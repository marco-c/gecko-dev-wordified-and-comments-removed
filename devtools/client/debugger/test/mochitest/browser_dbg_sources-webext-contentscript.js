const
ADDON_PATH
=
"
addon
-
webext
-
contentscript
.
xpi
"
;
const
TAB_URL
=
EXAMPLE_URL
+
"
doc_script_webext_contentscript
.
html
"
;
const
{
WebExtensionPolicy
}
=
Cu
.
getGlobalForObject
(
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Extension
.
jsm
"
{
}
)
)
;
function
test
(
)
{
let
gPanel
gDebugger
;
let
gSources
gAddon
;
let
cleanup
=
function
*
(
e
)
{
if
(
gAddon
)
{
yield
removeAddon
(
gAddon
)
;
}
if
(
gPanel
)
{
yield
closeDebuggerAndFinish
(
gPanel
)
;
}
else
{
finish
(
)
;
}
}
;
return
Task
.
spawn
(
function
*
(
)
{
gAddon
=
yield
addTemporaryAddon
(
ADDON_PATH
)
;
let
{
mozExtensionHostname
}
=
WebExtensionPolicy
.
getByID
(
gAddon
.
id
)
;
let
options
=
{
source
:
moz
-
extension
:
/
/
{
mozExtensionHostname
}
/
webext
-
content
-
script
.
js
line
:
1
}
;
[
gPanel
]
=
yield
initDebugger
(
TAB_URL
options
)
;
gDebugger
=
gPanel
.
panelWin
;
gSources
=
gDebugger
.
DebuggerView
.
Sources
;
is
(
gSources
.
values
.
length
2
"
Should
have
2
sources
"
)
;
let
item
=
gSources
.
getItemForAttachment
(
attachment
=
>
{
return
attachment
.
source
.
url
.
includes
(
"
moz
-
extension
"
)
;
}
)
;
ok
(
item
"
Got
the
expected
WebExtensions
ContentScript
source
"
)
;
ok
(
item
&
&
item
.
attachment
.
source
.
url
.
includes
(
item
.
attachment
.
group
)
"
The
source
is
in
the
expected
source
group
"
)
;
is
(
item
&
&
item
.
attachment
.
label
"
webext
-
content
-
script
.
js
"
"
Got
the
expected
filename
in
the
label
"
)
;
yield
cleanup
(
)
;
}
)
.
catch
(
(
e
)
=
>
{
ok
(
false
Got
an
unexpected
exception
:
{
e
}
)
;
return
Task
.
spawn
(
cleanup
)
;
}
)
;
}
