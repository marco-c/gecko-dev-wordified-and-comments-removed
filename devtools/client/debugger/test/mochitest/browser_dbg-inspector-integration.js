"
use
strict
"
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
devtools
.
debugger
.
end
-
panel
-
size
"
600
)
;
await
pushPref
(
"
devtools
.
inspector
.
three
-
pane
-
enabled
"
false
)
;
const
dbg
=
await
initDebugger
(
"
doc
-
script
-
switching
.
html
"
)
;
const
{
toolbox
}
=
dbg
;
const
highlighterTestFront
=
await
getHighlighterTestFront
(
toolbox
)
;
const
highlighter
=
toolbox
.
getHighlighter
(
)
;
const
onWhyPausedDisplayed
=
waitUntil
(
(
)
=
>
dbg
.
win
.
document
.
querySelector
(
"
.
why
-
paused
:
not
(
.
hidden
)
"
)
)
;
await
addExpression
(
dbg
"
window
.
document
.
querySelector
(
'
button
'
)
"
)
;
await
onWhyPausedDisplayed
;
await
waitUntil
(
(
)
=
>
dbg
.
win
.
document
.
querySelector
(
"
.
why
-
paused
.
hidden
"
)
)
;
info
(
"
Check
that
hovering
over
DOM
element
highlights
the
node
in
content
panel
"
)
;
let
onNodeHighlight
=
highlighter
.
waitForHighlighterShown
(
)
;
info
(
"
Mouseover
the
open
in
inspector
button
"
)
;
const
inspectorNode
=
await
waitFor
(
(
)
=
>
findElement
(
dbg
"
openInspector
"
)
)
;
const
view
=
inspectorNode
.
ownerDocument
.
defaultView
;
EventUtils
.
synthesizeMouseAtCenter
(
inspectorNode
{
type
:
"
mouseover
"
}
view
)
;
info
(
"
Wait
for
highligther
to
be
shown
"
)
;
const
{
nodeFront
}
=
await
onNodeHighlight
;
is
(
nodeFront
.
displayName
"
button
"
"
The
correct
node
was
highlighted
"
)
;
info
(
"
Check
that
moving
the
mouse
away
from
the
node
hides
the
highlighter
"
)
;
let
onNodeUnhighlight
=
highlighter
.
waitForHighlighterHidden
(
)
;
const
nonHighlightEl
=
inspectorNode
.
closest
(
"
.
object
-
node
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
nonHighlightEl
{
type
:
"
mouseover
"
}
view
)
;
await
onNodeUnhighlight
;
isVisible
=
await
highlighterTestFront
.
isHighlighting
(
)
;
is
(
isVisible
false
"
The
highlighter
is
not
displayed
anymore
"
)
;
info
(
"
Check
we
don
'
t
have
zombie
highlighters
when
briefly
hovering
a
node
"
)
;
onNodeHighlight
=
highlighter
.
waitForHighlighterShown
(
)
;
onNodeUnhighlight
=
highlighter
.
waitForHighlighterHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
inspectorNode
{
type
:
"
mousemove
"
}
view
)
;
EventUtils
.
synthesizeMouseAtCenter
(
nonHighlightEl
{
type
:
"
mousemove
"
}
view
)
;
await
Promise
.
all
(
[
onNodeHighlight
onNodeUnhighlight
]
)
;
isVisible
=
await
highlighterTestFront
.
isHighlighting
(
)
;
is
(
isVisible
false
"
The
highlighter
is
not
displayed
anymore
-
no
zombie
"
)
;
info
(
"
Ensure
panel
changes
when
button
is
clicked
"
)
;
const
inspector
=
await
toolbox
.
loadTool
(
"
inspector
"
)
;
const
onInspectorSelected
=
toolbox
.
once
(
"
inspector
-
selected
"
)
;
const
onInspectorUpdated
=
inspector
.
once
(
"
inspector
-
updated
"
)
;
const
onNewNode
=
toolbox
.
selection
.
once
(
"
new
-
node
-
front
"
)
;
inspectorNode
.
click
(
)
;
await
onInspectorSelected
;
await
onInspectorUpdated
;
const
inspectorNodeFront
=
await
onNewNode
;
ok
(
true
"
Inspector
selected
and
new
node
got
selected
"
)
;
is
(
inspectorNodeFront
.
displayName
"
button
"
"
The
expected
node
was
selected
"
)
;
}
)
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
devtools
.
inspector
.
three
-
pane
-
enabled
"
false
)
;
const
iframeUrl
=
EXAMPLE_URL
+
"
doc
-
event
-
handler
.
html
"
;
const
dbg
=
await
initDebuggerWithAbsoluteURL
(
https
:
/
/
example
.
org
/
document
-
builder
.
sjs
?
html
=
top
<
iframe
src
=
"
{
iframeUrl
}
"
>
<
iframe
>
)
;
const
{
toolbox
}
=
dbg
;
const
iframeBc
=
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
content
.
document
.
querySelector
(
"
iframe
"
)
.
browsingContext
)
;
SpecialPowers
.
spawn
(
iframeBc
[
]
(
)
=
>
content
.
wrappedJSObject
.
synthesizeClick
(
)
)
;
await
waitForPaused
(
dbg
)
;
findElement
(
dbg
"
frame
"
2
)
.
focus
(
)
;
clickElement
(
dbg
"
frame
"
2
)
;
await
waitForPaused
(
dbg
)
;
await
waitForSelectedSource
(
dbg
"
doc
-
event
-
handler
.
html
"
)
;
await
waitForDocumentLoadComplete
(
dbg
)
;
const
iframeThread
=
dbg
.
selectors
.
getThreads
(
)
.
find
(
(
{
url
}
)
=
>
url
=
=
=
iframeUrl
)
;
await
waitForPausedThread
(
dbg
iframeThread
.
actor
)
;
await
tryHovering
(
dbg
5
8
"
popup
"
)
;
info
(
"
Wait
for
top
level
node
to
expand
and
child
nodes
to
load
"
)
;
await
waitUntil
(
(
)
=
>
dbg
.
win
.
document
.
querySelectorAll
(
"
.
preview
-
popup
.
node
"
)
.
length
>
1
)
;
info
(
"
Mouseover
the
open
in
inspector
button
"
)
;
const
openInspectorEl
=
await
waitForElement
(
dbg
"
openInspector
"
)
;
openInspectorEl
.
scrollIntoView
(
)
;
const
view
=
openInspectorEl
.
ownerDocument
.
defaultView
;
EventUtils
.
synthesizeMouseAtCenter
(
openInspectorEl
{
type
:
"
mouseover
"
}
view
)
;
info
(
"
Wait
for
highligther
to
be
shown
"
)
;
await
SpecialPowers
.
spawn
(
iframeBc
[
]
(
)
=
>
{
const
doc
=
content
.
document
;
return
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
{
const
roots
=
doc
.
getConnectedShadowRoots
(
)
;
const
getBoxModelHighlighterInfoBarEl
=
root
=
>
root
.
querySelector
(
"
.
highlighter
-
container
.
box
-
model
#
box
-
model
-
infobar
-
container
"
)
;
const
boxModelRoot
=
roots
.
find
(
root
=
>
getBoxModelHighlighterInfoBarEl
(
root
)
)
;
if
(
!
boxModelRoot
)
{
return
false
;
}
const
boxModelInfoBarEl
=
getBoxModelHighlighterInfoBarEl
(
boxModelRoot
)
;
return
(
boxModelInfoBarEl
.
getAttribute
(
"
hidden
"
)
=
=
=
null
&
&
boxModelInfoBarEl
.
querySelector
(
"
.
box
-
model
-
infobar
-
id
"
)
?
.
textContent
=
=
=
"
#
clicky
"
)
;
}
"
wait
for
hihglighter
to
be
visible
"
)
;
}
)
;
await
wait
(
1000
)
;
ok
(
dbg
.
selectors
.
getIsCurrentThreadPaused
(
)
"
current
thread
is
paused
"
)
;
ok
(
findElement
(
dbg
"
threadsPaneItemPause
"
2
)
.
classList
.
contains
(
"
selected
"
)
iframe
thread
is
still
selected
)
;
const
inspector
=
await
toolbox
.
getPanel
(
"
inspector
"
)
;
const
onInspectorSelected
=
toolbox
.
once
(
"
inspector
-
selected
"
)
;
const
onInspectorUpdated
=
inspector
.
once
(
"
inspector
-
updated
"
)
;
const
onNewNode
=
toolbox
.
selection
.
once
(
"
new
-
node
-
front
"
)
;
openInspectorEl
.
click
(
)
;
await
onInspectorSelected
;
await
onInspectorUpdated
;
await
onNewNode
;
ok
(
true
"
Inspector
selected
and
new
node
got
selected
"
)
;
}
)
;
