const
WAIT_UNTIL_TYPE
=
"
service
/
waitUntil
"
;
function
waitUntilService
(
{
dispatch
getState
}
)
{
let
pending
=
[
]
;
function
checkPending
(
action
)
{
const
readyRequests
=
[
]
;
const
stillPending
=
[
]
;
for
(
const
request
of
pending
)
{
if
(
request
.
predicate
(
action
)
)
{
readyRequests
.
push
(
request
)
;
}
else
{
stillPending
.
push
(
request
)
;
}
}
pending
=
stillPending
;
for
(
const
request
of
readyRequests
)
{
request
.
run
(
dispatch
getState
action
)
;
}
}
return
(
next
:
Function
)
=
>
(
action
:
Object
)
=
>
{
if
(
action
.
type
=
=
=
WAIT_UNTIL_TYPE
)
{
pending
.
push
(
action
)
;
return
null
;
}
const
result
=
next
(
action
)
;
checkPending
(
action
)
;
return
result
;
}
;
}
module
.
exports
=
{
WAIT_UNTIL_TYPE
waitUntilService
}
;
