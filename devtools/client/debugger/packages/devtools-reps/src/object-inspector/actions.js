import
type
{
GripProperties
Node
Props
ReduxAction
}
from
"
.
/
types
"
;
const
{
loadItemProperties
}
=
require
(
"
.
/
utils
/
load
-
properties
"
)
;
const
{
getPathExpression
getParentFront
getParentGripValue
getValue
nodeIsBucket
}
=
require
(
"
.
/
utils
/
node
"
)
;
const
{
getLoadedProperties
getActors
getWatchpoints
}
=
require
(
"
.
/
reducer
"
)
;
type
Dispatch
=
ReduxAction
=
>
void
;
type
ThunkArg
=
{
getState
:
(
)
=
>
{
}
dispatch
:
Dispatch
}
;
function
nodeExpand
(
node
:
Node
actor
)
{
return
async
(
{
dispatch
}
:
ThunkArg
)
=
>
{
dispatch
(
{
type
:
"
NODE_EXPAND
"
data
:
{
node
}
}
)
;
dispatch
(
nodeLoadProperties
(
node
actor
)
)
;
}
;
}
function
nodeCollapse
(
node
:
Node
)
{
return
{
type
:
"
NODE_COLLAPSE
"
data
:
{
node
}
}
;
}
function
nodeLoadProperties
(
node
:
Node
actor
)
{
return
async
(
{
dispatch
client
getState
}
:
ThunkArg
)
=
>
{
const
state
=
getState
(
)
;
const
loadedProperties
=
getLoadedProperties
(
state
)
;
if
(
loadedProperties
.
has
(
node
.
path
)
)
{
return
;
}
try
{
const
properties
=
await
loadItemProperties
(
node
client
loadedProperties
)
;
if
(
!
client
|
|
!
client
.
releaseActor
)
{
actor
=
null
;
}
dispatch
(
nodePropertiesLoaded
(
node
actor
properties
)
)
;
}
catch
(
e
)
{
console
.
error
(
e
)
;
}
}
;
}
function
nodePropertiesLoaded
(
node
:
Node
actor
?
:
string
properties
:
GripProperties
)
{
return
{
type
:
"
NODE_PROPERTIES_LOADED
"
data
:
{
node
actor
properties
}
}
;
}
function
addWatchpoint
(
item
watchpoint
:
string
)
{
return
async
function
(
{
dispatch
client
}
:
ThunkArgs
)
{
const
{
parent
name
}
=
item
;
let
object
=
getValue
(
parent
)
;
if
(
nodeIsBucket
(
parent
)
)
{
object
=
getValue
(
parent
.
parent
)
;
}
if
(
!
object
)
{
return
;
}
const
path
=
parent
.
path
;
const
property
=
name
;
const
label
=
getPathExpression
(
item
)
;
const
actor
=
object
.
actor
;
await
client
.
addWatchpoint
(
object
property
label
watchpoint
)
;
dispatch
(
{
type
:
"
SET_WATCHPOINT
"
data
:
{
path
watchpoint
property
actor
}
}
)
;
}
;
}
function
removeWatchpoint
(
item
)
{
return
async
function
(
{
dispatch
client
}
:
ThunkArgs
)
{
const
{
parent
name
}
=
item
;
let
object
=
getValue
(
parent
)
;
if
(
nodeIsBucket
(
parent
)
)
{
object
=
getValue
(
parent
.
parent
)
;
}
const
property
=
name
;
const
path
=
parent
.
path
;
const
actor
=
object
.
actor
;
await
client
.
removeWatchpoint
(
object
property
)
;
dispatch
(
{
type
:
"
REMOVE_WATCHPOINT
"
data
:
{
path
property
actor
}
}
)
;
}
;
}
function
closeObjectInspector
(
)
{
return
(
{
dispatch
getState
client
}
:
ThunkArg
)
=
>
releaseActors
(
getState
(
)
client
dispatch
)
;
}
function
rootsChanged
(
props
:
Props
)
{
return
(
{
dispatch
client
getState
}
:
ThunkArg
)
=
>
{
releaseActors
(
getState
(
)
client
dispatch
)
;
dispatch
(
{
type
:
"
ROOTS_CHANGED
"
data
:
props
}
)
;
}
;
}
async
function
releaseActors
(
state
client
dispatch
)
{
const
actors
=
getActors
(
state
)
;
if
(
!
client
|
|
!
client
.
releaseActor
|
|
actors
.
size
=
=
=
0
)
{
return
;
}
const
watchpoints
=
getWatchpoints
(
state
)
;
let
released
=
false
;
for
(
const
actor
of
actors
)
{
if
(
!
watchpoints
.
has
(
actor
)
)
{
await
client
.
releaseActor
(
actor
)
;
released
=
true
;
}
}
if
(
released
)
{
dispatch
(
{
type
:
"
RELEASED_ACTORS
"
data
:
{
actors
}
}
)
;
}
}
function
invokeGetter
(
node
:
Node
receiverId
:
string
|
null
)
{
return
async
(
{
dispatch
client
getState
}
:
ThunkArg
)
=
>
{
try
{
const
objectFront
=
getParentFront
(
node
)
|
|
client
.
createObjectFront
(
getParentGripValue
(
node
)
)
;
const
getterName
=
node
.
propertyName
|
|
node
.
name
;
const
result
=
await
objectFront
.
getPropertyValue
(
getterName
receiverId
)
;
dispatch
(
{
type
:
"
GETTER_INVOKED
"
data
:
{
node
result
}
}
)
;
}
catch
(
e
)
{
console
.
error
(
e
)
;
}
}
;
}
module
.
exports
=
{
closeObjectInspector
invokeGetter
nodeExpand
nodeCollapse
nodeLoadProperties
nodePropertiesLoaded
rootsChanged
addWatchpoint
removeWatchpoint
}
;
