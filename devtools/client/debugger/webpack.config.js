const
sourceMapAssets
=
require
(
"
devtools
-
source
-
map
/
assets
"
)
;
const
CopyWebpackPlugin
=
require
(
"
copy
-
webpack
-
plugin
"
)
;
const
webpack
=
require
(
"
webpack
"
)
;
const
getConfig
=
require
(
"
.
/
bin
/
getConfig
"
)
;
const
mozillaCentralMappings
=
require
(
"
.
/
configs
/
mozilla
-
central
-
mappings
"
)
;
const
path
=
require
(
"
path
"
)
;
const
ObjectRestSpreadPlugin
=
require
(
"
sucrase
/
webpack
-
object
-
rest
-
spread
-
plugin
"
)
;
const
isProduction
=
process
.
env
.
NODE_ENV
=
=
=
"
production
"
;
function
getEntry
(
filename
)
{
return
[
path
.
join
(
__dirname
filename
)
]
;
}
const
webpackConfig
=
{
entry
:
{
"
parser
-
worker
"
:
getEntry
(
"
src
/
workers
/
parser
/
worker
.
js
"
)
"
pretty
-
print
-
worker
"
:
getEntry
(
"
src
/
workers
/
pretty
-
print
/
worker
.
js
"
)
"
search
-
worker
"
:
getEntry
(
"
src
/
workers
/
search
/
worker
.
js
"
)
"
source
-
map
-
worker
"
:
getEntry
(
"
packages
/
devtools
-
source
-
map
/
src
/
worker
.
js
"
)
"
source
-
map
-
index
"
:
getEntry
(
"
packages
/
devtools
-
source
-
map
/
src
/
index
.
js
"
)
}
output
:
{
path
:
path
.
join
(
__dirname
"
assets
/
build
"
)
filename
:
"
[
name
]
.
js
"
publicPath
:
"
/
assets
/
build
"
}
plugins
:
[
new
CopyWebpackPlugin
(
Object
.
entries
(
sourceMapAssets
)
.
map
(
(
[
name
filePath
]
)
=
>
(
{
from
:
filePath
to
:
source
-
map
-
worker
-
assets
/
{
name
}
}
)
)
)
new
webpack
.
BannerPlugin
(
{
banner
:
/
*
This
Source
Code
Form
is
subject
to
the
terms
of
the
Mozilla
Public
*
License
v
.
2
.
0
.
If
a
copy
of
the
MPL
was
not
distributed
with
this
*
file
You
can
obtain
one
at
http
:
/
/
mozilla
.
org
/
MPL
/
2
.
0
/
.
*
/
raw
:
true
exclude
:
/
\
.
css
/
}
)
]
}
;
if
(
isProduction
)
{
webpackConfig
.
entry
.
vendors
=
getEntry
(
"
src
/
vendors
.
js
"
)
;
}
const
envConfig
=
getConfig
(
)
;
const
extra
=
{
babelIncludes
:
[
"
react
-
aria
-
components
"
]
}
;
webpackConfig
.
plugins
.
push
(
new
ObjectRestSpreadPlugin
(
)
)
;
if
(
!
isProduction
)
{
webpackConfig
.
module
=
webpackConfig
.
module
|
|
{
}
;
webpackConfig
.
module
.
rules
=
webpackConfig
.
module
.
rules
|
|
[
]
;
}
else
{
webpackConfig
.
output
.
libraryTarget
=
"
umd
"
;
extra
.
excludeMap
=
mozillaCentralMappings
;
extra
.
recordsPath
=
"
bin
/
module
-
manifest
.
json
"
;
}
const
overallConfig
=
toolboxConfig
(
webpackConfig
envConfig
extra
)
;
for
(
const
rule
of
overallConfig
.
module
.
rules
)
{
if
(
rule
.
loader
=
=
=
"
babel
-
loader
?
ignore
=
src
/
lib
"
)
{
rule
.
loader
=
require
.
resolve
(
"
babel
-
loader
"
)
;
rule
.
options
=
{
ignore
:
[
"
src
/
lib
"
]
}
;
}
}
module
.
exports
=
overallConfig
;
function
toolboxConfig
(
innerWebpackConfig
innerEnvConfig
options
=
{
}
)
{
require
(
"
babel
-
register
"
)
;
const
ExtractTextPlugin
=
require
(
"
extract
-
text
-
webpack
-
plugin
"
)
;
const
{
isDevelopment
isFirefoxPanel
}
=
require
(
"
devtools
-
environment
"
)
;
const
{
getValue
setConfig
}
=
require
(
"
devtools
-
config
"
)
;
const
NODE_ENV
=
process
.
env
.
NODE_ENV
|
|
"
development
"
;
const
TARGET
=
process
.
env
.
TARGET
|
|
"
local
"
;
setConfig
(
innerEnvConfig
)
;
innerWebpackConfig
.
context
=
path
.
resolve
(
__dirname
"
src
"
)
;
innerWebpackConfig
.
devtool
=
"
source
-
map
"
;
innerWebpackConfig
.
module
=
innerWebpackConfig
.
module
|
|
{
}
;
innerWebpackConfig
.
module
.
rules
=
innerWebpackConfig
.
module
.
rules
|
|
[
]
;
innerWebpackConfig
.
module
.
rules
.
push
(
{
test
:
/
\
.
json
/
loader
:
"
json
-
loader
"
}
)
;
innerWebpackConfig
.
module
.
rules
.
push
(
{
test
:
/
\
.
js
/
exclude
:
request
=
>
{
const
excludedPaths
=
[
"
fs
"
"
node_modules
"
]
;
const
excludedRe
=
new
RegExp
(
(
{
excludedPaths
.
join
(
"
|
"
)
}
)
)
;
let
excluded
=
!
!
request
.
match
(
excludedRe
)
;
if
(
options
.
babelExcludes
)
{
excluded
=
excluded
|
|
!
!
request
.
match
(
options
.
babelExcludes
)
;
}
let
included
=
[
"
devtools
-
"
]
;
if
(
options
.
babelIncludes
)
{
included
=
included
.
concat
(
options
.
babelIncludes
)
;
}
const
reincludeRe
=
new
RegExp
(
node_modules
(
\
\
/
|
\
\
\
\
)
{
included
.
join
(
"
|
"
)
}
)
;
return
excluded
&
&
!
request
.
match
(
reincludeRe
)
;
}
loader
:
babel
-
loader
?
ignore
=
src
/
lib
}
)
;
innerWebpackConfig
.
module
.
rules
.
push
(
{
test
:
/
\
.
properties
/
loader
:
"
raw
-
loader
"
}
)
;
innerWebpackConfig
.
node
=
{
fs
:
"
empty
"
}
;
innerWebpackConfig
.
plugins
=
innerWebpackConfig
.
plugins
|
|
[
]
;
innerWebpackConfig
.
plugins
.
push
(
new
webpack
.
DefinePlugin
(
{
"
process
.
env
"
:
{
NODE_ENV
:
JSON
.
stringify
(
NODE_ENV
)
TARGET
:
JSON
.
stringify
(
TARGET
)
}
DebuggerConfig
:
JSON
.
stringify
(
innerEnvConfig
)
}
)
)
;
if
(
isDevelopment
(
)
)
{
innerWebpackConfig
.
module
.
rules
.
push
(
{
test
:
/
svg
/
loader
:
"
svg
-
inline
-
loader
"
}
)
;
const
cssUses
=
[
{
loader
:
"
style
-
loader
"
}
{
loader
:
"
css
-
loader
"
options
:
{
importLoaders
:
1
url
:
false
}
}
]
;
if
(
!
options
.
disablePostCSS
)
{
cssUses
.
push
(
{
loader
:
"
postcss
-
loader
"
}
)
;
}
innerWebpackConfig
.
module
.
rules
.
push
(
{
test
:
/
\
.
css
/
use
:
cssUses
}
)
;
innerWebpackConfig
.
plugins
.
push
(
new
webpack
.
NormalModuleReplacementPlugin
(
/
(
resource
:
|
chrome
:
)
.
*
.
css
/
function
(
resource
)
{
const
newUrl
=
resource
.
request
.
replace
(
/
(
.
\
/
chrome
:
\
/
\
/
|
.
\
/
resource
:
\
/
\
/
)
/
devtools
-
mc
-
assets
/
assets
/
)
.
replace
(
/
devtools
\
/
skin
/
"
devtools
/
client
/
themes
"
)
.
replace
(
/
devtools
\
/
content
/
"
devtools
/
client
"
)
;
resource
.
request
=
newUrl
;
}
)
)
;
}
else
{
const
cssUses
=
[
{
loader
:
"
css
-
loader
"
options
:
{
importLoaders
:
1
url
:
false
}
}
]
;
if
(
!
options
.
disablePostCSS
)
{
cssUses
.
push
(
{
loader
:
"
postcss
-
loader
"
}
)
;
}
innerWebpackConfig
.
module
.
rules
.
push
(
{
test
:
/
\
.
css
/
exclude
:
request
=
>
{
return
(
innerWebpackConfig
.
cssExcludes
&
&
request
.
match
(
innerWebpackConfig
.
cssExcludes
)
)
;
}
use
:
ExtractTextPlugin
.
extract
(
{
filename
:
"
*
.
css
"
use
:
cssUses
}
)
}
)
;
innerWebpackConfig
.
module
.
rules
.
push
(
{
test
:
/
svg
/
loader
:
"
svg
-
inline
-
loader
"
}
)
;
innerWebpackConfig
.
plugins
.
push
(
new
ExtractTextPlugin
(
"
[
name
]
.
css
"
)
)
;
}
if
(
isFirefoxPanel
(
)
)
{
innerWebpackConfig
=
devtoolsConfig
(
innerWebpackConfig
innerEnvConfig
options
)
;
}
if
(
getValue
(
"
transformParameters
"
)
)
{
innerWebpackConfig
.
module
.
rules
.
forEach
(
spec
=
>
{
if
(
spec
.
isJavaScriptLoader
)
{
const
idx
=
spec
.
rules
.
findIndex
(
loader
=
>
loader
.
includes
(
"
babel
-
loader
"
)
)
;
spec
.
rules
[
idx
]
+
=
"
&
plugins
[
]
=
transform
-
es2015
-
parameters
"
;
}
}
)
;
}
return
innerWebpackConfig
;
}
function
devtoolsConfig
(
innerWebpackConfig
innerEnvConfig
options
)
{
const
nativeMapping
=
{
react
:
"
devtools
/
client
/
shared
/
vendor
/
react
"
"
react
-
dom
"
:
"
devtools
/
client
/
shared
/
vendor
/
react
-
dom
"
"
react
-
dom
-
factories
"
:
"
devtools
/
client
/
shared
/
vendor
/
react
-
dom
-
factories
"
"
prop
-
types
"
:
"
devtools
/
client
/
shared
/
vendor
/
react
-
prop
-
types
"
lodash
:
"
devtools
/
client
/
shared
/
vendor
/
lodash
"
}
;
const
outputPath
=
process
.
env
.
OUTPUT_PATH
;
if
(
outputPath
)
{
innerWebpackConfig
.
output
.
path
=
outputPath
;
}
innerWebpackConfig
.
devtool
=
false
;
const
recordsPath
=
options
.
recordsPath
|
|
"
assets
/
module
-
manifest
.
json
"
;
innerWebpackConfig
.
recordsPath
=
path
.
join
(
__dirname
recordsPath
)
;
function
externalsTest
(
context
request
callback
)
{
const
mod
=
request
;
if
(
mod
.
match
(
/
.
*
\
/
Services
/
)
)
{
callback
(
null
"
Services
"
)
;
return
;
}
const
excludeMap
=
(
options
&
&
options
.
excludeMap
)
|
|
nativeMapping
;
if
(
excludeMap
[
mod
]
)
{
const
mapping
=
excludeMap
[
mod
]
;
if
(
innerWebpackConfig
.
externalsRequire
)
{
const
reqMethod
=
innerWebpackConfig
.
externalsRequire
;
callback
(
null
var
{
reqMethod
}
(
"
{
mapping
}
"
)
)
;
}
else
{
callback
(
null
mapping
)
;
}
return
;
}
callback
(
)
;
}
innerWebpackConfig
.
externals
=
innerWebpackConfig
.
externals
|
|
[
]
;
innerWebpackConfig
.
externals
.
push
(
externalsTest
)
;
const
plugins
=
innerWebpackConfig
.
plugins
.
filter
(
p
=
>
!
(
p
instanceof
webpack
.
DefinePlugin
)
)
;
innerWebpackConfig
.
plugins
=
plugins
.
concat
(
[
new
webpack
.
DefinePlugin
(
{
"
process
.
env
"
:
{
NODE_ENV
:
JSON
.
stringify
(
process
.
env
.
NODE_ENV
|
|
"
production
"
)
TARGET
:
JSON
.
stringify
(
"
firefox
-
panel
"
)
}
DebuggerConfig
:
JSON
.
stringify
(
innerEnvConfig
)
}
)
]
)
;
const
mappings
=
[
[
/
.
\
/
src
\
/
network
-
request
/
"
.
/
src
/
privileged
-
network
-
request
"
]
]
;
mappings
.
forEach
(
(
[
regex
res
]
)
=
>
{
innerWebpackConfig
.
plugins
.
push
(
new
webpack
.
NormalModuleReplacementPlugin
(
regex
res
)
)
;
}
)
;
return
innerWebpackConfig
;
}
