import
{
hasSource
hasSourceActor
getSourceActor
getSourceCount
}
from
"
.
.
/
.
.
/
selectors
/
index
"
;
import
{
features
}
from
"
.
.
/
.
.
/
utils
/
prefs
"
;
import
{
isUrlExtension
getRawSourceURL
getFormattedSourceId
}
from
"
.
.
/
.
.
/
utils
/
source
"
;
import
{
createLocation
}
from
"
.
.
/
.
.
/
utils
/
location
"
;
import
{
getDisplayURL
}
from
"
.
.
/
.
.
/
utils
/
sources
-
tree
/
getURL
"
;
let
store
;
export
function
setupCreate
(
dependencies
)
{
store
=
dependencies
.
store
;
}
export
async
function
createFrame
(
thread
frame
index
=
0
)
{
const
sourceActor
=
await
waitForSourceActorToBeRegisteredInStore
(
frame
.
where
.
actor
)
;
const
location
=
createLocation
(
{
source
:
sourceActor
.
sourceObject
sourceActor
line
:
frame
.
where
.
line
column
:
frame
.
where
.
column
}
)
;
return
{
id
:
frame
.
actorID
thread
displayName
:
frame
.
displayName
location
generatedLocation
:
location
this
:
frame
.
this
index
asyncCause
:
frame
.
asyncCause
state
:
frame
.
state
type
:
frame
.
type
}
;
}
export
function
createWasmOriginalFrame
(
generatedFrame
id
originalFrame
originalFrameLocation
)
{
return
{
id
thread
:
generatedFrame
.
thread
displayName
:
originalFrame
.
displayName
location
:
originalFrameLocation
generatedLocation
:
generatedFrame
.
generatedLocation
this
:
generatedFrame
.
this
index
:
generatedFrame
.
index
asyncCause
:
generatedFrame
.
asyncCause
state
:
generatedFrame
.
state
type
:
generatedFrame
.
type
isOriginal
:
true
originalDisplayName
:
originalFrame
.
displayName
originalVariables
:
originalFrame
.
variables
}
;
}
async
function
waitForSourceActorToBeRegisteredInStore
(
sourceActorId
)
{
if
(
!
hasSourceActor
(
store
.
getState
(
)
sourceActorId
)
)
{
await
new
Promise
(
resolve
=
>
{
const
unsubscribe
=
store
.
subscribe
(
check
)
;
let
currentSize
=
null
;
function
check
(
)
{
const
previousSize
=
currentSize
;
currentSize
=
store
.
getState
(
)
.
sourceActors
.
mutableSourceActors
.
size
;
if
(
previousSize
=
=
currentSize
)
{
return
;
}
if
(
hasSourceActor
(
store
.
getState
(
)
sourceActorId
)
)
{
unsubscribe
(
)
;
resolve
(
)
;
}
}
}
)
;
}
return
getSourceActor
(
store
.
getState
(
)
sourceActorId
)
;
}
export
async
function
waitForSourceToBeRegisteredInStore
(
sourceId
)
{
return
new
Promise
(
resolve
=
>
{
if
(
hasSource
(
store
.
getState
(
)
sourceId
)
)
{
resolve
(
)
;
return
;
}
const
unsubscribe
=
store
.
subscribe
(
check
)
;
let
currentSize
=
null
;
function
check
(
)
{
const
previousSize
=
currentSize
;
currentSize
=
getSourceCount
(
store
.
getState
(
)
)
;
if
(
previousSize
=
=
currentSize
)
{
return
;
}
if
(
hasSource
(
store
.
getState
(
)
sourceId
)
)
{
unsubscribe
(
)
;
resolve
(
)
;
}
}
}
)
;
}
export
function
makeSourceId
(
sourceResource
)
{
if
(
"
mockedJestID
"
in
sourceResource
)
{
return
sourceResource
.
mockedJestID
;
}
if
(
sourceResource
.
url
)
{
return
source
-
url
-
{
sourceResource
.
url
}
;
}
return
source
-
actor
-
{
sourceResource
.
actor
}
;
}
export
function
createGeneratedSource
(
sourceResource
)
{
return
createSourceObject
(
{
id
:
makeSourceId
(
sourceResource
)
url
:
sourceResource
.
url
extensionName
:
sourceResource
.
extensionName
isWasm
:
!
!
features
.
wasm
&
&
sourceResource
.
introductionType
=
=
=
"
wasm
"
isExtension
:
(
sourceResource
.
url
&
&
isUrlExtension
(
sourceResource
.
url
)
)
|
|
false
isHTML
:
!
!
sourceResource
.
isInlineSource
}
)
;
}
function
createSourceObject
(
{
id
url
extensionName
=
null
isWasm
=
false
isExtension
=
false
isPrettyPrinted
=
false
isOriginal
=
false
isHTML
=
false
}
)
{
const
displayURL
=
getDisplayURL
(
url
extensionName
)
;
return
{
id
url
displayURL
shortName
:
url
?
getRawSourceURL
(
displayURL
.
filename
)
:
getFormattedSourceId
(
id
)
longName
:
url
?
getRawSourceURL
(
displayURL
.
filename
+
displayURL
.
search
)
:
getFormattedSourceId
(
id
)
extensionName
isExtension
isWasm
isHTML
isPrettyPrinted
isOriginal
}
;
}
export
function
createSourceMapOriginalSource
(
id
url
)
{
return
createSourceObject
(
{
id
url
isOriginal
:
true
}
)
;
}
export
function
createPrettyPrintOriginalSource
(
id
url
)
{
return
createSourceObject
(
{
id
url
isOriginal
:
true
isPrettyPrinted
:
true
}
)
;
}
export
function
createSourceActor
(
sourceResource
sourceObject
)
{
const
actorId
=
sourceResource
.
actor
;
return
{
id
:
actorId
actor
:
actorId
thread
:
sourceResource
.
targetFront
.
getCachedFront
(
"
thread
"
)
.
actorID
source
:
makeSourceId
(
sourceResource
)
sourceObject
sourceMapBaseURL
:
sourceResource
.
sourceMapBaseURL
sourceMapURL
:
sourceResource
.
sourceMapURL
url
:
sourceResource
.
url
introductionType
:
sourceResource
.
introductionType
sourceStartLine
:
sourceResource
.
sourceStartLine
sourceStartColumn
:
sourceResource
.
sourceStartColumn
sourceLength
:
sourceResource
.
sourceLength
}
;
}
export
async
function
createPause
(
threadActorID
pausedThreadState
)
{
const
frame
=
await
createFrame
(
threadActorID
pausedThreadState
.
frame
)
;
return
{
thread
:
threadActorID
frame
why
:
pausedThreadState
.
why
}
;
}
export
function
createThread
(
targetFront
)
{
const
name
=
targetFront
.
isTopLevel
&
&
!
targetFront
.
commands
.
descriptorFront
.
isWebExtension
?
L10N
.
getStr
(
"
mainThread
"
)
:
targetFront
.
name
;
return
{
actor
:
targetFront
.
targetForm
.
threadActor
url
:
targetFront
.
url
isTopLevel
:
targetFront
.
isTopLevel
targetType
:
targetFront
.
targetType
name
serviceWorkerStatus
:
targetFront
.
debuggerServiceWorkerStatus
processID
:
targetFront
.
processID
innerWindowId
:
targetFront
.
innerWindowId
}
;
}
export
function
createBreakpoint
(
{
id
thread
disabled
=
false
options
=
{
}
location
generatedLocation
text
originalText
}
)
{
return
{
id
thread
disabled
options
location
generatedLocation
text
originalText
}
;
}
