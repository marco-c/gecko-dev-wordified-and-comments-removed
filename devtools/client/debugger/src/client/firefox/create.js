import
{
hasSourceActor
getSourceActor
}
from
"
.
.
/
.
.
/
selectors
"
;
import
{
features
}
from
"
.
.
/
.
.
/
utils
/
prefs
"
;
import
{
isUrlExtension
}
from
"
.
.
/
.
.
/
utils
/
source
"
;
let
store
;
export
function
setupCreate
(
dependencies
)
{
store
=
dependencies
.
store
;
}
export
async
function
createFrame
(
thread
frame
index
=
0
)
{
if
(
!
frame
)
{
return
null
;
}
const
sourceActor
=
await
waitForSourceActorToBeRegisteredInStore
(
frame
.
where
.
actor
)
;
const
location
=
{
sourceId
:
sourceActor
.
source
line
:
frame
.
where
.
line
column
:
frame
.
where
.
column
}
;
return
{
id
:
frame
.
actorID
thread
displayName
:
frame
.
displayName
location
generatedLocation
:
location
this
:
frame
.
this
source
:
null
index
asyncCause
:
frame
.
asyncCause
state
:
frame
.
state
type
:
frame
.
type
}
;
}
async
function
waitForSourceActorToBeRegisteredInStore
(
sourceActorId
)
{
if
(
!
hasSourceActor
(
store
.
getState
(
)
sourceActorId
)
)
{
await
new
Promise
(
resolve
=
>
{
const
unsubscribe
=
store
.
subscribe
(
check
)
;
let
currentSize
=
null
;
function
check
(
)
{
const
previousSize
=
currentSize
;
currentSize
=
store
.
getState
(
)
.
sourceActors
.
size
;
if
(
previousSize
=
=
currentSize
)
{
return
;
}
if
(
hasSourceActor
(
store
.
getState
(
)
sourceActorId
)
)
{
unsubscribe
(
)
;
resolve
(
)
;
}
}
}
)
;
}
return
getSourceActor
(
store
.
getState
(
)
sourceActorId
)
;
}
export
function
makeSourceId
(
sourceResource
)
{
if
(
"
mockedJestID
"
in
sourceResource
)
{
return
sourceResource
.
mockedJestID
;
}
if
(
sourceResource
.
url
)
{
if
(
sourceResource
.
targetFront
.
isTopLevel
)
{
return
source
-
{
sourceResource
.
url
}
;
}
const
threadActorID
=
sourceResource
.
targetFront
.
getCachedFront
(
"
thread
"
)
.
actorID
;
return
source
-
{
threadActorID
}
-
{
sourceResource
.
url
}
;
}
return
source
-
{
sourceResource
.
actor
}
;
}
export
function
createGeneratedSource
(
sourceResource
)
{
return
createSourceObject
(
{
id
:
makeSourceId
(
sourceResource
)
url
:
sourceResource
.
url
thread
:
sourceResource
.
targetFront
.
getCachedFront
(
"
thread
"
)
.
actorID
extensionName
:
sourceResource
.
extensionName
isWasm
:
!
!
features
.
wasm
&
&
sourceResource
.
introductionType
=
=
=
"
wasm
"
isExtension
:
(
sourceResource
.
url
&
&
isUrlExtension
(
sourceResource
.
url
)
)
|
|
false
}
)
;
}
function
createSourceObject
(
{
id
url
thread
=
null
extensionName
=
null
isWasm
=
false
isExtension
=
false
isPrettyPrinted
=
false
isOriginal
=
false
}
)
{
return
{
id
url
thread
relativeUrl
:
url
extensionName
isExtension
isWasm
isPrettyPrinted
isOriginal
isBlackBoxed
:
false
}
;
}
export
function
createSourceMapOriginalSource
(
id
url
thread
)
{
return
createSourceObject
(
{
id
url
thread
isOriginal
:
true
}
)
;
}
export
function
createPrettyPrintOriginalSource
(
id
url
thread
)
{
return
createSourceObject
(
{
id
url
thread
isOriginal
:
true
isPrettyPrinted
:
true
}
)
;
}
export
function
createSourceActor
(
sourceResource
)
{
const
actorId
=
sourceResource
.
actor
;
const
threadActorID
=
sourceResource
.
targetFront
.
getCachedFront
(
"
thread
"
)
.
actorID
;
return
{
id
:
actorId
actor
:
actorId
thread
:
threadActorID
source
:
makeSourceId
(
sourceResource
)
sourceMapBaseURL
:
sourceResource
.
sourceMapBaseURL
sourceMapURL
:
sourceResource
.
sourceMapURL
url
:
sourceResource
.
url
introductionType
:
sourceResource
.
introductionType
}
;
}
export
async
function
createPause
(
thread
packet
)
{
const
frame
=
await
createFrame
(
thread
packet
.
frame
)
;
return
{
.
.
.
packet
thread
frame
}
;
}
export
function
createThread
(
actor
target
)
{
const
name
=
target
.
isTopLevel
?
L10N
.
getStr
(
"
mainThread
"
)
:
target
.
name
;
return
{
actor
url
:
target
.
url
isTopLevel
:
target
.
isTopLevel
targetType
:
target
.
targetType
name
serviceWorkerStatus
:
target
.
debuggerServiceWorkerStatus
}
;
}
export
function
createBreakpoint
(
{
id
thread
disabled
=
false
options
=
{
}
location
astLocation
generatedLocation
text
originalText
}
)
{
return
{
id
thread
disabled
options
location
astLocation
generatedLocation
text
originalText
}
;
}
