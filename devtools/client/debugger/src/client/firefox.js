import
{
setupCommands
clientCommands
}
from
"
.
/
firefox
/
commands
"
;
import
{
setupEvents
clientEvents
}
from
"
.
/
firefox
/
events
"
;
import
{
features
prefs
}
from
"
.
.
/
utils
/
prefs
"
;
import
type
{
Grip
}
from
"
.
.
/
types
"
;
let
DebuggerClient
;
function
createObjectClient
(
grip
:
Grip
)
{
return
DebuggerClient
.
createObjectClient
(
grip
)
;
}
export
async
function
onConnect
(
connection
:
any
actions
:
Object
)
{
const
{
tabConnection
:
{
tabTarget
threadFront
debuggerClient
}
}
=
connection
;
DebuggerClient
=
debuggerClient
;
if
(
!
tabTarget
|
|
!
threadFront
|
|
!
debuggerClient
)
{
return
;
}
const
supportsWasm
=
features
.
wasm
&
&
!
!
debuggerClient
.
mainRoot
.
traits
.
wasmBinarySource
;
setupCommands
(
{
threadFront
tabTarget
debuggerClient
supportsWasm
}
)
;
setupEvents
(
{
threadFront
tabTarget
actions
supportsWasm
}
)
;
tabTarget
.
on
(
"
will
-
navigate
"
actions
.
willNavigate
)
;
tabTarget
.
on
(
"
navigate
"
actions
.
navigated
)
;
await
threadFront
.
reconfigure
(
{
observeAsmJS
:
true
pauseWorkersUntilAttach
:
true
wasmBinarySource
:
supportsWasm
skipBreakpoints
:
prefs
.
skipPausing
}
)
;
actions
.
getEventListenerBreakpointTypes
(
)
.
catch
(
e
=
>
console
.
error
(
e
)
)
;
actions
.
addEventListenerBreakpoints
(
[
]
)
.
catch
(
e
=
>
console
.
error
(
e
)
)
;
const
traits
=
tabTarget
.
traits
;
await
actions
.
connect
(
tabTarget
.
url
threadFront
.
actor
traits
&
&
traits
.
canRewind
tabTarget
.
isWebExtension
)
;
const
fetched
=
clientCommands
.
fetchSources
(
)
.
then
(
sources
=
>
actions
.
newGeneratedSources
(
sources
)
)
;
const
pausedPacket
=
threadFront
.
getLastPausePacket
(
)
;
if
(
pausedPacket
)
{
clientEvents
.
paused
(
threadFront
pausedPacket
)
;
}
return
fetched
;
}
export
{
createObjectClient
clientCommands
clientEvents
}
;
