import
{
setupCommands
clientCommands
}
from
"
.
/
firefox
/
commands
"
;
import
{
setupEvents
clientEvents
}
from
"
.
/
firefox
/
events
"
;
import
{
features
prefs
}
from
"
.
.
/
utils
/
prefs
"
;
let
actions
;
export
async
function
onConnect
(
connection
:
any
_actions
:
Object
)
:
Promise
<
void
>
{
const
{
devToolsClient
targetList
}
=
connection
;
actions
=
_actions
;
setupCommands
(
{
devToolsClient
targetList
}
)
;
setupEvents
(
{
actions
devToolsClient
}
)
;
const
{
targetFront
}
=
targetList
;
if
(
targetFront
.
isBrowsingContext
|
|
targetFront
.
isParentProcess
)
{
targetList
.
listenForWorkers
=
true
;
if
(
targetFront
.
localTab
&
&
features
.
windowlessServiceWorkers
)
{
targetList
.
listenForServiceWorkers
=
true
;
targetList
.
destroyServiceWorkersOnNavigation
=
true
;
}
await
targetList
.
startListening
(
)
;
}
await
targetList
.
watchTargets
(
targetList
.
ALL_TYPES
onTargetAvailable
onTargetDestroyed
)
;
}
async
function
onTargetAvailable
(
{
targetFront
isTargetSwitching
}
)
:
Promise
<
void
>
{
if
(
!
targetFront
.
isTopLevel
)
{
await
actions
.
addTarget
(
targetFront
)
;
return
;
}
if
(
isTargetSwitching
)
{
actions
.
willNavigate
(
{
url
:
targetFront
.
url
}
)
;
}
await
targetFront
.
onThreadAttached
;
const
{
threadFront
}
=
targetFront
;
if
(
!
threadFront
)
{
return
;
}
targetFront
.
on
(
"
will
-
navigate
"
actions
.
willNavigate
)
;
targetFront
.
on
(
"
navigate
"
actions
.
navigated
)
;
await
threadFront
.
reconfigure
(
{
observeAsmJS
:
true
pauseWorkersUntilAttach
:
true
skipBreakpoints
:
prefs
.
skipPausing
logEventBreakpoints
:
prefs
.
logEventBreakpoints
}
)
;
actions
.
getEventListenerBreakpointTypes
(
)
.
catch
(
e
=
>
console
.
error
(
e
)
)
;
actions
.
addEventListenerBreakpoints
(
[
]
)
.
catch
(
e
=
>
console
.
error
(
e
)
)
;
const
{
traits
}
=
targetFront
;
await
actions
.
connect
(
targetFront
.
url
threadFront
.
actor
traits
targetFront
.
isWebExtension
)
;
await
clientCommands
.
checkIfAlreadyPaused
(
)
;
await
actions
.
addTarget
(
targetFront
)
;
}
function
onTargetDestroyed
(
{
targetFront
}
)
:
void
{
if
(
targetFront
.
isTopLevel
)
{
targetFront
.
off
(
"
will
-
navigate
"
actions
.
willNavigate
)
;
targetFront
.
off
(
"
navigate
"
actions
.
navigated
)
;
}
actions
.
removeTarget
(
targetFront
)
;
}
export
{
clientCommands
clientEvents
}
;
