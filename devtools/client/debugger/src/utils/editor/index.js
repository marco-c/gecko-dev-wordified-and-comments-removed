export
*
from
"
.
/
source
-
documents
"
;
export
*
from
"
.
/
source
-
search
"
;
export
*
from
"
.
.
/
ui
"
;
export
*
from
"
.
/
tokens
"
;
import
{
createEditor
}
from
"
.
/
create
-
editor
"
;
import
{
isWasm
lineToWasmOffset
wasmOffsetToLine
}
from
"
.
.
/
wasm
"
;
import
{
createLocation
}
from
"
.
.
/
location
"
;
import
{
features
}
from
"
.
.
/
prefs
"
;
let
editor
;
export
function
getEditor
(
useCm6
)
{
if
(
editor
)
{
return
editor
;
}
editor
=
createEditor
(
{
cm6
:
useCm6
}
)
;
return
editor
;
}
export
function
removeEditor
(
)
{
editor
=
null
;
}
export
function
updateEditorLineWrapping
(
value
)
{
if
(
!
editor
)
{
return
;
}
editor
.
setLineWrapping
(
value
)
;
}
function
getCodeMirror
(
)
{
return
editor
&
&
editor
.
hasCodeMirror
?
editor
.
codeMirror
:
null
;
}
export
function
startOperation
(
)
{
const
codeMirror
=
getCodeMirror
(
)
;
if
(
!
codeMirror
)
{
return
;
}
codeMirror
.
startOperation
(
)
;
}
export
function
endOperation
(
)
{
const
codeMirror
=
getCodeMirror
(
)
;
if
(
!
codeMirror
)
{
return
;
}
codeMirror
.
endOperation
(
)
;
}
export
function
toWasmSourceLine
(
sourceId
offset
)
{
if
(
features
.
codemirrorNext
)
{
return
editor
.
wasmOffsetToLine
(
offset
)
|
|
0
;
}
return
wasmOffsetToLine
(
sourceId
offset
)
|
|
0
;
}
export
function
toEditorLine
(
source
lineOrOffset
)
{
if
(
features
.
codemirrorNext
)
{
if
(
editor
.
isWasm
&
&
!
source
.
isOriginal
)
{
return
toWasmSourceLine
(
source
.
id
lineOrOffset
)
+
1
;
}
return
lineOrOffset
;
}
if
(
isWasm
(
source
.
id
)
)
{
return
toWasmSourceLine
(
source
.
id
lineOrOffset
)
;
}
return
lineOrOffset
?
lineOrOffset
-
1
:
1
;
}
export
function
fromEditorLine
(
source
line
)
{
if
(
features
.
codemirrorNext
)
{
if
(
editor
.
isWasm
&
&
!
source
.
isOriginal
)
{
return
editor
.
lineToWasmOffset
(
line
-
1
)
;
}
return
line
;
}
if
(
isWasm
(
source
.
id
)
)
{
return
lineToWasmOffset
(
source
.
id
line
)
;
}
return
line
+
1
;
}
export
function
toEditorPosition
(
location
)
{
const
isSourceWasm
=
features
.
codemirrorNext
?
editor
.
isWasm
:
isWasm
(
location
.
source
.
id
)
;
return
{
line
:
toEditorLine
(
location
.
source
location
.
line
)
column
:
isSourceWasm
|
|
!
location
.
column
?
0
:
location
.
column
}
;
}
export
function
toSourceLine
(
source
line
)
{
if
(
features
.
codemirrorNext
)
{
if
(
editor
.
isWasm
&
&
!
source
.
isOriginal
)
{
return
editor
.
lineToWasmOffset
(
line
-
1
)
;
}
return
line
;
}
if
(
isWasm
(
source
.
id
)
)
{
return
lineToWasmOffset
(
source
.
id
line
)
;
}
return
line
+
1
;
}
export
function
markText
(
{
codeMirror
}
className
{
start
end
}
)
{
return
codeMirror
.
markText
(
{
ch
:
start
.
column
line
:
start
.
line
}
{
ch
:
end
.
column
line
:
end
.
line
}
{
className
}
)
;
}
export
function
lineAtHeight
(
{
codeMirror
}
source
event
)
{
const
_editorLine
=
codeMirror
.
lineAtHeight
(
event
.
clientY
)
;
return
toSourceLine
(
source
_editorLine
)
;
}
export
function
getSourceLocationFromMouseEvent
(
{
codeMirror
}
source
e
)
{
const
{
line
ch
}
=
codeMirror
.
coordsChar
(
{
left
:
e
.
clientX
top
:
e
.
clientY
}
)
;
const
isSourceWasm
=
features
.
codemirrorNext
?
editor
.
isWasm
:
isWasm
(
location
.
source
.
id
)
;
return
createLocation
(
{
source
line
:
fromEditorLine
(
source
line
)
column
:
isSourceWasm
?
0
:
ch
+
1
}
)
;
}
export
function
forEachLine
(
codeMirror
iter
)
{
codeMirror
.
operation
(
(
)
=
>
{
codeMirror
.
doc
.
iter
(
0
codeMirror
.
lineCount
(
)
iter
)
;
}
)
;
}
export
function
removeLineClass
(
codeMirror
line
className
)
{
codeMirror
.
removeLineClass
(
line
"
wrap
"
className
)
;
}
export
function
clearLineClass
(
codeMirror
className
)
{
forEachLine
(
codeMirror
line
=
>
{
removeLineClass
(
codeMirror
line
className
)
;
}
)
;
}
export
function
getTextForLine
(
codeMirror
line
)
{
return
codeMirror
.
getLine
(
line
-
1
)
.
trim
(
)
;
}
export
function
getCursorLine
(
codeMirror
)
{
return
codeMirror
.
getCursor
(
)
.
line
;
}
export
function
getCursorColumn
(
codeMirror
)
{
return
codeMirror
.
getCursor
(
)
.
ch
;
}
