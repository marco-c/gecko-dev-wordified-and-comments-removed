import
{
asSettled
}
from
"
.
/
async
-
value
"
;
import
{
validateContext
}
from
"
.
/
context
"
;
export
function
memoizeableAction
(
name
{
getValue
createKey
action
}
)
{
const
requests
=
new
Map
(
)
;
return
args
=
>
async
thunkArgs
=
>
{
let
result
=
asSettled
(
getValue
(
args
thunkArgs
)
)
;
if
(
!
result
)
{
const
key
=
createKey
(
args
thunkArgs
)
;
if
(
!
requests
.
has
(
key
)
)
{
requests
.
set
(
key
(
async
(
)
=
>
{
try
{
await
action
(
args
thunkArgs
)
;
}
catch
(
e
)
{
console
.
warn
(
Action
{
name
}
had
an
exception
:
e
)
;
}
finally
{
requests
.
delete
(
key
)
;
}
}
)
(
)
)
;
}
await
requests
.
get
(
key
)
;
if
(
args
.
cx
)
{
validateContext
(
thunkArgs
.
getState
(
)
args
.
cx
)
;
}
result
=
asSettled
(
getValue
(
args
thunkArgs
)
)
;
if
(
!
result
)
{
return
null
;
}
}
if
(
result
.
state
=
=
=
"
rejected
"
)
{
throw
result
.
value
;
}
return
result
.
value
;
}
;
}
