import
type
{
ThunkArgs
}
from
"
.
.
/
actions
/
types
"
;
import
{
asSettled
type
AsyncValue
}
from
"
.
/
async
-
value
"
;
export
type
MemoizedAction
<
Args
Result
>
=
Args
=
>
ThunkArgs
=
>
Promise
<
Result
|
null
>
;
type
MemoizableActionParams
<
Args
Result
>
=
{
getValue
:
(
args
:
Args
thunkArgs
:
ThunkArgs
)
=
>
AsyncValue
<
Result
>
|
null
createKey
:
(
args
:
Args
thunkArgs
:
ThunkArgs
)
=
>
string
action
:
(
args
:
Args
thunkArgs
:
ThunkArgs
)
=
>
Promise
<
mixed
>
}
;
export
function
memoizeableAction
<
Args
Result
>
(
name
:
string
{
getValue
createKey
action
}
:
MemoizableActionParams
<
Args
Result
>
)
:
MemoizedAction
<
Args
Result
>
{
const
requests
=
new
Map
(
)
;
return
args
=
>
async
thunkArgs
=
>
{
let
result
=
asSettled
(
getValue
(
args
thunkArgs
)
)
;
if
(
!
result
)
{
const
key
=
createKey
(
args
thunkArgs
)
;
if
(
!
requests
.
has
(
key
)
)
{
requests
.
set
(
key
(
async
(
)
=
>
{
try
{
await
action
(
args
thunkArgs
)
;
}
catch
(
e
)
{
console
.
warn
(
Action
{
name
}
had
an
exception
:
e
)
;
}
finally
{
requests
.
delete
(
key
)
;
}
}
)
(
)
)
;
}
await
requests
.
get
(
key
)
;
result
=
asSettled
(
getValue
(
args
thunkArgs
)
)
;
if
(
!
result
)
{
return
null
;
}
}
if
(
result
.
state
=
=
=
"
rejected
"
)
{
throw
result
.
value
;
}
return
result
.
value
;
}
;
}
