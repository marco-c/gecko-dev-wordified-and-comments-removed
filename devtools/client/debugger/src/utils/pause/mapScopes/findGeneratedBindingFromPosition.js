import
{
locColumn
}
from
"
.
/
locColumn
"
;
import
{
mappingContains
}
from
"
.
/
mappingContains
"
;
import
type
{
BindingContents
}
from
"
.
.
/
.
.
/
.
.
/
types
"
;
import
type
{
ApplicableBinding
}
from
"
.
/
getApplicableBindingsForOriginalPosition
"
;
import
{
createObjectFront
}
from
"
.
.
/
.
.
/
.
.
/
client
/
firefox
"
;
export
type
GeneratedDescriptor
=
{
name
:
string
desc
:
?
BindingContents
expression
:
string
}
;
export
async
function
findGeneratedReference
(
applicableBindings
:
Array
<
ApplicableBinding
>
)
:
Promise
<
GeneratedDescriptor
|
null
>
{
if
(
applicableBindings
.
length
>
4
)
{
applicableBindings
=
[
]
;
}
for
(
const
applicable
of
applicableBindings
)
{
const
result
=
await
mapBindingReferenceToDescriptor
(
applicable
)
;
if
(
result
)
{
return
result
;
}
}
return
null
;
}
export
async
function
findGeneratedImportReference
(
applicableBindings
:
Array
<
ApplicableBinding
>
)
:
Promise
<
GeneratedDescriptor
|
null
>
{
applicableBindings
=
applicableBindings
.
filter
(
(
applicable
i
)
=
>
{
if
(
!
applicable
.
firstInRange
|
|
applicable
.
binding
.
loc
.
type
!
=
=
"
ref
"
|
|
applicable
.
binding
.
loc
.
meta
)
{
return
true
;
}
const
next
=
i
+
1
<
applicableBindings
.
length
?
applicableBindings
[
i
+
1
]
:
null
;
return
!
next
|
|
next
.
binding
.
loc
.
type
!
=
=
"
ref
"
|
|
!
next
.
binding
.
loc
.
meta
;
}
)
;
if
(
applicableBindings
.
length
>
2
)
{
applicableBindings
=
[
]
;
}
for
(
const
applicable
of
applicableBindings
)
{
const
result
=
await
mapImportReferenceToDescriptor
(
applicable
)
;
if
(
result
)
{
return
result
;
}
}
return
null
;
}
export
async
function
findGeneratedImportDeclaration
(
applicableBindings
:
Array
<
ApplicableBinding
>
importName
:
string
)
:
Promise
<
GeneratedDescriptor
|
null
>
{
if
(
applicableBindings
.
length
>
10
)
{
applicableBindings
=
[
]
;
}
let
result
=
null
;
for
(
const
{
binding
}
of
applicableBindings
)
{
if
(
binding
.
loc
.
type
=
=
=
"
ref
"
)
{
continue
;
}
const
namespaceDesc
=
await
binding
.
desc
(
)
;
if
(
isPrimitiveValue
(
namespaceDesc
)
)
{
continue
;
}
if
(
!
isObjectValue
(
namespaceDesc
)
)
{
result
=
{
name
:
binding
.
name
desc
:
namespaceDesc
expression
:
binding
.
name
}
;
continue
;
}
const
desc
=
await
readDescriptorProperty
(
namespaceDesc
importName
)
;
const
expression
=
{
binding
.
name
}
.
{
importName
}
;
if
(
desc
)
{
result
=
{
name
:
binding
.
name
desc
expression
}
;
break
;
}
}
return
result
;
}
async
function
mapBindingReferenceToDescriptor
(
{
binding
range
firstInRange
firstOnLine
}
:
ApplicableBinding
)
:
Promise
<
GeneratedDescriptor
|
null
>
{
if
(
range
.
start
.
line
=
=
=
binding
.
loc
.
start
.
line
&
&
(
firstInRange
|
|
firstOnLine
|
|
locColumn
(
range
.
start
)
>
=
locColumn
(
binding
.
loc
.
start
)
)
&
&
locColumn
(
range
.
start
)
<
=
locColumn
(
binding
.
loc
.
end
)
)
{
return
{
name
:
binding
.
name
desc
:
await
binding
.
desc
(
)
expression
:
binding
.
name
}
;
}
return
null
;
}
async
function
mapImportReferenceToDescriptor
(
{
binding
range
}
:
ApplicableBinding
)
:
Promise
<
GeneratedDescriptor
|
null
>
{
if
(
binding
.
loc
.
type
!
=
=
"
ref
"
)
{
return
null
;
}
if
(
!
mappingContains
(
range
binding
.
loc
)
)
{
return
null
;
}
if
(
binding
.
name
=
=
=
"
__webpack_require__
"
&
&
binding
.
loc
.
meta
&
&
binding
.
loc
.
meta
.
type
=
=
=
"
member
"
&
&
binding
.
loc
.
meta
.
property
=
=
=
"
i
"
)
{
return
null
;
}
let
expression
=
binding
.
name
;
let
desc
=
await
binding
.
desc
(
)
;
if
(
binding
.
loc
.
type
=
=
=
"
ref
"
)
{
const
{
meta
}
=
binding
.
loc
;
for
(
let
op
=
meta
index
=
0
;
op
&
&
mappingContains
(
range
op
)
&
&
desc
&
&
index
<
2
;
index
+
+
op
=
op
&
&
op
.
parent
)
{
if
(
op
.
type
=
=
=
"
call
"
)
{
return
null
;
}
if
(
op
.
type
=
=
=
"
inherit
"
)
{
continue
;
}
desc
=
await
readDescriptorProperty
(
desc
op
.
property
)
;
expression
+
=
.
{
op
.
property
}
;
}
}
return
desc
?
{
name
:
binding
.
name
desc
expression
}
:
null
;
}
function
isPrimitiveValue
(
desc
:
?
BindingContents
)
{
return
desc
&
&
(
!
desc
.
value
|
|
typeof
desc
.
value
!
=
=
"
object
"
)
;
}
function
isObjectValue
(
desc
:
?
BindingContents
)
{
return
(
desc
&
&
!
isPrimitiveValue
(
desc
)
&
&
desc
.
value
.
type
=
=
=
"
object
"
&
&
!
desc
.
value
.
optimizedOut
)
;
}
async
function
readDescriptorProperty
(
desc
:
?
BindingContents
property
:
string
)
:
Promise
<
?
BindingContents
>
{
if
(
!
desc
)
{
return
null
;
}
if
(
typeof
desc
.
value
!
=
=
"
object
"
|
|
!
desc
.
value
)
{
return
{
value
:
{
type
:
"
undefined
"
}
}
;
}
if
(
!
isObjectValue
(
desc
)
)
{
return
desc
;
}
const
objectFront
=
createObjectFront
(
desc
.
value
)
;
return
(
await
objectFront
.
getProperty
(
property
)
)
.
descriptor
;
}
