import
{
has
}
from
"
lodash
"
;
import
type
{
SourceScope
BindingLocation
}
from
"
.
.
/
.
.
/
.
.
/
workers
/
parser
"
;
import
type
{
Scope
BindingContents
}
from
"
.
.
/
.
.
/
.
.
/
types
"
;
import
{
clientCommands
}
from
"
.
.
/
.
.
/
.
.
/
client
/
firefox
"
;
import
{
locColumn
}
from
"
.
/
locColumn
"
;
export
type
GeneratedBindingLocation
=
{
name
:
string
loc
:
BindingLocation
desc
:
(
)
=
>
Promise
<
BindingContents
|
null
>
}
;
export
function
buildGeneratedBindingList
(
scopes
:
Scope
generatedAstScopes
:
SourceScope
[
]
thisBinding
:
?
BindingContents
)
:
Array
<
GeneratedBindingLocation
>
{
const
frameThisOwner
=
generatedAstScopes
.
find
(
generated
=
>
"
this
"
in
generated
.
bindings
)
;
let
globalScope
=
null
;
const
clientScopes
=
[
]
;
for
(
let
s
=
scopes
;
s
;
s
=
s
.
parent
)
{
const
bindings
=
s
.
bindings
?
Object
.
assign
(
{
}
.
.
.
s
.
bindings
.
arguments
s
.
bindings
.
variables
)
:
{
}
;
clientScopes
.
push
(
bindings
)
;
globalScope
=
s
;
}
const
generatedMainScopes
=
generatedAstScopes
.
slice
(
0
-
2
)
;
const
generatedGlobalScopes
=
generatedAstScopes
.
slice
(
-
2
)
;
const
clientMainScopes
=
clientScopes
.
slice
(
0
generatedMainScopes
.
length
)
;
const
clientGlobalScopes
=
clientScopes
.
slice
(
generatedMainScopes
.
length
)
;
const
generatedBindings
=
generatedMainScopes
.
reduce
(
(
acc
generated
i
)
=
>
{
const
bindings
=
clientMainScopes
[
i
]
;
if
(
generated
=
=
=
frameThisOwner
&
&
thisBinding
)
{
bindings
.
this
=
{
value
:
thisBinding
}
;
}
for
(
const
name
of
Object
.
keys
(
generated
.
bindings
)
)
{
if
(
name
=
=
=
"
this
"
&
&
!
bindings
[
name
]
)
{
continue
;
}
const
{
refs
}
=
generated
.
bindings
[
name
]
;
for
(
const
loc
of
refs
)
{
acc
.
push
(
{
name
loc
desc
:
(
)
=
>
Promise
.
resolve
(
bindings
[
name
]
|
|
null
)
}
)
;
}
}
return
acc
;
}
[
]
)
;
for
(
const
generated
of
generatedGlobalScopes
)
{
for
(
const
name
of
Object
.
keys
(
generated
.
bindings
)
)
{
const
{
refs
}
=
generated
.
bindings
[
name
]
;
const
bindings
=
clientGlobalScopes
.
find
(
b
=
>
has
(
b
name
)
)
;
for
(
const
loc
of
refs
)
{
if
(
bindings
)
{
generatedBindings
.
push
(
{
name
loc
desc
:
(
)
=
>
Promise
.
resolve
(
bindings
[
name
]
)
}
)
;
}
else
{
const
globalGrip
=
globalScope
?
.
object
;
if
(
globalGrip
)
{
generatedBindings
.
push
(
{
name
loc
desc
:
async
(
)
=
>
{
const
objectFront
=
clientCommands
.
createObjectFront
(
globalGrip
)
;
return
(
await
objectFront
.
getProperty
(
name
)
)
.
descriptor
;
}
}
)
;
}
}
}
}
}
return
generatedBindings
.
sort
(
(
a
b
)
=
>
{
const
aStart
=
a
.
loc
.
start
;
const
bStart
=
b
.
loc
.
start
;
if
(
aStart
.
line
=
=
=
bStart
.
line
)
{
return
locColumn
(
aStart
)
-
locColumn
(
bStart
)
;
}
return
aStart
.
line
-
bStart
.
line
;
}
)
;
}
