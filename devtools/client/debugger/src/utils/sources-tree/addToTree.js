import
{
nodeHasChildren
isPathDirectory
partIsFile
createSourceNode
createDirectoryNode
}
from
"
.
/
utils
"
;
import
{
createTreeNodeMatcher
findNodeInContents
}
from
"
.
/
treeOrder
"
;
function
createNodeInTree
(
part
path
tree
index
)
{
const
node
=
createDirectoryNode
(
part
path
[
]
)
;
const
contents
=
tree
.
contents
.
slice
(
0
)
;
contents
.
splice
(
index
0
node
)
;
tree
.
contents
=
contents
;
return
node
;
}
function
findOrCreateNode
(
source
subTree
path
part
index
mainThreadHost
)
{
const
addedPartIsFile
=
partIsFile
(
index
source
.
parts
source
.
displayURL
)
;
const
{
found
:
childFound
index
:
childIndex
}
=
findNodeInContents
(
subTree
createTreeNodeMatcher
(
part
!
addedPartIsFile
mainThreadHost
)
)
;
if
(
!
childFound
)
{
return
createNodeInTree
(
part
path
subTree
childIndex
)
;
}
const
child
=
subTree
.
contents
[
childIndex
]
;
const
childIsFile
=
!
nodeHasChildren
(
child
)
;
if
(
childIsFile
!
=
addedPartIsFile
)
{
const
{
index
:
insertIndex
}
=
findNodeInContents
(
subTree
createTreeNodeMatcher
(
part
!
addedPartIsFile
mainThreadHost
source
true
)
)
;
return
createNodeInTree
(
part
path
subTree
insertIndex
)
;
}
return
child
;
}
function
traverseTree
(
source
tree
)
{
return
source
.
parts
.
reduce
(
(
subTree
{
part
path
mainThreadHostIfRoot
}
index
)
=
>
findOrCreateNode
(
source
subTree
path
part
index
mainThreadHostIfRoot
)
tree
)
;
}
function
addSourceToNode
(
node
source
)
{
const
url
=
source
.
displayURL
;
const
isFile
=
!
isPathDirectory
(
url
.
path
)
;
if
(
node
.
type
=
=
"
source
"
&
&
!
isFile
)
{
throw
new
Error
(
Unexpected
type
"
source
"
at
:
{
node
.
name
}
)
;
}
if
(
isFile
)
{
node
.
type
=
"
source
"
;
return
source
;
}
let
{
filename
}
=
url
;
if
(
filename
=
=
=
"
(
index
)
"
&
&
url
.
search
)
{
filename
=
url
.
search
;
}
else
{
filename
+
=
url
.
search
;
}
const
{
found
:
childFound
index
:
childIndex
}
=
findNodeInContents
(
node
createTreeNodeMatcher
(
filename
false
null
)
)
;
if
(
childFound
)
{
const
existingNode
=
node
.
contents
[
childIndex
]
;
if
(
existingNode
.
type
=
=
=
"
source
"
)
{
existingNode
.
contents
=
source
;
}
return
node
.
contents
;
}
const
newNode
=
createSourceNode
(
filename
source
.
url
source
)
;
const
contents
=
node
.
contents
.
slice
(
0
)
;
contents
.
splice
(
childIndex
0
newNode
)
;
return
contents
;
}
export
function
addToTree
(
tree
source
)
{
const
finalNode
=
traverseTree
(
source
tree
)
;
finalNode
.
contents
=
addSourceToNode
(
finalNode
source
)
;
}
