import
{
isOriginalId
}
from
"
devtools
/
client
/
shared
/
source
-
map
-
loader
/
index
"
;
import
{
isSimilarTab
}
from
"
.
.
/
utils
/
tabs
"
;
export
function
initialTabState
(
)
{
return
{
tabs
:
[
]
}
;
}
function
update
(
state
=
initialTabState
(
)
action
)
{
switch
(
action
.
type
)
{
case
"
ADD_TAB
"
:
return
updateTabList
(
state
action
.
source
action
.
sourceActor
)
;
case
"
MOVE_TAB
"
:
return
moveTabInList
(
state
action
)
;
case
"
MOVE_TAB_BY_SOURCE_ID
"
:
return
moveTabInListBySourceId
(
state
action
)
;
case
"
CLOSE_TAB
"
:
return
removeSourceFromTabList
(
state
action
)
;
case
"
CLOSE_TABS
"
:
return
removeSourcesFromTabList
(
state
action
)
;
case
"
ADD_ORIGINAL_SOURCES
"
:
return
addVisibleTabsForOriginalSources
(
state
action
.
originalSources
action
.
generatedSourceActor
)
;
case
"
INSERT_SOURCE_ACTORS
"
:
return
addVisibleTabsForSourceActors
(
state
action
.
sourceActors
)
;
case
"
REMOVE_THREAD
"
:
{
return
resetTabsForThread
(
state
action
.
threadActorID
)
;
}
default
:
return
state
;
}
}
function
matchesSource
(
tab
source
)
{
return
tab
.
source
?
.
id
=
=
=
source
.
id
|
|
matchesUrl
(
tab
source
)
;
}
function
matchesUrl
(
tab
source
)
{
return
tab
.
url
=
=
=
source
.
url
&
&
tab
.
isOriginal
=
=
isOriginalId
(
source
.
id
)
;
}
function
addVisibleTabsForSourceActors
(
state
sourceActors
)
{
let
changed
=
false
;
const
tabs
=
state
.
tabs
.
map
(
tab
=
>
{
const
sourceActor
=
sourceActors
.
find
(
actor
=
>
matchesUrl
(
tab
actor
.
sourceObject
)
)
;
if
(
!
sourceActor
)
{
return
tab
;
}
changed
=
true
;
return
{
.
.
.
tab
source
:
sourceActor
.
sourceObject
sourceActor
}
;
}
)
;
return
changed
?
{
tabs
}
:
state
;
}
function
addVisibleTabsForOriginalSources
(
state
sources
generatedSourceActor
)
{
let
changed
=
false
;
const
tabs
=
state
.
tabs
.
map
(
tab
=
>
{
const
source
=
sources
.
find
(
s
=
>
matchesUrl
(
tab
s
)
)
;
if
(
!
source
)
{
return
tab
;
}
changed
=
true
;
return
{
.
.
.
tab
source
sourceActor
:
generatedSourceActor
}
;
}
)
;
return
changed
?
{
tabs
}
:
state
;
}
function
removeSourceFromTabList
(
state
{
source
}
)
{
const
newTabs
=
state
.
tabs
.
filter
(
tab
=
>
!
matchesSource
(
tab
source
)
)
;
if
(
newTabs
.
length
=
=
state
.
tabs
.
length
)
{
return
state
;
}
return
{
tabs
:
newTabs
}
;
}
function
removeSourcesFromTabList
(
state
{
sources
}
)
{
const
newTabs
=
sources
.
reduce
(
(
tabList
source
)
=
>
tabList
.
filter
(
tab
=
>
!
matchesSource
(
tab
source
)
)
state
.
tabs
)
;
if
(
newTabs
.
length
=
=
state
.
tabs
.
length
)
{
return
state
;
}
return
{
tabs
:
newTabs
}
;
}
function
resetTabsForThread
(
state
threadActorID
)
{
let
changed
=
false
;
const
tabs
=
state
.
tabs
.
map
(
tab
=
>
{
if
(
tab
.
sourceActor
?
.
thread
!
=
threadActorID
)
{
return
tab
;
}
changed
=
true
;
return
{
.
.
.
tab
source
:
null
sourceActor
:
null
}
;
}
)
;
return
changed
?
{
tabs
}
:
state
;
}
function
updateTabList
(
state
source
sourceActor
)
{
const
{
url
}
=
source
;
const
isOriginal
=
isOriginalId
(
source
.
id
)
;
let
{
tabs
}
=
state
;
const
currentIndex
=
url
?
tabs
.
findIndex
(
tab
=
>
isSimilarTab
(
tab
url
isOriginal
)
)
:
-
1
;
if
(
currentIndex
=
=
=
-
1
)
{
const
newTab
=
{
url
source
isOriginal
sourceActor
}
;
tabs
=
[
newTab
.
.
.
tabs
]
;
}
else
{
return
state
;
}
return
{
.
.
.
state
tabs
}
;
}
function
moveTabInList
(
state
{
url
tabIndex
:
newIndex
}
)
{
const
{
tabs
}
=
state
;
const
currentIndex
=
tabs
.
findIndex
(
tab
=
>
tab
.
url
=
=
url
)
;
return
moveTab
(
tabs
currentIndex
newIndex
)
;
}
function
moveTabInListBySourceId
(
state
{
sourceId
tabIndex
:
newIndex
}
)
{
const
{
tabs
}
=
state
;
const
currentIndex
=
tabs
.
findIndex
(
tab
=
>
tab
.
source
?
.
id
=
=
sourceId
)
;
return
moveTab
(
tabs
currentIndex
newIndex
)
;
}
function
moveTab
(
tabs
currentIndex
newIndex
)
{
const
item
=
tabs
[
currentIndex
]
;
const
newTabs
=
Array
.
from
(
tabs
)
;
newTabs
.
splice
(
currentIndex
1
)
;
newTabs
.
splice
(
newIndex
0
item
)
;
return
{
tabs
:
newTabs
}
;
}
export
default
update
;
