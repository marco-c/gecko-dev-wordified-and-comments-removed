import
type
{
Action
}
from
"
.
.
/
actions
/
types
"
;
import
type
{
SourceId
ThreadId
}
from
"
.
.
/
types
"
;
import
{
createInitial
insertResources
removeResources
hasResource
getItem
createFieldByIDGetter
createFieldReducer
type
ResourceState
type
FieldReducer
type
FieldByIDGetter
}
from
"
.
.
/
utils
/
resource
"
;
export
opaque
type
SourceActorId
=
string
;
export
type
SourceActor
=
{
|
id
:
SourceActorId
actor
:
string
thread
:
ThreadId
source
:
SourceId
isBlackBoxed
:
boolean
sourceMapURL
:
string
|
null
url
:
string
|
null
introductionUrl
:
string
|
null
introductionType
:
string
|
null
|
}
;
type
SourceActorResource
=
{
|
item
:
SourceActor
|
}
;
export
type
SourceActorsState
=
ResourceState
<
SourceActorResource
>
;
export
type
SourceActorOuterState
=
{
sourceActors
:
SourceActorsState
}
;
const
initial
:
SourceActorsState
=
createInitial
(
{
item
:
{
}
}
)
;
export
default
function
update
(
state
:
SourceActorsState
=
initial
action
:
Action
)
:
SourceActorsState
{
switch
(
action
.
type
)
{
case
"
INSERT_SOURCE_ACTORS
"
:
{
const
{
items
}
=
action
;
state
=
insertResources
(
state
items
.
map
(
item
=
>
(
{
item
}
)
)
)
;
break
;
}
case
"
REMOVE_SOURCE_ACTORS
"
:
{
const
{
items
}
=
action
;
state
=
removeResources
(
state
items
)
;
break
;
}
case
"
NAVIGATE
"
:
{
state
=
initial
;
break
;
}
}
return
state
;
}
export
function
stringToSourceActorId
(
s
:
string
)
:
SourceActorId
{
return
s
;
}
export
function
hasSourceActor
(
state
:
SourceActorOuterState
id
:
SourceActorId
)
:
boolean
{
return
hasResource
(
state
.
sourceActors
id
)
;
}
export
function
getSourceActor
(
state
:
SourceActorOuterState
id
:
SourceActorId
)
:
SourceActor
{
return
getItem
(
state
.
sourceActors
id
)
;
}
const
getSourceActorsById
:
FieldByIDGetter
<
SourceActorResource
"
item
"
>
=
createFieldByIDGetter
(
"
item
"
)
;
export
function
getSourceActors
(
state
:
SourceActorOuterState
ids
:
Array
<
SourceActorId
>
)
:
Array
<
SourceActor
>
{
return
getSourceActorsById
(
state
.
sourceActors
ids
)
;
}
const
getSourcesByThreadID
:
FieldReducer
<
SourceActorResource
{
[
ThreadId
]
:
Array
<
SourceActor
>
}
>
=
createFieldReducer
(
"
item
"
(
acc
item
id
)
=
>
{
acc
[
item
.
thread
]
=
acc
[
item
.
thread
]
|
|
[
]
;
acc
[
item
.
thread
]
.
push
(
item
)
;
return
acc
;
}
(
)
=
>
(
{
}
)
)
;
export
function
getSourceActorsForThread
(
state
:
SourceActorOuterState
ids
:
ThreadId
|
Array
<
ThreadId
>
)
:
Array
<
SourceActor
>
{
const
sourcesByThread
=
getSourcesByThreadID
(
state
.
sourceActors
)
;
let
sources
=
[
]
;
for
(
const
id
of
Array
.
isArray
(
ids
)
?
ids
:
[
ids
]
)
{
sources
=
sources
.
concat
(
sourcesByThread
[
id
]
|
|
[
]
)
;
}
return
sources
;
}
const
getThreadsBySourceObject
:
FieldReducer
<
SourceActorResource
{
[
SourceId
]
:
Array
<
ThreadId
>
}
>
=
createFieldReducer
(
"
item
"
(
acc
item
id
)
=
>
{
let
sourceThreads
=
acc
[
item
.
source
]
;
if
(
!
sourceThreads
)
{
sourceThreads
=
[
]
;
acc
[
item
.
source
]
=
sourceThreads
;
}
sourceThreads
.
push
(
item
.
thread
)
;
return
acc
;
}
(
)
=
>
(
{
}
)
)
;
export
function
getThreadsBySource
(
state
:
SourceActorOuterState
)
:
{
[
SourceId
]
:
Array
<
ThreadId
>
}
{
return
getThreadsBySourceObject
(
state
.
sourceActors
)
;
}
