import
getMatches
from
"
.
/
get
-
matches
"
;
import
type
{
Source
}
from
"
.
.
/
.
.
/
types
"
;
export
function
findSourceMatches
(
source
:
Source
queryText
:
string
)
:
Object
[
]
{
const
{
id
loadedState
text
}
=
source
;
if
(
loadedState
!
=
"
loaded
"
|
|
typeof
text
!
=
"
string
"
|
|
queryText
=
=
"
"
)
{
return
[
]
;
}
const
modifiers
=
{
caseSensitive
:
false
regexMatch
:
false
wholeWord
:
false
}
;
const
lines
=
text
.
split
(
"
\
n
"
)
;
return
getMatches
(
queryText
text
modifiers
)
.
map
(
(
{
line
ch
}
)
=
>
{
const
{
value
matchIndex
}
=
truncateLine
(
lines
[
line
]
ch
)
;
return
{
sourceId
:
id
line
:
line
+
1
column
:
ch
matchIndex
match
:
queryText
value
}
;
}
)
;
}
const
startRegex
=
/
(
[
!
#
%
^
&
*
(
)
_
+
\
-
=
\
[
\
]
{
}
;
'
:
"
\
\
|
.
<
>
\
/
?
]
)
/
g
;
const
endRegex
=
new
RegExp
(
[
"
(
[
!
#
%
^
&
*
(
)
_
+
-
=
[
]
{
}
;
'
:
\
"
\
\
|
.
<
>
/
?
]
)
"
'
[
^
!
#
%
^
&
*
(
)
_
+
-
=
[
]
{
}
;
\
'
:
"
\
\
|
.
<
>
/
?
]
*
"
/
'
]
.
join
(
"
"
)
)
;
function
truncateLine
(
text
column
)
{
if
(
text
.
length
<
100
)
{
return
{
matchIndex
:
column
value
:
text
}
;
}
const
offset
=
Math
.
max
(
column
-
40
0
)
;
const
truncStr
=
text
.
slice
(
offset
column
+
400
)
;
let
start
=
truncStr
.
search
(
startRegex
)
;
let
end
=
truncStr
.
search
(
endRegex
)
;
if
(
start
>
column
)
{
start
=
-
1
;
}
if
(
end
<
column
)
{
end
=
truncStr
.
length
;
}
const
value
=
truncStr
.
slice
(
start
+
1
end
)
;
return
{
matchIndex
:
column
-
start
-
offset
-
1
value
}
;
}
