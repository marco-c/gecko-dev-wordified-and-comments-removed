import
{
generatedToOriginalId
}
from
"
devtools
/
client
/
shared
/
source
-
map
-
loader
/
index
"
;
import
assert
from
"
.
.
/
.
.
/
utils
/
assert
"
;
import
{
recordEvent
}
from
"
.
.
/
.
.
/
utils
/
telemetry
"
;
import
{
updateBreakpointsForNewPrettyPrintedSource
}
from
"
.
.
/
breakpoints
"
;
import
{
setSymbols
}
from
"
.
/
symbols
"
;
import
{
getPrettySourceURL
isGenerated
isJavaScript
}
from
"
.
.
/
.
.
/
utils
/
source
"
;
import
{
isFulfilled
}
from
"
.
.
/
.
.
/
utils
/
async
-
value
"
;
import
{
loadGeneratedSourceText
}
from
"
.
/
loadSourceText
"
;
import
{
mapFrames
}
from
"
.
.
/
pause
"
;
import
{
selectSpecificLocation
}
from
"
.
.
/
sources
"
;
import
{
createPrettyPrintOriginalSource
}
from
"
.
.
/
.
.
/
client
/
firefox
/
create
"
;
import
{
getSource
getFirstSourceActorForGeneratedSource
getSourceFromId
getSourceByURL
getSelectedLocation
getThreadContext
}
from
"
.
.
/
.
.
/
selectors
"
;
import
{
selectSource
}
from
"
.
/
select
"
;
function
getPrettyOriginalSourceURL
(
generatedSource
)
{
return
getPrettySourceURL
(
generatedSource
.
url
|
|
generatedSource
.
id
)
;
}
export
async
function
prettyPrintSource
(
sourceMaps
prettyPrintWorker
generatedSource
content
actors
)
{
if
(
!
content
|
|
!
isFulfilled
(
content
)
)
{
throw
new
Error
(
"
Cannot
pretty
-
print
a
file
that
has
not
loaded
"
)
;
}
const
contentValue
=
content
.
value
;
if
(
!
isJavaScript
(
generatedSource
contentValue
)
|
|
contentValue
.
type
!
=
=
"
text
"
)
{
throw
new
Error
(
"
Can
'
t
prettify
non
-
javascript
files
.
"
)
;
}
const
url
=
getPrettyOriginalSourceURL
(
generatedSource
)
;
const
{
code
mappings
}
=
await
prettyPrintWorker
.
prettyPrint
(
{
text
:
contentValue
.
value
url
}
)
;
await
sourceMaps
.
applySourceMap
(
generatedSource
.
id
url
code
mappings
)
;
for
(
const
{
actor
}
of
actors
)
{
await
sourceMaps
.
applySourceMap
(
actor
url
code
mappings
)
;
}
return
{
text
:
code
contentType
:
"
text
/
javascript
"
}
;
}
export
function
createPrettySource
(
cx
sourceId
)
{
return
async
(
{
dispatch
getState
sourceMaps
}
)
=
>
{
const
source
=
getSourceFromId
(
getState
(
)
sourceId
)
;
const
url
=
getPrettyOriginalSourceURL
(
source
)
;
const
id
=
generatedToOriginalId
(
sourceId
url
)
;
const
prettySource
=
createPrettyPrintOriginalSource
(
id
url
)
;
dispatch
(
{
type
:
"
ADD_ORIGINAL_SOURCES
"
cx
originalSources
:
[
prettySource
]
}
)
;
await
dispatch
(
selectSource
(
cx
id
)
)
;
return
prettySource
;
}
;
}
function
selectPrettyLocation
(
cx
prettySource
generatedLocation
)
{
return
async
(
{
dispatch
sourceMaps
getState
}
)
=
>
{
let
location
=
generatedLocation
?
generatedLocation
:
getSelectedLocation
(
getState
(
)
)
;
if
(
location
&
&
location
.
line
>
=
1
)
{
location
=
await
sourceMaps
.
getOriginalLocation
(
location
)
;
return
dispatch
(
selectSpecificLocation
(
cx
{
.
.
.
location
sourceId
:
prettySource
.
id
}
)
)
;
}
return
dispatch
(
selectSource
(
cx
prettySource
.
id
)
)
;
}
;
}
export
function
togglePrettyPrint
(
cx
sourceId
)
{
return
async
(
{
dispatch
getState
client
sourceMaps
}
)
=
>
{
const
source
=
getSource
(
getState
(
)
sourceId
)
;
if
(
!
source
)
{
return
{
}
;
}
if
(
!
source
.
isPrettyPrinted
)
{
recordEvent
(
"
pretty_print
"
)
;
}
assert
(
isGenerated
(
source
)
"
Pretty
-
printing
only
allowed
on
generated
sources
"
)
;
const
sourceActor
=
getFirstSourceActorForGeneratedSource
(
getState
(
)
source
.
id
)
;
await
dispatch
(
loadGeneratedSourceText
(
{
cx
sourceActor
}
)
)
;
const
url
=
getPrettySourceURL
(
source
.
url
)
;
const
prettySource
=
getSourceByURL
(
getState
(
)
url
)
;
if
(
prettySource
)
{
return
dispatch
(
selectPrettyLocation
(
cx
prettySource
)
)
;
}
const
selectedLocation
=
getSelectedLocation
(
getState
(
)
)
;
const
newPrettySource
=
await
dispatch
(
createPrettySource
(
cx
sourceId
)
)
;
await
dispatch
(
selectPrettyLocation
(
cx
newPrettySource
selectedLocation
)
)
;
const
threadcx
=
getThreadContext
(
getState
(
)
)
;
await
dispatch
(
mapFrames
(
threadcx
)
)
;
await
dispatch
(
setSymbols
(
{
cx
source
:
newPrettySource
sourceActor
}
)
)
;
await
dispatch
(
updateBreakpointsForNewPrettyPrintedSource
(
cx
sourceId
)
)
;
return
newPrettySource
;
}
;
}
