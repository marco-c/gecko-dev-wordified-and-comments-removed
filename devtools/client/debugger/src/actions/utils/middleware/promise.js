import
{
fromPairs
toPairs
}
from
"
lodash
"
;
import
{
executeSoon
}
from
"
.
.
/
.
.
/
.
.
/
utils
/
DevToolsUtils
"
;
import
{
pending
rejected
fulfilled
}
from
"
.
.
/
.
.
/
.
.
/
utils
/
async
-
value
"
;
export
function
asyncActionAsValue
(
action
)
{
if
(
action
.
status
=
=
=
"
start
"
)
{
return
pending
(
)
;
}
if
(
action
.
status
=
=
=
"
error
"
)
{
return
rejected
(
action
.
error
)
;
}
return
fulfilled
(
action
.
value
)
;
}
let
seqIdVal
=
1
;
function
seqIdGen
(
)
{
return
seqIdVal
+
+
;
}
function
filterAction
(
action
)
{
return
fromPairs
(
toPairs
(
action
)
.
filter
(
pair
=
>
pair
[
0
]
!
=
=
PROMISE
)
)
;
}
function
promiseMiddleware
(
{
dispatch
getState
}
)
{
return
next
=
>
action
=
>
{
if
(
!
(
PROMISE
in
action
)
)
{
return
next
(
action
)
;
}
const
promiseInst
=
action
[
PROMISE
]
;
const
seqId
=
seqIdGen
(
)
.
toString
(
)
;
action
=
{
.
.
.
filterAction
(
action
)
seqId
}
;
dispatch
(
{
.
.
.
action
status
:
"
start
"
}
)
;
return
Promise
.
resolve
(
promiseInst
)
.
finally
(
(
)
=
>
new
Promise
(
resolve
=
>
executeSoon
(
resolve
)
)
)
.
then
(
value
=
>
{
dispatch
(
{
.
.
.
action
status
:
"
done
"
value
:
value
}
)
;
return
value
;
}
error
=
>
{
dispatch
(
{
.
.
.
action
status
:
"
error
"
error
:
error
.
message
|
|
error
}
)
;
return
Promise
.
reject
(
error
)
;
}
)
;
}
;
}
export
const
PROMISE
=
"
dispatch
/
promise
"
;
export
{
promiseMiddleware
as
promise
}
;
