function
findBreakpoint
(
dbg
url
line
)
{
const
{
selectors
:
{
getBreakpoint
}
getState
}
=
dbg
;
const
source
=
findSource
(
dbg
url
)
;
return
getBreakpoint
(
getState
(
)
{
sourceId
:
source
.
id
line
}
)
;
}
function
getLineEl
(
dbg
line
)
{
const
lines
=
dbg
.
win
.
document
.
querySelectorAll
(
"
.
CodeMirror
-
code
>
div
"
)
;
return
lines
[
line
-
1
]
;
}
function
assertEditorBreakpoint
(
dbg
line
shouldExist
)
{
const
exists
=
getLineEl
(
dbg
line
)
.
classList
.
contains
(
"
has
-
condition
"
)
;
ok
(
exists
=
=
=
shouldExist
"
Breakpoint
"
+
(
shouldExist
?
"
exists
"
:
"
does
not
exist
"
)
+
"
on
line
"
+
line
)
;
}
function
waitForElementFocus
(
dbg
el
)
{
const
doc
=
dbg
.
win
.
document
;
return
waitFor
(
(
)
=
>
doc
.
activeElement
=
=
el
&
&
doc
.
hasFocus
(
)
)
;
}
async
function
assertConditionalBreakpointIsFocused
(
dbg
)
{
const
input
=
findElement
(
dbg
"
conditionalPanelInput
"
)
;
await
waitForElementFocus
(
dbg
input
)
;
}
async
function
setConditionalBreakpoint
(
dbg
index
condition
)
{
const
{
addConditionalBreakpoint
editBreakpoint
}
=
selectors
.
gutterContextMenu
;
const
selector
=
{
addConditionalBreakpoint
}
{
editBreakpoint
}
;
rightClickElement
(
dbg
"
gutter
"
index
)
;
selectContextMenuItem
(
dbg
selector
)
;
await
waitForElement
(
dbg
"
conditionalPanelInput
"
)
;
await
assertConditionalBreakpointIsFocused
(
dbg
)
;
pressKey
(
dbg
"
End
"
)
;
type
(
dbg
condition
)
;
pressKey
(
dbg
"
Enter
"
)
;
}
add_task
(
async
function
(
)
{
const
dbg
=
await
initDebugger
(
"
doc
-
scripts
.
html
"
"
simple2
"
)
;
await
selectSource
(
dbg
"
simple2
"
)
;
await
waitForSelectedSource
(
dbg
"
simple2
"
)
;
await
setConditionalBreakpoint
(
dbg
5
"
1
"
)
;
await
waitForDispatch
(
dbg
"
ADD_BREAKPOINT
"
)
;
let
bp
=
findBreakpoint
(
dbg
"
simple2
"
5
)
;
is
(
bp
.
condition
"
1
"
"
breakpoint
is
created
with
the
condition
"
)
;
assertEditorBreakpoint
(
dbg
5
true
)
;
await
setConditionalBreakpoint
(
dbg
5
"
2
"
)
;
await
waitForDispatch
(
dbg
"
SET_BREAKPOINT_CONDITION
"
)
;
bp
=
findBreakpoint
(
dbg
"
simple2
"
5
)
;
is
(
bp
.
condition
"
12
"
"
breakpoint
is
created
with
the
condition
"
)
;
assertEditorBreakpoint
(
dbg
5
true
)
;
clickElement
(
dbg
"
gutter
"
5
)
;
await
waitForDispatch
(
dbg
"
REMOVE_BREAKPOINT
"
)
;
bp
=
findBreakpoint
(
dbg
"
simple2
"
5
)
;
is
(
bp
null
"
breakpoint
was
removed
"
)
;
assertEditorBreakpoint
(
dbg
5
false
)
;
clickElement
(
dbg
"
gutter
"
5
)
;
await
waitForDispatch
(
dbg
"
ADD_BREAKPOINT
"
)
;
await
setConditionalBreakpoint
(
dbg
5
"
1
"
)
;
await
waitForDispatch
(
dbg
"
SET_BREAKPOINT_CONDITION
"
)
;
bp
=
findBreakpoint
(
dbg
"
simple2
"
5
)
;
is
(
bp
.
condition
"
1
"
"
breakpoint
is
created
with
the
condition
"
)
;
assertEditorBreakpoint
(
dbg
5
true
)
;
const
bpCondition
=
waitForDispatch
(
dbg
"
SET_BREAKPOINT_CONDITION
"
)
;
rightClickElement
(
dbg
"
breakpointItem
"
3
)
selectContextMenuItem
(
dbg
selectors
.
breakpointContextMenu
.
removeCondition
)
;
await
bpCondition
;
bp
=
findBreakpoint
(
dbg
"
simple2
"
5
)
;
is
(
bp
.
condition
undefined
"
breakpoint
condition
removed
"
)
;
}
)
;
