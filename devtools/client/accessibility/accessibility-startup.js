"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
PROMOTE_COUNT_PREF
=
"
devtools
.
promote
.
accessibility
"
;
class
AccessibilityStartup
{
constructor
(
toolbox
)
{
this
.
toolbox
=
toolbox
;
this
.
_updateToolHighlight
=
this
.
_updateToolHighlight
.
bind
(
this
)
;
this
.
initAccessibility
(
)
;
}
get
target
(
)
{
return
this
.
toolbox
.
target
;
}
get
accessibility
(
)
{
return
this
.
_accessibility
;
}
get
walker
(
)
{
return
this
.
_walker
;
}
initAccessibility
(
)
{
if
(
!
this
.
_initAccessibility
)
{
this
.
_initAccessibility
=
(
async
function
(
)
{
this
.
_accessibility
=
this
.
target
.
getFront
(
"
accessibility
"
)
;
this
.
_walker
=
await
this
.
_accessibility
.
getWalker
(
)
;
this
.
_supportsLatestAccessibility
=
await
this
.
target
.
actorHasMethod
(
"
accessibility
"
"
enable
"
)
;
if
(
this
.
_supportsLatestAccessibility
)
{
await
this
.
_accessibility
.
bootstrap
(
)
;
}
this
.
_updateToolHighlight
(
)
;
this
.
_accessibility
.
on
(
"
init
"
this
.
_updateToolHighlight
)
;
this
.
_accessibility
.
on
(
"
shutdown
"
this
.
_updateToolHighlight
)
;
}
.
bind
(
this
)
)
(
)
;
}
return
this
.
_initAccessibility
;
}
destroyAccessibility
(
)
{
if
(
this
.
_destroyingAccessibility
)
{
return
this
.
_destroyingAccessibility
;
}
this
.
_destroyingAccessibility
=
(
async
function
(
)
{
if
(
!
this
.
_accessibility
)
{
return
;
}
await
this
.
_initAccessibility
;
this
.
_accessibility
.
off
(
"
init
"
this
.
_updateToolHighlight
)
;
this
.
_accessibility
.
off
(
"
shutdown
"
this
.
_updateToolHighlight
)
;
await
this
.
_walker
.
destroy
(
)
;
this
.
_accessibility
=
null
;
this
.
_walker
=
null
;
}
.
bind
(
this
)
)
(
)
;
return
this
.
_destroyingAccessibility
;
}
async
_updateToolHighlight
(
)
{
const
isHighlighted
=
await
this
.
toolbox
.
isToolHighlighted
(
"
accessibility
"
)
;
if
(
this
.
_accessibility
.
enabled
&
&
!
isHighlighted
)
{
this
.
toolbox
.
highlightTool
(
"
accessibility
"
)
;
}
else
if
(
!
this
.
_accessibility
.
enabled
&
&
isHighlighted
)
{
this
.
toolbox
.
unhighlightTool
(
"
accessibility
"
)
;
}
}
updatePanelPromoteCount
(
)
{
Services
.
prefs
.
setIntPref
(
PROMOTE_COUNT_PREF
0
)
;
}
async
destroy
(
)
{
await
this
.
destroyAccessibility
(
)
;
this
.
toolbox
=
null
;
}
}
exports
.
AccessibilityStartup
=
AccessibilityStartup
;
