"
use
strict
"
;
const
{
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
const
kDebuggerPrefs
=
[
"
devtools
.
debugger
.
remote
-
enabled
"
"
devtools
.
chrome
.
enabled
"
]
;
const
{
XPCOMUtils
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
{
}
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
Services
"
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
function
DevToolsStartup
(
)
{
}
DevToolsStartup
.
prototype
=
{
handle
:
function
(
cmdLine
)
{
let
consoleFlag
=
cmdLine
.
handleFlag
(
"
jsconsole
"
false
)
;
let
debuggerFlag
=
cmdLine
.
handleFlag
(
"
jsdebugger
"
false
)
;
let
devtoolsFlag
=
cmdLine
.
handleFlag
(
"
devtools
"
false
)
;
if
(
consoleFlag
)
{
this
.
handleConsoleFlag
(
cmdLine
)
;
}
if
(
debuggerFlag
)
{
this
.
handleDebuggerFlag
(
cmdLine
)
;
}
let
debuggerServerFlag
;
try
{
debuggerServerFlag
=
cmdLine
.
handleFlagWithParam
(
"
start
-
debugger
-
server
"
false
)
;
}
catch
(
e
)
{
debuggerServerFlag
=
cmdLine
.
handleFlag
(
"
start
-
debugger
-
server
"
false
)
;
}
if
(
debuggerServerFlag
)
{
this
.
handleDebuggerServerFlag
(
cmdLine
debuggerServerFlag
)
;
}
let
onStartup
=
function
(
window
)
{
Services
.
obs
.
removeObserver
(
onStartup
"
browser
-
delayed
-
startup
-
finished
"
)
;
this
.
initDevTools
(
)
;
if
(
devtoolsFlag
)
{
this
.
handleDevToolsFlag
(
window
)
;
}
}
.
bind
(
this
)
;
Services
.
obs
.
addObserver
(
onStartup
"
browser
-
delayed
-
startup
-
finished
"
false
)
;
}
initDevTools
:
function
(
)
{
let
{
loader
}
=
Cu
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
loader
.
require
(
"
devtools
/
client
/
framework
/
devtools
-
browser
"
)
;
}
handleConsoleFlag
:
function
(
cmdLine
)
{
let
window
=
Services
.
wm
.
getMostRecentWindow
(
"
devtools
:
webconsole
"
)
;
if
(
!
window
)
{
this
.
initDevTools
(
)
;
let
{
require
}
=
Cu
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
let
hudservice
=
require
(
"
devtools
/
client
/
webconsole
/
hudservice
"
)
;
let
{
console
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Console
.
jsm
"
{
}
)
;
hudservice
.
toggleBrowserConsole
(
)
.
then
(
null
console
.
error
)
;
}
else
{
window
.
focus
(
)
;
}
if
(
cmdLine
.
state
=
=
Ci
.
nsICommandLine
.
STATE_REMOTE_AUTO
)
{
cmdLine
.
preventDefault
=
true
;
}
}
handleDevToolsFlag
:
function
(
window
)
{
const
{
require
}
=
Cu
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
const
{
gDevTools
}
=
require
(
"
devtools
/
client
/
framework
/
devtools
"
)
;
const
{
TargetFactory
}
=
require
(
"
devtools
/
client
/
framework
/
target
"
)
;
let
target
=
TargetFactory
.
forTab
(
window
.
gBrowser
.
selectedTab
)
;
gDevTools
.
showToolbox
(
target
)
;
}
_isRemoteDebuggingEnabled
(
)
{
let
remoteDebuggingEnabled
=
false
;
try
{
remoteDebuggingEnabled
=
kDebuggerPrefs
.
every
(
pref
=
>
{
return
Services
.
prefs
.
getBoolPref
(
pref
)
;
}
)
;
}
catch
(
ex
)
{
let
{
console
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Console
.
jsm
"
{
}
)
;
console
.
error
(
ex
)
;
return
false
;
}
if
(
!
remoteDebuggingEnabled
)
{
let
errorMsg
=
"
Could
not
run
chrome
debugger
!
You
need
the
following
"
+
"
prefs
to
be
set
to
true
:
"
+
kDebuggerPrefs
.
join
(
"
"
)
;
let
{
console
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Console
.
jsm
"
{
}
)
;
console
.
error
(
new
Error
(
errorMsg
)
)
;
dump
(
errorMsg
+
"
\
n
"
)
;
}
return
remoteDebuggingEnabled
;
}
handleDebuggerFlag
:
function
(
cmdLine
)
{
if
(
!
this
.
_isRemoteDebuggingEnabled
(
)
)
{
return
;
}
const
{
BrowserToolboxProcess
}
=
Cu
.
import
(
"
resource
:
/
/
devtools
/
client
/
framework
/
ToolboxProcess
.
jsm
"
{
}
)
;
BrowserToolboxProcess
.
init
(
)
;
if
(
cmdLine
.
state
=
=
Ci
.
nsICommandLine
.
STATE_REMOTE_AUTO
)
{
cmdLine
.
preventDefault
=
true
;
}
}
handleDebuggerServerFlag
:
function
(
cmdLine
portOrPath
)
{
if
(
!
this
.
_isRemoteDebuggingEnabled
(
)
)
{
return
;
}
let
webSocket
=
false
;
let
defaultPort
=
Services
.
prefs
.
getIntPref
(
"
devtools
.
debugger
.
remote
-
port
"
)
;
if
(
portOrPath
=
=
=
true
)
{
webSocket
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
debugger
.
remote
-
websocket
"
)
;
portOrPath
=
defaultPort
;
}
else
if
(
portOrPath
.
startsWith
(
"
ws
:
"
)
)
{
webSocket
=
true
;
let
port
=
portOrPath
.
slice
(
3
)
;
portOrPath
=
Number
(
port
)
?
port
:
defaultPort
;
}
let
{
DevToolsLoader
}
=
Cu
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
try
{
let
serverLoader
=
new
DevToolsLoader
(
)
;
serverLoader
.
invisibleToDebugger
=
true
;
let
{
DebuggerServer
:
debuggerServer
}
=
serverLoader
.
require
(
"
devtools
/
server
/
main
"
)
;
debuggerServer
.
init
(
)
;
debuggerServer
.
addBrowserActors
(
)
;
debuggerServer
.
allowChromeProcess
=
true
;
let
listener
=
debuggerServer
.
createListener
(
)
;
listener
.
portOrPath
=
portOrPath
;
listener
.
webSocket
=
webSocket
;
listener
.
open
(
)
;
dump
(
"
Started
debugger
server
on
"
+
portOrPath
+
"
\
n
"
)
;
}
catch
(
e
)
{
dump
(
"
Unable
to
start
debugger
server
on
"
+
portOrPath
+
"
:
"
+
e
)
;
}
if
(
cmdLine
.
state
=
=
Ci
.
nsICommandLine
.
STATE_REMOTE_AUTO
)
{
cmdLine
.
preventDefault
=
true
;
}
}
helpInfo
:
"
-
-
jsconsole
Open
the
Browser
Console
.
\
n
"
+
"
-
-
jsdebugger
Open
the
Browser
Toolbox
.
\
n
"
+
"
-
-
devtools
Open
DevTools
on
initial
load
.
\
n
"
+
"
-
-
start
-
debugger
-
server
[
ws
:
]
[
<
port
>
|
<
path
>
]
Start
the
debugger
server
on
\
n
"
+
"
a
TCP
port
or
Unix
domain
socket
path
.
Defaults
to
TCP
port
\
n
"
+
"
6000
.
Use
WebSocket
protocol
if
ws
:
prefix
is
specified
.
\
n
"
classID
:
Components
.
ID
(
"
{
9e9a9283
-
0ce9
-
4e4a
-
8f1c
-
ba129a032c32
}
"
)
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsICommandLineHandler
]
)
}
;
this
.
NSGetFactory
=
XPCOMUtils
.
generateNSGetFactory
(
[
DevToolsStartup
]
)
;
