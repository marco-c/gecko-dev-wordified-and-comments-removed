"
use
strict
"
;
add_task
(
function
*
(
)
{
let
{
monitor
}
=
yield
initNetMonitor
(
SIMPLE_URL
)
;
let
{
getRequestFilterTypes
}
=
monitor
.
panelWin
.
windowRequire
(
"
devtools
/
client
/
netmonitor
/
selectors
/
index
"
)
;
let
Actions
=
monitor
.
panelWin
.
windowRequire
(
"
devtools
/
client
/
netmonitor
/
actions
/
index
"
)
;
info
(
"
Starting
test
.
.
.
"
)
;
requestLongerTimeout
(
3
)
;
let
getDoc
=
(
)
=
>
monitor
.
panelWin
.
document
;
let
getPrefs
=
(
)
=
>
monitor
.
panelWin
.
windowRequire
(
"
devtools
/
client
/
netmonitor
/
prefs
"
)
.
Prefs
;
let
getStore
=
(
)
=
>
monitor
.
panelWin
.
gStore
;
let
getState
=
(
)
=
>
getStore
(
)
.
getState
(
)
;
let
prefsToCheck
=
{
filters
:
{
newValue
:
[
"
html
"
"
css
"
]
validateValue
:
(
)
=
>
getRequestFilterTypes
(
getState
(
)
)
.
filter
(
(
[
type
check
]
)
=
>
check
)
.
map
(
(
[
type
check
]
)
=
>
type
)
modifyFrontend
:
(
value
)
=
>
value
.
forEach
(
e
=
>
getStore
(
)
.
dispatch
(
Actions
.
toggleRequestFilterType
(
e
)
)
)
}
networkDetailsWidth
:
{
newValue
:
~
~
(
Math
.
random
(
)
*
200
+
100
)
validateValue
:
(
)
=
>
getDoc
(
)
.
querySelector
(
"
.
monitor
-
panel
.
split
-
box
.
controlled
"
)
.
clientWidth
modifyFrontend
:
(
value
)
=
>
getDoc
(
)
.
querySelector
(
"
.
monitor
-
panel
.
split
-
box
.
controlled
"
)
.
style
.
width
=
{
value
}
px
}
networkDetailsHeight
:
{
newValue
:
~
~
(
Math
.
random
(
)
*
300
+
100
)
validateValue
:
(
)
=
>
getDoc
(
)
.
querySelector
(
"
.
monitor
-
panel
.
split
-
box
.
controlled
"
)
.
clientHeight
modifyFrontend
:
(
value
)
=
>
getDoc
(
)
.
querySelector
(
"
.
monitor
-
panel
.
split
-
box
.
controlled
"
)
.
style
.
height
=
{
value
}
px
}
}
;
yield
testBottom
(
)
;
yield
testSide
(
)
;
yield
testWindow
(
)
;
info
(
"
Moving
toolbox
back
to
the
bottom
.
.
.
"
)
;
yield
monitor
.
_toolbox
.
switchHost
(
Toolbox
.
HostType
.
BOTTOM
)
;
return
teardown
(
monitor
)
;
function
storeFirstPrefValues
(
)
{
info
(
"
Caching
initial
pref
values
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
let
currentValue
=
getPrefs
(
)
[
name
]
;
prefsToCheck
[
name
]
.
firstValue
=
currentValue
;
}
}
function
validateFirstPrefValues
(
isVerticalSplitter
)
{
info
(
"
Validating
current
pref
values
to
the
UI
elements
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
if
(
(
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsHeight
"
)
|
|
(
!
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsWidth
"
)
)
{
continue
}
let
currentValue
=
getPrefs
(
)
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
is
(
firstValue
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
be
equal
to
first
value
:
"
+
currentValue
)
;
is
(
validateValue
(
)
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
validate
:
"
+
currentValue
)
;
}
}
function
modifyFrontend
(
isVerticalSplitter
)
{
info
(
"
Modifying
UI
elements
to
the
specified
new
values
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
if
(
(
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsHeight
"
)
|
|
(
!
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsWidth
"
)
)
{
continue
}
let
currentValue
=
getPrefs
(
)
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
newValue
=
prefsToCheck
[
name
]
.
newValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
let
modFrontend
=
prefsToCheck
[
name
]
.
modifyFrontend
;
modFrontend
(
newValue
)
;
info
(
"
Modified
UI
element
affecting
"
+
name
+
"
to
:
"
+
newValue
)
;
is
(
firstValue
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
still
be
equal
to
first
value
:
"
+
currentValue
)
;
isnot
(
newValue
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
'
t
yet
be
equal
to
second
value
:
"
+
currentValue
)
;
is
(
validateValue
(
)
.
toSource
(
)
newValue
.
toSource
(
)
"
The
UI
element
affecting
"
+
name
+
"
should
validate
:
"
+
newValue
)
;
}
}
function
validateNewPrefValues
(
isVerticalSplitter
)
{
info
(
"
Invalidating
old
pref
values
to
the
modified
UI
elements
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
if
(
(
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsHeight
"
)
|
|
(
!
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsWidth
"
)
)
{
continue
}
let
currentValue
=
getPrefs
(
)
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
newValue
=
prefsToCheck
[
name
]
.
newValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
isnot
(
firstValue
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
'
t
be
equal
to
first
value
:
"
+
currentValue
)
;
is
(
newValue
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
now
be
equal
to
second
value
:
"
+
currentValue
)
;
is
(
validateValue
(
)
.
toSource
(
)
newValue
.
toSource
(
)
"
The
UI
element
affecting
"
+
name
+
"
should
validate
:
"
+
newValue
)
;
}
}
function
resetFrontend
(
isVerticalSplitter
)
{
info
(
"
Resetting
UI
elements
to
the
cached
initial
pref
values
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
if
(
(
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsHeight
"
)
|
|
(
!
isVerticalSplitter
&
&
name
=
=
=
"
networkDetailsWidth
"
)
)
{
continue
}
let
currentValue
=
getPrefs
(
)
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
newValue
=
prefsToCheck
[
name
]
.
newValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
let
modFrontend
=
prefsToCheck
[
name
]
.
modifyFrontend
;
modFrontend
(
firstValue
)
;
info
(
"
Modified
UI
element
affecting
"
+
name
+
"
to
:
"
+
firstValue
)
;
isnot
(
firstValue
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
'
t
yet
be
equal
to
first
value
:
"
+
currentValue
)
;
is
(
newValue
.
toSource
(
)
currentValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
still
be
equal
to
second
value
:
"
+
currentValue
)
;
is
(
validateValue
(
)
.
toSource
(
)
firstValue
.
toSource
(
)
"
The
UI
element
affecting
"
+
name
+
"
should
validate
:
"
+
firstValue
)
;
}
}
function
*
restartNetMonitorAndSetupEnv
(
)
{
let
newMonitor
=
yield
restartNetMonitor
(
monitor
)
;
monitor
=
newMonitor
.
monitor
;
let
networkEvent
=
waitForNetworkEvents
(
monitor
1
)
;
newMonitor
.
tab
.
linkedBrowser
.
reload
(
)
;
yield
networkEvent
;
let
wait
=
waitForDOM
(
getDoc
(
)
"
.
network
-
details
-
panel
"
)
;
EventUtils
.
sendMouseEvent
(
{
type
:
"
click
"
}
getDoc
(
)
.
querySelector
(
"
.
network
-
details
-
panel
-
toggle
"
)
)
;
yield
wait
;
}
function
*
testBottom
(
)
{
yield
restartNetMonitorAndSetupEnv
(
)
;
info
(
"
Testing
prefs
reload
for
a
bottom
host
.
"
)
;
storeFirstPrefValues
(
)
;
validateFirstPrefValues
(
true
)
;
modifyFrontend
(
true
)
;
yield
restartNetMonitorAndSetupEnv
(
)
;
validateNewPrefValues
(
true
)
;
resetFrontend
(
true
)
;
yield
restartNetMonitorAndSetupEnv
(
)
;
validateFirstPrefValues
(
true
)
;
}
function
*
testSide
(
)
{
yield
restartNetMonitorAndSetupEnv
(
)
;
info
(
"
Moving
toolbox
to
the
side
.
.
.
"
)
;
yield
monitor
.
_toolbox
.
switchHost
(
Toolbox
.
HostType
.
SIDE
)
;
info
(
"
Testing
prefs
reload
for
a
side
host
.
"
)
;
storeFirstPrefValues
(
)
;
validateFirstPrefValues
(
false
)
;
modifyFrontend
(
false
)
;
yield
restartNetMonitorAndSetupEnv
(
)
;
validateNewPrefValues
(
false
)
;
resetFrontend
(
false
)
;
yield
restartNetMonitorAndSetupEnv
(
)
;
validateFirstPrefValues
(
false
)
;
}
function
*
testWindow
(
)
{
yield
restartNetMonitorAndSetupEnv
(
)
;
info
(
"
Moving
toolbox
into
a
window
.
.
.
"
)
;
yield
monitor
.
_toolbox
.
switchHost
(
Toolbox
.
HostType
.
WINDOW
)
;
info
(
"
Testing
prefs
reload
for
a
window
host
.
"
)
;
storeFirstPrefValues
(
)
;
validateFirstPrefValues
(
true
)
;
modifyFrontend
(
true
)
;
yield
restartNetMonitorAndSetupEnv
(
)
;
validateNewPrefValues
(
true
)
;
resetFrontend
(
true
)
;
yield
restartNetMonitorAndSetupEnv
(
)
;
validateFirstPrefValues
(
true
)
;
}
}
)
;
