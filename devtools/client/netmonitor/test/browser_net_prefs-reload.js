"
use
strict
"
;
add_task
(
function
*
(
)
{
let
Actions
=
require
(
"
devtools
/
client
/
netmonitor
/
actions
/
index
"
)
;
let
{
getActiveFilters
}
=
require
(
"
devtools
/
client
/
netmonitor
/
selectors
/
index
"
)
;
let
{
monitor
}
=
yield
initNetMonitor
(
SIMPLE_URL
)
;
let
{
document
gStore
Prefs
}
=
monitor
.
panelWin
;
info
(
"
Starting
test
.
.
.
"
)
;
requestLongerTimeout
(
3
)
;
let
getStore
=
(
)
=
>
gStore
;
let
getState
=
(
)
=
>
getStore
(
)
.
getState
(
)
;
let
prefsToCheck
=
{
filters
:
{
newValue
:
[
"
html
"
"
css
"
]
validateValue
:
(
)
=
>
getActiveFilters
(
getState
(
)
)
modifyFrontend
:
(
value
)
=
>
value
.
forEach
(
e
=
>
getStore
(
)
.
dispatch
(
Actions
.
toggleRequestFilterType
(
e
)
)
)
}
networkDetailsWidth
:
{
newValue
:
~
~
(
Math
.
random
(
)
*
200
+
100
)
validateValue
:
(
)
=
>
~
~
document
.
querySelector
(
"
.
network
-
details
-
panel
"
)
.
getAttribute
(
"
width
"
)
modifyFrontend
:
(
value
)
=
>
document
.
querySelector
(
"
.
network
-
details
-
panel
"
)
.
setAttribute
(
"
width
"
value
)
}
networkDetailsHeight
:
{
newValue
:
~
~
(
Math
.
random
(
)
*
300
+
100
)
validateValue
:
(
)
=
>
~
~
document
.
querySelector
(
"
.
network
-
details
-
panel
"
)
.
getAttribute
(
"
height
"
)
modifyFrontend
:
(
value
)
=
>
document
.
querySelector
(
"
.
network
-
details
-
panel
"
)
.
setAttribute
(
"
height
"
value
)
}
}
;
yield
testBottom
(
)
;
yield
testSide
(
)
;
yield
testWindow
(
)
;
info
(
"
Moving
toolbox
back
to
the
bottom
.
.
.
"
)
;
yield
monitor
.
_toolbox
.
switchHost
(
Toolbox
.
HostType
.
BOTTOM
)
;
return
teardown
(
monitor
)
;
function
storeFirstPrefValues
(
)
{
info
(
"
Caching
initial
pref
values
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
let
currentValue
=
Prefs
[
name
]
;
prefsToCheck
[
name
]
.
firstValue
=
currentValue
;
}
}
function
validateFirstPrefValues
(
)
{
info
(
"
Validating
current
pref
values
to
the
UI
elements
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
let
currentValue
=
Prefs
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
is
(
currentValue
.
toSource
(
)
firstValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
be
equal
to
first
value
:
"
+
firstValue
)
;
is
(
currentValue
.
toSource
(
)
validateValue
(
)
.
toSource
(
)
"
Pref
"
+
name
+
"
should
validate
:
"
+
currentValue
)
;
}
}
function
modifyFrontend
(
)
{
info
(
"
Modifying
UI
elements
to
the
specified
new
values
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
let
currentValue
=
Prefs
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
newValue
=
prefsToCheck
[
name
]
.
newValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
let
modFrontend
=
prefsToCheck
[
name
]
.
modifyFrontend
;
modFrontend
(
newValue
)
;
info
(
"
Modified
UI
element
affecting
"
+
name
+
"
to
:
"
+
newValue
)
;
is
(
currentValue
.
toSource
(
)
firstValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
still
be
equal
to
first
value
:
"
+
firstValue
)
;
isnot
(
currentValue
.
toSource
(
)
newValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
'
t
yet
be
equal
to
second
value
:
"
+
newValue
)
;
is
(
newValue
.
toSource
(
)
validateValue
(
)
.
toSource
(
)
"
The
UI
element
affecting
"
+
name
+
"
should
validate
:
"
+
newValue
)
;
}
}
function
validateNewPrefValues
(
)
{
info
(
"
Invalidating
old
pref
values
to
the
modified
UI
elements
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
let
currentValue
=
Prefs
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
newValue
=
prefsToCheck
[
name
]
.
newValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
isnot
(
currentValue
.
toSource
(
)
firstValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
'
t
be
equal
to
first
value
:
"
+
firstValue
)
;
is
(
currentValue
.
toSource
(
)
newValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
now
be
equal
to
second
value
:
"
+
newValue
)
;
is
(
newValue
.
toSource
(
)
validateValue
(
)
.
toSource
(
)
"
The
UI
element
affecting
"
+
name
+
"
should
validate
:
"
+
newValue
)
;
}
}
function
resetFrontend
(
)
{
info
(
"
Resetting
UI
elements
to
the
cached
initial
pref
values
.
"
)
;
for
(
let
name
in
prefsToCheck
)
{
let
currentValue
=
Prefs
[
name
]
;
let
firstValue
=
prefsToCheck
[
name
]
.
firstValue
;
let
newValue
=
prefsToCheck
[
name
]
.
newValue
;
let
validateValue
=
prefsToCheck
[
name
]
.
validateValue
;
let
modFrontend
=
prefsToCheck
[
name
]
.
modifyFrontend
;
modFrontend
(
firstValue
)
;
info
(
"
Modified
UI
element
affecting
"
+
name
+
"
to
:
"
+
firstValue
)
;
isnot
(
currentValue
.
toSource
(
)
firstValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
'
t
yet
be
equal
to
first
value
:
"
+
firstValue
)
;
is
(
currentValue
.
toSource
(
)
newValue
.
toSource
(
)
"
Pref
"
+
name
+
"
should
still
be
equal
to
second
value
:
"
+
newValue
)
;
is
(
firstValue
.
toSource
(
)
validateValue
(
)
.
toSource
(
)
"
The
UI
element
affecting
"
+
name
+
"
should
validate
:
"
+
firstValue
)
;
}
}
function
*
testBottom
(
)
{
info
(
"
Testing
prefs
reload
for
a
bottom
host
.
"
)
;
storeFirstPrefValues
(
)
;
validateFirstPrefValues
(
)
;
modifyFrontend
(
)
;
let
newMonitor
=
yield
restartNetMonitor
(
monitor
)
;
monitor
=
newMonitor
.
monitor
;
validateNewPrefValues
(
)
;
resetFrontend
(
)
;
newMonitor
=
yield
restartNetMonitor
(
monitor
)
;
monitor
=
newMonitor
.
monitor
;
validateFirstPrefValues
(
)
;
}
function
*
testSide
(
)
{
info
(
"
Moving
toolbox
to
the
side
.
.
.
"
)
;
yield
monitor
.
_toolbox
.
switchHost
(
Toolbox
.
HostType
.
SIDE
)
;
info
(
"
Testing
prefs
reload
for
a
side
host
.
"
)
;
storeFirstPrefValues
(
)
;
validateFirstPrefValues
(
)
;
modifyFrontend
(
)
;
let
newMonitor
=
yield
restartNetMonitor
(
monitor
)
;
monitor
=
newMonitor
.
monitor
;
validateNewPrefValues
(
)
;
resetFrontend
(
)
;
newMonitor
=
yield
restartNetMonitor
(
monitor
)
;
monitor
=
newMonitor
.
monitor
;
validateFirstPrefValues
(
)
;
}
function
*
testWindow
(
)
{
info
(
"
Moving
toolbox
into
a
window
.
.
.
"
)
;
yield
monitor
.
_toolbox
.
switchHost
(
Toolbox
.
HostType
.
WINDOW
)
;
info
(
"
Testing
prefs
reload
for
a
window
host
.
"
)
;
storeFirstPrefValues
(
)
;
validateFirstPrefValues
(
)
;
modifyFrontend
(
)
;
let
newMonitor
=
yield
restartNetMonitor
(
monitor
)
;
monitor
=
newMonitor
.
monitor
;
validateNewPrefValues
(
)
;
resetFrontend
(
)
;
newMonitor
=
yield
restartNetMonitor
(
monitor
)
;
monitor
=
newMonitor
.
monitor
;
validateFirstPrefValues
(
)
;
}
}
)
;
