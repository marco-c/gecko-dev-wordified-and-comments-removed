"
use
strict
"
;
add_task
(
function
*
(
)
{
const
EXPECTED_REQUESTS
=
[
{
status
:
302
hasStack
:
true
}
{
status
:
200
hasStack
:
false
}
{
status
:
200
hasStack
:
true
}
]
;
let
{
tab
monitor
}
=
yield
initNetMonitor
(
CUSTOM_GET_URL
)
;
let
{
RequestsMenu
}
=
monitor
.
panelWin
.
NetMonitorView
;
RequestsMenu
.
lazyUpdate
=
false
;
let
wait
=
waitForNetworkEvents
(
monitor
EXPECTED_REQUESTS
.
length
)
;
yield
performRequests
(
2
HSTS_SJS
)
;
yield
wait
;
EXPECTED_REQUESTS
.
forEach
(
(
{
status
hasStack
}
i
)
=
>
{
let
item
=
RequestsMenu
.
getItemAtIndex
(
i
)
;
is
(
item
.
status
status
Request
#
{
i
}
has
the
expected
status
)
;
let
{
stacktrace
}
=
item
.
cause
;
let
stackLen
=
stacktrace
?
stacktrace
.
length
:
0
;
if
(
hasStack
)
{
ok
(
stacktrace
Request
#
{
i
}
has
a
stacktrace
)
;
ok
(
stackLen
>
0
Request
#
{
i
}
has
a
stacktrace
with
{
stackLen
}
items
)
;
}
else
{
is
(
stackLen
0
Request
#
{
i
}
has
an
empty
stacktrace
)
;
}
}
)
;
wait
=
waitForNetworkEvents
(
monitor
1
)
;
yield
performRequests
(
1
HSTS_SJS
+
"
?
reset
"
)
;
yield
wait
;
yield
teardown
(
monitor
)
;
function
performRequests
(
count
url
)
{
return
ContentTask
.
spawn
(
tab
.
linkedBrowser
{
count
url
}
function
*
(
args
)
{
content
.
wrappedJSObject
.
performRequests
(
args
.
count
args
.
url
)
;
}
)
;
}
}
)
;
