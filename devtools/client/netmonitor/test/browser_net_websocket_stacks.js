"
use
strict
"
;
const
TOP_FILE_NAME
=
"
html_websocket
-
test
-
page
.
html
"
;
const
TOP_URL
=
EXAMPLE_URL
+
TOP_FILE_NAME
;
const
WORKER_FILE_NAME
=
"
js_websocket
-
worker
-
test
.
js
"
;
const
EXPECTED_REQUESTS
=
{
[
TOP_URL
]
:
{
method
:
"
GET
"
url
:
TOP_URL
causeType
:
"
document
"
causeUri
:
null
stack
:
false
}
"
ws
:
/
/
localhost
:
8080
/
"
:
{
method
:
"
GET
"
url
:
"
ws
:
/
/
localhost
:
8080
/
"
causeType
:
"
websocket
"
causeUri
:
TOP_URL
stack
:
[
{
fn
:
"
openSocket
"
file
:
TOP_URL
line
:
6
}
{
file
:
TOP_FILE_NAME
line
:
3
}
]
}
[
EXAMPLE_URL
+
WORKER_FILE_NAME
]
:
{
method
:
"
GET
"
url
:
EXAMPLE_URL
+
WORKER_FILE_NAME
causeType
:
"
script
"
causeUri
:
TOP_URL
stack
:
[
{
file
:
TOP_URL
line
:
9
}
]
}
"
wss
:
/
/
localhost
:
8081
/
"
:
{
method
:
"
GET
"
url
:
"
wss
:
/
/
localhost
:
8081
/
"
causeType
:
"
websocket
"
causeUri
:
TOP_URL
stack
:
[
{
fn
:
"
openWorkerSocket
"
file
:
EXAMPLE_URL
+
WORKER_FILE_NAME
line
:
5
}
{
file
:
WORKER_FILE_NAME
line
:
2
}
]
}
}
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
fission
.
bfcacheInParent
"
false
]
]
}
)
;
const
{
monitor
}
=
await
initNetMonitor
(
SIMPLE_URL
{
requestCount
:
1
}
)
;
const
{
store
windowRequire
connector
}
=
monitor
.
panelWin
;
const
{
getSortedRequests
}
=
windowRequire
(
"
devtools
/
client
/
netmonitor
/
src
/
selectors
/
index
"
)
;
const
onNetworkEvents
=
waitForNetworkEvents
(
monitor
Object
.
keys
(
EXPECTED_REQUESTS
)
.
length
)
;
await
navigateTo
(
TOP_URL
)
;
await
onNetworkEvents
;
is
(
store
.
getState
(
)
.
requests
.
requests
.
length
Object
.
keys
(
EXPECTED_REQUESTS
)
.
length
"
All
the
page
events
should
be
recorded
.
"
)
;
const
requests
=
getSortedRequests
(
store
.
getState
(
)
)
;
const
expectedRequests
=
[
]
;
await
Promise
.
all
(
requests
.
map
(
request
=
>
{
expectedRequests
.
push
(
EXPECTED_REQUESTS
[
request
.
url
]
)
;
return
connector
.
requestData
(
request
.
id
"
stackTrace
"
)
;
}
)
)
;
validateRequests
(
expectedRequests
monitor
)
;
await
teardown
(
monitor
)
;
}
)
;
