"
use
strict
"
;
const
I
=
require
(
"
devtools
/
client
/
shared
/
vendor
/
immutable
"
)
;
const
{
getUrlDetails
processNetworkUpdates
}
=
require
(
"
.
.
/
utils
/
request
-
utils
"
)
;
const
{
ADD_REQUEST
CLEAR_REQUESTS
CLONE_SELECTED_REQUEST
OPEN_NETWORK_DETAILS
REMOVE_SELECTED_CUSTOM_REQUEST
SELECT_REQUEST
SEND_CUSTOM_REQUEST
TOGGLE_RECORDING
UPDATE_REQUEST
}
=
require
(
"
.
.
/
constants
"
)
;
const
Request
=
I
.
Record
(
{
id
:
null
isCustom
:
false
startedMillis
:
undefined
endedMillis
:
undefined
method
:
undefined
url
:
undefined
urlDetails
:
undefined
remotePort
:
undefined
remoteAddress
:
undefined
isXHR
:
undefined
cause
:
undefined
fromCache
:
undefined
fromServiceWorker
:
undefined
status
:
undefined
statusText
:
undefined
httpVersion
:
undefined
securityState
:
undefined
securityInfo
:
undefined
mimeType
:
"
text
/
plain
"
contentSize
:
undefined
transferredSize
:
undefined
totalTime
:
undefined
eventTimings
:
undefined
headersSize
:
undefined
customQueryValue
:
undefined
requestHeaders
:
undefined
requestHeadersFromUploadStream
:
undefined
requestCookies
:
undefined
requestPostData
:
undefined
responseHeaders
:
undefined
responseCookies
:
undefined
responseContent
:
undefined
responseContentDataUri
:
undefined
formDataSections
:
undefined
}
)
;
const
Requests
=
I
.
Record
(
{
requests
:
I
.
Map
(
)
selectedId
:
null
preselectedId
:
null
firstStartedMillis
:
+
Infinity
lastEndedMillis
:
-
Infinity
recording
:
true
}
)
;
function
closeCustomRequest
(
state
)
{
let
{
requests
selectedId
}
=
state
;
if
(
!
selectedId
)
{
return
state
;
}
let
removedRequest
=
requests
.
get
(
selectedId
)
;
if
(
!
removedRequest
|
|
!
removedRequest
.
isCustom
)
{
return
state
;
}
return
state
.
withMutations
(
st
=
>
{
st
.
requests
=
st
.
requests
.
delete
(
selectedId
)
;
st
.
selectedId
=
null
;
}
)
;
}
function
requestsReducer
(
state
=
new
Requests
(
)
action
)
{
switch
(
action
.
type
)
{
case
ADD_REQUEST
:
{
return
state
.
withMutations
(
st
=
>
{
let
newRequest
=
new
Request
(
Object
.
assign
(
{
id
:
action
.
id
}
action
.
data
{
urlDetails
:
getUrlDetails
(
action
.
data
.
url
)
}
)
)
;
st
.
requests
=
st
.
requests
.
set
(
newRequest
.
id
newRequest
)
;
let
{
startedMillis
}
=
action
.
data
;
if
(
startedMillis
<
st
.
firstStartedMillis
)
{
st
.
firstStartedMillis
=
startedMillis
;
}
if
(
startedMillis
>
st
.
lastEndedMillis
)
{
st
.
lastEndedMillis
=
startedMillis
;
}
if
(
st
.
preselectedId
&
&
st
.
preselectedId
=
=
=
action
.
id
)
{
st
.
selectedId
=
st
.
selectedId
|
|
st
.
preselectedId
;
st
.
preselectedId
=
null
;
}
}
)
;
}
case
CLEAR_REQUESTS
:
{
return
new
Requests
(
{
recording
:
state
.
recording
}
)
;
}
case
CLONE_SELECTED_REQUEST
:
{
let
{
requests
selectedId
}
=
state
;
if
(
!
selectedId
)
{
return
state
;
}
let
clonedRequest
=
requests
.
get
(
selectedId
)
;
if
(
!
clonedRequest
)
{
return
state
;
}
let
newRequest
=
new
Request
(
{
id
:
clonedRequest
.
id
+
"
-
clone
"
method
:
clonedRequest
.
method
url
:
clonedRequest
.
url
urlDetails
:
clonedRequest
.
urlDetails
requestHeaders
:
clonedRequest
.
requestHeaders
requestPostData
:
clonedRequest
.
requestPostData
isCustom
:
true
}
)
;
return
state
.
withMutations
(
st
=
>
{
st
.
requests
=
requests
.
set
(
newRequest
.
id
newRequest
)
;
st
.
selectedId
=
newRequest
.
id
;
}
)
;
}
case
OPEN_NETWORK_DETAILS
:
{
if
(
!
action
.
open
)
{
return
state
.
set
(
"
selectedId
"
null
)
;
}
if
(
!
state
.
selectedId
&
&
!
state
.
requests
.
isEmpty
(
)
)
{
return
state
.
set
(
"
selectedId
"
state
.
requests
.
first
(
)
.
id
)
;
}
return
state
;
}
case
REMOVE_SELECTED_CUSTOM_REQUEST
:
{
return
closeCustomRequest
(
state
)
;
}
case
SELECT_REQUEST
:
{
return
state
.
set
(
"
selectedId
"
action
.
id
)
;
}
case
SEND_CUSTOM_REQUEST
:
{
return
closeCustomRequest
(
state
.
set
(
"
preselectedId
"
action
.
id
)
)
;
}
case
TOGGLE_RECORDING
:
{
return
state
.
set
(
"
recording
"
!
state
.
recording
)
;
}
case
UPDATE_REQUEST
:
{
let
{
requests
lastEndedMillis
}
=
state
;
let
updatedRequest
=
requests
.
get
(
action
.
id
)
;
if
(
!
updatedRequest
)
{
return
state
;
}
updatedRequest
=
updatedRequest
.
withMutations
(
request
=
>
{
let
values
=
processNetworkUpdates
(
action
.
data
)
;
request
=
Object
.
assign
(
request
values
)
;
}
)
;
return
state
.
withMutations
(
st
=
>
{
st
.
requests
=
requests
.
set
(
updatedRequest
.
id
updatedRequest
)
;
st
.
lastEndedMillis
=
lastEndedMillis
;
}
)
;
}
default
:
return
state
;
}
}
module
.
exports
=
{
Requests
requestsReducer
}
;
