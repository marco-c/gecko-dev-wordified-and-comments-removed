"
use
strict
"
;
const
{
gDevTools
}
=
require
(
"
devtools
/
client
/
framework
/
devtools
"
)
;
const
{
TOGGLE_REQUEST_FILTER_TYPE
ENABLE_REQUEST_FILTER_TYPE_ONLY
SET_REQUEST_FILTER_TEXT
SELECT_DETAILS_PANEL_TAB
SEND_CUSTOM_REQUEST
ENABLE_PERSISTENT_LOGS
WS_SELECT_FRAME
}
=
require
(
"
devtools
/
client
/
netmonitor
/
src
/
constants
"
)
;
const
{
CHANGE_NETWORK_THROTTLING
}
=
require
(
"
devtools
/
client
/
shared
/
components
/
throttling
/
actions
"
)
;
function
eventTelemetryMiddleware
(
connector
telemetry
)
{
return
store
=
>
next
=
>
action
=
>
{
const
oldState
=
store
.
getState
(
)
;
const
res
=
next
(
action
)
;
const
toolbox
=
gDevTools
.
getToolbox
(
connector
.
getTabTarget
(
)
)
;
if
(
!
toolbox
)
{
return
res
;
}
if
(
action
.
skipTelemetry
)
{
return
res
;
}
const
state
=
store
.
getState
(
)
;
const
sessionId
=
toolbox
.
sessionId
;
const
filterChangeActions
=
[
TOGGLE_REQUEST_FILTER_TYPE
ENABLE_REQUEST_FILTER_TYPE_ONLY
SET_REQUEST_FILTER_TEXT
]
;
if
(
filterChangeActions
.
includes
(
action
.
type
)
)
{
filterChange
(
{
action
state
oldState
telemetry
sessionId
}
)
;
}
if
(
action
.
type
=
=
SELECT_DETAILS_PANEL_TAB
)
{
sidePanelChange
(
{
state
oldState
telemetry
sessionId
}
)
;
}
if
(
action
.
type
=
=
SEND_CUSTOM_REQUEST
)
{
sendCustomRequest
(
{
telemetry
sessionId
}
)
;
}
if
(
action
.
type
=
=
CHANGE_NETWORK_THROTTLING
)
{
throttlingChange
(
{
action
telemetry
sessionId
}
)
;
}
if
(
action
.
type
=
=
ENABLE_PERSISTENT_LOGS
)
{
persistenceChange
(
{
telemetry
state
sessionId
}
)
;
}
if
(
action
.
type
=
=
WS_SELECT_FRAME
)
{
selectWSFrame
(
{
telemetry
sessionId
}
)
;
}
return
res
;
}
;
}
function
filterChange
(
{
action
state
oldState
telemetry
sessionId
}
)
{
const
oldFilterState
=
oldState
.
filters
;
const
filterState
=
state
.
filters
;
const
activeFilters
=
[
]
;
const
inactiveFilters
=
[
]
;
for
(
const
[
key
value
]
of
Object
.
entries
(
filterState
.
requestFilterTypes
)
)
{
if
(
value
)
{
activeFilters
.
push
(
key
)
;
}
else
{
inactiveFilters
.
push
(
key
)
;
}
}
let
trigger
;
if
(
action
.
type
=
=
=
TOGGLE_REQUEST_FILTER_TYPE
|
|
action
.
type
=
=
=
ENABLE_REQUEST_FILTER_TYPE_ONLY
)
{
trigger
=
action
.
filter
;
}
else
if
(
action
.
type
=
=
=
SET_REQUEST_FILTER_TEXT
)
{
if
(
oldFilterState
.
requestFilterText
!
=
=
"
"
&
&
filterState
.
requestFilterText
!
=
=
"
"
)
{
return
;
}
trigger
=
"
text
"
;
}
telemetry
.
recordEvent
(
"
filters_changed
"
"
netmonitor
"
null
{
trigger
:
trigger
active
:
activeFilters
.
join
(
"
"
)
inactive
:
inactiveFilters
.
join
(
"
"
)
session_id
:
sessionId
}
)
;
}
function
sidePanelChange
(
{
state
oldState
telemetry
sessionId
}
)
{
telemetry
.
recordEvent
(
"
sidepanel_changed
"
"
netmonitor
"
null
{
oldpanel
:
oldState
.
ui
.
detailsPanelSelectedTab
newpanel
:
state
.
ui
.
detailsPanelSelectedTab
session_id
:
sessionId
}
)
;
}
function
sendCustomRequest
(
{
telemetry
sessionId
}
)
{
telemetry
.
recordEvent
(
"
edit_resend
"
"
netmonitor
"
null
{
session_id
:
sessionId
}
)
;
}
function
throttlingChange
(
{
action
telemetry
sessionId
}
)
{
telemetry
.
recordEvent
(
"
throttle_changed
"
"
netmonitor
"
null
{
mode
:
action
.
profile
session_id
:
sessionId
}
)
;
}
function
persistenceChange
(
{
telemetry
state
sessionId
}
)
{
telemetry
.
recordEvent
(
"
persist_changed
"
"
netmonitor
"
String
(
state
.
ui
.
persistentLogsEnabled
)
{
session_id
:
sessionId
}
)
;
}
function
selectWSFrame
(
{
telemetry
sessionId
}
)
{
telemetry
.
recordEvent
(
"
select_ws_frame
"
"
netmonitor
"
null
{
session_id
:
sessionId
}
)
;
}
module
.
exports
=
eventTelemetryMiddleware
;
