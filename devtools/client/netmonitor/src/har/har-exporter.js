"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
DevToolsUtils
=
require
(
"
devtools
/
shared
/
DevToolsUtils
"
)
;
const
JSZip
=
require
(
"
devtools
/
client
/
shared
/
vendor
/
jszip
"
)
;
const
clipboardHelper
=
require
(
"
devtools
/
shared
/
platform
/
clipboard
"
)
;
const
{
HarBuilder
}
=
require
(
"
.
/
har
-
builder
"
)
;
var
uid
=
1
;
const
trace
=
{
log
:
function
(
.
.
.
args
)
{
}
}
;
const
HarExporter
=
{
async
save
(
options
)
{
const
defaultFileName
=
Services
.
prefs
.
getCharPref
(
"
devtools
.
netmonitor
.
har
.
defaultFileName
"
)
;
const
compress
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
netmonitor
.
har
.
compress
"
)
;
trace
.
log
(
"
HarExporter
.
save
;
"
+
defaultFileName
options
)
;
let
data
=
await
this
.
fetchHarData
(
options
)
;
let
fileName
=
this
.
getHarFileName
(
defaultFileName
options
.
jsonp
compress
options
)
;
if
(
compress
)
{
data
=
await
JSZip
(
)
.
file
(
fileName
data
)
.
generateAsync
(
{
compression
:
"
DEFLATE
"
platform
:
Services
.
appinfo
.
OS
=
=
=
"
WINNT
"
?
"
DOS
"
:
"
UNIX
"
type
:
"
uint8array
"
}
)
;
}
else
{
data
=
new
TextEncoder
(
)
.
encode
(
data
)
;
}
fileName
=
{
fileName
}
{
compress
?
"
.
zip
"
:
"
"
}
;
DevToolsUtils
.
saveAs
(
window
data
fileName
)
;
}
formatDate
(
date
)
{
const
year
=
String
(
date
.
getFullYear
(
)
%
100
)
.
padStart
(
2
"
0
"
)
;
const
month
=
String
(
date
.
getMonth
(
)
+
1
)
.
padStart
(
2
"
0
"
)
;
const
day
=
String
(
date
.
getDate
(
)
)
.
padStart
(
2
"
0
"
)
;
const
hour
=
String
(
date
.
getHours
(
)
)
.
padStart
(
2
"
0
"
)
;
const
minutes
=
String
(
date
.
getMinutes
(
)
)
.
padStart
(
2
"
0
"
)
;
const
seconds
=
String
(
date
.
getSeconds
(
)
)
.
padStart
(
2
"
0
"
)
;
return
{
year
}
-
{
month
}
-
{
day
}
{
hour
}
-
{
minutes
}
-
{
seconds
}
;
}
getHarFileName
(
defaultFileName
jsonp
compress
options
)
{
const
tabTarget
=
options
.
connector
.
getTabTarget
(
)
;
const
host
=
new
URL
(
tabTarget
.
url
)
;
let
name
=
defaultFileName
.
replace
(
/
%
date
/
g
this
.
formatDate
(
new
Date
(
)
)
)
;
name
=
name
.
replace
(
/
%
hostname
/
g
host
.
hostname
)
;
name
=
name
.
replace
(
/
\
:
/
gm
"
-
"
"
"
)
;
name
=
name
.
replace
(
/
\
/
/
gm
"
_
"
"
"
)
;
return
{
name
}
.
{
jsonp
?
"
harp
"
:
"
har
"
}
;
}
copy
:
function
(
options
)
{
return
this
.
fetchHarData
(
options
)
.
then
(
jsonString
=
>
{
clipboardHelper
.
copyString
(
jsonString
)
;
return
jsonString
;
}
)
;
}
getHar
:
function
(
options
)
{
return
this
.
fetchHarData
(
options
)
.
then
(
data
=
>
{
return
data
?
JSON
.
parse
(
data
)
:
null
;
}
)
;
}
fetchHarData
:
function
(
options
)
{
options
.
id
=
options
.
id
|
|
uid
+
+
;
if
(
typeof
options
.
jsonp
!
=
"
boolean
"
)
{
options
.
jsonp
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
netmonitor
.
har
.
jsonp
"
)
;
}
if
(
typeof
options
.
includeResponseBodies
!
=
"
boolean
"
)
{
options
.
includeResponseBodies
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
netmonitor
.
har
.
includeResponseBodies
"
)
;
}
if
(
typeof
options
.
jsonpCallback
!
=
"
boolean
"
)
{
options
.
jsonpCallback
=
Services
.
prefs
.
getCharPref
(
"
devtools
.
netmonitor
.
har
.
jsonpCallback
"
)
;
}
if
(
typeof
options
.
forceExport
!
=
"
boolean
"
)
{
options
.
forceExport
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
netmonitor
.
har
.
forceExport
"
)
;
}
return
this
.
buildHarData
(
options
)
.
then
(
har
=
>
{
if
(
!
har
.
log
.
entries
.
length
&
&
!
options
.
forceExport
)
{
return
Promise
.
resolve
(
)
;
}
let
jsonString
=
this
.
stringify
(
har
)
;
if
(
!
jsonString
)
{
return
Promise
.
resolve
(
)
;
}
if
(
options
.
jsonp
)
{
const
callbackName
=
options
.
jsonpCallback
|
|
"
onInputData
"
;
jsonString
=
callbackName
+
"
(
"
+
jsonString
+
"
)
;
"
;
}
return
jsonString
;
}
)
.
catch
(
function
onError
(
err
)
{
console
.
error
(
err
)
;
}
)
;
}
buildHarData
:
async
function
(
options
)
{
const
{
connector
}
=
options
;
const
{
getTabTarget
}
=
connector
;
const
{
form
:
{
title
url
}
}
=
getTabTarget
(
)
;
connector
.
enableActions
(
false
)
;
options
=
{
.
.
.
options
title
:
title
|
|
url
getString
:
connector
.
getLongString
getTimingMarker
:
connector
.
getTimingMarker
requestData
:
connector
.
requestData
}
;
const
builder
=
new
HarBuilder
(
options
)
;
const
result
=
await
builder
.
build
(
)
;
connector
.
enableActions
(
true
)
;
return
result
;
}
stringify
:
function
(
har
)
{
if
(
!
har
)
{
return
null
;
}
try
{
return
JSON
.
stringify
(
har
null
"
"
)
;
}
catch
(
err
)
{
console
.
error
(
err
)
;
return
undefined
;
}
}
}
;
exports
.
HarExporter
=
HarExporter
;
