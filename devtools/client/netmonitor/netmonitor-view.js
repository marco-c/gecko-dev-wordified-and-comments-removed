"
use
strict
"
;
const
{
testing
:
isTesting
}
=
require
(
"
devtools
/
shared
/
flags
"
)
;
const
{
Task
}
=
require
(
"
devtools
/
shared
/
task
"
)
;
const
{
ViewHelpers
}
=
require
(
"
devtools
/
client
/
shared
/
widgets
/
view
-
helpers
"
)
;
const
{
RequestsMenuView
}
=
require
(
"
.
/
requests
-
menu
-
view
"
)
;
const
{
CustomRequestView
}
=
require
(
"
.
/
custom
-
request
-
view
"
)
;
const
{
ToolbarView
}
=
require
(
"
.
/
toolbar
-
view
"
)
;
const
{
SidebarView
}
=
require
(
"
.
/
sidebar
-
view
"
)
;
const
{
DetailsView
}
=
require
(
"
.
/
details
-
view
"
)
;
const
{
StatisticsView
}
=
require
(
"
.
/
statistics
-
view
"
)
;
const
{
ACTIVITY_TYPE
}
=
require
(
"
.
/
constants
"
)
;
const
Actions
=
require
(
"
.
/
actions
/
index
"
)
;
const
{
Prefs
}
=
require
(
"
.
/
prefs
"
)
;
const
WDA_DEFAULT_VERIFY_INTERVAL
=
50
;
const
WDA_DEFAULT_GIVE_UP_TIMEOUT
=
isTesting
?
45000
:
2000
;
var
NetMonitorView
=
{
initialize
:
function
(
)
{
this
.
_initializePanes
(
)
;
this
.
Toolbar
.
initialize
(
gStore
)
;
this
.
RequestsMenu
.
initialize
(
gStore
)
;
this
.
NetworkDetails
.
initialize
(
gStore
)
;
this
.
CustomRequest
.
initialize
(
)
;
this
.
Statistics
.
initialize
(
gStore
)
;
this
.
unsubscribeStore
=
gStore
.
subscribe
(
storeWatcher
(
false
(
)
=
>
gStore
.
getState
(
)
.
ui
.
statisticsOpen
this
.
toggleFrontendMode
.
bind
(
this
)
)
)
;
}
destroy
:
function
(
)
{
this
.
_isDestroyed
=
true
;
this
.
Toolbar
.
destroy
(
)
;
this
.
RequestsMenu
.
destroy
(
)
;
this
.
NetworkDetails
.
destroy
(
)
;
this
.
CustomRequest
.
destroy
(
)
;
this
.
Statistics
.
destroy
(
)
;
this
.
unsubscribeStore
(
)
;
this
.
_destroyPanes
(
)
;
}
_initializePanes
:
function
(
)
{
dumpn
(
"
Initializing
the
NetMonitorView
panes
"
)
;
this
.
_body
=
(
"
#
body
"
)
;
this
.
_detailsPane
=
(
"
#
details
-
pane
"
)
;
this
.
_detailsPane
.
setAttribute
(
"
width
"
Prefs
.
networkDetailsWidth
)
;
this
.
_detailsPane
.
setAttribute
(
"
height
"
Prefs
.
networkDetailsHeight
)
;
this
.
toggleDetailsPane
(
{
visible
:
false
}
)
;
}
_destroyPanes
:
Task
.
async
(
function
*
(
)
{
dumpn
(
"
Destroying
the
NetMonitorView
panes
"
)
;
Prefs
.
networkDetailsWidth
=
this
.
_detailsPane
.
getAttribute
(
"
width
"
)
;
Prefs
.
networkDetailsHeight
=
this
.
_detailsPane
.
getAttribute
(
"
height
"
)
;
this
.
_detailsPane
=
null
;
}
)
get
detailsPaneHidden
(
)
{
return
this
.
_detailsPane
.
classList
.
contains
(
"
pane
-
collapsed
"
)
;
}
toggleDetailsPane
:
function
(
flags
tabIndex
)
{
ViewHelpers
.
togglePane
(
flags
this
.
_detailsPane
)
;
if
(
flags
.
visible
)
{
this
.
_body
.
classList
.
remove
(
"
pane
-
collapsed
"
)
;
gStore
.
dispatch
(
Actions
.
openSidebar
(
true
)
)
;
}
else
{
this
.
_body
.
classList
.
add
(
"
pane
-
collapsed
"
)
;
gStore
.
dispatch
(
Actions
.
openSidebar
(
false
)
)
;
}
if
(
tabIndex
!
=
=
undefined
)
{
(
"
#
event
-
details
-
pane
"
)
.
selectedIndex
=
tabIndex
;
}
}
get
currentFrontendMode
(
)
{
if
(
!
this
.
_body
.
selectedPanel
)
{
return
null
;
}
return
this
.
_body
.
selectedPanel
.
id
;
}
toggleFrontendMode
:
function
(
)
{
if
(
gStore
.
getState
(
)
.
ui
.
statisticsOpen
)
{
this
.
showNetworkStatisticsView
(
)
;
}
else
{
this
.
showNetworkInspectorView
(
)
;
}
}
showNetworkInspectorView
:
function
(
)
{
this
.
_body
.
selectedPanel
=
(
"
#
network
-
inspector
-
view
"
)
;
}
showNetworkStatisticsView
:
function
(
)
{
this
.
_body
.
selectedPanel
=
(
"
#
network
-
statistics
-
view
"
)
;
let
controller
=
NetMonitorController
;
let
requestsView
=
this
.
RequestsMenu
;
let
statisticsView
=
this
.
Statistics
;
Task
.
spawn
(
function
*
(
)
{
statisticsView
.
displayPlaceholderCharts
(
)
;
yield
controller
.
triggerActivity
(
ACTIVITY_TYPE
.
RELOAD
.
WITH_CACHE_ENABLED
)
;
try
{
yield
whenDataAvailable
(
requestsView
.
store
[
"
responseHeaders
"
"
status
"
"
contentSize
"
"
mimeType
"
"
totalTime
"
]
)
;
}
catch
(
ex
)
{
console
.
error
(
ex
)
;
}
const
requests
=
requestsView
.
store
.
getState
(
)
.
requests
.
requests
.
valueSeq
(
)
;
statisticsView
.
createPrimedCacheChart
(
requests
)
;
statisticsView
.
createEmptyCacheChart
(
requests
)
;
}
)
;
}
reloadPage
:
function
(
)
{
NetMonitorController
.
triggerActivity
(
ACTIVITY_TYPE
.
RELOAD
.
WITH_CACHE_DEFAULT
)
;
}
_body
:
null
_detailsPane
:
null
}
;
function
whenDataAvailable
(
dataStore
mandatoryFields
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
interval
=
setInterval
(
(
)
=
>
{
const
{
requests
}
=
dataStore
.
getState
(
)
.
requests
;
const
allFieldsPresent
=
!
requests
.
isEmpty
(
)
&
&
requests
.
every
(
item
=
>
mandatoryFields
.
every
(
field
=
>
item
.
get
(
field
)
!
=
=
undefined
)
)
;
if
(
allFieldsPresent
)
{
clearInterval
(
interval
)
;
clearTimeout
(
timer
)
;
resolve
(
)
;
}
}
WDA_DEFAULT_VERIFY_INTERVAL
)
;
let
timer
=
setTimeout
(
(
)
=
>
{
clearInterval
(
interval
)
;
reject
(
new
Error
(
"
Timed
out
while
waiting
for
data
"
)
)
;
}
WDA_DEFAULT_GIVE_UP_TIMEOUT
)
;
}
)
;
}
function
storeWatcher
(
initialValue
reduceValue
onChange
)
{
let
currentValue
=
initialValue
;
return
(
)
=
>
{
const
newValue
=
reduceValue
(
)
;
if
(
newValue
!
=
=
currentValue
)
{
onChange
(
)
;
currentValue
=
newValue
;
}
}
;
}
NetMonitorView
.
Toolbar
=
new
ToolbarView
(
)
;
NetMonitorView
.
Sidebar
=
new
SidebarView
(
)
;
NetMonitorView
.
NetworkDetails
=
new
DetailsView
(
)
;
NetMonitorView
.
RequestsMenu
=
new
RequestsMenuView
(
)
;
NetMonitorView
.
CustomRequest
=
new
CustomRequestView
(
)
;
NetMonitorView
.
Statistics
=
new
StatisticsView
(
)
;
exports
.
NetMonitorView
=
NetMonitorView
;
