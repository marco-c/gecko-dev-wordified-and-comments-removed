"
use
strict
"
;
const
{
FlameGraph
FlameGraphUtils
}
=
require
(
"
devtools
/
client
/
shared
/
widgets
/
FlameGraph
"
)
;
const
{
extend
}
=
require
(
"
devtools
/
shared
/
extend
"
)
;
const
RecordingUtils
=
require
(
"
devtools
/
shared
/
performance
/
recording
-
utils
"
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
EVENTS
=
require
(
"
.
.
/
events
"
)
;
const
{
DetailsSubview
}
=
require
(
"
.
/
details
-
abstract
-
subview
"
)
;
const
{
L10N
}
=
require
(
"
.
.
/
modules
/
global
"
)
;
const
MemoryFlameGraphView
=
extend
(
DetailsSubview
{
shouldUpdateWhileMouseIsActive
:
true
rerenderPrefs
:
[
"
invert
-
flame
-
graph
"
"
flatten
-
tree
-
recursion
"
"
show
-
idle
-
blocks
"
]
async
initialize
(
)
{
DetailsSubview
.
initialize
.
call
(
this
)
;
this
.
graph
=
new
FlameGraph
(
(
"
#
memory
-
flamegraph
-
view
"
)
)
;
this
.
graph
.
timelineTickUnits
=
L10N
.
getStr
(
"
graphs
.
ms
"
)
;
this
.
graph
.
setTheme
(
PerformanceController
.
getTheme
(
)
)
;
await
this
.
graph
.
ready
(
)
;
this
.
_onRangeChangeInGraph
=
this
.
_onRangeChangeInGraph
.
bind
(
this
)
;
this
.
_onThemeChanged
=
this
.
_onThemeChanged
.
bind
(
this
)
;
PerformanceController
.
on
(
EVENTS
.
THEME_CHANGED
this
.
_onThemeChanged
)
;
this
.
graph
.
on
(
"
selecting
"
this
.
_onRangeChangeInGraph
)
;
}
async
destroy
(
)
{
DetailsSubview
.
destroy
.
call
(
this
)
;
PerformanceController
.
off
(
EVENTS
.
THEME_CHANGED
this
.
_onThemeChanged
)
;
this
.
graph
.
off
(
"
selecting
"
this
.
_onRangeChangeInGraph
)
;
await
this
.
graph
.
destroy
(
)
;
}
render
:
function
(
interval
=
{
}
)
{
const
recording
=
PerformanceController
.
getCurrentRecording
(
)
;
const
duration
=
recording
.
getDuration
(
)
;
const
allocations
=
recording
.
getAllocations
(
)
;
const
thread
=
RecordingUtils
.
getProfileThreadFromAllocations
(
allocations
)
;
const
data
=
FlameGraphUtils
.
createFlameGraphDataFromThread
(
thread
{
invertStack
:
PerformanceController
.
getOption
(
"
invert
-
flame
-
graph
"
)
flattenRecursion
:
PerformanceController
.
getOption
(
"
flatten
-
tree
-
recursion
"
)
showIdleBlocks
:
PerformanceController
.
getOption
(
"
show
-
idle
-
blocks
"
)
&
&
L10N
.
getStr
(
"
table
.
idle
"
)
}
)
;
this
.
graph
.
setData
(
{
data
bounds
:
{
startTime
:
0
endTime
:
duration
}
visible
:
{
startTime
:
interval
.
startTime
|
|
0
endTime
:
interval
.
endTime
|
|
duration
}
}
)
;
this
.
emit
(
EVENTS
.
UI_MEMORY_FLAMEGRAPH_RENDERED
)
;
}
_onRangeChangeInGraph
:
function
(
)
{
const
interval
=
this
.
graph
.
getViewRange
(
)
;
this
.
requiresUpdateOnRangeChange
=
false
;
OverviewView
.
setTimeInterval
(
interval
)
;
this
.
requiresUpdateOnRangeChange
=
true
;
}
_onRerenderPrefChanged
:
function
(
)
{
const
recording
=
PerformanceController
.
getCurrentRecording
(
)
;
const
allocations
=
recording
.
getAllocations
(
)
;
const
thread
=
RecordingUtils
.
getProfileThreadFromAllocations
(
allocations
)
;
FlameGraphUtils
.
removeFromCache
(
thread
)
;
}
_onThemeChanged
:
function
(
theme
)
{
this
.
graph
.
setTheme
(
theme
)
;
this
.
graph
.
refresh
(
{
force
:
true
}
)
;
}
toString
:
(
)
=
>
"
[
object
MemoryFlameGraphView
]
"
}
)
;
EventEmitter
.
decorate
(
MemoryFlameGraphView
)
;
exports
.
MemoryFlameGraphView
=
MemoryFlameGraphView
;
