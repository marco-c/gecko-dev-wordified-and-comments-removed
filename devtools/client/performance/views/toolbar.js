"
use
strict
"
;
const
EVENTS
=
require
(
"
.
.
/
events
"
)
;
const
{
TIMELINE_BLUEPRINT
}
=
require
(
"
.
.
/
modules
/
markers
"
)
;
const
{
MarkerBlueprintUtils
}
=
require
(
"
.
.
/
modules
/
marker
-
blueprint
-
utils
"
)
;
const
{
OptionsView
}
=
require
(
"
devtools
/
client
/
shared
/
options
-
view
"
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
BRANCH_NAME
=
"
devtools
.
performance
.
ui
.
"
;
const
ToolbarView
=
{
async
initialize
(
)
{
this
.
_onFilterPopupShowing
=
this
.
_onFilterPopupShowing
.
bind
(
this
)
;
this
.
_onFilterPopupHiding
=
this
.
_onFilterPopupHiding
.
bind
(
this
)
;
this
.
_onHiddenMarkersChanged
=
this
.
_onHiddenMarkersChanged
.
bind
(
this
)
;
this
.
_onPrefChanged
=
this
.
_onPrefChanged
.
bind
(
this
)
;
this
.
_popup
=
(
"
#
performance
-
options
-
menupopup
"
)
;
this
.
optionsView
=
new
OptionsView
(
{
branchName
:
BRANCH_NAME
menupopup
:
this
.
_popup
}
)
;
const
experimentalEnabled
=
PerformanceController
.
getOption
(
"
experimental
"
)
;
this
.
_toggleExperimentalUI
(
experimentalEnabled
)
;
await
this
.
optionsView
.
initialize
(
)
;
this
.
optionsView
.
on
(
"
pref
-
changed
"
this
.
_onPrefChanged
)
;
this
.
_buildMarkersFilterPopup
(
)
;
this
.
_updateHiddenMarkersPopup
(
)
;
(
"
#
performance
-
filter
-
menupopup
"
)
.
addEventListener
(
"
popupshowing
"
this
.
_onFilterPopupShowing
)
;
(
"
#
performance
-
filter
-
menupopup
"
)
.
addEventListener
(
"
popuphiding
"
this
.
_onFilterPopupHiding
)
;
}
destroy
:
function
(
)
{
(
"
#
performance
-
filter
-
menupopup
"
)
.
removeEventListener
(
"
popupshowing
"
this
.
_onFilterPopupShowing
)
;
(
"
#
performance
-
filter
-
menupopup
"
)
.
removeEventListener
(
"
popuphiding
"
this
.
_onFilterPopupHiding
)
;
this
.
_popup
=
null
;
this
.
optionsView
.
off
(
"
pref
-
changed
"
this
.
_onPrefChanged
)
;
this
.
optionsView
.
destroy
(
)
;
}
_buildMarkersFilterPopup
:
function
(
)
{
for
(
const
[
markerName
markerDetails
]
of
Object
.
entries
(
TIMELINE_BLUEPRINT
)
)
{
const
menuitem
=
document
.
createXULElement
(
"
menuitem
"
)
;
menuitem
.
setAttribute
(
"
closemenu
"
"
none
"
)
;
menuitem
.
setAttribute
(
"
type
"
"
checkbox
"
)
;
menuitem
.
setAttribute
(
"
align
"
"
center
"
)
;
menuitem
.
setAttribute
(
"
flex
"
"
1
"
)
;
menuitem
.
setAttribute
(
"
label
"
MarkerBlueprintUtils
.
getMarkerGenericName
(
markerName
)
)
;
menuitem
.
setAttribute
(
"
marker
-
type
"
markerName
)
;
menuitem
.
className
=
marker
-
color
-
{
markerDetails
.
colorName
}
;
menuitem
.
addEventListener
(
"
command
"
this
.
_onHiddenMarkersChanged
)
;
(
"
#
performance
-
filter
-
menupopup
"
)
.
appendChild
(
menuitem
)
;
}
}
_updateHiddenMarkersPopup
:
function
(
)
{
const
menuItems
=
(
"
#
performance
-
filter
-
menupopup
menuitem
[
marker
-
type
]
"
)
;
const
hiddenMarkers
=
PerformanceController
.
getPref
(
"
hidden
-
markers
"
)
;
for
(
const
menuitem
of
menuItems
)
{
if
(
~
hiddenMarkers
.
indexOf
(
menuitem
.
getAttribute
(
"
marker
-
type
"
)
)
)
{
menuitem
.
removeAttribute
(
"
checked
"
)
;
}
else
{
menuitem
.
setAttribute
(
"
checked
"
"
true
"
)
;
}
}
}
_toggleExperimentalUI
:
function
(
isEnabled
)
{
if
(
isEnabled
)
{
(
"
.
theme
-
body
"
)
.
classList
.
add
(
"
experimental
-
enabled
"
)
;
this
.
_popup
.
classList
.
add
(
"
experimental
-
enabled
"
)
;
}
else
{
(
"
.
theme
-
body
"
)
.
classList
.
remove
(
"
experimental
-
enabled
"
)
;
this
.
_popup
.
classList
.
remove
(
"
experimental
-
enabled
"
)
;
}
}
_onFilterPopupShowing
:
function
(
)
{
(
"
#
filter
-
button
"
)
.
setAttribute
(
"
open
"
"
true
"
)
;
}
_onFilterPopupHiding
:
function
(
)
{
(
"
#
filter
-
button
"
)
.
removeAttribute
(
"
open
"
)
;
}
_onHiddenMarkersChanged
:
function
(
)
{
const
checkedMenuItems
=
(
"
#
performance
-
filter
-
menupopup
menuitem
[
marker
-
type
]
:
not
(
[
checked
]
)
"
)
;
const
hiddenMarkers
=
Array
.
map
(
checkedMenuItems
e
=
>
e
.
getAttribute
(
"
marker
-
type
"
)
)
;
PerformanceController
.
setPref
(
"
hidden
-
markers
"
hiddenMarkers
)
;
}
_onPrefChanged
:
function
(
prefName
)
{
const
value
=
PerformanceController
.
getOption
(
prefName
)
;
if
(
prefName
=
=
=
"
experimental
"
)
{
this
.
_toggleExperimentalUI
(
value
)
;
}
this
.
emit
(
EVENTS
.
UI_PREF_CHANGED
prefName
value
)
;
}
toString
:
(
)
=
>
"
[
object
ToolbarView
]
"
}
;
EventEmitter
.
decorate
(
ToolbarView
)
;
exports
.
ToolbarView
=
window
.
ToolbarView
=
ToolbarView
;
