"
use
strict
"
;
var
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
var
Services
=
require
(
"
Services
"
)
;
var
{
gDevTools
}
=
require
(
"
devtools
/
client
/
framework
/
devtools
"
)
;
var
{
TargetFactory
}
=
require
(
"
devtools
/
client
/
framework
/
target
"
)
;
var
{
Toolbox
}
=
require
(
"
devtools
/
client
/
framework
/
toolbox
"
)
;
var
{
DebuggerClient
}
=
require
(
"
devtools
/
shared
/
client
/
debugger
-
client
"
)
;
var
{
LocalizationHelper
}
=
require
(
"
devtools
/
shared
/
l10n
"
)
;
var
L10N
=
new
LocalizationHelper
(
"
devtools
/
client
/
locales
/
connection
-
screen
.
properties
"
)
;
var
gClient
;
var
gConnectionTimeout
;
window
.
addEventListener
(
"
DOMContentLoaded
"
function
(
)
{
const
host
=
Services
.
prefs
.
getCharPref
(
"
devtools
.
debugger
.
remote
-
host
"
)
;
const
port
=
Services
.
prefs
.
getIntPref
(
"
devtools
.
debugger
.
remote
-
port
"
)
;
if
(
host
)
{
document
.
getElementById
(
"
host
"
)
.
value
=
host
;
}
if
(
port
)
{
document
.
getElementById
(
"
port
"
)
.
value
=
port
;
}
const
form
=
document
.
querySelector
(
"
#
connection
-
form
form
"
)
;
form
.
addEventListener
(
"
submit
"
function
(
)
{
window
.
submit
(
)
.
catch
(
e
=
>
{
console
.
error
(
e
)
;
showError
(
"
unexpected
"
)
;
}
)
;
}
)
;
}
{
capture
:
true
once
:
true
}
)
;
var
submit
=
async
function
(
)
{
document
.
body
.
classList
.
add
(
"
connecting
"
)
;
const
host
=
document
.
getElementById
(
"
host
"
)
.
value
;
const
port
=
document
.
getElementById
(
"
port
"
)
.
value
;
try
{
Services
.
prefs
.
setCharPref
(
"
devtools
.
debugger
.
remote
-
host
"
host
)
;
Services
.
prefs
.
setIntPref
(
"
devtools
.
debugger
.
remote
-
port
"
port
)
;
}
catch
(
e
)
{
}
const
transport
=
await
DebuggerClient
.
socketConnect
(
{
host
port
}
)
;
gClient
=
new
DebuggerClient
(
transport
)
;
const
delay
=
Services
.
prefs
.
getIntPref
(
"
devtools
.
debugger
.
remote
-
timeout
"
)
;
gConnectionTimeout
=
setTimeout
(
handleConnectionTimeout
delay
)
;
const
response
=
await
gClient
.
connect
(
)
;
await
onConnectionReady
(
.
.
.
response
)
;
}
;
var
onConnectionReady
=
async
function
(
[
aType
aTraits
]
)
{
clearTimeout
(
gConnectionTimeout
)
;
let
addons
=
[
]
;
try
{
addons
=
await
gClient
.
mainRoot
.
listAddons
(
)
;
}
catch
(
e
)
{
}
let
parent
=
document
.
getElementById
(
"
addonTargetActors
"
)
;
if
(
addons
.
length
>
0
)
{
for
(
const
addon
of
addons
)
{
if
(
!
addon
.
debuggable
)
{
continue
;
}
buildAddonLink
(
addon
parent
)
;
}
}
else
{
parent
.
previousElementSibling
.
remove
(
)
;
parent
.
remove
(
)
;
}
parent
=
document
.
getElementById
(
"
tabTargetActors
"
)
;
const
tabs
=
await
gClient
.
mainRoot
.
listTabs
(
)
;
for
(
let
i
=
0
;
i
<
tabs
.
length
;
i
+
+
)
{
buildTabLink
(
tabs
[
i
]
parent
)
;
}
const
gParent
=
document
.
getElementById
(
"
globalActors
"
)
;
const
globals
=
await
gClient
.
mainRoot
.
rootForm
;
if
(
globals
.
consoleActor
|
|
gClient
.
mainRoot
.
traits
.
allowChromeProcess
)
{
const
a
=
document
.
createElement
(
"
a
"
)
;
a
.
onclick
=
function
(
)
{
if
(
gClient
.
mainRoot
.
traits
.
allowChromeProcess
)
{
gClient
.
mainRoot
.
getMainProcess
(
)
.
then
(
front
=
>
{
openToolbox
(
null
true
null
front
)
;
}
)
;
}
else
if
(
globals
.
consoleActor
)
{
openToolbox
(
globals
true
"
webconsole
"
false
)
;
}
}
;
a
.
title
=
a
.
textContent
=
L10N
.
getStr
(
"
mainProcess
"
)
;
a
.
className
=
"
remote
-
process
"
;
a
.
href
=
"
#
"
;
gParent
.
appendChild
(
a
)
;
}
const
selectedLink
=
parent
.
querySelector
(
"
a
.
selected
"
)
;
if
(
selectedLink
)
{
parent
.
insertBefore
(
selectedLink
parent
.
firstChild
)
;
}
document
.
body
.
classList
.
remove
(
"
connecting
"
)
;
document
.
body
.
classList
.
add
(
"
actors
-
mode
"
)
;
const
firstLink
=
parent
.
querySelector
(
"
a
:
first
-
of
-
type
"
)
;
if
(
firstLink
)
{
firstLink
.
focus
(
)
;
}
}
;
function
buildAddonLink
(
addon
parent
)
{
const
a
=
document
.
createElement
(
"
a
"
)
;
a
.
onclick
=
async
function
(
)
{
openToolbox
(
null
true
"
webconsole
"
addon
)
;
}
;
a
.
textContent
=
addon
.
name
;
a
.
title
=
addon
.
id
;
a
.
href
=
"
#
"
;
parent
.
appendChild
(
a
)
;
}
function
buildTabLink
(
tab
parent
)
{
const
a
=
document
.
createElement
(
"
a
"
)
;
a
.
onclick
=
function
(
)
{
openToolbox
(
tab
)
;
}
;
a
.
textContent
=
tab
.
title
;
a
.
title
=
tab
.
url
;
if
(
!
a
.
textContent
)
{
a
.
textContent
=
tab
.
url
;
}
a
.
href
=
"
#
"
;
if
(
tab
.
selected
)
{
a
.
classList
.
add
(
"
selected
"
)
;
}
parent
.
appendChild
(
a
)
;
}
function
showError
(
type
)
{
document
.
body
.
className
=
"
error
"
;
let
activeError
=
document
.
querySelector
(
"
.
error
-
message
.
active
"
)
;
if
(
activeError
)
{
activeError
.
classList
.
remove
(
"
active
"
)
;
}
activeError
=
document
.
querySelector
(
"
.
error
-
"
+
type
)
;
if
(
activeError
)
{
activeError
.
classList
.
add
(
"
active
"
)
;
}
}
function
handleConnectionTimeout
(
)
{
showError
(
"
timeout
"
)
;
}
function
openToolbox
(
form
chrome
=
false
tool
=
"
webconsole
"
activeTab
=
null
)
{
const
options
=
{
form
activeTab
client
:
gClient
chrome
}
;
TargetFactory
.
forRemoteTab
(
options
)
.
then
(
(
target
)
=
>
{
const
hostType
=
Toolbox
.
HostType
.
WINDOW
;
gDevTools
.
showToolbox
(
target
tool
hostType
)
.
then
(
(
toolbox
)
=
>
{
toolbox
.
once
(
"
destroyed
"
function
(
)
{
gClient
.
close
(
)
;
}
)
;
}
console
.
error
)
;
window
.
close
(
)
;
}
console
.
error
)
;
}
