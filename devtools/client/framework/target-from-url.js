"
use
strict
"
;
const
{
DevToolsServer
}
=
require
(
"
devtools
/
server
/
devtools
-
server
"
)
;
const
{
DebuggerClient
}
=
require
(
"
devtools
/
shared
/
client
/
debugger
-
client
"
)
;
const
{
remoteClientManager
}
=
require
(
"
devtools
/
client
/
shared
/
remote
-
debugging
/
remote
-
client
-
manager
"
)
;
exports
.
targetFromURL
=
async
function
targetFromURL
(
url
)
{
const
client
=
await
clientFromURL
(
url
)
;
const
params
=
url
.
searchParams
;
const
isCachedClient
=
params
.
get
(
"
remoteId
"
)
;
if
(
!
isCachedClient
)
{
await
client
.
connect
(
)
;
}
const
id
=
params
.
get
(
"
id
"
)
;
const
type
=
params
.
get
(
"
type
"
)
;
const
chrome
=
params
.
has
(
"
chrome
"
)
;
let
target
;
try
{
target
=
await
_targetFromURL
(
client
id
type
chrome
)
;
}
catch
(
e
)
{
if
(
!
isCachedClient
)
{
await
client
.
close
(
)
;
}
throw
e
;
}
target
.
shouldCloseClient
=
!
isCachedClient
;
return
target
;
}
;
async
function
_targetFromURL
(
client
id
type
chrome
)
{
if
(
!
type
)
{
throw
new
Error
(
"
targetFromURL
missing
type
parameter
"
)
;
}
let
front
;
if
(
type
=
=
=
"
tab
"
)
{
id
=
parseInt
(
id
10
)
;
if
(
isNaN
(
id
)
)
{
throw
new
Error
(
targetFromURL
wrong
tab
id
'
{
id
}
'
should
be
a
number
)
;
}
try
{
front
=
await
client
.
mainRoot
.
getTab
(
{
outerWindowID
:
id
}
)
;
}
catch
(
ex
)
{
if
(
ex
.
message
.
startsWith
(
"
Protocol
error
(
noTab
)
"
)
)
{
throw
new
Error
(
targetFromURL
tab
with
outerWindowID
'
{
id
}
'
doesn
'
t
exist
)
;
}
throw
ex
;
}
}
else
if
(
type
=
=
=
"
extension
"
)
{
const
addonDescriptor
=
await
client
.
mainRoot
.
getAddon
(
{
id
}
)
;
if
(
!
addonDescriptor
)
{
throw
new
Error
(
targetFromURL
extension
with
id
'
{
id
}
'
doesn
'
t
exist
)
;
}
front
=
await
addonDescriptor
.
getTarget
(
)
;
}
else
if
(
type
=
=
=
"
worker
"
)
{
front
=
await
client
.
mainRoot
.
getWorker
(
id
)
;
if
(
!
front
)
{
throw
new
Error
(
targetFromURL
worker
with
actor
id
'
{
id
}
'
doesn
'
t
exist
)
;
}
}
else
if
(
type
=
=
"
process
"
)
{
DevToolsServer
.
allowChromeProcess
=
true
;
try
{
id
=
parseInt
(
id
10
)
;
if
(
isNaN
(
id
)
)
{
id
=
0
;
}
front
=
await
client
.
mainRoot
.
getProcess
(
id
)
;
}
catch
(
ex
)
{
if
(
ex
.
error
=
=
"
noProcess
"
)
{
throw
new
Error
(
targetFromURL
process
with
id
'
{
id
}
'
doesn
'
t
exist
)
;
}
throw
ex
;
}
}
else
if
(
type
=
=
"
window
"
)
{
DevToolsServer
.
allowChromeProcess
=
true
;
try
{
id
=
parseInt
(
id
10
)
;
if
(
isNaN
(
id
)
)
{
throw
new
Error
(
"
targetFromURL
window
requires
id
parameter
"
)
;
}
front
=
await
client
.
mainRoot
.
getWindow
(
{
outerWindowID
:
id
}
)
;
}
catch
(
ex
)
{
if
(
ex
.
error
=
=
"
notFound
"
)
{
throw
new
Error
(
targetFromURL
window
with
id
'
{
id
}
'
doesn
'
t
exist
)
;
}
throw
ex
;
}
}
else
{
throw
new
Error
(
targetFromURL
unsupported
type
'
{
type
}
'
parameter
)
;
}
if
(
chrome
)
{
front
.
forceChrome
(
)
;
}
return
front
;
}
async
function
clientFromURL
(
url
)
{
const
params
=
url
.
searchParams
;
const
remoteId
=
params
.
get
(
"
remoteId
"
)
;
if
(
remoteId
)
{
const
client
=
remoteClientManager
.
getClientByRemoteId
(
remoteId
)
;
if
(
!
client
)
{
throw
new
Error
(
Could
not
find
client
with
remote
id
:
{
remoteId
}
)
;
}
return
client
;
}
const
host
=
params
.
get
(
"
host
"
)
;
const
port
=
params
.
get
(
"
port
"
)
;
const
webSocket
=
!
!
params
.
get
(
"
ws
"
)
;
let
transport
;
if
(
port
)
{
transport
=
await
DebuggerClient
.
socketConnect
(
{
host
port
webSocket
}
)
;
}
else
{
DevToolsServer
.
init
(
)
;
DevToolsServer
.
registerAllActors
(
)
;
transport
=
DevToolsServer
.
connectPipe
(
)
;
}
return
new
DebuggerClient
(
transport
)
;
}
exports
.
clientFromURL
=
clientFromURL
;
