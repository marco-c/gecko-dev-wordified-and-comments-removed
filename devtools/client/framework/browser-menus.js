"
use
strict
"
;
const
{
LocalizationHelper
}
=
require
(
"
resource
:
/
/
devtools
/
shared
/
l10n
.
js
"
)
;
const
MENUS_L10N
=
new
LocalizationHelper
(
"
devtools
/
client
/
locales
/
menus
.
properties
"
)
;
loader
.
lazyRequireGetter
(
this
"
gDevTools
"
"
resource
:
/
/
devtools
/
client
/
framework
/
devtools
.
js
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
gDevToolsBrowser
"
"
resource
:
/
/
devtools
/
client
/
framework
/
devtools
-
browser
.
js
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
Telemetry
"
"
resource
:
/
/
devtools
/
client
/
shared
/
telemetry
.
js
"
)
;
let
telemetry
=
null
;
const
FragmentsCache
=
new
Map
(
)
;
function
l10n
(
key
)
{
return
MENUS_L10N
.
getStr
(
key
)
;
}
function
createMenuItem
(
{
doc
id
label
accesskey
isCheckbox
appMenuL10nId
}
)
{
const
menuitem
=
doc
.
createXULElement
(
"
menuitem
"
)
;
menuitem
.
id
=
id
;
menuitem
.
setAttribute
(
"
label
"
label
)
;
if
(
accesskey
)
{
menuitem
.
setAttribute
(
"
accesskey
"
accesskey
)
;
}
if
(
isCheckbox
)
{
menuitem
.
setAttribute
(
"
type
"
"
checkbox
"
)
;
menuitem
.
setAttribute
(
"
autocheck
"
"
false
"
)
;
}
if
(
appMenuL10nId
)
{
menuitem
.
setAttribute
(
"
appmenu
-
data
-
l10n
-
id
"
appMenuL10nId
)
;
}
return
menuitem
;
}
function
createToolMenuElements
(
toolDefinition
doc
)
{
const
id
=
toolDefinition
.
id
;
const
menuId
=
"
menuitem_
"
+
id
;
if
(
doc
.
getElementById
(
menuId
)
)
{
return
null
;
}
const
oncommand
=
async
function
(
id
event
)
{
try
{
const
window
=
event
.
target
.
ownerDocument
.
defaultView
;
await
gDevToolsBrowser
.
selectToolCommand
(
window
id
ChromeUtils
.
now
(
)
)
;
sendEntryPointTelemetry
(
window
)
;
}
catch
(
e
)
{
console
.
error
(
Exception
while
opening
{
id
}
:
{
e
}
\
n
{
e
.
stack
}
)
;
}
}
.
bind
(
null
id
)
;
const
menuitem
=
createMenuItem
(
{
doc
id
:
"
menuitem_
"
+
id
label
:
toolDefinition
.
menuLabel
|
|
toolDefinition
.
label
accesskey
:
toolDefinition
.
accesskey
appMenuL10nId
:
toolDefinition
.
appMenuL10nId
}
)
;
menuitem
.
setAttribute
(
"
key
"
"
key_
"
+
id
)
;
menuitem
.
addEventListener
(
"
command
"
oncommand
)
;
return
menuitem
;
}
function
sendEntryPointTelemetry
(
window
)
{
if
(
!
telemetry
)
{
telemetry
=
new
Telemetry
(
)
;
}
telemetry
.
addEventProperty
(
window
"
open
"
"
tools
"
null
"
shortcut
"
"
"
)
;
telemetry
.
addEventProperty
(
window
"
open
"
"
tools
"
null
"
entrypoint
"
"
SystemMenu
"
)
;
}
function
insertToolMenuElements
(
doc
toolDefinition
prevDef
)
{
const
menuitem
=
createToolMenuElements
(
toolDefinition
doc
)
;
if
(
!
menuitem
)
{
return
;
}
let
ref
;
if
(
prevDef
)
{
const
menuitem
=
doc
.
getElementById
(
"
menuitem_
"
+
prevDef
.
id
)
;
ref
=
menuitem
?
.
nextSibling
?
menuitem
.
nextSibling
:
null
;
}
else
{
ref
=
doc
.
getElementById
(
"
menu_devtools_remotedebugging
"
)
;
}
if
(
ref
)
{
ref
.
parentNode
.
insertBefore
(
menuitem
ref
)
;
}
}
exports
.
insertToolMenuElements
=
insertToolMenuElements
;
function
removeToolFromMenu
(
toolId
doc
)
{
const
key
=
doc
.
getElementById
(
"
key_
"
+
toolId
)
;
if
(
key
)
{
key
.
remove
(
)
;
}
const
menuitem
=
doc
.
getElementById
(
"
menuitem_
"
+
toolId
)
;
if
(
menuitem
)
{
menuitem
.
remove
(
)
;
}
}
exports
.
removeToolFromMenu
=
removeToolFromMenu
;
function
addAllToolsToMenu
(
doc
)
{
const
fragMenuItems
=
doc
.
createDocumentFragment
(
)
;
for
(
const
toolDefinition
of
gDevTools
.
getToolDefinitionArray
(
)
)
{
if
(
!
toolDefinition
.
inMenu
)
{
continue
;
}
const
menuItem
=
createToolMenuElements
(
toolDefinition
doc
)
;
if
(
!
menuItem
)
{
continue
;
}
fragMenuItems
.
appendChild
(
menuItem
)
;
}
const
mps
=
doc
.
getElementById
(
"
menu_devtools_remotedebugging
"
)
;
if
(
mps
)
{
mps
.
parentNode
.
insertBefore
(
fragMenuItems
mps
)
;
}
}
function
addTopLevelItems
(
doc
)
{
const
menuItems
=
doc
.
createDocumentFragment
(
)
;
const
{
menuitems
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
menus
.
js
"
)
;
for
(
const
item
of
menuitems
)
{
if
(
item
.
separator
)
{
const
separator
=
doc
.
createXULElement
(
"
menuseparator
"
)
;
separator
.
id
=
item
.
id
;
menuItems
.
appendChild
(
separator
)
;
}
else
{
const
{
id
l10nKey
}
=
item
;
const
menuitem
=
createMenuItem
(
{
doc
id
label
:
l10n
(
l10nKey
+
"
.
label
"
)
accesskey
:
l10n
(
l10nKey
+
"
.
accesskey
"
)
isCheckbox
:
item
.
checkbox
appMenuL10nId
:
item
.
appMenuL10nId
}
)
;
menuitem
.
addEventListener
(
"
command
"
item
.
oncommand
)
;
menuItems
.
appendChild
(
menuitem
)
;
if
(
item
.
keyId
)
{
menuitem
.
setAttribute
(
"
key
"
"
key_
"
+
item
.
keyId
)
;
}
}
}
const
nodes
=
[
]
;
for
(
const
node
of
menuItems
.
children
)
{
nodes
.
push
(
node
)
;
}
FragmentsCache
.
set
(
doc
nodes
)
;
const
menu
=
doc
.
getElementById
(
"
menuWebDeveloperPopup
"
)
;
menu
.
appendChild
(
menuItems
)
;
const
pageSourceMenu
=
doc
.
getElementById
(
"
menu_pageSource
"
)
;
const
extensionsForDevelopersMenu
=
doc
.
getElementById
(
"
extensionsForDevelopers
"
)
;
menu
.
insertBefore
(
pageSourceMenu
extensionsForDevelopersMenu
)
;
const
taskManagerMenu
=
doc
.
getElementById
(
"
menu_taskManager
"
)
;
const
remoteDebuggingMenu
=
doc
.
getElementById
(
"
menu_devtools_remotedebugging
"
)
;
menu
.
insertBefore
(
taskManagerMenu
remoteDebuggingMenu
)
;
}
function
removeTopLevelItems
(
doc
)
{
const
nodes
=
FragmentsCache
.
get
(
doc
)
;
if
(
!
nodes
)
{
return
;
}
FragmentsCache
.
delete
(
doc
)
;
for
(
const
node
of
nodes
)
{
node
.
remove
(
)
;
}
}
exports
.
addMenus
=
function
(
doc
)
{
addTopLevelItems
(
doc
)
;
addAllToolsToMenu
(
doc
)
;
}
;
exports
.
removeMenus
=
function
(
doc
)
{
removeTopLevelItems
(
doc
)
;
}
;
