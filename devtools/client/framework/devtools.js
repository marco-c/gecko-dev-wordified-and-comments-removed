"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
promise
=
require
(
"
promise
"
)
;
loader
.
lazyRequireGetter
(
this
"
Toolbox
"
"
devtools
/
client
/
framework
/
toolbox
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
gDevToolsBrowser
"
"
devtools
/
client
/
framework
/
devtools
-
browser
"
true
)
;
const
{
defaultTools
:
DefaultTools
defaultThemes
:
DefaultThemes
}
=
require
(
"
devtools
/
client
/
definitions
"
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
Telemetry
=
require
(
"
devtools
/
client
/
shared
/
telemetry
"
)
;
const
{
JsonView
}
=
require
(
"
devtools
/
client
/
jsonview
/
main
"
)
;
const
TABS_OPEN_PEAK_HISTOGRAM
=
"
DEVTOOLS_TABS_OPEN_PEAK_LINEAR
"
;
const
TABS_OPEN_AVG_HISTOGRAM
=
"
DEVTOOLS_TABS_OPEN_AVERAGE_LINEAR
"
;
const
TABS_PINNED_PEAK_HISTOGRAM
=
"
DEVTOOLS_TABS_PINNED_PEAK_LINEAR
"
;
const
TABS_PINNED_AVG_HISTOGRAM
=
"
DEVTOOLS_TABS_PINNED_AVERAGE_LINEAR
"
;
const
FORBIDDEN_IDS
=
new
Set
(
[
"
toolbox
"
"
"
]
)
;
const
MAX_ORDINAL
=
99
;
this
.
DevTools
=
function
DevTools
(
)
{
this
.
_tools
=
new
Map
(
)
;
this
.
_themes
=
new
Map
(
)
;
this
.
_toolboxes
=
new
Map
(
)
;
this
.
_telemetry
=
new
Telemetry
(
)
;
this
.
destroy
=
this
.
destroy
.
bind
(
this
)
;
this
.
_teardown
=
this
.
_teardown
.
bind
(
this
)
;
JsonView
.
initialize
(
)
;
EventEmitter
.
decorate
(
this
)
;
Services
.
obs
.
addObserver
(
this
.
_teardown
"
devtools
-
unloaded
"
false
)
;
Services
.
obs
.
addObserver
(
this
.
destroy
"
quit
-
application
"
false
)
;
}
;
DevTools
.
prototype
=
{
registerTool
:
function
DT_registerTool
(
toolDefinition
)
{
let
toolId
=
toolDefinition
.
id
;
if
(
!
toolId
|
|
FORBIDDEN_IDS
.
has
(
toolId
)
)
{
throw
new
Error
(
"
Invalid
definition
.
id
"
)
;
}
if
(
DefaultTools
&
&
DefaultTools
.
indexOf
(
toolDefinition
)
=
=
-
1
)
{
toolDefinition
.
visibilityswitch
=
"
devtools
.
"
+
toolId
+
"
.
enabled
"
;
}
this
.
_tools
.
set
(
toolId
toolDefinition
)
;
this
.
emit
(
"
tool
-
registered
"
toolId
)
;
}
unregisterTool
:
function
DT_unregisterTool
(
tool
isQuitApplication
)
{
let
toolId
=
null
;
if
(
typeof
tool
=
=
"
string
"
)
{
toolId
=
tool
;
tool
=
this
.
_tools
.
get
(
tool
)
;
}
else
{
toolId
=
tool
.
id
;
}
this
.
_tools
.
delete
(
toolId
)
;
if
(
!
isQuitApplication
)
{
this
.
emit
(
"
tool
-
unregistered
"
tool
)
;
}
}
ordinalSort
:
function
DT_ordinalSort
(
d1
d2
)
{
let
o1
=
(
typeof
d1
.
ordinal
=
=
"
number
"
)
?
d1
.
ordinal
:
MAX_ORDINAL
;
let
o2
=
(
typeof
d2
.
ordinal
=
=
"
number
"
)
?
d2
.
ordinal
:
MAX_ORDINAL
;
return
o1
-
o2
;
}
getDefaultTools
:
function
DT_getDefaultTools
(
)
{
return
DefaultTools
.
sort
(
this
.
ordinalSort
)
;
}
getAdditionalTools
:
function
DT_getAdditionalTools
(
)
{
let
tools
=
[
]
;
for
(
let
[
key
value
]
of
this
.
_tools
)
{
if
(
DefaultTools
.
indexOf
(
value
)
=
=
-
1
)
{
tools
.
push
(
value
)
;
}
}
return
tools
.
sort
(
this
.
ordinalSort
)
;
}
getToolDefinition
:
function
DT_getToolDefinition
(
toolId
)
{
let
tool
=
this
.
_tools
.
get
(
toolId
)
;
if
(
!
tool
)
{
return
null
;
}
else
if
(
!
tool
.
visibilityswitch
)
{
return
tool
;
}
let
enabled
;
try
{
enabled
=
Services
.
prefs
.
getBoolPref
(
tool
.
visibilityswitch
)
;
}
catch
(
e
)
{
enabled
=
true
;
}
return
enabled
?
tool
:
null
;
}
getToolDefinitionMap
:
function
DT_getToolDefinitionMap
(
)
{
let
tools
=
new
Map
(
)
;
for
(
let
[
id
definition
]
of
this
.
_tools
)
{
if
(
this
.
getToolDefinition
(
id
)
)
{
tools
.
set
(
id
definition
)
;
}
}
return
tools
;
}
getToolDefinitionArray
:
function
DT_getToolDefinitionArray
(
)
{
let
definitions
=
[
]
;
for
(
let
[
id
definition
]
of
this
.
_tools
)
{
if
(
this
.
getToolDefinition
(
id
)
)
{
definitions
.
push
(
definition
)
;
}
}
return
definitions
.
sort
(
this
.
ordinalSort
)
;
}
registerTheme
:
function
DT_registerTheme
(
themeDefinition
)
{
let
themeId
=
themeDefinition
.
id
;
if
(
!
themeId
)
{
throw
new
Error
(
"
Invalid
theme
id
"
)
;
}
if
(
this
.
_themes
.
get
(
themeId
)
)
{
throw
new
Error
(
"
Theme
with
the
same
id
is
already
registered
"
)
;
}
this
.
_themes
.
set
(
themeId
themeDefinition
)
;
this
.
emit
(
"
theme
-
registered
"
themeId
)
;
}
unregisterTheme
:
function
DT_unregisterTheme
(
theme
)
{
let
themeId
=
null
;
if
(
typeof
theme
=
=
"
string
"
)
{
themeId
=
theme
;
theme
=
this
.
_themes
.
get
(
theme
)
;
}
else
{
themeId
=
theme
.
id
;
}
let
currTheme
=
Services
.
prefs
.
getCharPref
(
"
devtools
.
theme
"
)
;
let
isCoreTheme
=
DefaultThemes
.
some
(
t
=
>
t
.
id
=
=
=
themeId
)
;
if
(
!
Services
.
startup
.
shuttingDown
&
&
!
isCoreTheme
&
&
theme
.
id
=
=
currTheme
)
{
Services
.
prefs
.
setCharPref
(
"
devtools
.
theme
"
"
light
"
)
;
let
data
=
{
pref
:
"
devtools
.
theme
"
newValue
:
"
light
"
oldValue
:
currTheme
}
;
this
.
emit
(
"
pref
-
changed
"
data
)
;
this
.
emit
(
"
theme
-
unregistered
"
theme
)
;
}
this
.
_themes
.
delete
(
themeId
)
;
}
getThemeDefinition
:
function
DT_getThemeDefinition
(
themeId
)
{
let
theme
=
this
.
_themes
.
get
(
themeId
)
;
if
(
!
theme
)
{
return
null
;
}
return
theme
;
}
getThemeDefinitionMap
:
function
DT_getThemeDefinitionMap
(
)
{
let
themes
=
new
Map
(
)
;
for
(
let
[
id
definition
]
of
this
.
_themes
)
{
if
(
this
.
getThemeDefinition
(
id
)
)
{
themes
.
set
(
id
definition
)
;
}
}
return
themes
;
}
getThemeDefinitionArray
:
function
DT_getThemeDefinitionArray
(
)
{
let
definitions
=
[
]
;
for
(
let
[
id
definition
]
of
this
.
_themes
)
{
if
(
this
.
getThemeDefinition
(
id
)
)
{
definitions
.
push
(
definition
)
;
}
}
return
definitions
.
sort
(
this
.
ordinalSort
)
;
}
showToolbox
:
function
(
target
toolId
hostType
hostOptions
)
{
let
deferred
=
promise
.
defer
(
)
;
let
toolbox
=
this
.
_toolboxes
.
get
(
target
)
;
if
(
toolbox
)
{
let
hostPromise
=
(
hostType
!
=
null
&
&
toolbox
.
hostType
!
=
hostType
)
?
toolbox
.
switchHost
(
hostType
)
:
promise
.
resolve
(
null
)
;
if
(
toolId
!
=
null
&
&
toolbox
.
currentToolId
!
=
toolId
)
{
hostPromise
=
hostPromise
.
then
(
function
(
)
{
return
toolbox
.
selectTool
(
toolId
)
;
}
)
;
}
return
hostPromise
.
then
(
function
(
)
{
toolbox
.
raise
(
)
;
return
toolbox
;
}
)
;
}
else
{
toolbox
=
new
Toolbox
(
target
toolId
hostType
hostOptions
)
;
this
.
emit
(
"
toolbox
-
created
"
toolbox
)
;
this
.
_toolboxes
.
set
(
target
toolbox
)
;
toolbox
.
once
(
"
destroy
"
(
)
=
>
{
this
.
emit
(
"
toolbox
-
destroy
"
target
)
;
}
)
;
toolbox
.
once
(
"
destroyed
"
(
)
=
>
{
this
.
_toolboxes
.
delete
(
target
)
;
this
.
emit
(
"
toolbox
-
destroyed
"
target
)
;
}
)
;
toolbox
.
open
(
)
.
then
(
(
)
=
>
{
deferred
.
resolve
(
toolbox
)
;
this
.
emit
(
"
toolbox
-
ready
"
toolbox
)
;
}
)
;
}
return
deferred
.
promise
;
}
getToolbox
:
function
DT_getToolbox
(
target
)
{
return
this
.
_toolboxes
.
get
(
target
)
;
}
closeToolbox
:
function
DT_closeToolbox
(
target
)
{
let
toolbox
=
this
.
_toolboxes
.
get
(
target
)
;
if
(
toolbox
=
=
null
)
{
return
promise
.
resolve
(
false
)
;
}
return
toolbox
.
destroy
(
)
.
then
(
(
)
=
>
true
)
;
}
_pingTelemetry
:
function
(
)
{
let
mean
=
function
(
arr
)
{
if
(
arr
.
length
=
=
=
0
)
{
return
0
;
}
let
total
=
arr
.
reduce
(
(
a
b
)
=
>
a
+
b
)
;
return
Math
.
ceil
(
total
/
arr
.
length
)
;
}
;
let
tabStats
=
gDevToolsBrowser
.
_tabStats
;
this
.
_telemetry
.
log
(
TABS_OPEN_PEAK_HISTOGRAM
tabStats
.
peakOpen
)
;
this
.
_telemetry
.
log
(
TABS_OPEN_AVG_HISTOGRAM
mean
(
tabStats
.
histOpen
)
)
;
this
.
_telemetry
.
log
(
TABS_PINNED_PEAK_HISTOGRAM
tabStats
.
peakPinned
)
;
this
.
_telemetry
.
log
(
TABS_PINNED_AVG_HISTOGRAM
mean
(
tabStats
.
histPinned
)
)
;
}
_teardown
:
function
DT_teardown
(
)
{
for
(
let
[
target
toolbox
]
of
this
.
_toolboxes
)
{
toolbox
.
destroy
(
)
;
}
}
destroy
:
function
(
)
{
Services
.
obs
.
removeObserver
(
this
.
destroy
"
quit
-
application
"
)
;
Services
.
obs
.
removeObserver
(
this
.
_teardown
"
devtools
-
unloaded
"
)
;
for
(
let
[
key
tool
]
of
this
.
getToolDefinitionMap
(
)
)
{
this
.
unregisterTool
(
key
true
)
;
}
JsonView
.
destroy
(
)
;
this
.
_pingTelemetry
(
)
;
this
.
_telemetry
=
null
;
}
*
[
Symbol
.
iterator
]
(
)
{
for
(
let
toolbox
of
this
.
_toolboxes
)
{
yield
toolbox
;
}
}
}
;
exports
.
gDevTools
=
new
DevTools
(
)
;
