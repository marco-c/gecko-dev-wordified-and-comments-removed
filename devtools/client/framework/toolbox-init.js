"
use
strict
"
;
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
)
;
const
href
=
window
.
location
.
href
.
replace
(
"
about
:
"
"
http
:
/
/
"
)
;
const
url
=
new
window
.
URL
(
href
)
;
let
host
=
window
.
browsingContext
.
embedderElement
;
if
(
!
host
)
{
host
=
{
contentWindow
:
window
contentDocument
:
document
setAttribute
(
)
{
}
ownerDocument
:
document
addEventListener
(
)
{
}
}
;
}
const
onLoad
=
new
Promise
(
r
=
>
{
host
.
contentWindow
.
addEventListener
(
"
DOMContentLoaded
"
r
{
once
:
true
}
)
;
}
)
;
async
function
showErrorPage
(
doc
errorMessage
)
{
const
win
=
doc
.
defaultView
;
const
{
BrowserLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
client
/
shared
/
browser
-
loader
.
js
"
)
;
const
browserRequire
=
BrowserLoader
(
{
window
:
win
useOnlyShared
:
true
}
)
.
require
;
const
React
=
browserRequire
(
"
devtools
/
client
/
shared
/
vendor
/
react
"
)
;
const
ReactDOM
=
browserRequire
(
"
devtools
/
client
/
shared
/
vendor
/
react
-
dom
"
)
;
const
DebugTargetErrorPage
=
React
.
createFactory
(
require
(
"
devtools
/
client
/
framework
/
components
/
DebugTargetErrorPage
"
)
)
;
const
{
LocalizationHelper
}
=
browserRequire
(
"
devtools
/
shared
/
l10n
"
)
;
const
L10N
=
new
LocalizationHelper
(
"
devtools
/
client
/
locales
/
toolbox
.
properties
"
)
;
await
onLoad
;
document
.
title
=
L10N
.
getStr
(
"
toolbox
.
debugTargetInfo
.
tabTitleError
"
)
;
const
mountEl
=
doc
.
querySelector
(
"
#
toolbox
-
error
-
mount
"
)
;
const
element
=
DebugTargetErrorPage
(
{
errorMessage
L10N
}
)
;
ReactDOM
.
render
(
element
mountEl
)
;
win
.
addEventListener
(
"
unload
"
(
)
=
>
{
ReactDOM
.
unmountComponentAtNode
(
mountEl
)
;
}
{
once
:
true
}
)
;
}
async
function
initToolbox
(
url
host
)
{
const
{
gDevTools
}
=
require
(
"
devtools
/
client
/
framework
/
devtools
"
)
;
const
{
descriptorFromURL
}
=
require
(
"
devtools
/
client
/
framework
/
descriptor
-
from
-
url
"
)
;
const
{
Toolbox
}
=
require
(
"
devtools
/
client
/
framework
/
toolbox
"
)
;
const
tool
=
url
.
searchParams
.
get
(
"
tool
"
)
;
try
{
let
descriptor
;
if
(
url
.
searchParams
.
has
(
"
target
"
)
)
{
descriptor
=
await
_createTestOnlyDescriptor
(
host
)
;
}
else
{
descriptor
=
await
descriptorFromURL
(
url
)
;
const
toolbox
=
gDevTools
.
getToolboxForDescriptor
(
descriptor
)
;
if
(
toolbox
&
&
toolbox
.
isDestroying
(
)
)
{
await
toolbox
.
destroy
(
)
;
}
}
const
options
=
{
customIframe
:
host
}
;
const
newToolbox
=
await
gDevTools
.
showToolbox
(
descriptor
{
toolId
:
tool
hostType
:
Toolbox
.
HostType
.
PAGE
hostOptions
:
options
}
)
;
const
target
=
newToolbox
.
target
;
const
{
descriptorFront
}
=
target
;
descriptorFront
.
once
(
"
descriptor
-
destroyed
"
function
(
)
{
if
(
host
.
contentDocument
)
{
const
error
=
new
Error
(
"
Debug
target
was
disconnected
"
)
;
showErrorPage
(
host
.
contentDocument
{
error
}
)
;
}
}
)
;
const
isCachedClient
=
url
.
searchParams
.
get
(
"
remoteId
"
)
;
target
.
shouldCloseClient
=
!
isCachedClient
;
}
catch
(
error
)
{
console
.
error
(
"
Exception
while
loading
the
toolbox
"
error
)
;
showErrorPage
(
host
.
contentDocument
{
error
}
)
;
}
}
async
function
_createTestOnlyDescriptor
(
host
)
{
const
{
DevToolsServer
}
=
require
(
"
devtools
/
server
/
devtools
-
server
"
)
;
const
{
DevToolsClient
}
=
require
(
"
devtools
/
client
/
devtools
-
client
"
)
;
let
iframe
=
host
.
wrappedJSObject
?
host
.
wrappedJSObject
.
target
:
host
.
target
;
if
(
!
iframe
)
{
throw
new
Error
(
"
Unable
to
find
the
targeted
iframe
to
debug
"
)
;
}
iframe
=
XPCNativeWrapper
(
iframe
)
;
const
tab
=
{
linkedBrowser
:
iframe
}
;
DevToolsServer
.
init
(
)
;
DevToolsServer
.
registerAllActors
(
)
;
const
client
=
new
DevToolsClient
(
DevToolsServer
.
connectPipe
(
)
)
;
await
client
.
connect
(
)
;
const
descriptor
=
await
client
.
mainRoot
.
getTab
(
{
tab
}
)
;
const
target
=
await
descriptor
.
getTarget
(
)
;
target
.
shouldCloseClient
=
true
;
return
descriptor
;
}
if
(
url
.
search
.
length
>
1
)
{
initToolbox
(
url
host
)
;
}
