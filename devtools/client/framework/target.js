"
use
strict
"
;
loader
.
lazyRequireGetter
(
this
"
DebuggerServer
"
"
devtools
/
server
/
main
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
DebuggerClient
"
"
devtools
/
shared
/
client
/
debugger
-
client
"
true
)
;
const
targets
=
new
WeakMap
(
)
;
exports
.
TargetFactory
=
{
forTab
:
async
function
(
tab
)
{
let
target
=
targets
.
get
(
tab
)
;
if
(
target
)
{
return
target
;
}
const
promise
=
this
.
createTargetForTab
(
tab
)
;
targets
.
set
(
tab
promise
)
;
target
=
await
promise
;
targets
.
set
(
tab
target
)
;
target
.
attachTab
(
tab
)
;
target
.
once
(
"
close
"
(
)
=
>
{
targets
.
delete
(
tab
)
;
}
)
;
return
target
;
}
async
createTargetForTab
(
tab
)
{
function
createLocalServer
(
)
{
DebuggerServer
.
init
(
)
;
DebuggerServer
.
registerAllActors
(
)
;
DebuggerServer
.
allowChromeProcess
=
true
;
}
function
createLocalClient
(
)
{
return
new
DebuggerClient
(
DebuggerServer
.
connectPipe
(
)
)
;
}
createLocalServer
(
)
;
const
client
=
createLocalClient
(
)
;
await
client
.
connect
(
)
;
return
client
.
mainRoot
.
getTab
(
{
tab
}
)
;
}
forRemoteTab
:
function
(
{
activeTab
client
chrome
}
)
{
const
target
=
activeTab
;
if
(
chrome
)
{
target
.
forceChrome
(
)
;
}
const
targetPromise
=
target
.
attach
(
)
.
then
(
(
)
=
>
target
)
;
targetPromise
.
catch
(
e
=
>
{
console
.
error
(
"
Exception
while
attaching
target
"
e
)
;
}
)
;
return
targetPromise
;
}
forWorker
:
function
(
workerTargetFront
)
{
return
workerTargetFront
;
}
isKnownTab
:
function
(
tab
)
{
return
targets
.
has
(
tab
)
;
}
}
;
