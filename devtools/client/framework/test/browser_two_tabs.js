var
{
DebuggerServer
}
=
require
(
"
devtools
/
server
/
main
"
)
;
var
{
DebuggerClient
}
=
require
(
"
devtools
/
shared
/
client
/
debugger
-
client
"
)
;
const
TAB_URL_1
=
"
data
:
text
/
html
;
charset
=
utf
-
8
foo
"
;
const
TAB_URL_2
=
"
data
:
text
/
html
;
charset
=
utf
-
8
bar
"
;
var
gClient
;
var
gTab1
gTab2
;
var
gTabActor1
gTabActor2
;
function
test
(
)
{
waitForExplicitFinish
(
)
;
if
(
!
DebuggerServer
.
initialized
)
{
DebuggerServer
.
init
(
)
;
DebuggerServer
.
registerActors
(
{
browser
:
true
root
:
true
tab
:
true
}
)
;
}
openTabs
(
)
;
}
function
openTabs
(
)
{
addTab
(
TAB_URL_1
)
.
then
(
tab1
=
>
{
gTab1
=
tab1
;
addTab
(
TAB_URL_2
)
.
then
(
tab2
=
>
{
gTab2
=
tab2
;
connect
(
)
;
}
)
;
}
)
;
}
function
connect
(
)
{
gClient
=
new
DebuggerClient
(
DebuggerServer
.
connectPipe
(
)
)
;
gClient
.
connect
(
)
.
then
(
(
)
=
>
gClient
.
listTabs
(
)
)
.
then
(
response
=
>
{
gTabActor1
=
response
.
tabs
.
filter
(
a
=
>
a
.
url
=
=
=
TAB_URL_1
)
[
0
]
;
gTabActor2
=
response
.
tabs
.
filter
(
a
=
>
a
.
url
=
=
=
TAB_URL_2
)
[
0
]
;
checkGetTab
(
)
;
}
)
;
}
function
checkGetTab
(
)
{
gClient
.
getTab
(
{
tab
:
gTab1
}
)
.
then
(
response
=
>
{
is
(
JSON
.
stringify
(
gTabActor1
)
JSON
.
stringify
(
response
.
tab
)
"
getTab
returns
the
same
tab
grip
for
first
tab
"
)
;
}
)
.
then
(
(
)
=
>
{
let
filter
=
{
}
;
if
(
gTab1
.
linkedBrowser
.
frameLoader
.
tabParent
)
{
filter
.
tabId
=
gTab1
.
linkedBrowser
.
frameLoader
.
tabParent
.
tabId
;
}
else
{
let
windowUtils
=
gTab1
.
linkedBrowser
.
contentWindow
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDOMWindowUtils
)
;
filter
.
outerWindowID
=
windowUtils
.
outerWindowID
;
}
return
gClient
.
getTab
(
filter
)
;
}
)
.
then
(
response
=
>
{
is
(
JSON
.
stringify
(
gTabActor1
)
JSON
.
stringify
(
response
.
tab
)
"
getTab
returns
the
same
tab
grip
when
filtering
by
tabId
/
outerWindowID
"
)
;
}
)
.
then
(
(
)
=
>
gClient
.
getTab
(
{
tab
:
gTab2
}
)
)
.
then
(
response
=
>
{
is
(
JSON
.
stringify
(
gTabActor2
)
JSON
.
stringify
(
response
.
tab
)
"
getTab
returns
the
same
tab
grip
for
second
tab
"
)
;
}
)
.
then
(
checkGetTabFailures
)
;
}
function
checkGetTabFailures
(
)
{
gClient
.
getTab
(
{
tabId
:
-
999
}
)
.
then
(
response
=
>
ok
(
false
"
getTab
unexpectedly
succeed
with
a
wrong
tabId
"
)
response
=
>
{
is
(
response
.
error
"
noTab
"
)
;
is
(
response
.
message
"
Unable
to
find
tab
with
tabId
'
-
999
'
"
)
;
}
)
.
then
(
(
)
=
>
gClient
.
getTab
(
{
outerWindowID
:
-
999
}
)
)
.
then
(
response
=
>
ok
(
false
"
getTab
unexpectedly
succeed
with
a
wrong
outerWindowID
"
)
response
=
>
{
is
(
response
.
error
"
noTab
"
)
;
is
(
response
.
message
"
Unable
to
find
tab
with
outerWindowID
'
-
999
'
"
)
;
}
)
.
then
(
checkSelectedTabActor
)
;
}
function
checkSelectedTabActor
(
)
{
gClient
.
request
(
{
to
:
gTabActor2
.
consoleActor
type
:
"
startListeners
"
listeners
:
[
]
}
aResponse
=
>
{
ok
(
"
startedListeners
"
in
aResponse
"
Actor
from
the
selected
tab
should
respond
to
the
request
.
"
)
;
closeSecondTab
(
)
;
}
)
;
}
function
closeSecondTab
(
)
{
let
container
=
gBrowser
.
tabContainer
;
container
.
addEventListener
(
"
TabClose
"
function
(
)
{
checkFirstTabActor
(
)
;
}
{
once
:
true
}
)
;
gBrowser
.
removeTab
(
gTab2
)
;
}
function
checkFirstTabActor
(
)
{
gClient
.
request
(
{
to
:
gTabActor1
.
consoleActor
type
:
"
startListeners
"
listeners
:
[
]
}
aResponse
=
>
{
ok
(
"
startedListeners
"
in
aResponse
"
Actor
from
the
first
tab
should
still
respond
.
"
)
;
cleanup
(
)
;
}
)
;
}
function
cleanup
(
)
{
let
container
=
gBrowser
.
tabContainer
;
container
.
addEventListener
(
"
TabClose
"
function
(
)
{
gClient
.
close
(
)
.
then
(
finish
)
;
}
{
once
:
true
}
)
;
gBrowser
.
removeTab
(
gTab1
)
;
}
