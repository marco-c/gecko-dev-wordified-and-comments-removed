"
use
strict
"
;
let
tracker
;
{
const
{
DevToolsLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
const
loader
=
new
DevToolsLoader
(
{
invisibleToDebugger
:
true
}
)
;
const
{
allocationTracker
}
=
loader
.
require
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
shared
/
test
-
helpers
/
allocation
-
tracker
.
js
"
)
;
tracker
=
allocationTracker
(
{
watchDevToolsGlobals
:
true
}
)
;
}
const
{
XPCOMUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
sys
.
mjs
"
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
TrackedObjects
"
(
)
=
>
{
return
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
test
-
helpers
/
tracked
-
objects
.
jsm
"
)
;
}
)
;
SimpleTest
.
requestCompleteLog
(
)
;
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
devtools
.
testing
"
false
]
]
}
)
;
const
env
=
Cc
[
"
mozilla
.
org
/
process
/
environment
;
1
"
]
.
getService
(
Ci
.
nsIEnvironment
)
;
const
DEBUG_ALLOCATIONS
=
env
.
get
(
"
DEBUG_DEVTOOLS_ALLOCATIONS
"
)
;
async
function
addTab
(
url
)
{
const
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
url
)
;
gBrowser
.
selectedTab
=
tab
;
await
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
return
tab
;
}
async
function
startRecordingAllocations
(
{
alsoRecordContentProcess
=
false
}
=
{
}
)
{
if
(
alsoRecordContentProcess
)
{
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
DEBUG_ALLOCATIONS
]
async
debug_allocations
=
>
{
const
{
DevToolsLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
const
loader
=
new
DevToolsLoader
(
{
invisibleToDebugger
:
true
}
)
;
const
{
allocationTracker
}
=
loader
.
require
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
shared
/
test
-
helpers
/
allocation
-
tracker
.
js
"
)
;
const
tracker
=
allocationTracker
(
{
watchAllGlobals
:
true
}
)
;
DevToolsLoader
.
tracker
=
tracker
;
await
tracker
.
startRecordingAllocations
(
debug_allocations
)
;
}
)
;
await
tracker
.
doGC
(
)
;
}
await
tracker
.
startRecordingAllocations
(
DEBUG_ALLOCATIONS
)
;
}
async
function
stopRecordingAllocations
(
recordName
{
alsoRecordContentProcess
=
false
}
=
{
}
)
{
ok
(
!
tracker
.
overflowed
"
Allocation
were
all
recorded
in
the
parent
process
"
)
;
const
parentProcessData
=
await
tracker
.
stopRecordingAllocations
(
DEBUG_ALLOCATIONS
)
;
const
objectNodeIds
=
TrackedObjects
.
getAllNodeIds
(
)
;
if
(
objectNodeIds
.
length
)
{
tracker
.
traceObjects
(
objectNodeIds
)
;
}
let
contentProcessData
=
null
;
if
(
alsoRecordContentProcess
)
{
contentProcessData
=
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
DEBUG_ALLOCATIONS
]
debug_allocations
=
>
{
const
{
DevToolsLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
const
{
tracker
}
=
DevToolsLoader
;
ok
(
!
tracker
.
overflowed
"
Allocation
were
all
recorded
in
the
content
process
"
)
;
return
tracker
.
stopRecordingAllocations
(
debug_allocations
)
;
}
)
;
}
const
trackedObjectsInContent
=
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
TrackedObjects
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
test
-
helpers
/
tracked
-
objects
.
jsm
"
)
;
const
objectNodeIds
=
TrackedObjects
.
getAllNodeIds
(
)
;
if
(
objectNodeIds
.
length
)
{
const
{
DevToolsLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
const
{
tracker
}
=
DevToolsLoader
;
const
snapshotFile
=
tracker
.
getSnapshotFile
(
)
;
return
{
snapshotFile
objectNodeIds
}
;
}
return
null
;
}
)
;
if
(
trackedObjectsInContent
)
{
tracker
.
traceObjects
(
trackedObjectsInContent
.
objectNodeIds
trackedObjectsInContent
.
snapshotFile
)
;
}
info
(
The
{
recordName
}
test
leaked
{
parentProcessData
.
objectsWithStack
}
objects
(
{
parentProcessData
.
objectsWithoutStack
}
with
missing
allocation
site
)
in
the
parent
process
)
;
const
PERFHERDER_DATA
=
{
framework
:
{
name
:
"
devtools
"
}
suites
:
[
{
name
:
recordName
+
"
:
parent
-
process
"
subtests
:
[
{
name
:
"
objects
-
with
-
no
-
stacks
"
value
:
parentProcessData
.
objectsWithoutStack
}
{
name
:
"
objects
-
with
-
stacks
"
value
:
parentProcessData
.
objectsWithStack
}
{
name
:
"
memory
"
value
:
parentProcessData
.
memory
}
]
}
]
}
;
if
(
alsoRecordContentProcess
)
{
info
(
The
{
recordName
}
test
leaked
{
contentProcessData
.
objectsWithStack
}
objects
(
{
contentProcessData
.
objectsWithoutStack
}
with
missing
allocation
site
)
in
the
content
process
)
;
PERFHERDER_DATA
.
suites
.
push
(
{
name
:
recordName
+
"
:
content
-
process
"
subtests
:
[
{
name
:
"
objects
-
with
-
no
-
stacks
"
value
:
contentProcessData
.
objectsWithoutStack
}
{
name
:
"
objects
-
with
-
stacks
"
value
:
contentProcessData
.
objectsWithStack
}
{
name
:
"
memory
"
value
:
contentProcessData
.
memory
}
]
}
)
;
}
info
(
"
PERFHERDER_DATA
:
"
+
JSON
.
stringify
(
PERFHERDER_DATA
)
)
;
}
