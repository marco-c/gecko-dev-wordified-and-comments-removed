"
use
strict
"
;
const
devtoolsPreferences
=
Services
.
prefs
.
getBranch
(
"
devtools
"
)
;
const
alreadySetPreferences
=
new
Set
(
)
;
for
(
const
pref
of
devtoolsPreferences
.
getChildList
(
"
"
)
)
{
if
(
devtoolsPreferences
.
prefHasUserValue
(
pref
)
)
{
alreadySetPreferences
.
add
(
pref
)
;
}
}
registerCleanupFunction
(
async
(
)
=
>
{
await
SpecialPowers
.
flushPrefEnv
(
)
;
for
(
const
pref
of
devtoolsPreferences
.
getChildList
(
"
"
)
)
{
if
(
devtoolsPreferences
.
prefHasUserValue
(
pref
)
&
&
!
alreadySetPreferences
.
has
(
pref
)
)
{
devtoolsPreferences
.
clearUserPref
(
pref
)
;
}
}
}
)
;
let
tracker
releaseTrackerLoader
;
{
const
{
useDistinctSystemPrincipalLoader
releaseDistinctSystemPrincipalLoader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
DistinctSystemPrincipalLoader
.
sys
.
mjs
"
{
global
:
"
shared
"
}
)
;
const
requester
=
{
}
;
const
loader
=
useDistinctSystemPrincipalLoader
(
requester
)
;
releaseTrackerLoader
=
(
)
=
>
releaseDistinctSystemPrincipalLoader
(
requester
)
;
const
{
allocationTracker
}
=
loader
.
require
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
shared
/
test
-
helpers
/
allocation
-
tracker
.
js
"
)
;
tracker
=
allocationTracker
(
{
watchDevToolsGlobals
:
true
}
)
;
}
ChromeUtils
.
defineLazyGetter
(
this
"
TrackedObjects
"
(
)
=
>
{
return
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
test
-
helpers
/
tracked
-
objects
.
sys
.
mjs
"
)
;
}
)
;
ChromeUtils
.
defineLazyGetter
(
this
"
TraceObjects
"
(
)
=
>
{
return
ChromeUtils
.
importESModule
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
shared
/
test
-
helpers
/
trace
-
objects
.
sys
.
mjs
"
)
;
}
)
;
SimpleTest
.
requestCompleteLog
(
)
;
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
devtools
.
testing
"
false
]
]
}
)
;
const
DEBUG_ALLOCATIONS
=
Services
.
env
.
get
(
"
DEBUG_DEVTOOLS_ALLOCATIONS
"
)
;
async
function
addTab
(
url
)
{
const
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
url
)
;
gBrowser
.
selectedTab
=
tab
;
await
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
return
tab
;
}
async
function
startRecordingAllocations
(
{
alsoRecordContentProcess
=
false
}
=
{
}
)
{
if
(
alsoRecordContentProcess
)
{
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
DEBUG_ALLOCATIONS
]
async
debug_allocations
=
>
{
const
{
DevToolsLoader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
sys
.
mjs
"
)
;
const
{
useDistinctSystemPrincipalLoader
releaseDistinctSystemPrincipalLoader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
DistinctSystemPrincipalLoader
.
sys
.
mjs
"
)
;
const
requester
=
{
}
;
const
loader
=
useDistinctSystemPrincipalLoader
(
requester
)
;
const
{
allocationTracker
}
=
loader
.
require
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
shared
/
test
-
helpers
/
allocation
-
tracker
.
js
"
)
;
const
tracker
=
allocationTracker
(
{
watchAllGlobals
:
true
}
)
;
DevToolsLoader
.
tracker
=
tracker
;
DevToolsLoader
.
releaseTrackerLoader
=
(
)
=
>
releaseDistinctSystemPrincipalLoader
(
requester
)
;
await
tracker
.
startRecordingAllocations
(
debug_allocations
)
;
}
)
;
await
tracker
.
doGC
(
)
;
}
await
tracker
.
startRecordingAllocations
(
DEBUG_ALLOCATIONS
)
;
}
async
function
stopRecordingAllocations
(
recordName
{
alsoRecordContentProcess
=
false
}
=
{
}
)
{
ok
(
!
tracker
.
overflowed
"
Allocation
were
all
recorded
in
the
parent
process
"
)
;
const
parentProcessData
=
await
tracker
.
stopRecordingAllocations
(
DEBUG_ALLOCATIONS
)
;
const
leakedObjects
=
TrackedObjects
.
getStillAllocatedObjects
(
)
;
if
(
leakedObjects
.
length
)
{
await
TraceObjects
.
traceObjects
(
leakedObjects
tracker
.
getSnapshotFile
(
)
)
;
}
let
contentProcessData
=
null
;
if
(
alsoRecordContentProcess
)
{
contentProcessData
=
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
DEBUG_ALLOCATIONS
]
debug_allocations
=
>
{
const
{
DevToolsLoader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
sys
.
mjs
"
)
;
const
{
tracker
}
=
DevToolsLoader
;
ok
(
!
tracker
.
overflowed
"
Allocation
were
all
recorded
in
the
content
process
"
)
;
return
tracker
.
stopRecordingAllocations
(
debug_allocations
)
;
}
)
;
}
const
trackedObjectsInContent
=
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
async
(
)
=
>
{
const
TrackedObjects
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
test
-
helpers
/
tracked
-
objects
.
sys
.
mjs
"
)
;
const
leakedObjects
=
TrackedObjects
.
getStillAllocatedObjects
(
)
;
if
(
leakedObjects
.
length
)
{
const
TraceObjects
=
ChromeUtils
.
importESModule
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
shared
/
test
-
helpers
/
trace
-
objects
.
sys
.
mjs
"
)
;
await
TraceObjects
.
traceObjects
(
leakedObjects
.
map
(
e
=
>
{
return
{
weakRef
:
e
.
weakRef
}
;
}
)
)
;
const
{
DevToolsLoader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
sys
.
mjs
"
)
;
const
{
tracker
}
=
DevToolsLoader
;
const
snapshotFile
=
tracker
.
getSnapshotFile
(
)
;
return
{
snapshotFile
objectUbiNodeIds
:
leakedObjects
.
map
(
e
=
>
{
return
{
ubiNodeId
:
e
.
ubiNodeId
}
;
}
)
}
;
}
return
null
;
}
)
;
if
(
trackedObjectsInContent
)
{
TraceObjects
.
traceObjects
(
trackedObjectsInContent
.
objectUbiNodeIds
trackedObjectsInContent
.
snapshotFile
)
;
}
info
(
The
{
recordName
}
test
leaked
{
parentProcessData
.
objectsWithStack
}
objects
(
{
parentProcessData
.
objectsWithoutStack
}
with
missing
allocation
site
)
in
the
parent
process
)
;
const
PERFHERDER_DATA
=
{
framework
:
{
name
:
"
devtools
"
}
suites
:
[
{
name
:
recordName
+
"
:
parent
-
process
"
subtests
:
[
{
name
:
"
objects
-
with
-
stacks
"
value
:
parentProcessData
.
objectsWithStack
}
{
name
:
"
memory
"
value
:
parentProcessData
.
memory
}
]
}
]
}
;
if
(
alsoRecordContentProcess
)
{
info
(
The
{
recordName
}
test
leaked
{
contentProcessData
.
objectsWithStack
}
objects
(
{
contentProcessData
.
objectsWithoutStack
}
with
missing
allocation
site
)
in
the
content
process
)
;
PERFHERDER_DATA
.
suites
.
push
(
{
name
:
recordName
+
"
:
content
-
process
"
subtests
:
[
{
name
:
"
objects
-
with
-
stacks
"
value
:
contentProcessData
.
objectsWithStack
}
{
name
:
"
memory
"
value
:
contentProcessData
.
memory
}
]
}
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
{
DevToolsLoader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
sys
.
mjs
"
)
;
DevToolsLoader
.
releaseTrackerLoader
(
)
;
}
)
;
}
releaseTrackerLoader
(
)
;
info
(
"
PERFHERDER_DATA
:
"
+
JSON
.
stringify
(
PERFHERDER_DATA
)
)
;
}
