const
Services
=
require
(
"
Services
"
)
;
const
{
LocalizationHelper
}
=
require
(
"
devtools
/
shared
/
l10n
"
)
;
const
L10N
=
new
LocalizationHelper
(
"
devtools
/
client
/
locales
/
toolbox
.
properties
"
)
;
function
handleThreadState
(
toolbox
event
packet
)
{
if
(
event
=
=
=
"
paused
"
&
&
packet
.
why
.
type
=
=
=
"
interrupted
"
)
{
return
;
}
toolbox
.
target
.
emit
(
"
thread
-
"
+
event
)
;
if
(
event
=
=
=
"
paused
"
)
{
toolbox
.
highlightTool
(
"
jsdebugger
"
)
;
if
(
packet
.
why
.
type
=
=
=
"
debuggerStatement
"
|
|
packet
.
why
.
type
=
=
=
"
breakpoint
"
|
|
packet
.
why
.
type
=
=
=
"
exception
"
)
{
toolbox
.
raise
(
)
;
toolbox
.
selectTool
(
"
jsdebugger
"
packet
.
why
.
type
)
;
}
}
else
if
(
event
=
=
=
"
resumed
"
)
{
toolbox
.
unhighlightTool
(
"
jsdebugger
"
)
;
}
}
function
attachThread
(
toolbox
)
{
const
target
=
toolbox
.
target
;
const
{
form
:
{
chromeDebugger
actor
}
}
=
target
;
let
useSourceMaps
=
false
;
let
autoBlackBox
=
false
;
let
ignoreFrameEnvironment
=
false
;
const
newDebuggerEnabled
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
debugger
.
new
-
debugger
-
frontend
"
)
;
if
(
!
newDebuggerEnabled
)
{
useSourceMaps
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
debugger
.
source
-
maps
-
enabled
"
)
;
autoBlackBox
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
debugger
.
auto
-
black
-
box
"
)
;
}
else
{
ignoreFrameEnvironment
=
true
;
}
const
threadOptions
=
{
useSourceMaps
autoBlackBox
ignoreFrameEnvironment
}
;
return
new
Promise
(
(
resolve
reject
)
=
>
{
const
handleResponse
=
(
[
res
threadClient
]
)
=
>
{
if
(
res
.
error
)
{
reject
(
new
Error
(
"
Couldn
'
t
attach
to
thread
:
"
+
res
.
error
)
)
;
return
;
}
threadClient
.
addListener
(
"
paused
"
handleThreadState
.
bind
(
null
toolbox
)
)
;
threadClient
.
addListener
(
"
resumed
"
handleThreadState
.
bind
(
null
toolbox
)
)
;
if
(
!
threadClient
.
paused
)
{
reject
(
new
Error
(
"
Thread
in
wrong
state
when
starting
up
should
be
paused
"
)
)
;
}
threadClient
.
pauseOnExceptions
(
Services
.
prefs
.
getBoolPref
(
"
devtools
.
debugger
.
pause
-
on
-
exceptions
"
)
Services
.
prefs
.
getBoolPref
(
"
devtools
.
debugger
.
ignore
-
caught
-
exceptions
"
)
)
;
threadClient
.
resume
(
res
=
>
{
if
(
res
.
error
=
=
=
"
wrongOrder
"
)
{
const
box
=
toolbox
.
getNotificationBox
(
)
;
box
.
appendNotification
(
L10N
.
getStr
(
"
toolbox
.
resumeOrderWarning
"
)
"
wrong
-
resume
-
order
"
"
"
box
.
PRIORITY_WARNING_HIGH
)
;
}
resolve
(
threadClient
)
;
}
)
;
}
;
if
(
target
.
isBrowsingContext
)
{
target
.
activeTab
.
attachThread
(
threadOptions
)
.
then
(
handleResponse
)
;
}
else
if
(
target
.
isAddon
)
{
target
.
client
.
attachAddon
(
actor
)
.
then
(
(
[
res
]
)
=
>
{
target
.
client
.
attachThread
(
res
.
threadActor
)
.
then
(
handleResponse
)
;
}
)
;
}
else
{
target
.
client
.
attachThread
(
chromeDebugger
)
.
then
(
handleResponse
)
;
}
}
)
;
}
function
detachThread
(
threadClient
)
{
threadClient
.
removeListener
(
"
paused
"
)
;
threadClient
.
removeListener
(
"
resumed
"
)
;
}
module
.
exports
=
{
attachThread
detachThread
}
;
