"
use
strict
"
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
{
getCurrentZoom
}
=
require
(
"
devtools
/
shared
/
layout
/
utils
"
)
;
function
Menu
(
{
id
=
null
}
=
{
}
)
{
this
.
menuitems
=
[
]
;
this
.
id
=
id
;
Object
.
defineProperty
(
this
"
items
"
{
get
(
)
{
return
this
.
menuitems
;
}
}
)
;
EventEmitter
.
decorate
(
this
)
;
}
Menu
.
prototype
.
append
=
function
(
menuItem
)
{
this
.
menuitems
.
push
(
menuItem
)
;
}
;
Menu
.
prototype
.
insert
=
function
(
pos
menuItem
)
{
throw
Error
(
"
Not
implemented
"
)
;
}
;
Menu
.
prototype
.
popupWithZoom
=
function
(
x
y
doc
)
{
const
zoom
=
getCurrentZoom
(
doc
)
;
this
.
popup
(
x
*
zoom
y
*
zoom
doc
)
;
}
;
Menu
.
prototype
.
popup
=
function
(
screenX
screenY
doc
)
{
let
popupset
=
doc
.
querySelector
(
"
popupset
"
)
;
if
(
!
popupset
)
{
popupset
=
doc
.
createXULElement
(
"
popupset
"
)
;
doc
.
documentElement
.
appendChild
(
popupset
)
;
}
let
popup
=
popupset
.
querySelector
(
"
menupopup
[
menu
-
api
=
\
"
true
\
"
]
"
)
;
if
(
popup
)
{
popup
.
hidePopup
(
)
;
}
popup
=
doc
.
createXULElement
(
"
menupopup
"
)
;
popup
.
setAttribute
(
"
menu
-
api
"
"
true
"
)
;
popup
.
setAttribute
(
"
consumeoutsideclicks
"
"
false
"
)
;
popup
.
setAttribute
(
"
incontentshell
"
"
false
"
)
;
if
(
this
.
id
)
{
popup
.
id
=
this
.
id
;
}
this
.
_createMenuItems
(
popup
)
;
popup
.
addEventListener
(
"
popuphidden
"
(
e
)
=
>
{
if
(
e
.
target
=
=
=
popup
)
{
popup
.
remove
(
)
;
this
.
emit
(
"
close
"
)
;
}
}
)
;
popup
.
addEventListener
(
"
popupshown
"
(
e
)
=
>
{
if
(
e
.
target
=
=
=
popup
)
{
this
.
emit
(
"
open
"
)
;
}
}
)
;
popupset
.
appendChild
(
popup
)
;
popup
.
openPopupAtScreen
(
screenX
screenY
true
)
;
}
;
Menu
.
prototype
.
_createMenuItems
=
function
(
parent
)
{
const
doc
=
parent
.
ownerDocument
;
this
.
menuitems
.
forEach
(
item
=
>
{
if
(
!
item
.
visible
)
{
return
;
}
if
(
item
.
submenu
)
{
const
menupopup
=
doc
.
createXULElement
(
"
menupopup
"
)
;
menupopup
.
setAttribute
(
"
incontentshell
"
"
false
"
)
;
item
.
submenu
.
_createMenuItems
(
menupopup
)
;
const
menu
=
doc
.
createXULElement
(
"
menu
"
)
;
menu
.
appendChild
(
menupopup
)
;
applyItemAttributesToNode
(
item
menu
)
;
parent
.
appendChild
(
menu
)
;
}
else
if
(
item
.
type
=
=
=
"
separator
"
)
{
const
menusep
=
doc
.
createXULElement
(
"
menuseparator
"
)
;
parent
.
appendChild
(
menusep
)
;
}
else
{
const
menuitem
=
doc
.
createXULElement
(
"
menuitem
"
)
;
applyItemAttributesToNode
(
item
menuitem
)
;
menuitem
.
addEventListener
(
"
command
"
(
)
=
>
{
item
.
click
(
)
;
}
)
;
menuitem
.
addEventListener
(
"
DOMMenuItemActive
"
(
)
=
>
{
item
.
hover
(
)
;
}
)
;
parent
.
appendChild
(
menuitem
)
;
}
}
)
;
}
;
Menu
.
setApplicationMenu
=
(
)
=
>
{
throw
Error
(
"
Not
implemented
"
)
;
}
;
Menu
.
sendActionToFirstResponder
=
(
)
=
>
{
throw
Error
(
"
Not
implemented
"
)
;
}
;
Menu
.
buildFromTemplate
=
(
)
=
>
{
throw
Error
(
"
Not
implemented
"
)
;
}
;
function
applyItemAttributesToNode
(
item
node
)
{
if
(
item
.
l10nID
)
{
node
.
setAttribute
(
"
data
-
l10n
-
id
"
item
.
l10nID
)
;
}
else
{
node
.
setAttribute
(
"
label
"
item
.
label
)
;
if
(
item
.
accelerator
)
{
node
.
setAttribute
(
"
acceltext
"
item
.
accelerator
)
;
}
if
(
item
.
accesskey
)
{
node
.
setAttribute
(
"
accesskey
"
item
.
accesskey
)
;
}
}
if
(
item
.
type
=
=
=
"
checkbox
"
)
{
node
.
setAttribute
(
"
type
"
"
checkbox
"
)
;
}
if
(
item
.
type
=
=
=
"
radio
"
)
{
node
.
setAttribute
(
"
type
"
"
radio
"
)
;
}
if
(
item
.
disabled
)
{
node
.
setAttribute
(
"
disabled
"
"
true
"
)
;
}
if
(
item
.
checked
)
{
node
.
setAttribute
(
"
checked
"
"
true
"
)
;
}
if
(
item
.
id
)
{
node
.
id
=
item
.
id
;
}
}
module
.
exports
=
Menu
;
