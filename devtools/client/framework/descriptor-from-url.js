"
use
strict
"
;
const
{
DevToolsServer
}
=
require
(
"
devtools
/
server
/
devtools
-
server
"
)
;
const
{
DevToolsClient
}
=
require
(
"
devtools
/
client
/
devtools
-
client
"
)
;
const
{
remoteClientManager
}
=
require
(
"
devtools
/
client
/
shared
/
remote
-
debugging
/
remote
-
client
-
manager
"
)
;
exports
.
descriptorFromURL
=
async
function
descriptorFromURL
(
url
)
{
const
client
=
await
clientFromURL
(
url
)
;
const
params
=
url
.
searchParams
;
const
isCachedClient
=
params
.
get
(
"
remoteId
"
)
;
if
(
!
isCachedClient
)
{
await
client
.
connect
(
)
;
}
const
id
=
params
.
get
(
"
id
"
)
;
const
type
=
params
.
get
(
"
type
"
)
;
let
descriptorFront
;
try
{
descriptorFront
=
await
_descriptorFromURL
(
client
id
type
)
;
}
catch
(
e
)
{
if
(
!
isCachedClient
)
{
await
client
.
close
(
)
;
}
throw
e
;
}
descriptorFront
.
shouldCloseClient
=
!
isCachedClient
;
return
descriptorFront
;
}
;
async
function
_descriptorFromURL
(
client
id
type
)
{
if
(
!
type
)
{
throw
new
Error
(
"
descriptorFromURL
missing
type
parameter
"
)
;
}
let
descriptorFront
;
if
(
type
=
=
=
"
tab
"
)
{
if
(
id
.
startsWith
(
"
outerID
-
"
)
)
{
let
outerWindowID
=
id
.
replace
(
"
outerID
-
"
"
"
)
;
if
(
isNaN
(
outerWindowID
)
)
{
throw
new
Error
(
descriptorFromURL
wrong
tab
id
'
{
outerWindowID
}
'
should
be
a
number
)
;
}
outerWindowID
=
parseInt
(
outerWindowID
10
)
;
try
{
descriptorFront
=
await
client
.
mainRoot
.
getTab
(
{
outerWindowID
}
)
;
}
catch
(
ex
)
{
if
(
ex
.
message
.
startsWith
(
"
Protocol
error
(
noTab
)
"
)
)
{
throw
new
Error
(
descriptorFromURL
tab
with
outerWindowID
'
{
outerWindowID
}
'
doesn
'
t
exist
)
;
}
throw
ex
;
}
}
else
{
id
=
parseInt
(
id
10
)
;
if
(
isNaN
(
id
)
)
{
throw
new
Error
(
descriptorFromURL
wrong
tab
id
'
{
id
}
'
should
be
a
number
)
;
}
try
{
descriptorFront
=
await
client
.
mainRoot
.
getTab
(
{
browserId
:
id
}
)
;
}
catch
(
ex
)
{
if
(
ex
.
message
.
startsWith
(
"
Protocol
error
(
noTab
)
"
)
)
{
throw
new
Error
(
descriptorFromURL
tab
with
browserId
'
{
id
}
'
doesn
'
t
exist
)
;
}
throw
ex
;
}
}
}
else
if
(
type
=
=
=
"
extension
"
)
{
descriptorFront
=
await
client
.
mainRoot
.
getAddon
(
{
id
}
)
;
if
(
!
descriptorFront
)
{
throw
new
Error
(
descriptorFromURL
extension
with
id
'
{
id
}
'
doesn
'
t
exist
)
;
}
}
else
if
(
type
=
=
=
"
worker
"
)
{
descriptorFront
=
await
client
.
mainRoot
.
getWorker
(
id
)
;
if
(
!
descriptorFront
)
{
throw
new
Error
(
descriptorFromURL
worker
with
id
'
{
id
}
'
doesn
'
t
exist
)
;
}
}
else
if
(
type
=
=
"
process
"
)
{
DevToolsServer
.
allowChromeProcess
=
true
;
try
{
id
=
parseInt
(
id
10
)
;
if
(
isNaN
(
id
)
)
{
id
=
0
;
}
descriptorFront
=
await
client
.
mainRoot
.
getProcess
(
id
)
;
}
catch
(
ex
)
{
if
(
ex
.
error
=
=
"
noProcess
"
)
{
throw
new
Error
(
descriptorFromURL
process
with
id
'
{
id
}
'
doesn
'
t
exist
)
;
}
throw
ex
;
}
}
else
{
throw
new
Error
(
descriptorFromURL
unsupported
type
'
{
type
}
'
parameter
)
;
}
return
descriptorFront
;
}
async
function
clientFromURL
(
url
)
{
const
params
=
url
.
searchParams
;
const
remoteId
=
params
.
get
(
"
remoteId
"
)
;
if
(
remoteId
)
{
const
client
=
remoteClientManager
.
getClientByRemoteId
(
remoteId
)
;
if
(
!
client
)
{
throw
new
Error
(
Could
not
find
client
with
remote
id
:
{
remoteId
}
)
;
}
return
client
;
}
const
host
=
params
.
get
(
"
host
"
)
;
const
port
=
params
.
get
(
"
port
"
)
;
const
webSocket
=
!
!
params
.
get
(
"
ws
"
)
;
let
transport
;
if
(
port
)
{
transport
=
await
DevToolsClient
.
socketConnect
(
{
host
port
webSocket
}
)
;
}
else
{
DevToolsServer
.
init
(
)
;
DevToolsServer
.
registerAllActors
(
)
;
transport
=
DevToolsServer
.
connectPipe
(
)
;
}
return
new
DevToolsClient
(
transport
)
;
}
