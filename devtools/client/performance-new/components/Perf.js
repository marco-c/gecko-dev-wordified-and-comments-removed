"
use
strict
"
;
const
{
PureComponent
createFactory
}
=
require
(
"
devtools
/
client
/
shared
/
vendor
/
react
"
)
;
const
{
connect
}
=
require
(
"
devtools
/
client
/
shared
/
vendor
/
react
-
redux
"
)
;
const
{
div
}
=
require
(
"
devtools
/
client
/
shared
/
vendor
/
react
-
dom
-
factories
"
)
;
const
PropTypes
=
require
(
"
devtools
/
client
/
shared
/
vendor
/
react
-
prop
-
types
"
)
;
const
RecordingButton
=
createFactory
(
require
(
"
devtools
/
client
/
performance
-
new
/
components
/
RecordingButton
.
js
"
)
)
;
const
Settings
=
createFactory
(
require
(
"
devtools
/
client
/
performance
-
new
/
components
/
Settings
.
js
"
)
)
;
const
Description
=
createFactory
(
require
(
"
devtools
/
client
/
performance
-
new
/
components
/
Description
.
js
"
)
)
;
const
actions
=
require
(
"
devtools
/
client
/
performance
-
new
/
store
/
actions
"
)
;
const
selectors
=
require
(
"
devtools
/
client
/
performance
-
new
/
store
/
selectors
"
)
;
class
Perf
extends
PureComponent
{
static
get
propTypes
(
)
{
return
{
perfFront
:
PropTypes
.
object
.
isRequired
recordingState
:
PropTypes
.
string
.
isRequired
isSupportedPlatform
:
PropTypes
.
bool
isPopup
:
PropTypes
.
bool
changeRecordingState
:
PropTypes
.
func
.
isRequired
reportProfilerReady
:
PropTypes
.
func
.
isRequired
}
;
}
constructor
(
props
)
{
super
(
props
)
;
this
.
handleProfilerStarting
=
this
.
handleProfilerStarting
.
bind
(
this
)
;
this
.
handleProfilerStopping
=
this
.
handleProfilerStopping
.
bind
(
this
)
;
this
.
handlePrivateBrowsingStarting
=
this
.
handlePrivateBrowsingStarting
.
bind
(
this
)
;
this
.
handlePrivateBrowsingEnding
=
this
.
handlePrivateBrowsingEnding
.
bind
(
this
)
;
}
componentDidMount
(
)
{
const
{
perfFront
reportProfilerReady
isPopup
}
=
this
.
props
;
Promise
.
all
(
[
perfFront
.
isActive
(
)
perfFront
.
isSupportedPlatform
(
)
perfFront
.
isLockedForPrivateBrowsing
(
)
]
)
.
then
(
results
=
>
{
const
[
isActive
isSupportedPlatform
isLockedForPrivateBrowsing
]
=
results
;
let
recordingState
=
this
.
props
.
recordingState
;
if
(
recordingState
=
=
=
"
not
-
yet
-
known
"
&
&
isSupportedPlatform
)
{
if
(
isLockedForPrivateBrowsing
)
{
recordingState
=
"
locked
-
by
-
private
-
browsing
"
;
}
else
if
(
isActive
)
{
recordingState
=
isPopup
?
"
recording
"
:
"
other
-
is
-
recording
"
;
}
else
{
recordingState
=
"
available
-
to
-
record
"
;
}
}
reportProfilerReady
(
isSupportedPlatform
recordingState
)
;
if
(
window
.
gReportReady
)
{
window
.
gReportReady
(
)
;
}
}
)
;
this
.
props
.
perfFront
.
on
(
"
profiler
-
started
"
this
.
handleProfilerStarting
)
;
this
.
props
.
perfFront
.
on
(
"
profiler
-
stopped
"
this
.
handleProfilerStopping
)
;
this
.
props
.
perfFront
.
on
(
"
profile
-
locked
-
by
-
private
-
browsing
"
this
.
handlePrivateBrowsingStarting
)
;
this
.
props
.
perfFront
.
on
(
"
profile
-
unlocked
-
from
-
private
-
browsing
"
this
.
handlePrivateBrowsingEnding
)
;
}
componentWillUnmount
(
)
{
switch
(
this
.
props
.
recordingState
)
{
case
"
not
-
yet
-
known
"
:
case
"
available
-
to
-
record
"
:
case
"
request
-
to
-
stop
-
profiler
"
:
case
"
request
-
to
-
get
-
profile
-
and
-
stop
-
profiler
"
:
case
"
locked
-
by
-
private
-
browsing
"
:
case
"
other
-
is
-
recording
"
:
break
;
case
"
recording
"
:
case
"
request
-
to
-
start
-
recording
"
:
this
.
props
.
perfFront
.
stopProfilerAndDiscardProfile
(
)
;
break
;
default
:
throw
new
Error
(
"
Unhandled
recording
state
.
"
)
;
}
}
handleProfilerStarting
(
)
{
const
{
changeRecordingState
recordingState
isPopup
}
=
this
.
props
;
switch
(
recordingState
)
{
case
"
not
-
yet
-
known
"
:
case
"
available
-
to
-
record
"
:
case
"
request
-
to
-
stop
-
profiler
"
:
case
"
request
-
to
-
get
-
profile
-
and
-
stop
-
profiler
"
:
if
(
isPopup
)
{
changeRecordingState
(
"
recording
"
)
;
}
else
{
changeRecordingState
(
"
other
-
is
-
recording
"
)
;
}
break
;
case
"
request
-
to
-
start
-
recording
"
:
changeRecordingState
(
"
recording
"
)
;
break
;
case
"
locked
-
by
-
private
-
browsing
"
:
case
"
other
-
is
-
recording
"
:
case
"
recording
"
:
throw
new
Error
(
"
The
profiler
started
recording
when
it
shouldn
'
t
have
"
+
been
able
to
.
Current
state
:
"
{
recordingState
}
"
)
;
default
:
throw
new
Error
(
"
Unhandled
recording
state
"
)
;
}
}
handleProfilerStopping
(
)
{
const
{
changeRecordingState
recordingState
}
=
this
.
props
;
switch
(
recordingState
)
{
case
"
not
-
yet
-
known
"
:
case
"
request
-
to
-
get
-
profile
-
and
-
stop
-
profiler
"
:
case
"
request
-
to
-
stop
-
profiler
"
:
case
"
other
-
is
-
recording
"
:
changeRecordingState
(
"
available
-
to
-
record
"
)
;
break
;
case
"
request
-
to
-
start
-
recording
"
:
case
"
locked
-
by
-
private
-
browsing
"
:
break
;
case
"
recording
"
:
changeRecordingState
(
"
available
-
to
-
record
"
{
didRecordingUnexpectedlyStopped
:
true
}
)
;
break
;
case
"
available
-
to
-
record
"
:
throw
new
Error
(
"
The
profiler
stopped
recording
when
it
shouldn
'
t
have
been
able
to
.
"
)
;
default
:
throw
new
Error
(
"
Unhandled
recording
state
"
)
;
}
}
handlePrivateBrowsingStarting
(
)
{
const
{
recordingState
changeRecordingState
}
=
this
.
props
;
switch
(
recordingState
)
{
case
"
request
-
to
-
get
-
profile
-
and
-
stop
-
profiler
"
:
case
"
request
-
to
-
stop
-
profiler
"
:
case
"
available
-
to
-
record
"
:
case
"
other
-
is
-
recording
"
:
case
"
not
-
yet
-
known
"
:
changeRecordingState
(
"
locked
-
by
-
private
-
browsing
"
)
;
break
;
case
"
request
-
to
-
start
-
recording
"
:
case
"
recording
"
:
changeRecordingState
(
"
locked
-
by
-
private
-
browsing
"
{
didRecordingUnexpectedlyStopped
:
false
}
)
;
break
;
case
"
locked
-
by
-
private
-
browsing
"
:
break
;
default
:
throw
new
Error
(
"
Unhandled
recording
state
"
)
;
}
}
handlePrivateBrowsingEnding
(
)
{
this
.
props
.
changeRecordingState
(
"
available
-
to
-
record
"
)
;
}
render
(
)
{
const
{
isSupportedPlatform
isPopup
}
=
this
.
props
;
if
(
isSupportedPlatform
=
=
=
null
)
{
return
null
;
}
const
additionalClassName
=
isPopup
?
"
perf
-
popup
"
:
"
perf
-
devtools
"
;
return
div
(
{
className
:
perf
{
additionalClassName
}
}
RecordingButton
(
)
Settings
(
)
isPopup
?
null
:
Description
(
)
)
;
}
}
function
mapStateToProps
(
state
)
{
return
{
perfFront
:
selectors
.
getPerfFront
(
state
)
recordingState
:
selectors
.
getRecordingState
(
state
)
isSupportedPlatform
:
selectors
.
getIsSupportedPlatform
(
state
)
isPopup
:
selectors
.
getIsPopup
(
state
)
}
;
}
const
mapDispatchToProps
=
{
changeRecordingState
:
actions
.
changeRecordingState
reportProfilerReady
:
actions
.
reportProfilerReady
}
;
module
.
exports
=
connect
(
mapStateToProps
mapDispatchToProps
)
(
Perf
)
;
