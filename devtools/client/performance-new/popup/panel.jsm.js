"
use
strict
"
;
const
{
createLazyLoaders
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
typescript
-
lazy
-
load
.
jsm
.
js
"
)
;
const
lazy
=
createLazyLoaders
(
{
Services
:
(
)
=
>
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
PanelMultiView
:
(
)
=
>
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
)
Background
:
(
)
=
>
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
popup
/
background
.
jsm
.
js
"
)
}
)
;
function
selectElementsInPanelview
(
panelview
)
{
const
document
=
panelview
.
ownerDocument
;
function
getElementById
(
id
)
{
const
{
PanelMultiView
}
=
lazy
.
PanelMultiView
(
)
;
const
element
=
PanelMultiView
.
getViewNode
(
document
id
)
;
if
(
!
element
)
{
throw
new
Error
(
Could
not
find
the
element
from
the
ID
"
{
id
}
"
)
;
}
return
element
;
}
const
chromeWindowAny
=
document
.
defaultView
;
const
chromeWindow
=
chromeWindowAny
;
return
{
document
panelview
window
:
chromeWindow
inactive
:
getElementById
(
"
PanelUI
-
profiler
-
inactive
"
)
active
:
getElementById
(
"
PanelUI
-
profiler
-
active
"
)
locked
:
getElementById
(
"
PanelUI
-
profiler
-
locked
"
)
presetDescription
:
getElementById
(
"
PanelUI
-
profiler
-
content
-
description
"
)
presetsEditSettings
:
getElementById
(
"
PanelUI
-
profiler
-
content
-
edit
-
settings
"
)
presetsMenuList
:
(
getElementById
(
"
PanelUI
-
profiler
-
presets
"
)
)
header
:
getElementById
(
"
PanelUI
-
profiler
-
header
"
)
info
:
getElementById
(
"
PanelUI
-
profiler
-
info
"
)
menupopup
:
getElementById
(
"
PanelUI
-
profiler
-
presets
-
menupopup
"
)
infoButton
:
getElementById
(
"
PanelUI
-
profiler
-
info
-
button
"
)
learnMore
:
getElementById
(
"
PanelUI
-
profiler
-
learn
-
more
"
)
startRecording
:
getElementById
(
"
PanelUI
-
profiler
-
startRecording
"
)
stopAndDiscard
:
getElementById
(
"
PanelUI
-
profiler
-
stopAndDiscard
"
)
stopAndCapture
:
getElementById
(
"
PanelUI
-
profiler
-
stopAndCapture
"
)
settingsSection
:
getElementById
(
"
PanelUI
-
profiler
-
content
-
settings
"
)
contentRecording
:
getElementById
(
"
PanelUI
-
profiler
-
content
-
recording
"
)
}
;
}
function
createViewControllers
(
state
elements
)
{
return
{
updateInfoCollapse
(
)
{
const
{
header
info
infoButton
panelview
}
=
elements
;
header
.
setAttribute
(
"
isinfocollapsed
"
state
.
isInfoCollapsed
?
"
true
"
:
"
false
"
)
;
panelview
.
closest
(
"
panel
"
)
.
setAttribute
(
"
isinfoexpanded
"
state
.
isInfoCollapsed
?
"
false
"
:
"
true
"
)
;
infoButton
.
checked
=
!
state
.
isInfoCollapsed
;
if
(
state
.
isInfoCollapsed
)
{
const
{
height
}
=
info
.
getBoundingClientRect
(
)
;
info
.
style
.
marginBlockEnd
=
-
{
height
}
px
;
}
else
{
info
.
style
.
marginBlockEnd
=
"
0
"
;
}
}
updatePresets
(
)
{
const
{
Services
}
=
lazy
.
Services
(
)
;
const
{
presets
getRecordingSettings
}
=
lazy
.
Background
(
)
;
const
{
presetName
}
=
getRecordingSettings
(
"
aboutprofiling
"
Services
.
profiler
.
GetFeatures
(
)
)
;
const
preset
=
presets
[
presetName
]
;
if
(
preset
)
{
elements
.
presetDescription
.
style
.
display
=
"
block
"
;
elements
.
document
.
l10n
.
setAttributes
(
elements
.
presetDescription
preset
.
l10nIds
.
popup
.
description
)
;
elements
.
presetsMenuList
.
value
=
presetName
;
const
{
height
}
=
elements
.
presetDescription
.
getBoundingClientRect
(
)
;
elements
.
presetDescription
.
style
.
height
=
{
height
}
px
;
}
else
{
elements
.
presetDescription
.
style
.
display
=
"
none
"
;
elements
.
presetsMenuList
.
value
=
"
custom
"
;
}
const
{
PanelMultiView
}
=
lazy
.
PanelMultiView
(
)
;
PanelMultiView
.
forNode
(
elements
.
panelview
)
.
descriptionHeightWorkaround
(
)
;
}
updateProfilerState
(
)
{
const
{
Services
}
=
lazy
.
Services
(
)
;
let
profilerState
=
Services
.
profiler
.
IsActive
(
)
?
"
active
"
:
"
inactive
"
;
if
(
!
Services
.
profiler
.
CanProfile
(
)
)
{
profilerState
=
"
locked
"
;
}
switch
(
profilerState
)
{
case
"
active
"
:
elements
.
inactive
.
hidden
=
true
;
elements
.
active
.
hidden
=
false
;
elements
.
settingsSection
.
hidden
=
true
;
elements
.
contentRecording
.
hidden
=
false
;
elements
.
locked
.
hidden
=
true
;
break
;
case
"
inactive
"
:
elements
.
inactive
.
hidden
=
false
;
elements
.
active
.
hidden
=
true
;
elements
.
settingsSection
.
hidden
=
false
;
elements
.
contentRecording
.
hidden
=
true
;
elements
.
locked
.
hidden
=
true
;
break
;
case
"
locked
"
:
{
elements
.
inactive
.
hidden
=
true
;
elements
.
active
.
hidden
=
true
;
elements
.
settingsSection
.
hidden
=
true
;
elements
.
contentRecording
.
hidden
=
true
;
elements
.
locked
.
hidden
=
false
;
const
{
height
}
=
elements
.
locked
.
getBoundingClientRect
(
)
;
elements
.
locked
.
style
.
height
=
{
height
}
px
;
break
;
}
default
:
throw
new
Error
(
"
Unhandled
profiler
state
.
"
)
;
}
}
createPresetsList
(
)
{
if
(
elements
.
menupopup
.
getAttribute
(
"
presetsbuilt
"
)
=
=
=
"
true
"
)
{
return
;
}
const
{
Services
}
=
lazy
.
Services
(
)
;
const
{
presets
}
=
lazy
.
Background
(
)
;
const
currentPreset
=
Services
.
prefs
.
getCharPref
(
"
devtools
.
performance
.
recording
.
preset
"
)
;
const
menuitems
=
Object
.
entries
(
presets
)
.
map
(
(
[
id
preset
]
)
=
>
{
const
{
document
presetsMenuList
}
=
elements
;
const
menuitem
=
document
.
createXULElement
(
"
menuitem
"
)
;
document
.
l10n
.
setAttributes
(
menuitem
preset
.
l10nIds
.
popup
.
label
)
;
menuitem
.
setAttribute
(
"
value
"
id
)
;
if
(
id
=
=
=
currentPreset
)
{
presetsMenuList
.
setAttribute
(
"
value
"
id
)
;
}
return
menuitem
;
}
)
;
elements
.
menupopup
.
prepend
(
.
.
.
menuitems
)
;
elements
.
menupopup
.
setAttribute
(
"
presetsbuilt
"
"
true
"
)
;
}
hidePopup
(
)
{
const
panel
=
elements
.
panelview
.
closest
(
"
panel
"
)
;
if
(
!
panel
)
{
throw
new
Error
(
"
Could
not
find
the
panel
from
the
panelview
.
"
)
;
}
panel
.
removeAttribute
(
"
isinfoexpanded
"
)
;
(
panel
)
.
hidePopup
(
)
;
}
}
;
}
function
initializeView
(
state
elements
view
)
{
view
.
createPresetsList
(
)
;
state
.
cleanup
.
push
(
(
)
=
>
{
state
.
isInfoCollapsed
=
true
;
view
.
updateInfoCollapse
(
)
;
}
)
;
elements
.
header
.
setAttribute
(
"
animationready
"
"
false
"
)
;
elements
.
window
.
requestAnimationFrame
(
(
)
=
>
{
view
.
updateInfoCollapse
(
)
;
view
.
updateProfilerState
(
)
;
view
.
updatePresets
(
)
;
const
{
PanelMultiView
}
=
lazy
.
PanelMultiView
(
)
;
PanelMultiView
.
forNode
(
elements
.
panelview
)
.
descriptionHeightWorkaround
(
)
;
elements
.
window
.
requestAnimationFrame
(
(
)
=
>
{
elements
.
header
.
setAttribute
(
"
animationready
"
"
true
"
)
;
}
)
;
}
)
;
}
function
addPopupEventHandlers
(
state
elements
view
)
{
const
{
changePreset
startProfiler
stopProfiler
captureProfile
}
=
lazy
.
Background
(
)
;
function
addHandler
(
element
type
handler
)
{
element
.
addEventListener
(
type
handler
)
;
state
.
cleanup
.
push
(
(
)
=
>
{
element
.
removeEventListener
(
type
handler
)
;
}
)
;
}
addHandler
(
elements
.
infoButton
"
click
"
event
=
>
{
event
.
preventDefault
(
)
;
state
.
isInfoCollapsed
=
!
state
.
isInfoCollapsed
;
view
.
updateInfoCollapse
(
)
;
}
)
;
addHandler
(
elements
.
startRecording
"
click
"
(
)
=
>
{
startProfiler
(
"
aboutprofiling
"
)
;
}
)
;
addHandler
(
elements
.
stopAndDiscard
"
click
"
(
)
=
>
{
stopProfiler
(
)
;
}
)
;
addHandler
(
elements
.
stopAndCapture
"
click
"
(
)
=
>
{
captureProfile
(
"
aboutprofiling
"
)
;
view
.
hidePopup
(
)
;
}
)
;
addHandler
(
elements
.
learnMore
"
click
"
(
)
=
>
{
elements
.
window
.
openWebLinkIn
(
"
https
:
/
/
profiler
.
firefox
.
com
/
docs
/
"
"
tab
"
)
;
view
.
hidePopup
(
)
;
}
)
;
addHandler
(
elements
.
presetsMenuList
"
command
"
(
)
=
>
{
changePreset
(
"
aboutprofiling
"
elements
.
presetsMenuList
.
value
Services
.
profiler
.
GetFeatures
(
)
)
;
view
.
updatePresets
(
)
;
}
)
;
addHandler
(
elements
.
presetsMenuList
"
popuphidden
"
event
=
>
{
event
.
stopPropagation
(
)
;
}
)
;
addHandler
(
elements
.
presetsMenuList
"
click
"
event
=
>
{
event
.
preventDefault
(
)
;
}
)
;
addHandler
(
elements
.
presetsEditSettings
"
click
"
(
)
=
>
{
elements
.
window
.
openTrustedLinkIn
(
"
about
:
profiling
"
"
tab
"
)
;
view
.
hidePopup
(
)
;
}
)
;
const
{
Services
}
=
lazy
.
Services
(
)
;
const
events
=
[
"
profiler
-
started
"
"
profiler
-
stopped
"
"
chrome
-
document
-
global
-
created
"
"
last
-
pb
-
context
-
exited
"
]
;
for
(
const
event
of
events
)
{
Services
.
obs
.
addObserver
(
view
.
updateProfilerState
event
)
;
state
.
cleanup
.
push
(
(
)
=
>
{
Services
.
obs
.
removeObserver
(
view
.
updateProfilerState
event
)
;
}
)
;
}
}
function
initializePopup
(
panelState
panelview
)
{
const
panelElements
=
selectElementsInPanelview
(
panelview
)
;
const
panelviewControllers
=
createViewControllers
(
panelState
panelElements
)
;
addPopupEventHandlers
(
panelState
panelElements
panelviewControllers
)
;
initializeView
(
panelState
panelElements
panelviewControllers
)
;
}
(
this
)
.
module
=
{
}
;
module
.
exports
=
{
initializePopup
}
;
var
EXPORTED_SYMBOLS
=
Object
.
keys
(
module
.
exports
)
;
