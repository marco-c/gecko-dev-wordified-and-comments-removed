"
use
strict
"
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
createLazyLoaders
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
typescript
-
lazy
-
load
.
jsm
.
js
"
)
;
const
AppConstants
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
.
AppConstants
;
const
ENTRIES_PREF
=
"
devtools
.
performance
.
recording
.
entries
"
;
const
INTERVAL_PREF
=
"
devtools
.
performance
.
recording
.
interval
"
;
const
FEATURES_PREF
=
"
devtools
.
performance
.
recording
.
features
"
;
const
THREADS_PREF
=
"
devtools
.
performance
.
recording
.
threads
"
;
const
OBJDIRS_PREF
=
"
devtools
.
performance
.
recording
.
objdirs
"
;
const
DURATION_PREF
=
"
devtools
.
performance
.
recording
.
duration
"
;
const
PRESET_PREF
=
"
devtools
.
performance
.
recording
.
preset
"
;
const
POPUP_FEATURE_FLAG_PREF
=
"
devtools
.
performance
.
popup
.
feature
-
flag
"
;
const
PREF_PREFIX
=
"
devtools
.
performance
.
recording
.
"
;
const
CURRENT_WEBCHANNEL_VERSION
=
1
;
ChromeUtils
.
defineModuleGetter
(
this
"
require
"
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
const
lazy
=
createLazyLoaders
(
{
OS
:
(
)
=
>
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
)
Utils
:
(
)
=
>
require
(
"
devtools
/
client
/
performance
-
new
/
utils
"
)
BrowserModule
:
(
)
=
>
require
(
"
devtools
/
client
/
performance
-
new
/
browser
"
)
RecordingUtils
:
(
)
=
>
require
(
"
devtools
/
shared
/
performance
-
new
/
recording
-
utils
"
)
CustomizableUI
:
(
)
=
>
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
CustomizableUI
.
jsm
"
)
PerfSymbolication
:
(
)
=
>
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
symbolication
.
jsm
.
js
"
)
ProfilerMenuButton
:
(
)
=
>
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
popup
/
menu
-
button
.
jsm
.
js
"
)
}
)
;
const
presets
=
{
"
web
-
developer
"
:
{
entries
:
128
*
1024
*
1024
interval
:
1
features
:
[
"
screenshots
"
"
js
"
"
cpu
"
]
threads
:
[
"
GeckoMain
"
"
Compositor
"
"
Renderer
"
"
DOM
Worker
"
]
duration
:
0
profilerViewMode
:
"
active
-
tab
"
l10nIds
:
{
popup
:
{
label
:
"
profiler
-
popup
-
presets
-
web
-
developer
-
label
"
description
:
"
profiler
-
popup
-
presets
-
web
-
developer
-
description
"
}
devtools
:
{
label
:
"
perftools
-
presets
-
web
-
developer
-
label
"
description
:
"
perftools
-
presets
-
web
-
developer
-
description
"
}
}
}
"
firefox
-
platform
"
:
{
entries
:
128
*
1024
*
1024
interval
:
1
features
:
[
"
screenshots
"
"
js
"
"
leaf
"
"
stackwalk
"
"
cpu
"
"
java
"
]
threads
:
[
"
GeckoMain
"
"
Compositor
"
"
Renderer
"
"
SwComposite
"
"
DOM
Worker
"
]
duration
:
0
l10nIds
:
{
popup
:
{
label
:
"
profiler
-
popup
-
presets
-
firefox
-
label
"
description
:
"
profiler
-
popup
-
presets
-
firefox
-
description
"
}
devtools
:
{
label
:
"
perftools
-
presets
-
firefox
-
label
"
description
:
"
perftools
-
presets
-
firefox
-
description
"
}
}
}
graphics
:
{
entries
:
128
*
1024
*
1024
interval
:
1
features
:
[
"
leaf
"
"
stackwalk
"
"
js
"
"
cpu
"
"
java
"
]
threads
:
[
"
GeckoMain
"
"
Compositor
"
"
Renderer
"
"
SwComposite
"
"
RenderBackend
"
"
SceneBuilder
"
"
WrWorker
"
"
CanvasWorkers
"
]
duration
:
0
l10nIds
:
{
popup
:
{
label
:
"
profiler
-
popup
-
presets
-
graphics
-
label
"
description
:
"
profiler
-
popup
-
presets
-
graphics
-
description
"
}
devtools
:
{
label
:
"
perftools
-
presets
-
graphics
-
label
"
description
:
"
perftools
-
presets
-
graphics
-
description
"
}
}
}
media
:
{
entries
:
128
*
1024
*
1024
interval
:
1
features
:
[
"
js
"
"
leaf
"
"
stackwalk
"
"
cpu
"
"
audiocallbacktracing
"
]
threads
:
[
"
AsyncCubebTask
"
"
AudioEncoderQueue
"
"
AudioIPC
"
"
call_worker_queue
"
"
Compositor
"
"
DecodingThread
"
"
GeckoMain
"
"
GraphRunner
"
"
IncomingVideoStream
"
"
InotifyEventThread
"
"
libwebrtcModuleThread
"
"
MediaDecoderStateMachine
"
"
MediaPDecoder
"
"
MediaSupervisor
"
"
MediaTimer
"
"
ModuleProcessThread
"
"
NativeAudioCallback
"
"
PacerThread
"
"
RemVidChild
"
"
RenderBackend
"
"
Renderer
"
"
Socket
Thread
"
"
SwComposite
"
"
VoiceProcessThread
"
"
WebrtcWorker
"
]
duration
:
0
l10nIds
:
{
popup
:
{
label
:
"
profiler
-
popup
-
presets
-
media
-
label
"
description
:
"
profiler
-
popup
-
presets
-
media
-
description2
"
}
devtools
:
{
label
:
"
perftools
-
presets
-
media
-
label
"
description
:
"
perftools
-
presets
-
media
-
description2
"
}
}
}
networking
:
{
entries
:
128
*
1024
*
1024
interval
:
1
features
:
[
"
screenshots
"
"
js
"
"
leaf
"
"
stackwalk
"
"
cpu
"
"
java
"
]
threads
:
[
"
Compositor
"
"
DNS
Resolver
"
"
DOM
Worker
"
"
GeckoMain
"
"
Renderer
"
"
Socket
Thread
"
"
StreamTrans
"
"
SwComposite
"
"
TRR
Background
"
]
duration
:
0
l10nIds
:
{
popup
:
{
label
:
"
profiler
-
popup
-
presets
-
networking
-
label
"
description
:
"
profiler
-
popup
-
presets
-
networking
-
description
"
}
devtools
:
{
label
:
"
perftools
-
presets
-
networking
-
label
"
description
:
"
perftools
-
presets
-
networking
-
description
"
}
}
}
}
;
function
getProfilerViewModeForCurrentPreset
(
pageContext
)
{
const
prefPostfix
=
getPrefPostfix
(
pageContext
)
;
const
presetName
=
Services
.
prefs
.
getCharPref
(
PRESET_PREF
+
prefPostfix
)
;
if
(
presetName
=
=
=
"
custom
"
)
{
return
undefined
;
}
const
preset
=
presets
[
presetName
]
;
if
(
!
preset
)
{
console
.
error
(
Unknown
profiler
preset
was
encountered
:
"
{
presetName
}
"
)
;
return
undefined
;
}
return
preset
.
profilerViewMode
;
}
async
function
captureProfile
(
pageContext
)
{
if
(
!
Services
.
profiler
.
IsActive
(
)
)
{
return
;
}
if
(
Services
.
profiler
.
IsPaused
(
)
)
{
return
;
}
Services
.
profiler
.
Pause
(
)
;
const
profileCaptureResult
=
await
Services
.
profiler
.
getProfileDataAsGzippedArrayBuffer
(
)
.
then
(
profile
=
>
(
{
type
:
"
SUCCESS
"
profile
}
)
error
=
>
{
console
.
error
(
error
)
;
return
{
type
:
"
ERROR
"
error
}
;
}
)
;
const
profilerViewMode
=
getProfilerViewModeForCurrentPreset
(
pageContext
)
;
const
sharedLibraries
=
Services
.
profiler
.
sharedLibraries
;
const
objdirs
=
getObjdirPrefValue
(
)
;
const
{
createLocalSymbolicationService
}
=
lazy
.
PerfSymbolication
(
)
;
const
symbolicationService
=
createLocalSymbolicationService
(
sharedLibraries
objdirs
)
;
const
{
openProfilerTab
}
=
lazy
.
BrowserModule
(
)
;
const
browser
=
openProfilerTab
(
profilerViewMode
)
;
registerProfileCaptureForBrowser
(
browser
profileCaptureResult
symbolicationService
)
;
Services
.
profiler
.
StopProfiler
(
)
;
}
function
startProfiler
(
pageContext
)
{
const
{
entries
interval
features
threads
duration
}
=
getRecordingSettings
(
pageContext
Services
.
profiler
.
GetFeatures
(
)
)
;
const
{
getActiveBrowserID
}
=
lazy
.
RecordingUtils
(
)
;
const
activeTabID
=
getActiveBrowserID
(
)
;
Services
.
profiler
.
StartProfiler
(
entries
interval
features
threads
activeTabID
duration
)
;
}
function
stopProfiler
(
)
{
Services
.
profiler
.
StopProfiler
(
)
;
}
function
toggleProfiler
(
pageContext
)
{
if
(
Services
.
profiler
.
IsPaused
(
)
)
{
return
;
}
if
(
Services
.
profiler
.
IsActive
(
)
)
{
stopProfiler
(
)
;
}
else
{
startProfiler
(
pageContext
)
;
}
}
function
restartProfiler
(
pageContext
)
{
stopProfiler
(
)
;
startProfiler
(
pageContext
)
;
}
function
_getArrayOfStringsPref
(
prefName
)
{
const
text
=
Services
.
prefs
.
getCharPref
(
prefName
)
;
return
JSON
.
parse
(
text
)
;
}
function
getPrefPostfix
(
pageContext
)
{
switch
(
pageContext
)
{
case
"
devtools
"
:
case
"
aboutprofiling
"
:
return
"
"
;
case
"
devtools
-
remote
"
:
case
"
aboutprofiling
-
remote
"
:
return
"
.
remote
"
;
default
:
{
const
{
UnhandledCaseError
}
=
lazy
.
Utils
(
)
;
throw
new
UnhandledCaseError
(
pageContext
"
Page
Context
"
)
;
}
}
}
function
setObjdirPrefValue
(
objdirs
)
{
Services
.
prefs
.
setCharPref
(
OBJDIRS_PREF
JSON
.
stringify
(
objdirs
)
)
;
}
function
migrateObjdirsPrefsIfNeeded
(
)
{
const
OLD_REMOTE_OBJDIRS_PREF
=
OBJDIRS_PREF
+
"
.
remote
"
;
const
remoteString
=
Services
.
prefs
.
getCharPref
(
OLD_REMOTE_OBJDIRS_PREF
"
"
)
;
if
(
remoteString
=
=
=
"
"
)
{
return
;
}
const
remoteList
=
JSON
.
parse
(
remoteString
)
;
const
localList
=
_getArrayOfStringsPref
(
OBJDIRS_PREF
)
;
const
mergedList
=
[
.
.
.
new
Set
(
localList
.
concat
(
remoteList
)
)
]
;
setObjdirPrefValue
(
mergedList
)
;
Services
.
prefs
.
clearUserPref
(
OLD_REMOTE_OBJDIRS_PREF
)
;
}
function
getObjdirPrefValue
(
)
{
migrateObjdirsPrefsIfNeeded
(
)
;
return
_getArrayOfStringsPref
(
OBJDIRS_PREF
)
;
}
function
getRecordingSettings
(
pageContext
supportedFeatures
)
{
const
objdirs
=
getObjdirPrefValue
(
)
;
const
prefPostfix
=
getPrefPostfix
(
pageContext
)
;
const
presetName
=
Services
.
prefs
.
getCharPref
(
PRESET_PREF
+
prefPostfix
)
;
return
(
getRecordingSettingsFromPreset
(
presetName
supportedFeatures
objdirs
)
?
?
getRecordingSettingsFromPrefs
(
supportedFeatures
objdirs
prefPostfix
)
)
;
}
function
getRecordingSettingsFromPreset
(
presetName
supportedFeatures
objdirs
)
{
if
(
presetName
=
=
=
"
custom
"
)
{
return
null
;
}
const
preset
=
presets
[
presetName
]
;
if
(
!
preset
)
{
console
.
error
(
Unknown
profiler
preset
was
encountered
:
"
{
presetName
}
"
)
;
return
null
;
}
return
{
presetName
entries
:
preset
.
entries
interval
:
preset
.
interval
features
:
preset
.
features
.
filter
(
feature
=
>
supportedFeatures
.
includes
(
feature
)
)
threads
:
preset
.
threads
objdirs
duration
:
preset
.
duration
}
;
}
function
getRecordingSettingsFromPrefs
(
supportedFeatures
objdirs
prefPostfix
)
{
const
entries
=
Services
.
prefs
.
getIntPref
(
ENTRIES_PREF
+
prefPostfix
)
;
const
intervalInMicroseconds
=
Services
.
prefs
.
getIntPref
(
INTERVAL_PREF
+
prefPostfix
)
;
const
interval
=
intervalInMicroseconds
/
1000
;
const
features
=
_getArrayOfStringsPref
(
FEATURES_PREF
+
prefPostfix
)
;
const
threads
=
_getArrayOfStringsPref
(
THREADS_PREF
+
prefPostfix
)
;
const
duration
=
Services
.
prefs
.
getIntPref
(
DURATION_PREF
+
prefPostfix
)
;
return
{
presetName
:
"
custom
"
entries
interval
features
:
features
.
filter
(
feature
=
>
supportedFeatures
.
includes
(
feature
)
)
threads
objdirs
duration
}
;
}
function
setRecordingSettings
(
pageContext
prefs
)
{
const
prefPostfix
=
getPrefPostfix
(
pageContext
)
;
Services
.
prefs
.
setCharPref
(
PRESET_PREF
+
prefPostfix
prefs
.
presetName
)
;
Services
.
prefs
.
setIntPref
(
ENTRIES_PREF
+
prefPostfix
prefs
.
entries
)
;
const
intervalInMicroseconds
=
prefs
.
interval
*
1000
;
Services
.
prefs
.
setIntPref
(
INTERVAL_PREF
+
prefPostfix
intervalInMicroseconds
)
;
Services
.
prefs
.
setCharPref
(
FEATURES_PREF
+
prefPostfix
JSON
.
stringify
(
prefs
.
features
)
)
;
Services
.
prefs
.
setCharPref
(
THREADS_PREF
+
prefPostfix
JSON
.
stringify
(
prefs
.
threads
)
)
;
setObjdirPrefValue
(
prefs
.
objdirs
)
;
}
const
platform
=
AppConstants
.
platform
;
function
revertRecordingSettings
(
)
{
for
(
const
prefPostfix
of
[
"
"
"
.
remote
"
]
)
{
Services
.
prefs
.
clearUserPref
(
PRESET_PREF
+
prefPostfix
)
;
Services
.
prefs
.
clearUserPref
(
ENTRIES_PREF
+
prefPostfix
)
;
Services
.
prefs
.
clearUserPref
(
INTERVAL_PREF
+
prefPostfix
)
;
Services
.
prefs
.
clearUserPref
(
FEATURES_PREF
+
prefPostfix
)
;
Services
.
prefs
.
clearUserPref
(
THREADS_PREF
+
prefPostfix
)
;
Services
.
prefs
.
clearUserPref
(
DURATION_PREF
+
prefPostfix
)
;
}
Services
.
prefs
.
clearUserPref
(
OBJDIRS_PREF
)
;
Services
.
prefs
.
clearUserPref
(
POPUP_FEATURE_FLAG_PREF
)
;
}
function
changePreset
(
pageContext
presetName
supportedFeatures
)
{
const
prefPostfix
=
getPrefPostfix
(
pageContext
)
;
const
objdirs
=
getObjdirPrefValue
(
)
;
let
recordingSettings
=
getRecordingSettingsFromPreset
(
presetName
supportedFeatures
objdirs
)
;
if
(
!
recordingSettings
)
{
Services
.
prefs
.
setCharPref
(
PRESET_PREF
+
prefPostfix
presetName
)
;
recordingSettings
=
getRecordingSettings
(
pageContext
supportedFeatures
)
;
}
setRecordingSettings
(
pageContext
recordingSettings
)
;
}
function
addPrefObserver
(
observer
)
{
Services
.
prefs
.
addObserver
(
PREF_PREFIX
observer
)
;
}
function
removePrefObserver
(
observer
)
{
Services
.
prefs
.
removeObserver
(
PREF_PREFIX
observer
)
;
}
const
infoForBrowserMap
=
new
WeakMap
(
)
;
async
function
getResponseForMessage
(
request
browser
)
{
switch
(
request
.
type
)
{
case
"
STATUS_QUERY
"
:
{
const
{
ProfilerMenuButton
}
=
lazy
.
ProfilerMenuButton
(
)
;
return
{
version
:
CURRENT_WEBCHANNEL_VERSION
menuButtonIsEnabled
:
ProfilerMenuButton
.
isInNavbar
(
)
}
;
}
case
"
ENABLE_MENU_BUTTON
"
:
{
const
{
ownerDocument
}
=
browser
;
if
(
!
ownerDocument
)
{
throw
new
Error
(
"
Could
not
find
the
owner
document
for
the
current
browser
while
enabling
"
+
"
the
profiler
menu
button
"
)
;
}
Services
.
prefs
.
setBoolPref
(
POPUP_FEATURE_FLAG_PREF
true
)
;
const
supportedFeatures
=
Services
.
profiler
.
GetFeatures
(
)
;
changePreset
(
"
aboutprofiling
"
"
firefox
-
platform
"
supportedFeatures
)
;
const
{
ProfilerMenuButton
}
=
lazy
.
ProfilerMenuButton
(
)
;
ProfilerMenuButton
.
addToNavbar
(
ownerDocument
)
;
const
{
CustomizableUI
}
=
lazy
.
CustomizableUI
(
)
;
CustomizableUI
.
dispatchToolboxEvent
(
"
customizationchange
"
)
;
ProfilerMenuButton
.
openPopup
(
ownerDocument
)
;
return
undefined
;
}
case
"
GET_PROFILE
"
:
{
const
infoForBrowser
=
infoForBrowserMap
.
get
(
browser
)
;
if
(
infoForBrowser
=
=
=
undefined
)
{
throw
new
Error
(
"
Could
not
find
a
profile
for
this
tab
.
"
)
;
}
const
{
profileCaptureResult
}
=
infoForBrowser
;
switch
(
profileCaptureResult
.
type
)
{
case
"
SUCCESS
"
:
return
profileCaptureResult
.
profile
;
case
"
ERROR
"
:
throw
profileCaptureResult
.
error
;
default
:
const
{
UnhandledCaseError
}
=
lazy
.
Utils
(
)
;
throw
new
UnhandledCaseError
(
profileCaptureResult
"
profileCaptureResult
"
)
;
}
}
case
"
GET_SYMBOL_TABLE
"
:
{
const
{
debugName
breakpadId
}
=
request
;
const
symbolicationService
=
getSymbolicationServiceForBrowser
(
browser
)
;
return
symbolicationService
.
getSymbolTable
(
debugName
breakpadId
)
;
}
case
"
QUERY_SYMBOLICATION_API
"
:
{
const
{
path
requestJson
}
=
request
;
const
symbolicationService
=
getSymbolicationServiceForBrowser
(
browser
)
;
return
symbolicationService
.
querySymbolicationApi
(
path
requestJson
)
;
}
default
:
console
.
error
(
"
An
unknown
message
type
was
received
by
the
profiler
'
s
WebChannel
handler
.
"
request
)
;
const
{
UnhandledCaseError
}
=
lazy
.
Utils
(
)
;
throw
new
UnhandledCaseError
(
request
"
WebChannel
request
"
)
;
}
}
function
getSymbolicationServiceForBrowser
(
browser
)
{
const
infoForBrowser
=
infoForBrowserMap
.
get
(
browser
)
;
if
(
infoForBrowser
!
=
=
undefined
)
{
return
infoForBrowser
.
symbolicationService
;
}
const
{
createLocalSymbolicationService
}
=
lazy
.
PerfSymbolication
(
)
;
return
createLocalSymbolicationService
(
Services
.
profiler
.
sharedLibraries
getObjdirPrefValue
(
)
)
;
}
async
function
handleWebChannelMessage
(
channel
id
message
target
)
{
if
(
typeof
message
!
=
=
"
object
"
|
|
typeof
message
.
type
!
=
=
"
string
"
)
{
console
.
error
(
"
An
malformed
message
was
received
by
the
profiler
'
s
WebChannel
handler
.
"
message
)
;
return
;
}
const
messageFromFrontend
=
(
message
)
;
const
{
requestId
}
=
messageFromFrontend
;
try
{
const
response
=
await
getResponseForMessage
(
messageFromFrontend
target
.
browser
)
;
channel
.
send
(
{
type
:
"
SUCCESS_RESPONSE
"
requestId
response
}
target
)
;
}
catch
(
error
)
{
channel
.
send
(
{
type
:
"
ERROR_RESPONSE
"
requestId
error
:
{
error
.
name
}
:
{
error
.
message
}
}
target
)
;
}
}
function
registerProfileCaptureForBrowser
(
browser
profileCaptureResult
symbolicationService
)
{
infoForBrowserMap
.
set
(
browser
{
profileCaptureResult
symbolicationService
}
)
;
}
(
this
)
.
module
=
{
exports
:
{
}
}
;
module
.
exports
=
{
presets
captureProfile
startProfiler
stopProfiler
restartProfiler
toggleProfiler
platform
getRecordingSettings
setRecordingSettings
revertRecordingSettings
changePreset
handleWebChannelMessage
registerProfileCaptureForBrowser
addPrefObserver
removePrefObserver
getProfilerViewModeForCurrentPreset
}
;
var
EXPORTED_SYMBOLS
=
Object
.
keys
(
module
.
exports
)
;
