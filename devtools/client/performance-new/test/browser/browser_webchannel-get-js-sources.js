"
use
strict
"
;
const
FRONTEND_URL
=
"
https
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
performance
-
new
/
test
/
browser
/
webchannel
-
js
-
sources
.
html
"
;
add_task
(
async
function
test_webchannel_get_js_sources
(
)
{
info
(
"
Test
the
WebChannel
GET_JS_SOURCES
request
functionality
"
)
;
const
mockJSSources
=
{
"
uuid
-
12345
-
1
"
:
"
function
testFunction
(
)
{
return
42
;
}
"
"
uuid
-
12345
-
2
"
:
"
console
.
log
(
'
Hello
from
source
2
'
)
;
"
"
uuid
-
67890
-
5
"
:
"
function
anotherFunction
(
)
{
return
'
test
'
;
}
"
"
uuid
-
67890
-
6
"
:
"
alert
(
'
Hello
world
'
)
;
"
}
;
const
sourcesToRequest
=
[
"
uuid
-
12345
-
1
"
"
uuid
-
12345
-
2
"
"
uuid
-
67890
-
5
"
]
;
const
expectedResponse
=
[
{
sourceText
:
"
function
testFunction
(
)
{
return
42
;
}
"
}
{
sourceText
:
"
console
.
log
(
'
Hello
from
source
2
'
)
;
"
}
{
sourceText
:
"
function
anotherFunction
(
)
{
return
'
test
'
;
}
"
}
]
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
async
browser
=
>
{
BackgroundJSM
.
registerProfileCaptureForBrowser
(
browser
Promise
.
resolve
(
new
ArrayBuffer
(
0
)
)
null
mockJSSources
)
;
const
url
=
FRONTEND_URL
+
"
?
testType
=
basic
"
+
"
&
sourceUuids
=
"
+
encodeURIComponent
(
JSON
.
stringify
(
sourcesToRequest
)
)
+
"
&
expectedResponse
=
"
+
encodeURIComponent
(
JSON
.
stringify
(
expectedResponse
)
)
;
const
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
BrowserTestUtils
.
startLoadingURIString
(
browser
url
)
;
await
loaded
;
await
waitForTabTitle
(
"
JS
sources
received
"
)
;
ok
(
true
"
The
JS
sources
are
successfully
retrieved
by
the
WebChannel
.
"
)
;
}
)
;
}
)
;
add_task
(
async
function
test_webchannel_get_js_sources_nonexistent
(
)
{
info
(
"
Test
GET_JS_SOURCES
WebChannel
request
with
non
-
existent
sources
"
)
;
const
mockJSSources
=
{
"
uuid
-
12345
-
1
"
:
"
function
testFunction
(
)
{
return
42
;
}
"
}
;
const
sourcesToRequest
=
[
"
uuid
-
12345
-
999
"
"
uuid
-
99999
-
1
"
]
;
const
expectedResponse
=
[
{
error
:
"
Source
not
found
in
the
browser
"
}
{
error
:
"
Source
not
found
in
the
browser
"
}
]
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
async
browser
=
>
{
BackgroundJSM
.
registerProfileCaptureForBrowser
(
browser
Promise
.
resolve
(
new
ArrayBuffer
(
0
)
)
null
mockJSSources
)
;
const
url
=
FRONTEND_URL
+
"
?
testType
=
nonexistent
"
+
"
&
sourceUuids
=
"
+
encodeURIComponent
(
JSON
.
stringify
(
sourcesToRequest
)
)
+
"
&
expectedResponse
=
"
+
encodeURIComponent
(
JSON
.
stringify
(
expectedResponse
)
)
;
const
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
BrowserTestUtils
.
startLoadingURIString
(
browser
url
)
;
await
loaded
;
await
waitForTabTitle
(
"
JS
sources
received
"
)
;
ok
(
true
"
Successfully
verified
GET_JS_SOURCES
with
non
-
existent
sources
"
)
;
}
)
;
}
)
;
add_task
(
async
function
test_webchannel_get_js_sources_no_data
(
)
{
info
(
"
Test
GET_JS_SOURCES
WebChannel
request
when
no
data
is
registered
"
)
;
const
sourcesToRequest
=
[
"
uuid
-
12345
-
1
"
]
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
async
browser
=
>
{
const
url
=
FRONTEND_URL
+
"
?
testType
=
no
-
data
"
+
"
&
sourceUuids
=
"
+
encodeURIComponent
(
JSON
.
stringify
(
sourcesToRequest
)
)
+
"
&
expectError
=
true
"
;
const
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
BrowserTestUtils
.
startLoadingURIString
(
browser
url
)
;
await
loaded
;
await
waitForTabTitle
(
"
JS
sources
received
"
)
;
ok
(
true
"
Successfully
verified
GET_JS_SOURCES
error
handling
"
)
;
}
)
;
}
)
;
add_task
(
async
function
test_webchannel_get_js_sources_invalid_request
(
)
{
info
(
"
Test
GET_JS_SOURCES
WebChannel
request
with
invalid
sources
parameter
"
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
async
browser
=
>
{
const
url
=
FRONTEND_URL
+
"
?
testType
=
invalid
-
request
"
+
"
&
sourceUuids
=
invalid_not_array
"
+
"
&
expectError
=
true
"
;
const
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
BrowserTestUtils
.
startLoadingURIString
(
browser
url
)
;
await
loaded
;
await
waitForTabTitle
(
"
JS
sources
received
"
)
;
ok
(
true
"
Successfully
verified
GET_JS_SOURCES
invalid
request
handling
"
)
;
}
)
;
}
)
;
