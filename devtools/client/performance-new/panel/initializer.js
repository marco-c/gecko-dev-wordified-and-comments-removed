"
use
strict
"
;
{
const
{
BrowserLoader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
browser
-
loader
.
sys
.
mjs
"
)
;
const
browserLoader
=
BrowserLoader
(
{
baseURI
:
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
"
window
}
)
;
const
scope
=
this
;
scope
.
require
=
browserLoader
.
require
;
scope
.
loader
=
browserLoader
.
loader
;
}
const
ReactDOM
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
vendor
/
react
-
dom
.
mjs
"
)
;
const
React
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
vendor
/
react
.
mjs
"
)
;
const
FluentReact
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
vendor
/
fluent
-
react
.
js
"
)
;
const
{
FluentL10n
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
fluent
-
l10n
/
fluent
-
l10n
.
js
"
)
;
const
Provider
=
React
.
createFactory
(
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
vendor
/
react
-
redux
.
js
"
)
.
Provider
)
;
const
LocalizationProvider
=
React
.
createFactory
(
FluentReact
.
LocalizationProvider
)
;
const
DevToolsPanel
=
React
.
createFactory
(
require
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
components
/
panel
/
DevToolsPanel
.
js
"
)
)
;
const
ProfilerEventHandling
=
React
.
createFactory
(
require
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
components
/
panel
/
ProfilerEventHandling
.
js
"
)
)
;
const
ProfilerPreferenceObserver
=
React
.
createFactory
(
require
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
components
/
shared
/
ProfilerPreferenceObserver
.
js
"
)
)
;
const
createStore
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
redux
/
create
-
store
.
js
"
)
;
const
selectors
=
require
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
store
/
selectors
.
js
"
)
;
const
reducers
=
require
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
store
/
reducers
.
js
"
)
;
const
actions
=
require
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
store
/
actions
.
js
"
)
;
const
{
openProfilerTab
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
shared
/
browser
.
js
"
)
;
const
{
createLocalSymbolicationService
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
shared
/
symbolication
.
sys
.
mjs
"
)
;
const
{
registerProfileCaptureForBrowser
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
client
/
performance
-
new
/
shared
/
background
.
sys
.
mjs
"
)
;
const
{
presets
getProfilerViewModeForCurrentPreset
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
performance
-
new
/
prefs
-
presets
.
sys
.
mjs
"
)
;
async
function
gInit
(
perfFront
traits
pageContext
openAboutProfiling
)
{
const
store
=
createStore
(
reducers
)
;
const
isSupportedPlatform
=
await
perfFront
.
isSupportedPlatform
(
)
;
const
supportedFeatures
=
await
perfFront
.
getSupportedFeatures
(
)
;
{
const
anyWindow
=
(
window
)
;
const
panelWindow
=
(
anyWindow
)
;
const
anyStore
=
(
store
)
;
panelWindow
.
gStore
=
anyStore
;
}
const
l10n
=
new
FluentL10n
(
)
;
await
l10n
.
init
(
[
"
devtools
/
client
/
perftools
.
ftl
"
"
branding
/
brand
.
ftl
"
"
devtools
/
client
/
toolbox
-
options
.
ftl
"
"
toolkit
/
branding
/
brandings
.
ftl
"
]
)
;
store
.
dispatch
(
actions
.
initializeStore
(
{
isSupportedPlatform
presets
supportedFeatures
pageContext
}
)
)
;
const
onProfileReceived
=
async
(
{
profile
additionalInformation
}
)
=
>
{
const
objdirs
=
selectors
.
getObjdirs
(
store
.
getState
(
)
)
;
const
profilerViewMode
=
getProfilerViewModeForCurrentPreset
(
pageContext
)
;
const
sharedLibraries
=
additionalInformation
?
.
sharedLibraries
?
?
[
]
;
if
(
!
sharedLibraries
.
length
)
{
console
.
error
(
[
devtools
perf
]
No
shared
libraries
information
have
been
retrieved
from
the
profiled
target
this
is
unexpected
.
)
;
}
const
symbolicationService
=
createLocalSymbolicationService
(
sharedLibraries
objdirs
perfFront
)
;
const
browser
=
await
openProfilerTab
(
{
profilerViewMode
}
)
;
const
profileCaptureResult
=
{
type
:
"
SUCCESS
"
profile
}
;
registerProfileCaptureForBrowser
(
browser
profileCaptureResult
symbolicationService
)
;
}
;
const
onEditSettingsLinkClicked
=
openAboutProfiling
;
ReactDOM
.
render
(
Provider
(
{
store
}
LocalizationProvider
(
{
bundles
:
l10n
.
getBundles
(
)
}
React
.
createElement
(
React
.
Fragment
null
ProfilerEventHandling
(
{
perfFront
traits
}
)
ProfilerPreferenceObserver
(
)
DevToolsPanel
(
{
perfFront
onProfileReceived
onEditSettingsLinkClicked
}
)
)
)
)
document
.
querySelector
(
"
#
root
"
)
)
;
window
.
addEventListener
(
"
unload
"
(
)
=
>
gDestroy
(
)
{
once
:
true
}
)
;
}
function
gDestroy
(
)
{
const
root
=
document
.
querySelector
(
"
#
root
"
)
;
if
(
root
)
{
ReactDOM
.
unmountComponentAtNode
(
root
)
;
}
}
