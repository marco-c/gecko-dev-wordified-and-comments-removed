"
use
strict
"
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
network
.
cookie
.
sameSite
.
laxByDefault
"
false
]
[
"
privacy
.
partition
.
always_partition_third_party_non_cookie_storage
"
false
]
]
}
)
;
const
URL_IFRAME
=
buildURLWithContent
(
"
example
.
net
"
<
h1
>
iframe
<
/
h1
>
+
<
script
>
document
.
cookie
=
"
lorem
=
ipsum
"
;
<
/
script
>
)
;
const
URL_MAIN
=
buildURLWithContent
(
"
example
.
com
"
<
h1
>
Main
<
/
h1
>
+
<
script
>
document
.
cookie
=
"
foo
=
bar
"
;
<
/
script
>
+
<
iframe
src
=
"
{
URL_IFRAME
}
"
>
)
;
await
openTabAndSetupStorage
(
URL_MAIN
)
;
const
doc
=
gPanelWindow
.
document
;
checkTree
(
doc
[
"
cookies
"
"
https
:
/
/
example
.
com
"
]
)
;
checkTree
(
doc
[
"
cookies
"
"
https
:
/
/
example
.
net
"
]
)
;
await
selectTreeItem
(
[
"
cookies
"
"
https
:
/
/
example
.
com
"
]
)
;
checkCookieData
(
"
foo
"
"
bar
"
)
;
await
selectTreeItem
(
[
"
cookies
"
"
https
:
/
/
example
.
net
"
]
)
;
checkCookieData
(
"
lorem
"
"
ipsum
"
)
;
info
(
"
Add
more
cookies
"
)
;
const
onUpdated
=
gUI
.
once
(
"
store
-
objects
-
edit
"
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
async
function
(
)
{
content
.
window
.
document
.
cookie
=
"
foo2
=
bar2
"
;
const
iframe
=
content
.
document
.
querySelector
(
"
iframe
"
)
;
return
SpecialPowers
.
spawn
(
iframe
[
]
(
)
=
>
{
content
.
document
.
cookie
=
"
lorem2
=
ipsum2
"
;
}
)
;
}
)
;
await
onUpdated
;
checkCookieData
(
"
lorem2
"
"
ipsum2
"
)
;
await
selectTreeItem
(
[
"
cookies
"
"
https
:
/
/
example
.
com
"
]
)
;
checkCookieData
(
"
foo2
"
"
bar2
"
)
;
SpecialPowers
.
clearUserPref
(
"
network
.
cookie
.
sameSite
.
laxByDefault
"
)
;
}
)
;
