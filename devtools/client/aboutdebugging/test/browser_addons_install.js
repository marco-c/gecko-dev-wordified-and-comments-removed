"
use
strict
"
;
loader
.
lazyImporter
(
this
"
AddonTestUtils
"
"
resource
:
/
/
testing
-
common
/
AddonTestUtils
.
jsm
"
)
;
AddonTestUtils
.
initMochitest
(
this
)
;
const
ADDON_ID
=
"
test
-
devtools
mozilla
.
org
"
;
const
ADDON_NAME
=
"
test
-
devtools
"
;
function
mockFilePicker
(
window
file
)
{
let
MockFilePicker
=
SpecialPowers
.
MockFilePicker
;
MockFilePicker
.
init
(
window
)
;
MockFilePicker
.
setFiles
(
[
file
]
)
;
}
function
promiseWriteWebManifestForExtension
(
manifest
dir
)
{
let
files
=
{
"
manifest
.
json
"
:
JSON
.
stringify
(
manifest
)
}
;
return
AddonTestUtils
.
promiseWriteFilesToExtension
(
dir
.
path
manifest
.
applications
.
gecko
.
id
files
true
)
;
}
add_task
(
function
*
testLegacyInstallSuccess
(
)
{
let
{
tab
document
}
=
yield
openAboutDebugging
(
"
addons
"
)
;
yield
waitForInitialAddonList
(
document
)
;
yield
installAddon
(
{
document
path
:
"
addons
/
unpacked
/
install
.
rdf
"
name
:
ADDON_NAME
}
)
;
yield
uninstallAddon
(
{
document
id
:
ADDON_ID
name
:
ADDON_NAME
}
)
;
yield
closeAboutDebugging
(
tab
)
;
}
)
;
add_task
(
function
*
testWebextensionInstallError
(
)
{
let
{
tab
document
window
}
=
yield
openAboutDebugging
(
"
addons
"
)
;
yield
waitForInitialAddonList
(
document
)
;
let
top
=
document
.
querySelector
(
"
.
addons
-
top
"
)
;
let
promise
=
waitForMutation
(
top
{
childList
:
true
}
)
;
mockFilePicker
(
window
getSupportsFile
(
"
addons
/
bad
/
manifest
.
json
"
)
.
file
)
;
document
.
getElementById
(
"
load
-
addon
-
from
-
file
"
)
.
click
(
)
;
yield
promise
;
let
err
=
document
.
querySelector
(
"
.
addons
-
install
-
error
"
)
;
isnot
(
err
null
"
Addon
install
error
message
appeared
"
)
;
yield
closeAboutDebugging
(
tab
)
;
}
)
;
add_task
(
function
*
testWebextensionInstallErrorRetry
(
)
{
let
{
tab
document
window
}
=
yield
openAboutDebugging
(
"
addons
"
)
;
yield
waitForInitialAddonList
(
document
)
;
let
tempdir
=
AddonTestUtils
.
tempDir
.
clone
(
)
;
let
addonId
=
"
invalid
-
addon
-
install
-
retry
mozilla
.
org
"
;
let
addonName
=
"
invalid
-
addon
-
install
-
retry
"
;
let
manifest
=
{
name
:
addonName
description
:
"
test
invalid
-
addon
-
install
-
retry
"
manifest_version
:
2
version
:
"
1
.
0
"
applications
:
{
gecko
:
{
id
:
addonId
}
}
content_scripts
:
{
matches
:
"
http
:
/
/
*
/
"
js
:
"
foo
.
js
"
}
}
;
yield
promiseWriteWebManifestForExtension
(
manifest
tempdir
)
;
let
top
=
document
.
querySelector
(
"
.
addons
-
top
"
)
;
let
contentUpdated
=
waitForMutation
(
top
{
childList
:
true
}
)
;
let
manifestFile
=
tempdir
.
clone
(
)
;
manifestFile
.
append
(
addonId
"
manifest
.
json
"
)
;
mockFilePicker
(
window
manifestFile
)
;
document
.
getElementById
(
"
load
-
addon
-
from
-
file
"
)
.
click
(
)
;
yield
contentUpdated
;
let
err
=
document
.
querySelector
(
"
.
addons
-
install
-
error
"
)
;
isnot
(
err
null
"
Addon
install
error
message
appeared
"
)
;
let
retryButton
=
document
.
querySelector
(
"
button
.
addons
-
install
-
retry
"
)
;
is
(
retryButton
.
textContent
"
Retry
"
"
Retry
button
has
a
good
label
"
)
;
manifest
.
content_scripts
=
[
{
matches
:
[
"
http
:
/
/
*
/
"
]
js
:
[
"
foo
.
js
"
]
}
]
;
yield
promiseWriteWebManifestForExtension
(
manifest
tempdir
)
;
let
getAddonEl
=
(
)
=
>
document
.
querySelector
(
[
data
-
addon
-
id
=
"
{
addonId
}
"
]
)
;
ok
(
!
getAddonEl
(
)
"
Addon
is
not
installed
yet
"
)
;
let
addonAdded
=
waitForMutation
(
getTemporaryAddonList
(
document
)
{
childList
:
true
}
)
;
retryButton
.
click
(
)
;
yield
addonAdded
;
ok
(
getAddonEl
(
)
"
Addon
is
installed
"
)
;
yield
uninstallAddon
(
{
document
id
:
addonId
name
:
addonName
}
)
;
yield
closeAboutDebugging
(
tab
)
;
}
)
;
