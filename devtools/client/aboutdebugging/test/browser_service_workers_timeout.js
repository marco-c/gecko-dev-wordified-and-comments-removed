"
use
strict
"
;
const
HTTP_ROOT
=
CHROME_ROOT
.
replace
(
"
chrome
:
/
/
mochitests
/
content
/
"
"
http
:
/
/
mochi
.
test
:
8888
/
"
)
;
const
SERVICE_WORKER
=
HTTP_ROOT
+
"
service
-
workers
/
empty
-
sw
.
js
"
;
const
TAB_URL
=
HTTP_ROOT
+
"
service
-
workers
/
empty
-
sw
.
html
"
;
const
SW_TIMEOUT
=
1000
;
add_task
(
function
*
(
)
{
yield
new
Promise
(
done
=
>
{
let
options
=
{
"
set
"
:
[
[
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
]
[
"
dom
.
serviceWorkers
.
idle_timeout
"
SW_TIMEOUT
]
[
"
dom
.
serviceWorkers
.
idle_extended_timeout
"
SW_TIMEOUT
]
]
}
;
SpecialPowers
.
pushPrefEnv
(
options
done
)
;
}
)
;
let
{
tab
document
}
=
yield
openAboutDebugging
(
"
workers
"
)
;
let
swTab
=
yield
addTab
(
TAB_URL
)
;
let
serviceWorkersElement
=
getServiceWorkerList
(
document
)
;
yield
waitForMutation
(
serviceWorkersElement
{
childList
:
true
}
)
;
assertHasTarget
(
true
document
"
service
-
workers
"
SERVICE_WORKER
)
;
yield
waitForServiceWorkerRegistered
(
swTab
)
;
ok
(
true
"
Service
worker
registration
resolved
"
)
;
let
names
=
[
.
.
.
document
.
querySelectorAll
(
"
#
service
-
workers
.
target
-
name
"
)
]
;
let
name
=
names
.
filter
(
element
=
>
element
.
textContent
=
=
=
SERVICE_WORKER
)
[
0
]
;
ok
(
name
"
Found
the
service
worker
in
the
list
"
)
;
let
targetElement
=
name
.
parentNode
.
parentNode
;
let
debugBtn
=
targetElement
.
querySelector
(
"
.
debug
-
button
"
)
;
ok
(
debugBtn
"
Found
its
debug
button
"
)
;
let
onToolboxReady
=
new
Promise
(
done
=
>
{
gDevTools
.
once
(
"
toolbox
-
ready
"
function
(
e
toolbox
)
{
done
(
toolbox
)
;
}
)
;
}
)
;
debugBtn
.
click
(
)
;
let
toolbox
=
yield
onToolboxReady
;
yield
new
Promise
(
done
=
>
{
setTimeout
(
done
SW_TIMEOUT
*
2
)
;
}
)
;
assertHasTarget
(
true
document
"
service
-
workers
"
SERVICE_WORKER
)
;
ok
(
targetElement
.
querySelector
(
"
.
debug
-
button
"
)
"
The
debug
button
is
still
there
"
)
;
yield
toolbox
.
destroy
(
)
;
toolbox
=
null
;
yield
waitForMutation
(
targetElement
{
childList
:
true
}
)
;
ok
(
!
targetElement
.
querySelector
(
"
.
debug
-
button
"
)
"
The
debug
button
was
removed
when
the
worker
was
killed
"
)
;
yield
unregisterServiceWorker
(
swTab
)
;
ok
(
true
"
Service
worker
registration
unregistered
"
)
;
yield
waitForMutation
(
serviceWorkersElement
{
childList
:
true
}
)
;
assertHasTarget
(
false
document
"
service
-
workers
"
SERVICE_WORKER
)
;
yield
removeTab
(
swTab
)
;
yield
closeAboutDebugging
(
tab
)
;
}
)
;
