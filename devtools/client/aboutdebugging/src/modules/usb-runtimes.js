"
use
strict
"
;
loader
.
lazyRequireGetter
(
this
"
adb
"
"
resource
:
/
/
devtools
/
client
/
shared
/
remote
-
debugging
/
adb
/
adb
.
js
"
true
)
;
class
UsbRuntime
{
constructor
(
adbRuntime
)
{
this
.
id
=
adbRuntime
.
id
;
this
.
deviceId
=
adbRuntime
.
deviceId
;
this
.
deviceName
=
adbRuntime
.
deviceName
;
this
.
shortName
=
adbRuntime
.
shortName
;
this
.
socketPath
=
adbRuntime
.
socketPath
;
this
.
isFenix
=
adbRuntime
.
isFenix
;
this
.
isUnavailable
=
false
;
this
.
isUnplugged
=
false
;
this
.
versionName
=
adbRuntime
.
versionName
;
}
}
class
UnavailableUsbRuntime
{
constructor
(
adbDevice
)
{
this
.
id
=
adbDevice
.
id
+
"
|
unavailable
"
;
this
.
deviceId
=
adbDevice
.
id
;
this
.
deviceName
=
adbDevice
.
name
;
this
.
shortName
=
"
Unavailable
runtime
"
;
this
.
socketPath
=
null
;
this
.
isFenix
=
false
;
this
.
isUnavailable
=
true
;
this
.
isUnplugged
=
false
;
this
.
versionName
=
null
;
}
}
class
UnpluggedUsbRuntime
{
constructor
(
deviceId
deviceName
)
{
this
.
id
=
deviceId
+
"
|
unplugged
"
;
this
.
deviceId
=
deviceId
;
this
.
deviceName
=
deviceName
;
this
.
shortName
=
"
Unplugged
runtime
"
;
this
.
socketPath
=
null
;
this
.
isFenix
=
false
;
this
.
isUnavailable
=
true
;
this
.
isUnplugged
=
true
;
this
.
versionName
=
null
;
}
}
const
devices
=
new
Map
(
)
;
function
addUSBRuntimesObserver
(
listener
)
{
adb
.
registerListener
(
listener
)
;
}
exports
.
addUSBRuntimesObserver
=
addUSBRuntimesObserver
;
async
function
getUSBRuntimes
(
)
{
const
runtimes
=
adb
.
getRuntimes
(
)
.
map
(
r
=
>
new
UsbRuntime
(
r
)
)
;
const
runtimeDevices
=
runtimes
.
map
(
r
=
>
r
.
deviceId
)
;
const
unavailableRuntimes
=
adb
.
getDevices
(
)
.
filter
(
d
=
>
!
runtimeDevices
.
includes
(
d
.
id
)
)
.
map
(
d
=
>
new
UnavailableUsbRuntime
(
d
)
)
;
const
allRuntimes
=
runtimes
.
concat
(
unavailableRuntimes
)
;
for
(
const
runtime
of
allRuntimes
)
{
devices
.
set
(
runtime
.
deviceId
runtime
.
deviceName
)
;
}
const
currentDevices
=
allRuntimes
.
map
(
r
=
>
r
.
deviceId
)
;
const
detectedDevices
=
[
.
.
.
devices
.
keys
(
)
]
;
const
unpluggedDevices
=
detectedDevices
.
filter
(
id
=
>
!
currentDevices
.
includes
(
id
)
)
;
const
unpluggedRuntimes
=
unpluggedDevices
.
map
(
deviceId
=
>
{
const
deviceName
=
devices
.
get
(
deviceId
)
;
return
new
UnpluggedUsbRuntime
(
deviceId
deviceName
)
;
}
)
;
return
allRuntimes
.
concat
(
unpluggedRuntimes
)
;
}
exports
.
getUSBRuntimes
=
getUSBRuntimes
;
function
removeUSBRuntimesObserver
(
listener
)
{
adb
.
unregisterListener
(
listener
)
;
}
exports
.
removeUSBRuntimesObserver
=
removeUSBRuntimesObserver
;
function
refreshUSBRuntimes
(
)
{
return
adb
.
updateRuntimes
(
)
;
}
exports
.
refreshUSBRuntimes
=
refreshUSBRuntimes
;
