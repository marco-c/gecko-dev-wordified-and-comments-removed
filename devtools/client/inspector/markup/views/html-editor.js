"
use
strict
"
;
const
Editor
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
sourceeditor
/
editor
.
js
"
)
;
const
EventEmitter
=
require
(
"
resource
:
/
/
devtools
/
shared
/
event
-
emitter
.
js
"
)
;
class
HTMLEditor
extends
EventEmitter
{
constructor
(
htmlDocument
)
{
super
(
)
;
this
.
doc
=
htmlDocument
;
this
.
#
container
=
this
.
doc
.
createElement
(
"
div
"
)
;
this
.
#
container
.
className
=
"
html
-
editor
theme
-
body
"
;
this
.
#
container
.
style
.
display
=
"
none
"
;
this
.
#
editorInner
=
this
.
doc
.
createElement
(
"
div
"
)
;
this
.
#
editorInner
.
className
=
"
html
-
editor
-
inner
"
;
this
.
#
container
.
appendChild
(
this
.
#
editorInner
)
;
this
.
doc
.
body
.
appendChild
(
this
.
#
container
)
;
this
.
doc
.
defaultView
.
addEventListener
(
"
resize
"
this
.
refresh
true
)
;
const
config
=
{
mode
:
Editor
.
modes
.
html
lineWrapping
:
true
styleActiveLine
:
false
extraKeys
:
{
}
theme
:
"
mozilla
markup
-
view
"
}
;
config
.
extraKeys
[
HTMLEditor
.
#
ctrl
(
"
Enter
"
)
]
=
this
.
hide
;
config
.
extraKeys
.
F2
=
this
.
hide
;
config
.
extraKeys
.
Esc
=
this
.
hide
.
bind
(
this
false
)
;
this
.
#
container
.
addEventListener
(
"
click
"
this
.
hide
)
;
this
.
#
editorInner
.
addEventListener
(
"
click
"
HTMLEditor
.
#
stopPropagation
)
;
this
.
editor
=
new
Editor
(
config
)
;
this
.
editor
.
appendToLocalElement
(
this
.
#
editorInner
)
;
this
.
hide
(
false
)
;
}
editor
=
null
;
doc
=
null
;
#
container
=
null
;
#
editorInner
=
null
;
#
attachedElement
=
null
;
static
#
ctrl
(
k
)
{
return
(
Services
.
appinfo
.
OS
=
=
"
Darwin
"
?
"
Cmd
-
"
:
"
Ctrl
-
"
)
+
k
;
}
static
#
stopPropagation
(
e
)
{
e
.
stopPropagation
(
)
;
}
refresh
(
)
{
const
element
=
this
.
#
attachedElement
;
if
(
element
)
{
this
.
#
container
.
style
.
top
=
element
.
offsetTop
+
"
px
"
;
this
.
#
container
.
style
.
left
=
element
.
offsetLeft
+
"
px
"
;
this
.
#
container
.
style
.
width
=
element
.
offsetWidth
+
"
px
"
;
this
.
#
container
.
style
.
height
=
element
.
parentNode
.
offsetHeight
+
"
px
"
;
this
.
editor
.
refresh
(
)
;
}
}
#
attach
(
element
)
{
this
.
#
detach
(
)
;
this
.
#
attachedElement
=
element
;
element
.
classList
.
add
(
"
html
-
editor
-
container
"
)
;
this
.
refresh
(
)
;
}
#
detach
(
)
{
if
(
this
.
#
attachedElement
)
{
this
.
#
attachedElement
.
classList
.
remove
(
"
html
-
editor
-
container
"
)
;
this
.
#
attachedElement
=
undefined
;
}
}
show
=
(
element
text
)
=
>
{
if
(
this
.
isVisible
)
{
return
;
}
this
.
_originalValue
=
text
;
this
.
editor
.
setText
(
text
)
;
this
.
#
attach
(
element
)
;
this
.
#
container
.
style
.
display
=
"
flex
"
;
this
.
isVisible
=
true
;
this
.
editor
.
refresh
(
)
;
this
.
editor
.
focus
(
)
;
this
.
editor
.
clearHistory
(
)
;
this
.
emit
(
"
popupshown
"
)
;
}
;
hide
=
shouldCommit
=
>
{
if
(
!
this
.
isVisible
)
{
return
;
}
this
.
#
container
.
style
.
display
=
"
none
"
;
this
.
#
detach
(
)
;
const
newValue
=
this
.
editor
.
getText
(
)
;
const
valueHasChanged
=
this
.
_originalValue
!
=
=
newValue
;
const
preventCommit
=
shouldCommit
=
=
=
false
|
|
!
valueHasChanged
;
this
.
_originalValue
=
undefined
;
this
.
isVisible
=
undefined
;
this
.
emit
(
"
popuphidden
"
!
preventCommit
newValue
)
;
}
;
destroy
(
)
{
this
.
doc
.
defaultView
.
removeEventListener
(
"
resize
"
this
.
refresh
true
)
;
this
.
#
container
.
removeEventListener
(
"
click
"
this
.
hide
)
;
this
.
#
editorInner
.
removeEventListener
(
"
click
"
HTMLEditor
.
#
stopPropagation
)
;
this
.
hide
(
false
)
;
this
.
#
container
.
remove
(
)
;
this
.
editor
.
destroy
(
)
;
}
}
module
.
exports
=
HTMLEditor
;
