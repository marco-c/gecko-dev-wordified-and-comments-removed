"
use
strict
"
;
const
TEST_URL
=
"
data
:
text
/
html
;
charset
=
utf8
"
+
"
<
div
id
=
'
attr
'
a
=
'
1
'
b
=
'
2
'
c
=
'
3
'
>
<
/
div
>
"
+
"
<
div
id
=
'
delattr
'
tobeinvalid
=
'
1
'
last
=
'
2
'
>
<
/
div
>
"
;
add_task
(
async
function
(
)
{
const
{
inspector
}
=
await
openInspectorForURL
(
TEST_URL
)
;
await
testAttributeEditing
(
inspector
)
;
await
testAttributeDeletion
(
inspector
)
;
}
)
;
async
function
testAttributeEditing
(
inspector
)
{
info
(
"
Testing
focus
position
after
attribute
editing
"
)
;
info
(
"
Setting
the
first
non
-
id
attribute
in
edit
mode
"
)
;
await
activateFirstAttribute
(
"
#
attr
"
inspector
)
;
collapseSelectionAndTab
(
inspector
)
;
const
attrs
=
await
getAttributesFromEditor
(
"
#
attr
"
inspector
)
;
info
(
"
Editing
this
attribute
keeping
the
same
name
"
+
"
and
tabbing
to
the
next
"
)
;
await
editAttributeAndTab
(
attrs
[
1
]
+
'
=
"
99
"
'
inspector
)
;
checkFocusedAttribute
(
attrs
[
2
]
true
)
;
info
(
"
Editing
the
new
focused
attribute
keeping
the
name
"
+
"
and
tabbing
to
the
previous
"
)
;
await
editAttributeAndTab
(
attrs
[
2
]
+
'
=
"
99
"
'
inspector
true
)
;
checkFocusedAttribute
(
attrs
[
1
]
true
)
;
info
(
"
Editing
attribute
name
changes
attribute
order
"
)
;
await
editAttributeAndTab
(
"
d
=
'
4
'
"
inspector
)
;
checkFocusedAttribute
(
"
id
"
true
)
;
EventUtils
.
sendKey
(
"
escape
"
inspector
.
panelWin
)
;
}
async
function
testAttributeDeletion
(
inspector
)
{
info
(
"
Testing
focus
position
after
attribute
deletion
"
)
;
info
(
"
Setting
the
first
non
-
id
attribute
in
edit
mode
"
)
;
await
activateFirstAttribute
(
"
#
delattr
"
inspector
)
;
collapseSelectionAndTab
(
inspector
)
;
const
attrs
=
await
getAttributesFromEditor
(
"
#
delattr
"
inspector
)
;
info
(
"
Entering
an
invalid
attribute
to
delete
the
attribute
"
)
;
await
editAttributeAndTab
(
'
"
'
inspector
)
;
checkFocusedAttribute
(
attrs
[
2
]
true
)
;
info
(
"
Deleting
the
last
attribute
"
)
;
await
editAttributeAndTab
(
"
"
inspector
)
;
const
focusedAttr
=
Services
.
focus
.
focusedElement
;
ok
(
focusedAttr
.
classList
.
contains
(
"
styleinspector
-
propertyeditor
"
)
"
in
newattr
"
)
;
is
(
focusedAttr
.
tagName
"
textarea
"
"
newattr
is
active
"
)
;
}
async
function
editAttributeAndTab
(
newValue
inspector
goPrevious
)
{
const
onEditMutation
=
inspector
.
markup
.
once
(
"
refocusedonedit
"
)
;
inspector
.
markup
.
doc
.
activeElement
.
value
=
newValue
;
if
(
goPrevious
)
{
EventUtils
.
synthesizeKey
(
"
VK_TAB
"
{
shiftKey
:
true
}
inspector
.
panelWin
)
;
}
else
{
EventUtils
.
sendKey
(
"
tab
"
inspector
.
panelWin
)
;
}
await
onEditMutation
;
}
async
function
activateFirstAttribute
(
container
inspector
)
{
const
{
editor
}
=
await
focusNode
(
container
inspector
)
;
editor
.
tag
.
focus
(
)
;
EventUtils
.
sendKey
(
"
tab
"
inspector
.
panelWin
)
;
EventUtils
.
sendKey
(
"
return
"
inspector
.
panelWin
)
;
}
