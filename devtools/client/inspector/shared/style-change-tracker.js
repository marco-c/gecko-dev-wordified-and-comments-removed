"
use
strict
"
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
class
InspectorStyleChangeTracker
{
constructor
(
inspector
)
{
this
.
inspector
=
inspector
;
this
.
selection
=
inspector
.
selection
;
this
.
onMutations
=
this
.
onMutations
.
bind
(
this
)
;
this
.
onResized
=
this
.
onResized
.
bind
(
this
)
;
this
.
init
(
)
;
EventEmitter
.
decorate
(
this
)
;
}
async
init
(
)
{
if
(
!
this
.
inspector
)
{
return
;
}
try
{
this
.
inspectorFronts
=
await
this
.
inspector
.
inspectorFront
.
getAllInspectorFronts
(
)
;
}
catch
(
e
)
{
return
;
}
for
(
const
{
walker
}
of
this
.
inspectorFronts
)
{
walker
.
on
(
"
mutations
"
this
.
onMutations
)
;
walker
.
on
(
"
resize
"
this
.
onResized
)
;
}
}
destroy
(
)
{
for
(
const
{
walker
}
of
this
.
inspectorFronts
)
{
walker
.
off
(
"
mutations
"
this
.
onMutations
)
;
walker
.
off
(
"
resize
"
this
.
onResized
)
;
}
this
.
inspector
=
null
;
this
.
inspectorFronts
=
null
;
this
.
selection
=
null
;
}
onMutations
(
mutations
)
{
const
canMutationImpactCurrentStyles
=
(
{
type
target
}
)
=
>
{
if
(
type
!
=
=
"
attributes
"
)
{
return
false
;
}
const
currentNode
=
this
.
selection
.
nodeFront
;
if
(
target
=
=
=
currentNode
)
{
return
true
;
}
let
parent
=
currentNode
.
parentNode
(
)
;
const
siblings
=
parent
.
treeChildren
(
)
;
if
(
siblings
.
includes
(
target
)
)
{
return
true
;
}
while
(
parent
)
{
if
(
target
=
=
=
parent
)
{
return
true
;
}
parent
=
parent
.
parentNode
(
)
;
}
return
false
;
}
;
for
(
const
mutation
of
mutations
)
{
if
(
canMutationImpactCurrentStyles
(
mutation
)
)
{
this
.
emit
(
"
style
-
changed
"
)
;
break
;
}
}
}
onResized
(
)
{
this
.
emit
(
"
style
-
changed
"
)
;
}
}
module
.
exports
=
InspectorStyleChangeTracker
;
