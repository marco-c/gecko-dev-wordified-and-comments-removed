"
use
strict
"
;
const
EXAMPLE_COM_URI
=
"
http
:
/
/
example
.
com
/
document
-
builder
.
sjs
?
html
=
<
div
id
=
com
>
com
"
;
const
EXAMPLE_NET_URI
=
"
http
:
/
/
example
.
net
/
document
-
builder
.
sjs
?
html
=
<
div
id
=
net
>
net
"
;
const
ORG_URL_ROOT
=
URL_ROOT
.
replace
(
"
example
.
com
"
"
example
.
org
"
)
;
const
TEST_ORG_URI
=
ORG_URL_ROOT
+
"
doc_inspector_fission_frame_navigation
.
html
"
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
devtools
.
contenttoolbox
.
fission
"
true
)
;
const
{
inspector
}
=
await
openInspectorForURL
(
TEST_ORG_URI
)
;
const
tree
=
id
=
"
root
"
iframe
#
document
html
head
body
id
=
"
org
"
;
await
assertMarkupViewAsTree
(
tree
"
#
root
"
inspector
)
;
await
navigateIframeTo
(
inspector
EXAMPLE_COM_URI
)
;
const
treeAfterLoadingCom
=
id
=
"
root
"
iframe
#
document
html
head
body
id
=
"
com
"
;
await
assertMarkupViewAsTree
(
treeAfterLoadingCom
"
#
root
"
inspector
)
;
await
navigateIframeTo
(
inspector
EXAMPLE_NET_URI
)
;
const
treeAfterLoadingNet
=
id
=
"
root
"
iframe
#
document
html
head
body
id
=
"
net
"
;
await
assertMarkupViewAsTree
(
treeAfterLoadingNet
"
#
root
"
inspector
)
;
}
)
;
add_task
(
async
function
navigateFrameNotExpandedInMarkupView
(
)
{
if
(
!
isFissionEnabled
(
)
)
{
return
;
}
await
pushPref
(
"
devtools
.
contenttoolbox
.
fission
"
true
)
;
const
{
inspector
}
=
await
openInspectorForURL
(
TEST_ORG_URI
)
;
const
resourceWatcher
=
inspector
.
toolbox
.
resourceWatcher
;
const
{
resource
targetFront
}
=
await
navigateIframeTo
(
inspector
EXAMPLE_COM_URI
)
;
is
(
resource
?
.
resourceType
resourceWatcher
.
TYPES
.
ROOT_NODE
"
A
resource
with
resourceType
ROOT_NODE
was
received
when
navigating
"
)
;
todo
(
!
targetFront
.
getCachedFront
(
"
inspector
"
)
"
The
inspector
front
for
the
new
target
should
not
be
initialized
"
)
;
}
)
;
async
function
navigateIframeTo
(
inspector
url
)
{
info
(
"
Navigate
the
test
iframe
to
"
+
url
)
;
const
{
resourceWatcher
targetList
}
=
inspector
.
toolbox
;
const
onTargetProcessed
=
waitForTargetProcessed
(
targetList
url
)
;
const
onNewRoot
=
waitForResourceOnce
(
resourceWatcher
resourceWatcher
.
TYPES
.
ROOT_NODE
)
;
info
(
"
Update
the
src
attribute
of
the
iframe
tag
"
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
url
]
function
(
_url
)
{
content
.
document
.
querySelector
(
"
iframe
"
)
.
setAttribute
(
"
src
"
_url
)
;
}
)
;
info
(
"
Wait
for
frameLoad
/
newRoot
to
resolve
"
)
;
const
newRootResult
=
await
onNewRoot
;
info
(
"
Wait
for
pending
children
updates
"
)
;
await
inspector
.
markup
.
_waitForChildren
(
)
;
if
(
isFissionEnabled
(
)
)
{
info
(
"
Wait
until
the
new
target
has
been
processed
by
TargetList
"
)
;
await
onTargetProcessed
;
}
return
newRootResult
;
}
function
waitForTargetProcessed
(
targetList
url
)
{
return
new
Promise
(
resolve
=
>
{
const
onTargetProcessed
=
targetFront
=
>
{
if
(
targetFront
.
url
!
=
=
encodeURI
(
url
)
)
{
return
;
}
targetList
.
off
(
"
processed
-
available
-
target
"
onTargetProcessed
)
;
resolve
(
)
;
}
;
targetList
.
on
(
"
processed
-
available
-
target
"
onTargetProcessed
)
;
}
)
;
}
