"
use
strict
"
;
const
{
Task
}
=
require
(
"
devtools
/
shared
/
task
"
)
;
const
{
getCssProperties
}
=
require
(
"
devtools
/
shared
/
fronts
/
css
-
properties
"
)
;
function
EditingSession
(
{
inspector
doc
elementRules
}
)
{
this
.
_doc
=
doc
;
this
.
_rules
=
elementRules
;
this
.
_modifications
=
new
Map
(
)
;
this
.
_cssProperties
=
getCssProperties
(
inspector
.
toolbox
)
;
}
EditingSession
.
prototype
=
{
getPropertyFromRule
:
function
(
rule
property
)
{
let
index
=
this
.
getPropertyIndex
(
property
rule
)
;
if
(
index
!
=
=
-
1
)
{
return
rule
.
declarations
[
index
]
.
value
;
}
let
dummyStyle
=
this
.
_element
.
style
;
dummyStyle
.
cssText
=
rule
.
cssText
;
return
dummyStyle
.
getPropertyValue
(
property
)
;
}
getProperty
:
function
(
property
)
{
let
div
=
this
.
_doc
.
createElement
(
"
div
"
)
;
div
.
setAttribute
(
"
style
"
"
display
:
none
"
)
;
this
.
_doc
.
getElementById
(
"
inspector
-
main
-
content
"
)
.
appendChild
(
div
)
;
this
.
_element
=
this
.
_doc
.
createElement
(
"
p
"
)
;
div
.
appendChild
(
this
.
_element
)
;
for
(
let
rule
of
this
.
_rules
)
{
let
value
=
this
.
getPropertyFromRule
(
rule
property
)
;
if
(
value
!
=
=
"
"
)
{
div
.
remove
(
)
;
return
value
;
}
}
div
.
remove
(
)
;
return
"
"
;
}
getPropertyIndex
:
function
(
name
rule
=
this
.
_rules
[
0
]
)
{
let
elementStyleRule
=
this
.
_rules
[
0
]
;
if
(
!
elementStyleRule
.
declarations
.
length
)
{
return
-
1
;
}
return
elementStyleRule
.
declarations
.
findIndex
(
p
=
>
p
.
name
=
=
=
name
)
;
}
setProperties
:
Task
.
async
(
function
*
(
properties
)
{
for
(
let
property
of
properties
)
{
let
modifications
=
this
.
_rules
[
0
]
.
startModifyingProperties
(
this
.
_cssProperties
)
;
if
(
!
this
.
_modifications
.
has
(
property
.
name
)
)
{
this
.
_modifications
.
set
(
property
.
name
this
.
getPropertyFromRule
(
this
.
_rules
[
0
]
property
.
name
)
)
;
}
let
index
=
this
.
getPropertyIndex
(
property
.
name
)
;
if
(
index
=
=
=
-
1
)
{
index
=
this
.
_rules
[
0
]
.
declarations
.
length
;
}
if
(
property
.
value
=
=
"
"
)
{
modifications
.
removeProperty
(
index
property
.
name
)
;
}
else
{
modifications
.
setProperty
(
index
property
.
name
property
.
value
"
"
)
;
}
yield
modifications
.
apply
(
)
;
}
}
)
revert
:
Task
.
async
(
function
*
(
)
{
for
(
let
[
property
value
]
of
this
.
_modifications
)
{
let
modifications
=
this
.
_rules
[
0
]
.
startModifyingProperties
(
this
.
_cssProperties
)
;
let
index
=
this
.
getPropertyIndex
(
property
)
;
if
(
value
!
=
"
"
)
{
if
(
index
=
=
=
-
1
)
{
index
=
0
;
}
modifications
.
setProperty
(
index
property
value
"
"
)
;
}
else
{
if
(
index
=
=
=
-
1
)
{
continue
;
}
modifications
.
removeProperty
(
index
property
)
;
}
yield
modifications
.
apply
(
)
;
}
}
)
destroy
:
function
(
)
{
this
.
_doc
=
null
;
this
.
_rules
=
null
;
this
.
_modifications
.
clear
(
)
;
}
}
;
module
.
exports
=
EditingSession
;
