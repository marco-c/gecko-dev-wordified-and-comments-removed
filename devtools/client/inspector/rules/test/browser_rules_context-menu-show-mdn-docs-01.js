"
use
strict
"
;
const
{
PrefObserver
}
=
require
(
"
devtools
/
client
/
shared
/
prefs
"
)
;
const
PREF_ENABLE_MDN_DOCS_TOOLTIP
=
"
devtools
.
inspector
.
mdnDocsTooltip
.
enabled
"
;
const
TEST_URI
=
<
html
>
<
head
>
<
style
>
padding
{
font
-
family
:
margin
;
}
<
/
style
>
<
/
head
>
<
body
>
<
padding
>
MDN
tooltip
testing
<
/
padding
>
<
/
body
>
<
/
html
>
;
add_task
(
function
*
(
)
{
info
(
"
Ensure
the
pref
is
true
to
begin
with
"
)
;
let
initial
=
Services
.
prefs
.
getBoolPref
(
PREF_ENABLE_MDN_DOCS_TOOLTIP
)
;
if
(
initial
!
=
true
)
{
yield
setBooleanPref
(
PREF_ENABLE_MDN_DOCS_TOOLTIP
true
)
;
}
yield
addTab
(
"
data
:
text
/
html
;
charset
=
utf8
"
+
encodeURIComponent
(
TEST_URI
)
)
;
let
{
inspector
view
}
=
yield
openRuleView
(
)
;
yield
selectNode
(
"
padding
"
inspector
)
;
yield
testMdnContextMenuItemVisibility
(
view
)
;
info
(
"
Ensure
the
pref
is
reset
to
its
initial
value
"
)
;
let
eventual
=
Services
.
prefs
.
getBoolPref
(
PREF_ENABLE_MDN_DOCS_TOOLTIP
)
;
if
(
eventual
!
=
initial
)
{
yield
setBooleanPref
(
PREF_ENABLE_MDN_DOCS_TOOLTIP
initial
)
;
}
}
)
;
function
*
setBooleanPref
(
pref
state
)
{
let
prefObserver
=
new
PrefObserver
(
"
devtools
.
"
)
;
let
oncePrefChanged
=
new
Promise
(
resolve
=
>
{
prefObserver
.
on
(
pref
onPrefChanged
)
;
function
onPrefChanged
(
)
{
prefObserver
.
off
(
pref
onPrefChanged
)
;
resolve
(
)
;
}
}
)
;
info
(
"
Set
the
pref
"
+
pref
+
"
to
:
"
+
state
)
;
Services
.
prefs
.
setBoolPref
(
pref
state
)
;
info
(
"
Wait
for
prefObserver
to
call
back
so
the
UI
can
update
"
)
;
yield
oncePrefChanged
;
}
function
*
testMdnContextMenuItemVisibility
(
view
)
{
info
(
"
Test
that
MDN
context
menu
item
is
shown
only
when
it
should
be
.
"
)
;
let
root
=
rootElement
(
view
)
;
for
(
let
node
of
iterateNodes
(
root
)
)
{
info
(
"
Setting
"
+
node
+
"
as
popupNode
"
)
;
info
(
"
Creating
context
menu
with
"
+
node
+
"
as
popupNode
"
)
;
let
allMenuItems
=
openStyleContextMenuAndGetAllItems
(
view
node
)
;
let
menuitemShowMdnDocs
=
allMenuItems
.
find
(
item
=
>
item
.
label
=
=
=
STYLE_INSPECTOR_L10N
.
getStr
(
"
styleinspector
.
contextmenu
.
showMdnDocs
"
)
)
;
let
isVisible
=
menuitemShowMdnDocs
.
visible
;
let
shouldBeVisible
=
isPropertyNameNode
(
node
)
;
let
message
=
shouldBeVisible
?
"
shown
"
:
"
hidden
"
;
is
(
isVisible
shouldBeVisible
"
The
MDN
context
menu
item
is
"
+
message
+
"
;
content
:
"
+
node
.
textContent
+
"
;
type
:
"
+
node
.
nodeType
)
;
}
}
function
isPropertyNameNode
(
node
)
{
return
node
.
textContent
=
=
=
"
font
-
family
"
;
}
function
*
iterateNodes
(
baseNode
)
{
yield
baseNode
;
for
(
let
child
of
baseNode
.
childNodes
)
{
yield
*
iterateNodes
(
child
)
;
}
}
var
rootElement
=
view
=
>
(
view
.
element
)
?
view
.
element
:
view
.
styleDocument
;
