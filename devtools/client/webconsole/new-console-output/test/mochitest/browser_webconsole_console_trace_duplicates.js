"
use
strict
"
;
const
TEST_URI
=
"
http
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
webconsole
/
"
+
"
new
-
console
-
output
/
test
/
mochitest
/
"
+
"
test
-
console
-
trace
-
duplicates
.
html
"
;
add_task
(
async
function
testTraceMessages
(
)
{
let
hud
=
await
openNewTabAndConsole
(
TEST_URI
)
;
let
message
=
await
waitFor
(
(
)
=
>
findMessage
(
hud
"
foo1
"
)
)
;
let
stackInfo
=
getStackInfo
(
message
)
;
checkStackInfo
(
stackInfo
{
variable
:
"
console
.
trace
(
)
"
repeats
:
3
filename
:
"
test
-
console
-
trace
-
duplicates
.
html
"
line
:
23
column
:
3
stack
:
[
{
functionName
:
"
foo3
"
filename
:
TEST_URI
line
:
23
column
:
3
}
{
functionName
:
"
foo2
"
filename
:
TEST_URI
line
:
19
column
:
3
}
{
functionName
:
"
foo1
"
filename
:
TEST_URI
line
:
11
column
:
3
}
{
functionName
:
"
<
anonymous
>
"
filename
:
TEST_URI
line
:
26
column
:
1
}
]
}
)
;
}
)
;
function
getStackInfo
(
message
)
{
let
lineNode
=
message
.
querySelector
(
"
.
frame
-
link
-
line
"
)
;
let
lc
=
getLineAndColumn
(
lineNode
)
;
let
result
=
{
variable
:
message
.
querySelector
(
"
.
cm
-
variable
"
)
.
textContent
repeats
:
message
.
querySelector
(
"
.
message
-
repeats
"
)
.
textContent
filename
:
message
.
querySelector
(
"
.
frame
-
link
-
filename
"
)
.
textContent
line
:
lc
.
line
column
:
lc
.
column
stack
:
[
]
}
;
let
stack
=
message
.
querySelector
(
"
.
stack
-
trace
"
)
;
if
(
stack
)
{
let
filenameNodes
=
stack
.
querySelectorAll
(
"
.
frame
-
link
-
filename
"
)
;
let
lineNodes
=
stack
.
querySelectorAll
(
"
.
frame
-
link
-
line
"
)
;
let
funcNodes
=
stack
.
querySelectorAll
(
"
.
frame
-
link
-
function
-
display
-
name
"
)
;
for
(
let
i
=
0
;
i
<
filenameNodes
.
length
;
i
+
+
)
{
let
filename
=
filenameNodes
[
i
]
.
textContent
;
let
functionName
=
funcNodes
[
i
]
.
textContent
;
let
{
line
column
}
=
getLineAndColumn
(
lineNodes
[
i
]
)
;
result
.
stack
.
push
(
{
functionName
filename
line
:
line
column
:
column
}
)
;
}
}
return
result
;
}
function
checkStackInfo
(
stackInfo
expected
)
{
is
(
stackInfo
.
variable
expected
.
variable
"
(
expected
.
variable
}
"
command
logged
)
;
is
(
stackInfo
.
repeats
expected
.
repeats
"
expected
number
of
repeats
are
displayed
"
)
;
is
(
stackInfo
.
filename
expected
.
filename
"
expected
filename
is
displayed
"
)
;
is
(
stackInfo
.
line
expected
.
line
"
expected
line
is
displayed
"
)
;
is
(
stackInfo
.
column
expected
.
column
"
expected
column
is
displayed
"
)
;
ok
(
stackInfo
.
stack
.
length
>
0
"
a
stack
is
displayed
"
)
;
is
(
stackInfo
.
stack
.
length
expected
.
stack
.
length
"
the
stack
is
the
expected
length
"
)
;
for
(
let
i
=
0
;
i
<
stackInfo
.
stack
.
length
;
i
+
+
)
{
let
actual
=
stackInfo
.
stack
[
i
]
;
let
stackExpected
=
expected
.
stack
[
i
]
;
is
(
actual
.
functionName
stackExpected
.
functionName
expected
function
name
is
displayed
for
index
{
i
}
)
;
is
(
actual
.
filename
stackExpected
.
filename
expected
filename
is
displayed
for
index
{
i
}
)
;
is
(
actual
.
line
stackExpected
.
line
expected
line
is
displayed
for
index
{
i
}
)
;
is
(
actual
.
column
stackExpected
.
column
expected
column
is
displayed
for
index
{
i
}
)
;
}
}
function
getLineAndColumn
(
node
)
{
let
lineAndColumn
=
node
.
textContent
;
let
line
=
0
;
let
column
=
0
;
if
(
lineAndColumn
.
startsWith
(
"
:
"
)
)
{
lineAndColumn
=
lineAndColumn
.
substr
(
1
)
;
[
line
column
]
=
lineAndColumn
.
split
(
"
:
"
)
;
}
return
{
line
:
line
*
1
column
:
column
*
1
}
;
}
