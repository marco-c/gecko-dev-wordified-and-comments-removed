"
use
strict
"
;
const
TEST_URI
=
data
:
text
/
html
;
charset
=
utf
-
8
<
head
>
<
script
>
/
*
Create
a
prototype
-
less
object
so
popup
does
not
contain
native
*
Object
prototype
properties
.
*
/
window
.
foo
=
Object
.
create
(
null
)
;
Object
.
assign
(
window
.
foo
{
item0
:
"
value0
"
item1
:
"
value1
"
}
)
;
<
/
script
>
<
/
head
>
<
body
>
bug
585991
-
autocomplete
popup
escape
key
usage
test
<
/
body
>
;
add_task
(
async
function
(
)
{
let
{
jsterm
}
=
await
openNewTabAndConsole
(
TEST_URI
)
;
info
(
"
web
console
opened
"
)
;
await
jsterm
.
clearHistory
(
)
;
const
{
autocompletePopup
:
popup
completeNode
inputNode
}
=
jsterm
;
let
onPopUpOpen
=
popup
.
once
(
"
popup
-
opened
"
)
;
info
(
"
wait
for
completion
:
window
.
foo
.
"
)
;
jsterm
.
setInputValue
(
"
window
.
foo
"
)
;
EventUtils
.
synthesizeKey
(
"
.
"
{
}
)
;
await
onPopUpOpen
;
ok
(
popup
.
isOpen
"
popup
is
open
"
)
;
ok
(
popup
.
itemCount
"
popup
has
items
"
)
;
info
(
"
press
Escape
to
close
the
popup
"
)
;
const
onPopupClose
=
popup
.
once
(
"
popup
-
closed
"
)
;
EventUtils
.
synthesizeKey
(
"
VK_ESCAPE
"
{
}
)
;
await
onPopupClose
;
ok
(
!
popup
.
isOpen
"
popup
is
not
open
after
VK_ESCAPE
"
)
;
is
(
jsterm
.
getInputValue
(
)
"
window
.
foo
.
"
"
completion
was
cancelled
"
)
;
ok
(
!
completeNode
.
value
"
completeNode
is
empty
"
)
;
await
jsterm
.
clearHistory
(
)
;
}
)
;
