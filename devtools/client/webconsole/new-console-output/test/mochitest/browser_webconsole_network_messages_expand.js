"
use
strict
"
;
const
TEST_URI
=
"
data
:
text
/
html
;
charset
=
utf8
Test
that
clicking
on
a
network
message
"
+
"
in
the
console
toggles
the
HTTP
inspection
.
"
;
const
TEST_FILE
=
"
test
-
network
-
request
.
html
"
;
const
TEST_PATH
=
"
http
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
webconsole
/
new
-
console
-
output
/
test
/
mochitest
/
"
;
const
NET_PREF
=
"
devtools
.
webconsole
.
filter
.
net
"
;
const
XHR_PREF
=
"
devtools
.
webconsole
.
filter
.
netxhr
"
;
Services
.
prefs
.
setBoolPref
(
NET_PREF
true
)
;
Services
.
prefs
.
setBoolPref
(
XHR_PREF
true
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
NET_PREF
)
;
Services
.
prefs
.
clearUserPref
(
XHR_PREF
)
;
}
)
;
add_task
(
async
function
task
(
)
{
const
hud
=
await
openNewTabAndConsole
(
TEST_URI
)
;
const
currentTab
=
gBrowser
.
selectedTab
;
let
target
=
TargetFactory
.
forTab
(
currentTab
)
;
let
toolbox
=
gDevTools
.
getToolbox
(
target
)
;
const
documentUrl
=
TEST_PATH
+
TEST_FILE
;
await
loadDocument
(
documentUrl
)
;
info
(
"
Document
loaded
.
"
)
;
let
messageNode
=
await
waitFor
(
(
)
=
>
findMessage
(
hud
documentUrl
)
)
;
let
urlNode
=
messageNode
.
querySelector
(
"
.
url
"
)
;
info
(
"
Network
message
found
.
"
)
;
urlNode
.
click
(
)
;
await
waitForNetworkUpdates
(
toolbox
)
;
await
testNetworkMessage
(
messageNode
)
;
}
)
;
async
function
testNetworkMessage
(
messageNode
)
{
let
headersTab
=
messageNode
.
querySelector
(
"
#
headers
-
tab
"
)
;
let
cookiesTab
=
messageNode
.
querySelector
(
"
#
cookies
-
tab
"
)
;
let
paramsTab
=
messageNode
.
querySelector
(
"
#
params
-
tab
"
)
;
let
responseTab
=
messageNode
.
querySelector
(
"
#
response
-
tab
"
)
;
let
timingsTab
=
messageNode
.
querySelector
(
"
#
timings
-
tab
"
)
;
ok
(
headersTab
"
Headers
tab
is
available
"
)
;
ok
(
cookiesTab
"
Cookies
tab
is
available
"
)
;
ok
(
paramsTab
"
Params
tab
is
available
"
)
;
ok
(
responseTab
"
Response
tab
is
available
"
)
;
ok
(
timingsTab
"
Timings
tab
is
available
"
)
;
let
headersContent
=
messageNode
.
querySelector
(
"
#
headers
-
panel
.
headers
-
overview
"
)
;
ok
(
headersContent
"
Headers
content
is
available
"
)
;
timingsTab
.
click
(
)
;
let
timingsContent
=
messageNode
.
querySelector
(
"
#
timings
-
panel
.
timings
-
container
.
timings
-
label
"
)
;
ok
(
timingsContent
"
Timings
content
is
available
"
)
;
ok
(
timingsContent
.
textContent
"
Timings
text
is
available
"
)
;
}
async
function
waitForNetworkUpdates
(
toolbox
)
{
let
panel
=
toolbox
.
getCurrentPanel
(
)
;
let
hud
=
panel
.
hud
;
let
ui
=
hud
.
ui
;
return
new
Promise
(
resolve
=
>
{
ui
.
jsterm
.
hud
.
on
(
"
network
-
request
-
payload
-
ready
"
(
)
=
>
{
info
(
"
network
-
request
-
payload
-
ready
received
"
)
;
resolve
(
)
;
}
)
;
}
)
;
}
