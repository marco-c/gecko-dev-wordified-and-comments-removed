"
use
strict
"
;
const
TEST_URI
=
"
data
:
text
/
html
;
charset
=
utf8
<
p
>
test
cached
autocompletion
results
"
;
add_task
(
async
function
(
)
{
let
{
jsterm
}
=
await
openNewTabAndConsole
(
TEST_URI
)
;
const
{
autocompletePopup
:
popup
completeNode
inputNode
:
input
}
=
jsterm
;
const
jstermComplete
=
(
value
delta
)
=
>
complete
(
jsterm
input
value
delta
)
;
await
jstermComplete
(
"
doc
"
)
;
is
(
input
.
value
"
doc
"
"
'
docu
'
completion
(
input
.
value
)
"
)
;
is
(
completeNode
.
value
"
ument
"
"
'
docu
'
completion
(
completeNode
)
"
)
;
await
jstermComplete
(
"
window
.
"
)
;
ok
(
popup
.
getItems
(
)
.
length
>
0
"
'
window
.
'
gave
a
list
of
suggestions
"
)
;
await
jsterm
.
execute
(
"
window
.
docfoobar
=
true
"
)
;
await
jstermComplete
(
"
window
.
doc
"
)
;
ok
(
!
getPopupLabels
(
popup
)
.
includes
(
"
docfoobar
"
)
"
autocomplete
cached
results
do
not
contain
docfoobar
.
list
has
not
been
updated
"
)
;
await
jstermComplete
(
"
window
.
do
"
)
;
ok
(
!
getPopupLabels
(
popup
)
.
includes
(
"
docfoobar
"
)
"
autocomplete
cached
results
do
not
contain
docfoobar
.
list
has
not
been
updated
"
)
;
await
jsterm
.
execute
(
"
delete
window
.
docfoobar
"
)
;
await
jstermComplete
(
"
window
.
"
)
;
await
jstermComplete
(
"
window
.
getC
"
)
;
ok
(
getPopupLabels
(
popup
)
.
includes
(
"
getComputedStyle
"
)
"
autocomplete
results
do
contain
getComputedStyle
"
)
;
await
jstermComplete
(
"
dump
(
d
"
)
;
ok
(
popup
.
getItems
(
)
.
length
>
0
"
'
dump
(
d
'
gives
non
-
zero
results
"
)
;
await
jstermComplete
(
"
dump
(
window
.
)
"
-
1
)
;
ok
(
popup
.
getItems
(
)
.
length
>
0
"
'
dump
(
window
.
'
gave
a
list
of
suggestions
"
)
;
await
jsterm
.
execute
(
"
window
.
docfoobar
=
true
"
)
;
await
jstermComplete
(
"
dump
(
window
.
doc
)
"
-
1
)
;
ok
(
!
getPopupLabels
(
popup
)
.
includes
(
"
docfoobar
"
)
"
autocomplete
cached
results
do
not
contain
docfoobar
.
list
has
not
been
updated
"
)
;
}
)
;
function
complete
(
jsterm
input
value
caretIndexDelta
=
0
)
{
input
.
value
=
value
;
let
index
=
value
.
length
+
caretIndexDelta
;
input
.
setSelectionRange
(
index
index
)
;
const
updated
=
jsterm
.
once
(
"
autocomplete
-
updated
"
)
;
jsterm
.
complete
(
jsterm
.
COMPLETE_HINT_ONLY
)
;
return
updated
;
}
function
getPopupLabels
(
popup
)
{
return
popup
.
getItems
(
)
.
map
(
item
=
>
item
.
label
)
;
}
