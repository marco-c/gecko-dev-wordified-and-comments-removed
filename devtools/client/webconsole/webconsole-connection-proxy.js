"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
l10n
=
require
(
"
devtools
/
client
/
webconsole
/
utils
/
l10n
"
)
;
const
{
safeAsyncMethod
}
=
require
(
"
devtools
/
shared
/
async
-
utils
"
)
;
const
PREF_CONNECTION_TIMEOUT
=
"
devtools
.
debugger
.
remote
-
timeout
"
;
class
WebConsoleConnectionProxy
{
constructor
(
webConsoleUI
target
)
{
this
.
webConsoleUI
=
webConsoleUI
;
this
.
target
=
target
;
this
.
_connecter
=
null
;
this
.
_onLastPrivateContextExited
=
this
.
_onLastPrivateContextExited
.
bind
(
this
)
;
this
.
_asyncConnect
=
safeAsyncMethod
(
this
.
_asyncConnect
.
bind
(
this
)
(
)
=
>
this
.
target
.
isDestroyed
(
)
)
;
}
connect
(
)
{
if
(
this
.
_connecter
)
{
return
this
.
_connecter
;
}
if
(
this
.
target
.
isDestroyed
(
)
)
{
return
Promise
.
reject
(
"
target
was
destroyed
"
)
;
}
const
connection
=
this
.
_asyncConnect
(
)
;
let
timeoutId
;
const
connectionTimeout
=
new
Promise
(
(
_
reject
)
=
>
{
timeoutId
=
setTimeout
(
(
)
=
>
{
reject
(
{
error
:
"
timeout
"
message
:
l10n
.
getStr
(
"
connectionTimeout
"
)
}
)
;
}
Services
.
prefs
.
getIntPref
(
PREF_CONNECTION_TIMEOUT
)
)
;
}
)
;
this
.
_connecter
=
Promise
.
race
(
[
connection
connectionTimeout
]
)
;
connection
.
then
(
(
)
=
>
clearTimeout
(
timeoutId
)
)
;
return
this
.
_connecter
;
}
async
_asyncConnect
(
)
{
this
.
webConsoleFront
=
await
this
.
target
.
getFront
(
"
console
"
)
;
const
{
targetCommand
resourceCommand
}
=
this
.
webConsoleUI
.
hud
.
commands
;
const
hasNetworkResourceCommandSupport
=
resourceCommand
.
hasResourceCommandSupport
(
resourceCommand
.
TYPES
.
NETWORK_EVENT
)
;
const
supportsWatcherRequest
=
targetCommand
.
hasTargetWatcherSupport
(
"
saveRequestAndResponseBodies
"
)
;
if
(
!
hasNetworkResourceCommandSupport
|
|
!
supportsWatcherRequest
)
{
const
saveBodies
=
!
this
.
webConsoleUI
.
isBrowserConsole
&
&
Services
.
prefs
.
getBoolPref
(
"
devtools
.
netmonitor
.
saveRequestAndResponseBodies
"
)
;
await
this
.
setSaveRequestAndResponseBodies
(
saveBodies
)
;
}
this
.
_addWebConsoleFrontEventListeners
(
)
;
}
getConnectionPromise
(
)
{
return
this
.
_connecter
;
}
async
setSaveRequestAndResponseBodies
(
value
)
{
if
(
!
this
.
webConsoleFront
)
{
return
null
;
}
const
newValue
=
!
!
value
;
const
toSet
=
{
"
NetworkMonitor
.
saveRequestAndResponseBodies
"
:
newValue
}
;
return
this
.
webConsoleFront
.
setPreferences
(
toSet
)
;
}
_addWebConsoleFrontEventListeners
(
)
{
if
(
!
this
.
webConsoleFront
)
{
return
;
}
this
.
webConsoleFront
.
on
(
"
lastPrivateContextExited
"
this
.
_onLastPrivateContextExited
)
;
}
_removeWebConsoleFrontEventListeners
(
)
{
this
.
webConsoleFront
.
off
(
"
lastPrivateContextExited
"
this
.
_onLastPrivateContextExited
)
;
}
_onLastPrivateContextExited
(
packet
)
{
if
(
this
.
webConsoleUI
)
{
this
.
webConsoleUI
.
clearPrivateMessages
(
)
;
}
}
disconnect
(
)
{
if
(
!
this
.
webConsoleFront
)
{
return
;
}
this
.
_removeWebConsoleFrontEventListeners
(
)
;
this
.
webConsoleFront
=
null
;
}
}
exports
.
WebConsoleConnectionProxy
=
WebConsoleConnectionProxy
;
