"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
l10n
=
require
(
"
devtools
/
client
/
webconsole
/
utils
/
l10n
"
)
;
const
PREF_CONNECTION_TIMEOUT
=
"
devtools
.
debugger
.
remote
-
timeout
"
;
class
WebConsoleConnectionProxy
{
constructor
(
webConsoleUI
target
needContentProcessMessagesListener
=
false
)
{
this
.
webConsoleUI
=
webConsoleUI
;
this
.
target
=
target
;
this
.
needContentProcessMessagesListener
=
needContentProcessMessagesListener
;
this
.
_connecter
=
null
;
this
.
_onPageError
=
this
.
_onPageError
.
bind
(
this
)
;
this
.
_onLogMessage
=
this
.
_onLogMessage
.
bind
(
this
)
;
this
.
_onConsoleAPICall
=
this
.
_onConsoleAPICall
.
bind
(
this
)
;
this
.
_onNetworkEvent
=
this
.
_onNetworkEvent
.
bind
(
this
)
;
this
.
_onNetworkEventUpdate
=
this
.
_onNetworkEventUpdate
.
bind
(
this
)
;
this
.
_onTabNavigated
=
this
.
_onTabNavigated
.
bind
(
this
)
;
this
.
_onTabWillNavigate
=
this
.
_onTabWillNavigate
.
bind
(
this
)
;
this
.
_onLastPrivateContextExited
=
this
.
_onLastPrivateContextExited
.
bind
(
this
)
;
this
.
_clearLogpointMessages
=
this
.
_clearLogpointMessages
.
bind
(
this
)
;
}
connect
(
)
{
if
(
this
.
_connecter
)
{
return
this
.
_connecter
;
}
this
.
target
.
on
(
"
will
-
navigate
"
this
.
_onTabWillNavigate
)
;
this
.
target
.
on
(
"
navigate
"
this
.
_onTabNavigated
)
;
const
connection
=
(
async
(
)
=
>
{
this
.
client
=
this
.
target
.
client
;
this
.
webConsoleClient
=
await
this
.
target
.
getFront
(
"
console
"
)
;
this
.
_addWebConsoleClientEventListeners
(
)
;
await
this
.
_attachConsole
(
)
;
const
saveBodies
=
!
this
.
webConsoleUI
.
isBrowserConsole
&
&
Services
.
prefs
.
getBoolPref
(
"
devtools
.
netmonitor
.
saveRequestAndResponseBodies
"
)
;
await
this
.
webConsoleUI
.
setSaveRequestAndResponseBodies
(
saveBodies
)
;
const
cachedMessages
=
await
this
.
_getCachedMessages
(
)
;
const
networkMessages
=
this
.
_getNetworkMessages
(
)
;
const
messages
=
cachedMessages
.
concat
(
networkMessages
)
;
messages
.
sort
(
(
a
b
)
=
>
a
.
timeStamp
-
b
.
timeStamp
)
;
this
.
dispatchMessagesAdd
(
messages
)
;
if
(
!
this
.
webConsoleClient
.
hasNativeConsoleAPI
)
{
await
this
.
webConsoleUI
.
logWarningAboutReplacedAPI
(
)
;
}
}
)
(
)
;
let
timeoutId
;
const
connectionTimeout
=
new
Promise
(
(
_
reject
)
=
>
{
timeoutId
=
setTimeout
(
(
)
=
>
{
reject
(
{
error
:
"
timeout
"
message
:
l10n
.
getStr
(
"
connectionTimeout
"
)
}
)
;
}
Services
.
prefs
.
getIntPref
(
PREF_CONNECTION_TIMEOUT
)
)
;
}
)
;
this
.
_connecter
=
Promise
.
race
(
[
connection
connectionTimeout
]
)
;
connection
.
then
(
(
)
=
>
clearTimeout
(
timeoutId
)
)
;
return
this
.
_connecter
;
}
_attachConsole
(
)
{
const
listeners
=
[
"
PageError
"
"
ConsoleAPI
"
"
NetworkActivity
"
]
;
if
(
this
.
needContentProcessMessagesListener
)
{
listeners
.
push
(
"
ContentProcessMessages
"
)
;
}
return
this
.
webConsoleClient
.
startListeners
(
listeners
)
;
}
_addWebConsoleClientEventListeners
(
)
{
this
.
webConsoleClient
.
on
(
"
networkEvent
"
this
.
_onNetworkEvent
)
;
this
.
webConsoleClient
.
on
(
"
networkEventUpdate
"
this
.
_onNetworkEventUpdate
)
;
this
.
webConsoleClient
.
on
(
"
logMessage
"
this
.
_onLogMessage
)
;
this
.
webConsoleClient
.
on
(
"
pageError
"
this
.
_onPageError
)
;
this
.
webConsoleClient
.
on
(
"
consoleAPICall
"
this
.
_onConsoleAPICall
)
;
this
.
webConsoleClient
.
on
(
"
lastPrivateContextExited
"
this
.
_onLastPrivateContextExited
)
;
this
.
webConsoleClient
.
on
(
"
clearLogpointMessages
"
this
.
_clearLogpointMessages
)
;
}
_removeWebConsoleClientEventListeners
(
)
{
this
.
webConsoleClient
.
off
(
"
networkEvent
"
this
.
_onNetworkEvent
)
;
this
.
webConsoleClient
.
off
(
"
networkEventUpdate
"
this
.
_onNetworkEventUpdate
)
;
this
.
webConsoleClient
.
off
(
"
logMessage
"
this
.
_onLogMessage
)
;
this
.
webConsoleClient
.
off
(
"
pageError
"
this
.
_onPageError
)
;
this
.
webConsoleClient
.
off
(
"
consoleAPICall
"
this
.
_onConsoleAPICall
)
;
this
.
webConsoleClient
.
off
(
"
lastPrivateContextExited
"
this
.
_onLastPrivateContextExited
)
;
this
.
webConsoleClient
.
off
(
"
clearLogpointMessages
"
this
.
_clearLogpointMessages
)
;
}
async
_getCachedMessages
(
)
{
const
response
=
await
this
.
webConsoleClient
.
getCachedMessages
(
[
"
PageError
"
"
ConsoleAPI
"
]
)
;
if
(
response
.
error
)
{
throw
new
Error
(
Web
Console
getCachedMessages
error
:
{
response
.
error
}
{
response
.
message
}
)
;
}
return
response
.
messages
;
}
_getNetworkMessages
(
)
{
return
Array
.
from
(
this
.
webConsoleClient
.
getNetworkEvents
(
)
)
;
}
_onPageError
(
packet
)
{
if
(
!
this
.
webConsoleUI
)
{
return
;
}
packet
.
type
=
"
pageError
"
;
this
.
dispatchMessageAdd
(
packet
)
;
}
_onLogMessage
(
packet
)
{
if
(
!
this
.
webConsoleUI
)
{
return
;
}
packet
.
type
=
"
logMessage
"
;
this
.
dispatchMessageAdd
(
packet
)
;
}
_onConsoleAPICall
(
packet
)
{
if
(
!
this
.
webConsoleUI
)
{
return
;
}
packet
.
type
=
"
consoleAPICall
"
;
this
.
dispatchMessageAdd
(
packet
)
;
}
_clearLogpointMessages
(
logpointId
)
{
if
(
this
.
webConsoleUI
)
{
this
.
webConsoleUI
.
wrapper
.
dispatchClearLogpointMessages
(
logpointId
)
;
}
}
_onNetworkEvent
(
networkInfo
)
{
if
(
!
this
.
webConsoleUI
)
{
return
;
}
this
.
dispatchMessageAdd
(
networkInfo
)
;
}
_onNetworkEventUpdate
(
response
)
{
if
(
!
this
.
webConsoleUI
)
{
return
;
}
this
.
dispatchMessageUpdate
(
response
.
networkInfo
response
)
;
}
_onLastPrivateContextExited
(
packet
)
{
if
(
this
.
webConsoleUI
)
{
this
.
webConsoleUI
.
clearPrivateMessages
(
)
;
}
}
_onTabNavigated
(
packet
)
{
this
.
webConsoleUI
.
handleTabNavigated
(
packet
)
;
}
_onTabWillNavigate
(
packet
)
{
this
.
webConsoleUI
.
handleTabWillNavigate
(
packet
)
;
}
dispatchMessageAdd
(
packet
)
{
this
.
webConsoleUI
.
wrapper
.
dispatchMessageAdd
(
packet
)
;
}
dispatchMessagesAdd
(
packets
)
{
this
.
webConsoleUI
.
wrapper
.
dispatchMessagesAdd
(
packets
)
;
}
dispatchMessageUpdate
(
networkInfo
response
)
{
if
(
!
this
.
webConsoleUI
)
{
return
;
}
this
.
webConsoleUI
.
wrapper
.
dispatchMessageUpdate
(
networkInfo
response
)
;
}
releaseActor
(
actor
)
{
if
(
this
.
client
)
{
this
.
client
.
release
(
actor
)
.
catch
(
(
)
=
>
{
}
)
;
}
}
disconnect
(
)
{
if
(
!
this
.
client
)
{
return
;
}
this
.
_removeWebConsoleClientEventListeners
(
)
;
this
.
target
.
off
(
"
will
-
navigate
"
this
.
_onTabWillNavigate
)
;
this
.
target
.
off
(
"
navigate
"
this
.
_onTabNavigated
)
;
this
.
client
=
null
;
this
.
webConsoleClient
=
null
;
this
.
webConsoleUI
=
null
;
}
}
exports
.
WebConsoleConnectionProxy
=
WebConsoleConnectionProxy
;
