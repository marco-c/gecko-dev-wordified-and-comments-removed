"
use
strict
"
;
const
defer
=
require
(
"
devtools
/
shared
/
defer
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
l10n
=
require
(
"
devtools
/
client
/
webconsole
/
webconsole
-
l10n
"
)
;
const
PREF_CONNECTION_TIMEOUT
=
"
devtools
.
debugger
.
remote
-
timeout
"
;
function
WebConsoleConnectionProxy
(
webConsoleFrame
target
)
{
this
.
webConsoleFrame
=
webConsoleFrame
;
this
.
target
=
target
;
this
.
webConsoleClient
=
target
.
activeConsole
;
this
.
_onPageError
=
this
.
_onPageError
.
bind
(
this
)
;
this
.
_onLogMessage
=
this
.
_onLogMessage
.
bind
(
this
)
;
this
.
_onConsoleAPICall
=
this
.
_onConsoleAPICall
.
bind
(
this
)
;
this
.
_onVirtualConsoleLog
=
this
.
_onVirtualConsoleLog
.
bind
(
this
)
;
this
.
_onNetworkEvent
=
this
.
_onNetworkEvent
.
bind
(
this
)
;
this
.
_onNetworkEventUpdate
=
this
.
_onNetworkEventUpdate
.
bind
(
this
)
;
this
.
_onTabNavigated
=
this
.
_onTabNavigated
.
bind
(
this
)
;
this
.
_onTabWillNavigate
=
this
.
_onTabWillNavigate
.
bind
(
this
)
;
this
.
_onAttachConsole
=
this
.
_onAttachConsole
.
bind
(
this
)
;
this
.
_onCachedMessages
=
this
.
_onCachedMessages
.
bind
(
this
)
;
this
.
_connectionTimeout
=
this
.
_connectionTimeout
.
bind
(
this
)
;
this
.
_onLastPrivateContextExited
=
this
.
_onLastPrivateContextExited
.
bind
(
this
)
;
}
WebConsoleConnectionProxy
.
prototype
=
{
webConsoleFrame
:
null
target
:
null
client
:
null
webConsoleClient
:
null
connected
:
false
isAttached
:
null
_connectTimer
:
null
_connectDefer
:
null
_disconnecter
:
null
connect
:
function
(
)
{
if
(
this
.
_connectDefer
)
{
return
this
.
_connectDefer
.
promise
;
}
this
.
_connectDefer
=
defer
(
)
;
const
timeout
=
Services
.
prefs
.
getIntPref
(
PREF_CONNECTION_TIMEOUT
)
;
this
.
_connectTimer
=
setTimeout
(
this
.
_connectionTimeout
timeout
)
;
const
connPromise
=
this
.
_connectDefer
.
promise
;
connPromise
.
then
(
(
)
=
>
{
clearTimeout
(
this
.
_connectTimer
)
;
this
.
_connectTimer
=
null
;
}
(
)
=
>
{
clearTimeout
(
this
.
_connectTimer
)
;
this
.
_connectTimer
=
null
;
}
)
;
const
client
=
this
.
client
=
this
.
target
.
client
;
client
.
addListener
(
"
logMessage
"
this
.
_onLogMessage
)
;
client
.
addListener
(
"
pageError
"
this
.
_onPageError
)
;
client
.
addListener
(
"
consoleAPICall
"
this
.
_onConsoleAPICall
)
;
client
.
addListener
(
"
lastPrivateContextExited
"
this
.
_onLastPrivateContextExited
)
;
client
.
addListener
(
"
virtualConsoleLog
"
this
.
_onVirtualConsoleLog
)
;
this
.
target
.
on
(
"
will
-
navigate
"
this
.
_onTabWillNavigate
)
;
this
.
target
.
on
(
"
navigate
"
this
.
_onTabNavigated
)
;
if
(
this
.
target
.
isBrowsingContext
)
{
this
.
webConsoleFrame
.
onLocationChange
(
this
.
target
.
url
this
.
target
.
title
)
;
}
this
.
isAttached
=
this
.
_attachConsole
(
)
;
return
connPromise
;
}
_connectionTimeout
:
function
(
)
{
const
error
=
{
error
:
"
timeout
"
message
:
l10n
.
getStr
(
"
connectionTimeout
"
)
}
;
this
.
_connectDefer
.
reject
(
error
)
;
}
_attachConsole
:
function
(
)
{
const
listeners
=
[
"
PageError
"
"
ConsoleAPI
"
"
NetworkActivity
"
]
;
if
(
this
.
target
.
chrome
&
&
!
this
.
target
.
isAddon
)
{
listeners
.
push
(
"
ContentProcessMessages
"
)
;
}
return
this
.
webConsoleClient
.
startListeners
(
listeners
)
.
then
(
this
.
_onAttachConsole
error
=
>
{
console
.
error
(
"
attachConsole
failed
:
"
+
error
)
;
this
.
_connectDefer
.
reject
(
error
)
;
}
)
;
}
_onAttachConsole
:
async
function
(
response
)
{
let
saveBodies
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
netmonitor
.
saveRequestAndResponseBodies
"
)
;
if
(
this
.
webConsoleFrame
.
isBrowserConsole
)
{
saveBodies
=
false
;
}
this
.
webConsoleFrame
.
setSaveRequestAndResponseBodies
(
saveBodies
)
;
this
.
webConsoleClient
.
on
(
"
networkEvent
"
this
.
_onNetworkEvent
)
;
this
.
webConsoleClient
.
on
(
"
networkEventUpdate
"
this
.
_onNetworkEventUpdate
)
;
const
msgs
=
[
"
PageError
"
"
ConsoleAPI
"
]
;
const
cachedMessages
=
await
this
.
webConsoleClient
.
getCachedMessages
(
msgs
)
;
this
.
_onCachedMessages
(
cachedMessages
)
;
this
.
webConsoleFrame
.
_onUpdateListeners
(
)
;
}
dispatchMessageAdd
:
function
(
packet
)
{
this
.
webConsoleFrame
.
consoleOutput
.
dispatchMessageAdd
(
packet
)
;
}
dispatchMessagesAdd
:
function
(
packets
)
{
this
.
webConsoleFrame
.
consoleOutput
.
dispatchMessagesAdd
(
packets
)
;
}
dispatchMessageUpdate
:
function
(
networkInfo
response
)
{
this
.
webConsoleFrame
.
consoleOutput
.
dispatchMessageUpdate
(
networkInfo
response
)
;
}
dispatchRequestUpdate
:
function
(
id
data
)
{
this
.
webConsoleFrame
.
consoleOutput
.
dispatchRequestUpdate
(
id
data
)
;
}
_onCachedMessages
:
async
function
(
response
)
{
if
(
response
.
error
)
{
console
.
error
(
"
Web
Console
getCachedMessages
error
:
"
+
response
.
error
+
"
"
+
response
.
message
)
;
this
.
_connectDefer
.
reject
(
response
)
;
return
;
}
if
(
!
this
.
_connectTimer
)
{
console
.
error
(
"
Web
Console
getCachedMessages
error
:
invalid
state
.
"
)
;
}
const
messages
=
response
.
messages
.
concat
(
.
.
.
this
.
webConsoleClient
.
getNetworkEvents
(
)
)
;
messages
.
sort
(
(
a
b
)
=
>
a
.
timeStamp
-
b
.
timeStamp
)
;
this
.
dispatchMessagesAdd
(
messages
)
;
if
(
!
this
.
webConsoleClient
.
hasNativeConsoleAPI
)
{
await
this
.
webConsoleFrame
.
logWarningAboutReplacedAPI
(
)
;
}
this
.
connected
=
true
;
this
.
_connectDefer
.
resolve
(
this
)
;
}
_onPageError
:
function
(
type
packet
)
{
if
(
!
this
.
webConsoleFrame
|
|
packet
.
from
!
=
this
.
webConsoleClient
.
actor
)
{
return
;
}
this
.
dispatchMessageAdd
(
packet
)
;
}
_onLogMessage
:
function
(
type
packet
)
{
if
(
!
this
.
webConsoleFrame
|
|
packet
.
from
!
=
this
.
webConsoleClient
.
actor
)
{
return
;
}
this
.
dispatchMessageAdd
(
packet
)
;
}
_onConsoleAPICall
:
function
(
type
packet
)
{
if
(
!
this
.
webConsoleFrame
|
|
packet
.
from
!
=
this
.
webConsoleClient
.
actor
)
{
return
;
}
this
.
dispatchMessageAdd
(
packet
)
;
}
_onVirtualConsoleLog
:
function
(
type
packet
)
{
if
(
!
this
.
webConsoleFrame
)
{
return
;
}
this
.
dispatchMessageAdd
(
{
type
:
"
consoleAPICall
"
message
:
{
executionPoint
:
packet
.
executionPoint
"
arguments
"
:
[
packet
.
url
+
"
:
"
+
packet
.
line
packet
.
message
]
}
}
)
;
}
_onNetworkEvent
:
function
(
networkInfo
)
{
if
(
!
this
.
webConsoleFrame
)
{
return
;
}
this
.
dispatchMessageAdd
(
networkInfo
)
;
}
_onNetworkEventUpdate
:
function
(
response
)
{
if
(
!
this
.
webConsoleFrame
)
{
return
;
}
this
.
dispatchMessageUpdate
(
response
.
networkInfo
response
)
;
}
_onLastPrivateContextExited
:
function
(
type
packet
)
{
if
(
this
.
webConsoleFrame
&
&
packet
.
from
=
=
this
.
webConsoleClient
.
actor
)
{
this
.
webConsoleFrame
.
clearPrivateMessages
(
)
;
}
}
_onTabNavigated
:
function
(
packet
)
{
if
(
!
this
.
webConsoleFrame
)
{
return
;
}
this
.
webConsoleFrame
.
handleTabNavigated
(
packet
)
;
}
_onTabWillNavigate
:
function
(
packet
)
{
if
(
!
this
.
webConsoleFrame
)
{
return
;
}
this
.
webConsoleFrame
.
handleTabWillNavigate
(
packet
)
;
}
releaseActor
:
function
(
actor
)
{
if
(
this
.
client
)
{
this
.
client
.
release
(
actor
)
;
}
}
disconnect
:
async
function
(
)
{
if
(
this
.
_disconnecter
)
{
return
this
.
_disconnecter
.
promise
;
}
this
.
_disconnecter
=
defer
(
)
;
if
(
this
.
isAttached
)
{
await
this
.
isAttached
;
}
if
(
!
this
.
client
)
{
this
.
_disconnecter
.
resolve
(
null
)
;
return
this
.
_disconnecter
.
promise
;
}
this
.
client
.
removeListener
(
"
logMessage
"
this
.
_onLogMessage
)
;
this
.
client
.
removeListener
(
"
pageError
"
this
.
_onPageError
)
;
this
.
client
.
removeListener
(
"
consoleAPICall
"
this
.
_onConsoleAPICall
)
;
this
.
client
.
removeListener
(
"
lastPrivateContextExited
"
this
.
_onLastPrivateContextExited
)
;
this
.
client
.
removeListener
(
"
virtualConsoleLog
"
this
.
_onVirtualConsoleLog
)
;
this
.
webConsoleClient
.
off
(
"
networkEvent
"
this
.
_onNetworkEvent
)
;
this
.
webConsoleClient
.
off
(
"
networkEventUpdate
"
this
.
_onNetworkEventUpdate
)
;
this
.
target
.
off
(
"
will
-
navigate
"
this
.
_onTabWillNavigate
)
;
this
.
target
.
off
(
"
navigate
"
this
.
_onTabNavigated
)
;
this
.
client
=
null
;
this
.
webConsoleClient
=
null
;
this
.
target
=
null
;
this
.
connected
=
false
;
this
.
webConsoleFrame
=
null
;
this
.
_disconnecter
.
resolve
(
null
)
;
return
this
.
_disconnecter
.
promise
;
}
}
;
exports
.
WebConsoleConnectionProxy
=
WebConsoleConnectionProxy
;
