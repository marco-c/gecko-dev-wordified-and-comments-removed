"
use
strict
"
;
const
TEST_URI
=
"
http
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
webconsole
/
old
/
"
+
"
test
/
test
-
console
.
html
?
"
+
Date
.
now
(
)
;
const
TEST_FILE
=
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
client
/
"
+
"
webconsole
/
old
/
test
/
test
-
cu
-
reporterror
.
js
"
;
const
TEST_XHR_ERROR_URI
=
http
:
/
/
example
.
com
/
404
.
html
?
{
Date
.
now
(
)
}
;
const
TEST_IMAGE
=
"
http
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
webconsole
/
old
/
"
+
"
test
/
test
-
image
.
png
"
;
const
ObjectClient
=
require
(
"
devtools
/
shared
/
client
/
object
-
client
"
)
;
add_task
(
function
*
(
)
{
yield
loadTab
(
TEST_URI
)
;
let
opened
=
waitForBrowserConsole
(
)
;
let
hud
=
HUDService
.
getBrowserConsole
(
)
;
ok
(
!
hud
"
browser
console
is
not
open
"
)
;
info
(
"
wait
for
the
browser
console
to
open
with
ctrl
-
shift
-
j
"
)
;
EventUtils
.
synthesizeKey
(
"
j
"
{
accelKey
:
true
shiftKey
:
true
}
window
)
;
hud
=
yield
opened
;
ok
(
hud
"
browser
console
opened
"
)
;
yield
testMessages
(
hud
)
;
yield
testCPOWInspection
(
hud
)
;
}
)
;
function
testMessages
(
hud
)
{
hud
.
jsterm
.
clearOutput
(
true
)
;
expectUncaughtException
(
)
;
executeSoon
(
(
)
=
>
{
foobarExceptionBug587757
(
)
;
}
)
;
hud
.
iframeWindow
.
console
.
log
(
"
bug587757a
"
)
;
Services
.
scriptloader
.
loadSubScript
(
TEST_FILE
hud
.
iframeWindow
)
;
let
sandbox
=
new
Cu
.
Sandbox
(
null
{
wantComponents
:
false
wantGlobalProperties
:
[
"
URL
"
"
URLSearchParams
"
]
}
)
;
let
error
=
Cu
.
evalInSandbox
(
new
Error
(
"
1348885
"
)
;
sandbox
)
;
Cu
.
reportError
(
error
)
;
Cu
.
nukeSandbox
(
sandbox
)
;
gBrowser
.
contentWindowAsCPOW
.
console
.
log
(
"
bug587757b
"
)
;
hud
.
jsterm
.
execute
(
"
document
.
location
.
href
"
)
;
hud
.
jsterm
.
execute
(
gBrowser
.
selectedBrowser
.
messageManager
.
loadFrameScript
(
'
data
:
application
/
javascript
console
.
log
(
"
framescript
-
message
"
)
'
false
)
;
"
framescript
-
eval
"
;
)
;
let
xhr
=
new
XMLHttpRequest
(
)
;
xhr
.
onload
=
(
)
=
>
console
.
log
(
"
xhr
loaded
status
is
:
"
+
xhr
.
status
)
;
xhr
.
open
(
"
get
"
TEST_URI
true
)
;
xhr
.
send
(
)
;
let
xhrErr
=
new
XMLHttpRequest
(
)
;
xhrErr
.
onload
=
(
)
=
>
{
console
.
log
(
"
xhr
error
loaded
status
is
:
"
+
xhrErr
.
status
)
;
}
;
xhrErr
.
open
(
"
get
"
TEST_XHR_ERROR_URI
true
)
;
xhrErr
.
send
(
)
;
fetch
(
TEST_IMAGE
)
.
then
(
(
)
=
>
{
console
.
log
(
"
fetch
loaded
"
)
;
}
)
;
return
waitForMessages
(
{
webconsole
:
hud
messages
:
[
{
name
:
"
chrome
window
console
.
log
(
)
is
displayed
"
text
:
"
bug587757a
"
category
:
CATEGORY_WEBDEV
severity
:
SEVERITY_LOG
}
{
name
:
"
Cu
.
reportError
is
displayed
"
text
:
"
bug1141222
"
category
:
CATEGORY_JS
severity
:
SEVERITY_ERROR
stacktrace
:
[
{
file
:
TEST_FILE
line
:
2
}
{
file
:
TEST_FILE
line
:
4
}
]
}
{
name
:
"
Error
from
nuked
global
works
"
text
:
"
1348885
"
category
:
CATEGORY_JS
severity
:
SEVERITY_ERROR
}
{
name
:
"
content
window
console
.
log
(
)
is
displayed
"
text
:
"
bug587757b
"
category
:
CATEGORY_WEBDEV
severity
:
SEVERITY_LOG
}
{
name
:
"
jsterm
eval
result
"
text
:
"
browser
.
xul
"
category
:
CATEGORY_OUTPUT
severity
:
SEVERITY_LOG
}
{
name
:
"
jsterm
eval
result
2
"
text
:
"
framescript
-
eval
"
category
:
CATEGORY_OUTPUT
severity
:
SEVERITY_LOG
}
{
name
:
"
frame
script
message
"
text
:
"
framescript
-
message
"
category
:
CATEGORY_WEBDEV
severity
:
SEVERITY_LOG
}
{
name
:
"
exception
message
"
text
:
"
foobarExceptionBug587757
"
category
:
CATEGORY_JS
severity
:
SEVERITY_ERROR
}
{
name
:
"
network
message
"
text
:
"
test
-
console
.
html
"
category
:
CATEGORY_NETWORK
severity
:
SEVERITY_INFO
isXhr
:
true
}
{
name
:
"
xhr
error
message
"
text
:
"
404
.
html
"
category
:
CATEGORY_NETWORK
severity
:
SEVERITY_ERROR
isXhr
:
true
}
{
name
:
"
network
message
"
text
:
"
test
-
image
.
png
"
category
:
CATEGORY_NETWORK
severity
:
SEVERITY_INFO
isXhr
:
true
}
]
}
)
;
}
function
*
testCPOWInspection
(
hud
)
{
let
cpowEval
=
yield
hud
.
jsterm
.
requestEvaluation
(
"
gBrowser
.
selectedBrowser
"
)
;
info
(
"
Creating
an
ObjectClient
with
:
"
+
cpowEval
.
result
.
actor
)
;
let
objectClient
=
new
ObjectClient
(
hud
.
jsterm
.
hud
.
proxy
.
client
{
actor
:
cpowEval
.
result
.
actor
}
)
;
let
prototypeAndProperties
=
yield
objectClient
.
getPrototypeAndProperties
(
)
;
is
(
prototypeAndProperties
.
prototype
.
class
"
XBL
prototype
JSClass
"
"
Looks
like
a
valid
response
"
)
;
let
cpow
=
prototypeAndProperties
.
ownProperties
.
_contentWindow
.
value
;
let
e10sCheck
=
yield
hud
.
jsterm
.
requestEvaluation
(
"
Cu
.
isCrossProcessWrapper
(
gBrowser
.
selectedBrowser
.
_contentWindow
)
"
)
;
if
(
!
e10sCheck
.
result
)
{
is
(
cpow
.
class
"
Window
"
"
The
object
is
not
a
CPOW
.
"
)
;
return
;
}
is
(
cpow
.
class
"
CPOW
:
Window
"
"
The
CPOW
grip
has
the
right
class
.
"
)
;
let
response
slice
;
let
objClient
=
new
ObjectClient
(
hud
.
jsterm
.
hud
.
proxy
.
client
cpow
)
;
response
=
yield
objClient
.
getPrototypeAndProperties
(
)
;
is
(
Reflect
.
ownKeys
(
response
.
ownProperties
)
.
length
0
"
No
property
was
retrieved
.
"
)
;
is
(
response
.
ownSymbols
.
length
0
"
No
symbol
property
was
retrieved
.
"
)
;
is
(
response
.
prototype
.
type
"
null
"
"
The
prototype
is
null
.
"
)
;
response
=
yield
objClient
.
enumProperties
(
{
ignoreIndexedProperties
:
true
}
)
;
slice
=
yield
response
.
iterator
.
slice
(
0
response
.
iterator
.
count
)
;
is
(
Reflect
.
ownKeys
(
slice
.
ownProperties
)
.
length
0
"
No
property
was
retrieved
.
"
)
;
response
=
yield
objClient
.
enumProperties
(
{
}
)
;
slice
=
yield
response
.
iterator
.
slice
(
0
response
.
iterator
.
count
)
;
is
(
Reflect
.
ownKeys
(
slice
.
ownProperties
)
.
length
0
"
No
property
was
retrieved
.
"
)
;
response
=
yield
objClient
.
getOwnPropertyNames
(
)
;
is
(
response
.
ownPropertyNames
.
length
0
"
No
property
was
retrieved
.
"
)
;
response
=
yield
objClient
.
getProperty
(
"
x
"
)
;
is
(
response
.
descriptor
undefined
"
The
property
does
not
exist
.
"
)
;
response
=
yield
objClient
.
enumSymbols
(
)
;
slice
=
yield
response
.
iterator
.
slice
(
0
response
.
iterator
.
count
)
;
is
(
slice
.
ownSymbols
.
length
0
"
No
symbol
property
was
retrieved
.
"
)
;
response
=
yield
objClient
.
getPrototype
(
)
;
is
(
response
.
prototype
.
type
"
null
"
"
The
prototype
is
null
.
"
)
;
response
=
yield
objClient
.
getDisplayString
(
)
;
is
(
response
.
displayString
"
<
cpow
>
"
"
The
CPOW
stringifies
to
<
cpow
>
"
)
;
}
