"
use
strict
"
;
var
Services
=
require
(
"
Services
"
)
;
loader
.
lazyRequireGetter
(
this
"
Utils
"
"
devtools
/
client
/
webconsole
/
utils
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
WebConsoleUI
"
"
devtools
/
client
/
webconsole
/
webconsole
-
ui
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
gDevTools
"
"
devtools
/
client
/
framework
/
devtools
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
openDocLink
"
"
devtools
/
client
/
shared
/
link
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
DevToolsUtils
"
"
devtools
/
shared
/
DevToolsUtils
"
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
Telemetry
=
require
(
"
devtools
/
client
/
shared
/
telemetry
"
)
;
var
gHudId
=
0
;
const
isMacOS
=
Services
.
appinfo
.
OS
=
=
=
"
Darwin
"
;
class
WebConsole
{
constructor
(
toolbox
iframeWindow
chromeWindow
isBrowserConsole
=
false
)
{
this
.
toolbox
=
toolbox
;
this
.
iframeWindow
=
iframeWindow
;
this
.
chromeWindow
=
chromeWindow
;
this
.
hudId
=
"
hud_
"
+
+
+
gHudId
;
this
.
browserWindow
=
DevToolsUtils
.
getTopWindow
(
this
.
chromeWindow
)
;
this
.
isBrowserConsole
=
isBrowserConsole
;
this
.
telemetry
=
new
Telemetry
(
)
;
const
element
=
this
.
browserWindow
.
document
.
documentElement
;
if
(
element
.
getAttribute
(
"
windowtype
"
)
!
=
gDevTools
.
chromeWindowType
)
{
this
.
browserWindow
=
Services
.
wm
.
getMostRecentWindow
(
gDevTools
.
chromeWindowType
)
;
}
this
.
ui
=
new
WebConsoleUI
(
this
)
;
this
.
_destroyer
=
null
;
EventEmitter
.
decorate
(
this
)
;
}
recordEvent
(
event
extra
=
{
}
)
{
this
.
telemetry
.
recordEvent
(
event
"
webconsole
"
null
{
session_id
:
(
this
.
toolbox
&
&
this
.
toolbox
.
sessionId
)
|
|
-
1
.
.
.
extra
}
)
;
}
get
currentTarget
(
)
{
return
this
.
toolbox
.
target
;
}
get
chromeUtilsWindow
(
)
{
if
(
this
.
browserWindow
)
{
return
this
.
browserWindow
;
}
return
DevToolsUtils
.
getTopWindow
(
this
.
chromeWindow
)
;
}
get
gViewSourceUtils
(
)
{
return
this
.
chromeUtilsWindow
.
gViewSourceUtils
;
}
init
(
)
{
return
this
.
ui
.
init
(
)
;
}
get
jsterm
(
)
{
return
this
.
ui
?
this
.
ui
.
jsterm
:
null
;
}
canRewind
(
)
{
const
traits
=
this
.
currentTarget
&
&
this
.
currentTarget
.
traits
;
return
traits
&
&
traits
.
canRewind
;
}
getInputValue
(
)
{
if
(
!
this
.
jsterm
)
{
return
null
;
}
return
this
.
jsterm
.
_getValue
(
)
;
}
inputHasSelection
(
)
{
const
{
editor
}
=
this
.
jsterm
|
|
{
}
;
return
editor
&
&
!
!
editor
.
getSelection
(
)
;
}
getInputSelection
(
)
{
if
(
!
this
.
jsterm
|
|
!
this
.
jsterm
.
editor
)
{
return
null
;
}
return
this
.
jsterm
.
editor
.
getSelection
(
)
;
}
setInputValue
(
newValue
)
{
if
(
!
this
.
jsterm
)
{
return
;
}
this
.
jsterm
.
_setValue
(
newValue
)
;
}
focusInput
(
)
{
return
this
.
jsterm
&
&
this
.
jsterm
.
focus
(
)
;
}
openLink
(
link
e
=
{
}
)
{
openDocLink
(
link
{
relatedToCurrent
:
true
inBackground
:
isMacOS
?
e
.
metaKey
:
e
.
ctrlKey
}
)
;
if
(
e
&
&
typeof
e
.
stopPropagation
=
=
=
"
function
"
)
{
e
.
stopPropagation
(
)
;
}
}
viewSource
(
sourceURL
sourceLine
)
{
this
.
gViewSourceUtils
.
viewSource
(
{
URL
:
sourceURL
lineNumber
:
sourceLine
|
|
0
}
)
;
}
viewSourceInStyleEditor
(
sourceURL
sourceLine
)
{
const
toolbox
=
this
.
toolbox
;
if
(
!
toolbox
)
{
this
.
viewSource
(
sourceURL
sourceLine
)
;
return
;
}
toolbox
.
viewSourceInStyleEditor
(
sourceURL
sourceLine
)
;
}
async
viewSourceInDebugger
(
sourceURL
sourceLine
sourceColumn
)
{
const
toolbox
=
this
.
toolbox
;
if
(
!
toolbox
)
{
this
.
viewSource
(
sourceURL
sourceLine
sourceColumn
)
;
return
;
}
await
toolbox
.
viewSourceInDebugger
(
sourceURL
sourceLine
sourceColumn
)
;
this
.
ui
.
emit
(
"
source
-
in
-
debugger
-
opened
"
)
;
}
getDebuggerFrames
(
)
{
const
toolbox
=
this
.
toolbox
;
if
(
!
toolbox
)
{
return
null
;
}
const
panel
=
toolbox
.
getPanel
(
"
jsdebugger
"
)
;
if
(
!
panel
)
{
return
null
;
}
return
panel
.
getFrames
(
)
;
}
getMappedExpression
(
expression
)
{
const
toolbox
=
this
.
toolbox
;
const
panel
=
toolbox
&
&
toolbox
.
getPanel
(
"
jsdebugger
"
)
;
if
(
panel
)
{
return
panel
.
getMappedExpression
(
expression
)
;
}
if
(
this
.
parserService
&
&
expression
.
includes
(
"
await
"
)
)
{
const
shouldMapBindings
=
false
;
const
shouldMapAwait
=
true
;
const
res
=
this
.
parserService
.
mapExpression
(
expression
null
null
shouldMapBindings
shouldMapAwait
)
;
return
res
;
}
return
null
;
}
get
parserService
(
)
{
if
(
this
.
_parserService
)
{
return
this
.
_parserService
;
}
const
{
ParserDispatcher
}
=
require
(
"
devtools
/
client
/
debugger
/
src
/
workers
/
parser
/
index
"
)
;
this
.
_parserService
=
new
ParserDispatcher
(
)
;
this
.
_parserService
.
start
(
"
resource
:
/
/
devtools
/
client
/
debugger
/
dist
/
parser
-
worker
.
js
"
this
.
chromeUtilsWindow
)
;
return
this
.
_parserService
;
}
getInspectorSelection
(
)
{
const
toolbox
=
this
.
toolbox
;
if
(
!
toolbox
)
{
return
null
;
}
const
panel
=
toolbox
.
getPanel
(
"
inspector
"
)
;
if
(
!
panel
|
|
!
panel
.
selection
)
{
return
null
;
}
return
panel
.
selection
;
}
async
onViewSourceInDebugger
(
frame
)
{
if
(
this
.
toolbox
)
{
await
this
.
toolbox
.
viewSourceInDebugger
(
frame
.
url
frame
.
line
frame
.
column
frame
.
sourceId
)
;
this
.
recordEvent
(
"
jump_to_source
"
)
;
this
.
emit
(
"
source
-
in
-
debugger
-
opened
"
)
;
}
}
async
onViewSourceInStyleEditor
(
frame
)
{
if
(
!
this
.
toolbox
)
{
return
;
}
await
this
.
toolbox
.
viewSourceInStyleEditor
(
frame
.
url
frame
.
line
frame
.
column
)
;
this
.
recordEvent
(
"
jump_to_source
"
)
;
}
async
openNetworkPanel
(
requestId
)
{
if
(
!
this
.
toolbox
)
{
return
;
}
const
netmonitor
=
await
this
.
toolbox
.
selectTool
(
"
netmonitor
"
)
;
await
netmonitor
.
panelWin
.
Netmonitor
.
inspectRequest
(
requestId
)
;
}
async
resendNetworkRequest
(
requestId
)
{
if
(
!
this
.
toolbox
)
{
return
;
}
const
api
=
await
this
.
toolbox
.
getNetMonitorAPI
(
)
;
await
api
.
resendRequest
(
requestId
)
;
}
async
openNodeInInspector
(
grip
)
{
if
(
!
this
.
toolbox
)
{
return
;
}
const
onSelectInspector
=
this
.
toolbox
.
selectTool
(
"
inspector
"
"
inspect_dom
"
)
;
const
onNodeFront
=
this
.
toolbox
.
target
.
getFront
(
"
inspector
"
)
.
then
(
inspectorFront
=
>
inspectorFront
.
getNodeFrontFromNodeGrip
(
grip
)
)
;
const
[
nodeFront
inspectorPanel
]
=
await
Promise
.
all
(
[
onNodeFront
onSelectInspector
]
)
;
const
onInspectorUpdated
=
inspectorPanel
.
once
(
"
inspector
-
updated
"
)
;
const
onNodeFrontSet
=
this
.
toolbox
.
selection
.
setNodeFront
(
nodeFront
{
reason
:
"
console
"
}
)
;
await
Promise
.
all
(
[
onNodeFrontSet
onInspectorUpdated
]
)
;
}
destroy
(
)
{
if
(
!
this
.
hudId
)
{
return
;
}
if
(
this
.
ui
)
{
this
.
ui
.
destroy
(
)
;
}
if
(
this
.
_parserService
)
{
this
.
_parserService
.
stop
(
)
;
this
.
_parserService
=
null
;
}
const
id
=
Utils
.
supportsString
(
this
.
hudId
)
;
Services
.
obs
.
notifyObservers
(
id
"
web
-
console
-
destroyed
"
)
;
this
.
hudId
=
null
;
this
.
emit
(
"
destroyed
"
)
;
}
}
module
.
exports
=
WebConsole
;
