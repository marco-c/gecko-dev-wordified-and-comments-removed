"
use
strict
"
;
const
TEST_URI
=
"
http
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
webconsole
/
"
+
"
test
/
mochitest
/
test
-
console
.
html
?
"
+
Date
.
now
(
)
;
const
TEST_FILE
=
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
client
/
"
+
"
webconsole
/
test
/
mochitest
/
"
+
"
test
-
cu
-
reporterror
.
js
"
;
const
TEST_XHR_ERROR_URI
=
http
:
/
/
example
.
com
/
404
.
html
?
{
Date
.
now
(
)
}
;
const
TEST_IMAGE
=
"
http
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
webconsole
/
"
+
"
test
/
test
-
image
.
png
"
;
const
ObjectClient
=
require
(
"
devtools
/
shared
/
client
/
object
-
client
"
)
;
add_task
(
async
function
(
)
{
await
addTab
(
TEST_URI
)
;
const
opened
=
waitForBrowserConsole
(
)
;
let
hud
=
HUDService
.
getBrowserConsole
(
)
;
ok
(
!
hud
"
browser
console
is
not
open
"
)
;
info
(
"
wait
for
the
browser
console
to
open
with
ctrl
-
shift
-
j
"
)
;
EventUtils
.
synthesizeKey
(
"
j
"
{
accelKey
:
true
shiftKey
:
true
}
window
)
;
hud
=
await
opened
;
ok
(
hud
"
browser
console
opened
"
)
;
await
setFilterState
(
hud
{
netxhr
:
true
}
)
;
await
testMessages
(
hud
)
;
await
testCPOWInspection
(
hud
)
;
await
resetFilters
(
hud
)
;
}
)
;
async
function
testMessages
(
hud
)
{
hud
.
ui
.
clearOutput
(
true
)
;
expectUncaughtException
(
)
;
executeSoon
(
(
)
=
>
{
foobarException
(
)
;
}
)
;
hud
.
iframeWindow
.
console
.
log
(
"
message
from
chrome
window
"
)
;
Services
.
scriptloader
.
loadSubScript
(
TEST_FILE
hud
.
iframeWindow
)
;
const
sandbox
=
new
Cu
.
Sandbox
(
null
{
wantComponents
:
false
wantGlobalProperties
:
[
"
URL
"
"
URLSearchParams
"
]
}
)
;
const
error
=
Cu
.
evalInSandbox
(
new
Error
(
"
error
from
nuked
globals
"
)
;
sandbox
)
;
Cu
.
reportError
(
error
)
;
Cu
.
nukeSandbox
(
sandbox
)
;
content
.
console
.
log
(
"
message
from
content
window
"
)
;
hud
.
jsterm
.
execute
(
"
document
.
location
.
href
"
)
;
hud
.
jsterm
.
execute
(
gBrowser
.
selectedBrowser
.
messageManager
.
loadFrameScript
(
+
'
data
:
application
/
javascript
console
.
log
(
"
framescript
-
message
"
)
'
false
)
;
+
"
framescript
-
eval
"
;
)
;
const
xhr
=
new
XMLHttpRequest
(
)
;
xhr
.
onload
=
(
)
=
>
console
.
log
(
"
xhr
loaded
status
is
:
"
+
xhr
.
status
)
;
xhr
.
open
(
"
get
"
TEST_URI
true
)
;
xhr
.
send
(
)
;
const
xhrErr
=
new
XMLHttpRequest
(
)
;
xhrErr
.
onload
=
(
)
=
>
{
console
.
log
(
"
xhr
error
loaded
status
is
:
"
+
xhrErr
.
status
)
;
}
;
xhrErr
.
open
(
"
get
"
TEST_XHR_ERROR_URI
true
)
;
xhrErr
.
send
(
)
;
await
fetch
(
TEST_IMAGE
)
;
console
.
log
(
"
fetch
loaded
"
)
;
await
checkMessageExists
(
hud
"
message
from
chrome
window
"
)
;
await
checkMessageExists
(
hud
"
error
thrown
from
test
-
cu
-
reporterror
.
js
via
Cu
.
reportError
(
)
"
)
;
await
checkMessageExists
(
hud
"
error
from
nuked
globals
"
)
;
await
checkMessageExists
(
hud
"
message
from
content
window
"
)
;
await
checkMessageExists
(
hud
"
browser
.
xul
"
)
;
await
checkMessageExists
(
hud
"
framescript
-
eval
"
)
;
await
checkMessageExists
(
hud
"
framescript
-
message
"
)
;
await
checkMessageExists
(
hud
"
foobarException
"
)
;
await
checkMessageExists
(
hud
"
test
-
console
.
html
"
)
;
await
checkMessageExists
(
hud
"
404
.
html
"
)
;
await
checkMessageExists
(
hud
"
test
-
image
.
png
"
)
;
}
async
function
testCPOWInspection
(
hud
)
{
const
cpowEval
=
await
hud
.
jsterm
.
requestEvaluation
(
"
gBrowser
.
selectedBrowser
"
)
;
info
(
"
Creating
an
ObjectClient
with
:
"
+
cpowEval
.
result
.
actor
)
;
const
objectClient
=
new
ObjectClient
(
hud
.
ui
.
proxy
.
client
{
actor
:
cpowEval
.
result
.
actor
}
)
;
const
prototypeAndProperties
=
await
objectClient
.
getPrototypeAndProperties
(
)
;
is
(
prototypeAndProperties
.
prototype
.
class
"
XBL
prototype
JSClass
"
"
Looks
like
a
valid
response
"
)
;
const
cpow
=
prototypeAndProperties
.
ownProperties
.
_contentWindow
.
value
;
const
e10sCheck
=
await
hud
.
jsterm
.
requestEvaluation
(
"
Cu
.
isCrossProcessWrapper
(
gBrowser
.
selectedBrowser
.
_contentWindow
)
"
)
;
if
(
!
e10sCheck
.
result
)
{
is
(
cpow
.
class
"
Window
"
"
The
object
is
not
a
CPOW
.
"
)
;
return
;
}
is
(
cpow
.
class
"
CPOW
:
Window
"
"
The
CPOW
grip
has
the
right
class
.
"
)
;
const
objClient
=
new
ObjectClient
(
hud
.
ui
.
proxy
.
client
cpow
)
;
let
response
=
await
objClient
.
getPrototypeAndProperties
(
)
;
is
(
Reflect
.
ownKeys
(
response
.
ownProperties
)
.
length
0
"
No
property
was
retrieved
.
"
)
;
is
(
response
.
ownSymbols
.
length
0
"
No
symbol
property
was
retrieved
.
"
)
;
is
(
response
.
prototype
.
type
"
null
"
"
The
prototype
is
null
.
"
)
;
response
=
await
objClient
.
enumProperties
(
{
ignoreIndexedProperties
:
true
}
)
;
let
slice
=
await
response
.
iterator
.
slice
(
0
response
.
iterator
.
count
)
;
is
(
Reflect
.
ownKeys
(
slice
.
ownProperties
)
.
length
0
"
No
property
was
retrieved
.
"
)
;
response
=
await
objClient
.
enumProperties
(
{
}
)
;
slice
=
await
response
.
iterator
.
slice
(
0
response
.
iterator
.
count
)
;
is
(
Reflect
.
ownKeys
(
slice
.
ownProperties
)
.
length
0
"
No
property
was
retrieved
.
"
)
;
response
=
await
objClient
.
getOwnPropertyNames
(
)
;
is
(
response
.
ownPropertyNames
.
length
0
"
No
property
was
retrieved
.
"
)
;
response
=
await
objClient
.
getProperty
(
"
x
"
)
;
is
(
response
.
descriptor
undefined
"
The
property
does
not
exist
.
"
)
;
response
=
await
objClient
.
enumSymbols
(
)
;
slice
=
await
response
.
iterator
.
slice
(
0
response
.
iterator
.
count
)
;
is
(
slice
.
ownSymbols
.
length
0
"
No
symbol
property
was
retrieved
.
"
)
;
response
=
await
objClient
.
getPrototype
(
)
;
is
(
response
.
prototype
.
type
"
null
"
"
The
prototype
is
null
.
"
)
;
response
=
await
objClient
.
getDisplayString
(
)
;
is
(
response
.
displayString
"
<
cpow
>
"
"
The
CPOW
stringifies
to
<
cpow
>
"
)
;
}
async
function
checkMessageExists
(
hud
msg
)
{
info
(
Checking
"
{
msg
}
"
was
logged
)
;
const
message
=
await
waitFor
(
(
)
=
>
findMessage
(
hud
msg
)
)
;
ok
(
message
"
{
msg
}
"
was
logged
)
;
}
