"
use
strict
"
;
const
TEST_URI
=
"
data
:
text
/
html
;
charset
=
utf
-
8
<
p
>
bug
660806
-
history
"
+
"
navigation
must
not
show
the
autocomplete
popup
"
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
devtools
.
webconsole
.
jsterm
.
codeMirror
"
false
)
;
await
testHistory
(
)
;
await
pushPref
(
"
devtools
.
webconsole
.
jsterm
.
codeMirror
"
true
)
;
await
testHistory
(
)
;
}
)
;
async
function
testHistory
(
)
{
const
{
jsterm
}
=
await
openNewTabAndConsole
(
TEST_URI
)
;
const
popup
=
jsterm
.
autocompletePopup
;
const
onShown
=
function
(
)
{
ok
(
false
"
popup
shown
"
)
;
}
;
await
jsterm
.
execute
(
window
.
foobarBug660806
=
{
'
location
'
:
'
value0
'
'
locationbar
'
:
'
value1
'
}
)
;
popup
.
on
(
"
popup
-
opened
"
onShown
)
;
ok
(
!
popup
.
isOpen
"
popup
is
not
open
"
)
;
ok
(
!
jsterm
.
lastInputValue
"
no
lastInputValue
"
)
;
jsterm
.
setInputValue
(
"
window
.
foobarBug660806
.
location
"
)
;
is
(
jsterm
.
lastInputValue
"
window
.
foobarBug660806
.
location
"
"
lastInputValue
is
correct
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
waitFor
(
(
)
=
>
!
jsterm
.
lastInputValue
)
;
const
onSetInputValue
=
jsterm
.
once
(
"
set
-
input
-
value
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowUp
"
)
;
await
onSetInputValue
;
await
new
Promise
(
executeSoon
)
;
is
(
jsterm
.
lastInputValue
"
window
.
foobarBug660806
.
location
"
"
lastInputValue
is
correct
again
"
)
;
ok
(
!
popup
.
isOpen
"
popup
is
not
open
"
)
;
popup
.
off
(
"
popup
-
opened
"
onShown
)
;
}
