"
use
strict
"
;
const
TEST_URI
=
data
:
text
/
html
;
charset
=
utf
-
8
Web
Console
test
top
-
level
await
when
debugger
paused
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
devtools
.
debugger
.
features
.
map
-
await
-
expression
"
true
)
;
await
pushPref
(
"
devtools
.
webconsole
.
jsterm
.
codeMirror
"
false
)
;
await
performTests
(
)
;
await
pushPref
(
"
devtools
.
webconsole
.
jsterm
.
codeMirror
"
true
)
;
await
performTests
(
)
;
}
)
;
async
function
performTests
(
)
{
await
pushPref
(
"
devtools
.
toolbox
.
splitconsoleEnabled
"
false
)
;
const
hud
=
await
openNewTabAndConsole
(
TEST_URI
)
;
const
{
jsterm
}
=
hud
;
const
pauseExpression
=
(
(
)
=
>
{
var
foo
=
[
"
bar
"
]
;
/
*
Will
pause
the
script
and
open
the
debugger
panel
*
/
debugger
;
return
"
pauseExpression
-
res
"
;
}
)
(
)
;
jsterm
.
execute
(
pauseExpression
)
;
const
target
=
await
TargetFactory
.
forTab
(
gBrowser
.
selectedTab
)
;
const
toolbox
=
gDevTools
.
getToolbox
(
target
)
;
await
waitFor
(
(
)
=
>
toolbox
.
getPanel
(
"
jsdebugger
"
)
)
;
const
dbg
=
createDebuggerContext
(
toolbox
)
;
await
waitForPaused
(
dbg
)
;
await
toolbox
.
openSplitConsole
(
)
;
const
awaitExpression
=
await
new
Promise
(
res
=
>
{
setTimeout
(
(
)
=
>
res
(
[
"
res
"
.
.
.
foo
]
)
1000
)
;
}
)
;
const
onAwaitResultMessage
=
waitForMessage
(
hud
[
"
res
"
"
bar
"
]
"
.
message
.
result
"
)
;
jsterm
.
execute
(
awaitExpression
)
;
await
jsterm
.
execute
(
"
smoke
"
)
;
await
waitForTick
(
)
;
await
resume
(
dbg
)
;
await
onAwaitResultMessage
;
const
messages
=
hud
.
ui
.
outputNode
.
querySelectorAll
(
"
.
message
.
result
.
message
-
body
"
)
;
const
messagesText
=
Array
.
from
(
messages
)
.
map
(
n
=
>
n
.
textContent
)
;
const
expectedMessages
=
[
"
smoke
"
"
pauseExpression
-
res
"
Array
[
"
res
"
"
bar
"
]
]
;
is
(
JSON
.
stringify
(
messagesText
null
2
)
JSON
.
stringify
(
expectedMessages
null
2
)
"
The
output
contains
the
the
expected
messages
in
the
expected
order
"
)
;
}
