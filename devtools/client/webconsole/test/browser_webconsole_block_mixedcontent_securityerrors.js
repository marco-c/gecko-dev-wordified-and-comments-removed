"
use
strict
"
;
const
TEST_URI
=
"
https
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
webconsole
/
"
+
"
test
/
test
-
mixedcontent
-
securityerrors
.
html
"
;
const
LEARN_MORE_URI
=
"
https
:
/
/
developer
.
mozilla
.
org
/
docs
/
Web
/
Security
/
"
+
"
Mixed_content
"
+
DOCS_GA_PARAMS
;
add_task
(
function
*
(
)
{
yield
pushPrefEnv
(
)
;
let
{
browser
}
=
yield
loadTab
(
TEST_URI
)
;
let
hud
=
yield
openConsole
(
)
;
let
results
=
yield
waitForMessages
(
{
webconsole
:
hud
messages
:
[
{
name
:
"
Logged
blocking
mixed
active
content
"
text
:
"
Blocked
loading
mixed
active
content
\
u201chttp
:
/
/
example
.
com
/
\
u201d
"
category
:
CATEGORY_SECURITY
severity
:
SEVERITY_ERROR
objects
:
true
}
{
name
:
"
Logged
blocking
mixed
passive
content
-
image
"
text
:
"
Blocked
loading
mixed
active
content
\
u201chttp
:
/
/
example
.
com
/
\
u201d
"
category
:
CATEGORY_SECURITY
severity
:
SEVERITY_ERROR
objects
:
true
}
]
}
)
;
yield
testClickOpenNewTab
(
hud
results
[
0
]
)
;
let
results2
=
yield
mixedContentOverrideTest2
(
hud
browser
)
;
yield
testClickOpenNewTab
(
hud
results2
[
0
]
)
;
}
)
;
function
pushPrefEnv
(
)
{
let
deferred
=
promise
.
defer
(
)
;
let
options
=
{
"
set
"
:
[
[
"
security
.
mixed_content
.
block_active_content
"
true
]
[
"
security
.
mixed_content
.
block_display_content
"
true
]
[
"
security
.
mixed_content
.
use_hsts
"
false
]
[
"
security
.
mixed_content
.
send_hsts_priming
"
false
]
]
}
;
SpecialPowers
.
pushPrefEnv
(
options
deferred
.
resolve
)
;
return
deferred
.
promise
;
}
function
mixedContentOverrideTest2
(
hud
browser
)
{
let
deferred
=
promise
.
defer
(
)
;
let
{
gIdentityHandler
}
=
browser
.
ownerGlobal
;
ok
(
gIdentityHandler
.
_identityBox
.
classList
.
contains
(
"
mixedActiveBlocked
"
)
"
Mixed
Active
Content
state
appeared
on
identity
box
"
)
;
gIdentityHandler
.
disableMixedContentProtection
(
)
;
waitForMessages
(
{
webconsole
:
hud
messages
:
[
{
name
:
"
Logged
blocking
mixed
active
content
"
text
:
"
Loading
mixed
(
insecure
)
active
content
"
+
"
\
u201chttp
:
/
/
example
.
com
/
\
u201d
on
a
secure
page
"
category
:
CATEGORY_SECURITY
severity
:
SEVERITY_WARNING
objects
:
true
}
{
name
:
"
Logged
blocking
mixed
passive
content
-
image
"
text
:
"
Loading
mixed
(
insecure
)
display
content
"
+
"
\
u201chttp
:
/
/
example
.
com
/
tests
/
image
/
test
/
mochitest
/
blue
.
png
\
u201d
"
+
"
on
a
secure
page
"
category
:
CATEGORY_SECURITY
severity
:
SEVERITY_WARNING
objects
:
true
}
]
}
)
.
then
(
msgs
=
>
deferred
.
resolve
(
msgs
)
e
=
>
console
.
error
(
e
)
)
;
return
deferred
.
promise
;
}
function
testClickOpenNewTab
(
hud
match
)
{
let
warningNode
=
match
.
clickableElements
[
0
]
;
ok
(
warningNode
"
link
element
"
)
;
ok
(
warningNode
.
classList
.
contains
(
"
learn
-
more
-
link
"
)
"
link
class
name
"
)
;
return
simulateMessageLinkClick
(
warningNode
LEARN_MORE_URI
)
;
}
