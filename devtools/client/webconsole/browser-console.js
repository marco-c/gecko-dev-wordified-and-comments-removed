"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
WebConsole
=
require
(
"
devtools
/
client
/
webconsole
/
webconsole
"
)
;
const
{
TargetList
}
=
require
(
"
devtools
/
shared
/
resources
/
target
-
list
"
)
;
loader
.
lazyRequireGetter
(
this
"
Telemetry
"
"
devtools
/
client
/
shared
/
telemetry
"
)
;
loader
.
lazyRequireGetter
(
this
"
BrowserConsoleManager
"
"
devtools
/
client
/
webconsole
/
browser
-
console
-
manager
"
true
)
;
class
BrowserConsole
extends
WebConsole
{
constructor
(
target
iframeWindow
chromeWindow
)
{
super
(
null
iframeWindow
chromeWindow
true
)
;
this
.
_browserConsoleTarget
=
target
;
this
.
_targetList
=
new
TargetList
(
target
.
client
.
mainRoot
target
)
;
this
.
_telemetry
=
new
Telemetry
(
)
;
this
.
_bcInitializer
=
null
;
this
.
_bcDestroyer
=
null
;
}
get
currentTarget
(
)
{
return
this
.
_browserConsoleTarget
;
}
get
targetList
(
)
{
return
this
.
_targetList
;
}
init
(
)
{
if
(
this
.
_bcInitializer
)
{
return
this
.
_bcInitializer
;
}
this
.
_bcInitializer
=
(
async
(
)
=
>
{
ShutdownObserver
.
init
(
)
;
this
.
_telemetry
.
toolOpened
(
"
browserconsole
"
-
1
this
)
;
await
this
.
targetList
.
startListening
(
TargetList
.
ALL_TYPES
)
;
await
super
.
init
(
)
;
}
)
(
)
;
return
this
.
_bcInitializer
;
}
destroy
(
)
{
if
(
this
.
_bcDestroyer
)
{
return
this
.
_bcDestroyer
;
}
this
.
_bcDestroyer
=
(
async
(
)
=
>
{
this
.
_telemetry
.
toolClosed
(
"
browserconsole
"
-
1
this
)
;
await
this
.
targetList
.
stopListening
(
TargetList
.
ALL_TYPES
)
;
await
super
.
destroy
(
)
;
await
this
.
currentTarget
.
destroy
(
)
;
this
.
chromeWindow
.
close
(
)
;
}
)
(
)
;
return
this
.
_bcDestroyer
;
}
}
var
ShutdownObserver
=
{
_initialized
:
false
init
(
)
{
if
(
this
.
_initialized
)
{
return
;
}
Services
.
obs
.
addObserver
(
this
"
quit
-
application
-
granted
"
)
;
this
.
_initialized
=
true
;
}
observe
(
message
topic
)
{
if
(
topic
=
=
"
quit
-
application
-
granted
"
)
{
BrowserConsoleManager
.
storeBrowserConsoleSessionState
(
)
;
this
.
uninit
(
)
;
}
}
uninit
(
)
{
Services
.
obs
.
removeObserver
(
this
"
quit
-
application
-
granted
"
)
;
}
}
;
module
.
exports
=
BrowserConsole
;
