"
use
strict
"
;
var
Services
=
require
(
"
Services
"
)
;
loader
.
lazyRequireGetter
(
this
"
extend
"
"
devtools
/
shared
/
extend
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
Telemetry
"
"
devtools
/
client
/
shared
/
telemetry
"
)
;
loader
.
lazyRequireGetter
(
this
"
WebConsole
"
"
devtools
/
client
/
webconsole
/
webconsole
"
)
;
function
BrowserConsole
(
target
iframeWindow
chromeWindow
hudService
)
{
WebConsole
.
call
(
this
target
iframeWindow
chromeWindow
hudService
)
;
this
.
_telemetry
=
new
Telemetry
(
)
;
}
BrowserConsole
.
prototype
=
extend
(
WebConsole
.
prototype
{
_browserConsole
:
true
_bcInit
:
null
_bcDestroyer
:
null
init
:
WebConsole
.
prototype
.
init
init
(
)
{
if
(
this
.
_bcInit
)
{
return
this
.
_bcInit
;
}
ShutdownObserver
.
init
(
this
.
hudService
)
;
const
window
=
this
.
iframeWindow
;
window
.
addEventListener
(
"
unload
"
(
)
=
>
{
this
.
destroy
(
)
;
}
{
once
:
true
}
)
;
this
.
_telemetry
.
toolOpened
(
"
browserconsole
"
-
1
this
)
;
this
.
_bcInit
=
this
.
init
(
)
;
return
this
.
_bcInit
;
}
destroy
:
WebConsole
.
prototype
.
destroy
destroy
(
)
{
if
(
this
.
_bcDestroyer
)
{
return
this
.
_bcDestroyer
;
}
this
.
_bcDestroyer
=
(
async
(
)
=
>
{
this
.
_telemetry
.
toolClosed
(
"
browserconsole
"
-
1
this
)
;
await
this
.
destroy
(
)
;
await
this
.
target
.
destroy
(
)
;
this
.
hudService
.
_browserConsoleID
=
null
;
this
.
chromeWindow
.
close
(
)
;
}
)
(
)
;
return
this
.
_bcDestroyer
;
}
}
)
;
var
ShutdownObserver
=
{
_initialized
:
false
init
(
hudService
)
{
if
(
this
.
_initialized
)
{
return
;
}
Services
.
obs
.
addObserver
(
this
"
quit
-
application
-
granted
"
)
;
this
.
_initialized
=
true
;
this
.
hudService
=
hudService
;
}
observe
(
message
topic
)
{
if
(
topic
=
=
"
quit
-
application
-
granted
"
)
{
this
.
hudService
.
storeBrowserConsoleSessionState
(
)
;
this
.
uninit
(
)
;
}
}
uninit
(
)
{
Services
.
obs
.
removeObserver
(
this
"
quit
-
application
-
granted
"
)
;
}
}
;
module
.
exports
=
BrowserConsole
;
