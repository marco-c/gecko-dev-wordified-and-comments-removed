"
use
strict
"
;
(
function
(
)
{
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
const
Services
=
require
(
"
Services
"
)
;
const
{
gDevTools
}
=
require
(
"
devtools
/
client
/
framework
/
devtools
"
)
;
const
{
appendStyleSheet
}
=
require
(
"
devtools
/
client
/
shared
/
stylesheet
-
utils
"
)
;
const
documentElement
=
document
.
documentElement
;
let
os
;
const
platform
=
navigator
.
platform
;
if
(
platform
.
startsWith
(
"
Win
"
)
)
{
os
=
"
win
"
;
}
else
if
(
platform
.
startsWith
(
"
Mac
"
)
)
{
os
=
"
mac
"
;
}
else
{
os
=
"
linux
"
;
}
documentElement
.
setAttribute
(
"
platform
"
os
)
;
if
(
documentElement
.
getAttribute
(
"
no
-
theme
"
)
=
=
=
"
true
"
)
{
return
;
}
const
devtoolsStyleSheets
=
new
WeakMap
(
)
;
let
gOldTheme
=
"
"
;
function
forceStyle
(
)
{
const
computedStyle
=
window
.
getComputedStyle
(
documentElement
)
;
if
(
!
computedStyle
)
{
return
;
}
const
display
=
computedStyle
.
display
;
documentElement
.
style
.
display
=
"
none
"
;
window
.
getComputedStyle
(
documentElement
)
.
display
;
documentElement
.
style
.
display
=
display
;
}
function
notifyWindow
(
)
{
window
.
dispatchEvent
(
new
CustomEvent
(
"
theme
-
switch
-
complete
"
{
}
)
)
;
}
function
switchTheme
(
newTheme
)
{
if
(
newTheme
=
=
=
gOldTheme
)
{
return
;
}
const
oldTheme
=
gOldTheme
;
gOldTheme
=
newTheme
;
const
oldThemeDef
=
gDevTools
.
getThemeDefinition
(
oldTheme
)
;
let
newThemeDef
=
gDevTools
.
getThemeDefinition
(
newTheme
)
;
if
(
!
newThemeDef
)
{
newThemeDef
=
gDevTools
.
getThemeDefinition
(
"
light
"
)
;
}
devtoolsStyleSheets
.
set
(
newThemeDef
[
]
)
;
const
loadEvents
=
[
]
;
for
(
const
url
of
newThemeDef
.
stylesheets
)
{
const
{
styleSheet
loadPromise
}
=
appendStyleSheet
(
document
url
)
;
devtoolsStyleSheets
.
get
(
newThemeDef
)
.
push
(
styleSheet
)
;
loadEvents
.
push
(
loadPromise
)
;
}
if
(
os
!
=
=
"
win
"
&
&
os
!
=
=
"
mac
"
)
{
try
{
const
StylesheetUtils
=
require
(
"
devtools
/
shared
/
layout
/
utils
"
)
;
const
SCROLLBARS_URL
=
"
chrome
:
/
/
devtools
/
skin
/
floating
-
scrollbars
-
dark
-
theme
.
css
"
;
if
(
!
Services
.
appShell
.
hiddenDOMWindow
.
matchMedia
(
"
(
-
moz
-
overlay
-
scrollbars
)
"
)
.
matches
)
{
if
(
newTheme
=
=
"
dark
"
)
{
StylesheetUtils
.
loadSheet
(
window
SCROLLBARS_URL
"
agent
"
)
;
}
else
if
(
oldTheme
=
=
"
dark
"
)
{
StylesheetUtils
.
removeSheet
(
window
SCROLLBARS_URL
"
agent
"
)
;
}
forceStyle
(
)
;
}
}
catch
(
e
)
{
console
.
warn
(
"
customize
scrollbar
styles
is
only
supported
in
firefox
"
)
;
}
}
Promise
.
all
(
loadEvents
)
.
then
(
(
)
=
>
{
if
(
oldThemeDef
)
{
for
(
const
name
of
oldThemeDef
.
classList
)
{
documentElement
.
classList
.
remove
(
name
)
;
}
for
(
const
sheet
of
devtoolsStyleSheets
.
get
(
oldThemeDef
)
|
|
[
]
)
{
sheet
.
remove
(
)
;
}
if
(
oldThemeDef
.
onUnapply
)
{
oldThemeDef
.
onUnapply
(
window
newTheme
)
;
}
}
for
(
const
name
of
newThemeDef
.
classList
)
{
documentElement
.
classList
.
add
(
name
)
;
}
if
(
newThemeDef
.
onApply
)
{
newThemeDef
.
onApply
(
window
oldTheme
)
;
}
gDevTools
.
emit
(
"
theme
-
switched
"
window
newTheme
oldTheme
)
;
notifyWindow
(
)
;
}
console
.
error
)
;
}
function
handlePrefChange
(
)
{
switchTheme
(
Services
.
prefs
.
getCharPref
(
"
devtools
.
theme
"
)
)
;
}
if
(
documentElement
.
hasAttribute
(
"
force
-
theme
"
)
)
{
switchTheme
(
documentElement
.
getAttribute
(
"
force
-
theme
"
)
)
;
}
else
{
switchTheme
(
Services
.
prefs
.
getCharPref
(
"
devtools
.
theme
"
)
)
;
Services
.
prefs
.
addObserver
(
"
devtools
.
theme
"
handlePrefChange
)
;
window
.
addEventListener
(
"
unload
"
function
(
)
{
Services
.
prefs
.
removeObserver
(
"
devtools
.
theme
"
handlePrefChange
)
;
}
{
once
:
true
}
)
;
}
}
)
(
)
;
