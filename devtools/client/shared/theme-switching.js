"
use
strict
"
;
(
function
(
)
{
const
{
require
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
sys
.
mjs
"
)
;
const
{
gDevTools
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
framework
/
devtools
.
js
"
)
;
const
{
appendStyleSheet
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
stylesheet
-
utils
.
js
"
)
;
const
{
getTheme
getAutoTheme
getThemePrefValue
addThemeObserver
removeThemeObserver
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
theme
.
js
"
)
;
const
documentElement
=
document
.
documentElement
;
let
os
;
const
platform
=
navigator
.
platform
;
if
(
platform
.
startsWith
(
"
Win
"
)
)
{
os
=
"
win
"
;
}
else
if
(
platform
.
startsWith
(
"
Mac
"
)
)
{
os
=
"
mac
"
;
}
else
{
os
=
"
linux
"
;
}
documentElement
.
setAttribute
(
"
platform
"
os
)
;
if
(
documentElement
.
getAttribute
(
"
no
-
theme
"
)
=
=
=
"
true
"
)
{
return
;
}
const
devtoolsStyleSheets
=
new
WeakMap
(
)
;
let
gOldTheme
=
"
"
;
function
notifyWindow
(
)
{
window
.
dispatchEvent
(
new
CustomEvent
(
"
theme
-
switch
-
complete
"
{
}
)
)
;
}
function
switchTheme
(
newTheme
)
{
handleForcedColorsActiveAttribute
(
)
;
if
(
newTheme
=
=
=
gOldTheme
)
{
return
;
}
const
oldTheme
=
gOldTheme
;
gOldTheme
=
newTheme
;
const
oldThemeDef
=
gDevTools
.
getThemeDefinition
(
oldTheme
)
;
let
newThemeDef
=
gDevTools
.
getThemeDefinition
(
newTheme
)
;
if
(
!
newThemeDef
)
{
newThemeDef
=
gDevTools
.
getThemeDefinition
(
getAutoTheme
(
)
)
;
}
devtoolsStyleSheets
.
set
(
newThemeDef
[
]
)
;
const
loadEvents
=
[
]
;
for
(
const
url
of
newThemeDef
.
stylesheets
)
{
const
{
styleSheet
loadPromise
}
=
appendStyleSheet
(
document
url
)
;
devtoolsStyleSheets
.
get
(
newThemeDef
)
.
push
(
styleSheet
)
;
loadEvents
.
push
(
loadPromise
)
;
}
Promise
.
all
(
loadEvents
)
.
then
(
(
)
=
>
{
if
(
oldThemeDef
)
{
for
(
const
name
of
oldThemeDef
.
classList
)
{
documentElement
.
classList
.
remove
(
name
)
;
}
for
(
const
sheet
of
devtoolsStyleSheets
.
get
(
oldThemeDef
)
|
|
[
]
)
{
sheet
.
remove
(
)
;
}
if
(
oldThemeDef
.
onUnapply
)
{
oldThemeDef
.
onUnapply
(
window
newTheme
)
;
}
}
for
(
const
name
of
newThemeDef
.
classList
)
{
documentElement
.
classList
.
add
(
name
)
;
}
if
(
newThemeDef
.
onApply
)
{
newThemeDef
.
onApply
(
window
oldTheme
)
;
}
gDevTools
.
emit
(
"
theme
-
switched
"
window
newTheme
oldTheme
)
;
notifyWindow
(
)
;
}
console
.
error
)
;
}
function
handleThemeChange
(
)
{
switchTheme
(
getTheme
(
)
)
;
}
const
FORCED_COLORS_ACTIVE_ATTRIBUTE
=
"
forced
-
colors
-
active
"
;
const
FORCE_COLORS_ACTIVE_MEDIA_QUERY_STRING
=
"
(
forced
-
colors
:
active
)
"
;
function
handleForcedColorsActiveAttribute
(
)
{
const
themePrefValue
=
getThemePrefValue
(
)
;
const
forcedColorsActive
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
high
-
contrast
-
mode
-
support
"
false
)
&
&
themePrefValue
=
=
"
auto
"
&
&
window
.
matchMedia
(
FORCE_COLORS_ACTIVE_MEDIA_QUERY_STRING
)
.
matches
;
if
(
forcedColorsActive
)
{
documentElement
.
setAttribute
(
FORCED_COLORS_ACTIVE_ATTRIBUTE
"
"
)
;
}
else
{
documentElement
.
removeAttribute
(
FORCED_COLORS_ACTIVE_ATTRIBUTE
)
;
}
}
const
mql
=
window
.
matchMedia
(
FORCE_COLORS_ACTIVE_MEDIA_QUERY_STRING
)
;
mql
.
addEventListener
(
"
change
"
handleForcedColorsActiveAttribute
)
;
const
forcedTheme
=
documentElement
.
getAttribute
(
"
force
-
theme
"
)
|
|
window
.
top
.
document
.
documentElement
.
getAttribute
(
"
force
-
theme
"
)
;
if
(
forcedTheme
)
{
switchTheme
(
forcedTheme
)
;
}
else
{
switchTheme
(
getTheme
(
)
)
;
addThemeObserver
(
handleThemeChange
)
;
window
.
addEventListener
(
"
unload
"
function
(
)
{
removeThemeObserver
(
handleThemeChange
)
;
}
{
once
:
true
}
)
;
}
}
)
(
)
;
