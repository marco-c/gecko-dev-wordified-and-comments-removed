"
use
strict
"
;
class
RemoteClientManager
{
constructor
(
)
{
this
.
_clients
=
new
Map
(
)
;
this
.
_onClientClosed
=
this
.
_onClientClosed
.
bind
(
this
)
;
}
setClient
(
id
type
{
client
transportDetails
}
)
{
const
key
=
this
.
_getKey
(
id
type
)
;
this
.
_clients
.
set
(
key
{
client
transportDetails
}
)
;
client
.
addOneTimeListener
(
"
closed
"
this
.
_onClientClosed
)
;
}
hasClient
(
id
type
)
{
return
this
.
_clients
.
has
(
this
.
_getKey
(
id
type
)
)
;
}
getClient
(
id
type
)
{
return
this
.
_clients
.
get
(
this
.
_getKey
(
id
type
)
)
;
}
removeClient
(
id
type
)
{
const
key
=
this
.
_getKey
(
id
type
)
;
this
.
_removeClientByKey
(
key
)
;
}
removeAllClients
(
)
{
const
keys
=
[
.
.
.
this
.
_clients
.
keys
(
)
]
;
for
(
const
key
of
keys
)
{
this
.
_removeClientByKey
(
key
)
;
}
}
getRemoteId
(
id
type
)
{
return
encodeURIComponent
(
this
.
_getKey
(
id
type
)
)
;
}
getClientByRemoteId
(
remoteId
)
{
const
key
=
decodeURIComponent
(
remoteId
)
;
return
this
.
_clients
.
get
(
key
)
;
}
_getKey
(
id
type
)
{
return
id
+
"
-
"
+
type
;
}
_removeClientByKey
(
key
)
{
if
(
this
.
hasClient
(
key
)
)
{
this
.
getClient
(
key
)
.
client
.
removeListener
(
"
closed
"
this
.
_onClientClosed
)
;
this
.
_clients
.
delete
(
key
)
;
}
}
_onClientClosed
(
)
{
const
closedClientKeys
=
[
.
.
.
this
.
_clients
.
keys
(
)
]
.
filter
(
key
=
>
{
const
clientInfo
=
this
.
_clients
.
get
(
key
)
;
return
clientInfo
.
client
.
_closed
;
}
)
;
for
(
const
key
of
closedClientKeys
)
{
this
.
_removeClientByKey
(
key
)
;
}
}
}
exports
.
remoteClientManager
=
new
RemoteClientManager
(
)
;
