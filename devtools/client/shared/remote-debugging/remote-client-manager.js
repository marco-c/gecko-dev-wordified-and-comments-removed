"
use
strict
"
;
const
{
CONNECTION_TYPES
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
remote
-
debugging
/
constants
.
js
"
)
;
class
RemoteClientManager
{
constructor
(
)
{
this
.
_clients
=
new
Map
(
)
;
this
.
_runtimeInfoMap
=
new
Map
(
)
;
this
.
_onClientClosed
=
this
.
_onClientClosed
.
bind
(
this
)
;
}
setClient
(
id
type
client
runtimeInfo
)
{
const
key
=
this
.
_getKey
(
id
type
)
;
this
.
_clients
.
set
(
key
client
)
;
if
(
runtimeInfo
)
{
this
.
_runtimeInfoMap
.
set
(
key
runtimeInfo
)
;
}
client
.
once
(
"
closed
"
this
.
_onClientClosed
)
;
}
hasClient
(
id
type
)
{
return
this
.
_clients
.
has
(
this
.
_getKey
(
id
type
)
)
;
}
getClient
(
id
type
)
{
return
this
.
_clients
.
get
(
this
.
_getKey
(
id
type
)
)
;
}
removeClient
(
id
type
)
{
const
key
=
this
.
_getKey
(
id
type
)
;
this
.
_removeClientByKey
(
key
)
;
}
removeAllClients
(
)
{
const
keys
=
[
.
.
.
this
.
_clients
.
keys
(
)
]
;
for
(
const
key
of
keys
)
{
this
.
_removeClientByKey
(
key
)
;
}
}
getRemoteId
(
id
type
)
{
return
encodeURIComponent
(
this
.
_getKey
(
id
type
)
)
;
}
getClientByRemoteId
(
remoteId
)
{
const
key
=
this
.
_getKeyByRemoteId
(
remoteId
)
;
return
this
.
_clients
.
get
(
key
)
;
}
getRuntimeInfoByRemoteId
(
remoteId
)
{
const
key
=
this
.
_getKeyByRemoteId
(
remoteId
)
;
return
this
.
_runtimeInfoMap
.
get
(
key
)
;
}
getConnectionTypeByRemoteId
(
remoteId
)
{
const
key
=
this
.
_getKeyByRemoteId
(
remoteId
)
;
for
(
const
type
of
Object
.
values
(
CONNECTION_TYPES
)
)
{
if
(
key
.
endsWith
(
type
)
)
{
return
type
;
}
}
return
CONNECTION_TYPES
.
UNKNOWN
;
}
_getKey
(
id
type
)
{
return
id
+
"
-
"
+
type
;
}
_getKeyByRemoteId
(
remoteId
)
{
if
(
!
remoteId
)
{
const
{
THIS_FIREFOX
}
=
CONNECTION_TYPES
;
return
this
.
_getKey
(
THIS_FIREFOX
THIS_FIREFOX
)
;
}
return
decodeURIComponent
(
remoteId
)
;
}
_removeClientByKey
(
key
)
{
const
client
=
this
.
_clients
.
get
(
key
)
;
if
(
client
)
{
client
.
off
(
"
closed
"
this
.
_onClientClosed
)
;
this
.
_clients
.
delete
(
key
)
;
this
.
_runtimeInfoMap
.
delete
(
key
)
;
}
}
_onClientClosed
(
)
{
const
closedClientKeys
=
[
.
.
.
this
.
_clients
.
keys
(
)
]
.
filter
(
key
=
>
{
return
this
.
_clients
.
get
(
key
)
.
_transportClosed
;
}
)
;
for
(
const
key
of
closedClientKeys
)
{
this
.
_removeClientByKey
(
key
)
;
}
}
}
module
.
exports
=
{
remoteClientManager
:
new
RemoteClientManager
(
)
}
;
