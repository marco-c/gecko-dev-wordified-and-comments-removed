"
use
strict
"
;
const
{
dumpn
}
=
require
(
"
resource
:
/
/
devtools
/
shared
/
DevToolsUtils
.
js
"
)
;
const
{
runCommand
}
=
require
(
"
resource
:
/
/
devtools
/
client
/
shared
/
remote
-
debugging
/
adb
/
commands
/
run
-
command
.
js
"
)
;
const
forwardPort
=
function
(
deviceId
localPort
devicePort
)
{
dumpn
(
"
forwardPort
"
+
localPort
+
"
-
-
"
+
devicePort
)
;
return
runCommand
(
host
-
serial
:
{
deviceId
}
:
forward
:
{
localPort
}
;
{
devicePort
}
)
.
then
(
function
onSuccess
(
data
)
{
return
data
;
}
)
;
}
;
const
getFreeTCPPort
=
function
(
)
{
const
serv
=
Cc
[
"
mozilla
.
org
/
network
/
server
-
socket
;
1
"
]
.
createInstance
(
Ci
.
nsIServerSocket
)
;
serv
.
init
(
-
1
true
-
1
)
;
const
port
=
serv
.
port
;
serv
.
close
(
)
;
return
port
;
}
;
const
prepareTCPConnection
=
async
function
(
deviceId
socketPath
)
{
const
port
=
getFreeTCPPort
(
)
;
const
local
=
tcp
:
{
port
}
;
const
remote
=
socketPath
.
startsWith
(
"
"
)
?
localabstract
:
{
socketPath
.
substring
(
1
)
}
:
localfilesystem
:
{
socketPath
}
;
await
forwardPort
(
deviceId
local
remote
)
;
return
port
;
}
;
exports
.
prepareTCPConnection
=
prepareTCPConnection
;
