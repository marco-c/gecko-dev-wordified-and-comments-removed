"
use
strict
"
;
const
{
colorUtils
}
=
require
(
"
devtools
/
shared
/
css
/
color
"
)
;
const
Spectrum
=
require
(
"
devtools
/
client
/
shared
/
widgets
/
Spectrum
"
)
;
const
SwatchBasedEditorTooltip
=
require
(
"
devtools
/
client
/
shared
/
widgets
/
tooltip
/
SwatchBasedEditorTooltip
"
)
;
const
{
LocalizationHelper
}
=
require
(
"
devtools
/
shared
/
l10n
"
)
;
const
L10N
=
new
LocalizationHelper
(
"
devtools
/
client
/
locales
/
inspector
.
properties
"
)
;
const
{
openDocLink
}
=
require
(
"
devtools
/
client
/
shared
/
link
"
)
;
const
{
A11Y_CONTRAST_LEARN_MORE_LINK
}
=
require
(
"
devtools
/
client
/
accessibility
/
constants
"
)
;
loader
.
lazyRequireGetter
(
this
"
throttle
"
"
devtools
/
shared
/
throttle
"
true
)
;
loader
.
lazyRequireGetter
(
this
[
"
getFocusableElements
"
"
wrapMoveFocus
"
]
"
devtools
/
client
/
shared
/
focus
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
PICKER_TYPES
"
"
devtools
/
shared
/
picker
-
constants
"
)
;
const
TELEMETRY_PICKER_EYEDROPPER_OPEN_COUNT
=
"
DEVTOOLS_PICKER_EYEDROPPER_OPENED_COUNT
"
;
const
XHTML_NS
=
"
http
:
/
/
www
.
w3
.
org
/
1999
/
xhtml
"
;
class
SwatchColorPickerTooltip
extends
SwatchBasedEditorTooltip
{
constructor
(
document
inspector
{
supportsCssColor4ColorFunction
}
)
{
super
(
document
)
;
this
.
inspector
=
inspector
;
this
.
spectrum
=
this
.
setColorPickerContent
(
[
0
0
0
1
]
)
;
this
.
_onSpectrumColorChange
=
this
.
_onSpectrumColorChange
.
bind
(
this
)
;
this
.
_openEyeDropper
=
this
.
_openEyeDropper
.
bind
(
this
)
;
this
.
_openDocLink
=
this
.
_openDocLink
.
bind
(
this
)
;
this
.
_onTooltipKeydown
=
this
.
_onTooltipKeydown
.
bind
(
this
)
;
this
.
cssColor4
=
supportsCssColor4ColorFunction
(
)
;
this
.
_selectColor
=
throttle
(
this
.
_selectColor
.
bind
(
this
)
50
)
;
this
.
tooltip
.
container
.
addEventListener
(
"
keydown
"
this
.
_onTooltipKeydown
)
;
}
setColorPickerContent
(
color
)
{
const
{
doc
}
=
this
.
tooltip
;
this
.
tooltip
.
panel
.
innerHTML
=
"
"
;
const
container
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
container
.
id
=
"
spectrum
-
tooltip
"
;
const
node
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
node
.
id
=
"
spectrum
"
;
container
.
appendChild
(
node
)
;
const
widget
=
new
Spectrum
(
node
color
)
;
this
.
tooltip
.
panel
.
appendChild
(
container
)
;
this
.
tooltip
.
setContentSize
(
{
width
:
215
}
)
;
widget
.
inspector
=
this
.
inspector
;
this
.
tooltip
.
once
(
"
shown
"
(
)
=
>
{
widget
.
show
(
)
;
}
)
;
return
widget
;
}
async
show
(
)
{
const
name
=
this
.
activeSwatch
.
dataset
.
propertyName
;
if
(
this
.
isContrastCompatible
=
=
=
undefined
)
{
const
target
=
this
.
inspector
.
currentTarget
;
this
.
isContrastCompatible
=
await
target
.
actorHasMethod
(
"
domnode
"
"
getBackgroundColor
"
)
;
}
this
.
spectrum
.
contrastEnabled
=
name
=
=
=
"
color
"
&
&
this
.
isContrastCompatible
;
if
(
this
.
spectrum
.
contrastEnabled
)
{
const
{
nodeFront
}
=
this
.
inspector
.
selection
;
const
{
pageStyle
}
=
nodeFront
.
inspectorFront
;
this
.
spectrum
.
textProps
=
await
pageStyle
.
getComputed
(
nodeFront
{
filterProperties
:
[
"
font
-
size
"
"
font
-
weight
"
"
opacity
"
]
}
)
;
this
.
spectrum
.
backgroundColorData
=
await
nodeFront
.
getBackgroundColor
(
)
;
}
if
(
this
.
activeSwatch
)
{
this
.
_originalColor
=
this
.
_getSwatchColorContainer
(
)
.
dataset
.
color
;
const
color
=
this
.
activeSwatch
.
style
.
backgroundColor
;
this
.
spectrum
.
off
(
"
changed
"
this
.
_onSpectrumColorChange
)
;
this
.
spectrum
.
rgb
=
this
.
_colorToRgba
(
color
)
;
this
.
spectrum
.
on
(
"
changed
"
this
.
_onSpectrumColorChange
)
;
this
.
spectrum
.
updateUI
(
)
;
}
await
super
.
show
(
)
;
const
eyeButton
=
this
.
tooltip
.
container
.
querySelector
(
"
#
eyedropper
-
button
"
)
;
const
canShowEyeDropper
=
await
this
.
inspector
.
supportsEyeDropper
(
)
;
if
(
canShowEyeDropper
)
{
eyeButton
.
disabled
=
false
;
eyeButton
.
removeAttribute
(
"
title
"
)
;
eyeButton
.
addEventListener
(
"
click
"
this
.
_openEyeDropper
)
;
}
else
{
eyeButton
.
disabled
=
true
;
eyeButton
.
title
=
L10N
.
getStr
(
"
eyedropper
.
disabled
.
title
"
)
;
}
const
learnMoreButton
=
this
.
tooltip
.
container
.
querySelector
(
"
#
learn
-
more
-
button
"
)
;
if
(
learnMoreButton
)
{
learnMoreButton
.
addEventListener
(
"
click
"
this
.
_openDocLink
)
;
learnMoreButton
.
addEventListener
(
"
keydown
"
e
=
>
e
.
stopPropagation
(
)
)
;
}
this
.
focusableElements
[
0
]
.
focus
(
)
;
this
.
tooltip
.
container
.
addEventListener
(
"
keydown
"
this
.
_onTooltipKeydown
true
)
;
this
.
emit
(
"
ready
"
)
;
}
_onTooltipKeydown
(
event
)
{
const
{
target
key
shiftKey
}
=
event
;
if
(
key
!
=
=
"
Tab
"
)
{
return
;
}
const
focusMoved
=
!
!
wrapMoveFocus
(
this
.
focusableElements
target
shiftKey
)
;
if
(
focusMoved
)
{
event
.
preventDefault
(
)
;
}
event
.
stopPropagation
(
)
;
}
_getSwatchColorContainer
(
)
{
return
this
.
activeSwatch
.
closest
(
"
[
data
-
color
]
"
)
;
}
_onSpectrumColorChange
(
rgba
cssColor
)
{
this
.
_selectColor
(
cssColor
)
;
}
_selectColor
(
color
)
{
if
(
this
.
activeSwatch
)
{
this
.
activeSwatch
.
style
.
backgroundColor
=
color
;
color
=
this
.
_toDefaultType
(
color
)
;
this
.
_getSwatchColorContainer
(
)
.
dataset
.
color
=
color
;
if
(
this
.
activeSwatch
.
nextSibling
)
{
this
.
activeSwatch
.
nextSibling
.
textContent
=
color
;
}
this
.
preview
(
color
)
;
if
(
this
.
eyedropperOpen
)
{
this
.
commit
(
)
;
}
}
}
onTooltipHidden
(
)
{
if
(
this
.
eyedropperOpen
)
{
return
;
}
super
.
onTooltipHidden
(
)
;
this
.
tooltip
.
container
.
removeEventListener
(
"
keydown
"
this
.
_onTooltipKeydown
)
;
}
_openEyeDropper
(
)
{
const
{
inspectorFront
toolbox
telemetry
}
=
this
.
inspector
;
telemetry
.
getHistogramById
(
TELEMETRY_PICKER_EYEDROPPER_OPEN_COUNT
)
.
add
(
true
)
;
toolbox
.
nodePicker
.
cancel
(
)
;
toolbox
.
tellRDMAboutPickerState
(
true
PICKER_TYPES
.
EYEDROPPER
)
;
this
.
eyedropperOpen
=
true
;
inspectorFront
.
pickColorFromPage
(
{
copyOnSelect
:
false
}
)
.
then
(
(
)
=
>
{
this
.
hide
(
)
;
this
.
tooltip
.
emit
(
"
eyedropper
-
opened
"
)
;
}
console
.
error
)
;
inspectorFront
.
once
(
"
color
-
picked
"
color
=
>
{
toolbox
.
win
.
focus
(
)
;
this
.
_selectColor
(
color
)
;
this
.
_onEyeDropperDone
(
)
;
}
)
;
inspectorFront
.
once
(
"
color
-
pick
-
canceled
"
(
)
=
>
{
this
.
_onEyeDropperDone
(
)
;
}
)
;
}
_openDocLink
(
)
{
openDocLink
(
A11Y_CONTRAST_LEARN_MORE_LINK
)
;
this
.
hide
(
)
;
}
_onEyeDropperDone
(
)
{
this
.
inspector
.
toolbox
.
tellRDMAboutPickerState
(
false
PICKER_TYPES
.
EYEDROPPER
)
;
this
.
eyedropperOpen
=
false
;
this
.
activeSwatch
=
null
;
}
_colorToRgba
(
color
)
{
color
=
new
colorUtils
.
CssColor
(
color
this
.
cssColor4
)
;
const
rgba
=
color
.
getRGBATuple
(
)
;
return
[
rgba
.
r
rgba
.
g
rgba
.
b
rgba
.
a
]
;
}
_toDefaultType
(
color
)
{
const
colorObj
=
new
colorUtils
.
CssColor
(
color
)
;
colorObj
.
setAuthoredUnitFromColor
(
this
.
_originalColor
this
.
cssColor4
)
;
return
colorObj
.
toString
(
)
;
}
isEditing
(
)
{
return
this
.
tooltip
.
isVisible
(
)
|
|
this
.
eyedropperOpen
;
}
get
focusableElements
(
)
{
return
getFocusableElements
(
this
.
tooltip
.
container
)
.
filter
(
el
=
>
!
!
el
.
offsetParent
)
;
}
destroy
(
)
{
super
.
destroy
(
)
;
this
.
inspector
=
null
;
this
.
spectrum
.
off
(
"
changed
"
this
.
_onSpectrumColorChange
)
;
this
.
spectrum
.
destroy
(
)
;
}
}
module
.
exports
=
SwatchColorPickerTooltip
;
