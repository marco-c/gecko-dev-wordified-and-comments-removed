"
use
strict
"
;
const
{
colorUtils
}
=
require
(
"
devtools
/
shared
/
css
/
color
"
)
;
const
{
Spectrum
}
=
require
(
"
devtools
/
client
/
shared
/
widgets
/
Spectrum
"
)
;
const
SwatchBasedEditorTooltip
=
require
(
"
devtools
/
client
/
shared
/
widgets
/
tooltip
/
SwatchBasedEditorTooltip
"
)
;
const
{
LocalizationHelper
}
=
require
(
"
devtools
/
shared
/
l10n
"
)
;
const
L10N
=
new
LocalizationHelper
(
"
devtools
/
client
/
locales
/
inspector
.
properties
"
)
;
const
TELEMETRY_PICKER_EYEDROPPER_OPEN_COUNT
=
"
DEVTOOLS_PICKER_EYEDROPPER_OPENED_COUNT
"
;
const
XHTML_NS
=
"
http
:
/
/
www
.
w3
.
org
/
1999
/
xhtml
"
;
class
SwatchColorPickerTooltip
extends
SwatchBasedEditorTooltip
{
constructor
(
document
inspector
{
supportsCssColor4ColorFunction
}
)
{
super
(
document
)
;
this
.
inspector
=
inspector
;
this
.
spectrum
=
this
.
setColorPickerContent
(
[
0
0
0
1
]
)
;
this
.
_onSpectrumColorChange
=
this
.
_onSpectrumColorChange
.
bind
(
this
)
;
this
.
_openEyeDropper
=
this
.
_openEyeDropper
.
bind
(
this
)
;
this
.
cssColor4
=
supportsCssColor4ColorFunction
(
)
;
}
setColorPickerContent
(
color
)
{
const
{
doc
}
=
this
.
tooltip
;
this
.
tooltip
.
panel
.
innerHTML
=
"
"
;
const
container
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
container
.
id
=
"
spectrum
-
tooltip
"
;
const
node
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
node
.
id
=
"
spectrum
"
;
container
.
appendChild
(
node
)
;
const
widget
=
new
Spectrum
(
node
color
)
;
this
.
tooltip
.
panel
.
appendChild
(
container
)
;
this
.
tooltip
.
setContentSize
(
{
width
:
215
}
)
;
widget
.
inspector
=
this
.
inspector
;
this
.
tooltip
.
once
(
"
shown
"
(
)
=
>
{
widget
.
show
(
)
;
}
)
;
return
widget
;
}
async
show
(
)
{
const
name
=
this
.
activeSwatch
.
dataset
.
propertyName
;
if
(
this
.
isContrastCompatible
=
=
=
undefined
)
{
const
target
=
this
.
inspector
.
target
;
this
.
isContrastCompatible
=
await
target
.
actorHasMethod
(
"
domnode
"
"
getClosestBackgroundColor
"
)
;
}
this
.
spectrum
.
contrastEnabled
=
name
=
=
=
"
color
"
&
&
this
.
isContrastCompatible
;
this
.
spectrum
.
textProps
=
this
.
spectrum
.
contrastEnabled
?
await
this
.
inspector
.
pageStyle
.
getComputed
(
this
.
inspector
.
selection
.
nodeFront
{
filterProperties
:
[
"
font
-
size
"
"
font
-
weight
"
]
}
)
:
null
;
await
super
.
show
(
)
;
if
(
this
.
activeSwatch
)
{
this
.
currentSwatchColor
=
this
.
activeSwatch
.
nextSibling
;
this
.
_originalColor
=
this
.
currentSwatchColor
.
textContent
;
const
color
=
this
.
activeSwatch
.
style
.
backgroundColor
;
this
.
spectrum
.
off
(
"
changed
"
this
.
_onSpectrumColorChange
)
;
this
.
spectrum
.
rgb
=
this
.
_colorToRgba
(
color
)
;
this
.
spectrum
.
on
(
"
changed
"
this
.
_onSpectrumColorChange
)
;
this
.
spectrum
.
updateUI
(
)
;
}
const
eyeButton
=
this
.
tooltip
.
container
.
querySelector
(
"
#
eyedropper
-
button
"
)
;
const
canShowEyeDropper
=
await
this
.
inspector
.
supportsEyeDropper
(
)
;
if
(
canShowEyeDropper
)
{
eyeButton
.
disabled
=
false
;
eyeButton
.
removeAttribute
(
"
title
"
)
;
eyeButton
.
addEventListener
(
"
click
"
this
.
_openEyeDropper
)
;
}
else
{
eyeButton
.
disabled
=
true
;
eyeButton
.
title
=
L10N
.
getStr
(
"
eyedropper
.
disabled
.
title
"
)
;
}
this
.
tooltip
.
updateContainerBounds
(
super
.
tooltipAnchor
)
;
this
.
emit
(
"
ready
"
)
;
}
_onSpectrumColorChange
(
rgba
cssColor
)
{
this
.
_selectColor
(
cssColor
)
;
}
_selectColor
(
color
)
{
if
(
this
.
activeSwatch
)
{
this
.
activeSwatch
.
style
.
backgroundColor
=
color
;
this
.
activeSwatch
.
parentNode
.
dataset
.
color
=
color
;
color
=
this
.
_toDefaultType
(
color
)
;
this
.
currentSwatchColor
.
textContent
=
color
;
this
.
preview
(
color
)
;
if
(
this
.
eyedropperOpen
)
{
this
.
commit
(
)
;
}
}
}
onTooltipHidden
(
)
{
if
(
this
.
eyedropperOpen
)
{
return
;
}
super
.
onTooltipHidden
(
)
;
}
_openEyeDropper
(
)
{
const
{
inspector
toolbox
telemetry
}
=
this
.
inspector
;
telemetry
.
getHistogramById
(
TELEMETRY_PICKER_EYEDROPPER_OPEN_COUNT
)
.
add
(
true
)
;
inspector
.
nodePicker
.
cancel
(
)
;
this
.
eyedropperOpen
=
true
;
inspector
.
pickColorFromPage
(
{
copyOnSelect
:
false
}
)
.
then
(
(
)
=
>
{
this
.
hide
(
)
;
this
.
tooltip
.
emit
(
"
eyedropper
-
opened
"
)
;
}
console
.
error
)
;
inspector
.
once
(
"
color
-
picked
"
color
=
>
{
toolbox
.
win
.
focus
(
)
;
this
.
_selectColor
(
color
)
;
this
.
_onEyeDropperDone
(
)
;
}
)
;
inspector
.
once
(
"
color
-
pick
-
canceled
"
(
)
=
>
{
this
.
_onEyeDropperDone
(
)
;
}
)
;
}
_onEyeDropperDone
(
)
{
this
.
eyedropperOpen
=
false
;
this
.
activeSwatch
=
null
;
}
_colorToRgba
(
color
)
{
color
=
new
colorUtils
.
CssColor
(
color
this
.
cssColor4
)
;
const
rgba
=
color
.
getRGBATuple
(
)
;
return
[
rgba
.
r
rgba
.
g
rgba
.
b
rgba
.
a
]
;
}
_toDefaultType
(
color
)
{
const
colorObj
=
new
colorUtils
.
CssColor
(
color
)
;
colorObj
.
setAuthoredUnitFromColor
(
this
.
_originalColor
this
.
cssColor4
)
;
return
colorObj
.
toString
(
)
;
}
isEditing
(
)
{
return
this
.
tooltip
.
isVisible
(
)
|
|
this
.
eyedropperOpen
;
}
destroy
(
)
{
super
.
destroy
(
)
;
this
.
inspector
=
null
;
this
.
currentSwatchColor
=
null
;
this
.
spectrum
.
off
(
"
changed
"
this
.
_onSpectrumColorChange
)
;
this
.
spectrum
.
destroy
(
)
;
}
}
module
.
exports
=
SwatchColorPickerTooltip
;
