"
use
strict
"
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
KeyShortcuts
=
require
(
"
devtools
/
client
/
shared
/
key
-
shortcuts
"
)
;
const
{
HTMLTooltip
}
=
require
(
"
devtools
/
client
/
shared
/
widgets
/
tooltip
/
HTMLTooltip
"
)
;
loader
.
lazyRequireGetter
(
this
"
KeyCodes
"
"
devtools
/
client
/
shared
/
keycodes
"
true
)
;
class
SwatchBasedEditorTooltip
{
constructor
(
document
)
{
EventEmitter
.
decorate
(
this
)
;
this
.
tooltip
=
new
HTMLTooltip
(
document
{
type
:
"
arrow
"
consumeOutsideClicks
:
true
useXulWrapper
:
true
}
)
;
this
.
shortcuts
=
new
KeyShortcuts
(
{
window
:
this
.
tooltip
.
doc
.
defaultView
}
)
;
this
.
shortcuts
.
on
(
"
Escape
"
event
=
>
{
if
(
!
this
.
tooltip
.
isVisible
(
)
)
{
return
;
}
this
.
revert
(
)
;
this
.
hide
(
)
;
event
.
stopPropagation
(
)
;
event
.
preventDefault
(
)
;
}
)
;
this
.
shortcuts
.
on
(
"
Return
"
event
=
>
{
if
(
!
this
.
tooltip
.
isVisible
(
)
)
{
return
;
}
this
.
commit
(
)
;
this
.
hide
(
)
;
event
.
stopPropagation
(
)
;
event
.
preventDefault
(
)
;
}
)
;
this
.
swatches
=
new
Map
(
)
;
this
.
activeSwatch
=
null
;
this
.
_onSwatchClick
=
this
.
_onSwatchClick
.
bind
(
this
)
;
this
.
_onSwatchKeyDown
=
this
.
_onSwatchKeyDown
.
bind
(
this
)
;
}
isVisible
(
)
{
return
this
.
tooltip
.
isVisible
(
)
;
}
isEditing
(
)
{
return
this
.
isVisible
(
)
;
}
show
(
)
{
if
(
this
.
tooltipAnchor
)
{
const
onShown
=
this
.
tooltip
.
once
(
"
shown
"
)
;
this
.
tooltip
.
show
(
this
.
tooltipAnchor
)
;
this
.
tooltip
.
once
(
"
hidden
"
(
)
=
>
this
.
onTooltipHidden
(
)
)
;
return
onShown
;
}
return
Promise
.
resolve
(
)
;
}
onTooltipHidden
(
)
{
if
(
!
this
.
_reverted
)
{
this
.
commit
(
)
;
}
this
.
_reverted
=
false
;
this
.
activeSwatch
=
null
;
}
hide
(
)
{
if
(
this
.
swatchActivatedWithKeyboard
)
{
this
.
activeSwatch
.
focus
(
)
;
this
.
swatchActivatedWithKeyboard
=
null
;
}
this
.
tooltip
.
hide
(
)
;
}
addSwatch
(
swatchEl
callbacks
=
{
}
)
{
if
(
!
callbacks
.
onShow
)
{
callbacks
.
onShow
=
function
(
)
{
}
;
}
if
(
!
callbacks
.
onPreview
)
{
callbacks
.
onPreview
=
function
(
)
{
}
;
}
if
(
!
callbacks
.
onRevert
)
{
callbacks
.
onRevert
=
function
(
)
{
}
;
}
if
(
!
callbacks
.
onCommit
)
{
callbacks
.
onCommit
=
function
(
)
{
}
;
}
this
.
swatches
.
set
(
swatchEl
{
callbacks
}
)
;
swatchEl
.
addEventListener
(
"
click
"
this
.
_onSwatchClick
)
;
swatchEl
.
addEventListener
(
"
keydown
"
this
.
_onSwatchKeyDown
)
;
}
removeSwatch
(
swatchEl
)
{
if
(
this
.
swatches
.
has
(
swatchEl
)
)
{
if
(
this
.
activeSwatch
=
=
=
swatchEl
)
{
this
.
hide
(
)
;
this
.
activeSwatch
=
null
;
}
swatchEl
.
removeEventListener
(
"
click
"
this
.
_onSwatchClick
)
;
swatchEl
.
removeEventListener
(
"
keydown
"
this
.
_onSwatchKeyDown
)
;
this
.
swatches
.
delete
(
swatchEl
)
;
}
}
_onSwatchKeyDown
(
event
)
{
if
(
event
.
keyCode
=
=
=
KeyCodes
.
DOM_VK_RETURN
|
|
event
.
keyCode
=
=
=
KeyCodes
.
DOM_VK_SPACE
)
{
event
.
preventDefault
(
)
;
event
.
stopPropagation
(
)
;
this
.
_onSwatchClick
(
event
)
;
}
}
_onSwatchClick
(
event
)
{
const
{
shiftKey
clientX
clientY
target
}
=
event
;
this
.
swatchActivatedWithKeyboard
=
event
.
key
&
&
clientX
=
=
=
0
&
&
clientY
=
=
=
0
;
if
(
shiftKey
)
{
event
.
stopPropagation
(
)
;
return
;
}
const
swatch
=
this
.
swatches
.
get
(
target
)
;
if
(
swatch
)
{
this
.
activeSwatch
=
target
;
this
.
show
(
)
;
swatch
.
callbacks
.
onShow
(
)
;
event
.
stopPropagation
(
)
;
}
}
preview
(
value
)
{
if
(
this
.
activeSwatch
)
{
const
swatch
=
this
.
swatches
.
get
(
this
.
activeSwatch
)
;
swatch
.
callbacks
.
onPreview
(
value
)
;
}
}
revert
(
)
{
if
(
this
.
activeSwatch
)
{
this
.
_reverted
=
true
;
const
swatch
=
this
.
swatches
.
get
(
this
.
activeSwatch
)
;
this
.
tooltip
.
once
(
"
hidden
"
(
)
=
>
{
swatch
.
callbacks
.
onRevert
(
)
;
}
)
;
}
}
commit
(
)
{
if
(
this
.
activeSwatch
)
{
const
swatch
=
this
.
swatches
.
get
(
this
.
activeSwatch
)
;
swatch
.
callbacks
.
onCommit
(
)
;
}
}
get
tooltipAnchor
(
)
{
return
this
.
activeSwatch
;
}
destroy
(
)
{
this
.
swatches
.
clear
(
)
;
this
.
activeSwatch
=
null
;
this
.
tooltip
.
off
(
"
keydown
"
this
.
_onTooltipKeydown
)
;
this
.
tooltip
.
destroy
(
)
;
this
.
shortcuts
.
destroy
(
)
;
}
}
module
.
exports
=
SwatchBasedEditorTooltip
;
