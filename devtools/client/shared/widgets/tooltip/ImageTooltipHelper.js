"
use
strict
"
;
const
{
LocalizationHelper
}
=
require
(
"
devtools
/
shared
/
l10n
"
)
;
const
L10N
=
new
LocalizationHelper
(
"
devtools
/
client
/
locales
/
inspector
.
properties
"
)
;
const
XHTML_NS
=
"
http
:
/
/
www
.
w3
.
org
/
1999
/
xhtml
"
;
const
MAX_DIMENSION
=
200
;
const
CONTAINER_MIN_WIDTH
=
100
;
const
IMAGE_PADDING
=
4
;
const
LABEL_HEIGHT
=
20
;
function
getImageDimensions
(
doc
imageUrl
)
{
return
new
Promise
(
resolve
=
>
{
const
imgObj
=
new
doc
.
defaultView
.
Image
(
)
;
imgObj
.
onload
=
(
)
=
>
{
imgObj
.
onload
=
null
;
const
{
naturalWidth
naturalHeight
}
=
imgObj
;
resolve
(
{
naturalWidth
naturalHeight
}
)
;
}
;
imgObj
.
src
=
imageUrl
;
}
)
;
}
function
setImageTooltip
(
tooltip
doc
imageUrl
options
)
{
let
{
naturalWidth
naturalHeight
hideDimensionLabel
hideCheckeredBackground
maxDim
}
=
options
;
maxDim
=
maxDim
|
|
MAX_DIMENSION
;
let
imgHeight
=
naturalHeight
;
let
imgWidth
=
naturalWidth
;
if
(
imgHeight
>
maxDim
|
|
imgWidth
>
maxDim
)
{
const
scale
=
maxDim
/
Math
.
max
(
imgHeight
imgWidth
)
;
imgHeight
=
Math
.
floor
(
scale
*
naturalHeight
)
;
imgWidth
=
Math
.
ceil
(
scale
*
naturalWidth
)
;
}
const
container
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
container
.
classList
.
add
(
"
devtools
-
tooltip
-
image
-
container
"
)
;
const
wrapper
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
wrapper
.
classList
.
add
(
"
devtools
-
tooltip
-
image
-
wrapper
"
)
;
container
.
appendChild
(
wrapper
)
;
const
img
=
doc
.
createElementNS
(
XHTML_NS
"
img
"
)
;
img
.
classList
.
add
(
"
devtools
-
tooltip
-
image
"
)
;
img
.
classList
.
toggle
(
"
devtools
-
tooltip
-
tiles
"
!
hideCheckeredBackground
)
;
img
.
style
.
height
=
imgHeight
;
img
.
src
=
encodeURI
(
imageUrl
)
;
wrapper
.
appendChild
(
img
)
;
if
(
!
hideDimensionLabel
)
{
const
dimensions
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
dimensions
.
classList
.
add
(
"
devtools
-
tooltip
-
image
-
dimensions
"
)
;
container
.
appendChild
(
dimensions
)
;
const
label
=
naturalWidth
+
"
\
u00D7
"
+
naturalHeight
;
const
span
=
doc
.
createElementNS
(
XHTML_NS
"
span
"
)
;
span
.
classList
.
add
(
"
theme
-
comment
"
"
devtools
-
tooltip
-
caption
"
)
;
span
.
textContent
=
label
;
dimensions
.
appendChild
(
span
)
;
}
tooltip
.
panel
.
innerHTML
=
"
"
;
tooltip
.
panel
.
appendChild
(
container
)
;
const
width
=
Math
.
max
(
CONTAINER_MIN_WIDTH
imgWidth
+
2
*
IMAGE_PADDING
)
;
let
height
=
imgHeight
+
2
*
IMAGE_PADDING
;
if
(
!
hideDimensionLabel
)
{
height
+
=
parseFloat
(
LABEL_HEIGHT
)
;
}
tooltip
.
setContentSize
(
{
width
height
}
)
;
}
function
setBrokenImageTooltip
(
tooltip
doc
)
{
const
div
=
doc
.
createElementNS
(
XHTML_NS
"
div
"
)
;
div
.
className
=
"
theme
-
comment
devtools
-
tooltip
-
image
-
broken
"
;
const
message
=
L10N
.
getStr
(
"
previewTooltip
.
image
.
brokenImage
"
)
;
div
.
textContent
=
message
;
tooltip
.
panel
.
innerHTML
=
"
"
;
tooltip
.
panel
.
appendChild
(
div
)
;
tooltip
.
setContentSize
(
{
width
:
"
auto
"
height
:
"
auto
"
}
)
;
}
module
.
exports
.
getImageDimensions
=
getImageDimensions
;
module
.
exports
.
setImageTooltip
=
setImageTooltip
;
module
.
exports
.
setBrokenImageTooltip
=
setBrokenImageTooltip
;
