"
use
strict
"
;
const
{
Task
}
=
require
(
"
resource
:
/
/
gre
/
modules
/
Task
.
jsm
"
)
;
const
DEFAULT_SHOW_DELAY
=
50
;
function
TooltipToggle
(
tooltip
)
{
this
.
tooltip
=
tooltip
;
this
.
win
=
tooltip
.
doc
.
defaultView
;
this
.
_onMouseMove
=
this
.
_onMouseMove
.
bind
(
this
)
;
this
.
_onMouseLeave
=
this
.
_onMouseLeave
.
bind
(
this
)
;
}
module
.
exports
.
TooltipToggle
=
TooltipToggle
;
TooltipToggle
.
prototype
=
{
start
:
function
(
baseNode
targetNodeCb
showDelay
=
DEFAULT_SHOW_DELAY
)
{
this
.
stop
(
)
;
if
(
!
baseNode
)
{
return
;
}
this
.
_baseNode
=
baseNode
;
this
.
_showDelay
=
showDelay
;
this
.
_targetNodeCb
=
targetNodeCb
|
|
(
(
)
=
>
true
)
;
baseNode
.
addEventListener
(
"
mousemove
"
this
.
_onMouseMove
false
)
;
baseNode
.
addEventListener
(
"
mouseleave
"
this
.
_onMouseLeave
false
)
;
}
stop
:
function
(
)
{
this
.
win
.
clearTimeout
(
this
.
toggleTimer
)
;
if
(
!
this
.
_baseNode
)
{
return
;
}
this
.
_baseNode
.
removeEventListener
(
"
mousemove
"
this
.
_onMouseMove
false
)
;
this
.
_baseNode
.
removeEventListener
(
"
mouseleave
"
this
.
_onMouseLeave
false
)
;
this
.
_baseNode
=
null
;
this
.
_targetNodeCb
=
null
;
this
.
_lastHovered
=
null
;
}
_onMouseMove
:
function
(
event
)
{
if
(
event
.
target
!
=
=
this
.
_lastHovered
)
{
this
.
tooltip
.
hide
(
)
;
this
.
_lastHovered
=
event
.
target
;
this
.
win
.
clearTimeout
(
this
.
toggleTimer
)
;
this
.
toggleTimer
=
this
.
win
.
setTimeout
(
(
)
=
>
{
this
.
isValidHoverTarget
(
event
.
target
)
.
then
(
target
=
>
{
if
(
target
=
=
=
null
)
{
return
;
}
this
.
tooltip
.
show
(
target
)
;
}
reason
=
>
{
console
.
error
(
"
isValidHoverTarget
rejected
with
unexpected
reason
:
"
)
;
console
.
error
(
reason
)
;
}
)
;
}
this
.
_showDelay
)
;
}
}
isValidHoverTarget
:
Task
.
async
(
function
*
(
target
)
{
let
res
=
yield
this
.
_targetNodeCb
(
target
this
.
tooltip
)
;
if
(
res
)
{
return
res
.
nodeName
?
res
:
target
;
}
return
null
;
}
)
_onMouseLeave
:
function
(
)
{
this
.
win
.
clearTimeout
(
this
.
toggleTimer
)
;
this
.
_lastHovered
=
null
;
this
.
tooltip
.
hide
(
)
;
}
destroy
:
function
(
)
{
this
.
stop
(
)
;
}
}
;
