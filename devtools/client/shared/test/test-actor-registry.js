"
use
strict
"
;
(
function
(
exports
)
{
const
CC
=
Components
.
Constructor
;
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
const
{
fetch
}
=
require
(
"
devtools
/
shared
/
DevToolsUtils
"
)
;
const
TEST_URL_ROOT
=
"
http
:
/
/
example
.
com
/
browser
/
devtools
/
client
/
shared
/
test
/
"
;
const
ACTOR_URL
=
TEST_URL_ROOT
+
"
test
-
actor
.
js
"
;
exports
.
registerTestActor
=
async
function
(
client
)
{
const
response
=
await
client
.
listTabs
(
)
;
const
{
ActorRegistryFront
}
=
require
(
"
devtools
/
shared
/
fronts
/
actor
-
registry
"
)
;
const
registryFront
=
ActorRegistryFront
(
client
response
)
;
const
options
=
{
type
:
{
target
:
true
}
constructor
:
"
TestActor
"
prefix
:
"
testActor
"
}
;
const
testActorFront
=
await
registryFront
.
registerActor
(
ACTOR_URL
options
)
;
return
testActorFront
;
}
;
const
loadFront
=
async
function
(
)
{
const
sourceText
=
await
request
(
ACTOR_URL
)
;
const
principal
=
CC
(
"
mozilla
.
org
/
systemprincipal
;
1
"
"
nsIPrincipal
"
)
(
)
;
const
sandbox
=
Cu
.
Sandbox
(
principal
)
;
sandbox
.
exports
=
{
}
;
sandbox
.
require
=
require
;
Cu
.
evalInSandbox
(
sourceText
sandbox
"
1
.
8
"
ACTOR_URL
1
)
;
return
sandbox
.
exports
;
}
;
const
getUpdatedForm
=
function
(
client
tab
)
{
return
client
.
getTab
(
{
tab
:
tab
}
)
.
then
(
response
=
>
response
.
tab
)
;
}
;
exports
.
getTestActor
=
async
function
(
toolbox
)
{
const
client
=
toolbox
.
target
.
client
;
return
getTestActor
(
client
toolbox
.
target
.
tab
toolbox
)
;
}
;
exports
.
getTestActorWithoutToolbox
=
async
function
(
tab
)
{
const
{
DebuggerServer
}
=
require
(
"
devtools
/
server
/
main
"
)
;
const
{
DebuggerClient
}
=
require
(
"
devtools
/
shared
/
client
/
debugger
-
client
"
)
;
DebuggerServer
.
init
(
)
;
DebuggerServer
.
registerAllActors
(
)
;
const
client
=
new
DebuggerClient
(
DebuggerServer
.
connectPipe
(
)
)
;
await
client
.
connect
(
)
;
await
exports
.
registerTestActor
(
client
)
;
return
getTestActor
(
client
tab
)
;
}
;
const
request
=
function
(
uri
)
{
return
fetch
(
uri
)
.
then
(
(
{
content
}
)
=
>
content
)
;
}
;
const
getTestActor
=
async
function
(
client
tab
toolbox
)
{
const
form
=
await
getUpdatedForm
(
client
tab
)
;
const
{
TestActorFront
}
=
await
loadFront
(
)
;
return
new
TestActorFront
(
client
form
toolbox
)
;
}
;
}
)
(
this
)
;
