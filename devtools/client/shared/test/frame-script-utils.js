"
use
strict
"
;
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
)
;
const
Services
=
require
(
"
Services
"
)
;
addMessageListener
(
"
devtools
:
test
:
history
"
function
(
{
data
}
)
{
content
.
history
[
data
.
direction
]
(
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
navigate
"
function
(
{
data
}
)
{
content
.
location
=
data
.
location
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
reload
"
function
(
{
data
}
)
{
data
=
data
|
|
{
}
;
content
.
location
.
reload
(
data
.
forceget
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
console
"
function
(
{
data
}
)
{
const
{
method
args
id
}
=
data
;
content
.
console
[
method
]
.
apply
(
content
.
console
args
)
;
sendAsyncMessage
(
"
devtools
:
test
:
console
:
response
"
{
id
}
)
;
}
)
;
function
promiseXHR
(
data
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
const
xhr
=
new
content
.
XMLHttpRequest
(
)
;
const
method
=
data
.
method
|
|
"
GET
"
;
let
url
=
data
.
url
|
|
content
.
location
.
href
;
const
body
=
data
.
body
|
|
"
"
;
if
(
data
.
nocache
)
{
url
+
=
"
?
devtools
-
cachebust
=
"
+
Math
.
random
(
)
;
}
xhr
.
addEventListener
(
"
loadend
"
function
(
event
)
{
resolve
(
{
status
:
xhr
.
status
response
:
xhr
.
response
}
)
;
}
{
once
:
true
}
)
;
xhr
.
open
(
method
url
)
;
if
(
data
.
requestHeaders
)
{
data
.
requestHeaders
.
forEach
(
header
=
>
{
xhr
.
setRequestHeader
(
header
.
name
header
.
value
)
;
}
)
;
}
xhr
.
send
(
body
)
;
}
)
;
}
addMessageListener
(
"
devtools
:
test
:
xhr
"
async
function
(
{
data
}
)
{
const
requests
=
Array
.
isArray
(
data
)
?
data
:
[
data
]
;
const
responses
=
[
]
;
for
(
const
request
of
requests
)
{
const
response
=
await
promiseXHR
(
request
)
;
responses
.
push
(
response
)
;
}
sendAsyncMessage
(
"
devtools
:
test
:
xhr
"
responses
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
profiler
"
function
(
{
data
}
)
{
const
{
method
args
id
}
=
data
;
const
result
=
Services
.
profiler
[
method
]
(
.
.
.
args
)
;
sendAsyncMessage
(
"
devtools
:
test
:
profiler
:
response
"
{
data
:
result
id
:
id
}
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
eval
"
function
(
{
data
}
)
{
sendAsyncMessage
(
"
devtools
:
test
:
eval
:
response
"
{
value
:
content
.
eval
(
data
.
script
)
id
:
data
.
id
}
)
;
}
)
;
addEventListener
(
"
load
"
function
(
)
{
sendAsyncMessage
(
"
devtools
:
test
:
load
"
)
;
}
true
)
;
addMessageListener
(
"
devtools
:
test
:
setStyle
"
function
(
msg
)
{
const
{
selector
propertyName
propertyValue
}
=
msg
.
data
;
const
node
=
superQuerySelector
(
selector
)
;
if
(
!
node
)
{
return
;
}
node
.
style
[
propertyName
]
=
propertyValue
;
sendAsyncMessage
(
"
devtools
:
test
:
setStyle
"
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
setMultipleStyles
"
function
(
msg
)
{
const
{
selector
properties
}
=
msg
.
data
;
const
node
=
superQuerySelector
(
selector
)
;
if
(
!
node
)
{
return
;
}
for
(
const
propertyName
in
properties
)
{
const
propertyValue
=
properties
[
propertyName
]
;
node
.
style
[
propertyName
]
=
propertyValue
;
}
sendAsyncMessage
(
"
devtools
:
test
:
setMultipleStyles
"
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
setAttribute
"
function
(
msg
)
{
const
{
selector
attributeName
attributeValue
}
=
msg
.
data
;
const
node
=
superQuerySelector
(
selector
)
;
if
(
!
node
)
{
return
;
}
node
.
setAttribute
(
attributeName
attributeValue
)
;
sendAsyncMessage
(
"
devtools
:
test
:
setAttribute
"
)
;
}
)
;
function
superQuerySelector
(
superSelector
root
=
content
.
document
)
{
const
frameIndex
=
superSelector
.
indexOf
(
"
|
|
"
)
;
if
(
frameIndex
=
=
=
-
1
)
{
return
root
.
querySelector
(
superSelector
)
;
}
const
rootSelector
=
superSelector
.
substring
(
0
frameIndex
)
.
trim
(
)
;
const
childSelector
=
superSelector
.
substring
(
frameIndex
+
2
)
.
trim
(
)
;
root
=
root
.
querySelector
(
rootSelector
)
;
if
(
!
root
|
|
!
root
.
contentWindow
)
{
return
null
;
}
return
superQuerySelector
(
childSelector
root
.
contentWindow
.
document
)
;
}
