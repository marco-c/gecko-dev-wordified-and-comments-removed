"
use
strict
"
;
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
)
;
const
Services
=
require
(
"
Services
"
)
;
addMessageListener
(
"
devtools
:
test
:
history
"
function
(
{
data
}
)
{
content
.
history
[
data
.
direction
]
(
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
navigate
"
function
(
{
data
}
)
{
content
.
location
=
data
.
location
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
reload
"
function
(
{
data
}
)
{
data
=
data
|
|
{
}
;
content
.
location
.
reload
(
data
.
forceget
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
console
"
function
(
{
data
}
)
{
const
{
method
args
id
}
=
data
;
content
.
console
[
method
]
.
apply
(
content
.
console
args
)
;
sendAsyncMessage
(
"
devtools
:
test
:
console
:
response
"
{
id
}
)
;
}
)
;
function
promiseXHR
(
data
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
const
xhr
=
new
content
.
XMLHttpRequest
(
)
;
const
method
=
data
.
method
|
|
"
GET
"
;
let
url
=
data
.
url
|
|
content
.
location
.
href
;
const
body
=
data
.
body
|
|
"
"
;
if
(
data
.
nocache
)
{
url
+
=
"
?
devtools
-
cachebust
=
"
+
Math
.
random
(
)
;
}
xhr
.
addEventListener
(
"
loadend
"
function
(
event
)
{
resolve
(
{
status
:
xhr
.
status
response
:
xhr
.
response
}
)
;
}
{
once
:
true
}
)
;
xhr
.
open
(
method
url
)
;
if
(
data
.
requestHeaders
)
{
data
.
requestHeaders
.
forEach
(
header
=
>
{
xhr
.
setRequestHeader
(
header
.
name
header
.
value
)
;
}
)
;
}
xhr
.
send
(
body
)
;
}
)
;
}
function
promiseWS
(
data
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
url
=
data
.
url
;
if
(
data
.
nocache
)
{
url
+
=
"
?
devtools
-
cachebust
=
"
+
Math
.
random
(
)
;
}
const
socket
=
new
content
.
WebSocket
(
url
)
;
socket
.
onclose
=
e
=
>
{
socket
.
close
(
)
;
resolve
(
{
status
:
101
response
:
"
"
}
)
;
}
;
socket
.
onerror
=
e
=
>
{
socket
.
close
(
)
;
resolve
(
{
status
:
101
response
:
"
"
}
)
;
}
;
}
)
;
}
addMessageListener
(
"
devtools
:
test
:
xhr
"
async
function
(
{
data
}
)
{
const
requests
=
Array
.
isArray
(
data
)
?
data
:
[
data
]
;
const
responses
=
[
]
;
for
(
const
request
of
requests
)
{
let
response
=
null
;
if
(
request
.
ws
)
{
response
=
await
promiseWS
(
request
)
;
}
else
{
response
=
await
promiseXHR
(
request
)
;
}
responses
.
push
(
response
)
;
}
sendAsyncMessage
(
"
devtools
:
test
:
xhr
"
responses
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
profiler
"
function
(
{
data
}
)
{
const
{
method
args
id
}
=
data
;
const
result
=
Services
.
profiler
[
method
]
(
.
.
.
args
)
;
sendAsyncMessage
(
"
devtools
:
test
:
profiler
:
response
"
{
data
:
result
id
:
id
}
)
;
}
)
;
addMessageListener
(
"
devtools
:
test
:
eval
"
function
(
{
data
}
)
{
sendAsyncMessage
(
"
devtools
:
test
:
eval
:
response
"
{
value
:
content
.
eval
(
data
.
script
)
id
:
data
.
id
}
)
;
}
)
;
addEventListener
(
"
load
"
function
(
)
{
sendAsyncMessage
(
"
devtools
:
test
:
load
"
)
;
}
true
)
;
