"
use
strict
"
;
const
TEST_URI
=
"
data
:
text
/
html
;
charset
=
utf
-
8
"
+
"
<
p
>
browser_telemetry_button_responsive
.
js
<
/
p
>
"
;
const
TOOL_DELAY
=
200
;
const
asyncStorage
=
require
(
"
resource
:
/
/
devtools
/
shared
/
async
-
storage
.
js
"
)
;
requestLongerTimeout
(
2
)
;
Services
.
prefs
.
clearUserPref
(
"
devtools
.
responsive
.
html
.
displayedDeviceList
"
)
;
registerCleanupFunction
(
(
)
=
>
{
asyncStorage
.
removeItem
(
"
devtools
.
devices
.
local
"
)
;
}
)
;
loader
.
lazyRequireGetter
(
this
"
ResponsiveUIManager
"
"
resource
:
/
/
devtools
/
client
/
responsive
/
manager
.
js
"
)
;
add_task
(
async
function
(
)
{
await
addTab
(
TEST_URI
)
;
startTelemetry
(
)
;
const
tab
=
gBrowser
.
selectedTab
;
const
toolbox
=
await
gDevTools
.
showToolboxForTab
(
tab
{
toolId
:
"
inspector
"
}
)
;
info
(
"
inspector
opened
"
)
;
info
(
"
testing
the
responsivedesign
button
"
)
;
await
testButton
(
tab
toolbox
)
;
await
toolbox
.
destroy
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
async
function
testButton
(
tab
toolbox
)
{
info
(
"
Testing
command
-
button
-
responsive
"
)
;
const
button
=
toolbox
.
doc
.
querySelector
(
"
#
command
-
button
-
responsive
"
)
;
ok
(
button
"
Captain
we
have
the
button
"
)
;
await
delayedClicks
(
tab
button
4
)
;
checkResults
(
)
;
}
function
waitForToggle
(
)
{
return
new
Promise
(
resolve
=
>
{
const
handler
=
(
)
=
>
{
ResponsiveUIManager
.
off
(
"
on
"
handler
)
;
ResponsiveUIManager
.
off
(
"
off
"
handler
)
;
resolve
(
)
;
}
;
ResponsiveUIManager
.
on
(
"
on
"
handler
)
;
ResponsiveUIManager
.
on
(
"
off
"
handler
)
;
}
)
;
}
var
delayedClicks
=
async
function
(
tab
node
clicks
)
{
for
(
let
i
=
0
;
i
<
clicks
;
i
+
+
)
{
info
(
"
Clicking
button
"
+
node
.
id
)
;
const
toggled
=
waitForToggle
(
)
;
node
.
click
(
)
;
await
toggled
;
await
DevToolsUtils
.
waitForTime
(
TOOL_DELAY
)
;
if
(
i
%
2
=
=
0
)
{
await
waitFor
(
(
)
=
>
ResponsiveUIManager
.
isActiveForTab
(
tab
)
)
;
const
rdmUI
=
ResponsiveUIManager
.
getResponsiveUIForTab
(
tab
)
;
await
waitForRDMLoaded
(
rdmUI
)
;
}
}
}
;
function
checkResults
(
)
{
checkTelemetry
(
"
DEVTOOLS_RESPONSIVE_OPENED_COUNT
"
"
"
{
0
:
2
1
:
0
}
"
array
"
)
;
checkTelemetry
(
"
DEVTOOLS_RESPONSIVE_TIME_ACTIVE_SECONDS
"
"
"
null
"
hasentries
"
)
;
}
