"
use
strict
"
;
const
{
Ci
ChromeWorker
}
=
require
(
"
chrome
"
)
;
const
{
Services
}
=
require
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
HOTRELOAD_PREF
=
"
devtools
.
loader
.
hotreload
"
;
function
resolveResourceURI
(
uri
)
{
const
handler
=
Services
.
io
.
getProtocolHandler
(
"
resource
"
)
.
QueryInterface
(
Ci
.
nsIResProtocolHandler
)
;
return
handler
.
resolveURI
(
Services
.
io
.
newURI
(
uri
null
null
)
)
;
}
function
watchFiles
(
path
onFileChanged
)
{
if
(
!
path
.
startsWith
(
"
devtools
/
"
)
)
{
throw
new
Error
(
"
watchFiles
expects
a
devtools
path
"
)
;
}
let
resolvedRootURI
=
resolveResourceURI
(
"
resource
:
/
/
devtools
"
)
;
if
(
resolvedRootURI
.
match
(
/
\
/
obj
\
-
.
*
/
)
)
{
resolvedRootURI
=
resolvedRootURI
.
replace
(
/
\
/
obj
\
-
.
*
/
"
"
)
+
"
/
devtools
"
;
}
resolvedRootURI
=
resolvedRootURI
.
replace
(
/
^
file
:
\
/
\
/
/
"
"
)
;
const
localURI
=
resolvedRootURI
+
"
/
"
+
path
.
replace
(
/
^
devtools
\
/
/
"
"
)
;
const
watchWorker
=
new
ChromeWorker
(
"
resource
:
/
/
devtools
/
client
/
shared
/
file
-
watcher
-
worker
.
js
"
)
;
watchWorker
.
onmessage
=
event
=
>
{
const
relativePath
=
event
.
data
.
replace
(
resolvedRootURI
+
"
/
"
"
"
)
;
if
(
relativePath
.
startsWith
(
"
client
/
themes
"
)
)
{
onFileChanged
(
relativePath
.
replace
(
"
client
/
themes
"
"
chrome
:
/
/
devtools
/
skin
"
)
)
;
}
onFileChanged
(
"
resource
:
/
/
devtools
/
"
+
relativePath
)
;
}
;
watchWorker
.
postMessage
(
{
path
:
localURI
fileRegex
:
/
\
.
(
js
|
css
)
/
}
)
;
return
watchWorker
;
}
EventEmitter
.
decorate
(
module
.
exports
)
;
let
watchWorker
;
function
onPrefChange
(
)
{
if
(
Services
.
prefs
.
getBoolPref
(
HOTRELOAD_PREF
)
&
&
!
watchWorker
)
{
watchWorker
=
watchFiles
(
"
devtools
/
client
"
changedFile
=
>
{
module
.
exports
.
emit
(
"
file
-
changed
"
changedFile
)
;
}
)
;
}
else
if
(
watchWorker
)
{
watchWorker
.
terminate
(
)
;
watchWorker
=
null
;
}
}
Services
.
prefs
.
addObserver
(
HOTRELOAD_PREF
{
observe
:
onPrefChange
}
false
)
;
onPrefChange
(
)
;
