"
use
strict
"
;
const
PREF_INVALID
=
0
;
const
PREF_STRING
=
32
;
const
PREF_INT
=
64
;
const
PREF_BOOL
=
128
;
const
NS_PREFBRANCH_PREFCHANGE_TOPIC_ID
=
"
nsPref
:
changed
"
;
function
Preference
(
branch
name
fullName
)
{
this
.
branch
=
branch
;
this
.
name
=
name
;
this
.
fullName
=
fullName
;
this
.
defaultValue
=
null
;
this
.
hasUserValue
=
false
;
this
.
userValue
=
null
;
this
.
type
=
null
;
}
Preference
.
prototype
=
{
get
:
function
(
)
{
if
(
this
.
hasUserValue
)
{
return
this
.
userValue
;
}
return
this
.
defaultValue
;
}
set
:
function
(
value
)
{
if
(
!
this
.
hasUserValue
|
|
value
!
=
=
this
.
userValue
)
{
this
.
userValue
=
value
;
this
.
hasUserValue
=
true
;
this
.
saveAndNotify
(
)
;
}
}
setDefault
:
function
(
value
)
{
if
(
this
.
defaultValue
!
=
=
value
)
{
this
.
defaultValue
=
value
;
if
(
!
this
.
hasUserValue
)
{
this
.
saveAndNotify
(
)
;
}
}
}
clearUserValue
:
function
(
)
{
if
(
this
.
hasUserValue
)
{
this
.
userValue
=
null
;
this
.
hasUserValue
=
false
;
this
.
saveAndNotify
(
)
;
}
}
saveAndNotify
:
function
(
)
{
let
store
=
{
type
:
this
.
type
defaultValue
:
this
.
defaultValue
hasUserValue
:
this
.
hasUserValue
userValue
:
this
.
userValue
}
;
localStorage
.
setItem
(
this
.
fullName
JSON
.
stringify
(
store
)
)
;
this
.
branch
.
_notify
(
this
.
name
)
;
}
storageUpdated
:
function
(
type
userValue
hasUserValue
defaultValue
)
{
this
.
type
=
type
;
this
.
defaultValue
=
defaultValue
;
this
.
hasUserValue
=
hasUserValue
;
this
.
userValue
=
userValue
;
this
.
branch
.
_notify
(
this
.
name
)
;
}
}
;
function
PrefBranch
(
parent
name
fullName
)
{
this
.
_parent
=
parent
;
this
.
_name
=
name
;
this
.
_fullName
=
fullName
;
this
.
_observers
=
{
}
;
this
.
_children
=
{
}
;
if
(
!
parent
)
{
this
.
_initializeRoot
(
)
;
}
}
PrefBranch
.
prototype
=
{
PREF_INVALID
:
PREF_INVALID
PREF_STRING
:
PREF_STRING
PREF_INT
:
PREF_INT
PREF_BOOL
:
PREF_BOOL
get
root
(
)
{
return
this
.
_fullName
;
}
getPrefType
:
function
(
prefName
)
{
return
this
.
_findPref
(
prefName
)
.
type
;
}
getBoolPref
:
function
(
prefName
)
{
let
thePref
=
this
.
_findPref
(
prefName
)
;
if
(
thePref
.
type
!
=
=
PREF_BOOL
)
{
throw
new
Error
(
{
prefName
}
does
not
have
bool
type
)
;
}
return
thePref
.
get
(
)
;
}
setBoolPref
:
function
(
prefName
value
)
{
if
(
typeof
value
!
=
=
"
boolean
"
)
{
throw
new
Error
(
"
non
-
bool
passed
to
setBoolPref
"
)
;
}
let
thePref
=
this
.
_findOrCreatePref
(
prefName
value
true
value
)
;
if
(
thePref
.
type
!
=
=
PREF_BOOL
)
{
throw
new
Error
(
{
prefName
}
does
not
have
bool
type
)
;
}
thePref
.
set
(
value
)
;
}
getCharPref
:
function
(
prefName
)
{
let
thePref
=
this
.
_findPref
(
prefName
)
;
if
(
thePref
.
type
!
=
=
PREF_STRING
)
{
throw
new
Error
(
{
prefName
}
does
not
have
string
type
)
;
}
return
thePref
.
get
(
)
;
}
setCharPref
:
function
(
prefName
value
)
{
if
(
typeof
value
!
=
=
"
string
"
)
{
throw
new
Error
(
"
non
-
string
passed
to
setCharPref
"
)
;
}
let
thePref
=
this
.
_findOrCreatePref
(
prefName
value
true
value
)
;
if
(
thePref
.
type
!
=
=
PREF_STRING
)
{
throw
new
Error
(
{
prefName
}
does
not
have
string
type
)
;
}
thePref
.
set
(
value
)
;
}
getIntPref
:
function
(
prefName
)
{
let
thePref
=
this
.
_findPref
(
prefName
)
;
if
(
thePref
.
type
!
=
=
PREF_INT
)
{
throw
new
Error
(
{
prefName
}
does
not
have
int
type
)
;
}
return
thePref
.
get
(
)
;
}
setIntPref
:
function
(
prefName
value
)
{
if
(
typeof
value
!
=
=
"
number
"
)
{
throw
new
Error
(
"
non
-
number
passed
to
setIntPref
"
)
;
}
let
thePref
=
this
.
_findOrCreatePref
(
prefName
value
true
value
)
;
if
(
thePref
.
type
!
=
=
PREF_INT
)
{
throw
new
Error
(
{
prefName
}
does
not
have
int
type
)
;
}
thePref
.
set
(
value
)
;
}
clearUserPref
:
function
(
prefName
)
{
let
thePref
=
this
.
_findPref
(
prefName
)
;
thePref
.
clearUserValue
(
)
;
}
prefHasUserValue
:
function
(
prefName
)
{
let
thePref
=
this
.
_findPref
(
prefName
)
;
return
thePref
.
hasUserValue
;
}
addObserver
:
function
(
domain
observer
holdWeak
)
{
if
(
domain
!
=
=
"
"
&
&
!
domain
.
endsWith
(
"
.
"
)
)
{
throw
new
Error
(
"
invalid
domain
to
addObserver
:
"
+
domain
)
;
}
if
(
holdWeak
)
{
throw
new
Error
(
"
shim
prefs
only
supports
strong
observers
"
)
;
}
if
(
!
(
domain
in
this
.
_observers
)
)
{
this
.
_observers
[
domain
]
=
[
]
;
}
this
.
_observers
[
domain
]
.
push
(
observer
)
;
}
removeObserver
:
function
(
domain
observer
)
{
if
(
!
(
domain
in
this
.
_observers
)
)
{
return
;
}
let
index
=
this
.
_observers
[
domain
]
.
indexOf
(
observer
)
;
if
(
index
>
=
0
)
{
this
.
_observers
[
domain
]
.
splice
(
index
1
)
;
}
}
savePrefFile
:
function
(
file
)
{
if
(
file
)
{
throw
new
Error
(
"
shim
prefs
only
supports
null
file
in
savePrefFile
"
)
;
}
}
getBranch
:
function
(
prefRoot
)
{
if
(
!
prefRoot
)
{
return
this
;
}
if
(
prefRoot
.
endsWith
(
"
.
"
)
)
{
prefRoot
=
prefRoot
.
slice
(
0
-
1
)
;
}
return
this
.
_findPref
(
prefRoot
)
;
}
_findPref
:
function
(
prefName
)
{
let
branchNames
=
prefName
.
split
(
"
.
"
)
;
let
branch
=
this
;
for
(
let
branchName
of
branchNames
)
{
branch
=
branch
.
_children
[
branchName
]
;
if
(
!
branch
)
{
throw
new
Error
(
"
could
not
find
pref
branch
"
+
prefName
)
;
}
}
return
branch
;
}
_notify
:
function
(
relativeName
)
{
for
(
let
domain
in
this
.
_observers
)
{
if
(
relativeName
.
startsWith
(
domain
)
)
{
let
localList
=
this
.
_observers
[
domain
]
.
slice
(
)
;
for
(
let
observer
of
localList
)
{
try
{
observer
.
observe
(
this
NS_PREFBRANCH_PREFCHANGE_TOPIC_ID
relativeName
)
;
}
catch
(
e
)
{
console
.
error
(
e
)
;
}
}
}
}
if
(
this
.
_parent
)
{
this
.
_parent
.
_notify
(
this
.
_name
+
"
.
"
+
relativeName
)
;
}
}
_createBranch
:
function
(
branchList
)
{
let
parent
=
this
;
for
(
let
branch
of
branchList
)
{
if
(
!
parent
.
_children
[
branch
]
)
{
parent
.
_children
[
branch
]
=
new
PrefBranch
(
parent
branch
parent
.
root
+
"
.
"
+
branch
)
;
}
parent
=
parent
.
_children
[
branch
]
;
}
return
parent
;
}
_findOrCreatePref
:
function
(
keyName
userValue
hasUserValue
defaultValue
)
{
let
branchName
=
keyName
.
split
(
"
.
"
)
;
let
prefName
=
branchName
.
pop
(
)
;
let
branch
=
this
.
_createBranch
(
branchName
)
;
if
(
!
(
prefName
in
branch
.
_children
)
)
{
if
(
hasUserValue
&
&
typeof
(
userValue
)
!
=
=
typeof
(
defaultValue
)
)
{
throw
new
Error
(
"
inconsistent
values
when
creating
"
+
keyName
)
;
}
let
type
;
switch
(
typeof
(
defaultValue
)
)
{
case
"
boolean
"
:
type
=
PREF_BOOL
;
break
;
case
"
number
"
:
type
=
PREF_INT
;
break
;
case
"
string
"
:
type
=
PREF_STRING
;
break
;
default
:
throw
new
Error
(
"
unhandled
argument
type
:
"
+
typeof
(
defaultValue
)
)
;
}
let
thePref
=
new
Preference
(
branch
prefName
keyName
)
;
thePref
.
storageUpdated
(
type
userValue
hasUserValue
defaultValue
)
;
branch
.
_children
[
prefName
]
=
thePref
;
}
return
branch
.
_children
[
prefName
]
;
}
_onStorageChange
:
function
(
event
)
{
if
(
event
.
storageArea
!
=
=
localStorage
)
{
return
;
}
if
(
event
.
key
=
=
=
null
|
|
event
.
newValue
=
=
=
null
)
{
return
;
}
let
{
type
userValue
hasUserValue
defaultValue
}
=
JSON
.
parse
(
event
.
newValue
)
;
if
(
event
.
oldValue
=
=
=
null
)
{
this
.
_findOrCreatePref
(
event
.
key
userValue
hasUserValue
defaultValue
)
;
}
else
{
let
thePref
=
this
.
_findPref
(
event
.
key
)
;
thePref
.
storageUpdated
(
type
userValue
hasUserValue
defaultValue
)
;
}
}
_initializeRoot
:
function
(
)
{
if
(
localStorage
.
length
=
=
=
0
)
{
}
for
(
let
i
=
0
;
i
<
localStorage
.
length
;
+
+
i
)
{
let
keyName
=
localStorage
.
key
(
i
)
;
let
{
userValue
hasUserValue
defaultValue
}
=
JSON
.
parse
(
localStorage
.
getItem
(
keyName
)
)
;
this
.
_findOrCreatePref
(
keyName
userValue
hasUserValue
defaultValue
)
;
}
this
.
_onStorageChange
=
this
.
_onStorageChange
.
bind
(
this
)
;
window
.
addEventListener
(
"
storage
"
this
.
_onStorageChange
)
;
}
}
;
const
Services
=
{
prefs
:
new
PrefBranch
(
null
"
"
"
"
)
appinfo
:
{
get
OS
(
)
{
const
os
=
window
.
navigator
.
userAgent
;
if
(
os
)
{
if
(
os
.
includes
(
"
Linux
"
)
)
{
return
"
Linux
"
;
}
else
if
(
os
.
includes
(
"
Windows
"
)
)
{
return
"
WINNT
"
;
}
else
if
(
os
.
includes
(
"
Mac
"
)
)
{
return
"
Darwin
"
;
}
}
return
"
Unknown
"
;
}
get
name
(
)
{
return
window
.
navigator
.
userAgent
;
}
get
version
(
)
{
return
window
.
navigator
.
appVersion
;
}
get
is64Bit
(
)
{
return
true
;
}
}
}
;
function
pref
(
name
value
)
{
let
thePref
=
Services
.
prefs
.
_findOrCreatePref
(
name
value
true
value
)
;
thePref
.
setDefault
(
value
)
;
}
exports
.
Services
=
Services
;
exports
.
pref
=
pref
;
