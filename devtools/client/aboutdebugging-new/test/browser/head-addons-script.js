"
use
strict
"
;
const
{
Management
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Extension
.
jsm
"
{
}
)
;
function
getSupportsFile
(
path
)
{
const
cr
=
Cc
[
"
mozilla
.
org
/
chrome
/
chrome
-
registry
;
1
"
]
.
getService
(
Ci
.
nsIChromeRegistry
)
;
const
uri
=
Services
.
io
.
newURI
(
CHROME_URL_ROOT
+
path
)
;
const
fileurl
=
cr
.
convertChromeURL
(
uri
)
;
return
fileurl
.
QueryInterface
(
Ci
.
nsIFileURL
)
;
}
async
function
installTemporaryExtension
(
path
name
document
)
{
prepareMockFilePicker
(
path
)
;
const
onAddonInstalled
=
new
Promise
(
done
=
>
{
Management
.
on
(
"
startup
"
function
listener
(
event
extension
)
{
if
(
extension
.
name
!
=
name
)
{
return
;
}
Management
.
off
(
"
startup
"
listener
)
;
done
(
)
;
}
)
;
}
)
;
document
.
querySelector
(
"
.
js
-
temporary
-
extension
-
install
-
button
"
)
.
click
(
)
;
info
(
"
Wait
for
addon
to
be
installed
"
)
;
await
onAddonInstalled
;
}
async
function
removeTemporaryExtension
(
name
document
)
{
info
(
Remove
the
temporary
extension
with
name
:
'
{
name
}
'
)
;
const
temporaryExtensionItem
=
findDebugTargetByText
(
name
document
)
;
temporaryExtensionItem
.
querySelector
(
"
.
js
-
temporary
-
extension
-
remove
-
button
"
)
.
click
(
)
;
info
(
"
Wait
until
the
debug
target
item
disappears
"
)
;
await
waitUntil
(
(
)
=
>
!
findDebugTargetByText
(
name
document
)
)
;
}
function
prepareMockFilePicker
(
path
)
{
const
MockFilePicker
=
SpecialPowers
.
MockFilePicker
;
MockFilePicker
.
init
(
window
)
;
MockFilePicker
.
setFiles
(
[
getSupportsFile
(
path
)
.
file
]
)
;
}
