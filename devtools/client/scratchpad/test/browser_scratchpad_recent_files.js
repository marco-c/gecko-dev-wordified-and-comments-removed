var
gScratchpad
;
var
gFile01
;
var
gFile02
;
var
gFile03
;
var
gFile04
;
var
lists
=
{
recentFiles01
:
null
recentFiles02
:
null
recentFiles03
:
null
recentFiles04
:
null
}
;
var
gFileName01
=
"
file01_ForBug651942
.
tmp
"
;
var
gFileName02
=
"
"
;
var
gFileName03
=
"
file03_ForBug651942
.
tmp
"
;
var
gFileName04
=
"
file04_ForBug651942
.
tmp
"
;
var
gFileContent01
=
"
hello
.
world
.
01
(
'
bug651942
'
)
;
"
;
var
gFileContent02
=
"
hello
.
world
.
02
(
'
bug651942
'
)
;
"
;
var
gFileContent03
=
"
hello
.
world
.
03
(
'
bug651942
'
)
;
"
;
var
gFileContent04
=
"
hello
.
world
.
04
(
'
bug651942
'
)
;
"
;
function
snooze
(
)
{
return
new
Promise
(
resolve
=
>
setTimeout
(
resolve
0
)
)
;
}
async
function
testAddedToRecent
(
)
{
gScratchpad
=
gScratchpadWindow
.
Scratchpad
;
gFile01
=
await
createAndLoadTemporaryFile
(
gFileName01
gFileContent01
)
;
gFile02
=
await
createAndLoadTemporaryFile
(
gFileName02
gFileContent02
)
;
gFile03
=
await
createAndLoadTemporaryFile
(
gFileName03
gFileContent03
)
;
lists
.
recentFiles01
=
gScratchpad
.
getRecentFiles
(
)
;
is
(
lists
.
recentFiles01
.
length
3
"
Temporary
files
created
successfully
and
added
to
list
of
recent
files
.
"
)
;
gFile04
=
await
createAndLoadTemporaryFile
(
gFileName04
gFileContent04
)
;
lists
.
recentFiles02
=
gScratchpad
.
getRecentFiles
(
)
;
is
(
lists
.
recentFiles02
[
0
]
lists
.
recentFiles01
[
1
]
"
File02
was
reordered
successfully
in
the
'
recent
files
'
-
list
.
"
)
;
is
(
lists
.
recentFiles02
[
1
]
lists
.
recentFiles01
[
2
]
"
File03
was
reordered
successfully
in
the
'
recent
files
'
-
list
.
"
)
;
isnot
(
lists
.
recentFiles02
[
2
]
lists
.
recentFiles01
[
2
]
"
File04
:
was
added
successfully
.
"
)
;
await
gScratchpad
.
openFile
(
0
)
;
lists
.
recentFiles03
=
gScratchpad
.
getRecentFiles
(
)
;
is
(
lists
.
recentFiles02
[
0
]
lists
.
recentFiles03
[
2
]
"
File04
was
reordered
successfully
in
the
'
recent
files
'
-
list
.
"
)
;
is
(
lists
.
recentFiles02
[
1
]
lists
.
recentFiles03
[
0
]
"
File03
was
reordered
successfully
in
the
'
recent
files
'
-
list
.
"
)
;
is
(
lists
.
recentFiles02
[
2
]
lists
.
recentFiles03
[
1
]
"
File02
was
reordered
successfully
in
the
'
recent
files
'
-
list
.
"
)
;
}
async
function
testHideMenu
(
)
{
Services
.
prefs
.
setIntPref
(
"
devtools
.
scratchpad
.
recentFilesMax
"
0
)
;
await
snooze
(
)
;
const
menu
=
gScratchpadWindow
.
document
.
getElementById
(
"
sp
-
open_recent
-
menu
"
)
;
ok
(
menu
.
hasAttribute
(
"
hidden
"
)
"
The
menu
was
hidden
successfully
.
"
)
;
}
async
function
testEnableMenu
(
)
{
Services
.
prefs
.
setIntPref
(
"
devtools
.
scratchpad
.
recentFilesMax
"
2
)
;
await
snooze
(
)
;
const
menu
=
gScratchpadWindow
.
document
.
getElementById
(
"
sp
-
open_recent
-
menu
"
)
;
ok
(
!
menu
.
hasAttribute
(
"
hidden
"
)
"
The
menu
is
visible
.
\
\
o
/
"
)
;
lists
.
recentFiles04
=
gScratchpad
.
getRecentFiles
(
)
;
is
(
lists
.
recentFiles04
.
length
2
"
Two
recent
files
were
successfully
removed
from
the
'
recent
files
'
-
list
"
)
;
const
doc
=
gScratchpadWindow
.
document
;
const
popup
=
doc
.
getElementById
(
"
sp
-
menu
-
open_recentPopup
"
)
;
const
menuitemLabel
=
popup
.
children
[
0
]
.
getAttribute
(
"
label
"
)
;
let
correctMenuItem
=
false
;
if
(
menuitemLabel
=
=
=
lists
.
recentFiles03
[
2
]
&
&
menuitemLabel
=
=
=
lists
.
recentFiles04
[
1
]
)
{
correctMenuItem
=
true
;
}
is
(
correctMenuItem
true
"
Two
recent
files
were
successfully
removed
from
the
'
Open
Recent
'
-
menu
"
)
;
}
async
function
testOpenDeletedFile
(
)
{
gFile04
.
remove
(
false
)
;
while
(
gFile04
.
exists
(
)
)
{
await
snooze
(
)
;
}
gFile04
=
null
;
await
gScratchpad
.
openFile
(
0
)
;
const
doc
=
gScratchpadWindow
.
document
;
const
popup
=
doc
.
getElementById
(
"
sp
-
menu
-
open_recentPopup
"
)
;
is
(
gScratchpad
.
getRecentFiles
(
)
.
length
1
"
The
missing
file
was
successfully
removed
from
the
list
.
"
)
;
is
(
popup
.
children
.
length
3
"
The
missing
file
was
successfully
removed
from
the
menu
.
"
)
;
ok
(
gScratchpad
.
notificationBox
.
currentNotification
"
The
notification
was
successfully
displayed
.
"
)
;
is
(
gScratchpad
.
notificationBox
.
currentNotification
.
messageText
.
textContent
gScratchpad
.
strings
.
GetStringFromName
(
"
fileNoLongerExists
.
notification
"
)
"
The
notification
label
is
correct
.
"
)
;
}
async
function
testClearAll
(
)
{
gScratchpad
.
clearRecentFiles
(
)
;
await
snooze
(
)
;
const
doc
=
gScratchpadWindow
.
document
;
const
menu
=
doc
.
getElementById
(
"
sp
-
open_recent
-
menu
"
)
;
const
popup
=
doc
.
getElementById
(
"
sp
-
menu
-
open_recentPopup
"
)
;
is
(
gScratchpad
.
getRecentFiles
(
)
.
length
0
"
All
recent
files
removed
successfully
.
"
)
;
is
(
popup
.
children
.
length
0
"
All
menuitems
removed
successfully
.
"
)
;
ok
(
menu
.
hasAttribute
(
"
disabled
"
)
"
No
files
in
the
menu
it
was
disabled
successfully
.
"
)
;
}
async
function
createAndLoadTemporaryFile
(
aFileName
aFileContent
)
{
info
(
Create
file
:
{
aFileName
}
)
;
const
aFile
=
FileUtils
.
getFile
(
"
TmpD
"
[
aFileName
]
)
;
aFile
.
createUnique
(
Ci
.
nsIFile
.
NORMAL_FILE_TYPE
0o666
)
;
await
OS
.
File
.
writeAtomic
(
aFile
.
path
aFileContent
)
;
gScratchpad
.
setFilename
(
aFile
.
path
)
;
let
[
status
]
=
await
gScratchpad
.
importFromFile
(
aFile
.
QueryInterface
(
Ci
.
nsIFile
)
true
)
;
ok
(
Components
.
isSuccessCode
(
status
)
"
the
temporary
file
was
imported
successfully
with
Scratchpad
"
)
;
status
=
await
gScratchpad
.
saveFile
(
)
;
ok
(
Components
.
isSuccessCode
(
status
)
"
the
temporary
file
was
saved
successfully
with
Scratchpad
"
)
;
checkIfMenuIsPopulated
(
)
;
info
(
File
created
:
{
aFileName
}
)
;
return
aFile
;
}
function
checkIfMenuIsPopulated
(
)
{
const
doc
=
gScratchpadWindow
.
document
;
const
expectedMenuitemCount
=
doc
.
getElementById
(
"
sp
-
menu
-
open_recentPopup
"
)
.
children
.
length
;
const
recentFilesPlusExtra
=
gScratchpad
.
getRecentFiles
(
)
.
length
+
2
;
if
(
expectedMenuitemCount
>
2
)
{
is
(
expectedMenuitemCount
recentFilesPlusExtra
"
the
recent
files
menu
was
populated
successfully
.
"
)
;
}
}
async
function
test
(
)
{
waitForExplicitFinish
(
)
;
registerCleanupFunction
(
function
(
)
{
gFile01
.
remove
(
false
)
;
gFile02
.
remove
(
false
)
;
gFile03
.
remove
(
false
)
;
if
(
gFile04
)
{
gFile04
.
remove
(
false
)
;
}
Services
.
prefs
.
clearUserPref
(
"
devtools
.
scratchpad
.
recentFilesMax
"
)
;
}
)
;
Services
.
prefs
.
setIntPref
(
"
devtools
.
scratchpad
.
recentFilesMax
"
3
)
;
gBrowser
.
selectedTab
=
BrowserTestUtils
.
addTab
(
gBrowser
)
;
const
loaded
=
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
BrowserTestUtils
.
loadURI
(
gBrowser
"
data
:
text
/
html
<
p
>
test
recent
files
in
Scratchpad
"
)
;
await
loaded
;
await
new
Promise
(
openScratchpad
)
;
await
testAddedToRecent
(
)
;
await
testHideMenu
(
)
;
await
testEnableMenu
(
)
;
await
testOpenDeletedFile
(
)
;
await
testClearAll
(
)
;
finish
(
)
;
}
