"
use
strict
"
;
this
.
EXPORTED_SYMBOLS
=
[
"
ScratchpadManager
"
]
;
const
SCRATCHPAD_WINDOW_URL
=
"
chrome
:
/
/
devtools
/
content
/
scratchpad
/
index
.
xul
"
;
const
SCRATCHPAD_WINDOW_FEATURES
=
"
chrome
titlebar
toolbar
centerscreen
resizable
dialog
=
no
"
;
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
Telemetry
=
require
(
"
devtools
/
client
/
shared
/
telemetry
"
)
;
const
TELEMETRY_SCRATCHPAD_WIN_OPEN_COUNT
=
"
DEVTOOLS_SCRATCHPAD_WINDOW_OPENED_COUNT
"
;
this
.
ScratchpadManager
=
{
_nextUid
:
1
_scratchpads
:
[
]
_telemetry
:
new
Telemetry
(
)
getSessionState
:
function
SPM_getSessionState
(
)
{
return
this
.
_scratchpads
;
}
restoreSession
:
function
SPM_restoreSession
(
aSession
)
{
if
(
!
Array
.
isArray
(
aSession
)
)
{
return
[
]
;
}
const
wins
=
[
]
;
aSession
.
forEach
(
function
(
state
)
{
const
win
=
this
.
openScratchpad
(
state
)
;
wins
.
push
(
win
)
;
}
this
)
;
return
wins
;
}
saveOpenWindows
:
function
SPM_saveOpenWindows
(
)
{
this
.
_scratchpads
=
[
]
;
function
clone
(
src
)
{
const
dest
=
{
}
;
for
(
const
key
in
src
)
{
if
(
src
.
hasOwnProperty
(
key
)
)
{
dest
[
key
]
=
src
[
key
]
;
}
}
return
dest
;
}
for
(
const
win
of
Services
.
wm
.
getEnumerator
(
"
devtools
:
scratchpad
"
)
)
{
if
(
!
win
.
closed
&
&
win
.
Scratchpad
.
initialized
)
{
this
.
_scratchpads
.
push
(
clone
(
win
.
Scratchpad
.
getState
(
)
)
)
;
}
}
}
openScratchpad
:
function
SPM_openScratchpad
(
aState
)
{
const
params
=
Cc
[
"
mozilla
.
org
/
embedcomp
/
dialogparam
;
1
"
]
.
createInstance
(
Ci
.
nsIDialogParamBlock
)
;
params
.
SetNumberStrings
(
2
)
;
params
.
SetString
(
0
this
.
createUid
(
)
)
;
if
(
aState
)
{
if
(
typeof
aState
!
=
"
object
"
)
{
return
;
}
params
.
SetString
(
1
JSON
.
stringify
(
aState
)
)
;
}
const
win
=
Services
.
ww
.
openWindow
(
null
SCRATCHPAD_WINDOW_URL
"
_blank
"
SCRATCHPAD_WINDOW_FEATURES
params
)
;
this
.
_telemetry
.
getHistogramById
(
TELEMETRY_SCRATCHPAD_WIN_OPEN_COUNT
)
.
add
(
true
)
;
ShutdownObserver
.
init
(
)
;
return
win
;
}
createUid
:
function
SPM_createUid
(
)
{
return
JSON
.
stringify
(
this
.
_nextUid
+
+
)
;
}
}
;
var
ShutdownObserver
=
{
_initialized
:
false
init
(
)
{
if
(
this
.
_initialized
)
{
return
;
}
Services
.
obs
.
addObserver
(
this
"
quit
-
application
-
granted
"
)
;
this
.
_initialized
=
true
;
}
observe
(
message
topic
)
{
if
(
topic
=
=
"
quit
-
application
-
granted
"
)
{
ScratchpadManager
.
saveOpenWindows
(
)
;
this
.
uninit
(
)
;
}
}
uninit
(
)
{
Services
.
obs
.
removeObserver
(
this
"
quit
-
application
-
granted
"
)
;
}
}
;
