"
use
strict
"
;
const
Ci
=
Components
.
interfaces
;
const
Cm
=
Components
.
manager
;
const
Cr
=
Components
.
results
;
const
Cu
=
Components
.
utils
;
const
{
XPCOMUtils
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
{
}
)
;
const
{
Services
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
{
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
devtools
"
function
(
)
{
const
{
devtools
}
=
Cu
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
return
devtools
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
JsonViewService
"
function
(
)
{
const
{
JsonViewService
}
=
devtools
.
require
(
"
devtools
/
client
/
jsonview
/
converter
-
child
"
)
;
return
JsonViewService
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
JsonViewSniffer
"
function
(
)
{
const
{
JsonViewSniffer
}
=
devtools
.
require
(
"
devtools
/
client
/
jsonview
/
converter
-
sniffer
"
)
;
return
JsonViewSniffer
;
}
)
;
const
JSON_VIEW_PREF
=
"
devtools
.
jsonview
.
enabled
"
;
const
JSON_VIEW_MIME_TYPE
=
"
application
/
vnd
.
mozilla
.
json
.
view
"
;
const
JSON_VIEW_CONTRACT_ID
=
"
mozilla
.
org
/
streamconv
;
1
?
from
=
"
+
JSON_VIEW_MIME_TYPE
+
"
&
to
=
*
/
*
"
;
const
JSON_VIEW_CLASS_ID
=
Components
.
ID
(
"
{
d8c9acee
-
dec5
-
11e4
-
8c75
-
1681e6b88ec1
}
"
)
;
const
JSON_VIEW_CLASS_DESCRIPTION
=
"
JSONView
converter
"
;
const
JsonViewFactory
=
{
createInstance
:
function
(
outer
iid
)
{
if
(
outer
)
{
throw
Cr
.
NS_ERROR_NO_AGGREGATION
;
}
return
JsonViewService
.
createInstance
(
)
;
}
}
;
function
ConverterObserver
(
)
{
}
ConverterObserver
.
prototype
=
{
initialize
:
function
(
)
{
if
(
this
.
isEnabled
(
)
)
{
this
.
register
(
)
;
}
Services
.
prefs
.
addObserver
(
JSON_VIEW_PREF
this
false
)
;
Services
.
obs
.
addObserver
(
this
"
xpcom
-
shutdown
"
false
)
;
}
observe
:
function
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
xpcom
-
shutdown
"
:
this
.
onShutdown
(
)
;
break
;
case
"
nsPref
:
changed
"
:
this
.
onPrefChanged
(
)
;
break
;
}
}
onShutdown
:
function
(
)
{
Services
.
prefs
.
removeObserver
(
JSON_VIEW_PREF
observer
)
;
Services
.
obs
.
removeObserver
(
observer
"
xpcom
-
shutdown
"
)
;
}
onPrefChanged
:
function
(
)
{
if
(
this
.
isEnabled
(
)
)
{
this
.
register
(
)
;
}
else
{
this
.
unregister
(
)
;
}
}
register
:
function
(
)
{
JsonViewSniffer
.
register
(
)
;
const
registrar
=
Cm
.
QueryInterface
(
Ci
.
nsIComponentRegistrar
)
;
if
(
!
registrar
.
isCIDRegistered
(
JSON_VIEW_CLASS_ID
)
)
{
registrar
.
registerFactory
(
JSON_VIEW_CLASS_ID
JSON_VIEW_CLASS_DESCRIPTION
JSON_VIEW_CONTRACT_ID
JsonViewFactory
)
;
}
}
unregister
:
function
(
)
{
JsonViewSniffer
.
unregister
(
)
;
const
registrar
=
Cm
.
QueryInterface
(
Ci
.
nsIComponentRegistrar
)
;
if
(
registrar
.
isCIDRegistered
(
JSON_VIEW_CLASS_ID
)
)
{
registrar
.
unregisterFactory
(
JSON_VIEW_CLASS_ID
JsonViewFactory
)
;
}
}
isEnabled
:
function
(
)
{
return
Services
.
prefs
.
getBoolPref
(
JSON_VIEW_PREF
)
;
}
}
;
var
observer
=
new
ConverterObserver
(
)
;
observer
.
initialize
(
)
;
