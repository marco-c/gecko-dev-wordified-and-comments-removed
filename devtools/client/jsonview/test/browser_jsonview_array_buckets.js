"
use
strict
"
;
async
function
loadJsonData
(
data
)
{
const
json
=
JSON
.
stringify
(
data
)
;
return
addJsonViewTab
(
"
data
:
application
/
json
"
+
json
)
;
}
async
function
getBucketLabels
(
)
{
return
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
labels
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
.
treeLabelCell
"
)
)
;
return
labels
.
filter
(
label
=
>
/
\
[
\
d
+
\
d
+
\
]
/
.
test
(
label
.
textContent
)
)
.
map
(
label
=
>
label
.
textContent
.
trim
(
)
)
;
}
)
;
}
async
function
hasBuckets
(
)
{
return
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
labels
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
.
treeLabelCell
"
)
)
;
return
labels
.
some
(
label
=
>
/
\
[
\
d
+
\
d
+
\
]
/
.
test
(
label
.
textContent
)
)
;
}
)
;
}
add_task
(
async
function
test_small_array_no_buckets
(
)
{
const
smallArray
=
Array
(
100
)
.
fill
(
"
item
"
)
;
await
loadJsonData
(
{
data
:
smallArray
}
)
;
const
rowCount
=
await
getElementCount
(
"
.
treeRow
"
)
;
is
(
rowCount
101
"
Small
array
shows
all
100
elements
without
bucketing
"
)
;
is
(
await
hasBuckets
(
)
false
"
No
bucket
nodes
in
small
array
"
)
;
}
)
;
add_task
(
async
function
test_medium_array_has_buckets
(
)
{
const
mediumArray
=
Array
(
250
)
.
fill
(
null
)
.
map
(
(
_
i
)
=
>
item
{
i
}
)
;
await
loadJsonData
(
{
data
:
mediumArray
}
)
;
const
bucketLabels
=
await
getBucketLabels
(
)
;
is
(
bucketLabels
.
length
3
"
Medium
array
(
250
elements
)
creates
3
buckets
"
)
;
Assert
.
deepEqual
(
bucketLabels
[
"
[
0
99
]
"
"
[
100
199
]
"
"
[
200
249
]
"
]
"
Bucket
names
are
correct
"
)
;
}
)
;
add_task
(
async
function
test_expand_bucket
(
)
{
const
array
=
Array
(
150
)
.
fill
(
null
)
.
map
(
(
_
i
)
=
>
value
{
i
}
)
;
await
loadJsonData
(
array
)
;
const
bucketLabels
=
await
getBucketLabels
(
)
;
is
(
bucketLabels
.
length
2
"
Root
array
shows
2
buckets
"
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
labels
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
.
treeLabelCell
"
)
)
;
const
firstBucket
=
labels
.
find
(
label
=
>
label
.
textContent
.
includes
(
"
[
0
99
]
"
)
)
;
if
(
firstBucket
)
{
firstBucket
.
click
(
)
;
}
}
)
;
const
hasElements
=
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
labels
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
.
treeLabelCell
"
)
)
;
const
hasZero
=
labels
.
some
(
label
=
>
label
.
textContent
.
trim
(
)
=
=
=
"
0
"
)
;
const
has99
=
labels
.
some
(
label
=
>
label
.
textContent
.
trim
(
)
=
=
=
"
99
"
)
;
return
hasZero
&
&
has99
;
}
)
;
is
(
hasElements
true
"
Expanding
bucket
shows
individual
elements
"
)
;
}
)
;
add_task
(
async
function
test_large_array_bucket_size
(
)
{
const
largeArray
=
Array
(
10000
)
.
fill
(
"
x
"
)
;
await
loadJsonData
(
largeArray
)
;
const
bucketLabels
=
await
getBucketLabels
(
)
;
is
(
bucketLabels
.
length
100
"
10
000
elements
create
100
buckets
"
)
;
is
(
bucketLabels
[
0
]
"
[
0
99
]
"
"
First
bucket
starts
at
0
"
)
;
is
(
bucketLabels
[
99
]
"
[
9900
9999
]
"
"
Last
bucket
ends
at
9999
"
)
;
}
)
;
add_task
(
async
function
test_very_large_array_bucket_size
(
)
{
const
veryLargeArray
=
Array
(
100000
)
.
fill
(
1
)
;
await
loadJsonData
(
veryLargeArray
)
;
const
bucketLabels
=
await
getBucketLabels
(
)
;
is
(
bucketLabels
.
length
100
"
100
000
elements
create
100
buckets
"
)
;
is
(
bucketLabels
[
0
]
"
[
0
999
]
"
"
First
bucket
is
[
0
999
]
"
)
;
is
(
bucketLabels
[
1
]
"
[
1000
1999
]
"
"
Second
bucket
is
[
1000
1999
]
"
)
;
}
)
;
add_task
(
async
function
test_nested_buckets
(
)
{
const
veryLargeArray
=
Array
(
100000
)
.
fill
(
null
)
.
map
(
(
_
i
)
=
>
i
)
;
await
loadJsonData
(
veryLargeArray
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
labels
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
.
treeLabelCell
"
)
)
;
const
firstBucket
=
labels
.
find
(
label
=
>
label
.
textContent
.
includes
(
"
[
0
999
]
"
)
)
;
if
(
firstBucket
)
{
firstBucket
.
click
(
)
;
}
}
)
;
const
nestedBuckets
=
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
const
labels
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
.
treeLabelCell
"
)
)
;
return
labels
.
map
(
label
=
>
label
.
textContent
)
.
filter
(
text
=
>
{
const
match
=
text
.
match
(
/
\
[
(
\
d
+
)
(
\
d
+
)
\
]
/
)
;
if
(
!
match
)
{
return
false
;
}
const
start
=
parseInt
(
match
[
1
]
10
)
;
const
end
=
parseInt
(
match
[
2
]
10
)
;
return
end
-
start
=
=
=
99
;
}
)
;
}
)
;
is
(
nestedBuckets
.
length
10
"
1000
-
element
bucket
creates
10
nested
buckets
"
)
;
is
(
nestedBuckets
[
0
]
"
[
0
99
]
"
"
First
nested
bucket
is
[
0
99
]
"
)
;
is
(
nestedBuckets
[
9
]
"
[
900
999
]
"
"
Last
nested
bucket
is
[
900
999
]
"
)
;
}
)
;
