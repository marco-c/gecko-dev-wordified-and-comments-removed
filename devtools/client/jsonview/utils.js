"
use
strict
"
;
const
{
Cu
Cc
Ci
}
=
require
(
"
chrome
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
{
getMostRecentBrowserWindow
}
=
require
(
"
sdk
/
window
/
utils
"
)
;
const
OPEN_FLAGS
=
{
RDONLY
:
parseInt
(
"
0x01
"
16
)
WRONLY
:
parseInt
(
"
0x02
"
16
)
CREATE_FILE
:
parseInt
(
"
0x08
"
16
)
APPEND
:
parseInt
(
"
0x10
"
16
)
TRUNCATE
:
parseInt
(
"
0x20
"
16
)
EXCL
:
parseInt
(
"
0x80
"
16
)
}
;
exports
.
getTargetFile
=
function
(
)
{
return
new
Promise
(
resolve
=
>
{
let
fp
=
Cc
[
"
mozilla
.
org
/
filepicker
;
1
"
]
.
createInstance
(
Ci
.
nsIFilePicker
)
;
let
win
=
getMostRecentBrowserWindow
(
)
;
fp
.
init
(
win
null
Ci
.
nsIFilePicker
.
modeSave
)
;
fp
.
appendFilter
(
"
JSON
Files
"
"
*
.
json
;
*
.
jsonp
;
"
)
;
fp
.
appendFilters
(
Ci
.
nsIFilePicker
.
filterText
)
;
fp
.
appendFilters
(
Ci
.
nsIFilePicker
.
filterAll
)
;
fp
.
filterIndex
=
0
;
fp
.
open
(
rv
=
>
{
if
(
rv
=
=
Ci
.
nsIFilePicker
.
returnOK
|
|
rv
=
=
Ci
.
nsIFilePicker
.
returnReplace
)
{
resolve
(
fp
.
file
)
;
}
else
{
resolve
(
null
)
;
}
}
)
;
}
)
;
}
;
exports
.
saveToFile
=
function
(
file
jsonString
)
{
let
foStream
=
Cc
[
"
mozilla
.
org
/
network
/
file
-
output
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIFileOutputStream
)
;
let
openFlags
=
OPEN_FLAGS
.
WRONLY
|
OPEN_FLAGS
.
CREATE_FILE
|
OPEN_FLAGS
.
TRUNCATE
;
let
permFlags
=
parseInt
(
"
0666
"
8
)
;
foStream
.
init
(
file
openFlags
permFlags
0
)
;
let
converter
=
Cc
[
"
mozilla
.
org
/
intl
/
converter
-
output
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIConverterOutputStream
)
;
converter
.
init
(
foStream
"
UTF
-
8
"
0
0
)
;
let
chunkLength
=
1024
*
1204
;
for
(
let
i
=
0
;
i
<
=
jsonString
.
length
;
i
+
+
)
{
let
data
=
jsonString
.
substr
(
i
chunkLength
+
1
)
;
if
(
data
)
{
converter
.
writeString
(
data
)
;
}
i
=
i
+
chunkLength
;
}
converter
.
close
(
)
;
}
;
exports
.
getCurrentTheme
=
function
(
)
{
return
Services
.
prefs
.
getCharPref
(
"
devtools
.
theme
"
)
;
}
;
exports
.
exportIntoContentScope
=
function
(
win
obj
defineAs
)
{
let
clone
=
Cu
.
createObjectIn
(
win
{
defineAs
:
defineAs
}
)
;
let
props
=
Object
.
getOwnPropertyNames
(
obj
)
;
for
(
let
i
=
0
;
i
<
props
.
length
;
i
+
+
)
{
let
propName
=
props
[
i
]
;
let
propValue
=
obj
[
propName
]
;
if
(
typeof
propValue
=
=
"
function
"
)
{
Cu
.
exportFunction
(
propValue
clone
{
defineAs
:
propName
}
)
;
}
}
}
;
