"
use
strict
"
;
const
TEST_URL
=
"
http
:
/
/
example
.
com
/
"
;
function
getServerConnections
(
browser
)
{
ok
(
browser
.
isRemoteBrowser
"
Content
browser
is
remote
"
)
;
return
ContentTask
.
spawn
(
browser
{
}
function
*
(
)
{
const
Cu
=
Components
.
utils
;
const
{
require
}
=
Cu
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
{
}
)
;
const
{
DebuggerServer
}
=
require
(
"
devtools
/
server
/
main
"
)
;
if
(
!
DebuggerServer
.
_connections
)
{
return
0
;
}
return
Object
.
getOwnPropertyNames
(
DebuggerServer
.
_connections
)
;
}
)
;
}
let
checkServerConnectionCount
=
Task
.
async
(
function
*
(
browser
expected
)
{
let
conns
=
yield
getServerConnections
(
browser
)
;
is
(
conns
.
length
|
|
0
expected
"
Server
connection
count
"
)
;
}
)
;
let
checkToolbox
=
Task
.
async
(
function
*
(
tab
location
)
{
let
target
=
TargetFactory
.
forTab
(
tab
)
;
ok
(
!
!
gDevTools
.
getToolbox
(
target
)
Toolbox
exists
{
location
}
)
;
}
)
;
add_task
(
function
*
setup
(
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
ipc
.
processCount
"
1
]
]
}
)
;
}
)
;
add_task
(
function
*
(
)
{
let
tab
=
yield
addTab
(
TEST_URL
)
;
{
yield
checkServerConnectionCount
(
tab
.
linkedBrowser
0
)
;
let
{
toolbox
}
=
yield
openInspector
(
)
;
yield
checkServerConnectionCount
(
tab
.
linkedBrowser
2
)
;
yield
checkToolbox
(
tab
"
outside
RDM
"
)
;
let
{
ui
}
=
yield
openRDM
(
tab
)
;
yield
checkServerConnectionCount
(
ui
.
getViewportBrowser
(
)
3
)
;
yield
checkToolbox
(
tab
"
after
opening
RDM
"
)
;
yield
closeRDM
(
tab
)
;
yield
checkServerConnectionCount
(
tab
.
linkedBrowser
2
)
;
yield
checkToolbox
(
tab
tab
.
linkedBrowser
"
after
closing
RDM
"
)
;
yield
toolbox
.
destroy
(
)
;
yield
checkServerConnectionCount
(
tab
.
linkedBrowser
0
)
;
}
{
yield
checkServerConnectionCount
(
tab
.
linkedBrowser
0
)
;
let
{
ui
}
=
yield
openRDM
(
tab
)
;
yield
checkServerConnectionCount
(
ui
.
getViewportBrowser
(
)
1
)
;
let
{
toolbox
}
=
yield
openInspector
(
)
;
yield
checkServerConnectionCount
(
ui
.
getViewportBrowser
(
)
3
)
;
yield
checkToolbox
(
tab
ui
.
getViewportBrowser
(
)
"
inside
RDM
"
)
;
yield
closeRDM
(
tab
)
;
yield
checkServerConnectionCount
(
tab
.
linkedBrowser
2
)
;
yield
checkToolbox
(
tab
tab
.
linkedBrowser
"
after
closing
RDM
"
)
;
yield
toolbox
.
destroy
(
)
;
yield
checkServerConnectionCount
(
tab
.
linkedBrowser
0
)
;
}
yield
removeTab
(
tab
)
;
}
)
;
