"
use
strict
"
;
const
TEST_URL
=
"
http
:
/
/
example
.
com
/
"
;
const
CONTAINER_URL
=
"
chrome
:
/
/
devtools
/
content
/
responsive
.
html
/
index
.
xhtml
"
;
const
{
TabStateFlusher
}
=
Cu
.
import
(
"
resource
:
/
/
/
modules
/
sessionstore
/
TabStateFlusher
.
jsm
"
{
}
)
;
const
SessionStore
=
Cc
[
"
mozilla
.
org
/
browser
/
sessionstore
;
1
"
]
.
getService
(
Ci
.
nsISessionStore
)
;
const
{
OUTER_FRAME_LOADER_SYMBOL
}
=
require
(
"
devtools
/
client
/
responsive
.
html
/
browser
/
tunnel
"
)
;
function
flushContainerTabState
(
tab
)
{
let
browser
=
tab
.
linkedBrowser
;
let
outerBrowser
=
{
permanentKey
:
browser
.
permanentKey
messageManager
:
browser
[
OUTER_FRAME_LOADER_SYMBOL
]
.
messageManager
}
;
return
new
Promise
(
resolve
=
>
{
TabStateFlusher
.
flush
(
outerBrowser
)
.
then
(
resolve
)
;
waitForTime
(
10000
)
.
then
(
resolve
)
;
}
)
;
}
add_task
(
function
*
(
)
{
let
tab
=
yield
addTab
(
TEST_URL
)
;
let
browser
=
tab
.
linkedBrowser
;
let
history
=
yield
getSessionHistory
(
browser
)
;
is
(
history
.
index
-
1
0
"
At
page
0
in
history
"
)
;
is
(
history
.
entries
.
length
1
"
1
page
in
history
"
)
;
is
(
history
.
entries
[
0
]
.
url
TEST_URL
"
Page
0
URL
matches
"
)
;
yield
openRDM
(
tab
)
;
history
=
yield
getSessionHistory
(
browser
)
;
is
(
history
.
index
-
1
0
"
At
page
0
in
history
"
)
;
is
(
history
.
entries
.
length
1
"
1
page
in
history
"
)
;
is
(
history
.
entries
[
0
]
.
url
CONTAINER_URL
"
Page
0
URL
matches
"
)
;
yield
flushContainerTabState
(
tab
)
;
let
tabState
=
JSON
.
parse
(
SessionStore
.
getTabState
(
tab
)
)
;
is
(
tabState
.
index
-
1
0
"
At
page
0
in
history
"
)
;
is
(
tabState
.
entries
.
length
1
"
1
page
in
history
"
)
;
is
(
tabState
.
entries
[
0
]
.
url
TEST_URL
"
Page
0
URL
matches
"
)
;
yield
closeRDM
(
tab
)
;
yield
removeTab
(
tab
)
;
}
)
;
