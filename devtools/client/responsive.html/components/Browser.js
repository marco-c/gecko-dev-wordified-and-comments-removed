"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
{
Task
}
=
require
(
"
devtools
/
shared
/
task
"
)
;
const
flags
=
require
(
"
devtools
/
shared
/
flags
"
)
;
const
{
DOM
:
dom
createClass
addons
PropTypes
}
=
require
(
"
devtools
/
client
/
shared
/
vendor
/
react
"
)
;
const
e10s
=
require
(
"
.
.
/
utils
/
e10s
"
)
;
const
message
=
require
(
"
.
.
/
utils
/
message
"
)
;
const
{
getToplevelWindow
}
=
require
(
"
.
.
/
utils
/
window
"
)
;
const
FRAME_SCRIPT
=
"
resource
:
/
/
devtools
/
client
/
responsive
.
html
/
browser
/
content
.
js
"
;
module
.
exports
=
createClass
(
{
displayName
:
"
Browser
"
propTypes
:
{
swapAfterMount
:
PropTypes
.
bool
.
isRequired
onBrowserMounted
:
PropTypes
.
func
.
isRequired
onContentResize
:
PropTypes
.
func
.
isRequired
}
mixins
:
[
addons
.
PureRenderMixin
]
componentWillMount
(
)
{
this
.
browserShown
=
new
Promise
(
resolve
=
>
{
let
handler
=
frameLoader
=
>
{
let
browser
=
this
.
refs
.
browserContainer
.
querySelector
(
"
iframe
.
browser
"
)
;
if
(
frameLoader
.
ownerElement
!
=
browser
)
{
return
;
}
Services
.
obs
.
removeObserver
(
handler
"
remote
-
browser
-
shown
"
)
;
resolve
(
)
;
}
;
Services
.
obs
.
addObserver
(
handler
"
remote
-
browser
-
shown
"
)
;
}
)
;
}
componentDidMount
:
Task
.
async
(
function
*
(
)
{
if
(
!
this
.
props
.
swapAfterMount
)
{
yield
this
.
startFrameScript
(
)
;
}
yield
this
.
browserShown
;
this
.
props
.
onBrowserMounted
(
)
;
if
(
this
.
props
.
swapAfterMount
)
{
yield
message
.
wait
(
window
"
start
-
frame
-
script
"
)
;
yield
this
.
startFrameScript
(
)
;
message
.
post
(
window
"
start
-
frame
-
script
:
done
"
)
;
}
message
.
wait
(
window
"
stop
-
frame
-
script
"
)
.
then
(
(
)
=
>
{
this
.
stopFrameScript
(
)
;
}
)
;
}
)
onContentResize
(
msg
)
{
let
{
onContentResize
}
=
this
.
props
;
let
{
width
height
}
=
msg
.
data
;
onContentResize
(
{
width
height
}
)
;
}
startFrameScript
:
Task
.
async
(
function
*
(
)
{
let
{
onContentResize
}
=
this
;
let
browser
=
this
.
refs
.
browserContainer
.
querySelector
(
"
iframe
.
browser
"
)
;
let
mm
=
browser
.
frameLoader
.
messageManager
;
e10s
.
on
(
mm
"
OnContentResize
"
onContentResize
)
;
let
ready
=
e10s
.
once
(
mm
"
ChildScriptReady
"
)
;
mm
.
loadFrameScript
(
FRAME_SCRIPT
true
)
;
yield
ready
;
let
browserWindow
=
getToplevelWindow
(
window
)
;
let
requiresFloatingScrollbars
=
!
browserWindow
.
matchMedia
(
"
(
-
moz
-
overlay
-
scrollbars
)
"
)
.
matches
;
yield
e10s
.
request
(
mm
"
Start
"
{
requiresFloatingScrollbars
notifyOnResize
:
flags
.
testing
}
)
;
}
)
stopFrameScript
:
Task
.
async
(
function
*
(
)
{
let
{
onContentResize
}
=
this
;
let
browser
=
this
.
refs
.
browserContainer
.
querySelector
(
"
iframe
.
browser
"
)
;
let
mm
=
browser
.
frameLoader
.
messageManager
;
e10s
.
off
(
mm
"
OnContentResize
"
onContentResize
)
;
yield
e10s
.
request
(
mm
"
Stop
"
)
;
message
.
post
(
window
"
stop
-
frame
-
script
:
done
"
)
;
}
)
render
(
)
{
return
dom
.
div
(
{
ref
:
"
browserContainer
"
className
:
"
browser
-
container
"
dangerouslySetInnerHTML
:
{
__html
:
<
iframe
class
=
"
browser
"
mozbrowser
=
"
true
"
remote
=
"
true
"
remoteType
=
"
web
"
noisolation
=
"
true
"
allowfullscreen
=
"
true
"
src
=
"
about
:
blank
"
width
=
"
100
%
"
height
=
"
100
%
"
>
<
/
iframe
>
}
}
)
;
}
}
)
;
