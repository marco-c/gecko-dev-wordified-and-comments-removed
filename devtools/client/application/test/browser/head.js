"
use
strict
"
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
client
/
shared
/
test
/
shared
-
head
.
js
"
this
)
;
async
function
enableServiceWorkerDebugging
(
)
{
await
pushPref
(
"
dom
.
serviceWorkers
.
enabled
"
true
)
;
await
pushPref
(
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
)
;
await
pushPref
(
"
dom
.
ipc
.
processCount
"
1
)
;
await
pushPref
(
"
devtools
.
debugger
.
features
.
windowless
-
service
-
workers
"
true
)
;
Services
.
ppmm
.
releaseCachedProcesses
(
)
;
}
async
function
enableApplicationPanel
(
)
{
await
enableServiceWorkerDebugging
(
)
;
await
pushPref
(
"
devtools
.
application
.
enabled
"
true
)
;
}
function
getWorkerContainers
(
doc
)
{
return
doc
.
querySelectorAll
(
"
.
js
-
sw
-
container
"
)
;
}
function
navigate
(
target
url
waitForTargetEvent
=
"
navigate
"
)
{
executeSoon
(
(
)
=
>
target
.
navigateTo
(
{
url
}
)
)
;
return
once
(
target
waitForTargetEvent
)
;
}
async
function
openNewTabAndApplicationPanel
(
url
)
{
const
tab
=
await
addTab
(
url
)
;
const
target
=
await
TargetFactory
.
forTab
(
tab
)
;
const
toolbox
=
await
gDevTools
.
showToolbox
(
target
"
application
"
)
;
const
panel
=
toolbox
.
getCurrentPanel
(
)
;
return
{
panel
tab
target
toolbox
}
;
}
async
function
unregisterAllWorkers
(
client
)
{
info
(
"
Wait
until
all
workers
have
a
valid
registrationFront
"
)
;
let
workers
;
await
asyncWaitUntil
(
async
function
(
)
{
workers
=
await
client
.
mainRoot
.
listAllWorkers
(
)
;
const
allWorkersRegistered
=
workers
.
service
.
every
(
worker
=
>
!
!
worker
.
registrationFront
)
;
return
allWorkersRegistered
;
}
)
;
info
(
"
Unregister
all
service
workers
"
)
;
for
(
const
worker
of
workers
.
service
)
{
await
worker
.
registrationFront
.
unregister
(
)
;
}
}
async
function
waitForWorkerRegistration
(
swTab
)
{
info
(
"
Wait
until
the
registration
appears
on
the
window
"
)
;
const
swBrowser
=
swTab
.
linkedBrowser
;
await
asyncWaitUntil
(
async
(
)
=
>
ContentTask
.
spawn
(
swBrowser
{
}
function
(
)
{
return
content
.
wrappedJSObject
.
getRegistration
(
)
;
}
)
)
;
}
function
selectPage
(
panel
page
)
{
info
(
Selecting
application
page
:
{
page
}
)
;
const
doc
=
panel
.
panelWin
.
document
;
const
navItem
=
doc
.
querySelector
(
.
js
-
sidebar
-
{
page
}
)
;
navItem
.
click
(
)
;
}
