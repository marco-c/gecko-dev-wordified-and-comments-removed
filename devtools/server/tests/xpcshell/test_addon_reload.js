"
use
strict
"
;
const
{
AddonManager
}
=
require
(
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
jsm
"
)
;
function
promiseAddonEvent
(
event
)
{
return
new
Promise
(
resolve
=
>
{
const
listener
=
{
[
event
]
(
.
.
.
args
)
{
AddonManager
.
removeAddonListener
(
listener
)
;
resolve
(
args
)
;
}
}
;
AddonManager
.
addAddonListener
(
listener
)
;
}
)
;
}
function
promiseWebExtensionStartup
(
)
{
const
{
Management
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Extension
.
jsm
"
)
;
return
new
Promise
(
resolve
=
>
{
const
listener
=
(
evt
extension
)
=
>
{
Management
.
off
(
"
ready
"
listener
)
;
resolve
(
extension
)
;
}
;
Management
.
on
(
"
ready
"
listener
)
;
}
)
;
}
async
function
reloadAddon
(
addonFront
)
{
const
onInstalled
=
promiseAddonEvent
(
"
onInstalled
"
)
;
await
addonFront
.
reload
(
)
;
await
onInstalled
;
}
function
getSupportFile
(
path
)
{
const
allowMissing
=
false
;
return
do_get_file
(
path
allowMissing
)
;
}
add_task
(
async
function
testReloadExitedAddon
(
)
{
await
startupAddonsManager
(
)
;
DevToolsServer
.
init
(
)
;
DevToolsServer
.
registerAllActors
(
)
;
const
client
=
new
DevToolsClient
(
DevToolsServer
.
connectPipe
(
)
)
;
await
client
.
connect
(
)
;
const
addonFile
=
getSupportFile
(
"
addons
/
web
-
extension
"
)
;
const
[
installedAddon
]
=
await
Promise
.
all
(
[
AddonManager
.
installTemporaryAddon
(
addonFile
)
promiseWebExtensionStartup
(
)
]
)
;
const
addonFile2
=
getSupportFile
(
"
addons
/
web
-
extension2
"
)
;
const
[
installedAddon2
]
=
await
Promise
.
all
(
[
AddonManager
.
installTemporaryAddon
(
addonFile2
)
promiseWebExtensionStartup
(
)
]
)
;
const
addonFront
=
await
client
.
mainRoot
.
getAddon
(
{
id
:
installedAddon
.
id
}
)
;
await
Promise
.
all
(
[
reloadAddon
(
addonFront
)
promiseWebExtensionStartup
(
)
]
)
;
const
onUninstalled
=
promiseAddonEvent
(
"
onUninstalled
"
)
;
installedAddon2
.
uninstall
(
)
;
await
onUninstalled
;
const
newAddonFront
=
await
client
.
mainRoot
.
getAddon
(
{
id
:
installedAddon
.
id
}
)
;
equal
(
newAddonFront
.
id
addonFront
.
id
)
;
equal
(
newAddonFront
addonFront
)
;
const
onAddonListChanged
=
client
.
mainRoot
.
once
(
"
addonListChanged
"
)
;
const
addonUpgradeFile
=
getSupportFile
(
"
addons
/
web
-
extension
-
upgrade
"
)
;
const
[
upgradedAddon
]
=
await
Promise
.
all
(
[
AddonManager
.
installTemporaryAddon
(
addonUpgradeFile
)
promiseWebExtensionStartup
(
)
]
)
;
await
onAddonListChanged
;
const
upgradedAddonFront
=
await
client
.
mainRoot
.
getAddon
(
{
id
:
upgradedAddon
.
id
}
)
;
equal
(
upgradedAddonFront
.
id
addonFront
.
id
)
;
equal
(
upgradedAddonFront
addonFront
)
;
equal
(
upgradedAddonFront
.
name
"
Test
Addons
Actor
Upgrade
"
)
;
await
close
(
client
)
;
}
)
;
