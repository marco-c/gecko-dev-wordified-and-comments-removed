"
use
strict
"
;
const
{
SocketListener
}
=
require
(
"
devtools
/
shared
/
security
/
socket
"
)
;
function
run_test
(
)
{
const
socketListener
=
new
SocketListener
(
DevToolsServer
{
}
)
;
Assert
.
throws
(
(
)
=
>
DevToolsServer
.
addSocketListener
(
socketListener
)
/
DevToolsServer
has
not
been
initialized
/
"
addSocketListener
should
throw
before
it
has
been
initialized
"
)
;
Assert
.
throws
(
DevToolsServer
.
closeAllSocketListeners
/
this
is
undefined
/
"
closeAllSocketListeners
should
throw
before
it
has
been
initialized
"
)
;
Assert
.
throws
(
DevToolsServer
.
connectPipe
/
this
is
undefined
/
"
connectPipe
should
throw
before
it
has
been
initialized
"
)
;
DevToolsServer
.
init
(
)
;
Assert
.
throws
(
DevToolsServer
.
closeAllSocketListeners
/
this
is
undefined
/
"
closeAllSocketListeners
should
throw
if
createRootActor
hasn
'
t
been
added
"
)
;
Assert
.
throws
(
DevToolsServer
.
connectPipe
/
this
is
undefined
/
"
closeAllSocketListeners
should
throw
if
createRootActor
hasn
'
t
been
added
"
)
;
const
{
createRootActor
}
=
require
(
"
xpcshell
-
test
/
testactors
"
)
;
DevToolsServer
.
setRootActor
(
createRootActor
)
;
DevToolsServer
.
addSocketListener
(
socketListener
)
;
DevToolsServer
.
closeAllSocketListeners
(
)
;
const
client1
=
DevToolsServer
.
connectPipe
(
)
;
client1
.
hooks
=
{
onPacket
:
function
(
packet1
)
{
Assert
.
equal
(
packet1
.
from
"
root
"
)
;
Assert
.
equal
(
packet1
.
applicationType
"
xpcshell
-
tests
"
)
;
const
client2
=
DevToolsServer
.
connectPipe
(
)
;
client2
.
hooks
=
{
onPacket
:
function
(
packet2
)
{
Assert
.
equal
(
packet2
.
from
"
root
"
)
;
Assert
.
notEqual
(
packet1
.
testConnectionPrefix
packet2
.
testConnectionPrefix
)
;
client2
.
close
(
)
;
}
onTransportClosed
:
function
(
result
)
{
client1
.
close
(
)
;
}
}
;
client2
.
ready
(
)
;
}
onTransportClosed
:
function
(
result
)
{
do_test_finished
(
)
;
}
}
;
client1
.
ready
(
)
;
do_test_pending
(
)
;
}
