"
use
strict
"
;
function
run_test
(
)
{
let
{
EventLoopLagFront
}
=
require
(
"
devtools
/
shared
/
fronts
/
eventlooplag
"
)
;
DebuggerServer
.
init
(
)
;
DebuggerServer
.
registerAllActors
(
)
;
let
threshold
=
20
;
let
interval
=
10
;
let
front
;
let
client
=
new
DebuggerClient
(
DebuggerServer
.
connectPipe
(
)
)
;
client
.
connect
(
)
.
then
(
function
(
)
{
client
.
listTabs
(
)
.
then
(
function
(
resp
)
{
front
=
new
EventLoopLagFront
(
client
resp
)
;
front
.
start
(
)
.
then
(
success
=
>
{
Assert
.
ok
(
success
)
;
front
.
once
(
"
event
-
loop
-
lag
"
gotLagEvent
)
;
executeSoon
(
lag
)
;
}
)
;
}
)
;
}
)
;
function
lag
(
)
{
let
start
=
new
Date
(
)
;
let
duration
=
threshold
+
interval
+
1
;
while
(
true
)
{
if
(
(
(
new
Date
(
)
)
-
start
)
>
duration
)
{
break
;
}
}
}
function
gotLagEvent
(
time
)
{
info
(
"
lag
:
"
+
time
)
;
Assert
.
ok
(
time
>
=
threshold
)
;
front
.
stop
(
)
.
then
(
(
)
=
>
{
finishClient
(
client
)
;
}
)
;
}
do_test_pending
(
)
;
}
