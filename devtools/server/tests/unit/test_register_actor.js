"
use
strict
"
;
function
run_test
(
)
{
DebuggerServer
.
init
(
)
;
DebuggerServer
.
registerAllActors
(
)
;
add_test
(
test_lazy_api
)
;
add_test
(
manual_remove
)
;
add_test
(
cleanup
)
;
run_next_test
(
)
;
}
function
test_lazy_api
(
)
{
let
isActorLoaded
=
false
;
let
isActorInstantiated
=
false
;
function
onActorEvent
(
subject
topic
data
)
{
if
(
data
=
=
"
loaded
"
)
{
isActorLoaded
=
true
;
}
else
if
(
data
=
=
"
instantiated
"
)
{
isActorInstantiated
=
true
;
}
}
Services
.
obs
.
addObserver
(
onActorEvent
"
actor
"
)
;
ActorRegistry
.
registerModule
(
"
xpcshell
-
test
/
registertestactors
-
lazy
"
{
prefix
:
"
lazy
"
constructor
:
"
LazyActor
"
type
:
{
global
:
true
target
:
true
}
}
)
;
Assert
.
ok
(
ActorRegistry
.
targetScopedActorFactories
.
hasOwnProperty
(
"
lazyActor
"
)
)
;
Assert
.
ok
(
ActorRegistry
.
globalActorFactories
.
hasOwnProperty
(
"
lazyActor
"
)
)
;
Assert
.
ok
(
!
isActorLoaded
)
;
Assert
.
ok
(
!
isActorInstantiated
)
;
const
client
=
new
DebuggerClient
(
DebuggerServer
.
connectPipe
(
)
)
;
client
.
connect
(
)
.
then
(
function
onConnect
(
)
{
client
.
mainRoot
.
rootForm
.
then
(
onRootForm
)
;
}
)
;
function
onRootForm
(
response
)
{
Assert
.
ok
(
!
isActorLoaded
)
;
Assert
.
ok
(
!
isActorInstantiated
)
;
Assert
.
ok
(
"
lazyActor
"
in
response
)
;
const
{
LazyFront
}
=
require
(
"
xpcshell
-
test
/
registertestactors
-
lazy
"
)
;
const
front
=
new
LazyFront
(
client
)
;
front
.
actorID
=
response
.
lazyActor
;
client
.
addActorPool
(
front
)
;
front
.
manage
(
front
)
;
front
.
hello
(
)
.
then
(
onRequest
)
;
}
function
onRequest
(
response
)
{
Assert
.
equal
(
response
"
world
"
)
;
Assert
.
ok
(
isActorLoaded
)
;
Assert
.
ok
(
isActorInstantiated
)
;
Services
.
obs
.
removeObserver
(
onActorEvent
"
actor
"
)
;
client
.
close
(
)
.
then
(
(
)
=
>
run_next_test
(
)
)
;
}
}
function
manual_remove
(
)
{
Assert
.
ok
(
ActorRegistry
.
globalActorFactories
.
hasOwnProperty
(
"
lazyActor
"
)
)
;
ActorRegistry
.
removeGlobalActor
(
"
lazyActor
"
)
;
Assert
.
ok
(
!
ActorRegistry
.
globalActorFactories
.
hasOwnProperty
(
"
lazyActor
"
)
)
;
run_next_test
(
)
;
}
function
cleanup
(
)
{
DebuggerServer
.
destroy
(
)
;
Assert
.
ok
(
!
ActorRegistry
.
targetScopedActorFactories
.
hasOwnProperty
(
"
lazyActor
"
)
)
;
Assert
.
ok
(
!
ActorRegistry
.
globalActorFactories
.
hasOwnProperty
(
"
lazyActor
"
)
)
;
run_next_test
(
)
;
}
