"
use
strict
"
;
const
{
PromisesFront
}
=
require
(
"
devtools
/
shared
/
fronts
/
promises
"
)
;
const
{
setTimeout
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
{
}
)
;
var
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
add_task
(
function
*
(
)
{
let
client
=
yield
startTestDebuggerServer
(
"
test
-
promises
-
timetosettle
"
)
;
let
chromeActors
=
yield
getChromeActors
(
client
)
;
yield
attachTab
(
client
chromeActors
)
;
ok
(
Promise
.
toString
(
)
.
includes
(
"
native
code
"
)
"
Expect
native
DOM
Promise
.
"
)
;
yield
attachTab
(
client
chromeActors
)
;
yield
testGetTimeToSettle
(
client
chromeActors
v
=
>
new
Promise
(
resolve
=
>
setTimeout
(
(
)
=
>
resolve
(
v
)
100
)
)
)
;
let
response
=
yield
listTabs
(
client
)
;
let
targetTab
=
findTab
(
response
.
tabs
"
test
-
promises
-
timetosettle
"
)
;
ok
(
targetTab
"
Found
our
target
tab
.
"
)
;
yield
attachTab
(
client
targetTab
)
;
yield
testGetTimeToSettle
(
client
targetTab
v
=
>
{
const
debuggee
=
DebuggerServer
.
getTestGlobal
(
"
test
-
promises
-
timetosettle
"
)
;
return
new
debuggee
.
Promise
(
resolve
=
>
setTimeout
(
(
)
=
>
resolve
(
v
)
100
)
)
;
}
)
;
yield
close
(
client
)
;
}
)
;
function
*
testGetTimeToSettle
(
client
form
makePromise
)
{
let
front
=
PromisesFront
(
client
form
)
;
let
resolution
=
"
MyLittleSecret
"
+
Math
.
random
(
)
;
let
found
=
false
;
yield
front
.
attach
(
)
;
yield
front
.
listPromises
(
)
;
let
onNewPromise
=
new
Promise
(
resolve
=
>
{
EventEmitter
.
on
(
front
"
promises
-
settled
"
promises
=
>
{
for
(
let
p
of
promises
)
{
if
(
p
.
promiseState
.
state
=
=
=
"
fulfilled
"
&
&
p
.
promiseState
.
value
=
=
=
resolution
)
{
let
timeToSettle
=
Math
.
floor
(
p
.
promiseState
.
timeToSettle
/
100
)
*
100
;
ok
(
timeToSettle
>
=
100
"
Expect
time
to
settle
for
resolved
promise
to
be
"
+
"
at
least
100ms
got
"
+
timeToSettle
+
"
ms
.
"
)
;
found
=
true
;
resolve
(
)
;
}
else
{
dump
(
"
Found
non
-
target
promise
.
\
n
"
)
;
}
}
}
)
;
}
)
;
let
promise
=
makePromise
(
resolution
)
;
yield
onNewPromise
;
ok
(
found
"
Found
our
new
promise
.
"
)
;
yield
front
.
detach
(
)
;
void
promise
;
}
