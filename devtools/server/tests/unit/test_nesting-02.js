"
use
strict
"
;
add_task
(
threadFrontTest
(
async
(
{
threadFront
client
}
)
=
>
{
const
thread
=
client
.
_transport
.
_serverConnection
.
getActor
(
threadFront
.
actorID
)
;
test_nesting
(
thread
)
;
}
)
)
;
function
test_nesting
(
thread
)
{
const
{
resolve
promise
:
p
}
=
defer
(
)
;
let
currentStep
=
0
;
executeSoon
(
function
(
)
{
executeSoon
(
function
(
)
{
Assert
.
equal
(
+
+
currentStep
2
)
;
Assert
.
equal
(
thread
.
_nestedEventLoops
.
size
2
)
;
executeSoon
(
function
(
)
{
Assert
.
equal
(
+
+
currentStep
3
)
;
Assert
.
equal
(
thread
.
_nestedEventLoops
.
size
2
)
;
Assert
.
ok
(
!
!
eventLoop
)
;
eventLoop
.
resolve
(
)
;
}
)
;
resolve
(
true
)
;
Assert
.
equal
(
thread
.
_nestedEventLoops
.
size
2
)
;
}
)
;
Assert
.
equal
(
+
+
currentStep
1
)
;
Assert
.
equal
(
thread
.
_nestedEventLoops
.
size
1
)
;
const
eventLoop
=
thread
.
_nestedEventLoops
.
push
(
)
;
eventLoop
.
enter
(
)
;
}
)
;
Assert
.
equal
(
thread
.
unsafeSynchronize
(
p
)
true
)
;
Assert
.
equal
(
+
+
currentStep
4
)
;
Assert
.
equal
(
thread
.
_nestedEventLoops
.
size
0
)
;
}
