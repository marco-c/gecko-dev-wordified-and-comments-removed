"
use
strict
"
;
const
{
Ci
Cu
}
=
require
(
"
chrome
"
)
;
const
ChromeUtils
=
require
(
"
ChromeUtils
"
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
protocol
=
require
(
"
devtools
/
shared
/
protocol
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
{
highlighterSpec
customHighlighterSpec
}
=
require
(
"
devtools
/
shared
/
specs
/
highlighters
"
)
;
loader
.
lazyRequireGetter
(
this
"
isWindowIncluded
"
"
devtools
/
shared
/
layout
/
utils
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
isXUL
"
"
devtools
/
server
/
actors
/
highlighters
/
utils
/
markup
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
SimpleOutlineHighlighter
"
"
devtools
/
server
/
actors
/
highlighters
/
simple
-
outline
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
BoxModelHighlighter
"
"
devtools
/
server
/
actors
/
highlighters
/
box
-
model
"
true
)
;
const
HIGHLIGHTER_PICKED_TIMER
=
1000
;
const
IS_OSX
=
Services
.
appinfo
.
OS
=
=
=
"
Darwin
"
;
const
highlighterTypes
=
new
Map
(
)
;
const
isTypeRegistered
=
(
typeName
)
=
>
highlighterTypes
.
has
(
typeName
)
;
exports
.
isTypeRegistered
=
isTypeRegistered
;
const
register
=
(
typeName
modulePath
)
=
>
{
if
(
highlighterTypes
.
has
(
typeName
)
)
{
throw
Error
(
{
typeName
}
is
already
registered
.
)
;
}
highlighterTypes
.
set
(
typeName
modulePath
)
;
}
;
exports
.
register
=
register
;
exports
.
HighlighterActor
=
protocol
.
ActorClassWithSpec
(
highlighterSpec
{
initialize
:
function
(
inspector
autohide
)
{
protocol
.
Actor
.
prototype
.
initialize
.
call
(
this
null
)
;
this
.
_autohide
=
autohide
;
this
.
_inspector
=
inspector
;
this
.
_walker
=
this
.
_inspector
.
walker
;
this
.
_tabActor
=
this
.
_inspector
.
tabActor
;
this
.
_highlighterEnv
=
new
HighlighterEnvironment
(
)
;
this
.
_highlighterEnv
.
initFromTabActor
(
this
.
_tabActor
)
;
this
.
_highlighterReady
=
this
.
_highlighterReady
.
bind
(
this
)
;
this
.
_highlighterHidden
=
this
.
_highlighterHidden
.
bind
(
this
)
;
this
.
_onNavigate
=
this
.
_onNavigate
.
bind
(
this
)
;
const
doc
=
this
.
_tabActor
.
window
.
document
;
if
(
doc
.
documentElement
&
&
doc
.
readyState
!
=
"
uninitialized
"
)
{
this
.
_createHighlighter
(
)
;
}
this
.
_tabActor
.
on
(
"
navigate
"
this
.
_onNavigate
)
;
}
get
conn
(
)
{
return
this
.
_inspector
&
&
this
.
_inspector
.
conn
;
}
form
:
function
(
)
{
return
{
actor
:
this
.
actorID
traits
:
{
autoHideOnDestroy
:
true
}
}
;
}
_createHighlighter
:
function
(
)
{
this
.
_isPreviousWindowXUL
=
isXUL
(
this
.
_tabActor
.
window
)
;
if
(
!
this
.
_isPreviousWindowXUL
)
{
this
.
_highlighter
=
new
BoxModelHighlighter
(
this
.
_highlighterEnv
this
.
_inspector
)
;
this
.
_highlighter
.
on
(
"
ready
"
this
.
_highlighterReady
)
;
this
.
_highlighter
.
on
(
"
hide
"
this
.
_highlighterHidden
)
;
}
else
{
this
.
_highlighter
=
new
SimpleOutlineHighlighter
(
this
.
_highlighterEnv
)
;
}
}
_destroyHighlighter
:
function
(
)
{
if
(
this
.
_highlighter
)
{
if
(
!
this
.
_isPreviousWindowXUL
)
{
this
.
_highlighter
.
off
(
"
ready
"
this
.
_highlighterReady
)
;
this
.
_highlighter
.
off
(
"
hide
"
this
.
_highlighterHidden
)
;
}
this
.
_highlighter
.
destroy
(
)
;
this
.
_highlighter
=
null
;
}
}
_onNavigate
:
function
(
{
isTopLevel
}
)
{
if
(
!
isTopLevel
|
|
!
this
.
_tabActor
.
window
.
document
.
documentElement
)
{
return
;
}
if
(
isXUL
(
this
.
_tabActor
.
window
)
!
=
=
this
.
_isPreviousWindowXUL
)
{
this
.
_destroyHighlighter
(
)
;
this
.
_createHighlighter
(
)
;
}
}
destroy
:
function
(
)
{
protocol
.
Actor
.
prototype
.
destroy
.
call
(
this
)
;
this
.
hideBoxModel
(
)
;
this
.
_destroyHighlighter
(
)
;
this
.
_tabActor
.
off
(
"
navigate
"
this
.
_onNavigate
)
;
this
.
_highlighterEnv
.
destroy
(
)
;
this
.
_highlighterEnv
=
null
;
this
.
_autohide
=
null
;
this
.
_inspector
=
null
;
this
.
_walker
=
null
;
this
.
_tabActor
=
null
;
}
showBoxModel
:
function
(
node
options
=
{
}
)
{
if
(
!
node
|
|
!
this
.
_highlighter
.
show
(
node
.
rawNode
options
)
)
{
this
.
_highlighter
.
hide
(
)
;
}
}
hideBoxModel
:
function
(
)
{
if
(
this
.
_highlighter
)
{
this
.
_highlighter
.
hide
(
)
;
}
}
_isEventAllowed
:
function
(
{
view
}
)
{
const
{
window
}
=
this
.
_highlighterEnv
;
return
window
instanceof
Ci
.
nsIDOMChromeWindow
|
|
isWindowIncluded
(
window
view
)
;
}
_isPicking
:
false
_hoveredNode
:
null
_currentNode
:
null
pick
:
function
(
)
{
if
(
this
.
_isPicking
)
{
return
null
;
}
this
.
_isPicking
=
true
;
this
.
_preventContentEvent
=
event
=
>
{
event
.
stopPropagation
(
)
;
event
.
preventDefault
(
)
;
}
;
this
.
_onPick
=
event
=
>
{
this
.
_preventContentEvent
(
event
)
;
if
(
!
this
.
_isEventAllowed
(
event
)
)
{
return
;
}
if
(
event
.
shiftKey
)
{
this
.
_walker
.
emit
(
"
picker
-
node
-
previewed
"
this
.
_findAndAttachElement
(
event
)
)
;
return
;
}
this
.
_stopPickerListeners
(
)
;
this
.
_isPicking
=
false
;
if
(
this
.
_autohide
)
{
this
.
_tabActor
.
window
.
setTimeout
(
(
)
=
>
{
this
.
_highlighter
.
hide
(
)
;
}
HIGHLIGHTER_PICKED_TIMER
)
;
}
if
(
!
this
.
_currentNode
)
{
this
.
_currentNode
=
this
.
_findAndAttachElement
(
event
)
;
}
this
.
_walker
.
emit
(
"
picker
-
node
-
picked
"
this
.
_currentNode
)
;
}
;
this
.
_onHovered
=
event
=
>
{
this
.
_preventContentEvent
(
event
)
;
if
(
!
this
.
_isEventAllowed
(
event
)
)
{
return
;
}
this
.
_currentNode
=
this
.
_findAndAttachElement
(
event
)
;
if
(
this
.
_hoveredNode
!
=
=
this
.
_currentNode
.
node
)
{
this
.
_highlighter
.
show
(
this
.
_currentNode
.
node
.
rawNode
)
;
this
.
_walker
.
emit
(
"
picker
-
node
-
hovered
"
this
.
_currentNode
)
;
this
.
_hoveredNode
=
this
.
_currentNode
.
node
;
}
}
;
this
.
_onKey
=
event
=
>
{
if
(
!
this
.
_currentNode
|
|
!
this
.
_isPicking
)
{
return
;
}
this
.
_preventContentEvent
(
event
)
;
if
(
!
this
.
_isEventAllowed
(
event
)
)
{
return
;
}
let
currentNode
=
this
.
_currentNode
.
node
.
rawNode
;
switch
(
event
.
keyCode
)
{
case
event
.
DOM_VK_LEFT
:
if
(
!
currentNode
.
parentElement
)
{
return
;
}
currentNode
=
currentNode
.
parentElement
;
break
;
case
event
.
DOM_VK_RIGHT
:
if
(
!
currentNode
.
children
.
length
)
{
return
;
}
let
child
=
currentNode
.
firstElementChild
;
const
hoveredNode
=
this
.
_hoveredNode
.
rawNode
;
for
(
const
sibling
of
currentNode
.
children
)
{
if
(
sibling
.
contains
(
hoveredNode
)
|
|
sibling
=
=
=
hoveredNode
)
{
child
=
sibling
;
}
}
currentNode
=
child
;
break
;
case
event
.
DOM_VK_RETURN
:
this
.
_onPick
(
event
)
;
return
;
case
event
.
DOM_VK_ESCAPE
:
this
.
cancelPick
(
)
;
this
.
_walker
.
emit
(
"
picker
-
node
-
canceled
"
)
;
return
;
case
event
.
DOM_VK_C
:
if
(
(
IS_OSX
&
&
event
.
metaKey
&
&
event
.
altKey
)
|
|
(
!
IS_OSX
&
&
event
.
ctrlKey
&
&
event
.
shiftKey
)
)
{
this
.
cancelPick
(
)
;
this
.
_walker
.
emit
(
"
picker
-
node
-
canceled
"
)
;
}
return
;
default
:
return
;
}
this
.
_currentNode
=
this
.
_walker
.
attachElement
(
currentNode
)
;
this
.
_highlighter
.
show
(
this
.
_currentNode
.
node
.
rawNode
)
;
this
.
_walker
.
emit
(
"
picker
-
node
-
hovered
"
this
.
_currentNode
)
;
}
;
this
.
_startPickerListeners
(
)
;
return
null
;
}
pickAndFocus
:
function
(
)
{
const
pickResults
=
this
.
pick
(
)
;
this
.
_highlighterEnv
.
window
.
focus
(
)
;
return
pickResults
;
}
_findAndAttachElement
:
function
(
event
)
{
const
node
=
event
.
originalTarget
|
|
event
.
target
;
return
this
.
_walker
.
attachElement
(
node
)
;
}
_startPickerListeners
:
function
(
)
{
const
target
=
this
.
_highlighterEnv
.
pageListenerTarget
;
target
.
addEventListener
(
"
mousemove
"
this
.
_onHovered
true
)
;
target
.
addEventListener
(
"
click
"
this
.
_onPick
true
)
;
target
.
addEventListener
(
"
mousedown
"
this
.
_preventContentEvent
true
)
;
target
.
addEventListener
(
"
mouseup
"
this
.
_preventContentEvent
true
)
;
target
.
addEventListener
(
"
dblclick
"
this
.
_preventContentEvent
true
)
;
target
.
addEventListener
(
"
keydown
"
this
.
_onKey
true
)
;
target
.
addEventListener
(
"
keyup
"
this
.
_preventContentEvent
true
)
;
}
_stopPickerListeners
:
function
(
)
{
const
target
=
this
.
_highlighterEnv
.
pageListenerTarget
;
if
(
!
target
)
{
return
;
}
target
.
removeEventListener
(
"
mousemove
"
this
.
_onHovered
true
)
;
target
.
removeEventListener
(
"
click
"
this
.
_onPick
true
)
;
target
.
removeEventListener
(
"
mousedown
"
this
.
_preventContentEvent
true
)
;
target
.
removeEventListener
(
"
mouseup
"
this
.
_preventContentEvent
true
)
;
target
.
removeEventListener
(
"
dblclick
"
this
.
_preventContentEvent
true
)
;
target
.
removeEventListener
(
"
keydown
"
this
.
_onKey
true
)
;
target
.
removeEventListener
(
"
keyup
"
this
.
_preventContentEvent
true
)
;
}
_highlighterReady
:
function
(
)
{
this
.
_inspector
.
walker
.
emit
(
"
highlighter
-
ready
"
)
;
}
_highlighterHidden
:
function
(
)
{
this
.
_inspector
.
walker
.
emit
(
"
highlighter
-
hide
"
)
;
}
cancelPick
:
function
(
)
{
if
(
this
.
_isPicking
)
{
this
.
_highlighter
.
hide
(
)
;
this
.
_stopPickerListeners
(
)
;
this
.
_isPicking
=
false
;
this
.
_hoveredNode
=
null
;
}
}
}
)
;
exports
.
CustomHighlighterActor
=
protocol
.
ActorClassWithSpec
(
customHighlighterSpec
{
initialize
:
function
(
parent
typeName
)
{
protocol
.
Actor
.
prototype
.
initialize
.
call
(
this
null
)
;
this
.
_parent
=
parent
;
const
modulePath
=
highlighterTypes
.
get
(
typeName
)
;
if
(
!
modulePath
)
{
const
list
=
[
.
.
.
highlighterTypes
.
keys
(
)
]
;
throw
new
Error
(
{
typeName
}
isn
'
t
a
valid
highlighter
class
(
{
list
}
)
)
;
}
const
constructor
=
require
(
"
.
/
highlighters
/
"
+
modulePath
)
[
typeName
]
;
if
(
!
isXUL
(
this
.
_parent
.
tabActor
.
window
)
|
|
constructor
.
XULSupported
)
{
this
.
_highlighterEnv
=
new
HighlighterEnvironment
(
)
;
this
.
_highlighterEnv
.
initFromTabActor
(
parent
.
tabActor
)
;
this
.
_highlighter
=
new
constructor
(
this
.
_highlighterEnv
)
;
if
(
this
.
_highlighter
.
on
)
{
this
.
_highlighter
.
on
(
"
highlighter
-
event
"
this
.
_onHighlighterEvent
.
bind
(
this
)
)
;
}
}
else
{
throw
new
Error
(
"
Custom
"
+
typeName
+
"
highlighter
cannot
be
created
in
a
XUL
window
"
)
;
}
}
get
conn
(
)
{
return
this
.
_parent
&
&
this
.
_parent
.
conn
;
}
destroy
:
function
(
)
{
protocol
.
Actor
.
prototype
.
destroy
.
call
(
this
)
;
this
.
finalize
(
)
;
this
.
_parent
=
null
;
}
release
:
function
(
)
{
}
show
:
function
(
node
options
)
{
if
(
!
node
|
|
!
this
.
_highlighter
)
{
return
false
;
}
return
this
.
_highlighter
.
show
(
node
.
rawNode
options
)
;
}
hide
:
function
(
)
{
if
(
this
.
_highlighter
)
{
this
.
_highlighter
.
hide
(
)
;
}
}
_onHighlighterEvent
:
function
(
data
)
{
this
.
emit
(
"
highlighter
-
event
"
data
)
;
}
finalize
:
function
(
)
{
if
(
this
.
_highlighter
)
{
if
(
this
.
_highlighter
.
off
)
{
this
.
_highlighter
.
off
(
"
highlighter
-
event
"
this
.
_onHighlighterEvent
.
bind
(
this
)
)
;
}
this
.
_highlighter
.
destroy
(
)
;
this
.
_highlighter
=
null
;
}
if
(
this
.
_highlighterEnv
)
{
this
.
_highlighterEnv
.
destroy
(
)
;
this
.
_highlighterEnv
=
null
;
}
}
}
)
;
function
HighlighterEnvironment
(
)
{
this
.
relayTabActorWindowReady
=
this
.
relayTabActorWindowReady
.
bind
(
this
)
;
this
.
relayTabActorNavigate
=
this
.
relayTabActorNavigate
.
bind
(
this
)
;
this
.
relayTabActorWillNavigate
=
this
.
relayTabActorWillNavigate
.
bind
(
this
)
;
EventEmitter
.
decorate
(
this
)
;
}
exports
.
HighlighterEnvironment
=
HighlighterEnvironment
;
HighlighterEnvironment
.
prototype
=
{
initFromTabActor
:
function
(
tabActor
)
{
this
.
_tabActor
=
tabActor
;
this
.
_tabActor
.
on
(
"
window
-
ready
"
this
.
relayTabActorWindowReady
)
;
this
.
_tabActor
.
on
(
"
navigate
"
this
.
relayTabActorNavigate
)
;
this
.
_tabActor
.
on
(
"
will
-
navigate
"
this
.
relayTabActorWillNavigate
)
;
}
initFromWindow
:
function
(
win
)
{
this
.
_win
=
win
;
const
self
=
this
;
this
.
listener
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIWebProgressListener
Ci
.
nsISupportsWeakReference
]
)
onStateChange
:
function
(
progress
request
flag
)
{
const
isStart
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_START
;
const
isStop
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_STOP
;
const
isWindow
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_IS_WINDOW
;
const
isDocument
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_IS_DOCUMENT
;
if
(
progress
.
DOMWindow
!
=
=
win
)
{
return
;
}
if
(
isDocument
&
&
isStart
)
{
self
.
emit
(
"
will
-
navigate
"
{
window
:
win
isTopLevel
:
true
}
)
;
}
if
(
isWindow
&
&
isStop
)
{
self
.
emit
(
"
navigate
"
{
window
:
win
isTopLevel
:
true
}
)
;
}
}
}
;
this
.
webProgress
.
addProgressListener
(
this
.
listener
Ci
.
nsIWebProgress
.
NOTIFY_STATE_WINDOW
|
Ci
.
nsIWebProgress
.
NOTIFY_STATE_DOCUMENT
)
;
}
get
isInitialized
(
)
{
return
this
.
_win
|
|
this
.
_tabActor
;
}
get
isXUL
(
)
{
return
isXUL
(
this
.
window
)
;
}
get
window
(
)
{
if
(
!
this
.
isInitialized
)
{
throw
new
Error
(
"
Initialize
HighlighterEnvironment
with
a
tabActor
"
+
"
or
window
first
"
)
;
}
const
win
=
this
.
_tabActor
?
this
.
_tabActor
.
window
:
this
.
_win
;
return
Cu
.
isDeadWrapper
(
win
)
?
null
:
win
;
}
get
document
(
)
{
return
this
.
window
&
&
this
.
window
.
document
;
}
get
docShell
(
)
{
return
this
.
window
&
&
this
.
window
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebNavigation
)
.
QueryInterface
(
Ci
.
nsIDocShell
)
;
}
get
webProgress
(
)
{
return
this
.
docShell
&
&
this
.
docShell
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebProgress
)
;
}
get
pageListenerTarget
(
)
{
if
(
this
.
_tabActor
&
&
this
.
_tabActor
.
isRootActor
)
{
return
this
.
window
;
}
return
this
.
docShell
&
&
this
.
docShell
.
chromeEventHandler
;
}
relayTabActorWindowReady
:
function
(
data
)
{
this
.
emit
(
"
window
-
ready
"
data
)
;
}
relayTabActorNavigate
:
function
(
data
)
{
this
.
emit
(
"
navigate
"
data
)
;
}
relayTabActorWillNavigate
:
function
(
data
)
{
this
.
emit
(
"
will
-
navigate
"
data
)
;
}
destroy
:
function
(
)
{
if
(
this
.
_tabActor
)
{
this
.
_tabActor
.
off
(
"
window
-
ready
"
this
.
relayTabActorWindowReady
)
;
this
.
_tabActor
.
off
(
"
navigate
"
this
.
relayTabActorNavigate
)
;
this
.
_tabActor
.
off
(
"
will
-
navigate
"
this
.
relayTabActorWillNavigate
)
;
}
if
(
this
.
_win
)
{
try
{
this
.
webProgress
.
removeProgressListener
(
this
.
listener
)
;
}
catch
(
e
)
{
}
}
this
.
_tabActor
=
null
;
this
.
_win
=
null
;
}
}
;
register
(
"
BoxModelHighlighter
"
"
box
-
model
"
)
;
register
(
"
CssGridHighlighter
"
"
css
-
grid
"
)
;
register
(
"
CssTransformHighlighter
"
"
css
-
transform
"
)
;
register
(
"
EyeDropper
"
"
eye
-
dropper
"
)
;
register
(
"
FlexboxHighlighter
"
"
flexbox
"
)
;
register
(
"
FontsHighlighter
"
"
fonts
"
)
;
register
(
"
GeometryEditorHighlighter
"
"
geometry
-
editor
"
)
;
register
(
"
MeasuringToolHighlighter
"
"
measuring
-
tool
"
)
;
register
(
"
PausedDebuggerOverlay
"
"
paused
-
debugger
"
)
;
register
(
"
RulersHighlighter
"
"
rulers
"
)
;
register
(
"
SelectorHighlighter
"
"
selector
"
)
;
register
(
"
ShapesHighlighter
"
"
shapes
"
)
;
