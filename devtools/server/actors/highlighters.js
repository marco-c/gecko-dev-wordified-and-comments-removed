"
use
strict
"
;
const
{
Actor
}
=
require
(
"
devtools
/
shared
/
protocol
"
)
;
const
{
customHighlighterSpec
}
=
require
(
"
devtools
/
shared
/
specs
/
highlighters
"
)
;
const
{
TYPES
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
devtools
/
shared
/
highlighters
.
mjs
"
{
global
:
"
contextual
"
}
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
loader
.
lazyRequireGetter
(
this
"
isXUL
"
"
resource
:
/
/
devtools
/
server
/
actors
/
highlighters
/
utils
/
markup
.
js
"
true
)
;
const
highlighterTypes
=
new
Map
(
)
;
const
isTypeRegistered
=
typeName
=
>
highlighterTypes
.
has
(
typeName
)
;
exports
.
isTypeRegistered
=
isTypeRegistered
;
const
registerHighlighter
=
(
typeName
modulePath
)
=
>
{
if
(
highlighterTypes
.
has
(
typeName
)
)
{
throw
Error
(
{
typeName
}
is
already
registered
.
)
;
}
highlighterTypes
.
set
(
typeName
modulePath
)
;
}
;
exports
.
CustomHighlighterActor
=
class
CustomHighligherActor
extends
Actor
{
constructor
(
parent
typeName
)
{
super
(
parent
.
conn
customHighlighterSpec
)
;
this
.
_parent
=
parent
;
const
modulePath
=
highlighterTypes
.
get
(
typeName
)
;
if
(
!
modulePath
)
{
const
list
=
[
.
.
.
highlighterTypes
.
keys
(
)
]
;
throw
new
Error
(
{
typeName
}
isn
'
t
a
valid
highlighter
class
(
{
list
}
)
)
;
}
const
constructor
=
require
(
modulePath
)
[
typeName
]
;
if
(
!
isXUL
(
this
.
_parent
.
targetActor
.
window
)
|
|
constructor
.
XULSupported
)
{
this
.
_highlighterEnv
=
new
HighlighterEnvironment
(
)
;
this
.
_highlighterEnv
.
initFromTargetActor
(
parent
.
targetActor
)
;
this
.
_highlighter
=
new
constructor
(
this
.
_highlighterEnv
parent
)
;
if
(
this
.
_highlighter
.
on
)
{
this
.
_highlighter
.
on
(
"
highlighter
-
event
"
this
.
_onHighlighterEvent
.
bind
(
this
)
)
;
}
}
else
{
throw
new
Error
(
"
Custom
"
+
typeName
+
"
highlighter
cannot
be
created
in
a
XUL
window
"
)
;
}
}
destroy
(
)
{
super
.
destroy
(
)
;
this
.
finalize
(
)
;
this
.
_parent
=
null
;
}
release
(
)
{
}
get
instance
(
)
{
return
this
.
_highlighter
;
}
show
(
node
options
)
{
if
(
!
this
.
_highlighter
)
{
return
null
;
}
const
rawNode
=
node
?
.
rawNode
;
return
this
.
_highlighter
.
show
(
rawNode
options
)
;
}
hide
(
)
{
if
(
this
.
_highlighter
)
{
this
.
_highlighter
.
hide
(
)
;
}
}
_onHighlighterEvent
(
data
)
{
this
.
emit
(
"
highlighter
-
event
"
data
)
;
}
finalize
(
)
{
if
(
this
.
_highlighter
)
{
if
(
this
.
_highlighter
.
off
)
{
this
.
_highlighter
.
off
(
"
highlighter
-
event
"
this
.
_onHighlighterEvent
.
bind
(
this
)
)
;
}
this
.
_highlighter
.
destroy
(
)
;
this
.
_highlighter
=
null
;
}
if
(
this
.
_highlighterEnv
)
{
this
.
_highlighterEnv
.
destroy
(
)
;
this
.
_highlighterEnv
=
null
;
}
}
}
;
class
HighlighterEnvironment
extends
EventEmitter
{
initFromTargetActor
(
targetActor
)
{
this
.
_targetActor
=
targetActor
;
const
relayedEvents
=
[
"
window
-
ready
"
"
navigate
"
"
will
-
navigate
"
"
use
-
simple
-
highlighters
-
updated
"
]
;
this
.
_abortController
=
new
AbortController
(
)
;
const
signal
=
this
.
_abortController
.
signal
;
for
(
const
event
of
relayedEvents
)
{
this
.
_targetActor
.
on
(
event
this
.
relayTargetEvent
.
bind
(
this
event
)
{
signal
}
)
;
}
}
initFromWindow
(
win
)
{
this
.
_win
=
win
;
const
self
=
this
;
this
.
listener
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIWebProgressListener
"
"
nsISupportsWeakReference
"
]
)
onStateChange
(
progress
request
flag
)
{
const
isStart
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_START
;
const
isStop
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_STOP
;
const
isWindow
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_IS_WINDOW
;
const
isDocument
=
flag
&
Ci
.
nsIWebProgressListener
.
STATE_IS_DOCUMENT
;
if
(
progress
.
DOMWindow
!
=
=
win
)
{
return
;
}
if
(
isDocument
&
&
isStart
)
{
self
.
emit
(
"
will
-
navigate
"
{
window
:
win
isTopLevel
:
true
}
)
;
}
if
(
isWindow
&
&
isStop
)
{
self
.
emit
(
"
navigate
"
{
window
:
win
isTopLevel
:
true
}
)
;
}
}
}
;
this
.
webProgress
.
addProgressListener
(
this
.
listener
Ci
.
nsIWebProgress
.
NOTIFY_STATE_WINDOW
|
Ci
.
nsIWebProgress
.
NOTIFY_STATE_DOCUMENT
)
;
}
get
isInitialized
(
)
{
return
this
.
_win
|
|
this
.
_targetActor
;
}
get
isXUL
(
)
{
return
isXUL
(
this
.
window
)
;
}
get
useSimpleHighlightersForReducedMotion
(
)
{
return
this
.
_targetActor
?
.
_useSimpleHighlightersForReducedMotion
;
}
get
window
(
)
{
if
(
!
this
.
isInitialized
)
{
throw
new
Error
(
"
Initialize
HighlighterEnvironment
with
a
targetActor
"
+
"
or
window
first
"
)
;
}
const
win
=
this
.
_targetActor
?
this
.
_targetActor
.
window
:
this
.
_win
;
try
{
return
Cu
.
isDeadWrapper
(
win
)
?
null
:
win
;
}
catch
(
e
)
{
return
null
;
}
}
get
document
(
)
{
return
this
.
window
&
&
this
.
window
.
document
;
}
get
docShell
(
)
{
return
this
.
window
&
&
this
.
window
.
docShell
;
}
get
webProgress
(
)
{
return
(
this
.
docShell
&
&
this
.
docShell
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebProgress
)
)
;
}
get
pageListenerTarget
(
)
{
if
(
this
.
_targetActor
&
&
this
.
_targetActor
.
isRootActor
)
{
return
this
.
window
;
}
return
this
.
docShell
&
&
this
.
docShell
.
chromeEventHandler
;
}
relayTargetEvent
(
name
data
)
{
this
.
emit
(
name
data
)
;
}
destroy
(
)
{
if
(
this
.
_abortController
)
{
this
.
_abortController
.
abort
(
)
;
this
.
_abortController
=
null
;
}
if
(
this
.
_win
)
{
try
{
this
.
webProgress
.
removeProgressListener
(
this
.
listener
)
;
}
catch
(
e
)
{
}
}
this
.
_targetActor
=
null
;
this
.
_win
=
null
;
}
}
exports
.
HighlighterEnvironment
=
HighlighterEnvironment
;
const
HIGHLIGHTERS
=
{
[
TYPES
.
ACCESSIBLE
]
:
"
devtools
/
server
/
actors
/
highlighters
/
accessible
"
[
TYPES
.
BOXMODEL
]
:
"
devtools
/
server
/
actors
/
highlighters
/
box
-
model
"
[
TYPES
.
GRID
]
:
"
devtools
/
server
/
actors
/
highlighters
/
css
-
grid
"
[
TYPES
.
TRANSFORM
]
:
"
devtools
/
server
/
actors
/
highlighters
/
css
-
transform
"
[
TYPES
.
EYEDROPPER
]
:
"
devtools
/
server
/
actors
/
highlighters
/
eye
-
dropper
"
[
TYPES
.
FLEXBOX
]
:
"
devtools
/
server
/
actors
/
highlighters
/
flexbox
"
[
TYPES
.
FONTS
]
:
"
devtools
/
server
/
actors
/
highlighters
/
fonts
"
[
TYPES
.
GEOMETRY
]
:
"
devtools
/
server
/
actors
/
highlighters
/
geometry
-
editor
"
[
TYPES
.
MEASURING
]
:
"
devtools
/
server
/
actors
/
highlighters
/
measuring
-
tool
"
[
TYPES
.
PAUSED_DEBUGGER
]
:
"
devtools
/
server
/
actors
/
highlighters
/
paused
-
debugger
"
[
TYPES
.
RULERS
]
:
"
devtools
/
server
/
actors
/
highlighters
/
rulers
"
[
TYPES
.
SELECTOR
]
:
"
devtools
/
server
/
actors
/
highlighters
/
selector
"
[
TYPES
.
SHAPES
]
:
"
devtools
/
server
/
actors
/
highlighters
/
shapes
"
[
TYPES
.
TABBING_ORDER
]
:
"
devtools
/
server
/
actors
/
highlighters
/
tabbing
-
order
"
[
TYPES
.
VIEWPORT_SIZE
]
:
"
devtools
/
server
/
actors
/
highlighters
/
viewport
-
size
"
}
;
for
(
const
[
typeName
modulePath
]
of
Object
.
entries
(
HIGHLIGHTERS
)
)
{
registerHighlighter
(
typeName
modulePath
)
;
}
