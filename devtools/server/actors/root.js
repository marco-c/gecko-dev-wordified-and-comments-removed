"
use
strict
"
;
const
{
Cu
}
=
require
(
"
chrome
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
{
ActorPool
appendExtraActors
createExtraActors
}
=
require
(
"
devtools
/
server
/
actors
/
common
"
)
;
const
{
DebuggerServer
}
=
require
(
"
devtools
/
server
/
main
"
)
;
loader
.
lazyRequireGetter
(
this
"
WindowActor
"
"
devtools
/
server
/
actors
/
window
"
true
)
;
function
RootActor
(
connection
parameters
)
{
this
.
conn
=
connection
;
this
.
_parameters
=
parameters
;
this
.
_onTabListChanged
=
this
.
onTabListChanged
.
bind
(
this
)
;
this
.
_onAddonListChanged
=
this
.
onAddonListChanged
.
bind
(
this
)
;
this
.
_onWorkerListChanged
=
this
.
onWorkerListChanged
.
bind
(
this
)
;
this
.
_onServiceWorkerRegistrationListChanged
=
this
.
onServiceWorkerRegistrationListChanged
.
bind
(
this
)
;
this
.
_onProcessListChanged
=
this
.
onProcessListChanged
.
bind
(
this
)
;
this
.
_extraActors
=
{
}
;
this
.
_globalActorPool
=
new
ActorPool
(
this
.
conn
)
;
this
.
conn
.
addActorPool
(
this
.
_globalActorPool
)
;
this
.
_chromeActor
=
null
;
this
.
_processActors
=
new
Map
(
)
;
}
RootActor
.
prototype
=
{
constructor
:
RootActor
applicationType
:
"
browser
"
traits
:
{
sources
:
true
highlightable
:
true
networkMonitor
:
true
storageInspector
:
true
storageInspectorReadOnly
:
true
conditionalBreakpoints
:
true
debuggerSourceActors
:
true
wasmBinarySource
:
true
bulk
:
true
selectorEditable
:
true
getCssPath
:
true
getXPath
:
true
directorScripts
:
true
noBlackBoxing
:
false
noPrettyPrinting
:
false
memoryActorAllocations
:
true
webConsoleCommands
:
true
get
allowChromeProcess
(
)
{
return
DebuggerServer
.
allowChromeProcess
;
}
profilerDataFilterable
:
true
heapSnapshots
:
true
documentLoadingMarkers
:
true
webExtensionAddonConnect
:
true
}
sayHello
:
function
(
)
{
return
{
from
:
this
.
actorID
applicationType
:
this
.
applicationType
testConnectionPrefix
:
this
.
conn
.
prefix
traits
:
this
.
traits
}
;
}
forwardingCancelled
:
function
(
prefix
)
{
return
{
from
:
this
.
actorID
type
:
"
forwardingCancelled
"
prefix
}
;
}
destroy
:
function
(
)
{
if
(
this
.
_parameters
.
tabList
)
{
this
.
_parameters
.
tabList
.
onListChanged
=
null
;
}
if
(
this
.
_parameters
.
addonList
)
{
this
.
_parameters
.
addonList
.
onListChanged
=
null
;
}
if
(
this
.
_parameters
.
workerList
)
{
this
.
_parameters
.
workerList
.
onListChanged
=
null
;
}
if
(
this
.
_parameters
.
serviceWorkerRegistrationList
)
{
this
.
_parameters
.
serviceWorkerRegistrationList
.
onListChanged
=
null
;
}
if
(
this
.
_parameters
.
processList
)
{
this
.
_parameters
.
processList
.
onListChanged
=
null
;
}
if
(
typeof
this
.
_parameters
.
onShutdown
=
=
=
"
function
"
)
{
this
.
_parameters
.
onShutdown
(
)
;
}
this
.
_extraActors
=
null
;
this
.
conn
=
null
;
this
.
_tabActorPool
=
null
;
this
.
_globalActorPool
=
null
;
this
.
_windowActorPool
=
null
;
this
.
_parameters
=
null
;
this
.
_chromeActor
=
null
;
this
.
_processActors
.
clear
(
)
;
}
onGetRoot
:
function
(
)
{
const
reply
=
{
from
:
this
.
actorID
}
;
if
(
!
this
.
_globalActorPool
)
{
this
.
_globalActorPool
=
new
ActorPool
(
this
.
conn
)
;
this
.
conn
.
addActorPool
(
this
.
_globalActorPool
)
;
}
this
.
_createExtraActors
(
this
.
_parameters
.
globalActorFactories
this
.
_globalActorPool
)
;
this
.
_appendExtraActors
(
reply
)
;
return
reply
;
}
onListTabs
:
async
function
(
request
)
{
const
tabList
=
this
.
_parameters
.
tabList
;
if
(
!
tabList
)
{
return
{
from
:
this
.
actorID
error
:
"
noTabs
"
message
:
"
This
root
actor
has
no
browser
tabs
.
"
}
;
}
tabList
.
onListChanged
=
this
.
_onTabListChanged
;
const
newActorPool
=
new
ActorPool
(
this
.
conn
)
;
const
tabActorList
=
[
]
;
let
selected
;
const
options
=
request
.
options
|
|
{
}
;
const
tabActors
=
await
tabList
.
getList
(
options
)
;
for
(
const
tabActor
of
tabActors
)
{
if
(
tabActor
.
exited
)
{
continue
;
}
if
(
tabActor
.
selected
)
{
selected
=
tabActorList
.
length
;
}
tabActor
.
parentID
=
this
.
actorID
;
newActorPool
.
addActor
(
tabActor
)
;
tabActorList
.
push
(
tabActor
)
;
}
const
reply
=
this
.
onGetRoot
(
)
;
if
(
this
.
_tabActorPool
)
{
this
.
conn
.
removeActorPool
(
this
.
_tabActorPool
)
;
}
this
.
_tabActorPool
=
newActorPool
;
this
.
conn
.
addActorPool
(
this
.
_tabActorPool
)
;
Object
.
assign
(
reply
{
selected
:
selected
|
|
0
tabs
:
tabActorList
.
map
(
actor
=
>
actor
.
form
(
)
)
}
)
;
return
reply
;
}
onGetTab
:
async
function
(
options
)
{
const
tabList
=
this
.
_parameters
.
tabList
;
if
(
!
tabList
)
{
return
{
error
:
"
noTabs
"
message
:
"
This
root
actor
has
no
browser
tabs
.
"
}
;
}
if
(
!
this
.
_tabActorPool
)
{
this
.
_tabActorPool
=
new
ActorPool
(
this
.
conn
)
;
this
.
conn
.
addActorPool
(
this
.
_tabActorPool
)
;
}
let
tabActor
;
try
{
tabActor
=
await
tabList
.
getTab
(
options
)
;
}
catch
(
error
)
{
if
(
error
.
error
)
{
return
error
;
}
return
{
error
:
"
noTab
"
message
:
"
Unexpected
error
while
calling
getTab
(
)
:
"
+
error
}
;
}
tabActor
.
parentID
=
this
.
actorID
;
this
.
_tabActorPool
.
addActor
(
tabActor
)
;
return
{
tab
:
tabActor
.
form
(
)
}
;
}
onGetWindow
:
function
(
{
outerWindowID
}
)
{
if
(
!
DebuggerServer
.
allowChromeProcess
)
{
return
{
from
:
this
.
actorID
error
:
"
forbidden
"
message
:
"
You
are
not
allowed
to
debug
windows
.
"
}
;
}
const
window
=
Services
.
wm
.
getOuterWindowWithId
(
outerWindowID
)
;
if
(
!
window
)
{
return
{
from
:
this
.
actorID
error
:
"
notFound
"
message
:
No
window
found
with
outerWindowID
{
outerWindowID
}
}
;
}
if
(
!
this
.
_windowActorPool
)
{
this
.
_windowActorPool
=
new
ActorPool
(
this
.
conn
)
;
this
.
conn
.
addActorPool
(
this
.
_windowActorPool
)
;
}
const
actor
=
new
WindowActor
(
this
.
conn
window
)
;
actor
.
parentID
=
this
.
actorID
;
this
.
_windowActorPool
.
addActor
(
actor
)
;
return
{
from
:
this
.
actorID
window
:
actor
.
form
(
)
}
;
}
onTabListChanged
:
function
(
)
{
this
.
conn
.
send
(
{
from
:
this
.
actorID
type
:
"
tabListChanged
"
}
)
;
this
.
_parameters
.
tabList
.
onListChanged
=
null
;
}
onListAddons
:
function
(
)
{
const
addonList
=
this
.
_parameters
.
addonList
;
if
(
!
addonList
)
{
return
{
from
:
this
.
actorID
error
:
"
noAddons
"
message
:
"
This
root
actor
has
no
browser
addons
.
"
}
;
}
addonList
.
onListChanged
=
this
.
_onAddonListChanged
;
return
addonList
.
getList
(
)
.
then
(
(
addonActors
)
=
>
{
const
addonActorPool
=
new
ActorPool
(
this
.
conn
)
;
for
(
const
addonActor
of
addonActors
)
{
addonActorPool
.
addActor
(
addonActor
)
;
}
if
(
this
.
_addonActorPool
)
{
this
.
conn
.
removeActorPool
(
this
.
_addonActorPool
)
;
}
this
.
_addonActorPool
=
addonActorPool
;
this
.
conn
.
addActorPool
(
this
.
_addonActorPool
)
;
return
{
"
from
"
:
this
.
actorID
"
addons
"
:
addonActors
.
map
(
addonActor
=
>
addonActor
.
form
(
)
)
}
;
}
)
;
}
onAddonListChanged
:
function
(
)
{
this
.
conn
.
send
(
{
from
:
this
.
actorID
type
:
"
addonListChanged
"
}
)
;
this
.
_parameters
.
addonList
.
onListChanged
=
null
;
}
onListWorkers
:
function
(
)
{
const
workerList
=
this
.
_parameters
.
workerList
;
if
(
!
workerList
)
{
return
{
from
:
this
.
actorID
error
:
"
noWorkers
"
message
:
"
This
root
actor
has
no
workers
.
"
}
;
}
workerList
.
onListChanged
=
this
.
_onWorkerListChanged
;
return
workerList
.
getList
(
)
.
then
(
actors
=
>
{
const
pool
=
new
ActorPool
(
this
.
conn
)
;
for
(
const
actor
of
actors
)
{
pool
.
addActor
(
actor
)
;
}
this
.
conn
.
removeActorPool
(
this
.
_workerActorPool
)
;
this
.
_workerActorPool
=
pool
;
this
.
conn
.
addActorPool
(
this
.
_workerActorPool
)
;
return
{
"
from
"
:
this
.
actorID
"
workers
"
:
actors
.
map
(
actor
=
>
actor
.
form
(
)
)
}
;
}
)
;
}
onWorkerListChanged
:
function
(
)
{
this
.
conn
.
send
(
{
from
:
this
.
actorID
type
:
"
workerListChanged
"
}
)
;
this
.
_parameters
.
workerList
.
onListChanged
=
null
;
}
onListServiceWorkerRegistrations
:
function
(
)
{
const
registrationList
=
this
.
_parameters
.
serviceWorkerRegistrationList
;
if
(
!
registrationList
)
{
return
{
from
:
this
.
actorID
error
:
"
noServiceWorkerRegistrations
"
message
:
"
This
root
actor
has
no
service
worker
registrations
.
"
}
;
}
registrationList
.
onListChanged
=
this
.
_onServiceWorkerRegistrationListChanged
;
return
registrationList
.
getList
(
)
.
then
(
actors
=
>
{
const
pool
=
new
ActorPool
(
this
.
conn
)
;
for
(
const
actor
of
actors
)
{
pool
.
addActor
(
actor
)
;
}
this
.
conn
.
removeActorPool
(
this
.
_serviceWorkerRegistrationActorPool
)
;
this
.
_serviceWorkerRegistrationActorPool
=
pool
;
this
.
conn
.
addActorPool
(
this
.
_serviceWorkerRegistrationActorPool
)
;
return
{
"
from
"
:
this
.
actorID
"
registrations
"
:
actors
.
map
(
actor
=
>
actor
.
form
(
)
)
}
;
}
)
;
}
onServiceWorkerRegistrationListChanged
:
function
(
)
{
this
.
conn
.
send
(
{
from
:
this
.
actorID
type
:
"
serviceWorkerRegistrationListChanged
"
}
)
;
this
.
_parameters
.
serviceWorkerRegistrationList
.
onListChanged
=
null
;
}
onListProcesses
:
function
(
)
{
const
{
processList
}
=
this
.
_parameters
;
if
(
!
processList
)
{
return
{
from
:
this
.
actorID
error
:
"
noProcesses
"
message
:
"
This
root
actor
has
no
processes
.
"
}
;
}
processList
.
onListChanged
=
this
.
_onProcessListChanged
;
return
{
processes
:
processList
.
getList
(
)
}
;
}
onProcessListChanged
:
function
(
)
{
this
.
conn
.
send
(
{
from
:
this
.
actorID
type
:
"
processListChanged
"
}
)
;
this
.
_parameters
.
processList
.
onListChanged
=
null
;
}
async
onGetProcess
(
request
)
{
if
(
!
DebuggerServer
.
allowChromeProcess
)
{
return
{
error
:
"
forbidden
"
message
:
"
You
are
not
allowed
to
debug
chrome
.
"
}
;
}
if
(
(
"
id
"
in
request
)
&
&
typeof
(
request
.
id
)
!
=
"
number
"
)
{
return
{
error
:
"
wrongParameter
"
message
:
"
getProcess
requires
a
valid
id
attribute
.
"
}
;
}
if
(
(
!
(
"
id
"
in
request
)
)
|
|
request
.
id
=
=
=
0
)
{
if
(
this
.
_chromeActor
&
&
(
!
this
.
_chromeActor
.
docShell
|
|
this
.
_chromeActor
.
docShell
.
isBeingDestroyed
)
)
{
this
.
_globalActorPool
.
removeActor
(
this
.
_chromeActor
)
;
this
.
_chromeActor
=
null
;
}
if
(
!
this
.
_chromeActor
)
{
const
{
ChromeActor
}
=
require
(
"
devtools
/
server
/
actors
/
chrome
"
)
;
this
.
_chromeActor
=
new
ChromeActor
(
this
.
conn
)
;
this
.
_globalActorPool
.
addActor
(
this
.
_chromeActor
)
;
}
return
{
form
:
this
.
_chromeActor
.
form
(
)
}
;
}
const
{
id
}
=
request
;
const
mm
=
Services
.
ppmm
.
getChildAt
(
id
)
;
if
(
!
mm
)
{
return
{
error
:
"
noProcess
"
message
:
"
There
is
no
process
with
id
'
"
+
id
+
"
'
.
"
}
;
}
let
form
=
this
.
_processActors
.
get
(
id
)
;
if
(
form
)
{
return
{
form
}
;
}
const
onDestroy
=
(
)
=
>
{
this
.
_processActors
.
delete
(
id
)
;
}
;
form
=
await
DebuggerServer
.
connectToContentProcess
(
this
.
conn
mm
onDestroy
)
;
this
.
_processActors
.
set
(
id
form
)
;
return
{
form
}
;
}
onEcho
:
function
(
request
)
{
return
Cu
.
cloneInto
(
request
{
}
)
;
}
onProtocolDescription
:
function
(
)
{
return
require
(
"
devtools
/
shared
/
protocol
"
)
.
dumpProtocolSpec
(
)
;
}
_createExtraActors
:
createExtraActors
_appendExtraActors
:
appendExtraActors
removeActorByName
:
function
(
name
)
{
if
(
name
in
this
.
_extraActors
)
{
const
actor
=
this
.
_extraActors
[
name
]
;
if
(
this
.
_globalActorPool
.
has
(
actor
)
)
{
this
.
_globalActorPool
.
removeActor
(
actor
)
;
}
if
(
this
.
_tabActorPool
)
{
this
.
_tabActorPool
.
forEach
(
tab
=
>
{
tab
.
removeActorByName
(
name
)
;
}
)
;
}
delete
this
.
_extraActors
[
name
]
;
}
}
}
;
RootActor
.
prototype
.
requestTypes
=
{
getRoot
:
RootActor
.
prototype
.
onGetRoot
listTabs
:
RootActor
.
prototype
.
onListTabs
getTab
:
RootActor
.
prototype
.
onGetTab
getWindow
:
RootActor
.
prototype
.
onGetWindow
listAddons
:
RootActor
.
prototype
.
onListAddons
listWorkers
:
RootActor
.
prototype
.
onListWorkers
listServiceWorkerRegistrations
:
RootActor
.
prototype
.
onListServiceWorkerRegistrations
listProcesses
:
RootActor
.
prototype
.
onListProcesses
getProcess
:
RootActor
.
prototype
.
onGetProcess
echo
:
RootActor
.
prototype
.
onEcho
protocolDescription
:
RootActor
.
prototype
.
onProtocolDescription
}
;
exports
.
RootActor
=
RootActor
;
