"
use
strict
"
;
const
protocol
=
require
(
"
devtools
/
shared
/
protocol
"
)
;
const
{
webExtensionSpec
}
=
require
(
"
devtools
/
shared
/
specs
/
addon
/
webextension
"
)
;
const
{
WebExtensionTargetActorProxy
}
=
require
(
"
devtools
/
server
/
actors
/
targets
/
webextension
-
proxy
"
)
;
loader
.
lazyImporter
(
this
"
AddonManager
"
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
jsm
"
)
;
loader
.
lazyImporter
(
this
"
ExtensionParent
"
"
resource
:
/
/
gre
/
modules
/
ExtensionParent
.
jsm
"
)
;
const
WebExtensionActor
=
protocol
.
ActorClassWithSpec
(
webExtensionSpec
{
initialize
(
conn
addon
)
{
this
.
conn
=
conn
;
this
.
addon
=
addon
;
this
.
addonId
=
addon
.
id
;
this
.
_childFormPromise
=
null
;
AddonManager
.
addAddonListener
(
this
)
;
}
destroy
(
)
{
AddonManager
.
removeAddonListener
(
this
)
;
this
.
addon
=
null
;
this
.
_childFormPromise
=
null
;
if
(
this
.
_destroyProxy
)
{
this
.
_destroyProxy
(
)
;
delete
this
.
_destroyProxy
;
}
}
reload
(
)
{
return
this
.
addon
.
reload
(
)
.
then
(
(
)
=
>
{
return
{
}
;
}
)
;
}
form
(
)
{
const
policy
=
ExtensionParent
.
WebExtensionPolicy
.
getByID
(
this
.
addonId
)
;
return
{
actor
:
this
.
actorID
id
:
this
.
addonId
name
:
this
.
addon
.
name
url
:
this
.
addon
.
sourceURI
?
this
.
addon
.
sourceURI
.
spec
:
undefined
iconDataURL
:
this
.
_iconDataURL
iconURL
:
this
.
addon
.
iconURL
isSystem
:
this
.
addon
.
isSystem
debuggable
:
this
.
addon
.
isDebuggable
temporarilyInstalled
:
this
.
addon
.
temporarilyInstalled
type
:
this
.
addon
.
type
isWebExtension
:
this
.
addon
.
isWebExtension
isAPIExtension
:
this
.
addon
.
isAPIExtension
manifestURL
:
policy
&
&
policy
.
getURL
(
"
manifest
.
json
"
)
warnings
:
ExtensionParent
.
DebugUtils
.
getExtensionManifestWarnings
(
this
.
addonId
)
}
;
}
connect
(
)
{
if
(
this
.
_childFormPormise
)
{
return
this
.
_childFormPromise
;
}
const
proxy
=
new
WebExtensionTargetActorProxy
(
this
.
conn
this
)
;
this
.
_childFormPromise
=
proxy
.
connect
(
)
.
then
(
form
=
>
{
return
Object
.
assign
(
form
{
id
:
this
.
addon
.
id
name
:
this
.
addon
.
name
iconURL
:
this
.
addon
.
iconURL
isOOP
:
proxy
.
isOOP
}
)
;
}
)
;
this
.
_destroyProxy
=
(
)
=
>
proxy
.
destroy
(
)
;
return
this
.
_childFormPromise
;
}
async
loadIconDataURL
(
)
{
this
.
_iconDataURL
=
await
this
.
getIconDataURL
(
)
;
}
async
getIconDataURL
(
)
{
if
(
!
this
.
addon
.
iconURL
)
{
return
null
;
}
const
xhr
=
new
XMLHttpRequest
(
)
;
xhr
.
responseType
=
"
blob
"
;
xhr
.
open
(
"
GET
"
this
.
addon
.
iconURL
true
)
;
if
(
this
.
addon
.
iconURL
.
toLowerCase
(
)
.
endsWith
(
"
.
svg
"
)
)
{
xhr
.
overrideMimeType
(
"
image
/
svg
+
xml
"
)
;
}
try
{
const
blob
=
await
new
Promise
(
(
resolve
reject
)
=
>
{
xhr
.
onload
=
(
)
=
>
resolve
(
xhr
.
response
)
;
xhr
.
onerror
=
reject
;
xhr
.
send
(
)
;
}
)
;
const
reader
=
new
FileReader
(
)
;
return
await
new
Promise
(
(
resolve
reject
)
=
>
{
reader
.
onloadend
=
(
)
=
>
resolve
(
reader
.
result
)
;
reader
.
onerror
=
reject
;
reader
.
readAsDataURL
(
blob
)
;
}
)
;
}
catch
(
_
)
{
console
.
warn
(
Failed
to
create
data
url
from
[
{
this
.
addon
.
iconURL
}
]
)
;
return
null
;
}
}
onProxyDestroy
(
)
{
this
.
_childFormPromise
=
null
;
delete
this
.
_destroyProxy
;
}
onInstalled
(
addon
)
{
if
(
addon
.
id
!
=
this
.
addonId
)
{
return
;
}
this
.
addon
=
addon
;
}
onUninstalled
(
addon
)
{
if
(
addon
!
=
this
.
addon
)
{
return
;
}
this
.
destroy
(
)
;
}
}
)
;
exports
.
WebExtensionActor
=
WebExtensionActor
;
