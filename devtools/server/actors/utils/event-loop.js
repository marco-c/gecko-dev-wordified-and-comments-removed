"
use
strict
"
;
const
xpcInspector
=
require
(
"
xpcInspector
"
)
;
const
DevToolsUtils
=
require
(
"
devtools
/
shared
/
DevToolsUtils
"
)
;
const
{
dumpn
}
=
DevToolsUtils
;
function
EventLoopStack
(
{
thread
connection
hooks
}
)
{
this
.
_hooks
=
hooks
;
this
.
_thread
=
thread
;
this
.
_connection
=
connection
;
}
EventLoopStack
.
prototype
=
{
get
size
(
)
{
return
xpcInspector
.
eventLoopNestLevel
;
}
get
lastPausedUrl
(
)
{
let
url
=
null
;
if
(
this
.
size
>
0
)
{
try
{
url
=
xpcInspector
.
lastNestRequestor
.
url
;
}
catch
(
e
)
{
dumpn
(
e
)
;
}
}
return
url
;
}
get
lastConnection
(
)
{
return
xpcInspector
.
lastNestRequestor
.
_connection
;
}
push
:
function
(
)
{
return
new
EventLoop
(
{
thread
:
this
.
_thread
connection
:
this
.
_connection
hooks
:
this
.
_hooks
}
)
;
}
}
;
function
EventLoop
(
{
thread
connection
hooks
}
)
{
this
.
_thread
=
thread
;
this
.
_hooks
=
hooks
;
this
.
_connection
=
connection
;
this
.
enter
=
this
.
enter
.
bind
(
this
)
;
this
.
resolve
=
this
.
resolve
.
bind
(
this
)
;
}
EventLoop
.
prototype
=
{
entered
:
false
resolved
:
false
get
url
(
)
{
return
this
.
_hooks
.
url
;
}
enter
:
function
(
)
{
const
nestData
=
this
.
_hooks
.
preNest
?
this
.
_hooks
.
preNest
(
)
:
null
;
this
.
entered
=
true
;
xpcInspector
.
enterNestedEventLoop
(
this
)
;
if
(
xpcInspector
.
eventLoopNestLevel
>
0
)
{
const
{
resolved
}
=
xpcInspector
.
lastNestRequestor
;
if
(
resolved
)
{
xpcInspector
.
exitNestedEventLoop
(
)
;
}
}
if
(
this
.
_hooks
.
postNest
)
{
this
.
_hooks
.
postNest
(
nestData
)
;
}
}
resolve
:
function
(
)
{
if
(
!
this
.
entered
)
{
throw
new
Error
(
"
Can
'
t
resolve
an
event
loop
before
it
has
been
entered
!
"
)
;
}
if
(
this
.
resolved
)
{
throw
new
Error
(
"
Already
resolved
this
nested
event
loop
!
"
)
;
}
this
.
resolved
=
true
;
if
(
this
=
=
=
xpcInspector
.
lastNestRequestor
)
{
xpcInspector
.
exitNestedEventLoop
(
)
;
return
true
;
}
return
false
;
}
}
;
exports
.
EventLoopStack
=
EventLoopStack
;
