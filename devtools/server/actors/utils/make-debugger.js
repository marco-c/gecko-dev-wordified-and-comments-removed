"
use
strict
"
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
Debugger
=
require
(
"
Debugger
"
)
;
const
ReplayDebugger
=
require
(
"
.
.
/
replay
/
debugger
"
)
;
const
{
reportException
}
=
require
(
"
devtools
/
shared
/
DevToolsUtils
"
)
;
module
.
exports
=
function
makeDebugger
(
{
findDebuggees
shouldAddNewGlobalAsDebuggee
}
=
{
}
)
{
const
dbg
=
isReplaying
?
new
ReplayDebugger
(
)
:
new
Debugger
(
)
;
EventEmitter
.
decorate
(
dbg
)
;
dbg
.
allowUnobservedAsmJS
=
true
;
dbg
.
uncaughtExceptionHook
=
reportDebuggerHookException
;
function
onNewDebuggee
(
global
)
{
if
(
dbg
.
onNewDebuggee
)
{
dbg
.
onNewDebuggee
(
global
)
;
}
}
const
onNewGlobalObject
=
function
(
global
)
{
if
(
shouldAddNewGlobalAsDebuggee
(
global
)
)
{
safeAddDebuggee
(
this
global
)
;
onNewDebuggee
(
global
)
;
}
}
;
dbg
.
onNewGlobalObject
=
onNewGlobalObject
;
dbg
.
addDebuggees
=
function
(
)
{
for
(
const
global
of
findDebuggees
(
this
)
)
{
safeAddDebuggee
(
this
global
)
;
onNewDebuggee
(
global
)
;
}
}
;
dbg
.
enable
=
(
)
=
>
{
dbg
.
addDebuggees
(
)
;
dbg
.
onNewGlobalObject
=
onNewGlobalObject
;
}
;
dbg
.
disable
=
function
(
)
{
dbg
.
removeAllDebuggees
(
)
;
dbg
.
onNewGlobalObject
=
undefined
;
}
;
return
dbg
;
}
;
const
reportDebuggerHookException
=
e
=
>
reportException
(
"
Debugger
Hook
"
e
)
;
function
safeAddDebuggee
(
dbg
global
)
{
try
{
dbg
.
addDebuggee
(
global
)
;
}
catch
(
e
)
{
}
}
