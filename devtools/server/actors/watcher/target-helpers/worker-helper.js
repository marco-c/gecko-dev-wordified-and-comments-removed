"
use
strict
"
;
const
{
getAllRemoteBrowsingContexts
shouldNotifyWindowGlobal
}
=
require
(
"
devtools
/
server
/
actors
/
watcher
/
target
-
helpers
/
utils
.
js
"
)
;
const
DEVTOOLS_WORKER_JS_WINDOW_ACTOR_NAME
=
"
DevToolsWorker
"
;
async
function
createTargets
(
watcher
)
{
const
browsingContexts
=
getFilteredBrowsingContext
(
watcher
.
browserElement
)
;
const
promises
=
[
]
;
for
(
const
browsingContext
of
browsingContexts
)
{
const
promise
=
browsingContext
.
currentWindowGlobal
.
getActor
(
DEVTOOLS_WORKER_JS_WINDOW_ACTOR_NAME
)
.
instantiateWorkerTargets
(
{
watcherActorID
:
watcher
.
actorID
connectionPrefix
:
watcher
.
conn
.
prefix
sessionContext
:
watcher
.
sessionContext
sessionData
:
watcher
.
sessionData
}
)
;
promises
.
push
(
promise
)
;
}
return
Promise
.
all
(
promises
)
;
}
async
function
destroyTargets
(
watcher
)
{
const
browsingContexts
=
getFilteredBrowsingContext
(
watcher
.
browserElement
)
;
for
(
const
browsingContext
of
browsingContexts
)
{
let
windowActor
;
try
{
windowActor
=
browsingContext
.
currentWindowGlobal
.
getActor
(
DEVTOOLS_WORKER_JS_WINDOW_ACTOR_NAME
)
;
}
catch
(
e
)
{
continue
;
}
windowActor
.
destroyWorkerTargets
(
{
watcherActorID
:
watcher
.
actorID
sessionContext
:
watcher
.
sessionContext
}
)
;
}
}
async
function
addSessionDataEntry
(
{
watcher
type
entries
}
)
{
const
browsingContexts
=
getFilteredBrowsingContext
(
watcher
.
browserElement
)
;
const
promises
=
[
]
;
for
(
const
browsingContext
of
browsingContexts
)
{
const
promise
=
browsingContext
.
currentWindowGlobal
.
getActor
(
DEVTOOLS_WORKER_JS_WINDOW_ACTOR_NAME
)
.
addSessionDataEntry
(
{
watcherActorID
:
watcher
.
actorID
sessionContext
:
watcher
.
sessionContext
type
entries
}
)
;
promises
.
push
(
promise
)
;
}
return
Promise
.
all
(
promises
)
;
}
function
removeSessionDataEntry
(
{
watcher
type
entries
}
)
{
const
browsingContexts
=
getFilteredBrowsingContext
(
watcher
.
browserElement
)
;
for
(
const
browsingContext
of
browsingContexts
)
{
browsingContext
.
currentWindowGlobal
.
getActor
(
DEVTOOLS_WORKER_JS_WINDOW_ACTOR_NAME
)
.
removeSessionDataEntry
(
{
watcherActorID
:
watcher
.
actorID
sessionContext
:
watcher
.
sessionContext
type
entries
}
)
;
}
}
function
getFilteredBrowsingContext
(
browserElement
)
{
const
browsingContexts
=
getAllRemoteBrowsingContexts
(
browserElement
?
.
browsingContext
)
;
if
(
browserElement
?
.
browsingContext
)
{
browsingContexts
.
push
(
browserElement
?
.
browsingContext
)
;
}
return
browsingContexts
.
filter
(
browsingContext
=
>
shouldNotifyWindowGlobal
(
browsingContext
browserElement
?
.
browserId
{
acceptNonRemoteFrame
:
true
}
)
)
;
}
module
.
exports
=
{
createTargets
destroyTargets
addSessionDataEntry
removeSessionDataEntry
}
;
