"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
WatcherRegistry
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
ActorManagerParent
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ActorManagerParent
.
jsm
"
)
;
const
watchedDataByWatcherActor
=
new
Map
(
)
;
const
watcherActors
=
new
Map
(
)
;
const
SHARED_DATA_KEY_NAME
=
"
DevTools
:
watchedPerWatcher
"
;
function
getWatchedData
(
watcher
{
createData
=
false
}
=
{
}
)
{
const
watcherActorID
=
watcher
.
actorID
;
let
watchedData
=
watchedDataByWatcherActor
.
get
(
watcherActorID
)
;
if
(
!
watchedData
&
&
createData
)
{
watchedData
=
{
targets
:
[
]
resources
:
[
]
browserId
:
watcher
.
browserId
connectionPrefix
:
watcher
.
conn
.
prefix
}
;
watchedDataByWatcherActor
.
set
(
watcherActorID
watchedData
)
;
watcherActors
.
set
(
watcherActorID
watcher
)
;
}
return
watchedData
;
}
function
persistMapToSharedData
(
)
{
Services
.
ppmm
.
sharedData
.
set
(
SHARED_DATA_KEY_NAME
watchedDataByWatcherActor
)
;
Services
.
ppmm
.
sharedData
.
flush
(
)
;
}
const
WatcherRegistry
=
{
isWatchingTargets
(
watcher
targetType
)
{
const
watchedData
=
getWatchedData
(
watcher
)
;
return
watchedData
&
&
watchedData
.
targets
.
includes
(
targetType
)
;
}
getWatchedResources
(
watcher
)
{
const
watchedData
=
getWatchedData
(
watcher
)
;
if
(
watchedData
)
{
return
watchedData
.
resources
;
}
return
[
]
;
}
getWatcher
(
actorID
)
{
return
watcherActors
.
get
(
actorID
)
;
}
watchTargets
(
watcher
targetType
)
{
const
watchedData
=
getWatchedData
(
watcher
{
createData
:
true
}
)
;
if
(
watchedData
.
targets
.
includes
(
targetType
)
)
{
throw
new
Error
(
Already
watching
for
'
{
targetType
}
'
targets
for
Watcher
Actor
{
watcher
.
actorID
}
)
;
}
registerJSWindowActor
(
)
;
watchedData
.
targets
.
push
(
targetType
)
;
persistMapToSharedData
(
)
;
}
unwatchTargets
(
watcher
targetType
)
{
const
watchedData
=
getWatchedData
(
watcher
)
;
if
(
!
watchedData
)
{
return
false
;
}
const
idx
=
watchedData
.
targets
.
indexOf
(
targetType
)
;
if
(
idx
=
=
=
-
1
)
{
return
false
;
}
watchedData
.
targets
.
splice
(
idx
1
)
;
if
(
watchedData
.
targets
.
length
=
=
=
0
&
&
watchedData
.
resources
.
length
=
=
=
0
)
{
watchedDataByWatcherActor
.
delete
(
watcher
.
actorID
)
;
watcherActors
.
delete
(
watcher
.
actorID
)
;
}
persistMapToSharedData
(
)
;
return
true
;
}
watchResources
(
watcher
resourceTypes
)
{
const
watchedData
=
getWatchedData
(
watcher
{
createData
:
true
}
)
;
registerJSWindowActor
(
)
;
for
(
const
resourceType
of
resourceTypes
)
{
if
(
watchedData
.
resources
.
includes
(
resourceType
)
)
{
throw
new
Error
(
Already
watching
for
'
{
resourceType
}
'
resource
for
Watcher
Actor
{
watcher
.
actorID
}
)
;
}
}
for
(
const
resourceType
of
resourceTypes
)
{
watchedData
.
resources
.
push
(
resourceType
)
;
}
persistMapToSharedData
(
)
;
}
unwatchResources
(
watcher
resourceTypes
)
{
const
watchedData
=
getWatchedData
(
watcher
)
;
if
(
!
watchedData
)
{
return
false
;
}
let
atLeastOneWasRegistered
=
false
;
for
(
const
resourceType
of
resourceTypes
)
{
const
idx
=
watchedData
.
resources
.
indexOf
(
resourceType
)
;
if
(
idx
!
=
=
-
1
)
{
watchedData
.
resources
.
splice
(
idx
1
)
;
atLeastOneWasRegistered
=
true
;
}
}
if
(
!
atLeastOneWasRegistered
)
{
return
false
;
}
if
(
watchedData
.
targets
.
length
=
=
=
0
&
&
watchedData
.
resources
.
length
=
=
=
0
)
{
watchedDataByWatcherActor
.
delete
(
watcher
.
actorID
)
;
watcherActors
.
delete
(
watcher
.
actorID
)
;
}
persistMapToSharedData
(
)
;
return
true
;
}
maybeUnregisteringJSWindowActor
(
)
{
if
(
watchedDataByWatcherActor
.
size
=
=
0
)
{
unregisterJSWindowActor
(
)
;
}
}
}
;
let
isJSWindowActorRegistered
=
false
;
function
registerJSWindowActor
(
)
{
if
(
isJSWindowActorRegistered
)
{
return
;
}
isJSWindowActorRegistered
=
true
;
ActorManagerParent
.
addJSWindowActors
(
{
DevToolsFrame
:
{
parent
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsFrameParent
.
jsm
"
}
child
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsFrameChild
.
jsm
"
events
:
{
DOMWindowCreated
:
{
}
}
}
allFrames
:
true
}
}
)
;
ActorManagerParent
.
flush
(
)
;
}
function
unregisterJSWindowActor
(
)
{
if
(
!
isJSWindowActorRegistered
)
{
return
;
}
isJSWindowActorRegistered
=
false
;
ChromeUtils
.
unregisterWindowActor
(
"
DevToolsFrame
"
)
;
}
