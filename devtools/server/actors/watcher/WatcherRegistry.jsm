"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
WatcherRegistry
"
]
;
const
{
ActorManagerParent
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ActorManagerParent
.
jsm
"
)
;
const
{
SessionDataHelpers
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
server
/
actors
/
watcher
/
SessionDataHelpers
.
jsm
"
)
;
const
{
SUPPORTED_DATA
}
=
SessionDataHelpers
;
const
SUPPORTED_DATA_TYPES
=
Object
.
values
(
SUPPORTED_DATA
)
;
const
sessionDataByWatcherActor
=
new
Map
(
)
;
const
watcherActors
=
new
Map
(
)
;
const
SHARED_DATA_KEY_NAME
=
"
DevTools
:
watchedPerWatcher
"
;
function
persistMapToSharedData
(
)
{
Services
.
ppmm
.
sharedData
.
set
(
SHARED_DATA_KEY_NAME
sessionDataByWatcherActor
)
;
Services
.
ppmm
.
sharedData
.
flush
(
)
;
}
const
WatcherRegistry
=
{
isWatchingTargets
(
watcher
targetType
)
{
const
sessionData
=
this
.
getSessionData
(
watcher
)
;
return
!
!
sessionData
?
.
targets
?
.
includes
(
targetType
)
;
}
getSessionData
(
watcher
{
createData
=
false
}
=
{
}
)
{
const
watcherActorID
=
watcher
.
actorID
;
let
sessionData
=
sessionDataByWatcherActor
.
get
(
watcherActorID
)
;
if
(
!
sessionData
&
&
createData
)
{
sessionData
=
{
sessionContext
:
watcher
.
sessionContext
connectionPrefix
:
watcher
.
conn
.
prefix
}
;
sessionDataByWatcherActor
.
set
(
watcherActorID
sessionData
)
;
watcherActors
.
set
(
watcherActorID
watcher
)
;
}
return
sessionData
;
}
getWatcher
(
actorID
)
{
return
watcherActors
.
get
(
actorID
)
;
}
getWatchersForBrowserId
(
browserId
)
{
const
watchers
=
[
]
;
for
(
const
watcherActor
of
watcherActors
.
values
(
)
)
{
if
(
watcherActor
.
sessionContext
.
type
=
=
"
browser
-
element
"
&
&
watcherActor
.
sessionContext
.
browserId
=
=
=
browserId
)
{
watchers
.
push
(
watcherActor
)
;
}
}
return
watchers
;
}
addSessionDataEntry
(
watcher
type
entries
)
{
const
sessionData
=
this
.
getSessionData
(
watcher
{
createData
:
true
}
)
;
if
(
!
SUPPORTED_DATA_TYPES
.
includes
(
type
)
)
{
throw
new
Error
(
Unsupported
session
data
type
:
{
type
}
)
;
}
SessionDataHelpers
.
addSessionDataEntry
(
sessionData
type
entries
)
;
registerJSWindowActor
(
)
;
persistMapToSharedData
(
)
;
}
removeSessionDataEntry
(
watcher
type
entries
options
)
{
const
sessionData
=
this
.
getSessionData
(
watcher
)
;
if
(
!
sessionData
)
{
return
false
;
}
if
(
!
SUPPORTED_DATA_TYPES
.
includes
(
type
)
)
{
throw
new
Error
(
Unsupported
session
data
type
:
{
type
}
)
;
}
if
(
!
SessionDataHelpers
.
removeSessionDataEntry
(
sessionData
type
entries
)
)
{
return
false
;
}
const
isWatchingSomething
=
SUPPORTED_DATA_TYPES
.
some
(
dataType
=
>
sessionData
[
dataType
]
&
&
!
!
sessionData
[
dataType
]
.
length
)
;
if
(
!
isWatchingSomething
&
&
!
options
?
.
isModeSwitching
)
{
sessionDataByWatcherActor
.
delete
(
watcher
.
actorID
)
;
watcherActors
.
delete
(
watcher
.
actorID
)
;
}
persistMapToSharedData
(
)
;
return
true
;
}
unregisterWatcher
(
watcher
)
{
sessionDataByWatcherActor
.
delete
(
watcher
.
actorID
)
;
watcherActors
.
delete
(
watcher
.
actorID
)
;
this
.
maybeUnregisteringJSWindowActor
(
)
;
}
watchTargets
(
watcher
targetType
)
{
this
.
addSessionDataEntry
(
watcher
SUPPORTED_DATA
.
TARGETS
[
targetType
]
)
;
}
unwatchTargets
(
watcher
targetType
options
)
{
return
this
.
removeSessionDataEntry
(
watcher
SUPPORTED_DATA
.
TARGETS
[
targetType
]
options
)
;
}
watchResources
(
watcher
resourceTypes
)
{
this
.
addSessionDataEntry
(
watcher
SUPPORTED_DATA
.
RESOURCES
resourceTypes
)
;
}
unwatchResources
(
watcher
resourceTypes
)
{
return
this
.
removeSessionDataEntry
(
watcher
SUPPORTED_DATA
.
RESOURCES
resourceTypes
)
;
}
maybeUnregisteringJSWindowActor
(
)
{
if
(
sessionDataByWatcherActor
.
size
=
=
0
)
{
unregisterJSWindowActor
(
)
;
}
}
}
;
let
isJSWindowActorRegistered
=
false
;
const
JSWindowActorsConfig
=
{
DevToolsFrame
:
{
parent
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsFrameParent
.
jsm
"
}
child
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsFrameChild
.
jsm
"
events
:
{
DOMWindowCreated
:
{
}
DOMDocElementInserted
:
{
}
pageshow
:
{
}
pagehide
:
{
}
}
}
allFrames
:
true
}
DevToolsWorker
:
{
parent
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsWorkerParent
.
jsm
"
}
child
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsWorkerChild
.
jsm
"
events
:
{
DOMWindowCreated
:
{
}
}
}
allFrames
:
true
}
}
;
function
registerJSWindowActor
(
)
{
if
(
isJSWindowActorRegistered
)
{
return
;
}
isJSWindowActorRegistered
=
true
;
ActorManagerParent
.
addJSWindowActors
(
JSWindowActorsConfig
)
;
}
function
unregisterJSWindowActor
(
)
{
if
(
!
isJSWindowActorRegistered
)
{
return
;
}
isJSWindowActorRegistered
=
false
;
for
(
const
JSWindowActorName
of
Object
.
keys
(
JSWindowActorsConfig
)
)
{
ChromeUtils
.
unregisterWindowActor
(
JSWindowActorName
)
;
}
}
