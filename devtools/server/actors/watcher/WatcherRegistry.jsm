"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
WatcherRegistry
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
ActorManagerParent
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ActorManagerParent
.
jsm
"
)
;
const
{
WatchedDataHelpers
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
server
/
actors
/
watcher
/
WatchedDataHelpers
.
jsm
"
)
;
const
{
SUPPORTED_DATA
}
=
WatchedDataHelpers
;
const
watchedDataByWatcherActor
=
new
Map
(
)
;
const
watcherActors
=
new
Map
(
)
;
const
SHARED_DATA_KEY_NAME
=
"
DevTools
:
watchedPerWatcher
"
;
function
persistMapToSharedData
(
)
{
Services
.
ppmm
.
sharedData
.
set
(
SHARED_DATA_KEY_NAME
watchedDataByWatcherActor
)
;
Services
.
ppmm
.
sharedData
.
flush
(
)
;
}
const
WatcherRegistry
=
{
isWatchingTargets
(
watcher
targetType
)
{
const
watchedData
=
this
.
getWatchedData
(
watcher
)
;
return
watchedData
&
&
watchedData
.
targets
.
includes
(
targetType
)
;
}
getWatchedData
(
watcher
{
createData
=
false
}
=
{
}
)
{
const
watcherActorID
=
watcher
.
actorID
;
let
watchedData
=
watchedDataByWatcherActor
.
get
(
watcherActorID
)
;
if
(
!
watchedData
&
&
createData
)
{
watchedData
=
{
browserId
:
watcher
.
browserId
connectionPrefix
:
watcher
.
conn
.
prefix
watcherTraits
:
watcher
.
form
(
)
.
traits
isServerTargetSwitchingEnabled
:
watcher
.
isServerTargetSwitchingEnabled
}
;
for
(
const
name
of
Object
.
values
(
SUPPORTED_DATA
)
)
{
watchedData
[
name
]
=
[
]
;
}
watchedDataByWatcherActor
.
set
(
watcherActorID
watchedData
)
;
watcherActors
.
set
(
watcherActorID
watcher
)
;
}
return
watchedData
;
}
getWatcher
(
actorID
)
{
return
watcherActors
.
get
(
actorID
)
;
}
getWatchersForBrowserId
(
browserId
)
{
const
watchers
=
[
]
;
for
(
const
watcherActor
of
watcherActors
.
values
(
)
)
{
if
(
watcherActor
.
browserId
=
=
=
browserId
)
{
watchers
.
push
(
watcherActor
)
;
}
}
return
watchers
;
}
addWatcherDataEntry
(
watcher
type
entries
)
{
const
watchedData
=
this
.
getWatchedData
(
watcher
{
createData
:
true
}
)
;
if
(
!
(
type
in
watchedData
)
)
{
throw
new
Error
(
Unsupported
watcher
data
type
:
{
type
}
)
;
}
WatchedDataHelpers
.
addWatchedDataEntry
(
watchedData
type
entries
)
;
registerJSWindowActor
(
)
;
persistMapToSharedData
(
)
;
}
removeWatcherDataEntry
(
watcher
type
entries
)
{
const
watchedData
=
this
.
getWatchedData
(
watcher
)
;
if
(
!
watchedData
)
{
return
false
;
}
if
(
!
(
type
in
watchedData
)
)
{
throw
new
Error
(
Unsupported
watcher
data
type
:
{
type
}
)
;
}
if
(
!
WatchedDataHelpers
.
removeWatchedDataEntry
(
watchedData
type
entries
)
)
{
return
false
;
}
const
isWatchingSomething
=
Object
.
values
(
SUPPORTED_DATA
)
.
some
(
dataType
=
>
watchedData
[
dataType
]
.
length
>
0
)
;
if
(
!
isWatchingSomething
)
{
watchedDataByWatcherActor
.
delete
(
watcher
.
actorID
)
;
watcherActors
.
delete
(
watcher
.
actorID
)
;
}
persistMapToSharedData
(
)
;
return
true
;
}
unregisterWatcher
(
watcher
)
{
watchedDataByWatcherActor
.
delete
(
watcher
.
actorID
)
;
watcherActors
.
delete
(
watcher
.
actorID
)
;
this
.
maybeUnregisteringJSWindowActor
(
)
;
}
watchTargets
(
watcher
targetType
)
{
this
.
addWatcherDataEntry
(
watcher
SUPPORTED_DATA
.
TARGETS
[
targetType
]
)
;
}
unwatchTargets
(
watcher
targetType
)
{
return
this
.
removeWatcherDataEntry
(
watcher
SUPPORTED_DATA
.
TARGETS
[
targetType
]
)
;
}
watchResources
(
watcher
resourceTypes
)
{
this
.
addWatcherDataEntry
(
watcher
SUPPORTED_DATA
.
RESOURCES
resourceTypes
)
;
}
unwatchResources
(
watcher
resourceTypes
)
{
return
this
.
removeWatcherDataEntry
(
watcher
SUPPORTED_DATA
.
RESOURCES
resourceTypes
)
;
}
maybeUnregisteringJSWindowActor
(
)
{
if
(
watchedDataByWatcherActor
.
size
=
=
0
)
{
unregisterJSWindowActor
(
)
;
}
}
}
;
let
isJSWindowActorRegistered
=
false
;
const
JSWindowActorsConfig
=
{
DevToolsFrame
:
{
parent
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsFrameParent
.
jsm
"
}
child
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsFrameChild
.
jsm
"
events
:
{
DOMWindowCreated
:
{
}
pageshow
:
{
}
pagehide
:
{
}
}
}
allFrames
:
true
}
DevToolsWorker
:
{
parent
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsWorkerParent
.
jsm
"
}
child
:
{
moduleURI
:
"
resource
:
/
/
devtools
/
server
/
connectors
/
js
-
window
-
actor
/
DevToolsWorkerChild
.
jsm
"
events
:
{
DOMWindowCreated
:
{
}
}
}
allFrames
:
true
}
}
;
function
registerJSWindowActor
(
)
{
if
(
isJSWindowActorRegistered
)
{
return
;
}
isJSWindowActorRegistered
=
true
;
ActorManagerParent
.
addJSWindowActors
(
JSWindowActorsConfig
)
;
}
function
unregisterJSWindowActor
(
)
{
if
(
!
isJSWindowActorRegistered
)
{
return
;
}
isJSWindowActorRegistered
=
false
;
for
(
const
JSWindowActorName
of
Object
.
keys
(
JSWindowActorsConfig
)
)
{
ChromeUtils
.
unregisterWindowActor
(
JSWindowActorName
)
;
}
}
