"
use
strict
"
;
const
Cu
=
Components
.
utils
;
const
Ci
=
Components
.
interfaces
;
const
{
Services
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
{
}
)
;
const
{
XPCOMUtils
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
{
}
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
cpmm
"
"
mozilla
.
org
/
childprocessmessagemanager
;
1
"
"
nsIMessageSender
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
E10SUtils
"
"
resource
:
/
/
gre
/
modules
/
E10SUtils
.
jsm
"
)
;
const
MSG_MGR_CONSOLE_MAX_SIZE
=
1024
*
1024
;
const
MSG_MGR_CONSOLE_VAR_SIZE
=
8
;
const
MSG_MGR_CONSOLE_INFO_MAX
=
1024
;
function
ContentProcessForward
(
)
{
Services
.
obs
.
addObserver
(
this
"
console
-
api
-
log
-
event
"
)
;
Services
.
obs
.
addObserver
(
this
"
xpcom
-
shutdown
"
)
;
cpmm
.
addMessageListener
(
"
DevTools
:
StopForwardingContentProcessMessage
"
this
)
;
}
ContentProcessForward
.
prototype
=
{
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsIObserver
Ci
.
nsISupportsWeakReference
]
)
receiveMessage
(
message
)
{
if
(
message
.
name
=
=
"
DevTools
:
StopForwardingContentProcessMessage
"
)
{
this
.
uninit
(
)
;
}
}
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
console
-
api
-
log
-
event
"
:
{
let
consoleMsg
=
subject
.
wrappedJSObject
;
let
msgData
=
{
level
:
consoleMsg
.
level
filename
:
consoleMsg
.
filename
.
substring
(
0
MSG_MGR_CONSOLE_INFO_MAX
)
lineNumber
:
consoleMsg
.
lineNumber
functionName
:
consoleMsg
.
functionName
&
&
consoleMsg
.
functionName
.
substring
(
0
MSG_MGR_CONSOLE_INFO_MAX
)
timeStamp
:
consoleMsg
.
timeStamp
addonId
:
consoleMsg
.
addonId
arguments
:
[
]
}
;
let
unavailString
=
"
<
unavailable
>
"
;
let
unavailStringLength
=
unavailString
.
length
*
2
;
let
totalArgLength
=
0
;
for
(
let
arg
of
consoleMsg
.
arguments
)
{
if
(
(
typeof
arg
=
=
"
object
"
|
|
typeof
arg
=
=
"
function
"
)
&
&
arg
!
=
=
null
)
{
if
(
Services
.
appinfo
.
remoteType
=
=
=
E10SUtils
.
EXTENSION_REMOTE_TYPE
)
{
try
{
arg
=
Cu
.
cloneInto
(
arg
{
}
)
;
}
catch
(
e
)
{
arg
=
unavailString
;
}
}
else
{
arg
=
unavailString
;
}
totalArgLength
+
=
unavailStringLength
;
}
else
if
(
typeof
arg
=
=
"
string
"
)
{
totalArgLength
+
=
arg
.
length
*
2
;
}
else
{
totalArgLength
+
=
MSG_MGR_CONSOLE_VAR_SIZE
;
}
if
(
totalArgLength
<
=
MSG_MGR_CONSOLE_MAX_SIZE
)
{
msgData
.
arguments
.
push
(
arg
)
;
}
else
{
msgData
.
arguments
=
[
"
<
truncated
>
"
]
;
break
;
}
}
cpmm
.
sendAsyncMessage
(
"
Console
:
Log
"
msgData
)
;
break
;
}
case
"
xpcom
-
shutdown
"
:
this
.
uninit
(
)
;
break
;
}
}
uninit
(
)
{
Services
.
obs
.
removeObserver
(
this
"
console
-
api
-
log
-
event
"
)
;
Services
.
obs
.
removeObserver
(
this
"
xpcom
-
shutdown
"
)
;
cpmm
.
removeMessageListener
(
"
DevTools
:
StopForwardingContentProcessMessage
"
this
)
;
}
}
;
if
(
Services
.
appinfo
.
processType
=
=
Services
.
appinfo
.
PROCESS_TYPE_CONTENT
)
{
new
ContentProcessForward
(
)
;
}
