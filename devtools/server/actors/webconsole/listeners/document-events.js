"
use
strict
"
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
const
WILL_NAVIGATE_TIME_SHIFT
=
5
;
exports
.
WILL_NAVIGATE_TIME_SHIFT
=
WILL_NAVIGATE_TIME_SHIFT
;
function
DocumentEventsListener
(
targetActor
)
{
this
.
targetActor
=
targetActor
;
EventEmitter
.
decorate
(
this
)
;
this
.
onWillNavigate
=
this
.
onWillNavigate
.
bind
(
this
)
;
this
.
onWindowReady
=
this
.
onWindowReady
.
bind
(
this
)
;
this
.
onContentLoaded
=
this
.
onContentLoaded
.
bind
(
this
)
;
this
.
onLoad
=
this
.
onLoad
.
bind
(
this
)
;
}
exports
.
DocumentEventsListener
=
DocumentEventsListener
;
DocumentEventsListener
.
prototype
=
{
listen
(
)
{
EventEmitter
.
on
(
this
.
targetActor
"
will
-
navigate
"
this
.
onWillNavigate
)
;
EventEmitter
.
on
(
this
.
targetActor
"
window
-
ready
"
this
.
onWindowReady
)
;
if
(
!
this
.
targetActor
.
attached
)
{
this
.
targetActor
.
attach
(
)
;
}
else
{
this
.
onWindowReady
(
{
window
:
this
.
targetActor
.
window
isTopLevel
:
true
shouldBeIgnoredAsRedundantWithTargetAvailable
:
true
}
)
;
}
}
onWillNavigate
(
{
window
isTopLevel
newURI
navigationStart
}
)
{
if
(
!
isTopLevel
)
{
return
;
}
this
.
emit
(
"
will
-
navigate
"
{
time
:
navigationStart
-
WILL_NAVIGATE_TIME_SHIFT
newURI
}
)
;
}
onWindowReady
(
{
window
isTopLevel
shouldBeIgnoredAsRedundantWithTargetAvailable
isFrameSwitching
}
)
{
if
(
!
isTopLevel
)
{
return
;
}
const
time
=
window
.
performance
.
timing
.
navigationStart
;
shouldBeIgnoredAsRedundantWithTargetAvailable
=
shouldBeIgnoredAsRedundantWithTargetAvailable
|
|
(
this
.
targetActor
.
isTopLevelTarget
&
&
this
.
targetActor
.
followWindowGlobalLifeCycle
)
;
this
.
emit
(
"
dom
-
loading
"
{
time
shouldBeIgnoredAsRedundantWithTargetAvailable
isFrameSwitching
}
)
;
const
{
readyState
}
=
window
.
document
;
if
(
readyState
!
=
"
interactive
"
&
&
readyState
!
=
"
complete
"
)
{
window
.
addEventListener
(
"
DOMContentLoaded
"
e
=
>
this
.
onContentLoaded
(
e
isFrameSwitching
)
{
once
:
true
}
)
;
}
else
{
this
.
onContentLoaded
(
{
target
:
window
.
document
}
isFrameSwitching
)
;
}
if
(
readyState
!
=
"
complete
"
)
{
window
.
addEventListener
(
"
load
"
e
=
>
this
.
onLoad
(
e
isFrameSwitching
)
{
once
:
true
}
)
;
}
else
{
this
.
onLoad
(
{
target
:
window
.
document
}
isFrameSwitching
)
;
}
}
onContentLoaded
(
event
isFrameSwitching
)
{
const
window
=
event
.
target
.
defaultView
;
const
time
=
window
.
performance
.
timing
.
domInteractive
;
this
.
emit
(
"
dom
-
interactive
"
{
time
isFrameSwitching
}
)
;
}
onLoad
(
event
isFrameSwitching
)
{
const
window
=
event
.
target
.
defaultView
;
const
time
=
window
.
performance
.
timing
.
domComplete
;
this
.
emit
(
"
dom
-
complete
"
{
time
isFrameSwitching
}
)
;
}
destroy
(
)
{
this
.
listener
=
null
;
}
}
;
