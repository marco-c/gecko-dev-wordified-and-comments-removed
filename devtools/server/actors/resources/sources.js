"
use
strict
"
;
const
{
TYPES
:
{
SOURCE
}
}
=
require
(
"
resource
:
/
/
devtools
/
server
/
actors
/
resources
/
index
.
js
"
)
;
const
Targets
=
require
(
"
resource
:
/
/
devtools
/
server
/
actors
/
targets
/
index
.
js
"
)
;
const
{
STATES
:
THREAD_STATES
}
=
require
(
"
resource
:
/
/
devtools
/
server
/
actors
/
thread
.
js
"
)
;
class
SourceWatcher
{
constructor
(
)
{
this
.
onNewSource
=
this
.
onNewSource
.
bind
(
this
)
;
}
async
watch
(
targetActor
{
onAvailable
}
)
{
if
(
targetActor
.
sessionContext
.
type
=
=
"
all
"
&
&
targetActor
.
targetType
=
=
=
Targets
.
TYPES
.
FRAME
&
&
targetActor
.
typeName
!
=
"
parentProcessTarget
"
)
{
return
;
}
const
{
threadActor
}
=
targetActor
;
this
.
sourcesManager
=
targetActor
.
sourcesManager
;
this
.
onAvailable
=
onAvailable
;
threadActor
.
disableNewSourceEvents
(
)
;
threadActor
.
sourcesManager
.
on
(
"
newSource
"
this
.
onNewSource
)
;
const
isTargetCreation
=
threadActor
.
state
=
=
THREAD_STATES
.
DETACHED
;
if
(
isTargetCreation
&
&
!
targetActor
.
targetType
.
endsWith
(
"
worker
"
)
)
{
await
threadActor
.
attach
(
{
}
)
;
}
onAvailable
(
threadActor
.
sourcesManager
.
iter
(
)
.
map
(
s
=
>
{
const
resource
=
s
.
form
(
)
;
resource
.
resourceType
=
SOURCE
;
return
resource
;
}
)
)
;
threadActor
.
addAllSources
(
)
;
}
destroy
(
)
{
if
(
this
.
sourcesManager
)
{
this
.
sourcesManager
.
off
(
"
newSource
"
this
.
onNewSource
)
;
}
}
onNewSource
(
source
)
{
const
resource
=
source
.
form
(
)
;
resource
.
resourceType
=
SOURCE
;
this
.
onAvailable
(
[
resource
]
)
;
}
}
module
.
exports
=
SourceWatcher
;
