"
use
strict
"
;
const
Targets
=
require
(
"
resource
:
/
/
devtools
/
server
/
actors
/
targets
/
index
.
js
"
)
;
const
{
STATES
:
THREAD_STATES
}
=
require
(
"
resource
:
/
/
devtools
/
server
/
actors
/
thread
.
js
"
)
;
class
SourceWatcher
{
constructor
(
)
{
this
.
onNewSource
=
this
.
onNewSource
.
bind
(
this
)
;
}
async
watch
(
targetActor
{
onAvailable
}
)
{
if
(
targetActor
.
sessionContext
.
type
=
=
"
all
"
&
&
targetActor
.
targetType
=
=
=
Targets
.
TYPES
.
FRAME
&
&
targetActor
.
typeName
!
=
"
parentProcessTarget
"
)
{
return
;
}
const
{
threadActor
}
=
targetActor
;
this
.
sourcesManager
=
targetActor
.
sourcesManager
;
this
.
onAvailable
=
onAvailable
;
threadActor
.
attach
(
{
}
)
;
threadActor
.
disableNewSourceEvents
(
)
;
threadActor
.
sourcesManager
.
on
(
"
newSource
"
this
.
onNewSource
)
;
const
isTargetCreation
=
threadActor
.
state
=
=
THREAD_STATES
.
DETACHED
;
const
{
targetType
}
=
targetActor
;
if
(
isTargetCreation
&
&
targetType
!
=
Targets
.
TYPES
.
WORKER
&
&
targetType
!
=
Targets
.
TYPES
.
SHARED_WORKER
)
{
await
threadActor
.
attach
(
{
}
)
;
}
const
sources
=
[
]
;
for
(
const
sourceActor
of
threadActor
.
sourcesManager
.
iter
(
)
)
{
const
resource
=
sourceActor
.
form
(
)
;
sources
.
push
(
resource
)
;
}
onAvailable
(
sources
)
;
threadActor
.
addAllSources
(
)
;
}
destroy
(
)
{
if
(
this
.
sourcesManager
)
{
this
.
sourcesManager
.
off
(
"
newSource
"
this
.
onNewSource
)
;
}
}
onNewSource
(
source
)
{
const
resource
=
source
.
form
(
)
;
this
.
onAvailable
(
[
resource
]
)
;
}
}
module
.
exports
=
SourceWatcher
;
