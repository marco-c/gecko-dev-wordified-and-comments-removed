"
use
strict
"
;
const
Targets
=
require
(
"
resource
:
/
/
devtools
/
server
/
actors
/
targets
/
index
.
js
"
)
;
const
TYPES
=
{
CONSOLE_MESSAGE
:
"
console
-
message
"
CSS_CHANGE
:
"
css
-
change
"
CSS_MESSAGE
:
"
css
-
message
"
CSS_REGISTERED_PROPERTIES
:
"
css
-
registered
-
properties
"
DOCUMENT_EVENT
:
"
document
-
event
"
ERROR_MESSAGE
:
"
error
-
message
"
LAST_PRIVATE_CONTEXT_EXIT
:
"
last
-
private
-
context
-
exit
"
NETWORK_EVENT
:
"
network
-
event
"
NETWORK_EVENT_STACKTRACE
:
"
network
-
event
-
stacktrace
"
PLATFORM_MESSAGE
:
"
platform
-
message
"
REFLOW
:
"
reflow
"
SERVER_SENT_EVENT
:
"
server
-
sent
-
event
"
SOURCE
:
"
source
"
STYLESHEET
:
"
stylesheet
"
THREAD_STATE
:
"
thread
-
state
"
JSTRACER_TRACE
:
"
jstracer
-
trace
"
JSTRACER_STATE
:
"
jstracer
-
state
"
WEBSOCKET
:
"
websocket
"
CACHE_STORAGE
:
"
Cache
"
COOKIE
:
"
cookies
"
EXTENSION_STORAGE
:
"
extension
-
storage
"
INDEXED_DB
:
"
indexed
-
db
"
LOCAL_STORAGE
:
"
local
-
storage
"
SESSION_STORAGE
:
"
session
-
storage
"
EXTENSIONS_BGSCRIPT_STATUS
:
"
extensions
-
backgroundscript
-
status
"
}
;
exports
.
TYPES
=
TYPES
;
const
FrameTargetResources
=
augmentResourceDictionary
(
{
[
TYPES
.
CACHE_STORAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
storage
-
cache
"
}
[
TYPES
.
CONSOLE_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
console
-
messages
"
}
[
TYPES
.
CSS_CHANGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
css
-
changes
"
}
[
TYPES
.
CSS_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
css
-
messages
"
}
[
TYPES
.
CSS_REGISTERED_PROPERTIES
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
css
-
registered
-
properties
"
}
[
TYPES
.
DOCUMENT_EVENT
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
document
-
event
"
}
[
TYPES
.
ERROR_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
error
-
messages
"
}
[
TYPES
.
JSTRACER_STATE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
jstracer
-
state
"
}
[
TYPES
.
JSTRACER_TRACE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
jstracer
-
trace
"
}
[
TYPES
.
LOCAL_STORAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
storage
-
local
-
storage
"
}
[
TYPES
.
PLATFORM_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
platform
-
messages
"
}
[
TYPES
.
SESSION_STORAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
storage
-
session
-
storage
"
}
[
TYPES
.
STYLESHEET
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
stylesheets
"
}
[
TYPES
.
NETWORK_EVENT
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
network
-
events
-
content
"
}
[
TYPES
.
NETWORK_EVENT_STACKTRACE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
network
-
events
-
stacktraces
"
}
[
TYPES
.
REFLOW
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
reflow
"
}
[
TYPES
.
SOURCE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
sources
"
}
[
TYPES
.
THREAD_STATE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
thread
-
states
"
}
[
TYPES
.
SERVER_SENT_EVENT
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
server
-
sent
-
events
"
}
[
TYPES
.
WEBSOCKET
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
websockets
"
}
}
)
;
const
ProcessTargetResources
=
augmentResourceDictionary
(
{
[
TYPES
.
CONSOLE_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
console
-
messages
"
}
[
TYPES
.
JSTRACER_TRACE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
jstracer
-
trace
"
}
[
TYPES
.
JSTRACER_STATE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
jstracer
-
state
"
}
[
TYPES
.
ERROR_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
error
-
messages
"
}
[
TYPES
.
PLATFORM_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
platform
-
messages
"
}
[
TYPES
.
SOURCE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
sources
"
}
[
TYPES
.
THREAD_STATE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
thread
-
states
"
}
}
)
;
const
WorkerTargetResources
=
augmentResourceDictionary
(
{
[
TYPES
.
CONSOLE_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
console
-
messages
"
}
[
TYPES
.
JSTRACER_TRACE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
jstracer
-
trace
"
}
[
TYPES
.
JSTRACER_STATE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
jstracer
-
state
"
}
[
TYPES
.
SOURCE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
sources
"
}
[
TYPES
.
THREAD_STATE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
thread
-
states
"
}
}
)
;
const
ParentProcessResources
=
augmentResourceDictionary
(
{
[
TYPES
.
NETWORK_EVENT
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
network
-
events
"
}
[
TYPES
.
COOKIE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
storage
-
cookie
"
}
[
TYPES
.
EXTENSION_STORAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
storage
-
extension
"
}
[
TYPES
.
INDEXED_DB
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
storage
-
indexed
-
db
"
}
[
TYPES
.
DOCUMENT_EVENT
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
parent
-
process
-
document
-
event
"
}
[
TYPES
.
LAST_PRIVATE_CONTEXT_EXIT
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
last
-
private
-
context
-
exit
"
}
}
)
;
const
RootResources
=
augmentResourceDictionary
(
{
[
TYPES
.
EXTENSIONS_BGSCRIPT_STATUS
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
extensions
-
backgroundscript
-
status
"
}
}
)
;
exports
.
RootResources
=
RootResources
;
function
augmentResourceDictionary
(
dict
)
{
for
(
const
resource
of
Object
.
values
(
dict
)
)
{
resource
.
watchers
=
new
WeakMap
(
)
;
loader
.
lazyRequireGetter
(
resource
"
WatcherClass
"
resource
.
path
)
;
}
return
dict
;
}
function
getResourceTypeDictionary
(
rootOrWatcherOrTargetActor
)
{
const
{
typeName
}
=
rootOrWatcherOrTargetActor
;
if
(
typeName
=
=
"
root
"
)
{
return
RootResources
;
}
if
(
typeName
=
=
"
watcher
"
)
{
return
ParentProcessResources
;
}
const
{
targetType
}
=
rootOrWatcherOrTargetActor
;
return
getResourceTypeDictionaryForTargetType
(
targetType
)
;
}
function
getResourceTypeDictionaryForTargetType
(
targetType
)
{
switch
(
targetType
)
{
case
Targets
.
TYPES
.
FRAME
:
return
FrameTargetResources
;
case
Targets
.
TYPES
.
PROCESS
:
return
ProcessTargetResources
;
case
Targets
.
TYPES
.
WORKER
:
return
WorkerTargetResources
;
case
Targets
.
TYPES
.
SERVICE_WORKER
:
return
WorkerTargetResources
;
case
Targets
.
TYPES
.
SHARED_WORKER
:
return
WorkerTargetResources
;
default
:
throw
new
Error
(
Unsupported
target
actor
typeName
'
{
targetType
}
'
)
;
}
}
function
getResourceTypeEntry
(
rootOrWatcherOrTargetActor
resourceType
)
{
const
dict
=
getResourceTypeDictionary
(
rootOrWatcherOrTargetActor
)
;
if
(
!
(
resourceType
in
dict
)
)
{
throw
new
Error
(
Unsupported
resource
type
'
{
resourceType
}
'
for
{
rootOrWatcherOrTargetActor
.
typeName
}
)
;
}
return
dict
[
resourceType
]
;
}
async
function
watchResources
(
rootOrWatcherOrTargetActor
resourceTypes
)
{
const
{
targetType
}
=
rootOrWatcherOrTargetActor
;
if
(
targetType
)
{
resourceTypes
=
getResourceTypesForTargetType
(
resourceTypes
targetType
)
;
}
const
promises
=
[
]
;
for
(
const
resourceType
of
resourceTypes
)
{
const
{
watchers
WatcherClass
}
=
getResourceTypeEntry
(
rootOrWatcherOrTargetActor
resourceType
)
;
if
(
watchers
.
has
(
rootOrWatcherOrTargetActor
)
)
{
continue
;
}
if
(
resourceType
=
=
TYPES
.
CONSOLE_MESSAGE
&
&
rootOrWatcherOrTargetActor
.
workerConsoleApiMessagesDispatchedToMainThread
)
{
continue
;
}
const
watcher
=
new
WatcherClass
(
)
;
promises
.
push
(
watcher
.
watch
(
rootOrWatcherOrTargetActor
{
onAvailable
:
rootOrWatcherOrTargetActor
.
notifyResources
.
bind
(
rootOrWatcherOrTargetActor
"
available
"
resourceType
)
onUpdated
:
rootOrWatcherOrTargetActor
.
notifyResources
.
bind
(
rootOrWatcherOrTargetActor
"
updated
"
resourceType
)
onDestroyed
:
rootOrWatcherOrTargetActor
.
notifyResources
.
bind
(
rootOrWatcherOrTargetActor
"
destroyed
"
resourceType
)
}
)
)
;
watchers
.
set
(
rootOrWatcherOrTargetActor
watcher
)
;
}
await
Promise
.
all
(
promises
)
;
if
(
rootOrWatcherOrTargetActor
.
emitResources
)
{
rootOrWatcherOrTargetActor
.
emitResources
(
)
;
}
}
exports
.
watchResources
=
watchResources
;
function
getParentProcessResourceTypes
(
resourceTypes
)
{
return
resourceTypes
.
filter
(
resourceType
=
>
{
return
resourceType
in
ParentProcessResources
;
}
)
;
}
exports
.
getParentProcessResourceTypes
=
getParentProcessResourceTypes
;
function
getResourceTypesForTargetType
(
resourceTypes
targetType
)
{
const
resourceDictionnary
=
getResourceTypeDictionaryForTargetType
(
targetType
)
;
return
resourceTypes
.
filter
(
resourceType
=
>
{
return
resourceType
in
resourceDictionnary
;
}
)
;
}
exports
.
getResourceTypesForTargetType
=
getResourceTypesForTargetType
;
function
hasResourceTypesForTargets
(
resourceTypes
)
{
return
resourceTypes
.
some
(
resourceType
=
>
{
return
resourceType
in
FrameTargetResources
;
}
)
;
}
exports
.
hasResourceTypesForTargets
=
hasResourceTypesForTargets
;
function
unwatchResources
(
rootOrWatcherOrTargetActor
resourceTypes
)
{
const
{
targetType
}
=
rootOrWatcherOrTargetActor
;
if
(
targetType
)
{
resourceTypes
=
getResourceTypesForTargetType
(
resourceTypes
targetType
)
;
}
for
(
const
resourceType
of
resourceTypes
)
{
const
{
watchers
}
=
getResourceTypeEntry
(
rootOrWatcherOrTargetActor
resourceType
)
;
const
watcher
=
watchers
.
get
(
rootOrWatcherOrTargetActor
)
;
if
(
watcher
)
{
watcher
.
destroy
(
)
;
watchers
.
delete
(
rootOrWatcherOrTargetActor
)
;
}
}
}
exports
.
unwatchResources
=
unwatchResources
;
function
clearResources
(
rootOrWatcherOrTargetActor
resourceTypes
)
{
const
{
targetType
}
=
rootOrWatcherOrTargetActor
;
if
(
targetType
)
{
resourceTypes
=
getResourceTypesForTargetType
(
resourceTypes
targetType
)
;
}
for
(
const
resourceType
of
resourceTypes
)
{
const
{
watchers
}
=
getResourceTypeEntry
(
rootOrWatcherOrTargetActor
resourceType
)
;
const
watcher
=
watchers
.
get
(
rootOrWatcherOrTargetActor
)
;
if
(
watcher
&
&
typeof
watcher
.
clear
=
=
"
function
"
)
{
watcher
.
clear
(
)
;
}
}
}
exports
.
clearResources
=
clearResources
;
function
unwatchAllResources
(
rootOrWatcherOrTargetActor
)
{
for
(
const
{
watchers
}
of
Object
.
values
(
getResourceTypeDictionary
(
rootOrWatcherOrTargetActor
)
)
)
{
const
watcher
=
watchers
.
get
(
rootOrWatcherOrTargetActor
)
;
if
(
watcher
)
{
watcher
.
destroy
(
)
;
watchers
.
delete
(
rootOrWatcherOrTargetActor
)
;
}
}
}
exports
.
unwatchAllResources
=
unwatchAllResources
;
function
getResourceWatcher
(
watcherOrTargetActor
resourceType
)
{
const
{
watchers
}
=
getResourceTypeEntry
(
watcherOrTargetActor
resourceType
)
;
return
watchers
.
get
(
watcherOrTargetActor
)
;
}
exports
.
getResourceWatcher
=
getResourceWatcher
;
