"
use
strict
"
;
const
TYPES
=
{
CONSOLE_MESSAGE
:
"
console
-
message
"
PLATFORM_MESSAGE
:
"
platform
-
message
"
}
;
exports
.
TYPES
=
TYPES
;
const
Resources
=
{
[
TYPES
.
CONSOLE_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
console
-
messages
"
}
[
TYPES
.
PLATFORM_MESSAGE
]
:
{
path
:
"
devtools
/
server
/
actors
/
resources
/
platform
-
messages
"
}
}
;
for
(
const
resource
of
Object
.
values
(
Resources
)
)
{
resource
.
watchers
=
new
WeakMap
(
)
;
loader
.
lazyRequireGetter
(
resource
"
WatcherClass
"
resource
.
path
)
;
}
function
watchResources
(
watcherOrTargetActor
resourceTypes
)
{
for
(
const
resourceType
of
resourceTypes
)
{
if
(
!
(
resourceType
in
Resources
)
)
{
throw
new
Error
(
Unsupported
resource
type
'
{
resourceType
}
'
)
;
}
const
{
watchers
WatcherClass
}
=
Resources
[
resourceType
]
;
if
(
watchers
.
has
(
watcherOrTargetActor
)
)
{
continue
;
}
const
watcher
=
new
WatcherClass
(
watcherOrTargetActor
{
onAvailable
:
watcherOrTargetActor
.
notifyResourceAvailable
}
)
;
watchers
.
set
(
watcherOrTargetActor
watcher
)
;
}
}
function
getParentProcessResourceTypes
(
resourceTypes
)
{
return
resourceTypes
.
filter
(
resourceType
=
>
{
if
(
!
(
resourceType
in
Resources
)
)
{
throw
new
Error
(
Unsupported
resource
type
'
{
resourceType
}
'
)
;
}
return
!
!
Resources
[
resourceType
]
.
parentProcessResource
;
}
)
;
}
function
getContentProcessResourceTypes
(
resourceTypes
)
{
return
resourceTypes
.
filter
(
resourceType
=
>
{
if
(
!
(
resourceType
in
Resources
)
)
{
throw
new
Error
(
Unsupported
resource
type
'
{
resourceType
}
'
)
;
}
return
!
Resources
[
resourceType
]
.
parentProcessResource
;
}
)
;
}
function
watchTargetResources
(
targetActor
resourceTypes
)
{
const
contentProcessTypes
=
getContentProcessResourceTypes
(
resourceTypes
)
;
watchResources
(
targetActor
contentProcessTypes
)
;
}
exports
.
watchTargetResources
=
watchTargetResources
;
function
watchParentProcessResources
(
watcherActor
resourceTypes
)
{
const
parentProcessTypes
=
getParentProcessResourceTypes
(
resourceTypes
)
;
watchResources
(
watcherActor
parentProcessTypes
)
;
return
resourceTypes
.
filter
(
resource
=
>
!
parentProcessTypes
.
includes
(
resource
)
)
;
}
exports
.
watchParentProcessResources
=
watchParentProcessResources
;
function
unwatchResources
(
watcherOrTargetActor
resourceTypes
)
{
for
(
const
resourceType
of
resourceTypes
)
{
if
(
!
(
resourceType
in
Resources
)
)
{
throw
new
Error
(
Unsupported
resource
type
'
{
resourceType
}
'
)
;
}
const
{
watchers
}
=
Resources
[
resourceType
]
;
const
watcher
=
watchers
.
get
(
watcherOrTargetActor
)
;
if
(
watcher
)
{
watcher
.
destroy
(
)
;
watchers
.
delete
(
watcherOrTargetActor
)
;
}
}
}
function
unwatchTargetResources
(
targetActor
resourceTypes
)
{
const
contentProcessTypes
=
getContentProcessResourceTypes
(
resourceTypes
)
;
unwatchResources
(
targetActor
contentProcessTypes
)
;
}
exports
.
unwatchTargetResources
=
unwatchTargetResources
;
function
unwatchParentProcessResources
(
watcherActor
resourceTypes
)
{
const
parentProcessTypes
=
getParentProcessResourceTypes
(
resourceTypes
)
;
unwatchResources
(
watcherActor
parentProcessTypes
)
;
return
resourceTypes
.
filter
(
resource
=
>
!
parentProcessTypes
.
includes
(
resource
)
)
;
}
exports
.
unwatchParentProcessResources
=
unwatchParentProcessResources
;
function
unwatchAllTargetResources
(
watcherOrTargetActor
)
{
for
(
const
{
watchers
}
of
Object
.
values
(
Resources
)
)
{
const
watcher
=
watchers
.
get
(
watcherOrTargetActor
)
;
if
(
watcher
)
{
watcher
.
destroy
(
)
;
watchers
.
delete
(
watcherOrTargetActor
)
;
}
}
}
exports
.
unwatchAllTargetResources
=
unwatchAllTargetResources
;
function
getResourceWatcher
(
watcherOrTargetActor
resourceType
)
{
if
(
!
(
resourceType
in
Resources
)
)
{
throw
new
Error
(
Unsupported
resource
type
'
{
resourceType
}
'
)
;
}
const
{
watchers
}
=
Resources
[
resourceType
]
;
return
watchers
.
get
(
watcherOrTargetActor
)
;
}
exports
.
getResourceWatcher
=
getResourceWatcher
;
