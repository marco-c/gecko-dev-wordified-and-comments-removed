"
use
strict
"
;
const
{
LongStringActor
}
=
require
(
"
resource
:
/
/
devtools
/
server
/
actors
/
string
.
js
"
)
;
const
eventSourceEventService
=
Cc
[
"
mozilla
.
org
/
eventsourceevent
/
service
;
1
"
]
.
getService
(
Ci
.
nsIEventSourceEventService
)
;
class
ServerSentEventWatcher
{
constructor
(
)
{
this
.
windowIds
=
new
Set
(
)
;
this
.
onWindowReady
=
this
.
onWindowReady
.
bind
(
this
)
;
this
.
onWindowDestroy
=
this
.
onWindowDestroy
.
bind
(
this
)
;
}
watch
(
targetActor
{
onAvailable
}
)
{
this
.
onAvailable
=
onAvailable
;
this
.
targetActor
=
targetActor
;
for
(
const
window
of
this
.
targetActor
.
windows
)
{
const
{
innerWindowId
}
=
window
.
windowGlobalChild
;
this
.
startListening
(
innerWindowId
)
;
}
this
.
targetActor
.
on
(
"
window
-
ready
"
this
.
onWindowReady
)
;
this
.
targetActor
.
on
(
"
window
-
destroyed
"
this
.
onWindowDestroy
)
;
}
static
createResource
(
messageType
eventParams
)
{
return
{
messageType
.
.
.
eventParams
}
;
}
static
prepareFramePayload
(
targetActor
frame
)
{
const
payload
=
new
LongStringActor
(
targetActor
.
conn
frame
)
;
targetActor
.
manage
(
payload
)
;
return
payload
.
form
(
)
;
}
onWindowReady
(
{
window
}
)
{
const
{
innerWindowId
}
=
window
.
windowGlobalChild
;
this
.
startListening
(
innerWindowId
)
;
}
onWindowDestroy
(
{
id
}
)
{
this
.
stopListening
(
id
)
;
}
startListening
(
innerWindowId
)
{
if
(
!
this
.
windowIds
.
has
(
innerWindowId
)
)
{
this
.
windowIds
.
add
(
innerWindowId
)
;
eventSourceEventService
.
addListener
(
innerWindowId
this
)
;
}
}
stopListening
(
innerWindowId
)
{
if
(
this
.
windowIds
.
has
(
innerWindowId
)
)
{
this
.
windowIds
.
delete
(
innerWindowId
)
;
if
(
!
eventSourceEventService
.
hasListenerFor
(
innerWindowId
)
)
{
console
.
warn
(
"
Already
stopped
listening
to
server
sent
events
for
this
window
.
"
)
;
return
;
}
eventSourceEventService
.
removeListener
(
innerWindowId
this
)
;
}
}
destroy
(
)
{
for
(
const
id
of
this
.
windowIds
)
{
this
.
stopListening
(
id
)
;
}
this
.
targetActor
.
off
(
"
window
-
ready
"
this
.
onWindowReady
)
;
this
.
targetActor
.
off
(
"
window
-
destroyed
"
this
.
onWindowDestroy
)
;
}
eventSourceConnectionOpened
(
)
{
}
eventSourceConnectionClosed
(
httpChannelId
)
{
const
resource
=
ServerSentEventWatcher
.
createResource
(
"
eventSourceConnectionClosed
"
{
httpChannelId
}
)
;
this
.
onAvailable
(
[
resource
]
)
;
}
eventReceived
(
httpChannelId
eventName
lastEventId
data
retry
timeStamp
)
{
const
payload
=
ServerSentEventWatcher
.
prepareFramePayload
(
this
.
targetActor
data
)
;
const
resource
=
ServerSentEventWatcher
.
createResource
(
"
eventReceived
"
{
httpChannelId
data
:
{
payload
eventName
lastEventId
retry
timeStamp
}
}
)
;
this
.
onAvailable
(
[
resource
]
)
;
}
}
module
.
exports
=
ServerSentEventWatcher
;
