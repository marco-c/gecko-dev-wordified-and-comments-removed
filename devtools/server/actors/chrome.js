"
use
strict
"
;
const
{
Ci
}
=
require
(
"
chrome
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
{
DebuggerServer
}
=
require
(
"
.
.
/
main
"
)
;
const
{
getChildDocShells
TabActor
}
=
require
(
"
.
/
tab
"
)
;
const
makeDebugger
=
require
(
"
.
/
utils
/
make
-
debugger
"
)
;
const
{
extend
}
=
require
(
"
devtools
/
shared
/
extend
"
)
;
const
{
ActorClassWithSpec
Actor
}
=
require
(
"
devtools
/
shared
/
protocol
"
)
;
const
{
tabSpec
}
=
require
(
"
devtools
/
shared
/
specs
/
tab
"
)
;
const
chromePrototype
=
extend
(
{
}
TabActor
.
prototype
)
;
chromePrototype
.
initialize
=
function
(
connection
)
{
Actor
.
prototype
.
initialize
.
call
(
this
connection
)
;
TabActor
.
call
(
this
connection
)
;
this
.
makeDebugger
=
makeDebugger
.
bind
(
null
{
findDebuggees
:
dbg
=
>
dbg
.
findAllGlobals
(
)
shouldAddNewGlobalAsDebuggee
:
(
)
=
>
true
}
)
;
this
.
listenForNewDocShells
=
true
;
let
window
=
Services
.
wm
.
getMostRecentWindow
(
DebuggerServer
.
chromeWindowType
)
;
if
(
!
window
)
{
window
=
Services
.
wm
.
getMostRecentWindow
(
null
)
;
}
if
(
!
window
)
{
try
{
window
=
Services
.
appShell
.
hiddenDOMWindow
;
}
catch
(
e
)
{
}
}
let
docShell
=
window
?
window
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDocShell
)
:
null
;
Object
.
defineProperty
(
this
"
docShell
"
{
value
:
docShell
configurable
:
true
}
)
;
}
;
chromePrototype
.
isRootActor
=
true
;
Object
.
defineProperty
(
chromePrototype
"
docShells
"
{
get
:
function
(
)
{
let
docShells
=
[
]
;
let
e
=
Services
.
ww
.
getWindowEnumerator
(
)
;
while
(
e
.
hasMoreElements
(
)
)
{
let
window
=
e
.
getNext
(
)
;
let
docShell
=
window
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebNavigation
)
.
QueryInterface
(
Ci
.
nsIDocShell
)
;
docShells
=
docShells
.
concat
(
getChildDocShells
(
docShell
)
)
;
}
return
docShells
;
}
}
)
;
chromePrototype
.
observe
=
function
(
subject
topic
data
)
{
TabActor
.
prototype
.
observe
.
call
(
this
subject
topic
data
)
;
if
(
!
this
.
attached
)
{
return
;
}
subject
.
QueryInterface
(
Ci
.
nsIDocShell
)
;
if
(
topic
=
=
"
chrome
-
webnavigation
-
create
"
)
{
this
.
_onDocShellCreated
(
subject
)
;
}
else
if
(
topic
=
=
"
chrome
-
webnavigation
-
destroy
"
)
{
this
.
_onDocShellDestroy
(
subject
)
;
}
}
;
chromePrototype
.
_attach
=
function
(
)
{
if
(
this
.
attached
)
{
return
false
;
}
TabActor
.
prototype
.
_attach
.
call
(
this
)
;
Services
.
obs
.
addObserver
(
this
"
chrome
-
webnavigation
-
create
"
)
;
Services
.
obs
.
addObserver
(
this
"
chrome
-
webnavigation
-
destroy
"
)
;
let
e
=
Services
.
ww
.
getWindowEnumerator
(
)
;
while
(
e
.
hasMoreElements
(
)
)
{
let
window
=
e
.
getNext
(
)
;
let
docShell
=
window
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebNavigation
)
.
QueryInterface
(
Ci
.
nsIDocShell
)
;
if
(
docShell
=
=
this
.
docShell
)
{
continue
;
}
this
.
_progressListener
.
watch
(
docShell
)
;
}
return
undefined
;
}
;
chromePrototype
.
_detach
=
function
(
)
{
if
(
!
this
.
attached
)
{
return
false
;
}
Services
.
obs
.
removeObserver
(
this
"
chrome
-
webnavigation
-
create
"
)
;
Services
.
obs
.
removeObserver
(
this
"
chrome
-
webnavigation
-
destroy
"
)
;
let
e
=
Services
.
ww
.
getWindowEnumerator
(
)
;
while
(
e
.
hasMoreElements
(
)
)
{
let
window
=
e
.
getNext
(
)
;
let
docShell
=
window
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebNavigation
)
.
QueryInterface
(
Ci
.
nsIDocShell
)
;
if
(
docShell
=
=
this
.
docShell
)
{
continue
;
}
this
.
_progressListener
.
unwatch
(
docShell
)
;
}
TabActor
.
prototype
.
_detach
.
call
(
this
)
;
return
undefined
;
}
;
chromePrototype
.
preNest
=
function
(
)
{
let
e
=
Services
.
wm
.
getEnumerator
(
null
)
;
while
(
e
.
hasMoreElements
(
)
)
{
let
win
=
e
.
getNext
(
)
;
let
windowUtils
=
win
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDOMWindowUtils
)
;
windowUtils
.
suppressEventHandling
(
true
)
;
windowUtils
.
suspendTimeouts
(
)
;
}
}
;
chromePrototype
.
postNest
=
function
(
nestData
)
{
let
e
=
Services
.
wm
.
getEnumerator
(
null
)
;
while
(
e
.
hasMoreElements
(
)
)
{
let
win
=
e
.
getNext
(
)
;
let
windowUtils
=
win
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDOMWindowUtils
)
;
windowUtils
.
resumeTimeouts
(
)
;
windowUtils
.
suppressEventHandling
(
false
)
;
}
}
;
chromePrototype
.
typeName
=
"
Chrome
"
;
exports
.
chromePrototype
=
chromePrototype
;
exports
.
ChromeActor
=
ActorClassWithSpec
(
tabSpec
chromePrototype
)
;
