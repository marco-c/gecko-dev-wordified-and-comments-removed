"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
const
protocol
=
require
(
"
devtools
/
shared
/
protocol
"
)
;
const
{
LongStringActor
}
=
require
(
"
devtools
/
server
/
actors
/
string
"
)
;
const
defer
=
require
(
"
devtools
/
shared
/
defer
"
)
;
const
{
inspectorSpec
}
=
require
(
"
devtools
/
shared
/
specs
/
inspector
"
)
;
loader
.
lazyRequireGetter
(
this
"
InspectorActorUtils
"
"
devtools
/
server
/
actors
/
inspector
/
utils
"
)
;
loader
.
lazyRequireGetter
(
this
"
WalkerActor
"
"
devtools
/
server
/
actors
/
inspector
/
walker
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
EyeDropper
"
"
devtools
/
server
/
actors
/
highlighters
/
eye
-
dropper
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
PageStyleActor
"
"
devtools
/
server
/
actors
/
styles
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
HighlighterActor
"
"
devtools
/
server
/
actors
/
highlighters
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
CustomHighlighterActor
"
"
devtools
/
server
/
actors
/
highlighters
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
isTypeRegistered
"
"
devtools
/
server
/
actors
/
highlighters
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
HighlighterEnvironment
"
"
devtools
/
server
/
actors
/
highlighters
"
true
)
;
const
SVG_NS
=
"
http
:
/
/
www
.
w3
.
org
/
2000
/
svg
"
;
const
XUL_NS
=
"
http
:
/
/
www
.
mozilla
.
org
/
keymaster
/
gatekeeper
/
there
.
is
.
only
.
xul
"
;
exports
.
InspectorActor
=
protocol
.
ActorClassWithSpec
(
inspectorSpec
{
initialize
:
function
(
conn
tabActor
)
{
protocol
.
Actor
.
prototype
.
initialize
.
call
(
this
conn
)
;
this
.
tabActor
=
tabActor
;
this
.
_onColorPicked
=
this
.
_onColorPicked
.
bind
(
this
)
;
this
.
_onColorPickCanceled
=
this
.
_onColorPickCanceled
.
bind
(
this
)
;
this
.
destroyEyeDropper
=
this
.
destroyEyeDropper
.
bind
(
this
)
;
}
destroy
:
function
(
)
{
protocol
.
Actor
.
prototype
.
destroy
.
call
(
this
)
;
this
.
destroyEyeDropper
(
)
;
this
.
_highlighterPromise
=
null
;
this
.
_pageStylePromise
=
null
;
this
.
_walkerPromise
=
null
;
this
.
walker
=
null
;
this
.
tabActor
=
null
;
}
get
window
(
)
{
return
this
.
tabActor
.
window
;
}
getWalker
:
function
(
options
=
{
}
)
{
if
(
this
.
_walkerPromise
)
{
return
this
.
_walkerPromise
;
}
let
deferred
=
defer
(
)
;
this
.
_walkerPromise
=
deferred
.
promise
;
let
window
=
this
.
window
;
let
domReady
=
(
)
=
>
{
let
tabActor
=
this
.
tabActor
;
window
.
removeEventListener
(
"
DOMContentLoaded
"
domReady
true
)
;
this
.
walker
=
WalkerActor
(
this
.
conn
tabActor
options
)
;
this
.
manage
(
this
.
walker
)
;
this
.
walker
.
once
(
"
destroyed
"
(
)
=
>
{
this
.
_walkerPromise
=
null
;
this
.
_pageStylePromise
=
null
;
}
)
;
deferred
.
resolve
(
this
.
walker
)
;
}
;
if
(
window
.
document
.
readyState
=
=
=
"
loading
"
)
{
window
.
addEventListener
(
"
DOMContentLoaded
"
domReady
true
)
;
}
else
{
domReady
(
)
;
}
return
this
.
_walkerPromise
;
}
getPageStyle
:
function
(
)
{
if
(
this
.
_pageStylePromise
)
{
return
this
.
_pageStylePromise
;
}
this
.
_pageStylePromise
=
this
.
getWalker
(
)
.
then
(
walker
=
>
{
let
pageStyle
=
PageStyleActor
(
this
)
;
this
.
manage
(
pageStyle
)
;
return
pageStyle
;
}
)
;
return
this
.
_pageStylePromise
;
}
getHighlighter
:
function
(
autohide
)
{
if
(
this
.
_highlighterPromise
)
{
return
this
.
_highlighterPromise
;
}
this
.
_highlighterPromise
=
this
.
getWalker
(
)
.
then
(
walker
=
>
{
let
highlighter
=
HighlighterActor
(
this
autohide
)
;
this
.
manage
(
highlighter
)
;
return
highlighter
;
}
)
;
return
this
.
_highlighterPromise
;
}
getHighlighterByType
:
function
(
typeName
)
{
if
(
isTypeRegistered
(
typeName
)
)
{
return
CustomHighlighterActor
(
this
typeName
)
;
}
return
null
;
}
getImageDataFromURL
:
function
(
url
maxDim
)
{
let
img
=
new
this
.
window
.
Image
(
)
;
img
.
src
=
url
;
return
InspectorActorUtils
.
imageToImageData
(
img
maxDim
)
.
then
(
imageData
=
>
{
return
{
data
:
LongStringActor
(
this
.
conn
imageData
.
data
)
size
:
imageData
.
size
}
;
}
)
;
}
resolveRelativeURL
:
function
(
url
node
)
{
let
document
=
InspectorActorUtils
.
isNodeDead
(
node
)
?
this
.
window
.
document
:
InspectorActorUtils
.
nodeDocument
(
node
.
rawNode
)
;
if
(
!
document
)
{
return
url
;
}
let
baseURI
=
Services
.
io
.
newURI
(
document
.
location
.
href
)
;
return
Services
.
io
.
newURI
(
url
null
baseURI
)
.
spec
;
}
createEyeDropper
:
function
(
)
{
this
.
destroyEyeDropper
(
)
;
this
.
_highlighterEnv
=
new
HighlighterEnvironment
(
)
;
this
.
_highlighterEnv
.
initFromTabActor
(
this
.
tabActor
)
;
this
.
_eyeDropper
=
new
EyeDropper
(
this
.
_highlighterEnv
)
;
}
destroyEyeDropper
:
function
(
)
{
if
(
this
.
_eyeDropper
)
{
this
.
cancelPickColorFromPage
(
)
;
this
.
_eyeDropper
.
destroy
(
)
;
this
.
_eyeDropper
=
null
;
this
.
_highlighterEnv
.
destroy
(
)
;
this
.
_highlighterEnv
=
null
;
}
}
pickColorFromPage
:
function
(
options
)
{
this
.
createEyeDropper
(
)
;
this
.
_eyeDropper
.
show
(
this
.
window
.
document
.
documentElement
options
)
;
this
.
_eyeDropper
.
once
(
"
selected
"
this
.
_onColorPicked
)
;
this
.
_eyeDropper
.
once
(
"
canceled
"
this
.
_onColorPickCanceled
)
;
this
.
tabActor
.
once
(
"
will
-
navigate
"
this
.
destroyEyeDropper
)
;
}
cancelPickColorFromPage
:
function
(
)
{
if
(
this
.
_eyeDropper
)
{
this
.
_eyeDropper
.
hide
(
)
;
this
.
_eyeDropper
.
off
(
"
selected
"
this
.
_onColorPicked
)
;
this
.
_eyeDropper
.
off
(
"
canceled
"
this
.
_onColorPickCanceled
)
;
this
.
tabActor
.
off
(
"
will
-
navigate
"
this
.
destroyEyeDropper
)
;
}
}
supportsHighlighters
:
function
(
)
{
let
doc
=
this
.
tabActor
.
window
.
document
;
let
ns
=
doc
.
documentElement
.
namespaceURI
;
if
(
ns
=
=
=
XUL_NS
)
{
return
false
;
}
if
(
ns
=
=
=
SVG_NS
)
{
return
false
;
}
return
true
;
}
_onColorPicked
:
function
(
e
color
)
{
this
.
emit
(
"
color
-
picked
"
color
)
;
}
_onColorPickCanceled
:
function
(
)
{
this
.
emit
(
"
color
-
pick
-
canceled
"
)
;
}
}
)
;
