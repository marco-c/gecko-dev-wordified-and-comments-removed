"
use
strict
"
;
const
{
Cu
}
=
require
(
"
chrome
"
)
;
const
InspectorUtils
=
require
(
"
InspectorUtils
"
)
;
const
EventEmitter
=
require
(
"
devtools
/
shared
/
event
-
emitter
"
)
;
class
CustomElementWatcher
extends
EventEmitter
{
constructor
(
chromeEventHandler
)
{
super
(
)
;
this
.
chromeEventHandler
=
chromeEventHandler
;
this
.
_onCustomElementDefined
=
this
.
_onCustomElementDefined
.
bind
(
this
)
;
this
.
chromeEventHandler
.
addEventListener
(
"
customelementdefined
"
this
.
_onCustomElementDefined
)
;
this
.
watchedRegistries
=
new
WeakMap
(
)
;
}
destroy
(
)
{
this
.
watchedRegistries
=
null
;
this
.
chromeEventHandler
.
removeEventListener
(
"
customelementdefined
"
this
.
_onCustomElementDefined
)
;
}
manageNode
(
nodeActor
)
{
if
(
!
this
.
_isValidNode
(
nodeActor
)
)
{
return
;
}
if
(
!
this
.
_shouldWatchDefinition
(
nodeActor
)
)
{
return
;
}
const
registry
=
nodeActor
.
rawNode
.
ownerGlobal
.
customElements
;
const
registryMap
=
this
.
_getMapForRegistry
(
registry
)
;
const
name
=
nodeActor
.
rawNode
.
localName
;
const
actorsSet
=
this
.
_getActorsForName
(
name
registryMap
)
;
actorsSet
.
add
(
nodeActor
)
;
}
unmanageNode
(
nodeActor
)
{
if
(
!
this
.
_isValidNode
(
nodeActor
)
)
{
return
;
}
const
win
=
nodeActor
.
rawNode
.
ownerGlobal
;
const
registry
=
win
.
customElements
;
const
registryMap
=
this
.
_getMapForRegistry
(
registry
)
;
const
name
=
nodeActor
.
rawNode
.
localName
;
if
(
registryMap
.
has
(
name
)
)
{
registryMap
.
get
(
name
)
.
delete
(
nodeActor
)
;
}
}
_getMapForRegistry
(
registry
)
{
if
(
!
this
.
watchedRegistries
.
has
(
registry
)
)
{
this
.
watchedRegistries
.
set
(
registry
new
Map
(
)
)
;
}
return
this
.
watchedRegistries
.
get
(
registry
)
;
}
_getActorsForName
(
name
registryMap
)
{
if
(
!
registryMap
.
has
(
name
)
)
{
registryMap
.
set
(
name
new
Set
(
)
)
;
}
return
registryMap
.
get
(
name
)
;
}
_shouldWatchDefinition
(
nodeActor
)
{
const
doc
=
nodeActor
.
rawNode
.
ownerDocument
;
const
namespaceURI
=
doc
.
documentElement
.
namespaceURI
;
const
name
=
nodeActor
.
rawNode
.
localName
;
const
isValidName
=
InspectorUtils
.
isCustomElementName
(
name
namespaceURI
)
;
const
customElements
=
doc
.
defaultView
.
customElements
;
return
isValidName
&
&
!
customElements
.
get
(
name
)
;
}
_onCustomElementDefined
(
event
)
{
const
doc
=
event
.
target
;
const
registry
=
doc
.
defaultView
.
customElements
;
const
registryMap
=
this
.
_getMapForRegistry
(
registry
)
;
const
name
=
event
.
detail
;
const
actors
=
this
.
_getActorsForName
(
name
registryMap
)
;
this
.
emit
(
"
element
-
defined
"
{
name
actors
}
)
;
registryMap
.
delete
(
name
)
;
}
_isValidNode
(
nodeActor
)
{
const
node
=
nodeActor
.
rawNode
;
return
(
!
Cu
.
isDeadWrapper
(
node
)
&
&
node
.
ownerGlobal
&
&
node
.
ownerDocument
&
&
node
.
ownerDocument
.
documentElement
)
;
}
}
exports
.
CustomElementWatcher
=
CustomElementWatcher
;
