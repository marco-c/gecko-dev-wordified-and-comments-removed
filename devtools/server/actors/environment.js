"
use
strict
"
;
const
{
ActorClassWithSpec
Actor
}
=
require
(
"
devtools
/
shared
/
protocol
"
)
;
const
{
createValueGrip
}
=
require
(
"
devtools
/
server
/
actors
/
object
/
utils
"
)
;
const
{
environmentSpec
}
=
require
(
"
devtools
/
shared
/
specs
/
environment
"
)
;
const
EnvironmentActor
=
ActorClassWithSpec
(
environmentSpec
{
initialize
:
function
(
environment
threadActor
)
{
Actor
.
prototype
.
initialize
.
call
(
this
threadActor
.
conn
)
;
this
.
obj
=
environment
;
this
.
threadActor
=
threadActor
;
}
destroy
:
function
(
)
{
this
.
obj
.
actor
=
null
;
}
form
:
function
(
)
{
const
form
=
{
actor
:
this
.
actorID
}
;
if
(
this
.
obj
.
type
=
=
"
declarative
"
)
{
form
.
type
=
this
.
obj
.
callee
?
"
function
"
:
"
block
"
;
}
else
{
form
.
type
=
this
.
obj
.
type
;
}
form
.
scopeKind
=
this
.
obj
.
scopeKind
;
if
(
this
.
obj
.
parent
)
{
form
.
parent
=
this
.
threadActor
.
createEnvironmentActor
(
this
.
obj
.
parent
this
.
getParent
(
)
)
.
form
(
)
;
}
if
(
this
.
obj
.
type
=
=
"
object
"
|
|
this
.
obj
.
type
=
=
"
with
"
)
{
form
.
object
=
createValueGrip
(
this
.
obj
.
object
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
}
if
(
this
.
obj
.
callee
)
{
form
.
function
=
createValueGrip
(
this
.
obj
.
callee
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
}
if
(
this
.
obj
.
type
=
=
"
declarative
"
)
{
form
.
bindings
=
this
.
bindings
(
)
;
}
return
form
;
}
assign
:
function
(
name
value
)
{
try
{
this
.
obj
.
setVariable
(
name
value
)
;
}
catch
(
e
)
{
if
(
e
instanceof
Debugger
.
DebuggeeWouldRun
)
{
const
errorObject
=
{
error
:
"
threadWouldRun
"
message
:
"
Assigning
a
value
would
cause
the
debuggee
to
run
"
}
;
throw
errorObject
;
}
else
{
throw
e
;
}
}
return
{
from
:
this
.
actorID
}
;
}
bindings
:
function
(
)
{
const
bindings
=
{
arguments
:
[
]
variables
:
{
}
}
;
if
(
typeof
this
.
obj
.
getVariable
!
=
"
function
"
)
{
return
bindings
;
}
let
parameterNames
;
if
(
this
.
obj
.
callee
)
{
parameterNames
=
this
.
obj
.
callee
.
parameterNames
;
}
else
{
parameterNames
=
[
]
;
}
for
(
const
name
of
parameterNames
)
{
const
arg
=
{
}
;
const
value
=
this
.
obj
.
getVariable
(
name
)
;
const
desc
=
{
value
:
value
configurable
:
false
writable
:
!
(
value
&
&
value
.
optimizedOut
)
enumerable
:
true
}
;
const
descForm
=
{
enumerable
:
true
configurable
:
desc
.
configurable
}
;
if
(
"
value
"
in
desc
)
{
descForm
.
value
=
createValueGrip
(
desc
.
value
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
descForm
.
writable
=
desc
.
writable
;
}
else
{
descForm
.
get
=
createValueGrip
(
desc
.
get
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
descForm
.
set
=
createValueGrip
(
desc
.
set
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
}
arg
[
name
]
=
descForm
;
bindings
.
arguments
.
push
(
arg
)
;
}
for
(
const
name
of
this
.
obj
.
names
(
)
)
{
if
(
bindings
.
arguments
.
some
(
function
exists
(
element
)
{
return
!
!
element
[
name
]
;
}
)
)
{
continue
;
}
const
value
=
this
.
obj
.
getVariable
(
name
)
;
const
desc
=
{
value
:
value
configurable
:
false
writable
:
!
(
value
&
&
(
value
.
optimizedOut
|
|
value
.
uninitialized
|
|
value
.
missingArguments
)
)
enumerable
:
true
}
;
const
descForm
=
{
enumerable
:
true
configurable
:
desc
.
configurable
}
;
if
(
"
value
"
in
desc
)
{
descForm
.
value
=
createValueGrip
(
desc
.
value
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
descForm
.
writable
=
desc
.
writable
;
}
else
{
descForm
.
get
=
createValueGrip
(
desc
.
get
|
|
undefined
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
descForm
.
set
=
createValueGrip
(
desc
.
set
|
|
undefined
this
.
getParent
(
)
this
.
threadActor
.
objectGrip
)
;
}
bindings
.
variables
[
name
]
=
descForm
;
}
return
bindings
;
}
}
)
;
exports
.
EnvironmentActor
=
EnvironmentActor
;
