"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
initContentProcessTarget
"
]
;
function
initContentProcessTarget
(
msg
)
{
const
mm
=
msg
.
target
;
const
prefix
=
msg
.
data
.
prefix
;
const
watcherActorID
=
msg
.
data
.
watcherActorID
;
const
{
useDistinctSystemPrincipalLoader
releaseDistinctSystemPrincipalLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
const
loaderRequester
=
{
}
;
const
loader
=
useDistinctSystemPrincipalLoader
(
loaderRequester
)
;
const
{
DevToolsServer
}
=
loader
.
require
(
"
devtools
/
server
/
devtools
-
server
"
)
;
DevToolsServer
.
init
(
)
;
DevToolsServer
.
registerActors
(
{
root
:
true
target
:
true
}
)
;
const
conn
=
DevToolsServer
.
connectToParent
(
prefix
mm
)
;
conn
.
parentMessageManager
=
mm
;
const
{
ContentProcessTargetActor
}
=
loader
.
require
(
"
devtools
/
server
/
actors
/
targets
/
content
-
process
"
)
;
const
actor
=
new
ContentProcessTargetActor
(
conn
{
sessionContext
:
msg
.
data
.
sessionContext
}
)
;
actor
.
manage
(
actor
)
;
const
response
=
{
watcherActorID
prefix
actor
:
actor
.
form
(
)
}
;
mm
.
sendAsyncMessage
(
"
debug
:
content
-
process
-
actor
"
response
)
;
function
onDestroy
(
options
)
{
mm
.
removeMessageListener
(
"
debug
:
content
-
process
-
disconnect
"
onContentProcessDisconnect
)
;
actor
.
off
(
"
destroyed
"
onDestroy
)
;
mm
.
sendAsyncMessage
(
"
debug
:
content
-
process
-
actor
-
destroyed
"
{
watcherActorID
}
)
;
conn
.
close
(
options
)
;
releaseDistinctSystemPrincipalLoader
(
loaderRequester
)
;
}
function
onContentProcessDisconnect
(
message
)
{
if
(
message
.
data
.
prefix
!
=
prefix
)
{
return
;
}
onDestroy
(
)
;
}
mm
.
addMessageListener
(
"
debug
:
content
-
process
-
disconnect
"
onContentProcessDisconnect
)
;
actor
.
on
(
"
destroyed
"
onDestroy
)
;
return
{
actor
connection
:
conn
}
;
}
