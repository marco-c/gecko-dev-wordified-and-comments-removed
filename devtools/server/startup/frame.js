"
use
strict
"
;
try
{
var
chromeGlobal
=
this
;
(
function
(
)
{
let
loader
customLoader
=
false
;
if
(
content
.
document
.
nodePrincipal
.
isSystemPrincipal
)
{
const
{
useDistinctSystemPrincipalLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
loader
=
useDistinctSystemPrincipalLoader
(
chromeGlobal
)
;
customLoader
=
true
;
}
else
{
loader
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
}
const
{
require
}
=
loader
;
const
DevToolsUtils
=
require
(
"
devtools
/
shared
/
DevToolsUtils
"
)
;
const
{
DevToolsServer
}
=
require
(
"
devtools
/
server
/
devtools
-
server
"
)
;
DevToolsServer
.
init
(
)
;
DevToolsServer
.
registerActors
(
{
target
:
true
}
)
;
const
connections
=
new
Map
(
)
;
const
onConnect
=
DevToolsUtils
.
makeInfallible
(
function
(
msg
)
{
const
mm
=
msg
.
target
;
const
prefix
=
msg
.
data
.
prefix
;
const
addonId
=
msg
.
data
.
addonId
;
const
addonBrowsingContextGroupId
=
msg
.
data
.
addonBrowsingContextGroupId
;
if
(
DevToolsServer
.
hasConnectionForPrefix
(
prefix
)
)
{
return
;
}
removeMessageListener
(
"
debug
:
connect
"
onConnect
)
;
const
conn
=
DevToolsServer
.
connectToParent
(
prefix
mm
)
;
conn
.
parentMessageManager
=
mm
;
connections
.
set
(
prefix
conn
)
;
let
actor
;
if
(
addonId
)
{
const
{
WebExtensionTargetActor
}
=
require
(
"
devtools
/
server
/
actors
/
targets
/
webextension
"
)
;
const
{
createWebExtensionSessionContext
}
=
require
(
"
devtools
/
server
/
actors
/
watcher
/
session
-
context
"
)
;
const
{
browsingContext
}
=
docShell
;
actor
=
new
WebExtensionTargetActor
(
conn
{
addonId
addonBrowsingContextGroupId
chromeGlobal
isTopLevelTarget
:
true
prefix
sessionContext
:
createWebExtensionSessionContext
(
{
addonId
:
addonId
browsingContextID
:
browsingContext
.
id
innerWindowId
:
browsingContext
.
currentWindowContext
.
innerWindowId
}
{
isServerTargetSwitchingEnabled
:
msg
.
data
.
isServerTargetSwitchingEnabled
}
)
}
)
;
}
else
{
const
{
WindowGlobalTargetActor
}
=
require
(
"
devtools
/
server
/
actors
/
targets
/
window
-
global
"
)
;
const
{
createBrowserElementSessionContext
}
=
require
(
"
devtools
/
server
/
actors
/
watcher
/
session
-
context
"
)
;
const
{
docShell
}
=
chromeGlobal
;
const
fakeBrowserElement
=
{
browserId
:
docShell
.
browsingContext
.
browserId
}
;
actor
=
new
WindowGlobalTargetActor
(
conn
{
docShell
isTopLevelTarget
:
true
sessionContext
:
createBrowserElementSessionContext
(
fakeBrowserElement
{
}
)
}
)
;
}
actor
.
manage
(
actor
)
;
sendAsyncMessage
(
"
debug
:
actor
"
{
actor
:
actor
.
form
(
)
prefix
:
prefix
}
)
;
}
)
;
addMessageListener
(
"
debug
:
connect
"
onConnect
)
;
const
onDisconnect
=
DevToolsUtils
.
makeInfallible
(
function
(
msg
)
{
const
prefix
=
msg
.
data
.
prefix
;
const
conn
=
connections
.
get
(
prefix
)
;
if
(
!
conn
)
{
return
;
}
removeMessageListener
(
"
debug
:
disconnect
"
onDisconnect
)
;
conn
.
close
(
)
;
connections
.
delete
(
prefix
)
;
}
)
;
addMessageListener
(
"
debug
:
disconnect
"
onDisconnect
)
;
addEventListener
(
"
unload
"
(
)
=
>
{
for
(
const
conn
of
connections
.
values
(
)
)
{
conn
.
close
(
)
;
}
connections
.
clear
(
)
;
}
)
;
function
destroyLoader
(
)
{
if
(
DevToolsServer
.
hasConnection
(
)
|
|
DevToolsServer
.
keepAlive
)
{
return
;
}
DevToolsServer
.
off
(
"
connectionchange
"
destroyLoader
)
;
if
(
customLoader
)
{
const
{
releaseDistinctSystemPrincipalLoader
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
loader
/
Loader
.
jsm
"
)
;
releaseDistinctSystemPrincipalLoader
(
chromeGlobal
)
;
}
}
DevToolsServer
.
on
(
"
connectionchange
"
destroyLoader
)
;
}
)
(
)
;
}
catch
(
e
)
{
dump
(
Exception
in
DevTools
frame
startup
:
{
e
}
\
n
)
;
}
