"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
NetworkObserver
:
"
resource
:
/
/
devtools
/
shared
/
network
-
observer
/
NetworkObserver
.
sys
.
mjs
"
}
)
;
const
TEST_DIR
=
gTestPath
.
substr
(
0
gTestPath
.
lastIndexOf
(
"
/
"
)
)
;
const
CHROME_URL_ROOT
=
TEST_DIR
+
"
/
"
;
const
URL_ROOT
=
CHROME_URL_ROOT
.
replace
(
"
chrome
:
/
/
mochitests
/
content
/
"
"
https
:
/
/
example
.
com
/
"
)
;
async
function
loadURL
(
browser
url
)
{
const
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
BrowserTestUtils
.
startLoadingURIString
(
browser
url
)
;
return
loaded
;
}
async
function
addTab
(
url
)
{
const
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
url
)
;
registerCleanupFunction
(
(
)
=
>
{
gBrowser
.
removeTab
(
tab
)
;
}
)
;
return
tab
;
}
class
NetworkEventOwner
{
hasEventTimings
=
false
;
hasResponseCache
=
false
;
hasResponseContent
=
false
;
hasResponseStart
=
false
;
hasSecurityInfo
=
false
;
hasServerTimings
=
false
;
addEventTimings
(
)
{
this
.
hasEventTimings
=
true
;
}
addResponseCache
(
)
{
this
.
hasResponseCache
=
true
;
}
addResponseContent
(
)
{
this
.
hasResponseContent
=
true
;
}
addResponseStart
(
)
{
this
.
hasResponseStart
=
true
;
}
addSecurityInfo
(
)
{
this
.
hasSecurityInfo
=
true
;
}
addServerTimings
(
)
{
this
.
hasServerTimings
=
true
;
}
addServiceWorkerTimings
(
)
{
this
.
hasServiceWorkerTimings
=
true
;
}
}
function
createNetworkEventOwner
(
event
)
{
return
new
NetworkEventOwner
(
)
;
}
async
function
waitForNetworkEvents
(
expectedUrl
=
null
expectedRequestsCount
)
{
const
events
=
[
]
;
const
networkObserver
=
new
NetworkObserver
(
{
ignoreChannelFunction
:
channel
=
>
expectedUrl
?
channel
.
URI
.
spec
!
=
=
expectedUrl
:
false
onNetworkEvent
:
(
)
=
>
{
info
(
"
waitForNetworkEvents
received
a
new
event
"
)
;
const
owner
=
createNetworkEventOwner
(
)
;
events
.
push
(
owner
)
;
return
owner
;
}
}
)
;
registerCleanupFunction
(
(
)
=
>
networkObserver
.
destroy
(
)
)
;
info
(
"
Wait
until
the
events
count
reaches
"
+
expectedRequestsCount
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
events
.
length
>
=
expectedRequestsCount
)
;
return
events
;
}
