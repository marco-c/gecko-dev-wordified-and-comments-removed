"
use
strict
"
;
var
{
Constructor
:
CC
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
var
{
Loader
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
commonjs
/
toolkit
/
loader
.
js
"
{
}
)
;
var
promise
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Promise
.
jsm
"
{
}
)
.
Promise
;
this
.
EXPORTED_SYMBOLS
=
[
"
DevToolsLoader
"
"
devtools
"
"
BuiltinProvider
"
"
require
"
"
loader
"
]
;
var
loaderModules
=
{
"
Services
"
:
Object
.
create
(
Services
)
"
toolkit
/
loader
"
:
Loader
PromiseDebugging
ChromeUtils
ThreadSafeChromeUtils
HeapSnapshot
}
;
XPCOMUtils
.
defineLazyGetter
(
loaderModules
"
Debugger
"
(
)
=
>
{
let
sandbox
=
Cu
.
Sandbox
(
CC
(
'
mozilla
.
org
/
systemprincipal
;
1
'
'
nsIPrincipal
'
)
(
)
)
;
Cu
.
evalInSandbox
(
"
Components
.
utils
.
import
(
'
resource
:
/
/
gre
/
modules
/
jsdebugger
.
jsm
'
)
;
"
+
"
addDebuggerToGlobal
(
this
)
;
"
sandbox
)
;
return
sandbox
.
Debugger
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
loaderModules
"
Timer
"
(
)
=
>
{
let
{
setTimeout
clearTimeout
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
{
}
)
;
return
{
setTimeout
clearTimeout
}
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
loaderModules
"
xpcInspector
"
(
)
=
>
{
return
Cc
[
"
mozilla
.
org
/
jsinspector
;
1
"
]
.
getService
(
Ci
.
nsIJSInspector
)
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
loaderModules
"
indexedDB
"
(
)
=
>
{
try
{
let
sandbox
=
Cu
.
Sandbox
(
CC
(
'
mozilla
.
org
/
systemprincipal
;
1
'
'
nsIPrincipal
'
)
(
)
{
wantGlobalProperties
:
[
"
indexedDB
"
]
}
)
;
return
sandbox
.
indexedDB
;
}
catch
(
e
)
{
return
{
}
;
}
}
)
;
XPCOMUtils
.
defineLazyGetter
(
loaderModules
"
CSS
"
(
)
=
>
{
let
sandbox
=
Cu
.
Sandbox
(
CC
(
'
mozilla
.
org
/
systemprincipal
;
1
'
'
nsIPrincipal
'
)
(
)
{
wantGlobalProperties
:
[
"
CSS
"
]
}
)
;
return
sandbox
.
CSS
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
loaderModules
"
URL
"
(
)
=
>
{
let
sandbox
=
Cu
.
Sandbox
(
CC
(
'
mozilla
.
org
/
systemprincipal
;
1
'
'
nsIPrincipal
'
)
(
)
{
wantGlobalProperties
:
[
"
URL
"
]
}
)
;
return
sandbox
.
URL
;
}
)
;
const
loaderPaths
=
{
"
"
:
"
resource
:
/
/
gre
/
modules
/
commonjs
/
"
"
devtools
"
:
"
resource
:
/
/
devtools
"
"
gcli
"
:
"
resource
:
/
/
devtools
/
shared
/
gcli
/
source
/
lib
/
gcli
"
"
acorn
"
:
"
resource
:
/
/
devtools
/
acorn
"
"
acorn
/
util
/
walk
"
:
"
resource
:
/
/
devtools
/
acorn
/
walk
.
js
"
"
source
-
map
"
:
"
resource
:
/
/
devtools
/
shared
/
sourcemap
/
source
-
map
.
js
"
"
xpcshell
-
test
"
:
"
resource
:
/
/
test
"
}
;
var
sharedGlobalBlocklist
=
[
"
sdk
/
indexed
-
db
"
]
;
function
BuiltinProvider
(
)
{
}
BuiltinProvider
.
prototype
=
{
load
:
function
(
)
{
let
paths
=
{
}
;
for
(
let
path
in
loaderPaths
)
{
paths
[
path
]
=
loaderPaths
[
path
]
;
}
let
modules
=
{
}
;
for
(
let
name
in
loaderModules
)
{
XPCOMUtils
.
defineLazyGetter
(
modules
name
(
function
(
name
)
{
return
loaderModules
[
name
]
;
}
)
.
bind
(
null
name
)
)
;
}
if
(
this
.
invisibleToDebugger
)
{
paths
[
"
promise
"
]
=
"
resource
:
/
/
gre
/
modules
/
Promise
-
backend
.
js
"
;
}
else
{
modules
[
"
promise
"
]
=
promise
;
}
this
.
loader
=
new
Loader
.
Loader
(
{
id
:
"
fx
-
devtools
"
modules
paths
globals
:
this
.
globals
invisibleToDebugger
:
this
.
invisibleToDebugger
sharedGlobal
:
true
sharedGlobalBlocklist
}
)
;
return
promise
.
resolve
(
undefined
)
;
}
unload
:
function
(
reason
)
{
Loader
.
unload
(
this
.
loader
reason
)
;
delete
this
.
loader
;
}
}
;
var
gNextLoaderID
=
0
;
this
.
DevToolsLoader
=
function
DevToolsLoader
(
)
{
this
.
require
=
this
.
require
.
bind
(
this
)
;
this
.
lazyGetter
=
XPCOMUtils
.
defineLazyGetter
.
bind
(
XPCOMUtils
)
;
this
.
lazyImporter
=
XPCOMUtils
.
defineLazyModuleGetter
.
bind
(
XPCOMUtils
)
;
this
.
lazyServiceGetter
=
XPCOMUtils
.
defineLazyServiceGetter
.
bind
(
XPCOMUtils
)
;
this
.
lazyRequireGetter
=
this
.
lazyRequireGetter
.
bind
(
this
)
;
Services
.
obs
.
addObserver
(
this
"
devtools
-
unload
"
false
)
;
}
;
DevToolsLoader
.
prototype
=
{
get
provider
(
)
{
if
(
!
this
.
_provider
)
{
this
.
_loadProvider
(
)
;
}
return
this
.
_provider
;
}
_provider
:
null
get
id
(
)
{
if
(
this
.
_id
)
{
return
this
.
_id
;
}
else
{
return
this
.
_id
=
+
+
gNextLoaderID
;
}
}
require
:
function
(
)
{
if
(
!
this
.
_provider
)
{
this
.
_loadProvider
(
)
;
}
return
this
.
require
.
apply
(
this
arguments
)
;
}
lazyRequireGetter
:
function
(
obj
property
module
destructure
)
{
Object
.
defineProperty
(
obj
property
{
get
:
(
)
=
>
{
delete
obj
[
property
]
;
let
value
=
destructure
?
this
.
require
(
module
)
[
property
]
:
this
.
require
(
module
|
|
property
)
;
Object
.
defineProperty
(
obj
property
{
value
writable
:
true
configurable
:
true
enumerable
:
true
}
)
;
return
value
;
}
configurable
:
true
enumerable
:
true
}
)
;
}
setProvider
:
function
(
provider
)
{
if
(
provider
=
=
=
this
.
_provider
)
{
return
;
}
if
(
this
.
_provider
)
{
delete
this
.
require
;
this
.
_provider
.
unload
(
"
newprovider
"
)
;
}
this
.
_provider
=
provider
;
this
.
_provider
.
invisibleToDebugger
=
this
.
invisibleToDebugger
;
this
.
_provider
.
globals
=
{
isWorker
:
false
reportError
:
Cu
.
reportError
atob
:
atob
btoa
:
btoa
_Iterator
:
Iterator
loader
:
{
lazyGetter
:
this
.
lazyGetter
lazyImporter
:
this
.
lazyImporter
lazyServiceGetter
:
this
.
lazyServiceGetter
lazyRequireGetter
:
this
.
lazyRequireGetter
id
:
this
.
id
}
define
(
factory
)
{
factory
(
this
.
require
this
.
exports
this
.
module
)
;
}
}
;
XPCOMUtils
.
defineLazyGetter
(
this
.
_provider
.
globals
"
console
"
(
)
=
>
{
return
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Console
.
jsm
"
{
}
)
.
console
;
}
)
;
this
.
_provider
.
load
(
)
;
this
.
require
=
Loader
.
Require
(
this
.
_provider
.
loader
{
id
:
"
devtools
"
}
)
;
}
_loadProvider
:
function
(
)
{
this
.
setProvider
(
new
BuiltinProvider
(
)
)
;
}
observe
:
function
(
subject
topic
data
)
{
if
(
topic
!
=
"
devtools
-
unload
"
)
{
return
;
}
Services
.
obs
.
removeObserver
(
this
"
devtools
-
unload
"
)
;
if
(
this
.
_provider
)
{
this
.
_provider
.
unload
(
data
)
;
delete
this
.
_provider
;
}
}
invisibleToDebugger
:
Services
.
appinfo
.
name
!
=
=
"
Firefox
"
}
;
this
.
devtools
=
this
.
loader
=
new
DevToolsLoader
(
)
;
this
.
require
=
this
.
devtools
.
require
.
bind
(
this
.
devtools
)
;
Object
.
defineProperty
(
this
.
devtools
"
Toolbox
"
{
get
:
(
)
=
>
this
.
require
(
"
devtools
/
client
/
framework
/
toolbox
"
)
.
Toolbox
}
)
;
Object
.
defineProperty
(
this
.
devtools
"
TargetFactory
"
{
get
:
(
)
=
>
this
.
require
(
"
devtools
/
client
/
framework
/
target
"
)
.
TargetFactory
}
)
;
