"
use
strict
"
;
var
{
Pool
}
=
require
(
"
resource
:
/
/
devtools
/
shared
/
protocol
/
Pool
.
js
"
)
;
loader
.
lazyRequireGetter
(
this
"
BULK_RESPONSE
"
"
resource
:
/
/
devtools
/
shared
/
protocol
/
types
.
js
"
true
)
;
var
actorSpecs
=
new
WeakMap
(
)
;
exports
.
actorSpecs
=
actorSpecs
;
class
Actor
extends
Pool
{
constructor
(
conn
spec
)
{
super
(
conn
)
;
this
.
typeName
=
spec
.
typeName
;
this
.
actorID
=
null
;
const
proto
=
Object
.
getPrototypeOf
(
this
)
;
if
(
!
proto
.
requestTypes
)
{
proto
.
requestTypes
=
generateRequestTypes
(
spec
)
;
}
if
(
spec
.
events
)
{
for
(
const
[
name
request
]
of
spec
.
events
.
entries
(
)
)
{
this
.
on
(
name
(
.
.
.
args
)
=
>
{
this
.
_sendEvent
(
name
request
.
.
.
args
)
;
}
)
;
}
}
}
toString
(
)
{
return
"
[
Actor
"
+
this
.
typeName
+
"
/
"
+
this
.
actorID
+
"
]
"
;
}
_sendEvent
(
name
request
.
.
.
args
)
{
if
(
this
.
isDestroyed
(
)
)
{
console
.
error
(
Tried
to
send
a
'
{
name
}
'
event
on
an
already
destroyed
actor
+
'
{
this
.
typeName
}
'
)
;
return
;
}
let
packet
;
try
{
packet
=
request
.
write
(
args
this
)
;
}
catch
(
ex
)
{
console
.
error
(
"
Error
sending
event
:
"
+
name
)
;
throw
ex
;
}
packet
.
from
=
packet
.
from
|
|
this
.
actorID
;
this
.
conn
.
send
(
packet
)
;
if
(
Services
.
profiler
?
.
IsActive
(
)
)
{
ChromeUtils
.
addProfilerMarker
(
"
DevTools
:
RDP
Actor
"
null
{
this
.
typeName
}
.
{
name
}
)
;
}
}
destroy
(
)
{
super
.
destroy
(
)
;
this
.
actorID
=
null
;
this
.
_isDestroyed
=
true
;
}
form
(
)
{
return
{
actor
:
this
.
actorID
}
;
}
writeError
(
error
typeName
method
)
{
console
.
error
(
Error
while
calling
actor
'
{
typeName
}
'
s
method
'
{
method
}
'
error
.
message
|
|
error
)
;
if
(
error
.
stack
)
{
console
.
error
(
error
)
;
}
if
(
this
.
isDestroyed
(
)
)
{
return
;
}
this
.
conn
.
send
(
{
from
:
this
.
actorID
error
:
error
.
error
|
|
error
.
name
|
|
(
typeof
error
=
=
"
string
"
?
error
:
"
unknownError
"
)
message
:
error
.
message
fileName
:
error
.
fileName
|
|
error
.
filename
lineNumber
:
error
.
lineNumber
columnNumber
:
error
.
columnNumber
stack
:
error
.
stack
}
)
;
}
_queueResponse
(
create
)
{
const
pending
=
this
.
_pendingResponse
|
|
Promise
.
resolve
(
null
)
;
const
response
=
create
(
pending
)
;
this
.
_pendingResponse
=
response
;
}
throwError
(
error
message
)
{
const
err
=
new
Error
(
message
)
;
err
.
error
=
error
;
throw
err
;
}
}
exports
.
Actor
=
Actor
;
var
generateRequestTypes
=
function
(
actorSpec
)
{
const
requestTypes
=
Object
.
create
(
null
)
;
actorSpec
.
methods
.
forEach
(
spec
=
>
{
const
handler
=
function
(
packet
conn
)
{
try
{
const
startTime
=
isWorker
?
null
:
ChromeUtils
.
now
(
)
;
let
args
;
try
{
args
=
spec
.
request
.
read
(
packet
this
)
;
}
catch
(
ex
)
{
console
.
error
(
"
Error
reading
request
:
"
+
packet
.
type
)
;
throw
ex
;
}
if
(
!
this
[
spec
.
name
]
)
{
throw
new
Error
(
Spec
for
'
{
actorSpec
.
typeName
}
'
specifies
a
'
{
spec
.
name
}
'
+
method
that
isn
'
t
implemented
by
the
actor
)
;
}
const
isBulkResponse
=
spec
.
response
.
template
=
=
=
BULK_RESPONSE
;
if
(
isBulkResponse
)
{
args
.
push
(
length
=
>
{
return
this
.
conn
.
startBulkSend
(
{
actor
:
this
.
actorID
length
}
)
;
}
)
;
}
const
ret
=
this
[
spec
.
name
]
.
apply
(
this
args
)
;
const
sendReturn
=
retToSend
=
>
{
if
(
spec
.
oneway
)
{
return
;
}
if
(
isBulkResponse
)
{
if
(
retToSend
)
{
throw
new
Actor
(
Actor
method
'
{
this
.
typeName
}
.
{
spec
.
name
}
'
is
supposed
to
return
a
bulk
response
but
returned
some
value
.
)
;
}
return
;
}
if
(
this
.
isDestroyed
(
)
)
{
console
.
error
(
Tried
to
send
a
'
{
spec
.
name
}
'
method
reply
on
an
already
destroyed
actor
+
'
{
this
.
typeName
}
'
)
;
return
;
}
let
response
;
try
{
response
=
spec
.
response
.
write
(
retToSend
this
)
;
}
catch
(
ex
)
{
console
.
error
(
"
Error
writing
response
to
:
"
+
spec
.
name
)
;
throw
ex
;
}
response
.
from
=
this
.
actorID
;
if
(
spec
.
release
)
{
try
{
this
.
destroy
(
)
;
}
catch
(
e
)
{
this
.
writeError
(
e
actorSpec
.
typeName
spec
.
name
)
;
return
;
}
}
conn
.
send
(
response
)
;
ChromeUtils
.
addProfilerMarker
(
"
DevTools
:
RDP
Actor
"
startTime
{
actorSpec
.
typeName
}
:
{
spec
.
name
}
(
)
)
;
}
;
this
.
_queueResponse
(
p
=
>
{
return
p
.
then
(
(
)
=
>
ret
)
.
then
(
sendReturn
)
.
catch
(
e
=
>
this
.
writeError
(
e
actorSpec
.
typeName
spec
.
name
)
)
;
}
)
;
}
catch
(
e
)
{
this
.
_queueResponse
(
p
=
>
{
return
p
.
then
(
(
)
=
>
this
.
writeError
(
e
actorSpec
.
typeName
spec
.
name
)
)
;
}
)
;
}
}
;
requestTypes
[
spec
.
request
.
type
]
=
handler
;
}
)
;
return
requestTypes
;
}
;
exports
.
generateRequestTypes
=
generateRequestTypes
;
