"
use
strict
"
;
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
{
DebuggerServer
}
=
require
(
"
devtools
/
server
/
debugger
-
server
"
)
;
const
{
DebuggerClient
}
=
require
(
"
devtools
/
shared
/
client
/
debugger
-
client
"
)
;
const
defer
=
require
(
"
devtools
/
shared
/
defer
"
)
;
function
dumpn
(
msg
)
{
dump
(
"
DBG
-
TEST
:
"
+
msg
+
"
\
n
"
)
;
}
function
connectPipeTracing
(
)
{
return
new
TracingTransport
(
DebuggerServer
.
connectPipe
(
)
)
;
}
function
TracingTransport
(
childTransport
)
{
this
.
hooks
=
null
;
this
.
child
=
childTransport
;
this
.
child
.
hooks
=
this
;
this
.
expectations
=
[
]
;
this
.
packets
=
[
]
;
this
.
checkIndex
=
0
;
}
TracingTransport
.
prototype
=
{
normalize
:
function
(
packet
)
{
return
JSON
.
parse
(
JSON
.
stringify
(
packet
(
key
value
)
=
>
{
if
(
key
=
=
=
"
to
"
|
|
key
=
=
=
"
from
"
|
|
key
=
=
=
"
actor
"
)
{
return
"
<
actorid
>
"
;
}
return
value
;
}
)
)
;
}
send
:
function
(
packet
)
{
this
.
packets
.
push
(
{
type
:
"
sent
"
packet
:
this
.
normalize
(
packet
)
}
)
;
return
this
.
child
.
send
(
packet
)
;
}
close
:
function
(
)
{
return
this
.
child
.
close
(
)
;
}
ready
:
function
(
)
{
return
this
.
child
.
ready
(
)
;
}
onPacket
:
function
(
packet
)
{
this
.
packets
.
push
(
{
type
:
"
received
"
packet
:
this
.
normalize
(
packet
)
}
)
;
this
.
hooks
.
onPacket
(
packet
)
;
}
onClosed
:
function
(
)
{
this
.
hooks
.
onClosed
(
)
;
}
expectSend
:
function
(
expected
)
{
const
packet
=
this
.
packets
[
this
.
checkIndex
+
+
]
;
Assert
.
equal
(
packet
.
type
"
sent
"
)
;
deepEqual
(
packet
.
packet
this
.
normalize
(
expected
)
)
;
}
expectReceive
:
function
(
expected
)
{
const
packet
=
this
.
packets
[
this
.
checkIndex
+
+
]
;
Assert
.
equal
(
packet
.
type
"
received
"
)
;
deepEqual
(
packet
.
packet
this
.
normalize
(
expected
)
)
;
}
dumpLog
:
function
(
)
{
for
(
const
entry
of
this
.
packets
)
{
if
(
entry
.
type
=
=
=
"
sent
"
)
{
dumpn
(
"
trace
.
expectSend
(
"
+
entry
.
packet
+
"
)
;
"
)
;
}
else
{
dumpn
(
"
trace
.
expectReceive
(
"
+
entry
.
packet
+
"
)
;
"
)
;
}
}
}
}
;
