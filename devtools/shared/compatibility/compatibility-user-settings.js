"
use
strict
"
;
const
{
RemoteSettings
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
services
-
settings
/
remote
-
settings
.
sys
.
mjs
"
)
;
loader
.
lazyRequireGetter
(
this
[
"
TARGET_BROWSER_ID
"
"
TARGET_BROWSER_STATUS
"
"
TARGET_BROWSER_PREF
"
]
"
resource
:
/
/
devtools
/
shared
/
compatibility
/
constants
.
js
"
true
)
;
class
TargetBrowserFilter
{
async
filterEntry
(
record
)
{
if
(
!
TARGET_BROWSER_ID
.
includes
(
record
.
browserid
)
|
|
!
TARGET_BROWSER_STATUS
.
includes
(
record
.
status
)
)
{
return
null
;
}
return
{
id
:
record
.
browserid
name
:
record
.
name
version
:
record
.
version
status
:
record
.
status
}
;
}
}
async
function
getBrowsersList
(
)
{
const
records
=
await
RemoteSettings
(
"
devtools
-
compatibility
-
browsers
"
{
filterCreator
:
async
(
)
=
>
new
TargetBrowserFilter
(
)
}
)
.
get
(
)
;
const
numericCollator
=
new
Intl
.
Collator
(
[
]
{
numeric
:
true
}
)
;
records
.
sort
(
(
a
b
)
=
>
{
if
(
a
.
id
=
=
b
.
id
)
{
return
numericCollator
.
compare
(
a
.
version
b
.
version
)
;
}
return
a
.
id
>
b
.
id
?
1
:
-
1
;
}
)
;
return
records
.
filter
(
(
record
index
arr
)
=
>
{
const
nextRecord
=
arr
[
index
+
1
]
;
if
(
nextRecord
&
&
record
.
id
=
=
=
nextRecord
.
id
&
&
record
.
status
=
=
=
nextRecord
.
status
)
{
return
false
;
}
return
true
;
}
)
;
}
async
function
getTargetBrowsers
(
)
{
const
targetsString
=
Services
.
prefs
.
getCharPref
(
TARGET_BROWSER_PREF
"
"
)
;
const
browsers
=
await
getBrowsersList
(
)
;
if
(
!
targetsString
)
{
return
browsers
;
}
const
selectedBrowsersAndStatuses
=
JSON
.
parse
(
targetsString
)
;
return
browsers
.
filter
(
browser
=
>
!
!
selectedBrowsersAndStatuses
.
find
(
(
{
id
status
}
)
=
>
browser
.
id
=
=
id
&
&
browser
.
status
=
=
status
)
)
;
}
function
setTargetBrowsers
(
browsers
)
{
Services
.
prefs
.
setCharPref
(
TARGET_BROWSER_PREF
JSON
.
stringify
(
browsers
.
map
(
browser
=
>
(
{
id
:
browser
.
id
status
:
browser
.
status
}
)
)
)
)
;
}
module
.
exports
=
{
getBrowsersList
getTargetBrowsers
setTargetBrowsers
}
;
