"
use
strict
"
;
(
function
(
factory
)
{
if
(
this
.
module
&
&
module
.
id
.
includes
(
"
worker
"
)
)
{
const
{
Cc
Ci
Cu
ChromeWorker
}
=
require
(
"
chrome
"
)
;
const
dumpn
=
require
(
"
devtools
/
shared
/
DevToolsUtils
"
)
.
dumpn
;
factory
.
call
(
this
require
exports
module
{
Cc
Ci
Cu
}
ChromeWorker
dumpn
)
;
}
else
{
const
{
require
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
devtools
/
shared
/
Loader
.
jsm
"
)
;
this
.
isWorker
=
false
;
this
.
Promise
=
require
(
"
resource
:
/
/
gre
/
modules
/
Promise
.
jsm
"
)
.
Promise
;
this
.
console
=
console
;
factory
.
call
(
this
require
this
{
exports
:
this
}
{
Cc
Ci
Cu
}
ChromeWorker
null
)
;
this
.
EXPORTED_SYMBOLS
=
[
"
DevToolsWorker
"
]
;
}
}
)
.
call
(
this
function
(
require
exports
module
{
Ci
Cc
}
ChromeWorker
dumpn
)
{
let
MESSAGE_COUNTER
=
0
;
function
DevToolsWorker
(
url
opts
)
{
opts
=
opts
|
|
{
}
;
this
.
_worker
=
new
ChromeWorker
(
url
)
;
this
.
_verbose
=
opts
.
verbose
;
this
.
_name
=
opts
.
name
;
this
.
_worker
.
addEventListener
(
"
error
"
this
.
onError
)
;
}
exports
.
DevToolsWorker
=
DevToolsWorker
;
DevToolsWorker
.
prototype
.
performTask
=
function
(
task
data
transfer
)
{
if
(
this
.
_destroyed
)
{
return
Promise
.
reject
(
"
Cannot
call
performTask
on
a
destroyed
DevToolsWorker
"
)
;
}
const
worker
=
this
.
_worker
;
const
id
=
+
+
MESSAGE_COUNTER
;
const
payload
=
{
task
id
data
}
;
if
(
this
.
_verbose
&
&
dumpn
)
{
dumpn
(
"
Sending
message
to
worker
"
+
(
this
.
_name
?
(
"
(
"
+
this
.
_name
+
"
)
"
)
:
"
"
)
+
"
:
"
+
JSON
.
stringify
(
payload
null
2
)
)
;
}
worker
.
postMessage
(
payload
transfer
)
;
return
new
Promise
(
(
resolve
reject
)
=
>
{
const
listener
=
(
{
data
:
result
}
)
=
>
{
if
(
this
.
_verbose
&
&
dumpn
)
{
dumpn
(
"
Received
message
from
worker
"
+
(
this
.
_name
?
(
"
(
"
+
this
.
_name
+
"
)
"
)
:
"
"
)
+
"
:
"
+
JSON
.
stringify
(
result
null
2
)
)
;
}
if
(
result
.
id
!
=
=
id
)
{
return
;
}
worker
.
removeEventListener
(
"
message
"
listener
)
;
if
(
result
.
error
)
{
reject
(
result
.
error
)
;
}
else
{
resolve
(
result
.
response
)
;
}
}
;
worker
.
addEventListener
(
"
message
"
listener
)
;
}
)
;
}
;
DevToolsWorker
.
prototype
.
destroy
=
function
(
)
{
this
.
_worker
.
terminate
(
)
;
this
.
_worker
=
null
;
this
.
_destroyed
=
true
;
}
;
DevToolsWorker
.
prototype
.
onError
=
function
(
{
message
filename
lineno
}
)
{
dump
(
new
Error
(
message
+
"
"
+
filename
+
"
:
"
+
lineno
)
+
"
\
n
"
)
;
}
;
function
workerify
(
fn
)
{
console
.
warn
(
"
workerify
should
only
be
used
in
tests
or
measuring
performance
.
"
+
"
This
creates
an
object
URL
on
the
browser
window
and
should
not
be
"
+
"
used
in
production
.
"
)
;
const
Services
=
require
(
"
Services
"
)
;
const
{
URL
Blob
}
=
Services
.
wm
.
getMostRecentWindow
(
"
navigator
:
browser
"
)
;
const
stringifiedFn
=
createWorkerString
(
fn
)
;
const
blob
=
new
Blob
(
[
stringifiedFn
]
)
;
const
url
=
URL
.
createObjectURL
(
blob
)
;
const
worker
=
new
DevToolsWorker
(
url
)
;
const
wrapperFn
=
(
data
transfer
)
=
>
worker
.
performTask
(
"
workerifiedTask
"
data
transfer
)
;
wrapperFn
.
destroy
=
function
(
)
{
URL
.
revokeObjectURL
(
url
)
;
worker
.
destroy
(
)
;
}
;
return
wrapperFn
;
}
exports
.
workerify
=
workerify
;
function
createWorkerString
(
fn
)
{
return
importScripts
(
"
resource
:
/
/
gre
/
modules
/
workers
/
require
.
js
"
)
;
const
{
createTask
}
=
require
(
"
resource
:
/
/
devtools
/
shared
/
worker
/
helper
.
js
"
)
;
createTask
(
self
"
workerifiedTask
"
{
fn
.
toString
(
)
}
)
;
;
}
}
)
;
