"
use
strict
"
;
const
{
arg
DebuggerClient
}
=
require
(
"
devtools
/
shared
/
client
/
debugger
-
client
"
)
;
const
noop
=
(
)
=
>
{
}
;
function
SourceClient
(
client
form
)
{
this
.
_form
=
form
;
this
.
_activeThread
=
client
;
this
.
_client
=
client
.
client
;
}
SourceClient
.
prototype
=
{
get
_transport
(
)
{
return
this
.
_client
.
_transport
;
}
get
actor
(
)
{
return
this
.
_form
.
actor
;
}
get
request
(
)
{
return
this
.
_client
.
request
;
}
get
url
(
)
{
return
this
.
_form
.
url
;
}
blackBox
:
DebuggerClient
.
requester
(
{
type
:
"
blackbox
"
range
:
arg
(
0
)
}
{
telemetry
:
"
BLACKBOX
"
}
)
unblackBox
:
DebuggerClient
.
requester
(
{
type
:
"
unblackbox
"
range
:
arg
(
0
)
}
{
telemetry
:
"
UNBLACKBOX
"
}
)
getExecutableLines
:
function
(
cb
=
noop
)
{
const
packet
=
{
to
:
this
.
_form
.
actor
type
:
"
getExecutableLines
"
}
;
return
this
.
_client
.
request
(
packet
)
.
then
(
res
=
>
{
cb
(
res
.
lines
)
;
return
res
.
lines
;
}
)
;
}
getBreakpointPositions
:
function
(
query
)
{
const
packet
=
{
to
:
this
.
_form
.
actor
type
:
"
getBreakpointPositions
"
query
}
;
return
this
.
_client
.
request
(
packet
)
;
}
getBreakpointPositionsCompressed
:
function
(
query
)
{
const
packet
=
{
to
:
this
.
_form
.
actor
type
:
"
getBreakpointPositionsCompressed
"
query
}
;
return
this
.
_client
.
request
(
packet
)
;
}
source
:
function
(
)
{
const
packet
=
{
to
:
this
.
_form
.
actor
type
:
"
source
"
}
;
return
this
.
_client
.
request
(
packet
)
.
then
(
response
=
>
{
return
this
.
_onSourceResponse
(
response
)
;
}
)
;
}
_onSourceResponse
:
function
(
response
)
{
if
(
typeof
response
.
source
=
=
=
"
string
"
)
{
return
response
;
}
const
{
contentType
source
}
=
response
;
if
(
source
.
type
=
=
=
"
arrayBuffer
"
)
{
const
arrayBuffer
=
this
.
_activeThread
.
threadArrayBuffer
(
source
)
;
return
arrayBuffer
.
slice
(
0
arrayBuffer
.
length
)
.
then
(
function
(
resp
)
{
if
(
resp
.
error
)
{
return
resp
;
}
const
str
=
atob
(
resp
.
encoded
)
;
const
newResponse
=
{
source
:
{
binary
:
str
toString
:
(
)
=
>
"
[
wasm
]
"
}
contentType
}
;
return
newResponse
;
}
)
;
}
const
longString
=
this
.
_activeThread
.
threadLongString
(
source
)
;
return
longString
.
substring
(
0
longString
.
length
)
.
then
(
function
(
resp
)
{
if
(
resp
.
error
)
{
return
resp
;
}
const
newResponse
=
{
source
:
resp
.
substring
contentType
:
contentType
}
;
return
newResponse
;
}
)
;
}
setPausePoints
:
function
(
pausePoints
)
{
const
packet
=
{
to
:
this
.
_form
.
actor
type
:
"
setPausePoints
"
pausePoints
}
;
return
this
.
_client
.
request
(
packet
)
;
}
}
;
module
.
exports
=
SourceClient
;
