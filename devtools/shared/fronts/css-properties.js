"
use
strict
"
;
const
{
FrontClassWithSpec
Front
}
=
require
(
"
devtools
/
shared
/
protocol
"
)
;
const
{
cssPropertiesSpec
}
=
require
(
"
devtools
/
shared
/
specs
/
css
-
properties
"
)
;
const
{
Task
}
=
require
(
"
devtools
/
shared
/
task
"
)
;
const
{
CSS_PROPERTIES_DB
}
=
require
(
"
devtools
/
shared
/
css
-
properties
-
db
"
)
;
const
{
cssColors
}
=
require
(
"
devtools
/
shared
/
css
-
color
-
db
"
)
;
var
NON_ASCII
=
"
[
^
\
\
x00
-
\
\
x7F
]
"
;
var
ESCAPE
=
"
\
\
\
\
[
^
\
n
\
r
]
"
;
var
FIRST_CHAR
=
[
"
[
_a
-
z
]
"
NON_ASCII
ESCAPE
]
.
join
(
"
|
"
)
;
var
TRAILING_CHAR
=
[
"
[
_a
-
z0
-
9
-
]
"
NON_ASCII
ESCAPE
]
.
join
(
"
|
"
)
;
var
IS_VARIABLE_TOKEN
=
new
RegExp
(
^
-
-
(
{
FIRST_CHAR
}
)
(
{
TRAILING_CHAR
}
)
*
"
i
"
)
;
function
isCssVariable
(
input
)
{
return
!
!
input
.
match
(
IS_VARIABLE_TOKEN
)
;
}
var
cachedCssProperties
=
new
WeakMap
(
)
;
const
CssPropertiesFront
=
FrontClassWithSpec
(
cssPropertiesSpec
{
initialize
:
function
(
client
{
cssPropertiesActor
}
)
{
Front
.
prototype
.
initialize
.
call
(
this
client
{
actor
:
cssPropertiesActor
}
)
;
this
.
manage
(
this
)
;
}
}
)
;
function
CssProperties
(
db
)
{
this
.
properties
=
db
.
properties
;
this
.
pseudoElements
=
db
.
pseudoElements
;
this
.
isKnown
=
this
.
isKnown
.
bind
(
this
)
;
this
.
isInherited
=
this
.
isInherited
.
bind
(
this
)
;
this
.
supportsType
=
this
.
supportsType
.
bind
(
this
)
;
}
CssProperties
.
prototype
=
{
isKnown
(
property
)
{
return
!
!
this
.
properties
[
property
]
|
|
isCssVariable
(
property
)
;
}
isInherited
(
property
)
{
return
this
.
properties
[
property
]
&
&
this
.
properties
[
property
]
.
isInherited
;
}
supportsType
(
property
type
)
{
return
this
.
properties
[
property
]
&
&
this
.
properties
[
property
]
.
supports
.
includes
(
type
)
;
}
getValues
(
property
)
{
return
this
.
properties
[
property
]
?
this
.
properties
[
property
]
.
values
:
[
]
;
}
getNames
(
property
)
{
return
Object
.
keys
(
this
.
properties
)
;
}
}
;
const
initCssProperties
=
Task
.
async
(
function
*
(
toolbox
)
{
const
client
=
toolbox
.
target
.
client
;
if
(
cachedCssProperties
.
has
(
client
)
)
{
return
cachedCssProperties
.
get
(
client
)
;
}
let
db
front
;
if
(
toolbox
.
target
.
hasActor
(
"
cssProperties
"
)
)
{
front
=
CssPropertiesFront
(
client
toolbox
.
target
.
form
)
;
const
serverDB
=
yield
front
.
getCSSDatabase
(
getClientBrowserVersion
(
toolbox
)
)
;
if
(
!
serverDB
.
properties
&
&
!
serverDB
.
margin
)
{
db
=
CSS_PROPERTIES_DB
;
}
else
{
db
=
serverDB
;
}
}
else
{
db
=
CSS_PROPERTIES_DB
;
}
const
cssProperties
=
new
CssProperties
(
normalizeCssData
(
db
)
)
;
cachedCssProperties
.
set
(
client
{
cssProperties
front
}
)
;
return
{
cssProperties
front
}
;
}
)
;
function
getCssProperties
(
toolbox
)
{
if
(
!
cachedCssProperties
.
has
(
toolbox
.
target
.
client
)
)
{
throw
new
Error
(
"
The
CSS
database
has
not
been
initialized
please
make
"
+
"
sure
initCssDatabase
was
called
once
before
for
this
"
+
"
toolbox
.
"
)
;
}
return
cachedCssProperties
.
get
(
toolbox
.
target
.
client
)
.
cssProperties
;
}
function
getClientCssProperties
(
)
{
return
new
CssProperties
(
normalizeCssData
(
CSS_PROPERTIES_DB
)
)
;
}
function
getClientBrowserVersion
(
toolbox
)
{
if
(
!
toolbox
.
_host
)
{
return
"
0
"
;
}
const
regexResult
=
toolbox
.
_host
.
frame
.
contentWindow
.
navigator
.
userAgent
.
match
(
/
Firefox
\
/
(
\
d
+
)
\
.
\
d
/
)
;
return
Array
.
isArray
(
regexResult
)
?
regexResult
[
1
]
:
"
0
"
;
}
function
normalizeCssData
(
db
)
{
if
(
db
!
=
=
CSS_PROPERTIES_DB
)
{
if
(
!
db
.
properties
)
{
db
=
{
properties
:
db
}
;
}
db
=
Object
.
assign
(
{
}
CSS_PROPERTIES_DB
db
)
;
if
(
!
db
.
properties
.
color
.
supports
)
{
for
(
let
name
in
db
.
properties
)
{
if
(
typeof
CSS_PROPERTIES_DB
.
properties
[
name
]
=
=
=
"
object
"
)
{
db
.
properties
[
name
]
.
supports
=
CSS_PROPERTIES_DB
.
properties
[
name
]
.
supports
;
}
}
}
if
(
!
db
.
properties
.
color
.
values
)
{
for
(
let
name
in
db
.
properties
)
{
if
(
typeof
CSS_PROPERTIES_DB
.
properties
[
name
]
=
=
=
"
object
"
)
{
db
.
properties
[
name
]
.
values
=
CSS_PROPERTIES_DB
.
properties
[
name
]
.
values
;
}
}
}
}
reattachCssColorValues
(
db
)
;
return
db
;
}
function
reattachCssColorValues
(
db
)
{
if
(
db
.
properties
.
color
.
values
[
0
]
=
=
=
"
COLOR
"
)
{
const
colors
=
Object
.
keys
(
cssColors
)
;
for
(
let
name
in
db
.
properties
)
{
const
property
=
db
.
properties
[
name
]
;
if
(
property
.
values
[
0
]
=
=
=
"
COLOR
"
)
{
property
.
values
.
shift
(
)
;
property
.
values
=
property
.
values
.
concat
(
colors
)
.
sort
(
)
;
}
}
}
}
module
.
exports
=
{
CssPropertiesFront
CssProperties
getCssProperties
getClientCssProperties
initCssProperties
}
;
