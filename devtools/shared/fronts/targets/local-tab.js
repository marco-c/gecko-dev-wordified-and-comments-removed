"
use
strict
"
;
const
Services
=
require
(
"
Services
"
)
;
loader
.
lazyRequireGetter
(
this
"
gDevTools
"
"
devtools
/
client
/
framework
/
devtools
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
TargetFactory
"
"
devtools
/
client
/
framework
/
target
"
true
)
;
loader
.
lazyRequireGetter
(
this
"
BrowsingContextTargetFront
"
"
devtools
/
shared
/
fronts
/
targets
/
browsing
-
context
"
true
)
;
class
LocalTabTargetFront
extends
BrowsingContextTargetFront
{
constructor
(
client
targetFront
parentFront
tab
)
{
super
(
client
targetFront
parentFront
)
;
this
.
_teardownTabListeners
=
this
.
_teardownTabListeners
.
bind
(
this
)
;
this
.
_handleTabEvent
=
this
.
_handleTabEvent
.
bind
(
this
)
;
this
.
_tab
=
tab
;
this
.
_setupTabListeners
(
)
;
this
.
once
(
"
close
"
this
.
_teardownTabListeners
)
;
}
get
isLocalTab
(
)
{
return
true
;
}
get
tab
(
)
{
return
this
.
_tab
;
}
get
contentPrincipal
(
)
{
return
this
.
tab
.
linkedBrowser
.
contentPrincipal
;
}
get
csp
(
)
{
return
this
.
tab
.
linkedBrowser
.
csp
;
}
toString
(
)
{
return
Target
:
{
this
.
tab
}
;
}
_setupTabListeners
(
)
{
this
.
tab
.
addEventListener
(
"
TabClose
"
this
.
_handleTabEvent
)
;
this
.
tab
.
ownerDocument
.
defaultView
.
addEventListener
(
"
unload
"
this
.
_handleTabEvent
)
;
this
.
tab
.
addEventListener
(
"
TabRemotenessChange
"
this
.
_handleTabEvent
)
;
}
_teardownTabListeners
(
)
{
if
(
this
.
tab
.
ownerDocument
.
defaultView
)
{
this
.
tab
.
ownerDocument
.
defaultView
.
removeEventListener
(
"
unload
"
this
.
_handleTabEvent
)
;
}
this
.
tab
.
removeEventListener
(
"
TabClose
"
this
.
_handleTabEvent
)
;
this
.
tab
.
removeEventListener
(
"
TabRemotenessChange
"
this
.
_handleTabEvent
)
;
}
async
_handleTabEvent
(
event
)
{
switch
(
event
.
type
)
{
case
"
TabClose
"
:
const
toolbox
=
gDevTools
.
getToolbox
(
this
)
;
if
(
toolbox
)
{
await
toolbox
.
destroy
(
)
;
}
break
;
case
"
unload
"
:
this
.
destroy
(
)
;
break
;
case
"
TabRemotenessChange
"
:
this
.
_onRemotenessChange
(
)
;
break
;
}
}
async
_onRemotenessChange
(
)
{
if
(
this
.
tab
.
isResponsiveDesignMode
)
{
return
;
}
const
toolbox
=
gDevTools
.
getToolbox
(
this
)
;
const
targetSwitchingEnabled
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
target
-
switching
.
enabled
"
false
)
;
const
client
=
this
.
client
;
if
(
targetSwitchingEnabled
)
{
this
.
shouldCloseClient
=
false
;
await
this
.
once
(
"
close
"
)
;
}
else
{
await
toolbox
.
destroy
(
)
;
}
const
newTarget
=
await
TargetFactory
.
forTab
(
this
.
tab
targetSwitchingEnabled
?
client
:
null
)
;
if
(
targetSwitchingEnabled
)
{
this
.
shouldCloseClient
=
true
;
toolbox
.
switchToTarget
(
newTarget
)
;
}
else
{
gDevTools
.
showToolbox
(
newTarget
)
;
}
}
}
exports
.
LocalTabTargetFront
=
LocalTabTargetFront
;
