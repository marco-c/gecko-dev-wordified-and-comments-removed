#
include
"
mozilla
/
devtools
/
HeapSnapshot
.
h
"
#
include
"
mozilla
/
devtools
/
HeapSnapshotTempFileHelperParent
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
private
/
pprio
.
h
"
#
include
"
nsIFile
.
h
"
namespace
mozilla
{
namespace
devtools
{
using
ipc
:
:
FileDescriptor
;
static
bool
openFileFailure
(
ErrorResult
&
rv
OpenHeapSnapshotTempFileResponse
*
outResponse
)
{
*
outResponse
=
rv
.
StealNSResult
(
)
;
return
true
;
}
bool
HeapSnapshotTempFileHelperParent
:
:
RecvOpenHeapSnapshotTempFile
(
OpenHeapSnapshotTempFileResponse
*
outResponse
)
{
auto
start
=
TimeStamp
:
:
Now
(
)
;
ErrorResult
rv
;
nsAutoString
filePath
;
nsCOMPtr
<
nsIFile
>
file
=
HeapSnapshot
:
:
CreateUniqueCoreDumpFile
(
rv
start
filePath
)
;
if
(
NS_WARN_IF
(
rv
.
Failed
(
)
)
)
return
openFileFailure
(
rv
outResponse
)
;
PRFileDesc
*
prfd
;
rv
=
file
-
>
OpenNSPRFileDesc
(
PR_WRONLY
0
&
prfd
)
;
if
(
NS_WARN_IF
(
rv
.
Failed
(
)
)
)
return
openFileFailure
(
rv
outResponse
)
;
FileDescriptor
:
:
PlatformHandleType
handle
=
FileDescriptor
:
:
PlatformHandleType
(
PR_FileDesc2NativeHandle
(
prfd
)
)
;
FileDescriptor
fd
(
handle
)
;
*
outResponse
=
OpenedFile
(
filePath
fd
)
;
return
true
;
}
}
}
