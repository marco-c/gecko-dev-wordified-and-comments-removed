"
use
strict
"
;
importScripts
(
"
resource
:
/
/
gre
/
modules
/
workers
/
require
.
js
"
)
;
importScripts
(
"
resource
:
/
/
devtools
/
shared
/
worker
/
helper
.
js
"
)
;
const
{
censusReportToCensusTreeNode
}
=
require
(
"
resource
:
/
/
devtools
/
shared
/
heapsnapshot
/
census
-
tree
-
node
.
js
"
)
;
const
CensusUtils
=
require
(
"
resource
:
/
/
devtools
/
shared
/
heapsnapshot
/
CensusUtils
.
js
"
)
;
const
snapshots
=
Object
.
create
(
null
)
;
workerHelper
.
createTask
(
self
"
readHeapSnapshot
"
(
{
snapshotFilePath
}
)
=
>
{
snapshots
[
snapshotFilePath
]
=
ThreadSafeChromeUtils
.
readHeapSnapshot
(
snapshotFilePath
)
;
return
true
;
}
)
;
workerHelper
.
createTask
(
self
"
takeCensus
"
(
{
snapshotFilePath
censusOptions
requestOptions
}
)
=
>
{
if
(
!
snapshots
[
snapshotFilePath
]
)
{
throw
new
Error
(
No
known
heap
snapshot
for
'
{
snapshotFilePath
}
'
)
;
}
const
report
=
snapshots
[
snapshotFilePath
]
.
takeCensus
(
censusOptions
)
;
if
(
requestOptions
.
asTreeNode
|
|
requestOptions
.
asInvertedTreeNode
)
{
const
opts
=
{
filter
:
requestOptions
.
filter
|
|
null
}
;
if
(
requestOptions
.
asInvertedTreeNode
)
{
opts
.
invert
=
true
;
}
return
censusReportToCensusTreeNode
(
censusOptions
.
breakdown
report
opts
)
;
}
return
report
;
}
)
;
workerHelper
.
createTask
(
self
"
takeCensusDiff
"
request
=
>
{
const
{
firstSnapshotFilePath
secondSnapshotFilePath
censusOptions
requestOptions
}
=
request
;
if
(
!
snapshots
[
firstSnapshotFilePath
]
)
{
throw
new
Error
(
No
known
heap
snapshot
for
'
{
firstSnapshotFilePath
}
'
)
;
}
if
(
!
snapshots
[
secondSnapshotFilePath
]
)
{
throw
new
Error
(
No
known
heap
snapshot
for
'
{
secondSnapshotFilePath
}
'
)
;
}
const
first
=
snapshots
[
firstSnapshotFilePath
]
.
takeCensus
(
censusOptions
)
;
const
second
=
snapshots
[
secondSnapshotFilePath
]
.
takeCensus
(
censusOptions
)
;
const
delta
=
CensusUtils
.
diff
(
censusOptions
.
breakdown
first
second
)
;
if
(
requestOptions
.
asTreeNode
)
{
return
censusReportToCensusTreeNode
(
censusOptions
.
breakdown
delta
)
;
}
else
if
(
requestOptions
.
asInvertedTreeNode
)
{
return
censusReportToCensusTreeNode
(
censusOptions
.
breakdown
delta
{
invert
:
true
}
)
;
}
else
{
return
delta
;
}
}
)
;
workerHelper
.
createTask
(
self
"
getCreationTime
"
(
snapshotFilePath
)
=
>
{
let
snapshot
=
snapshots
[
snapshotFilePath
]
;
return
snapshot
?
snapshot
.
creationTime
:
null
;
}
)
;
