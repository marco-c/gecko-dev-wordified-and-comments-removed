"
use
strict
"
;
var
{
Ci
}
=
require
(
"
chrome
"
)
;
var
Services
=
require
(
"
Services
"
)
;
var
DevToolsUtils
=
require
(
"
devtools
/
shared
/
DevToolsUtils
"
)
;
loader
.
lazyRequireGetter
(
this
"
AuthenticationResult
"
"
devtools
/
shared
/
security
/
auth
"
true
)
;
const
{
LocalizationHelper
}
=
require
(
"
devtools
/
shared
/
l10n
"
)
;
const
L10N
=
new
LocalizationHelper
(
"
devtools
/
shared
/
locales
/
debugger
.
properties
"
)
;
var
Client
=
exports
.
Client
=
{
}
;
var
Server
=
exports
.
Server
=
{
}
;
Client
.
defaultSendOOB
=
(
{
authResult
oob
}
)
=
>
{
if
(
authResult
!
=
AuthenticationResult
.
PENDING
)
{
throw
new
Error
(
"
Expected
PENDING
result
got
"
+
authResult
)
;
}
const
title
=
L10N
.
getStr
(
"
clientSendOOBTitle
"
)
;
const
header
=
L10N
.
getStr
(
"
clientSendOOBHeader
"
)
;
const
hashMsg
=
L10N
.
getFormatStr
(
"
clientSendOOBHash
"
oob
.
sha256
)
;
const
token
=
oob
.
sha256
.
replace
(
/
:
/
g
"
"
)
.
toLowerCase
(
)
+
oob
.
k
;
const
tokenMsg
=
L10N
.
getFormatStr
(
"
clientSendOOBToken
"
token
)
;
const
msg
=
{
header
}
\
n
\
n
{
hashMsg
}
\
n
{
tokenMsg
}
;
const
prompt
=
Services
.
prompt
;
const
flags
=
prompt
.
BUTTON_POS_0
*
prompt
.
BUTTON_TITLE_CANCEL
;
let
promptWindow
;
const
windowListener
=
{
onOpenWindow
(
xulWindow
)
{
const
win
=
xulWindow
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDOMWindow
)
;
win
.
addEventListener
(
"
load
"
function
(
)
{
if
(
win
.
document
.
documentElement
.
getAttribute
(
"
id
"
)
!
=
"
commonDialog
"
)
{
return
;
}
promptWindow
=
win
;
Services
.
wm
.
removeListener
(
windowListener
)
;
}
{
once
:
true
}
)
;
}
onCloseWindow
(
)
{
}
}
;
Services
.
wm
.
addListener
(
windowListener
)
;
DevToolsUtils
.
executeSoon
(
(
)
=
>
{
prompt
.
confirmEx
(
null
title
msg
flags
null
null
null
null
{
value
:
false
}
)
;
}
)
;
return
{
close
(
)
{
if
(
!
promptWindow
)
{
return
;
}
promptWindow
.
document
.
documentElement
.
acceptDialog
(
)
;
promptWindow
=
null
;
}
}
;
}
;
Server
.
defaultAllowConnection
=
(
{
client
server
}
)
=
>
{
const
title
=
L10N
.
getStr
(
"
remoteIncomingPromptTitle
"
)
;
const
header
=
L10N
.
getStr
(
"
remoteIncomingPromptHeader
"
)
;
const
clientEndpoint
=
{
client
.
host
}
:
{
client
.
port
}
;
const
clientMsg
=
L10N
.
getFormatStr
(
"
remoteIncomingPromptClientEndpoint
"
clientEndpoint
)
;
const
serverEndpoint
=
{
server
.
host
}
:
{
server
.
port
}
;
const
serverMsg
=
L10N
.
getFormatStr
(
"
remoteIncomingPromptServerEndpoint
"
serverEndpoint
)
;
const
footer
=
L10N
.
getStr
(
"
remoteIncomingPromptFooter
"
)
;
const
msg
=
{
header
}
\
n
\
n
{
clientMsg
}
\
n
{
serverMsg
}
\
n
\
n
{
footer
}
;
const
disableButton
=
L10N
.
getStr
(
"
remoteIncomingPromptDisable
"
)
;
const
prompt
=
Services
.
prompt
;
const
flags
=
prompt
.
BUTTON_POS_0
*
prompt
.
BUTTON_TITLE_OK
+
prompt
.
BUTTON_POS_1
*
prompt
.
BUTTON_TITLE_CANCEL
+
prompt
.
BUTTON_POS_2
*
prompt
.
BUTTON_TITLE_IS_STRING
+
prompt
.
BUTTON_POS_1_DEFAULT
;
const
result
=
prompt
.
confirmEx
(
null
title
msg
flags
null
null
disableButton
null
{
value
:
false
}
)
;
if
(
result
=
=
=
0
)
{
return
AuthenticationResult
.
ALLOW
;
}
if
(
result
=
=
=
2
)
{
return
AuthenticationResult
.
DISABLE_ALL
;
}
return
AuthenticationResult
.
DENY
;
}
;
Server
.
defaultReceiveOOB
=
(
)
=
>
{
const
title
=
L10N
.
getStr
(
"
serverReceiveOOBTitle
"
)
;
const
msg
=
L10N
.
getStr
(
"
serverReceiveOOBBody
"
)
;
let
input
=
{
value
:
null
}
;
const
prompt
=
Services
.
prompt
;
const
result
=
prompt
.
prompt
(
null
title
msg
input
null
{
value
:
false
}
)
;
if
(
!
result
)
{
return
null
;
}
input
=
input
.
value
.
trim
(
)
;
let
sha256
=
input
.
substring
(
0
64
)
;
sha256
=
sha256
.
replace
(
/
\
w
{
2
}
/
g
"
&
:
"
)
.
slice
(
0
-
1
)
.
toUpperCase
(
)
;
const
k
=
input
.
substring
(
64
)
;
return
{
sha256
k
}
;
}
;
