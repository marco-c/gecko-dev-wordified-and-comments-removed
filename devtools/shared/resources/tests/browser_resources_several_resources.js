"
use
strict
"
;
const
{
ResourceWatcher
}
=
require
(
"
devtools
/
shared
/
resources
/
resource
-
watcher
"
)
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
devtools
.
browsertoolbox
.
fission
"
true
)
;
const
tab
=
await
addTab
(
"
data
:
text
/
html
Root
Node
tests
"
)
;
const
{
client
resourceWatcher
targetList
}
=
await
initResourceWatcherAndTarget
(
)
;
const
{
CONSOLE_MESSAGE
ROOT_NODE
}
=
ResourceWatcher
.
TYPES
;
const
receivedMessages
=
[
]
;
const
onAvailable
=
resources
=
>
{
for
(
const
resource
of
resources
)
{
if
(
resource
.
resourceType
=
=
=
CONSOLE_MESSAGE
)
{
receivedMessages
.
push
(
resource
)
;
}
}
}
;
info
(
"
Call
watchResources
(
[
CONSOLE_MESSAGE
ROOT_NODE
]
.
.
.
)
"
)
;
await
resourceWatcher
.
watchResources
(
[
CONSOLE_MESSAGE
ROOT_NODE
]
{
onAvailable
}
)
;
info
(
"
Use
console
.
log
in
the
content
page
"
)
;
logInTab
(
tab
"
test
from
data
-
url
"
)
;
info
(
"
Wait
until
onAvailable
received
the
CONSOLE_MESSAGE
resource
emitted
from
the
data
-
url
tab
"
)
;
await
waitUntil
(
(
)
=
>
receivedMessages
.
find
(
resource
=
>
resource
.
message
.
arguments
[
0
]
=
=
=
"
test
from
data
-
url
"
)
)
;
info
(
"
Open
a
first
tab
on
the
example
.
com
domain
"
)
;
const
comTab
=
await
addTab
(
"
http
:
/
/
example
.
com
/
document
-
builder
.
sjs
?
html
=
com
"
)
;
info
(
"
Use
console
.
log
in
the
example
.
com
page
"
)
;
logInTab
(
comTab
"
test
-
from
-
example
-
com
"
)
;
info
(
"
Wait
until
onAvailable
received
the
CONSOLE_MESSAGE
resource
emitted
from
the
example
.
com
tab
"
)
;
await
waitUntil
(
(
)
=
>
receivedMessages
.
find
(
resource
=
>
resource
.
message
.
arguments
[
0
]
=
=
=
"
test
-
from
-
example
-
com
"
)
)
;
info
(
"
Stop
watching
ROOT_NODE
resources
"
)
;
await
resourceWatcher
.
unwatchResources
(
[
ROOT_NODE
]
{
onAvailable
}
)
;
info
(
"
Open
a
second
tab
on
the
example
.
net
domain
"
)
;
const
netTab
=
await
addTab
(
"
http
:
/
/
example
.
net
/
document
-
builder
.
sjs
?
html
=
net
"
)
;
info
(
"
Use
console
.
log
in
the
example
.
net
page
"
)
;
logInTab
(
netTab
"
test
-
from
-
example
-
net
"
)
;
info
(
"
Wait
until
onAvailable
received
the
CONSOLE_MESSAGE
resource
emitted
from
the
example
.
net
tab
"
)
;
await
waitUntil
(
(
)
=
>
receivedMessages
.
find
(
resource
=
>
resource
.
message
.
arguments
[
0
]
=
=
=
"
test
-
from
-
example
-
net
"
)
)
;
info
(
"
Stop
watching
CONSOLE_MESSAGE
resources
"
)
;
await
resourceWatcher
.
unwatchResources
(
[
CONSOLE_MESSAGE
]
{
onAvailable
}
)
;
await
logInTab
(
tab
"
test
-
again
"
)
;
await
wait
(
1000
)
;
is
(
receivedMessages
.
find
(
resource
=
>
resource
.
message
.
arguments
[
0
]
=
=
=
"
test
-
again
"
)
undefined
"
The
resource
watcher
should
not
watch
CONSOLE_MESSAGE
anymore
"
)
;
targetList
.
destroy
(
)
;
await
client
.
close
(
)
;
}
)
;
function
logInTab
(
tab
message
)
{
return
ContentTask
.
spawn
(
tab
.
linkedBrowser
message
function
(
_message
)
{
content
.
console
.
log
(
_message
)
;
}
)
;
}
