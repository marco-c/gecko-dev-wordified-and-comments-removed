"
use
strict
"
;
const
{
ResourceWatcher
}
=
require
(
"
devtools
/
shared
/
resources
/
resource
-
watcher
"
)
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
dom
.
ipc
.
processPrelaunch
.
enabled
"
false
)
;
const
{
client
resourceWatcher
targetCommand
}
=
await
initMultiProcessResourceWatcher
(
)
;
const
expectedPlatformMessage
=
"
expectedMessage
"
;
info
(
"
Log
a
message
*
before
*
calling
ResourceWatcher
.
watchResources
"
)
;
Services
.
console
.
logStringMessage
(
expectedPlatformMessage
)
;
info
(
"
Call
watchResources
from
2
separate
call
sites
consecutively
"
)
;
const
onCssMessageAvailable
=
resources
=
>
{
}
;
const
initialWatchPromise
=
resourceWatcher
.
watchResources
(
[
ResourceWatcher
.
TYPES
.
CSS_MESSAGE
]
{
onAvailable
:
onCssMessageAvailable
}
)
;
const
onMessageReceived
=
waitForNextResource
(
resourceWatcher
ResourceWatcher
.
TYPES
.
PLATFORM_MESSAGE
{
ignoreExistingResources
:
false
predicate
:
r
=
>
r
.
message
=
=
=
expectedPlatformMessage
}
)
;
info
(
"
Waiting
for
the
expected
message
to
be
received
"
)
;
await
onMessageReceived
;
ok
(
true
"
All
the
expected
messages
were
received
"
)
;
info
(
"
Wait
for
the
other
watchResources
promise
to
finish
"
)
;
await
initialWatchPromise
;
resourceWatcher
.
unwatchResources
(
[
ResourceWatcher
.
TYPES
.
CSS_MESSAGE
]
{
onAvailable
:
onCssMessageAvailable
}
)
;
Services
.
console
.
reset
(
)
;
targetCommand
.
destroy
(
)
;
await
client
.
close
(
)
;
}
)
;
