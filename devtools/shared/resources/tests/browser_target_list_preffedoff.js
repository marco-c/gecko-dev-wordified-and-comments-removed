"
use
strict
"
;
const
{
TargetList
}
=
require
(
"
devtools
/
shared
/
resources
/
target
-
list
"
)
;
const
FISSION_TEST_URL
=
URL_ROOT_SSL
+
"
/
fission_document
.
html
"
;
add_task
(
async
function
(
)
{
await
pushPref
(
"
dom
.
ipc
.
processPrelaunch
.
enabled
"
false
)
;
await
pushPref
(
"
dom
.
ipc
.
keepProcessesAlive
.
web
"
1
)
;
const
client
=
await
createLocalClient
(
)
;
const
mainRoot
=
client
.
mainRoot
;
const
targetDescriptor
=
await
mainRoot
.
getMainProcess
(
)
;
const
mainProcess
=
await
targetDescriptor
.
getTarget
(
)
;
await
pushPref
(
"
devtools
.
browsertoolbox
.
fission
"
false
)
;
await
pushPref
(
"
devtools
.
contenttoolbox
.
fission
"
false
)
;
is
(
gDevTools
.
isFissionContentToolboxEnabled
(
)
false
"
isFissionContentToolboxEnabled
returns
the
expected
value
"
)
;
await
testPreffedOffMainProcess
(
mainRoot
mainProcess
)
;
await
testPreffedOffTab
(
mainRoot
)
;
await
client
.
close
(
)
;
}
)
;
async
function
testPreffedOffMainProcess
(
mainRoot
mainProcess
)
{
info
(
"
Test
TargetList
when
devtools
'
s
fission
pref
is
false
via
the
parent
process
target
"
)
;
const
targetList
=
new
TargetList
(
mainRoot
mainProcess
)
;
await
targetList
.
startListening
(
)
;
const
processes
=
await
targetList
.
getAllTargets
(
[
TargetList
.
TYPES
.
PROCESS
]
)
;
is
(
processes
.
length
0
"
We
only
get
a
frame
target
for
the
top
level
target
"
)
;
const
frames
=
await
targetList
.
getAllTargets
(
[
TargetList
.
TYPES
.
FRAME
]
)
;
is
(
frames
.
length
1
"
We
get
only
one
frame
when
preffed
-
off
"
)
;
is
(
frames
[
0
]
mainProcess
"
The
target
is
the
top
level
one
via
getAllTargets
"
)
;
const
processTargets
=
[
]
;
const
onProcessAvailable
=
(
{
targetFront
}
)
=
>
{
processTargets
.
push
(
targetFront
)
;
}
;
await
targetList
.
watchTargets
(
[
TargetList
.
TYPES
.
PROCESS
]
onProcessAvailable
)
;
is
(
processTargets
.
length
0
"
We
get
no
process
when
preffed
-
off
"
)
;
targetList
.
unwatchTargets
(
[
TargetList
.
TYPES
.
PROCESS
]
onProcessAvailable
)
;
const
frameTargets
=
[
]
;
const
onFrameAvailable
=
(
{
targetFront
}
)
=
>
{
is
(
targetFront
.
targetType
TargetList
.
TYPES
.
FRAME
"
We
are
only
notified
about
frame
targets
"
)
;
ok
(
targetFront
.
isTopLevel
"
We
are
only
notified
about
the
top
level
target
"
)
;
frameTargets
.
push
(
targetFront
)
;
}
;
await
targetList
.
watchTargets
(
[
TargetList
.
TYPES
.
FRAME
]
onFrameAvailable
)
;
is
(
frameTargets
.
length
1
"
We
get
one
frame
via
watchTargets
when
preffed
-
off
"
)
;
is
(
frameTargets
[
0
]
mainProcess
"
The
target
is
the
top
level
one
via
watchTargets
"
)
;
targetList
.
unwatchTargets
(
[
TargetList
.
TYPES
.
FRAME
]
onFrameAvailable
)
;
targetList
.
destroy
(
)
;
}
async
function
testPreffedOffTab
(
mainRoot
)
{
info
(
"
Test
TargetList
when
devtools
'
s
fission
pref
is
false
via
the
tab
target
"
)
;
const
tab
=
await
addTab
(
FISSION_TEST_URL
)
;
const
descriptor
=
await
mainRoot
.
getTab
(
{
tab
}
)
;
const
target
=
await
descriptor
.
getTarget
(
)
;
const
targetList
=
new
TargetList
(
mainRoot
target
)
;
await
targetList
.
startListening
(
)
;
const
processes
=
await
targetList
.
getAllTargets
(
[
TargetList
.
TYPES
.
PROCESS
]
)
;
is
(
processes
.
length
0
"
Tabs
don
'
t
expose
any
process
"
)
;
const
frames
=
await
targetList
.
getAllTargets
(
[
TargetList
.
TYPES
.
FRAME
]
)
;
is
(
frames
.
length
1
"
We
get
only
one
frame
when
preffed
-
off
"
)
;
is
(
frames
[
0
]
target
"
The
target
is
the
top
level
one
via
getAllTargets
"
)
;
const
processTargets
=
[
]
;
const
onProcessAvailable
=
(
{
type
targetFront
}
)
=
>
{
processTargets
.
push
(
targetFront
)
;
}
;
await
targetList
.
watchTargets
(
[
TargetList
.
TYPES
.
PROCESS
]
onProcessAvailable
)
;
is
(
processTargets
.
length
0
"
We
get
no
process
when
preffed
-
off
"
)
;
targetList
.
unwatchTargets
(
[
TargetList
.
TYPES
.
PROCESS
]
onProcessAvailable
)
;
const
frameTargets
=
[
]
;
const
onFrameAvailable
=
(
{
targetFront
}
)
=
>
{
is
(
targetFront
.
targetType
TargetList
.
TYPES
.
FRAME
"
We
are
only
notified
about
frame
targets
"
)
;
ok
(
targetFront
.
isTopLevel
"
We
are
only
notified
about
the
top
level
target
"
)
;
frameTargets
.
push
(
targetFront
)
;
}
;
await
targetList
.
watchTargets
(
[
TargetList
.
TYPES
.
FRAME
]
onFrameAvailable
)
;
is
(
frameTargets
.
length
1
"
We
get
one
frame
via
watchTargets
when
preffed
-
off
"
)
;
is
(
frameTargets
[
0
]
target
"
The
target
is
the
top
level
one
via
watchTargets
"
)
;
targetList
.
unwatchTargets
(
[
TargetList
.
TYPES
.
FRAME
]
onFrameAvailable
)
;
targetList
.
destroy
(
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
