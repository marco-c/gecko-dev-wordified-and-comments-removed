"
use
strict
"
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
client
/
shared
/
test
/
shared
-
head
.
js
"
this
)
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
devtools
/
client
/
debugger
/
test
/
mochitest
/
shared
-
head
.
js
"
this
)
;
const
{
DevToolsStartup
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
DevToolsStartup
.
sys
.
mjs
"
)
;
const
startup
=
new
DevToolsStartup
(
)
;
startup
.
initialized
=
true
;
registerCleanupFunction
(
(
)
=
>
{
for
(
const
pref
of
[
"
devtools
.
debugger
.
pending
-
selected
-
location
"
"
devtools
.
debugger
.
prefs
-
schema
-
version
"
"
devtools
.
everOpened
"
"
devtools
.
toolbox
.
selectedTool
"
]
)
{
Services
.
prefs
.
clearUserPref
(
pref
)
;
}
}
)
;
add_task
(
async
function
ignoredUrls
(
)
{
const
tabCount
=
gBrowser
.
tabs
.
length
;
sendUrlViaCommandLine
(
"
https
:
/
/
foo
user
:
123
"
)
;
sendUrlViaCommandLine
(
"
https
:
/
/
foo
user
:
123
"
)
;
sendUrlViaCommandLine
(
"
https
:
/
/
foo
123
:
456
"
)
;
sendUrlViaCommandLine
(
"
https
:
/
/
foo
/
index
.
html
:
123
:
456
"
)
;
await
new
Promise
(
r
=
>
setTimeout
(
r
1000
)
)
;
is
(
tabCount
gBrowser
.
tabs
.
length
)
;
}
)
;
add_task
(
async
function
openingWithDevToolsClosed
(
)
{
const
url
=
URL_ROOT_SSL
+
"
command
-
line
.
html
:
5
:
2
"
;
const
tabCount
=
gBrowser
.
tabs
.
length
;
const
ignoredUrl
=
sendUrlViaCommandLine
(
url
)
;
ok
(
ignoredUrl
"
The
url
is
ignored
when
no
devtools
are
opened
"
)
;
await
new
Promise
(
r
=
>
setTimeout
(
r
1000
)
)
;
is
(
tabCount
gBrowser
.
tabs
.
length
)
;
}
)
;
add_task
(
async
function
openingWithDevToolsButUnknownSource
(
)
{
const
url
=
URL_ROOT_SSL
+
"
command
-
line
.
html
:
5
:
2
"
;
const
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
data
:
text
/
html
;
charset
=
utf
-
8
<
title
>
foo
<
/
title
>
"
)
;
gBrowser
.
selectedTab
=
tab
;
const
toolbox
=
await
gDevTools
.
showToolboxForTab
(
tab
{
toolId
:
"
jsdebugger
"
}
)
;
const
newTabOpened
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
)
;
sendUrlViaCommandLine
(
url
)
;
const
newTab
=
await
newTabOpened
;
is
(
newTab
.
linkedBrowser
.
documentURI
.
spec
"
view
-
source
:
"
+
URL_ROOT_SSL
+
"
command
-
line
.
html
"
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
async
function
(
)
{
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
!
!
content
.
getSelection
(
)
)
;
const
selection
=
content
.
getSelection
(
)
;
Assert
.
equal
(
selection
.
toString
(
)
.
trimEnd
(
)
"
<
title
>
Command
line
test
page
<
/
title
>
"
"
The
5th
line
is
selected
in
view
-
source
"
)
;
}
)
;
await
gBrowser
.
removeTab
(
newTab
)
;
await
toolbox
.
destroy
(
)
;
await
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
openingWithDevToolsAndKnownSource
(
)
{
const
line
=
5
;
const
column
=
2
;
const
url
=
URL_ROOT_SSL
+
command
-
line
.
js
:
{
line
}
:
{
column
}
;
const
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
URL_ROOT_SSL
+
"
command
-
line
.
html
"
)
;
const
toolbox
=
await
gDevTools
.
showToolboxForTab
(
tab
{
toolId
:
"
jsdebugger
"
}
)
;
info
(
"
Open
a
first
URL
with
line
and
column
"
)
;
sendUrlViaCommandLine
(
url
)
;
const
dbg
=
createDebuggerContext
(
toolbox
)
;
await
waitForSelectedSource
(
dbg
"
command
-
line
.
js
"
)
;
await
waitForSelectedLocation
(
dbg
line
column
)
;
info
(
"
Open
another
URL
with
only
a
line
"
)
;
const
secondLine
=
6
;
const
url2
=
URL_ROOT_SSL
+
command
-
line
.
js
:
{
secondLine
}
;
sendUrlViaCommandLine
(
url2
)
;
await
waitForSelectedSource
(
dbg
"
command
-
line
.
js
"
)
;
await
waitForSelectedLocation
(
dbg
secondLine
1
)
;
await
toolbox
.
destroy
(
)
;
await
gBrowser
.
removeTab
(
tab
)
;
}
)
;
function
sendUrlViaCommandLine
(
url
)
{
const
cmdLine
=
Cu
.
createCommandLine
(
[
"
-
url
"
url
]
null
Ci
.
nsICommandLine
.
STATE_REMOTE_EXPLICIT
)
;
startup
.
handle
(
cmdLine
)
;
return
cmdLine
.
findFlag
(
"
url
"
false
)
!
=
-
1
;
}
