#
include
"
mozilla
/
Types
.
h
"
#
include
"
mozilla
/
Utf8
.
h
"
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
MFBT_API
bool
mozilla
:
:
IsValidUtf8
(
const
void
*
aCodeUnits
size_t
aCount
)
{
const
auto
*
s
=
static_cast
<
const
unsigned
char
*
>
(
aCodeUnits
)
;
const
auto
*
limit
=
s
+
aCount
;
while
(
s
<
limit
)
{
uint32_t
n
=
*
s
+
+
;
if
(
(
n
&
0x80
)
=
=
0
)
{
continue
;
}
uint_fast8_t
remaining
;
uint32_t
min
;
if
(
(
n
&
0xE0
)
=
=
0xC0
)
{
remaining
=
1
;
min
=
0x80
;
n
&
=
0x1F
;
}
else
if
(
(
n
&
0xF0
)
=
=
0xE0
)
{
remaining
=
2
;
min
=
0x800
;
n
&
=
0x0F
;
}
else
if
(
(
n
&
0xF8
)
=
=
0xF0
)
{
remaining
=
3
;
min
=
0x10000
;
n
&
=
0x07
;
}
else
{
return
false
;
}
if
(
s
+
remaining
>
limit
)
{
return
false
;
}
for
(
uint_fast8_t
i
=
0
;
i
<
remaining
;
i
+
+
)
{
if
(
(
s
[
i
]
&
0xC0
)
!
=
0x80
)
{
return
false
;
}
n
=
(
n
<
<
6
)
|
(
s
[
i
]
&
0x3F
)
;
}
if
(
n
<
min
|
|
(
0xD800
<
=
n
&
&
n
<
0xE000
)
|
|
n
>
=
0x110000
)
{
return
false
;
}
s
+
=
remaining
;
}
return
true
;
}
