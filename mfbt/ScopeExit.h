#
ifndef
mozilla_ScopeExit_h
#
define
mozilla_ScopeExit_h
#
include
<
utility
>
#
include
"
mozilla
/
Attributes
.
h
"
namespace
mozilla
{
template
<
typename
ExitFunction
>
class
MOZ_STACK_CLASS
ScopeExit
{
ExitFunction
mExitFunction
;
bool
mExecuteOnDestruction
;
public
:
explicit
ScopeExit
(
ExitFunction
&
&
cleanup
)
:
mExitFunction
(
std
:
:
move
(
cleanup
)
)
mExecuteOnDestruction
(
true
)
{
}
ScopeExit
(
ScopeExit
&
&
rhs
)
:
mExitFunction
(
std
:
:
move
(
rhs
.
mExitFunction
)
)
mExecuteOnDestruction
(
rhs
.
mExecuteOnDestruction
)
{
rhs
.
release
(
)
;
}
~
ScopeExit
(
)
{
if
(
mExecuteOnDestruction
)
{
mExitFunction
(
)
;
}
}
void
release
(
)
{
mExecuteOnDestruction
=
false
;
}
private
:
explicit
ScopeExit
(
const
ScopeExit
&
)
=
delete
;
ScopeExit
&
operator
=
(
const
ScopeExit
&
)
=
delete
;
ScopeExit
&
operator
=
(
ScopeExit
&
&
)
=
delete
;
}
;
template
<
typename
ExitFunction
>
[
[
nodiscard
]
]
ScopeExit
<
ExitFunction
>
MakeScopeExit
(
ExitFunction
&
&
exitFunction
)
{
return
ScopeExit
<
ExitFunction
>
(
std
:
:
move
(
exitFunction
)
)
;
}
}
#
endif
