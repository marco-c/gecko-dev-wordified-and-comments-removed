#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
ResultExtensions
.
h
"
#
include
<
functional
>
using
namespace
mozilla
;
namespace
{
class
TestClass
{
public
:
static
constexpr
int
kTestValue
=
42
;
nsresult
NonOverloadedNoInput
(
int
*
aOut
)
{
*
aOut
=
kTestValue
;
return
NS_OK
;
}
nsresult
NonOverloadedNoInputFails
(
int
*
aOut
)
{
return
NS_ERROR_FAILURE
;
}
nsresult
NonOverloadedNoInputConst
(
int
*
aOut
)
const
{
*
aOut
=
kTestValue
;
return
NS_OK
;
}
nsresult
NonOverloadedNoInputFailsConst
(
int
*
aOut
)
const
{
return
NS_ERROR_FAILURE
;
}
nsresult
NonOverloadedNoInputRef
(
int
&
aOut
)
{
aOut
=
kTestValue
;
return
NS_OK
;
}
nsresult
NonOverloadedNoInputFailsRef
(
int
&
aOut
)
{
return
NS_ERROR_FAILURE
;
}
nsresult
NonOverloadedWithInput
(
int
aIn
int
*
aOut
)
{
*
aOut
=
aIn
;
return
NS_OK
;
}
nsresult
NonOverloadedWithInputFails
(
int
aIn
int
*
aOut
)
{
return
NS_ERROR_FAILURE
;
}
nsresult
NonOverloadedNoOutput
(
int
aIn
)
{
return
NS_OK
;
}
nsresult
NonOverloadedNoOutputFails
(
int
aIn
)
{
return
NS_ERROR_FAILURE
;
}
}
;
}
TEST
(
ResultExtensions_ToResultInvoke
Lambda
)
{
TestClass
foo
;
{
auto
valOrErr
=
ToResultInvoke
<
int
>
(
[
&
foo
]
(
int
*
out
)
{
return
foo
.
NonOverloadedNoInput
(
out
)
;
}
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isOk
(
)
)
;
ASSERT_EQ
(
TestClass
:
:
kTestValue
valOrErr
.
unwrap
(
)
)
;
}
{
auto
valOrErr
=
ToResultInvoke
<
int
>
(
[
&
foo
]
(
int
*
out
)
{
return
foo
.
NonOverloadedNoInputFails
(
out
)
;
}
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isErr
(
)
)
;
ASSERT_EQ
(
NS_ERROR_FAILURE
valOrErr
.
unwrapErr
(
)
)
;
}
}
TEST
(
ResultExtensions_ToResultInvoke
MemFn
)
{
TestClass
foo
;
{
auto
valOrErr
=
ToResultInvoke
<
int
>
(
std
:
:
mem_fn
(
&
TestClass
:
:
NonOverloadedNoInput
)
foo
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isOk
(
)
)
;
ASSERT_EQ
(
TestClass
:
:
kTestValue
valOrErr
.
unwrap
(
)
)
;
}
{
auto
valOrErr
=
ToResultInvoke
<
int
>
(
std
:
:
mem_fn
(
&
TestClass
:
:
NonOverloadedNoInputFails
)
foo
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isErr
(
)
)
;
ASSERT_EQ
(
NS_ERROR_FAILURE
valOrErr
.
unwrapErr
(
)
)
;
}
}
TEST
(
ResultExtensions_ToResultInvoke
MemberFunction_NoInput
)
{
TestClass
foo
;
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoInput
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isOk
(
)
)
;
ASSERT_EQ
(
TestClass
:
:
kTestValue
valOrErr
.
unwrap
(
)
)
;
}
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoInputFails
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isErr
(
)
)
;
ASSERT_EQ
(
NS_ERROR_FAILURE
valOrErr
.
unwrapErr
(
)
)
;
}
}
TEST
(
ResultExtensions_ToResultInvoke
MemberFunction_NoInput_Const
)
{
const
TestClass
foo
;
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoInputConst
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isOk
(
)
)
;
ASSERT_EQ
(
TestClass
:
:
kTestValue
valOrErr
.
unwrap
(
)
)
;
}
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoInputFailsConst
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isErr
(
)
)
;
ASSERT_EQ
(
NS_ERROR_FAILURE
valOrErr
.
unwrapErr
(
)
)
;
}
}
TEST
(
ResultExtensions_ToResultInvoke
MemberFunction_NoInput_Ref
)
{
TestClass
foo
;
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoInputRef
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isOk
(
)
)
;
ASSERT_EQ
(
TestClass
:
:
kTestValue
valOrErr
.
unwrap
(
)
)
;
}
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoInputFailsRef
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isErr
(
)
)
;
ASSERT_EQ
(
NS_ERROR_FAILURE
valOrErr
.
unwrapErr
(
)
)
;
}
}
TEST
(
ResultExtensions_ToResultInvoke
MemberFunction_WithInput
)
{
TestClass
foo
;
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedWithInput
-
TestClass
:
:
kTestValue
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isOk
(
)
)
;
ASSERT_EQ
(
-
TestClass
:
:
kTestValue
valOrErr
.
unwrap
(
)
)
;
}
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedWithInputFails
-
TestClass
:
:
kTestValue
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
int
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isErr
(
)
)
;
ASSERT_EQ
(
NS_ERROR_FAILURE
valOrErr
.
unwrapErr
(
)
)
;
}
}
TEST
(
ResultExtensions_ToResultInvoke
MemberFunction_NoOutput
)
{
TestClass
foo
;
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoOutput
-
TestClass
:
:
kTestValue
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
Ok
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isOk
(
)
)
;
}
{
auto
valOrErr
=
ToResultInvoke
(
foo
&
TestClass
:
:
NonOverloadedNoOutputFails
-
TestClass
:
:
kTestValue
)
;
static_assert
(
std
:
:
is_same_v
<
decltype
(
valOrErr
)
Result
<
Ok
nsresult
>
>
)
;
ASSERT_TRUE
(
valOrErr
.
isErr
(
)
)
;
ASSERT_EQ
(
NS_ERROR_FAILURE
valOrErr
.
unwrapErr
(
)
)
;
}
}
