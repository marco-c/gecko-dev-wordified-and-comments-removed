#
include
"
mozilla
/
BufferList
.
h
"
class
InfallibleAllocPolicy
{
public
:
template
<
typename
T
>
T
*
pod_malloc
(
size_t
aNumElems
)
{
size_t
size
;
if
(
__builtin_mul_overflow
(
aNumElems
sizeof
(
T
)
&
size
)
)
{
MOZ_CRASH
(
"
TestBufferList
.
cpp
:
overflow
"
)
;
}
T
*
rv
=
static_cast
<
T
*
>
(
malloc
(
size
)
)
;
if
(
!
rv
)
{
MOZ_CRASH
(
"
TestBufferList
.
cpp
:
out
of
memory
"
)
;
}
return
rv
;
}
template
<
typename
T
>
void
free_
(
T
*
aPtr
size_t
aNumElems
=
0
)
{
free
(
aPtr
)
;
}
void
reportAllocOverflow
(
)
const
{
}
bool
checkSimulatedOOM
(
)
const
{
return
true
;
}
}
;
typedef
mozilla
:
:
BufferList
<
InfallibleAllocPolicy
>
BufferList
;
int
main
(
void
)
{
const
size_t
kInitialSize
=
16
;
const
size_t
kInitialCapacity
=
24
;
const
size_t
kStandardCapacity
=
32
;
BufferList
bl
(
kInitialSize
kInitialCapacity
kStandardCapacity
)
;
memset
(
bl
.
Start
(
)
0x0c
kInitialSize
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Size
(
)
=
=
kInitialSize
)
;
BufferList
:
:
IterImpl
iter
(
bl
.
Iter
(
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
kInitialSize
)
;
MOZ_RELEASE_ASSERT
(
iter
.
HasRoomFor
(
kInitialSize
)
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
HasRoomFor
(
kInitialSize
+
1
)
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
HasRoomFor
(
size_t
(
-
1
)
)
)
;
MOZ_RELEASE_ASSERT
(
*
iter
.
Data
(
)
=
=
0x0c
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
Done
(
)
)
;
iter
.
Advance
(
bl
4
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
kInitialSize
-
4
)
;
MOZ_RELEASE_ASSERT
(
iter
.
HasRoomFor
(
kInitialSize
-
4
)
)
;
MOZ_RELEASE_ASSERT
(
*
iter
.
Data
(
)
=
=
0x0c
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
Done
(
)
)
;
iter
.
Advance
(
bl
11
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
kInitialSize
-
4
-
11
)
;
MOZ_RELEASE_ASSERT
(
iter
.
HasRoomFor
(
kInitialSize
-
4
-
11
)
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
HasRoomFor
(
kInitialSize
-
4
-
11
+
1
)
)
;
MOZ_RELEASE_ASSERT
(
*
iter
.
Data
(
)
=
=
0x0c
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
Done
(
)
)
;
iter
.
Advance
(
bl
kInitialSize
-
4
-
11
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
HasRoomFor
(
1
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
const
size_t
kSmallWrite
=
16
;
char
toWrite
[
kSmallWrite
]
;
memset
(
toWrite
0x0a
kSmallWrite
)
;
MOZ_ALWAYS_TRUE
(
bl
.
WriteBytes
(
toWrite
kSmallWrite
)
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Size
(
)
=
=
kInitialSize
+
kSmallWrite
)
;
iter
=
bl
.
Iter
(
)
;
iter
.
Advance
(
bl
kInitialSize
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
kInitialCapacity
-
kInitialSize
)
;
MOZ_RELEASE_ASSERT
(
iter
.
HasRoomFor
(
kInitialCapacity
-
kInitialSize
)
)
;
MOZ_RELEASE_ASSERT
(
*
iter
.
Data
(
)
=
=
0x0a
)
;
iter
=
bl
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl
kInitialCapacity
-
4
)
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
4
)
;
MOZ_RELEASE_ASSERT
(
iter
.
HasRoomFor
(
4
)
)
;
MOZ_RELEASE_ASSERT
(
*
iter
.
Data
(
)
=
=
0x0a
)
;
iter
=
bl
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl
kInitialSize
+
kSmallWrite
-
4
)
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
4
)
;
MOZ_RELEASE_ASSERT
(
iter
.
HasRoomFor
(
4
)
)
;
MOZ_RELEASE_ASSERT
(
*
iter
.
Data
(
)
=
=
0x0a
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Iter
(
)
.
AdvanceAcrossSegments
(
bl
kInitialSize
+
kSmallWrite
-
1
)
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Iter
(
)
.
AdvanceAcrossSegments
(
bl
kInitialSize
+
kSmallWrite
)
)
;
MOZ_RELEASE_ASSERT
(
!
bl
.
Iter
(
)
.
AdvanceAcrossSegments
(
bl
kInitialSize
+
kSmallWrite
+
1
)
)
;
MOZ_RELEASE_ASSERT
(
!
bl
.
Iter
(
)
.
AdvanceAcrossSegments
(
bl
size_t
(
-
1
)
)
)
;
char
toRead
[
kSmallWrite
]
;
iter
=
bl
.
Iter
(
)
;
iter
.
Advance
(
bl
kInitialSize
)
;
bl
.
ReadBytes
(
iter
toRead
kSmallWrite
)
;
MOZ_RELEASE_ASSERT
(
memcmp
(
toRead
toWrite
kSmallWrite
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
iter
=
bl
.
Iter
(
)
;
bl
.
ReadBytes
(
iter
toRead
kInitialSize
)
;
MOZ_RELEASE_ASSERT
(
!
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
kInitialCapacity
-
kInitialSize
)
;
const
size_t
kBigWrite
=
1024
;
char
*
toWriteBig
=
static_cast
<
char
*
>
(
malloc
(
kBigWrite
)
)
;
for
(
unsigned
i
=
0
;
i
<
kBigWrite
;
i
+
+
)
{
toWriteBig
[
i
]
=
i
%
37
;
}
MOZ_ALWAYS_TRUE
(
bl
.
WriteBytes
(
toWriteBig
kBigWrite
)
)
;
char
*
toReadBig
=
static_cast
<
char
*
>
(
malloc
(
kBigWrite
)
)
;
iter
=
bl
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl
kInitialSize
+
kSmallWrite
)
)
;
bl
.
ReadBytes
(
iter
toReadBig
kBigWrite
)
;
MOZ_RELEASE_ASSERT
(
memcmp
(
toReadBig
toWriteBig
kBigWrite
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
free
(
toReadBig
)
;
free
(
toWriteBig
)
;
static
size_t
kTotalSize
=
kInitialSize
+
kSmallWrite
+
kBigWrite
;
MOZ_RELEASE_ASSERT
(
bl
.
Size
(
)
=
=
kTotalSize
)
;
static
size_t
kLastSegmentSize
=
(
kTotalSize
-
kInitialCapacity
)
%
kStandardCapacity
;
iter
=
bl
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl
kTotalSize
-
kLastSegmentSize
-
kStandardCapacity
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
kStandardCapacity
)
;
iter
.
Advance
(
bl
kStandardCapacity
)
;
MOZ_RELEASE_ASSERT
(
iter
.
RemainingInSegment
(
)
=
=
kLastSegmentSize
)
;
MOZ_RELEASE_ASSERT
(
unsigned
(
*
iter
.
Data
(
)
)
=
=
(
kTotalSize
-
kLastSegmentSize
-
kInitialSize
-
kSmallWrite
)
%
37
)
;
bl
.
Clear
(
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Size
(
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Iter
(
)
.
Done
(
)
)
;
const
size_t
kSmallCapacity
=
8
;
BufferList
bl2
(
0
kSmallCapacity
kSmallCapacity
)
;
MOZ_ALWAYS_TRUE
(
bl2
.
WriteBytes
(
toWrite
kSmallWrite
)
)
;
MOZ_ALWAYS_TRUE
(
bl2
.
WriteBytes
(
toWrite
kSmallWrite
)
)
;
MOZ_ALWAYS_TRUE
(
bl2
.
WriteBytes
(
toWrite
kSmallWrite
)
)
;
bl
=
std
:
:
move
(
bl2
)
;
MOZ_RELEASE_ASSERT
(
bl2
.
Size
(
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
bl2
.
Iter
(
)
.
Done
(
)
)
;
iter
=
bl
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl
kSmallWrite
*
3
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
bool
success
;
bl2
=
bl
.
MoveFallible
<
InfallibleAllocPolicy
>
(
&
success
)
;
MOZ_RELEASE_ASSERT
(
success
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Size
(
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
bl
.
Iter
(
)
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl2
.
Size
(
)
=
=
kSmallWrite
*
3
)
;
iter
=
bl2
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl2
kSmallWrite
*
3
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
bl
=
bl2
.
MoveFallible
<
InfallibleAllocPolicy
>
(
&
success
)
;
const
size_t
kBorrowStart
=
4
;
const
size_t
kBorrowSize
=
24
;
iter
=
bl
.
Iter
(
)
;
iter
.
Advance
(
bl
kBorrowStart
)
;
bl2
=
bl
.
Borrow
<
InfallibleAllocPolicy
>
(
iter
kBorrowSize
&
success
)
;
MOZ_RELEASE_ASSERT
(
success
)
;
MOZ_RELEASE_ASSERT
(
bl2
.
Size
(
)
=
=
kBorrowSize
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl
kSmallWrite
*
3
-
kBorrowSize
-
kBorrowStart
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
iter
=
bl2
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl2
kBorrowSize
)
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
BufferList
:
:
IterImpl
iter1
(
bl
.
Iter
(
)
)
iter2
(
bl2
.
Iter
(
)
)
;
iter1
.
Advance
(
bl
kBorrowStart
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
Data
(
)
=
=
iter2
.
Data
(
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl
kBorrowSize
-
5
)
)
;
MOZ_RELEASE_ASSERT
(
iter2
.
AdvanceAcrossSegments
(
bl2
kBorrowSize
-
5
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
Data
(
)
=
=
iter2
.
Data
(
)
)
;
BufferList
bl12
(
0
0
8
)
;
MOZ_ALWAYS_TRUE
(
bl12
.
WriteBytes
(
"
abcdefgh
"
8
)
)
;
MOZ_ALWAYS_TRUE
(
bl12
.
WriteBytes
(
"
12345678
"
8
)
)
;
iter
=
bl12
.
Iter
(
)
;
iter1
=
bl12
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
4
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
8
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
12
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
3
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
15
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
1
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
Done
(
)
)
;
iter
=
bl12
.
Iter
(
)
;
iter1
=
bl12
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl12
1
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
1
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
4
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
8
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
12
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
2
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
14
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
1
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
Done
(
)
)
;
iter
=
bl12
.
Iter
(
)
;
iter1
=
bl12
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl12
8
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
8
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
4
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
3
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
7
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
1
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
Done
(
)
)
;
iter
=
bl12
.
Iter
(
)
;
iter1
=
bl12
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl12
9
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
9
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
4
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
4
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
2
)
)
;
MOZ_RELEASE_ASSERT
(
bl12
.
RangeLength
(
iter
iter1
)
=
=
6
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
AdvanceAcrossSegments
(
bl12
1
)
)
;
MOZ_RELEASE_ASSERT
(
iter1
.
Done
(
)
)
;
BufferList
bl13
(
0
0
8
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
abcdefgh
"
8
)
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
12345678
"
8
)
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
ABCDEFGH
"
8
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
24
)
;
iter
=
bl13
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl13
8
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Truncate
(
iter
)
=
=
16
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
8
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
12345678
"
8
)
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
ABCDEFGH
"
8
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
24
)
;
iter
=
bl13
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl13
7
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Truncate
(
iter
)
=
=
17
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
7
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
h
"
1
)
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
12345678
"
8
)
)
;
MOZ_ALWAYS_TRUE
(
bl13
.
WriteBytes
(
"
ABCDEFGH
"
8
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
24
)
;
iter
=
bl13
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl13
20
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Truncate
(
iter
)
=
=
4
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
20
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Truncate
(
iter
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
20
)
;
iter
=
bl13
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
iter
.
AdvanceAcrossSegments
(
bl13
20
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Truncate
(
iter
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
20
)
;
iter
=
bl13
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Truncate
(
iter
)
=
=
20
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
0
)
;
iter
=
bl13
.
Iter
(
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Truncate
(
iter
)
=
=
0
)
;
MOZ_RELEASE_ASSERT
(
iter
.
Done
(
)
)
;
MOZ_RELEASE_ASSERT
(
bl13
.
Size
(
)
=
=
0
)
;
return
0
;
}
