#
ifndef
mozilla_ThreadLocal_h
#
define
mozilla_ThreadLocal_h
#
if
!
defined
(
XP_WIN
)
#
include
<
pthread
.
h
>
#
endif
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
TypeTraits
.
h
"
namespace
mozilla
{
namespace
detail
{
#
ifdef
XP_MACOSX
#
if
defined
(
__has_feature
)
#
if
__has_feature
(
cxx_thread_local
)
#
define
MACOSX_HAS_THREAD_LOCAL
#
endif
#
endif
#
endif
template
<
typename
S
>
struct
Helper
{
typedef
uintptr_t
Type
;
}
;
template
<
typename
S
>
struct
Helper
<
S
*
>
{
typedef
S
*
Type
;
}
;
#
if
defined
(
XP_WIN
)
#
if
defined
(
TLS_OUT_OF_INDEXES
)
template
<
typename
T
>
class
ThreadLocalKeyStorage
{
public
:
ThreadLocalKeyStorage
(
)
:
mKey
(
TLS_OUT_OF_INDEXES
)
{
}
inline
bool
initialized
(
)
const
{
return
mKey
!
=
TLS_OUT_OF_INDEXES
;
}
inline
void
init
(
)
{
mKey
=
TlsAlloc
(
)
;
}
inline
T
get
(
)
const
{
void
*
h
=
TlsGetValue
(
mKey
)
;
return
static_cast
<
T
>
(
reinterpret_cast
<
typename
Helper
<
T
>
:
:
Type
>
(
h
)
)
;
}
inline
bool
set
(
const
T
aValue
)
{
void
*
h
=
reinterpret_cast
<
void
*
>
(
static_cast
<
typename
Helper
<
T
>
:
:
Type
>
(
aValue
)
)
;
return
TlsSetValue
(
mKey
h
)
;
}
private
:
unsigned
long
mKey
;
}
;
#
endif
#
else
template
<
typename
T
>
class
ThreadLocalKeyStorage
{
public
:
constexpr
ThreadLocalKeyStorage
(
)
:
mKey
(
0
)
mInited
(
false
)
{
}
inline
bool
initialized
(
)
const
{
return
mInited
;
}
inline
void
init
(
)
{
mInited
=
!
pthread_key_create
(
&
mKey
nullptr
)
;
}
inline
T
get
(
)
const
{
void
*
h
=
pthread_getspecific
(
mKey
)
;
return
static_cast
<
T
>
(
reinterpret_cast
<
typename
Helper
<
T
>
:
:
Type
>
(
h
)
)
;
}
inline
bool
set
(
const
T
aValue
)
{
void
*
h
=
reinterpret_cast
<
void
*
>
(
static_cast
<
typename
Helper
<
T
>
:
:
Type
>
(
aValue
)
)
;
return
!
pthread_setspecific
(
mKey
h
)
;
}
private
:
pthread_key_t
mKey
;
bool
mInited
;
}
;
#
endif
template
<
typename
T
>
class
ThreadLocalNativeStorage
{
public
:
inline
bool
initialized
(
)
const
{
return
true
;
}
inline
void
init
(
)
{
}
inline
T
get
(
)
const
{
return
mValue
;
}
inline
bool
set
(
const
T
aValue
)
{
mValue
=
aValue
;
return
true
;
}
private
:
T
mValue
;
}
;
template
<
typename
T
template
<
typename
U
>
class
Storage
>
class
ThreadLocal
:
public
Storage
<
T
>
{
public
:
MOZ_MUST_USE
inline
bool
init
(
)
;
void
infallibleInit
(
)
{
MOZ_RELEASE_ASSERT
(
init
(
)
"
Infallible
TLS
initialization
failed
"
)
;
}
inline
T
get
(
)
const
;
inline
void
set
(
const
T
aValue
)
;
}
;
template
<
typename
T
template
<
typename
U
>
class
Storage
>
inline
bool
ThreadLocal
<
T
Storage
>
:
:
init
(
)
{
static_assert
(
mozilla
:
:
IsPointer
<
T
>
:
:
value
|
|
mozilla
:
:
IsIntegral
<
T
>
:
:
value
"
mozilla
:
:
ThreadLocal
must
be
used
with
a
pointer
or
"
"
integral
type
"
)
;
static_assert
(
sizeof
(
T
)
<
=
sizeof
(
void
*
)
"
mozilla
:
:
ThreadLocal
can
'
t
be
used
for
types
larger
than
"
"
a
pointer
"
)
;
if
(
!
Storage
<
T
>
:
:
initialized
(
)
)
{
Storage
<
T
>
:
:
init
(
)
;
}
return
Storage
<
T
>
:
:
initialized
(
)
;
}
template
<
typename
T
template
<
typename
U
>
class
Storage
>
inline
T
ThreadLocal
<
T
Storage
>
:
:
get
(
)
const
{
MOZ_ASSERT
(
Storage
<
T
>
:
:
initialized
(
)
)
;
return
Storage
<
T
>
:
:
get
(
)
;
}
template
<
typename
T
template
<
typename
U
>
class
Storage
>
inline
void
ThreadLocal
<
T
Storage
>
:
:
set
(
const
T
aValue
)
{
MOZ_ASSERT
(
Storage
<
T
>
:
:
initialized
(
)
)
;
bool
succeeded
=
Storage
<
T
>
:
:
set
(
aValue
)
;
if
(
!
succeeded
)
{
MOZ_CRASH
(
)
;
}
}
#
if
(
defined
(
XP_WIN
)
|
|
defined
(
MACOSX_HAS_THREAD_LOCAL
)
)
&
&
\
!
defined
(
__MINGW32__
)
#
define
MOZ_THREAD_LOCAL
(
TYPE
)
\
thread_local
:
:
mozilla
:
:
detail
:
:
ThreadLocal
<
\
TYPE
:
:
mozilla
:
:
detail
:
:
ThreadLocalNativeStorage
>
#
elif
defined
(
HAVE_THREAD_TLS_KEYWORD
)
#
define
MOZ_THREAD_LOCAL
(
TYPE
)
\
__thread
:
:
mozilla
:
:
detail
:
:
ThreadLocal
<
\
TYPE
:
:
mozilla
:
:
detail
:
:
ThreadLocalNativeStorage
>
#
else
#
define
MOZ_THREAD_LOCAL
(
TYPE
)
\
:
:
mozilla
:
:
detail
:
:
ThreadLocal
<
TYPE
:
:
mozilla
:
:
detail
:
:
ThreadLocalKeyStorage
>
#
endif
}
}
#
endif
