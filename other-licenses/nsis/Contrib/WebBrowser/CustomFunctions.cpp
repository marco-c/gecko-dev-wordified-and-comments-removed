#
include
"
WebBrowser
.
h
"
#
include
"
exdll
.
h
"
extern
WebBrowser
*
gBrowser
;
void
Init
(
HWND
hWndParent
int
string_size
TCHAR
*
variables
stack_t
*
*
stacktop
extra_parameters
*
extra
)
;
static
void
CustomFunctionWrapper
(
void
*
NSISFunctionAddr
VARIANT
jsArg
VARIANT
*
retVal
)
{
switch
(
jsArg
.
vt
)
{
case
VT_BSTR
:
pushstring
(
jsArg
.
bstrVal
)
;
break
;
case
VT_I4
:
{
TCHAR
intArgStr
[
32
]
=
_T
(
"
"
)
;
_itot_s
(
jsArg
.
intVal
intArgStr
10
)
;
pushstring
(
intArgStr
)
;
break
;
}
case
VT_BOOL
:
pushstring
(
jsArg
.
boolVal
=
=
VARIANT_TRUE
?
_T
(
"
1
"
)
:
_T
(
"
0
"
)
)
;
break
;
default
:
pushstring
(
_T
(
"
"
)
)
;
break
;
}
int
rv
=
g_executeCodeSegment
(
(
int
)
NSISFunctionAddr
g_hwndParent
)
;
TCHAR
*
nsisRetval
=
(
TCHAR
*
)
HeapAlloc
(
GetProcessHeap
(
)
0
g_stringsize
*
sizeof
(
TCHAR
)
)
;
popstring
(
nsisRetval
)
;
if
(
retVal
)
{
VariantInit
(
retVal
)
;
retVal
-
>
vt
=
VT_BSTR
;
retVal
-
>
bstrVal
=
SysAllocString
(
nsisRetval
)
;
}
HeapFree
(
GetProcessHeap
(
)
0
nsisRetval
)
;
}
PLUGINFUNCTION
(
RegisterCustomFunction
)
{
if
(
!
gBrowser
)
{
Init
(
hWndParent
string_size
variables
stacktop
extra
)
;
}
TCHAR
*
funcAddrStr
=
(
TCHAR
*
)
HeapAlloc
(
GetProcessHeap
(
)
0
g_stringsize
*
sizeof
(
TCHAR
)
)
;
popstring
(
funcAddrStr
)
;
TCHAR
*
funcName
=
(
TCHAR
*
)
HeapAlloc
(
GetProcessHeap
(
)
0
g_stringsize
*
sizeof
(
TCHAR
)
)
;
popstring
(
funcName
)
;
if
(
gBrowser
&
&
funcAddrStr
&
&
funcName
)
{
uintptr_t
funcAddr
=
static_cast
<
uintptr_t
>
(
_ttoi64
(
funcAddrStr
)
)
-
1
;
gBrowser
-
>
AddCustomFunction
(
funcName
CustomFunctionWrapper
(
void
*
)
funcAddr
)
;
}
HeapFree
(
GetProcessHeap
(
)
0
funcName
)
;
HeapFree
(
GetProcessHeap
(
)
0
funcAddrStr
)
;
}
