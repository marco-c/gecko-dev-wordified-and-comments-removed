#
include
"
StdAfx
.
h
"
#
include
"
ConsoleClose
.
h
"
#
if
!
defined
(
UNDER_CE
)
&
&
defined
(
_WIN32
)
#
include
"
.
.
/
.
.
/
.
.
/
Common
/
MyWindows
.
h
"
#
endif
namespace
NConsoleClose
{
unsigned
g_BreakCounter
=
0
;
static
const
unsigned
kBreakAbortThreshold
=
2
;
#
if
!
defined
(
UNDER_CE
)
&
&
defined
(
_WIN32
)
static
BOOL
WINAPI
HandlerRoutine
(
DWORD
ctrlType
)
{
if
(
ctrlType
=
=
CTRL_LOGOFF_EVENT
)
{
return
TRUE
;
}
g_BreakCounter
+
+
;
if
(
g_BreakCounter
<
kBreakAbortThreshold
)
return
TRUE
;
return
FALSE
;
}
#
endif
CCtrlHandlerSetter
:
:
CCtrlHandlerSetter
(
)
{
#
if
!
defined
(
UNDER_CE
)
&
&
defined
(
_WIN32
)
if
(
!
SetConsoleCtrlHandler
(
HandlerRoutine
TRUE
)
)
throw
"
SetConsoleCtrlHandler
fails
"
;
#
endif
}
CCtrlHandlerSetter
:
:
~
CCtrlHandlerSetter
(
)
{
#
if
!
defined
(
UNDER_CE
)
&
&
defined
(
_WIN32
)
if
(
!
SetConsoleCtrlHandler
(
HandlerRoutine
FALSE
)
)
{
}
#
endif
}
}
