#
include
"
storage_test_harness
.
h
"
#
include
"
nsThreadUtils
.
h
"
class
ServiceInitializer
:
public
mozilla
:
:
Runnable
{
public
:
ServiceInitializer
(
)
:
mozilla
:
:
Runnable
(
"
ServiceInitializer
"
)
{
}
NS_IMETHOD
Run
(
)
override
{
nsCOMPtr
<
mozIStorageService
>
service
=
do_GetService
(
"
mozilla
.
org
/
storage
/
service
;
1
"
)
;
do_check_false
(
service
)
;
return
NS_OK
;
}
}
;
TEST
(
storage_service_init_background_thread_DeathTest
Test
)
{
nsCOMPtr
<
nsIRunnable
>
event
=
new
ServiceInitializer
(
)
;
do_check_true
(
event
)
;
nsCOMPtr
<
nsIThread
>
thread
;
do_check_success
(
NS_NewNamedThread
(
"
StorageService
"
getter_AddRefs
(
thread
)
)
)
;
do_check_success
(
thread
-
>
Dispatch
(
event
NS_DISPATCH_NORMAL
)
)
;
do_check_success
(
thread
-
>
Shutdown
(
)
)
;
}
