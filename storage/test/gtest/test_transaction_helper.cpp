#
include
"
storage_test_harness
.
h
"
#
include
"
mozStorageHelper
.
h
"
#
include
"
mozStorageConnection
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
storage
;
bool
has_transaction
(
mozIStorageConnection
*
aDB
)
{
return
!
(
static_cast
<
Connection
*
>
(
aDB
)
-
>
getAutocommit
(
)
)
;
}
TEST
(
storage_transaction_helper
Commit
)
{
nsCOMPtr
<
mozIStorageConnection
>
db
(
getMemoryDatabase
(
)
)
;
{
mozStorageTransaction
transaction
(
db
false
)
;
do_check_true
(
has_transaction
(
db
)
)
;
(
void
)
db
-
>
ExecuteSimpleSQL
(
"
CREATE
TABLE
test
(
id
INTEGER
PRIMARY
KEY
)
"
_ns
)
;
(
void
)
transaction
.
Commit
(
)
;
}
do_check_false
(
has_transaction
(
db
)
)
;
bool
exists
=
false
;
(
void
)
db
-
>
TableExists
(
"
test
"
_ns
&
exists
)
;
do_check_true
(
exists
)
;
}
TEST
(
storage_transaction_helper
Rollback
)
{
nsCOMPtr
<
mozIStorageConnection
>
db
(
getMemoryDatabase
(
)
)
;
{
mozStorageTransaction
transaction
(
db
true
)
;
do_check_true
(
has_transaction
(
db
)
)
;
(
void
)
db
-
>
ExecuteSimpleSQL
(
"
CREATE
TABLE
test
(
id
INTEGER
PRIMARY
KEY
)
"
_ns
)
;
(
void
)
transaction
.
Rollback
(
)
;
}
do_check_false
(
has_transaction
(
db
)
)
;
bool
exists
=
true
;
(
void
)
db
-
>
TableExists
(
"
test
"
_ns
&
exists
)
;
do_check_false
(
exists
)
;
}
TEST
(
storage_transaction_helper
AutoCommit
)
{
nsCOMPtr
<
mozIStorageConnection
>
db
(
getMemoryDatabase
(
)
)
;
{
mozStorageTransaction
transaction
(
db
true
)
;
do_check_true
(
has_transaction
(
db
)
)
;
(
void
)
db
-
>
ExecuteSimpleSQL
(
"
CREATE
TABLE
test
(
id
INTEGER
PRIMARY
KEY
)
"
_ns
)
;
}
do_check_false
(
has_transaction
(
db
)
)
;
bool
exists
=
false
;
(
void
)
db
-
>
TableExists
(
"
test
"
_ns
&
exists
)
;
do_check_true
(
exists
)
;
}
TEST
(
storage_transaction_helper
AutoRollback
)
{
nsCOMPtr
<
mozIStorageConnection
>
db
(
getMemoryDatabase
(
)
)
;
{
mozStorageTransaction
transaction
(
db
false
)
;
do_check_true
(
has_transaction
(
db
)
)
;
(
void
)
db
-
>
ExecuteSimpleSQL
(
"
CREATE
TABLE
test
(
id
INTEGER
PRIMARY
KEY
)
"
_ns
)
;
}
do_check_false
(
has_transaction
(
db
)
)
;
bool
exists
=
true
;
(
void
)
db
-
>
TableExists
(
"
test
"
_ns
&
exists
)
;
do_check_false
(
exists
)
;
}
TEST
(
storage_transaction_helper
null_database_connection
)
{
mozStorageTransaction
transaction
(
nullptr
false
)
;
do_check_true
(
NS_SUCCEEDED
(
transaction
.
Commit
(
)
)
)
;
do_check_true
(
NS_SUCCEEDED
(
transaction
.
Rollback
(
)
)
)
;
}
TEST
(
storage_transaction_helper
async_Commit
)
{
HookSqliteMutex
hook
;
nsCOMPtr
<
mozIStorageConnection
>
db
(
getMemoryDatabase
(
)
)
;
nsCOMPtr
<
nsIThread
>
target
(
get_conn_async_thread
(
db
)
)
;
do_check_true
(
target
)
;
RefPtr
<
ThreadWedger
>
wedger
(
new
ThreadWedger
(
target
)
)
;
{
mozStorageTransaction
transaction
(
db
false
mozIStorageConnection
:
:
TRANSACTION_DEFERRED
true
)
;
do_check_true
(
has_transaction
(
db
)
)
;
(
void
)
db
-
>
ExecuteSimpleSQL
(
"
CREATE
TABLE
test
(
id
INTEGER
PRIMARY
KEY
)
"
_ns
)
;
(
void
)
transaction
.
Commit
(
)
;
}
do_check_true
(
has_transaction
(
db
)
)
;
wedger
-
>
unwedge
(
)
;
nsCOMPtr
<
mozIStorageAsyncStatement
>
stmt
;
(
void
)
db
-
>
CreateAsyncStatement
(
"
SELECT
NULL
"
_ns
getter_AddRefs
(
stmt
)
)
;
blocking_async_execute
(
stmt
)
;
stmt
-
>
Finalize
(
)
;
do_check_false
(
has_transaction
(
db
)
)
;
bool
exists
=
false
;
(
void
)
db
-
>
TableExists
(
"
test
"
_ns
&
exists
)
;
do_check_true
(
exists
)
;
blocking_async_close
(
db
)
;
}
TEST
(
storage_transaction_helper
Nesting
)
{
nsCOMPtr
<
mozIStorageConnection
>
db
(
getMemoryDatabase
(
)
)
;
{
mozStorageTransaction
transaction
(
db
false
)
;
do_check_true
(
has_transaction
(
db
)
)
;
do_check_success
(
db
-
>
ExecuteSimpleSQL
(
"
CREATE
TABLE
test
(
id
INTEGER
PRIMARY
KEY
)
"
_ns
)
)
;
{
mozStorageTransaction
nestedTransaction
(
db
false
)
;
do_check_true
(
has_transaction
(
db
)
)
;
do_check_success
(
db
-
>
ExecuteSimpleSQL
(
"
CREATE
TABLE
nested_test
(
id
INTEGER
PRIMARY
KEY
)
"
_ns
)
)
;
#
ifndef
MOZ_DIAGNOSTIC_ASSERT_ENABLED
do_check_true
(
transaction
.
Commit
(
)
=
=
NS_ERROR_NOT_AVAILABLE
)
;
do_check_true
(
transaction
.
Rollback
(
)
=
=
NS_ERROR_NOT_AVAILABLE
)
;
#
endif
}
bool
exists
=
false
;
do_check_success
(
db
-
>
TableExists
(
"
nested_test
"
_ns
&
exists
)
)
;
do_check_false
(
exists
)
;
(
void
)
transaction
.
Commit
(
)
;
}
do_check_false
(
has_transaction
(
db
)
)
;
bool
exists
=
false
;
do_check_success
(
db
-
>
TableExists
(
"
test
"
_ns
&
exists
)
)
;
do_check_true
(
exists
)
;
}
