#
ifndef
PreloadService_h__
#
define
PreloadService_h__
#
include
"
nsIContentPolicy
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
#
include
"
mozilla
/
PreloadHashKey
.
h
"
class
nsINode
;
namespace
mozilla
{
class
PreloaderBase
;
namespace
dom
{
class
HTMLLinkElement
;
class
Document
;
enum
class
ReferrerPolicy
:
uint8_t
;
}
class
PreloadService
{
public
:
explicit
PreloadService
(
dom
:
:
Document
*
)
;
~
PreloadService
(
)
;
bool
RegisterPreload
(
const
PreloadHashKey
&
aKey
PreloaderBase
*
aPreload
)
;
void
DeregisterPreload
(
const
PreloadHashKey
&
aKey
)
;
void
ClearAllPreloads
(
)
;
bool
PreloadExists
(
const
PreloadHashKey
&
aKey
)
;
already_AddRefed
<
PreloaderBase
>
LookupPreload
(
const
PreloadHashKey
&
aKey
)
const
;
void
SetSpeculationBase
(
nsIURI
*
aURI
)
{
mSpeculationBaseURI
=
aURI
;
}
already_AddRefed
<
nsIURI
>
GetPreloadURI
(
const
nsAString
&
aURL
)
;
already_AddRefed
<
PreloaderBase
>
PreloadLinkElement
(
dom
:
:
HTMLLinkElement
*
aLink
nsContentPolicyType
aPolicyType
)
;
void
PreloadLinkHeader
(
nsIURI
*
aURI
const
nsAString
&
aURL
nsContentPolicyType
aPolicyType
const
nsAString
&
aAs
const
nsAString
&
aType
const
nsAString
&
aIntegrity
const
nsAString
&
aSrcset
const
nsAString
&
aSizes
const
nsAString
&
aCORS
const
nsAString
&
aReferrerPolicy
uint64_t
aEarlyHintPreloaderId
)
;
void
PreloadScript
(
nsIURI
*
aURI
const
nsAString
&
aType
const
nsAString
&
aCharset
const
nsAString
&
aCrossOrigin
const
nsAString
&
aReferrerPolicy
const
nsAString
&
aNonce
const
nsAString
&
aIntegrity
bool
aScriptFromHead
uint64_t
aEarlyHintPreloaderId
)
;
void
PreloadImage
(
nsIURI
*
aURI
const
nsAString
&
aCrossOrigin
const
nsAString
&
aImageReferrerPolicy
bool
aIsImgSet
uint64_t
aEarlyHintPreloaderId
)
;
void
PreloadFont
(
nsIURI
*
aURI
const
nsAString
&
aCrossOrigin
const
nsAString
&
aReferrerPolicy
uint64_t
aEarlyHintPreloaderId
)
;
void
PreloadFetch
(
nsIURI
*
aURI
const
nsAString
&
aCrossOrigin
const
nsAString
&
aReferrerPolicy
uint64_t
aEarlyHintPreloaderId
)
;
static
void
NotifyNodeEvent
(
nsINode
*
aNode
bool
aSuccess
)
;
void
SetEarlyHintUsed
(
)
{
mEarlyHintUsed
=
true
;
}
bool
GetEarlyHintUsed
(
)
const
{
return
mEarlyHintUsed
;
}
private
:
dom
:
:
ReferrerPolicy
PreloadReferrerPolicy
(
const
nsAString
&
aReferrerPolicy
)
;
nsIURI
*
BaseURIForPreload
(
)
;
struct
PreloadOrCoalesceResult
{
RefPtr
<
PreloaderBase
>
mPreloader
;
bool
mAlreadyComplete
;
}
;
PreloadOrCoalesceResult
PreloadOrCoalesce
(
nsIURI
*
aURI
const
nsAString
&
aURL
nsContentPolicyType
aPolicyType
const
nsAString
&
aAs
const
nsAString
&
aType
const
nsAString
&
aCharset
const
nsAString
&
aSrcset
const
nsAString
&
aSizes
const
nsAString
&
aNonce
const
nsAString
&
aIntegrity
const
nsAString
&
aCORS
const
nsAString
&
aReferrerPolicy
bool
aFromHeader
uint64_t
aEarlyHintPreloaderId
)
;
private
:
nsRefPtrHashtable
<
PreloadHashKey
PreloaderBase
>
mPreloads
;
dom
:
:
Document
*
mDocument
;
nsCOMPtr
<
nsIURI
>
mSpeculationBaseURI
;
bool
mEarlyHintUsed
=
false
;
}
;
}
#
endif
