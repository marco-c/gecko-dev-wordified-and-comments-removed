Cu
.
import
(
"
resource
:
/
/
services
-
sync
/
engines
.
js
"
)
;
Cu
.
import
(
"
resource
:
/
/
services
-
sync
/
service
.
js
"
)
;
Cu
.
import
(
"
resource
:
/
/
services
-
sync
/
util
.
js
"
)
;
Cu
.
import
(
"
resource
:
/
/
testing
-
common
/
services
/
sync
/
utils
.
js
"
)
;
async
function
makeSteamEngine
(
)
{
let
engine
=
new
SyncEngine
(
"
Steam
"
Service
)
;
await
engine
.
initialize
(
)
;
return
engine
;
}
let
server
;
add_task
(
async
function
setup
(
)
{
server
=
httpd_setup
(
{
}
)
;
}
)
;
add_task
(
async
function
test_url_attributes
(
)
{
_
(
"
SyncEngine
url
attributes
"
)
;
await
SyncTestingInfrastructure
(
server
)
;
Service
.
clusterURL
=
"
https
:
/
/
cluster
/
1
.
1
/
foo
/
"
;
let
engine
=
await
makeSteamEngine
(
)
;
try
{
do_check_eq
(
engine
.
storageURL
"
https
:
/
/
cluster
/
1
.
1
/
foo
/
storage
/
"
)
;
do_check_eq
(
engine
.
engineURL
"
https
:
/
/
cluster
/
1
.
1
/
foo
/
storage
/
steam
"
)
;
do_check_eq
(
engine
.
metaURL
"
https
:
/
/
cluster
/
1
.
1
/
foo
/
storage
/
meta
/
global
"
)
;
}
finally
{
Svc
.
Prefs
.
resetBranch
(
"
"
)
;
}
}
)
;
add_task
(
async
function
test_syncID
(
)
{
_
(
"
SyncEngine
.
syncID
corresponds
to
preference
"
)
;
await
SyncTestingInfrastructure
(
server
)
;
let
engine
=
await
makeSteamEngine
(
)
;
try
{
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
syncID
"
)
undefined
)
;
do_check_eq
(
engine
.
syncID
"
fake
-
guid
-
00
"
)
;
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
syncID
"
)
"
fake
-
guid
-
00
"
)
;
Svc
.
Prefs
.
set
(
"
steam
.
syncID
"
Utils
.
makeGUID
(
)
)
;
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
syncID
"
)
"
fake
-
guid
-
01
"
)
;
do_check_eq
(
engine
.
syncID
"
fake
-
guid
-
01
"
)
;
}
finally
{
Svc
.
Prefs
.
resetBranch
(
"
"
)
;
}
}
)
add_task
(
async
function
test_lastSync
(
)
{
_
(
"
SyncEngine
.
lastSync
and
SyncEngine
.
lastSyncLocal
correspond
to
preferences
"
)
;
await
SyncTestingInfrastructure
(
server
)
;
let
engine
=
await
makeSteamEngine
(
)
;
try
{
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
lastSync
"
)
undefined
)
;
do_check_eq
(
engine
.
lastSync
0
)
;
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
lastSyncLocal
"
)
undefined
)
;
do_check_eq
(
engine
.
lastSyncLocal
0
)
;
engine
.
lastSync
=
123
.
45
;
do_check_eq
(
engine
.
lastSync
123
.
45
)
;
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
lastSync
"
)
"
123
.
45
"
)
;
engine
.
lastSyncLocal
=
67890
;
do_check_eq
(
engine
.
lastSyncLocal
67890
)
;
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
lastSyncLocal
"
)
"
67890
"
)
;
engine
.
resetLastSync
(
)
;
do_check_eq
(
engine
.
lastSync
0
)
;
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
lastSync
"
)
"
0
"
)
;
}
finally
{
Svc
.
Prefs
.
resetBranch
(
"
"
)
;
}
}
)
add_task
(
async
function
test_toFetch
(
)
{
_
(
"
SyncEngine
.
toFetch
corresponds
to
file
on
disk
"
)
;
let
syncTesting
=
await
SyncTestingInfrastructure
(
server
)
;
const
filename
=
"
weave
/
toFetch
/
steam
.
json
"
;
let
engine
=
await
makeSteamEngine
(
)
;
try
{
do_check_eq
(
engine
.
toFetch
.
length
0
)
;
let
toFetch
=
[
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
]
;
engine
.
toFetch
=
toFetch
;
do_check_eq
(
engine
.
toFetch
toFetch
)
;
await
Async
.
promiseYield
(
)
;
let
fakefile
=
syncTesting
.
fakeFilesystem
.
fakeContents
[
filename
]
;
do_check_eq
(
fakefile
JSON
.
stringify
(
toFetch
)
)
;
toFetch
=
[
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
]
;
syncTesting
.
fakeFilesystem
.
fakeContents
[
filename
]
=
JSON
.
stringify
(
toFetch
)
;
await
engine
.
loadToFetch
(
)
;
do_check_eq
(
engine
.
toFetch
.
length
2
)
;
do_check_eq
(
engine
.
toFetch
[
0
]
toFetch
[
0
]
)
;
do_check_eq
(
engine
.
toFetch
[
1
]
toFetch
[
1
]
)
;
}
finally
{
Svc
.
Prefs
.
resetBranch
(
"
"
)
;
}
}
)
;
add_task
(
async
function
test_previousFailed
(
)
{
_
(
"
SyncEngine
.
previousFailed
corresponds
to
file
on
disk
"
)
;
let
syncTesting
=
await
SyncTestingInfrastructure
(
server
)
;
const
filename
=
"
weave
/
failed
/
steam
.
json
"
;
let
engine
=
await
makeSteamEngine
(
)
;
try
{
do_check_eq
(
engine
.
previousFailed
.
length
0
)
;
let
previousFailed
=
[
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
]
;
engine
.
previousFailed
=
previousFailed
;
do_check_eq
(
engine
.
previousFailed
previousFailed
)
;
await
Async
.
promiseYield
(
)
;
let
fakefile
=
syncTesting
.
fakeFilesystem
.
fakeContents
[
filename
]
;
do_check_eq
(
fakefile
JSON
.
stringify
(
previousFailed
)
)
;
previousFailed
=
[
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
]
;
syncTesting
.
fakeFilesystem
.
fakeContents
[
filename
]
=
JSON
.
stringify
(
previousFailed
)
;
await
engine
.
loadPreviousFailed
(
)
;
do_check_eq
(
engine
.
previousFailed
.
length
2
)
;
do_check_eq
(
engine
.
previousFailed
[
0
]
previousFailed
[
0
]
)
;
do_check_eq
(
engine
.
previousFailed
[
1
]
previousFailed
[
1
]
)
;
}
finally
{
Svc
.
Prefs
.
resetBranch
(
"
"
)
;
}
}
)
;
add_task
(
async
function
test_resetClient
(
)
{
_
(
"
SyncEngine
.
resetClient
resets
lastSync
and
toFetch
"
)
;
await
SyncTestingInfrastructure
(
server
)
;
let
engine
=
await
makeSteamEngine
(
)
;
try
{
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
lastSync
"
)
undefined
)
;
do_check_eq
(
Svc
.
Prefs
.
get
(
"
steam
.
lastSyncLocal
"
)
undefined
)
;
do_check_eq
(
engine
.
toFetch
.
length
0
)
;
engine
.
lastSync
=
123
.
45
;
engine
.
lastSyncLocal
=
67890
;
engine
.
toFetch
=
[
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
]
;
engine
.
previousFailed
=
[
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
]
;
await
engine
.
resetClient
(
)
;
do_check_eq
(
engine
.
lastSync
0
)
;
do_check_eq
(
engine
.
lastSyncLocal
0
)
;
do_check_eq
(
engine
.
toFetch
.
length
0
)
;
do_check_eq
(
engine
.
previousFailed
.
length
0
)
;
}
finally
{
Svc
.
Prefs
.
resetBranch
(
"
"
)
;
}
}
)
;
add_task
(
async
function
test_wipeServer
(
)
{
_
(
"
SyncEngine
.
wipeServer
deletes
server
data
and
resets
the
client
.
"
)
;
let
engine
=
await
makeSteamEngine
(
)
;
const
PAYLOAD
=
42
;
let
steamCollection
=
new
ServerWBO
(
"
steam
"
PAYLOAD
)
;
let
steamServer
=
httpd_setup
(
{
"
/
1
.
1
/
foo
/
storage
/
steam
"
:
steamCollection
.
handler
(
)
}
)
;
await
SyncTestingInfrastructure
(
steamServer
)
;
do_test_pending
(
)
;
try
{
engine
.
lastSync
=
123
.
45
;
engine
.
toFetch
=
[
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
Utils
.
makeGUID
(
)
]
;
_
(
"
Wipe
server
data
and
reset
client
.
"
)
;
await
engine
.
wipeServer
(
)
;
do_check_eq
(
steamCollection
.
payload
undefined
)
;
do_check_eq
(
engine
.
lastSync
0
)
;
do_check_eq
(
engine
.
toFetch
.
length
0
)
;
}
finally
{
steamServer
.
stop
(
do_test_finished
)
;
Svc
.
Prefs
.
resetBranch
(
"
"
)
;
}
}
)
;
add_task
(
async
function
finish
(
)
{
await
promiseStopServer
(
server
)
;
}
)
;
