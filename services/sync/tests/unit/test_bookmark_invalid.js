const
{
BookmarksEngine
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
services
-
sync
/
engines
/
bookmarks
.
js
"
)
;
const
{
Service
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
services
-
sync
/
service
.
js
"
)
;
let
engine
;
let
store
;
let
tracker
;
add_task
(
async
function
setup
(
)
{
engine
=
new
BookmarksEngine
(
Service
)
;
store
=
engine
.
_store
;
tracker
=
engine
.
_tracker
;
}
)
;
add_task
(
async
function
test_ignore_invalid_uri
(
)
{
_
(
"
Ensure
that
we
don
'
t
die
with
invalid
bookmarks
.
"
)
;
let
bmInfo
=
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
url
:
"
http
:
/
/
example
.
com
/
"
title
:
"
the
title
"
}
)
;
await
PlacesUtils
.
withConnectionWrapper
(
"
test_ignore_invalid_uri
"
async
function
(
db
)
{
await
db
.
execute
(
UPDATE
moz_places
SET
url
=
:
url
url_hash
=
hash
(
:
url
)
WHERE
id
=
(
SELECT
b
.
fk
FROM
moz_bookmarks
b
WHERE
b
.
guid
=
:
guid
)
{
guid
:
bmInfo
.
guid
url
:
"
<
invalid
url
>
"
}
)
;
}
)
;
await
engine
.
_buildGUIDMap
(
)
;
}
)
;
add_task
(
async
function
test_ignore_missing_uri
(
)
{
_
(
"
Ensure
that
we
don
'
t
die
with
a
bookmark
referencing
an
invalid
bookmark
id
.
"
)
;
let
bmInfo
=
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
url
:
"
http
:
/
/
example
.
com
/
"
title
:
"
the
title
"
}
)
;
await
PlacesUtils
.
withConnectionWrapper
(
"
test_ignore_missing_uri
"
async
function
(
db
)
{
await
db
.
execute
(
UPDATE
moz_bookmarks
SET
fk
=
999999
WHERE
guid
=
:
guid
{
guid
:
bmInfo
.
guid
}
)
;
}
)
;
await
engine
.
_buildGUIDMap
(
)
;
}
)
;
