ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
this
)
;
const
TEST_PAGE_URI
=
"
data
:
text
/
html
;
charset
=
utf
-
8
The
letter
s
.
"
;
const
E10S_PARENT_TEST_PAGE_URI
=
getRootDirectory
(
gTestPath
)
+
"
file_empty
.
html
"
;
const
TEST_PAGE_URI_WITHIFRAME
=
"
https
:
/
/
example
.
com
/
browser
/
toolkit
/
content
/
tests
/
browser
/
file_findinframe
.
html
"
;
add_task
(
async
function
test_hotkey_event_propagation
(
)
{
info
(
"
Ensure
hotkeys
are
not
affected
by
stopPropagation
.
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
let
findbar
=
await
gBrowser
.
getFindBar
(
)
;
const
HOTKEYS
=
[
"
/
"
"
'
"
]
;
for
(
let
key
of
HOTKEYS
)
{
is
(
findbar
.
hidden
true
"
Findbar
is
hidden
now
.
"
)
;
gBrowser
.
selectedTab
=
tab
;
await
SimpleTest
.
promiseFocus
(
gBrowser
.
selectedBrowser
)
;
await
BrowserTestUtils
.
sendChar
(
key
browser
)
;
is
(
findbar
.
hidden
false
"
Findbar
should
not
be
hidden
.
"
)
;
await
closeFindbarAndWait
(
findbar
)
;
}
let
frameScript
=
(
)
=
>
{
const
stopPropagation
=
e
=
>
e
.
stopImmediatePropagation
(
)
;
let
window
=
content
.
document
.
defaultView
;
window
.
removeEventListener
(
"
keydown
"
stopPropagation
)
;
window
.
removeEventListener
(
"
keypress
"
stopPropagation
)
;
window
.
removeEventListener
(
"
keyup
"
stopPropagation
)
;
}
;
let
mm
=
browser
.
messageManager
;
mm
.
loadFrameScript
(
"
data
:
(
"
+
frameScript
.
toString
(
)
+
"
)
(
)
;
"
false
)
;
for
(
let
key
of
HOTKEYS
)
{
is
(
findbar
.
hidden
true
"
Findbar
is
hidden
now
.
"
)
;
gBrowser
.
selectedTab
=
tab
;
await
SimpleTest
.
promiseFocus
(
gBrowser
.
selectedBrowser
)
;
await
BrowserTestUtils
.
sendChar
(
key
browser
)
;
is
(
findbar
.
hidden
false
"
Findbar
should
not
be
hidden
.
"
)
;
await
closeFindbarAndWait
(
findbar
)
;
}
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_not_found
(
)
{
info
(
"
Check
correct
'
Phrase
not
found
'
on
new
tab
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
await
promiseFindFinished
(
"
-
-
-
THIS
SHOULD
NEVER
MATCH
-
-
-
"
false
)
;
let
findbar
=
gBrowser
.
getCachedFindBar
(
)
;
is
(
findbar
.
_findStatusDesc
.
textContent
findbar
.
_notFoundStr
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_found
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
await
promiseFindFinished
(
"
S
"
true
)
;
ok
(
!
gBrowser
.
getCachedFindBar
(
)
.
_findStatusDesc
.
textContent
"
Findbar
status
should
be
empty
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_tabwise_case_sensitive
(
)
{
let
tab1
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
findbar1
=
await
gBrowser
.
getFindBar
(
)
;
let
tab2
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
findbar2
=
await
gBrowser
.
getFindBar
(
)
;
findbar1
.
getElement
(
"
find
-
case
-
sensitive
"
)
.
click
(
)
;
gBrowser
.
selectedTab
=
tab1
;
await
promiseFindFinished
(
"
S
"
true
)
;
is
(
findbar1
.
_findStatusDesc
.
textContent
findbar1
.
_notFoundStr
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
gBrowser
.
selectedTab
=
tab2
;
await
promiseFindFinished
(
"
S
"
true
)
;
ok
(
!
findbar2
.
_findStatusDesc
.
textContent
"
Findbar
status
should
be
empty
"
)
;
gBrowser
.
removeTab
(
tab1
)
;
gBrowser
.
removeTab
(
tab2
)
;
}
)
;
add_task
(
async
function
test_reinitialization_at_remoteness_change
(
)
{
if
(
!
gMultiProcessBrowser
)
{
info
(
"
Skipping
this
test
because
of
non
-
e10s
environment
.
"
)
;
return
;
}
info
(
"
Ensure
findbar
re
-
initialization
at
remoteness
change
.
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
let
findbar
=
await
gBrowser
.
getFindBar
(
)
;
await
promiseFindFinished
(
"
z
"
false
)
;
is
(
findbar
.
_findStatusDesc
.
textContent
findbar
.
_notFoundStr
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
await
promiseFindFinished
(
"
s
"
false
)
;
ok
(
!
findbar
.
_findStatusDesc
.
textContent
"
Findbar
status
should
be
empty
"
)
;
ok
(
browser
.
isRemoteBrowser
"
Browser
should
be
remote
now
.
"
)
;
await
promiseRemotenessChange
(
tab
false
)
;
let
docLoaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
E10S_PARENT_TEST_PAGE_URI
)
;
BrowserTestUtils
.
loadURI
(
browser
E10S_PARENT_TEST_PAGE_URI
)
;
await
docLoaded
;
ok
(
!
browser
.
isRemoteBrowser
"
Browser
should
not
be
remote
any
more
.
"
)
;
browser
.
contentDocument
.
body
.
append
(
"
The
letter
s
.
"
)
;
browser
.
contentDocument
.
body
.
clientHeight
;
await
promiseFindFinished
(
"
z
"
false
)
;
is
(
findbar
.
_findStatusDesc
.
textContent
findbar
.
_notFoundStr
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
await
promiseFindFinished
(
"
s
"
false
)
;
ok
(
!
findbar
.
_findStatusDesc
.
textContent
"
Findbar
status
should
be
empty
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
e10sLostKeys
(
)
{
if
(
!
gMultiProcessBrowser
)
{
info
(
"
Skipping
this
test
because
of
non
-
e10s
environment
.
"
)
;
return
;
}
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
ok
(
!
gFindBarInitialized
"
findbar
isn
'
t
initialized
yet
"
)
;
await
gFindBarPromise
;
let
findBar
=
gFindBar
;
let
initialValue
=
findBar
.
_findField
.
value
;
await
EventUtils
.
synthesizeAndWaitKey
(
"
F
"
{
accelKey
:
true
}
window
null
(
)
=
>
{
isnot
(
document
.
activeElement
findBar
.
_findField
"
findbar
is
not
yet
focused
"
)
;
EventUtils
.
synthesizeKey
(
"
a
"
)
;
EventUtils
.
synthesizeKey
(
"
b
"
)
;
EventUtils
.
synthesizeKey
(
"
c
"
)
;
is
(
findBar
.
_findField
.
value
initialValue
"
still
has
initial
find
query
"
)
;
}
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
findBar
.
_findField
.
value
.
length
=
=
3
)
;
is
(
document
.
activeElement
findBar
.
_findField
"
findbar
is
now
focused
"
)
;
is
(
findBar
.
_findField
.
value
"
abc
"
"
abc
fully
entered
as
find
query
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_open_and_close_keys
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
body
style
=
'
height
:
5000px
;
'
>
Hello
There
<
/
body
>
"
)
;
await
gFindBarPromise
;
let
findBar
=
gFindBar
;
is
(
findBar
.
hidden
true
"
Findbar
is
hidden
now
.
"
)
;
let
openedPromise
=
BrowserTestUtils
.
waitForEvent
(
findBar
"
findbaropen
"
)
;
await
EventUtils
.
synthesizeKey
(
"
f
"
{
accelKey
:
true
}
)
;
await
openedPromise
;
is
(
findBar
.
hidden
false
"
Findbar
should
not
be
hidden
.
"
)
;
let
closedPromise
=
BrowserTestUtils
.
waitForEvent
(
findBar
"
findbarclose
"
)
;
await
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
closedPromise
;
let
scrollPromise
=
BrowserTestUtils
.
waitForContentEvent
(
tab
.
linkedBrowser
"
scroll
"
)
;
await
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
await
scrollPromise
;
let
scrollPosition
=
await
SpecialPowers
.
spawn
(
tab
.
linkedBrowser
[
]
async
function
(
)
{
return
content
.
document
.
body
.
scrollTop
;
}
)
;
ok
(
scrollPosition
>
0
"
Scrolled
ok
to
"
+
scrollPosition
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_hotkey_insubframe
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI_WITHIFRAME
)
;
await
gFindBarPromise
;
let
findBar
=
gFindBar
;
let
browser
=
gBrowser
.
selectedBrowser
;
let
frameBC
=
browser
.
browsingContext
.
getChildren
(
)
[
0
]
;
await
SpecialPowers
.
spawn
(
frameBC
[
]
async
(
)
=
>
{
content
.
document
.
body
.
focus
(
)
;
content
.
document
.
defaultView
.
focus
(
)
;
}
)
;
let
findBarOpenPromise
=
BrowserTestUtils
.
waitForEvent
(
gBrowser
"
findbaropen
"
)
;
EventUtils
.
synthesizeKey
(
"
f
"
{
accelKey
:
true
}
)
;
await
findBarOpenPromise
;
let
cursorPos
=
await
SpecialPowers
.
spawn
(
frameBC
[
]
async
(
)
=
>
{
content
.
document
.
body
.
focus
(
)
;
content
.
document
.
defaultView
.
focus
(
)
;
return
content
.
getSelection
(
)
.
anchorOffset
;
}
)
;
is
(
cursorPos
0
"
initial
cursor
position
"
)
;
await
BrowserTestUtils
.
synthesizeKey
(
"
KEY_ArrowRight
"
{
}
frameBC
)
;
cursorPos
=
await
SpecialPowers
.
spawn
(
frameBC
[
]
async
(
)
=
>
{
return
content
.
getSelection
(
)
.
anchorOffset
;
}
)
;
is
(
cursorPos
1
"
cursor
moved
"
)
;
await
closeFindbarAndWait
(
findBar
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
async
function
promiseFindFinished
(
searchText
highlightOn
)
{
let
findbar
=
await
gBrowser
.
getFindBar
(
)
;
findbar
.
startFind
(
findbar
.
FIND_NORMAL
)
;
let
highlightElement
=
findbar
.
getElement
(
"
highlight
"
)
;
if
(
highlightElement
.
checked
!
=
highlightOn
)
{
highlightElement
.
click
(
)
;
}
return
new
Promise
(
resolve
=
>
{
executeSoon
(
(
)
=
>
{
findbar
.
_findField
.
value
=
searchText
;
let
resultListener
;
let
waitMore
=
highlightOn
;
let
findTimeout
=
setTimeout
(
(
)
=
>
foundOrTimedout
(
null
)
2000
)
;
let
foundOrTimedout
=
function
(
aData
)
{
if
(
aData
!
=
=
null
&
&
waitMore
)
{
waitMore
=
false
;
return
;
}
if
(
aData
=
=
=
null
)
{
info
(
"
Result
listener
not
called
timeout
reached
.
"
)
;
}
clearTimeout
(
findTimeout
)
;
findbar
.
browser
.
finder
.
removeResultListener
(
resultListener
)
;
resolve
(
)
;
}
;
resultListener
=
{
onFindResult
:
foundOrTimedout
onCurrentSelection
(
)
{
}
onMatchesCountResult
(
)
{
}
onHighlightFinished
(
)
{
}
}
;
findbar
.
browser
.
finder
.
addResultListener
(
resultListener
)
;
findbar
.
_find
(
)
;
}
)
;
}
)
;
}
function
promiseRemotenessChange
(
tab
shouldBeRemote
)
{
return
new
Promise
(
resolve
=
>
{
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
tab
.
addEventListener
(
"
TabRemotenessChange
"
function
(
)
{
resolve
(
)
;
}
{
once
:
true
}
)
;
let
remoteType
=
shouldBeRemote
?
E10SUtils
.
DEFAULT_REMOTE_TYPE
:
E10SUtils
.
NOT_REMOTE
;
gBrowser
.
updateBrowserRemoteness
(
browser
{
remoteType
}
)
;
}
)
;
}
