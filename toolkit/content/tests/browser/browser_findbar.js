const
{
setTimeout
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
sys
.
mjs
"
)
;
const
{
ContentTaskUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
ContentTaskUtils
.
sys
.
mjs
"
)
;
requestLongerTimeout
(
2
)
;
const
TEST_PAGE_URI
=
"
data
:
text
/
html
;
charset
=
utf
-
8
The
letter
s
.
"
;
const
E10S_PARENT_TEST_PAGE_URI
=
getRootDirectory
(
gTestPath
)
+
"
file_empty
.
html
"
;
const
TEST_PAGE_URI_WITHIFRAME
=
"
https
:
/
/
example
.
com
/
browser
/
toolkit
/
content
/
tests
/
browser
/
file_findinframe
.
html
"
;
add_task
(
async
function
test_hotkey_event_propagation
(
)
{
info
(
"
Ensure
hotkeys
are
not
affected
by
stopPropagation
.
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
let
findbar
=
await
gBrowser
.
getFindBar
(
)
;
const
HOTKEYS
=
[
"
/
"
"
'
"
]
;
for
(
let
key
of
HOTKEYS
)
{
is
(
findbar
.
hidden
true
"
Findbar
is
hidden
now
.
"
)
;
gBrowser
.
selectedTab
=
tab
;
await
SimpleTest
.
promiseFocus
(
gBrowser
.
selectedBrowser
)
;
await
BrowserTestUtils
.
sendChar
(
key
browser
)
;
is
(
findbar
.
hidden
false
"
Findbar
should
not
be
hidden
.
"
)
;
await
closeFindbarAndWait
(
findbar
)
;
}
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
{
const
stopPropagation
=
e
=
>
{
e
.
stopImmediatePropagation
(
)
;
}
;
let
window
=
content
.
document
.
defaultView
;
window
.
addEventListener
(
"
keydown
"
stopPropagation
)
;
window
.
addEventListener
(
"
keypress
"
stopPropagation
)
;
window
.
addEventListener
(
"
keyup
"
stopPropagation
)
;
}
)
;
for
(
let
key
of
HOTKEYS
)
{
is
(
findbar
.
hidden
true
"
Findbar
is
hidden
now
.
"
)
;
gBrowser
.
selectedTab
=
tab
;
await
SimpleTest
.
promiseFocus
(
gBrowser
.
selectedBrowser
)
;
await
BrowserTestUtils
.
sendChar
(
key
browser
)
;
is
(
findbar
.
hidden
false
"
Findbar
should
not
be
hidden
.
"
)
;
await
closeFindbarAndWait
(
findbar
)
;
}
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_not_found
(
)
{
info
(
"
Check
correct
'
Phrase
not
found
'
on
new
tab
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
await
promiseFindFinished
(
gBrowser
"
-
-
-
THIS
SHOULD
NEVER
MATCH
-
-
-
"
false
)
;
let
findbar
=
gBrowser
.
getCachedFindBar
(
)
;
is
(
findbar
.
_findStatusDesc
.
dataset
.
l10nId
"
findbar
-
not
-
found
"
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_found
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
await
promiseFindFinished
(
gBrowser
"
S
"
true
)
;
ok
(
gBrowser
.
getCachedFindBar
(
)
.
_findStatusDesc
.
dataset
.
l10nId
=
=
=
undefined
"
Findbar
status
should
be
empty
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_tabwise_case_sensitive
(
)
{
let
tab1
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
findbar1
=
await
gBrowser
.
getFindBar
(
)
;
let
tab2
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
findbar2
=
await
gBrowser
.
getFindBar
(
)
;
findbar1
.
getElement
(
"
find
-
case
-
sensitive
"
)
.
click
(
)
;
gBrowser
.
selectedTab
=
tab1
;
await
promiseFindFinished
(
gBrowser
"
S
"
true
)
;
is
(
findbar1
.
_findStatusDesc
.
dataset
.
l10nId
"
findbar
-
not
-
found
"
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
gBrowser
.
selectedTab
=
tab2
;
await
promiseFindFinished
(
gBrowser
"
S
"
true
)
;
ok
(
findbar2
.
_findStatusDesc
.
dataset
.
l10nId
=
=
=
undefined
"
Findbar
status
should
be
empty
"
)
;
gBrowser
.
removeTab
(
tab1
)
;
gBrowser
.
removeTab
(
tab2
)
;
}
)
;
add_task
(
async
function
test_reinitialization_at_remoteness_change
(
)
{
if
(
!
gMultiProcessBrowser
)
{
info
(
"
Skipping
this
test
because
of
non
-
e10s
environment
.
"
)
;
return
;
}
info
(
"
Ensure
findbar
re
-
initialization
at
remoteness
change
.
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
let
findbar
=
await
gBrowser
.
getFindBar
(
)
;
await
promiseFindFinished
(
gBrowser
"
z
"
false
)
;
is
(
findbar
.
_findStatusDesc
.
dataset
.
l10nId
"
findbar
-
not
-
found
"
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
await
promiseFindFinished
(
gBrowser
"
s
"
false
)
;
ok
(
findbar
.
_findStatusDesc
.
dataset
.
l10nId
=
=
=
undefined
"
Findbar
status
should
be
empty
"
)
;
ok
(
browser
.
isRemoteBrowser
"
Browser
should
be
remote
now
.
"
)
;
await
promiseRemotenessChange
(
tab
false
)
;
let
docLoaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
E10S_PARENT_TEST_PAGE_URI
)
;
BrowserTestUtils
.
loadURIString
(
browser
E10S_PARENT_TEST_PAGE_URI
)
;
await
docLoaded
;
ok
(
!
browser
.
isRemoteBrowser
"
Browser
should
not
be
remote
any
more
.
"
)
;
browser
.
contentDocument
.
body
.
append
(
"
The
letter
s
.
"
)
;
browser
.
contentDocument
.
body
.
clientHeight
;
await
promiseFindFinished
(
gBrowser
"
z
"
false
)
;
is
(
findbar
.
_findStatusDesc
.
dataset
.
l10nId
"
findbar
-
not
-
found
"
"
Findbar
status
text
should
be
'
Phrase
not
found
'
"
)
;
await
promiseFindFinished
(
gBrowser
"
s
"
false
)
;
ok
(
findbar
.
_findStatusDesc
.
dataset
.
l10nId
=
=
=
undefined
"
Findbar
status
should
be
empty
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
e10sLostKeys
(
)
{
if
(
!
gMultiProcessBrowser
)
{
info
(
"
Skipping
this
test
because
of
non
-
e10s
environment
.
"
)
;
return
;
}
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI
)
;
ok
(
!
gFindBarInitialized
"
findbar
isn
'
t
initialized
yet
"
)
;
await
gFindBarPromise
;
let
findBar
=
gFindBar
;
let
initialValue
=
findBar
.
_findField
.
value
;
await
EventUtils
.
synthesizeAndWaitKey
(
"
F
"
{
accelKey
:
true
}
window
null
(
)
=
>
{
isnot
(
document
.
activeElement
findBar
.
_findField
"
findbar
is
not
yet
focused
"
)
;
EventUtils
.
synthesizeKey
(
"
a
"
)
;
EventUtils
.
synthesizeKey
(
"
b
"
)
;
EventUtils
.
synthesizeKey
(
"
c
"
)
;
is
(
findBar
.
_findField
.
value
initialValue
"
still
has
initial
find
query
"
)
;
}
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
findBar
.
_findField
.
value
.
length
=
=
3
)
;
is
(
document
.
activeElement
findBar
.
_findField
"
findbar
is
now
focused
"
)
;
is
(
findBar
.
_findField
.
value
"
abc
"
"
abc
fully
entered
as
find
query
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_open_and_close_keys
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
body
style
=
'
height
:
5000px
;
'
>
Hello
There
<
/
body
>
"
)
;
await
gFindBarPromise
;
let
findBar
=
gFindBar
;
is
(
findBar
.
hidden
true
"
Findbar
is
hidden
now
.
"
)
;
let
openedPromise
=
BrowserTestUtils
.
waitForEvent
(
findBar
"
findbaropen
"
)
;
await
EventUtils
.
synthesizeKey
(
"
f
"
{
accelKey
:
true
}
)
;
await
openedPromise
;
is
(
findBar
.
hidden
false
"
Findbar
should
not
be
hidden
.
"
)
;
let
closedPromise
=
BrowserTestUtils
.
waitForEvent
(
findBar
"
findbarclose
"
)
;
await
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
closedPromise
;
let
scrollPromise
=
BrowserTestUtils
.
waitForContentEvent
(
tab
.
linkedBrowser
"
scroll
"
)
;
await
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
await
scrollPromise
;
let
scrollPosition
=
await
SpecialPowers
.
spawn
(
tab
.
linkedBrowser
[
]
async
function
(
)
{
return
content
.
document
.
body
.
scrollTop
;
}
)
;
ok
(
scrollPosition
>
0
"
Scrolled
ok
to
"
+
scrollPosition
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_input_keypress
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
general
.
smoothScroll
"
false
]
]
}
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
data
:
text
/
html
<
!
DOCTYPE
html
>
<
body
style
=
'
height
:
5000px
;
'
>
Hello
There
<
/
body
>
)
;
await
gFindBarPromise
;
let
findBar
=
gFindBar
;
is
(
findBar
.
hidden
true
"
Findbar
is
hidden
now
.
"
)
;
let
openedPromise
=
BrowserTestUtils
.
waitForEvent
(
findBar
"
findbaropen
"
)
;
await
EventUtils
.
synthesizeKey
(
"
f
"
{
accelKey
:
true
}
)
;
await
openedPromise
;
is
(
findBar
.
hidden
false
"
Findbar
should
not
be
hidden
.
"
)
;
let
scrollPromise
=
BrowserTestUtils
.
waitForContentEvent
(
tab
.
linkedBrowser
"
scroll
"
)
;
await
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
await
scrollPromise
;
await
ContentTask
.
spawn
(
tab
.
linkedBrowser
null
async
function
(
)
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
defaultView
.
innerHeight
+
content
.
document
.
defaultView
.
pageYOffset
>
0
"
Scroll
with
ArrowDown
"
)
;
}
)
;
let
completeScrollPromise
=
BrowserTestUtils
.
waitForContentEvent
(
tab
.
linkedBrowser
"
scroll
"
)
;
await
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
{
accelKey
:
true
}
)
;
await
completeScrollPromise
;
await
ContentTask
.
spawn
(
tab
.
linkedBrowser
null
async
function
(
)
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
defaultView
.
innerHeight
+
content
.
document
.
defaultView
.
pageYOffset
>
=
content
.
document
.
body
.
offsetHeight
"
Scroll
with
Accel
+
ArrowDown
"
)
;
}
)
;
let
closedPromise
=
BrowserTestUtils
.
waitForEvent
(
findBar
"
findbarclose
"
)
;
await
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
closedPromise
;
info
(
"
Scrolling
ok
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_hotkey_insubframe
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_PAGE_URI_WITHIFRAME
)
;
await
gFindBarPromise
;
let
findBar
=
gFindBar
;
let
browser
=
gBrowser
.
selectedBrowser
;
let
frameBC
=
browser
.
browsingContext
.
children
[
0
]
;
await
SpecialPowers
.
spawn
(
frameBC
[
]
async
(
)
=
>
{
content
.
document
.
body
.
focus
(
)
;
content
.
document
.
defaultView
.
focus
(
)
;
}
)
;
let
findBarOpenPromise
=
BrowserTestUtils
.
waitForEvent
(
gBrowser
"
findbaropen
"
)
;
EventUtils
.
synthesizeKey
(
"
f
"
{
accelKey
:
true
}
)
;
await
findBarOpenPromise
;
let
cursorPos
=
await
SpecialPowers
.
spawn
(
frameBC
[
]
async
(
)
=
>
{
content
.
document
.
body
.
focus
(
)
;
content
.
document
.
defaultView
.
focus
(
)
;
return
content
.
getSelection
(
)
.
anchorOffset
;
}
)
;
is
(
cursorPos
0
"
initial
cursor
position
"
)
;
await
BrowserTestUtils
.
synthesizeKey
(
"
KEY_ArrowRight
"
{
}
frameBC
)
;
cursorPos
=
await
SpecialPowers
.
spawn
(
frameBC
[
]
async
(
)
=
>
{
return
content
.
getSelection
(
)
.
anchorOffset
;
}
)
;
is
(
cursorPos
1
"
cursor
moved
"
)
;
await
closeFindbarAndWait
(
findBar
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_preservestate_on_reload
(
)
{
for
(
let
stateChange
of
[
"
case
-
sensitive
"
"
entire
-
word
"
]
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
!
DOCTYPE
html
>
<
p
>
There
is
a
cat
named
Theo
in
the
kitchen
with
another
cat
named
Catherine
.
The
two
of
them
are
thirsty
.
"
)
;
let
findBarOpenPromise
=
BrowserTestUtils
.
waitForEvent
(
gBrowser
"
findbaropen
"
)
;
EventUtils
.
synthesizeKey
(
"
f
"
{
accelKey
:
true
}
)
;
await
findBarOpenPromise
;
let
isEntireWord
=
stateChange
=
=
"
entire
-
word
"
;
let
findbar
=
await
gBrowser
.
getFindBar
(
)
;
let
promiseMatches
=
promiseGetMatchCount
(
findbar
)
;
await
promiseFindFinished
(
gBrowser
"
The
"
true
)
;
let
matches
=
await
promiseMatches
;
is
(
matches
.
current
1
"
Correct
match
position
"
+
stateChange
)
;
is
(
matches
.
total
7
"
Correct
number
of
matches
"
+
stateChange
)
;
findbar
.
getElement
(
"
find
-
"
+
stateChange
)
.
click
(
)
;
promiseMatches
=
promiseGetMatchCount
(
findbar
)
;
gFindBar
.
onFindAgainCommand
(
)
;
matches
=
await
promiseMatches
;
is
(
matches
.
current
2
"
Correct
match
position
after
state
change
matches
"
+
stateChange
)
;
is
(
matches
.
total
isEntireWord
?
2
:
3
"
Correct
number
after
state
change
matches
"
+
stateChange
)
;
let
loadedPromise
=
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
true
)
;
gBrowser
.
reload
(
)
;
await
loadedPromise
;
promiseMatches
=
promiseGetMatchCount
(
findbar
)
;
gFindBar
.
onFindAgainCommand
(
)
;
matches
=
await
promiseMatches
;
is
(
matches
.
current
1
"
Correct
match
position
after
reload
and
find
again
"
+
stateChange
)
;
is
(
matches
.
total
isEntireWord
?
2
:
3
"
Correct
number
of
matches
after
reload
and
find
again
"
+
stateChange
)
;
findbar
.
getElement
(
"
find
-
"
+
stateChange
)
.
click
(
)
;
promiseMatches
=
promiseGetMatchCount
(
findbar
)
;
gFindBar
.
onFindAgainCommand
(
)
;
matches
=
await
promiseMatches
;
is
(
matches
.
current
isEntireWord
?
4
:
2
"
Correct
match
position
after
reload
and
find
again
reset
"
+
stateChange
)
;
is
(
matches
.
total
7
"
Correct
number
of
matches
after
reload
and
find
again
reset
"
+
stateChange
)
;
findbar
.
clear
(
)
;
await
closeFindbarAndWait
(
findbar
)
;
gBrowser
.
removeTab
(
tab
)
;
}
}
)
;
function
promiseGetMatchCount
(
findbar
)
{
return
new
Promise
(
resolve
=
>
{
let
resultListener
=
{
onFindResult
(
)
{
}
onCurrentSelection
(
)
{
}
onHighlightFinished
(
)
{
}
onMatchesCountResult
(
response
)
{
if
(
response
.
total
>
0
)
{
findbar
.
browser
.
finder
.
removeResultListener
(
resultListener
)
;
resolve
(
response
)
;
}
}
}
;
findbar
.
browser
.
finder
.
addResultListener
(
resultListener
)
;
}
)
;
}
function
promiseRemotenessChange
(
tab
shouldBeRemote
)
{
return
new
Promise
(
resolve
=
>
{
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
tab
.
addEventListener
(
"
TabRemotenessChange
"
function
(
)
{
resolve
(
)
;
}
{
once
:
true
}
)
;
let
remoteType
=
shouldBeRemote
?
E10SUtils
.
DEFAULT_REMOTE_TYPE
:
E10SUtils
.
NOT_REMOTE
;
gBrowser
.
updateBrowserRemoteness
(
browser
{
remoteType
}
)
;
}
)
;
}
