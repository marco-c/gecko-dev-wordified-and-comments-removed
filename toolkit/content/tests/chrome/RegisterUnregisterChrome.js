const
NS_CHROME_MANIFESTS_FILE_LIST
=
"
ChromeML
"
;
const
XUL_CACHE_PREF
=
"
nglayout
.
debug
.
disable_xul_cache
"
;
var
gChromeReg
=
Cc
[
"
mozilla
.
org
/
chrome
/
chrome
-
registry
;
1
"
]
.
getService
(
Ci
.
nsIXULChromeRegistry
)
;
function
copyToTemporaryFile
(
f
)
{
let
tmpd
=
Services
.
dirsvc
.
get
(
"
ProfD
"
Ci
.
nsIFile
)
;
let
tmpf
=
tmpd
.
clone
(
)
;
tmpf
.
append
(
"
temp
.
manifest
"
)
;
tmpf
.
createUnique
(
Ci
.
nsIFile
.
NORMAL_FILE_TYPE
0o600
)
;
tmpf
.
remove
(
false
)
;
f
.
copyTo
(
tmpd
tmpf
.
leafName
)
;
return
tmpf
;
}
function
*
dirIter
(
directory
)
{
var
testsDir
=
Services
.
io
.
newURI
(
directory
)
.
QueryInterface
(
Ci
.
nsIFileURL
)
.
file
;
let
en
=
testsDir
.
directoryEntries
;
while
(
en
.
hasMoreElements
(
)
)
{
yield
en
.
nextFile
;
}
}
function
getParent
(
path
)
{
let
lastSlash
=
path
.
lastIndexOf
(
"
/
"
)
;
if
(
lastSlash
=
=
-
1
)
{
lastSlash
=
path
.
lastIndexOf
(
"
\
\
"
)
;
if
(
lastSlash
=
=
-
1
)
{
return
"
"
;
}
return
"
/
"
+
path
.
substring
(
0
lastSlash
)
.
replace
(
/
\
\
/
g
"
/
"
)
;
}
return
path
.
substring
(
0
lastSlash
)
;
}
function
copyDirToTempProfile
(
path
subdirname
)
{
if
(
subdirname
=
=
=
undefined
)
{
subdirname
=
"
mochikit
-
tmp
"
;
}
let
tmpdir
=
Services
.
dirsvc
.
get
(
"
ProfD
"
Ci
.
nsIFile
)
;
tmpdir
.
append
(
subdirname
)
;
tmpdir
.
createUnique
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
0o777
)
;
let
rootDir
=
getParent
(
path
)
;
if
(
rootDir
=
=
"
"
)
{
return
tmpdir
;
}
var
files
=
Array
.
from
(
dirIter
(
"
file
:
/
/
"
+
rootDir
)
)
;
for
(
let
f
in
files
)
{
files
[
f
]
.
copyTo
(
tmpdir
"
"
)
;
}
return
tmpdir
;
}
function
convertChromeURI
(
chromeURI
)
{
let
uri
=
Services
.
io
.
newURI
(
chromeURI
)
;
return
gChromeReg
.
convertChromeURL
(
uri
)
;
}
function
chromeURIToFile
(
chromeURI
)
{
var
jar
=
getJar
(
chromeURI
)
;
if
(
jar
)
{
var
tmpDir
=
extractJarToTmp
(
jar
)
;
let
parts
=
chromeURI
.
split
(
"
/
"
)
;
if
(
parts
[
parts
.
length
-
1
]
!
=
"
"
)
{
tmpDir
.
append
(
parts
[
parts
.
length
-
1
]
)
;
}
return
tmpDir
;
}
return
convertChromeURI
(
chromeURI
)
.
QueryInterface
(
Ci
.
nsIFileURL
)
.
file
;
}
function
createManifestTemporarily
(
tempDir
manifestText
)
{
Services
.
prefs
.
setBoolPref
(
XUL_CACHE_PREF
true
)
;
tempDir
.
append
(
"
temp
.
manifest
"
)
;
let
foStream
=
Cc
[
"
mozilla
.
org
/
network
/
file
-
output
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIFileOutputStream
)
;
foStream
.
init
(
tempDir
0x02
|
0x08
|
0x20
0o664
0
)
;
foStream
.
write
(
manifestText
manifestText
.
length
)
;
foStream
.
close
(
)
;
let
tempfile
=
copyToTemporaryFile
(
tempDir
)
;
Components
.
manager
.
QueryInterface
(
Ci
.
nsIComponentRegistrar
)
.
autoRegister
(
tempfile
)
;
gChromeReg
.
refreshSkins
(
)
;
return
function
(
)
{
tempfile
.
fileSize
=
0
;
gChromeReg
.
checkForNewChrome
(
)
;
gChromeReg
.
refreshSkins
(
)
;
Services
.
prefs
.
clearUserPref
(
XUL_CACHE_PREF
)
;
}
;
}
function
registerManifestTemporarily
(
manifestURI
)
{
Services
.
prefs
.
setBoolPref
(
XUL_CACHE_PREF
true
)
;
let
file
=
chromeURIToFile
(
manifestURI
)
;
let
tempfile
=
copyToTemporaryFile
(
file
)
;
Components
.
manager
.
QueryInterface
(
Ci
.
nsIComponentRegistrar
)
.
autoRegister
(
tempfile
)
;
gChromeReg
.
refreshSkins
(
)
;
return
function
(
)
{
tempfile
.
fileSize
=
0
;
gChromeReg
.
checkForNewChrome
(
)
;
gChromeReg
.
refreshSkins
(
)
;
Services
.
prefs
.
clearUserPref
(
XUL_CACHE_PREF
)
;
}
;
}
function
registerManifestPermanently
(
manifestURI
)
{
var
chromepath
=
chromeURIToFile
(
manifestURI
)
;
Components
.
manager
.
QueryInterface
(
Ci
.
nsIComponentRegistrar
)
.
autoRegister
(
chromepath
)
;
return
chromepath
;
}
