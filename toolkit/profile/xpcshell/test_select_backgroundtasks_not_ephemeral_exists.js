let
condition
=
{
skip_if
:
(
)
=
>
!
AppConstants
.
MOZ_BACKGROUNDTASKS
}
;
let
vendor
=
"
Mozilla
"
;
add_task
(
condition
async
(
)
=
>
{
let
hash
=
xreDirProvider
.
getInstallHash
(
)
;
let
saltedPath
=
saltSALT
.
{
vendor
}
BackgroundTask
-
{
hash
}
-
not_ephemeral_profile
;
let
profileName
=
{
vendor
}
BackgroundTask
-
{
hash
}
-
not_ephemeral_profile
;
BACKGROUNDTASKS_PROFILE_DATA
.
backgroundTasksProfiles
.
splice
(
0
0
{
name
:
profileName
path
:
saltedPath
}
)
;
writeProfilesIni
(
BACKGROUNDTASKS_PROFILE_DATA
)
;
const
bts
=
Cc
[
"
mozilla
.
org
/
backgroundtasks
;
1
"
]
.
getService
(
Ci
.
nsIBackgroundTasks
)
;
bts
.
overrideBackgroundTaskNameForTesting
(
"
not_ephemeral_profile
"
)
;
let
{
didCreate
rootDir
}
=
selectStartupProfile
(
)
;
checkStartupReason
(
"
backgroundtask
-
not
-
ephemeral
"
)
;
Assert
.
equal
(
didCreate
true
"
Re
-
used
existing
non
-
ephemeral
profile
but
should
create
a
new
directory
for
it
"
)
;
Assert
.
equal
(
rootDir
.
exists
(
)
true
"
rootDir
has
a
directory
in
the
file
system
"
)
;
let
profileData
=
readProfilesIni
(
)
;
Assert
.
equal
(
profileData
.
backgroundTasksProfiles
.
length
2
)
;
let
createdProfile
=
profileData
.
backgroundTasksProfiles
.
find
(
searchProfile
=
>
searchProfile
.
name
=
=
profileName
)
;
Assert
.
ok
(
rootDir
.
path
.
endsWith
(
createdProfile
.
path
)
rootDir
"
{
rootDir
.
path
}
"
ends
with
salted
path
"
{
saltedPath
}
"
)
;
let
backgroundTasksProfilesPath
=
gDataHome
;
if
(
!
AppConstants
.
XP_UNIX
|
|
AppConstants
.
platform
=
=
=
"
macosx
"
)
{
backgroundTasksProfilesPath
.
append
(
"
Background
Tasks
Profiles
"
)
;
}
Assert
.
ok
(
rootDir
.
path
.
startsWith
(
backgroundTasksProfilesPath
.
path
)
rootDir
"
{
rootDir
.
path
}
"
is
sibling
to
user
profiles
directory
{
backgroundTasksProfilesPath
}
)
;
}
)
;
