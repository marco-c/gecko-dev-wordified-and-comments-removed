"
use
strict
"
;
const
{
utils
:
Cu
interfaces
:
Ci
classes
:
Cc
results
:
Cr
}
=
Components
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
NetUtil
"
"
resource
:
/
/
gre
/
modules
/
NetUtil
.
jsm
"
)
;
function
MainProcessSingleton
(
)
{
}
MainProcessSingleton
.
prototype
=
{
classID
:
Components
.
ID
(
"
{
0636a680
-
45cb
-
11e4
-
916c
-
0800200c9a66
}
"
)
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsIObserver
Ci
.
nsISupportsWeakReference
]
)
addSearchEngine
(
{
target
:
browser
data
:
{
pageURL
engineURL
}
}
)
{
pageURL
=
NetUtil
.
newURI
(
pageURL
)
;
engineURL
=
NetUtil
.
newURI
(
engineURL
null
pageURL
)
;
let
iconURL
;
let
tabbrowser
=
browser
.
getTabBrowser
(
)
;
if
(
browser
.
mIconURL
&
&
(
!
tabbrowser
|
|
tabbrowser
.
shouldLoadFavIcon
(
pageURL
)
)
)
iconURL
=
NetUtil
.
newURI
(
browser
.
mIconURL
)
;
try
{
let
isWeb
=
[
"
https
"
"
http
"
"
ftp
"
]
;
if
(
!
isWeb
.
includes
(
engineURL
.
scheme
)
)
throw
"
Unsupported
search
engine
URL
:
"
+
engineURL
;
if
(
iconURL
&
&
!
isWeb
.
includes
(
iconURL
.
scheme
)
)
throw
"
Unsupported
search
icon
URL
:
"
+
iconURL
;
}
catch
(
ex
)
{
Cu
.
reportError
(
"
Invalid
argument
passed
to
window
.
external
.
AddSearchProvider
:
"
+
ex
)
;
var
searchBundle
=
Services
.
strings
.
createBundle
(
"
chrome
:
/
/
global
/
locale
/
search
/
search
.
properties
"
)
;
var
brandBundle
=
Services
.
strings
.
createBundle
(
"
chrome
:
/
/
branding
/
locale
/
brand
.
properties
"
)
;
var
brandName
=
brandBundle
.
GetStringFromName
(
"
brandShortName
"
)
;
var
title
=
searchBundle
.
GetStringFromName
(
"
error_invalid_format_title
"
)
;
var
msg
=
searchBundle
.
formatStringFromName
(
"
error_invalid_engine_msg2
"
[
brandName
engineURL
.
spec
]
2
)
;
Services
.
ww
.
getNewPrompter
(
browser
.
ownerGlobal
)
.
alert
(
title
msg
)
;
return
;
}
Services
.
search
.
init
(
function
(
status
)
{
if
(
status
!
=
Cr
.
NS_OK
)
return
;
Services
.
search
.
addEngine
(
engineURL
.
spec
null
iconURL
?
iconURL
.
spec
:
null
true
)
;
}
)
;
}
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
app
-
startup
"
:
{
Services
.
obs
.
addObserver
(
this
"
xpcom
-
shutdown
"
)
;
Services
.
mm
.
loadFrameScript
(
"
chrome
:
/
/
global
/
content
/
browser
-
content
.
js
"
true
)
;
Services
.
ppmm
.
loadProcessScript
(
"
chrome
:
/
/
global
/
content
/
process
-
content
.
js
"
true
)
;
Services
.
mm
.
addMessageListener
(
"
Search
:
AddEngine
"
this
.
addSearchEngine
)
;
Services
.
ppmm
.
loadProcessScript
(
"
resource
:
/
/
/
modules
/
ContentObservers
.
js
"
true
)
;
break
;
}
case
"
xpcom
-
shutdown
"
:
Services
.
mm
.
removeMessageListener
(
"
Search
:
AddEngine
"
this
.
addSearchEngine
)
;
break
;
}
}
}
;
this
.
NSGetFactory
=
XPCOMUtils
.
generateNSGetFactory
(
[
MainProcessSingleton
]
)
;
