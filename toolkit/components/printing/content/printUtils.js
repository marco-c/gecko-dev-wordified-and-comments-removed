XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
PRINT_TAB_MODAL
"
"
print
.
tab_modal
.
enabled
"
false
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
PRINT_ALWAYS_SILENT
"
"
print
.
always_print_silent
"
false
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
PromptUtils
"
"
resource
:
/
/
gre
/
modules
/
SharedPromptUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
PrintingParent
"
"
resource
:
/
/
gre
/
actors
/
PrintingParent
.
jsm
"
)
;
var
gFocusedElement
=
null
;
var
gPendingPrintPreviews
=
new
Map
(
)
;
var
PrintUtils
=
{
SAVE_TO_PDF_PRINTER
:
"
Mozilla
Save
to
PDF
"
get
_bundle
(
)
{
delete
this
.
_bundle
;
return
(
this
.
_bundle
=
Services
.
strings
.
createBundle
(
"
chrome
:
/
/
global
/
locale
/
printing
.
properties
"
)
)
;
}
showPageSetup
(
)
{
let
printSettings
=
this
.
getPrintSettings
(
)
;
let
PSSVC
=
Cc
[
"
mozilla
.
org
/
gfx
/
printsettings
-
service
;
1
"
]
.
getService
(
Ci
.
nsIPrintSettingsService
)
;
if
(
!
PSSVC
.
lastUsedPrinterName
)
{
if
(
printSettings
.
printerName
)
{
PSSVC
.
savePrintSettingsToPrefs
(
printSettings
false
Ci
.
nsIPrintSettings
.
kInitSavePrinterName
)
;
PSSVC
.
savePrintSettingsToPrefs
(
printSettings
true
Ci
.
nsIPrintSettings
.
kInitSaveAll
)
;
}
}
try
{
var
PRINTPROMPTSVC
=
Cc
[
"
mozilla
.
org
/
embedcomp
/
printingprompt
-
service
;
1
"
]
.
getService
(
Ci
.
nsIPrintingPromptService
)
;
PRINTPROMPTSVC
.
showPageSetupDialog
(
window
printSettings
null
)
;
}
catch
(
e
)
{
dump
(
"
showPageSetup
"
+
e
+
"
\
n
"
)
;
return
false
;
}
return
true
;
}
getPreviewBrowser
(
sourceBrowser
)
{
let
dialogBox
=
gBrowser
.
getTabDialogBox
(
sourceBrowser
)
;
for
(
let
dialog
of
dialogBox
.
_dialogManager
.
_dialogs
)
{
let
browser
=
dialog
.
_box
.
querySelector
(
"
.
printPreviewBrowser
"
)
;
if
(
browser
)
{
return
browser
;
}
}
return
null
;
}
updatePrintPreviewMenuHiddenState
(
)
{
let
printPreviewMenuItem
=
document
.
getElementById
(
"
menu_printPreview
"
)
;
if
(
printPreviewMenuItem
)
{
printPreviewMenuItem
.
hidden
=
PRINT_TAB_MODAL
;
}
let
pageSetupMenuItem
=
document
.
getElementById
(
"
menu_printSetup
"
)
;
if
(
pageSetupMenuItem
)
{
pageSetupMenuItem
.
hidden
=
PRINT_TAB_MODAL
;
}
}
createPreviewBrowser
(
aBrowsingContext
aDialogBrowser
)
{
let
browser
=
gBrowser
.
createBrowser
(
{
remoteType
:
aBrowsingContext
.
currentRemoteType
userContextId
:
aBrowsingContext
.
originAttributes
.
userContextId
initialBrowsingContextGroupId
:
aBrowsingContext
.
group
.
id
skipLoad
:
true
}
)
;
browser
.
addEventListener
(
"
DOMWindowClose
"
function
(
e
)
{
e
.
preventDefault
(
)
;
e
.
stopPropagation
(
)
;
}
)
;
browser
.
addEventListener
(
"
contextmenu
"
function
(
e
)
{
e
.
preventDefault
(
)
;
}
)
;
browser
.
classList
.
add
(
"
printPreviewBrowser
"
)
;
browser
.
setAttribute
(
"
flex
"
"
1
"
)
;
browser
.
setAttribute
(
"
printpreview
"
"
true
"
)
;
document
.
l10n
.
setAttributes
(
browser
"
printui
-
preview
-
label
"
)
;
let
previewStack
=
document
.
importNode
(
document
.
getElementById
(
"
printPreviewStackTemplate
"
)
.
content
true
)
.
firstElementChild
;
previewStack
.
append
(
browser
)
;
let
previewPagination
=
document
.
createElement
(
"
printpreview
-
pagination
"
)
;
previewPagination
.
classList
.
add
(
"
printPreviewNavigation
"
)
;
previewStack
.
append
(
previewPagination
)
;
aDialogBrowser
.
parentElement
.
prepend
(
previewStack
)
;
return
browser
;
}
async
_openTabModalPrint
(
aBrowsingContext
aExistingPreviewBrowser
aPrintInitiationTime
aPrintSelectionOnly
)
{
let
sourceBrowser
=
aBrowsingContext
.
top
.
embedderElement
;
let
previewBrowser
=
this
.
getPreviewBrowser
(
sourceBrowser
)
;
if
(
previewBrowser
)
{
if
(
aExistingPreviewBrowser
)
{
aExistingPreviewBrowser
.
remove
(
)
;
}
return
Promise
.
reject
(
)
;
}
let
args
=
PromptUtils
.
objectToPropBag
(
{
previewBrowser
:
aExistingPreviewBrowser
printSelectionOnly
:
!
!
aPrintSelectionOnly
}
)
;
let
dialogBox
=
gBrowser
.
getTabDialogBox
(
sourceBrowser
)
;
return
dialogBox
.
open
(
chrome
:
/
/
global
/
content
/
print
.
html
?
browsingContextId
=
{
aBrowsingContext
.
id
}
&
printInitiationTime
=
{
aPrintInitiationTime
}
{
features
:
"
resizable
=
no
"
sizeTo
:
"
available
"
}
args
)
;
}
startPrintWindow
(
aTrigger
aBrowsingContext
aOpenWindowInfo
aPrintSelectionOnly
)
{
const
printInitiationTime
=
Date
.
now
(
)
;
if
(
!
aOpenWindowInfo
|
|
aOpenWindowInfo
.
isForWindowDotPrint
)
{
Services
.
telemetry
.
keyedScalarAdd
(
"
printing
.
trigger
"
aTrigger
1
)
;
}
let
browser
=
null
;
if
(
aOpenWindowInfo
)
{
browser
=
document
.
createXULElement
(
"
browser
"
)
;
browser
.
openWindowInfo
=
aOpenWindowInfo
;
browser
.
setAttribute
(
"
type
"
"
content
"
)
;
let
remoteType
=
aBrowsingContext
.
currentRemoteType
;
if
(
remoteType
)
{
browser
.
setAttribute
(
"
remoteType
"
remoteType
)
;
browser
.
setAttribute
(
"
remote
"
"
true
"
)
;
}
browser
.
addEventListener
(
"
DOMWindowClose
"
function
(
e
)
{
if
(
browser
.
isConnected
)
{
browser
.
remove
(
)
;
}
e
.
stopPropagation
(
)
;
e
.
preventDefault
(
)
;
}
)
;
browser
.
style
.
visibility
=
"
collapse
"
;
document
.
documentElement
.
appendChild
(
browser
)
;
}
if
(
PRINT_TAB_MODAL
&
&
!
PRINT_ALWAYS_SILENT
&
&
(
!
aOpenWindowInfo
|
|
aOpenWindowInfo
.
isForWindowDotPrint
)
)
{
this
.
_openTabModalPrint
(
aBrowsingContext
browser
printInitiationTime
aPrintSelectionOnly
)
.
catch
(
(
)
=
>
{
}
)
;
return
browser
;
}
if
(
browser
)
{
return
browser
;
}
let
settings
=
this
.
getPrintSettings
(
)
;
settings
.
printSelectionOnly
=
aPrintSelectionOnly
;
this
.
printWindow
(
aBrowsingContext
settings
)
;
return
null
;
}
printWindow
(
aBrowsingContext
aPrintSettings
)
{
let
windowID
=
aBrowsingContext
.
currentWindowGlobal
.
outerWindowId
;
let
topBrowser
=
aBrowsingContext
.
top
.
embedderElement
;
const
printPreviewIsOpen
=
!
!
document
.
getElementById
(
"
print
-
preview
-
toolbar
"
)
;
if
(
printPreviewIsOpen
)
{
this
.
_logKeyedTelemetry
(
"
PRINT_DIALOG_OPENED_COUNT
"
"
FROM_PREVIEW
"
)
;
}
else
{
this
.
_logKeyedTelemetry
(
"
PRINT_DIALOG_OPENED_COUNT
"
"
FROM_PAGE
"
)
;
}
let
printSettings
=
aPrintSettings
|
|
this
.
getPrintSettings
(
)
;
printSettings
.
title
=
this
.
_originalTitle
|
|
topBrowser
.
contentTitle
;
if
(
this
.
_shouldSimplify
)
{
printSettings
.
docURL
=
this
.
_originalURL
|
|
topBrowser
.
currentURI
.
spec
;
}
let
promise
=
topBrowser
.
print
(
windowID
printSettings
)
;
if
(
printPreviewIsOpen
)
{
if
(
this
.
_shouldSimplify
)
{
this
.
_logKeyedTelemetry
(
"
PRINT_COUNT
"
"
SIMPLIFIED
"
)
;
}
else
{
this
.
_logKeyedTelemetry
(
"
PRINT_COUNT
"
"
WITH_PREVIEW
"
)
;
}
}
else
{
this
.
_logKeyedTelemetry
(
"
PRINT_COUNT
"
"
WITHOUT_PREVIEW
"
)
;
}
return
promise
;
}
printPreview
(
aTrigger
aListenerObj
)
{
if
(
aTrigger
)
{
Services
.
telemetry
.
keyedScalarAdd
(
"
printing
.
trigger
"
aTrigger
1
)
;
}
if
(
PRINT_TAB_MODAL
)
{
return
this
.
_openTabModalPrint
(
gBrowser
.
selectedBrowser
.
browsingContext
undefined
Date
.
now
(
)
)
;
}
let
printPreviewTB
=
document
.
getElementById
(
"
print
-
preview
-
toolbar
"
)
;
if
(
!
printPreviewTB
)
{
this
.
_listener
=
aListenerObj
;
this
.
_sourceBrowser
=
aListenerObj
.
getSourceBrowser
(
)
;
this
.
_originalTitle
=
this
.
_sourceBrowser
.
contentTitle
;
this
.
_originalURL
=
this
.
_sourceBrowser
.
currentURI
.
spec
;
this
.
logTelemetry
(
"
PRINT_PREVIEW_OPENED_COUNT
"
)
;
}
else
{
printPreviewTB
.
disableUpdateTriggers
(
true
)
;
this
.
_sourceBrowser
=
this
.
_shouldSimplify
?
this
.
_listener
.
getSimplifiedPrintPreviewBrowser
(
)
:
this
.
_listener
.
getPrintPreviewBrowser
(
)
;
this
.
_sourceBrowser
.
collapsed
=
true
;
this
.
ensureProgressDialogClosed
(
)
;
}
this
.
_webProgressPP
=
{
}
;
let
ppParams
=
{
}
;
let
notifyOnOpen
=
{
}
;
let
printSettings
=
this
.
getPrintSettings
(
)
;
let
PPROMPTSVC
=
Cc
[
"
mozilla
.
org
/
embedcomp
/
printingprompt
-
service
;
1
"
]
.
getService
(
Ci
.
nsIPrintingPromptService
)
;
let
promise
=
new
Promise
(
(
resolve
reject
)
=
>
{
this
.
_onEntered
.
push
(
{
resolve
reject
}
)
;
}
)
;
try
{
PPROMPTSVC
.
showPrintProgressDialog
(
window
printSettings
this
.
_obsPP
false
this
.
_webProgressPP
ppParams
notifyOnOpen
)
;
if
(
ppParams
.
value
)
{
ppParams
.
value
.
docTitle
=
this
.
_originalTitle
;
ppParams
.
value
.
docURL
=
this
.
_originalURL
;
}
if
(
!
notifyOnOpen
.
value
.
valueOf
(
)
|
|
this
.
_webProgressPP
.
value
=
=
null
)
{
this
.
_enterPrintPreview
(
)
;
}
}
catch
(
e
)
{
this
.
_enterPrintPreview
(
)
;
}
return
promise
;
}
_listener
:
null
_closeHandlerPP
:
null
_webProgressPP
:
null
_sourceBrowser
:
null
_originalTitle
:
"
"
_originalURL
:
"
"
_shouldSimplify
:
false
_getErrorCodeForNSResult
(
nsresult
)
{
const
MSG_CODES
=
[
"
GFX_PRINTER_NO_PRINTER_AVAILABLE
"
"
GFX_PRINTER_NAME_NOT_FOUND
"
"
GFX_PRINTER_COULD_NOT_OPEN_FILE
"
"
GFX_PRINTER_STARTDOC
"
"
GFX_PRINTER_ENDDOC
"
"
GFX_PRINTER_STARTPAGE
"
"
GFX_PRINTER_DOC_IS_BUSY
"
"
ABORT
"
"
NOT_AVAILABLE
"
"
NOT_IMPLEMENTED
"
"
OUT_OF_MEMORY
"
"
UNEXPECTED
"
]
;
for
(
let
code
of
MSG_CODES
)
{
let
nsErrorResult
=
"
NS_ERROR_
"
+
code
;
if
(
Cr
[
nsErrorResult
]
=
=
nsresult
)
{
return
code
;
}
}
return
"
FAILURE
"
;
}
_displayPrintingError
(
nsresult
isPrinting
)
{
let
msgName
=
"
PERR_
"
+
this
.
_getErrorCodeForNSResult
(
nsresult
)
;
let
msg
title
;
if
(
!
isPrinting
)
{
let
ppMsgName
=
msgName
+
"
_PP
"
;
try
{
msg
=
this
.
_bundle
.
GetStringFromName
(
ppMsgName
)
;
}
catch
(
e
)
{
}
}
if
(
!
msg
)
{
msg
=
this
.
_bundle
.
GetStringFromName
(
msgName
)
;
}
title
=
this
.
_bundle
.
GetStringFromName
(
isPrinting
?
"
print_error_dialog_title
"
:
"
printpreview_error_dialog_title
"
)
;
Services
.
prompt
.
alert
(
window
title
msg
)
;
Services
.
telemetry
.
keyedScalarAdd
(
"
printing
.
error
"
this
.
_getErrorCodeForNSResult
(
nsresult
)
1
)
;
}
_setPrinterDefaultsForSelectedPrinter
(
aPSSVC
aPrintSettings
defaultsOnly
=
false
)
{
if
(
!
aPrintSettings
.
printerName
)
{
aPrintSettings
.
printerName
=
aPSSVC
.
lastUsedPrinterName
;
if
(
!
aPrintSettings
.
printerName
)
{
let
printerList
=
Cc
[
"
mozilla
.
org
/
gfx
/
printerlist
;
1
"
]
.
getService
(
Ci
.
nsIPrinterList
)
;
aPrintSettings
.
printerName
=
printerList
.
systemDefaultPrinterName
;
}
}
if
(
aPrintSettings
.
printerName
!
=
this
.
SAVE_TO_PDF_PRINTER
)
{
aPSSVC
.
initPrintSettingsFromPrinter
(
aPrintSettings
.
printerName
aPrintSettings
)
;
}
if
(
!
defaultsOnly
)
{
aPSSVC
.
initPrintSettingsFromPrefs
(
aPrintSettings
true
aPrintSettings
.
kInitSaveAll
)
;
}
}
getPrintSettings
(
aPrinterName
defaultsOnly
)
{
var
printSettings
;
try
{
var
PSSVC
=
Cc
[
"
mozilla
.
org
/
gfx
/
printsettings
-
service
;
1
"
]
.
getService
(
Ci
.
nsIPrintSettingsService
)
;
printSettings
=
PSSVC
.
newPrintSettings
;
if
(
aPrinterName
)
{
printSettings
.
printerName
=
aPrinterName
;
}
this
.
_setPrinterDefaultsForSelectedPrinter
(
PSSVC
printSettings
defaultsOnly
)
;
}
catch
(
e
)
{
dump
(
"
getPrintSettings
:
"
+
e
+
"
\
n
"
)
;
}
return
printSettings
;
}
_obsPP
:
{
observe
(
aSubject
aTopic
aData
)
{
if
(
aTopic
)
{
return
;
}
setTimeout
(
function
(
)
{
PrintUtils
.
_enterPrintPreview
(
)
;
}
0
)
;
}
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIObserver
"
"
nsISupportsWeakReference
"
]
)
}
get
shouldSimplify
(
)
{
return
this
.
_shouldSimplify
;
}
setSimplifiedMode
(
shouldSimplify
)
{
this
.
_shouldSimplify
=
shouldSimplify
;
}
_onEntered
:
[
]
_ppBrowsers
:
new
Set
(
)
_currentPPBrowser
:
null
_enterPrintPreview
(
)
{
let
ppBrowser
=
this
.
_shouldSimplify
?
this
.
_listener
.
getSimplifiedPrintPreviewBrowser
(
)
:
this
.
_listener
.
getPrintPreviewBrowser
(
)
;
this
.
_ppBrowsers
.
add
(
ppBrowser
)
;
let
oldPPBrowser
=
null
;
let
changingPrintPreviewBrowsers
=
false
;
if
(
this
.
_currentPPBrowser
&
&
ppBrowser
!
=
this
.
_currentPPBrowser
)
{
changingPrintPreviewBrowsers
=
true
;
oldPPBrowser
=
this
.
_currentPPBrowser
;
}
this
.
_currentPPBrowser
=
ppBrowser
;
let
waitForPrintProgressToEnableToolbar
=
false
;
if
(
this
.
_webProgressPP
.
value
)
{
waitForPrintProgressToEnableToolbar
=
true
;
}
gPendingPrintPreviews
.
set
(
ppBrowser
waitForPrintProgressToEnableToolbar
)
;
if
(
this
.
_shouldSimplify
)
{
let
simplifiedBrowser
=
this
.
_listener
.
getSimplifiedSourceBrowser
(
)
;
if
(
!
simplifiedBrowser
)
{
simplifiedBrowser
=
this
.
_listener
.
createSimplifiedBrowser
(
)
;
simplifiedBrowser
.
sendMessageToActor
(
"
Printing
:
Preview
:
ParseDocument
"
{
URL
:
this
.
_originalURL
windowID
:
oldPPBrowser
.
outerWindowID
}
"
Printing
"
)
;
this
.
logTelemetry
(
"
PRINT_PREVIEW_SIMPLIFY_PAGE_OPENED_COUNT
"
)
;
return
;
}
}
this
.
sendEnterPrintPreviewToChild
(
ppBrowser
this
.
_sourceBrowser
this
.
_shouldSimplify
changingPrintPreviewBrowsers
)
;
}
sendEnterPrintPreviewToChild
(
ppBrowser
sourceBrowser
simplifiedMode
changingBrowsers
)
{
ppBrowser
.
sendMessageToActor
(
"
Printing
:
Preview
:
Enter
"
{
browsingContextId
:
sourceBrowser
.
browsingContext
.
id
simplifiedMode
changingBrowsers
lastUsedPrinterName
:
this
.
getLastUsedPrinterName
(
)
}
"
Printing
"
)
;
}
printPreviewEntered
(
ppBrowser
previewResult
)
{
let
waitForPrintProgressToEnableToolbar
=
gPendingPrintPreviews
.
get
(
ppBrowser
)
;
gPendingPrintPreviews
.
delete
(
ppBrowser
)
;
for
(
let
{
resolve
reject
}
of
this
.
_onEntered
)
{
if
(
previewResult
.
failed
)
{
reject
(
)
;
}
else
{
resolve
(
)
;
}
}
this
.
_onEntered
=
[
]
;
if
(
previewResult
.
failed
)
{
this
.
_ppBrowsers
.
clear
(
)
;
this
.
_listener
.
onEnter
(
)
;
this
.
_listener
.
onExit
(
)
;
return
;
}
gFocusedElement
=
document
.
commandDispatcher
.
focusedElement
;
let
printPreviewTB
=
document
.
getElementById
(
"
print
-
preview
-
toolbar
"
)
;
if
(
printPreviewTB
)
{
if
(
previewResult
.
changingBrowsers
)
{
printPreviewTB
.
destroy
(
)
;
printPreviewTB
.
initialize
(
ppBrowser
)
;
}
else
{
printPreviewTB
.
updateToolbar
(
)
;
}
if
(
!
waitForPrintProgressToEnableToolbar
)
{
printPreviewTB
.
disableUpdateTriggers
(
false
)
;
}
ppBrowser
.
collapsed
=
false
;
ppBrowser
.
focus
(
)
;
return
;
}
if
(
this
.
_listener
.
activateBrowser
)
{
this
.
_listener
.
activateBrowser
(
this
.
_sourceBrowser
)
;
}
else
{
this
.
_sourceBrowser
.
docShellIsActive
=
true
;
}
printPreviewTB
=
document
.
createXULElement
(
"
toolbar
"
{
is
:
"
printpreview
-
toolbar
"
}
)
;
printPreviewTB
.
setAttribute
(
"
fullscreentoolbar
"
true
)
;
printPreviewTB
.
setAttribute
(
"
flex
"
"
1
"
)
;
printPreviewTB
.
id
=
"
print
-
preview
-
toolbar
"
;
let
navToolbox
=
this
.
_listener
.
getNavToolbox
(
)
;
navToolbox
.
parentNode
.
insertBefore
(
printPreviewTB
navToolbox
)
;
printPreviewTB
.
initialize
(
ppBrowser
)
;
if
(
waitForPrintProgressToEnableToolbar
)
{
printPreviewTB
.
disableUpdateTriggers
(
true
)
;
}
if
(
this
.
_sourceBrowser
.
isArticle
)
{
printPreviewTB
.
enableSimplifyPage
(
)
;
}
else
{
this
.
logTelemetry
(
"
PRINT_PREVIEW_SIMPLIFY_PAGE_UNAVAILABLE_COUNT
"
)
;
printPreviewTB
.
disableSimplifyPage
(
)
;
}
if
(
window
.
onclose
)
{
this
.
_closeHandlerPP
=
window
.
onclose
;
}
else
{
this
.
_closeHandlerPP
=
null
;
}
window
.
onclose
=
function
(
)
{
PrintUtils
.
exitPrintPreview
(
)
;
return
false
;
}
;
window
.
addEventListener
(
"
keydown
"
this
.
onKeyDownPP
true
)
;
window
.
addEventListener
(
"
keypress
"
this
.
onKeyPressPP
true
)
;
ppBrowser
.
collapsed
=
false
;
ppBrowser
.
focus
(
)
;
this
.
_listener
.
onEnter
(
)
;
}
readerModeReady
(
sourceBrowser
)
{
let
ppBrowser
=
this
.
_listener
.
getSimplifiedPrintPreviewBrowser
(
)
;
this
.
sendEnterPrintPreviewToChild
(
ppBrowser
sourceBrowser
true
true
)
;
}
getLastUsedPrinterName
(
)
{
let
PSSVC
=
Cc
[
"
mozilla
.
org
/
gfx
/
printsettings
-
service
;
1
"
]
.
getService
(
Ci
.
nsIPrintSettingsService
)
;
let
lastUsedPrinterName
=
PSSVC
.
lastUsedPrinterName
;
if
(
!
lastUsedPrinterName
)
{
let
settings
=
this
.
getPrintSettings
(
)
;
if
(
settings
.
printerName
)
{
PSSVC
.
savePrintSettingsToPrefs
(
settings
false
Ci
.
nsIPrintSettings
.
kInitSavePrinterName
)
;
PSSVC
.
savePrintSettingsToPrefs
(
settings
true
Ci
.
nsIPrintSettings
.
kInitSaveAll
)
;
lastUsedPrinterName
=
settings
.
printerName
;
}
}
return
lastUsedPrinterName
;
}
exitPrintPreview
(
)
{
for
(
let
browser
of
this
.
_ppBrowsers
)
{
browser
.
sendMessageToActor
(
"
Printing
:
Preview
:
Exit
"
{
}
"
Printing
"
)
;
}
this
.
_ppBrowsers
.
clear
(
)
;
this
.
_currentPPBrowser
=
null
;
window
.
removeEventListener
(
"
keydown
"
this
.
onKeyDownPP
true
)
;
window
.
removeEventListener
(
"
keypress
"
this
.
onKeyPressPP
true
)
;
if
(
this
.
_closeHandlerPP
)
{
window
.
onclose
=
this
.
_closeHandlerPP
;
}
else
{
window
.
onclose
=
null
;
}
this
.
_closeHandlerPP
=
null
;
let
printPreviewTB
=
document
.
getElementById
(
"
print
-
preview
-
toolbar
"
)
;
printPreviewTB
.
destroy
(
)
;
printPreviewTB
.
remove
(
)
;
if
(
gFocusedElement
)
{
Services
.
focus
.
setFocus
(
gFocusedElement
Services
.
focus
.
FLAG_NOSCROLL
)
;
}
else
{
this
.
_sourceBrowser
.
focus
(
)
;
}
gFocusedElement
=
null
;
this
.
setSimplifiedMode
(
false
)
;
this
.
ensureProgressDialogClosed
(
)
;
this
.
_listener
.
onExit
(
)
;
this
.
_originalTitle
=
"
"
;
this
.
_originalURL
=
"
"
;
}
logTelemetry
(
ID
)
{
let
histogram
=
Services
.
telemetry
.
getHistogramById
(
ID
)
;
histogram
.
add
(
true
)
;
}
_logKeyedTelemetry
(
id
key
)
{
let
histogram
=
Services
.
telemetry
.
getKeyedHistogramById
(
id
)
;
histogram
.
add
(
key
)
;
}
onKeyDownPP
(
aEvent
)
{
if
(
aEvent
.
keyCode
=
=
aEvent
.
DOM_VK_ESCAPE
)
{
PrintUtils
.
exitPrintPreview
(
)
;
}
}
onKeyPressPP
(
aEvent
)
{
var
closeKey
;
try
{
closeKey
=
document
.
getElementById
(
"
key_close
"
)
.
getAttribute
(
"
key
"
)
;
closeKey
=
aEvent
[
"
DOM_VK_
"
+
closeKey
]
;
}
catch
(
e
)
{
}
var
isModif
=
aEvent
.
ctrlKey
|
|
aEvent
.
metaKey
;
if
(
isModif
&
&
(
aEvent
.
charCode
=
=
closeKey
|
|
aEvent
.
charCode
=
=
closeKey
+
32
)
)
{
PrintUtils
.
exitPrintPreview
(
)
;
}
else
if
(
isModif
)
{
var
printPreviewTB
=
document
.
getElementById
(
"
print
-
preview
-
toolbar
"
)
;
var
printKey
=
document
.
getElementById
(
"
printKb
"
)
.
getAttribute
(
"
key
"
)
.
toUpperCase
(
)
;
var
pressedKey
=
String
.
fromCharCode
(
aEvent
.
charCode
)
.
toUpperCase
(
)
;
if
(
printKey
=
=
pressedKey
)
{
printPreviewTB
.
print
(
)
;
}
}
if
(
isModif
)
{
aEvent
.
preventDefault
(
)
;
aEvent
.
stopPropagation
(
)
;
}
}
ensureProgressDialogClosed
(
)
{
if
(
this
.
_webProgressPP
&
&
this
.
_webProgressPP
.
value
)
{
this
.
_webProgressPP
.
value
.
onStateChange
(
null
null
Ci
.
nsIWebProgressListener
.
STATE_STOP
0
)
;
}
}
}
;
