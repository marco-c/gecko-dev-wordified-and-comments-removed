"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
LoginStore
"
]
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
JSONFile
"
"
resource
:
/
/
gre
/
modules
/
JSONFile
.
jsm
"
)
;
const
kDataVersion
=
2
;
const
PERMISSION_SAVE_LOGINS
=
"
login
-
saving
"
;
function
LoginStore
(
aPath
)
{
JSONFile
.
call
(
this
{
path
:
aPath
dataPostProcessor
:
this
.
_dataPostProcessor
.
bind
(
this
)
}
)
;
}
LoginStore
.
prototype
=
Object
.
create
(
JSONFile
.
prototype
)
;
LoginStore
.
prototype
.
constructor
=
LoginStore
;
LoginStore
.
prototype
.
_dataPostProcessor
=
function
(
data
)
{
if
(
data
.
nextId
=
=
=
undefined
)
{
data
.
nextId
=
1
;
}
if
(
!
data
.
logins
)
{
data
.
logins
=
[
]
;
}
if
(
!
data
.
disabledHosts
)
{
data
.
disabledHosts
=
[
]
;
}
if
(
data
.
version
=
=
=
1
)
{
this
.
_migrateDisabledHosts
(
data
)
;
}
data
.
version
=
kDataVersion
;
return
data
;
}
;
LoginStore
.
prototype
.
_migrateDisabledHosts
=
function
(
data
)
{
for
(
let
host
of
data
.
disabledHosts
)
{
try
{
let
uri
=
Services
.
io
.
newURI
(
host
)
;
Services
.
perms
.
add
(
uri
PERMISSION_SAVE_LOGINS
Services
.
perms
.
DENY_ACTION
)
;
}
catch
(
e
)
{
Cu
.
reportError
(
e
)
;
}
}
delete
data
.
disabledHosts
;
}
;
