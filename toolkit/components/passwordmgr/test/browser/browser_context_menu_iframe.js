"
use
strict
"
;
const
TEST_ORIGIN
=
"
https
:
/
/
example
.
com
"
;
const
IFRAME_PAGE_PATH
=
"
/
browser
/
toolkit
/
components
/
passwordmgr
/
test
/
browser
/
form_basic_iframe
.
html
"
;
add_task
(
async
function
test_initialize
(
)
{
Services
.
prefs
.
setBoolPref
(
"
signon
.
autofillForms
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
signon
.
schemeUpgrades
"
true
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
signon
.
autofillForms
"
)
;
Services
.
prefs
.
clearUserPref
(
"
signon
.
schemeUpgrades
"
)
;
}
)
;
for
(
let
login
of
loginList
(
)
)
{
Services
.
logins
.
addLogin
(
login
)
;
}
}
)
;
add_task
(
async
function
test_context_menu_iframe_fill
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
TEST_ORIGIN
+
IFRAME_PAGE_PATH
}
async
function
(
browser
)
{
await
openPasswordContextMenu
(
browser
"
#
form
-
basic
-
password
"
(
)
=
>
true
browser
.
browsingContext
.
children
[
0
]
true
)
;
let
popupMenu
=
document
.
getElementById
(
"
fill
-
login
-
popup
"
)
;
function
promiseFrameInputValue
(
name
)
{
return
SpecialPowers
.
spawn
(
browser
.
browsingContext
.
children
[
0
]
[
name
]
function
(
inputname
)
{
return
content
.
document
.
getElementById
(
inputname
)
.
value
;
}
)
;
}
let
usernameOriginalValue
=
await
promiseFrameInputValue
(
"
form
-
basic
-
username
"
)
;
let
firstLoginItem
=
popupMenu
.
getElementsByClassName
(
"
context
-
login
-
item
"
)
[
0
]
;
Assert
.
ok
(
firstLoginItem
"
Found
the
first
login
item
"
)
;
await
TestUtils
.
waitForTick
(
)
;
Assert
.
ok
(
BrowserTestUtils
.
is_visible
(
firstLoginItem
)
"
First
login
menuitem
is
visible
"
)
;
info
(
"
Clicking
on
the
firstLoginItem
"
)
;
popupMenu
.
activateItem
(
firstLoginItem
)
;
let
passwordValue
=
await
TestUtils
.
waitForCondition
(
async
(
)
=
>
{
let
value
=
await
promiseFrameInputValue
(
"
form
-
basic
-
password
"
)
;
return
value
;
}
)
;
let
login
=
getLoginFromUsername
(
firstLoginItem
.
label
)
;
Assert
.
equal
(
login
.
password
passwordValue
"
Password
filled
and
correct
.
"
)
;
let
usernameNewValue
=
await
promiseFrameInputValue
(
"
form
-
basic
-
username
"
)
;
Assert
.
equal
(
usernameOriginalValue
usernameNewValue
"
Username
value
was
not
changed
.
"
)
;
let
contextMenu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
contextMenu
.
hidePopup
(
)
;
await
cleanupDoorhanger
(
)
;
await
cleanupPasswordNotifications
(
)
;
}
)
;
}
)
;
add_task
(
async
function
test_context_menu_iframe_sandbox
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
TEST_ORIGIN
+
IFRAME_PAGE_PATH
}
async
function
(
browser
)
{
info
(
"
Opening
context
menu
for
test_context_menu_iframe_sandbox
"
)
;
await
openPasswordContextMenu
(
browser
"
#
form
-
basic
-
password
"
function
checkDisabled
(
)
{
info
(
"
checkDisabled
for
test_context_menu_iframe_sandbox
"
)
;
let
popupHeader
=
document
.
getElementById
(
"
fill
-
login
"
)
;
Assert
.
ok
(
popupHeader
.
hidden
"
Check
that
the
Fill
Login
menu
item
is
hidden
"
)
;
return
false
;
}
browser
.
browsingContext
.
children
[
1
]
)
;
let
contextMenu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
contextMenu
.
hidePopup
(
)
;
}
)
;
}
)
;
add_task
(
async
function
test_context_menu_iframe_sandbox_same_origin
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
TEST_ORIGIN
+
IFRAME_PAGE_PATH
}
async
function
(
browser
)
{
await
openPasswordContextMenu
(
browser
"
#
form
-
basic
-
password
"
function
checkDisabled
(
)
{
let
popupHeader
=
document
.
getElementById
(
"
fill
-
login
"
)
;
Assert
.
ok
(
!
popupHeader
.
hidden
"
Check
that
the
Fill
Login
menu
item
is
visible
"
)
;
Assert
.
ok
(
!
popupHeader
.
disabled
"
Check
that
the
Fill
Login
menu
item
is
disabled
"
)
;
return
false
;
}
browser
.
browsingContext
.
children
[
2
]
)
;
let
contextMenu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
contextMenu
.
hidePopup
(
)
;
}
)
;
}
)
;
function
getLoginFromUsername
(
username
)
{
return
loginList
(
)
.
find
(
login
=
>
login
.
username
=
=
username
)
;
}
function
loginList
(
)
{
return
[
LoginTestUtils
.
testData
.
formLogin
(
{
origin
:
"
https
:
/
/
example
.
com
"
formActionOrigin
:
"
https
:
/
/
example
.
com
"
username
:
"
username
"
password
:
"
password
"
}
)
LoginTestUtils
.
testData
.
formLogin
(
{
origin
:
"
http
:
/
/
example
.
com
"
formActionOrigin
:
"
http
:
/
/
example
.
com
"
username
:
"
username
"
password
:
"
password
"
}
)
LoginTestUtils
.
testData
.
formLogin
(
{
origin
:
"
http
:
/
/
example
.
com
"
formActionOrigin
:
"
http
:
/
/
example
.
com
"
username
:
"
username1
"
password
:
"
password1
"
}
)
LoginTestUtils
.
testData
.
formLogin
(
{
origin
:
"
https
:
/
/
example
.
com
"
formActionOrigin
:
"
https
:
/
/
example
.
com
"
username
:
"
username2
"
password
:
"
password2
"
}
)
LoginTestUtils
.
testData
.
formLogin
(
{
origin
:
"
http
:
/
/
example
.
org
"
formActionOrigin
:
"
http
:
/
/
example
.
org
"
username
:
"
username
-
cross
-
origin
"
password
:
"
password
-
cross
-
origin
"
}
)
]
;
}
