(
"
use
strict
"
)
;
const
{
LoginManagerRustStorage
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
storage
-
rust
.
sys
.
mjs
"
)
;
const
{
sinon
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
Sinon
.
sys
.
mjs
"
)
;
add_task
(
async
function
test_mirror_addLogin
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
const
loginInfo
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
username
"
password
:
"
password
"
}
)
;
await
Services
.
logins
.
addLoginAsync
(
loginInfo
)
;
const
rustStorage
=
new
LoginManagerRustStorage
(
)
;
const
storedLoginInfos
=
await
Services
.
logins
.
getAllLogins
(
)
;
const
rustStoredLoginInfos
=
await
rustStorage
.
getAllLogins
(
)
;
LoginTestUtils
.
assertLoginListsEqual
(
storedLoginInfos
rustStoredLoginInfos
)
;
LoginTestUtils
.
clearData
(
)
;
rustStorage
.
removeAllLogins
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_mirror_modifyLogin
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
const
loginInfo
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
username
"
password
:
"
password
"
}
)
;
await
Services
.
logins
.
addLoginAsync
(
loginInfo
)
;
const
rustStorage
=
new
LoginManagerRustStorage
(
)
;
const
[
storedLoginInfo
]
=
await
Services
.
logins
.
getAllLogins
(
)
;
const
modifiedLoginInfo
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
username
"
password
:
"
password
"
usernameField
:
"
new_form_field_username
"
passwordField
:
"
new_form_field_password
"
}
)
;
Services
.
logins
.
modifyLogin
(
storedLoginInfo
modifiedLoginInfo
)
;
const
[
storedModifiedLoginInfo
]
=
await
Services
.
logins
.
getAllLogins
(
)
;
const
[
rustStoredModifiedLoginInfo
]
=
await
rustStorage
.
searchLoginsAsync
(
{
guid
:
storedLoginInfo
.
guid
}
)
;
LoginTestUtils
.
assertLoginListsEqual
(
[
storedModifiedLoginInfo
]
[
rustStoredModifiedLoginInfo
]
)
;
LoginTestUtils
.
clearData
(
)
;
rustStorage
.
removeAllLogins
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_mirror_removeLogin
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
const
loginInfo
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
username
"
password
:
"
password
"
}
)
;
await
Services
.
logins
.
addLoginAsync
(
loginInfo
)
;
const
rustStorage
=
new
LoginManagerRustStorage
(
)
;
const
[
storedLoginInfo
]
=
await
Services
.
logins
.
getAllLogins
(
)
;
Services
.
logins
.
removeLogin
(
storedLoginInfo
)
;
const
allLogins
=
await
rustStorage
.
getAllLogins
(
)
;
Assert
.
equal
(
allLogins
.
length
0
)
;
LoginTestUtils
.
clearData
(
)
;
rustStorage
.
removeAllLogins
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_migration_is_triggered_by_pref_change
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
false
]
]
}
)
;
Assert
.
equal
(
Services
.
prefs
.
getBoolPref
(
"
signon
.
rustMirror
.
migrationNeeded
"
false
)
true
"
migrationNeeded
is
set
to
true
"
)
;
const
prefChangePromise
=
TestUtils
.
waitForPrefChange
(
"
signon
.
rustMirror
.
migrationNeeded
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
await
prefChangePromise
;
Assert
.
equal
(
Services
.
prefs
.
getBoolPref
(
"
signon
.
rustMirror
.
migrationNeeded
"
false
)
false
"
migrationNeeded
is
set
to
false
"
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_migration_is_idempotent
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
const
login
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
test
-
user
"
password
:
"
secure
-
password
"
}
)
;
await
Services
.
logins
.
addLoginAsync
(
login
)
;
const
rustStorage
=
new
LoginManagerRustStorage
(
)
;
let
rustLogins
=
await
rustStorage
.
getAllLogins
(
)
;
Assert
.
equal
(
rustLogins
.
length
1
"
Rust
store
contains
login
after
first
migration
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
false
]
]
}
)
;
const
prefChangePromise
=
TestUtils
.
waitForPrefChange
(
"
signon
.
rustMirror
.
migrationNeeded
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
await
prefChangePromise
;
rustLogins
=
await
rustStorage
.
getAllLogins
(
)
;
Assert
.
equal
(
rustLogins
.
length
1
"
No
duplicate
after
second
migration
"
)
;
LoginTestUtils
.
clearData
(
)
;
rustStorage
.
removeAllLogins
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_migration_partial_failure
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
false
]
]
}
)
;
const
rustStorage
=
new
LoginManagerRustStorage
(
)
;
sinon
.
stub
(
rustStorage
"
addLoginsAsync
"
)
.
callsFake
(
async
(
logins
_cont
)
=
>
{
await
rustStorage
.
addWithMeta
(
logins
[
0
]
)
;
return
[
{
login
:
{
}
error
:
null
}
{
login
:
null
error
:
{
message
:
"
row
failed
"
}
}
]
;
}
)
;
const
login_ok
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
test
-
user
-
ok
"
password
:
"
secure
-
password
"
}
)
;
await
Services
.
logins
.
addLoginAsync
(
login_ok
)
;
const
login_bad
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
test
-
user
-
bad
"
password
:
"
secure
-
password
"
}
)
;
await
Services
.
logins
.
addLoginAsync
(
login_bad
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
false
]
]
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
200
)
)
;
const
rustLogins
=
await
rustStorage
.
getAllLogins
(
)
;
Assert
.
equal
(
rustLogins
.
length
1
"
only
valid
login
migrated
"
)
;
sinon
.
restore
(
)
;
LoginTestUtils
.
clearData
(
)
;
rustStorage
.
removeAllLogins
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_migration_rejects_when_bulk_add_rejects
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
false
]
]
}
)
;
const
rustStorage
=
new
LoginManagerRustStorage
(
)
;
sinon
.
stub
(
rustStorage
"
addLoginsAsync
"
)
.
rejects
(
new
Error
(
"
bulk
failed
"
)
)
;
const
login
=
LoginTestUtils
.
testData
.
formLogin
(
{
username
:
"
test
-
user
"
password
:
"
secure
-
password
"
}
)
;
await
Services
.
logins
.
addLoginAsync
(
login
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
false
]
]
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
200
)
)
;
const
rustLogins
=
await
rustStorage
.
getAllLogins
(
)
;
Assert
.
equal
(
rustLogins
.
length
0
"
zero
logins
migrated
"
)
;
const
newPrefValue
=
Services
.
prefs
.
getBoolPref
(
"
signon
.
rustMirror
.
migrationNeeded
"
false
)
;
Assert
.
equal
(
newPrefValue
true
"
pref
has
not
been
reset
"
)
;
sinon
.
restore
(
)
;
LoginTestUtils
.
clearData
(
)
;
rustStorage
.
removeAllLogins
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_migration_time_under_threshold
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
false
]
]
}
)
;
const
numberOfLogins
=
100
;
const
logins
=
Array
.
from
(
{
length
:
numberOfLogins
}
(
_
i
)
=
>
LoginTestUtils
.
testData
.
formLogin
(
{
origin
:
https
:
/
/
www
{
i
}
.
example
.
com
username
:
user
{
i
}
}
)
)
;
await
Services
.
logins
.
addLogins
(
logins
)
;
await
LoginTestUtils
.
reloadData
(
)
;
const
rustStorage
=
new
LoginManagerRustStorage
(
)
;
const
start
=
Date
.
now
(
)
;
const
prefChangePromise
=
TestUtils
.
waitForPrefChange
(
"
signon
.
rustMirror
.
migrationNeeded
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rustMirror
.
enabled
"
true
]
]
}
)
;
await
prefChangePromise
;
const
duration
=
Date
.
now
(
)
-
start
;
Assert
.
less
(
duration
2000
"
Migration
should
complete
under
2s
"
)
;
Assert
.
equal
(
rustStorage
.
countLogins
(
"
"
"
"
"
"
)
numberOfLogins
)
;
LoginTestUtils
.
clearData
(
)
;
rustStorage
.
removeAllLogins
(
)
;
}
)
;
