"
use
strict
"
;
function
buildExpectedLogins
(
aQuery
)
{
return
TestData
.
loginList
(
)
.
filter
(
entry
=
>
Object
.
keys
(
aQuery
)
.
every
(
name
=
>
entry
[
name
]
=
=
=
aQuery
[
name
]
)
)
;
}
async
function
checkSearchLogins
(
aQuery
aExpectedCount
)
{
info
(
"
Testing
searchLogins
for
"
+
JSON
.
stringify
(
aQuery
)
)
;
let
expectedLogins
=
buildExpectedLogins
(
aQuery
)
;
Assert
.
equal
(
expectedLogins
.
length
aExpectedCount
)
;
let
logins
=
await
Services
.
logins
.
searchLoginsAsync
(
aQuery
)
;
LoginTestUtils
.
assertLoginListsEqual
(
logins
expectedLogins
)
;
}
async
function
checkAllSearches
(
aQuery
aExpectedCount
)
{
info
(
"
Testing
all
search
functions
for
"
+
JSON
.
stringify
(
aQuery
)
)
;
let
expectedLogins
=
buildExpectedLogins
(
aQuery
)
;
Assert
.
equal
(
expectedLogins
.
length
aExpectedCount
)
;
let
origin
=
"
origin
"
in
aQuery
?
aQuery
.
origin
:
"
"
;
let
formActionOrigin
=
"
formActionOrigin
"
in
aQuery
?
aQuery
.
formActionOrigin
:
"
"
;
let
httpRealm
=
"
httpRealm
"
in
aQuery
?
aQuery
.
httpRealm
:
"
"
;
let
count
=
Services
.
logins
.
countLogins
(
origin
formActionOrigin
httpRealm
)
;
Assert
.
equal
(
count
expectedLogins
.
length
)
;
await
checkSearchLogins
(
aQuery
aExpectedCount
)
;
}
add_setup
(
async
(
)
=
>
{
await
Services
.
logins
.
addLogins
(
TestData
.
loginList
(
)
)
;
}
)
;
add_task
(
async
function
test_search_all_basic
(
)
{
await
checkAllSearches
(
{
}
28
)
;
await
checkAllSearches
(
{
httpRealm
:
null
}
17
)
;
await
checkAllSearches
(
{
formActionOrigin
:
null
}
11
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
www4
.
example
.
com
"
httpRealm
:
null
}
3
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
www2
.
example
.
org
"
formActionOrigin
:
null
}
2
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
www
.
example
.
com
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
https
:
/
/
www
.
example
.
com
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
https
:
/
/
example
.
com
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
www3
.
example
.
com
"
}
3
)
;
await
checkAllSearches
(
{
formActionOrigin
:
"
http
:
/
/
www
.
example
.
com
"
}
2
)
;
await
checkAllSearches
(
{
formActionOrigin
:
"
https
:
/
/
www
.
example
.
com
"
}
2
)
;
await
checkAllSearches
(
{
formActionOrigin
:
"
http
:
/
/
example
.
com
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
www3
.
example
.
com
"
formActionOrigin
:
"
http
:
/
/
www
.
example
.
com
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
www3
.
example
.
com
"
formActionOrigin
:
"
https
:
/
/
www
.
example
.
com
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
www3
.
example
.
com
"
formActionOrigin
:
"
http
:
/
/
example
.
com
"
}
1
)
;
await
checkAllSearches
(
{
httpRealm
:
"
The
HTTP
Realm
"
}
3
)
;
await
checkAllSearches
(
{
httpRealm
:
"
ftp
:
/
/
ftp
.
example
.
org
"
}
1
)
;
await
checkAllSearches
(
{
httpRealm
:
"
The
HTTP
Realm
Other
"
}
2
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
example
.
net
"
httpRealm
:
"
The
HTTP
Realm
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
http
:
/
/
example
.
net
"
httpRealm
:
"
The
HTTP
Realm
Other
"
}
1
)
;
await
checkAllSearches
(
{
origin
:
"
ftp
:
/
/
example
.
net
"
httpRealm
:
"
ftp
:
/
/
example
.
net
"
}
1
)
;
}
)
;
add_task
(
async
function
test_searchLogins
(
)
{
await
checkSearchLogins
(
{
usernameField
:
"
form_field_username
"
}
12
)
;
await
checkSearchLogins
(
{
passwordField
:
"
form_field_password
"
}
13
)
;
await
checkSearchLogins
(
{
usernameField
:
"
"
}
16
)
;
await
checkSearchLogins
(
{
httpRealm
:
null
usernameField
:
"
"
}
5
)
;
await
checkSearchLogins
(
{
origin
:
"
http
:
/
/
www6
.
example
.
com
"
usernameField
:
"
"
}
1
)
;
}
)
;
add_task
(
async
function
test_searchLogins_invalid
(
)
{
await
Assert
.
rejects
(
Services
.
logins
.
searchLoginsAsync
(
{
foo
:
"
value
"
}
)
/
Unexpected
field
/
)
;
}
)
;
add_task
(
function
test_search_all_full_case_sensitive
(
)
{
checkAllSearches
(
{
origin
:
"
http
:
/
/
www
.
example
.
com
"
}
1
)
;
checkAllSearches
(
{
origin
:
"
http
:
/
/
www
.
example
.
com
/
"
}
0
)
;
checkAllSearches
(
{
origin
:
"
example
.
com
"
}
0
)
;
checkAllSearches
(
{
formActionOrigin
:
"
http
:
/
/
www
.
example
.
com
"
}
2
)
;
checkAllSearches
(
{
formActionOrigin
:
"
http
:
/
/
www
.
example
.
com
/
"
}
0
)
;
checkAllSearches
(
{
formActionOrigin
:
"
http
:
/
/
"
}
0
)
;
checkAllSearches
(
{
formActionOrigin
:
"
example
.
com
"
}
0
)
;
checkAllSearches
(
{
httpRealm
:
"
The
HTTP
Realm
"
}
3
)
;
checkAllSearches
(
{
httpRealm
:
"
The
http
Realm
"
}
0
)
;
checkAllSearches
(
{
httpRealm
:
"
The
HTTP
"
}
0
)
;
checkAllSearches
(
{
httpRealm
:
"
Realm
"
}
0
)
;
}
)
;
add_task
(
async
function
test_search_all_empty
(
)
{
checkAllSearches
(
{
origin
:
"
http
:
/
/
nonexistent
.
example
.
com
"
}
0
)
;
checkAllSearches
(
{
formActionOrigin
:
"
http
:
/
/
www
.
example
.
com
"
httpRealm
:
"
The
HTTP
Realm
"
}
0
)
;
await
checkSearchLogins
(
{
origin
:
"
"
}
0
)
;
await
checkSearchLogins
(
{
id
:
"
1000
"
}
0
)
;
}
)
;
