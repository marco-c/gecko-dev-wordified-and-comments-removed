var
Ci
=
SpecialPowers
.
Ci
;
ok
(
Ci
!
=
null
"
Access
Ci
"
)
;
var
Cc
=
SpecialPowers
.
Cc
;
ok
(
Cc
!
=
null
"
Access
Cc
"
)
;
var
didDialog
;
var
timer
;
function
startCallbackTimer
(
)
{
didDialog
=
false
;
const
dialogDelay
=
10
;
timer
=
Cc
[
"
mozilla
.
org
/
timer
;
1
"
]
.
createInstance
(
Ci
.
nsITimer
)
;
timer
.
init
(
observer
dialogDelay
Ci
.
nsITimer
.
TYPE_ONE_SHOT
)
;
}
var
observer
=
SpecialPowers
.
wrapCallbackObject
(
{
QueryInterface
(
iid
)
{
const
interfaces
=
[
Ci
.
nsIObserver
Ci
.
nsISupports
Ci
.
nsISupportsWeakReference
]
;
if
(
!
interfaces
.
some
(
function
(
v
)
{
return
iid
.
equals
(
v
)
;
}
)
)
{
throw
SpecialPowers
.
Components
.
results
.
NS_ERROR_NO_INTERFACE
;
}
return
this
;
}
observe
(
subject
topic
data
)
{
var
doc
=
getDialogDoc
(
)
;
if
(
doc
)
{
handleDialog
(
doc
testNum
)
;
}
else
{
startCallbackTimer
(
)
;
}
}
}
)
;
function
getDialogDoc
(
)
{
for
(
let
{
docShell
}
of
SpecialPowers
.
Services
.
wm
.
getXULWindowEnumerator
(
null
)
)
{
var
containedDocShells
=
docShell
.
getDocShellEnumerator
(
docShell
.
typeChrome
docShell
.
ENUMERATE_FORWARDS
)
;
for
(
let
childDocShell
of
containedDocShells
)
{
if
(
childDocShell
.
busyFlags
!
=
Ci
.
nsIDocShell
.
BUSY_FLAGS_NONE
)
{
continue
;
}
var
childDoc
=
childDocShell
.
contentViewer
.
DOMDocument
;
if
(
childDoc
.
location
.
href
=
=
"
chrome
:
/
/
global
/
content
/
commonDialog
.
xul
"
)
{
return
childDoc
;
}
}
}
return
null
;
}
