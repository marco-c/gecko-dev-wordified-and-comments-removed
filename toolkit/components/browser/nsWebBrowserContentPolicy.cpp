#
include
"
nsWebBrowserContentPolicy
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsContentPolicyUtils
.
h
"
#
include
"
nsNetUtil
.
h
"
nsWebBrowserContentPolicy
:
:
nsWebBrowserContentPolicy
(
)
=
default
;
nsWebBrowserContentPolicy
:
:
~
nsWebBrowserContentPolicy
(
)
=
default
;
NS_IMPL_ISUPPORTS
(
nsWebBrowserContentPolicy
nsIContentPolicy
)
NS_IMETHODIMP
nsWebBrowserContentPolicy
:
:
ShouldLoad
(
nsIURI
*
aContentLocation
nsILoadInfo
*
aLoadInfo
const
nsACString
&
aMimeGuess
int16_t
*
aShouldLoad
)
{
MOZ_ASSERT
(
aShouldLoad
"
Null
out
param
"
)
;
uint32_t
contentType
=
aLoadInfo
-
>
GetExternalContentPolicyType
(
)
;
MOZ_ASSERT
(
contentType
=
=
nsContentUtils
:
:
InternalContentPolicyTypeToExternal
(
contentType
)
"
We
should
only
see
external
content
policy
types
here
.
"
)
;
*
aShouldLoad
=
nsIContentPolicy
:
:
ACCEPT
;
nsCOMPtr
<
nsISupports
>
context
=
aLoadInfo
-
>
GetLoadingContext
(
)
;
nsIDocShell
*
shell
=
NS_CP_GetDocShellFromContext
(
context
)
;
if
(
!
shell
)
{
return
NS_OK
;
}
nsresult
rv
;
bool
allowed
=
true
;
switch
(
contentType
)
{
case
nsIContentPolicy
:
:
TYPE_SCRIPT
:
rv
=
shell
-
>
GetAllowJavascript
(
&
allowed
)
;
break
;
case
nsIContentPolicy
:
:
TYPE_SUBDOCUMENT
:
rv
=
shell
-
>
GetAllowSubframes
(
&
allowed
)
;
break
;
#
if
0
case
nsIContentPolicy
:
:
TYPE_REFRESH
:
rv
=
shell
-
>
GetAllowMetaRedirects
(
&
allowed
)
;
break
;
#
endif
case
nsIContentPolicy
:
:
TYPE_IMAGE
:
case
nsIContentPolicy
:
:
TYPE_IMAGESET
:
rv
=
shell
-
>
GetAllowImages
(
&
allowed
)
;
break
;
default
:
return
NS_OK
;
}
if
(
NS_SUCCEEDED
(
rv
)
&
&
!
allowed
)
{
NS_SetRequestBlockingReason
(
aLoadInfo
nsILoadInfo
:
:
BLOCKING_REASON_CONTENT_POLICY_WEB_BROWSER
)
;
*
aShouldLoad
=
nsIContentPolicy
:
:
REJECT_TYPE
;
}
return
rv
;
}
NS_IMETHODIMP
nsWebBrowserContentPolicy
:
:
ShouldProcess
(
nsIURI
*
aContentLocation
nsILoadInfo
*
aLoadInfo
const
nsACString
&
aMimeGuess
int16_t
*
aShouldProcess
)
{
MOZ_ASSERT
(
aShouldProcess
"
Null
out
param
"
)
;
uint32_t
contentType
=
aLoadInfo
-
>
GetExternalContentPolicyType
(
)
;
MOZ_ASSERT
(
contentType
=
=
nsContentUtils
:
:
InternalContentPolicyTypeToExternal
(
contentType
)
"
We
should
only
see
external
content
policy
types
here
.
"
)
;
*
aShouldProcess
=
nsIContentPolicy
:
:
ACCEPT
;
if
(
contentType
!
=
nsIContentPolicy
:
:
TYPE_OBJECT
)
{
return
NS_OK
;
}
nsCOMPtr
<
nsISupports
>
context
=
aLoadInfo
-
>
GetLoadingContext
(
)
;
nsIDocShell
*
shell
=
NS_CP_GetDocShellFromContext
(
context
)
;
if
(
shell
&
&
(
!
shell
-
>
PluginsAllowedInCurrentDoc
(
)
)
)
{
NS_SetRequestBlockingReason
(
aLoadInfo
nsILoadInfo
:
:
BLOCKING_REASON_CONTENT_POLICY_WEB_BROWSER
)
;
*
aShouldProcess
=
nsIContentPolicy
:
:
REJECT_TYPE
;
}
return
NS_OK
;
}
