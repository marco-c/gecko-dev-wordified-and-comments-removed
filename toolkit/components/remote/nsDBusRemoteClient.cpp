#
include
"
nsDBusRemoteClient
.
h
"
#
include
"
RemoteUtils
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
Base64
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
<
dlfcn
.
h
>
#
include
<
dbus
/
dbus
-
glib
-
lowlevel
.
h
>
using
mozilla
:
:
LogLevel
;
static
mozilla
:
:
LazyLogModule
sRemoteLm
(
"
nsDBusRemoteClient
"
)
;
nsDBusRemoteClient
:
:
nsDBusRemoteClient
(
)
{
mConnection
=
nullptr
;
MOZ_LOG
(
sRemoteLm
LogLevel
:
:
Debug
(
"
nsDBusRemoteClient
:
:
nsDBusRemoteClient
"
)
)
;
}
nsDBusRemoteClient
:
:
~
nsDBusRemoteClient
(
)
{
MOZ_LOG
(
sRemoteLm
LogLevel
:
:
Debug
(
"
nsDBusRemoteClient
:
:
~
nsDBusRemoteClient
"
)
)
;
Shutdown
(
)
;
}
nsresult
nsDBusRemoteClient
:
:
Init
(
)
{
MOZ_LOG
(
sRemoteLm
LogLevel
:
:
Debug
(
"
nsDBusRemoteClient
:
:
Init
"
)
)
;
if
(
mConnection
)
return
NS_OK
;
mConnection
=
already_AddRefed
<
DBusConnection
>
(
dbus_bus_get
(
DBUS_BUS_SESSION
nullptr
)
)
;
if
(
!
mConnection
)
return
NS_ERROR_FAILURE
;
dbus_connection_set_exit_on_disconnect
(
mConnection
false
)
;
dbus_connection_setup_with_g_main
(
mConnection
nullptr
)
;
return
NS_OK
;
}
void
nsDBusRemoteClient
:
:
Shutdown
(
void
)
{
MOZ_LOG
(
sRemoteLm
LogLevel
:
:
Debug
(
"
nsDBusRemoteClient
:
:
Shutdown
"
)
)
;
mConnection
=
nullptr
;
}
nsresult
nsDBusRemoteClient
:
:
SendCommandLine
(
const
char
*
aProgram
const
char
*
aProfile
int32_t
argc
char
*
*
argv
const
char
*
aDesktopStartupID
char
*
*
aResponse
bool
*
aWindowFound
)
{
NS_ENSURE_TRUE
(
aProgram
NS_ERROR_INVALID_ARG
)
;
MOZ_LOG
(
sRemoteLm
LogLevel
:
:
Debug
(
"
nsDBusRemoteClient
:
:
SendCommandLine
"
)
)
;
int
commandLineLength
;
char
*
commandLine
=
ConstructCommandLine
(
argc
argv
aDesktopStartupID
&
commandLineLength
)
;
if
(
!
commandLine
)
return
NS_ERROR_FAILURE
;
nsresult
rv
=
DoSendDBusCommandLine
(
aProgram
aProfile
commandLine
commandLineLength
)
;
free
(
commandLine
)
;
*
aWindowFound
=
NS_SUCCEEDED
(
rv
)
;
MOZ_LOG
(
sRemoteLm
LogLevel
:
:
Debug
(
"
DoSendDBusCommandLine
returning
0x
%
"
PRIx32
"
\
n
"
static_cast
<
uint32_t
>
(
rv
)
)
)
;
return
rv
;
}
bool
nsDBusRemoteClient
:
:
GetRemoteDestinationName
(
const
char
*
aProgram
const
char
*
aProfile
nsCString
&
aDestinationName
)
{
nsAutoCString
profileName
;
nsresult
rv
=
mozilla
:
:
Base64Encode
(
nsAutoCString
(
aProfile
)
profileName
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
profileName
.
ReplaceChar
(
"
+
/
=
-
"
'
_
'
)
;
aDestinationName
=
nsPrintfCString
(
"
org
.
mozilla
.
%
s
.
%
s
"
aProgram
profileName
.
get
(
)
)
;
if
(
aDestinationName
.
Length
(
)
>
DBUS_MAXIMUM_NAME_LENGTH
)
aDestinationName
.
Truncate
(
DBUS_MAXIMUM_NAME_LENGTH
)
;
static
auto
sDBusValidateBusName
=
(
bool
(
*
)
(
const
char
*
DBusError
*
)
)
dlsym
(
RTLD_DEFAULT
"
dbus_validate_bus_name
"
)
;
if
(
!
sDBusValidateBusName
)
{
return
false
;
}
if
(
!
sDBusValidateBusName
(
aDestinationName
.
get
(
)
nullptr
)
)
{
aDestinationName
=
nsPrintfCString
(
"
org
.
mozilla
.
%
s
.
%
s
"
aProgram
"
default
"
)
;
if
(
!
sDBusValidateBusName
(
aDestinationName
.
get
(
)
nullptr
)
)
{
return
false
;
}
}
return
true
;
}
nsresult
nsDBusRemoteClient
:
:
DoSendDBusCommandLine
(
const
char
*
aProgram
const
char
*
aProfile
const
char
*
aBuffer
int
aLength
)
{
nsAutoCString
appName
(
aProgram
)
;
appName
.
ReplaceChar
(
"
+
/
=
-
"
'
_
'
)
;
nsAutoCString
destinationName
;
if
(
!
GetRemoteDestinationName
(
appName
.
get
(
)
aProfile
destinationName
)
)
return
NS_ERROR_FAILURE
;
nsAutoCString
pathName
;
pathName
=
nsPrintfCString
(
"
/
org
/
mozilla
/
%
s
/
Remote
"
appName
.
get
(
)
)
;
static
auto
sDBusValidatePathName
=
(
bool
(
*
)
(
const
char
*
DBusError
*
)
)
dlsym
(
RTLD_DEFAULT
"
dbus_validate_path
"
)
;
if
(
!
sDBusValidatePathName
|
|
!
sDBusValidatePathName
(
pathName
.
get
(
)
nullptr
)
)
{
return
NS_ERROR_FAILURE
;
}
nsAutoCString
remoteInterfaceName
;
remoteInterfaceName
=
nsPrintfCString
(
"
org
.
mozilla
.
%
s
"
appName
.
get
(
)
)
;
RefPtr
<
DBusMessage
>
msg
=
already_AddRefed
<
DBusMessage
>
(
dbus_message_new_method_call
(
destinationName
.
get
(
)
pathName
.
get
(
)
remoteInterfaceName
.
get
(
)
"
OpenURL
"
)
)
;
if
(
!
msg
)
{
return
NS_ERROR_FAILURE
;
}
if
(
!
dbus_message_append_args
(
msg
DBUS_TYPE_ARRAY
DBUS_TYPE_BYTE
&
aBuffer
aLength
DBUS_TYPE_INVALID
)
)
{
return
NS_ERROR_FAILURE
;
}
RefPtr
<
DBusMessage
>
reply
=
already_AddRefed
<
DBusMessage
>
(
dbus_connection_send_with_reply_and_block
(
mConnection
msg
-
1
nullptr
)
)
;
return
reply
?
NS_OK
:
NS_ERROR_FAILURE
;
}
