#
ifndef
mozilla_antitrackingservice_h
#
define
mozilla_antitrackingservice_h
#
include
"
nsString
.
h
"
#
include
"
mozilla
/
ContentBlockingNotifier
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
StaticPrefs_privacy
.
h
"
#
include
"
nsIUrlClassifierFeature
.
h
"
class
nsIChannel
;
class
nsICookieJarSettings
;
class
nsIPermission
;
class
nsIPrincipal
;
class
nsIURI
;
class
nsPIDOMWindowInner
;
class
nsPIDOMWindowOuter
;
namespace
mozilla
{
class
OriginAttributes
;
namespace
dom
{
class
BrowsingContext
;
class
ContentParent
;
class
Document
;
}
class
ContentBlocking
final
{
public
:
static
bool
ShouldAllowAccessFor
(
nsPIDOMWindowInner
*
a3rdPartyTrackingWindow
nsIURI
*
aURI
uint32_t
*
aRejectedReason
)
;
static
bool
ApproximateAllowAccessForWithoutChannel
(
nsPIDOMWindowInner
*
aFirstPartyWindow
nsIURI
*
aURI
)
;
static
bool
ShouldAllowAccessFor
(
nsIChannel
*
aChannel
nsIURI
*
aURI
uint32_t
*
aRejectedReason
)
;
static
bool
ShouldAllowAccessFor
(
nsIPrincipal
*
aPrincipal
nsICookieJarSettings
*
aCookieJarSettings
)
;
enum
StorageAccessPromptChoices
{
eAllow
eAllowAutoGrant
}
;
typedef
MozPromise
<
int
bool
true
>
StorageAccessFinalCheckPromise
;
typedef
std
:
:
function
<
RefPtr
<
StorageAccessFinalCheckPromise
>
(
)
>
PerformFinalChecks
;
typedef
MozPromise
<
int
bool
true
>
StorageAccessPermissionGrantPromise
;
[
[
nodiscard
]
]
static
RefPtr
<
StorageAccessPermissionGrantPromise
>
AllowAccessFor
(
nsIPrincipal
*
aPrincipal
dom
:
:
BrowsingContext
*
aParentContext
ContentBlockingNotifier
:
:
StorageAccessPermissionGrantedReason
aReason
const
PerformFinalChecks
&
aPerformFinalChecks
=
nullptr
)
;
static
void
OnAllowAccessFor
(
dom
:
:
BrowsingContext
*
aParentContext
const
nsCString
&
aTrackingOrigin
uint32_t
aCookieBehavior
ContentBlockingNotifier
:
:
StorageAccessPermissionGrantedReason
aReason
)
;
typedef
MozPromise
<
nsresult
bool
true
>
ParentAccessGrantPromise
;
static
RefPtr
<
ParentAccessGrantPromise
>
SaveAccessForOriginOnParentProcess
(
nsIPrincipal
*
aParentPrincipal
nsIPrincipal
*
aTrackingPrincipal
int
aAllowMode
uint64_t
aExpirationTime
=
StaticPrefs
:
:
privacy_restrict3rdpartystorage_expiration
(
)
)
;
static
RefPtr
<
ParentAccessGrantPromise
>
SaveAccessForOriginOnParentProcess
(
uint64_t
aTopLevelWindowId
dom
:
:
BrowsingContext
*
aParentContext
nsIPrincipal
*
aTrackingPrincipal
int
aAllowMode
uint64_t
aExpirationTime
=
StaticPrefs
:
:
privacy_restrict3rdpartystorage_expiration
(
)
)
;
static
Maybe
<
bool
>
CheckCookiesPermittedDecidesStorageAccessAPI
(
nsICookieJarSettings
*
aCookieJarSettings
nsIPrincipal
*
aRequestingPrincipal
)
;
static
RefPtr
<
MozPromise
<
Maybe
<
bool
>
nsresult
true
>
>
AsyncCheckCookiesPermittedDecidesStorageAccessAPI
(
dom
:
:
BrowsingContext
*
aBrowsingContext
nsIPrincipal
*
aRequestingPrincipal
)
;
static
Maybe
<
bool
>
CheckBrowserSettingsDecidesStorageAccessAPI
(
nsICookieJarSettings
*
aCookieJarSettings
bool
aThirdParty
)
;
static
Maybe
<
bool
>
CheckCallingContextDecidesStorageAccessAPI
(
dom
:
:
Document
*
aDocument
bool
aRequestingStorageAccess
)
;
static
Maybe
<
bool
>
CheckSameSiteCallingContextDecidesStorageAccessAPI
(
dom
:
:
Document
*
aDocument
bool
aRequireUserActivation
)
;
static
Maybe
<
bool
>
CheckExistingPermissionDecidesStorageAccessAPI
(
dom
:
:
Document
*
aDocument
)
;
private
:
friend
class
dom
:
:
ContentParent
;
[
[
nodiscard
]
]
static
RefPtr
<
StorageAccessPermissionGrantPromise
>
CompleteAllowAccessFor
(
dom
:
:
BrowsingContext
*
aParentContext
uint64_t
aTopLevelWindowId
nsIPrincipal
*
aTrackingPrincipal
const
nsCString
&
aTrackingOrigin
uint32_t
aCookieBehavior
ContentBlockingNotifier
:
:
StorageAccessPermissionGrantedReason
aReason
const
PerformFinalChecks
&
aPerformFinalChecks
=
nullptr
)
;
static
void
UpdateAllowAccessOnCurrentProcess
(
dom
:
:
BrowsingContext
*
aParentContext
const
nsACString
&
aTrackingOrigin
)
;
static
void
UpdateAllowAccessOnParentProcess
(
dom
:
:
BrowsingContext
*
aParentContext
const
nsACString
&
aTrackingOrigin
)
;
typedef
MozPromise
<
uint32_t
nsresult
true
>
CheckTrackerForPrincipalPromise
;
class
TrackerClassifierFeatureCallback
final
:
public
nsIUrlClassifierFeatureCallback
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIURLCLASSIFIERFEATURECALLBACK
RefPtr
<
CheckTrackerForPrincipalPromise
>
Promise
(
)
{
return
mHolder
.
Ensure
(
__func__
)
;
}
void
Reject
(
nsresult
rv
)
{
mHolder
.
Reject
(
rv
__func__
)
;
}
TrackerClassifierFeatureCallback
(
)
=
default
;
private
:
~
TrackerClassifierFeatureCallback
(
)
=
default
;
MozPromiseHolder
<
CheckTrackerForPrincipalPromise
>
mHolder
;
}
;
[
[
nodiscard
]
]
static
RefPtr
<
CheckTrackerForPrincipalPromise
>
CheckTrackerForPrincipal
(
nsIPrincipal
*
aPrincipal
)
;
}
;
}
#
endif
