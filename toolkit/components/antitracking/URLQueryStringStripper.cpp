#
include
"
URLQueryStringStripper
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
StaticPrefs_privacy
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsEffectiveTLDService
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsIURIMutator
.
h
"
#
include
"
nsUnicharUtils
.
h
"
#
include
"
nsURLHelper
.
h
"
namespace
{
mozilla
:
:
StaticRefPtr
<
mozilla
:
:
URLQueryStringStripper
>
gQueryStringStripper
;
}
namespace
mozilla
{
NS_IMPL_ISUPPORTS
(
URLQueryStringStripper
nsIURLQueryStrippingListObserver
)
URLQueryStringStripper
*
URLQueryStringStripper
:
:
GetOrCreate
(
)
{
if
(
!
gQueryStringStripper
)
{
gQueryStringStripper
=
new
URLQueryStringStripper
(
)
;
gQueryStringStripper
-
>
Init
(
)
;
RunOnShutdown
(
[
&
]
{
gQueryStringStripper
-
>
Shutdown
(
)
;
gQueryStringStripper
=
nullptr
;
}
ShutdownPhase
:
:
XPCOMShutdown
)
;
}
return
gQueryStringStripper
;
}
bool
URLQueryStringStripper
:
:
Strip
(
nsIURI
*
aURI
nsCOMPtr
<
nsIURI
>
&
aOutput
)
{
if
(
!
StaticPrefs
:
:
privacy_query_stripping_enabled
(
)
)
{
return
false
;
}
RefPtr
<
URLQueryStringStripper
>
stripper
=
GetOrCreate
(
)
;
if
(
stripper
-
>
CheckAllowList
(
aURI
)
)
{
return
false
;
}
return
stripper
-
>
StripQueryString
(
aURI
aOutput
)
;
}
void
URLQueryStringStripper
:
:
Init
(
)
{
mService
=
do_GetService
(
"
mozilla
.
org
/
query
-
stripping
-
list
-
service
;
1
"
)
;
NS_ENSURE_TRUE_VOID
(
mService
)
;
mService
-
>
Init
(
)
;
mService
-
>
RegisterAndRunObserver
(
this
)
;
}
void
URLQueryStringStripper
:
:
Shutdown
(
)
{
mList
.
Clear
(
)
;
mAllowList
.
Clear
(
)
;
mService
-
>
UnregisterObserver
(
this
)
;
mService
=
nullptr
;
}
bool
URLQueryStringStripper
:
:
StripQueryString
(
nsIURI
*
aURI
nsCOMPtr
<
nsIURI
>
&
aOutput
)
{
MOZ_ASSERT
(
aURI
)
;
nsCOMPtr
<
nsIURI
>
uri
(
aURI
)
;
nsAutoCString
query
;
nsresult
rv
=
aURI
-
>
GetQuery
(
query
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
if
(
query
.
IsEmpty
(
)
)
{
return
false
;
}
URLParams
params
;
bool
hasStripped
=
false
;
URLParams
:
:
Parse
(
query
[
&
]
(
nsString
&
&
name
nsString
&
&
value
)
{
nsAutoString
lowerCaseName
;
ToLowerCase
(
name
lowerCaseName
)
;
if
(
mList
.
Contains
(
lowerCaseName
)
)
{
hasStripped
=
true
;
return
true
;
}
params
.
Append
(
name
value
)
;
return
true
;
}
)
;
if
(
!
hasStripped
)
{
return
false
;
}
nsAutoString
newQuery
;
params
.
Serialize
(
newQuery
false
)
;
Unused
<
<
NS_MutateURI
(
uri
)
.
SetQuery
(
NS_ConvertUTF16toUTF8
(
newQuery
)
)
.
Finalize
(
aOutput
)
;
return
true
;
}
bool
URLQueryStringStripper
:
:
CheckAllowList
(
nsIURI
*
aURI
)
{
MOZ_ASSERT
(
aURI
)
;
nsAutoCString
baseDomain
;
nsresult
rv
=
nsEffectiveTLDService
:
:
GetInstance
(
)
-
>
GetBaseDomain
(
aURI
0
baseDomain
)
;
if
(
rv
=
=
NS_ERROR_INSUFFICIENT_DOMAIN_LEVELS
)
{
return
false
;
}
NS_ENSURE_SUCCESS
(
rv
false
)
;
return
mAllowList
.
Contains
(
baseDomain
)
;
}
void
URLQueryStringStripper
:
:
PopulateStripList
(
const
nsAString
&
aList
)
{
mList
.
Clear
(
)
;
for
(
const
nsAString
&
item
:
aList
.
Split
(
'
'
)
)
{
mList
.
Insert
(
item
)
;
}
}
void
URLQueryStringStripper
:
:
PopulateAllowList
(
const
nsACString
&
aList
)
{
mAllowList
.
Clear
(
)
;
for
(
const
nsACString
&
item
:
aList
.
Split
(
'
'
)
)
{
mAllowList
.
Insert
(
item
)
;
}
}
NS_IMETHODIMP
URLQueryStringStripper
:
:
OnQueryStrippingListUpdate
(
const
nsAString
&
aStripList
const
nsACString
&
aAllowList
)
{
PopulateStripList
(
aStripList
)
;
PopulateAllowList
(
aAllowList
)
;
return
NS_OK
;
}
}
