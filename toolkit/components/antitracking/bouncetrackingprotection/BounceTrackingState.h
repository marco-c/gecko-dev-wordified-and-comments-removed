#
ifndef
mozilla_BounceTrackingState_h
#
define
mozilla_BounceTrackingState_h
#
include
"
BounceTrackingRecord
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
#
include
"
mozilla
/
OriginAttributes
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsIWeakReferenceUtils
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsIWebProgressListener
.
h
"
#
include
"
nsWeakReference
.
h
"
class
nsIChannel
;
class
nsITimer
;
class
nsIPrincipal
;
namespace
mozilla
{
class
BounceTrackingProtection
;
namespace
dom
{
class
CanonicalBrowsingContext
;
class
BrowsingContext
;
class
BrowsingContextWebProgress
;
}
class
BounceTrackingState
:
public
nsIWebProgressListener
public
nsSupportsWeakReference
public
SupportsWeakPtr
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIWEBPROGRESSLISTENER
static
already_AddRefed
<
BounceTrackingState
>
GetOrCreate
(
dom
:
:
BrowsingContextWebProgress
*
aWebProgress
nsresult
&
aRv
)
;
static
void
ResetAll
(
)
;
static
void
ResetAllForOriginAttributes
(
const
OriginAttributes
&
aOriginAttributes
)
;
static
void
ResetAllForOriginAttributesPattern
(
const
OriginAttributesPattern
&
aPattern
)
;
const
Maybe
<
BounceTrackingRecord
>
&
GetBounceTrackingRecord
(
)
;
void
ResetBounceTrackingRecord
(
)
;
[
[
nodiscard
]
]
nsresult
OnDocumentStartRequest
(
nsIChannel
*
aChannel
)
;
[
[
nodiscard
]
]
nsresult
OnStartNavigation
(
nsIPrincipal
*
aTriggeringPrincipal
const
bool
aHasValidUserGestureActivation
)
;
[
[
nodiscard
]
]
nsresult
OnCookieWrite
(
const
nsACString
&
aSiteHost
)
;
static
bool
ShouldCreateBounceTrackingStateForBC
(
dom
:
:
CanonicalBrowsingContext
*
aBrowsingContext
)
;
static
bool
ShouldTrackPrincipal
(
nsIPrincipal
*
aPrincipal
)
;
[
[
nodiscard
]
]
static
nsresult
HasBounceTrackingStateForSite
(
const
nsACString
&
aSiteHost
bool
&
aResult
)
;
already_AddRefed
<
dom
:
:
BrowsingContext
>
CurrentBrowsingContext
(
)
;
uint64_t
GetBrowserId
(
)
{
return
mBrowserId
;
}
const
OriginAttributes
&
OriginAttributesRef
(
)
;
nsCString
Describe
(
)
;
[
[
nodiscard
]
]
nsresult
OnStorageAccess
(
nsIPrincipal
*
aPrincipal
)
;
private
:
explicit
BounceTrackingState
(
)
;
virtual
~
BounceTrackingState
(
)
;
bool
mIsInitialized
{
false
}
;
uint64_t
mBrowserId
{
}
;
OriginAttributes
mOriginAttributes
;
RefPtr
<
BounceTrackingProtection
>
mBounceTrackingProtection
;
Maybe
<
BounceTrackingRecord
>
mBounceTrackingRecord
;
RefPtr
<
nsITimer
>
mClientBounceDetectionTimeout
;
static
void
Reset
(
const
OriginAttributes
*
aOriginAttributes
const
OriginAttributesPattern
*
aPattern
)
;
static
bool
ShouldCreateBounceTrackingStateForWebProgress
(
dom
:
:
BrowsingContextWebProgress
*
aWebProgress
)
;
[
[
nodiscard
]
]
nsresult
Init
(
dom
:
:
BrowsingContextWebProgress
*
aWebProgress
)
;
[
[
nodiscard
]
]
nsresult
OnResponseReceived
(
const
nsTArray
<
nsCString
>
&
aSiteList
)
;
[
[
nodiscard
]
]
nsresult
OnDocumentLoaded
(
nsIPrincipal
*
aDocumentPrincipal
)
;
[
[
nodiscard
]
]
nsresult
OnServiceWorkerActivation
(
)
;
}
;
}
#
endif
