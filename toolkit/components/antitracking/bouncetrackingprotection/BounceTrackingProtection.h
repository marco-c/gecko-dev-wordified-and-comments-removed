#
ifndef
mozilla_BounceTrackingProtection_h__
#
define
mozilla_BounceTrackingProtection_h__
#
include
"
BounceTrackingMapEntry
.
h
"
#
include
"
BounceTrackingStorageObserver
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
nsIBounceTrackingProtection
.
h
"
#
include
"
nsIBTPRemoteExceptionList
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
"
nsTHashSet
.
h
"
class
nsIPrincipal
;
class
nsITimer
;
namespace
mozilla
{
class
BounceTrackingAllowList
;
class
BounceTrackingState
;
class
BounceTrackingStateGlobal
;
class
BounceTrackingProtectionStorage
;
class
ClearDataCallback
;
class
OriginAttributes
;
namespace
dom
{
class
CanonicalBrowsingContext
;
class
WindowContext
;
class
WindowGlobalParent
;
}
using
ClearDataMozPromise
=
MozPromise
<
RefPtr
<
BounceTrackingPurgeEntry
>
uint32_t
true
>
;
extern
LazyLogModule
gBounceTrackingProtectionLog
;
class
BounceTrackingProtection
final
:
public
nsIBounceTrackingProtection
public
nsIObserver
public
nsSupportsWeakReference
{
NS_DECL_ISUPPORTS
NS_DECL_NSIOBSERVER
NS_DECL_NSIBOUNCETRACKINGPROTECTION
public
:
static
already_AddRefed
<
BounceTrackingProtection
>
GetSingleton
(
)
;
static
void
RecordModePrefTelemetry
(
)
;
[
[
nodiscard
]
]
nsresult
RecordStatefulBounces
(
BounceTrackingState
*
aBounceTrackingState
)
;
[
[
nodiscard
]
]
static
nsresult
RecordUserActivation
(
nsIPrincipal
*
aPrincipal
Maybe
<
PRTime
>
aActivationTime
=
Nothing
(
)
dom
:
:
CanonicalBrowsingContext
*
aTopBrowsingContext
=
nullptr
)
;
[
[
nodiscard
]
]
static
nsresult
RecordUserActivation
(
dom
:
:
WindowContext
*
aWindowContext
)
;
[
[
nodiscard
]
]
nsresult
ClearExpiredUserInteractions
(
BounceTrackingStateGlobal
*
aStateGlobal
=
nullptr
)
;
void
MaybeLogPurgedWarningForSite
(
nsIPrincipal
*
aPrincipal
BounceTrackingState
*
aBounceTrackingState
)
;
private
:
BounceTrackingProtection
(
)
=
default
;
~
BounceTrackingProtection
(
)
=
default
;
[
[
nodiscard
]
]
nsresult
Init
(
)
;
static
void
OnPrefChange
(
const
char
*
aPref
void
*
aData
)
;
nsresult
OnModeChange
(
bool
aIsStartup
)
;
nsresult
UpdateBounceTrackingPurgeTimer
(
bool
aShouldEnable
)
;
static
Maybe
<
uint32_t
>
sLastRecordedModeTelemetry
;
nsCOMPtr
<
nsITimer
>
mBounceTrackingPurgeTimer
;
RefPtr
<
BounceTrackingStorageObserver
>
mStorageObserver
;
RefPtr
<
BounceTrackingProtectionStorage
>
mStorage
;
nsCOMPtr
<
nsIBTPRemoteExceptionList
>
mRemoteExceptionList
;
RefPtr
<
GenericNonExclusivePromise
>
mRemoteExceptionListInitPromise
;
nsTHashSet
<
nsCStringHashKey
>
mRemoteSiteHostExceptions
;
RefPtr
<
GenericNonExclusivePromise
>
EnsureRemoteExceptionListService
(
)
;
using
PurgeBounceTrackersMozPromise
=
MozPromise
<
nsTArray
<
RefPtr
<
BounceTrackingPurgeEntry
>
>
nsresult
true
>
;
RefPtr
<
PurgeBounceTrackersMozPromise
>
PurgeBounceTrackers
(
)
;
static
void
ReportPurgedTrackersToAntiTrackingDB
(
const
nsTArray
<
RefPtr
<
BounceTrackingPurgeEntry
>
>
&
aPurgedSiteHosts
)
;
[
[
nodiscard
]
]
nsresult
PurgeBounceTrackersForStateGlobal
(
BounceTrackingStateGlobal
*
aStateGlobal
BounceTrackingAllowList
&
aBounceTrackingAllowList
nsTArray
<
RefPtr
<
ClearDataMozPromise
>
>
&
aClearPromises
)
;
[
[
nodiscard
]
]
nsresult
PurgeStateForHostAndOriginAttributes
(
const
nsACString
&
aHost
PRTime
bounceTime
const
OriginAttributes
&
aOriginAttributes
ClearDataMozPromise
*
*
aClearPromise
)
;
bool
mPurgeInProgress
=
false
;
[
[
nodiscard
]
]
nsresult
MaybeMigrateUserInteractionPermissions
(
)
;
[
[
nodiscard
]
]
static
nsresult
LogBounceTrackersClassifiedToWebConsole
(
BounceTrackingState
*
aBounceTrackingState
const
nsTArray
<
nsCString
>
&
aSiteHosts
)
;
class
PurgeEntryTimeComparator
{
public
:
bool
Equals
(
const
BounceTrackingPurgeEntry
*
a
const
BounceTrackingPurgeEntry
*
b
)
const
{
MOZ_ASSERT
(
a
&
&
b
)
;
return
a
-
>
PurgeTimeRefConst
(
)
=
=
b
-
>
PurgeTimeRefConst
(
)
;
}
bool
LessThan
(
const
BounceTrackingPurgeEntry
*
a
const
BounceTrackingPurgeEntry
*
b
)
const
{
MOZ_ASSERT
(
a
&
&
b
)
;
return
a
-
>
PurgeTimeRefConst
(
)
<
b
-
>
PurgeTimeRefConst
(
)
;
}
}
;
}
;
}
#
endif
