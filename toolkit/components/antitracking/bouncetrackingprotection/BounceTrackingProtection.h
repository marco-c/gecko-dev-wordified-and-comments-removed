#
ifndef
mozilla_BounceTrackingProtection_h__
#
define
mozilla_BounceTrackingProtection_h__
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
nsIBounceTrackingProtection
.
h
"
#
include
"
nsIClearDataService
.
h
"
class
nsIPrincipal
;
class
nsITimer
;
namespace
mozilla
{
class
BounceTrackingState
;
class
BounceTrackingStateGlobal
;
class
BounceTrackingProtectionStorage
;
class
ContentBlockingAllowListCache
;
class
OriginAttributes
;
extern
LazyLogModule
gBounceTrackingProtectionLog
;
class
BounceTrackingProtection
final
:
public
nsIBounceTrackingProtection
{
NS_DECL_ISUPPORTS
NS_DECL_NSIBOUNCETRACKINGPROTECTION
public
:
static
already_AddRefed
<
BounceTrackingProtection
>
GetSingleton
(
)
;
[
[
nodiscard
]
]
nsresult
RecordStatefulBounces
(
BounceTrackingState
*
aBounceTrackingState
)
;
[
[
nodiscard
]
]
nsresult
RecordUserActivation
(
nsIPrincipal
*
aPrincipal
)
;
[
[
nodiscard
]
]
nsresult
ClearExpiredUserInteractions
(
BounceTrackingStateGlobal
*
aStateGlobal
=
nullptr
)
;
private
:
BounceTrackingProtection
(
)
;
~
BounceTrackingProtection
(
)
=
default
;
nsCOMPtr
<
nsITimer
>
mBounceTrackingPurgeTimer
;
RefPtr
<
BounceTrackingProtectionStorage
>
mStorage
;
using
PurgeBounceTrackersMozPromise
=
MozPromise
<
nsTArray
<
nsCString
>
nsresult
true
>
;
RefPtr
<
PurgeBounceTrackersMozPromise
>
PurgeBounceTrackers
(
)
;
using
ClearDataMozPromise
=
MozPromise
<
nsCString
uint32_t
true
>
;
[
[
nodiscard
]
]
nsresult
PurgeBounceTrackersForStateGlobal
(
BounceTrackingStateGlobal
*
aStateGlobal
ContentBlockingAllowListCache
&
aContentBlockingAllowList
nsTArray
<
RefPtr
<
ClearDataMozPromise
>
>
&
aClearPromises
)
;
bool
mPurgeInProgress
=
false
;
class
ClearDataCallback
final
:
public
nsIClearDataCallback
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSICLEARDATACALLBACK
explicit
ClearDataCallback
(
ClearDataMozPromise
:
:
Private
*
aPromise
const
nsACString
&
aHost
const
PRTime
aBounceTime
)
:
mHost
(
aHost
)
mBounceTime
(
aBounceTime
)
mPromise
(
aPromise
)
{
MOZ_ASSERT
(
!
aHost
.
IsEmpty
(
)
"
Host
must
not
be
empty
"
)
;
MOZ_ASSERT
(
aBounceTime
>
0
"
Bounce
time
must
be
a
valid
timestamp
.
"
)
;
}
;
private
:
virtual
~
ClearDataCallback
(
)
{
mPromise
-
>
Reject
(
0
__func__
)
;
}
void
RecordClearDataTelemetry
(
bool
success
)
;
nsCString
mHost
;
PRTime
mBounceTime
;
RefPtr
<
ClearDataMozPromise
:
:
Private
>
mPromise
;
}
;
}
;
}
#
endif
