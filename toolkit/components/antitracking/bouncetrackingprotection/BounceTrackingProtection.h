#
ifndef
mozilla_BounceTrackingProtection_h__
#
define
mozilla_BounceTrackingProtection_h__
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
glean
/
GleanMetrics
.
h
"
#
include
"
nsIBounceTrackingProtection
.
h
"
#
include
"
nsIClearDataService
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
class
nsIPrincipal
;
class
nsITimer
;
namespace
mozilla
{
class
BounceTrackingAllowList
;
class
BounceTrackingState
;
class
BounceTrackingStateGlobal
;
class
BounceTrackingProtectionStorage
;
class
OriginAttributes
;
extern
LazyLogModule
gBounceTrackingProtectionLog
;
class
BounceTrackingProtection
final
:
public
nsIBounceTrackingProtection
{
NS_DECL_ISUPPORTS
NS_DECL_NSIBOUNCETRACKINGPROTECTION
public
:
static
already_AddRefed
<
BounceTrackingProtection
>
GetSingleton
(
)
;
[
[
nodiscard
]
]
nsresult
RecordStatefulBounces
(
BounceTrackingState
*
aBounceTrackingState
)
;
[
[
nodiscard
]
]
nsresult
RecordUserActivation
(
nsIPrincipal
*
aPrincipal
Maybe
<
PRTime
>
aActivationTime
=
Nothing
(
)
)
;
[
[
nodiscard
]
]
nsresult
ClearExpiredUserInteractions
(
BounceTrackingStateGlobal
*
aStateGlobal
=
nullptr
)
;
private
:
BounceTrackingProtection
(
)
;
~
BounceTrackingProtection
(
)
=
default
;
static
Maybe
<
bool
>
sFeatureIsEnabled
;
nsCOMPtr
<
nsITimer
>
mBounceTrackingPurgeTimer
;
RefPtr
<
BounceTrackingProtectionStorage
>
mStorage
;
using
PurgeBounceTrackersMozPromise
=
MozPromise
<
nsTArray
<
nsCString
>
nsresult
true
>
;
RefPtr
<
PurgeBounceTrackersMozPromise
>
PurgeBounceTrackers
(
)
;
using
ClearDataMozPromise
=
MozPromise
<
nsCString
uint32_t
true
>
;
[
[
nodiscard
]
]
nsresult
PurgeBounceTrackersForStateGlobal
(
BounceTrackingStateGlobal
*
aStateGlobal
BounceTrackingAllowList
&
aBounceTrackingAllowList
nsTArray
<
RefPtr
<
ClearDataMozPromise
>
>
&
aClearPromises
)
;
bool
mPurgeInProgress
=
false
;
class
ClearDataCallback
final
:
public
nsIClearDataCallback
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSICLEARDATACALLBACK
explicit
ClearDataCallback
(
ClearDataMozPromise
:
:
Private
*
aPromise
const
nsACString
&
aHost
)
;
private
:
virtual
~
ClearDataCallback
(
)
;
nsCString
mHost
;
void
RecordClearDurationTelemetry
(
)
;
glean
:
:
TimerId
mClearDurationTimer
;
RefPtr
<
ClearDataMozPromise
:
:
Private
>
mPromise
;
}
;
[
[
nodiscard
]
]
nsresult
MaybeMigrateUserInteractionPermissions
(
)
;
}
;
}
#
endif
