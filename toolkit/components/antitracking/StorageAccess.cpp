#
include
"
StorageAccess
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
net
/
CookieJarSettings
.
h
"
#
include
"
mozilla
/
ContentBlocking
.
h
"
#
include
"
mozilla
/
StaticPrefs_browser
.
h
"
#
include
"
mozilla
/
StaticPrefs_network
.
h
"
#
include
"
mozilla
/
StaticPrefs_privacy
.
h
"
#
include
"
mozilla
/
StorageAccess
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsICookiePermission
.
h
"
#
include
"
nsICookieService
.
h
"
#
include
"
nsICookieJarSettings
.
h
"
#
include
"
nsIPermission
.
h
"
#
include
"
nsIWebProgressListener
.
h
"
#
include
"
nsSandboxFlags
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
static
void
GetCookieLifetimePolicyFromCookieJarSettings
(
nsICookieJarSettings
*
aCookieJarSettings
nsIPrincipal
*
aPrincipal
uint32_t
*
aLifetimePolicy
)
{
*
aLifetimePolicy
=
StaticPrefs
:
:
network_cookie_lifetimePolicy
(
)
;
if
(
aCookieJarSettings
)
{
uint32_t
cookiePermission
=
0
;
nsresult
rv
=
aCookieJarSettings
-
>
CookiePermission
(
aPrincipal
&
cookiePermission
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
;
}
switch
(
cookiePermission
)
{
case
nsICookiePermission
:
:
ACCESS_ALLOW
:
*
aLifetimePolicy
=
nsICookieService
:
:
ACCEPT_NORMALLY
;
break
;
case
nsICookiePermission
:
:
ACCESS_DENY
:
*
aLifetimePolicy
=
nsICookieService
:
:
ACCEPT_NORMALLY
;
break
;
case
nsICookiePermission
:
:
ACCESS_SESSION
:
*
aLifetimePolicy
=
nsICookieService
:
:
ACCEPT_SESSION
;
break
;
}
}
}
static
StorageAccess
InternalStorageAllowedCheck
(
nsIPrincipal
*
aPrincipal
nsPIDOMWindowInner
*
aWindow
nsIURI
*
aURI
nsIChannel
*
aChannel
nsICookieJarSettings
*
aCookieJarSettings
uint32_t
&
aRejectedReason
)
{
MOZ_ASSERT
(
aPrincipal
)
;
aRejectedReason
=
0
;
StorageAccess
access
=
StorageAccess
:
:
eAllow
;
if
(
aPrincipal
-
>
GetIsNullPrincipal
(
)
)
{
return
StorageAccess
:
:
eDeny
;
}
nsCOMPtr
<
nsIURI
>
documentURI
;
if
(
aWindow
)
{
Document
*
document
=
aWindow
-
>
GetExtantDoc
(
)
;
if
(
document
&
&
document
-
>
GetSandboxFlags
(
)
&
SANDBOXED_ORIGIN
)
{
return
StorageAccess
:
:
eDeny
;
}
if
(
nsContentUtils
:
:
IsInPrivateBrowsing
(
document
)
)
{
access
=
StorageAccess
:
:
ePrivateBrowsing
;
}
documentURI
=
document
?
document
-
>
GetDocumentURI
(
)
:
nullptr
;
}
uint32_t
lifetimePolicy
;
auto
policy
=
BasePrincipal
:
:
Cast
(
aPrincipal
)
-
>
AddonPolicy
(
)
;
if
(
policy
)
{
lifetimePolicy
=
nsICookieService
:
:
ACCEPT_NORMALLY
;
}
else
{
GetCookieLifetimePolicyFromCookieJarSettings
(
aCookieJarSettings
aPrincipal
&
lifetimePolicy
)
;
}
if
(
lifetimePolicy
=
=
nsICookieService
:
:
ACCEPT_SESSION
)
{
access
=
std
:
:
min
(
StorageAccess
:
:
eSessionScoped
access
)
;
}
if
(
(
aURI
&
&
aURI
-
>
SchemeIs
(
"
about
"
)
)
|
|
(
documentURI
&
&
documentURI
-
>
SchemeIs
(
"
about
"
)
)
|
|
aPrincipal
-
>
SchemeIs
(
"
about
"
)
)
{
return
access
;
}
if
(
!
StorageDisabledByAntiTracking
(
aWindow
aChannel
aPrincipal
aURI
aRejectedReason
)
)
{
return
access
;
}
if
(
aRejectedReason
=
=
static_cast
<
uint32_t
>
(
nsIWebProgressListener
:
:
STATE_COOKIES_BLOCKED_TRACKER
)
|
|
aRejectedReason
=
=
static_cast
<
uint32_t
>
(
nsIWebProgressListener
:
:
STATE_COOKIES_BLOCKED_SOCIALTRACKER
)
)
{
return
StorageAccess
:
:
ePartitionTrackersOrDeny
;
}
if
(
aRejectedReason
=
=
static_cast
<
uint32_t
>
(
nsIWebProgressListener
:
:
STATE_COOKIES_PARTITIONED_FOREIGN
)
)
{
return
StorageAccess
:
:
ePartitionForeignOrDeny
;
}
return
StorageAccess
:
:
eDeny
;
}
static
StorageAccess
InternalStorageAllowedCheckCached
(
nsIPrincipal
*
aPrincipal
nsPIDOMWindowInner
*
aWindow
nsIURI
*
aURI
nsIChannel
*
aChannel
nsICookieJarSettings
*
aCookieJarSettings
uint32_t
&
aRejectedReason
)
{
nsGlobalWindowInner
*
win
=
nullptr
;
if
(
aWindow
)
{
win
=
nsGlobalWindowInner
:
:
Cast
(
aWindow
)
;
Maybe
<
StorageAccess
>
storageAccess
=
win
-
>
GetStorageAllowedCache
(
aRejectedReason
)
;
if
(
storageAccess
.
isSome
(
)
)
{
return
storageAccess
.
value
(
)
;
}
}
StorageAccess
result
=
InternalStorageAllowedCheck
(
aPrincipal
aWindow
aURI
aChannel
aCookieJarSettings
aRejectedReason
)
;
if
(
win
)
{
win
-
>
SetStorageAllowedCache
(
result
aRejectedReason
)
;
}
return
result
;
}
static
bool
StorageDisabledByAntiTrackingInternal
(
nsPIDOMWindowInner
*
aWindow
nsIChannel
*
aChannel
nsIPrincipal
*
aPrincipal
nsIURI
*
aURI
nsICookieJarSettings
*
aCookieJarSettings
uint32_t
&
aRejectedReason
)
{
MOZ_ASSERT
(
aWindow
|
|
aChannel
|
|
aPrincipal
)
;
if
(
aWindow
)
{
nsIURI
*
documentURI
=
aURI
?
aURI
:
aWindow
-
>
GetDocumentURI
(
)
;
return
!
documentURI
|
|
!
ContentBlocking
:
:
ShouldAllowAccessFor
(
aWindow
documentURI
&
aRejectedReason
)
;
}
if
(
aChannel
)
{
nsCOMPtr
<
nsIURI
>
uri
;
nsresult
rv
=
aChannel
-
>
GetURI
(
getter_AddRefs
(
uri
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
false
;
}
return
!
ContentBlocking
:
:
ShouldAllowAccessFor
(
aChannel
uri
&
aRejectedReason
)
;
}
MOZ_ASSERT
(
aPrincipal
)
;
return
!
ContentBlocking
:
:
ShouldAllowAccessFor
(
aPrincipal
aCookieJarSettings
)
;
}
namespace
mozilla
{
StorageAccess
StorageAllowedForWindow
(
nsPIDOMWindowInner
*
aWindow
uint32_t
*
aRejectedReason
)
{
uint32_t
rejectedReason
;
if
(
!
aRejectedReason
)
{
aRejectedReason
=
&
rejectedReason
;
}
*
aRejectedReason
=
0
;
if
(
Document
*
document
=
aWindow
-
>
GetExtantDoc
(
)
)
{
nsCOMPtr
<
nsIPrincipal
>
principal
=
document
-
>
NodePrincipal
(
)
;
nsIChannel
*
channel
=
document
-
>
GetChannel
(
)
;
return
InternalStorageAllowedCheckCached
(
principal
aWindow
nullptr
channel
document
-
>
CookieJarSettings
(
)
*
aRejectedReason
)
;
}
return
StorageAccess
:
:
eDeny
;
}
StorageAccess
StorageAllowedForDocument
(
const
Document
*
aDoc
)
{
MOZ_ASSERT
(
aDoc
)
;
if
(
nsPIDOMWindowInner
*
inner
=
aDoc
-
>
GetInnerWindow
(
)
)
{
nsCOMPtr
<
nsIPrincipal
>
principal
=
aDoc
-
>
NodePrincipal
(
)
;
nsIChannel
*
channel
=
aDoc
-
>
GetChannel
(
)
;
uint32_t
rejectedReason
=
0
;
return
InternalStorageAllowedCheckCached
(
principal
inner
nullptr
channel
const_cast
<
Document
*
>
(
aDoc
)
-
>
CookieJarSettings
(
)
rejectedReason
)
;
}
return
StorageAccess
:
:
eDeny
;
}
StorageAccess
StorageAllowedForNewWindow
(
nsIPrincipal
*
aPrincipal
nsIURI
*
aURI
nsPIDOMWindowInner
*
aParent
)
{
MOZ_ASSERT
(
aPrincipal
)
;
MOZ_ASSERT
(
aURI
)
;
uint32_t
rejectedReason
=
0
;
nsCOMPtr
<
nsICookieJarSettings
>
cjs
;
if
(
aParent
&
&
aParent
-
>
GetExtantDoc
(
)
)
{
cjs
=
aParent
-
>
GetExtantDoc
(
)
-
>
CookieJarSettings
(
)
;
}
else
{
cjs
=
net
:
:
CookieJarSettings
:
:
Create
(
aPrincipal
)
;
}
return
InternalStorageAllowedCheck
(
aPrincipal
aParent
aURI
nullptr
cjs
rejectedReason
)
;
}
StorageAccess
StorageAllowedForChannel
(
nsIChannel
*
aChannel
)
{
MOZ_DIAGNOSTIC_ASSERT
(
nsContentUtils
:
:
GetSecurityManager
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aChannel
)
;
nsCOMPtr
<
nsIPrincipal
>
principal
;
Unused
<
<
nsContentUtils
:
:
GetSecurityManager
(
)
-
>
GetChannelResultPrincipal
(
aChannel
getter_AddRefs
(
principal
)
)
;
NS_ENSURE_TRUE
(
principal
StorageAccess
:
:
eDeny
)
;
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aChannel
-
>
LoadInfo
(
)
;
nsCOMPtr
<
nsICookieJarSettings
>
cookieJarSettings
;
nsresult
rv
=
loadInfo
-
>
GetCookieJarSettings
(
getter_AddRefs
(
cookieJarSettings
)
)
;
NS_ENSURE_SUCCESS
(
rv
StorageAccess
:
:
eDeny
)
;
uint32_t
rejectedReason
=
0
;
StorageAccess
result
=
InternalStorageAllowedCheck
(
principal
nullptr
nullptr
aChannel
cookieJarSettings
rejectedReason
)
;
return
result
;
}
StorageAccess
StorageAllowedForServiceWorker
(
nsIPrincipal
*
aPrincipal
nsICookieJarSettings
*
aCookieJarSettings
)
{
uint32_t
rejectedReason
=
0
;
return
InternalStorageAllowedCheck
(
aPrincipal
nullptr
nullptr
nullptr
aCookieJarSettings
rejectedReason
)
;
}
bool
StorageDisabledByAntiTracking
(
nsPIDOMWindowInner
*
aWindow
nsIChannel
*
aChannel
nsIPrincipal
*
aPrincipal
nsIURI
*
aURI
uint32_t
&
aRejectedReason
)
{
MOZ_ASSERT
(
aWindow
|
|
aChannel
|
|
aPrincipal
)
;
nsCOMPtr
<
nsICookieJarSettings
>
cookieJarSettings
;
if
(
aWindow
)
{
if
(
aWindow
-
>
GetExtantDoc
(
)
)
{
cookieJarSettings
=
aWindow
-
>
GetExtantDoc
(
)
-
>
CookieJarSettings
(
)
;
}
}
else
if
(
aChannel
)
{
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aChannel
-
>
LoadInfo
(
)
;
Unused
<
<
loadInfo
-
>
GetCookieJarSettings
(
getter_AddRefs
(
cookieJarSettings
)
)
;
}
if
(
!
cookieJarSettings
)
{
cookieJarSettings
=
net
:
:
CookieJarSettings
:
:
Create
(
aPrincipal
)
;
}
bool
disabled
=
StorageDisabledByAntiTrackingInternal
(
aWindow
aChannel
aPrincipal
aURI
cookieJarSettings
aRejectedReason
)
;
if
(
aWindow
)
{
ContentBlockingNotifier
:
:
OnDecision
(
aWindow
disabled
?
ContentBlockingNotifier
:
:
BlockingDecision
:
:
eBlock
:
ContentBlockingNotifier
:
:
BlockingDecision
:
:
eAllow
aRejectedReason
)
;
}
else
if
(
aChannel
)
{
ContentBlockingNotifier
:
:
OnDecision
(
aChannel
disabled
?
ContentBlockingNotifier
:
:
BlockingDecision
:
:
eBlock
:
ContentBlockingNotifier
:
:
BlockingDecision
:
:
eAllow
aRejectedReason
)
;
}
return
disabled
;
}
bool
StorageDisabledByAntiTracking
(
dom
:
:
Document
*
aDocument
nsIURI
*
aURI
uint32_t
&
aRejectedReason
)
{
aRejectedReason
=
0
;
return
StorageDisabledByAntiTracking
(
aDocument
-
>
GetInnerWindow
(
)
aDocument
-
>
GetChannel
(
)
aDocument
-
>
NodePrincipal
(
)
aURI
aRejectedReason
)
;
}
RefPtr
<
AsyncStorageDisabledByAntiTrackingPromise
>
AsyncStorageDisabledByAntiTracking
(
dom
:
:
BrowsingContext
*
aContext
nsIPrincipal
*
aPrincipal
)
{
MOZ_ASSERT
(
aContext
)
;
MOZ_ASSERT
(
aPrincipal
)
;
return
ContentBlocking
:
:
AsyncShouldAllowAccessFor
(
aContext
aPrincipal
)
-
>
Then
(
GetCurrentSerialEventTarget
(
)
__func__
[
]
(
const
ContentBlocking
:
:
AsyncShouldAllowAccessForPromise
:
:
ResolveOrRejectValue
&
&
aValue
)
{
if
(
aValue
.
IsResolve
(
)
)
{
return
AsyncStorageDisabledByAntiTrackingPromise
:
:
CreateAndReject
(
aValue
.
ResolveValue
(
)
__func__
)
;
}
return
AsyncStorageDisabledByAntiTrackingPromise
:
:
CreateAndResolve
(
aValue
.
RejectValue
(
)
__func__
)
;
}
)
;
}
bool
ShouldPartitionStorage
(
StorageAccess
aAccess
)
{
return
aAccess
=
=
StorageAccess
:
:
ePartitionTrackersOrDeny
|
|
aAccess
=
=
StorageAccess
:
:
ePartitionForeignOrDeny
;
}
bool
ShouldPartitionStorage
(
uint32_t
aRejectedReason
)
{
return
aRejectedReason
=
=
static_cast
<
uint32_t
>
(
nsIWebProgressListener
:
:
STATE_COOKIES_BLOCKED_TRACKER
)
|
|
aRejectedReason
=
=
static_cast
<
uint32_t
>
(
nsIWebProgressListener
:
:
STATE_COOKIES_BLOCKED_SOCIALTRACKER
)
|
|
aRejectedReason
=
=
static_cast
<
uint32_t
>
(
nsIWebProgressListener
:
:
STATE_COOKIES_PARTITIONED_FOREIGN
)
;
}
bool
StoragePartitioningEnabled
(
StorageAccess
aAccess
nsICookieJarSettings
*
aCookieJarSettings
)
{
return
aAccess
=
=
StorageAccess
:
:
ePartitionForeignOrDeny
&
&
aCookieJarSettings
-
>
GetCookieBehavior
(
)
=
=
nsICookieService
:
:
BEHAVIOR_REJECT_TRACKER_AND_PARTITION_FOREIGN
;
}
bool
StoragePartitioningEnabled
(
uint32_t
aRejectedReason
nsICookieJarSettings
*
aCookieJarSettings
)
{
return
aRejectedReason
=
=
static_cast
<
uint32_t
>
(
nsIWebProgressListener
:
:
STATE_COOKIES_PARTITIONED_FOREIGN
)
&
&
aCookieJarSettings
-
>
GetCookieBehavior
(
)
=
=
nsICookieService
:
:
BEHAVIOR_REJECT_TRACKER_AND_PARTITION_FOREIGN
;
}
}
