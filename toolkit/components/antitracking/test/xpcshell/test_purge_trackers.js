const
TRACKING_PAGE
=
"
https
:
/
/
tracking
.
example
.
org
"
;
const
BENIGN_PAGE
=
"
https
:
/
/
example
.
com
"
;
const
HTTP_TRACKING_PAGE
=
"
http
:
/
/
tracking
.
example
.
org
"
;
const
{
UrlClassifierTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
UrlClassifierTestUtils
.
jsm
"
)
;
const
{
SiteDataTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
SiteDataTestUtils
.
jsm
"
)
;
const
{
PermissionTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
PermissionTestUtils
.
jsm
"
)
;
const
{
setTimeout
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
PurgeTrackerService
"
"
mozilla
.
org
/
purge
-
tracker
-
service
;
1
"
"
nsIPurgeTrackerService
"
)
;
add_task
(
async
function
setup
(
)
{
Services
.
prefs
.
setIntPref
(
"
network
.
cookie
.
cookieBehavior
"
Ci
.
nsICookieService
.
BEHAVIOR_REJECT_TRACKER
)
;
Services
.
prefs
.
setBoolPref
(
"
privacy
.
purge_trackers
.
enabled
"
true
)
;
Services
.
prefs
.
setCharPref
(
"
privacy
.
purge_trackers
.
logging
.
level
"
"
Debug
"
)
;
Services
.
prefs
.
setStringPref
(
"
urlclassifier
.
trackingAnnotationTable
.
testEntries
"
"
tracking
.
example
.
org
"
)
;
Services
.
prefs
.
setBoolPref
(
"
dom
.
storage
.
client_validation
"
false
)
;
}
)
;
add_task
(
async
function
(
)
{
await
UrlClassifierTestUtils
.
addTestTrackers
(
)
;
PermissionTestUtils
.
add
(
TRACKING_PAGE
"
storageAccessAPI
"
Services
.
perms
.
ALLOW_ACTION
)
;
SiteDataTestUtils
.
addToLocalStorage
(
TRACKING_PAGE
)
;
SiteDataTestUtils
.
addToCookies
(
BENIGN_PAGE
)
;
SiteDataTestUtils
.
addToCookies
(
TRACKING_PAGE
)
;
await
SiteDataTestUtils
.
addToIndexedDB
(
TRACKING_PAGE
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
ok
(
SiteDataTestUtils
.
hasCookies
(
TRACKING_PAGE
)
"
cookie
remains
while
storage
access
permission
exists
.
"
)
;
ok
(
SiteDataTestUtils
.
hasLocalStorage
(
TRACKING_PAGE
)
"
localStorage
should
not
have
been
removed
while
storage
access
permission
exists
.
"
)
;
Assert
.
greater
(
await
SiteDataTestUtils
.
getQuotaUsage
(
TRACKING_PAGE
)
0
We
have
data
for
{
TRACKING_PAGE
}
)
;
PermissionTestUtils
.
remove
(
TRACKING_PAGE
"
storageAccessAPI
"
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
ok
(
SiteDataTestUtils
.
hasCookies
(
BENIGN_PAGE
)
"
A
non
-
tracking
page
should
retain
cookies
after
purging
"
)
;
ok
(
!
SiteDataTestUtils
.
hasCookies
(
TRACKING_PAGE
)
"
cookie
is
removed
after
purge
with
no
storage
access
permission
.
"
)
;
ok
(
!
SiteDataTestUtils
.
hasLocalStorage
(
TRACKING_PAGE
)
"
localStorage
should
have
been
removed
"
)
;
Assert
.
equal
(
await
SiteDataTestUtils
.
getQuotaUsage
(
TRACKING_PAGE
)
0
"
quota
storage
was
deleted
"
)
;
UrlClassifierTestUtils
.
cleanupTestTrackers
(
)
;
}
)
;
add_task
(
async
function
(
)
{
await
UrlClassifierTestUtils
.
addTestTrackers
(
)
;
let
associatedOrigins
=
[
"
https
:
/
/
itisatracker
.
org
"
"
https
:
/
/
sub
.
itisatracker
.
org
"
"
https
:
/
/
www
.
itisatracker
.
org
"
"
https
:
/
/
sub
.
sub
.
sub
.
itisatracker
.
org
"
"
http
:
/
/
itisatracker
.
org
"
"
http
:
/
/
sub
.
itisatracker
.
org
"
]
;
for
(
let
permissionOrigin
of
associatedOrigins
)
{
PermissionTestUtils
.
add
(
permissionOrigin
"
storageAccessAPI
"
Services
.
perms
.
ALLOW_ACTION
)
;
for
(
let
origin
of
associatedOrigins
)
{
SiteDataTestUtils
.
addToCookies
(
origin
)
;
}
SiteDataTestUtils
.
addToCookies
(
TRACKING_PAGE
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
for
(
let
origin
of
associatedOrigins
)
{
ok
(
SiteDataTestUtils
.
hasCookies
(
origin
)
{
origin
}
should
have
retained
its
cookies
when
permission
is
set
for
{
permissionOrigin
}
.
)
;
}
ok
(
!
SiteDataTestUtils
.
hasCookies
(
TRACKING_PAGE
)
"
cookie
is
removed
after
purge
with
no
storage
access
permission
.
"
)
;
PermissionTestUtils
.
remove
(
permissionOrigin
"
storageAccessAPI
"
)
;
await
SiteDataTestUtils
.
clear
(
)
;
}
UrlClassifierTestUtils
.
cleanupTestTrackers
(
)
;
}
)
;
add_task
(
async
function
(
)
{
Services
.
prefs
.
setBoolPref
(
"
privacy
.
purge_trackers
.
consider_entity_list
"
true
)
;
Services
.
prefs
.
setCharPref
(
"
urlclassifier
.
trackingAnnotationTable
.
testEntries
"
"
example
.
org
"
)
;
await
UrlClassifierTestUtils
.
addTestTrackers
(
)
;
const
OWNER_PAGE
=
"
https
:
/
/
itisatrap
.
org
"
;
const
RESOURCE_PAGE
=
"
https
:
/
/
example
.
org
"
;
PermissionTestUtils
.
add
(
OWNER_PAGE
"
storageAccessAPI
"
Services
.
perms
.
ALLOW_ACTION
)
;
SiteDataTestUtils
.
addToCookies
(
RESOURCE_PAGE
)
;
SiteDataTestUtils
.
addToCookies
(
"
https
:
/
/
another
-
tracking
.
example
.
net
"
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
ok
(
SiteDataTestUtils
.
hasCookies
(
RESOURCE_PAGE
)
{
RESOURCE_PAGE
}
should
have
retained
its
cookies
when
permission
is
set
for
{
OWNER_PAGE
}
.
)
;
ok
(
!
SiteDataTestUtils
.
hasCookies
(
"
https
:
/
/
another
-
tracking
.
example
.
net
"
)
"
cookie
is
removed
after
purge
with
no
storage
access
permission
.
"
)
;
Services
.
prefs
.
setBoolPref
(
"
privacy
.
purge_trackers
.
consider_entity_list
"
false
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
ok
(
!
SiteDataTestUtils
.
hasCookies
(
RESOURCE_PAGE
)
{
RESOURCE_PAGE
}
should
not
have
retained
its
cookies
when
permission
is
set
for
{
OWNER_PAGE
}
and
the
entity
list
pref
is
off
.
)
;
PermissionTestUtils
.
remove
(
OWNER_PAGE
"
storageAccessAPI
"
)
;
await
SiteDataTestUtils
.
clear
(
)
;
Services
.
prefs
.
clearUserPref
(
"
privacy
.
purge_trackers
.
consider_entity_list
"
)
;
UrlClassifierTestUtils
.
cleanupTestTrackers
(
)
;
}
)
;
add_task
(
async
function
(
)
{
await
UrlClassifierTestUtils
.
addTestTrackers
(
)
;
let
testCases
=
[
{
localStorage
:
true
indexedDB
:
true
}
{
localStorage
:
false
indexedDB
:
true
}
{
localStorage
:
true
indexedDB
:
false
}
]
;
for
(
let
{
localStorage
indexedDB
}
of
testCases
)
{
PermissionTestUtils
.
add
(
TRACKING_PAGE
"
storageAccessAPI
"
Services
.
perms
.
ALLOW_ACTION
)
;
if
(
localStorage
)
{
SiteDataTestUtils
.
addToLocalStorage
(
TRACKING_PAGE
)
;
SiteDataTestUtils
.
addToLocalStorage
(
BENIGN_PAGE
)
;
}
if
(
indexedDB
)
{
await
SiteDataTestUtils
.
addToIndexedDB
(
TRACKING_PAGE
)
;
await
SiteDataTestUtils
.
addToIndexedDB
(
BENIGN_PAGE
)
;
}
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
if
(
localStorage
)
{
ok
(
SiteDataTestUtils
.
hasLocalStorage
(
TRACKING_PAGE
)
"
localStorage
should
not
have
been
removed
while
storage
access
permission
exists
.
"
)
;
}
if
(
indexedDB
)
{
Assert
.
greater
(
await
SiteDataTestUtils
.
getQuotaUsage
(
TRACKING_PAGE
)
0
We
have
data
for
{
TRACKING_PAGE
}
)
;
}
PermissionTestUtils
.
remove
(
TRACKING_PAGE
"
storageAccessAPI
"
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
if
(
localStorage
)
{
ok
(
SiteDataTestUtils
.
hasLocalStorage
(
BENIGN_PAGE
)
"
localStorage
should
not
have
been
removed
for
benign
page
.
"
)
;
ok
(
!
SiteDataTestUtils
.
hasLocalStorage
(
TRACKING_PAGE
)
"
localStorage
should
have
been
removed
.
"
)
;
}
if
(
indexedDB
)
{
Assert
.
greater
(
await
SiteDataTestUtils
.
getQuotaUsage
(
BENIGN_PAGE
)
0
"
quota
storage
for
benign
page
was
not
deleted
"
)
;
Assert
.
equal
(
await
SiteDataTestUtils
.
getQuotaUsage
(
TRACKING_PAGE
)
0
"
quota
storage
was
deleted
"
)
;
}
await
SiteDataTestUtils
.
clear
(
)
;
}
UrlClassifierTestUtils
.
cleanupTestTrackers
(
)
;
}
)
;
add_task
(
async
function
(
)
{
await
UrlClassifierTestUtils
.
addTestTrackers
(
)
;
PermissionTestUtils
.
add
(
TRACKING_PAGE
"
storageAccessAPI
"
Services
.
perms
.
ALLOW_ACTION
Services
.
perms
.
EXPIRE_TIME
Date
.
now
(
)
+
500
)
;
SiteDataTestUtils
.
addToLocalStorage
(
TRACKING_PAGE
)
;
SiteDataTestUtils
.
addToCookies
(
TRACKING_PAGE
)
;
await
SiteDataTestUtils
.
addToIndexedDB
(
TRACKING_PAGE
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
ok
(
SiteDataTestUtils
.
hasCookies
(
TRACKING_PAGE
)
"
cookie
remains
while
storage
access
permission
exists
.
"
)
;
ok
(
SiteDataTestUtils
.
hasLocalStorage
(
TRACKING_PAGE
)
"
localStorage
should
not
have
been
removed
while
storage
access
permission
exists
.
"
)
;
Assert
.
greater
(
await
SiteDataTestUtils
.
getQuotaUsage
(
TRACKING_PAGE
)
0
We
have
data
for
{
TRACKING_PAGE
}
)
;
await
new
Promise
(
c
=
>
setTimeout
(
c
500
)
)
;
await
PurgeTrackerService
.
purgeTrackingCookieJars
(
)
;
ok
(
!
SiteDataTestUtils
.
hasCookies
(
TRACKING_PAGE
)
"
cookie
is
removed
after
purge
with
no
storage
access
permission
.
"
)
;
ok
(
!
SiteDataTestUtils
.
hasLocalStorage
(
TRACKING_PAGE
)
"
localStorage
should
not
have
been
removed
while
storage
access
permission
exists
.
"
)
;
Assert
.
equal
(
await
SiteDataTestUtils
.
getQuotaUsage
(
TRACKING_PAGE
)
0
"
quota
storage
was
deleted
"
)
;
UrlClassifierTestUtils
.
cleanupTestTrackers
(
)
;
}
)
;
