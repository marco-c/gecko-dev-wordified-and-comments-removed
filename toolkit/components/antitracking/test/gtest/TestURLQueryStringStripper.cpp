#
include
"
gtest
/
gtest
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
SpinEventLoopUntil
.
h
"
#
include
"
mozilla
/
URLQueryStringStripper
.
h
"
using
namespace
mozilla
;
static
const
char
kPrefQueryStrippingEnabled
[
]
=
"
privacy
.
query_stripping
.
enabled
"
;
static
const
char
kPrefQueryStrippingEnabledPBM
[
]
=
"
privacy
.
query_stripping
.
enabled
.
pbmode
"
;
static
const
char
kPrefQueryStrippingList
[
]
=
"
privacy
.
query_stripping
.
strip_list
"
;
void
DoTest
(
const
nsACString
&
aTestURL
const
bool
aIsPBM
const
nsACString
&
aExpectedURL
bool
aExpectedResult
)
{
nsCOMPtr
<
nsIURI
>
testURI
;
NS_NewURI
(
getter_AddRefs
(
testURI
)
aTestURL
)
;
bool
result
;
nsCOMPtr
<
nsIURI
>
strippedURI
;
result
=
URLQueryStringStripper
:
:
Strip
(
testURI
aIsPBM
strippedURI
)
;
EXPECT_TRUE
(
result
=
=
aExpectedResult
)
;
if
(
!
result
)
{
EXPECT_TRUE
(
!
strippedURI
)
;
}
else
{
EXPECT_TRUE
(
strippedURI
-
>
GetSpecOrDefault
(
)
.
Equals
(
aExpectedURL
)
)
;
}
}
class
StripListObserver
final
:
public
nsIURLQueryStrippingListObserver
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIURLQUERYSTRIPPINGLISTOBSERVER
bool
IsStillWaiting
(
)
{
return
mWaitingObserver
;
}
void
StartWaitingObserver
(
)
{
mWaitingObserver
=
true
;
}
StripListObserver
(
)
:
mWaitingObserver
(
false
)
{
mService
=
do_GetService
(
"
mozilla
.
org
/
query
-
stripping
-
list
-
service
;
1
"
)
;
mService
-
>
RegisterAndRunObserver
(
this
)
;
}
private
:
~
StripListObserver
(
)
{
mService
-
>
UnregisterObserver
(
this
)
;
mService
=
nullptr
;
}
bool
mWaitingObserver
;
nsCOMPtr
<
nsIURLQueryStrippingListService
>
mService
;
}
;
NS_IMPL_ISUPPORTS
(
StripListObserver
nsIURLQueryStrippingListObserver
)
NS_IMETHODIMP
StripListObserver
:
:
OnQueryStrippingListUpdate
(
const
nsAString
&
aStripList
const
nsACString
&
aAllowList
)
{
mWaitingObserver
=
false
;
return
NS_OK
;
}
TEST
(
TestURLQueryStringStripper
TestPrefDisabled
)
{
Preferences
:
:
SetCString
(
kPrefQueryStrippingList
"
fooBar
foobaz
"
)
;
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabled
false
)
;
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabledPBM
false
)
;
for
(
bool
isPBM
:
{
false
true
}
)
{
DoTest
(
"
https
:
/
/
example
.
com
/
"
_ns
isPBM
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
Barfoo
=
123
"
_ns
isPBM
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
&
foobaz
"
_ns
isPBM
"
"
_ns
false
)
;
}
}
TEST
(
TestURLQueryStringStripper
TestEmptyStripList
)
{
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabled
true
)
;
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabledPBM
true
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
"
_ns
false
"
"
_ns
false
)
;
RefPtr
<
StripListObserver
>
observer
=
new
StripListObserver
(
)
;
observer
-
>
StartWaitingObserver
(
)
;
Preferences
:
:
SetCString
(
kPrefQueryStrippingList
"
"
)
;
MOZ_ALWAYS_TRUE
(
mozilla
:
:
SpinEventLoopUntil
(
"
TEST
(
TestURLQueryStringStripper
TestEmptyStripList
)
"
_ns
[
&
]
(
)
-
>
bool
{
return
!
observer
-
>
IsStillWaiting
(
)
;
}
)
)
;
for
(
bool
isPBM
:
{
false
true
}
)
{
DoTest
(
"
https
:
/
/
example
.
com
/
"
_ns
isPBM
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
Barfoo
=
123
"
_ns
isPBM
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
&
foobaz
"
_ns
isPBM
"
"
_ns
false
)
;
}
}
TEST
(
TestURLQueryStringStripper
TestStripping
)
{
DoTest
(
"
https
:
/
/
example
.
com
/
"
_ns
false
"
"
_ns
false
)
;
RefPtr
<
StripListObserver
>
observer
=
new
StripListObserver
(
)
;
observer
-
>
StartWaitingObserver
(
)
;
Preferences
:
:
SetCString
(
kPrefQueryStrippingList
"
fooBar
foobaz
"
)
;
MOZ_ALWAYS_TRUE
(
mozilla
:
:
SpinEventLoopUntil
(
"
TEST
(
TestURLQueryStringStripper
TestStripping
)
"
_ns
[
&
]
(
)
-
>
bool
{
return
!
observer
-
>
IsStillWaiting
(
)
;
}
)
)
;
for
(
bool
pref
:
{
false
true
}
)
{
for
(
bool
prefPBM
:
{
false
true
}
)
{
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabled
pref
)
;
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabledPBM
prefPBM
)
;
for
(
bool
isPBM
:
{
false
true
}
)
{
bool
expectStrip
=
(
prefPBM
&
&
isPBM
)
|
|
(
pref
&
&
!
isPBM
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
"
_ns
isPBM
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
Barfoo
=
123
"
_ns
isPBM
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
"
_ns
isPBM
"
https
:
/
/
example
.
com
/
"
_ns
expectStrip
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
&
foobaz
"
_ns
isPBM
"
https
:
/
/
example
.
com
/
"
_ns
expectStrip
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
&
Barfoo
=
456
&
foobaz
"
_ns
isPBM
"
https
:
/
/
example
.
com
/
?
Barfoo
=
456
"
_ns
expectStrip
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
FOOBAR
=
123
"
_ns
isPBM
"
https
:
/
/
example
.
com
/
"
_ns
expectStrip
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
barfoo
=
foobar
"
_ns
isPBM
"
https
:
/
/
example
.
com
/
?
barfoo
=
foobar
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
foobar
=
123
&
nostrip
=
456
&
FooBar
=
789
"
_ns
isPBM
"
https
:
/
/
example
.
com
/
?
nostrip
=
456
"
_ns
expectStrip
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
AfoobazB
=
123
"
_ns
isPBM
"
https
:
/
/
example
.
com
/
?
AfoobazB
=
123
"
_ns
false
)
;
}
}
}
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabled
true
)
;
Preferences
:
:
SetBool
(
kPrefQueryStrippingEnabledPBM
false
)
;
observer
-
>
StartWaitingObserver
(
)
;
Preferences
:
:
SetCString
(
kPrefQueryStrippingList
"
Barfoo
bazfoo
"
)
;
MOZ_ALWAYS_TRUE
(
mozilla
:
:
SpinEventLoopUntil
(
"
TEST
(
TestURLQueryStringStripper
TestStripping
)
"
_ns
[
&
]
(
)
-
>
bool
{
return
!
observer
-
>
IsStillWaiting
(
)
;
}
)
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
"
_ns
false
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
&
foobaz
"
_ns
false
"
"
_ns
false
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
bazfoo
=
123
"
_ns
false
"
https
:
/
/
example
.
com
/
"
_ns
true
)
;
DoTest
(
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
&
Barfoo
=
456
&
foobaz
=
abc
"
_ns
false
"
https
:
/
/
example
.
com
/
?
fooBar
=
123
&
foobaz
=
abc
"
_ns
true
)
;
}
