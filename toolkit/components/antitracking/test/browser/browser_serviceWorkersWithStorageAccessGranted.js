add_task
(
async
_
=
>
{
PermissionTestUtils
.
add
(
TEST_DOMAIN
"
3rdPartyStorage
^
https
:
/
/
tracking
.
example
.
org
"
Services
.
perms
.
ALLOW_ACTION
)
;
registerCleanupFunction
(
_
=
>
{
Services
.
perms
.
removeAll
(
)
;
}
)
;
AntiTracking
.
_createTask
(
{
name
:
"
Test
that
we
can
use
service
worker
if
we
have
the
storage
access
permission
"
cookieBehavior
:
BEHAVIOR_REJECT_TRACKER
allowList
:
false
callback
:
async
_
=
>
{
await
navigator
.
serviceWorker
.
register
(
"
empty
.
js
"
)
.
then
(
_
=
>
{
ok
(
true
"
ServiceWorker
can
be
used
!
"
)
;
}
_
=
>
{
ok
(
false
"
ServiceWorker
can
be
used
!
"
)
;
}
)
.
catch
(
e
=
>
ok
(
false
"
Promise
rejected
:
"
+
e
)
)
;
}
extraPrefs
:
[
[
"
dom
.
serviceWorkers
.
exemptFromPerDomainMax
"
true
]
[
"
dom
.
serviceWorkers
.
enabled
"
true
]
[
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
]
]
expectedBlockingNotifications
:
0
runInPrivateWindow
:
false
iframeSandbox
:
null
accessRemoval
:
null
callbackAfterRemoval
:
null
}
)
;
AntiTracking
.
_createTask
(
{
name
:
"
Test
again
to
check
if
we
can
still
use
service
worker
without
hit
the
assertion
.
"
cookieBehavior
:
BEHAVIOR_REJECT_TRACKER
allowList
:
false
callback
:
async
_
=
>
{
await
navigator
.
serviceWorker
.
register
(
"
empty
.
js
"
)
.
then
(
_
=
>
{
ok
(
true
"
ServiceWorker
can
be
used
!
"
)
;
}
_
=
>
{
ok
(
false
"
ServiceWorker
can
be
used
!
"
)
;
}
)
.
catch
(
e
=
>
ok
(
false
"
Promise
rejected
:
"
+
e
)
)
;
}
extraPrefs
:
[
[
"
dom
.
serviceWorkers
.
exemptFromPerDomainMax
"
true
]
[
"
dom
.
serviceWorkers
.
enabled
"
true
]
[
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
]
]
expectedBlockingNotifications
:
0
runInPrivateWindow
:
false
iframeSandbox
:
null
accessRemoval
:
null
callbackAfterRemoval
:
null
}
)
;
AntiTracking
.
_createTask
(
{
name
:
"
Test
again
to
check
if
we
cannot
use
service
worker
in
a
sandbox
iframe
without
hit
the
assertion
.
"
cookieBehavior
:
BEHAVIOR_REJECT_TRACKER
allowList
:
false
callback
:
async
_
=
>
{
await
navigator
.
serviceWorker
.
register
(
"
empty
.
js
"
)
.
then
(
_
=
>
{
ok
(
false
"
ServiceWorker
cannot
be
used
in
sandbox
iframe
!
"
)
;
}
_
=
>
{
ok
(
true
"
ServiceWorker
cannot
be
used
in
sandbox
iframe
!
"
)
;
}
)
.
catch
(
e
=
>
ok
(
false
"
Promise
rejected
:
"
+
e
)
)
;
}
extraPrefs
:
[
[
"
dom
.
serviceWorkers
.
exemptFromPerDomainMax
"
true
]
[
"
dom
.
serviceWorkers
.
enabled
"
true
]
[
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
]
]
expectedBlockingNotifications
:
0
runInPrivateWindow
:
false
iframeSandbox
:
"
allow
-
scripts
allow
-
same
-
origin
"
accessRemoval
:
null
callbackAfterRemoval
:
null
}
)
;
const
NESTED_THIRD_PARTY_PAGE
=
TEST_DOMAIN
+
TEST_PATH
+
"
3rdPartyRelay
.
html
?
"
+
TEST_3RD_PARTY_PAGE
;
AntiTracking
.
_createTask
(
{
name
:
"
Test
again
to
check
if
we
cannot
use
service
worker
in
a
nested
iframe
without
hit
the
assertion
.
"
cookieBehavior
:
BEHAVIOR_REJECT_TRACKER
allowList
:
false
callback
:
async
_
=
>
{
await
navigator
.
serviceWorker
.
register
(
"
empty
.
js
"
)
.
then
(
_
=
>
{
ok
(
false
"
ServiceWorker
cannot
be
used
in
nested
iframe
!
"
)
;
}
_
=
>
{
ok
(
true
"
ServiceWorker
cannot
be
used
in
nested
iframe
!
"
)
;
}
)
.
catch
(
e
=
>
ok
(
false
"
Promise
rejected
:
"
+
e
)
)
;
}
extraPrefs
:
[
[
"
dom
.
serviceWorkers
.
exemptFromPerDomainMax
"
true
]
[
"
dom
.
serviceWorkers
.
enabled
"
true
]
[
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
]
]
expectedBlockingNotifications
:
Ci
.
nsIWebProgressListener
.
STATE_COOKIES_BLOCKED_TRACKER
dontResetExpectedBlockingNotifications
:
true
runInPrivateWindow
:
false
iframeSandbox
:
null
accessRemoval
:
null
callbackAfterRemoval
:
null
thirdPartyPage
:
NESTED_THIRD_PARTY_PAGE
}
)
;
}
)
;
