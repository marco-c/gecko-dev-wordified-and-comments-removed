ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
let
counter
=
0
;
AntiTracking
.
runTest
(
"
Storage
Access
API
called
in
a
sandboxed
iframe
"
async
_
=
>
{
let
[
threw
rejected
]
=
await
callRequestStorageAccess
(
)
;
ok
(
!
threw
"
requestStorageAccess
should
not
throw
"
)
;
ok
(
rejected
"
requestStorageAccess
shouldn
'
t
be
available
"
)
;
}
null
async
_
=
>
{
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteDataFromHost
(
Services
.
io
.
newURI
(
TEST_3RD_PARTY_DOMAIN
)
.
host
true
Ci
.
nsIClearDataService
.
CLEAR_PERMISSIONS
value
=
>
resolve
(
)
)
;
}
)
;
}
[
[
"
dom
.
storage_access
.
enabled
"
true
]
]
false
false
0
false
"
allow
-
scripts
allow
-
same
-
origin
allow
-
popups
"
)
;
AntiTracking
.
runTest
(
"
Storage
Access
API
called
in
a
sandboxed
iframe
with
"
+
"
allow
-
storage
-
access
-
by
-
user
-
activation
"
async
_
=
>
{
let
[
threw
rejected
]
=
await
callRequestStorageAccess
(
)
;
ok
(
!
threw
"
requestStorageAccess
should
not
throw
"
)
;
ok
(
!
rejected
"
requestStorageAccess
should
be
available
"
)
;
}
null
async
_
=
>
{
if
(
+
+
counter
%
2
=
=
0
)
{
return
;
}
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
value
=
>
resolve
(
)
)
;
}
)
;
}
[
[
"
dom
.
storage_access
.
enabled
"
true
]
]
false
false
Ci
.
nsIWebProgressListener
.
STATE_COOKIES_BLOCKED_TRACKER
false
"
allow
-
scripts
allow
-
same
-
origin
allow
-
popups
allow
-
storage
-
access
-
by
-
user
-
activation
"
)
;
AntiTracking
.
runTest
(
"
Verify
that
sandboxed
contexts
don
'
t
get
the
saved
permission
"
async
_
=
>
{
await
noStorageAccessInitially
(
)
;
try
{
localStorage
.
foo
=
42
;
ok
(
false
"
LocalStorage
cannot
be
used
!
"
)
;
}
catch
(
e
)
{
ok
(
true
"
LocalStorage
cannot
be
used
!
"
)
;
is
(
e
.
name
"
SecurityError
"
"
We
want
a
security
error
message
.
"
)
;
}
}
null
null
[
[
"
dom
.
storage_access
.
enabled
"
true
]
]
false
false
false
false
"
allow
-
scripts
allow
-
same
-
origin
allow
-
popups
"
)
;
AntiTracking
.
runTest
(
"
Verify
that
sandboxed
contexts
with
"
+
"
allow
-
storage
-
access
-
by
-
user
-
activation
get
the
"
+
"
saved
permission
"
async
_
=
>
{
await
hasStorageAccessInitially
(
)
;
localStorage
.
foo
=
42
;
ok
(
true
"
LocalStorage
can
be
used
!
"
)
;
}
null
null
[
[
"
dom
.
storage_access
.
enabled
"
true
]
]
false
false
false
false
"
allow
-
scripts
allow
-
same
-
origin
allow
-
popups
allow
-
storage
-
access
-
by
-
user
-
activation
"
)
;
AntiTracking
.
runTest
(
"
Verify
that
private
browsing
contexts
don
'
t
get
the
saved
permission
"
async
_
=
>
{
await
noStorageAccessInitially
(
)
;
try
{
localStorage
.
foo
=
42
;
ok
(
false
"
LocalStorage
cannot
be
used
!
"
)
;
}
catch
(
e
)
{
ok
(
true
"
LocalStorage
cannot
be
used
!
"
)
;
is
(
e
.
name
"
SecurityError
"
"
We
want
a
security
error
message
.
"
)
;
}
}
null
null
[
[
"
dom
.
storage_access
.
enabled
"
true
]
]
false
false
0
true
null
)
;
AntiTracking
.
runTest
(
"
Verify
that
non
-
sandboxed
contexts
get
the
"
+
"
saved
permission
"
async
_
=
>
{
await
hasStorageAccessInitially
(
)
;
localStorage
.
foo
=
42
;
ok
(
true
"
LocalStorage
can
be
used
!
"
)
;
}
null
async
_
=
>
{
if
(
+
+
counter
%
2
=
=
1
)
{
return
;
}
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
value
=
>
resolve
(
)
)
;
}
)
;
}
[
[
"
dom
.
storage_access
.
enabled
"
true
]
]
false
false
0
)
;
