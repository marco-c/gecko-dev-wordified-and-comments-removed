"
use
strict
"
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
urlQueryStrippingListService
"
"
mozilla
.
org
/
query
-
stripping
-
list
-
service
;
1
"
Ci
.
nsIURLQueryStrippingListService
)
;
const
COLLECTION_NAME
=
"
query
-
stripping
"
;
const
TEST_URI
=
TEST_DOMAIN
+
TEST_PATH
+
"
empty
.
html
"
;
const
TEST_THIRD_PARTY_URI
=
TEST_DOMAIN_2
+
TEST_PATH
+
"
empty
.
html
"
;
class
UpdateEvent
extends
EventTarget
{
}
class
ListObserver
{
updateEvent
=
new
UpdateEvent
(
)
;
onQueryStrippingListUpdate
(
stripList
allowList
)
{
let
event
=
new
CustomEvent
(
"
update
"
{
detail
:
{
stripList
allowList
}
}
)
;
this
.
updateEvent
.
dispatchEvent
(
event
)
;
}
}
function
waitForEvent
(
element
eventName
)
{
return
BrowserTestUtils
.
waitForEvent
(
element
eventName
)
.
then
(
e
=
>
e
.
detail
)
;
}
async
function
verifyQueryString
(
browser
expected
)
{
await
SpecialPowers
.
spawn
(
browser
[
expected
]
expected
=
>
{
let
search
=
content
.
location
.
search
.
slice
(
1
)
;
is
(
search
expected
"
The
query
string
is
correct
.
"
)
;
}
)
;
}
async
function
check
(
query
expected
)
{
let
testURI
=
TEST_URI
+
"
?
"
+
query
;
await
BrowserTestUtils
.
withNewTab
(
testURI
async
browser
=
>
{
await
verifyQueryString
(
browser
expected
)
;
}
)
;
testURI
=
TEST_URI
+
"
?
"
+
query
;
let
expectedURI
;
if
(
expected
!
=
"
"
)
{
expectedURI
=
TEST_URI
+
"
?
"
+
expected
;
}
else
{
expectedURI
=
TEST_URI
;
}
await
BrowserTestUtils
.
withNewTab
(
TEST_THIRD_PARTY_URI
async
browser
=
>
{
let
locationChangePromise
=
BrowserTestUtils
.
waitForLocationChange
(
gBrowser
expectedURI
)
;
await
SpecialPowers
.
spawn
(
browser
[
testURI
]
async
uri
=
>
{
let
link
=
content
.
document
.
createElement
(
"
a
"
)
;
link
.
setAttribute
(
"
href
"
uri
)
;
link
.
textContent
=
"
Link
"
;
content
.
document
.
body
.
appendChild
(
link
)
;
link
.
click
(
)
;
}
)
;
await
locationChangePromise
;
await
verifyQueryString
(
browser
expected
)
;
}
)
;
}
registerCleanupFunction
(
(
)
=
>
{
Cc
[
"
mozilla
.
org
/
query
-
stripping
-
list
-
service
;
1
"
]
.
getService
(
Ci
.
nsIURLQueryStrippingListService
)
.
clearLists
(
)
;
}
)
;
add_task
(
async
function
testPrefSettings
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
enabled
"
true
]
[
"
privacy
.
query_stripping
.
strip_list
"
"
"
]
[
"
privacy
.
query_stripping
.
allow_list
"
"
"
]
[
"
privacy
.
query_stripping
.
testing
"
true
]
]
}
)
;
let
obs
=
new
ListObserver
(
)
;
let
promise
=
waitForEvent
(
obs
.
updateEvent
"
update
"
)
;
urlQueryStrippingListService
.
registerAndRunObserver
(
obs
)
;
let
lists
=
await
promise
;
is
(
lists
.
stripList
"
"
"
No
strip
list
at
the
beginning
.
"
)
;
is
(
lists
.
allowList
"
"
"
No
allow
list
at
the
beginning
.
"
)
;
await
check
(
"
pref_query1
=
123
"
"
pref_query1
=
123
"
)
;
await
check
(
"
pref_query2
=
456
"
"
pref_query2
=
456
"
)
;
promise
=
waitForEvent
(
obs
.
updateEvent
"
update
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
strip_list
"
"
pref_query1
pref_query2
"
]
]
}
)
;
lists
=
await
promise
;
is
(
lists
.
stripList
"
pref_query1
pref_query2
"
"
There
should
be
strip
list
entries
.
"
)
;
is
(
lists
.
allowList
"
"
"
There
should
be
no
allow
list
entries
.
"
)
;
await
check
(
"
pref_query1
=
123
"
"
"
)
;
await
check
(
"
pref_query2
=
456
"
"
"
)
;
promise
=
waitForEvent
(
obs
.
updateEvent
"
update
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
allow_list
"
"
example
.
net
"
]
]
}
)
;
lists
=
await
promise
;
is
(
lists
.
stripList
"
pref_query1
pref_query2
"
"
There
should
be
strip
list
entires
.
"
)
;
is
(
lists
.
allowList
"
example
.
net
"
"
There
should
be
one
allow
list
entry
.
"
)
;
await
check
(
"
pref_query1
=
123
"
"
pref_query1
=
123
"
)
;
await
check
(
"
pref_query2
=
123
"
"
pref_query2
=
123
"
)
;
urlQueryStrippingListService
.
unregisterObserver
(
obs
)
;
SpecialPowers
.
flushPrefEnv
(
)
;
}
)
;
add_task
(
async
function
testRemoteSettings
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
enabled
"
true
]
[
"
privacy
.
query_stripping
.
strip_list
"
"
"
]
[
"
privacy
.
query_stripping
.
allow_list
"
"
"
]
[
"
privacy
.
query_stripping
.
testing
"
true
]
]
}
)
;
let
db
=
RemoteSettings
(
COLLECTION_NAME
)
.
db
;
await
db
.
importChanges
(
{
}
Date
.
now
(
)
[
]
)
;
let
obs
=
new
ListObserver
(
)
;
let
promise
=
waitForEvent
(
obs
.
updateEvent
"
update
"
)
;
urlQueryStrippingListService
.
registerAndRunObserver
(
obs
)
;
let
lists
=
await
promise
;
is
(
lists
.
stripList
"
"
"
No
strip
list
at
the
beginning
.
"
)
;
is
(
lists
.
allowList
"
"
"
No
allow
list
at
the
beginning
.
"
)
;
await
check
(
"
remote_query1
=
123
"
"
remote_query1
=
123
"
)
;
await
check
(
"
remote_query2
=
456
"
"
remote_query2
=
456
"
)
;
promise
=
waitForEvent
(
obs
.
updateEvent
"
update
"
)
;
await
RemoteSettings
(
COLLECTION_NAME
)
.
emit
(
"
sync
"
{
data
:
{
current
:
[
{
id
:
"
1
"
last_modified
:
1000000000000001
stripList
:
[
"
remote_query1
"
"
remote_query2
"
]
allowList
:
[
]
}
]
}
}
)
;
lists
=
await
promise
;
is
(
lists
.
stripList
"
remote_query1
remote_query2
"
"
There
should
be
strip
list
entries
.
"
)
;
is
(
lists
.
allowList
"
"
"
There
should
be
no
allow
list
entries
.
"
)
;
await
check
(
"
remote_query1
=
123
"
"
"
)
;
await
check
(
"
remote_query2
=
456
"
"
"
)
;
promise
=
waitForEvent
(
obs
.
updateEvent
"
update
"
)
;
await
RemoteSettings
(
COLLECTION_NAME
)
.
emit
(
"
sync
"
{
data
:
{
current
:
[
{
id
:
"
2
"
last_modified
:
1000000000000002
stripList
:
[
"
remote_query1
"
"
remote_query2
"
]
allowList
:
[
"
example
.
net
"
]
}
]
}
}
)
;
lists
=
await
promise
;
is
(
lists
.
stripList
"
remote_query1
remote_query2
"
"
There
should
be
strip
list
entries
.
"
)
;
is
(
lists
.
allowList
"
example
.
net
"
"
There
should
be
one
allow
list
entry
.
"
)
;
await
check
(
"
remote_query1
=
123
"
"
remote_query1
=
123
"
)
;
await
check
(
"
remote_query2
=
123
"
"
remote_query2
=
123
"
)
;
urlQueryStrippingListService
.
unregisterObserver
(
obs
)
;
await
db
.
clear
(
)
;
}
)
;
