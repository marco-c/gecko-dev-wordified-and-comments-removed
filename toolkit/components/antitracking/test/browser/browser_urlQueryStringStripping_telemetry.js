"
use
strict
"
;
const
TEST_URI
=
TEST_DOMAIN
+
TEST_PATH
+
"
file_stripping
.
html
"
;
const
TEST_THIRD_PARTY_URI
=
TEST_DOMAIN_2
+
TEST_PATH
+
"
file_stripping
.
html
"
;
const
TEST_REDIRECT_URI
=
TEST_DOMAIN
+
TEST_PATH
+
"
redirect
.
sjs
"
;
const
{
TelemetryTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
TelemetryTestUtils
.
jsm
"
)
;
const
LABEL_NAVIGATION
=
0
;
const
LABEL_REDIRECT
=
1
;
const
LABEL_STRIP_FOR_NAVIGATION
=
2
;
const
LABEL_STRIP_FOR_REDIRECT
=
3
;
const
QUERY_STRIPPING_COUNT
=
"
QUERY_STRIPPING_COUNT
"
;
const
QUERY_STRIPPING_PARAM_COUNT
=
"
QUERY_STRIPPING_PARAM_COUNT
"
;
async
function
clearTelemetry
(
)
{
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
2000
)
)
;
Services
.
telemetry
.
getSnapshotForHistograms
(
"
main
"
true
)
;
Services
.
telemetry
.
getHistogramById
(
QUERY_STRIPPING_COUNT
)
.
clear
(
)
;
Services
.
telemetry
.
getHistogramById
(
QUERY_STRIPPING_PARAM_COUNT
)
.
clear
(
)
;
let
isCleared
=
(
)
=
>
{
let
histograms
=
Services
.
telemetry
.
getSnapshotForHistograms
(
"
main
"
false
)
.
content
;
return
(
!
histograms
|
|
(
!
histograms
[
QUERY_STRIPPING_COUNT
]
&
&
!
histograms
[
QUERY_STRIPPING_PARAM_COUNT
]
)
)
;
}
;
if
(
!
isCleared
(
)
)
{
await
TestUtils
.
waitForCondition
(
isCleared
)
;
}
ok
(
true
"
Telemetry
has
been
cleared
.
"
)
;
}
async
function
verifyQueryString
(
browser
expected
)
{
await
SpecialPowers
.
spawn
(
browser
[
expected
]
expected
=
>
{
let
search
=
content
.
location
.
search
.
slice
(
1
)
;
is
(
search
expected
"
The
query
string
is
correct
.
"
)
;
}
)
;
}
async
function
getTelemetryProbe
(
probeInParent
key
label
checkCntFn
)
{
let
histogram
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
let
histograms
;
if
(
probeInParent
)
{
histograms
=
Services
.
telemetry
.
getSnapshotForHistograms
(
"
main
"
false
)
.
parent
;
}
else
{
histograms
=
Services
.
telemetry
.
getSnapshotForHistograms
(
"
main
"
false
)
.
content
;
}
histogram
=
histograms
[
key
]
;
let
checkRes
=
false
;
if
(
histogram
)
{
checkRes
=
checkCntFn
?
checkCntFn
(
histogram
.
values
[
label
]
)
:
true
;
}
return
checkRes
;
}
)
;
return
histogram
.
values
[
label
]
;
}
async
function
checkTelemetryProbe
(
probeInParent
key
expectedCnt
label
)
{
let
cnt
=
await
getTelemetryProbe
(
probeInParent
key
label
cnt
=
>
cnt
=
=
expectedCnt
)
;
is
(
cnt
expectedCnt
"
There
should
be
expected
count
in
telemetry
.
"
)
;
}
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
enabled
"
true
]
[
"
privacy
.
query_stripping
.
strip_list
"
"
paramToStrip
paramToStripB
paramToStripC
paramToStripD
"
]
]
}
)
;
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
testQueryStrippingNavigationInParent
(
)
{
let
testURI
=
TEST_URI
+
"
?
paramToStrip
=
value
"
;
await
BrowserTestUtils
.
withNewTab
(
testURI
async
browser
=
>
{
await
verifyQueryString
(
browser
"
"
)
;
}
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
1
LABEL_STRIP_FOR_NAVIGATION
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_PARAM_COUNT
1
"
1
"
)
;
let
newNavigationCnt
=
await
getTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
LABEL_NAVIGATION
cnt
=
>
cnt
>
0
)
;
ok
(
newNavigationCnt
>
0
"
There
is
navigation
count
added
.
"
)
;
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
testQueryStrippingNavigationInContent
(
)
{
let
testThirdPartyURI
=
TEST_THIRD_PARTY_URI
+
"
?
paramToStrip
=
value
"
;
await
BrowserTestUtils
.
withNewTab
(
TEST_URI
async
browser
=
>
{
let
locationChangePromise
=
BrowserTestUtils
.
waitForLocationChange
(
gBrowser
TEST_THIRD_PARTY_URI
)
;
await
SpecialPowers
.
spawn
(
browser
[
testThirdPartyURI
]
async
url
=
>
{
content
.
postMessage
(
{
type
:
"
script
"
url
}
"
*
"
)
;
}
)
;
await
locationChangePromise
;
await
verifyQueryString
(
browser
"
"
)
;
}
)
;
await
checkTelemetryProbe
(
false
QUERY_STRIPPING_COUNT
1
LABEL_STRIP_FOR_NAVIGATION
)
;
await
checkTelemetryProbe
(
false
QUERY_STRIPPING_PARAM_COUNT
1
"
1
"
)
;
let
newNavigationCnt
=
await
getTelemetryProbe
(
false
QUERY_STRIPPING_COUNT
LABEL_NAVIGATION
cnt
=
>
cnt
>
0
)
;
ok
(
newNavigationCnt
>
0
"
There
is
navigation
count
added
.
"
)
;
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
testQueryStrippingNavigationInContentQueryCount
(
)
{
let
testThirdPartyURI
=
TEST_THIRD_PARTY_URI
+
"
?
paramToStrip
=
value
&
paramToStripB
=
valueB
&
paramToStripC
=
valueC
&
paramToStripD
=
valueD
"
;
await
BrowserTestUtils
.
withNewTab
(
TEST_URI
async
browser
=
>
{
let
locationChangePromise
=
BrowserTestUtils
.
waitForLocationChange
(
gBrowser
TEST_THIRD_PARTY_URI
)
;
await
SpecialPowers
.
spawn
(
browser
[
testThirdPartyURI
]
async
url
=
>
{
content
.
postMessage
(
{
type
:
"
script
"
url
}
"
*
"
)
;
}
)
;
await
locationChangePromise
;
await
verifyQueryString
(
browser
"
"
)
;
}
)
;
await
checkTelemetryProbe
(
false
QUERY_STRIPPING_COUNT
1
LABEL_STRIP_FOR_NAVIGATION
)
;
await
getTelemetryProbe
(
false
QUERY_STRIPPING_PARAM_COUNT
"
0
"
cnt
=
>
!
cnt
)
;
await
getTelemetryProbe
(
false
QUERY_STRIPPING_PARAM_COUNT
"
1
"
cnt
=
>
!
cnt
)
;
await
getTelemetryProbe
(
false
QUERY_STRIPPING_PARAM_COUNT
"
2
"
cnt
=
>
!
cnt
)
;
await
getTelemetryProbe
(
false
QUERY_STRIPPING_PARAM_COUNT
"
3
"
cnt
=
>
!
cnt
)
;
await
getTelemetryProbe
(
false
QUERY_STRIPPING_PARAM_COUNT
"
4
"
cnt
=
>
cnt
=
=
1
)
;
await
getTelemetryProbe
(
false
QUERY_STRIPPING_PARAM_COUNT
"
5
"
cnt
=
>
!
cnt
)
;
let
newNavigationCnt
=
await
getTelemetryProbe
(
false
QUERY_STRIPPING_COUNT
LABEL_NAVIGATION
cnt
=
>
cnt
>
0
)
;
ok
(
newNavigationCnt
>
0
"
There
is
navigation
count
added
.
"
)
;
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
testQueryStrippingRedirect
(
)
{
let
testThirdPartyURI
=
{
TEST_REDIRECT_URI
}
?
{
TEST_THIRD_PARTY_URI
}
?
paramToStrip
=
value
;
await
BrowserTestUtils
.
withNewTab
(
TEST_URI
async
browser
=
>
{
let
locationChangePromise
=
BrowserTestUtils
.
waitForLocationChange
(
gBrowser
TEST_THIRD_PARTY_URI
)
;
await
SpecialPowers
.
spawn
(
browser
[
testThirdPartyURI
]
async
url
=
>
{
content
.
postMessage
(
{
type
:
"
script
"
url
}
"
*
"
)
;
}
)
;
await
locationChangePromise
;
await
verifyQueryString
(
browser
"
"
)
;
}
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
1
LABEL_STRIP_FOR_REDIRECT
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
1
LABEL_REDIRECT
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_PARAM_COUNT
1
"
1
"
)
;
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
testQueryStrippingDisabled
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
enabled
"
false
]
]
}
)
;
let
testURI
=
TEST_URI
+
"
?
paramToStrip
=
value
"
;
await
BrowserTestUtils
.
withNewTab
(
testURI
async
browser
=
>
{
await
verifyQueryString
(
browser
"
paramToStrip
=
value
"
)
;
}
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
undefined
LABEL_STRIP_FOR_NAVIGATION
)
;
let
newNavigationCnt
=
await
getTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
LABEL_NAVIGATION
cnt
=
>
cnt
>
0
)
;
ok
(
newNavigationCnt
>
0
"
There
is
navigation
count
added
.
"
)
;
let
testThirdPartyURI
=
TEST_THIRD_PARTY_URI
+
"
?
paramToStrip
=
value
"
;
await
BrowserTestUtils
.
withNewTab
(
TEST_URI
async
browser
=
>
{
let
locationChangePromise
=
BrowserTestUtils
.
waitForLocationChange
(
gBrowser
testThirdPartyURI
)
;
await
SpecialPowers
.
spawn
(
browser
[
testThirdPartyURI
]
async
url
=
>
{
content
.
postMessage
(
{
type
:
"
script
"
url
}
"
*
"
)
;
}
)
;
await
locationChangePromise
;
await
verifyQueryString
(
browser
"
paramToStrip
=
value
"
)
;
}
)
;
await
checkTelemetryProbe
(
false
QUERY_STRIPPING_COUNT
undefined
LABEL_STRIP_FOR_NAVIGATION
)
;
newNavigationCnt
=
await
getTelemetryProbe
(
false
QUERY_STRIPPING_COUNT
LABEL_NAVIGATION
cnt
=
>
cnt
>
0
)
;
ok
(
newNavigationCnt
>
0
"
There
is
navigation
count
added
.
"
)
;
testThirdPartyURI
=
{
TEST_REDIRECT_URI
}
?
{
TEST_THIRD_PARTY_URI
}
?
paramToStrip
=
value
;
await
BrowserTestUtils
.
withNewTab
(
TEST_URI
async
browser
=
>
{
let
locationChangePromise
=
BrowserTestUtils
.
waitForLocationChange
(
gBrowser
{
TEST_THIRD_PARTY_URI
}
?
paramToStrip
=
value
)
;
await
SpecialPowers
.
spawn
(
browser
[
testThirdPartyURI
]
async
url
=
>
{
content
.
postMessage
(
{
type
:
"
script
"
url
}
"
*
"
)
;
}
)
;
await
locationChangePromise
;
await
verifyQueryString
(
browser
"
paramToStrip
=
value
"
)
;
}
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
undefined
LABEL_STRIP_FOR_REDIRECT
)
;
await
checkTelemetryProbe
(
true
QUERY_STRIPPING_COUNT
1
LABEL_REDIRECT
)
;
await
clearTelemetry
(
)
;
}
)
;
