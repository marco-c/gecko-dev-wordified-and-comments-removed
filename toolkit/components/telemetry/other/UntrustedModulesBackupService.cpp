#
include
"
UntrustedModulesBackupService
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
HashFunctions
.
h
"
#
include
"
mozilla
/
SchedulerGroup
.
h
"
#
include
"
mozilla
/
StaticLocalPtr
.
h
"
namespace
mozilla
{
ProcessHashKey
:
:
ProcessHashKey
(
GeckoProcessType
aType
DWORD
aPid
)
:
mType
(
aType
)
mPid
(
aPid
)
{
}
bool
ProcessHashKey
:
:
operator
=
=
(
const
ProcessHashKey
&
aOther
)
const
{
return
mPid
=
=
aOther
.
mPid
&
&
mType
=
=
aOther
.
mType
;
}
PLDHashNumber
ProcessHashKey
:
:
Hash
(
)
const
{
return
HashGeneric
(
mPid
mType
)
;
}
void
UntrustedModulesBackupData
:
:
Add
(
UntrustedModulesData
&
&
aData
)
{
WithEntryHandle
(
ProcessHashKey
(
aData
.
mProcessType
aData
.
mPid
)
[
&
]
(
auto
&
&
p
)
{
if
(
p
)
{
p
.
Data
(
)
-
>
mData
.
Merge
(
std
:
:
move
(
aData
)
)
;
}
else
{
p
.
Insert
(
MakeRefPtr
<
UntrustedModulesDataContainer
>
(
std
:
:
move
(
aData
)
)
)
;
}
}
)
;
}
UntrustedModulesBackupService
*
UntrustedModulesBackupService
:
:
Get
(
)
{
if
(
!
XRE_IsParentProcess
(
)
)
{
return
nullptr
;
}
static
StaticLocalRefPtr
<
UntrustedModulesBackupService
>
sInstance
(
[
]
(
)
-
>
already_AddRefed
<
UntrustedModulesBackupService
>
{
RefPtr
<
UntrustedModulesBackupService
>
instance
(
new
UntrustedModulesBackupService
(
)
)
;
auto
setClearOnShutdown
=
[
ptr
=
&
sInstance
]
(
)
-
>
void
{
ClearOnShutdown
(
ptr
)
;
}
;
if
(
NS_IsMainThread
(
)
)
{
setClearOnShutdown
(
)
;
return
instance
.
forget
(
)
;
}
SchedulerGroup
:
:
Dispatch
(
TaskCategory
:
:
Other
NS_NewRunnableFunction
(
"
mozilla
:
:
UntrustedModulesBackupService
:
:
Get
"
std
:
:
move
(
setClearOnShutdown
)
)
)
;
return
instance
.
forget
(
)
;
}
(
)
)
;
return
sInstance
;
}
void
UntrustedModulesBackupService
:
:
Backup
(
UntrustedModulesData
&
&
aData
)
{
mStaging
.
Add
(
std
:
:
move
(
aData
)
)
;
}
void
UntrustedModulesBackupService
:
:
SettleAllStagingData
(
)
{
UntrustedModulesBackupData
staging
;
staging
.
SwapElements
(
mStaging
)
;
for
(
auto
&
&
iter
=
staging
.
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
if
(
!
iter
.
Data
(
)
)
{
continue
;
}
mSettled
.
Add
(
std
:
:
move
(
iter
.
Data
(
)
-
>
mData
)
)
;
}
}
}
