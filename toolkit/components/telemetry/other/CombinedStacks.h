#
ifndef
CombinedStacks_h__
#
define
CombinedStacks_h__
#
include
<
vector
>
#
include
"
ipc
/
IPCMessageUtils
.
h
"
#
include
"
ProcessedStack
.
h
"
class
JSObject
;
struct
JSContext
;
namespace
mozilla
{
namespace
Telemetry
{
class
CombinedStacks
{
public
:
explicit
CombinedStacks
(
)
;
explicit
CombinedStacks
(
size_t
aMaxStacksCount
)
;
CombinedStacks
(
CombinedStacks
&
&
)
=
default
;
CombinedStacks
&
operator
=
(
CombinedStacks
&
&
)
=
default
;
void
Swap
(
CombinedStacks
&
aOther
)
;
typedef
std
:
:
vector
<
Telemetry
:
:
ProcessedStack
:
:
Frame
>
Stack
;
const
Telemetry
:
:
ProcessedStack
:
:
Module
&
GetModule
(
unsigned
aIndex
)
const
;
size_t
GetModuleCount
(
)
const
;
const
Stack
&
GetStack
(
unsigned
aIndex
)
const
;
size_t
AddStack
(
const
Telemetry
:
:
ProcessedStack
&
aStack
)
;
size_t
GetStackCount
(
)
const
;
size_t
SizeOfExcludingThis
(
)
const
;
void
RemoveStack
(
unsigned
aIndex
)
;
#
if
defined
(
MOZ_GECKO_PROFILER
)
void
Clear
(
)
;
#
endif
private
:
std
:
:
vector
<
Telemetry
:
:
ProcessedStack
:
:
Module
>
mModules
;
std
:
:
vector
<
Stack
>
mStacks
;
size_t
mNextIndex
;
size_t
mMaxStacksCount
;
friend
struct
:
:
IPC
:
:
ParamTraits
<
CombinedStacks
>
;
}
;
JSObject
*
CreateJSStackObject
(
JSContext
*
cx
const
CombinedStacks
&
stacks
)
;
}
}
namespace
IPC
{
#
if
defined
(
NIGHTLY_BUILD
)
#
define
ANNOTATE_READ_FAILURE
(
)
\
CrashReporter
:
:
AnnotateCrashReport
(
\
CrashReporter
:
:
Annotation
:
:
\
UntrustedModulesDataCombinedStackReadFailure
\
__LINE__
)
#
else
#
define
ANNOTATE_READ_FAILURE
(
)
\
do
{
\
}
while
(
false
)
#
endif
template
<
>
struct
ParamTraits
<
mozilla
:
:
Telemetry
:
:
CombinedStacks
>
{
typedef
mozilla
:
:
Telemetry
:
:
CombinedStacks
paramType
;
static
void
Write
(
Message
*
aMsg
const
paramType
&
aParam
)
{
WriteParam
(
aMsg
aParam
.
mModules
)
;
WriteParam
(
aMsg
aParam
.
mStacks
)
;
WriteParam
(
aMsg
aParam
.
mNextIndex
)
;
WriteParam
(
aMsg
aParam
.
mMaxStacksCount
)
;
}
static
bool
Read
(
const
Message
*
aMsg
PickleIterator
*
aIter
paramType
*
aResult
)
{
if
(
!
ReadParam
(
aMsg
aIter
&
aResult
-
>
mModules
)
)
{
ANNOTATE_READ_FAILURE
(
)
;
return
false
;
}
if
(
!
ReadParam
(
aMsg
aIter
&
aResult
-
>
mStacks
)
)
{
ANNOTATE_READ_FAILURE
(
)
;
return
false
;
}
if
(
!
ReadParam
(
aMsg
aIter
&
aResult
-
>
mNextIndex
)
)
{
ANNOTATE_READ_FAILURE
(
)
;
return
false
;
}
if
(
!
ReadParam
(
aMsg
aIter
&
aResult
-
>
mMaxStacksCount
)
)
{
ANNOTATE_READ_FAILURE
(
)
;
return
false
;
}
return
true
;
}
}
;
#
undef
ANNOTATE_READ_FAILURE
}
#
endif
