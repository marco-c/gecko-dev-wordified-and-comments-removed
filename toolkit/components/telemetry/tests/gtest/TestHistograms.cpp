#
include
"
gtest
/
gtest
.
h
"
#
include
"
js
/
Conversions
.
h
"
#
include
"
nsITelemetry
.
h
"
#
include
"
Telemetry
.
h
"
#
include
"
TelemetryFixture
.
h
"
TEST_F
(
TelemetryTestFixture
AccumulateCountHistogram
)
{
const
uint32_t
kExpectedValue
=
100
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
JS
:
:
RootedValue
testHistogram
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
RootedValue
rval
(
cx
.
GetJSContext
(
)
)
;
nsresult
rv
=
mTelemetry
-
>
GetHistogramById
(
NS_LITERAL_CSTRING
(
"
TELEMETRY_TEST_COUNT
"
)
cx
.
GetJSContext
(
)
&
testHistogram
)
;
ASSERT_EQ
(
rv
NS_OK
)
<
<
"
Cannot
fetch
histogram
"
;
JS
:
:
RootedObject
testHistogramObj
(
cx
.
GetJSContext
(
)
&
testHistogram
.
toObject
(
)
)
;
ASSERT_TRUE
(
JS_CallFunctionName
(
cx
.
GetJSContext
(
)
testHistogramObj
"
clear
"
JS
:
:
HandleValueArray
:
:
empty
(
)
&
rval
)
)
<
<
"
Cannot
clear
histogram
"
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_COUNT
kExpectedValue
)
;
JS
:
:
RootedValue
snapshot
(
cx
.
GetJSContext
(
)
)
;
rv
=
mTelemetry
-
>
GetHistogramSnapshots
(
cx
.
GetJSContext
(
)
&
snapshot
)
;
ASSERT_EQ
(
rv
NS_OK
)
<
<
"
Cannot
call
histogram
snapshots
"
;
JS
:
:
RootedValue
histogram
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
RootedObject
snapshotObj
(
cx
.
GetJSContext
(
)
&
snapshot
.
toObject
(
)
)
;
JS_GetProperty
(
cx
.
GetJSContext
(
)
snapshotObj
"
TELEMETRY_TEST_COUNT
"
&
histogram
)
;
JS
:
:
RootedValue
sum
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
RootedObject
histogramObj
(
cx
.
GetJSContext
(
)
&
histogram
.
toObject
(
)
)
;
JS_GetProperty
(
cx
.
GetJSContext
(
)
histogramObj
"
sum
"
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
kExpectedValue
)
<
<
"
The
histogram
is
not
returning
expected
value
"
;
}
