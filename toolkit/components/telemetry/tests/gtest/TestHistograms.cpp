#
include
"
core
/
TelemetryHistogram
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
js
/
Conversions
.
h
"
#
include
"
mozilla
/
glean
/
GleanTestsTestMetrics
.
h
"
#
include
"
mozilla
/
glean
/
TelemetryMetrics
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
include
"
TelemetryFixture
.
h
"
#
include
"
TelemetryTestHelpers
.
h
"
using
namespace
mozilla
;
using
namespace
TelemetryTestHelpers
;
TEST_F
(
TelemetryTestFixture
AccumulateCountHistogram
)
{
const
uint32_t
kExpectedValue
=
200
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
const
char
*
telemetryTestCountName
=
Telemetry
:
:
GetHistogramName
(
Telemetry
:
:
TELEMETRY_TEST_COUNT
)
;
ASSERT_STREQ
(
telemetryTestCountName
"
TELEMETRY_TEST_COUNT
"
)
<
<
"
The
histogram
name
is
wrong
"
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_COUNT
"
_ns
false
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_COUNT
kExpectedValue
/
2
)
;
Telemetry
:
:
Accumulate
(
"
TELEMETRY_TEST_COUNT
"
kExpectedValue
/
2
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
telemetryTestCountName
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
telemetryTestCountName
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
histogram
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
kExpectedValue
)
<
<
"
The
histogram
is
not
returning
expected
value
"
;
}
TEST_F
(
TelemetryTestFixture
AccumulateKeyedCountHistogram
)
{
const
uint32_t
kExpectedValue
=
100
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_COUNT
"
_ns
true
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_COUNT
"
sample
"
_ns
kExpectedValue
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_COUNT
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_COUNT
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
expectedKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sample
"
histogram
&
expectedKeyData
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
expectedKeyData
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
kExpectedValue
)
<
<
"
The
histogram
is
not
returning
expected
sum
"
;
}
TEST_F
(
TelemetryTestFixture
TestKeyedKeysHistogram
)
{
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
testHistogram
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
rval
(
cx
.
GetJSContext
(
)
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_KEYS
"
_ns
true
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_KEYS
"
not
-
allowed
"
_ns
1
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_KEYS
"
testkey
"
_ns
0
)
;
Telemetry
:
:
Accumulate
(
"
TELEMETRY_TEST_KEYED_KEYS
"
"
not
-
allowed
"
_ns
1
)
;
Telemetry
:
:
Accumulate
(
"
TELEMETRY_TEST_KEYED_KEYS
"
"
CommonKey
"
_ns
1
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_KEYS
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_KEYS
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
expectedKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
testkey
"
histogram
&
expectedKeyData
)
;
ASSERT_TRUE
(
!
expectedKeyData
.
isUndefined
(
)
)
<
<
"
Cannot
find
the
expected
key
in
the
histogram
data
"
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
expectedKeyData
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
0U
)
<
<
"
The
histogram
is
not
returning
expected
sum
for
'
testkey
'
"
;
GetProperty
(
cx
.
GetJSContext
(
)
"
CommonKey
"
histogram
&
expectedKeyData
)
;
ASSERT_TRUE
(
!
expectedKeyData
.
isUndefined
(
)
)
<
<
"
Cannot
find
the
expected
key
in
the
histogram
data
"
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
expectedKeyData
&
sum
)
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
1U
)
<
<
"
The
histogram
is
not
returning
expected
sum
for
'
CommonKey
'
"
;
GetProperty
(
cx
.
GetJSContext
(
)
"
not
-
allowed
"
histogram
&
expectedKeyData
)
;
ASSERT_TRUE
(
expectedKeyData
.
isUndefined
(
)
)
<
<
"
Unallowed
keys
must
not
be
recorded
in
the
histogram
data
"
;
const
uint32_t
expectedAccumulateUnknownCount
=
2
;
JS
:
:
Rooted
<
JS
:
:
Value
>
scalarsSnapshot
(
cx
.
GetJSContext
(
)
)
;
GetScalarsSnapshot
(
true
cx
.
GetJSContext
(
)
&
scalarsSnapshot
)
;
CheckKeyedUintScalar
(
"
telemetry
.
accumulate_unknown_histogram_keys
"
"
TELEMETRY_TEST_KEYED_KEYS
"
cx
.
GetJSContext
(
)
scalarsSnapshot
expectedAccumulateUnknownCount
)
;
}
TEST_F
(
TelemetryTestFixture
AccumulateCategoricalHistogram
)
{
const
uint32_t
kExpectedValue
=
1
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_CATEGORICAL
"
_ns
false
)
;
TelemetryHistogram
:
:
AccumulateCategorical
(
Telemetry
:
:
TELEMETRY_TEST_CATEGORICAL
"
CommonLabel
"
_ns
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_CATEGORICAL
"
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_CATEGORICAL
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
values
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
histogram
&
values
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
value
(
cx
.
GetJSContext
(
)
)
;
GetElement
(
cx
.
GetJSContext
(
)
static_cast
<
uint32_t
>
(
Telemetry
:
:
LABELS_TELEMETRY_TEST_CATEGORICAL
:
:
CommonLabel
)
values
&
value
)
;
uint32_t
uValue
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
value
&
uValue
)
;
ASSERT_EQ
(
uValue
kExpectedValue
)
<
<
"
The
histogram
is
not
returning
expected
value
"
;
}
TEST_F
(
TelemetryTestFixture
AccumulateKeyedCategoricalHistogram
)
{
const
uint32_t
kSampleExpectedValue
=
2
;
const
uint32_t
kOtherSampleExpectedValue
=
1
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_CATEGORICAL
"
_ns
true
)
;
Telemetry
:
:
AccumulateCategoricalKeyed
(
"
sample
"
_ns
Telemetry
:
:
LABELS_TELEMETRY_TEST_KEYED_CATEGORICAL
:
:
CommonLabel
)
;
Telemetry
:
:
AccumulateCategoricalKeyed
(
"
sample
"
_ns
Telemetry
:
:
LABELS_TELEMETRY_TEST_KEYED_CATEGORICAL
:
:
CommonLabel
)
;
Telemetry
:
:
AccumulateCategoricalKeyed
(
"
other
-
sample
"
_ns
Telemetry
:
:
LABELS_TELEMETRY_TEST_KEYED_CATEGORICAL
:
:
CommonLabel
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_CATEGORICAL
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_CATEGORICAL
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sample
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sample
"
histogram
&
sample
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sampleValues
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
sample
&
sampleValues
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sampleValue
(
cx
.
GetJSContext
(
)
)
;
GetElement
(
cx
.
GetJSContext
(
)
static_cast
<
uint32_t
>
(
Telemetry
:
:
LABELS_TELEMETRY_TEST_KEYED_CATEGORICAL
:
:
CommonLabel
)
sampleValues
&
sampleValue
)
;
uint32_t
uSampleValue
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sampleValue
&
uSampleValue
)
;
ASSERT_EQ
(
uSampleValue
kSampleExpectedValue
)
<
<
"
The
sample
histogram
is
not
returning
expected
value
"
;
JS
:
:
Rooted
<
JS
:
:
Value
>
otherSample
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
other
-
sample
"
histogram
&
otherSample
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
otherValues
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
otherSample
&
otherValues
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
otherValue
(
cx
.
GetJSContext
(
)
)
;
GetElement
(
cx
.
GetJSContext
(
)
static_cast
<
uint32_t
>
(
Telemetry
:
:
LABELS_TELEMETRY_TEST_KEYED_CATEGORICAL
:
:
CommonLabel
)
otherValues
&
otherValue
)
;
uint32_t
uOtherValue
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
otherValue
&
uOtherValue
)
;
ASSERT_EQ
(
uOtherValue
kOtherSampleExpectedValue
)
<
<
"
The
other
-
sample
histogram
is
not
returning
expected
value
"
;
}
TEST_F
(
TelemetryTestFixture
AccumulateCountHistogram_MultipleSamples
)
{
nsTArray
<
uint32_t
>
samples
(
{
4
4
4
}
)
;
const
uint32_t
kExpectedSum
=
12
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_COUNT
"
_ns
false
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_COUNT
samples
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_COUNT
"
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_COUNT
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
histogram
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
kExpectedSum
)
<
<
"
This
histogram
is
not
returning
expected
value
"
;
}
TEST_F
(
TelemetryTestFixture
AccumulateLinearHistogram_MultipleSamples
)
{
nsTArray
<
uint32_t
>
samples
(
{
4
4
4
}
)
;
const
uint32_t
kExpectedCount
=
3
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_LINEAR
"
_ns
false
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_LINEAR
samples
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_LINEAR
"
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_LINEAR
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
values
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
histogram
&
values
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
count
(
cx
.
GetJSContext
(
)
)
;
const
uint32_t
index
=
1
;
GetElement
(
cx
.
GetJSContext
(
)
index
values
&
count
)
;
uint32_t
uCount
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
count
&
uCount
)
;
ASSERT_EQ
(
uCount
kExpectedCount
)
<
<
"
The
histogram
did
not
accumulate
the
correct
number
of
values
"
;
}
TEST_F
(
TelemetryTestFixture
AccumulateLinearHistogram_DifferentSamples
)
{
nsTArray
<
uint32_t
>
samples
(
{
4
8
2147483646
uint32_t
(
INT_MAX
)
+
1
UINT32_MAX
}
)
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
mTelemetry
-
>
ClearScalars
(
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_LINEAR
"
_ns
false
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_LINEAR
samples
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_LINEAR
"
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_LINEAR
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
values
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
histogram
&
values
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countFirst
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countLast
(
cx
.
GetJSContext
(
)
)
;
const
uint32_t
firstIndex
=
1
;
const
uint32_t
lastIndex
=
INT32_MAX
-
1
;
GetElement
(
cx
.
GetJSContext
(
)
firstIndex
values
&
countFirst
)
;
GetElement
(
cx
.
GetJSContext
(
)
lastIndex
values
&
countLast
)
;
uint32_t
uCountFirst
=
0
;
uint32_t
uCountLast
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countFirst
&
uCountFirst
)
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countLast
&
uCountLast
)
;
const
uint32_t
kExpectedCountFirst
=
2
;
const
uint32_t
kExpectedCountLast
=
3
;
ASSERT_EQ
(
uCountFirst
kExpectedCountFirst
)
<
<
"
The
first
bucket
did
not
accumulate
the
correct
number
of
values
"
;
ASSERT_EQ
(
uCountLast
kExpectedCountLast
)
<
<
"
The
last
bucket
did
not
accumulate
the
correct
number
of
values
"
;
const
uint32_t
expectedAccumulateClampedCount
=
2
;
JS
:
:
Rooted
<
JS
:
:
Value
>
scalarsSnapshot
(
cx
.
GetJSContext
(
)
)
;
GetScalarsSnapshot
(
true
cx
.
GetJSContext
(
)
&
scalarsSnapshot
)
;
CheckKeyedUintScalar
(
"
telemetry
.
accumulate_clamped_values
"
"
TELEMETRY_TEST_LINEAR
"
cx
.
GetJSContext
(
)
scalarsSnapshot
expectedAccumulateClampedCount
)
;
}
TEST_F
(
TelemetryTestFixture
AccumulateKeyedCountHistogram_MultipleSamples
)
{
const
nsTArray
<
uint32_t
>
samples
(
{
5
10
15
}
)
;
const
uint32_t
kExpectedSum
=
5
+
10
+
15
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_COUNT
"
_ns
true
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_COUNT
"
sample
"
_ns
samples
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_COUNT
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_COUNT
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
expectedKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sample
"
histogram
&
expectedKeyData
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
expectedKeyData
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
kExpectedSum
)
<
<
"
The
histogram
is
not
returning
expected
sum
"
;
}
TEST_F
(
TelemetryTestFixture
TestKeyedLinearHistogram_MultipleSamples
)
{
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
mTelemetry
-
>
ClearScalars
(
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_LINEAR
"
_ns
true
)
;
const
nsTArray
<
uint32_t
>
samples
(
{
1
5
250000
UINT_MAX
}
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_LINEAR
"
testkey
"
_ns
samples
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_LINEAR
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_LINEAR
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
expectedKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
testkey
"
histogram
&
expectedKeyData
)
;
ASSERT_TRUE
(
!
expectedKeyData
.
isUndefined
(
)
)
<
<
"
Cannot
find
the
expected
key
in
the
histogram
data
"
;
JS
:
:
Rooted
<
JS
:
:
Value
>
values
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
expectedKeyData
&
values
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countFirst
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countLast
(
cx
.
GetJSContext
(
)
)
;
const
uint32_t
firstIndex
=
1
;
const
uint32_t
lastIndex
=
250000
;
GetElement
(
cx
.
GetJSContext
(
)
firstIndex
values
&
countFirst
)
;
GetElement
(
cx
.
GetJSContext
(
)
lastIndex
values
&
countLast
)
;
uint32_t
uCountFirst
=
0
;
uint32_t
uCountLast
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countFirst
&
uCountFirst
)
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countLast
&
uCountLast
)
;
const
uint32_t
kExpectedCountFirst
=
2
;
const
uint32_t
kExpectedCountLast
=
2
;
ASSERT_EQ
(
uCountFirst
kExpectedCountFirst
)
<
<
"
The
first
bucket
did
not
accumulate
the
correct
number
of
values
for
"
"
key
'
testkey
'
"
;
ASSERT_EQ
(
uCountLast
kExpectedCountLast
)
<
<
"
The
last
bucket
did
not
accumulate
the
correct
number
of
values
for
"
"
key
'
testkey
'
"
;
const
uint32_t
expectedAccumulateClampedCount
=
1
;
JS
:
:
Rooted
<
JS
:
:
Value
>
scalarsSnapshot
(
cx
.
GetJSContext
(
)
)
;
GetScalarsSnapshot
(
true
cx
.
GetJSContext
(
)
&
scalarsSnapshot
)
;
CheckKeyedUintScalar
(
"
telemetry
.
accumulate_clamped_values
"
"
TELEMETRY_TEST_KEYED_LINEAR
"
cx
.
GetJSContext
(
)
scalarsSnapshot
expectedAccumulateClampedCount
)
;
}
TEST_F
(
TelemetryTestFixture
TestKeyedKeysHistogram_MultipleSamples
)
{
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
mTelemetry
-
>
ClearScalars
(
)
;
const
nsTArray
<
uint32_t
>
samples
(
{
false
false
true
32
true
}
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_KEYS
"
_ns
true
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_KEYS
"
not
-
allowed
"
_ns
samples
)
;
Telemetry
:
:
Accumulate
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_KEYS
"
testkey
"
_ns
samples
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_KEYS
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_KEYS
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
testKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
testkey
"
histogram
&
testKeyData
)
;
ASSERT_TRUE
(
!
testKeyData
.
isUndefined
(
)
)
<
<
"
Cannot
find
the
key
'
testkey
'
in
the
histogram
data
"
;
JS
:
:
Rooted
<
JS
:
:
Value
>
values
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
testKeyData
&
values
)
;
const
uint32_t
falseIndex
=
0
;
const
uint32_t
trueIndex
=
1
;
const
uint32_t
otherIndex
=
2
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countFalse
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countTrue
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countOther
(
cx
.
GetJSContext
(
)
)
;
GetElement
(
cx
.
GetJSContext
(
)
falseIndex
values
&
countFalse
)
;
GetElement
(
cx
.
GetJSContext
(
)
trueIndex
values
&
countTrue
)
;
GetElement
(
cx
.
GetJSContext
(
)
otherIndex
values
&
countOther
)
;
uint32_t
uCountFalse
=
0
;
uint32_t
uCountTrue
=
0
;
uint32_t
uCountOther
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countFalse
&
uCountFalse
)
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countTrue
&
uCountTrue
)
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countOther
&
uCountOther
)
;
const
uint32_t
kExpectedCountFalse
=
2
;
const
uint32_t
kExpectedCountTrue
=
3
;
const
uint32_t
kExpectedCountOther
=
0
;
ASSERT_EQ
(
uCountFalse
kExpectedCountFalse
)
<
<
"
The
histogram
did
not
accumulate
the
correct
number
of
'
false
'
"
"
booleans
for
key
'
testkey
'
"
;
ASSERT_EQ
(
uCountTrue
kExpectedCountTrue
)
<
<
"
The
histogram
did
not
accumulate
the
correct
number
of
'
true
'
"
"
booleans
for
key
'
testkey
'
"
;
ASSERT_EQ
(
uCountOther
kExpectedCountOther
)
<
<
"
The
histogram
did
not
accumulate
the
correct
number
of
undefined
"
"
values
for
key
'
testkey
'
"
;
JS
:
:
Rooted
<
JS
:
:
Value
>
commonKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
CommonKey
"
histogram
&
commonKeyData
)
;
ASSERT_TRUE
(
commonKeyData
.
isUndefined
(
)
)
<
<
"
Found
data
in
key
'
CommonKey
'
even
though
we
accumulated
no
data
to
"
"
it
"
;
JS
:
:
Rooted
<
JS
:
:
Value
>
notAllowedKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
not
-
allowed
"
histogram
&
notAllowedKeyData
)
;
ASSERT_TRUE
(
notAllowedKeyData
.
isUndefined
(
)
)
<
<
"
Found
data
in
key
'
not
-
allowed
'
even
though
accumuling
data
to
it
is
"
"
not
allowed
"
;
const
uint32_t
expectedAccumulateUnknownCount
=
1
;
JS
:
:
Rooted
<
JS
:
:
Value
>
scalarsSnapshot
(
cx
.
GetJSContext
(
)
)
;
GetScalarsSnapshot
(
true
cx
.
GetJSContext
(
)
&
scalarsSnapshot
)
;
CheckKeyedUintScalar
(
"
telemetry
.
accumulate_unknown_histogram_keys
"
"
TELEMETRY_TEST_KEYED_KEYS
"
cx
.
GetJSContext
(
)
scalarsSnapshot
expectedAccumulateUnknownCount
)
;
}
TEST_F
(
TelemetryTestFixture
AccumulateTimeDelta
)
{
const
uint32_t
kExpectedValue
=
100
;
const
TimeStamp
start
=
TimeStamp
:
:
Now
(
)
;
const
TimeDuration
delta
=
TimeDuration
:
:
FromMilliseconds
(
50
)
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_COUNT
"
_ns
false
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
TELEMETRY_TEST_COUNT
start
-
delta
start
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
TELEMETRY_TEST_COUNT
start
-
delta
start
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
TELEMETRY_TEST_COUNT
start
start
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_COUNT
"
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_COUNT
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
histogram
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
kExpectedValue
)
<
<
"
The
histogram
is
not
returning
expected
value
"
;
}
TEST_F
(
TelemetryTestFixture
AccumulateKeyedTimeDelta
)
{
const
uint32_t
kExpectedValue
=
100
;
const
TimeStamp
start
=
TimeStamp
:
:
Now
(
)
;
const
TimeDuration
delta
=
TimeDuration
:
:
FromMilliseconds
(
50
)
;
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_COUNT
"
_ns
true
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_COUNT
"
sample
"
_ns
start
-
delta
start
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_COUNT
"
sample
"
_ns
start
-
delta
start
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
TELEMETRY_TEST_KEYED_COUNT
"
sample
"
_ns
start
start
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_COUNT
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_COUNT
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
expectedKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sample
"
histogram
&
expectedKeyData
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
expectedKeyData
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
uSum
kExpectedValue
)
<
<
"
The
histogram
is
not
returning
expected
sum
"
;
}
TEST_F
(
TelemetryTestFixture
GIFFTLabeledCounterToBooleanHgram
)
{
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_BOOLEAN
"
_ns
false
)
;
nsCString
empty
;
ASSERT_EQ
(
NS_OK
mozilla
:
:
glean
:
:
impl
:
:
fog_test_reset
(
&
empty
&
empty
)
)
;
auto
forTrue
=
mozilla
:
:
glean
:
:
test_only_ipc
:
:
a_labeled_counter_for_hgram
.
EnumGet
(
mozilla
:
:
glean
:
:
test_only_ipc
:
:
ALabeledCounterForHgramLabel
:
:
eTrue
)
;
forTrue
.
Add
(
1
)
;
forTrue
.
Add
(
1
)
;
mozilla
:
:
glean
:
:
test_only_ipc
:
:
a_labeled_counter_for_hgram
.
Get
(
"
false
"
_ns
)
.
Add
(
1
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
"
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_BOOLEAN
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
values
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
histogram
&
values
)
;
const
uint32_t
falseIndex
=
0
;
const
uint32_t
trueIndex
=
1
;
const
uint32_t
otherIndex
=
2
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countFalse
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countTrue
(
cx
.
GetJSContext
(
)
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
countOther
(
cx
.
GetJSContext
(
)
)
;
GetElement
(
cx
.
GetJSContext
(
)
falseIndex
values
&
countFalse
)
;
GetElement
(
cx
.
GetJSContext
(
)
trueIndex
values
&
countTrue
)
;
GetElement
(
cx
.
GetJSContext
(
)
otherIndex
values
&
countOther
)
;
uint32_t
uCountFalse
=
0
;
uint32_t
uCountTrue
=
0
;
uint32_t
uCountOther
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countFalse
&
uCountFalse
)
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countTrue
&
uCountTrue
)
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
countOther
&
uCountOther
)
;
ASSERT_EQ
(
1u
uCountFalse
)
;
ASSERT_EQ
(
2u
uCountTrue
)
;
ASSERT_EQ
(
0u
uCountOther
)
;
}
TEST_F
(
TelemetryTestFixture
GIFFTLabeledCounterToKeyedCountHgram
)
{
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_KEYED_COUNT
"
_ns
true
)
;
nsCString
empty
;
ASSERT_EQ
(
NS_OK
mozilla
:
:
glean
:
:
impl
:
:
fog_test_reset
(
&
empty
&
empty
)
)
;
mozilla
:
:
glean
:
:
test_only_ipc
:
:
a_labeled_counter_for_keyed_count_hgram
.
Get
(
"
aLabel
"
_ns
)
.
Add
(
3
)
;
mozilla
:
:
glean
:
:
test_only_ipc
:
:
a_labeled_counter_for_keyed_count_hgram
.
Get
(
"
some
other
label
"
_ns
)
.
Add
(
4
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
"
&
snapshot
true
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_KEYED_COUNT
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
expectedKeyData
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
aLabel
"
histogram
&
expectedKeyData
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
sum
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
expectedKeyData
&
sum
)
;
uint32_t
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
3u
uSum
)
<
<
"
The
'
aLabel
'
hgram
has
incorrect
sum
.
"
;
GetProperty
(
cx
.
GetJSContext
(
)
"
some
other
label
"
histogram
&
expectedKeyData
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
sum
"
expectedKeyData
&
sum
)
;
uSum
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
sum
&
uSum
)
;
ASSERT_EQ
(
4u
uSum
)
<
<
"
The
'
some
other
label
'
hgram
has
incorrect
sum
.
"
;
}
TEST_F
(
TelemetryTestFixture
GIFFTLabeledCounterToCategoricalHgram
)
{
AutoJSContextWithGlobal
cx
(
mCleanGlobal
)
;
GetAndClearHistogram
(
cx
.
GetJSContext
(
)
mTelemetry
"
TELEMETRY_TEST_CATEGORICAL_OPTOUT
"
_ns
false
)
;
nsCString
empty
;
ASSERT_EQ
(
NS_OK
mozilla
:
:
glean
:
:
impl
:
:
fog_test_reset
(
&
empty
&
empty
)
)
;
mozilla
:
:
glean
:
:
test_only_ipc
:
:
a_labeled_counter_for_categorical
.
EnumGet
(
mozilla
:
:
glean
:
:
test_only_ipc
:
:
ALabeledCounterForCategoricalLabel
:
:
eCommonlabel
)
.
Add
(
1
)
;
mozilla
:
:
glean
:
:
test_only_ipc
:
:
a_labeled_counter_for_categorical
.
Get
(
"
CommonLabel
"
_ns
)
.
Add
(
1
)
;
mozilla
:
:
glean
:
:
test_only_ipc
:
:
a_labeled_counter_for_categorical
.
Get
(
"
Label5
"
_ns
)
.
Add
(
1
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
snapshot
(
cx
.
GetJSContext
(
)
)
;
GetSnapshots
(
cx
.
GetJSContext
(
)
mTelemetry
"
"
&
snapshot
false
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
histogram
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
TELEMETRY_TEST_CATEGORICAL_OPTOUT
"
snapshot
&
histogram
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
values
(
cx
.
GetJSContext
(
)
)
;
GetProperty
(
cx
.
GetJSContext
(
)
"
values
"
histogram
&
values
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
value
(
cx
.
GetJSContext
(
)
)
;
GetElement
(
cx
.
GetJSContext
(
)
static_cast
<
uint32_t
>
(
Telemetry
:
:
LABELS_TELEMETRY_TEST_CATEGORICAL_OPTOUT
:
:
CommonLabel
)
values
&
value
)
;
uint32_t
uValue
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
value
&
uValue
)
;
ASSERT_EQ
(
2u
uValue
)
<
<
"
CommonLabel
has
incorrect
value
"
;
GetElement
(
cx
.
GetJSContext
(
)
static_cast
<
uint32_t
>
(
Telemetry
:
:
LABELS_TELEMETRY_TEST_CATEGORICAL_OPTOUT
:
:
Label5
)
values
&
value
)
;
uValue
=
0
;
JS
:
:
ToUint32
(
cx
.
GetJSContext
(
)
value
&
uValue
)
;
ASSERT_EQ
(
1u
uValue
)
<
<
"
Label5
has
incorrect
value
"
;
}
