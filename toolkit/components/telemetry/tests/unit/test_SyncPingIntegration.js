Services
.
prefs
.
setBoolPref
(
"
toolkit
.
telemetry
.
testing
.
overrideProductsCheck
"
true
)
;
add_setup
(
async
function
test_setup
(
)
{
do_get_profile
(
)
;
}
)
;
add_task
(
async
function
test_register_twice_fails
(
)
{
TelemetryController
.
registerSyncPingShutdown
(
(
)
=
>
{
}
)
;
Assert
.
throws
(
(
)
=
>
TelemetryController
.
registerSyncPingShutdown
(
(
)
=
>
{
}
)
/
The
sync
ping
shutdown
handler
is
already
registered
.
/
)
;
await
TelemetryController
.
testReset
(
)
;
}
)
;
add_task
(
async
function
test_reset_clears_handler
(
)
{
await
TelemetryController
.
testSetup
(
)
;
TelemetryController
.
registerSyncPingShutdown
(
(
)
=
>
{
}
)
;
await
TelemetryController
.
testReset
(
)
;
TelemetryController
.
registerSyncPingShutdown
(
(
)
=
>
{
}
)
;
await
TelemetryController
.
testReset
(
)
;
}
)
;
add_task
(
async
function
test_shutdown_handler_submits
(
)
{
let
handlerCalled
=
false
;
await
TelemetryController
.
testSetup
(
)
;
TelemetryController
.
registerSyncPingShutdown
(
(
)
=
>
{
handlerCalled
=
true
;
let
ping
=
{
why
:
"
shutdown
"
}
;
TelemetryController
.
submitExternalPing
(
"
sync
"
ping
)
;
}
)
;
await
TelemetryController
.
testShutdown
(
)
;
Assert
.
ok
(
handlerCalled
)
;
await
TelemetryController
.
testReset
(
)
;
}
)
;
add_task
(
async
function
test_shutdown_handler_no_submit
(
)
{
let
handlerCalled
=
false
;
await
TelemetryController
.
testSetup
(
)
;
TelemetryController
.
registerSyncPingShutdown
(
(
)
=
>
{
handlerCalled
=
true
;
}
)
;
await
TelemetryController
.
testShutdown
(
)
;
Assert
.
ok
(
handlerCalled
)
;
}
)
;
