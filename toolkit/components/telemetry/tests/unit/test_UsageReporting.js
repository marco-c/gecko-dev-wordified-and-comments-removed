"
use
strict
"
;
const
{
ProfileAge
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
ProfileAge
.
sys
.
mjs
"
)
;
const
{
UsageReporting
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
UsageReporting
.
sys
.
mjs
"
)
;
const
{
ClientEnvironmentBase
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
components
-
utils
/
ClientEnvironment
.
sys
.
mjs
"
)
;
add_task
(
async
function
setup
(
)
{
do_get_profile
(
true
)
;
await
setEmptyPrefWatchlist
(
)
;
await
TelemetryController
.
testSetup
(
)
;
Services
.
fog
.
initializeFOG
(
)
;
}
)
;
add_task
(
async
function
test_prefs
(
)
{
Services
.
prefs
.
setBoolPref
(
"
datareporting
.
usage
.
uploadEnabled
"
true
)
;
GleanPings
.
usageReporting
.
setEnabled
(
true
)
;
GleanPings
.
usageDeletionRequest
.
setEnabled
(
true
)
;
const
kTestUuid
=
"
decafdec
-
afde
-
cafd
-
ecaf
-
decafdecafde
"
;
Glean
.
usage
.
profileId
.
set
(
kTestUuid
)
;
Assert
.
equal
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
deletion
-
request
"
)
)
;
let
deletionRequestSubmitted
=
false
;
GleanPings
.
usageDeletionRequest
.
testBeforeNextSubmit
(
reason
=
>
{
deletionRequestSubmitted
=
true
;
Assert
.
equal
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
deletion
-
request
"
)
)
;
Assert
.
equal
(
reason
"
set_upload_enabled
"
)
;
}
)
;
Services
.
prefs
.
setBoolPref
(
"
datareporting
.
usage
.
uploadEnabled
"
false
)
;
Assert
.
ok
(
deletionRequestSubmitted
"
'
usage
-
deletion
-
request
'
ping
submitted
"
)
;
Assert
.
equal
(
null
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Services
.
prefs
.
setBoolPref
(
"
datareporting
.
usage
.
uploadEnabled
"
true
)
;
let
os
=
ClientEnvironmentBase
.
os
;
const
testOs
=
Services
.
appinfo
.
OS
;
const
testOsVersion
=
os
.
version
;
const
testWindowsBuildNumber
=
os
.
windowsBuildNumber
;
const
testAppBuild
=
Services
.
appinfo
.
appBuildID
;
const
testAppDisplayVersion
=
ClientEnvironmentBase
.
version
;
const
testChannel
=
ClientEnvironmentBase
.
channel
;
const
testIsDefault
=
ClientEnvironmentBase
.
isDefaultBrowser
;
const
testDistributionId
=
ClientEnvironmentBase
.
distribution
;
await
UsageReporting
.
ensureInitialized
(
)
;
let
profileAccessor
=
await
ProfileAge
(
)
;
let
firstUse
=
new
Date
(
await
profileAccessor
.
firstUse
)
;
let
usageReportingSubmitted
=
false
;
GleanPings
.
usageReporting
.
testBeforeNextSubmit
(
_reason
=
>
{
usageReportingSubmitted
=
true
;
Assert
.
notEqual
(
null
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
notEqual
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
testOs
Glean
.
usage
.
os
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
testOsVersion
Glean
.
usage
.
osVersion
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
testWindowsBuildNumber
Glean
.
usage
.
windowsBuildNumber
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
greater
(
Glean
.
usage
.
windowsUserProfileAgeInDays
.
testGetValue
(
)
0
"
The
Windows
user
profile
is
not
supposed
to
be
created
today
in
our
tests
.
"
)
;
Assert
.
equal
(
testAppBuild
Glean
.
usage
.
appBuild
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
testAppDisplayVersion
Glean
.
usage
.
appDisplayVersion
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
testChannel
Glean
.
usage
.
appChannel
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
testIsDefault
Glean
.
usage
.
isDefaultBrowser
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
testDistributionId
Glean
.
usage
.
distributionId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
let
firstUsedTruncatedToDay
=
new
Date
(
firstUse
)
;
firstUsedTruncatedToDay
.
setHours
(
0
)
;
firstUsedTruncatedToDay
.
setMinutes
(
0
)
;
firstUsedTruncatedToDay
.
setSeconds
(
0
)
;
firstUsedTruncatedToDay
.
setMilliseconds
(
0
)
;
Assert
.
equal
(
firstUsedTruncatedToDay
.
getTime
(
)
Glean
.
usage
.
firstRunDate
.
testGetValue
(
"
usage
-
reporting
"
)
.
getTime
(
)
)
;
}
)
;
GleanPings
.
usageReporting
.
submit
(
)
;
Assert
.
ok
(
usageReportingSubmitted
"
'
usage
-
reporting
'
ping
submitted
"
)
;
}
)
;
