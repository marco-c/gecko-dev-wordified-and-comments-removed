"
use
strict
"
;
add_task
(
async
function
setup
(
)
{
do_get_profile
(
true
)
;
await
setEmptyPrefWatchlist
(
)
;
await
TelemetryController
.
testSetup
(
)
;
Services
.
fog
.
initializeFOG
(
)
;
}
)
;
add_task
(
async
function
test_prefs
(
)
{
Services
.
prefs
.
setBoolPref
(
"
datareporting
.
usage
.
uploadEnabled
"
true
)
;
GleanPings
.
usageReporting
.
setEnabled
(
true
)
;
GleanPings
.
usageDeletionRequest
.
setEnabled
(
true
)
;
const
kTestUuid
=
"
decafdec
-
afde
-
cafd
-
ecaf
-
decafdecafde
"
;
Glean
.
usage
.
profileId
.
set
(
kTestUuid
)
;
Assert
.
equal
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
equal
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
deletion
-
request
"
)
)
;
let
deletionRequestSubmitted
=
false
;
GleanPings
.
usageDeletionRequest
.
testBeforeNextSubmit
(
reason
=
>
{
deletionRequestSubmitted
=
true
;
Assert
.
equal
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
deletion
-
request
"
)
)
;
Assert
.
equal
(
reason
"
set_upload_enabled
"
)
;
}
)
;
Services
.
prefs
.
setBoolPref
(
"
datareporting
.
usage
.
uploadEnabled
"
false
)
;
Assert
.
ok
(
deletionRequestSubmitted
"
'
usage
-
deletion
-
request
'
ping
submitted
"
)
;
Assert
.
equal
(
null
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Services
.
prefs
.
setBoolPref
(
"
datareporting
.
usage
.
uploadEnabled
"
true
)
;
let
usageReportingSubmitted
=
false
;
GleanPings
.
usageReporting
.
testBeforeNextSubmit
(
_reason
=
>
{
usageReportingSubmitted
=
true
;
Assert
.
notEqual
(
null
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
Assert
.
notEqual
(
kTestUuid
Glean
.
usage
.
profileId
.
testGetValue
(
"
usage
-
reporting
"
)
)
;
}
)
;
GleanPings
.
usageReporting
.
submit
(
)
;
Assert
.
ok
(
usageReportingSubmitted
"
'
usage
-
reporting
'
ping
submitted
"
)
;
}
)
;
