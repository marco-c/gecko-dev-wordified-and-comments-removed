ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
httpd
.
js
"
this
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
PromiseUtils
.
jsm
"
this
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
this
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
TelemetryStorage
.
jsm
"
this
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
TelemetryController
.
jsm
"
this
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
TelemetrySession
.
jsm
"
this
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
TelemetrySend
.
jsm
"
this
)
;
var
gHttpServer
=
null
;
add_task
(
async
function
test_setup
(
)
{
do_get_profile
(
)
;
await
setEmptyPrefWatchlist
(
)
;
Services
.
prefs
.
setBoolPref
(
TelemetryUtils
.
Preferences
.
FhrUploadEnabled
true
)
;
gHttpServer
=
new
HttpServer
(
)
;
gHttpServer
.
start
(
-
1
)
;
}
)
;
add_task
(
async
function
testSendPendingOnIdleDaily
(
)
{
const
PENDING_PING
=
{
id
:
"
2133234d
-
4ea1
-
44f4
-
909e
-
ce8c6c41e0fc
"
type
:
"
test
-
ping
"
version
:
4
application
:
{
}
payload
:
{
}
}
;
await
TelemetryStorage
.
savePing
(
PENDING_PING
true
)
;
await
TelemetryController
.
testSetup
(
)
;
TelemetrySend
.
setServer
(
"
http
:
/
/
localhost
:
"
+
gHttpServer
.
identity
.
primaryPort
)
;
let
pendingPromise
=
new
Promise
(
resolve
=
>
gHttpServer
.
registerPrefixHandler
(
"
/
submit
/
telemetry
/
"
request
=
>
resolve
(
request
)
)
)
;
let
gatherPromise
=
PromiseUtils
.
defer
(
)
;
Services
.
obs
.
addObserver
(
gatherPromise
.
resolve
"
gather
-
telemetry
"
)
;
TelemetrySession
.
observe
(
null
"
idle
-
daily
"
null
)
;
await
gatherPromise
.
promise
;
Assert
.
ok
(
true
"
Received
gather
-
telemetry
notification
.
"
)
;
Services
.
obs
.
removeObserver
(
gatherPromise
.
resolve
"
gather
-
telemetry
"
)
;
let
module
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
TelemetrySend
.
jsm
"
null
)
;
module
.
TelemetrySendImpl
.
observe
(
null
"
idle
-
daily
"
null
)
;
let
request
=
await
pendingPromise
;
let
ping
=
decodeRequestPayload
(
request
)
;
Assert
.
equal
(
ping
.
id
PENDING_PING
.
id
)
;
Assert
.
equal
(
ping
.
type
PENDING_PING
.
type
)
;
await
new
Promise
(
resolve
=
>
gHttpServer
.
stop
(
resolve
)
)
;
}
)
;
