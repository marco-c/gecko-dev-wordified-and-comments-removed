"
use
strict
"
;
const
{
TelemetryController
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
TelemetryController
.
sys
.
mjs
"
)
;
const
{
TelemetrySend
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
TelemetrySend
.
sys
.
mjs
"
)
;
const
{
AsyncShutdown
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
AsyncShutdown
.
sys
.
mjs
"
)
;
function
contentHandler
(
metadata
response
)
{
dump
(
"
contentHandler
called
for
path
:
"
+
metadata
.
_path
+
"
\
n
"
)
;
response
.
processAsync
(
)
;
response
.
setHeader
(
"
Content
-
Type
"
"
text
/
plain
"
)
;
}
add_task
(
async
function
test_setup
(
)
{
do_get_profile
(
)
;
await
loadAddonManager
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
1
.
9
.
2
"
)
;
finishAddonManagerStartup
(
)
;
await
AddonTestUtils
.
getXPIExports
(
)
.
XPIDatabase
.
finalize
(
)
;
fakeIntlReady
(
)
;
await
setEmptyPrefWatchlist
(
)
;
Services
.
prefs
.
setBoolPref
(
TelemetryUtils
.
Preferences
.
FhrUploadEnabled
true
)
;
}
)
;
add_task
(
async
function
test_sendTelemetryShutsDownWithinReasonableTimeout
(
)
{
const
CRASH_TIMEOUT_MS
=
10
*
1000
;
Services
.
prefs
.
setBoolPref
(
"
toolkit
.
asyncshutdown
.
testing
"
true
)
;
Services
.
prefs
.
setIntPref
(
"
toolkit
.
asyncshutdown
.
crash_timeout
"
CRASH_TIMEOUT_MS
)
;
let
httpServer
=
new
HttpServer
(
)
;
httpServer
.
registerPrefixHandler
(
"
/
"
contentHandler
)
;
httpServer
.
start
(
-
1
)
;
await
TelemetryController
.
testSetup
(
)
;
TelemetrySend
.
setServer
(
"
http
:
/
/
localhost
:
"
+
httpServer
.
identity
.
primaryPort
)
;
let
submissionPromise
=
TelemetryController
.
submitExternalPing
(
"
test
-
ping
-
type
"
{
}
)
;
AsyncShutdown
.
profileBeforeChange
.
_trigger
(
)
;
AsyncShutdown
.
sendTelemetry
.
_trigger
(
)
;
await
submissionPromise
;
Assert
.
ok
(
true
"
Didn
'
t
time
out
on
shutdown
.
"
)
;
}
)
;
