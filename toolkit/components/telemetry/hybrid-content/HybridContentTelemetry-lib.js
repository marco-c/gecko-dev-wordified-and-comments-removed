if
(
typeof
Mozilla
=
=
"
undefined
"
)
{
var
Mozilla
=
{
}
;
}
(
function
(
)
{
"
use
strict
"
;
var
_canUpload
=
false
;
var
_initPromise
=
null
;
if
(
typeof
Mozilla
.
ContentTelemetry
=
=
"
undefined
"
)
{
Mozilla
.
ContentTelemetry
=
{
}
;
}
function
_sendMessageToChrome
(
name
data
)
{
var
event
=
new
CustomEvent
(
"
mozTelemetry
"
{
bubbles
:
true
detail
:
{
name
:
name
data
:
data
|
|
{
}
}
}
)
;
document
.
dispatchEvent
(
event
)
;
}
function
_registerInternalPolicyHandler
(
)
{
var
setupPromise
=
new
Promise
(
function
(
resolveInit
rejectInit
)
{
function
policyChangeHandler
(
updatedPref
)
{
if
(
!
(
"
detail
"
in
updatedPref
)
|
|
!
(
"
canUpload
"
in
updatedPref
.
detail
)
|
|
typeof
updatedPref
.
detail
.
canUpload
!
=
"
boolean
"
)
{
return
;
}
_canUpload
=
updatedPref
.
detail
.
canUpload
;
resolveInit
(
)
;
}
document
.
addEventListener
(
"
mozTelemetryPolicyChange
"
policyChangeHandler
)
;
document
.
addEventListener
(
"
mozTelemetryUntrustedOrigin
"
(
)
=
>
rejectInit
(
new
Error
(
"
Origin
not
trusted
or
HCT
disabled
.
"
)
)
{
once
:
true
}
)
;
}
)
;
var
timeoutPromise
=
new
Promise
(
(
resolve
reject
)
=
>
{
setTimeout
(
reject
3000
)
;
}
)
;
_initPromise
=
Promise
.
race
(
[
setupPromise
timeoutPromise
]
)
;
_sendMessageToChrome
(
"
init
"
)
;
}
Mozilla
.
ContentTelemetry
.
canUpload
=
function
(
)
{
return
_canUpload
;
}
;
Mozilla
.
ContentTelemetry
.
initPromise
=
function
(
)
{
return
_initPromise
;
}
;
Mozilla
.
ContentTelemetry
.
registerEvents
=
function
(
category
eventData
)
{
_sendMessageToChrome
(
"
registerEvents
"
{
category
:
category
eventData
:
eventData
}
)
;
}
;
Mozilla
.
ContentTelemetry
.
recordEvent
=
function
(
category
method
object
value
extra
)
{
_sendMessageToChrome
(
"
recordEvent
"
{
category
:
category
method
:
method
object
:
object
value
:
value
extra
:
extra
}
)
;
}
;
_registerInternalPolicyHandler
(
)
;
}
)
(
)
;
if
(
typeof
module
!
=
=
"
undefined
"
&
&
module
.
exports
)
{
module
.
exports
=
Mozilla
.
ContentTelemetry
;
}
