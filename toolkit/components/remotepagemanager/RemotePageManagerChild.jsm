"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
ChildMessagePort
"
]
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
remotepagemanager
/
MessagePort
.
jsm
"
)
;
function
ChildMessagePort
(
contentFrame
window
)
{
let
portID
=
Services
.
appinfo
.
processID
+
"
:
"
+
ChildMessagePort
.
prototype
.
nextPortID
+
+
;
MessagePort
.
call
(
this
contentFrame
portID
)
;
this
.
window
=
window
;
Cu
.
exportFunction
(
this
.
sendAsyncMessage
.
bind
(
this
)
window
{
defineAs
:
"
RPMSendAsyncMessage
"
}
)
;
Cu
.
exportFunction
(
this
.
addMessageListener
.
bind
(
this
)
window
{
defineAs
:
"
RPMAddMessageListener
"
allowCallbacks
:
true
}
)
;
Cu
.
exportFunction
(
this
.
removeMessageListener
.
bind
(
this
)
window
{
defineAs
:
"
RPMRemoveMessageListener
"
allowCallbacks
:
true
}
)
;
Cu
.
exportFunction
(
this
.
getBoolPref
.
bind
(
this
)
window
{
defineAs
:
"
RPMGetBoolPref
"
}
)
;
Cu
.
exportFunction
(
this
.
setBoolPref
.
bind
(
this
)
window
{
defineAs
:
"
RPMSetBoolPref
"
}
)
;
Cu
.
exportFunction
(
this
.
getFormatURLPref
.
bind
(
this
)
window
{
defineAs
:
"
RPMGetFormatURLPref
"
}
)
;
Cu
.
exportFunction
(
this
.
isWindowPrivate
.
bind
(
this
)
window
{
defineAs
:
"
RPMIsWindowPrivate
"
}
)
;
let
loadListener
=
(
)
=
>
{
this
.
sendAsyncMessage
(
"
RemotePage
:
Load
"
)
;
window
.
removeEventListener
(
"
load
"
loadListener
)
;
}
;
window
.
addEventListener
(
"
load
"
loadListener
)
;
window
.
addEventListener
(
"
unload
"
(
)
=
>
{
try
{
this
.
sendAsyncMessage
(
"
RemotePage
:
Unload
"
)
;
}
catch
(
e
)
{
}
this
.
destroy
(
)
;
}
)
;
this
.
messageManager
.
sendAsyncMessage
(
"
RemotePage
:
InitPort
"
{
portID
url
:
window
.
document
.
documentURI
.
replace
(
/
[
\
#
|
\
?
]
.
*
/
"
"
)
}
)
;
}
ChildMessagePort
.
prototype
=
Object
.
create
(
MessagePort
.
prototype
)
;
ChildMessagePort
.
prototype
.
nextPortID
=
0
;
ChildMessagePort
.
prototype
.
message
=
function
(
{
data
:
messagedata
}
)
{
if
(
this
.
destroyed
|
|
(
messagedata
.
portID
!
=
this
.
portID
)
)
{
return
;
}
let
message
=
{
name
:
messagedata
.
name
data
:
messagedata
.
data
}
;
this
.
listener
.
callListeners
(
Cu
.
cloneInto
(
message
this
.
window
)
)
;
}
;
ChildMessagePort
.
prototype
.
destroy
=
function
(
)
{
this
.
window
=
null
;
MessagePort
.
prototype
.
destroy
.
call
(
this
)
;
}
;
var
registeredURLs
=
new
Set
(
Services
.
cpmm
.
initialProcessData
[
"
RemotePageManager
:
urls
"
]
)
;
var
observer
=
(
window
)
=
>
{
let
url
=
window
.
document
.
documentURI
.
replace
(
/
[
\
#
|
\
?
]
.
*
/
"
"
)
;
if
(
!
registeredURLs
.
has
(
url
)
)
return
;
let
messageManager
=
window
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDocShell
)
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIContentFrameMessageManager
)
;
new
ChildMessagePort
(
messageManager
window
)
;
}
;
Services
.
obs
.
addObserver
(
observer
"
chrome
-
document
-
global
-
created
"
)
;
Services
.
obs
.
addObserver
(
observer
"
content
-
document
-
global
-
created
"
)
;
Services
.
cpmm
.
addMessageListener
(
"
RemotePage
:
Register
"
(
{
data
}
)
=
>
{
for
(
let
url
of
data
.
urls
)
registeredURLs
.
add
(
url
)
;
}
)
;
Services
.
cpmm
.
addMessageListener
(
"
RemotePage
:
Unregister
"
(
{
data
}
)
=
>
{
for
(
let
url
of
data
.
urls
)
registeredURLs
.
delete
(
url
)
;
}
)
;
