#
ifndef
nsUrlClassifierPrefixSet_h_
#
define
nsUrlClassifierPrefixSet_h_
#
include
"
nsIUrlClassifierPrefixSet
.
h
"
#
include
"
nsISupports
.
h
"
#
include
"
nsToolkitCompsCID
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
mozilla
/
FileUtils
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
Poison
.
h
"
class
nsIInputStream
;
class
nsIOutputStream
;
namespace
mozilla
{
namespace
safebrowsing
{
class
VariableLengthPrefixSet
;
}
}
class
nsUrlClassifierPrefixSet
final
:
public
nsIUrlClassifierPrefixSet
{
public
:
nsUrlClassifierPrefixSet
(
)
;
NS_IMETHOD
Init
(
const
nsACString
&
aName
)
override
;
NS_IMETHOD
SetPrefixes
(
const
uint32_t
*
aArray
uint32_t
aLength
)
override
;
NS_IMETHOD
GetPrefixes
(
uint32_t
*
aCount
uint32_t
*
*
aPrefixes
)
override
;
NS_IMETHOD
Contains
(
uint32_t
aPrefix
bool
*
aFound
)
override
;
NS_IMETHOD
IsEmpty
(
bool
*
aEmpty
)
override
;
nsresult
GetPrefixesNative
(
FallibleTArray
<
uint32_t
>
&
outArray
)
;
nsresult
WritePrefixes
(
nsCOMPtr
<
nsIOutputStream
>
&
out
)
const
;
nsresult
LoadPrefixes
(
nsCOMPtr
<
nsIInputStream
>
&
in
)
;
uint32_t
CalculatePreallocateSize
(
)
const
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
const
;
NS_DECL_THREADSAFE_ISUPPORTS
friend
class
mozilla
:
:
safebrowsing
:
:
VariableLengthPrefixSet
;
private
:
virtual
~
nsUrlClassifierPrefixSet
(
)
;
static
const
uint32_t
DELTAS_LIMIT
=
120
;
static
const
uint32_t
MAX_INDEX_DIFF
=
(
1
<
<
16
)
;
static
const
uint32_t
PREFIXSET_VERSION_MAGIC
=
1
;
void
Clear
(
)
REQUIRES
(
mLock
)
;
nsresult
MakePrefixSet
(
const
uint32_t
*
aArray
uint32_t
aLength
)
REQUIRES
(
mLock
)
;
uint32_t
BinSearch
(
uint32_t
start
uint32_t
end
uint32_t
target
)
const
REQUIRES
(
mLock
)
;
bool
IsEmptyInternal
(
)
const
REQUIRES
(
mLock
)
;
mutable
mozilla
:
:
Mutex
mLock
;
nsTArray
<
uint32_t
>
mIndexPrefixes
GUARDED_BY
(
mLock
)
;
nsTArray
<
nsTArray
<
uint16_t
>
>
mIndexDeltas
GUARDED_BY
(
mLock
)
;
uint32_t
mTotalPrefixes
GUARDED_BY
(
mLock
)
;
nsCString
mName
;
mozilla
:
:
CorruptionCanary
mCanary
;
}
;
#
endif
