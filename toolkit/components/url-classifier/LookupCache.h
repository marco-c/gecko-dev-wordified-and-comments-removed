#
ifndef
LookupCache_h__
#
define
LookupCache_h__
#
include
"
Entries
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIFile
.
h
"
#
include
"
nsIFileStreams
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsUrlClassifierPrefixSet
.
h
"
#
include
"
VariableLengthPrefixSet
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
namespace
mozilla
{
namespace
safebrowsing
{
#
define
MAX_HOST_COMPONENTS
5
#
define
MAX_PATH_COMPONENTS
4
class
LookupResult
{
public
:
LookupResult
(
)
:
mNoise
(
false
)
mProtocolConfirmed
(
false
)
mPartialHashLength
(
0
)
mConfirmed
(
false
)
mProtocolV2
(
true
)
{
}
union
{
Prefix
fixedLengthPrefix
;
Completion
complete
;
}
hash
;
const
Completion
&
CompleteHash
(
)
{
MOZ_ASSERT
(
!
mNoise
)
;
return
hash
.
complete
;
}
nsCString
PartialHash
(
)
{
MOZ_ASSERT
(
mPartialHashLength
<
=
COMPLETE_SIZE
)
;
return
nsCString
(
reinterpret_cast
<
char
*
>
(
hash
.
complete
.
buf
)
mPartialHashLength
)
;
}
nsCString
PartialHashHex
(
)
{
nsAutoCString
hex
;
for
(
size_t
i
=
0
;
i
<
mPartialHashLength
;
i
+
+
)
{
hex
.
AppendPrintf
(
"
%
.
2X
"
hash
.
complete
.
buf
[
i
]
)
;
}
return
hex
;
}
bool
Confirmed
(
)
const
{
return
mConfirmed
|
|
mProtocolConfirmed
;
}
bool
Complete
(
)
const
{
return
mPartialHashLength
=
=
COMPLETE_SIZE
;
}
bool
mNoise
;
bool
mProtocolConfirmed
;
nsCString
mTableName
;
uint32_t
mPartialHashLength
;
bool
mConfirmed
;
bool
mProtocolV2
;
}
;
typedef
nsTArray
<
LookupResult
>
LookupResultArray
;
struct
CacheResult
{
AddComplete
entry
;
nsCString
table
;
bool
operator
=
=
(
const
CacheResult
&
aOther
)
const
{
if
(
entry
!
=
aOther
.
entry
)
{
return
false
;
}
return
table
=
=
aOther
.
table
;
}
}
;
typedef
nsTArray
<
CacheResult
>
CacheResultArray
;
class
LookupCache
{
public
:
static
bool
IsCanonicalizedIP
(
const
nsACString
&
aHost
)
;
static
nsresult
GetLookupFragments
(
const
nsACString
&
aSpec
nsTArray
<
nsCString
>
*
aFragments
)
;
static
nsresult
GetHostKeys
(
const
nsACString
&
aSpec
nsTArray
<
nsCString
>
*
aHostKeys
)
;
LookupCache
(
const
nsACString
&
aTableName
const
nsACString
&
aProvider
nsIFile
*
aStoreFile
)
;
virtual
~
LookupCache
(
)
{
}
const
nsCString
&
TableName
(
)
const
{
return
mTableName
;
}
nsresult
UpdateRootDirHandle
(
nsIFile
*
aRootStoreDirectory
)
;
nsresult
AddCompletionsToCache
(
AddCompleteArray
&
aAddCompletes
)
;
nsresult
WriteFile
(
)
;
void
ClearCache
(
)
;
bool
IsPrimed
(
)
const
{
return
mPrimed
;
}
;
#
if
DEBUG
void
DumpCache
(
)
;
#
endif
virtual
nsresult
Open
(
)
;
virtual
nsresult
Init
(
)
=
0
;
virtual
nsresult
ClearPrefixes
(
)
=
0
;
virtual
nsresult
Has
(
const
Completion
&
aCompletion
bool
*
aHas
uint32_t
*
aMatchLength
bool
*
aFromCache
)
=
0
;
virtual
void
IsHashEntryConfirmed
(
const
Completion
&
aEntry
const
TableFreshnessMap
&
aTableFreshness
uint32_t
aFreshnessGuarantee
bool
*
aConfirmed
)
=
0
;
virtual
bool
IsEmpty
(
)
=
0
;
virtual
void
ClearAll
(
)
;
template
<
typename
T
>
static
T
*
Cast
(
LookupCache
*
aThat
)
{
return
(
(
aThat
&
&
T
:
:
VER
=
=
aThat
-
>
Ver
(
)
)
?
reinterpret_cast
<
T
*
>
(
aThat
)
:
nullptr
)
;
}
private
:
nsresult
Reset
(
)
;
nsresult
LoadPrefixSet
(
)
;
virtual
nsresult
StoreToFile
(
nsIFile
*
aFile
)
=
0
;
virtual
nsresult
LoadFromFile
(
nsIFile
*
aFile
)
=
0
;
virtual
size_t
SizeOfPrefixSet
(
)
=
0
;
virtual
int
Ver
(
)
const
=
0
;
protected
:
bool
mPrimed
;
nsCString
mTableName
;
nsCString
mProvider
;
nsCOMPtr
<
nsIFile
>
mRootStoreDirectory
;
nsCOMPtr
<
nsIFile
>
mStoreDirectory
;
CompletionArray
mGetHashCache
;
friend
class
PerProviderDirectoryTestUtils
;
}
;
class
LookupCacheV2
final
:
public
LookupCache
{
public
:
explicit
LookupCacheV2
(
const
nsACString
&
aTableName
const
nsACString
&
aProvider
nsIFile
*
aStoreFile
)
:
LookupCache
(
aTableName
aProvider
aStoreFile
)
{
}
~
LookupCacheV2
(
)
{
}
virtual
nsresult
Init
(
)
override
;
virtual
nsresult
Open
(
)
override
;
virtual
void
ClearAll
(
)
override
;
virtual
nsresult
Has
(
const
Completion
&
aCompletion
bool
*
aHas
uint32_t
*
aMatchLength
bool
*
aFromCache
)
override
;
virtual
void
IsHashEntryConfirmed
(
const
Completion
&
aEntry
const
TableFreshnessMap
&
aTableFreshness
uint32_t
aFreshnessGuarantee
bool
*
aConfirmed
)
override
;
virtual
bool
IsEmpty
(
)
override
;
nsresult
Build
(
AddPrefixArray
&
aAddPrefixes
AddCompleteArray
&
aAddCompletes
)
;
nsresult
GetPrefixes
(
FallibleTArray
<
uint32_t
>
&
aAddPrefixes
)
;
#
if
DEBUG
void
DumpCompletions
(
)
;
#
endif
static
const
int
VER
;
protected
:
nsresult
ReadCompletions
(
)
;
virtual
nsresult
ClearPrefixes
(
)
override
;
virtual
nsresult
StoreToFile
(
nsIFile
*
aFile
)
override
;
virtual
nsresult
LoadFromFile
(
nsIFile
*
aFile
)
override
;
virtual
size_t
SizeOfPrefixSet
(
)
override
;
private
:
virtual
int
Ver
(
)
const
override
{
return
VER
;
}
nsresult
ConstructPrefixSet
(
AddPrefixArray
&
aAddPrefixes
)
;
CompletionArray
mUpdateCompletions
;
RefPtr
<
nsUrlClassifierPrefixSet
>
mPrefixSet
;
}
;
}
}
#
endif
