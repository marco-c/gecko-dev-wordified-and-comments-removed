#
ifndef
LookupCache_h__
#
define
LookupCache_h__
#
include
"
Entries
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIFile
.
h
"
#
include
"
nsIFileStreams
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsUrlClassifierPrefixSet
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
namespace
mozilla
{
namespace
safebrowsing
{
#
define
MAX_HOST_COMPONENTS
5
#
define
MAX_PATH_COMPONENTS
4
class
LookupResult
{
public
:
LookupResult
(
)
:
mComplete
(
false
)
mNoise
(
false
)
mFresh
(
false
)
mProtocolConfirmed
(
false
)
{
}
union
{
Prefix
prefix
;
Completion
complete
;
}
hash
;
const
Prefix
&
PrefixHash
(
)
{
return
hash
.
prefix
;
}
const
Completion
&
CompleteHash
(
)
{
MOZ_ASSERT
(
!
mNoise
)
;
return
hash
.
complete
;
}
bool
Confirmed
(
)
const
{
return
(
mComplete
&
&
mFresh
)
|
|
mProtocolConfirmed
;
}
bool
Complete
(
)
const
{
return
mComplete
;
}
bool
mComplete
;
bool
mNoise
;
bool
mFresh
;
bool
mProtocolConfirmed
;
nsCString
mTableName
;
}
;
typedef
nsTArray
<
LookupResult
>
LookupResultArray
;
struct
CacheResult
{
AddComplete
entry
;
nsCString
table
;
bool
operator
=
=
(
const
CacheResult
&
aOther
)
const
{
if
(
entry
!
=
aOther
.
entry
)
{
return
false
;
}
return
table
=
=
aOther
.
table
;
}
}
;
typedef
nsTArray
<
CacheResult
>
CacheResultArray
;
class
LookupCache
{
public
:
static
bool
IsCanonicalizedIP
(
const
nsACString
&
aHost
)
;
static
nsresult
GetLookupFragments
(
const
nsACString
&
aSpec
nsTArray
<
nsCString
>
*
aFragments
)
;
static
nsresult
GetHostKeys
(
const
nsACString
&
aSpec
nsTArray
<
nsCString
>
*
aHostKeys
)
;
LookupCache
(
const
nsACString
&
aTableName
nsIFile
*
aStoreFile
)
;
~
LookupCache
(
)
;
const
nsCString
&
TableName
(
)
const
{
return
mTableName
;
}
nsresult
Init
(
)
;
nsresult
Open
(
)
;
nsresult
UpdateRootDirHandle
(
nsIFile
*
aRootStoreDirectory
)
;
nsresult
Build
(
AddPrefixArray
&
aAddPrefixes
AddCompleteArray
&
aAddCompletes
)
;
nsresult
AddCompletionsToCache
(
AddCompleteArray
&
aAddCompletes
)
;
nsresult
GetPrefixes
(
FallibleTArray
<
uint32_t
>
&
aAddPrefixes
)
;
void
ClearUpdatedCompletions
(
)
;
void
ClearCache
(
)
;
#
if
DEBUG
void
DumpCache
(
)
;
void
Dump
(
)
;
#
endif
nsresult
WriteFile
(
)
;
nsresult
Has
(
const
Completion
&
aCompletion
bool
*
aHas
bool
*
aComplete
)
;
bool
IsPrimed
(
)
;
private
:
void
ClearAll
(
)
;
nsresult
Reset
(
)
;
nsresult
ReadCompletions
(
)
;
nsresult
LoadPrefixSet
(
)
;
nsresult
LoadCompletions
(
)
;
nsresult
ConstructPrefixSet
(
AddPrefixArray
&
aAddPrefixes
)
;
bool
mPrimed
;
nsCString
mTableName
;
nsCOMPtr
<
nsIFile
>
mRootStoreDirectory
;
nsCOMPtr
<
nsIFile
>
mStoreDirectory
;
RefPtr
<
nsUrlClassifierPrefixSet
>
mPrefixSet
;
CompletionArray
mUpdateCompletions
;
CompletionArray
mGetHashCache
;
friend
class
PerProviderDirectoryTestUtils
;
}
;
}
}
#
endif
