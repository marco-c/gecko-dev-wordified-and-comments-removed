if
(
typeof
(
classifierHelper
)
=
=
"
undefined
"
)
{
var
classifierHelper
=
{
}
;
}
const
CLASSIFIER_COMMON_URL
=
SimpleTest
.
getTestFileURL
(
"
classifierCommon
.
js
"
)
;
var
gScript
=
SpecialPowers
.
loadChromeScript
(
CLASSIFIER_COMMON_URL
)
;
const
ADD_CHUNKNUM
=
524
;
const
SUB_CHUNKNUM
=
523
;
const
HASHLEN
=
32
;
const
PREFS
=
{
PROVIDER_LISTS
:
"
browser
.
safebrowsing
.
provider
.
mozilla
.
lists
"
DISALLOW_COMPLETIONS
:
"
urlclassifier
.
disallow_completions
"
PROVIDER_GETHASHURL
:
"
browser
.
safebrowsing
.
provider
.
mozilla
.
gethashURL
"
}
;
classifierHelper
.
_updates
=
[
]
;
classifierHelper
.
_updatesToCleanup
=
[
]
;
classifierHelper
.
_initsCB
=
[
]
;
classifierHelper
.
waitForInit
=
function
(
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
classifierHelper
.
_initsCB
.
push
(
resolve
)
;
gScript
.
sendAsyncMessage
(
"
waitForInit
"
)
;
}
)
;
}
classifierHelper
.
allowCompletion
=
function
(
lists
url
)
{
for
(
var
list
of
lists
)
{
var
pref
=
SpecialPowers
.
getCharPref
(
PREFS
.
PROVIDER_LISTS
)
;
pref
+
=
"
"
+
list
;
SpecialPowers
.
setCharPref
(
PREFS
.
PROVIDER_LISTS
pref
)
;
pref
=
SpecialPowers
.
getCharPref
(
PREFS
.
DISALLOW_COMPLETIONS
)
;
pref
=
pref
.
replace
(
list
list
+
"
-
backup
"
)
;
SpecialPowers
.
setCharPref
(
PREFS
.
DISALLOW_COMPLETIONS
pref
)
;
}
SpecialPowers
.
setCharPref
(
PREFS
.
PROVIDER_GETHASHURL
url
)
;
}
classifierHelper
.
addUrlToDB
=
function
(
updateData
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
var
testUpdate
=
"
"
;
for
(
var
update
of
updateData
)
{
var
LISTNAME
=
update
.
db
;
var
CHUNKDATA
=
update
.
url
;
var
CHUNKLEN
=
CHUNKDATA
.
length
;
var
HASHLEN
=
update
.
len
?
update
.
len
:
32
;
classifierHelper
.
_updatesToCleanup
.
push
(
update
)
;
testUpdate
+
=
"
n
:
1000
\
n
"
+
"
i
:
"
+
LISTNAME
+
"
\
n
"
+
"
ad
:
1
\
n
"
+
"
a
:
"
+
ADD_CHUNKNUM
+
"
:
"
+
HASHLEN
+
"
:
"
+
CHUNKLEN
+
"
\
n
"
+
CHUNKDATA
;
}
classifierHelper
.
_update
(
testUpdate
resolve
reject
)
;
}
)
;
}
classifierHelper
.
removeUrlFromDB
=
function
(
updateData
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
var
testUpdate
=
"
"
;
for
(
var
update
of
updateData
)
{
var
LISTNAME
=
update
.
db
;
var
CHUNKDATA
=
ADD_CHUNKNUM
+
"
:
"
+
update
.
url
;
var
CHUNKLEN
=
CHUNKDATA
.
length
;
var
HASHLEN
=
update
.
len
?
update
.
len
:
32
;
testUpdate
+
=
"
n
:
1000
\
n
"
+
"
i
:
"
+
LISTNAME
+
"
\
n
"
+
"
s
:
"
+
SUB_CHUNKNUM
+
"
:
"
+
HASHLEN
+
"
:
"
+
CHUNKLEN
+
"
\
n
"
+
CHUNKDATA
;
}
classifierHelper
.
_updatesToCleanup
=
classifierHelper
.
_updatesToCleanup
.
filter
(
(
v
)
=
>
{
return
updateData
.
indexOf
(
v
)
=
=
-
1
;
}
)
;
classifierHelper
.
_update
(
testUpdate
resolve
reject
)
;
}
)
;
}
;
classifierHelper
.
resetDatabase
=
function
(
)
{
function
removeDatabase
(
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
var
testUpdate
=
"
"
;
for
(
var
update
of
classifierHelper
.
_updatesToCleanup
)
{
if
(
testUpdate
.
includes
(
update
.
db
)
)
continue
;
testUpdate
+
=
"
n
:
1000
\
n
"
+
"
i
:
"
+
update
.
db
+
"
\
n
"
+
"
ad
:
"
+
ADD_CHUNKNUM
+
"
\
n
"
+
"
sd
:
"
+
SUB_CHUNKNUM
+
"
\
n
"
}
classifierHelper
.
_update
(
testUpdate
resolve
reject
)
;
}
)
;
}
return
Promise
.
resolve
(
)
.
then
(
removeDatabase
)
.
then
(
classifierHelper
.
reloadDatabase
)
;
}
;
classifierHelper
.
reloadDatabase
=
function
(
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
gScript
.
addMessageListener
(
"
reloadSuccess
"
function
handler
(
)
{
gScript
.
removeMessageListener
(
'
reloadSuccess
'
handler
)
;
resolve
(
)
;
}
)
;
gScript
.
sendAsyncMessage
(
"
doReload
"
)
;
}
)
;
}
classifierHelper
.
_update
=
function
(
testUpdate
onsuccess
onerror
)
{
classifierHelper
.
_updates
.
push
(
{
"
data
"
:
testUpdate
"
onsuccess
"
:
onsuccess
"
onerror
"
:
onerror
}
)
;
if
(
classifierHelper
.
_updates
.
length
!
=
1
)
{
return
;
}
gScript
.
sendAsyncMessage
(
"
doUpdate
"
{
testUpdate
}
)
;
}
;
classifierHelper
.
_updateSuccess
=
function
(
)
{
var
update
=
classifierHelper
.
_updates
.
shift
(
)
;
update
.
onsuccess
(
)
;
if
(
classifierHelper
.
_updates
.
length
)
{
var
testUpdate
=
classifierHelper
.
_updates
[
0
]
.
data
;
gScript
.
sendAsyncMessage
(
"
doUpdate
"
{
testUpdate
}
)
;
}
}
;
classifierHelper
.
_updateError
=
function
(
errorCode
)
{
var
update
=
classifierHelper
.
_updates
.
shift
(
)
;
update
.
onerror
(
errorCode
)
;
if
(
classifierHelper
.
_updates
.
length
)
{
var
testUpdate
=
classifierHelper
.
_updates
[
0
]
.
data
;
gScript
.
sendAsyncMessage
(
"
doUpdate
"
{
testUpdate
}
)
;
}
}
;
classifierHelper
.
_inited
=
function
(
)
{
classifierHelper
.
_initsCB
.
forEach
(
function
(
cb
)
{
cb
(
)
;
}
)
;
classifierHelper
.
_initsCB
=
[
]
;
}
;
classifierHelper
.
_setup
=
function
(
)
{
gScript
.
addMessageListener
(
"
updateSuccess
"
classifierHelper
.
_updateSuccess
)
;
gScript
.
addMessageListener
(
"
updateError
"
classifierHelper
.
_updateError
)
;
gScript
.
addMessageListener
(
"
safeBrowsingInited
"
classifierHelper
.
_inited
)
;
SimpleTest
.
registerCleanupFunction
(
classifierHelper
.
_cleanup
)
;
}
;
classifierHelper
.
_cleanup
=
function
(
)
{
for
(
var
pref
in
PREFS
)
{
SpecialPowers
.
clearUserPref
(
pref
)
;
}
if
(
!
classifierHelper
.
_updatesToCleanup
)
{
return
Promise
.
resolve
(
)
;
}
return
classifierHelper
.
resetDatabase
(
)
;
}
;
classifierHelper
.
_setup
(
)
;
