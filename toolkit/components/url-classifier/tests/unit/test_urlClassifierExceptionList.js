"
use
strict
"
;
const
ALLOW_LIST_BASELINE_PREF
=
"
privacy
.
trackingprotection
.
allow_list
.
baseline
.
enabled
"
;
const
ALLOW_LIST_CONVENIENCE_PREF
=
"
privacy
.
trackingprotection
.
allow_list
.
convenience
.
enabled
"
;
function
rsObjectToEntry
(
rsObject
)
{
let
entry
=
Cc
[
"
mozilla
.
org
/
url
-
classifier
/
exception
-
list
-
entry
;
1
"
]
.
createInstance
(
Ci
.
nsIUrlClassifierExceptionListEntry
)
;
let
{
category
:
categoryStr
urlPattern
topLevelUrlPattern
=
"
"
isPrivateBrowsingOnly
=
false
filterContentBlockingCategories
=
[
]
classifierFeatures
=
[
]
}
=
rsObject
;
const
CATEGORY_STR_TO_ENUM
=
{
"
internal
-
pref
"
:
Ci
.
nsIUrlClassifierExceptionListEntry
.
CATEGORY_INTERNAL_PREF
baseline
:
Ci
.
nsIUrlClassifierExceptionListEntry
.
CATEGORY_BASELINE
convenience
:
Ci
.
nsIUrlClassifierExceptionListEntry
.
CATEGORY_CONVENIENCE
}
;
let
category
=
CATEGORY_STR_TO_ENUM
[
categoryStr
]
;
entry
.
init
(
category
urlPattern
topLevelUrlPattern
isPrivateBrowsingOnly
filterContentBlockingCategories
classifierFeatures
)
;
return
entry
;
}
add_task
(
async
function
test_exception_list_lookups
(
)
{
let
list
=
Cc
[
"
mozilla
.
org
/
url
-
classifier
/
exception
-
list
;
1
"
]
.
createInstance
(
Ci
.
nsIUrlClassifierExceptionList
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
tracker
.
com
/
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
com
/
"
)
false
)
"
Exception
list
with
no
entries
should
not
match
tracker
.
com
"
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
internal
-
pref
"
urlPattern
:
"
*
:
/
/
tracker
.
com
/
*
"
topLevelUrlPattern
:
"
*
:
/
/
example
.
com
/
*
"
}
)
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
internal
-
pref
"
urlPattern
:
"
*
:
/
/
*
.
sub
.
tracker
.
com
/
*
"
topLevelUrlPattern
:
"
*
:
/
/
*
.
example
.
org
/
*
"
}
)
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
internal
-
pref
"
urlPattern
:
"
*
:
/
/
tracker
.
org
/
*
"
}
)
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
internal
-
pref
"
urlPattern
:
"
*
:
/
/
foo
.
tracker
.
org
/
*
"
}
)
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
internal
-
pref
"
urlPattern
:
"
*
:
/
/
foo
.
bar
.
tracker
.
org
/
*
"
}
)
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
com
/
foo
"
)
false
)
"
Exception
list
should
match
tracker
.
com
under
example
.
com
.
"
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
not
match
tracker
.
com
under
example
.
org
.
"
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
foo
.
sub
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
foo
.
bar
.
example
.
org
/
foo
/
bar
"
)
false
)
"
Exception
list
should
match
foo
.
sub
.
tracker
.
com
under
foo
.
bar
.
example
.
org
.
"
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
tracker
.
org
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
mozilla
.
org
/
foo
/
bar
"
)
false
)
"
Exception
list
should
match
tracker
.
org
under
mozilla
.
org
.
"
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
foo
.
bar
.
tracker
.
org
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
mozilla
.
org
/
foo
/
bar
"
)
false
)
"
Exception
list
should
match
foo
.
bar
.
tracker
.
org
under
mozilla
.
org
.
"
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
sub
.
foo
.
bar
.
tracker
.
org
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
mozilla
.
org
/
foo
/
bar
"
)
false
)
"
Exception
list
should
not
match
sub
.
foo
.
bar
.
tracker
.
org
under
mozilla
.
org
.
"
)
;
}
)
;
add_task
(
async
function
test_exception_list_lookups_with_category_prefs
(
)
{
let
list
=
Cc
[
"
mozilla
.
org
/
url
-
classifier
/
exception
-
list
;
1
"
]
.
createInstance
(
Ci
.
nsIUrlClassifierExceptionList
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
internal
-
pref
"
urlPattern
:
"
*
:
/
/
tracker
.
com
/
*
"
}
)
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
baseline
"
urlPattern
:
"
*
:
/
/
foo
.
tracker
.
com
/
*
"
}
)
)
;
list
.
addEntry
(
rsObjectToEntry
(
{
category
:
"
convenience
"
urlPattern
:
"
*
:
/
/
bar
.
tracker
.
com
/
*
"
}
)
)
;
info
(
"
Start
with
both
allow
-
list
categories
disabled
.
"
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_BASELINE_PREF
false
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_CONVENIENCE_PREF
false
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
match
tracker
.
com
when
both
allow
-
list
categories
are
disabled
.
"
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
foo
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
not
match
foo
.
tracker
.
com
because
baseline
allow
-
list
is
disabled
.
"
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
bar
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
not
match
bar
.
tracker
.
com
because
convenience
allow
-
list
is
disabled
.
"
)
;
info
(
"
Enable
only
the
baseline
allow
-
list
.
"
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_BASELINE_PREF
true
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_CONVENIENCE_PREF
false
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
match
tracker
.
com
when
only
the
baseline
allow
-
list
is
enabled
.
"
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
foo
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
match
foo
.
tracker
.
com
because
baseline
allow
-
list
is
enabled
.
"
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
bar
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
not
match
bar
.
tracker
.
com
because
convenience
allow
-
list
is
disabled
.
"
)
;
info
(
"
Enable
both
allow
-
list
categories
.
"
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_BASELINE_PREF
true
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_CONVENIENCE_PREF
true
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
match
tracker
.
com
when
both
allow
-
list
categories
are
enabled
.
"
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
foo
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
match
foo
.
tracker
.
com
because
baseline
allow
-
list
is
enabled
.
"
)
;
Assert
.
ok
(
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
bar
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
not
match
bar
.
tracker
.
com
because
convenience
allow
-
list
is
enabled
.
"
)
;
info
(
"
Enable
only
the
convenience
allow
-
list
.
Convenience
should
not
apply
because
baseline
is
disabled
.
"
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_BASELINE_PREF
false
)
;
Services
.
prefs
.
setBoolPref
(
ALLOW_LIST_CONVENIENCE_PREF
true
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
foo
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
not
match
foo
.
tracker
.
com
because
baseline
allow
-
list
is
disabled
.
"
)
;
Assert
.
ok
(
!
list
.
matches
(
Services
.
io
.
newURI
(
"
https
:
/
/
bar
.
tracker
.
com
/
bar
"
)
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
org
/
foo
"
)
false
)
"
Exception
list
should
not
match
bar
.
tracker
.
com
even
when
convenience
allow
-
list
is
enabled
because
baseline
is
disabled
.
"
)
;
Services
.
prefs
.
clearUserPref
(
ALLOW_LIST_BASELINE_PREF
)
;
Services
.
prefs
.
clearUserPref
(
ALLOW_LIST_CONVENIENCE_PREF
)
;
}
)
;
