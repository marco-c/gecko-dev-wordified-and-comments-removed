#
include
"
string
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
HashStore
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsPrintfCString
.
h
"
static
const
char
*
kFilesInV2
[
]
=
{
"
.
vlpset
"
"
.
sbstore
"
}
;
static
const
char
*
kFilesInV4
[
]
=
{
"
.
vlpset
"
"
.
metadata
"
}
;
#
define
GTEST_MALWARE_TABLE_V4
NS_LITERAL_CSTRING
(
"
goog
-
malware
-
proto
"
)
#
define
GTEST_PHISH_TABLE_V4
NS_LITERAL_CSTRING
(
"
goog
-
phish
-
proto
"
)
#
define
ROOT_DIR
NS_LITERAL_STRING
(
"
safebrowsing
"
)
#
define
SB_FILE
(
x
y
)
NS_ConvertUTF8toUTF16
(
nsPrintfCString
(
"
%
s
%
s
"
x
y
)
)
template
<
typename
T
size_t
N
>
static
void
CheckFileExist
(
const
nsCString
&
aTable
const
T
(
&
aFiles
)
[
N
]
bool
aExpectExists
const
char
*
aMsg
=
nullptr
)
{
for
(
uint32_t
i
=
0
;
i
<
N
;
i
+
+
)
{
NS_ConvertUTF8toUTF16
SUB_DIR
(
strstr
(
aTable
.
get
(
)
"
-
proto
"
)
?
"
google4
"
:
"
"
)
;
nsCOMPtr
<
nsIFile
>
file
=
GetFile
(
nsTArray
<
nsString
>
{
ROOT_DIR
SUB_DIR
SB_FILE
(
aTable
.
get
(
)
aFiles
[
i
]
)
}
)
;
bool
exists
;
file
-
>
Exists
(
&
exists
)
;
if
(
aMsg
)
{
ASSERT_EQ
(
aExpectExists
exists
)
<
<
file
-
>
HumanReadablePath
(
)
.
get
(
)
<
<
"
"
<
<
aMsg
;
}
else
{
ASSERT_EQ
(
aExpectExists
exists
)
<
<
file
-
>
HumanReadablePath
(
)
.
get
(
)
;
}
}
}
TEST
(
UrlClassifierFailUpdate
CheckTableReset
)
{
const
bool
FULL_UPDATE
=
true
;
const
bool
PARTIAL_UPDATE
=
false
;
{
RefPtr
<
TableUpdateV2
>
update
=
new
TableUpdateV2
(
GTEST_TABLE_V2
)
;
Unused
<
<
update
-
>
NewAddChunk
(
1
)
;
ApplyUpdate
(
update
)
;
CheckFileExist
(
GTEST_TABLE_V2
kFilesInV2
true
"
V2
update
doesn
'
t
create
vlpset
or
sbstore
"
)
;
}
auto
func
=
[
]
(
RefPtr
<
TableUpdateV4
>
update
bool
full
const
char
*
str
)
{
update
-
>
SetFullUpdate
(
full
)
;
nsCString
prefix
(
str
)
;
update
-
>
NewPrefixes
(
prefix
.
Length
(
)
prefix
)
;
}
;
{
RefPtr
<
TableUpdateV4
>
update
=
new
TableUpdateV4
(
GTEST_MALWARE_TABLE_V4
)
;
func
(
update
FULL_UPDATE
"
test_prefix
"
)
;
ApplyUpdate
(
update
)
;
CheckFileExist
(
GTEST_MALWARE_TABLE_V4
kFilesInV4
true
"
v4
update
doesn
'
t
create
vlpset
or
metadata
"
)
;
}
{
RefPtr
<
TableUpdateV4
>
update
=
new
TableUpdateV4
(
GTEST_PHISH_TABLE_V4
)
;
func
(
update
FULL_UPDATE
"
test_prefix
"
)
;
ApplyUpdate
(
update
)
;
CheckFileExist
(
GTEST_PHISH_TABLE_V4
kFilesInV4
true
"
v4
update
doesn
'
t
create
vlpset
or
metadata
"
)
;
}
{
RefPtr
<
TableUpdateV4
>
update
=
new
TableUpdateV4
(
GTEST_MALWARE_TABLE_V4
)
;
func
(
update
PARTIAL_UPDATE
"
test_prefix
"
)
;
ApplyUpdate
(
update
)
;
CheckFileExist
(
GTEST_MALWARE_TABLE_V4
kFilesInV4
false
"
a
fail
v4
update
doesn
'
t
remove
the
tables
"
)
;
CheckFileExist
(
GTEST_TABLE_V2
kFilesInV2
true
"
a
fail
v4
update
removes
a
v2
table
"
)
;
CheckFileExist
(
GTEST_PHISH_TABLE_V4
kFilesInV4
true
"
a
fail
v4
update
removes
the
other
v4
table
"
)
;
}
}
