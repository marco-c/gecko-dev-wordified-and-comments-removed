#
ifndef
LookupCacheV4_h__
#
define
LookupCacheV4_h__
#
include
"
LookupCache
.
h
"
namespace
mozilla
{
namespace
safebrowsing
{
class
TableUpdateV4
;
class
LookupCacheV4
final
:
public
LookupCache
{
public
:
explicit
LookupCacheV4
(
const
nsACString
&
aTableName
const
nsACString
&
aProvider
nsIFile
*
aStoreFile
)
:
LookupCache
(
aTableName
aProvider
aStoreFile
)
{
}
~
LookupCacheV4
(
)
{
}
virtual
nsresult
Init
(
)
override
;
virtual
nsresult
Has
(
const
Completion
&
aCompletion
const
TableFreshnessMap
&
aTableFreshness
uint32_t
aFreshnessGuarantee
bool
*
aHas
uint32_t
*
aMatchLength
bool
*
aConfirmed
bool
*
aFromCache
)
override
;
virtual
void
ClearCache
(
)
override
;
#
if
DEBUG
virtual
void
DumpCache
(
)
override
;
#
endif
virtual
bool
IsEmpty
(
)
override
;
nsresult
Build
(
PrefixStringMap
&
aPrefixMap
)
;
nsresult
GetPrefixes
(
PrefixStringMap
&
aPrefixMap
)
;
nsresult
GetFixedLengthPrefixes
(
FallibleTArray
<
uint32_t
>
&
aPrefixes
)
;
nsresult
ApplyUpdate
(
TableUpdateV4
*
aTableUpdate
PrefixStringMap
&
aInputMap
PrefixStringMap
&
aOutputMap
)
;
nsresult
AddFullHashResponseToCache
(
const
FullHashResponseMap
&
aResponseMap
)
;
nsresult
WriteMetadata
(
TableUpdateV4
*
aTableUpdate
)
;
nsresult
LoadMetadata
(
nsACString
&
aState
nsACString
&
aChecksum
)
;
void
InvalidateExpiredCacheEntry
(
)
;
static
const
int
VER
;
protected
:
virtual
nsresult
ClearPrefixes
(
)
override
;
virtual
nsresult
StoreToFile
(
nsIFile
*
aFile
)
override
;
virtual
nsresult
LoadFromFile
(
nsIFile
*
aFile
)
override
;
virtual
size_t
SizeOfPrefixSet
(
)
override
;
private
:
virtual
int
Ver
(
)
const
override
{
return
VER
;
}
nsresult
InitCrypto
(
nsCOMPtr
<
nsICryptoHash
>
&
aCrypto
)
;
nsresult
VerifyChecksum
(
const
nsACString
&
aChecksum
)
;
RefPtr
<
VariableLengthPrefixSet
>
mVLPrefixSet
;
nsClassHashtable
<
VLHashPrefixString
CachedFullHashResponse
>
mCache
;
}
;
}
}
#
endif
