#
ifndef
nsCheckSummedOutputStream_h__
#
define
nsCheckSummedOutputStream_h__
#
include
"
nsIFile
.
h
"
#
include
"
nsIOutputStream
.
h
"
#
include
"
nsICryptoHash
.
h
"
#
include
"
nsNetCID
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsString
.
h
"
#
include
"
.
.
/
.
.
/
.
.
/
netwerk
/
base
/
nsBufferedStreams
.
h
"
#
include
"
prio
.
h
"
class
nsCheckSummedOutputStream
:
public
nsBufferedOutputStream
{
public
:
NS_DECL_ISUPPORTS_INHERITED
static
const
uint32_t
CHECKSUM_SIZE
=
16
;
static
const
uint32_t
MAX_BUFFER_SIZE
=
64
*
1024
;
nsCheckSummedOutputStream
(
)
{
}
NS_IMETHOD
Finish
(
)
override
;
NS_IMETHOD
Write
(
const
char
*
buf
uint32_t
count
uint32_t
*
result
)
override
;
NS_IMETHOD
Init
(
nsIOutputStream
*
stream
uint32_t
bufferSize
)
override
;
protected
:
virtual
~
nsCheckSummedOutputStream
(
)
{
nsBufferedOutputStream
:
:
Close
(
)
;
}
nsCOMPtr
<
nsICryptoHash
>
mHash
;
nsCString
mCheckSum
;
}
;
inline
nsresult
NS_NewCheckSummedOutputStream
(
nsIOutputStream
*
*
result
nsIFile
*
file
)
{
nsCOMPtr
<
nsIOutputStream
>
localOutFile
;
nsresult
rv
=
NS_NewSafeLocalFileOutputStream
(
getter_AddRefs
(
localOutFile
)
file
PR_WRONLY
|
PR_TRUNCATE
|
PR_CREATE_FILE
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsCOMPtr
<
nsIBufferedOutputStream
>
out
=
new
nsCheckSummedOutputStream
(
)
;
rv
=
out
-
>
Init
(
localOutFile
nsCheckSummedOutputStream
:
:
CHECKSUM_SIZE
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
out
.
forget
(
result
)
;
}
return
rv
;
}
#
endif
