const
ANCHOR_PAGE
=
data
:
text
/
html
<
a
href
=
"
about
:
blank
"
target
=
"
_blank
"
>
Click
me
!
<
/
a
>
;
const
SCRIPT_PAGE
=
data
:
text
/
html
<
script
>
window
.
open
(
"
about
:
blank
"
"
_blank
"
)
;
<
/
script
>
;
add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
browser
.
link
.
open_newwindow
"
2
]
]
}
)
;
}
)
;
function
assertFlags
(
win
)
{
let
docShell
=
win
.
docShell
;
let
loadContext
=
docShell
.
QueryInterface
(
Ci
.
nsILoadContext
)
;
let
chromeFlags
=
docShell
.
treeOwner
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIXULWindow
)
.
chromeFlags
;
Assert
.
ok
(
loadContext
.
useRemoteTabs
"
Should
be
using
remote
tabs
on
the
load
context
"
)
;
Assert
.
ok
(
chromeFlags
&
Ci
.
nsIWebBrowserChrome
.
CHROME_REMOTE_WINDOW
"
Should
have
the
remoteness
chrome
flag
on
the
window
"
)
;
}
add_task
(
async
function
test_new_remote_window_flags_target_blank
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
ANCHOR_PAGE
}
async
function
(
browser
)
{
let
newWinPromise
=
BrowserTestUtils
.
waitForNewWindow
(
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
a
"
{
}
browser
)
;
let
win
=
await
newWinPromise
;
assertFlags
(
win
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
}
)
;
add_task
(
async
function
test_new_remote_window_flags_window_open
(
)
{
let
newWinPromise
=
BrowserTestUtils
.
waitForNewWindow
(
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
SCRIPT_PAGE
}
async
function
(
browser
)
{
let
win
=
await
newWinPromise
;
assertFlags
(
win
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
}
)
;
add_task
(
async
function
test_new_remote_window_flags_content_open
(
)
{
let
newWinPromise
=
BrowserTestUtils
.
waitForNewWindow
(
)
;
await
ContentTask
.
spawn
(
gBrowser
.
selectedBrowser
null
async
function
(
)
{
content
.
open
(
"
about
:
blank
"
"
_blank
"
)
;
}
)
;
let
win
=
await
newWinPromise
;
assertFlags
(
win
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
