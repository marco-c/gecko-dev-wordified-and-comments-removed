"
use
strict
"
;
add_task
(
async
(
)
=
>
{
let
videoID
=
"
with
-
controls
"
;
await
BrowserTestUtils
.
withNewTab
(
{
url
:
TEST_PAGE_WITH_SOUND
gBrowser
}
async
browser
=
>
{
await
ensureVideosReady
(
browser
)
;
let
audioPromise
=
BrowserTestUtils
.
waitForEvent
(
browser
"
DOMAudioPlaybackStarted
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
videoID
]
async
videoID
=
>
{
await
content
.
document
.
getElementById
(
videoID
)
.
play
(
)
;
}
)
;
ok
(
!
(
await
isVideoPaused
(
browser
videoID
)
)
"
The
video
is
not
paused
.
"
)
;
await
audioPromise
;
let
tab
=
gBrowser
.
getTabForBrowser
(
browser
)
;
let
tabIconOverlay
=
tab
.
getElementsByClassName
(
"
tab
-
icon
-
overlay
"
)
[
0
]
;
let
tabAudioButton
=
tab
.
getElementsByClassName
(
"
tab
-
audio
-
button
"
)
[
0
]
;
ok
(
!
tabIconOverlay
.
hasAttribute
(
"
pictureinpicture
"
)
"
Not
using
PiP
"
)
;
ok
(
tabAudioButton
.
hasAttribute
(
"
soundplaying
"
)
"
Sound
is
playing
"
)
;
let
pipWin
=
await
triggerPictureInPicture
(
browser
videoID
)
;
ok
(
pipWin
"
Got
Picture
-
in
-
Picture
window
.
"
)
;
ok
(
!
(
await
isVideoPaused
(
browser
videoID
)
)
"
The
video
is
not
paused
.
"
)
;
ok
(
tabAudioButton
.
hasAttribute
(
"
soundplaying
"
)
"
Tab
knows
sound
is
playing
"
)
;
ok
(
tabIconOverlay
.
hasAttribute
(
"
pictureinpicture
"
)
"
Tab
knows
were
using
PiP
"
)
;
let
style
=
window
.
getComputedStyle
(
tabAudioButton
.
buttonEl
.
querySelector
(
"
.
button
-
background
"
)
)
;
Assert
.
equal
(
style
.
backgroundImage
'
url
(
"
chrome
:
/
/
browser
/
skin
/
tabbrowser
/
tab
-
audio
-
playing
-
small
.
svg
"
)
'
"
Got
the
tab
-
audio
-
button
image
"
)
;
ok
(
!
tabAudioButton
.
hasAttribute
(
"
muted
"
)
"
Tab
is
not
muted
"
)
;
tabAudioButton
.
click
(
)
;
ok
(
tabAudioButton
.
hasAttribute
(
"
muted
"
)
"
Tab
is
muted
"
)
;
tabAudioButton
.
click
(
)
;
ok
(
!
tabAudioButton
.
hasAttribute
(
"
muted
"
)
"
Tab
is
not
muted
"
)
;
}
)
;
}
)
;
