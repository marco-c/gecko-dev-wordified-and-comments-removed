"
use
strict
"
;
var
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
ExtensionUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
ProxyScriptContext
"
"
resource
:
/
/
gre
/
modules
/
ProxyScriptContext
.
jsm
"
)
;
var
{
SingletonEventManager
}
=
ExtensionUtils
;
let
proxyScriptContextMap
=
new
WeakMap
(
)
;
extensions
.
on
(
"
shutdown
"
(
type
extension
)
=
>
{
let
proxyScriptContext
=
proxyScriptContextMap
.
get
(
extension
)
;
if
(
proxyScriptContext
)
{
proxyScriptContext
.
unload
(
)
;
proxyScriptContextMap
.
delete
(
extension
)
;
}
}
)
;
extensions
.
registerSchemaAPI
(
"
proxy
"
"
addon_parent
"
context
=
>
{
let
{
extension
}
=
context
;
return
{
proxy
:
{
registerProxyScript
:
(
url
)
=
>
{
if
(
proxyScriptContextMap
.
has
(
extension
)
)
{
proxyScriptContextMap
.
get
(
extension
)
.
unload
(
)
;
proxyScriptContextMap
.
delete
(
extension
)
;
}
let
proxyScriptContext
=
new
ProxyScriptContext
(
extension
url
)
;
if
(
proxyScriptContext
.
load
(
)
)
{
proxyScriptContextMap
.
set
(
extension
proxyScriptContext
)
;
}
}
onProxyError
:
new
SingletonEventManager
(
context
"
proxy
.
onProxyError
"
fire
=
>
{
let
listener
=
(
name
error
)
=
>
{
fire
.
async
(
error
)
;
}
;
extension
.
on
(
"
proxy
-
error
"
listener
)
;
return
(
)
=
>
{
extension
.
off
(
"
proxy
-
error
"
listener
)
;
}
;
}
)
.
api
(
)
}
}
;
}
)
;
