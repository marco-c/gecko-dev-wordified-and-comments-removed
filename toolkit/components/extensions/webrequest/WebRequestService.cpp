#
include
"
WebRequestService
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
nsIChannel
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
using
namespace
mozilla
:
:
extensions
;
static
WebRequestService
*
sWeakWebRequestService
;
WebRequestService
:
:
~
WebRequestService
(
)
{
sWeakWebRequestService
=
nullptr
;
}
WebRequestService
&
WebRequestService
:
:
GetSingleton
(
)
{
static
RefPtr
<
WebRequestService
>
instance
;
if
(
!
sWeakWebRequestService
)
{
instance
=
new
WebRequestService
(
)
;
ClearOnShutdown
(
&
instance
)
;
sWeakWebRequestService
=
instance
;
}
return
*
sWeakWebRequestService
;
}
UniquePtr
<
WebRequestChannelEntry
>
WebRequestService
:
:
RegisterChannel
(
ChannelWrapper
*
aChannel
)
{
UniquePtr
<
ChannelEntry
>
entry
(
new
ChannelEntry
(
aChannel
)
)
;
auto
key
=
mChannelEntries
.
LookupForAdd
(
entry
-
>
mChannelId
)
;
MOZ_DIAGNOSTIC_ASSERT
(
!
key
)
;
key
.
OrInsert
(
[
&
entry
]
(
)
{
return
entry
.
get
(
)
;
}
)
;
return
std
:
:
move
(
entry
)
;
}
already_AddRefed
<
nsITraceableChannel
>
WebRequestService
:
:
GetTraceableChannel
(
uint64_t
aChannelId
nsAtom
*
aAddonId
nsIContentParent
*
aContentParent
)
{
if
(
auto
entry
=
mChannelEntries
.
Get
(
aChannelId
)
)
{
if
(
entry
-
>
mChannel
)
{
return
entry
-
>
mChannel
-
>
GetTraceableChannel
(
aAddonId
aContentParent
)
;
}
}
return
nullptr
;
}
WebRequestChannelEntry
:
:
WebRequestChannelEntry
(
ChannelWrapper
*
aChannel
)
:
mChannelId
(
aChannel
-
>
Id
(
)
)
mChannel
(
aChannel
)
{
}
WebRequestChannelEntry
:
:
~
WebRequestChannelEntry
(
)
{
if
(
sWeakWebRequestService
)
{
sWeakWebRequestService
-
>
mChannelEntries
.
Remove
(
mChannelId
)
;
}
}
