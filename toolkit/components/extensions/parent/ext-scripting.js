"
use
strict
"
;
var
{
ExtensionError
}
=
ExtensionUtils
;
const
execute
=
(
tab
context
details
kind
method
)
=
>
{
let
options
=
{
jsPaths
:
[
]
extensionId
:
context
.
extension
.
id
}
;
options
.
hasActiveTabPermission
=
tab
.
hasActiveTabPermission
;
options
.
matches
=
tab
.
extension
.
allowedOrigins
.
patterns
.
map
(
host
=
>
host
.
pattern
)
;
if
(
details
.
codeToExecute
)
{
options
[
{
kind
}
Code
]
=
details
.
codeToExecute
;
}
if
(
details
.
files
)
{
for
(
const
file
of
details
.
files
)
{
let
url
=
context
.
uri
.
resolve
(
file
)
;
if
(
!
tab
.
extension
.
isExtensionURL
(
url
)
)
{
return
Promise
.
reject
(
{
message
:
"
Files
to
be
injected
must
be
within
the
extension
"
}
)
;
}
options
[
{
kind
}
Paths
]
.
push
(
url
)
;
}
}
let
{
frameIds
allFrames
}
=
details
.
target
;
if
(
allFrames
&
&
frameIds
)
{
throw
new
ExtensionError
(
"
Cannot
specify
both
'
allFrames
'
and
'
frameIds
'
.
"
)
;
}
if
(
allFrames
)
{
options
.
allFrames
=
allFrames
;
}
else
if
(
frameIds
)
{
options
.
frameIds
=
frameIds
;
}
options
.
runAt
=
"
document_idle
"
;
options
.
wantReturnValue
=
true
;
options
.
returnResultsWithFrameIds
=
kind
=
=
=
"
js
"
;
return
tab
.
queryContent
(
"
Execute
"
options
)
;
}
;
this
.
scripting
=
class
extends
ExtensionAPI
{
getAPI
(
context
)
{
const
{
extension
}
=
context
;
const
{
tabManager
}
=
extension
;
return
{
scripting
:
{
executeScriptInternal
:
async
details
=
>
{
let
{
tabId
}
=
details
.
target
;
let
tab
=
tabManager
.
get
(
tabId
)
;
return
execute
(
tab
context
details
"
js
"
"
executeScript
"
)
;
}
}
}
;
}
}
;
