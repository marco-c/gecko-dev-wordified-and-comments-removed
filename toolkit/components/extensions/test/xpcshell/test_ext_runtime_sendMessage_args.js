"
use
strict
"
;
add_task
(
async
function
(
)
{
const
ID1
=
"
sendMessage1
tests
.
mozilla
.
org
"
;
const
ID2
=
"
sendMessage2
tests
.
mozilla
.
org
"
;
let
extension1
=
ExtensionTestUtils
.
loadExtension
(
{
background
(
)
{
browser
.
test
.
onMessage
.
addListener
(
(
.
.
.
args
)
=
>
{
browser
.
runtime
.
sendMessage
(
.
.
.
args
)
;
}
)
;
let
frame
=
document
.
createElement
(
"
iframe
"
)
;
frame
.
src
=
"
page
.
html
"
;
document
.
body
.
appendChild
(
frame
)
;
}
manifest
:
{
applications
:
{
gecko
:
{
id
:
ID1
}
}
}
files
:
{
"
page
.
js
"
:
function
(
)
{
browser
.
runtime
.
onMessage
.
addListener
(
(
msg
sender
)
=
>
{
browser
.
test
.
sendMessage
(
"
received
-
page
"
{
msg
sender
}
)
;
}
)
;
browser
.
test
.
sendMessage
(
"
page
-
ready
"
)
;
}
"
page
.
html
"
:
<
!
DOCTYPE
html
>
<
meta
charset
=
"
utf
-
8
"
>
<
script
src
=
"
page
.
js
"
>
<
/
script
>
}
}
)
;
let
extension2
=
ExtensionTestUtils
.
loadExtension
(
{
background
(
)
{
browser
.
runtime
.
onMessageExternal
.
addListener
(
(
msg
sender
)
=
>
{
browser
.
test
.
sendMessage
(
"
received
-
external
"
{
msg
sender
}
)
;
}
)
;
}
manifest
:
{
applications
:
{
gecko
:
{
id
:
ID2
}
}
}
}
)
;
await
Promise
.
all
(
[
extension1
.
startup
(
)
extension2
.
startup
(
)
]
)
;
await
extension1
.
awaitMessage
(
"
page
-
ready
"
)
;
async
function
checkLocalMessage
(
msg
)
{
let
result
=
await
extension1
.
awaitMessage
(
"
received
-
page
"
)
;
deepEqual
(
result
.
msg
msg
"
Received
internal
message
"
)
;
equal
(
result
.
sender
.
id
ID1
"
Received
correct
sender
id
"
)
;
}
async
function
checkRemoteMessage
(
msg
)
{
let
result
=
await
extension2
.
awaitMessage
(
"
received
-
external
"
)
;
deepEqual
(
result
.
msg
msg
"
Received
cross
-
extension
message
"
)
;
equal
(
result
.
sender
.
id
ID1
"
Received
correct
sender
id
"
)
;
}
extension1
.
sendMessage
(
null
)
;
await
checkLocalMessage
(
null
)
;
extension1
.
sendMessage
(
"
message
"
)
;
await
checkLocalMessage
(
"
message
"
)
;
extension1
.
sendMessage
(
ID2
"
message
"
)
;
await
checkRemoteMessage
(
"
message
"
)
;
extension1
.
sendMessage
(
ID2
{
msg
:
"
message
"
}
)
;
await
checkRemoteMessage
(
{
msg
:
"
message
"
}
)
;
extension1
.
sendMessage
(
"
message
"
{
}
)
;
await
checkLocalMessage
(
"
message
"
)
;
extension1
.
sendMessage
(
"
message
"
undefined
)
;
await
checkLocalMessage
(
"
message
"
)
;
extension1
.
sendMessage
(
ID2
"
message
"
{
}
)
;
await
checkRemoteMessage
(
"
message
"
)
;
extension1
.
sendMessage
(
ID2
"
message
"
undefined
)
;
await
checkRemoteMessage
(
"
message
"
)
;
extension1
.
sendMessage
(
ID2
"
message
"
{
}
null
)
;
await
checkRemoteMessage
(
"
message
"
)
;
await
Promise
.
all
(
[
extension1
.
unload
(
)
extension2
.
unload
(
)
]
)
;
}
)
;
add_task
(
async
function
test_sendMessage_to_badid
(
)
{
const
extension
=
ExtensionTestUtils
.
loadExtension
(
{
async
background
(
)
{
await
browser
.
test
.
assertRejects
(
browser
.
runtime
.
sendMessage
(
"
badid
test
-
extension
"
"
fake
-
message
"
)
/
Could
not
establish
connection
.
Receiving
end
does
not
exist
.
/
"
Got
the
expected
error
message
on
sendMessage
to
badid
ext
"
)
;
browser
.
test
.
sendMessage
(
"
test
-
done
"
)
;
}
}
)
;
await
extension
.
startup
(
)
;
await
extension
.
awaitMessage
(
"
test
-
done
"
)
;
await
extension
.
unload
(
)
;
}
)
;
