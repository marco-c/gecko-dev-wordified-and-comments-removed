"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
this
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ExtensionCommon
.
jsm
"
this
)
;
var
{
BaseContext
}
=
ExtensionCommon
;
class
Context
extends
BaseContext
{
constructor
(
principal
)
{
super
(
)
;
Object
.
defineProperty
(
this
"
principal
"
{
value
:
principal
configurable
:
true
}
)
;
this
.
sandbox
=
Cu
.
Sandbox
(
principal
{
wantXrays
:
false
}
)
;
this
.
extension
=
{
id
:
"
test
web
.
extension
"
}
;
}
get
cloneScope
(
)
{
return
this
.
sandbox
;
}
}
async
function
withContext
(
f
)
{
const
ssm
=
Services
.
scriptSecurityManager
;
const
PRINCIPAL1
=
ssm
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
www
.
example
.
org
"
)
;
const
context
=
new
Context
(
PRINCIPAL1
)
;
try
{
await
f
(
context
)
;
}
finally
{
await
context
.
unload
(
)
;
}
}
async
function
withSyncContext
(
f
)
{
const
STORAGE_SYNC_PREF
=
"
webextensions
.
storage
.
sync
.
enabled
"
;
let
prefs
=
Services
.
prefs
;
try
{
prefs
.
setBoolPref
(
STORAGE_SYNC_PREF
true
)
;
await
withContext
(
f
)
;
}
finally
{
prefs
.
clearUserPref
(
STORAGE_SYNC_PREF
)
;
}
}
