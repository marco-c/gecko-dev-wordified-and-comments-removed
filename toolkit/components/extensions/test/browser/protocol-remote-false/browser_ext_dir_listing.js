"
use
strict
"
;
const
{
AddonTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
AddonTestUtils
.
sys
.
mjs
"
)
;
const
{
ExtensionTestCommon
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
ExtensionTestCommon
.
sys
.
mjs
"
)
;
AddonTestUtils
.
initMochitest
(
this
)
;
async
function
checkNoFileOrJarURLs
(
extensionURL
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
extensionURL
}
async
browser
=
>
{
info
(
"
Successfully
loaded
extension
root
page
"
)
;
let
title
=
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
{
return
content
.
document
.
title
;
}
)
;
is
(
title
Index
of
{
extensionURL
}
Page
title
should
start
with
"
Index
of
moz
-
extension
:
/
/
"
got
:
{
title
}
)
;
let
hasManifest
=
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
{
for
(
let
elem
of
content
.
document
.
querySelectorAll
(
"
[
href
]
"
)
)
{
let
url
=
elem
.
href
;
if
(
url
.
endsWith
(
"
manifest
.
json
"
)
)
{
return
true
;
}
}
return
false
;
}
)
;
ok
(
hasManifest
"
Directory
listing
should
include
manifest
.
json
"
)
;
let
invalidURLs
=
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
{
let
invalid
=
[
]
;
for
(
let
elem
of
content
.
document
.
querySelectorAll
(
"
[
href
]
[
src
]
"
)
)
{
let
url
=
elem
.
href
|
|
elem
.
src
;
if
(
url
.
startsWith
(
"
file
:
"
)
|
|
url
.
startsWith
(
"
jar
:
"
)
)
{
invalid
.
push
(
elem
.
outerHTML
)
;
}
}
return
invalid
;
}
)
;
Assert
.
deepEqual
(
invalidURLs
[
]
"
No
URLs
should
use
file
:
/
/
or
jar
:
/
/
schemes
.
"
)
;
}
)
;
}
add_task
(
async
function
test_webextension_dir_listing
(
)
{
is
(
Services
.
prefs
.
getBoolPref
(
"
extensions
.
webextensions
.
protocol
.
remote
"
)
false
"
extensions
.
webextensions
.
protocol
.
remote
should
be
false
"
)
;
let
policy
=
WebExtensionPolicy
.
getByID
(
"
mochikit
mozilla
.
org
"
)
;
ok
(
policy
"
This
extension
must
exist
"
)
;
let
extensionURL
=
policy
.
getURL
(
"
/
"
)
;
info
(
Extension
base
URL
:
{
extensionURL
}
)
;
await
checkNoFileOrJarURLs
(
extensionURL
)
;
}
)
;
add_task
(
async
function
test_temp_webextension_dir_listing
(
)
{
is
(
Services
.
prefs
.
getBoolPref
(
"
extensions
.
webextensions
.
protocol
.
remote
"
)
false
"
extensions
.
webextensions
.
protocol
.
remote
should
be
false
"
)
;
const
ID
=
"
addon
tests
.
mozilla
.
org
"
;
const
addonDir
=
AddonTestUtils
.
tempDir
.
clone
(
)
.
clone
(
)
;
addonDir
.
append
(
"
exttest
"
)
;
await
AddonTestUtils
.
promiseWriteFilesToDir
(
addonDir
.
path
ExtensionTestCommon
.
generateFiles
(
{
manifest
:
{
browser_specific_settings
:
{
gecko
:
{
id
:
ID
}
}
version
:
"
1
.
0
"
}
}
)
)
;
let
startupPromise
=
AddonTestUtils
.
promiseWebExtensionStartup
(
ID
)
;
let
addon
=
await
AddonManager
.
installTemporaryAddon
(
addonDir
)
;
await
startupPromise
;
let
policy
=
WebExtensionPolicy
.
getByID
(
ID
)
;
ok
(
policy
"
Extension
policy
found
"
)
;
let
extensionURL
=
policy
.
getURL
(
"
/
"
)
;
info
(
Temporary
extension
base
URL
:
{
extensionURL
}
)
;
await
checkNoFileOrJarURLs
(
extensionURL
)
;
await
addon
.
uninstall
(
)
;
addonDir
.
remove
(
true
)
;
}
)
;
