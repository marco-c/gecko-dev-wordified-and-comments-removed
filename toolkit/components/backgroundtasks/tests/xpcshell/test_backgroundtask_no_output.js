add_task
(
async
function
test_backgroundtask_no_output
(
)
{
let
sentinel
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
;
sentinel
=
sentinel
.
substring
(
1
sentinel
.
length
-
1
)
;
let
count
=
2
;
let
outputLines
=
[
]
;
let
exitCode
=
await
do_backgroundtask
(
"
no_output
"
{
extraArgs
:
[
sentinel
count
.
toString
(
)
]
onStdoutLine
:
line
=
>
outputLines
.
push
(
line
)
}
)
;
Assert
.
equal
(
0
exitCode
)
;
if
(
AppConstants
.
platform
!
=
=
"
win
"
)
{
ok
(
outputLines
.
every
(
l
=
>
!
l
.
includes
(
"
*
*
*
You
are
running
in
"
)
)
"
Should
not
have
logs
by
default
"
)
;
}
}
)
;
add_task
(
async
function
test_backgroundtask_ignore_no_output
(
)
{
let
sentinel
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
;
sentinel
=
sentinel
.
substring
(
1
sentinel
.
length
-
1
)
;
let
count
=
2
;
let
outputLines
=
[
]
;
let
exitCode
=
await
do_backgroundtask
(
"
no_output
"
{
extraArgs
:
[
sentinel
count
.
toString
(
)
]
extraEnv
:
{
MOZ_BACKGROUNDTASKS_IGNORE_NO_OUTPUT
:
"
1
"
}
onStdoutLine
:
line
=
>
{
if
(
line
.
includes
(
sentinel
)
)
{
outputLines
.
push
(
line
)
;
}
}
}
)
;
Assert
.
equal
(
0
exitCode
)
;
Assert
.
equal
(
count
outputLines
.
length
)
;
}
)
;
