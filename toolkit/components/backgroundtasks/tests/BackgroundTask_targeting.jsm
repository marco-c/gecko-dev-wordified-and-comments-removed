const
EXPORTED_SYMBOLS
=
[
"
runBackgroundTask
"
]
;
const
{
EXIT_CODE
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
BackgroundTasksManager
.
jsm
"
)
.
BackgroundTasksManager
;
const
{
ASRouterTargeting
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouterTargeting
.
sys
.
mjs
"
)
;
const
EXCLUDED_NAMES
=
[
"
region
"
"
needsUpdate
"
]
;
async
function
runBackgroundTask
(
commandLine
)
{
let
exitCode
=
EXIT_CODE
.
SUCCESS
;
let
target
=
ASRouterTargeting
.
Environment
;
let
environment
=
{
}
;
for
(
let
name
of
Object
.
keys
(
target
)
)
{
if
(
EXCLUDED_NAMES
.
includes
(
name
)
)
{
continue
;
}
try
{
console
.
debug
(
Fetching
property
{
name
}
)
;
environment
[
name
]
=
await
target
[
name
]
;
}
catch
(
e
)
{
exitCode
=
11
;
console
.
error
(
Caught
exception
for
property
{
name
}
:
e
)
;
}
}
console
.
log
(
ASRouterTargeting
.
Environment
:
environment
)
;
console
.
error
(
runBackgroundTask
:
exiting
with
status
{
exitCode
}
)
;
return
exitCode
;
}
