var
{
FormHistory
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
FormHistory
.
sys
.
mjs
"
)
;
add_task
(
async
function
test
(
)
{
let
windowsToClose
=
[
]
;
let
testURI
=
"
http
:
/
/
example
.
com
/
tests
/
toolkit
/
components
/
satchel
/
test
/
subtst_privbrowsing
.
html
"
;
async
function
doTest
(
aShouldValueExist
aWindow
)
{
let
browser
=
aWindow
.
gBrowser
.
selectedBrowser
;
BrowserTestUtils
.
loadURIString
(
browser
testURI
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
let
count
=
await
FormHistory
.
count
(
{
fieldname
:
"
field
"
value
:
"
value
"
}
)
;
if
(
aShouldValueExist
)
{
Assert
.
equal
(
count
1
"
In
non
-
PB
mode
we
add
a
single
entry
"
)
;
}
else
{
Assert
.
equal
(
count
0
"
In
PB
mode
we
don
'
t
add
any
entries
"
)
;
}
}
function
testOnWindow
(
aOptions
aCallback
)
{
return
BrowserTestUtils
.
openNewBrowserWindow
(
aOptions
)
.
then
(
win
=
>
{
windowsToClose
.
push
(
win
)
;
return
win
;
}
)
;
}
await
testOnWindow
(
{
private
:
true
}
)
.
then
(
aWin
=
>
doTest
(
false
aWin
)
)
;
await
testOnWindow
(
{
}
)
.
then
(
aWin
=
>
doTest
(
true
aWin
)
)
;
await
Promise
.
all
(
windowsToClose
.
map
(
win
=
>
BrowserTestUtils
.
closeWindow
(
win
)
)
)
;
}
)
;
