"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
FormHistoryTestUtils
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
FormHistory
:
"
resource
:
/
/
gre
/
modules
/
FormHistory
.
jsm
"
}
)
;
var
FormHistoryTestUtils
=
{
makeListener
(
resolve
reject
)
{
let
results
=
[
]
;
return
{
_results
:
results
handleResult
(
result
)
{
results
.
push
(
result
)
;
}
handleError
(
error
)
{
reject
(
error
)
;
}
handleCompletion
(
errored
)
{
if
(
!
errored
)
{
resolve
(
results
)
;
}
}
}
;
}
async
add
(
fieldname
additions
=
[
]
)
{
additions
=
additions
.
map
(
v
=
>
(
typeof
v
=
=
"
string
"
?
{
value
:
v
}
:
v
)
)
;
for
(
let
{
value
source
}
of
additions
)
{
await
new
Promise
(
(
resolve
reject
)
=
>
{
FormHistory
.
update
(
Object
.
assign
(
{
fieldname
}
{
op
:
"
bump
"
value
source
}
)
this
.
makeListener
(
resolve
reject
)
)
;
}
)
;
}
}
async
count
(
fieldname
filters
=
{
}
)
{
let
results
=
await
new
Promise
(
(
resolve
reject
)
=
>
{
FormHistory
.
count
(
Object
.
assign
(
{
fieldname
}
filters
)
this
.
makeListener
(
resolve
reject
)
)
;
}
)
;
return
results
[
0
]
;
}
remove
(
fieldname
removals
)
{
let
changes
=
removals
.
map
(
v
=
>
{
let
criteria
=
typeof
v
=
=
"
string
"
?
{
value
:
v
}
:
v
;
return
Object
.
assign
(
{
fieldname
op
:
"
remove
"
}
criteria
)
;
}
)
;
return
new
Promise
(
(
resolve
reject
)
=
>
{
FormHistory
.
update
(
changes
this
.
makeListener
(
resolve
reject
)
)
;
}
)
;
}
clear
(
fieldname
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
baseChange
=
fieldname
?
{
fieldname
}
:
{
}
;
FormHistory
.
update
(
Object
.
assign
(
baseChange
{
op
:
"
remove
"
}
)
this
.
makeListener
(
resolve
reject
)
)
;
}
)
;
}
search
(
fieldname
filters
=
{
}
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
FormHistory
.
search
(
null
Object
.
assign
(
{
fieldname
}
filters
)
this
.
makeListener
(
resolve
reject
)
)
;
}
)
;
}
autocomplete
(
searchString
fieldname
filters
=
{
}
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
FormHistory
.
getAutoCompleteResults
(
searchString
Object
.
assign
(
{
fieldname
}
filters
)
this
.
makeListener
(
resolve
reject
)
)
;
}
)
;
}
}
;
