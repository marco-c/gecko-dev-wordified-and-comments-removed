const
{
Sqlite
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
Sqlite
.
sys
.
mjs
"
)
;
add_task
(
async
function
(
)
{
let
testnum
=
0
;
try
{
let
testfile
=
do_get_file
(
"
formhistory_v3
.
sqlite
"
)
;
let
profileDir
=
Services
.
dirsvc
.
get
(
"
ProfD
"
Ci
.
nsIFile
)
;
let
destFile
=
profileDir
.
clone
(
)
;
destFile
.
append
(
"
formhistory
.
sqlite
"
)
;
if
(
destFile
.
exists
(
)
)
{
destFile
.
remove
(
false
)
;
}
testfile
.
copyTo
(
profileDir
"
formhistory
.
sqlite
"
)
;
Assert
.
equal
(
3
await
getDBVersion
(
testfile
)
)
;
Assert
.
ok
(
destFile
.
exists
(
)
)
;
testnum
+
+
;
destFile
=
profileDir
.
clone
(
)
;
destFile
.
append
(
"
formhistory
.
sqlite
"
)
;
let
dbConnection
=
await
Sqlite
.
openConnection
(
{
path
:
destFile
.
path
sharedMemoryCache
:
false
}
)
;
await
FormHistory
.
count
(
{
}
)
;
Assert
.
equal
(
CURRENT_SCHEMA
await
getDBVersion
(
destFile
)
)
;
Assert
.
ok
(
dbConnection
.
tableExists
(
"
moz_deleted_formhistory
"
)
)
;
dbConnection
.
close
(
)
;
Assert
.
equal
(
CURRENT_SCHEMA
await
getDBVersion
(
destFile
)
)
;
let
num
=
await
promiseCountEntries
(
"
name
-
A
"
"
value
-
A
"
)
;
Assert
.
greater
(
num
0
)
;
}
catch
(
e
)
{
throw
new
Error
(
FAILED
in
test
#
{
testnum
}
-
-
{
e
}
)
;
}
}
)
;
