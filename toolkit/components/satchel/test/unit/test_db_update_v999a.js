add_task
(
async
function
(
)
{
let
testnum
=
0
;
try
{
let
testfile
=
do_get_file
(
"
formhistory_v999a
.
sqlite
"
)
;
let
profileDir
=
Services
.
dirsvc
.
get
(
"
ProfD
"
Ci
.
nsIFile
)
;
let
destFile
=
profileDir
.
clone
(
)
;
destFile
.
append
(
"
formhistory
.
sqlite
"
)
;
if
(
destFile
.
exists
(
)
)
{
destFile
.
remove
(
false
)
;
}
testfile
.
copyTo
(
profileDir
"
formhistory
.
sqlite
"
)
;
Assert
.
equal
(
999
await
getDBVersion
(
testfile
)
)
;
testnum
+
+
;
Assert
.
greater
(
await
promiseCountEntries
(
null
null
)
0
)
;
Assert
.
equal
(
1
await
promiseCountEntries
(
"
name
-
A
"
"
value
-
A
"
)
)
;
Assert
.
equal
(
1
await
promiseCountEntries
(
"
name
-
B
"
"
value
-
B
"
)
)
;
Assert
.
equal
(
1
await
promiseCountEntries
(
"
name
-
C
"
"
value
-
C1
"
)
)
;
Assert
.
equal
(
1
await
promiseCountEntries
(
"
name
-
C
"
"
value
-
C2
"
)
)
;
Assert
.
equal
(
1
await
promiseCountEntries
(
"
name
-
E
"
"
value
-
E
"
)
)
;
Assert
.
equal
(
CURRENT_SCHEMA
await
getDBVersion
(
destFile
)
)
;
testnum
+
+
;
Assert
.
equal
(
0
await
promiseCountEntries
(
"
name
-
D
"
"
value
-
D
"
)
)
;
await
promiseUpdateEntry
(
"
add
"
"
name
-
D
"
"
value
-
D
"
)
;
Assert
.
equal
(
1
await
promiseCountEntries
(
"
name
-
D
"
"
value
-
D
"
)
)
;
await
promiseUpdateEntry
(
"
remove
"
"
name
-
D
"
"
value
-
D
"
)
;
Assert
.
equal
(
0
await
promiseCountEntries
(
"
name
-
D
"
"
value
-
D
"
)
)
;
}
catch
(
e
)
{
throw
new
Error
(
FAILED
in
test
#
{
testnum
}
-
-
{
e
}
)
;
}
}
)
;
