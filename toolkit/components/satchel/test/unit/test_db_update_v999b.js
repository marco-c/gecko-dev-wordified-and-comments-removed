var
iter
=
tests
(
)
;
function
run_test
(
)
{
do_test_pending
(
)
;
iter
.
next
(
)
;
}
function
next_test
(
)
{
iter
.
next
(
)
;
}
function
*
tests
(
)
{
let
testnum
=
0
;
try
{
let
testfile
=
do_get_file
(
"
formhistory_v999b
.
sqlite
"
)
;
let
profileDir
=
Services
.
dirsvc
.
get
(
"
ProfD
"
Ci
.
nsIFile
)
;
let
destFile
=
profileDir
.
clone
(
)
;
destFile
.
append
(
"
formhistory
.
sqlite
"
)
;
if
(
destFile
.
exists
(
)
)
{
destFile
.
remove
(
false
)
;
}
let
bakFile
=
profileDir
.
clone
(
)
;
bakFile
.
append
(
"
formhistory
.
sqlite
.
corrupt
"
)
;
if
(
bakFile
.
exists
(
)
)
{
bakFile
.
remove
(
false
)
;
}
testfile
.
copyTo
(
profileDir
"
formhistory
.
sqlite
"
)
;
Assert
.
equal
(
999
getDBVersion
(
testfile
)
)
;
let
checkZero
=
function
(
num
)
{
Assert
.
equal
(
num
0
)
;
next_test
(
)
;
}
;
let
checkOne
=
function
(
num
)
{
Assert
.
equal
(
num
1
)
;
next_test
(
)
;
}
;
testnum
+
+
;
Assert
.
ok
(
!
bakFile
.
exists
(
)
)
;
yield
countEntries
(
"
"
"
"
next_test
)
;
Assert
.
ok
(
bakFile
.
exists
(
)
)
;
bakFile
.
remove
(
false
)
;
testnum
+
+
;
yield
countEntries
(
null
null
function
(
num
)
{
Assert
.
ok
(
!
num
)
;
next_test
(
)
;
}
)
;
yield
countEntries
(
"
name
-
A
"
"
value
-
A
"
checkZero
)
;
Assert
.
equal
(
CURRENT_SCHEMA
FormHistory
.
schemaVersion
)
;
testnum
+
+
;
yield
updateEntry
(
"
add
"
"
name
-
A
"
"
value
-
A
"
next_test
)
;
yield
countEntries
(
null
null
checkOne
)
;
yield
countEntries
(
"
name
-
A
"
"
value
-
A
"
checkOne
)
;
testnum
+
+
;
yield
updateEntry
(
"
remove
"
"
name
-
A
"
"
value
-
A
"
next_test
)
;
yield
countEntries
(
null
null
checkZero
)
;
yield
countEntries
(
"
name
-
A
"
"
value
-
A
"
checkZero
)
;
}
catch
(
e
)
{
throw
new
Error
(
FAILED
in
test
#
{
testnum
}
-
-
{
e
}
)
;
}
do_test_finished
(
)
;
}
