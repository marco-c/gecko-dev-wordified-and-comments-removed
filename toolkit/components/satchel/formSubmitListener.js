(
function
(
)
{
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
)
;
let
satchelFormListener
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIFormSubmitObserver
Ci
.
nsIObserver
Ci
.
nsISupportsWeakReference
]
)
debug
:
true
enabled
:
true
init
(
)
{
Services
.
obs
.
addObserver
(
this
"
earlyformsubmit
"
)
;
Services
.
obs
.
addObserver
(
this
"
xpcom
-
shutdown
"
)
;
Services
.
prefs
.
addObserver
(
"
browser
.
formfill
.
"
this
)
;
this
.
updatePrefs
(
)
;
}
updatePrefs
(
)
{
this
.
debug
=
Services
.
prefs
.
getBoolPref
(
"
browser
.
formfill
.
debug
"
)
;
this
.
enabled
=
Services
.
prefs
.
getBoolPref
(
"
browser
.
formfill
.
enable
"
)
;
}
isValidCCNumber
(
ccNumber
)
{
ccNumber
=
ccNumber
.
replace
(
/
[
\
-
\
s
]
/
g
"
"
)
;
let
len
=
ccNumber
.
length
;
if
(
len
!
=
9
&
&
len
!
=
15
&
&
len
!
=
16
)
{
return
false
;
}
if
(
!
/
^
\
d
+
/
.
test
(
ccNumber
)
)
{
return
false
;
}
let
total
=
0
;
for
(
let
i
=
0
;
i
<
len
;
i
+
+
)
{
let
ch
=
parseInt
(
ccNumber
[
len
-
i
-
1
]
10
)
;
if
(
i
%
2
=
=
1
)
{
ch
*
=
2
;
if
(
ch
>
9
)
{
ch
-
=
9
;
}
}
total
+
=
ch
;
}
return
total
%
10
=
=
0
;
}
log
(
message
)
{
if
(
!
this
.
debug
)
{
return
;
}
dump
(
"
satchelFormListener
:
"
+
message
+
"
\
n
"
)
;
Services
.
console
.
logStringMessage
(
"
satchelFormListener
:
"
+
message
)
;
}
observe
(
subject
topic
data
)
{
if
(
topic
=
=
"
nsPref
:
changed
"
)
{
this
.
updatePrefs
(
)
;
}
else
if
(
topic
=
=
"
xpcom
-
shutdown
"
)
{
Services
.
obs
.
removeObserver
(
this
"
earlyformsubmit
"
)
;
Services
.
obs
.
removeObserver
(
this
"
xpcom
-
shutdown
"
)
;
Services
.
prefs
.
removeObserver
(
"
browser
.
formfill
.
"
this
)
;
}
else
{
this
.
log
(
"
Oops
!
Unexpected
notification
:
"
+
topic
)
;
}
}
notify
(
form
domWin
actionURI
cancelSubmit
)
{
try
{
if
(
!
this
.
enabled
|
|
PrivateBrowsingUtils
.
isContentWindowPrivate
(
domWin
)
)
{
return
;
}
this
.
log
(
"
Form
submit
observer
notified
.
"
)
;
if
(
form
.
hasAttribute
(
"
autocomplete
"
)
&
&
form
.
getAttribute
(
"
autocomplete
"
)
.
toLowerCase
(
)
=
=
"
off
"
)
{
return
;
}
let
entries
=
[
]
;
for
(
let
i
=
0
;
i
<
form
.
elements
.
length
;
i
+
+
)
{
let
input
=
form
.
elements
[
i
]
;
if
(
ChromeUtils
.
getClassName
(
input
)
!
=
=
"
HTMLInputElement
"
)
{
continue
;
}
if
(
!
input
.
mozIsTextField
(
true
)
)
{
continue
;
}
if
(
input
.
hasAttribute
(
"
autocomplete
"
)
&
&
input
.
getAttribute
(
"
autocomplete
"
)
.
toLowerCase
(
)
=
=
"
off
"
)
{
continue
;
}
let
value
=
input
.
value
.
trim
(
)
;
if
(
!
value
|
|
value
=
=
input
.
defaultValue
.
trim
(
)
)
{
continue
;
}
if
(
this
.
isValidCCNumber
(
value
)
)
{
this
.
log
(
"
skipping
saving
a
credit
card
number
"
)
;
continue
;
}
let
name
=
input
.
name
|
|
input
.
id
;
if
(
!
name
)
{
continue
;
}
if
(
name
=
=
"
searchbar
-
history
"
)
{
this
.
log
(
'
addEntry
for
input
name
"
'
+
name
+
'
"
is
denied
'
)
;
continue
;
}
if
(
name
.
length
>
200
|
|
value
.
length
>
200
)
{
this
.
log
(
"
skipping
input
that
has
a
name
/
value
too
large
"
)
;
continue
;
}
if
(
entries
.
length
>
=
100
)
{
this
.
log
(
"
not
saving
any
more
entries
for
this
form
.
"
)
;
break
;
}
entries
.
push
(
{
name
value
}
)
;
}
if
(
entries
.
length
)
{
this
.
log
(
"
sending
entries
to
parent
process
for
form
"
+
form
.
id
)
;
sendAsyncMessage
(
"
FormHistory
:
FormSubmitEntries
"
entries
)
;
}
}
catch
(
e
)
{
this
.
log
(
"
notify
failed
:
"
+
e
)
;
}
}
}
;
satchelFormListener
.
init
(
)
;
}
)
(
)
;
