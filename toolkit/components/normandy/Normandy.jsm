"
use
strict
"
;
const
{
Log
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Log
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
PromiseUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
PromiseUtils
.
jsm
"
)
;
const
{
setTimeout
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
AddonRollouts
:
"
resource
:
/
/
normandy
/
lib
/
AddonRollouts
.
jsm
"
AddonStudies
:
"
resource
:
/
/
normandy
/
lib
/
AddonStudies
.
jsm
"
CleanupManager
:
"
resource
:
/
/
normandy
/
lib
/
CleanupManager
.
jsm
"
LogManager
:
"
resource
:
/
/
normandy
/
lib
/
LogManager
.
jsm
"
NormandyMigrations
:
"
resource
:
/
/
normandy
/
NormandyMigrations
.
jsm
"
PreferenceExperiments
:
"
resource
:
/
/
normandy
/
lib
/
PreferenceExperiments
.
jsm
"
PreferenceRollouts
:
"
resource
:
/
/
normandy
/
lib
/
PreferenceRollouts
.
jsm
"
RecipeRunner
:
"
resource
:
/
/
normandy
/
lib
/
RecipeRunner
.
jsm
"
ShieldPreferences
:
"
resource
:
/
/
normandy
/
lib
/
ShieldPreferences
.
jsm
"
TelemetryUtils
:
"
resource
:
/
/
gre
/
modules
/
TelemetryUtils
.
jsm
"
TelemetryEvents
:
"
resource
:
/
/
normandy
/
lib
/
TelemetryEvents
.
jsm
"
ExperimentManager
:
"
resource
:
/
/
nimbus
/
lib
/
ExperimentManager
.
jsm
"
RemoteSettingsExperimentLoader
:
"
resource
:
/
/
nimbus
/
lib
/
RemoteSettingsExperimentLoader
.
jsm
"
}
)
;
var
EXPORTED_SYMBOLS
=
[
"
Normandy
"
]
;
const
UI_AVAILABLE_NOTIFICATION
=
"
sessionstore
-
windows
-
restored
"
;
const
BOOTSTRAP_LOGGER_NAME
=
"
app
.
normandy
.
bootstrap
"
;
const
SHIELD_INIT_NOTIFICATION
=
"
shield
-
init
-
complete
"
;
const
STARTUP_EXPERIMENT_PREFS_BRANCH
=
"
app
.
normandy
.
startupExperimentPrefs
.
"
;
const
STARTUP_ROLLOUT_PREFS_BRANCH
=
"
app
.
normandy
.
startupRolloutPrefs
.
"
;
const
PREF_LOGGING_LEVEL
=
"
app
.
normandy
.
logging
.
level
"
;
const
log
=
Log
.
repository
.
getLogger
(
BOOTSTRAP_LOGGER_NAME
)
;
log
.
addAppender
(
new
Log
.
ConsoleAppender
(
new
Log
.
BasicFormatter
(
)
)
)
;
log
.
level
=
Services
.
prefs
.
getIntPref
(
PREF_LOGGING_LEVEL
Log
.
Level
.
Warn
)
;
var
Normandy
=
{
studyPrefsChanged
:
{
}
rolloutPrefsChanged
:
{
}
defaultPrefsHaveBeenApplied
:
PromiseUtils
.
defer
(
)
uiAvailableNotificationObserved
:
PromiseUtils
.
defer
(
)
async
init
(
{
runAsync
=
true
}
=
{
}
)
{
Services
.
obs
.
addObserver
(
this
UI_AVAILABLE_NOTIFICATION
)
;
Services
.
obs
.
addObserver
(
this
TelemetryUtils
.
TELEMETRY_UPLOAD_DISABLED_TOPIC
)
;
this
.
rolloutPrefsChanged
=
this
.
applyStartupPrefs
(
STARTUP_ROLLOUT_PREFS_BRANCH
)
;
this
.
studyPrefsChanged
=
this
.
applyStartupPrefs
(
STARTUP_EXPERIMENT_PREFS_BRANCH
)
;
this
.
defaultPrefsHaveBeenApplied
.
resolve
(
)
;
await
NormandyMigrations
.
applyAll
(
)
;
if
(
runAsync
)
{
await
Promise
.
race
(
[
this
.
uiAvailableNotificationObserved
new
Promise
(
resolve
=
>
setTimeout
(
resolve
5
*
60
*
1000
)
)
]
)
;
}
try
{
Services
.
obs
.
removeObserver
(
this
UI_AVAILABLE_NOTIFICATION
)
;
}
catch
(
e
)
{
}
await
this
.
finishInit
(
)
;
}
async
observe
(
subject
topic
data
)
{
if
(
topic
=
=
=
UI_AVAILABLE_NOTIFICATION
)
{
Services
.
obs
.
removeObserver
(
this
UI_AVAILABLE_NOTIFICATION
)
;
this
.
uiAvailableNotificationObserved
.
resolve
(
)
;
}
else
if
(
topic
=
=
=
TelemetryUtils
.
TELEMETRY_UPLOAD_DISABLED_TOPIC
)
{
await
Promise
.
all
(
[
PreferenceExperiments
PreferenceRollouts
AddonStudies
AddonRollouts
]
.
map
(
service
=
>
service
.
onTelemetryDisabled
(
)
)
)
;
}
}
async
finishInit
(
)
{
try
{
TelemetryEvents
.
init
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
telemetry
events
:
"
err
)
;
}
await
PreferenceRollouts
.
recordOriginalValues
(
this
.
rolloutPrefsChanged
)
;
await
PreferenceExperiments
.
recordOriginalValues
(
this
.
studyPrefsChanged
)
;
LogManager
.
configure
(
Services
.
prefs
.
getIntPref
(
PREF_LOGGING_LEVEL
Log
.
Level
.
Warn
)
)
;
Services
.
prefs
.
addObserver
(
PREF_LOGGING_LEVEL
LogManager
.
configure
)
;
CleanupManager
.
addCleanupHandler
(
(
)
=
>
Services
.
prefs
.
removeObserver
(
PREF_LOGGING_LEVEL
LogManager
.
configure
)
)
;
try
{
await
ExperimentManager
.
onStartup
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
ExperimentManager
:
"
err
)
;
}
try
{
await
RemoteSettingsExperimentLoader
.
init
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
RemoteSettingsExperimentLoader
:
"
err
)
;
}
try
{
await
AddonStudies
.
init
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
addon
studies
:
"
err
)
;
}
try
{
await
PreferenceRollouts
.
init
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
preference
rollouts
:
"
err
)
;
}
try
{
await
AddonRollouts
.
init
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
addon
rollouts
:
"
err
)
;
}
try
{
await
PreferenceExperiments
.
init
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
preference
experiments
:
"
err
)
;
}
try
{
ShieldPreferences
.
init
(
)
;
}
catch
(
err
)
{
log
.
error
(
"
Failed
to
initialize
preferences
UI
:
"
err
)
;
}
await
RecipeRunner
.
init
(
)
;
Services
.
obs
.
notifyObservers
(
null
SHIELD_INIT_NOTIFICATION
)
;
}
async
uninit
(
)
{
await
CleanupManager
.
cleanup
(
)
;
Services
.
prefs
.
removeObserver
(
PREF_LOGGING_LEVEL
LogManager
.
configure
)
;
for
(
const
topic
of
[
TelemetryUtils
.
TELEMETRY_UPLOAD_DISABLED_TOPIC
UI_AVAILABLE_NOTIFICATION
]
)
{
try
{
Services
.
obs
.
removeObserver
(
this
topic
)
;
}
catch
(
e
)
{
}
}
}
applyStartupPrefs
(
sourcePrefix
)
{
const
originalValues
=
{
}
;
const
sourceBranch
=
Services
.
prefs
.
getBranch
(
sourcePrefix
)
;
const
targetBranch
=
Services
.
prefs
.
getDefaultBranch
(
"
"
)
;
for
(
const
prefName
of
sourceBranch
.
getChildList
(
"
"
)
)
{
const
sourcePrefType
=
sourceBranch
.
getPrefType
(
prefName
)
;
const
targetPrefType
=
targetBranch
.
getPrefType
(
prefName
)
;
if
(
targetPrefType
!
=
=
Services
.
prefs
.
PREF_INVALID
&
&
targetPrefType
!
=
=
sourcePrefType
)
{
Cu
.
reportError
(
new
Error
(
Error
setting
startup
pref
{
prefName
}
;
pref
type
does
not
match
.
)
)
;
continue
;
}
try
{
switch
(
targetPrefType
)
{
case
Services
.
prefs
.
PREF_STRING
:
{
originalValues
[
prefName
]
=
targetBranch
.
getCharPref
(
prefName
)
;
break
;
}
case
Services
.
prefs
.
PREF_INT
:
{
originalValues
[
prefName
]
=
targetBranch
.
getIntPref
(
prefName
)
;
break
;
}
case
Services
.
prefs
.
PREF_BOOL
:
{
originalValues
[
prefName
]
=
targetBranch
.
getBoolPref
(
prefName
)
;
break
;
}
case
Services
.
prefs
.
PREF_INVALID
:
{
originalValues
[
prefName
]
=
null
;
break
;
}
default
:
{
log
.
error
(
Error
getting
startup
pref
{
prefName
}
;
unknown
value
type
{
sourcePrefType
}
.
)
;
}
}
}
catch
(
e
)
{
if
(
e
.
result
=
=
=
Cr
.
NS_ERROR_UNEXPECTED
)
{
originalValues
[
prefName
]
=
null
;
}
else
{
Cu
.
reportError
(
e
)
;
continue
;
}
}
switch
(
sourcePrefType
)
{
case
Services
.
prefs
.
PREF_STRING
:
{
targetBranch
.
setCharPref
(
prefName
sourceBranch
.
getCharPref
(
prefName
)
)
;
break
;
}
case
Services
.
prefs
.
PREF_INT
:
{
targetBranch
.
setIntPref
(
prefName
sourceBranch
.
getIntPref
(
prefName
)
)
;
break
;
}
case
Services
.
prefs
.
PREF_BOOL
:
{
targetBranch
.
setBoolPref
(
prefName
sourceBranch
.
getBoolPref
(
prefName
)
)
;
break
;
}
default
:
{
Cu
.
reportError
(
new
Error
(
Error
getting
startup
pref
{
prefName
}
;
unexpected
value
type
{
sourcePrefType
}
.
)
)
;
}
}
}
return
originalValues
;
}
}
;
