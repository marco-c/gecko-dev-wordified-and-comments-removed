const
{
normalizeUrl
areSameSite
TabLedger
SessionLedger
}
=
ChromeUtils
.
importESModule
(
"
chrome
:
/
/
global
/
content
/
ml
/
security
/
SecurityUtils
.
sys
.
mjs
"
)
;
add_task
(
async
function
test_normalizeUrl_valid_http
(
)
{
const
result
=
normalizeUrl
(
"
http
:
/
/
example
.
com
/
page
"
)
;
Assert
.
ok
(
result
.
success
"
Should
succeed
for
valid
HTTP
URL
"
)
;
Assert
.
ok
(
result
.
url
"
Should
return
normalized
URL
"
)
;
Assert
.
ok
(
result
.
url
.
startsWith
(
"
http
:
/
/
"
)
"
Should
preserve
http
scheme
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_valid_https
(
)
{
const
result
=
normalizeUrl
(
"
https
:
/
/
example
.
com
/
page
"
)
;
Assert
.
ok
(
result
.
success
"
Should
succeed
for
valid
HTTPS
URL
"
)
;
Assert
.
ok
(
result
.
url
"
Should
return
normalized
URL
"
)
;
Assert
.
ok
(
result
.
url
.
startsWith
(
"
https
:
/
/
"
)
"
Should
preserve
https
scheme
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_with_query_params
(
)
{
const
result
=
normalizeUrl
(
"
https
:
/
/
example
.
com
/
page
?
foo
=
bar
&
baz
=
qux
"
)
;
Assert
.
ok
(
result
.
success
"
Should
succeed
for
URL
with
query
params
"
)
;
Assert
.
ok
(
result
.
url
.
includes
(
"
?
"
)
"
Should
preserve
query
parameters
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_empty_string
(
)
{
const
result
=
normalizeUrl
(
"
"
)
;
Assert
.
ok
(
!
result
.
success
"
Should
fail
for
empty
string
"
)
;
Assert
.
ok
(
result
.
error
"
Should
return
error
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_whitespace
(
)
{
const
result
=
normalizeUrl
(
"
"
)
;
Assert
.
ok
(
!
result
.
success
"
Should
fail
for
whitespace
-
only
string
"
)
;
Assert
.
ok
(
result
.
error
"
Should
return
error
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_invalid_format
(
)
{
const
result
=
normalizeUrl
(
"
not
-
a
-
valid
-
url
"
)
;
Assert
.
ok
(
!
result
.
success
"
Should
fail
for
invalid
URL
format
"
)
;
Assert
.
ok
(
result
.
error
"
Should
return
error
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_non_http_scheme
(
)
{
const
schemes
=
[
"
ftp
:
/
/
example
.
com
"
"
file
:
/
/
/
path
"
"
javascript
:
alert
(
1
)
"
]
;
for
(
const
url
of
schemes
)
{
const
result
=
normalizeUrl
(
url
)
;
Assert
.
ok
(
!
result
.
success
Should
fail
for
scheme
:
{
url
}
)
;
Assert
.
ok
(
result
.
error
"
Should
return
error
"
)
;
}
}
)
;
add_task
(
async
function
test_normalizeUrl_null_undefined
(
)
{
const
resultNull
=
normalizeUrl
(
null
)
;
const
resultUndefined
=
normalizeUrl
(
undefined
)
;
Assert
.
ok
(
!
resultNull
.
success
"
Should
fail
for
null
"
)
;
Assert
.
ok
(
!
resultUndefined
.
success
"
Should
fail
for
undefined
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_strips_fragments
(
)
{
const
result
=
normalizeUrl
(
"
https
:
/
/
example
.
com
/
page
#
section
"
)
;
Assert
.
ok
(
result
.
success
"
Should
succeed
"
)
;
Assert
.
ok
(
!
result
.
url
.
includes
(
"
#
"
)
"
Should
strip
fragment
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_strips_tracking
(
)
{
const
result
=
normalizeUrl
(
"
https
:
/
/
example
.
com
/
page
?
utm_source
=
test
&
foo
=
bar
"
)
;
Assert
.
ok
(
result
.
success
"
Should
succeed
"
)
;
Assert
.
ok
(
!
result
.
url
.
includes
(
"
utm_
"
)
"
Should
strip
utm
parameters
"
)
;
Assert
.
ok
(
result
.
url
.
includes
(
"
foo
=
bar
"
)
"
Should
preserve
non
-
tracking
params
"
)
;
}
)
;
add_task
(
async
function
test_normalizeUrl_relative_with_base
(
)
{
const
result
=
normalizeUrl
(
"
/
page
"
"
https
:
/
/
example
.
com
"
)
;
Assert
.
ok
(
result
.
success
"
Should
succeed
with
baseUrl
"
)
;
Assert
.
ok
(
result
.
url
.
includes
(
"
example
.
com
/
page
"
)
"
Should
resolve
relative
URL
"
)
;
}
)
;
add_task
(
async
function
test_areSameSite_same_domain
(
)
{
const
result
=
areSameSite
(
"
https
:
/
/
example
.
com
"
"
https
:
/
/
example
.
com
"
)
;
Assert
.
ok
(
result
"
Should
return
true
for
same
domain
"
)
;
}
)
;
add_task
(
async
function
test_areSameSite_subdomain
(
)
{
const
result
=
areSameSite
(
"
https
:
/
/
www
.
example
.
com
"
"
https
:
/
/
example
.
com
"
)
;
Assert
.
ok
(
result
"
Should
return
true
for
subdomain
vs
apex
"
)
;
}
)
;
add_task
(
async
function
test_areSameSite_different_subdomains
(
)
{
const
result
=
areSameSite
(
"
https
:
/
/
blog
.
example
.
com
"
"
https
:
/
/
shop
.
example
.
com
"
)
;
Assert
.
ok
(
result
"
Should
return
true
for
different
subdomains
"
)
;
}
)
;
add_task
(
async
function
test_areSameSite_different_domains
(
)
{
const
result
=
areSameSite
(
"
https
:
/
/
example
.
com
"
"
https
:
/
/
evil
.
com
"
)
;
Assert
.
ok
(
!
result
"
Should
return
false
for
different
domains
"
)
;
}
)
;
add_task
(
async
function
test_areSameSite_injection_attempt
(
)
{
const
result
=
areSameSite
(
"
https
:
/
/
example
.
com
"
"
https
:
/
/
example
.
com
.
evil
.
com
"
)
;
Assert
.
ok
(
!
result
"
Should
return
false
for
subdomain
injection
attempt
"
)
;
}
)
;
add_task
(
async
function
test_areSameSite_invalid_urls
(
)
{
const
result
=
areSameSite
(
"
not
-
a
-
url
"
"
https
:
/
/
example
.
com
"
)
;
Assert
.
ok
(
!
result
"
Should
return
false
for
invalid
URL
(
fail
-
closed
)
"
)
;
}
)
;
add_task
(
async
function
test_TabLedger_creation
(
)
{
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
Assert
.
ok
(
ledger
"
Should
create
ledger
"
)
;
Assert
.
equal
(
ledger
.
tabId
"
tab
-
123
"
"
Should
store
tab
ID
"
)
;
Assert
.
equal
(
ledger
.
size
(
)
0
"
Should
start
empty
"
)
;
}
)
;
add_task
(
async
function
test_TabLedger_seed
(
)
{
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
const
urls
=
[
"
https
:
/
/
example
.
com
"
"
https
:
/
/
example
.
com
/
page
"
]
;
ledger
.
seed
(
urls
)
;
Assert
.
ok
(
ledger
.
has
(
"
https
:
/
/
example
.
com
"
)
"
Should
contain
first
URL
"
)
;
Assert
.
ok
(
ledger
.
has
(
"
https
:
/
/
example
.
com
/
page
"
)
"
Should
contain
second
URL
"
)
;
Assert
.
equal
(
ledger
.
size
(
)
2
"
Should
have
correct
size
"
)
;
}
)
;
add_task
(
async
function
test_TabLedger_add
(
)
{
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
ledger
.
add
(
"
https
:
/
/
example
.
com
"
)
;
Assert
.
ok
(
ledger
.
has
(
"
https
:
/
/
example
.
com
"
)
"
Should
contain
added
URL
"
)
;
Assert
.
equal
(
ledger
.
size
(
)
1
"
Should
have
size
1
"
)
;
}
)
;
add_task
(
async
function
test_TabLedger_has_missing
(
)
{
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
ledger
.
add
(
"
https
:
/
/
example
.
com
"
)
;
Assert
.
ok
(
!
ledger
.
has
(
"
https
:
/
/
evil
.
com
"
)
"
Should
return
false
for
missing
URL
"
)
;
}
)
;
add_task
(
async
function
test_TabLedger_clear
(
)
{
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
ledger
.
seed
(
[
"
https
:
/
/
example
.
com
"
"
https
:
/
/
example
.
com
/
page
"
]
)
;
ledger
.
clear
(
)
;
Assert
.
equal
(
ledger
.
size
(
)
0
"
Should
be
empty
after
clear
"
)
;
Assert
.
ok
(
!
ledger
.
has
(
"
https
:
/
/
example
.
com
"
)
"
Should
not
contain
URLs
after
clear
"
)
;
}
)
;
add_task
(
async
function
test_TabLedger_size_limit
(
)
{
const
maxUrls
=
1000
;
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
for
(
let
i
=
0
;
i
<
maxUrls
+
2
;
i
+
+
)
{
ledger
.
add
(
https
:
/
/
example
.
com
/
page
{
i
}
)
;
}
Assert
.
lessOrEqual
(
ledger
.
size
(
)
maxUrls
"
Should
not
exceed
max
size
"
)
;
}
)
;
add_task
(
async
function
test_TabLedger_invalid_urls
(
)
{
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
ledger
.
add
(
"
not
-
a
-
url
"
)
;
ledger
.
add
(
"
"
)
;
ledger
.
add
(
null
)
;
Assert
.
equal
(
ledger
.
size
(
)
0
"
Should
not
add
invalid
URLs
"
)
;
}
)
;
add_task
(
async
function
test_SessionLedger_creation
(
)
{
const
session
=
new
SessionLedger
(
"
session
-
123
"
)
;
Assert
.
ok
(
session
"
Should
create
session
ledger
"
)
;
Assert
.
equal
(
session
.
sessionId
"
session
-
123
"
"
Should
store
session
ID
"
)
;
Assert
.
equal
(
session
.
tabCount
(
)
0
"
Should
start
with
no
tabs
"
)
;
}
)
;
add_task
(
async
function
test_SessionLedger_forTab
(
)
{
const
session
=
new
SessionLedger
(
"
session
-
123
"
)
;
const
ledger1
=
session
.
forTab
(
"
tab
-
1
"
)
;
const
ledger2
=
session
.
forTab
(
"
tab
-
1
"
)
;
Assert
.
ok
(
ledger1
"
Should
create
ledger
for
tab
-
1
"
)
;
Assert
.
equal
(
ledger1
ledger2
"
Should
return
same
ledger
for
same
tab
"
)
;
Assert
.
equal
(
session
.
tabCount
(
)
1
"
Should
have
1
tab
"
)
;
}
)
;
add_task
(
async
function
test_SessionLedger_multiple_tabs
(
)
{
const
session
=
new
SessionLedger
(
"
session
-
123
"
)
;
const
ledger1
=
session
.
forTab
(
"
tab
-
1
"
)
;
const
ledger2
=
session
.
forTab
(
"
tab
-
2
"
)
;
Assert
.
notEqual
(
ledger1
ledger2
"
Different
tabs
should
have
different
ledgers
"
)
;
Assert
.
equal
(
session
.
tabCount
(
)
2
"
Should
have
2
tabs
"
)
;
}
)
;
add_task
(
async
function
test_SessionLedger_merge
(
)
{
const
session
=
new
SessionLedger
(
"
session
-
123
"
)
;
const
ledger1
=
session
.
forTab
(
"
tab
-
1
"
)
;
const
ledger2
=
session
.
forTab
(
"
tab
-
2
"
)
;
ledger1
.
add
(
"
https
:
/
/
example
.
com
/
page1
"
)
;
ledger2
.
add
(
"
https
:
/
/
example
.
com
/
page2
"
)
;
const
merged
=
session
.
merge
(
[
"
tab
-
1
"
"
tab
-
2
"
]
)
;
Assert
.
ok
(
merged
.
has
(
"
https
:
/
/
example
.
com
/
page1
"
)
"
Should
have
URL
from
tab
-
1
"
)
;
Assert
.
ok
(
merged
.
has
(
"
https
:
/
/
example
.
com
/
page2
"
)
"
Should
have
URL
from
tab
-
2
"
)
;
Assert
.
equal
(
merged
.
size
(
)
2
"
Should
have
2
URLs
"
)
;
}
)
;
add_task
(
async
function
test_SessionLedger_removeTab
(
)
{
const
session
=
new
SessionLedger
(
"
session
-
123
"
)
;
session
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
session
.
forTab
(
"
tab
-
2
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
session
.
removeTab
(
"
tab
-
1
"
)
;
Assert
.
equal
(
session
.
tabCount
(
)
1
"
Should
have
1
tab
after
removal
"
)
;
const
newLedger
=
session
.
forTab
(
"
tab
-
1
"
)
;
Assert
.
equal
(
newLedger
.
size
(
)
0
"
New
ledger
for
removed
tab
should
be
empty
"
)
;
}
)
;
add_task
(
async
function
test_SessionLedger_clearAll
(
)
{
const
session
=
new
SessionLedger
(
"
session
-
123
"
)
;
session
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
session
.
forTab
(
"
tab
-
2
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
session
.
clearAll
(
)
;
Assert
.
equal
(
session
.
tabCount
(
)
0
"
Should
have
no
tabs
after
clearAll
"
)
;
}
)
;
add_task
(
async
function
test_ledger_normalizes_urls
(
)
{
const
ledger
=
new
TabLedger
(
"
tab
-
123
"
)
;
ledger
.
add
(
"
https
:
/
/
example
.
com
/
page
#
section
"
)
;
Assert
.
ok
(
ledger
.
has
(
"
https
:
/
/
example
.
com
/
page
"
)
"
Should
match
normalized
URL
without
fragment
"
)
;
}
)
;
