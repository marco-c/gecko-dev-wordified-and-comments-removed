const
{
SecurityOrchestrator
getSecurityOrchestrator
}
=
ChromeUtils
.
importESModule
(
"
chrome
:
/
/
global
/
content
/
ml
/
security
/
SecurityOrchestrator
.
sys
.
mjs
"
)
;
const
PREF_SECURITY_ENABLED
=
"
browser
.
ml
.
security
.
enabled
"
;
const
POLICY_JSON_URL
=
"
chrome
:
/
/
global
/
content
/
ml
/
security
/
policies
/
tool
-
execution
-
policies
.
json
"
;
const
TEST_SESSION_ID
=
"
test
-
session
"
;
let
orchestrator
=
null
;
function
setup
(
)
{
Services
.
prefs
.
clearUserPref
(
PREF_SECURITY_ENABLED
)
;
}
async
function
teardown
(
)
{
Services
.
prefs
.
clearUserPref
(
PREF_SECURITY_ENABLED
)
;
await
SecurityOrchestrator
.
resetForTesting
(
)
;
orchestrator
=
null
;
}
add_task
(
async
function
test_json_policy_file_loads_and_validates
(
)
{
const
response
=
await
fetch
(
POLICY_JSON_URL
)
;
const
policyData
=
await
response
.
json
(
)
;
Assert
.
ok
(
response
.
ok
"
Policy
JSON
should
be
accessible
"
)
;
Assert
.
ok
(
policyData
.
policies
"
Should
have
policies
array
"
)
;
Assert
.
greater
(
policyData
.
policies
.
length
0
"
Should
have
at
least
one
policy
"
)
;
const
policy
=
policyData
.
policies
[
0
]
;
Assert
.
ok
(
policy
.
id
"
Policy
should
have
id
"
)
;
Assert
.
ok
(
policy
.
phase
"
Policy
should
have
phase
"
)
;
Assert
.
ok
(
policy
.
effect
"
Policy
should
have
effect
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_orchestrator_initializes_with_policies
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
Assert
.
ok
(
ledger
"
Should
initialize
successfully
"
)
;
Assert
.
ok
(
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
"
Should
have
session
ledger
"
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
evil
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
Policies
should
be
loaded
and
working
(
denies
unseen
URL
)
"
)
;
Assert
.
equal
(
decision
.
policyId
"
block
-
unseen
-
links
"
"
Should
use
JSON
policy
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_deny_unseen_link
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
evil
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
deny
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
CRITICAL
:
Should
deny
unseen
URL
(
real
policy
from
JSON
)
"
)
;
Assert
.
equal
(
decision
.
code
"
UNSEEN_LINK
"
"
Should
have
UNSEEN_LINK
code
from
JSON
policy
"
)
;
Assert
.
equal
(
decision
.
policyId
"
block
-
unseen
-
links
"
"
Should
be
from
block
-
unseen
-
links
policy
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_deny_if_any_url_unseen
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
const
tabLedger
=
ledger
.
forTab
(
"
tab
-
1
"
)
;
tabLedger
.
add
(
"
https
:
/
/
example
.
com
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
"
"
https
:
/
/
evil
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
deny
-
multiple
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
Should
deny
if
ANY
URL
unseen
(
all
-
or
-
nothing
security
)
"
)
;
Assert
.
equal
(
decision
.
code
"
UNSEEN_LINK
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_deny_malformed_url
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
not
-
a
-
valid
-
url
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
malformed
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
Should
deny
malformed
URL
(
fail
-
closed
)
"
)
;
Assert
.
equal
(
decision
.
code
"
UNSEEN_LINK
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_allow_seeded_url
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
const
tabLedger
=
ledger
.
forTab
(
"
tab
-
1
"
)
;
tabLedger
.
add
(
"
https
:
/
/
example
.
com
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
allow
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
CRITICAL
:
Should
allow
seeded
URL
(
real
policy
from
JSON
)
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_allow_multiple_seeded_urls
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
const
tabLedger
=
ledger
.
forTab
(
"
tab
-
1
"
)
;
tabLedger
.
add
(
"
https
:
/
/
example
.
com
"
)
;
tabLedger
.
add
(
"
https
:
/
/
mozilla
.
org
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
"
"
https
:
/
/
mozilla
.
org
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
allow
-
multiple
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
allow
when
all
URLs
seeded
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_allow_empty_urls
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
empty
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
allow
when
no
URLs
to
check
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_allow_url_from_mentioned_tab
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
ledger
.
forTab
(
"
tab
-
2
"
)
.
add
(
"
https
:
/
/
mozilla
.
org
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
mozilla
.
org
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
"
tab
-
2
"
]
requestId
:
"
test
-
mention
-
allow
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
allow
URL
from
mentioned
tab
(
merged
ledger
)
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_deny_url_not_in_mentioned_tabs
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
ledger
.
forTab
(
"
tab
-
2
"
)
.
add
(
"
https
:
/
/
mozilla
.
org
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
evil
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
"
tab
-
2
"
]
requestId
:
"
test
-
mention
-
deny
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
Should
deny
URL
not
in
current
or
mentioned
tabs
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_url_normalization_strips_fragments
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
/
page
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
/
page
#
section
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
normalize
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
allow
after
normalizing
(
fragments
stripped
)
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_e2e_pref_switch_bypasses_policies
(
)
{
setup
(
)
;
Services
.
prefs
.
setBoolPref
(
PREF_SECURITY_ENABLED
false
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
evil
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
-
prefswitch
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Pref
switch
OFF
:
should
bypass
all
policies
(
allow
everything
)
"
)
;
await
teardown
(
)
;
}
)
;
