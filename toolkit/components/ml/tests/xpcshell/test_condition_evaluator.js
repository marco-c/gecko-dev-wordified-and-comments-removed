const
{
SecurityOrchestrator
getSecurityOrchestrator
}
=
ChromeUtils
.
importESModule
(
"
chrome
:
/
/
global
/
content
/
ml
/
security
/
SecurityOrchestrator
.
sys
.
mjs
"
)
;
const
PREF_SECURITY_ENABLED
=
"
browser
.
ml
.
security
.
enabled
"
;
const
TEST_SESSION_ID
=
"
test
-
session
"
;
let
orchestrator
=
null
;
function
setup
(
)
{
Services
.
prefs
.
clearUserPref
(
PREF_SECURITY_ENABLED
)
;
}
async
function
teardown
(
)
{
Services
.
prefs
.
clearUserPref
(
PREF_SECURITY_ENABLED
)
;
await
SecurityOrchestrator
.
resetForTesting
(
)
;
orchestrator
=
null
;
}
add_task
(
async
function
test_condition_passes_when_all_urls_in_ledger
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
const
tabLedger
=
ledger
.
forTab
(
"
tab
-
1
"
)
;
tabLedger
.
add
(
"
https
:
/
/
example
.
com
"
)
;
tabLedger
.
add
(
"
https
:
/
/
mozilla
.
org
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
"
"
https
:
/
/
mozilla
.
org
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
allow
when
all
URLs
in
ledger
(
condition
passes
)
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_condition_fails_when_url_missing_from_ledger
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
"
"
https
:
/
/
evil
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
Should
deny
when
URL
not
in
ledger
(
condition
fails
)
"
)
;
Assert
.
equal
(
decision
.
code
"
UNSEEN_LINK
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_condition_passes_with_empty_urls_array
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
allow
with
empty
URLs
(
nothing
to
check
)
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_condition_fails_with_malformed_url
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
not
-
a
-
valid
-
url
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
Should
deny
malformed
URL
(
condition
/
validation
fails
)
"
)
;
Assert
.
equal
(
decision
.
code
"
UNSEEN_LINK
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_condition_checks_current_tab_only
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
check
current
tab
ledger
only
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_condition_merges_mentioned_tabs
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
"
)
;
ledger
.
forTab
(
"
tab
-
2
"
)
.
add
(
"
https
:
/
/
mozilla
.
org
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
mozilla
.
org
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
"
tab
-
2
"
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
merge
current
tab
+
mentioned
tabs
"
)
;
await
teardown
(
)
;
}
)
;
add_task
(
async
function
test_condition_normalizes_urls
(
)
{
setup
(
)
;
orchestrator
=
await
getSecurityOrchestrator
(
)
;
orchestrator
.
registerSession
(
TEST_SESSION_ID
)
;
const
ledger
=
orchestrator
.
getSessionLedger
(
TEST_SESSION_ID
)
;
ledger
.
forTab
(
"
tab
-
1
"
)
.
add
(
"
https
:
/
/
example
.
com
/
page
"
)
;
const
decision
=
await
orchestrator
.
evaluate
(
TEST_SESSION_ID
{
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
/
page
#
section
"
]
tabId
:
"
tab
-
1
"
}
context
:
{
currentTabId
:
"
tab
-
1
"
mentionedTabIds
:
[
]
requestId
:
"
test
"
}
}
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
allow
after
normalizing
URLs
(
fragments
stripped
)
"
)
;
await
teardown
(
)
;
}
)
;
