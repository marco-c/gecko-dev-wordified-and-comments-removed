const
{
SecurityPolicyError
DenialCodes
ReasonPhrases
createAllowDecision
createDenyDecision
isAllowDecision
isDenyDecision
}
=
ChromeUtils
.
importESModule
(
"
chrome
:
/
/
global
/
content
/
ml
/
security
/
DecisionTypes
.
sys
.
mjs
"
)
;
add_task
(
async
function
test_security_policy_error_constructor
(
)
{
const
decision
=
{
effect
:
"
deny
"
policyId
:
"
test
-
policy
"
code
:
"
TEST_CODE
"
reason
:
"
Test
reason
message
"
details
:
{
foo
:
"
bar
"
}
}
;
const
error
=
new
SecurityPolicyError
(
decision
)
;
Assert
.
equal
(
error
.
name
"
SecurityPolicyError
"
"
Should
have
correct
name
"
)
;
Assert
.
equal
(
error
.
message
"
Test
reason
message
"
"
Should
have
correct
message
"
)
;
Assert
.
equal
(
error
.
code
"
TEST_CODE
"
"
Should
have
correct
code
"
)
;
Assert
.
equal
(
error
.
policyId
"
test
-
policy
"
"
Should
have
correct
policyId
"
)
;
Assert
.
deepEqual
(
error
.
decision
decision
"
Should
store
the
full
decision
object
"
)
;
}
)
;
add_task
(
async
function
test_security_policy_error_toJSON
(
)
{
const
decision
=
{
effect
:
"
deny
"
policyId
:
"
test
-
policy
"
code
:
"
TEST_CODE
"
reason
:
"
Test
reason
"
details
:
{
url
:
"
https
:
/
/
example
.
com
"
}
}
;
const
error
=
new
SecurityPolicyError
(
decision
)
;
const
json
=
error
.
toJSON
(
)
;
Assert
.
equal
(
json
.
name
"
SecurityPolicyError
"
"
JSON
should
include
name
"
)
;
Assert
.
equal
(
json
.
code
"
TEST_CODE
"
"
JSON
should
include
code
"
)
;
Assert
.
equal
(
json
.
policyId
"
test
-
policy
"
"
JSON
should
include
policyId
"
)
;
Assert
.
equal
(
json
.
message
"
Test
reason
"
"
JSON
should
include
message
"
)
;
Assert
.
deepEqual
(
json
.
decision
decision
"
JSON
should
include
full
decision
"
)
;
const
serialized
=
JSON
.
stringify
(
json
)
;
const
parsed
=
JSON
.
parse
(
serialized
)
;
Assert
.
equal
(
parsed
.
code
"
TEST_CODE
"
"
Should
round
-
trip
through
JSON
"
)
;
}
)
;
add_task
(
async
function
test_error_throw_catch
(
)
{
const
decision
=
createDenyDecision
(
"
TEST_CODE
"
"
Test
reason
"
)
;
try
{
throw
new
SecurityPolicyError
(
decision
)
;
}
catch
(
error
)
{
Assert
.
equal
(
error
.
name
"
SecurityPolicyError
"
"
Should
catch
as
SecurityPolicyError
"
)
;
Assert
.
equal
(
error
.
code
"
TEST_CODE
"
"
Should
have
correct
code
"
)
;
Assert
.
equal
(
error
.
message
"
Test
reason
"
"
Should
have
correct
message
"
)
;
}
}
)
;
add_task
(
async
function
test_allow_helper
(
)
{
const
decision
=
createAllowDecision
(
)
;
Assert
.
equal
(
decision
.
effect
"
allow
"
"
Should
have
effect
'
allow
'
"
)
;
Assert
.
equal
(
Object
.
keys
(
decision
)
.
length
1
"
Should
only
have
'
effect
'
property
"
)
;
}
)
;
add_task
(
async
function
test_deny_helper_full
(
)
{
const
decision
=
createDenyDecision
(
"
TEST_CODE
"
"
Test
reason
"
{
url
:
"
https
:
/
/
example
.
com
"
}
"
custom
-
policy
"
)
;
Assert
.
equal
(
decision
.
effect
"
deny
"
"
Should
have
effect
'
deny
'
"
)
;
Assert
.
equal
(
decision
.
code
"
TEST_CODE
"
"
Should
have
correct
code
"
)
;
Assert
.
equal
(
decision
.
reason
"
Test
reason
"
"
Should
have
correct
reason
"
)
;
Assert
.
equal
(
decision
.
policyId
"
custom
-
policy
"
"
Should
have
custom
policyId
"
)
;
Assert
.
deepEqual
(
decision
.
details
{
url
:
"
https
:
/
/
example
.
com
"
}
"
Should
have
correct
details
"
)
;
}
)
;
add_task
(
async
function
test_deny_helper_default_policy
(
)
{
const
decision
=
createDenyDecision
(
"
TEST_CODE
"
"
Test
reason
"
)
;
Assert
.
equal
(
decision
.
policyId
"
block
-
unseen
-
links
"
"
Should
use
default
policyId
"
)
;
Assert
.
equal
(
decision
.
details
undefined
"
Details
should
be
undefined
when
not
provided
"
)
;
}
)
;
add_task
(
async
function
test_isAllow_with_allow_decision
(
)
{
const
decision
=
createAllowDecision
(
)
;
Assert
.
ok
(
isAllowDecision
(
decision
)
"
Should
return
true
for
allow
decision
"
)
;
}
)
;
add_task
(
async
function
test_isAllow_with_deny_decision
(
)
{
const
decision
=
createDenyDecision
(
"
CODE
"
"
reason
"
)
;
Assert
.
ok
(
!
isAllowDecision
(
decision
)
"
Should
return
false
for
deny
decision
"
)
;
}
)
;
add_task
(
async
function
test_isAllow_with_invalid
(
)
{
Assert
.
ok
(
!
isAllowDecision
(
null
)
"
Should
return
false
for
null
"
)
;
Assert
.
ok
(
!
isAllowDecision
(
undefined
)
"
Should
return
false
for
undefined
"
)
;
Assert
.
ok
(
!
isAllowDecision
(
{
}
)
"
Should
return
false
for
empty
object
"
)
;
Assert
.
ok
(
!
isAllowDecision
(
{
effect
:
"
maybe
"
}
)
"
Should
return
false
for
invalid
effect
"
)
;
}
)
;
add_task
(
async
function
test_isDeny_with_deny_decision
(
)
{
const
decision
=
createDenyDecision
(
"
CODE
"
"
reason
"
)
;
Assert
.
ok
(
isDenyDecision
(
decision
)
"
Should
return
true
for
deny
decision
"
)
;
}
)
;
add_task
(
async
function
test_isDeny_with_allow_decision
(
)
{
const
decision
=
createAllowDecision
(
)
;
Assert
.
ok
(
!
isDenyDecision
(
decision
)
"
Should
return
false
for
allow
decision
"
)
;
}
)
;
add_task
(
async
function
test_isDeny_with_invalid
(
)
{
Assert
.
ok
(
!
isDenyDecision
(
null
)
"
Should
return
false
for
null
"
)
;
Assert
.
ok
(
!
isDenyDecision
(
undefined
)
"
Should
return
false
for
undefined
"
)
;
Assert
.
ok
(
!
isDenyDecision
(
{
}
)
"
Should
return
false
for
empty
object
"
)
;
Assert
.
ok
(
!
isDenyDecision
(
{
effect
:
"
maybe
"
}
)
"
Should
return
false
for
invalid
effect
"
)
;
}
)
;
add_task
(
async
function
test_deny_to_error_to_json
(
)
{
const
decision
=
createDenyDecision
(
DenialCodes
.
UNSEEN_LINK
ReasonPhrases
.
UNSEEN_LINK
{
url
:
"
https
:
/
/
evil
.
com
"
}
)
;
const
error
=
new
SecurityPolicyError
(
decision
)
;
const
json
=
error
.
toJSON
(
)
;
Assert
.
equal
(
json
.
code
"
UNSEEN_LINK
"
"
Should
preserve
code
through
chain
"
)
;
Assert
.
equal
(
json
.
message
"
URL
not
in
selected
request
context
"
"
Should
preserve
reason
through
chain
"
)
;
Assert
.
equal
(
json
.
policyId
"
block
-
unseen
-
links
"
"
Should
have
default
policyId
"
)
;
Assert
.
deepEqual
(
json
.
decision
.
details
{
url
:
"
https
:
/
/
evil
.
com
"
}
"
Should
preserve
details
through
chain
"
)
;
}
)
;
add_task
(
async
function
test_decision_control_flow
(
)
{
const
allowDecision
=
createAllowDecision
(
)
;
const
denyDecision
=
createDenyDecision
(
"
CODE
"
"
reason
"
)
;
function
processDecision
(
decision
)
{
if
(
isAllowDecision
(
decision
)
)
{
return
"
allowed
"
;
}
else
if
(
isDenyDecision
(
decision
)
)
{
return
"
denied
"
;
}
return
"
unknown
"
;
}
Assert
.
equal
(
processDecision
(
allowDecision
)
"
allowed
"
"
Should
handle
allow
decision
"
)
;
Assert
.
equal
(
processDecision
(
denyDecision
)
"
denied
"
"
Should
handle
deny
decision
"
)
;
Assert
.
equal
(
processDecision
(
null
)
"
unknown
"
"
Should
handle
invalid
decision
gracefully
"
)
;
}
)
;
