const
{
logSecurityEvent
}
=
ChromeUtils
.
importESModule
(
"
chrome
:
/
/
global
/
content
/
ml
/
security
/
SecurityLogger
.
sys
.
mjs
"
)
;
function
createTestEntry
(
overrides
=
{
}
)
{
return
{
requestId
:
"
req
-
123
"
sessionId
:
"
session
-
456
"
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
/
page
"
]
args
:
{
mode
:
"
full
"
}
}
context
:
{
tainted
:
true
trustedCount
:
5
}
decision
:
{
effect
:
"
allow
"
}
durationMs
:
1
.
5
.
.
.
overrides
}
;
}
add_task
(
function
test_logSecurityEvent_completes_without_error
(
)
{
logSecurityEvent
(
createTestEntry
(
)
)
;
Assert
.
ok
(
true
"
logSecurityEvent
(
)
completed
without
error
"
)
;
}
)
;
add_task
(
function
test_logSecurityEvent_handles_deny_decision
(
)
{
logSecurityEvent
(
createTestEntry
(
{
decision
:
{
effect
:
"
deny
"
policyId
:
"
block
-
unseen
-
links
"
code
:
"
UNSEEN_LINK
"
reason
:
"
URL
not
in
trusted
context
"
}
}
)
)
;
Assert
.
ok
(
true
"
logSecurityEvent
(
)
handles
deny
decision
without
error
"
)
;
}
)
;
add_task
(
function
test_logSecurityEvent_handles_missing_optional_fields
(
)
{
logSecurityEvent
(
{
requestId
:
"
req
-
minimal
"
sessionId
:
"
session
-
minimal
"
phase
:
"
tool
.
execution
"
action
:
{
type
:
"
tool
.
call
"
tool
:
"
search_tabs
"
}
context
:
{
}
decision
:
{
effect
:
"
allow
"
}
durationMs
:
0
.
5
}
)
;
Assert
.
ok
(
true
"
logSecurityEvent
(
)
handles
missing
optional
fields
without
error
"
)
;
}
)
;
add_task
(
function
test_logSecurityEvent_handles_error_entry
(
)
{
logSecurityEvent
(
createTestEntry
(
{
error
:
new
Error
(
"
Test
error
"
)
}
)
)
;
Assert
.
ok
(
true
"
logSecurityEvent
(
)
handles
error
entries
without
error
"
)
;
}
)
;
add_task
(
function
test_logSecurityEvent_handles_multiple_urls
(
)
{
logSecurityEvent
(
createTestEntry
(
{
action
:
{
type
:
"
tool
.
call
"
tool
:
"
get_page_content
"
urls
:
[
"
https
:
/
/
example
.
com
/
page1
"
"
https
:
/
/
example
.
com
/
page2
"
"
https
:
/
/
example
.
com
/
page3
"
]
}
}
)
)
;
Assert
.
ok
(
true
"
logSecurityEvent
(
)
handles
multiple
URLs
without
error
"
)
;
}
)
;
