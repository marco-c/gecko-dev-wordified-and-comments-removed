"
use
strict
"
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
quotaManagerService
"
"
mozilla
.
org
/
dom
/
quota
-
manager
-
service
;
1
"
"
nsIQuotaManagerService
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
serviceWorkerManager
"
"
mozilla
.
org
/
serviceworkers
/
manager
;
1
"
"
nsIServiceWorkerManager
"
)
;
class
PrincipalsCollector
{
constructor
(
)
{
this
.
principals
=
null
;
}
static
isSupportedPrincipal
(
principal
)
{
return
[
"
http
"
"
https
"
"
file
"
]
.
some
(
scheme
=
>
principal
.
schemeIs
(
scheme
)
)
;
}
async
getAllPrincipals
(
progress
=
{
}
)
{
if
(
this
.
principals
=
=
null
)
{
this
.
principals
=
await
this
.
_getAllPrincipalsInternal
(
progress
)
;
}
return
this
.
principals
;
}
async
_getAllPrincipalsInternal
(
progress
=
{
}
)
{
progress
.
step
=
"
principals
-
quota
-
manager
"
;
let
principals
=
await
new
Promise
(
resolve
=
>
{
quotaManagerService
.
listOrigins
(
)
.
callback
=
request
=
>
{
progress
.
step
=
"
principals
-
quota
-
manager
-
listOrigins
"
;
if
(
request
.
resultCode
!
=
Cr
.
NS_OK
)
{
resolve
(
[
]
)
;
return
;
}
let
list
=
[
]
;
for
(
const
origin
of
request
.
result
)
{
let
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
origin
)
;
if
(
PrincipalsCollector
.
isSupportedPrincipal
(
principal
)
)
{
list
.
push
(
principal
)
;
}
}
progress
.
step
=
"
principals
-
quota
-
manager
-
completed
"
;
resolve
(
list
)
;
}
;
}
)
.
catch
(
ex
=
>
{
Cu
.
reportError
(
"
QuotaManagerService
promise
failed
:
"
+
ex
)
;
return
[
]
;
}
)
;
progress
.
step
=
"
principals
-
service
-
workers
"
;
let
serviceWorkers
=
serviceWorkerManager
.
getAllRegistrations
(
)
;
for
(
let
i
=
0
;
i
<
serviceWorkers
.
length
;
i
+
+
)
{
let
sw
=
serviceWorkers
.
queryElementAt
(
i
Ci
.
nsIServiceWorkerRegistrationInfo
)
;
principals
.
push
(
sw
.
principal
)
;
}
progress
.
step
=
"
principals
-
cookies
"
;
let
cookies
=
Services
.
cookies
.
cookies
;
let
hosts
=
new
Set
(
)
;
for
(
let
cookie
of
cookies
)
{
hosts
.
add
(
cookie
.
rawHost
+
ChromeUtils
.
originAttributesToSuffix
(
cookie
.
originAttributes
)
)
;
}
progress
.
step
=
"
principals
-
host
-
cookie
"
;
hosts
.
forEach
(
host
=
>
{
principals
.
push
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
"
+
host
)
)
;
}
)
;
progress
.
step
=
"
total
-
principals
:
"
+
principals
.
length
;
return
principals
;
}
}
this
.
EXPORTED_SYMBOLS
=
[
"
PrincipalsCollector
"
]
;
