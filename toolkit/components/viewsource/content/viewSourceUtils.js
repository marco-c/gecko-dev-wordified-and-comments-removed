ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
ViewSourceBrowser
"
"
resource
:
/
/
gre
/
modules
/
ViewSourceBrowser
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
Deprecated
"
"
resource
:
/
/
gre
/
modules
/
Deprecated
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
PrivateBrowsingUtils
"
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
Services
"
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
var
gViewSourceUtils
=
{
mnsIWebBrowserPersist
:
Components
.
interfaces
.
nsIWebBrowserPersist
mnsIWebProgress
:
Components
.
interfaces
.
nsIWebProgress
mnsIWebPageDescriptor
:
Components
.
interfaces
.
nsIWebPageDescriptor
viewSource
(
aArgsOrURL
aPageDescriptor
aDocument
aLineNumber
)
{
if
(
Services
.
prefs
.
getBoolPref
(
"
view_source
.
editor
.
external
"
)
)
{
this
.
openInExternalEditor
(
aArgsOrURL
aPageDescriptor
aDocument
aLineNumber
)
;
}
else
{
this
.
_openInInternalViewer
(
aArgsOrURL
aPageDescriptor
aDocument
aLineNumber
)
;
}
}
viewSourceInBrowser
(
aArgs
)
{
Services
.
telemetry
.
getHistogramById
(
"
VIEW_SOURCE_IN_BROWSER_OPENED_BOOLEAN
"
)
.
add
(
true
)
;
let
viewSourceBrowser
=
new
ViewSourceBrowser
(
aArgs
.
viewSourceBrowser
)
;
viewSourceBrowser
.
loadViewSource
(
aArgs
)
;
}
viewPartialSourceInBrowser
(
aViewSourceInBrowser
aTarget
aGetBrowserFn
)
{
let
mm
=
aViewSourceInBrowser
.
messageManager
;
mm
.
addMessageListener
(
"
ViewSource
:
GetSelectionDone
"
function
gotSelection
(
message
)
{
mm
.
removeMessageListener
(
"
ViewSource
:
GetSelectionDone
"
gotSelection
)
;
if
(
!
message
.
data
)
return
;
let
browserToOpenIn
=
aGetBrowserFn
?
aGetBrowserFn
(
)
:
null
;
if
(
browserToOpenIn
)
{
let
viewSourceBrowser
=
new
ViewSourceBrowser
(
browserToOpenIn
)
;
viewSourceBrowser
.
loadViewSourceFromSelection
(
message
.
data
.
uri
message
.
data
.
drawSelection
message
.
data
.
baseURI
)
;
}
else
{
window
.
openDialog
(
"
chrome
:
/
/
global
/
content
/
viewPartialSource
.
xul
"
"
_blank
"
"
all
dialog
=
no
"
{
URI
:
message
.
data
.
uri
drawSelection
:
message
.
data
.
drawSelection
baseURI
:
message
.
data
.
baseURI
partial
:
true
}
)
;
}
}
)
;
mm
.
sendAsyncMessage
(
"
ViewSource
:
GetSelection
"
{
}
{
target
:
aTarget
}
)
;
}
_openInInternalViewer
(
aArgsOrURL
aPageDescriptor
aDocument
aLineNumber
)
{
var
charset
=
null
;
var
isForcedCharset
=
false
;
if
(
aDocument
)
{
if
(
Components
.
utils
.
isCrossProcessWrapper
(
aDocument
)
)
{
throw
new
Error
(
"
View
Source
cannot
accept
a
CPOW
as
a
document
.
"
)
;
}
charset
=
"
charset
=
"
+
aDocument
.
characterSet
;
try
{
isForcedCharset
=
aDocument
.
defaultView
.
QueryInterface
(
Components
.
interfaces
.
nsIInterfaceRequestor
)
.
getInterface
(
Components
.
interfaces
.
nsIDOMWindowUtils
)
.
docCharsetIsForced
;
}
catch
(
ex
)
{
}
}
Services
.
telemetry
.
getHistogramById
(
"
VIEW_SOURCE_IN_WINDOW_OPENED_BOOLEAN
"
)
.
add
(
true
)
;
openDialog
(
"
chrome
:
/
/
global
/
content
/
viewSource
.
xul
"
"
_blank
"
"
all
dialog
=
no
"
aArgsOrURL
charset
aPageDescriptor
aLineNumber
isForcedCharset
)
;
}
buildEditorArgs
(
aPath
aLineNumber
)
{
var
editorArgs
=
[
]
;
var
args
=
Services
.
prefs
.
getCharPref
(
"
view_source
.
editor
.
args
"
)
;
if
(
args
)
{
args
=
args
.
replace
(
"
%
LINE
%
"
aLineNumber
|
|
"
0
"
)
;
const
argumentRE
=
/
"
(
[
^
"
]
+
)
"
|
(
\
S
+
)
/
g
;
while
(
argumentRE
.
test
(
args
)
)
editorArgs
.
push
(
RegExp
.
1
|
|
RegExp
.
2
)
;
}
editorArgs
.
push
(
aPath
)
;
return
editorArgs
;
}
openInExternalEditor
(
aArgsOrURL
aPageDescriptor
aDocument
aLineNumber
aCallBack
)
{
let
data
;
if
(
typeof
aArgsOrURL
=
=
"
string
"
)
{
Deprecated
.
warning
(
"
The
arguments
you
'
re
passing
to
"
+
"
openInExternalEditor
are
using
an
out
-
of
-
date
API
.
"
"
https
:
/
/
developer
.
mozilla
.
org
/
en
-
US
/
Add
-
ons
/
"
+
"
Code_snippets
/
View_Source_for_XUL_Applications
"
)
;
if
(
Components
.
utils
.
isCrossProcessWrapper
(
aDocument
)
)
{
throw
new
Error
(
"
View
Source
cannot
accept
a
CPOW
as
a
document
.
"
)
;
}
data
=
{
url
:
aArgsOrURL
pageDescriptor
:
aPageDescriptor
doc
:
aDocument
lineNumber
:
aLineNumber
isPrivate
:
false
}
;
if
(
aDocument
)
{
data
.
isPrivate
=
PrivateBrowsingUtils
.
isWindowPrivate
(
aDocument
.
defaultView
)
;
}
}
else
{
let
{
URL
browser
lineNumber
}
=
aArgsOrURL
;
data
=
{
url
:
URL
lineNumber
isPrivate
:
false
}
;
if
(
browser
)
{
data
.
doc
=
{
characterSet
:
browser
.
characterSet
contentType
:
browser
.
documentContentType
title
:
browser
.
contentTitle
}
;
data
.
isPrivate
=
PrivateBrowsingUtils
.
isBrowserPrivate
(
browser
)
;
}
}
try
{
var
editor
=
this
.
getExternalViewSourceEditor
(
)
;
if
(
!
editor
)
{
this
.
handleCallBack
(
aCallBack
false
data
)
;
return
;
}
var
charset
=
data
.
doc
?
data
.
doc
.
characterSet
:
null
;
var
uri
=
Services
.
io
.
newURI
(
data
.
url
charset
)
;
data
.
uri
=
uri
;
var
path
;
var
contentType
=
data
.
doc
?
data
.
doc
.
contentType
:
null
;
if
(
uri
.
scheme
=
=
"
file
"
)
{
path
=
uri
.
QueryInterface
(
Components
.
interfaces
.
nsIFileURL
)
.
file
.
path
;
var
editorArgs
=
this
.
buildEditorArgs
(
path
data
.
lineNumber
)
;
editor
.
runw
(
false
editorArgs
editorArgs
.
length
)
;
this
.
handleCallBack
(
aCallBack
true
data
)
;
}
else
{
this
.
viewSourceProgressListener
.
contentLoaded
=
false
;
this
.
viewSourceProgressListener
.
editor
=
editor
;
this
.
viewSourceProgressListener
.
callBack
=
aCallBack
;
this
.
viewSourceProgressListener
.
data
=
data
;
if
(
!
data
.
pageDescriptor
)
{
var
file
=
this
.
getTemporaryFile
(
uri
data
.
doc
contentType
)
;
this
.
viewSourceProgressListener
.
file
=
file
;
var
webBrowserPersist
=
Components
.
classes
[
"
mozilla
.
org
/
embedding
/
browser
/
nsWebBrowserPersist
;
1
"
]
.
createInstance
(
this
.
mnsIWebBrowserPersist
)
;
webBrowserPersist
.
persistFlags
=
this
.
mnsIWebBrowserPersist
.
PERSIST_FLAGS_REPLACE_EXISTING_FILES
;
webBrowserPersist
.
progressListener
=
this
.
viewSourceProgressListener
;
let
referrerPolicy
=
Components
.
interfaces
.
nsIHttpChannel
.
REFERRER_POLICY_NO_REFERRER
;
webBrowserPersist
.
savePrivacyAwareURI
(
uri
null
null
referrerPolicy
null
null
file
data
.
isPrivate
)
;
let
helperService
=
Components
.
classes
[
"
mozilla
.
org
/
uriloader
/
external
-
helper
-
app
-
service
;
1
"
]
.
getService
(
Components
.
interfaces
.
nsPIExternalAppLauncher
)
;
if
(
data
.
isPrivate
)
{
helperService
.
deleteTemporaryPrivateFileWhenPossible
(
file
)
;
}
else
{
helperService
.
deleteTemporaryFileOnExit
(
file
)
;
}
}
else
{
var
webShell
=
Components
.
classes
[
"
mozilla
.
org
/
docshell
;
1
"
]
.
createInstance
(
)
;
webShell
.
QueryInterface
(
Components
.
interfaces
.
nsIBaseWindow
)
.
create
(
)
;
this
.
viewSourceProgressListener
.
webShell
=
webShell
;
var
progress
=
webShell
.
QueryInterface
(
this
.
mnsIWebProgress
)
;
progress
.
addProgressListener
(
this
.
viewSourceProgressListener
this
.
mnsIWebProgress
.
NOTIFY_STATE_DOCUMENT
)
;
var
pageLoader
=
webShell
.
QueryInterface
(
this
.
mnsIWebPageDescriptor
)
;
pageLoader
.
loadPage
(
data
.
pageDescriptor
this
.
mnsIWebPageDescriptor
.
DISPLAY_AS_SOURCE
)
;
}
}
}
catch
(
ex
)
{
Components
.
utils
.
reportError
(
ex
)
;
this
.
handleCallBack
(
aCallBack
false
data
)
;
}
}
internalViewerFallback
(
result
data
)
{
if
(
!
result
)
{
this
.
_openInInternalViewer
(
data
.
url
data
.
pageDescriptor
data
.
doc
data
.
lineNumber
)
;
}
}
handleCallBack
(
aCallBack
result
data
)
{
Services
.
telemetry
.
getHistogramById
(
"
VIEW_SOURCE_EXTERNAL_RESULT_BOOLEAN
"
)
.
add
(
result
)
;
if
(
aCallBack
=
=
=
undefined
)
{
this
.
internalViewerFallback
(
result
data
)
;
}
else
if
(
aCallBack
)
{
aCallBack
(
result
data
)
;
}
}
getExternalViewSourceEditor
(
)
{
try
{
let
viewSourceAppPath
=
Services
.
prefs
.
getComplexValue
(
"
view_source
.
editor
.
path
"
Components
.
interfaces
.
nsIFile
)
;
let
editor
=
Components
.
classes
[
"
mozilla
.
org
/
process
/
util
;
1
"
]
.
createInstance
(
Components
.
interfaces
.
nsIProcess
)
;
editor
.
init
(
viewSourceAppPath
)
;
return
editor
;
}
catch
(
ex
)
{
Components
.
utils
.
reportError
(
ex
)
;
}
return
null
;
}
viewSourceProgressListener
:
{
mnsIWebProgressListener
:
Components
.
interfaces
.
nsIWebProgressListener
QueryInterface
(
aIID
)
{
if
(
aIID
.
equals
(
this
.
mnsIWebProgressListener
)
|
|
aIID
.
equals
(
Components
.
interfaces
.
nsISupportsWeakReference
)
|
|
aIID
.
equals
(
Components
.
interfaces
.
nsISupports
)
)
return
this
;
throw
Components
.
results
.
NS_NOINTERFACE
;
}
destroy
(
)
{
if
(
this
.
webShell
)
{
this
.
webShell
.
QueryInterface
(
Components
.
interfaces
.
nsIBaseWindow
)
.
destroy
(
)
;
}
this
.
webShell
=
null
;
this
.
editor
=
null
;
this
.
callBack
=
null
;
this
.
data
=
null
;
this
.
file
=
null
;
}
onStateChange
(
aProgress
aRequest
aFlag
aStatus
)
{
if
(
(
aFlag
&
this
.
mnsIWebProgressListener
.
STATE_STOP
)
&
&
aStatus
=
=
0
)
{
if
(
!
this
.
webShell
)
{
this
.
onContentLoaded
(
)
;
return
0
;
}
var
webNavigation
=
this
.
webShell
.
QueryInterface
(
Components
.
interfaces
.
nsIWebNavigation
)
;
if
(
webNavigation
.
document
.
readyState
=
=
"
complete
"
)
{
this
.
onContentLoaded
(
)
;
}
else
{
webNavigation
.
document
.
addEventListener
(
"
DOMContentLoaded
"
this
.
onContentLoaded
.
bind
(
this
)
)
;
}
}
return
0
;
}
onContentLoaded
(
)
{
if
(
this
.
contentLoaded
)
{
return
;
}
try
{
if
(
!
this
.
file
)
{
this
.
file
=
gViewSourceUtils
.
getTemporaryFile
(
this
.
data
.
uri
this
.
data
.
doc
this
.
data
.
doc
.
contentType
)
;
var
webNavigation
=
this
.
webShell
.
QueryInterface
(
Components
.
interfaces
.
nsIWebNavigation
)
;
var
foStream
=
Components
.
classes
[
"
mozilla
.
org
/
network
/
file
-
output
-
stream
;
1
"
]
.
createInstance
(
Components
.
interfaces
.
nsIFileOutputStream
)
;
foStream
.
init
(
this
.
file
0x02
|
0x08
|
0x20
-
1
0
)
;
var
coStream
=
Components
.
classes
[
"
mozilla
.
org
/
intl
/
converter
-
output
-
stream
;
1
"
]
.
createInstance
(
Components
.
interfaces
.
nsIConverterOutputStream
)
;
coStream
.
init
(
foStream
this
.
data
.
doc
.
characterSet
)
;
coStream
.
writeString
(
webNavigation
.
document
.
body
.
textContent
)
;
coStream
.
close
(
)
;
foStream
.
close
(
)
;
let
helperService
=
Components
.
classes
[
"
mozilla
.
org
/
uriloader
/
external
-
helper
-
app
-
service
;
1
"
]
.
getService
(
Components
.
interfaces
.
nsPIExternalAppLauncher
)
;
if
(
this
.
data
.
isPrivate
)
{
helperService
.
deleteTemporaryPrivateFileWhenPossible
(
this
.
file
)
;
}
else
{
helperService
.
deleteTemporaryFileOnExit
(
this
.
file
)
;
}
}
var
editorArgs
=
gViewSourceUtils
.
buildEditorArgs
(
this
.
file
.
path
this
.
data
.
lineNumber
)
;
this
.
editor
.
runw
(
false
editorArgs
editorArgs
.
length
)
;
this
.
contentLoaded
=
true
;
gViewSourceUtils
.
handleCallBack
(
this
.
callBack
true
this
.
data
)
;
}
catch
(
ex
)
{
Components
.
utils
.
reportError
(
ex
)
;
gViewSourceUtils
.
handleCallBack
(
this
.
callBack
false
this
.
data
)
;
}
finally
{
this
.
destroy
(
)
;
}
}
webShell
:
null
editor
:
null
callBack
:
null
data
:
null
file
:
null
}
getTemporaryFile
(
aURI
aDocument
aContentType
)
{
if
(
!
this
.
_caUtils
)
{
this
.
_caUtils
=
{
}
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
global
/
content
/
contentAreaUtils
.
js
"
this
.
_caUtils
)
;
}
var
tempFile
=
Services
.
dirsvc
.
get
(
"
TmpD
"
Components
.
interfaces
.
nsIFile
)
;
var
fileName
=
this
.
_caUtils
.
getDefaultFileName
(
null
aURI
aDocument
aContentType
)
;
var
extension
=
this
.
_caUtils
.
getDefaultExtension
(
fileName
aURI
aContentType
)
;
var
leafName
=
this
.
_caUtils
.
getNormalizedLeafName
(
fileName
extension
)
;
tempFile
.
append
(
leafName
)
;
return
tempFile
;
}
}
;
