Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
PromiseUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Preferences
.
jsm
"
)
;
const
WINDOW_TYPE
=
"
navigator
:
view
-
source
"
;
function
openViewSourceWindow
(
aURI
aCallback
)
{
let
viewSourceWindow
=
openDialog
(
"
chrome
:
/
/
global
/
content
/
viewSource
.
xul
"
null
null
aURI
)
;
viewSourceWindow
.
addEventListener
(
"
pageshow
"
function
pageShowHandler
(
event
)
{
if
(
event
.
target
.
location
=
=
"
view
-
source
:
"
+
aURI
)
{
info
(
"
View
source
window
opened
:
"
+
event
.
target
.
location
)
;
viewSourceWindow
.
removeEventListener
(
"
pageshow
"
pageShowHandler
)
;
aCallback
(
viewSourceWindow
)
;
}
}
)
;
}
function
loadViewSourceWindow
(
URL
)
{
return
new
Promise
(
(
resolve
)
=
>
{
openViewSourceWindow
(
URL
resolve
)
;
}
)
}
function
closeViewSourceWindow
(
aWindow
aCallback
)
{
return
new
Promise
(
resolve
=
>
{
Services
.
wm
.
addListener
(
{
onCloseWindow
(
)
{
Services
.
wm
.
removeListener
(
this
)
;
if
(
aCallback
)
{
executeSoon
(
aCallback
)
;
}
resolve
(
)
;
}
}
)
;
aWindow
.
close
(
)
;
}
)
;
}
function
testViewSourceWindow
(
aURI
aTestCallback
aCloseCallback
)
{
openViewSourceWindow
(
aURI
function
(
aWindow
)
{
aTestCallback
(
aWindow
)
;
closeViewSourceWindow
(
aWindow
aCloseCallback
)
;
}
)
;
}
function
waitForViewSourceWindow
(
)
{
return
new
Promise
(
resolve
=
>
{
let
windowListener
=
{
onOpenWindow
(
xulWindow
)
{
let
win
=
xulWindow
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDOMWindow
)
;
win
.
addEventListener
(
"
load
"
function
(
)
{
if
(
win
.
document
.
documentElement
.
getAttribute
(
"
windowtype
"
)
!
=
WINDOW_TYPE
)
{
return
;
}
resolve
(
win
)
;
Services
.
wm
.
removeListener
(
windowListener
)
;
}
{
once
:
true
}
)
;
}
onCloseWindow
(
)
{
}
onWindowTitleChange
(
)
{
}
}
;
Services
.
wm
.
addListener
(
windowListener
)
;
}
)
;
}
async
function
openViewSource
(
browser
)
{
let
openPromise
;
if
(
Services
.
prefs
.
getBoolPref
(
"
view_source
.
tab
"
)
)
{
openPromise
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
null
)
;
}
else
{
openPromise
=
waitForViewSourceWindow
(
)
;
}
window
.
BrowserViewSource
(
browser
)
;
return
(
await
openPromise
)
;
}
async
function
openViewPartialSource
(
aCSSSelector
)
{
let
contentAreaContextMenuPopup
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
let
popupShownPromise
=
BrowserTestUtils
.
waitForEvent
(
contentAreaContextMenuPopup
"
popupshown
"
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
aCSSSelector
{
type
:
"
contextmenu
"
button
:
2
}
gBrowser
.
selectedBrowser
)
;
await
popupShownPromise
;
let
openPromise
;
if
(
Services
.
prefs
.
getBoolPref
(
"
view_source
.
tab
"
)
)
{
openPromise
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
null
)
;
}
else
{
openPromise
=
waitForViewSourceWindow
(
)
;
}
let
popupHiddenPromise
=
BrowserTestUtils
.
waitForEvent
(
contentAreaContextMenuPopup
"
popuphidden
"
)
;
let
item
=
document
.
getElementById
(
"
context
-
viewpartialsource
-
selection
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
item
{
}
)
;
await
popupHiddenPromise
;
return
(
await
openPromise
)
;
}
async
function
openViewFrameSourceTab
(
aCSSSelector
)
{
let
contentAreaContextMenuPopup
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
let
popupShownPromise
=
BrowserTestUtils
.
waitForEvent
(
contentAreaContextMenuPopup
"
popupshown
"
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
aCSSSelector
{
type
:
"
contextmenu
"
button
:
2
}
gBrowser
.
selectedBrowser
)
;
await
popupShownPromise
;
let
frameContextMenu
=
document
.
getElementById
(
"
frame
"
)
;
popupShownPromise
=
BrowserTestUtils
.
waitForEvent
(
frameContextMenu
"
popupshown
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
frameContextMenu
{
}
)
;
await
popupShownPromise
;
let
newTabPromise
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
null
)
;
let
popupHiddenPromise
=
BrowserTestUtils
.
waitForEvent
(
frameContextMenu
"
popuphidden
"
)
;
let
item
=
document
.
getElementById
(
"
context
-
viewframesource
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
item
{
}
)
;
await
popupHiddenPromise
;
return
(
await
newTabPromise
)
;
}
registerCleanupFunction
(
function
(
)
{
var
windows
=
Services
.
wm
.
getEnumerator
(
WINDOW_TYPE
)
;
ok
(
!
windows
.
hasMoreElements
(
)
"
No
remaining
view
source
windows
still
open
"
)
;
while
(
windows
.
hasMoreElements
(
)
)
windows
.
getNext
(
)
.
close
(
)
;
}
)
;
function
waitForSourceLoaded
(
tabOrWindow
)
{
return
new
Promise
(
resolve
=
>
{
let
mm
=
tabOrWindow
.
messageManager
|
|
tabOrWindow
.
linkedBrowser
.
messageManager
;
mm
.
addMessageListener
(
"
ViewSource
:
SourceLoaded
"
function
sourceLoaded
(
)
{
mm
.
removeMessageListener
(
"
ViewSource
:
SourceLoaded
"
sourceLoaded
)
;
setTimeout
(
resolve
0
)
;
}
)
;
}
)
;
}
async
function
openDocumentSelect
(
aURI
aCSSSelector
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
aURI
)
;
registerCleanupFunction
(
function
(
)
{
gBrowser
.
removeTab
(
tab
)
;
}
)
;
await
ContentTask
.
spawn
(
gBrowser
.
selectedBrowser
{
selector
:
aCSSSelector
}
async
function
(
arg
)
{
let
element
=
content
.
document
.
querySelector
(
arg
.
selector
)
;
content
.
getSelection
(
)
.
selectAllChildren
(
element
)
;
}
)
;
let
tabOrWindow
=
await
openViewPartialSource
(
aCSSSelector
)
;
await
waitForSourceLoaded
(
tabOrWindow
)
;
return
tabOrWindow
;
}
function
pushPrefs
(
.
.
.
aPrefs
)
{
return
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
aPrefs
}
)
;
}
function
waitForPrefChange
(
pref
)
{
let
deferred
=
PromiseUtils
.
defer
(
)
;
let
observer
=
(
)
=
>
{
Preferences
.
ignore
(
pref
observer
)
;
deferred
.
resolve
(
)
;
}
;
Preferences
.
observe
(
pref
observer
)
;
return
deferred
.
promise
;
}
