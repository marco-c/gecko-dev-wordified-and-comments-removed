"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
formAutofillStorage
"
"
FormAutofillStorage
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
sys
.
mjs
"
)
;
const
{
FormAutofillStorageBase
CreditCardsBase
AddressesBase
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
autofill
/
FormAutofillStorageBase
.
jsm
"
)
;
const
{
JSONFile
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
JSONFile
.
sys
.
mjs
"
)
;
const
lazy
=
{
}
;
XPCOMUtils
.
defineLazyModuleGetters
(
lazy
{
Address
:
"
resource
:
/
/
gre
/
modules
/
GeckoViewAutocomplete
.
jsm
"
CreditCard
:
"
resource
:
/
/
gre
/
modules
/
GeckoViewAutocomplete
.
jsm
"
GeckoViewAutocomplete
:
"
resource
:
/
/
gre
/
modules
/
GeckoViewAutocomplete
.
jsm
"
}
)
;
class
GeckoViewStorage
extends
JSONFile
{
constructor
(
)
{
super
(
{
path
:
null
sanitizedBasename
:
"
GeckoViewStorage
"
}
)
;
}
async
updateCreditCards
(
)
{
const
creditCards
=
await
lazy
.
GeckoViewAutocomplete
.
fetchCreditCards
(
)
.
then
(
results
=
>
results
?
.
map
(
r
=
>
lazy
.
CreditCard
.
parse
(
r
)
.
toGecko
(
)
)
?
?
[
]
_
=
>
[
]
)
;
super
.
data
.
creditCards
=
creditCards
;
}
async
updateAddresses
(
)
{
const
addresses
=
await
lazy
.
GeckoViewAutocomplete
.
fetchAddresses
(
)
.
then
(
results
=
>
results
?
.
map
(
r
=
>
lazy
.
Address
.
parse
(
r
)
.
toGecko
(
)
)
?
?
[
]
_
=
>
[
]
)
;
super
.
data
.
addresses
=
addresses
;
}
async
load
(
)
{
super
.
data
=
{
creditCards
:
{
}
addresses
:
{
}
}
;
await
this
.
updateCreditCards
(
)
;
await
this
.
updateAddresses
(
)
;
}
ensureDataReady
(
)
{
if
(
this
.
dataReady
)
{
return
;
}
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
async
_save
(
)
{
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
}
class
Addresses
extends
AddressesBase
{
_initialize
(
)
{
this
.
_initializePromise
=
Promise
.
resolve
(
)
;
}
async
_saveRecord
(
record
{
sourceSync
=
false
}
=
{
}
)
{
lazy
.
GeckoViewAutocomplete
.
onAddressSave
(
lazy
.
Address
.
fromGecko
(
record
)
)
;
}
async
get
(
guid
{
rawData
=
false
}
=
{
}
)
{
await
this
.
_store
.
updateAddresses
(
)
;
return
super
.
get
(
guid
{
rawData
}
)
;
}
async
getAll
(
{
rawData
=
false
includeDeleted
=
false
}
=
{
}
)
{
await
this
.
_store
.
updateAddresses
(
)
;
return
super
.
getAll
(
{
rawData
includeDeleted
}
)
;
}
async
getSavedFieldNames
(
)
{
await
this
.
_store
.
updateAddresses
(
)
;
return
super
.
getSavedFieldNames
(
)
;
}
async
reconcile
(
remoteRecord
)
{
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
async
findDuplicateGUID
(
remoteRecord
)
{
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
async
mergeToStorage
(
targetRecord
strict
=
false
)
{
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
}
class
CreditCards
extends
CreditCardsBase
{
async
_encryptNumber
(
creditCard
)
{
}
_initialize
(
)
{
this
.
_initializePromise
=
Promise
.
resolve
(
)
;
}
async
_saveRecord
(
record
{
sourceSync
=
false
}
=
{
}
)
{
lazy
.
GeckoViewAutocomplete
.
onCreditCardSave
(
lazy
.
CreditCard
.
fromGecko
(
record
)
)
;
}
async
get
(
guid
{
rawData
=
false
}
=
{
}
)
{
await
this
.
_store
.
updateCreditCards
(
)
;
return
super
.
get
(
guid
{
rawData
}
)
;
}
async
getAll
(
{
rawData
=
false
includeDeleted
=
false
}
=
{
}
)
{
await
this
.
_store
.
updateCreditCards
(
)
;
return
super
.
getAll
(
{
rawData
includeDeleted
}
)
;
}
async
getSavedFieldNames
(
)
{
await
this
.
_store
.
updateCreditCards
(
)
;
return
super
.
getSavedFieldNames
(
)
;
}
async
*
getDuplicateRecords
(
record
)
{
if
(
!
record
[
"
cc
-
number
"
]
)
{
return
null
;
}
await
this
.
_store
.
updateCreditCards
(
)
;
for
(
const
recordInStorage
of
this
.
_data
)
{
if
(
recordInStorage
.
deleted
)
{
continue
;
}
if
(
recordInStorage
[
"
cc
-
number
"
]
=
=
record
[
"
cc
-
number
"
]
)
{
yield
recordInStorage
;
}
}
return
null
;
}
async
reconcile
(
remoteRecord
)
{
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
async
findDuplicateGUID
(
remoteRecord
)
{
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
async
mergeToStorage
(
targetRecord
strict
=
false
)
{
throw
Components
.
Exception
(
"
"
Cr
.
NS_ERROR_NOT_IMPLEMENTED
)
;
}
}
class
FormAutofillStorage
extends
FormAutofillStorageBase
{
constructor
(
)
{
super
(
null
)
;
}
getAddresses
(
)
{
if
(
!
this
.
_addresses
)
{
this
.
_store
.
ensureDataReady
(
)
;
this
.
_addresses
=
new
Addresses
(
this
.
_store
)
;
}
return
this
.
_addresses
;
}
getCreditCards
(
)
{
if
(
!
this
.
_creditCards
)
{
this
.
_store
.
ensureDataReady
(
)
;
this
.
_creditCards
=
new
CreditCards
(
this
.
_store
)
;
}
return
this
.
_creditCards
;
}
_initializeStore
(
)
{
return
new
GeckoViewStorage
(
)
;
}
}
const
formAutofillStorage
=
new
FormAutofillStorage
(
)
;
