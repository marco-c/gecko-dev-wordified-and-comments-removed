#
ifndef
PerformanceMetricsCollector_h
#
define
PerformanceMetricsCollector_h
#
include
"
nsIObserver
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsID
.
h
"
#
include
"
mozilla
/
dom
/
ChromeUtilsBinding
.
h
"
#
include
"
mozilla
/
dom
/
DOMTypes
.
h
"
#
include
"
mozilla
/
PerformanceTypes
.
h
"
namespace
mozilla
{
namespace
dom
{
class
Promise
;
}
class
PerformanceMetricsCollector
;
class
AggregatedResults
;
class
IPCTimeout
final
:
public
nsIObserver
{
public
:
NS_DECL_NSIOBSERVER
NS_DECL_ISUPPORTS
static
IPCTimeout
*
CreateInstance
(
AggregatedResults
*
aResults
)
;
void
Cancel
(
)
;
private
:
IPCTimeout
(
AggregatedResults
*
aResults
uint32_t
aDelay
)
;
~
IPCTimeout
(
)
;
nsCOMPtr
<
nsITimer
>
mTimer
;
AggregatedResults
*
mResults
;
}
;
class
AggregatedResults
final
{
public
:
AggregatedResults
(
nsID
aUUID
PerformanceMetricsCollector
*
aCollector
)
;
~
AggregatedResults
(
)
=
default
;
void
AppendResult
(
const
nsTArray
<
dom
:
:
PerformanceInfo
>
&
aMetrics
)
;
void
SetNumResultsRequired
(
uint32_t
aNumResultsRequired
)
;
void
Abort
(
nsresult
aReason
)
;
void
ResolveNow
(
)
;
RefPtr
<
RequestMetricsPromise
>
GetPromise
(
)
;
private
:
RefPtr
<
IPCTimeout
>
mIPCTimeout
;
MozPromiseHolder
<
RequestMetricsPromise
>
mHolder
;
uint32_t
mPendingResults
;
FallibleTArray
<
dom
:
:
PerformanceInfoDictionary
>
mData
;
RefPtr
<
PerformanceMetricsCollector
>
mCollector
;
nsID
mUUID
;
}
;
class
PerformanceMetricsCollector
final
{
public
:
NS_INLINE_DECL_REFCOUNTING
(
PerformanceMetricsCollector
)
static
RefPtr
<
RequestMetricsPromise
>
RequestMetrics
(
)
;
static
nsresult
DataReceived
(
const
nsID
&
aUUID
const
nsTArray
<
dom
:
:
PerformanceInfo
>
&
aMetrics
)
;
void
ForgetAggregatedResults
(
const
nsID
&
aUUID
)
;
private
:
~
PerformanceMetricsCollector
(
)
;
RefPtr
<
RequestMetricsPromise
>
RequestMetricsInternal
(
)
;
nsresult
DataReceivedInternal
(
const
nsID
&
aUUID
const
nsTArray
<
dom
:
:
PerformanceInfo
>
&
aMetrics
)
;
nsDataHashtable
<
nsIDHashKey
UniquePtr
<
AggregatedResults
>
>
mAggregatedResults
;
}
;
}
#
endif
