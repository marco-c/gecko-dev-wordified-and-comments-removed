#
include
"
mozilla
/
PerformanceUtils
.
h
"
#
include
"
mozilla
/
dom
/
DOMTypes
.
h
"
#
include
"
mozilla
/
dom
/
DocGroup
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContextGroup
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
WorkerDebugger
.
h
"
#
include
"
mozilla
/
dom
/
WorkerDebuggerManager
.
h
"
#
include
"
MediaDecoder
.
h
"
#
include
"
jsfriendapi
.
h
"
#
include
"
nsGlobalWindowOuter
.
h
"
#
include
"
nsWindowSizes
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
namespace
mozilla
{
nsTArray
<
RefPtr
<
PerformanceInfoPromise
>
>
CollectPerformanceInfo
(
)
{
nsTArray
<
RefPtr
<
PerformanceInfoPromise
>
>
promises
;
RefPtr
<
mozilla
:
:
dom
:
:
WorkerDebuggerManager
>
wdm
=
WorkerDebuggerManager
:
:
GetOrCreate
(
)
;
if
(
NS_WARN_IF
(
!
wdm
)
)
{
return
promises
;
}
for
(
uint32_t
i
=
0
;
i
<
wdm
-
>
GetDebuggersLength
(
)
;
i
+
+
)
{
const
RefPtr
<
WorkerDebugger
>
debugger
=
wdm
-
>
GetDebuggerAt
(
i
)
;
promises
.
AppendElement
(
debugger
-
>
ReportPerformanceInfo
(
)
)
;
}
nsTArray
<
RefPtr
<
BrowsingContextGroup
>
>
groups
;
BrowsingContextGroup
:
:
GetAllGroups
(
groups
)
;
nsTArray
<
DocGroup
*
>
docGroups
;
for
(
auto
&
browsingContextGroup
:
groups
)
{
browsingContextGroup
-
>
GetDocGroups
(
docGroups
)
;
}
for
(
DocGroup
*
docGroup
:
docGroups
)
{
promises
.
AppendElement
(
docGroup
-
>
ReportPerformanceInfo
(
)
)
;
}
return
promises
;
}
void
AddWindowTabSizes
(
nsGlobalWindowOuter
*
aWindow
nsTabSizes
*
aSizes
)
{
Document
*
document
=
aWindow
-
>
GetDocument
(
)
;
if
(
document
&
&
document
-
>
GetCachedSizes
(
aSizes
)
)
{
return
;
}
nsTabSizes
sizes
;
SizeOfState
state
(
moz_malloc_size_of
)
;
nsWindowSizes
windowSizes
(
state
)
;
aWindow
-
>
AddSizeOfIncludingThis
(
windowSizes
)
;
nsGlobalWindowInner
*
inner
=
aWindow
-
>
GetCurrentInnerWindowInternal
(
)
;
if
(
inner
!
=
nullptr
)
{
inner
-
>
AddSizeOfIncludingThis
(
windowSizes
)
;
}
windowSizes
.
addToTabSizes
(
&
sizes
)
;
if
(
document
)
{
document
-
>
SetCachedSizes
(
&
sizes
)
;
}
aSizes
-
>
mDom
+
=
sizes
.
mDom
;
aSizes
-
>
mStyle
+
=
sizes
.
mStyle
;
aSizes
-
>
mOther
+
=
sizes
.
mOther
;
}
nsresult
GetTabSizes
(
BrowsingContext
*
aContext
nsTabSizes
*
aSizes
)
{
if
(
!
aContext
)
{
return
NS_OK
;
}
nsGlobalWindowOuter
*
window
=
nsGlobalWindowOuter
:
:
Cast
(
aContext
-
>
GetDOMWindow
(
)
)
;
if
(
window
)
{
AddWindowTabSizes
(
window
aSizes
)
;
}
for
(
const
auto
&
child
:
aContext
-
>
Children
(
)
)
{
MOZ_TRY
(
GetTabSizes
(
child
aSizes
)
)
;
}
return
NS_OK
;
}
RefPtr
<
MemoryPromise
>
CollectMemoryInfo
(
const
RefPtr
<
DocGroup
>
&
aDocGroup
const
RefPtr
<
AbstractThread
>
&
aEventTarget
)
{
nsTabSizes
sizes
;
for
(
const
auto
&
document
:
*
aDocGroup
)
{
nsGlobalWindowOuter
*
window
=
document
?
nsGlobalWindowOuter
:
:
Cast
(
document
-
>
GetWindow
(
)
)
:
nullptr
;
if
(
window
)
{
AddWindowTabSizes
(
window
&
sizes
)
;
}
}
BrowsingContextGroup
*
group
=
aDocGroup
-
>
GetBrowsingContextGroup
(
)
;
uint64_t
GCHeapUsage
=
0
;
JSObject
*
object
=
group
-
>
GetWrapper
(
)
;
if
(
object
!
=
nullptr
)
{
GCHeapUsage
=
js
:
:
GetGCHeapUsageForObjectZone
(
object
)
;
}
return
GetMediaMemorySizes
(
)
-
>
Then
(
aEventTarget
__func__
[
GCHeapUsage
sizes
]
(
const
MediaMemoryInfo
&
media
)
{
return
MemoryPromise
:
:
CreateAndResolve
(
PerformanceMemoryInfo
(
media
sizes
.
mDom
sizes
.
mStyle
sizes
.
mOther
GCHeapUsage
)
__func__
)
;
}
[
]
(
const
nsresult
rv
)
{
return
MemoryPromise
:
:
CreateAndReject
(
rv
__func__
)
;
}
)
;
}
RefPtr
<
MemoryPromise
>
CollectMemoryInfo
(
const
RefPtr
<
BrowsingContext
>
&
aContext
const
RefPtr
<
AbstractThread
>
&
aEventTarget
)
{
nsTabSizes
sizes
;
nsresult
rv
=
GetTabSizes
(
aContext
&
sizes
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
MemoryPromise
:
:
CreateAndReject
(
rv
__func__
)
;
}
JSObject
*
obj
=
aContext
-
>
GetWrapper
(
)
;
uint64_t
GCHeapUsage
=
0
;
if
(
obj
!
=
nullptr
)
{
GCHeapUsage
=
js
:
:
GetGCHeapUsageForObjectZone
(
obj
)
;
}
return
GetMediaMemorySizes
(
)
-
>
Then
(
aEventTarget
__func__
[
GCHeapUsage
sizes
]
(
const
MediaMemoryInfo
&
media
)
{
return
MemoryPromise
:
:
CreateAndResolve
(
PerformanceMemoryInfo
(
media
sizes
.
mDom
sizes
.
mStyle
sizes
.
mOther
GCHeapUsage
)
__func__
)
;
}
[
]
(
const
nsresult
rv
)
{
return
MemoryPromise
:
:
CreateAndReject
(
rv
__func__
)
;
}
)
;
}
}
