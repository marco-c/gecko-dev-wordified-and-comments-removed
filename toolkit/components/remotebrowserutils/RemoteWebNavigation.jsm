ChromeUtils
.
defineModuleGetter
(
this
"
Services
"
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
Utils
"
"
resource
:
/
/
gre
/
modules
/
sessionstore
/
Utils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
PrivateBrowsingUtils
"
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
E10SUtils
"
"
resource
:
/
/
gre
/
modules
/
E10SUtils
.
jsm
"
)
;
function
RemoteWebNavigation
(
)
{
this
.
wrappedJSObject
=
this
;
this
.
_cancelContentJSEpoch
=
1
;
}
RemoteWebNavigation
.
prototype
=
{
classDescription
:
"
nsIWebNavigation
for
remote
browsers
"
classID
:
Components
.
ID
(
"
{
4b56964e
-
cdf3
-
4bb8
-
830c
-
0e2dad3f4ebd
}
"
)
contractID
:
"
mozilla
.
org
/
remote
-
web
-
navigation
;
1
"
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIWebNavigation
]
)
swapBrowser
(
aBrowser
)
{
this
.
_browser
=
aBrowser
;
}
LOAD_FLAGS_MASK
:
65535
LOAD_FLAGS_NONE
:
0
LOAD_FLAGS_IS_REFRESH
:
16
LOAD_FLAGS_IS_LINK
:
32
LOAD_FLAGS_BYPASS_HISTORY
:
64
LOAD_FLAGS_REPLACE_HISTORY
:
128
LOAD_FLAGS_BYPASS_CACHE
:
256
LOAD_FLAGS_BYPASS_PROXY
:
512
LOAD_FLAGS_CHARSET_CHANGE
:
1024
LOAD_FLAGS_STOP_CONTENT
:
2048
LOAD_FLAGS_FROM_EXTERNAL
:
4096
LOAD_FLAGS_ALLOW_THIRD_PARTY_FIXUP
:
8192
LOAD_FLAGS_FIRST_LOAD
:
16384
LOAD_FLAGS_ALLOW_POPUPS
:
32768
LOAD_FLAGS_BYPASS_CLASSIFIER
:
65536
LOAD_FLAGS_FORCE_ALLOW_COOKIES
:
131072
STOP_NETWORK
:
1
STOP_CONTENT
:
2
STOP_ALL
:
3
canGoBack
:
false
canGoForward
:
false
goBack
(
)
{
let
cancelContentJSEpoch
=
this
.
_cancelContentJSEpoch
+
+
;
this
.
_browser
.
frameLoader
.
remoteTab
.
maybeCancelContentJSExecution
(
Ci
.
nsIRemoteTab
.
NAVIGATE_BACK
{
epoch
:
cancelContentJSEpoch
}
)
;
this
.
_sendMessage
(
"
WebNavigation
:
GoBack
"
{
cancelContentJSEpoch
}
)
;
}
goForward
(
)
{
let
cancelContentJSEpoch
=
this
.
_cancelContentJSEpoch
+
+
;
this
.
_browser
.
frameLoader
.
remoteTab
.
maybeCancelContentJSExecution
(
Ci
.
nsIRemoteTab
.
NAVIGATE_FORWARD
{
epoch
:
cancelContentJSEpoch
}
)
;
this
.
_sendMessage
(
"
WebNavigation
:
GoForward
"
{
cancelContentJSEpoch
}
)
;
}
gotoIndex
(
aIndex
)
{
let
cancelContentJSEpoch
=
this
.
_cancelContentJSEpoch
+
+
;
this
.
_browser
.
frameLoader
.
remoteTab
.
maybeCancelContentJSExecution
(
Ci
.
nsIRemoteTab
.
NAVIGATE_INDEX
{
index
:
aIndex
epoch
:
cancelContentJSEpoch
}
)
;
this
.
_sendMessage
(
"
WebNavigation
:
GotoIndex
"
{
index
:
aIndex
cancelContentJSEpoch
}
)
;
}
loadURI
(
aURI
aLoadURIOptions
)
{
let
uri
;
try
{
let
fixup
=
Cc
[
"
mozilla
.
org
/
docshell
/
urifixup
;
1
"
]
.
getService
(
)
;
let
fixupFlags
=
fixup
.
webNavigationFlagsToFixupFlags
(
aURI
aLoadURIOptions
.
loadFlags
)
;
uri
=
fixup
.
createFixupURI
(
aURI
fixupFlags
)
;
if
(
uri
.
schemeIs
(
"
http
"
)
|
|
uri
.
schemeIs
(
"
https
"
)
)
{
let
principal
=
aLoadURIOptions
.
triggeringPrincipal
;
if
(
!
principal
|
|
principal
.
isSystemPrincipal
)
{
let
attrs
=
{
userContextId
:
this
.
_browser
.
getAttribute
(
"
usercontextid
"
)
|
|
0
privateBrowsingId
:
PrivateBrowsingUtils
.
isBrowserPrivate
(
this
.
_browser
)
?
1
:
0
}
;
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipal
(
uri
attrs
)
;
}
Services
.
io
.
speculativeConnect
(
uri
principal
null
)
;
}
}
catch
(
ex
)
{
}
let
cancelContentJSEpoch
=
this
.
_cancelContentJSEpoch
+
+
;
this
.
_browser
.
frameLoader
.
remoteTab
.
maybeCancelContentJSExecution
(
Ci
.
nsIRemoteTab
.
NAVIGATE_URL
{
uri
epoch
:
cancelContentJSEpoch
}
)
;
this
.
_sendMessage
(
"
WebNavigation
:
LoadURI
"
{
uri
:
aURI
loadFlags
:
aLoadURIOptions
.
loadFlags
referrerInfo
:
E10SUtils
.
serializeReferrerInfo
(
aLoadURIOptions
.
referrerInfo
)
postData
:
aLoadURIOptions
.
postData
?
Utils
.
serializeInputStream
(
aLoadURIOptions
.
postData
)
:
null
headers
:
aLoadURIOptions
.
headers
?
Utils
.
serializeInputStream
(
aLoadURIOptions
.
headers
)
:
null
baseURI
:
aLoadURIOptions
.
baseURI
?
aLoadURIOptions
.
baseURI
.
spec
:
null
triggeringPrincipal
:
E10SUtils
.
serializePrincipal
(
aLoadURIOptions
.
triggeringPrincipal
|
|
Services
.
scriptSecurityManager
.
createNullPrincipal
(
{
}
)
)
csp
:
aLoadURIOptions
.
csp
?
E10SUtils
.
serializeCSP
(
aLoadURIOptions
.
csp
)
:
null
cancelContentJSEpoch
}
)
;
}
setOriginAttributesBeforeLoading
(
aOriginAttributes
)
{
this
.
_sendMessage
(
"
WebNavigation
:
SetOriginAttributes
"
{
originAttributes
:
aOriginAttributes
}
)
;
}
reload
(
aReloadFlags
)
{
this
.
_sendMessage
(
"
WebNavigation
:
Reload
"
{
loadFlags
:
aReloadFlags
}
)
;
}
stop
(
aStopFlags
)
{
this
.
_sendMessage
(
"
WebNavigation
:
Stop
"
{
loadFlags
:
aStopFlags
}
)
;
}
get
document
(
)
{
return
this
.
_browser
.
contentDocument
;
}
_currentURI
:
null
get
currentURI
(
)
{
if
(
!
this
.
_currentURI
)
{
this
.
_currentURI
=
Services
.
io
.
newURI
(
"
about
:
blank
"
)
;
}
return
this
.
_currentURI
;
}
set
currentURI
(
aURI
)
{
let
loadURIOptions
=
{
triggeringPrincipal
:
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
}
;
this
.
loadURI
(
aURI
.
spec
loadURIOptions
)
;
}
referringURI
:
null
get
sessionHistory
(
)
{
throw
Cr
.
NS_ERROR_NOT_IMPLEMENTED
;
}
set
sessionHistory
(
aValue
)
{
throw
Cr
.
NS_ERROR_NOT_IMPLEMENTED
;
}
_sendMessage
(
aMessage
aData
)
{
try
{
this
.
_browser
.
messageManager
.
sendAsyncMessage
(
aMessage
aData
)
;
}
catch
(
e
)
{
Cu
.
reportError
(
e
)
;
}
}
}
;
var
EXPORTED_SYMBOLS
=
[
"
RemoteWebNavigation
"
]
;
