#
include
<
inttypes
.
h
>
#
include
"
nsError
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
dom
/
UniFFIScaffolding
.
h
"
using
mozilla
:
:
dom
:
:
GlobalObject
;
using
mozilla
:
:
dom
:
:
Promise
;
using
mozilla
:
:
dom
:
:
RootedDictionary
;
using
mozilla
:
:
dom
:
:
ScaffoldingType
;
using
mozilla
:
:
dom
:
:
Sequence
;
using
mozilla
:
:
dom
:
:
UniFFIPointer
;
using
mozilla
:
:
dom
:
:
UniFFIScaffoldingCallResult
;
namespace
mozilla
:
:
uniffi
{
Maybe
<
already_AddRefed
<
Promise
>
>
UniFFICallAsync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
ScaffoldingType
>
&
aArgs
ErrorResult
&
aError
)
;
bool
UniFFICallSync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
ScaffoldingType
>
&
aArgs
RootedDictionary
<
UniFFIScaffoldingCallResult
>
&
aReturnValue
ErrorResult
&
aError
)
;
Maybe
<
already_AddRefed
<
UniFFIPointer
>
>
UniFFIReadPointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
;
bool
UniFFIWritePointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
UniFFIPointer
&
aPtr
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
;
#
ifdef
MOZ_UNIFFI_FIXTURES
Maybe
<
already_AddRefed
<
Promise
>
>
UniFFIFixturesCallAsync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
ScaffoldingType
>
&
aArgs
ErrorResult
&
aError
)
;
bool
UniFFIFixturesCallSync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
ScaffoldingType
>
&
aArgs
RootedDictionary
<
UniFFIScaffoldingCallResult
>
&
aReturnValue
ErrorResult
&
aError
)
;
Maybe
<
already_AddRefed
<
UniFFIPointer
>
>
UniFFIFixturesReadPointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
;
bool
UniFFIFixturesWritePointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
UniFFIPointer
&
aPtr
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
;
#
endif
}
namespace
mozilla
:
:
dom
{
already_AddRefed
<
Promise
>
UniFFIScaffolding
:
:
CallAsync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
ScaffoldingType
>
&
aArgs
ErrorResult
&
aError
)
{
Maybe
<
already_AddRefed
<
Promise
>
>
firstTry
=
uniffi
:
:
UniFFICallAsync
(
aGlobal
aId
aArgs
aError
)
;
if
(
firstTry
.
isSome
(
)
)
{
return
firstTry
.
extract
(
)
;
}
#
ifdef
MOZ_UNIFFI_FIXTURES
Maybe
<
already_AddRefed
<
Promise
>
>
secondTry
=
uniffi
:
:
UniFFIFixturesCallAsync
(
aGlobal
aId
aArgs
aError
)
;
if
(
secondTry
.
isSome
(
)
)
{
return
secondTry
.
extract
(
)
;
}
#
endif
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
function
id
:
%
"
PRIu64
aId
)
)
;
return
nullptr
;
}
void
UniFFIScaffolding
:
:
CallSync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
ScaffoldingType
>
&
aArgs
RootedDictionary
<
UniFFIScaffoldingCallResult
>
&
aReturnValue
ErrorResult
&
aError
)
{
if
(
uniffi
:
:
UniFFICallSync
(
aGlobal
aId
aArgs
aReturnValue
aError
)
)
{
return
;
}
#
ifdef
MOZ_UNIFFI_FIXTURES
if
(
uniffi
:
:
UniFFIFixturesCallSync
(
aGlobal
aId
aArgs
aReturnValue
aError
)
)
{
return
;
}
#
endif
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
function
id
:
%
"
PRIu64
aId
)
)
;
}
already_AddRefed
<
UniFFIPointer
>
UniFFIScaffolding
:
:
ReadPointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
{
Maybe
<
already_AddRefed
<
UniFFIPointer
>
>
firstTry
=
uniffi
:
:
UniFFIReadPointer
(
aGlobal
aId
aArrayBuff
aPosition
aError
)
;
if
(
firstTry
.
isSome
(
)
)
{
return
firstTry
.
extract
(
)
;
}
#
ifdef
MOZ_UNIFFI_FIXTURES
Maybe
<
already_AddRefed
<
UniFFIPointer
>
>
secondTry
=
uniffi
:
:
UniFFIFixturesReadPointer
(
aGlobal
aId
aArrayBuff
aPosition
aError
)
;
if
(
secondTry
.
isSome
(
)
)
{
return
secondTry
.
extract
(
)
;
}
#
endif
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
object
id
:
%
"
PRIu64
aId
)
)
;
return
nullptr
;
}
void
UniFFIScaffolding
:
:
WritePointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
UniFFIPointer
&
aPtr
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
{
if
(
uniffi
:
:
UniFFIWritePointer
(
aGlobal
aId
aPtr
aArrayBuff
aPosition
aError
)
)
{
return
;
}
#
ifdef
MOZ_UNIFFI_FIXTURES
if
(
uniffi
:
:
UniFFIFixturesWritePointer
(
aGlobal
aId
aPtr
aArrayBuff
aPosition
aError
)
)
{
return
;
}
#
endif
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
object
id
:
%
"
PRIu64
aId
)
)
;
}
}
