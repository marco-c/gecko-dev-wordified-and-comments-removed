#
include
<
inttypes
.
h
>
#
include
"
nsError
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
dom
/
Promise
.
h
"
#
include
"
mozilla
/
uniffi
/
Call
.
h
"
#
include
"
mozilla
/
uniffi
/
Callbacks
.
h
"
#
include
"
mozilla
/
dom
/
UniFFIScaffolding
.
h
"
using
mozilla
:
:
dom
:
:
ArrayBuffer
;
using
mozilla
:
:
dom
:
:
GlobalObject
;
using
mozilla
:
:
dom
:
:
OwningUniFFIScaffoldingValue
;
using
mozilla
:
:
dom
:
:
Promise
;
using
mozilla
:
:
dom
:
:
RootedDictionary
;
using
mozilla
:
:
dom
:
:
Sequence
;
using
mozilla
:
:
dom
:
:
UniFFICallbackHandler
;
using
mozilla
:
:
dom
:
:
UniFFIPointer
;
using
mozilla
:
:
dom
:
:
UniFFIScaffoldingCallResult
;
using
mozilla
:
:
uniffi
:
:
UniffiAsyncCallHandler
;
using
mozilla
:
:
uniffi
:
:
UniffiSyncCallHandler
;
namespace
mozilla
:
:
uniffi
{
mozilla
:
:
LazyLogModule
gUniffiLogger
(
"
uniffi
"
)
;
UniquePtr
<
UniffiSyncCallHandler
>
GetSyncCallHandler
(
uint64_t
aId
)
;
UniquePtr
<
UniffiAsyncCallHandler
>
GetAsyncCallHandler
(
uint64_t
aId
)
;
Maybe
<
already_AddRefed
<
UniFFIPointer
>
>
ReadPointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
;
bool
WritePointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
UniFFIPointer
&
aPtr
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
;
}
namespace
mozilla
:
:
dom
{
void
UniFFIScaffolding
:
:
CallSync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
OwningUniFFIScaffoldingValue
>
&
aArgs
RootedDictionary
<
UniFFIScaffoldingCallResult
>
&
aReturnValue
ErrorResult
&
aError
)
{
if
(
UniquePtr
<
UniffiSyncCallHandler
>
handler
=
uniffi
:
:
GetSyncCallHandler
(
aId
)
)
{
return
UniffiSyncCallHandler
:
:
CallSync
(
std
:
:
move
(
handler
)
aGlobal
aArgs
aReturnValue
aError
)
;
}
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
function
id
:
%
"
PRIu64
aId
)
)
;
}
already_AddRefed
<
Promise
>
UniFFIScaffolding
:
:
CallAsync
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
OwningUniFFIScaffoldingValue
>
&
aArgs
ErrorResult
&
aError
)
{
if
(
UniquePtr
<
UniffiAsyncCallHandler
>
handler
=
uniffi
:
:
GetAsyncCallHandler
(
aId
)
)
{
return
UniffiAsyncCallHandler
:
:
CallAsync
(
std
:
:
move
(
handler
)
aGlobal
aArgs
aError
)
;
}
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
function
id
:
%
"
PRIu64
aId
)
)
;
return
nullptr
;
}
already_AddRefed
<
Promise
>
UniFFIScaffolding
:
:
CallAsyncWrapper
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
Sequence
<
OwningUniFFIScaffoldingValue
>
&
aArgs
ErrorResult
&
aError
)
{
if
(
UniquePtr
<
UniffiSyncCallHandler
>
handler
=
uniffi
:
:
GetSyncCallHandler
(
aId
)
)
{
return
UniffiSyncCallHandler
:
:
CallAsyncWrapper
(
std
:
:
move
(
handler
)
aGlobal
aArgs
aError
)
;
}
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
function
id
:
%
"
PRIu64
aId
)
)
;
return
nullptr
;
}
already_AddRefed
<
UniFFIPointer
>
UniFFIScaffolding
:
:
ReadPointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
{
Maybe
<
already_AddRefed
<
UniFFIPointer
>
>
firstTry
=
uniffi
:
:
ReadPointer
(
aGlobal
aId
aArrayBuff
aPosition
aError
)
;
if
(
firstTry
.
isSome
(
)
)
{
return
firstTry
.
extract
(
)
;
}
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
object
id
:
%
"
PRIu64
aId
)
)
;
return
nullptr
;
}
void
UniFFIScaffolding
:
:
WritePointer
(
const
GlobalObject
&
aGlobal
uint64_t
aId
const
UniFFIPointer
&
aPtr
const
ArrayBuffer
&
aArrayBuff
long
aPosition
ErrorResult
&
aError
)
{
if
(
uniffi
:
:
WritePointer
(
aGlobal
aId
aPtr
aArrayBuff
aPosition
aError
)
)
{
return
;
}
aError
.
ThrowUnknownError
(
nsPrintfCString
(
"
Unknown
object
id
:
%
"
PRIu64
aId
)
)
;
}
void
UniFFIScaffolding
:
:
RegisterCallbackHandler
(
GlobalObject
&
aGlobal
uint64_t
aInterfaceId
UniFFICallbackHandler
&
aCallbackHandler
ErrorResult
&
aError
)
{
uniffi
:
:
RegisterCallbackHandler
(
aInterfaceId
aCallbackHandler
aError
)
;
}
void
UniFFIScaffolding
:
:
DeregisterCallbackHandler
(
GlobalObject
&
aGlobal
uint64_t
aInterfaceId
ErrorResult
&
aError
)
{
uniffi
:
:
DeregisterCallbackHandler
(
aInterfaceId
aError
)
;
}
}
