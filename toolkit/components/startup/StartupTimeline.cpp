#
include
"
StartupTimeline
.
h
"
#
include
"
mozilla
/
glean
/
StartupMetrics
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsXULAppAPI
.
h
"
namespace
mozilla
{
TimeStamp
StartupTimeline
:
:
sStartupTimeline
[
StartupTimeline
:
:
MAX_EVENT_ID
]
;
const
char
*
StartupTimeline
:
:
sStartupTimelineDesc
[
StartupTimeline
:
:
MAX_EVENT_ID
]
=
{
#
define
mozilla_StartupTimeline_Event
(
ev
desc
)
desc
#
include
"
StartupTimeline
.
h
"
#
undef
mozilla_StartupTimeline_Event
}
;
}
using
mozilla
:
:
StartupTimeline
;
using
mozilla
:
:
TimeStamp
;
void
XRE_StartupTimelineRecord
(
int
aEvent
TimeStamp
aWhen
)
{
StartupTimeline
:
:
Record
(
(
StartupTimeline
:
:
Event
)
aEvent
aWhen
)
;
}
void
StartupTimeline
:
:
Record
(
Event
ev
TimeStamp
when
)
{
sStartupTimeline
[
ev
]
=
when
;
if
(
!
XRE_IsParentProcess
(
)
)
{
return
;
}
uint32_t
msSinceProcStart
=
(
uint32_t
)
(
when
-
TimeStamp
:
:
ProcessCreation
(
)
)
.
ToMilliseconds
(
)
;
glean
:
:
timestamps
:
:
startup_timeline
.
EnumGet
(
static_cast
<
glean
:
:
timestamps
:
:
StartupTimelineLabel
>
(
ev
)
)
.
Set
(
msSinceProcStart
)
;
glean
:
:
timestamps
:
:
global_startup_timeline
.
EnumGet
(
static_cast
<
glean
:
:
timestamps
:
:
GlobalStartupTimelineLabel
>
(
ev
)
)
.
Set
(
msSinceProcStart
)
;
}
void
StartupTimeline
:
:
RecordOnce
(
Event
ev
)
{
RecordOnce
(
ev
TimeStamp
:
:
Now
(
)
)
;
}
void
StartupTimeline
:
:
RecordOnce
(
Event
ev
const
TimeStamp
&
aWhen
)
{
if
(
HasRecord
(
ev
)
)
{
return
;
}
Record
(
ev
aWhen
)
;
if
(
!
XRE_IsParentProcess
(
)
)
{
return
;
}
if
(
ev
=
=
FIRST_PAINT
|
|
ev
=
=
FIRST_PAINT2
)
{
uint32_t
firstPaintTime
=
(
uint32_t
)
(
aWhen
-
TimeStamp
:
:
ProcessCreation
(
)
)
.
ToMilliseconds
(
)
;
if
(
ev
=
=
FIRST_PAINT
)
{
glean
:
:
timestamps
:
:
first_paint
.
Set
(
firstPaintTime
)
;
}
else
{
glean
:
:
timestamps
:
:
first_paint_two
.
Set
(
firstPaintTime
)
;
}
}
}
