const
{
getSingleton
getJsRefcount
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
RustRefcounts
.
sys
.
mjs
"
)
;
function
createObjectAndCallMethods
(
)
{
const
obj
=
getSingleton
(
)
;
obj
.
method
(
)
;
}
add_test
(
(
)
=
>
{
const
obj
=
getSingleton
(
)
;
createObjectAndCallMethods
(
)
;
Cu
.
forceGC
(
)
;
Cu
.
forceCC
(
)
;
do_test_pending
(
)
;
do_timeout
(
500
(
)
=
>
{
Assert
.
equal
(
getJsRefcount
(
)
1
)
;
obj
.
method
(
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
function
createAndDeleteObjects
(
)
{
[
getSingleton
(
)
getSingleton
(
)
getSingleton
(
)
]
;
}
add_test
(
(
)
=
>
{
const
obj
=
getSingleton
(
)
;
createAndDeleteObjects
(
)
;
Cu
.
forceGC
(
)
;
Cu
.
forceCC
(
)
;
do_timeout
(
500
(
)
=
>
{
Assert
.
equal
(
getJsRefcount
(
)
1
)
;
obj
.
method
(
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
