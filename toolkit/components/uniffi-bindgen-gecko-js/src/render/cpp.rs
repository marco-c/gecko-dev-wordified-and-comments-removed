use
crate
:
:
{
CallbackIds
Config
FunctionIds
ObjectIds
}
;
use
askama
:
:
Template
;
use
extend
:
:
ext
;
use
heck
:
:
{
ToShoutySnakeCase
ToUpperCamelCase
}
;
use
std
:
:
collections
:
:
HashSet
;
use
std
:
:
iter
;
use
uniffi_bindgen
:
:
interface
:
:
{
CallbackInterface
ComponentInterface
FfiArgument
FfiFunction
FfiType
Object
}
;
#
[
derive
(
Template
)
]
#
[
template
(
path
=
"
UniFFIScaffolding
.
cpp
"
escape
=
"
none
"
)
]
pub
struct
CPPScaffoldingTemplate
<
'
a
>
{
pub
prefix
:
&
'
a
str
pub
components
:
&
'
a
Vec
<
(
ComponentInterface
Config
)
>
pub
function_ids
:
&
'
a
FunctionIds
<
'
a
>
pub
object_ids
:
&
'
a
ObjectIds
<
'
a
>
pub
callback_ids
:
&
'
a
CallbackIds
<
'
a
>
}
impl
<
'
a
>
CPPScaffoldingTemplate
<
'
a
>
{
fn
has_any_objects
(
&
self
)
-
>
bool
{
self
.
components
.
iter
(
)
.
any
(
|
(
ci
_
)
|
ci
.
object_definitions
(
)
.
len
(
)
>
0
)
}
}
#
[
ext
(
name
=
ComponentInterfaceCppExt
)
]
pub
impl
ComponentInterface
{
fn
pointer_type
(
&
self
object
:
&
Object
)
-
>
String
{
self
.
_pointer_type
(
object
.
name
(
)
)
}
fn
_pointer_type
(
&
self
name
:
&
str
)
-
>
String
{
format
!
(
"
k
{
}
{
}
PointerType
"
self
.
namespace
(
)
.
to_upper_camel_case
(
)
name
.
to_upper_camel_case
(
)
)
}
fn
exposed_functions
(
&
self
)
-
>
Vec
<
&
FfiFunction
>
{
let
excluded
:
HashSet
<
_
>
=
self
.
object_definitions
(
)
.
iter
(
)
.
map
(
|
o
|
o
.
ffi_object_free
(
)
.
name
(
)
)
.
chain
(
self
.
callback_interface_definitions
(
)
.
iter
(
)
.
map
(
|
cbi
|
cbi
.
ffi_init_callback
(
)
.
name
(
)
)
)
.
collect
(
)
;
self
.
iter_user_ffi_function_definitions
(
)
.
filter
(
move
|
f
|
!
excluded
.
contains
(
f
.
name
(
)
)
)
.
collect
(
)
}
fn
scaffolding_converter
(
&
self
ffi_type
:
&
FfiType
)
-
>
String
{
match
ffi_type
{
FfiType
:
:
RustArcPtr
(
name
)
=
>
{
format
!
(
"
ScaffoldingObjectConverter
<
&
{
}
>
"
self
.
_pointer_type
(
name
)
)
}
_
=
>
format
!
(
"
ScaffoldingConverter
<
{
}
>
"
ffi_type
.
rust_type
(
)
)
}
}
fn
scaffolding_call_handler
(
&
self
func
:
&
FfiFunction
)
-
>
String
{
let
return_param
=
match
func
.
return_type
(
)
{
Some
(
return_type
)
=
>
self
.
scaffolding_converter
(
return_type
)
None
=
>
"
ScaffoldingConverter
<
void
>
"
.
to_string
(
)
}
;
let
all_params
=
iter
:
:
once
(
return_param
)
.
chain
(
func
.
arguments
(
)
.
into_iter
(
)
.
map
(
|
a
|
self
.
scaffolding_converter
(
&
a
.
type_
(
)
)
)
)
.
collect
:
:
<
Vec
<
_
>
>
(
)
.
join
(
"
"
)
;
return
format
!
(
"
ScaffoldingCallHandler
<
{
}
>
"
all_params
)
;
}
}
#
[
ext
(
name
=
FFIFunctionCppExt
)
]
pub
impl
FfiFunction
{
fn
nm
(
&
self
)
-
>
String
{
self
.
name
(
)
.
to_upper_camel_case
(
)
}
fn
rust_name
(
&
self
)
-
>
String
{
self
.
name
(
)
.
to_string
(
)
}
fn
rust_return_type
(
&
self
)
-
>
String
{
match
self
.
return_type
(
)
{
Some
(
t
)
=
>
t
.
rust_type
(
)
None
=
>
"
void
"
.
to_owned
(
)
}
}
fn
rust_arg_list
(
&
self
)
-
>
String
{
let
mut
parts
:
Vec
<
String
>
=
self
.
arguments
(
)
.
iter
(
)
.
map
(
|
a
|
a
.
rust_type
(
)
)
.
collect
(
)
;
parts
.
push
(
"
RustCallStatus
*
"
.
to_owned
(
)
)
;
parts
.
join
(
"
"
)
}
}
#
[
ext
(
name
=
FFITypeCppExt
)
]
pub
impl
FfiType
{
fn
rust_type
(
&
self
)
-
>
String
{
match
self
{
FfiType
:
:
UInt8
=
>
"
uint8_t
"
FfiType
:
:
Int8
=
>
"
int8_t
"
FfiType
:
:
UInt16
=
>
"
uint16_t
"
FfiType
:
:
Int16
=
>
"
int16_t
"
FfiType
:
:
UInt32
=
>
"
uint32_t
"
FfiType
:
:
Int32
=
>
"
int32_t
"
FfiType
:
:
UInt64
=
>
"
uint64_t
"
FfiType
:
:
Int64
=
>
"
int64_t
"
FfiType
:
:
Float32
=
>
"
float
"
FfiType
:
:
Float64
=
>
"
double
"
FfiType
:
:
RustBuffer
(
_
)
=
>
"
RustBuffer
"
FfiType
:
:
RustArcPtr
(
_
)
=
>
"
void
*
"
FfiType
:
:
ForeignCallback
=
>
"
ForeignCallback
"
FfiType
:
:
ForeignBytes
=
>
unimplemented
!
(
"
ForeignBytes
not
supported
"
)
}
.
to_owned
(
)
}
}
#
[
ext
(
name
=
FFIArgumentCppExt
)
]
pub
impl
FfiArgument
{
fn
rust_type
(
&
self
)
-
>
String
{
self
.
type_
(
)
.
rust_type
(
)
}
}
#
[
ext
(
name
=
ObjectCppExt
)
]
pub
impl
Object
{
fn
nm
(
&
self
)
-
>
String
{
self
.
name
(
)
.
to_upper_camel_case
(
)
}
}
#
[
ext
(
name
=
CallbackInterfaceCppExt
)
]
pub
impl
CallbackInterface
{
fn
nm
(
&
self
)
-
>
String
{
self
.
name
(
)
.
to_upper_camel_case
(
)
}
fn
js_handler
(
&
self
)
-
>
String
{
format
!
(
"
JS_CALLBACK_HANDLER_
{
}
"
self
.
name
(
)
.
to_shouty_snake_case
(
)
)
}
fn
c_handler
(
&
self
prefix
:
&
str
)
-
>
String
{
format
!
(
"
{
prefix
}
CallbackHandler
{
}
"
self
.
name
(
)
.
to_upper_camel_case
(
)
)
}
}
