const
{
invokeTestCallbackInterfaceNoop
invokeTestCallbackInterfaceSetValue
TestCallbackInterface
UniffiSkipJsTypeCheck
UnitTestObjs
}
=
ChromeUtils
.
importESModule
(
"
moz
-
src
:
/
/
/
toolkit
/
components
/
uniffi
-
bindgen
-
gecko
-
js
/
tests
/
generated
/
RustUniffiBindingsTests
.
sys
.
mjs
"
)
;
class
Callback
extends
TestCallbackInterface
{
constructor
(
value
)
{
super
(
)
;
this
.
value
=
value
;
}
noop
(
)
{
}
getValue
(
)
{
return
this
.
value
;
}
setValue
(
value
)
{
this
.
value
=
value
;
}
}
add_task
(
async
(
)
=
>
{
const
cbi
=
new
Callback
(
42
)
;
invokeTestCallbackInterfaceNoop
(
cbi
)
;
do_test_pending
(
)
;
do_timeout
(
100
do_test_finished
)
;
}
)
;
add_task
(
async
(
)
=
>
{
const
cbi
=
new
Callback
(
42
)
;
invokeTestCallbackInterfaceSetValue
(
cbi
43
)
;
do_test_pending
(
)
;
do_timeout
(
100
async
(
)
=
>
{
Assert
.
equal
(
await
cbi
.
getValue
(
)
43
)
;
do_test_finished
(
)
;
}
)
;
}
)
;
add_task
(
async
function
testCleanupAfterFailedLower
(
)
{
const
cbi
=
new
Callback
(
42
)
;
Assert
.
equal
(
UnitTestObjs
.
uniffiCallbackHandlerUniffiBindingsTestsTestCallbackInterface
.
hasRegisteredCallbacks
(
)
false
)
;
const
invalidU32Value
=
2
*
*
48
;
invokeTestCallbackInterfaceSetValue
(
cbi
invalidU32Value
)
.
catch
(
(
)
=
>
null
)
;
Assert
.
equal
(
UnitTestObjs
.
uniffiCallbackHandlerUniffiBindingsTestsTestCallbackInterface
.
hasRegisteredCallbacks
(
)
false
)
;
}
)
;
add_task
(
async
function
testCleanupAfterFailedCppLower
(
)
{
const
cbi
=
new
Callback
(
42
)
;
Assert
.
equal
(
UnitTestObjs
.
uniffiCallbackHandlerUniffiBindingsTestsTestCallbackInterface
.
hasRegisteredCallbacks
(
)
false
)
;
const
invalidU32Value
=
2
*
*
48
;
invokeTestCallbackInterfaceSetValue
(
cbi
new
UniffiSkipJsTypeCheck
(
invalidU32Value
)
)
.
catch
(
(
)
=
>
null
)
;
do_test_pending
(
)
;
do_timeout
(
100
(
)
=
>
{
Assert
.
equal
(
UnitTestObjs
.
uniffiCallbackHandlerUniffiBindingsTestsTestCallbackInterface
.
hasRegisteredCallbacks
(
)
false
)
;
do_test_finished
(
)
;
}
)
;
}
)
;
