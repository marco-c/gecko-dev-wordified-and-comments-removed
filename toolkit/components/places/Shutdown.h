#
ifndef
mozilla_places_Shutdown_h_
#
define
mozilla_places_Shutdown_h_
#
include
"
nsIAsyncShutdown
.
h
"
#
include
"
Database
.
h
"
#
include
"
nsProxyRelease
.
h
"
namespace
mozilla
{
namespace
places
{
class
Database
;
class
PlacesShutdownBlocker
:
public
nsIAsyncShutdownBlocker
{
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIASYNCSHUTDOWNBLOCKER
explicit
PlacesShutdownBlocker
(
const
nsString
&
aName
)
;
static
bool
IsStarted
(
)
{
return
sIsStarted
;
}
enum
States
{
NOT_STARTED
RECEIVED_BLOCK_SHUTDOWN
CALLED_WAIT_CLIENTS
RECEIVED_DONE
NOTIFIED_OBSERVERS_PLACES_WILL_CLOSE_CONNECTION
CALLED_STORAGESHUTDOWN
RECEIVED_STORAGESHUTDOWN_COMPLETE
NOTIFIED_OBSERVERS_PLACES_CONNECTION_CLOSED
}
;
States
State
(
)
{
return
mState
;
}
protected
:
nsString
mName
;
States
mState
;
nsMainThreadPtrHandle
<
nsIAsyncShutdownBarrier
>
mBarrier
;
nsMainThreadPtrHandle
<
nsIAsyncShutdownClient
>
mParentClient
;
uint16_t
mCounter
;
static
uint16_t
sCounter
;
static
Atomic
<
bool
>
sIsStarted
;
virtual
~
PlacesShutdownBlocker
(
)
{
}
}
;
class
ClientsShutdownBlocker
final
:
public
PlacesShutdownBlocker
public
nsIAsyncShutdownCompletionCallback
{
public
:
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_NSIASYNCSHUTDOWNCOMPLETIONCALLBACK
explicit
ClientsShutdownBlocker
(
)
;
NS_IMETHOD
BlockShutdown
(
nsIAsyncShutdownClient
*
aParentClient
)
override
;
already_AddRefed
<
nsIAsyncShutdownClient
>
GetClient
(
)
;
private
:
~
ClientsShutdownBlocker
(
)
{
}
}
;
class
ConnectionShutdownBlocker
final
:
public
PlacesShutdownBlocker
public
mozIStorageCompletionCallback
{
public
:
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_MOZISTORAGECOMPLETIONCALLBACK
NS_IMETHOD
BlockShutdown
(
nsIAsyncShutdownClient
*
aParentClient
)
override
;
explicit
ConnectionShutdownBlocker
(
mozilla
:
:
places
:
:
Database
*
aDatabase
)
;
private
:
~
ConnectionShutdownBlocker
(
)
{
}
RefPtr
<
mozilla
:
:
places
:
:
Database
>
mDatabase
;
}
;
}
}
#
endif
