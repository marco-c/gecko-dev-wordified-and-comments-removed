#
ifndef
nsFaviconService_h_
#
define
nsFaviconService_h_
#
include
<
utility
>
#
include
"
Database
.
h
"
#
include
"
FaviconHelpers
.
h
"
#
include
"
imgITools
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
storage
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsIFaviconService
.
h
"
#
include
"
nsINamed
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
nsToolkitCompsCID
.
h
"
#
include
"
nsURIHashKey
.
h
"
extern
const
uint16_t
gFaviconSizes
[
7
]
;
class
mozIStorageStatementCallback
;
class
UnassociatedIconHashKey
:
public
nsURIHashKey
{
public
:
explicit
UnassociatedIconHashKey
(
const
nsIURI
*
aURI
)
:
nsURIHashKey
(
aURI
)
{
}
UnassociatedIconHashKey
(
UnassociatedIconHashKey
&
&
aOther
)
:
nsURIHashKey
(
std
:
:
move
(
aOther
)
)
iconData
(
std
:
:
move
(
aOther
.
iconData
)
)
created
(
std
:
:
move
(
aOther
.
created
)
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Do
not
call
me
!
"
)
;
}
mozilla
:
:
places
:
:
IconData
iconData
;
PRTime
created
;
}
;
class
nsFaviconService
final
:
public
nsIFaviconService
public
nsITimerCallback
public
nsINamed
{
public
:
nsFaviconService
(
)
;
static
already_AddRefed
<
nsFaviconService
>
GetSingleton
(
)
;
nsresult
Init
(
)
;
static
nsFaviconService
*
GetFaviconService
(
)
{
if
(
!
gFaviconService
)
{
nsCOMPtr
<
nsIFaviconService
>
serv
=
do_GetService
(
NS_FAVICONSERVICE_CONTRACTID
)
;
NS_ENSURE_TRUE
(
serv
nullptr
)
;
NS_ASSERTION
(
gFaviconService
"
Should
have
static
instance
pointer
now
"
)
;
}
return
gFaviconService
;
}
nsresult
GetFaviconLinkForIconString
(
const
nsCString
&
aIcon
nsIURI
*
*
aOutput
)
;
nsresult
OptimizeIconSizes
(
mozilla
:
:
places
:
:
IconData
&
aIcon
)
;
nsresult
GetFaviconDataAsync
(
const
nsCString
&
aFaviconSpec
mozIStorageStatementCallback
*
aCallback
)
;
void
SendFaviconNotifications
(
nsIURI
*
aPageURI
nsIURI
*
aFaviconURI
const
nsACString
&
aGUID
)
;
static
mozilla
:
:
Atomic
<
int64_t
>
sLastInsertedIconId
;
static
void
StoreLastInsertedId
(
const
nsACString
&
aTable
const
int64_t
aLastInsertedId
)
;
NS_DECL_ISUPPORTS
NS_DECL_NSIFAVICONSERVICE
NS_DECL_NSITIMERCALLBACK
NS_DECL_NSINAMED
private
:
imgITools
*
GetImgTools
(
)
{
if
(
!
mImgTools
)
{
mImgTools
=
do_CreateInstance
(
"
mozilla
.
org
/
image
/
tools
;
1
"
)
;
}
return
mImgTools
;
}
~
nsFaviconService
(
)
;
RefPtr
<
mozilla
:
:
places
:
:
Database
>
mDB
;
nsCOMPtr
<
nsITimer
>
mExpireUnassociatedIconsTimer
;
nsCOMPtr
<
imgITools
>
mImgTools
;
static
nsFaviconService
*
gFaviconService
;
nsCOMPtr
<
nsIURI
>
mDefaultIcon
;
friend
class
mozilla
:
:
places
:
:
AsyncReplaceFaviconData
;
nsTHashtable
<
UnassociatedIconHashKey
>
mUnassociatedIcons
;
uint16_t
mDefaultIconURIPreferredSize
;
}
;
#
define
FAVICON_ANNOTATION_NAME
"
favicon
"
#
endif
