#
ifndef
mozilla_places_Database_h_
#
define
mozilla_places_Database_h_
#
include
"
MainThreadUtils
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsIAsyncShutdown
.
h
"
#
include
"
mozilla
/
storage
.
h
"
#
include
"
mozilla
/
storage
/
StatementCache
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsIEventTarget
.
h
"
#
include
"
Shutdown
.
h
"
#
include
"
nsCategoryCache
.
h
"
#
define
DATABASE_SCHEMA_VERSION
52
#
define
TOPIC_PLACES_INIT_COMPLETE
"
places
-
init
-
complete
"
#
define
TOPIC_PROFILE_CHANGE_TEARDOWN
"
profile
-
change
-
teardown
"
#
define
TOPIC_PLACES_SHUTDOWN
"
places
-
shutdown
"
#
define
TOPIC_PLACES_CONNECTION_CLOSED
"
places
-
connection
-
closed
"
#
define
TOPIC_SIMULATE_PLACES_SHUTDOWN
"
test
-
simulate
-
places
-
shutdown
"
class
nsIRunnable
;
namespace
mozilla
{
namespace
places
{
enum
JournalMode
{
JOURNAL_DELETE
=
0
JOURNAL_TRUNCATE
JOURNAL_MEMORY
JOURNAL_WAL
}
;
class
ClientsShutdownBlocker
;
class
ConnectionShutdownBlocker
;
class
Database
final
:
public
nsIObserver
public
nsSupportsWeakReference
{
typedef
mozilla
:
:
storage
:
:
StatementCache
<
mozIStorageStatement
>
StatementCache
;
typedef
mozilla
:
:
storage
:
:
StatementCache
<
mozIStorageAsyncStatement
>
AsyncStatementCache
;
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIOBSERVER
Database
(
)
;
nsresult
Init
(
)
;
already_AddRefed
<
nsIAsyncShutdownClient
>
GetClientsShutdown
(
)
;
already_AddRefed
<
nsIAsyncShutdownClient
>
GetConnectionShutdown
(
)
;
static
already_AddRefed
<
Database
>
GetDatabase
(
)
;
nsresult
EnsureConnection
(
)
;
nsresult
NotifyConnectionInitalized
(
)
;
uint16_t
GetDatabaseStatus
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mDatabaseStatus
;
}
mozIStorageConnection
*
MainConn
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mMainConn
;
}
void
DispatchToAsyncThread
(
nsIRunnable
*
aEvent
)
{
if
(
mClosed
|
|
NS_FAILED
(
EnsureConnection
(
)
)
)
{
return
;
}
nsCOMPtr
<
nsIEventTarget
>
target
=
do_GetInterface
(
mMainConn
)
;
if
(
target
)
{
(
void
)
target
-
>
Dispatch
(
aEvent
NS_DISPATCH_NORMAL
)
;
}
}
template
<
int
N
>
already_AddRefed
<
mozIStorageStatement
>
GetStatement
(
const
char
(
&
aQuery
)
[
N
]
)
{
nsDependentCString
query
(
aQuery
N
-
1
)
;
return
GetStatement
(
query
)
;
}
already_AddRefed
<
mozIStorageStatement
>
GetStatement
(
const
nsACString
&
aQuery
)
;
template
<
int
N
>
already_AddRefed
<
mozIStorageAsyncStatement
>
GetAsyncStatement
(
const
char
(
&
aQuery
)
[
N
]
)
{
nsDependentCString
query
(
aQuery
N
-
1
)
;
return
GetAsyncStatement
(
query
)
;
}
already_AddRefed
<
mozIStorageAsyncStatement
>
GetAsyncStatement
(
const
nsACString
&
aQuery
)
;
uint32_t
MaxUrlLength
(
)
;
int64_t
GetRootFolderId
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mRootId
;
}
int64_t
GetMenuFolderId
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mMenuRootId
;
}
int64_t
GetTagsFolderId
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mTagsRootId
;
}
int64_t
GetUnfiledFolderId
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mUnfiledRootId
;
}
int64_t
GetToolbarFolderId
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mToolbarRootId
;
}
int64_t
GetMobileFolderId
(
)
{
mozilla
:
:
Unused
<
<
EnsureConnection
(
)
;
return
mMobileRootId
;
}
protected
:
void
Shutdown
(
)
;
bool
IsShutdownStarted
(
)
const
;
nsresult
EnsureFaviconsDatabaseAttached
(
const
nsCOMPtr
<
mozIStorageService
>
&
aStorage
)
;
nsresult
BackupAndReplaceDatabaseFile
(
nsCOMPtr
<
mozIStorageService
>
&
aStorage
const
nsString
&
aDbFilename
bool
aTryToClone
bool
aReopenConnection
)
;
nsresult
TryToCloneTablesFromCorruptDatabase
(
const
nsCOMPtr
<
mozIStorageService
>
&
aStorage
const
nsCOMPtr
<
nsIFile
>
&
aDatabaseFile
)
;
nsresult
SetupDatabaseConnection
(
nsCOMPtr
<
mozIStorageService
>
&
aStorage
)
;
nsresult
InitSchema
(
bool
*
aDatabaseMigrated
)
;
nsresult
CheckRoots
(
)
;
nsresult
EnsureBookmarkRoots
(
const
int32_t
startPosition
)
;
nsresult
InitFunctions
(
)
;
nsresult
InitTempEntities
(
)
;
nsresult
MigrateV31Up
(
)
;
nsresult
MigrateV32Up
(
)
;
nsresult
MigrateV33Up
(
)
;
nsresult
MigrateV34Up
(
)
;
nsresult
MigrateV35Up
(
)
;
nsresult
MigrateV36Up
(
)
;
nsresult
MigrateV37Up
(
)
;
nsresult
MigrateV38Up
(
)
;
nsresult
MigrateV39Up
(
)
;
nsresult
MigrateV40Up
(
)
;
nsresult
MigrateV41Up
(
)
;
nsresult
MigrateV42Up
(
)
;
nsresult
MigrateV43Up
(
)
;
nsresult
MigrateV44Up
(
)
;
nsresult
MigrateV45Up
(
)
;
nsresult
MigrateV46Up
(
)
;
nsresult
MigrateV47Up
(
)
;
nsresult
MigrateV48Up
(
)
;
nsresult
MigrateV49Up
(
)
;
nsresult
MigrateV50Up
(
)
;
nsresult
MigrateV51Up
(
)
;
nsresult
MigrateV52Up
(
)
;
void
MigrateV52OriginFrecencies
(
)
;
nsresult
UpdateBookmarkRootTitles
(
)
;
friend
class
ConnectionShutdownBlocker
;
int64_t
CreateMobileRoot
(
)
;
nsresult
ConvertOldStyleQuery
(
nsCString
&
aURL
)
;
nsresult
GetItemsWithAnno
(
const
nsACString
&
aAnnoName
int32_t
aItemType
nsTArray
<
int64_t
>
&
aItemIds
)
;
nsresult
DeleteBookmarkItem
(
int32_t
aItemId
)
;
private
:
~
Database
(
)
;
static
already_AddRefed
<
Database
>
GetSingleton
(
)
;
static
Database
*
gDatabase
;
nsCOMPtr
<
mozIStorageConnection
>
mMainConn
;
mutable
StatementCache
mMainThreadStatements
;
mutable
AsyncStatementCache
mMainThreadAsyncStatements
;
mutable
StatementCache
mAsyncThreadStatements
;
int32_t
mDBPageSize
;
uint16_t
mDatabaseStatus
;
bool
mClosed
;
bool
mShouldConvertIconPayloads
;
bool
mShouldVacuumIcons
;
already_AddRefed
<
nsIAsyncShutdownClient
>
GetProfileChangeTeardownPhase
(
)
;
already_AddRefed
<
nsIAsyncShutdownClient
>
GetProfileBeforeChangePhase
(
)
;
RefPtr
<
ClientsShutdownBlocker
>
mClientsShutdown
;
RefPtr
<
ConnectionShutdownBlocker
>
mConnectionShutdown
;
uint32_t
mMaxUrlLength
;
nsCategoryCache
<
nsIObserver
>
mCacheObservers
;
int64_t
mRootId
;
int64_t
mMenuRootId
;
int64_t
mTagsRootId
;
int64_t
mUnfiledRootId
;
int64_t
mToolbarRootId
;
int64_t
mMobileRootId
;
}
;
}
}
#
endif
