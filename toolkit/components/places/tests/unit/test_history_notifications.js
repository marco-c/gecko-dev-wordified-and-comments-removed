const
NS_PLACES_INIT_COMPLETE_TOPIC
=
"
places
-
init
-
complete
"
;
const
NS_PLACES_DATABASE_LOCKED_TOPIC
=
"
places
-
database
-
locked
"
;
add_task
(
function
*
(
)
{
let
db
=
Services
.
dirsvc
.
get
(
'
ProfD
'
Ci
.
nsIFile
)
;
db
.
append
(
"
places
.
sqlite
"
)
;
let
dbConn
=
Services
.
storage
.
openUnsharedDatabase
(
db
)
;
Assert
.
ok
(
db
.
exists
(
)
"
The
database
should
have
been
created
"
)
;
dbConn
.
executeSimpleSQL
(
"
PRAGMA
locking_mode
=
EXCLUSIVE
"
)
;
dbConn
.
executeSimpleSQL
(
"
PRAGMA
USER_VERSION
=
1
"
)
;
let
promiseLocked
=
promiseTopicObserved
(
NS_PLACES_DATABASE_LOCKED_TOPIC
)
;
Assert
.
throws
(
(
)
=
>
Cc
[
"
mozilla
.
org
/
browser
/
nav
-
history
-
service
;
1
"
]
.
getService
(
Ci
.
nsINavHistoryService
)
/
NS_ERROR_XPC_GS_RETURNED_FAILURE
/
)
;
yield
promiseLocked
;
dbConn
.
close
(
)
;
if
(
db
.
exists
(
)
)
{
try
{
db
.
remove
(
false
)
;
}
catch
(
e
)
{
do_print
(
"
Unable
to
remove
dummy
places
.
sqlite
"
)
;
}
}
let
promiseComplete
=
promiseTopicObserved
(
NS_PLACES_INIT_COMPLETE_TOPIC
)
;
Cc
[
"
mozilla
.
org
/
browser
/
nav
-
history
-
service
;
1
"
]
.
getService
(
Ci
.
nsINavHistoryService
)
;
yield
promiseComplete
;
}
)
;
