add_task
(
async
function
test_execute
(
)
{
try
{
var
histsvc
=
Cc
[
"
mozilla
.
org
/
browser
/
nav
-
history
-
service
;
1
"
]
.
getService
(
Ci
.
nsINavHistoryService
)
;
}
catch
(
ex
)
{
do_throw
(
"
Unable
to
initialize
Places
services
"
)
;
}
var
testURI
=
uri
(
"
http
:
/
/
test
"
)
;
await
PlacesTestUtils
.
addVisits
(
testURI
)
;
var
options
=
histsvc
.
getNewQueryOptions
(
)
;
options
.
maxResults
=
1
;
options
.
resultType
=
options
.
RESULTS_AS_URI
;
var
query
=
histsvc
.
getNewQuery
(
)
;
query
.
uri
=
testURI
;
var
result
=
histsvc
.
executeQuery
(
query
options
)
;
var
root
=
result
.
root
;
Assert
.
equal
(
root
.
hasChildren
true
)
;
var
queryURI
=
histsvc
.
queryToQueryString
(
query
options
)
;
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
title
:
"
test
query
"
url
:
queryURI
}
)
;
options
=
histsvc
.
getNewQueryOptions
(
)
;
query
=
histsvc
.
getNewQuery
(
)
;
query
.
setParents
(
[
PlacesUtils
.
bookmarks
.
toolbarGuid
]
1
)
;
result
=
histsvc
.
executeQuery
(
query
options
)
;
root
=
result
.
root
;
root
.
containerOpen
=
true
;
var
queryNode
=
root
.
getChild
(
0
)
;
Assert
.
equal
(
queryNode
.
title
"
test
query
"
)
;
queryNode
.
QueryInterface
(
Ci
.
nsINavHistoryContainerResultNode
)
;
Assert
.
equal
(
queryNode
.
hasChildren
true
)
;
root
.
containerOpen
=
false
;
}
)
;
