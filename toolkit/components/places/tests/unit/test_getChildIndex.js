add_task
(
async
function
test_get_child_index
(
)
{
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
menuGuid
url
:
"
http
:
/
/
test
.
mozilla
.
org
/
bookmark
/
"
title
:
"
Test
bookmark
"
}
)
;
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
url
:
"
http
:
/
/
test
.
mozilla
.
org
/
unfiled
/
"
title
:
"
Unfiled
bookmark
"
}
)
;
let
unfiledNode
=
getNodeAt
(
PlacesUtils
.
unfiledBookmarksFolderId
0
)
;
if
(
!
unfiledNode
)
do_throw
(
"
Unable
to
find
bookmark
in
hierarchy
!
"
)
;
do_check_eq
(
unfiledNode
.
title
"
Unfiled
bookmark
"
)
;
let
hs
=
PlacesUtils
.
history
;
let
query
=
hs
.
getNewQuery
(
)
;
query
.
setFolders
(
[
PlacesUtils
.
bookmarksMenuFolderId
]
1
)
;
let
options
=
hs
.
getNewQueryOptions
(
)
;
options
.
queryType
=
options
.
QUERY_TYPE_BOOKMARKS
;
let
root
=
hs
.
executeQuery
(
query
options
)
.
root
;
root
.
containerOpen
=
true
;
for
(
let
i
=
0
;
i
<
root
.
childCount
;
i
+
+
)
{
let
node
=
root
.
getChild
(
i
)
;
print
(
"
Now
testing
:
"
+
node
.
title
)
;
do_check_eq
(
root
.
getChildIndex
(
node
)
i
)
;
}
try
{
root
.
getChildIndex
(
unfiledNode
)
;
do_throw
(
"
Searching
for
an
invalid
node
should
have
thrown
.
"
)
;
}
catch
(
ex
)
{
print
(
"
We
correctly
got
an
exception
.
"
)
;
}
root
.
containerOpen
=
false
;
}
)
;
function
getNodeAt
(
aFolderId
aIndex
)
{
let
hs
=
PlacesUtils
.
history
;
let
query
=
hs
.
getNewQuery
(
)
;
query
.
setFolders
(
[
aFolderId
]
1
)
;
let
options
=
hs
.
getNewQueryOptions
(
)
;
options
.
queryType
=
options
.
QUERY_TYPE_BOOKMARKS
;
let
root
=
hs
.
executeQuery
(
query
options
)
.
root
;
root
.
containerOpen
=
true
;
if
(
root
.
childCount
<
aIndex
)
do_throw
(
"
Not
enough
children
to
find
bookmark
!
"
)
;
let
node
=
root
.
getChild
(
aIndex
)
;
root
.
containerOpen
=
false
;
return
node
;
}
