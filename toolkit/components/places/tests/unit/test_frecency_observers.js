add_task
(
async
function
test_InsertVisitedURIs_UpdateFrecency_and_History_InsertPlace
(
)
{
let
url
=
Services
.
io
.
newURI
(
"
http
:
/
/
example
.
com
/
a
"
)
;
let
promise
=
onRankingChanged
(
)
;
await
PlacesUtils
.
history
.
insert
(
{
url
visits
:
[
{
transition
:
PlacesUtils
.
history
.
TRANSITIONS
.
DOWNLOAD
}
]
}
)
;
await
promise
;
}
)
;
add_task
(
async
function
test_nsNavHistory_UpdateFrecency
(
)
{
let
url
=
Services
.
io
.
newURI
(
"
http
:
/
/
example
.
com
/
b
"
)
;
let
promise
=
onRankingChanged
(
)
;
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
url
title
:
"
test
"
}
)
;
await
promise
;
}
)
;
add_task
(
async
function
test_invalidateFrecencies
(
)
{
let
url
=
Services
.
io
.
newURI
(
"
http
:
/
/
test
-
invalidateFrecencies
.
com
/
"
)
;
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
url
title
:
"
test
"
}
)
;
let
promise
=
onRankingChanged
(
)
;
await
PlacesUtils
.
history
.
removeByFilter
(
{
host
:
url
.
host
}
)
;
await
promise
;
}
)
;
add_task
(
async
function
test_clear
(
)
{
await
Promise
.
all
(
[
onRankingChanged
(
)
PlacesUtils
.
history
.
clear
(
)
]
)
;
}
)
;
add_task
(
async
function
test_nsNavHistory_decayFrecency
(
)
{
let
svc
=
Cc
[
"
mozilla
.
org
/
places
/
frecency
-
recalculator
;
1
"
]
.
getService
(
Ci
.
nsIObserver
)
;
svc
.
observe
(
null
"
idle
-
daily
"
"
"
)
;
await
Promise
.
all
(
[
onRankingChanged
(
)
]
)
;
}
)
;
add_task
(
async
function
test_nsNavHistory_decayFrecency
(
)
{
let
svc
=
Cc
[
"
mozilla
.
org
/
places
/
frecency
-
recalculator
;
1
"
]
.
getService
(
Ci
.
nsIObserver
)
;
await
Promise
.
all
(
[
onRankingChanged
(
)
svc
.
wrappedJSObject
.
recalculateAnyOutdatedFrecencies
(
)
]
)
;
}
)
;
function
onRankingChanged
(
)
{
return
PlacesTestUtils
.
waitForNotification
(
"
pages
-
rank
-
changed
"
(
)
=
>
true
"
places
"
)
;
}
