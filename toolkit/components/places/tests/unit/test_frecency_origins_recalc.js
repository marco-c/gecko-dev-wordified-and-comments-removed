add_task
(
async
function
test
(
)
{
const
now
=
new
Date
(
)
;
const
url
=
"
https
:
/
/
mozilla
.
org
/
test
/
"
;
await
PlacesTestUtils
.
addVisits
(
[
{
url
visitDate
:
now
}
{
url
visitDate
:
new
Date
(
new
Date
(
)
.
setDate
(
now
.
getDate
(
)
-
30
)
)
}
]
)
;
let
db
=
await
PlacesUtils
.
promiseDBConnection
(
)
;
Assert
.
equal
(
(
await
db
.
execute
(
SELECT
recalc_frecency
FROM
moz_origins
)
)
[
0
]
.
getResultByIndex
(
0
)
0
"
Should
have
been
calculated
already
"
)
;
Assert
.
equal
(
(
await
db
.
execute
(
SELECT
recalc_alt_frecency
FROM
moz_origins
)
)
[
0
]
.
getResultByIndex
(
0
)
1
"
Should
not
have
been
calculated
"
)
;
await
PlacesUtils
.
history
.
removeVisitsByFilter
(
{
beginDate
:
new
Date
(
now
.
valueOf
(
)
-
10000
)
endDate
:
new
Date
(
now
.
valueOf
(
)
+
10000
)
}
)
;
Assert
.
equal
(
(
await
db
.
execute
(
SELECT
recalc_frecency
FROM
moz_origins
)
)
[
0
]
.
getResultByIndex
(
0
)
0
"
Should
have
been
calculated
already
"
)
;
Assert
.
equal
(
(
await
db
.
execute
(
SELECT
recalc_alt_frecency
FROM
moz_origins
)
)
[
0
]
.
getResultByIndex
(
0
)
1
"
Should
not
have
been
calculated
yet
"
)
;
}
)
;
