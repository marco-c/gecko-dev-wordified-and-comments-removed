const
kUniqueURI
=
Services
.
io
.
newURI
(
"
http
:
/
/
mochi
.
test
:
8888
/
#
bug_680727
"
null
null
)
;
var
gAsyncHistory
=
Cc
[
"
mozilla
.
org
/
browser
/
history
;
1
"
]
.
getService
(
Ci
.
mozIAsyncHistory
)
;
var
proxyPrefValue
;
var
ourTab
;
function
test
(
)
{
waitForExplicitFinish
(
)
;
proxyPrefValue
=
Services
.
prefs
.
getIntPref
(
"
network
.
proxy
.
type
"
)
;
Services
.
prefs
.
setIntPref
(
"
network
.
proxy
.
type
"
0
)
;
Components
.
classes
[
"
mozilla
.
org
/
netwerk
/
cache
-
storage
-
service
;
1
"
]
.
getService
(
Components
.
interfaces
.
nsICacheStorageService
)
.
clear
(
)
;
Services
.
io
.
offline
=
true
;
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
.
then
(
tab
=
>
{
ourTab
=
tab
;
BrowserTestUtils
.
waitForContentEvent
(
ourTab
.
linkedBrowser
"
DOMContentLoaded
"
)
.
then
(
errorListener
)
;
BrowserTestUtils
.
loadURI
(
ourTab
.
linkedBrowser
kUniqueURI
.
spec
)
;
}
)
;
}
function
errorListener
(
)
{
ok
(
Services
.
io
.
offline
"
Services
.
io
.
offline
is
true
.
"
)
;
ContentTask
.
spawn
(
ourTab
.
linkedBrowser
kUniqueURI
.
spec
function
(
uri
)
{
Assert
.
equal
(
content
.
document
.
documentURI
.
substring
(
0
27
)
"
about
:
neterror
?
e
=
netOffline
"
"
Document
URI
is
the
error
page
.
"
)
;
Assert
.
equal
(
content
.
location
.
href
uri
"
Docshell
URI
is
the
original
URI
.
"
)
;
}
)
.
then
(
(
)
=
>
{
return
PlacesTestUtils
.
promiseAsyncUpdates
(
)
.
then
(
(
)
=
>
{
gAsyncHistory
.
isURIVisited
(
kUniqueURI
errorAsyncListener
)
;
}
)
;
}
)
;
}
function
errorAsyncListener
(
aURI
aIsVisited
)
{
ok
(
kUniqueURI
.
equals
(
aURI
)
&
&
!
aIsVisited
"
The
neterror
page
is
not
listed
in
global
history
.
"
)
;
Services
.
prefs
.
setIntPref
(
"
network
.
proxy
.
type
"
proxyPrefValue
)
;
Services
.
io
.
offline
=
false
;
BrowserTestUtils
.
waitForContentEvent
(
ourTab
.
linkedBrowser
"
DOMContentLoaded
"
)
.
then
(
reloadListener
)
;
ContentTask
.
spawn
(
ourTab
.
linkedBrowser
null
function
(
)
{
Assert
.
ok
(
content
.
document
.
getElementById
(
"
errorTryAgain
"
)
"
The
error
page
has
got
a
#
errorTryAgain
element
"
)
;
content
.
document
.
getElementById
(
"
errorTryAgain
"
)
.
click
(
)
;
}
)
;
}
function
reloadListener
(
)
{
ok
(
!
Services
.
io
.
offline
"
Services
.
io
.
offline
is
false
.
"
)
;
ContentTask
.
spawn
(
ourTab
.
linkedBrowser
kUniqueURI
.
spec
function
(
uri
)
{
Assert
.
equal
(
content
.
document
.
documentURI
uri
"
Document
URI
is
not
the
offline
-
error
page
but
the
original
URI
.
"
)
;
}
)
.
then
(
(
)
=
>
{
PlacesTestUtils
.
promiseAsyncUpdates
(
)
.
then
(
(
)
=
>
{
gAsyncHistory
.
isURIVisited
(
kUniqueURI
reloadAsyncListener
)
;
}
)
;
}
)
;
}
function
reloadAsyncListener
(
aURI
aIsVisited
)
{
ok
(
kUniqueURI
.
equals
(
aURI
)
&
&
aIsVisited
"
We
have
visited
the
URI
.
"
)
;
PlacesTestUtils
.
clearHistory
(
)
.
then
(
finish
)
;
}
registerCleanupFunction
(
function
*
(
)
{
Services
.
prefs
.
setIntPref
(
"
network
.
proxy
.
type
"
proxyPrefValue
)
;
Services
.
io
.
offline
=
false
;
yield
BrowserTestUtils
.
removeTab
(
ourTab
)
;
}
)
;
