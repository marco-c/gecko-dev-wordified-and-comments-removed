add_task
(
function
*
(
)
{
let
tab
=
yield
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
'
http
:
/
/
example
.
com
'
)
;
let
newTitlePromise
=
new
Promise
(
resolve
=
>
{
let
observer
=
{
onTitleChanged
(
uri
title
)
{
if
(
/
new_page
/
.
test
(
uri
.
spec
)
)
{
resolve
(
title
)
;
PlacesUtils
.
history
.
removeObserver
(
observer
)
;
}
}
onBeginUpdateBatch
(
)
{
}
onEndUpdateBatch
(
)
{
}
onVisit
(
)
{
}
onDeleteURI
(
)
{
}
onClearHistory
(
)
{
}
onPageChanged
(
)
{
}
onDeleteVisits
(
)
{
}
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsINavHistoryObserver
]
)
}
;
PlacesUtils
.
history
.
addObserver
(
observer
false
)
;
}
)
;
yield
ContentTask
.
spawn
(
tab
.
linkedBrowser
null
function
*
(
)
{
let
title
=
content
.
document
.
title
;
content
.
history
.
pushState
(
'
'
'
'
'
new_page
'
)
;
Assert
.
ok
(
title
"
Content
window
should
initially
have
a
title
.
"
)
;
}
)
;
let
newtitle
=
yield
newTitlePromise
;
yield
ContentTask
.
spawn
(
tab
.
linkedBrowser
{
newtitle
}
function
*
(
args
)
{
Assert
.
equal
(
args
.
newtitle
content
.
document
.
title
"
Title
after
pushstate
.
"
)
;
}
)
;
yield
PlacesTestUtils
.
clearHistory
(
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
