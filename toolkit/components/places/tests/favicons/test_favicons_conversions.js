var
isWindows
=
"
mozilla
.
org
/
windows
-
registry
-
key
;
1
"
in
Cc
;
async
function
checkFaviconDataConversion
(
aFileName
aFileMimeType
aFileLength
aExpectConversion
aVaryOnWindows
)
{
let
pageURI
=
NetUtil
.
newURI
(
"
http
:
/
/
places
.
test
/
page
/
"
+
aFileName
)
;
await
PlacesTestUtils
.
addVisits
(
{
uri
:
pageURI
transition
:
TRANSITION_TYPED
}
)
;
let
faviconURI
=
NetUtil
.
newURI
(
"
http
:
/
/
places
.
test
/
icon
/
"
+
aFileName
)
;
let
fileData
=
readFileOfLength
(
aFileName
aFileLength
)
;
let
fileDataURL
=
await
PlacesTestUtils
.
fileDataToDataURL
(
fileData
aFileMimeType
)
;
await
PlacesTestUtils
.
setFaviconForPage
(
pageURI
.
spec
faviconURI
.
spec
fileDataURL
)
;
if
(
!
aExpectConversion
)
{
await
checkFaviconDataForPage
(
pageURI
aFileMimeType
fileData
)
;
}
else
if
(
!
aVaryOnWindows
|
|
!
isWindows
)
{
let
allowMissing
=
AppConstants
.
USE_LIBZ_RS
;
let
expectedFile
=
do_get_file
(
"
expected
-
"
+
aFileName
+
(
AppConstants
.
USE_LIBZ_RS
?
"
.
libz
-
rs
.
png
"
:
"
.
png
"
)
allowMissing
)
;
if
(
!
expectedFile
.
exists
(
)
)
{
expectedFile
=
do_get_file
(
"
expected
-
"
+
aFileName
+
"
.
png
"
)
;
}
let
expectedData
=
readFileData
(
expectedFile
)
;
await
checkFaviconDataForPage
(
pageURI
"
image
/
png
"
expectedData
)
;
}
else
{
await
checkFaviconDataForPage
(
pageURI
"
image
/
png
"
null
)
;
}
}
add_task
(
async
function
test_storing_a_normal_16x16_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
normal16
.
png
"
"
image
/
png
"
286
false
false
)
;
}
)
;
add_task
(
async
function
test_storing_a_normal_32x32_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
normal32
.
png
"
"
image
/
png
"
344
false
false
)
;
}
)
;
add_task
(
async
function
test_storing_a_big_16x16_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big16
.
ico
"
"
image
/
x
-
icon
"
1406
true
false
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_4x4_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big4
.
jpg
"
"
image
/
jpeg
"
4751
true
false
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_32x32_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big32
.
jpg
"
"
image
/
jpeg
"
3494
true
true
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_48x48_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big48
.
ico
"
"
image
/
x
-
icon
"
56646
true
false
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_64x64_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big64
.
png
"
"
image
/
png
"
10698
true
false
)
;
}
)
;
add_task
(
async
function
test_scaling_an_oversize_160x3_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
scale160x3
.
jpg
"
"
image
/
jpeg
"
5095
true
false
)
;
}
)
;
add_task
(
async
function
test_scaling_an_oversize_3x160_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
scale3x160
.
jpg
"
"
image
/
jpeg
"
5059
true
false
)
;
}
)
;
add_task
(
async
function
test_animated_16x16_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
animated16
.
png
"
"
image
/
png
"
1791
true
false
)
;
}
)
;
