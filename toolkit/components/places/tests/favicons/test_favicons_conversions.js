var
isWindows
=
(
"
mozilla
.
org
/
windows
-
registry
-
key
;
1
"
in
Cc
)
;
async
function
checkFaviconDataConversion
(
aFileName
aFileMimeType
aFileLength
aExpectConversion
aVaryOnWindows
)
{
let
pageURI
=
NetUtil
.
newURI
(
"
http
:
/
/
places
.
test
/
page
/
"
+
aFileName
)
;
await
PlacesTestUtils
.
addVisits
(
{
uri
:
pageURI
transition
:
TRANSITION_TYPED
}
)
;
let
faviconURI
=
NetUtil
.
newURI
(
"
http
:
/
/
places
.
test
/
icon
/
"
+
aFileName
)
;
let
fileData
=
readFileOfLength
(
aFileName
aFileLength
)
;
PlacesUtils
.
favicons
.
replaceFaviconData
(
faviconURI
fileData
fileData
.
length
aFileMimeType
)
;
await
new
Promise
(
resolve
=
>
{
PlacesUtils
.
favicons
.
setAndFetchFaviconForPage
(
pageURI
faviconURI
true
PlacesUtils
.
favicons
.
FAVICON_LOAD_NON_PRIVATE
(
aURI
aDataLen
aData
aMimeType
)
=
>
{
if
(
!
aExpectConversion
)
{
Assert
.
ok
(
compareArrays
(
aData
fileData
)
)
;
Assert
.
equal
(
aMimeType
aFileMimeType
)
;
}
else
{
if
(
!
aVaryOnWindows
|
|
!
isWindows
)
{
let
expectedFile
=
do_get_file
(
"
expected
-
"
+
aFileName
+
"
.
png
"
)
;
Assert
.
ok
(
compareArrays
(
aData
readFileData
(
expectedFile
)
)
)
;
}
Assert
.
equal
(
aMimeType
"
image
/
png
"
)
;
}
resolve
(
)
;
}
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
)
;
}
)
;
}
add_task
(
async
function
test_storing_a_normal_16x16_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
normal16
.
png
"
"
image
/
png
"
286
false
false
)
;
}
)
;
add_task
(
async
function
test_storing_a_normal_32x32_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
normal32
.
png
"
"
image
/
png
"
344
false
false
)
;
}
)
;
add_task
(
async
function
test_storing_a_big_16x16_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big16
.
ico
"
"
image
/
x
-
icon
"
1406
true
false
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_4x4_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big4
.
jpg
"
"
image
/
jpeg
"
4751
true
false
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_32x32_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big32
.
jpg
"
"
image
/
jpeg
"
3494
true
true
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_48x48_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big48
.
ico
"
"
image
/
x
-
icon
"
56646
true
false
)
;
}
)
;
add_task
(
async
function
test_storing_an_oversize_64x64_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
big64
.
png
"
"
image
/
png
"
10698
true
false
)
;
}
)
;
add_task
(
async
function
test_scaling_an_oversize_160x3_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
scale160x3
.
jpg
"
"
image
/
jpeg
"
5095
true
false
)
;
}
)
;
add_task
(
async
function
test_scaling_an_oversize_3x160_icon
(
)
{
await
checkFaviconDataConversion
(
"
favicon
-
scale3x160
.
jpg
"
"
image
/
jpeg
"
5059
true
false
)
;
}
)
;
