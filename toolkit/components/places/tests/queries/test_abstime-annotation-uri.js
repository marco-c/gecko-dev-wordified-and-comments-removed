const
DAY_MSEC
=
86400000
;
const
MIN_MSEC
=
60000
;
const
HOUR_MSEC
=
3600000
;
var
beginTimeDate
=
new
Date
(
2008
0
6
8
0
0
0
)
;
var
endTimeDate
=
new
Date
(
2008
0
15
21
30
0
0
)
;
var
beginTime
=
beginTimeDate
.
getTime
(
)
;
var
endTime
=
endTimeDate
.
getTime
(
)
;
var
now
=
PlacesUtils
.
toPRTime
(
Date
.
now
(
)
)
;
var
jan7_8_00
=
PlacesUtils
.
toPRTime
(
beginTime
+
DAY_MSEC
)
;
var
jan6_8_15
=
PlacesUtils
.
toPRTime
(
beginTime
+
MIN_MSEC
*
15
)
;
var
jan14_21_30
=
PlacesUtils
.
toPRTime
(
endTime
-
DAY_MSEC
)
;
var
jan15_20_45
=
PlacesUtils
.
toPRTime
(
endTime
-
MIN_MSEC
*
45
)
;
var
jan12_17_30
=
PlacesUtils
.
toPRTime
(
endTime
-
DAY_MSEC
*
3
-
HOUR_MSEC
*
4
)
;
var
jan6_7_00
=
PlacesUtils
.
toPRTime
(
beginTime
-
HOUR_MSEC
)
;
var
dec27_8_00
=
PlacesUtils
.
toPRTime
(
beginTime
-
DAY_MSEC
*
10
)
;
var
goodAnnoName
=
"
moz
-
test
-
places
/
testing123
"
;
var
val
=
"
test
"
;
var
badAnnoName
=
"
text
/
foo
"
;
var
testData
=
[
{
isInQuery
:
true
isVisit
:
true
isDetails
:
true
isPageAnnotation
:
true
uri
:
"
http
:
/
/
foo
.
com
/
"
annoName
:
goodAnnoName
annoVal
:
val
lastVisit
:
jan14_21_30
title
:
"
moz
"
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
isPageAnnotation
:
true
uri
:
"
http
:
/
/
www
.
foo
.
com
/
yiihah
"
annoName
:
goodAnnoName
annoVal
:
val
lastVisit
:
jan7_8_00
title
:
"
moz
"
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
uri
:
"
http
:
/
/
mail
.
foo
.
com
/
yiihah
"
title
:
"
moz
"
lastVisit
:
jan6_8_15
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
title
:
"
moz
"
uri
:
"
https
:
/
/
foo
.
com
/
"
lastVisit
:
jan15_20_45
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
uri
:
"
ftp
:
/
/
foo
.
com
/
ftp
"
lastVisit
:
jan12_17_30
title
:
"
hugelongconfmozlagurationofwordswithasearchtermsinit
whoo
-
hoo
"
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
title
:
"
moz
"
uri
:
"
http
:
/
/
foo
.
com
/
tooearly
.
php
"
lastVisit
:
jan6_7_00
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
isPageAnnotation
:
true
title
:
"
moz
"
uri
:
"
http
:
/
/
foo
.
com
/
badanno
.
htm
"
lastVisit
:
jan12_17_30
annoName
:
badAnnoName
annoVal
:
val
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
title
:
"
changeme
"
uri
:
"
http
:
/
/
foo
.
com
/
changeme1
.
htm
"
lastVisit
:
jan12_17_30
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
title
:
"
changeme2
"
uri
:
"
http
:
/
/
foo
.
com
/
changeme2
.
htm
"
lastVisit
:
jan7_8_00
}
{
isInQuery
:
false
isVisit
:
true
isDetails
:
true
title
:
"
moz
"
uri
:
"
http
:
/
/
foo
.
com
/
changeme3
.
htm
"
lastVisit
:
dec27_8_00
}
]
;
add_task
(
async
function
test_abstime_annotation_uri
(
)
{
await
task_populateDB
(
testData
)
;
var
query
=
PlacesUtils
.
history
.
getNewQuery
(
)
;
query
.
beginTime
=
PlacesUtils
.
toPRTime
(
beginTime
)
;
query
.
endTime
=
PlacesUtils
.
toPRTime
(
endTime
)
;
query
.
beginTimeReference
=
PlacesUtils
.
history
.
TIME_RELATIVE_EPOCH
;
query
.
endTimeReference
=
PlacesUtils
.
history
.
TIME_RELATIVE_EPOCH
;
query
.
searchTerms
=
"
moz
"
;
query
.
uri
=
uri
(
"
http
:
/
/
foo
.
com
"
)
;
query
.
annotation
=
"
text
/
foo
"
;
query
.
annotationIsNot
=
true
;
var
options
=
PlacesUtils
.
history
.
getNewQueryOptions
(
)
;
options
.
sortingMode
=
options
.
SORT_BY_URI_ASCENDING
;
options
.
resultType
=
options
.
RESULTS_AS_URI
;
var
result
=
PlacesUtils
.
history
.
executeQuery
(
query
options
)
;
var
root
=
result
.
root
;
root
.
containerOpen
=
true
;
compareArrayToResult
(
testData
root
)
;
info
(
"
change
title
"
)
;
var
change1
=
[
{
isDetails
:
true
uri
:
"
http
:
/
/
foo
.
com
/
"
title
:
"
mo
"
lastVisit
:
now
}
]
;
await
task_populateDB
(
change1
)
;
Assert
.
ok
(
!
nodeInResult
(
{
uri
:
"
http
:
/
/
foo
.
com
/
"
}
root
)
)
;
var
change2
=
[
{
isDetails
:
true
uri
:
"
http
:
/
/
foo
.
com
/
"
title
:
"
moz
"
lastVisit
:
PlacesUtils
.
toPRTime
(
endTime
+
1
)
}
]
;
await
task_populateDB
(
change2
)
;
let
node
=
nodeInResult
(
{
uri
:
"
http
:
/
/
foo
.
com
/
"
}
root
)
;
Assert
.
ok
(
node
)
;
Assert
.
equal
(
node
.
time
now
"
The
node
time
should
be
the
absolute
last
visit
date
"
)
;
var
change3
=
[
{
isPageAnnotation
:
true
uri
:
"
http
:
/
/
foo
.
com
/
"
annoName
:
badAnnoName
annoVal
:
"
test
"
}
]
;
await
task_populateDB
(
change3
)
;
info
(
"
LiveUpdate
by
removing
annotation
"
)
;
node
=
nodeInResult
(
{
uri
:
"
http
:
/
/
foo
.
com
/
"
}
root
)
;
Assert
.
ok
(
node
)
;
Assert
.
equal
(
node
.
time
now
"
The
node
time
should
be
the
last
visit
date
future
dates
are
capped
to
now
"
)
;
root
.
containerOpen
=
false
;
}
)
;
