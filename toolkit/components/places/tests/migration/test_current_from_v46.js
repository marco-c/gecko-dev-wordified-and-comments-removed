"
use
strict
"
;
let
guid
=
"
null
"
.
padEnd
(
12
"
_
"
)
;
add_task
(
async
function
setup
(
)
{
await
setupPlacesDatabase
(
"
places_v43
.
sqlite
"
)
;
let
path
=
OS
.
Path
.
join
(
OS
.
Constants
.
Path
.
profileDir
DB_FILENAME
)
;
let
db
=
await
Sqlite
.
openConnection
(
{
path
}
)
;
await
db
.
execute
(
INSERT
INTO
moz_places
(
url
guid
url_hash
)
VALUES
(
NULL
:
guid
"
123456
"
)
{
guid
}
)
;
await
db
.
execute
(
INSERT
INTO
moz_bookmarks
(
fk
guid
)
VALUES
(
(
SELECT
id
FROM
moz_places
WHERE
guid
=
:
guid
)
:
guid
)
{
guid
}
)
;
await
db
.
close
(
)
;
}
)
;
add_task
(
async
function
database_is_valid
(
)
{
Assert
.
equal
(
PlacesUtils
.
history
.
databaseStatus
PlacesUtils
.
history
.
DATABASE_STATUS_UPGRADED
)
;
let
db
=
await
PlacesUtils
.
promiseDBConnection
(
)
;
Assert
.
equal
(
await
db
.
getSchemaVersion
(
)
CURRENT_SCHEMA_VERSION
)
;
let
page
=
await
PlacesUtils
.
history
.
fetch
(
guid
)
;
Assert
.
equal
(
page
.
url
.
href
"
place
:
excludeItems
=
1
"
)
;
let
rows
=
await
db
.
execute
(
SELECT
syncChangeCounter
FROM
moz_bookmarks
WHERE
guid
=
:
guid
{
guid
}
)
;
Assert
.
equal
(
rows
[
0
]
.
getResultByIndex
(
0
)
2
)
;
}
)
;
