add_task
(
async
function
compress_bookmark_backups_test
(
)
{
let
todayFilename
=
PlacesBackups
.
getFilenameForDate
(
new
Date
(
2014
4
15
)
true
)
;
do_check_eq
(
todayFilename
"
bookmarks
-
2014
-
05
-
15
.
jsonlz4
"
)
;
await
PlacesBackups
.
create
(
)
;
do_check_eq
(
(
await
PlacesBackups
.
getBackupFiles
(
)
)
.
length
1
)
;
let
mostRecentBackupFile
=
await
PlacesBackups
.
getMostRecentBackup
(
)
;
do_check_neq
(
mostRecentBackupFile
null
)
;
do_check_true
(
PlacesBackups
.
filenamesRegex
.
test
(
OS
.
Path
.
basename
(
mostRecentBackupFile
)
)
)
;
await
OS
.
File
.
remove
(
mostRecentBackupFile
)
;
do_check_false
(
(
await
OS
.
File
.
exists
(
mostRecentBackupFile
)
)
)
;
let
jsonFile
=
OS
.
Path
.
join
(
OS
.
Constants
.
Path
.
profileDir
"
bookmarks
.
json
"
)
;
await
PlacesBackups
.
saveBookmarksToJSONFile
(
jsonFile
)
;
do_check_eq
(
(
await
PlacesBackups
.
getBackupFiles
(
)
)
.
length
1
)
;
let
url
=
"
http
:
/
/
www
.
mozilla
.
org
/
en
-
US
/
"
;
let
bm
=
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
title
:
"
bookmark
"
url
}
)
;
await
PlacesBackups
.
create
(
undefined
true
)
;
let
recentBackup
=
await
PlacesBackups
.
getMostRecentBackup
(
)
;
await
PlacesUtils
.
bookmarks
.
remove
(
bm
)
;
await
BookmarkJSONUtils
.
importFromFile
(
recentBackup
true
)
;
let
root
=
PlacesUtils
.
getFolderContents
(
PlacesUtils
.
unfiledBookmarksFolderId
)
.
root
;
let
node
=
root
.
getChild
(
0
)
;
do_check_eq
(
node
.
uri
url
)
;
root
.
containerOpen
=
false
;
PlacesUtils
.
bookmarks
.
removeFolderChildren
(
PlacesUtils
.
unfiledBookmarksFolderId
)
;
await
OS
.
File
.
remove
(
jsonFile
)
;
}
)
;
