"
use
strict
"
;
class
PaymentDialog
extends
PaymentStateSubscriberMixin
(
HTMLElement
)
{
constructor
(
)
{
super
(
)
;
this
.
_template
=
document
.
getElementById
(
"
payment
-
dialog
-
template
"
)
;
this
.
_cachedState
=
{
}
;
}
connectedCallback
(
)
{
let
contents
=
document
.
importNode
(
this
.
_template
.
content
true
)
;
this
.
_hostNameEl
=
contents
.
querySelector
(
"
#
host
-
name
"
)
;
this
.
_cancelButton
=
contents
.
querySelector
(
"
#
cancel
"
)
;
this
.
_cancelButton
.
addEventListener
(
"
click
"
this
.
cancelRequest
)
;
this
.
_payButton
=
contents
.
querySelector
(
"
#
pay
"
)
;
this
.
_payButton
.
addEventListener
(
"
click
"
this
)
;
this
.
_viewAllButton
=
contents
.
querySelector
(
"
#
view
-
all
"
)
;
this
.
_viewAllButton
.
addEventListener
(
"
click
"
this
)
;
this
.
_orderDetailsOverlay
=
contents
.
querySelector
(
"
#
order
-
details
-
overlay
"
)
;
this
.
_shippingRequestedEls
=
contents
.
querySelectorAll
(
"
.
shippingRequested
"
)
;
this
.
_disabledOverlay
=
contents
.
getElementById
(
"
disabled
-
overlay
"
)
;
this
.
appendChild
(
contents
)
;
super
.
connectedCallback
(
)
;
}
disconnectedCallback
(
)
{
this
.
_cancelButton
.
removeEventListener
(
"
click
"
this
.
cancelRequest
)
;
this
.
_payButton
.
removeEventListener
(
"
click
"
this
.
pay
)
;
this
.
_viewAllButton
.
removeEventListener
(
"
click
"
this
)
;
super
.
disconnectedCallback
(
)
;
}
handleEvent
(
event
)
{
if
(
event
.
type
=
=
"
click
"
)
{
switch
(
event
.
target
)
{
case
this
.
_viewAllButton
:
let
orderDetailsShowing
=
!
this
.
requestStore
.
getState
(
)
.
orderDetailsShowing
;
this
.
requestStore
.
setState
(
{
orderDetailsShowing
}
)
;
break
;
case
this
.
_payButton
:
this
.
pay
(
)
;
break
;
}
}
}
cancelRequest
(
)
{
paymentRequest
.
cancel
(
)
;
}
pay
(
)
{
let
{
selectedPaymentCard
selectedPaymentCardSecurityCode
}
=
this
.
requestStore
.
getState
(
)
;
paymentRequest
.
pay
(
{
selectedPaymentCardGUID
:
selectedPaymentCard
selectedPaymentCardSecurityCode
}
)
;
}
changeShippingAddress
(
shippingAddressGUID
)
{
paymentRequest
.
changeShippingAddress
(
{
shippingAddressGUID
}
)
;
}
changeShippingOption
(
optionID
)
{
paymentRequest
.
changeShippingOption
(
{
optionID
}
)
;
}
setStateFromParent
(
state
)
{
this
.
requestStore
.
setState
(
state
)
;
state
=
this
.
requestStore
.
getState
(
)
;
let
{
savedAddresses
savedBasicCards
selectedPaymentCard
selectedShippingAddress
selectedShippingOption
}
=
state
;
let
shippingOptions
=
state
.
request
.
paymentDetails
.
shippingOptions
;
if
(
!
savedAddresses
[
selectedShippingAddress
]
)
{
this
.
requestStore
.
setState
(
{
selectedShippingAddress
:
Object
.
keys
(
savedAddresses
)
[
0
]
|
|
null
}
)
;
}
if
(
!
savedBasicCards
[
selectedPaymentCard
]
)
{
this
.
requestStore
.
setState
(
{
selectedPaymentCard
:
Object
.
keys
(
savedBasicCards
)
[
0
]
|
|
null
selectedPaymentCardSecurityCode
:
null
}
)
;
}
if
(
shippingOptions
&
&
!
shippingOptions
.
find
(
option
=
>
option
.
id
=
=
selectedShippingOption
)
)
{
for
(
let
i
=
shippingOptions
.
length
-
1
;
i
>
=
0
;
i
-
-
)
{
if
(
shippingOptions
[
i
]
.
selected
)
{
selectedShippingOption
=
shippingOptions
[
i
]
.
id
;
break
;
}
}
if
(
!
selectedShippingOption
&
&
shippingOptions
.
length
)
{
selectedShippingOption
=
shippingOptions
[
0
]
.
id
;
}
this
.
_cachedState
.
selectedShippingOption
=
selectedShippingOption
;
this
.
requestStore
.
setState
(
{
selectedShippingOption
}
)
;
}
}
_renderPayButton
(
state
)
{
this
.
_payButton
.
disabled
=
state
.
changesPrevented
;
switch
(
state
.
completionState
)
{
case
"
initial
"
:
case
"
processing
"
:
break
;
default
:
throw
new
Error
(
"
Invalid
completionState
"
)
;
}
this
.
_payButton
.
textContent
=
this
.
_payButton
.
dataset
[
state
.
completionState
+
"
Label
"
]
;
}
stateChangeCallback
(
state
)
{
super
.
stateChangeCallback
(
state
)
;
if
(
state
.
selectedShippingAddress
!
=
this
.
_cachedState
.
selectedShippingAddress
)
{
this
.
changeShippingAddress
(
state
.
selectedShippingAddress
)
;
}
if
(
state
.
selectedShippingOption
!
=
this
.
_cachedState
.
selectedShippingOption
)
{
this
.
changeShippingOption
(
state
.
selectedShippingOption
)
;
}
this
.
_cachedState
.
selectedShippingAddress
=
state
.
selectedShippingAddress
;
this
.
_cachedState
.
selectedShippingOption
=
state
.
selectedShippingOption
;
}
render
(
state
)
{
let
request
=
state
.
request
;
this
.
_hostNameEl
.
textContent
=
request
.
topLevelPrincipal
.
URI
.
displayHost
;
let
totalItem
=
request
.
paymentDetails
.
totalItem
;
let
totalAmountEl
=
this
.
querySelector
(
"
#
total
>
currency
-
amount
"
)
;
totalAmountEl
.
value
=
totalItem
.
amount
.
value
;
totalAmountEl
.
currency
=
totalItem
.
amount
.
currency
;
this
.
_orderDetailsOverlay
.
hidden
=
!
state
.
orderDetailsShowing
;
for
(
let
element
of
this
.
_shippingRequestedEls
)
{
element
.
hidden
=
!
request
.
paymentOptions
.
requestShipping
;
}
this
.
_renderPayButton
(
state
)
;
let
{
changesPrevented
completionState
}
=
state
;
if
(
changesPrevented
)
{
this
.
setAttribute
(
"
changes
-
prevented
"
"
"
)
;
}
else
{
this
.
removeAttribute
(
"
changes
-
prevented
"
)
;
}
this
.
setAttribute
(
"
completion
-
state
"
completionState
)
;
this
.
_disabledOverlay
.
hidden
=
!
changesPrevented
;
}
}
customElements
.
define
(
"
payment
-
dialog
"
PaymentDialog
)
;
