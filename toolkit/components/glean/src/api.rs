#
!
[
allow
(
dead_code
)
]
use
fog
:
:
ping_upload
:
:
{
self
UploadResult
}
;
use
glean_core
:
:
{
global_glean
setup_glean
Configuration
Glean
Result
}
;
use
once_cell
:
:
sync
:
:
OnceCell
;
use
url
:
:
Url
;
use
viaduct
:
:
Request
;
use
crate
:
:
client_info
:
:
ClientInfo
;
use
crate
:
:
core_metrics
:
:
InternalMetrics
;
#
[
derive
(
Debug
Clone
)
]
pub
struct
AppState
{
client_info
:
ClientInfo
}
static
STATE
:
OnceCell
<
AppState
>
=
OnceCell
:
:
new
(
)
;
fn
global_state
(
)
-
>
&
'
static
AppState
{
STATE
.
get
(
)
.
unwrap
(
)
}
fn
with_glean_mut
<
F
R
>
(
f
:
F
)
-
>
Option
<
R
>
where
F
:
Fn
(
&
mut
Glean
)
-
>
R
{
let
mut
glean
=
global_glean
(
)
?
.
lock
(
)
.
unwrap
(
)
;
Some
(
f
(
&
mut
glean
)
)
}
pub
fn
initialize
(
cfg
:
Configuration
client_info
:
ClientInfo
)
-
>
Result
<
(
)
>
{
STATE
.
get_or_try_init
(
|
|
{
let
glean
=
Glean
:
:
new
(
cfg
)
?
;
initialize_core_metrics
(
&
glean
&
client_info
)
;
setup_glean
(
glean
)
?
;
register_uploader
(
)
;
Ok
(
AppState
{
client_info
}
)
}
)
.
map
(
|
_
|
(
)
)
}
fn
initialize_core_metrics
(
glean
:
&
Glean
client_info
:
&
ClientInfo
)
{
let
core_metrics
=
InternalMetrics
:
:
new
(
)
;
core_metrics
.
app_build
.
set
(
glean
&
client_info
.
app_build
[
.
.
]
)
;
core_metrics
.
app_display_version
.
set
(
glean
&
client_info
.
app_display_version
[
.
.
]
)
;
if
let
Some
(
app_channel
)
=
&
client_info
.
channel
{
core_metrics
.
app_channel
.
set
(
glean
app_channel
)
;
}
core_metrics
.
os
.
set
(
glean
"
unknown
"
.
to_string
(
)
)
;
core_metrics
.
os_version
.
set
(
glean
&
client_info
.
os_version
[
.
.
]
)
;
core_metrics
.
architecture
.
set
(
glean
&
client_info
.
architecture
)
;
core_metrics
.
device_manufacturer
.
set
(
glean
"
unknown
"
.
to_string
(
)
)
;
core_metrics
.
device_model
.
set
(
glean
"
unknown
"
.
to_string
(
)
)
;
}
pub
fn
set_upload_enabled
(
enabled
:
bool
)
-
>
bool
{
with_glean_mut
(
|
glean
|
{
let
state
=
global_state
(
)
;
let
old_enabled
=
glean
.
is_upload_enabled
(
)
;
glean
.
set_upload_enabled
(
enabled
)
;
if
!
old_enabled
&
&
enabled
{
initialize_core_metrics
(
&
glean
&
state
.
client_info
)
;
}
else
if
old_enabled
&
&
!
enabled
{
ping_upload
:
:
check_for_uploads
(
)
;
}
enabled
}
)
.
expect
(
"
Setting
upload
enabled
failed
!
"
)
}
fn
register_uploader
(
)
{
let
result
=
ping_upload
:
:
register_uploader
(
Box
:
:
new
(
|
ping_request
|
{
log
:
:
trace
!
(
"
FOG
Ping
Uploader
uploading
ping
{
}
"
ping_request
.
document_id
)
;
let
result
:
std
:
:
result
:
:
Result
<
UploadResult
viaduct
:
:
Error
>
=
(
move
|
|
{
const
SERVER
:
&
str
=
"
https
:
/
/
incoming
.
telemetry
.
mozilla
.
org
"
;
let
mut
server
=
String
:
:
from
(
SERVER
)
;
let
localhost_port
=
static_prefs
:
:
pref
!
(
"
telemetry
.
fog
.
test
.
localhost_port
"
)
;
if
localhost_port
>
0
{
server
=
format
!
(
"
http
:
/
/
localhost
:
{
}
"
localhost_port
)
;
}
else
if
localhost_port
<
0
{
log
:
:
info
!
(
"
FOG
Ping
uploader
faking
success
"
)
;
return
Ok
(
UploadResult
:
:
HttpStatus
(
200
)
)
;
}
let
url
=
Url
:
:
parse
(
&
server
)
?
.
join
(
&
ping_request
.
path
)
?
;
log
:
:
info
!
(
"
FOG
Ping
uploader
uploading
to
{
:
?
}
"
url
)
;
let
mut
req
=
Request
:
:
post
(
url
)
.
body
(
ping_request
.
body
.
clone
(
)
)
;
for
(
header_key
header_value
)
in
&
ping_request
.
headers
{
req
=
req
.
header
(
header_key
.
to_owned
(
)
header_value
)
?
;
}
log
:
:
trace
!
(
"
FOG
Ping
Uploader
sending
ping
{
}
"
ping_request
.
document_id
)
;
let
res
=
req
.
send
(
)
?
;
Ok
(
UploadResult
:
:
HttpStatus
(
res
.
status
.
into
(
)
)
)
}
)
(
)
;
log
:
:
trace
!
(
"
FOG
Ping
Uploader
completed
uploading
ping
{
}
(
Result
{
:
?
}
)
"
ping_request
.
document_id
result
)
;
match
result
{
Ok
(
result
)
=
>
result
_
=
>
UploadResult
:
:
UnrecoverableFailure
}
}
)
)
;
if
result
.
is_err
(
)
{
log
:
:
warn
!
(
"
Couldn
'
t
register
uploader
because
one
'
s
already
in
there
.
{
:
?
}
"
result
)
;
}
}
pub
fn
set_debug_view_tag
(
value
:
&
str
)
-
>
bool
{
with_glean_mut
(
|
glean
|
glean
.
set_debug_view_tag
(
value
)
)
.
unwrap_or
(
false
)
}
pub
fn
submit_ping
(
ping_name
:
&
str
)
-
>
Result
<
bool
>
{
match
with_glean_mut
(
|
glean
|
glean
.
submit_ping_by_name
(
ping_name
None
)
)
{
Some
(
Ok
(
true
)
)
=
>
{
ping_upload
:
:
check_for_uploads
(
)
;
Ok
(
true
)
}
Some
(
result
)
=
>
result
None
=
>
Ok
(
false
)
}
}
pub
fn
set_log_pings
(
value
:
bool
)
-
>
bool
{
with_glean_mut
(
|
glean
|
glean
.
set_log_pings
(
value
)
)
.
unwrap_or
(
false
)
}
