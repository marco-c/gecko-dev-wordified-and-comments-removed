"
use
strict
"
;
Cu
.
importGlobalProperties
(
[
"
Glean
"
]
)
;
const
{
setTimeout
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
)
;
function
sleep
(
ms
)
{
return
new
Promise
(
resolve
=
>
setTimeout
(
resolve
ms
)
)
;
}
add_task
(
function
test_setup
(
)
{
do_get_profile
(
)
;
let
FOG
=
Cc
[
"
mozilla
.
org
/
toolkit
/
glean
;
1
"
]
.
createInstance
(
Ci
.
nsIFOG
)
;
FOG
.
initializeFOG
(
)
;
}
)
;
add_task
(
function
test_fog_counter_works
(
)
{
Glean
.
test_only
.
bad_code
.
add
(
31
)
;
Assert
.
ok
(
Glean
.
test_only
.
bad_code
.
testHasValue
(
"
test
-
ping
"
)
)
;
Assert
.
equal
(
31
Glean
.
test_only
.
bad_code
.
testGetValue
(
"
test
-
ping
"
)
)
;
}
)
;
add_task
(
async
function
test_fog_timespan_works
(
)
{
Glean
.
test_only
.
can_we_time_it
.
start
(
)
;
await
sleep
(
10
)
;
Glean
.
test_only
.
can_we_time_it
.
stop
(
)
;
Assert
.
ok
(
Glean
.
test_only
.
can_we_time_it
.
testHasValue
(
"
test
-
ping
"
)
)
;
Assert
.
ok
(
Glean
.
test_only
.
can_we_time_it
.
testGetValue
(
"
test
-
ping
"
)
>
0
)
;
}
)
;
add_task
(
async
function
test_fog_uuid_works
(
)
{
const
kTestUuid
=
"
decafdec
-
afde
-
cafd
-
ecaf
-
decafdecafde
"
;
Glean
.
test_only
.
what_id_it
.
set
(
kTestUuid
)
;
Assert
.
ok
(
Glean
.
test_only
.
what_id_it
.
testHasValue
(
"
test
-
ping
"
)
)
;
Assert
.
equal
(
kTestUuid
Glean
.
test_only
.
what_id_it
.
testGetValue
(
"
test
-
ping
"
)
)
;
Glean
.
test_only
.
what_id_it
.
generateAndSet
(
)
;
Assert
.
notEqual
(
kTestUuid
Glean
.
test_only
.
what_id_it
.
testGetValue
(
"
test
-
ping
"
)
)
;
}
)
;
