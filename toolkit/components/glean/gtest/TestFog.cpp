#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
glean
/
GleanMetrics
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
nsString
.
h
"
#
include
"
prtime
.
h
"
using
mozilla
:
:
Preferences
;
using
namespace
mozilla
:
:
glean
;
#
define
DATA_PREF
"
datareporting
.
healthreport
.
uploadEnabled
"
extern
"
C
"
{
void
GTest_FOG_ExpectFailure
(
const
char
*
aMessage
)
{
EXPECT_STREQ
(
aMessage
"
"
)
;
}
nsresult
fog_init
(
)
;
nsresult
fog_submit_ping
(
const
nsACString
*
aPingName
)
;
}
TEST
(
FOG
FogInitDoesntCrash
)
{
Preferences
:
:
SetInt
(
"
telemetry
.
fog
.
test
.
localhost_port
"
-
1
)
;
ASSERT_EQ
(
NS_OK
fog_init
(
)
)
;
Preferences
:
:
SetBool
(
DATA_PREF
false
)
;
Preferences
:
:
SetBool
(
DATA_PREF
true
)
;
}
TEST
(
FOG
BuiltinPingsRegistered
)
{
Preferences
:
:
SetInt
(
"
telemetry
.
fog
.
test
.
localhost_port
"
-
1
)
;
nsAutoCString
metricsPingName
(
"
metrics
"
)
;
nsAutoCString
baselinePingName
(
"
baseline
"
)
;
nsAutoCString
eventsPingName
(
"
events
"
)
;
ASSERT_EQ
(
NS_OK
fog_submit_ping
(
&
metricsPingName
)
)
;
ASSERT_EQ
(
NS_OK
fog_submit_ping
(
&
baselinePingName
)
)
;
ASSERT_EQ
(
NS_OK
fog_submit_ping
(
&
eventsPingName
)
)
;
}
TEST
(
FOG
TestCppCounterWorks
)
{
mozilla
:
:
glean
:
:
test_only
:
:
bad_code
.
Add
(
42
)
;
ASSERT_EQ
(
42
mozilla
:
:
glean
:
:
test_only
:
:
bad_code
.
TestGetValue
(
"
test
-
ping
"
)
.
value
(
)
)
;
}
TEST
(
FOG
TestCppStringWorks
)
{
auto
kValue
=
"
cheez
!
"
_ns
;
mozilla
:
:
glean
:
:
test_only
:
:
cheesy_string
.
Set
(
kValue
)
;
ASSERT_STREQ
(
kValue
.
get
(
)
mozilla
:
:
glean
:
:
test_only
:
:
cheesy_string
.
TestGetValue
(
"
test
-
ping
"
)
.
value
(
)
.
get
(
)
)
;
}
TEST
(
FOG
TestCppUuidWorks
)
{
nsCString
kTestUuid
(
"
decafdec
-
afde
-
cafd
-
ecaf
-
decafdecafde
"
)
;
test_only
:
:
what_id_it
.
Set
(
kTestUuid
)
;
ASSERT_STREQ
(
kTestUuid
.
get
(
)
test_only
:
:
what_id_it
.
TestGetValue
(
"
test
-
ping
"
)
.
value
(
)
.
get
(
)
)
;
test_only
:
:
what_id_it
.
GenerateAndSet
(
)
;
ASSERT_STRNE
(
kTestUuid
.
get
(
)
test_only
:
:
what_id_it
.
TestGetValue
(
"
test
-
ping
"
)
.
value
(
)
.
get
(
)
)
;
}
TEST
(
FOG
TestCppBooleanWorks
)
{
mozilla
:
:
glean
:
:
test_only
:
:
can_we_flag_it
.
Set
(
false
)
;
ASSERT_TRUE
(
mozilla
:
:
glean
:
:
test_only
:
:
can_we_flag_it
.
TestHasValue
(
"
test
-
ping
"
)
)
;
ASSERT_EQ
(
false
mozilla
:
:
glean
:
:
test_only
:
:
can_we_flag_it
.
TestGetValue
(
"
test
-
ping
"
)
)
;
}
