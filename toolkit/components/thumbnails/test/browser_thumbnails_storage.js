const
URL
=
"
http
:
/
/
mochi
.
test
:
8888
/
"
;
const
URL_COPY
=
URL
+
"
#
copy
"
;
XPCOMUtils
.
defineLazyGetter
(
this
"
Sanitizer
"
function
(
)
{
let
tmp
=
{
}
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
browser
/
content
/
sanitize
.
js
"
tmp
)
;
return
tmp
.
Sanitizer
;
}
)
;
function
*
runTests
(
)
{
yield
(
async
function
(
)
{
dontExpireThumbnailURLs
(
[
URL
URL_COPY
]
)
;
await
promiseClearHistory
(
)
;
await
promiseAddVisitsAndRepopulateNewTabLinks
(
URL
)
;
await
promiseCreateThumbnail
(
)
;
await
PageThumbsStorage
.
copy
(
URL
URL_COPY
)
;
let
copy
=
new
FileUtils
.
File
(
PageThumbsStorageService
.
getFilePathForURL
(
URL_COPY
)
)
;
let
mtime
=
copy
.
lastModifiedTime
-
=
60
;
await
PageThumbsStorage
.
copy
(
URL
URL_COPY
)
;
isnot
(
new
FileUtils
.
File
(
PageThumbsStorageService
.
getFilePathForURL
(
URL_COPY
)
)
.
lastModifiedTime
mtime
"
thumbnail
file
was
updated
"
)
;
let
file
=
new
FileUtils
.
File
(
PageThumbsStorageService
.
getFilePathForURL
(
URL
)
)
;
let
fileCopy
=
new
FileUtils
.
File
(
PageThumbsStorageService
.
getFilePathForURL
(
URL_COPY
)
)
;
info
(
"
Clearing
history
"
)
;
while
(
file
.
exists
(
)
|
|
fileCopy
.
exists
(
)
)
{
await
promiseClearHistory
(
)
;
}
info
(
"
History
is
clear
"
)
;
info
(
"
Repopulating
"
)
;
await
promiseAddVisitsAndRepopulateNewTabLinks
(
URL
)
;
await
promiseCreateThumbnail
(
)
;
info
(
"
Clearing
the
last
10
minutes
of
browsing
history
"
)
;
await
promiseClearHistory
(
true
)
;
info
(
"
Attempt
to
clear
file
"
)
;
await
promiseClearFile
(
file
URL
)
;
info
(
"
Done
"
)
;
}
)
(
)
;
}
async
function
promiseClearFile
(
aFile
aURL
)
{
if
(
!
aFile
.
exists
(
)
)
{
return
undefined
;
}
await
PlacesTestUtils
.
addVisits
(
makeURI
(
aURL
)
)
;
await
promiseClearHistory
(
true
)
;
return
promiseClearFile
(
aFile
aURL
)
;
}
function
promiseClearHistory
(
aUseRange
)
{
let
s
=
new
Sanitizer
(
)
;
s
.
prefDomain
=
"
privacy
.
cpd
.
"
;
let
prefs
=
Services
.
prefs
.
getBranch
(
s
.
prefDomain
)
;
prefs
.
setBoolPref
(
"
history
"
true
)
;
prefs
.
setBoolPref
(
"
downloads
"
false
)
;
prefs
.
setBoolPref
(
"
cache
"
false
)
;
prefs
.
setBoolPref
(
"
cookies
"
false
)
;
prefs
.
setBoolPref
(
"
formdata
"
false
)
;
prefs
.
setBoolPref
(
"
offlineApps
"
false
)
;
prefs
.
setBoolPref
(
"
passwords
"
false
)
;
prefs
.
setBoolPref
(
"
sessions
"
false
)
;
prefs
.
setBoolPref
(
"
siteSettings
"
false
)
;
if
(
aUseRange
)
{
let
usec
=
Date
.
now
(
)
*
1000
;
s
.
range
=
[
usec
-
10
*
60
*
1000
*
1000
usec
]
;
s
.
ignoreTimespan
=
false
;
}
return
s
.
sanitize
(
)
.
then
(
(
)
=
>
{
s
.
range
=
null
;
s
.
ignoreTimespan
=
true
;
}
)
;
}
function
promiseCreateThumbnail
(
)
{
return
new
Promise
(
resolve
=
>
{
addTab
(
URL
function
(
)
{
gBrowserThumbnails
.
clearTopSiteURLCache
(
)
;
whenFileExists
(
URL
function
(
)
{
gBrowser
.
removeTab
(
gBrowser
.
selectedTab
)
;
resolve
(
)
;
}
)
;
}
)
;
}
)
;
}
