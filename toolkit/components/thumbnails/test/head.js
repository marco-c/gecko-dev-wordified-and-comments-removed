var
tmp
=
{
}
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
PageThumbs
.
jsm
"
tmp
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
BackgroundPageThumbs
.
jsm
"
tmp
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
NewTabUtils
.
jsm
"
tmp
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
sessionstore
/
SessionStore
.
jsm
"
tmp
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
FileUtils
.
jsm
"
tmp
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
tmp
)
;
var
{
PageThumbs
BackgroundPageThumbs
NewTabUtils
PageThumbsStorage
SessionStore
FileUtils
OS
}
=
tmp
;
ChromeUtils
.
defineModuleGetter
(
this
"
PlacesTestUtils
"
"
resource
:
/
/
testing
-
common
/
PlacesTestUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
PageThumbsStorageService
"
"
mozilla
.
org
/
thumbnails
/
pagethumbs
-
service
;
1
"
"
nsIPageThumbsStorageService
"
)
;
var
oldEnabledPref
=
Services
.
prefs
.
getBoolPref
(
"
browser
.
pagethumbnails
.
capturing_disabled
"
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
pagethumbnails
.
capturing_disabled
"
false
)
;
registerCleanupFunction
(
function
(
)
{
while
(
gBrowser
.
tabs
.
length
>
1
)
{
gBrowser
.
removeTab
(
gBrowser
.
tabs
[
1
]
)
;
}
Services
.
prefs
.
setBoolPref
(
"
browser
.
pagethumbnails
.
capturing_disabled
"
oldEnabledPref
)
;
}
)
;
function
test
(
)
{
TestRunner
.
run
(
)
;
}
var
TestRunner
=
{
run
(
)
{
waitForExplicitFinish
(
)
;
SessionStore
.
promiseInitialized
.
then
(
(
)
=
>
{
this
.
_iter
=
runTests
(
)
;
if
(
this
.
_iter
)
{
this
.
next
(
)
;
}
else
{
finish
(
)
;
}
}
)
;
}
next
(
aValue
)
{
let
obj
=
TestRunner
.
_iter
.
next
(
aValue
)
;
if
(
obj
.
done
)
{
finish
(
)
;
return
;
}
let
value
=
obj
.
value
|
|
obj
;
if
(
value
&
&
typeof
value
.
then
=
=
"
function
"
)
{
value
.
then
(
result
=
>
{
next
(
result
)
;
}
error
=
>
{
ok
(
false
error
+
"
\
n
"
+
error
.
stack
)
;
}
)
;
}
}
}
;
function
next
(
aValue
)
{
TestRunner
.
next
(
aValue
)
;
}
function
addTab
(
aURI
aCallback
)
{
let
tab
=
(
gBrowser
.
selectedTab
=
BrowserTestUtils
.
addTab
(
gBrowser
aURI
)
)
;
let
callback
=
aCallback
?
aCallback
:
next
;
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
.
then
(
callback
)
;
}
function
navigateTo
(
aURI
)
{
let
browser
=
gBrowser
.
selectedBrowser
;
BrowserTestUtils
.
browserLoaded
(
browser
)
.
then
(
next
)
;
BrowserTestUtils
.
loadURI
(
browser
aURI
)
;
}
function
whenLoaded
(
aElement
aCallback
=
next
)
{
aElement
.
addEventListener
(
"
load
"
function
(
)
{
executeSoon
(
aCallback
)
;
}
{
capture
:
true
once
:
true
}
)
;
}
async
function
captureAndCheckColor
(
aRed
aGreen
aBlue
aMessage
)
{
let
browser
=
gBrowser
.
selectedBrowser
;
dontExpireThumbnailURLs
(
[
browser
.
currentURI
.
spec
]
)
;
await
PageThumbs
.
captureAndStore
(
browser
)
;
retrieveImageDataForURL
(
browser
.
currentURI
.
spec
function
(
[
r
g
b
]
)
{
is
(
"
"
+
[
r
g
b
]
"
"
+
[
aRed
aGreen
aBlue
]
aMessage
)
;
next
(
)
;
}
)
;
}
function
retrieveImageDataForURL
(
aURL
aCallback
)
{
let
width
=
100
height
=
100
;
let
thumb
=
PageThumbs
.
getThumbnailURL
(
aURL
width
height
)
;
let
htmlns
=
"
http
:
/
/
www
.
w3
.
org
/
1999
/
xhtml
"
;
let
img
=
document
.
createElementNS
(
htmlns
"
img
"
)
;
img
.
setAttribute
(
"
src
"
thumb
)
;
whenLoaded
(
img
function
(
)
{
let
canvas
=
document
.
createElementNS
(
htmlns
"
canvas
"
)
;
canvas
.
setAttribute
(
"
width
"
width
)
;
canvas
.
setAttribute
(
"
height
"
height
)
;
let
ctx
=
canvas
.
getContext
(
"
2d
"
)
;
ctx
.
drawImage
(
img
0
0
width
height
)
;
let
result
=
ctx
.
getImageData
(
0
0
100
100
)
.
data
;
aCallback
(
result
)
;
}
)
;
}
function
thumbnailFile
(
aURL
)
{
return
new
FileUtils
.
File
(
PageThumbsStorageService
.
getFilePathForURL
(
aURL
)
)
;
}
function
thumbnailExists
(
aURL
)
{
let
file
=
thumbnailFile
(
aURL
)
;
return
file
.
exists
(
)
&
&
file
.
fileSize
;
}
function
removeThumbnail
(
aURL
)
{
let
file
=
thumbnailFile
(
aURL
)
;
file
.
remove
(
false
)
;
}
function
addVisitsAndRepopulateNewTabLinks
(
aPlaceInfo
aCallback
)
{
PlacesTestUtils
.
addVisits
(
makeURI
(
aPlaceInfo
)
)
.
then
(
(
)
=
>
{
NewTabUtils
.
links
.
populateCache
(
aCallback
true
)
;
}
)
;
}
function
promiseAddVisitsAndRepopulateNewTabLinks
(
aPlaceInfo
)
{
return
new
Promise
(
resolve
=
>
addVisitsAndRepopulateNewTabLinks
(
aPlaceInfo
resolve
)
)
;
}
function
whenFileExists
(
aURL
aCallback
=
next
)
{
let
callback
=
aCallback
;
if
(
!
thumbnailExists
(
aURL
)
)
{
callback
=
(
)
=
>
whenFileExists
(
aURL
aCallback
)
;
}
setTimeout
(
callback
0
)
;
}
function
whenFileRemoved
(
aFile
aCallback
)
{
let
callback
=
aCallback
;
if
(
aFile
.
exists
(
)
)
{
callback
=
(
)
=
>
whenFileRemoved
(
aFile
aCallback
)
;
}
executeSoon
(
callback
|
|
next
)
;
}
function
wait
(
aMillis
)
{
setTimeout
(
next
aMillis
)
;
}
function
dontExpireThumbnailURLs
(
aURLs
)
{
let
dontExpireURLs
=
cb
=
>
cb
(
aURLs
)
;
PageThumbs
.
addExpirationFilter
(
dontExpireURLs
)
;
registerCleanupFunction
(
function
(
)
{
PageThumbs
.
removeExpirationFilter
(
dontExpireURLs
)
;
}
)
;
}
function
bgCapture
(
aURL
aOptions
)
{
bgCaptureWithMethod
(
"
capture
"
aURL
aOptions
)
;
}
function
bgCaptureIfMissing
(
aURL
aOptions
)
{
bgCaptureWithMethod
(
"
captureIfMissing
"
aURL
aOptions
)
;
}
function
bgCaptureWithMethod
(
aMethodName
aURL
aOptions
=
{
}
)
{
dontExpireThumbnailURLs
(
[
aURL
]
)
;
if
(
!
aOptions
.
onDone
)
{
aOptions
.
onDone
=
next
;
}
BackgroundPageThumbs
[
aMethodName
]
(
aURL
aOptions
)
;
}
function
bgTestPageURL
(
aOpts
=
{
}
)
{
let
TEST_PAGE_URL
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
toolkit
/
components
/
thumbnails
/
test
/
thumbnails_background
.
sjs
"
;
return
TEST_PAGE_URL
+
"
?
"
+
encodeURIComponent
(
JSON
.
stringify
(
aOpts
)
)
;
}
function
bgAddPageThumbObserver
(
url
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
function
observe
(
subject
topic
data
)
{
if
(
data
=
=
=
url
)
{
switch
(
topic
)
{
case
"
page
-
thumbnail
:
create
"
:
resolve
(
)
;
break
;
case
"
page
-
thumbnail
:
error
"
:
reject
(
new
Error
(
"
page
-
thumbnail
:
error
"
)
)
;
break
;
}
Services
.
obs
.
removeObserver
(
observe
"
page
-
thumbnail
:
create
"
)
;
Services
.
obs
.
removeObserver
(
observe
"
page
-
thumbnail
:
error
"
)
;
}
}
Services
.
obs
.
addObserver
(
observe
"
page
-
thumbnail
:
create
"
)
;
Services
.
obs
.
addObserver
(
observe
"
page
-
thumbnail
:
error
"
)
;
}
)
;
}
