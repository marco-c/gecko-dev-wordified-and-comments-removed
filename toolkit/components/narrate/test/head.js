"
use
strict
"
;
const
TEST_ARTICLE
=
"
http
:
/
/
example
.
com
/
browser
/
toolkit
/
components
/
narrate
/
test
/
moby_dick
.
html
"
;
Components
.
utils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
Promise
"
"
resource
:
/
/
gre
/
modules
/
Promise
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
Services
"
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
AddonManager
"
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
jsm
"
)
;
const
TEST_PREFS
=
{
"
reader
.
parse
-
on
-
load
.
enabled
"
:
true
"
media
.
webspeech
.
synth
.
enabled
"
:
true
"
media
.
webspeech
.
synth
.
test
"
:
true
"
narrate
.
enabled
"
:
true
"
narrate
.
test
"
:
true
"
narrate
.
voice
"
:
null
}
;
function
setup
(
voiceUri
=
"
automatic
"
)
{
let
prefs
=
Object
.
assign
(
{
}
TEST_PREFS
{
"
narrate
.
voice
"
:
voiceUri
}
)
;
Object
.
entries
(
prefs
)
.
forEach
(
(
[
name
value
]
)
=
>
{
switch
(
typeof
value
)
{
case
"
boolean
"
:
setBoolPref
(
name
value
)
;
break
;
case
"
string
"
:
setCharPref
(
name
value
)
;
break
;
}
}
)
;
}
function
teardown
(
)
{
Object
.
entries
(
TEST_PREFS
)
.
forEach
(
pref
=
>
{
clearUserPref
(
pref
[
0
]
)
;
}
)
;
}
function
spawnInNewReaderTab
(
url
func
)
{
return
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
about
:
reader
?
url
=
{
encodeURIComponent
(
url
)
}
}
function
*
(
browser
)
{
yield
ContentTask
.
spawn
(
browser
null
function
*
(
)
{
Components
.
utils
.
import
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
"
+
"
toolkit
/
components
/
narrate
/
test
/
NarrateTestUtils
.
jsm
"
)
;
yield
NarrateTestUtils
.
getReaderReadyPromise
(
content
)
;
}
)
;
yield
ContentTask
.
spawn
(
browser
null
func
)
;
}
)
;
}
function
setBoolPref
(
name
value
)
{
Services
.
prefs
.
setBoolPref
(
name
value
)
;
}
function
setCharPref
(
name
value
)
{
Services
.
prefs
.
setCharPref
(
name
value
)
;
}
function
clearUserPref
(
name
)
{
Services
.
prefs
.
clearUserPref
(
name
)
;
}
