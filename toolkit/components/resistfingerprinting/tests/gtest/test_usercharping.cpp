#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
gtest
/
nsUserCharacteristics
.
h
"
#
include
"
mozilla
/
glean
/
GleanPings
.
h
"
#
include
"
mozilla
/
glean
/
ResistfingerprintingMetrics
.
h
"
using
namespace
mozilla
;
const
auto
*
const
kUUIDPref
=
"
toolkit
.
telemetry
.
user_characteristics_ping
.
uuid
"
;
TEST
(
ResistFingerprinting
UserCharacteristics_Simple
)
{
mozilla
:
:
glean
:
:
characteristics
:
:
max_touch_points
.
Set
(
7
)
;
ASSERT_TRUE
(
mozilla
:
:
glean_pings
:
:
UserCharacteristics
.
TestSubmission
(
[
]
(
const
nsACString
&
aReason
)
{
ASSERT_EQ
(
7
mozilla
:
:
glean
:
:
characteristics
:
:
max_touch_points
.
TestGetValue
(
)
.
unwrap
(
)
.
ref
(
)
)
;
}
[
]
(
)
{
mozilla
:
:
glean_pings
:
:
UserCharacteristics
.
Submit
(
)
;
}
)
)
;
}
TEST
(
ResistFingerprinting
UserCharacteristics_Complex
)
{
nsUserCharacteristics
:
:
PopulateDataAndEventuallySubmit
(
false
true
)
;
ASSERT_TRUE
(
mozilla
:
:
glean_pings
:
:
UserCharacteristics
.
TestSubmission
(
[
]
(
const
nsACString
&
aReason
)
{
ASSERT_STRNE
(
"
"
mozilla
:
:
glean
:
:
characteristics
:
:
client_identifier
.
TestGetValue
(
)
.
unwrap
(
)
.
value
(
)
.
get
(
)
)
;
nsCString
fullUuidStr
;
Preferences
:
:
GetCString
(
kUUIDPref
fullUuidStr
)
;
nsAutoCString
uuidString
;
uuidString
=
Substring
(
fullUuidStr
1
NSID_LENGTH
-
3
)
;
ASSERT_STREQ
(
uuidString
.
get
(
)
mozilla
:
:
glean
:
:
characteristics
:
:
client_identifier
.
TestGetValue
(
)
.
unwrap
(
)
.
value
(
)
.
get
(
)
)
;
ASSERT_EQ
(
testing
:
:
MaxTouchPoints
(
)
mozilla
:
:
glean
:
:
characteristics
:
:
max_touch_points
.
TestGetValue
(
)
.
unwrap
(
)
.
ref
(
)
)
;
}
[
]
(
)
{
nsUserCharacteristics
:
:
SubmitPing
(
)
;
}
)
)
;
}
TEST
(
ResistFingerprinting
UserCharacteristics_ClearPref
)
{
nsCString
originalUUID
;
ASSERT_TRUE
(
mozilla
:
:
glean_pings
:
:
UserCharacteristics
.
TestSubmission
(
[
&
originalUUID
]
(
const
nsACString
&
aReason
)
{
originalUUID
=
mozilla
:
:
glean
:
:
characteristics
:
:
client_identifier
.
TestGetValue
(
)
.
unwrap
(
)
.
value
(
)
.
get
(
)
;
ASSERT_STRNE
(
"
"
mozilla
:
:
glean
:
:
characteristics
:
:
client_identifier
.
TestGetValue
(
)
.
unwrap
(
)
.
value
(
)
.
get
(
)
)
;
nsCString
fullUuidStr
;
Preferences
:
:
GetCString
(
kUUIDPref
fullUuidStr
)
;
nsAutoCString
uuidString
;
uuidString
=
Substring
(
fullUuidStr
1
NSID_LENGTH
-
3
)
;
ASSERT_STREQ
(
uuidString
.
get
(
)
mozilla
:
:
glean
:
:
characteristics
:
:
client_identifier
.
TestGetValue
(
)
.
unwrap
(
)
.
value
(
)
.
get
(
)
)
;
}
[
]
(
)
{
nsUserCharacteristics
:
:
PopulateDataAndEventuallySubmit
(
false
true
)
;
nsUserCharacteristics
:
:
SubmitPing
(
)
;
}
)
)
;
auto
original_value
=
Preferences
:
:
GetBool
(
"
datareporting
.
healthreport
.
uploadEnabled
"
)
;
Preferences
:
:
SetBool
(
"
datareporting
.
healthreport
.
uploadEnabled
"
true
)
;
Preferences
:
:
SetBool
(
"
datareporting
.
healthreport
.
uploadEnabled
"
false
)
;
ASSERT_TRUE
(
mozilla
:
:
glean_pings
:
:
UserCharacteristics
.
TestSubmission
(
[
]
(
const
nsACString
&
aReason
)
{
nsAutoCString
uuidValue
;
Preferences
:
:
GetCString
(
kUUIDPref
uuidValue
)
;
ASSERT_STREQ
(
"
"
uuidValue
.
get
(
)
)
;
}
[
]
(
)
{
nsUserCharacteristics
:
:
SubmitPing
(
)
;
}
)
)
;
Preferences
:
:
SetBool
(
"
datareporting
.
healthreport
.
uploadEnabled
"
true
)
;
ASSERT_TRUE
(
mozilla
:
:
glean_pings
:
:
UserCharacteristics
.
TestSubmission
(
[
&
originalUUID
]
(
const
nsACString
&
aReason
)
{
ASSERT_STRNE
(
originalUUID
.
get
(
)
mozilla
:
:
glean
:
:
characteristics
:
:
client_identifier
.
TestGetValue
(
)
.
unwrap
(
)
.
value
(
)
.
get
(
)
)
;
nsAutoCString
uuidValue
;
Preferences
:
:
GetCString
(
kUUIDPref
uuidValue
)
;
ASSERT_STRNE
(
"
"
uuidValue
.
get
(
)
)
;
}
[
]
(
)
{
nsUserCharacteristics
:
:
PopulateDataAndEventuallySubmit
(
false
true
)
;
nsUserCharacteristics
:
:
SubmitPing
(
)
;
}
)
)
;
Preferences
:
:
SetBool
(
"
datareporting
.
healthreport
.
uploadEnabled
"
original_value
)
;
}
const
auto
*
const
kLastVersionPref
=
"
toolkit
.
telemetry
.
user_characteristics_ping
.
last_version_sent
"
;
const
auto
*
const
kCurrentVersionPref
=
"
toolkit
.
telemetry
.
user_characteristics_ping
.
current_version
"
;
const
auto
*
const
kOptOutPref
=
"
toolkit
.
telemetry
.
user_characteristics_ping
.
opt
-
out
"
;
const
auto
*
const
kSendOncePref
=
"
toolkit
.
telemetry
.
user_characteristics_ping
.
send
-
once
"
;
const
auto
*
const
kResistFingerprintingPref
=
"
privacy
.
resistFingerprinting
"
;
const
auto
*
const
kResistFingerprintingPrefPBMode
=
"
privacy
.
resistFingerprinting
.
pbmode
"
;
const
auto
*
const
kFingerprintingProtectionOverrides
=
"
privacy
.
fingerprintingProtection
.
overrides
"
;
const
auto
*
const
kBaselineFPPOverridesPref
=
"
privacy
.
baselineFingerprintingProtection
.
overrides
"
;
TEST
(
ResistFingerprinting
UserCharacteristics_ShouldSubmit
)
{
Preferences
:
:
SetInt
(
kCurrentVersionPref
1
)
;
Preferences
:
:
SetInt
(
kLastVersionPref
0
)
;
ASSERT_TRUE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetBool
(
kOptOutPref
true
)
;
ASSERT_FALSE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetBool
(
kOptOutPref
false
)
;
ASSERT_TRUE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetInt
(
kCurrentVersionPref
0
)
;
ASSERT_FALSE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetBool
(
kSendOncePref
true
)
;
ASSERT_TRUE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetInt
(
kCurrentVersionPref
1
)
;
Preferences
:
:
SetBool
(
kOptOutPref
true
)
;
ASSERT_FALSE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetBool
(
kOptOutPref
false
)
;
Preferences
:
:
SetBool
(
kResistFingerprintingPref
true
)
;
ASSERT_FALSE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetBool
(
kResistFingerprintingPref
false
)
;
Preferences
:
:
SetBool
(
kResistFingerprintingPrefPBMode
true
)
;
ASSERT_FALSE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetBool
(
kResistFingerprintingPrefPBMode
false
)
;
Preferences
:
:
SetCString
(
kFingerprintingProtectionOverrides
"
test
"
)
;
ASSERT_FALSE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
ClearUser
(
kFingerprintingProtectionOverrides
)
;
ASSERT_TRUE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
SetCString
(
kBaselineFPPOverridesPref
"
test
"
)
;
ASSERT_FALSE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
Preferences
:
:
ClearUser
(
kBaselineFPPOverridesPref
)
;
ASSERT_TRUE
(
nsUserCharacteristics
:
:
ShouldSubmit
(
)
)
;
}
