runTestInFirstAndThirdPartyContexts
(
"
ServiceWorkers
-
Ensure
the
fingerprinting
WebCompat
overrides
the
fingerprinting
protection
in
third
-
party
context
.
"
async
win
=
>
{
let
SPOOFED_HW_CONCURRENCY
=
4
;
if
(
!
win
.
sw
)
{
win
.
sw
=
await
registerServiceWorker
(
win
"
serviceWorker
.
js
"
)
;
}
let
res
=
await
sendAndWaitWorkerMessage
(
win
.
sw
win
.
navigator
.
serviceWorker
{
type
:
"
GetHWConcurrency
"
}
)
;
is
(
res
.
value
SPOOFED_HW_CONCURRENCY
"
HW
Concurrency
should
be
spoofed
in
the
first
-
party
context
"
)
;
}
async
win
=
>
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
fingerprintingProtection
"
false
]
]
}
)
;
var
DEFAULT_HARDWARE_CONCURRENCY
=
navigator
.
hardwareConcurrency
;
await
SpecialPowers
.
popPrefEnv
(
)
;
if
(
!
win
.
sw
)
{
win
.
sw
=
await
registerServiceWorker
(
win
"
serviceWorker
.
js
"
)
;
}
let
res
=
await
sendAndWaitWorkerMessage
(
win
.
sw
win
.
navigator
.
serviceWorker
{
type
:
"
GetHWConcurrency
"
}
)
;
is
(
res
.
value
DEFAULT_HARDWARE_CONCURRENCY
"
HW
Concurrency
should
not
be
spoofed
in
the
third
-
party
context
"
)
;
}
async
_
=
>
{
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
(
)
=
>
resolve
(
)
)
;
}
)
;
}
[
[
"
dom
.
serviceWorkers
.
exemptFromPerDomainMax
"
true
]
[
"
dom
.
ipc
.
processCount
"
1
]
[
"
dom
.
serviceWorkers
.
enabled
"
true
]
[
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
]
[
"
privacy
.
fingerprintingProtection
"
true
]
[
"
privacy
.
fingerprintingProtection
.
overrides
"
"
+
NavigatorHWConcurrency
"
]
[
"
privacy
.
fingerprintingProtection
.
granularOverrides
"
JSON
.
stringify
(
[
{
id
:
"
1
"
last_modified
:
1000000000000001
overrides
:
"
-
NavigatorHWConcurrency
"
firstPartyDomain
:
"
example
.
net
"
thirdPartyDomain
:
"
example
.
com
"
}
]
)
]
]
)
;
runTestInFirstAndThirdPartyContexts
(
"
ServiceWorkers
-
Ensure
the
fingerprinting
WebCompat
overrides
the
fingerprinting
protection
in
third
-
party
context
with
FPI
enabled
.
"
async
win
=
>
{
let
SPOOFED_HW_CONCURRENCY
=
4
;
if
(
!
win
.
sw
)
{
win
.
sw
=
await
registerServiceWorker
(
win
"
serviceWorker
.
js
"
)
;
}
let
res
=
await
sendAndWaitWorkerMessage
(
win
.
sw
win
.
navigator
.
serviceWorker
{
type
:
"
GetHWConcurrency
"
}
)
;
is
(
res
.
value
SPOOFED_HW_CONCURRENCY
"
HW
Concurrency
should
be
spoofed
in
the
first
-
party
context
"
)
;
}
async
win
=
>
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
fingerprintingProtection
"
false
]
]
}
)
;
var
DEFAULT_HARDWARE_CONCURRENCY
=
navigator
.
hardwareConcurrency
;
await
SpecialPowers
.
popPrefEnv
(
)
;
if
(
!
win
.
sw
)
{
win
.
sw
=
await
registerServiceWorker
(
win
"
serviceWorker
.
js
"
)
;
}
let
res
=
await
sendAndWaitWorkerMessage
(
win
.
sw
win
.
navigator
.
serviceWorker
{
type
:
"
GetHWConcurrency
"
}
)
;
is
(
res
.
value
DEFAULT_HARDWARE_CONCURRENCY
"
HW
Concurrency
should
not
be
spoofed
in
the
third
-
party
context
"
)
;
}
async
_
=
>
{
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
(
)
=
>
resolve
(
)
)
;
}
)
;
}
[
[
"
dom
.
serviceWorkers
.
exemptFromPerDomainMax
"
true
]
[
"
dom
.
ipc
.
processCount
"
1
]
[
"
dom
.
serviceWorkers
.
enabled
"
true
]
[
"
dom
.
serviceWorkers
.
testing
.
enabled
"
true
]
[
"
privacy
.
firstparty
.
isolate
"
true
]
[
"
privacy
.
fingerprintingProtection
"
true
]
[
"
privacy
.
fingerprintingProtection
.
overrides
"
"
+
NavigatorHWConcurrency
"
]
[
"
privacy
.
fingerprintingProtection
.
granularOverrides
"
JSON
.
stringify
(
[
{
id
:
"
1
"
last_modified
:
1000000000000001
overrides
:
"
-
NavigatorHWConcurrency
"
firstPartyDomain
:
"
example
.
net
"
thirdPartyDomain
:
"
example
.
com
"
}
]
)
]
]
)
;
