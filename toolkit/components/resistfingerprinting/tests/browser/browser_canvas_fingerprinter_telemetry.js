"
use
strict
"
;
const
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
com
"
)
;
const
TEST_PAGE_NORMAL
=
TEST_PATH
+
"
empty
.
html
"
;
const
TEST_PAGE_FINGERPRINTER
=
TEST_PATH
+
"
canvas
-
fingerprinter
.
html
"
;
const
TELEMETRY_CANVAS_FINGERPRINTING_PER_TAB
=
"
CANVAS_FINGERPRINTING_PER_TAB
"
;
const
KEY_UNKNOWN
=
"
unknown
"
;
const
KEY_KNOWN_TEXT
=
"
known_text
"
;
async
function
clearTelemetry
(
)
{
Services
.
telemetry
.
getSnapshotForHistograms
(
"
main
"
true
)
;
Services
.
telemetry
.
getKeyedHistogramById
(
TELEMETRY_CANVAS_FINGERPRINTING_PER_TAB
)
.
clear
(
)
;
}
async
function
getKeyedHistogram
(
histogram_id
key
bucket
checkCntFn
)
{
let
histogram
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
let
histograms
=
Services
.
telemetry
.
getSnapshotForKeyedHistograms
(
"
main
"
false
)
.
parent
;
histogram
=
histograms
[
histogram_id
]
;
let
checkRes
=
false
;
if
(
histogram
&
&
histogram
[
key
]
)
{
checkRes
=
checkCntFn
?
checkCntFn
(
histogram
[
key
]
.
values
[
bucket
]
)
:
true
;
}
return
checkRes
;
}
)
;
return
histogram
[
key
]
.
values
[
bucket
]
|
|
0
;
}
async
function
checkKeyedHistogram
(
histogram_id
key
bucket
expectedCnt
)
{
let
cnt
=
await
getKeyedHistogram
(
histogram_id
key
bucket
cnt
=
>
{
if
(
cnt
=
=
=
undefined
)
{
cnt
=
0
;
}
return
cnt
=
=
expectedCnt
;
}
)
;
is
(
cnt
expectedCnt
"
There
should
be
expected
count
in
keyed
telemetry
.
"
)
;
}
add_setup
(
async
function
(
)
{
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
test_canvas_fingerprinting_telemetry
(
)
{
let
promiseWindowDestroyed
=
BrowserUtils
.
promiseObserved
(
"
window
-
global
-
destroyed
"
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_PAGE_NORMAL
async
_
=
>
{
}
)
;
await
promiseWindowDestroyed
;
await
checkKeyedHistogram
(
TELEMETRY_CANVAS_FINGERPRINTING_PER_TAB
KEY_UNKNOWN
0
1
)
;
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
test_canvas_fingerprinting_telemetry
(
)
{
let
promiseWindowDestroyed
=
BrowserUtils
.
promiseObserved
(
"
window
-
global
-
destroyed
"
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_PAGE_FINGERPRINTER
async
_
=
>
{
}
)
;
await
promiseWindowDestroyed
;
await
checkKeyedHistogram
(
TELEMETRY_CANVAS_FINGERPRINTING_PER_TAB
KEY_KNOWN_TEXT
6
1
)
;
await
clearTelemetry
(
)
;
}
)
;
