"
use
strict
"
;
const
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
com
"
)
;
const
TEST_PAGE_NORMAL
=
TEST_PATH
+
"
empty
.
html
"
;
const
TEST_PAGE_FINGERPRINTER
=
TEST_PATH
+
"
canvas
-
fingerprinter
.
html
"
;
const
GLEAN_METRIC
=
"
canvas_fingerprinting_per_tab2
"
;
const
KEY_UNKNOWN
=
"
not_found
"
;
const
KEY_KNOWN_TEXT
=
"
found
"
;
async
function
clearTelemetry
(
)
{
Services
.
fog
.
testResetFOG
(
)
;
}
async
function
getLabeledCounter
(
metricName
label
checkCntFn
)
{
let
value
=
0
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
value
=
Glean
.
contentblocking
.
canvasFingerprintingPerTab2
[
label
]
.
testGetValue
(
)
;
return
checkCntFn
?
checkCntFn
(
value
)
:
value
>
0
;
}
)
;
return
value
;
}
async
function
checkLabeledCounter
(
metricName
label
expectedCnt
)
{
let
cnt
=
await
getLabeledCounter
(
metricName
label
v
=
>
{
return
(
v
?
?
0
)
=
=
expectedCnt
;
}
)
;
is
(
cnt
expectedCnt
"
Expected
count
in
Glean
labeled
counter
.
"
)
;
}
add_setup
(
async
function
(
)
{
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
test_canvas_fingerprinting_telemetry
(
)
{
let
promiseWindowDestroyed
=
BrowserUtils
.
promiseObserved
(
"
window
-
global
-
destroyed
"
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_PAGE_NORMAL
async
_
=
>
{
}
)
;
await
promiseWindowDestroyed
;
await
checkLabeledCounter
(
GLEAN_METRIC
KEY_UNKNOWN
1
)
;
await
clearTelemetry
(
)
;
}
)
;
add_task
(
async
function
test_canvas_fingerprinting_telemetry
(
)
{
let
promiseWindowDestroyed
=
BrowserUtils
.
promiseObserved
(
"
window
-
global
-
destroyed
"
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_PAGE_FINGERPRINTER
async
_
=
>
{
}
)
;
await
promiseWindowDestroyed
;
await
checkLabeledCounter
(
GLEAN_METRIC
KEY_KNOWN_TEXT
1
)
;
await
clearTelemetry
(
)
;
}
)
;
