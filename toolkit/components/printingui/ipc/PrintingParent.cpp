#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
mozilla
/
dom
/
BrowserParent
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsIPrintingPromptService
.
h
"
#
include
"
nsIPrintSettingsService
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
PrintingParent
.
h
"
#
include
"
PrintSettingsDialogParent
.
h
"
#
include
"
mozilla
/
layout
/
RemotePrintJobParent
.
h
"
#
include
"
mozilla
/
StaticPrefs_print
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
using
namespace
mozilla
:
:
layout
;
namespace
mozilla
{
namespace
embedding
{
nsresult
PrintingParent
:
:
ShowPrintDialog
(
PBrowserParent
*
aParent
const
PrintData
&
aData
PrintData
*
aResult
)
{
bool
isPrintPreview
=
!
aParent
;
nsCOMPtr
<
nsPIDOMWindowOuter
>
parentWin
;
if
(
aParent
)
{
parentWin
=
DOMWindowFromBrowserParent
(
aParent
)
;
if
(
!
parentWin
)
{
return
NS_ERROR_FAILURE
;
}
}
nsCOMPtr
<
nsIPrintingPromptService
>
pps
(
do_GetService
(
"
mozilla
.
org
/
embedcomp
/
printingprompt
-
service
;
1
"
)
)
;
if
(
!
pps
)
{
return
NS_ERROR_FAILURE
;
}
RemotePrintJobParent
*
remotePrintJob
=
static_cast
<
RemotePrintJobParent
*
>
(
aData
.
remotePrintJobParent
(
)
)
;
nsCOMPtr
<
nsIPrintSettings
>
settings
;
nsresult
rv
;
if
(
remotePrintJob
)
{
settings
=
remotePrintJob
-
>
GetPrintSettings
(
)
;
}
else
{
rv
=
mPrintSettingsSvc
-
>
GetNewPrintSettings
(
getter_AddRefs
(
settings
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
bool
printSilently
;
rv
=
settings
-
>
GetPrintSilent
(
&
printSilently
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
rv
=
mPrintSettingsSvc
-
>
DeserializeToPrintSettings
(
aData
settings
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
rv
=
settings
-
>
SetPrintSilent
(
printSilently
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsString
printerName
;
settings
-
>
GetPrinterName
(
printerName
)
;
#
ifdef
MOZ_X11
bool
printToFile
=
false
;
MOZ_ALWAYS_SUCCEEDS
(
settings
-
>
GetPrintToFile
(
&
printToFile
)
)
;
if
(
!
printToFile
&
&
printerName
.
IsEmpty
(
)
)
{
mPrintSettingsSvc
-
>
GetLastUsedPrinterName
(
printerName
)
;
settings
-
>
SetPrinterName
(
printerName
)
;
}
mPrintSettingsSvc
-
>
InitPrintSettingsFromPrinter
(
printerName
settings
)
;
#
endif
if
(
isPrintPreview
|
|
printSilently
|
|
StaticPrefs
:
:
print_always_print_silent
(
)
)
{
settings
-
>
SetIsInitializedFromPrinter
(
false
)
;
mPrintSettingsSvc
-
>
InitPrintSettingsFromPrinter
(
printerName
settings
)
;
}
else
{
rv
=
pps
-
>
ShowPrintDialog
(
parentWin
settings
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
if
(
isPrintPreview
)
{
rv
=
mPrintSettingsSvc
-
>
SerializeToPrintData
(
settings
aResult
)
;
}
else
{
rv
=
SerializeAndEnsureRemotePrintJob
(
settings
nullptr
remotePrintJob
aResult
)
;
}
return
rv
;
}
mozilla
:
:
ipc
:
:
IPCResult
PrintingParent
:
:
RecvShowPrintDialog
(
PPrintSettingsDialogParent
*
aDialog
PBrowserParent
*
aParent
const
PrintData
&
aData
)
{
PrintData
resultData
;
nsresult
rv
=
ShowPrintDialog
(
aParent
aData
&
resultData
)
;
if
(
NS_FAILED
(
rv
)
)
{
mozilla
:
:
Unused
<
<
PPrintingParent
:
:
PPrintSettingsDialogParent
:
:
Send__delete__
(
aDialog
rv
)
;
}
else
{
mozilla
:
:
Unused
<
<
PPrintingParent
:
:
PPrintSettingsDialogParent
:
:
Send__delete__
(
aDialog
resultData
)
;
}
return
IPC_OK
(
)
;
}
PPrintSettingsDialogParent
*
PrintingParent
:
:
AllocPPrintSettingsDialogParent
(
)
{
return
new
PrintSettingsDialogParent
(
)
;
}
bool
PrintingParent
:
:
DeallocPPrintSettingsDialogParent
(
PPrintSettingsDialogParent
*
aDoomed
)
{
delete
aDoomed
;
return
true
;
}
void
PrintingParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
}
nsPIDOMWindowOuter
*
PrintingParent
:
:
DOMWindowFromBrowserParent
(
PBrowserParent
*
parent
)
{
if
(
!
parent
)
{
return
nullptr
;
}
BrowserParent
*
browserParent
=
BrowserParent
:
:
GetFrom
(
parent
)
;
if
(
!
browserParent
)
{
return
nullptr
;
}
nsCOMPtr
<
Element
>
frameElement
=
browserParent
-
>
GetOwnerElement
(
)
;
if
(
!
frameElement
)
{
return
nullptr
;
}
nsCOMPtr
<
nsIContent
>
frame
(
frameElement
)
;
if
(
!
frame
)
{
return
nullptr
;
}
nsCOMPtr
<
nsPIDOMWindowOuter
>
parentWin
=
frame
-
>
OwnerDoc
(
)
-
>
GetWindow
(
)
;
if
(
!
parentWin
)
{
return
nullptr
;
}
return
parentWin
;
}
nsresult
PrintingParent
:
:
SerializeAndEnsureRemotePrintJob
(
nsIPrintSettings
*
aPrintSettings
nsIWebProgressListener
*
aListener
layout
:
:
RemotePrintJobParent
*
aRemotePrintJob
PrintData
*
aPrintData
)
{
MOZ_ASSERT
(
aPrintData
)
;
nsresult
rv
;
nsCOMPtr
<
nsIPrintSettings
>
printSettings
;
if
(
aPrintSettings
)
{
printSettings
=
aPrintSettings
;
}
else
{
rv
=
mPrintSettingsSvc
-
>
GetNewPrintSettings
(
getter_AddRefs
(
printSettings
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
}
rv
=
mPrintSettingsSvc
-
>
SerializeToPrintData
(
printSettings
aPrintData
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
RemotePrintJobParent
*
remotePrintJob
;
if
(
aRemotePrintJob
)
{
remotePrintJob
=
aRemotePrintJob
;
aPrintData
-
>
remotePrintJobParent
(
)
=
remotePrintJob
;
}
else
{
remotePrintJob
=
new
RemotePrintJobParent
(
aPrintSettings
)
;
aPrintData
-
>
remotePrintJobParent
(
)
=
SendPRemotePrintJobConstructor
(
remotePrintJob
)
;
}
if
(
aListener
)
{
remotePrintJob
-
>
RegisterListener
(
aListener
)
;
}
return
NS_OK
;
}
PrintingParent
:
:
PrintingParent
(
)
{
mPrintSettingsSvc
=
do_GetService
(
"
mozilla
.
org
/
gfx
/
printsettings
-
service
;
1
"
)
;
MOZ_ASSERT
(
mPrintSettingsSvc
)
;
}
PrintingParent
:
:
~
PrintingParent
(
)
=
default
;
}
}
