"
use
strict
"
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
OS
"
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
setTimeout
"
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
Services
"
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
function
nsTerminatorTelemetry
(
)
{
}
var
HISTOGRAMS
=
{
"
quit
-
application
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_QUIT_APPLICATION
"
"
profile
-
change
-
teardown
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_PROFILE_CHANGE_TEARDOWN
"
"
profile
-
before
-
change
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_PROFILE_BEFORE_CHANGE
"
"
xpcom
-
will
-
shutdown
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_XPCOM_WILL_SHUTDOWN
"
}
;
nsTerminatorTelemetry
.
prototype
=
{
classID
:
Components
.
ID
(
"
{
3f78ada1
-
cba2
-
442a
-
82dd
-
d5fb300ddea7
}
"
)
_xpcom_factory
:
XPCOMUtils
.
generateSingletonFactory
(
nsTerminatorTelemetry
)
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIObserver
]
)
observe
:
function
DS_observe
(
aSubject
aTopic
aData
)
{
(
async
function
(
)
{
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
3000
)
)
;
let
PATH
=
OS
.
Path
.
join
(
OS
.
Constants
.
Path
.
localProfileDir
"
ShutdownDuration
.
json
"
)
;
let
raw
;
try
{
raw
=
await
OS
.
File
.
read
(
PATH
{
encoding
:
"
utf
-
8
"
}
)
;
}
catch
(
ex
)
{
if
(
!
ex
.
becauseNoSuchFile
)
{
throw
ex
;
}
return
;
}
OS
.
File
.
remove
(
PATH
)
;
OS
.
File
.
remove
(
PATH
+
"
.
tmp
"
)
;
let
data
=
JSON
.
parse
(
raw
)
;
for
(
let
k
of
Object
.
keys
(
data
)
)
{
let
id
=
HISTOGRAMS
[
k
]
;
try
{
let
histogram
=
Services
.
telemetry
.
getHistogramById
(
id
)
;
if
(
!
histogram
)
{
throw
new
Error
(
"
Unknown
histogram
"
+
id
)
;
}
histogram
.
add
(
Number
.
parseInt
(
data
[
k
]
)
)
;
}
catch
(
ex
)
{
Promise
.
reject
(
ex
)
;
continue
;
}
}
Services
.
obs
.
notifyObservers
(
null
"
shutdown
-
terminator
-
telemetry
-
updated
"
)
;
}
)
(
)
;
}
}
;
this
.
NSGetFactory
=
XPCOMUtils
.
generateNSGetFactory
(
[
nsTerminatorTelemetry
]
)
;
