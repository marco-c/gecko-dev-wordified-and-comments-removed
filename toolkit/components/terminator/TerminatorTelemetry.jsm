"
use
strict
"
;
const
lazy
=
{
}
;
ChromeUtils
.
defineESModuleGetters
(
lazy
{
PromiseUtils
:
"
resource
:
/
/
gre
/
modules
/
PromiseUtils
.
sys
.
mjs
"
setTimeout
:
"
resource
:
/
/
gre
/
modules
/
Timer
.
sys
.
mjs
"
}
)
;
function
nsTerminatorTelemetry
(
)
{
this
.
_wasNotified
=
false
;
this
.
_deferred
=
lazy
.
PromiseUtils
.
defer
(
)
;
IOUtils
.
sendTelemetry
.
addBlocker
(
"
TerminatoryTelemetry
:
Waiting
to
submit
telemetry
"
this
.
_deferred
.
promise
(
)
=
>
(
{
wasNotified
:
this
.
_wasNotified
}
)
)
;
}
var
HISTOGRAMS
=
{
"
quit
-
application
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_QUIT_APPLICATION
"
"
profile
-
change
-
net
-
teardown
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_PROFILE_CHANGE_NET_TEARDOWN
"
"
profile
-
change
-
teardown
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_PROFILE_CHANGE_TEARDOWN
"
"
profile
-
before
-
change
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_PROFILE_BEFORE_CHANGE
"
"
profile
-
before
-
change
-
qm
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_PROFILE_BEFORE_CHANGE_QM
"
"
xpcom
-
will
-
shutdown
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_XPCOM_WILL_SHUTDOWN
"
"
xpcom
-
shutdown
"
:
"
SHUTDOWN_PHASE_DURATION_TICKS_XPCOM_SHUTDOWN
"
"
xpcom
-
shutdown
-
threads
"
:
null
XPCOMShutdownFinal
:
null
CCPostLastCycleCollection
:
null
}
;
nsTerminatorTelemetry
.
prototype
=
{
classID
:
Components
.
ID
(
"
{
3f78ada1
-
cba2
-
442a
-
82dd
-
d5fb300ddea7
}
"
)
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIObserver
"
]
)
observe
:
function
DS_observe
(
aSubject
aTopic
aData
)
{
this
.
_wasNotified
=
true
;
(
async
(
)
=
>
{
try
{
await
new
Promise
(
resolve
=
>
lazy
.
setTimeout
(
resolve
3000
)
)
;
let
PATH
=
PathUtils
.
join
(
Services
.
dirsvc
.
get
(
"
ProfLD
"
Ci
.
nsIFile
)
.
path
"
ShutdownDuration
.
json
"
)
;
let
data
;
try
{
data
=
await
IOUtils
.
readJSON
(
PATH
)
;
}
catch
(
ex
)
{
if
(
DOMException
.
isInstance
(
ex
)
&
&
ex
.
name
=
=
"
NotFoundError
"
)
{
return
;
}
throw
ex
;
}
await
IOUtils
.
remove
(
PATH
)
;
await
IOUtils
.
remove
(
PATH
+
"
.
tmp
"
)
;
for
(
let
k
of
Object
.
keys
(
data
)
)
{
let
id
=
HISTOGRAMS
[
k
]
;
if
(
id
=
=
=
null
)
{
continue
;
}
try
{
let
histogram
=
Services
.
telemetry
.
getHistogramById
(
id
)
;
histogram
.
add
(
Number
.
parseInt
(
data
[
k
]
)
)
;
}
catch
(
ex
)
{
Promise
.
reject
(
ex
)
;
continue
;
}
}
Services
.
obs
.
notifyObservers
(
null
"
shutdown
-
terminator
-
telemetry
-
updated
"
)
;
}
finally
{
this
.
_deferred
.
resolve
(
)
;
}
}
)
(
)
;
}
}
;
var
EXPORTED_SYMBOLS
=
[
"
nsTerminatorTelemetry
"
]
;
