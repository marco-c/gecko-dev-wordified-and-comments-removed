#
ifndef
mozilla_CookieBannerDomainPrefService_h__
#
define
mozilla_CookieBannerDomainPrefService_h__
#
include
"
nsIContentPrefService2
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsTHashMap
.
h
"
#
include
"
nsTHashSet
.
h
"
#
include
"
nsICookieBannerService
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsIAsyncShutdown
.
h
"
namespace
mozilla
{
class
CookieBannerDomainPrefService
final
:
public
nsIAsyncShutdownBlocker
public
nsIObserver
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIASYNCSHUTDOWNBLOCKER
NS_DECL_NSIOBSERVER
static
already_AddRefed
<
CookieBannerDomainPrefService
>
GetOrCreate
(
)
;
Maybe
<
nsICookieBannerService
:
:
Modes
>
GetPref
(
const
nsACString
&
aDomain
bool
aIsPrivate
)
;
[
[
nodiscard
]
]
nsresult
SetPref
(
const
nsACString
&
aDomain
nsICookieBannerService
:
:
Modes
aMode
bool
aIsPrivate
bool
aPersistInPrivateBrowsing
)
;
[
[
nodiscard
]
]
nsresult
RemovePref
(
const
nsACString
&
aDomain
bool
aIsPrivate
)
;
[
[
nodiscard
]
]
nsresult
RemoveAll
(
bool
aIsPrivate
)
;
void
Init
(
)
;
private
:
~
CookieBannerDomainPrefService
(
)
=
default
;
CookieBannerDomainPrefService
(
)
:
mIsInitialized
(
false
)
mIsContentPrefLoaded
(
false
)
mIsPrivateContentPrefLoaded
(
false
)
mIsShuttingDown
(
false
)
{
}
bool
mIsInitialized
;
bool
mIsContentPrefLoaded
;
bool
mIsPrivateContentPrefLoaded
;
bool
mIsShuttingDown
;
class
DomainPrefData
final
:
public
nsISupports
{
public
:
NS_DECL_ISUPPORTS
explicit
DomainPrefData
(
nsICookieBannerService
:
:
Modes
aMode
bool
aIsPersistent
)
:
mMode
(
aMode
)
mIsPersistent
(
aIsPersistent
)
{
}
private
:
~
DomainPrefData
(
)
=
default
;
friend
class
CookieBannerDomainPrefService
;
nsICookieBannerService
:
:
Modes
mMode
;
bool
mIsPersistent
;
}
;
nsTHashMap
<
nsCStringHashKey
RefPtr
<
DomainPrefData
>
>
mPrefs
;
nsTHashMap
<
nsCStringHashKey
RefPtr
<
DomainPrefData
>
>
mPrefsPrivate
;
void
EnsureInitCompleted
(
bool
aIsPrivate
)
;
nsresult
AddShutdownBlocker
(
)
;
nsresult
RemoveShutdownBlocker
(
)
;
nsresult
RemoveContentPrefForDomain
(
const
nsACString
&
aDomain
bool
aIsPrivate
)
;
class
BaseContentPrefCallback
:
public
nsIContentPrefCallback2
{
public
:
NS_DECL_ISUPPORTS
NS_IMETHOD
HandleResult
(
nsIContentPref
*
)
override
=
0
;
NS_IMETHOD
HandleCompletion
(
uint16_t
)
override
=
0
;
NS_IMETHOD
HandleError
(
nsresult
)
override
=
0
;
explicit
BaseContentPrefCallback
(
CookieBannerDomainPrefService
*
aService
)
:
mService
(
aService
)
{
}
protected
:
virtual
~
BaseContentPrefCallback
(
)
=
default
;
RefPtr
<
CookieBannerDomainPrefService
>
mService
;
}
;
class
InitialLoadContentPrefCallback
final
:
public
BaseContentPrefCallback
{
public
:
NS_DECL_NSICONTENTPREFCALLBACK2
explicit
InitialLoadContentPrefCallback
(
CookieBannerDomainPrefService
*
aService
bool
aIsPrivate
)
:
BaseContentPrefCallback
(
aService
)
mIsPrivate
(
aIsPrivate
)
{
}
private
:
bool
mIsPrivate
;
}
;
class
WriteContentPrefCallback
final
:
public
BaseContentPrefCallback
{
public
:
NS_DECL_NSICONTENTPREFCALLBACK2
explicit
WriteContentPrefCallback
(
CookieBannerDomainPrefService
*
aService
)
:
BaseContentPrefCallback
(
aService
)
{
}
}
;
uint32_t
mWritingCount
=
0
;
void
Shutdown
(
)
;
}
;
}
#
endif
