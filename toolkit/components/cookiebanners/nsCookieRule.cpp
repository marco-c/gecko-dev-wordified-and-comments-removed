#
include
"
nsCookieRule
.
h
"
#
include
"
mozilla
/
OriginAttributes
.
h
"
#
include
"
nsICookie
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
Cookie
.
h
"
#
include
"
prtime
.
h
"
#
include
"
mozilla
/
StaticPrefs_cookiebanners
.
h
"
namespace
mozilla
{
NS_IMPL_ISUPPORTS
(
nsCookieRule
nsICookieRule
)
nsCookieRule
:
:
nsCookieRule
(
bool
aIsOptOut
const
nsACString
&
aHost
const
nsACString
&
aName
const
nsACString
&
aValue
const
nsACString
&
aPath
int64_t
aExpiryRelative
const
nsACString
&
aUnsetValue
bool
aIsSecure
bool
aIsHttpOnly
bool
aIsSession
int32_t
aSameSite
nsICookie
:
:
schemeType
aSchemeMap
)
{
if
(
aExpiryRelative
<
=
0
)
{
aExpiryRelative
=
StaticPrefs
:
:
cookiebanners_cookieInjector_defaultExpiryRelative
(
)
;
}
mExpiryRelative
=
aExpiryRelative
;
nsCString
path
(
aPath
)
;
if
(
path
.
IsEmpty
(
)
)
{
path
.
AssignLiteral
(
"
/
"
)
;
}
mUnsetValue
=
aUnsetValue
;
net
:
:
CookieStruct
cookieData
(
nsCString
(
aName
)
nsCString
(
aValue
)
nsCString
(
aHost
)
path
0
0
0
aIsHttpOnly
aIsSession
aIsSecure
aSameSite
aSameSite
aSchemeMap
)
;
OriginAttributes
attrs
;
mCookie
=
net
:
:
Cookie
:
:
Create
(
cookieData
attrs
)
;
}
NS_IMETHODIMP
nsCookieRule
:
:
GetExpiryRelative
(
int64_t
*
aExpiryRelative
)
{
NS_ENSURE_ARG_POINTER
(
aExpiryRelative
)
;
*
aExpiryRelative
=
mExpiryRelative
;
return
NS_OK
;
}
NS_IMETHODIMP
nsCookieRule
:
:
GetUnsetValue
(
nsACString
&
aUnsetValue
)
{
aUnsetValue
=
mUnsetValue
;
return
NS_OK
;
}
NS_IMETHODIMP
nsCookieRule
:
:
GetCookie
(
nsICookie
*
*
aCookie
)
{
NS_ENSURE_ARG_POINTER
(
aCookie
)
;
nsICookie
*
cookie
=
mCookie
;
RefPtr
<
net
:
:
Cookie
>
cookieNative
=
static_cast
<
net
:
:
Cookie
*
>
(
cookie
)
-
>
Clone
(
)
;
int64_t
currentTimeInUsec
=
PR_Now
(
)
;
cookieNative
-
>
SetCreationTime
(
net
:
:
Cookie
:
:
GenerateUniqueCreationTime
(
currentTimeInUsec
)
)
;
cookieNative
-
>
SetLastAccessed
(
currentTimeInUsec
)
;
cookieNative
-
>
SetExpiry
(
(
currentTimeInUsec
/
PR_USEC_PER_SEC
)
+
mExpiryRelative
)
;
cookieNative
.
forget
(
aCookie
)
;
return
NS_OK
;
}
}
