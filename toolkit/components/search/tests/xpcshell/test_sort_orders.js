"
use
strict
"
;
const
EXPECTED_DEFAULT_ORDER
=
[
"
engine1
"
"
engine6
"
"
engine2
"
"
engine3
"
"
engine5
"
"
engine4
"
]
;
const
EXPECTED_GD_ORDER
=
[
"
engine1
"
"
engine4
"
"
engine6
"
"
engine2
"
"
engine3
"
"
engine5
"
]
;
const
CONFIG
=
[
{
identifier
:
"
engine1
"
}
{
identifier
:
"
engine2
"
}
{
identifier
:
"
engine3
"
}
{
identifier
:
"
engine4
"
}
{
identifier
:
"
engine5
"
}
{
identifier
:
"
engine6
"
}
{
orders
:
[
{
environment
:
{
allRegionsAndLocales
:
true
}
order
:
EXPECTED_DEFAULT_ORDER
}
{
environment
:
{
locales
:
[
"
gd
"
]
}
order
:
EXPECTED_GD_ORDER
}
]
}
]
;
add_setup
(
async
function
(
)
{
SearchTestUtils
.
setRemoteSettingsConfig
(
CONFIG
)
;
Services
.
locale
.
availableLocales
=
[
.
.
.
Services
.
locale
.
availableLocales
"
gd
"
]
;
Services
.
prefs
.
setBoolPref
(
SearchUtils
.
BROWSER_SEARCH_PREF
+
"
separatePrivateDefault
"
true
)
;
Services
.
prefs
.
setBoolPref
(
SearchUtils
.
BROWSER_SEARCH_PREF
+
"
separatePrivateDefault
.
ui
.
enabled
"
true
)
;
}
)
;
async
function
checkOrder
(
type
expectedOrder
)
{
Services
.
search
.
wrappedJSObject
.
_cachedSortedEngines
=
null
;
const
sortedEngines
=
await
Services
.
search
[
type
]
(
)
;
Assert
.
deepEqual
(
sortedEngines
.
map
(
s
=
>
s
.
name
)
expectedOrder
Should
have
the
expected
engine
order
from
{
type
}
)
;
}
add_task
(
async
function
test_engine_sort_only_builtins
(
)
{
await
checkOrder
(
"
getAppProvidedEngines
"
EXPECTED_DEFAULT_ORDER
)
;
await
checkOrder
(
"
getEngines
"
EXPECTED_DEFAULT_ORDER
)
;
}
)
;
add_task
(
async
function
test_engine_sort_with_non_builtins_sort
(
)
{
await
SearchTestUtils
.
installSearchExtension
(
{
name
:
"
nonbuiltin1
"
}
)
;
Services
.
search
.
wrappedJSObject
.
_settings
.
setMetaDataAttribute
(
"
useSavedOrder
"
false
)
;
await
checkOrder
(
"
getAppProvidedEngines
"
EXPECTED_DEFAULT_ORDER
)
;
const
expected
=
[
.
.
.
EXPECTED_DEFAULT_ORDER
]
;
expected
.
splice
(
EXPECTED_DEFAULT_ORDER
.
length
0
"
nonbuiltin1
"
)
;
await
checkOrder
(
"
getEngines
"
expected
)
;
}
)
;
add_task
(
async
function
test_engine_sort_with_locale
(
)
{
await
promiseSetLocale
(
"
gd
"
)
;
const
expected
=
[
.
.
.
EXPECTED_GD_ORDER
]
;
await
checkOrder
(
"
getAppProvidedEngines
"
expected
)
;
expected
.
push
(
"
nonbuiltin1
"
)
;
await
checkOrder
(
"
getEngines
"
expected
)
;
}
)
;
