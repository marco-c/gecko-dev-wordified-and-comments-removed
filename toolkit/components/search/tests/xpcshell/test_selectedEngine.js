const
kDefaultEngineName
=
"
engine1
"
;
add_setup
(
async
function
(
)
{
useHttpServer
(
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
await
SearchTestUtils
.
useTestEngines
(
"
data1
"
)
;
Assert
.
ok
(
!
Services
.
search
.
isInitialized
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
search
.
removeEngineInfobar
.
enabled
"
false
)
;
}
)
;
add_task
(
async
function
test_defaultEngine
(
)
{
await
Services
.
search
.
init
(
)
;
await
SearchTestUtils
.
promiseNewSearchEngine
(
{
url
:
{
gDataUrl
}
engine
.
xml
}
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
}
)
;
add_task
(
async
function
test_persistAcrossRestarts
(
)
{
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterSettings
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
defaultEngineIdHash
.
length
44
)
;
Services
.
search
.
wrappedJSObject
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
Services
.
search
.
resetToAppDefaultEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
}
)
;
add_task
(
async
function
test_ignoreInvalidHash
(
)
{
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterSettings
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
metadata
.
defaultEngineIdHash
=
"
invalid
"
;
await
promiseSaveGlobalMetadata
(
metadata
)
;
Services
.
search
.
wrappedJSObject
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
}
)
;
add_task
(
async
function
test_settingToDefault
(
)
{
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterSettings
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
let
currentEngine
=
Services
.
search
.
getEngineByName
(
kTestEngineName
)
;
Assert
.
equal
(
metadata
.
defaultEngineId
currentEngine
.
id
)
;
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kDefaultEngineName
)
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
await
promiseAfterSettings
(
)
;
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
defaultEngineId
"
"
)
;
}
)
;
add_task
(
async
function
test_resetToOriginalDefaultEngine
(
)
{
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterSettings
(
)
;
Services
.
search
.
resetToAppDefaultEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
await
promiseAfterSettings
(
)
;
}
)
;
add_task
(
async
function
test_fallback_kept_after_restart
(
)
{
let
builtInEngines
=
await
Services
.
search
.
getAppProvidedEngines
(
)
;
let
nonDefaultBuiltInEngine
;
for
(
let
engine
of
builtInEngines
)
{
if
(
engine
.
name
!
=
kDefaultEngineName
)
{
nonDefaultBuiltInEngine
=
engine
;
break
;
}
}
await
Services
.
search
.
setDefault
(
nonDefaultBuiltInEngine
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
nonDefaultBuiltInEngine
.
name
)
;
await
promiseAfterSettings
(
)
;
await
Services
.
search
.
removeEngine
(
nonDefaultBuiltInEngine
)
;
Assert
.
ok
(
nonDefaultBuiltInEngine
.
hidden
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
Services
.
search
.
restoreDefaultEngines
(
)
;
Assert
.
ok
(
!
nonDefaultBuiltInEngine
.
hidden
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
await
promiseAfterSettings
(
)
;
Services
.
search
.
wrappedJSObject
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kDefaultEngineName
)
;
}
)
;
