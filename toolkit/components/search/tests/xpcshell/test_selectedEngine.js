const
kSelectedEnginePref
=
"
browser
.
search
.
selectedEngine
"
;
add_task
(
async
function
test_defaultEngine
(
)
{
await
asyncInit
(
)
;
await
installTestEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
getDefaultEngineName
(
)
)
;
}
)
;
add_task
(
async
function
test_selectedEngine
(
)
{
let
defaultEngineName
=
getDefaultEngineName
(
)
;
Services
.
prefs
.
setCharPref
(
kSelectedEnginePref
kTestEngineName
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultEngineName
)
;
Services
.
prefs
.
clearUserPref
(
kSelectedEnginePref
)
;
Services
.
prefs
.
setCharPref
(
kDefaultenginenamePref
kTestEngineName
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultEngineName
)
;
Services
.
prefs
.
clearUserPref
(
kDefaultenginenamePref
)
;
}
)
;
add_task
(
async
function
test_persistAcrossRestarts
(
)
{
Services
.
search
.
defaultEngine
=
Services
.
search
.
getEngineByName
(
kTestEngineName
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
hash
.
length
44
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
Services
.
search
.
resetToOriginalDefaultEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
getDefaultEngineName
(
)
)
;
}
)
;
add_task
(
async
function
test_ignoreInvalidHash
(
)
{
Services
.
search
.
defaultEngine
=
Services
.
search
.
getEngineByName
(
kTestEngineName
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
metadata
.
hash
=
"
invalid
"
;
await
promiseSaveGlobalMetadata
(
metadata
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
getDefaultEngineName
(
)
)
;
}
)
;
add_task
(
async
function
test_settingToDefault
(
)
{
Services
.
search
.
defaultEngine
=
Services
.
search
.
getEngineByName
(
kTestEngineName
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
current
kTestEngineName
)
;
Services
.
search
.
defaultEngine
=
Services
.
search
.
getEngineByName
(
getDefaultEngineName
(
)
)
;
await
promiseAfterCache
(
)
;
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
current
"
"
)
;
}
)
;
add_task
(
async
function
test_resetToOriginalDefaultEngine
(
)
{
let
defaultName
=
getDefaultEngineName
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
Services
.
search
.
defaultEngine
=
Services
.
search
.
getEngineByName
(
kTestEngineName
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
Services
.
search
.
resetToOriginalDefaultEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
await
promiseAfterCache
(
)
;
}
)
;
add_task
(
async
function
test_fallback_kept_after_restart
(
)
{
let
builtInEngines
=
Services
.
search
.
getDefaultEngines
(
)
;
let
defaultName
=
getDefaultEngineName
(
)
;
let
nonDefaultBuiltInEngine
;
for
(
let
engine
of
builtInEngines
)
{
if
(
engine
.
name
!
=
defaultName
)
{
nonDefaultBuiltInEngine
=
engine
;
break
;
}
}
Services
.
search
.
defaultEngine
=
nonDefaultBuiltInEngine
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
nonDefaultBuiltInEngine
.
name
)
;
await
promiseAfterCache
(
)
;
Services
.
search
.
removeEngine
(
nonDefaultBuiltInEngine
)
;
Assert
.
ok
(
nonDefaultBuiltInEngine
.
hidden
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
Services
.
search
.
restoreDefaultEngines
(
)
;
Assert
.
ok
(
!
nonDefaultBuiltInEngine
.
hidden
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
await
promiseAfterCache
(
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
}
)
;
function
run_test
(
)
{
Assert
.
ok
(
!
Services
.
search
.
isInitialized
)
;
let
engineDummyFile
=
gProfD
.
clone
(
)
;
engineDummyFile
.
append
(
"
searchplugins
"
)
;
engineDummyFile
.
append
(
"
test
-
search
-
engine
.
xml
"
)
;
let
engineDir
=
engineDummyFile
.
parent
;
engineDir
.
create
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
FileUtils
.
PERMS_DIRECTORY
)
;
do_get_file
(
"
data
/
engine
.
xml
"
)
.
copyTo
(
engineDir
"
engine
.
xml
"
)
;
run_next_test
(
)
;
}
