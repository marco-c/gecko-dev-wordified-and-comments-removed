const
kSelectedEnginePref
=
"
browser
.
search
.
selectedEngine
"
;
add_task
(
async
function
setup
(
)
{
await
AddonTestUtils
.
promiseStartupManager
(
)
;
await
useTestEngines
(
"
data1
"
)
;
Assert
.
ok
(
!
Services
.
search
.
isInitialized
)
;
}
)
;
add_task
(
async
function
test_defaultEngine
(
)
{
await
Services
.
search
.
init
(
)
;
await
installTestEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
getDefaultEngineName
(
)
)
;
}
)
;
add_task
(
async
function
test_selectedEngine
(
)
{
let
defaultEngineName
=
getDefaultEngineName
(
)
;
Services
.
prefs
.
setCharPref
(
kSelectedEnginePref
kTestEngineName
)
;
Services
.
search
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultEngineName
)
;
Services
.
prefs
.
clearUserPref
(
kSelectedEnginePref
)
;
Services
.
prefs
.
setCharPref
(
kDefaultenginenamePref
kTestEngineName
)
;
Services
.
search
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultEngineName
)
;
Services
.
prefs
.
clearUserPref
(
kDefaultenginenamePref
)
;
}
)
;
add_task
(
async
function
test_persistAcrossRestarts
(
)
{
await
installTestEngine
(
)
;
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
hash
.
length
44
)
;
Services
.
search
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
Services
.
search
.
resetToOriginalDefaultEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
getDefaultEngineName
(
)
)
;
}
)
;
add_task
(
async
function
test_ignoreInvalidHash
(
)
{
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
metadata
.
hash
=
"
invalid
"
;
await
promiseSaveGlobalMetadata
(
metadata
)
;
Services
.
search
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
getDefaultEngineName
(
)
)
;
}
)
;
add_task
(
async
function
test_settingToDefault
(
)
{
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
let
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
current
kTestEngineName
)
;
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
getDefaultEngineName
(
)
)
)
;
await
promiseAfterCache
(
)
;
metadata
=
await
promiseGlobalMetadata
(
)
;
Assert
.
equal
(
metadata
.
current
"
"
)
;
}
)
;
add_task
(
async
function
test_resetToOriginalDefaultEngine
(
)
{
let
defaultName
=
getDefaultEngineName
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
await
Services
.
search
.
setDefault
(
Services
.
search
.
getEngineByName
(
kTestEngineName
)
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
kTestEngineName
)
;
await
promiseAfterCache
(
)
;
Services
.
search
.
resetToOriginalDefaultEngine
(
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
await
promiseAfterCache
(
)
;
}
)
;
add_task
(
async
function
test_fallback_kept_after_restart
(
)
{
let
builtInEngines
=
await
Services
.
search
.
getDefaultEngines
(
)
;
let
defaultName
=
getDefaultEngineName
(
)
;
let
nonDefaultBuiltInEngine
;
for
(
let
engine
of
builtInEngines
)
{
if
(
engine
.
name
!
=
defaultName
)
{
nonDefaultBuiltInEngine
=
engine
;
break
;
}
}
await
Services
.
search
.
setDefault
(
nonDefaultBuiltInEngine
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
nonDefaultBuiltInEngine
.
name
)
;
await
promiseAfterCache
(
)
;
await
Services
.
search
.
removeEngine
(
nonDefaultBuiltInEngine
)
;
Assert
.
ok
(
nonDefaultBuiltInEngine
.
hidden
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
Services
.
search
.
restoreDefaultEngines
(
)
;
Assert
.
ok
(
!
nonDefaultBuiltInEngine
.
hidden
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
await
promiseAfterCache
(
)
;
Services
.
search
.
reset
(
)
;
await
Services
.
search
.
init
(
true
)
;
Assert
.
equal
(
Services
.
search
.
defaultEngine
.
name
defaultName
)
;
}
)
;
