const
{
MockRegistrar
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
MockRegistrar
.
jsm
"
)
;
"
use
strict
"
;
var
promptService
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIPromptService
]
)
confirmEx
(
)
{
}
}
;
var
prompt
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIPrompt
]
)
alert
(
)
{
}
}
;
MockRegistrar
.
register
(
"
mozilla
.
org
/
embedcomp
/
prompt
-
service
;
1
"
promptService
)
;
MockRegistrar
.
register
(
"
mozilla
.
org
/
prompter
;
1
"
prompt
)
;
add_task
(
async
function
init_search_service
(
)
{
useHttpServer
(
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
simple_callback_test
(
)
{
let
engine
=
await
Services
.
search
.
addEngine
(
gDataUrl
+
"
engine
.
xml
"
null
false
)
;
Assert
.
ok
(
!
!
engine
)
;
Assert
.
notEqual
(
engine
.
name
(
await
Services
.
search
.
getDefault
(
)
)
.
name
)
;
Assert
.
equal
(
engine
.
wrappedJSObject
.
_loadPath
"
[
http
]
localhost
/
test
-
search
-
engine
.
xml
"
)
;
}
)
;
add_task
(
async
function
duplicate_failure_test
(
)
{
let
engine
;
try
{
engine
=
await
Services
.
search
.
addEngine
(
gDataUrl
+
"
engine
.
xml
"
null
false
)
;
}
catch
(
ex
)
{
let
errorCode
=
ex
.
result
;
Assert
.
ok
(
!
!
errorCode
)
;
Assert
.
equal
(
errorCode
Ci
.
nsISearchService
.
ERROR_DUPLICATE_ENGINE
)
;
}
finally
{
Assert
.
ok
(
!
engine
)
;
}
}
)
;
add_task
(
async
function
load_failure_test
(
)
{
let
engine
;
try
{
engine
=
await
Services
.
search
.
addEngine
(
"
http
:
/
/
invalid
/
data
/
engine
.
xml
"
null
false
)
;
}
catch
(
ex
)
{
let
errorCode
=
ex
.
result
;
Assert
.
ok
(
!
!
errorCode
)
;
Assert
.
equal
(
errorCode
Ci
.
nsISearchService
.
ERROR_UNKNOWN_FAILURE
)
;
}
finally
{
Assert
.
ok
(
!
engine
)
;
}
}
)
;
