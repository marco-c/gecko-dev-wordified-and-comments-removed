function
run_test
(
)
{
do_load_manifest
(
"
data
/
chrome
.
manifest
"
)
;
configureToLoadJarEngines
(
)
;
Assert
.
ok
(
!
Services
.
search
.
isInitialized
)
;
run_next_test
(
)
;
}
add_task
(
async
function
ignore_cache_files_without_engines
(
)
{
let
commitPromise
=
promiseAfterCache
(
)
;
let
engineCount
=
(
await
Services
.
search
.
getEngines
(
)
)
.
length
;
Assert
.
equal
(
engineCount
1
)
;
await
commitPromise
;
let
cache
=
await
promiseCacheData
(
)
;
cache
.
engines
=
[
]
;
await
promiseSaveCacheData
(
cache
)
;
commitPromise
=
promiseAfterCache
(
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
engineCount
(
await
Services
.
search
.
getEngines
(
)
)
.
length
)
;
await
commitPromise
;
await
promiseSaveCacheData
(
cache
)
;
let
unInitPromise
=
waitForSearchNotification
(
"
uninit
-
complete
"
)
;
let
reInitPromise
=
asyncReInit
(
)
;
await
unInitPromise
;
Assert
.
ok
(
!
Services
.
search
.
isInitialized
)
;
Assert
.
equal
(
engineCount
(
await
Services
.
search
.
getEngines
(
)
)
.
length
)
;
Assert
.
ok
(
Services
.
search
.
isInitialized
)
;
await
reInitPromise
;
}
)
;
add_task
(
async
function
skip_writing_cache_without_engines
(
)
{
let
unInitPromise
=
waitForSearchNotification
(
"
uninit
-
complete
"
)
;
let
reInitPromise
=
asyncReInit
(
)
;
await
unInitPromise
;
Assert
.
ok
(
removeCacheFile
(
)
)
;
let
resProt
=
Services
.
io
.
getProtocolHandler
(
"
resource
"
)
.
QueryInterface
(
Ci
.
nsIResProtocolHandler
)
;
resProt
.
setSubstitution
(
"
search
-
plugins
"
Services
.
io
.
newURI
(
"
about
:
blank
"
)
)
;
await
reInitPromise
;
Assert
.
strictEqual
(
0
(
await
Services
.
search
.
getEngines
(
)
)
.
length
)
;
unInitPromise
=
waitForSearchNotification
(
"
uninit
-
complete
"
)
;
reInitPromise
=
asyncReInit
(
)
;
await
unInitPromise
;
Assert
.
ok
(
!
removeCacheFile
(
)
)
;
await
reInitPromise
;
}
)
;
