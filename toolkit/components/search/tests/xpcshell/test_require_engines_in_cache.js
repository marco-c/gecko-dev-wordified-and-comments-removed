add_task
(
async
function
setup
(
)
{
await
useTestEngines
(
"
simple
-
engines
"
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
ignore_cache_files_without_engines
(
)
{
let
commitPromise
=
promiseAfterCache
(
)
;
let
engineCount
=
(
await
Services
.
search
.
getEngines
(
)
)
.
length
;
Assert
.
equal
(
engineCount
2
)
;
await
commitPromise
;
let
cache
=
await
promiseCacheData
(
)
;
cache
.
engines
=
[
]
;
await
promiseSaveCacheData
(
cache
)
;
commitPromise
=
promiseAfterCache
(
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
engineCount
(
await
Services
.
search
.
getEngines
(
)
)
.
length
)
;
await
commitPromise
;
await
promiseSaveCacheData
(
cache
)
;
let
unInitPromise
=
SearchTestUtils
.
promiseSearchNotification
(
"
uninit
-
complete
"
)
;
let
reInitPromise
=
asyncReInit
(
)
;
await
unInitPromise
;
Assert
.
ok
(
!
Services
.
search
.
isInitialized
)
;
Assert
.
equal
(
engineCount
(
await
Services
.
search
.
getEngines
(
)
)
.
length
)
;
Assert
.
ok
(
Services
.
search
.
isInitialized
)
;
await
reInitPromise
;
}
)
;
