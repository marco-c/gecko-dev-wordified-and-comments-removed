add_task
(
async
function
setup
(
)
{
Services
.
prefs
.
setCharPref
(
"
browser
.
search
.
region
"
"
US
"
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
search
.
geoSpecificDefaults
"
false
)
;
configureToLoadJarEngines
(
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
ignore_cache_files_without_engines
(
)
{
let
commitPromise
=
promiseAfterCache
(
)
;
let
engineCount
=
(
await
Services
.
search
.
getEngines
(
)
)
.
length
;
Assert
.
equal
(
engineCount
1
"
one
engine
installed
on
search
init
"
)
;
await
commitPromise
;
let
cache
=
await
promiseCacheData
(
)
;
cache
.
engines
=
[
]
;
await
promiseSaveCacheData
(
cache
)
;
commitPromise
=
promiseAfterCache
(
)
;
await
asyncReInit
(
)
;
Assert
.
equal
(
engineCount
(
await
Services
.
search
.
getEngines
(
)
)
.
length
"
Search
got
correct
number
of
engines
"
)
;
await
commitPromise
;
await
promiseSaveCacheData
(
cache
)
;
let
unInitPromise
=
SearchTestUtils
.
promiseSearchNotification
(
"
uninit
-
complete
"
)
;
let
reInitPromise
=
asyncReInit
(
)
;
await
unInitPromise
;
Assert
.
ok
(
!
Services
.
search
.
isInitialized
"
Search
is
not
initialized
"
)
;
Assert
.
equal
(
engineCount
(
await
Services
.
search
.
getEngines
(
)
)
.
length
"
Search
got
correct
number
of
engines
"
)
;
Assert
.
ok
(
Services
.
search
.
isInitialized
"
Search
is
initialized
"
)
;
await
reInitPromise
;
}
)
;
