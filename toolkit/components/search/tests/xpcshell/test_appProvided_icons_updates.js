"
use
strict
"
;
let
CONFIG
=
[
{
identifier
:
"
engine_no_initial_icon
"
recordType
:
"
engine
"
base
:
{
name
:
"
engine_no_initial_icon
name
"
urls
:
{
search
:
{
base
:
"
https
:
/
/
example
.
com
/
1
"
searchTermParamName
:
"
q
"
}
}
}
variants
:
[
{
environment
:
{
allRegionsAndLocales
:
true
}
}
]
}
{
identifier
:
"
engine_icon_updates
"
recordType
:
"
engine
"
base
:
{
name
:
"
engine_icon_updates
name
"
urls
:
{
search
:
{
base
:
"
https
:
/
/
example
.
com
/
2
"
searchTermParamName
:
"
q
"
}
}
}
variants
:
[
{
environment
:
{
allRegionsAndLocales
:
true
}
}
]
}
{
identifier
:
"
engine_icon_not_local
"
recordType
:
"
engine
"
base
:
{
name
:
"
engine_icon_not_local
name
"
urls
:
{
search
:
{
base
:
"
https
:
/
/
example
.
com
/
3
"
searchTermParamName
:
"
q
"
}
}
}
variants
:
[
{
environment
:
{
allRegionsAndLocales
:
true
}
}
]
}
{
identifier
:
"
engine_icon_out_of_date
"
recordType
:
"
engine
"
base
:
{
name
:
"
engine_icon_out_of_date
name
"
urls
:
{
search
:
{
base
:
"
https
:
/
/
example
.
com
/
4
"
searchTermParamName
:
"
q
"
}
}
}
variants
:
[
{
environment
:
{
allRegionsAndLocales
:
true
}
}
]
}
{
recordType
:
"
defaultEngines
"
globalDefault
:
"
engine_no_initial_icon
"
specificDefaults
:
[
]
}
{
recordType
:
"
engineOrders
"
orders
:
[
]
}
]
;
async
function
assertIconMatches
(
actualIconData
expectedIcon
)
{
let
expectedBuffer
=
new
Uint8Array
(
await
getFileDataBuffer
(
expectedIcon
)
)
;
Assert
.
equal
(
actualIconData
.
length
expectedBuffer
.
length
"
Should
have
received
matching
buffer
lengths
for
the
expected
icon
"
)
;
Assert
.
ok
(
actualIconData
.
every
(
(
value
index
)
=
>
value
=
=
=
expectedBuffer
[
index
]
)
"
Should
have
received
matching
data
for
the
expected
icon
"
)
;
}
async
function
assertEngineIcon
(
engineName
expectedIcon
)
{
let
engine
=
Services
.
search
.
getEngineByName
(
engineName
)
;
let
engineIconURL
=
await
engine
.
getIconURL
(
16
)
;
if
(
expectedIcon
)
{
Assert
.
notEqual
(
engineIconURL
null
"
Should
have
an
icon
URL
for
the
engine
.
"
)
;
let
response
=
await
fetch
(
engineIconURL
)
;
let
buffer
=
new
Uint8Array
(
await
response
.
arrayBuffer
(
)
)
;
await
assertIconMatches
(
buffer
expectedIcon
)
;
}
else
{
Assert
.
equal
(
engineIconURL
null
"
Should
not
have
an
icon
URL
for
the
engine
.
"
)
;
}
}
let
originalIconId
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
;
let
client
;
add_setup
(
async
function
setup
(
)
{
useHttpServer
(
)
;
SearchTestUtils
.
useMockIdleService
(
)
;
client
=
RemoteSettings
(
"
search
-
config
-
icons
"
)
;
await
client
.
db
.
clear
(
)
;
sinon
.
stub
(
RemoteSettingsUtils
"
baseAttachmentsURL
"
)
.
returns
(
gDataUrl
)
;
await
insertRecordIntoCollection
(
client
{
id
:
originalIconId
filename
:
"
remoteIcon
.
ico
"
engineIdentifiers
:
[
"
engine_icon_upd
*
"
]
imageSize
:
16
}
)
;
await
insertRecordIntoCollection
(
client
{
id
:
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
filename
:
"
bigIcon
.
ico
"
engineIdentifiers
:
[
"
enterprise
"
"
next_generation
"
"
engine_icon_not_local
"
]
imageSize
:
16
}
false
)
;
let
outOfDateRecordId
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
;
await
insertRecordIntoCollection
(
client
{
id
:
outOfDateRecordId
filename
:
"
remoteIcon
.
ico
"
engineIdentifiers
:
[
"
engine_icon_out_of_date
"
]
imageSize
:
16
lastModified
:
Date
.
now
(
)
-
600000
}
true
)
;
let
{
record
}
=
await
mockRecordWithAttachment
(
{
id
:
outOfDateRecordId
filename
:
"
bigIcon
.
ico
"
engineIdentifiers
:
[
"
engine_icon_out_of_date
"
]
imageSize
:
16
}
)
;
await
client
.
db
.
update
(
record
)
;
await
client
.
db
.
importChanges
(
{
}
record
.
lastModified
)
;
await
SearchTestUtils
.
useTestEngines
(
"
simple
-
engines
"
null
CONFIG
)
;
await
Services
.
search
.
init
(
)
;
consoleAllowList
.
push
(
"
Could
not
find
"
)
;
}
)
;
add_task
(
async
function
test_icon_added_unknown_engine
(
)
{
let
newIconId
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
;
let
mock
=
await
mockRecordWithAttachment
(
{
id
:
newIconId
filename
:
"
bigIcon
.
ico
"
engineIdentifiers
:
[
"
engine_unknown
"
]
imageSize
:
16
}
)
;
await
client
.
db
.
update
(
mock
.
record
Date
.
now
(
)
)
;
await
client
.
emit
(
"
sync
"
{
data
:
{
current
:
[
mock
.
record
]
created
:
[
mock
.
record
]
updated
:
[
]
deleted
:
[
]
}
}
)
;
SearchTestUtils
.
idleService
.
_fireObservers
(
"
idle
"
)
;
let
icon
;
await
TestUtils
.
waitForCondition
(
async
(
)
=
>
{
try
{
icon
=
await
client
.
attachments
.
get
(
mock
.
record
)
;
}
catch
(
ex
)
{
}
return
!
!
icon
;
}
"
Should
have
loaded
the
icon
into
the
attachments
store
.
"
)
;
await
assertIconMatches
(
new
Uint8Array
(
icon
.
buffer
)
"
bigIcon
.
ico
"
)
;
}
)
;
add_task
(
async
function
test_icon_added_existing_engine
(
)
{
let
newIconId
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
;
let
mock
=
await
mockRecordWithAttachment
(
{
id
:
newIconId
filename
:
"
bigIcon
.
ico
"
engineIdentifiers
:
[
"
engine_no_initial_icon
"
]
imageSize
:
16
}
)
;
await
client
.
db
.
update
(
mock
.
record
Date
.
now
(
)
)
;
let
promiseIconChanged
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
ICON_CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
await
client
.
emit
(
"
sync
"
{
data
:
{
current
:
[
mock
.
record
]
created
:
[
mock
.
record
]
updated
:
[
]
deleted
:
[
]
}
}
)
;
SearchTestUtils
.
idleService
.
_fireObservers
(
"
idle
"
)
;
await
promiseIconChanged
;
await
assertEngineIcon
(
"
engine_no_initial_icon
name
"
"
bigIcon
.
ico
"
)
;
}
)
;
add_task
(
async
function
test_icon_updated
(
)
{
await
assertEngineIcon
(
"
engine_icon_updates
name
"
"
remoteIcon
.
ico
"
)
;
let
mock
=
await
mockRecordWithAttachment
(
{
id
:
originalIconId
filename
:
"
bigIcon
.
ico
"
engineIdentifiers
:
[
"
engine_icon_upd
*
"
]
imageSize
:
16
}
)
;
await
client
.
db
.
update
(
mock
.
record
Date
.
now
(
)
)
;
let
promiseIconChanged
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
ICON_CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
await
client
.
emit
(
"
sync
"
{
data
:
{
current
:
[
mock
.
record
]
created
:
[
]
updated
:
[
{
new
:
mock
.
record
}
]
deleted
:
[
]
}
}
)
;
SearchTestUtils
.
idleService
.
_fireObservers
(
"
idle
"
)
;
await
promiseIconChanged
;
await
assertEngineIcon
(
"
engine_icon_updates
name
"
"
bigIcon
.
ico
"
)
;
}
)
;
add_task
(
async
function
test_icon_not_local
(
)
{
await
assertEngineIcon
(
"
engine_icon_not_local
name
"
null
)
;
let
promiseIconChanged
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
ICON_CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
SearchTestUtils
.
idleService
.
_fireObservers
(
"
idle
"
)
;
await
promiseIconChanged
;
await
assertEngineIcon
(
"
engine_icon_not_local
name
"
"
bigIcon
.
ico
"
)
;
}
)
;
add_task
(
async
function
test_icon_out_of_date
(
)
{
await
assertEngineIcon
(
"
engine_icon_out_of_date
name
"
"
remoteIcon
.
ico
"
)
;
let
promiseIconChanged
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
ICON_CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
SearchTestUtils
.
idleService
.
_fireObservers
(
"
idle
"
)
;
await
promiseIconChanged
;
await
assertEngineIcon
(
"
engine_icon_out_of_date
name
"
"
bigIcon
.
ico
"
)
;
}
)
;
