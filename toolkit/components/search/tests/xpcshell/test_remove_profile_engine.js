add_task
(
async
function
run_test
(
)
{
let
dir
=
do_get_profile
(
)
.
clone
(
)
;
dir
.
append
(
"
searchplugins
"
)
;
if
(
!
dir
.
exists
(
)
)
{
dir
.
create
(
dir
.
DIRECTORY_TYPE
FileUtils
.
PERMS_DIRECTORY
)
;
}
do_get_file
(
"
data
/
engine
-
override
.
xml
"
)
.
copyTo
(
dir
"
basic
.
xml
"
)
;
let
file
=
dir
.
clone
(
)
;
file
.
append
(
"
basic
.
xml
"
)
;
Assert
.
ok
(
file
.
exists
(
)
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
let
cacheWrittenPromise
=
promiseAfterCache
(
)
;
await
Services
.
search
.
init
(
)
;
await
cacheWrittenPromise
;
useHttpServer
(
)
;
cacheWrittenPromise
=
promiseAfterCache
(
)
;
await
addTestEngines
(
[
{
name
:
"
basic
"
xmlFileName
:
"
engine
-
override
.
xml
"
}
]
)
;
await
cacheWrittenPromise
;
let
data
=
await
promiseCacheData
(
)
;
for
(
let
engine
of
data
.
engines
)
{
if
(
engine
.
_name
=
=
"
basic
"
)
{
engine
.
filePath
=
file
.
path
;
}
}
await
promiseSaveCacheData
(
data
)
;
cacheWrittenPromise
=
promiseAfterCache
(
)
;
await
asyncReInit
(
)
;
await
cacheWrittenPromise
;
let
engine
=
Services
.
search
.
getEngineByName
(
"
basic
"
)
;
Assert
.
notEqual
(
engine
null
)
;
await
Services
.
search
.
removeEngine
(
engine
)
;
Assert
.
ok
(
!
file
.
exists
(
)
)
;
}
)
;
