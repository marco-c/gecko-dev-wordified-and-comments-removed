add_setup
(
async
function
(
)
{
await
SearchTestUtils
.
useTestEngines
(
"
data1
"
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
run_test
(
)
{
let
dir
=
do_get_profile
(
)
.
clone
(
)
;
dir
.
append
(
"
searchplugins
"
)
;
if
(
!
dir
.
exists
(
)
)
{
dir
.
create
(
dir
.
DIRECTORY_TYPE
FileUtils
.
PERMS_DIRECTORY
)
;
}
do_get_file
(
"
data
/
engine
.
xml
"
)
.
copyTo
(
dir
"
test
-
search
-
engine
.
xml
"
)
;
let
file
=
dir
.
clone
(
)
;
file
.
append
(
"
test
-
search
-
engine
.
xml
"
)
;
Assert
.
ok
(
file
.
exists
(
)
)
;
let
data
=
await
readJSONFile
(
do_get_file
(
"
data
/
search
-
legacy
.
json
"
)
)
;
for
(
let
engine
of
data
.
engines
)
{
if
(
engine
.
_name
=
=
"
Test
search
engine
"
)
{
engine
.
filePath
=
file
.
path
;
}
}
await
promiseSaveSettingsData
(
data
)
;
await
Services
.
search
.
init
(
)
;
let
engine
=
Services
.
search
.
getEngineByName
(
"
Test
search
engine
"
)
;
Assert
.
notEqual
(
engine
null
"
Should
have
found
the
engine
"
)
;
await
Services
.
search
.
removeEngine
(
engine
)
;
Assert
.
ok
(
!
file
.
exists
(
)
"
Should
have
removed
the
file
.
"
)
;
}
)
;
