"
use
strict
"
;
const
{
AppConstants
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
sys
.
mjs
"
)
;
const
defaultBranch
=
Services
.
prefs
.
getDefaultBranch
(
SearchUtils
.
BROWSER_SEARCH_PREF
)
;
const
baseURL
=
"
https
:
/
/
www
.
google
.
com
/
search
?
q
=
foo
"
;
const
baseURLSearchConfigV2
=
"
https
:
/
/
www
.
google
.
com
/
search
?
"
;
add_setup
(
async
function
(
)
{
await
SearchTestUtils
.
useTestEngines
(
)
;
}
)
;
add_task
(
async
function
test_pref_initial_value
(
)
{
defaultBranch
.
setCharPref
(
"
param
.
code
"
"
good
&
id
=
unique
"
)
;
if
(
!
AppConstants
.
NIGHTLY_BUILD
)
{
Services
.
prefs
.
setCharPref
(
SearchUtils
.
BROWSER_SEARCH_PREF
+
"
param
.
code
"
"
bad
"
)
;
}
await
Services
.
search
.
init
(
)
;
const
engine
=
Services
.
search
.
getEngineByName
(
"
engine
-
pref
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURLSearchConfigV2
+
"
code
=
good
%
26id
%
3Dunique
&
q
=
foo
"
"
Should
have
got
the
submission
URL
with
the
correct
code
"
)
;
Services
.
prefs
.
clearUserPref
(
SearchUtils
.
BROWSER_SEARCH_PREF
+
"
param
.
code
"
)
;
}
)
;
add_task
(
async
function
test_pref_updated
(
)
{
defaultBranch
.
setCharPref
(
"
param
.
code
"
"
supergood
&
id
=
unique123456
"
)
;
const
engine
=
Services
.
search
.
getEngineByName
(
"
engine
-
pref
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURLSearchConfigV2
+
"
code
=
supergood
%
26id
%
3Dunique123456
&
q
=
foo
"
"
Should
have
got
the
submission
URL
with
the
updated
code
"
)
;
}
)
;
add_task
(
async
function
test_pref_cleared
(
)
{
defaultBranch
.
setCharPref
(
"
param
.
code
"
"
"
)
;
let
engine
=
Services
.
search
.
getEngineByName
(
"
engine
-
pref
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURL
"
Should
have
just
the
base
URL
after
the
pref
was
cleared
"
)
;
}
)
;
