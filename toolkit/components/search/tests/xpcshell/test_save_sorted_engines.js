add_task
(
async
function
setup
(
)
{
useHttpServer
(
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
test_save_sorted_engines
(
)
{
let
[
engine1
engine2
]
=
await
addTestEngines
(
[
{
name
:
"
Test
search
engine
"
xmlFileName
:
"
engine
.
xml
"
}
{
name
:
"
A
second
test
engine
"
xmlFileName
:
"
engine2
.
xml
"
}
]
)
;
await
promiseAfterCache
(
)
;
let
search
=
Services
.
search
;
await
search
.
moveEngine
(
engine1
0
)
;
await
search
.
moveEngine
(
engine2
1
)
;
await
promiseAfterCache
(
)
;
info
(
"
Commit
complete
after
moveEngine
"
)
;
let
metadata
=
await
promiseEngineMetadata
(
)
;
Assert
.
equal
(
metadata
[
"
Test
search
engine
"
]
.
order
1
)
;
Assert
.
equal
(
metadata
[
"
A
second
test
engine
"
]
.
order
2
)
;
search
.
removeEngine
(
engine1
)
;
await
promiseAfterCache
(
)
;
info
(
"
Commit
complete
after
removeEngine
"
)
;
metadata
=
await
promiseEngineMetadata
(
)
;
Assert
.
equal
(
metadata
[
"
A
second
test
engine
"
]
.
order
1
)
;
let
engine
=
await
search
.
addEngineWithDetails
(
"
foo
"
{
alias
:
"
foo
"
method
:
"
GET
"
template
:
"
http
:
/
/
searchget
/
?
search
=
{
searchTerms
}
"
}
)
;
await
promiseAfterCache
(
)
;
info
(
"
Commit
complete
after
addEngineWithDetails
"
)
;
metadata
=
await
promiseEngineMetadata
(
)
;
Assert
.
ok
(
engine
.
aliases
.
includes
(
"
foo
"
)
)
;
Assert
.
ok
(
metadata
.
foo
.
order
>
0
)
;
}
)
;
