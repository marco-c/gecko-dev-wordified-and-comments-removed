function
promiseTimezoneMessage
(
)
{
return
new
Promise
(
resolve
=
>
{
let
listener
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIConsoleListener
]
)
observe
(
msg
)
{
if
(
msg
.
message
.
startsWith
(
"
getIsUS
(
)
fell
back
to
a
timezone
check
with
the
result
=
"
)
)
{
Services
.
console
.
unregisterListener
(
listener
)
;
resolve
(
msg
)
;
}
}
}
;
Services
.
console
.
registerListener
(
listener
)
;
}
)
;
}
add_task
(
async
function
setup
(
)
{
await
AddonTestUtils
.
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
test_location_malformed_json
(
)
{
Services
.
prefs
.
setCharPref
(
"
browser
.
search
.
geoip
.
url
"
'
data
:
application
/
json
{
"
country_code
"
'
)
;
await
Services
.
search
.
init
(
)
;
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
"
browser
.
search
.
region
"
)
"
should
be
no
region
pref
"
)
;
await
Services
.
search
.
getEngines
(
)
;
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
"
browser
.
search
.
region
"
)
"
should
be
no
region
pref
"
)
;
checkCountryResultTelemetry
(
TELEMETRY_RESULT_ENUM
.
SUCCESS_WITHOUT_DATA
)
;
let
histogram
=
Services
.
telemetry
.
getHistogramById
(
"
SEARCH_SERVICE_COUNTRY_TIMEOUT
"
)
;
let
snapshot
=
histogram
.
snapshot
(
)
;
deepEqual
(
snapshot
.
values
{
0
:
1
1
:
0
}
)
;
}
)
;
