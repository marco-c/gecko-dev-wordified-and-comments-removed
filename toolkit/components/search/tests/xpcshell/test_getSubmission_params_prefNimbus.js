"
use
strict
"
;
const
{
NimbusFeatures
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
nimbus
/
ExperimentAPI
.
sys
.
mjs
"
)
;
const
baseURL
=
"
https
:
/
/
example
.
com
/
search
?
"
;
let
getVariableStub
;
let
updateStub
;
const
CONFIG
=
[
{
identifier
:
"
preferenceEngine
"
base
:
{
urls
:
{
search
:
{
base
:
"
https
:
/
/
example
.
com
/
search
"
params
:
[
{
name
:
"
code
"
experimentConfig
:
"
code
"
}
{
name
:
"
test
"
experimentConfig
:
"
test
"
}
]
searchTermParamName
:
"
q
"
}
}
}
}
]
;
add_setup
(
async
function
(
)
{
updateStub
=
sinon
.
stub
(
NimbusFeatures
.
search
"
onUpdate
"
)
;
getVariableStub
=
sinon
.
stub
(
NimbusFeatures
.
search
"
getVariable
"
)
;
sinon
.
stub
(
NimbusFeatures
.
search
"
ready
"
)
.
resolves
(
)
;
SearchTestUtils
.
setRemoteSettingsConfig
(
CONFIG
)
;
registerCleanupFunction
(
async
(
)
=
>
{
sinon
.
restore
(
)
;
}
)
;
}
)
;
add_task
(
async
function
test_pref_initial_value
(
)
{
getVariableStub
.
withArgs
(
"
extraParams
"
)
.
returns
(
[
{
key
:
"
code
"
value
:
"
good
&
id
=
unique
"
}
]
)
;
await
Services
.
search
.
init
(
)
;
Assert
.
ok
(
updateStub
.
called
"
Should
have
called
onUpdate
to
listen
for
future
updates
"
)
;
const
engine
=
Services
.
search
.
getEngineById
(
"
preferenceEngine
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURL
+
"
code
=
good
%
26id
%
3Dunique
&
q
=
foo
"
"
Should
have
got
the
submission
URL
with
the
correct
code
"
)
;
}
)
;
add_task
(
async
function
test_pref_updated
(
)
{
getVariableStub
.
withArgs
(
"
extraParams
"
)
.
returns
(
[
{
key
:
"
code
"
value
:
"
supergood
&
id
=
unique123456
"
}
]
)
;
updateStub
.
firstCall
.
args
[
0
]
(
)
;
const
engine
=
Services
.
search
.
getEngineById
(
"
preferenceEngine
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURL
+
"
code
=
supergood
%
26id
%
3Dunique123456
&
q
=
foo
"
"
Should
have
got
the
submission
URL
with
the
updated
code
"
)
;
}
)
;
add_task
(
async
function
test_multiple_params
(
)
{
getVariableStub
.
withArgs
(
"
extraParams
"
)
.
returns
(
[
{
key
:
"
code
"
value
:
"
sng
"
}
{
key
:
"
test
"
value
:
"
sup
"
}
]
)
;
updateStub
.
firstCall
.
args
[
0
]
(
)
;
let
engine
=
Services
.
search
.
getEngineById
(
"
preferenceEngine
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURL
+
"
code
=
sng
&
test
=
sup
&
q
=
foo
"
"
Should
have
got
the
submission
URL
with
both
parameters
"
)
;
getVariableStub
.
withArgs
(
"
extraParams
"
)
.
returns
(
[
{
key
:
"
code
"
value
:
"
sng
"
}
]
)
;
updateStub
.
firstCall
.
args
[
0
]
(
)
;
engine
=
Services
.
search
.
getEngineById
(
"
preferenceEngine
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURL
+
"
code
=
sng
&
q
=
foo
"
"
Should
have
got
the
submission
URL
with
one
parameter
"
)
;
}
)
;
add_task
(
async
function
test_pref_cleared
(
)
{
getVariableStub
.
withArgs
(
"
extraParams
"
)
.
returns
(
[
]
)
;
updateStub
.
firstCall
.
args
[
0
]
(
)
;
let
engine
=
Services
.
search
.
getEngineById
(
"
preferenceEngine
"
)
;
Assert
.
equal
(
engine
.
getSubmission
(
"
foo
"
)
.
uri
.
spec
baseURL
+
"
q
=
foo
"
"
Should
have
just
the
base
URL
after
the
pref
was
cleared
"
)
;
}
)
;
