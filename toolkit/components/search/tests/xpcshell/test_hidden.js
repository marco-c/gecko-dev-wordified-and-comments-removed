const
kUrlPref
=
"
geoSpecificDefaults
.
url
"
;
function
run_test
(
)
{
removeMetadata
(
)
;
removeCacheFile
(
)
;
do_load_manifest
(
"
data
/
chrome
.
manifest
"
)
;
configureToLoadJarEngines
(
)
;
Services
.
prefs
.
setCharPref
(
"
browser
.
search
.
geoip
.
url
"
'
data
:
application
/
json
{
"
country_code
"
:
"
US
"
}
'
)
;
let
url
=
"
data
:
application
/
json
{
\
"
interval
\
"
:
31536000
\
"
settings
\
"
:
{
\
"
searchDefault
\
"
:
\
"
hidden
\
"
\
"
visibleDefaultEngines
\
"
:
[
\
"
hidden
\
"
]
}
}
"
;
Services
.
prefs
.
getDefaultBranch
(
BROWSER_SEARCH_PREF
)
.
setCharPref
(
kUrlPref
url
)
;
do_check_false
(
Services
.
search
.
isInitialized
)
;
run_next_test
(
)
;
}
add_task
(
function
*
async_init
(
)
{
let
commitPromise
=
promiseAfterCache
(
)
yield
asyncInit
(
)
;
let
engines
=
Services
.
search
.
getEngines
(
)
;
do_check_eq
(
engines
.
length
1
)
;
let
engine
=
Services
.
search
.
getEngineByName
(
"
bug645970
"
)
;
do_check_eq
(
engine
null
)
;
engine
=
Services
.
search
.
getEngineByName
(
"
hidden
"
)
;
do_check_neq
(
engine
null
)
;
yield
commitPromise
;
}
)
;
add_task
(
function
*
sync_init
(
)
{
let
reInitPromise
=
asyncReInit
(
)
;
do_check_false
(
Services
.
search
.
isInitialized
)
;
do_check_eq
(
Services
.
search
.
currentEngine
.
name
"
hidden
"
)
;
do_check_true
(
Services
.
search
.
isInitialized
)
;
let
engines
=
Services
.
search
.
getEngines
(
)
;
do_check_eq
(
engines
.
length
1
)
;
let
engine
=
Services
.
search
.
getEngineByName
(
"
bug645970
"
)
;
do_check_eq
(
engine
null
)
;
engine
=
Services
.
search
.
getEngineByName
(
"
hidden
"
)
;
do_check_neq
(
engine
null
)
;
yield
reInitPromise
;
}
)
;
add_task
(
function
*
invalid_engine
(
)
{
yield
forceExpiration
(
)
;
let
url
=
"
data
:
application
/
json
{
\
"
interval
\
"
:
31536000
\
"
settings
\
"
:
{
\
"
searchDefault
\
"
:
\
"
hidden
\
"
\
"
visibleDefaultEngines
\
"
:
[
\
"
hidden
\
"
\
"
bogus
\
"
]
}
}
"
;
Services
.
prefs
.
getDefaultBranch
(
BROWSER_SEARCH_PREF
)
.
setCharPref
(
kUrlPref
url
)
;
let
commitPromise
=
promiseAfterCache
(
)
;
yield
asyncReInit
(
)
;
let
engines
=
Services
.
search
.
getEngines
(
)
;
do_check_eq
(
engines
.
length
1
)
;
let
engine
=
Services
.
search
.
getEngineByName
(
"
bug645970
"
)
;
do_check_neq
(
engine
null
)
;
engine
=
Services
.
search
.
getEngineByName
(
"
hidden
"
)
;
do_check_eq
(
engine
null
)
;
}
)
;
