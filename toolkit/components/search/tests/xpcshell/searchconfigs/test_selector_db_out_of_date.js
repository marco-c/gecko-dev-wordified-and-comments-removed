"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
RemoteSettingsWorker
:
"
resource
:
/
/
services
-
settings
/
RemoteSettingsWorker
.
sys
.
mjs
"
}
)
;
do_get_profile
(
)
;
add_task
(
async
function
test_selector_db_out_of_date
(
)
{
let
searchConfig
=
RemoteSettings
(
SearchUtils
.
SETTINGS_KEY
)
;
await
searchConfig
.
get
(
)
;
let
db
=
searchConfig
.
db
;
await
db
.
clear
(
)
;
let
databaseEntries
=
await
db
.
list
(
)
;
Assert
.
equal
(
databaseEntries
.
length
0
"
Should
have
cleared
the
database
.
"
)
;
if
(
SearchUtils
.
newSearchConfigEnabled
)
{
await
RemoteSettingsWorker
.
_execute
(
"
_test_only_import
"
[
"
main
"
SearchUtils
.
SETTINGS_KEY
[
{
id
:
"
b70edfdd
-
1c3f
-
4b7b
-
ab55
-
38cb048636c0
"
identifier
:
"
outofdate
"
recordType
:
"
engine
"
base
:
{
}
variants
:
[
{
environment
:
{
allRegionsAndLocales
:
true
}
}
]
last_modified
:
1606227264000
}
]
1606227264000
]
)
;
}
else
{
await
RemoteSettingsWorker
.
_execute
(
"
_test_only_import
"
[
"
main
"
SearchUtils
.
SETTINGS_KEY
[
{
id
:
"
b70edfdd
-
1c3f
-
4b7b
-
ab55
-
38cb048636c0
"
default
:
"
yes
"
webExtension
:
{
id
:
"
outofdate
search
.
mozilla
.
org
"
}
appliesTo
:
[
{
included
:
{
everywhere
:
true
}
}
]
last_modified
:
1606227264000
}
]
1606227264000
]
)
;
}
let
engineSelector
=
SearchUtils
.
newSearchConfigEnabled
?
new
SearchEngineSelector
(
)
:
new
SearchEngineSelectorOld
(
)
;
let
result
=
await
engineSelector
.
fetchEngineConfiguration
(
{
locale
:
"
default
"
region
:
"
default
"
}
)
;
if
(
SearchUtils
.
newSearchConfigEnabled
)
{
Assert
.
deepEqual
(
result
.
engines
.
map
(
e
=
>
e
.
identifier
)
[
"
google
"
"
ddg
"
"
wikipedia
"
]
"
Should
have
returned
the
correct
data
.
"
)
;
}
else
{
Assert
.
deepEqual
(
result
.
engines
.
map
(
e
=
>
e
.
webExtension
.
id
)
[
"
google
search
.
mozilla
.
org
"
"
wikipedia
search
.
mozilla
.
org
"
"
ddg
search
.
mozilla
.
org
"
]
"
Should
have
returned
the
correct
data
.
"
)
;
}
}
)
;
