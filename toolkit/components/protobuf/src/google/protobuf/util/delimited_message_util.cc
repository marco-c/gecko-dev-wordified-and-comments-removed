#
include
<
google
/
protobuf
/
util
/
delimited_message_util
.
h
>
#
include
<
google
/
protobuf
/
io
/
coded_stream
.
h
>
namespace
google
{
namespace
protobuf
{
namespace
util
{
bool
SerializeDelimitedToFileDescriptor
(
const
MessageLite
&
message
int
file_descriptor
)
{
io
:
:
FileOutputStream
output
(
file_descriptor
)
;
return
SerializeDelimitedToZeroCopyStream
(
message
&
output
)
;
}
bool
SerializeDelimitedToOstream
(
const
MessageLite
&
message
std
:
:
ostream
*
output
)
{
{
io
:
:
OstreamOutputStream
zero_copy_output
(
output
)
;
if
(
!
SerializeDelimitedToZeroCopyStream
(
message
&
zero_copy_output
)
)
return
false
;
}
return
output
-
>
good
(
)
;
}
bool
ParseDelimitedFromZeroCopyStream
(
MessageLite
*
message
io
:
:
ZeroCopyInputStream
*
input
bool
*
clean_eof
)
{
io
:
:
CodedInputStream
coded_input
(
input
)
;
return
ParseDelimitedFromCodedStream
(
message
&
coded_input
clean_eof
)
;
}
bool
ParseDelimitedFromCodedStream
(
MessageLite
*
message
io
:
:
CodedInputStream
*
input
bool
*
clean_eof
)
{
if
(
clean_eof
!
=
nullptr
)
*
clean_eof
=
false
;
int
start
=
input
-
>
CurrentPosition
(
)
;
uint32_t
size
;
if
(
!
input
-
>
ReadVarint32
(
&
size
)
)
{
if
(
clean_eof
!
=
nullptr
)
*
clean_eof
=
input
-
>
CurrentPosition
(
)
=
=
start
;
return
false
;
}
int
position_after_size
=
input
-
>
CurrentPosition
(
)
;
io
:
:
CodedInputStream
:
:
Limit
limit
=
input
-
>
PushLimit
(
static_cast
<
int
>
(
size
)
)
;
if
(
!
message
-
>
MergeFromCodedStream
(
input
)
)
return
false
;
if
(
!
input
-
>
ConsumedEntireMessage
(
)
)
return
false
;
if
(
input
-
>
CurrentPosition
(
)
-
position_after_size
!
=
static_cast
<
int
>
(
size
)
)
return
false
;
input
-
>
PopLimit
(
limit
)
;
return
true
;
}
bool
SerializeDelimitedToZeroCopyStream
(
const
MessageLite
&
message
io
:
:
ZeroCopyOutputStream
*
output
)
{
io
:
:
CodedOutputStream
coded_output
(
output
)
;
return
SerializeDelimitedToCodedStream
(
message
&
coded_output
)
;
}
bool
SerializeDelimitedToCodedStream
(
const
MessageLite
&
message
io
:
:
CodedOutputStream
*
output
)
{
size_t
size
=
message
.
ByteSizeLong
(
)
;
if
(
size
>
INT_MAX
)
return
false
;
output
-
>
WriteVarint32
(
static_cast
<
uint32_t
>
(
size
)
)
;
uint8_t
*
buffer
=
output
-
>
GetDirectBufferForNBytesAndAdvance
(
static_cast
<
int
>
(
size
)
)
;
if
(
buffer
!
=
nullptr
)
{
message
.
SerializeWithCachedSizesToArray
(
buffer
)
;
}
else
{
message
.
SerializeWithCachedSizes
(
output
)
;
if
(
output
-
>
HadError
(
)
)
return
false
;
}
return
true
;
}
}
}
}
