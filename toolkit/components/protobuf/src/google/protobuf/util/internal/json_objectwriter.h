#
ifndef
GOOGLE_PROTOBUF_UTIL_INTERNAL_JSON_OBJECTWRITER_H__
#
define
GOOGLE_PROTOBUF_UTIL_INTERNAL_JSON_OBJECTWRITER_H__
#
include
<
cstdint
>
#
include
<
memory
>
#
include
<
string
>
#
include
<
google
/
protobuf
/
io
/
coded_stream
.
h
>
#
include
<
google
/
protobuf
/
stubs
/
bytestream
.
h
>
#
include
<
google
/
protobuf
/
util
/
internal
/
structured_objectwriter
.
h
>
#
include
<
google
/
protobuf
/
port_def
.
inc
>
namespace
google
{
namespace
protobuf
{
namespace
util
{
namespace
converter
{
class
PROTOBUF_EXPORT
JsonObjectWriter
:
public
StructuredObjectWriter
{
public
:
JsonObjectWriter
(
StringPiece
indent_string
io
:
:
CodedOutputStream
*
out
)
:
element_
(
new
Element
(
nullptr
false
)
)
stream_
(
out
)
sink_
(
out
)
indent_string_
(
indent_string
)
indent_char_
(
'
\
0
'
)
indent_count_
(
0
)
use_websafe_base64_for_bytes_
(
false
)
{
if
(
!
indent_string
.
empty
(
)
)
{
indent_char_
=
indent_string
[
0
]
;
indent_count_
=
indent_string
.
length
(
)
;
for
(
int
i
=
1
;
i
<
indent_string
.
length
(
)
;
i
+
+
)
{
if
(
indent_char_
!
=
indent_string_
[
i
]
)
{
indent_char_
=
'
\
0
'
;
indent_count_
=
0
;
break
;
}
}
}
}
~
JsonObjectWriter
(
)
override
;
JsonObjectWriter
*
StartObject
(
StringPiece
name
)
override
;
JsonObjectWriter
*
EndObject
(
)
override
;
JsonObjectWriter
*
StartList
(
StringPiece
name
)
override
;
JsonObjectWriter
*
EndList
(
)
override
;
JsonObjectWriter
*
RenderBool
(
StringPiece
name
bool
value
)
override
;
JsonObjectWriter
*
RenderInt32
(
StringPiece
name
int32_t
value
)
override
;
JsonObjectWriter
*
RenderUint32
(
StringPiece
name
uint32_t
value
)
override
;
JsonObjectWriter
*
RenderInt64
(
StringPiece
name
int64_t
value
)
override
;
JsonObjectWriter
*
RenderUint64
(
StringPiece
name
uint64_t
value
)
override
;
JsonObjectWriter
*
RenderDouble
(
StringPiece
name
double
value
)
override
;
JsonObjectWriter
*
RenderFloat
(
StringPiece
name
float
value
)
override
;
JsonObjectWriter
*
RenderString
(
StringPiece
name
StringPiece
value
)
override
;
JsonObjectWriter
*
RenderBytes
(
StringPiece
name
StringPiece
value
)
override
;
JsonObjectWriter
*
RenderNull
(
StringPiece
name
)
override
;
virtual
JsonObjectWriter
*
RenderNullAsEmpty
(
StringPiece
name
)
;
void
set_use_websafe_base64_for_bytes
(
bool
value
)
{
use_websafe_base64_for_bytes_
=
value
;
}
protected
:
class
PROTOBUF_EXPORT
Element
:
public
BaseElement
{
public
:
Element
(
Element
*
parent
bool
is_json_object
)
:
BaseElement
(
parent
)
is_first_
(
true
)
is_json_object_
(
is_json_object
)
{
}
bool
is_first
(
)
{
if
(
is_first_
)
{
is_first_
=
false
;
return
true
;
}
return
false
;
}
bool
is_json_object
(
)
const
{
return
is_json_object_
;
}
private
:
bool
is_first_
;
bool
is_json_object_
;
GOOGLE_DISALLOW_IMPLICIT_CONSTRUCTORS
(
Element
)
;
}
;
Element
*
element
(
)
override
{
return
element_
.
get
(
)
;
}
private
:
class
PROTOBUF_EXPORT
ByteSinkWrapper
:
public
strings
:
:
ByteSink
{
public
:
explicit
ByteSinkWrapper
(
io
:
:
CodedOutputStream
*
stream
)
:
stream_
(
stream
)
{
}
~
ByteSinkWrapper
(
)
override
{
}
void
Append
(
const
char
*
bytes
size_t
n
)
override
{
stream_
-
>
WriteRaw
(
bytes
n
)
;
}
private
:
io
:
:
CodedOutputStream
*
stream_
;
GOOGLE_DISALLOW_EVIL_CONSTRUCTORS
(
ByteSinkWrapper
)
;
}
;
JsonObjectWriter
*
RenderSimple
(
StringPiece
name
StringPiece
value
)
{
WritePrefix
(
name
)
;
WriteRawString
(
value
)
;
return
this
;
}
void
PushArray
(
)
{
element_
.
reset
(
new
Element
(
element_
.
release
(
)
false
)
)
;
}
void
PushObject
(
)
{
element_
.
reset
(
new
Element
(
element_
.
release
(
)
true
)
)
;
}
void
Pop
(
)
{
bool
needs_newline
=
!
element_
-
>
is_first
(
)
;
element_
.
reset
(
element_
-
>
pop
<
Element
>
(
)
)
;
if
(
needs_newline
)
NewLine
(
)
;
}
void
NewLine
(
)
{
if
(
!
indent_string_
.
empty
(
)
)
{
size_t
len
=
sizeof
(
'
\
n
'
)
+
(
indent_string_
.
size
(
)
*
element
(
)
-
>
level
(
)
)
;
uint8_t
*
out
=
nullptr
;
if
(
indent_count_
>
0
)
{
out
=
stream_
-
>
GetDirectBufferForNBytesAndAdvance
(
len
)
;
}
if
(
out
!
=
nullptr
)
{
out
[
0
]
=
'
\
n
'
;
memset
(
&
out
[
1
]
indent_char_
len
-
1
)
;
}
else
{
WriteChar
(
'
\
n
'
)
;
for
(
int
i
=
0
;
i
<
element
(
)
-
>
level
(
)
;
i
+
+
)
{
stream_
-
>
WriteRaw
(
indent_string_
.
c_str
(
)
indent_string_
.
length
(
)
)
;
}
}
}
}
void
WritePrefix
(
StringPiece
name
)
;
void
WriteChar
(
const
char
c
)
{
stream_
-
>
WriteRaw
(
&
c
sizeof
(
c
)
)
;
}
void
WriteRawString
(
StringPiece
s
)
{
stream_
-
>
WriteRaw
(
s
.
data
(
)
s
.
length
(
)
)
;
}
std
:
:
unique_ptr
<
Element
>
element_
;
io
:
:
CodedOutputStream
*
stream_
;
ByteSinkWrapper
sink_
;
const
std
:
:
string
indent_string_
;
char
indent_char_
;
int
indent_count_
;
bool
use_websafe_base64_for_bytes_
;
GOOGLE_DISALLOW_IMPLICIT_CONSTRUCTORS
(
JsonObjectWriter
)
;
}
;
}
}
}
}
#
include
<
google
/
protobuf
/
port_undef
.
inc
>
#
endif
