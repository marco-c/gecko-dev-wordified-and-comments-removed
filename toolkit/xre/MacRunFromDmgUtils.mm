#
include
<
AppKit
/
AppKit
.
h
>
#
include
<
ApplicationServices
/
ApplicationServices
.
h
>
#
include
<
CoreFoundation
/
CoreFoundation
.
h
>
#
include
<
CoreServices
/
CoreServices
.
h
>
#
include
<
IOKit
/
IOKitLib
.
h
>
#
include
<
string
.
h
>
#
include
<
sys
/
mount
.
h
>
#
include
<
sys
/
param
.
h
>
#
include
"
MacRunFromDmgUtils
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
mozilla
/
intl
/
Localization
.
h
"
#
include
"
nsCocoaFeatures
.
h
"
#
include
"
nsCommandLine
.
h
"
#
include
"
nsCommandLineServiceMac
.
h
"
#
include
"
nsILocalFileMac
.
h
"
#
include
"
nsIMacDockSupport
.
h
"
#
include
"
nsObjCExceptions
.
h
"
#
include
"
nsString
.
h
"
namespace
mozilla
{
namespace
MacRunFromDmgUtils
{
static
bool
AskUserIfWeShouldInstall
(
)
{
NS_OBJC_BEGIN_TRY_BLOCK_RETURN
;
nsTArray
<
nsCString
>
resIds
=
{
"
branding
/
brand
.
ftl
"
_ns
"
toolkit
/
global
/
run
-
from
-
dmg
.
ftl
"
_ns
}
;
RefPtr
<
intl
:
:
Localization
>
l10n
=
intl
:
:
Localization
:
:
Create
(
resIds
true
)
;
ErrorResult
rv
;
nsAutoCString
mozTitle
mozMessage
mozInstall
mozDontInstall
;
l10n
-
>
FormatValueSync
(
"
prompt
-
to
-
install
-
title
"
_ns
{
}
mozTitle
rv
)
;
if
(
rv
.
Failed
(
)
)
{
return
false
;
}
l10n
-
>
FormatValueSync
(
"
prompt
-
to
-
install
-
message
"
_ns
{
}
mozMessage
rv
)
;
if
(
rv
.
Failed
(
)
)
{
return
false
;
}
l10n
-
>
FormatValueSync
(
"
prompt
-
to
-
install
-
yes
-
button
"
_ns
{
}
mozInstall
rv
)
;
if
(
rv
.
Failed
(
)
)
{
return
false
;
}
l10n
-
>
FormatValueSync
(
"
prompt
-
to
-
install
-
no
-
button
"
_ns
{
}
mozDontInstall
rv
)
;
if
(
rv
.
Failed
(
)
)
{
return
false
;
}
NSString
*
title
=
[
NSString
stringWithUTF8String
:
reinterpret_cast
<
const
char
*
>
(
mozTitle
.
get
(
)
)
]
;
NSString
*
message
=
[
NSString
stringWithUTF8String
:
reinterpret_cast
<
const
char
*
>
(
mozMessage
.
get
(
)
)
]
;
NSString
*
install
=
[
NSString
stringWithUTF8String
:
reinterpret_cast
<
const
char
*
>
(
mozInstall
.
get
(
)
)
]
;
NSString
*
dontInstall
=
[
NSString
stringWithUTF8String
:
reinterpret_cast
<
const
char
*
>
(
mozDontInstall
.
get
(
)
)
]
;
NSAlert
*
alert
=
[
[
[
NSAlert
alloc
]
init
]
autorelease
]
;
[
alert
setAlertStyle
:
NSAlertStyleInformational
]
;
[
alert
setMessageText
:
title
]
;
[
alert
setInformativeText
:
message
]
;
[
alert
addButtonWithTitle
:
install
]
;
NSButton
*
dontInstallButton
=
[
alert
addButtonWithTitle
:
dontInstall
]
;
[
dontInstallButton
setKeyEquivalent
:
"
\
e
"
]
;
NSInteger
result
=
[
alert
runModal
]
;
return
result
=
=
NSAlertFirstButtonReturn
;
NS_OBJC_END_TRY_BLOCK_RETURN
(
false
)
;
}
bool
IsAppRunningFromDmg
(
)
{
NS_OBJC_BEGIN_TRY_BLOCK_RETURN
;
const
char
*
path
=
[
[
[
NSBundle
mainBundle
]
bundlePath
]
fileSystemRepresentation
]
;
struct
statfs
statfsBuf
;
if
(
statfs
(
path
&
statfsBuf
)
!
=
0
)
{
return
false
;
}
if
(
!
(
statfsBuf
.
f_flags
&
MNT_RDONLY
)
)
{
return
false
;
}
const
char
devDirPath
[
]
=
"
/
dev
/
"
;
const
int
devDirPathLength
=
strlen
(
devDirPath
)
;
if
(
strncmp
(
statfsBuf
.
f_mntfromname
devDirPath
devDirPathLength
)
!
=
0
)
{
return
false
;
}
const
char
*
bsdDeviceName
=
statfsBuf
.
f_mntfromname
+
devDirPathLength
;
CFMutableDictionaryRef
serviceDict
=
IOBSDNameMatching
(
kIOMasterPortDefault
0
bsdDeviceName
)
;
if
(
!
serviceDict
)
{
return
false
;
}
io_service_t
media
=
IOServiceGetMatchingService
(
kIOMasterPortDefault
serviceDict
)
;
if
(
!
media
|
|
!
IOObjectConformsTo
(
media
"
IOMedia
"
)
)
{
return
false
;
}
io_service_t
imageDrive
=
IO_OBJECT_NULL
;
io_iterator_t
iter
;
if
(
IORegistryEntryCreateIterator
(
media
kIOServicePlane
kIORegistryIterateRecursively
|
kIORegistryIterateParents
&
iter
)
!
=
KERN_SUCCESS
)
{
IOObjectRelease
(
media
)
;
return
false
;
}
const
char
*
imageClass
=
nsCocoaFeatures
:
:
macOSVersionMajor
(
)
>
=
12
?
"
AppleDiskImageDevice
"
:
"
IOHDIXHDDrive
"
;
for
(
imageDrive
=
media
;
imageDrive
;
imageDrive
=
IOIteratorNext
(
iter
)
)
{
if
(
IOObjectConformsTo
(
imageDrive
imageClass
)
)
{
break
;
}
IOObjectRelease
(
imageDrive
)
;
}
IOObjectRelease
(
iter
)
;
if
(
imageDrive
)
{
IOObjectRelease
(
imageDrive
)
;
return
true
;
}
return
false
;
NS_OBJC_END_TRY_BLOCK_RETURN
(
false
)
;
}
}
}
