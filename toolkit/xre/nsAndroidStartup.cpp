#
include
<
android
/
log
.
h
>
#
include
<
jni
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
string
.
h
>
#
include
<
pthread
.
h
>
#
include
"
mozilla
/
jni
/
Utils
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsAppRunner
.
h
"
#
include
"
mozilla
/
Bootstrap
.
h
"
#
include
"
XREShellData
.
h
"
#
define
LOG
(
args
.
.
.
)
__android_log_print
(
ANDROID_LOG_INFO
MOZ_APP_NAME
args
)
using
namespace
mozilla
;
extern
"
C
"
NS_EXPORT
void
GeckoStart
(
JNIEnv
*
env
char
*
*
argv
int
argc
const
StaticXREAppData
&
aAppData
bool
xpcshell
const
char
*
outFilePath
)
{
mozilla
:
:
jni
:
:
SetGeckoThreadEnv
(
env
)
;
if
(
!
argv
)
{
LOG
(
"
Failed
to
get
arguments
for
GeckoStart
\
n
"
)
;
return
;
}
if
(
xpcshell
)
{
XREShellData
shellData
;
FILE
*
outFile
=
fopen
(
outFilePath
"
w
"
)
;
if
(
!
outFile
)
{
LOG
(
"
XRE_XPCShellMain
cannot
open
%
s
"
outFilePath
)
;
return
;
}
shellData
.
outFile
=
outFile
;
shellData
.
errFile
=
outFile
;
int
result
=
XRE_XPCShellMain
(
argc
argv
nullptr
&
shellData
)
;
fclose
(
shellData
.
outFile
)
;
if
(
result
)
LOG
(
"
XRE_XPCShellMain
returned
%
d
"
result
)
;
}
else
{
BootstrapConfig
config
;
config
.
appData
=
&
aAppData
;
config
.
appDataPath
=
nullptr
;
int
result
=
XRE_main
(
argc
argv
config
)
;
if
(
result
)
LOG
(
"
XRE_main
returned
%
d
"
result
)
;
}
}
