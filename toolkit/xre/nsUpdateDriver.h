#
ifndef
nsUpdateDriver_h__
#
define
nsUpdateDriver_h__
#
include
"
nscore
.
h
"
#
include
"
nsIUpdateService
.
h
"
#
include
"
nsIThread
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsString
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
class
nsIFile
;
#
if
defined
(
XP_WIN
)
#
include
<
windows
.
h
>
#
include
"
mozilla
/
WinHandleWatcher
.
h
"
typedef
HANDLE
ProcessType
;
#
elif
defined
(
XP_UNIX
)
typedef
pid_t
ProcessType
;
#
else
#
include
"
prproces
.
h
"
typedef
PRProcess
*
ProcessType
;
#
endif
#
ifdef
XP_WIN
#
define
UPDATER_BIN
"
updater
.
exe
"
#
define
MAINTENANCE_SVC_NAME
L
"
MozillaMaintenance
"
#
define
MAYBE_WAIT_TIMEOUT_MS
(
60U
*
1000U
)
#
elif
XP_MACOSX
#
define
UPDATER_APP
"
updater
.
app
"
#
define
UPDATER_BIN
"
org
.
mozilla
.
updater
"
#
else
#
define
UPDATER_BIN
"
updater
"
#
endif
nsresult
ProcessUpdates
(
nsIFile
*
greDir
nsIFile
*
appDir
nsIFile
*
updRootDir
int
argc
char
*
*
argv
const
char
*
appVersion
bool
restart
=
true
ProcessType
*
pid
=
nullptr
)
;
nsresult
IsMultiSessionInstallLockoutActive
(
nsIFile
*
updRootDir
bool
&
isActive
)
;
nsresult
WriteUpdateCompleteTestFile
(
nsIFile
*
updRootDir
)
;
class
nsUpdateProcessor
final
:
public
nsIUpdateProcessor
{
public
:
nsUpdateProcessor
(
)
;
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIUPDATEPROCESSOR
private
:
~
nsUpdateProcessor
(
)
;
struct
StagedUpdateInfo
{
StagedUpdateInfo
(
)
:
mArgc
(
0
)
mArgv
(
nullptr
)
{
}
~
StagedUpdateInfo
(
)
{
for
(
int
i
=
0
;
i
<
mArgc
;
+
+
i
)
{
delete
[
]
mArgv
[
i
]
;
}
delete
[
]
mArgv
;
}
nsCOMPtr
<
nsIFile
>
mGREDir
;
nsCOMPtr
<
nsIFile
>
mAppDir
;
nsCOMPtr
<
nsIFile
>
mUpdateRoot
;
int
mArgc
;
char
*
*
mArgv
;
nsCString
mAppVersion
;
}
;
private
:
void
StartStagedUpdate
(
)
;
void
UpdateDone
(
)
;
void
ShutdownWorkerThread
(
)
;
#
ifndef
XP_WIN
void
WaitForProcess
(
)
;
#
endif
private
:
ProcessType
mUpdaterPID
;
nsCOMPtr
<
nsIThread
>
mWorkerThread
;
#
ifdef
XP_WIN
mozilla
:
:
HandleWatcher
mProcessWatcher
;
#
endif
StagedUpdateInfo
mInfo
;
}
;
#
endif
