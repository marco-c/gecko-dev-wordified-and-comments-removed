const
{
BrowserUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
BrowserUtils
.
jsm
"
)
;
const
{
Region
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Region
.
jsm
"
)
;
const
initialHomeRegion
=
Region
.
_home
;
const
initialCurrentRegion
=
Region
.
_current
;
function
setupRegions
(
home
current
)
{
Region
.
_setHomeRegion
(
home
|
|
"
"
)
;
Region
.
_setCurrentRegion
(
current
|
|
"
"
)
;
}
add_task
(
async
function
test_shouldShowVPNPromo
(
)
{
function
setPromoEnabled
(
enabled
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
vpn_promo
.
enabled
"
enabled
)
;
}
const
allowedRegion
=
"
US
"
;
const
disallowedRegion
=
"
SY
"
;
const
illegalRegion
=
"
CN
"
;
const
unsupportedRegion
=
"
LY
"
;
setupRegions
(
allowedRegion
allowedRegion
)
;
Assert
.
ok
(
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setPromoEnabled
(
false
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setPromoEnabled
(
true
)
;
setupRegions
(
disallowedRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setupRegions
(
illegalRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setupRegions
(
allowedRegion
disallowedRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setupRegions
(
allowedRegion
illegalRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setupRegions
(
allowedRegion
unsupportedRegion
)
;
Assert
.
ok
(
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setupRegions
(
unsupportedRegion
allowedRegion
)
;
Assert
.
ok
(
BrowserUtils
.
shouldShowVPNPromo
(
)
)
;
setupRegions
(
initialHomeRegion
initialCurrentRegion
)
;
}
)
;
add_task
(
async
function
test_shouldShowRallyPromo
(
)
{
const
initialLanguage
=
Services
.
locale
.
appLocaleAsBCP47
;
const
allowedRegion
=
"
US
"
;
const
disallowedRegion
=
"
CN
"
;
const
allowedLanguage
=
"
en
-
US
"
;
const
disallowedLanguage
=
"
fr
"
;
function
setLanguage
(
language
)
{
Services
.
locale
.
availableLocales
=
[
language
]
;
Services
.
locale
.
requestedLocales
=
[
language
]
;
}
setupRegions
(
allowedRegion
allowedRegion
)
;
setLanguage
(
allowedLanguage
)
;
Assert
.
ok
(
BrowserUtils
.
shouldShowRallyPromo
(
)
)
;
setupRegions
(
disallowedRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowRallyPromo
(
)
)
;
setLanguage
(
disallowedLanguage
)
;
setupRegions
(
allowedRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowRallyPromo
(
)
)
;
setupRegions
(
disallowedRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowRallyPromo
(
)
)
;
setupRegions
(
allowedRegion
disallowedRegion
)
;
Assert
.
ok
(
!
BrowserUtils
.
shouldShowRallyPromo
(
)
)
;
setupRegions
(
initialHomeRegion
initialCurrentRegion
)
;
setLanguage
(
initialLanguage
)
;
}
)
;
