"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Integration
.
jsm
"
this
)
;
const
TestIntegration
=
{
value
:
"
value
"
get
valueFromThis
(
)
{
return
this
.
value
;
}
get
property
(
)
{
return
this
.
_property
;
}
set
property
(
value
)
{
this
.
_property
=
value
;
}
method
(
argument
)
{
this
.
methodArgument
=
argument
;
return
"
method
"
+
argument
;
}
async
asyncMethod
(
argument
)
{
this
.
asyncMethodArgument
=
argument
;
return
"
asyncMethod
"
+
argument
;
}
}
;
let
overrideFn
=
base
=
>
(
{
value
:
"
overridden
-
value
"
get
property
(
)
{
return
"
overridden
-
"
+
base
.
__lookupGetter__
(
"
property
"
)
.
call
(
this
)
;
}
set
property
(
value
)
{
base
.
__lookupSetter__
(
"
property
"
)
.
call
(
this
"
overridden
-
"
+
value
)
;
}
method
(
)
{
return
"
overridden
-
"
+
base
.
method
.
apply
(
this
arguments
)
;
}
async
asyncMethod
(
)
{
return
"
overridden
-
"
+
(
await
base
.
asyncMethod
.
apply
(
this
arguments
)
)
;
}
}
)
;
let
superOverrideFn
=
base
=
>
(
{
__proto__
:
base
value
:
"
overridden
-
value
"
get
property
(
)
{
return
"
overridden
-
"
+
super
.
property
;
}
set
property
(
value
)
{
super
.
property
=
"
overridden
-
"
+
value
;
}
method
(
)
{
return
"
overridden
-
"
+
super
.
method
(
.
.
.
arguments
)
;
}
async
asyncMethod
(
)
{
return
"
overridden
-
"
+
(
await
base
.
asyncMethod
.
apply
(
this
arguments
)
)
;
}
}
)
;
async
function
assertCombinedResults
(
combined
overridesCount
)
{
let
expectedValue
=
overridesCount
>
0
?
"
overridden
-
value
"
:
"
value
"
;
let
prefix
=
"
overridden
-
"
.
repeat
(
overridesCount
)
;
Assert
.
equal
(
combined
.
value
expectedValue
)
;
Assert
.
equal
(
combined
.
valueFromThis
expectedValue
)
;
combined
.
property
=
"
property
"
;
Assert
.
equal
(
combined
.
property
prefix
.
repeat
(
2
)
+
"
property
"
)
;
combined
.
methodArgument
=
"
"
;
Assert
.
equal
(
combined
.
method
(
"
-
argument
"
)
prefix
+
"
method
-
argument
"
)
;
Assert
.
equal
(
combined
.
methodArgument
"
-
argument
"
)
;
combined
.
asyncMethodArgument
=
"
"
;
Assert
.
equal
(
await
combined
.
asyncMethod
(
"
-
argument
"
)
prefix
+
"
asyncMethod
-
argument
"
)
;
Assert
.
equal
(
combined
.
asyncMethodArgument
"
-
argument
"
)
;
}
async
function
assertCurrentCombinedResults
(
overridesCount
)
{
let
combined
=
Integration
.
testModule
.
getCombined
(
TestIntegration
)
;
await
assertCombinedResults
(
combined
overridesCount
)
;
}
add_task
(
async
function
test_base
(
)
{
await
assertCurrentCombinedResults
(
0
)
;
}
)
;
add_task
(
async
function
test_override
(
)
{
Integration
.
testModule
.
register
(
overrideFn
)
;
await
assertCurrentCombinedResults
(
1
)
;
Integration
.
testModule
.
register
(
overrideFn
)
;
await
assertCurrentCombinedResults
(
1
)
;
Integration
.
testModule
.
unregister
(
overrideFn
)
;
await
assertCurrentCombinedResults
(
0
)
;
}
)
;
add_task
(
async
function
test_override_super_multiple
(
)
{
Integration
.
testModule
.
register
(
overrideFn
)
;
Integration
.
testModule
.
register
(
superOverrideFn
)
;
await
assertCurrentCombinedResults
(
2
)
;
Integration
.
testModule
.
unregister
(
overrideFn
)
;
await
assertCurrentCombinedResults
(
1
)
;
Integration
.
testModule
.
unregister
(
superOverrideFn
)
;
await
assertCurrentCombinedResults
(
0
)
;
}
)
;
add_task
(
async
function
test_override_error
(
)
{
let
errorOverrideFn
=
base
=
>
{
throw
"
Expected
error
.
"
;
}
;
Integration
.
testModule
.
register
(
errorOverrideFn
)
;
Integration
.
testModule
.
register
(
overrideFn
)
;
await
assertCurrentCombinedResults
(
1
)
;
Integration
.
testModule
.
unregister
(
errorOverrideFn
)
;
Integration
.
testModule
.
unregister
(
overrideFn
)
;
await
assertCurrentCombinedResults
(
0
)
;
}
)
;
add_task
(
async
function
test_state_preserved
(
)
{
let
valueObject
=
{
toString
:
(
)
=
>
"
toString
"
}
;
let
combined
=
Integration
.
testModule
.
getCombined
(
TestIntegration
)
;
combined
.
property
=
valueObject
;
Assert
.
ok
(
combined
.
property
=
=
=
valueObject
)
;
Integration
.
testModule
.
register
(
overrideFn
)
;
combined
=
Integration
.
testModule
.
getCombined
(
TestIntegration
)
;
Assert
.
equal
(
combined
.
property
"
overridden
-
toString
"
)
;
Integration
.
testModule
.
unregister
(
overrideFn
)
;
combined
=
Integration
.
testModule
.
getCombined
(
TestIntegration
)
;
Assert
.
ok
(
combined
.
property
=
=
=
valueObject
)
;
}
)
;
add_task
(
async
function
test_xpcom_throws
(
)
{
let
combined
=
Integration
.
testModule
.
getCombined
(
TestIntegration
)
;
Assert
.
throws
(
(
)
=
>
Services
.
obs
.
addObserver
(
combined
"
test
-
topic
"
true
)
/
NS_NOINTERFACE
/
)
;
}
)
;
add_task
(
async
function
test_defineModuleGetter
(
)
{
let
objectForGetters
=
{
}
;
Integration
.
testModule
.
defineModuleGetter
(
objectForGetters
"
TestIntegration
"
"
resource
:
/
/
testing
-
common
/
TestIntegration
.
jsm
"
)
;
Integration
.
testModule
.
defineModuleGetter
(
objectForGetters
"
integration
"
"
resource
:
/
/
testing
-
common
/
TestIntegration
.
jsm
"
"
TestIntegration
"
)
;
Integration
.
testModule
.
register
(
overrideFn
)
;
await
assertCombinedResults
(
objectForGetters
.
integration
1
)
;
await
assertCombinedResults
(
objectForGetters
.
TestIntegration
1
)
;
Integration
.
testModule
.
unregister
(
overrideFn
)
;
await
assertCombinedResults
(
objectForGetters
.
integration
0
)
;
await
assertCombinedResults
(
objectForGetters
.
TestIntegration
0
)
;
}
)
;
