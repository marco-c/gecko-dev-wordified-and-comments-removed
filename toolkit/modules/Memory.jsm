var
EXPORTED_SYMBOLS
=
[
"
Memory
"
]
;
const
TIMEOUT_INTERVAL
=
2000
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
setTimeout
clearTimeout
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
memory
"
"
mozilla
.
org
/
memory
-
reporter
-
manager
;
1
"
"
nsIMemoryReporterManager
"
)
;
var
Memory
=
{
summary
(
)
{
if
(
!
this
.
_pendingPromise
)
{
this
.
_pendingPromise
=
new
Promise
(
resolve
=
>
{
this
.
_pendingResolve
=
resolve
;
this
.
_summaries
=
{
}
;
this
.
_origChildCount
=
Services
.
ppmm
.
childCount
;
Services
.
ppmm
.
broadcastAsyncMessage
(
"
Memory
:
GetSummary
"
)
;
Services
.
ppmm
.
addMessageListener
(
"
Memory
:
Summary
"
this
)
;
this
.
_pendingTimeout
=
setTimeout
(
(
)
=
>
{
this
.
finish
(
)
;
}
TIMEOUT_INTERVAL
)
;
}
)
;
}
return
this
.
_pendingPromise
;
}
receiveMessage
(
msg
)
{
if
(
msg
.
name
!
=
"
Memory
:
Summary
"
|
|
!
this
.
_pendingResolve
)
{
return
;
}
this
.
_summaries
[
msg
.
data
.
pid
]
=
msg
.
data
.
summary
;
if
(
Object
.
keys
(
this
.
_summaries
)
.
length
>
=
Math
.
min
(
this
.
_origChildCount
Services
.
ppmm
.
childCount
)
-
1
)
{
this
.
finish
(
)
;
}
}
finish
(
)
{
let
rss
=
memory
.
resident
;
let
uss
=
memory
.
residentUnique
;
let
ghosts
=
memory
.
ghostWindows
;
this
.
_summaries
.
Parent
=
{
uss
rss
ghosts
}
;
this
.
_pendingResolve
(
this
.
_summaries
)
;
this
.
_pendingResolve
=
null
;
this
.
_summaries
=
null
;
this
.
_pendingPromise
=
null
;
clearTimeout
(
this
.
_pendingTimeout
)
;
Services
.
ppmm
.
removeMessageListener
(
"
Memory
:
Summary
"
this
)
;
}
}
;
