"
use
strict
"
;
const
FILE_ENTRY
=
"
201
:
"
;
onmessage
=
async
function
(
msg
)
{
try
{
let
extractedPaths
=
[
]
;
let
jarPath
=
"
jar
:
"
+
msg
.
data
.
zipURI
+
"
!
/
"
;
let
jarResponse
=
await
fetch
(
jarPath
)
;
let
dirListing
=
await
jarResponse
.
text
(
)
;
let
lines
=
dirListing
.
split
(
"
\
n
"
)
;
let
reader
=
new
FileReader
(
)
;
for
(
let
line
of
lines
)
{
if
(
!
line
.
startsWith
(
FILE_ENTRY
)
)
{
continue
;
}
let
lineSplits
=
line
.
split
(
"
"
)
;
let
fileName
=
lineSplits
[
1
]
;
if
(
fileName
=
=
"
verified_contents
.
json
"
|
|
fileName
=
=
"
icon
-
128x128
.
png
"
)
{
continue
;
}
let
filePath
=
jarPath
+
fileName
;
let
filePathResponse
=
await
fetch
(
filePath
)
;
let
fileContents
=
await
filePathResponse
.
blob
(
)
;
let
fileData
=
await
new
Promise
(
resolve
=
>
{
reader
.
onloadend
=
function
(
)
{
resolve
(
reader
.
result
)
;
}
;
reader
.
readAsArrayBuffer
(
fileContents
)
;
}
)
;
let
installToDirPath
=
PathUtils
.
join
(
await
PathUtils
.
getProfileDir
(
)
.
.
.
msg
.
data
.
relativeInstallPath
)
;
await
IOUtils
.
makeDirectory
(
installToDirPath
)
;
let
destPath
=
PathUtils
.
join
(
installToDirPath
fileName
)
;
await
IOUtils
.
write
(
destPath
new
Uint8Array
(
fileData
)
{
tmpPath
:
destPath
+
"
.
tmp
"
}
)
;
await
IOUtils
.
setPermissions
(
destPath
0o700
)
;
if
(
IOUtils
.
removeMacXAttr
)
{
try
{
await
IOUtils
.
removeMacXAttr
(
destPath
"
com
.
apple
.
quarantine
"
)
;
}
catch
(
e
)
{
}
}
extractedPaths
.
push
(
destPath
)
;
}
postMessage
(
{
result
:
"
success
"
extractedPaths
}
)
;
}
catch
(
e
)
{
postMessage
(
{
result
:
"
fail
"
exception
:
e
.
message
}
)
;
}
}
;
