var
EXPORTED_SYMBOLS
=
[
"
FirstStartup
"
]
;
const
{
AppConstants
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
Normandy
:
"
resource
:
/
/
normandy
/
Normandy
.
jsm
"
}
)
;
const
PREF_TIMEOUT
=
"
first
-
startup
.
timeout
"
;
const
PROBE_NAME
=
"
firstStartup
.
statusCode
"
;
var
FirstStartup
=
{
NOT_STARTED
:
0
IN_PROGRESS
:
1
TIMED_OUT
:
2
SUCCESS
:
3
_state
:
this
.
NOT_STARTED
init
(
)
{
this
.
_state
=
this
.
IN_PROGRESS
;
const
timeout
=
Services
.
prefs
.
getIntPref
(
PREF_TIMEOUT
5000
)
;
let
expiredTime
=
Date
.
now
(
)
+
timeout
;
if
(
AppConstants
.
MOZ_NORMANDY
)
{
let
normandyInitialized
=
false
;
Normandy
.
init
(
{
runAsync
:
false
}
)
.
then
(
(
)
=
>
(
normandyInitialized
=
true
)
)
;
Services
.
tm
.
spinEventLoopUntil
(
(
)
=
>
{
if
(
Date
.
now
(
)
>
=
expiredTime
)
{
this
.
_state
=
this
.
TIMED_OUT
;
return
true
;
}
else
if
(
normandyInitialized
)
{
this
.
_state
=
this
.
SUCCESS
;
return
true
;
}
return
false
;
}
)
;
Services
.
telemetry
.
scalarSet
(
PROBE_NAME
this
.
_state
)
;
}
}
get
state
(
)
{
return
this
.
_state
;
}
}
;
