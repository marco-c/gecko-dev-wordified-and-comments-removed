var
EXPORTED_SYMBOLS
=
[
"
PrivateBrowsingUtils
"
]
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
function
PrivateBrowsingContentBlockingAllowList
(
)
{
Services
.
obs
.
addObserver
(
this
"
last
-
pb
-
context
-
exited
"
true
)
;
}
PrivateBrowsingContentBlockingAllowList
.
prototype
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIObserver
Ci
.
nsISupportsWeakReference
]
)
addToAllowList
(
uri
)
{
Services
.
perms
.
add
(
uri
"
trackingprotection
-
pb
"
Ci
.
nsIPermissionManager
.
ALLOW_ACTION
Ci
.
nsIPermissionManager
.
EXPIRE_SESSION
)
;
}
removeFromAllowList
(
uri
)
{
Services
.
perms
.
remove
(
uri
"
trackingprotection
-
pb
"
)
;
}
observe
(
subject
topic
data
)
{
if
(
topic
=
=
"
last
-
pb
-
context
-
exited
"
)
{
Services
.
perms
.
removeByType
(
"
trackingprotection
-
pb
"
)
;
}
}
}
;
const
kAutoStartPref
=
"
browser
.
privatebrowsing
.
autostart
"
;
var
gTemporaryAutoStartMode
=
false
;
var
PrivateBrowsingUtils
=
{
get
enabled
(
)
{
return
Services
.
policies
.
isAllowed
(
"
privatebrowsing
"
)
;
}
isWindowPrivate
:
function
pbu_isWindowPrivate
(
aWindow
)
{
if
(
!
aWindow
.
isChromeWindow
)
{
dump
(
"
WARNING
:
content
window
passed
to
PrivateBrowsingUtils
.
isWindowPrivate
.
"
+
"
Use
isContentWindowPrivate
instead
(
but
only
for
frame
scripts
)
.
\
n
"
+
new
Error
(
)
.
stack
)
;
}
return
this
.
privacyContextFromWindow
(
aWindow
)
.
usePrivateBrowsing
;
}
isContentWindowPrivate
:
function
pbu_isWindowPrivate
(
aWindow
)
{
return
this
.
privacyContextFromWindow
(
aWindow
)
.
usePrivateBrowsing
;
}
isBrowserPrivate
(
aBrowser
)
{
let
chromeWin
=
aBrowser
.
ownerGlobal
;
if
(
chromeWin
.
gMultiProcessBrowser
|
|
!
aBrowser
.
contentWindow
)
{
return
this
.
isWindowPrivate
(
chromeWin
)
;
}
return
this
.
privacyContextFromWindow
(
aBrowser
.
contentWindow
)
.
usePrivateBrowsing
;
}
privacyContextFromWindow
:
function
pbu_privacyContextFromWindow
(
aWindow
)
{
return
aWindow
.
docShell
.
QueryInterface
(
Ci
.
nsILoadContext
)
;
}
get
_pbCBAllowList
(
)
{
delete
this
.
_pbCBAllowList
;
return
this
.
_pbCBAllowList
=
new
PrivateBrowsingContentBlockingAllowList
(
)
;
}
addToTrackingAllowlist
(
aURI
)
{
this
.
_pbCBAllowList
.
addToAllowList
(
aURI
)
;
}
removeFromTrackingAllowlist
(
aURI
)
{
this
.
_pbCBAllowList
.
removeFromAllowList
(
aURI
)
;
}
get
permanentPrivateBrowsing
(
)
{
try
{
return
gTemporaryAutoStartMode
|
|
Services
.
prefs
.
getBoolPref
(
kAutoStartPref
)
;
}
catch
(
e
)
{
return
false
;
}
}
enterTemporaryAutoStartMode
:
function
pbu_enterTemporaryAutoStartMode
(
)
{
gTemporaryAutoStartMode
=
true
;
}
get
isInTemporaryAutoStartMode
(
)
{
return
gTemporaryAutoStartMode
;
}
}
;
