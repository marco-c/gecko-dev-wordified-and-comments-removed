#
ifndef
mozilla_recordreplay_ThreadSnapshot_h
#
define
mozilla_recordreplay_ThreadSnapshot_h
#
include
"
File
.
h
"
#
include
"
Thread
.
h
"
namespace
mozilla
{
namespace
recordreplay
{
bool
SaveThreadState
(
size_t
aId
int
*
aStackSeparator
)
;
struct
SavedThreadStack
{
void
*
mStackPointer
;
uint8_t
*
mStack
;
size_t
mStackBytes
;
jmp_buf
mRegisters
;
SavedThreadStack
(
)
{
PodZero
(
this
)
;
}
void
ReleaseContents
(
)
{
if
(
mStackBytes
)
{
DeallocateMemory
(
mStack
mStackBytes
UntrackedMemoryKind
:
:
ThreadSnapshot
)
;
}
}
}
;
struct
SavedCheckpoint
{
CheckpointId
mCheckpoint
;
SavedThreadStack
mStacks
[
MaxRecordedThreadId
]
;
explicit
SavedCheckpoint
(
CheckpointId
aCheckpoint
)
:
mCheckpoint
(
aCheckpoint
)
{
}
void
ReleaseContents
(
)
{
for
(
SavedThreadStack
&
stack
:
mStacks
)
{
stack
.
ReleaseContents
(
)
;
}
}
}
;
bool
SaveAllThreads
(
SavedCheckpoint
&
aSavedCheckpoint
)
;
void
RestoreAllThreads
(
const
SavedCheckpoint
&
aSavedCheckpoint
)
;
void
WaitForIdleThreadsToRestoreTheirStacks
(
)
;
bool
ShouldRestoreThreadStack
(
size_t
aId
)
;
void
RestoreThreadStack
(
size_t
aId
)
;
void
InitializeThreadSnapshots
(
size_t
aNumThreads
)
;
}
}
#
endif
