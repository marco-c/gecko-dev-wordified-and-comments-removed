#
ifndef
mozilla_recordreplay_Channel_h
#
define
mozilla_recordreplay_Channel_h
#
include
"
base
/
process
.
h
"
#
include
"
mozilla
/
gfx
/
Types
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
File
.
h
"
#
include
"
JSControl
.
h
"
#
include
"
MiddlemanCall
.
h
"
#
include
"
Monitor
.
h
"
namespace
mozilla
{
namespace
recordreplay
{
#
define
ForEachMessageType
(
_Macro
)
\
_Macro
(
Introduction
)
\
\
/
*
Sent
to
recording
processes
to
indicate
that
the
middleman
will
be
running
*
/
\
/
*
developer
tools
server
-
side
code
instead
of
the
recording
process
itself
.
*
/
\
_Macro
(
SetDebuggerRunsInMiddleman
)
\
\
/
*
Periodically
sent
to
replaying
processes
to
make
sure
they
are
*
/
\
/
*
responsive
and
determine
how
much
progress
they
have
made
.
This
can
be
*
/
\
/
*
sent
while
the
process
is
unpaused
but
only
when
it
will
not
be
*
/
\
/
*
rewinding
.
*
/
\
_Macro
(
Ping
)
\
\
/
*
Sent
to
recording
processes
when
exiting
or
to
force
a
hanged
replaying
*
/
\
/
*
process
to
crash
.
*
/
\
_Macro
(
Terminate
)
\
\
/
*
Poke
a
child
that
is
recording
to
create
an
artificial
checkpoint
rather
than
*
/
\
/
*
(
potentially
)
idling
indefinitely
.
This
has
no
effect
on
a
replaying
process
.
*
/
\
_Macro
(
CreateCheckpoint
)
\
\
/
*
Unpause
the
child
and
perform
a
debugger
-
defined
operation
.
*
/
\
_Macro
(
ManifestStart
)
\
\
/
*
Respond
to
a
MiddlemanCallRequest
message
.
*
/
\
_Macro
(
MiddlemanCallResponse
)
\
\
/
*
Messages
sent
from
the
child
process
to
the
middleman
.
*
/
\
\
/
*
Pause
after
executing
a
manifest
specifying
its
response
.
*
/
\
_Macro
(
ManifestFinished
)
\
\
/
*
Respond
to
a
ping
message
*
/
\
_Macro
(
PingResponse
)
\
\
/
*
A
critical
error
occurred
and
execution
cannot
continue
.
The
child
will
*
/
\
/
*
stop
executing
after
sending
this
message
and
will
wait
to
be
terminated
.
*
/
\
/
*
A
minidump
for
the
child
has
been
generated
.
*
/
\
_Macro
(
FatalError
)
\
\
/
*
Sent
when
a
fatal
error
has
occurred
but
before
the
minidump
has
been
*
/
\
/
*
generated
.
*
/
\
_Macro
(
BeginFatalError
)
\
\
/
*
The
child
'
s
graphics
were
repainted
.
*
/
\
_Macro
(
Paint
)
\
\
/
*
Call
a
system
function
from
the
middleman
process
which
the
child
has
*
/
\
/
*
encountered
after
diverging
from
the
recording
.
*
/
\
_Macro
(
MiddlemanCallRequest
)
\
\
/
*
Reset
all
information
generated
by
previous
MiddlemanCallRequest
messages
.
*
/
\
_Macro
(
ResetMiddlemanCalls
)
enum
class
MessageType
{
#
define
DefineEnum
(
Kind
)
Kind
ForEachMessageType
(
DefineEnum
)
#
undef
DefineEnum
}
;
struct
Message
{
MessageType
mType
;
uint32_t
mReceiveTime
;
uint32_t
mSize
;
protected
:
Message
(
MessageType
aType
uint32_t
aSize
)
:
mType
(
aType
)
mReceiveTime
(
0
)
mSize
(
aSize
)
{
MOZ_RELEASE_ASSERT
(
mSize
>
=
sizeof
(
*
this
)
)
;
}
public
:
struct
FreePolicy
{
void
operator
(
)
(
Message
*
msg
)
{
}
}
;
typedef
UniquePtr
<
Message
FreePolicy
>
UniquePtr
;
UniquePtr
Clone
(
)
const
{
Message
*
res
=
static_cast
<
Message
*
>
(
malloc
(
mSize
)
)
;
memcpy
(
res
this
mSize
)
;
return
UniquePtr
(
res
)
;
}
const
char
*
TypeString
(
)
const
{
switch
(
mType
)
{
#
define
EnumToString
(
Kind
)
\
case
MessageType
:
:
Kind
:
\
return
#
Kind
;
ForEachMessageType
(
EnumToString
)
#
undef
EnumToString
default
:
return
"
Unknown
"
;
}
}
bool
CanBeSentWhileUnpaused
(
)
const
{
return
mType
=
=
MessageType
:
:
CreateCheckpoint
|
|
mType
=
=
MessageType
:
:
SetDebuggerRunsInMiddleman
|
|
mType
=
=
MessageType
:
:
MiddlemanCallResponse
|
|
mType
=
=
MessageType
:
:
Ping
|
|
mType
=
=
MessageType
:
:
Terminate
|
|
mType
=
=
MessageType
:
:
Introduction
;
}
protected
:
template
<
typename
T
typename
Elem
>
Elem
*
Data
(
)
{
return
(
Elem
*
)
(
sizeof
(
T
)
+
(
char
*
)
this
)
;
}
template
<
typename
T
typename
Elem
>
const
Elem
*
Data
(
)
const
{
return
(
const
Elem
*
)
(
sizeof
(
T
)
+
(
const
char
*
)
this
)
;
}
template
<
typename
T
typename
Elem
>
size_t
DataSize
(
)
const
{
return
(
mSize
-
sizeof
(
T
)
)
/
sizeof
(
Elem
)
;
}
template
<
typename
T
typename
Elem
typename
.
.
.
Args
>
static
T
*
NewWithData
(
size_t
aBufferSize
Args
&
&
.
.
.
aArgs
)
{
size_t
size
=
sizeof
(
T
)
+
aBufferSize
*
sizeof
(
Elem
)
;
void
*
ptr
=
malloc
(
size
)
;
return
new
(
ptr
)
T
(
size
std
:
:
forward
<
Args
>
(
aArgs
)
.
.
.
)
;
}
}
;
struct
IntroductionMessage
:
public
Message
{
base
:
:
ProcessId
mParentPid
;
uint32_t
mArgc
;
IntroductionMessage
(
uint32_t
aSize
base
:
:
ProcessId
aParentPid
uint32_t
aArgc
)
:
Message
(
MessageType
:
:
Introduction
aSize
)
mParentPid
(
aParentPid
)
mArgc
(
aArgc
)
{
}
char
*
ArgvString
(
)
{
return
Data
<
IntroductionMessage
char
>
(
)
;
}
const
char
*
ArgvString
(
)
const
{
return
Data
<
IntroductionMessage
char
>
(
)
;
}
static
IntroductionMessage
*
New
(
base
:
:
ProcessId
aParentPid
int
aArgc
char
*
aArgv
[
]
)
{
size_t
argsLen
=
0
;
for
(
int
i
=
0
;
i
<
aArgc
;
i
+
+
)
{
argsLen
+
=
strlen
(
aArgv
[
i
]
)
+
1
;
}
IntroductionMessage
*
res
=
NewWithData
<
IntroductionMessage
char
>
(
argsLen
aParentPid
aArgc
)
;
size_t
offset
=
0
;
for
(
int
i
=
0
;
i
<
aArgc
;
i
+
+
)
{
memcpy
(
&
res
-
>
ArgvString
(
)
[
offset
]
aArgv
[
i
]
strlen
(
aArgv
[
i
]
)
+
1
)
;
offset
+
=
strlen
(
aArgv
[
i
]
)
+
1
;
}
MOZ_RELEASE_ASSERT
(
offset
=
=
argsLen
)
;
return
res
;
}
static
IntroductionMessage
*
RecordReplay
(
const
IntroductionMessage
&
aMsg
)
{
size_t
introductionSize
=
RecordReplayValue
(
aMsg
.
mSize
)
;
IntroductionMessage
*
msg
=
(
IntroductionMessage
*
)
malloc
(
introductionSize
)
;
if
(
IsRecording
(
)
)
{
memcpy
(
msg
&
aMsg
introductionSize
)
;
}
RecordReplayBytes
(
msg
introductionSize
)
;
return
msg
;
}
}
;
template
<
MessageType
Type
>
struct
EmptyMessage
:
public
Message
{
EmptyMessage
(
)
:
Message
(
Type
sizeof
(
*
this
)
)
{
}
}
;
typedef
EmptyMessage
<
MessageType
:
:
SetDebuggerRunsInMiddleman
>
SetDebuggerRunsInMiddlemanMessage
;
typedef
EmptyMessage
<
MessageType
:
:
Terminate
>
TerminateMessage
;
typedef
EmptyMessage
<
MessageType
:
:
CreateCheckpoint
>
CreateCheckpointMessage
;
template
<
MessageType
Type
>
struct
JSONMessage
:
public
Message
{
explicit
JSONMessage
(
uint32_t
aSize
)
:
Message
(
Type
aSize
)
{
}
const
char16_t
*
Buffer
(
)
const
{
return
Data
<
JSONMessage
<
Type
>
char16_t
>
(
)
;
}
size_t
BufferSize
(
)
const
{
return
DataSize
<
JSONMessage
<
Type
>
char16_t
>
(
)
;
}
static
JSONMessage
<
Type
>
*
New
(
const
char16_t
*
aBuffer
size_t
aBufferSize
)
{
JSONMessage
<
Type
>
*
res
=
NewWithData
<
JSONMessage
<
Type
>
char16_t
>
(
aBufferSize
)
;
MOZ_RELEASE_ASSERT
(
res
-
>
BufferSize
(
)
=
=
aBufferSize
)
;
PodCopy
(
res
-
>
Data
<
JSONMessage
<
Type
>
char16_t
>
(
)
aBuffer
aBufferSize
)
;
return
res
;
}
}
;
typedef
JSONMessage
<
MessageType
:
:
ManifestStart
>
ManifestStartMessage
;
typedef
JSONMessage
<
MessageType
:
:
ManifestFinished
>
ManifestFinishedMessage
;
struct
FatalErrorMessage
:
public
Message
{
explicit
FatalErrorMessage
(
uint32_t
aSize
)
:
Message
(
MessageType
:
:
FatalError
aSize
)
{
}
const
char
*
Error
(
)
const
{
return
Data
<
FatalErrorMessage
const
char
>
(
)
;
}
}
;
typedef
EmptyMessage
<
MessageType
:
:
BeginFatalError
>
BeginFatalErrorMessage
;
static
const
gfx
:
:
SurfaceFormat
gSurfaceFormat
=
gfx
:
:
SurfaceFormat
:
:
R8G8B8X8
;
struct
PaintMessage
:
public
Message
{
uint32_t
mWidth
;
uint32_t
mHeight
;
PaintMessage
(
uint32_t
aWidth
uint32_t
aHeight
)
:
Message
(
MessageType
:
:
Paint
sizeof
(
*
this
)
)
mWidth
(
aWidth
)
mHeight
(
aHeight
)
{
}
}
;
template
<
MessageType
Type
>
struct
BinaryMessage
:
public
Message
{
explicit
BinaryMessage
(
uint32_t
aSize
)
:
Message
(
Type
aSize
)
{
}
const
char
*
BinaryData
(
)
const
{
return
Data
<
BinaryMessage
<
Type
>
char
>
(
)
;
}
size_t
BinaryDataSize
(
)
const
{
return
DataSize
<
BinaryMessage
<
Type
>
char
>
(
)
;
}
static
BinaryMessage
<
Type
>
*
New
(
const
char
*
aData
size_t
aDataSize
)
{
BinaryMessage
<
Type
>
*
res
=
NewWithData
<
BinaryMessage
<
Type
>
char
>
(
aDataSize
)
;
MOZ_RELEASE_ASSERT
(
res
-
>
BinaryDataSize
(
)
=
=
aDataSize
)
;
PodCopy
(
res
-
>
Data
<
BinaryMessage
<
Type
>
char
>
(
)
aData
aDataSize
)
;
return
res
;
}
}
;
typedef
BinaryMessage
<
MessageType
:
:
MiddlemanCallRequest
>
MiddlemanCallRequestMessage
;
typedef
BinaryMessage
<
MessageType
:
:
MiddlemanCallResponse
>
MiddlemanCallResponseMessage
;
typedef
EmptyMessage
<
MessageType
:
:
ResetMiddlemanCalls
>
ResetMiddlemanCallsMessage
;
struct
PingMessage
:
public
Message
{
uint32_t
mId
;
explicit
PingMessage
(
uint32_t
aId
)
:
Message
(
MessageType
:
:
Ping
sizeof
(
*
this
)
)
mId
(
aId
)
{
}
}
;
struct
PingResponseMessage
:
public
Message
{
uint32_t
mId
;
uint64_t
mProgress
;
PingResponseMessage
(
uint32_t
aId
uint64_t
aProgress
)
:
Message
(
MessageType
:
:
PingResponse
sizeof
(
*
this
)
)
mId
(
aId
)
mProgress
(
aProgress
)
{
}
}
;
class
Channel
{
public
:
typedef
std
:
:
function
<
void
(
Message
:
:
UniquePtr
)
>
MessageHandler
;
private
:
size_t
mId
;
MessageHandler
mHandler
;
Atomic
<
bool
SequentiallyConsistent
Behavior
:
:
DontPreserve
>
mInitialized
;
int
mConnectionFd
;
int
mFd
;
Monitor
mMonitor
;
typedef
InfallibleVector
<
char
0
AllocPolicy
<
MemoryKind
:
:
Generic
>
>
MessageBuffer
;
MessageBuffer
*
mMessageBuffer
;
size_t
mMessageBytes
;
bool
mSimulateDelays
;
TimeStamp
mStartTime
;
TimeStamp
mAvailableTime
;
void
PrintMessage
(
const
char
*
aPrefix
const
Message
&
aMsg
)
;
Message
:
:
UniquePtr
WaitForMessage
(
)
;
static
void
ThreadMain
(
void
*
aChannel
)
;
public
:
Channel
(
size_t
aId
bool
aMiddlemanRecording
const
MessageHandler
&
aHandler
)
;
size_t
GetId
(
)
{
return
mId
;
}
void
SendMessage
(
Message
&
&
aMsg
)
;
}
;
static
const
char
*
gMiddlemanPidOption
=
"
-
middlemanPid
"
;
static
const
char
*
gChannelIDOption
=
"
-
recordReplayChannelID
"
;
}
}
#
endif
