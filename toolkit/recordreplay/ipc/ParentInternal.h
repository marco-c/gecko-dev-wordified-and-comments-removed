#
ifndef
mozilla_recordreplay_ParentInternal_h
#
define
mozilla_recordreplay_ParentInternal_h
#
include
"
ParentIPC
.
h
"
#
include
"
Channel
.
h
"
#
include
"
mozilla
/
ipc
/
GeckoChildProcessHost
.
h
"
namespace
mozilla
{
namespace
recordreplay
{
namespace
parent
{
class
ChildProcessInfo
;
MessageLoop
*
MainThreadMessageLoop
(
)
;
void
ChromeRegistered
(
)
;
bool
CanRewind
(
)
;
ChildProcessInfo
*
GetActiveChild
(
)
;
ChildProcessInfo
*
GetChildProcess
(
size_t
aId
)
;
void
SpawnReplayingChild
(
size_t
aId
)
;
void
SetActiveChild
(
ChildProcessInfo
*
aChild
)
;
void
MaybeHandlePendingSyncMessage
(
)
;
void
InitializeForwarding
(
)
;
void
Shutdown
(
)
;
extern
StaticInfallibleVector
<
char
>
gRecordingContents
;
extern
Monitor
*
gMonitor
;
extern
void
*
gGraphicsMemory
;
void
InitializeGraphicsMemory
(
)
;
void
SendGraphicsMemoryToChild
(
)
;
void
UpdateGraphicsAfterPaint
(
const
PaintMessage
&
aMsg
)
;
void
UpdateGraphicsAfterRepaint
(
const
nsACString
&
imageData
)
;
void
RestoreMainGraphics
(
)
;
void
ClearGraphics
(
)
;
static
const
int32_t
GraphicsHandshakeMessageId
=
42
;
static
const
int32_t
GraphicsMemoryMessageId
=
43
;
static
const
size_t
GraphicsMemorySize
=
4096
*
4096
*
4
;
bool
InRepaintStressMode
(
)
;
extern
ipc
:
:
GeckoChildProcessHost
*
gRecordingProcess
;
struct
RecordingProcessData
{
const
base
:
:
SharedMemoryHandle
&
mPrefsHandle
;
const
ipc
:
:
FileDescriptor
&
mPrefMapHandle
;
RecordingProcessData
(
const
base
:
:
SharedMemoryHandle
&
aPrefsHandle
const
ipc
:
:
FileDescriptor
&
aPrefMapHandle
)
:
mPrefsHandle
(
aPrefsHandle
)
mPrefMapHandle
(
aPrefMapHandle
)
{
}
}
;
class
ChildProcessInfo
{
Channel
*
mChannel
=
nullptr
;
bool
mRecording
=
false
;
void
OnIncomingMessage
(
const
Message
&
aMsg
)
;
static
void
MaybeProcessPendingMessageRunnable
(
)
;
static
void
ReceiveChildMessageOnMainThread
(
size_t
aChildId
Message
:
:
UniquePtr
aMsg
)
;
void
OnCrash
(
size_t
aForkId
const
char
*
aWhy
)
;
void
LaunchSubprocess
(
size_t
aId
const
Maybe
<
RecordingProcessData
>
&
aRecordingProcessData
)
;
public
:
explicit
ChildProcessInfo
(
size_t
aId
const
Maybe
<
RecordingProcessData
>
&
aRecordingProcessData
)
;
~
ChildProcessInfo
(
)
;
size_t
GetId
(
)
{
return
mChannel
-
>
GetId
(
)
;
}
bool
IsRecording
(
)
{
return
mRecording
;
}
void
SendMessage
(
Message
&
&
aMessage
)
;
static
void
SetIntroductionMessage
(
IntroductionMessage
*
aMessage
)
;
static
void
MaybeProcessNextMessage
(
)
;
}
;
}
}
}
#
endif
