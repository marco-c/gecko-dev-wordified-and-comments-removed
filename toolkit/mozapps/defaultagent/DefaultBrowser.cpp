#
include
"
DefaultBrowser
.
h
"
#
include
<
string
>
#
include
<
unordered_map
>
#
include
<
shlobj
.
h
>
#
include
<
shlwapi
.
h
>
#
include
"
common
.
h
"
#
include
"
EventLog
.
h
"
#
include
"
Registry
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
WinHeaderOnlyUtils
.
h
"
using
BrowserResult
=
mozilla
:
:
WindowsErrorResult
<
Browser
>
;
std
:
:
string
GetStringForBrowser
(
Browser
browser
)
{
switch
(
browser
)
{
case
Browser
:
:
Firefox
:
return
std
:
:
string
(
"
firefox
"
)
;
case
Browser
:
:
Chrome
:
return
std
:
:
string
(
"
chrome
"
)
;
case
Browser
:
:
EdgeWithEdgeHTML
:
return
std
:
:
string
(
"
edge
"
)
;
case
Browser
:
:
EdgeWithBlink
:
return
std
:
:
string
(
"
edge
-
chrome
"
)
;
case
Browser
:
:
InternetExplorer
:
return
std
:
:
string
(
"
ie
"
)
;
case
Browser
:
:
Opera
:
return
std
:
:
string
(
"
opera
"
)
;
case
Browser
:
:
Brave
:
return
std
:
:
string
(
"
brave
"
)
;
case
Browser
:
:
Unknown
:
return
std
:
:
string
(
"
"
)
;
}
}
Browser
GetBrowserFromString
(
const
std
:
:
string
&
browserString
)
{
if
(
browserString
.
compare
(
"
firefox
"
)
=
=
0
)
{
return
Browser
:
:
Firefox
;
}
if
(
browserString
.
compare
(
"
chrome
"
)
=
=
0
)
{
return
Browser
:
:
Chrome
;
}
if
(
browserString
.
compare
(
"
edge
"
)
=
=
0
)
{
return
Browser
:
:
EdgeWithEdgeHTML
;
}
if
(
browserString
.
compare
(
"
edge
-
chrome
"
)
=
=
0
)
{
return
Browser
:
:
EdgeWithBlink
;
}
if
(
browserString
.
compare
(
"
ie
"
)
=
=
0
)
{
return
Browser
:
:
InternetExplorer
;
}
if
(
browserString
.
compare
(
"
opera
"
)
=
=
0
)
{
return
Browser
:
:
Opera
;
}
if
(
browserString
.
compare
(
"
brave
"
)
=
=
0
)
{
return
Browser
:
:
Brave
;
}
return
Browser
:
:
Unknown
;
}
static
BrowserResult
GetDefaultBrowser
(
)
{
RefPtr
<
IApplicationAssociationRegistration
>
pAAR
;
HRESULT
hr
=
CoCreateInstance
(
CLSID_ApplicationAssociationRegistration
nullptr
CLSCTX_INPROC
IID_IApplicationAssociationRegistration
getter_AddRefs
(
pAAR
)
)
;
if
(
FAILED
(
hr
)
)
{
LOG_ERROR
(
hr
)
;
return
BrowserResult
(
mozilla
:
:
WindowsError
:
:
FromHResult
(
hr
)
)
;
}
wchar_t
*
rawRegisteredApp
;
hr
=
pAAR
-
>
QueryCurrentDefault
(
L
"
http
"
AT_URLPROTOCOL
AL_EFFECTIVE
&
rawRegisteredApp
)
;
if
(
FAILED
(
hr
)
)
{
LOG_ERROR
(
hr
)
;
return
BrowserResult
(
mozilla
:
:
WindowsError
:
:
FromHResult
(
hr
)
)
;
}
mozilla
:
:
UniquePtr
<
wchar_t
mozilla
:
:
CoTaskMemFreeDeleter
>
registeredApp
(
rawRegisteredApp
)
;
const
std
:
:
unordered_map
<
std
:
:
wstring
Browser
>
AppIDPrefixes
=
{
{
L
"
Firefox
"
Browser
:
:
Firefox
}
{
L
"
Chrome
"
Browser
:
:
Chrome
}
{
L
"
AppX
"
Browser
:
:
EdgeWithEdgeHTML
}
{
L
"
MSEdgeHTM
"
Browser
:
:
EdgeWithBlink
}
{
L
"
IE
.
"
Browser
:
:
InternetExplorer
}
{
L
"
Opera
"
Browser
:
:
Opera
}
{
L
"
Brave
"
Browser
:
:
Brave
}
}
;
for
(
const
auto
&
prefix
:
AppIDPrefixes
)
{
if
(
!
wcsnicmp
(
registeredApp
.
get
(
)
prefix
.
first
.
c_str
(
)
prefix
.
first
.
length
(
)
)
)
{
return
prefix
.
second
;
}
}
return
Browser
:
:
Unknown
;
}
static
BrowserResult
GetPreviousDefaultBrowser
(
Browser
currentDefault
)
{
std
:
:
string
currentDefaultStr
=
GetStringForBrowser
(
currentDefault
)
;
std
:
:
string
previousDefault
=
RegistryGetValueString
(
IsPrefixed
:
:
Prefixed
L
"
CurrentDefault
"
)
.
unwrapOr
(
mozilla
:
:
Some
(
currentDefaultStr
)
)
.
valueOr
(
currentDefaultStr
)
;
mozilla
:
:
Unused
<
<
RegistrySetValueString
(
IsPrefixed
:
:
Prefixed
L
"
CurrentDefault
"
currentDefaultStr
.
c_str
(
)
)
;
return
GetBrowserFromString
(
previousDefault
)
;
}
DefaultBrowserResult
GetDefaultBrowserInfo
(
)
{
DefaultBrowserInfo
browserInfo
;
BrowserResult
defaultBrowserResult
=
GetDefaultBrowser
(
)
;
if
(
defaultBrowserResult
.
isErr
(
)
)
{
return
DefaultBrowserResult
(
defaultBrowserResult
.
unwrapErr
(
)
)
;
}
browserInfo
.
currentDefaultBrowser
=
defaultBrowserResult
.
unwrap
(
)
;
BrowserResult
previousDefaultBrowserResult
=
GetPreviousDefaultBrowser
(
browserInfo
.
currentDefaultBrowser
)
;
if
(
previousDefaultBrowserResult
.
isErr
(
)
)
{
return
DefaultBrowserResult
(
previousDefaultBrowserResult
.
unwrapErr
(
)
)
;
}
browserInfo
.
previousDefaultBrowser
=
previousDefaultBrowserResult
.
unwrap
(
)
;
return
browserInfo
;
}
