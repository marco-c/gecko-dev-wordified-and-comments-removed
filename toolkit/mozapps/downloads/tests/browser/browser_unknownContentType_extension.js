"
use
strict
"
;
const
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
http
:
/
/
example
.
com
"
)
;
add_task
(
async
function
test_download_filename_extension
(
)
{
forcePromptForFiles
(
"
application
/
octet
-
stream
"
"
exe
"
)
;
let
windowObserver
=
BrowserTestUtils
.
domWindowOpenedAndLoaded
(
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
opening
:
TEST_PATH
+
"
unknownContentType
.
EXE
"
waitForLoad
:
false
}
)
;
let
win
=
await
windowObserver
;
let
list
=
await
Downloads
.
getList
(
Downloads
.
ALL
)
;
let
downloadFinishedPromise
=
new
Promise
(
resolve
=
>
{
list
.
addView
(
{
onDownloadChanged
(
download
)
{
if
(
download
.
stopped
)
{
list
.
removeView
(
this
)
;
resolve
(
download
)
;
}
}
}
)
;
}
)
;
let
dialog
=
win
.
document
.
querySelector
(
"
dialog
"
)
;
dialog
.
getButton
(
"
accept
"
)
.
removeAttribute
(
"
disabled
"
)
;
dialog
.
acceptDialog
(
)
;
let
download
=
await
downloadFinishedPromise
;
let
filename
=
PathUtils
.
filename
(
download
.
target
.
path
)
;
Assert
.
equal
(
filename
.
indexOf
(
"
.
"
)
filename
.
lastIndexOf
(
"
.
"
)
"
Should
not
duplicate
extension
"
)
;
Assert
.
ok
(
filename
.
endsWith
(
"
.
EXE
"
)
"
Should
not
change
extension
"
)
;
await
list
.
remove
(
download
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
try
{
await
IOUtils
.
remove
(
download
.
target
.
path
)
;
}
catch
(
ex
)
{
info
(
"
Failed
to
remove
the
file
"
+
ex
)
;
}
}
)
;
