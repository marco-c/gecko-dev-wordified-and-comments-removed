"
use
strict
"
;
const
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
http
:
/
/
example
.
com
"
)
;
function
waitDelay
(
delay
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
window
.
setTimeout
(
resolve
delay
)
;
}
)
;
}
add_task
(
async
function
test_download_filename_extension
(
)
{
let
windowObserver
=
BrowserTestUtils
.
domWindowOpenedAndLoaded
(
)
;
let
windowOpenDelay
=
waitDelay
(
1000
)
;
let
uctWindow
=
await
Promise
.
race
(
[
windowOpenDelay
windowObserver
.
promise
]
)
;
const
prefEnabled
=
Services
.
prefs
.
getBoolPref
(
"
browser
.
download
.
improvements_to_download_panel
"
)
;
if
(
prefEnabled
)
{
SimpleTest
.
is
(
!
uctWindow
true
"
UnknownContentType
window
shouldn
'
t
open
.
"
)
;
return
;
}
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
opening
:
TEST_PATH
+
"
unknownContentType
.
EXE
"
waitForLoad
:
false
}
)
;
let
win
=
await
windowObserver
;
let
list
=
await
Downloads
.
getList
(
Downloads
.
ALL
)
;
let
downloadFinishedPromise
=
new
Promise
(
resolve
=
>
{
list
.
addView
(
{
onDownloadChanged
(
download
)
{
if
(
download
.
stopped
)
{
list
.
removeView
(
this
)
;
resolve
(
download
)
;
}
}
}
)
;
}
)
;
let
dialog
=
win
.
document
.
querySelector
(
"
dialog
"
)
;
dialog
.
getButton
(
"
accept
"
)
.
removeAttribute
(
"
disabled
"
)
;
dialog
.
acceptDialog
(
)
;
let
download
=
await
downloadFinishedPromise
;
let
filename
=
PathUtils
.
filename
(
download
.
target
.
path
)
;
Assert
.
ok
(
filename
.
indexOf
(
"
.
"
)
=
=
filename
.
lastIndexOf
(
"
.
"
)
"
Should
not
duplicate
extension
"
)
;
Assert
.
ok
(
filename
.
endsWith
(
"
.
EXE
"
)
"
Should
not
change
extension
"
)
;
await
list
.
remove
(
download
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
try
{
await
IOUtils
.
remove
(
download
.
target
.
path
)
;
}
catch
(
ex
)
{
info
(
"
Failed
to
remove
the
file
"
+
ex
)
;
}
}
)
;
