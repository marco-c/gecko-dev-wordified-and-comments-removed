"
use
strict
"
;
const
{
ClientID
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ClientID
.
jsm
"
)
;
const
{
AddonTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
AddonTestUtils
.
jsm
"
)
;
AddonTestUtils
.
initMochitest
(
this
)
;
const
server
=
AddonTestUtils
.
createHttpServer
(
)
;
const
serverBaseUrl
=
http
:
/
/
localhost
:
{
server
.
identity
.
primaryPort
}
/
;
server
.
registerPathHandler
(
"
/
sumo
/
personalized
-
addons
"
(
request
response
)
=
>
{
response
.
write
(
"
This
is
a
SUMO
page
that
explains
personalized
add
-
ons
.
"
)
;
}
)
;
async
function
promiseOneDiscoveryApiRequest
(
)
{
return
new
Promise
(
resolve
=
>
{
let
requestCount
=
0
;
server
.
registerPathHandler
(
"
/
discoapi
"
(
request
response
)
=
>
{
is
(
+
+
requestCount
1
"
Expecting
one
discovery
API
request
"
)
;
response
.
write
(
{
"
results
"
:
[
]
}
)
;
let
searchParams
=
new
URLSearchParams
(
request
.
queryString
)
;
let
clientId
=
searchParams
.
get
(
"
telemetry
-
client
-
id
"
)
;
resolve
(
clientId
)
;
}
)
;
}
)
;
}
function
getNoticeButton
(
win
)
{
return
win
.
document
.
querySelector
(
"
[
action
=
'
notice
-
learn
-
more
'
]
"
)
;
}
function
isNoticeVisible
(
win
)
{
let
message
=
win
.
document
.
querySelector
(
"
taar
-
notice
"
)
;
return
message
&
&
message
.
offsetHeight
>
0
;
}
add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
discovery
.
enabled
"
true
]
[
"
datareporting
.
healthreport
.
uploadEnabled
"
true
]
[
"
extensions
.
getAddons
.
discovery
.
api_url
"
{
serverBaseUrl
}
discoapi
]
[
"
app
.
support
.
baseURL
"
{
serverBaseUrl
}
sumo
/
]
[
"
extensions
.
htmlaboutaddons
.
discover
.
enabled
"
true
]
[
"
extensions
.
htmlaboutaddons
.
enabled
"
true
]
[
"
extensions
.
htmlaboutaddons
.
recommendations
.
enabled
"
false
]
]
}
)
;
}
)
;
add_task
(
async
function
clientid_enabled
(
)
{
let
EXPECTED_CLIENT_ID
=
await
ClientID
.
getClientIdHash
(
)
;
ok
(
EXPECTED_CLIENT_ID
"
ClientID
should
be
available
"
)
;
let
requestPromise
=
promiseOneDiscoveryApiRequest
(
)
;
let
win
=
await
loadInitialView
(
"
discover
"
)
;
ok
(
isNoticeVisible
(
win
)
"
Notice
about
personalization
should
be
visible
"
)
;
ok
(
await
requestPromise
"
Moz
-
Client
-
Id
should
be
set
when
telemetry
&
discovery
are
enabled
"
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
tabbrowser
=
win
.
windowRoot
.
ownerGlobal
.
gBrowser
;
let
expectedUrl
=
{
serverBaseUrl
}
sumo
/
personalized
-
addons
;
let
tabPromise
=
BrowserTestUtils
.
waitForNewTab
(
tabbrowser
expectedUrl
)
;
getNoticeButton
(
win
)
.
click
(
)
;
info
(
Waiting
for
new
tab
with
URL
:
{
expectedUrl
}
)
;
let
tab
=
await
tabPromise
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
closeView
(
win
)
;
assertAboutAddonsTelemetryEvents
(
[
[
"
addonsManager
"
"
link
"
"
aboutAddons
"
"
disconotice
"
{
view
:
"
discover
"
}
]
]
{
methods
:
[
"
link
"
]
}
)
;
}
)
;
add_task
(
async
function
clientid_disabled
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
discovery
.
enabled
"
false
]
]
}
)
;
let
requestPromise
=
promiseOneDiscoveryApiRequest
(
)
;
let
win
=
await
loadInitialView
(
"
discover
"
)
;
ok
(
!
isNoticeVisible
(
win
)
"
Notice
about
personalization
should
be
hidden
"
)
;
is
(
await
requestPromise
null
"
Moz
-
Client
-
Id
should
not
be
sent
when
discovery
is
disabled
"
)
;
await
closeView
(
win
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
clientid_from_private_window
(
)
{
let
privateWindow
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
let
requestPromise
=
promiseOneDiscoveryApiRequest
(
)
;
let
managerWindow
=
await
open_manager
(
"
addons
:
/
/
discover
/
"
null
null
null
privateWindow
)
;
ok
(
PrivateBrowsingUtils
.
isContentWindowPrivate
(
managerWindow
)
"
Addon
-
manager
is
in
a
private
window
"
)
;
is
(
await
requestPromise
null
"
Moz
-
Client
-
Id
should
not
be
sent
in
private
windows
"
)
;
await
close_manager
(
managerWindow
)
;
await
BrowserTestUtils
.
closeWindow
(
privateWindow
)
;
}
)
;
add_task
(
async
function
clientid_enabled_from_extension_list
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
extensions
.
htmlaboutaddons
.
discover
.
enabled
"
false
]
[
"
extensions
.
htmlaboutaddons
.
recommendations
.
enabled
"
true
]
]
}
)
;
Services
.
prefs
.
setCharPref
(
PREF_UI_LASTCATEGORY
"
addons
:
/
/
list
/
extension
"
)
;
let
requestPromise
=
promiseOneDiscoveryApiRequest
(
)
;
let
win
=
await
loadInitialView
(
"
extension
"
)
;
ok
(
isNoticeVisible
(
win
)
"
Notice
about
personalization
should
be
visible
"
)
;
ok
(
await
requestPromise
"
Moz
-
Client
-
Id
should
be
set
when
telemetry
&
discovery
are
enabled
"
)
;
await
switchView
(
win
"
theme
"
)
;
let
recommendations
=
win
.
document
.
querySelector
(
"
recommended
-
addon
-
list
"
)
;
await
recommendations
.
loadCardsIfNeeded
(
)
;
await
closeView
(
win
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
clientid_enabled_from_theme_list
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
extensions
.
htmlaboutaddons
.
discover
.
enabled
"
false
]
[
"
extensions
.
htmlaboutaddons
.
recommendations
.
enabled
"
true
]
]
}
)
;
Services
.
prefs
.
setCharPref
(
PREF_UI_LASTCATEGORY
"
addons
:
/
/
list
/
theme
"
)
;
let
requestPromise
=
promiseOneDiscoveryApiRequest
(
)
;
let
win
=
await
loadInitialView
(
"
theme
"
)
;
ok
(
!
isNoticeVisible
(
win
)
"
Notice
about
personalization
should
be
hidden
"
)
;
is
(
await
requestPromise
null
"
Moz
-
Client
-
Id
should
not
be
sent
when
loading
themes
initially
"
)
;
info
(
"
Load
the
extension
list
and
verify
the
client
ID
is
now
sent
"
)
;
requestPromise
=
promiseOneDiscoveryApiRequest
(
)
;
await
switchView
(
win
"
extension
"
)
;
ok
(
await
requestPromise
"
Moz
-
Client
-
Id
is
now
sent
for
extensions
"
)
;
await
closeView
(
win
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
