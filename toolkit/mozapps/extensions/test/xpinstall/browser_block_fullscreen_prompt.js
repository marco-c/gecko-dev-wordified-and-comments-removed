"
use
strict
"
;
SimpleTest
.
ignoreAllUncaughtExceptions
(
true
)
;
const
ADDON_FILE_URI
=
"
http
:
/
/
example
.
com
/
browser
/
toolkit
/
mozapps
/
extensions
/
test
/
xpinstall
/
amosigned
.
xpi
"
;
const
ADDON_EVENTS
=
[
"
addon
-
install
-
blocked
"
"
addon
-
install
-
blocked
-
silent
"
"
addon
-
install
-
complete
"
"
addon
-
install
-
confirmation
"
"
addon
-
install
-
disabled
"
"
addon
-
install
-
failed
"
"
addon
-
install
-
origin
-
blocked
"
"
addon
-
install
-
started
"
"
addon
-
progress
"
"
addon
-
webext
-
permissions
"
"
xpinstall
-
disabled
"
]
;
function
waitForNextAddonEvent
(
)
{
return
Promise
.
race
(
ADDON_EVENTS
.
map
(
async
(
eventStr
)
=
>
{
await
TestUtils
.
topicObserved
(
eventStr
)
;
return
eventStr
;
}
)
)
;
}
function
changeFullscreen
(
browser
fullscreenState
)
{
return
ContentTask
.
spawn
(
browser
fullscreenState
async
function
(
state
)
{
if
(
state
)
{
await
content
.
document
.
body
.
requestFullscreen
(
)
;
}
else
{
await
content
.
document
.
exitFullscreen
(
)
;
}
}
)
;
}
add_task
(
async
function
testFullscreenBlockAddonInstallPrompt
(
)
{
await
BrowserTestUtils
.
withNewTab
(
"
http
:
/
/
example
.
com
"
async
function
(
browser
)
{
await
changeFullscreen
(
browser
true
)
;
BrowserTestUtils
.
loadURI
(
browser
ADDON_FILE_URI
)
;
let
eventStr
=
await
waitForNextAddonEvent
(
)
;
Assert
.
equal
(
eventStr
"
addon
-
install
-
blocked
-
silent
"
"
Addon
installation
was
blocked
"
)
;
let
panelOpened
;
try
{
panelOpened
=
await
TestUtils
.
waitForCondition
(
(
)
=
>
PopupNotifications
.
isPanelOpen
100
10
)
;
}
catch
(
ex
)
{
panelOpened
=
false
;
}
is
(
panelOpened
false
"
Addon
installation
prompt
not
opened
"
)
;
window
.
fullScreen
=
false
;
}
)
;
}
)
;
add_task
(
async
function
testFullscreenCloseAddonInstallPrompt
(
)
{
await
BrowserTestUtils
.
withNewTab
(
"
http
:
/
/
example
.
com
"
async
function
(
browser
)
{
BrowserTestUtils
.
loadURI
(
browser
ADDON_FILE_URI
)
;
let
eventStr
=
await
waitForNextAddonEvent
(
)
;
Assert
.
ok
(
eventStr
=
=
=
"
addon
-
install
-
started
"
"
Addon
installation
started
"
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
PopupNotifications
.
isPanelOpen
"
Waiting
for
addon
installation
prompt
to
open
"
)
;
Assert
.
ok
(
ADDON_EVENTS
.
some
(
id
=
>
PopupNotifications
.
getNotification
(
id
browser
)
!
=
null
)
"
Opened
notification
is
installation
prompt
"
)
;
let
panelClosePromise
=
TestUtils
.
waitForCondition
(
(
)
=
>
!
PopupNotifications
.
isPanelOpen
"
Waiting
for
addon
installation
prompt
to
close
"
)
;
await
changeFullscreen
(
browser
true
)
;
await
panelClosePromise
;
window
.
fullScreen
=
false
;
}
)
;
}
)
;
