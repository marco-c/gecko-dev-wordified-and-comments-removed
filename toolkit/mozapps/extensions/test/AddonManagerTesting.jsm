"
use
strict
"
;
this
.
EXPORTED_SYMBOLS
=
[
"
AddonManagerTesting
"
]
;
const
{
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Promise
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
AddonManager
"
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
jsm
"
)
;
this
.
AddonManagerTesting
=
{
getAddonById
(
id
)
{
return
new
Promise
(
resolve
=
>
AddonManager
.
getAddonByID
(
id
addon
=
>
resolve
(
addon
)
)
)
;
}
uninstallAddonByID
(
id
)
{
let
deferred
=
Promise
.
defer
(
)
;
AddonManager
.
getAddonByID
(
id
(
addon
)
=
>
{
if
(
!
addon
)
{
deferred
.
reject
(
new
Error
(
"
Add
-
on
is
not
known
:
"
+
id
)
)
;
return
;
}
let
listener
=
{
onUninstalling
(
addon
needsRestart
)
{
if
(
addon
.
id
!
=
id
)
{
return
;
}
if
(
needsRestart
)
{
AddonManager
.
removeAddonListener
(
listener
)
;
deferred
.
resolve
(
true
)
;
}
}
onUninstalled
(
addon
)
{
if
(
addon
.
id
!
=
id
)
{
return
;
}
AddonManager
.
removeAddonListener
(
listener
)
;
deferred
.
resolve
(
false
)
;
}
onOperationCancelled
(
addon
)
{
if
(
addon
.
id
!
=
id
)
{
return
;
}
AddonManager
.
removeAddonListener
(
listener
)
;
deferred
.
reject
(
new
Error
(
"
Uninstall
cancelled
.
"
)
)
;
}
}
;
AddonManager
.
addAddonListener
(
listener
)
;
addon
.
uninstall
(
)
;
}
)
;
return
deferred
.
promise
;
}
installXPIFromURL
(
url
hash
name
iconURL
version
)
{
let
deferred
=
Promise
.
defer
(
)
;
AddonManager
.
getInstallForURL
(
url
(
install
)
=
>
{
let
fail
=
(
)
=
>
{
deferred
.
reject
(
new
Error
(
"
Add
-
on
install
failed
.
"
)
)
}
;
let
listener
=
{
onDownloadCancelled
:
fail
onDownloadFailed
:
fail
onInstallCancelled
:
fail
onInstallFailed
:
fail
onInstallEnded
(
install
addon
)
{
deferred
.
resolve
(
addon
)
;
}
}
;
install
.
addListener
(
listener
)
;
install
.
install
(
)
;
}
"
application
/
x
-
xpinstall
"
hash
name
iconURL
version
)
;
return
deferred
.
promise
;
}
}
;
