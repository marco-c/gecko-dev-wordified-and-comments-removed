const
{
ADDON_SIGNING
}
=
AM_Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
addons
/
AddonConstants
.
jsm
"
{
}
)
;
function
run_test
(
)
{
run_next_test
(
)
;
}
let
profileDir
;
add_task
(
function
*
setup
(
)
{
profileDir
=
gProfD
.
clone
(
)
;
profileDir
.
append
(
"
extensions
"
)
;
if
(
!
profileDir
.
exists
(
)
)
profileDir
.
create
(
AM_Ci
.
nsIFile
.
DIRECTORY_TYPE
FileUtils
.
PERMS_DIRECTORY
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
1
.
9
.
2
"
)
;
startupManager
(
)
;
}
)
;
const
IMPLICIT_ID_XPI
=
"
data
/
webext
-
implicit
-
id
.
xpi
"
;
const
IMPLICIT_ID_ID
=
"
webext_implicit_id
tests
.
mozilla
.
org
"
;
add_task
(
function
*
test_implicit_id
(
)
{
ok
(
ADDON_SIGNING
"
Addon
signing
is
enabled
"
)
;
let
addon
=
yield
promiseAddonByID
(
IMPLICIT_ID_ID
)
;
do_check_eq
(
addon
null
)
;
let
xpifile
=
do_get_file
(
IMPLICIT_ID_XPI
)
;
yield
promiseInstallAllFiles
(
[
xpifile
]
)
;
addon
=
yield
promiseAddonByID
(
IMPLICIT_ID_ID
)
;
do_check_neq
(
addon
null
)
;
addon
.
uninstall
(
)
;
}
)
;
add_task
(
function
*
test_implicit_id_temp
(
)
{
ok
(
ADDON_SIGNING
"
Addon
signing
is
enabled
"
)
;
let
addon
=
yield
promiseAddonByID
(
IMPLICIT_ID_ID
)
;
do_check_eq
(
addon
null
)
;
let
xpifile
=
do_get_file
(
IMPLICIT_ID_XPI
)
;
yield
AddonManager
.
installTemporaryAddon
(
xpifile
)
;
addon
=
yield
promiseAddonByID
(
IMPLICIT_ID_ID
)
;
do_check_neq
(
addon
null
)
;
addon
.
uninstall
(
)
;
}
)
;
add_task
(
function
*
test_bss_id
(
)
{
const
ID
=
"
webext_bss_id
tests
.
mozilla
.
org
"
;
let
manifest
=
{
name
:
"
bss
test
"
description
:
"
test
that
ID
may
be
in
browser_specific_settings
"
manifest_version
:
2
version
:
"
1
.
0
"
browser_specific_settings
:
{
gecko
:
{
id
:
ID
}
}
}
;
let
addon
=
yield
promiseAddonByID
(
ID
)
;
do_check_eq
(
addon
null
)
;
writeWebManifestForExtension
(
manifest
profileDir
ID
)
;
yield
promiseRestartManager
(
)
;
addon
=
yield
promiseAddonByID
(
ID
)
;
do_check_neq
(
addon
null
)
;
addon
.
uninstall
(
)
;
}
)
;
add_task
(
function
*
test_two_ids
(
)
{
const
GOOD_ID
=
"
two_ids
tests
.
mozilla
.
org
"
;
const
BAD_ID
=
"
i_am_obsolete
tests
.
mozilla
.
org
"
;
let
manifest
=
{
name
:
"
two
id
test
"
description
:
"
test
a
web
extension
with
ids
in
both
applications
and
browser_specific_settings
"
manifest_version
:
2
version
:
"
1
.
0
"
applications
:
{
gecko
:
{
id
:
BAD_ID
}
}
browser_specific_settings
:
{
gecko
:
{
id
:
GOOD_ID
}
}
}
writeWebManifestForExtension
(
manifest
profileDir
GOOD_ID
)
;
yield
promiseRestartManager
(
)
;
let
addon
=
yield
promiseAddonByID
(
BAD_ID
)
;
do_check_eq
(
addon
null
)
;
addon
=
yield
promiseAddonByID
(
GOOD_ID
)
;
do_check_neq
(
addon
null
)
;
addon
.
uninstall
(
)
;
}
)
;
