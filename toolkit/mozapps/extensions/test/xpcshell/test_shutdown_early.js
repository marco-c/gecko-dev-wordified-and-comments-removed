"
use
strict
"
;
const
{
TelemetryEnvironment
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
TelemetryEnvironment
.
jsm
"
)
;
add_task
(
async
function
test_shutdown_immediately_after_startup
(
)
{
Services
.
prefs
.
setBoolPref
(
"
extensions
.
incognito
.
migrated
"
true
)
;
Services
.
prefs
.
setCharPref
(
"
extensions
.
lastAppVersion
"
"
42
"
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
42
"
)
;
Cc
[
"
mozilla
.
org
/
addons
/
integration
;
1
"
]
.
getService
(
Ci
.
nsIObserver
)
.
observe
(
null
"
addons
-
startup
"
null
)
;
equal
(
AddonManagerPrivate
.
isDBLoaded
(
)
false
"
DB
not
loaded
synchronously
"
)
;
let
shutdownCount
=
0
;
AddonManager
.
beforeShutdown
.
addBlocker
(
"
count
"
async
(
)
=
>
+
+
shutdownCount
)
;
let
databaseLoaded
=
false
;
AddonManagerPrivate
.
databaseReady
.
then
(
(
)
=
>
{
databaseLoaded
=
true
;
}
)
;
equal
(
TelemetryEnvironment
.
currentEnvironment
.
addons
undefined
"
TelemetryEnvironment
.
currentEnvironment
.
addons
is
uninitialized
"
)
;
info
(
"
Immediate
exit
at
startup
without
quit
-
application
-
granted
"
)
;
Services
.
startup
.
advanceShutdownPhase
(
Services
.
startup
.
SHUTDOWN_PHASE_APPSHUTDOWN
)
;
let
shutdownPromise
=
MockAsyncShutdown
.
profileBeforeChange
.
trigger
(
)
;
equal
(
shutdownCount
1
"
AddonManager
.
beforeShutdown
has
started
"
)
;
await
shutdownPromise
;
ok
(
databaseLoaded
"
Addon
DB
loaded
for
use
by
TelemetryEnvironment
"
)
;
equal
(
AddonManagerPrivate
.
isDBLoaded
(
)
false
"
DB
unloaded
after
shutdown
"
)
;
Assert
.
deepEqual
(
TelemetryEnvironment
.
currentEnvironment
.
addons
.
activeAddons
{
}
"
TelemetryEnvironment
.
currentEnvironment
.
addons
is
initialized
"
)
;
}
)
;
