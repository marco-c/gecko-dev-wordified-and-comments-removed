const
ADDON
=
"
test_bug397778
"
;
const
ID
=
"
bug397778
tests
.
mozilla
.
org
"
;
function
run_test
(
)
{
do_test_pending
(
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
)
;
Services
.
locale
.
setRequestedLocales
(
[
"
fr
-
FR
"
]
)
;
startupManager
(
)
;
installAllFiles
(
[
do_get_addon
(
ADDON
)
]
function
(
)
{
restartManager
(
)
;
run_test_1
(
)
;
}
)
;
}
function
run_test_1
(
)
{
AddonManager
.
getAddonByID
(
ID
callback_soon
(
function
(
addon
)
{
Assert
.
notEqual
(
addon
null
)
;
Assert
.
equal
(
addon
.
name
"
fr
Name
"
)
;
Assert
.
equal
(
addon
.
description
"
fr
Description
"
)
;
addon
.
userDisabled
=
true
;
restartManager
(
)
;
AddonManager
.
getAddonByID
(
ID
function
(
newAddon
)
{
Assert
.
notEqual
(
newAddon
null
)
;
Assert
.
equal
(
newAddon
.
name
"
fr
Name
"
)
;
do_execute_soon
(
run_test_2
)
;
}
)
;
}
)
)
;
}
function
run_test_2
(
)
{
Services
.
locale
.
setRequestedLocales
(
[
"
de
"
]
)
;
restartManager
(
)
;
AddonManager
.
getAddonByID
(
ID
function
(
addon
)
{
Assert
.
notEqual
(
addon
null
)
;
Assert
.
equal
(
addon
.
name
"
de
-
DE
Name
"
)
;
Assert
.
equal
(
addon
.
description
null
)
;
do_execute_soon
(
run_test_3
)
;
}
)
;
}
function
run_test_3
(
)
{
Services
.
locale
.
setRequestedLocales
(
[
"
DE
-
de
"
]
)
;
restartManager
(
)
;
AddonManager
.
getAddonByID
(
ID
function
(
addon
)
{
Assert
.
notEqual
(
addon
null
)
;
Assert
.
equal
(
addon
.
name
"
de
-
DE
Name
"
)
;
Assert
.
equal
(
addon
.
description
null
)
;
do_execute_soon
(
run_test_4
)
;
}
)
;
}
function
run_test_4
(
)
{
Services
.
locale
.
setRequestedLocales
(
[
"
es
-
AR
"
]
)
;
restartManager
(
)
;
AddonManager
.
getAddonByID
(
ID
function
(
addon
)
{
Assert
.
notEqual
(
addon
null
)
;
Assert
.
equal
(
addon
.
name
"
es
-
ES
Name
"
)
;
Assert
.
equal
(
addon
.
description
"
es
-
ES
Description
"
)
;
do_execute_soon
(
run_test_5
)
;
}
)
;
}
function
run_test_5
(
)
{
Services
.
locale
.
setRequestedLocales
(
[
"
zh
"
]
)
;
restartManager
(
)
;
AddonManager
.
getAddonByID
(
ID
function
(
addon
)
{
Assert
.
notEqual
(
addon
null
)
;
if
(
addon
.
name
!
=
"
zh
-
TW
Name
"
&
&
addon
.
name
!
=
"
zh
-
CN
Name
"
)
do_throw
(
"
zh
matched
to
"
+
addon
.
name
)
;
do_execute_soon
(
run_test_6
)
;
}
)
;
}
function
run_test_6
(
)
{
Services
.
locale
.
setRequestedLocales
(
[
"
nl
-
NL
"
]
)
;
restartManager
(
)
;
AddonManager
.
getAddonByID
(
ID
function
(
addon
)
{
Assert
.
notEqual
(
addon
null
)
;
Assert
.
equal
(
addon
.
name
"
en
Name
"
)
;
Assert
.
equal
(
addon
.
description
"
en
Description
"
)
;
do_execute_soon
(
do_test_finished
)
;
}
)
;
}
