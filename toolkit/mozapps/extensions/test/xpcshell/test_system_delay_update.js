PromiseTestUtils
.
whitelistRejectionsGlobally
(
/
Message
manager
disconnected
/
)
;
const
profileDir
=
gProfD
.
clone
(
)
;
profileDir
.
append
(
"
extensions
"
)
;
const
IGNORE_ID
=
"
system_delay_ignore
tests
.
mozilla
.
org
"
;
const
COMPLETE_ID
=
"
system_delay_complete
tests
.
mozilla
.
org
"
;
const
DEFER_ID
=
"
system_delay_defer
tests
.
mozilla
.
org
"
;
const
DEFER2_ID
=
"
system_delay_defer2
tests
.
mozilla
.
org
"
;
const
DEFER_ALSO_ID
=
"
system_delay_defer_also
tests
.
mozilla
.
org
"
;
const
NORMAL_ID
=
"
system1
tests
.
mozilla
.
org
"
;
const
distroDir
=
FileUtils
.
getDir
(
"
ProfD
"
[
"
sysfeatures
"
]
true
)
;
registerDirectory
(
"
XREAppFeat
"
distroDir
)
;
AddonTestUtils
.
usePrivilegedSignatures
=
id
=
>
"
system
"
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
42
"
)
;
function
promiseInstallPostponed
(
addonID1
addonID2
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
seen
=
[
]
;
let
listener
=
{
onInstallFailed
:
(
)
=
>
{
AddonManager
.
removeInstallListener
(
listener
)
;
reject
(
"
extension
installation
should
not
have
failed
"
)
;
}
onInstallEnded
:
install
=
>
{
AddonManager
.
removeInstallListener
(
listener
)
;
reject
(
extension
installation
should
not
have
ended
for
{
install
.
addon
.
id
}
)
;
}
onInstallPostponed
:
install
=
>
{
seen
.
push
(
install
.
addon
.
id
)
;
if
(
seen
.
includes
(
addonID1
)
&
&
seen
.
includes
(
addonID2
)
)
{
AddonManager
.
removeInstallListener
(
listener
)
;
resolve
(
)
;
}
}
}
;
AddonManager
.
addInstallListener
(
listener
)
;
}
)
;
}
function
promiseInstallResumed
(
addonID1
addonID2
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
seenPostponed
=
[
]
;
let
seenEnded
=
[
]
;
let
listener
=
{
onInstallFailed
:
(
)
=
>
{
AddonManager
.
removeInstallListener
(
listener
)
;
reject
(
"
extension
installation
should
not
have
failed
"
)
;
}
onInstallEnded
:
install
=
>
{
seenEnded
.
push
(
install
.
addon
.
id
)
;
if
(
seenEnded
.
includes
(
addonID1
)
&
&
seenEnded
.
includes
(
addonID2
)
&
&
(
seenPostponed
.
includes
(
addonID1
)
&
&
seenPostponed
.
includes
(
addonID2
)
)
)
{
AddonManager
.
removeInstallListener
(
listener
)
;
resolve
(
)
;
}
}
onInstallPostponed
:
install
=
>
{
seenPostponed
.
push
(
install
.
addon
.
id
)
;
}
}
;
AddonManager
.
addInstallListener
(
listener
)
;
}
)
;
}
function
promiseInstallDeferred
(
addonID1
addonID2
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
seenEnded
=
[
]
;
let
listener
=
{
onInstallFailed
:
(
)
=
>
{
AddonManager
.
removeInstallListener
(
listener
)
;
reject
(
"
extension
installation
should
not
have
failed
"
)
;
}
onInstallEnded
:
install
=
>
{
seenEnded
.
push
(
install
.
addon
.
id
)
;
if
(
seenEnded
.
includes
(
addonID1
)
&
&
seenEnded
.
includes
(
addonID2
)
)
{
AddonManager
.
removeInstallListener
(
listener
)
;
resolve
(
)
;
}
}
}
;
AddonManager
.
addInstallListener
(
listener
)
;
}
)
;
}
add_task
(
async
function
(
)
{
Services
.
prefs
.
setCharPref
(
PREF_SYSTEM_ADDON_SET
"
"
)
;
let
xpi
=
await
getSystemAddonXPI
(
1
"
1
.
0
"
)
;
xpi
.
copyTo
(
distroDir
"
system1
tests
.
mozilla
.
org
.
xpi
"
)
;
function
background
(
)
{
browser
.
runtime
.
onUpdateAvailable
.
addListener
(
(
)
=
>
{
browser
.
test
.
sendMessage
(
"
got
-
update
"
)
;
}
)
;
}
xpi
=
await
createTempWebExtensionFile
(
{
background
manifest
:
{
version
:
"
1
.
0
"
applications
:
{
gecko
:
{
id
:
IGNORE_ID
}
}
}
}
)
;
xpi
.
copyTo
(
distroDir
{
IGNORE_ID
}
.
xpi
)
;
let
xpi2
=
await
createTempWebExtensionFile
(
{
manifest
:
{
version
:
"
2
.
0
"
applications
:
{
gecko
:
{
id
:
IGNORE_ID
}
}
}
}
)
;
await
overrideBuiltIns
(
{
system
:
[
IGNORE_ID
NORMAL_ID
]
}
)
;
let
extension
=
ExtensionTestUtils
.
expectExtension
(
IGNORE_ID
)
;
await
Promise
.
all
(
[
promiseStartupManager
(
)
extension
.
awaitStartup
(
)
]
)
;
let
updateList
=
[
{
id
:
IGNORE_ID
version
:
"
2
.
0
"
path
:
"
system_delay_ignore_2
.
xpi
"
xpi
:
xpi2
}
{
id
:
NORMAL_ID
version
:
"
2
.
0
"
path
:
"
system1_2
.
xpi
"
xpi
:
await
getSystemAddonXPI
(
1
"
2
.
0
"
)
}
]
;
await
Promise
.
all
(
[
promiseInstallPostponed
(
IGNORE_ID
NORMAL_ID
)
installSystemAddons
(
buildSystemAddonUpdates
(
updateList
)
)
extension
.
awaitMessage
(
"
got
-
update
"
)
]
)
;
let
addon_postponed
=
await
promiseAddonByID
(
IGNORE_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
addon_postponed
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
await
Promise
.
all
(
[
promiseRestartManager
(
)
extension
.
awaitStartup
(
)
]
)
;
let
addon_upgraded
=
await
promiseAddonByID
(
IGNORE_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
addon_upgraded
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
await
promiseShutdownManager
(
)
;
}
)
;
add_task
(
async
function
(
)
{
Services
.
prefs
.
setCharPref
(
PREF_SYSTEM_ADDON_SET
"
"
)
;
let
xpi
=
await
getSystemAddonXPI
(
1
"
1
.
0
"
)
;
xpi
.
copyTo
(
distroDir
"
system1
tests
.
mozilla
.
org
.
xpi
"
)
;
function
background
(
)
{
browser
.
runtime
.
onUpdateAvailable
.
addListener
(
function
listener
(
)
{
browser
.
runtime
.
onUpdateAvailable
.
removeListener
(
listener
)
;
browser
.
test
.
sendMessage
(
"
got
-
update
"
)
;
browser
.
runtime
.
reload
(
)
;
}
)
;
}
xpi
=
await
createTempWebExtensionFile
(
{
background
manifest
:
{
version
:
"
1
.
0
"
applications
:
{
gecko
:
{
id
:
COMPLETE_ID
}
}
}
}
)
;
xpi
.
copyTo
(
distroDir
{
COMPLETE_ID
}
.
xpi
)
;
let
xpi2
=
await
createTempWebExtensionFile
(
{
manifest
:
{
version
:
"
2
.
0
"
applications
:
{
gecko
:
{
id
:
COMPLETE_ID
}
}
}
}
)
;
await
overrideBuiltIns
(
{
system
:
[
COMPLETE_ID
NORMAL_ID
]
}
)
;
let
extension
=
ExtensionTestUtils
.
expectExtension
(
COMPLETE_ID
)
;
await
Promise
.
all
(
[
promiseStartupManager
(
)
extension
.
awaitStartup
(
)
]
)
;
let
updateList
=
[
{
id
:
COMPLETE_ID
version
:
"
2
.
0
"
path
:
"
system_delay_complete_2
.
xpi
"
xpi
:
xpi2
}
{
id
:
NORMAL_ID
version
:
"
2
.
0
"
path
:
"
system1_2
.
xpi
"
xpi
:
await
getSystemAddonXPI
(
1
"
2
.
0
"
)
}
]
;
let
addon_allowed
=
await
promiseAddonByID
(
COMPLETE_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
equal
(
addon_allowed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
addon_allowed
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
equal
(
addon_allowed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
await
Promise
.
all
(
[
extension
.
awaitMessage
(
"
got
-
update
"
)
promiseInstallResumed
(
COMPLETE_ID
NORMAL_ID
)
installSystemAddons
(
buildSystemAddonUpdates
(
updateList
)
)
]
)
;
addon_allowed
=
await
promiseAddonByID
(
COMPLETE_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
equal
(
addon_allowed
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
addon_allowed
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
equal
(
addon_allowed
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
await
Promise
.
all
(
[
promiseRestartManager
(
)
extension
.
awaitStartup
(
)
]
)
;
let
addon_upgraded
=
await
promiseAddonByID
(
COMPLETE_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
addon_upgraded
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
await
promiseShutdownManager
(
)
;
}
)
;
function
delayBackground
(
)
{
browser
.
test
.
onMessage
.
addListener
(
msg
=
>
{
browser
.
runtime
.
reload
(
)
;
browser
.
test
.
sendMessage
(
"
reloaded
"
)
;
}
)
;
browser
.
runtime
.
onUpdateAvailable
.
addListener
(
async
function
listener
(
)
{
browser
.
runtime
.
onUpdateAvailable
.
removeListener
(
listener
)
;
browser
.
test
.
sendMessage
(
"
got
-
update
"
)
;
}
)
;
}
add_task
(
async
function
(
)
{
Services
.
prefs
.
setCharPref
(
PREF_SYSTEM_ADDON_SET
"
"
)
;
let
xpi
=
await
getSystemAddonXPI
(
1
"
1
.
0
"
)
;
xpi
.
copyTo
(
distroDir
"
system1
tests
.
mozilla
.
org
.
xpi
"
)
;
xpi
=
await
createTempWebExtensionFile
(
{
background
:
delayBackground
manifest
:
{
version
:
"
1
.
0
"
applications
:
{
gecko
:
{
id
:
DEFER_ID
}
}
}
}
)
;
xpi
.
copyTo
(
distroDir
{
DEFER_ID
}
.
xpi
)
;
let
xpi2
=
await
createTempWebExtensionFile
(
{
manifest
:
{
version
:
"
2
.
0
"
applications
:
{
gecko
:
{
id
:
DEFER_ID
}
}
}
}
)
;
await
overrideBuiltIns
(
{
system
:
[
DEFER_ID
NORMAL_ID
]
}
)
;
let
extension
=
ExtensionTestUtils
.
expectExtension
(
DEFER_ID
)
;
await
Promise
.
all
(
[
promiseStartupManager
(
)
extension
.
awaitStartup
(
)
]
)
;
let
updateList
=
[
{
id
:
DEFER_ID
version
:
"
2
.
0
"
path
:
"
system_delay_defer_2
.
xpi
"
xpi
:
xpi2
}
{
id
:
NORMAL_ID
version
:
"
2
.
0
"
path
:
"
system1_2
.
xpi
"
xpi
:
await
getSystemAddonXPI
(
1
"
2
.
0
"
)
}
]
;
await
Promise
.
all
(
[
promiseInstallPostponed
(
DEFER_ID
NORMAL_ID
)
installSystemAddons
(
buildSystemAddonUpdates
(
updateList
)
)
extension
.
awaitMessage
(
"
got
-
update
"
)
]
)
;
let
addon_postponed
=
await
promiseAddonByID
(
DEFER_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
addon_postponed
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
let
deferred
=
promiseInstallDeferred
(
DEFER_ID
NORMAL_ID
)
;
extension
.
sendMessage
(
"
go
"
)
;
await
Promise
.
all
(
[
deferred
extension
.
awaitMessage
(
"
reloaded
"
)
]
)
;
let
addon_allowed
=
await
promiseAddonByID
(
DEFER_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
equal
(
addon_allowed
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
addon_allowed
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
equal
(
addon_allowed
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
await
promiseRestartManager
(
)
;
let
addon_upgraded
=
await
promiseAddonByID
(
DEFER_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
addon_upgraded
=
await
promiseAddonByID
(
NORMAL_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
await
promiseShutdownManager
(
)
;
}
)
;
add_task
(
async
function
(
)
{
Services
.
prefs
.
setCharPref
(
PREF_SYSTEM_ADDON_SET
"
"
)
;
let
updateList
=
[
]
;
let
xpi
=
await
createTempWebExtensionFile
(
{
background
:
delayBackground
manifest
:
{
version
:
"
1
.
0
"
applications
:
{
gecko
:
{
id
:
DEFER2_ID
}
}
}
}
)
;
xpi
.
copyTo
(
distroDir
{
DEFER2_ID
}
.
xpi
)
;
xpi
=
await
createTempWebExtensionFile
(
{
manifest
:
{
version
:
"
2
.
0
"
applications
:
{
gecko
:
{
id
:
DEFER2_ID
}
}
}
}
)
;
updateList
.
push
(
{
id
:
DEFER2_ID
version
:
"
2
.
0
"
path
:
"
system_delay_defer_2
.
xpi
"
xpi
}
)
;
xpi
=
await
createTempWebExtensionFile
(
{
background
:
delayBackground
manifest
:
{
version
:
"
1
.
0
"
applications
:
{
gecko
:
{
id
:
DEFER_ALSO_ID
}
}
}
}
)
;
xpi
.
copyTo
(
distroDir
{
DEFER_ALSO_ID
}
.
xpi
)
;
xpi
=
await
createTempWebExtensionFile
(
{
manifest
:
{
version
:
"
2
.
0
"
applications
:
{
gecko
:
{
id
:
DEFER_ALSO_ID
}
}
}
}
)
;
updateList
.
push
(
{
id
:
DEFER_ALSO_ID
version
:
"
2
.
0
"
path
:
"
system_delay_defer_also_2
.
xpi
"
xpi
}
)
;
await
overrideBuiltIns
(
{
system
:
[
DEFER2_ID
DEFER_ALSO_ID
]
}
)
;
let
extension1
=
ExtensionTestUtils
.
expectExtension
(
DEFER2_ID
)
;
let
extension2
=
ExtensionTestUtils
.
expectExtension
(
DEFER_ALSO_ID
)
;
await
Promise
.
all
(
[
promiseStartupManager
(
)
extension1
.
awaitStartup
(
)
extension2
.
awaitStartup
(
)
]
)
;
await
Promise
.
all
(
[
promiseInstallPostponed
(
DEFER2_ID
DEFER_ALSO_ID
)
installSystemAddons
(
buildSystemAddonUpdates
(
updateList
)
)
extension1
.
awaitMessage
(
"
got
-
update
"
)
extension2
.
awaitMessage
(
"
got
-
update
"
)
]
)
;
let
addon_postponed
=
await
promiseAddonByID
(
DEFER2_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
addon_postponed
=
await
promiseAddonByID
(
DEFER_ALSO_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
let
deferred
=
promiseInstallDeferred
(
DEFER2_ID
DEFER_ALSO_ID
)
;
extension1
.
sendMessage
(
"
go
"
)
;
await
extension1
.
awaitMessage
(
"
reloaded
"
)
;
addon_postponed
=
await
promiseAddonByID
(
DEFER2_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
addon_postponed
=
await
promiseAddonByID
(
DEFER_ALSO_ID
)
;
Assert
.
notEqual
(
addon_postponed
null
)
;
Assert
.
equal
(
addon_postponed
.
version
"
1
.
0
"
)
;
Assert
.
ok
(
addon_postponed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_postponed
.
appDisabled
)
;
Assert
.
ok
(
addon_postponed
.
isActive
)
;
Assert
.
equal
(
addon_postponed
.
type
"
extension
"
)
;
extension2
.
sendMessage
(
"
go
"
)
;
await
Promise
.
all
(
[
extension2
.
awaitMessage
(
"
reloaded
"
)
deferred
extension1
.
awaitStartup
(
)
extension2
.
awaitStartup
(
)
]
)
;
let
addon_allowed
=
await
promiseAddonByID
(
DEFER2_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
equal
(
addon_allowed
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
addon_allowed
=
await
promiseAddonByID
(
DEFER_ALSO_ID
)
;
Assert
.
notEqual
(
addon_allowed
null
)
;
Assert
.
ok
(
addon_allowed
.
isCompatible
)
;
Assert
.
ok
(
!
addon_allowed
.
appDisabled
)
;
Assert
.
ok
(
addon_allowed
.
isActive
)
;
Assert
.
equal
(
addon_allowed
.
type
"
extension
"
)
;
await
Promise
.
all
(
[
promiseRestartManager
(
)
extension1
.
awaitStartup
(
)
extension2
.
awaitStartup
(
)
]
)
;
let
addon_upgraded
=
await
promiseAddonByID
(
DEFER2_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
addon_upgraded
=
await
promiseAddonByID
(
DEFER_ALSO_ID
)
;
Assert
.
notEqual
(
addon_upgraded
null
)
;
Assert
.
equal
(
addon_upgraded
.
version
"
2
.
0
"
)
;
Assert
.
ok
(
addon_upgraded
.
isCompatible
)
;
Assert
.
ok
(
!
addon_upgraded
.
appDisabled
)
;
Assert
.
ok
(
addon_upgraded
.
isActive
)
;
Assert
.
equal
(
addon_upgraded
.
type
"
extension
"
)
;
await
promiseShutdownManager
(
)
;
}
)
;
