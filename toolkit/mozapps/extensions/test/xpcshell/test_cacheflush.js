var
gExpectedFile
=
null
;
var
gCacheFlushCount
=
0
;
var
CacheFlushObserver
=
{
observe
(
aSubject
aTopic
aData
)
{
if
(
aTopic
!
=
"
flush
-
cache
-
entry
"
)
return
;
if
(
aData
=
=
"
cert
-
override
"
)
return
;
ok
(
gExpectedFile
!
=
null
)
;
ok
(
aSubject
instanceof
AM_Ci
.
nsIFile
)
;
equal
(
aSubject
.
path
gExpectedFile
.
path
)
;
gCacheFlushCount
+
+
;
}
}
;
const
ADDONS
=
[
{
id
:
"
addon1
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
name
:
"
Cache
Flush
Test
"
targetApplications
:
[
{
id
:
"
xpcshell
tests
.
mozilla
.
org
"
minVersion
:
"
1
"
maxVersion
:
"
1
"
}
]
}
{
id
:
"
addon2
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
name
:
"
Cache
Flush
Test
"
bootstrap
:
true
targetApplications
:
[
{
id
:
"
xpcshell
tests
.
mozilla
.
org
"
minVersion
:
"
1
"
maxVersion
:
"
1
"
}
]
}
]
;
const
XPIS
=
ADDONS
.
map
(
addon
=
>
createTempXPIFile
(
addon
)
)
;
add_task
(
async
function
setup
(
)
{
Services
.
obs
.
addObserver
(
CacheFlushObserver
"
flush
-
cache
-
entry
"
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
2
"
)
;
await
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
test_flush_pending_install
(
)
{
let
install
=
await
AddonManager
.
getInstallForFile
(
XPIS
[
0
]
)
;
await
promiseCompleteInstall
(
install
)
;
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
staged
"
)
;
gExpectedFile
.
append
(
"
addon1
tests
.
mozilla
.
org
.
xpi
"
)
;
install
.
cancel
(
)
;
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
}
)
;
add_task
(
async
function
test_flush_uninstall
(
)
{
await
promiseInstallFile
(
XPIS
[
0
]
)
;
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
staged
"
)
;
gExpectedFile
.
append
(
"
addon1
tests
.
mozilla
.
org
.
xpi
"
)
;
await
promiseRestartManager
(
)
;
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
let
addon
=
await
AddonManager
.
getAddonByID
(
"
addon1
tests
.
mozilla
.
org
"
)
;
ok
(
addon
!
=
null
)
;
addon
.
uninstall
(
)
;
equal
(
gCacheFlushCount
0
)
;
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
addon1
tests
.
mozilla
.
org
.
xpi
"
)
;
await
promiseRestartManager
(
)
;
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
}
)
;
add_task
(
async
function
test_flush_restartless_install
(
)
{
let
install
=
await
AddonManager
.
getInstallForFile
(
XPIS
[
1
]
)
;
await
new
Promise
(
resolve
=
>
{
install
.
addListener
(
{
onInstallStarted
(
)
{
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
staged
"
)
;
gExpectedFile
.
append
(
"
addon2
tests
.
mozilla
.
org
.
xpi
"
)
;
}
onInstallEnded
(
)
{
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
resolve
(
)
;
}
}
)
;
install
.
install
(
)
;
}
)
;
}
)
;
add_task
(
async
function
test_flush_uninstall
(
)
{
let
addon
=
await
AddonManager
.
getAddonByID
(
"
addon2
tests
.
mozilla
.
org
"
)
;
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
addon2
tests
.
mozilla
.
org
.
xpi
"
)
;
addon
.
uninstall
(
)
;
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
}
)
;
