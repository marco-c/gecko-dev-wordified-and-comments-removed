var
gExpectedFile
=
null
;
var
gCacheFlushCount
=
0
;
var
CacheFlushObserver
=
{
observe
(
aSubject
aTopic
aData
)
{
if
(
aTopic
!
=
"
flush
-
cache
-
entry
"
)
return
;
if
(
aData
=
=
"
cert
-
override
"
)
return
;
Assert
.
ok
(
gExpectedFile
!
=
null
)
;
Assert
.
ok
(
aSubject
instanceof
AM_Ci
.
nsIFile
)
;
Assert
.
equal
(
aSubject
.
path
gExpectedFile
.
path
)
;
gCacheFlushCount
+
+
;
}
}
;
function
run_test
(
)
{
do_test_pending
(
)
;
Services
.
obs
.
addObserver
(
CacheFlushObserver
"
flush
-
cache
-
entry
"
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
2
"
)
;
startupManager
(
)
;
run_test_1
(
)
;
}
function
run_test_1
(
)
{
AddonManager
.
getInstallForFile
(
do_get_addon
(
"
test_cacheflush1
"
)
function
(
aInstall
)
{
completeAllInstalls
(
[
aInstall
]
function
(
)
{
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
staged
"
)
;
gExpectedFile
.
append
(
"
addon1
tests
.
mozilla
.
org
.
xpi
"
)
;
aInstall
.
cancel
(
)
;
Assert
.
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
run_test_2
(
)
;
}
)
;
}
)
;
}
function
run_test_2
(
)
{
installAllFiles
(
[
do_get_addon
(
"
test_cacheflush1
"
)
]
function
(
)
{
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
staged
"
)
;
gExpectedFile
.
append
(
"
addon1
tests
.
mozilla
.
org
.
xpi
"
)
;
restartManager
(
)
;
Assert
.
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
AddonManager
.
getAddonByID
(
"
addon1
tests
.
mozilla
.
org
"
function
(
a1
)
{
Assert
.
ok
(
a1
!
=
null
)
;
a1
.
uninstall
(
)
;
Assert
.
equal
(
gCacheFlushCount
0
)
;
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
addon1
tests
.
mozilla
.
org
.
xpi
"
)
;
restartManager
(
)
;
Assert
.
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
do_execute_soon
(
run_test_3
)
;
}
)
;
}
)
;
}
function
run_test_3
(
)
{
AddonManager
.
getInstallForFile
(
do_get_addon
(
"
test_cacheflush2
"
)
function
(
aInstall
)
{
aInstall
.
addListener
(
{
onInstallStarted
(
)
{
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
staged
"
)
;
gExpectedFile
.
append
(
"
addon2
tests
.
mozilla
.
org
.
xpi
"
)
;
}
onInstallEnded
(
)
{
Assert
.
equal
(
gCacheFlushCount
1
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
do_execute_soon
(
run_test_4
)
;
}
}
)
;
aInstall
.
install
(
)
;
}
)
;
}
function
run_test_4
(
)
{
AddonManager
.
getAddonByID
(
"
addon2
tests
.
mozilla
.
org
"
function
(
a2
)
{
gExpectedFile
=
gProfD
.
clone
(
)
;
gExpectedFile
.
append
(
"
extensions
"
)
;
gExpectedFile
.
append
(
"
addon2
tests
.
mozilla
.
org
.
xpi
"
)
;
a2
.
uninstall
(
)
;
Assert
.
equal
(
gCacheFlushCount
2
)
;
gExpectedFile
=
null
;
gCacheFlushCount
=
0
;
do_execute_soon
(
do_test_finished
)
;
}
)
;
}
