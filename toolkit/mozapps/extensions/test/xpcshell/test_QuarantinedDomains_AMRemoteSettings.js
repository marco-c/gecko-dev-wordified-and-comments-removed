createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
42
"
"
42
"
)
;
const
QUARANTINE_LIST_PREF
=
"
extensions
.
quarantinedDomains
.
list
"
;
async
function
testQuarantinedDomainsFromRemoteSettings
(
)
{
const
MAX_PREF_LENGTH
=
1
*
1024
*
1024
;
const
quarantinedDomainsSets
=
{
testSet1
:
"
example
.
com
example
.
org
"
testSet2
:
"
someothersite
.
org
testset2
.
org
"
}
;
await
setAndEmitFakeRemoteSettingsData
(
[
{
id
:
"
quarantinedDomains
-
01
-
testSet
-
toolong
"
quarantinedDomains
:
{
[
QUARANTINE_LIST_PREF
]
:
"
x
"
.
repeat
(
MAX_PREF_LENGTH
+
1
)
}
installTriggerDeprecation
:
null
}
{
id
:
"
quarantinedDomains
-
02
-
testSet1
"
quarantinedDomains
:
{
[
QUARANTINE_LIST_PREF
]
:
quarantinedDomainsSets
.
testSet1
}
installTriggerDeprecation
:
null
}
{
id
:
"
quarantinedDomains
-
03
-
testSet2
"
quarantinedDomains
:
{
[
QUARANTINE_LIST_PREF
]
:
quarantinedDomainsSets
.
testSet2
}
installTriggerDeprecation
:
null
}
{
id
:
"
quarantinedDomains
-
04
-
null
"
quarantinedDomains
:
null
installTriggerDeprecation
:
null
}
]
)
;
Assert
.
equal
(
Services
.
prefs
.
getPrefType
(
QUARANTINE_LIST_PREF
)
Services
.
prefs
.
PREF_STRING
Expect
{
QUARANTINE_LIST_PREF
}
preference
type
to
be
string
)
;
Assert
.
equal
(
Services
.
prefs
.
getStringPref
(
QUARANTINE_LIST_PREF
)
quarantinedDomainsSets
.
testSet2
Got
the
expected
value
set
on
{
QUARANTINE_LIST_PREF
}
)
;
for
(
const
domain
of
quarantinedDomainsSets
.
testSet2
.
split
(
"
"
)
)
{
let
uri
=
Services
.
io
.
newURI
(
https
:
/
/
{
domain
}
/
)
;
ok
(
WebExtensionPolicy
.
isQuarantinedURI
(
uri
)
Expect
{
domain
}
to
be
quarantined
)
;
}
for
(
const
domain
of
quarantinedDomainsSets
.
testSet1
.
split
(
"
"
)
)
{
let
uri
=
Services
.
io
.
newURI
(
https
:
/
/
{
domain
}
/
)
;
ok
(
!
WebExtensionPolicy
.
isQuarantinedURI
(
uri
)
Expect
{
domain
}
to
not
be
quarantined
)
;
}
const
NEW_PREF_VALUE
=
"
newdomain1
.
org
newdomain2
.
org
"
;
await
setAndEmitFakeRemoteSettingsData
(
[
{
id
:
"
quarantinedDomains
-
withoutInstallTriggerDeprecation
"
quarantinedDomains
:
{
[
QUARANTINE_LIST_PREF
]
:
NEW_PREF_VALUE
}
}
]
)
;
Assert
.
equal
(
Services
.
prefs
.
getStringPref
(
QUARANTINE_LIST_PREF
)
NEW_PREF_VALUE
Got
the
expected
value
set
on
{
QUARANTINE_LIST_PREF
}
on
record
)
;
await
setAndEmitFakeRemoteSettingsData
(
[
{
id
:
"
quarantinedDomains
-
withoutInstallTriggerDeprecation
"
quarantinedDomains
:
{
[
QUARANTINE_LIST_PREF
]
:
quarantinedDomainsSets
.
testSet1
}
someUnexpectedProperty
:
"
some
unexpected
value
"
}
]
)
;
Assert
.
equal
(
Services
.
prefs
.
getStringPref
(
QUARANTINE_LIST_PREF
)
quarantinedDomainsSets
.
testSet1
Got
the
expected
value
set
on
{
QUARANTINE_LIST_PREF
}
on
record
)
;
}
add_setup
(
async
(
)
=
>
{
await
AddonTestUtils
.
promiseStartupManager
(
)
;
}
)
;
add_task
(
testQuarantinedDomainsFromRemoteSettings
)
;
