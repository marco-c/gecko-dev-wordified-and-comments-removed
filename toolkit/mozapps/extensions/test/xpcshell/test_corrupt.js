var
testserver
=
createHttpServer
(
{
hosts
:
[
"
example
.
com
"
]
}
)
;
testserver
.
registerDirectory
(
"
/
data
/
"
do_get_file
(
"
data
"
)
)
;
Services
.
prefs
.
setBoolPref
(
PREF_EM_CHECK_UPDATE_SECURITY
false
)
;
const
ADDONS
=
{
"
addon3
tests
.
mozilla
.
org
"
:
{
manifest
:
{
name
:
"
Test
3
"
browser_specific_settings
:
{
gecko
:
{
id
:
"
addon3
tests
.
mozilla
.
org
"
update_url
:
"
http
:
/
/
example
.
com
/
data
/
test_corrupt
.
json
"
}
}
}
findUpdates
:
true
desiredState
:
{
isActive
:
true
userDisabled
:
false
appDisabled
:
false
pendingOperations
:
0
}
}
"
addon4
tests
.
mozilla
.
org
"
:
{
manifest
:
{
name
:
"
Test
4
"
browser_specific_settings
:
{
gecko
:
{
id
:
"
addon4
tests
.
mozilla
.
org
"
update_url
:
"
http
:
/
/
example
.
com
/
data
/
test_corrupt
.
json
"
}
}
}
initialState
:
{
userDisabled
:
true
}
findUpdates
:
true
desiredState
:
{
isActive
:
false
userDisabled
:
true
appDisabled
:
false
pendingOperations
:
0
}
}
"
addon5
tests
.
mozilla
.
org
"
:
{
manifest
:
{
name
:
"
Test
5
"
browser_specific_settings
:
{
gecko
:
{
id
:
"
addon5
tests
.
mozilla
.
org
"
}
}
}
desiredState
:
{
isActive
:
true
userDisabled
:
false
appDisabled
:
false
pendingOperations
:
0
}
}
"
addon7
tests
.
mozilla
.
org
"
:
{
manifest
:
{
name
:
"
Test
7
"
browser_specific_settings
:
{
gecko
:
{
id
:
"
addon7
tests
.
mozilla
.
org
"
}
}
}
initialState
:
{
userDisabled
:
true
}
desiredState
:
{
isActive
:
false
userDisabled
:
true
appDisabled
:
false
pendingOperations
:
0
}
}
"
theme1
tests
.
mozilla
.
org
"
:
{
manifest
:
{
manifest_version
:
2
name
:
"
Theme
1
"
version
:
"
1
.
0
"
theme
:
{
images
:
{
theme_frame
:
"
example
.
png
"
}
}
browser_specific_settings
:
{
gecko
:
{
id
:
"
theme1
tests
.
mozilla
.
org
"
}
}
}
desiredState
:
{
isActive
:
false
userDisabled
:
true
appDisabled
:
false
pendingOperations
:
0
}
}
"
theme2
tests
.
mozilla
.
org
"
:
{
manifest
:
{
manifest_version
:
2
name
:
"
Theme
2
"
version
:
"
1
.
0
"
theme
:
{
images
:
{
theme_frame
:
"
example
.
png
"
}
}
browser_specific_settings
:
{
gecko
:
{
id
:
"
theme2
tests
.
mozilla
.
org
"
}
}
}
initialState
:
{
userDisabled
:
false
}
desiredState
:
{
isActive
:
true
userDisabled
:
false
appDisabled
:
false
pendingOperations
:
0
}
}
}
;
const
IDS
=
Object
.
keys
(
ADDONS
)
;
function
promiseUpdates
(
addon
)
{
return
new
Promise
(
resolve
=
>
{
addon
.
findUpdates
(
{
onUpdateFinished
:
resolve
}
AddonManager
.
UPDATE_WHEN_PERIODIC_UPDATE
)
;
}
)
;
}
add_task
(
async
function
setup
(
)
{
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
2
"
"
2
"
)
;
for
(
let
addon
of
Object
.
values
(
ADDONS
)
)
{
let
webext
=
createTempWebExtensionFile
(
{
manifest
:
addon
.
manifest
}
)
;
await
AddonTestUtils
.
manuallyInstall
(
webext
)
;
}
await
promiseStartupManager
(
)
;
let
addons
=
await
getAddons
(
IDS
)
;
for
(
let
[
id
addon
]
of
Object
.
entries
(
ADDONS
)
)
{
if
(
addon
.
initialState
)
{
await
setInitialState
(
addons
.
get
(
id
)
addon
.
initialState
)
;
}
if
(
addon
.
findUpdates
)
{
await
promiseUpdates
(
addons
.
get
(
id
)
)
;
}
}
}
)
;
add_task
(
async
function
test_after_restart
(
)
{
await
promiseRestartManager
(
)
;
info
(
"
Test
add
-
on
state
after
restart
"
)
;
let
addons
=
await
getAddons
(
IDS
)
;
for
(
let
[
id
addon
]
of
Object
.
entries
(
ADDONS
)
)
{
checkAddon
(
id
addons
.
get
(
id
)
addon
.
desiredState
)
;
}
await
promiseShutdownManager
(
)
;
}
)
;
add_task
(
async
function
test_after_corruption
(
)
{
gExtensionsJSON
.
remove
(
true
)
;
gExtensionsJSON
.
create
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
FileUtils
.
PERMS_DIRECTORY
)
;
await
promiseStartupManager
(
)
;
Services
.
obs
.
notifyObservers
(
null
"
sessionstore
-
windows
-
restored
"
)
;
await
AddonManagerPrivate
.
databaseReady
;
info
(
"
Test
add
-
on
state
after
corruption
"
)
;
let
addons
=
await
getAddons
(
IDS
)
;
for
(
let
[
id
addon
]
of
Object
.
entries
(
ADDONS
)
)
{
checkAddon
(
id
addons
.
get
(
id
)
addon
.
desiredState
)
;
}
await
Assert
.
rejects
(
promiseShutdownManager
(
)
/
NotAllowedError
:
Could
not
open
the
file
at
.
+
for
writing
/
)
;
}
)
;
add_task
(
async
function
test_after_second_restart
(
)
{
await
promiseStartupManager
(
)
;
info
(
"
Test
add
-
on
state
after
second
restart
"
)
;
let
addons
=
await
getAddons
(
IDS
)
;
for
(
let
[
id
addon
]
of
Object
.
entries
(
ADDONS
)
)
{
checkAddon
(
id
addons
.
get
(
id
)
addon
.
desiredState
)
;
}
await
Assert
.
rejects
(
promiseShutdownManager
(
)
/
NotAllowedError
:
Could
not
open
the
file
at
.
+
for
writing
/
)
;
}
)
;
