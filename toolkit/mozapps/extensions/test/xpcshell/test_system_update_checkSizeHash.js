let
scopes
=
AddonManager
.
SCOPE_PROFILE
|
AddonManager
.
SCOPE_APPLICATION
;
Services
.
prefs
.
setIntPref
(
"
extensions
.
enabledScopes
"
scopes
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
2
"
)
;
let
distroDir
=
FileUtils
.
getDir
(
"
ProfD
"
[
"
sysfeatures
"
"
empty
"
]
)
;
distroDir
.
create
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
FileUtils
.
PERMS_DIRECTORY
)
;
registerDirectory
(
"
XREAppFeat
"
distroDir
)
;
AddonTestUtils
.
usePrivilegedSignatures
=
(
)
=
>
"
system
"
;
const
TEST_CONDITIONS
=
{
blank
:
{
setup
(
)
{
clearSystemAddonUpdatesDir
(
)
;
distroDir
.
leafName
=
"
empty
"
;
}
initialState
:
[
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
null
}
]
}
withAppSet
:
{
setup
(
)
{
clearSystemAddonUpdatesDir
(
)
;
distroDir
.
leafName
=
"
prefilled
"
;
}
initialState
:
[
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
"
2
.
0
"
asBuiltin
:
true
}
{
isUpgrade
:
false
version
:
"
2
.
0
"
asBuiltin
:
false
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
null
}
]
}
withProfileSet
:
{
async
setup
(
)
{
await
buildPrefilledUpdatesDir
(
)
;
distroDir
.
leafName
=
"
empty
"
;
}
initialState
:
[
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
2
.
0
"
}
{
isUpgrade
:
true
version
:
"
2
.
0
"
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
null
}
]
}
withBothSets
:
{
async
setup
(
)
{
await
buildPrefilledUpdatesDir
(
)
;
distroDir
.
leafName
=
"
hidden
"
;
}
initialState
:
[
{
isUpgrade
:
false
version
:
"
1
.
0
"
asBuiltin
:
false
}
{
isUpgrade
:
true
version
:
"
2
.
0
"
}
{
isUpgrade
:
true
version
:
"
2
.
0
"
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
false
version
:
null
}
]
}
}
;
const
TESTS
=
{
checkSizeHash
:
{
updateList
:
[
]
finalState
:
{
blank
:
[
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
1
.
0
"
}
]
withAppSet
:
[
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
1
.
0
"
}
]
withProfileSet
:
[
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
1
.
0
"
}
]
withBothSets
:
[
{
isUpgrade
:
false
version
:
"
1
.
0
"
asBuiltin
:
false
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
true
version
:
"
3
.
0
"
}
{
isUpgrade
:
false
version
:
null
}
{
isUpgrade
:
true
version
:
"
1
.
0
"
}
]
}
}
}
;
add_task
(
async
function
setup
(
)
{
await
initSystemAddonDirs
(
)
;
await
overrideBuiltIns
(
{
system
:
[
]
}
)
;
await
promiseStartupManager
(
)
;
await
promiseShutdownManager
(
)
;
let
list
=
TESTS
.
checkSizeHash
.
updateList
;
let
xpi
=
await
getSystemAddonXPI
(
2
"
3
.
0
"
)
;
list
.
push
(
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system2_3
.
xpi
"
xpi
size
:
xpi
.
fileSize
}
)
;
xpi
=
await
getSystemAddonXPI
(
3
"
3
.
0
"
)
;
let
[
hashFunction
hashValue
]
=
do_get_file_hash
(
xpi
"
sha256
"
)
.
split
(
"
:
"
)
;
list
.
push
(
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system3_3
.
xpi
"
xpi
hashFunction
hashValue
}
)
;
xpi
=
await
getSystemAddonXPI
(
5
"
1
.
0
"
)
;
[
hashFunction
hashValue
]
=
do_get_file_hash
(
xpi
"
sha256
"
)
.
split
(
"
:
"
)
;
list
.
push
(
{
id
:
"
system5
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system5_1
.
xpi
"
size
:
xpi
.
fileSize
xpi
hashFunction
hashValue
}
)
;
}
)
;
add_task
(
async
function
(
)
{
for
(
let
setupName
of
Object
.
keys
(
TEST_CONDITIONS
)
)
{
for
(
let
testName
of
Object
.
keys
(
TESTS
)
)
{
info
(
"
Running
test
"
+
setupName
+
"
"
+
testName
)
;
let
setup
=
TEST_CONDITIONS
[
setupName
]
;
let
test
=
TESTS
[
testName
]
;
await
execSystemAddonTest
(
setupName
setup
test
distroDir
)
;
}
}
}
)
;
