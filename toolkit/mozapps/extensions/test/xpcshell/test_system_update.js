const
PREF_SYSTEM_ADDON_SET
=
"
extensions
.
systemAddonSet
"
;
const
PREF_SYSTEM_ADDON_UPDATE_URL
=
"
extensions
.
systemAddon
.
update
.
url
"
;
const
PREF_XPI_STATE
=
"
extensions
.
xpiState
"
;
const
PREF_APP_UPDATE_ENABLED
=
"
app
.
update
.
enabled
"
;
Components
.
utils
.
import
(
"
resource
:
/
/
testing
-
common
/
httpd
.
js
"
)
;
const
{
computeHash
}
=
Components
.
utils
.
import
(
"
resource
:
/
/
gre
/
modules
/
addons
/
ProductAddonChecker
.
jsm
"
)
;
const
featureDir
=
FileUtils
.
getDir
(
"
ProfD
"
[
"
features
"
]
)
;
function
getCurrentFeatureDir
(
)
{
let
dir
=
featureDir
.
clone
(
)
;
let
set
=
JSON
.
parse
(
Services
.
prefs
.
getCharPref
(
PREF_SYSTEM_ADDON_SET
)
)
;
dir
.
append
(
set
.
directory
)
;
return
dir
;
}
let
dir
=
FileUtils
.
getDir
(
"
ProfD
"
[
"
features
"
"
prefilled
"
]
true
)
;
do_get_file
(
"
data
/
system_addons
/
system2_2
.
xpi
"
)
.
copyTo
(
dir
"
system2
tests
.
mozilla
.
org
.
xpi
"
)
;
do_get_file
(
"
data
/
system_addons
/
system3_2
.
xpi
"
)
.
copyTo
(
dir
"
system3
tests
.
mozilla
.
org
.
xpi
"
)
;
FileUtils
.
getFile
(
"
ProfD
"
[
"
features
"
"
prefilled
"
"
system2
tests
.
mozilla
.
org
.
xpi
"
]
)
.
lastModifiedTime
-
=
10000
;
FileUtils
.
getFile
(
"
ProfD
"
[
"
features
"
"
prefilled
"
"
system3
tests
.
mozilla
.
org
.
xpi
"
]
)
.
lastModifiedTime
-
=
10000
;
const
prefilledSet
=
{
schema
:
1
directory
:
dir
.
leafName
addons
:
{
"
system2
tests
.
mozilla
.
org
"
:
{
version
:
"
2
.
0
"
}
"
system3
tests
.
mozilla
.
org
"
:
{
version
:
"
2
.
0
"
}
}
}
;
dir
=
FileUtils
.
getDir
(
"
ProfD
"
[
"
sysfeatures
"
"
hidden
"
]
true
)
;
do_get_file
(
"
data
/
system_addons
/
system1_1
.
xpi
"
)
.
copyTo
(
dir
"
system1
tests
.
mozilla
.
org
.
xpi
"
)
;
do_get_file
(
"
data
/
system_addons
/
system2_1
.
xpi
"
)
.
copyTo
(
dir
"
system2
tests
.
mozilla
.
org
.
xpi
"
)
;
dir
=
FileUtils
.
getDir
(
"
ProfD
"
[
"
sysfeatures
"
"
prefilled
"
]
true
)
;
do_get_file
(
"
data
/
system_addons
/
system2_2
.
xpi
"
)
.
copyTo
(
dir
"
system2
tests
.
mozilla
.
org
.
xpi
"
)
;
do_get_file
(
"
data
/
system_addons
/
system3_2
.
xpi
"
)
.
copyTo
(
dir
"
system3
tests
.
mozilla
.
org
.
xpi
"
)
;
const
distroDir
=
FileUtils
.
getDir
(
"
ProfD
"
[
"
sysfeatures
"
"
empty
"
]
true
)
;
registerDirectory
(
"
XREAppFeat
"
distroDir
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
2
"
)
;
let
testserver
=
new
HttpServer
(
)
;
testserver
.
registerDirectory
(
"
/
data
/
"
do_get_file
(
"
data
/
system_addons
"
)
)
;
testserver
.
start
(
)
;
let
root
=
testserver
.
identity
.
primaryScheme
+
"
:
/
/
"
+
testserver
.
identity
.
primaryHost
+
"
:
"
+
testserver
.
identity
.
primaryPort
+
"
/
data
/
"
Services
.
prefs
.
setCharPref
(
PREF_SYSTEM_ADDON_UPDATE_URL
root
+
"
update
.
xml
"
)
;
function
makeUUID
(
)
{
let
uuidGen
=
AM_Cc
[
"
mozilla
.
org
/
uuid
-
generator
;
1
"
]
.
getService
(
AM_Ci
.
nsIUUIDGenerator
)
;
return
uuidGen
.
generateUUID
(
)
.
toString
(
)
;
}
function
*
serve_update
(
xml
perform_update
)
{
testserver
.
registerPathHandler
(
"
/
data
/
update
.
xml
"
(
request
response
)
=
>
{
response
.
write
(
xml
)
;
}
)
;
try
{
yield
perform_update
(
)
;
}
finally
{
testserver
.
registerPathHandler
(
"
/
data
/
update
.
xml
"
null
)
;
}
}
function
*
install_system_addons
(
xml
)
{
do_print
(
"
Triggering
system
add
-
on
update
check
.
"
)
;
yield
serve_update
(
xml
function
*
(
)
{
let
{
XPIProvider
}
=
Components
.
utils
.
import
(
"
resource
:
/
/
gre
/
modules
/
addons
/
XPIProvider
.
jsm
"
)
;
yield
XPIProvider
.
updateSystemAddons
(
)
;
}
)
;
}
function
*
update_all_addons
(
xml
)
{
do_print
(
"
Triggering
full
add
-
on
update
check
.
"
)
;
yield
serve_update
(
xml
function
(
)
{
return
new
Promise
(
resolve
=
>
{
Services
.
obs
.
addObserver
(
function
(
)
{
Services
.
obs
.
removeObserver
(
arguments
.
callee
"
addons
-
background
-
update
-
complete
"
)
;
resolve
(
)
;
}
"
addons
-
background
-
update
-
complete
"
false
)
;
gInternalManager
.
notify
(
null
)
;
}
)
;
}
)
;
}
function
*
build_xml
(
addons
)
{
let
xml
=
<
?
xml
version
=
"
1
.
0
"
encoding
=
"
UTF
-
8
"
?
>
\
n
\
n
<
updates
>
\
n
;
if
(
addons
)
{
xml
+
=
<
addons
>
\
n
;
for
(
let
addon
of
addons
)
{
xml
+
=
<
addon
id
=
"
{
addon
.
id
}
"
URL
=
"
{
root
+
addon
.
path
}
"
version
=
"
{
addon
.
version
}
"
;
if
(
addon
.
size
)
xml
+
=
size
=
"
{
addon
.
size
}
"
;
if
(
addon
.
hashFunction
)
xml
+
=
hashFunction
=
"
{
addon
.
hashFunction
}
"
;
if
(
addon
.
hashValue
)
xml
+
=
hashValue
=
"
{
addon
.
hashValue
}
"
;
xml
+
=
/
>
\
n
;
}
xml
+
=
<
/
addons
>
\
n
;
}
xml
+
=
<
/
updates
>
\
n
;
return
xml
;
}
function
*
check_installed
(
inProfile
.
.
.
versions
)
{
let
expectedDir
=
inProfile
?
getCurrentFeatureDir
(
)
:
distroDir
;
for
(
let
i
=
0
;
i
<
versions
.
length
;
i
+
+
)
{
let
id
=
"
system
"
+
(
i
+
1
)
+
"
tests
.
mozilla
.
org
"
;
let
addon
=
yield
promiseAddonByID
(
id
)
;
if
(
versions
[
i
]
)
{
do_check_neq
(
addon
null
)
;
do_check_eq
(
addon
.
version
versions
[
i
]
)
;
do_check_true
(
addon
.
isActive
)
;
do_check_false
(
addon
.
foreignInstall
)
;
do_check_true
(
addon
.
hidden
)
;
let
file
=
expectedDir
.
clone
(
)
;
file
.
append
(
id
+
"
.
xpi
"
)
;
do_check_true
(
file
.
exists
(
)
)
;
do_check_true
(
file
.
isFile
(
)
)
;
let
uri
=
addon
.
getResourceURI
(
null
)
;
do_check_true
(
uri
instanceof
AM_Ci
.
nsIFileURL
)
;
do_check_eq
(
uri
.
file
.
path
file
.
path
)
;
let
installed
=
Services
.
prefs
.
getCharPref
(
"
bootstraptest
.
"
+
id
+
"
.
active_version
"
)
;
do_check_eq
(
installed
versions
[
i
]
)
;
}
else
{
if
(
inProfile
)
{
do_check_eq
(
addon
null
)
;
}
else
{
do_check_true
(
!
addon
|
|
!
addon
.
isActive
)
;
}
try
{
Services
.
prefs
.
getCharPref
(
"
bootstraptest
.
"
+
id
+
"
.
active_version
"
)
;
do_throw
(
"
Expected
pref
to
be
missing
"
)
;
}
catch
(
e
)
{
}
}
}
}
const
TEST_CONDITIONS
=
{
blank
:
{
setup
:
function
*
(
)
{
Services
.
prefs
.
clearUserPref
(
PREF_SYSTEM_ADDON_SET
)
;
distroDir
.
leafName
=
"
empty
"
;
}
initialState
:
[
false
null
null
null
null
null
]
}
withAppSet
:
{
setup
:
function
*
(
)
{
Services
.
prefs
.
clearUserPref
(
PREF_SYSTEM_ADDON_SET
)
;
distroDir
.
leafName
=
"
prefilled
"
;
}
initialState
:
[
false
null
"
2
.
0
"
"
2
.
0
"
null
null
]
}
withProfileSet
:
{
setup
:
function
*
(
)
{
Services
.
prefs
.
setCharPref
(
PREF_SYSTEM_ADDON_SET
JSON
.
stringify
(
prefilledSet
)
)
;
distroDir
.
leafName
=
"
empty
"
;
}
initialState
:
[
true
null
"
2
.
0
"
"
2
.
0
"
null
null
]
}
withBothSets
:
{
setup
:
function
*
(
)
{
Services
.
prefs
.
setCharPref
(
PREF_SYSTEM_ADDON_SET
JSON
.
stringify
(
prefilledSet
)
)
;
distroDir
.
leafName
=
"
hidden
"
;
}
initialState
:
[
true
null
"
2
.
0
"
"
2
.
0
"
null
null
]
}
}
;
const
TESTS
=
{
error
:
{
test
:
function
*
(
)
{
try
{
yield
install_system_addons
(
"
foobar
"
)
;
do_throw
(
"
Expected
to
fail
the
update
check
"
)
;
}
catch
(
e
)
{
do_check_true
(
true
"
Expected
to
fail
the
update
check
"
)
;
}
}
}
blank
:
{
updateList
:
null
}
empty
:
{
updateList
:
[
]
finalState
:
[
true
null
null
null
null
null
]
}
newset
:
{
updateList
:
[
{
id
:
"
system4
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system4_1
.
xpi
"
}
{
id
:
"
system5
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system5_1
.
xpi
"
}
]
finalState
:
[
true
null
null
null
"
1
.
0
"
"
1
.
0
"
]
}
upgrades
:
{
updateList
:
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system2_3
.
xpi
"
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system3_3
.
xpi
"
}
]
finalState
:
[
true
null
"
3
.
0
"
"
3
.
0
"
null
null
]
}
overlapping
:
{
updateList
:
[
{
id
:
"
system1
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system1_2
.
xpi
"
}
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system2_2
.
xpi
"
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system3_3
.
xpi
"
}
{
id
:
"
system4
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system4_1
.
xpi
"
}
]
finalState
:
[
true
"
2
.
0
"
"
2
.
0
"
"
3
.
0
"
"
1
.
0
"
null
]
}
badVersion
:
{
fails
:
true
updateList
:
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
4
.
0
"
path
:
"
system2_3
.
xpi
"
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system3_3
.
xpi
"
}
]
}
badSize
:
{
fails
:
true
updateList
:
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system2_3
.
xpi
"
size
:
2
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system3_3
.
xpi
"
}
]
}
badHash
:
{
fails
:
true
updateList
:
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system2_3
.
xpi
"
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system3_3
.
xpi
"
hashFunction
:
"
sha1
"
hashValue
:
"
205a4c49bd513ebd30594e380c19e86bba1f83e2
"
}
]
}
checkSizeHash
:
{
updateList
:
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system2_3
.
xpi
"
size
:
858
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
3
.
0
"
path
:
"
system3_3
.
xpi
"
hashFunction
:
"
sha1
"
hashValue
:
"
105a4c49bd513ebd30594e380c19e86bba1f83e2
"
}
{
id
:
"
system5
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system5_1
.
xpi
"
size
:
857
hashFunction
:
"
sha1
"
hashValue
:
"
664e9218be3c9acbb9029e715c1e5d2fbb4ea2cc
"
}
]
finalState
:
[
true
null
"
3
.
0
"
"
3
.
0
"
null
"
1
.
0
"
]
}
}
add_task
(
function
*
setup
(
)
{
startupManager
(
)
;
yield
promiseShutdownManager
(
)
;
}
)
function
*
setup_conditions
(
setup
)
{
do_print
(
"
Setting
up
conditions
.
"
)
;
yield
setup
.
setup
(
)
;
Services
.
prefs
.
clearUserPref
(
PREF_XPI_STATE
)
;
startupManager
(
false
)
;
do_print
(
"
Checking
initial
state
.
"
)
;
yield
check_installed
(
.
.
.
setup
.
initialState
)
;
}
function
*
verify_state
(
finalState
)
{
do_print
(
"
Checking
final
state
.
"
)
;
yield
promiseRestartManager
(
)
;
yield
check_installed
(
.
.
.
finalState
)
;
}
function
*
exec_test
(
setup
test
)
{
yield
setup_conditions
(
setup
)
;
try
{
if
(
"
test
"
in
test
)
{
yield
test
.
test
(
)
;
}
else
{
yield
install_system_addons
(
yield
build_xml
(
test
.
updateList
)
)
;
}
if
(
test
.
fails
)
{
do_throw
(
"
Expected
this
test
to
fail
"
)
;
}
}
catch
(
e
)
{
if
(
!
test
.
fails
)
{
do_throw
(
e
)
;
}
}
yield
verify_state
(
test
.
finalState
?
test
.
finalState
:
setup
.
initialState
)
;
yield
promiseShutdownManager
(
)
;
}
for
(
let
setup
of
Object
.
keys
(
TEST_CONDITIONS
)
)
{
for
(
let
test
of
Object
.
keys
(
TESTS
)
)
{
add_task
(
function
*
(
)
{
do_print
(
"
Running
test
"
+
setup
+
"
"
+
test
)
;
yield
exec_test
(
TEST_CONDITIONS
[
setup
]
TESTS
[
test
]
)
;
}
)
;
}
}
add_task
(
function
*
test_addon_update
(
)
{
yield
setup_conditions
(
TEST_CONDITIONS
.
blank
)
;
yield
update_all_addons
(
yield
build_xml
(
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
path
:
"
system2_2
.
xpi
"
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
path
:
"
system3_2
.
xpi
"
}
]
)
)
;
yield
verify_state
(
[
true
null
"
2
.
0
"
"
2
.
0
"
null
null
]
)
;
yield
promiseShutdownManager
(
)
;
}
)
;
add_task
(
function
*
test_app_update_disabled
(
)
{
yield
setup_conditions
(
TEST_CONDITIONS
.
blank
)
;
Services
.
prefs
.
setBoolPref
(
PREF_APP_UPDATE_ENABLED
false
)
;
yield
update_all_addons
(
yield
build_xml
(
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
path
:
"
system2_2
.
xpi
"
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
path
:
"
system3_2
.
xpi
"
}
]
)
)
;
Services
.
prefs
.
clearUserPref
(
PREF_APP_UPDATE_ENABLED
)
;
yield
verify_state
(
TEST_CONDITIONS
.
blank
.
initialState
)
;
yield
promiseShutdownManager
(
)
;
}
)
;
add_task
(
function
*
test_match_default
(
)
{
yield
setup_conditions
(
TEST_CONDITIONS
.
withBothSets
)
;
yield
install_system_addons
(
yield
build_xml
(
[
{
id
:
"
system1
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system1_1
.
xpi
"
}
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
1
.
0
"
path
:
"
system2_1
.
xpi
"
}
]
)
)
;
yield
verify_state
(
[
true
"
1
.
0
"
"
1
.
0
"
null
null
null
]
)
;
yield
promiseShutdownManager
(
)
;
}
)
;
add_task
(
function
*
test_match_current
(
)
{
yield
setup_conditions
(
TEST_CONDITIONS
.
withBothSets
)
;
yield
install_system_addons
(
yield
build_xml
(
[
{
id
:
"
system2
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
path
:
"
system2_2
.
xpi
"
}
{
id
:
"
system3
tests
.
mozilla
.
org
"
version
:
"
2
.
0
"
path
:
"
system3_2
.
xpi
"
}
]
)
)
;
yield
verify_state
(
[
true
null
"
2
.
0
"
"
2
.
0
"
null
null
]
)
;
yield
promiseShutdownManager
(
)
;
}
)
;
