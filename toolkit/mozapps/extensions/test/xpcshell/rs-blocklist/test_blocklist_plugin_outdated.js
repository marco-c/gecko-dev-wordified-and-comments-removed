const
Cm
=
Components
.
manager
.
QueryInterface
(
Ci
.
nsIComponentRegistrar
)
;
const
nsIBLS
=
Ci
.
nsIBlocklistService
;
var
gBlocklist
=
null
;
var
PLUGINS
=
[
{
name
:
"
test_bug514327_outdated
"
version
:
"
5
"
disabled
:
false
blocklisted
:
false
}
{
name
:
"
test_bug514327_1
"
version
:
"
5
"
disabled
:
false
blocklisted
:
false
}
{
name
:
"
test_bug514327_2
"
version
:
"
5
"
disabled
:
false
blocklisted
:
false
}
]
.
map
(
opts
=
>
new
MockPluginTag
(
opts
opts
.
enabledState
)
)
;
mockPluginHost
(
PLUGINS
)
;
const
BLOCKLIST_DATA
=
{
empty
:
{
}
outdated_1
:
{
plugins
:
[
{
matchName
:
"
test_bug514327_1
"
versionRange
:
[
]
}
{
matchName
:
"
test_bug514327_outdated
"
versionRange
:
[
{
severity
:
"
0
"
}
]
}
]
}
outdated_2
:
{
plugins
:
[
{
matchName
:
"
test_bug514327_2
"
versionRange
:
[
]
}
{
matchName
:
"
test_bug514327_outdated
"
versionRange
:
[
{
severity
:
"
0
"
}
]
}
]
}
}
;
var
BlocklistPrompt
=
{
get
wrappedJSObject
(
)
{
return
this
;
}
prompt
(
list
)
{
Assert
.
equal
(
list
.
length
1
)
;
var
item
=
list
[
0
]
;
Assert
.
ok
(
item
.
item
instanceof
Ci
.
nsIPluginTag
)
;
Assert
.
notEqual
(
item
.
name
"
test_bug514327_outdated
"
)
;
}
QueryInterface
:
ChromeUtils
.
generateQI
(
[
]
)
}
;
let
factory
=
XPCOMUtils
.
generateSingletonFactory
(
function
(
)
{
return
BlocklistPrompt
;
}
)
;
Cm
.
registerFactory
(
Components
.
ID
(
"
{
26d32654
-
30c7
-
485d
-
b983
-
b4d2568aebba
}
"
)
"
Blocklist
Prompt
"
"
mozilla
.
org
/
addons
/
blocklist
-
prompt
;
1
"
factory
)
;
add_task
(
async
function
setup
(
)
{
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
1
.
9
"
)
;
await
promiseStartupManager
(
)
;
await
AddonTestUtils
.
loadBlocklistRawData
(
BLOCKLIST_DATA
.
empty
)
;
gBlocklist
=
Services
.
blocklist
;
executeSoon
(
(
)
=
>
{
void
Blocklist
;
}
)
;
Assert
.
equal
(
await
gBlocklist
.
getPluginBlocklistState
(
PLUGINS
[
0
]
"
1
"
"
1
.
9
"
)
nsIBLS
.
STATE_NOT_BLOCKED
)
;
}
)
;
add_task
(
async
function
test_part_1
(
)
{
await
AddonTestUtils
.
loadBlocklistRawData
(
BLOCKLIST_DATA
.
outdated_1
)
;
Assert
.
equal
(
await
gBlocklist
.
getPluginBlocklistState
(
PLUGINS
[
0
]
"
1
"
"
1
.
9
"
)
nsIBLS
.
STATE_OUTDATED
)
;
}
)
;
add_task
(
async
function
test_part_2
(
)
{
await
AddonTestUtils
.
loadBlocklistRawData
(
BLOCKLIST_DATA
.
outdated_2
)
;
Assert
.
equal
(
await
gBlocklist
.
getPluginBlocklistState
(
PLUGINS
[
0
]
"
1
"
"
1
.
9
"
)
nsIBLS
.
STATE_OUTDATED
)
;
}
)
;
