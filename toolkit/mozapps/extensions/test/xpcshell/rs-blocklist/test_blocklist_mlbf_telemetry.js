"
use
strict
"
;
Services
.
prefs
.
setBoolPref
(
"
extensions
.
blocklist
.
useMLBF
"
true
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
1
"
)
;
const
{
Downloader
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
services
-
settings
/
Attachments
.
sys
.
mjs
"
)
;
const
{
TelemetryController
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
TelemetryController
.
sys
.
mjs
"
)
;
const
{
TelemetryTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
TelemetryTestUtils
.
sys
.
mjs
"
)
;
const
OLDEST_STASH
=
{
stash
:
{
blocked
:
[
]
unblocked
:
[
]
}
stash_time
:
2e6
}
;
const
NEWEST_STASH
=
{
stash
:
{
blocked
:
[
]
unblocked
:
[
]
}
stash_time
:
5e6
}
;
const
RECORDS_WITH_STASHES_AND_MLBF
=
[
MLBF_RECORD
OLDEST_STASH
NEWEST_STASH
]
;
const
ExtensionBlocklistMLBF
=
getExtensionBlocklistMLBF
(
)
;
function
assertTelemetryScalars
(
expectedScalars
)
{
if
(
IS_ANDROID_BUILD
)
{
info
(
Skip
assertions
on
collected
samples
for
{
expectedScalars
}
on
android
builds
)
;
return
;
}
let
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
)
;
for
(
const
scalarName
of
Object
.
keys
(
expectedScalars
|
|
{
}
)
)
{
equal
(
scalars
[
scalarName
]
expectedScalars
[
scalarName
]
Got
the
expected
value
for
{
scalarName
}
scalar
)
;
}
}
function
toUTC
(
time
)
{
return
new
Date
(
time
)
.
toUTCString
(
)
;
}
add_task
(
async
function
setup
(
)
{
if
(
!
IS_ANDROID_BUILD
)
{
do_get_profile
(
)
;
Services
.
fog
.
initializeFOG
(
)
;
}
await
TelemetryController
.
testSetup
(
)
;
await
promiseStartupManager
(
)
;
Downloader
.
_RESOURCE_BASE_URL
=
"
invalid
:
/
/
bogus
"
;
}
)
;
add_task
(
async
function
test_initialization
(
)
{
resetBlocklistTelemetry
(
)
;
ExtensionBlocklistMLBF
.
ensureInitialized
(
)
;
Assert
.
equal
(
undefined
testGetValue
(
Glean
.
blocklist
.
mlbfSource
)
)
;
Assert
.
equal
(
undefined
testGetValue
(
Glean
.
blocklist
.
mlbfGenerationTime
)
)
;
Assert
.
equal
(
undefined
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeOldest
)
)
;
Assert
.
equal
(
undefined
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeNewest
)
)
;
assertTelemetryScalars
(
{
"
blocklist
.
lastModified_rs_addons_mlbf
"
:
undefined
"
blocklist
.
mlbf_source
"
:
undefined
"
blocklist
.
mlbf_generation_time
"
:
undefined
"
blocklist
.
mlbf_stash_time_oldest
"
:
undefined
"
blocklist
.
mlbf_stash_time_newest
"
:
undefined
}
)
;
}
)
;
add_task
(
async
function
test_without_mlbf
(
)
{
resetBlocklistTelemetry
(
)
;
await
AddonTestUtils
.
loadBlocklistRawData
(
{
extensionsMLBF
:
[
{
}
]
}
)
;
Assert
.
equal
(
"
unknown
"
testGetValue
(
Glean
.
blocklist
.
mlbfSource
)
)
;
Assert
.
equal
(
0
testGetValue
(
Glean
.
blocklist
.
mlbfGenerationTime
)
.
getTime
(
)
)
;
Assert
.
equal
(
0
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeOldest
)
.
getTime
(
)
)
;
Assert
.
equal
(
0
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeNewest
)
.
getTime
(
)
)
;
assertTelemetryScalars
(
{
"
blocklist
.
mlbf_source
"
:
"
unknown
"
"
blocklist
.
mlbf_generation_time
"
:
"
Missing
Date
"
"
blocklist
.
mlbf_stash_time_oldest
"
:
"
Missing
Date
"
"
blocklist
.
mlbf_stash_time_newest
"
:
"
Missing
Date
"
}
)
;
}
)
;
add_task
(
async
function
test_common_good_case_with_stashes
(
)
{
resetBlocklistTelemetry
(
)
;
await
ExtensionBlocklistMLBF
.
_client
.
db
.
saveAttachment
(
ExtensionBlocklistMLBF
.
RS_ATTACHMENT_ID
{
record
:
MLBF_RECORD
blob
:
await
load_mlbf_record_as_blob
(
)
}
)
;
await
AddonTestUtils
.
loadBlocklistRawData
(
{
extensionsMLBF
:
RECORDS_WITH_STASHES_AND_MLBF
}
)
;
Assert
.
equal
(
"
cache_match
"
testGetValue
(
Glean
.
blocklist
.
mlbfSource
)
)
;
Assert
.
equal
(
MLBF_RECORD
.
generation_time
testGetValue
(
Glean
.
blocklist
.
mlbfGenerationTime
)
.
getTime
(
)
)
;
Assert
.
equal
(
OLDEST_STASH
.
stash_time
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeOldest
)
.
getTime
(
)
)
;
Assert
.
equal
(
NEWEST_STASH
.
stash_time
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeNewest
)
.
getTime
(
)
)
;
assertTelemetryScalars
(
{
"
blocklist
.
mlbf_source
"
:
"
cache_match
"
"
blocklist
.
mlbf_generation_time
"
:
toUTC
(
MLBF_RECORD
.
generation_time
)
"
blocklist
.
mlbf_stash_time_oldest
"
:
toUTC
(
OLDEST_STASH
.
stash_time
)
"
blocklist
.
mlbf_stash_time_newest
"
:
toUTC
(
NEWEST_STASH
.
stash_time
)
}
)
;
}
)
;
add_task
(
async
function
test_without_stashes
(
)
{
resetBlocklistTelemetry
(
)
;
await
AddonTestUtils
.
loadBlocklistRawData
(
{
extensionsMLBF
:
[
MLBF_RECORD
]
}
)
;
Assert
.
equal
(
"
cache_match
"
testGetValue
(
Glean
.
blocklist
.
mlbfSource
)
)
;
Assert
.
equal
(
MLBF_RECORD
.
generation_time
testGetValue
(
Glean
.
blocklist
.
mlbfGenerationTime
)
.
getTime
(
)
)
;
Assert
.
equal
(
0
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeOldest
)
.
getTime
(
)
)
;
Assert
.
equal
(
0
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeNewest
)
.
getTime
(
)
)
;
assertTelemetryScalars
(
{
"
blocklist
.
mlbf_source
"
:
"
cache_match
"
"
blocklist
.
mlbf_generation_time
"
:
toUTC
(
MLBF_RECORD
.
generation_time
)
"
blocklist
.
mlbf_stash_time_oldest
"
:
"
Missing
Date
"
"
blocklist
.
mlbf_stash_time_newest
"
:
"
Missing
Date
"
}
)
;
}
)
;
add_task
(
async
function
test_without_collection_but_cache
(
)
{
resetBlocklistTelemetry
(
)
;
await
AddonTestUtils
.
loadBlocklistRawData
(
{
extensionsMLBF
:
[
{
last_modified
:
Date
.
now
(
)
}
]
}
)
;
Assert
.
equal
(
"
cache_fallback
"
testGetValue
(
Glean
.
blocklist
.
mlbfSource
)
)
;
Assert
.
equal
(
MLBF_RECORD
.
generation_time
testGetValue
(
Glean
.
blocklist
.
mlbfGenerationTime
)
.
getTime
(
)
)
;
Assert
.
equal
(
0
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeOldest
)
.
getTime
(
)
)
;
Assert
.
equal
(
0
testGetValue
(
Glean
.
blocklist
.
mlbfStashTimeNewest
)
.
getTime
(
)
)
;
assertTelemetryScalars
(
{
"
blocklist
.
mlbf_source
"
:
"
cache_fallback
"
"
blocklist
.
mlbf_generation_time
"
:
toUTC
(
MLBF_RECORD
.
generation_time
)
"
blocklist
.
mlbf_stash_time_oldest
"
:
"
Missing
Date
"
"
blocklist
.
mlbf_stash_time_newest
"
:
"
Missing
Date
"
}
)
;
}
)
;
