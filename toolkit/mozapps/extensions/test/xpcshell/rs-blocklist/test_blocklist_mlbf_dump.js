"
use
strict
"
;
Services
.
prefs
.
setBoolPref
(
"
extensions
.
blocklist
.
useMLBF
"
true
)
;
Services
.
prefs
.
setBoolPref
(
"
extensions
.
blocklist
.
useMLBF
.
stashes
"
true
)
;
const
ExtensionBlocklistMLBF
=
getExtensionBlocklistMLBF
(
)
;
const
blockedAddon
=
{
id
:
"
{
6f62927a
-
e380
-
401a
-
8c9e
-
c485b7d87f0d
}
"
version
:
"
9
.
2
.
0
"
signedDate
:
new
Date
(
1588098908496
)
}
;
const
nonBlockedAddon
=
{
id
:
"
disable
-
ctrl
-
q
-
and
-
cmd
-
q
robwu
.
nl
"
version
:
"
1
"
signedDate
:
new
Date
(
1482430349000
)
}
;
async
function
sha256
(
arrayBuffer
)
{
Cu
.
importGlobalProperties
(
[
"
crypto
"
]
)
;
let
hash
=
await
crypto
.
subtle
.
digest
(
"
SHA
-
256
"
arrayBuffer
)
;
const
toHex
=
b
=
>
b
.
toString
(
16
)
.
padStart
(
2
"
0
"
)
;
return
Array
.
from
(
new
Uint8Array
(
hash
)
toHex
)
.
join
(
"
"
)
;
}
add_task
(
async
function
verify_dump_first_run
(
)
{
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
1
"
)
;
const
observed
=
[
]
;
ExtensionBlocklistMLBF
.
ensureInitialized
(
)
;
const
originalImpl
=
ExtensionBlocklistMLBF
.
_client
.
attachments
.
download
;
ExtensionBlocklistMLBF
.
_client
.
attachments
.
download
=
function
(
record
)
{
let
downloadPromise
=
originalImpl
.
apply
(
this
arguments
)
;
observed
.
push
(
{
inputRecord
:
record
downloadPromise
}
)
;
return
downloadPromise
;
}
;
Assert
.
equal
(
await
Blocklist
.
getAddonBlocklistState
(
blockedAddon
)
Ci
.
nsIBlocklistService
.
STATE_BLOCKED
"
A
add
-
on
that
is
known
to
be
on
the
blocklist
should
be
blocked
"
)
;
Assert
.
equal
(
await
Blocklist
.
getAddonBlocklistState
(
nonBlockedAddon
)
Ci
.
nsIBlocklistService
.
STATE_NOT_BLOCKED
"
A
known
non
-
blocked
add
-
on
should
not
be
blocked
"
)
;
Assert
.
equal
(
observed
.
length
1
"
expected
number
of
MLBF
download
requests
"
)
;
const
{
inputRecord
downloadPromise
}
=
observed
[
0
]
;
Assert
.
ok
(
inputRecord
"
addons
-
bloomfilters
collection
dump
exists
"
)
;
const
downloadResult
=
await
downloadPromise
;
Assert
.
equal
(
downloadResult
.
_source
"
dump_match
"
"
MLBF
attachment
should
match
the
RemoteSettings
collection
"
)
;
Assert
.
equal
(
await
sha256
(
downloadResult
.
buffer
)
inputRecord
.
attachment
.
hash
"
The
content
of
the
attachment
should
actually
matches
the
record
"
)
;
}
)
;
