const
ADDON_ID
=
"
embedder
-
disabled
tests
.
mozilla
.
org
"
;
const
PREF_IS_EMBEDDED
=
"
extensions
.
isembedded
"
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
49
"
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
PREF_IS_EMBEDDED
)
;
}
)
;
async
function
installExtension
(
)
{
return
promiseInstallWebExtension
(
{
manifest
:
{
browser_specific_settings
:
{
gecko
:
{
id
:
ADDON_ID
}
}
}
}
)
;
}
add_task
(
async
function
test_setup
(
)
{
await
promiseStartupManager
(
)
;
}
)
;
add_task
(
async
function
embedder_disabled_while_not_embedding
(
)
{
const
addon
=
await
installExtension
(
)
;
let
exceptionThrown
=
false
;
try
{
await
addon
.
setEmbedderDisabled
(
true
)
;
}
catch
(
exception
)
{
exceptionThrown
=
true
;
}
equal
(
exceptionThrown
true
)
;
equal
(
addon
.
isActive
true
)
;
equal
(
addon
.
embedderDisabled
undefined
)
;
await
addon
.
uninstall
(
)
;
}
)
;
add_task
(
async
function
unset_embedder_disabled_while_not_embedding
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF_IS_EMBEDDED
true
)
;
const
addon
=
await
installExtension
(
)
;
await
addon
.
setEmbedderDisabled
(
true
)
;
equal
(
addon
.
isActive
false
)
;
equal
(
addon
.
embedderDisabled
true
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IS_EMBEDDED
false
)
;
equal
(
addon
.
embedderDisabled
undefined
)
;
await
addon
.
disable
(
)
;
await
addon
.
enable
(
)
;
equal
(
addon
.
isActive
true
)
;
equal
(
addon
.
embedderDisabled
undefined
)
;
await
addon
.
uninstall
(
)
;
}
)
;
add_task
(
async
function
embedder_disabled_while_embedding
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF_IS_EMBEDDED
true
)
;
const
addon
=
await
installExtension
(
)
;
await
addon
.
setEmbedderDisabled
(
true
)
;
equal
(
addon
.
embedderDisabled
true
)
;
equal
(
addon
.
isActive
false
)
;
await
addon
.
setEmbedderDisabled
(
false
)
;
equal
(
addon
.
isActive
true
)
;
equal
(
addon
.
embedderDisabled
false
)
;
await
addon
.
uninstall
(
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IS_EMBEDDED
false
)
;
}
)
;
add_task
(
async
function
embedder_disabled_while_user_disabled
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF_IS_EMBEDDED
true
)
;
const
addon
=
await
installExtension
(
)
;
await
addon
.
disable
(
)
;
equal
(
addon
.
isActive
false
)
;
equal
(
addon
.
userDisabled
true
)
;
equal
(
addon
.
embedderDisabled
false
)
;
await
addon
.
setEmbedderDisabled
(
true
)
;
equal
(
addon
.
isActive
false
)
;
equal
(
addon
.
userDisabled
true
)
;
equal
(
addon
.
embedderDisabled
true
)
;
await
addon
.
setEmbedderDisabled
(
false
)
;
equal
(
addon
.
isActive
false
)
;
equal
(
addon
.
userDisabled
true
)
;
equal
(
addon
.
embedderDisabled
false
)
;
await
addon
.
enable
(
)
;
equal
(
addon
.
isActive
true
)
;
equal
(
addon
.
userDisabled
false
)
;
equal
(
addon
.
embedderDisabled
false
)
;
await
addon
.
uninstall
(
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IS_EMBEDDED
false
)
;
}
)
;
