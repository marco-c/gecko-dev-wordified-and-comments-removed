createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
1
.
9
.
2
"
)
;
function
mockAddonProvider
(
aName
)
{
let
mockProvider
=
{
donePromise
:
null
doneResolve
:
null
doneReject
:
null
shutdownPromise
:
null
shutdownResolve
:
null
get
name
(
)
{
return
aName
;
}
shutdown
(
)
{
this
.
shutdownResolve
(
)
;
return
this
.
donePromise
;
}
}
;
mockProvider
.
donePromise
=
new
Promise
(
(
resolve
reject
)
=
>
{
mockProvider
.
doneResolve
=
resolve
;
mockProvider
.
doneReject
=
reject
;
}
)
;
mockProvider
.
shutdownPromise
=
new
Promise
(
resolve
=
>
{
mockProvider
.
shutdownResolve
=
resolve
;
}
)
;
return
mockProvider
;
}
function
findInStatus
(
aStatus
aName
)
{
for
(
let
{
name
state
}
of
aStatus
.
state
)
{
if
(
name
=
=
aName
)
{
return
state
;
}
}
return
null
;
}
add_task
(
async
function
blockRepoShutdown
(
)
{
let
mockRepo
=
mockAddonProvider
(
"
Mock
repo
"
)
;
AddonManagerPrivate
.
overrideAddonRepository
(
mockRepo
)
;
let
mockProvider
=
mockAddonProvider
(
"
Mock
provider
"
)
;
await
promiseStartupManager
(
)
;
AddonManagerPrivate
.
registerProvider
(
mockProvider
)
;
let
{
fetchState
}
=
MockAsyncShutdown
.
profileBeforeChange
.
blockers
[
0
]
.
options
;
let
managerDown
=
promiseShutdownManager
(
)
;
await
mockProvider
.
shutdownPromise
;
let
status
=
fetchState
(
)
;
equal
(
findInStatus
(
status
[
1
]
"
Mock
provider
"
)
"
(
none
)
"
)
;
equal
(
status
[
2
]
.
name
"
AddonRepository
:
async
shutdown
"
)
;
equal
(
status
[
2
]
.
state
"
pending
"
)
;
mockProvider
.
doneResolve
(
)
;
await
mockRepo
.
shutdownPromise
;
status
=
fetchState
(
)
;
equal
(
status
[
1
]
.
name
"
AddonManager
:
Waiting
for
providers
to
shut
down
.
"
)
;
equal
(
status
[
1
]
.
state
"
Complete
"
)
;
equal
(
status
[
2
]
.
name
"
AddonRepository
:
async
shutdown
"
)
;
equal
(
status
[
2
]
.
state
"
in
progress
"
)
;
mockRepo
.
doneResolve
(
)
;
await
managerDown
;
status
=
fetchState
(
)
;
equal
(
status
[
0
]
.
name
"
AddonRepository
:
async
shutdown
"
)
;
equal
(
status
[
0
]
.
state
"
done
"
)
;
}
)
;
