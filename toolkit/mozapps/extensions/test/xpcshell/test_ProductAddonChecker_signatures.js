"
use
strict
"
;
const
{
ProductAddonChecker
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
addons
/
ProductAddonChecker
.
jsm
"
)
;
Services
.
prefs
.
setBoolPref
(
"
media
.
gmp
-
manager
.
updateEnabled
"
true
)
;
const
signedTestServer
=
new
HttpServer
(
)
;
const
testDataDir
=
"
data
/
productaddons
/
"
;
signedTestServer
.
start
(
)
;
const
signedBaseUri
=
signedTestServer
.
identity
.
primaryScheme
+
"
:
/
/
"
+
signedTestServer
.
identity
.
primaryHost
+
"
:
"
+
signedTestServer
.
identity
.
primaryPort
;
const
validX5uPath
=
"
/
valid_x5u
"
;
const
validCertChain
=
loadCertChain
(
testDataDir
+
"
content_signing
"
[
"
aus_ee
"
"
int
"
"
root
"
]
)
;
signedTestServer
.
registerPathHandler
(
validX5uPath
(
req
res
)
=
>
{
res
.
write
(
validCertChain
.
join
(
"
\
n
"
)
)
;
}
)
;
const
validX5uUrl
=
signedBaseUri
+
validX5uPath
;
const
invalidX5uPath
=
"
/
invalid_x5u
"
;
const
invalidCertChain
=
loadCertChain
(
testDataDir
+
"
content_signing
"
[
"
aus_ee
"
"
root
"
]
)
;
signedTestServer
.
registerPathHandler
(
invalidX5uPath
(
req
res
)
=
>
{
res
.
write
(
invalidCertChain
.
join
(
"
\
n
"
)
)
;
}
)
;
const
invalidX5uUrl
=
signedBaseUri
+
invalidX5uPath
;
let
goodXml
;
const
goodXmlContentSignature
=
"
7QYnPqFoOlS02BpDdIRIljzmPr6BFwPs1z1y8KJUBlnU7EVG6FbnXmVVt5Op9wDzgvhXX7th8qFJvpPOZs_B_tHRDNJ8SK0HN95BAN15z3ZW2r95SSHmU
-
fP2JgoNOR3
"
;
const
goodXmlPath
=
"
/
good
.
xml
"
;
const
validSignatureQuery
=
"
validSignature
"
;
const
invalidSignatureQuery
=
"
invalidSignature
"
;
const
missingSignatureQuery
=
"
missingSignature
"
;
const
incompleteSignatureQuery
=
"
incompleteSignature
"
;
const
badX5uSignatureQuery
=
"
badX5uSignature
"
;
signedTestServer
.
registerPathHandler
(
goodXmlPath
(
req
res
)
=
>
{
if
(
req
.
queryString
=
=
validSignatureQuery
)
{
res
.
setHeader
(
"
content
-
signature
"
x5u
=
{
validX5uUrl
}
;
p384ecdsa
=
{
goodXmlContentSignature
}
)
;
}
else
if
(
req
.
queryString
=
=
invalidSignatureQuery
)
{
res
.
setHeader
(
"
content
-
signature
"
x5u
=
{
validX5uUrl
}
;
p384ecdsa
=
garbage
)
;
}
else
if
(
req
.
queryString
=
=
missingSignatureQuery
)
{
}
else
if
(
req
.
queryString
=
=
incompleteSignatureQuery
)
{
res
.
setHeader
(
"
content
-
signature
"
x5u
=
{
validX5uUrl
}
)
;
}
else
if
(
req
.
queryString
=
=
badX5uSignatureQuery
)
{
res
.
setHeader
(
"
content
-
signature
"
x5u
=
{
invalidX5uUrl
}
;
p384ecdsa
=
{
goodXmlContentSignature
}
)
;
}
else
{
Assert
.
ok
(
false
"
Invalid
queryString
passed
to
server
!
Tests
shouldn
'
t
do
that
!
"
)
;
}
res
.
write
(
goodXml
)
;
}
)
;
setCertRoot
(
testDataDir
+
"
content_signing_root
.
pem
"
)
;
add_task
(
async
function
load_good_xml
(
)
{
goodXml
=
await
IOUtils
.
readUTF8
(
do_get_file
(
testDataDir
+
"
good
.
xml
"
)
.
path
)
;
}
)
;
add_task
(
async
function
test_valid_content_signature
(
)
{
try
{
const
res
=
await
ProductAddonChecker
.
getProductAddonList
(
signedBaseUri
+
goodXmlPath
+
"
?
"
+
validSignatureQuery
false
false
true
)
;
Assert
.
ok
(
true
"
Should
successfully
get
addon
list
"
)
;
Assert
.
equal
(
res
.
addons
[
0
]
.
id
"
test1
"
)
;
Assert
.
equal
(
res
.
addons
[
1
]
.
id
"
test2
"
)
;
Assert
.
equal
(
res
.
addons
[
2
]
.
id
"
test3
"
)
;
Assert
.
equal
(
res
.
addons
[
3
]
.
id
"
test4
"
)
;
Assert
.
equal
(
res
.
addons
[
4
]
.
id
undefined
)
;
}
catch
(
e
)
{
Assert
.
ok
(
false
Should
successfully
get
addon
list
instead
failed
with
{
e
}
)
;
}
}
)
;
add_task
(
async
function
test_invalid_content_signature
(
)
{
try
{
await
ProductAddonChecker
.
getProductAddonList
(
signedBaseUri
+
goodXmlPath
+
"
?
"
+
invalidSignatureQuery
false
false
true
)
;
Assert
.
ok
(
false
"
Should
fail
to
get
addon
list
"
)
;
}
catch
(
e
)
{
Assert
.
ok
(
true
"
Should
fail
to
get
addon
list
"
)
;
Assert
.
ok
(
e
.
message
.
startsWith
(
"
Content
signature
validation
failed
:
"
)
"
Should
get
signature
failure
message
"
)
;
}
}
)
;
add_task
(
async
function
test_missing_content_signature_header
(
)
{
try
{
await
ProductAddonChecker
.
getProductAddonList
(
signedBaseUri
+
goodXmlPath
+
"
?
"
+
missingSignatureQuery
false
false
true
)
;
Assert
.
ok
(
false
"
Should
fail
to
get
addon
list
"
)
;
}
catch
(
e
)
{
Assert
.
ok
(
true
"
Should
fail
to
get
addon
list
"
)
;
Assert
.
equal
(
e
.
addonCheckerErr
ProductAddonChecker
.
VERIFICATION_MISSING_DATA_ERR
)
;
Assert
.
equal
(
e
.
message
"
Content
signature
validation
failed
:
missing
content
signature
header
"
)
;
}
}
)
;
add_task
(
async
function
test_incomplete_content_signature_header
(
)
{
try
{
await
ProductAddonChecker
.
getProductAddonList
(
signedBaseUri
+
goodXmlPath
+
"
?
"
+
incompleteSignatureQuery
false
false
true
)
;
Assert
.
ok
(
false
"
Should
fail
to
get
addon
list
"
)
;
}
catch
(
e
)
{
Assert
.
ok
(
true
"
Should
fail
to
get
addon
list
"
)
;
Assert
.
equal
(
e
.
addonCheckerErr
ProductAddonChecker
.
VERIFICATION_MISSING_DATA_ERR
)
;
Assert
.
equal
(
e
.
message
"
Content
signature
validation
failed
:
missing
signature
"
)
;
}
}
)
;
add_task
(
async
function
test_bad_x5u_content_signature_header
(
)
{
try
{
await
ProductAddonChecker
.
getProductAddonList
(
signedBaseUri
+
goodXmlPath
+
"
?
"
+
badX5uSignatureQuery
false
false
true
)
;
Assert
.
ok
(
false
"
Should
fail
to
get
addon
list
"
)
;
}
catch
(
e
)
{
Assert
.
ok
(
true
"
Should
fail
to
get
addon
list
"
)
;
Assert
.
equal
(
e
.
addonCheckerErr
ProductAddonChecker
.
VERIFICATION_INVALID_ERR
)
;
Assert
.
equal
(
e
.
message
"
Content
signature
is
not
valid
"
)
;
}
}
)
;
