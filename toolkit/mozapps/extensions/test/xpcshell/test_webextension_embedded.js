BootstrapMonitor
.
init
(
)
;
const
profileDir
=
gProfD
.
clone
(
)
;
profileDir
.
append
(
"
extensions
"
)
;
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
49
"
)
;
startupManager
(
)
;
const
{
Management
}
=
Components
.
utils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Extension
.
jsm
"
{
}
)
;
const
{
EmbeddedExtensionManager
LegacyExtensionsUtils
}
=
Components
.
utils
.
import
(
"
resource
:
/
/
gre
/
modules
/
LegacyExtensionsUtils
.
jsm
"
)
;
function
promiseWebExtensionStartup
(
)
{
return
new
Promise
(
resolve
=
>
{
let
listener
=
(
event
extension
)
=
>
{
Management
.
off
(
"
startup
"
listener
)
;
resolve
(
extension
)
;
}
;
Management
.
on
(
"
startup
"
listener
)
;
}
)
;
}
function
promiseWebExtensionShutdown
(
)
{
return
new
Promise
(
resolve
=
>
{
let
listener
=
(
event
extension
)
=
>
{
Management
.
off
(
"
shutdown
"
listener
)
;
resolve
(
extension
)
;
}
;
Management
.
on
(
"
shutdown
"
listener
)
;
}
)
;
}
const
BOOTSTRAP
=
String
.
raw
Components
.
utils
.
import
(
"
resource
:
/
/
xpcshell
-
data
/
BootstrapMonitor
.
jsm
"
)
.
monitor
(
this
)
;
;
const
EMBEDDED_WEBEXT_MANIFEST
=
JSON
.
stringify
(
{
name
:
"
embedded
webextension
addon
"
manifest_version
:
2
version
:
"
1
.
0
"
}
)
;
add_task
(
function
*
has_embedded_webextension_persisted
(
)
{
const
ID
=
"
embedded
-
webextension
-
addon
-
persist
tests
.
mozilla
.
org
"
;
const
xpiFile
=
createTempXPIFile
(
{
id
:
ID
name
:
"
Test
Add
-
on
"
version
:
"
1
.
0
"
bootstrap
:
true
hasEmbeddedWebExtension
:
true
targetApplications
:
[
{
id
:
"
xpcshell
tests
.
mozilla
.
org
"
minVersion
:
"
1
"
maxVersion
:
"
1
.
9
.
2
"
}
]
}
{
"
bootstrap
.
js
"
:
BOOTSTRAP
"
webextension
/
manifest
.
json
"
:
EMBEDDED_WEBEXT_MANIFEST
}
)
;
yield
promiseInstallFile
(
xpiFile
)
;
let
addon
=
yield
promiseAddonByID
(
ID
)
;
notEqual
(
addon
null
"
Got
an
addon
object
as
expected
"
)
;
equal
(
addon
.
version
"
1
.
0
"
"
Got
the
expected
version
"
)
;
equal
(
addon
.
hasEmbeddedWebExtension
true
"
Got
the
expected
hasEmbeddedWebExtension
value
"
)
;
BootstrapMonitor
.
checkAddonInstalled
(
ID
"
1
.
0
"
)
;
BootstrapMonitor
.
checkAddonStarted
(
ID
"
1
.
0
"
)
;
let
startupInfo
=
BootstrapMonitor
.
started
.
get
(
ID
)
;
ok
(
(
"
webExtension
"
in
startupInfo
.
data
)
"
Got
an
webExtension
property
in
the
startup
bootstrap
method
params
"
)
;
ok
(
(
"
startup
"
in
startupInfo
.
data
.
webExtension
)
"
Got
the
expected
'
startup
'
property
in
the
webExtension
object
"
)
;
yield
promiseRestartManager
(
)
;
let
persisted
=
JSON
.
parse
(
Services
.
prefs
.
getCharPref
(
"
extensions
.
bootstrappedAddons
"
)
)
;
ok
(
ID
in
persisted
"
Hybrid
add
-
on
persisted
to
bootstrappedAddons
.
"
)
;
equal
(
persisted
[
ID
]
.
hasEmbeddedWebExtension
true
"
hasEmbeddedWebExtension
flag
persisted
to
bootstrappedAddons
.
"
)
;
BootstrapMonitor
.
checkAddonInstalled
(
ID
"
1
.
0
"
)
;
BootstrapMonitor
.
checkAddonStarted
(
ID
"
1
.
0
"
)
;
addon
=
yield
promiseAddonByID
(
ID
)
;
notEqual
(
addon
null
"
Got
an
addon
object
as
expected
"
)
;
equal
(
addon
.
hasEmbeddedWebExtension
true
"
Got
the
expected
hasEmbeddedWebExtension
value
"
)
;
let
newStartupInfo
=
BootstrapMonitor
.
started
.
get
(
ID
)
;
ok
(
(
"
webExtension
"
in
newStartupInfo
.
data
)
"
Got
an
webExtension
property
in
the
startup
bootstrap
method
params
"
)
;
ok
(
(
"
startup
"
in
newStartupInfo
.
data
.
webExtension
)
"
Got
the
expected
'
startup
'
property
in
the
webExtension
object
"
)
;
let
waitUninstall
=
promiseAddonEvent
(
"
onUninstalled
"
)
;
addon
.
uninstall
(
)
;
yield
waitUninstall
;
}
)
;
add_task
(
function
*
run_embedded_webext_bootstrap
(
)
{
const
ID
=
"
embedded
-
webextension
-
addon2
tests
.
mozilla
.
org
"
;
const
xpiFile
=
createTempXPIFile
(
{
id
:
ID
name
:
"
Test
Add
-
on
"
version
:
"
1
.
0
"
bootstrap
:
true
hasEmbeddedWebExtension
:
true
targetApplications
:
[
{
id
:
"
xpcshell
tests
.
mozilla
.
org
"
minVersion
:
"
1
"
maxVersion
:
"
1
.
9
.
2
"
}
]
}
{
"
bootstrap
.
js
"
:
BOOTSTRAP
"
webextension
/
manifest
.
json
"
:
EMBEDDED_WEBEXT_MANIFEST
}
)
;
yield
AddonManager
.
installTemporaryAddon
(
xpiFile
)
;
let
addon
=
yield
promiseAddonByID
(
ID
)
;
notEqual
(
addon
null
"
Got
an
addon
object
as
expected
"
)
;
equal
(
addon
.
version
"
1
.
0
"
"
Got
the
expected
version
"
)
;
equal
(
addon
.
hasEmbeddedWebExtension
true
"
Got
the
expected
hasEmbeddedWebExtension
value
"
)
;
BootstrapMonitor
.
checkAddonInstalled
(
ID
"
1
.
0
"
)
;
let
installInfo
=
BootstrapMonitor
.
installed
.
get
(
ID
)
;
ok
(
!
(
"
webExtension
"
in
installInfo
.
data
)
"
No
webExtension
property
is
expected
in
the
install
bootstrap
method
params
"
)
;
BootstrapMonitor
.
checkAddonStarted
(
ID
"
1
.
0
"
)
;
let
startupInfo
=
BootstrapMonitor
.
started
.
get
(
ID
)
;
ok
(
(
"
webExtension
"
in
startupInfo
.
data
)
"
Got
an
webExtension
property
in
the
startup
bootstrap
method
params
"
)
;
ok
(
(
"
startup
"
in
startupInfo
.
data
.
webExtension
)
"
Got
the
expected
'
startup
'
property
in
the
webExtension
object
"
)
;
const
waitForWebExtensionStartup
=
promiseWebExtensionStartup
(
)
;
const
embeddedAPI
=
yield
startupInfo
.
data
.
webExtension
.
startup
(
)
;
yield
waitForWebExtensionStartup
;
Assert
.
deepEqual
(
Object
.
keys
(
embeddedAPI
.
browser
.
runtime
)
.
sort
(
)
[
"
onConnect
"
"
onMessage
"
]
Got
the
expected
'
runtime
'
in
the
'
browser
'
API
object
)
;
let
waitForWebExtensionShutdown
=
promiseWebExtensionShutdown
(
)
;
let
waitUninstall
=
promiseAddonEvent
(
"
onUninstalled
"
)
;
addon
.
uninstall
(
)
;
yield
waitForWebExtensionShutdown
;
yield
waitUninstall
;
BootstrapMonitor
.
checkAddonNotStarted
(
ID
"
1
.
0
"
)
;
let
shutdownInfo
=
BootstrapMonitor
.
stopped
.
get
(
ID
)
;
ok
(
!
(
"
webExtension
"
in
shutdownInfo
.
data
)
"
No
webExtension
property
is
expected
in
the
shutdown
bootstrap
method
params
"
)
;
let
uninstallInfo
=
BootstrapMonitor
.
uninstalled
.
get
(
ID
)
;
ok
(
!
(
"
webExtension
"
in
uninstallInfo
.
data
)
"
No
webExtension
property
is
expected
in
the
uninstall
bootstrap
method
params
"
)
;
}
)
;
add_task
(
function
*
reload_embedded_webext_bootstrap
(
)
{
const
ID
=
"
embedded
-
webextension
-
addon2
tests
.
mozilla
.
org
"
;
equal
(
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
size
0
"
No
embedded
extension
instance
should
be
tracked
here
"
)
;
const
xpiFile
=
createTempXPIFile
(
{
id
:
ID
name
:
"
Test
Add
-
on
"
version
:
"
1
.
0
"
bootstrap
:
true
hasEmbeddedWebExtension
:
true
targetApplications
:
[
{
id
:
"
xpcshell
tests
.
mozilla
.
org
"
minVersion
:
"
1
"
maxVersion
:
"
1
.
9
.
2
"
}
]
}
{
"
bootstrap
.
js
"
:
BOOTSTRAP
"
webextension
/
manifest
.
json
"
:
EMBEDDED_WEBEXT_MANIFEST
}
)
;
yield
AddonManager
.
installTemporaryAddon
(
xpiFile
)
;
let
addon
=
yield
promiseAddonByID
(
ID
)
;
notEqual
(
addon
null
"
Got
an
addon
object
as
expected
"
)
;
equal
(
addon
.
version
"
1
.
0
"
"
Got
the
expected
version
"
)
;
equal
(
addon
.
isActive
true
"
The
Addon
is
active
"
)
;
equal
(
addon
.
appDisabled
false
"
The
addon
is
not
app
disabled
"
)
;
equal
(
addon
.
userDisabled
false
"
The
addon
is
not
user
disabled
"
)
;
BootstrapMonitor
.
checkAddonInstalled
(
ID
"
1
.
0
"
)
;
BootstrapMonitor
.
checkAddonStarted
(
ID
"
1
.
0
"
)
;
equal
(
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
size
1
"
Got
the
expected
number
of
tracked
extension
instances
"
)
;
const
embeddedWebExtension
=
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
get
(
ID
)
;
let
startupInfo
=
BootstrapMonitor
.
started
.
get
(
ID
)
;
yield
startupInfo
.
data
.
webExtension
.
startup
(
)
;
const
waitForAddonDisabled
=
promiseAddonEvent
(
"
onDisabled
"
)
;
addon
.
userDisabled
=
true
;
yield
waitForAddonDisabled
;
equal
(
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
size
0
"
No
embedded
extension
instance
should
be
tracked
here
"
)
;
const
waitForAddonEnabled
=
promiseAddonEvent
(
"
onEnabled
"
)
;
addon
.
userDisabled
=
false
;
yield
waitForAddonEnabled
;
equal
(
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
size
1
"
Got
the
expected
number
of
tracked
extension
instances
"
)
;
const
embeddedWebExtensionAfterEnabled
=
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
get
(
ID
)
;
notEqual
(
embeddedWebExtensionAfterEnabled
embeddedWebExtension
"
Got
a
new
EmbeddedExtension
instance
after
the
addon
has
been
disabled
and
then
enabled
"
)
;
startupInfo
=
BootstrapMonitor
.
started
.
get
(
ID
)
;
yield
startupInfo
.
data
.
webExtension
.
startup
(
)
;
const
waitForReinstalled
=
promiseAddonEvent
(
"
onInstalled
"
)
;
addon
.
reload
(
)
;
yield
waitForReinstalled
;
equal
(
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
size
1
"
Got
the
expected
number
of
tracked
extension
instances
"
)
;
const
embeddedWebExtensionAfterReload
=
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
get
(
ID
)
;
notEqual
(
embeddedWebExtensionAfterReload
embeddedWebExtensionAfterEnabled
"
Got
a
new
EmbeddedExtension
instance
after
the
addon
has
been
reloaded
"
)
;
startupInfo
=
BootstrapMonitor
.
started
.
get
(
ID
)
;
yield
startupInfo
.
data
.
webExtension
.
startup
(
)
;
let
waitUninstalled
=
promiseAddonEvent
(
"
onUninstalled
"
)
;
addon
.
uninstall
(
)
;
yield
waitUninstalled
;
equal
(
EmbeddedExtensionManager
.
embeddedExtensionsByAddonId
.
size
0
"
No
embedded
extension
instance
should
be
tracked
after
the
addon
uninstall
"
)
;
}
)
;
