add_task
(
async
function
(
)
{
let
blocklist
=
AM_Cc
[
"
mozilla
.
org
/
extensions
/
blocklist
;
1
"
]
.
getService
(
)
.
wrappedJSObject
;
let
scope
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
{
}
)
;
let
read
=
scope
.
OS
.
File
.
read
;
let
triedToRead
=
false
;
scope
.
OS
.
File
.
read
=
(
)
=
>
triedToRead
=
true
;
blocklist
.
_loadBlocklist
(
)
;
Assert
.
ok
(
blocklist
.
isLoaded
)
;
await
blocklist
.
_preloadBlocklist
(
)
;
Assert
.
ok
(
!
triedToRead
)
;
scope
.
OS
.
File
.
read
=
read
;
blocklist
.
_clear
(
)
;
info
(
"
sync
-
>
async
complete
"
)
;
await
blocklist
.
_preloadBlocklist
(
)
;
Assert
.
ok
(
blocklist
.
isLoaded
)
;
info
(
"
async
test
complete
"
)
;
blocklist
.
_clear
(
)
;
scope
.
OS
.
File
.
read
=
function
(
.
.
.
args
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
executeSoon
(
(
)
=
>
{
blocklist
.
_loadBlocklist
(
)
;
resolve
(
read
(
.
.
.
args
)
)
;
}
)
;
}
)
;
}
;
await
blocklist
.
_preloadBlocklist
(
)
;
Assert
.
ok
(
blocklist
.
isLoaded
)
;
info
(
"
mixed
async
/
sync
test
complete
"
)
;
}
)
;
