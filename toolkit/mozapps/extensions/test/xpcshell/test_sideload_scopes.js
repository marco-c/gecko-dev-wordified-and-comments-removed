"
use
strict
"
;
let
legacyIDs
=
[
getID
(
legacy
-
global
)
getID
(
legacy
-
user
)
getID
(
legacy
-
profile
)
]
;
add_task
(
async
function
test_sideloads_legacy
(
)
{
let
IDs
=
[
]
;
for
(
let
[
name
dir
]
of
Object
.
entries
(
scopeDirectories
)
)
{
let
id
=
getID
(
legacy
-
{
name
}
)
;
IDs
.
push
(
id
)
;
await
createWebExtension
(
id
initialVersion
(
name
)
dir
)
;
}
await
promiseStartupManager
(
)
;
let
sideloaded
=
await
AddonManagerPrivate
.
getNewSideloads
(
)
;
Assert
.
equal
(
sideloaded
.
length
3
"
three
sideloaded
addon
"
)
;
let
sideloadedIds
=
sideloaded
.
map
(
a
=
>
a
.
id
)
;
for
(
let
id
of
legacyIDs
)
{
Assert
.
ok
(
sideloadedIds
.
includes
(
id
)
{
id
}
is
sideloaded
)
;
}
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_INSTALLED
[
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_CHANGED
[
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_UNINSTALLED
[
]
)
;
await
promiseShutdownManager
(
)
;
}
)
;
add_task
(
async
function
test_sideloads_disabled
(
)
{
Services
.
prefs
.
clearUserPref
(
"
extensions
.
sideloadScopes
"
)
;
for
(
let
[
name
dir
]
of
Object
.
entries
(
scopeDirectories
)
)
{
await
createWebExtension
(
getID
(
name
)
initialVersion
(
name
)
dir
)
;
}
await
promiseStartupManager
(
)
;
let
sideloaded
=
await
AddonManagerPrivate
.
getNewSideloads
(
)
;
Assert
.
equal
(
sideloaded
.
length
1
"
one
sideloaded
addon
"
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_INSTALLED
[
getID
(
"
profile
"
)
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_CHANGED
[
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_UNINSTALLED
[
]
)
;
for
(
let
[
name
]
of
Object
.
entries
(
scopeDirectories
)
)
{
let
id
=
getID
(
name
)
;
let
addon
=
await
promiseAddonByID
(
id
)
;
if
(
name
=
=
=
"
profile
"
)
{
Assert
.
notEqual
(
addon
null
)
;
Assert
.
equal
(
addon
.
id
id
)
;
Assert
.
ok
(
addon
.
foreignInstall
)
;
Assert
.
equal
(
addon
.
scope
AddonManager
.
SCOPE_PROFILE
)
;
Assert
.
ok
(
addon
.
userDisabled
)
;
Assert
.
ok
(
!
addon
.
seen
)
;
}
else
{
Assert
.
equal
(
addon
null
addon
{
id
}
is
not
installed
)
;
}
}
let
extensionAddons
=
await
AddonManager
.
getAddonsByTypes
(
[
"
extension
"
]
)
;
Assert
.
equal
(
extensionAddons
.
length
4
)
;
let
IDs
=
extensionAddons
.
map
(
ext
=
>
ext
.
id
)
;
for
(
let
id
of
[
getID
(
"
profile
"
)
.
.
.
legacyIDs
]
)
{
Assert
.
ok
(
IDs
.
includes
(
id
)
{
id
}
is
installed
)
;
}
await
promiseShutdownManager
(
)
;
}
)
;
add_task
(
async
function
test_sideloads_changed
(
)
{
for
(
let
[
name
dir
]
of
Object
.
entries
(
scopeDirectories
)
)
{
let
id
=
getID
(
name
)
;
await
createWebExtension
(
id
{
name
}
.
1
dir
)
;
id
=
getID
(
legacy
-
{
name
}
)
;
await
createWebExtension
(
id
{
name
}
.
1
dir
)
;
}
await
promiseStartupManager
(
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_INSTALLED
[
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_CHANGED
[
getID
(
"
profile
"
)
.
.
.
legacyIDs
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_UNINSTALLED
[
]
)
;
await
promiseShutdownManager
(
)
;
}
)
;
add_task
(
async
function
test_sideloads_removed
(
)
{
let
id
=
getID
(
legacy
-
profile
)
;
let
file
=
AddonTestUtils
.
getFileForAddon
(
profileDir
id
)
;
file
.
remove
(
false
)
;
Assert
.
ok
(
!
file
.
exists
(
)
)
;
await
promiseStartupManager
(
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_INSTALLED
[
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_CHANGED
[
]
)
;
check_startup_changes
(
AddonManager
.
STARTUP_CHANGE_UNINSTALLED
[
id
]
)
;
await
promiseShutdownManager
(
)
;
}
)
;
add_task
(
async
function
test_sideload_uninstall
(
)
{
await
promiseStartupManager
(
)
;
let
addons
=
await
AddonManager
.
getAddonsByTypes
(
[
"
extension
"
]
)
;
Assert
.
equal
(
addons
.
length
3
"
addons
installed
"
)
;
for
(
let
addon
of
addons
)
{
let
file
=
AddonTestUtils
.
getFileForAddon
(
scopeToDir
.
get
(
addon
.
scope
)
addon
.
id
)
;
await
addon
.
uninstall
(
)
;
Assert
.
notEqual
(
addon
.
scope
=
=
AddonManager
.
SCOPE_PROFILE
file
.
exists
(
)
file
remains
after
uninstall
for
non
-
profile
sideloads
scope
{
addon
.
scope
}
)
;
}
addons
=
await
AddonManager
.
getAddonsByTypes
(
[
"
extension
"
]
)
;
Assert
.
equal
(
addons
.
length
0
"
addons
left
"
)
;
await
promiseShutdownManager
(
)
;
}
)
;
