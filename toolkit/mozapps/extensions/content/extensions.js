"
use
strict
"
;
const
{
AddonManager
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
AMTelemetry
"
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
jsm
"
)
;
document
.
addEventListener
(
"
load
"
initialize
true
)
;
window
.
addEventListener
(
"
unload
"
shutdown
)
;
var
gPendingInitializations
=
1
;
Object
.
defineProperty
(
this
"
gIsInitializing
"
{
get
:
(
)
=
>
gPendingInitializations
>
0
}
)
;
function
initialize
(
event
)
{
document
.
removeEventListener
(
"
load
"
initialize
true
)
;
document
.
addEventListener
(
"
keypress
"
e
=
>
{
getHtmlBrowser
(
)
.
contentDocument
.
querySelector
(
"
search
-
addons
"
)
.
handleEvent
(
e
)
;
}
)
;
gViewController
.
initialize
(
)
;
Services
.
obs
.
addObserver
(
sendEMPong
"
EM
-
ping
"
)
;
Services
.
obs
.
notifyObservers
(
window
"
EM
-
loaded
"
)
;
if
(
gViewController
.
initialViewSelected
)
{
return
;
}
if
(
window
.
history
.
state
)
{
gViewController
.
updateState
(
window
.
history
.
state
)
;
}
}
function
notifyInitialized
(
)
{
if
(
!
gIsInitializing
)
{
return
;
}
gPendingInitializations
-
-
;
if
(
!
gIsInitializing
)
{
var
event
=
document
.
createEvent
(
"
Events
"
)
;
event
.
initEvent
(
"
Initialized
"
true
true
)
;
document
.
dispatchEvent
(
event
)
;
}
}
function
shutdown
(
)
{
Services
.
obs
.
removeObserver
(
sendEMPong
"
EM
-
ping
"
)
;
}
function
sendEMPong
(
aSubject
aTopic
aData
)
{
Services
.
obs
.
notifyObservers
(
window
"
EM
-
pong
"
)
;
}
async
function
recordViewTelemetry
(
param
)
{
let
type
;
let
addon
;
if
(
param
in
AddonManager
.
addonTypes
|
|
[
"
recent
"
"
available
"
]
.
includes
(
param
)
)
{
type
=
param
;
}
else
if
(
param
)
{
let
id
=
param
.
replace
(
"
/
preferences
"
"
"
)
;
addon
=
await
AddonManager
.
getAddonByID
(
id
)
;
}
let
{
currentViewId
}
=
gViewController
;
let
viewType
=
gViewController
.
parseViewId
(
currentViewId
)
?
.
type
;
AMTelemetry
.
recordViewEvent
(
{
view
:
viewType
|
|
"
other
"
addon
type
}
)
;
}
function
loadView
(
aViewId
)
{
if
(
!
gViewController
.
initialViewSelected
)
{
gViewController
.
loadInitialView
(
aViewId
)
;
}
else
{
gViewController
.
loadView
(
aViewId
)
;
}
}
var
HTML5History
=
{
get
index
(
)
{
return
window
.
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
sessionHistory
.
index
;
}
get
canGoBack
(
)
{
return
window
.
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
canGoBack
;
}
get
canGoForward
(
)
{
return
window
.
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
canGoForward
;
}
back
(
)
{
window
.
history
.
back
(
)
;
}
forward
(
)
{
window
.
history
.
forward
(
)
;
}
pushState
(
aState
)
{
window
.
history
.
pushState
(
aState
document
.
title
)
;
}
replaceState
(
aState
)
{
window
.
history
.
replaceState
(
aState
document
.
title
)
;
}
popState
(
)
{
function
onStatePopped
(
aEvent
)
{
window
.
removeEventListener
(
"
popstate
"
onStatePopped
true
)
;
window
.
history
.
pushState
(
aEvent
.
state
document
.
title
)
;
}
window
.
addEventListener
(
"
popstate
"
onStatePopped
true
)
;
window
.
history
.
back
(
)
;
}
}
;
var
FakeHistory
=
{
pos
:
0
states
:
[
null
]
get
index
(
)
{
return
this
.
pos
;
}
get
canGoBack
(
)
{
return
this
.
pos
>
0
;
}
get
canGoForward
(
)
{
return
this
.
pos
+
1
<
this
.
states
.
length
;
}
back
(
)
{
if
(
this
.
pos
=
=
0
)
{
throw
Components
.
Exception
(
"
Cannot
go
back
from
this
point
"
)
;
}
this
.
pos
-
-
;
gViewController
.
updateState
(
this
.
states
[
this
.
pos
]
)
;
}
forward
(
)
{
if
(
this
.
pos
+
1
>
=
this
.
states
.
length
)
{
throw
Components
.
Exception
(
"
Cannot
go
forward
from
this
point
"
)
;
}
this
.
pos
+
+
;
gViewController
.
updateState
(
this
.
states
[
this
.
pos
]
)
;
}
pushState
(
aState
)
{
this
.
pos
+
+
;
this
.
states
.
splice
(
this
.
pos
this
.
states
.
length
)
;
this
.
states
.
push
(
aState
)
;
}
replaceState
(
aState
)
{
this
.
states
[
this
.
pos
]
=
aState
;
}
popState
(
)
{
if
(
this
.
pos
=
=
0
)
{
throw
Components
.
Exception
(
"
Cannot
popState
from
this
view
"
)
;
}
this
.
states
.
splice
(
this
.
pos
this
.
states
.
length
)
;
this
.
pos
-
-
;
gViewController
.
updateState
(
this
.
states
[
this
.
pos
]
)
;
}
}
;
if
(
window
.
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
sessionHistory
)
{
var
gHistory
=
HTML5History
;
}
else
{
gHistory
=
FakeHistory
;
}
var
gViewController
=
{
defaultViewId
:
"
addons
:
/
/
discover
/
"
currentViewId
:
"
"
isLoading
:
true
nextHistoryEntryId
:
Math
.
floor
(
Math
.
random
(
)
*
2
*
*
32
)
initialViewSelected
:
false
initialize
(
)
{
if
(
!
isDiscoverEnabled
(
)
)
{
this
.
defaultViewId
=
"
addons
:
/
/
list
/
extension
"
;
}
gCategories
.
initialize
(
)
;
window
.
addEventListener
(
"
popstate
"
e
=
>
{
this
.
updateState
(
e
.
state
)
;
}
)
;
}
updateState
(
state
)
{
this
.
loadViewInternal
(
state
.
view
state
.
previousView
state
)
;
}
parseViewId
(
aViewId
)
{
var
matchRegex
=
/
^
addons
:
\
/
\
/
(
[
^
\
/
]
+
)
\
/
(
.
*
)
/
;
var
[
viewType
viewParam
]
=
aViewId
.
match
(
matchRegex
)
|
|
[
]
;
return
{
type
:
viewType
param
:
decodeURIComponent
(
viewParam
)
}
;
}
loadView
(
aViewId
)
{
if
(
aViewId
=
=
this
.
currentViewId
)
{
return
;
}
var
state
=
{
view
:
aViewId
previousView
:
this
.
currentViewId
historyEntryId
:
+
+
this
.
nextHistoryEntryId
}
;
gHistory
.
pushState
(
state
)
;
this
.
loadViewInternal
(
aViewId
this
.
currentViewId
state
)
;
}
replaceView
(
aViewId
)
{
if
(
aViewId
=
=
this
.
currentViewId
)
{
return
;
}
var
state
=
{
view
:
aViewId
previousView
:
null
historyEntryId
:
+
+
this
.
nextHistoryEntryId
}
;
gHistory
.
replaceState
(
state
)
;
this
.
loadViewInternal
(
aViewId
null
state
)
;
}
loadInitialView
(
aViewId
)
{
var
state
=
{
view
:
aViewId
previousView
:
null
historyEntryId
:
+
+
this
.
nextHistoryEntryId
}
;
gHistory
.
replaceState
(
state
)
;
this
.
loadViewInternal
(
aViewId
null
state
)
;
notifyInitialized
(
)
;
}
loadViewInternal
(
aViewId
aPreviousView
aState
)
{
const
view
=
this
.
parseViewId
(
aViewId
)
;
const
viewTypes
=
[
"
shortcuts
"
"
list
"
"
detail
"
"
updates
"
"
discover
"
]
;
if
(
!
view
.
type
|
|
!
viewTypes
.
includes
(
view
.
type
)
)
{
throw
Components
.
Exception
(
"
Invalid
view
:
"
+
view
.
type
)
;
}
if
(
aViewId
!
=
aPreviousView
)
{
promiseHtmlBrowserLoaded
(
)
.
then
(
browser
=
>
browser
.
contentWindow
.
hide
(
)
)
.
catch
(
err
=
>
Cu
.
reportError
(
err
)
)
;
}
this
.
currentViewId
=
aViewId
;
this
.
isLoading
=
true
;
recordViewTelemetry
(
view
.
param
)
;
if
(
aViewId
!
=
aPreviousView
)
{
promiseHtmlBrowserLoaded
(
)
.
then
(
browser
=
>
browser
.
contentWindow
.
show
(
view
.
type
view
.
param
aState
)
)
.
then
(
(
)
=
>
{
this
.
isLoading
=
false
;
var
event
=
document
.
createEvent
(
"
Events
"
)
;
event
.
initEvent
(
"
ViewChanged
"
true
true
)
;
document
.
dispatchEvent
(
event
)
;
}
)
;
}
this
.
initialViewSelected
=
true
;
}
}
;
var
gCategories
=
{
initialize
(
)
{
gPendingInitializations
+
+
;
promiseHtmlBrowserLoaded
(
)
.
then
(
async
browser
=
>
{
await
browser
.
contentWindow
.
customElements
.
whenDefined
(
"
categories
-
box
"
)
;
let
categoriesBox
=
browser
.
contentDocument
.
getElementById
(
"
categories
"
)
;
await
categoriesBox
.
promiseInitialized
;
notifyInitialized
(
)
;
}
)
;
}
}
;
const
htmlViewOpts
=
{
loadViewFn
(
view
)
{
let
viewId
=
view
.
startsWith
(
"
addons
:
/
/
"
)
?
view
:
addons
:
/
/
{
view
}
;
gViewController
.
loadView
(
viewId
)
;
}
loadInitialViewFn
(
viewId
)
{
gViewController
.
loadInitialView
(
viewId
)
;
}
replaceWithDefaultViewFn
(
)
{
gViewController
.
replaceView
(
gViewController
.
defaultViewId
)
;
}
get
shouldLoadInitialView
(
)
{
return
!
gViewController
.
currentViewId
&
&
!
window
.
history
.
state
;
}
}
;
let
htmlBrowser
;
let
_htmlBrowserLoaded
;
function
getHtmlBrowser
(
)
{
if
(
!
htmlBrowser
)
{
gPendingInitializations
+
+
;
htmlBrowser
=
document
.
getElementById
(
"
html
-
view
-
browser
"
)
;
htmlBrowser
.
loadURI
(
"
chrome
:
/
/
mozapps
/
content
/
extensions
/
aboutaddons
.
html
"
{
triggeringPrincipal
:
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
}
)
;
_htmlBrowserLoaded
=
new
Promise
(
resolve
=
>
htmlBrowser
.
addEventListener
(
"
load
"
function
loadListener
(
)
{
if
(
htmlBrowser
.
contentWindow
.
location
.
href
!
=
"
about
:
blank
"
)
{
htmlBrowser
.
removeEventListener
(
"
load
"
loadListener
)
;
resolve
(
)
;
}
}
)
)
.
then
(
(
)
=
>
{
htmlBrowser
.
contentWindow
.
initialize
(
htmlViewOpts
)
;
notifyInitialized
(
)
;
}
)
;
}
return
htmlBrowser
;
}
async
function
promiseHtmlBrowserLoaded
(
)
{
let
browser
=
getHtmlBrowser
(
)
;
await
_htmlBrowserLoaded
;
return
browser
;
}
window
.
openAbuseReport
=
(
{
addonId
reportEntryPoint
}
)
=
>
{
promiseHtmlBrowserLoaded
(
)
.
then
(
browser
=
>
{
browser
.
contentWindow
.
openAbuseReport
(
{
addonId
reportEntryPoint
}
)
;
}
)
;
}
;
