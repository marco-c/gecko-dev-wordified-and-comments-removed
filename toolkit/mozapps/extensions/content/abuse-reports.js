const
{
AbuseReporter
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
AbuseReporter
.
sys
.
mjs
"
)
;
const
ABUSE_REPORT_MESSAGE_BARS
=
{
submitting
:
{
id
:
"
submitting
"
actions
:
[
"
cancel
"
]
}
submitted
:
{
id
:
"
submitted
"
actionAddonTypeSuffix
:
true
actions
:
[
"
remove
"
"
keep
"
]
dismissable
:
true
}
"
submitted
-
no
-
remove
-
action
"
:
{
id
:
"
submitted
-
noremove
"
dismissable
:
true
}
"
submitted
-
and
-
removed
"
:
{
id
:
"
removed
"
addonTypeSuffix
:
true
dismissable
:
true
}
ERROR_ABORTED_SUBMIT
:
{
id
:
"
aborted
"
type
:
"
generic
"
dismissable
:
true
}
ERROR_ADDON_NOTFOUND
:
{
id
:
"
error
"
type
:
"
error
"
dismissable
:
true
}
ERROR_CLIENT
:
{
id
:
"
error
"
type
:
"
error
"
dismissable
:
true
}
ERROR_NETWORK
:
{
id
:
"
error
"
actions
:
[
"
retry
"
"
cancel
"
]
type
:
"
error
"
}
ERROR_RECENT_SUBMIT
:
{
id
:
"
error
-
recent
-
submit
"
actions
:
[
"
retry
"
"
cancel
"
]
type
:
"
error
"
}
ERROR_SERVER
:
{
id
:
"
error
"
actions
:
[
"
retry
"
"
cancel
"
]
type
:
"
error
"
}
ERROR_UNKNOWN
:
{
id
:
"
error
"
actions
:
[
"
retry
"
"
cancel
"
]
type
:
"
error
"
}
}
;
async
function
openAbuseReport
(
{
addonId
reportEntryPoint
}
)
{
try
{
const
reportDialog
=
await
AbuseReporter
.
openDialog
(
addonId
reportEntryPoint
window
.
docShell
.
chromeEventHandler
)
;
const
beforeunloadListener
=
evt
=
>
evt
.
preventDefault
(
)
;
const
unloadListener
=
(
)
=
>
reportDialog
.
close
(
)
;
const
clearUnloadListeners
=
(
)
=
>
{
window
.
removeEventListener
(
"
beforeunload
"
beforeunloadListener
)
;
window
.
removeEventListener
(
"
unload
"
unloadListener
)
;
}
;
window
.
addEventListener
(
"
beforeunload
"
beforeunloadListener
)
;
window
.
addEventListener
(
"
unload
"
unloadListener
)
;
reportDialog
.
promiseReport
.
then
(
report
=
>
{
if
(
report
)
{
submitReport
(
{
report
}
)
;
}
}
err
=
>
{
Cu
.
reportError
(
Unexpected
abuse
report
panel
error
:
{
err
}
:
:
{
err
.
stack
}
)
;
reportDialog
.
close
(
)
;
}
)
.
then
(
clearUnloadListeners
)
;
}
catch
(
err
)
{
Cu
.
reportError
(
err
)
;
document
.
dispatchEvent
(
new
CustomEvent
(
"
abuse
-
report
:
create
-
error
"
{
detail
:
{
addonId
addon
:
err
.
addon
errorType
:
err
.
errorType
}
}
)
)
;
}
}
window
.
openAbuseReport
=
openAbuseReport
;
function
createReportMessageBar
(
definitionId
{
addonId
addonName
addonType
}
{
onclose
onaction
}
=
{
}
)
{
const
getMessageL10n
=
id
=
>
abuse
-
report
-
messagebar
-
{
id
}
;
const
getActionL10n
=
action
=
>
getMessageL10n
(
action
-
{
action
}
)
;
const
barInfo
=
ABUSE_REPORT_MESSAGE_BARS
[
definitionId
]
;
if
(
!
barInfo
)
{
throw
new
Error
(
message
-
bar
definition
not
found
:
{
definitionId
}
)
;
}
const
{
id
dismissable
actions
type
}
=
barInfo
;
const
messageEl
=
document
.
createElement
(
"
span
"
)
;
const
addonNameEl
=
document
.
createElement
(
"
span
"
)
;
addonNameEl
.
setAttribute
(
"
data
-
l10n
-
name
"
"
addon
-
name
"
)
;
messageEl
.
append
(
addonNameEl
)
;
const
mappingAddonType
=
addonType
=
=
=
"
sitepermission
-
deprecated
"
?
"
sitepermission
"
:
addonType
;
document
.
l10n
.
setAttributes
(
messageEl
getMessageL10n
(
barInfo
.
addonTypeSuffix
?
{
id
}
-
{
mappingAddonType
}
:
id
)
{
"
addon
-
name
"
:
addonName
|
|
addonId
}
)
;
const
barActions
=
actions
?
actions
.
map
(
action
=
>
{
const
actionId
=
barInfo
.
actionAddonTypeSuffix
?
{
action
}
-
{
mappingAddonType
}
:
action
;
const
buttonEl
=
document
.
createElement
(
"
button
"
)
;
buttonEl
.
addEventListener
(
"
click
"
(
)
=
>
onaction
&
&
onaction
(
action
)
)
;
document
.
l10n
.
setAttributes
(
buttonEl
getActionL10n
(
actionId
)
)
;
return
buttonEl
;
}
)
:
[
]
;
const
messagebar
=
document
.
createElement
(
"
message
-
bar
"
)
;
messagebar
.
setAttribute
(
"
type
"
type
|
|
"
generic
"
)
;
if
(
dismissable
)
{
messagebar
.
setAttribute
(
"
dismissable
"
"
"
)
;
}
messagebar
.
append
(
messageEl
.
.
.
barActions
)
;
messagebar
.
addEventListener
(
"
message
-
bar
:
close
"
onclose
{
once
:
true
}
)
;
document
.
getElementById
(
"
abuse
-
reports
-
messages
"
)
.
append
(
messagebar
)
;
document
.
dispatchEvent
(
new
CustomEvent
(
"
abuse
-
report
:
new
-
message
-
bar
"
{
detail
:
{
definitionId
messagebar
}
}
)
)
;
return
messagebar
;
}
async
function
submitReport
(
{
report
}
)
{
const
{
addon
}
=
report
;
const
addonId
=
addon
.
id
;
const
addonName
=
addon
.
name
;
const
addonType
=
addon
.
type
;
const
{
gBrowser
}
=
window
.
windowRoot
.
ownerGlobal
;
if
(
gBrowser
&
&
gBrowser
.
getTabForBrowser
)
{
let
tab
=
gBrowser
.
getTabForBrowser
(
window
.
docShell
.
chromeEventHandler
)
;
gBrowser
.
selectedTab
=
tab
;
}
const
mbSubmitting
=
createReportMessageBar
(
"
submitting
"
{
addonId
addonName
addonType
}
{
onaction
:
action
=
>
{
if
(
action
=
=
=
"
cancel
"
)
{
report
.
abort
(
)
;
mbSubmitting
.
remove
(
)
;
}
}
}
)
;
try
{
await
report
.
submit
(
)
;
mbSubmitting
.
remove
(
)
;
let
barId
;
if
(
!
(
addon
.
permissions
&
AddonManager
.
PERM_CAN_UNINSTALL
)
&
&
!
isPending
(
addon
"
uninstall
"
)
)
{
barId
=
"
submitted
-
no
-
remove
-
action
"
;
}
else
if
(
report
.
reportEntryPoint
=
=
=
"
uninstall
"
)
{
barId
=
"
submitted
-
and
-
removed
"
;
}
else
{
barId
=
"
submitted
"
;
}
const
mbInfo
=
createReportMessageBar
(
barId
{
addonId
addonName
addonType
}
{
onaction
:
action
=
>
{
mbInfo
.
remove
(
)
;
if
(
action
=
=
=
"
remove
"
)
{
report
.
addon
.
uninstall
(
true
)
;
}
}
}
)
;
}
catch
(
err
)
{
console
.
error
(
"
Error
submitting
abuse
report
for
"
addonId
err
)
;
mbSubmitting
.
remove
(
)
;
const
barId
=
err
.
errorType
in
ABUSE_REPORT_MESSAGE_BARS
?
err
.
errorType
:
"
ERROR_UNKNOWN
"
;
const
mbError
=
createReportMessageBar
(
barId
{
addonId
addonName
addonType
}
{
onaction
:
action
=
>
{
mbError
.
remove
(
)
;
switch
(
action
)
{
case
"
retry
"
:
submitReport
(
{
report
}
)
;
break
;
case
"
cancel
"
:
report
.
abort
(
)
;
break
;
}
}
}
)
;
}
}
document
.
addEventListener
(
"
abuse
-
report
:
submit
"
(
{
detail
}
)
=
>
{
submitReport
(
detail
)
;
}
)
;
document
.
addEventListener
(
"
abuse
-
report
:
create
-
error
"
(
{
detail
}
)
=
>
{
const
{
addonId
addon
errorType
}
=
detail
;
const
barId
=
errorType
in
ABUSE_REPORT_MESSAGE_BARS
?
errorType
:
"
ERROR_UNKNOWN
"
;
createReportMessageBar
(
barId
{
addonId
addonName
:
addon
&
&
addon
.
name
addonType
:
addon
&
&
addon
.
type
}
)
;
}
)
;
