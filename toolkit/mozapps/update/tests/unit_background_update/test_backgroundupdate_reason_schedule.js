"
use
strict
"
;
const
{
BackgroundUpdate
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
BackgroundUpdate
.
jsm
"
)
;
let
reasons
=
(
)
=
>
BackgroundUpdate
.
_reasonsToNotScheduleUpdates
(
)
;
let
REASON
=
BackgroundUpdate
.
REASON
;
const
{
AddonTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
AddonTestUtils
.
jsm
"
)
;
const
{
ExtensionTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
ExtensionXPCShellUtils
.
jsm
"
)
;
setupProfileService
(
)
;
ExtensionTestUtils
.
init
(
this
)
;
AddonTestUtils
.
init
(
this
)
;
AddonTestUtils
.
overrideCertDB
(
)
;
AddonTestUtils
.
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
42
"
"
42
"
)
;
add_setup
(
function
test_setup
(
)
{
do_get_profile
(
)
;
Services
.
fog
.
initializeFOG
(
)
;
setupProfileService
(
)
;
}
)
;
add_task
(
{
skip_if
:
(
)
=
>
!
AppConstants
.
MOZ_BACKGROUNDTASKS
}
async
function
test_reasons_schedule_langpacks
(
)
{
await
AddonTestUtils
.
promiseStartupManager
(
)
;
Services
.
prefs
.
setBoolPref
(
"
app
.
update
.
langpack
.
enabled
"
true
)
;
let
result
=
await
reasons
(
)
;
Assert
.
ok
(
!
result
.
includes
(
REASON
.
LANGPACK_INSTALLED
)
"
Reasons
does
not
include
LANGPACK_INSTALLED
"
)
;
let
langpack
=
{
"
manifest
.
json
"
:
{
name
:
"
test
Language
Pack
"
version
:
"
1
.
0
"
manifest_version
:
2
browser_specific_settings
:
{
gecko
:
{
id
:
"
test
-
langpack
"
strict_min_version
:
"
42
.
0
"
strict_max_version
:
"
42
.
0
"
}
}
langpack_id
:
"
fr
"
languages
:
{
fr
:
{
chrome_resources
:
{
global
:
"
chrome
/
fr
/
locale
/
fr
/
global
/
"
}
version
:
"
20171001190118
"
}
}
sources
:
{
browser
:
{
base_path
:
"
browser
/
"
}
}
}
}
;
await
Promise
.
all
(
[
TestUtils
.
topicObserved
(
"
webextension
-
langpack
-
startup
"
)
AddonTestUtils
.
promiseInstallXPI
(
langpack
)
]
)
;
result
=
await
reasons
(
)
;
Assert
.
ok
(
result
.
includes
(
REASON
.
LANGPACK_INSTALLED
)
"
Reasons
include
LANGPACK_INSTALLED
"
)
;
result
=
await
checkGleanPing
(
)
;
Assert
.
ok
(
result
.
includes
(
REASON
.
LANGPACK_INSTALLED
)
"
Recognizes
a
language
pack
is
installed
.
"
)
;
Services
.
prefs
.
setBoolPref
(
"
app
.
update
.
langpack
.
enabled
"
false
)
;
result
=
await
reasons
(
)
;
Assert
.
ok
(
!
result
.
includes
(
REASON
.
LANGPACK_INSTALLED
)
"
Reasons
does
not
include
LANGPACK_INSTALLED
"
)
;
result
=
await
checkGleanPing
(
)
;
Assert
.
ok
(
!
result
.
includes
(
REASON
.
LANGPACK_INSTALLED
)
"
No
Glean
metric
when
no
language
pack
is
installed
.
"
)
;
}
)
;
add_task
(
{
skip_if
:
(
)
=
>
!
AppConstants
.
MOZ_BACKGROUNDTASKS
}
async
function
test_reasons_schedule_default_profile
(
)
{
let
result
=
await
reasons
(
)
;
Assert
.
ok
(
result
.
includes
(
REASON
.
NO_DEFAULT_PROFILE_EXISTS
)
)
;
Assert
.
ok
(
result
.
includes
(
REASON
.
NOT_DEFAULT_PROFILE
)
)
;
}
)
;
