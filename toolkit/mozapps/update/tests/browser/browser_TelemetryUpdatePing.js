ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
TelemetryArchiveTesting
.
jsm
"
this
)
;
add_task
(
async
function
testUpdatePingReady
(
)
{
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
PREF_APP_UPDATE_STAGING_ENABLED
false
]
]
}
)
;
await
UpdateUtils
.
setAppUpdateAutoEnabled
(
false
)
;
let
updateParams
=
"
promptWaitTime
=
0
"
;
let
archiveChecker
=
new
TelemetryArchiveTesting
.
Checker
(
)
;
await
archiveChecker
.
promiseInit
(
)
;
await
runUpdateTest
(
updateParams
1
[
{
notificationId
:
"
update
-
available
"
button
:
"
button
"
beforeClick
(
)
{
checkWhatsNewLink
(
window
"
update
-
available
-
whats
-
new
"
)
;
}
}
{
notificationId
:
"
update
-
restart
"
button
:
"
secondaryButton
"
cleanup
(
)
{
AppMenuNotifications
.
removeNotification
(
/
.
*
/
)
;
}
}
]
)
;
let
updatePing
;
await
BrowserTestUtils
.
waitForCondition
(
async
function
(
)
{
updatePing
=
await
archiveChecker
.
promiseFindPing
(
"
update
"
[
[
[
"
payload
"
"
reason
"
]
"
ready
"
]
[
[
"
payload
"
"
targetBuildId
"
]
"
20080811053724
"
]
]
)
;
return
!
!
updatePing
;
}
"
Make
sure
the
ping
is
generated
before
trying
to
validate
it
.
"
500
100
)
;
ok
(
updatePing
"
The
'
update
'
ping
must
be
correctly
sent
.
"
)
;
for
(
let
f
of
[
"
targetVersion
"
"
targetChannel
"
"
targetDisplayVersion
"
]
)
{
ok
(
f
in
updatePing
.
payload
{
f
}
must
be
available
in
the
update
ping
payload
.
)
;
ok
(
typeof
(
updatePing
.
payload
[
f
]
)
=
=
"
string
"
{
f
}
must
have
the
correct
format
.
)
;
}
ok
(
"
clientId
"
in
updatePing
"
The
update
ping
must
report
a
client
id
.
"
)
;
ok
(
"
environment
"
in
updatePing
"
The
update
ping
must
report
the
environment
.
"
)
;
}
)
;
