add_task
(
async
function
(
)
{
setupTestCommon
(
)
;
let
syncManager
=
Cc
[
"
mozilla
.
org
/
updates
/
update
-
sync
-
manager
;
1
"
]
.
getService
(
Ci
.
nsIUpdateSyncManager
)
;
Assert
.
ok
(
!
syncManager
.
isOtherInstanceRunning
(
)
"
no
other
instance
is
running
yet
"
)
;
for
(
let
runs
=
0
;
runs
<
2
;
runs
+
+
)
{
runInSubprocessWithPrelude
(
getTestDirFile
(
"
syncManagerTestChild
.
js
"
)
.
path
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
syncManager
.
isOtherInstanceRunning
(
)
"
waiting
for
child
process
to
take
the
lock
"
)
.
catch
(
_e
=
>
{
Assert
.
ok
(
syncManager
.
isOtherInstanceRunning
(
)
"
child
process
has
the
lock
"
)
;
}
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
!
syncManager
.
isOtherInstanceRunning
(
)
"
waiting
for
child
process
to
release
the
lock
"
)
.
catch
(
_e
=
>
{
Assert
.
ok
(
!
syncManager
.
isOtherInstanceRunning
(
)
"
child
process
has
released
the
lock
"
)
;
}
)
;
}
await
doTestFinish
(
)
;
}
)
;
