ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
this
)
;
async
function
verifyPref
(
configFile
expectedValue
)
{
let
decoder
=
new
TextDecoder
(
)
;
let
configValue
=
await
UpdateUtils
.
getAppUpdateAutoEnabled
(
)
;
Assert
.
equal
(
configValue
expectedValue
"
Value
returned
by
getAppUpdateAutoEnabled
should
have
"
+
"
matched
the
expected
value
"
)
;
let
fileContents
=
await
OS
.
File
.
read
(
configFile
.
path
)
;
let
saveObject
=
JSON
.
parse
(
decoder
.
decode
(
fileContents
)
)
;
Assert
.
equal
(
saveObject
[
"
app
.
update
.
auto
"
]
expectedValue
"
Value
in
update
config
file
should
match
expected
"
)
;
}
async
function
run_test
(
)
{
setupTestCommon
(
null
)
;
standardInit
(
)
;
let
configFile
=
getUpdateDirFile
(
FILE_UPDATE_CONFIG_JSON
)
;
Services
.
prefs
.
setBoolPref
(
"
app
.
update
.
auto
.
migrated
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
app
.
update
.
auto
"
false
)
;
Assert
.
ok
(
!
configFile
.
exists
(
)
"
Config
file
should
not
exist
yet
"
)
;
await
verifyPref
(
configFile
false
)
;
Services
.
prefs
.
setBoolPref
(
"
app
.
update
.
auto
"
true
)
;
await
verifyPref
(
configFile
false
)
;
debugDump
(
"
about
to
remove
config
file
"
)
;
configFile
.
remove
(
false
)
;
Assert
.
ok
(
!
configFile
.
exists
(
)
"
Pref
file
should
have
been
removed
"
)
;
let
configValue
=
await
UpdateUtils
.
getAppUpdateAutoEnabled
(
)
;
Assert
.
equal
(
configValue
true
"
getAppUpdateAutoEnabled
should
have
returned
the
default
value
(
true
)
"
)
;
await
UpdateUtils
.
setAppUpdateAutoEnabled
(
false
)
;
await
verifyPref
(
configFile
false
)
;
Services
.
prefs
.
setBoolPref
(
"
app
.
update
.
auto
.
migrated
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
app
.
update
.
auto
"
true
)
;
configFile
.
remove
(
false
)
;
Assert
.
ok
(
!
configFile
.
exists
(
)
"
App
update
config
file
should
have
been
removed
"
)
;
await
verifyPref
(
configFile
true
)
;
await
UpdateUtils
.
setAppUpdateAutoEnabled
(
false
)
;
await
verifyPref
(
configFile
false
)
;
doTestFinish
(
)
;
}
