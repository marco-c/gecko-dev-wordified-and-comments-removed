const
TEST_ID
=
"
0112
"
;
const
TEST_FILES
=
[
{
fileName
:
"
1_1_image1
.
png
"
destinationDir
:
TEST_ID
+
APPLY_TO_DIR_SUFFIX
+
"
/
mar_test
/
1
/
1_1
/
"
originalContents
:
null
compareContents
:
null
originalFile
:
"
data
/
complete
.
png
"
compareFile
:
"
data
/
complete
.
png
"
originalPerms
:
0644
comparePerms
:
null
}
{
fileName
:
"
1_1_text1
"
destinationDir
:
TEST_ID
+
APPLY_TO_DIR_SUFFIX
+
"
/
mar_test
/
1
/
1_1
/
"
originalContents
:
"
ShouldNotBeDeleted
\
n
"
compareContents
:
"
ShouldNotBeDeleted
\
n
"
originalFile
:
null
compareFile
:
null
originalPerms
:
0644
comparePerms
:
null
}
{
fileName
:
"
1_1_text2
"
destinationDir
:
TEST_ID
+
APPLY_TO_DIR_SUFFIX
+
"
/
mar_test
/
1
/
1_1
/
"
originalContents
:
"
ShouldNotBeDeleted
\
n
"
compareContents
:
"
ShouldNotBeDeleted
\
n
"
originalFile
:
null
compareFile
:
null
originalPerms
:
0644
comparePerms
:
null
}
{
fileName
:
"
1_exe1
.
exe
"
destinationDir
:
TEST_ID
+
APPLY_TO_DIR_SUFFIX
+
"
/
mar_test
/
1
/
"
originalContents
:
null
compareContents
:
null
originalFile
:
"
data
/
partial
.
png
"
compareFile
:
"
data
/
partial
.
png
"
originalPerms
:
0755
comparePerms
:
null
}
{
fileName
:
"
2_1_text1
"
destinationDir
:
TEST_ID
+
APPLY_TO_DIR_SUFFIX
+
"
/
mar_test
/
2
/
2_1
/
"
originalContents
:
"
ShouldNotBeDeleted
\
n
"
compareContents
:
"
ShouldNotBeDeleted
\
n
"
originalFile
:
null
compareFile
:
null
originalPerms
:
0644
comparePerms
:
null
}
]
;
function
run_test
(
)
{
if
(
IS_ANDROID
)
{
logTestInfo
(
"
this
test
is
not
applicable
to
Android
.
.
.
returning
early
"
)
;
return
;
}
do_test_pending
(
)
;
do_register_cleanup
(
end_test
)
;
setupUpdaterTest
(
TEST_ID
MAR_PARTIAL_FILE
TEST_FILES
)
;
testUpdate
(
)
;
}
function
end_test
(
)
{
cleanupUpdaterTest
(
TEST_ID
)
;
}
function
testUpdate
(
)
{
let
updatesDir
=
do_get_file
(
TEST_ID
+
UPDATES_DIR_SUFFIX
)
;
let
applyToDir
=
do_get_file
(
TEST_ID
+
APPLY_TO_DIR_SUFFIX
)
;
let
lastModTime
;
if
(
IS_MACOSX
)
{
let
now
=
Date
.
now
(
)
;
lastModTime
=
now
-
(
1000
*
60
*
60
*
24
)
;
applyToDir
.
lastModifiedTime
=
lastModTime
;
lastModTime
=
applyToDir
.
lastModifiedTime
;
}
let
exitValue
=
runUpdate
(
TEST_ID
)
;
logTestInfo
(
"
testing
updater
binary
process
exitValue
for
success
when
"
+
"
applying
a
partial
mar
"
)
;
do_check_eq
(
exitValue
0
)
;
logTestInfo
(
"
testing
update
.
status
should
be
"
+
STATE_FAILED
)
;
do_check_eq
(
readStatusFile
(
updatesDir
)
.
split
(
"
:
"
)
[
0
]
STATE_FAILED
)
;
if
(
IS_MACOSX
)
{
logTestInfo
(
"
testing
last
modified
time
on
the
apply
to
directory
has
"
+
"
not
changed
after
a
failed
update
(
bug
600098
)
"
)
;
do_check_eq
(
applyToDir
.
lastModifiedTime
lastModTime
)
;
}
checkFilesAfterUpdateFailure
(
TEST_ID
TEST_FILES
)
;
logTestInfo
(
"
testing
tobedeleted
directory
doesn
'
t
exist
"
)
;
let
toBeDeletedDir
=
applyToDir
.
clone
(
)
;
toBeDeletedDir
.
append
(
"
tobedeleted
"
)
;
do_check_false
(
toBeDeletedDir
.
exists
(
)
)
;
checkCallbackAppLog
(
TEST_ID
)
;
}
