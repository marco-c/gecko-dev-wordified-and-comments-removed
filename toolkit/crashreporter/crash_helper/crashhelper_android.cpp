#
include
<
jni
.
h
>
#
include
<
android
/
log
.
h
>
#
include
<
fcntl
.
h
>
#
include
<
sys
/
socket
.
h
>
#
include
<
sys
/
un
.
h
>
#
include
"
mozilla
/
toolkit
/
crashreporter
/
rust_minidump_writer_linux_ffi_generated
.
h
"
#
include
"
mozilla
/
crash_helper_ffi_generated
.
h
"
#
define
CRASH_HELPER_LOGTAG
"
GeckoCrashHelper
"
extern
"
C
"
JNIEXPORT
jboolean
JNICALL
Java_org_mozilla_gecko_crashhelper_CrashHelper_set_1breakpad_1opts
(
JNIEnv
*
jenv
jclass
jint
breakpad_fd
)
{
const
int
val
=
1
;
int
res
=
setsockopt
(
breakpad_fd
SOL_SOCKET
SO_PASSCRED
&
val
sizeof
(
val
)
)
;
if
(
res
<
0
)
{
return
false
;
}
return
true
;
}
extern
"
C
"
JNIEXPORT
void
JNICALL
Java_org_mozilla_gecko_crashhelper_CrashHelper_crash_1generator
(
JNIEnv
*
jenv
jclass
jint
pid
jint
breakpad_fd
jstring
minidump_path
jint
server_fd
)
{
int
flags
=
fcntl
(
breakpad_fd
F_GETFL
)
;
if
(
flags
=
=
-
1
)
{
__android_log_print
(
ANDROID_LOG_FATAL
CRASH_HELPER_LOGTAG
"
Unable
to
get
the
Breakpad
pipe
file
options
"
)
;
return
;
}
int
res
=
fcntl
(
breakpad_fd
F_SETFL
flags
|
O_NONBLOCK
)
;
if
(
res
=
=
-
1
)
{
__android_log_print
(
ANDROID_LOG_FATAL
CRASH_HELPER_LOGTAG
"
Unable
to
set
the
Breakpad
pipe
in
non
-
blocking
mode
"
)
;
return
;
}
const
char
*
minidump_path_str
=
jenv
-
>
GetStringUTFChars
(
minidump_path
nullptr
)
;
crash_generator_logic_android
(
pid
breakpad_fd
minidump_path_str
server_fd
)
;
jenv
-
>
ReleaseStringUTFChars
(
minidump_path
minidump_path_str
)
;
}
