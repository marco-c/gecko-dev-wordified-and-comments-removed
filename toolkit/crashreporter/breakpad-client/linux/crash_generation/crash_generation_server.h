#
ifndef
CLIENT_LINUX_CRASH_GENERATION_CRASH_GENERATION_SERVER_H_
#
define
CLIENT_LINUX_CRASH_GENERATION_CRASH_GENERATION_SERVER_H_
#
include
<
pthread
.
h
>
#
include
<
array
>
#
include
<
functional
>
#
include
<
string
>
#
include
"
common
/
using_std_string
.
h
"
#
if
defined
(
MOZ_OXIDIZED_BREAKPAD
)
struct
DirectAuxvDumpInfo
;
#
endif
namespace
google_breakpad
{
class
ClientInfo
;
class
CrashGenerationServer
{
public
:
using
OnClientDumpRequestCallback
=
void
(
void
*
dump_context
const
ClientInfo
&
client_info
const
string
&
file_path
)
;
#
if
defined
(
MOZ_OXIDIZED_BREAKPAD
)
using
GetAuxvInfoCallback
=
bool
(
pid_t
pid
DirectAuxvDumpInfo
*
)
;
#
endif
CrashGenerationServer
(
const
int
listen_fd
#
if
defined
(
MOZ_OXIDIZED_BREAKPAD
)
std
:
:
function
<
GetAuxvInfoCallback
>
get_auxv_info
#
endif
std
:
:
function
<
OnClientDumpRequestCallback
>
dump_callback
void
*
dump_context
const
string
*
dump_path
)
;
~
CrashGenerationServer
(
)
;
bool
Start
(
)
;
void
Stop
(
)
;
void
SetPath
(
const
char
*
dump_path
)
;
static
bool
CreateReportChannel
(
int
*
server_fd
int
*
client_fd
)
;
CrashGenerationServer
(
CrashGenerationServer
&
&
)
=
delete
;
CrashGenerationServer
&
operator
=
(
CrashGenerationServer
&
&
)
=
delete
;
CrashGenerationServer
(
const
CrashGenerationServer
&
)
=
delete
;
CrashGenerationServer
&
operator
=
(
const
CrashGenerationServer
&
)
=
delete
;
private
:
void
Run
(
)
;
bool
ClientEvent
(
short
revents
)
;
bool
ControlEvent
(
short
revents
)
;
bool
MakeMinidumpFilename
(
string
&
outFilename
)
;
void
ReserveFileDescriptors
(
)
;
void
ReleaseFileDescriptors
(
)
;
int
server_fd_
;
#
if
defined
(
MOZ_OXIDIZED_BREAKPAD
)
std
:
:
function
<
GetAuxvInfoCallback
>
get_auxv_info_
;
#
endif
std
:
:
function
<
OnClientDumpRequestCallback
>
dump_callback_
;
void
*
dump_context_
;
pthread_mutex_t
dump_dir_mutex_
;
string
dump_dir_
;
bool
started_
;
pthread_t
thread_
;
int
control_pipe_in_
;
int
control_pipe_out_
;
static
const
size_t
RESERVED_FDS_NUM
=
2
;
std
:
:
array
<
int
RESERVED_FDS_NUM
>
reserved_fds_
;
}
;
}
#
endif
