use
std
:
:
{
env
path
:
:
Path
}
;
fn
main
(
)
{
windows_manifest
(
)
;
crash_ping_annotations
(
)
;
set_mock_cfg
(
)
;
set_glean_metrics_file
(
)
;
}
fn
windows_manifest
(
)
{
use
embed_manifest
:
:
{
embed_manifest
manifest
new_manifest
}
;
if
std
:
:
env
:
:
var_os
(
"
CARGO_CFG_WINDOWS
"
)
.
is_none
(
)
{
return
;
}
let
manifest
=
new_manifest
(
"
CrashReporter
"
)
.
active_code_page
(
manifest
:
:
ActiveCodePage
:
:
Legacy
)
.
dpi_awareness
(
manifest
:
:
DpiAwareness
:
:
PerMonitorV2
)
;
embed_manifest
(
manifest
)
.
expect
(
"
unable
to
embed
windows
manifest
file
"
)
;
println
!
(
"
cargo
:
rerun
-
if
-
changed
=
build
.
rs
"
)
;
}
fn
crash_ping_annotations
(
)
{
use
std
:
:
fs
:
:
File
;
use
std
:
:
io
:
:
{
BufWriter
Write
}
;
use
yaml_rust
:
:
{
Yaml
YamlLoader
}
;
let
crash_annotations
=
Path
:
:
new
(
"
.
.
/
.
.
/
CrashAnnotations
.
yaml
"
)
.
canonicalize
(
)
.
unwrap
(
)
;
println
!
(
"
cargo
:
rerun
-
if
-
changed
=
{
}
"
crash_annotations
.
display
(
)
)
;
let
crash_ping_file
=
Path
:
:
new
(
&
env
:
:
var
(
"
OUT_DIR
"
)
.
unwrap
(
)
)
.
join
(
"
ping_annotations
.
rs
"
)
;
let
yaml
=
std
:
:
fs
:
:
read_to_string
(
crash_annotations
)
.
unwrap
(
)
;
let
Yaml
:
:
Hash
(
entries
)
=
YamlLoader
:
:
load_from_str
(
&
yaml
)
.
unwrap
(
)
.
into_iter
(
)
.
next
(
)
.
unwrap
(
)
else
{
panic
!
(
"
unexpected
crash
annotations
root
type
"
)
;
}
;
let
ping_annotations
=
entries
.
into_iter
(
)
.
filter_map
(
|
(
k
v
)
|
{
v
[
"
ping
"
]
.
as_bool
(
)
.
unwrap_or
(
false
)
.
then
(
|
|
k
.
into_string
(
)
.
unwrap
(
)
)
}
)
;
let
mut
phf_set
=
phf_codegen
:
:
Set
:
:
new
(
)
;
for
annotation
in
ping_annotations
{
phf_set
.
entry
(
annotation
)
;
}
let
mut
file
=
BufWriter
:
:
new
(
File
:
:
create
(
&
crash_ping_file
)
.
unwrap
(
)
)
;
writeln
!
(
&
mut
file
"
static
PING_ANNOTATIONS
:
phf
:
:
Set
<
&
'
static
str
>
=
{
}
;
"
phf_set
.
build
(
)
)
.
unwrap
(
)
;
}
fn
set_mock_cfg
(
)
{
println
!
(
"
cargo
:
rustc
-
check
-
cfg
=
cfg
(
mock
)
"
)
;
if
env
:
:
var_os
(
"
CARGO_FEATURE_MOCK
"
)
.
is_some
(
)
|
|
mozbuild
:
:
config
:
:
MOZ_CRASHREPORTER_MOCK
{
println
!
(
"
cargo
:
rustc
-
cfg
=
mock
"
)
;
}
}
fn
set_glean_metrics_file
(
)
{
let
full_path
=
Path
:
:
new
(
env
!
(
"
CARGO_MANIFEST_DIR
"
)
)
;
let
relative_path
=
full_path
.
strip_prefix
(
mozbuild
:
:
TOPSRCDIR
)
.
expect
(
"
CARGO_MANIFEST_DIR
not
a
child
of
TOPSRCDIR
"
)
;
let
glean_metrics_path
=
{
let
mut
p
=
mozbuild
:
:
TOPOBJDIR
.
join
(
relative_path
)
;
p
.
push
(
"
glean_metrics
.
rs
"
)
;
p
}
;
println
!
(
"
cargo
:
rustc
-
env
=
GLEAN_METRICS_FILE
=
{
}
"
glean_metrics_path
.
display
(
)
)
;
}
