#
ifndef
js_ProfilingSources_h
#
define
js_ProfilingSources_h
#
include
"
mozilla
/
Variant
.
h
"
#
include
<
stdint
.
h
>
#
include
"
jstypes
.
h
"
#
include
"
js
/
TypeDecls
.
h
"
#
include
"
js
/
Utility
.
h
"
#
include
"
js
/
Vector
.
h
"
struct
JS_PUBLIC_API
ProfilerJSSourceData
{
public
:
struct
SourceTextUTF16
{
public
:
SourceTextUTF16
(
JS
:
:
UniqueTwoByteChars
&
&
c
size_t
l
)
:
chars_
(
std
:
:
move
(
c
)
)
length_
(
l
)
{
}
const
JS
:
:
UniqueTwoByteChars
&
chars
(
)
const
{
return
chars_
;
}
size_t
length
(
)
const
{
return
length_
;
}
private
:
JS
:
:
UniqueTwoByteChars
chars_
;
size_t
length_
;
}
;
struct
SourceTextUTF8
{
public
:
SourceTextUTF8
(
JS
:
:
UniqueChars
&
&
c
size_t
l
)
:
chars_
(
std
:
:
move
(
c
)
)
length_
(
l
)
{
}
const
JS
:
:
UniqueChars
&
chars
(
)
const
{
return
chars_
;
}
size_t
length
(
)
const
{
return
length_
;
}
private
:
JS
:
:
UniqueChars
chars_
;
size_t
length_
;
}
;
struct
RetrievableFile
{
}
;
struct
Unavailable
{
}
;
using
ProfilerSourceVariant
=
mozilla
:
:
Variant
<
SourceTextUTF16
SourceTextUTF8
RetrievableFile
Unavailable
>
;
ProfilerJSSourceData
(
uint32_t
sourceId
JS
:
:
UniqueChars
&
&
filePath
size_t
pathLen
)
:
sourceId_
(
sourceId
)
filePath_
(
std
:
:
move
(
filePath
)
)
filePathLength_
(
pathLen
)
data_
(
Unavailable
{
}
)
{
}
ProfilerJSSourceData
(
uint32_t
sourceId
JS
:
:
UniqueChars
&
&
chars
size_t
length
JS
:
:
UniqueChars
&
&
filePath
size_t
pathLen
)
:
sourceId_
(
sourceId
)
filePath_
(
std
:
:
move
(
filePath
)
)
filePathLength_
(
pathLen
)
data_
(
SourceTextUTF8
{
std
:
:
move
(
chars
)
length
}
)
{
}
ProfilerJSSourceData
(
uint32_t
sourceId
JS
:
:
UniqueTwoByteChars
&
&
chars
size_t
length
JS
:
:
UniqueChars
&
&
filePath
size_t
pathLen
)
:
sourceId_
(
sourceId
)
filePath_
(
std
:
:
move
(
filePath
)
)
filePathLength_
(
pathLen
)
data_
(
SourceTextUTF16
{
std
:
:
move
(
chars
)
length
}
)
{
}
ProfilerJSSourceData
(
JS
:
:
UniqueChars
&
&
chars
size_t
length
)
:
sourceId_
(
0
)
filePath_
(
nullptr
)
filePathLength_
(
0
)
data_
(
SourceTextUTF8
{
std
:
:
move
(
chars
)
length
}
)
{
}
ProfilerJSSourceData
(
)
:
sourceId_
(
0
)
filePathLength_
(
0
)
data_
(
Unavailable
{
}
)
{
}
static
ProfilerJSSourceData
CreateRetrievableFile
(
uint32_t
sourceId
JS
:
:
UniqueChars
&
&
filePath
size_t
pathLength
)
{
ProfilerJSSourceData
result
(
sourceId
std
:
:
move
(
filePath
)
pathLength
)
;
result
.
data_
.
emplace
<
RetrievableFile
>
(
)
;
return
result
;
}
ProfilerJSSourceData
(
ProfilerJSSourceData
&
&
)
=
default
;
ProfilerJSSourceData
&
operator
=
(
ProfilerJSSourceData
&
&
)
=
default
;
ProfilerJSSourceData
(
const
ProfilerJSSourceData
&
other
)
=
delete
;
ProfilerJSSourceData
&
operator
=
(
const
ProfilerJSSourceData
&
)
=
delete
;
uint32_t
sourceId
(
)
const
{
return
sourceId_
;
}
const
char
*
filePath
(
)
const
{
MOZ_ASSERT
(
filePath_
)
;
return
filePath_
.
get
(
)
;
}
size_t
filePathLength
(
)
const
{
return
filePathLength_
;
}
const
ProfilerSourceVariant
&
data
(
)
const
{
return
data_
;
}
size_t
SizeOf
(
)
const
{
size_t
size
=
sizeof
(
uint32_t
)
+
filePathLength_
*
sizeof
(
char
)
;
data_
.
match
(
[
&
]
(
const
SourceTextUTF16
&
srcText
)
{
size
+
=
srcText
.
length
(
)
*
sizeof
(
char16_t
)
;
}
[
&
]
(
const
SourceTextUTF8
&
srcText
)
{
size
+
=
srcText
.
length
(
)
*
sizeof
(
char
)
;
}
[
]
(
const
RetrievableFile
&
)
{
}
[
]
(
const
Unavailable
&
)
{
}
)
;
return
size
;
}
private
:
uint32_t
sourceId_
;
JS
:
:
UniqueChars
filePath_
;
size_t
filePathLength_
;
ProfilerSourceVariant
data_
;
}
;
namespace
js
{
using
ProfilerJSSources
=
js
:
:
Vector
<
ProfilerJSSourceData
0
js
:
:
SystemAllocPolicy
>
;
JS_PUBLIC_API
ProfilerJSSources
GetProfilerScriptSources
(
JSRuntime
*
rt
)
;
JS_PUBLIC_API
ProfilerJSSourceData
RetrieveProfilerSourceContent
(
JSContext
*
cx
const
char
*
filename
)
;
}
#
endif
