#
ifndef
js_StructuredClone_h
#
define
js_StructuredClone_h
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
BufferList
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
<
stdint
.
h
>
#
include
"
jstypes
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
js
/
TypeDecls
.
h
"
#
include
"
js
/
Value
.
h
"
#
include
"
js
/
Vector
.
h
"
struct
JSStructuredCloneReader
;
struct
JSStructuredCloneWriter
;
#
define
JS_STRUCTURED_CLONE_VERSION
8
namespace
JS
{
enum
class
StructuredCloneScope
:
uint32_t
{
SameProcessSameThread
SameProcessDifferentThread
DifferentProcess
}
;
enum
TransferableOwnership
{
SCTAG_TMO_UNFILLED
=
0
SCTAG_TMO_UNOWNED
=
1
SCTAG_TMO_FIRST_OWNED
=
2
SCTAG_TMO_ALLOC_DATA
=
2
SCTAG_TMO_MAPPED_DATA
=
3
SCTAG_TMO_CUSTOM
=
4
SCTAG_TMO_USER_MIN
}
;
class
CloneDataPolicy
{
bool
sharedArrayBuffer_
;
public
:
CloneDataPolicy
(
)
:
sharedArrayBuffer_
(
true
)
{
}
CloneDataPolicy
&
denySharedArrayBuffer
(
)
{
sharedArrayBuffer_
=
false
;
return
*
this
;
}
bool
isSharedArrayBufferAllowed
(
)
const
{
return
sharedArrayBuffer_
;
}
}
;
}
typedef
JSObject
*
(
*
ReadStructuredCloneOp
)
(
JSContext
*
cx
JSStructuredCloneReader
*
r
uint32_t
tag
uint32_t
data
void
*
closure
)
;
typedef
bool
(
*
WriteStructuredCloneOp
)
(
JSContext
*
cx
JSStructuredCloneWriter
*
w
JS
:
:
HandleObject
obj
void
*
closure
)
;
typedef
void
(
*
StructuredCloneErrorOp
)
(
JSContext
*
cx
uint32_t
errorid
)
;
typedef
bool
(
*
ReadTransferStructuredCloneOp
)
(
JSContext
*
cx
JSStructuredCloneReader
*
r
uint32_t
tag
void
*
content
uint64_t
extraData
void
*
closure
JS
:
:
MutableHandleObject
returnObject
)
;
typedef
bool
(
*
TransferStructuredCloneOp
)
(
JSContext
*
cx
JS
:
:
Handle
<
JSObject
*
>
obj
void
*
closure
uint32_t
*
tag
JS
:
:
TransferableOwnership
*
ownership
void
*
*
content
uint64_t
*
extraData
)
;
typedef
void
(
*
FreeTransferStructuredCloneOp
)
(
uint32_t
tag
JS
:
:
TransferableOwnership
ownership
void
*
content
uint64_t
extraData
void
*
closure
)
;
typedef
bool
(
*
CanTransferStructuredCloneOp
)
(
JSContext
*
cx
JS
:
:
Handle
<
JSObject
*
>
obj
void
*
closure
)
;
struct
JSStructuredCloneCallbacks
{
ReadStructuredCloneOp
read
;
WriteStructuredCloneOp
write
;
StructuredCloneErrorOp
reportError
;
ReadTransferStructuredCloneOp
readTransfer
;
TransferStructuredCloneOp
writeTransfer
;
FreeTransferStructuredCloneOp
freeTransfer
;
CanTransferStructuredCloneOp
canTransfer
;
}
;
enum
OwnTransferablePolicy
{
OwnsTransferablesIfAny
IgnoreTransferablesIfAny
NoTransferables
}
;
namespace
js
{
class
SharedArrayRawBuffer
;
class
SharedArrayRawBufferRefs
{
public
:
SharedArrayRawBufferRefs
(
)
=
default
;
SharedArrayRawBufferRefs
(
SharedArrayRawBufferRefs
&
&
other
)
=
default
;
SharedArrayRawBufferRefs
&
operator
=
(
SharedArrayRawBufferRefs
&
&
other
)
;
~
SharedArrayRawBufferRefs
(
)
;
MOZ_MUST_USE
bool
acquire
(
JSContext
*
cx
SharedArrayRawBuffer
*
rawbuf
)
;
MOZ_MUST_USE
bool
acquireAll
(
JSContext
*
cx
const
SharedArrayRawBufferRefs
&
that
)
;
void
takeOwnership
(
SharedArrayRawBufferRefs
&
&
)
;
void
releaseAll
(
)
;
private
:
js
:
:
Vector
<
js
:
:
SharedArrayRawBuffer
*
0
js
:
:
SystemAllocPolicy
>
refs_
;
}
;
}
class
MOZ_NON_MEMMOVABLE
JS_PUBLIC_API
(
JSStructuredCloneData
)
:
public
mozilla
:
:
BufferList
<
js
:
:
SystemAllocPolicy
>
{
typedef
js
:
:
SystemAllocPolicy
AllocPolicy
;
typedef
mozilla
:
:
BufferList
<
js
:
:
SystemAllocPolicy
>
BufferList
;
static
const
size_t
kInitialSize
=
0
;
static
const
size_t
kInitialCapacity
=
4096
;
static
const
size_t
kStandardCapacity
=
4096
;
const
JSStructuredCloneCallbacks
*
callbacks_
=
nullptr
;
void
*
closure_
=
nullptr
;
OwnTransferablePolicy
ownTransferables_
=
OwnTransferablePolicy
:
:
NoTransferables
;
js
:
:
SharedArrayRawBufferRefs
refsHeld_
;
friend
struct
JSStructuredCloneWriter
;
friend
class
JS_PUBLIC_API
(
JSAutoStructuredCloneBuffer
)
;
public
:
explicit
JSStructuredCloneData
(
AllocPolicy
aAP
=
AllocPolicy
(
)
)
:
BufferList
(
kInitialSize
kInitialCapacity
kStandardCapacity
aAP
)
callbacks_
(
nullptr
)
closure_
(
nullptr
)
ownTransferables_
(
OwnTransferablePolicy
:
:
NoTransferables
)
{
}
MOZ_IMPLICIT
JSStructuredCloneData
(
BufferList
&
&
buffers
)
:
BufferList
(
Move
(
buffers
)
)
callbacks_
(
nullptr
)
closure_
(
nullptr
)
ownTransferables_
(
OwnTransferablePolicy
:
:
NoTransferables
)
{
}
JSStructuredCloneData
(
JSStructuredCloneData
&
&
other
)
=
default
;
JSStructuredCloneData
&
operator
=
(
JSStructuredCloneData
&
&
other
)
=
default
;
~
JSStructuredCloneData
(
)
{
discardTransferables
(
)
;
}
void
setCallbacks
(
const
JSStructuredCloneCallbacks
*
callbacks
void
*
closure
OwnTransferablePolicy
policy
)
{
callbacks_
=
callbacks
;
closure_
=
closure
;
ownTransferables_
=
policy
;
}
void
discardTransferables
(
)
;
using
BufferList
:
:
BufferList
;
}
;
JS_PUBLIC_API
(
bool
)
JS_ReadStructuredClone
(
JSContext
*
cx
JSStructuredCloneData
&
data
uint32_t
version
JS
:
:
StructuredCloneScope
scope
JS
:
:
MutableHandleValue
vp
const
JSStructuredCloneCallbacks
*
optionalCallbacks
void
*
closure
)
;
JS_PUBLIC_API
(
bool
)
JS_WriteStructuredClone
(
JSContext
*
cx
JS
:
:
HandleValue
v
JSStructuredCloneData
*
data
JS
:
:
StructuredCloneScope
scope
JS
:
:
CloneDataPolicy
cloneDataPolicy
const
JSStructuredCloneCallbacks
*
optionalCallbacks
void
*
closure
JS
:
:
HandleValue
transferable
)
;
JS_PUBLIC_API
(
bool
)
JS_StructuredCloneHasTransferables
(
JSStructuredCloneData
&
data
bool
*
hasTransferable
)
;
JS_PUBLIC_API
(
bool
)
JS_StructuredClone
(
JSContext
*
cx
JS
:
:
HandleValue
v
JS
:
:
MutableHandleValue
vp
const
JSStructuredCloneCallbacks
*
optionalCallbacks
void
*
closure
)
;
class
JS_PUBLIC_API
(
JSAutoStructuredCloneBuffer
)
{
const
JS
:
:
StructuredCloneScope
scope_
;
JSStructuredCloneData
data_
;
uint32_t
version_
;
public
:
JSAutoStructuredCloneBuffer
(
JS
:
:
StructuredCloneScope
scope
const
JSStructuredCloneCallbacks
*
callbacks
void
*
closure
)
:
scope_
(
scope
)
version_
(
JS_STRUCTURED_CLONE_VERSION
)
{
data_
.
setCallbacks
(
callbacks
closure
OwnTransferablePolicy
:
:
NoTransferables
)
;
}
JSAutoStructuredCloneBuffer
(
JSAutoStructuredCloneBuffer
&
&
other
)
;
JSAutoStructuredCloneBuffer
&
operator
=
(
JSAutoStructuredCloneBuffer
&
&
other
)
;
~
JSAutoStructuredCloneBuffer
(
)
{
clear
(
)
;
}
JSStructuredCloneData
&
data
(
)
{
return
data_
;
}
bool
empty
(
)
const
{
return
!
data_
.
Size
(
)
;
}
void
clear
(
)
;
bool
copy
(
JSContext
*
cx
const
JSStructuredCloneData
&
data
uint32_t
version
=
JS_STRUCTURED_CLONE_VERSION
const
JSStructuredCloneCallbacks
*
callbacks
=
nullptr
void
*
closure
=
nullptr
)
;
void
adopt
(
JSStructuredCloneData
&
&
data
uint32_t
version
=
JS_STRUCTURED_CLONE_VERSION
const
JSStructuredCloneCallbacks
*
callbacks
=
nullptr
void
*
closure
=
nullptr
)
;
void
steal
(
JSStructuredCloneData
*
data
uint32_t
*
versionp
=
nullptr
const
JSStructuredCloneCallbacks
*
*
callbacks
=
nullptr
void
*
*
closure
=
nullptr
)
;
void
abandon
(
)
{
data_
.
ownTransferables_
=
OwnTransferablePolicy
:
:
IgnoreTransferablesIfAny
;
}
bool
read
(
JSContext
*
cx
JS
:
:
MutableHandleValue
vp
const
JSStructuredCloneCallbacks
*
optionalCallbacks
=
nullptr
void
*
closure
=
nullptr
)
;
bool
write
(
JSContext
*
cx
JS
:
:
HandleValue
v
const
JSStructuredCloneCallbacks
*
optionalCallbacks
=
nullptr
void
*
closure
=
nullptr
)
;
bool
write
(
JSContext
*
cx
JS
:
:
HandleValue
v
JS
:
:
HandleValue
transferable
JS
:
:
CloneDataPolicy
cloneDataPolicy
const
JSStructuredCloneCallbacks
*
optionalCallbacks
=
nullptr
void
*
closure
=
nullptr
)
;
size_t
sizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
{
return
data_
.
SizeOfExcludingThis
(
mallocSizeOf
)
;
}
size_t
sizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
{
return
mallocSizeOf
(
this
)
+
sizeOfExcludingThis
(
mallocSizeOf
)
;
}
private
:
JSAutoStructuredCloneBuffer
(
const
JSAutoStructuredCloneBuffer
&
other
)
=
delete
;
JSAutoStructuredCloneBuffer
&
operator
=
(
const
JSAutoStructuredCloneBuffer
&
other
)
=
delete
;
}
;
#
define
JS_SCTAG_USER_MIN
(
(
uint32_t
)
0xFFFF8000
)
#
define
JS_SCTAG_USER_MAX
(
(
uint32_t
)
0xFFFFFFFF
)
#
define
JS_SCERR_RECURSION
0
#
define
JS_SCERR_TRANSFERABLE
1
#
define
JS_SCERR_DUP_TRANSFERABLE
2
#
define
JS_SCERR_UNSUPPORTED_TYPE
3
#
define
JS_SCERR_SHMEM_TRANSFERABLE
4
JS_PUBLIC_API
(
bool
)
JS_ReadUint32Pair
(
JSStructuredCloneReader
*
r
uint32_t
*
p1
uint32_t
*
p2
)
;
JS_PUBLIC_API
(
bool
)
JS_ReadBytes
(
JSStructuredCloneReader
*
r
void
*
p
size_t
len
)
;
JS_PUBLIC_API
(
bool
)
JS_ReadTypedArray
(
JSStructuredCloneReader
*
r
JS
:
:
MutableHandleValue
vp
)
;
JS_PUBLIC_API
(
bool
)
JS_WriteUint32Pair
(
JSStructuredCloneWriter
*
w
uint32_t
tag
uint32_t
data
)
;
JS_PUBLIC_API
(
bool
)
JS_WriteBytes
(
JSStructuredCloneWriter
*
w
const
void
*
p
size_t
len
)
;
JS_PUBLIC_API
(
bool
)
JS_WriteString
(
JSStructuredCloneWriter
*
w
JS
:
:
HandleString
str
)
;
JS_PUBLIC_API
(
bool
)
JS_WriteTypedArray
(
JSStructuredCloneWriter
*
w
JS
:
:
HandleValue
v
)
;
JS_PUBLIC_API
(
bool
)
JS_ObjectNotWritten
(
JSStructuredCloneWriter
*
w
JS
:
:
HandleObject
obj
)
;
JS_PUBLIC_API
(
JS
:
:
StructuredCloneScope
)
JS_GetStructuredCloneScope
(
JSStructuredCloneWriter
*
w
)
;
#
endif
