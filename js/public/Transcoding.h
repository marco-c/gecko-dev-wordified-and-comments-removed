#
ifndef
js_Transcoding_h
#
define
js_Transcoding_h
#
include
"
mozilla
/
Range
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
"
js
/
TypeDecls
.
h
"
namespace
JS
{
class
ReadOnlyCompileOptions
;
using
TranscodeBuffer
=
mozilla
:
:
Vector
<
uint8_t
>
;
using
TranscodeRange
=
mozilla
:
:
Range
<
const
uint8_t
>
;
struct
TranscodeSource
final
{
TranscodeSource
(
const
TranscodeRange
&
range_
const
char
*
file
uint32_t
line
)
:
range
(
range_
)
filename
(
file
)
lineno
(
line
)
{
}
const
TranscodeRange
range
;
const
char
*
filename
;
const
uint32_t
lineno
;
}
;
using
TranscodeSources
=
mozilla
:
:
Vector
<
TranscodeSource
>
;
enum
class
TranscodeResult
:
uint8_t
{
Ok
=
0
Failure
=
0x10
Failure_BadBuildId
=
Failure
|
0x1
Failure_AsmJSNotSupported
=
Failure
|
0x2
Failure_BadDecode
=
Failure
|
0x3
Throw
=
0x20
}
;
inline
bool
IsTranscodeFailureResult
(
const
TranscodeResult
result
)
{
uint8_t
raw_result
=
static_cast
<
uint8_t
>
(
result
)
;
uint8_t
raw_failure
=
static_cast
<
uint8_t
>
(
TranscodeResult
:
:
Failure
)
;
TranscodeResult
masked
=
static_cast
<
TranscodeResult
>
(
raw_result
&
raw_failure
)
;
return
masked
=
=
TranscodeResult
:
:
Failure
;
}
static
constexpr
size_t
BytecodeOffsetAlignment
=
4
;
static_assert
(
BytecodeOffsetAlignment
<
=
alignof
(
std
:
:
max_align_t
)
"
Alignment
condition
requires
a
custom
allocator
.
"
)
;
inline
size_t
AlignTranscodingBytecodeOffset
(
size_t
offset
)
{
size_t
extra
=
offset
%
BytecodeOffsetAlignment
;
if
(
extra
=
=
0
)
{
return
offset
;
}
size_t
padding
=
BytecodeOffsetAlignment
-
extra
;
return
offset
+
padding
;
}
inline
bool
IsTranscodingBytecodeOffsetAligned
(
size_t
offset
)
{
return
offset
%
BytecodeOffsetAlignment
=
=
0
;
}
inline
bool
IsTranscodingBytecodeAligned
(
const
void
*
offset
)
{
return
IsTranscodingBytecodeOffsetAligned
(
size_t
(
offset
)
)
;
}
extern
JS_PUBLIC_API
bool
FinishIncrementalEncoding
(
JSContext
*
cx
Handle
<
JSScript
*
>
script
TranscodeBuffer
&
buffer
)
;
extern
JS_PUBLIC_API
bool
FinishIncrementalEncoding
(
JSContext
*
cx
Handle
<
JSObject
*
>
module
TranscodeBuffer
&
buffer
)
;
extern
JS_PUBLIC_API
bool
CheckCompileOptionsMatch
(
const
ReadOnlyCompileOptions
&
options
JSScript
*
script
)
;
}
#
endif
