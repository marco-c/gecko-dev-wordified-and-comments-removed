#
ifndef
js_experimental_JSStencil_h
#
define
js_experimental_JSStencil_h
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
Utf8
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
#
include
<
stddef
.
h
>
#
include
"
jstypes
.
h
"
#
include
"
js
/
CompileOptions
.
h
"
#
include
"
js
/
OffThreadScriptCompilation
.
h
"
#
include
"
js
/
SourceText
.
h
"
#
include
"
js
/
Transcoding
.
h
"
struct
JS_PUBLIC_API
JSContext
;
class
JS_PUBLIC_API
JSTracer
;
namespace
js
{
struct
ParseTask
;
class
FrontendContext
;
namespace
frontend
{
struct
CompilationStencil
;
struct
CompilationGCOutput
;
struct
CompilationInput
;
struct
PreallocatedCompilationGCOutput
;
}
}
namespace
JS
{
struct
CompilationStorage
;
using
Stencil
=
js
:
:
frontend
:
:
CompilationStencil
;
using
FrontendContext
=
js
:
:
FrontendContext
;
struct
InstantiationStorage
{
private
:
js
:
:
frontend
:
:
PreallocatedCompilationGCOutput
*
gcOutput_
=
nullptr
;
friend
JS_PUBLIC_API
JSScript
*
InstantiateGlobalStencil
(
JSContext
*
cx
const
InstantiateOptions
&
options
Stencil
*
stencil
InstantiationStorage
*
storage
)
;
friend
JS_PUBLIC_API
JSObject
*
InstantiateModuleStencil
(
JSContext
*
cx
const
InstantiateOptions
&
options
Stencil
*
stencil
InstantiationStorage
*
storage
)
;
friend
JS_PUBLIC_API
bool
PrepareForInstantiate
(
JS
:
:
FrontendContext
*
fc
JS
:
:
Stencil
&
stencil
JS
:
:
InstantiationStorage
&
storage
)
;
friend
struct
js
:
:
ParseTask
;
public
:
InstantiationStorage
(
)
=
default
;
InstantiationStorage
(
InstantiationStorage
&
&
other
)
:
gcOutput_
(
other
.
gcOutput_
)
{
other
.
gcOutput_
=
nullptr
;
}
~
InstantiationStorage
(
)
;
void
operator
=
(
InstantiationStorage
&
&
other
)
{
gcOutput_
=
other
.
gcOutput_
;
other
.
gcOutput_
=
nullptr
;
}
private
:
InstantiationStorage
(
const
InstantiationStorage
&
other
)
=
delete
;
void
operator
=
(
const
InstantiationStorage
&
aOther
)
=
delete
;
public
:
bool
isValid
(
)
const
{
return
!
!
gcOutput_
;
}
}
;
}
namespace
JS
{
JS_PUBLIC_API
void
StencilAddRef
(
Stencil
*
stencil
)
;
JS_PUBLIC_API
void
StencilRelease
(
Stencil
*
stencil
)
;
}
namespace
mozilla
{
template
<
>
struct
RefPtrTraits
<
JS
:
:
Stencil
>
{
static
void
AddRef
(
JS
:
:
Stencil
*
stencil
)
{
JS
:
:
StencilAddRef
(
stencil
)
;
}
static
void
Release
(
JS
:
:
Stencil
*
stencil
)
{
JS
:
:
StencilRelease
(
stencil
)
;
}
}
;
}
namespace
JS
{
extern
JS_PUBLIC_API
bool
StencilIsBorrowed
(
Stencil
*
stencil
)
;
extern
JS_PUBLIC_API
size_t
SizeOfStencil
(
Stencil
*
stencil
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
;
}
namespace
JS
{
extern
JS_PUBLIC_API
already_AddRefed
<
Stencil
>
CompileGlobalScriptToStencil
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
mozilla
:
:
Utf8Unit
>
&
srcBuf
)
;
extern
JS_PUBLIC_API
already_AddRefed
<
Stencil
>
CompileGlobalScriptToStencil
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
char16_t
>
&
srcBuf
)
;
extern
JS_PUBLIC_API
already_AddRefed
<
Stencil
>
CompileModuleScriptToStencil
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
mozilla
:
:
Utf8Unit
>
&
srcBuf
)
;
extern
JS_PUBLIC_API
already_AddRefed
<
Stencil
>
CompileModuleScriptToStencil
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
char16_t
>
&
srcBuf
)
;
}
namespace
JS
{
extern
JS_PUBLIC_API
JSScript
*
InstantiateGlobalStencil
(
JSContext
*
cx
const
InstantiateOptions
&
options
Stencil
*
stencil
InstantiationStorage
*
storage
=
nullptr
)
;
extern
JS_PUBLIC_API
JSObject
*
InstantiateModuleStencil
(
JSContext
*
cx
const
InstantiateOptions
&
options
Stencil
*
stencil
InstantiationStorage
*
storage
=
nullptr
)
;
}
namespace
JS
{
class
OffThreadToken
;
extern
JS_PUBLIC_API
TranscodeResult
EncodeStencil
(
JSContext
*
cx
Stencil
*
stencil
TranscodeBuffer
&
buffer
)
;
extern
JS_PUBLIC_API
TranscodeResult
DecodeStencil
(
JSContext
*
cx
const
ReadOnlyDecodeOptions
&
options
const
TranscodeRange
&
range
Stencil
*
*
stencilOut
)
;
extern
JS_PUBLIC_API
TranscodeResult
DecodeStencil
(
JS
:
:
FrontendContext
*
fc
const
ReadOnlyDecodeOptions
&
options
const
TranscodeRange
&
range
Stencil
*
*
stencilOut
)
;
extern
JS_PUBLIC_API
bool
StartIncrementalEncoding
(
JSContext
*
cx
RefPtr
<
Stencil
>
&
&
stencil
)
;
}
namespace
JS
{
extern
JS_PUBLIC_API
OffThreadToken
*
CompileToStencilOffThread
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
char16_t
>
&
srcBuf
OffThreadCompileCallback
callback
void
*
callbackData
)
;
extern
JS_PUBLIC_API
OffThreadToken
*
CompileToStencilOffThread
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
mozilla
:
:
Utf8Unit
>
&
srcBuf
OffThreadCompileCallback
callback
void
*
callbackData
)
;
extern
JS_PUBLIC_API
OffThreadToken
*
CompileModuleToStencilOffThread
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
char16_t
>
&
srcBuf
OffThreadCompileCallback
callback
void
*
callbackData
)
;
extern
JS_PUBLIC_API
OffThreadToken
*
CompileModuleToStencilOffThread
(
JSContext
*
cx
const
ReadOnlyCompileOptions
&
options
SourceText
<
mozilla
:
:
Utf8Unit
>
&
srcBuf
OffThreadCompileCallback
callback
void
*
callbackData
)
;
extern
JS_PUBLIC_API
OffThreadToken
*
DecodeStencilOffThread
(
JSContext
*
cx
const
ReadOnlyDecodeOptions
&
options
const
TranscodeBuffer
&
buffer
size_t
cursor
OffThreadCompileCallback
callback
void
*
callbackData
)
;
extern
JS_PUBLIC_API
OffThreadToken
*
DecodeStencilOffThread
(
JSContext
*
cx
const
ReadOnlyDecodeOptions
&
options
const
TranscodeRange
&
range
OffThreadCompileCallback
callback
void
*
callbackData
)
;
extern
JS_PUBLIC_API
already_AddRefed
<
Stencil
>
FinishOffThreadStencil
(
JSContext
*
cx
OffThreadToken
*
token
InstantiationStorage
*
storage
=
nullptr
)
;
extern
JS_PUBLIC_API
void
CancelOffThreadToken
(
JSContext
*
cx
OffThreadToken
*
token
)
;
}
#
endif
