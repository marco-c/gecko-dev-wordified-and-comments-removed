#
ifndef
js_SliceBudget_h
#
define
js_SliceBudget_h
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
<
stdint
.
h
>
#
include
"
jstypes
.
h
"
namespace
js
{
struct
JS_PUBLIC_API
(
TimeBudget
)
{
int64_t
budget
;
explicit
TimeBudget
(
int64_t
milliseconds
)
{
budget
=
milliseconds
;
}
}
;
struct
JS_PUBLIC_API
(
WorkBudget
)
{
int64_t
budget
;
explicit
WorkBudget
(
int64_t
work
)
{
budget
=
work
;
}
}
;
class
JS_PUBLIC_API
(
SliceBudget
)
{
const
mozilla
:
:
TimeStamp
&
UnlimitedDeadline
(
)
const
{
static
const
mozilla
:
:
TimeStamp
unlimitedDeadline
=
mozilla
:
:
TimeStamp
:
:
Now
(
)
+
mozilla
:
:
TimeDuration
:
:
Forever
(
)
;
return
unlimitedDeadline
;
}
static
const
intptr_t
unlimitedStartCounter
=
INTPTR_MAX
;
bool
checkOverBudget
(
)
;
SliceBudget
(
)
;
public
:
TimeBudget
timeBudget
;
WorkBudget
workBudget
;
mozilla
:
:
TimeStamp
deadline
;
intptr_t
counter
;
static
const
intptr_t
CounterReset
=
1000
;
static
const
int64_t
UnlimitedTimeBudget
=
-
1
;
static
const
int64_t
UnlimitedWorkBudget
=
-
1
;
static
SliceBudget
unlimited
(
)
{
return
SliceBudget
(
)
;
}
explicit
SliceBudget
(
TimeBudget
time
)
;
explicit
SliceBudget
(
WorkBudget
work
)
;
void
makeUnlimited
(
)
{
deadline
=
UnlimitedDeadline
(
)
;
counter
=
unlimitedStartCounter
;
}
void
step
(
intptr_t
amt
=
1
)
{
counter
-
=
amt
;
}
bool
isOverBudget
(
)
{
if
(
counter
>
0
)
return
false
;
return
checkOverBudget
(
)
;
}
bool
isWorkBudget
(
)
const
{
return
deadline
.
IsNull
(
)
;
}
bool
isTimeBudget
(
)
const
{
return
!
deadline
.
IsNull
(
)
&
&
!
isUnlimited
(
)
;
}
bool
isUnlimited
(
)
const
{
return
deadline
=
=
UnlimitedDeadline
(
)
;
}
int
describe
(
char
*
buffer
size_t
maxlen
)
const
;
}
;
}
#
endif
