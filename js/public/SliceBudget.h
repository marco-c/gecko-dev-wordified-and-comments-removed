#
ifndef
js_SliceBudget_h
#
define
js_SliceBudget_h
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
Variant
.
h
"
#
include
<
stdint
.
h
>
#
include
"
jstypes
.
h
"
namespace
js
{
struct
JS_PUBLIC_API
TimeBudget
{
const
int64_t
budget
;
mozilla
:
:
TimeStamp
deadline
;
explicit
TimeBudget
(
int64_t
milliseconds
)
:
budget
(
milliseconds
)
{
}
explicit
TimeBudget
(
mozilla
:
:
TimeDuration
duration
)
:
TimeBudget
(
duration
.
ToMilliseconds
(
)
)
{
}
}
;
struct
JS_PUBLIC_API
WorkBudget
{
const
int64_t
budget
;
explicit
WorkBudget
(
int64_t
work
)
:
budget
(
work
)
{
}
}
;
struct
UnlimitedBudget
{
}
;
class
JS_PUBLIC_API
SliceBudget
{
static
const
intptr_t
UnlimitedCounter
=
INTPTR_MAX
;
static
const
intptr_t
DefaultStepsPerTimeCheck
=
1000
;
mozilla
:
:
Variant
<
TimeBudget
WorkBudget
UnlimitedBudget
>
budget
;
int64_t
stepsPerTimeCheck
=
DefaultStepsPerTimeCheck
;
int64_t
counter
;
SliceBudget
(
)
:
budget
(
UnlimitedBudget
(
)
)
counter
(
UnlimitedCounter
)
{
}
bool
checkOverBudget
(
)
;
public
:
static
SliceBudget
unlimited
(
)
{
return
SliceBudget
(
)
;
}
explicit
SliceBudget
(
TimeBudget
time
int64_t
stepsPerTimeCheck
=
DefaultStepsPerTimeCheck
)
;
explicit
SliceBudget
(
WorkBudget
work
)
;
explicit
SliceBudget
(
mozilla
:
:
TimeDuration
time
)
:
SliceBudget
(
TimeBudget
(
time
.
ToMilliseconds
(
)
)
)
{
}
void
step
(
uint64_t
steps
=
1
)
{
MOZ_ASSERT
(
steps
>
0
)
;
counter
-
=
steps
;
}
void
stepAndForceCheck
(
)
{
if
(
!
isUnlimited
(
)
)
{
counter
=
0
;
}
}
bool
isOverBudget
(
)
{
return
counter
<
=
0
&
&
checkOverBudget
(
)
;
}
bool
isWorkBudget
(
)
const
{
return
budget
.
is
<
WorkBudget
>
(
)
;
}
bool
isTimeBudget
(
)
const
{
return
budget
.
is
<
TimeBudget
>
(
)
;
}
bool
isUnlimited
(
)
const
{
return
budget
.
is
<
UnlimitedBudget
>
(
)
;
}
int64_t
timeBudget
(
)
const
{
return
budget
.
as
<
TimeBudget
>
(
)
.
budget
;
}
int64_t
workBudget
(
)
const
{
return
budget
.
as
<
WorkBudget
>
(
)
.
budget
;
}
mozilla
:
:
TimeStamp
deadline
(
)
const
{
return
budget
.
as
<
TimeBudget
>
(
)
.
deadline
;
}
int
describe
(
char
*
buffer
size_t
maxlen
)
const
;
}
;
}
#
endif
