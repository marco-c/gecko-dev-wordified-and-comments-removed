#
ifndef
js_PropertyDescriptor_h
#
define
js_PropertyDescriptor_h
#
include
"
mozilla
/
Assertions
.
h
"
#
include
<
stdint
.
h
>
#
include
"
jstypes
.
h
"
#
include
"
js
/
Class
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
js
/
Value
.
h
"
struct
JS_PUBLIC_API
JSContext
;
class
JS_PUBLIC_API
JSObject
;
class
JS_PUBLIC_API
JSTracer
;
static
constexpr
uint8_t
JSPROP_ENUMERATE
=
0x01
;
static
constexpr
uint8_t
JSPROP_READONLY
=
0x02
;
static
constexpr
uint8_t
JSPROP_PERMANENT
=
0x04
;
static
constexpr
uint8_t
JSPROP_CUSTOM_DATA_PROP
=
0x08
;
static
constexpr
uint8_t
JSPROP_GETTER
=
0x10
;
static
constexpr
uint8_t
JSPROP_SETTER
=
0x20
;
static
constexpr
unsigned
JSPROP_RESOLVING
=
0x2000
;
static
constexpr
unsigned
JSPROP_IGNORE_ENUMERATE
=
0x4000
;
static
constexpr
unsigned
JSPROP_IGNORE_READONLY
=
0x8000
;
static
constexpr
unsigned
JSPROP_IGNORE_PERMANENT
=
0x10000
;
static
constexpr
unsigned
JSPROP_IGNORE_VALUE
=
0x20000
;
static
constexpr
unsigned
JSPROP_FLAGS_MASK
=
JSPROP_ENUMERATE
|
JSPROP_READONLY
|
JSPROP_PERMANENT
|
JSPROP_CUSTOM_DATA_PROP
|
JSPROP_GETTER
|
JSPROP_SETTER
|
JSPROP_RESOLVING
|
JSPROP_IGNORE_ENUMERATE
|
JSPROP_IGNORE_READONLY
|
JSPROP_IGNORE_PERMANENT
|
JSPROP_IGNORE_VALUE
;
namespace
JS
{
struct
JS_PUBLIC_API
PropertyDescriptor
{
JSObject
*
obj
=
nullptr
;
unsigned
attrs
=
0
;
JSObject
*
getter
=
nullptr
;
JSObject
*
setter
=
nullptr
;
Value
value
;
PropertyDescriptor
(
)
=
default
;
void
trace
(
JSTracer
*
trc
)
;
}
;
}
namespace
js
{
template
<
typename
Wrapper
>
class
WrappedPtrOperations
<
JS
:
:
PropertyDescriptor
Wrapper
>
{
const
JS
:
:
PropertyDescriptor
&
desc
(
)
const
{
return
static_cast
<
const
Wrapper
*
>
(
this
)
-
>
get
(
)
;
}
bool
has
(
unsigned
bit
)
const
{
MOZ_ASSERT
(
bit
!
=
0
)
;
MOZ_ASSERT
(
(
bit
&
(
bit
-
1
)
)
=
=
0
)
;
return
(
desc
(
)
.
attrs
&
bit
)
!
=
0
;
}
bool
hasAny
(
unsigned
bits
)
const
{
return
(
desc
(
)
.
attrs
&
bits
)
!
=
0
;
}
bool
hasAll
(
unsigned
bits
)
const
{
return
(
desc
(
)
.
attrs
&
bits
)
=
=
bits
;
}
public
:
bool
isAccessorDescriptor
(
)
const
{
return
hasAny
(
JSPROP_GETTER
|
JSPROP_SETTER
)
;
}
bool
isGenericDescriptor
(
)
const
{
return
(
desc
(
)
.
attrs
&
(
JSPROP_GETTER
|
JSPROP_SETTER
|
JSPROP_IGNORE_READONLY
|
JSPROP_IGNORE_VALUE
)
)
=
=
(
JSPROP_IGNORE_READONLY
|
JSPROP_IGNORE_VALUE
)
;
}
bool
isDataDescriptor
(
)
const
{
return
!
isAccessorDescriptor
(
)
&
&
!
isGenericDescriptor
(
)
;
}
bool
hasConfigurable
(
)
const
{
return
!
has
(
JSPROP_IGNORE_PERMANENT
)
;
}
bool
configurable
(
)
const
{
MOZ_ASSERT
(
hasConfigurable
(
)
)
;
return
!
has
(
JSPROP_PERMANENT
)
;
}
bool
hasEnumerable
(
)
const
{
return
!
has
(
JSPROP_IGNORE_ENUMERATE
)
;
}
bool
enumerable
(
)
const
{
MOZ_ASSERT
(
hasEnumerable
(
)
)
;
return
has
(
JSPROP_ENUMERATE
)
;
}
bool
hasValue
(
)
const
{
return
!
isAccessorDescriptor
(
)
&
&
!
has
(
JSPROP_IGNORE_VALUE
)
;
}
JS
:
:
HandleValue
value
(
)
const
{
return
JS
:
:
Handle
<
JS
:
:
Value
>
:
:
fromMarkedLocation
(
&
desc
(
)
.
value
)
;
}
bool
hasWritable
(
)
const
{
return
!
isAccessorDescriptor
(
)
&
&
!
has
(
JSPROP_IGNORE_READONLY
)
;
}
bool
writable
(
)
const
{
MOZ_ASSERT
(
hasWritable
(
)
)
;
return
!
has
(
JSPROP_READONLY
)
;
}
bool
hasGetterObject
(
)
const
{
return
has
(
JSPROP_GETTER
)
;
}
JS
:
:
Handle
<
JSObject
*
>
getterObject
(
)
const
{
MOZ_ASSERT
(
hasGetterObject
(
)
)
;
return
JS
:
:
Handle
<
JSObject
*
>
:
:
fromMarkedLocation
(
reinterpret_cast
<
JSObject
*
const
*
>
(
&
desc
(
)
.
getter
)
)
;
}
bool
hasSetterObject
(
)
const
{
return
has
(
JSPROP_SETTER
)
;
}
JS
:
:
Handle
<
JSObject
*
>
setterObject
(
)
const
{
MOZ_ASSERT
(
hasSetterObject
(
)
)
;
return
JS
:
:
Handle
<
JSObject
*
>
:
:
fromMarkedLocation
(
reinterpret_cast
<
JSObject
*
const
*
>
(
&
desc
(
)
.
setter
)
)
;
}
bool
hasGetterOrSetter
(
)
const
{
return
desc
(
)
.
getter
|
|
desc
(
)
.
setter
;
}
JS
:
:
Handle
<
JSObject
*
>
object
(
)
const
{
return
JS
:
:
Handle
<
JSObject
*
>
:
:
fromMarkedLocation
(
&
desc
(
)
.
obj
)
;
}
unsigned
attributes
(
)
const
{
return
desc
(
)
.
attrs
;
}
void
assertValid
(
)
const
{
#
ifdef
DEBUG
MOZ_ASSERT
(
(
attributes
(
)
&
~
(
JSPROP_ENUMERATE
|
JSPROP_IGNORE_ENUMERATE
|
JSPROP_PERMANENT
|
JSPROP_IGNORE_PERMANENT
|
JSPROP_READONLY
|
JSPROP_IGNORE_READONLY
|
JSPROP_IGNORE_VALUE
|
JSPROP_GETTER
|
JSPROP_SETTER
|
JSPROP_RESOLVING
)
)
=
=
0
)
;
MOZ_ASSERT
(
!
hasAll
(
JSPROP_IGNORE_ENUMERATE
|
JSPROP_ENUMERATE
)
)
;
MOZ_ASSERT
(
!
hasAll
(
JSPROP_IGNORE_PERMANENT
|
JSPROP_PERMANENT
)
)
;
if
(
isAccessorDescriptor
(
)
)
{
MOZ_ASSERT
(
!
has
(
JSPROP_READONLY
)
)
;
MOZ_ASSERT
(
!
has
(
JSPROP_IGNORE_READONLY
)
)
;
MOZ_ASSERT
(
!
has
(
JSPROP_IGNORE_VALUE
)
)
;
MOZ_ASSERT
(
value
(
)
.
isUndefined
(
)
)
;
MOZ_ASSERT_IF
(
!
has
(
JSPROP_GETTER
)
!
desc
(
)
.
getter
)
;
MOZ_ASSERT_IF
(
!
has
(
JSPROP_SETTER
)
!
desc
(
)
.
setter
)
;
}
else
{
MOZ_ASSERT
(
!
hasAll
(
JSPROP_IGNORE_READONLY
|
JSPROP_READONLY
)
)
;
MOZ_ASSERT_IF
(
has
(
JSPROP_IGNORE_VALUE
)
value
(
)
.
isUndefined
(
)
)
;
}
MOZ_ASSERT_IF
(
has
(
JSPROP_RESOLVING
)
!
has
(
JSPROP_IGNORE_ENUMERATE
)
)
;
MOZ_ASSERT_IF
(
has
(
JSPROP_RESOLVING
)
!
has
(
JSPROP_IGNORE_PERMANENT
)
)
;
MOZ_ASSERT_IF
(
has
(
JSPROP_RESOLVING
)
!
has
(
JSPROP_IGNORE_READONLY
)
)
;
MOZ_ASSERT_IF
(
has
(
JSPROP_RESOLVING
)
!
has
(
JSPROP_IGNORE_VALUE
)
)
;
#
endif
}
void
assertComplete
(
)
const
{
#
ifdef
DEBUG
assertValid
(
)
;
MOZ_ASSERT
(
(
attributes
(
)
&
~
(
JSPROP_ENUMERATE
|
JSPROP_PERMANENT
|
JSPROP_READONLY
|
JSPROP_GETTER
|
JSPROP_SETTER
|
JSPROP_RESOLVING
)
)
=
=
0
)
;
MOZ_ASSERT_IF
(
isAccessorDescriptor
(
)
has
(
JSPROP_GETTER
)
&
&
has
(
JSPROP_SETTER
)
)
;
#
endif
}
void
assertCompleteIfFound
(
)
const
{
#
ifdef
DEBUG
if
(
object
(
)
)
{
assertComplete
(
)
;
}
#
endif
}
}
;
template
<
typename
Wrapper
>
class
MutableWrappedPtrOperations
<
JS
:
:
PropertyDescriptor
Wrapper
>
:
public
js
:
:
WrappedPtrOperations
<
JS
:
:
PropertyDescriptor
Wrapper
>
{
JS
:
:
PropertyDescriptor
&
desc
(
)
{
return
static_cast
<
Wrapper
*
>
(
this
)
-
>
get
(
)
;
}
public
:
void
clear
(
)
{
object
(
)
.
set
(
nullptr
)
;
setAttributes
(
0
)
;
setGetter
(
nullptr
)
;
setSetter
(
nullptr
)
;
value
(
)
.
setUndefined
(
)
;
}
void
initFields
(
JS
:
:
Handle
<
JSObject
*
>
obj
JS
:
:
Handle
<
JS
:
:
Value
>
v
unsigned
attrs
JSObject
*
getter
JSObject
*
setter
)
{
object
(
)
.
set
(
obj
)
;
value
(
)
.
set
(
v
)
;
setAttributes
(
attrs
)
;
setGetter
(
getter
)
;
setSetter
(
setter
)
;
}
void
assign
(
JS
:
:
PropertyDescriptor
&
other
)
{
object
(
)
.
set
(
other
.
obj
)
;
setAttributes
(
other
.
attrs
)
;
setGetter
(
other
.
getter
)
;
setSetter
(
other
.
setter
)
;
value
(
)
.
set
(
other
.
value
)
;
}
void
setDataDescriptor
(
JS
:
:
Handle
<
JS
:
:
Value
>
v
unsigned
attrs
)
{
MOZ_ASSERT
(
(
attrs
&
~
(
JSPROP_ENUMERATE
|
JSPROP_PERMANENT
|
JSPROP_READONLY
|
JSPROP_IGNORE_ENUMERATE
|
JSPROP_IGNORE_PERMANENT
|
JSPROP_IGNORE_READONLY
)
)
=
=
0
)
;
object
(
)
.
set
(
nullptr
)
;
setAttributes
(
attrs
)
;
setGetter
(
nullptr
)
;
setSetter
(
nullptr
)
;
value
(
)
.
set
(
v
)
;
}
JS
:
:
MutableHandle
<
JSObject
*
>
object
(
)
{
return
JS
:
:
MutableHandle
<
JSObject
*
>
:
:
fromMarkedLocation
(
&
desc
(
)
.
obj
)
;
}
unsigned
&
attributesRef
(
)
{
return
desc
(
)
.
attrs
;
}
JS
:
:
MutableHandle
<
JS
:
:
Value
>
value
(
)
{
return
JS
:
:
MutableHandle
<
JS
:
:
Value
>
:
:
fromMarkedLocation
(
&
desc
(
)
.
value
)
;
}
void
setValue
(
JS
:
:
Handle
<
JS
:
:
Value
>
v
)
{
MOZ_ASSERT
(
!
(
desc
(
)
.
attrs
&
(
JSPROP_GETTER
|
JSPROP_SETTER
)
)
)
;
attributesRef
(
)
&
=
~
JSPROP_IGNORE_VALUE
;
value
(
)
.
set
(
v
)
;
}
void
setConfigurable
(
bool
configurable
)
{
setAttributes
(
(
desc
(
)
.
attrs
&
~
(
JSPROP_IGNORE_PERMANENT
|
JSPROP_PERMANENT
)
)
|
(
configurable
?
0
:
JSPROP_PERMANENT
)
)
;
}
void
setEnumerable
(
bool
enumerable
)
{
setAttributes
(
(
desc
(
)
.
attrs
&
~
(
JSPROP_IGNORE_ENUMERATE
|
JSPROP_ENUMERATE
)
)
|
(
enumerable
?
JSPROP_ENUMERATE
:
0
)
)
;
}
void
setWritable
(
bool
writable
)
{
MOZ_ASSERT
(
!
(
desc
(
)
.
attrs
&
(
JSPROP_GETTER
|
JSPROP_SETTER
)
)
)
;
setAttributes
(
(
desc
(
)
.
attrs
&
~
(
JSPROP_IGNORE_READONLY
|
JSPROP_READONLY
)
)
|
(
writable
?
0
:
JSPROP_READONLY
)
)
;
}
void
setAttributes
(
unsigned
attrs
)
{
desc
(
)
.
attrs
=
attrs
;
}
void
setGetter
(
JSObject
*
obj
)
{
desc
(
)
.
getter
=
obj
;
}
void
setSetter
(
JSObject
*
obj
)
{
desc
(
)
.
setter
=
obj
;
}
void
setGetterObject
(
JSObject
*
obj
)
{
desc
(
)
.
getter
=
obj
;
desc
(
)
.
attrs
&
=
~
(
JSPROP_IGNORE_VALUE
|
JSPROP_IGNORE_READONLY
|
JSPROP_READONLY
)
;
desc
(
)
.
attrs
|
=
JSPROP_GETTER
;
}
void
setSetterObject
(
JSObject
*
obj
)
{
desc
(
)
.
setter
=
obj
;
desc
(
)
.
attrs
&
=
~
(
JSPROP_IGNORE_VALUE
|
JSPROP_IGNORE_READONLY
|
JSPROP_READONLY
)
;
desc
(
)
.
attrs
|
=
JSPROP_SETTER
;
}
JS
:
:
MutableHandle
<
JSObject
*
>
getterObject
(
)
{
MOZ_ASSERT
(
this
-
>
hasGetterObject
(
)
)
;
return
JS
:
:
MutableHandleObject
:
:
fromMarkedLocation
(
&
desc
(
)
.
getter
)
;
}
JS
:
:
MutableHandle
<
JSObject
*
>
setterObject
(
)
{
MOZ_ASSERT
(
this
-
>
hasSetterObject
(
)
)
;
return
JS
:
:
MutableHandleObject
:
:
fromMarkedLocation
(
&
desc
(
)
.
setter
)
;
}
}
;
}
namespace
JS
{
extern
JS_PUBLIC_API
bool
ObjectToCompletePropertyDescriptor
(
JSContext
*
cx
Handle
<
JSObject
*
>
obj
Handle
<
Value
>
descriptor
MutableHandle
<
PropertyDescriptor
>
desc
)
;
extern
JS_PUBLIC_API
bool
FromPropertyDescriptor
(
JSContext
*
cx
Handle
<
PropertyDescriptor
>
desc
MutableHandle
<
Value
>
vp
)
;
}
#
endif
