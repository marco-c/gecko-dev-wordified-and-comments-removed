#
ifndef
js_String_h
#
define
js_String_h
#
include
"
js
/
shadow
/
String
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Likely
.
h
"
#
include
<
algorithm
>
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
"
jstypes
.
h
"
#
include
"
js
/
TypeDecls
.
h
"
class
JS_PUBLIC_API
JSAtom
;
class
JSLinearString
;
class
JS_PUBLIC_API
JSString
;
namespace
JS
{
class
JS_PUBLIC_API
AutoRequireNoGC
;
static
constexpr
uint32_t
MaxStringLength
=
(
1
<
<
30
)
-
2
;
static_assert
(
(
uint64_t
(
MaxStringLength
)
+
1
)
*
sizeof
(
char16_t
)
<
=
INT32_MAX
"
size
of
null
-
terminated
JSString
char
buffer
must
fit
in
"
"
INT32_MAX
"
)
;
MOZ_ALWAYS_INLINE
size_t
GetStringLength
(
JSString
*
s
)
{
return
shadow
:
:
AsShadowString
(
s
)
-
>
length
(
)
;
}
MOZ_ALWAYS_INLINE
size_t
GetLinearStringLength
(
JSLinearString
*
s
)
{
return
shadow
:
:
AsShadowString
(
s
)
-
>
length
(
)
;
}
MOZ_ALWAYS_INLINE
bool
LinearStringHasLatin1Chars
(
JSLinearString
*
s
)
{
return
shadow
:
:
AsShadowString
(
s
)
-
>
hasLatin1Chars
(
)
;
}
MOZ_ALWAYS_INLINE
bool
StringHasLatin1Chars
(
JSString
*
s
)
{
return
shadow
:
:
AsShadowString
(
s
)
-
>
hasLatin1Chars
(
)
;
}
MOZ_ALWAYS_INLINE
const
Latin1Char
*
GetLatin1LinearStringChars
(
const
AutoRequireNoGC
&
nogc
JSLinearString
*
linear
)
{
return
shadow
:
:
AsShadowString
(
linear
)
-
>
latin1LinearChars
(
)
;
}
MOZ_ALWAYS_INLINE
const
char16_t
*
GetTwoByteLinearStringChars
(
const
AutoRequireNoGC
&
nogc
JSLinearString
*
linear
)
{
return
shadow
:
:
AsShadowString
(
linear
)
-
>
twoByteLinearChars
(
)
;
}
MOZ_ALWAYS_INLINE
char16_t
GetLinearStringCharAt
(
JSLinearString
*
linear
size_t
index
)
{
shadow
:
:
String
*
s
=
shadow
:
:
AsShadowString
(
linear
)
;
MOZ_ASSERT
(
index
<
s
-
>
length
(
)
)
;
return
s
-
>
hasLatin1Chars
(
)
?
s
-
>
latin1LinearChars
(
)
[
index
]
:
s
-
>
twoByteLinearChars
(
)
[
index
]
;
}
MOZ_ALWAYS_INLINE
JSLinearString
*
AtomToLinearString
(
JSAtom
*
atom
)
{
return
reinterpret_cast
<
JSLinearString
*
>
(
atom
)
;
}
MOZ_ALWAYS_INLINE
bool
IsExternalString
(
JSString
*
str
const
JSExternalStringCallbacks
*
*
callbacks
const
char16_t
*
*
chars
)
{
shadow
:
:
String
*
s
=
shadow
:
:
AsShadowString
(
str
)
;
if
(
!
s
-
>
isExternal
(
)
)
{
return
false
;
}
*
callbacks
=
s
-
>
externalCallbacks
;
*
chars
=
s
-
>
nonInlineCharsTwoByte
;
return
true
;
}
namespace
detail
{
extern
JS_FRIEND_API
JSLinearString
*
StringToLinearStringSlow
(
JSContext
*
cx
JSString
*
str
)
;
}
MOZ_ALWAYS_INLINE
JSLinearString
*
StringToLinearString
(
JSContext
*
cx
JSString
*
str
)
{
if
(
MOZ_LIKELY
(
shadow
:
:
AsShadowString
(
str
)
-
>
isLinear
(
)
)
)
{
return
reinterpret_cast
<
JSLinearString
*
>
(
str
)
;
}
return
detail
:
:
StringToLinearStringSlow
(
cx
str
)
;
}
MOZ_ALWAYS_INLINE
void
CopyLinearStringChars
(
char16_t
*
dest
JSLinearString
*
s
size_t
len
size_t
start
=
0
)
{
#
ifdef
DEBUG
size_t
stringLen
=
GetLinearStringLength
(
s
)
;
MOZ_ASSERT
(
start
<
=
stringLen
)
;
MOZ_ASSERT
(
len
<
=
stringLen
-
start
)
;
#
endif
shadow
:
:
String
*
str
=
shadow
:
:
AsShadowString
(
s
)
;
if
(
str
-
>
hasLatin1Chars
(
)
)
{
const
Latin1Char
*
src
=
str
-
>
latin1LinearChars
(
)
;
for
(
size_t
i
=
0
;
i
<
len
;
i
+
+
)
{
dest
[
i
]
=
src
[
start
+
i
]
;
}
}
else
{
const
char16_t
*
src
=
str
-
>
twoByteLinearChars
(
)
;
std
:
:
copy_n
(
src
+
start
len
dest
)
;
}
}
MOZ_ALWAYS_INLINE
void
LossyCopyLinearStringChars
(
char
*
dest
JSLinearString
*
s
size_t
len
size_t
start
=
0
)
{
#
ifdef
DEBUG
size_t
stringLen
=
GetLinearStringLength
(
s
)
;
MOZ_ASSERT
(
start
<
=
stringLen
)
;
MOZ_ASSERT
(
len
<
=
stringLen
-
start
)
;
#
endif
shadow
:
:
String
*
str
=
shadow
:
:
AsShadowString
(
s
)
;
if
(
LinearStringHasLatin1Chars
(
s
)
)
{
const
Latin1Char
*
src
=
str
-
>
latin1LinearChars
(
)
;
for
(
size_t
i
=
0
;
i
<
len
;
i
+
+
)
{
dest
[
i
]
=
char
(
src
[
start
+
i
]
)
;
}
}
else
{
const
char16_t
*
src
=
str
-
>
twoByteLinearChars
(
)
;
for
(
size_t
i
=
0
;
i
<
len
;
i
+
+
)
{
dest
[
i
]
=
char
(
src
[
start
+
i
]
)
;
}
}
}
inline
MOZ_MUST_USE
bool
CopyStringChars
(
JSContext
*
cx
char16_t
*
dest
JSString
*
s
size_t
len
size_t
start
=
0
)
{
JSLinearString
*
linear
=
StringToLinearString
(
cx
s
)
;
if
(
!
linear
)
{
return
false
;
}
CopyLinearStringChars
(
dest
linear
len
start
)
;
return
true
;
}
inline
MOZ_MUST_USE
bool
LossyCopyStringChars
(
JSContext
*
cx
char
*
dest
JSString
*
s
size_t
len
size_t
start
=
0
)
{
JSLinearString
*
linear
=
StringToLinearString
(
cx
s
)
;
if
(
!
linear
)
{
return
false
;
}
LossyCopyLinearStringChars
(
dest
linear
len
start
)
;
return
true
;
}
}
[
[
deprecated
]
]
extern
JS_PUBLIC_API
bool
JS_DeprecatedStringHasLatin1Chars
(
JSString
*
str
)
;
#
endif
