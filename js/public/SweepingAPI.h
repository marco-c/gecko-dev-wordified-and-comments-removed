#
ifndef
js_SweepingAPI_h
#
define
js_SweepingAPI_h
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
jstypes
.
h
"
#
include
"
js
/
GCAnnotations
.
h
"
#
include
"
js
/
GCPolicyAPI
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
namespace
js
{
namespace
gc
{
class
StoreBuffer
;
JS_PUBLIC_API
void
LockStoreBuffer
(
StoreBuffer
*
sb
)
;
JS_PUBLIC_API
void
UnlockStoreBuffer
(
StoreBuffer
*
sb
)
;
class
AutoLockStoreBuffer
{
StoreBuffer
*
sb
;
public
:
explicit
AutoLockStoreBuffer
(
StoreBuffer
*
sb
)
:
sb
(
sb
)
{
LockStoreBuffer
(
sb
)
;
}
~
AutoLockStoreBuffer
(
)
{
UnlockStoreBuffer
(
sb
)
;
}
}
;
}
}
namespace
JS
{
namespace
detail
{
class
WeakCacheBase
;
}
namespace
shadow
{
JS_PUBLIC_API
void
RegisterWeakCache
(
JS
:
:
Zone
*
zone
JS
:
:
detail
:
:
WeakCacheBase
*
cachep
)
;
JS_PUBLIC_API
void
RegisterWeakCache
(
JSRuntime
*
rt
JS
:
:
detail
:
:
WeakCacheBase
*
cachep
)
;
}
namespace
detail
{
class
WeakCacheBase
:
public
mozilla
:
:
LinkedListElement
<
WeakCacheBase
>
{
WeakCacheBase
(
)
=
delete
;
explicit
WeakCacheBase
(
const
WeakCacheBase
&
)
=
delete
;
public
:
explicit
WeakCacheBase
(
Zone
*
zone
)
{
shadow
:
:
RegisterWeakCache
(
zone
this
)
;
}
explicit
WeakCacheBase
(
JSRuntime
*
rt
)
{
shadow
:
:
RegisterWeakCache
(
rt
this
)
;
}
WeakCacheBase
(
WeakCacheBase
&
&
other
)
=
default
;
virtual
~
WeakCacheBase
(
)
=
default
;
virtual
size_t
sweep
(
js
:
:
gc
:
:
StoreBuffer
*
sbToLock
)
=
0
;
virtual
bool
needsSweep
(
)
=
0
;
virtual
bool
setNeedsIncrementalBarrier
(
bool
needs
)
{
return
false
;
}
virtual
bool
needsIncrementalBarrier
(
)
const
{
return
false
;
}
}
;
}
template
<
typename
T
>
class
WeakCache
:
protected
detail
:
:
WeakCacheBase
public
js
:
:
MutableWrappedPtrOperations
<
T
WeakCache
<
T
>
>
{
T
cache
;
public
:
using
Type
=
T
;
template
<
typename
.
.
.
Args
>
explicit
WeakCache
(
Zone
*
zone
Args
&
&
.
.
.
args
)
:
WeakCacheBase
(
zone
)
cache
(
std
:
:
forward
<
Args
>
(
args
)
.
.
.
)
{
}
template
<
typename
.
.
.
Args
>
explicit
WeakCache
(
JSRuntime
*
rt
Args
&
&
.
.
.
args
)
:
WeakCacheBase
(
rt
)
cache
(
std
:
:
forward
<
Args
>
(
args
)
.
.
.
)
{
}
const
T
&
get
(
)
const
{
return
cache
;
}
T
&
get
(
)
{
return
cache
;
}
size_t
sweep
(
js
:
:
gc
:
:
StoreBuffer
*
sbToLock
)
override
{
mozilla
:
:
Maybe
<
js
:
:
gc
:
:
AutoLockStoreBuffer
>
lock
;
if
(
sbToLock
)
{
lock
.
emplace
(
sbToLock
)
;
}
GCPolicy
<
T
>
:
:
sweep
(
&
cache
)
;
return
0
;
}
bool
needsSweep
(
)
override
{
return
cache
.
needsSweep
(
)
;
}
}
JS_HAZ_NON_GC_POINTER
;
}
#
endif
