#
ifndef
js_SweepingAPI_h
#
define
js_SweepingAPI_h
#
include
"
js
/
HeapAPI
.
h
"
namespace
js
{
template
<
typename
T
>
class
WeakCacheBase
{
}
;
}
namespace
JS
{
template
<
typename
T
>
class
WeakCache
;
namespace
shadow
{
JS_PUBLIC_API
(
void
)
RegisterWeakCache
(
JS
:
:
Zone
*
zone
JS
:
:
WeakCache
<
void
*
>
*
cachep
)
;
}
template
<
typename
T
>
class
WeakCache
:
public
js
:
:
WeakCacheBase
<
T
>
private
mozilla
:
:
LinkedListElement
<
WeakCache
<
T
>
>
{
friend
class
mozilla
:
:
LinkedListElement
<
WeakCache
<
T
>
>
;
friend
class
mozilla
:
:
LinkedList
<
WeakCache
<
T
>
>
;
WeakCache
(
const
WeakCache
&
)
=
delete
;
using
SweepFn
=
void
(
*
)
(
T
*
)
;
SweepFn
sweeper
;
T
cache
;
public
:
template
<
typename
U
>
WeakCache
(
Zone
*
zone
U
&
&
initial
)
:
cache
(
mozilla
:
:
Forward
<
U
>
(
initial
)
)
{
sweeper
=
js
:
:
GCPolicy
<
T
>
:
:
sweep
;
shadow
:
:
RegisterWeakCache
(
zone
reinterpret_cast
<
WeakCache
<
void
*
>
*
>
(
this
)
)
;
}
WeakCache
(
WeakCache
&
&
other
)
:
sweeper
(
other
.
sweeper
)
cache
(
mozilla
:
:
Forward
<
T
>
(
other
.
cache
)
)
{
}
const
T
&
get
(
)
const
{
return
cache
;
}
T
&
get
(
)
{
return
cache
;
}
void
sweep
(
)
{
sweeper
(
&
cache
)
;
}
}
;
}
#
endif
