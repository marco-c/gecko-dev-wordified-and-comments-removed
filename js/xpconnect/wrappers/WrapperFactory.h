#
ifndef
_xpc_WRAPPERFACTORY_H
#
define
_xpc_WRAPPERFACTORY_H
#
include
"
js
/
Wrapper
.
h
"
namespace
xpc
{
class
CrossOriginObjectWrapper
:
public
js
:
:
Wrapper
{
public
:
constexpr
explicit
CrossOriginObjectWrapper
(
)
:
js
:
:
Wrapper
(
CROSS_COMPARTMENT
false
true
)
{
}
bool
dynamicCheckedUnwrapAllowed
(
JS
:
:
HandleObject
obj
JSContext
*
cx
)
const
override
;
static
const
CrossOriginObjectWrapper
singleton
;
}
;
class
WrapperFactory
{
public
:
enum
{
WAIVE_XRAY_WRAPPER_FLAG
=
js
:
:
Wrapper
:
:
LAST_USED_FLAG
<
<
1
IS_XRAY_WRAPPER_FLAG
=
WAIVE_XRAY_WRAPPER_FLAG
<
<
1
}
;
static
bool
HasWrapperFlag
(
JSObject
*
wrapper
unsigned
flag
)
{
unsigned
flags
=
0
;
js
:
:
UncheckedUnwrap
(
wrapper
true
&
flags
)
;
return
!
!
(
flags
&
flag
)
;
}
static
bool
IsXrayWrapper
(
JSObject
*
wrapper
)
{
return
HasWrapperFlag
(
wrapper
IS_XRAY_WRAPPER_FLAG
)
;
}
static
bool
IsCrossOriginWrapper
(
JSObject
*
obj
)
{
return
(
js
:
:
IsProxy
(
obj
)
&
&
js
:
:
GetProxyHandler
(
obj
)
=
=
&
CrossOriginObjectWrapper
:
:
singleton
)
;
}
static
bool
HasWaiveXrayFlag
(
JSObject
*
wrapper
)
{
return
HasWrapperFlag
(
wrapper
WAIVE_XRAY_WRAPPER_FLAG
)
;
}
static
bool
IsCOW
(
JSObject
*
wrapper
)
;
static
JSObject
*
GetXrayWaiver
(
JS
:
:
HandleObject
obj
)
;
static
JSObject
*
CreateXrayWaiver
(
JSContext
*
cx
JS
:
:
HandleObject
obj
)
;
static
JSObject
*
WaiveXray
(
JSContext
*
cx
JSObject
*
obj
)
;
static
bool
AllowWaiver
(
JS
:
:
Compartment
*
target
JS
:
:
Compartment
*
origin
)
;
static
bool
AllowWaiver
(
JSObject
*
wrapper
)
;
static
void
PrepareForWrapping
(
JSContext
*
cx
JS
:
:
HandleObject
scope
JS
:
:
HandleObject
obj
JS
:
:
HandleObject
objectPassedToWrap
JS
:
:
MutableHandleObject
retObj
)
;
static
JSObject
*
Rewrap
(
JSContext
*
cx
JS
:
:
HandleObject
existing
JS
:
:
HandleObject
obj
)
;
static
bool
WaiveXrayAndWrap
(
JSContext
*
cx
JS
:
:
MutableHandleValue
vp
)
;
static
bool
WaiveXrayAndWrap
(
JSContext
*
cx
JS
:
:
MutableHandleObject
object
)
;
}
;
extern
const
js
:
:
Wrapper
XrayWaiver
;
}
#
endif
