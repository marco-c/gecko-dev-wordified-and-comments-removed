const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
allow_eval_with_system_principal
"
true
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
security
.
allow_eval_with_system_principal
"
)
;
}
)
;
function
run_test
(
)
{
registerAppManifest
(
do_get_file
(
'
.
.
/
components
/
js
/
xpctest
.
manifest
'
)
)
;
var
sb
=
new
Cu
.
Sandbox
(
this
)
;
sb
.
eval
(
'
function
fun
(
x
)
{
return
x
;
}
'
)
;
Assert
.
equal
(
sb
.
fun
(
"
foo
"
)
"
foo
"
)
;
var
utils
=
Cc
[
"
mozilla
.
org
/
js
/
xpc
/
test
/
js
/
TestUtils
;
1
"
]
.
createInstance
(
Ci
.
nsIXPCTestUtils
)
;
var
doubleWrapped
=
utils
.
doubleWrapFunction
(
sb
.
fun
)
;
Assert
.
equal
(
doubleWrapped
.
echo
(
"
foo
"
)
"
foo
"
)
;
Cu
.
forceGC
(
)
;
Assert
.
equal
(
doubleWrapped
.
echo
(
"
foo
"
)
"
foo
"
)
;
}
