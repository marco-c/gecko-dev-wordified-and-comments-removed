function
run_test
(
)
{
var
contentSB
=
new
Cu
.
Sandbox
(
[
'
http
:
/
/
www
.
google
.
com
'
]
{
wantGlobalProperties
:
[
"
XMLHttpRequest
"
]
wantComponents
:
true
}
)
;
Cu
.
evalInSandbox
(
'
xhr
=
new
XMLHttpRequest
(
)
;
'
contentSB
)
;
var
xhr
=
contentSB
.
xhr
;
Assert
.
ok
(
Cu
.
isXrayWrapper
(
xhr
)
)
;
xhr
.
unwaivedExpando
=
xhr
;
Assert
.
ok
(
Cu
.
isXrayWrapper
(
xhr
.
unwaivedExpando
)
)
;
var
waived
=
xhr
.
wrappedJSObject
;
Assert
.
ok
(
!
Cu
.
isXrayWrapper
(
waived
)
)
;
xhr
.
waivedExpando
=
waived
;
Assert
.
ok
(
!
Cu
.
isXrayWrapper
(
xhr
.
waivedExpando
)
)
;
Cu
.
evalInSandbox
(
'
function
f
(
)
{
}
'
contentSB
)
;
var
f
=
contentSB
.
f
;
var
fWaiver
=
Cu
.
waiveXrays
(
f
)
;
Assert
.
ok
(
f
!
=
fWaiver
)
;
Assert
.
ok
(
Cu
.
unwaiveXrays
(
fWaiver
)
=
=
=
f
)
;
Object
.
defineProperty
(
xhr
'
waivedAccessors
'
{
get
:
fWaiver
set
:
fWaiver
}
)
;
var
desc
=
Object
.
getOwnPropertyDescriptor
(
xhr
'
waivedAccessors
'
)
;
Assert
.
ok
(
desc
.
get
=
=
=
fWaiver
)
;
Assert
.
ok
(
desc
.
set
=
=
=
fWaiver
)
;
var
unwaivedC
=
contentSB
.
Components
;
Assert
.
ok
(
Cu
.
isXrayWrapper
(
unwaivedC
)
)
;
var
waivedC
=
unwaivedC
.
wrappedJSObject
;
Assert
.
ok
(
waivedC
&
&
unwaivedC
&
&
(
waivedC
!
=
unwaivedC
)
)
;
xhr
.
waivedC
=
waivedC
;
Assert
.
ok
(
xhr
.
waivedC
=
=
=
waivedC
)
;
Assert
.
ok
(
Cu
.
unwaiveXrays
(
xhr
.
waivedC
)
=
=
=
unwaivedC
)
;
}
