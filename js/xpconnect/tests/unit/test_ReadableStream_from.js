add_task
(
async
function
run_test
(
)
{
let
sb
=
new
Cu
.
Sandbox
(
'
http
:
/
/
www
.
example
.
com
'
)
;
let
done
=
false
;
let
iterator
=
{
[
Symbol
.
asyncIterator
]
(
)
{
return
this
;
}
next
(
)
{
let
promise
=
Cu
.
evalInSandbox
(
Promise
.
resolve
(
{
done
:
{
done
}
value
:
{
hello
:
"
world
"
}
}
)
sb
)
;
done
=
true
;
return
promise
;
}
}
let
stream
=
ReadableStream
.
from
(
iterator
)
;
let
reader
=
stream
.
getReader
(
)
;
let
result
=
await
reader
.
read
(
)
;
Assert
.
equal
(
result
.
done
false
)
;
Assert
.
equal
(
result
.
value
?
.
hello
"
world
"
)
;
result
=
await
reader
.
read
(
)
;
Assert
.
equal
(
result
.
done
true
)
;
}
)
;
