#
include
"
mozilla
/
GenericFactory
.
h
"
#
include
"
mozilla
/
ResultExtensions
.
h
"
#
include
"
nsComponentManager
.
h
"
#
include
"
xpctest_private
.
h
"
template
<
typename
T
>
nsresult
RegisterFactory
(
const
char
*
aContractID
)
{
auto
constructor
=
[
]
(
REFNSIID
aIID
void
*
*
aResult
)
{
RefPtr
inst
=
new
T
(
)
;
return
inst
-
>
QueryInterface
(
aIID
aResult
)
;
}
;
nsCOMPtr
<
nsIFactory
>
factory
=
new
mozilla
:
:
GenericFactory
(
constructor
)
;
nsID
cid
;
MOZ_TRY
(
nsID
:
:
GenerateUUIDInPlace
(
cid
)
)
;
return
nsComponentManagerImpl
:
:
gComponentManager
-
>
RegisterFactory
(
cid
aContractID
aContractID
factory
)
;
}
nsresult
xpcTestRegisterComponents
(
)
{
MOZ_TRY
(
RegisterFactory
<
xpcTestObjectReadOnly
>
(
"
mozilla
.
org
/
js
/
xpc
/
test
/
native
/
ObjectReadOnly
;
1
"
)
)
;
MOZ_TRY
(
RegisterFactory
<
xpcTestObjectReadWrite
>
(
"
mozilla
.
org
/
js
/
xpc
/
test
/
native
/
ObjectReadWrite
;
1
"
)
)
;
MOZ_TRY
(
RegisterFactory
<
nsXPCTestParams
>
(
"
mozilla
.
org
/
js
/
xpc
/
test
/
native
/
Params
;
1
"
)
)
;
MOZ_TRY
(
RegisterFactory
<
nsXPCTestReturnCodeParent
>
(
"
mozilla
.
org
/
js
/
xpc
/
test
/
native
/
ReturnCodeParent
;
1
"
)
)
;
MOZ_TRY
(
RegisterFactory
<
xpcTestCEnums
>
(
"
mozilla
.
org
/
js
/
xpc
/
test
/
native
/
CEnums
;
1
"
)
)
;
return
NS_OK
;
}
