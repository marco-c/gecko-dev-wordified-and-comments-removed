#
ifndef
frontend_ObjectEmitter_h
#
define
frontend_ObjectEmitter_h
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
"
frontend
/
EmitterScope
.
h
"
#
include
"
frontend
/
NameOpEmitter
.
h
"
#
include
"
frontend
/
ParseNode
.
h
"
#
include
"
frontend
/
ParserAtom
.
h
"
#
include
"
frontend
/
TDZCheckCache
.
h
"
#
include
"
vm
/
Opcodes
.
h
"
#
include
"
vm
/
Scope
.
h
"
namespace
js
{
namespace
frontend
{
struct
BytecodeEmitter
;
class
SharedContext
;
class
MOZ_STACK_CLASS
PropertyEmitter
{
public
:
enum
class
Kind
{
Prototype
Static
}
;
protected
:
BytecodeEmitter
*
bce_
;
bool
isClass_
=
false
;
bool
isStatic_
=
false
;
bool
isIndexOrComputed_
=
false
;
#
ifdef
DEBUG
enum
class
PropertyState
{
Start
PropValue
InitHomeObj
PrivateMethodValue
InitHomeObjForPrivateMethod
PrivateStaticMethod
InitHomeObjForPrivateStaticMethod
IndexKey
IndexValue
InitHomeObjForIndex
ComputedKey
ComputedValue
InitHomeObjForComputed
ProtoValue
SpreadOperand
Init
}
;
PropertyState
propertyState_
=
PropertyState
:
:
Start
;
#
endif
public
:
explicit
PropertyEmitter
(
BytecodeEmitter
*
bce
)
;
[
[
nodiscard
]
]
bool
prepareForProtoValue
(
uint32_t
keyPos
)
;
[
[
nodiscard
]
]
bool
emitMutateProto
(
)
;
[
[
nodiscard
]
]
bool
prepareForSpreadOperand
(
uint32_t
spreadPos
)
;
[
[
nodiscard
]
]
bool
emitSpread
(
)
;
[
[
nodiscard
]
]
bool
prepareForPropValue
(
uint32_t
keyPos
Kind
kind
)
;
[
[
nodiscard
]
]
bool
prepareForPrivateMethod
(
)
;
[
[
nodiscard
]
]
bool
prepareForPrivateStaticMethod
(
uint32_t
keyPos
)
;
[
[
nodiscard
]
]
bool
prepareForIndexPropKey
(
uint32_t
keyPos
Kind
kind
)
;
[
[
nodiscard
]
]
bool
prepareForIndexPropValue
(
)
;
[
[
nodiscard
]
]
bool
prepareForComputedPropKey
(
uint32_t
keyPos
Kind
kind
)
;
[
[
nodiscard
]
]
bool
prepareForComputedPropValue
(
)
;
[
[
nodiscard
]
]
bool
emitInitHomeObject
(
)
;
[
[
nodiscard
]
]
bool
emitInit
(
AccessorType
accessorType
TaggedParserAtomIndex
key
)
;
[
[
nodiscard
]
]
bool
emitInitIndexOrComputed
(
AccessorType
accessorType
)
;
[
[
nodiscard
]
]
bool
emitPrivateStaticMethod
(
AccessorType
accessorType
)
;
[
[
nodiscard
]
]
bool
skipInit
(
)
;
private
:
[
[
nodiscard
]
]
MOZ_ALWAYS_INLINE
bool
prepareForProp
(
uint32_t
keyPos
bool
isStatic
bool
isComputed
)
;
[
[
nodiscard
]
]
bool
emitInit
(
JSOp
op
TaggedParserAtomIndex
key
)
;
[
[
nodiscard
]
]
bool
emitInitIndexOrComputed
(
JSOp
op
)
;
[
[
nodiscard
]
]
bool
emitPopClassConstructor
(
)
;
}
;
class
MOZ_STACK_CLASS
ObjectEmitter
:
public
PropertyEmitter
{
private
:
#
ifdef
DEBUG
enum
class
ObjectState
{
Start
Object
End
}
;
ObjectState
objectState_
=
ObjectState
:
:
Start
;
#
endif
public
:
explicit
ObjectEmitter
(
BytecodeEmitter
*
bce
)
;
[
[
nodiscard
]
]
bool
emitObject
(
size_t
propertyCount
)
;
[
[
nodiscard
]
]
bool
emitObjectWithTemplateOnStack
(
)
;
[
[
nodiscard
]
]
bool
emitEnd
(
)
;
}
;
class
MOZ_RAII
AutoSaveLocalStrictMode
{
SharedContext
*
sc_
;
bool
savedStrictness_
;
public
:
explicit
AutoSaveLocalStrictMode
(
SharedContext
*
sc
)
;
~
AutoSaveLocalStrictMode
(
)
;
void
restore
(
)
;
}
;
class
MOZ_STACK_CLASS
ClassEmitter
:
public
PropertyEmitter
{
public
:
enum
class
Kind
{
Expression
Declaration
}
;
private
:
bool
isDerived_
=
false
;
mozilla
:
:
Maybe
<
TDZCheckCache
>
tdzCache_
;
mozilla
:
:
Maybe
<
EmitterScope
>
innerScope_
;
mozilla
:
:
Maybe
<
TDZCheckCache
>
bodyTdzCache_
;
mozilla
:
:
Maybe
<
EmitterScope
>
bodyScope_
;
AutoSaveLocalStrictMode
strictMode_
;
#
ifdef
DEBUG
enum
class
ClassState
{
Start
Scope
BodyScope
Class
InitConstructor
InstanceMemberInitializers
InstanceMemberInitializersEnd
StaticMemberInitializers
StaticMemberInitializersEnd
BoundName
End
}
;
ClassState
classState_
=
ClassState
:
:
Start
;
enum
class
MemberState
{
Start
Initializer
InitializerWithHomeObject
}
;
MemberState
memberState_
=
MemberState
:
:
Start
;
size_t
numInitializers_
=
0
;
#
endif
TaggedParserAtomIndex
name_
;
TaggedParserAtomIndex
nameForAnonymousClass_
;
bool
hasNameOnStack_
=
false
;
mozilla
:
:
Maybe
<
NameOpEmitter
>
initializersAssignment_
;
size_t
initializerIndex_
=
0
;
public
:
explicit
ClassEmitter
(
BytecodeEmitter
*
bce
)
;
bool
emitScope
(
LexicalScope
:
:
ParserData
*
scopeBindings
)
;
bool
emitBodyScope
(
ClassBodyScope
:
:
ParserData
*
scopeBindings
)
;
[
[
nodiscard
]
]
bool
emitClass
(
TaggedParserAtomIndex
name
TaggedParserAtomIndex
nameForAnonymousClass
bool
hasNameOnStack
)
;
[
[
nodiscard
]
]
bool
emitDerivedClass
(
TaggedParserAtomIndex
name
TaggedParserAtomIndex
nameForAnonymousClass
bool
hasNameOnStack
)
;
[
[
nodiscard
]
]
bool
emitInitConstructor
(
bool
needsHomeObject
)
;
[
[
nodiscard
]
]
bool
prepareForMemberInitializers
(
size_t
numInitializers
bool
isStatic
)
;
[
[
nodiscard
]
]
bool
prepareForMemberInitializer
(
)
;
[
[
nodiscard
]
]
bool
emitMemberInitializerHomeObject
(
bool
isStatic
)
;
[
[
nodiscard
]
]
bool
emitStoreMemberInitializer
(
)
;
[
[
nodiscard
]
]
bool
emitMemberInitializersEnd
(
)
;
[
[
nodiscard
]
]
bool
emitBinding
(
)
;
#
ifdef
ENABLE_DECORATORS
[
[
nodiscard
]
]
bool
prepareForDecorators
(
)
;
#
endif
[
[
nodiscard
]
]
bool
emitEnd
(
Kind
kind
)
;
private
:
[
[
nodiscard
]
]
bool
initProtoAndCtor
(
)
;
[
[
nodiscard
]
]
bool
leaveBodyAndInnerScope
(
)
;
}
;
}
}
#
endif
