#
include
"
frontend
/
BinASTRuntimeSupport
.
h
"
#
include
"
gc
/
Tracer
.
h
"
#
include
"
js
/
Vector
.
h
"
#
include
"
vm
/
StringType
.
h
"
namespace
js
{
namespace
frontend
{
BinASTSourceMetadata
*
BinASTSourceMetadata
:
:
Create
(
const
Vector
<
BinASTKind
>
&
binASTKinds
uint32_t
numStrings
)
{
uint32_t
numBinASTKinds
=
binASTKinds
.
length
(
)
;
BinASTSourceMetadata
*
data
=
static_cast
<
BinASTSourceMetadata
*
>
(
js_malloc
(
BinASTSourceMetadata
:
:
totalSize
(
numBinASTKinds
numStrings
)
)
)
;
if
(
MOZ_UNLIKELY
(
!
data
)
)
{
return
nullptr
;
}
new
(
data
)
BinASTSourceMetadata
(
numBinASTKinds
numStrings
)
;
memcpy
(
data
-
>
binASTKindBase
(
)
binASTKinds
.
begin
(
)
binASTKinds
.
length
(
)
*
sizeof
(
BinASTKind
)
)
;
return
data
;
}
BinASTSourceMetadata
*
BinASTSourceMetadata
:
:
Create
(
uint32_t
numStrings
)
{
BinASTSourceMetadata
*
data
=
static_cast
<
BinASTSourceMetadata
*
>
(
js_malloc
(
BinASTSourceMetadata
:
:
totalSize
(
0
numStrings
)
)
)
;
if
(
MOZ_UNLIKELY
(
!
data
)
)
{
return
nullptr
;
}
new
(
data
)
BinASTSourceMetadata
(
numStrings
)
;
return
data
;
}
void
BinASTSourceMetadata
:
:
trace
(
JSTracer
*
tracer
)
{
JSAtom
*
*
base
=
atomsBase
(
)
;
for
(
uint32_t
i
=
0
;
i
<
numStrings_
;
i
+
+
)
{
if
(
base
[
i
]
)
{
TraceManuallyBarrieredEdge
(
tracer
&
base
[
i
]
"
BinAST
Strings
"
)
;
}
}
}
}
}
