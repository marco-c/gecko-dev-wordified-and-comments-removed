#
ifndef
frontend_FunctionEmitter_h
#
define
frontend_FunctionEmitter_h
#
include
"
mozilla
/
Attributes
.
h
"
#
include
<
stdint
.
h
>
#
include
"
frontend
/
DefaultEmitter
.
h
"
#
include
"
frontend
/
EmitterScope
.
h
"
#
include
"
frontend
/
FunctionSyntaxKind
.
h
"
#
include
"
frontend
/
SharedContext
.
h
"
#
include
"
frontend
/
TDZCheckCache
.
h
"
#
include
"
frontend
/
TryEmitter
.
h
"
#
include
"
gc
/
Rooting
.
h
"
#
include
"
vm
/
BytecodeUtil
.
h
"
#
include
"
vm
/
JSAtom
.
h
"
#
include
"
vm
/
JSFunction
.
h
"
#
include
"
vm
/
SharedStencil
.
h
"
namespace
js
{
namespace
frontend
{
struct
BytecodeEmitter
;
class
MOZ_STACK_CLASS
FunctionEmitter
{
public
:
enum
class
IsHoisted
{
No
Yes
}
;
private
:
BytecodeEmitter
*
bce_
;
FunctionBox
*
funbox_
;
JS
:
:
Rooted
<
JSAtom
*
>
name_
;
FunctionSyntaxKind
syntaxKind_
;
IsHoisted
isHoisted_
;
#
ifdef
DEBUG
enum
class
State
{
Start
NonLazy
End
}
;
State
state_
=
State
:
:
Start
;
#
endif
public
:
FunctionEmitter
(
BytecodeEmitter
*
bce
FunctionBox
*
funbox
FunctionSyntaxKind
syntaxKind
IsHoisted
isHoisted
)
;
MOZ_MUST_USE
bool
prepareForNonLazy
(
)
;
MOZ_MUST_USE
bool
emitNonLazyEnd
(
)
;
MOZ_MUST_USE
bool
emitLazy
(
)
;
MOZ_MUST_USE
bool
emitAgain
(
)
;
MOZ_MUST_USE
bool
emitAsmJSModule
(
)
;
private
:
MOZ_MUST_USE
bool
emitFunction
(
)
;
MOZ_MUST_USE
bool
emitNonHoisted
(
GCThingIndex
index
)
;
MOZ_MUST_USE
bool
emitHoisted
(
GCThingIndex
index
)
;
MOZ_MUST_USE
bool
emitTopLevelFunction
(
GCThingIndex
index
)
;
MOZ_MUST_USE
bool
emitNewTargetForArrow
(
)
;
}
;
class
MOZ_STACK_CLASS
FunctionScriptEmitter
{
private
:
BytecodeEmitter
*
bce_
;
FunctionBox
*
funbox_
;
mozilla
:
:
Maybe
<
EmitterScope
>
namedLambdaEmitterScope_
;
mozilla
:
:
Maybe
<
EmitterScope
>
functionEmitterScope_
;
mozilla
:
:
Maybe
<
EmitterScope
>
extraBodyVarEmitterScope_
;
mozilla
:
:
Maybe
<
TDZCheckCache
>
tdzCache_
;
mozilla
:
:
Maybe
<
TryEmitter
>
rejectTryCatch_
;
mozilla
:
:
Maybe
<
uint32_t
>
paramStart_
;
mozilla
:
:
Maybe
<
uint32_t
>
bodyEnd_
;
#
ifdef
DEBUG
enum
class
State
{
Start
Parameters
Body
EndBody
End
}
;
State
state_
=
State
:
:
Start
;
#
endif
public
:
FunctionScriptEmitter
(
BytecodeEmitter
*
bce
FunctionBox
*
funbox
const
mozilla
:
:
Maybe
<
uint32_t
>
&
paramStart
const
mozilla
:
:
Maybe
<
uint32_t
>
&
bodyEnd
)
:
bce_
(
bce
)
funbox_
(
funbox
)
paramStart_
(
paramStart
)
bodyEnd_
(
bodyEnd
)
{
}
MOZ_MUST_USE
bool
prepareForParameters
(
)
;
MOZ_MUST_USE
bool
prepareForBody
(
)
;
MOZ_MUST_USE
bool
emitEndBody
(
)
;
MOZ_MUST_USE
bool
intoStencil
(
)
;
private
:
MOZ_MUST_USE
bool
emitExtraBodyVarScope
(
)
;
MOZ_MUST_USE
bool
emitAsyncFunctionRejectPrologue
(
)
;
MOZ_MUST_USE
bool
emitAsyncFunctionRejectEpilogue
(
)
;
}
;
class
MOZ_STACK_CLASS
FunctionParamsEmitter
{
private
:
BytecodeEmitter
*
bce_
;
FunctionBox
*
funbox_
;
EmitterScope
*
functionEmitterScope_
;
uint16_t
argSlot_
=
0
;
mozilla
:
:
Maybe
<
DefaultEmitter
>
default_
;
#
ifdef
DEBUG
enum
class
State
{
Start
Default
Destructuring
DestructuringDefaultInitializer
DestructuringDefault
DestructuringRest
End
}
;
State
state_
=
State
:
:
Start
;
#
endif
public
:
FunctionParamsEmitter
(
BytecodeEmitter
*
bce
FunctionBox
*
funbox
)
;
MOZ_MUST_USE
bool
emitSimple
(
JS
:
:
Handle
<
JSAtom
*
>
paramName
)
;
MOZ_MUST_USE
bool
prepareForDefault
(
)
;
MOZ_MUST_USE
bool
emitDefaultEnd
(
JS
:
:
Handle
<
JSAtom
*
>
paramName
)
;
MOZ_MUST_USE
bool
prepareForDestructuring
(
)
;
MOZ_MUST_USE
bool
emitDestructuringEnd
(
)
;
MOZ_MUST_USE
bool
prepareForDestructuringDefaultInitializer
(
)
;
MOZ_MUST_USE
bool
prepareForDestructuringDefault
(
)
;
MOZ_MUST_USE
bool
emitDestructuringDefaultEnd
(
)
;
MOZ_MUST_USE
bool
emitRest
(
JS
:
:
Handle
<
JSAtom
*
>
paramName
)
;
MOZ_MUST_USE
bool
prepareForDestructuringRest
(
)
;
MOZ_MUST_USE
bool
emitDestructuringRestEnd
(
)
;
private
:
MOZ_MUST_USE
bool
prepareForInitializer
(
)
;
MOZ_MUST_USE
bool
emitInitializerEnd
(
)
;
MOZ_MUST_USE
bool
emitRestArray
(
)
;
MOZ_MUST_USE
bool
emitAssignment
(
JS
:
:
Handle
<
JSAtom
*
>
paramName
)
;
}
;
}
}
#
endif
