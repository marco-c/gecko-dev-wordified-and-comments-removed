class
MyPromise
extends
Promise
{
}
var
mp1Value
=
{
}
;
var
mp1
=
MyPromise
.
resolve
(
mp1Value
)
;
var
mp2
=
MyPromise
.
resolve
(
42
)
;
var
thenCalls
=
[
]
;
var
then
=
Promise
.
prototype
.
then
;
Promise
.
prototype
.
then
=
function
(
resolve
reject
)
{
thenCalls
.
push
(
{
promise
:
this
resolve
reject
}
)
;
return
then
.
call
(
this
resolve
reject
)
;
}
;
mp1
.
finally
(
(
)
=
>
mp2
)
.
then
(
(
)
=
>
{
assert
.
sameValue
(
thenCalls
.
length
5
)
;
var
mp2Calls
=
thenCalls
.
filter
(
c
=
>
c
.
promise
=
=
=
mp2
)
;
assert
.
sameValue
(
mp2Calls
.
length
1
)
;
assert
.
sameValue
(
mp2Calls
[
0
]
.
reject
undefined
)
;
assert
.
sameValue
(
mp2Calls
[
0
]
.
resolve
(
)
mp1Value
)
;
}
)
.
then
(
DONE
DONE
)
;
