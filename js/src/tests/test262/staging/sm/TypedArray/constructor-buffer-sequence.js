const
otherGlobal
=
262
.
createRealm
(
)
.
global
;
function
*
createBuffers
(
lengths
=
[
0
8
]
)
{
for
(
let
length
of
lengths
)
{
let
buffer
=
new
ArrayBuffer
(
length
)
;
yield
{
buffer
detach
:
(
)
=
>
262
.
detachArrayBuffer
(
buffer
)
}
;
}
for
(
let
length
of
lengths
)
{
let
buffer
=
new
otherGlobal
.
ArrayBuffer
(
length
)
;
yield
{
buffer
detach
:
(
)
=
>
otherGlobal
.
262
.
detachArrayBuffer
(
buffer
)
}
;
}
}
const
poisonedValue
=
new
Proxy
(
{
}
new
Proxy
(
{
}
{
get
(
)
{
throw
new
Error
(
"
Poisoned
Value
"
)
;
}
}
)
)
;
class
ExpectedError
extends
Error
{
}
function
ConstructorWithThrowingPrototype
(
detach
)
{
return
Object
.
defineProperty
(
function
(
)
{
}
.
bind
(
null
)
"
prototype
"
{
get
(
)
{
if
(
detach
)
detach
(
)
;
throw
new
ExpectedError
(
)
;
}
}
)
;
}
function
ValueThrowing
(
detach
)
{
return
{
valueOf
(
)
{
if
(
detach
)
detach
(
)
;
throw
new
ExpectedError
(
)
;
}
}
;
}
function
ValueReturning
(
value
detach
)
{
return
{
valueOf
(
)
{
if
(
detach
)
detach
(
)
;
return
value
;
}
}
;
}
for
(
let
{
buffer
}
of
createBuffers
(
)
)
{
let
constructor
=
ConstructorWithThrowingPrototype
(
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
Reflect
.
construct
(
Int32Array
[
buffer
poisonedValue
0
]
constructor
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
constructor
=
ConstructorWithThrowingPrototype
(
)
;
detach
(
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
Reflect
.
construct
(
Int32Array
[
buffer
0
0
]
constructor
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
constructor
=
ConstructorWithThrowingPrototype
(
detach
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
Reflect
.
construct
(
Int32Array
[
buffer
0
0
]
constructor
)
)
;
}
for
(
let
{
buffer
}
of
createBuffers
(
)
)
{
let
constructor
=
ConstructorWithThrowingPrototype
(
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
Reflect
.
construct
(
Int32Array
[
buffer
0
poisonedValue
]
constructor
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
ValueThrowing
(
)
;
detach
(
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
0
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
ValueThrowing
(
detach
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
0
)
)
;
}
for
(
let
{
buffer
}
of
createBuffers
(
)
)
{
let
byteOffset
=
ValueThrowing
(
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
poisonedValue
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
1
;
detach
(
)
;
assert
.
throws
(
RangeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
0
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
ValueReturning
(
1
detach
)
;
assert
.
throws
(
RangeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
0
)
)
;
}
for
(
let
{
buffer
}
of
createBuffers
(
)
)
{
assert
.
throws
(
RangeError
(
)
=
>
new
Int32Array
(
buffer
1
poisonedValue
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
0
;
let
length
=
ValueThrowing
(
)
;
detach
(
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
length
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
ValueReturning
(
0
detach
)
;
let
length
=
ValueThrowing
(
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
length
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
0
;
let
length
=
ValueThrowing
(
detach
)
;
assert
.
throws
(
ExpectedError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
length
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
[
1
9
]
)
)
{
let
byteOffset
=
0
;
detach
(
)
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
[
1
9
]
)
)
{
let
byteOffset
=
ValueReturning
(
0
detach
)
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
64
;
detach
(
)
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
ValueReturning
(
64
detach
)
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
64
;
let
length
=
ValueReturning
(
0
detach
)
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
length
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
0
;
let
length
=
ValueReturning
(
64
detach
)
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
length
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
ValueReturning
(
0
detach
)
;
let
length
=
0
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
length
)
)
;
}
for
(
let
{
buffer
detach
}
of
createBuffers
(
)
)
{
let
byteOffset
=
0
;
let
length
=
ValueReturning
(
0
detach
)
;
assert
.
throws
(
TypeError
(
)
=
>
new
Int32Array
(
buffer
byteOffset
length
)
)
;
}
reportCompare
(
0
0
)
;
