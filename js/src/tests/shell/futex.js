var
DEBUG
=
false
;
function
dprint
(
s
)
{
if
(
DEBUG
)
print
(
s
)
;
}
var
hasSharedArrayBuffer
=
!
!
(
this
.
SharedArrayBuffer
&
&
this
.
getSharedObject
&
&
this
.
setSharedObject
)
;
if
(
hasSharedArrayBuffer
&
&
helperThreadCount
(
)
!
=
=
0
)
{
var
mem
=
new
Int32Array
(
new
SharedArrayBuffer
(
1024
)
)
;
mem
[
0
]
=
42
;
assertEq
(
Atomics
.
wait
(
mem
0
33
)
"
not
-
equal
"
)
;
assertEq
(
Atomics
.
wait
(
mem
0
42
100
)
"
timed
-
out
"
)
;
mem
[
0
]
=
42
;
mem
[
1
]
=
37
;
mem
[
2
]
=
DEBUG
;
setSharedObject
(
mem
.
buffer
)
;
evalInWorker
(
var
mem
=
new
Int32Array
(
getSharedObject
(
)
)
;
function
dprint
(
s
)
{
if
(
mem
[
2
]
)
print
(
s
)
;
}
assertEq
(
mem
[
0
]
42
)
;
assertEq
(
mem
[
1
]
37
)
;
mem
[
1
]
=
1337
;
dprint
(
"
Sleeping
for
2
seconds
"
)
;
sleep
(
2
)
;
dprint
(
"
Waking
the
main
thread
now
"
)
;
setSharedObject
(
null
)
;
assertEq
(
Atomics
.
notify
(
mem
0
1
)
1
)
;
)
;
var
then
=
Date
.
now
(
)
;
assertEq
(
Atomics
.
wait
(
mem
0
42
)
"
ok
"
)
;
dprint
(
"
Woke
up
as
I
should
have
in
"
+
(
Date
.
now
(
)
-
then
)
/
1000
+
"
s
"
)
;
assertEq
(
mem
[
1
]
1337
)
;
assertEq
(
getSharedObject
(
)
null
)
;
setSharedObject
(
mem
.
buffer
)
;
evalInWorker
(
var
mem
=
new
Int32Array
(
getSharedObject
(
)
)
;
sleep
(
2
)
;
assertEq
(
Atomics
.
notify
(
mem
0
)
1
)
;
)
;
var
then
=
Date
.
now
(
)
;
dprint
(
"
Main
thread
waiting
on
wakeup
(
2s
)
"
)
;
assertEq
(
Atomics
.
wait
(
mem
0
42
)
"
ok
"
)
;
dprint
(
"
Woke
up
as
I
should
have
in
"
+
(
Date
.
now
(
)
-
then
)
/
1000
+
"
s
"
)
;
var
exn
=
false
;
timeout
(
2
function
(
)
{
dprint
(
"
In
the
interrupt
starting
inner
wait
with
timeout
2s
"
)
;
try
{
Atomics
.
wait
(
mem
0
42
)
;
}
catch
(
e
)
{
dprint
(
"
Got
the
interrupt
exception
!
"
)
;
exn
=
true
;
}
return
true
;
}
)
;
try
{
dprint
(
"
Starting
outer
wait
"
)
;
assertEq
(
Atomics
.
wait
(
mem
0
42
5000
)
"
timed
-
out
"
)
;
}
finally
{
timeout
(
-
1
)
;
}
assertEq
(
exn
true
)
;
}
dprint
(
"
Done
"
)
;
reportCompare
(
true
true
)
;
