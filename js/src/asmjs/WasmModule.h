#
ifndef
wasm_module_h
#
define
wasm_module_h
#
include
"
asmjs
/
WasmCode
.
h
"
#
include
"
js
/
TypeDecls
.
h
"
namespace
js
{
class
ArrayBufferObjectMaybeShared
;
class
WasmInstanceObject
;
namespace
wasm
{
struct
LinkDataCacheablePod
{
uint32_t
functionCodeLength
;
uint32_t
globalDataLength
;
uint32_t
interruptOffset
;
uint32_t
outOfBoundsOffset
;
uint32_t
unalignedAccessOffset
;
LinkDataCacheablePod
(
)
{
mozilla
:
:
PodZero
(
this
)
;
}
}
;
struct
LinkData
:
LinkDataCacheablePod
{
LinkDataCacheablePod
&
pod
(
)
{
return
*
this
;
}
const
LinkDataCacheablePod
&
pod
(
)
const
{
return
*
this
;
}
struct
InternalLink
{
enum
Kind
{
RawPointer
CodeLabel
InstructionImmediate
}
;
MOZ_INIT_OUTSIDE_CTOR
uint32_t
patchAtOffset
;
MOZ_INIT_OUTSIDE_CTOR
uint32_t
targetOffset
;
InternalLink
(
)
=
default
;
explicit
InternalLink
(
Kind
kind
)
;
bool
isRawPointerPatch
(
)
;
}
;
typedef
Vector
<
InternalLink
0
SystemAllocPolicy
>
InternalLinkVector
;
struct
SymbolicLinkArray
:
EnumeratedArray
<
SymbolicAddress
SymbolicAddress
:
:
Limit
Uint32Vector
>
{
WASM_DECLARE_SERIALIZABLE
(
SymbolicLinkArray
)
}
;
struct
FuncTable
{
uint32_t
globalDataOffset
;
Uint32Vector
elemOffsets
;
FuncTable
(
uint32_t
globalDataOffset
Uint32Vector
&
&
elemOffsets
)
:
globalDataOffset
(
globalDataOffset
)
elemOffsets
(
Move
(
elemOffsets
)
)
{
}
FuncTable
(
)
=
default
;
WASM_DECLARE_SERIALIZABLE
(
FuncTable
)
}
;
typedef
Vector
<
FuncTable
0
SystemAllocPolicy
>
FuncTableVector
;
InternalLinkVector
internalLinks
;
SymbolicLinkArray
symbolicLinks
;
FuncTableVector
funcTables
;
WASM_DECLARE_SERIALIZABLE
(
LinkData
)
}
;
typedef
UniquePtr
<
LinkData
>
UniqueLinkData
;
typedef
UniquePtr
<
const
LinkData
>
UniqueConstLinkData
;
struct
Import
{
CacheableChars
module
;
CacheableChars
func
;
DefinitionKind
kind
;
Import
(
)
=
default
;
Import
(
UniqueChars
&
&
module
UniqueChars
&
&
func
DefinitionKind
kind
)
:
module
(
Move
(
module
)
)
func
(
Move
(
func
)
)
kind
(
kind
)
{
}
WASM_DECLARE_SERIALIZABLE
(
Import
)
}
;
typedef
Vector
<
Import
0
SystemAllocPolicy
>
ImportVector
;
static
const
uint32_t
MemoryExport
=
UINT32_MAX
;
struct
ExportMap
{
CacheableCharsVector
fieldNames
;
Uint32Vector
fieldsToExports
;
WASM_DECLARE_SERIALIZABLE
(
ExportMap
)
}
;
struct
DataSegment
{
uint32_t
memoryOffset
;
uint32_t
bytecodeOffset
;
uint32_t
length
;
}
;
typedef
Vector
<
DataSegment
0
SystemAllocPolicy
>
DataSegmentVector
;
class
Module
{
const
Bytes
code_
;
const
LinkData
linkData_
;
const
ImportVector
imports_
;
const
ExportMap
exportMap_
;
const
DataSegmentVector
dataSegments_
;
const
SharedMetadata
metadata_
;
const
SharedBytes
bytecode_
;
bool
instantiateMemory
(
JSContext
*
cx
MutableHandleWasmMemoryObject
memory
)
const
;
public
:
Module
(
Bytes
&
&
code
LinkData
&
&
linkData
ImportVector
&
&
imports
ExportMap
&
&
exportMap
DataSegmentVector
&
&
dataSegments
const
Metadata
&
metadata
const
ShareableBytes
&
bytecode
)
:
code_
(
Move
(
code
)
)
linkData_
(
Move
(
linkData
)
)
imports_
(
Move
(
imports
)
)
exportMap_
(
Move
(
exportMap
)
)
dataSegments_
(
Move
(
dataSegments
)
)
metadata_
(
&
metadata
)
bytecode_
(
&
bytecode
)
{
}
const
Metadata
&
metadata
(
)
const
{
return
*
metadata_
;
}
const
ImportVector
&
imports
(
)
const
{
return
imports_
;
}
bool
instantiate
(
JSContext
*
cx
Handle
<
FunctionVector
>
funcImports
HandleWasmMemoryObject
memoryImport
HandleWasmInstanceObject
instanceObj
)
const
;
size_t
serializedSize
(
)
const
;
uint8_t
*
serialize
(
uint8_t
*
cursor
)
const
;
static
const
uint8_t
*
deserialize
(
const
uint8_t
*
cursor
UniquePtr
<
Module
>
*
module
Metadata
*
maybeMetadata
=
nullptr
)
;
void
addSizeOfMisc
(
MallocSizeOf
mallocSizeOf
Metadata
:
:
SeenSet
*
seenMetadata
ShareableBytes
:
:
SeenSet
*
seenBytes
size_t
*
code
size_t
*
data
)
const
;
}
;
typedef
UniquePtr
<
Module
>
UniqueModule
;
extern
bool
IsExportedFunction
(
JSFunction
*
fun
)
;
extern
Instance
&
ExportedFunctionToInstance
(
JSFunction
*
fun
)
;
extern
uint32_t
ExportedFunctionToExportIndex
(
JSFunction
*
fun
)
;
}
}
#
endif
