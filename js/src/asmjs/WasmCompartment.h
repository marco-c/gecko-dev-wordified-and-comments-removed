#
ifndef
wasm_compartment_h
#
define
wasm_compartment_h
#
include
"
asmjs
/
WasmJS
.
h
"
namespace
js
{
class
WasmActivation
;
namespace
wasm
{
class
Code
;
class
Compartment
{
using
InstanceObjectSet
=
GCHashSet
<
ReadBarriered
<
WasmInstanceObject
*
>
MovableCellHasher
<
ReadBarriered
<
WasmInstanceObject
*
>
>
SystemAllocPolicy
>
;
using
WeakInstanceObjectSet
=
JS
:
:
WeakCache
<
InstanceObjectSet
>
;
using
InstanceVector
=
Vector
<
Instance
*
0
SystemAllocPolicy
>
;
InstanceVector
instances_
;
volatile
bool
mutatingInstances_
;
WeakInstanceObjectSet
instanceObjects_
;
size_t
activationCount_
;
bool
profilingEnabled_
;
friend
class
js
:
:
WasmActivation
;
struct
AutoMutateInstances
{
Compartment
&
c
;
explicit
AutoMutateInstances
(
Compartment
&
c
)
:
c
(
c
)
{
MOZ_ASSERT
(
!
c
.
mutatingInstances_
)
;
c
.
mutatingInstances_
=
true
;
}
~
AutoMutateInstances
(
)
{
MOZ_ASSERT
(
c
.
mutatingInstances_
)
;
c
.
mutatingInstances_
=
false
;
}
}
;
public
:
explicit
Compartment
(
Zone
*
zone
)
;
~
Compartment
(
)
;
void
trace
(
JSTracer
*
trc
)
;
bool
registerInstance
(
JSContext
*
cx
HandleWasmInstanceObject
instanceObj
)
;
void
unregisterInstance
(
Instance
&
instance
)
;
const
WeakInstanceObjectSet
&
instanceObjects
(
)
const
{
return
instanceObjects_
;
}
Code
*
lookupCode
(
const
void
*
pc
)
const
;
Instance
*
lookupInstanceDeprecated
(
const
void
*
pc
)
const
;
bool
ensureProfilingState
(
JSContext
*
cx
)
;
bool
profilingEnabled
(
)
const
;
void
addSizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
size_t
*
compartmentTables
)
;
}
;
}
}
#
endif
