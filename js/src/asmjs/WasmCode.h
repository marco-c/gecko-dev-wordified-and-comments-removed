#
ifndef
wasm_code_h
#
define
wasm_code_h
#
include
"
asmjs
/
WasmBinaryToExperimentalText
.
h
"
#
include
"
asmjs
/
WasmTypes
.
h
"
namespace
js
{
struct
AsmJSMetadata
;
namespace
wasm
{
struct
LinkData
;
struct
Metadata
;
class
CodeSegment
;
typedef
UniquePtr
<
CodeSegment
>
UniqueCodeSegment
;
class
CodeSegment
{
uint8_t
*
bytes_
;
uint32_t
functionCodeLength_
;
uint32_t
codeLength_
;
uint32_t
globalDataLength_
;
uint8_t
*
interruptCode_
;
uint8_t
*
badIndirectCallCode_
;
uint8_t
*
outOfBoundsCode_
;
uint8_t
*
unalignedAccessCode_
;
bool
profilingEnabled_
;
CodeSegment
(
)
{
PodZero
(
this
)
;
}
template
<
class
>
friend
struct
js
:
:
MallocProvider
;
CodeSegment
(
const
CodeSegment
&
)
=
delete
;
CodeSegment
(
CodeSegment
&
&
)
=
delete
;
void
operator
=
(
const
CodeSegment
&
)
=
delete
;
void
operator
=
(
CodeSegment
&
&
)
=
delete
;
public
:
static
UniqueCodeSegment
create
(
JSContext
*
cx
const
Bytes
&
code
const
LinkData
&
linkData
const
Metadata
&
metadata
HandleWasmMemoryObject
memory
)
;
~
CodeSegment
(
)
;
uint8_t
*
base
(
)
const
{
return
bytes_
;
}
uint8_t
*
globalData
(
)
const
{
return
bytes_
+
codeLength_
;
}
uint32_t
codeLength
(
)
const
{
return
codeLength_
;
}
uint32_t
globalDataLength
(
)
const
{
return
globalDataLength_
;
}
uint32_t
totalLength
(
)
const
{
return
codeLength_
+
globalDataLength_
;
}
uint8_t
*
interruptCode
(
)
const
{
return
interruptCode_
;
}
uint8_t
*
badIndirectCallCode
(
)
const
{
return
badIndirectCallCode_
;
}
uint8_t
*
outOfBoundsCode
(
)
const
{
return
outOfBoundsCode_
;
}
uint8_t
*
unalignedAccessCode
(
)
const
{
return
unalignedAccessCode_
;
}
bool
containsFunctionPC
(
const
void
*
pc
)
const
{
return
pc
>
=
base
(
)
&
&
pc
<
(
base
(
)
+
functionCodeLength_
)
;
}
bool
containsCodePC
(
const
void
*
pc
)
const
{
return
pc
>
=
base
(
)
&
&
pc
<
(
base
(
)
+
codeLength_
)
;
}
}
;
struct
ShareableBytes
:
ShareableBase
<
ShareableBytes
>
{
Bytes
bytes
;
size_t
sizeOfExcludingThis
(
MallocSizeOf
m
)
const
{
return
bytes
.
sizeOfExcludingThis
(
m
)
;
}
const
uint8_t
*
begin
(
)
const
{
return
bytes
.
begin
(
)
;
}
const
uint8_t
*
end
(
)
const
{
return
bytes
.
end
(
)
;
}
bool
append
(
const
uint8_t
*
p
uint32_t
ct
)
{
return
bytes
.
append
(
p
ct
)
;
}
}
;
typedef
RefPtr
<
ShareableBytes
>
MutableBytes
;
typedef
RefPtr
<
const
ShareableBytes
>
SharedBytes
;
class
FuncExport
{
Sig
sig_
;
struct
CacheablePod
{
uint32_t
funcIndex_
;
uint32_t
entryOffset_
;
uint32_t
tableEntryOffset_
;
}
pod
;
public
:
FuncExport
(
)
=
default
;
explicit
FuncExport
(
Sig
&
&
sig
uint32_t
funcIndex
uint32_t
tableEntryOffset
)
:
sig_
(
Move
(
sig
)
)
{
pod
.
funcIndex_
=
funcIndex
;
pod
.
entryOffset_
=
UINT32_MAX
;
pod
.
tableEntryOffset_
=
tableEntryOffset
;
}
void
initEntryOffset
(
uint32_t
entryOffset
)
{
MOZ_ASSERT
(
pod
.
entryOffset_
=
=
UINT32_MAX
)
;
pod
.
entryOffset_
=
entryOffset
;
}
const
Sig
&
sig
(
)
const
{
return
sig_
;
}
uint32_t
funcIndex
(
)
const
{
return
pod
.
funcIndex_
;
}
uint32_t
entryOffset
(
)
const
{
MOZ_ASSERT
(
pod
.
entryOffset_
!
=
UINT32_MAX
)
;
return
pod
.
entryOffset_
;
}
uint32_t
tableEntryOffset
(
)
const
{
return
pod
.
tableEntryOffset_
;
}
WASM_DECLARE_SERIALIZABLE
(
FuncExport
)
}
;
typedef
Vector
<
FuncExport
0
SystemAllocPolicy
>
FuncExportVector
;
class
FuncImport
{
Sig
sig_
;
struct
CacheablePod
{
uint32_t
tlsDataOffset_
;
uint32_t
interpExitCodeOffset_
;
uint32_t
jitExitCodeOffset_
;
}
pod
;
public
:
FuncImport
(
)
{
memset
(
&
pod
0
sizeof
(
CacheablePod
)
)
;
}
FuncImport
(
Sig
&
&
sig
uint32_t
tlsDataOffset
)
:
sig_
(
Move
(
sig
)
)
{
pod
.
tlsDataOffset_
=
tlsDataOffset
;
pod
.
interpExitCodeOffset_
=
0
;
pod
.
jitExitCodeOffset_
=
0
;
}
void
initInterpExitOffset
(
uint32_t
off
)
{
MOZ_ASSERT
(
!
pod
.
interpExitCodeOffset_
)
;
pod
.
interpExitCodeOffset_
=
off
;
}
void
initJitExitOffset
(
uint32_t
off
)
{
MOZ_ASSERT
(
!
pod
.
jitExitCodeOffset_
)
;
pod
.
jitExitCodeOffset_
=
off
;
}
const
Sig
&
sig
(
)
const
{
return
sig_
;
}
uint32_t
tlsDataOffset
(
)
const
{
return
pod
.
tlsDataOffset_
;
}
uint32_t
interpExitCodeOffset
(
)
const
{
return
pod
.
interpExitCodeOffset_
;
}
uint32_t
jitExitCodeOffset
(
)
const
{
return
pod
.
jitExitCodeOffset_
;
}
WASM_DECLARE_SERIALIZABLE
(
FuncImport
)
}
;
typedef
Vector
<
FuncImport
0
SystemAllocPolicy
>
FuncImportVector
;
enum
class
TableKind
{
AnyFunction
TypedFunction
}
;
struct
TableDesc
{
TableKind
kind
;
uint32_t
globalDataOffset
;
uint32_t
initial
;
uint32_t
maximum
;
TableDesc
(
)
{
PodZero
(
this
)
;
}
explicit
TableDesc
(
TableKind
kind
)
:
kind
(
kind
)
globalDataOffset
(
0
)
initial
(
0
)
maximum
(
0
)
{
}
}
;
WASM_DECLARE_POD_VECTOR
(
TableDesc
TableDescVector
)
class
CodeRange
{
public
:
enum
Kind
{
Function
Entry
ImportJitExit
ImportInterpExit
Inline
CallThunk
}
;
private
:
uint32_t
begin_
;
uint32_t
profilingReturn_
;
uint32_t
end_
;
uint32_t
funcIndex_
;
uint32_t
funcLineOrBytecode_
;
uint8_t
funcBeginToTableEntry_
;
uint8_t
funcBeginToTableProfilingJump_
;
uint8_t
funcBeginToNonProfilingEntry_
;
uint8_t
funcProfilingJumpToProfilingReturn_
;
uint8_t
funcProfilingEpilogueToProfilingReturn_
;
Kind
kind_
:
8
;
public
:
CodeRange
(
)
=
default
;
CodeRange
(
Kind
kind
Offsets
offsets
)
;
CodeRange
(
Kind
kind
ProfilingOffsets
offsets
)
;
CodeRange
(
uint32_t
funcIndex
uint32_t
lineOrBytecode
FuncOffsets
offsets
)
;
uint32_t
begin
(
)
const
{
return
begin_
;
}
uint32_t
end
(
)
const
{
return
end_
;
}
Kind
kind
(
)
const
{
return
kind_
;
}
bool
isFunction
(
)
const
{
return
kind
(
)
=
=
Function
;
}
bool
isImportExit
(
)
const
{
return
kind
(
)
=
=
ImportJitExit
|
|
kind
(
)
=
=
ImportInterpExit
;
}
bool
isInline
(
)
const
{
return
kind
(
)
=
=
Inline
;
}
uint32_t
profilingReturn
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
|
|
isImportExit
(
)
)
;
return
profilingReturn_
;
}
uint32_t
funcProfilingEntry
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin
(
)
;
}
uint32_t
funcTableEntry
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin_
+
funcBeginToTableEntry_
;
}
uint32_t
funcTableProfilingJump
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin_
+
funcBeginToTableProfilingJump_
;
}
uint32_t
funcNonProfilingEntry
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin_
+
funcBeginToNonProfilingEntry_
;
}
uint32_t
funcProfilingJump
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
profilingReturn_
-
funcProfilingJumpToProfilingReturn_
;
}
uint32_t
funcProfilingEpilogue
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
profilingReturn_
-
funcProfilingEpilogueToProfilingReturn_
;
}
uint32_t
funcIndex
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
funcIndex_
;
}
uint32_t
funcLineOrBytecode
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
funcLineOrBytecode_
;
}
struct
PC
{
size_t
offset
;
explicit
PC
(
size_t
offset
)
:
offset
(
offset
)
{
}
bool
operator
=
=
(
const
CodeRange
&
rhs
)
const
{
return
offset
>
=
rhs
.
begin
(
)
&
&
offset
<
rhs
.
end
(
)
;
}
bool
operator
<
(
const
CodeRange
&
rhs
)
const
{
return
offset
<
rhs
.
begin
(
)
;
}
}
;
}
;
WASM_DECLARE_POD_VECTOR
(
CodeRange
CodeRangeVector
)
struct
CallThunk
{
uint32_t
offset
;
union
{
uint32_t
funcIndex
;
uint32_t
codeRangeIndex
;
}
u
;
CallThunk
(
uint32_t
offset
uint32_t
funcIndex
)
:
offset
(
offset
)
{
u
.
funcIndex
=
funcIndex
;
}
CallThunk
(
)
=
default
;
}
;
WASM_DECLARE_POD_VECTOR
(
CallThunk
CallThunkVector
)
struct
CacheableChars
:
UniqueChars
{
CacheableChars
(
)
=
default
;
explicit
CacheableChars
(
char
*
ptr
)
:
UniqueChars
(
ptr
)
{
}
MOZ_IMPLICIT
CacheableChars
(
UniqueChars
&
&
rhs
)
:
UniqueChars
(
Move
(
rhs
)
)
{
}
WASM_DECLARE_SERIALIZABLE
(
CacheableChars
)
}
;
typedef
Vector
<
CacheableChars
0
SystemAllocPolicy
>
CacheableCharsVector
;
enum
class
MemoryUsage
{
None
=
false
Unshared
=
1
Shared
=
2
}
;
static
inline
bool
UsesMemory
(
MemoryUsage
memoryUsage
)
{
return
bool
(
memoryUsage
)
;
}
struct
NameInBytecode
{
uint32_t
offset
;
uint32_t
length
;
NameInBytecode
(
)
=
default
;
NameInBytecode
(
uint32_t
offset
uint32_t
length
)
:
offset
(
offset
)
length
(
length
)
{
}
}
;
typedef
Vector
<
NameInBytecode
0
SystemAllocPolicy
>
NameInBytecodeVector
;
typedef
Vector
<
char16_t
64
>
TwoByteName
;
class
MetadataCacheablePod
{
static
const
uint32_t
NO_START_FUNCTION
=
UINT32_MAX
;
static_assert
(
NO_START_FUNCTION
>
MaxFuncs
"
sentinel
value
"
)
;
uint32_t
startFuncIndex_
;
public
:
ModuleKind
kind
;
MemoryUsage
memoryUsage
;
uint32_t
minMemoryLength
;
uint32_t
maxMemoryLength
;
MetadataCacheablePod
(
)
{
mozilla
:
:
PodZero
(
this
)
;
startFuncIndex_
=
NO_START_FUNCTION
;
}
bool
hasStartFunction
(
)
const
{
return
startFuncIndex_
!
=
NO_START_FUNCTION
;
}
void
initStartFuncIndex
(
uint32_t
i
)
{
MOZ_ASSERT
(
!
hasStartFunction
(
)
)
;
startFuncIndex_
=
i
;
MOZ_ASSERT
(
hasStartFunction
(
)
)
;
}
uint32_t
startFuncIndex
(
)
const
{
MOZ_ASSERT
(
hasStartFunction
(
)
)
;
return
startFuncIndex_
;
}
}
;
struct
Metadata
:
ShareableBase
<
Metadata
>
MetadataCacheablePod
{
virtual
~
Metadata
(
)
{
}
MetadataCacheablePod
&
pod
(
)
{
return
*
this
;
}
const
MetadataCacheablePod
&
pod
(
)
const
{
return
*
this
;
}
FuncImportVector
funcImports
;
FuncExportVector
funcExports
;
SigWithIdVector
sigIds
;
GlobalDescVector
globals
;
TableDescVector
tables
;
MemoryAccessVector
memoryAccesses
;
BoundsCheckVector
boundsChecks
;
CodeRangeVector
codeRanges
;
CallSiteVector
callSites
;
CallThunkVector
callThunks
;
NameInBytecodeVector
funcNames
;
CacheableChars
filename
;
Assumptions
assumptions
;
bool
usesMemory
(
)
const
{
return
UsesMemory
(
memoryUsage
)
;
}
bool
hasSharedMemory
(
)
const
{
return
memoryUsage
=
=
MemoryUsage
:
:
Shared
;
}
const
FuncExport
&
lookupFuncExport
(
uint32_t
funcIndex
)
const
;
bool
isAsmJS
(
)
const
{
return
kind
=
=
ModuleKind
:
:
AsmJS
;
}
const
AsmJSMetadata
&
asAsmJS
(
)
const
{
MOZ_ASSERT
(
isAsmJS
(
)
)
;
return
*
(
const
AsmJSMetadata
*
)
this
;
}
virtual
bool
mutedErrors
(
)
const
{
return
false
;
}
virtual
const
char16_t
*
displayURL
(
)
const
{
return
nullptr
;
}
virtual
ScriptSource
*
maybeScriptSource
(
)
const
{
return
nullptr
;
}
virtual
bool
getFuncName
(
JSContext
*
cx
const
Bytes
*
maybeBytecode
uint32_t
funcIndex
TwoByteName
*
name
)
const
;
WASM_DECLARE_SERIALIZABLE_VIRTUAL
(
Metadata
)
;
}
;
typedef
RefPtr
<
Metadata
>
MutableMetadata
;
typedef
RefPtr
<
const
Metadata
>
SharedMetadata
;
class
Code
{
const
UniqueCodeSegment
segment_
;
const
SharedMetadata
metadata_
;
const
SharedBytes
maybeBytecode_
;
UniqueGeneratedSourceMap
maybeSourceMap_
;
CacheableCharsVector
funcLabels_
;
bool
profilingEnabled_
;
public
:
Code
(
UniqueCodeSegment
segment
const
Metadata
&
metadata
const
ShareableBytes
*
maybeBytecode
)
;
const
CodeSegment
&
segment
(
)
const
{
return
*
segment_
;
}
const
Metadata
&
metadata
(
)
const
{
return
*
metadata_
;
}
const
CallSite
*
lookupCallSite
(
void
*
returnAddress
)
const
;
const
CodeRange
*
lookupRange
(
void
*
pc
)
const
;
#
ifdef
ASMJS_MAY_USE_SIGNAL_HANDLERS
const
MemoryAccess
*
lookupMemoryAccess
(
void
*
pc
)
const
;
#
endif
bool
getFuncName
(
JSContext
*
cx
uint32_t
funcIndex
TwoByteName
*
name
)
const
;
JSAtom
*
getFuncAtom
(
JSContext
*
cx
uint32_t
funcIndex
)
const
;
JSString
*
createText
(
JSContext
*
cx
)
;
bool
getLineOffsets
(
size_t
lineno
Vector
<
uint32_t
>
&
offsets
)
const
;
MOZ_MUST_USE
bool
ensureProfilingState
(
JSContext
*
cx
bool
enabled
)
;
bool
profilingEnabled
(
)
const
{
return
profilingEnabled_
;
}
const
char
*
profilingLabel
(
uint32_t
funcIndex
)
const
{
return
funcLabels_
[
funcIndex
]
.
get
(
)
;
}
void
addSizeOfMisc
(
MallocSizeOf
mallocSizeOf
Metadata
:
:
SeenSet
*
seenMetadata
ShareableBytes
:
:
SeenSet
*
seenBytes
size_t
*
code
size_t
*
data
)
const
;
WASM_DECLARE_SERIALIZABLE
(
Code
)
;
}
;
typedef
UniquePtr
<
Code
>
UniqueCode
;
}
}
#
endif
