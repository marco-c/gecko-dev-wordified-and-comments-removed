#
ifndef
wasm_generator_h
#
define
wasm_generator_h
#
include
"
asmjs
/
WasmBinary
.
h
"
#
include
"
asmjs
/
WasmIonCompile
.
h
"
#
include
"
asmjs
/
WasmModule
.
h
"
#
include
"
jit
/
MacroAssembler
.
h
"
namespace
js
{
namespace
wasm
{
class
FunctionGenerator
;
struct
SlowFunction
{
SlowFunction
(
uint32_t
index
unsigned
ms
unsigned
lineOrBytecode
)
:
index
(
index
)
ms
(
ms
)
lineOrBytecode
(
lineOrBytecode
)
{
}
static
const
unsigned
msThreshold
=
250
;
uint32_t
index
;
unsigned
ms
;
unsigned
lineOrBytecode
;
}
;
typedef
Vector
<
SlowFunction
>
SlowFunctionVector
;
struct
ModuleImportGeneratorData
{
const
DeclaredSig
*
sig
;
uint32_t
globalDataOffset
;
ModuleImportGeneratorData
(
)
:
sig
(
nullptr
)
globalDataOffset
(
0
)
{
}
explicit
ModuleImportGeneratorData
(
const
DeclaredSig
*
sig
)
:
sig
(
sig
)
globalDataOffset
(
0
)
{
}
}
;
typedef
Vector
<
ModuleImportGeneratorData
0
SystemAllocPolicy
>
ModuleImportGeneratorDataVector
;
struct
AsmJSGlobalVariable
{
ExprType
type
;
unsigned
globalDataOffset
;
bool
isConst
;
AsmJSGlobalVariable
(
ExprType
type
unsigned
offset
bool
isConst
)
:
type
(
type
)
globalDataOffset
(
offset
)
isConst
(
isConst
)
{
}
}
;
typedef
Vector
<
AsmJSGlobalVariable
0
SystemAllocPolicy
>
AsmJSGlobalVariableVector
;
struct
ModuleGeneratorData
{
DeclaredSigVector
sigs
;
DeclaredSigPtrVector
funcSigs
;
ModuleImportGeneratorDataVector
imports
;
AsmJSGlobalVariableVector
globals
;
}
;
typedef
UniquePtr
<
ModuleGeneratorData
>
UniqueModuleGeneratorData
;
class
ModuleGeneratorThreadView
{
const
ModuleGeneratorData
&
shared_
;
public
:
explicit
ModuleGeneratorThreadView
(
const
ModuleGeneratorData
&
shared
)
:
shared_
(
shared
)
{
}
const
DeclaredSig
&
sig
(
uint32_t
sigIndex
)
const
{
return
shared_
.
sigs
[
sigIndex
]
;
}
const
DeclaredSig
&
funcSig
(
uint32_t
funcIndex
)
const
{
MOZ_ASSERT
(
shared_
.
funcSigs
[
funcIndex
]
)
;
return
*
shared_
.
funcSigs
[
funcIndex
]
;
}
const
ModuleImportGeneratorData
&
import
(
uint32_t
importIndex
)
const
{
MOZ_ASSERT
(
shared_
.
imports
[
importIndex
]
.
sig
)
;
return
shared_
.
imports
[
importIndex
]
;
}
const
AsmJSGlobalVariable
&
globalVar
(
uint32_t
globalIndex
)
const
{
return
shared_
.
globals
[
globalIndex
]
;
}
}
;
class
MOZ_STACK_CLASS
ModuleGenerator
{
typedef
UniquePtr
<
ModuleGeneratorThreadView
>
UniqueModuleGeneratorThreadView
;
typedef
HashMap
<
uint32_t
uint32_t
>
FuncIndexMap
;
ExclusiveContext
*
cx_
;
jit
:
:
JitContext
jcx_
;
UniqueModuleData
module_
;
UniqueStaticLinkData
link_
;
UniqueExportMap
exportMap_
;
SlowFunctionVector
slowFuncs_
;
UniqueModuleGeneratorData
shared_
;
uint32_t
numSigs_
;
LifoAlloc
lifo_
;
jit
:
:
TempAllocator
alloc_
;
jit
:
:
MacroAssembler
masm_
;
Uint32Vector
funcEntryOffsets_
;
FuncIndexMap
funcIndexToExport_
;
bool
parallel_
;
uint32_t
outstanding_
;
UniqueModuleGeneratorThreadView
threadView_
;
Vector
<
IonCompileTask
>
tasks_
;
Vector
<
IonCompileTask
*
>
freeTasks_
;
DebugOnly
<
FunctionGenerator
*
>
activeFunc_
;
DebugOnly
<
bool
>
finishedFuncs_
;
bool
finishOutstandingTask
(
)
;
bool
funcIsDefined
(
uint32_t
funcIndex
)
const
;
bool
finishTask
(
IonCompileTask
*
task
)
;
bool
addImport
(
const
Sig
&
sig
uint32_t
globalDataOffset
)
;
bool
startedFuncDefs
(
)
const
{
return
!
!
threadView_
;
}
bool
allocateGlobalBytes
(
uint32_t
bytes
uint32_t
align
uint32_t
*
globalDataOffset
)
;
public
:
explicit
ModuleGenerator
(
ExclusiveContext
*
cx
)
;
~
ModuleGenerator
(
)
;
bool
init
(
UniqueModuleGeneratorData
shared
UniqueChars
filename
ModuleKind
=
ModuleKind
:
:
Wasm
)
;
bool
isAsmJS
(
)
const
{
return
module_
-
>
kind
=
=
ModuleKind
:
:
AsmJS
;
}
CompileArgs
args
(
)
const
{
return
module_
-
>
compileArgs
;
}
jit
:
:
MacroAssembler
&
masm
(
)
{
return
masm_
;
}
bool
allocateGlobalVar
(
ValType
type
bool
isConst
uint32_t
*
index
)
;
const
AsmJSGlobalVariable
&
globalVar
(
unsigned
index
)
const
{
return
shared_
-
>
globals
[
index
]
;
}
void
initHeapUsage
(
HeapUsage
heapUsage
)
;
bool
usesHeap
(
)
const
;
void
initSig
(
uint32_t
sigIndex
Sig
&
&
sig
)
;
uint32_t
numSigs
(
)
const
{
return
numSigs_
;
}
const
DeclaredSig
&
sig
(
uint32_t
sigIndex
)
const
;
bool
initFuncSig
(
uint32_t
funcIndex
uint32_t
sigIndex
)
;
uint32_t
numFuncSigs
(
)
const
{
return
module_
-
>
numFuncs
;
}
const
DeclaredSig
&
funcSig
(
uint32_t
funcIndex
)
const
;
bool
initImport
(
uint32_t
importIndex
uint32_t
sigIndex
)
;
uint32_t
numImports
(
)
const
;
const
ModuleImportGeneratorData
&
import
(
uint32_t
index
)
const
;
bool
defineImport
(
uint32_t
index
ProfilingOffsets
interpExit
ProfilingOffsets
jitExit
)
;
bool
declareExport
(
UniqueChars
fieldName
uint32_t
funcIndex
uint32_t
*
exportIndex
=
nullptr
)
;
uint32_t
numExports
(
)
const
;
uint32_t
exportFuncIndex
(
uint32_t
index
)
const
;
uint32_t
exportEntryOffset
(
uint32_t
index
)
const
;
const
Sig
&
exportSig
(
uint32_t
index
)
const
;
bool
defineExport
(
uint32_t
index
Offsets
offsets
)
;
bool
addMemoryExport
(
UniqueChars
fieldName
)
;
bool
startFuncDefs
(
)
;
bool
startFuncDef
(
uint32_t
lineOrBytecode
FunctionGenerator
*
fg
)
;
bool
finishFuncDef
(
uint32_t
funcIndex
unsigned
generateTime
FunctionGenerator
*
fg
)
;
bool
finishFuncDefs
(
)
;
bool
declareFuncPtrTable
(
uint32_t
numElems
uint32_t
*
index
)
;
uint32_t
funcPtrTableGlobalDataOffset
(
uint32_t
index
)
const
;
void
defineFuncPtrTable
(
uint32_t
index
const
Vector
<
uint32_t
>
&
elemFuncIndices
)
;
bool
defineInlineStub
(
Offsets
offsets
)
;
void
defineInterruptExit
(
uint32_t
offset
)
;
void
defineOutOfBoundsExit
(
uint32_t
offset
)
;
bool
finish
(
CacheableCharsVector
&
&
prettyFuncNames
UniqueModuleData
*
module
UniqueStaticLinkData
*
staticLinkData
UniqueExportMap
*
exportMap
SlowFunctionVector
*
slowFuncs
)
;
}
;
class
MOZ_STACK_CLASS
FunctionGenerator
{
friend
class
ModuleGenerator
;
ModuleGenerator
*
m_
;
IonCompileTask
*
task_
;
UniqueBytecode
bytecode_
;
Uint32Vector
callSiteLineNums_
;
ValTypeVector
locals_
;
uint32_t
lineOrBytecode_
;
public
:
FunctionGenerator
(
)
:
m_
(
nullptr
)
task_
(
nullptr
)
lineOrBytecode_
(
0
)
{
}
Bytecode
&
bytecode
(
)
const
{
return
*
bytecode_
;
}
bool
addCallSiteLineNum
(
uint32_t
lineno
)
{
return
callSiteLineNums_
.
append
(
lineno
)
;
}
bool
addLocal
(
ValType
v
)
{
return
locals_
.
append
(
v
)
;
}
const
ValTypeVector
&
locals
(
)
const
{
return
locals_
;
}
}
;
}
}
#
endif
