#
include
"
jscompartment
.
h
"
#
include
"
jsfriendapi
.
h
"
#
include
"
jsstr
.
h
"
#
include
"
builtin
/
TestingFunctions
.
h
"
#
include
"
jsapi
-
tests
/
tests
.
h
"
#
include
"
vm
/
ArrayObject
.
h
"
#
include
"
vm
/
SavedStacks
.
h
"
BEGIN_TEST
(
testSavedStacks_withNoStack
)
{
JSCompartment
*
compartment
=
js
:
:
GetContextCompartment
(
cx
)
;
compartment
-
>
setAllocationMetadataBuilder
(
&
js
:
:
SavedStacks
:
:
metadataBuilder
)
;
JS
:
:
RootedObject
obj
(
cx
js
:
:
NewDenseEmptyArray
(
cx
)
)
;
compartment
-
>
setAllocationMetadataBuilder
(
nullptr
)
;
return
true
;
}
END_TEST
(
testSavedStacks_withNoStack
)
BEGIN_TEST
(
testSavedStacks_ApiDefaultValues
)
{
js
:
:
RootedSavedFrame
savedFrame
(
cx
nullptr
)
;
JS
:
:
RootedString
str
(
cx
)
;
JS
:
:
SavedFrameResult
result
=
JS
:
:
GetSavedFrameSource
(
cx
savedFrame
&
str
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
AccessDenied
)
;
CHECK
(
str
.
get
(
)
=
=
cx
-
>
runtime
(
)
-
>
emptyString
)
;
uint32_t
line
=
123
;
result
=
JS
:
:
GetSavedFrameLine
(
cx
savedFrame
&
line
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
AccessDenied
)
;
CHECK
(
line
=
=
0
)
;
uint32_t
column
=
123
;
result
=
JS
:
:
GetSavedFrameColumn
(
cx
savedFrame
&
column
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
AccessDenied
)
;
CHECK
(
column
=
=
0
)
;
result
=
JS
:
:
GetSavedFrameFunctionDisplayName
(
cx
savedFrame
&
str
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
AccessDenied
)
;
CHECK
(
str
.
get
(
)
=
=
nullptr
)
;
JS
:
:
RootedObject
parent
(
cx
)
;
result
=
JS
:
:
GetSavedFrameParent
(
cx
savedFrame
&
parent
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
AccessDenied
)
;
CHECK
(
parent
.
get
(
)
=
=
nullptr
)
;
CHECK
(
JS
:
:
BuildStackString
(
cx
savedFrame
&
str
)
)
;
CHECK
(
str
.
get
(
)
=
=
cx
-
>
runtime
(
)
-
>
emptyString
)
;
return
true
;
}
END_TEST
(
testSavedStacks_ApiDefaultValues
)
BEGIN_TEST
(
testSavedStacks_RangeBasedForLoops
)
{
CHECK
(
js
:
:
DefineTestingFunctions
(
cx
global
false
false
)
)
;
JS
:
:
RootedValue
val
(
cx
)
;
CHECK
(
evaluate
(
"
(
function
one
(
)
{
\
n
"
"
return
(
function
two
(
)
{
\
n
"
"
return
(
function
three
(
)
{
\
n
"
"
return
saveStack
(
)
;
\
n
"
"
}
(
)
)
;
\
n
"
"
}
(
)
)
;
\
n
"
"
}
(
)
)
;
\
n
"
"
filename
.
js
"
1
&
val
)
)
;
CHECK
(
val
.
isObject
(
)
)
;
JS
:
:
RootedObject
obj
(
cx
&
val
.
toObject
(
)
)
;
CHECK
(
obj
-
>
is
<
js
:
:
SavedFrame
>
(
)
)
;
JS
:
:
Rooted
<
js
:
:
SavedFrame
*
>
savedFrame
(
cx
&
obj
-
>
as
<
js
:
:
SavedFrame
>
(
)
)
;
js
:
:
SavedFrame
*
f
=
savedFrame
.
get
(
)
;
for
(
auto
&
frame
:
*
savedFrame
.
get
(
)
)
{
CHECK
(
&
frame
=
=
f
)
;
f
=
f
-
>
getParent
(
)
;
}
CHECK
(
f
=
=
nullptr
)
;
const
js
:
:
SavedFrame
*
cf
=
savedFrame
.
get
(
)
;
for
(
const
auto
&
frame
:
*
savedFrame
.
get
(
)
)
{
CHECK
(
&
frame
=
=
cf
)
;
cf
=
cf
-
>
getParent
(
)
;
}
CHECK
(
cf
=
=
nullptr
)
;
JS
:
:
Rooted
<
js
:
:
SavedFrame
*
>
rf
(
cx
savedFrame
)
;
for
(
JS
:
:
Handle
<
js
:
:
SavedFrame
*
>
frame
:
js
:
:
SavedFrame
:
:
RootedRange
(
cx
rf
)
)
{
JS_GC
(
cx
)
;
CHECK
(
frame
=
=
rf
)
;
rf
=
rf
-
>
getParent
(
)
;
}
CHECK
(
rf
=
=
nullptr
)
;
return
true
;
}
END_TEST
(
testSavedStacks_RangeBasedForLoops
)
BEGIN_TEST
(
testSavedStacks_selfHostedFrames
)
{
CHECK
(
js
:
:
DefineTestingFunctions
(
cx
global
false
false
)
)
;
JS
:
:
RootedValue
val
(
cx
)
;
CHECK
(
evaluate
(
"
(
function
one
(
)
{
\
n
"
"
try
{
\
n
"
"
[
1
]
.
map
(
function
two
(
)
{
\
n
"
"
throw
saveStack
(
)
;
\
n
"
"
}
)
;
\
n
"
"
}
catch
(
stack
)
{
\
n
"
"
return
stack
;
\
n
"
"
}
\
n
"
"
}
(
)
)
\
n
"
"
filename
.
js
"
1
&
val
)
)
;
CHECK
(
val
.
isObject
(
)
)
;
JS
:
:
RootedObject
obj
(
cx
&
val
.
toObject
(
)
)
;
CHECK
(
obj
-
>
is
<
js
:
:
SavedFrame
>
(
)
)
;
JS
:
:
Rooted
<
js
:
:
SavedFrame
*
>
savedFrame
(
cx
&
obj
-
>
as
<
js
:
:
SavedFrame
>
(
)
)
;
JS
:
:
Rooted
<
js
:
:
SavedFrame
*
>
selfHostedFrame
(
cx
savedFrame
-
>
getParent
(
)
)
;
CHECK
(
selfHostedFrame
-
>
isSelfHosted
(
cx
)
)
;
JS
:
:
RootedString
str
(
cx
)
;
JS
:
:
SavedFrameResult
result
=
JS
:
:
GetSavedFrameSource
(
cx
selfHostedFrame
&
str
JS
:
:
SavedFrameSelfHosted
:
:
Exclude
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
Ok
)
;
JSLinearString
*
lin
=
str
-
>
ensureLinear
(
cx
)
;
CHECK
(
lin
)
;
CHECK
(
js
:
:
StringEqualsAscii
(
lin
"
filename
.
js
"
)
)
;
result
=
JS
:
:
GetSavedFrameSource
(
cx
selfHostedFrame
&
str
JS
:
:
SavedFrameSelfHosted
:
:
Include
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
Ok
)
;
lin
=
str
-
>
ensureLinear
(
cx
)
;
CHECK
(
lin
)
;
CHECK
(
js
:
:
StringEqualsAscii
(
lin
"
self
-
hosted
"
)
)
;
uint32_t
line
=
123
;
result
=
JS
:
:
GetSavedFrameLine
(
cx
selfHostedFrame
&
line
JS
:
:
SavedFrameSelfHosted
:
:
Exclude
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
Ok
)
;
CHECK_EQUAL
(
line
3U
)
;
uint32_t
column
=
123
;
result
=
JS
:
:
GetSavedFrameColumn
(
cx
selfHostedFrame
&
column
JS
:
:
SavedFrameSelfHosted
:
:
Exclude
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
Ok
)
;
CHECK_EQUAL
(
column
5U
)
;
result
=
JS
:
:
GetSavedFrameFunctionDisplayName
(
cx
selfHostedFrame
&
str
JS
:
:
SavedFrameSelfHosted
:
:
Exclude
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
Ok
)
;
lin
=
str
-
>
ensureLinear
(
cx
)
;
CHECK
(
lin
)
;
CHECK
(
js
:
:
StringEqualsAscii
(
lin
"
one
"
)
)
;
JS
:
:
RootedObject
parent
(
cx
)
;
result
=
JS
:
:
GetSavedFrameParent
(
cx
savedFrame
&
parent
JS
:
:
SavedFrameSelfHosted
:
:
Exclude
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
Ok
)
;
result
=
JS
:
:
GetSavedFrameSource
(
cx
parent
&
str
JS
:
:
SavedFrameSelfHosted
:
:
Exclude
)
;
CHECK
(
result
=
=
JS
:
:
SavedFrameResult
:
:
Ok
)
;
lin
=
str
-
>
ensureLinear
(
cx
)
;
CHECK
(
lin
)
;
CHECK
(
js
:
:
StringEqualsAscii
(
lin
"
filename
.
js
"
)
)
;
return
true
;
}
END_TEST
(
testSavedStacks_selfHostedFrames
)
