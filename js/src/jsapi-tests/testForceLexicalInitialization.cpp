#
include
"
jsfriendapi
.
h
"
#
include
"
jsapi
-
tests
/
tests
.
h
"
#
include
"
vm
/
EnvironmentObject
.
h
"
BEGIN_TEST
(
testForceLexicalInitialization
)
{
js
:
:
RootedGlobalObject
g
(
cx
cx
-
>
global
(
)
)
;
JS
:
:
Rooted
<
js
:
:
LexicalEnvironmentObject
*
>
env
(
cx
js
:
:
LexicalEnvironmentObject
:
:
createGlobal
(
cx
g
)
)
;
JS
:
:
RootedValue
uninitialized
(
cx
JS
:
:
MagicValue
(
JS_UNINITIALIZED_LEXICAL
)
)
;
js
:
:
RootedPropertyName
name
(
cx
Atomize
(
cx
"
foopi
"
4
)
-
>
asPropertyName
(
)
)
;
JS
:
:
RootedId
id
(
cx
NameToId
(
name
)
)
;
unsigned
attrs
=
JSPROP_ENUMERATE
|
JSPROP_PERMANENT
;
CHECK
(
NativeDefineProperty
(
cx
env
id
uninitialized
nullptr
nullptr
attrs
)
)
;
const
JS
:
:
Value
v
=
env
-
>
getSlot
(
env
-
>
lookup
(
cx
id
)
-
>
slot
(
)
)
;
CHECK
(
v
.
isMagic
(
JS_UNINITIALIZED_LEXICAL
)
)
;
ForceLexicalInitialization
(
cx
env
)
;
const
JS
:
:
Value
v2
=
env
-
>
getSlot
(
env
-
>
lookup
(
cx
id
)
-
>
slot
(
)
)
;
CHECK
(
v2
.
isUndefined
(
)
)
;
return
true
;
}
END_TEST
(
testForceLexicalInitialization
)
