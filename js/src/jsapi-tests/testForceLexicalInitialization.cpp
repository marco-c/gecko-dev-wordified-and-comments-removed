#
include
"
jsfriendapi
.
h
"
#
include
"
jsapi
-
tests
/
tests
.
h
"
#
include
"
vm
/
EnvironmentObject
.
h
"
BEGIN_TEST
(
testForceLexicalInitialization
)
{
JS
:
:
Rooted
<
js
:
:
GlobalObject
*
>
g
(
cx
cx
-
>
global
(
)
)
;
JS
:
:
Rooted
<
js
:
:
GlobalLexicalEnvironmentObject
*
>
env
(
cx
js
:
:
GlobalLexicalEnvironmentObject
:
:
create
(
cx
g
)
)
;
JS
:
:
RootedValue
uninitialized
(
cx
JS
:
:
MagicValue
(
JS_UNINITIALIZED_LEXICAL
)
)
;
JS
:
:
Rooted
<
js
:
:
PropertyName
*
>
name
(
cx
Atomize
(
cx
"
foopi
"
4
)
-
>
asPropertyName
(
)
)
;
JS
:
:
RootedId
id
(
cx
NameToId
(
name
)
)
;
unsigned
attrs
=
JSPROP_ENUMERATE
|
JSPROP_PERMANENT
;
CHECK
(
NativeDefineDataProperty
(
cx
env
id
uninitialized
attrs
)
)
;
const
JS
:
:
Value
v
=
env
-
>
getSlot
(
env
-
>
lookup
(
cx
id
)
-
>
slot
(
)
)
;
CHECK
(
v
.
isMagic
(
JS_UNINITIALIZED_LEXICAL
)
)
;
ForceLexicalInitialization
(
cx
env
)
;
const
JS
:
:
Value
v2
=
env
-
>
getSlot
(
env
-
>
lookup
(
cx
id
)
-
>
slot
(
)
)
;
CHECK
(
v2
.
isUndefined
(
)
)
;
return
true
;
}
END_TEST
(
testForceLexicalInitialization
)
