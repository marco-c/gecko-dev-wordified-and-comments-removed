#
include
"
jsfriendapi
.
h
"
#
include
"
jsapi
-
tests
/
tests
.
h
"
#
include
"
vm
/
ScopeObject
.
h
"
BEGIN_TEST
(
testForceLexicalInitialization
)
{
js
:
:
RootedGlobalObject
g
(
cx
cx
-
>
global
(
)
)
;
JS
:
:
Rooted
<
js
:
:
ClonedBlockObject
*
>
scope
(
cx
js
:
:
ClonedBlockObject
:
:
createGlobal
(
cx
g
)
)
;
JS
:
:
RootedValue
uninitialized
(
cx
JS
:
:
MagicValue
(
JS_UNINITIALIZED_LEXICAL
)
)
;
js
:
:
RootedPropertyName
name
(
cx
Atomize
(
cx
"
foopi
"
4
)
-
>
asPropertyName
(
)
)
;
JS
:
:
RootedId
id
(
cx
NameToId
(
name
)
)
;
unsigned
attrs
=
JSPROP_ENUMERATE
|
JSPROP_PERMANENT
;
NativeDefineProperty
(
cx
scope
id
uninitialized
nullptr
nullptr
attrs
)
;
const
JS
:
:
Value
v
=
scope
-
>
getSlot
(
scope
-
>
lookup
(
cx
id
)
-
>
slot
(
)
)
;
CHECK
(
v
.
isMagic
(
JS_UNINITIALIZED_LEXICAL
)
)
;
ForceLexicalInitialization
(
cx
scope
)
;
const
JS
:
:
Value
v2
=
scope
-
>
getSlot
(
scope
-
>
lookup
(
cx
id
)
-
>
slot
(
)
)
;
CHECK
(
v2
.
isUndefined
(
)
)
;
return
true
;
}
END_TEST
(
testForceLexicalInitialization
)
