#
include
"
jsapi
-
tests
/
tests
.
h
"
using
namespace
JS
;
BEGIN_TEST
(
test_DeflateStringToUTF8Buffer
)
{
JSString
*
str
;
JSFlatString
*
flatStr
;
char
actual
[
100
]
;
mozilla
:
:
RangedPtr
<
char
>
range
=
mozilla
:
:
RangedPtr
<
char
>
(
actual
100
)
;
str
=
JS_NewStringCopyZ
(
cx
"
Ohai
"
)
;
MOZ_RELEASE_ASSERT
(
str
)
;
flatStr
=
JS_FlattenString
(
cx
str
)
;
{
const
char
expected
[
]
=
{
0x4F
0x68
0x61
0x69
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
}
{
size_t
dstlen
=
4
;
const
char
expected
[
]
=
{
0x4F
0x68
0x61
0x69
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
4u
)
;
}
{
size_t
numchars
=
0
;
const
char
expected
[
]
=
{
0x4F
0x68
0x61
0x69
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
nullptr
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
4
;
size_t
numchars
=
0
;
const
char
expected
[
]
=
{
0x4F
0x68
0x61
0x69
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
4u
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
3
;
size_t
numchars
=
0
;
const
char
expected
[
]
=
{
0x4F
0x68
0x61
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
3u
)
;
CHECK_EQUAL
(
numchars
3u
)
;
}
{
size_t
dstlen
=
100
;
size_t
numchars
=
0
;
const
char
expected
[
]
=
{
0x4F
0x68
0x61
0x69
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
4u
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
0
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
0u
)
;
CHECK_EQUAL
(
numchars
0u
)
;
}
str
=
JS_NewUCStringCopyZ
(
cx
MOZ_UTF16
(
"
\
xD3
\
x68
\
xE3
\
xEF
"
)
)
;
MOZ_RELEASE_ASSERT
(
str
)
;
flatStr
=
JS_FlattenString
(
cx
str
)
;
{
const
unsigned
char
expected
[
]
=
{
0xC3
0x93
0x68
0xC3
0xA3
0xC3
0xAF
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
}
{
size_t
dstlen
=
7
;
const
unsigned
char
expected
[
]
=
{
0xC3
0x93
0x68
0xC3
0xA3
0xC3
0xAF
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
7u
)
;
}
{
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xC3
0x93
0x68
0xC3
0xA3
0xC3
0xAF
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
nullptr
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
7
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xC3
0x93
0x68
0xC3
0xA3
0xC3
0xAF
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
7u
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
3
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xC3
0x93
0x68
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
3u
)
;
CHECK_EQUAL
(
numchars
2u
)
;
}
{
size_t
dstlen
=
4
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xC3
0x93
0x68
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
3u
)
;
CHECK_EQUAL
(
numchars
2u
)
;
}
{
size_t
dstlen
=
100
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xC3
0x93
0x68
0xC3
0xA3
0xC3
0xAF
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
7u
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
0
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
0u
)
;
CHECK_EQUAL
(
numchars
0u
)
;
}
str
=
JS_NewUCStringCopyZ
(
cx
MOZ_UTF16
(
"
\
x038C
\
x0068
\
x0203
\
x0457
"
)
)
;
MOZ_RELEASE_ASSERT
(
str
)
;
flatStr
=
JS_FlattenString
(
cx
str
)
;
{
const
unsigned
char
expected
[
]
=
{
0xCE
0x8C
0x68
0xC8
0x83
0xD1
0x97
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
}
{
size_t
dstlen
=
7
;
const
unsigned
char
expected
[
]
=
{
0xCE
0x8C
0x68
0xC8
0x83
0xD1
0x97
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
7u
)
;
}
{
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xCE
0x8C
0x68
0xC8
0x83
0xD1
0x97
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
nullptr
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
7
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xCE
0x8C
0x68
0xC8
0x83
0xD1
0x97
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
7u
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
3
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xCE
0x8C
0x68
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
3u
)
;
CHECK_EQUAL
(
numchars
2u
)
;
}
{
size_t
dstlen
=
4
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xCE
0x8C
0x68
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
3u
)
;
CHECK_EQUAL
(
numchars
2u
)
;
}
{
size_t
dstlen
=
100
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0xCE
0x8C
0x68
0xC8
0x83
0xD1
0x97
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
7u
)
;
CHECK_EQUAL
(
numchars
4u
)
;
}
{
size_t
dstlen
=
0
;
size_t
numchars
=
0
;
const
unsigned
char
expected
[
]
=
{
0x1
}
;
memset
(
actual
0x1
100
)
;
JS
:
:
DeflateStringToUTF8Buffer
(
flatStr
range
&
dstlen
&
numchars
)
;
CHECK_EQUAL
(
memcmp
(
actual
expected
sizeof
(
expected
)
)
0
)
;
CHECK_EQUAL
(
dstlen
0u
)
;
CHECK_EQUAL
(
numchars
0u
)
;
}
return
true
;
}
END_TEST
(
test_DeflateStringToUTF8Buffer
)
