#
include
"
js
/
CompilationAndEvaluation
.
h
"
#
include
"
jsapi
-
tests
/
tests
.
h
"
BEGIN_TEST
(
testGCOutOfMemory
)
{
JS
:
:
RootedValue
root
(
cx
)
;
static
const
char
source
[
]
=
"
var
max
=
0
;
(
function
(
)
{
"
"
var
array
=
[
]
;
"
"
for
(
;
;
+
+
max
)
"
"
array
.
push
(
{
}
)
;
"
"
array
=
[
]
;
array
.
push
(
0
)
;
"
"
}
)
(
)
;
"
;
JS
:
:
CompileOptions
opts
(
cx
)
;
bool
ok
=
JS
:
:
Evaluate
(
cx
opts
source
strlen
(
source
)
&
root
)
;
CHECK
(
!
ok
)
;
CHECK
(
JS_GetPendingException
(
cx
&
root
)
)
;
CHECK
(
root
.
isString
(
)
)
;
bool
match
=
false
;
CHECK
(
JS_StringEqualsAscii
(
cx
root
.
toString
(
)
"
out
of
memory
"
&
match
)
)
;
CHECK
(
match
)
;
JS_ClearPendingException
(
cx
)
;
JS_GC
(
cx
)
;
EVAL
(
"
(
function
(
)
{
"
"
var
array
=
[
]
;
"
"
for
(
var
i
=
max
>
>
2
;
i
!
=
0
;
)
{
"
"
-
-
i
;
"
"
array
.
push
(
{
}
)
;
"
"
}
"
"
}
)
(
)
;
"
&
root
)
;
CHECK
(
!
JS_IsExceptionPending
(
cx
)
)
;
return
true
;
}
virtual
JSContext
*
createContext
(
)
override
{
JSContext
*
cx
=
JS_NewContext
(
1024
*
1024
128
*
1024
)
;
if
(
!
cx
)
{
return
nullptr
;
}
setNativeStackQuota
(
cx
)
;
return
cx
;
}
virtual
void
destroyContext
(
)
override
{
JS_DestroyContext
(
cx
)
;
}
END_TEST
(
testGCOutOfMemory
)
