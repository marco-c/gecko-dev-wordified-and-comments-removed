#
include
"
js
/
GCVector
.
h
"
#
include
"
jsapi
-
tests
/
tests
.
h
"
#
include
"
gc
/
StableCellHasher
-
inl
.
h
"
using
namespace
js
;
static
void
MinimizeHeap
(
JSContext
*
cx
)
{
JS_GC
(
cx
)
;
JS_GC
(
cx
)
;
js
:
:
gc
:
:
FinishGC
(
cx
)
;
}
BEGIN_TEST
(
testGCUID
)
{
AutoLeaveZeal
nozeal
(
cx
)
;
AutoGCParameter
gcparam
(
cx
JSGC_SEMISPACE_NURSERY_ENABLED
0
)
;
uint64_t
uid
=
0
;
uint64_t
tmp
=
0
;
MinimizeHeap
(
cx
)
;
JS
:
:
RootedObject
obj
(
cx
JS_NewPlainObject
(
cx
)
)
;
uintptr_t
nurseryAddr
=
uintptr_t
(
obj
.
get
(
)
)
;
CHECK
(
obj
)
;
CHECK
(
gc
:
:
IsInsideNursery
(
obj
)
)
;
CHECK
(
!
gc
:
:
HasUniqueId
(
obj
)
)
;
CHECK
(
gc
:
:
GetOrCreateUniqueId
(
obj
&
uid
)
)
;
CHECK
(
uid
>
gc
:
:
LargestTaggedNullCellPointer
)
;
CHECK
(
gc
:
:
HasUniqueId
(
obj
)
)
;
CHECK
(
gc
:
:
GetOrCreateUniqueId
(
obj
&
tmp
)
)
;
CHECK
(
uid
=
=
tmp
)
;
MinimizeHeap
(
cx
)
;
uintptr_t
tenuredAddr
=
uintptr_t
(
obj
.
get
(
)
)
;
CHECK
(
tenuredAddr
!
=
nurseryAddr
)
;
CHECK
(
!
gc
:
:
IsInsideNursery
(
obj
)
)
;
CHECK
(
gc
:
:
HasUniqueId
(
obj
)
)
;
CHECK
(
gc
:
:
GetOrCreateUniqueId
(
obj
&
tmp
)
)
;
CHECK
(
uid
=
=
tmp
)
;
obj
=
JS_NewPlainObject
(
cx
)
;
CHECK
(
obj
)
;
CHECK
(
uintptr_t
(
obj
.
get
(
)
)
=
=
nurseryAddr
)
;
CHECK
(
!
gc
:
:
HasUniqueId
(
obj
)
)
;
obj
=
nullptr
;
MinimizeHeap
(
cx
)
;
obj
=
JS_NewPlainObject
(
cx
)
;
MinimizeHeap
(
cx
)
;
CHECK
(
uintptr_t
(
obj
.
get
(
)
)
=
=
tenuredAddr
)
;
CHECK
(
!
gc
:
:
HasUniqueId
(
obj
)
)
;
CHECK
(
gc
:
:
GetOrCreateUniqueId
(
obj
&
tmp
)
)
;
CHECK
(
uid
!
=
tmp
)
;
uid
=
tmp
;
const
static
size_t
N
=
2049
;
using
ObjectVector
=
JS
:
:
GCVector
<
JSObject
*
>
;
JS
:
:
Rooted
<
ObjectVector
>
vec
(
cx
ObjectVector
(
cx
)
)
;
for
(
size_t
i
=
0
;
i
<
N
;
+
+
i
)
{
obj
=
JS_NewPlainObject
(
cx
)
;
CHECK
(
obj
)
;
CHECK
(
vec
.
append
(
obj
)
)
;
}
MinimizeHeap
(
cx
)
;
JS
:
:
Rooted
<
ObjectVector
>
vec2
(
cx
ObjectVector
(
cx
)
)
;
for
(
size_t
i
=
0
;
i
<
N
;
+
+
i
)
{
if
(
i
%
2
=
=
1
)
{
CHECK
(
vec2
.
append
(
vec
[
i
]
)
)
;
}
}
vec
.
clear
(
)
;
obj
=
vec2
.
back
(
)
;
CHECK
(
obj
)
;
CHECK
(
!
gc
:
:
IsInsideNursery
(
obj
)
)
;
tenuredAddr
=
uintptr_t
(
obj
.
get
(
)
)
;
CHECK
(
gc
:
:
GetOrCreateUniqueId
(
obj
&
uid
)
)
;
JS
:
:
PrepareForFullGC
(
cx
)
;
JS
:
:
NonIncrementalGC
(
cx
JS
:
:
GCOptions
:
:
Shrink
JS
:
:
GCReason
:
:
API
)
;
CHECK
(
uintptr_t
(
obj
.
get
(
)
)
!
=
tenuredAddr
)
;
CHECK
(
gc
:
:
HasUniqueId
(
obj
)
)
;
CHECK
(
gc
:
:
GetOrCreateUniqueId
(
obj
&
tmp
)
)
;
CHECK
(
uid
=
=
tmp
)
;
return
true
;
}
END_TEST
(
testGCUID
)
