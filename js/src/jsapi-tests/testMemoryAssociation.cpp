#
include
"
jsapi
.
h
"
#
include
"
jspubtd
.
h
"
#
include
"
js
/
CompilationAndEvaluation
.
h
"
#
include
"
jsapi
-
tests
/
tests
.
h
"
static
const
JS
:
:
MemoryUse
TestUse1
=
JS
:
:
MemoryUse
:
:
XPCWrappedNative
;
static
const
JS
:
:
MemoryUse
TestUse2
=
JS
:
:
MemoryUse
:
:
DOMBinding
;
BEGIN_TEST
(
testMemoryAssociation
)
{
JS
:
:
RootedObject
obj
(
cx
JS_NewPlainObject
(
cx
)
)
;
CHECK
(
obj
)
;
JS_GC
(
cx
)
;
JS
:
:
AddAssociatedMemory
(
obj
100
TestUse1
)
;
JS
:
:
RemoveAssociatedMemory
(
obj
100
TestUse1
)
;
void
*
initial
=
obj
;
JS
:
:
AddAssociatedMemory
(
obj
300
TestUse1
)
;
JS
:
:
PrepareForFullGC
(
cx
)
;
JS
:
:
NonIncrementalGC
(
cx
JS
:
:
GCOptions
:
:
Shrink
JS
:
:
GCReason
:
:
DEBUG_GC
)
;
CHECK
(
obj
!
=
initial
)
;
JS
:
:
RemoveAssociatedMemory
(
obj
300
TestUse1
)
;
JS
:
:
AddAssociatedMemory
(
obj
400
TestUse1
)
;
JS
:
:
AddAssociatedMemory
(
obj
500
TestUse2
)
;
JS
:
:
RemoveAssociatedMemory
(
obj
400
TestUse1
)
;
JS
:
:
RemoveAssociatedMemory
(
obj
500
TestUse2
)
;
return
true
;
}
END_TEST
(
testMemoryAssociation
)
