#
ifndef
builtin_WeakMapObject_inl_h
#
define
builtin_WeakMapObject_inl_h
#
include
"
builtin
/
WeakMapObject
.
h
"
#
include
"
js
/
friend
/
ErrorMessages
.
h
"
#
include
"
js
/
Wrapper
.
h
"
#
include
"
gc
/
WeakMap
-
inl
.
h
"
#
include
"
vm
/
JSObject
-
inl
.
h
"
namespace
js
{
static
bool
TryPreserveReflector
(
JSContext
*
cx
HandleObject
obj
)
{
if
(
!
MaybePreserveDOMWrapper
(
cx
obj
)
)
{
JS_ReportErrorNumberASCII
(
cx
GetErrorMessage
nullptr
JSMSG_BAD_WEAKMAP_KEY
)
;
return
false
;
}
return
true
;
}
static
MOZ_ALWAYS_INLINE
bool
WeakCollectionPutEntryInternal
(
JSContext
*
cx
Handle
<
WeakCollectionObject
*
>
obj
HandleValue
key
HandleValue
value
)
{
ValueValueWeakMap
*
map
=
obj
-
>
getMap
(
)
;
if
(
!
map
)
{
auto
newMap
=
cx
-
>
make_unique
<
ValueValueWeakMap
>
(
cx
obj
.
get
(
)
)
;
if
(
!
newMap
)
{
return
false
;
}
map
=
newMap
.
release
(
)
;
InitReservedSlot
(
obj
WeakCollectionObject
:
:
DataSlot
map
MemoryUse
:
:
WeakMapObject
)
;
}
if
(
key
.
isObject
(
)
)
{
RootedObject
keyObj
(
cx
&
key
.
toObject
(
)
)
;
if
(
!
TryPreserveReflector
(
cx
keyObj
)
)
{
return
false
;
}
RootedObject
delegate
(
cx
UncheckedUnwrapWithoutExpose
(
keyObj
)
)
;
if
(
delegate
&
&
!
TryPreserveReflector
(
cx
delegate
)
)
{
return
false
;
}
}
MOZ_ASSERT_IF
(
key
.
isObject
(
)
key
.
toObject
(
)
.
compartment
(
)
=
=
obj
-
>
compartment
(
)
)
;
MOZ_ASSERT_IF
(
value
.
isGCThing
(
)
gc
:
:
ToMarkable
(
value
)
-
>
zoneFromAnyThread
(
)
=
=
obj
-
>
zone
(
)
|
|
gc
:
:
ToMarkable
(
value
)
-
>
zoneFromAnyThread
(
)
-
>
isAtomsZone
(
)
)
;
MOZ_ASSERT_IF
(
value
.
isObject
(
)
value
.
toObject
(
)
.
compartment
(
)
=
=
obj
-
>
compartment
(
)
)
;
if
(
!
map
-
>
put
(
key
value
)
)
{
JS_ReportOutOfMemory
(
cx
)
;
return
false
;
}
return
true
;
}
}
#
endif
