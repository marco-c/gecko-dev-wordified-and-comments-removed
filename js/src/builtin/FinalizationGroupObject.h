#
ifndef
builtin_FinalizationGroupObject_h
#
define
builtin_FinalizationGroupObject_h
#
include
"
gc
/
Barrier
.
h
"
#
include
"
js
/
GCVector
.
h
"
#
include
"
vm
/
NativeObject
.
h
"
namespace
js
{
class
FinalizationGroupObject
;
class
FinalizationIteratorObject
;
class
FinalizationRecordObject
;
class
ObjectWeakMap
;
using
HandleFinalizationGroupObject
=
Handle
<
FinalizationGroupObject
*
>
;
using
HandleFinalizationRecordObject
=
Handle
<
FinalizationRecordObject
*
>
;
using
RootedFinalizationGroupObject
=
Rooted
<
FinalizationGroupObject
*
>
;
using
RootedFinalizationIteratorObject
=
Rooted
<
FinalizationIteratorObject
*
>
;
using
RootedFinalizationRecordObject
=
Rooted
<
FinalizationRecordObject
*
>
;
class
FinalizationRecordObject
:
public
NativeObject
{
enum
{
GroupSlot
=
0
HeldValueSlot
SlotCount
}
;
public
:
static
const
JSClass
class_
;
static
FinalizationRecordObject
*
create
(
JSContext
*
cx
HandleFinalizationGroupObject
group
HandleValue
heldValue
)
;
FinalizationGroupObject
*
group
(
)
const
;
Value
heldValue
(
)
const
;
bool
wasCleared
(
)
const
;
void
clear
(
)
;
}
;
using
FinalizationRecordVector
=
GCVector
<
HeapPtr
<
FinalizationRecordObject
*
>
1
js
:
:
ZoneAllocPolicy
>
;
class
FinalizationRecordVectorObject
:
public
NativeObject
{
enum
{
RecordsSlot
=
0
SlotCount
}
;
public
:
static
const
JSClass
class_
;
static
FinalizationRecordVectorObject
*
create
(
JSContext
*
cx
)
;
FinalizationRecordVector
*
records
(
)
;
const
FinalizationRecordVector
*
records
(
)
const
;
bool
isEmpty
(
)
const
;
bool
append
(
HandleFinalizationRecordObject
record
)
;
void
remove
(
HandleFinalizationRecordObject
record
)
;
private
:
static
const
JSClassOps
classOps_
;
void
*
privatePtr
(
)
const
;
static
void
trace
(
JSTracer
*
trc
JSObject
*
obj
)
;
static
void
finalize
(
JSFreeOp
*
fop
JSObject
*
obj
)
;
}
;
class
FinalizationGroupObject
:
public
NativeObject
{
enum
{
CleanupCallbackSlot
=
0
RegistrationsSlot
RecordsToBeCleanedUpSlot
IsQueuedForCleanupSlot
IsCleanupJobActiveSlot
SlotCount
}
;
public
:
static
const
JSClass
class_
;
static
const
JSClass
protoClass_
;
JSObject
*
cleanupCallback
(
)
const
;
ObjectWeakMap
*
registrations
(
)
const
;
FinalizationRecordVector
*
recordsToBeCleanedUp
(
)
const
;
bool
isQueuedForCleanup
(
)
const
;
bool
isCleanupJobActive
(
)
const
;
void
queueRecordToBeCleanedUp
(
FinalizationRecordObject
*
record
)
;
void
setQueuedForCleanup
(
bool
value
)
;
void
setCleanupJobActive
(
bool
value
)
;
static
bool
cleanupQueuedRecords
(
JSContext
*
cx
HandleFinalizationGroupObject
group
HandleObject
callback
=
nullptr
)
;
private
:
static
const
JSClassOps
classOps_
;
static
const
ClassSpec
classSpec_
;
static
const
JSFunctionSpec
methods_
[
]
;
static
const
JSPropertySpec
properties_
[
]
;
static
bool
construct
(
JSContext
*
cx
unsigned
argc
Value
*
vp
)
;
static
bool
register_
(
JSContext
*
cx
unsigned
argc
Value
*
vp
)
;
static
bool
unregister
(
JSContext
*
cx
unsigned
argc
Value
*
vp
)
;
static
bool
cleanupSome
(
JSContext
*
cx
unsigned
argc
Value
*
vp
)
;
static
bool
addRegistration
(
JSContext
*
cx
HandleFinalizationGroupObject
group
HandleObject
unregisterToken
HandleFinalizationRecordObject
record
)
;
static
void
removeRegistrationOnError
(
HandleFinalizationGroupObject
group
HandleObject
unregisterToken
HandleFinalizationRecordObject
record
)
;
static
void
trace
(
JSTracer
*
trc
JSObject
*
obj
)
;
static
void
finalize
(
JSFreeOp
*
fop
JSObject
*
obj
)
;
static
bool
hasRegisteredRecordsToBeCleanedUp
(
HandleFinalizationGroupObject
group
)
;
}
;
class
FinalizationIteratorObject
:
public
NativeObject
{
enum
{
FinalizationGroupSlot
=
0
IndexSlot
SlotCount
}
;
public
:
static
const
JSClass
class_
;
static
FinalizationIteratorObject
*
create
(
JSContext
*
cx
HandleFinalizationGroupObject
group
)
;
FinalizationGroupObject
*
finalizationGroup
(
)
const
;
size_t
index
(
)
const
;
void
setIndex
(
size_t
index
)
;
void
clearFinalizationGroup
(
)
;
private
:
friend
class
GlobalObject
;
static
const
JSFunctionSpec
methods_
[
]
;
static
const
JSPropertySpec
properties_
[
]
;
static
bool
next
(
JSContext
*
cx
unsigned
argc
Value
*
vp
)
;
}
;
}
#
endif
