#
include
"
builtin
/
Promise
.
h
"
#
include
"
jscntxt
.
h
"
using
namespace
js
;
static
const
JSFunctionSpec
promise_methods
[
]
=
{
JS_SELF_HOSTED_FN
(
"
catch
"
"
Promise_catch
"
1
0
)
JS_SELF_HOSTED_FN
(
"
then
"
"
Promise_then
"
2
0
)
JS_FS_END
}
;
static
const
JSFunctionSpec
promise_static_methods
[
]
=
{
JS_SELF_HOSTED_FN
(
"
all
"
"
Promise_all
"
1
0
)
JS_SELF_HOSTED_FN
(
"
race
"
"
Promise_race
"
1
0
)
JS_SELF_HOSTED_FN
(
"
reject
"
"
Promise_reject
"
1
0
)
JS_SELF_HOSTED_FN
(
"
resolve
"
"
Promise_resolve
"
1
0
)
JS_FS_END
}
;
static
bool
PromiseConstructor
(
JSContext
*
cx
unsigned
argc
Value
*
vp
)
{
CallArgs
args
=
CallArgsFromVp
(
argc
vp
)
;
JSObject
*
obj
=
NewBuiltinClassInstance
(
cx
&
ShellPromiseObject
:
:
class_
)
;
if
(
!
obj
)
return
false
;
args
.
rval
(
)
.
setObject
(
*
obj
)
;
return
true
;
}
static
JSObject
*
CreatePromisePrototype
(
JSContext
*
cx
JSProtoKey
key
)
{
return
cx
-
>
global
(
)
-
>
createBlankPrototype
(
cx
&
ShellPromiseObject
:
:
protoClass_
)
;
}
const
Class
ShellPromiseObject
:
:
class_
=
{
"
ShellPromise
"
JSCLASS_HAS_CACHED_PROTO
(
JSProto_ShellPromise
)
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
{
GenericCreateConstructor
<
PromiseConstructor
2
gc
:
:
AllocKind
:
:
FUNCTION
>
CreatePromisePrototype
promise_static_methods
nullptr
promise_methods
}
}
;
const
Class
ShellPromiseObject
:
:
protoClass_
=
{
"
ShellPromise
"
JSCLASS_HAS_CACHED_PROTO
(
JSProto_ShellPromise
)
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
{
DELEGATED_CLASSSPEC
(
&
ShellPromiseObject
:
:
class_
.
spec
)
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
ClassSpec
:
:
IsDelegated
}
}
;
