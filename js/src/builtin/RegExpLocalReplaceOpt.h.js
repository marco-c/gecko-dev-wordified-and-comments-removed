function
FUNC_NAME
(
rx
S
lengthS
replaceValue
#
ifdef
SUBSTITUTION
firstDollarIndex
#
endif
)
{
var
flags
=
UnsafeGetInt32FromReservedSlot
(
rx
REGEXP_FLAGS_SLOT
)
;
var
sticky
=
!
!
(
flags
&
REGEXP_STICKY_FLAG
)
;
var
lastIndex
;
if
(
sticky
)
{
lastIndex
=
ToLength
(
rx
.
lastIndex
)
;
if
(
lastIndex
>
lengthS
)
{
rx
.
lastIndex
=
0
;
return
S
;
}
}
else
{
lastIndex
=
0
;
}
var
result
=
RegExpMatcher
(
rx
S
lastIndex
sticky
)
;
if
(
result
=
=
=
null
)
{
rx
.
lastIndex
=
0
;
return
S
;
}
#
if
defined
(
FUNCTIONAL
)
|
|
defined
(
SUBSTITUTION
)
var
nCaptures
=
std_Math_max
(
result
.
length
-
1
0
)
;
#
endif
var
matched
=
result
[
0
]
;
var
matchLength
=
matched
.
length
;
var
position
=
result
.
index
;
var
nextSourcePosition
=
position
+
matchLength
;
if
(
sticky
)
rx
.
lastIndex
=
nextSourcePosition
;
var
replacement
;
#
if
defined
(
FUNCTIONAL
)
replacement
=
RegExpGetComplexReplacement
(
result
matched
S
position
nCaptures
replaceValue
true
-
1
)
;
#
elif
defined
(
SUBSTITUTION
)
replacement
=
RegExpGetComplexReplacement
(
result
matched
S
position
nCaptures
replaceValue
false
firstDollarIndex
)
;
#
else
replacement
=
replaceValue
;
#
endif
var
accumulatedResult
=
Substring
(
S
0
position
)
+
replacement
;
if
(
nextSourcePosition
>
=
lengthS
)
return
accumulatedResult
;
return
accumulatedResult
+
Substring
(
S
nextSourcePosition
lengthS
-
nextSourcePosition
)
;
}
