function
FUNC_NAME
(
rx
S
lengthS
replaceValue
#
ifdef
SUBSTITUTION
firstDollarIndex
#
endif
)
{
var
fullUnicode
=
!
!
rx
.
unicode
;
var
lastIndex
=
0
;
rx
.
lastIndex
=
0
;
var
accumulatedResult
=
"
"
;
var
nextSourcePosition
=
0
;
var
flags
=
UnsafeGetInt32FromReservedSlot
(
rx
REGEXP_FLAGS_SLOT
)
;
var
sticky
=
!
!
(
flags
&
REGEXP_STICKY_FLAG
)
;
while
(
true
)
{
var
result
=
RegExpMatcher
(
rx
S
lastIndex
sticky
)
;
if
(
result
=
=
=
null
)
break
;
#
if
defined
(
FUNCTIONAL
)
|
|
defined
(
SUBSTITUTION
)
var
nCaptures
=
std_Math_max
(
result
.
length
-
1
0
)
;
#
endif
var
matched
=
result
[
0
]
;
var
matchLength
=
matched
.
length
;
var
position
=
result
.
index
;
lastIndex
=
position
+
matchLength
;
var
replacement
;
#
if
defined
(
FUNCTIONAL
)
replacement
=
RegExpGetComplexReplacement
(
result
matched
S
position
nCaptures
replaceValue
true
-
1
)
;
#
elif
defined
(
SUBSTITUTION
)
replacement
=
RegExpGetComplexReplacement
(
result
matched
S
position
nCaptures
replaceValue
false
firstDollarIndex
)
;
#
else
replacement
=
replaceValue
;
#
endif
accumulatedResult
+
=
Substring
(
S
nextSourcePosition
position
-
nextSourcePosition
)
+
replacement
;
nextSourcePosition
=
lastIndex
;
if
(
matchLength
=
=
=
0
)
{
lastIndex
=
fullUnicode
?
AdvanceStringIndex
(
S
lastIndex
)
:
lastIndex
+
1
;
if
(
lastIndex
>
lengthS
)
break
;
}
}
if
(
nextSourcePosition
>
=
lengthS
)
return
accumulatedResult
;
return
accumulatedResult
+
Substring
(
S
nextSourcePosition
lengthS
-
nextSourcePosition
)
;
}
