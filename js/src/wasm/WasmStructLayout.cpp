#
include
"
wasm
/
WasmStructLayout
.
h
"
#
include
"
jstypes
.
h
"
namespace
js
:
:
wasm
{
#
ifdef
DEBUG
static
bool
IsWordAligned
(
uintptr_t
x
)
{
return
(
x
%
sizeof
(
void
*
)
)
=
=
0
;
}
#
endif
bool
StructLayout
:
:
init
(
uint32_t
firstUsableILOffset
uint32_t
usableILSize
)
{
MOZ_ASSERT
(
IsWordAligned
(
firstUsableILOffset
)
)
;
MOZ_ASSERT
(
IsWordAligned
(
usableILSize
)
)
;
MOZ_ASSERT
(
usableILSize
>
=
sizeof
(
void
*
)
)
;
startILO_
=
firstUsableILOffset
;
endPlusILO_
=
firstUsableILOffset
+
usableILSize
;
oolptrILO_
=
js
:
:
RoundUp
(
startILO_
sizeof
(
void
*
)
)
;
MOZ_ASSERT
(
IsWordAligned
(
oolptrILO_
)
)
;
nextILO_
=
oolptrILO_
+
sizeof
(
void
*
)
;
return
true
;
}
bool
StructLayout
:
:
addField
(
uint32_t
fieldSize
FieldAccessPath
*
path
)
{
MOZ_ASSERT
(
fieldSize
=
=
16
|
|
fieldSize
=
=
8
|
|
fieldSize
=
=
4
|
|
fieldSize
=
=
2
|
|
fieldSize
=
=
1
)
;
numFieldsProcessed_
+
+
;
MOZ_RELEASE_ASSERT
(
numFieldsProcessed_
<
=
js
:
:
wasm
:
:
MaxStructFields
)
;
MOZ_RELEASE_ASSERT
(
fieldSize
<
=
16
)
;
uint32_t
nextNextILO
=
js
:
:
RoundUp
(
nextILO_
fieldSize
)
+
fieldSize
;
if
(
nextNextILO
<
=
endPlusILO_
)
{
nextILO_
=
nextNextILO
;
*
path
=
FieldAccessPath
(
nextILO_
-
fieldSize
)
;
return
true
;
}
nextOOLO_
=
js
:
:
RoundUp
(
nextOOLO_
fieldSize
)
+
fieldSize
;
*
path
=
FieldAccessPath
(
oolptrILO_
nextOOLO_
-
fieldSize
)
;
return
true
;
}
uint32_t
StructLayout
:
:
totalSizeIL
(
)
const
{
return
js
:
:
RoundUp
(
nextILO_
sizeof
(
void
*
)
)
;
}
bool
StructLayout
:
:
hasOOL
(
)
const
{
return
nextOOLO_
>
0
;
}
uint32_t
StructLayout
:
:
totalSizeOOL
(
)
const
{
MOZ_ASSERT
(
hasOOL
(
)
)
;
return
js
:
:
RoundUp
(
nextOOLO_
sizeof
(
void
*
)
)
;
}
FieldAccessPath
StructLayout
:
:
oolPointerPath
(
)
const
{
MOZ_ASSERT
(
hasOOL
(
)
)
;
return
FieldAccessPath
(
oolptrILO_
)
;
}
}
