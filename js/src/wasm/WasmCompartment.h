#
ifndef
wasm_compartment_h
#
define
wasm_compartment_h
#
include
"
wasm
/
WasmJS
.
h
"
namespace
js
{
class
WasmActivation
;
namespace
wasm
{
class
Code
;
class
CodeSegment
;
typedef
Vector
<
Instance
*
0
SystemAllocPolicy
>
InstanceVector
;
class
Compartment
{
InstanceVector
instances_
;
volatile
bool
mutatingInstances_
;
friend
class
js
:
:
WasmActivation
;
struct
AutoMutateInstances
{
Compartment
&
c
;
explicit
AutoMutateInstances
(
Compartment
&
c
)
:
c
(
c
)
{
MOZ_ASSERT
(
!
c
.
mutatingInstances_
)
;
c
.
mutatingInstances_
=
true
;
}
~
AutoMutateInstances
(
)
{
MOZ_ASSERT
(
c
.
mutatingInstances_
)
;
c
.
mutatingInstances_
=
false
;
}
}
;
public
:
explicit
Compartment
(
Zone
*
zone
)
;
~
Compartment
(
)
;
bool
registerInstance
(
JSContext
*
cx
HandleWasmInstanceObject
instanceObj
)
;
void
unregisterInstance
(
Instance
&
instance
)
;
const
InstanceVector
&
instances
(
)
const
{
return
instances_
;
}
const
Code
*
lookupCode
(
const
void
*
pc
const
CodeSegment
*
*
segment
=
nullptr
)
const
;
void
ensureProfilingLabels
(
bool
profilingEnabled
)
;
void
addSizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
size_t
*
compartmentTables
)
;
}
;
}
}
#
endif
