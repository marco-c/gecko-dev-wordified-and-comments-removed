#
ifndef
wasm_generator_h
#
define
wasm_generator_h
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
jit
/
MacroAssembler
.
h
"
#
include
"
jit
/
PerfSpewer
.
h
"
#
include
"
threading
/
ProtectedData
.
h
"
#
include
"
vm
/
HelperThreadTask
.
h
"
#
include
"
wasm
/
WasmCompile
.
h
"
#
include
"
wasm
/
WasmMetadata
.
h
"
#
include
"
wasm
/
WasmModule
.
h
"
namespace
JS
{
class
OptimizedEncodingListener
;
}
namespace
js
{
namespace
wasm
{
struct
CompileTask
;
using
CompileTaskPtrVector
=
Vector
<
CompileTask
*
0
SystemAllocPolicy
>
;
struct
FuncCompileInput
{
const
uint8_t
*
begin
;
const
uint8_t
*
end
;
uint32_t
index
;
uint32_t
lineOrBytecode
;
Uint32Vector
callSiteLineNums
;
FuncCompileInput
(
uint32_t
index
uint32_t
lineOrBytecode
const
uint8_t
*
begin
const
uint8_t
*
end
Uint32Vector
&
&
callSiteLineNums
)
:
begin
(
begin
)
end
(
end
)
index
(
index
)
lineOrBytecode
(
lineOrBytecode
)
callSiteLineNums
(
std
:
:
move
(
callSiteLineNums
)
)
{
}
}
;
using
FuncCompileInputVector
=
Vector
<
FuncCompileInput
8
SystemAllocPolicy
>
;
struct
FuncCompileOutput
{
FuncCompileOutput
(
uint32_t
index
FeatureUsage
featureUsage
CallRefMetricsRange
callRefMetricsRange
=
CallRefMetricsRange
(
)
)
:
index
(
index
)
featureUsage
(
featureUsage
)
callRefMetricsRange
(
callRefMetricsRange
)
{
}
uint32_t
index
;
FeatureUsage
featureUsage
;
CallRefMetricsRange
callRefMetricsRange
;
}
;
using
FuncCompileOutputVector
=
Vector
<
FuncCompileOutput
8
SystemAllocPolicy
>
;
struct
CompiledCode
{
CompiledCode
(
)
:
featureUsage
(
FeatureUsage
:
:
None
)
{
}
FuncCompileOutputVector
funcs
;
Bytes
bytes
;
CodeRangeVector
codeRanges
;
CallSites
callSites
;
CallSiteTargetVector
callSiteTargets
;
TrapSites
trapSites
;
SymbolicAccessVector
symbolicAccesses
;
jit
:
:
CodeLabelVector
codeLabels
;
StackMaps
stackMaps
;
TryNoteVector
tryNotes
;
CodeRangeUnwindInfoVector
codeRangeUnwindInfos
;
CallRefMetricsPatchVector
callRefMetricsPatches
;
FuncIonPerfSpewerVector
funcIonSpewers
;
FuncBaselinePerfSpewerVector
funcBaselineSpewers
;
FeatureUsage
featureUsage
;
[
[
nodiscard
]
]
bool
swap
(
jit
:
:
MacroAssembler
&
masm
)
;
void
clear
(
)
{
funcs
.
clear
(
)
;
bytes
.
clear
(
)
;
codeRanges
.
clear
(
)
;
callSites
.
clear
(
)
;
callSiteTargets
.
clear
(
)
;
trapSites
.
clear
(
)
;
symbolicAccesses
.
clear
(
)
;
codeLabels
.
clear
(
)
;
stackMaps
.
clear
(
)
;
tryNotes
.
clear
(
)
;
codeRangeUnwindInfos
.
clear
(
)
;
callRefMetricsPatches
.
clear
(
)
;
funcIonSpewers
.
clear
(
)
;
funcBaselineSpewers
.
clear
(
)
;
featureUsage
=
FeatureUsage
:
:
None
;
MOZ_ASSERT
(
empty
(
)
)
;
}
bool
empty
(
)
{
return
funcs
.
empty
(
)
&
&
bytes
.
empty
(
)
&
&
codeRanges
.
empty
(
)
&
&
callSites
.
empty
(
)
&
&
callSiteTargets
.
empty
(
)
&
&
trapSites
.
empty
(
)
&
&
symbolicAccesses
.
empty
(
)
&
&
codeLabels
.
empty
(
)
&
&
tryNotes
.
empty
(
)
&
&
stackMaps
.
empty
(
)
&
&
codeRangeUnwindInfos
.
empty
(
)
&
&
callRefMetricsPatches
.
empty
(
)
&
&
funcIonSpewers
.
empty
(
)
&
&
funcBaselineSpewers
.
empty
(
)
&
&
featureUsage
=
=
FeatureUsage
:
:
None
;
}
size_t
sizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
const
;
}
;
struct
CompileTaskState
{
HelperThreadLockData
<
CompileTaskPtrVector
>
finished_
;
HelperThreadLockData
<
uint32_t
>
numFailed_
;
HelperThreadLockData
<
UniqueChars
>
errorMessage_
;
HelperThreadLockData
<
ConditionVariable
>
condVar_
;
CompileTaskState
(
)
:
numFailed_
(
0
)
{
}
~
CompileTaskState
(
)
{
MOZ_ASSERT
(
finished_
.
refNoCheck
(
)
.
empty
(
)
)
;
MOZ_ASSERT
(
!
numFailed_
.
refNoCheck
(
)
)
;
}
CompileTaskPtrVector
&
finished
(
)
{
return
finished_
.
ref
(
)
;
}
uint32_t
&
numFailed
(
)
{
return
numFailed_
.
ref
(
)
;
}
UniqueChars
&
errorMessage
(
)
{
return
errorMessage_
.
ref
(
)
;
}
ConditionVariable
&
condVar
(
)
{
return
condVar_
.
ref
(
)
;
}
}
;
struct
CompileTask
:
public
HelperThreadTask
{
const
CodeMetadata
&
codeMeta
;
const
CompilerEnvironment
&
compilerEnv
;
const
CompileState
compileState
;
CompileTaskState
&
state
;
LifoAlloc
lifo
;
FuncCompileInputVector
inputs
;
CompiledCode
output
;
CompileTask
(
const
CodeMetadata
&
codeMeta
const
CompilerEnvironment
&
compilerEnv
CompileState
compileState
CompileTaskState
&
state
size_t
defaultChunkSize
)
:
codeMeta
(
codeMeta
)
compilerEnv
(
compilerEnv
)
compileState
(
compileState
)
state
(
state
)
lifo
(
defaultChunkSize
js
:
:
MallocArena
)
{
}
virtual
~
CompileTask
(
)
=
default
;
size_t
sizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
const
;
void
runHelperThreadTask
(
AutoLockHelperThreadState
&
locked
)
override
;
ThreadType
threadType
(
)
override
;
const
char
*
getName
(
)
override
{
return
"
WasmCompileTask
"
;
}
}
;
class
MOZ_STACK_CLASS
ModuleGenerator
{
using
CompileTaskVector
=
Vector
<
CompileTask
0
SystemAllocPolicy
>
;
using
CodeOffsetVector
=
Vector
<
jit
:
:
CodeOffset
0
SystemAllocPolicy
>
;
struct
MacroAssemblerScope
{
jit
:
:
TempAllocator
masmAlloc
;
jit
:
:
WasmMacroAssembler
masm
;
explicit
MacroAssemblerScope
(
LifoAlloc
&
lifo
)
;
~
MacroAssemblerScope
(
)
=
default
;
}
;
SharedCompileArgs
const
compileArgs_
;
const
CompileState
compileState_
;
UniqueChars
*
const
error_
;
UniqueCharsVector
*
const
warnings_
;
const
mozilla
:
:
Atomic
<
bool
>
*
const
cancelled_
;
const
CodeMetadata
*
const
codeMeta_
;
const
CompilerEnvironment
*
const
compilerEnv_
;
SharedCode
partialTieringCode_
;
mozilla
:
:
TimeStamp
completeTierStartTime_
;
BytecodeRangeVector
funcDefRanges_
;
FeatureUsageVector
funcDefFeatureUsages_
;
CallRefMetricsRangeVector
funcDefCallRefMetrics_
;
FuncImportVector
funcImports_
;
UniqueLinkData
sharedStubsLinkData_
;
UniqueCodeBlock
sharedStubsCodeBlock_
;
MutableCodeMetadataForAsmJS
codeMetaForAsmJS_
;
FeatureUsage
featureUsage_
;
UniqueCodeBlock
codeBlock_
;
UniqueLinkData
linkData_
;
LifoAlloc
lifo_
;
mozilla
:
:
Maybe
<
MacroAssemblerScope
>
masmScope_
;
jit
:
:
WasmMacroAssembler
*
masm_
;
uint32_t
debugStubCodeOffset_
;
uint32_t
requestTierUpStubCodeOffset_
;
uint32_t
updateCallRefMetricsStubCodeOffset_
;
CallFarJumpVector
callFarJumps_
;
CallSiteTargetVector
callSiteTargets_
;
FuncIonPerfSpewerVector
funcIonSpewers_
;
FuncBaselinePerfSpewerVector
funcBaselineSpewers_
;
uint32_t
lastPatchedCallSite_
;
uint32_t
startOfUnpatchedCallsites_
;
uint32_t
numCallRefMetrics_
;
bool
parallel_
;
uint32_t
outstanding_
;
CompileTaskState
taskState_
;
CompileTaskVector
tasks_
;
CompileTaskPtrVector
freeTasks_
;
CompileTask
*
currentTask_
;
uint32_t
batchedBytecode_
;
mozilla
:
:
DebugOnly
<
bool
>
finishedFuncDefs_
;
bool
funcIsCompiledInBlock
(
uint32_t
funcIndex
)
const
;
const
CodeRange
&
funcCodeRangeInBlock
(
uint32_t
funcIndex
)
const
;
bool
linkCallSites
(
)
;
void
noteCodeRange
(
uint32_t
codeRangeIndex
const
CodeRange
&
codeRange
)
;
bool
linkCompiledCode
(
CompiledCode
&
code
)
;
[
[
nodiscard
]
]
bool
initTasks
(
)
;
bool
locallyCompileCurrentTask
(
)
;
bool
finishTask
(
CompileTask
*
task
)
;
bool
launchBatchCompile
(
)
;
bool
finishOutstandingTask
(
)
;
[
[
nodiscard
]
]
bool
startCodeBlock
(
CodeBlockKind
kind
)
;
UniqueCodeBlock
finishCodeBlock
(
UniqueLinkData
*
linkData
)
;
[
[
nodiscard
]
]
bool
prepareTier1
(
)
;
[
[
nodiscard
]
]
bool
startCompleteTier
(
)
;
[
[
nodiscard
]
]
bool
startPartialTier
(
uint32_t
funcIndex
)
;
UniqueCodeBlock
finishTier
(
UniqueLinkData
*
linkData
)
;
bool
isAsmJS
(
)
const
{
return
codeMeta_
-
>
isAsmJS
(
)
;
}
Tier
tier
(
)
const
{
return
compilerEnv_
-
>
tier
(
)
;
}
CompileMode
mode
(
)
const
{
return
compilerEnv_
-
>
mode
(
)
;
}
bool
debugEnabled
(
)
const
{
return
compilerEnv_
-
>
debugEnabled
(
)
;
}
bool
compilingTier1
(
)
const
{
return
compileState_
=
=
CompileState
:
:
Once
|
|
compileState_
=
=
CompileState
:
:
EagerTier1
|
|
compileState_
=
=
CompileState
:
:
LazyTier1
;
}
void
warnf
(
const
char
*
msg
.
.
.
)
MOZ_FORMAT_PRINTF
(
2
3
)
;
public
:
ModuleGenerator
(
const
CodeMetadata
&
codeMeta
const
CompilerEnvironment
&
compilerEnv
CompileState
compilerState
const
mozilla
:
:
Atomic
<
bool
>
*
cancelled
UniqueChars
*
error
UniqueCharsVector
*
warnings
)
;
~
ModuleGenerator
(
)
;
[
[
nodiscard
]
]
bool
initializeCompleteTier
(
CodeMetadataForAsmJS
*
codeMetaForAsmJS
=
nullptr
)
;
[
[
nodiscard
]
]
bool
initializePartialTier
(
const
Code
&
code
uint32_t
maybeFuncIndex
)
;
[
[
nodiscard
]
]
bool
compileFuncDef
(
uint32_t
funcIndex
uint32_t
lineOrBytecode
const
uint8_t
*
begin
const
uint8_t
*
end
Uint32Vector
&
&
callSiteLineNums
=
Uint32Vector
(
)
)
;
[
[
nodiscard
]
]
bool
finishFuncDefs
(
)
;
SharedModule
finishModule
(
const
ShareableBytes
&
bytecode
MutableModuleMetadata
moduleMeta
JS
:
:
OptimizedEncodingListener
*
maybeCompleteTier2Listener
)
;
[
[
nodiscard
]
]
bool
finishTier2
(
const
Module
&
module
)
;
[
[
nodiscard
]
]
bool
finishPartialTier2
(
)
;
}
;
}
}
#
endif
