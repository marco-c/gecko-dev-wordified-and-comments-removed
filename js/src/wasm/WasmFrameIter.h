#
ifndef
wasm_frame_iter_h
#
define
wasm_frame_iter_h
#
include
"
js
/
ProfilingFrameIterator
.
h
"
class
JSAtom
;
namespace
js
{
class
WasmActivation
;
namespace
jit
{
class
MacroAssembler
;
}
namespace
wasm
{
class
CallSite
;
class
Code
;
class
CodeRange
;
class
DebugFrame
;
class
DebugState
;
class
Instance
;
class
SigIdDesc
;
struct
Frame
;
struct
FuncOffsets
;
struct
CallableOffsets
;
class
WasmFrameIter
{
public
:
enum
class
Unwind
{
True
False
}
;
private
:
WasmActivation
*
activation_
;
const
Code
*
code_
;
const
CallSite
*
callsite_
;
const
CodeRange
*
codeRange_
;
Frame
*
fp_
;
Unwind
unwind_
;
void
*
*
unwoundAddressOfReturnAddress_
;
void
popFrame
(
)
;
public
:
explicit
WasmFrameIter
(
)
;
explicit
WasmFrameIter
(
WasmActivation
*
activation
Unwind
unwind
=
Unwind
:
:
False
)
;
void
operator
+
+
(
)
;
bool
done
(
)
const
;
const
char
*
filename
(
)
const
;
const
char16_t
*
displayURL
(
)
const
;
bool
mutedErrors
(
)
const
;
JSAtom
*
functionDisplayAtom
(
)
const
;
unsigned
lineOrBytecode
(
)
const
;
const
CodeRange
*
codeRange
(
)
const
{
return
codeRange_
;
}
Instance
*
instance
(
)
const
;
void
*
*
unwoundAddressOfReturnAddress
(
)
const
;
bool
debugEnabled
(
)
const
;
DebugFrame
*
debugFrame
(
)
const
;
const
CallSite
*
debugTrapCallsite
(
)
const
;
}
;
enum
class
SymbolicAddress
;
class
ExitReason
{
uint32_t
payload_
;
ExitReason
(
)
{
}
public
:
enum
class
Fixed
:
uint32_t
{
None
ImportJit
ImportInterp
BuiltinNative
Trap
DebugTrap
}
;
MOZ_IMPLICIT
ExitReason
(
Fixed
exitReason
)
:
payload_
(
0x0
|
(
uint32_t
(
exitReason
)
<
<
1
)
)
{
MOZ_ASSERT
(
isFixed
(
)
)
;
}
explicit
ExitReason
(
SymbolicAddress
sym
)
:
payload_
(
0x1
|
(
uint32_t
(
sym
)
<
<
1
)
)
{
MOZ_ASSERT
(
uint32_t
(
sym
)
<
=
(
UINT32_MAX
<
<
1
)
"
packing
constraints
"
)
;
MOZ_ASSERT
(
!
isFixed
(
)
)
;
}
static
ExitReason
Decode
(
uint32_t
payload
)
{
ExitReason
reason
;
reason
.
payload_
=
payload
;
return
reason
;
}
static
ExitReason
None
(
)
{
return
ExitReason
(
ExitReason
:
:
Fixed
:
:
None
)
;
}
bool
isFixed
(
)
const
{
return
(
payload_
&
0x1
)
=
=
0
;
}
bool
isNone
(
)
const
{
return
isFixed
(
)
&
&
fixed
(
)
=
=
Fixed
:
:
None
;
}
bool
isNative
(
)
const
{
return
!
isFixed
(
)
|
|
fixed
(
)
=
=
Fixed
:
:
BuiltinNative
;
}
uint32_t
encode
(
)
const
{
return
payload_
;
}
Fixed
fixed
(
)
const
{
MOZ_ASSERT
(
isFixed
(
)
)
;
return
Fixed
(
payload_
>
>
1
)
;
}
SymbolicAddress
symbolic
(
)
const
{
MOZ_ASSERT
(
!
isFixed
(
)
)
;
return
SymbolicAddress
(
payload_
>
>
1
)
;
}
}
;
class
ProfilingFrameIterator
{
const
WasmActivation
*
activation_
;
const
Code
*
code_
;
const
CodeRange
*
codeRange_
;
Frame
*
callerFP_
;
void
*
callerPC_
;
void
*
stackAddress_
;
ExitReason
exitReason_
;
void
initFromExitFP
(
)
;
public
:
ProfilingFrameIterator
(
)
;
explicit
ProfilingFrameIterator
(
const
WasmActivation
&
activation
)
;
ProfilingFrameIterator
(
const
WasmActivation
&
activation
const
JS
:
:
ProfilingFrameIterator
:
:
RegisterState
&
state
)
;
void
operator
+
+
(
)
;
bool
done
(
)
const
{
return
!
codeRange_
;
}
void
*
stackAddress
(
)
const
{
MOZ_ASSERT
(
!
done
(
)
)
;
return
stackAddress_
;
}
const
char
*
label
(
)
const
;
}
;
void
GenerateExitPrologue
(
jit
:
:
MacroAssembler
&
masm
unsigned
framePushed
ExitReason
reason
CallableOffsets
*
offsets
)
;
void
GenerateExitEpilogue
(
jit
:
:
MacroAssembler
&
masm
unsigned
framePushed
ExitReason
reason
CallableOffsets
*
offsets
)
;
void
GenerateFunctionPrologue
(
jit
:
:
MacroAssembler
&
masm
unsigned
framePushed
const
SigIdDesc
&
sigId
FuncOffsets
*
offsets
)
;
void
GenerateFunctionEpilogue
(
jit
:
:
MacroAssembler
&
masm
unsigned
framePushed
FuncOffsets
*
offsets
)
;
void
TraceActivations
(
JSContext
*
cx
const
CooperatingContext
&
target
JSTracer
*
trc
)
;
Instance
*
LookupFaultingInstance
(
WasmActivation
*
activation
void
*
pc
void
*
fp
)
;
WasmActivation
*
ActivationIfInnermost
(
JSContext
*
cx
)
;
bool
InCompiledCode
(
void
*
pc
)
;
struct
UnwindState
{
Frame
*
fp
;
void
*
pc
;
const
Code
*
code
;
const
CodeRange
*
codeRange
;
UnwindState
(
)
:
fp
(
nullptr
)
pc
(
nullptr
)
code
(
nullptr
)
codeRange
(
nullptr
)
{
}
}
;
typedef
JS
:
:
ProfilingFrameIterator
:
:
RegisterState
RegisterState
;
bool
StartUnwinding
(
const
WasmActivation
&
activation
const
RegisterState
&
registers
UnwindState
*
unwindState
bool
*
unwoundCaller
)
;
}
}
#
endif
