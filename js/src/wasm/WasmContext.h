#
ifndef
wasm_context_h
#
define
wasm_context_h
#
ifdef
ENABLE_WASM_JSPI
#
include
"
gc
/
Barrier
.
h
"
#
endif
#
include
"
js
/
NativeStackLimits
.
h
"
#
ifdef
_WIN32
struct
_NT_TIB
;
#
endif
namespace
js
:
:
wasm
{
#
ifdef
ENABLE_WASM_JSPI
class
SuspenderObject
;
using
SuspenderObjectSet
=
HashSet
<
SuspenderObject
*
PointerHasher
<
SuspenderObject
*
>
SystemAllocPolicy
>
;
#
endif
class
Context
{
public
:
Context
(
)
;
~
Context
(
)
;
static
constexpr
size_t
offsetOfStackLimit
(
)
{
return
offsetof
(
Context
stackLimit
)
;
}
static
constexpr
size_t
offsetOfMainStackLimit
(
)
{
return
offsetof
(
Context
mainStackLimit
)
;
}
void
initStackLimit
(
JSContext
*
cx
)
;
#
ifdef
ENABLE_WASM_JSPI
static
constexpr
size_t
offsetOfActiveSuspender
(
)
{
return
offsetof
(
Context
activeSuspender_
)
;
}
#
ifdef
_WIN32
static
constexpr
size_t
offsetOfTib
(
)
{
return
offsetof
(
Context
tib_
)
;
}
static
constexpr
size_t
offsetOfTibStackBase
(
)
{
return
offsetof
(
Context
tibStackBase_
)
;
}
static
constexpr
size_t
offsetOfTibStackLimit
(
)
{
return
offsetof
(
Context
tibStackLimit_
)
;
}
#
endif
SuspenderObject
*
activeSuspender
(
)
{
return
activeSuspender_
;
}
bool
onSuspendableStack
(
)
const
{
return
activeSuspender_
!
=
nullptr
;
}
void
enterSuspendableStack
(
JSContext
*
cx
SuspenderObject
*
suspender
)
;
void
leaveSuspendableStack
(
JSContext
*
cx
)
;
void
trace
(
JSTracer
*
trc
)
;
void
traceRoots
(
JSTracer
*
trc
)
;
#
endif
bool
triedToInstallSignalHandlers
;
bool
haveSignalHandlers
;
JS
:
:
NativeStackLimit
stackLimit
;
JS
:
:
NativeStackLimit
mainStackLimit
;
#
ifdef
ENABLE_WASM_JSPI
#
if
defined
(
_WIN32
)
_NT_TIB
*
tib_
=
nullptr
;
void
*
tibStackBase_
=
nullptr
;
void
*
tibStackLimit_
=
nullptr
;
#
endif
HeapPtr
<
SuspenderObject
*
>
activeSuspender_
;
SuspenderObjectSet
suspenders_
;
#
endif
}
;
}
#
endif
