#
ifndef
wasm_code_h
#
define
wasm_code_h
#
include
"
js
/
HashTable
.
h
"
#
include
"
wasm
/
WasmTypes
.
h
"
namespace
js
{
struct
AsmJSMetadata
;
class
Debugger
;
class
WasmActivation
;
class
WasmBreakpoint
;
class
WasmBreakpointSite
;
class
WasmInstanceObject
;
namespace
wasm
{
struct
LinkData
;
struct
Metadata
;
class
FrameIterator
;
class
CodeSegment
;
typedef
UniquePtr
<
CodeSegment
>
UniqueCodeSegment
;
class
CodeSegment
{
uint8_t
*
bytes_
;
uint32_t
functionLength_
;
uint32_t
length_
;
uint8_t
*
interruptCode_
;
uint8_t
*
outOfBoundsCode_
;
uint8_t
*
unalignedAccessCode_
;
bool
profilingEnabled_
;
CodeSegment
(
)
{
PodZero
(
this
)
;
}
template
<
class
>
friend
struct
js
:
:
MallocProvider
;
CodeSegment
(
const
CodeSegment
&
)
=
delete
;
CodeSegment
(
CodeSegment
&
&
)
=
delete
;
void
operator
=
(
const
CodeSegment
&
)
=
delete
;
void
operator
=
(
CodeSegment
&
&
)
=
delete
;
public
:
static
UniqueCodeSegment
create
(
JSContext
*
cx
const
Bytes
&
code
const
LinkData
&
linkData
const
Metadata
&
metadata
HandleWasmMemoryObject
memory
)
;
~
CodeSegment
(
)
;
uint8_t
*
base
(
)
const
{
return
bytes_
;
}
uint32_t
length
(
)
const
{
return
length_
;
}
uint8_t
*
interruptCode
(
)
const
{
return
interruptCode_
;
}
uint8_t
*
outOfBoundsCode
(
)
const
{
return
outOfBoundsCode_
;
}
uint8_t
*
unalignedAccessCode
(
)
const
{
return
unalignedAccessCode_
;
}
bool
containsFunctionPC
(
const
void
*
pc
)
const
{
return
pc
>
=
base
(
)
&
&
pc
<
(
base
(
)
+
functionLength_
)
;
}
bool
containsCodePC
(
const
void
*
pc
)
const
{
return
pc
>
=
base
(
)
&
&
pc
<
(
base
(
)
+
length_
)
;
}
void
onMovingGrow
(
uint8_t
*
prevMemoryBase
const
Metadata
&
metadata
ArrayBufferObject
&
buffer
)
;
}
;
struct
ShareableBytes
:
ShareableBase
<
ShareableBytes
>
{
Bytes
bytes
;
size_t
sizeOfExcludingThis
(
MallocSizeOf
m
)
const
{
return
bytes
.
sizeOfExcludingThis
(
m
)
;
}
const
uint8_t
*
begin
(
)
const
{
return
bytes
.
begin
(
)
;
}
const
uint8_t
*
end
(
)
const
{
return
bytes
.
end
(
)
;
}
size_t
length
(
)
const
{
return
bytes
.
length
(
)
;
}
bool
append
(
const
uint8_t
*
p
uint32_t
ct
)
{
return
bytes
.
append
(
p
ct
)
;
}
}
;
typedef
RefPtr
<
ShareableBytes
>
MutableBytes
;
typedef
RefPtr
<
const
ShareableBytes
>
SharedBytes
;
class
FuncExport
{
Sig
sig_
;
MOZ_INIT_OUTSIDE_CTOR
struct
CacheablePod
{
uint32_t
funcIndex_
;
uint32_t
codeRangeIndex_
;
uint32_t
entryOffset_
;
}
pod
;
public
:
FuncExport
(
)
=
default
;
explicit
FuncExport
(
Sig
&
&
sig
uint32_t
funcIndex
uint32_t
codeRangeIndex
)
:
sig_
(
Move
(
sig
)
)
{
pod
.
funcIndex_
=
funcIndex
;
pod
.
codeRangeIndex_
=
codeRangeIndex
;
pod
.
entryOffset_
=
UINT32_MAX
;
}
void
initEntryOffset
(
uint32_t
entryOffset
)
{
MOZ_ASSERT
(
pod
.
entryOffset_
=
=
UINT32_MAX
)
;
pod
.
entryOffset_
=
entryOffset
;
}
const
Sig
&
sig
(
)
const
{
return
sig_
;
}
uint32_t
funcIndex
(
)
const
{
return
pod
.
funcIndex_
;
}
uint32_t
codeRangeIndex
(
)
const
{
return
pod
.
codeRangeIndex_
;
}
uint32_t
entryOffset
(
)
const
{
MOZ_ASSERT
(
pod
.
entryOffset_
!
=
UINT32_MAX
)
;
return
pod
.
entryOffset_
;
}
WASM_DECLARE_SERIALIZABLE
(
FuncExport
)
}
;
typedef
Vector
<
FuncExport
0
SystemAllocPolicy
>
FuncExportVector
;
class
FuncImport
{
Sig
sig_
;
struct
CacheablePod
{
uint32_t
tlsDataOffset_
;
uint32_t
interpExitCodeOffset_
;
uint32_t
jitExitCodeOffset_
;
}
pod
;
public
:
FuncImport
(
)
{
memset
(
&
pod
0
sizeof
(
CacheablePod
)
)
;
}
FuncImport
(
Sig
&
&
sig
uint32_t
tlsDataOffset
)
:
sig_
(
Move
(
sig
)
)
{
pod
.
tlsDataOffset_
=
tlsDataOffset
;
pod
.
interpExitCodeOffset_
=
0
;
pod
.
jitExitCodeOffset_
=
0
;
}
void
initInterpExitOffset
(
uint32_t
off
)
{
MOZ_ASSERT
(
!
pod
.
interpExitCodeOffset_
)
;
pod
.
interpExitCodeOffset_
=
off
;
}
void
initJitExitOffset
(
uint32_t
off
)
{
MOZ_ASSERT
(
!
pod
.
jitExitCodeOffset_
)
;
pod
.
jitExitCodeOffset_
=
off
;
}
const
Sig
&
sig
(
)
const
{
return
sig_
;
}
uint32_t
tlsDataOffset
(
)
const
{
return
pod
.
tlsDataOffset_
;
}
uint32_t
interpExitCodeOffset
(
)
const
{
return
pod
.
interpExitCodeOffset_
;
}
uint32_t
jitExitCodeOffset
(
)
const
{
return
pod
.
jitExitCodeOffset_
;
}
WASM_DECLARE_SERIALIZABLE
(
FuncImport
)
}
;
typedef
Vector
<
FuncImport
0
SystemAllocPolicy
>
FuncImportVector
;
class
CodeRange
{
public
:
enum
Kind
{
Function
Entry
ImportJitExit
ImportInterpExit
TrapExit
DebugTrap
FarJumpIsland
Inline
}
;
private
:
uint32_t
begin_
;
uint32_t
profilingReturn_
;
uint32_t
end_
;
uint32_t
funcIndex_
;
uint32_t
funcLineOrBytecode_
;
uint8_t
funcBeginToTableEntry_
;
uint8_t
funcBeginToTableProfilingJump_
;
uint8_t
funcBeginToNonProfilingEntry_
;
uint8_t
funcProfilingJumpToProfilingReturn_
;
uint8_t
funcProfilingEpilogueToProfilingReturn_
;
Kind
kind_
:
8
;
public
:
CodeRange
(
)
=
default
;
CodeRange
(
Kind
kind
Offsets
offsets
)
;
CodeRange
(
Kind
kind
ProfilingOffsets
offsets
)
;
CodeRange
(
uint32_t
funcIndex
uint32_t
lineOrBytecode
FuncOffsets
offsets
)
;
uint32_t
begin
(
)
const
{
return
begin_
;
}
uint32_t
end
(
)
const
{
return
end_
;
}
Kind
kind
(
)
const
{
return
kind_
;
}
bool
isFunction
(
)
const
{
return
kind
(
)
=
=
Function
;
}
bool
isImportExit
(
)
const
{
return
kind
(
)
=
=
ImportJitExit
|
|
kind
(
)
=
=
ImportInterpExit
;
}
bool
isTrapExit
(
)
const
{
return
kind
(
)
=
=
TrapExit
;
}
bool
isInline
(
)
const
{
return
kind
(
)
=
=
Inline
;
}
uint32_t
profilingReturn
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
|
|
isImportExit
(
)
|
|
isTrapExit
(
)
)
;
return
profilingReturn_
;
}
uint32_t
funcProfilingEntry
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin
(
)
;
}
uint32_t
funcTableEntry
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin_
+
funcBeginToTableEntry_
;
}
uint32_t
funcTableProfilingJump
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin_
+
funcBeginToTableProfilingJump_
;
}
uint32_t
funcNonProfilingEntry
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
begin_
+
funcBeginToNonProfilingEntry_
;
}
uint32_t
funcProfilingJump
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
profilingReturn_
-
funcProfilingJumpToProfilingReturn_
;
}
uint32_t
funcProfilingEpilogue
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
profilingReturn_
-
funcProfilingEpilogueToProfilingReturn_
;
}
uint32_t
funcIndex
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
funcIndex_
;
}
uint32_t
funcLineOrBytecode
(
)
const
{
MOZ_ASSERT
(
isFunction
(
)
)
;
return
funcLineOrBytecode_
;
}
struct
PC
{
size_t
offset
;
explicit
PC
(
size_t
offset
)
:
offset
(
offset
)
{
}
bool
operator
=
=
(
const
CodeRange
&
rhs
)
const
{
return
offset
>
=
rhs
.
begin
(
)
&
&
offset
<
rhs
.
end
(
)
;
}
bool
operator
<
(
const
CodeRange
&
rhs
)
const
{
return
offset
<
rhs
.
begin
(
)
;
}
}
;
}
;
WASM_DECLARE_POD_VECTOR
(
CodeRange
CodeRangeVector
)
struct
CallThunk
{
uint32_t
offset
;
union
{
uint32_t
funcIndex
;
uint32_t
codeRangeIndex
;
}
u
;
CallThunk
(
uint32_t
offset
uint32_t
funcIndex
)
:
offset
(
offset
)
{
u
.
funcIndex
=
funcIndex
;
}
CallThunk
(
)
=
default
;
}
;
WASM_DECLARE_POD_VECTOR
(
CallThunk
CallThunkVector
)
enum
class
MemoryUsage
{
None
=
false
Unshared
=
1
Shared
=
2
}
;
static
inline
bool
UsesMemory
(
MemoryUsage
memoryUsage
)
{
return
bool
(
memoryUsage
)
;
}
struct
NameInBytecode
{
uint32_t
offset
;
uint32_t
length
;
NameInBytecode
(
)
=
default
;
NameInBytecode
(
uint32_t
offset
uint32_t
length
)
:
offset
(
offset
)
length
(
length
)
{
}
}
;
typedef
Vector
<
NameInBytecode
0
SystemAllocPolicy
>
NameInBytecodeVector
;
struct
CustomSection
{
NameInBytecode
name
;
uint32_t
offset
;
uint32_t
length
;
CustomSection
(
)
=
default
;
CustomSection
(
NameInBytecode
name
uint32_t
offset
uint32_t
length
)
:
name
(
name
)
offset
(
offset
)
length
(
length
)
{
}
}
;
typedef
Vector
<
CustomSection
0
SystemAllocPolicy
>
CustomSectionVector
;
struct
MetadataCacheablePod
{
ModuleKind
kind
;
MemoryUsage
memoryUsage
;
uint32_t
minMemoryLength
;
Maybe
<
uint32_t
>
maxMemoryLength
;
Maybe
<
uint32_t
>
startFuncIndex
;
explicit
MetadataCacheablePod
(
ModuleKind
kind
)
:
kind
(
kind
)
memoryUsage
(
MemoryUsage
:
:
None
)
minMemoryLength
(
0
)
{
}
}
;
struct
Metadata
:
ShareableBase
<
Metadata
>
MetadataCacheablePod
{
explicit
Metadata
(
ModuleKind
kind
=
ModuleKind
:
:
Wasm
)
:
MetadataCacheablePod
(
kind
)
{
}
virtual
~
Metadata
(
)
{
}
MetadataCacheablePod
&
pod
(
)
{
return
*
this
;
}
const
MetadataCacheablePod
&
pod
(
)
const
{
return
*
this
;
}
FuncImportVector
funcImports
;
FuncExportVector
funcExports
;
SigWithIdVector
sigIds
;
GlobalDescVector
globals
;
TableDescVector
tables
;
MemoryAccessVector
memoryAccesses
;
MemoryPatchVector
memoryPatches
;
BoundsCheckVector
boundsChecks
;
CodeRangeVector
codeRanges
;
CallSiteVector
callSites
;
CallThunkVector
callThunks
;
NameInBytecodeVector
funcNames
;
CustomSectionVector
customSections
;
CacheableChars
filename
;
bool
debugEnabled
;
Uint32Vector
debugTrapFarJumpOffsets
;
bool
usesMemory
(
)
const
{
return
UsesMemory
(
memoryUsage
)
;
}
bool
hasSharedMemory
(
)
const
{
return
memoryUsage
=
=
MemoryUsage
:
:
Shared
;
}
const
FuncExport
&
lookupFuncExport
(
uint32_t
funcIndex
)
const
;
bool
isAsmJS
(
)
const
{
return
kind
=
=
ModuleKind
:
:
AsmJS
;
}
const
AsmJSMetadata
&
asAsmJS
(
)
const
{
MOZ_ASSERT
(
isAsmJS
(
)
)
;
return
*
(
const
AsmJSMetadata
*
)
this
;
}
virtual
bool
mutedErrors
(
)
const
{
return
false
;
}
virtual
const
char16_t
*
displayURL
(
)
const
{
return
nullptr
;
}
virtual
ScriptSource
*
maybeScriptSource
(
)
const
{
return
nullptr
;
}
virtual
bool
getFuncName
(
const
Bytes
*
maybeBytecode
uint32_t
funcIndex
UTF8Bytes
*
name
)
const
;
WASM_DECLARE_SERIALIZABLE_VIRTUAL
(
Metadata
)
;
}
;
typedef
RefPtr
<
Metadata
>
MutableMetadata
;
typedef
RefPtr
<
const
Metadata
>
SharedMetadata
;
struct
ExprLoc
{
uint32_t
lineno
;
uint32_t
column
;
uint32_t
offset
;
ExprLoc
(
)
:
lineno
(
0
)
column
(
0
)
offset
(
0
)
{
}
ExprLoc
(
uint32_t
lineno_
uint32_t
column_
uint32_t
offset_
)
:
lineno
(
lineno_
)
column
(
column_
)
offset
(
offset_
)
{
}
}
;
typedef
Vector
<
ExprLoc
0
SystemAllocPolicy
>
ExprLocVector
;
struct
FunctionLoc
{
size_t
startExprsIndex
;
size_t
endExprsIndex
;
uint32_t
startLineno
;
uint32_t
endLineno
;
FunctionLoc
(
size_t
startExprsIndex_
size_t
endExprsIndex_
uint32_t
startLineno_
uint32_t
endLineno_
)
:
startExprsIndex
(
startExprsIndex_
)
endExprsIndex
(
endExprsIndex_
)
startLineno
(
startLineno_
)
endLineno
(
endLineno_
)
{
}
}
;
typedef
Vector
<
FunctionLoc
0
SystemAllocPolicy
>
FunctionLocVector
;
typedef
Vector
<
uint32_t
0
SystemAllocPolicy
>
ExprLocIndexVector
;
class
GeneratedSourceMap
{
ExprLocVector
exprlocs_
;
FunctionLocVector
functionlocs_
;
UniquePtr
<
ExprLocIndexVector
>
sortedByOffsetExprLocIndices_
;
uint32_t
totalLines_
;
public
:
explicit
GeneratedSourceMap
(
)
:
exprlocs_
(
)
functionlocs_
(
)
totalLines_
(
0
)
{
}
ExprLocVector
&
exprlocs
(
)
{
return
exprlocs_
;
}
FunctionLocVector
&
functionlocs
(
)
{
return
functionlocs_
;
}
uint32_t
totalLines
(
)
{
return
totalLines_
;
}
void
setTotalLines
(
uint32_t
val
)
{
totalLines_
=
val
;
}
bool
searchLineByOffset
(
JSContext
*
cx
uint32_t
offset
size_t
*
exprlocIndex
)
;
}
;
typedef
UniquePtr
<
GeneratedSourceMap
>
UniqueGeneratedSourceMap
;
typedef
HashMap
<
uint32_t
uint32_t
DefaultHasher
<
uint32_t
>
SystemAllocPolicy
>
StepModeCounters
;
typedef
HashMap
<
uint32_t
WasmBreakpointSite
*
DefaultHasher
<
uint32_t
>
SystemAllocPolicy
>
WasmBreakpointSiteMap
;
class
Code
{
const
UniqueCodeSegment
segment_
;
const
SharedMetadata
metadata_
;
const
SharedBytes
maybeBytecode_
;
UniqueGeneratedSourceMap
maybeSourceMap_
;
CacheableCharsVector
funcLabels_
;
bool
profilingEnabled_
;
uint32_t
enterAndLeaveFrameTrapsCounter_
;
WasmBreakpointSiteMap
breakpointSites_
;
StepModeCounters
stepModeCounters_
;
void
toggleDebugTrap
(
uint32_t
offset
bool
enabled
)
;
bool
ensureSourceMap
(
JSContext
*
cx
)
;
public
:
Code
(
UniqueCodeSegment
segment
const
Metadata
&
metadata
const
ShareableBytes
*
maybeBytecode
)
;
CodeSegment
&
segment
(
)
{
return
*
segment_
;
}
const
CodeSegment
&
segment
(
)
const
{
return
*
segment_
;
}
const
Metadata
&
metadata
(
)
const
{
return
*
metadata_
;
}
const
CallSite
*
lookupCallSite
(
void
*
returnAddress
)
const
;
const
CodeRange
*
lookupRange
(
void
*
pc
)
const
;
const
CodeRange
*
lookupRangeByFuncIndexSlow
(
uint32_t
funcIndex
)
const
;
const
MemoryAccess
*
lookupMemoryAccess
(
void
*
pc
)
const
;
bool
getFuncName
(
uint32_t
funcIndex
UTF8Bytes
*
name
)
const
;
JSAtom
*
getFuncAtom
(
JSContext
*
cx
uint32_t
funcIndex
)
const
;
JSString
*
createText
(
JSContext
*
cx
)
;
bool
getLineOffsets
(
JSContext
*
cx
size_t
lineno
Vector
<
uint32_t
>
*
offsets
)
;
bool
getOffsetLocation
(
JSContext
*
cx
uint32_t
offset
bool
*
found
size_t
*
lineno
size_t
*
column
)
;
bool
totalSourceLines
(
JSContext
*
cx
uint32_t
*
count
)
;
MOZ_MUST_USE
bool
ensureProfilingState
(
JSRuntime
*
rt
bool
enabled
)
;
bool
profilingEnabled
(
)
const
{
return
profilingEnabled_
;
}
const
char
*
profilingLabel
(
uint32_t
funcIndex
)
const
{
return
funcLabels_
[
funcIndex
]
.
get
(
)
;
}
void
adjustEnterAndLeaveFrameTrapsState
(
JSContext
*
cx
bool
enabled
)
;
bool
hasBreakpointTrapAtOffset
(
uint32_t
offset
)
;
void
toggleBreakpointTrap
(
JSRuntime
*
rt
uint32_t
offset
bool
enabled
)
;
WasmBreakpointSite
*
getOrCreateBreakpointSite
(
JSContext
*
cx
uint32_t
offset
)
;
bool
hasBreakpointSite
(
uint32_t
offset
)
;
void
destroyBreakpointSite
(
FreeOp
*
fop
uint32_t
offset
)
;
bool
clearBreakpointsIn
(
JSContext
*
cx
WasmInstanceObject
*
instance
js
:
:
Debugger
*
dbg
JSObject
*
handler
)
;
bool
stepModeEnabled
(
uint32_t
funcIndex
)
const
;
bool
incrementStepModeCount
(
JSContext
*
cx
uint32_t
funcIndex
)
;
bool
decrementStepModeCount
(
JSContext
*
cx
uint32_t
funcIndex
)
;
void
addSizeOfMisc
(
MallocSizeOf
mallocSizeOf
Metadata
:
:
SeenSet
*
seenMetadata
ShareableBytes
:
:
SeenSet
*
seenBytes
size_t
*
code
size_t
*
data
)
const
;
WASM_DECLARE_SERIALIZABLE
(
Code
)
;
}
;
typedef
UniquePtr
<
Code
>
UniqueCode
;
}
}
#
endif
