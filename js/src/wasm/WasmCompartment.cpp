#
include
"
wasm
/
WasmCompartment
.
h
"
#
include
"
jscompartment
.
h
"
#
include
"
wasm
/
WasmInstance
.
h
"
#
include
"
vm
/
Debugger
-
inl
.
h
"
using
namespace
js
;
using
namespace
wasm
;
Compartment
:
:
Compartment
(
Zone
*
zone
)
:
mutatingInstances_
(
false
)
interruptedCount_
(
0
)
{
}
Compartment
:
:
~
Compartment
(
)
{
MOZ_ASSERT
(
interruptedCount_
=
=
0
)
;
MOZ_ASSERT
(
instances_
.
empty
(
)
)
;
MOZ_ASSERT
(
!
mutatingInstances_
)
;
}
struct
InstanceComparator
{
const
Instance
&
target
;
explicit
InstanceComparator
(
const
Instance
&
target
)
:
target
(
target
)
{
}
int
operator
(
)
(
const
Instance
*
instance
)
const
{
if
(
instance
=
=
&
target
)
return
0
;
if
(
instance
-
>
codeBase
(
)
=
=
target
.
codeBase
(
)
)
return
instance
<
&
target
?
-
1
:
1
;
return
target
.
codeBase
(
)
<
instance
-
>
codeBase
(
)
?
-
1
:
1
;
}
}
;
void
Compartment
:
:
trace
(
JSTracer
*
trc
)
{
if
(
interruptedCount_
)
{
for
(
Instance
*
i
:
instances_
)
i
-
>
trace
(
trc
)
;
}
}
bool
Compartment
:
:
registerInstance
(
JSContext
*
cx
HandleWasmInstanceObject
instanceObj
)
{
Instance
&
instance
=
instanceObj
-
>
instance
(
)
;
MOZ_ASSERT
(
this
=
=
&
instance
.
compartment
(
)
-
>
wasm
)
;
instance
.
code
(
)
.
ensureProfilingLabels
(
cx
-
>
runtime
(
)
-
>
geckoProfiler
(
)
.
enabled
(
)
)
;
size_t
index
;
if
(
BinarySearchIf
(
instances_
0
instances_
.
length
(
)
InstanceComparator
(
instance
)
&
index
)
)
MOZ_CRASH
(
"
duplicate
registration
"
)
;
{
AutoMutateInstances
guard
(
*
this
)
;
if
(
!
instances_
.
insert
(
instances_
.
begin
(
)
+
index
&
instance
)
)
{
ReportOutOfMemory
(
cx
)
;
return
false
;
}
}
Debugger
:
:
onNewWasmInstance
(
cx
instanceObj
)
;
return
true
;
}
void
Compartment
:
:
unregisterInstance
(
Instance
&
instance
)
{
size_t
index
;
if
(
!
BinarySearchIf
(
instances_
0
instances_
.
length
(
)
InstanceComparator
(
instance
)
&
index
)
)
return
;
AutoMutateInstances
guard
(
*
this
)
;
instances_
.
erase
(
instances_
.
begin
(
)
+
index
)
;
}
struct
PCComparator
{
const
void
*
pc
;
explicit
PCComparator
(
const
void
*
pc
)
:
pc
(
pc
)
{
}
int
operator
(
)
(
const
Instance
*
instance
)
const
{
if
(
instance
-
>
codeSegment
(
)
.
containsCodePC
(
pc
)
)
return
0
;
return
pc
<
instance
-
>
codeBase
(
)
?
-
1
:
1
;
}
}
;
Code
*
Compartment
:
:
lookupCode
(
const
void
*
pc
)
const
{
if
(
mutatingInstances_
)
return
nullptr
;
size_t
index
;
if
(
!
BinarySearchIf
(
instances_
0
instances_
.
length
(
)
PCComparator
(
pc
)
&
index
)
)
return
nullptr
;
return
&
instances_
[
index
]
-
>
code
(
)
;
}
void
Compartment
:
:
setInterrupted
(
bool
interrupted
)
{
if
(
interrupted
)
{
interruptedCount_
+
+
;
}
else
{
MOZ_ASSERT
(
interruptedCount_
>
0
)
;
interruptedCount_
-
-
;
}
}
void
Compartment
:
:
ensureProfilingLabels
(
bool
profilingEnabled
)
{
for
(
Instance
*
instance
:
instances_
)
instance
-
>
code
(
)
.
ensureProfilingLabels
(
profilingEnabled
)
;
}
void
Compartment
:
:
addSizeOfExcludingThis
(
MallocSizeOf
mallocSizeOf
size_t
*
compartmentTables
)
{
*
compartmentTables
+
=
instances_
.
sizeOfExcludingThis
(
mallocSizeOf
)
;
}
