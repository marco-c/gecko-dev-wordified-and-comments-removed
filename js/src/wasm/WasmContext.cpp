#
include
"
wasm
/
WasmContext
.
h
"
#
include
"
jit
/
JitRuntime
.
h
"
#
include
"
js
/
friend
/
StackLimits
.
h
"
#
include
"
js
/
TracingAPI
.
h
"
#
include
"
vm
/
JSContext
.
h
"
#
include
"
wasm
/
WasmPI
.
h
"
#
ifdef
XP_WIN
#
include
<
winternl
.
h
>
#
include
"
util
/
WindowsWrapper
.
h
"
#
endif
using
namespace
js
:
:
wasm
;
Context
:
:
Context
(
)
:
triedToInstallSignalHandlers
(
false
)
haveSignalHandlers
(
false
)
stackLimit
(
JS
:
:
NativeStackLimitMin
)
mainStackLimit
(
JS
:
:
NativeStackLimitMin
)
#
ifdef
ENABLE_WASM_JSPI
activeSuspender_
(
nullptr
)
#
endif
{
}
Context
:
:
~
Context
(
)
{
#
ifdef
ENABLE_WASM_JSPI
MOZ_ASSERT
(
activeSuspender_
=
=
nullptr
)
;
MOZ_ASSERT
(
suspenders_
.
empty
(
)
)
;
#
endif
}
void
Context
:
:
initStackLimit
(
JSContext
*
cx
)
{
stackLimit
=
cx
-
>
jitStackLimitNoInterrupt
;
mainStackLimit
=
stackLimit
;
#
ifdef
ENABLE_WASM_JSPI
#
if
defined
(
_WIN32
)
tib_
=
reinterpret_cast
<
_NT_TIB
*
>
(
:
:
NtCurrentTeb
(
)
)
;
tibStackBase_
=
tib_
-
>
StackBase
;
tibStackLimit_
=
tib_
-
>
StackLimit
;
#
endif
#
endif
}
#
ifdef
ENABLE_WASM_JSPI
SuspenderObject
*
Context
:
:
findSuspenderForStackAddress
(
const
void
*
stackAddress
)
{
for
(
auto
iter
=
suspenders_
.
iter
(
)
;
!
iter
.
done
(
)
;
iter
.
next
(
)
)
{
SuspenderObject
*
object
=
iter
.
get
(
)
;
if
(
object
-
>
isActive
(
)
&
&
object
-
>
hasStackAddress
(
stackAddress
)
)
{
return
object
;
}
}
return
nullptr
;
}
void
Context
:
:
trace
(
JSTracer
*
trc
)
{
if
(
activeSuspender_
)
{
TraceEdge
(
trc
&
activeSuspender_
"
suspender
"
)
;
}
}
void
Context
:
:
traceRoots
(
JSTracer
*
trc
)
{
if
(
!
trc
-
>
isTenuringTracer
(
)
)
{
return
;
}
gc
:
:
AssertRootMarkingPhase
(
trc
)
;
for
(
auto
iter
=
suspenders_
.
iter
(
)
;
!
iter
.
done
(
)
;
iter
.
next
(
)
)
{
SuspenderObject
*
object
=
iter
.
get
(
)
;
if
(
object
-
>
state
(
)
=
=
SuspenderState
:
:
Suspended
)
{
TraceSuspendableStack
(
trc
object
)
;
}
}
}
void
Context
:
:
enterSuspendableStack
(
JSContext
*
cx
SuspenderObject
*
suspender
)
{
MOZ_ASSERT
(
!
activeSuspender_
)
;
activeSuspender_
=
suspender
;
stackLimit
=
suspender
-
>
stackMemoryLimitForJit
(
)
;
#
if
defined
(
_WIN32
)
tibStackBase_
=
tib_
-
>
StackBase
;
tibStackLimit_
=
tib_
-
>
StackLimit
;
tib_
-
>
StackBase
=
reinterpret_cast
<
void
*
>
(
suspender
-
>
stackMemoryBase
(
)
)
;
tib_
-
>
StackLimit
=
reinterpret_cast
<
void
*
>
(
suspender
-
>
stackMemoryLimitForSystem
(
)
)
;
#
endif
#
ifdef
DEBUG
cx
-
>
runtime
(
)
-
>
jitRuntime
(
)
-
>
disallowArbitraryCode
(
)
;
#
endif
}
void
Context
:
:
leaveSuspendableStack
(
JSContext
*
cx
)
{
MOZ_ASSERT
(
activeSuspender_
)
;
activeSuspender_
=
nullptr
;
stackLimit
=
mainStackLimit
;
#
if
defined
(
_WIN32
)
tib_
-
>
StackBase
=
static_cast
<
void
*
>
(
tibStackBase_
)
;
tib_
-
>
StackLimit
=
static_cast
<
void
*
>
(
tibStackLimit_
)
;
#
endif
#
ifdef
DEBUG
cx
-
>
runtime
(
)
-
>
jitRuntime
(
)
-
>
clearDisallowArbitraryCode
(
)
;
#
endif
}
#
endif
