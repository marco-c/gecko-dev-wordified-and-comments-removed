#
include
"
wasm
/
WasmContext
.
h
"
#
include
"
js
/
friend
/
StackLimits
.
h
"
#
include
"
js
/
TracingAPI
.
h
"
#
include
"
vm
/
JSContext
.
h
"
#
include
"
wasm
/
WasmPI
.
h
"
#
ifdef
XP_WIN
#
include
<
winternl
.
h
>
#
include
"
util
/
WindowsWrapper
.
h
"
#
endif
using
namespace
js
:
:
wasm
;
Context
:
:
Context
(
)
:
triedToInstallSignalHandlers
(
false
)
haveSignalHandlers
(
false
)
stackLimit
(
JS
:
:
NativeStackLimitMin
)
mainStackLimit
(
JS
:
:
NativeStackLimitMin
)
#
ifdef
ENABLE_WASM_JSPI
activeSuspender_
(
nullptr
)
suspendableStacksCount
(
0
)
suspendedStacks_
(
)
#
endif
{
}
Context
:
:
~
Context
(
)
{
#
ifdef
ENABLE_WASM_JSPI
MOZ_ASSERT
(
activeSuspender_
=
=
nullptr
)
;
MOZ_ASSERT
(
suspendedStacks_
.
isEmpty
(
)
)
;
#
endif
}
void
Context
:
:
initStackLimit
(
JSContext
*
cx
)
{
stackLimit
=
cx
-
>
jitStackLimitNoInterrupt
;
mainStackLimit
=
stackLimit
;
#
ifdef
ENABLE_WASM_JSPI
#
if
defined
(
_WIN32
)
_NT_TIB
*
tib
=
reinterpret_cast
<
_NT_TIB
*
>
(
:
:
NtCurrentTeb
(
)
)
;
tibStackBase_
=
tib
-
>
StackBase
;
tibStackLimit_
=
tib
-
>
StackLimit
;
#
endif
#
endif
}
#
ifdef
ENABLE_WASM_JSPI
void
Context
:
:
trace
(
JSTracer
*
trc
)
{
if
(
activeSuspender_
)
{
TraceEdge
(
trc
&
activeSuspender_
"
suspender
"
)
;
}
}
void
Context
:
:
traceRoots
(
JSTracer
*
trc
)
{
if
(
!
trc
-
>
isTenuringTracer
(
)
)
{
return
;
}
gc
:
:
AssertRootMarkingPhase
(
trc
)
;
for
(
const
SuspenderObjectData
&
data
:
suspendedStacks_
)
{
TraceSuspendableStack
(
trc
data
)
;
}
}
void
Context
:
:
enterSuspendableStack
(
SuspenderObject
*
suspender
)
{
MOZ_ASSERT
(
!
activeSuspender_
)
;
activeSuspender_
=
suspender
;
stackLimit
=
suspender
-
>
stackMemoryLimitForJit
(
)
;
#
if
defined
(
_WIN32
)
_NT_TIB
*
tib
=
reinterpret_cast
<
_NT_TIB
*
>
(
:
:
NtCurrentTeb
(
)
)
;
tibStackBase_
=
tib
-
>
StackBase
;
tibStackLimit
=
tib
-
>
StackLimit
;
tib
-
>
StackBase
=
reinterpret_cast
<
void
*
>
(
suspender
-
>
stackMemoryBase
(
)
)
;
tib
-
>
StackLimit
=
reinterpret_cast
<
void
*
>
(
suspender
-
>
stackMemoryLimitForSystem
(
)
)
;
#
endif
}
void
Context
:
:
leaveSuspendableStack
(
)
{
MOZ_ASSERT
(
activeSuspender_
)
;
activeSuspender_
=
nullptr
;
stackLimit
=
mainStackLimit
;
#
if
defined
(
_WIN32
)
_NT_TIB
*
tib
=
reinterpret_cast
<
_NT_TIB
*
>
(
:
:
NtCurrentTeb
(
)
)
;
tib
-
>
StackBase
=
tibStackBase_
;
tib
-
>
StackLimit
=
tibStackLimit_
;
#
endif
}
bool
js
:
:
IsSuspendableStackActive
(
JSContext
*
cx
)
{
return
cx
-
>
wasm
(
)
.
onSuspendableStack
(
)
;
}
JS
:
:
NativeStackLimit
js
:
:
GetSuspendableStackLimit
(
JSContext
*
cx
)
{
MOZ_ASSERT
(
IsSuspendableStackActive
(
cx
)
)
;
return
cx
-
>
wasm
(
)
.
stackLimit
;
}
#
endif
