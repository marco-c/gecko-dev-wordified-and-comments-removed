#
ifndef
wasm_pi_h
#
define
wasm_pi_h
#
include
"
js
/
TypeDecls
.
h
"
#
include
"
vm
/
NativeObject
.
h
"
#
include
"
vm
/
PromiseObject
.
h
"
#
include
"
wasm
/
WasmAnyRef
.
h
"
#
include
"
wasm
/
WasmTypeDef
.
h
"
namespace
js
{
class
WasmStructObject
;
namespace
wasm
{
class
Context
;
#
ifdef
ENABLE_WASM_JSPI
enum
SuspenderState
:
int32_t
{
Moribund
Initial
Active
Suspended
CalledOnMain
}
;
class
SuspenderObject
:
public
NativeObject
{
public
:
static
const
JSClass
class_
;
enum
{
StateSlot
PromisingPromiseSlot
SuspendingReturnTypeSlot
StackMemorySlot
MainFPSlot
MainSPSlot
SuspendableFPSlot
SuspendableSPSlot
SuspendableExitFPSlot
SuspendedRASlot
MainExitFPSlot
SlotCount
}
;
enum
class
ReturnType
:
int32_t
{
Unknown
Promise
Exception
}
;
static
SuspenderObject
*
create
(
JSContext
*
cx
)
;
SuspenderState
state
(
)
const
{
return
(
SuspenderState
)
getFixedSlot
(
StateSlot
)
.
toInt32
(
)
;
}
void
setState
(
SuspenderState
state
)
{
setFixedSlot
(
StateSlot
JS
:
:
Int32Value
(
(
int32_t
)
state
)
)
;
}
bool
isTraceable
(
)
const
{
SuspenderState
current
=
state
(
)
;
return
current
=
=
SuspenderState
:
:
Active
|
|
current
=
=
SuspenderState
:
:
Suspended
|
|
current
=
=
SuspenderState
:
:
CalledOnMain
;
}
bool
isMoribund
(
)
const
{
return
state
(
)
=
=
SuspenderState
:
:
Moribund
;
}
bool
isActive
(
)
const
{
return
state
(
)
=
=
SuspenderState
:
:
Active
;
}
bool
isSuspended
(
)
const
{
return
state
(
)
=
=
SuspenderState
:
:
Suspended
;
}
bool
isCalledOnMain
(
)
const
{
return
state
(
)
=
=
SuspenderState
:
:
CalledOnMain
;
}
PromiseObject
*
promisingPromise
(
)
const
{
return
&
getFixedSlot
(
PromisingPromiseSlot
)
.
toObject
(
)
.
as
<
PromiseObject
>
(
)
;
}
void
setPromisingPromise
(
Handle
<
PromiseObject
*
>
promise
)
{
setFixedSlot
(
PromisingPromiseSlot
ObjectOrNullValue
(
promise
)
)
;
}
ReturnType
suspendingReturnType
(
)
const
{
return
ReturnType
(
getFixedSlot
(
SuspendingReturnTypeSlot
)
.
toInt32
(
)
)
;
}
void
setSuspendingReturnType
(
ReturnType
type
)
{
MOZ_ASSERT
(
(
type
=
=
ReturnType
:
:
Unknown
)
!
=
(
suspendingReturnType
(
)
=
=
ReturnType
:
:
Unknown
)
)
;
setFixedSlot
(
SuspendingReturnTypeSlot
Int32Value
(
int32_t
(
type
)
)
)
;
}
void
*
stackMemory
(
)
const
{
return
getFixedSlot
(
StackMemorySlot
)
.
toPrivate
(
)
;
}
void
setStackMemory
(
void
*
stackMemory
)
{
setFixedSlot
(
StackMemorySlot
PrivateValue
(
stackMemory
)
)
;
}
JS
:
:
NativeStackLimit
stackMemoryBase
(
)
const
{
return
(
(
uintptr_t
)
stackMemory
(
)
)
+
SuspendableStackPlusRedZoneSize
;
}
JS
:
:
NativeStackLimit
stackMemoryLimitForSystem
(
)
const
{
return
JS
:
:
NativeStackLimit
(
stackMemory
(
)
)
;
}
JS
:
:
NativeStackLimit
stackMemoryLimitForJit
(
)
const
{
return
stackMemoryLimitForSystem
(
)
+
SuspendableRedZoneSize
;
}
bool
hasFramePointer
(
void
*
fp
)
const
{
MOZ_ASSERT
(
!
isMoribund
(
)
)
;
void
*
base
=
stackMemory
(
)
;
return
(
uintptr_t
)
base
<
=
(
uintptr_t
)
fp
&
&
(
uintptr_t
)
fp
<
(
uintptr_t
)
base
+
SuspendableStackPlusRedZoneSize
;
}
void
*
mainFP
(
)
const
{
MOZ_ASSERT
(
isActive
(
)
)
;
return
getFixedSlot
(
MainFPSlot
)
.
toPrivate
(
)
;
}
void
*
mainSP
(
)
const
{
MOZ_ASSERT
(
isActive
(
)
)
;
return
getFixedSlot
(
MainSPSlot
)
.
toPrivate
(
)
;
}
void
*
mainExitFP
(
)
const
{
MOZ_ASSERT
(
isSuspended
(
)
)
;
return
getFixedSlot
(
MainExitFPSlot
)
.
toPrivate
(
)
;
}
void
*
suspendableFP
(
)
const
{
MOZ_ASSERT
(
isSuspended
(
)
)
;
return
getFixedSlot
(
SuspendableFPSlot
)
.
toPrivate
(
)
;
}
void
*
suspendableSP
(
)
const
{
MOZ_ASSERT
(
isSuspended
(
)
)
;
return
getFixedSlot
(
SuspendableSPSlot
)
.
toPrivate
(
)
;
}
void
*
suspendedReturnAddress
(
)
const
{
MOZ_ASSERT
(
isSuspended
(
)
)
;
return
getFixedSlot
(
SuspendedRASlot
)
.
toPrivate
(
)
;
}
void
*
suspendableExitFP
(
)
const
{
MOZ_ASSERT
(
isTraceable
(
)
)
;
return
getFixedSlot
(
SuspendableExitFPSlot
)
.
toPrivate
(
)
;
}
static
constexpr
size_t
offsetOfState
(
)
{
return
getFixedSlotOffset
(
StateSlot
)
;
}
static
constexpr
size_t
offsetOfStackMemory
(
)
{
return
getFixedSlotOffset
(
StackMemorySlot
)
;
}
static
constexpr
size_t
offsetOfMainFP
(
)
{
return
getFixedSlotOffset
(
MainFPSlot
)
;
}
static
constexpr
size_t
offsetOfMainSP
(
)
{
return
getFixedSlotOffset
(
MainSPSlot
)
;
}
static
constexpr
size_t
offsetOfSuspendableFP
(
)
{
return
getFixedSlotOffset
(
SuspendableFPSlot
)
;
}
static
constexpr
size_t
offsetOfSuspendableSP
(
)
{
return
getFixedSlotOffset
(
SuspendableSPSlot
)
;
}
static
constexpr
size_t
offsetOfSuspendableExitFP
(
)
{
return
getFixedSlotOffset
(
SuspendableExitFPSlot
)
;
}
static
constexpr
size_t
offsetOfMainExitFP
(
)
{
return
getFixedSlotOffset
(
MainExitFPSlot
)
;
}
static
constexpr
size_t
offsetOfSuspendedReturnAddress
(
)
{
return
getFixedSlotOffset
(
SuspendedRASlot
)
;
}
void
setMoribund
(
JSContext
*
cx
)
;
void
setActive
(
JSContext
*
cx
)
;
void
setSuspended
(
JSContext
*
cx
)
;
void
setCalledOnMain
(
JSContext
*
cx
)
;
void
enter
(
JSContext
*
cx
)
;
void
suspend
(
JSContext
*
cx
)
;
void
resume
(
JSContext
*
cx
)
;
void
leave
(
JSContext
*
cx
)
;
void
releaseStackMemory
(
)
;
#
if
defined
(
JS_SIMULATOR_ARM64
)
|
|
defined
(
JS_SIMULATOR_ARM
)
|
|
\
defined
(
JS_SIMULATOR_RISCV64
)
|
|
defined
(
JS_SIMULATOR_LOONG64
)
|
|
\
defined
(
JS_SIMULATOR_MIPS64
)
void
switchSimulatorToMain
(
)
;
void
switchSimulatorToSuspendable
(
)
;
#
endif
void
forwardToSuspendable
(
)
;
private
:
static
const
JSClassOps
classOps_
;
static
const
ClassExtension
classExt_
;
static
void
finalize
(
JS
:
:
GCContext
*
gcx
JSObject
*
obj
)
;
static
void
trace
(
JSTracer
*
trc
JSObject
*
obj
)
;
static
size_t
moved
(
JSObject
*
obj
JSObject
*
old
)
;
}
;
using
CallOnMainStackFn
=
bool
(
*
)
(
void
*
data
)
;
bool
CallOnMainStack
(
JSContext
*
cx
CallOnMainStackFn
fn
void
*
data
)
;
JSFunction
*
WasmSuspendingFunctionCreate
(
JSContext
*
cx
HandleObject
func
wasm
:
:
ValTypeVector
&
&
params
wasm
:
:
ValTypeVector
&
&
results
)
;
JSFunction
*
WasmSuspendingFunctionCreate
(
JSContext
*
cx
HandleObject
func
const
FuncType
&
type
)
;
JSFunction
*
WasmPromisingFunctionCreate
(
JSContext
*
cx
HandleObject
func
wasm
:
:
ValTypeVector
&
&
params
wasm
:
:
ValTypeVector
&
&
results
)
;
SuspenderObject
*
CurrentSuspender
(
Instance
*
instance
int
reserved
)
;
SuspenderObject
*
CreateSuspender
(
Instance
*
instance
int
reserved
)
;
PromiseObject
*
CreatePromisingPromise
(
Instance
*
instance
SuspenderObject
*
suspender
)
;
JSObject
*
GetSuspendingPromiseResult
(
Instance
*
instance
void
*
result
SuspenderObject
*
suspender
)
;
void
*
AddPromiseReactions
(
Instance
*
instance
SuspenderObject
*
suspender
void
*
result
JSFunction
*
continueOnSuspendable
)
;
void
*
ForwardExceptionToSuspended
(
Instance
*
instance
SuspenderObject
*
suspender
void
*
exception
)
;
int32_t
SetPromisingPromiseResults
(
Instance
*
instance
SuspenderObject
*
suspender
WasmStructObject
*
results
)
;
void
UpdateSuspenderState
(
Instance
*
instance
SuspenderObject
*
suspender
UpdateSuspenderStateAction
action
)
;
void
TraceSuspendableStack
(
JSTracer
*
trc
SuspenderObject
*
suspender
)
;
#
endif
}
}
#
endif
