#
ifndef
wasm_WasmStructLayout_h
#
define
wasm_WasmStructLayout_h
#
include
"
mozilla
/
Assertions
.
h
"
#
include
<
stdint
.
h
>
#
include
"
wasm
/
WasmConstants
.
h
"
namespace
js
:
:
wasm
{
const
size_t
WasmStructObject_Size_ASSUMED
=
16
;
#
ifdef
JS_64BIT
const
size_t
WasmStructObject_MaxInlineBytes_ASSUMED
=
136
;
#
else
const
size_t
WasmStructObject_MaxInlineBytes_ASSUMED
=
128
;
#
endif
class
FieldAccessPath
{
uint32_t
path_
;
static
constexpr
uint32_t
ILBits
=
9
;
static
constexpr
uint32_t
OOLBits
=
32
-
ILBits
;
static
constexpr
uint32_t
MaxValidILOffset
=
(
1
<
<
ILBits
)
-
1
;
static
constexpr
uint32_t
MaxValidOOLOffset
=
(
1
<
<
OOLBits
)
-
1
-
1
;
static
constexpr
uint32_t
InvalidOOLOffset
=
MaxValidOOLOffset
+
1
;
uint32_t
getIL
(
)
const
{
return
path_
&
MaxValidILOffset
;
}
uint32_t
getOOL
(
)
const
{
return
path_
>
>
ILBits
;
}
static_assert
(
(
WasmStructObject_Size_ASSUMED
+
WasmStructObject_MaxInlineBytes_ASSUMED
)
<
MaxValidILOffset
)
;
static_assert
(
js
:
:
wasm
:
:
MaxStructFields
*
64
<
MaxValidOOLOffset
)
;
public
:
FieldAccessPath
(
)
:
path_
(
0
)
{
}
explicit
FieldAccessPath
(
uint32_t
offsetIL
)
:
path_
(
(
InvalidOOLOffset
<
<
ILBits
)
|
offsetIL
)
{
MOZ_ASSERT
(
offsetIL
<
=
MaxValidILOffset
)
;
}
FieldAccessPath
(
uint32_t
offsetIL
uint32_t
offsetOOL
)
:
path_
(
(
offsetOOL
<
<
ILBits
)
|
offsetIL
)
{
MOZ_ASSERT
(
offsetIL
<
=
MaxValidILOffset
)
;
MOZ_ASSERT
(
offsetOOL
<
=
MaxValidOOLOffset
)
;
}
bool
hasOOL
(
)
const
{
return
getOOL
(
)
!
=
InvalidOOLOffset
;
}
uint32_t
ilOffset
(
)
const
{
return
getIL
(
)
;
}
uint32_t
oolOffset
(
)
const
{
MOZ_ASSERT
(
hasOOL
(
)
)
;
return
getOOL
(
)
;
}
}
;
static_assert
(
sizeof
(
FieldAccessPath
)
=
=
sizeof
(
uint32_t
)
)
;
class
StructLayout
{
public
:
bool
init
(
uint32_t
firstUsableILOffset
uint32_t
usableILSize
)
;
bool
addField
(
uint32_t
fieldSize
FieldAccessPath
*
path
)
;
uint32_t
totalSizeIL
(
)
const
;
bool
hasOOL
(
)
const
;
uint32_t
totalSizeOOL
(
)
const
;
FieldAccessPath
oolPointerPath
(
)
const
;
private
:
uint32_t
startILO_
=
0
;
uint32_t
endPlusILO_
=
0
;
uint32_t
oolptrILO_
=
0
;
uint32_t
nextILO_
=
0
;
uint32_t
nextOOLO_
=
0
;
uint32_t
numFieldsProcessed_
=
0
;
}
;
}
#
endif
