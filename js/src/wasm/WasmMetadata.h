#
ifndef
wasm_WasmMetadata_h
#
define
wasm_WasmMetadata_h
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
wasm
/
WasmBinaryTypes
.
h
"
#
include
"
wasm
/
WasmHeuristics
.
h
"
#
include
"
wasm
/
WasmInstanceData
.
h
"
#
include
"
wasm
/
WasmModuleTypes
.
h
"
#
include
"
wasm
/
WasmProcess
.
h
"
namespace
js
{
namespace
wasm
{
using
BuiltinModuleFuncIdVector
=
Vector
<
BuiltinModuleFuncId
0
SystemAllocPolicy
>
;
enum
class
NameContext
{
Standalone
BeforeLocation
}
;
using
ModuleHash
=
uint8_t
[
8
]
;
struct
CodeMetadata
:
public
ShareableBase
<
CodeMetadata
>
{
ModuleKind
kind
;
SharedCompileArgs
compileArgs
;
uint32_t
numFuncImports
;
BuiltinModuleFuncIdVector
knownFuncImports
;
uint32_t
numGlobalImports
;
MutableTypeContext
types
;
FuncDescVector
funcs
;
TableDescVector
tables
;
MemoryDescVector
memories
;
TagDescVector
tags
;
GlobalDescVector
globals
;
mozilla
:
:
Maybe
<
uint32_t
>
startFuncIndex
;
RefTypeVector
elemSegmentTypes
;
mozilla
:
:
Maybe
<
uint32_t
>
dataCount
;
Uint32Vector
exportedFuncIndices
;
Uint32Vector
asmJSSigToTableIndex
;
BranchHintCollection
branchHints
;
mozilla
:
:
Maybe
<
Name
>
moduleName
;
NameVector
funcNames
;
SharedBytes
namePayload
;
mozilla
:
:
Maybe
<
uint32_t
>
nameCustomSectionIndex
;
CustomSectionRangeVector
customSectionRanges
;
MaybeSectionRange
codeSectionRange
;
SharedBytes
codeSectionBytecode
;
FuncDefRangeVector
funcDefRanges
;
FeatureUsageVector
funcDefFeatureUsages
;
CallRefMetricsRangeVector
funcDefCallRefs
;
SharedBytes
debugBytecode
;
MutableCallRefHints
callRefHints
;
bool
debugEnabled
;
ModuleHash
debugHash
;
struct
ProtectedOptimizationStats
{
size_t
completeNumFuncs
=
0
;
size_t
completeBCSize
=
0
;
size_t
partialNumFuncs
=
0
;
size_t
partialBCSize
=
0
;
size_t
partialNumFuncsInlinedDirect
=
0
;
size_t
partialNumFuncsInlinedCallRef
=
0
;
size_t
partialBCInlinedSizeDirect
=
0
;
size_t
partialBCInlinedSizeCallRef
=
0
;
size_t
partialInlineBudgetOverruns
=
0
;
size_t
partialCodeBytesMapped
=
0
;
size_t
partialCodeBytesUsed
=
0
;
int64_t
inliningBudget
=
0
;
WASM_CHECK_CACHEABLE_POD
(
completeNumFuncs
completeBCSize
partialNumFuncs
partialBCSize
partialNumFuncsInlinedDirect
partialNumFuncsInlinedCallRef
partialBCInlinedSizeDirect
partialBCInlinedSizeCallRef
partialInlineBudgetOverruns
partialCodeBytesMapped
partialCodeBytesUsed
inliningBudget
)
;
}
;
using
ReadGuard
=
RWExclusiveData
<
ProtectedOptimizationStats
>
:
:
ReadGuard
;
using
WriteGuard
=
RWExclusiveData
<
ProtectedOptimizationStats
>
:
:
WriteGuard
;
RWExclusiveData
<
ProtectedOptimizationStats
>
stats
;
uint32_t
funcDefsOffsetStart
;
uint32_t
funcImportsOffsetStart
;
uint32_t
funcExportsOffsetStart
;
uint32_t
typeDefsOffsetStart
;
uint32_t
memoriesOffsetStart
;
uint32_t
tablesOffsetStart
;
uint32_t
tagsOffsetStart
;
uint32_t
instanceDataLength
;
uint32_t
numCallRefMetrics
;
explicit
CodeMetadata
(
const
CompileArgs
*
compileArgs
=
nullptr
ModuleKind
kind
=
ModuleKind
:
:
Wasm
)
:
kind
(
kind
)
compileArgs
(
compileArgs
)
numFuncImports
(
0
)
numGlobalImports
(
0
)
callRefHints
(
nullptr
)
debugEnabled
(
false
)
debugHash
(
)
stats
(
mutexid
:
:
WasmCodeMetaStats
)
funcDefsOffsetStart
(
UINT32_MAX
)
funcImportsOffsetStart
(
UINT32_MAX
)
funcExportsOffsetStart
(
UINT32_MAX
)
typeDefsOffsetStart
(
UINT32_MAX
)
memoriesOffsetStart
(
UINT32_MAX
)
tablesOffsetStart
(
UINT32_MAX
)
tagsOffsetStart
(
UINT32_MAX
)
instanceDataLength
(
UINT32_MAX
)
numCallRefMetrics
(
UINT32_MAX
)
{
}
[
[
nodiscard
]
]
bool
init
(
)
{
MOZ_ASSERT
(
!
types
)
;
types
=
js_new
<
TypeContext
>
(
)
;
return
types
;
}
void
dumpStats
(
)
const
;
~
CodeMetadata
(
)
{
dumpStats
(
)
;
}
[
[
nodiscard
]
]
bool
prepareForCompile
(
CompileMode
mode
)
;
bool
isPreparedForCompile
(
)
const
{
return
instanceDataLength
!
=
UINT32_MAX
;
}
bool
isAsmJS
(
)
const
{
return
kind
=
=
ModuleKind
:
:
AsmJS
;
}
bool
isBuiltinModule
(
)
const
{
return
features
(
)
.
isBuiltinModule
;
}
#
define
WASM_FEATURE
(
NAME
SHORT_NAME
.
.
.
)
\
bool
SHORT_NAME
#
#
Enabled
(
)
const
{
return
features
(
)
.
SHORT_NAME
;
}
JS_FOR_WASM_FEATURES
(
WASM_FEATURE
)
#
undef
WASM_FEATURE
Shareable
sharedMemoryEnabled
(
)
const
{
return
features
(
)
.
sharedMemory
;
}
bool
simdAvailable
(
)
const
{
return
features
(
)
.
simd
;
}
bool
hugeMemoryEnabled
(
uint32_t
memoryIndex
)
const
{
return
!
isAsmJS
(
)
&
&
memoryIndex
<
memories
.
length
(
)
&
&
IsHugeMemoryEnabled
(
memories
[
memoryIndex
]
.
addressType
(
)
)
;
}
bool
usesSharedMemory
(
uint32_t
memoryIndex
)
const
{
return
memoryIndex
<
memories
.
length
(
)
&
&
memories
[
memoryIndex
]
.
isShared
(
)
;
}
const
FeatureArgs
&
features
(
)
const
{
return
compileArgs
-
>
features
;
}
const
ScriptedCaller
&
scriptedCaller
(
)
const
{
return
compileArgs
-
>
scriptedCaller
;
}
const
UniqueChars
&
sourceMapURL
(
)
const
{
return
compileArgs
-
>
sourceMapURL
;
}
size_t
numTypes
(
)
const
{
return
types
-
>
length
(
)
;
}
size_t
numFuncs
(
)
const
{
return
funcs
.
length
(
)
;
}
size_t
numFuncDefs
(
)
const
{
return
funcs
.
length
(
)
-
numFuncImports
;
}
size_t
numTables
(
)
const
{
return
tables
.
length
(
)
;
}
size_t
numMemories
(
)
const
{
return
memories
.
length
(
)
;
}
bool
funcIsImport
(
uint32_t
funcIndex
)
const
{
return
funcIndex
<
numFuncImports
;
}
const
TypeDef
&
getFuncTypeDef
(
uint32_t
funcIndex
)
const
{
return
types
-
>
type
(
funcs
[
funcIndex
]
.
typeIndex
)
;
}
const
FuncType
&
getFuncType
(
uint32_t
funcIndex
)
const
{
return
getFuncTypeDef
(
funcIndex
)
.
funcType
(
)
;
}
uint32_t
funcBytecodeOffset
(
uint32_t
funcIndex
)
const
{
if
(
funcIndex
<
numFuncImports
)
{
return
0
;
}
uint32_t
funcDefIndex
=
funcIndex
-
numFuncImports
;
return
funcDefRanges
[
funcDefIndex
]
.
bytecodeOffset
;
}
const
FuncDefRange
&
funcDefRange
(
uint32_t
funcIndex
)
const
{
MOZ_ASSERT
(
funcIndex
>
=
numFuncImports
)
;
uint32_t
funcDefIndex
=
funcIndex
-
numFuncImports
;
return
funcDefRanges
[
funcDefIndex
]
;
}
FeatureUsage
funcDefFeatureUsage
(
uint32_t
funcIndex
)
const
{
MOZ_ASSERT
(
funcIndex
>
=
numFuncImports
)
;
uint32_t
funcDefIndex
=
funcIndex
-
numFuncImports
;
return
funcDefFeatureUsages
[
funcDefIndex
]
;
}
BuiltinModuleFuncId
knownFuncImport
(
uint32_t
funcIndex
)
const
{
MOZ_ASSERT
(
funcIndex
<
numFuncImports
)
;
if
(
knownFuncImports
.
empty
(
)
)
{
return
BuiltinModuleFuncId
:
:
None
;
}
return
knownFuncImports
[
funcIndex
]
;
}
CallRefMetricsRange
getFuncDefCallRefs
(
uint32_t
funcIndex
)
const
{
MOZ_ASSERT
(
funcIndex
>
=
numFuncImports
)
;
uint32_t
funcDefIndex
=
funcIndex
-
numFuncImports
;
return
funcDefCallRefs
[
funcDefIndex
]
;
}
uint32_t
findFuncExportIndex
(
uint32_t
funcIndex
)
const
;
uint32_t
numExportedFuncs
(
)
const
{
return
exportedFuncIndices
.
length
(
)
;
}
CallRefHint
getCallRefHint
(
uint32_t
callRefIndex
)
const
{
if
(
!
callRefHints
)
{
return
CallRefHint
:
:
unknown
(
)
;
}
return
CallRefHint
:
:
fromRepr
(
callRefHints
[
callRefIndex
]
)
;
}
void
setCallRefHint
(
uint32_t
callRefIndex
CallRefHint
hint
)
const
{
callRefHints
[
callRefIndex
]
=
hint
.
toRepr
(
)
;
}
size_t
codeSectionSize
(
)
const
{
if
(
codeSectionRange
)
{
return
codeSectionRange
-
>
size
;
}
return
0
;
}
bool
getFuncNameForWasm
(
NameContext
ctx
uint32_t
funcIndex
UTF8Bytes
*
name
)
const
;
uint32_t
offsetOfFuncDefInstanceData
(
uint32_t
funcIndex
)
const
{
MOZ_ASSERT
(
funcIndex
>
=
numFuncImports
&
&
funcIndex
<
numFuncs
(
)
)
;
return
funcDefsOffsetStart
+
(
funcIndex
-
numFuncImports
)
*
sizeof
(
FuncDefInstanceData
)
;
}
uint32_t
offsetOfFuncImportInstanceData
(
uint32_t
funcIndex
)
const
{
MOZ_ASSERT
(
funcIndex
<
numFuncImports
)
;
return
funcImportsOffsetStart
+
funcIndex
*
sizeof
(
FuncImportInstanceData
)
;
}
uint32_t
offsetOfFuncExportInstanceData
(
uint32_t
funcExportIndex
)
const
{
MOZ_ASSERT
(
funcExportIndex
<
exportedFuncIndices
.
length
(
)
)
;
return
funcExportsOffsetStart
+
funcExportIndex
*
sizeof
(
FuncExportInstanceData
)
;
}
uint32_t
offsetOfTypeDefInstanceData
(
uint32_t
typeIndex
)
const
{
MOZ_ASSERT
(
typeIndex
<
types
-
>
length
(
)
)
;
return
typeDefsOffsetStart
+
typeIndex
*
sizeof
(
TypeDefInstanceData
)
;
}
uint32_t
offsetOfTypeDef
(
uint32_t
typeIndex
)
const
{
return
offsetOfTypeDefInstanceData
(
typeIndex
)
+
offsetof
(
TypeDefInstanceData
typeDef
)
;
}
uint32_t
offsetOfSuperTypeVector
(
uint32_t
typeIndex
)
const
{
return
offsetOfTypeDefInstanceData
(
typeIndex
)
+
offsetof
(
TypeDefInstanceData
superTypeVector
)
;
}
uint32_t
offsetOfMemoryInstanceData
(
uint32_t
memoryIndex
)
const
{
MOZ_ASSERT
(
memoryIndex
<
memories
.
length
(
)
)
;
return
memoriesOffsetStart
+
memoryIndex
*
sizeof
(
MemoryInstanceData
)
;
}
uint32_t
offsetOfTableInstanceData
(
uint32_t
tableIndex
)
const
{
MOZ_ASSERT
(
tableIndex
<
tables
.
length
(
)
)
;
return
tablesOffsetStart
+
tableIndex
*
sizeof
(
TableInstanceData
)
;
}
uint32_t
offsetOfTagInstanceData
(
uint32_t
tagIndex
)
const
{
MOZ_ASSERT
(
tagIndex
<
tags
.
length
(
)
)
;
return
tagsOffsetStart
+
tagIndex
*
sizeof
(
TagInstanceData
)
;
}
size_t
sizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
const
;
private
:
[
[
nodiscard
]
]
bool
allocateInstanceDataBytes
(
uint32_t
bytes
uint32_t
align
uint32_t
*
assignedOffset
)
;
[
[
nodiscard
]
]
bool
allocateInstanceDataBytesN
(
uint32_t
bytes
uint32_t
align
uint32_t
count
uint32_t
*
assignedOffset
)
;
}
;
using
MutableCodeMetadata
=
RefPtr
<
CodeMetadata
>
;
using
SharedCodeMetadata
=
RefPtr
<
const
CodeMetadata
>
;
WASM_DECLARE_CACHEABLE_POD
(
CodeMetadata
:
:
ProtectedOptimizationStats
)
;
struct
ModuleMetadata
:
public
ShareableBase
<
ModuleMetadata
>
{
MutableCodeMetadata
codeMeta
;
ImportVector
imports
;
ExportVector
exports
;
ModuleElemSegmentVector
elemSegments
;
DataSegmentRangeVector
dataSegmentRanges
;
DataSegmentVector
dataSegments
;
CustomSectionVector
customSections
;
FeatureUsage
featureUsage
;
explicit
ModuleMetadata
(
)
=
default
;
[
[
nodiscard
]
]
bool
init
(
const
CompileArgs
&
compileArgs
ModuleKind
kind
=
ModuleKind
:
:
Wasm
)
{
codeMeta
=
js_new
<
CodeMetadata
>
(
&
compileArgs
kind
)
;
return
!
!
codeMeta
&
&
codeMeta
-
>
init
(
)
;
}
bool
addDefinedFunc
(
ValTypeVector
&
&
params
ValTypeVector
&
&
results
bool
declareForRef
=
false
mozilla
:
:
Maybe
<
CacheableName
>
&
&
optionalExportedName
=
mozilla
:
:
Nothing
(
)
)
;
bool
addImportedFunc
(
ValTypeVector
&
&
params
ValTypeVector
&
&
results
CacheableName
&
&
importModName
CacheableName
&
&
importFieldName
)
;
[
[
nodiscard
]
]
bool
prepareForCompile
(
CompileMode
mode
)
{
return
codeMeta
-
>
prepareForCompile
(
mode
)
;
}
bool
isPreparedForCompile
(
)
const
{
return
codeMeta
-
>
isPreparedForCompile
(
)
;
}
size_t
sizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
const
;
}
;
using
MutableModuleMetadata
=
RefPtr
<
ModuleMetadata
>
;
using
SharedModuleMetadata
=
RefPtr
<
const
ModuleMetadata
>
;
}
}
#
endif
