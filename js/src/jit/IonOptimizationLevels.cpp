#
include
"
jit
/
IonOptimizationLevels
.
h
"
#
include
"
jit
/
Ion
.
h
"
#
include
"
vm
/
JSScript
.
h
"
#
include
"
vm
/
JSScript
-
inl
.
h
"
using
namespace
js
;
using
namespace
js
:
:
jit
;
namespace
js
{
namespace
jit
{
const
OptimizationLevelInfo
IonOptimizations
;
void
OptimizationInfo
:
:
initNormalOptimizationInfo
(
)
{
level_
=
OptimizationLevel
:
:
Normal
;
autoTruncate_
=
true
;
eaa_
=
true
;
edgeCaseAnalysis_
=
true
;
eliminateRedundantChecks_
=
true
;
eliminateRedundantShapeGuards_
=
true
;
inlineInterpreted_
=
true
;
inlineNative_
=
true
;
licm_
=
true
;
gvn_
=
true
;
rangeAnalysis_
=
true
;
reordering_
=
true
;
scalarReplacement_
=
true
;
sink_
=
true
;
registerAllocator_
=
RegisterAllocator_Backtracking
;
}
void
OptimizationInfo
:
:
initWasmOptimizationInfo
(
)
{
initNormalOptimizationInfo
(
)
;
level_
=
OptimizationLevel
:
:
Wasm
;
ama_
=
true
;
autoTruncate_
=
false
;
edgeCaseAnalysis_
=
false
;
eliminateRedundantChecks_
=
false
;
eliminateRedundantShapeGuards_
=
false
;
scalarReplacement_
=
false
;
sink_
=
false
;
}
uint32_t
OptimizationInfo
:
:
compilerWarmUpThreshold
(
JSScript
*
script
jsbytecode
*
pc
)
const
{
MOZ_ASSERT
(
pc
=
=
nullptr
|
|
pc
=
=
script
-
>
code
(
)
|
|
JSOp
(
*
pc
)
=
=
JSOp
:
:
LoopHead
)
;
MOZ_ASSERT_IF
(
pc
&
&
JSOp
(
*
pc
)
=
=
JSOp
:
:
LoopHead
pc
>
script
-
>
code
(
)
)
;
if
(
pc
=
=
script
-
>
code
(
)
)
{
pc
=
nullptr
;
}
uint32_t
warmUpThreshold
=
baseCompilerWarmUpThreshold
(
)
;
if
(
script
-
>
length
(
)
>
JitOptions
.
ionMaxScriptSizeMainThread
)
{
warmUpThreshold
*
=
(
script
-
>
length
(
)
/
double
(
JitOptions
.
ionMaxScriptSizeMainThread
)
)
;
}
uint32_t
numLocalsAndArgs
=
NumLocalsAndArgs
(
script
)
;
if
(
numLocalsAndArgs
>
JitOptions
.
ionMaxLocalsAndArgsMainThread
)
{
warmUpThreshold
*
=
(
numLocalsAndArgs
/
double
(
JitOptions
.
ionMaxLocalsAndArgsMainThread
)
)
;
}
if
(
!
pc
|
|
JitOptions
.
eagerIonCompilation
(
)
)
{
return
warmUpThreshold
;
}
uint32_t
loopDepth
=
LoopHeadDepthHint
(
pc
)
;
MOZ_ASSERT
(
loopDepth
>
0
)
;
return
warmUpThreshold
+
loopDepth
*
(
baseCompilerWarmUpThreshold
(
)
/
10
)
;
}
uint32_t
OptimizationInfo
:
:
recompileWarmUpThreshold
(
JSScript
*
script
jsbytecode
*
pc
)
const
{
MOZ_ASSERT
(
pc
=
=
script
-
>
code
(
)
|
|
JSOp
(
*
pc
)
=
=
JSOp
:
:
LoopHead
)
;
uint32_t
threshold
=
compilerWarmUpThreshold
(
script
pc
)
;
if
(
JSOp
(
*
pc
)
!
=
JSOp
:
:
LoopHead
|
|
JitOptions
.
eagerIonCompilation
(
)
)
{
return
threshold
;
}
uint32_t
loopDepth
=
LoopHeadDepthHint
(
pc
)
;
MOZ_ASSERT
(
loopDepth
>
0
)
;
return
threshold
+
loopDepth
*
(
baseCompilerWarmUpThreshold
(
)
/
10
)
;
}
OptimizationLevelInfo
:
:
OptimizationLevelInfo
(
)
{
infos_
[
OptimizationLevel
:
:
Normal
]
.
initNormalOptimizationInfo
(
)
;
infos_
[
OptimizationLevel
:
:
Wasm
]
.
initWasmOptimizationInfo
(
)
;
}
OptimizationLevel
OptimizationLevelInfo
:
:
levelForScript
(
JSScript
*
script
jsbytecode
*
pc
)
const
{
const
OptimizationInfo
*
info
=
get
(
OptimizationLevel
:
:
Normal
)
;
if
(
script
-
>
getWarmUpCount
(
)
<
info
-
>
compilerWarmUpThreshold
(
script
pc
)
)
{
return
OptimizationLevel
:
:
DontCompile
;
}
return
OptimizationLevel
:
:
Normal
;
}
}
}
