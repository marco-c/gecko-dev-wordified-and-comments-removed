#
ifndef
jit_WarpBuilder_h
#
define
jit_WarpBuilder_h
#
include
"
jit
/
JitContext
.
h
"
#
include
"
jit
/
MIR
.
h
"
#
include
"
jit
/
MIRBuilderShared
.
h
"
#
include
"
jit
/
WarpOracle
.
h
"
#
include
"
vm
/
Opcodes
.
h
"
namespace
js
{
namespace
jit
{
#
define
WARP_UNSUPPORTED_OPCODE_LIST
(
_
)
\
_
(
ForceInterpreter
)
\
/
*
With
*
/
\
_
(
EnterWith
)
\
_
(
LeaveWith
)
\
/
*
Eval
*
/
\
_
(
Eval
)
\
_
(
StrictEval
)
\
_
(
SpreadEval
)
\
_
(
StrictSpreadEval
)
\
/
*
Super
*
/
\
_
(
SetPropSuper
)
\
_
(
SetElemSuper
)
\
_
(
StrictSetPropSuper
)
\
_
(
StrictSetElemSuper
)
\
/
*
Environments
(
bug
1366470
)
*
/
\
_
(
PushVarEnv
)
\
/
*
Compound
assignment
*
/
\
_
(
GetBoundName
)
\
/
*
Generators
/
Async
(
bug
1317690
)
*
/
\
_
(
IsGenClosing
)
\
_
(
InitialYield
)
\
_
(
Yield
)
\
_
(
FinalYieldRval
)
\
_
(
Resume
)
\
_
(
ResumeKind
)
\
_
(
CheckResumeKind
)
\
_
(
AfterYield
)
\
_
(
Await
)
\
_
(
TrySkipAwait
)
\
_
(
Generator
)
\
_
(
AsyncAwait
)
\
_
(
AsyncResolve
)
\
/
*
Catch
/
finally
*
/
\
_
(
Exception
)
\
_
(
Finally
)
\
_
(
Gosub
)
\
_
(
Retsub
)
\
/
*
Misc
*
/
\
_
(
DelName
)
\
_
(
GetRval
)
\
_
(
SetIntrinsic
)
\
_
(
ThrowMsg
)
class
MIRGenerator
;
class
MIRGraph
;
class
WarpSnapshot
;
class
MOZ_STACK_CLASS
WarpBuilder
{
WarpSnapshot
&
snapshot_
;
MIRGenerator
&
mirGen_
;
MIRGraph
&
graph_
;
TempAllocator
&
alloc_
;
const
CompileInfo
&
info_
;
JSScript
*
script_
;
MBasicBlock
*
current
=
nullptr
;
const
WarpOpSnapshot
*
opSnapshotIter_
=
nullptr
;
uint32_t
loopDepth_
=
0
;
LoopStateStack
loopStack_
;
PendingEdgesMap
pendingEdges_
;
PhiVector
iterators_
;
TempAllocator
&
alloc
(
)
{
return
alloc_
;
}
MIRGraph
&
graph
(
)
{
return
graph_
;
}
const
CompileInfo
&
info
(
)
const
{
return
info_
;
}
WarpSnapshot
&
snapshot
(
)
const
{
return
snapshot_
;
}
BytecodeSite
*
newBytecodeSite
(
BytecodeLocation
loc
)
;
const
WarpOpSnapshot
*
getOpSnapshotImpl
(
BytecodeLocation
loc
)
;
template
<
typename
T
>
const
T
*
getOpSnapshot
(
BytecodeLocation
loc
)
{
const
WarpOpSnapshot
*
snapshot
=
getOpSnapshotImpl
(
loc
)
;
return
snapshot
?
snapshot
-
>
as
<
T
>
(
)
:
nullptr
;
}
void
initBlock
(
MBasicBlock
*
block
)
;
MOZ_MUST_USE
bool
startNewEntryBlock
(
size_t
stackDepth
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
startNewBlock
(
MBasicBlock
*
predecessor
BytecodeLocation
loc
size_t
numToPop
=
0
)
;
MOZ_MUST_USE
bool
startNewLoopHeaderBlock
(
BytecodeLocation
loopHead
)
;
MOZ_MUST_USE
bool
startNewOsrPreHeaderBlock
(
BytecodeLocation
loopHead
)
;
bool
hasTerminatedBlock
(
)
const
{
return
current
=
=
nullptr
;
}
void
setTerminatedBlock
(
)
{
current
=
nullptr
;
}
MOZ_MUST_USE
bool
addPendingEdge
(
const
PendingEdge
&
edge
BytecodeLocation
target
)
;
MOZ_MUST_USE
bool
buildForwardGoto
(
BytecodeLocation
target
)
;
MOZ_MUST_USE
bool
buildBackedge
(
)
;
MOZ_MUST_USE
bool
buildTestBackedge
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
resumeAfter
(
MInstruction
*
ins
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
addIteratorLoopPhis
(
BytecodeLocation
loopHead
)
;
MConstant
*
constant
(
const
Value
&
v
)
;
void
pushConstant
(
const
Value
&
v
)
;
MOZ_MUST_USE
bool
buildPrologue
(
)
;
MOZ_MUST_USE
bool
buildBody
(
)
;
MOZ_MUST_USE
bool
buildEpilogue
(
)
;
MOZ_MUST_USE
bool
buildEnvironmentChain
(
)
;
MInstruction
*
buildNamedLambdaEnv
(
MDefinition
*
callee
MDefinition
*
env
LexicalEnvironmentObject
*
templateObj
)
;
MInstruction
*
buildCallObject
(
MDefinition
*
callee
MDefinition
*
env
CallObject
*
templateObj
)
;
MInstruction
*
buildLoadSlot
(
MDefinition
*
obj
uint32_t
numFixedSlots
uint32_t
slot
)
;
MConstant
*
globalLexicalEnvConstant
(
)
;
MDefinition
*
getCallee
(
)
;
MOZ_MUST_USE
bool
buildUnaryOp
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
buildBinaryOp
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
buildCompareOp
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
buildTestOp
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
buildDefLexicalOp
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
buildCallOp
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
buildGetNameOp
(
BytecodeLocation
loc
MDefinition
*
env
)
;
MOZ_MUST_USE
bool
buildBindNameOp
(
BytecodeLocation
loc
MDefinition
*
env
)
;
MOZ_MUST_USE
bool
buildGetPropOp
(
BytecodeLocation
loc
MDefinition
*
val
MDefinition
*
id
)
;
MOZ_MUST_USE
bool
buildSetPropOp
(
BytecodeLocation
loc
MDefinition
*
obj
MDefinition
*
id
MDefinition
*
val
)
;
MOZ_MUST_USE
bool
buildInitPropOp
(
BytecodeLocation
loc
MDefinition
*
obj
MDefinition
*
id
MDefinition
*
val
)
;
MOZ_MUST_USE
bool
buildGetPropSuperOp
(
BytecodeLocation
loc
MDefinition
*
obj
MDefinition
*
receiver
MDefinition
*
id
)
;
MOZ_MUST_USE
bool
buildInitPropGetterSetterOp
(
BytecodeLocation
loc
)
;
MOZ_MUST_USE
bool
buildInitElemGetterSetterOp
(
BytecodeLocation
loc
)
;
void
buildCopyLexicalEnvOp
(
bool
copySlots
)
;
void
buildCheckLexicalOp
(
BytecodeLocation
loc
)
;
bool
usesEnvironmentChain
(
)
const
;
MDefinition
*
walkEnvironmentChain
(
uint32_t
numHops
)
;
#
define
BUILD_OP
(
OP
.
.
.
)
MOZ_MUST_USE
bool
build_
#
#
OP
(
BytecodeLocation
loc
)
;
FOR_EACH_OPCODE
(
BUILD_OP
)
#
undef
BUILD_OP
public
:
WarpBuilder
(
WarpSnapshot
&
snapshot
MIRGenerator
&
mirGen
)
;
MOZ_MUST_USE
bool
build
(
)
;
}
;
}
}
#
endif
