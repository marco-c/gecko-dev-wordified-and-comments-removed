#
ifndef
jit_WarpBuilder_h
#
define
jit_WarpBuilder_h
#
include
<
initializer_list
>
#
include
"
ds
/
InlineTable
.
h
"
#
include
"
jit
/
JitContext
.
h
"
#
include
"
jit
/
MIR
.
h
"
#
include
"
jit
/
WarpBuilderShared
.
h
"
#
include
"
jit
/
WarpSnapshot
.
h
"
#
include
"
vm
/
Opcodes
.
h
"
namespace
js
{
namespace
jit
{
#
define
WARP_UNSUPPORTED_OPCODE_LIST
(
_
)
\
_
(
ForceInterpreter
)
\
/
*
With
*
/
\
_
(
EnterWith
)
\
_
(
LeaveWith
)
\
/
*
Eval
*
/
\
_
(
Eval
)
\
_
(
StrictEval
)
\
_
(
SpreadEval
)
\
_
(
StrictSpreadEval
)
\
/
*
Super
*
/
\
_
(
SetPropSuper
)
\
_
(
SetElemSuper
)
\
_
(
StrictSetPropSuper
)
\
_
(
StrictSetElemSuper
)
\
/
*
Environments
(
bug
1366470
)
*
/
\
_
(
PushVarEnv
)
\
/
*
Compound
assignment
*
/
\
_
(
GetBoundName
)
\
/
*
Generators
/
Async
(
bug
1317690
)
*
/
\
_
(
IsGenClosing
)
\
_
(
Resume
)
\
/
*
try
-
finally
*
/
\
_
(
Finally
)
\
_
(
Gosub
)
\
_
(
Retsub
)
\
/
*
Misc
*
/
\
_
(
DelName
)
\
_
(
SetIntrinsic
)
\
/
*
Private
Fields
*
/
\
_
(
InitLockedElem
)
\
_
(
GetAliasedDebugVar
)
\
/
*
Non
-
syntactic
scope
*
/
\
_
(
NonSyntacticGlobalThis
)
\
/
/
=
=
=
!
!
WARNING
WARNING
WARNING
!
!
=
=
=
class
MIRGenerator
;
class
MIRGraph
;
class
WarpSnapshot
;
enum
class
CacheKind
:
uint8_t
;
class
PendingEdge
{
public
:
enum
class
Kind
:
uint8_t
{
TestTrue
TestFalse
Goto
}
;
private
:
MBasicBlock
*
block_
;
Kind
kind_
;
JSOp
testOp_
=
JSOp
:
:
Undefined
;
PendingEdge
(
MBasicBlock
*
block
Kind
kind
JSOp
testOp
=
JSOp
:
:
Undefined
)
:
block_
(
block
)
kind_
(
kind
)
testOp_
(
testOp
)
{
}
public
:
static
PendingEdge
NewTestTrue
(
MBasicBlock
*
block
JSOp
op
)
{
return
PendingEdge
(
block
Kind
:
:
TestTrue
op
)
;
}
static
PendingEdge
NewTestFalse
(
MBasicBlock
*
block
JSOp
op
)
{
return
PendingEdge
(
block
Kind
:
:
TestFalse
op
)
;
}
static
PendingEdge
NewGoto
(
MBasicBlock
*
block
)
{
return
PendingEdge
(
block
Kind
:
:
Goto
)
;
}
MBasicBlock
*
block
(
)
const
{
return
block_
;
}
Kind
kind
(
)
const
{
return
kind_
;
}
JSOp
testOp
(
)
const
{
MOZ_ASSERT
(
kind_
=
=
Kind
:
:
TestTrue
|
|
kind_
=
=
Kind
:
:
TestFalse
)
;
return
testOp_
;
}
}
;
using
PendingEdges
=
Vector
<
PendingEdge
2
SystemAllocPolicy
>
;
using
PendingEdgesMap
=
InlineMap
<
jsbytecode
*
PendingEdges
8
PointerHasher
<
jsbytecode
*
>
SystemAllocPolicy
>
;
class
LoopState
{
MBasicBlock
*
header_
=
nullptr
;
public
:
explicit
LoopState
(
MBasicBlock
*
header
)
:
header_
(
header
)
{
}
MBasicBlock
*
header
(
)
const
{
return
header_
;
}
}
;
using
LoopStateStack
=
Vector
<
LoopState
4
JitAllocPolicy
>
;
class
MOZ_STACK_CLASS
WarpCompilation
{
uint32_t
loopDepth_
=
0
;
PhiVector
iterators_
;
public
:
explicit
WarpCompilation
(
TempAllocator
&
alloc
)
:
iterators_
(
alloc
)
{
}
uint32_t
loopDepth
(
)
const
{
return
loopDepth_
;
}
void
incLoopDepth
(
)
{
loopDepth_
+
+
;
}
void
decLoopDepth
(
)
{
MOZ_ASSERT
(
loopDepth
(
)
>
0
)
;
loopDepth_
-
-
;
}
PhiVector
*
iterators
(
)
{
return
&
iterators_
;
}
}
;
class
MOZ_STACK_CLASS
WarpBuilder
:
public
WarpBuilderShared
{
WarpCompilation
*
warpCompilation_
;
MIRGraph
&
graph_
;
const
CompileInfo
&
info_
;
const
WarpScriptSnapshot
*
scriptSnapshot_
;
JSScript
*
script_
;
const
WarpOpSnapshot
*
opSnapshotIter_
=
nullptr
;
LoopStateStack
loopStack_
;
PendingEdgesMap
pendingEdges_
;
WarpBuilder
*
callerBuilder_
=
nullptr
;
MResumePoint
*
callerResumePoint_
=
nullptr
;
CallInfo
*
inlineCallInfo_
=
nullptr
;
WarpCompilation
*
warpCompilation
(
)
const
{
return
warpCompilation_
;
}
MIRGraph
&
graph
(
)
{
return
graph_
;
}
const
CompileInfo
&
info
(
)
const
{
return
info_
;
}
const
WarpScriptSnapshot
*
scriptSnapshot
(
)
const
{
return
scriptSnapshot_
;
}
uint32_t
loopDepth
(
)
const
{
return
warpCompilation_
-
>
loopDepth
(
)
;
}
void
incLoopDepth
(
)
{
warpCompilation_
-
>
incLoopDepth
(
)
;
}
void
decLoopDepth
(
)
{
warpCompilation_
-
>
decLoopDepth
(
)
;
}
PhiVector
*
iterators
(
)
{
return
warpCompilation_
-
>
iterators
(
)
;
}
WarpBuilder
*
callerBuilder
(
)
const
{
return
callerBuilder_
;
}
MResumePoint
*
callerResumePoint
(
)
const
{
return
callerResumePoint_
;
}
BytecodeSite
*
newBytecodeSite
(
BytecodeLocation
loc
)
;
const
WarpOpSnapshot
*
getOpSnapshotImpl
(
BytecodeLocation
loc
WarpOpSnapshot
:
:
Kind
kind
)
;
template
<
typename
T
>
const
T
*
getOpSnapshot
(
BytecodeLocation
loc
)
{
const
WarpOpSnapshot
*
snapshot
=
getOpSnapshotImpl
(
loc
T
:
:
ThisKind
)
;
return
snapshot
?
snapshot
-
>
as
<
T
>
(
)
:
nullptr
;
}
void
initBlock
(
MBasicBlock
*
block
)
;
[
[
nodiscard
]
]
bool
startNewEntryBlock
(
size_t
stackDepth
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
startNewBlock
(
MBasicBlock
*
predecessor
BytecodeLocation
loc
size_t
numToPop
=
0
)
;
[
[
nodiscard
]
]
bool
startNewLoopHeaderBlock
(
BytecodeLocation
loopHead
)
;
[
[
nodiscard
]
]
bool
startNewOsrPreHeaderBlock
(
BytecodeLocation
loopHead
)
;
bool
hasTerminatedBlock
(
)
const
{
return
current
=
=
nullptr
;
}
void
setTerminatedBlock
(
)
{
current
=
nullptr
;
}
[
[
nodiscard
]
]
bool
addPendingEdge
(
const
PendingEdge
&
edge
BytecodeLocation
target
)
;
[
[
nodiscard
]
]
bool
buildForwardGoto
(
BytecodeLocation
target
)
;
[
[
nodiscard
]
]
bool
buildBackedge
(
)
;
[
[
nodiscard
]
]
bool
buildTestBackedge
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
addIteratorLoopPhis
(
BytecodeLocation
loopHead
)
;
[
[
nodiscard
]
]
bool
buildPrologue
(
)
;
[
[
nodiscard
]
]
bool
buildBody
(
)
;
[
[
nodiscard
]
]
bool
buildInlinePrologue
(
)
;
[
[
nodiscard
]
]
bool
buildIC
(
BytecodeLocation
loc
CacheKind
kind
std
:
:
initializer_list
<
MDefinition
*
>
inputs
)
;
[
[
nodiscard
]
]
bool
buildBailoutForColdIC
(
BytecodeLocation
loc
CacheKind
kind
)
;
[
[
nodiscard
]
]
bool
buildEnvironmentChain
(
)
;
MInstruction
*
buildNamedLambdaEnv
(
MDefinition
*
callee
MDefinition
*
env
NamedLambdaObject
*
templateObj
)
;
MInstruction
*
buildCallObject
(
MDefinition
*
callee
MDefinition
*
env
CallObject
*
templateObj
)
;
MInstruction
*
buildLoadSlot
(
MDefinition
*
obj
uint32_t
numFixedSlots
uint32_t
slot
)
;
MConstant
*
globalLexicalEnvConstant
(
)
;
MDefinition
*
getCallee
(
)
;
[
[
nodiscard
]
]
bool
buildUnaryOp
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
buildBinaryOp
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
buildCompareOp
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
buildTestOp
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
buildCallOp
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
buildInitPropGetterSetterOp
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
buildInitElemGetterSetterOp
(
BytecodeLocation
loc
)
;
[
[
nodiscard
]
]
bool
buildSuspend
(
BytecodeLocation
loc
MDefinition
*
gen
MDefinition
*
retVal
)
;
void
buildCopyLexicalEnvOp
(
bool
copySlots
)
;
void
buildCheckLexicalOp
(
BytecodeLocation
loc
)
;
bool
usesEnvironmentChain
(
)
const
;
MDefinition
*
walkEnvironmentChain
(
uint32_t
numHops
)
;
[
[
nodiscard
]
]
bool
transpileCall
(
BytecodeLocation
loc
const
WarpCacheIR
*
cacheIRSnapshot
CallInfo
*
callInfo
)
;
[
[
nodiscard
]
]
bool
buildInlinedCall
(
BytecodeLocation
loc
const
WarpInlinedCall
*
snapshot
CallInfo
&
callInfo
)
;
MDefinition
*
patchInlinedReturns
(
CompileInfo
*
calleeCompileInfo
CallInfo
&
callInfo
MIRGraphReturns
&
exits
MBasicBlock
*
returnBlock
)
;
MDefinition
*
patchInlinedReturn
(
CompileInfo
*
calleeCompileInfo
CallInfo
&
callInfo
MBasicBlock
*
exit
MBasicBlock
*
returnBlock
)
;
#
define
BUILD_OP
(
OP
.
.
.
)
[
[
nodiscard
]
]
bool
build_
#
#
OP
(
BytecodeLocation
loc
)
;
FOR_EACH_OPCODE
(
BUILD_OP
)
#
undef
BUILD_OP
public
:
WarpBuilder
(
WarpSnapshot
&
snapshot
MIRGenerator
&
mirGen
WarpCompilation
*
warpCompilation
)
;
WarpBuilder
(
WarpBuilder
*
caller
WarpScriptSnapshot
*
snapshot
CompileInfo
&
compileInfo
CallInfo
*
inlineCallInfo
MResumePoint
*
callerResumePoint
)
;
[
[
nodiscard
]
]
bool
build
(
)
;
[
[
nodiscard
]
]
bool
buildInline
(
)
;
CallInfo
*
inlineCallInfo
(
)
const
{
return
inlineCallInfo_
;
}
}
;
}
}
#
endif
