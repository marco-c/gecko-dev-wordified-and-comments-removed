#
include
"
jit
/
IonIC
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
SizePrintfMacros
.
h
"
#
include
"
jit
/
CacheIRCompiler
.
h
"
#
include
"
jit
/
Linker
.
h
"
#
include
"
jit
/
MacroAssembler
-
inl
.
h
"
#
include
"
vm
/
Interpreter
-
inl
.
h
"
using
namespace
js
;
using
namespace
js
:
:
jit
;
using
mozilla
:
:
Maybe
;
void
IonIC
:
:
updateBaseAddress
(
JitCode
*
code
MacroAssembler
&
masm
)
{
fallbackLabel_
.
repoint
(
code
&
masm
)
;
rejoinLabel_
.
repoint
(
code
&
masm
)
;
codeRaw_
=
fallbackLabel_
.
raw
(
)
;
}
Register
IonIC
:
:
scratchRegisterForEntryJump
(
)
{
switch
(
kind_
)
{
case
CacheKind
:
:
GetProp
:
case
CacheKind
:
:
GetElem
:
{
Register
temp
=
asGetPropertyIC
(
)
-
>
maybeTemp
(
)
;
if
(
temp
!
=
InvalidReg
)
return
temp
;
TypedOrValueRegister
output
=
asGetPropertyIC
(
)
-
>
output
(
)
;
return
output
.
hasValue
(
)
?
output
.
valueReg
(
)
.
scratchReg
(
)
:
output
.
typedReg
(
)
.
gpr
(
)
;
}
}
MOZ_CRASH
(
"
Invalid
kind
"
)
;
}
void
IonIC
:
:
reset
(
Zone
*
zone
)
{
if
(
firstStub_
&
&
zone
-
>
needsIncrementalBarrier
(
)
)
{
trace
(
zone
-
>
barrierTracer
(
)
)
;
}
#
ifdef
JS_CRASH_DIAGNOSTICS
IonICStub
*
stub
=
firstStub_
;
while
(
stub
)
{
IonICStub
*
next
=
stub
-
>
next
(
)
;
stub
-
>
poison
(
)
;
stub
=
next
;
}
#
endif
firstStub_
=
nullptr
;
codeRaw_
=
fallbackLabel_
.
raw
(
)
;
numStubs_
=
0
;
}
void
IonIC
:
:
trace
(
JSTracer
*
trc
)
{
if
(
script_
)
TraceManuallyBarrieredEdge
(
trc
&
script_
"
IonIC
:
:
script_
"
)
;
}
bool
IonGetPropertyIC
:
:
update
(
JSContext
*
cx
HandleScript
outerScript
IonGetPropertyIC
*
ic
HandleObject
obj
HandleValue
idVal
MutableHandleValue
res
)
{
AutoDetectInvalidation
adi
(
cx
res
outerScript
-
>
ionScript
(
)
)
;
if
(
ic
-
>
idempotent
(
)
)
adi
.
disable
(
)
;
bool
attached
=
false
;
if
(
!
attached
&
&
ic
-
>
idempotent
(
)
)
{
JitSpew
(
JitSpew_IonIC
"
Invalidating
from
idempotent
cache
%
s
:
%
"
PRIuSIZE
outerScript
-
>
filename
(
)
outerScript
-
>
lineno
(
)
)
;
outerScript
-
>
setInvalidatedIdempotentCache
(
)
;
if
(
outerScript
-
>
hasIonScript
(
)
)
Invalidate
(
cx
outerScript
)
;
}
if
(
ic
-
>
kind
(
)
=
=
CacheKind
:
:
GetProp
)
{
if
(
!
GetProperty
(
cx
obj
obj
idVal
.
toString
(
)
-
>
asAtom
(
)
.
asPropertyName
(
)
res
)
)
return
false
;
}
else
{
MOZ_ASSERT
(
ic
-
>
kind
(
)
=
=
CacheKind
:
:
GetElem
)
;
if
(
!
GetObjectElementOperation
(
cx
JSOp
(
*
ic
-
>
pc
(
)
)
obj
obj
idVal
res
)
)
return
false
;
}
if
(
!
ic
-
>
idempotent
(
)
)
{
if
(
!
ic
-
>
monitoredResult
(
)
)
TypeScript
:
:
Monitor
(
cx
ic
-
>
script
(
)
ic
-
>
pc
(
)
res
)
;
}
return
true
;
}
