#
include
"
jit
/
arm64
/
vixl
/
Cpu
-
vixl
.
h
"
#
include
"
jit
/
arm64
/
vixl
/
Utils
-
vixl
.
h
"
#
include
"
util
/
Windows
.
h
"
namespace
vixl
{
void
CPU
:
:
EnsureIAndDCacheCoherency
(
void
*
address
size_t
length
)
{
#
if
defined
(
_MSC_VER
)
&
&
defined
(
_M_ARM64
)
FlushInstructionCache
(
GetCurrentProcess
(
)
address
length
)
;
#
elif
defined
(
__aarch64__
)
if
(
length
=
=
0
)
{
return
;
}
uintptr_t
start
=
reinterpret_cast
<
uintptr_t
>
(
address
)
;
uintptr_t
dsize
=
static_cast
<
uintptr_t
>
(
dcache_line_size_
)
;
uintptr_t
isize
=
static_cast
<
uintptr_t
>
(
icache_line_size_
)
;
uintptr_t
dline
=
start
&
~
(
dsize
-
1
)
;
uintptr_t
iline
=
start
&
~
(
isize
-
1
)
;
VIXL_ASSERT
(
IsPowerOf2
(
dsize
)
)
;
VIXL_ASSERT
(
IsPowerOf2
(
isize
)
)
;
uintptr_t
end
=
start
+
length
;
do
{
__asm__
__volatile__
(
"
dc
cvau
%
[
dline
]
\
n
"
:
:
[
dline
]
"
r
"
(
dline
)
:
"
memory
"
)
;
dline
+
=
dsize
;
}
while
(
dline
<
end
)
;
__asm__
__volatile__
(
"
dsb
ish
\
n
"
:
:
:
"
memory
"
)
;
do
{
__asm__
__volatile__
(
"
ic
ivau
%
[
iline
]
\
n
"
:
:
[
iline
]
"
r
"
(
iline
)
:
"
memory
"
)
;
iline
+
=
isize
;
}
while
(
iline
<
end
)
;
__asm__
__volatile__
(
"
dsb
ish
\
n
"
"
isb
\
n
"
:
:
:
"
memory
"
)
;
#
else
USE
(
address
length
)
;
#
endif
}
}
