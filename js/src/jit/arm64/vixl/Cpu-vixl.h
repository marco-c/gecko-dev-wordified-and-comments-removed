#
ifndef
VIXL_CPU_AARCH64_H
#
define
VIXL_CPU_AARCH64_H
#
include
"
jit
/
arm64
/
vixl
/
Cpu
-
Features
-
vixl
.
h
"
#
include
"
jit
/
arm64
/
vixl
/
Globals
-
vixl
.
h
"
#
include
"
jit
/
arm64
/
vixl
/
Instructions
-
vixl
.
h
"
#
ifndef
VIXL_INCLUDE_TARGET_AARCH64
#
error
cpu
-
aarch64
.
h
requires
VIXL_INCLUDE_TARGET_AARCH64
(
scons
target
=
a64
)
.
#
endif
namespace
vixl
{
class
IDRegister
{
protected
:
explicit
IDRegister
(
uint64_t
value
=
0
)
:
value_
(
value
)
{
}
class
Field
{
public
:
enum
Type
{
kUnsigned
kSigned
}
;
explicit
Field
(
int
lsb
Type
type
=
kUnsigned
)
:
lsb_
(
lsb
)
type_
(
type
)
{
}
static
const
int
kMaxWidthInBits
=
4
;
int
GetWidthInBits
(
)
const
{
return
kMaxWidthInBits
;
}
int
GetLsb
(
)
const
{
return
lsb_
;
}
int
GetMsb
(
)
const
{
return
lsb_
+
GetWidthInBits
(
)
-
1
;
}
Type
GetType
(
)
const
{
return
type_
;
}
private
:
int
lsb_
;
Type
type_
;
}
;
public
:
int
Get
(
Field
field
)
const
;
private
:
uint64_t
value_
;
}
;
class
AA64PFR0
:
public
IDRegister
{
public
:
explicit
AA64PFR0
(
uint64_t
value
)
:
IDRegister
(
value
)
{
}
CPUFeatures
GetCPUFeatures
(
)
const
;
private
:
static
const
Field
kFP
;
static
const
Field
kAdvSIMD
;
static
const
Field
kSVE
;
static
const
Field
kDIT
;
}
;
class
AA64PFR1
:
public
IDRegister
{
public
:
explicit
AA64PFR1
(
uint64_t
value
)
:
IDRegister
(
value
)
{
}
CPUFeatures
GetCPUFeatures
(
)
const
;
private
:
static
const
Field
kBT
;
}
;
class
AA64ISAR0
:
public
IDRegister
{
public
:
explicit
AA64ISAR0
(
uint64_t
value
)
:
IDRegister
(
value
)
{
}
CPUFeatures
GetCPUFeatures
(
)
const
;
private
:
static
const
Field
kAES
;
static
const
Field
kSHA1
;
static
const
Field
kSHA2
;
static
const
Field
kCRC32
;
static
const
Field
kAtomic
;
static
const
Field
kRDM
;
static
const
Field
kSHA3
;
static
const
Field
kSM3
;
static
const
Field
kSM4
;
static
const
Field
kDP
;
static
const
Field
kFHM
;
static
const
Field
kTS
;
}
;
class
AA64ISAR1
:
public
IDRegister
{
public
:
explicit
AA64ISAR1
(
uint64_t
value
)
:
IDRegister
(
value
)
{
}
CPUFeatures
GetCPUFeatures
(
)
const
;
private
:
static
const
Field
kDPB
;
static
const
Field
kAPA
;
static
const
Field
kAPI
;
static
const
Field
kJSCVT
;
static
const
Field
kFCMA
;
static
const
Field
kLRCPC
;
static
const
Field
kGPA
;
static
const
Field
kGPI
;
static
const
Field
kFRINTTS
;
static
const
Field
kSB
;
static
const
Field
kSPECRES
;
}
;
class
AA64MMFR1
:
public
IDRegister
{
public
:
explicit
AA64MMFR1
(
uint64_t
value
)
:
IDRegister
(
value
)
{
}
CPUFeatures
GetCPUFeatures
(
)
const
;
private
:
static
const
Field
kLO
;
}
;
class
CPU
{
public
:
static
void
SetUp
(
)
;
static
void
EnsureIAndDCacheCoherency
(
void
*
address
size_t
length
bool
codeIsThreadLocal
)
;
static
bool
CanFlushICacheFromBackgroundThreads
(
)
;
static
CPUFeatures
InferCPUFeaturesFromIDRegisters
(
)
;
static
CPUFeatures
InferCPUFeaturesFromOS
(
CPUFeatures
:
:
QueryIDRegistersOption
option
=
CPUFeatures
:
:
kQueryIDRegistersIfAvailable
)
;
template
<
typename
T
>
static
T
SetPointerTag
(
T
pointer
uint64_t
tag
)
{
VIXL_ASSERT
(
IsUintN
(
kAddressTagWidth
tag
)
)
;
uint64_t
raw
=
(
uint64_t
)
pointer
;
VIXL_STATIC_ASSERT
(
sizeof
(
pointer
)
=
=
sizeof
(
raw
)
)
;
raw
=
(
raw
&
~
kAddressTagMask
)
|
(
tag
<
<
kAddressTagOffset
)
;
return
(
T
)
raw
;
}
template
<
typename
T
>
static
uint64_t
GetPointerTag
(
T
pointer
)
{
uint64_t
raw
=
(
uint64_t
)
pointer
;
VIXL_STATIC_ASSERT
(
sizeof
(
pointer
)
=
=
sizeof
(
raw
)
)
;
return
(
raw
&
kAddressTagMask
)
>
>
kAddressTagOffset
;
}
private
:
#
define
VIXL_AARCH64_ID_REG_LIST
(
V
)
\
V
(
AA64PFR0
)
\
V
(
AA64PFR1
)
\
V
(
AA64ISAR0
)
\
V
(
AA64ISAR1
)
\
V
(
AA64MMFR1
)
#
define
VIXL_READ_ID_REG
(
NAME
)
static
NAME
Read
#
#
NAME
(
)
;
VIXL_AARCH64_ID_REG_LIST
(
VIXL_READ_ID_REG
)
#
undef
VIXL_READ_ID_REG
static
uint32_t
GetCacheType
(
)
;
static
unsigned
icache_line_size_
;
static
unsigned
dcache_line_size_
;
}
;
}
#
endif
