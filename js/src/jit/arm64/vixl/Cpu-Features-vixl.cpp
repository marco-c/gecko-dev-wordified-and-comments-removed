#
include
"
jit
/
arm64
/
vixl
/
Cpu
-
Features
-
vixl
.
h
"
#
include
<
ostream
>
#
include
"
jit
/
arm64
/
vixl
/
Cpu
-
vixl
.
h
"
#
include
"
jit
/
arm64
/
vixl
/
Globals
-
vixl
.
h
"
#
include
"
jit
/
arm64
/
vixl
/
Utils
-
vixl
.
h
"
#
define
VIXL_USE_AARCH64_CPU_HELPERS
namespace
vixl
{
static
uint64_t
MakeFeatureMask
(
CPUFeatures
:
:
Feature
feature
)
{
if
(
feature
=
=
CPUFeatures
:
:
kNone
)
{
return
0
;
}
else
{
VIXL_STATIC_ASSERT
(
CPUFeatures
:
:
kNumberOfFeatures
<
=
(
sizeof
(
uint64_t
)
*
8
)
)
;
VIXL_ASSERT
(
feature
<
CPUFeatures
:
:
kNumberOfFeatures
)
;
return
UINT64_C
(
1
)
<
<
feature
;
}
}
CPUFeatures
:
:
CPUFeatures
(
Feature
feature0
Feature
feature1
Feature
feature2
Feature
feature3
)
:
features_
(
0
)
{
Combine
(
feature0
feature1
feature2
feature3
)
;
}
CPUFeatures
CPUFeatures
:
:
All
(
)
{
CPUFeatures
all
;
VIXL_STATIC_ASSERT
(
CPUFeatures
:
:
kNumberOfFeatures
<
(
sizeof
(
uint64_t
)
*
8
)
)
;
all
.
features_
=
(
UINT64_C
(
1
)
<
<
kNumberOfFeatures
)
-
1
;
return
all
;
}
CPUFeatures
CPUFeatures
:
:
InferFromIDRegisters
(
)
{
CPUFeatures
features
(
CPUFeatures
:
:
kIDRegisterEmulation
)
;
#
ifdef
VIXL_USE_AARCH64_CPU_HELPERS
features
.
Combine
(
CPU
:
:
InferCPUFeaturesFromIDRegisters
(
)
)
;
#
endif
return
features
;
}
CPUFeatures
CPUFeatures
:
:
InferFromOS
(
QueryIDRegistersOption
option
)
{
#
ifdef
VIXL_USE_AARCH64_CPU_HELPERS
return
CPU
:
:
InferCPUFeaturesFromOS
(
option
)
;
#
else
USE
(
option
)
;
return
CPUFeatures
(
)
;
#
endif
}
void
CPUFeatures
:
:
Combine
(
const
CPUFeatures
&
other
)
{
features_
|
=
other
.
features_
;
}
void
CPUFeatures
:
:
Combine
(
Feature
feature0
Feature
feature1
Feature
feature2
Feature
feature3
)
{
features_
|
=
MakeFeatureMask
(
feature0
)
;
features_
|
=
MakeFeatureMask
(
feature1
)
;
features_
|
=
MakeFeatureMask
(
feature2
)
;
features_
|
=
MakeFeatureMask
(
feature3
)
;
}
void
CPUFeatures
:
:
Remove
(
const
CPUFeatures
&
other
)
{
features_
&
=
~
other
.
features_
;
}
void
CPUFeatures
:
:
Remove
(
Feature
feature0
Feature
feature1
Feature
feature2
Feature
feature3
)
{
features_
&
=
~
MakeFeatureMask
(
feature0
)
;
features_
&
=
~
MakeFeatureMask
(
feature1
)
;
features_
&
=
~
MakeFeatureMask
(
feature2
)
;
features_
&
=
~
MakeFeatureMask
(
feature3
)
;
}
CPUFeatures
CPUFeatures
:
:
With
(
const
CPUFeatures
&
other
)
const
{
CPUFeatures
f
(
*
this
)
;
f
.
Combine
(
other
)
;
return
f
;
}
CPUFeatures
CPUFeatures
:
:
With
(
Feature
feature0
Feature
feature1
Feature
feature2
Feature
feature3
)
const
{
CPUFeatures
f
(
*
this
)
;
f
.
Combine
(
feature0
feature1
feature2
feature3
)
;
return
f
;
}
CPUFeatures
CPUFeatures
:
:
Without
(
const
CPUFeatures
&
other
)
const
{
CPUFeatures
f
(
*
this
)
;
f
.
Remove
(
other
)
;
return
f
;
}
CPUFeatures
CPUFeatures
:
:
Without
(
Feature
feature0
Feature
feature1
Feature
feature2
Feature
feature3
)
const
{
CPUFeatures
f
(
*
this
)
;
f
.
Remove
(
feature0
feature1
feature2
feature3
)
;
return
f
;
}
bool
CPUFeatures
:
:
Has
(
const
CPUFeatures
&
other
)
const
{
return
(
features_
&
other
.
features_
)
=
=
other
.
features_
;
}
bool
CPUFeatures
:
:
Has
(
Feature
feature0
Feature
feature1
Feature
feature2
Feature
feature3
)
const
{
uint64_t
mask
=
MakeFeatureMask
(
feature0
)
|
MakeFeatureMask
(
feature1
)
|
MakeFeatureMask
(
feature2
)
|
MakeFeatureMask
(
feature3
)
;
return
(
features_
&
mask
)
=
=
mask
;
}
size_t
CPUFeatures
:
:
Count
(
)
const
{
return
CountSetBits
(
features_
)
;
}
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
os
CPUFeatures
:
:
Feature
feature
)
{
switch
(
feature
)
{
#
define
VIXL_FORMAT_FEATURE
(
SYMBOL
NAME
CPUINFO
)
\
case
CPUFeatures
:
:
SYMBOL
:
\
return
os
<
<
NAME
;
VIXL_CPU_FEATURE_LIST
(
VIXL_FORMAT_FEATURE
)
#
undef
VIXL_FORMAT_FEATURE
case
CPUFeatures
:
:
kNone
:
return
os
<
<
"
none
"
;
case
CPUFeatures
:
:
kNumberOfFeatures
:
VIXL_UNREACHABLE
(
)
;
}
VIXL_UNREACHABLE
(
)
;
return
os
;
}
CPUFeatures
:
:
const_iterator
CPUFeatures
:
:
begin
(
)
const
{
if
(
features_
=
=
0
)
return
const_iterator
(
this
kNone
)
;
int
feature_number
=
CountTrailingZeros
(
features_
)
;
vixl
:
:
CPUFeatures
:
:
Feature
feature
=
static_cast
<
CPUFeatures
:
:
Feature
>
(
feature_number
)
;
return
const_iterator
(
this
feature
)
;
}
CPUFeatures
:
:
const_iterator
CPUFeatures
:
:
end
(
)
const
{
return
const_iterator
(
this
kNone
)
;
}
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
os
const
CPUFeatures
&
features
)
{
CPUFeatures
:
:
const_iterator
it
=
features
.
begin
(
)
;
while
(
it
!
=
features
.
end
(
)
)
{
os
<
<
*
it
;
+
+
it
;
if
(
it
!
=
features
.
end
(
)
)
os
<
<
"
"
;
}
return
os
;
}
bool
CPUFeaturesConstIterator
:
:
operator
=
=
(
const
CPUFeaturesConstIterator
&
other
)
const
{
VIXL_ASSERT
(
IsValid
(
)
)
;
return
(
cpu_features_
=
=
other
.
cpu_features_
)
&
&
(
feature_
=
=
other
.
feature_
)
;
}
CPUFeatures
:
:
Feature
CPUFeaturesConstIterator
:
:
operator
+
+
(
)
{
VIXL_ASSERT
(
IsValid
(
)
)
;
do
{
feature_
=
static_cast
<
CPUFeatures
:
:
Feature
>
(
feature_
+
1
)
;
if
(
feature_
=
=
CPUFeatures
:
:
kNumberOfFeatures
)
{
feature_
=
CPUFeatures
:
:
kNone
;
VIXL_STATIC_ASSERT
(
CPUFeatures
:
:
kNone
=
=
-
1
)
;
}
VIXL_ASSERT
(
CPUFeatures
:
:
kNone
<
=
feature_
)
;
VIXL_ASSERT
(
feature_
<
CPUFeatures
:
:
kNumberOfFeatures
)
;
}
while
(
!
cpu_features_
-
>
Has
(
feature_
)
)
;
return
feature_
;
}
CPUFeatures
:
:
Feature
CPUFeaturesConstIterator
:
:
operator
+
+
(
int
)
{
CPUFeatures
:
:
Feature
result
=
feature_
;
+
+
(
*
this
)
;
return
result
;
}
}
