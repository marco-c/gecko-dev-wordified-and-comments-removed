#
ifndef
jit_none_AtomicOperations_feeling_lucky_h
#
define
jit_none_AtomicOperations_feeling_lucky_h
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Types
.
h
"
#
if
defined
(
__ppc__
)
|
|
defined
(
__PPC__
)
#
define
GNUC_COMPATIBLE
#
endif
#
if
defined
(
__ppc64__
)
|
|
defined
(
__PPC64__
)
|
|
defined
(
__ppc64le__
)
|
|
defined
(
__PPC64LE__
)
#
define
HAS_64BIT_ATOMICS
#
define
HAS_64BIT_LOCKFREE
#
define
GNUC_COMPATIBLE
#
endif
#
ifdef
__sparc__
#
define
GNUC_COMPATIBLE
#
ifdef
__LP64__
#
define
HAS_64BIT_ATOMICS
#
define
HAS_64BIT_LOCKFREE
#
endif
#
endif
#
ifdef
__alpha__
#
define
GNUC_COMPATIBLE
#
endif
#
ifdef
__hppa__
#
define
GNUC_COMPATIBLE
#
endif
#
ifdef
__sh__
#
define
GNUC_COMPATIBLE
#
endif
#
if
defined
(
HAS_64BIT_LOCKFREE
)
&
&
!
defined
(
HAS_64BIT_ATOMICS
)
#
error
"
This
combination
of
features
is
senseless
please
fix
"
#
endif
#
ifdef
GNUC_COMPATIBLE
inline
bool
js
:
:
jit
:
:
AtomicOperations
:
:
hasAtomic8
(
)
{
#
if
defined
(
HAS_64BIT_ATOMICS
)
return
true
;
#
else
return
false
;
#
endif
}
inline
bool
js
:
:
jit
:
:
AtomicOperations
:
:
isLockfree8
(
)
{
#
if
defined
(
HAS_64BIT_LOCKFREE
)
return
true
;
#
else
return
false
;
#
endif
}
inline
void
js
:
:
jit
:
:
AtomicOperations
:
:
fenceSeqCst
(
)
{
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
__sync_synchronize
(
)
;
#
else
__atomic_thread_fence
(
__ATOMIC_SEQ_CST
)
;
#
endif
}
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
loadSeqCst
(
T
*
addr
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
__sync_synchronize
(
)
;
T
v
=
*
addr
;
__sync_synchronize
(
)
;
#
else
T
v
;
__atomic_load
(
addr
&
v
__ATOMIC_SEQ_CST
)
;
#
endif
return
v
;
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
loadSeqCst
(
int64_t
*
addr
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
loadSeqCst
(
uint64_t
*
addr
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
void
js
:
:
jit
:
:
AtomicOperations
:
:
storeSeqCst
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
__sync_synchronize
(
)
;
*
addr
=
val
;
__sync_synchronize
(
)
;
#
else
__atomic_store
(
addr
&
val
__ATOMIC_SEQ_CST
)
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
void
AtomicOperations
:
:
storeSeqCst
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
void
AtomicOperations
:
:
storeSeqCst
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
compareExchangeSeqCst
(
T
*
addr
T
oldval
T
newval
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
return
__sync_val_compare_and_swap
(
addr
oldval
newval
)
;
#
else
__atomic_compare_exchange
(
addr
&
oldval
&
newval
false
__ATOMIC_SEQ_CST
__ATOMIC_SEQ_CST
)
;
return
oldval
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
compareExchangeSeqCst
(
int64_t
*
addr
int64_t
oldval
int64_t
newval
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
compareExchangeSeqCst
(
uint64_t
*
addr
uint64_t
oldval
uint64_t
newval
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
fetchAddSeqCst
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
return
__sync_fetch_and_add
(
addr
val
)
;
#
else
return
__atomic_fetch_add
(
addr
val
__ATOMIC_SEQ_CST
)
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
fetchAddSeqCst
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
fetchAddSeqCst
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
fetchSubSeqCst
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
return
__sync_fetch_and_sub
(
addr
val
)
;
#
else
return
__atomic_fetch_sub
(
addr
val
__ATOMIC_SEQ_CST
)
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
fetchSubSeqCst
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
fetchSubSeqCst
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
fetchAndSeqCst
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
return
__sync_fetch_and_and
(
addr
val
)
;
#
else
return
__atomic_fetch_and
(
addr
val
__ATOMIC_SEQ_CST
)
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
fetchAndSeqCst
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
fetchAndSeqCst
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
fetchOrSeqCst
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
return
__sync_fetch_and_or
(
addr
val
)
;
#
else
return
__atomic_fetch_or
(
addr
val
__ATOMIC_SEQ_CST
)
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
fetchOrSeqCst
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
fetchOrSeqCst
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
fetchXorSeqCst
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
return
__sync_fetch_and_xor
(
addr
val
)
;
#
else
return
__atomic_fetch_xor
(
addr
val
__ATOMIC_SEQ_CST
)
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
fetchXorSeqCst
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
fetchXorSeqCst
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
loadSafeWhenRacy
(
T
*
addr
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
return
*
addr
;
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
loadSafeWhenRacy
(
int64_t
*
addr
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
loadSafeWhenRacy
(
uint64_t
*
addr
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
typename
T
>
inline
void
js
:
:
jit
:
:
AtomicOperations
:
:
storeSafeWhenRacy
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
*
addr
=
val
;
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
void
AtomicOperations
:
:
storeSafeWhenRacy
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
void
AtomicOperations
:
:
storeSafeWhenRacy
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
inline
void
js
:
:
jit
:
:
AtomicOperations
:
:
memcpySafeWhenRacy
(
void
*
dest
const
void
*
src
size_t
nbytes
)
{
MOZ_ASSERT
(
!
(
(
char
*
)
dest
<
=
(
char
*
)
src
&
&
(
char
*
)
src
<
(
char
*
)
dest
+
nbytes
)
)
;
MOZ_ASSERT
(
!
(
(
char
*
)
src
<
=
(
char
*
)
dest
&
&
(
char
*
)
dest
<
(
char
*
)
src
+
nbytes
)
)
;
:
:
memcpy
(
dest
src
nbytes
)
;
}
inline
void
js
:
:
jit
:
:
AtomicOperations
:
:
memmoveSafeWhenRacy
(
void
*
dest
const
void
*
src
size_t
nbytes
)
{
:
:
memmove
(
dest
src
nbytes
)
;
}
template
<
typename
T
>
inline
T
js
:
:
jit
:
:
AtomicOperations
:
:
exchangeSeqCst
(
T
*
addr
T
val
)
{
static_assert
(
sizeof
(
T
)
<
=
8
"
atomics
supported
up
to
8
bytes
only
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
T
v
;
__sync_synchronize
(
)
;
do
{
v
=
*
addr
;
}
while
(
__sync_val_compare_and_swap
(
addr
v
val
)
!
=
v
)
;
return
v
;
#
else
T
v
;
__atomic_exchange
(
addr
&
val
&
v
__ATOMIC_SEQ_CST
)
;
return
v
;
#
endif
}
#
ifndef
HAS_64BIT_ATOMICS
namespace
js
{
namespace
jit
{
template
<
>
inline
int64_t
AtomicOperations
:
:
exchangeSeqCst
(
int64_t
*
addr
int64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
template
<
>
inline
uint64_t
AtomicOperations
:
:
exchangeSeqCst
(
uint64_t
*
addr
uint64_t
val
)
{
MOZ_CRASH
(
"
No
64
-
bit
atomics
"
)
;
}
}
}
#
endif
template
<
size_t
nbytes
>
inline
void
js
:
:
jit
:
:
RegionLock
:
:
acquire
(
void
*
addr
)
{
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
while
(
!
__sync_bool_compare_and_swap
(
&
spinlock
0
1
)
)
;
#
else
uint32_t
zero
=
0
;
uint32_t
one
=
1
;
while
(
!
__atomic_compare_exchange
(
&
spinlock
&
zero
&
one
false
__ATOMIC_ACQUIRE
__ATOMIC_ACQUIRE
)
)
{
zero
=
0
;
continue
;
}
#
endif
}
template
<
size_t
nbytes
>
inline
void
js
:
:
jit
:
:
RegionLock
:
:
release
(
void
*
addr
)
{
MOZ_ASSERT
(
AtomicOperations
:
:
loadSeqCst
(
&
spinlock
)
=
=
1
"
releasing
unlocked
region
lock
"
)
;
#
ifdef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
__sync_sub_and_fetch
(
&
spinlock
1
)
;
#
else
uint32_t
zero
=
0
;
__atomic_store
(
&
spinlock
&
zero
__ATOMIC_SEQ_CST
)
;
#
endif
}
#
elif
defined
(
ENABLE_SHARED_ARRAY_BUFFER
)
#
error
"
Either
disable
JS
shared
memory
use
GCC
or
Clang
or
add
code
here
"
#
endif
#
undef
ATOMICS_IMPLEMENTED_WITH_SYNC_INTRINSICS
#
undef
GNUC_COMPATIBLE
#
undef
HAS_64BIT_ATOMICS
#
undef
HAS_64BIT_LOCKFREE
#
endif
