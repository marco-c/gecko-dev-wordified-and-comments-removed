#
ifndef
jit_WarpSnapshot_h
#
define
jit_WarpSnapshot_h
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
Variant
.
h
"
#
include
"
jit
/
JitAllocPolicy
.
h
"
#
include
"
jit
/
JitContext
.
h
"
#
include
"
vm
/
Printer
.
h
"
namespace
js
{
class
ModuleEnvironmentObject
;
namespace
jit
{
#
define
WARP_OP_SNAPSHOT_LIST
(
_
)
\
_
(
WarpArguments
)
\
_
(
WarpRegExp
)
\
_
(
WarpFunctionProto
)
\
_
(
WarpGetIntrinsic
)
\
_
(
WarpGetImport
)
\
_
(
WarpLambda
)
\
_
(
WarpRest
)
class
WarpOpSnapshot
:
public
TempObject
public
mozilla
:
:
LinkedListElement
<
WarpOpSnapshot
>
{
public
:
enum
class
Kind
:
uint16_t
{
#
define
DEF_KIND
(
KIND
)
KIND
WARP_OP_SNAPSHOT_LIST
(
DEF_KIND
)
#
undef
DEF_KIND
}
;
private
:
uint32_t
offset_
=
0
;
Kind
kind_
;
protected
:
WarpOpSnapshot
(
Kind
kind
uint32_t
offset
)
:
offset_
(
offset
)
kind_
(
kind
)
{
}
public
:
uint32_t
offset
(
)
const
{
return
offset_
;
}
template
<
typename
T
>
const
T
*
as
(
)
const
{
MOZ_ASSERT
(
kind_
=
=
T
:
:
ThisKind
)
;
return
static_cast
<
const
T
*
>
(
this
)
;
}
template
<
typename
T
>
T
*
as
(
)
{
MOZ_ASSERT
(
kind_
=
=
T
:
:
ThisKind
)
;
return
static_cast
<
T
*
>
(
this
)
;
}
void
trace
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dump
(
GenericPrinter
&
out
JSScript
*
script
)
const
;
#
endif
}
;
using
WarpOpSnapshotList
=
mozilla
:
:
LinkedList
<
WarpOpSnapshot
>
;
class
WarpArguments
:
public
WarpOpSnapshot
{
ArgumentsObject
*
templateObj_
;
public
:
static
constexpr
Kind
ThisKind
=
Kind
:
:
WarpArguments
;
WarpArguments
(
uint32_t
offset
ArgumentsObject
*
templateObj
)
:
WarpOpSnapshot
(
ThisKind
offset
)
templateObj_
(
templateObj
)
{
}
ArgumentsObject
*
templateObj
(
)
const
{
return
templateObj_
;
}
void
traceData
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dumpData
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
class
WarpRegExp
:
public
WarpOpSnapshot
{
bool
hasShared_
;
public
:
static
constexpr
Kind
ThisKind
=
Kind
:
:
WarpRegExp
;
WarpRegExp
(
uint32_t
offset
bool
hasShared
)
:
WarpOpSnapshot
(
ThisKind
offset
)
hasShared_
(
hasShared
)
{
}
bool
hasShared
(
)
const
{
return
hasShared_
;
}
void
traceData
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dumpData
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
class
WarpFunctionProto
:
public
WarpOpSnapshot
{
JSObject
*
proto_
;
public
:
static
constexpr
Kind
ThisKind
=
Kind
:
:
WarpFunctionProto
;
WarpFunctionProto
(
uint32_t
offset
JSObject
*
proto
)
:
WarpOpSnapshot
(
ThisKind
offset
)
proto_
(
proto
)
{
MOZ_ASSERT
(
proto
)
;
}
JSObject
*
proto
(
)
const
{
return
proto_
;
}
void
traceData
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dumpData
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
class
WarpGetIntrinsic
:
public
WarpOpSnapshot
{
Value
intrinsic_
;
public
:
static
constexpr
Kind
ThisKind
=
Kind
:
:
WarpGetIntrinsic
;
WarpGetIntrinsic
(
uint32_t
offset
const
Value
&
intrinsic
)
:
WarpOpSnapshot
(
ThisKind
offset
)
intrinsic_
(
intrinsic
)
{
}
Value
intrinsic
(
)
const
{
return
intrinsic_
;
}
void
traceData
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dumpData
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
class
WarpGetImport
:
public
WarpOpSnapshot
{
ModuleEnvironmentObject
*
targetEnv_
;
uint32_t
numFixedSlots_
;
uint32_t
slot_
;
bool
needsLexicalCheck_
;
public
:
static
constexpr
Kind
ThisKind
=
Kind
:
:
WarpGetImport
;
WarpGetImport
(
uint32_t
offset
ModuleEnvironmentObject
*
targetEnv
uint32_t
numFixedSlots
uint32_t
slot
bool
needsLexicalCheck
)
:
WarpOpSnapshot
(
ThisKind
offset
)
targetEnv_
(
targetEnv
)
numFixedSlots_
(
numFixedSlots
)
slot_
(
slot
)
needsLexicalCheck_
(
needsLexicalCheck
)
{
}
ModuleEnvironmentObject
*
targetEnv
(
)
const
{
return
targetEnv_
;
}
uint32_t
numFixedSlots
(
)
const
{
return
numFixedSlots_
;
}
uint32_t
slot
(
)
const
{
return
slot_
;
}
bool
needsLexicalCheck
(
)
const
{
return
needsLexicalCheck_
;
}
void
traceData
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dumpData
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
class
WarpLambda
:
public
WarpOpSnapshot
{
BaseScript
*
baseScript_
;
FunctionFlags
flags_
;
uint16_t
nargs_
;
public
:
static
constexpr
Kind
ThisKind
=
Kind
:
:
WarpLambda
;
WarpLambda
(
uint32_t
offset
BaseScript
*
baseScript
FunctionFlags
flags
uint16_t
nargs
)
:
WarpOpSnapshot
(
ThisKind
offset
)
baseScript_
(
baseScript
)
flags_
(
flags
)
nargs_
(
nargs
)
{
}
BaseScript
*
baseScript
(
)
const
{
return
baseScript_
;
}
FunctionFlags
flags
(
)
const
{
return
flags_
;
}
uint16_t
nargs
(
)
const
{
return
nargs_
;
}
void
traceData
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dumpData
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
class
WarpRest
:
public
WarpOpSnapshot
{
ArrayObject
*
templateObject_
;
public
:
static
constexpr
Kind
ThisKind
=
Kind
:
:
WarpRest
;
WarpRest
(
uint32_t
offset
ArrayObject
*
templateObject
)
:
WarpOpSnapshot
(
ThisKind
offset
)
templateObject_
(
templateObject
)
{
}
ArrayObject
*
templateObject
(
)
const
{
return
templateObject_
;
}
void
traceData
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dumpData
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
struct
NoEnvironment
{
}
;
struct
FunctionEnvironment
{
CallObject
*
callObjectTemplate
;
LexicalEnvironmentObject
*
namedLambdaTemplate
;
public
:
FunctionEnvironment
(
CallObject
*
callObjectTemplate
LexicalEnvironmentObject
*
namedLambdaTemplate
)
:
callObjectTemplate
(
callObjectTemplate
)
namedLambdaTemplate
(
namedLambdaTemplate
)
{
}
}
;
using
WarpEnvironment
=
mozilla
:
:
Variant
<
NoEnvironment
JSObject
*
FunctionEnvironment
>
;
class
WarpScriptSnapshot
:
public
TempObject
{
JSScript
*
script_
;
WarpEnvironment
environment_
;
WarpOpSnapshotList
opSnapshots_
;
ModuleObject
*
moduleObject_
;
JSObject
*
instrumentationCallback_
;
mozilla
:
:
Maybe
<
int32_t
>
instrumentationScriptId_
;
mozilla
:
:
Maybe
<
bool
>
instrumentationActive_
;
bool
isArrowFunction_
;
public
:
WarpScriptSnapshot
(
JSScript
*
script
const
WarpEnvironment
&
env
WarpOpSnapshotList
&
&
opSnapshots
ModuleObject
*
moduleObject
JSObject
*
instrumentationCallback
mozilla
:
:
Maybe
<
int32_t
>
instrumentationScriptId
mozilla
:
:
Maybe
<
bool
>
instrumentationActive
)
;
JSScript
*
script
(
)
const
{
return
script_
;
}
const
WarpEnvironment
&
environment
(
)
const
{
return
environment_
;
}
const
WarpOpSnapshotList
&
opSnapshots
(
)
const
{
return
opSnapshots_
;
}
ModuleObject
*
moduleObject
(
)
const
{
return
moduleObject_
;
}
JSObject
*
instrumentationCallback
(
)
const
{
MOZ_ASSERT
(
instrumentationCallback_
)
;
return
instrumentationCallback_
;
}
int32_t
instrumentationScriptId
(
)
const
{
return
*
instrumentationScriptId_
;
}
bool
instrumentationActive
(
)
const
{
return
*
instrumentationActive_
;
}
bool
isArrowFunction
(
)
const
{
return
isArrowFunction_
;
}
void
trace
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dump
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
class
WarpSnapshot
:
public
TempObject
{
WarpScriptSnapshot
*
script_
;
LexicalEnvironmentObject
*
globalLexicalEnv_
;
Value
globalLexicalEnvThis_
;
public
:
explicit
WarpSnapshot
(
JSContext
*
cx
WarpScriptSnapshot
*
script
)
;
WarpScriptSnapshot
*
script
(
)
const
{
return
script_
;
}
LexicalEnvironmentObject
*
globalLexicalEnv
(
)
const
{
return
globalLexicalEnv_
;
}
Value
globalLexicalEnvThis
(
)
const
{
return
globalLexicalEnvThis_
;
}
void
trace
(
JSTracer
*
trc
)
;
#
ifdef
JS_JITSPEW
void
dump
(
)
const
;
void
dump
(
GenericPrinter
&
out
)
const
;
#
endif
}
;
}
}
#
endif
