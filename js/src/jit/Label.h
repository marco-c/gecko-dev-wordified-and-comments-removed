#
ifndef
jit_Label_h
#
define
jit_Label_h
#
include
"
jit
/
Ion
.
h
"
namespace
js
{
namespace
jit
{
struct
LabelBase
{
protected
:
int32_t
offset_
:
31
;
bool
bound_
:
1
;
void
operator
=
(
const
LabelBase
&
label
)
=
delete
;
public
:
static
const
int32_t
INVALID_OFFSET
=
-
1
;
LabelBase
(
)
:
offset_
(
INVALID_OFFSET
)
bound_
(
false
)
{
}
bool
bound
(
)
const
{
return
bound_
;
}
int32_t
offset
(
)
const
{
MOZ_ASSERT
(
bound
(
)
|
|
used
(
)
)
;
return
offset_
;
}
void
offsetBy
(
int32_t
delta
)
{
MOZ_ASSERT
(
bound
(
)
|
|
used
(
)
)
;
MOZ_ASSERT
(
offset
(
)
+
delta
>
=
offset
(
)
"
no
overflow
"
)
;
mozilla
:
:
DebugOnly
<
int32_t
>
oldOffset
(
offset
(
)
)
;
offset_
+
=
delta
;
MOZ_ASSERT
(
offset_
=
=
delta
+
oldOffset
"
new
offset
fits
in
31
bits
"
)
;
}
bool
used
(
)
const
{
return
!
bound
(
)
&
&
offset_
>
INVALID_OFFSET
;
}
void
bind
(
int32_t
offset
)
{
MOZ_ASSERT
(
!
bound
(
)
)
;
offset_
=
offset
;
bound_
=
true
;
MOZ_ASSERT
(
offset_
=
=
offset
"
offset
fits
in
31
bits
"
)
;
}
void
reset
(
)
{
offset_
=
INVALID_OFFSET
;
bound_
=
false
;
}
int32_t
use
(
int32_t
offset
)
{
MOZ_ASSERT
(
!
bound
(
)
)
;
int32_t
old
=
offset_
;
offset_
=
offset
;
MOZ_ASSERT
(
offset_
=
=
offset
"
offset
fits
in
31
bits
"
)
;
return
old
;
}
}
;
class
Label
:
public
LabelBase
{
public
:
~
Label
(
)
{
#
ifdef
DEBUG
JitContext
*
context
=
MaybeGetJitContext
(
)
;
bool
hadError
=
js
:
:
oom
:
:
HadSimulatedOOM
(
)
|
|
(
context
&
&
context
-
>
runtime
&
&
context
-
>
runtime
-
>
hadOutOfMemory
(
)
)
;
MOZ_ASSERT_IF
(
!
hadError
!
used
(
)
)
;
#
endif
}
}
;
class
NonAssertingLabel
:
public
Label
{
public
:
~
NonAssertingLabel
(
)
{
#
ifdef
DEBUG
if
(
used
(
)
)
bind
(
0
)
;
#
endif
}
}
;
}
}
#
endif
