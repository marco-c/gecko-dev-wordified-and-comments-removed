#
ifndef
jit_ProcessExecutableMemory_h
#
define
jit_ProcessExecutableMemory_h
#
include
"
util
/
Poison
.
h
"
#
ifdef
XP_IOS
#
include
<
BrowserEngineCore
/
BEMemory
.
h
>
#
endif
namespace
js
{
namespace
jit
{
#
if
JS_BITS_PER_WORD
=
=
32
static
const
size_t
MaxCodeBytesPerProcess
=
140
*
1024
*
1024
;
#
else
static
const
size_t
MaxCodeBytesPerProcess
=
2044
*
1024
*
1024
;
#
endif
#
if
defined
(
JS_CODEGEN_ARM
)
static
const
size_t
MaxCodeBytesPerBuffer
=
(
1
<
<
25
)
-
4
;
#
elif
defined
(
JS_CODEGEN_ARM64
)
static
const
size_t
MaxCodeBytesPerBuffer
=
(
1
<
<
27
)
-
4
;
#
else
static
const
size_t
MaxCodeBytesPerBuffer
=
MaxCodeBytesPerProcess
;
#
endif
static
const
size_t
ExecutableCodePageSize
=
64
*
1024
;
enum
class
ProtectionSetting
{
Writable
Executable
}
;
enum
class
MustFlushICache
{
No
Yes
}
;
[
[
nodiscard
]
]
extern
bool
ReprotectRegion
(
void
*
start
size_t
size
ProtectionSetting
protection
MustFlushICache
flushICache
)
;
[
[
nodiscard
]
]
extern
bool
InitProcessExecutableMemory
(
)
;
extern
void
ReleaseProcessExecutableMemory
(
)
;
extern
void
*
AllocateExecutableMemory
(
size_t
bytes
ProtectionSetting
protection
MemCheckKind
checkKind
)
;
extern
void
DeallocateExecutableMemory
(
void
*
addr
size_t
bytes
)
;
extern
bool
CanLikelyAllocateMoreExecutableMemory
(
)
;
extern
size_t
LikelyAvailableExecutableMemory
(
)
;
extern
bool
AddressIsInExecutableMemory
(
const
void
*
p
)
;
class
MOZ_RAII
AutoMarkJitCodeWritableForThread
{
#
ifdef
DEBUG
void
checkConstructor
(
)
;
void
checkDestructor
(
)
;
#
else
void
checkConstructor
(
)
{
}
void
checkDestructor
(
)
{
}
#
endif
#
if
defined
(
JS_USE_APPLE_FAST_WX
)
&
&
!
defined
(
XP_IOS
)
void
markExecutable
(
bool
executable
)
;
#
endif
public
:
MOZ_ALWAYS_INLINE_EVEN_DEBUG
AutoMarkJitCodeWritableForThread
(
)
{
#
if
defined
(
JS_USE_APPLE_FAST_WX
)
#
if
defined
(
XP_IOS
)
be_memory_inline_jit_restrict_rwx_to_rw_with_witness
(
)
;
#
else
markExecutable
(
false
)
;
#
endif
#
endif
checkConstructor
(
)
;
}
MOZ_ALWAYS_INLINE_EVEN_DEBUG
~
AutoMarkJitCodeWritableForThread
(
)
{
#
if
defined
(
JS_USE_APPLE_FAST_WX
)
#
if
defined
(
XP_IOS
)
be_memory_inline_jit_restrict_rwx_to_rx_with_witness
(
)
;
#
else
markExecutable
(
true
)
;
#
endif
#
endif
checkDestructor
(
)
;
}
}
;
}
}
#
endif
