#
ifndef
vm_GeckoProfiler_h
#
define
vm_GeckoProfiler_h
#
include
"
mozilla
/
DebugOnly
.
h
"
#
include
"
mozilla
/
GuardObjects
.
h
"
#
include
<
stddef
.
h
>
#
include
"
jsscript
.
h
"
#
include
"
js
/
ProfilingStack
.
h
"
#
include
"
threading
/
ExclusiveData
.
h
"
#
include
"
vm
/
MutexIDs
.
h
"
namespace
js
{
using
ProfileStringMap
=
HashMap
<
JSScript
*
UniqueChars
DefaultHasher
<
JSScript
*
>
SystemAllocPolicy
>
;
class
AutoGeckoProfilerEntry
;
class
GeckoProfilerEntryMarker
;
class
GeckoProfilerBaselineOSRMarker
;
class
GeckoProfiler
{
friend
class
AutoGeckoProfilerEntry
;
friend
class
GeckoProfilerEntryMarker
;
friend
class
GeckoProfilerBaselineOSRMarker
;
JSRuntime
*
rt
;
ExclusiveData
<
ProfileStringMap
>
strings
;
ProfileEntry
*
stack_
;
uint32_t
*
size_
;
uint32_t
max_
;
bool
slowAssertions
;
uint32_t
enabled_
;
void
(
*
eventMarker_
)
(
const
char
*
)
;
UniqueChars
allocProfileString
(
JSScript
*
script
JSFunction
*
function
)
;
void
push
(
const
char
*
string
void
*
sp
JSScript
*
script
jsbytecode
*
pc
bool
copy
ProfileEntry
:
:
Category
category
=
ProfileEntry
:
:
Category
:
:
JS
)
;
void
pop
(
)
;
public
:
explicit
GeckoProfiler
(
JSRuntime
*
rt
)
;
bool
init
(
)
;
uint32_t
*
*
addressOfSizePointer
(
)
{
return
&
size_
;
}
uint32_t
*
addressOfMaxSize
(
)
{
return
&
max_
;
}
ProfileEntry
*
*
addressOfStack
(
)
{
return
&
stack_
;
}
uint32_t
*
sizePointer
(
)
{
return
size_
;
}
uint32_t
maxSize
(
)
{
return
max_
;
}
uint32_t
size
(
)
{
MOZ_ASSERT
(
installed
(
)
)
;
return
*
size_
;
}
ProfileEntry
*
stack
(
)
{
return
stack_
;
}
bool
enabled
(
)
{
MOZ_ASSERT_IF
(
enabled_
installed
(
)
)
;
return
enabled_
;
}
bool
installed
(
)
{
return
stack_
!
=
nullptr
&
&
size_
!
=
nullptr
;
}
MOZ_MUST_USE
bool
enable
(
bool
enabled
)
;
void
enableSlowAssertions
(
bool
enabled
)
{
slowAssertions
=
enabled
;
}
bool
slowAssertionsEnabled
(
)
{
return
slowAssertions
;
}
bool
enter
(
JSContext
*
cx
JSScript
*
script
JSFunction
*
maybeFun
)
;
void
exit
(
JSScript
*
script
JSFunction
*
maybeFun
)
;
void
updatePC
(
JSScript
*
script
jsbytecode
*
pc
)
{
if
(
enabled
(
)
&
&
*
size_
-
1
<
max_
)
{
MOZ_ASSERT
(
*
size_
>
0
)
;
MOZ_ASSERT
(
stack_
[
*
size_
-
1
]
.
rawScript
(
)
=
=
script
)
;
stack_
[
*
size_
-
1
]
.
setPC
(
pc
)
;
}
}
void
beginPseudoJS
(
const
char
*
string
void
*
sp
)
;
void
endPseudoJS
(
)
{
pop
(
)
;
}
jsbytecode
*
ipToPC
(
JSScript
*
script
size_t
ip
)
{
return
nullptr
;
}
void
setProfilingStack
(
ProfileEntry
*
stack
uint32_t
*
size
uint32_t
max
)
;
void
setEventMarker
(
void
(
*
fn
)
(
const
char
*
)
)
;
const
char
*
profileString
(
JSScript
*
script
JSFunction
*
maybeFun
)
;
void
onScriptFinalized
(
JSScript
*
script
)
;
void
markEvent
(
const
char
*
event
)
;
size_t
stringsCount
(
)
;
void
stringsReset
(
)
;
uint32_t
*
addressOfEnabled
(
)
{
return
&
enabled_
;
}
void
trace
(
JSTracer
*
trc
)
;
void
fixupStringsMapAfterMovingGC
(
)
;
#
ifdef
JSGC_HASH_TABLE_CHECKS
void
checkStringsMapAfterMovingGC
(
)
;
#
endif
}
;
inline
size_t
GeckoProfiler
:
:
stringsCount
(
)
{
return
strings
.
lock
(
)
-
>
count
(
)
;
}
inline
void
GeckoProfiler
:
:
stringsReset
(
)
{
strings
.
lock
(
)
-
>
clear
(
)
;
}
class
MOZ_RAII
GeckoProfilerEntryMarker
{
public
:
explicit
GeckoProfilerEntryMarker
(
JSRuntime
*
rt
JSScript
*
script
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
;
~
GeckoProfilerEntryMarker
(
)
;
private
:
GeckoProfiler
*
profiler
;
mozilla
:
:
DebugOnly
<
uint32_t
>
size_before
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
class
MOZ_NONHEAP_CLASS
AutoGeckoProfilerEntry
{
public
:
explicit
AutoGeckoProfilerEntry
(
JSRuntime
*
rt
const
char
*
label
ProfileEntry
:
:
Category
category
=
ProfileEntry
:
:
Category
:
:
JS
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
;
~
AutoGeckoProfilerEntry
(
)
;
private
:
GeckoProfiler
*
profiler_
;
mozilla
:
:
DebugOnly
<
uint32_t
>
sizeBefore_
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
class
MOZ_RAII
GeckoProfilerBaselineOSRMarker
{
public
:
explicit
GeckoProfilerBaselineOSRMarker
(
JSRuntime
*
rt
bool
hasProfilerFrame
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
;
~
GeckoProfilerBaselineOSRMarker
(
)
;
private
:
GeckoProfiler
*
profiler
;
mozilla
:
:
DebugOnly
<
uint32_t
>
size_before
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
template
<
class
Assembler
class
Register
>
class
GeckoProfilerInstrumentation
{
GeckoProfiler
*
profiler_
;
public
:
explicit
GeckoProfilerInstrumentation
(
GeckoProfiler
*
profiler
)
:
profiler_
(
profiler
)
{
}
bool
enabled
(
)
{
return
profiler_
&
&
profiler_
-
>
enabled
(
)
;
}
GeckoProfiler
*
profiler
(
)
{
MOZ_ASSERT
(
enabled
(
)
)
;
return
profiler_
;
}
void
disable
(
)
{
profiler_
=
nullptr
;
}
}
;
void
*
GetTopProfilingJitFrame
(
uint8_t
*
exitFramePtr
)
;
}
#
endif
