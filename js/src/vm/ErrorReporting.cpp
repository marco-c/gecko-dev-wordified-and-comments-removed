#
include
"
vm
/
ErrorReporting
.
h
"
#
include
<
stdarg
.
h
>
#
include
<
utility
>
#
include
"
jsexn
.
h
"
#
include
"
jsfriendapi
.
h
"
#
include
"
js
/
Warnings
.
h
"
#
include
"
vm
/
GlobalObject
.
h
"
#
include
"
vm
/
JSContext
.
h
"
#
include
"
vm
/
JSContext
-
inl
.
h
"
using
JS
:
:
HandleObject
;
using
JS
:
:
HandleValue
;
using
JS
:
:
UniqueTwoByteChars
;
void
js
:
:
CallWarningReporter
(
JSContext
*
cx
JSErrorReport
*
reportp
)
{
MOZ_ASSERT
(
reportp
)
;
MOZ_ASSERT
(
JSREPORT_IS_WARNING
(
reportp
-
>
flags
)
)
;
if
(
JS
:
:
WarningReporter
warningReporter
=
cx
-
>
runtime
(
)
-
>
warningReporter
)
{
warningReporter
(
cx
reportp
)
;
}
}
void
js
:
:
CompileError
:
:
throwError
(
JSContext
*
cx
)
{
if
(
JSREPORT_IS_WARNING
(
flags
)
)
{
CallWarningReporter
(
cx
this
)
;
return
;
}
ErrorToException
(
cx
this
nullptr
nullptr
)
;
}
bool
js
:
:
ReportExceptionClosure
:
:
operator
(
)
(
JSContext
*
cx
)
{
cx
-
>
setPendingExceptionAndCaptureStack
(
exn_
)
;
return
false
;
}
bool
js
:
:
ReportCompileWarning
(
JSContext
*
cx
ErrorMetadata
&
&
metadata
UniquePtr
<
JSErrorNotes
>
notes
unsigned
flags
unsigned
errorNumber
va_list
*
args
)
{
CompileError
tempErr
;
CompileError
*
err
=
&
tempErr
;
if
(
cx
-
>
isHelperThreadContext
(
)
&
&
!
cx
-
>
addPendingCompileError
(
&
err
)
)
{
return
false
;
}
err
-
>
notes
=
std
:
:
move
(
notes
)
;
err
-
>
flags
=
flags
;
err
-
>
errorNumber
=
errorNumber
;
err
-
>
filename
=
metadata
.
filename
;
err
-
>
lineno
=
metadata
.
lineNumber
;
err
-
>
column
=
metadata
.
columnNumber
;
err
-
>
isMuted
=
metadata
.
isMuted
;
if
(
UniqueTwoByteChars
lineOfContext
=
std
:
:
move
(
metadata
.
lineOfContext
)
)
{
err
-
>
initOwnedLinebuf
(
lineOfContext
.
release
(
)
metadata
.
lineLength
metadata
.
tokenOffset
)
;
}
if
(
!
ExpandErrorArgumentsVA
(
cx
GetErrorMessage
nullptr
errorNumber
ArgumentsAreLatin1
err
*
args
)
)
{
return
false
;
}
if
(
!
cx
-
>
isHelperThreadContext
(
)
)
{
err
-
>
throwError
(
cx
)
;
}
return
true
;
}
static
void
ReportCompileErrorImpl
(
JSContext
*
cx
js
:
:
ErrorMetadata
&
&
metadata
js
:
:
UniquePtr
<
JSErrorNotes
>
notes
unsigned
flags
unsigned
errorNumber
va_list
*
args
js
:
:
ErrorArgumentsType
argumentsType
)
{
js
:
:
CompileError
tempErr
;
js
:
:
CompileError
*
err
=
&
tempErr
;
if
(
cx
-
>
isHelperThreadContext
(
)
&
&
!
cx
-
>
addPendingCompileError
(
&
err
)
)
{
return
;
}
err
-
>
notes
=
std
:
:
move
(
notes
)
;
err
-
>
flags
=
flags
;
err
-
>
errorNumber
=
errorNumber
;
err
-
>
filename
=
metadata
.
filename
;
err
-
>
lineno
=
metadata
.
lineNumber
;
err
-
>
column
=
metadata
.
columnNumber
;
err
-
>
isMuted
=
metadata
.
isMuted
;
if
(
UniqueTwoByteChars
lineOfContext
=
std
:
:
move
(
metadata
.
lineOfContext
)
)
{
err
-
>
initOwnedLinebuf
(
lineOfContext
.
release
(
)
metadata
.
lineLength
metadata
.
tokenOffset
)
;
}
if
(
!
js
:
:
ExpandErrorArgumentsVA
(
cx
js
:
:
GetErrorMessage
nullptr
errorNumber
argumentsType
err
*
args
)
)
{
return
;
}
if
(
!
cx
-
>
isHelperThreadContext
(
)
)
{
err
-
>
throwError
(
cx
)
;
}
}
void
js
:
:
ReportCompileErrorLatin1
(
JSContext
*
cx
ErrorMetadata
&
&
metadata
UniquePtr
<
JSErrorNotes
>
notes
unsigned
flags
unsigned
errorNumber
va_list
*
args
)
{
ReportCompileErrorImpl
(
cx
std
:
:
move
(
metadata
)
std
:
:
move
(
notes
)
flags
errorNumber
args
ArgumentsAreLatin1
)
;
}
void
js
:
:
ReportCompileErrorUTF8
(
JSContext
*
cx
ErrorMetadata
&
&
metadata
UniquePtr
<
JSErrorNotes
>
notes
unsigned
flags
unsigned
errorNumber
va_list
*
args
)
{
ReportCompileErrorImpl
(
cx
std
:
:
move
(
metadata
)
std
:
:
move
(
notes
)
flags
errorNumber
args
ArgumentsAreUTF8
)
;
}
void
js
:
:
ReportErrorToGlobal
(
JSContext
*
cx
Handle
<
GlobalObject
*
>
global
HandleValue
error
)
{
MOZ_ASSERT
(
!
cx
-
>
isExceptionPending
(
)
)
;
#
ifdef
DEBUG
if
(
error
.
isObject
(
)
)
{
AssertSameCompartment
(
global
&
error
.
toObject
(
)
)
;
}
#
endif
js
:
:
ReportExceptionClosure
report
(
error
)
;
PrepareScriptEnvironmentAndInvoke
(
cx
global
report
)
;
}
