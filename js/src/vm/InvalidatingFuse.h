#
ifndef
vm_InvalidatingFuse_h
#
define
vm_InvalidatingFuse_h
#
include
"
gc
/
Barrier
.
h
"
#
include
"
gc
/
SweepingAPI
.
h
"
#
include
"
vm
/
GuardFuse
.
h
"
class
JSScript
;
namespace
js
{
class
InvalidatingFuse
:
public
GuardFuse
{
public
:
virtual
bool
addFuseDependency
(
JSContext
*
cx
Handle
<
JSScript
*
>
script
)
=
0
;
}
;
class
InvalidatingRuntimeFuse
:
public
InvalidatingFuse
{
public
:
virtual
bool
addFuseDependency
(
JSContext
*
cx
Handle
<
JSScript
*
>
script
)
override
;
virtual
void
popFuse
(
JSContext
*
cx
)
override
;
}
;
class
DependentScriptSet
{
public
:
DependentScriptSet
(
JSContext
*
cx
InvalidatingFuse
*
fuse
)
;
InvalidatingFuse
*
associatedFuse
;
bool
addScriptForFuse
(
InvalidatingFuse
*
fuse
Handle
<
JSScript
*
>
script
)
;
void
invalidateForFuse
(
JSContext
*
cx
InvalidatingFuse
*
fuse
)
;
private
:
using
WeakScriptSet
=
GCHashSet
<
WeakHeapPtr
<
JSScript
*
>
StableCellHasher
<
WeakHeapPtr
<
JSScript
*
>
>
js
:
:
SystemAllocPolicy
>
;
js
:
:
WeakCache
<
WeakScriptSet
>
weakScripts
;
}
;
class
DependentScriptGroup
{
Vector
<
DependentScriptSet
1
SystemAllocPolicy
>
dependencies
;
public
:
DependentScriptSet
*
getOrCreateDependentScriptSet
(
JSContext
*
cx
InvalidatingFuse
*
fuse
)
;
DependentScriptSet
*
begin
(
)
{
return
dependencies
.
begin
(
)
;
}
DependentScriptSet
*
end
(
)
{
return
dependencies
.
end
(
)
;
}
}
;
}
#
endif
