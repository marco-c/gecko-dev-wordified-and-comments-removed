#
include
"
vm
/
PlainObject
-
inl
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
jspubtd
.
h
"
#
include
"
gc
/
AllocKind
.
h
"
#
include
"
vm
/
JSContext
.
h
"
#
include
"
vm
/
JSFunction
.
h
"
#
include
"
vm
/
JSObject
.
h
"
#
include
"
vm
/
ObjectGroup
.
h
"
#
include
"
vm
/
TaggedProto
.
h
"
#
include
"
vm
/
TypeInference
.
h
"
#
include
"
vm
/
JSObject
-
inl
.
h
"
#
include
"
vm
/
TypeInference
-
inl
.
h
"
using
JS
:
:
Handle
;
using
JS
:
:
Rooted
;
using
js
:
:
AutoSweepObjectGroup
;
using
js
:
:
CopyInitializerObject
;
using
js
:
:
GenericObject
;
using
js
:
:
GuessObjectGCKind
;
using
js
:
:
NewObjectGCKind
;
using
js
:
:
NewObjectKind
;
using
js
:
:
NewObjectWithGroup
;
using
js
:
:
NewSingletonObjectWithGivenTaggedProtoAndKind
;
using
js
:
:
ObjectGroup
;
using
js
:
:
PlainObject
;
using
js
:
:
SingletonObject
;
using
js
:
:
TaggedProto
;
using
js
:
:
TenuredObject
;
using
js
:
:
TypeNewScript
;
static
PlainObject
*
CreateThisForFunctionWithGroup
(
JSContext
*
cx
Handle
<
ObjectGroup
*
>
group
NewObjectKind
newKind
)
{
TypeNewScript
*
maybeNewScript
;
{
AutoSweepObjectGroup
sweep
(
group
)
;
maybeNewScript
=
group
-
>
newScript
(
sweep
)
;
}
if
(
maybeNewScript
)
{
if
(
maybeNewScript
-
>
analyzed
(
)
)
{
Rooted
<
PlainObject
*
>
templateObject
(
cx
maybeNewScript
-
>
templateObject
(
)
)
;
MOZ_ASSERT
(
templateObject
-
>
group
(
)
=
=
group
)
;
Rooted
<
PlainObject
*
>
res
(
cx
CopyInitializerObject
(
cx
templateObject
newKind
)
)
;
if
(
!
res
)
{
return
nullptr
;
}
if
(
newKind
=
=
SingletonObject
)
{
Rooted
<
TaggedProto
>
proto
(
cx
TaggedProto
(
templateObject
-
>
staticPrototype
(
)
)
)
;
if
(
!
JSObject
:
:
splicePrototype
(
cx
res
proto
)
)
{
return
nullptr
;
}
}
else
{
res
-
>
setGroup
(
group
)
;
}
return
res
;
}
if
(
newKind
=
=
GenericObject
)
{
newKind
=
TenuredObject
;
}
js
:
:
gc
:
:
AllocKind
allocKind
=
GuessObjectGCKind
(
PlainObject
:
:
MAX_FIXED_SLOTS
)
;
PlainObject
*
res
=
NewObjectWithGroup
<
PlainObject
>
(
cx
group
allocKind
newKind
)
;
if
(
!
res
)
{
return
nullptr
;
}
AutoSweepObjectGroup
sweep
(
group
)
;
if
(
newKind
!
=
SingletonObject
&
&
group
-
>
newScript
(
sweep
)
)
{
group
-
>
newScript
(
sweep
)
-
>
registerNewObject
(
res
)
;
}
return
res
;
}
js
:
:
gc
:
:
AllocKind
allocKind
=
NewObjectGCKind
(
&
PlainObject
:
:
class_
)
;
if
(
newKind
=
=
SingletonObject
)
{
Rooted
<
TaggedProto
>
protoRoot
(
cx
group
-
>
proto
(
)
)
;
return
NewSingletonObjectWithGivenTaggedProtoAndKind
<
PlainObject
>
(
cx
protoRoot
allocKind
)
;
}
return
NewObjectWithGroup
<
PlainObject
>
(
cx
group
allocKind
newKind
)
;
}
PlainObject
*
js
:
:
CreateThisForFunctionWithProto
(
JSContext
*
cx
Handle
<
JSFunction
*
>
callee
Handle
<
JSObject
*
>
newTarget
Handle
<
JSObject
*
>
proto
NewObjectKind
newKind
)
{
MOZ_ASSERT
(
!
callee
-
>
constructorNeedsUninitializedThis
(
)
)
;
Rooted
<
PlainObject
*
>
res
(
cx
)
;
mozilla
:
:
Maybe
<
AutoRealm
>
ar
;
if
(
cx
-
>
realm
(
)
!
=
callee
-
>
realm
(
)
)
{
MOZ_ASSERT
(
cx
-
>
compartment
(
)
=
=
callee
-
>
compartment
(
)
)
;
ar
.
emplace
(
cx
callee
)
;
}
if
(
proto
)
{
Rooted
<
ObjectGroup
*
>
group
(
cx
ObjectGroup
:
:
defaultNewGroup
(
cx
&
PlainObject
:
:
class_
TaggedProto
(
proto
)
newTarget
)
)
;
if
(
!
group
)
{
return
nullptr
;
}
{
AutoSweepObjectGroup
sweep
(
group
)
;
if
(
group
-
>
newScript
(
sweep
)
&
&
!
group
-
>
newScript
(
sweep
)
-
>
analyzed
(
)
)
{
bool
regenerate
;
if
(
!
group
-
>
newScript
(
sweep
)
-
>
maybeAnalyze
(
cx
group
&
regenerate
)
)
{
return
nullptr
;
}
if
(
regenerate
)
{
group
=
ObjectGroup
:
:
defaultNewGroup
(
cx
&
PlainObject
:
:
class_
TaggedProto
(
proto
)
newTarget
)
;
AutoSweepObjectGroup
sweepNewGroup
(
group
)
;
MOZ_ASSERT
(
group
)
;
MOZ_ASSERT
(
group
-
>
newScript
(
sweepNewGroup
)
)
;
}
}
}
res
=
CreateThisForFunctionWithGroup
(
cx
group
newKind
)
;
}
else
{
res
=
NewBuiltinClassInstanceWithKind
<
PlainObject
>
(
cx
newKind
)
;
}
if
(
res
)
{
MOZ_ASSERT
(
res
-
>
nonCCWRealm
(
)
=
=
callee
-
>
realm
(
)
)
;
JSScript
*
script
=
JSFunction
:
:
getOrCreateScript
(
cx
callee
)
;
if
(
!
script
)
{
return
nullptr
;
}
jit
:
:
JitScript
:
:
MonitorThisType
(
cx
script
TypeSet
:
:
ObjectType
(
res
)
)
;
}
return
res
;
}
PlainObject
*
js
:
:
CreateThisForFunction
(
JSContext
*
cx
Handle
<
JSFunction
*
>
callee
Handle
<
JSObject
*
>
newTarget
NewObjectKind
newKind
)
{
MOZ_ASSERT
(
!
callee
-
>
constructorNeedsUninitializedThis
(
)
)
;
Rooted
<
JSObject
*
>
proto
(
cx
)
;
if
(
!
GetPrototypeFromConstructor
(
cx
newTarget
JSProto_Object
&
proto
)
)
{
return
nullptr
;
}
PlainObject
*
obj
=
CreateThisForFunctionWithProto
(
cx
callee
newTarget
proto
newKind
)
;
if
(
obj
&
&
newKind
=
=
SingletonObject
)
{
Rooted
<
PlainObject
*
>
nobj
(
cx
obj
)
;
NativeObject
:
:
clear
(
cx
nobj
)
;
JSScript
*
calleeScript
=
callee
-
>
nonLazyScript
(
)
;
jit
:
:
JitScript
:
:
MonitorThisType
(
cx
calleeScript
TypeSet
:
:
ObjectType
(
nobj
)
)
;
return
nobj
;
}
return
obj
;
}
