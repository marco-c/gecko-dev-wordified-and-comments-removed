#
include
"
vm
/
ShapeZone
.
h
"
#
include
"
gc
/
Marking
-
inl
.
h
"
#
include
"
vm
/
JSContext
-
inl
.
h
"
using
namespace
js
;
#
ifdef
JSGC_HASH_TABLE_CHECKS
void
ShapeZone
:
:
checkTablesAfterMovingGC
(
)
{
for
(
auto
r
=
initialPropMaps
.
all
(
)
;
!
r
.
empty
(
)
;
r
.
popFront
(
)
)
{
SharedPropMap
*
map
=
r
.
front
(
)
.
unbarrieredGet
(
)
;
CheckGCThingAfterMovingGC
(
map
)
;
InitialPropMapHasher
:
:
Lookup
lookup
(
map
-
>
getKey
(
0
)
map
-
>
getPropertyInfo
(
0
)
)
;
InitialPropMapSet
:
:
Ptr
ptr
=
initialPropMaps
.
lookup
(
lookup
)
;
MOZ_RELEASE_ASSERT
(
ptr
.
found
(
)
&
&
&
*
ptr
=
=
&
r
.
front
(
)
)
;
}
for
(
auto
r
=
baseShapes
.
all
(
)
;
!
r
.
empty
(
)
;
r
.
popFront
(
)
)
{
BaseShape
*
base
=
r
.
front
(
)
.
unbarrieredGet
(
)
;
CheckGCThingAfterMovingGC
(
base
)
;
BaseShapeHasher
:
:
Lookup
lookup
(
base
-
>
clasp
(
)
base
-
>
realm
(
)
base
-
>
proto
(
)
)
;
BaseShapeSet
:
:
Ptr
ptr
=
baseShapes
.
lookup
(
lookup
)
;
MOZ_RELEASE_ASSERT
(
ptr
.
found
(
)
&
&
&
*
ptr
=
=
&
r
.
front
(
)
)
;
}
for
(
auto
r
=
initialShapes
.
all
(
)
;
!
r
.
empty
(
)
;
r
.
popFront
(
)
)
{
Shape
*
shape
=
r
.
front
(
)
.
unbarrieredGet
(
)
;
CheckGCThingAfterMovingGC
(
shape
)
;
using
Lookup
=
InitialShapeHasher
:
:
Lookup
;
Lookup
lookup
(
shape
-
>
getObjectClass
(
)
shape
-
>
realm
(
)
shape
-
>
proto
(
)
shape
-
>
numFixedSlots
(
)
shape
-
>
objectFlags
(
)
)
;
InitialShapeSet
:
:
Ptr
ptr
=
initialShapes
.
lookup
(
lookup
)
;
MOZ_RELEASE_ASSERT
(
ptr
.
found
(
)
&
&
&
*
ptr
=
=
&
r
.
front
(
)
)
;
}
}
#
endif
ShapeZone
:
:
ShapeZone
(
Zone
*
zone
)
:
propertyTree
(
zone
)
baseShapes
(
zone
)
initialPropMaps
(
zone
)
initialShapes
(
zone
)
{
}
void
ShapeZone
:
:
clearTables
(
)
{
baseShapes
.
clear
(
)
;
initialPropMaps
.
clear
(
)
;
initialShapes
.
clear
(
)
;
}
void
ShapeZone
:
:
addSizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
size_t
*
initialPropMapTable
size_t
*
shapeTables
)
{
*
shapeTables
+
=
baseShapes
.
sizeOfExcludingThis
(
mallocSizeOf
)
;
*
initialPropMapTable
+
=
initialPropMaps
.
sizeOfExcludingThis
(
mallocSizeOf
)
;
*
shapeTables
+
=
initialShapes
.
sizeOfExcludingThis
(
mallocSizeOf
)
;
}
