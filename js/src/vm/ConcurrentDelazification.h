#
ifndef
vm_ConcurrentDelazification_h
#
define
vm_ConcurrentDelazification_h
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
<
stddef
.
h
>
#
include
<
utility
>
#
include
"
frontend
/
CompilationStencil
.
h
"
#
include
"
frontend
/
ScriptIndex
.
h
"
#
include
"
js
/
AllocPolicy
.
h
"
#
include
"
js
/
CompileOptions
.
h
"
#
include
"
js
/
experimental
/
JSStencil
.
h
"
#
include
"
js
/
UniquePtr
.
h
"
#
include
"
js
/
Vector
.
h
"
namespace
js
{
class
FrontendContext
;
struct
DelazifyStrategy
{
using
ScriptIndex
=
frontend
:
:
ScriptIndex
;
using
InitialStencilAndDelazifications
=
frontend
:
:
InitialStencilAndDelazifications
;
virtual
~
DelazifyStrategy
(
)
=
default
;
virtual
bool
done
(
)
const
=
0
;
virtual
ScriptIndex
next
(
)
=
0
;
virtual
void
clear
(
)
=
0
;
[
[
nodiscard
]
]
virtual
bool
insert
(
ScriptIndex
index
frontend
:
:
ScriptStencilRef
&
ref
)
=
0
;
[
[
nodiscard
]
]
bool
add
(
FrontendContext
*
fc
const
InitialStencilAndDelazifications
&
stencils
const
frontend
:
:
CompilationStencil
&
stencil
ScriptIndex
index
)
;
}
;
struct
DepthFirstDelazification
final
:
public
DelazifyStrategy
{
Vector
<
ScriptIndex
0
SystemAllocPolicy
>
stack
;
bool
done
(
)
const
override
{
return
stack
.
empty
(
)
;
}
ScriptIndex
next
(
)
override
{
return
stack
.
popCopy
(
)
;
}
void
clear
(
)
override
{
return
stack
.
clear
(
)
;
}
bool
insert
(
ScriptIndex
index
frontend
:
:
ScriptStencilRef
&
)
override
{
return
stack
.
append
(
index
)
;
}
}
;
struct
LargeFirstDelazification
final
:
public
DelazifyStrategy
{
using
SourceSize
=
uint32_t
;
Vector
<
std
:
:
pair
<
SourceSize
ScriptIndex
>
0
SystemAllocPolicy
>
heap
;
bool
done
(
)
const
override
{
return
heap
.
empty
(
)
;
}
ScriptIndex
next
(
)
override
;
void
clear
(
)
override
{
return
heap
.
clear
(
)
;
}
bool
insert
(
ScriptIndex
frontend
:
:
ScriptStencilRef
&
)
override
;
}
;
class
DelazificationContext
{
const
JS
:
:
PrefableCompileOptions
initialPrefableOptions_
;
UniquePtr
<
DelazifyStrategy
>
strategy_
;
frontend
:
:
CompilationStencilMerger
merger_
;
RefPtr
<
frontend
:
:
InitialStencilAndDelazifications
>
stencils_
;
FrontendContext
fc_
;
size_t
stackQuota_
;
bool
isInterrupted_
=
false
;
public
:
explicit
DelazificationContext
(
const
JS
:
:
PrefableCompileOptions
&
initialPrefableOptions
size_t
stackQuota
)
:
initialPrefableOptions_
(
initialPrefableOptions
)
stackQuota_
(
stackQuota
)
{
}
bool
init
(
const
JS
:
:
ReadOnlyCompileOptions
&
options
frontend
:
:
InitialStencilAndDelazifications
*
stencils
)
;
bool
delazify
(
)
;
bool
isInterrupted
(
)
const
{
return
isInterrupted_
;
}
void
interrupt
(
)
{
isInterrupted_
=
true
;
}
bool
done
(
)
const
;
size_t
sizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
mallocSizeOf
)
const
;
}
;
}
#
endif
