#
include
"
js
/
ProfilingStack
.
h
"
#
include
"
mozilla
/
IntegerRange
.
h
"
#
include
"
mozilla
/
MathAlgorithms
.
h
"
#
include
<
algorithm
>
using
namespace
js
;
ProfilingStack
:
:
~
ProfilingStack
(
)
{
MOZ_RELEASE_ASSERT
(
stackPointer
=
=
0
)
;
delete
[
]
frames
;
}
void
ProfilingStack
:
:
ensureCapacitySlow
(
)
{
MOZ_ASSERT
(
stackPointer
>
=
capacity
)
;
const
uint32_t
kInitialCapacity
=
4096
/
sizeof
(
ProfilingStackFrame
)
;
uint32_t
sp
=
stackPointer
;
uint32_t
newCapacity
;
if
(
!
capacity
)
{
newCapacity
=
kInitialCapacity
;
}
else
{
size_t
memoryGoal
=
mozilla
:
:
RoundUpPow2
(
capacity
*
2
*
sizeof
(
ProfilingStackFrame
)
)
;
newCapacity
=
memoryGoal
/
sizeof
(
ProfilingStackFrame
)
;
}
newCapacity
=
std
:
:
max
(
sp
+
1
newCapacity
)
;
auto
*
newFrames
=
new
js
:
:
ProfilingStackFrame
[
newCapacity
]
;
for
(
auto
i
:
mozilla
:
:
IntegerRange
(
capacity
)
)
{
newFrames
[
i
]
=
frames
[
i
]
;
}
js
:
:
ProfilingStackFrame
*
oldFrames
=
frames
;
frames
=
newFrames
;
capacity
=
newCapacity
;
delete
[
]
oldFrames
;
}
