#
include
"
vm
/
TaggedProto
.
h
"
#
include
"
jsfun
.
h
"
#
include
"
jsobj
.
h
"
#
include
"
gc
/
Barrier
.
h
"
#
include
"
gc
/
Zone
.
h
"
#
include
"
js
/
HashTable
.
h
"
namespace
js
{
void
InternalGCMethods
<
TaggedProto
>
:
:
preBarrier
(
TaggedProto
&
proto
)
{
InternalGCMethods
<
JSObject
*
>
:
:
preBarrier
(
proto
.
toObjectOrNull
(
)
)
;
}
void
InternalGCMethods
<
TaggedProto
>
:
:
postBarrier
(
TaggedProto
*
vp
TaggedProto
prev
TaggedProto
next
)
{
JSObject
*
prevObj
=
prev
.
isObject
(
)
?
prev
.
toObject
(
)
:
nullptr
;
JSObject
*
nextObj
=
next
.
isObject
(
)
?
next
.
toObject
(
)
:
nullptr
;
InternalGCMethods
<
JSObject
*
>
:
:
postBarrier
(
reinterpret_cast
<
JSObject
*
*
>
(
vp
)
prevObj
nextObj
)
;
}
void
InternalGCMethods
<
TaggedProto
>
:
:
readBarrier
(
const
TaggedProto
&
proto
)
{
InternalGCMethods
<
JSObject
*
>
:
:
readBarrier
(
proto
.
toObjectOrNull
(
)
)
;
}
}
js
:
:
HashNumber
js
:
:
TaggedProto
:
:
hashCode
(
)
const
{
uint64_t
uid
=
uniqueId
(
)
;
return
js
:
:
HashNumber
(
uid
>
>
32
)
^
js
:
:
HashNumber
(
uid
&
0xFFFFFFFF
)
;
}
uint64_t
js
:
:
TaggedProto
:
:
uniqueId
(
)
const
{
if
(
isLazy
(
)
)
return
uint64_t
(
1
)
;
JSObject
*
obj
=
toObjectOrNull
(
)
;
if
(
!
obj
)
return
uint64_t
(
0
)
;
AutoEnterOOMUnsafeRegion
oomUnsafe
;
uint64_t
uid
;
if
(
!
obj
-
>
zone
(
)
-
>
getUniqueId
(
obj
&
uid
)
)
oomUnsafe
.
crash
(
"
failed
to
get
unique
id
for
TaggedProto
"
)
;
return
uid
;
}
