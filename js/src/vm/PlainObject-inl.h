#
ifndef
vm_PlainObject_inl_h
#
define
vm_PlainObject_inl_h
#
include
"
vm
/
PlainObject
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
gc
/
Allocator
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
js
/
Value
.
h
"
#
include
"
vm
/
JSFunction
.
h
"
#
include
"
vm
/
JSObject
.
h
"
#
include
"
vm
/
NativeObject
.
h
"
#
include
"
vm
/
Shape
.
h
"
#
include
"
gc
/
ObjectKind
-
inl
.
h
"
#
include
"
vm
/
JSObject
-
inl
.
h
"
#
include
"
vm
/
NativeObject
-
inl
.
h
"
inline
JS
:
:
Result
<
js
:
:
PlainObject
*
JS
:
:
OOM
>
js
:
:
PlainObject
:
:
createWithTemplate
(
JSContext
*
cx
JS
:
:
Handle
<
PlainObject
*
>
templateObject
)
{
JS
:
:
Rooted
<
Shape
*
>
shape
(
cx
templateObject
-
>
lastProperty
(
)
)
;
MOZ_ASSERT
(
shape
-
>
getObjectClass
(
)
=
=
&
PlainObject
:
:
class_
)
;
gc
:
:
InitialHeap
heap
=
GetInitialHeap
(
GenericObject
&
PlainObject
:
:
class_
)
;
gc
:
:
AllocKind
kind
=
gc
:
:
GetGCObjectKind
(
shape
-
>
numFixedSlots
(
)
)
;
MOZ_ASSERT
(
gc
:
:
CanChangeToBackgroundAllocKind
(
kind
shape
-
>
getObjectClass
(
)
)
)
;
kind
=
gc
:
:
ForegroundToBackgroundAllocKind
(
kind
)
;
return
NativeObject
:
:
create
(
cx
kind
heap
shape
)
.
map
(
[
]
(
NativeObject
*
obj
)
{
return
&
obj
-
>
as
<
PlainObject
>
(
)
;
}
)
;
}
inline
js
:
:
gc
:
:
AllocKind
js
:
:
PlainObject
:
:
allocKindForTenure
(
)
const
{
gc
:
:
AllocKind
kind
=
gc
:
:
GetGCObjectFixedSlotsKind
(
numFixedSlots
(
)
)
;
MOZ_ASSERT
(
!
gc
:
:
IsBackgroundFinalized
(
kind
)
)
;
MOZ_ASSERT
(
gc
:
:
CanChangeToBackgroundAllocKind
(
kind
getClass
(
)
)
)
;
return
gc
:
:
ForegroundToBackgroundAllocKind
(
kind
)
;
}
namespace
js
{
static
inline
PlainObject
*
CopyTemplateObject
(
JSContext
*
cx
JS
:
:
Handle
<
PlainObject
*
>
baseobj
NewObjectKind
newKind
=
GenericObject
)
{
MOZ_ASSERT
(
!
baseobj
-
>
inDictionaryMode
(
)
)
;
gc
:
:
AllocKind
allocKind
=
gc
:
:
GetGCObjectFixedSlotsKind
(
baseobj
-
>
numFixedSlots
(
)
)
;
allocKind
=
gc
:
:
ForegroundToBackgroundAllocKind
(
allocKind
)
;
MOZ_ASSERT_IF
(
baseobj
-
>
isTenured
(
)
allocKind
=
=
baseobj
-
>
asTenured
(
)
.
getAllocKind
(
)
)
;
RootedObject
proto
(
cx
baseobj
-
>
staticPrototype
(
)
)
;
JS
:
:
Rooted
<
PlainObject
*
>
obj
(
cx
NewObjectWithGivenProtoAndKinds
<
PlainObject
>
(
cx
proto
allocKind
newKind
)
)
;
if
(
!
obj
)
{
return
nullptr
;
}
if
(
!
obj
-
>
setLastProperty
(
cx
baseobj
-
>
lastProperty
(
)
)
)
{
return
nullptr
;
}
return
obj
;
}
static
MOZ_ALWAYS_INLINE
bool
CreateThis
(
JSContext
*
cx
JS
:
:
Handle
<
JSFunction
*
>
callee
JS
:
:
Handle
<
JSObject
*
>
newTarget
NewObjectKind
newKind
JS
:
:
MutableHandle
<
JS
:
:
Value
>
thisv
)
{
if
(
callee
-
>
constructorNeedsUninitializedThis
(
)
)
{
thisv
.
setMagic
(
JS_UNINITIALIZED_LEXICAL
)
;
return
true
;
}
MOZ_ASSERT
(
thisv
.
isMagic
(
JS_IS_CONSTRUCTING
)
)
;
PlainObject
*
obj
=
CreateThisForFunction
(
cx
callee
newTarget
newKind
)
;
if
(
!
obj
)
{
return
false
;
}
MOZ_ASSERT
(
obj
-
>
nonCCWRealm
(
)
=
=
callee
-
>
realm
(
)
)
;
thisv
.
setObject
(
*
obj
)
;
return
true
;
}
}
#
endif
