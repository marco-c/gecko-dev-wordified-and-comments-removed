#
ifndef
vm_PlainObject_inl_h
#
define
vm_PlainObject_inl_h
#
include
"
vm
/
PlainObject
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
gc
/
AllocKind
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
js
/
Value
.
h
"
#
include
"
vm
/
JSFunction
.
h
"
#
include
"
vm
/
JSObject
.
h
"
#
include
"
vm
/
NativeObject
.
h
"
#
include
"
vm
/
Shape
.
h
"
#
include
"
gc
/
ObjectKind
-
inl
.
h
"
#
include
"
vm
/
JSObject
-
inl
.
h
"
#
include
"
vm
/
NativeObject
-
inl
.
h
"
inline
js
:
:
PlainObject
*
js
:
:
PlainObject
:
:
createWithShape
(
JSContext
*
cx
JS
:
:
Handle
<
SharedShape
*
>
shape
gc
:
:
AllocKind
kind
NewObjectKind
newKind
)
{
MOZ_ASSERT
(
shape
-
>
getObjectClass
(
)
=
=
&
PlainObject
:
:
class_
)
;
gc
:
:
InitialHeap
heap
=
GetInitialHeap
(
newKind
&
PlainObject
:
:
class_
)
;
MOZ_ASSERT
(
gc
:
:
CanChangeToBackgroundAllocKind
(
kind
&
PlainObject
:
:
class_
)
)
;
kind
=
gc
:
:
ForegroundToBackgroundAllocKind
(
kind
)
;
NativeObject
*
obj
=
NativeObject
:
:
create
(
cx
kind
heap
shape
)
;
if
(
!
obj
)
{
return
nullptr
;
}
return
&
obj
-
>
as
<
PlainObject
>
(
)
;
}
inline
js
:
:
PlainObject
*
js
:
:
PlainObject
:
:
createWithShape
(
JSContext
*
cx
JS
:
:
Handle
<
SharedShape
*
>
shape
NewObjectKind
newKind
)
{
gc
:
:
AllocKind
kind
=
gc
:
:
GetGCObjectKind
(
shape
-
>
numFixedSlots
(
)
)
;
return
createWithShape
(
cx
shape
kind
newKind
)
;
}
inline
js
:
:
PlainObject
*
js
:
:
PlainObject
:
:
createWithTemplate
(
JSContext
*
cx
JS
:
:
Handle
<
PlainObject
*
>
templateObject
)
{
JS
:
:
Rooted
<
SharedShape
*
>
shape
(
cx
templateObject
-
>
sharedShape
(
)
)
;
return
createWithShape
(
cx
shape
)
;
}
inline
js
:
:
gc
:
:
AllocKind
js
:
:
PlainObject
:
:
allocKindForTenure
(
)
const
{
gc
:
:
AllocKind
kind
=
gc
:
:
GetGCObjectFixedSlotsKind
(
numFixedSlots
(
)
)
;
MOZ_ASSERT
(
!
gc
:
:
IsBackgroundFinalized
(
kind
)
)
;
MOZ_ASSERT
(
gc
:
:
CanChangeToBackgroundAllocKind
(
kind
getClass
(
)
)
)
;
return
gc
:
:
ForegroundToBackgroundAllocKind
(
kind
)
;
}
namespace
js
{
static
MOZ_ALWAYS_INLINE
bool
CreateThis
(
JSContext
*
cx
JS
:
:
Handle
<
JSFunction
*
>
callee
JS
:
:
Handle
<
JSObject
*
>
newTarget
NewObjectKind
newKind
JS
:
:
MutableHandle
<
JS
:
:
Value
>
thisv
)
{
if
(
callee
-
>
constructorNeedsUninitializedThis
(
)
)
{
thisv
.
setMagic
(
JS_UNINITIALIZED_LEXICAL
)
;
return
true
;
}
MOZ_ASSERT
(
thisv
.
isMagic
(
JS_IS_CONSTRUCTING
)
)
;
Rooted
<
SharedShape
*
>
shape
(
cx
ThisShapeForFunction
(
cx
callee
newTarget
)
)
;
if
(
!
shape
)
{
return
false
;
}
PlainObject
*
obj
=
PlainObject
:
:
createWithShape
(
cx
shape
newKind
)
;
if
(
!
obj
)
{
return
false
;
}
MOZ_ASSERT
(
obj
-
>
nonCCWRealm
(
)
=
=
callee
-
>
realm
(
)
)
;
thisv
.
setObject
(
*
obj
)
;
return
true
;
}
}
#
endif
