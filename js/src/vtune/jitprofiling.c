#
include
"
vtune
/
ittnotify_config
.
h
"
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
#
include
<
windows
.
h
>
#
endif
#
if
ITT_PLATFORM
!
=
ITT_PLATFORM_MAC
&
&
ITT_PLATFORM
!
=
ITT_PLATFORM_FREEBSD
#
include
<
malloc
.
h
>
#
endif
#
include
<
stdlib
.
h
>
#
include
"
vtune
/
jitprofiling
.
h
"
static
const
char
rcsid
[
]
=
"
\
n
(
#
)
Revision
:
523557
\
n
"
;
#
define
DLL_ENVIRONMENT_VAR
"
VS_PROFILER
"
#
ifndef
NEW_DLL_ENVIRONMENT_VAR
#
if
ITT_ARCH
=
=
ITT_ARCH_IA32
#
define
NEW_DLL_ENVIRONMENT_VAR
"
INTEL_JIT_PROFILER32
"
#
else
#
define
NEW_DLL_ENVIRONMENT_VAR
"
INTEL_JIT_PROFILER64
"
#
endif
#
endif
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
#
define
DEFAULT_DLLNAME
"
JitPI
.
dll
"
HINSTANCE
m_libHandle
=
NULL
;
#
elif
ITT_PLATFORM
=
=
ITT_PLATFORM_MAC
#
define
DEFAULT_DLLNAME
"
libJitPI
.
dylib
"
void
*
m_libHandle
=
NULL
;
#
else
#
define
DEFAULT_DLLNAME
"
libJitPI
.
so
"
void
*
m_libHandle
=
NULL
;
#
endif
#
define
ANDROID_JIT_AGENT_PATH
"
/
data
/
intel
/
libittnotify
.
so
"
typedef
unsigned
int
(
JITAPI
*
TPInitialize
)
(
void
)
;
static
TPInitialize
FUNC_Initialize
=
NULL
;
typedef
unsigned
int
(
JITAPI
*
TPNotify
)
(
unsigned
int
void
*
)
;
static
TPNotify
FUNC_NotifyEvent
=
NULL
;
static
iJIT_IsProfilingActiveFlags
executionMode
=
iJIT_NOTHING_RUNNING
;
int
loadiJIT_Funcs
(
void
)
;
static
int
iJIT_DLL_is_missing
=
0
;
ITT_EXTERN_C
int
JITAPI
iJIT_NotifyEvent
(
iJIT_JVM_EVENT
event_type
void
*
EventSpecificData
)
{
int
ReturnValue
=
0
;
if
(
!
FUNC_NotifyEvent
)
{
if
(
iJIT_DLL_is_missing
)
return
0
;
if
(
!
loadiJIT_Funcs
(
)
)
return
0
;
}
if
(
event_type
=
=
iJVM_EVENT_TYPE_METHOD_LOAD_FINISHED
|
|
event_type
=
=
iJVM_EVENT_TYPE_METHOD_UPDATE
)
{
if
(
(
(
piJIT_Method_Load
)
EventSpecificData
)
-
>
method_id
=
=
0
)
return
0
;
}
else
if
(
event_type
=
=
iJVM_EVENT_TYPE_METHOD_LOAD_FINISHED_V2
)
{
if
(
(
(
piJIT_Method_Load_V2
)
EventSpecificData
)
-
>
method_id
=
=
0
)
return
0
;
}
else
if
(
event_type
=
=
iJVM_EVENT_TYPE_METHOD_LOAD_FINISHED_V3
)
{
if
(
(
(
piJIT_Method_Load_V3
)
EventSpecificData
)
-
>
method_id
=
=
0
)
return
0
;
}
else
if
(
event_type
=
=
iJVM_EVENT_TYPE_METHOD_INLINE_LOAD_FINISHED
)
{
if
(
(
(
piJIT_Method_Inline_Load
)
EventSpecificData
)
-
>
method_id
=
=
0
|
|
(
(
piJIT_Method_Inline_Load
)
EventSpecificData
)
-
>
parent_method_id
=
=
0
)
return
0
;
}
ReturnValue
=
(
int
)
FUNC_NotifyEvent
(
event_type
EventSpecificData
)
;
return
ReturnValue
;
}
ITT_EXTERN_C
iJIT_IsProfilingActiveFlags
JITAPI
iJIT_IsProfilingActive
(
)
{
if
(
!
iJIT_DLL_is_missing
)
{
loadiJIT_Funcs
(
)
;
}
return
executionMode
;
}
int
loadiJIT_Funcs
(
)
{
static
int
bDllWasLoaded
=
0
;
char
*
dllName
=
(
char
*
)
rcsid
;
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
DWORD
dNameLength
=
0
;
#
endif
if
(
bDllWasLoaded
)
{
return
1
;
}
iJIT_DLL_is_missing
=
1
;
FUNC_NotifyEvent
=
NULL
;
if
(
m_libHandle
)
{
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
FreeLibrary
(
m_libHandle
)
;
#
else
dlclose
(
m_libHandle
)
;
#
endif
m_libHandle
=
NULL
;
}
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
dNameLength
=
GetEnvironmentVariableA
(
NEW_DLL_ENVIRONMENT_VAR
NULL
0
)
;
if
(
dNameLength
)
{
DWORD
envret
=
0
;
dllName
=
(
char
*
)
malloc
(
sizeof
(
char
)
*
(
dNameLength
+
1
)
)
;
if
(
dllName
!
=
NULL
)
{
envret
=
GetEnvironmentVariableA
(
NEW_DLL_ENVIRONMENT_VAR
dllName
dNameLength
)
;
if
(
envret
)
{
m_libHandle
=
LoadLibraryExA
(
dllName
NULL
LOAD_WITH_ALTERED_SEARCH_PATH
)
;
}
free
(
dllName
)
;
}
}
else
{
dNameLength
=
GetEnvironmentVariableA
(
DLL_ENVIRONMENT_VAR
NULL
0
)
;
if
(
dNameLength
)
{
DWORD
envret
=
0
;
dllName
=
(
char
*
)
malloc
(
sizeof
(
char
)
*
(
dNameLength
+
1
)
)
;
if
(
dllName
!
=
NULL
)
{
envret
=
GetEnvironmentVariableA
(
DLL_ENVIRONMENT_VAR
dllName
dNameLength
)
;
if
(
envret
)
{
m_libHandle
=
LoadLibraryA
(
dllName
)
;
}
free
(
dllName
)
;
}
}
}
#
else
dllName
=
getenv
(
NEW_DLL_ENVIRONMENT_VAR
)
;
if
(
!
dllName
)
dllName
=
getenv
(
DLL_ENVIRONMENT_VAR
)
;
#
if
defined
(
__ANDROID__
)
|
|
defined
(
ANDROID
)
if
(
!
dllName
)
dllName
=
ANDROID_JIT_AGENT_PATH
;
#
endif
if
(
dllName
)
{
if
(
DL_SYMBOLS
)
{
m_libHandle
=
dlopen
(
dllName
RTLD_LAZY
)
;
}
}
#
endif
if
(
!
m_libHandle
)
{
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
m_libHandle
=
LoadLibraryA
(
DEFAULT_DLLNAME
)
;
#
else
if
(
DL_SYMBOLS
)
{
m_libHandle
=
dlopen
(
DEFAULT_DLLNAME
RTLD_LAZY
)
;
}
#
endif
}
if
(
!
m_libHandle
)
{
iJIT_DLL_is_missing
=
1
;
return
0
;
}
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
FUNC_NotifyEvent
=
(
TPNotify
)
GetProcAddress
(
m_libHandle
"
NotifyEvent
"
)
;
#
else
FUNC_NotifyEvent
=
(
TPNotify
)
dlsym
(
m_libHandle
"
NotifyEvent
"
)
;
#
endif
if
(
!
FUNC_NotifyEvent
)
{
FUNC_Initialize
=
NULL
;
return
0
;
}
#
if
ITT_PLATFORM
=
=
ITT_PLATFORM_WIN
FUNC_Initialize
=
(
TPInitialize
)
GetProcAddress
(
m_libHandle
"
Initialize
"
)
;
#
else
FUNC_Initialize
=
(
TPInitialize
)
dlsym
(
m_libHandle
"
Initialize
"
)
;
#
endif
if
(
!
FUNC_Initialize
)
{
FUNC_NotifyEvent
=
NULL
;
return
0
;
}
executionMode
=
(
iJIT_IsProfilingActiveFlags
)
FUNC_Initialize
(
)
;
bDllWasLoaded
=
1
;
iJIT_DLL_is_missing
=
0
;
return
1
;
}
ITT_EXTERN_C
unsigned
int
JITAPI
iJIT_GetNewMethodID
(
)
{
static
unsigned
int
methodID
=
1
;
if
(
methodID
=
=
0
)
return
0
;
return
methodID
+
+
;
}
