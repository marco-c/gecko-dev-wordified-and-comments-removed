const
nurseryCount
=
25000
;
const
tenuredCount
=
300000
;
function
setupPretenureTest
(
)
{
let
jitOptions
=
getJitCompilerOptions
(
)
;
if
(
!
jitOptions
[
'
baseline
.
enable
'
]
|
|
jitOptions
[
'
ion
.
warmup
.
trigger
'
]
<
=
jitOptions
[
'
baseline
.
warmup
.
trigger
'
]
)
{
print
(
"
Unsupported
JIT
options
"
)
;
quit
(
)
;
}
gczeal
(
0
)
;
gcparam
(
"
minNurseryBytes
"
1024
*
1024
)
;
gcparam
(
"
maxNurseryBytes
"
1024
*
1024
)
;
gcparam
(
"
allocationThreshold
"
1024
*
1024
)
;
gcparam
(
"
incrementalGCEnabled
"
false
)
;
let
o
=
{
}
;
gc
(
)
;
}
function
allocateObjects
(
count
longLived
)
{
let
array
=
new
Array
(
nurseryCount
)
;
for
(
let
i
=
0
;
i
<
count
;
i
+
+
)
{
let
x
=
{
x
:
i
}
;
if
(
longLived
)
{
array
[
i
%
nurseryCount
]
=
x
;
}
else
{
array
[
0
]
=
x
;
}
}
return
array
;
}
function
allocateArrays
(
count
longLived
)
{
let
array
=
new
Array
(
nurseryCount
)
;
for
(
let
i
=
0
;
i
<
count
;
i
+
+
)
{
let
x
=
[
i
]
;
if
(
longLived
)
{
array
[
i
%
nurseryCount
]
=
x
;
}
else
{
array
[
0
]
=
x
;
}
}
return
array
;
}
function
gcCounts
(
)
{
return
{
minor
:
gcparam
(
"
minorGCNumber
"
)
major
:
gcparam
(
"
majorGCNumber
"
)
}
;
}
function
runTestAndCountCollections
(
thunk
)
{
let
initialCounts
=
gcCounts
(
)
;
thunk
(
)
;
let
finalCounts
=
gcCounts
(
)
;
return
{
minor
:
finalCounts
.
minor
-
initialCounts
.
minor
major
:
finalCounts
.
major
-
initialCounts
.
major
}
;
}
