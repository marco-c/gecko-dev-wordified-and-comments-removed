function
allocUntilFail
(
)
{
gc
(
)
;
let
initGCNumber
=
gcparam
(
"
gcNumber
"
)
;
let
error
;
try
{
let
a
=
[
]
;
while
(
true
)
{
a
.
push
(
Symbol
(
)
)
;
}
}
catch
(
err
)
{
error
=
err
;
}
let
finalGCNumber
=
gcparam
(
"
gcNumber
"
)
;
gc
(
)
;
assertEq
(
error
"
out
of
memory
"
)
;
return
finalGCNumber
-
initGCNumber
;
}
gczeal
(
0
)
;
gc
(
)
;
let
currentSize
=
gcparam
(
"
gcBytes
"
)
;
gcparam
(
"
maxBytes
"
currentSize
+
16
*
1024
)
;
gcparam
(
"
minLastDitchGCPeriod
"
5
)
;
assertEq
(
gcparam
(
"
minLastDitchGCPeriod
"
)
5
)
;
let
gcCount
=
allocUntilFail
(
)
;
assertEq
(
gcCount
1
)
gcCount
=
allocUntilFail
(
)
;
assertEq
(
gcCount
0
)
sleep
(
6
)
;
gcCount
=
allocUntilFail
(
)
;
assertEq
(
gcCount
1
)
