let
wr
;
{
let
obj
=
{
}
;
wr
=
new
WeakRef
(
obj
)
;
obj
=
null
;
}
gc
(
)
;
assertEq
(
undefined
=
=
wr
.
deref
(
)
false
)
;
var
g
=
newGlobal
(
{
newCompartment
:
true
}
)
;
var
wr2
=
new
g
.
WeakRef
(
{
}
)
;
assertEq
(
undefined
=
=
wr2
.
deref
(
)
false
)
;
let
wr3
=
g
.
eval
(
"
new
WeakRef
(
{
}
)
"
)
;
let
wr4
=
new
WeakRef
(
evalcx
(
'
(
{
}
)
'
newGlobal
(
{
newCompartment
:
true
}
)
)
)
;
let
wr5
=
new
g
.
WeakRef
(
evalcx
(
'
(
{
}
)
'
newGlobal
(
{
newCompartment
:
true
}
)
)
)
;
var
that
=
this
;
(
function
(
)
{
let
wr6
=
new
g
.
WeakRef
(
newGlobal
(
{
newCompartment
:
true
}
)
)
;
let
wr7
=
new
WeakRef
(
wr6
)
;
let
wr8
=
new
WeakRef
(
that
)
;
wr6
=
null
;
wr7
=
null
;
wr8
=
null
;
}
)
(
)
;
gc
(
)
;
let
wr1
;
function
allocObj
(
)
{
return
{
}
;
}
(
function
(
)
{
let
obj
=
allocObj
(
)
;
wr1
=
new
WeakRef
(
obj
)
;
obj
=
null
;
}
)
(
)
;
assertEq
(
undefined
=
=
=
wr1
.
deref
(
)
false
)
;
gc
(
)
;
function
simulateEndOfJob
(
fn
)
{
clearKeptObjects
(
)
;
gc
(
)
;
fn
(
)
;
}
simulateEndOfJob
(
(
)
=
>
{
assertEq
(
undefined
wr1
.
deref
(
)
)
;
}
)
;
