if
(
!
this
.
SharedArrayBuffer
|
|
!
isAsmJSCompilationAvailable
(
)
)
quit
(
0
)
;
function
m1
(
stdlib
ffi
heap
)
{
"
use
asm
"
;
var
i8
=
new
stdlib
.
Int8Array
(
heap
)
;
var
add
=
stdlib
.
Atomics
.
add
;
function
f
(
)
{
add
(
i8
0
1
)
;
return
37
;
}
return
{
f
:
f
}
}
assertEq
(
isAsmJSModule
(
m1
)
true
)
;
var
{
f
}
=
m1
(
this
{
}
new
SharedArrayBuffer
(
65536
)
)
;
assertEq
(
f
(
)
37
)
;
function
m2
(
stdlib
ffi
heap
)
{
"
use
asm
"
;
var
i8
=
new
stdlib
.
SharedInt8Array
(
heap
)
;
var
add
=
stdlib
.
Atomics
.
add
;
function
g
(
)
{
add
(
i8
0
1
)
;
return
42
;
}
return
{
g
:
g
}
}
assertEq
(
isAsmJSModule
(
m2
)
true
)
;
var
{
g
}
=
m2
(
this
{
}
new
SharedArrayBuffer
(
65536
)
)
;
assertEq
(
g
(
)
42
)
;
function
m3
(
stdlib
ffi
heap
)
{
"
use
asm
"
;
var
i8
=
new
stdlib
.
SharedInt8Array
(
heap
)
;
function
h
(
)
{
return
i8
[
0
]
|
0
;
}
return
{
h
:
h
}
}
assertEq
(
isAsmJSModule
(
m3
)
true
)
;
try
{
var
wasThrown
=
false
;
m3
(
this
{
}
new
ArrayBuffer
(
65536
)
)
;
}
catch
(
e
)
{
wasThrown
=
true
;
}
assertEq
(
wasThrown
true
)
;
function
m4
(
stdlib
ffi
heap
)
{
"
use
asm
"
;
var
i8
=
new
stdlib
.
Int8Array
(
heap
)
;
function
i
(
)
{
return
i8
[
0
]
|
0
;
}
return
{
i
:
i
}
}
assertEq
(
isAsmJSModule
(
m4
)
true
)
;
var
{
i
}
=
m4
(
this
{
}
new
SharedArrayBuffer
(
65536
)
)
;
assertEq
(
isAsmJSFunction
(
i
)
false
)
;
