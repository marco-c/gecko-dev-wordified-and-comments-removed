load
(
libdir
+
"
asserts
.
js
"
)
;
function
roundtrip
(
error
)
{
let
opts
=
{
ErrorStackFrames
:
"
allow
"
}
;
return
deserialize
(
serialize
(
error
[
]
opts
)
opts
)
;
}
{
let
error
=
new
Error
(
"
hello
world
"
)
;
let
cloned
=
roundtrip
(
error
)
;
assertDeepEq
(
cloned
error
)
;
assertEq
(
cloned
.
name
"
Error
"
)
;
assertEq
(
cloned
.
message
"
hello
world
"
)
;
assertEq
(
cloned
.
stack
error
.
stack
)
;
}
let
constructors
=
[
Error
EvalError
RangeError
ReferenceError
SyntaxError
TypeError
URIError
]
;
for
(
let
constructor
of
constructors
)
{
let
error
=
new
constructor
(
"
hello
"
)
;
let
cloned
=
roundtrip
(
error
)
;
assertDeepEq
(
cloned
error
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
true
)
;
assertEq
(
cloned
instanceof
constructor
true
)
;
error
=
new
constructor
(
)
;
cloned
=
roundtrip
(
error
)
;
assertDeepEq
(
cloned
error
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
false
)
;
assertEq
(
cloned
instanceof
constructor
true
)
;
error
=
new
constructor
(
"
hello
"
)
;
error
.
name
=
"
MyError
"
;
cloned
=
roundtrip
(
error
)
;
assertEq
(
cloned
.
name
"
Error
"
)
;
assertEq
(
cloned
.
message
"
hello
"
)
;
assertEq
(
cloned
.
stack
error
.
stack
)
;
if
(
constructor
!
=
=
Error
)
{
assertEq
(
cloned
instanceof
constructor
false
)
;
}
error
=
new
constructor
(
"
hello
"
{
cause
:
new
Error
(
"
foobar
"
)
}
)
;
cloned
=
roundtrip
(
error
)
;
assertDeepEq
(
cloned
error
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
true
)
;
assertEq
(
cloned
instanceof
constructor
true
)
;
assertEq
(
cloned
.
stack
error
.
stack
)
;
assertEq
(
cloned
.
stack
=
=
=
undefined
false
)
;
error
=
new
constructor
(
"
hello
"
)
;
error
.
cause
=
new
Error
(
"
foobar
"
)
;
assertDeepEq
(
Object
.
getOwnPropertyDescriptor
(
error
"
cause
"
)
{
value
:
error
.
cause
writable
:
true
enumerable
:
true
configurable
:
true
}
)
;
cloned
=
roundtrip
(
error
)
;
assertDeepEq
(
Object
.
getOwnPropertyDescriptor
(
cloned
"
cause
"
)
{
value
:
cloned
.
cause
writable
:
true
enumerable
:
false
configurable
:
true
}
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
true
)
;
assertEq
(
cloned
instanceof
constructor
true
)
;
assertEq
(
cloned
.
stack
error
.
stack
)
;
assertEq
(
cloned
.
stack
=
=
=
undefined
false
)
;
error
=
new
(
class
MyError
extends
constructor
{
}
)
;
cloned
=
roundtrip
(
error
)
;
assertEq
(
cloned
.
name
constructor
.
name
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
false
)
;
assertEq
(
cloned
.
stack
error
.
stack
)
;
assertEq
(
cloned
instanceof
Error
true
)
;
error
=
evalcx
(
new
{
constructor
.
name
}
(
"
hello
"
)
)
;
cloned
=
roundtrip
(
error
)
;
assertEq
(
cloned
.
name
constructor
.
name
)
;
assertEq
(
cloned
.
message
"
hello
"
)
;
assertEq
(
cloned
.
stack
error
.
stack
)
;
assertEq
(
cloned
instanceof
constructor
true
)
;
}
{
let
error
=
new
Error
(
"
hello
world
"
)
;
error
.
message
=
123
;
let
cloned
=
roundtrip
(
error
)
;
assertEq
(
cloned
.
message
"
123
"
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
true
)
;
error
=
new
Error
(
)
;
Object
.
defineProperty
(
error
'
message
'
{
get
:
(
)
=
>
{
}
}
)
;
cloned
=
roundtrip
(
error
)
;
assertEq
(
cloned
.
message
"
"
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
false
)
;
}
{
let
error
=
new
AggregateError
(
[
{
a
:
1
}
{
b
:
2
}
]
"
hello
"
)
;
let
cloned
=
roundtrip
(
error
)
;
assertDeepEq
(
cloned
error
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
true
)
;
assertEq
(
cloned
instanceof
AggregateError
true
)
;
error
=
new
AggregateError
(
[
{
a
:
1
}
{
b
:
2
}
]
)
;
cloned
=
roundtrip
(
error
)
;
assertDeepEq
(
cloned
error
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
message
'
)
false
)
;
assertEq
(
cloned
instanceof
AggregateError
true
)
;
error
=
new
AggregateError
(
[
{
a
:
1
}
{
b
:
2
}
]
)
;
error
.
name
=
"
MyError
"
;
cloned
=
roundtrip
(
error
)
;
assertEq
(
cloned
.
name
"
Error
"
)
;
assertEq
(
cloned
.
message
"
"
)
;
assertEq
(
cloned
.
stack
error
.
stack
)
;
assertEq
(
cloned
instanceof
AggregateError
false
)
;
assertEq
(
cloned
.
errors
undefined
)
;
assertEq
(
cloned
.
hasOwnProperty
(
'
errors
'
)
false
)
;
}
{
let
error
=
new
Error
(
)
;
let
cloned
=
deserialize
(
serialize
(
error
[
]
{
ErrorStackFrames
:
"
deny
"
}
)
{
ErrorStackFrames
:
"
allow
"
}
)
;
assertEq
(
cloned
.
name
"
Error
"
)
;
assertEq
(
cloned
.
stack
"
"
)
;
cloned
=
deserialize
(
serialize
(
error
)
)
;
assertEq
(
cloned
.
name
"
Error
"
)
;
assertEq
(
cloned
.
stack
"
"
)
;
assertErrorMessage
(
(
)
=
>
{
deserialize
(
serialize
(
error
[
]
{
ErrorStackFrames
:
"
allow
"
}
)
{
ErrorStackFrames
:
"
deny
"
}
)
;
}
InternalError
"
bad
serialized
structured
data
(
disallowed
'
stack
'
field
encountered
for
Error
object
)
"
)
;
cloned
=
roundtrip
(
error
)
;
assertEq
(
cloned
.
stack
.
length
>
0
true
)
;
}
