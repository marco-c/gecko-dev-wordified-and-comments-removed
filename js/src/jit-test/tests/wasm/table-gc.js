load
(
libdir
+
'
wasm
.
js
'
)
;
load
(
libdir
+
'
asserts
.
js
'
)
;
const
Module
=
WebAssembly
.
Module
;
const
Instance
=
WebAssembly
.
Instance
;
const
Table
=
WebAssembly
.
Table
;
const
textToBinary
=
str
=
>
wasmTextToBinary
(
str
'
new
-
format
'
)
;
const
evalText
=
(
str
imports
)
=
>
new
Instance
(
new
Module
(
textToBinary
(
str
)
)
imports
)
;
var
caller
=
(
type
v2i
(
func
(
result
i32
)
)
)
(
func
call
(
param
i
i32
)
(
result
i32
)
(
call_indirect
v2i
(
get_local
i
)
)
)
(
export
"
call
"
call
)
var
callee
=
i
=
>
(
func
f
{
i
}
(
type
v2i
)
(
result
i32
)
(
i32
.
const
{
i
}
)
)
;
resetFinalizeCount
(
)
;
var
i
=
evalText
(
(
module
(
table
(
resizable
2
)
)
(
export
"
tbl
"
table
)
(
elem
(
i32
.
const
0
)
f0
)
{
callee
(
0
)
}
{
caller
}
)
)
;
var
e
=
i
.
exports
;
var
t
=
e
.
tbl
;
var
f
=
t
.
get
(
0
)
;
assertEq
(
f
(
)
e
.
call
(
0
)
)
;
assertErrorMessage
(
(
)
=
>
e
.
call
(
1
)
Error
/
bad
wasm
indirect
call
/
)
;
assertErrorMessage
(
(
)
=
>
e
.
call
(
2
)
Error
/
out
-
of
-
range
/
)
;
assertEq
(
finalizeCount
(
)
0
)
;
i
.
edge
=
makeFinalizeObserver
(
)
;
e
.
edge
=
makeFinalizeObserver
(
)
;
t
.
edge
=
makeFinalizeObserver
(
)
;
f
.
edge
=
makeFinalizeObserver
(
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
0
)
;
f
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
1
)
;
f
=
t
.
get
(
0
)
;
f
.
edge
=
makeFinalizeObserver
(
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
1
)
;
i
.
exports
=
null
;
e
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
2
)
;
t
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
3
)
;
i
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
3
)
;
assertEq
(
f
(
)
0
)
;
f
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
5
)
;
resetFinalizeCount
(
)
;
var
i
=
evalText
(
(
module
(
table
(
resizable
1
)
)
(
export
"
tbl
"
table
)
(
elem
(
i32
.
const
0
)
f0
)
{
callee
(
0
)
}
{
caller
}
)
)
;
var
e
=
i
.
exports
;
var
t
=
e
.
tbl
;
var
f
=
t
.
get
(
0
)
;
i
.
edge
=
makeFinalizeObserver
(
)
;
e
.
edge
=
makeFinalizeObserver
(
)
;
t
.
edge
=
makeFinalizeObserver
(
)
;
f
.
edge
=
makeFinalizeObserver
(
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
0
)
;
i
.
exports
=
null
;
e
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
1
)
;
f
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
2
)
;
i
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
2
)
;
t
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
4
)
;
resetFinalizeCount
(
)
;
var
i
=
evalText
(
(
module
(
table
(
resizable
2
)
)
(
export
"
tbl
"
table
)
{
caller
}
)
)
;
var
e
=
i
.
exports
;
var
t
=
e
.
tbl
;
i
.
edge
=
makeFinalizeObserver
(
)
;
e
.
edge
=
makeFinalizeObserver
(
)
;
t
.
edge
=
makeFinalizeObserver
(
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
0
)
;
i
.
exports
=
null
;
e
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
1
)
;
i
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
1
)
;
t
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
3
)
;
resetFinalizeCount
(
)
;
var
i
=
evalText
(
(
module
(
func
f0
(
result
i32
)
(
i32
.
const
0
)
)
(
export
"
f0
"
f0
)
)
)
;
var
t
=
new
Table
(
{
initial
:
4
element
:
"
anyfunc
"
}
)
;
i
.
edge
=
makeFinalizeObserver
(
)
;
t
.
edge
=
makeFinalizeObserver
(
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
0
)
;
i
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
1
)
;
t
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
2
)
;
resetFinalizeCount
(
)
;
var
i
=
evalText
(
(
module
(
func
f
(
result
i32
)
(
i32
.
const
42
)
)
(
export
"
f
"
f
)
)
)
;
var
f
=
i
.
exports
.
f
;
var
t
=
new
Table
(
{
initial
:
1
element
:
"
anyfunc
"
}
)
;
i
.
edge
=
makeFinalizeObserver
(
)
;
f
.
edge
=
makeFinalizeObserver
(
)
;
t
.
edge
=
makeFinalizeObserver
(
)
;
t
.
set
(
0
f
)
;
assertEq
(
t
.
get
(
0
)
f
)
;
assertEq
(
t
.
get
(
0
)
(
)
42
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
0
)
;
f
=
null
;
i
.
exports
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
1
)
;
assertEq
(
t
.
get
(
0
)
(
)
42
)
;
t
.
get
(
0
)
.
edge
=
makeFinalizeObserver
(
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
2
)
;
i
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
2
)
;
t
.
set
(
0
null
)
;
assertEq
(
t
.
get
(
0
)
null
)
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
2
)
;
t
=
null
;
gc
(
)
;
assertEq
(
finalizeCount
(
)
4
)
;
