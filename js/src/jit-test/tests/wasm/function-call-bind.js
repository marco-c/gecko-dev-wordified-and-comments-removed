function
wrapFunc
(
params
func
)
{
let
funcCallBind
=
Function
.
prototype
.
call
.
bind
(
func
)
;
return
wasmEvalText
(
(
module
(
func
(
import
"
"
"
f
"
)
(
param
{
params
.
join
(
"
"
)
}
)
)
(
func
(
export
"
f
"
)
(
param
{
params
.
join
(
"
"
)
}
)
{
params
.
map
(
(
x
i
)
=
>
local
.
get
{
i
}
)
.
join
(
"
\
n
"
)
}
call
0
)
)
{
"
"
:
{
"
f
"
:
funcCallBind
}
}
)
.
exports
.
f
;
}
{
let
func
=
function
(
expected
)
{
"
use
strict
"
;
assertEq
(
this
expected
)
;
}
;
let
test
=
wrapFunc
(
[
"
externref
"
"
externref
"
]
func
)
;
for
(
let
val
of
WasmExternrefValues
)
{
test
(
val
val
)
;
}
}
{
let
func
=
function
(
a
b
)
{
"
use
strict
"
;
assertEq
(
this
a
)
;
assertEq
(
a
b
)
;
}
;
let
test
=
wrapFunc
(
[
"
externref
"
"
externref
"
"
externref
"
]
func
)
;
for
(
let
val
of
WasmExternrefValues
)
{
test
(
val
val
val
)
;
}
}
{
let
func
=
function
(
expected
)
{
"
use
strict
"
;
assertEq
(
this
expected
)
;
}
;
let
vals
=
[
0
1
2
3
4
5
]
;
for
(
let
valType
of
[
"
i32
"
"
i64
"
"
f32
"
"
f64
"
]
)
{
let
test
=
wrapFunc
(
[
valType
valType
]
func
)
;
for
(
let
val
of
vals
)
{
if
(
valType
=
=
=
"
i64
"
)
{
val
=
BigInt
(
val
)
;
}
test
(
val
val
)
;
}
}
}
{
let
func
=
function
(
expected
)
{
assertEq
(
this
expected
)
;
}
;
let
test
=
wrapFunc
(
[
"
externref
"
"
externref
"
]
func
)
;
test
(
null
globalThis
)
;
test
(
undefined
globalThis
)
;
}
{
function
func
(
x
)
{
"
use
strict
"
;
assertEq
(
this
1
)
;
assertEq
(
x
2
)
;
}
let
funcCallBind
=
Function
.
prototype
.
call
.
bind
(
func
1
)
;
let
{
test
}
=
wasmEvalText
(
(
module
(
func
(
import
"
"
"
f
"
)
(
param
i32
)
)
(
export
"
test
"
(
func
0
)
)
)
{
"
"
:
{
"
f
"
:
funcCallBind
}
}
)
.
exports
;
test
(
2
)
;
}
{
let
test
=
wrapFunc
(
[
]
function
(
)
{
"
use
strict
"
;
assertEq
(
this
undefined
)
;
}
)
;
test
(
)
;
}
