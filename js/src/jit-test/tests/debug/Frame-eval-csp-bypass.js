var
g
=
newGlobal
(
{
newCompartment
:
true
}
)
;
var
dbg
=
new
Debugger
(
g
)
;
g
.
eval
(
"
function
triggerDebugger
(
)
{
debugger
;
}
"
)
;
g
.
eval
(
"
function
triggerEval
(
)
{
return
eval
(
'
2
+
2
'
)
;
}
"
)
;
g
.
eval
(
"
function
triggerNewFunction
(
)
{
return
new
Function
(
'
return
2
+
2
'
)
(
)
;
}
"
)
;
const
EXPECTED_VALUE
=
4
;
function
assertSuccess
(
expression
options
=
{
}
)
{
let
evaluated
=
false
;
dbg
.
onDebuggerStatement
=
function
(
frame
)
{
assertEq
(
frame
.
eval
(
expression
options
)
.
return
EXPECTED_VALUE
)
;
evaluated
=
true
;
}
;
g
.
triggerDebugger
(
)
;
assertEq
(
evaluated
true
)
;
}
function
assertThrows
(
expression
options
=
{
}
)
{
let
evaluated
=
false
;
dbg
.
onDebuggerStatement
=
function
(
frame
)
{
assertEq
(
frame
.
eval
(
expression
options
)
.
throw
!
=
=
undefined
true
)
;
evaluated
=
true
;
}
;
g
.
triggerDebugger
(
)
;
assertEq
(
evaluated
true
)
;
}
assertSuccess
(
"
2
+
2
"
)
;
assertSuccess
(
"
2
+
2
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
2
+
2
"
{
bypassCSP
:
true
}
)
;
assertSuccess
(
"
eval
(
'
2
+
2
'
)
"
)
;
assertSuccess
(
"
new
Function
(
'
return
2
+
2
'
)
(
)
"
)
;
assertSuccess
(
"
triggerEval
(
)
"
)
;
assertSuccess
(
"
triggerNewFunction
(
)
"
)
;
assertSuccess
(
"
eval
(
'
2
+
2
'
)
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
new
Function
(
'
return
2
+
2
'
)
(
)
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
triggerEval
(
)
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
triggerNewFunction
(
)
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
eval
(
'
2
+
2
'
)
"
{
bypassCSP
:
true
}
)
;
assertSuccess
(
"
new
Function
(
'
return
2
+
2
'
)
(
)
"
{
bypassCSP
:
true
}
)
;
assertSuccess
(
"
triggerEval
(
)
"
{
bypassCSP
:
true
}
)
;
assertSuccess
(
"
triggerNewFunction
(
)
"
{
bypassCSP
:
true
}
)
;
setCSPEnabled
(
true
)
;
assertSuccess
(
"
2
+
2
"
)
;
assertSuccess
(
"
2
+
2
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
2
+
2
"
{
bypassCSP
:
true
}
)
;
assertThrows
(
"
eval
(
'
2
+
2
'
)
"
)
;
assertThrows
(
"
new
Function
(
'
return
2
+
2
'
)
(
)
"
)
;
assertThrows
(
"
triggerEval
(
)
"
)
;
assertThrows
(
"
triggerNewFunction
(
)
"
)
;
assertThrows
(
"
eval
(
'
2
+
2
'
)
"
{
bypassCSP
:
false
}
)
;
assertThrows
(
"
new
Function
(
'
return
2
+
2
'
)
(
)
"
{
bypassCSP
:
false
}
)
;
assertThrows
(
"
triggerEval
(
)
"
{
bypassCSP
:
false
}
)
;
assertThrows
(
"
triggerNewFunction
(
)
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
eval
(
'
2
+
2
'
)
"
{
bypassCSP
:
true
}
)
;
assertSuccess
(
"
new
Function
(
'
return
2
+
2
'
)
(
)
"
{
bypassCSP
:
true
}
)
;
assertSuccess
(
"
triggerEval
(
)
"
{
bypassCSP
:
true
}
)
;
assertSuccess
(
"
triggerNewFunction
(
)
"
{
bypassCSP
:
true
}
)
;
dbg
.
onDebuggerStatement
=
function
(
frame
)
{
frame
.
eval
(
"
globalThis
.
fnWithBypass
=
(
)
=
>
eval
(
'
2
+
2
'
)
"
{
bypassCSP
:
true
}
)
;
frame
.
eval
(
"
globalThis
.
fnWithoutBypass
=
(
)
=
>
eval
(
'
2
+
2
'
)
"
{
bypassCSP
:
false
}
)
;
}
;
g
.
triggerDebugger
(
)
;
assertThrows
(
"
globalThis
.
fnWithBypass
(
)
"
)
;
assertThrows
(
"
globalThis
.
fnWithBypass
(
)
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
globalThis
.
fnWithBypass
(
)
"
{
bypassCSP
:
true
}
)
;
assertThrows
(
"
globalThis
.
fnWithoutBypass
(
)
"
)
;
assertThrows
(
"
globalThis
.
fnWithoutBypass
(
)
"
{
bypassCSP
:
false
}
)
;
assertSuccess
(
"
globalThis
.
fnWithoutBypass
(
)
"
{
bypassCSP
:
true
}
)
;
const
asyncEvalExpression
=
(
async
function
(
)
{
try
{
globalThis
.
evalBeforeAwaitSuccess
=
false
;
globalThis
.
evalAfterAwaitSuccess
=
false
;
eval
(
"
1
+
1
"
)
;
globalThis
.
evalBeforeAwaitSuccess
=
true
;
await
1
;
eval
(
"
2
+
2
"
)
;
globalThis
.
evalAfterAwaitSuccess
=
true
;
}
catch
{
}
}
)
(
)
;
dbg
.
onDebuggerStatement
=
function
(
frame
)
{
frame
.
onPop
=
completion
=
>
{
frame
.
eval
(
asyncEvalExpression
{
bypassCSP
:
true
}
)
;
dbg
.
removeDebuggee
(
g
)
;
drainJobQueue
(
)
;
dbg
.
addDebuggee
(
g
)
;
}
}
;
g
.
triggerDebugger
(
)
;
dbg
.
onDebuggerStatement
=
function
(
frame
)
{
assertEq
(
frame
.
eval
(
"
globalThis
.
evalBeforeAwaitSuccess
"
options
)
.
return
true
)
;
assertEq
(
frame
.
eval
(
"
globalThis
.
evalAfterAwaitSuccess
"
options
)
.
return
false
)
;
}
;
g
.
triggerDebugger
(
)
;
dbg
.
onDebuggerStatement
=
function
(
frame
)
{
frame
.
onPop
=
completion
=
>
{
frame
.
eval
(
asyncEvalExpression
{
bypassCSP
:
false
}
)
;
dbg
.
removeDebuggee
(
g
)
;
drainJobQueue
(
)
;
dbg
.
addDebuggee
(
g
)
;
}
}
;
g
.
triggerDebugger
(
)
;
drainJobQueue
(
)
;
dbg
.
onDebuggerStatement
=
function
(
frame
)
{
assertEq
(
frame
.
eval
(
"
globalThis
.
evalBeforeAwaitSuccess
"
options
)
.
return
false
)
;
assertEq
(
frame
.
eval
(
"
globalThis
.
evalAfterAwaitSuccess
"
options
)
.
return
false
)
;
}
;
g
.
triggerDebugger
(
)
;
