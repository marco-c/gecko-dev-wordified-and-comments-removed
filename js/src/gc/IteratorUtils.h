#
ifndef
gc_IteratorUtils_h
#
define
gc_IteratorUtils_h
#
include
"
mozilla
/
Maybe
.
h
"
namespace
js
{
template
<
typename
IteratorA
typename
IteratorB
>
class
NestedIterator
{
using
T
=
decltype
(
std
:
:
declval
<
IteratorB
>
(
)
.
get
(
)
)
;
IteratorA
a
;
mozilla
:
:
Maybe
<
IteratorB
>
b
;
public
:
template
<
typename
.
.
.
Args
>
explicit
NestedIterator
(
Args
&
&
.
.
.
args
)
:
a
(
std
:
:
forward
<
Args
>
(
args
)
.
.
.
)
{
settle
(
)
;
}
bool
done
(
)
const
{
return
b
.
isNothing
(
)
;
}
T
get
(
)
const
{
MOZ_ASSERT
(
!
done
(
)
)
;
return
b
.
ref
(
)
.
get
(
)
;
}
void
next
(
)
{
MOZ_ASSERT
(
!
done
(
)
)
;
b
-
>
next
(
)
;
if
(
b
-
>
done
(
)
)
{
b
.
reset
(
)
;
a
.
next
(
)
;
settle
(
)
;
}
}
operator
T
(
)
const
{
return
get
(
)
;
}
T
operator
-
>
(
)
const
{
return
get
(
)
;
}
private
:
void
settle
(
)
{
MOZ_ASSERT
(
b
.
isNothing
(
)
)
;
while
(
!
a
.
done
(
)
)
{
b
.
emplace
(
a
.
get
(
)
)
;
if
(
!
b
-
>
done
(
)
)
{
break
;
}
b
.
reset
(
)
;
a
.
next
(
)
;
}
}
}
;
}
#
endif
