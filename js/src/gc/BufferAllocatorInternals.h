#
ifndef
gc_BufferAllocatorInternals_h
#
define
gc_BufferAllocatorInternals_h
namespace
js
:
:
gc
{
template
<
size_t
GranularityShift
=
4
>
struct
EncodedSize
{
static
constexpr
size_t
ShiftBits
=
4
;
static
constexpr
size_t
ValueBits
=
4
;
static_assert
(
ShiftBits
+
ValueBits
=
=
8
)
;
static
constexpr
size_t
Granularity
=
Bit
(
GranularityShift
)
;
static
constexpr
size_t
MaxSize
=
BitMask
(
ValueBits
+
1
)
<
<
(
BitMask
(
ShiftBits
)
-
1
+
GranularityShift
)
;
uint8_t
bits
=
0
;
EncodedSize
(
)
=
default
;
explicit
EncodedSize
(
size_t
bytes
)
{
set
(
bytes
)
;
}
void
set
(
size_t
bytes
)
{
MOZ_ASSERT
(
bytes
<
MaxSize
)
;
size_t
i
=
(
bytes
+
BitMask
(
GranularityShift
)
)
>
>
GranularityShift
;
if
(
i
<
Bit
(
ValueBits
)
)
{
bits
=
i
;
return
;
}
MOZ_ASSERT
(
i
<
=
UINT32_MAX
)
;
size_t
topBit
=
31
-
mozilla
:
:
CountLeadingZeroes32
(
i
)
;
MOZ_ASSERT
(
i
&
Bit
(
topBit
)
)
;
size_t
shift
=
topBit
-
ValueBits
;
size_t
value
=
(
i
>
>
shift
)
&
BitMask
(
ValueBits
)
;
bits
=
(
(
shift
+
1
)
<
<
ValueBits
)
|
value
;
if
(
i
&
BitMask
(
shift
)
)
{
bits
+
+
;
}
}
size_t
get
(
)
const
{
size_t
shift
=
shiftPart
(
)
;
size_t
value
=
valuePart
(
)
;
size_t
i
;
if
(
shift
=
=
0
)
{
i
=
value
;
}
else
{
i
=
(
Bit
(
ValueBits
)
|
value
)
<
<
(
shift
-
1
)
;
}
return
i
<
<
GranularityShift
;
}
size_t
valuePart
(
)
const
{
return
bits
&
BitMask
(
ValueBits
)
;
}
size_t
shiftPart
(
)
const
{
return
bits
>
>
ValueBits
;
}
}
;
}
#
endif
