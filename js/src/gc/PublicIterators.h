#
ifndef
gc_PublicIterators_h
#
define
gc_PublicIterators_h
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
gc
/
Zone
.
h
"
#
include
"
vm
/
JSCompartment
.
h
"
namespace
js
{
enum
ZoneSelector
{
WithAtoms
SkipAtoms
}
;
class
ZonesIter
{
gc
:
:
AutoEnterIteration
iterMarker
;
JS
:
:
Zone
*
atomsZone
;
JS
:
:
Zone
*
*
it
;
JS
:
:
Zone
*
*
end
;
public
:
ZonesIter
(
JSRuntime
*
rt
ZoneSelector
selector
)
:
iterMarker
(
&
rt
-
>
gc
)
atomsZone
(
selector
=
=
WithAtoms
?
rt
-
>
gc
.
atomsZone
.
ref
(
)
:
nullptr
)
it
(
rt
-
>
gc
.
zones
(
)
.
begin
(
)
)
end
(
rt
-
>
gc
.
zones
(
)
.
end
(
)
)
{
if
(
!
atomsZone
)
skipHelperThreadZones
(
)
;
}
bool
done
(
)
const
{
return
!
atomsZone
&
&
it
=
=
end
;
}
void
next
(
)
{
MOZ_ASSERT
(
!
done
(
)
)
;
if
(
atomsZone
)
atomsZone
=
nullptr
;
else
it
+
+
;
skipHelperThreadZones
(
)
;
}
void
skipHelperThreadZones
(
)
{
while
(
!
done
(
)
&
&
get
(
)
-
>
usedByHelperThread
(
)
)
it
+
+
;
}
JS
:
:
Zone
*
get
(
)
const
{
MOZ_ASSERT
(
!
done
(
)
)
;
return
atomsZone
?
atomsZone
:
*
it
;
}
operator
JS
:
:
Zone
*
(
)
const
{
return
get
(
)
;
}
JS
:
:
Zone
*
operator
-
>
(
)
const
{
return
get
(
)
;
}
}
;
struct
CompartmentsInZoneIter
{
explicit
CompartmentsInZoneIter
(
JS
:
:
Zone
*
zone
)
:
zone
(
zone
)
{
it
=
zone
-
>
compartments
(
)
.
begin
(
)
;
}
bool
done
(
)
const
{
MOZ_ASSERT
(
it
)
;
return
it
<
zone
-
>
compartments
(
)
.
begin
(
)
|
|
it
>
=
zone
-
>
compartments
(
)
.
end
(
)
;
}
void
next
(
)
{
MOZ_ASSERT
(
!
done
(
)
)
;
it
+
+
;
}
JSCompartment
*
get
(
)
const
{
MOZ_ASSERT
(
it
)
;
return
*
it
;
}
operator
JSCompartment
*
(
)
const
{
return
get
(
)
;
}
JSCompartment
*
operator
-
>
(
)
const
{
return
get
(
)
;
}
private
:
JS
:
:
Zone
*
zone
;
JSCompartment
*
*
it
;
CompartmentsInZoneIter
(
)
:
zone
(
nullptr
)
it
(
nullptr
)
{
}
friend
class
mozilla
:
:
Maybe
<
CompartmentsInZoneIter
>
;
}
;
class
RealmsInCompartmentIter
{
JSCompartment
*
comp
;
JS
:
:
Realm
*
*
it
;
public
:
explicit
RealmsInCompartmentIter
(
JSCompartment
*
comp
)
:
comp
(
comp
)
{
it
=
comp
-
>
realms
(
)
.
begin
(
)
;
}
bool
done
(
)
const
{
MOZ_ASSERT
(
it
)
;
return
it
<
comp
-
>
realms
(
)
.
begin
(
)
|
|
it
>
=
comp
-
>
realms
(
)
.
end
(
)
;
}
void
next
(
)
{
MOZ_ASSERT
(
!
done
(
)
)
;
it
+
+
;
}
JS
:
:
Realm
*
get
(
)
const
{
MOZ_ASSERT
(
!
done
(
)
)
;
return
*
it
;
}
operator
JS
:
:
Realm
*
(
)
const
{
return
get
(
)
;
}
JS
:
:
Realm
*
operator
-
>
(
)
const
{
return
get
(
)
;
}
}
;
class
RealmsInZoneIter
{
CompartmentsInZoneIter
comp
;
mozilla
:
:
Maybe
<
RealmsInCompartmentIter
>
realm
;
public
:
explicit
RealmsInZoneIter
(
JS
:
:
Zone
*
zone
)
:
comp
(
zone
)
{
settleOnCompartment
(
)
;
}
void
settleOnCompartment
(
)
{
if
(
!
comp
.
done
(
)
)
{
realm
.
emplace
(
comp
.
get
(
)
)
;
MOZ_ASSERT
(
!
realm
-
>
done
(
)
"
compartment
must
have
at
least
one
realm
"
)
;
}
}
bool
done
(
)
const
{
MOZ_ASSERT
(
comp
.
done
(
)
=
=
realm
.
isNothing
(
)
)
;
return
comp
.
done
(
)
;
}
void
next
(
)
{
MOZ_ASSERT
(
!
done
(
)
)
;
realm
-
>
next
(
)
;
if
(
realm
-
>
done
(
)
)
{
realm
.
reset
(
)
;
comp
.
next
(
)
;
settleOnCompartment
(
)
;
}
}
JS
:
:
Realm
*
get
(
)
const
{
return
realm
-
>
get
(
)
;
}
operator
JS
:
:
Realm
*
(
)
const
{
return
get
(
)
;
}
JS
:
:
Realm
*
operator
-
>
(
)
const
{
return
get
(
)
;
}
}
;
template
<
class
ZonesIterT
>
class
CompartmentsIterT
{
gc
:
:
AutoEnterIteration
iterMarker
;
ZonesIterT
zone
;
mozilla
:
:
Maybe
<
CompartmentsInZoneIter
>
comp
;
public
:
explicit
CompartmentsIterT
(
JSRuntime
*
rt
)
:
iterMarker
(
&
rt
-
>
gc
)
zone
(
rt
)
{
if
(
zone
.
done
(
)
)
comp
.
emplace
(
)
;
else
comp
.
emplace
(
zone
)
;
}
CompartmentsIterT
(
JSRuntime
*
rt
ZoneSelector
selector
)
:
iterMarker
(
&
rt
-
>
gc
)
zone
(
rt
selector
)
{
if
(
zone
.
done
(
)
)
comp
.
emplace
(
)
;
else
comp
.
emplace
(
zone
)
;
}
bool
done
(
)
const
{
return
zone
.
done
(
)
;
}
void
next
(
)
{
MOZ_ASSERT
(
!
done
(
)
)
;
MOZ_ASSERT
(
!
comp
.
ref
(
)
.
done
(
)
)
;
comp
-
>
next
(
)
;
if
(
comp
-
>
done
(
)
)
{
comp
.
reset
(
)
;
zone
.
next
(
)
;
if
(
!
zone
.
done
(
)
)
comp
.
emplace
(
zone
)
;
}
}
JSCompartment
*
get
(
)
const
{
MOZ_ASSERT
(
!
done
(
)
)
;
return
*
comp
;
}
operator
JSCompartment
*
(
)
const
{
return
get
(
)
;
}
JSCompartment
*
operator
-
>
(
)
const
{
return
get
(
)
;
}
}
;
using
CompartmentsIter
=
CompartmentsIterT
<
ZonesIter
>
;
template
<
class
ZonesIterT
>
class
RealmsIterT
{
gc
:
:
AutoEnterIteration
iterMarker
;
CompartmentsIterT
<
ZonesIterT
>
comp
;
public
:
explicit
RealmsIterT
(
JSRuntime
*
rt
)
:
iterMarker
(
&
rt
-
>
gc
)
comp
(
rt
)
{
}
RealmsIterT
(
JSRuntime
*
rt
ZoneSelector
selector
)
:
iterMarker
(
&
rt
-
>
gc
)
comp
(
rt
selector
)
{
}
bool
done
(
)
const
{
return
comp
.
done
(
)
;
}
void
next
(
)
{
MOZ_ASSERT
(
!
done
(
)
)
;
comp
.
next
(
)
;
}
JS
:
:
Realm
*
get
(
)
const
{
MOZ_ASSERT
(
!
done
(
)
)
;
return
JS
:
:
GetRealmForCompartment
(
comp
.
get
(
)
)
;
}
operator
JS
:
:
Realm
*
(
)
const
{
return
get
(
)
;
}
JS
:
:
Realm
*
operator
-
>
(
)
const
{
return
get
(
)
;
}
}
;
using
RealmsIter
=
RealmsIterT
<
ZonesIter
>
;
}
#
endif
