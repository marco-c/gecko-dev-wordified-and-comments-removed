#
ifndef
gc_ZoneGroup_h
#
define
gc_ZoneGroup_h
#
include
"
jsgc
.
h
"
#
include
"
gc
/
Statistics
.
h
"
#
include
"
vm
/
Caches
.
h
"
#
include
"
vm
/
Stack
.
h
"
namespace
js
{
namespace
jit
{
class
JitZoneGroup
;
}
class
AutoKeepAtoms
;
typedef
Vector
<
JS
:
:
Zone
*
4
SystemAllocPolicy
>
ZoneVector
;
class
ZoneGroup
{
public
:
JSRuntime
*
const
runtime
;
private
:
UnprotectedData
<
CooperatingContext
>
ownerContext_
;
UnprotectedData
<
size_t
>
enterCount
;
UnprotectedData
<
bool
>
useExclusiveLocking
;
public
:
CooperatingContext
&
ownerContext
(
)
{
return
ownerContext_
.
ref
(
)
;
}
void
*
addressOfOwnerContext
(
)
{
return
&
ownerContext_
.
ref
(
)
.
cx
;
}
void
enter
(
JSContext
*
cx
)
;
void
leave
(
)
;
bool
ownedByCurrentThread
(
)
;
private
:
ZoneGroupOrGCTaskData
<
ZoneVector
>
zones_
;
public
:
ZoneVector
&
zones
(
)
{
return
zones_
.
ref
(
)
;
}
private
:
enum
class
HelperThreadUse
:
uint32_t
{
None
Pending
Active
}
;
mozilla
:
:
Atomic
<
HelperThreadUse
>
helperThreadUse
;
public
:
bool
createdForHelperThread
(
)
const
{
return
helperThreadUse
!
=
HelperThreadUse
:
:
None
;
}
bool
usedByHelperThread
(
)
const
{
return
helperThreadUse
=
=
HelperThreadUse
:
:
Active
;
}
void
setCreatedForHelperThread
(
)
{
MOZ_ASSERT
(
helperThreadUse
=
=
HelperThreadUse
:
:
None
)
;
helperThreadUse
=
HelperThreadUse
:
:
Pending
;
}
void
setUsedByHelperThread
(
)
{
MOZ_ASSERT
(
helperThreadUse
=
=
HelperThreadUse
:
:
Pending
)
;
helperThreadUse
=
HelperThreadUse
:
:
Active
;
}
void
clearUsedByHelperThread
(
)
{
MOZ_ASSERT
(
helperThreadUse
!
=
HelperThreadUse
:
:
None
)
;
helperThreadUse
=
HelperThreadUse
:
:
None
;
}
explicit
ZoneGroup
(
JSRuntime
*
runtime
)
;
~
ZoneGroup
(
)
;
bool
init
(
)
;
inline
Nursery
&
nursery
(
)
;
inline
gc
:
:
StoreBuffer
&
storeBuffer
(
)
;
inline
bool
isCollecting
(
)
;
inline
bool
isGCScheduled
(
)
;
void
setUseExclusiveLocking
(
)
{
useExclusiveLocking
=
true
;
}
void
deleteEmptyZone
(
Zone
*
zone
)
;
#
ifdef
DEBUG
private
:
ZoneGroupData
<
uint32_t
>
ionBailAfter_
;
public
:
void
*
addressOfIonBailAfter
(
)
{
return
&
ionBailAfter_
;
}
void
setIonBailAfter
(
uint32_t
after
)
{
ionBailAfter_
=
after
;
}
#
endif
ZoneGroupData
<
jit
:
:
JitZoneGroup
*
>
jitZoneGroup
;
private
:
ZoneGroupData
<
mozilla
:
:
LinkedList
<
js
:
:
Debugger
>
>
debuggerList_
;
public
:
mozilla
:
:
LinkedList
<
js
:
:
Debugger
>
&
debuggerList
(
)
{
return
debuggerList_
.
ref
(
)
;
}
mozilla
:
:
Atomic
<
size_t
>
numFinishedBuilders
;
private
:
typedef
mozilla
:
:
LinkedList
<
js
:
:
jit
:
:
IonBuilder
>
IonBuilderList
;
js
:
:
HelperThreadLockData
<
IonBuilderList
>
ionLazyLinkList_
;
js
:
:
HelperThreadLockData
<
size_t
>
ionLazyLinkListSize_
;
public
:
IonBuilderList
&
ionLazyLinkList
(
)
;
size_t
ionLazyLinkListSize
(
)
{
return
ionLazyLinkListSize_
;
}
void
ionLazyLinkListRemove
(
js
:
:
jit
:
:
IonBuilder
*
builder
)
;
void
ionLazyLinkListAdd
(
js
:
:
jit
:
:
IonBuilder
*
builder
)
;
}
;
}
#
endif
