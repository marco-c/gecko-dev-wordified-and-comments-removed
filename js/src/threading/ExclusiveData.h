#
ifndef
threading_ExclusiveData_h
#
define
threading_ExclusiveData_h
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Move
.
h
"
#
include
"
jslock
.
h
"
namespace
js
{
namespace
detail
{
class
ExclusiveDataBase
{
private
:
mutable
PRLock
*
lock_
;
ExclusiveDataBase
(
const
ExclusiveDataBase
&
)
=
delete
;
ExclusiveDataBase
&
operator
=
(
const
ExclusiveDataBase
&
)
=
delete
;
public
:
ExclusiveDataBase
(
ExclusiveDataBase
&
&
rhs
)
:
lock_
(
rhs
.
lock_
)
{
MOZ_ASSERT
(
&
rhs
!
=
this
"
self
-
move
disallowed
!
"
)
;
rhs
.
lock_
=
nullptr
;
}
~
ExclusiveDataBase
(
)
;
protected
:
explicit
ExclusiveDataBase
(
PRLock
*
lock
)
:
lock_
(
lock
)
{
MOZ_ASSERT
(
lock_
)
;
}
static
mozilla
:
:
Maybe
<
ExclusiveDataBase
>
Create
(
)
;
void
acquire
(
)
const
;
void
release
(
)
const
;
}
;
}
template
<
typename
T
>
class
ExclusiveData
:
private
detail
:
:
ExclusiveDataBase
{
mutable
T
value_
;
ExclusiveData
(
const
ExclusiveData
&
)
=
delete
;
ExclusiveData
&
operator
=
(
const
ExclusiveData
&
)
=
delete
;
template
<
typename
U
>
explicit
ExclusiveData
(
U
&
&
u
ExclusiveDataBase
&
&
base
)
:
ExclusiveDataBase
(
mozilla
:
:
Move
(
base
)
)
value_
(
mozilla
:
:
Forward
<
U
>
(
u
)
)
{
}
public
:
template
<
typename
U
>
static
mozilla
:
:
Maybe
<
ExclusiveData
<
T
>
>
Create
(
U
&
&
u
)
{
auto
base
=
detail
:
:
ExclusiveDataBase
:
:
Create
(
)
;
if
(
base
.
isNothing
(
)
)
return
mozilla
:
:
Nothing
(
)
;
return
mozilla
:
:
Some
(
ExclusiveData
(
mozilla
:
:
Forward
<
U
>
(
u
)
mozilla
:
:
Move
(
*
base
)
)
)
;
}
ExclusiveData
(
ExclusiveData
&
&
rhs
)
:
ExclusiveDataBase
(
mozilla
:
:
Move
(
static_cast
<
ExclusiveDataBase
&
&
>
(
rhs
)
)
)
value_
(
mozilla
:
:
Move
(
rhs
.
value_
)
)
{
MOZ_ASSERT
(
&
rhs
!
=
this
"
self
-
move
disallowed
!
"
)
;
}
ExclusiveData
&
operator
=
(
ExclusiveData
&
&
rhs
)
{
this
-
>
~
ExclusiveData
(
)
;
new
(
this
)
ExclusiveData
(
mozilla
:
:
Move
(
rhs
)
)
;
return
*
this
;
}
class
MOZ_STACK_CLASS
Guard
{
const
ExclusiveData
*
parent_
;
Guard
(
const
Guard
&
)
=
delete
;
Guard
&
operator
=
(
const
Guard
&
)
=
delete
;
public
:
explicit
Guard
(
const
ExclusiveData
&
parent
)
:
parent_
(
&
parent
)
{
parent_
-
>
acquire
(
)
;
}
Guard
(
Guard
&
&
rhs
)
:
parent_
(
rhs
.
parent_
)
{
MOZ_ASSERT
(
&
rhs
!
=
this
"
self
-
move
disallowed
!
"
)
;
rhs
.
parent_
=
nullptr
;
}
Guard
&
operator
=
(
Guard
&
&
rhs
)
{
this
-
>
~
Guard
(
)
;
new
(
this
)
Guard
(
mozilla
:
:
Move
(
rhs
)
)
;
return
*
this
;
}
T
&
get
(
)
const
{
MOZ_ASSERT
(
parent_
)
;
return
parent_
-
>
value_
;
}
operator
T
&
(
)
const
{
return
get
(
)
;
}
T
*
operator
-
>
(
)
const
{
return
&
get
(
)
;
}
~
Guard
(
)
{
if
(
parent_
)
parent_
-
>
release
(
)
;
}
}
;
Guard
lock
(
)
const
{
return
Guard
(
*
this
)
;
}
}
;
}
#
endif
