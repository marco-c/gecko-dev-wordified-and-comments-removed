"
use
strict
"
;
var
ignoreIndirectCalls
=
{
"
mallocSizeOf
"
:
true
"
aMallocSizeOf
"
:
true
"
_malloc_message
"
:
true
"
je_malloc_message
"
:
true
"
chunk_dalloc
"
:
true
"
chunk_alloc
"
:
true
"
__conv
"
:
true
"
__convf
"
:
true
"
prerrortable
.
c
:
callback_newtable
"
:
true
"
mozalloc_oom
.
cpp
:
void
(
*
gAbortHandler
)
(
size_t
)
"
:
true
}
;
function
indirectCallCannotGC
(
fullCaller
fullVariable
)
{
var
caller
=
readable
(
fullCaller
)
;
var
name
=
readable
(
fullVariable
)
;
if
(
name
in
ignoreIndirectCalls
)
return
true
;
if
(
name
=
=
"
mapper
"
&
&
caller
=
=
"
ptio
.
c
:
pt_MapError
"
)
return
true
;
if
(
name
=
=
"
params
"
&
&
caller
=
=
"
PR_ExplodeTime
"
)
return
true
;
if
(
name
=
=
"
op
"
&
&
/
GetWeakmapKeyDelegate
/
.
test
(
caller
)
)
return
true
;
if
(
/
CallDestroyScriptHook
/
.
test
(
caller
)
)
return
true
;
if
(
name
=
=
"
op
"
&
&
caller
.
indexOf
(
"
bool
js
:
:
WeakMap
<
Key
Value
HashPolicy
>
:
:
keyNeedsMark
(
JSObject
*
)
"
)
!
=
-
1
)
{
return
true
;
}
return
false
;
}
var
ignoreClasses
=
{
"
JSStringFinalizer
"
:
true
"
SprintfState
"
:
true
"
SprintfStateStr
"
:
true
"
JSLocaleCallbacks
"
:
true
"
JSC
:
:
ExecutableAllocator
"
:
true
"
PRIOMethods
"
:
true
"
XPCOMFunctions
"
:
true
"
_MD_IOVector
"
:
true
"
malloc_table_t
"
:
true
"
malloc_hook_table_t
"
:
true
}
;
var
ignoreCallees
=
{
"
js
:
:
Class
.
trace
"
:
true
"
js
:
:
Class
.
finalize
"
:
true
"
JSRuntime
.
destroyPrincipals
"
:
true
"
icu_50
:
:
UObject
.
__deleting_dtor
"
:
true
"
mozilla
:
:
CycleCollectedJSRuntime
.
DescribeCustomObjects
"
:
true
"
mozilla
:
:
CycleCollectedJSRuntime
.
NoteCustomGCThingXPCOMChildren
"
:
true
"
PLDHashTableOps
.
hashKey
"
:
true
"
z_stream_s
.
zfree
"
:
true
"
GrGLInterface
.
fCallback
"
:
true
"
std
:
:
strstreambuf
.
_M_alloc_fun
"
:
true
"
std
:
:
strstreambuf
.
_M_free_fun
"
:
true
"
struct
js
:
:
gc
:
:
Callback
<
void
(
*
)
(
JSRuntime
*
void
*
)
>
.
op
"
:
true
}
;
function
fieldCallCannotGC
(
csu
fullfield
)
{
if
(
csu
in
ignoreClasses
)
return
true
;
if
(
fullfield
in
ignoreCallees
)
return
true
;
return
false
;
}
function
ignoreEdgeUse
(
edge
variable
body
)
{
if
(
(
'
Name
'
in
variable
)
&
&
(
variable
.
Name
[
0
]
=
=
'
paramBuffer
'
)
)
{
if
(
body
.
BlockId
.
Kind
=
=
'
Function
'
&
&
body
.
BlockId
.
Variable
.
Name
[
0
]
=
=
'
PrepareAndDispatch
'
)
if
(
edge
.
Kind
=
=
'
Assign
'
&
&
edge
.
Type
.
Kind
=
=
'
Pointer
'
)
if
(
edge
.
Exp
[
0
]
.
Kind
=
=
'
Var
'
&
&
edge
.
Exp
[
1
]
.
Kind
=
=
'
Var
'
)
if
(
edge
.
Exp
[
1
]
.
Variable
.
Kind
=
=
'
Local
'
&
&
edge
.
Exp
[
1
]
.
Variable
.
Name
[
0
]
=
=
'
paramBuffer
'
)
return
true
;
}
if
(
edge
.
Kind
=
=
"
Call
"
)
{
var
callee
=
edge
.
Exp
[
0
]
;
if
(
callee
.
Kind
=
=
"
Var
"
)
{
var
name
=
callee
.
Variable
.
Name
[
0
]
;
if
(
/
~
DebugOnly
/
.
test
(
name
)
)
return
true
;
if
(
/
~
ScopedThreadSafeStringInspector
/
.
test
(
name
)
)
return
true
;
}
}
return
false
;
}
function
ignoreEdgeAddressTaken
(
edge
)
{
if
(
edge
.
Kind
=
=
"
Call
"
)
{
var
callee
=
edge
.
Exp
[
0
]
;
if
(
callee
.
Kind
=
=
"
Var
"
)
{
var
name
=
callee
.
Variable
.
Name
[
0
]
;
if
(
/
js
:
:
Invoke
\
(
/
.
test
(
name
)
)
return
true
;
}
}
return
false
;
}
var
ignoreFunctions
=
{
"
ptio
.
c
:
pt_MapError
"
:
true
"
je_malloc_printf
"
:
true
"
PR_ExplodeTime
"
:
true
"
PR_ErrorInstallTable
"
:
true
"
PR_SetThreadPrivate
"
:
true
"
JSObject
*
js
:
:
GetWeakmapKeyDelegate
(
JSObject
*
)
"
:
true
"
uint8
NS_IsMainThread
(
)
"
:
true
"
void
*
std
:
:
_Locale_impl
:
:
~
_Locale_impl
(
int32
)
"
:
true
"
uint32
nsXPConnect
:
:
Release
(
)
"
:
true
"
NS_LogInit
"
:
true
"
NS_LogTerm
"
:
true
"
NS_LogAddRef
"
:
true
"
NS_LogRelease
"
:
true
"
NS_LogCtor
"
:
true
"
NS_LogDtor
"
:
true
"
NS_LogCOMPtrAddRef
"
:
true
"
NS_LogCOMPtrRelease
"
:
true
"
NS_DebugBreak
"
:
true
"
void
js
:
:
AutoCompartment
:
:
~
AutoCompartment
(
int32
)
"
:
true
"
void
JSAutoCompartment
:
:
~
JSAutoCompartment
(
int32
)
"
:
true
"
void
mozilla
:
:
AutoJSContext
:
:
AutoJSContext
(
mozilla
:
:
detail
:
:
GuardObjectNotifier
*
)
"
:
true
"
void
mozilla
:
:
AutoSafeJSContext
:
:
~
AutoSafeJSContext
(
int32
)
"
:
true
"
void
js
:
:
AutoCompartment
:
:
AutoCompartment
(
js
:
:
ExclusiveContext
*
JSCompartment
*
)
"
:
true
"
nsGlobalNameStruct
*
nsScriptNameSpaceManager
:
:
LookupNavigatorName
(
nsAString_internal
*
)
"
:
true
"
nsGlobalNameStruct
*
nsScriptNameSpaceManager
:
:
LookupName
(
nsAString_internal
*
uint16
*
*
)
"
:
true
"
void
test
:
:
RingbufferDumper
:
:
OnTestPartResult
(
testing
:
:
TestPartResult
*
)
"
:
true
"
float64
JS_GetCurrentEmbedderTime
(
)
"
:
true
"
uint64
js
:
:
TenuringTracer
:
:
moveObjectToTenured
(
JSObject
*
JSObject
*
int32
)
"
:
true
"
uint32
js
:
:
TenuringTracer
:
:
moveObjectToTenured
(
JSObject
*
JSObject
*
int32
)
"
:
true
}
;
function
isProtobuf
(
name
)
{
return
name
.
match
(
/
\
bgoogle
:
:
protobuf
\
b
/
)
|
|
name
.
match
(
/
\
bmozilla
:
:
devtools
:
:
protobuf
\
b
/
)
;
}
function
isHeapSnapshotMockClass
(
name
)
{
return
name
.
match
(
/
\
bMockWriter
\
b
/
)
|
|
name
.
match
(
/
\
bMockDeserializedNode
\
b
/
)
;
}
function
isGTest
(
name
)
{
return
name
.
match
(
/
\
btesting
:
:
/
)
;
}
function
ignoreGCFunction
(
mangled
)
{
assert
(
mangled
in
readableNames
)
;
var
fun
=
readableNames
[
mangled
]
[
0
]
;
if
(
fun
in
ignoreFunctions
)
return
true
;
if
(
isProtobuf
(
fun
)
)
return
true
;
if
(
isHeapSnapshotMockClass
(
fun
)
|
|
isGTest
(
fun
)
)
return
true
;
if
(
fun
.
indexOf
(
"
void
nsCOMPtr
<
T
>
:
:
Assert_NoQueryNeeded
(
)
"
)
>
=
0
)
return
true
;
if
(
fun
.
indexOf
(
"
js
:
:
WeakMap
<
Key
Value
HashPolicy
>
:
:
getDelegate
(
"
)
>
=
0
)
return
true
;
if
(
/
refillFreeList
/
.
test
(
fun
)
&
&
/
\
(
js
:
:
AllowGC
\
)
0u
/
.
test
(
fun
)
)
return
true
;
return
false
;
}
function
stripUCSAndNamespace
(
name
)
{
name
=
name
.
replace
(
/
(
struct
|
class
|
union
|
const
)
/
g
"
"
)
;
name
=
name
.
replace
(
/
(
js
:
:
ctypes
:
:
|
js
:
:
|
JS
:
:
|
mozilla
:
:
dom
:
:
|
mozilla
:
:
)
/
g
"
"
)
;
return
name
;
}
function
isRootedGCTypeName
(
name
)
{
return
(
name
=
=
"
JSAddonId
"
)
;
}
function
isRootedGCPointerTypeName
(
name
)
{
name
=
stripUCSAndNamespace
(
name
)
;
if
(
name
.
startsWith
(
'
MaybeRooted
<
'
)
)
return
/
\
(
js
:
:
AllowGC
\
)
1u
>
:
:
RootType
/
.
test
(
name
)
;
if
(
name
=
=
"
ErrorResult
"
|
|
name
=
=
"
JSErrorResult
"
|
|
name
=
=
"
WrappableJSErrorResult
"
|
|
name
=
=
"
frontend
:
:
TokenStream
"
|
|
name
=
=
"
frontend
:
:
TokenStream
:
:
Position
"
|
|
name
=
=
"
ModuleValidator
"
)
{
return
true
;
}
return
name
.
startsWith
(
'
Rooted
'
)
|
|
name
.
startsWith
(
'
PersistentRooted
'
)
;
}
function
isRootedTypeName
(
name
)
{
return
isRootedGCTypeName
(
name
)
|
|
isRootedGCPointerTypeName
(
name
)
;
}
function
isUnsafeStorage
(
typeName
)
{
typeName
=
stripUCSAndNamespace
(
typeName
)
;
return
typeName
.
startsWith
(
'
UniquePtr
<
'
)
;
}
function
isSuppressConstructor
(
varName
)
{
return
[
"
AutoSuppressGC
"
"
AutoAssertGCCallback
"
"
AutoEnterAnalysis
"
"
AutoSuppressGCAnalysis
"
"
AutoIgnoreRootingHazards
"
]
.
indexOf
(
varName
[
1
]
)
!
=
-
1
;
}
function
isOverridableField
(
initialCSU
csu
field
)
{
if
(
csu
!
=
'
nsISupports
'
)
return
false
;
if
(
field
=
=
'
GetCurrentJSContext
'
)
return
false
;
if
(
field
=
=
'
IsOnCurrentThread
'
)
return
false
;
if
(
field
=
=
'
GetNativeContext
'
)
return
false
;
if
(
field
=
=
"
GetGlobalJSObject
"
)
return
false
;
if
(
field
=
=
"
GetIsMainThread
"
)
return
false
;
if
(
initialCSU
=
=
'
nsIXPConnectJSObjectHolder
'
&
&
field
=
=
'
GetJSObject
'
)
return
false
;
if
(
initialCSU
=
=
'
nsIXPConnect
'
&
&
field
=
=
'
GetSafeJSContext
'
)
return
false
;
if
(
initialCSU
=
=
'
nsIScriptContext
'
)
{
if
(
field
=
=
'
GetWindowProxy
'
|
|
field
=
=
'
GetWindowProxyPreserveColor
'
)
return
false
;
}
return
true
;
}
function
listGCTypes
(
)
{
return
[
'
js
:
:
gc
:
:
Cell
'
'
JSObject
'
'
JSString
'
'
JSFatInlineString
'
'
JSExternalString
'
'
js
:
:
Shape
'
'
js
:
:
AccessorShape
'
'
js
:
:
BaseShape
'
'
JSScript
'
'
js
:
:
ObjectGroup
'
'
js
:
:
LazyScript
'
'
js
:
:
jit
:
:
JitCode
'
'
JS
:
:
Symbol
'
]
;
}
function
listGCPointers
(
)
{
return
[
'
JS
:
:
Value
'
'
jsid
'
'
js
:
:
TypeSet
'
'
js
:
:
TypeSet
:
:
ObjectKey
'
'
js
:
:
TypeSet
:
:
Type
'
'
JS
:
:
AutoCheckCannotGC
'
]
;
}
function
listNonGCTypes
(
)
{
return
[
]
;
}
function
listNonGCPointers
(
)
{
return
[
'
NPIdentifier
'
'
XPCNativeMember
'
]
;
}
function
isGCPointer
(
typeName
)
{
return
false
;
}
