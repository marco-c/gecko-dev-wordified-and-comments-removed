#
include
"
ScriptLoadRequest
.
h
"
#
include
"
GeckoProfiler
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
ScriptLoadContext
.
h
"
#
include
"
mozilla
/
dom
/
WorkerLoadContext
.
h
"
#
include
"
mozilla
/
dom
/
ScriptSettings
.
h
"
#
include
"
mozilla
/
HoldDropJSObjects
.
h
"
#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
Utf8
.
h
"
#
include
"
js
/
SourceText
.
h
"
#
include
"
ModuleLoadRequest
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIClassOfService
.
h
"
#
include
"
nsISupportsPriority
.
h
"
using
JS
:
:
SourceText
;
namespace
JS
:
:
loader
{
NS_IMPL_CYCLE_COLLECTION
(
ScriptFetchOptions
mTriggeringPrincipal
)
ScriptFetchOptions
:
:
ScriptFetchOptions
(
mozilla
:
:
CORSMode
aCORSMode
const
nsAString
&
aNonce
mozilla
:
:
dom
:
:
RequestPriority
aFetchPriority
const
ParserMetadata
aParserMetadata
nsIPrincipal
*
aTriggeringPrincipal
)
:
mCORSMode
(
aCORSMode
)
mNonce
(
aNonce
)
mFetchPriority
(
aFetchPriority
)
mParserMetadata
(
aParserMetadata
)
mTriggeringPrincipal
(
aTriggeringPrincipal
)
{
}
void
ScriptFetchOptions
:
:
SetTriggeringPrincipal
(
nsIPrincipal
*
aTriggeringPrincipal
)
{
MOZ_ASSERT
(
!
mTriggeringPrincipal
)
;
mTriggeringPrincipal
=
aTriggeringPrincipal
;
}
already_AddRefed
<
ScriptFetchOptions
>
ScriptFetchOptions
:
:
CreateDefault
(
)
{
RefPtr
<
ScriptFetchOptions
>
options
=
new
ScriptFetchOptions
(
mozilla
:
:
CORS_NONE
u
"
"
_ns
mozilla
:
:
dom
:
:
RequestPriority
:
:
Auto
ParserMetadata
:
:
NotParserInserted
)
;
return
options
.
forget
(
)
;
}
ScriptFetchOptions
:
:
~
ScriptFetchOptions
(
)
=
default
;
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
ScriptLoadRequest
)
NS_INTERFACE_MAP_ENTRY
(
nsISupports
)
NS_INTERFACE_MAP_END
NS_IMPL_CYCLE_COLLECTING_ADDREF
(
ScriptLoadRequest
)
NS_IMPL_CYCLE_COLLECTING_RELEASE
(
ScriptLoadRequest
)
NS_IMPL_CYCLE_COLLECTION_CLASS
(
ScriptLoadRequest
)
NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN
(
ScriptLoadRequest
)
NS_IMPL_CYCLE_COLLECTION_UNLINK
(
mFetchOptions
mOriginPrincipal
mBaseURL
mLoadedScript
mLoadContext
)
tmp
-
>
mScriptForCache
=
nullptr
;
NS_IMPL_CYCLE_COLLECTION_UNLINK_END
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN
(
ScriptLoadRequest
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE
(
mFetchOptions
mLoadContext
mLoadedScript
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
NS_IMPL_CYCLE_COLLECTION_TRACE_BEGIN
(
ScriptLoadRequest
)
NS_IMPL_CYCLE_COLLECTION_TRACE_JS_MEMBER_CALLBACK
(
mScriptForCache
)
NS_IMPL_CYCLE_COLLECTION_TRACE_END
ScriptLoadRequest
:
:
ScriptLoadRequest
(
ScriptKind
aKind
nsIURI
*
aURI
mozilla
:
:
dom
:
:
ReferrerPolicy
aReferrerPolicy
ScriptFetchOptions
*
aFetchOptions
const
SRIMetadata
&
aIntegrity
nsIURI
*
aReferrer
LoadContextBase
*
aContext
)
:
mKind
(
aKind
)
mState
(
State
:
:
CheckingCache
)
mFetchSourceOnly
(
false
)
mHasSourceMapURL_
(
false
)
mReferrerPolicy
(
aReferrerPolicy
)
mFetchOptions
(
aFetchOptions
)
mIntegrity
(
aIntegrity
)
mReferrer
(
aReferrer
)
mURI
(
aURI
)
mLoadContext
(
aContext
)
mEarlyHintPreloaderId
(
0
)
{
MOZ_ASSERT
(
mFetchOptions
)
;
if
(
mLoadContext
)
{
mLoadContext
-
>
SetRequest
(
this
)
;
}
}
ScriptLoadRequest
:
:
~
ScriptLoadRequest
(
)
{
DropJSObjects
(
this
)
;
}
void
ScriptLoadRequest
:
:
SetReady
(
)
{
MOZ_ASSERT
(
!
IsFinished
(
)
)
;
mState
=
State
:
:
Ready
;
}
void
ScriptLoadRequest
:
:
Cancel
(
)
{
mState
=
State
:
:
Canceled
;
if
(
HasScriptLoadContext
(
)
)
{
GetScriptLoadContext
(
)
-
>
MaybeCancelOffThreadScript
(
)
;
}
}
bool
ScriptLoadRequest
:
:
HasScriptLoadContext
(
)
const
{
return
HasLoadContext
(
)
&
&
mLoadContext
-
>
IsWindowContext
(
)
;
}
bool
ScriptLoadRequest
:
:
HasWorkerLoadContext
(
)
const
{
return
HasLoadContext
(
)
&
&
mLoadContext
-
>
IsWorkerContext
(
)
;
}
mozilla
:
:
dom
:
:
ScriptLoadContext
*
ScriptLoadRequest
:
:
GetScriptLoadContext
(
)
{
MOZ_ASSERT
(
mLoadContext
)
;
return
mLoadContext
-
>
AsWindowContext
(
)
;
}
const
mozilla
:
:
dom
:
:
ScriptLoadContext
*
ScriptLoadRequest
:
:
GetScriptLoadContext
(
)
const
{
MOZ_ASSERT
(
mLoadContext
)
;
return
mLoadContext
-
>
AsWindowContext
(
)
;
}
mozilla
:
:
loader
:
:
SyncLoadContext
*
ScriptLoadRequest
:
:
GetSyncLoadContext
(
)
{
MOZ_ASSERT
(
mLoadContext
)
;
return
mLoadContext
-
>
AsSyncContext
(
)
;
}
mozilla
:
:
dom
:
:
WorkerLoadContext
*
ScriptLoadRequest
:
:
GetWorkerLoadContext
(
)
{
MOZ_ASSERT
(
mLoadContext
)
;
return
mLoadContext
-
>
AsWorkerContext
(
)
;
}
mozilla
:
:
dom
:
:
WorkletLoadContext
*
ScriptLoadRequest
:
:
GetWorkletLoadContext
(
)
{
MOZ_ASSERT
(
mLoadContext
)
;
return
mLoadContext
-
>
AsWorkletContext
(
)
;
}
ModuleLoadRequest
*
ScriptLoadRequest
:
:
AsModuleRequest
(
)
{
MOZ_ASSERT
(
IsModuleRequest
(
)
)
;
return
static_cast
<
ModuleLoadRequest
*
>
(
this
)
;
}
const
ModuleLoadRequest
*
ScriptLoadRequest
:
:
AsModuleRequest
(
)
const
{
MOZ_ASSERT
(
IsModuleRequest
(
)
)
;
return
static_cast
<
const
ModuleLoadRequest
*
>
(
this
)
;
}
bool
ScriptLoadRequest
:
:
IsCacheable
(
)
const
{
if
(
HasScriptLoadContext
(
)
&
&
GetScriptLoadContext
(
)
-
>
mIsInline
)
{
return
false
;
}
return
!
mExpirationTime
.
IsExpired
(
)
;
}
void
ScriptLoadRequest
:
:
CacheEntryFound
(
LoadedScript
*
aLoadedScript
)
{
MOZ_ASSERT
(
IsCheckingCache
(
)
)
;
MOZ_ASSERT
(
mURI
)
;
MOZ_ASSERT
(
mFetchOptions
-
>
IsCompatible
(
aLoadedScript
-
>
GetFetchOptions
(
)
)
)
;
switch
(
mKind
)
{
case
ScriptKind
:
:
eClassic
:
case
ScriptKind
:
:
eImportMap
:
MOZ_ASSERT
(
aLoadedScript
-
>
IsClassicScript
(
)
)
;
mLoadedScript
=
aLoadedScript
;
mState
=
State
:
:
Ready
;
break
;
case
ScriptKind
:
:
eModule
:
MOZ_ASSERT
(
aLoadedScript
-
>
IsModuleScript
(
)
)
;
mLoadedScript
=
ModuleScript
:
:
FromCache
(
*
aLoadedScript
)
;
#
ifdef
DEBUG
{
bool
equals
=
false
;
mURI
-
>
Equals
(
mLoadedScript
-
>
GetURI
(
)
&
equals
)
;
MOZ_ASSERT
(
equals
)
;
}
#
endif
mBaseURL
=
mLoadedScript
-
>
BaseURL
(
)
;
mState
=
State
:
:
Fetching
;
break
;
case
ScriptKind
:
:
eEvent
:
MOZ_ASSERT_UNREACHABLE
(
"
EventScripts
are
not
using
ScriptLoadRequest
"
)
;
break
;
}
}
void
ScriptLoadRequest
:
:
NoCacheEntryFound
(
)
{
MOZ_ASSERT
(
IsCheckingCache
(
)
)
;
MOZ_ASSERT
(
mURI
)
;
switch
(
mKind
)
{
case
ScriptKind
:
:
eClassic
:
case
ScriptKind
:
:
eImportMap
:
mLoadedScript
=
new
ClassicScript
(
mReferrerPolicy
mFetchOptions
mURI
)
;
break
;
case
ScriptKind
:
:
eModule
:
mLoadedScript
=
new
ModuleScript
(
mReferrerPolicy
mFetchOptions
mURI
)
;
break
;
case
ScriptKind
:
:
eEvent
:
MOZ_ASSERT_UNREACHABLE
(
"
EventScripts
are
not
using
ScriptLoadRequest
"
)
;
break
;
}
mState
=
State
:
:
Fetching
;
}
void
ScriptLoadRequest
:
:
SetPendingFetchingError
(
)
{
MOZ_ASSERT
(
IsCheckingCache
(
)
)
;
mState
=
State
:
:
PendingFetchingError
;
}
void
ScriptLoadRequest
:
:
MarkScriptForCache
(
JSScript
*
aScript
)
{
MOZ_ASSERT
(
!
IsModuleRequest
(
)
)
;
MOZ_ASSERT
(
!
mScriptForCache
)
;
MarkForCache
(
)
;
mScriptForCache
=
aScript
;
HoldJSObjects
(
this
)
;
}
static
bool
IsInternalURIScheme
(
nsIURI
*
uri
)
{
return
uri
-
>
SchemeIs
(
"
moz
-
extension
"
)
|
|
uri
-
>
SchemeIs
(
"
resource
"
)
|
|
uri
-
>
SchemeIs
(
"
moz
-
src
"
)
|
|
uri
-
>
SchemeIs
(
"
chrome
"
)
;
}
void
ScriptLoadRequest
:
:
SetBaseURLFromChannelAndOriginalURI
(
nsIChannel
*
aChannel
nsIURI
*
aOriginalURI
)
{
if
(
aOriginalURI
&
&
IsInternalURIScheme
(
aOriginalURI
)
)
{
mBaseURL
=
aOriginalURI
;
}
else
{
aChannel
-
>
GetURI
(
getter_AddRefs
(
mBaseURL
)
)
;
}
}
}
