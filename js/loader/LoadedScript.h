#
ifndef
js_loader_LoadedScript_h
#
define
js_loader_LoadedScript_h
#
include
"
js
/
AllocPolicy
.
h
"
#
include
"
js
/
experimental
/
JSStencil
.
h
"
#
include
"
js
/
Transcoding
.
h
"
#
include
"
mozilla
/
AlreadyAddRefed
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
MaybeOneOf
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
Utf8
.
h
"
#
include
"
mozilla
/
Variant
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsICacheInfoChannel
.
h
"
#
include
"
nsIMemoryReporter
.
h
"
#
include
"
jsapi
.
h
"
#
include
"
ScriptKind
.
h
"
#
include
"
ScriptFetchOptions
.
h
"
class
nsIURI
;
namespace
JS
:
:
loader
{
class
ScriptLoadRequest
;
using
Utf8Unit
=
mozilla
:
:
Utf8Unit
;
void
HostAddRefTopLevelScript
(
const
Value
&
aPrivate
)
;
void
HostReleaseTopLevelScript
(
const
Value
&
aPrivate
)
;
class
ClassicScript
;
class
ModuleScript
;
class
EventScript
;
class
LoadContextBase
;
class
LoadedScript
:
public
nsIMemoryReporter
{
protected
:
LoadedScript
(
ScriptKind
aKind
mozilla
:
:
dom
:
:
ReferrerPolicy
aReferrerPolicy
ScriptFetchOptions
*
aFetchOptions
nsIURI
*
aURI
)
;
LoadedScript
(
const
LoadedScript
&
aOther
)
;
template
<
typename
T
typename
.
.
.
Args
>
friend
RefPtr
<
T
>
mozilla
:
:
MakeRefPtr
(
Args
&
&
.
.
.
aArgs
)
;
virtual
~
LoadedScript
(
)
;
public
:
void
RegisterMemoryReport
(
)
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
public
:
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
;
NS_DECL_NSIMEMORYREPORTER
;
NS_DECL_CYCLE_COLLECTION_CLASS
(
LoadedScript
)
bool
IsClassicScript
(
)
const
{
return
mKind
=
=
ScriptKind
:
:
eClassic
;
}
bool
IsModuleScript
(
)
const
{
return
mKind
=
=
ScriptKind
:
:
eModule
;
}
bool
IsEventScript
(
)
const
{
return
mKind
=
=
ScriptKind
:
:
eEvent
;
}
inline
ClassicScript
*
AsClassicScript
(
)
;
inline
ModuleScript
*
AsModuleScript
(
)
;
inline
EventScript
*
AsEventScript
(
)
;
ScriptFetchOptions
*
GetFetchOptions
(
)
const
{
return
mFetchOptions
;
}
mozilla
:
:
dom
:
:
ReferrerPolicy
ReferrerPolicy
(
)
const
{
return
mReferrerPolicy
;
}
nsIURI
*
GetURI
(
)
const
{
return
mURI
;
}
void
SetBaseURL
(
nsIURI
*
aBaseURL
)
{
MOZ_ASSERT
(
!
mBaseURL
)
;
mBaseURL
=
aBaseURL
;
}
nsIURI
*
BaseURL
(
)
const
{
return
mBaseURL
;
}
void
AssociateWithScript
(
JSScript
*
aScript
)
;
public
:
template
<
typename
.
.
.
Ts
>
using
Variant
=
mozilla
:
:
Variant
<
Ts
.
.
.
>
;
template
<
typename
.
.
.
Ts
>
using
VariantType
=
mozilla
:
:
VariantType
<
Ts
.
.
.
>
;
enum
class
DataType
:
uint8_t
{
eUnknown
eTextSource
eBytecode
eCachedStencil
}
;
template
<
typename
Unit
>
using
ScriptTextBuffer
=
mozilla
:
:
Vector
<
Unit
0
js
:
:
MallocAllocPolicy
>
;
using
MaybeSourceText
=
mozilla
:
:
MaybeOneOf
<
SourceText
<
char16_t
>
SourceText
<
Utf8Unit
>
>
;
bool
IsUnknownDataType
(
)
const
{
return
mDataType
=
=
DataType
:
:
eUnknown
;
}
bool
IsTextSource
(
)
const
{
return
mDataType
=
=
DataType
:
:
eTextSource
;
}
bool
IsSource
(
)
const
{
return
IsTextSource
(
)
;
}
bool
IsBytecode
(
)
const
{
return
mDataType
=
=
DataType
:
:
eBytecode
;
}
bool
IsCachedStencil
(
)
const
{
return
mDataType
=
=
DataType
:
:
eCachedStencil
;
}
void
SetUnknownDataType
(
)
{
mDataType
=
DataType
:
:
eUnknown
;
mScriptData
.
reset
(
)
;
}
void
SetTextSource
(
LoadContextBase
*
maybeLoadContext
)
{
MOZ_ASSERT
(
IsUnknownDataType
(
)
)
;
mDataType
=
DataType
:
:
eTextSource
;
mScriptData
.
emplace
(
VariantType
<
ScriptTextBuffer
<
Utf8Unit
>
>
(
)
)
;
}
void
SetBytecode
(
)
{
MOZ_ASSERT
(
IsUnknownDataType
(
)
)
;
mDataType
=
DataType
:
:
eBytecode
;
}
void
SetCachedStencil
(
already_AddRefed
<
Stencil
>
aStencil
)
{
SetUnknownDataType
(
)
;
mDataType
=
DataType
:
:
eCachedStencil
;
mStencil
=
aStencil
;
}
bool
IsUTF16Text
(
)
const
{
return
mScriptData
-
>
is
<
ScriptTextBuffer
<
char16_t
>
>
(
)
;
}
bool
IsUTF8Text
(
)
const
{
return
mScriptData
-
>
is
<
ScriptTextBuffer
<
Utf8Unit
>
>
(
)
;
}
template
<
typename
Unit
>
const
ScriptTextBuffer
<
Unit
>
&
ScriptText
(
)
const
{
MOZ_ASSERT
(
IsTextSource
(
)
)
;
return
mScriptData
-
>
as
<
ScriptTextBuffer
<
Unit
>
>
(
)
;
}
template
<
typename
Unit
>
ScriptTextBuffer
<
Unit
>
&
ScriptText
(
)
{
MOZ_ASSERT
(
IsTextSource
(
)
)
;
return
mScriptData
-
>
as
<
ScriptTextBuffer
<
Unit
>
>
(
)
;
}
size_t
ScriptTextLength
(
)
const
{
MOZ_ASSERT
(
IsTextSource
(
)
)
;
return
IsUTF16Text
(
)
?
ScriptText
<
char16_t
>
(
)
.
length
(
)
:
ScriptText
<
Utf8Unit
>
(
)
.
length
(
)
;
}
nsresult
GetScriptSource
(
JSContext
*
aCx
MaybeSourceText
*
aMaybeSource
LoadContextBase
*
aMaybeLoadContext
)
;
void
ClearScriptSource
(
)
{
if
(
IsTextSource
(
)
)
{
ClearScriptText
(
)
;
}
}
void
ClearScriptText
(
)
{
MOZ_ASSERT
(
IsTextSource
(
)
)
;
return
IsUTF16Text
(
)
?
ScriptText
<
char16_t
>
(
)
.
clearAndFree
(
)
:
ScriptText
<
Utf8Unit
>
(
)
.
clearAndFree
(
)
;
}
size_t
ReceivedScriptTextLength
(
)
const
{
return
mReceivedScriptTextLength
;
}
void
SetReceivedScriptTextLength
(
size_t
aLength
)
{
mReceivedScriptTextLength
=
aLength
;
}
bool
CanHaveBytecode
(
)
const
{
return
IsBytecode
(
)
|
|
IsSource
(
)
|
|
IsCachedStencil
(
)
;
}
TranscodeBuffer
&
SRIAndBytecode
(
)
{
MOZ_ASSERT
(
CanHaveBytecode
(
)
)
;
return
mScriptBytecode
;
}
TranscodeRange
Bytecode
(
)
const
{
MOZ_ASSERT
(
IsBytecode
(
)
)
;
const
auto
&
bytecode
=
mScriptBytecode
;
auto
offset
=
mBytecodeOffset
;
return
TranscodeRange
(
bytecode
.
begin
(
)
+
offset
bytecode
.
length
(
)
-
offset
)
;
}
size_t
GetSRILength
(
)
const
{
MOZ_ASSERT
(
CanHaveBytecode
(
)
)
;
return
mBytecodeOffset
;
}
void
SetSRILength
(
size_t
sriLength
)
{
MOZ_ASSERT
(
CanHaveBytecode
(
)
)
;
mBytecodeOffset
=
AlignTranscodingBytecodeOffset
(
sriLength
)
;
}
void
DropBytecode
(
)
{
MOZ_ASSERT
(
CanHaveBytecode
(
)
)
;
mScriptBytecode
.
clearAndFree
(
)
;
}
Stencil
*
GetStencil
(
)
const
{
MOZ_ASSERT
(
IsCachedStencil
(
)
)
;
return
mStencil
;
}
public
:
DataType
mDataType
;
uint8_t
mFetchCount
=
0
;
private
:
ScriptKind
mKind
;
protected
:
mozilla
:
:
dom
:
:
ReferrerPolicy
mReferrerPolicy
;
public
:
uint32_t
mBytecodeOffset
;
private
:
RefPtr
<
ScriptFetchOptions
>
mFetchOptions
;
nsCOMPtr
<
nsIURI
>
mURI
;
nsCOMPtr
<
nsIURI
>
mBaseURL
;
public
:
mozilla
:
:
Maybe
<
Variant
<
ScriptTextBuffer
<
char16_t
>
ScriptTextBuffer
<
Utf8Unit
>
>
>
mScriptData
;
size_t
mReceivedScriptTextLength
;
TranscodeBuffer
mScriptBytecode
;
RefPtr
<
Stencil
>
mStencil
;
nsCOMPtr
<
nsICacheInfoChannel
>
mCacheInfo
;
JS
:
:
TranscodeBuffer
mSRI
;
}
;
template
<
typename
Derived
>
class
LoadedScriptDelegate
{
private
:
const
LoadedScript
*
GetLoadedScript
(
)
const
{
return
static_cast
<
const
Derived
*
>
(
this
)
-
>
getLoadedScript
(
)
;
}
LoadedScript
*
GetLoadedScript
(
)
{
return
static_cast
<
Derived
*
>
(
this
)
-
>
getLoadedScript
(
)
;
}
public
:
template
<
typename
Unit
>
using
ScriptTextBuffer
=
LoadedScript
:
:
ScriptTextBuffer
<
Unit
>
;
using
MaybeSourceText
=
LoadedScript
:
:
MaybeSourceText
;
bool
IsModuleScript
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsModuleScript
(
)
;
}
bool
IsEventScript
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsEventScript
(
)
;
}
bool
IsUnknownDataType
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsUnknownDataType
(
)
;
}
bool
IsTextSource
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsTextSource
(
)
;
}
bool
IsSource
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsSource
(
)
;
}
bool
IsBytecode
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsBytecode
(
)
;
}
bool
IsCachedStencil
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsCachedStencil
(
)
;
}
void
SetUnknownDataType
(
)
{
GetLoadedScript
(
)
-
>
SetUnknownDataType
(
)
;
}
void
SetTextSource
(
LoadContextBase
*
maybeLoadContext
)
{
GetLoadedScript
(
)
-
>
SetTextSource
(
maybeLoadContext
)
;
}
void
SetBytecode
(
)
{
GetLoadedScript
(
)
-
>
SetBytecode
(
)
;
}
void
SetCachedStencil
(
already_AddRefed
<
Stencil
>
aStencil
)
{
GetLoadedScript
(
)
-
>
SetCachedStencil
(
std
:
:
move
(
aStencil
)
)
;
}
bool
IsUTF16Text
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsUTF16Text
(
)
;
}
bool
IsUTF8Text
(
)
const
{
return
GetLoadedScript
(
)
-
>
IsUTF8Text
(
)
;
}
template
<
typename
Unit
>
const
ScriptTextBuffer
<
Unit
>
&
ScriptText
(
)
const
{
const
LoadedScript
*
loader
=
GetLoadedScript
(
)
;
return
loader
-
>
ScriptText
<
Unit
>
(
)
;
}
template
<
typename
Unit
>
ScriptTextBuffer
<
Unit
>
&
ScriptText
(
)
{
LoadedScript
*
loader
=
GetLoadedScript
(
)
;
return
loader
-
>
ScriptText
<
Unit
>
(
)
;
}
size_t
ScriptTextLength
(
)
const
{
return
GetLoadedScript
(
)
-
>
ScriptTextLength
(
)
;
}
size_t
ReceivedScriptTextLength
(
)
const
{
return
GetLoadedScript
(
)
-
>
ReceivedScriptTextLength
(
)
;
}
void
SetReceivedScriptTextLength
(
size_t
aLength
)
{
GetLoadedScript
(
)
-
>
SetReceivedScriptTextLength
(
aLength
)
;
}
nsresult
GetScriptSource
(
JSContext
*
aCx
MaybeSourceText
*
aMaybeSource
LoadContextBase
*
aLoadContext
)
{
return
GetLoadedScript
(
)
-
>
GetScriptSource
(
aCx
aMaybeSource
aLoadContext
)
;
}
void
ClearScriptSource
(
)
{
GetLoadedScript
(
)
-
>
ClearScriptSource
(
)
;
}
void
ClearScriptText
(
)
{
GetLoadedScript
(
)
-
>
ClearScriptText
(
)
;
}
TranscodeBuffer
&
SRIAndBytecode
(
)
{
return
GetLoadedScript
(
)
-
>
SRIAndBytecode
(
)
;
}
TranscodeRange
Bytecode
(
)
const
{
return
GetLoadedScript
(
)
-
>
Bytecode
(
)
;
}
size_t
GetSRILength
(
)
const
{
return
GetLoadedScript
(
)
-
>
GetSRILength
(
)
;
}
void
SetSRILength
(
size_t
sriLength
)
{
GetLoadedScript
(
)
-
>
SetSRILength
(
sriLength
)
;
}
void
DropBytecode
(
)
{
GetLoadedScript
(
)
-
>
DropBytecode
(
)
;
}
Stencil
*
GetStencil
(
)
const
{
return
GetLoadedScript
(
)
-
>
GetStencil
(
)
;
}
}
;
class
ClassicScript
final
:
public
LoadedScript
{
~
ClassicScript
(
)
=
default
;
private
:
ClassicScript
(
mozilla
:
:
dom
:
:
ReferrerPolicy
aReferrerPolicy
ScriptFetchOptions
*
aFetchOptions
nsIURI
*
aURI
)
;
friend
class
ScriptLoadRequest
;
}
;
class
EventScript
final
:
public
LoadedScript
{
~
EventScript
(
)
=
default
;
public
:
EventScript
(
mozilla
:
:
dom
:
:
ReferrerPolicy
aReferrerPolicy
ScriptFetchOptions
*
aFetchOptions
nsIURI
*
aURI
)
;
}
;
class
ModuleScript
final
:
public
LoadedScript
{
Heap
<
JSObject
*
>
mModuleRecord
;
Heap
<
Value
>
mParseError
;
Heap
<
Value
>
mErrorToRethrow
;
bool
mForPreload
=
false
;
bool
mHadImportMap
=
false
;
~
ModuleScript
(
)
;
public
:
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS_INHERITED
(
ModuleScript
LoadedScript
)
private
:
ModuleScript
(
mozilla
:
:
dom
:
:
ReferrerPolicy
aReferrerPolicy
ScriptFetchOptions
*
aFetchOptions
nsIURI
*
aURI
)
;
explicit
ModuleScript
(
const
LoadedScript
&
other
)
;
template
<
typename
T
typename
.
.
.
Args
>
friend
RefPtr
<
T
>
mozilla
:
:
MakeRefPtr
(
Args
&
&
.
.
.
aArgs
)
;
friend
class
ScriptLoadRequest
;
public
:
static
already_AddRefed
<
ModuleScript
>
FromCache
(
const
LoadedScript
&
aScript
)
;
already_AddRefed
<
LoadedScript
>
ToCache
(
)
;
void
SetModuleRecord
(
Handle
<
JSObject
*
>
aModuleRecord
)
;
void
SetParseError
(
const
Value
&
aError
)
;
void
SetErrorToRethrow
(
const
Value
&
aError
)
;
void
SetForPreload
(
bool
aValue
)
;
void
SetHadImportMap
(
bool
aValue
)
;
JSObject
*
ModuleRecord
(
)
const
{
return
mModuleRecord
;
}
Value
ParseError
(
)
const
{
return
mParseError
;
}
Value
ErrorToRethrow
(
)
const
{
return
mErrorToRethrow
;
}
bool
HasParseError
(
)
const
{
return
!
mParseError
.
isUndefined
(
)
;
}
bool
HasErrorToRethrow
(
)
const
{
return
!
mErrorToRethrow
.
isUndefined
(
)
;
}
bool
ForPreload
(
)
const
{
return
mForPreload
;
}
bool
HadImportMap
(
)
const
{
return
mHadImportMap
;
}
void
Shutdown
(
)
;
void
UnlinkModuleRecord
(
)
;
friend
void
CheckModuleScriptPrivate
(
LoadedScript
*
const
Value
&
)
;
void
UpdateReferrerPolicy
(
mozilla
:
:
dom
:
:
ReferrerPolicy
aReferrerPolicy
)
{
mReferrerPolicy
=
aReferrerPolicy
;
}
}
;
ClassicScript
*
LoadedScript
:
:
AsClassicScript
(
)
{
MOZ_ASSERT
(
!
IsModuleScript
(
)
)
;
return
static_cast
<
ClassicScript
*
>
(
this
)
;
}
ModuleScript
*
LoadedScript
:
:
AsModuleScript
(
)
{
MOZ_ASSERT
(
IsModuleScript
(
)
)
;
return
static_cast
<
ModuleScript
*
>
(
this
)
;
}
}
#
endif
