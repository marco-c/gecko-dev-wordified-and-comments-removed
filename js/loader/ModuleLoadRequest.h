#
ifndef
js_loader_ModuleLoadRequest_h
#
define
js_loader_ModuleLoadRequest_h
#
include
"
LoadContextBase
.
h
"
#
include
"
ScriptLoadRequest
.
h
"
#
include
"
ModuleLoaderBase
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
js
/
Value
.
h
"
#
include
"
nsURIHashKey
.
h
"
#
include
"
nsTHashtable
.
h
"
namespace
JS
:
:
loader
{
class
ModuleScript
;
class
ModuleLoaderBase
;
class
VisitedURLSet
:
public
nsTHashtable
<
nsURIHashKey
>
{
NS_INLINE_DECL_REFCOUNTING
(
VisitedURLSet
)
private
:
~
VisitedURLSet
(
)
=
default
;
}
;
class
ModuleLoadRequest
final
:
public
ScriptLoadRequest
{
~
ModuleLoadRequest
(
)
=
default
;
ModuleLoadRequest
(
const
ModuleLoadRequest
&
aOther
)
=
delete
;
ModuleLoadRequest
(
ModuleLoadRequest
&
&
aOther
)
=
delete
;
public
:
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS_INHERITED
(
ModuleLoadRequest
ScriptLoadRequest
)
using
SRIMetadata
=
mozilla
:
:
dom
:
:
SRIMetadata
;
template
<
typename
T
>
using
MozPromiseHolder
=
mozilla
:
:
MozPromiseHolder
<
T
>
;
using
GenericPromise
=
mozilla
:
:
GenericPromise
;
ModuleLoadRequest
(
nsIURI
*
aURI
ScriptFetchOptions
*
aFetchOptions
const
SRIMetadata
&
aIntegrity
nsIURI
*
aReferrer
LoadContextBase
*
aContext
bool
aIsTopLevel
bool
aIsDynamicImport
ModuleLoaderBase
*
aLoader
VisitedURLSet
*
aVisitedSet
ModuleLoadRequest
*
aRootModule
)
;
static
VisitedURLSet
*
NewVisitedSetForTopLevelImport
(
nsIURI
*
aURI
)
;
bool
IsTopLevel
(
)
const
override
{
return
mIsTopLevel
;
}
bool
IsDynamicImport
(
)
const
{
return
mIsDynamicImport
;
}
nsIGlobalObject
*
GetGlobalObject
(
)
;
void
SetReady
(
)
override
;
void
Cancel
(
)
override
;
void
ClearDynamicImport
(
)
;
void
ModuleLoaded
(
)
;
void
ModuleErrored
(
)
;
void
DependenciesLoaded
(
)
;
void
LoadFailed
(
)
;
ModuleLoadRequest
*
GetRootModule
(
)
{
if
(
!
mRootModule
)
{
return
this
;
}
return
mRootModule
;
}
bool
IsModuleMarkedForBytecodeEncoding
(
)
const
{
return
mIsMarkedForBytecodeEncoding
;
}
void
MarkModuleForBytecodeEncoding
(
)
{
MOZ_ASSERT
(
!
IsModuleMarkedForBytecodeEncoding
(
)
)
;
mIsMarkedForBytecodeEncoding
=
true
;
}
void
CancelDynamicImport
(
nsresult
aResult
)
{
MOZ_ASSERT
(
IsDynamicImport
(
)
)
;
mLoader
-
>
CancelDynamicImport
(
this
aResult
)
;
}
#
ifdef
DEBUG
bool
IsRegisteredDynamicImport
(
)
const
{
return
IsDynamicImport
(
)
&
&
mLoader
-
>
HasDynamicImport
(
this
)
;
}
#
endif
nsresult
StartModuleLoad
(
)
{
return
mLoader
-
>
StartModuleLoad
(
this
)
;
}
nsresult
RestartModuleLoad
(
)
{
return
mLoader
-
>
RestartModuleLoad
(
this
)
;
}
void
SetModuleFetchFinishedAndResumeWaitingRequests
(
nsresult
aResult
)
{
mLoader
-
>
SetModuleFetchFinishedAndResumeWaitingRequests
(
this
aResult
)
;
}
nsresult
ProcessFetchedModuleSource
(
)
{
return
mLoader
-
>
ProcessFetchedModuleSource
(
this
)
;
}
bool
InstantiateModuleTree
(
)
{
return
mLoader
-
>
InstantiateModuleTree
(
this
)
;
}
nsresult
EvaluateModule
(
)
{
return
mLoader
-
>
EvaluateModule
(
this
)
;
}
void
StartDynamicImport
(
)
{
mLoader
-
>
StartDynamicImport
(
this
)
;
}
void
ProcessDynamicImport
(
)
{
mLoader
-
>
ProcessDynamicImport
(
this
)
;
}
private
:
void
LoadFinished
(
)
;
void
CancelImports
(
)
;
void
CheckModuleDependenciesLoaded
(
)
;
public
:
const
bool
mIsTopLevel
;
const
bool
mIsDynamicImport
;
bool
mIsMarkedForBytecodeEncoding
=
false
;
RefPtr
<
ModuleLoaderBase
>
mLoader
;
RefPtr
<
ModuleLoadRequest
>
mRootModule
;
RefPtr
<
ModuleScript
>
mModuleScript
;
MozPromiseHolder
<
GenericPromise
>
mReady
;
nsTArray
<
RefPtr
<
ModuleLoadRequest
>
>
mImports
;
RefPtr
<
VisitedURLSet
>
mVisitedSet
;
JS
:
:
Heap
<
JS
:
:
Value
>
mDynamicReferencingPrivate
;
JS
:
:
Heap
<
JSString
*
>
mDynamicSpecifier
;
JS
:
:
Heap
<
JSObject
*
>
mDynamicPromise
;
}
;
}
#
endif
