#
include
"
nsJSConfigTriggers
.
h
"
#
include
"
jsapi
.
h
"
#
include
"
nsIXPConnect
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIServiceManager
.
h
"
#
include
"
nsIComponentManager
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsIPrefBranch
.
h
"
#
include
"
nsIPrefService
.
h
"
#
include
"
nspr
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIScriptSecurityManager
.
h
"
#
include
"
nsJSPrincipals
.
h
"
#
include
"
nsIScriptError
.
h
"
#
include
"
js
/
Wrapper
.
h
"
#
include
"
NullPrincipal
.
h
"
extern
mozilla
:
:
LazyLogModule
MCD
;
using
mozilla
:
:
AutoSafeJSContext
;
using
mozilla
:
:
dom
:
:
AutoJSAPI
;
static
JS
:
:
PersistentRooted
<
JSObject
*
>
autoconfigSystemSb
;
static
JS
:
:
PersistentRooted
<
JSObject
*
>
autoconfigSb
;
static
bool
sandboxEnabled
;
nsresult
CentralizedAdminPrefManagerInit
(
bool
aSandboxEnabled
)
{
nsresult
rv
;
if
(
autoconfigSb
.
initialized
(
)
)
return
NS_OK
;
sandboxEnabled
=
aSandboxEnabled
|
|
!
strcmp
(
NS_STRINGIFY
(
MOZ_UPDATE_CHANNEL
)
"
release
"
)
;
nsCOMPtr
<
nsIXPConnect
>
xpc
=
do_GetService
(
nsIXPConnect
:
:
GetCID
(
)
&
rv
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
nsCOMPtr
<
nsIPrincipal
>
principal
;
nsContentUtils
:
:
GetSecurityManager
(
)
-
>
GetSystemPrincipal
(
getter_AddRefs
(
principal
)
)
;
AutoSafeJSContext
cx
;
JS
:
:
Rooted
<
JSObject
*
>
sandbox
(
cx
)
;
rv
=
xpc
-
>
CreateSandbox
(
cx
principal
sandbox
.
address
(
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
NS_ENSURE_STATE
(
sandbox
)
;
autoconfigSystemSb
.
init
(
cx
js
:
:
UncheckedUnwrap
(
sandbox
)
)
;
principal
=
NullPrincipal
:
:
CreateWithoutOriginAttributes
(
)
;
rv
=
xpc
-
>
CreateSandbox
(
cx
principal
sandbox
.
address
(
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
autoconfigSb
.
init
(
cx
js
:
:
UncheckedUnwrap
(
sandbox
)
)
;
JSAutoRealm
ac
(
cx
autoconfigSystemSb
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
value
(
cx
JS
:
:
ObjectValue
(
*
sandbox
)
)
;
if
(
!
JS_WrapValue
(
cx
&
value
)
|
|
!
JS_DefineProperty
(
cx
autoconfigSystemSb
"
gSandbox
"
value
JSPROP_ENUMERATE
)
)
{
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
nsresult
CentralizedAdminPrefManagerFinish
(
)
{
if
(
autoconfigSb
.
initialized
(
)
)
{
AutoSafeJSContext
cx
;
autoconfigSb
.
reset
(
)
;
autoconfigSystemSb
.
reset
(
)
;
JS_MaybeGC
(
cx
)
;
}
return
NS_OK
;
}
nsresult
EvaluateAdminConfigScript
(
const
char
*
js_buffer
size_t
length
const
char
*
filename
bool
globalContext
bool
callbacks
bool
skipFirstLine
bool
isPrivileged
)
{
if
(
!
sandboxEnabled
)
{
isPrivileged
=
true
;
}
return
EvaluateAdminConfigScript
(
isPrivileged
?
autoconfigSystemSb
:
autoconfigSb
js_buffer
length
filename
globalContext
callbacks
skipFirstLine
)
;
}
nsresult
EvaluateAdminConfigScript
(
JS
:
:
HandleObject
sandbox
const
char
*
js_buffer
size_t
length
const
char
*
filename
bool
globalContext
bool
callbacks
bool
skipFirstLine
)
{
nsresult
rv
=
NS_OK
;
if
(
skipFirstLine
)
{
unsigned
int
i
=
0
;
while
(
i
<
length
)
{
char
c
=
js_buffer
[
i
+
+
]
;
if
(
c
=
=
'
\
r
'
)
{
if
(
js_buffer
[
i
]
=
=
'
\
n
'
)
i
+
+
;
break
;
}
if
(
c
=
=
'
\
n
'
)
break
;
}
length
-
=
i
;
js_buffer
+
=
i
;
}
nsCOMPtr
<
nsIXPConnect
>
xpc
=
do_GetService
(
nsIXPConnect
:
:
GetCID
(
)
&
rv
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
AutoJSAPI
jsapi
;
if
(
!
jsapi
.
Init
(
sandbox
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
JSContext
*
cx
=
jsapi
.
cx
(
)
;
nsAutoCString
script
(
js_buffer
length
)
;
JS
:
:
RootedValue
v
(
cx
)
;
nsString
convertedScript
;
bool
isUTF8
=
IsUTF8
(
script
)
;
if
(
isUTF8
)
{
convertedScript
=
NS_ConvertUTF8toUTF16
(
script
)
;
}
else
{
nsContentUtils
:
:
ReportToConsoleNonLocalized
(
NS_LITERAL_STRING
(
"
Your
AutoConfig
file
is
ASCII
.
Please
convert
it
to
UTF
-
8
.
"
)
nsIScriptError
:
:
warningFlag
NS_LITERAL_CSTRING
(
"
autoconfig
"
)
nullptr
)
;
convertedScript
=
NS_ConvertASCIItoUTF16
(
script
)
;
}
{
JSAutoRealm
ac
(
cx
autoconfigSystemSb
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
value
(
cx
JS
:
:
BooleanValue
(
isUTF8
)
)
;
if
(
!
JS_DefineProperty
(
cx
autoconfigSystemSb
"
gIsUTF8
"
value
JSPROP_ENUMERATE
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
}
rv
=
xpc
-
>
EvalInSandboxObject
(
convertedScript
filename
cx
sandbox
&
v
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
return
NS_OK
;
}
