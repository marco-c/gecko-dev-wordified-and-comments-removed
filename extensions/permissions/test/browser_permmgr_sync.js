function
addPerm
(
aOrigin
aName
)
{
let
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
aOrigin
)
;
Services
.
perms
.
addFromPrincipal
(
principal
aName
Services
.
perms
.
ALLOW_ACTION
)
;
}
add_task
(
async
function
(
)
{
addPerm
(
"
http
:
/
/
example
.
com
"
"
perm1
"
)
;
addPerm
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
"
perm2
"
)
;
addPerm
(
"
about
:
home
"
"
perm3
"
)
;
addPerm
(
"
https
:
/
/
example
.
com
"
"
perm4
"
)
;
addPerm
(
"
https
:
/
/
somerandomwebsite
.
com
"
"
cookie
"
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
forceNewProcess
:
true
}
async
function
(
aBrowser
)
{
await
SpecialPowers
.
spawn
(
aBrowser
[
]
async
function
(
)
{
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
perm1
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm1
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
)
"
perm2
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm2
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
about
:
home
"
)
"
perm3
"
)
Services
.
perms
.
ALLOW_ACTION
"
perm3
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
example
.
com
"
)
"
perm4
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm4
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
somerandomwebsite
.
com
"
)
"
cookie
"
)
Services
.
perms
.
ALLOW_ACTION
"
cookie
-
1
"
)
;
let
iframe
=
content
.
document
.
createElement
(
"
iframe
"
)
;
await
new
Promise
(
resolve
=
>
{
iframe
.
setAttribute
(
"
src
"
"
http
:
/
/
example
.
com
"
)
;
iframe
.
onload
=
resolve
;
content
.
document
.
body
.
appendChild
(
iframe
)
;
}
)
;
await
content
.
SpecialPowers
.
spawn
(
iframe
[
]
async
function
(
)
{
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
perm1
"
)
Services
.
perms
.
ALLOW_ACTION
"
perm1
-
2
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
)
"
perm2
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm2
-
2
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
about
:
home
"
)
"
perm3
"
)
Services
.
perms
.
ALLOW_ACTION
"
perm3
-
2
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
example
.
com
"
)
"
perm4
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm4
-
2
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
somerandomwebsite
.
com
"
)
"
cookie
"
)
Services
.
perms
.
ALLOW_ACTION
"
cookie
-
2
"
)
;
}
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
perm1
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
perm1
-
3
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
)
"
perm2
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm2
-
3
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
example
.
com
"
)
"
perm4
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm4
-
3
"
)
;
}
)
;
addPerm
(
"
http
:
/
/
example
.
com
"
"
newperm1
"
)
;
addPerm
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
"
newperm2
"
)
;
addPerm
(
"
about
:
home
"
"
newperm3
"
)
;
addPerm
(
"
https
:
/
/
example
.
com
"
"
newperm4
"
)
;
addPerm
(
"
https
:
/
/
someotherrandomwebsite
.
com
"
"
cookie
"
)
;
await
SpecialPowers
.
spawn
(
aBrowser
[
]
async
function
(
)
{
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
perm1
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
perm1
-
4
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
newperm1
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
newperm1
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
)
"
perm2
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm2
-
4
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
)
"
newperm2
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
newperm2
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
about
:
home
"
)
"
perm3
"
)
Services
.
perms
.
ALLOW_ACTION
"
perm3
-
3
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
about
:
home
"
)
"
newperm3
"
)
Services
.
perms
.
ALLOW_ACTION
"
newperm3
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
example
.
com
"
)
"
perm4
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm4
-
4
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
example
.
com
"
)
"
newperm4
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
newperm4
-
1
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
somerandomwebsite
.
com
"
)
"
cookie
"
)
Services
.
perms
.
ALLOW_ACTION
"
cookie
-
3
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
someotherrandomwebsite
.
com
"
)
"
cookie
"
)
Services
.
perms
.
ALLOW_ACTION
"
othercookie
-
3
"
)
;
let
iframe
=
content
.
document
.
createElement
(
"
iframe
"
)
;
await
new
Promise
(
resolve
=
>
{
iframe
.
setAttribute
(
"
src
"
"
https
:
/
/
sub1
.
test1
.
example
.
com
"
)
;
iframe
.
onload
=
resolve
;
content
.
document
.
body
.
appendChild
(
iframe
)
;
}
)
;
await
content
.
SpecialPowers
.
spawn
(
iframe
[
]
async
function
(
)
{
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
example
.
com
"
)
"
perm4
"
)
Services
.
perms
.
ALLOW_ACTION
"
perm4
-
5
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
perm1
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
perm1
-
5
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
newperm1
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
newperm1
-
2
"
)
;
}
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
perm1
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
perm1
-
4
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
example
.
com
"
)
"
newperm1
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
newperm1
-
3
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
example
.
com
"
)
"
perm4
"
)
SpecialPowers
.
useRemoteSubframes
?
Services
.
perms
.
UNKNOWN_ACTION
:
Services
.
perms
.
ALLOW_ACTION
"
perm4
-
6
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
)
"
perm2
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
perm2
-
5
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
http
:
/
/
foo
.
bar
.
example
.
com
"
)
"
newperm2
"
)
Services
.
perms
.
UNKNOWN_ACTION
"
newperm2
-
2
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
about
:
home
"
)
"
perm3
"
)
Services
.
perms
.
ALLOW_ACTION
"
perm3
-
4
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
about
:
home
"
)
"
newperm3
"
)
Services
.
perms
.
ALLOW_ACTION
"
newperm3
-
2
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
somerandomwebsite
.
com
"
)
"
cookie
"
)
Services
.
perms
.
ALLOW_ACTION
"
cookie
-
4
"
)
;
is
(
Services
.
perms
.
testPermissionFromPrincipal
(
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
"
https
:
/
/
someotherrandomwebsite
.
com
"
)
"
cookie
"
)
Services
.
perms
.
ALLOW_ACTION
"
othercookie
-
4
"
)
;
}
)
;
}
)
;
}
)
;
