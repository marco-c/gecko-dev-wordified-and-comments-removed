#
ifndef
nsPermissionManager_h__
#
define
nsPermissionManager_h__
#
include
"
nsIPermissionManager
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIInputStream
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsPermission
.
h
"
#
include
"
nsIPrefBranch
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsCOMArray
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsIRunnable
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
#
include
"
mozilla
/
BasePrincipal
.
h
"
#
include
"
mozilla
/
ExpandedPrincipal
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
Variant
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
namespace
IPC
{
struct
Permission
;
}
namespace
mozilla
{
class
OriginAttributesPattern
;
}
class
nsIPermission
;
class
mozIStorageConnection
;
class
mozIStorageAsyncStatement
;
class
nsPermissionManager
final
:
public
nsIPermissionManager
public
nsIObserver
public
nsSupportsWeakReference
{
public
:
class
PermissionEntry
{
public
:
PermissionEntry
(
int64_t
aID
uint32_t
aType
uint32_t
aPermission
uint32_t
aExpireType
int64_t
aExpireTime
int64_t
aModificationTime
)
:
mID
(
aID
)
mExpireTime
(
aExpireTime
)
mModificationTime
(
aModificationTime
)
mType
(
aType
)
mPermission
(
aPermission
)
mExpireType
(
aExpireType
)
mNonSessionPermission
(
aPermission
)
mNonSessionExpireType
(
aExpireType
)
mNonSessionExpireTime
(
aExpireTime
)
{
}
int64_t
mID
;
int64_t
mExpireTime
;
int64_t
mModificationTime
;
uint32_t
mType
;
uint32_t
mPermission
;
uint32_t
mExpireType
;
uint32_t
mNonSessionPermission
;
uint32_t
mNonSessionExpireType
;
uint32_t
mNonSessionExpireTime
;
}
;
class
PermissionKey
{
public
:
static
PermissionKey
*
CreateFromPrincipal
(
nsIPrincipal
*
aPrincipal
nsresult
&
aResult
)
;
static
PermissionKey
*
CreateFromURI
(
nsIURI
*
aURI
nsresult
&
aResult
)
;
static
PermissionKey
*
CreateFromURIAndOriginAttributes
(
nsIURI
*
aURI
const
mozilla
:
:
OriginAttributes
*
aOriginAttributes
nsresult
&
aResult
)
;
explicit
PermissionKey
(
const
nsACString
&
aOrigin
)
:
mOrigin
(
aOrigin
)
mHashCode
(
mozilla
:
:
HashString
(
aOrigin
)
)
{
}
bool
operator
=
=
(
const
PermissionKey
&
aKey
)
const
{
return
mOrigin
.
Equals
(
aKey
.
mOrigin
)
;
}
PLDHashNumber
GetHashCode
(
)
const
{
return
mHashCode
;
}
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
PermissionKey
)
const
nsCString
mOrigin
;
const
PLDHashNumber
mHashCode
;
private
:
PermissionKey
(
)
=
delete
;
~
PermissionKey
(
)
{
}
;
}
;
class
PermissionHashKey
:
public
nsRefPtrHashKey
<
PermissionKey
>
{
public
:
explicit
PermissionHashKey
(
const
PermissionKey
*
aPermissionKey
)
:
nsRefPtrHashKey
<
PermissionKey
>
(
aPermissionKey
)
{
}
PermissionHashKey
(
PermissionHashKey
&
&
toCopy
)
:
nsRefPtrHashKey
<
PermissionKey
>
(
std
:
:
move
(
toCopy
)
)
mPermissions
(
std
:
:
move
(
toCopy
.
mPermissions
)
)
{
}
bool
KeyEquals
(
const
PermissionKey
*
aKey
)
const
{
return
*
aKey
=
=
*
GetKey
(
)
;
}
static
PLDHashNumber
HashKey
(
const
PermissionKey
*
aKey
)
{
return
aKey
-
>
GetHashCode
(
)
;
}
enum
{
ALLOW_MEMMOVE
=
false
}
;
inline
nsTArray
<
PermissionEntry
>
&
GetPermissions
(
)
{
return
mPermissions
;
}
inline
int32_t
GetPermissionIndex
(
uint32_t
aType
)
const
{
for
(
uint32_t
i
=
0
;
i
<
mPermissions
.
Length
(
)
;
+
+
i
)
if
(
mPermissions
[
i
]
.
mType
=
=
aType
)
return
i
;
return
-
1
;
}
inline
PermissionEntry
GetPermission
(
uint32_t
aType
)
const
{
for
(
uint32_t
i
=
0
;
i
<
mPermissions
.
Length
(
)
;
+
+
i
)
if
(
mPermissions
[
i
]
.
mType
=
=
aType
)
return
mPermissions
[
i
]
;
return
PermissionEntry
(
-
1
aType
nsIPermissionManager
:
:
UNKNOWN_ACTION
nsIPermissionManager
:
:
EXPIRE_NEVER
0
0
)
;
}
private
:
AutoTArray
<
PermissionEntry
1
>
mPermissions
;
}
;
NS_DECL_ISUPPORTS
NS_DECL_NSIPERMISSIONMANAGER
NS_DECL_NSIOBSERVER
nsPermissionManager
(
)
;
static
already_AddRefed
<
nsIPermissionManager
>
GetXPCOMSingleton
(
)
;
static
nsPermissionManager
*
GetInstance
(
)
;
nsresult
Init
(
)
;
enum
OperationType
{
eOperationNone
eOperationAdding
eOperationRemoving
eOperationChanging
eOperationReplacingDefault
}
;
enum
DBOperationType
{
eNoDBOperation
eWriteToDB
}
;
enum
NotifyOperationType
{
eDontNotify
eNotify
}
;
static
const
int64_t
cIDPermissionIsDefault
=
-
1
;
nsresult
AddInternal
(
nsIPrincipal
*
aPrincipal
const
nsACString
&
aType
uint32_t
aPermission
int64_t
aID
uint32_t
aExpireType
int64_t
aExpireTime
int64_t
aModificationTime
NotifyOperationType
aNotifyOperation
DBOperationType
aDBOperation
const
bool
aIgnoreSessionPermissions
=
false
)
;
nsresult
TestPermissionWithoutDefaultsFromPrincipal
(
nsIPrincipal
*
aPrincipal
const
nsACString
&
aType
uint32_t
*
aPermission
)
{
MOZ_ASSERT
(
!
HasDefaultPref
(
aType
)
)
;
return
CommonTestPermission
(
aPrincipal
-
1
aType
aPermission
nsIPermissionManager
:
:
UNKNOWN_ACTION
true
false
true
)
;
}
nsresult
LegacyTestPermissionFromURI
(
nsIURI
*
aURI
const
mozilla
:
:
OriginAttributes
*
aOriginAttributes
const
nsACString
&
aType
uint32_t
*
aPermission
)
;
static
void
Startup
(
)
;
static
void
GetKeyForPrincipal
(
nsIPrincipal
*
aPrincipal
nsACString
&
aPermissionKey
)
;
static
void
GetKeyForOrigin
(
const
nsACString
&
aOrigin
nsACString
&
aPermissionKey
)
;
static
void
GetKeyForPermission
(
nsIPrincipal
*
aPrincipal
const
nsACString
&
aType
nsACString
&
aKey
)
;
static
nsTArray
<
nsCString
>
GetAllKeysForPrincipal
(
nsIPrincipal
*
aPrincipal
)
;
nsresult
RemoveAllFromIPC
(
)
;
bool
PermissionAvailable
(
nsIPrincipal
*
aPrincipal
const
nsACString
&
aType
)
;
void
GetPermissionsWithKey
(
const
nsACString
&
aPermissionKey
nsTArray
<
IPC
:
:
Permission
>
&
aPerms
)
;
void
SetPermissionsWithKey
(
const
nsACString
&
aPermissionKey
nsTArray
<
IPC
:
:
Permission
>
&
aPerms
)
;
void
WhenPermissionsAvailable
(
nsIPrincipal
*
aPrincipal
nsIRunnable
*
aRunnable
)
;
bool
HasPreloadPermissions
(
)
;
private
:
virtual
~
nsPermissionManager
(
)
;
static
bool
HasDefaultPref
(
const
nsACString
&
aType
)
{
static
const
nsLiteralCString
kPermissionsWithDefaults
[
]
=
{
NS_LITERAL_CSTRING
(
"
camera
"
)
NS_LITERAL_CSTRING
(
"
microphone
"
)
NS_LITERAL_CSTRING
(
"
geo
"
)
NS_LITERAL_CSTRING
(
"
desktop
-
notification
"
)
NS_LITERAL_CSTRING
(
"
shortcuts
"
)
}
;
if
(
!
aType
.
IsEmpty
(
)
)
{
for
(
const
auto
&
perm
:
kPermissionsWithDefaults
)
{
if
(
perm
.
Equals
(
aType
)
)
{
return
true
;
}
}
}
return
false
;
}
int32_t
GetTypeIndex
(
const
nsACString
&
aType
bool
aAdd
)
{
for
(
uint32_t
i
=
0
;
i
<
mTypeArray
.
length
(
)
;
+
+
i
)
{
if
(
mTypeArray
[
i
]
.
Equals
(
aType
)
)
{
return
i
;
}
}
if
(
!
aAdd
)
{
return
-
1
;
}
if
(
!
mTypeArray
.
emplaceBack
(
aType
)
)
{
return
-
1
;
}
return
mTypeArray
.
length
(
)
-
1
;
}
PermissionHashKey
*
GetPermissionHashKey
(
nsIPrincipal
*
aPrincipal
uint32_t
aType
bool
aExactHostMatch
)
;
PermissionHashKey
*
GetPermissionHashKey
(
nsIURI
*
aURI
const
mozilla
:
:
OriginAttributes
*
aOriginAttributes
uint32_t
aType
bool
aExactHostMatch
)
;
typedef
mozilla
:
:
Variant
<
int32_t
nsresult
>
TestPreparationResult
;
TestPreparationResult
CommonPrepareToTestPermission
(
nsIPrincipal
*
aPrincipal
int32_t
aTypeIndex
const
nsACString
&
aType
uint32_t
*
aPermission
uint32_t
aDefaultPermission
bool
aDefaultPermissionIsValid
bool
aExactHostMatch
bool
aIncludingSession
)
{
using
mozilla
:
:
AsVariant
;
auto
*
basePrin
=
mozilla
:
:
BasePrincipal
:
:
Cast
(
aPrincipal
)
;
if
(
basePrin
&
&
basePrin
-
>
IsSystemPrincipal
(
)
)
{
*
aPermission
=
ALLOW_ACTION
;
return
AsVariant
(
NS_OK
)
;
}
int32_t
defaultPermission
=
aDefaultPermissionIsValid
?
aDefaultPermission
:
UNKNOWN_ACTION
;
if
(
!
aDefaultPermissionIsValid
&
&
HasDefaultPref
(
aType
)
)
{
mozilla
:
:
Unused
<
<
mDefaultPrefBranch
-
>
GetIntPref
(
PromiseFlatCString
(
aType
)
.
get
(
)
&
defaultPermission
)
;
}
*
aPermission
=
defaultPermission
;
int32_t
typeIndex
=
aTypeIndex
=
=
-
1
?
GetTypeIndex
(
aType
false
)
:
aTypeIndex
;
if
(
basePrin
&
&
basePrin
-
>
Is
<
ExpandedPrincipal
>
(
)
)
{
auto
ep
=
basePrin
-
>
As
<
ExpandedPrincipal
>
(
)
;
for
(
auto
&
prin
:
ep
-
>
AllowList
(
)
)
{
uint32_t
perm
;
nsresult
rv
=
CommonTestPermission
(
prin
typeIndex
aType
&
perm
defaultPermission
true
aExactHostMatch
aIncludingSession
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
AsVariant
(
rv
)
;
}
if
(
perm
=
=
nsIPermissionManager
:
:
ALLOW_ACTION
)
{
*
aPermission
=
perm
;
return
AsVariant
(
NS_OK
)
;
}
if
(
perm
=
=
nsIPermissionManager
:
:
PROMPT_ACTION
)
{
*
aPermission
=
perm
;
}
}
return
AsVariant
(
NS_OK
)
;
}
if
(
typeIndex
=
=
-
1
)
{
return
AsVariant
(
NS_OK
)
;
}
return
AsVariant
(
typeIndex
)
;
}
nsresult
CommonTestPermission
(
nsIPrincipal
*
aPrincipal
int32_t
aTypeIndex
const
nsACString
&
aType
uint32_t
*
aPermission
uint32_t
aDefaultPermission
bool
aDefaultPermissionIsValid
bool
aExactHostMatch
bool
aIncludingSession
)
{
auto
preparationResult
=
CommonPrepareToTestPermission
(
aPrincipal
aTypeIndex
aType
aPermission
aDefaultPermission
aDefaultPermissionIsValid
aExactHostMatch
aIncludingSession
)
;
if
(
preparationResult
.
is
<
nsresult
>
(
)
)
{
return
preparationResult
.
as
<
nsresult
>
(
)
;
}
return
CommonTestPermissionInternal
(
aPrincipal
nullptr
nullptr
preparationResult
.
as
<
int32_t
>
(
)
aType
aPermission
aExactHostMatch
aIncludingSession
)
;
}
nsresult
CommonTestPermission
(
nsIURI
*
aURI
int32_t
aTypeIndex
const
nsACString
&
aType
uint32_t
*
aPermission
uint32_t
aDefaultPermission
bool
aDefaultPermissionIsValid
bool
aExactHostMatch
bool
aIncludingSession
)
{
auto
preparationResult
=
CommonPrepareToTestPermission
(
nullptr
aTypeIndex
aType
aPermission
aDefaultPermission
aDefaultPermissionIsValid
aExactHostMatch
aIncludingSession
)
;
if
(
preparationResult
.
is
<
nsresult
>
(
)
)
{
return
preparationResult
.
as
<
nsresult
>
(
)
;
}
return
CommonTestPermissionInternal
(
nullptr
aURI
nullptr
preparationResult
.
as
<
int32_t
>
(
)
aType
aPermission
aExactHostMatch
aIncludingSession
)
;
}
nsresult
CommonTestPermission
(
nsIURI
*
aURI
const
mozilla
:
:
OriginAttributes
*
aOriginAttributes
int32_t
aTypeIndex
const
nsACString
&
aType
uint32_t
*
aPermission
uint32_t
aDefaultPermission
bool
aDefaultPermissionIsValid
bool
aExactHostMatch
bool
aIncludingSession
)
{
auto
preparationResult
=
CommonPrepareToTestPermission
(
nullptr
aTypeIndex
aType
aPermission
aDefaultPermission
aDefaultPermissionIsValid
aExactHostMatch
aIncludingSession
)
;
if
(
preparationResult
.
is
<
nsresult
>
(
)
)
{
return
preparationResult
.
as
<
nsresult
>
(
)
;
}
return
CommonTestPermissionInternal
(
nullptr
aURI
aOriginAttributes
preparationResult
.
as
<
int32_t
>
(
)
aType
aPermission
aExactHostMatch
aIncludingSession
)
;
}
nsresult
CommonTestPermissionInternal
(
nsIPrincipal
*
aPrincipal
nsIURI
*
aURI
const
mozilla
:
:
OriginAttributes
*
aOriginAttributes
int32_t
aTypeIndex
const
nsACString
&
aType
uint32_t
*
aPermission
bool
aExactHostMatch
bool
aIncludingSession
)
;
nsresult
OpenDatabase
(
nsIFile
*
permissionsFile
)
;
nsresult
InitDB
(
bool
aRemoveFile
)
;
nsresult
CreateTable
(
)
;
nsresult
ImportDefaults
(
)
;
nsresult
_DoImport
(
nsIInputStream
*
inputStream
mozIStorageConnection
*
aConn
)
;
nsresult
Read
(
)
;
void
NotifyObserversWithPermission
(
nsIPrincipal
*
aPrincipal
const
nsACString
&
aType
uint32_t
aPermission
uint32_t
aExpireType
int64_t
aExpireTime
int64_t
aModificationTime
const
char16_t
*
aData
)
;
void
NotifyObservers
(
nsIPermission
*
aPermission
const
char16_t
*
aData
)
;
void
CloseDB
(
bool
aRebuildOnSuccess
=
false
)
;
nsresult
RemoveAllInternal
(
bool
aNotifyObservers
)
;
nsresult
RemoveAllFromMemory
(
)
;
static
void
UpdateDB
(
OperationType
aOp
mozIStorageAsyncStatement
*
aStmt
int64_t
aID
const
nsACString
&
aOrigin
const
nsACString
&
aType
uint32_t
aPermission
uint32_t
aExpireType
int64_t
aExpireTime
int64_t
aModificationTime
)
;
nsresult
RemoveAllModifiedSince
(
int64_t
aModificationTime
)
;
template
<
class
T
>
nsresult
RemovePermissionEntries
(
T
aCondition
)
;
nsresult
RemovePermissionsWithAttributes
(
const
nsAString
&
aPattern
)
;
nsresult
RemovePermissionsWithAttributes
(
mozilla
:
:
OriginAttributesPattern
&
aAttrs
)
;
nsRefPtrHashtable
<
nsCStringHashKey
mozilla
:
:
GenericNonExclusivePromise
:
:
Private
>
mPermissionKeyPromiseMap
;
nsCOMPtr
<
mozIStorageConnection
>
mDBConn
;
nsCOMPtr
<
mozIStorageAsyncStatement
>
mStmtInsert
;
nsCOMPtr
<
mozIStorageAsyncStatement
>
mStmtDelete
;
nsCOMPtr
<
mozIStorageAsyncStatement
>
mStmtUpdate
;
bool
mMemoryOnlyDB
;
nsTHashtable
<
PermissionHashKey
>
mPermissionTable
;
int64_t
mLargestID
;
nsCOMPtr
<
nsIPrefBranch
>
mDefaultPrefBranch
;
mozilla
:
:
Vector
<
nsCString
512
>
mTypeArray
;
friend
class
DeleteFromMozHostListener
;
friend
class
CloseDatabaseListener
;
}
;
#
define
NS_PERMISSIONMANAGER_CID
\
{
\
0x4f6b5e00
0xc36
0x11d5
{
\
0xa5
0x35
0x0
0x10
0xa4
0x1
0xeb
0x10
\
}
\
}
#
endif
