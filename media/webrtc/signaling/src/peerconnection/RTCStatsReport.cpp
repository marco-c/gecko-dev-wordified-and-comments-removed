#
include
"
RTCStatsReport
.
h
"
#
include
"
mozilla
/
dom
/
Performance
.
h
"
#
include
"
nsRFPService
.
h
"
namespace
mozilla
{
namespace
dom
{
RTCStatsTimestampMaker
:
:
RTCStatsTimestampMaker
(
const
GlobalObject
*
aGlobal
)
{
nsCOMPtr
<
nsPIDOMWindowInner
>
window
=
do_QueryInterface
(
aGlobal
-
>
GetAsSupports
(
)
)
;
if
(
window
)
{
mRandomTimelineSeed
=
window
-
>
GetPerformance
(
)
-
>
GetRandomTimelineSeed
(
)
;
mStartWallClock
=
window
-
>
GetPerformance
(
)
-
>
TimeOrigin
(
)
;
mStartMonotonic
=
window
-
>
GetPerformance
(
)
-
>
CreationTimeStamp
(
)
;
}
}
DOMHighResTimeStamp
RTCStatsTimestampMaker
:
:
GetNow
(
)
const
{
TimeStamp
nowMonotonic
=
TimeStamp
:
:
NowUnfuzzed
(
)
;
DOMHighResTimeStamp
msSinceStart
=
(
nowMonotonic
-
mStartMonotonic
)
.
ToMilliseconds
(
)
;
DOMHighResTimeStamp
rawTime
=
mStartWallClock
+
msSinceStart
;
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
rawTime
mRandomTimelineSeed
)
;
}
NS_IMPL_CYCLE_COLLECTION_WRAPPERCACHE
(
RTCStatsReport
mParent
)
NS_IMPL_CYCLE_COLLECTION_ROOT_NATIVE
(
RTCStatsReport
AddRef
)
NS_IMPL_CYCLE_COLLECTION_UNROOT_NATIVE
(
RTCStatsReport
Release
)
RTCStatsReport
:
:
RTCStatsReport
(
nsPIDOMWindowInner
*
aParent
)
:
mParent
(
aParent
)
{
}
already_AddRefed
<
RTCStatsReport
>
RTCStatsReport
:
:
Constructor
(
const
GlobalObject
&
aGlobal
)
{
nsCOMPtr
<
nsPIDOMWindowInner
>
window
(
do_QueryInterface
(
aGlobal
.
GetAsSupports
(
)
)
)
;
RefPtr
<
RTCStatsReport
>
report
(
new
RTCStatsReport
(
window
)
)
;
return
report
.
forget
(
)
;
}
JSObject
*
RTCStatsReport
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
RTCStatsReport_Binding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
void
RTCStatsReport
:
:
Incorporate
(
RTCStatsCollection
&
aStats
)
{
SetRTCStats
(
aStats
.
mIceCandidatePairStats
)
;
SetRTCStats
(
aStats
.
mIceCandidateStats
)
;
SetRTCStats
(
aStats
.
mInboundRtpStreamStats
)
;
SetRTCStats
(
aStats
.
mOutboundRtpStreamStats
)
;
SetRTCStats
(
aStats
.
mRemoteInboundRtpStreamStats
)
;
SetRTCStats
(
aStats
.
mRemoteOutboundRtpStreamStats
)
;
SetRTCStats
(
aStats
.
mRtpContributingSourceStats
)
;
SetRTCStats
(
aStats
.
mTrickledIceCandidateStats
)
;
}
void
RTCStatsReport
:
:
Set
(
const
nsAString
&
aKey
JS
:
:
Handle
<
JSObject
*
>
aValue
ErrorResult
&
aRv
)
{
RTCStatsReport_Binding
:
:
MaplikeHelpers
:
:
Set
(
this
aKey
aValue
aRv
)
;
}
}
}
