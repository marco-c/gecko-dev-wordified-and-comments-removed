#
ifndef
MEDIA_CONDUIT_ABSTRACTION_
#
define
MEDIA_CONDUIT_ABSTRACTION_
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsXPCOM
.
h
"
#
include
"
nsDOMNavigationTiming
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
RefCounted
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
utils
.
h
"
#
include
"
CodecConfig
.
h
"
#
include
"
VideoTypes
.
h
"
#
include
"
MediaConduitErrors
.
h
"
#
include
"
ImageContainer
.
h
"
#
include
"
webrtc
/
call
.
h
"
#
include
"
webrtc
/
config
.
h
"
#
include
"
webrtc
/
common_types
.
h
"
#
include
<
vector
>
namespace
webrtc
{
class
VideoFrame
;
}
namespace
mozilla
{
class
WebRtcCallWrapper
:
public
RefCounted
<
WebRtcCallWrapper
>
{
public
:
typedef
webrtc
:
:
Call
:
:
Config
Config
;
static
RefPtr
<
WebRtcCallWrapper
>
Create
(
const
Config
&
config
)
{
return
new
WebRtcCallWrapper
(
webrtc
:
:
Call
:
:
Create
(
config
)
)
;
}
webrtc
:
:
Call
*
Call
(
)
const
{
return
mCall
.
get
(
)
;
}
virtual
~
WebRtcCallWrapper
(
)
{
if
(
mCall
-
>
voice_engine
(
)
)
{
webrtc
:
:
VoiceEngine
*
voice_engine
=
mCall
-
>
voice_engine
(
)
;
mCall
.
reset
(
nullptr
)
;
webrtc
:
:
VoiceEngine
:
:
Delete
(
voice_engine
)
;
}
}
MOZ_DECLARE_REFCOUNTED_TYPENAME
(
WebRtcCallWrapper
)
private
:
WebRtcCallWrapper
(
)
=
delete
;
explicit
WebRtcCallWrapper
(
webrtc
:
:
Call
*
aCall
)
:
mCall
(
aCall
)
{
}
DISALLOW_COPY_AND_ASSIGN
(
WebRtcCallWrapper
)
;
UniquePtr
<
webrtc
:
:
Call
>
mCall
;
}
;
class
TransportInterface
{
protected
:
virtual
~
TransportInterface
(
)
{
}
public
:
virtual
nsresult
SendRtpPacket
(
const
uint8_t
*
data
size_t
len
)
=
0
;
virtual
nsresult
SendRtcpPacket
(
const
uint8_t
*
data
size_t
len
)
=
0
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
TransportInterface
)
}
;
class
ImageHandle
{
public
:
explicit
ImageHandle
(
layers
:
:
Image
*
image
)
:
mImage
(
image
)
{
}
const
RefPtr
<
layers
:
:
Image
>
&
GetImage
(
)
const
{
return
mImage
;
}
private
:
RefPtr
<
layers
:
:
Image
>
mImage
;
}
;
class
VideoRenderer
{
protected
:
virtual
~
VideoRenderer
(
)
{
}
public
:
virtual
void
FrameSizeChange
(
unsigned
int
width
unsigned
int
height
unsigned
int
number_of_streams
)
=
0
;
virtual
void
RenderVideoFrame
(
const
unsigned
char
*
buffer
size_t
buffer_size
uint32_t
time_stamp
int64_t
render_time
const
ImageHandle
&
handle
)
=
0
;
virtual
void
RenderVideoFrame
(
const
unsigned
char
*
buffer
size_t
buffer_size
uint32_t
y_stride
uint32_t
cbcr_stride
uint32_t
time_stamp
int64_t
render_time
const
ImageHandle
&
handle
)
=
0
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
VideoRenderer
)
}
;
class
MediaSessionConduit
{
protected
:
virtual
~
MediaSessionConduit
(
)
{
}
public
:
enum
Type
{
AUDIO
VIDEO
}
;
virtual
Type
type
(
)
const
=
0
;
virtual
MediaConduitErrorCode
ReceivedRTPPacket
(
const
void
*
data
int
len
)
=
0
;
virtual
MediaConduitErrorCode
ReceivedRTCPPacket
(
const
void
*
data
int
len
)
=
0
;
virtual
MediaConduitErrorCode
StopTransmitting
(
)
=
0
;
virtual
MediaConduitErrorCode
StartTransmitting
(
)
=
0
;
virtual
MediaConduitErrorCode
StopReceiving
(
)
=
0
;
virtual
MediaConduitErrorCode
StartReceiving
(
)
=
0
;
virtual
MediaConduitErrorCode
SetTransmitterTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
=
0
;
virtual
MediaConduitErrorCode
SetReceiverTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
=
0
;
virtual
bool
SetLocalSSRCs
(
const
std
:
:
vector
<
unsigned
int
>
&
aSSRCs
)
=
0
;
virtual
std
:
:
vector
<
unsigned
int
>
GetLocalSSRCs
(
)
const
=
0
;
virtual
bool
GetRemoteSSRC
(
unsigned
int
*
ssrc
)
=
0
;
virtual
bool
SetRemoteSSRC
(
unsigned
int
ssrc
)
=
0
;
virtual
bool
SetLocalCNAME
(
const
char
*
cname
)
=
0
;
virtual
bool
GetVideoEncoderStats
(
double
*
framerateMean
double
*
framerateStdDev
double
*
bitrateMean
double
*
bitrateStdDev
uint32_t
*
droppedFrames
)
=
0
;
virtual
bool
GetVideoDecoderStats
(
double
*
framerateMean
double
*
framerateStdDev
double
*
bitrateMean
double
*
bitrateStdDev
uint32_t
*
discardedPackets
)
=
0
;
virtual
bool
GetAVStats
(
int32_t
*
jitterBufferDelayMs
int32_t
*
playoutBufferDelayMs
int32_t
*
avSyncOffsetMs
)
=
0
;
virtual
bool
GetRTPStats
(
unsigned
int
*
jitterMs
unsigned
int
*
cumulativeLost
)
=
0
;
virtual
bool
GetRTCPReceiverReport
(
DOMHighResTimeStamp
*
timestamp
uint32_t
*
jitterMs
uint32_t
*
packetsReceived
uint64_t
*
bytesReceived
uint32_t
*
cumulativeLost
int32_t
*
rttMs
)
=
0
;
virtual
bool
GetRTCPSenderReport
(
DOMHighResTimeStamp
*
timestamp
unsigned
int
*
packetsSent
uint64_t
*
bytesSent
)
=
0
;
virtual
uint64_t
CodecPluginID
(
)
=
0
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
MediaSessionConduit
)
}
;
class
CodecPluginID
{
public
:
virtual
~
CodecPluginID
(
)
{
}
virtual
uint64_t
PluginID
(
)
const
=
0
;
}
;
class
VideoEncoder
:
public
CodecPluginID
{
public
:
virtual
~
VideoEncoder
(
)
{
}
}
;
class
VideoDecoder
:
public
CodecPluginID
{
public
:
virtual
~
VideoDecoder
(
)
{
}
}
;
class
VideoSessionConduit
:
public
MediaSessionConduit
{
public
:
static
RefPtr
<
VideoSessionConduit
>
Create
(
RefPtr
<
WebRtcCallWrapper
>
aCall
)
;
enum
FrameRequestType
{
FrameRequestNone
FrameRequestFir
FrameRequestPli
FrameRequestUnknown
}
;
VideoSessionConduit
(
)
:
mFrameRequestMethod
(
FrameRequestNone
)
mUsingNackBasic
(
false
)
mUsingTmmbr
(
false
)
mUsingFEC
(
false
)
{
}
virtual
~
VideoSessionConduit
(
)
{
}
virtual
Type
type
(
)
const
{
return
VIDEO
;
}
virtual
void
AddLocalRTPExtensions
(
bool
aIsSend
const
std
:
:
vector
<
webrtc
:
:
RtpExtension
>
&
extensions
)
=
0
;
virtual
std
:
:
vector
<
webrtc
:
:
RtpExtension
>
GetLocalRTPExtensions
(
bool
aIsSend
)
const
=
0
;
virtual
MediaConduitErrorCode
AttachRenderer
(
RefPtr
<
mozilla
:
:
VideoRenderer
>
aRenderer
)
=
0
;
virtual
void
DetachRenderer
(
)
=
0
;
virtual
bool
SetRemoteSSRC
(
unsigned
int
ssrc
)
=
0
;
virtual
MediaConduitErrorCode
SendVideoFrame
(
unsigned
char
*
video_frame
unsigned
int
video_frame_length
unsigned
short
width
unsigned
short
height
VideoType
video_type
uint64_t
capture_time
)
=
0
;
virtual
MediaConduitErrorCode
SendVideoFrame
(
webrtc
:
:
VideoFrame
&
frame
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureCodecMode
(
webrtc
:
:
VideoCodecMode
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureSendMediaCodec
(
const
VideoCodecConfig
*
sendSessionConfig
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureRecvMediaCodecs
(
const
std
:
:
vector
<
VideoCodecConfig
*
>
&
recvCodecConfigList
)
=
0
;
virtual
unsigned
short
SendingWidth
(
)
=
0
;
virtual
unsigned
short
SendingHeight
(
)
=
0
;
virtual
unsigned
int
SendingMaxFs
(
)
=
0
;
virtual
unsigned
int
SendingMaxFr
(
)
=
0
;
FrameRequestType
FrameRequestMethod
(
)
const
{
return
mFrameRequestMethod
;
}
bool
UsingNackBasic
(
)
const
{
return
mUsingNackBasic
;
}
bool
UsingTmmbr
(
)
const
{
return
mUsingTmmbr
;
}
bool
UsingFEC
(
)
const
{
return
mUsingFEC
;
}
protected
:
FrameRequestType
mFrameRequestMethod
;
bool
mUsingNackBasic
;
bool
mUsingTmmbr
;
bool
mUsingFEC
;
}
;
class
AudioSessionConduit
:
public
MediaSessionConduit
{
public
:
static
RefPtr
<
AudioSessionConduit
>
Create
(
)
;
virtual
~
AudioSessionConduit
(
)
{
}
virtual
Type
type
(
)
const
{
return
AUDIO
;
}
virtual
MediaConduitErrorCode
SendAudioFrame
(
const
int16_t
audioData
[
]
int32_t
lengthSamples
int32_t
samplingFreqHz
int32_t
capture_delay
)
=
0
;
virtual
MediaConduitErrorCode
GetAudioFrame
(
int16_t
speechData
[
]
int32_t
samplingFreqHz
int32_t
capture_delay
int
&
lengthSamples
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureSendMediaCodec
(
const
AudioCodecConfig
*
sendCodecConfig
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureRecvMediaCodecs
(
const
std
:
:
vector
<
AudioCodecConfig
*
>
&
recvCodecConfigList
)
=
0
;
virtual
MediaConduitErrorCode
EnableAudioLevelExtension
(
bool
enabled
uint8_t
id
)
=
0
;
virtual
bool
SetDtmfPayloadType
(
unsigned
char
type
)
=
0
;
virtual
bool
InsertDTMFTone
(
int
channel
int
eventCode
bool
outOfBand
int
lengthMs
int
attenuationDb
)
=
0
;
}
;
}
#
endif
