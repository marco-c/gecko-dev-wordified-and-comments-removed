#
ifndef
VIDEO_SESSION_H_
#
define
VIDEO_SESSION_H_
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
ReentrantMonitor
.
h
"
#
include
"
mozilla
/
SharedThreadPool
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
MediaConduitInterface
.
h
"
#
include
"
MediaEngineWrapper
.
h
"
#
include
"
RunningStat
.
h
"
#
include
"
runnable_utils
.
h
"
#
undef
FF
#
include
"
webrtc
/
call
.
h
"
#
include
"
webrtc
/
common_types
.
h
"
#
ifdef
FF
#
undef
FF
/
/
Avoid
name
collision
between
scoped_ptr
.
h
and
nsCRTGlue
.
h
.
#
endif
#
include
"
webrtc
/
video_decoder
.
h
"
#
include
"
webrtc
/
video_encoder
.
h
"
#
include
"
webrtc
/
config
.
h
"
#
include
"
webrtc
/
media
/
base
/
videosinkinterface
.
h
"
#
include
"
webrtc
/
media
/
base
/
videoadapter
.
h
"
#
include
"
webrtc
/
media
/
base
/
videobroadcaster
.
h
"
#
include
<
functional
>
#
include
<
memory
>
namespace
mozilla
{
const
unsigned
int
kVideoMtu
=
1200
;
const
int
kQpMax
=
56
;
class
WebrtcAudioConduit
;
class
nsThread
;
class
WebrtcVideoEncoder
:
public
VideoEncoder
public
webrtc
:
:
VideoEncoder
{
}
;
class
WebrtcVideoDecoder
:
public
VideoDecoder
public
webrtc
:
:
VideoDecoder
{
}
;
class
WebrtcVideoConduit
:
public
VideoSessionConduit
public
webrtc
:
:
Transport
public
rtc
:
:
VideoSinkInterface
<
webrtc
:
:
VideoFrame
>
public
rtc
:
:
VideoSourceInterface
<
webrtc
:
:
VideoFrame
>
{
public
:
static
const
uint32_t
kDefaultMinBitrate_bps
;
static
const
uint32_t
kDefaultStartBitrate_bps
;
static
const
uint32_t
kDefaultMaxBitrate_bps
;
static
const
unsigned
int
CODEC_PLNAME_SIZE
;
void
SetLocalRTPExtensions
(
bool
aIsSend
const
RtpExtList
&
extensions
)
override
;
RtpExtList
GetLocalRTPExtensions
(
bool
aIsSend
)
const
override
;
void
SyncTo
(
WebrtcAudioConduit
*
aConduit
)
;
virtual
MediaConduitErrorCode
AttachRenderer
(
RefPtr
<
mozilla
:
:
VideoRenderer
>
aVideoRenderer
)
override
;
virtual
void
DetachRenderer
(
)
override
;
virtual
MediaConduitErrorCode
ReceivedRTPPacket
(
const
void
*
data
int
len
uint32_t
ssrc
)
override
;
virtual
MediaConduitErrorCode
ReceivedRTCPPacket
(
const
void
*
data
int
len
)
override
;
virtual
MediaConduitErrorCode
StopTransmitting
(
)
override
;
virtual
MediaConduitErrorCode
StartTransmitting
(
)
override
;
virtual
MediaConduitErrorCode
StopReceiving
(
)
override
;
virtual
MediaConduitErrorCode
StartReceiving
(
)
override
;
virtual
MediaConduitErrorCode
ConfigureCodecMode
(
webrtc
:
:
VideoCodecMode
)
override
;
virtual
MediaConduitErrorCode
ConfigureSendMediaCodec
(
const
VideoCodecConfig
*
codecInfo
)
override
;
virtual
MediaConduitErrorCode
ConfigureRecvMediaCodecs
(
const
std
:
:
vector
<
VideoCodecConfig
*
>
&
codecConfigList
)
override
;
virtual
MediaConduitErrorCode
SetTransmitterTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
override
;
virtual
MediaConduitErrorCode
SetReceiverTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
override
;
void
SelectBitrates
(
unsigned
short
width
unsigned
short
height
int
cap
int32_t
aLastFramerateTenths
webrtc
:
:
VideoStream
&
aVideoStream
)
;
void
SelectSendResolution
(
unsigned
short
width
unsigned
short
height
)
;
unsigned
int
SelectSendFrameRate
(
const
VideoCodecConfig
*
codecConfig
unsigned
int
old_framerate
unsigned
short
sending_width
unsigned
short
sending_height
)
const
;
virtual
MediaConduitErrorCode
SendVideoFrame
(
const
webrtc
:
:
VideoFrame
&
frame
)
override
;
virtual
bool
SendRtp
(
const
uint8_t
*
packet
size_t
length
const
webrtc
:
:
PacketOptions
&
options
)
override
;
virtual
bool
SendRtcp
(
const
uint8_t
*
packet
size_t
length
)
override
;
virtual
void
OnFrame
(
const
webrtc
:
:
VideoFrame
&
frame
)
override
;
void
AddOrUpdateSink
(
rtc
:
:
VideoSinkInterface
<
webrtc
:
:
VideoFrame
>
*
sink
const
rtc
:
:
VideoSinkWants
&
wants
)
override
;
void
RemoveSink
(
rtc
:
:
VideoSinkInterface
<
webrtc
:
:
VideoFrame
>
*
sink
)
override
;
void
OnSinkWantsChanged
(
const
rtc
:
:
VideoSinkWants
&
wants
)
;
virtual
uint64_t
CodecPluginID
(
)
override
;
virtual
void
SetPCHandle
(
const
std
:
:
string
&
aPCHandle
)
override
{
mPCHandle
=
aPCHandle
;
}
unsigned
int
SendingMaxFs
(
)
override
{
if
(
mCurSendCodecConfig
)
{
return
mCurSendCodecConfig
-
>
mEncodingConstraints
.
maxFs
;
}
return
0
;
}
unsigned
int
SendingMaxFr
(
)
override
{
if
(
mCurSendCodecConfig
)
{
return
mCurSendCodecConfig
-
>
mEncodingConstraints
.
maxFps
;
}
return
0
;
}
bool
Denoising
(
)
const
{
return
mDenoising
;
}
uint8_t
SpatialLayers
(
)
const
{
return
mSpatialLayers
;
}
uint8_t
TemporalLayers
(
)
const
{
return
mTemporalLayers
;
}
webrtc
:
:
VideoCodecMode
CodecMode
(
)
const
{
return
mCodecMode
;
}
WebrtcVideoConduit
(
RefPtr
<
WebRtcCallWrapper
>
aCall
UniquePtr
<
cricket
:
:
VideoAdapter
>
&
&
aVideoAdapter
)
;
virtual
~
WebrtcVideoConduit
(
)
;
MediaConduitErrorCode
InitMain
(
)
;
virtual
MediaConduitErrorCode
Init
(
)
;
virtual
void
Destroy
(
)
;
std
:
:
vector
<
unsigned
int
>
GetLocalSSRCs
(
)
const
override
;
bool
SetLocalSSRCs
(
const
std
:
:
vector
<
unsigned
int
>
&
ssrcs
)
override
;
bool
GetRemoteSSRC
(
unsigned
int
*
ssrc
)
override
;
bool
SetRemoteSSRC
(
unsigned
int
ssrc
)
override
;
bool
SetLocalCNAME
(
const
char
*
cname
)
override
;
bool
SetLocalMID
(
const
std
:
:
string
&
mid
)
override
;
bool
GetSendPacketTypeStats
(
webrtc
:
:
RtcpPacketTypeCounter
*
aPacketCounts
)
override
;
bool
GetRecvPacketTypeStats
(
webrtc
:
:
RtcpPacketTypeCounter
*
aPacketCounts
)
override
;
bool
GetVideoEncoderStats
(
double
*
framerateMean
double
*
framerateStdDev
double
*
bitrateMean
double
*
bitrateStdDev
uint32_t
*
droppedFrames
uint32_t
*
framesEncoded
)
override
;
bool
GetVideoDecoderStats
(
double
*
framerateMean
double
*
framerateStdDev
double
*
bitrateMean
double
*
bitrateStdDev
uint32_t
*
discardedPackets
uint32_t
*
framesDecoded
)
override
;
bool
GetAVStats
(
int32_t
*
jitterBufferDelayMs
int32_t
*
playoutBufferDelayMs
int32_t
*
avSyncOffsetMs
)
override
;
bool
GetRTPStats
(
unsigned
int
*
jitterMs
unsigned
int
*
cumulativeLost
)
override
;
bool
GetRTCPReceiverReport
(
DOMHighResTimeStamp
*
timestamp
uint32_t
*
jitterMs
uint32_t
*
packetsReceived
uint64_t
*
bytesReceived
uint32_t
*
cumulativeLost
int32_t
*
rttMs
)
override
;
bool
GetRTCPSenderReport
(
DOMHighResTimeStamp
*
timestamp
unsigned
int
*
packetsSent
uint64_t
*
bytesSent
)
override
;
uint64_t
MozVideoLatencyAvg
(
)
;
private
:
DISALLOW_COPY_AND_ASSIGN
(
WebrtcVideoConduit
)
;
class
StreamStatistics
{
public
:
void
Update
(
const
double
aFrameRate
const
double
aBitrate
)
;
bool
GetVideoStreamStats
(
double
&
aOutFrMean
double
&
aOutFrStdDev
double
&
aOutBrMean
double
&
aOutBrStdDev
)
const
;
private
:
RunningStat
mFrameRate
;
RunningStat
mBitrate
;
}
;
class
SendStreamStatistics
:
public
StreamStatistics
{
public
:
void
DroppedFrames
(
uint32_t
&
aOutDroppedFrames
)
const
;
uint32_t
FramesEncoded
(
)
const
{
return
mFramesEncoded
;
}
void
Update
(
const
webrtc
:
:
VideoSendStream
:
:
Stats
&
aStats
)
;
void
FrameDeliveredToEncoder
(
)
{
+
+
mFramesDeliveredToEncoder
;
}
private
:
uint32_t
mDroppedFrames
=
0
;
uint32_t
mFramesEncoded
=
0
;
mozilla
:
:
Atomic
<
int32_t
>
mFramesDeliveredToEncoder
;
}
;
class
ReceiveStreamStatistics
:
public
StreamStatistics
{
public
:
void
DiscardedPackets
(
uint32_t
&
aOutDiscPackets
)
const
;
void
FramesDecoded
(
uint32_t
&
aFramesDecoded
)
const
;
void
Update
(
const
webrtc
:
:
VideoReceiveStream
:
:
Stats
&
aStats
)
;
private
:
uint32_t
mDiscardedPackets
=
0
;
uint32_t
mFramesDecoded
=
0
;
}
;
class
VideoStreamFactory
;
class
VideoEncoderConfigBuilder
{
public
:
class
SimulcastStreamConfig
{
public
:
int
jsMaxBitrate
;
double
jsScaleDownBy
=
1
.
0
;
}
;
void
SetEncoderSpecificSettings
(
rtc
:
:
scoped_refptr
<
webrtc
:
:
VideoEncoderConfig
:
:
EncoderSpecificSettings
>
aSettings
)
;
void
SetVideoStreamFactory
(
rtc
:
:
scoped_refptr
<
WebrtcVideoConduit
:
:
VideoStreamFactory
>
aFactory
)
;
void
SetMinTransmitBitrateBps
(
int
aXmitMinBps
)
;
void
SetContentType
(
webrtc
:
:
VideoEncoderConfig
:
:
ContentType
aContentType
)
;
void
SetResolutionDivisor
(
unsigned
char
aDivisor
)
;
void
SetMaxEncodings
(
size_t
aMaxStreams
)
;
void
AddStream
(
webrtc
:
:
VideoStream
aStream
)
;
void
AddStream
(
webrtc
:
:
VideoStream
aStream
const
SimulcastStreamConfig
&
aSimulcastConfig
)
;
size_t
StreamCount
(
)
const
;
void
ClearStreams
(
)
;
void
ForEachStream
(
const
std
:
:
function
<
void
(
webrtc
:
:
VideoStream
&
SimulcastStreamConfig
&
const
size_t
index
)
>
&
&
f
)
;
webrtc
:
:
VideoEncoderConfig
CopyConfig
(
)
const
{
return
mConfig
.
Copy
(
)
;
}
size_t
NumberOfStreams
(
)
const
{
return
mConfig
.
number_of_streams
;
}
private
:
webrtc
:
:
VideoEncoderConfig
mConfig
;
std
:
:
vector
<
SimulcastStreamConfig
>
mSimulcastStreams
;
}
;
void
CodecConfigToWebRTCCodec
(
const
VideoCodecConfig
*
codecInfo
webrtc
:
:
VideoCodec
&
cinst
)
;
MediaConduitErrorCode
ValidateCodecConfig
(
const
VideoCodecConfig
*
codecInfo
)
;
void
DumpCodecDB
(
)
const
;
bool
CodecsDifferent
(
const
nsTArray
<
UniquePtr
<
VideoCodecConfig
>
>
&
a
const
nsTArray
<
UniquePtr
<
VideoCodecConfig
>
>
&
b
)
;
class
VideoStreamFactory
:
public
webrtc
:
:
VideoEncoderConfig
:
:
VideoStreamFactoryInterface
{
public
:
VideoStreamFactory
(
const
std
:
:
string
&
aCodecName
WebrtcVideoConduit
*
aConduit
)
:
mCodecName
(
aCodecName
)
mConduit
(
aConduit
)
{
}
private
:
std
:
:
vector
<
webrtc
:
:
VideoStream
>
CreateEncoderStreams
(
int
width
int
height
const
webrtc
:
:
VideoEncoderConfig
&
config
)
override
;
std
:
:
string
mCodecName
;
WebrtcVideoConduit
*
mConduit
;
}
;
void
VideoLatencyUpdate
(
uint64_t
new_sample
)
;
MediaConduitErrorCode
CreateSendStream
(
)
;
void
DeleteSendStream
(
)
;
MediaConduitErrorCode
CreateRecvStream
(
)
;
void
DeleteRecvStream
(
)
;
webrtc
:
:
VideoDecoder
*
CreateDecoder
(
webrtc
:
:
VideoCodecType
aType
)
;
webrtc
:
:
VideoEncoder
*
CreateEncoder
(
webrtc
:
:
VideoCodecType
aType
bool
enable_simulcast
)
;
MediaConduitErrorCode
DeliverPacket
(
const
void
*
data
int
len
)
;
bool
RequiresNewSendStream
(
const
VideoCodecConfig
&
newConfig
)
const
;
mozilla
:
:
ReentrantMonitor
mTransportMonitor
;
RefPtr
<
TransportInterface
>
mTransmitterTransport
;
RefPtr
<
TransportInterface
>
mReceiverTransport
;
RefPtr
<
mozilla
:
:
VideoRenderer
>
mRenderer
;
UniquePtr
<
cricket
:
:
VideoAdapter
>
mVideoAdapter
;
rtc
:
:
VideoBroadcaster
mVideoBroadcaster
;
mozilla
:
:
Atomic
<
bool
>
mEngineTransmitting
;
mozilla
:
:
Atomic
<
bool
>
mEngineReceiving
;
int
mCapId
;
nsTArray
<
UniquePtr
<
VideoCodecConfig
>
>
mRecvCodecList
;
Mutex
mCodecMutex
;
nsAutoPtr
<
VideoCodecConfig
>
mCurSendCodecConfig
;
SendStreamStatistics
mSendStreamStats
;
ReceiveStreamStatistics
mRecvStreamStats
;
webrtc
:
:
RtcpPacketTypeCounter
mSendPacketCounts
;
webrtc
:
:
RtcpPacketTypeCounter
mRecvPacketCounts
;
webrtc
:
:
VideoReceiveStream
*
mRecvStream
;
webrtc
:
:
VideoSendStream
*
mSendStream
;
unsigned
short
mLastWidth
;
unsigned
short
mLastHeight
;
unsigned
short
mSendingWidth
;
unsigned
short
mSendingHeight
;
unsigned
short
mReceivingWidth
;
unsigned
short
mReceivingHeight
;
unsigned
int
mSendingFramerate
;
mozilla
:
:
Atomic
<
int32_t
mozilla
:
:
Relaxed
>
mLastFramerateTenths
;
unsigned
short
mNumReceivingStreams
;
bool
mVideoLatencyTestEnable
;
uint64_t
mVideoLatencyAvg
;
int
mMinBitrate
;
int
mStartBitrate
;
int
mPrefMaxBitrate
;
int
mNegotiatedMaxBitrate
;
int
mMinBitrateEstimate
;
bool
mDenoising
;
bool
mLockScaling
;
uint8_t
mSpatialLayers
;
uint8_t
mTemporalLayers
;
rtc
:
:
VideoSinkWants
mLastSinkWanted
;
static
const
unsigned
int
sAlphaNum
=
7
;
static
const
unsigned
int
sAlphaDen
=
8
;
static
const
unsigned
int
sRoundingPadding
=
1024
;
RefPtr
<
WebrtcAudioConduit
>
mSyncedTo
;
webrtc
:
:
VideoCodecMode
mCodecMode
;
RefPtr
<
WebRtcCallWrapper
>
mCall
;
webrtc
:
:
VideoSendStream
:
:
Config
mSendStreamConfig
;
VideoEncoderConfigBuilder
mEncoderConfig
;
webrtc
:
:
VideoReceiveStream
:
:
Config
mRecvStreamConfig
;
uint32_t
mRecvSSRC
;
bool
mRecvSSRCSetInProgress
;
struct
QueuedPacket
{
int
mLen
;
uint8_t
mData
[
1
]
;
}
;
nsTArray
<
UniquePtr
<
QueuedPacket
>
>
mQueuedPackets
;
nsAutoPtr
<
webrtc
:
:
VideoEncoder
>
mEncoder
;
std
:
:
vector
<
std
:
:
unique_ptr
<
webrtc
:
:
VideoDecoder
>
>
mDecoders
;
WebrtcVideoEncoder
*
mSendCodecPlugin
;
WebrtcVideoDecoder
*
mRecvCodecPlugin
;
nsCOMPtr
<
nsITimer
>
mVideoStatsTimer
;
std
:
:
string
mPCHandle
;
}
;
}
#
endif
