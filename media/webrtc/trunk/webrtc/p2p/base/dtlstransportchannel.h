#
ifndef
WEBRTC_P2P_BASE_DTLSTRANSPORTCHANNEL_H_
#
define
WEBRTC_P2P_BASE_DTLSTRANSPORTCHANNEL_H_
#
include
<
memory
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
webrtc
/
base
/
buffer
.
h
"
#
include
"
webrtc
/
base
/
bufferqueue
.
h
"
#
include
"
webrtc
/
base
/
constructormagic
.
h
"
#
include
"
webrtc
/
base
/
sslstreamadapter
.
h
"
#
include
"
webrtc
/
base
/
stream
.
h
"
#
include
"
webrtc
/
p2p
/
base
/
icetransportinternal
.
h
"
#
include
"
webrtc
/
p2p
/
base
/
transportchannelimpl
.
h
"
namespace
rtc
{
class
PacketTransportInterface
;
}
namespace
cricket
{
class
StreamInterfaceChannel
:
public
rtc
:
:
StreamInterface
{
public
:
explicit
StreamInterfaceChannel
(
IceTransportInternal
*
channel
)
;
bool
OnPacketReceived
(
const
char
*
data
size_t
size
)
;
rtc
:
:
StreamState
GetState
(
)
const
override
{
return
state_
;
}
void
Close
(
)
override
;
rtc
:
:
StreamResult
Read
(
void
*
buffer
size_t
buffer_len
size_t
*
read
int
*
error
)
override
;
rtc
:
:
StreamResult
Write
(
const
void
*
data
size_t
data_len
size_t
*
written
int
*
error
)
override
;
private
:
IceTransportInternal
*
channel_
;
rtc
:
:
StreamState
state_
;
rtc
:
:
BufferQueue
packets_
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
StreamInterfaceChannel
)
;
}
;
class
DtlsTransportChannelWrapper
:
public
TransportChannelImpl
{
public
:
explicit
DtlsTransportChannelWrapper
(
IceTransportInternal
*
channel
)
;
~
DtlsTransportChannelWrapper
(
)
override
;
void
SetIceRole
(
IceRole
role
)
override
{
channel_
-
>
SetIceRole
(
role
)
;
}
IceRole
GetIceRole
(
)
const
override
{
return
channel_
-
>
GetIceRole
(
)
;
}
bool
SetLocalCertificate
(
const
rtc
:
:
scoped_refptr
<
rtc
:
:
RTCCertificate
>
&
certificate
)
override
;
rtc
:
:
scoped_refptr
<
rtc
:
:
RTCCertificate
>
GetLocalCertificate
(
)
const
override
;
bool
SetRemoteFingerprint
(
const
std
:
:
string
&
digest_alg
const
uint8_t
*
digest
size_t
digest_len
)
override
;
bool
IsDtlsActive
(
)
const
override
{
return
dtls_active_
;
}
int
SendPacket
(
const
char
*
data
size_t
size
const
rtc
:
:
PacketOptions
&
options
int
flags
)
override
;
int
SetOption
(
rtc
:
:
Socket
:
:
Option
opt
int
value
)
override
{
return
channel_
-
>
SetOption
(
opt
value
)
;
}
bool
GetOption
(
rtc
:
:
Socket
:
:
Option
opt
int
*
value
)
override
{
return
channel_
-
>
GetOption
(
opt
value
)
;
}
int
GetError
(
)
override
{
return
channel_
-
>
GetError
(
)
;
}
bool
GetStats
(
ConnectionInfos
*
infos
)
override
{
return
channel_
-
>
GetStats
(
infos
)
;
}
virtual
bool
SetSslMaxProtocolVersion
(
rtc
:
:
SSLProtocolVersion
version
)
;
bool
SetSrtpCryptoSuites
(
const
std
:
:
vector
<
int
>
&
ciphers
)
override
;
bool
GetSrtpCryptoSuite
(
int
*
cipher
)
override
;
bool
GetSslRole
(
rtc
:
:
SSLRole
*
role
)
const
override
;
bool
SetSslRole
(
rtc
:
:
SSLRole
role
)
override
;
bool
GetSslCipherSuite
(
int
*
cipher
)
override
;
std
:
:
unique_ptr
<
rtc
:
:
SSLCertificate
>
GetRemoteSSLCertificate
(
)
const
override
;
bool
ExportKeyingMaterial
(
const
std
:
:
string
&
label
const
uint8_t
*
context
size_t
context_len
bool
use_context
uint8_t
*
result
size_t
result_len
)
override
{
return
(
dtls_
.
get
(
)
)
?
dtls_
-
>
ExportKeyingMaterial
(
label
context
context_len
use_context
result
result_len
)
:
false
;
}
IceTransportState
GetState
(
)
const
override
{
return
channel_
-
>
GetState
(
)
;
}
void
SetIceTiebreaker
(
uint64_t
tiebreaker
)
override
{
channel_
-
>
SetIceTiebreaker
(
tiebreaker
)
;
}
void
SetIceParameters
(
const
IceParameters
&
ice_params
)
override
{
channel_
-
>
SetIceParameters
(
ice_params
)
;
}
void
SetRemoteIceParameters
(
const
IceParameters
&
ice_params
)
override
{
channel_
-
>
SetRemoteIceParameters
(
ice_params
)
;
}
void
SetRemoteIceMode
(
IceMode
mode
)
override
{
channel_
-
>
SetRemoteIceMode
(
mode
)
;
}
void
MaybeStartGathering
(
)
override
{
channel_
-
>
MaybeStartGathering
(
)
;
}
IceGatheringState
gathering_state
(
)
const
override
{
return
channel_
-
>
gathering_state
(
)
;
}
void
AddRemoteCandidate
(
const
Candidate
&
candidate
)
override
{
channel_
-
>
AddRemoteCandidate
(
candidate
)
;
}
void
RemoveRemoteCandidate
(
const
Candidate
&
candidate
)
override
{
channel_
-
>
RemoveRemoteCandidate
(
candidate
)
;
}
void
SetMetricsObserver
(
webrtc
:
:
MetricsObserverInterface
*
observer
)
override
{
channel_
-
>
SetMetricsObserver
(
observer
)
;
}
void
SetIceConfig
(
const
IceConfig
&
config
)
override
{
channel_
-
>
SetIceConfig
(
config
)
;
}
IceTransportInternal
*
channel
(
)
{
return
channel_
;
}
bool
IsDtlsConnected
(
)
;
private
:
void
OnWritableState
(
rtc
:
:
PacketTransportInterface
*
transport
)
;
void
OnReadPacket
(
rtc
:
:
PacketTransportInterface
*
transport
const
char
*
data
size_t
size
const
rtc
:
:
PacketTime
&
packet_time
int
flags
)
;
void
OnSentPacket
(
rtc
:
:
PacketTransportInterface
*
transport
const
rtc
:
:
SentPacket
&
sent_packet
)
;
void
OnReadyToSend
(
rtc
:
:
PacketTransportInterface
*
transport
)
;
void
OnReceivingState
(
rtc
:
:
PacketTransportInterface
*
transport
)
;
void
OnDtlsEvent
(
rtc
:
:
StreamInterface
*
stream_
int
sig
int
err
)
;
bool
SetupDtls
(
)
;
void
MaybeStartDtls
(
)
;
bool
HandleDtlsPacket
(
const
char
*
data
size_t
size
)
;
void
OnGatheringState
(
IceTransportInternal
*
channel
)
;
void
OnCandidateGathered
(
IceTransportInternal
*
channel
const
Candidate
&
c
)
;
void
OnCandidatesRemoved
(
IceTransportInternal
*
channel
const
Candidates
&
candidates
)
;
void
OnRoleConflict
(
IceTransportInternal
*
channel
)
;
void
OnRouteChange
(
IceTransportInternal
*
channel
const
Candidate
&
candidate
)
;
void
OnSelectedCandidatePairChanged
(
IceTransportInternal
*
channel
CandidatePairInterface
*
selected_candidate_pair
int
last_sent_packet_id
bool
ready_to_send
)
;
void
OnChannelStateChanged
(
IceTransportInternal
*
channel
)
;
void
OnDtlsHandshakeError
(
rtc
:
:
SSLHandshakeError
error
)
;
rtc
:
:
Thread
*
network_thread_
;
IceTransportInternal
*
const
channel_
;
std
:
:
unique_ptr
<
rtc
:
:
SSLStreamAdapter
>
dtls_
;
StreamInterfaceChannel
*
downward_
;
std
:
:
vector
<
int
>
srtp_ciphers_
;
bool
dtls_active_
=
false
;
rtc
:
:
scoped_refptr
<
rtc
:
:
RTCCertificate
>
local_certificate_
;
rtc
:
:
SSLRole
ssl_role_
;
rtc
:
:
SSLProtocolVersion
ssl_max_version_
;
rtc
:
:
Buffer
remote_fingerprint_value_
;
std
:
:
string
remote_fingerprint_algorithm_
;
rtc
:
:
Buffer
cached_client_hello_
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
DtlsTransportChannelWrapper
)
;
}
;
}
#
endif
