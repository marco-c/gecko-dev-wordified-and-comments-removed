#
ifndef
WEBRTC_MODULES_DESKTOP_CAPTURE_WIN_SCREEN_CAPTURER_WIN_MAGNIFIER_H_
#
define
WEBRTC_MODULES_DESKTOP_CAPTURE_WIN_SCREEN_CAPTURER_WIN_MAGNIFIER_H_
#
include
<
memory
>
#
include
<
windows
.
h
>
#
include
<
magnification
.
h
>
#
include
<
wincodec
.
h
>
#
include
"
webrtc
/
base
/
constructormagic
.
h
"
#
include
"
webrtc
/
modules
/
desktop_capture
/
desktop_capturer
.
h
"
#
include
"
webrtc
/
modules
/
desktop_capture
/
screen_capture_frame_queue
.
h
"
#
include
"
webrtc
/
modules
/
desktop_capture
/
screen_capturer_helper
.
h
"
#
include
"
webrtc
/
modules
/
desktop_capture
/
shared_desktop_frame
.
h
"
#
include
"
webrtc
/
modules
/
desktop_capture
/
win
/
scoped_thread_desktop
.
h
"
#
include
"
webrtc
/
system_wrappers
/
include
/
atomic32
.
h
"
namespace
webrtc
{
class
DesktopFrame
;
class
DesktopRect
;
class
ScreenCapturerWinMagnifier
:
public
DesktopCapturer
{
public
:
explicit
ScreenCapturerWinMagnifier
(
std
:
:
unique_ptr
<
DesktopCapturer
>
fallback_capturer
)
;
~
ScreenCapturerWinMagnifier
(
)
override
;
void
Start
(
Callback
*
callback
)
override
;
void
SetSharedMemoryFactory
(
std
:
:
unique_ptr
<
SharedMemoryFactory
>
shared_memory_factory
)
override
;
void
CaptureFrame
(
)
override
;
bool
GetSourceList
(
SourceList
*
screens
)
override
;
bool
SelectSource
(
SourceId
id
)
override
;
void
SetExcludedWindow
(
WindowId
window
)
override
;
private
:
typedef
BOOL
(
WINAPI
*
MagImageScalingCallback
)
(
HWND
hwnd
void
*
srcdata
MAGIMAGEHEADER
srcheader
void
*
destdata
MAGIMAGEHEADER
destheader
RECT
unclipped
RECT
clipped
HRGN
dirty
)
;
typedef
BOOL
(
WINAPI
*
MagInitializeFunc
)
(
void
)
;
typedef
BOOL
(
WINAPI
*
MagUninitializeFunc
)
(
void
)
;
typedef
BOOL
(
WINAPI
*
MagSetWindowSourceFunc
)
(
HWND
hwnd
RECT
rect
)
;
typedef
BOOL
(
WINAPI
*
MagSetWindowFilterListFunc
)
(
HWND
hwnd
DWORD
dwFilterMode
int
count
HWND
*
pHWND
)
;
typedef
BOOL
(
WINAPI
*
MagSetImageScalingCallbackFunc
)
(
HWND
hwnd
MagImageScalingCallback
callback
)
;
static
BOOL
WINAPI
OnMagImageScalingCallback
(
HWND
hwnd
void
*
srcdata
MAGIMAGEHEADER
srcheader
void
*
destdata
MAGIMAGEHEADER
destheader
RECT
unclipped
RECT
clipped
HRGN
dirty
)
;
bool
CaptureImage
(
const
DesktopRect
&
rect
)
;
bool
InitializeMagnifier
(
)
;
void
OnCaptured
(
void
*
data
const
MAGIMAGEHEADER
&
header
)
;
void
CreateCurrentFrameIfNecessary
(
const
DesktopSize
&
size
)
;
void
StartFallbackCapturer
(
)
;
static
Atomic32
tls_index_
;
std
:
:
unique_ptr
<
DesktopCapturer
>
fallback_capturer_
;
bool
fallback_capturer_started_
=
false
;
Callback
*
callback_
=
nullptr
;
std
:
:
unique_ptr
<
SharedMemoryFactory
>
shared_memory_factory_
;
ScreenId
current_screen_id_
=
kFullDesktopScreenId
;
std
:
:
wstring
current_device_key_
;
HWND
excluded_window_
=
NULL
;
ScreenCaptureFrameQueue
<
SharedDesktopFrame
>
queue_
;
ScopedThreadDesktop
desktop_
;
HDC
desktop_dc_
=
NULL
;
HMODULE
mag_lib_handle_
=
NULL
;
MagInitializeFunc
mag_initialize_func_
=
nullptr
;
MagUninitializeFunc
mag_uninitialize_func_
=
nullptr
;
MagSetWindowSourceFunc
set_window_source_func_
=
nullptr
;
MagSetWindowFilterListFunc
set_window_filter_list_func_
=
nullptr
;
MagSetImageScalingCallbackFunc
set_image_scaling_callback_func_
=
nullptr
;
HWND
host_window_
=
NULL
;
HWND
magnifier_window_
=
NULL
;
bool
magnifier_initialized_
=
false
;
bool
magnifier_capture_succeeded_
=
true
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
ScreenCapturerWinMagnifier
)
;
}
;
}
#
endif
