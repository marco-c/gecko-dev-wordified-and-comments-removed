#
include
"
modules
/
rtp_rtcp
/
include
/
remote_ntp_time_estimator
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
namespace
webrtc
{
namespace
{
static
const
int
kTimingLogIntervalMs
=
10000
;
static
const
int
kClocksOffsetSmoothingWindow
=
100
;
}
RemoteNtpTimeEstimator
:
:
RemoteNtpTimeEstimator
(
Clock
*
clock
)
:
clock_
(
clock
)
ntp_clocks_offset_estimator_
(
kClocksOffsetSmoothingWindow
)
last_timing_log_ms_
(
-
1
)
{
}
RemoteNtpTimeEstimator
:
:
~
RemoteNtpTimeEstimator
(
)
{
}
bool
RemoteNtpTimeEstimator
:
:
UpdateRtcpTimestamp
(
int64_t
rtt
uint32_t
ntp_secs
uint32_t
ntp_frac
uint32_t
rtcp_timestamp
)
{
bool
new_rtcp_sr
=
false
;
if
(
!
rtp_to_ntp_
.
UpdateMeasurements
(
ntp_secs
ntp_frac
rtcp_timestamp
&
new_rtcp_sr
)
)
{
return
false
;
}
if
(
!
new_rtcp_sr
)
{
return
true
;
}
int64_t
receiver_arrival_time_ms
=
clock_
-
>
TimeInMilliseconds
(
)
;
int64_t
sender_send_time_ms
=
Clock
:
:
NtpToMs
(
ntp_secs
ntp_frac
)
;
int64_t
sender_arrival_time_ms
=
sender_send_time_ms
+
rtt
/
2
;
int64_t
remote_to_local_clocks_offset
=
receiver_arrival_time_ms
-
sender_arrival_time_ms
;
ntp_clocks_offset_estimator_
.
Insert
(
remote_to_local_clocks_offset
)
;
return
true
;
}
int64_t
RemoteNtpTimeEstimator
:
:
Estimate
(
uint32_t
rtp_timestamp
)
{
int64_t
sender_capture_ntp_ms
=
0
;
if
(
!
rtp_to_ntp_
.
Estimate
(
rtp_timestamp
&
sender_capture_ntp_ms
)
)
{
return
-
1
;
}
int64_t
remote_to_local_clocks_offset
=
ntp_clocks_offset_estimator_
.
GetFilteredValue
(
)
;
int64_t
receiver_capture_ms
=
sender_capture_ntp_ms
+
remote_to_local_clocks_offset
;
int64_t
now_ms
=
clock_
-
>
TimeInMilliseconds
(
)
;
int64_t
ntp_offset
=
clock_
-
>
CurrentNtpInMilliseconds
(
)
-
now_ms
;
int64_t
receiver_capture_ntp_ms
=
receiver_capture_ms
+
ntp_offset
;
if
(
now_ms
-
last_timing_log_ms_
>
kTimingLogIntervalMs
)
{
RTC_LOG
(
LS_INFO
)
<
<
"
RTP
timestamp
:
"
<
<
rtp_timestamp
<
<
"
in
NTP
clock
:
"
<
<
sender_capture_ntp_ms
<
<
"
estimated
time
in
receiver
clock
:
"
<
<
receiver_capture_ms
<
<
"
converted
to
NTP
clock
:
"
<
<
receiver_capture_ntp_ms
;
last_timing_log_ms_
=
now_ms
;
}
return
receiver_capture_ntp_ms
;
}
}
