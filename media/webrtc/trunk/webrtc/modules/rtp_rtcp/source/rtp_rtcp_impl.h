#
ifndef
WEBRTC_MODULES_RTP_RTCP_SOURCE_RTP_RTCP_IMPL_H_
#
define
WEBRTC_MODULES_RTP_RTCP_SOURCE_RTP_RTCP_IMPL_H_
#
include
<
list
>
#
include
<
vector
>
#
include
"
webrtc
/
base
/
scoped_ptr
.
h
"
#
include
"
webrtc
/
modules
/
rtp_rtcp
/
interface
/
rtp_rtcp
.
h
"
#
include
"
webrtc
/
modules
/
rtp_rtcp
/
source
/
rtcp_receiver
.
h
"
#
include
"
webrtc
/
modules
/
rtp_rtcp
/
source
/
rtcp_sender
.
h
"
#
include
"
webrtc
/
modules
/
rtp_rtcp
/
source
/
rtp_sender
.
h
"
#
include
"
webrtc
/
test
/
testsupport
/
gtest_prod_util
.
h
"
namespace
webrtc
{
class
ModuleRtpRtcpImpl
:
public
RtpRtcp
{
public
:
explicit
ModuleRtpRtcpImpl
(
const
RtpRtcp
:
:
Configuration
&
configuration
)
;
int64_t
TimeUntilNextProcess
(
)
override
;
int32_t
Process
(
)
override
;
int32_t
IncomingRtcpPacket
(
const
uint8_t
*
incoming_packet
size_t
incoming_packet_length
)
override
;
void
SetRemoteSSRC
(
uint32_t
ssrc
)
override
;
int32_t
RegisterSendPayload
(
const
CodecInst
&
voice_codec
)
override
;
int32_t
RegisterSendPayload
(
const
VideoCodec
&
video_codec
)
override
;
int32_t
DeRegisterSendPayload
(
int8_t
payload_type
)
override
;
int8_t
SendPayloadType
(
)
const
;
int32_t
RegisterSendRtpHeaderExtension
(
RTPExtensionType
type
uint8_t
id
)
override
;
int32_t
DeregisterSendRtpHeaderExtension
(
RTPExtensionType
type
)
override
;
uint32_t
StartTimestamp
(
)
const
override
;
void
SetStartTimestamp
(
uint32_t
timestamp
)
override
;
uint16_t
SequenceNumber
(
)
const
override
;
void
SetSequenceNumber
(
uint16_t
seq
)
override
;
bool
SetRtpStateForSsrc
(
uint32_t
ssrc
const
RtpState
&
rtp_state
)
override
;
bool
GetRtpStateForSsrc
(
uint32_t
ssrc
RtpState
*
rtp_state
)
override
;
uint32_t
SSRC
(
)
const
override
;
void
SetSSRC
(
uint32_t
ssrc
)
override
;
void
SetCsrcs
(
const
std
:
:
vector
<
uint32_t
>
&
csrcs
)
override
;
RTCPSender
:
:
FeedbackState
GetFeedbackState
(
)
;
int
CurrentSendFrequencyHz
(
)
const
;
void
SetRtxSendStatus
(
int
mode
)
override
;
int
RtxSendStatus
(
)
const
override
;
void
SetRtxSsrc
(
uint32_t
ssrc
)
override
;
void
SetRtxSendPayloadType
(
int
payload_type
)
override
;
int32_t
SetSendingStatus
(
bool
sending
)
override
;
bool
Sending
(
)
const
override
;
void
SetSendingMediaStatus
(
bool
sending
)
override
;
bool
SendingMedia
(
)
const
override
;
int32_t
SendOutgoingData
(
FrameType
frame_type
int8_t
payload_type
uint32_t
time_stamp
int64_t
capture_time_ms
const
uint8_t
*
payload_data
size_t
payload_size
const
RTPFragmentationHeader
*
fragmentation
=
NULL
const
RTPVideoHeader
*
rtp_video_hdr
=
NULL
)
override
;
bool
TimeToSendPacket
(
uint32_t
ssrc
uint16_t
sequence_number
int64_t
capture_time_ms
bool
retransmission
)
override
;
size_t
TimeToSendPadding
(
size_t
bytes
)
override
;
bool
GetSendSideDelay
(
int
*
avg_send_delay_ms
int
*
max_send_delay_ms
)
const
override
;
RTCPMethod
RTCP
(
)
const
override
;
void
SetRTCPStatus
(
RTCPMethod
method
)
override
;
int32_t
SetCNAME
(
const
char
c_name
[
RTCP_CNAME_SIZE
]
)
override
;
int32_t
RemoteCNAME
(
uint32_t
remote_ssrc
char
c_name
[
RTCP_CNAME_SIZE
]
)
const
override
;
int32_t
RemoteNTP
(
uint32_t
*
received_ntp_secs
uint32_t
*
received_ntp_frac
uint32_t
*
rtcp_arrival_time_secs
uint32_t
*
rtcp_arrival_time_frac
uint32_t
*
rtcp_timestamp
)
const
override
;
int32_t
AddMixedCNAME
(
uint32_t
ssrc
const
char
c_name
[
RTCP_CNAME_SIZE
]
)
override
;
int32_t
RemoveMixedCNAME
(
uint32_t
ssrc
)
override
;
int32_t
RTT
(
uint32_t
remote_ssrc
int64_t
*
rtt
int64_t
*
avg_rtt
int64_t
*
min_rtt
int64_t
*
max_rtt
)
const
override
;
virtual
int32_t
GetReportBlockInfo
(
const
uint32_t
remote_ssrc
uint32_t
*
ntp_high
uint32_t
*
ntp_low
uint32_t
*
packets_received
uint64_t
*
octets_received
)
const
override
;
int32_t
SendRTCP
(
uint32_t
rtcp_packet_type
=
kRtcpReport
)
override
;
int32_t
ResetSendDataCountersRTP
(
)
override
;
int32_t
DataCountersRTP
(
size_t
*
bytes_sent
uint32_t
*
packets_sent
)
const
override
;
void
GetSendStreamDataCounters
(
StreamDataCounters
*
rtp_counters
StreamDataCounters
*
rtx_counters
)
const
override
;
int32_t
RemoteRTCPStat
(
RTCPSenderInfo
*
sender_info
)
override
;
int32_t
RemoteRTCPStat
(
std
:
:
vector
<
RTCPReportBlock
>
*
receive_blocks
)
const
override
;
int32_t
AddRTCPReportBlock
(
uint32_t
ssrc
const
RTCPReportBlock
*
receive_block
)
override
;
int32_t
RemoveRTCPReportBlock
(
uint32_t
ssrc
)
override
;
bool
REMB
(
)
const
override
;
void
SetREMBStatus
(
bool
enable
)
override
;
void
SetREMBData
(
uint32_t
bitrate
const
std
:
:
vector
<
uint32_t
>
&
ssrcs
)
override
;
bool
IJ
(
)
const
override
;
void
SetIJStatus
(
bool
enable
)
override
;
bool
TMMBR
(
)
const
override
;
void
SetTMMBRStatus
(
bool
enable
)
override
;
int32_t
SetTMMBN
(
const
TMMBRSet
*
bounding_set
)
;
uint16_t
MaxPayloadLength
(
)
const
override
;
uint16_t
MaxDataPayloadLength
(
)
const
override
;
int32_t
SetMaxTransferUnit
(
uint16_t
size
)
override
;
int32_t
SetTransportOverhead
(
bool
tcp
bool
ipv6
uint8_t
authentication_overhead
=
0
)
override
;
int
SelectiveRetransmissions
(
)
const
override
;
int
SetSelectiveRetransmissions
(
uint8_t
settings
)
override
;
int32_t
SendNACK
(
const
uint16_t
*
nack_list
uint16_t
size
)
override
;
void
SetStorePacketsStatus
(
bool
enable
uint16_t
number_to_store
)
override
;
bool
StorePackets
(
)
const
override
;
void
RegisterRtcpStatisticsCallback
(
RtcpStatisticsCallback
*
callback
)
override
;
RtcpStatisticsCallback
*
GetRtcpStatisticsCallback
(
)
override
;
int32_t
SetRTCPApplicationSpecificData
(
uint8_t
sub_type
uint32_t
name
const
uint8_t
*
data
uint16_t
length
)
override
;
int32_t
SetRTCPVoIPMetrics
(
const
RTCPVoIPMetric
*
VoIPMetric
)
override
;
void
SetRtcpXrRrtrStatus
(
bool
enable
)
override
;
bool
RtcpXrRrtrStatus
(
)
const
override
;
int32_t
SetAudioPacketSize
(
uint16_t
packet_size_samples
)
override
;
int32_t
SendTelephoneEventOutband
(
uint8_t
key
uint16_t
time_ms
uint8_t
level
)
override
;
int32_t
SetSendREDPayloadType
(
int8_t
payload_type
)
override
;
int32_t
SendREDPayloadType
(
int8_t
&
payload_type
)
const
override
;
int32_t
SetAudioLevel
(
uint8_t
level_d_bov
)
override
;
int32_t
SendRTCPSliceLossIndication
(
uint8_t
picture_id
)
override
;
int32_t
SetKeyFrameRequestMethod
(
KeyFrameRequestMethod
method
)
override
;
int32_t
RequestKeyFrame
(
)
override
;
void
SetTargetSendBitrate
(
uint32_t
bitrate_bps
)
override
;
int32_t
SetGenericFECStatus
(
bool
enable
uint8_t
payload_type_red
uint8_t
payload_type_fec
)
override
;
int32_t
GenericFECStatus
(
bool
&
enable
uint8_t
&
payload_type_red
uint8_t
&
payload_type_fec
)
override
;
int32_t
SetFecParameters
(
const
FecProtectionParams
*
delta_params
const
FecProtectionParams
*
key_params
)
override
;
bool
LastReceivedNTP
(
uint32_t
*
NTPsecs
uint32_t
*
NTPfrac
uint32_t
*
remote_sr
)
const
;
bool
LastReceivedXrReferenceTimeInfo
(
RtcpReceiveTimeInfo
*
info
)
const
;
virtual
int32_t
BoundingSet
(
bool
&
tmmbr_owner
TMMBRSet
*
&
bounding_set_rec
)
;
void
BitrateSent
(
uint32_t
*
total_rate
uint32_t
*
video_rate
uint32_t
*
fec_rate
uint32_t
*
nackRate
)
const
override
;
bool
GetSendReportMetadata
(
const
uint32_t
send_report
uint64_t
*
time_of_send
uint32_t
*
packet_count
uint64_t
*
octet_count
)
;
bool
SendTimeOfXrRrReport
(
uint32_t
mid_ntp
int64_t
*
time_ms
)
const
;
int32_t
SendRTCPReferencePictureSelection
(
uint64_t
picture_id
)
override
;
void
RegisterSendChannelRtpStatisticsCallback
(
StreamDataCountersCallback
*
callback
)
override
;
StreamDataCountersCallback
*
GetSendChannelRtpStatisticsCallback
(
)
const
override
;
void
OnReceivedTMMBR
(
)
;
void
OnRequestIntraFrame
(
)
;
void
OnReceivedSliceLossIndication
(
uint8_t
picture_id
)
;
void
OnReceivedReferencePictureSelectionIndication
(
uint64_t
picture_id
)
;
void
OnReceivedNACK
(
const
std
:
:
list
<
uint16_t
>
&
nack_sequence_numbers
)
;
void
OnRequestSendReport
(
)
;
protected
:
bool
UpdateRTCPReceiveInformationTimers
(
)
;
uint32_t
BitrateReceivedNow
(
)
const
;
uint16_t
RemoteSequenceNumber
(
)
const
;
uint32_t
LastSendReport
(
int64_t
&
last_rtcptime
)
;
RTPSender
rtp_sender_
;
RTCPSender
rtcp_sender_
;
RTCPReceiver
rtcp_receiver_
;
Clock
*
clock_
;
private
:
FRIEND_TEST_ALL_PREFIXES
(
RtpRtcpImplTest
Rtt
)
;
FRIEND_TEST_ALL_PREFIXES
(
RtpRtcpImplTest
RttForReceiverOnly
)
;
int64_t
RtcpReportInterval
(
)
;
void
SetRtcpReceiverSsrcs
(
uint32_t
main_ssrc
)
;
void
set_rtt_ms
(
int64_t
rtt_ms
)
;
int64_t
rtt_ms
(
)
const
;
bool
TimeToSendFullNackList
(
int64_t
now
)
const
;
int32_t
id_
;
const
bool
audio_
;
bool
collision_detected_
;
int64_t
last_process_time_
;
int64_t
last_bitrate_process_time_
;
int64_t
last_rtt_process_time_
;
uint16_t
packet_overhead_
;
size_t
padding_index_
;
NACKMethod
nack_method_
;
int64_t
nack_last_time_sent_full_
;
uint32_t
nack_last_time_sent_full_prev_
;
uint16_t
nack_last_seq_number_sent_
;
VideoCodec
send_video_codec_
;
KeyFrameRequestMethod
key_frame_req_method_
;
RemoteBitrateEstimator
*
remote_bitrate_
;
RtcpRttStats
*
rtt_stats_
;
rtc
:
:
scoped_ptr
<
CriticalSectionWrapper
>
critical_section_rtt_
;
int64_t
rtt_ms_
;
}
;
}
#
endif
