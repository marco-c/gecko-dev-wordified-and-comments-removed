#
include
"
webrtc
/
modules
/
audio_coding
/
audio_network_adaptor
/
bitrate_controller
.
h
"
#
include
"
webrtc
/
test
/
field_trial
.
h
"
#
include
"
webrtc
/
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
audio_network_adaptor
{
namespace
{
void
CheckDecision
(
BitrateController
*
controller
const
rtc
:
:
Optional
<
int
>
&
target_audio_bitrate_bps
const
rtc
:
:
Optional
<
size_t
>
&
overhead_bytes_per_packet
const
rtc
:
:
Optional
<
int
>
&
frame_length_ms
int
expected_bitrate_bps
)
{
Controller
:
:
NetworkMetrics
metrics
;
metrics
.
target_audio_bitrate_bps
=
target_audio_bitrate_bps
;
metrics
.
overhead_bytes_per_packet
=
overhead_bytes_per_packet
;
AudioNetworkAdaptor
:
:
EncoderRuntimeConfig
config
;
config
.
frame_length_ms
=
frame_length_ms
;
controller
-
>
MakeDecision
(
metrics
&
config
)
;
EXPECT_EQ
(
rtc
:
:
Optional
<
int
>
(
expected_bitrate_bps
)
config
.
bitrate_bps
)
;
}
}
TEST
(
AnaBitrateControllerTest
OutputInitValueWhenTargetBitrateUnknown
)
{
constexpr
int
kInitialBitrateBps
=
32000
;
constexpr
int
kInitialFrameLengthMs
=
20
;
constexpr
size_t
kOverheadBytesPerPacket
=
64
;
BitrateController
controller
(
BitrateController
:
:
Config
(
kInitialBitrateBps
kInitialFrameLengthMs
)
)
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
kInitialFrameLengthMs
*
2
)
kInitialBitrateBps
)
;
}
TEST
(
AnaBitrateControllerTest
OutputInitValueWhenOverheadUnknown
)
{
constexpr
int
kInitialBitrateBps
=
32000
;
constexpr
int
kInitialFrameLengthMs
=
20
;
constexpr
int
kTargetBitrateBps
=
48000
;
BitrateController
controller
(
BitrateController
:
:
Config
(
kInitialBitrateBps
kInitialFrameLengthMs
)
)
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
)
rtc
:
:
Optional
<
int
>
(
kInitialFrameLengthMs
*
2
)
kInitialBitrateBps
)
;
}
TEST
(
AnaBitrateControllerTest
ChangeBitrateOnTargetBitrateChanged
)
{
test
:
:
ScopedFieldTrials
override_field_trials
(
"
WebRTC
-
SendSideBwe
-
WithOverhead
/
Enabled
/
"
)
;
constexpr
int
kInitialFrameLengthMs
=
20
;
BitrateController
controller
(
BitrateController
:
:
Config
(
32000
kInitialFrameLengthMs
)
)
;
constexpr
int
kTargetBitrateBps
=
48000
;
constexpr
size_t
kOverheadBytesPerPacket
=
64
;
constexpr
int
kBitrateBps
=
kTargetBitrateBps
-
kOverheadBytesPerPacket
*
8
*
1000
/
kInitialFrameLengthMs
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
kInitialFrameLengthMs
)
kBitrateBps
)
;
}
TEST
(
AnaBitrateControllerTest
TreatUnknownFrameLengthAsFrameLengthUnchanged
)
{
test
:
:
ScopedFieldTrials
override_field_trials
(
"
WebRTC
-
SendSideBwe
-
WithOverhead
/
Enabled
/
"
)
;
constexpr
int
kInitialFrameLengthMs
=
20
;
BitrateController
controller
(
BitrateController
:
:
Config
(
32000
kInitialFrameLengthMs
)
)
;
constexpr
int
kTargetBitrateBps
=
48000
;
constexpr
size_t
kOverheadBytesPerPacket
=
64
;
constexpr
int
kBitrateBps
=
kTargetBitrateBps
-
kOverheadBytesPerPacket
*
8
*
1000
/
kInitialFrameLengthMs
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
)
kBitrateBps
)
;
}
TEST
(
AnaBitrateControllerTest
IncreaseBitrateOnFrameLengthIncreased
)
{
test
:
:
ScopedFieldTrials
override_field_trials
(
"
WebRTC
-
SendSideBwe
-
WithOverhead
/
Enabled
/
"
)
;
constexpr
int
kInitialFrameLengthMs
=
20
;
BitrateController
controller
(
BitrateController
:
:
Config
(
32000
kInitialFrameLengthMs
)
)
;
constexpr
int
kTargetBitrateBps
=
48000
;
constexpr
size_t
kOverheadBytesPerPacket
=
64
;
constexpr
int
kBitrateBps
=
kTargetBitrateBps
-
kOverheadBytesPerPacket
*
8
*
1000
/
kInitialFrameLengthMs
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
)
kBitrateBps
)
;
constexpr
int
kFrameLengthMs
=
60
;
constexpr
size_t
kPacketOverheadRateDiff
=
kOverheadBytesPerPacket
*
8
*
1000
/
20
-
kOverheadBytesPerPacket
*
8
*
1000
/
60
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
kFrameLengthMs
)
kBitrateBps
+
kPacketOverheadRateDiff
)
;
}
TEST
(
AnaBitrateControllerTest
DecreaseBitrateOnFrameLengthDecreased
)
{
test
:
:
ScopedFieldTrials
override_field_trials
(
"
WebRTC
-
SendSideBwe
-
WithOverhead
/
Enabled
/
"
)
;
constexpr
int
kInitialFrameLengthMs
=
60
;
BitrateController
controller
(
BitrateController
:
:
Config
(
32000
kInitialFrameLengthMs
)
)
;
constexpr
int
kTargetBitrateBps
=
48000
;
constexpr
size_t
kOverheadBytesPerPacket
=
64
;
constexpr
int
kBitrateBps
=
kTargetBitrateBps
-
kOverheadBytesPerPacket
*
8
*
1000
/
kInitialFrameLengthMs
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
)
kBitrateBps
)
;
constexpr
int
kFrameLengthMs
=
20
;
constexpr
size_t
kPacketOverheadRateDiff
=
kOverheadBytesPerPacket
*
8
*
1000
/
20
-
kOverheadBytesPerPacket
*
8
*
1000
/
60
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
kFrameLengthMs
)
kBitrateBps
-
kPacketOverheadRateDiff
)
;
}
TEST
(
AnaBitrateControllerTest
BitrateNeverBecomesNegative
)
{
test
:
:
ScopedFieldTrials
override_field_trials
(
"
WebRTC
-
SendSideBwe
-
WithOverhead
/
Enabled
/
"
)
;
BitrateController
controller
(
BitrateController
:
:
Config
(
32000
20
)
)
;
constexpr
size_t
kOverheadBytesPerPacket
=
64
;
constexpr
int
kFrameLengthMs
=
60
;
constexpr
int
kTargetBitrateBps
=
kOverheadBytesPerPacket
*
8
*
1000
/
kFrameLengthMs
-
1
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
kTargetBitrateBps
)
rtc
:
:
Optional
<
size_t
>
(
kOverheadBytesPerPacket
)
rtc
:
:
Optional
<
int
>
(
kFrameLengthMs
)
0
)
;
}
TEST
(
AnaBitrateControllerTest
CheckBehaviorOnChangingCondition
)
{
test
:
:
ScopedFieldTrials
override_field_trials
(
"
WebRTC
-
SendSideBwe
-
WithOverhead
/
Enabled
/
"
)
;
BitrateController
controller
(
BitrateController
:
:
Config
(
32000
20
)
)
;
int
overall_bitrate
=
34567
;
size_t
overhead_bytes_per_packet
=
64
;
int
frame_length_ms
=
20
;
int
current_bitrate
=
overall_bitrate
-
overhead_bytes_per_packet
*
8
*
1000
/
frame_length_ms
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
overall_bitrate
)
rtc
:
:
Optional
<
size_t
>
(
overhead_bytes_per_packet
)
rtc
:
:
Optional
<
int
>
(
frame_length_ms
)
current_bitrate
)
;
overall_bitrate
+
=
100
;
current_bitrate
+
=
100
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
overall_bitrate
)
rtc
:
:
Optional
<
size_t
>
(
overhead_bytes_per_packet
)
rtc
:
:
Optional
<
int
>
(
frame_length_ms
)
current_bitrate
)
;
frame_length_ms
=
60
;
current_bitrate
+
=
overhead_bytes_per_packet
*
8
*
1000
/
20
-
overhead_bytes_per_packet
*
8
*
1000
/
60
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
overall_bitrate
)
rtc
:
:
Optional
<
size_t
>
(
overhead_bytes_per_packet
)
rtc
:
:
Optional
<
int
>
(
frame_length_ms
)
current_bitrate
)
;
overhead_bytes_per_packet
-
=
30
;
current_bitrate
+
=
30
*
8
*
1000
/
frame_length_ms
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
overall_bitrate
)
rtc
:
:
Optional
<
size_t
>
(
overhead_bytes_per_packet
)
rtc
:
:
Optional
<
int
>
(
frame_length_ms
)
current_bitrate
)
;
frame_length_ms
=
20
;
current_bitrate
-
=
overhead_bytes_per_packet
*
8
*
1000
/
20
-
overhead_bytes_per_packet
*
8
*
1000
/
60
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
overall_bitrate
)
rtc
:
:
Optional
<
size_t
>
(
overhead_bytes_per_packet
)
rtc
:
:
Optional
<
int
>
(
frame_length_ms
)
current_bitrate
)
;
overall_bitrate
-
=
100
;
current_bitrate
-
=
100
;
frame_length_ms
=
60
;
current_bitrate
+
=
overhead_bytes_per_packet
*
8
*
1000
/
20
-
overhead_bytes_per_packet
*
8
*
1000
/
60
;
CheckDecision
(
&
controller
rtc
:
:
Optional
<
int
>
(
overall_bitrate
)
rtc
:
:
Optional
<
size_t
>
(
overhead_bytes_per_packet
)
rtc
:
:
Optional
<
int
>
(
frame_length_ms
)
current_bitrate
)
;
}
}
}
