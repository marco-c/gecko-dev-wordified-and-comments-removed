#
include
<
algorithm
>
#
include
<
vector
>
#
include
"
testing
/
gtest
/
include
/
gtest
/
gtest
.
h
"
#
include
"
webrtc
/
modules
/
bitrate_controller
/
send_side_bandwidth_estimation
.
h
"
namespace
webrtc
{
TEST
(
SendSideBweTest
InitialRembWithProbing
)
{
SendSideBandwidthEstimation
bwe
;
bwe
.
SetMinMaxBitrate
(
100000
1500000
)
;
bwe
.
SetSendBitrate
(
200000
)
;
const
int
kRembBps
=
1000000
;
const
int
kSecondRembBps
=
kRembBps
+
500000
;
int64_t
now_ms
=
0
;
bwe
.
UpdateReceiverBlock
(
0
50
1
now_ms
)
;
bwe
.
UpdateReceiverEstimate
(
kRembBps
)
;
bwe
.
UpdateEstimate
(
now_ms
)
;
int
bitrate
;
uint8_t
fraction_loss
;
int64_t
rtt
;
bwe
.
CurrentEstimate
(
&
bitrate
&
fraction_loss
&
rtt
)
;
EXPECT_EQ
(
kRembBps
bitrate
)
;
now_ms
+
=
2001
;
bwe
.
UpdateReceiverEstimate
(
kSecondRembBps
)
;
bwe
.
UpdateEstimate
(
now_ms
)
;
bitrate
=
0
;
bwe
.
CurrentEstimate
(
&
bitrate
&
fraction_loss
&
rtt
)
;
EXPECT_EQ
(
kRembBps
bitrate
)
;
}
}
