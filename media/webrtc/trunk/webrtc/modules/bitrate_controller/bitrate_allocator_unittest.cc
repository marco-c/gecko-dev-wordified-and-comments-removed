#
include
<
algorithm
>
#
include
<
vector
>
#
include
"
testing
/
gtest
/
include
/
gtest
/
gtest
.
h
"
#
include
"
webrtc
/
modules
/
bitrate_controller
/
include
/
bitrate_allocator
.
h
"
#
include
"
webrtc
/
modules
/
bitrate_controller
/
include
/
bitrate_controller
.
h
"
namespace
webrtc
{
class
TestBitrateObserver
:
public
BitrateObserver
{
public
:
TestBitrateObserver
(
)
:
last_bitrate_
(
0
)
last_fraction_loss_
(
0
)
last_rtt_
(
0
)
{
}
virtual
void
OnNetworkChanged
(
uint32_t
bitrate
uint8_t
fraction_loss
int64_t
rtt
)
{
last_bitrate_
=
bitrate
;
last_fraction_loss_
=
fraction_loss
;
last_rtt_
=
rtt
;
}
uint32_t
last_bitrate_
;
uint8_t
last_fraction_loss_
;
int64_t
last_rtt_
;
}
;
class
BitrateAllocatorTest
:
public
:
:
testing
:
:
Test
{
protected
:
BitrateAllocatorTest
(
)
:
allocator_
(
new
BitrateAllocator
(
)
)
{
allocator_
-
>
OnNetworkChanged
(
300000u
0
0
)
;
}
~
BitrateAllocatorTest
(
)
{
}
rtc
:
:
scoped_ptr
<
BitrateAllocator
>
allocator_
;
}
;
TEST_F
(
BitrateAllocatorTest
UpdatingBitrateObserver
)
{
TestBitrateObserver
bitrate_observer
;
int
start_bitrate
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer
200000
100000
1500000
&
start_bitrate
)
;
EXPECT_EQ
(
300000
start_bitrate
)
;
allocator_
-
>
OnNetworkChanged
(
200000
0
0
)
;
EXPECT_EQ
(
200000u
bitrate_observer
.
last_bitrate_
)
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer
1500000
100000
1500000
&
start_bitrate
)
;
EXPECT_EQ
(
1500000
start_bitrate
)
;
allocator_
-
>
OnNetworkChanged
(
1500000
0
0
)
;
EXPECT_EQ
(
1500000u
bitrate_observer
.
last_bitrate_
)
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer
500000
100000
1500000
&
start_bitrate
)
;
EXPECT_EQ
(
1500000
start_bitrate
)
;
allocator_
-
>
OnNetworkChanged
(
1500000
0
0
)
;
EXPECT_EQ
(
1500000u
bitrate_observer
.
last_bitrate_
)
;
}
TEST_F
(
BitrateAllocatorTest
TwoBitrateObserversOneRtcpObserver
)
{
TestBitrateObserver
bitrate_observer_1
;
TestBitrateObserver
bitrate_observer_2
;
int
start_bitrate
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_1
200000
100000
300000
&
start_bitrate
)
;
EXPECT_EQ
(
300000
start_bitrate
)
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_2
200000
200000
300000
&
start_bitrate
)
;
EXPECT_EQ
(
200000
start_bitrate
)
;
allocator_
-
>
OnNetworkChanged
(
200000
0
50
)
;
EXPECT_EQ
(
100000u
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
0
bitrate_observer_1
.
last_fraction_loss_
)
;
EXPECT_EQ
(
50
bitrate_observer_1
.
last_rtt_
)
;
EXPECT_EQ
(
200000u
bitrate_observer_2
.
last_bitrate_
)
;
EXPECT_EQ
(
0
bitrate_observer_2
.
last_fraction_loss_
)
;
EXPECT_EQ
(
50
bitrate_observer_2
.
last_rtt_
)
;
allocator_
-
>
OnNetworkChanged
(
500000
0
50
)
;
const
uint32_t
kBitrateToShare
=
500000
-
200000
-
100000
;
EXPECT_EQ
(
100000u
+
kBitrateToShare
/
2
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
200000u
+
kBitrateToShare
/
2
bitrate_observer_2
.
last_bitrate_
)
;
allocator_
-
>
OnNetworkChanged
(
1500000
0
50
)
;
EXPECT_EQ
(
600000u
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
600000u
bitrate_observer_2
.
last_bitrate_
)
;
}
class
BitrateAllocatorTestNoEnforceMin
:
public
:
:
testing
:
:
Test
{
protected
:
BitrateAllocatorTestNoEnforceMin
(
)
:
allocator_
(
new
BitrateAllocator
(
)
)
{
allocator_
-
>
EnforceMinBitrate
(
false
)
;
allocator_
-
>
OnNetworkChanged
(
300000u
0
0
)
;
}
~
BitrateAllocatorTestNoEnforceMin
(
)
{
}
rtc
:
:
scoped_ptr
<
BitrateAllocator
>
allocator_
;
}
;
TEST_F
(
BitrateAllocatorTestNoEnforceMin
OneBitrateObserver
)
{
TestBitrateObserver
bitrate_observer_1
;
int
start_bitrate
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_1
200000
100000
400000
&
start_bitrate
)
;
EXPECT_EQ
(
300000
start_bitrate
)
;
allocator_
-
>
OnNetworkChanged
(
150000
0
0
)
;
EXPECT_EQ
(
150000u
bitrate_observer_1
.
last_bitrate_
)
;
allocator_
-
>
OnNetworkChanged
(
10000
0
0
)
;
EXPECT_EQ
(
10000u
bitrate_observer_1
.
last_bitrate_
)
;
allocator_
-
>
RemoveBitrateObserver
(
&
bitrate_observer_1
)
;
}
TEST_F
(
BitrateAllocatorTestNoEnforceMin
ThreeBitrateObservers
)
{
TestBitrateObserver
bitrate_observer_1
;
TestBitrateObserver
bitrate_observer_2
;
TestBitrateObserver
bitrate_observer_3
;
int
start_bitrate
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_1
200000
100000
400000
&
start_bitrate
)
;
EXPECT_EQ
(
300000
start_bitrate
)
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_2
200000
200000
400000
&
start_bitrate
)
;
EXPECT_EQ
(
200000
start_bitrate
)
;
EXPECT_EQ
(
100000u
bitrate_observer_1
.
last_bitrate_
)
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_3
200000
300000
400000
&
start_bitrate
)
;
EXPECT_EQ
(
0
start_bitrate
)
;
EXPECT_EQ
(
100000u
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
200000u
bitrate_observer_2
.
last_bitrate_
)
;
allocator_
-
>
OnNetworkChanged
(
690000
0
0
)
;
uint32_t
bitrate_to_share
=
690000u
-
100000u
-
200000u
-
300000u
;
EXPECT_EQ
(
100000u
+
bitrate_to_share
/
3
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
200000u
+
bitrate_to_share
/
3
bitrate_observer_2
.
last_bitrate_
)
;
EXPECT_EQ
(
300000u
+
bitrate_to_share
/
3
bitrate_observer_3
.
last_bitrate_
)
;
allocator_
-
>
OnNetworkChanged
(
500000
0
0
)
;
EXPECT_EQ
(
100000u
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
200000u
bitrate_observer_2
.
last_bitrate_
)
;
EXPECT_EQ
(
200000u
bitrate_observer_3
.
last_bitrate_
)
;
allocator_
-
>
OnNetworkChanged
(
10000
0
0
)
;
EXPECT_EQ
(
10000u
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
0u
bitrate_observer_2
.
last_bitrate_
)
;
EXPECT_EQ
(
0u
bitrate_observer_3
.
last_bitrate_
)
;
allocator_
-
>
RemoveBitrateObserver
(
&
bitrate_observer_1
)
;
allocator_
-
>
RemoveBitrateObserver
(
&
bitrate_observer_2
)
;
allocator_
-
>
RemoveBitrateObserver
(
&
bitrate_observer_3
)
;
}
TEST_F
(
BitrateAllocatorTest
ThreeBitrateObserversLowRembEnforceMin
)
{
TestBitrateObserver
bitrate_observer_1
;
TestBitrateObserver
bitrate_observer_2
;
TestBitrateObserver
bitrate_observer_3
;
int
start_bitrate
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_1
200000
100000
400000
&
start_bitrate
)
;
EXPECT_EQ
(
300000
start_bitrate
)
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_2
200000
200000
400000
&
start_bitrate
)
;
EXPECT_EQ
(
200000
start_bitrate
)
;
EXPECT_EQ
(
100000u
bitrate_observer_1
.
last_bitrate_
)
;
allocator_
-
>
AddBitrateObserver
(
&
bitrate_observer_3
200000
300000
400000
&
start_bitrate
)
;
EXPECT_EQ
(
300000
start_bitrate
)
;
EXPECT_EQ
(
100000
static_cast
<
int
>
(
bitrate_observer_1
.
last_bitrate_
)
)
;
EXPECT_EQ
(
200000
static_cast
<
int
>
(
bitrate_observer_2
.
last_bitrate_
)
)
;
allocator_
-
>
OnNetworkChanged
(
1000
0
0
)
;
EXPECT_EQ
(
100000u
bitrate_observer_1
.
last_bitrate_
)
;
EXPECT_EQ
(
200000u
bitrate_observer_2
.
last_bitrate_
)
;
EXPECT_EQ
(
300000u
bitrate_observer_3
.
last_bitrate_
)
;
allocator_
-
>
RemoveBitrateObserver
(
&
bitrate_observer_1
)
;
allocator_
-
>
RemoveBitrateObserver
(
&
bitrate_observer_2
)
;
allocator_
-
>
RemoveBitrateObserver
(
&
bitrate_observer_3
)
;
}
}
