#
ifndef
WEBRTC_MODULES_VIDEO_CODING_RTP_FRAME_REFERENCE_FINDER_H_
#
define
WEBRTC_MODULES_VIDEO_CODING_RTP_FRAME_REFERENCE_FINDER_H_
#
include
<
array
>
#
include
<
map
>
#
include
<
memory
>
#
include
<
deque
>
#
include
<
set
>
#
include
<
utility
>
#
include
"
webrtc
/
base
/
criticalsection
.
h
"
#
include
"
webrtc
/
base
/
thread_annotations
.
h
"
#
include
"
webrtc
/
modules
/
include
/
module_common_types
.
h
"
#
include
"
webrtc
/
modules
/
video_coding
/
sequence_number_util
.
h
"
namespace
webrtc
{
namespace
video_coding
{
class
FrameObject
;
class
RtpFrameObject
;
class
OnCompleteFrameCallback
{
public
:
virtual
~
OnCompleteFrameCallback
(
)
{
}
virtual
void
OnCompleteFrame
(
std
:
:
unique_ptr
<
FrameObject
>
frame
)
=
0
;
}
;
class
RtpFrameReferenceFinder
{
public
:
explicit
RtpFrameReferenceFinder
(
OnCompleteFrameCallback
*
frame_callback
)
;
void
ManageFrame
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
;
void
PaddingReceived
(
uint16_t
seq_num
)
;
void
ClearTo
(
uint16_t
seq_num
)
;
private
:
static
const
uint16_t
kPicIdLength
=
1
<
<
15
;
static
const
uint8_t
kMaxTemporalLayers
=
5
;
static
const
int
kMaxLayerInfo
=
50
;
static
const
int
kMaxStashedFrames
=
50
;
static
const
int
kMaxNotYetReceivedFrames
=
100
;
static
const
int
kMaxGofSaved
=
50
;
static
const
int
kMaxPaddingAge
=
100
;
struct
GofInfo
{
GofInfo
(
GofInfoVP9
*
gof
uint16_t
last_picture_id
)
:
gof
(
gof
)
last_picture_id
(
last_picture_id
)
{
}
GofInfoVP9
*
gof
;
uint16_t
last_picture_id
;
}
;
rtc
:
:
CriticalSection
crit_
;
void
UpdateLastPictureIdWithPadding
(
uint16_t
seq_num
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
void
RetryStashedFrames
(
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
void
ManageFrameGeneric
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
int
picture_id
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
void
ManageFrameVp8
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
void
CompletedFrameVp8
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
void
ManageFrameVp9
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
void
CompletedFrameVp9
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
bool
MissingRequiredFrameVp9
(
uint16_t
picture_id
const
GofInfo
&
info
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
void
FrameReceivedVp9
(
uint16_t
picture_id
GofInfo
*
info
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
bool
UpSwitchInIntervalVp9
(
uint16_t
picture_id
uint8_t
temporal_idx
uint16_t
pid_ref
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
uint16_t
UnwrapPictureId
(
uint16_t
picture_id
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
bool
Vp9PidTl0Fix
(
const
RtpFrameObject
&
frame
int16_t
*
picture_id
int16_t
*
tl0_pic_idx
)
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
bool
DetectVp9PicIdJump
(
int
fixed_pid
int
fixed_tl0
uint32_t
timestamp
)
const
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
bool
DetectVp9Tl0PicIdxJump
(
int
fixed_tl0
uint32_t
timestamp
)
const
EXCLUSIVE_LOCKS_REQUIRED
(
crit_
)
;
std
:
:
map
<
uint16_t
std
:
:
pair
<
uint16_t
uint16_t
>
DescendingSeqNumComp
<
uint16_t
>
>
last_seq_num_gop_
GUARDED_BY
(
crit_
)
;
int
last_picture_id_
GUARDED_BY
(
crit_
)
;
std
:
:
set
<
uint16_t
DescendingSeqNumComp
<
uint16_t
>
>
stashed_padding_
GUARDED_BY
(
crit_
)
;
int
last_unwrap_
GUARDED_BY
(
crit_
)
;
std
:
:
set
<
uint16_t
DescendingSeqNumComp
<
uint16_t
kPicIdLength
>
>
not_yet_received_frames_
GUARDED_BY
(
crit_
)
;
std
:
:
deque
<
std
:
:
unique_ptr
<
RtpFrameObject
>
>
stashed_frames_
GUARDED_BY
(
crit_
)
;
std
:
:
map
<
uint8_t
std
:
:
array
<
int16_t
kMaxTemporalLayers
>
DescendingSeqNumComp
<
uint8_t
>
>
layer_info_
GUARDED_BY
(
crit_
)
;
uint8_t
current_ss_idx_
;
std
:
:
array
<
GofInfoVP9
kMaxGofSaved
>
scalability_structures_
GUARDED_BY
(
crit_
)
;
std
:
:
map
<
uint8_t
GofInfo
DescendingSeqNumComp
<
uint8_t
>
>
gof_info_
GUARDED_BY
(
crit_
)
;
std
:
:
map
<
uint16_t
uint8_t
DescendingSeqNumComp
<
uint16_t
kPicIdLength
>
>
up_switch_
GUARDED_BY
(
crit_
)
;
std
:
:
array
<
std
:
:
set
<
uint16_t
DescendingSeqNumComp
<
uint16_t
kPicIdLength
>
>
kMaxTemporalLayers
>
missing_frames_for_layer_
GUARDED_BY
(
crit_
)
;
int
cleared_to_seq_num_
GUARDED_BY
(
crit_
)
;
OnCompleteFrameCallback
*
frame_callback_
;
int
vp9_fix_last_timestamp_
=
-
1
;
int
vp9_fix_jump_timestamp_
=
-
1
;
int
vp9_fix_last_picture_id_
=
-
1
;
int
vp9_fix_pid_offset_
=
0
;
int
vp9_fix_last_tl0_pic_idx_
=
-
1
;
int
vp9_fix_tl0_pic_idx_offset_
=
0
;
}
;
}
}
#
endif
