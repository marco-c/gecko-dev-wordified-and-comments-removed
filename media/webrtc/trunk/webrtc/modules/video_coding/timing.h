#
ifndef
MODULES_VIDEO_CODING_TIMING_H_
#
define
MODULES_VIDEO_CODING_TIMING_H_
#
include
<
memory
>
#
include
"
modules
/
video_coding
/
codec_timer
.
h
"
#
include
"
rtc_base
/
criticalsection
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
#
include
"
typedefs
.
h
"
namespace
webrtc
{
class
Clock
;
class
TimestampExtrapolator
;
class
VCMTiming
{
public
:
explicit
VCMTiming
(
Clock
*
clock
VCMTiming
*
master_timing
=
NULL
)
;
virtual
~
VCMTiming
(
)
;
void
Reset
(
)
;
void
ResetDecodeTime
(
)
;
void
set_render_delay
(
int
render_delay_ms
)
;
void
SetJitterDelay
(
int
required_delay_ms
)
;
void
set_min_playout_delay
(
int
min_playout_delay_ms
)
;
int
min_playout_delay
(
)
;
void
set_max_playout_delay
(
int
max_playout_delay_ms
)
;
int
max_playout_delay
(
)
;
void
UpdateCurrentDelay
(
uint32_t
frame_timestamp
)
;
void
UpdateCurrentDelay
(
int64_t
render_time_ms
int64_t
actual_decode_time_ms
)
;
int32_t
StopDecodeTimer
(
uint32_t
time_stamp
int32_t
decode_time_ms
int64_t
now_ms
int64_t
render_time_ms
)
;
void
IncomingTimestamp
(
uint32_t
time_stamp
int64_t
last_packet_time_ms
)
;
virtual
int64_t
RenderTimeMs
(
uint32_t
frame_timestamp
int64_t
now_ms
)
const
;
virtual
uint32_t
MaxWaitingTime
(
int64_t
render_time_ms
int64_t
now_ms
)
const
;
int
TargetVideoDelay
(
)
const
;
bool
EnoughTimeToDecode
(
uint32_t
available_processing_time_ms
)
const
;
virtual
bool
GetTimings
(
int
*
decode_ms
int
*
max_decode_ms
int
*
current_delay_ms
int
*
target_delay_ms
int
*
jitter_buffer_ms
int
*
min_playout_delay_ms
int
*
render_delay_ms
)
const
;
void
SetTimingFrameInfo
(
const
TimingFrameInfo
&
info
)
;
rtc
:
:
Optional
<
TimingFrameInfo
>
GetTimingFrameInfo
(
)
;
enum
{
kDefaultRenderDelayMs
=
10
}
;
enum
{
kDelayMaxChangeMsPerS
=
100
}
;
protected
:
int
RequiredDecodeTimeMs
(
)
const
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int64_t
RenderTimeMsInternal
(
uint32_t
frame_timestamp
int64_t
now_ms
)
const
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
TargetDelayInternal
(
)
const
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
private
:
void
UpdateHistograms
(
)
const
;
rtc
:
:
CriticalSection
crit_sect_
;
Clock
*
const
clock_
;
bool
master_
RTC_GUARDED_BY
(
crit_sect_
)
;
TimestampExtrapolator
*
ts_extrapolator_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
VCMCodecTimer
>
codec_timer_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
render_delay_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
min_playout_delay_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
max_playout_delay_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
jitter_delay_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
current_delay_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
last_decode_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
uint32_t
prev_frame_timestamp_
RTC_GUARDED_BY
(
crit_sect_
)
;
rtc
:
:
Optional
<
TimingFrameInfo
>
timing_frame_info_
RTC_GUARDED_BY
(
crit_sect_
)
;
size_t
num_decoded_frames_
RTC_GUARDED_BY
(
crit_sect_
)
;
size_t
num_delayed_decoded_frames_
RTC_GUARDED_BY
(
crit_sect_
)
;
int64_t
first_decoded_frame_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
uint64_t
sum_missed_render_deadline_ms_
RTC_GUARDED_BY
(
crit_sect_
)
;
}
;
}
#
endif
