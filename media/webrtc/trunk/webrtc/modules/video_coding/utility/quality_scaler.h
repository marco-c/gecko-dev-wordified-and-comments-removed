#
ifndef
WEBRTC_MODULES_VIDEO_CODING_UTILITY_QUALITY_SCALER_H_
#
define
WEBRTC_MODULES_VIDEO_CODING_UTILITY_QUALITY_SCALER_H_
#
include
<
utility
>
#
include
"
webrtc
/
common_types
.
h
"
#
include
"
webrtc
/
video_encoder
.
h
"
#
include
"
webrtc
/
base
/
optional
.
h
"
#
include
"
webrtc
/
base
/
sequenced_task_checker
.
h
"
#
include
"
webrtc
/
modules
/
video_coding
/
utility
/
moving_average
.
h
"
namespace
webrtc
{
class
ScalingObserverInterface
{
public
:
enum
ScaleReason
:
size_t
{
kQuality
=
0
kCpu
=
1
}
;
static
const
size_t
kScaleReasonSize
=
2
;
virtual
void
ScaleUp
(
ScaleReason
reason
)
=
0
;
virtual
void
ScaleDown
(
ScaleReason
reason
)
=
0
;
protected
:
virtual
~
ScalingObserverInterface
(
)
{
}
}
;
class
QualityScaler
{
public
:
QualityScaler
(
ScalingObserverInterface
*
observer
VideoCodecType
codec_type
)
;
QualityScaler
(
ScalingObserverInterface
*
observer
VideoEncoder
:
:
QpThresholds
thresholds
)
;
virtual
~
QualityScaler
(
)
;
void
ReportDroppedFrame
(
)
;
void
ReportQP
(
int
qp
)
;
protected
:
QualityScaler
(
ScalingObserverInterface
*
observer
VideoEncoder
:
:
QpThresholds
thresholds
int64_t
sampling_period
)
;
private
:
class
CheckQPTask
;
void
CheckQP
(
)
;
void
ClearSamples
(
)
;
void
ReportQPLow
(
)
;
void
ReportQPHigh
(
)
;
int64_t
GetSamplingPeriodMs
(
)
const
;
CheckQPTask
*
check_qp_task_
GUARDED_BY
(
&
task_checker_
)
;
ScalingObserverInterface
*
const
observer_
GUARDED_BY
(
&
task_checker_
)
;
rtc
:
:
SequencedTaskChecker
task_checker_
;
const
int64_t
sampling_period_ms_
;
bool
fast_rampup_
GUARDED_BY
(
&
task_checker_
)
;
MovingAverage
average_qp_
GUARDED_BY
(
&
task_checker_
)
;
MovingAverage
framedrop_percent_
GUARDED_BY
(
&
task_checker_
)
;
VideoEncoder
:
:
QpThresholds
thresholds_
GUARDED_BY
(
&
task_checker_
)
;
}
;
}
#
endif
