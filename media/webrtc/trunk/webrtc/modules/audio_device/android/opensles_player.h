#
ifndef
WEBRTC_MODULES_AUDIO_DEVICE_ANDROID_OPENSLES_PLAYER_H_
#
define
WEBRTC_MODULES_AUDIO_DEVICE_ANDROID_OPENSLES_PLAYER_H_
#
include
<
SLES
/
OpenSLES
.
h
>
#
include
<
SLES
/
OpenSLES_Android
.
h
>
#
include
<
SLES
/
OpenSLES_AndroidConfiguration
.
h
>
#
include
"
webrtc
/
base
/
thread_checker
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
android
/
audio_common
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
android
/
audio_manager
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
android
/
opensles_common
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
include
/
audio_device_defines
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
audio_device_generic
.
h
"
#
include
"
webrtc
/
modules
/
utility
/
include
/
helpers_android
.
h
"
namespace
webrtc
{
class
FineAudioBuffer
;
class
OpenSLESPlayer
{
public
:
static
const
int
kNumOfOpenSLESBuffers
=
2
;
explicit
OpenSLESPlayer
(
AudioManager
*
audio_manager
)
;
~
OpenSLESPlayer
(
)
;
int
Init
(
)
;
int
Terminate
(
)
;
int
InitPlayout
(
)
;
bool
PlayoutIsInitialized
(
)
const
{
return
initialized_
;
}
int
StartPlayout
(
)
;
int
StopPlayout
(
)
;
bool
Playing
(
)
const
{
return
playing_
;
}
int
SpeakerVolumeIsAvailable
(
bool
&
available
)
;
int
SetSpeakerVolume
(
uint32_t
volume
)
;
int
SpeakerVolume
(
uint32_t
&
volume
)
const
;
int
MaxSpeakerVolume
(
uint32_t
&
maxVolume
)
const
;
int
MinSpeakerVolume
(
uint32_t
&
minVolume
)
const
;
void
AttachAudioBuffer
(
AudioDeviceBuffer
*
audioBuffer
)
;
private
:
static
void
SimpleBufferQueueCallback
(
SLAndroidSimpleBufferQueueItf
caller
void
*
context
)
;
void
FillBufferQueue
(
)
;
void
EnqueuePlayoutData
(
bool
silence
)
;
void
AllocateDataBuffers
(
)
;
bool
ObtainEngineInterface
(
)
;
bool
CreateMix
(
)
;
void
DestroyMix
(
)
;
bool
CreateAudioPlayer
(
)
;
void
DestroyAudioPlayer
(
)
;
SLuint32
GetPlayState
(
)
const
;
rtc
:
:
ThreadChecker
thread_checker_
;
rtc
:
:
ThreadChecker
thread_checker_opensles_
;
AudioManager
*
audio_manager_
;
const
AudioParameters
audio_parameters_
;
AudioDeviceBuffer
*
audio_device_buffer_
;
bool
initialized_
;
bool
playing_
;
SLDataFormat_PCM
pcm_format_
;
std
:
:
unique_ptr
<
SLint8
[
]
>
audio_buffers_
[
kNumOfOpenSLESBuffers
]
;
std
:
:
unique_ptr
<
FineAudioBuffer
>
fine_audio_buffer_
;
int
buffer_index_
;
SLEngineItf
engine_
;
webrtc
:
:
ScopedSLObjectItf
output_mix_
;
webrtc
:
:
ScopedSLObjectItf
player_object_
;
SLPlayItf
player_
;
SLAndroidSimpleBufferQueueItf
simple_buffer_queue_
;
SLVolumeItf
volume_
;
uint32_t
last_play_time_
;
void
*
opensles_lib_
;
typedef
SLresult
(
*
slCreateEngine_t
)
(
SLObjectItf
*
SLuint32
const
SLEngineOption
*
SLuint32
const
SLInterfaceID
*
const
SLboolean
*
)
;
slCreateEngine_t
slCreateEngine_
;
SLInterfaceID
SL_IID_ENGINE_
;
SLInterfaceID
SL_IID_ANDROIDCONFIGURATION_
;
SLInterfaceID
SL_IID_BUFFERQUEUE_
;
SLInterfaceID
SL_IID_VOLUME_
;
SLInterfaceID
SL_IID_PLAY_
;
}
;
}
#
endif
