#
include
<
math
.
h
>
#
include
<
stdio
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
string
.
h
>
#
include
"
modules
/
audio_device
/
mac
/
portaudio
/
pa_memorybarrier
.
h
"
#
include
"
modules
/
audio_device
/
mac
/
portaudio
/
pa_ringbuffer
.
h
"
PaRingBufferSize
PaUtil_InitializeRingBuffer
(
PaUtilRingBuffer
*
rbuf
PaRingBufferSize
elementSizeBytes
PaRingBufferSize
elementCount
void
*
dataPtr
)
{
if
(
(
(
elementCount
-
1
)
&
elementCount
)
!
=
0
)
return
-
1
;
rbuf
-
>
bufferSize
=
elementCount
;
rbuf
-
>
buffer
=
(
char
*
)
dataPtr
;
PaUtil_FlushRingBuffer
(
rbuf
)
;
rbuf
-
>
bigMask
=
(
elementCount
*
2
)
-
1
;
rbuf
-
>
smallMask
=
(
elementCount
)
-
1
;
rbuf
-
>
elementSizeBytes
=
elementSizeBytes
;
return
0
;
}
PaRingBufferSize
PaUtil_GetRingBufferReadAvailable
(
PaUtilRingBuffer
*
rbuf
)
{
PaUtil_ReadMemoryBarrier
(
)
;
return
(
(
rbuf
-
>
writeIndex
-
rbuf
-
>
readIndex
)
&
rbuf
-
>
bigMask
)
;
}
PaRingBufferSize
PaUtil_GetRingBufferWriteAvailable
(
PaUtilRingBuffer
*
rbuf
)
{
return
(
rbuf
-
>
bufferSize
-
PaUtil_GetRingBufferReadAvailable
(
rbuf
)
)
;
}
void
PaUtil_FlushRingBuffer
(
PaUtilRingBuffer
*
rbuf
)
{
rbuf
-
>
writeIndex
=
rbuf
-
>
readIndex
=
0
;
}
PaRingBufferSize
PaUtil_GetRingBufferWriteRegions
(
PaUtilRingBuffer
*
rbuf
PaRingBufferSize
elementCount
void
*
*
dataPtr1
PaRingBufferSize
*
sizePtr1
void
*
*
dataPtr2
PaRingBufferSize
*
sizePtr2
)
{
PaRingBufferSize
index
;
PaRingBufferSize
available
=
PaUtil_GetRingBufferWriteAvailable
(
rbuf
)
;
if
(
elementCount
>
available
)
elementCount
=
available
;
index
=
rbuf
-
>
writeIndex
&
rbuf
-
>
smallMask
;
if
(
(
index
+
elementCount
)
>
rbuf
-
>
bufferSize
)
{
PaRingBufferSize
firstHalf
=
rbuf
-
>
bufferSize
-
index
;
*
dataPtr1
=
&
rbuf
-
>
buffer
[
index
*
rbuf
-
>
elementSizeBytes
]
;
*
sizePtr1
=
firstHalf
;
*
dataPtr2
=
&
rbuf
-
>
buffer
[
0
]
;
*
sizePtr2
=
elementCount
-
firstHalf
;
}
else
{
*
dataPtr1
=
&
rbuf
-
>
buffer
[
index
*
rbuf
-
>
elementSizeBytes
]
;
*
sizePtr1
=
elementCount
;
*
dataPtr2
=
NULL
;
*
sizePtr2
=
0
;
}
return
elementCount
;
}
PaRingBufferSize
PaUtil_AdvanceRingBufferWriteIndex
(
PaUtilRingBuffer
*
rbuf
PaRingBufferSize
elementCount
)
{
PaUtil_WriteMemoryBarrier
(
)
;
return
rbuf
-
>
writeIndex
=
(
rbuf
-
>
writeIndex
+
elementCount
)
&
rbuf
-
>
bigMask
;
}
PaRingBufferSize
PaUtil_GetRingBufferReadRegions
(
PaUtilRingBuffer
*
rbuf
PaRingBufferSize
elementCount
void
*
*
dataPtr1
PaRingBufferSize
*
sizePtr1
void
*
*
dataPtr2
PaRingBufferSize
*
sizePtr2
)
{
PaRingBufferSize
index
;
PaRingBufferSize
available
=
PaUtil_GetRingBufferReadAvailable
(
rbuf
)
;
if
(
elementCount
>
available
)
elementCount
=
available
;
index
=
rbuf
-
>
readIndex
&
rbuf
-
>
smallMask
;
if
(
(
index
+
elementCount
)
>
rbuf
-
>
bufferSize
)
{
PaRingBufferSize
firstHalf
=
rbuf
-
>
bufferSize
-
index
;
*
dataPtr1
=
&
rbuf
-
>
buffer
[
index
*
rbuf
-
>
elementSizeBytes
]
;
*
sizePtr1
=
firstHalf
;
*
dataPtr2
=
&
rbuf
-
>
buffer
[
0
]
;
*
sizePtr2
=
elementCount
-
firstHalf
;
}
else
{
*
dataPtr1
=
&
rbuf
-
>
buffer
[
index
*
rbuf
-
>
elementSizeBytes
]
;
*
sizePtr1
=
elementCount
;
*
dataPtr2
=
NULL
;
*
sizePtr2
=
0
;
}
return
elementCount
;
}
PaRingBufferSize
PaUtil_AdvanceRingBufferReadIndex
(
PaUtilRingBuffer
*
rbuf
PaRingBufferSize
elementCount
)
{
PaUtil_WriteMemoryBarrier
(
)
;
return
rbuf
-
>
readIndex
=
(
rbuf
-
>
readIndex
+
elementCount
)
&
rbuf
-
>
bigMask
;
}
PaRingBufferSize
PaUtil_WriteRingBuffer
(
PaUtilRingBuffer
*
rbuf
const
void
*
data
PaRingBufferSize
elementCount
)
{
PaRingBufferSize
size1
size2
numWritten
;
void
*
data1
*
data2
;
numWritten
=
PaUtil_GetRingBufferWriteRegions
(
rbuf
elementCount
&
data1
&
size1
&
data2
&
size2
)
;
if
(
size2
>
0
)
{
memcpy
(
data1
data
size1
*
rbuf
-
>
elementSizeBytes
)
;
data
=
(
(
char
*
)
data
)
+
size1
*
rbuf
-
>
elementSizeBytes
;
memcpy
(
data2
data
size2
*
rbuf
-
>
elementSizeBytes
)
;
}
else
{
memcpy
(
data1
data
size1
*
rbuf
-
>
elementSizeBytes
)
;
}
PaUtil_AdvanceRingBufferWriteIndex
(
rbuf
numWritten
)
;
return
numWritten
;
}
PaRingBufferSize
PaUtil_ReadRingBuffer
(
PaUtilRingBuffer
*
rbuf
void
*
data
PaRingBufferSize
elementCount
)
{
PaRingBufferSize
size1
size2
numRead
;
void
*
data1
*
data2
;
numRead
=
PaUtil_GetRingBufferReadRegions
(
rbuf
elementCount
&
data1
&
size1
&
data2
&
size2
)
;
if
(
size2
>
0
)
{
memcpy
(
data
data1
size1
*
rbuf
-
>
elementSizeBytes
)
;
data
=
(
(
char
*
)
data
)
+
size1
*
rbuf
-
>
elementSizeBytes
;
memcpy
(
data
data2
size2
*
rbuf
-
>
elementSizeBytes
)
;
}
else
{
memcpy
(
data
data1
size1
*
rbuf
-
>
elementSizeBytes
)
;
}
PaUtil_AdvanceRingBufferReadIndex
(
rbuf
numRead
)
;
return
numRead
;
}
