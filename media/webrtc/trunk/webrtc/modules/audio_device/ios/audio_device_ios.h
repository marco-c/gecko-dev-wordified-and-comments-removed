#
ifndef
WEBRTC_MODULES_AUDIO_DEVICE_IOS_AUDIO_DEVICE_IOS_H_
#
define
WEBRTC_MODULES_AUDIO_DEVICE_IOS_AUDIO_DEVICE_IOS_H_
#
include
<
memory
>
#
include
"
WebRTC
/
RTCMacros
.
h
"
#
include
"
webrtc
/
base
/
thread
.
h
"
#
include
"
webrtc
/
base
/
thread_checker
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
audio_device_generic
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
ios
/
audio_session_observer
.
h
"
#
include
"
webrtc
/
modules
/
audio_device
/
ios
/
voice_processing_audio_unit
.
h
"
RTC_FWD_DECL_OBJC_CLASS
(
RTCAudioSessionDelegateAdapter
)
;
namespace
webrtc
{
class
FineAudioBuffer
;
class
AudioDeviceIOS
:
public
AudioDeviceGeneric
public
AudioSessionObserver
public
VoiceProcessingAudioUnitObserver
public
rtc
:
:
MessageHandler
{
public
:
AudioDeviceIOS
(
)
;
~
AudioDeviceIOS
(
)
;
void
AttachAudioBuffer
(
AudioDeviceBuffer
*
audioBuffer
)
override
;
InitStatus
Init
(
)
override
;
int32_t
Terminate
(
)
override
;
bool
Initialized
(
)
const
override
{
return
initialized_
;
}
int32_t
InitPlayout
(
)
override
;
bool
PlayoutIsInitialized
(
)
const
override
{
return
audio_is_initialized_
;
}
int32_t
InitRecording
(
)
override
;
bool
RecordingIsInitialized
(
)
const
override
{
return
audio_is_initialized_
;
}
int32_t
StartPlayout
(
)
override
;
int32_t
StopPlayout
(
)
override
;
bool
Playing
(
)
const
override
{
return
playing_
;
}
int32_t
StartRecording
(
)
override
;
int32_t
StopRecording
(
)
override
;
bool
Recording
(
)
const
override
{
return
recording_
;
}
int32_t
SetLoudspeakerStatus
(
bool
enable
)
override
;
int32_t
GetLoudspeakerStatus
(
bool
&
enabled
)
const
override
;
int32_t
PlayoutDelay
(
uint16_t
&
delayMS
)
const
override
;
int32_t
RecordingDelay
(
uint16_t
&
delayMS
)
const
override
;
int
GetPlayoutAudioParameters
(
AudioParameters
*
params
)
const
override
;
int
GetRecordAudioParameters
(
AudioParameters
*
params
)
const
override
;
int32_t
PlayoutBuffer
(
AudioDeviceModule
:
:
BufferType
&
type
uint16_t
&
sizeMS
)
const
override
;
int32_t
ActiveAudioLayer
(
AudioDeviceModule
:
:
AudioLayer
&
audioLayer
)
const
override
;
int32_t
ResetAudioDevice
(
)
override
;
int32_t
PlayoutIsAvailable
(
bool
&
available
)
override
;
int32_t
RecordingIsAvailable
(
bool
&
available
)
override
;
int32_t
SetAGC
(
bool
enable
)
override
;
bool
AGC
(
)
const
override
;
int16_t
PlayoutDevices
(
)
override
;
int16_t
RecordingDevices
(
)
override
;
int32_t
PlayoutDeviceName
(
uint16_t
index
char
name
[
kAdmMaxDeviceNameSize
]
char
guid
[
kAdmMaxGuidSize
]
)
override
;
int32_t
RecordingDeviceName
(
uint16_t
index
char
name
[
kAdmMaxDeviceNameSize
]
char
guid
[
kAdmMaxGuidSize
]
)
override
;
int32_t
SetPlayoutDevice
(
uint16_t
index
)
override
;
int32_t
SetPlayoutDevice
(
AudioDeviceModule
:
:
WindowsDeviceType
device
)
override
;
int32_t
SetRecordingDevice
(
uint16_t
index
)
override
;
int32_t
SetRecordingDevice
(
AudioDeviceModule
:
:
WindowsDeviceType
device
)
override
;
int32_t
SetWaveOutVolume
(
uint16_t
volumeLeft
uint16_t
volumeRight
)
override
;
int32_t
WaveOutVolume
(
uint16_t
&
volumeLeft
uint16_t
&
volumeRight
)
const
override
;
int32_t
InitSpeaker
(
)
override
;
bool
SpeakerIsInitialized
(
)
const
override
;
int32_t
InitMicrophone
(
)
override
;
bool
MicrophoneIsInitialized
(
)
const
override
;
int32_t
SpeakerVolumeIsAvailable
(
bool
&
available
)
override
;
int32_t
SetSpeakerVolume
(
uint32_t
volume
)
override
;
int32_t
SpeakerVolume
(
uint32_t
&
volume
)
const
override
;
int32_t
MaxSpeakerVolume
(
uint32_t
&
maxVolume
)
const
override
;
int32_t
MinSpeakerVolume
(
uint32_t
&
minVolume
)
const
override
;
int32_t
SpeakerVolumeStepSize
(
uint16_t
&
stepSize
)
const
override
;
int32_t
MicrophoneVolumeIsAvailable
(
bool
&
available
)
override
;
int32_t
SetMicrophoneVolume
(
uint32_t
volume
)
override
;
int32_t
MicrophoneVolume
(
uint32_t
&
volume
)
const
override
;
int32_t
MaxMicrophoneVolume
(
uint32_t
&
maxVolume
)
const
override
;
int32_t
MinMicrophoneVolume
(
uint32_t
&
minVolume
)
const
override
;
int32_t
MicrophoneVolumeStepSize
(
uint16_t
&
stepSize
)
const
override
;
int32_t
MicrophoneMuteIsAvailable
(
bool
&
available
)
override
;
int32_t
SetMicrophoneMute
(
bool
enable
)
override
;
int32_t
MicrophoneMute
(
bool
&
enabled
)
const
override
;
int32_t
SpeakerMuteIsAvailable
(
bool
&
available
)
override
;
int32_t
SetSpeakerMute
(
bool
enable
)
override
;
int32_t
SpeakerMute
(
bool
&
enabled
)
const
override
;
int32_t
MicrophoneBoostIsAvailable
(
bool
&
available
)
override
;
int32_t
SetMicrophoneBoost
(
bool
enable
)
override
;
int32_t
MicrophoneBoost
(
bool
&
enabled
)
const
override
;
int32_t
StereoPlayoutIsAvailable
(
bool
&
available
)
override
;
int32_t
SetStereoPlayout
(
bool
enable
)
override
;
int32_t
StereoPlayout
(
bool
&
enabled
)
const
override
;
int32_t
StereoRecordingIsAvailable
(
bool
&
available
)
override
;
int32_t
SetStereoRecording
(
bool
enable
)
override
;
int32_t
StereoRecording
(
bool
&
enabled
)
const
override
;
int32_t
SetPlayoutBuffer
(
const
AudioDeviceModule
:
:
BufferType
type
uint16_t
sizeMS
)
override
;
int32_t
CPULoad
(
uint16_t
&
load
)
const
override
;
bool
PlayoutWarning
(
)
const
override
;
bool
PlayoutError
(
)
const
override
;
bool
RecordingWarning
(
)
const
override
;
bool
RecordingError
(
)
const
override
;
void
ClearPlayoutWarning
(
)
override
{
}
void
ClearPlayoutError
(
)
override
{
}
void
ClearRecordingWarning
(
)
override
{
}
void
ClearRecordingError
(
)
override
{
}
void
OnInterruptionBegin
(
)
override
;
void
OnInterruptionEnd
(
)
override
;
void
OnValidRouteChange
(
)
override
;
void
OnCanPlayOrRecordChange
(
bool
can_play_or_record
)
override
;
OSStatus
OnDeliverRecordedData
(
AudioUnitRenderActionFlags
*
flags
const
AudioTimeStamp
*
time_stamp
UInt32
bus_number
UInt32
num_frames
AudioBufferList
*
io_data
)
override
;
OSStatus
OnGetPlayoutData
(
AudioUnitRenderActionFlags
*
flags
const
AudioTimeStamp
*
time_stamp
UInt32
bus_number
UInt32
num_frames
AudioBufferList
*
io_data
)
override
;
void
OnMessage
(
rtc
:
:
Message
*
msg
)
override
;
private
:
void
HandleInterruptionBegin
(
)
;
void
HandleInterruptionEnd
(
)
;
void
HandleValidRouteChange
(
)
;
void
HandleCanPlayOrRecordChange
(
bool
can_play_or_record
)
;
void
HandleSampleRateChange
(
float
sample_rate
)
;
void
UpdateAudioDeviceBuffer
(
)
;
void
SetupAudioBuffersForActiveAudioSession
(
)
;
bool
CreateAudioUnit
(
)
;
void
UpdateAudioUnit
(
bool
can_play_or_record
)
;
void
ConfigureAudioSession
(
)
;
void
UnconfigureAudioSession
(
)
;
bool
InitPlayOrRecord
(
)
;
void
ShutdownPlayOrRecord
(
)
;
rtc
:
:
ThreadChecker
thread_checker_
;
rtc
:
:
Thread
*
thread_
;
AudioDeviceBuffer
*
audio_device_buffer_
;
AudioParameters
playout_parameters_
;
AudioParameters
record_parameters_
;
std
:
:
unique_ptr
<
VoiceProcessingAudioUnit
>
audio_unit_
;
std
:
:
unique_ptr
<
FineAudioBuffer
>
fine_audio_buffer_
;
std
:
:
unique_ptr
<
int8_t
[
]
>
playout_audio_buffer_
;
AudioBufferList
audio_record_buffer_list_
;
std
:
:
unique_ptr
<
int8_t
[
]
>
record_audio_buffer_
;
volatile
int
recording_
;
volatile
int
playing_
;
bool
initialized_
;
bool
audio_is_initialized_
;
bool
is_interrupted_
;
RTCAudioSessionDelegateAdapter
*
audio_session_observer_
;
bool
has_configured_session_
;
}
;
}
#
endif
