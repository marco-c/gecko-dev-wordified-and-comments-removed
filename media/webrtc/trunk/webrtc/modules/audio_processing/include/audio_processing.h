#
ifndef
WEBRTC_MODULES_AUDIO_PROCESSING_INCLUDE_AUDIO_PROCESSING_H_
#
define
WEBRTC_MODULES_AUDIO_PROCESSING_INCLUDE_AUDIO_PROCESSING_H_
#
ifndef
_USE_MATH_DEFINES
#
define
_USE_MATH_DEFINES
#
endif
#
include
<
math
.
h
>
#
include
<
stddef
.
h
>
#
include
<
stdio
.
h
>
#
include
<
vector
>
#
include
"
webrtc
/
base
/
arraysize
.
h
"
#
include
"
webrtc
/
base
/
platform_file
.
h
"
#
include
"
webrtc
/
common
.
h
"
#
include
"
webrtc
/
modules
/
audio_processing
/
beamformer
/
array_util
.
h
"
#
include
"
webrtc
/
typedefs
.
h
"
struct
AecCore
;
namespace
webrtc
{
class
AudioFrame
;
template
<
typename
T
>
class
Beamformer
;
class
StreamConfig
;
class
ProcessingConfig
;
class
EchoCancellation
;
class
EchoControlMobile
;
class
GainControl
;
class
HighPassFilter
;
class
LevelEstimator
;
class
NoiseSuppression
;
class
VoiceDetection
;
struct
ExtendedFilter
{
ExtendedFilter
(
)
:
enabled
(
false
)
{
}
explicit
ExtendedFilter
(
bool
enabled
)
:
enabled
(
enabled
)
{
}
static
const
ConfigOptionID
identifier
=
ConfigOptionID
:
:
kExtendedFilter
;
bool
enabled
;
}
;
struct
DelayAgnostic
{
DelayAgnostic
(
)
:
enabled
(
false
)
{
}
explicit
DelayAgnostic
(
bool
enabled
)
:
enabled
(
enabled
)
{
}
static
const
ConfigOptionID
identifier
=
ConfigOptionID
:
:
kDelayAgnostic
;
bool
enabled
;
}
;
#
if
defined
(
WEBRTC_CHROMIUM_BUILD
)
static
const
int
kAgcStartupMinVolume
=
85
;
#
else
static
const
int
kAgcStartupMinVolume
=
0
;
#
endif
struct
ExperimentalAgc
{
ExperimentalAgc
(
)
:
enabled
(
true
)
startup_min_volume
(
kAgcStartupMinVolume
)
{
}
explicit
ExperimentalAgc
(
bool
enabled
)
:
enabled
(
enabled
)
startup_min_volume
(
kAgcStartupMinVolume
)
{
}
ExperimentalAgc
(
bool
enabled
int
startup_min_volume
)
:
enabled
(
enabled
)
startup_min_volume
(
startup_min_volume
)
{
}
static
const
ConfigOptionID
identifier
=
ConfigOptionID
:
:
kExperimentalAgc
;
bool
enabled
;
int
startup_min_volume
;
}
;
struct
ExperimentalNs
{
ExperimentalNs
(
)
:
enabled
(
false
)
{
}
explicit
ExperimentalNs
(
bool
enabled
)
:
enabled
(
enabled
)
{
}
static
const
ConfigOptionID
identifier
=
ConfigOptionID
:
:
kExperimentalNs
;
bool
enabled
;
}
;
struct
Beamforming
{
Beamforming
(
)
:
enabled
(
false
)
array_geometry
(
)
target_direction
(
SphericalPointf
(
static_cast
<
float
>
(
M_PI
)
/
2
.
f
0
.
f
1
.
f
)
)
{
}
Beamforming
(
bool
enabled
const
std
:
:
vector
<
Point
>
&
array_geometry
)
:
Beamforming
(
enabled
array_geometry
SphericalPointf
(
static_cast
<
float
>
(
M_PI
)
/
2
.
f
0
.
f
1
.
f
)
)
{
}
Beamforming
(
bool
enabled
const
std
:
:
vector
<
Point
>
&
array_geometry
SphericalPointf
target_direction
)
:
enabled
(
enabled
)
array_geometry
(
array_geometry
)
target_direction
(
target_direction
)
{
}
static
const
ConfigOptionID
identifier
=
ConfigOptionID
:
:
kBeamforming
;
const
bool
enabled
;
const
std
:
:
vector
<
Point
>
array_geometry
;
const
SphericalPointf
target_direction
;
}
;
struct
Intelligibility
{
Intelligibility
(
)
:
enabled
(
false
)
{
}
explicit
Intelligibility
(
bool
enabled
)
:
enabled
(
enabled
)
{
}
static
const
ConfigOptionID
identifier
=
ConfigOptionID
:
:
kIntelligibility
;
bool
enabled
;
}
;
class
AudioProcessing
{
public
:
enum
ChannelLayout
{
kMono
kStereo
kMonoAndKeyboard
kStereoAndKeyboard
}
;
static
AudioProcessing
*
Create
(
)
;
static
AudioProcessing
*
Create
(
const
Config
&
config
)
;
static
AudioProcessing
*
Create
(
const
Config
&
config
Beamformer
<
float
>
*
beamformer
)
;
virtual
~
AudioProcessing
(
)
{
}
virtual
int
Initialize
(
)
=
0
;
virtual
int
Initialize
(
const
ProcessingConfig
&
processing_config
)
=
0
;
virtual
int
Initialize
(
int
input_sample_rate_hz
int
output_sample_rate_hz
int
reverse_sample_rate_hz
ChannelLayout
input_layout
ChannelLayout
output_layout
ChannelLayout
reverse_layout
)
=
0
;
virtual
void
SetExtraOptions
(
const
Config
&
config
)
=
0
;
virtual
int
input_sample_rate_hz
(
)
const
=
0
;
virtual
int
proc_sample_rate_hz
(
)
const
=
0
;
virtual
int
proc_split_sample_rate_hz
(
)
const
=
0
;
virtual
size_t
num_input_channels
(
)
const
=
0
;
virtual
size_t
num_proc_channels
(
)
const
=
0
;
virtual
size_t
num_output_channels
(
)
const
=
0
;
virtual
size_t
num_reverse_channels
(
)
const
=
0
;
virtual
void
set_output_will_be_muted
(
bool
muted
)
=
0
;
virtual
int
ProcessStream
(
AudioFrame
*
frame
)
=
0
;
virtual
int
ProcessStream
(
const
float
*
const
*
src
size_t
samples_per_channel
int
input_sample_rate_hz
ChannelLayout
input_layout
int
output_sample_rate_hz
ChannelLayout
output_layout
float
*
const
*
dest
)
=
0
;
virtual
int
ProcessStream
(
const
float
*
const
*
src
const
StreamConfig
&
input_config
const
StreamConfig
&
output_config
float
*
const
*
dest
)
=
0
;
virtual
int
AnalyzeReverseStream
(
AudioFrame
*
frame
)
=
0
;
virtual
int
ProcessReverseStream
(
AudioFrame
*
frame
)
=
0
;
virtual
int
AnalyzeReverseStream
(
const
float
*
const
*
data
size_t
samples_per_channel
int
rev_sample_rate_hz
ChannelLayout
layout
)
=
0
;
virtual
int
ProcessReverseStream
(
const
float
*
const
*
src
const
StreamConfig
&
reverse_input_config
const
StreamConfig
&
reverse_output_config
float
*
const
*
dest
)
=
0
;
virtual
int
set_stream_delay_ms
(
int
delay
)
=
0
;
virtual
int
stream_delay_ms
(
)
const
=
0
;
virtual
bool
was_stream_delay_set
(
)
const
=
0
;
virtual
void
set_stream_key_pressed
(
bool
key_pressed
)
=
0
;
virtual
void
set_delay_offset_ms
(
int
offset
)
=
0
;
virtual
int
delay_offset_ms
(
)
const
=
0
;
static
const
size_t
kMaxFilenameSize
=
1024
;
virtual
int
StartDebugRecording
(
const
char
filename
[
kMaxFilenameSize
]
)
=
0
;
virtual
int
StartDebugRecording
(
FILE
*
handle
)
=
0
;
virtual
int
StartDebugRecordingForPlatformFile
(
rtc
:
:
PlatformFile
handle
)
{
return
-
1
;
}
virtual
int
StopDebugRecording
(
)
=
0
;
virtual
void
UpdateHistogramsOnCallEnd
(
)
=
0
;
virtual
EchoCancellation
*
echo_cancellation
(
)
const
=
0
;
virtual
EchoControlMobile
*
echo_control_mobile
(
)
const
=
0
;
virtual
GainControl
*
gain_control
(
)
const
=
0
;
virtual
HighPassFilter
*
high_pass_filter
(
)
const
=
0
;
virtual
LevelEstimator
*
level_estimator
(
)
const
=
0
;
virtual
NoiseSuppression
*
noise_suppression
(
)
const
=
0
;
virtual
VoiceDetection
*
voice_detection
(
)
const
=
0
;
struct
Statistic
{
int
instant
;
int
average
;
int
maximum
;
int
minimum
;
}
;
enum
Error
{
kNoError
=
0
kUnspecifiedError
=
-
1
kCreationFailedError
=
-
2
kUnsupportedComponentError
=
-
3
kUnsupportedFunctionError
=
-
4
kNullPointerError
=
-
5
kBadParameterError
=
-
6
kBadSampleRateError
=
-
7
kBadDataLengthError
=
-
8
kBadNumberChannelsError
=
-
9
kFileError
=
-
10
kStreamParameterNotSetError
=
-
11
kNotEnabledError
=
-
12
kBadStreamParameterWarning
=
-
13
}
;
enum
NativeRate
{
kSampleRate8kHz
=
8000
kSampleRate16kHz
=
16000
kSampleRate32kHz
=
32000
kSampleRate48kHz
=
48000
}
;
static
const
int
kNativeSampleRatesHz
[
]
;
static
const
size_t
kNumNativeSampleRates
;
static
const
int
kMaxNativeSampleRateHz
;
static
const
int
kMaxAECMSampleRateHz
;
static
const
int
kChunkSizeMs
=
10
;
}
;
class
StreamConfig
{
public
:
StreamConfig
(
int
sample_rate_hz
=
0
size_t
num_channels
=
0
bool
has_keyboard
=
false
)
:
sample_rate_hz_
(
sample_rate_hz
)
num_channels_
(
num_channels
)
has_keyboard_
(
has_keyboard
)
num_frames_
(
calculate_frames
(
sample_rate_hz
)
)
{
}
void
set_sample_rate_hz
(
int
value
)
{
sample_rate_hz_
=
value
;
num_frames_
=
calculate_frames
(
value
)
;
}
void
set_num_channels
(
size_t
value
)
{
num_channels_
=
value
;
}
void
set_has_keyboard
(
bool
value
)
{
has_keyboard_
=
value
;
}
int
sample_rate_hz
(
)
const
{
return
sample_rate_hz_
;
}
size_t
num_channels
(
)
const
{
return
num_channels_
;
}
bool
has_keyboard
(
)
const
{
return
has_keyboard_
;
}
size_t
num_frames
(
)
const
{
return
num_frames_
;
}
size_t
num_samples
(
)
const
{
return
num_channels_
*
num_frames_
;
}
bool
operator
=
=
(
const
StreamConfig
&
other
)
const
{
return
sample_rate_hz_
=
=
other
.
sample_rate_hz_
&
&
num_channels_
=
=
other
.
num_channels_
&
&
has_keyboard_
=
=
other
.
has_keyboard_
;
}
bool
operator
!
=
(
const
StreamConfig
&
other
)
const
{
return
!
(
*
this
=
=
other
)
;
}
private
:
static
size_t
calculate_frames
(
int
sample_rate_hz
)
{
return
static_cast
<
size_t
>
(
AudioProcessing
:
:
kChunkSizeMs
*
sample_rate_hz
/
1000
)
;
}
int
sample_rate_hz_
;
size_t
num_channels_
;
bool
has_keyboard_
;
size_t
num_frames_
;
}
;
class
ProcessingConfig
{
public
:
enum
StreamName
{
kInputStream
kOutputStream
kReverseInputStream
kReverseOutputStream
kNumStreamNames
}
;
const
StreamConfig
&
input_stream
(
)
const
{
return
streams
[
StreamName
:
:
kInputStream
]
;
}
const
StreamConfig
&
output_stream
(
)
const
{
return
streams
[
StreamName
:
:
kOutputStream
]
;
}
const
StreamConfig
&
reverse_input_stream
(
)
const
{
return
streams
[
StreamName
:
:
kReverseInputStream
]
;
}
const
StreamConfig
&
reverse_output_stream
(
)
const
{
return
streams
[
StreamName
:
:
kReverseOutputStream
]
;
}
StreamConfig
&
input_stream
(
)
{
return
streams
[
StreamName
:
:
kInputStream
]
;
}
StreamConfig
&
output_stream
(
)
{
return
streams
[
StreamName
:
:
kOutputStream
]
;
}
StreamConfig
&
reverse_input_stream
(
)
{
return
streams
[
StreamName
:
:
kReverseInputStream
]
;
}
StreamConfig
&
reverse_output_stream
(
)
{
return
streams
[
StreamName
:
:
kReverseOutputStream
]
;
}
bool
operator
=
=
(
const
ProcessingConfig
&
other
)
const
{
for
(
int
i
=
0
;
i
<
StreamName
:
:
kNumStreamNames
;
+
+
i
)
{
if
(
this
-
>
streams
[
i
]
!
=
other
.
streams
[
i
]
)
{
return
false
;
}
}
return
true
;
}
bool
operator
!
=
(
const
ProcessingConfig
&
other
)
const
{
return
!
(
*
this
=
=
other
)
;
}
StreamConfig
streams
[
StreamName
:
:
kNumStreamNames
]
;
}
;
class
EchoCancellation
{
public
:
virtual
int
Enable
(
bool
enable
)
=
0
;
virtual
bool
is_enabled
(
)
const
=
0
;
virtual
int
enable_drift_compensation
(
bool
enable
)
=
0
;
virtual
bool
is_drift_compensation_enabled
(
)
const
=
0
;
virtual
void
set_stream_drift_samples
(
int
drift
)
=
0
;
virtual
int
stream_drift_samples
(
)
const
=
0
;
enum
SuppressionLevel
{
kLowSuppression
kModerateSuppression
kHighSuppression
}
;
virtual
int
set_suppression_level
(
SuppressionLevel
level
)
=
0
;
virtual
SuppressionLevel
suppression_level
(
)
const
=
0
;
virtual
bool
stream_has_echo
(
)
const
=
0
;
virtual
int
enable_metrics
(
bool
enable
)
=
0
;
virtual
bool
are_metrics_enabled
(
)
const
=
0
;
struct
Metrics
{
AudioProcessing
:
:
Statistic
residual_echo_return_loss
;
AudioProcessing
:
:
Statistic
echo_return_loss
;
AudioProcessing
:
:
Statistic
echo_return_loss_enhancement
;
AudioProcessing
:
:
Statistic
a_nlp
;
}
;
virtual
int
GetMetrics
(
Metrics
*
metrics
)
=
0
;
virtual
int
enable_delay_logging
(
bool
enable
)
=
0
;
virtual
bool
is_delay_logging_enabled
(
)
const
=
0
;
virtual
int
GetDelayMetrics
(
int
*
median
int
*
std
)
=
0
;
virtual
int
GetDelayMetrics
(
int
*
median
int
*
std
float
*
fraction_poor_delays
)
=
0
;
virtual
struct
AecCore
*
aec_core
(
)
const
=
0
;
protected
:
virtual
~
EchoCancellation
(
)
{
}
}
;
class
EchoControlMobile
{
public
:
virtual
int
Enable
(
bool
enable
)
=
0
;
virtual
bool
is_enabled
(
)
const
=
0
;
enum
RoutingMode
{
kQuietEarpieceOrHeadset
kEarpiece
kLoudEarpiece
kSpeakerphone
kLoudSpeakerphone
}
;
virtual
int
set_routing_mode
(
RoutingMode
mode
)
=
0
;
virtual
RoutingMode
routing_mode
(
)
const
=
0
;
virtual
int
enable_comfort_noise
(
bool
enable
)
=
0
;
virtual
bool
is_comfort_noise_enabled
(
)
const
=
0
;
virtual
int
SetEchoPath
(
const
void
*
echo_path
size_t
size_bytes
)
=
0
;
virtual
int
GetEchoPath
(
void
*
echo_path
size_t
size_bytes
)
const
=
0
;
static
size_t
echo_path_size_bytes
(
)
;
protected
:
virtual
~
EchoControlMobile
(
)
{
}
}
;
class
GainControl
{
public
:
virtual
int
Enable
(
bool
enable
)
=
0
;
virtual
bool
is_enabled
(
)
const
=
0
;
virtual
int
set_stream_analog_level
(
int
level
)
=
0
;
virtual
int
stream_analog_level
(
)
=
0
;
enum
Mode
{
kAdaptiveAnalog
kAdaptiveDigital
kFixedDigital
}
;
virtual
int
set_mode
(
Mode
mode
)
=
0
;
virtual
Mode
mode
(
)
const
=
0
;
virtual
int
set_target_level_dbfs
(
int
level
)
=
0
;
virtual
int
target_level_dbfs
(
)
const
=
0
;
virtual
int
set_compression_gain_db
(
int
gain
)
=
0
;
virtual
int
compression_gain_db
(
)
const
=
0
;
virtual
int
enable_limiter
(
bool
enable
)
=
0
;
virtual
bool
is_limiter_enabled
(
)
const
=
0
;
virtual
int
set_analog_level_limits
(
int
minimum
int
maximum
)
=
0
;
virtual
int
analog_level_minimum
(
)
const
=
0
;
virtual
int
analog_level_maximum
(
)
const
=
0
;
virtual
bool
stream_is_saturated
(
)
const
=
0
;
protected
:
virtual
~
GainControl
(
)
{
}
}
;
class
HighPassFilter
{
public
:
virtual
int
Enable
(
bool
enable
)
=
0
;
virtual
bool
is_enabled
(
)
const
=
0
;
protected
:
virtual
~
HighPassFilter
(
)
{
}
}
;
class
LevelEstimator
{
public
:
virtual
int
Enable
(
bool
enable
)
=
0
;
virtual
bool
is_enabled
(
)
const
=
0
;
virtual
int
RMS
(
)
=
0
;
protected
:
virtual
~
LevelEstimator
(
)
{
}
}
;
class
NoiseSuppression
{
public
:
virtual
int
Enable
(
bool
enable
)
=
0
;
virtual
bool
is_enabled
(
)
const
=
0
;
enum
Level
{
kLow
kModerate
kHigh
kVeryHigh
}
;
virtual
int
set_level
(
Level
level
)
=
0
;
virtual
Level
level
(
)
const
=
0
;
virtual
float
speech_probability
(
)
const
=
0
;
protected
:
virtual
~
NoiseSuppression
(
)
{
}
}
;
class
VoiceDetection
{
public
:
virtual
int
Enable
(
bool
enable
)
=
0
;
virtual
bool
is_enabled
(
)
const
=
0
;
virtual
bool
stream_has_voice
(
)
const
=
0
;
virtual
int
set_stream_has_voice
(
bool
has_voice
)
=
0
;
enum
Likelihood
{
kVeryLowLikelihood
kLowLikelihood
kModerateLikelihood
kHighLikelihood
}
;
virtual
int
set_likelihood
(
Likelihood
likelihood
)
=
0
;
virtual
Likelihood
likelihood
(
)
const
=
0
;
virtual
int
set_frame_size_ms
(
int
size
)
=
0
;
virtual
int
frame_size_ms
(
)
const
=
0
;
protected
:
virtual
~
VoiceDetection
(
)
{
}
}
;
}
#
endif
