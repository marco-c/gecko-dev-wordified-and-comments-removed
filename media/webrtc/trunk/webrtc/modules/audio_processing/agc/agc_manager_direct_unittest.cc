#
include
"
modules
/
audio_processing
/
agc
/
agc_manager_direct
.
h
"
#
include
"
common_types
.
h
"
#
include
"
modules
/
audio_processing
/
agc
/
mock_agc
.
h
"
#
include
"
modules
/
audio_processing
/
include
/
mock_audio_processing
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
using
:
:
testing
:
:
_
;
using
:
:
testing
:
:
DoAll
;
using
:
:
testing
:
:
Return
;
using
:
:
testing
:
:
SetArgPointee
;
namespace
webrtc
{
namespace
{
const
int
kSampleRateHz
=
32000
;
const
int
kNumChannels
=
1
;
const
int
kSamplesPerChannel
=
kSampleRateHz
/
100
;
const
int
kInitialVolume
=
128
;
constexpr
int
kClippedMin
=
165
;
const
float
kAboveClippedThreshold
=
0
.
2f
;
class
TestVolumeCallbacks
:
public
VolumeCallbacks
{
public
:
TestVolumeCallbacks
(
)
:
volume_
(
0
)
{
}
void
SetMicVolume
(
int
volume
)
override
{
volume_
=
volume
;
}
int
GetMicVolume
(
)
override
{
return
volume_
;
}
private
:
int
volume_
;
}
;
}
class
AgcManagerDirectTest
:
public
:
:
testing
:
:
Test
{
protected
:
AgcManagerDirectTest
(
)
:
agc_
(
new
MockAgc
)
manager_
(
agc_
&
gctrl_
&
volume_
kInitialVolume
kClippedMin
)
{
ExpectInitialize
(
)
;
manager_
.
Initialize
(
)
;
}
void
FirstProcess
(
)
{
EXPECT_CALL
(
*
agc_
Reset
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
Return
(
false
)
)
;
CallProcess
(
1
)
;
}
void
SetVolumeAndProcess
(
int
volume
)
{
volume_
.
SetMicVolume
(
volume
)
;
FirstProcess
(
)
;
}
void
ExpectCheckVolumeAndReset
(
int
volume
)
{
volume_
.
SetMicVolume
(
volume
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
;
}
void
ExpectInitialize
(
)
{
EXPECT_CALL
(
gctrl_
set_mode
(
GainControl
:
:
kFixedDigital
)
)
;
EXPECT_CALL
(
gctrl_
set_target_level_dbfs
(
2
)
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
7
)
)
;
EXPECT_CALL
(
gctrl_
enable_limiter
(
true
)
)
;
}
void
CallProcess
(
int
num_calls
)
{
for
(
int
i
=
0
;
i
<
num_calls
;
+
+
i
)
{
EXPECT_CALL
(
*
agc_
Process
(
_
_
_
)
)
.
WillOnce
(
Return
(
0
)
)
;
manager_
.
Process
(
nullptr
kSamplesPerChannel
kSampleRateHz
)
;
}
}
void
CallPreProc
(
int
num_calls
)
{
for
(
int
i
=
0
;
i
<
num_calls
;
+
+
i
)
{
manager_
.
AnalyzePreProcess
(
nullptr
kNumChannels
kSamplesPerChannel
)
;
}
}
MockAgc
*
agc_
;
test
:
:
MockGainControl
gctrl_
;
TestVolumeCallbacks
volume_
;
AgcManagerDirect
manager_
;
}
;
TEST_F
(
AgcManagerDirectTest
StartupMinVolumeConfigurationIsRespected
)
{
FirstProcess
(
)
;
EXPECT_EQ
(
kInitialVolume
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
MicVolumeResponseToRmsError
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
130
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
20
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
168
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
167
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
163
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
9
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
129
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
MicVolumeIsLimited
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
183
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
243
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
255
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
254
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
194
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
137
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
88
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
54
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
33
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
18
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
12
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
CompressorStepsTowardsTarget
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
9
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
9
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
20
)
;
}
TEST_F
(
AgcManagerDirectTest
CompressorErrorIsDeemphasized
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
7
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
6
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
CallProcess
(
20
)
;
}
TEST_F
(
AgcManagerDirectTest
CompressorReachesMaximum
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
10
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
11
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
12
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
}
TEST_F
(
AgcManagerDirectTest
CompressorReachesMinimum
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
6
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
5
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
4
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
3
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
2
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
}
TEST_F
(
AgcManagerDirectTest
NoActionWhileMuted
)
{
manager_
.
SetCaptureMuted
(
true
)
;
manager_
.
Process
(
nullptr
kSamplesPerChannel
kSampleRateHz
)
;
}
TEST_F
(
AgcManagerDirectTest
UnmutingChecksVolumeWithoutRaising
)
{
FirstProcess
(
)
;
manager_
.
SetCaptureMuted
(
true
)
;
manager_
.
SetCaptureMuted
(
false
)
;
ExpectCheckVolumeAndReset
(
127
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
Return
(
false
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
127
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
UnmutingRaisesTooLowVolume
)
{
FirstProcess
(
)
;
manager_
.
SetCaptureMuted
(
true
)
;
manager_
.
SetCaptureMuted
(
false
)
;
ExpectCheckVolumeAndReset
(
11
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
Return
(
false
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
12
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
ManualLevelChangeResultsInNoSetMicCall
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
;
volume_
.
SetMicVolume
(
154
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
154
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
volume_
.
SetMicVolume
(
100
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
100
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
99
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
RecoveryAfterManualLevelChangeFromMax
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
183
volume_
.
GetMicVolume
(
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
243
volume_
.
GetMicVolume
(
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
255
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
volume_
.
SetMicVolume
(
50
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
50
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
20
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
69
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
RecoveryAfterManualLevelChangeBelowMin
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
volume_
.
SetMicVolume
(
1
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
1
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
2
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
11
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
20
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
18
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
NoClippingHasNoImpact
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillRepeatedly
(
Return
(
0
)
)
;
CallPreProc
(
100
)
;
EXPECT_EQ
(
128
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
ClippingUnderThresholdHasNoImpact
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
0
.
099
)
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
128
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
ClippingLowersVolume
)
{
SetVolumeAndProcess
(
255
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
0
.
101
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
240
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
WaitingPeriodBetweenClippingChecks
)
{
SetVolumeAndProcess
(
255
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
240
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillRepeatedly
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
0
)
;
CallPreProc
(
300
)
;
EXPECT_EQ
(
240
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
225
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
ClippingLoweringIsLimited
)
{
SetVolumeAndProcess
(
180
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
kClippedMin
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillRepeatedly
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
0
)
;
CallPreProc
(
1000
)
;
EXPECT_EQ
(
kClippedMin
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
ClippingMaxIsRespectedWhenEqualToLevel
)
{
SetVolumeAndProcess
(
255
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
240
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
CallProcess
(
10
)
;
EXPECT_EQ
(
240
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
ClippingMaxIsRespectedWhenHigherThanLevel
)
{
SetVolumeAndProcess
(
200
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
185
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
240
volume_
.
GetMicVolume
(
)
)
;
CallProcess
(
10
)
;
EXPECT_EQ
(
240
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
MaxCompressionIsIncreasedAfterClipping
)
{
SetVolumeAndProcess
(
210
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
195
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
10
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
11
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
12
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
13
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
CallPreProc
(
300
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
180
volume_
.
GetMicVolume
(
)
)
;
CallPreProc
(
300
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
kClippedMin
volume_
.
GetMicVolume
(
)
)
;
CallPreProc
(
300
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
CallPreProc
(
1
)
;
CallPreProc
(
300
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
CallPreProc
(
1
)
;
CallPreProc
(
300
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
CallPreProc
(
1
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
CallProcess
(
19
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
14
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
15
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
16
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
17
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
20
)
;
EXPECT_CALL
(
gctrl_
set_compression_gain_db
(
18
)
)
.
WillOnce
(
Return
(
0
)
)
;
CallProcess
(
1
)
;
}
TEST_F
(
AgcManagerDirectTest
UserCanRaiseVolumeAfterClipping
)
{
SetVolumeAndProcess
(
225
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
210
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
14
)
Return
(
true
)
)
)
;
volume_
.
SetMicVolume
(
250
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
1
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
250
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
10
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
210
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
40
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
250
volume_
.
GetMicVolume
(
)
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
CallProcess
(
1
)
;
EXPECT_EQ
(
250
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
ClippingDoesNotPullLowVolumeBackUp
)
{
SetVolumeAndProcess
(
80
)
;
EXPECT_CALL
(
*
agc_
AnalyzePreproc
(
_
_
)
)
.
WillOnce
(
Return
(
kAboveClippedThreshold
)
)
;
EXPECT_CALL
(
*
agc_
Reset
(
)
)
.
Times
(
0
)
;
int
initial_volume
=
volume_
.
GetMicVolume
(
)
;
CallPreProc
(
1
)
;
EXPECT_EQ
(
initial_volume
volume_
.
GetMicVolume
(
)
)
;
}
TEST_F
(
AgcManagerDirectTest
TakesNoActionOnZeroMicVolume
)
{
FirstProcess
(
)
;
EXPECT_CALL
(
*
agc_
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
volume_
.
SetMicVolume
(
0
)
;
CallProcess
(
10
)
;
EXPECT_EQ
(
0
volume_
.
GetMicVolume
(
)
)
;
}
}
