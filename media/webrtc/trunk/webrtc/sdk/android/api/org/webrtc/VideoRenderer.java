package
org
.
webrtc
;
import
java
.
nio
.
ByteBuffer
;
public
class
VideoRenderer
{
public
static
class
I420Frame
{
public
final
int
width
;
public
final
int
height
;
public
final
int
[
]
yuvStrides
;
public
ByteBuffer
[
]
yuvPlanes
;
public
final
boolean
yuvFrame
;
public
final
float
[
]
samplingMatrix
;
public
int
textureId
;
private
long
nativeFramePointer
;
public
int
rotationDegree
;
private
final
VideoFrame
.
Buffer
backingBuffer
;
public
I420Frame
(
int
width
int
height
int
rotationDegree
int
[
]
yuvStrides
ByteBuffer
[
]
yuvPlanes
long
nativeFramePointer
)
{
this
.
width
=
width
;
this
.
height
=
height
;
this
.
yuvStrides
=
yuvStrides
;
this
.
yuvPlanes
=
yuvPlanes
;
this
.
yuvFrame
=
true
;
this
.
rotationDegree
=
rotationDegree
;
this
.
nativeFramePointer
=
nativeFramePointer
;
backingBuffer
=
null
;
if
(
rotationDegree
%
90
!
=
0
)
{
throw
new
IllegalArgumentException
(
"
Rotation
degree
not
multiple
of
90
:
"
+
rotationDegree
)
;
}
samplingMatrix
=
RendererCommon
.
verticalFlipMatrix
(
)
;
}
public
I420Frame
(
int
width
int
height
int
rotationDegree
int
textureId
float
[
]
samplingMatrix
long
nativeFramePointer
)
{
this
.
width
=
width
;
this
.
height
=
height
;
this
.
yuvStrides
=
null
;
this
.
yuvPlanes
=
null
;
this
.
samplingMatrix
=
samplingMatrix
;
this
.
textureId
=
textureId
;
this
.
yuvFrame
=
false
;
this
.
rotationDegree
=
rotationDegree
;
this
.
nativeFramePointer
=
nativeFramePointer
;
backingBuffer
=
null
;
if
(
rotationDegree
%
90
!
=
0
)
{
throw
new
IllegalArgumentException
(
"
Rotation
degree
not
multiple
of
90
:
"
+
rotationDegree
)
;
}
}
public
I420Frame
(
int
rotationDegree
VideoFrame
.
Buffer
buffer
long
nativeFramePointer
)
{
this
.
width
=
buffer
.
getWidth
(
)
;
this
.
height
=
buffer
.
getHeight
(
)
;
this
.
rotationDegree
=
rotationDegree
;
if
(
rotationDegree
%
90
!
=
0
)
{
throw
new
IllegalArgumentException
(
"
Rotation
degree
not
multiple
of
90
:
"
+
rotationDegree
)
;
}
if
(
buffer
instanceof
VideoFrame
.
TextureBuffer
&
&
(
(
VideoFrame
.
TextureBuffer
)
buffer
)
.
getType
(
)
=
=
VideoFrame
.
TextureBuffer
.
Type
.
OES
)
{
VideoFrame
.
TextureBuffer
textureBuffer
=
(
VideoFrame
.
TextureBuffer
)
buffer
;
this
.
yuvFrame
=
false
;
this
.
textureId
=
textureBuffer
.
getTextureId
(
)
;
this
.
samplingMatrix
=
RendererCommon
.
convertMatrixFromAndroidGraphicsMatrix
(
textureBuffer
.
getTransformMatrix
(
)
)
;
this
.
yuvStrides
=
null
;
this
.
yuvPlanes
=
null
;
}
else
if
(
buffer
instanceof
VideoFrame
.
I420Buffer
)
{
VideoFrame
.
I420Buffer
i420Buffer
=
(
VideoFrame
.
I420Buffer
)
buffer
;
this
.
yuvFrame
=
true
;
this
.
yuvStrides
=
new
int
[
]
{
i420Buffer
.
getStrideY
(
)
i420Buffer
.
getStrideU
(
)
i420Buffer
.
getStrideV
(
)
}
;
this
.
yuvPlanes
=
new
ByteBuffer
[
]
{
i420Buffer
.
getDataY
(
)
i420Buffer
.
getDataU
(
)
i420Buffer
.
getDataV
(
)
}
;
this
.
samplingMatrix
=
RendererCommon
.
verticalFlipMatrix
(
)
;
this
.
textureId
=
0
;
}
else
{
this
.
yuvFrame
=
false
;
this
.
textureId
=
0
;
this
.
samplingMatrix
=
null
;
this
.
yuvStrides
=
null
;
this
.
yuvPlanes
=
null
;
}
this
.
nativeFramePointer
=
nativeFramePointer
;
backingBuffer
=
buffer
;
}
public
int
rotatedWidth
(
)
{
return
(
rotationDegree
%
180
=
=
0
)
?
width
:
height
;
}
public
int
rotatedHeight
(
)
{
return
(
rotationDegree
%
180
=
=
0
)
?
height
:
width
;
}
Override
public
String
toString
(
)
{
final
String
type
=
yuvFrame
?
"
Y
:
"
+
yuvStrides
[
0
]
+
"
U
:
"
+
yuvStrides
[
1
]
+
"
V
:
"
+
yuvStrides
[
2
]
:
"
Texture
:
"
+
textureId
;
return
width
+
"
x
"
+
height
+
"
"
+
type
;
}
VideoFrame
toVideoFrame
(
)
{
final
VideoFrame
.
Buffer
buffer
;
if
(
backingBuffer
!
=
null
)
{
backingBuffer
.
retain
(
)
;
VideoRenderer
.
renderFrameDone
(
this
)
;
buffer
=
backingBuffer
;
}
else
if
(
yuvFrame
)
{
buffer
=
JavaI420Buffer
.
wrap
(
width
height
yuvPlanes
[
0
]
yuvStrides
[
0
]
yuvPlanes
[
1
]
yuvStrides
[
1
]
yuvPlanes
[
2
]
yuvStrides
[
2
]
(
)
-
>
{
VideoRenderer
.
renderFrameDone
(
this
)
;
}
)
;
}
else
{
buffer
=
new
TextureBufferImpl
(
width
height
VideoFrame
.
TextureBuffer
.
Type
.
OES
textureId
RendererCommon
.
convertMatrixToAndroidGraphicsMatrix
(
samplingMatrix
)
null
(
)
-
>
{
VideoRenderer
.
renderFrameDone
(
this
)
;
}
)
;
}
return
new
VideoFrame
(
buffer
rotationDegree
0
)
;
}
}
public
static
native
void
nativeCopyPlane
(
ByteBuffer
src
int
width
int
height
int
srcStride
ByteBuffer
dst
int
dstStride
)
;
public
static
interface
Callbacks
{
public
void
renderFrame
(
I420Frame
frame
)
;
}
public
static
void
renderFrameDone
(
I420Frame
frame
)
{
frame
.
yuvPlanes
=
null
;
frame
.
textureId
=
0
;
if
(
frame
.
nativeFramePointer
!
=
0
)
{
releaseNativeFrame
(
frame
.
nativeFramePointer
)
;
frame
.
nativeFramePointer
=
0
;
}
}
long
nativeVideoRenderer
;
public
VideoRenderer
(
Callbacks
callbacks
)
{
nativeVideoRenderer
=
nativeWrapVideoRenderer
(
callbacks
)
;
}
public
void
dispose
(
)
{
if
(
nativeVideoRenderer
=
=
0
)
{
return
;
}
freeWrappedVideoRenderer
(
nativeVideoRenderer
)
;
nativeVideoRenderer
=
0
;
}
private
static
native
long
nativeWrapVideoRenderer
(
Callbacks
callbacks
)
;
private
static
native
void
freeWrappedVideoRenderer
(
long
nativeVideoRenderer
)
;
private
static
native
void
releaseNativeFrame
(
long
nativeFramePointer
)
;
}
