package
org
.
webrtc
;
import
java
.
util
.
Collections
;
import
java
.
util
.
LinkedList
;
import
java
.
util
.
List
;
public
class
PeerConnection
{
static
{
System
.
loadLibrary
(
"
jingle_peerconnection_so
"
)
;
}
public
enum
IceGatheringState
{
NEW
GATHERING
COMPLETE
}
public
enum
IceConnectionState
{
NEW
CHECKING
CONNECTED
COMPLETED
FAILED
DISCONNECTED
CLOSED
}
public
enum
TlsCertPolicy
{
TLS_CERT_POLICY_SECURE
TLS_CERT_POLICY_INSECURE_NO_CHECK
}
public
enum
SignalingState
{
STABLE
HAVE_LOCAL_OFFER
HAVE_LOCAL_PRANSWER
HAVE_REMOTE_OFFER
HAVE_REMOTE_PRANSWER
CLOSED
}
public
static
interface
Observer
{
public
void
onSignalingChange
(
SignalingState
newState
)
;
public
void
onIceConnectionChange
(
IceConnectionState
newState
)
;
public
void
onIceConnectionReceivingChange
(
boolean
receiving
)
;
public
void
onIceGatheringChange
(
IceGatheringState
newState
)
;
public
void
onIceCandidate
(
IceCandidate
candidate
)
;
public
void
onIceCandidatesRemoved
(
IceCandidate
[
]
candidates
)
;
public
void
onAddStream
(
MediaStream
stream
)
;
public
void
onRemoveStream
(
MediaStream
stream
)
;
public
void
onDataChannel
(
DataChannel
dataChannel
)
;
public
void
onRenegotiationNeeded
(
)
;
public
void
onAddTrack
(
RtpReceiver
receiver
MediaStream
[
]
mediaStreams
)
;
}
public
static
class
IceServer
{
public
final
String
uri
;
public
final
String
username
;
public
final
String
password
;
public
final
TlsCertPolicy
tlsCertPolicy
;
public
IceServer
(
String
uri
)
{
this
(
uri
"
"
"
"
)
;
}
public
IceServer
(
String
uri
String
username
String
password
)
{
this
(
uri
username
password
TlsCertPolicy
.
TLS_CERT_POLICY_SECURE
)
;
}
public
IceServer
(
String
uri
String
username
String
password
TlsCertPolicy
tlsCertPolicy
)
{
this
.
uri
=
uri
;
this
.
username
=
username
;
this
.
password
=
password
;
this
.
tlsCertPolicy
=
tlsCertPolicy
;
}
public
String
toString
(
)
{
return
uri
+
"
[
"
+
username
+
"
:
"
+
password
+
"
]
[
"
+
tlsCertPolicy
+
"
]
"
;
}
}
public
enum
IceTransportsType
{
NONE
RELAY
NOHOST
ALL
}
public
enum
BundlePolicy
{
BALANCED
MAXBUNDLE
MAXCOMPAT
}
public
enum
RtcpMuxPolicy
{
NEGOTIATE
REQUIRE
}
public
enum
TcpCandidatePolicy
{
ENABLED
DISABLED
}
public
enum
CandidateNetworkPolicy
{
ALL
LOW_COST
}
public
enum
KeyType
{
RSA
ECDSA
}
public
enum
ContinualGatheringPolicy
{
GATHER_ONCE
GATHER_CONTINUALLY
}
public
static
class
RTCConfiguration
{
public
IceTransportsType
iceTransportsType
;
public
List
<
IceServer
>
iceServers
;
public
BundlePolicy
bundlePolicy
;
public
RtcpMuxPolicy
rtcpMuxPolicy
;
public
TcpCandidatePolicy
tcpCandidatePolicy
;
public
CandidateNetworkPolicy
candidateNetworkPolicy
;
public
int
audioJitterBufferMaxPackets
;
public
boolean
audioJitterBufferFastAccelerate
;
public
int
iceConnectionReceivingTimeout
;
public
int
iceBackupCandidatePairPingInterval
;
public
KeyType
keyType
;
public
ContinualGatheringPolicy
continualGatheringPolicy
;
public
int
iceCandidatePoolSize
;
public
boolean
pruneTurnPorts
;
public
boolean
presumeWritableWhenFullyRelayed
;
public
RTCConfiguration
(
List
<
IceServer
>
iceServers
)
{
iceTransportsType
=
IceTransportsType
.
ALL
;
bundlePolicy
=
BundlePolicy
.
BALANCED
;
rtcpMuxPolicy
=
RtcpMuxPolicy
.
REQUIRE
;
tcpCandidatePolicy
=
TcpCandidatePolicy
.
ENABLED
;
candidateNetworkPolicy
=
candidateNetworkPolicy
.
ALL
;
this
.
iceServers
=
iceServers
;
audioJitterBufferMaxPackets
=
50
;
audioJitterBufferFastAccelerate
=
false
;
iceConnectionReceivingTimeout
=
-
1
;
iceBackupCandidatePairPingInterval
=
-
1
;
keyType
=
KeyType
.
ECDSA
;
continualGatheringPolicy
=
ContinualGatheringPolicy
.
GATHER_ONCE
;
iceCandidatePoolSize
=
0
;
pruneTurnPorts
=
false
;
presumeWritableWhenFullyRelayed
=
false
;
}
}
;
private
final
List
<
MediaStream
>
localStreams
;
private
final
long
nativePeerConnection
;
private
final
long
nativeObserver
;
private
List
<
RtpSender
>
senders
;
private
List
<
RtpReceiver
>
receivers
;
PeerConnection
(
long
nativePeerConnection
long
nativeObserver
)
{
this
.
nativePeerConnection
=
nativePeerConnection
;
this
.
nativeObserver
=
nativeObserver
;
localStreams
=
new
LinkedList
<
MediaStream
>
(
)
;
senders
=
new
LinkedList
<
RtpSender
>
(
)
;
receivers
=
new
LinkedList
<
RtpReceiver
>
(
)
;
}
public
native
SessionDescription
getLocalDescription
(
)
;
public
native
SessionDescription
getRemoteDescription
(
)
;
public
native
DataChannel
createDataChannel
(
String
label
DataChannel
.
Init
init
)
;
public
native
void
createOffer
(
SdpObserver
observer
MediaConstraints
constraints
)
;
public
native
void
createAnswer
(
SdpObserver
observer
MediaConstraints
constraints
)
;
public
native
void
setLocalDescription
(
SdpObserver
observer
SessionDescription
sdp
)
;
public
native
void
setRemoteDescription
(
SdpObserver
observer
SessionDescription
sdp
)
;
public
boolean
setConfiguration
(
RTCConfiguration
config
)
{
return
nativeSetConfiguration
(
config
nativeObserver
)
;
}
public
boolean
addIceCandidate
(
IceCandidate
candidate
)
{
return
nativeAddIceCandidate
(
candidate
.
sdpMid
candidate
.
sdpMLineIndex
candidate
.
sdp
)
;
}
public
boolean
removeIceCandidates
(
final
IceCandidate
[
]
candidates
)
{
return
nativeRemoveIceCandidates
(
candidates
)
;
}
public
boolean
addStream
(
MediaStream
stream
)
{
boolean
ret
=
nativeAddLocalStream
(
stream
.
nativeStream
)
;
if
(
!
ret
)
{
return
false
;
}
localStreams
.
add
(
stream
)
;
return
true
;
}
public
void
removeStream
(
MediaStream
stream
)
{
nativeRemoveLocalStream
(
stream
.
nativeStream
)
;
localStreams
.
remove
(
stream
)
;
}
public
RtpSender
createSender
(
String
kind
String
stream_id
)
{
RtpSender
new_sender
=
nativeCreateSender
(
kind
stream_id
)
;
if
(
new_sender
!
=
null
)
{
senders
.
add
(
new_sender
)
;
}
return
new_sender
;
}
public
List
<
RtpSender
>
getSenders
(
)
{
for
(
RtpSender
sender
:
senders
)
{
sender
.
dispose
(
)
;
}
senders
=
nativeGetSenders
(
)
;
return
Collections
.
unmodifiableList
(
senders
)
;
}
public
List
<
RtpReceiver
>
getReceivers
(
)
{
for
(
RtpReceiver
receiver
:
receivers
)
{
receiver
.
dispose
(
)
;
}
receivers
=
nativeGetReceivers
(
)
;
return
Collections
.
unmodifiableList
(
receivers
)
;
}
public
boolean
getStats
(
StatsObserver
observer
MediaStreamTrack
track
)
{
return
nativeGetStats
(
observer
(
track
=
=
null
)
?
0
:
track
.
nativeTrack
)
;
}
public
boolean
startRtcEventLog
(
int
file_descriptor
int
max_size_bytes
)
{
return
nativeStartRtcEventLog
(
file_descriptor
max_size_bytes
)
;
}
public
void
stopRtcEventLog
(
)
{
nativeStopRtcEventLog
(
)
;
}
public
native
SignalingState
signalingState
(
)
;
public
native
IceConnectionState
iceConnectionState
(
)
;
public
native
IceGatheringState
iceGatheringState
(
)
;
public
native
void
close
(
)
;
public
void
dispose
(
)
{
close
(
)
;
for
(
MediaStream
stream
:
localStreams
)
{
nativeRemoveLocalStream
(
stream
.
nativeStream
)
;
stream
.
dispose
(
)
;
}
localStreams
.
clear
(
)
;
for
(
RtpSender
sender
:
senders
)
{
sender
.
dispose
(
)
;
}
senders
.
clear
(
)
;
for
(
RtpReceiver
receiver
:
receivers
)
{
receiver
.
dispose
(
)
;
}
receivers
.
clear
(
)
;
freePeerConnection
(
nativePeerConnection
)
;
freeObserver
(
nativeObserver
)
;
}
private
static
native
void
freePeerConnection
(
long
nativePeerConnection
)
;
private
static
native
void
freeObserver
(
long
nativeObserver
)
;
public
native
boolean
nativeSetConfiguration
(
RTCConfiguration
config
long
nativeObserver
)
;
private
native
boolean
nativeAddIceCandidate
(
String
sdpMid
int
sdpMLineIndex
String
iceCandidateSdp
)
;
private
native
boolean
nativeRemoveIceCandidates
(
final
IceCandidate
[
]
candidates
)
;
private
native
boolean
nativeAddLocalStream
(
long
nativeStream
)
;
private
native
void
nativeRemoveLocalStream
(
long
nativeStream
)
;
private
native
boolean
nativeGetStats
(
StatsObserver
observer
long
nativeTrack
)
;
private
native
RtpSender
nativeCreateSender
(
String
kind
String
stream_id
)
;
private
native
List
<
RtpSender
>
nativeGetSenders
(
)
;
private
native
List
<
RtpReceiver
>
nativeGetReceivers
(
)
;
private
native
boolean
nativeStartRtcEventLog
(
int
file_descriptor
int
max_size_bytes
)
;
private
native
void
nativeStopRtcEventLog
(
)
;
}
