#
include
"
webrtc
/
sdk
/
android
/
src
/
jni
/
androidvideotracksource
.
h
"
#
include
"
webrtc
/
sdk
/
android
/
src
/
jni
/
classreferenceholder
.
h
"
#
include
"
webrtc
/
api
/
videosourceproxy
.
h
"
#
define
JOW_OBSERVER_METHOD
(
rettype
name
)
\
JOW
(
rettype
VideoCapturer_00024AndroidVideoTrackSourceObserver_
#
#
name
)
namespace
webrtc_jni
{
static
webrtc
:
:
AndroidVideoTrackSource
*
AndroidVideoTrackSourceFromJavaProxy
(
jlong
j_proxy
)
{
auto
proxy_source
=
reinterpret_cast
<
webrtc
:
:
VideoTrackSourceProxy
*
>
(
j_proxy
)
;
return
reinterpret_cast
<
webrtc
:
:
AndroidVideoTrackSource
*
>
(
proxy_source
-
>
internal
(
)
)
;
}
JOW_OBSERVER_METHOD
(
void
nativeOnByteBufferFrameCaptured
)
(
JNIEnv
*
jni
jclass
jlong
j_source
jbyteArray
j_frame
jint
length
jint
width
jint
height
jint
rotation
jlong
timestamp
)
{
webrtc
:
:
AndroidVideoTrackSource
*
source
=
AndroidVideoTrackSourceFromJavaProxy
(
j_source
)
;
jbyte
*
bytes
=
jni
-
>
GetByteArrayElements
(
j_frame
nullptr
)
;
source
-
>
OnByteBufferFrameCaptured
(
bytes
length
width
height
rotation
timestamp
)
;
jni
-
>
ReleaseByteArrayElements
(
j_frame
bytes
JNI_ABORT
)
;
}
JOW_OBSERVER_METHOD
(
void
nativeOnTextureFrameCaptured
)
(
JNIEnv
*
jni
jclass
jlong
j_source
jint
j_width
jint
j_height
jint
j_oes_texture_id
jfloatArray
j_transform_matrix
jint
j_rotation
jlong
j_timestamp
)
{
webrtc
:
:
AndroidVideoTrackSource
*
source
=
AndroidVideoTrackSourceFromJavaProxy
(
j_source
)
;
source
-
>
OnTextureFrameCaptured
(
j_width
j_height
j_rotation
j_timestamp
NativeHandleImpl
(
jni
j_oes_texture_id
j_transform_matrix
)
)
;
}
JOW_OBSERVER_METHOD
(
void
nativeCapturerStarted
)
(
JNIEnv
*
jni
jclass
jlong
j_source
jboolean
j_success
)
{
LOG
(
LS_INFO
)
<
<
"
AndroidVideoTrackSourceObserve_nativeCapturerStarted
"
;
webrtc
:
:
AndroidVideoTrackSource
*
source
=
AndroidVideoTrackSourceFromJavaProxy
(
j_source
)
;
source
-
>
SetState
(
j_success
?
webrtc
:
:
AndroidVideoTrackSource
:
:
SourceState
:
:
kLive
:
webrtc
:
:
AndroidVideoTrackSource
:
:
SourceState
:
:
kEnded
)
;
}
JOW_OBSERVER_METHOD
(
void
nativeCapturerStopped
)
(
JNIEnv
*
jni
jclass
jlong
j_source
)
{
LOG
(
LS_INFO
)
<
<
"
AndroidVideoTrackSourceObserve_nativeCapturerStopped
"
;
webrtc
:
:
AndroidVideoTrackSource
*
source
=
AndroidVideoTrackSourceFromJavaProxy
(
j_source
)
;
source
-
>
SetState
(
webrtc
:
:
AndroidVideoTrackSource
:
:
SourceState
:
:
kEnded
)
;
}
JOW
(
void
VideoSource_nativeAdaptOutputFormat
)
(
JNIEnv
*
jni
jclass
jlong
j_source
jint
j_width
jint
j_height
jint
j_fps
)
{
LOG
(
LS_INFO
)
<
<
"
VideoSource_nativeAdaptOutputFormat
"
;
webrtc
:
:
AndroidVideoTrackSource
*
source
=
AndroidVideoTrackSourceFromJavaProxy
(
j_source
)
;
source
-
>
OnOutputFormatRequest
(
j_width
j_height
j_fps
)
;
}
}
