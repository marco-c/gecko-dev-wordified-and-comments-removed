#
ifndef
WEBRTC_VIDEO_OVERUSE_FRAME_DETECTOR_H_
#
define
WEBRTC_VIDEO_OVERUSE_FRAME_DETECTOR_H_
#
include
<
list
>
#
include
<
memory
>
#
include
"
webrtc
/
base
/
constructormagic
.
h
"
#
include
"
webrtc
/
base
/
numerics
/
exp_filter
.
h
"
#
include
"
webrtc
/
base
/
optional
.
h
"
#
include
"
webrtc
/
base
/
sequenced_task_checker
.
h
"
#
include
"
webrtc
/
base
/
task_queue
.
h
"
#
include
"
webrtc
/
base
/
thread_annotations
.
h
"
#
include
"
webrtc
/
modules
/
video_coding
/
utility
/
quality_scaler
.
h
"
namespace
webrtc
{
class
Clock
;
class
EncodedFrameObserver
;
class
VideoFrame
;
struct
CpuOveruseOptions
{
CpuOveruseOptions
(
)
;
int
low_encode_usage_threshold_percent
;
int
high_encode_usage_threshold_percent
;
int
frame_timeout_interval_ms
;
int
min_frame_samples
;
int
min_process_count
;
int
high_threshold_consecutive_count
;
}
;
struct
CpuOveruseMetrics
{
CpuOveruseMetrics
(
)
:
encode_usage_percent
(
-
1
)
{
}
int
encode_usage_percent
;
}
;
class
CpuOveruseMetricsObserver
{
public
:
virtual
~
CpuOveruseMetricsObserver
(
)
{
}
virtual
void
OnEncodedFrameTimeMeasured
(
int
encode_duration_ms
const
CpuOveruseMetrics
&
metrics
)
=
0
;
}
;
class
OveruseFrameDetector
{
public
:
OveruseFrameDetector
(
Clock
*
clock
const
CpuOveruseOptions
&
options
ScalingObserverInterface
*
overuse_observer
EncodedFrameObserver
*
encoder_timing_
CpuOveruseMetricsObserver
*
metrics_observer
)
;
~
OveruseFrameDetector
(
)
;
void
StartCheckForOveruse
(
)
;
void
StopCheckForOveruse
(
)
;
void
FrameCaptured
(
const
VideoFrame
&
frame
int64_t
time_when_first_seen_ms
)
;
void
FrameSent
(
uint32_t
timestamp
int64_t
time_sent_in_ms
)
;
protected
:
void
CheckForOveruse
(
)
;
private
:
class
SendProcessingUsage
;
class
CheckOveruseTask
;
struct
FrameTiming
{
FrameTiming
(
int64_t
capture_ntp_ms
uint32_t
timestamp
int64_t
now
)
:
capture_ntp_ms
(
capture_ntp_ms
)
timestamp
(
timestamp
)
capture_ms
(
now
)
last_send_ms
(
-
1
)
{
}
int64_t
capture_ntp_ms
;
uint32_t
timestamp
;
int64_t
capture_ms
;
int64_t
last_send_ms
;
}
;
void
EncodedFrameTimeMeasured
(
int
encode_duration_ms
)
;
bool
IsOverusing
(
const
CpuOveruseMetrics
&
metrics
)
;
bool
IsUnderusing
(
const
CpuOveruseMetrics
&
metrics
int64_t
time_now
)
;
bool
FrameTimeoutDetected
(
int64_t
now
)
const
;
bool
FrameSizeChanged
(
int
num_pixels
)
const
;
void
ResetAll
(
int
num_pixels
)
;
rtc
:
:
SequencedTaskChecker
task_checker_
;
CheckOveruseTask
*
check_overuse_task_
;
const
CpuOveruseOptions
options_
;
ScalingObserverInterface
*
const
observer_
;
EncodedFrameObserver
*
const
encoder_timing_
;
CpuOveruseMetricsObserver
*
const
metrics_observer_
;
rtc
:
:
Optional
<
CpuOveruseMetrics
>
metrics_
GUARDED_BY
(
task_checker_
)
;
Clock
*
const
clock_
;
int64_t
num_process_times_
GUARDED_BY
(
task_checker_
)
;
int64_t
last_capture_time_ms_
GUARDED_BY
(
task_checker_
)
;
int64_t
last_processed_capture_time_ms_
GUARDED_BY
(
task_checker_
)
;
int
num_pixels_
GUARDED_BY
(
task_checker_
)
;
int64_t
last_overuse_time_ms_
GUARDED_BY
(
task_checker_
)
;
int
checks_above_threshold_
GUARDED_BY
(
task_checker_
)
;
int
num_overuse_detections_
GUARDED_BY
(
task_checker_
)
;
int64_t
last_rampup_time_ms_
GUARDED_BY
(
task_checker_
)
;
bool
in_quick_rampup_
GUARDED_BY
(
task_checker_
)
;
int
current_rampup_delay_ms_
GUARDED_BY
(
task_checker_
)
;
const
std
:
:
unique_ptr
<
SendProcessingUsage
>
usage_
GUARDED_BY
(
task_checker_
)
;
std
:
:
list
<
FrameTiming
>
frame_timing_
GUARDED_BY
(
task_checker_
)
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
OveruseFrameDetector
)
;
}
;
}
#
endif
