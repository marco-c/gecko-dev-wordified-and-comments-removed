#
include
"
webrtc
/
system_wrappers
/
interface
/
critical_section_wrapper
.
h
"
#
include
"
webrtc
/
system_wrappers
/
interface
/
tick_util
.
h
"
#
include
"
webrtc
/
voice_engine
/
monitor_module
.
h
"
namespace
webrtc
{
namespace
voe
{
MonitorModule
:
:
MonitorModule
(
)
:
_observerPtr
(
NULL
)
_callbackCritSect
(
*
CriticalSectionWrapper
:
:
CreateCriticalSection
(
)
)
_lastProcessTime
(
TickTime
:
:
MillisecondTimestamp
(
)
)
{
}
MonitorModule
:
:
~
MonitorModule
(
)
{
delete
&
_callbackCritSect
;
}
int32_t
MonitorModule
:
:
RegisterObserver
(
MonitorObserver
&
observer
)
{
CriticalSectionScoped
lock
(
&
_callbackCritSect
)
;
if
(
_observerPtr
)
{
return
-
1
;
}
_observerPtr
=
&
observer
;
return
0
;
}
int32_t
MonitorModule
:
:
DeRegisterObserver
(
)
{
CriticalSectionScoped
lock
(
&
_callbackCritSect
)
;
if
(
!
_observerPtr
)
{
return
0
;
}
_observerPtr
=
NULL
;
return
0
;
}
int64_t
MonitorModule
:
:
TimeUntilNextProcess
(
)
{
int64_t
now
=
TickTime
:
:
MillisecondTimestamp
(
)
;
const
int64_t
kAverageProcessUpdateTimeMs
=
1000
;
return
kAverageProcessUpdateTimeMs
-
(
now
-
_lastProcessTime
)
;
}
int32_t
MonitorModule
:
:
Process
(
)
{
_lastProcessTime
=
TickTime
:
:
MillisecondTimestamp
(
)
;
if
(
_observerPtr
)
{
CriticalSectionScoped
lock
(
&
_callbackCritSect
)
;
_observerPtr
-
>
OnPeriodicProcess
(
)
;
}
return
0
;
}
}
}
