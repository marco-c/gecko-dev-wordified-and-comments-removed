#
include
"
rtc_base
/
gunit
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
nullsocketserver
.
h
"
#
include
"
rtc_base
/
stream
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
test
/
testsupport
/
fileutils
.
h
"
namespace
rtc
{
template
<
typename
Base
>
class
LogSinkImpl
:
public
LogSink
public
Base
{
public
:
LogSinkImpl
(
)
{
}
template
<
typename
P
>
explicit
LogSinkImpl
(
P
*
p
)
:
Base
(
p
)
{
}
private
:
void
OnLogMessage
(
const
std
:
:
string
&
message
)
override
{
static_cast
<
Base
*
>
(
this
)
-
>
WriteAll
(
message
.
data
(
)
message
.
size
(
)
nullptr
nullptr
)
;
}
}
;
TEST
(
LogTest
SingleStream
)
{
int
sev
=
LogMessage
:
:
GetLogToStream
(
nullptr
)
;
std
:
:
string
str
;
LogSinkImpl
<
StringStream
>
stream
(
&
str
)
;
LogMessage
:
:
AddLogToStream
(
&
stream
LS_INFO
)
;
EXPECT_EQ
(
LS_INFO
LogMessage
:
:
GetLogToStream
(
&
stream
)
)
;
RTC_LOG
(
LS_INFO
)
<
<
"
INFO
"
;
RTC_LOG
(
LS_VERBOSE
)
<
<
"
VERBOSE
"
;
EXPECT_NE
(
std
:
:
string
:
:
npos
str
.
find
(
"
INFO
"
)
)
;
EXPECT_EQ
(
std
:
:
string
:
:
npos
str
.
find
(
"
VERBOSE
"
)
)
;
LogMessage
:
:
RemoveLogToStream
(
&
stream
)
;
EXPECT_EQ
(
LS_NONE
LogMessage
:
:
GetLogToStream
(
&
stream
)
)
;
EXPECT_EQ
(
sev
LogMessage
:
:
GetLogToStream
(
nullptr
)
)
;
}
TEST
(
LogTest
MultipleStreams
)
{
int
sev
=
LogMessage
:
:
GetLogToStream
(
nullptr
)
;
std
:
:
string
str1
str2
;
LogSinkImpl
<
StringStream
>
stream1
(
&
str1
)
stream2
(
&
str2
)
;
LogMessage
:
:
AddLogToStream
(
&
stream1
LS_INFO
)
;
LogMessage
:
:
AddLogToStream
(
&
stream2
LS_VERBOSE
)
;
EXPECT_EQ
(
LS_INFO
LogMessage
:
:
GetLogToStream
(
&
stream1
)
)
;
EXPECT_EQ
(
LS_VERBOSE
LogMessage
:
:
GetLogToStream
(
&
stream2
)
)
;
RTC_LOG
(
LS_INFO
)
<
<
"
INFO
"
;
RTC_LOG
(
LS_VERBOSE
)
<
<
"
VERBOSE
"
;
EXPECT_NE
(
std
:
:
string
:
:
npos
str1
.
find
(
"
INFO
"
)
)
;
EXPECT_EQ
(
std
:
:
string
:
:
npos
str1
.
find
(
"
VERBOSE
"
)
)
;
EXPECT_NE
(
std
:
:
string
:
:
npos
str2
.
find
(
"
INFO
"
)
)
;
EXPECT_NE
(
std
:
:
string
:
:
npos
str2
.
find
(
"
VERBOSE
"
)
)
;
LogMessage
:
:
RemoveLogToStream
(
&
stream2
)
;
LogMessage
:
:
RemoveLogToStream
(
&
stream1
)
;
EXPECT_EQ
(
LS_NONE
LogMessage
:
:
GetLogToStream
(
&
stream2
)
)
;
EXPECT_EQ
(
LS_NONE
LogMessage
:
:
GetLogToStream
(
&
stream1
)
)
;
EXPECT_EQ
(
sev
LogMessage
:
:
GetLogToStream
(
nullptr
)
)
;
}
class
LogThread
:
public
Thread
{
public
:
LogThread
(
)
:
Thread
(
std
:
:
unique_ptr
<
SocketServer
>
(
new
NullSocketServer
(
)
)
)
{
}
~
LogThread
(
)
override
{
Stop
(
)
;
}
private
:
void
Run
(
)
override
{
RTC_LOG
(
LS_SENSITIVE
)
<
<
"
RTC_LOG
"
;
}
}
;
TEST
(
LogTest
MultipleThreads
)
{
int
sev
=
LogMessage
:
:
GetLogToStream
(
nullptr
)
;
LogThread
thread1
thread2
thread3
;
thread1
.
Start
(
)
;
thread2
.
Start
(
)
;
thread3
.
Start
(
)
;
LogSinkImpl
<
NullStream
>
stream1
stream2
stream3
;
for
(
int
i
=
0
;
i
<
1000
;
+
+
i
)
{
LogMessage
:
:
AddLogToStream
(
&
stream1
LS_INFO
)
;
LogMessage
:
:
AddLogToStream
(
&
stream2
LS_VERBOSE
)
;
LogMessage
:
:
AddLogToStream
(
&
stream3
LS_SENSITIVE
)
;
LogMessage
:
:
RemoveLogToStream
(
&
stream1
)
;
LogMessage
:
:
RemoveLogToStream
(
&
stream2
)
;
LogMessage
:
:
RemoveLogToStream
(
&
stream3
)
;
}
EXPECT_EQ
(
sev
LogMessage
:
:
GetLogToStream
(
nullptr
)
)
;
}
TEST
(
LogTest
WallClockStartTime
)
{
uint32_t
time
=
LogMessage
:
:
WallClockStartTime
(
)
;
EXPECT_GT
(
time
1325376000u
)
;
}
#
if
defined
(
WEBRTC_ANDROID
)
#
define
MAYBE_Perf
DISABLED_Perf
#
else
#
define
MAYBE_Perf
Perf
#
endif
TEST
(
LogTest
MAYBE_Perf
)
{
std
:
:
string
path
=
webrtc
:
:
test
:
:
TempFilename
(
webrtc
:
:
test
:
:
OutputPath
(
)
"
ut
"
)
;
LogSinkImpl
<
FileStream
>
stream
;
EXPECT_TRUE
(
stream
.
Open
(
path
"
wb
"
nullptr
)
)
;
stream
.
DisableBuffering
(
)
;
LogMessage
:
:
AddLogToStream
(
&
stream
LS_SENSITIVE
)
;
int64_t
start
=
TimeMillis
(
)
finish
;
std
:
:
string
message
(
'
X
'
80
)
;
for
(
int
i
=
0
;
i
<
1000
;
+
+
i
)
{
RTC_LOG
(
LS_SENSITIVE
)
<
<
message
;
}
finish
=
TimeMillis
(
)
;
LogMessage
:
:
RemoveLogToStream
(
&
stream
)
;
stream
.
Close
(
)
;
webrtc
:
:
test
:
:
RemoveFile
(
path
)
;
RTC_LOG
(
LS_INFO
)
<
<
"
Average
log
time
:
"
<
<
TimeDiff
(
finish
start
)
<
<
"
ms
"
;
}
}
