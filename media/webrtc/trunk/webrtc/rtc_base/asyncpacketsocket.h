#
ifndef
RTC_BASE_ASYNCPACKETSOCKET_H_
#
define
RTC_BASE_ASYNCPACKETSOCKET_H_
#
include
"
rtc_base
/
constructormagic
.
h
"
#
include
"
rtc_base
/
dscp
.
h
"
#
include
"
rtc_base
/
sigslot
.
h
"
#
include
"
rtc_base
/
socket
.
h
"
#
include
"
rtc_base
/
timeutils
.
h
"
namespace
rtc
{
struct
PacketTimeUpdateParams
{
PacketTimeUpdateParams
(
)
;
~
PacketTimeUpdateParams
(
)
;
int
rtp_sendtime_extension_id
;
std
:
:
vector
<
char
>
srtp_auth_key
;
int
srtp_auth_tag_len
;
int64_t
srtp_packet_index
;
}
;
struct
PacketOptions
{
PacketOptions
(
)
:
dscp
(
DSCP_NO_CHANGE
)
packet_id
(
-
1
)
{
}
explicit
PacketOptions
(
DiffServCodePoint
dscp
)
:
dscp
(
dscp
)
packet_id
(
-
1
)
{
}
DiffServCodePoint
dscp
;
int
packet_id
;
PacketTimeUpdateParams
packet_time_params
;
}
;
struct
PacketTime
{
PacketTime
(
)
:
timestamp
(
-
1
)
not_before
(
-
1
)
{
}
PacketTime
(
int64_t
timestamp
int64_t
not_before
)
:
timestamp
(
timestamp
)
not_before
(
not_before
)
{
}
int64_t
timestamp
;
int64_t
not_before
;
}
;
inline
PacketTime
CreatePacketTime
(
int64_t
not_before
)
{
return
PacketTime
(
TimeMicros
(
)
not_before
)
;
}
class
AsyncPacketSocket
:
public
sigslot
:
:
has_slots
<
>
{
public
:
enum
State
{
STATE_CLOSED
STATE_BINDING
STATE_BOUND
STATE_CONNECTING
STATE_CONNECTED
}
;
AsyncPacketSocket
(
)
;
~
AsyncPacketSocket
(
)
override
;
virtual
SocketAddress
GetLocalAddress
(
)
const
=
0
;
virtual
SocketAddress
GetRemoteAddress
(
)
const
=
0
;
virtual
int
Send
(
const
void
*
pv
size_t
cb
const
PacketOptions
&
options
)
=
0
;
virtual
int
SendTo
(
const
void
*
pv
size_t
cb
const
SocketAddress
&
addr
const
PacketOptions
&
options
)
=
0
;
virtual
int
Close
(
)
=
0
;
virtual
State
GetState
(
)
const
=
0
;
virtual
int
GetOption
(
Socket
:
:
Option
opt
int
*
value
)
=
0
;
virtual
int
SetOption
(
Socket
:
:
Option
opt
int
value
)
=
0
;
virtual
int
GetError
(
)
const
=
0
;
virtual
void
SetError
(
int
error
)
=
0
;
sigslot
:
:
signal5
<
AsyncPacketSocket
*
const
char
*
size_t
const
SocketAddress
&
const
PacketTime
&
>
SignalReadPacket
;
sigslot
:
:
signal2
<
AsyncPacketSocket
*
const
SentPacket
&
>
SignalSentPacket
;
sigslot
:
:
signal1
<
AsyncPacketSocket
*
>
SignalReadyToSend
;
sigslot
:
:
signal2
<
AsyncPacketSocket
*
const
SocketAddress
&
>
SignalAddressReady
;
sigslot
:
:
signal1
<
AsyncPacketSocket
*
>
SignalConnect
;
sigslot
:
:
signal2
<
AsyncPacketSocket
*
int
>
SignalClose
;
sigslot
:
:
signal2
<
AsyncPacketSocket
*
AsyncPacketSocket
*
>
SignalNewConnection
;
private
:
RTC_DISALLOW_COPY_AND_ASSIGN
(
AsyncPacketSocket
)
;
}
;
}
#
endif
