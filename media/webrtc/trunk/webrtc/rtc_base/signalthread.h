#
ifndef
RTC_BASE_SIGNALTHREAD_H_
#
define
RTC_BASE_SIGNALTHREAD_H_
#
include
<
string
>
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
constructormagic
.
h
"
#
include
"
rtc_base
/
nullsocketserver
.
h
"
#
include
"
rtc_base
/
sigslot
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
namespace
rtc
{
class
SignalThread
:
public
sigslot
:
:
has_slots
<
>
protected
MessageHandler
{
public
:
explicit
SignalThread
(
bool
use_socket_server
=
true
)
;
bool
SetName
(
const
std
:
:
string
&
name
const
void
*
obj
)
;
void
Start
(
)
;
void
Destroy
(
bool
wait
)
;
void
Release
(
)
;
sigslot
:
:
signal1
<
SignalThread
*
>
SignalWorkDone
;
enum
{
ST_MSG_WORKER_DONE
ST_MSG_FIRST_AVAILABLE
}
;
protected
:
~
SignalThread
(
)
override
;
Thread
*
worker
(
)
{
return
&
worker_
;
}
virtual
void
OnWorkStart
(
)
{
}
virtual
void
DoWork
(
)
=
0
;
bool
ContinueWork
(
)
;
virtual
void
OnWorkStop
(
)
{
}
virtual
void
OnWorkDone
(
)
{
}
void
OnMessage
(
Message
*
msg
)
override
;
private
:
enum
State
{
kInit
kRunning
kReleasing
kComplete
kStopping
}
;
class
Worker
:
public
Thread
{
public
:
explicit
Worker
(
SignalThread
*
parent
bool
use_socket_server
)
:
Thread
(
use_socket_server
?
SocketServer
:
:
CreateDefault
(
)
:
std
:
:
unique_ptr
<
SocketServer
>
(
new
NullSocketServer
(
)
)
)
parent_
(
parent
)
{
}
~
Worker
(
)
override
;
void
Run
(
)
override
;
bool
IsProcessingMessages
(
)
override
;
private
:
SignalThread
*
parent_
;
RTC_DISALLOW_IMPLICIT_CONSTRUCTORS
(
Worker
)
;
}
;
class
RTC_SCOPED_LOCKABLE
EnterExit
{
public
:
explicit
EnterExit
(
SignalThread
*
t
)
RTC_EXCLUSIVE_LOCK_FUNCTION
(
t
-
>
cs_
)
:
t_
(
t
)
{
t_
-
>
cs_
.
Enter
(
)
;
RTC_DCHECK_NE
(
0
t_
-
>
refcount_
)
;
+
+
t_
-
>
refcount_
;
}
~
EnterExit
(
)
RTC_UNLOCK_FUNCTION
(
)
{
bool
d
=
(
0
=
=
-
-
t_
-
>
refcount_
)
;
t_
-
>
cs_
.
Leave
(
)
;
if
(
d
)
delete
t_
;
}
private
:
SignalThread
*
t_
;
RTC_DISALLOW_IMPLICIT_CONSTRUCTORS
(
EnterExit
)
;
}
;
void
Run
(
)
;
void
OnMainThreadDestroyed
(
)
;
Thread
*
main_
;
Worker
worker_
;
CriticalSection
cs_
;
State
state_
;
int
refcount_
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
SignalThread
)
;
}
;
}
#
endif
