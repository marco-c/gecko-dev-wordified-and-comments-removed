#
ifndef
RTC_BASE_PLATFORM_THREAD_H_
#
define
RTC_BASE_PLATFORM_THREAD_H_
#
include
<
string
>
#
include
"
rtc_base
/
constructormagic
.
h
"
#
include
"
rtc_base
/
event
.
h
"
#
include
"
rtc_base
/
platform_thread_types
.
h
"
#
include
"
rtc_base
/
thread_checker
.
h
"
namespace
rtc
{
PlatformThreadId
CurrentThreadId
(
)
;
PlatformThreadRef
CurrentThreadRef
(
)
;
bool
IsThreadRefEqual
(
const
PlatformThreadRef
&
a
const
PlatformThreadRef
&
b
)
;
void
SetCurrentThreadName
(
const
char
*
name
)
;
typedef
bool
(
*
ThreadRunFunctionDeprecated
)
(
void
*
)
;
typedef
void
(
*
ThreadRunFunction
)
(
void
*
)
;
enum
ThreadPriority
{
#
ifdef
WEBRTC_WIN
kLowPriority
=
THREAD_PRIORITY_BELOW_NORMAL
kNormalPriority
=
THREAD_PRIORITY_NORMAL
kHighPriority
=
THREAD_PRIORITY_ABOVE_NORMAL
kHighestPriority
=
THREAD_PRIORITY_HIGHEST
kRealtimePriority
=
THREAD_PRIORITY_TIME_CRITICAL
#
else
kLowPriority
=
1
kNormalPriority
=
2
kHighPriority
=
3
kHighestPriority
=
4
kRealtimePriority
=
5
#
endif
}
;
class
PlatformThread
{
public
:
PlatformThread
(
ThreadRunFunctionDeprecated
func
void
*
obj
const
char
*
thread_name
)
;
PlatformThread
(
ThreadRunFunction
func
void
*
obj
const
char
*
thread_name
ThreadPriority
priority
=
kNormalPriority
)
;
virtual
~
PlatformThread
(
)
;
const
std
:
:
string
&
name
(
)
const
{
return
name_
;
}
virtual
void
Start
(
)
;
bool
IsRunning
(
)
const
;
PlatformThreadRef
GetThreadRef
(
)
const
;
virtual
void
Stop
(
)
;
bool
SetPriority
(
ThreadPriority
priority
)
;
protected
:
#
if
defined
(
WEBRTC_WIN
)
bool
QueueAPC
(
PAPCFUNC
apc_function
ULONG_PTR
data
)
;
#
endif
virtual
void
Run
(
)
;
ThreadRunFunctionDeprecated
const
run_function_deprecated_
=
nullptr
;
ThreadRunFunction
const
run_function_
=
nullptr
;
const
ThreadPriority
priority_
=
kNormalPriority
;
void
*
const
obj_
;
const
std
:
:
string
name_
;
rtc
:
:
ThreadChecker
thread_checker_
;
rtc
:
:
ThreadChecker
spawned_thread_checker_
;
#
if
defined
(
WEBRTC_WIN
)
static
DWORD
WINAPI
StartThread
(
void
*
param
)
;
bool
stop_
=
false
;
HANDLE
thread_
=
nullptr
;
DWORD
thread_id_
=
0
;
CriticalSection
cs_
;
#
else
static
void
*
StartThread
(
void
*
param
)
;
volatile
int
stop_flag_
=
0
;
pthread_t
thread_
=
0
;
#
endif
RTC_DISALLOW_COPY_AND_ASSIGN
(
PlatformThread
)
;
}
;
#
if
defined
(
WEBRTC_WIN
)
class
PlatformUIThread
:
public
PlatformThread
{
public
:
PlatformUIThread
(
ThreadRunFunctionDeprecated
func
void
*
obj
const
char
*
thread_name
)
:
PlatformThread
(
func
obj
thread_name
)
hwnd_
(
nullptr
)
timerid_
(
0
)
timeout_
(
0
)
{
}
virtual
~
PlatformUIThread
(
)
{
}
void
Stop
(
)
override
;
void
RequestCallback
(
)
;
bool
RequestCallbackTimer
(
unsigned
int
milliseconds
)
;
protected
:
void
Run
(
)
override
;
private
:
static
LRESULT
CALLBACK
EventWindowProc
(
HWND
UINT
WPARAM
LPARAM
)
;
void
NativeEventCallback
(
)
;
bool
InternalInit
(
)
;
HWND
hwnd_
;
UINT_PTR
timerid_
;
unsigned
int
timeout_
;
}
;
#
endif
}
#
endif
