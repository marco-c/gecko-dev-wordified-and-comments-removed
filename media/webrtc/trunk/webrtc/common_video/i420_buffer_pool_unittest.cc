#
include
<
string
>
#
include
"
webrtc
/
common_video
/
include
/
i420_buffer_pool
.
h
"
#
include
"
webrtc
/
test
/
gtest
.
h
"
namespace
webrtc
{
TEST
(
TestI420BufferPool
SimpleFrameReuse
)
{
I420BufferPool
pool
;
rtc
:
:
scoped_refptr
<
VideoFrameBuffer
>
buffer
=
pool
.
CreateBuffer
(
16
16
)
;
EXPECT_EQ
(
16
buffer
-
>
width
(
)
)
;
EXPECT_EQ
(
16
buffer
-
>
height
(
)
)
;
const
uint8_t
*
y_ptr
=
buffer
-
>
DataY
(
)
;
const
uint8_t
*
u_ptr
=
buffer
-
>
DataU
(
)
;
const
uint8_t
*
v_ptr
=
buffer
-
>
DataV
(
)
;
buffer
=
nullptr
;
buffer
=
pool
.
CreateBuffer
(
16
16
)
;
EXPECT_EQ
(
y_ptr
buffer
-
>
DataY
(
)
)
;
EXPECT_EQ
(
u_ptr
buffer
-
>
DataU
(
)
)
;
EXPECT_EQ
(
v_ptr
buffer
-
>
DataV
(
)
)
;
EXPECT_EQ
(
16
buffer
-
>
width
(
)
)
;
EXPECT_EQ
(
16
buffer
-
>
height
(
)
)
;
}
TEST
(
TestI420BufferPool
FailToReuse
)
{
I420BufferPool
pool
;
rtc
:
:
scoped_refptr
<
VideoFrameBuffer
>
buffer
=
pool
.
CreateBuffer
(
16
16
)
;
const
uint8_t
*
u_ptr
=
buffer
-
>
DataU
(
)
;
const
uint8_t
*
v_ptr
=
buffer
-
>
DataV
(
)
;
buffer
=
nullptr
;
buffer
=
pool
.
CreateBuffer
(
32
16
)
;
EXPECT_EQ
(
32
buffer
-
>
width
(
)
)
;
EXPECT_EQ
(
16
buffer
-
>
height
(
)
)
;
EXPECT_NE
(
u_ptr
buffer
-
>
DataU
(
)
)
;
EXPECT_NE
(
v_ptr
buffer
-
>
DataV
(
)
)
;
}
TEST
(
TestI420BufferPool
FrameValidAfterPoolDestruction
)
{
rtc
:
:
scoped_refptr
<
I420Buffer
>
buffer
;
{
I420BufferPool
pool
;
buffer
=
pool
.
CreateBuffer
(
16
16
)
;
}
EXPECT_EQ
(
16
buffer
-
>
width
(
)
)
;
EXPECT_EQ
(
16
buffer
-
>
height
(
)
)
;
memset
(
buffer
-
>
MutableDataY
(
)
0xA5
16
*
buffer
-
>
StrideY
(
)
)
;
}
TEST
(
TestI420BufferPool
MaxNumberOfBuffers
)
{
I420BufferPool
pool
(
false
1
)
;
rtc
:
:
scoped_refptr
<
VideoFrameBuffer
>
buffer1
=
pool
.
CreateBuffer
(
16
16
)
;
EXPECT_NE
(
nullptr
buffer1
.
get
(
)
)
;
EXPECT_EQ
(
nullptr
pool
.
CreateBuffer
(
16
16
)
.
get
(
)
)
;
}
}
