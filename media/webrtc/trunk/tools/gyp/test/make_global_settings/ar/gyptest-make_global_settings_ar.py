"
"
"
Verifies
'
AR
'
in
make_global_settings
.
"
"
"
import
os
import
sys
import
TestGyp
def
resolve_path
(
test
path
)
:
  
if
path
is
None
:
    
return
None
  
elif
test
.
format
=
=
'
make
'
:
    
return
'
(
abspath
%
s
)
'
%
path
  
elif
test
.
format
in
[
'
ninja
'
'
xcode
-
ninja
'
]
:
    
return
os
.
path
.
join
(
'
.
.
'
'
.
.
'
path
)
  
else
:
    
test
.
fail_test
(
)
def
verify_ar_target
(
test
ar
=
None
rel_path
=
False
)
:
  
if
rel_path
:
    
ar_expected
=
resolve_path
(
test
ar
)
  
else
:
    
ar_expected
=
ar
  
if
ar_expected
is
None
:
    
if
test
.
format
=
=
'
make
'
:
      
test
.
must_not_contain
(
'
Makefile
'
'
AR
?
=
'
)
      
return
    
elif
test
.
format
in
[
'
ninja
'
'
xcode
-
ninja
'
]
:
      
if
sys
.
platform
=
=
'
win32
'
:
        
ar_expected
=
'
lib
.
exe
'
      
else
:
        
ar_expected
=
'
ar
'
  
if
test
.
format
=
=
'
make
'
:
    
test
.
must_contain
(
'
Makefile
'
'
AR
?
=
%
s
'
%
ar_expected
)
  
elif
test
.
format
in
[
'
ninja
'
'
xcode
-
ninja
'
]
:
    
test
.
must_contain
(
'
out
/
Default
/
build
.
ninja
'
'
ar
=
%
s
'
%
ar_expected
)
  
else
:
    
test
.
fail_test
(
)
def
verify_ar_host
(
test
ar
=
None
rel_path
=
False
)
:
  
if
rel_path
:
    
ar_expected
=
resolve_path
(
test
ar
)
  
else
:
    
ar_expected
=
ar
  
if
ar_expected
is
None
:
    
if
sys
.
platform
=
=
'
win32
'
:
      
ar_expected
=
'
lib
.
exe
'
    
else
:
      
ar_expected
=
'
ar
'
  
if
test
.
format
=
=
'
make
'
:
    
test
.
must_contain
(
'
Makefile
'
'
AR
.
host
?
=
%
s
'
%
ar_expected
)
  
elif
test
.
format
in
[
'
ninja
'
'
xcode
-
ninja
'
]
:
    
test
.
must_contain
(
'
out
/
Default
/
build
.
ninja
'
'
ar_host
=
%
s
'
%
ar_expected
)
  
else
:
    
test
.
fail_test
(
)
test_format
=
[
'
ninja
'
]
if
sys
.
platform
in
(
'
linux2
'
'
darwin
'
)
:
  
test_format
+
=
[
'
make
'
]
test
=
TestGyp
.
TestGyp
(
formats
=
test_format
)
test
.
run_gyp
(
'
make_global_settings_ar
.
gyp
'
)
verify_ar_target
(
test
)
with
TestGyp
.
LocalEnv
(
{
'
GYP_CROSSCOMPILE
'
:
'
1
'
}
)
:
  
test
.
run_gyp
(
'
make_global_settings_ar
.
gyp
'
)
verify_ar_target
(
test
)
verify_ar_host
(
test
)
with
TestGyp
.
LocalEnv
(
{
'
GYP_CROSSCOMPILE
'
:
'
1
'
}
)
:
  
test
.
run_gyp
(
'
make_global_settings_ar
.
gyp
'
'
-
Dcustom_ar_target
=
my_ar
'
)
verify_ar_target
(
test
ar
=
'
my_ar
'
rel_path
=
True
)
with
TestGyp
.
LocalEnv
(
{
'
GYP_CROSSCOMPILE
'
:
'
1
'
}
)
:
  
test
.
run_gyp
(
'
make_global_settings_ar
.
gyp
'
               
'
-
Dcustom_ar_target
=
my_ar_target1
'
               
'
-
Dcustom_ar_host
=
my_ar_host1
'
)
verify_ar_target
(
test
ar
=
'
my_ar_target1
'
rel_path
=
True
)
verify_ar_host
(
test
ar
=
'
my_ar_host1
'
rel_path
=
True
)
with
TestGyp
.
LocalEnv
(
{
'
AR
'
:
'
my_ar_target2
'
                       
'
AR_host
'
:
'
my_ar_host2
'
}
)
:
  
test
.
run_gyp
(
'
make_global_settings_ar
.
gyp
'
)
if
test
.
format
=
=
'
ninja
'
:
  
if
sys
.
platform
=
=
'
win32
'
:
    
verify_ar_target
(
test
ar
=
'
lib
.
exe
'
rel_path
=
False
)
  
else
:
    
verify_ar_target
(
test
ar
=
'
my_ar_target2
'
rel_path
=
False
)
verify_ar_host
(
test
ar
=
'
my_ar_host2
'
rel_path
=
False
)
with
TestGyp
.
LocalEnv
(
{
'
AR_host
'
:
'
my_ar_host3
'
}
)
:
  
test
.
run_gyp
(
'
make_global_settings_ar
.
gyp
'
               
'
-
Dcustom_ar_target
=
my_ar_target3
'
)
verify_ar_target
(
test
ar
=
'
my_ar_target3
'
rel_path
=
True
)
verify_ar_host
(
test
ar
=
'
my_ar_host3
'
rel_path
=
False
)
test
.
pass_test
(
)
