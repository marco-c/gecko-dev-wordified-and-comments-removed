#
include
<
assert
.
h
>
#
include
<
limits
.
h
>
#
include
"
.
/
bitwriter
.
h
"
#
if
CONFIG_BITSTREAM_DEBUG
#
include
"
vpx_util
/
vpx_debug_util
.
h
"
#
endif
void
vpx_start_encode
(
vpx_writer
*
br
uint8_t
*
source
size_t
size
)
{
br
-
>
lowvalue
=
0
;
br
-
>
range
=
255
;
br
-
>
count
=
-
24
;
br
-
>
error
=
0
;
br
-
>
pos
=
0
;
if
(
size
>
INT_MAX
)
size
=
INT_MAX
;
br
-
>
size
=
(
unsigned
int
)
size
;
br
-
>
buffer
=
source
;
vpx_write_bit
(
br
0
)
;
}
int
vpx_stop_encode
(
vpx_writer
*
br
)
{
int
i
;
#
if
CONFIG_BITSTREAM_DEBUG
bitstream_queue_set_skip_write
(
1
)
;
#
endif
for
(
i
=
0
;
i
<
32
;
i
+
+
)
vpx_write_bit
(
br
0
)
;
if
(
!
br
-
>
error
&
&
(
br
-
>
buffer
[
br
-
>
pos
-
1
]
&
0xe0
)
=
=
0xc0
)
{
if
(
br
-
>
pos
<
br
-
>
size
)
{
br
-
>
buffer
[
br
-
>
pos
+
+
]
=
0
;
}
else
{
br
-
>
error
=
1
;
}
}
#
if
CONFIG_BITSTREAM_DEBUG
bitstream_queue_set_skip_write
(
0
)
;
#
endif
return
br
-
>
error
?
-
1
:
0
;
}
