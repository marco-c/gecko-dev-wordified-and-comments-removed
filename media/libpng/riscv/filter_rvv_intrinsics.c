#
include
"
.
.
/
pngpriv
.
h
"
#
ifdef
PNG_READ_SUPPORTED
#
if
PNG_RISCV_RVV_IMPLEMENTATION
=
=
1
#
include
<
riscv_vector
.
h
>
void
png_read_filter_row_up_rvv
(
png_row_infop
row_info
png_bytep
row
png_const_bytep
prev_row
)
{
size_t
len
=
row_info
-
>
rowbytes
;
for
(
size_t
vl
;
len
>
0
;
len
-
=
vl
row
+
=
vl
prev_row
+
=
vl
)
{
vl
=
__riscv_vsetvl_e8m8
(
len
)
;
vuint8m8_t
prev_vals
=
__riscv_vle8_v_u8m8
(
prev_row
vl
)
;
vuint8m8_t
row_vals
=
__riscv_vle8_v_u8m8
(
row
vl
)
;
row_vals
=
__riscv_vadd_vv_u8m8
(
row_vals
prev_vals
vl
)
;
__riscv_vse8_v_u8m8
(
row
row_vals
vl
)
;
}
}
static
inline
void
png_read_filter_row_sub_rvv
(
size_t
len
size_t
bpp
unsigned
char
*
row
)
{
png_bytep
rp_end
=
row
+
len
;
size_t
vl
=
__riscv_vsetvl_e8m1
(
bpp
)
;
vuint8m1_t
a
=
__riscv_vle8_v_u8m1
(
row
vl
)
;
row
+
=
bpp
;
while
(
row
<
rp_end
)
{
vuint8m1_t
x
=
__riscv_vle8_v_u8m1
(
row
vl
)
;
a
=
__riscv_vadd_vv_u8m1
(
a
x
vl
)
;
__riscv_vse8_v_u8m1
(
row
a
vl
)
;
row
+
=
bpp
;
}
}
void
png_read_filter_row_sub3_rvv
(
png_row_infop
row_info
png_bytep
row
png_const_bytep
prev_row
)
{
size_t
len
=
row_info
-
>
rowbytes
;
png_read_filter_row_sub_rvv
(
len
3
row
)
;
PNG_UNUSED
(
prev_row
)
}
void
png_read_filter_row_sub4_rvv
(
png_row_infop
row_info
png_bytep
row
png_const_bytep
prev_row
)
{
size_t
len
=
row_info
-
>
rowbytes
;
png_read_filter_row_sub_rvv
(
len
4
row
)
;
PNG_UNUSED
(
prev_row
)
}
static
inline
void
png_read_filter_row_avg_rvv
(
size_t
len
size_t
bpp
unsigned
char
*
row
const
unsigned
char
*
prev_row
)
{
png_bytep
rp_end
=
row
+
len
;
size_t
vl
=
__riscv_vsetvl_e8m1
(
bpp
)
;
vuint8m1_t
b
=
__riscv_vle8_v_u8m1
(
prev_row
vl
)
;
prev_row
+
=
bpp
;
vuint8m1_t
x
=
__riscv_vle8_v_u8m1
(
row
vl
)
;
b
=
__riscv_vsrl_vx_u8m1
(
b
1
vl
)
;
vuint8m1_t
a
=
__riscv_vadd_vv_u8m1
(
b
x
vl
)
;
__riscv_vse8_v_u8m1
(
row
a
vl
)
;
row
+
=
bpp
;
while
(
row
<
rp_end
)
{
b
=
__riscv_vle8_v_u8m1
(
prev_row
vl
)
;
prev_row
+
=
bpp
;
x
=
__riscv_vle8_v_u8m1
(
row
vl
)
;
a
=
__riscv_vaaddu_vv_u8m1
(
a
b
2
vl
)
;
a
=
__riscv_vadd_vv_u8m1
(
a
x
vl
)
;
__riscv_vse8_v_u8m1
(
row
a
vl
)
;
row
+
=
bpp
;
}
}
void
png_read_filter_row_avg3_rvv
(
png_row_infop
row_info
png_bytep
row
png_const_bytep
prev_row
)
{
size_t
len
=
row_info
-
>
rowbytes
;
png_read_filter_row_avg_rvv
(
len
3
row
prev_row
)
;
PNG_UNUSED
(
prev_row
)
}
void
png_read_filter_row_avg4_rvv
(
png_row_infop
row_info
png_bytep
row
png_const_bytep
prev_row
)
{
size_t
len
=
row_info
-
>
rowbytes
;
png_read_filter_row_avg_rvv
(
len
4
row
prev_row
)
;
PNG_UNUSED
(
prev_row
)
}
static
inline
void
png_read_filter_row_paeth_rvv
(
size_t
len
size_t
bpp
unsigned
char
*
row
const
unsigned
char
*
prev
)
{
png_bytep
rp_end
=
row
+
len
;
size_t
vl
=
__riscv_vsetvl_e8m1
(
bpp
)
;
vuint8m1_t
a
=
__riscv_vle8_v_u8m1
(
row
vl
)
;
vuint8m1_t
c
=
__riscv_vle8_v_u8m1
(
prev
vl
)
;
a
=
__riscv_vadd_vv_u8m1
(
a
c
vl
)
;
__riscv_vse8_v_u8m1
(
row
a
vl
)
;
row
+
=
bpp
;
prev
+
=
bpp
;
while
(
row
<
rp_end
)
{
vuint8m1_t
b
=
__riscv_vle8_v_u8m1
(
prev
vl
)
;
prev
+
=
bpp
;
vuint8m1_t
x
=
__riscv_vle8_v_u8m1
(
row
vl
)
;
vuint16m2_t
p
=
__riscv_vwsubu_vv_u16m2
(
b
c
vl
)
;
vuint16m2_t
pc
=
__riscv_vwsubu_vv_u16m2
(
a
c
vl
)
;
vuint16m2_t
tmp
=
__riscv_vrsub_vx_u16m2
(
p
0
vl
)
;
vuint16m2_t
pa
=
__riscv_vminu_vv_u16m2
(
p
tmp
vl
)
;
tmp
=
__riscv_vrsub_vx_u16m2
(
pc
0
vl
)
;
vuint16m2_t
pb
=
__riscv_vminu_vv_u16m2
(
pc
tmp
vl
)
;
pc
=
__riscv_vadd_vv_u16m2
(
p
pc
vl
)
;
tmp
=
__riscv_vrsub_vx_u16m2
(
pc
0
vl
)
;
pc
=
__riscv_vminu_vv_u16m2
(
pc
tmp
vl
)
;
vbool8_t
m1
=
__riscv_vmsltu_vv_u16m2_b8
(
pb
pa
vl
)
;
pa
=
__riscv_vmerge_vvm_u16m2
(
pa
pb
m1
vl
)
;
a
=
__riscv_vmerge_vvm_u8m1
(
a
b
m1
vl
)
;
vbool8_t
m2
=
__riscv_vmsltu_vv_u16m2_b8
(
pc
pa
vl
)
;
a
=
__riscv_vmerge_vvm_u8m1
(
a
c
m2
vl
)
;
a
=
__riscv_vadd_vv_u8m1
(
a
x
vl
)
;
__riscv_vse8_v_u8m1
(
row
a
vl
)
;
row
+
=
bpp
;
c
=
b
;
}
}
void
png_read_filter_row_paeth3_rvv
(
png_row_infop
row_info
png_bytep
row
png_const_bytep
prev_row
)
{
size_t
len
=
row_info
-
>
rowbytes
;
png_read_filter_row_paeth_rvv
(
len
3
row
prev_row
)
;
}
void
png_read_filter_row_paeth4_rvv
(
png_row_infop
row_info
png_bytep
row
png_const_bytep
prev_row
)
{
size_t
len
=
row_info
-
>
rowbytes
;
png_read_filter_row_paeth_rvv
(
len
4
row
prev_row
)
;
}
#
endif
#
endif
