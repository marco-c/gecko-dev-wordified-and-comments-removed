#
ifdef
HAVE_CONFIG_H
#
include
"
config
.
h
"
#
endif
#
include
<
xmmintrin
.
h
>
#
include
<
emmintrin
.
h
>
#
include
<
smmintrin
.
h
>
#
include
"
main
.
h
"
#
include
"
stack_alloc
.
h
"
static
const
opus_int32
tiltWeights
[
VAD_N_BANDS
]
=
{
30000
6000
-
12000
-
12000
}
;
opus_int
silk_VAD_GetSA_Q8_sse4_1
(
silk_encoder_state
*
psEncC
const
opus_int16
pIn
[
]
)
{
opus_int
SA_Q15
pSNR_dB_Q7
input_tilt
;
opus_int
decimated_framelength1
decimated_framelength2
;
opus_int
decimated_framelength
;
opus_int
dec_subframe_length
dec_subframe_offset
SNR_Q7
i
b
s
;
opus_int32
sumSquared
smooth_coef_Q16
;
opus_int16
HPstateTmp
;
VARDECL
(
opus_int16
X
)
;
opus_int32
Xnrg
[
VAD_N_BANDS
]
;
opus_int32
NrgToNoiseRatio_Q8
[
VAD_N_BANDS
]
;
opus_int32
speech_nrg
x_tmp
;
opus_int
X_offset
[
VAD_N_BANDS
]
;
opus_int
ret
=
0
;
silk_VAD_state
*
psSilk_VAD
=
&
psEncC
-
>
sVAD
;
SAVE_STACK
;
#
ifdef
OPUS_CHECK_ASM
silk_encoder_state
psEncC_c
;
opus_int
ret_c
;
silk_memcpy
(
&
psEncC_c
psEncC
sizeof
(
psEncC_c
)
)
;
ret_c
=
silk_VAD_GetSA_Q8_c
(
&
psEncC_c
pIn
)
;
#
endif
silk_assert
(
VAD_N_BANDS
=
=
4
)
;
celt_assert
(
MAX_FRAME_LENGTH
>
=
psEncC
-
>
frame_length
)
;
celt_assert
(
psEncC
-
>
frame_length
<
=
512
)
;
celt_assert
(
psEncC
-
>
frame_length
=
=
8
*
silk_RSHIFT
(
psEncC
-
>
frame_length
3
)
)
;
decimated_framelength1
=
silk_RSHIFT
(
psEncC
-
>
frame_length
1
)
;
decimated_framelength2
=
silk_RSHIFT
(
psEncC
-
>
frame_length
2
)
;
decimated_framelength
=
silk_RSHIFT
(
psEncC
-
>
frame_length
3
)
;
X_offset
[
0
]
=
0
;
X_offset
[
1
]
=
decimated_framelength
+
decimated_framelength2
;
X_offset
[
2
]
=
X_offset
[
1
]
+
decimated_framelength
;
X_offset
[
3
]
=
X_offset
[
2
]
+
decimated_framelength2
;
ALLOC
(
X
X_offset
[
3
]
+
decimated_framelength1
opus_int16
)
;
silk_ana_filt_bank_1
(
pIn
&
psSilk_VAD
-
>
AnaState
[
0
]
X
&
X
[
X_offset
[
3
]
]
psEncC
-
>
frame_length
)
;
silk_ana_filt_bank_1
(
X
&
psSilk_VAD
-
>
AnaState1
[
0
]
X
&
X
[
X_offset
[
2
]
]
decimated_framelength1
)
;
silk_ana_filt_bank_1
(
X
&
psSilk_VAD
-
>
AnaState2
[
0
]
X
&
X
[
X_offset
[
1
]
]
decimated_framelength2
)
;
X
[
decimated_framelength
-
1
]
=
silk_RSHIFT
(
X
[
decimated_framelength
-
1
]
1
)
;
HPstateTmp
=
X
[
decimated_framelength
-
1
]
;
for
(
i
=
decimated_framelength
-
1
;
i
>
0
;
i
-
-
)
{
X
[
i
-
1
]
=
silk_RSHIFT
(
X
[
i
-
1
]
1
)
;
X
[
i
]
-
=
X
[
i
-
1
]
;
}
X
[
0
]
-
=
psSilk_VAD
-
>
HPstate
;
psSilk_VAD
-
>
HPstate
=
HPstateTmp
;
for
(
b
=
0
;
b
<
VAD_N_BANDS
;
b
+
+
)
{
decimated_framelength
=
silk_RSHIFT
(
psEncC
-
>
frame_length
silk_min_int
(
VAD_N_BANDS
-
b
VAD_N_BANDS
-
1
)
)
;
dec_subframe_length
=
silk_RSHIFT
(
decimated_framelength
VAD_INTERNAL_SUBFRAMES_LOG2
)
;
dec_subframe_offset
=
0
;
Xnrg
[
b
]
=
psSilk_VAD
-
>
XnrgSubfr
[
b
]
;
for
(
s
=
0
;
s
<
VAD_INTERNAL_SUBFRAMES
;
s
+
+
)
{
__m128i
xmm_X
xmm_acc
;
sumSquared
=
0
;
xmm_acc
=
_mm_setzero_si128
(
)
;
for
(
i
=
0
;
i
<
dec_subframe_length
-
7
;
i
+
=
8
)
{
xmm_X
=
_mm_loadu_si128
(
(
__m128i
*
)
&
(
X
[
X_offset
[
b
]
+
i
+
dec_subframe_offset
]
)
)
;
xmm_X
=
_mm_srai_epi16
(
xmm_X
3
)
;
xmm_X
=
_mm_madd_epi16
(
xmm_X
xmm_X
)
;
xmm_acc
=
_mm_add_epi32
(
xmm_acc
xmm_X
)
;
}
xmm_acc
=
_mm_add_epi32
(
xmm_acc
_mm_unpackhi_epi64
(
xmm_acc
xmm_acc
)
)
;
xmm_acc
=
_mm_add_epi32
(
xmm_acc
_mm_shufflelo_epi16
(
xmm_acc
0x0E
)
)
;
sumSquared
+
=
_mm_cvtsi128_si32
(
xmm_acc
)
;
for
(
;
i
<
dec_subframe_length
;
i
+
+
)
{
x_tmp
=
silk_RSHIFT
(
X
[
X_offset
[
b
]
+
i
+
dec_subframe_offset
]
3
)
;
sumSquared
=
silk_SMLABB
(
sumSquared
x_tmp
x_tmp
)
;
silk_assert
(
sumSquared
>
=
0
)
;
}
if
(
s
<
VAD_INTERNAL_SUBFRAMES
-
1
)
{
Xnrg
[
b
]
=
silk_ADD_POS_SAT32
(
Xnrg
[
b
]
sumSquared
)
;
}
else
{
Xnrg
[
b
]
=
silk_ADD_POS_SAT32
(
Xnrg
[
b
]
silk_RSHIFT
(
sumSquared
1
)
)
;
}
dec_subframe_offset
+
=
dec_subframe_length
;
}
psSilk_VAD
-
>
XnrgSubfr
[
b
]
=
sumSquared
;
}
silk_VAD_GetNoiseLevels
(
&
Xnrg
[
0
]
psSilk_VAD
)
;
sumSquared
=
0
;
input_tilt
=
0
;
for
(
b
=
0
;
b
<
VAD_N_BANDS
;
b
+
+
)
{
speech_nrg
=
Xnrg
[
b
]
-
psSilk_VAD
-
>
NL
[
b
]
;
if
(
speech_nrg
>
0
)
{
if
(
(
Xnrg
[
b
]
&
0xFF800000
)
=
=
0
)
{
NrgToNoiseRatio_Q8
[
b
]
=
silk_DIV32
(
silk_LSHIFT
(
Xnrg
[
b
]
8
)
psSilk_VAD
-
>
NL
[
b
]
+
1
)
;
}
else
{
NrgToNoiseRatio_Q8
[
b
]
=
silk_DIV32
(
Xnrg
[
b
]
silk_RSHIFT
(
psSilk_VAD
-
>
NL
[
b
]
8
)
+
1
)
;
}
SNR_Q7
=
silk_lin2log
(
NrgToNoiseRatio_Q8
[
b
]
)
-
8
*
128
;
sumSquared
=
silk_SMLABB
(
sumSquared
SNR_Q7
SNR_Q7
)
;
if
(
speech_nrg
<
(
(
opus_int32
)
1
<
<
20
)
)
{
SNR_Q7
=
silk_SMULWB
(
silk_LSHIFT
(
silk_SQRT_APPROX
(
speech_nrg
)
6
)
SNR_Q7
)
;
}
input_tilt
=
silk_SMLAWB
(
input_tilt
tiltWeights
[
b
]
SNR_Q7
)
;
}
else
{
NrgToNoiseRatio_Q8
[
b
]
=
256
;
}
}
sumSquared
=
silk_DIV32_16
(
sumSquared
VAD_N_BANDS
)
;
pSNR_dB_Q7
=
(
opus_int16
)
(
3
*
silk_SQRT_APPROX
(
sumSquared
)
)
;
SA_Q15
=
silk_sigm_Q15
(
silk_SMULWB
(
VAD_SNR_FACTOR_Q16
pSNR_dB_Q7
)
-
VAD_NEGATIVE_OFFSET_Q5
)
;
psEncC
-
>
input_tilt_Q15
=
silk_LSHIFT
(
silk_sigm_Q15
(
input_tilt
)
-
16384
1
)
;
speech_nrg
=
0
;
for
(
b
=
0
;
b
<
VAD_N_BANDS
;
b
+
+
)
{
speech_nrg
+
=
(
b
+
1
)
*
silk_RSHIFT
(
Xnrg
[
b
]
-
psSilk_VAD
-
>
NL
[
b
]
4
)
;
}
if
(
psEncC
-
>
frame_length
=
=
20
*
psEncC
-
>
fs_kHz
)
{
speech_nrg
=
silk_RSHIFT32
(
speech_nrg
1
)
;
}
if
(
speech_nrg
<
=
0
)
{
SA_Q15
=
silk_RSHIFT
(
SA_Q15
1
)
;
}
else
if
(
speech_nrg
<
16384
)
{
speech_nrg
=
silk_LSHIFT32
(
speech_nrg
16
)
;
speech_nrg
=
silk_SQRT_APPROX
(
speech_nrg
)
;
SA_Q15
=
silk_SMULWB
(
32768
+
speech_nrg
SA_Q15
)
;
}
psEncC
-
>
speech_activity_Q8
=
silk_min_int
(
silk_RSHIFT
(
SA_Q15
7
)
silk_uint8_MAX
)
;
smooth_coef_Q16
=
silk_SMULWB
(
VAD_SNR_SMOOTH_COEF_Q18
silk_SMULWB
(
(
opus_int32
)
SA_Q15
SA_Q15
)
)
;
if
(
psEncC
-
>
frame_length
=
=
10
*
psEncC
-
>
fs_kHz
)
{
smooth_coef_Q16
>
>
=
1
;
}
for
(
b
=
0
;
b
<
VAD_N_BANDS
;
b
+
+
)
{
psSilk_VAD
-
>
NrgRatioSmth_Q8
[
b
]
=
silk_SMLAWB
(
psSilk_VAD
-
>
NrgRatioSmth_Q8
[
b
]
NrgToNoiseRatio_Q8
[
b
]
-
psSilk_VAD
-
>
NrgRatioSmth_Q8
[
b
]
smooth_coef_Q16
)
;
SNR_Q7
=
3
*
(
silk_lin2log
(
psSilk_VAD
-
>
NrgRatioSmth_Q8
[
b
]
)
-
8
*
128
)
;
psEncC
-
>
input_quality_bands_Q15
[
b
]
=
silk_sigm_Q15
(
silk_RSHIFT
(
SNR_Q7
-
16
*
128
4
)
)
;
}
#
ifdef
OPUS_CHECK_ASM
silk_assert
(
ret
=
=
ret_c
)
;
silk_assert
(
!
memcmp
(
&
psEncC_c
psEncC
sizeof
(
psEncC_c
)
)
)
;
#
endif
RESTORE_STACK
;
return
(
ret
)
;
}
