#
if
RGB_RED
=
=
0
#
define
mmA
mm0
#
define
mmB
mm1
#
elif
RGB_GREEN
=
=
0
#
define
mmA
mm2
#
define
mmB
mm3
#
elif
RGB_BLUE
=
=
0
#
define
mmA
mm4
#
define
mmB
mm5
#
else
#
define
mmA
mm6
#
define
mmB
mm7
#
endif
#
if
RGB_RED
=
=
1
#
define
mmC
mm0
#
define
mmD
mm1
#
elif
RGB_GREEN
=
=
1
#
define
mmC
mm2
#
define
mmD
mm3
#
elif
RGB_BLUE
=
=
1
#
define
mmC
mm4
#
define
mmD
mm5
#
else
#
define
mmC
mm6
#
define
mmD
mm7
#
endif
#
if
RGB_RED
=
=
2
#
define
mmE
mm0
#
define
mmF
mm1
#
elif
RGB_GREEN
=
=
2
#
define
mmE
mm2
#
define
mmF
mm3
#
elif
RGB_BLUE
=
=
2
#
define
mmE
mm4
#
define
mmF
mm5
#
else
#
define
mmE
mm6
#
define
mmF
mm7
#
endif
#
if
RGB_RED
=
=
3
#
define
mmG
mm0
#
define
mmH
mm1
#
elif
RGB_GREEN
=
=
3
#
define
mmG
mm2
#
define
mmH
mm3
#
elif
RGB_BLUE
=
=
3
#
define
mmG
mm4
#
define
mmH
mm5
#
else
#
define
mmG
mm6
#
define
mmH
mm7
#
endif
void
jsimd_ycc_rgb_convert_mmi
(
JDIMENSION
out_width
JSAMPIMAGE
input_buf
JDIMENSION
input_row
JSAMPARRAY
output_buf
int
num_rows
)
{
JSAMPROW
outptr
inptr0
inptr1
inptr2
;
int
num_cols
col
;
__m64
mm0
mm1
mm2
mm3
mm4
mm5
mm6
mm7
;
__m64
mm8
wk
[
2
]
;
while
(
-
-
num_rows
>
=
0
)
{
inptr0
=
input_buf
[
0
]
[
input_row
]
;
inptr1
=
input_buf
[
1
]
[
input_row
]
;
inptr2
=
input_buf
[
2
]
[
input_row
]
;
input_row
+
+
;
outptr
=
*
output_buf
+
+
;
for
(
num_cols
=
out_width
;
num_cols
>
0
;
num_cols
-
=
8
inptr0
+
=
8
inptr1
+
=
8
inptr2
+
=
8
)
{
mm5
=
_mm_load_si64
(
(
__m64
*
)
inptr1
)
;
mm1
=
_mm_load_si64
(
(
__m64
*
)
inptr2
)
;
mm8
=
_mm_load_si64
(
(
__m64
*
)
inptr0
)
;
mm4
=
0
;
mm7
=
0
;
mm4
=
_mm_cmpeq_pi16
(
mm4
mm4
)
;
mm7
=
_mm_cmpeq_pi16
(
mm7
mm7
)
;
mm4
=
_mm_srli_pi16
(
mm4
BYTE_BIT
)
;
mm7
=
_mm_slli_pi16
(
mm7
7
)
;
mm0
=
mm4
;
mm4
=
_mm_and_si64
(
mm4
mm5
)
;
mm5
=
_mm_srli_pi16
(
mm5
BYTE_BIT
)
;
mm0
=
_mm_and_si64
(
mm0
mm1
)
;
mm1
=
_mm_srli_pi16
(
mm1
BYTE_BIT
)
;
mm4
=
_mm_add_pi16
(
mm4
mm7
)
;
mm5
=
_mm_add_pi16
(
mm5
mm7
)
;
mm0
=
_mm_add_pi16
(
mm0
mm7
)
;
mm1
=
_mm_add_pi16
(
mm1
mm7
)
;
mm2
=
mm4
;
mm3
=
mm5
;
mm4
=
_mm_add_pi16
(
mm4
mm4
)
;
mm5
=
_mm_add_pi16
(
mm5
mm5
)
;
mm6
=
mm0
;
mm7
=
mm1
;
mm0
=
_mm_add_pi16
(
mm0
mm0
)
;
mm1
=
_mm_add_pi16
(
mm1
mm1
)
;
mm4
=
_mm_mulhi_pi16
(
mm4
PW_MF0228
)
;
mm5
=
_mm_mulhi_pi16
(
mm5
PW_MF0228
)
;
mm0
=
_mm_mulhi_pi16
(
mm0
PW_F0402
)
;
mm1
=
_mm_mulhi_pi16
(
mm1
PW_F0402
)
;
mm4
=
_mm_add_pi16
(
mm4
PW_ONE
)
;
mm5
=
_mm_add_pi16
(
mm5
PW_ONE
)
;
mm4
=
_mm_srai_pi16
(
mm4
1
)
;
mm5
=
_mm_srai_pi16
(
mm5
1
)
;
mm0
=
_mm_add_pi16
(
mm0
PW_ONE
)
;
mm1
=
_mm_add_pi16
(
mm1
PW_ONE
)
;
mm0
=
_mm_srai_pi16
(
mm0
1
)
;
mm1
=
_mm_srai_pi16
(
mm1
1
)
;
mm4
=
_mm_add_pi16
(
mm4
mm2
)
;
mm5
=
_mm_add_pi16
(
mm5
mm3
)
;
mm4
=
_mm_add_pi16
(
mm4
mm2
)
;
mm5
=
_mm_add_pi16
(
mm5
mm3
)
;
mm0
=
_mm_add_pi16
(
mm0
mm6
)
;
mm1
=
_mm_add_pi16
(
mm1
mm7
)
;
wk
[
0
]
=
mm4
;
wk
[
1
]
=
mm5
;
mm4
=
mm2
;
mm5
=
mm3
;
mm2
=
_mm_unpacklo_pi16
(
mm2
mm6
)
;
mm4
=
_mm_unpackhi_pi16
(
mm4
mm6
)
;
mm2
=
_mm_madd_pi16
(
mm2
PW_MF0344_F0285
)
;
mm4
=
_mm_madd_pi16
(
mm4
PW_MF0344_F0285
)
;
mm3
=
_mm_unpacklo_pi16
(
mm3
mm7
)
;
mm5
=
_mm_unpackhi_pi16
(
mm5
mm7
)
;
mm3
=
_mm_madd_pi16
(
mm3
PW_MF0344_F0285
)
;
mm5
=
_mm_madd_pi16
(
mm5
PW_MF0344_F0285
)
;
mm2
=
_mm_add_pi32
(
mm2
PD_ONEHALF
)
;
mm4
=
_mm_add_pi32
(
mm4
PD_ONEHALF
)
;
mm2
=
_mm_srai_pi32
(
mm2
SCALEBITS
)
;
mm4
=
_mm_srai_pi32
(
mm4
SCALEBITS
)
;
mm3
=
_mm_add_pi32
(
mm3
PD_ONEHALF
)
;
mm5
=
_mm_add_pi32
(
mm5
PD_ONEHALF
)
;
mm3
=
_mm_srai_pi32
(
mm3
SCALEBITS
)
;
mm5
=
_mm_srai_pi32
(
mm5
SCALEBITS
)
;
mm2
=
_mm_packs_pi32
(
mm2
mm4
)
;
mm3
=
_mm_packs_pi32
(
mm3
mm5
)
;
mm2
=
_mm_sub_pi16
(
mm2
mm6
)
;
mm3
=
_mm_sub_pi16
(
mm3
mm7
)
;
mm5
=
mm8
;
mm4
=
_mm_cmpeq_pi16
(
mm4
mm4
)
;
mm4
=
_mm_srli_pi16
(
mm4
BYTE_BIT
)
;
mm4
=
_mm_and_si64
(
mm4
mm5
)
;
mm5
=
_mm_srli_pi16
(
mm5
BYTE_BIT
)
;
mm0
=
_mm_add_pi16
(
mm0
mm4
)
;
mm1
=
_mm_add_pi16
(
mm1
mm5
)
;
mm0
=
_mm_packs_pu16
(
mm0
mm0
)
;
mm1
=
_mm_packs_pu16
(
mm1
mm1
)
;
mm2
=
_mm_add_pi16
(
mm2
mm4
)
;
mm3
=
_mm_add_pi16
(
mm3
mm5
)
;
mm2
=
_mm_packs_pu16
(
mm2
mm2
)
;
mm3
=
_mm_packs_pu16
(
mm3
mm3
)
;
mm4
=
_mm_add_pi16
(
mm4
wk
[
0
]
)
;
mm5
=
_mm_add_pi16
(
mm5
wk
[
1
]
)
;
mm4
=
_mm_packs_pu16
(
mm4
mm4
)
;
mm5
=
_mm_packs_pu16
(
mm5
mm5
)
;
#
if
RGB_PIXELSIZE
=
=
3
mmA
=
_mm_unpacklo_pi8
(
mmA
mmC
)
;
mmE
=
_mm_unpacklo_pi8
(
mmE
mmB
)
;
mmD
=
_mm_unpacklo_pi8
(
mmD
mmF
)
;
mmG
=
mmA
;
mmH
=
mmA
;
mmA
=
_mm_unpacklo_pi16
(
mmA
mmE
)
;
mmG
=
_mm_unpackhi_pi16
(
mmG
mmE
)
;
mmH
=
_mm_srli_si64
(
mmH
2
*
BYTE_BIT
)
;
mmE
=
_mm_srli_si64
(
mmE
2
*
BYTE_BIT
)
;
mmC
=
mmD
;
mmB
=
mmD
;
mmD
=
_mm_unpacklo_pi16
(
mmD
mmH
)
;
mmC
=
_mm_unpackhi_pi16
(
mmC
mmH
)
;
mmB
=
_mm_srli_si64
(
mmB
2
*
BYTE_BIT
)
;
mmF
=
mmE
;
mmE
=
_mm_unpacklo_pi16
(
mmE
mmB
)
;
mmF
=
_mm_unpackhi_pi16
(
mmF
mmB
)
;
mmA
=
_mm_unpacklo_pi32
(
mmA
mmD
)
;
mmE
=
_mm_unpacklo_pi32
(
mmE
mmG
)
;
mmC
=
_mm_unpacklo_pi32
(
mmC
mmF
)
;
if
(
num_cols
>
=
8
)
{
_mm_store_si64
(
(
__m64
*
)
outptr
mmA
)
;
_mm_store_si64
(
(
__m64
*
)
(
outptr
+
8
)
mmE
)
;
_mm_store_si64
(
(
__m64
*
)
(
outptr
+
16
)
mmC
)
;
outptr
+
=
RGB_PIXELSIZE
*
8
;
}
else
{
col
=
num_cols
*
3
;
asm
(
"
.
set
noreorder
\
r
\
n
"
"
li
8
16
\
r
\
n
"
"
move
9
%
4
\
r
\
n
"
"
mov
.
s
f4
%
1
\
r
\
n
"
"
mov
.
s
f6
%
3
\
r
\
n
"
"
move
10
%
5
\
r
\
n
"
"
bltu
9
8
1f
\
r
\
n
"
"
nop
\
r
\
n
"
"
gssdlc1
f4
7
(
10
)
\
r
\
n
"
"
gssdrc1
f4
0
(
10
)
\
r
\
n
"
"
gssdlc1
f6
7
+
8
(
10
)
\
r
\
n
"
"
gssdrc1
f6
8
(
10
)
\
r
\
n
"
"
mov
.
s
f4
%
2
\
r
\
n
"
"
subu
9
9
16
\
r
\
n
"
"
daddu
10
10
16
\
r
\
n
"
"
b
2f
\
r
\
n
"
"
nop
\
r
\
n
"
"
1
:
\
r
\
n
"
"
li
8
8
\
r
\
n
"
"
bltu
9
8
2f
\
r
\
n
"
"
nop
\
r
\
n
"
"
gssdlc1
f4
7
(
10
)
\
r
\
n
"
"
gssdrc1
f4
(
10
)
\
r
\
n
"
"
mov
.
s
f4
%
3
\
r
\
n
"
"
subu
9
9
8
\
r
\
n
"
"
daddu
10
10
8
\
r
\
n
"
"
2
:
\
r
\
n
"
"
li
8
4
\
r
\
n
"
"
mfc1
11
f4
\
r
\
n
"
"
bltu
9
8
3f
\
r
\
n
"
"
nop
\
r
\
n
"
"
swl
11
3
(
10
)
\
r
\
n
"
"
swr
11
0
(
10
)
\
r
\
n
"
"
li
8
32
\
r
\
n
"
"
mtc1
8
f6
\
r
\
n
"
"
dsrl
f4
f4
f6
\
r
\
n
"
"
mfc1
11
f4
\
r
\
n
"
"
subu
9
9
4
\
r
\
n
"
"
daddu
10
10
4
\
r
\
n
"
"
3
:
\
r
\
n
"
"
li
8
2
\
r
\
n
"
"
bltu
9
8
4f
\
r
\
n
"
"
nop
\
r
\
n
"
"
ush
11
0
(
10
)
\
r
\
n
"
"
srl
11
16
\
r
\
n
"
"
subu
9
9
2
\
r
\
n
"
"
daddu
10
10
2
\
r
\
n
"
"
4
:
\
r
\
n
"
"
li
8
1
\
r
\
n
"
"
bltu
9
8
5f
\
r
\
n
"
"
nop
\
r
\
n
"
"
sb
11
0
(
10
)
\
r
\
n
"
"
5
:
\
r
\
n
"
"
nop
\
r
\
n
"
:
"
=
m
"
(
*
outptr
)
:
"
f
"
(
mmA
)
"
f
"
(
mmC
)
"
f
"
(
mmE
)
"
r
"
(
col
)
"
r
"
(
outptr
)
:
"
f4
"
"
f6
"
"
8
"
"
9
"
"
10
"
"
11
"
"
memory
"
)
;
}
#
else
#
ifdef
RGBX_FILLER_0XFF
mm6
=
_mm_cmpeq_pi8
(
mm6
mm6
)
;
mm7
=
_mm_cmpeq_pi8
(
mm7
mm7
)
;
#
else
mm6
=
_mm_xor_si64
(
mm6
mm6
)
;
mm7
=
_mm_xor_si64
(
mm7
mm7
)
;
#
endif
mmA
=
_mm_unpacklo_pi8
(
mmA
mmC
)
;
mmE
=
_mm_unpacklo_pi8
(
mmE
mmG
)
;
mmB
=
_mm_unpacklo_pi8
(
mmB
mmD
)
;
mmF
=
_mm_unpacklo_pi8
(
mmF
mmH
)
;
mmC
=
mmA
;
mmA
=
_mm_unpacklo_pi16
(
mmA
mmE
)
;
mmC
=
_mm_unpackhi_pi16
(
mmC
mmE
)
;
mmG
=
mmB
;
mmB
=
_mm_unpacklo_pi16
(
mmB
mmF
)
;
mmG
=
_mm_unpackhi_pi16
(
mmG
mmF
)
;
mmD
=
mmA
;
mmA
=
_mm_unpacklo_pi32
(
mmA
mmB
)
;
mmD
=
_mm_unpackhi_pi32
(
mmD
mmB
)
;
mmH
=
mmC
;
mmC
=
_mm_unpacklo_pi32
(
mmC
mmG
)
;
mmH
=
_mm_unpackhi_pi32
(
mmH
mmG
)
;
if
(
num_cols
>
=
8
)
{
_mm_store_si64
(
(
__m64
*
)
outptr
mmA
)
;
_mm_store_si64
(
(
__m64
*
)
(
outptr
+
8
)
mmD
)
;
_mm_store_si64
(
(
__m64
*
)
(
outptr
+
16
)
mmC
)
;
_mm_store_si64
(
(
__m64
*
)
(
outptr
+
24
)
mmH
)
;
outptr
+
=
RGB_PIXELSIZE
*
8
;
}
else
{
col
=
num_cols
;
asm
(
"
.
set
noreorder
\
r
\
n
"
"
li
8
4
\
r
\
n
"
"
move
9
%
6
\
r
\
n
"
"
move
10
%
7
\
r
\
n
"
"
mov
.
s
f4
%
2
\
r
\
n
"
"
mov
.
s
f6
%
4
\
r
\
n
"
"
bltu
9
8
1f
\
r
\
n
"
"
nop
\
r
\
n
"
"
gssdlc1
f4
7
(
10
)
\
r
\
n
"
"
gssdrc1
f4
(
10
)
\
r
\
n
"
"
gssdlc1
f6
7
+
8
(
10
)
\
r
\
n
"
"
gssdrc1
f6
8
(
10
)
\
r
\
n
"
"
mov
.
s
f4
%
3
\
r
\
n
"
"
mov
.
s
f6
%
5
\
r
\
n
"
"
subu
9
9
4
\
r
\
n
"
"
daddu
10
10
16
\
r
\
n
"
"
1
:
\
r
\
n
"
"
li
8
2
\
r
\
n
"
"
bltu
9
8
2f
\
r
\
n
"
"
nop
\
r
\
n
"
"
gssdlc1
f4
7
(
10
)
\
r
\
n
"
"
gssdrc1
f4
0
(
10
)
\
r
\
n
"
"
mov
.
s
f4
f6
\
r
\
n
"
"
subu
9
9
2
\
r
\
n
"
"
daddu
10
10
8
\
r
\
n
"
"
2
:
\
r
\
n
"
"
li
8
1
\
r
\
n
"
"
bltu
9
8
3f
\
r
\
n
"
"
nop
\
r
\
n
"
"
gsswlc1
f4
3
(
10
)
\
r
\
n
"
"
gsswrc1
f4
0
(
10
)
\
r
\
n
"
"
3
:
\
r
\
n
"
"
li
%
1
0
\
r
\
n
"
:
"
=
m
"
(
*
outptr
)
"
=
r
"
(
col
)
:
"
f
"
(
mmA
)
"
f
"
(
mmC
)
"
f
"
(
mmD
)
"
f
"
(
mmH
)
"
r
"
(
col
)
"
r
"
(
outptr
)
:
"
f4
"
"
f6
"
"
8
"
"
9
"
"
10
"
"
memory
"
)
;
}
#
endif
}
}
}
#
undef
mmA
#
undef
mmB
#
undef
mmC
#
undef
mmD
#
undef
mmE
#
undef
mmF
#
undef
mmG
#
undef
mmH
