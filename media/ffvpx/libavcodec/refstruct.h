#
ifndef
AVCODEC_REFSTRUCT_H
#
define
AVCODEC_REFSTRUCT_H
#
include
<
stddef
.
h
>
typedef
union
{
void
*
nc
;
const
void
*
c
;
}
FFRefStructOpaque
;
#
define
FF_REFSTRUCT_FLAG_NO_ZEROING
(
1
<
<
0
)
void
*
ff_refstruct_alloc_ext_c
(
size_t
size
unsigned
flags
FFRefStructOpaque
opaque
void
(
*
free_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
)
;
static
inline
void
*
ff_refstruct_alloc_ext
(
size_t
size
unsigned
flags
void
*
opaque
void
(
*
free_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
)
{
return
ff_refstruct_alloc_ext_c
(
size
flags
(
FFRefStructOpaque
)
{
.
nc
=
opaque
}
free_cb
)
;
}
static
inline
void
*
ff_refstruct_allocz
(
size_t
size
)
{
return
ff_refstruct_alloc_ext
(
size
0
NULL
NULL
)
;
}
void
ff_refstruct_unref
(
void
*
objp
)
;
void
*
ff_refstruct_ref
(
void
*
obj
)
;
const
void
*
ff_refstruct_ref_c
(
const
void
*
obj
)
;
void
ff_refstruct_replace
(
void
*
dstp
const
void
*
src
)
;
int
ff_refstruct_exclusive
(
const
void
*
obj
)
;
typedef
struct
FFRefStructPool
FFRefStructPool
;
#
define
FF_REFSTRUCT_POOL_FLAG_NO_ZEROING
FF_REFSTRUCT_FLAG_NO_ZEROING
#
define
FF_REFSTRUCT_POOL_FLAG_RESET_ON_INIT_ERROR
(
1
<
<
16
)
#
define
FF_REFSTRUCT_POOL_FLAG_FREE_ON_INIT_ERROR
(
1
<
<
17
)
#
define
FF_REFSTRUCT_POOL_FLAG_ZERO_EVERY_TIME
(
1
<
<
18
)
FFRefStructPool
*
ff_refstruct_pool_alloc
(
size_t
size
unsigned
flags
)
;
FFRefStructPool
*
ff_refstruct_pool_alloc_ext_c
(
size_t
size
unsigned
flags
FFRefStructOpaque
opaque
int
(
*
init_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
void
(
*
reset_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
void
(
*
free_entry_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
void
(
*
free_cb
)
(
FFRefStructOpaque
opaque
)
)
;
static
inline
FFRefStructPool
*
ff_refstruct_pool_alloc_ext
(
size_t
size
unsigned
flags
void
*
opaque
int
(
*
init_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
void
(
*
reset_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
void
(
*
free_entry_cb
)
(
FFRefStructOpaque
opaque
void
*
obj
)
void
(
*
free_cb
)
(
FFRefStructOpaque
opaque
)
)
{
return
ff_refstruct_pool_alloc_ext_c
(
size
flags
(
FFRefStructOpaque
)
{
.
nc
=
opaque
}
init_cb
reset_cb
free_entry_cb
free_cb
)
;
}
void
*
ff_refstruct_pool_get
(
FFRefStructPool
*
pool
)
;
static
inline
void
ff_refstruct_pool_uninit
(
FFRefStructPool
*
*
poolp
)
{
ff_refstruct_unref
(
poolp
)
;
}
#
endif
