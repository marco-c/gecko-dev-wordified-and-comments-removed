#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
"
libavutil
/
mem
.
h
"
#
include
"
atsc_a53
.
h
"
#
include
"
get_bits
.
h
"
int
ff_alloc_a53_sei
(
const
AVFrame
*
frame
size_t
prefix_len
void
*
*
data
size_t
*
sei_size
)
{
AVFrameSideData
*
side_data
=
NULL
;
uint8_t
*
sei_data
;
if
(
frame
)
side_data
=
av_frame_get_side_data
(
frame
AV_FRAME_DATA_A53_CC
)
;
if
(
!
side_data
)
{
*
data
=
NULL
;
return
0
;
}
*
sei_size
=
side_data
-
>
size
+
11
;
*
data
=
av_mallocz
(
*
sei_size
+
prefix_len
)
;
if
(
!
*
data
)
return
AVERROR
(
ENOMEM
)
;
sei_data
=
(
uint8_t
*
)
*
data
+
prefix_len
;
sei_data
[
0
]
=
181
;
sei_data
[
1
]
=
0
;
sei_data
[
2
]
=
49
;
AV_WL32
(
sei_data
+
3
MKTAG
(
'
G
'
'
A
'
'
9
'
'
4
'
)
)
;
sei_data
[
7
]
=
3
;
sei_data
[
8
]
=
(
(
side_data
-
>
size
/
3
)
&
0x1f
)
|
0x40
;
sei_data
[
9
]
=
0
;
memcpy
(
sei_data
+
10
side_data
-
>
data
side_data
-
>
size
)
;
sei_data
[
side_data
-
>
size
+
10
]
=
255
;
return
0
;
}
int
ff_parse_a53_cc
(
AVBufferRef
*
*
pbuf
const
uint8_t
*
data
int
size
)
{
AVBufferRef
*
buf
=
*
pbuf
;
GetBitContext
gb
;
size_t
new_size
old_size
=
buf
?
buf
-
>
size
:
0
;
int
ret
cc_count
;
if
(
size
<
3
)
return
AVERROR_INVALIDDATA
;
ret
=
init_get_bits8
(
&
gb
data
size
)
;
if
(
ret
<
0
)
return
ret
;
if
(
get_bits
(
&
gb
8
)
!
=
0x3
)
return
0
;
skip_bits
(
&
gb
1
)
;
if
(
!
get_bits
(
&
gb
1
)
)
return
0
;
skip_bits
(
&
gb
1
)
;
cc_count
=
get_bits
(
&
gb
5
)
;
if
(
!
cc_count
)
return
0
;
skip_bits
(
&
gb
8
)
;
if
(
cc_count
*
3
>
=
(
get_bits_left
(
&
gb
)
>
>
3
)
)
return
AVERROR_INVALIDDATA
;
new_size
=
(
old_size
+
cc_count
*
3
)
;
if
(
new_size
>
INT_MAX
)
return
AVERROR_INVALIDDATA
;
ret
=
av_buffer_realloc
(
pbuf
new_size
)
;
if
(
ret
<
0
)
return
ret
;
buf
=
*
pbuf
;
for
(
int
i
=
0
;
i
<
cc_count
;
i
+
+
)
{
buf
-
>
data
[
old_size
+
+
]
=
get_bits
(
&
gb
8
)
;
buf
-
>
data
[
old_size
+
+
]
=
get_bits
(
&
gb
8
)
;
buf
-
>
data
[
old_size
+
+
]
=
get_bits
(
&
gb
8
)
;
}
return
cc_count
;
}
