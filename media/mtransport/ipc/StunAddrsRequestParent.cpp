#
include
"
StunAddrsRequestParent
.
h
"
#
include
"
.
.
/
runnable_utils
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
mtransport
/
nricectx
.
h
"
#
include
"
mtransport
/
nricemediastream
.
h
"
#
include
"
mtransport
/
nricestunaddr
.
h
"
using
namespace
mozilla
:
:
ipc
;
namespace
mozilla
{
namespace
net
{
StunAddrsRequestParent
:
:
StunAddrsRequestParent
(
)
:
mIPCClosed
(
false
)
{
NS_GetMainThread
(
getter_AddRefs
(
mMainThread
)
)
;
nsresult
res
;
mSTSThread
=
do_GetService
(
NS_SOCKETTRANSPORTSERVICE_CONTRACTID
&
res
)
;
MOZ_ASSERT
(
mSTSThread
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
StunAddrsRequestParent
:
:
RecvGetStunAddrs
(
)
{
ASSERT_ON_THREAD
(
mMainThread
)
;
if
(
mIPCClosed
)
{
return
IPC_OK
(
)
;
}
RUN_ON_THREAD
(
mSTSThread
WrapRunnable
(
RefPtr
<
StunAddrsRequestParent
>
(
this
)
&
StunAddrsRequestParent
:
:
GetStunAddrs_s
)
NS_DISPATCH_NORMAL
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
StunAddrsRequestParent
:
:
Recv__delete__
(
)
{
mIPCClosed
=
true
;
return
IPC_OK
(
)
;
}
void
StunAddrsRequestParent
:
:
ActorDestroy
(
ActorDestroyReason
why
)
{
mIPCClosed
=
true
;
}
void
StunAddrsRequestParent
:
:
GetStunAddrs_s
(
)
{
ASSERT_ON_THREAD
(
mSTSThread
)
;
NrIceStunAddrArray
addrs
=
NrIceCtx
:
:
GetStunAddrs
(
)
;
if
(
mIPCClosed
)
{
return
;
}
RUN_ON_THREAD
(
mMainThread
WrapRunnable
(
RefPtr
<
StunAddrsRequestParent
>
(
this
)
&
StunAddrsRequestParent
:
:
SendStunAddrs_m
std
:
:
move
(
addrs
)
)
NS_DISPATCH_NORMAL
)
;
}
void
StunAddrsRequestParent
:
:
SendStunAddrs_m
(
const
NrIceStunAddrArray
&
addrs
)
{
ASSERT_ON_THREAD
(
mMainThread
)
;
if
(
mIPCClosed
)
{
return
;
}
mIPCClosed
=
true
;
Unused
<
<
SendOnStunAddrsAvailable
(
addrs
)
;
}
NS_IMPL_ADDREF
(
StunAddrsRequestParent
)
NS_IMPL_RELEASE
(
StunAddrsRequestParent
)
}
}
