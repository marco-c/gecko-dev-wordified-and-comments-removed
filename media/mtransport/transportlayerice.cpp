#
include
<
string
>
#
include
<
vector
>
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsIEventTarget
.
h
"
#
include
"
nsNetCID
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
extern
"
C
"
{
#
include
"
nr_api
.
h
"
#
include
"
registry
.
h
"
#
include
"
async_timer
.
h
"
#
include
"
ice_util
.
h
"
#
include
"
transport_addr
.
h
"
#
include
"
nr_crypto
.
h
"
#
include
"
nr_socket
.
h
"
#
include
"
nr_socket_local
.
h
"
#
include
"
stun_client_ctx
.
h
"
#
include
"
stun_server_ctx
.
h
"
#
include
"
ice_ctx
.
h
"
#
include
"
ice_candidate
.
h
"
#
include
"
ice_handler
.
h
"
}
#
include
"
logging
.
h
"
#
include
"
nricectx
.
h
"
#
include
"
nricemediastream
.
h
"
#
include
"
transportflow
.
h
"
#
include
"
transportlayerice
.
h
"
namespace
mozilla
{
#
ifdef
ERROR
#
undef
ERROR
#
endif
MOZ_MTLOG_MODULE
(
"
mtransport
"
)
TransportLayerIce
:
:
TransportLayerIce
(
)
:
stream_
(
nullptr
)
component_
(
0
)
old_stream_
(
nullptr
)
{
}
TransportLayerIce
:
:
~
TransportLayerIce
(
)
{
}
void
TransportLayerIce
:
:
SetParameters
(
RefPtr
<
NrIceMediaStream
>
stream
int
component
)
{
if
(
!
stream
)
{
MOZ_ASSERT
(
false
)
;
return
;
}
if
(
stream_
&
&
!
old_stream_
&
&
(
stream_
!
=
stream
)
)
{
old_stream_
=
stream_
;
MOZ_MTLOG
(
ML_INFO
LAYER_INFO
<
<
"
SetParameters
save
old
stream
(
"
<
<
old_stream_
-
>
name
(
)
<
<
"
)
"
)
;
}
stream_
=
stream
;
component_
=
component
;
PostSetup
(
)
;
}
void
TransportLayerIce
:
:
PostSetup
(
)
{
stream_
-
>
SignalReady
.
connect
(
this
&
TransportLayerIce
:
:
IceReady
)
;
stream_
-
>
SignalFailed
.
connect
(
this
&
TransportLayerIce
:
:
IceFailed
)
;
stream_
-
>
SignalPacketReceived
.
connect
(
this
&
TransportLayerIce
:
:
IcePacketReceived
)
;
if
(
stream_
-
>
state
(
)
=
=
NrIceMediaStream
:
:
ICE_OPEN
)
{
TL_SET_STATE
(
TS_OPEN
)
;
}
}
void
TransportLayerIce
:
:
ResetOldStream
(
)
{
if
(
old_stream_
=
=
nullptr
)
{
return
;
}
MOZ_MTLOG
(
ML_INFO
LAYER_INFO
<
<
"
ResetOldStream
(
"
<
<
old_stream_
-
>
name
(
)
<
<
"
)
"
)
;
old_stream_
-
>
SignalReady
.
disconnect
(
this
)
;
old_stream_
-
>
SignalFailed
.
disconnect
(
this
)
;
old_stream_
-
>
SignalPacketReceived
.
disconnect
(
this
)
;
old_stream_
=
nullptr
;
}
void
TransportLayerIce
:
:
RestoreOldStream
(
)
{
if
(
old_stream_
=
=
nullptr
)
{
return
;
}
MOZ_MTLOG
(
ML_INFO
LAYER_INFO
<
<
"
RestoreOldStream
(
"
<
<
old_stream_
-
>
name
(
)
<
<
"
)
"
)
;
stream_
-
>
SignalReady
.
disconnect
(
this
)
;
stream_
-
>
SignalFailed
.
disconnect
(
this
)
;
stream_
-
>
SignalPacketReceived
.
disconnect
(
this
)
;
stream_
=
old_stream_
;
old_stream_
=
nullptr
;
if
(
stream_
-
>
state
(
)
=
=
NrIceMediaStream
:
:
ICE_OPEN
)
{
IceReady
(
stream_
)
;
}
else
if
(
stream_
-
>
state
(
)
=
=
NrIceMediaStream
:
:
ICE_CLOSED
)
{
IceFailed
(
stream_
)
;
}
}
TransportResult
TransportLayerIce
:
:
SendPacket
(
MediaPacket
&
packet
)
{
CheckThread
(
)
;
nsresult
res
=
(
old_stream_
?
old_stream_
:
stream_
)
-
>
SendPacket
(
component_
packet
.
data
(
)
packet
.
len
(
)
)
;
if
(
!
NS_SUCCEEDED
(
res
)
)
{
return
(
res
=
=
NS_BASE_STREAM_WOULD_BLOCK
)
?
TE_WOULDBLOCK
:
TE_ERROR
;
}
MOZ_MTLOG
(
ML_DEBUG
LAYER_INFO
<
<
"
SendPacket
(
"
<
<
packet
.
len
(
)
<
<
"
)
succeeded
"
)
;
return
packet
.
len
(
)
;
}
void
TransportLayerIce
:
:
IceCandidate
(
NrIceMediaStream
*
stream
const
std
:
:
string
&
)
{
}
void
TransportLayerIce
:
:
IceReady
(
NrIceMediaStream
*
stream
)
{
CheckThread
(
)
;
if
(
stream
!
=
stream_
)
{
return
;
}
MOZ_MTLOG
(
ML_INFO
LAYER_INFO
<
<
"
ICE
Ready
(
"
<
<
stream
-
>
name
(
)
<
<
"
"
<
<
component_
<
<
"
)
"
)
;
TL_SET_STATE
(
TS_OPEN
)
;
}
void
TransportLayerIce
:
:
IceFailed
(
NrIceMediaStream
*
stream
)
{
CheckThread
(
)
;
if
(
stream
!
=
stream_
)
{
return
;
}
MOZ_MTLOG
(
ML_INFO
LAYER_INFO
<
<
"
ICE
Failed
(
"
<
<
stream
-
>
name
(
)
<
<
"
"
<
<
component_
<
<
"
)
"
)
;
TL_SET_STATE
(
TS_ERROR
)
;
}
void
TransportLayerIce
:
:
IcePacketReceived
(
NrIceMediaStream
*
stream
int
component
const
unsigned
char
*
data
int
len
)
{
CheckThread
(
)
;
if
(
component_
!
=
component
)
return
;
MOZ_MTLOG
(
ML_DEBUG
LAYER_INFO
<
<
"
PacketReceived
(
"
<
<
stream
-
>
name
(
)
<
<
"
"
<
<
component
<
<
"
"
<
<
len
<
<
"
)
"
)
;
MediaPacket
packet
;
packet
.
Copy
(
data
len
)
;
SignalPacketReceived
(
this
packet
)
;
}
}
