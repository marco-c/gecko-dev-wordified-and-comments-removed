#
include
<
cassert
>
#
include
"
cubeb
-
internal
.
h
"
#
include
"
cubeb_mixer
.
h
"
cubeb_layout_map
const
CUBEB_CHANNEL_LAYOUT_MAPS
[
CUBEB_LAYOUT_MAX
]
=
{
{
"
undefined
"
0
CUBEB_LAYOUT_UNDEFINED
}
{
"
dual
mono
"
2
CUBEB_LAYOUT_DUAL_MONO
}
{
"
dual
mono
lfe
"
3
CUBEB_LAYOUT_DUAL_MONO_LFE
}
{
"
mono
"
1
CUBEB_LAYOUT_MONO
}
{
"
mono
lfe
"
2
CUBEB_LAYOUT_MONO_LFE
}
{
"
stereo
"
2
CUBEB_LAYOUT_STEREO
}
{
"
stereo
lfe
"
3
CUBEB_LAYOUT_STEREO_LFE
}
{
"
3f
"
3
CUBEB_LAYOUT_3F
}
{
"
3f
lfe
"
4
CUBEB_LAYOUT_3F_LFE
}
{
"
2f1
"
3
CUBEB_LAYOUT_2F1
}
{
"
2f1
lfe
"
4
CUBEB_LAYOUT_2F1_LFE
}
{
"
3f1
"
4
CUBEB_LAYOUT_3F1
}
{
"
3f1
lfe
"
5
CUBEB_LAYOUT_3F1_LFE
}
{
"
2f2
"
4
CUBEB_LAYOUT_2F2
}
{
"
2f2
lfe
"
5
CUBEB_LAYOUT_2F2_LFE
}
{
"
3f2
"
5
CUBEB_LAYOUT_3F2
}
{
"
3f2
lfe
"
6
CUBEB_LAYOUT_3F2_LFE
}
{
"
3f3r
lfe
"
7
CUBEB_LAYOUT_3F3R_LFE
}
{
"
3f4
lfe
"
8
CUBEB_LAYOUT_3F4_LFE
}
}
;
static
int
const
CHANNEL_ORDER_TO_INDEX
[
CUBEB_LAYOUT_MAX
]
[
CHANNEL_MAX
]
=
{
{
-
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
}
{
-
1
0
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
}
{
-
1
0
1
-
1
-
1
-
1
-
1
-
1
-
1
2
}
{
0
-
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
}
{
0
-
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
1
}
{
-
1
0
1
-
1
-
1
-
1
-
1
-
1
-
1
-
1
}
{
-
1
0
1
-
1
-
1
-
1
-
1
-
1
-
1
2
}
{
-
1
0
1
2
-
1
-
1
-
1
-
1
-
1
-
1
}
{
-
1
0
1
2
-
1
-
1
-
1
-
1
-
1
3
}
{
-
1
0
1
-
1
-
1
-
1
-
1
2
-
1
-
1
}
{
-
1
0
1
-
1
-
1
-
1
-
1
3
-
1
2
}
{
-
1
0
1
2
-
1
-
1
-
1
3
-
1
-
1
}
{
-
1
0
1
2
-
1
-
1
-
1
4
-
1
3
}
{
-
1
0
1
-
1
2
3
-
1
-
1
-
1
-
1
}
{
-
1
0
1
-
1
3
4
-
1
-
1
-
1
2
}
{
-
1
0
1
2
3
4
-
1
-
1
-
1
-
1
}
{
-
1
0
1
2
4
5
-
1
-
1
-
1
3
}
{
-
1
0
1
2
5
6
-
1
4
-
1
3
}
{
-
1
0
1
2
6
7
4
-
1
5
3
}
}
;
unsigned
int
const
SUPPORTED_LAYOUT_NUM
=
12
;
unsigned
int
const
INPUT_CHANNEL_NUM
=
6
;
unsigned
int
const
MAX_OUTPUT_CHANNEL_NUM
=
5
;
float
const
INV_SQRT_2
=
0
.
707106f
;
static
float
const
DOWNMIX_MATRIX_3F2_LFE
[
SUPPORTED_LAYOUT_NUM
]
[
MAX_OUTPUT_CHANNEL_NUM
]
[
INPUT_CHANNEL_NUM
]
=
{
{
{
INV_SQRT_2
INV_SQRT_2
1
0
0
.
5
0
.
5
}
}
{
{
INV_SQRT_2
INV_SQRT_2
1
0
0
.
5
0
.
5
}
{
0
0
0
1
0
0
}
}
{
{
1
0
INV_SQRT_2
0
INV_SQRT_2
0
}
{
0
1
INV_SQRT_2
0
0
INV_SQRT_2
}
}
{
{
1
0
INV_SQRT_2
0
INV_SQRT_2
0
}
{
0
1
INV_SQRT_2
0
0
INV_SQRT_2
}
{
0
0
0
1
0
0
}
}
{
{
1
0
0
0
INV_SQRT_2
0
}
{
0
1
0
0
0
INV_SQRT_2
}
{
0
0
1
0
0
0
}
}
{
{
1
0
0
0
INV_SQRT_2
0
}
{
0
1
0
0
0
INV_SQRT_2
}
{
0
0
1
0
0
0
}
{
0
0
0
1
0
0
}
}
{
{
1
0
INV_SQRT_2
0
0
0
}
{
0
1
INV_SQRT_2
0
0
0
}
{
0
0
0
0
INV_SQRT_2
INV_SQRT_2
}
}
{
{
1
0
INV_SQRT_2
0
0
0
}
{
0
1
INV_SQRT_2
0
0
0
}
{
0
0
0
1
0
0
}
{
0
0
0
0
INV_SQRT_2
INV_SQRT_2
}
}
{
{
1
0
0
0
0
0
}
{
0
1
0
0
0
0
}
{
0
0
1
0
0
0
}
{
0
0
0
0
INV_SQRT_2
INV_SQRT_2
}
}
{
{
1
0
0
0
0
0
}
{
0
1
0
0
0
0
}
{
0
0
1
0
0
0
}
{
0
0
0
1
0
0
}
{
0
0
0
0
INV_SQRT_2
INV_SQRT_2
}
}
{
{
1
0
INV_SQRT_2
0
0
0
}
{
0
1
INV_SQRT_2
0
0
0
}
{
0
0
0
0
1
0
}
{
0
0
0
0
0
1
}
}
{
{
1
0
INV_SQRT_2
0
0
0
}
{
0
1
INV_SQRT_2
0
0
0
}
{
0
0
0
1
0
0
}
{
0
0
0
0
1
0
}
{
0
0
0
0
0
1
}
}
}
;
template
<
typename
T
>
bool
downmix_3f2
(
T
const
*
const
in
unsigned
long
inframes
T
*
out
cubeb_channel_layout
in_layout
cubeb_channel_layout
out_layout
)
{
if
(
(
in_layout
!
=
CUBEB_LAYOUT_3F2
&
&
in_layout
!
=
CUBEB_LAYOUT_3F2_LFE
)
|
|
out_layout
<
CUBEB_LAYOUT_MONO
|
|
out_layout
>
CUBEB_LAYOUT_2F2_LFE
)
{
return
false
;
}
unsigned
int
in_channels
=
CUBEB_CHANNEL_LAYOUT_MAPS
[
in_layout
]
.
channels
;
unsigned
int
out_channels
=
CUBEB_CHANNEL_LAYOUT_MAPS
[
out_layout
]
.
channels
;
assert
(
out_channels
<
=
in_channels
)
;
long
out_index
=
0
;
auto
&
downmix_matrix
=
DOWNMIX_MATRIX_3F2_LFE
[
out_layout
-
CUBEB_LAYOUT_MONO
]
;
for
(
unsigned
long
i
=
0
;
i
<
inframes
*
in_channels
;
i
+
=
in_channels
)
{
for
(
unsigned
int
j
=
0
;
j
<
out_channels
;
+
+
j
)
{
out
[
out_index
+
j
]
=
0
;
for
(
unsigned
int
k
=
0
;
k
<
INPUT_CHANNEL_NUM
;
+
+
k
)
{
T
data
=
(
in_layout
=
=
CUBEB_LAYOUT_3F2_LFE
)
?
in
[
i
+
k
]
:
(
k
=
=
3
)
?
0
:
in
[
i
+
(
(
k
<
3
)
?
k
:
k
-
1
)
]
;
out
[
out_index
+
j
]
+
=
downmix_matrix
[
j
]
[
k
]
*
data
;
}
}
out_index
+
=
out_channels
;
}
return
true
;
}
template
<
class
T
>
bool
mix_remap
(
T
const
*
const
in
unsigned
long
inframes
T
*
out
cubeb_channel_layout
in_layout
cubeb_channel_layout
out_layout
)
{
assert
(
in_layout
!
=
out_layout
)
;
unsigned
int
in_channels
=
CUBEB_CHANNEL_LAYOUT_MAPS
[
in_layout
]
.
channels
;
unsigned
int
out_channels
=
CUBEB_CHANNEL_LAYOUT_MAPS
[
out_layout
]
.
channels
;
uint32_t
in_layout_mask
=
0
;
for
(
unsigned
int
i
=
0
;
i
<
in_channels
;
+
+
i
)
{
in_layout_mask
|
=
1
<
<
CHANNEL_INDEX_TO_ORDER
[
in_layout
]
[
i
]
;
}
uint32_t
out_layout_mask
=
0
;
for
(
unsigned
int
i
=
0
;
i
<
out_channels
;
+
+
i
)
{
out_layout_mask
|
=
1
<
<
CHANNEL_INDEX_TO_ORDER
[
out_layout
]
[
i
]
;
}
if
(
!
(
out_layout_mask
&
in_layout_mask
)
)
{
return
false
;
}
long
out_index
=
0
;
for
(
unsigned
long
i
=
0
;
i
<
inframes
*
in_channels
;
i
+
=
in_channels
)
{
for
(
unsigned
int
j
=
0
;
j
<
out_channels
;
+
+
j
)
{
cubeb_channel
channel
=
CHANNEL_INDEX_TO_ORDER
[
out_layout
]
[
j
]
;
uint32_t
channel_mask
=
1
<
<
channel
;
int
channel_index
=
CHANNEL_ORDER_TO_INDEX
[
in_layout
]
[
channel
]
;
if
(
in_layout_mask
&
channel_mask
)
{
assert
(
channel_index
!
=
-
1
)
;
out
[
out_index
+
j
]
=
in
[
i
+
channel_index
]
;
}
else
{
assert
(
channel_index
=
=
-
1
)
;
out
[
out_index
+
j
]
=
0
;
}
}
out_index
+
=
out_channels
;
}
return
true
;
}
template
<
typename
T
>
void
downmix_fallback
(
T
const
*
const
in
unsigned
long
inframes
T
*
out
unsigned
int
in_channels
unsigned
int
out_channels
)
{
assert
(
in_channels
>
=
out_channels
)
;
long
out_index
=
0
;
for
(
unsigned
long
i
=
0
;
i
<
inframes
*
in_channels
;
i
+
=
in_channels
)
{
for
(
unsigned
int
j
=
0
;
j
<
out_channels
;
+
+
j
)
{
out
[
out_index
+
j
]
=
in
[
i
+
j
]
;
}
out_index
+
=
out_channels
;
}
}
template
<
typename
T
>
void
cubeb_downmix
(
T
const
*
const
in
long
inframes
T
*
out
unsigned
int
in_channels
unsigned
int
out_channels
cubeb_channel_layout
in_layout
cubeb_channel_layout
out_layout
)
{
assert
(
in_channels
>
=
out_channels
&
&
in_layout
!
=
CUBEB_LAYOUT_UNDEFINED
)
;
if
(
out_channels
=
=
CUBEB_CHANNEL_LAYOUT_MAPS
[
out_layout
]
.
channels
&
&
in_channels
=
=
CUBEB_CHANNEL_LAYOUT_MAPS
[
in_layout
]
.
channels
)
{
if
(
downmix_3f2
(
in
inframes
out
in_layout
out_layout
)
)
{
return
;
}
if
(
mix_remap
(
in
inframes
out
in_layout
out_layout
)
)
{
return
;
}
}
downmix_fallback
(
in
inframes
out
in_channels
out_channels
)
;
}
template
<
typename
T
>
void
mono_to_stereo
(
T
const
*
in
long
insamples
T
*
out
unsigned
int
out_channels
)
{
for
(
long
i
=
0
j
=
0
;
i
<
insamples
;
+
+
i
j
+
=
out_channels
)
{
out
[
j
]
=
out
[
j
+
1
]
=
in
[
i
]
;
}
}
template
<
typename
T
>
void
cubeb_upmix
(
T
const
*
in
long
inframes
T
*
out
unsigned
int
in_channels
unsigned
int
out_channels
)
{
assert
(
out_channels
>
=
in_channels
&
&
in_channels
>
0
)
;
if
(
in_channels
=
=
1
&
&
out_channels
>
=
2
)
{
mono_to_stereo
(
in
inframes
out
out_channels
)
;
}
else
{
for
(
unsigned
int
i
=
0
o
=
0
;
i
<
inframes
*
in_channels
;
i
+
=
in_channels
o
+
=
out_channels
)
{
for
(
unsigned
int
j
=
0
;
j
<
in_channels
;
+
+
j
)
{
out
[
o
+
j
]
=
in
[
i
+
j
]
;
}
}
}
if
(
out_channels
<
=
2
)
{
return
;
}
for
(
long
i
=
0
o
=
0
;
i
<
inframes
;
+
+
i
o
+
=
out_channels
)
{
for
(
unsigned
int
j
=
2
;
j
<
out_channels
;
+
+
j
)
{
out
[
o
+
j
]
=
0
.
0
;
}
}
}
bool
cubeb_should_upmix
(
cubeb_stream_params
const
*
stream
cubeb_stream_params
const
*
mixer
)
{
return
mixer
-
>
channels
>
stream
-
>
channels
;
}
bool
cubeb_should_downmix
(
cubeb_stream_params
const
*
stream
cubeb_stream_params
const
*
mixer
)
{
if
(
mixer
-
>
channels
>
stream
-
>
channels
|
|
mixer
-
>
layout
=
=
stream
-
>
layout
)
{
return
false
;
}
return
mixer
-
>
channels
<
stream
-
>
channels
|
|
mixer
-
>
layout
=
=
CUBEB_LAYOUT_UNDEFINED
|
|
(
stream
-
>
layout
=
=
CUBEB_LAYOUT_3F2
&
&
(
mixer
-
>
layout
=
=
CUBEB_LAYOUT_2F2_LFE
|
|
mixer
-
>
layout
=
=
CUBEB_LAYOUT_3F1_LFE
)
)
;
}
void
cubeb_downmix_float
(
float
*
const
in
long
inframes
float
*
out
unsigned
int
in_channels
unsigned
int
out_channels
cubeb_channel_layout
in_layout
cubeb_channel_layout
out_layout
)
{
cubeb_downmix
(
in
inframes
out
in_channels
out_channels
in_layout
out_layout
)
;
}
void
cubeb_upmix_float
(
float
*
const
in
long
inframes
float
*
out
unsigned
int
in_channels
unsigned
int
out_channels
)
{
cubeb_upmix
(
in
inframes
out
in_channels
out_channels
)
;
}
