#
include
<
windows
.
h
>
#
include
<
Python
.
h
>
HANDLE
token_from_handle
(
HANDLE
hProcess
)
{
HANDLE
hToken
=
NULL
;
if
(
!
OpenProcessToken
(
hProcess
TOKEN_QUERY
&
hToken
)
)
{
return
PyErr_SetFromWindowsErr
(
0
)
;
}
return
hToken
;
}
int
HasSystemPrivilege
(
HANDLE
hProcess
)
{
DWORD
i
;
DWORD
dwSize
=
0
;
DWORD
dwRetval
=
0
;
TCHAR
privName
[
256
]
;
DWORD
dwNameSize
=
256
;
BYTE
*
pBuffer
=
NULL
;
TOKEN_PRIVILEGES
*
tp
=
NULL
;
HANDLE
hToken
=
token_from_handle
(
hProcess
)
;
if
(
NULL
=
=
hToken
)
{
return
-
1
;
}
if
(
!
GetTokenInformation
(
hToken
TokenPrivileges
NULL
0
&
dwSize
)
)
{
dwRetval
=
GetLastError
(
)
;
if
(
dwRetval
!
=
ERROR_INSUFFICIENT_BUFFER
)
{
PyErr_SetFromWindowsErr
(
dwRetval
)
;
return
0
;
}
}
pBuffer
=
(
BYTE
*
)
malloc
(
dwSize
)
;
if
(
pBuffer
=
=
NULL
)
{
PyErr_NoMemory
(
)
;
return
-
1
;
}
if
(
!
GetTokenInformation
(
hToken
TokenPrivileges
pBuffer
dwSize
&
dwSize
)
)
{
PyErr_SetFromWindowsErr
(
0
)
;
free
(
pBuffer
)
;
return
-
1
;
}
tp
=
(
TOKEN_PRIVILEGES
*
)
pBuffer
;
for
(
i
=
0
;
i
<
tp
-
>
PrivilegeCount
;
i
+
+
)
{
strcpy
(
privName
"
"
)
;
dwNameSize
=
sizeof
(
privName
)
/
sizeof
(
TCHAR
)
;
if
(
!
LookupPrivilegeName
(
NULL
&
tp
-
>
Privileges
[
i
]
.
Luid
(
LPTSTR
)
privName
&
dwNameSize
)
)
{
PyErr_SetFromWindowsErr
(
0
)
;
free
(
pBuffer
)
;
return
-
1
;
}
if
(
!
lstrcmpi
(
privName
TEXT
(
"
SeTcbPrivilege
"
)
)
)
{
free
(
pBuffer
)
;
return
1
;
}
}
free
(
pBuffer
)
;
return
0
;
}
BOOL
SetPrivilege
(
HANDLE
hToken
LPCTSTR
Privilege
BOOL
bEnablePrivilege
)
{
TOKEN_PRIVILEGES
tp
;
LUID
luid
;
TOKEN_PRIVILEGES
tpPrevious
;
DWORD
cbPrevious
=
sizeof
(
TOKEN_PRIVILEGES
)
;
if
(
!
LookupPrivilegeValue
(
NULL
Privilege
&
luid
)
)
return
FALSE
;
tp
.
PrivilegeCount
=
1
;
tp
.
Privileges
[
0
]
.
Luid
=
luid
;
tp
.
Privileges
[
0
]
.
Attributes
=
0
;
AdjustTokenPrivileges
(
hToken
FALSE
&
tp
sizeof
(
TOKEN_PRIVILEGES
)
&
tpPrevious
&
cbPrevious
)
;
if
(
GetLastError
(
)
!
=
ERROR_SUCCESS
)
return
FALSE
;
tpPrevious
.
PrivilegeCount
=
1
;
tpPrevious
.
Privileges
[
0
]
.
Luid
=
luid
;
if
(
bEnablePrivilege
)
{
tpPrevious
.
Privileges
[
0
]
.
Attributes
|
=
(
SE_PRIVILEGE_ENABLED
)
;
}
else
{
tpPrevious
.
Privileges
[
0
]
.
Attributes
^
=
(
SE_PRIVILEGE_ENABLED
&
tpPrevious
.
Privileges
[
0
]
.
Attributes
)
;
}
AdjustTokenPrivileges
(
hToken
FALSE
&
tpPrevious
cbPrevious
NULL
NULL
)
;
if
(
GetLastError
(
)
!
=
ERROR_SUCCESS
)
return
FALSE
;
return
TRUE
;
}
int
SetSeDebug
(
)
{
HANDLE
hToken
;
if
(
!
OpenThreadToken
(
GetCurrentThread
(
)
TOKEN_ADJUST_PRIVILEGES
|
TOKEN_QUERY
FALSE
&
hToken
)
)
{
if
(
GetLastError
(
)
=
=
ERROR_NO_TOKEN
)
{
if
(
!
ImpersonateSelf
(
SecurityImpersonation
)
)
{
CloseHandle
(
hToken
)
;
return
0
;
}
if
(
!
OpenThreadToken
(
GetCurrentThread
(
)
TOKEN_ADJUST_PRIVILEGES
|
TOKEN_QUERY
FALSE
&
hToken
)
)
{
RevertToSelf
(
)
;
CloseHandle
(
hToken
)
;
return
0
;
}
}
}
if
(
!
SetPrivilege
(
hToken
SE_DEBUG_NAME
TRUE
)
)
{
RevertToSelf
(
)
;
CloseHandle
(
hToken
)
;
return
0
;
}
RevertToSelf
(
)
;
CloseHandle
(
hToken
)
;
return
1
;
}
int
UnsetSeDebug
(
)
{
HANDLE
hToken
;
if
(
!
OpenThreadToken
(
GetCurrentThread
(
)
TOKEN_ADJUST_PRIVILEGES
|
TOKEN_QUERY
FALSE
&
hToken
)
)
{
if
(
GetLastError
(
)
=
=
ERROR_NO_TOKEN
)
{
if
(
!
ImpersonateSelf
(
SecurityImpersonation
)
)
{
return
0
;
}
if
(
!
OpenThreadToken
(
GetCurrentThread
(
)
TOKEN_ADJUST_PRIVILEGES
|
TOKEN_QUERY
FALSE
&
hToken
)
)
{
return
0
;
}
}
}
if
(
!
SetPrivilege
(
hToken
SE_DEBUG_NAME
FALSE
)
)
{
return
0
;
}
CloseHandle
(
hToken
)
;
return
1
;
}
