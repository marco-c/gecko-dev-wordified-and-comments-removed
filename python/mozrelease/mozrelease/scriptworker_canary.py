import
logging
import
os
import
shutil
import
subprocess
import
tempfile
from
contextlib
import
contextmanager
from
pathlib
import
Path
import
taskcluster
from
appdirs
import
user_config_dir
from
gecko_taskgraph
import
GECKO
from
mach
.
base
import
FailedCommandError
logger
=
logging
.
getLogger
(
__name__
)
TASK_TYPES
=
{
    
"
signing
"
:
[
"
linux
-
signing
"
"
linux
-
signing
-
partial
"
]
    
"
beetmover
"
:
[
"
beetmover
-
candidates
"
]
    
"
bouncer
"
:
[
"
bouncer
-
submit
"
]
    
"
balrog
"
:
[
"
balrog
-
submit
"
]
    
"
tree
"
:
[
"
tree
"
]
}
def
get_secret
(
secret
)
:
    
if
"
TASKCLUSTER_PROXY_URL
"
in
os
.
environ
:
        
secrets_options
=
{
"
rootUrl
"
:
os
.
environ
[
"
TASKCLUSTER_PROXY_URL
"
]
}
    
else
:
        
secrets_options
=
taskcluster
.
optionsFromEnvironment
(
)
    
secrets
=
taskcluster
.
Secrets
(
secrets_options
)
    
return
secrets
.
get
(
secret
)
[
"
secret
"
]
contextmanager
def
configure_ssh
(
ssh_key_secret
)
:
    
if
ssh_key_secret
is
None
:
        
yield
    
hgrc
=
Path
(
user_config_dir
(
"
hg
"
)
)
/
"
hgrc
"
    
if
hgrc
.
exists
(
)
:
        
raise
FailedCommandError
(
f
"
Not
overwriting
{
hgrc
}
;
cannot
configure
ssh
.
"
)
    
try
:
        
ssh_key_dir
=
Path
(
tempfile
.
mkdtemp
(
)
)
        
ssh_key
=
get_secret
(
ssh_key_secret
)
        
ssh_key_file
=
ssh_key_dir
/
"
id_rsa
"
        
ssh_key_file
.
write_text
(
ssh_key
[
"
ssh_privkey
"
]
)
        
ssh_key_file
.
chmod
(
0o600
)
        
hgrc_content
=
(
            
"
[
ui
]
\
n
"
            
"
username
=
trybld
\
n
"
            
"
ssh
=
ssh
-
i
{
path
}
-
l
{
user
}
\
n
"
.
format
(
                
path
=
ssh_key_file
user
=
ssh_key
[
"
user
"
]
            
)
        
)
        
hgrc
.
write_text
(
hgrc_content
)
        
yield
    
finally
:
        
shutil
.
rmtree
(
str
(
ssh_key_dir
)
)
        
hgrc
.
unlink
(
)
def
push_canary
(
scriptworkers
addresses
ssh_key_secret
)
:
    
if
ssh_key_secret
and
os
.
environ
.
get
(
"
MOZ_AUTOMATION
"
"
0
"
)
!
=
"
1
"
:
        
raise
FailedCommandError
(
"
Cannot
use
ssh
-
key
-
secret
outside
of
automation
.
"
)
    
tasks
=
[
]
    
for
scriptworker
in
scriptworkers
:
        
worker_tasks
=
TASK_TYPES
.
get
(
scriptworker
)
        
if
worker_tasks
:
            
logger
.
info
(
f
"
Running
tasks
for
{
scriptworker
}
:
{
worker_tasks
}
"
)
            
tasks
.
extend
(
worker_tasks
)
        
else
:
            
logger
.
info
(
f
"
No
tasks
for
{
scriptworker
}
.
"
)
    
mach
=
Path
(
GECKO
)
/
"
mach
"
    
base_command
=
[
str
(
mach
)
"
try
"
"
scriptworker
"
"
-
-
closed
-
tree
"
"
-
-
push
-
to
-
vcs
"
]
    
for
address
in
addresses
:
        
base_command
.
extend
(
            
[
                
"
-
-
route
"
                
f
"
notify
.
email
.
{
address
}
.
on
-
failed
"
                
"
-
-
route
"
                
f
"
notify
.
email
.
{
address
}
.
on
-
exception
"
            
]
        
)
    
with
configure_ssh
(
ssh_key_secret
)
:
        
env
=
os
.
environ
.
copy
(
)
        
for
task
in
tasks
:
            
subprocess
.
check_call
(
base_command
+
[
task
]
env
=
env
)
