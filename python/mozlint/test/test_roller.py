import
os
import
sys
from
unittest
import
TestCase
from
mozunit
import
main
from
mozlint
import
LintRoller
ResultContainer
from
mozlint
.
errors
import
LintersNotConfigured
LintException
here
=
os
.
path
.
abspath
(
os
.
path
.
dirname
(
__file__
)
)
class
TestLintRoller
(
TestCase
)
:
    
def
__init__
(
self
*
args
*
*
kwargs
)
:
        
TestCase
.
__init__
(
self
*
args
*
*
kwargs
)
        
filedir
=
os
.
path
.
join
(
here
'
files
'
)
        
self
.
files
=
[
os
.
path
.
join
(
filedir
f
)
for
f
in
os
.
listdir
(
filedir
)
]
        
self
.
lintdir
=
os
.
path
.
join
(
here
'
linters
'
)
        
names
=
(
'
string
.
lint
'
'
regex
.
lint
'
'
external
.
lint
'
)
        
self
.
linters
=
[
os
.
path
.
join
(
self
.
lintdir
n
)
for
n
in
names
]
    
def
setUp
(
self
)
:
        
TestCase
.
setUp
(
self
)
        
self
.
lint
=
LintRoller
(
)
    
def
test_roll_no_linters_configured
(
self
)
:
        
with
self
.
assertRaises
(
LintersNotConfigured
)
:
            
self
.
lint
.
roll
(
self
.
files
)
    
def
test_roll_successful
(
self
)
:
        
self
.
lint
.
read
(
self
.
linters
)
        
result
=
self
.
lint
.
roll
(
self
.
files
)
        
self
.
assertEqual
(
len
(
result
)
1
)
        
path
=
result
.
keys
(
)
[
0
]
        
self
.
assertEqual
(
os
.
path
.
basename
(
path
)
'
foobar
.
js
'
)
        
errors
=
result
[
path
]
        
self
.
assertIsInstance
(
errors
list
)
        
self
.
assertEqual
(
len
(
errors
)
6
)
        
container
=
errors
[
0
]
        
self
.
assertIsInstance
(
container
ResultContainer
)
        
self
.
assertEqual
(
container
.
rule
'
no
-
foobar
'
)
    
def
test_roll_catch_exception
(
self
)
:
        
self
.
lint
.
read
(
os
.
path
.
join
(
self
.
lintdir
'
raises
.
lint
'
)
)
        
old_stderr
=
sys
.
stderr
        
sys
.
stderr
=
open
(
os
.
devnull
'
w
'
)
        
with
self
.
assertRaises
(
LintException
)
:
            
self
.
lint
.
roll
(
self
.
files
)
        
sys
.
stderr
=
old_stderr
    
def
test_roll_with_excluded_path
(
self
)
:
        
self
.
lint
.
lintargs
=
{
'
exclude
'
:
[
'
*
*
/
foobar
.
js
'
]
}
        
self
.
lint
.
read
(
self
.
linters
)
        
result
=
self
.
lint
.
roll
(
self
.
files
)
        
self
.
assertEqual
(
len
(
result
)
0
)
if
__name__
=
=
'
__main__
'
:
    
main
(
)
