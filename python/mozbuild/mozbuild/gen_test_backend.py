import
sys
from
mozbuild
.
backend
.
test_manifest
import
TestManifestBackend
from
mozbuild
.
base
import
BuildEnvironmentNotFoundException
MozbuildObject
from
mozbuild
.
frontend
.
emitter
import
TreeMetadataEmitter
from
mozbuild
.
frontend
.
reader
import
BuildReader
EmptyConfig
import
mozpack
.
path
as
mozpath
def
gen_test_backend
(
)
:
    
build_obj
=
MozbuildObject
.
from_environment
(
)
    
try
:
        
config
=
build_obj
.
config_environment
    
except
BuildEnvironmentNotFoundException
:
        
config_status
=
mozpath
.
join
(
build_obj
.
topobjdir
'
config
.
status
'
)
        
open
(
config_status
'
w
'
)
.
close
(
)
        
print
(
"
No
build
detected
test
metadata
may
be
incomplete
.
"
)
        
substs
=
EmptyConfig
.
default_substs
        
if
'
JS_STANDALONE
'
in
substs
:
            
del
substs
[
'
JS_STANDALONE
'
]
        
config
=
EmptyConfig
(
build_obj
.
topsrcdir
substs
)
        
config
.
topobjdir
=
build_obj
.
topobjdir
    
reader
=
BuildReader
(
config
)
    
emitter
=
TreeMetadataEmitter
(
config
)
    
backend
=
TestManifestBackend
(
config
)
    
context
=
reader
.
read_topsrcdir
(
)
    
data
=
emitter
.
emit
(
context
emitfn
=
emitter
.
_process_test_manifests
)
    
backend
.
consume
(
data
)
if
__name__
=
=
'
__main__
'
:
    
sys
.
exit
(
gen_test_backend
(
)
)
