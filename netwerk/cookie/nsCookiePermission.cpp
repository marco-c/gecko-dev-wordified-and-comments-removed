#
include
"
nsCookiePermission
.
h
"
#
include
"
nsICookie
.
h
"
#
include
"
nsIServiceManager
.
h
"
#
include
"
nsICookieManager
.
h
"
#
include
"
nsICookieService
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsIProtocolHandler
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsIChannel
.
h
"
#
include
"
nsIHttpChannelInternal
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsCRT
.
h
"
#
include
"
nsILoadContext
.
h
"
#
include
"
nsIScriptObjectPrincipal
.
h
"
#
include
"
nsNetCID
.
h
"
#
include
"
prtime
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
nsContentUtils
.
h
"
using
namespace
mozilla
;
static
const
bool
kDefaultPolicy
=
true
;
namespace
{
mozilla
:
:
StaticRefPtr
<
nsCookiePermission
>
gSingleton
;
}
NS_IMPL_ISUPPORTS
(
nsCookiePermission
nsICookiePermission
)
already_AddRefed
<
nsICookiePermission
>
nsCookiePermission
:
:
GetOrCreate
(
)
{
if
(
!
gSingleton
)
{
gSingleton
=
new
nsCookiePermission
(
)
;
ClearOnShutdown
(
&
gSingleton
)
;
}
return
do_AddRef
(
gSingleton
)
;
}
bool
nsCookiePermission
:
:
Init
(
)
{
mPermMgr
=
nsPermissionManager
:
:
GetInstance
(
)
;
return
mPermMgr
!
=
nullptr
;
}
NS_IMETHODIMP
nsCookiePermission
:
:
CanSetCookie
(
nsIURI
*
aURI
nsIChannel
*
aChannel
nsICookie
*
aCookie
bool
*
aIsSession
int64_t
*
aExpiry
bool
*
aResult
)
{
NS_ASSERTION
(
aURI
"
null
uri
"
)
;
*
aResult
=
kDefaultPolicy
;
if
(
!
EnsureInitialized
(
)
)
return
NS_ERROR_UNEXPECTED
;
nsCookie
*
cookie
=
static_cast
<
nsCookie
*
>
(
aCookie
)
;
uint32_t
perm
;
mPermMgr
-
>
LegacyTestPermissionFromURI
(
aURI
&
cookie
-
>
OriginAttributesRef
(
)
NS_LITERAL_CSTRING
(
"
cookie
"
)
&
perm
)
;
switch
(
perm
)
{
case
nsICookiePermission
:
:
ACCESS_SESSION
:
*
aIsSession
=
true
;
MOZ_FALLTHROUGH
;
case
nsICookiePermission
:
:
ACCESS_ALLOW
:
*
aResult
=
true
;
break
;
case
nsICookiePermission
:
:
ACCESS_DENY
:
*
aResult
=
false
;
break
;
default
:
if
(
StaticPrefs
:
:
network_cookie_lifetimePolicy
(
)
=
=
nsICookieService
:
:
ACCEPT_NORMALLY
)
{
*
aResult
=
true
;
return
NS_OK
;
}
int64_t
currentTime
=
PR_Now
(
)
/
PR_USEC_PER_SEC
;
int64_t
delta
=
*
aExpiry
-
currentTime
;
if
(
!
*
aIsSession
&
&
delta
>
0
)
{
if
(
StaticPrefs
:
:
network_cookie_lifetimePolicy
(
)
=
=
nsICookieService
:
:
ACCEPT_SESSION
)
{
*
aIsSession
=
true
;
}
}
}
return
NS_OK
;
}
