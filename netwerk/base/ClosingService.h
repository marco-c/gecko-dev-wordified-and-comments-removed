#
ifndef
ClosingService_h__
#
define
ClosingService_h__
#
include
"
nsTArray
.
h
"
#
include
"
nspr
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
namespace
mozilla
{
namespace
net
{
class
ClosingService
final
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
ClosingService
)
ClosingService
(
)
;
static
nsresult
AttachIOLayer
(
PRFileDesc
*
aFd
)
;
static
void
Start
(
)
;
static
void
Shutdown
(
)
;
void
PostRequest
(
PRFileDesc
*
aFd
)
;
private
:
~
ClosingService
(
)
{
}
nsresult
StartInternal
(
)
;
void
ShutdownInternal
(
)
;
void
ThreadFunc
(
)
;
static
void
ThreadFunc
(
void
*
aClosure
)
{
static_cast
<
ClosingService
*
>
(
aClosure
)
-
>
ThreadFunc
(
)
;
}
void
SendPRCloseTelemetry
(
PRIntervalTime
aStart
mozilla
:
:
Telemetry
:
:
ID
aIDNormal
mozilla
:
:
Telemetry
:
:
ID
aIDShutdown
mozilla
:
:
Telemetry
:
:
ID
aIDConnectivityChange
mozilla
:
:
Telemetry
:
:
ID
aIDLinkChange
mozilla
:
:
Telemetry
:
:
ID
aIDOffline
)
;
static
ClosingService
*
sInstance
;
Atomic
<
bool
>
mShutdown
;
nsTArray
<
PRFileDesc
*
>
mQueue
;
mozilla
:
:
Monitor
mMonitor
;
PRThread
*
mThread
;
}
;
}
}
#
endif
