#
ifndef
mozilla_net_EarlyHintPreloader_h
#
define
mozilla_net_EarlyHintPreloader_h
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
PreloadHashKey
.
h
"
#
include
"
nsIChannelEventSink
.
h
"
#
include
"
nsIInterfaceRequestor
.
h
"
#
include
"
nsIRedirectResultListener
.
h
"
#
include
"
nsIStreamListener
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
class
nsAttrValue
;
class
nsICookieJarSettings
;
class
nsIPrincipal
;
class
nsIReferrerInfo
;
namespace
mozilla
:
:
net
{
class
EarlyHintPreloader
;
struct
LinkHeader
;
class
OngoingEarlyHints
final
{
public
:
NS_INLINE_DECL_REFCOUNTING
(
OngoingEarlyHints
)
MOZ_DECLARE_REFCOUNTED_TYPENAME
(
OngoingEarlyHints
)
OngoingEarlyHints
(
)
=
default
;
bool
Contains
(
const
PreloadHashKey
&
aKey
)
;
bool
Add
(
const
PreloadHashKey
&
aKey
RefPtr
<
EarlyHintPreloader
>
aPreloader
)
;
void
CancelAllOngoingPreloads
(
)
;
private
:
~
OngoingEarlyHints
(
)
=
default
;
nsRefPtrHashtable
<
PreloadHashKey
EarlyHintPreloader
>
mOngoingPreloads
;
}
;
class
EarlyHintPreloader
final
:
public
nsIStreamListener
public
nsIChannelEventSink
public
nsIRedirectResultListener
public
nsIInterfaceRequestor
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIREQUESTOBSERVER
NS_DECL_NSISTREAMLISTENER
NS_DECL_NSICHANNELEVENTSINK
NS_DECL_NSIREDIRECTRESULTLISTENER
NS_DECL_NSIINTERFACEREQUESTOR
public
:
static
void
MaybeCreateAndInsertPreload
(
OngoingEarlyHints
*
aOngoingEarlyHints
const
LinkHeader
&
aHeader
nsIURI
*
aBaseURI
nsIPrincipal
*
aPrincipal
nsICookieJarSettings
*
aCookieJarSettings
)
;
nsresult
CancelChannel
(
nsresult
aStatus
)
;
private
:
explicit
EarlyHintPreloader
(
nsIURI
*
aURI
)
;
~
EarlyHintPreloader
(
)
=
default
;
static
Maybe
<
PreloadHashKey
>
GenerateHashKey
(
ASDestination
aAs
nsIURI
*
aURI
nsIPrincipal
*
aPrincipal
CORSMode
corsMode
const
nsAString
&
aType
)
;
static
nsSecurityFlags
ComputeSecurityFlags
(
CORSMode
aCORSMode
ASDestination
aAs
bool
aIsModule
)
;
nsresult
OpenChannel
(
nsIPrincipal
*
aPrincipal
nsSecurityFlags
aSecurityFlags
nsContentPolicyType
aContentPolicyType
nsIReferrerInfo
*
aReferrerInfo
nsICookieJarSettings
*
aCookieJarSettings
)
;
static
void
CollectResourcesTypeTelemetry
(
ASDestination
aASDestination
)
;
nsCOMPtr
<
nsIURI
>
mURI
;
nsCOMPtr
<
nsIChannel
>
mChannel
;
nsCOMPtr
<
nsIChannel
>
mRedirectChannel
;
}
;
inline
nsISupports
*
ToSupports
(
EarlyHintPreloader
*
aObj
)
{
return
static_cast
<
nsIInterfaceRequestor
*
>
(
aObj
)
;
}
}
#
endif
