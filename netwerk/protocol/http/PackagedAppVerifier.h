#
ifndef
mozilla_net_PackagedAppVerifier_h
#
define
mozilla_net_PackagedAppVerifier_h
#
include
"
nsICacheEntry
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsClassHashtable
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsICryptoHash
.
h
"
#
include
"
nsIPackagedAppVerifier
.
h
"
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
nsIPackagedAppUtils
.
h
"
namespace
mozilla
{
namespace
net
{
class
PackagedAppVerifier
final
:
public
nsIPackagedAppVerifier
public
nsIVerificationCallback
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIREQUESTOBSERVER
NS_DECL_NSISTREAMLISTENER
NS_DECL_NSIPACKAGEDAPPVERIFIER
NS_DECL_NSIVERIFICATIONCALLBACK
public
:
enum
EState
{
STATE_UNKNOWN
STATE_MANIFEST_VERIFYING
STATE_MANIFEST_VERIFIED_OK
STATE_MANIFEST_VERIFIED_FAILED
STATE_RESOURCE_VERIFIED_FAILED
}
;
class
ResourceCacheInfo
:
public
nsISupports
public
mozilla
:
:
LinkedListElement
<
ResourceCacheInfo
>
{
public
:
NS_DECL_ISUPPORTS
ResourceCacheInfo
(
nsIURI
*
aURI
nsICacheEntry
*
aCacheEntry
nsresult
aStatusCode
bool
aIsLastPart
)
:
mURI
(
aURI
)
mCacheEntry
(
aCacheEntry
)
mStatusCode
(
aStatusCode
)
mIsLastPart
(
aIsLastPart
)
{
}
ResourceCacheInfo
(
const
ResourceCacheInfo
&
aCopyFrom
)
:
mURI
(
aCopyFrom
.
mURI
)
mCacheEntry
(
aCopyFrom
.
mCacheEntry
)
mStatusCode
(
aCopyFrom
.
mStatusCode
)
mIsLastPart
(
aCopyFrom
.
mIsLastPart
)
{
}
nsCOMPtr
<
nsIURI
>
mURI
;
nsCOMPtr
<
nsICacheEntry
>
mCacheEntry
;
nsresult
mStatusCode
;
bool
mIsLastPart
;
private
:
virtual
~
ResourceCacheInfo
(
)
{
}
}
;
public
:
PackagedAppVerifier
(
)
;
PackagedAppVerifier
(
nsIPackagedAppVerifierListener
*
aListener
const
nsACString
&
aSignature
nsICacheEntry
*
aPackageCacheEntry
)
;
void
SetHasBrokenLastPart
(
nsresult
aStatusCode
)
;
void
ClearListener
(
)
{
mListener
=
nullptr
;
}
bool
GetIsPackageSigned
(
)
const
{
return
mIsPackageSigned
;
}
const
nsACString
&
GetPackageIdentifier
(
)
const
{
return
mPackageIdentifer
;
}
bool
WouldVerify
(
)
const
;
static
const
char
*
kSignedPakIdMetadataKey
;
private
:
virtual
~
PackagedAppVerifier
(
)
;
void
ProcessResourceCache
(
const
ResourceCacheInfo
*
aInfo
)
;
static
NS_METHOD
WriteManifest
(
nsIInputStream
*
aStream
void
*
aManifest
const
char
*
aFromRawSegment
uint32_t
aToOffset
uint32_t
aCount
uint32_t
*
aWriteCount
)
;
void
VerifyManifest
(
const
ResourceCacheInfo
*
aInfo
)
;
void
VerifyResource
(
const
ResourceCacheInfo
*
aInfo
)
;
void
OnManifestVerified
(
bool
aSuccess
)
;
void
OnResourceVerified
(
bool
aSuccess
)
;
nsCOMPtr
<
nsIPackagedAppVerifierListener
>
mListener
;
EState
mState
;
nsCString
mPackageOrigin
;
nsCString
mSignature
;
nsCString
mManifest
;
bool
mIsFirstResource
;
bool
mIsPackageSigned
;
nsCOMPtr
<
nsICacheEntry
>
mPackageCacheEntry
;
nsCString
mHashingResourceURI
;
nsCOMPtr
<
nsICryptoHash
>
mHasher
;
nsCString
mLastComputedResourceHash
;
nsCOMPtr
<
nsIPackagedAppUtils
>
mPackagedAppUtils
;
mozilla
:
:
LinkedList
<
ResourceCacheInfo
>
mPendingResourceCacheInfoList
;
nsClassHashtable
<
nsCStringHashKey
nsCString
>
mResourceHashStore
;
nsCString
mPackageIdentifer
;
}
;
}
}
#
endif
