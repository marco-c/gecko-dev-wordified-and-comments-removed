#
include
"
EarlyHintPreconnect
.
h
"
#
include
"
mozilla
/
CORSMode
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
mozilla
/
StaticPrefs_network
.
h
"
#
include
"
nsIOService
.
h
"
#
include
"
nsIURI
.
h
"
namespace
mozilla
:
:
net
{
void
EarlyHintPreconnect
:
:
MaybePreconnect
(
const
LinkHeader
&
aHeader
nsIURI
*
aBaseURI
nsIPrincipal
*
aPrincipal
)
{
if
(
!
StaticPrefs
:
:
network_early_hints_preconnect_enabled
(
)
)
{
return
;
}
if
(
!
gIOService
)
{
return
;
}
nsCOMPtr
<
nsIURI
>
uri
;
if
(
NS_FAILED
(
aHeader
.
NewResolveHref
(
getter_AddRefs
(
uri
)
aBaseURI
)
)
)
{
return
;
}
if
(
!
uri
-
>
SchemeIs
(
"
https
"
)
)
{
return
;
}
CORSMode
corsMode
=
dom
:
:
Element
:
:
StringToCORSMode
(
aHeader
.
mCrossOrigin
)
;
if
(
corsMode
=
=
CORS_ANONYMOUS
)
{
gIOService
-
>
SpeculativeAnonymousConnect
(
uri
aPrincipal
nullptr
)
;
}
else
{
gIOService
-
>
SpeculativeConnect
(
uri
aPrincipal
nullptr
)
;
}
}
}
