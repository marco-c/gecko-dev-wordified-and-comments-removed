#
ifndef
nsHttpConnectionInfo_h__
#
define
nsHttpConnectionInfo_h__
#
include
"
nsHttp
.
h
"
#
include
"
nsProxyInfo
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
BasePrincipal
.
h
"
#
include
"
mozilla
/
AlreadyAddRefed
.
h
"
#
include
"
ARefBase
.
h
"
class
nsISVCBRecord
;
namespace
mozilla
{
namespace
net
{
extern
LazyLogModule
gHttpLog
;
class
HttpConnectionInfoCloneArgs
;
class
nsHttpTransaction
;
class
nsHttpConnectionInfo
final
:
public
ARefBase
{
public
:
nsHttpConnectionInfo
(
const
nsACString
&
originHost
int32_t
originPort
const
nsACString
&
npnToken
const
nsACString
&
username
nsProxyInfo
*
proxyInfo
const
OriginAttributes
&
originAttributes
bool
endToEndSSL
=
false
bool
aIsHttp3
=
false
)
;
nsHttpConnectionInfo
(
const
nsACString
&
originHost
int32_t
originPort
const
nsACString
&
npnToken
const
nsACString
&
username
nsProxyInfo
*
proxyInfo
const
OriginAttributes
&
originAttributes
const
nsACString
&
routedHost
int32_t
routedPort
bool
aIsHttp3
)
;
static
void
SerializeHttpConnectionInfo
(
nsHttpConnectionInfo
*
aInfo
HttpConnectionInfoCloneArgs
&
aArgs
)
;
static
already_AddRefed
<
nsHttpConnectionInfo
>
DeserializeHttpConnectionInfoCloneArgs
(
const
HttpConnectionInfoCloneArgs
&
aInfoArgs
)
;
private
:
virtual
~
nsHttpConnectionInfo
(
)
{
MOZ_LOG
(
gHttpLog
LogLevel
:
:
Debug
(
"
Destroying
nsHttpConnectionInfo
%
p
\
n
"
this
)
)
;
}
void
BuildHashKey
(
)
;
void
RebuildHashKey
(
)
;
public
:
const
nsCString
&
HashKey
(
)
const
{
return
mHashKey
;
}
const
nsCString
&
GetOrigin
(
)
const
{
return
mOrigin
;
}
const
char
*
Origin
(
)
const
{
return
mOrigin
.
get
(
)
;
}
int32_t
OriginPort
(
)
const
{
return
mOriginPort
;
}
const
nsCString
&
GetRoutedHost
(
)
const
{
return
mRoutedHost
;
}
const
char
*
RoutedHost
(
)
const
{
return
mRoutedHost
.
get
(
)
;
}
int32_t
RoutedPort
(
)
const
{
return
mRoutedPort
;
}
already_AddRefed
<
nsHttpConnectionInfo
>
Clone
(
)
const
;
already_AddRefed
<
nsHttpConnectionInfo
>
CloneAndAdoptHTTPSSVCRecord
(
nsISVCBRecord
*
aRecord
)
const
;
void
CloneAsDirectRoute
(
nsHttpConnectionInfo
*
*
outParam
)
;
[
[
nodiscard
]
]
nsresult
CreateWildCard
(
nsHttpConnectionInfo
*
*
outParam
)
;
const
char
*
ProxyHost
(
)
const
{
return
mProxyInfo
?
mProxyInfo
-
>
Host
(
)
.
get
(
)
:
nullptr
;
}
int32_t
ProxyPort
(
)
const
{
return
mProxyInfo
?
mProxyInfo
-
>
Port
(
)
:
-
1
;
}
const
char
*
ProxyType
(
)
const
{
return
mProxyInfo
?
mProxyInfo
-
>
Type
(
)
:
nullptr
;
}
const
char
*
ProxyUsername
(
)
const
{
return
mProxyInfo
?
mProxyInfo
-
>
Username
(
)
.
get
(
)
:
nullptr
;
}
const
char
*
ProxyPassword
(
)
const
{
return
mProxyInfo
?
mProxyInfo
-
>
Password
(
)
.
get
(
)
:
nullptr
;
}
const
nsCString
&
ProxyAuthorizationHeader
(
)
const
{
return
mProxyInfo
?
mProxyInfo
-
>
ProxyAuthorizationHeader
(
)
:
EmptyCString
(
)
;
}
const
nsCString
&
ConnectionIsolationKey
(
)
const
{
return
mProxyInfo
?
mProxyInfo
-
>
ConnectionIsolationKey
(
)
:
EmptyCString
(
)
;
}
bool
Equals
(
const
nsHttpConnectionInfo
*
info
)
{
return
mHashKey
.
Equals
(
info
-
>
HashKey
(
)
)
;
}
const
char
*
Username
(
)
const
{
return
mUsername
.
get
(
)
;
}
nsProxyInfo
*
ProxyInfo
(
)
const
{
return
mProxyInfo
;
}
int32_t
DefaultPort
(
)
const
{
return
mEndToEndSSL
?
NS_HTTPS_DEFAULT_PORT
:
NS_HTTP_DEFAULT_PORT
;
}
void
SetAnonymous
(
bool
anon
)
{
mHashKey
.
SetCharAt
(
anon
?
'
A
'
:
'
.
'
2
)
;
}
bool
GetAnonymous
(
)
const
{
return
mHashKey
.
CharAt
(
2
)
=
=
'
A
'
;
}
void
SetPrivate
(
bool
priv
)
{
mHashKey
.
SetCharAt
(
priv
?
'
P
'
:
'
.
'
3
)
;
}
bool
GetPrivate
(
)
const
{
return
mHashKey
.
CharAt
(
3
)
=
=
'
P
'
;
}
void
SetInsecureScheme
(
bool
insecureScheme
)
{
mHashKey
.
SetCharAt
(
insecureScheme
?
'
I
'
:
'
.
'
4
)
;
}
bool
GetInsecureScheme
(
)
const
{
return
mHashKey
.
CharAt
(
4
)
=
=
'
I
'
;
}
void
SetNoSpdy
(
bool
aNoSpdy
)
{
mHashKey
.
SetCharAt
(
aNoSpdy
?
'
X
'
:
'
.
'
5
)
;
}
bool
GetNoSpdy
(
)
const
{
return
mHashKey
.
CharAt
(
5
)
=
=
'
X
'
;
}
void
SetBeConservative
(
bool
aBeConservative
)
{
mHashKey
.
SetCharAt
(
aBeConservative
?
'
C
'
:
'
.
'
6
)
;
}
bool
GetBeConservative
(
)
const
{
return
mHashKey
.
CharAt
(
6
)
=
=
'
C
'
;
}
void
SetTlsFlags
(
uint32_t
aTlsFlags
)
;
uint32_t
GetTlsFlags
(
)
const
{
return
mTlsFlags
;
}
void
SetIsTrrServiceChannel
(
bool
aIsTRRChannel
)
{
mIsTrrServiceChannel
=
aIsTRRChannel
;
}
bool
GetIsTrrServiceChannel
(
)
const
{
return
mIsTrrServiceChannel
;
}
void
SetTRRMode
(
nsIRequest
:
:
TRRMode
aTRRMode
)
;
nsIRequest
:
:
TRRMode
GetTRRMode
(
)
const
{
return
mTRRMode
;
}
void
SetIPv4Disabled
(
bool
aNoIPv4
)
;
bool
GetIPv4Disabled
(
)
const
{
return
mIPv4Disabled
;
}
void
SetIPv6Disabled
(
bool
aNoIPv6
)
;
bool
GetIPv6Disabled
(
)
const
{
return
mIPv6Disabled
;
}
const
nsCString
&
GetNPNToken
(
)
{
return
mNPNToken
;
}
const
nsCString
&
GetUsername
(
)
{
return
mUsername
;
}
const
OriginAttributes
&
GetOriginAttributes
(
)
{
return
mOriginAttributes
;
}
bool
UsingProxy
(
)
;
bool
UsingHttpProxy
(
)
const
{
return
mUsingHttpProxy
|
|
mUsingHttpsProxy
;
}
bool
UsingHttpsProxy
(
)
const
{
return
mUsingHttpsProxy
;
}
bool
EndToEndSSL
(
)
const
{
return
mEndToEndSSL
;
}
bool
FirstHopSSL
(
)
const
{
return
mEndToEndSSL
|
|
mUsingHttpsProxy
;
}
bool
UsingConnect
(
)
const
{
return
mUsingConnect
;
}
bool
HostIsLocalIPLiteral
(
)
const
;
bool
GetLessThanTls13
(
)
const
{
return
mLessThanTls13
;
}
void
SetLessThanTls13
(
bool
aLessThanTls13
)
{
mLessThanTls13
=
aLessThanTls13
;
}
bool
IsHttp3
(
)
const
{
return
mIsHttp3
;
}
void
SetHasIPHintAddress
(
bool
aHasIPHint
)
{
mHasIPHintAddress
=
aHasIPHint
;
}
bool
HasIPHintAddress
(
)
const
{
return
mHasIPHintAddress
;
}
void
SetEchConfig
(
const
nsACString
&
aEchConfig
)
{
mEchConfig
=
aEchConfig
;
}
const
nsCString
&
GetEchConfig
(
)
const
{
return
mEchConfig
;
}
private
:
void
Init
(
const
nsACString
&
host
int32_t
port
const
nsACString
&
npnToken
const
nsACString
&
username
nsProxyInfo
*
proxyInfo
const
OriginAttributes
&
originAttributes
bool
EndToEndSSL
bool
aIsHttp3
)
;
void
SetOriginServer
(
const
nsACString
&
host
int32_t
port
)
;
nsCString
mOrigin
;
int32_t
mOriginPort
;
nsCString
mRoutedHost
;
int32_t
mRoutedPort
;
nsCString
mHashKey
;
nsCString
mUsername
;
nsCOMPtr
<
nsProxyInfo
>
mProxyInfo
;
bool
mUsingHttpProxy
;
bool
mUsingHttpsProxy
;
bool
mEndToEndSSL
;
bool
mUsingConnect
;
nsCString
mNPNToken
;
OriginAttributes
mOriginAttributes
;
nsIRequest
:
:
TRRMode
mTRRMode
;
uint32_t
mTlsFlags
;
uint16_t
mIsTrrServiceChannel
:
1
;
uint16_t
mIPv4Disabled
:
1
;
uint16_t
mIPv6Disabled
:
1
;
bool
mLessThanTls13
;
bool
mIsHttp3
;
bool
mHasIPHintAddress
=
false
;
nsCString
mEchConfig
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
nsHttpConnectionInfo
override
)
}
;
}
}
#
endif
