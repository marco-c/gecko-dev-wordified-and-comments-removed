#
ifndef
nsHttpAuthCache_h__
#
define
nsHttpAuthCache_h__
#
include
"
nsError
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
include
"
nsClassHashtable
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsIObserver
.
h
"
namespace
mozilla
{
class
OriginAttributesPattern
;
namespace
net
{
struct
nsHttpAuthPath
{
struct
nsHttpAuthPath
*
mNext
;
char
mPath
[
1
]
;
}
;
class
nsHttpAuthIdentity
{
public
:
nsHttpAuthIdentity
(
)
:
mUser
(
nullptr
)
mPass
(
nullptr
)
mDomain
(
nullptr
)
{
}
nsHttpAuthIdentity
(
const
char16_t
*
domain
const
char16_t
*
user
const
char16_t
*
password
)
:
mUser
(
nullptr
)
mPass
{
nullptr
}
mDomain
{
nullptr
}
{
DebugOnly
<
nsresult
>
rv
=
Set
(
domain
user
password
)
;
MOZ_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
}
~
nsHttpAuthIdentity
(
)
{
Clear
(
)
;
}
const
char16_t
*
Domain
(
)
const
{
return
mDomain
;
}
const
char16_t
*
User
(
)
const
{
return
mUser
;
}
const
char16_t
*
Password
(
)
const
{
return
mPass
;
}
MOZ_MUST_USE
nsresult
Set
(
const
char16_t
*
domain
const
char16_t
*
user
const
char16_t
*
password
)
;
MOZ_MUST_USE
nsresult
Set
(
const
nsHttpAuthIdentity
&
other
)
{
return
Set
(
other
.
mDomain
other
.
mUser
other
.
mPass
)
;
}
void
Clear
(
)
;
bool
Equals
(
const
nsHttpAuthIdentity
&
other
)
const
;
bool
IsEmpty
(
)
const
{
return
!
mUser
;
}
private
:
char16_t
*
mUser
;
char16_t
*
mPass
;
char16_t
*
mDomain
;
}
;
class
nsHttpAuthEntry
{
public
:
const
char
*
Realm
(
)
const
{
return
mRealm
;
}
const
char
*
Creds
(
)
const
{
return
mCreds
;
}
const
char
*
Challenge
(
)
const
{
return
mChallenge
;
}
const
char16_t
*
Domain
(
)
const
{
return
mIdent
.
Domain
(
)
;
}
const
char16_t
*
User
(
)
const
{
return
mIdent
.
User
(
)
;
}
const
char16_t
*
Pass
(
)
const
{
return
mIdent
.
Password
(
)
;
}
nsHttpAuthPath
*
RootPath
(
)
{
return
mRoot
;
}
const
nsHttpAuthIdentity
&
Identity
(
)
const
{
return
mIdent
;
}
MOZ_MUST_USE
nsresult
AddPath
(
const
char
*
aPath
)
;
nsCOMPtr
<
nsISupports
>
mMetaData
;
private
:
nsHttpAuthEntry
(
const
char
*
path
const
char
*
realm
const
char
*
creds
const
char
*
challenge
const
nsHttpAuthIdentity
*
ident
nsISupports
*
metadata
)
:
mRoot
(
nullptr
)
mTail
(
nullptr
)
mRealm
(
nullptr
)
mCreds
{
nullptr
}
mChallenge
{
nullptr
}
{
DebugOnly
<
nsresult
>
rv
=
Set
(
path
realm
creds
challenge
ident
metadata
)
;
MOZ_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
}
~
nsHttpAuthEntry
(
)
;
MOZ_MUST_USE
nsresult
Set
(
const
char
*
path
const
char
*
realm
const
char
*
creds
const
char
*
challenge
const
nsHttpAuthIdentity
*
ident
nsISupports
*
metadata
)
;
nsHttpAuthIdentity
mIdent
;
nsHttpAuthPath
*
mRoot
;
nsHttpAuthPath
*
mTail
;
char
*
mRealm
;
char
*
mCreds
;
char
*
mChallenge
;
friend
class
nsHttpAuthNode
;
friend
class
nsHttpAuthCache
;
friend
class
nsAutoPtr
<
nsHttpAuthEntry
>
;
}
;
class
nsHttpAuthNode
{
private
:
nsHttpAuthNode
(
)
;
~
nsHttpAuthNode
(
)
;
nsHttpAuthEntry
*
LookupEntryByPath
(
const
char
*
path
)
;
nsHttpAuthEntry
*
LookupEntryByRealm
(
const
char
*
realm
)
;
MOZ_MUST_USE
nsresult
SetAuthEntry
(
const
char
*
path
const
char
*
realm
const
char
*
credentials
const
char
*
challenge
const
nsHttpAuthIdentity
*
ident
nsISupports
*
metadata
)
;
void
ClearAuthEntry
(
const
char
*
realm
)
;
uint32_t
EntryCount
(
)
{
return
mList
.
Length
(
)
;
}
private
:
nsTArray
<
nsAutoPtr
<
nsHttpAuthEntry
>
>
mList
;
friend
class
nsHttpAuthCache
;
friend
class
nsAutoPtr
<
nsHttpAuthNode
>
;
}
;
class
nsHttpAuthCache
{
public
:
nsHttpAuthCache
(
)
;
~
nsHttpAuthCache
(
)
;
MOZ_MUST_USE
nsresult
GetAuthEntryForPath
(
const
char
*
scheme
const
char
*
host
int32_t
port
const
char
*
path
nsACString
const
&
originSuffix
nsHttpAuthEntry
*
*
entry
)
;
MOZ_MUST_USE
nsresult
GetAuthEntryForDomain
(
const
char
*
scheme
const
char
*
host
int32_t
port
const
char
*
realm
nsACString
const
&
originSuffix
nsHttpAuthEntry
*
*
entry
)
;
MOZ_MUST_USE
nsresult
SetAuthEntry
(
const
char
*
scheme
const
char
*
host
int32_t
port
const
char
*
directory
const
char
*
realm
const
char
*
credentials
const
char
*
challenge
nsACString
const
&
originSuffix
const
nsHttpAuthIdentity
*
ident
nsISupports
*
metadata
)
;
void
ClearAuthEntry
(
const
char
*
scheme
const
char
*
host
int32_t
port
const
char
*
realm
nsACString
const
&
originSuffix
)
;
void
ClearAll
(
)
;
private
:
nsHttpAuthNode
*
LookupAuthNode
(
const
char
*
scheme
const
char
*
host
int32_t
port
nsACString
const
&
originSuffix
nsCString
&
key
)
;
class
OriginClearObserver
:
public
nsIObserver
{
virtual
~
OriginClearObserver
(
)
=
default
;
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIOBSERVER
explicit
OriginClearObserver
(
nsHttpAuthCache
*
aOwner
)
:
mOwner
(
aOwner
)
{
}
nsHttpAuthCache
*
mOwner
;
}
;
void
ClearOriginData
(
OriginAttributesPattern
const
&
pattern
)
;
private
:
using
AuthNodeTable
=
nsClassHashtable
<
nsCStringHashKey
nsHttpAuthNode
>
;
AuthNodeTable
mDB
;
RefPtr
<
OriginClearObserver
>
mObserver
;
}
;
}
}
#
endif
