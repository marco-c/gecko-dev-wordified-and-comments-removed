#
ifndef
ConnectionEntry_h__
#
define
ConnectionEntry_h__
#
include
"
PendingTransactionInfo
.
h
"
#
include
"
PendingTransactionQueue
.
h
"
#
include
"
HalfOpenSocket
.
h
"
namespace
mozilla
{
namespace
net
{
class
ConnectionEntry
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
ConnectionEntry
)
explicit
ConnectionEntry
(
nsHttpConnectionInfo
*
ci
)
;
void
ReschedTransaction
(
nsHttpTransaction
*
aTrans
)
;
nsTArray
<
RefPtr
<
PendingTransactionInfo
>
>
*
GetTransactionPendingQHelper
(
nsAHttpTransaction
*
trans
)
;
void
InsertTransactionSorted
(
nsTArray
<
RefPtr
<
PendingTransactionInfo
>
>
&
pendingQ
PendingTransactionInfo
*
pendingTransInfo
bool
aInsertAsFirstForTheSamePriority
=
false
)
;
void
InsertTransaction
(
PendingTransactionInfo
*
aPendingTransInfo
bool
aInsertAsFirstForTheSamePriority
=
false
)
;
size_t
UrgentStartQueueLength
(
)
;
void
PrintPendingQ
(
)
;
void
Compact
(
)
;
void
CancelAllTransactions
(
nsresult
reason
)
;
RefPtr
<
nsHttpConnectionInfo
>
mConnInfo
;
nsTArray
<
RefPtr
<
HttpConnectionBase
>
>
mActiveConns
;
nsTArray
<
RefPtr
<
nsHttpConnection
>
>
mIdleConns
;
nsTArray
<
HalfOpenSocket
*
>
mHalfOpens
;
nsTArray
<
RefPtr
<
HalfOpenSocket
>
>
mHalfOpenFastOpenBackups
;
bool
AvailableForDispatchNow
(
)
;
uint32_t
UnconnectedHalfOpens
(
)
const
;
void
RemoveHalfOpen
(
HalfOpenSocket
*
)
;
nsTArray
<
nsCString
>
mCoalescingKeys
;
bool
mUsingSpdy
:
1
;
bool
mCanUseSpdy
:
1
;
bool
mPreferIPv4
:
1
;
bool
mPreferIPv6
:
1
;
bool
mUsedForConnection
:
1
;
bool
mUseFastOpen
:
1
;
bool
mDoNotDestroy
:
1
;
bool
AllowHttp2
(
)
const
{
return
mCanUseSpdy
;
}
void
DisallowHttp2
(
)
;
void
DontReuseHttp3Conn
(
)
;
void
RecordIPFamilyPreference
(
uint16_t
family
)
;
void
ResetIPFamilyPreference
(
)
;
bool
PreferenceKnown
(
)
const
;
size_t
PendingQueueLength
(
)
const
;
size_t
PendingQueueLengthForWindow
(
uint64_t
windowId
)
const
;
void
AppendPendingUrgentStartQ
(
nsTArray
<
RefPtr
<
PendingTransactionInfo
>
>
&
result
)
;
void
AppendPendingQForFocusedWindow
(
uint64_t
windowId
nsTArray
<
RefPtr
<
PendingTransactionInfo
>
>
&
result
uint32_t
maxCount
=
0
)
;
void
AppendPendingQForNonFocusedWindows
(
uint64_t
windowId
nsTArray
<
RefPtr
<
PendingTransactionInfo
>
>
&
result
uint32_t
maxCount
=
0
)
;
void
RemoveEmptyPendingQ
(
)
;
void
PrintDiagnostics
(
nsCString
&
log
uint32_t
aMaxPersistConns
)
;
bool
RestrictConnections
(
)
;
uint32_t
TotalActiveConnections
(
)
const
;
private
:
PendingTransactionQueue
mPendingQ
;
~
ConnectionEntry
(
)
;
}
;
}
}
#
endif
