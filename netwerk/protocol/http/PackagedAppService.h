#
ifndef
mozilla_net_PackagedAppService_h
#
define
mozilla_net_PackagedAppService_h
#
include
"
nsIPackagedAppService
.
h
"
#
include
"
nsILoadContextInfo
.
h
"
#
include
"
nsICacheStorage
.
h
"
namespace
mozilla
{
namespace
net
{
class
nsHttpResponseHead
;
class
PackagedAppService
final
:
public
nsIPackagedAppService
{
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIPACKAGEDAPPSERVICE
PackagedAppService
(
)
;
private
:
~
PackagedAppService
(
)
;
nsresult
NotifyPackageDownloaded
(
nsCString
aKey
)
;
static
nsresult
GetPackageURI
(
nsIURI
*
aUri
nsIURI
*
*
aPackageURI
)
;
class
CacheEntryWriter
final
:
public
nsIStreamListener
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSISTREAMLISTENER
NS_DECL_NSIREQUESTOBSERVER
static
nsresult
Create
(
nsIURI
*
nsICacheStorage
*
CacheEntryWriter
*
*
)
;
nsCOMPtr
<
nsICacheEntry
>
mEntry
;
private
:
CacheEntryWriter
(
)
{
}
~
CacheEntryWriter
(
)
{
}
nsresult
CopySecurityInfo
(
nsIChannel
*
aChannel
)
;
static
nsresult
CopyHeadersFromChannel
(
nsIChannel
*
aChannel
nsHttpResponseHead
*
aHead
)
;
static
NS_METHOD
ConsumeData
(
nsIInputStream
*
in
void
*
closure
const
char
*
fromRawSegment
uint32_t
toOffset
uint32_t
count
uint32_t
*
writeCount
)
;
nsCOMPtr
<
nsIOutputStream
>
mOutputStream
;
}
;
class
PackagedAppDownloader
final
:
public
nsIStreamListener
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSISTREAMLISTENER
NS_DECL_NSIREQUESTOBSERVER
nsresult
Init
(
nsILoadContextInfo
*
aInfo
const
nsCString
&
aKey
)
;
nsresult
AddCallback
(
nsIURI
*
aURI
nsICacheEntryOpenCallback
*
aCallback
)
;
void
SetIsFromCache
(
bool
aFromCache
)
{
mIsFromCache
=
aFromCache
;
}
private
:
~
PackagedAppDownloader
(
)
{
}
nsresult
CallCallbacks
(
nsIURI
*
aURI
nsICacheEntry
*
aEntry
nsresult
aResult
)
;
nsresult
ClearCallbacks
(
nsresult
aResult
)
;
static
nsresult
GetSubresourceURI
(
nsIRequest
*
aRequest
nsIURI
*
*
aResult
)
;
nsRefPtr
<
CacheEntryWriter
>
mWriter
;
nsCOMPtr
<
nsICacheStorage
>
mCacheStorage
;
nsClassHashtable
<
nsCStringHashKey
nsCOMArray
<
nsICacheEntryOpenCallback
>
>
mCallbacks
;
nsCString
mPackageKey
;
bool
mIsFromCache
;
}
;
class
PackagedAppChannelListener
final
:
public
nsIStreamListener
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSISTREAMLISTENER
NS_DECL_NSIREQUESTOBSERVER
PackagedAppChannelListener
(
PackagedAppDownloader
*
aDownloader
nsIStreamListener
*
aListener
)
:
mDownloader
(
aDownloader
)
mListener
(
aListener
)
{
}
private
:
~
PackagedAppChannelListener
(
)
{
}
nsRefPtr
<
PackagedAppDownloader
>
mDownloader
;
nsCOMPtr
<
nsIStreamListener
>
mListener
;
}
;
nsRefPtrHashtable
<
nsCStringHashKey
PackagedAppDownloader
>
mDownloadingPackages
;
}
;
}
}
#
endif
