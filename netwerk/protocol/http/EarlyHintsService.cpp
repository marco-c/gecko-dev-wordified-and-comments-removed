#
include
"
EarlyHintsService
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
namespace
mozilla
:
:
net
{
void
EarlyHintsService
:
:
EarlyHint
(
const
nsACString
&
linkHeader
)
{
mEarlyHintsCount
+
+
;
if
(
!
mFirstEarlyHint
)
{
mFirstEarlyHint
.
emplace
(
TimeStamp
:
:
NowLoRes
(
)
)
;
}
}
void
EarlyHintsService
:
:
FinalResponse
(
uint32_t
aResponseStatus
)
{
CollectTelemetry
(
Some
(
aResponseStatus
)
)
;
}
void
EarlyHintsService
:
:
Cancel
(
)
{
if
(
!
mCanceled
)
{
CollectTelemetry
(
Nothing
(
)
)
;
mCanceled
=
true
;
}
}
void
EarlyHintsService
:
:
CollectTelemetry
(
Maybe
<
uint32_t
>
aResponseStatus
)
{
if
(
aResponseStatus
&
&
(
*
aResponseStatus
<
=
299
)
)
{
Telemetry
:
:
Accumulate
(
Telemetry
:
:
EH_NUM_OF_HINTS_PER_PAGE
mEarlyHintsCount
)
;
}
if
(
mEarlyHintsCount
=
=
0
)
{
return
;
}
Telemetry
:
:
LABELS_EH_FINAL_RESPONSE
label
=
Telemetry
:
:
LABELS_EH_FINAL_RESPONSE
:
:
Cancel
;
if
(
aResponseStatus
)
{
if
(
*
aResponseStatus
<
=
299
)
{
label
=
Telemetry
:
:
LABELS_EH_FINAL_RESPONSE
:
:
R2xx
;
MOZ_ASSERT
(
mFirstEarlyHint
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
EH_TIME_TO_FINAL_RESPONSE
*
mFirstEarlyHint
TimeStamp
:
:
NowLoRes
(
)
)
;
}
else
if
(
*
aResponseStatus
<
=
399
)
{
label
=
Telemetry
:
:
LABELS_EH_FINAL_RESPONSE
:
:
R3xx
;
}
else
if
(
*
aResponseStatus
<
=
499
)
{
label
=
Telemetry
:
:
LABELS_EH_FINAL_RESPONSE
:
:
R4xx
;
}
else
{
label
=
Telemetry
:
:
LABELS_EH_FINAL_RESPONSE
:
:
Other
;
}
}
Telemetry
:
:
AccumulateCategorical
(
label
)
;
mEarlyHintsCount
=
0
;
mFirstEarlyHint
=
Nothing
(
)
;
}
}
