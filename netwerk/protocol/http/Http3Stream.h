#
ifndef
mozilla_net_Http3Stream_h
#
define
mozilla_net_Http3Stream_h
#
include
"
nsAHttpTransaction
.
h
"
#
include
"
ARefBase
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
namespace
mozilla
{
namespace
net
{
class
Http3Session
;
class
Http3Stream
final
:
public
nsAHttpSegmentReader
public
nsAHttpSegmentWriter
public
SupportsWeakPtr
public
ARefBase
{
public
:
NS_DECL_NSAHTTPSEGMENTREADER
NS_DECL_NSAHTTPSEGMENTWRITER
NS_INLINE_DECL_REFCOUNTING
(
Http3Stream
override
)
Http3Stream
(
nsAHttpTransaction
*
Http3Session
*
uint32_t
uint64_t
)
;
bool
HasStreamId
(
)
const
{
return
mStreamId
!
=
UINT64_MAX
;
}
uint64_t
StreamId
(
)
const
{
return
mStreamId
;
}
nsresult
TryActivating
(
)
;
void
TopBrowsingContextIdChanged
(
uint64_t
id
)
;
[
[
nodiscard
]
]
nsresult
ReadSegments
(
nsAHttpSegmentReader
*
)
;
[
[
nodiscard
]
]
nsresult
WriteSegments
(
nsAHttpSegmentWriter
*
uint32_t
uint32_t
*
)
;
void
SetQueued
(
bool
aStatus
)
{
mQueued
=
aStatus
;
}
bool
Queued
(
)
const
{
return
mQueued
;
}
bool
Done
(
)
const
{
return
mRecvState
=
=
RECV_DONE
;
}
void
Close
(
nsresult
aResult
)
;
bool
RecvdData
(
)
const
{
return
mDataReceived
;
}
nsAHttpTransaction
*
Transaction
(
)
{
return
mTransaction
;
}
bool
RecvdFin
(
)
const
{
return
mFin
;
}
bool
RecvdReset
(
)
const
{
return
mResetRecv
;
}
void
SetRecvdReset
(
)
{
mResetRecv
=
true
;
}
void
StopSending
(
)
;
void
SetResponseHeaders
(
nsTArray
<
uint8_t
>
&
aResponseHeaders
bool
fin
bool
interim
)
;
bool
Do0RTT
(
)
;
nsresult
Finish0RTT
(
bool
aRestart
)
;
uint8_t
PriorityUrgency
(
)
;
bool
PriorityIncremental
(
)
;
private
:
~
Http3Stream
(
)
=
default
;
bool
GetHeadersString
(
const
char
*
buf
uint32_t
avail
uint32_t
*
countUsed
)
;
nsresult
StartRequest
(
)
;
void
SetPriority
(
uint32_t
aCos
)
;
enum
SendStreamState
{
PREPARING_HEADERS
WAITING_TO_ACTIVATE
SENDING_BODY
EARLY_RESPONSE
SEND_DONE
}
mSendState
{
PREPARING_HEADERS
}
;
enum
RecvStreamState
{
BEFORE_HEADERS
READING_HEADERS
READING_INTERIM_HEADERS
READING_DATA
RECEIVED_FIN
RECV_DONE
}
mRecvState
{
BEFORE_HEADERS
}
;
uint64_t
mStreamId
{
UINT64_MAX
}
;
Http3Session
*
mSession
;
RefPtr
<
nsAHttpTransaction
>
mTransaction
;
nsCString
mFlatHttpRequestHeaders
;
bool
mQueued
{
false
}
;
bool
mDataReceived
{
false
}
;
bool
mResetRecv
{
false
}
;
nsTArray
<
uint8_t
>
mFlatResponseHeaders
;
uint64_t
mTransactionTabId
{
0
}
;
uint64_t
mCurrentTopBrowsingContextId
;
uint8_t
mPriorityUrgency
{
3
}
;
bool
mPriorityIncremental
{
false
}
;
uint64_t
mTotalSent
{
0
}
;
uint64_t
mTotalRead
{
0
}
;
bool
mFin
{
false
}
;
bool
mAttempting0RTT
=
false
;
uint32_t
mSendingBlockedByFlowControlCount
=
0
;
nsresult
mSocketInCondition
=
NS_ERROR_NOT_INITIALIZED
;
nsresult
mSocketOutCondition
=
NS_ERROR_NOT_INITIALIZED
;
#
ifdef
DEBUG
uint32_t
mRequestBodyLenExpected
{
0
}
;
uint32_t
mRequestBodyLenSent
{
0
}
;
#
endif
}
;
}
}
#
endif
