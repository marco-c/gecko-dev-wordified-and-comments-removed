#
ifndef
nsAHttpTransaction_h__
#
define
nsAHttpTransaction_h__
#
include
"
nsISupports
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsWeakReference
.
h
"
#
ifdef
Status
typedef
Status
__StatusTmp
;
#
undef
Status
typedef
__StatusTmp
Status
;
#
endif
class
nsIDNSHTTPSSVCRecord
;
class
nsIInterfaceRequestor
;
class
nsISVCBRecord
;
class
nsITransport
;
class
nsIRequestContext
;
namespace
mozilla
{
namespace
net
{
class
nsAHttpConnection
;
class
nsAHttpSegmentReader
;
class
nsAHttpSegmentWriter
;
class
nsHttpTransaction
;
class
nsHttpRequestHead
;
class
nsHttpConnectionInfo
;
class
NullHttpTransaction
;
class
Http2ConnectTransaction
;
#
define
NS_AHTTPTRANSACTION_IID
\
{
\
0x2af6d634
0x13e3
0x494c
{
\
0x89
0x03
0xc9
0xdc
0xe5
0xc2
0x2f
0xc0
\
}
\
}
class
nsAHttpTransaction
:
public
nsSupportsWeakReference
{
public
:
NS_DECLARE_STATIC_IID_ACCESSOR
(
NS_AHTTPTRANSACTION_IID
)
virtual
void
SetConnection
(
nsAHttpConnection
*
)
=
0
;
virtual
void
OnActivated
(
)
{
}
virtual
nsAHttpConnection
*
Connection
(
)
=
0
;
virtual
void
GetSecurityCallbacks
(
nsIInterfaceRequestor
*
*
)
=
0
;
virtual
void
OnTransportStatus
(
nsITransport
*
transport
nsresult
status
int64_t
progress
)
=
0
;
virtual
bool
IsDone
(
)
=
0
;
virtual
nsresult
Status
(
)
=
0
;
virtual
uint32_t
Caps
(
)
=
0
;
[
[
nodiscard
]
]
virtual
nsresult
ReadSegments
(
nsAHttpSegmentReader
*
reader
uint32_t
count
uint32_t
*
countRead
)
=
0
;
[
[
nodiscard
]
]
virtual
nsresult
WriteSegments
(
nsAHttpSegmentWriter
*
writer
uint32_t
count
uint32_t
*
countWritten
)
=
0
;
[
[
nodiscard
]
]
virtual
nsresult
ReadSegmentsAgain
(
nsAHttpSegmentReader
*
reader
uint32_t
count
uint32_t
*
countRead
bool
*
again
)
{
return
ReadSegments
(
reader
count
countRead
)
;
}
[
[
nodiscard
]
]
virtual
nsresult
WriteSegmentsAgain
(
nsAHttpSegmentWriter
*
writer
uint32_t
count
uint32_t
*
countWritten
bool
*
again
)
{
return
WriteSegments
(
writer
count
countWritten
)
;
}
virtual
void
Close
(
nsresult
reason
)
=
0
;
virtual
void
SetProxyConnectFailed
(
)
=
0
;
virtual
nsHttpRequestHead
*
RequestHead
(
)
=
0
;
virtual
uint32_t
Http1xTransactionCount
(
)
=
0
;
[
[
nodiscard
]
]
virtual
nsresult
TakeSubTransactions
(
nsTArray
<
RefPtr
<
nsAHttpTransaction
>
>
&
outTransactions
)
=
0
;
virtual
bool
IsNullTransaction
(
)
{
return
false
;
}
virtual
NullHttpTransaction
*
QueryNullTransaction
(
)
{
return
nullptr
;
}
virtual
nsHttpTransaction
*
QueryHttpTransaction
(
)
{
return
nullptr
;
}
virtual
Http2ConnectTransaction
*
QueryHttp2ConnectTransaction
(
)
{
return
nullptr
;
}
virtual
nsIRequestContext
*
RequestContext
(
)
{
return
nullptr
;
}
virtual
nsHttpConnectionInfo
*
ConnectionInfo
(
)
=
0
;
virtual
bool
ResponseTimeoutEnabled
(
)
const
;
virtual
PRIntervalTime
ResponseTimeout
(
)
;
[
[
nodiscard
]
]
virtual
nsresult
GetTransactionSecurityInfo
(
nsISupports
*
*
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
virtual
void
DisableSpdy
(
)
{
}
virtual
void
DisableHttp3
(
bool
aAllowRetryHTTPSRR
)
{
}
virtual
void
MakeNonSticky
(
)
{
}
virtual
void
ReuseConnectionOnRestartOK
(
bool
)
{
}
virtual
void
DoNotRemoveAltSvc
(
)
{
}
[
[
nodiscard
]
]
virtual
bool
Do0RTT
(
)
{
return
false
;
}
[
[
nodiscard
]
]
virtual
nsresult
Finish0RTT
(
bool
aRestart
bool
aAlpnChanged
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
virtual
uint64_t
TopBrowsingContextId
(
)
{
MOZ_ASSERT
(
false
)
;
return
0
;
}
virtual
void
OnProxyConnectComplete
(
int32_t
aResponseCode
)
{
}
virtual
nsresult
FetchHTTPSRR
(
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
virtual
nsresult
OnHTTPSRRAvailable
(
nsIDNSHTTPSSVCRecord
*
aHTTPSSVCRecord
nsISVCBRecord
*
aHighestPriorityRecord
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
}
;
NS_DEFINE_STATIC_IID_ACCESSOR
(
nsAHttpTransaction
NS_AHTTPTRANSACTION_IID
)
#
define
NS_DECL_NSAHTTPTRANSACTION
\
void
SetConnection
(
nsAHttpConnection
*
)
override
;
\
nsAHttpConnection
*
Connection
(
)
override
;
\
void
GetSecurityCallbacks
(
nsIInterfaceRequestor
*
*
)
override
;
\
void
OnTransportStatus
(
nsITransport
*
transport
nsresult
status
\
int64_t
progress
)
override
;
\
bool
IsDone
(
)
override
;
\
nsresult
Status
(
)
override
;
\
uint32_t
Caps
(
)
override
;
\
[
[
nodiscard
]
]
virtual
nsresult
ReadSegments
(
nsAHttpSegmentReader
*
uint32_t
\
uint32_t
*
)
override
;
\
[
[
nodiscard
]
]
virtual
nsresult
WriteSegments
(
nsAHttpSegmentWriter
*
\
uint32_t
uint32_t
*
)
override
;
\
virtual
void
Close
(
nsresult
reason
)
override
;
\
nsHttpConnectionInfo
*
ConnectionInfo
(
)
override
;
\
void
SetProxyConnectFailed
(
)
override
;
\
virtual
nsHttpRequestHead
*
RequestHead
(
)
override
;
\
uint32_t
Http1xTransactionCount
(
)
override
;
\
[
[
nodiscard
]
]
nsresult
TakeSubTransactions
(
\
nsTArray
<
RefPtr
<
nsAHttpTransaction
>
>
&
outTransactions
)
override
;
class
nsAHttpSegmentReader
{
NS_INLINE_DECL_PURE_VIRTUAL_REFCOUNTING
public
:
[
[
nodiscard
]
]
virtual
nsresult
OnReadSegment
(
const
char
*
segment
uint32_t
count
uint32_t
*
countRead
)
=
0
;
[
[
nodiscard
]
]
virtual
nsresult
CommitToSegmentSize
(
uint32_t
size
bool
forceCommitment
)
{
return
NS_ERROR_FAILURE
;
}
}
;
#
define
NS_DECL_NSAHTTPSEGMENTREADER
\
[
[
nodiscard
]
]
nsresult
OnReadSegment
(
const
char
*
uint32_t
uint32_t
*
)
\
override
;
class
nsAHttpSegmentWriter
{
public
:
[
[
nodiscard
]
]
virtual
nsresult
OnWriteSegment
(
char
*
segment
uint32_t
count
uint32_t
*
countWritten
)
=
0
;
}
;
#
define
NS_DECL_NSAHTTPSEGMENTWRITER
\
[
[
nodiscard
]
]
nsresult
OnWriteSegment
(
char
*
uint32_t
uint32_t
*
)
override
;
}
}
#
endif
