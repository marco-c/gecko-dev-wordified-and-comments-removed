#
ifndef
mozilla_net_Http3WebTransportSession_h
#
define
mozilla_net_Http3WebTransportSession_h
#
include
"
ARefBase
.
h
"
#
include
"
Http3StreamBase
.
h
"
#
include
"
nsIWebTransport
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
namespace
mozilla
:
:
net
{
class
Http3Session
;
class
Http3WebTransportSession
final
:
public
Http3StreamBase
public
nsAHttpSegmentWriter
public
nsAHttpSegmentReader
{
public
:
NS_DECL_NSAHTTPSEGMENTWRITER
NS_DECL_NSAHTTPSEGMENTREADER
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
Http3WebTransportSession
override
)
Http3WebTransportSession
(
nsAHttpTransaction
*
Http3Session
*
)
;
Http3WebTransportSession
*
GetHttp3WebTransportSession
(
)
override
{
return
this
;
}
Http3Stream
*
GetHttp3Stream
(
)
override
{
return
nullptr
;
}
[
[
nodiscard
]
]
nsresult
ReadSegments
(
)
override
;
[
[
nodiscard
]
]
nsresult
WriteSegments
(
)
override
;
bool
Done
(
)
const
override
{
return
mRecvState
=
=
RECV_DONE
;
}
void
Close
(
nsresult
aResult
)
override
;
void
SetResponseHeaders
(
nsTArray
<
uint8_t
>
&
aResponseHeaders
bool
fin
bool
interim
)
override
;
void
SetWebTransportSessionEventListener
(
WebTransportSessionEventListener
*
listener
)
{
mListener
=
listener
;
}
nsresult
TryActivating
(
)
;
void
TransactionIsDone
(
nsresult
aResult
)
;
void
CloseSession
(
uint32_t
aStatus
nsACString
&
aReason
)
;
void
OnSessionClosed
(
uint32_t
aStatus
nsACString
&
aReason
)
;
private
:
~
Http3WebTransportSession
(
)
=
default
;
bool
ConsumeHeaders
(
const
char
*
buf
uint32_t
avail
uint32_t
*
countUsed
)
;
enum
RecvStreamState
{
BEFORE_HEADERS
READING_HEADERS
READING_INTERIM_HEADERS
ACTIVE
CLOSE_PENDING
RECV_DONE
}
mRecvState
{
BEFORE_HEADERS
}
;
enum
SendStreamState
{
PREPARING_HEADERS
WAITING_TO_ACTIVATE
SEND_DONE
}
mSendState
{
PREPARING_HEADERS
}
;
nsCString
mFlatHttpRequestHeaders
;
nsTArray
<
uint8_t
>
mFlatResponseHeaders
;
nsresult
mSocketInCondition
=
NS_ERROR_NOT_INITIALIZED
;
nsresult
mSocketOutCondition
=
NS_ERROR_NOT_INITIALIZED
;
RefPtr
<
WebTransportSessionEventListener
>
mListener
;
uint32_t
mStatus
{
0
}
;
nsCString
mReason
;
}
;
}
#
endif
