#
ifndef
ExtensionProtocolHandler_h___
#
define
ExtensionProtocolHandler_h___
#
include
"
mozilla
/
net
/
NeckoParent
.
h
"
#
include
"
mozilla
/
LazyIdleThread
.
h
"
#
include
"
mozilla
/
Result
.
h
"
#
include
"
SubstitutingProtocolHandler
.
h
"
namespace
mozilla
{
namespace
net
{
class
ExtensionStreamGetter
;
class
ExtensionProtocolHandler
final
:
public
nsISubstitutingProtocolHandler
public
SubstitutingProtocolHandler
public
nsSupportsWeakReference
{
public
:
NS_DECL_ISUPPORTS_INHERITED
NS_FORWARD_NSIPROTOCOLHANDLER
(
SubstitutingProtocolHandler
:
:
)
NS_FORWARD_NSISUBSTITUTINGPROTOCOLHANDLER
(
SubstitutingProtocolHandler
:
:
)
static
already_AddRefed
<
ExtensionProtocolHandler
>
GetSingleton
(
)
;
Result
<
nsCOMPtr
<
nsIInputStream
>
nsresult
>
NewStream
(
nsIURI
*
aChildURI
bool
*
aTerminateSender
)
;
Result
<
Ok
nsresult
>
NewFD
(
nsIURI
*
aChildURI
bool
*
aTerminateSender
NeckoParent
:
:
GetExtensionFDResolver
&
aResolve
)
;
protected
:
~
ExtensionProtocolHandler
(
)
=
default
;
private
:
explicit
ExtensionProtocolHandler
(
)
;
[
[
nodiscard
]
]
bool
ResolveSpecialCases
(
const
nsACString
&
aHost
const
nsACString
&
aPath
const
nsACString
&
aPathname
nsACString
&
aResult
)
override
;
[
[
nodiscard
]
]
virtual
nsresult
SubstituteChannel
(
nsIURI
*
uri
nsILoadInfo
*
aLoadInfo
nsIChannel
*
*
result
)
override
;
Result
<
Ok
nsresult
>
SubstituteRemoteChannel
(
nsIURI
*
aURI
nsILoadInfo
*
aLoadInfo
nsIChannel
*
*
aRetVal
)
;
void
SubstituteRemoteFileChannel
(
nsIURI
*
aURI
nsILoadInfo
*
aLoadinfo
nsACString
&
aResolvedFileSpec
nsIChannel
*
*
aRetVal
)
;
Result
<
Ok
nsresult
>
SubstituteRemoteJarChannel
(
nsIURI
*
aURI
nsILoadInfo
*
aLoadinfo
nsACString
&
aResolvedSpec
nsIChannel
*
*
aRetVal
)
;
Result
<
bool
nsresult
>
AllowExternalResource
(
nsIFile
*
aExtensionDir
nsIFile
*
aRequestedFile
)
;
static
void
SetContentType
(
nsIURI
*
aURI
nsIChannel
*
aChannel
)
;
static
void
NewSimpleChannel
(
nsIURI
*
aURI
nsILoadInfo
*
aLoadinfo
ExtensionStreamGetter
*
aStreamGetter
nsIChannel
*
*
aRetVal
)
;
static
void
NewSimpleChannel
(
nsIURI
*
aURI
nsILoadInfo
*
aLoadinfo
nsIChannel
*
aChannel
nsIChannel
*
*
aRetVal
)
;
#
if
defined
(
XP_MACOSX
)
Result
<
bool
nsresult
>
DevRepoContains
(
nsIFile
*
aRequestedFile
)
;
nsCOMPtr
<
nsIFile
>
mDevRepo
;
bool
mAlreadyCheckedDevRepo
{
false
}
;
#
endif
#
if
!
defined
(
XP_WIN
)
Result
<
bool
nsresult
>
AppDirContains
(
nsIFile
*
aExtensionDir
)
;
nsCOMPtr
<
nsIFile
>
mAppDir
;
bool
mAlreadyCheckedAppDir
{
false
}
;
#
endif
RefPtr
<
mozilla
:
:
LazyIdleThread
>
mFileOpenerThread
;
static
StaticRefPtr
<
ExtensionProtocolHandler
>
sSingleton
;
bool
mUseRemoteFileChannels
;
}
;
}
}
#
endif
