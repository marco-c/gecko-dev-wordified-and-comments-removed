#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
nsIHttpProtocolHandler
.
h
"
#
include
"
nsHttp
.
h
"
namespace
mozilla
{
namespace
net
{
TEST
(
TestSupportAlpn
testSvcParamKeyAlpn
)
{
Preferences
:
:
SetBool
(
"
network
.
http
.
http3
.
enabled
"
true
)
;
nsCOMPtr
<
nsIHttpProtocolHandler
>
http
=
do_GetService
(
NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX
"
http
"
)
;
nsTArray
<
nsCString
>
alpn
=
{
"
h3
-
28
"
_ns
"
h3
-
27
"
_ns
"
h2
"
_ns
"
http
/
1
.
1
"
_ns
}
;
Tuple
<
nsCString
bool
>
result
=
SelectAlpnFromAlpnList
(
alpn
false
false
)
;
ASSERT_EQ
(
Get
<
0
>
(
result
)
"
h3
-
28
"
_ns
)
;
ASSERT_EQ
(
Get
<
1
>
(
result
)
true
)
;
alpn
=
{
"
h3
-
26
"
_ns
"
h2
"
_ns
"
http
/
1
.
1
"
_ns
}
;
result
=
SelectAlpnFromAlpnList
(
alpn
false
false
)
;
ASSERT_EQ
(
Get
<
0
>
(
result
)
"
h2
"
_ns
)
;
ASSERT_EQ
(
Get
<
1
>
(
result
)
false
)
;
alpn
=
{
"
h3
-
28
"
_ns
"
h3
-
27
"
_ns
"
h2
"
_ns
"
http
/
1
.
1
"
_ns
}
;
result
=
SelectAlpnFromAlpnList
(
alpn
false
true
)
;
ASSERT_EQ
(
Get
<
0
>
(
result
)
"
h2
"
_ns
)
;
ASSERT_EQ
(
Get
<
1
>
(
result
)
false
)
;
alpn
=
{
"
h3
-
28
"
_ns
"
h3
-
27
"
_ns
"
http
/
1
.
1
"
_ns
}
;
result
=
SelectAlpnFromAlpnList
(
alpn
false
true
)
;
ASSERT_EQ
(
Get
<
0
>
(
result
)
"
http
/
1
.
1
"
_ns
)
;
ASSERT_EQ
(
Get
<
1
>
(
result
)
false
)
;
alpn
=
{
"
h3
-
28
"
_ns
"
h3
-
27
"
_ns
"
h2
"
_ns
"
http
/
1
.
1
"
_ns
}
;
result
=
SelectAlpnFromAlpnList
(
alpn
true
true
)
;
ASSERT_EQ
(
Get
<
0
>
(
result
)
"
http
/
1
.
1
"
_ns
)
;
ASSERT_EQ
(
Get
<
1
>
(
result
)
false
)
;
alpn
=
{
"
h3
-
28
"
_ns
"
h3
-
27
"
_ns
"
h2
"
_ns
}
;
result
=
SelectAlpnFromAlpnList
(
alpn
true
true
)
;
ASSERT_EQ
(
Get
<
0
>
(
result
)
"
"
_ns
)
;
ASSERT_EQ
(
Get
<
1
>
(
result
)
false
)
;
alpn
=
{
"
ftp
"
_ns
"
h2c
"
_ns
}
;
result
=
SelectAlpnFromAlpnList
(
alpn
true
true
)
;
ASSERT_EQ
(
Get
<
0
>
(
result
)
"
"
_ns
)
;
ASSERT_EQ
(
Get
<
1
>
(
result
)
false
)
;
}
}
}
