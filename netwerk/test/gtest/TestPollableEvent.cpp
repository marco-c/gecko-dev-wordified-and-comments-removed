#
include
"
TestCommon
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
gtest
/
MozAssertions
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsISocketTransport
.
h
"
#
include
"
.
.
/
.
.
/
base
/
nsSocketTransportService2
.
h
"
#
include
"
.
.
/
.
.
/
base
/
PollableEvent
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsThreadUtils
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
net
;
TEST
(
TestPollableEvent
ClearDoesNotBlock
)
{
nsCOMPtr
<
nsISocketTransportService
>
service
=
do_GetService
(
"
mozilla
.
org
/
network
/
socket
-
transport
-
service
;
1
"
)
;
ASSERT_TRUE
(
service
)
;
auto
*
sts
=
gSocketTransportService
;
ASSERT_TRUE
(
sts
)
;
NS_DispatchAndSpinEventLoopUntilComplete
(
"
TestPollableEvent
:
:
ClearDoesNotBlock
"
_ns
sts
NS_NewRunnableFunction
(
"
TestPollableEvent
:
:
ClearDoesNotBlock
"
[
&
]
(
)
{
PollableEvent
event
;
ASSERT_TRUE
(
event
.
Valid
(
)
)
;
ASSERT_TRUE
(
event
.
Clear
(
)
)
;
ASSERT_TRUE
(
event
.
Signal
(
)
)
;
ASSERT_TRUE
(
event
.
Clear
(
)
)
;
ASSERT_TRUE
(
event
.
Clear
(
)
)
;
for
(
int
i
=
0
;
i
<
10
;
i
+
+
)
{
ASSERT_TRUE
(
event
.
Signal
(
)
)
;
ASSERT_TRUE
(
event
.
Clear
(
)
)
;
}
}
)
)
;
}
