"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
request_count_checking
"
"
test_hint_preload
"
"
test_hint_preload_internal
"
"
test_preload_hint_and_request
"
]
;
const
{
Assert
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
Assert
.
sys
.
mjs
"
)
;
const
{
BrowserTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
BrowserTestUtils
.
sys
.
mjs
"
)
;
const
{
gBrowser
}
=
Services
.
wm
.
getMostRecentWindow
(
"
navigator
:
browser
"
)
;
async
function
request_count_checking
(
testName
got
expected
)
{
let
g
=
JSON
.
stringify
(
got
)
;
let
e
=
JSON
.
stringify
(
expected
)
;
Assert
.
ok
(
got
.
hinted
=
=
expected
.
hinted
{
testName
}
:
unexpected
amount
of
hinted
request
made
expected
{
expected
.
hinted
}
(
{
e
}
)
got
{
got
.
hinted
}
(
{
g
}
)
)
;
let
expected_normal
=
expected
.
normal
;
Assert
.
ok
(
got
.
normal
=
=
expected_normal
{
testName
}
:
unexpected
amount
of
normal
request
made
expected
{
expected_normal
}
(
{
e
}
)
got
{
got
.
normal
}
(
{
g
}
)
)
;
}
async
function
test_hint_preload
(
testName
requestFrom
imgUrl
expectedRequestCount
uuid
=
undefined
)
{
if
(
uuid
=
=
undefined
)
{
uuid
=
Services
.
uuid
.
generateUUID
(
)
;
}
await
test_hint_preload_internal
(
testName
requestFrom
[
[
imgUrl
uuid
.
toString
(
)
]
]
expectedRequestCount
)
;
}
async
function
test_hint_preload_internal
(
testName
requestFrom
imgUrls
expectedRequestCount
)
{
let
headers
=
new
Headers
(
)
;
headers
.
append
(
"
X
-
Early
-
Hint
-
Count
-
Start
"
"
"
)
;
await
fetch
(
"
http
:
/
/
example
.
com
/
browser
/
netwerk
/
test
/
browser
/
early_hint_pixel_count
.
sjs
"
{
headers
}
)
;
let
requestUrl
=
requestFrom
+
"
/
browser
/
netwerk
/
test
/
browser
/
early_hint_main_html
.
sjs
?
"
+
new
URLSearchParams
(
imgUrls
)
.
toString
(
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
requestUrl
waitForLoad
:
true
}
async
function
(
)
{
}
)
;
let
gotRequestCount
=
await
fetch
(
"
http
:
/
/
example
.
com
/
browser
/
netwerk
/
test
/
browser
/
early_hint_pixel_count
.
sjs
"
)
.
then
(
response
=
>
response
.
json
(
)
)
;
await
request_count_checking
(
testName
gotRequestCount
expectedRequestCount
)
;
}
async
function
test_preload_hint_and_request
(
input
expected_results
)
{
let
headers
=
new
Headers
(
)
;
headers
.
append
(
"
X
-
Early
-
Hint
-
Count
-
Start
"
"
"
)
;
await
fetch
(
"
https
:
/
/
example
.
com
/
browser
/
netwerk
/
test
/
browser
/
early_hint_pixel_count
.
sjs
"
{
headers
}
)
;
let
requestUrl
=
https
:
/
/
example
.
com
/
browser
/
netwerk
/
test
/
browser
/
early_hint_csp_options_html
.
sjs
?
as
=
{
input
.
resource_type
}
&
hinted
=
{
input
.
hinted
?
"
1
"
:
"
0
"
}
{
input
.
csp
?
"
&
csp
=
"
+
input
.
csp
:
"
"
}
{
input
.
csp_in_early_hint
?
"
&
csp_in_early_hint
=
"
+
input
.
csp_in_early_hint
:
"
"
}
{
input
.
host
?
"
&
host
=
"
+
input
.
host
:
"
"
}
;
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
requestUrl
true
)
;
let
gotRequestCount
=
await
fetch
(
"
https
:
/
/
example
.
com
/
browser
/
netwerk
/
test
/
browser
/
early_hint_pixel_count
.
sjs
"
)
.
then
(
response
=
>
response
.
json
(
)
)
;
await
Assert
.
deepEqual
(
gotRequestCount
expected_results
input
.
test_name
)
;
gBrowser
.
removeCurrentTab
(
)
;
Services
.
cache2
.
clear
(
)
;
}
