"
use
strict
"
;
const
{
HttpServer
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
httpd
.
sys
.
mjs
"
)
;
const
TEST_PATH
=
"
/
browser
/
netwerk
/
test
/
browser
/
"
;
let
gServer
;
let
gServerURL
;
let
gConnectionNumberWhenRequested
=
0
;
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
network
.
predictor
.
enable
-
hover
-
on
-
ssl
"
true
]
[
"
network
.
http
.
debug
-
observations
"
true
]
[
"
browser
.
newtabpage
.
activity
-
stream
.
discoverystream
.
imageProxy
.
enabled
"
false
]
]
}
)
;
gServer
=
new
HttpServer
(
)
;
gServer
.
start
(
-
1
)
;
gServerURL
=
http
:
/
/
localhost
:
{
gServer
.
identity
.
primaryPort
}
;
gServer
.
registerPathHandler
(
"
/
target
.
html
"
handleTarget
)
;
registerCleanupFunction
(
async
(
)
=
>
{
await
gServer
.
stop
(
)
;
}
)
;
}
)
;
function
handleTarget
(
request
response
)
{
response
.
setHeader
(
"
Content
-
Type
"
"
text
/
html
"
false
)
;
response
.
setHeader
(
"
Cache
-
Control
"
"
no
-
cache
"
false
)
;
gConnectionNumberWhenRequested
=
response
.
_connection
.
number
;
let
body
=
<
!
DOCTYPE
html
>
<
html
>
<
head
>
<
meta
charset
=
"
UTF
-
8
"
>
<
title
>
Target
Page
<
/
title
>
<
/
head
>
<
body
>
<
h1
>
Target
Page
<
/
h1
>
<
p
>
Connection
:
{
gConnectionNumberWhenRequested
}
<
/
p
>
<
/
body
>
<
/
html
>
;
response
.
write
(
body
)
;
}
function
hoverOverLink
(
browser
linkId
)
{
return
SpecialPowers
.
spawn
(
browser
[
linkId
]
async
id
=
>
{
let
link
=
content
.
document
.
getElementById
(
id
)
;
let
event
=
new
content
.
MouseEvent
(
"
mouseover
"
{
bubbles
:
true
cancelable
:
true
view
:
content
}
)
;
link
.
dispatchEvent
(
event
)
;
}
)
;
}
async
function
clickLink
(
browser
linkId
)
{
let
loadedPromise
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
await
SpecialPowers
.
spawn
(
browser
[
linkId
]
async
id
=
>
{
let
link
=
content
.
document
.
getElementById
(
id
)
;
link
.
click
(
)
;
}
)
;
await
loadedPromise
;
}
add_task
(
async
function
test_link_hover_https_page
(
)
{
let
speculativeConnectObserved
=
false
;
let
observer
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIObserver
"
]
)
observe
(
aSubject
aTopic
aData
)
{
if
(
aTopic
=
=
"
speculative
-
connect
-
request
"
&
&
aData
.
includes
(
"
localhost
"
)
)
{
info
(
"
Observed
speculative
connection
request
for
:
"
+
aData
)
;
speculativeConnectObserved
=
true
;
}
}
}
;
Services
.
obs
.
addObserver
(
observer
"
speculative
-
connect
-
request
"
)
;
const
targetURL
=
encodeURIComponent
(
gServerURL
+
"
/
target
.
html
"
)
;
const
pageURL
=
"
https
:
/
/
example
.
com
"
+
TEST_PATH
+
"
file_link_hover
.
sjs
?
target
=
"
+
targetURL
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
pageURL
waitForLoad
:
true
}
async
function
(
browser
)
{
let
connectionCountBeforeHover
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
before
hover
:
"
+
connectionCountBeforeHover
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
getElementById
(
"
testLink
"
)
"
Waiting
for
link
element
to
be
available
"
)
;
}
)
;
await
hoverOverLink
(
browser
"
testLink
"
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
1000
)
)
;
let
connectionCountAfterHover
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
after
hover
:
"
+
connectionCountAfterHover
)
;
Assert
.
ok
(
speculativeConnectObserved
"
Speculative
connection
should
be
triggered
on
link
hover
"
)
;
await
clickLink
(
browser
"
testLink
"
)
;
let
connectionCountAfterClick
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
after
click
:
"
+
connectionCountAfterClick
)
;
info
(
"
Connection
number
that
handled
the
request
:
"
+
gConnectionNumberWhenRequested
)
;
Assert
.
equal
(
connectionCountAfterClick
connectionCountBeforeHover
+
1
"
Exactly
one
connection
should
be
established
for
the
HTTP
request
"
)
;
Assert
.
equal
(
gConnectionNumberWhenRequested
connectionCountBeforeHover
+
1
"
The
HTTP
request
should
be
handled
by
the
new
connection
"
)
;
}
)
;
Services
.
obs
.
removeObserver
(
observer
"
speculative
-
connect
-
request
"
)
;
}
)
;
add_task
(
async
function
test_link_hover_http_page
(
)
{
let
speculativeConnectObserved
=
false
;
let
observer
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIObserver
"
]
)
observe
(
aSubject
aTopic
aData
)
{
if
(
aTopic
=
=
"
speculative
-
connect
-
request
"
&
&
aData
.
includes
(
"
localhost
"
)
)
{
info
(
"
Observed
speculative
connection
request
for
:
"
+
aData
)
;
speculativeConnectObserved
=
true
;
}
}
}
;
Services
.
obs
.
addObserver
(
observer
"
speculative
-
connect
-
request
"
)
;
const
targetURL
=
encodeURIComponent
(
gServerURL
+
"
/
target
.
html
"
)
;
const
pageURL
=
"
http
:
/
/
example
.
com
"
+
TEST_PATH
+
"
file_link_hover
.
sjs
?
target
=
"
+
targetURL
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
pageURL
waitForLoad
:
true
}
async
function
(
browser
)
{
let
connectionCountBeforeHover
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
before
hover
:
"
+
connectionCountBeforeHover
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
getElementById
(
"
testLink
"
)
"
Waiting
for
link
element
to
be
available
"
)
;
}
)
;
await
hoverOverLink
(
browser
"
testLink
"
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
1000
)
)
;
let
connectionCountAfterHover
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
after
hover
:
"
+
connectionCountAfterHover
)
;
Assert
.
ok
(
speculativeConnectObserved
"
Speculative
connection
should
be
triggered
on
link
hover
from
HTTP
page
"
)
;
await
clickLink
(
browser
"
testLink
"
)
;
let
connectionCountAfterClick
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
after
click
:
"
+
connectionCountAfterClick
)
;
info
(
"
Connection
number
that
handled
the
request
:
"
+
gConnectionNumberWhenRequested
)
;
Assert
.
equal
(
connectionCountAfterClick
connectionCountBeforeHover
+
1
"
Exactly
one
connection
should
be
established
for
the
HTTP
request
"
)
;
Assert
.
equal
(
gConnectionNumberWhenRequested
connectionCountBeforeHover
+
1
"
The
HTTP
request
should
be
handled
by
the
new
connection
"
)
;
}
)
;
Services
.
obs
.
removeObserver
(
observer
"
speculative
-
connect
-
request
"
)
;
}
)
;
add_task
(
async
function
test_link_hover_https_page_pref_disabled
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
network
.
predictor
.
enable
-
hover
-
on
-
ssl
"
false
]
]
}
)
;
let
speculativeConnectObserved
=
false
;
let
observer
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIObserver
"
]
)
observe
(
aSubject
aTopic
aData
)
{
if
(
aTopic
=
=
"
speculative
-
connect
-
request
"
&
&
aData
.
includes
(
"
localhost
"
)
)
{
info
(
"
Observed
speculative
connection
request
for
:
"
+
aData
)
;
speculativeConnectObserved
=
true
;
}
}
}
;
Services
.
obs
.
addObserver
(
observer
"
speculative
-
connect
-
request
"
)
;
const
targetURL
=
encodeURIComponent
(
gServerURL
+
"
/
target
.
html
"
)
;
const
pageURL
=
"
https
:
/
/
example
.
com
"
+
TEST_PATH
+
"
file_link_hover
.
sjs
?
target
=
"
+
targetURL
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
pageURL
waitForLoad
:
true
}
async
function
(
browser
)
{
let
connectionCountBeforeHover
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
before
hover
:
"
+
connectionCountBeforeHover
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
getElementById
(
"
testLink
"
)
"
Waiting
for
link
element
to
be
available
"
)
;
}
)
;
await
hoverOverLink
(
browser
"
testLink
"
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
1000
)
)
;
let
connectionCountAfterHover
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
after
hover
:
"
+
connectionCountAfterHover
)
;
Assert
.
ok
(
!
speculativeConnectObserved
"
Speculative
connection
should
NOT
be
triggered
on
link
hover
from
HTTPS
page
when
pref
is
disabled
"
)
;
await
clickLink
(
browser
"
testLink
"
)
;
let
connectionCountAfterClick
=
gServer
.
connectionNumber
;
info
(
"
Connection
count
after
click
:
"
+
connectionCountAfterClick
)
;
Assert
.
equal
(
connectionCountAfterClick
connectionCountBeforeHover
+
1
"
Exactly
one
connection
should
be
established
(
from
the
click
not
hover
)
"
)
;
}
)
;
Services
.
obs
.
removeObserver
(
observer
"
speculative
-
connect
-
request
"
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
