function
run_test
(
)
{
var
storage
=
getCacheStorage
(
"
disk
"
)
;
var
lcis
=
[
LoadContextInfo
.
default
LoadContextInfo
.
custom
(
false
{
userContextId
:
1
}
)
LoadContextInfo
.
custom
(
false
{
userContextId
:
2
}
)
LoadContextInfo
.
custom
(
false
{
userContextId
:
3
}
)
]
;
do_get_profile
(
)
;
if
(
!
newCacheBackEndUsed
(
)
)
{
do_check_true
(
true
"
This
test
checks
only
cache2
specific
behavior
.
"
)
;
return
;
}
var
mc
=
new
MultipleCallbacks
(
8
function
(
)
{
do_execute_soon
(
function
(
)
{
var
expectedConsumption
=
8192
;
var
entries
=
[
{
uri
:
"
http
:
/
/
a
/
"
lci
:
lcis
[
0
]
}
{
uri
:
"
http
:
/
/
b
/
"
lci
:
lcis
[
0
]
}
{
uri
:
"
http
:
/
/
a
/
"
lci
:
lcis
[
1
]
}
{
uri
:
"
http
:
/
/
b
/
"
lci
:
lcis
[
1
]
}
{
uri
:
"
http
:
/
/
a
/
"
lci
:
lcis
[
2
]
}
{
uri
:
"
http
:
/
/
b
/
"
lci
:
lcis
[
2
]
}
{
uri
:
"
http
:
/
/
a
/
"
lci
:
lcis
[
3
]
}
{
uri
:
"
http
:
/
/
b
/
"
lci
:
lcis
[
3
]
}
]
;
get_cache_service
(
)
.
asyncVisitAllStorages
(
new
VisitCallback
(
8
expectedConsumption
entries
function
(
)
{
get_cache_service
(
)
.
asyncVisitAllStorages
(
new
VisitCallback
(
8
expectedConsumption
null
function
(
)
{
finish_cache2_test
(
)
;
}
)
false
)
;
}
)
true
)
;
}
)
;
}
true
)
;
for
(
var
i
=
0
;
i
<
lcis
.
length
;
i
+
+
)
{
asyncOpenCacheEntry
(
"
http
:
/
/
a
/
"
"
disk
"
Ci
.
nsICacheStorage
.
OPEN_NORMALLY
lcis
[
i
]
new
OpenCallback
(
NEW
"
a1m
"
"
a1d
"
function
(
entry
)
{
asyncOpenCacheEntry
(
"
http
:
/
/
a
/
"
"
disk
"
Ci
.
nsICacheStorage
.
OPEN_NORMALLY
lcis
[
i
]
new
OpenCallback
(
NORMAL
"
a1m
"
"
a1d
"
function
(
entry
)
{
mc
.
fired
(
)
;
}
)
)
;
}
)
)
;
asyncOpenCacheEntry
(
"
http
:
/
/
b
/
"
"
disk
"
Ci
.
nsICacheStorage
.
OPEN_NORMALLY
lcis
[
i
]
new
OpenCallback
(
NEW
"
b1m
"
"
b1d
"
function
(
entry
)
{
asyncOpenCacheEntry
(
"
http
:
/
/
b
/
"
"
disk
"
Ci
.
nsICacheStorage
.
OPEN_NORMALLY
lcis
[
i
]
new
OpenCallback
(
NORMAL
"
b1m
"
"
b1d
"
function
(
entry
)
{
mc
.
fired
(
)
;
}
)
)
;
}
)
)
;
}
do_test_pending
(
)
;
}
