"
use
strict
"
;
function
make_channel
(
url
)
{
return
NetUtil
.
newChannel
(
{
uri
:
url
loadUsingSystemPrincipal
:
true
}
)
.
QueryInterface
(
Ci
.
nsIHttpChannel
)
;
}
function
getCookieStringFromPrivateDocument
(
uriSpec
)
{
return
CookieXPCShellUtils
.
getCookieStringFromDocument
(
uriSpec
{
privateBrowsing
:
true
}
)
;
}
add_task
(
async
(
)
=
>
{
let
profile
=
do_get_profile
(
)
;
Services
.
prefs
.
setBoolPref
(
"
network
.
cookieJarSettings
.
unblocked_for_testing
"
true
)
;
Services
.
prefs
.
setIntPref
(
"
network
.
cookie
.
cookieBehavior
"
0
)
;
CookieXPCShellUtils
.
createServer
(
{
hosts
:
[
"
foo
.
com
"
"
bar
.
com
"
]
}
)
;
const
privateBrowsingHolder
=
await
CookieXPCShellUtils
.
loadContentPage
(
"
http
:
/
/
bar
.
com
/
"
{
privateBrowsing
:
true
}
)
;
let
uri1
=
NetUtil
.
newURI
(
"
http
:
/
/
foo
.
com
/
foo
.
html
"
)
;
let
uri2
=
NetUtil
.
newURI
(
"
http
:
/
/
bar
.
com
/
bar
.
html
"
)
;
Services
.
cookiesvc
.
setCookieStringFromHttp
(
uri1
"
oh
=
hai
;
max
-
age
=
1000
"
make_channel
(
uri1
.
spec
)
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri1
.
host
)
1
)
;
var
chan1
=
make_channel
(
uri1
.
spec
)
;
chan1
.
QueryInterface
(
Ci
.
nsIPrivateBrowsingChannel
)
;
chan1
.
setPrivate
(
true
)
;
var
chan2
=
make_channel
(
uri2
.
spec
)
;
chan2
.
QueryInterface
(
Ci
.
nsIPrivateBrowsingChannel
)
;
chan2
.
setPrivate
(
true
)
;
Services
.
cookiesvc
.
setCookieStringFromHttp
(
uri2
"
oh
=
hai
;
max
-
age
=
1000
"
chan2
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri1
.
spec
)
"
"
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri2
.
spec
)
"
oh
=
hai
"
)
;
Services
.
obs
.
notifyObservers
(
null
"
last
-
pb
-
context
-
exited
"
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri1
.
spec
)
"
"
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri2
.
spec
)
"
"
)
;
Services
.
cookiesvc
.
setCookieStringFromHttp
(
uri2
"
oh
=
hai
;
max
-
age
=
1000
"
chan2
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri2
.
spec
)
"
oh
=
hai
"
)
;
Services
.
obs
.
notifyObservers
(
null
"
last
-
pb
-
context
-
exited
"
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri1
.
host
)
1
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri2
.
host
)
0
)
;
await
promise_close_profile
(
)
;
do_load_profile
(
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri1
.
host
)
1
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri2
.
host
)
0
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri1
.
spec
)
"
"
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri2
.
spec
)
"
"
)
;
Services
.
cookiesvc
.
setCookieStringFromHttp
(
uri2
"
oh
=
hai
;
max
-
age
=
1000
"
chan2
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri2
.
spec
)
"
oh
=
hai
"
)
;
await
promise_close_profile
(
)
;
do_load_profile
(
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri1
.
spec
)
"
"
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri2
.
spec
)
"
"
)
;
Services
.
obs
.
notifyObservers
(
null
"
last
-
pb
-
context
-
exited
"
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri1
.
host
)
1
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri2
.
host
)
0
)
;
await
promise_close_profile
(
)
;
await
promise_load_profile
(
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri1
.
spec
)
"
"
)
;
Assert
.
equal
(
await
getCookieStringFromPrivateDocument
(
uri2
.
spec
)
"
"
)
;
Services
.
obs
.
notifyObservers
(
null
"
last
-
pb
-
context
-
exited
"
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri1
.
host
)
1
)
;
Assert
.
equal
(
Services
.
cookiemgr
.
countCookiesFromHost
(
uri2
.
host
)
0
)
;
privateBrowsingHolder
.
close
(
)
;
}
)
;
