add_task
(
async
function
test_url_failure
(
)
{
let
validUrl
=
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
com
/
"
)
;
Assert
.
equal
(
validUrl
.
host
"
example
.
com
"
)
;
let
validUrl2
=
Services
.
io
.
newURI
(
"
https
:
/
/
1
.
2
.
3
.
4
"
)
;
Assert
.
equal
(
validUrl2
.
host
"
1
.
2
.
3
.
4
"
)
;
try
{
Assert
.
throws
(
(
)
=
>
{
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
0
"
)
;
}
/
NS_ERROR_MALFORMED_URI
/
"
non
-
ipv3
ending
in
number
throws
"
)
;
}
catch
{
}
}
)
;
add_task
(
async
function
test_migrate_invalid_cookie
(
)
{
let
profile
=
do_get_profile
(
)
;
let
dbFile
=
do_get_cookie_file
(
profile
)
;
Assert
.
ok
(
!
dbFile
.
exists
(
)
)
;
let
schema12db
=
new
CookieDatabaseConnection
(
dbFile
12
)
;
let
now
=
Date
.
now
(
)
*
1000
;
let
futureExpiry
=
Math
.
round
(
now
/
1e6
+
1000
)
;
let
cookie1
=
new
Cookie
(
"
cookie
-
name1
"
"
cookie
-
value1
"
"
cookie
-
host1
.
com
"
"
/
"
futureExpiry
now
now
false
false
false
)
;
let
badcookie
=
new
Cookie
(
"
cookie
-
name
"
"
cookie
-
value
"
"
cookie
-
host
.
0
"
"
/
"
futureExpiry
now
now
false
false
false
)
;
let
cookie2
=
new
Cookie
(
"
cookie
-
name2
"
"
cookie
-
value2
"
"
cookie
-
host2
.
com
"
"
/
"
futureExpiry
now
now
false
false
false
)
;
schema12db
.
insertCookie
(
cookie1
)
;
schema12db
.
insertCookie
(
badcookie
)
;
schema12db
.
insertCookie
(
cookie2
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
)
3
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
"
cookie
-
host1
.
com
"
)
1
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
"
cookie
-
host2
.
com
"
)
1
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
"
cookie
-
host
.
0
"
)
1
)
;
let
cookie1Exists
=
false
;
let
cookie2Exists
=
false
;
let
badcookieExists
=
false
;
for
(
let
cookie
of
Services
.
cookies
.
cookies
)
{
if
(
cookie
.
host
=
=
"
cookie
-
host1
.
com
"
)
{
cookie1Exists
=
true
;
}
if
(
cookie
.
host
=
=
"
cookie
-
host2
.
com
"
)
{
cookie2Exists
=
true
;
}
if
(
cookie
.
host
=
=
"
cookie
-
host
.
0
"
)
{
badcookieExists
=
true
;
}
}
Assert
.
ok
(
cookie1Exists
"
Cookie
1
was
inadvertently
removed
"
)
;
Assert
.
ok
(
cookie2Exists
"
Cookie
2
was
inadvertently
removed
"
)
;
Assert
.
ok
(
!
badcookieExists
"
Bad
cookie
was
not
filtered
by
migration
"
)
;
Assert
.
equal
(
schema12db
.
db
.
schemaVersion
13
)
;
await
promise_close_profile
(
)
;
do_load_profile
(
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
)
2
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
"
cookie
-
host1
.
com
"
)
1
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
"
cookie
-
host2
.
com
"
)
1
)
;
Assert
.
equal
(
do_count_cookies_in_db
(
schema12db
.
db
"
cookie
-
host
.
0
"
)
0
)
;
schema12db
.
close
(
)
;
}
)
;
