load
(
"
.
.
/
unit
/
test_http3_prio_helpers
.
js
"
)
;
if
(
!
inChildProcess
(
)
)
{
registerCleanupFunction
(
async
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
network
.
http
.
http3
.
priority
"
)
;
Services
.
prefs
.
clearUserPref
(
"
network
.
http
.
priority_header
.
enabled
"
)
;
http3_clear_prefs
(
)
;
}
)
;
}
add_task
(
async
function
setup
(
)
{
if
(
!
inChildProcess
(
)
)
{
await
http3_setup_tests
(
"
h3
-
29
"
)
;
}
}
)
;
async
function
test_http3_prio_enabled
(
incremental
)
{
await
test_flag_priority
(
"
enabled
(
none
)
"
null
"
u
=
4
"
null
false
)
;
await
test_flag_priority
(
"
enabled
(
urgent_start
)
"
Ci
.
nsIClassOfService
.
UrgentStart
"
u
=
1
"
incremental
incremental
)
;
await
test_flag_priority
(
"
enabled
(
leader
)
"
Ci
.
nsIClassOfService
.
Leader
"
u
=
2
"
incremental
incremental
)
;
await
test_flag_priority
(
"
enabled
(
unblocked
)
"
Ci
.
nsIClassOfService
.
Unblocked
null
incremental
incremental
?
incremental
:
null
)
;
await
test_flag_priority
(
"
enabled
(
follower
)
"
Ci
.
nsIClassOfService
.
Follower
"
u
=
4
"
incremental
incremental
)
;
await
test_flag_priority
(
"
enabled
(
speculative
)
"
Ci
.
nsIClassOfService
.
Speculative
"
u
=
6
"
incremental
incremental
)
;
await
test_flag_priority
(
"
enabled
(
background
)
"
Ci
.
nsIClassOfService
.
Background
"
u
=
6
"
incremental
incremental
)
;
await
test_flag_priority
(
"
enabled
(
tail
)
"
Ci
.
nsIClassOfService
.
Tail
"
u
=
6
"
incremental
incremental
)
;
}
add_task
(
async
function
test_http3_prio_enabled_incremental_true
(
)
{
if
(
!
inChildProcess
(
)
)
{
Services
.
prefs
.
setBoolPref
(
"
network
.
http
.
http3
.
priority
"
true
)
;
Services
.
prefs
.
setBoolPref
(
"
network
.
http
.
priority_header
.
enabled
"
true
)
;
}
await
test_http3_prio_enabled
(
true
)
;
}
)
;
add_task
(
async
function
test_http3_prio_enabled_incremental_false
(
)
{
if
(
!
inChildProcess
(
)
)
{
Services
.
prefs
.
setBoolPref
(
"
network
.
http
.
http3
.
priority
"
true
)
;
Services
.
prefs
.
setBoolPref
(
"
network
.
http
.
priority_header
.
enabled
"
true
)
;
}
await
test_http3_prio_enabled
(
false
)
;
}
)
;
