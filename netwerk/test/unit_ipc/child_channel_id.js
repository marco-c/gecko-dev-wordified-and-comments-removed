ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
NetUtil
.
jsm
"
)
;
let
shouldQuit
=
false
;
function
run_test
(
)
{
do_timeout
(
100
function
keepAlive
(
)
{
if
(
!
shouldQuit
)
{
do_timeout
(
100
keepAlive
)
;
}
}
)
;
}
function
makeRequest
(
uri
)
{
let
requestChannel
=
NetUtil
.
newChannel
(
{
uri
loadUsingSystemPrincipal
:
true
}
)
;
requestChannel
.
asyncOpen2
(
new
ChannelListener
(
checkResponse
requestChannel
)
)
;
requestChannel
.
QueryInterface
(
Ci
.
nsIHttpChannel
)
;
dump
(
Child
opened
request
:
{
uri
}
channelId
=
{
requestChannel
.
channelId
}
\
n
)
;
}
function
checkResponse
(
request
buffer
requestChannel
)
{
requestChannel
.
QueryInterface
(
Ci
.
nsIHttpChannel
)
;
do_send_remote_message
(
request
:
{
requestChannel
.
channelId
}
)
;
let
responseChannel
=
request
.
QueryInterface
(
Ci
.
nsIHttpChannel
)
;
let
uri
=
responseChannel
.
URI
.
spec
;
let
origUri
=
responseChannel
.
originalURI
.
spec
;
let
id
=
responseChannel
.
channelId
;
dump
(
Child
got
response
to
:
{
uri
}
(
orig
=
{
origUri
}
)
channelId
=
{
id
}
\
n
)
;
do_send_remote_message
(
response
:
{
id
}
)
;
}
function
finish
(
)
{
shouldQuit
=
true
;
}
