#
include
"
TRRServiceBase
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
nsIOService
.
h
"
namespace
mozilla
{
namespace
net
{
#
undef
LOG
extern
mozilla
:
:
LazyLogModule
gHostResolverLog
;
#
define
LOG
(
args
)
MOZ_LOG
(
gHostResolverLog
mozilla
:
:
LogLevel
:
:
Debug
args
)
TRRServiceBase
:
:
TRRServiceBase
(
)
:
mMode
(
0
)
mURISetByDetection
(
false
)
{
}
void
TRRServiceBase
:
:
ProcessURITemplate
(
nsACString
&
aURI
)
{
if
(
aURI
.
IsEmpty
(
)
)
{
return
;
}
nsAutoCString
scheme
;
nsCOMPtr
<
nsIIOService
>
ios
(
do_GetIOService
(
)
)
;
if
(
ios
)
{
ios
-
>
ExtractScheme
(
aURI
scheme
)
;
}
if
(
!
scheme
.
Equals
(
"
https
"
)
)
{
LOG
(
(
"
TRRService
TRR
URI
%
s
is
not
https
.
Not
used
.
\
n
"
PromiseFlatCString
(
aURI
)
.
get
(
)
)
)
;
aURI
.
Truncate
(
)
;
return
;
}
nsAutoCString
uri
(
aURI
)
;
do
{
nsCCharSeparatedTokenizer
openBrace
(
uri
'
{
'
)
;
if
(
openBrace
.
hasMoreTokens
(
)
)
{
nsAutoCString
prefix
(
openBrace
.
nextToken
(
)
)
;
const
nsACString
&
endBrace
=
openBrace
.
nextToken
(
)
;
nsCCharSeparatedTokenizer
closeBrace
(
endBrace
'
}
'
)
;
if
(
closeBrace
.
hasMoreTokens
(
)
)
{
closeBrace
.
nextToken
(
)
;
nsAutoCString
suffix
(
closeBrace
.
nextToken
(
)
)
;
uri
=
prefix
+
suffix
;
}
else
{
break
;
}
}
else
{
break
;
}
}
while
(
true
)
;
aURI
=
uri
;
}
void
TRRServiceBase
:
:
CheckURIPrefs
(
)
{
mURISetByDetection
=
false
;
if
(
mURIPrefHasUserValue
)
{
MaybeSetPrivateURI
(
mURIPref
)
;
return
;
}
if
(
!
mRolloutURIPref
.
IsEmpty
(
)
)
{
MaybeSetPrivateURI
(
mRolloutURIPref
)
;
return
;
}
MaybeSetPrivateURI
(
mURIPref
)
;
}
uint32_t
ModeFromPrefs
(
)
{
auto
processPrefValue
=
[
]
(
uint32_t
value
)
-
>
uint32_t
{
if
(
value
=
=
MODE_RESERVED1
|
|
value
=
=
MODE_RESERVED4
|
|
value
>
MODE_TRROFF
)
{
return
MODE_TRROFF
;
}
return
value
;
}
;
uint32_t
tmp
=
MODE_NATIVEONLY
;
if
(
NS_SUCCEEDED
(
Preferences
:
:
GetUint
(
"
network
.
trr
.
mode
"
&
tmp
)
)
)
{
tmp
=
processPrefValue
(
tmp
)
;
}
if
(
tmp
!
=
MODE_NATIVEONLY
)
{
return
tmp
;
}
if
(
NS_SUCCEEDED
(
Preferences
:
:
GetUint
(
kRolloutModePref
&
tmp
)
)
)
{
return
processPrefValue
(
tmp
)
;
}
return
MODE_NATIVEONLY
;
}
void
TRRServiceBase
:
:
OnTRRModeChange
(
)
{
uint32_t
oldMode
=
mMode
;
mMode
=
ModeFromPrefs
(
)
;
if
(
mMode
!
=
oldMode
)
{
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
obs
)
{
obs
-
>
NotifyObservers
(
nullptr
NS_NETWORK_TRR_MODE_CHANGED_TOPIC
nullptr
)
;
}
}
static
bool
readHosts
=
false
;
if
(
(
mMode
=
=
2
|
|
mMode
=
=
3
)
&
&
!
readHosts
)
{
readHosts
=
true
;
ReadEtcHostsFile
(
)
;
}
}
void
TRRServiceBase
:
:
OnTRRURIChange
(
)
{
mURIPrefHasUserValue
=
Preferences
:
:
HasUserValue
(
"
network
.
trr
.
uri
"
)
;
Preferences
:
:
GetCString
(
"
network
.
trr
.
uri
"
mURIPref
)
;
Preferences
:
:
GetCString
(
kRolloutURIPref
mRolloutURIPref
)
;
CheckURIPrefs
(
)
;
}
}
}
