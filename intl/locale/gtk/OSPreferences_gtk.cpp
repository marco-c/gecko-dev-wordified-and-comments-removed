#
include
<
locale
.
h
>
#
include
"
OSPreferences
.
h
"
#
include
"
unicode
/
uloc
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsIGSettingsService
.
h
"
using
namespace
mozilla
:
:
intl
;
OSPreferences
:
:
OSPreferences
(
)
=
default
;
bool
OSPreferences
:
:
ReadSystemLocales
(
nsTArray
<
nsCString
>
&
aLocaleList
)
{
MOZ_ASSERT
(
aLocaleList
.
IsEmpty
(
)
)
;
nsAutoCString
defaultLang
(
uloc_getDefault
(
)
)
;
if
(
CanonicalizeLanguageTag
(
defaultLang
)
)
{
aLocaleList
.
AppendElement
(
defaultLang
)
;
return
true
;
}
return
false
;
}
bool
OSPreferences
:
:
ReadRegionalPrefsLocales
(
nsTArray
<
nsCString
>
&
aLocaleList
)
{
MOZ_ASSERT
(
aLocaleList
.
IsEmpty
(
)
)
;
nsAutoCString
localeStr
(
setlocale
(
LC_TIME
nullptr
)
)
;
if
(
CanonicalizeLanguageTag
(
localeStr
)
)
{
aLocaleList
.
AppendElement
(
localeStr
)
;
return
true
;
}
return
false
;
}
static
int
HourCycle
(
)
{
int
rval
=
0
;
nsAutoCString
schema
;
nsAutoCString
key
;
const
char
*
env
=
getenv
(
"
XDG_CURRENT_DESKTOP
"
)
;
if
(
env
&
&
strcmp
(
env
"
Unity
"
)
=
=
0
)
{
schema
=
"
com
.
canonical
.
indicator
.
datetime
"
;
key
=
"
time
-
format
"
;
}
else
{
schema
=
"
org
.
gnome
.
desktop
.
interface
"
;
key
=
"
clock
-
format
"
;
}
nsCOMPtr
<
nsIGSettingsService
>
gsettings
=
do_GetService
(
NS_GSETTINGSSERVICE_CONTRACTID
)
;
nsCOMPtr
<
nsIGSettingsCollection
>
desktop_settings
;
if
(
gsettings
)
{
gsettings
-
>
GetCollectionForSchema
(
schema
getter_AddRefs
(
desktop_settings
)
)
;
if
(
desktop_settings
)
{
nsAutoCString
result
;
desktop_settings
-
>
GetString
(
key
result
)
;
if
(
result
=
=
"
12h
"
)
{
rval
=
12
;
}
else
if
(
result
=
=
"
24h
"
)
{
rval
=
24
;
}
}
}
return
rval
;
}
bool
OSPreferences
:
:
ReadDateTimePattern
(
DateTimeFormatStyle
aDateStyle
DateTimeFormatStyle
aTimeStyle
const
nsACString
&
aLocale
nsACString
&
aRetVal
)
{
nsAutoCString
skeleton
;
if
(
!
GetDateTimeSkeletonForStyle
(
aDateStyle
aTimeStyle
aLocale
skeleton
)
)
{
return
false
;
}
int
hourCycle
=
HourCycle
(
)
;
if
(
hourCycle
=
=
12
|
|
hourCycle
=
=
24
)
{
OverrideSkeletonHourCycle
(
hourCycle
=
=
24
skeleton
)
;
}
if
(
!
GetPatternForSkeleton
(
skeleton
aLocale
aRetVal
)
)
{
return
false
;
}
return
true
;
}
void
OSPreferences
:
:
RemoveObservers
(
)
{
}
