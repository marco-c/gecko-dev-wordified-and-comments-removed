#
include
"
LocaleService
.
h
"
#
include
<
algorithm
>
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
Omnijar
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
mozilla
/
intl
/
Locale
.
h
"
#
include
"
mozilla
/
intl
/
OSPreferences
.
h
"
#
include
"
nsIObserverService
.
h
"
#
include
"
nsIToolkitChromeRegistry
.
h
"
#
include
"
nsStringEnumerator
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
include
"
nsZipArchive
.
h
"
#
include
"
unicode
/
uloc
.
h
"
#
define
INTL_SYSTEM_LOCALES_CHANGED
"
intl
:
system
-
locales
-
changed
"
#
define
REQUESTED_LOCALES_PREF
"
intl
.
locale
.
requested
"
static
const
char
*
kObservedPrefs
[
]
=
{
REQUESTED_LOCALES_PREF
nullptr
}
;
using
namespace
mozilla
:
:
intl
;
using
namespace
mozilla
;
NS_IMPL_ISUPPORTS
(
LocaleService
mozILocaleService
nsIObserver
nsISupportsWeakReference
)
mozilla
:
:
StaticRefPtr
<
LocaleService
>
LocaleService
:
:
sInstance
;
static
bool
SanitizeForBCP47
(
nsACString
&
aLocale
bool
strict
)
{
const
int32_t
LANG_TAG_CAPACITY
=
128
;
char
langTag
[
LANG_TAG_CAPACITY
]
;
nsAutoCString
locale
(
aLocale
)
;
locale
.
Trim
(
"
"
)
;
UErrorCode
err
=
U_ZERO_ERROR
;
int32_t
len
=
uloc_toLanguageTag
(
locale
.
get
(
)
langTag
LANG_TAG_CAPACITY
strict
&
err
)
;
if
(
U_SUCCESS
(
err
)
&
&
len
>
0
)
{
aLocale
.
Assign
(
langTag
len
)
;
}
return
U_SUCCESS
(
err
)
;
}
static
bool
ReadRequestedLocales
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
nsAutoCString
str
;
nsresult
rv
=
Preferences
:
:
GetCString
(
REQUESTED_LOCALES_PREF
str
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
if
(
str
.
Length
(
)
>
0
)
{
for
(
const
nsACString
&
part
:
str
.
Split
(
'
'
)
)
{
nsAutoCString
locale
(
part
)
;
if
(
locale
.
EqualsLiteral
(
"
ja
-
JP
-
mac
"
)
)
{
if
(
!
aRetVal
.
Contains
(
locale
)
)
{
aRetVal
.
AppendElement
(
locale
)
;
}
}
else
if
(
SanitizeForBCP47
(
locale
true
)
)
{
if
(
!
aRetVal
.
Contains
(
locale
)
)
{
aRetVal
.
AppendElement
(
locale
)
;
}
}
}
}
else
{
OSPreferences
:
:
GetInstance
(
)
-
>
GetSystemLocales
(
aRetVal
)
;
}
}
else
{
nsAutoCString
defaultLocale
;
LocaleService
:
:
GetInstance
(
)
-
>
GetDefaultLocale
(
defaultLocale
)
;
aRetVal
.
AppendElement
(
defaultLocale
)
;
}
LocaleService
:
:
GetInstance
(
)
-
>
GetLastFallbackLocale
(
str
)
;
if
(
!
aRetVal
.
Contains
(
str
)
)
{
aRetVal
.
AppendElement
(
str
)
;
}
return
true
;
}
static
bool
ReadAvailableLocales
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
nsCOMPtr
<
nsIToolkitChromeRegistry
>
cr
=
mozilla
:
:
services
:
:
GetToolkitChromeRegistryService
(
)
;
if
(
!
cr
)
{
return
false
;
}
nsCOMPtr
<
nsIUTF8StringEnumerator
>
localesEnum
;
nsresult
rv
=
cr
-
>
GetLocalesForPackage
(
NS_LITERAL_CSTRING
(
"
global
"
)
getter_AddRefs
(
localesEnum
)
)
;
if
(
!
NS_SUCCEEDED
(
rv
)
)
{
return
false
;
}
bool
more
;
while
(
NS_SUCCEEDED
(
rv
=
localesEnum
-
>
HasMore
(
&
more
)
)
&
&
more
)
{
nsAutoCString
localeStr
;
rv
=
localesEnum
-
>
GetNext
(
localeStr
)
;
if
(
!
NS_SUCCEEDED
(
rv
)
)
{
return
false
;
}
aRetVal
.
AppendElement
(
localeStr
)
;
}
return
!
aRetVal
.
IsEmpty
(
)
;
}
LocaleService
:
:
LocaleService
(
bool
aIsServer
)
:
mIsServer
(
aIsServer
)
{
}
void
LocaleService
:
:
NegotiateAppLocales
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
nsAutoCString
defaultLocale
;
GetDefaultLocale
(
defaultLocale
)
;
if
(
mIsServer
)
{
AutoTArray
<
nsCString
100
>
availableLocales
;
AutoTArray
<
nsCString
10
>
requestedLocales
;
GetAvailableLocales
(
availableLocales
)
;
GetRequestedLocales
(
requestedLocales
)
;
NegotiateLanguages
(
requestedLocales
availableLocales
defaultLocale
LangNegStrategy
:
:
Filtering
aRetVal
)
;
}
else
{
aRetVal
.
AppendElement
(
defaultLocale
)
;
}
}
LocaleService
*
LocaleService
:
:
GetInstance
(
)
{
if
(
!
sInstance
)
{
sInstance
=
new
LocaleService
(
XRE_IsParentProcess
(
)
)
;
if
(
sInstance
-
>
IsServer
(
)
)
{
DebugOnly
<
nsresult
>
rv
=
Preferences
:
:
AddWeakObservers
(
sInstance
kObservedPrefs
)
;
MOZ_ASSERT
(
NS_SUCCEEDED
(
rv
)
"
Adding
observers
failed
.
"
)
;
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
obs
)
{
obs
-
>
AddObserver
(
sInstance
INTL_SYSTEM_LOCALES_CHANGED
true
)
;
}
}
ClearOnShutdown
(
&
sInstance
ShutdownPhase
:
:
Shutdown
)
;
}
return
sInstance
;
}
LocaleService
:
:
~
LocaleService
(
)
{
if
(
mIsServer
)
{
Preferences
:
:
RemoveObservers
(
this
kObservedPrefs
)
;
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
obs
)
{
obs
-
>
RemoveObserver
(
this
INTL_SYSTEM_LOCALES_CHANGED
)
;
}
}
}
void
LocaleService
:
:
GetAppLocalesAsLangTags
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
if
(
mAppLocales
.
IsEmpty
(
)
)
{
NegotiateAppLocales
(
mAppLocales
)
;
}
aRetVal
=
mAppLocales
;
}
void
LocaleService
:
:
GetAppLocalesAsBCP47
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
if
(
mAppLocales
.
IsEmpty
(
)
)
{
NegotiateAppLocales
(
mAppLocales
)
;
}
for
(
uint32_t
i
=
0
;
i
<
mAppLocales
.
Length
(
)
;
i
+
+
)
{
nsAutoCString
locale
(
mAppLocales
[
i
]
)
;
SanitizeForBCP47
(
locale
false
)
;
aRetVal
.
AppendElement
(
locale
)
;
}
}
void
LocaleService
:
:
GetRegionalPrefsLocales
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
bool
useOSLocales
=
Preferences
:
:
GetBool
(
"
intl
.
regional_prefs
.
use_os_locales
"
false
)
;
if
(
useOSLocales
)
{
if
(
OSPreferences
:
:
GetInstance
(
)
-
>
GetRegionalPrefsLocales
(
aRetVal
)
)
{
return
;
}
GetAppLocalesAsBCP47
(
aRetVal
)
;
return
;
}
nsAutoCString
appLocale
;
AutoTArray
<
nsCString
10
>
regionalPrefsLocales
;
LocaleService
:
:
GetInstance
(
)
-
>
GetAppLocaleAsBCP47
(
appLocale
)
;
if
(
!
OSPreferences
:
:
GetInstance
(
)
-
>
GetRegionalPrefsLocales
(
regionalPrefsLocales
)
)
{
GetAppLocalesAsBCP47
(
aRetVal
)
;
return
;
}
if
(
LocaleService
:
:
LanguagesMatch
(
appLocale
regionalPrefsLocales
[
0
]
)
)
{
aRetVal
=
regionalPrefsLocales
;
return
;
}
GetAppLocalesAsBCP47
(
aRetVal
)
;
}
void
LocaleService
:
:
AssignAppLocales
(
const
nsTArray
<
nsCString
>
&
aAppLocales
)
{
MOZ_ASSERT
(
!
mIsServer
"
This
should
only
be
called
for
LocaleService
in
client
mode
.
"
)
;
mAppLocales
=
aAppLocales
;
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
obs
)
{
obs
-
>
NotifyObservers
(
nullptr
"
intl
:
app
-
locales
-
changed
"
nullptr
)
;
}
}
void
LocaleService
:
:
AssignRequestedLocales
(
const
nsTArray
<
nsCString
>
&
aRequestedLocales
)
{
MOZ_ASSERT
(
!
mIsServer
"
This
should
only
be
called
for
LocaleService
in
client
mode
.
"
)
;
mRequestedLocales
=
aRequestedLocales
;
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
obs
)
{
obs
-
>
NotifyObservers
(
nullptr
"
intl
:
requested
-
locales
-
changed
"
nullptr
)
;
}
}
bool
LocaleService
:
:
GetRequestedLocales
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
if
(
mRequestedLocales
.
IsEmpty
(
)
)
{
ReadRequestedLocales
(
mRequestedLocales
)
;
}
aRetVal
=
mRequestedLocales
;
return
true
;
}
bool
LocaleService
:
:
GetAvailableLocales
(
nsTArray
<
nsCString
>
&
aRetVal
)
{
if
(
mAvailableLocales
.
IsEmpty
(
)
)
{
ReadAvailableLocales
(
mAvailableLocales
)
;
}
aRetVal
=
mAvailableLocales
;
return
true
;
}
void
LocaleService
:
:
AvailableLocalesChanged
(
)
{
MOZ_ASSERT
(
mIsServer
"
This
should
only
be
called
in
the
server
mode
.
"
)
;
mAvailableLocales
.
Clear
(
)
;
LocalesChanged
(
)
;
}
void
LocaleService
:
:
RequestedLocalesChanged
(
)
{
MOZ_ASSERT
(
mIsServer
"
This
should
only
be
called
in
the
server
mode
.
"
)
;
nsTArray
<
nsCString
>
newLocales
;
ReadRequestedLocales
(
newLocales
)
;
if
(
mRequestedLocales
!
=
newLocales
)
{
mRequestedLocales
=
Move
(
newLocales
)
;
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
obs
)
{
obs
-
>
NotifyObservers
(
nullptr
"
intl
:
requested
-
locales
-
changed
"
nullptr
)
;
}
LocalesChanged
(
)
;
}
}
void
LocaleService
:
:
LocalesChanged
(
)
{
MOZ_ASSERT
(
mIsServer
"
This
should
only
be
called
in
the
server
mode
.
"
)
;
if
(
mAppLocales
.
IsEmpty
(
)
)
{
return
;
}
nsTArray
<
nsCString
>
newLocales
;
NegotiateAppLocales
(
newLocales
)
;
if
(
mAppLocales
!
=
newLocales
)
{
mAppLocales
=
Move
(
newLocales
)
;
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
obs
)
{
obs
-
>
NotifyObservers
(
nullptr
"
intl
:
app
-
locales
-
changed
"
nullptr
)
;
obs
-
>
NotifyObservers
(
nullptr
"
selected
-
locale
-
has
-
changed
"
nullptr
)
;
}
}
}
#
define
HANDLE_STRATEGY
\
switch
(
aStrategy
)
{
\
case
LangNegStrategy
:
:
Lookup
:
\
return
;
\
case
LangNegStrategy
:
:
Matching
:
\
continue
;
\
case
LangNegStrategy
:
:
Filtering
:
\
break
;
\
}
void
LocaleService
:
:
FilterMatches
(
const
nsTArray
<
nsCString
>
&
aRequested
const
nsTArray
<
nsCString
>
&
aAvailable
LangNegStrategy
aStrategy
nsTArray
<
nsCString
>
&
aRetVal
)
{
AutoTArray
<
Locale
100
>
availLocales
;
for
(
auto
&
avail
:
aAvailable
)
{
availLocales
.
AppendElement
(
Locale
(
avail
true
)
)
;
}
auto
eraseFromAvail
=
[
&
]
(
nsTArray
<
Locale
>
:
:
iterator
aIter
)
{
nsTArray
<
Locale
>
:
:
size_type
index
=
aIter
-
availLocales
.
begin
(
)
;
availLocales
.
RemoveElementAt
(
index
)
;
return
availLocales
.
begin
(
)
+
index
;
}
;
for
(
auto
&
requested
:
aRequested
)
{
auto
matchesExactly
=
[
&
]
(
const
Locale
&
aLoc
)
{
return
requested
.
Equals
(
aLoc
.
AsString
(
)
nsCaseInsensitiveCStringComparator
(
)
)
;
}
;
auto
match
=
std
:
:
find_if
(
availLocales
.
begin
(
)
availLocales
.
end
(
)
matchesExactly
)
;
if
(
match
!
=
availLocales
.
end
(
)
)
{
aRetVal
.
AppendElement
(
match
-
>
AsString
(
)
)
;
eraseFromAvail
(
match
)
;
}
if
(
!
aRetVal
.
IsEmpty
(
)
)
{
HANDLE_STRATEGY
;
}
auto
findRangeMatches
=
[
&
]
(
const
Locale
&
aReq
)
{
auto
matchesRange
=
[
&
]
(
const
Locale
&
aLoc
)
{
return
aReq
.
Matches
(
aLoc
)
;
}
;
bool
foundMatch
=
false
;
auto
match
=
availLocales
.
begin
(
)
;
while
(
(
match
=
std
:
:
find_if
(
match
availLocales
.
end
(
)
matchesRange
)
)
!
=
availLocales
.
end
(
)
)
{
aRetVal
.
AppendElement
(
match
-
>
AsString
(
)
)
;
match
=
eraseFromAvail
(
match
)
;
foundMatch
=
true
;
if
(
aStrategy
!
=
LangNegStrategy
:
:
Filtering
)
{
return
true
;
}
}
return
foundMatch
;
}
;
Locale
requestedLocale
=
Locale
(
requested
false
)
;
if
(
findRangeMatches
(
requestedLocale
)
)
{
HANDLE_STRATEGY
;
}
if
(
requestedLocale
.
AddLikelySubtags
(
)
)
{
if
(
findRangeMatches
(
requestedLocale
)
)
{
HANDLE_STRATEGY
;
}
}
requestedLocale
.
SetVariantRange
(
)
;
if
(
findRangeMatches
(
requestedLocale
)
)
{
HANDLE_STRATEGY
;
}
if
(
requestedLocale
.
AddLikelySubtagsWithoutRegion
(
)
)
{
if
(
findRangeMatches
(
requestedLocale
)
)
{
HANDLE_STRATEGY
;
}
}
requestedLocale
.
SetRegionRange
(
)
;
if
(
findRangeMatches
(
requestedLocale
)
)
{
HANDLE_STRATEGY
;
}
}
}
bool
LocaleService
:
:
NegotiateLanguages
(
const
nsTArray
<
nsCString
>
&
aRequested
const
nsTArray
<
nsCString
>
&
aAvailable
const
nsACString
&
aDefaultLocale
LangNegStrategy
aStrategy
nsTArray
<
nsCString
>
&
aRetVal
)
{
if
(
aStrategy
=
=
LangNegStrategy
:
:
Lookup
&
&
aDefaultLocale
.
IsEmpty
(
)
)
{
return
false
;
}
FilterMatches
(
aRequested
aAvailable
aStrategy
aRetVal
)
;
if
(
aStrategy
=
=
LangNegStrategy
:
:
Lookup
)
{
if
(
aRetVal
.
Length
(
)
=
=
0
)
{
aRetVal
.
AppendElement
(
aDefaultLocale
)
;
}
}
else
if
(
!
aDefaultLocale
.
IsEmpty
(
)
&
&
!
aRetVal
.
Contains
(
aDefaultLocale
)
)
{
aRetVal
.
AppendElement
(
aDefaultLocale
)
;
}
return
true
;
}
bool
LocaleService
:
:
IsAppLocaleRTL
(
)
{
nsAutoCString
locale
;
GetAppLocaleAsBCP47
(
locale
)
;
int
pref
=
Preferences
:
:
GetInt
(
"
intl
.
uidirection
"
-
1
)
;
if
(
pref
>
=
0
)
{
return
(
pref
>
0
)
;
}
return
uloc_isRightToLeft
(
locale
.
get
(
)
)
;
}
NS_IMETHODIMP
LocaleService
:
:
Observe
(
nsISupports
*
aSubject
const
char
*
aTopic
const
char16_t
*
aData
)
{
MOZ_ASSERT
(
mIsServer
"
This
should
only
be
called
in
the
server
mode
.
"
)
;
if
(
!
strcmp
(
aTopic
INTL_SYSTEM_LOCALES_CHANGED
)
)
{
RequestedLocalesChanged
(
)
;
}
else
{
NS_ConvertUTF16toUTF8
pref
(
aData
)
;
if
(
pref
.
EqualsLiteral
(
REQUESTED_LOCALES_PREF
)
)
{
RequestedLocalesChanged
(
)
;
}
}
return
NS_OK
;
}
bool
LocaleService
:
:
LanguagesMatch
(
const
nsCString
&
aRequested
const
nsCString
&
aAvailable
)
{
return
Locale
(
aRequested
true
)
.
LanguageMatches
(
Locale
(
aAvailable
true
)
)
;
}
bool
LocaleService
:
:
IsServer
(
)
{
return
mIsServer
;
}
static
char
*
*
CreateOutArray
(
const
nsTArray
<
nsCString
>
&
aArray
)
{
uint32_t
n
=
aArray
.
Length
(
)
;
char
*
*
result
=
static_cast
<
char
*
*
>
(
moz_xmalloc
(
n
*
sizeof
(
char
*
)
)
)
;
for
(
uint32_t
i
=
0
;
i
<
n
;
i
+
+
)
{
result
[
i
]
=
moz_xstrdup
(
aArray
[
i
]
.
get
(
)
)
;
}
return
result
;
}
NS_IMETHODIMP
LocaleService
:
:
GetDefaultLocale
(
nsACString
&
aRetVal
)
{
if
(
mDefaultLocale
.
IsEmpty
(
)
)
{
RefPtr
<
nsZipArchive
>
zip
=
Omnijar
:
:
GetReader
(
Omnijar
:
:
GRE
)
;
if
(
zip
)
{
nsZipItemPtr
<
char
>
item
(
zip
"
update
.
locale
"
)
;
size_t
len
=
item
.
Length
(
)
;
while
(
len
>
0
&
&
item
.
Buffer
(
)
[
len
-
1
]
<
=
'
'
)
{
len
-
-
;
}
mDefaultLocale
.
Assign
(
item
.
Buffer
(
)
len
)
;
}
if
(
mDefaultLocale
.
IsEmpty
(
)
)
{
GetLastFallbackLocale
(
mDefaultLocale
)
;
}
}
aRetVal
=
mDefaultLocale
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetLastFallbackLocale
(
nsACString
&
aRetVal
)
{
aRetVal
.
AssignLiteral
(
"
en
-
US
"
)
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetAppLocalesAsLangTags
(
uint32_t
*
aCount
char
*
*
*
aOutArray
)
{
if
(
mAppLocales
.
IsEmpty
(
)
)
{
NegotiateAppLocales
(
mAppLocales
)
;
}
*
aCount
=
mAppLocales
.
Length
(
)
;
*
aOutArray
=
CreateOutArray
(
mAppLocales
)
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetAppLocalesAsBCP47
(
uint32_t
*
aCount
char
*
*
*
aOutArray
)
{
AutoTArray
<
nsCString
32
>
locales
;
GetAppLocalesAsBCP47
(
locales
)
;
*
aCount
=
locales
.
Length
(
)
;
*
aOutArray
=
CreateOutArray
(
locales
)
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetAppLocaleAsLangTag
(
nsACString
&
aRetVal
)
{
if
(
mAppLocales
.
IsEmpty
(
)
)
{
NegotiateAppLocales
(
mAppLocales
)
;
}
aRetVal
=
mAppLocales
[
0
]
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetAppLocaleAsBCP47
(
nsACString
&
aRetVal
)
{
if
(
mAppLocales
.
IsEmpty
(
)
)
{
NegotiateAppLocales
(
mAppLocales
)
;
}
aRetVal
=
mAppLocales
[
0
]
;
SanitizeForBCP47
(
aRetVal
false
)
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetRegionalPrefsLocales
(
uint32_t
*
aCount
char
*
*
*
aOutArray
)
{
AutoTArray
<
nsCString
10
>
rgLocales
;
GetRegionalPrefsLocales
(
rgLocales
)
;
*
aCount
=
rgLocales
.
Length
(
)
;
*
aOutArray
=
static_cast
<
char
*
*
>
(
moz_xmalloc
(
*
aCount
*
sizeof
(
char
*
)
)
)
;
for
(
uint32_t
i
=
0
;
i
<
*
aCount
;
i
+
+
)
{
(
*
aOutArray
)
[
i
]
=
moz_xstrdup
(
rgLocales
[
i
]
.
get
(
)
)
;
}
return
NS_OK
;
}
static
LocaleService
:
:
LangNegStrategy
ToLangNegStrategy
(
int32_t
aStrategy
)
{
switch
(
aStrategy
)
{
case
1
:
return
LocaleService
:
:
LangNegStrategy
:
:
Matching
;
case
2
:
return
LocaleService
:
:
LangNegStrategy
:
:
Lookup
;
default
:
return
LocaleService
:
:
LangNegStrategy
:
:
Filtering
;
}
}
NS_IMETHODIMP
LocaleService
:
:
NegotiateLanguages
(
const
char
*
*
aRequested
const
char
*
*
aAvailable
const
char
*
aDefaultLocale
int32_t
aStrategy
uint32_t
aRequestedCount
uint32_t
aAvailableCount
uint32_t
*
aCount
char
*
*
*
aRetVal
)
{
if
(
aStrategy
<
0
|
|
aStrategy
>
2
)
{
return
NS_ERROR_INVALID_ARG
;
}
auto
validTagChars
=
[
]
(
const
char
*
s
)
{
if
(
!
s
|
|
!
*
s
)
{
return
false
;
}
while
(
*
s
)
{
if
(
isalnum
(
(
unsigned
char
)
*
s
)
|
|
*
s
=
=
'
-
'
|
|
*
s
=
=
'
_
'
|
|
*
s
=
=
'
*
'
)
{
s
+
+
;
}
else
{
return
false
;
}
}
return
true
;
}
;
AutoTArray
<
nsCString
100
>
requestedLocales
;
for
(
uint32_t
i
=
0
;
i
<
aRequestedCount
;
i
+
+
)
{
if
(
!
validTagChars
(
aRequested
[
i
]
)
)
{
continue
;
}
requestedLocales
.
AppendElement
(
aRequested
[
i
]
)
;
}
AutoTArray
<
nsCString
100
>
availableLocales
;
for
(
uint32_t
i
=
0
;
i
<
aAvailableCount
;
i
+
+
)
{
if
(
!
validTagChars
(
aAvailable
[
i
]
)
)
{
continue
;
}
availableLocales
.
AppendElement
(
aAvailable
[
i
]
)
;
}
nsAutoCString
defaultLocale
(
aDefaultLocale
)
;
LangNegStrategy
strategy
=
ToLangNegStrategy
(
aStrategy
)
;
AutoTArray
<
nsCString
100
>
supportedLocales
;
bool
result
=
NegotiateLanguages
(
requestedLocales
availableLocales
defaultLocale
strategy
supportedLocales
)
;
if
(
!
result
)
{
return
NS_ERROR_INVALID_ARG
;
}
*
aRetVal
=
static_cast
<
char
*
*
>
(
moz_xmalloc
(
sizeof
(
char
*
)
*
supportedLocales
.
Length
(
)
)
)
;
*
aCount
=
0
;
for
(
const
auto
&
supported
:
supportedLocales
)
{
(
*
aRetVal
)
[
(
*
aCount
)
+
+
]
=
moz_xstrdup
(
supported
.
get
(
)
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetRequestedLocales
(
uint32_t
*
aCount
char
*
*
*
aOutArray
)
{
AutoTArray
<
nsCString
16
>
requestedLocales
;
bool
res
=
GetRequestedLocales
(
requestedLocales
)
;
if
(
!
res
)
{
NS_ERROR
(
"
Couldn
'
t
retrieve
selected
locales
from
prefs
!
"
)
;
return
NS_ERROR_FAILURE
;
}
*
aCount
=
requestedLocales
.
Length
(
)
;
*
aOutArray
=
CreateOutArray
(
requestedLocales
)
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetRequestedLocale
(
nsACString
&
aRetVal
)
{
AutoTArray
<
nsCString
16
>
requestedLocales
;
bool
res
=
GetRequestedLocales
(
requestedLocales
)
;
if
(
!
res
)
{
NS_ERROR
(
"
Couldn
'
t
retrieve
selected
locales
from
prefs
!
"
)
;
return
NS_ERROR_FAILURE
;
}
if
(
requestedLocales
.
Length
(
)
>
0
)
{
aRetVal
=
requestedLocales
[
0
]
;
}
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
SetRequestedLocales
(
const
char
*
*
aRequested
uint32_t
aRequestedCount
)
{
nsAutoCString
str
;
for
(
uint32_t
i
=
0
;
i
<
aRequestedCount
;
i
+
+
)
{
nsAutoCString
locale
(
aRequested
[
i
]
)
;
if
(
!
locale
.
EqualsLiteral
(
"
ja
-
JP
-
mac
"
)
&
&
!
SanitizeForBCP47
(
locale
true
)
)
{
NS_ERROR
(
"
Invalid
language
tag
provided
to
SetRequestedLocales
!
"
)
;
return
NS_ERROR_INVALID_ARG
;
}
if
(
i
>
0
)
{
str
.
AppendLiteral
(
"
"
)
;
}
str
.
Append
(
locale
)
;
}
Preferences
:
:
SetCString
(
REQUESTED_LOCALES_PREF
str
)
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetAvailableLocales
(
uint32_t
*
aCount
char
*
*
*
aOutArray
)
{
AutoTArray
<
nsCString
100
>
availableLocales
;
bool
res
=
GetAvailableLocales
(
availableLocales
)
;
if
(
!
res
)
{
NS_ERROR
(
"
Couldn
'
t
retrieve
available
locales
!
"
)
;
return
NS_ERROR_FAILURE
;
}
*
aCount
=
availableLocales
.
Length
(
)
;
*
aOutArray
=
CreateOutArray
(
availableLocales
)
;
return
NS_OK
;
}
NS_IMETHODIMP
LocaleService
:
:
GetIsAppLocaleRTL
(
bool
*
aRetVal
)
{
(
*
aRetVal
)
=
IsAppLocaleRTL
(
)
;
return
NS_OK
;
}
