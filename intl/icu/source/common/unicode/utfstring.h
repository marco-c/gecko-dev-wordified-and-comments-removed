#
ifndef
__UTFSTRING_H__
#
define
__UTFSTRING_H__
#
include
"
unicode
/
utypes
.
h
"
#
if
U_SHOW_CPLUSPLUS_API
|
|
U_SHOW_CPLUSPLUS_HEADER_API
|
|
!
defined
(
UTYPES_H
)
#
include
"
unicode
/
utf16
.
h
"
#
ifndef
U_HIDE_DRAFT_API
namespace
U_HEADER_ONLY_NAMESPACE
{
namespace
utfstring
{
#
ifndef
U_IN_DOXYGEN
namespace
prv
{
template
<
typename
StringClass
bool
validate
>
inline
StringClass
&
appendCodePoint
(
StringClass
&
s
uint32_t
c
)
{
using
Unit
=
typename
StringClass
:
:
value_type
;
if
constexpr
(
sizeof
(
Unit
)
=
=
1
)
{
if
(
c
<
=
0x7f
)
{
s
.
push_back
(
static_cast
<
Unit
>
(
c
)
)
;
}
else
{
Unit
buf
[
4
]
;
uint8_t
len
;
if
(
c
<
=
0x7ff
)
{
len
=
2
;
buf
[
2
]
=
(
c
>
>
6
)
|
0xc0
;
}
else
{
if
(
validate
?
c
<
0xd800
|
|
(
c
<
0xe000
|
|
c
>
0x10ffff
?
(
c
=
0xfffd
true
)
:
c
<
=
0xffff
)
:
c
<
=
0xffff
)
{
len
=
3
;
buf
[
1
]
=
(
c
>
>
12
)
|
0xe0
;
}
else
{
len
=
4
;
buf
[
0
]
=
(
c
>
>
18
)
|
0xf0
;
buf
[
1
]
=
(
(
c
>
>
12
)
&
0x3f
)
|
0x80
;
}
buf
[
2
]
=
(
(
c
>
>
6
)
&
0x3f
)
|
0x80
;
}
buf
[
3
]
=
(
c
&
0x3f
)
|
0x80
;
s
.
append
(
buf
+
4
-
len
len
)
;
}
}
else
if
constexpr
(
sizeof
(
Unit
)
=
=
2
)
{
if
(
validate
?
c
<
0xd800
|
|
(
c
<
0xe000
|
|
c
>
0x10ffff
?
(
c
=
0xfffd
true
)
:
c
<
=
0xffff
)
:
c
<
=
0xffff
)
{
s
.
push_back
(
static_cast
<
Unit
>
(
c
)
)
;
}
else
{
Unit
buf
[
2
]
=
{
U16_LEAD
(
c
)
U16_TRAIL
(
c
)
}
;
s
.
append
(
buf
2
)
;
}
}
else
{
s
.
push_back
(
!
validate
|
|
U_IS_SCALAR_VALUE
(
c
)
?
c
:
0xfffd
)
;
}
return
s
;
}
}
#
endif
#
ifndef
U_HIDE_DRAFT_API
template
<
typename
StringClass
>
inline
StringClass
&
appendOrFFFD
(
StringClass
&
s
UChar32
c
)
{
return
prv
:
:
appendCodePoint
<
StringClass
true
>
(
s
c
)
;
}
template
<
typename
StringClass
>
inline
StringClass
&
appendUnsafe
(
StringClass
&
s
UChar32
c
)
{
return
prv
:
:
appendCodePoint
<
StringClass
false
>
(
s
c
)
;
}
template
<
typename
StringClass
>
inline
StringClass
encodeOrFFFD
(
UChar32
c
)
{
StringClass
s
;
prv
:
:
appendCodePoint
<
StringClass
true
>
(
s
c
)
;
return
s
;
}
template
<
typename
StringClass
>
inline
StringClass
encodeUnsafe
(
UChar32
c
)
{
StringClass
s
;
prv
:
:
appendCodePoint
<
StringClass
false
>
(
s
c
)
;
return
s
;
}
#
endif
}
}
#
endif
#
endif
#
endif
