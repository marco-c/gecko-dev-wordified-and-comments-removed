#
include
"
unicode
/
utypes
.
h
"
#
include
"
mutex
.
h
"
#
include
"
ucln
.
h
"
#
include
"
ucln_io
.
h
"
#
include
"
uassert
.
h
"
#
ifndef
U_IO_IMPLEMENTATION
#
error
U_IO_IMPLEMENTATION
not
set
-
must
be
set
for
all
ICU
source
files
in
io
/
-
see
https
:
/
/
unicode
-
org
.
github
.
io
/
icu
/
userguide
/
howtouseicu
#
endif
#
define
UCLN_TYPE
UCLN_IO
#
include
"
ucln_imp
.
h
"
static
const
char
copyright
[
]
=
U_COPYRIGHT_STRING
;
static
cleanupFunc
*
gCleanupFunctions
[
UCLN_IO_COUNT
]
;
static
UBool
U_CALLCONV
io_cleanup
(
)
{
int32_t
libType
=
UCLN_IO_START
;
(
void
)
copyright
;
while
(
+
+
libType
<
UCLN_IO_COUNT
)
{
if
(
gCleanupFunctions
[
libType
]
)
{
gCleanupFunctions
[
libType
]
(
)
;
gCleanupFunctions
[
libType
]
=
nullptr
;
}
}
#
if
!
UCLN_NO_AUTO_CLEANUP
&
&
(
defined
(
UCLN_AUTO_ATEXIT
)
|
|
defined
(
UCLN_AUTO_LOCAL
)
)
ucln_unRegisterAutomaticCleanup
(
)
;
#
endif
return
true
;
}
void
ucln_io_registerCleanup
(
ECleanupIOType
type
cleanupFunc
*
func
)
{
U_ASSERT
(
UCLN_IO_START
<
type
&
&
type
<
UCLN_IO_COUNT
)
;
{
icu
:
:
Mutex
m
;
ucln_registerCleanup
(
UCLN_IO
io_cleanup
)
;
if
(
UCLN_IO_START
<
type
&
&
type
<
UCLN_IO_COUNT
)
{
gCleanupFunctions
[
type
]
=
func
;
}
}
#
if
!
UCLN_NO_AUTO_CLEANUP
&
&
(
defined
(
UCLN_AUTO_ATEXIT
)
|
|
defined
(
UCLN_AUTO_LOCAL
)
)
ucln_registerAutomaticCleanup
(
)
;
#
endif
}
