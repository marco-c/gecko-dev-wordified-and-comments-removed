const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
originalValues
=
{
requested
:
Services
.
locale
.
requestedLocales
}
;
const
l10nReg
=
new
L10nRegistry
(
)
;
function
getMockRegistry
(
)
{
const
mockSource
=
L10nFileSource
.
createMock
(
"
test
"
[
"
en
-
US
"
]
"
/
localization
/
{
locale
}
/
"
[
{
path
:
"
/
localization
/
en
-
US
/
mock
.
ftl
"
source
:
key
=
This
is
a
single
message
.
tooltip
=
This
is
a
tooltip
.
accesskey
=
f
}
]
)
;
let
registry
=
new
L10nRegistry
(
)
;
registry
.
registerSources
(
[
mockSource
]
)
;
return
registry
;
}
function
getAttributeByName
(
attributes
name
)
{
return
attributes
.
find
(
attr
=
>
attr
.
name
=
=
=
name
)
;
}
add_task
(
async
function
test_accented_works
(
)
{
Services
.
prefs
.
setStringPref
(
"
intl
.
l10n
.
pseudo
"
"
"
)
;
let
mockRegistry
=
getMockRegistry
(
)
;
const
l10n
=
new
Localization
(
[
"
mock
.
ftl
"
]
false
mockRegistry
)
;
{
let
message
=
(
await
l10n
.
formatMessages
(
[
{
id
:
"
key
"
}
]
)
)
[
0
]
;
ok
(
message
.
value
.
includes
(
"
This
is
a
single
message
"
)
)
;
let
attr0
=
getAttributeByName
(
message
.
attributes
"
tooltip
"
)
;
ok
(
attr0
.
value
.
includes
(
"
This
is
a
tooltip
"
)
)
;
let
attr1
=
getAttributeByName
(
message
.
attributes
"
accesskey
"
)
;
equal
(
attr1
.
value
"
f
"
)
;
}
{
Services
.
prefs
.
setStringPref
(
"
intl
.
l10n
.
pseudo
"
"
accented
"
)
;
let
message
=
(
await
l10n
.
formatMessages
(
[
{
id
:
"
key
"
}
]
)
)
[
0
]
;
ok
(
message
.
value
.
includes
(
"
i
i
aa
i
ee
ee
aa
ee
"
)
)
;
let
attr0
=
getAttributeByName
(
message
.
attributes
"
tooltip
"
)
;
ok
(
attr0
.
value
.
includes
(
"
i
i
aa
oooo
i
"
)
)
;
let
attr1
=
getAttributeByName
(
message
.
attributes
"
accesskey
"
)
;
equal
(
attr1
.
value
"
f
"
)
;
}
{
Services
.
prefs
.
setStringPref
(
"
intl
.
l10n
.
pseudo
"
"
bidi
"
)
;
let
message
=
(
await
l10n
.
formatMessages
(
[
{
id
:
"
key
"
}
]
)
)
[
0
]
;
ok
(
message
.
value
.
includes
(
"
i
a
i
e
e
a
e
"
)
)
;
let
attr0
=
getAttributeByName
(
message
.
attributes
"
tooltip
"
)
;
ok
(
attr0
.
value
.
includes
(
"
i
i
a
oo
i
"
)
)
;
let
attr1
=
getAttributeByName
(
message
.
attributes
"
accesskey
"
)
;
equal
(
attr1
.
value
"
f
"
)
;
}
{
Services
.
prefs
.
setStringPref
(
"
intl
.
l10n
.
pseudo
"
"
"
)
;
let
message
=
(
await
l10n
.
formatMessages
(
[
{
id
:
"
key
"
}
]
)
)
[
0
]
;
ok
(
message
.
value
.
includes
(
"
This
is
a
single
message
"
)
)
;
let
attr0
=
getAttributeByName
(
message
.
attributes
"
tooltip
"
)
;
ok
(
attr0
.
value
.
includes
(
"
This
is
a
tooltip
"
)
)
;
let
attr1
=
getAttributeByName
(
message
.
attributes
"
accesskey
"
)
;
equal
(
attr1
.
value
"
f
"
)
;
}
Services
.
locale
.
requestedLocales
=
originalValues
.
requested
;
}
)
;
add_task
(
async
function
test_unavailable_strategy_works
(
)
{
Services
.
prefs
.
setStringPref
(
"
intl
.
l10n
.
pseudo
"
"
"
)
;
let
mockRegistry
=
getMockRegistry
(
)
;
const
l10n
=
new
Localization
(
[
"
mock
.
ftl
"
]
false
mockRegistry
)
;
{
Services
.
prefs
.
setStringPref
(
"
intl
.
l10n
.
pseudo
"
"
unknown
-
strategy
"
)
;
let
message
=
(
await
l10n
.
formatMessages
(
[
{
id
:
"
key
"
}
]
)
)
[
0
]
;
ok
(
message
.
value
.
includes
(
"
This
is
a
single
message
"
)
)
;
let
attr0
=
getAttributeByName
(
message
.
attributes
"
tooltip
"
)
;
ok
(
attr0
.
value
.
includes
(
"
This
is
a
tooltip
"
)
)
;
let
attr1
=
getAttributeByName
(
message
.
attributes
"
accesskey
"
)
;
equal
(
attr1
.
value
"
f
"
)
;
}
Services
.
prefs
.
setStringPref
(
"
intl
.
l10n
.
pseudo
"
"
"
)
;
Services
.
locale
.
requestedLocales
=
originalValues
.
requested
;
}
)
;
