const
{
setTimeout
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
)
;
const
l10nReg
=
new
L10nRegistry
(
)
;
add_task
(
function
test_methods_presence
(
)
{
equal
(
typeof
l10nReg
.
generateBundles
"
function
"
)
;
equal
(
typeof
l10nReg
.
getAvailableLocales
"
function
"
)
;
equal
(
typeof
l10nReg
.
registerSources
"
function
"
)
;
equal
(
typeof
l10nReg
.
removeSources
"
function
"
)
;
equal
(
typeof
l10nReg
.
updateSources
"
function
"
)
;
}
)
;
add_task
(
async
function
test_empty_resourceids
(
)
{
const
fs
=
[
]
;
const
source
=
L10nFileSource
.
createMock
(
"
test
"
"
"
[
"
en
-
US
"
]
"
/
localization
/
{
locale
}
"
fs
)
;
l10nReg
.
registerSources
(
[
source
]
)
;
const
bundles
=
l10nReg
.
generateBundles
(
[
"
en
-
US
"
]
[
]
)
;
const
done
=
(
await
bundles
.
next
(
)
)
.
done
;
equal
(
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_empty_sources
(
)
{
const
fs
=
[
]
;
const
bundles
=
l10nReg
.
generateBundlesSync
(
[
"
en
-
US
"
]
fs
)
;
const
done
=
(
await
bundles
.
next
(
)
)
.
done
;
equal
(
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_methods_calling
(
)
{
const
fs
=
[
{
path
:
"
/
localization
/
en
-
US
/
browser
/
menu
.
ftl
"
source
:
"
key
=
Value
"
}
]
;
const
source
=
L10nFileSource
.
createMock
(
"
test
"
"
"
[
"
en
-
US
"
]
"
/
localization
/
{
locale
}
"
fs
)
;
l10nReg
.
registerSources
(
[
source
]
)
;
const
bundles
=
l10nReg
.
generateBundles
(
[
"
en
-
US
"
]
[
"
/
browser
/
menu
.
ftl
"
]
)
;
const
bundle
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle
.
hasMessage
(
"
key
"
)
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_has_one_source
(
)
{
const
fs
=
[
{
path
:
"
.
/
app
/
data
/
locales
/
en
-
US
/
test
.
ftl
"
source
:
"
key
=
value
en
-
US
"
}
]
;
let
oneSource
=
L10nFileSource
.
createMock
(
"
app
"
"
"
[
"
en
-
US
"
]
"
.
/
app
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
l10nReg
.
registerSources
(
[
oneSource
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
1
)
;
equal
(
l10nReg
.
hasSource
(
"
app
"
)
true
)
;
let
bundles
=
l10nReg
.
generateBundles
(
[
"
en
-
US
"
]
[
"
test
.
ftl
"
]
)
;
let
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle0
.
hasMessage
(
"
key
"
)
true
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_has_two_sources
(
)
{
const
fs
=
[
{
path
:
"
.
/
platform
/
data
/
locales
/
en
-
US
/
test
.
ftl
"
source
:
"
key
=
platform
value
"
}
{
path
:
"
.
/
app
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
app
value
"
}
]
;
let
oneSource
=
L10nFileSource
.
createMock
(
"
platform
"
"
"
[
"
en
-
US
"
]
"
.
/
platform
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
let
secondSource
=
L10nFileSource
.
createMock
(
"
app
"
"
"
[
"
pl
"
]
"
.
/
app
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
l10nReg
.
registerSources
(
[
oneSource
secondSource
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
2
)
;
equal
(
l10nReg
.
hasSource
(
"
app
"
)
true
)
;
equal
(
l10nReg
.
hasSource
(
"
platform
"
)
true
)
;
let
bundles
=
l10nReg
.
generateBundles
(
[
"
en
-
US
"
]
[
"
test
.
ftl
"
]
)
;
let
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle0
.
hasMessage
(
"
key
"
)
true
)
;
let
msg
=
bundle0
.
getMessage
(
"
key
"
)
;
equal
(
bundle0
.
formatPattern
(
msg
.
value
)
"
platform
value
"
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
"
en
-
US
"
]
[
"
test
.
ftl
"
]
)
;
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle0
.
locales
[
0
]
"
pl
"
)
;
equal
(
bundle0
.
hasMessage
(
"
key
"
)
true
)
;
let
msg0
=
bundle0
.
getMessage
(
"
key
"
)
;
equal
(
bundle0
.
formatPattern
(
msg0
.
value
)
"
app
value
"
)
;
let
bundle1
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle1
.
locales
[
0
]
"
en
-
US
"
)
;
equal
(
bundle1
.
hasMessage
(
"
key
"
)
true
)
;
let
msg1
=
bundle1
.
getMessage
(
"
key
"
)
;
equal
(
bundle1
.
formatPattern
(
msg1
.
value
)
"
platform
value
"
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
function
test_indexed
(
)
{
let
oneSource
=
new
L10nFileSource
(
"
langpack
-
pl
"
"
app
"
[
"
pl
"
]
"
/
data
/
locales
/
{
locale
}
/
"
{
}
[
"
/
data
/
locales
/
pl
/
test
.
ftl
"
]
)
;
equal
(
oneSource
.
hasFile
(
"
pl
"
"
test
.
ftl
"
)
"
present
"
)
;
equal
(
oneSource
.
hasFile
(
"
pl
"
"
missing
.
ftl
"
)
"
missing
"
)
;
}
)
;
add_task
(
async
function
test_override
(
)
{
const
fs
=
[
{
path
:
"
/
app
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
value
"
}
{
path
:
"
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
addon
value
"
}
]
;
let
fileSource
=
L10nFileSource
.
createMock
(
"
app
"
"
"
[
"
pl
"
]
"
/
app
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
let
oneSource
=
L10nFileSource
.
createMock
(
"
langpack
-
pl
"
"
"
[
"
pl
"
]
"
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
l10nReg
.
registerSources
(
[
fileSource
oneSource
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
2
)
;
equal
(
l10nReg
.
hasSource
(
"
langpack
-
pl
"
)
true
)
;
let
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
let
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle0
.
locales
[
0
]
"
pl
"
)
;
equal
(
bundle0
.
hasMessage
(
"
key
"
)
true
)
;
let
msg0
=
bundle0
.
getMessage
(
"
key
"
)
;
equal
(
bundle0
.
formatPattern
(
msg0
.
value
)
"
addon
value
"
)
;
let
bundle1
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle1
.
locales
[
0
]
"
pl
"
)
;
equal
(
bundle1
.
hasMessage
(
"
key
"
)
true
)
;
let
msg1
=
bundle1
.
getMessage
(
"
key
"
)
;
equal
(
bundle1
.
formatPattern
(
msg1
.
value
)
"
value
"
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_updating
(
)
{
const
fs
=
[
{
path
:
"
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
value
"
}
]
;
let
oneSource
=
L10nFileSource
.
createMock
(
"
langpack
-
pl
"
"
"
[
"
pl
"
]
"
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
l10nReg
.
registerSources
(
[
oneSource
]
)
;
let
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
let
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle0
.
locales
[
0
]
"
pl
"
)
;
equal
(
bundle0
.
hasMessage
(
"
key
"
)
true
)
;
let
msg0
=
bundle0
.
getMessage
(
"
key
"
)
;
equal
(
bundle0
.
formatPattern
(
msg0
.
value
)
"
value
"
)
;
const
newSource
=
L10nFileSource
.
createMock
(
"
langpack
-
pl
"
"
"
[
"
pl
"
]
"
/
data
/
locales
/
{
locale
}
/
"
[
{
path
:
"
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
new
value
"
}
]
)
;
l10nReg
.
updateSources
(
[
newSource
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
1
)
;
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
msg0
=
bundle0
.
getMessage
(
"
key
"
)
;
equal
(
bundle0
.
formatPattern
(
msg0
.
value
)
"
new
value
"
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_removing
(
)
{
const
fs
=
[
{
path
:
"
/
app
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
value
"
}
{
path
:
"
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
addon
value
"
}
]
;
let
fileSource
=
L10nFileSource
.
createMock
(
"
app
"
"
"
[
"
pl
"
]
"
/
app
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
let
oneSource
=
L10nFileSource
.
createMock
(
"
langpack
-
pl
"
"
"
[
"
pl
"
]
"
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
l10nReg
.
registerSources
(
[
fileSource
oneSource
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
2
)
;
equal
(
l10nReg
.
hasSource
(
"
langpack
-
pl
"
)
true
)
;
let
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
let
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle0
.
locales
[
0
]
"
pl
"
)
;
equal
(
bundle0
.
hasMessage
(
"
key
"
)
true
)
;
let
msg0
=
bundle0
.
getMessage
(
"
key
"
)
;
equal
(
bundle0
.
formatPattern
(
msg0
.
value
)
"
addon
value
"
)
;
let
bundle1
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle1
.
locales
[
0
]
"
pl
"
)
;
equal
(
bundle1
.
hasMessage
(
"
key
"
)
true
)
;
let
msg1
=
bundle1
.
getMessage
(
"
key
"
)
;
equal
(
bundle1
.
formatPattern
(
msg1
.
value
)
"
value
"
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
removeSources
(
[
"
langpack
-
pl
"
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
1
)
;
equal
(
l10nReg
.
hasSource
(
"
langpack
-
pl
"
)
false
)
;
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
bundle0
=
(
await
bundles
.
next
(
)
)
.
value
;
equal
(
bundle0
.
locales
[
0
]
"
pl
"
)
;
equal
(
bundle0
.
hasMessage
(
"
key
"
)
true
)
;
msg0
=
bundle0
.
getMessage
(
"
key
"
)
;
equal
(
bundle0
.
formatPattern
(
msg0
.
value
)
"
value
"
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
removeSources
(
[
"
app
"
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
0
)
;
bundles
=
l10nReg
.
generateBundles
(
[
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_missing_file
(
)
{
const
fs
=
[
{
path
:
"
.
/
app
/
data
/
locales
/
en
-
US
/
test
.
ftl
"
source
:
"
key
=
value
en
-
US
"
}
{
path
:
"
.
/
platform
/
data
/
locales
/
en
-
US
/
test
.
ftl
"
source
:
"
key
=
value
en
-
US
"
}
{
path
:
"
.
/
platform
/
data
/
locales
/
en
-
US
/
test2
.
ftl
"
source
:
"
key2
=
value2
en
-
US
"
}
]
;
let
oneSource
=
L10nFileSource
.
createMock
(
"
app
"
"
"
[
"
en
-
US
"
]
"
.
/
app
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
let
twoSource
=
L10nFileSource
.
createMock
(
"
platform
"
"
"
[
"
en
-
US
"
]
"
.
/
platform
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
l10nReg
.
registerSources
(
[
oneSource
twoSource
]
)
;
equal
(
l10nReg
.
getSourceNames
(
)
.
length
2
)
;
equal
(
l10nReg
.
hasSource
(
"
app
"
)
true
)
;
equal
(
l10nReg
.
hasSource
(
"
platform
"
)
true
)
;
let
bundles
=
l10nReg
.
generateBundles
(
[
"
en
-
US
"
]
[
"
test
.
ftl
"
"
test2
.
ftl
"
]
)
;
let
bundle1
=
(
await
bundles
.
next
(
)
)
;
equal
(
bundle1
.
value
.
hasMessage
(
"
key
"
)
true
)
;
let
bundle2
=
(
await
bundles
.
next
(
)
)
;
equal
(
bundle2
.
value
.
hasMessage
(
"
key
"
)
true
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_hasSource
(
)
{
equal
(
l10nReg
.
hasSource
(
"
gobbledygook
"
)
false
"
Non
-
existing
source
doesn
'
t
exist
"
)
;
equal
(
l10nReg
.
hasSource
(
"
app
"
)
false
"
hasSource
returns
true
before
registering
a
source
"
)
;
let
oneSource
=
new
L10nFileSource
(
"
app
"
"
app
"
[
"
en
-
US
"
]
"
/
{
locale
}
/
"
)
;
l10nReg
.
registerSources
(
[
oneSource
]
)
;
equal
(
l10nReg
.
hasSource
(
"
app
"
)
true
"
hasSource
returns
true
after
registering
a
source
"
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
add_task
(
async
function
test_remove_source_mid_iter_cycle
(
)
{
const
fs
=
[
{
path
:
"
.
/
platform
/
data
/
locales
/
en
-
US
/
test
.
ftl
"
source
:
"
key
=
platform
value
"
}
{
path
:
"
.
/
app
/
data
/
locales
/
pl
/
test
.
ftl
"
source
:
"
key
=
app
value
"
}
]
;
let
oneSource
=
L10nFileSource
.
createMock
(
"
platform
"
"
"
[
"
en
-
US
"
]
"
.
/
platform
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
let
secondSource
=
L10nFileSource
.
createMock
(
"
app
"
"
"
[
"
pl
"
]
"
.
/
app
/
data
/
locales
/
{
locale
}
/
"
fs
)
;
l10nReg
.
registerSources
(
[
oneSource
secondSource
]
)
;
let
bundles
=
l10nReg
.
generateBundles
(
[
"
en
-
US
"
"
pl
"
]
[
"
test
.
ftl
"
]
)
;
let
bundle0
=
await
bundles
.
next
(
)
;
l10nReg
.
removeSources
(
[
"
app
"
]
)
;
equal
(
(
await
bundles
.
next
(
)
)
.
done
true
)
;
l10nReg
.
clearSources
(
)
;
}
)
;
