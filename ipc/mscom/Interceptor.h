#
ifndef
mozilla_mscom_interceptor_h
#
define
mozilla_mscom_interceptor_h
#
include
"
mozilla
/
Move
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
mozilla
/
mscom
/
Ptr
.
h
"
#
include
"
mozilla
/
mscom
/
WeakRef
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
<
callobj
.
h
>
namespace
mozilla
{
namespace
mscom
{
DEFINE_GUID
(
IID_IInterceptorSink
0x8831eb53
0xa937
0x42bc
0x99
0x21
0xb3
0xe1
0x12
0x1f
0xdf
0x86
)
;
struct
IInterceptorSink
:
public
ICallFrameEvents
{
virtual
STDMETHODIMP
SetInterceptor
(
IWeakReference
*
aInterceptor
)
=
0
;
}
;
DEFINE_GUID
(
IID_IInterceptor
0x3710799b
0xeca2
0x4165
0xb9
0xb0
0x3f
0xa1
0xe4
0xa9
0xb2
0x30
)
;
struct
IInterceptor
:
public
IUnknown
{
virtual
STDMETHODIMP
GetTargetForIID
(
REFIID
aIid
InterceptorTargetPtr
&
aTarget
)
=
0
;
virtual
STDMETHODIMP
GetInterceptorForIID
(
REFIID
aIid
void
*
*
aOutInterceptor
)
=
0
;
}
;
class
Interceptor
final
:
public
WeakReferenceSupport
public
IInterceptor
{
public
:
static
HRESULT
Create
(
STAUniquePtr
<
IUnknown
>
&
aTarget
IInterceptorSink
*
aSink
REFIID
aIid
void
*
*
aOutput
)
;
STDMETHODIMP
QueryInterface
(
REFIID
riid
void
*
*
ppv
)
override
;
STDMETHODIMP_
(
ULONG
)
AddRef
(
)
override
;
STDMETHODIMP_
(
ULONG
)
Release
(
)
override
;
STDMETHODIMP
GetTargetForIID
(
REFIID
aIid
InterceptorTargetPtr
&
aTarget
)
override
;
STDMETHODIMP
GetInterceptorForIID
(
REFIID
aIid
void
*
*
aOutInterceptor
)
override
;
private
:
struct
MapEntry
{
MapEntry
(
REFIID
aIid
IUnknown
*
aInterceptor
IUnknown
*
aTargetInterface
)
:
mIID
(
aIid
)
mInterceptor
(
aInterceptor
)
mTargetInterface
(
aTargetInterface
)
{
}
IID
mIID
;
IUnknown
*
mInterceptor
;
IUnknown
*
mTargetInterface
;
}
;
private
:
Interceptor
(
STAUniquePtr
<
IUnknown
>
&
aTarget
IInterceptorSink
*
aSink
)
;
~
Interceptor
(
)
;
MapEntry
*
Lookup
(
REFIID
aIid
)
;
HRESULT
QueryInterfaceTarget
(
REFIID
aIid
void
*
*
aOutput
)
;
HRESULT
ThreadSafeQueryInterface
(
REFIID
aIid
IUnknown
*
*
aOutInterface
)
override
;
HRESULT
CreateInterceptor
(
REFIID
aIid
IUnknown
*
aOuter
IUnknown
*
*
aOutput
)
;
private
:
STAUniquePtr
<
IUnknown
>
mTarget
;
RefPtr
<
IInterceptorSink
>
mEventSink
;
mozilla
:
:
Mutex
mMutex
;
nsTArray
<
MapEntry
>
mInterceptorMap
;
}
;
template
<
typename
InterfaceT
>
inline
HRESULT
CreateInterceptor
(
STAUniquePtr
<
InterfaceT
>
&
aTargetInterface
IInterceptorSink
*
aEventSink
InterfaceT
*
*
aOutInterface
)
{
if
(
!
aTargetInterface
|
|
!
aEventSink
)
{
return
E_INVALIDARG
;
}
REFIID
iidTarget
=
__uuidof
(
aTargetInterface
)
;
STAUniquePtr
<
IUnknown
>
targetUnknown
(
aTargetInterface
.
release
(
)
)
;
return
Interceptor
:
:
Create
(
targetUnknown
aEventSink
iidTarget
(
void
*
*
)
aOutInterface
)
;
}
}
}
#
endif
