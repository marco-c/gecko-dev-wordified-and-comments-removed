#
include
"
mozilla
/
mscom
/
MainThreadHandoff
.
h
"
#
include
"
mozilla
/
mscom
/
InterceptorLog
.
h
"
#
include
"
mozilla
/
mscom
/
Registration
.
h
"
#
include
"
mozilla
/
mscom
/
utils
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
DebugOnly
.
h
"
#
include
"
nsThreadUtils
.
h
"
using
mozilla
:
:
DebugOnly
;
namespace
{
class
HandoffRunnable
:
public
mozilla
:
:
Runnable
{
public
:
explicit
HandoffRunnable
(
ICallFrame
*
aCallFrame
IUnknown
*
aTargetInterface
)
:
mCallFrame
(
aCallFrame
)
mTargetInterface
(
aTargetInterface
)
mResult
(
E_UNEXPECTED
)
{
}
NS_IMETHOD
Run
(
)
override
{
mResult
=
mCallFrame
-
>
Invoke
(
mTargetInterface
)
;
return
NS_OK
;
}
HRESULT
GetResult
(
)
const
{
return
mResult
;
}
private
:
ICallFrame
*
mCallFrame
;
IUnknown
*
mTargetInterface
;
HRESULT
mResult
;
}
;
}
namespace
mozilla
{
namespace
mscom
{
HRESULT
MainThreadHandoff
:
:
Create
(
IInterceptorSink
*
*
aOutput
)
{
*
aOutput
=
nullptr
;
MainThreadHandoff
*
handoff
=
new
MainThreadHandoff
(
)
;
HRESULT
hr
=
handoff
-
>
QueryInterface
(
IID_IInterceptorSink
(
void
*
*
)
aOutput
)
;
handoff
-
>
Release
(
)
;
return
hr
;
}
MainThreadHandoff
:
:
MainThreadHandoff
(
)
:
mRefCnt
(
1
)
{
}
MainThreadHandoff
:
:
~
MainThreadHandoff
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
HRESULT
MainThreadHandoff
:
:
QueryInterface
(
REFIID
riid
void
*
*
ppv
)
{
IUnknown
*
punk
=
nullptr
;
if
(
!
ppv
)
{
return
E_INVALIDARG
;
}
if
(
riid
=
=
IID_IUnknown
|
|
riid
=
=
IID_ICallFrameEvents
|
|
riid
=
=
IID_IInterceptorSink
)
{
punk
=
static_cast
<
IInterceptorSink
*
>
(
this
)
;
}
else
if
(
riid
=
=
IID_ICallFrameWalker
)
{
punk
=
static_cast
<
ICallFrameWalker
*
>
(
this
)
;
}
*
ppv
=
punk
;
if
(
!
punk
)
{
return
E_NOINTERFACE
;
}
punk
-
>
AddRef
(
)
;
return
S_OK
;
}
ULONG
MainThreadHandoff
:
:
AddRef
(
)
{
return
(
ULONG
)
InterlockedIncrement
(
(
LONG
*
)
&
mRefCnt
)
;
}
ULONG
MainThreadHandoff
:
:
Release
(
)
{
ULONG
newRefCnt
=
(
ULONG
)
InterlockedDecrement
(
(
LONG
*
)
&
mRefCnt
)
;
if
(
newRefCnt
=
=
0
)
{
if
(
NS_IsMainThread
(
)
)
{
delete
this
;
}
else
{
mozilla
:
:
DebugOnly
<
nsresult
>
rv
=
NS_DispatchToMainThread
(
NS_NewRunnableFunction
(
[
=
]
(
)
-
>
void
{
delete
this
;
}
)
)
;
MOZ_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
}
}
return
newRefCnt
;
}
HRESULT
MainThreadHandoff
:
:
OnCall
(
ICallFrame
*
aFrame
)
{
HRESULT
hr
;
IID
iid
;
ULONG
method
;
hr
=
aFrame
-
>
GetIIDAndMethod
(
&
iid
&
method
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
RefPtr
<
IInterceptor
>
interceptor
;
hr
=
mInterceptor
-
>
Resolve
(
IID_IInterceptor
(
void
*
*
)
getter_AddRefs
(
interceptor
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
InterceptorTargetPtr
targetInterface
;
hr
=
interceptor
-
>
GetTargetForIID
(
iid
targetInterface
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
RefPtr
<
HandoffRunnable
>
handoffInfo
(
new
HandoffRunnable
(
aFrame
targetInterface
.
get
(
)
)
)
;
if
(
!
mInvoker
.
Invoke
(
do_AddRef
(
handoffInfo
)
)
)
{
MOZ_ASSERT
(
false
)
;
return
E_UNEXPECTED
;
}
hr
=
handoffInfo
-
>
GetResult
(
)
;
MOZ_ASSERT
(
SUCCEEDED
(
hr
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
InterceptorLog
:
:
Event
(
aFrame
targetInterface
.
get
(
)
)
;
hr
=
aFrame
-
>
GetReturnValue
(
)
;
if
(
FAILED
(
hr
)
)
{
return
S_OK
;
}
hr
=
aFrame
-
>
WalkFrame
(
CALLFRAME_WALK_OUT
this
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
const
ArrayData
*
arrayData
=
FindArrayData
(
iid
method
)
;
if
(
arrayData
)
{
hr
=
FixArrayElements
(
aFrame
*
arrayData
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
}
return
S_OK
;
}
static
PVOID
ResolveArrayPtr
(
VARIANT
&
aVariant
)
{
if
(
!
(
aVariant
.
vt
&
VT_BYREF
)
)
{
return
nullptr
;
}
return
aVariant
.
byref
;
}
static
PVOID
*
ResolveInterfacePtr
(
PVOID
aArrayPtr
VARTYPE
aVartype
LONG
aIndex
)
{
if
(
aVartype
!
=
(
VT_VARIANT
|
VT_BYREF
)
)
{
IUnknown
*
*
ifaceArray
=
reinterpret_cast
<
IUnknown
*
*
>
(
aArrayPtr
)
;
return
reinterpret_cast
<
PVOID
*
>
(
&
ifaceArray
[
aIndex
]
)
;
}
VARIANT
*
variantArray
=
reinterpret_cast
<
VARIANT
*
>
(
aArrayPtr
)
;
VARIANT
&
element
=
variantArray
[
aIndex
]
;
return
&
element
.
byref
;
}
HRESULT
MainThreadHandoff
:
:
FixArrayElements
(
ICallFrame
*
aFrame
const
ArrayData
&
aArrayData
)
{
VARIANT
paramVal
;
HRESULT
hr
=
aFrame
-
>
GetParam
(
aArrayData
.
mLengthParamIndex
&
paramVal
)
;
MOZ_ASSERT
(
paramVal
.
vt
=
=
(
VT_I4
|
VT_BYREF
)
|
|
paramVal
.
vt
=
=
(
VT_UI4
|
VT_BYREF
)
)
;
if
(
FAILED
(
hr
)
|
|
(
paramVal
.
vt
!
=
(
VT_I4
|
VT_BYREF
)
&
&
paramVal
.
vt
!
=
(
VT_UI4
|
VT_BYREF
)
)
)
{
return
hr
;
}
const
LONG
arrayLength
=
*
(
paramVal
.
plVal
)
;
if
(
arrayLength
<
=
1
)
{
return
S_OK
;
}
hr
=
aFrame
-
>
GetParam
(
aArrayData
.
mArrayParamIndex
&
paramVal
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
PVOID
arrayPtr
=
ResolveArrayPtr
(
paramVal
)
;
MOZ_ASSERT
(
arrayPtr
)
;
if
(
!
arrayPtr
)
{
return
DISP_E_BADVARTYPE
;
}
for
(
LONG
index
=
1
;
index
<
arrayLength
;
+
+
index
)
{
hr
=
OnWalkInterface
(
aArrayData
.
mArrayParamIid
ResolveInterfacePtr
(
arrayPtr
paramVal
.
vt
index
)
FALSE
TRUE
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
}
return
S_OK
;
}
HRESULT
MainThreadHandoff
:
:
SetInterceptor
(
IWeakReference
*
aInterceptor
)
{
mInterceptor
=
aInterceptor
;
return
S_OK
;
}
HRESULT
MainThreadHandoff
:
:
OnWalkInterface
(
REFIID
aIid
PVOID
*
aInterface
BOOL
aIsInParam
BOOL
aIsOutParam
)
{
MOZ_ASSERT
(
aInterface
&
&
aIsOutParam
)
;
if
(
!
aInterface
|
|
!
aIsOutParam
)
{
return
E_UNEXPECTED
;
}
STAUniquePtr
<
IUnknown
>
origInterface
(
static_cast
<
IUnknown
*
>
(
*
aInterface
)
)
;
*
aInterface
=
nullptr
;
if
(
IsProxy
(
origInterface
.
get
(
)
)
)
{
*
aInterface
=
origInterface
.
release
(
)
;
return
S_OK
;
}
RefPtr
<
IInterceptor
>
interceptor
;
HRESULT
hr
=
mInterceptor
-
>
Resolve
(
IID_IInterceptor
(
void
*
*
)
getter_AddRefs
(
interceptor
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
InterceptorTargetPtr
existingTarget
;
hr
=
interceptor
-
>
GetTargetForIID
(
aIid
existingTarget
)
;
if
(
SUCCEEDED
(
hr
)
)
{
bool
areIUnknownsEqual
=
false
;
auto
checkFn
=
[
&
existingTarget
&
origInterface
&
areIUnknownsEqual
]
(
)
-
>
void
{
RefPtr
<
IUnknown
>
unkExisting
;
HRESULT
hrExisting
=
existingTarget
-
>
QueryInterface
(
IID_IUnknown
(
void
*
*
)
getter_AddRefs
(
unkExisting
)
)
;
RefPtr
<
IUnknown
>
unkNew
;
HRESULT
hrNew
=
origInterface
-
>
QueryInterface
(
IID_IUnknown
(
void
*
*
)
getter_AddRefs
(
unkNew
)
)
;
areIUnknownsEqual
=
SUCCEEDED
(
hrExisting
)
&
&
SUCCEEDED
(
hrNew
)
&
&
unkExisting
=
=
unkNew
;
}
;
MainThreadInvoker
invoker
;
if
(
invoker
.
Invoke
(
NS_NewRunnableFunction
(
checkFn
)
)
&
&
areIUnknownsEqual
)
{
void
*
intercepted
=
nullptr
;
hr
=
interceptor
-
>
GetInterceptorForIID
(
aIid
&
intercepted
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
*
aInterface
=
intercepted
;
return
S_OK
;
}
}
RefPtr
<
IInterceptorSink
>
handoff
;
hr
=
MainThreadHandoff
:
:
Create
(
getter_AddRefs
(
handoff
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
RefPtr
<
IUnknown
>
wrapped
;
hr
=
Interceptor
:
:
Create
(
origInterface
handoff
aIid
getter_AddRefs
(
wrapped
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
wrapped
.
forget
(
reinterpret_cast
<
IUnknown
*
*
>
(
aInterface
)
)
;
return
S_OK
;
}
}
}
