#
include
<
utility
>
#
include
"
mozilla
/
mscom
/
EnsureMTA
.
h
"
#
include
"
mozilla
/
mscom
/
ProxyStream
.
h
"
#
include
"
mozilla
/
mscom
/
Utils
.
h
"
#
include
"
mozilla
/
ScopeExit
.
h
"
#
include
"
mozilla
/
mscom
/
Objref
.
h
"
#
include
"
nsExceptionHandler
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
RegistrationAnnotator
.
h
"
#
include
<
windows
.
h
>
#
include
<
objbase
.
h
>
#
include
<
shlwapi
.
h
>
namespace
mozilla
{
namespace
mscom
{
ProxyStream
:
:
ProxyStream
(
)
:
mGlobalLockedBuf
(
nullptr
)
mHGlobal
(
nullptr
)
mBufSize
(
0
)
mPreserveStream
(
false
)
{
}
ProxyStream
:
:
ProxyStream
(
REFIID
aIID
const
BYTE
*
aInitBuf
const
int
aInitBufSize
Environment
*
aEnv
)
:
mGlobalLockedBuf
(
nullptr
)
mHGlobal
(
nullptr
)
mBufSize
(
aInitBufSize
)
mPreserveStream
(
false
)
{
CrashReporter
:
:
Annotation
kCrashReportKey
=
CrashReporter
:
:
Annotation
:
:
ProxyStreamUnmarshalStatus
;
if
(
!
aInitBufSize
)
{
CrashReporter
:
:
AnnotateCrashReport
(
kCrashReportKey
"
!
aInitBufSize
"
_ns
)
;
return
;
}
HRESULT
createStreamResult
=
CreateStream
(
aInitBuf
aInitBufSize
getter_AddRefs
(
mStream
)
)
;
if
(
FAILED
(
createStreamResult
)
)
{
nsPrintfCString
hrAsStr
(
"
0x
%
08lX
"
createStreamResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
kCrashReportKey
hrAsStr
)
;
return
;
}
MOZ_ASSERT
(
mStream
)
;
if
(
!
mStream
)
{
CrashReporter
:
:
AnnotateCrashReport
(
kCrashReportKey
"
!
mStream
"
_ns
)
;
return
;
}
HRESULT
unmarshalResult
=
S_OK
;
auto
marshalFn
=
[
this
&
unmarshalResult
&
aIID
aEnv
]
(
)
-
>
void
{
if
(
aEnv
)
{
bool
pushOk
=
aEnv
-
>
Push
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
pushOk
)
;
if
(
!
pushOk
)
{
return
;
}
}
auto
popEnv
=
MakeScopeExit
(
[
aEnv
]
(
)
-
>
void
{
if
(
!
aEnv
)
{
return
;
}
#
ifdef
MOZ_DIAGNOSTIC_ASSERT_ENABLED
bool
popOk
=
#
endif
aEnv
-
>
Pop
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
popOk
)
;
}
)
;
unmarshalResult
=
:
:
CoUnmarshalInterface
(
mStream
aIID
getter_AddRefs
(
mUnmarshaledProxy
)
)
;
MOZ_ASSERT
(
SUCCEEDED
(
unmarshalResult
)
)
;
}
;
if
(
XRE_IsParentProcess
(
)
)
{
marshalFn
(
)
;
}
else
{
EnsureMTA
mta
(
marshalFn
)
;
}
mStream
=
nullptr
;
if
(
FAILED
(
unmarshalResult
)
|
|
!
mUnmarshaledProxy
)
{
nsPrintfCString
hrAsStr
(
"
0x
%
08lX
"
unmarshalResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
CoUnmarshalInterfaceResult
hrAsStr
)
;
AnnotateInterfaceRegistration
(
aIID
)
;
if
(
!
mUnmarshaledProxy
)
{
CrashReporter
:
:
AnnotateCrashReport
(
kCrashReportKey
"
!
mUnmarshaledProxy
"
_ns
)
;
}
}
}
ProxyStream
:
:
ProxyStream
(
ProxyStream
&
&
aOther
)
:
mGlobalLockedBuf
(
nullptr
)
mHGlobal
(
nullptr
)
mBufSize
(
0
)
mPreserveStream
(
false
)
{
*
this
=
std
:
:
move
(
aOther
)
;
}
ProxyStream
&
ProxyStream
:
:
operator
=
(
ProxyStream
&
&
aOther
)
{
if
(
mHGlobal
&
&
mGlobalLockedBuf
)
{
DebugOnly
<
BOOL
>
result
=
:
:
GlobalUnlock
(
mHGlobal
)
;
MOZ_ASSERT
(
!
result
&
&
:
:
GetLastError
(
)
=
=
NO_ERROR
)
;
}
mStream
=
std
:
:
move
(
aOther
.
mStream
)
;
mGlobalLockedBuf
=
aOther
.
mGlobalLockedBuf
;
aOther
.
mGlobalLockedBuf
=
nullptr
;
mHGlobal
=
aOther
.
mHGlobal
;
aOther
.
mHGlobal
=
nullptr
;
mBufSize
=
aOther
.
mBufSize
;
aOther
.
mBufSize
=
0
;
mUnmarshaledProxy
=
std
:
:
move
(
aOther
.
mUnmarshaledProxy
)
;
mPreserveStream
=
aOther
.
mPreserveStream
;
return
*
this
;
}
ProxyStream
:
:
~
ProxyStream
(
)
{
if
(
mHGlobal
&
&
mGlobalLockedBuf
)
{
DebugOnly
<
BOOL
>
result
=
:
:
GlobalUnlock
(
mHGlobal
)
;
MOZ_ASSERT
(
!
result
&
&
:
:
GetLastError
(
)
=
=
NO_ERROR
)
;
}
MOZ_ASSERT
(
!
mPreserveStream
)
;
}
const
BYTE
*
ProxyStream
:
:
GetBuffer
(
int
&
aReturnedBufSize
)
const
{
aReturnedBufSize
=
0
;
if
(
!
mStream
)
{
return
nullptr
;
}
if
(
!
mGlobalLockedBuf
)
{
return
nullptr
;
}
aReturnedBufSize
=
mBufSize
;
return
mGlobalLockedBuf
;
}
PreservedStreamPtr
ProxyStream
:
:
GetPreservedStream
(
)
{
MOZ_ASSERT
(
mStream
)
;
MOZ_ASSERT
(
mHGlobal
)
;
if
(
!
mStream
|
|
!
mPreserveStream
)
{
return
nullptr
;
}
RefPtr
<
IStream
>
cloned
;
HRESULT
hr
=
mStream
-
>
Clone
(
getter_AddRefs
(
cloned
)
)
;
if
(
FAILED
(
hr
)
)
{
return
nullptr
;
}
LARGE_INTEGER
pos
;
pos
.
QuadPart
=
0LL
;
hr
=
cloned
-
>
Seek
(
pos
STREAM_SEEK_SET
nullptr
)
;
if
(
FAILED
(
hr
)
)
{
return
nullptr
;
}
mPreserveStream
=
false
;
return
ToPreservedStreamPtr
(
std
:
:
move
(
cloned
)
)
;
}
bool
ProxyStream
:
:
GetInterface
(
void
*
*
aOutInterface
)
{
MOZ_ASSERT
(
!
mGlobalLockedBuf
)
;
MOZ_ASSERT
(
aOutInterface
)
;
if
(
!
aOutInterface
)
{
return
false
;
}
*
aOutInterface
=
mUnmarshaledProxy
.
release
(
)
;
return
true
;
}
ProxyStream
:
:
ProxyStream
(
REFIID
aIID
IUnknown
*
aObject
Environment
*
aEnv
ProxyStreamFlags
aFlags
)
:
mGlobalLockedBuf
(
nullptr
)
mHGlobal
(
nullptr
)
mBufSize
(
0
)
mPreserveStream
(
aFlags
&
ProxyStreamFlags
:
:
ePreservable
)
{
if
(
!
aObject
)
{
return
;
}
RefPtr
<
IStream
>
stream
;
HGLOBAL
hglobal
=
NULL
;
int
streamSize
=
0
;
DWORD
mshlFlags
=
mPreserveStream
?
MSHLFLAGS_TABLESTRONG
:
MSHLFLAGS_NORMAL
;
HRESULT
createStreamResult
=
S_OK
;
HRESULT
marshalResult
=
S_OK
;
HRESULT
statResult
=
S_OK
;
HRESULT
getHGlobalResult
=
S_OK
;
auto
marshalFn
=
[
&
aIID
aObject
mshlFlags
&
stream
&
streamSize
&
hglobal
&
createStreamResult
&
marshalResult
&
statResult
&
getHGlobalResult
aEnv
]
(
)
-
>
void
{
if
(
aEnv
)
{
bool
pushOk
=
aEnv
-
>
Push
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
pushOk
)
;
if
(
!
pushOk
)
{
return
;
}
}
auto
popEnv
=
MakeScopeExit
(
[
aEnv
]
(
)
-
>
void
{
if
(
!
aEnv
)
{
return
;
}
#
ifdef
MOZ_DIAGNOSTIC_ASSERT_ENABLED
bool
popOk
=
#
endif
aEnv
-
>
Pop
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
popOk
)
;
}
)
;
createStreamResult
=
:
:
CreateStreamOnHGlobal
(
nullptr
TRUE
getter_AddRefs
(
stream
)
)
;
if
(
FAILED
(
createStreamResult
)
)
{
return
;
}
marshalResult
=
:
:
CoMarshalInterface
(
stream
aIID
aObject
MSHCTX_LOCAL
nullptr
mshlFlags
)
;
MOZ_ASSERT
(
marshalResult
!
=
E_INVALIDARG
)
;
if
(
FAILED
(
marshalResult
)
)
{
return
;
}
STATSTG
statstg
;
statResult
=
stream
-
>
Stat
(
&
statstg
STATFLAG_NONAME
)
;
if
(
SUCCEEDED
(
statResult
)
)
{
streamSize
=
static_cast
<
int
>
(
statstg
.
cbSize
.
LowPart
)
;
}
else
{
return
;
}
getHGlobalResult
=
:
:
GetHGlobalFromStream
(
stream
&
hglobal
)
;
MOZ_ASSERT
(
SUCCEEDED
(
getHGlobalResult
)
)
;
}
;
if
(
XRE_IsParentProcess
(
)
)
{
marshalFn
(
)
;
}
else
{
EnsureMTA
mta
(
marshalFn
)
;
}
if
(
FAILED
(
createStreamResult
)
)
{
nsPrintfCString
hrAsStr
(
"
0x
%
08lX
"
createStreamResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
CreateStreamOnHGlobalFailure
hrAsStr
)
;
}
if
(
FAILED
(
marshalResult
)
)
{
AnnotateInterfaceRegistration
(
aIID
)
;
nsPrintfCString
hrAsStr
(
"
0x
%
08lX
"
marshalResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
CoMarshalInterfaceFailure
hrAsStr
)
;
}
if
(
FAILED
(
statResult
)
)
{
nsPrintfCString
hrAsStr
(
"
0x
%
08lX
"
statResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
StatFailure
hrAsStr
)
;
}
if
(
FAILED
(
getHGlobalResult
)
)
{
nsPrintfCString
hrAsStr
(
"
0x
%
08lX
"
getHGlobalResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
GetHGlobalFromStreamFailure
hrAsStr
)
;
}
mStream
=
std
:
:
move
(
stream
)
;
if
(
streamSize
)
{
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
ProxyStreamSizeFrom
"
IStream
:
:
Stat
"
_ns
)
;
mBufSize
=
streamSize
;
}
if
(
!
hglobal
)
{
return
;
}
mGlobalLockedBuf
=
reinterpret_cast
<
BYTE
*
>
(
:
:
GlobalLock
(
hglobal
)
)
;
mHGlobal
=
hglobal
;
if
(
!
streamSize
)
{
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
ProxyStreamSizeFrom
"
GlobalSize
"
_ns
)
;
mBufSize
=
static_cast
<
int
>
(
:
:
GlobalSize
(
hglobal
)
)
;
}
CrashReporter
:
:
AnnotateCrashReport
(
CrashReporter
:
:
Annotation
:
:
ProxyStreamSize
mBufSize
)
;
}
}
}
