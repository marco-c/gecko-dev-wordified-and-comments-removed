#
include
"
mozilla
/
Move
.
h
"
#
include
"
mozilla
/
mscom
/
EnsureMTA
.
h
"
#
include
"
mozilla
/
mscom
/
ProxyStream
.
h
"
#
include
"
mozilla
/
mscom
/
Utils
.
h
"
#
include
"
mozilla
/
WindowsVersion
.
h
"
#
if
defined
(
MOZ_CRASHREPORTER
)
#
include
"
InterfaceRegistrationAnnotator
.
h
"
#
include
"
nsExceptionHandler
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
endif
#
include
<
windows
.
h
>
#
include
<
objbase
.
h
>
#
include
<
shlwapi
.
h
>
namespace
mozilla
{
namespace
mscom
{
ProxyStream
:
:
ProxyStream
(
)
:
mGlobalLockedBuf
(
nullptr
)
mHGlobal
(
nullptr
)
mBufSize
(
0
)
{
}
ProxyStream
:
:
ProxyStream
(
REFIID
aIID
const
BYTE
*
aInitBuf
const
int
aInitBufSize
)
:
mStream
(
InitStream
(
aInitBuf
static_cast
<
const
UINT
>
(
aInitBufSize
)
)
)
mGlobalLockedBuf
(
nullptr
)
mHGlobal
(
nullptr
)
mBufSize
(
aInitBufSize
)
{
if
(
!
aInitBufSize
)
{
return
;
}
MOZ_ASSERT
(
mStream
)
;
if
(
!
mStream
)
{
return
;
}
HRESULT
unmarshalResult
=
S_OK
;
auto
marshalFn
=
[
&
]
(
)
-
>
void
{
unmarshalResult
=
:
:
CoGetInterfaceAndReleaseStream
(
mStream
.
forget
(
)
.
take
(
)
aIID
getter_AddRefs
(
mUnmarshaledProxy
)
)
;
MOZ_ASSERT
(
SUCCEEDED
(
unmarshalResult
)
)
;
}
;
if
(
XRE_IsParentProcess
(
)
)
{
marshalFn
(
)
;
}
else
{
EnsureMTA
mta
(
marshalFn
)
;
}
#
if
defined
(
MOZ_CRASHREPORTER
)
if
(
FAILED
(
unmarshalResult
)
)
{
nsPrintfCString
hrAsStr
(
"
0x
%
08X
"
unmarshalResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
NS_LITERAL_CSTRING
(
"
CoGetInterfaceAndReleaseStreamFailure
"
)
hrAsStr
)
;
AnnotateInterfaceRegistration
(
aIID
)
;
}
#
endif
}
already_AddRefed
<
IStream
>
ProxyStream
:
:
InitStream
(
const
BYTE
*
aInitBuf
const
UINT
aInitBufSize
)
{
if
(
!
aInitBuf
|
|
!
aInitBufSize
)
{
return
nullptr
;
}
HRESULT
hr
;
RefPtr
<
IStream
>
stream
;
if
(
IsWin8OrLater
(
)
)
{
stream
=
already_AddRefed
<
IStream
>
(
:
:
SHCreateMemStream
(
aInitBuf
aInitBufSize
)
)
;
if
(
!
stream
)
{
return
nullptr
;
}
}
else
{
HGLOBAL
hglobal
=
:
:
GlobalAlloc
(
GMEM_MOVEABLE
aInitBufSize
)
;
if
(
!
hglobal
)
{
return
nullptr
;
}
hr
=
:
:
CreateStreamOnHGlobal
(
hglobal
TRUE
getter_AddRefs
(
stream
)
)
;
if
(
FAILED
(
hr
)
)
{
:
:
GlobalFree
(
hglobal
)
;
return
nullptr
;
}
ULARGE_INTEGER
streamSize
;
streamSize
.
QuadPart
=
aInitBufSize
;
hr
=
stream
-
>
SetSize
(
streamSize
)
;
if
(
FAILED
(
hr
)
)
{
return
nullptr
;
}
void
*
streamBuf
=
:
:
GlobalLock
(
hglobal
)
;
if
(
!
streamBuf
)
{
return
nullptr
;
}
memcpy
(
streamBuf
aInitBuf
aInitBufSize
)
;
:
:
GlobalUnlock
(
hglobal
)
;
}
LARGE_INTEGER
streamOffset
;
streamOffset
.
QuadPart
=
0
;
hr
=
stream
-
>
Seek
(
streamOffset
STREAM_SEEK_SET
nullptr
)
;
if
(
FAILED
(
hr
)
)
{
return
nullptr
;
}
return
stream
.
forget
(
)
;
}
ProxyStream
:
:
ProxyStream
(
ProxyStream
&
&
aOther
)
{
*
this
=
mozilla
:
:
Move
(
aOther
)
;
}
ProxyStream
&
ProxyStream
:
:
operator
=
(
ProxyStream
&
&
aOther
)
{
mStream
=
Move
(
aOther
.
mStream
)
;
mGlobalLockedBuf
=
aOther
.
mGlobalLockedBuf
;
aOther
.
mGlobalLockedBuf
=
nullptr
;
mHGlobal
=
aOther
.
mHGlobal
;
aOther
.
mHGlobal
=
nullptr
;
mBufSize
=
aOther
.
mBufSize
;
aOther
.
mBufSize
=
0
;
mUnmarshaledProxy
=
Move
(
aOther
.
mUnmarshaledProxy
)
;
return
*
this
;
}
ProxyStream
:
:
~
ProxyStream
(
)
{
if
(
mHGlobal
&
&
mGlobalLockedBuf
)
{
DebugOnly
<
BOOL
>
result
=
:
:
GlobalUnlock
(
mHGlobal
)
;
MOZ_ASSERT
(
!
result
&
&
:
:
GetLastError
(
)
=
=
NO_ERROR
)
;
}
}
const
BYTE
*
ProxyStream
:
:
GetBuffer
(
int
&
aReturnedBufSize
)
const
{
aReturnedBufSize
=
0
;
if
(
!
mStream
)
{
return
nullptr
;
}
if
(
!
mGlobalLockedBuf
)
{
return
nullptr
;
}
aReturnedBufSize
=
mBufSize
;
return
mGlobalLockedBuf
;
}
RefPtr
<
IStream
>
ProxyStream
:
:
GetStream
(
)
const
{
MOZ_ASSERT
(
mStream
)
;
MOZ_ASSERT
(
mHGlobal
)
;
if
(
!
mStream
)
{
return
nullptr
;
}
LARGE_INTEGER
pos
;
pos
.
QuadPart
=
0LL
;
DebugOnly
<
HRESULT
>
hr
=
mStream
-
>
Seek
(
pos
STREAM_SEEK_SET
nullptr
)
;
MOZ_ASSERT
(
SUCCEEDED
(
hr
)
)
;
return
mStream
;
}
bool
ProxyStream
:
:
GetInterface
(
void
*
*
aOutInterface
)
{
MOZ_ASSERT
(
!
mGlobalLockedBuf
)
;
MOZ_ASSERT
(
aOutInterface
)
;
if
(
!
aOutInterface
)
{
return
false
;
}
*
aOutInterface
=
mUnmarshaledProxy
.
release
(
)
;
return
true
;
}
ProxyStream
:
:
ProxyStream
(
REFIID
aIID
IUnknown
*
aObject
)
:
mGlobalLockedBuf
(
nullptr
)
mHGlobal
(
nullptr
)
mBufSize
(
0
)
{
if
(
!
aObject
)
{
return
;
}
RefPtr
<
IStream
>
stream
;
HGLOBAL
hglobal
=
NULL
;
int
streamSize
=
0
;
HRESULT
marshalResult
=
S_OK
;
auto
marshalFn
=
[
&
]
(
)
-
>
void
{
HRESULT
hr
=
:
:
CreateStreamOnHGlobal
(
nullptr
TRUE
getter_AddRefs
(
stream
)
)
;
if
(
FAILED
(
hr
)
)
{
return
;
}
hr
=
:
:
CoMarshalInterface
(
stream
aIID
aObject
MSHCTX_LOCAL
nullptr
MSHLFLAGS_NORMAL
)
;
if
(
FAILED
(
hr
)
)
{
marshalResult
=
hr
;
return
;
}
STATSTG
statstg
;
hr
=
stream
-
>
Stat
(
&
statstg
STATFLAG_NONAME
)
;
if
(
SUCCEEDED
(
hr
)
)
{
streamSize
=
static_cast
<
int
>
(
statstg
.
cbSize
.
LowPart
)
;
}
hr
=
:
:
GetHGlobalFromStream
(
stream
&
hglobal
)
;
MOZ_ASSERT
(
SUCCEEDED
(
hr
)
)
;
}
;
if
(
XRE_IsParentProcess
(
)
)
{
marshalFn
(
)
;
}
else
{
EnsureMTA
mta
(
marshalFn
)
;
}
#
if
defined
(
MOZ_CRASHREPORTER
)
if
(
FAILED
(
marshalResult
)
)
{
AnnotateInterfaceRegistration
(
aIID
)
;
nsPrintfCString
hrAsStr
(
"
0x
%
08X
"
marshalResult
)
;
CrashReporter
:
:
AnnotateCrashReport
(
NS_LITERAL_CSTRING
(
"
CoMarshalInterfaceFailure
"
)
hrAsStr
)
;
}
#
endif
mStream
=
mozilla
:
:
Move
(
stream
)
;
mBufSize
=
streamSize
;
if
(
hglobal
)
{
mGlobalLockedBuf
=
reinterpret_cast
<
BYTE
*
>
(
:
:
GlobalLock
(
hglobal
)
)
;
mHGlobal
=
hglobal
;
if
(
!
streamSize
)
{
mBufSize
=
static_cast
<
int
>
(
:
:
GlobalSize
(
hglobal
)
)
;
}
}
}
}
}
