#
ifndef
mozilla_mscom_MainThreadHandoff_h
#
define
mozilla_mscom_MainThreadHandoff_h
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Move
.
h
"
#
include
"
mozilla
/
mscom
/
Interceptor
.
h
"
#
include
"
mozilla
/
mscom
/
MainThreadInvoker
.
h
"
#
include
"
mozilla
/
mscom
/
Utils
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
nsTArray
.
h
"
namespace
mozilla
{
namespace
mscom
{
struct
ArrayData
;
class
MainThreadHandoff
final
:
public
IInterceptorSink
public
ICallFrameWalker
{
public
:
static
HRESULT
Create
(
IHandlerProvider
*
aHandlerProvider
IInterceptorSink
*
*
aOutput
)
;
template
<
typename
Interface
>
static
HRESULT
WrapInterface
(
STAUniquePtr
<
Interface
>
aTargetInterface
Interface
*
*
aOutInterface
)
{
return
WrapInterface
<
Interface
>
(
Move
(
aTargetInterface
)
nullptr
aOutInterface
)
;
}
template
<
typename
Interface
>
static
HRESULT
WrapInterface
(
STAUniquePtr
<
Interface
>
aTargetInterface
IHandlerProvider
*
aHandlerProvider
Interface
*
*
aOutInterface
)
{
MOZ_ASSERT
(
!
IsProxy
(
aTargetInterface
.
get
(
)
)
)
;
RefPtr
<
IInterceptorSink
>
handoff
;
HRESULT
hr
=
MainThreadHandoff
:
:
Create
(
aHandlerProvider
getter_AddRefs
(
handoff
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
CreateInterceptor
(
Move
(
aTargetInterface
)
handoff
aOutInterface
)
;
}
STDMETHODIMP
QueryInterface
(
REFIID
riid
void
*
*
ppv
)
override
;
STDMETHODIMP_
(
ULONG
)
AddRef
(
)
override
;
STDMETHODIMP_
(
ULONG
)
Release
(
)
override
;
STDMETHODIMP
OnCall
(
ICallFrame
*
aFrame
)
override
;
STDMETHODIMP
SetInterceptor
(
IWeakReference
*
aInterceptor
)
override
;
STDMETHODIMP
GetHandler
(
CLSID
*
aHandlerClsid
)
override
;
STDMETHODIMP
GetHandlerPayloadSize
(
DWORD
*
aOutPayloadSize
)
override
;
STDMETHODIMP
WriteHandlerPayload
(
IStream
*
aStream
)
override
;
STDMETHODIMP_
(
REFIID
)
MarshalAs
(
REFIID
aIid
)
override
;
STDMETHODIMP
OnWalkInterface
(
REFIID
aIid
PVOID
*
aInterface
BOOL
aIsInParam
BOOL
aIsOutParam
)
override
;
private
:
explicit
MainThreadHandoff
(
IHandlerProvider
*
aHandlerProvider
)
;
~
MainThreadHandoff
(
)
;
HRESULT
FixArrayElements
(
ICallFrame
*
aFrame
const
ArrayData
&
aArrayData
)
;
HRESULT
FixIServiceProvider
(
ICallFrame
*
aFrame
)
;
private
:
ULONG
mRefCnt
;
RefPtr
<
IWeakReference
>
mInterceptor
;
RefPtr
<
IHandlerProvider
>
mHandlerProvider
;
}
;
}
}
#
endif
