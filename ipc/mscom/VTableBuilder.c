#
include
"
VTableBuilder
.
h
"
#
include
<
stdlib
.
h
>
static
HRESULT
STDMETHODCALLTYPE
QueryInterfaceThunk
(
IUnknown
*
aThis
REFIID
aIid
void
*
*
aOutInterface
)
{
void
*
*
table
=
(
void
*
*
)
aThis
;
IUnknown
*
real
=
(
IUnknown
*
)
table
[
1
]
;
return
real
-
>
lpVtbl
-
>
QueryInterface
(
real
aIid
aOutInterface
)
;
}
static
ULONG
STDMETHODCALLTYPE
AddRefThunk
(
IUnknown
*
aThis
)
{
void
*
*
table
=
(
void
*
*
)
aThis
;
IUnknown
*
real
=
(
IUnknown
*
)
table
[
1
]
;
return
real
-
>
lpVtbl
-
>
AddRef
(
real
)
;
}
static
ULONG
STDMETHODCALLTYPE
ReleaseThunk
(
IUnknown
*
aThis
)
{
void
*
*
table
=
(
void
*
*
)
aThis
;
IUnknown
*
real
=
(
IUnknown
*
)
table
[
1
]
;
return
real
-
>
lpVtbl
-
>
Release
(
real
)
;
}
IUnknown
*
BuildNullVTable
(
IUnknown
*
aUnk
uint32_t
aVtblSize
)
{
void
*
*
table
;
if
(
aVtblSize
<
3
)
{
return
NULL
;
}
table
=
calloc
(
aVtblSize
+
2
sizeof
(
void
*
)
)
;
table
[
0
]
=
&
table
[
2
]
;
table
[
1
]
=
aUnk
;
table
[
2
]
=
&
QueryInterfaceThunk
;
table
[
3
]
=
&
AddRefThunk
;
table
[
4
]
=
&
ReleaseThunk
;
return
(
IUnknown
*
)
table
;
}
void
DeleteNullVTable
(
IUnknown
*
aUnk
)
{
free
(
aUnk
)
;
}
