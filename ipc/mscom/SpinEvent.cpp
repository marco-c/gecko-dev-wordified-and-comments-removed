#
include
"
mozilla
/
mscom
/
SpinEvent
.
h
"
#
include
"
mozilla
/
ArrayUtils
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsSystemInfo
.
h
"
#
if
defined
(
_MSC_VER
)
#
include
<
intrin
.
h
>
#
pragma
intrinsic
(
_mm_pause
)
#
define
CPU_PAUSE
(
)
_mm_pause
(
)
#
elif
defined
(
__GNUC__
)
|
|
defined
(
__clang__
)
#
define
CPU_PAUSE
(
)
__builtin_ia32_pause
(
)
#
endif
namespace
mozilla
{
namespace
mscom
{
static
const
TimeDuration
kMaxSpinTime
=
TimeDuration
:
:
FromMilliseconds
(
30
)
;
bool
SpinEvent
:
:
sIsMulticore
=
false
;
bool
SpinEvent
:
:
InitStatics
(
)
{
SYSTEM_INFO
sysInfo
;
:
:
GetSystemInfo
(
&
sysInfo
)
;
sIsMulticore
=
sysInfo
.
dwNumberOfProcessors
>
1
;
return
true
;
}
SpinEvent
:
:
SpinEvent
(
)
:
mDone
(
false
)
{
static
const
bool
gotStatics
=
InitStatics
(
)
;
MOZ_ASSERT
(
gotStatics
)
;
mDoneEvent
.
own
(
:
:
CreateEventW
(
nullptr
FALSE
FALSE
nullptr
)
)
;
MOZ_ASSERT
(
mDoneEvent
)
;
}
bool
SpinEvent
:
:
Wait
(
HANDLE
aTargetThread
)
{
MOZ_ASSERT
(
aTargetThread
)
;
if
(
!
aTargetThread
)
{
return
false
;
}
if
(
sIsMulticore
)
{
TimeStamp
start
(
TimeStamp
:
:
Now
(
)
)
;
while
(
!
mDone
)
{
TimeDuration
elapsed
(
TimeStamp
:
:
Now
(
)
-
start
)
;
if
(
elapsed
>
=
kMaxSpinTime
)
{
break
;
}
CPU_PAUSE
(
)
;
}
if
(
mDone
)
{
return
true
;
}
}
MOZ_ASSERT
(
mDoneEvent
)
;
HANDLE
handles
[
]
=
{
mDoneEvent
aTargetThread
}
;
DWORD
waitResult
=
:
:
WaitForMultipleObjects
(
mozilla
:
:
ArrayLength
(
handles
)
handles
FALSE
INFINITE
)
;
return
waitResult
=
=
WAIT_OBJECT_0
;
}
void
SpinEvent
:
:
Signal
(
)
{
:
:
SetEvent
(
mDoneEvent
)
;
mDone
=
true
;
}
}
}
