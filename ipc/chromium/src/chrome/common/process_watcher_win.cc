#
include
"
chrome
/
common
/
process_watcher
.
h
"
#
include
"
base
/
message_loop
.
h
"
#
include
"
base
/
object_watcher
.
h
"
#
include
"
base
/
sys_info
.
h
"
#
include
"
chrome
/
common
/
result_codes
.
h
"
static
const
int
kWaitInterval
=
2000
;
namespace
{
class
ChildReaper
:
public
mozilla
:
:
Runnable
public
base
:
:
ObjectWatcher
:
:
Delegate
public
MessageLoop
:
:
DestructionObserver
{
public
:
explicit
ChildReaper
(
base
:
:
ProcessHandle
process
bool
force
)
:
process_
(
process
)
force_
(
force
)
{
watcher_
.
StartWatching
(
process_
this
)
;
}
virtual
~
ChildReaper
(
)
{
if
(
process_
)
{
KillProcess
(
)
;
DCHECK
(
!
process_
)
<
<
"
Make
sure
to
close
the
handle
.
"
;
}
}
virtual
void
WillDestroyCurrentMessageLoop
(
)
{
MOZ_ASSERT
(
!
force_
)
;
if
(
process_
)
{
WaitForSingleObject
(
process_
INFINITE
)
;
base
:
:
CloseProcessHandle
(
process_
)
;
process_
=
0
;
MessageLoop
:
:
current
(
)
-
>
RemoveDestructionObserver
(
this
)
;
delete
this
;
}
}
NS_IMETHOD
Run
(
)
override
{
MOZ_ASSERT
(
force_
)
;
if
(
process_
)
{
KillProcess
(
)
;
}
return
NS_OK
;
}
virtual
void
OnObjectSignaled
(
HANDLE
object
)
{
watcher_
.
StopWatching
(
)
;
base
:
:
CloseProcessHandle
(
process_
)
;
process_
=
0
;
if
(
!
force_
)
{
MessageLoop
:
:
current
(
)
-
>
RemoveDestructionObserver
(
this
)
;
delete
this
;
}
}
private
:
void
KillProcess
(
)
{
MOZ_ASSERT
(
force_
)
;
TerminateProcess
(
process_
ResultCodes
:
:
HUNG
)
;
OnObjectSignaled
(
process_
)
;
}
base
:
:
ProcessHandle
process_
;
base
:
:
ObjectWatcher
watcher_
;
bool
force_
;
DISALLOW_EVIL_CONSTRUCTORS
(
ChildReaper
)
;
}
;
}
void
ProcessWatcher
:
:
EnsureProcessTerminated
(
base
:
:
ProcessHandle
process
bool
force
)
{
DCHECK
(
process
!
=
GetCurrentProcess
(
)
)
;
if
(
WaitForSingleObject
(
process
0
)
=
=
WAIT_OBJECT_0
)
{
base
:
:
CloseProcessHandle
(
process
)
;
return
;
}
MessageLoopForIO
*
loop
=
MessageLoopForIO
:
:
current
(
)
;
if
(
force
)
{
RefPtr
<
mozilla
:
:
Runnable
>
task
=
new
ChildReaper
(
process
force
)
;
loop
-
>
PostDelayedTask
(
task
.
forget
(
)
kWaitInterval
)
;
}
else
{
loop
-
>
AddDestructionObserver
(
new
ChildReaper
(
process
force
)
)
;
}
}
