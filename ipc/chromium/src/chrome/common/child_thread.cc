#
include
"
chrome
/
common
/
child_thread
.
h
"
#
include
"
chrome
/
common
/
child_process
.
h
"
#
include
"
mozilla
/
ipc
/
NodeController
.
h
"
ChildThread
:
:
ChildThread
(
Thread
:
:
Options
options
)
:
Thread
(
"
IPC
I
/
O
Child
"
)
owner_loop_
(
MessageLoop
:
:
current
(
)
)
options_
(
options
)
{
DCHECK
(
owner_loop_
)
;
channel_name_
=
IPC
:
:
Channel
:
:
ChannelIDForCurrentProcess
(
)
;
}
ChildThread
:
:
~
ChildThread
(
)
=
default
;
bool
ChildThread
:
:
Run
(
)
{
bool
r
=
StartWithOptions
(
options_
)
;
return
r
;
}
ChildThread
*
ChildThread
:
:
current
(
)
{
return
ChildProcess
:
:
current
(
)
-
>
child_thread
(
)
;
}
void
ChildThread
:
:
Init
(
)
{
auto
channel
=
mozilla
:
:
MakeUnique
<
IPC
:
:
Channel
>
(
channel_name_
IPC
:
:
Channel
:
:
MODE_CLIENT
nullptr
)
;
#
if
defined
(
XP_WIN
)
channel
-
>
StartAcceptingHandles
(
IPC
:
:
Channel
:
:
MODE_CLIENT
)
;
#
elif
defined
(
XP_DARWIN
)
channel
-
>
StartAcceptingMachPorts
(
IPC
:
:
Channel
:
:
MODE_CLIENT
)
;
#
endif
initial_port_
=
mozilla
:
:
ipc
:
:
NodeController
:
:
InitChildProcess
(
std
:
:
move
(
channel
)
)
;
}
void
ChildThread
:
:
CleanUp
(
)
{
mozilla
:
:
ipc
:
:
NodeController
:
:
CleanUp
(
)
;
}
