#
ifndef
mozilla_ipc_CrashReporterHelper_h
#
define
mozilla_ipc_CrashReporterHelper_h
#
include
"
CrashReporterHost
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsIAppStartup
.
h
"
#
include
"
nsExceptionHandler
.
h
"
#
include
"
nsICrashService
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
namespace
mozilla
{
namespace
ipc
{
template
<
GeckoProcessType
PT
>
class
CrashReporterHelper
{
public
:
CrashReporterHelper
(
)
:
mCrashReporter
(
nullptr
)
{
}
IPCResult
RecvInitCrashReporter
(
const
CrashReporter
:
:
ThreadId
&
aThreadId
)
{
mCrashReporter
=
MakeUnique
<
ipc
:
:
CrashReporterHost
>
(
PT
aThreadId
)
;
return
IPC_OK
(
)
;
}
protected
:
void
GenerateCrashReport
(
base
:
:
ProcessId
aPid
nsString
*
aMinidumpId
=
nullptr
)
{
nsAutoString
minidumpId
;
if
(
!
mCrashReporter
)
{
HandleOrphanedMinidump
(
aPid
minidumpId
)
;
}
else
if
(
mCrashReporter
-
>
GenerateCrashReport
(
aPid
)
)
{
minidumpId
=
mCrashReporter
-
>
MinidumpID
(
)
;
}
if
(
aMinidumpId
)
{
*
aMinidumpId
=
minidumpId
;
}
mCrashReporter
=
nullptr
;
}
void
MaybeTerminateProcess
(
)
{
if
(
PR_GetEnv
(
"
MOZ_CRASHREPORTER_SHUTDOWN
"
)
)
{
NS_WARNING
(
nsPrintfCString
(
"
Shutting
down
due
to
%
s
process
crash
.
"
XRE_GetProcessTypeString
(
)
)
.
get
(
)
)
;
nsCOMPtr
<
nsIAppStartup
>
appService
=
do_GetService
(
"
mozilla
.
org
/
toolkit
/
app
-
startup
;
1
"
)
;
if
(
appService
)
{
bool
userAllowedQuit
=
true
;
appService
-
>
Quit
(
nsIAppStartup
:
:
eForceQuit
1
&
userAllowedQuit
)
;
}
}
}
private
:
void
HandleOrphanedMinidump
(
base
:
:
ProcessId
aPid
nsString
&
aMinidumpId
)
{
if
(
CrashReporter
:
:
FinalizeOrphanedMinidump
(
aPid
PT
&
aMinidumpId
)
)
{
CrashReporterHost
:
:
RecordCrash
(
PT
nsICrashService
:
:
CRASH_TYPE_CRASH
aMinidumpId
)
;
}
else
{
NS_WARNING
(
nsPrintfCString
(
"
child
process
pid
=
%
"
PRIPID
"
crashed
without
leaving
a
minidump
behind
"
aPid
)
.
get
(
)
)
;
}
}
protected
:
UniquePtr
<
ipc
:
:
CrashReporterHost
>
mCrashReporter
;
}
;
}
}
#
endif
