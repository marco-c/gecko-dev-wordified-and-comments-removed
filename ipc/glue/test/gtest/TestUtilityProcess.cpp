#
include
<
algorithm
>
#
include
<
type_traits
>
#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
gtest
/
ipc
/
TestUtilityProcess
.
h
"
#
include
"
mozilla
/
gtest
/
WaitFor
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
mozilla
/
ipc
/
UtilityProcessManager
.
h
"
#
if
defined
(
MOZ_WIDGET_ANDROID
)
|
|
defined
(
XP_MACOSX
)
#
include
"
nsIAppShellService
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
endif
#
if
defined
(
XP_WIN
)
#
include
"
mozilla
/
gtest
/
MozHelpers
.
h
"
#
include
"
mozilla
/
ipc
/
UtilityProcessImpl
.
h
"
#
endif
#
ifdef
MOZ_WIDGET_ANDROID
#
define
NS_APPSHELLSERVICE_CONTRACTID
"
mozilla
.
org
/
widget
/
appshell
/
android
;
1
"
#
endif
#
ifdef
XP_MACOSX
#
define
NS_APPSHELLSERVICE_CONTRACTID
"
mozilla
.
org
/
widget
/
appshell
/
mac
;
1
"
#
endif
using
namespace
mozilla
;
using
namespace
mozilla
:
:
gtest
:
:
ipc
;
using
namespace
mozilla
:
:
ipc
;
void
TestUtilityProcess
:
:
SetUpTestSuite
(
)
{
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
static
bool
sOnce
=
false
;
if
(
!
sOnce
)
{
mozilla
:
:
SandboxBroker
:
:
GeckoDependentInitialize
(
)
;
sOnce
=
true
;
}
#
endif
#
if
defined
(
MOZ_WIDGET_ANDROID
)
|
|
defined
(
XP_MACOSX
)
nsCOMPtr
<
nsIAppShellService
>
appShell
=
do_GetService
(
NS_APPSHELLSERVICE_CONTRACTID
)
;
#
endif
}
TEST_F
(
TestUtilityProcess
LaunchAllKinds
)
{
using
kind_t
=
std
:
:
underlying_type
<
SandboxingKind
>
:
:
type
;
auto
manager
=
UtilityProcessManager
:
:
GetSingleton
(
)
;
ASSERT_TRUE
(
manager
)
;
auto
currentPid
=
base
:
:
GetCurrentProcId
(
)
;
ASSERT_GE
(
currentPid
base
:
:
ProcessId
(
1
)
)
;
for
(
kind_t
i
=
0
;
i
<
SandboxingKind
:
:
COUNT
;
+
+
i
)
{
auto
kind
=
static_cast
<
SandboxingKind
>
(
i
)
;
auto
res
=
WaitFor
(
manager
-
>
LaunchProcess
(
kind
)
)
;
ASSERT_TRUE
(
res
.
isOk
(
)
)
<
<
"
First
launch
LaunchError
:
"
<
<
res
.
inspectErr
(
)
.
FunctionName
(
)
<
<
"
"
<
<
res
.
inspectErr
(
)
.
ErrorCode
(
)
;
}
std
:
:
array
<
base
:
:
ProcessId
SandboxingKind
:
:
COUNT
>
pids
{
}
;
for
(
kind_t
i
=
0
;
i
<
SandboxingKind
:
:
COUNT
;
+
+
i
)
{
auto
kind
=
static_cast
<
SandboxingKind
>
(
i
)
;
auto
utilityPid
=
manager
-
>
ProcessPid
(
kind
)
;
ASSERT_TRUE
(
utilityPid
.
isSome
(
)
)
<
<
"
No
PID
for
kind
"
<
<
kind
;
ASSERT_GE
(
*
utilityPid
base
:
:
ProcessId
(
1
)
)
;
ASSERT_NE
(
*
utilityPid
currentPid
)
;
printf_stderr
(
"
Utility
process
running
as
PID
%
"
PRIPID
"
\
n
"
*
utilityPid
)
;
pids
[
i
]
=
*
utilityPid
;
}
for
(
kind_t
i
=
0
;
i
<
SandboxingKind
:
:
COUNT
;
+
+
i
)
{
auto
kind
=
static_cast
<
SandboxingKind
>
(
i
)
;
auto
res
=
WaitFor
(
manager
-
>
LaunchProcess
(
kind
)
)
;
ASSERT_TRUE
(
res
.
isOk
(
)
)
<
<
"
Second
launch
LaunchError
:
"
<
<
res
.
inspectErr
(
)
.
FunctionName
(
)
<
<
"
"
<
<
res
.
inspectErr
(
)
.
ErrorCode
(
)
;
ASSERT_TRUE
(
manager
-
>
ProcessPid
(
kind
)
=
=
Some
(
pids
[
i
]
)
)
;
}
std
:
:
sort
(
pids
.
begin
(
)
pids
.
end
(
)
)
;
auto
adjacentEqualPids
=
std
:
:
adjacent_find
(
pids
.
begin
(
)
pids
.
end
(
)
)
;
ASSERT_TRUE
(
adjacentEqualPids
=
=
pids
.
end
(
)
)
;
for
(
kind_t
i
=
0
;
i
<
SandboxingKind
:
:
COUNT
;
+
+
i
)
{
auto
kind
=
static_cast
<
SandboxingKind
>
(
i
)
;
manager
-
>
CleanShutdown
(
kind
)
;
ASSERT_TRUE
(
manager
-
>
ProcessPid
(
kind
)
.
isNothing
(
)
)
;
}
NS_ProcessPendingEvents
(
nullptr
)
;
}
#
if
defined
(
XP_WIN
)
static
void
LoadLibraryCrash_Test
(
)
{
mozilla
:
:
gtest
:
:
DisableCrashReporter
(
)
;
UtilityProcessImpl
:
:
LoadLibraryOrCrash
(
L
"
2b49036e
-
6ba3
-
400c
-
a297
-
38fa1f6c5255
.
dll
"
)
;
}
TEST_F
(
TestUtilityProcess
LoadLibraryCrash
)
{
ASSERT_DEATH_IF_SUPPORTED
(
LoadLibraryCrash_Test
(
)
"
"
)
;
}
#
endif
