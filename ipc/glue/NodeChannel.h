#
ifndef
mozilla_ipc_NodeChannel_h
#
define
mozilla_ipc_NodeChannel_h
#
include
"
mojo
/
core
/
ports
/
node
.
h
"
#
include
"
mojo
/
core
/
ports
/
node_delegate
.
h
"
#
include
"
base
/
process
.
h
"
#
include
"
chrome
/
common
/
ipc_message
.
h
"
#
include
"
chrome
/
common
/
ipc_channel
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
nsISupports
.
h
"
#
include
"
nsTHashMap
.
h
"
#
include
"
mozilla
/
Queue
.
h
"
#
include
"
mozilla
/
DataMutex
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
ifdef
FUZZING_SNAPSHOT
#
include
"
mozilla
/
fuzzing
/
IPCFuzzController
.
h
"
#
endif
namespace
mozilla
:
:
ipc
{
class
GeckoChildProcessHost
;
class
NodeController
;
class
NodeChannel
final
:
public
IPC
:
:
Channel
:
:
Listener
{
using
NodeName
=
mojo
:
:
core
:
:
ports
:
:
NodeName
;
using
PortName
=
mojo
:
:
core
:
:
ports
:
:
PortName
;
#
ifdef
FUZZING_SNAPSHOT
friend
class
mozilla
:
:
fuzzing
:
:
IPCFuzzController
;
#
endif
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING_WITH_DESTROY
(
NodeChannel
Destroy
(
)
)
struct
Introduction
{
NodeName
mName
;
IPC
:
:
Channel
:
:
ChannelHandle
mHandle
;
IPC
:
:
Channel
:
:
Mode
mMode
;
base
:
:
ProcessId
mMyPid
=
base
:
:
kInvalidProcessId
;
base
:
:
ProcessId
mOtherPid
=
base
:
:
kInvalidProcessId
;
}
;
class
Listener
{
public
:
virtual
~
Listener
(
)
=
default
;
NS_INLINE_DECL_PURE_VIRTUAL_REFCOUNTING
virtual
void
OnEventMessage
(
const
NodeName
&
aFromNode
UniquePtr
<
IPC
:
:
Message
>
aMessage
)
=
0
;
virtual
void
OnBroadcast
(
const
NodeName
&
aFromNode
UniquePtr
<
IPC
:
:
Message
>
aMessage
)
=
0
;
virtual
void
OnIntroduce
(
const
NodeName
&
aFromNode
Introduction
aIntroduction
)
=
0
;
virtual
void
OnRequestIntroduction
(
const
NodeName
&
aFromNode
const
NodeName
&
aName
)
=
0
;
virtual
void
OnAcceptInvite
(
const
NodeName
&
aFromNode
const
NodeName
&
aRealName
const
PortName
&
aInitialPort
)
=
0
;
virtual
void
OnChannelError
(
const
NodeName
&
aFromNode
)
=
0
;
}
;
NodeChannel
(
const
NodeName
&
aName
IPC
:
:
Channel
*
aChannel
Listener
*
aListener
base
:
:
ProcessId
aPid
=
base
:
:
kInvalidProcessId
GeckoChildProcessHost
*
aChildProcessHost
=
nullptr
)
;
void
SendEventMessage
(
UniquePtr
<
IPC
:
:
Message
>
aMessage
)
;
void
Broadcast
(
UniquePtr
<
IPC
:
:
Message
>
aMessage
)
;
void
RequestIntroduction
(
const
NodeName
&
aPeerName
)
;
void
Introduce
(
Introduction
aIntroduction
)
;
void
AcceptInvite
(
const
NodeName
&
aRealName
const
PortName
&
aInitialPort
)
;
base
:
:
ProcessId
OtherPid
(
)
const
{
return
mOtherPid
;
}
void
Start
(
)
;
void
Close
(
)
;
void
SetName
(
const
NodeName
&
aNewName
)
{
mName
=
aNewName
;
}
#
ifdef
FUZZING_SNAPSHOT
const
NodeName
&
GetName
(
)
{
return
mName
;
}
#
endif
void
SetOtherPid
(
base
:
:
ProcessId
aNewPid
)
;
#
ifdef
XP_DARWIN
void
SetMachTaskPort
(
task_t
aTask
)
;
#
endif
private
:
~
NodeChannel
(
)
;
void
Destroy
(
)
;
void
FinalDestroy
(
)
;
void
SendMessage
(
UniquePtr
<
IPC
:
:
Message
>
aMessage
)
;
void
OnMessageReceived
(
UniquePtr
<
IPC
:
:
Message
>
aMessage
)
override
;
void
OnChannelConnected
(
base
:
:
ProcessId
aPeerPid
)
override
;
void
OnChannelError
(
)
override
;
const
RefPtr
<
Listener
>
mListener
;
NodeName
mName
;
std
:
:
atomic
<
base
:
:
ProcessId
>
mOtherPid
;
const
RefPtr
<
IPC
:
:
Channel
>
mChannel
;
enum
class
State
{
Active
Closing
Closed
}
;
std
:
:
atomic
<
State
>
mState
=
State
:
:
Active
;
#
ifdef
FUZZING_SNAPSHOT
std
:
:
atomic
<
bool
>
mBlockSendRecv
=
false
;
#
endif
WeakPtr
<
mozilla
:
:
ipc
:
:
GeckoChildProcessHost
>
mChildProcessHost
;
}
;
}
#
endif
