#
include
"
mozilla
/
ipc
/
InProcessParent
.
h
"
#
include
"
mozilla
/
ipc
/
InProcessChild
.
h
"
#
include
"
nsIObserverService
.
h
"
#
include
"
mozilla
/
Services
.
h
"
namespace
mozilla
{
namespace
ipc
{
StaticRefPtr
<
InProcessParent
>
InProcessParent
:
:
sSingleton
;
StaticRefPtr
<
InProcessChild
>
InProcessChild
:
:
sSingleton
;
bool
InProcessParent
:
:
sShutdown
=
false
;
InProcessChild
*
InProcessChild
:
:
Singleton
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
sSingleton
)
{
InProcessParent
:
:
Startup
(
)
;
}
return
sSingleton
;
}
InProcessParent
*
InProcessParent
:
:
Singleton
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
sSingleton
)
{
InProcessParent
:
:
Startup
(
)
;
}
return
sSingleton
;
}
void
InProcessParent
:
:
Startup
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
sShutdown
)
{
NS_WARNING
(
"
Could
not
get
in
-
process
actor
while
shutting
down
!
"
)
;
return
;
}
nsCOMPtr
<
nsIObserverService
>
obs
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
!
obs
)
{
sShutdown
=
true
;
NS_WARNING
(
"
Failed
to
get
nsIObserverService
for
in
-
process
actor
"
)
;
return
;
}
RefPtr
<
InProcessParent
>
parent
=
new
InProcessParent
(
)
;
RefPtr
<
InProcessChild
>
child
=
new
InProcessChild
(
)
;
nsresult
rv
=
obs
-
>
AddObserver
(
parent
NS_XPCOM_SHUTDOWN_OBSERVER_ID
false
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
;
}
if
(
!
child
-
>
OpenOnSameThread
(
parent
-
>
GetIPCChannel
(
)
ChildSide
)
)
{
MOZ_CRASH
(
"
Failed
to
open
InProcessChild
!
"
)
;
}
parent
-
>
SetOtherProcessId
(
base
:
:
GetCurrentProcId
(
)
)
;
parent
.
get
(
)
-
>
AddRef
(
)
;
child
.
get
(
)
-
>
AddRef
(
)
;
InProcessParent
:
:
sSingleton
=
parent
.
forget
(
)
;
InProcessChild
:
:
sSingleton
=
child
.
forget
(
)
;
}
void
InProcessParent
:
:
Shutdown
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
sSingleton
|
|
sShutdown
)
{
return
;
}
sShutdown
=
true
;
RefPtr
<
InProcessParent
>
parent
=
sSingleton
;
InProcessParent
:
:
sSingleton
=
nullptr
;
InProcessChild
:
:
sSingleton
=
nullptr
;
parent
-
>
Close
(
)
;
}
NS_IMETHODIMP
InProcessParent
:
:
Observe
(
nsISupports
*
aSubject
const
char
*
aTopic
const
char16_t
*
aData
)
{
MOZ_ASSERT
(
!
strcmp
(
aTopic
NS_XPCOM_SHUTDOWN_OBSERVER_ID
)
)
;
InProcessParent
:
:
Shutdown
(
)
;
return
NS_OK
;
}
void
InProcessParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
InProcessParent
:
:
Shutdown
(
)
;
}
void
InProcessChild
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
InProcessParent
:
:
Shutdown
(
)
;
}
void
InProcessParent
:
:
DeallocPInProcessParent
(
)
{
MOZ_ASSERT
(
!
InProcessParent
:
:
sSingleton
)
;
Release
(
)
;
}
void
InProcessChild
:
:
DeallocPInProcessChild
(
)
{
MOZ_ASSERT
(
!
InProcessChild
:
:
sSingleton
)
;
Release
(
)
;
}
static
IProtocol
*
GetOtherInProcessActor
(
IProtocol
*
aActor
)
{
MOZ_ASSERT
(
aActor
-
>
GetSide
(
)
!
=
UnknownSide
"
bad
unknown
side
"
)
;
IProtocol
*
current
=
aActor
;
while
(
current
)
{
if
(
current
-
>
GetProtocolTypeId
(
)
=
=
PInProcessMsgStart
)
{
break
;
}
current
=
current
-
>
Manager
(
)
;
}
if
(
!
current
)
{
return
nullptr
;
}
MOZ_ASSERT
(
current
-
>
GetSide
(
)
=
=
aActor
-
>
GetSide
(
)
"
side
changed
?
"
)
;
MOZ_ASSERT_IF
(
aActor
-
>
GetSide
(
)
=
=
ParentSide
current
=
=
InProcessParent
:
:
Singleton
(
)
)
;
MOZ_ASSERT_IF
(
aActor
-
>
GetSide
(
)
=
=
ChildSide
current
=
=
InProcessChild
:
:
Singleton
(
)
)
;
IProtocol
*
otherRoot
=
nullptr
;
if
(
aActor
-
>
GetSide
(
)
=
=
ParentSide
)
{
otherRoot
=
InProcessChild
:
:
Singleton
(
)
;
}
else
{
otherRoot
=
InProcessParent
:
:
Singleton
(
)
;
}
if
(
NS_WARN_IF
(
!
otherRoot
)
)
{
return
nullptr
;
}
IProtocol
*
otherActor
=
otherRoot
-
>
Lookup
(
aActor
-
>
Id
(
)
)
;
if
(
otherActor
)
{
MOZ_ASSERT
(
otherActor
-
>
GetSide
(
)
!
=
UnknownSide
"
bad
unknown
side
"
)
;
MOZ_ASSERT
(
otherActor
-
>
GetSide
(
)
!
=
aActor
-
>
GetSide
(
)
"
Wrong
side
!
"
)
;
MOZ_ASSERT
(
otherActor
-
>
GetProtocolTypeId
(
)
=
=
aActor
-
>
GetProtocolTypeId
(
)
"
Wrong
type
of
protocol
!
"
)
;
}
return
otherActor
;
}
IProtocol
*
InProcessParent
:
:
ChildActorFor
(
IProtocol
*
aActor
)
{
MOZ_ASSERT
(
aActor
&
&
aActor
-
>
GetSide
(
)
=
=
ParentSide
)
;
return
GetOtherInProcessActor
(
aActor
)
;
}
IProtocol
*
InProcessChild
:
:
ParentActorFor
(
IProtocol
*
aActor
)
{
MOZ_ASSERT
(
aActor
&
&
aActor
-
>
GetSide
(
)
=
=
ChildSide
)
;
return
GetOtherInProcessActor
(
aActor
)
;
}
}
}
