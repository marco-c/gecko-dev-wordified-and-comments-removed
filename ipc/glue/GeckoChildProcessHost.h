#
ifndef
__IPC_GLUE_GECKOCHILDPROCESSHOST_H__
#
define
__IPC_GLUE_GECKOCHILDPROCESSHOST_H__
#
include
"
base
/
file_path
.
h
"
#
include
"
base
/
process_util
.
h
"
#
include
"
base
/
waitable_event
.
h
"
#
include
"
chrome
/
common
/
ipc_message
.
h
"
#
include
"
mojo
/
core
/
ports
/
port_ref
.
h
"
#
include
"
mozilla
/
ipc
/
Endpoint
.
h
"
#
include
"
mozilla
/
ipc
/
FileDescriptor
.
h
"
#
include
"
mozilla
/
ipc
/
NodeChannel
.
h
"
#
include
"
mozilla
/
ipc
/
LaunchError
.
h
"
#
include
"
mozilla
/
ipc
/
ScopedPort
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
Buffer
.
h
"
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
RWLock
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsExceptionHandler
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
include
"
nsString
.
h
"
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
"
sandboxBroker
.
h
"
#
endif
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
"
mozilla
/
Sandbox
.
h
"
#
endif
#
if
defined
(
MOZ_SANDBOX
)
#
include
"
mozilla
/
ipc
/
UtilityProcessSandboxing
.
h
"
#
endif
#
if
(
defined
(
XP_WIN
)
&
&
defined
(
_ARM64_
)
)
|
|
\
(
defined
(
XP_MACOSX
)
&
&
defined
(
__aarch64__
)
)
#
define
ALLOW_GECKO_CHILD_PROCESS_ARCH
#
endif
struct
_MacSandboxInfo
;
typedef
_MacSandboxInfo
MacSandboxInfo
;
namespace
mozilla
{
namespace
ipc
{
typedef
mozilla
:
:
MozPromise
<
base
:
:
ProcessHandle
LaunchError
false
>
ProcessHandlePromise
;
class
GeckoChildProcessHost
:
public
SupportsWeakPtr
public
LinkedListElement
<
GeckoChildProcessHost
>
{
protected
:
typedef
mozilla
:
:
Monitor
Monitor
;
typedef
std
:
:
vector
<
std
:
:
string
>
StringVector
;
public
:
using
ProcessId
=
base
:
:
ProcessId
;
using
ProcessHandle
=
base
:
:
ProcessHandle
;
explicit
GeckoChildProcessHost
(
GeckoProcessType
aProcessType
bool
aIsFileContent
=
false
)
;
void
Destroy
(
)
;
static
uint32_t
GetUniqueID
(
)
;
void
SetEnv
(
const
char
*
aKey
const
char
*
aValue
)
;
bool
AsyncLaunch
(
StringVector
aExtraOpts
=
StringVector
(
)
)
;
virtual
bool
WaitUntilConnected
(
int32_t
aTimeoutMs
=
0
)
;
bool
LaunchAndWaitForProcessHandle
(
StringVector
aExtraOpts
=
StringVector
(
)
)
;
bool
WaitForProcessHandle
(
)
;
bool
SyncLaunch
(
StringVector
aExtraOpts
=
StringVector
(
)
int32_t
timeoutMs
=
0
)
;
virtual
void
OnChannelConnected
(
base
:
:
ProcessId
peer_pid
)
;
RefPtr
<
ProcessHandlePromise
>
WhenProcessHandleReady
(
)
;
void
InitializeChannel
(
IPC
:
:
Channel
:
:
ChannelHandle
&
&
aServerHandle
)
;
virtual
bool
CanShutdown
(
)
{
return
true
;
}
UntypedEndpoint
TakeInitialEndpoint
(
)
{
return
UntypedEndpoint
{
PrivateIPDLInterface
{
}
std
:
:
move
(
mInitialPort
)
mInitialChannelId
base
:
:
GetCurrentProcId
(
)
GetChildProcessId
(
)
}
;
}
ProcessHandle
GetChildProcessHandle
(
)
;
ProcessId
GetChildProcessId
(
)
;
GeckoProcessType
GetProcessType
(
)
{
return
mProcessType
;
}
#
ifdef
XP_MACOSX
task_t
GetChildTask
(
)
;
#
endif
#
ifdef
XP_WIN
void
AddHandleToShare
(
HANDLE
aHandle
)
{
mLaunchOptions
-
>
handles_to_inherit
.
push_back
(
aHandle
)
;
}
#
else
void
AddFdToRemap
(
int
aSrcFd
int
aDstFd
)
{
mLaunchOptions
-
>
fds_to_remap
.
push_back
(
std
:
:
make_pair
(
aSrcFd
aDstFd
)
)
;
}
#
endif
#
ifdef
ALLOW_GECKO_CHILD_PROCESS_ARCH
void
SetLaunchArchitecture
(
uint32_t
aArch
)
{
mLaunchArch
=
aArch
;
}
#
endif
void
SetAlreadyDead
(
)
;
#
if
defined
(
MOZ_SANDBOX
)
&
&
defined
(
XP_MACOSX
)
static
bool
StartMacSandbox
(
int
aArgc
char
*
*
aArgv
std
:
:
string
&
aErrorMessage
)
;
static
MacSandboxType
GetDefaultMacSandboxType
(
)
{
return
MacSandboxType_Utility
;
}
;
void
DisableOSActivityMode
(
)
;
#
endif
typedef
std
:
:
function
<
void
(
GeckoChildProcessHost
*
)
>
GeckoProcessCallback
;
static
void
GetAll
(
const
GeckoProcessCallback
&
aCallback
)
;
friend
class
BaseProcessLauncher
;
friend
class
PosixProcessLauncher
;
friend
class
WindowsProcessLauncher
;
protected
:
virtual
~
GeckoChildProcessHost
(
)
;
GeckoProcessType
mProcessType
;
bool
mIsFileContent
;
Monitor
mMonitor
;
FilePath
mProcessPath
;
#
ifdef
ALLOW_GECKO_CHILD_PROCESS_ARCH
uint32_t
mLaunchArch
=
base
:
:
PROCESS_ARCH_INVALID
;
#
endif
UniquePtr
<
base
:
:
LaunchOptions
>
mLaunchOptions
;
ScopedPort
mInitialPort
;
nsID
mInitialChannelId
;
RefPtr
<
NodeController
>
mNodeController
;
RefPtr
<
NodeChannel
>
mNodeChannel
;
enum
{
CREATING_CHANNEL
=
0
CHANNEL_INITIALIZED
PROCESS_CREATED
PROCESS_CONNECTED
PROCESS_ERROR
}
mProcessState
MOZ_GUARDED_BY
(
mMonitor
)
;
void
PrepareLaunch
(
)
;
#
ifdef
XP_WIN
void
InitWindowsGroupID
(
)
;
nsString
mGroupId
;
#
ifdef
MOZ_SANDBOX
RefPtr
<
AbstractSandboxBroker
>
mSandboxBroker
;
std
:
:
vector
<
std
:
:
wstring
>
mAllowedFilesRead
;
bool
mEnableSandboxLogging
;
int32_t
mSandboxLevel
;
#
endif
#
endif
#
if
defined
(
MOZ_SANDBOX
)
SandboxingKind
mSandbox
;
#
endif
mozilla
:
:
RWLock
mHandleLock
;
ProcessHandle
mChildProcessHandle
MOZ_GUARDED_BY
(
mHandleLock
)
;
#
if
defined
(
XP_DARWIN
)
task_t
mChildTask
MOZ_GUARDED_BY
(
mHandleLock
)
;
#
endif
RefPtr
<
ProcessHandlePromise
>
mHandlePromise
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
bool
mDisableOSActivityMode
;
#
endif
bool
OpenPrivilegedHandle
(
base
:
:
ProcessId
aPid
)
MOZ_REQUIRES
(
mHandleLock
)
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
virtual
bool
IsMacSandboxLaunchEnabled
(
)
{
return
false
;
}
virtual
bool
FillMacSandboxInfo
(
MacSandboxInfo
&
aInfo
)
;
virtual
bool
AppendMacSandboxParams
(
StringVector
&
aArgs
)
;
#
endif
private
:
DISALLOW_EVIL_CONSTRUCTORS
(
GeckoChildProcessHost
)
;
void
RemoveFromProcessList
(
)
;
nsCString
mTmpDirName
;
nsCOMPtr
<
nsIFile
>
mProfileDir
;
mozilla
:
:
Atomic
<
bool
>
mDestroying
;
static
uint32_t
sNextUniqueID
;
static
StaticAutoPtr
<
LinkedList
<
GeckoChildProcessHost
>
>
sGeckoChildProcessHosts
MOZ_GUARDED_BY
(
sMutex
)
;
static
StaticMutex
sMutex
;
}
;
nsCOMPtr
<
nsIEventTarget
>
GetIPCLauncher
(
)
;
}
}
#
endif
