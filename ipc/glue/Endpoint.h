#
ifndef
IPC_GLUE_ENDPOINT_H_
#
define
IPC_GLUE_ENDPOINT_H_
#
include
<
utility
>
#
include
"
CrashAnnotations
.
h
"
#
include
"
base
/
process
.
h
"
#
include
"
base
/
process_util
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
ipc
/
MessageLink
.
h
"
#
include
"
mozilla
/
ipc
/
Transport
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
include
"
nscore
.
h
"
namespace
IPC
{
template
<
class
P
>
struct
ParamTraits
;
}
namespace
mozilla
{
namespace
ipc
{
struct
PrivateIPDLInterface
{
}
;
template
<
class
PFooSide
>
class
Endpoint
{
public
:
typedef
base
:
:
ProcessId
ProcessId
;
Endpoint
(
)
:
mValid
(
false
)
mMode
(
static_cast
<
mozilla
:
:
ipc
:
:
Transport
:
:
Mode
>
(
0
)
)
mMyPid
(
0
)
mOtherPid
(
0
)
{
}
Endpoint
(
const
PrivateIPDLInterface
&
mozilla
:
:
ipc
:
:
Transport
:
:
Mode
aMode
TransportDescriptor
aTransport
ProcessId
aMyPid
ProcessId
aOtherPid
)
:
mValid
(
true
)
mMode
(
aMode
)
mTransport
(
aTransport
)
mMyPid
(
aMyPid
)
mOtherPid
(
aOtherPid
)
{
}
Endpoint
(
Endpoint
&
&
aOther
)
:
mValid
(
aOther
.
mValid
)
mTransport
(
aOther
.
mTransport
)
mMyPid
(
aOther
.
mMyPid
)
mOtherPid
(
aOther
.
mOtherPid
)
{
if
(
aOther
.
mValid
)
{
mMode
=
aOther
.
mMode
;
}
aOther
.
mValid
=
false
;
}
Endpoint
&
operator
=
(
Endpoint
&
&
aOther
)
{
mValid
=
aOther
.
mValid
;
if
(
aOther
.
mValid
)
{
mMode
=
aOther
.
mMode
;
}
mTransport
=
aOther
.
mTransport
;
mMyPid
=
aOther
.
mMyPid
;
mOtherPid
=
aOther
.
mOtherPid
;
aOther
.
mValid
=
false
;
return
*
this
;
}
~
Endpoint
(
)
{
if
(
mValid
)
{
CloseDescriptor
(
mTransport
)
;
}
}
ProcessId
OtherPid
(
)
const
{
return
mOtherPid
;
}
bool
Bind
(
PFooSide
*
aActor
)
{
MOZ_RELEASE_ASSERT
(
mValid
)
;
MOZ_RELEASE_ASSERT
(
mMyPid
=
=
base
:
:
GetCurrentProcId
(
)
)
;
UniquePtr
<
Transport
>
transport
=
mozilla
:
:
ipc
:
:
OpenDescriptor
(
mTransport
mMode
)
;
if
(
!
transport
)
{
return
false
;
}
if
(
!
aActor
-
>
Open
(
std
:
:
move
(
transport
)
mOtherPid
XRE_GetIOMessageLoop
(
)
mMode
=
=
Transport
:
:
MODE_SERVER
?
ParentSide
:
ChildSide
)
)
{
return
false
;
}
mValid
=
false
;
return
true
;
}
bool
IsValid
(
)
const
{
return
mValid
;
}
private
:
friend
struct
IPC
:
:
ParamTraits
<
Endpoint
<
PFooSide
>
>
;
Endpoint
(
const
Endpoint
&
)
=
delete
;
Endpoint
&
operator
=
(
const
Endpoint
&
)
=
delete
;
bool
mValid
;
mozilla
:
:
ipc
:
:
Transport
:
:
Mode
mMode
;
TransportDescriptor
mTransport
;
ProcessId
mMyPid
mOtherPid
;
}
;
#
if
defined
(
XP_MACOSX
)
void
AnnotateCrashReportWithErrno
(
CrashReporter
:
:
Annotation
tag
int
error
)
;
#
else
static
inline
void
AnnotateCrashReportWithErrno
(
CrashReporter
:
:
Annotation
tag
int
error
)
{
}
#
endif
template
<
class
PFooParent
class
PFooChild
>
nsresult
CreateEndpoints
(
const
PrivateIPDLInterface
&
aPrivate
base
:
:
ProcessId
aParentDestPid
base
:
:
ProcessId
aChildDestPid
Endpoint
<
PFooParent
>
*
aParentEndpoint
Endpoint
<
PFooChild
>
*
aChildEndpoint
)
{
MOZ_RELEASE_ASSERT
(
aParentDestPid
)
;
MOZ_RELEASE_ASSERT
(
aChildDestPid
)
;
TransportDescriptor
parentTransport
childTransport
;
nsresult
rv
;
if
(
NS_FAILED
(
rv
=
CreateTransport
(
aParentDestPid
&
parentTransport
&
childTransport
)
)
)
{
AnnotateCrashReportWithErrno
(
CrashReporter
:
:
Annotation
:
:
IpcCreateEndpointsNsresult
int
(
rv
)
)
;
return
rv
;
}
*
aParentEndpoint
=
Endpoint
<
PFooParent
>
(
aPrivate
mozilla
:
:
ipc
:
:
Transport
:
:
MODE_SERVER
parentTransport
aParentDestPid
aChildDestPid
)
;
*
aChildEndpoint
=
Endpoint
<
PFooChild
>
(
aPrivate
mozilla
:
:
ipc
:
:
Transport
:
:
MODE_CLIENT
childTransport
aChildDestPid
aParentDestPid
)
;
return
NS_OK
;
}
template
<
class
PFooSide
>
class
ManagedEndpoint
{
public
:
ManagedEndpoint
(
)
:
mId
(
0
)
{
}
ManagedEndpoint
(
const
PrivateIPDLInterface
&
int32_t
aId
)
:
mId
(
aId
)
{
}
ManagedEndpoint
(
ManagedEndpoint
&
&
aOther
)
:
mId
(
aOther
.
mId
)
{
aOther
.
mId
=
0
;
}
ManagedEndpoint
&
operator
=
(
ManagedEndpoint
&
&
aOther
)
{
mId
=
aOther
.
mId
;
aOther
.
mId
=
0
;
return
*
this
;
}
bool
IsValid
(
)
const
{
return
mId
!
=
0
;
}
Maybe
<
int32_t
>
ActorId
(
)
const
{
return
IsValid
(
)
?
Some
(
mId
)
:
Nothing
(
)
;
}
bool
operator
=
=
(
const
ManagedEndpoint
&
_o
)
const
{
return
mId
=
=
_o
.
mId
;
}
private
:
friend
struct
IPC
:
:
ParamTraits
<
ManagedEndpoint
<
PFooSide
>
>
;
ManagedEndpoint
(
const
ManagedEndpoint
&
)
=
delete
;
ManagedEndpoint
&
operator
=
(
const
ManagedEndpoint
&
)
=
delete
;
int32_t
mId
;
}
;
}
}
#
endif
