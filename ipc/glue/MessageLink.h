#
ifndef
ipc_glue_MessageLink_h
#
define
ipc_glue_MessageLink_h
1
#
include
<
cstdint
>
#
include
"
base
/
message_loop
.
h
"
#
include
"
mojo
/
core
/
ports
/
node
.
h
"
#
include
"
mojo
/
core
/
ports
/
port_ref
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
ipc
/
ScopedPort
.
h
"
namespace
IPC
{
class
Message
;
class
MessageReader
;
class
MessageWriter
;
}
namespace
mozilla
{
namespace
ipc
{
class
MessageChannel
;
class
NodeController
;
struct
HasResultCodes
{
enum
Result
{
MsgProcessed
MsgDropped
MsgNotKnown
MsgNotAllowed
MsgPayloadError
MsgProcessingError
MsgRouteError
MsgValueError
}
;
}
;
enum
Side
:
uint8_t
{
ParentSide
ChildSide
UnknownSide
}
;
class
MessageLink
{
public
:
typedef
IPC
:
:
Message
Message
;
explicit
MessageLink
(
MessageChannel
*
aChan
)
;
virtual
~
MessageLink
(
)
;
virtual
void
SendMessage
(
mozilla
:
:
UniquePtr
<
Message
>
msg
)
=
0
;
virtual
void
Close
(
)
=
0
;
virtual
bool
IsClosed
(
)
const
=
0
;
#
ifdef
FUZZING_SNAPSHOT
virtual
Maybe
<
mojo
:
:
core
:
:
ports
:
:
PortName
>
GetPortName
(
)
{
return
Nothing
(
)
;
}
#
endif
protected
:
MessageChannel
*
mChan
;
}
;
class
PortLink
final
:
public
MessageLink
{
using
PortRef
=
mojo
:
:
core
:
:
ports
:
:
PortRef
;
using
PortStatus
=
mojo
:
:
core
:
:
ports
:
:
PortStatus
;
using
UserMessage
=
mojo
:
:
core
:
:
ports
:
:
UserMessage
;
using
UserMessageEvent
=
mojo
:
:
core
:
:
ports
:
:
UserMessageEvent
;
public
:
PortLink
(
MessageChannel
*
aChan
ScopedPort
aPort
)
;
virtual
~
PortLink
(
)
;
void
SendMessage
(
UniquePtr
<
Message
>
aMessage
)
override
;
void
Close
(
)
override
;
bool
IsClosed
(
)
const
override
;
#
ifdef
FUZZING_SNAPSHOT
Maybe
<
mojo
:
:
core
:
:
ports
:
:
PortName
>
GetPortName
(
)
override
{
return
Some
(
mPort
.
name
(
)
)
;
}
#
endif
private
:
class
PortObserverThunk
;
friend
class
PortObserverThunk
;
void
OnPortStatusChanged
(
)
;
void
Clear
(
)
;
const
RefPtr
<
NodeController
>
mNode
;
const
PortRef
mPort
;
RefPtr
<
PortObserverThunk
>
mObserver
;
}
;
}
}
#
endif
