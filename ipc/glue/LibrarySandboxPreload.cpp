#
include
"
LibrarySandboxPreload
.
h
"
#
include
"
BinaryPath
.
h
"
#
include
"
prlink
.
h
"
namespace
mozilla
{
namespace
ipc
{
PathString
GetSandboxedRLBoxPath
(
)
{
nsCOMPtr
<
nsIFile
>
libFile
;
nsresult
rv
=
mozilla
:
:
BinaryPath
:
:
GetFile
(
getter_AddRefs
(
libFile
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
MOZ_CRASH
(
"
Library
preload
failure
:
Failed
to
get
binary
file
\
n
"
)
;
}
rv
=
libFile
-
>
SetNativeLeafName
(
MOZ_DLL_PREFIX
"
rlbox
"
MOZ_DLL_SUFFIX
"
"
_ns
)
;
if
(
NS_FAILED
(
rv
)
)
{
MOZ_CRASH
(
"
Library
preload
failure
:
Failed
to
get
library
file
\
n
"
)
;
}
return
libFile
-
>
NativePath
(
)
;
}
PRLibrary
*
PreloadLibrary
(
const
PathString
&
path
)
{
PRLibSpec
libSpec
;
#
ifdef
XP_WIN
libSpec
.
type
=
PR_LibSpec_PathnameU
;
libSpec
.
value
.
pathname_u
=
path
.
get
(
)
;
#
else
libSpec
.
type
=
PR_LibSpec_Pathname
;
libSpec
.
value
.
pathname
=
path
.
get
(
)
;
#
endif
PRLibrary
*
ret
=
PR_LoadLibraryWithFlags
(
libSpec
PR_LD_LAZY
)
;
return
ret
;
}
void
PreloadSandboxedDynamicLibrary
(
)
{
#
if
defined
(
MOZ_USING_WASM_SANDBOXING
)
if
(
!
PreloadLibrary
(
GetSandboxedRLBoxPath
(
)
)
)
{
MOZ_CRASH
(
"
Library
preload
failure
:
Failed
to
load
librlbox
\
n
"
)
;
}
#
endif
}
}
}
