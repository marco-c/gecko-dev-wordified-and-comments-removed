#
ifndef
_include_ipc_glue_UtilityProcessHost_h_
#
define
_include_ipc_glue_UtilityProcessHost_h_
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
ipc
/
UtilityProcessParent
.
h
"
#
include
"
mozilla
/
ipc
/
UtilityProcessSandboxing
.
h
"
#
include
"
mozilla
/
ipc
/
GeckoChildProcessHost
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
include
"
mozilla
/
ipc
/
ProcessUtils
.
h
"
#
if
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
"
mozilla
/
SandboxBroker
.
h
"
#
endif
namespace
mozilla
:
:
ipc
{
class
UtilityProcessParent
;
class
UtilityProcessHost
final
:
public
mozilla
:
:
ipc
:
:
GeckoChildProcessHost
{
friend
class
UtilityProcessParent
;
public
:
class
Listener
{
protected
:
virtual
~
Listener
(
)
=
default
;
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
UtilityProcessHost
:
:
Listener
)
;
virtual
void
OnProcessUnexpectedShutdown
(
UtilityProcessHost
*
aHost
)
{
}
}
;
explicit
UtilityProcessHost
(
SandboxingKind
aSandbox
RefPtr
<
Listener
>
listener
)
;
bool
Launch
(
StringVector
aExtraOpts
)
;
using
LaunchPromiseType
=
MozPromise
<
Ok
LaunchError
false
>
;
RefPtr
<
LaunchPromiseType
>
LaunchPromise
(
)
;
void
Shutdown
(
)
;
RefPtr
<
UtilityProcessParent
>
GetActor
(
)
const
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
mUtilityProcessParent
;
}
bool
IsConnected
(
)
const
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
bool
(
mUtilityProcessParent
)
;
}
void
OnChannelConnected
(
base
:
:
ProcessId
peer_pid
)
override
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
static
MacSandboxType
GetMacSandboxType
(
)
;
#
endif
private
:
~
UtilityProcessHost
(
)
;
void
InitAfterConnect
(
bool
aSucceeded
)
;
void
OnChannelClosed
(
IProtocol
:
:
ActorDestroyReason
aReason
)
;
void
KillHard
(
const
char
*
aReason
)
;
void
DestroyProcess
(
)
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
static
bool
sLaunchWithMacSandbox
;
bool
IsMacSandboxLaunchEnabled
(
)
override
{
return
sLaunchWithMacSandbox
;
}
bool
FillMacSandboxInfo
(
MacSandboxInfo
&
aInfo
)
override
;
#
endif
DISALLOW_COPY_AND_ASSIGN
(
UtilityProcessHost
)
;
RefPtr
<
Listener
>
mListener
;
enum
class
LaunchPhase
{
Unlaunched
Waiting
Complete
}
;
LaunchPhase
mLaunchPhase
=
LaunchPhase
:
:
Unlaunched
;
RefPtr
<
UtilityProcessParent
>
mUtilityProcessParent
;
UniquePtr
<
ipc
:
:
SharedPreferenceSerializer
>
mPrefSerializer
{
}
;
bool
mShutdownRequested
=
false
;
void
ResolvePromise
(
)
;
void
RejectPromise
(
LaunchError
)
;
#
if
defined
(
MOZ_WMF_CDM
)
&
&
defined
(
MOZ_SANDBOX
)
&
&
!
defined
(
MOZ_ASAN
)
void
EnsureWidevineL1PathForSandbox
(
StringVector
&
aExtraOpts
)
;
#
endif
#
if
defined
(
MOZ_WMF_CDM
)
&
&
defined
(
MOZ_SANDBOX
)
void
EnanbleMFCDMTelemetryEventIfNeeded
(
)
const
;
#
endif
const
RefPtr
<
media
:
:
Refcountable
<
bool
>
>
mLiveToken
;
RefPtr
<
LaunchPromiseType
:
:
Private
>
mLaunchPromise
{
}
;
bool
mLaunchPromiseSettled
=
false
;
bool
mLaunchPromiseLaunched
=
false
;
bool
mLaunchCompleted
=
false
;
#
if
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_SANDBOX
)
UniquePtr
<
SandboxBroker
>
mSandboxBroker
{
}
;
#
endif
}
;
}
#
endif
