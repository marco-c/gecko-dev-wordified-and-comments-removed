#
ifndef
mozilla_ipc_CrashReporterHost_h
#
define
mozilla_ipc_CrashReporterHost_h
#
include
<
functional
>
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
ipc
/
Shmem
.
h
"
#
include
"
base
/
process
.
h
"
#
include
"
nsExceptionHandler
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
ProtocolUtils
.
h
"
namespace
mozilla
{
namespace
ipc
{
class
CrashReporterHost
{
typedef
mozilla
:
:
ipc
:
:
Shmem
Shmem
;
typedef
CrashReporter
:
:
AnnotationTable
AnnotationTable
;
public
:
CrashReporterHost
(
GeckoProcessType
aProcessType
const
Shmem
&
aShmem
CrashReporter
:
:
ThreadId
aThreadId
)
;
bool
GenerateCrashReport
(
base
:
:
ProcessId
aPid
)
;
RefPtr
<
nsIFile
>
TakeCrashedChildMinidump
(
base
:
:
ProcessId
aPid
uint32_t
*
aOutSequence
)
;
bool
AdoptMinidump
(
nsIFile
*
aFile
const
AnnotationTable
&
aAnnotations
)
;
bool
FinalizeCrashReport
(
)
;
template
<
typename
Toplevel
>
bool
GenerateMinidumpAndPair
(
Toplevel
*
aToplevelProtocol
nsIFile
*
aMinidumpToPair
const
nsACString
&
aPairName
)
{
ScopedProcessHandle
childHandle
;
#
ifdef
XP_MACOSX
childHandle
=
aToplevelProtocol
-
>
Process
(
)
-
>
GetChildTask
(
)
;
#
else
if
(
!
base
:
:
OpenPrivilegedProcessHandle
(
aToplevelProtocol
-
>
OtherPid
(
)
&
childHandle
.
rwget
(
)
)
)
{
NS_WARNING
(
"
Failed
to
open
child
process
handle
.
"
)
;
return
false
;
}
#
endif
nsCOMPtr
<
nsIFile
>
targetDump
;
if
(
!
CrashReporter
:
:
CreateMinidumpsAndPair
(
childHandle
mThreadId
aPairName
aMinidumpToPair
mExtraAnnotations
getter_AddRefs
(
targetDump
)
)
)
{
return
false
;
}
return
CrashReporter
:
:
GetIDFromMinidump
(
targetDump
mDumpID
)
;
}
void
AddAnnotation
(
CrashReporter
:
:
Annotation
aKey
bool
aValue
)
;
void
AddAnnotation
(
CrashReporter
:
:
Annotation
aKey
int
aValue
)
;
void
AddAnnotation
(
CrashReporter
:
:
Annotation
aKey
unsigned
int
aValue
)
;
void
AddAnnotation
(
CrashReporter
:
:
Annotation
aKey
const
nsACString
&
aValue
)
;
bool
HasMinidump
(
)
const
{
return
!
mDumpID
.
IsEmpty
(
)
;
}
const
nsString
&
MinidumpID
(
)
const
{
MOZ_ASSERT
(
HasMinidump
(
)
)
;
return
mDumpID
;
}
private
:
static
void
AsyncAddCrash
(
int32_t
aProcessType
int32_t
aCrashType
const
nsString
&
aChildDumpID
)
;
int32_t
GetCrashType
(
)
;
static
void
NotifyCrashService
(
GeckoProcessType
aProcessType
int32_t
aCrashType
const
nsString
&
aChildDumpID
)
;
private
:
GeckoProcessType
mProcessType
;
Shmem
mShmem
;
CrashReporter
:
:
ThreadId
mThreadId
;
time_t
mStartTime
;
AnnotationTable
mExtraAnnotations
;
nsString
mDumpID
;
bool
mFinalized
;
}
;
}
}
#
endif
