#
include
"
nsXPCOM
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
ifdef
XP_WIN
#
include
<
windows
.
h
>
#
define
XRE_DONT_PROTECT_DLL_LOAD
#
include
"
nsWindowsWMain
.
cpp
"
#
include
"
nsSetDllDirectory
.
h
"
#
else
#
include
<
unistd
.
h
>
#
endif
#
include
"
GMPLoader
.
h
"
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
"
mozilla
/
sandboxing
/
SandboxInitialization
.
h
"
#
include
"
mozilla
/
sandboxing
/
sandboxLogging
.
h
"
#
endif
#
if
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_GMP_SANDBOX
)
#
include
"
mozilla
/
Sandbox
.
h
"
#
include
"
mozilla
/
SandboxInfo
.
h
"
#
endif
#
ifdef
MOZ_WIDGET_GONK
#
include
<
sys
/
time
.
h
>
#
include
<
sys
/
resource
.
h
>
#
include
<
binder
/
ProcessState
.
h
>
#
ifdef
LOGE_IF
#
undef
LOGE_IF
#
endif
#
include
<
android
/
log
.
h
>
#
define
LOGE_IF
(
cond
.
.
.
)
\
(
(
CONDITION
(
cond
)
)
\
?
(
(
void
)
__android_log_print
(
ANDROID_LOG_ERROR
\
"
Gecko
:
MozillaRntimeMain
"
__VA_ARGS__
)
)
\
:
(
void
)
0
)
#
ifdef
MOZ_CONTENT_SANDBOX
#
include
"
mozilla
/
Sandbox
.
h
"
#
endif
#
endif
#
ifdef
MOZ_NUWA_PROCESS
#
include
<
binder
/
ProcessState
.
h
>
#
include
"
ipc
/
Nuwa
.
h
"
#
endif
#
ifdef
MOZ_WIDGET_GONK
static
void
InitializeBinder
(
void
*
aDummy
)
{
int
curPrio
=
getpriority
(
PRIO_PROCESS
0
)
;
int
err
=
setpriority
(
PRIO_PROCESS
0
0
)
;
MOZ_ASSERT
(
!
err
)
;
LOGE_IF
(
err
"
setpriority
failed
.
Current
process
needs
root
permission
.
"
)
;
android
:
:
ProcessState
:
:
self
(
)
-
>
startThreadPool
(
)
;
setpriority
(
PRIO_PROCESS
0
curPrio
)
;
}
#
endif
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
class
WinSandboxStarter
:
public
mozilla
:
:
gmp
:
:
SandboxStarter
{
public
:
virtual
bool
Start
(
const
char
*
aLibPath
)
override
{
if
(
IsSandboxedProcess
(
)
)
{
mozilla
:
:
sandboxing
:
:
LowerSandbox
(
)
;
}
return
true
;
}
}
;
#
endif
#
if
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_GMP_SANDBOX
)
class
LinuxSandboxStarter
:
public
mozilla
:
:
gmp
:
:
SandboxStarter
{
LinuxSandboxStarter
(
)
{
}
public
:
static
SandboxStarter
*
Make
(
)
{
if
(
mozilla
:
:
SandboxInfo
:
:
Get
(
)
.
CanSandboxMedia
(
)
)
{
return
new
LinuxSandboxStarter
(
)
;
}
else
{
return
nullptr
;
}
}
virtual
bool
Start
(
const
char
*
aLibPath
)
override
{
mozilla
:
:
SetMediaPluginSandbox
(
aLibPath
)
;
return
true
;
}
}
;
#
endif
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_GMP_SANDBOX
)
class
MacSandboxStarter
:
public
mozilla
:
:
gmp
:
:
SandboxStarter
{
public
:
virtual
bool
Start
(
const
char
*
aLibPath
)
override
{
std
:
:
string
err
;
bool
rv
=
mozilla
:
:
StartMacSandbox
(
mInfo
err
)
;
if
(
!
rv
)
{
fprintf
(
stderr
"
sandbox_init
(
)
failed
!
Error
\
"
%
s
\
"
\
n
"
err
.
c_str
(
)
)
;
}
return
rv
;
}
virtual
void
SetSandboxInfo
(
MacSandboxInfo
*
aSandboxInfo
)
override
{
mInfo
=
*
aSandboxInfo
;
}
private
:
MacSandboxInfo
mInfo
;
}
;
#
endif
mozilla
:
:
gmp
:
:
SandboxStarter
*
MakeSandboxStarter
(
)
{
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
return
new
WinSandboxStarter
(
)
;
#
elif
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_GMP_SANDBOX
)
return
LinuxSandboxStarter
:
:
Make
(
)
;
#
elif
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_GMP_SANDBOX
)
return
new
MacSandboxStarter
(
)
;
#
else
return
nullptr
;
#
endif
}
int
content_process_main
(
int
argc
char
*
argv
[
]
)
{
if
(
argc
<
1
)
{
return
3
;
}
bool
isNuwa
=
false
;
for
(
int
i
=
1
;
i
<
argc
;
i
+
+
)
{
isNuwa
|
=
strcmp
(
argv
[
i
]
"
-
nuwa
"
)
=
=
0
;
}
XREChildData
childData
;
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
if
(
IsSandboxedProcess
(
)
)
{
childData
.
sandboxTargetServices
=
mozilla
:
:
sandboxing
:
:
GetInitializedTargetServices
(
)
;
if
(
!
childData
.
sandboxTargetServices
)
{
return
1
;
}
childData
.
ProvideLogFunction
=
mozilla
:
:
sandboxing
:
:
ProvideLogFunction
;
}
#
endif
XRE_SetProcessType
(
argv
[
-
-
argc
]
)
;
#
ifdef
MOZ_NUWA_PROCESS
if
(
isNuwa
)
{
PrepareNuwaProcess
(
)
;
}
#
endif
#
if
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_SANDBOX
)
mozilla
:
:
SandboxEarlyInit
(
XRE_GetProcessType
(
)
isNuwa
)
;
#
endif
#
ifdef
MOZ_WIDGET_GONK
#
ifdef
MOZ_NUWA_PROCESS
if
(
!
isNuwa
)
{
InitializeBinder
(
nullptr
)
;
}
else
{
NuwaAddFinalConstructor
(
&
InitializeBinder
nullptr
)
;
}
#
else
InitializeBinder
(
nullptr
)
;
#
endif
#
endif
#
ifdef
XP_WIN
if
(
XRE_GetProcessType
(
)
!
=
GeckoProcessType_Plugin
)
{
mozilla
:
:
SanitizeEnvironmentVariables
(
)
;
SetDllDirectoryW
(
L
"
"
)
;
}
#
endif
#
if
!
defined
(
MOZ_WIDGET_ANDROID
)
&
&
!
defined
(
MOZ_WIDGET_GONK
)
&
&
defined
(
MOZ_PLUGIN_CONTAINER
)
nsAutoPtr
<
mozilla
:
:
gmp
:
:
SandboxStarter
>
starter
(
MakeSandboxStarter
(
)
)
;
if
(
XRE_GetProcessType
(
)
=
=
GeckoProcessType_GMPlugin
)
{
childData
.
gmpLoader
=
mozilla
:
:
gmp
:
:
CreateGMPLoader
(
starter
)
;
}
#
endif
nsresult
rv
=
XRE_InitChildProcess
(
argc
argv
&
childData
)
;
NS_ENSURE_SUCCESS
(
rv
1
)
;
return
0
;
}
