"
use
strict
"
;
const
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
this
.
EXPORTED_SYMBOLS
=
[
"
CaptivePortalWatcher
"
]
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
/
modules
/
RecentWindow
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
cps
"
"
mozilla
.
org
/
network
/
captive
-
portal
-
service
;
1
"
"
nsICaptivePortalService
"
)
;
this
.
CaptivePortalWatcher
=
{
PORTAL_RECHECK_DELAY_MS
:
150
PORTAL_NOTIFICATION_VALUE
:
"
captive
-
portal
-
detected
"
_captivePortalTab
:
null
_captivePortalNotification
:
null
_initialized
:
false
_delayedCaptivePortalDetectedInProgress
:
false
_waitingForRecheck
:
false
get
canonicalURL
(
)
{
return
Services
.
prefs
.
getCharPref
(
"
captivedetect
.
canonicalURL
"
)
;
}
init
(
)
{
Services
.
obs
.
addObserver
(
this
"
captive
-
portal
-
login
"
false
)
;
Services
.
obs
.
addObserver
(
this
"
captive
-
portal
-
login
-
abort
"
false
)
;
Services
.
obs
.
addObserver
(
this
"
captive
-
portal
-
login
-
success
"
false
)
;
this
.
_initialized
=
true
;
if
(
cps
.
state
=
=
cps
.
LOCKED_PORTAL
)
{
this
.
_captivePortalDetected
(
)
;
return
;
}
cps
.
recheckCaptivePortal
(
)
;
}
uninit
(
)
{
if
(
!
this
.
_initialized
)
{
return
;
}
Services
.
obs
.
removeObserver
(
this
"
captive
-
portal
-
login
"
)
;
Services
.
obs
.
removeObserver
(
this
"
captive
-
portal
-
login
-
abort
"
)
;
Services
.
obs
.
removeObserver
(
this
"
captive
-
portal
-
login
-
success
"
)
;
}
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
captive
-
portal
-
login
"
:
this
.
_captivePortalDetected
(
)
;
break
;
case
"
captive
-
portal
-
login
-
abort
"
:
case
"
captive
-
portal
-
login
-
success
"
:
this
.
_captivePortalGone
(
)
;
break
;
case
"
xul
-
window
-
visible
"
:
this
.
_delayedCaptivePortalDetected
(
)
;
break
;
}
}
_captivePortalDetected
(
)
{
if
(
this
.
_delayedCaptivePortalDetectedInProgress
)
{
return
;
}
let
win
=
RecentWindow
.
getMostRecentBrowserWindow
(
)
;
if
(
!
win
|
|
win
!
=
Services
.
ww
.
activeWindow
)
{
this
.
_delayedCaptivePortalDetectedInProgress
=
true
;
Services
.
obs
.
addObserver
(
this
"
xul
-
window
-
visible
"
false
)
;
return
;
}
this
.
_showNotification
(
win
)
;
}
_ensureCaptivePortalTab
(
win
)
{
let
tab
;
if
(
this
.
_captivePortalTab
)
{
tab
=
this
.
_captivePortalTab
.
get
(
)
;
}
if
(
!
tab
|
|
tab
.
closing
|
|
!
tab
.
parentNode
)
{
tab
=
win
.
gBrowser
.
addTab
(
this
.
canonicalURL
{
ownerTab
:
win
.
gBrowser
.
selectedTab
}
)
;
this
.
_captivePortalTab
=
Cu
.
getWeakReference
(
tab
)
;
}
win
.
gBrowser
.
selectedTab
=
tab
;
}
_delayedCaptivePortalDetected
(
)
{
if
(
!
this
.
_delayedCaptivePortalDetectedInProgress
)
{
return
;
}
let
win
=
RecentWindow
.
getMostRecentBrowserWindow
(
)
;
if
(
win
!
=
Services
.
ww
.
activeWindow
)
{
return
;
}
Services
.
obs
.
removeObserver
(
this
"
xul
-
window
-
visible
"
)
;
cps
.
recheckCaptivePortal
(
)
;
this
.
_waitingForRecheck
=
true
;
let
requestTime
=
Date
.
now
(
)
;
let
self
=
this
;
Services
.
obs
.
addObserver
(
function
observer
(
)
{
let
time
=
Date
.
now
(
)
-
requestTime
;
Services
.
obs
.
removeObserver
(
observer
"
captive
-
portal
-
check
-
complete
"
)
;
self
.
_waitingForRecheck
=
false
;
self
.
_delayedCaptivePortalDetectedInProgress
=
false
;
if
(
cps
.
state
!
=
cps
.
LOCKED_PORTAL
)
{
return
;
}
self
.
_showNotification
(
win
)
;
if
(
time
<
=
self
.
PORTAL_RECHECK_DELAY_MS
)
{
self
.
_ensureCaptivePortalTab
(
win
)
;
}
}
"
captive
-
portal
-
check
-
complete
"
false
)
;
}
_captivePortalGone
(
)
{
if
(
this
.
_delayedCaptivePortalDetectedInProgress
)
{
Services
.
obs
.
removeObserver
(
this
"
xul
-
window
-
visible
"
)
;
this
.
_delayedCaptivePortalDetectedInProgress
=
false
;
}
this
.
_removeNotification
(
)
;
if
(
!
this
.
_captivePortalTab
)
{
return
;
}
let
tab
=
this
.
_captivePortalTab
.
get
(
)
;
this
.
_captivePortalTab
=
null
;
if
(
!
tab
|
|
tab
.
closing
|
|
!
tab
.
parentNode
)
{
return
;
}
let
tabbrowser
=
tab
.
ownerGlobal
.
gBrowser
;
if
(
tab
.
linkedBrowser
.
currentURI
.
spec
!
=
this
.
canonicalURL
&
&
tabbrowser
.
selectedTab
=
=
tab
)
{
return
;
}
tabbrowser
.
removeTab
(
tab
)
;
}
get
_browserBundle
(
)
{
delete
this
.
_browserBundle
;
return
this
.
_browserBundle
=
Services
.
strings
.
createBundle
(
"
chrome
:
/
/
browser
/
locale
/
browser
.
properties
"
)
;
}
handleEvent
(
aEvent
)
{
if
(
aEvent
.
type
!
=
"
TabSelect
"
|
|
!
this
.
_captivePortalTab
|
|
!
this
.
_captivePortalNotification
)
{
return
;
}
let
tab
=
this
.
_captivePortalTab
.
get
(
)
;
let
n
=
this
.
_captivePortalNotification
.
get
(
)
;
if
(
!
tab
|
|
!
n
)
{
return
;
}
let
doc
=
tab
.
ownerDocument
;
let
button
=
n
.
querySelector
(
"
button
.
notification
-
button
"
)
;
if
(
doc
.
defaultView
.
gBrowser
.
selectedTab
=
=
tab
)
{
button
.
style
.
visibility
=
"
hidden
"
;
}
else
{
button
.
style
.
visibility
=
"
visible
"
;
}
}
_showNotification
(
win
)
{
let
buttons
=
[
{
label
:
this
.
_browserBundle
.
GetStringFromName
(
"
captivePortal
.
showLoginPage
"
)
callback
:
(
)
=
>
{
this
.
_ensureCaptivePortalTab
(
win
)
;
return
true
;
}
isDefault
:
true
}
]
;
let
message
=
this
.
_browserBundle
.
GetStringFromName
(
"
captivePortal
.
infoMessage2
"
)
;
let
closeHandler
=
(
aEventName
)
=
>
{
if
(
aEventName
!
=
"
removed
"
)
{
return
;
}
win
.
gBrowser
.
tabContainer
.
removeEventListener
(
"
TabSelect
"
this
)
;
}
;
let
nb
=
win
.
document
.
getElementById
(
"
high
-
priority
-
global
-
notificationbox
"
)
;
let
n
=
nb
.
appendNotification
(
message
this
.
PORTAL_NOTIFICATION_VALUE
"
"
nb
.
PRIORITY_INFO_MEDIUM
buttons
closeHandler
)
;
this
.
_captivePortalNotification
=
Cu
.
getWeakReference
(
n
)
;
win
.
gBrowser
.
tabContainer
.
addEventListener
(
"
TabSelect
"
this
)
;
}
_removeNotification
(
)
{
if
(
!
this
.
_captivePortalNotification
)
return
;
let
n
=
this
.
_captivePortalNotification
.
get
(
)
;
this
.
_captivePortalNotification
=
null
;
if
(
!
n
|
|
!
n
.
parentNode
)
{
return
;
}
n
.
close
(
)
;
}
}
;
