"
use
strict
"
;
Cu
.
importGlobalProperties
(
[
"
fetch
"
]
)
;
var
EXPORTED_SYMBOLS
=
[
"
PartnerLinkAttribution
"
"
CONTEXTUAL_SERVICES_PING_TYPES
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
Region
:
"
resource
:
/
/
gre
/
modules
/
Region
.
jsm
"
PingCentre
:
"
resource
:
/
/
/
modules
/
PingCentre
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
structuredIngestionEndpointBase
"
"
browser
.
newtabpage
.
activity
-
stream
.
telemetry
.
structuredIngestion
.
endpoint
"
"
"
)
;
const
NAMESPACE_CONTEXUAL_SERVICES
=
"
contextual
-
services
"
;
XPCOMUtils
.
defineLazyGetter
(
this
"
pingcentre
"
(
)
=
>
{
return
new
PingCentre
(
{
topic
:
"
contextual
-
services
"
}
)
;
}
)
;
const
CONTEXT_ID_PREF
=
"
browser
.
contextual
-
services
.
contextId
"
;
XPCOMUtils
.
defineLazyGetter
(
this
"
contextId
"
(
)
=
>
{
let
_contextId
=
Services
.
prefs
.
getStringPref
(
CONTEXT_ID_PREF
null
)
;
if
(
!
_contextId
)
{
_contextId
=
String
(
Services
.
uuid
.
generateUUID
(
)
)
;
Services
.
prefs
.
setStringPref
(
CONTEXT_ID_PREF
_contextId
)
;
}
return
_contextId
;
}
)
;
const
CONTEXTUAL_SERVICES_PING_TYPES
=
{
TOPSITES_IMPRESSION
:
"
topsites
-
impression
"
TOPSITES_SELECTION
:
"
topsites
-
click
"
QS_IMPRESSION
:
"
quicksuggest
-
impression
"
QS_SELECTION
:
"
quicksuggest
-
click
"
}
;
var
PartnerLinkAttribution
=
{
async
makeRequest
(
{
targetURL
source
campaignID
}
)
{
let
partner
=
targetURL
.
match
(
/
^
https
?
:
\
/
\
/
(
?
:
www
.
)
?
(
[
^
.
]
*
)
/
)
[
1
]
;
function
record
(
method
objectString
)
{
recordTelemetryEvent
(
{
method
objectString
value
:
partner
}
)
;
}
record
(
"
click
"
source
)
;
let
attributionUrl
=
Services
.
prefs
.
getStringPref
(
"
browser
.
partnerlink
.
attributionURL
"
)
;
if
(
!
attributionUrl
)
{
record
(
"
attribution
"
"
abort
"
)
;
return
;
}
if
(
!
campaignID
)
{
campaignID
=
Services
.
prefs
.
getStringPref
(
"
browser
.
partnerlink
.
campaign
.
topsites
"
)
;
}
attributionUrl
=
attributionUrl
+
campaignID
;
let
result
=
await
sendRequest
(
attributionUrl
source
targetURL
)
;
record
(
"
attribution
"
result
?
"
success
"
:
"
failure
"
)
;
}
async
makeSearchEngineRequest
(
engine
targetUrl
)
{
let
cid
;
if
(
engine
.
attribution
?
.
cid
)
{
cid
=
engine
.
attribution
.
cid
;
}
else
if
(
engine
.
sendAttributionRequest
)
{
cid
=
Services
.
prefs
.
getStringPref
(
"
browser
.
partnerlink
.
campaign
.
topsites
"
)
;
}
else
{
return
;
}
let
searchUrlQueryParamName
=
engine
.
searchUrlQueryParamName
;
if
(
!
searchUrlQueryParamName
)
{
Cu
.
reportError
(
"
makeSearchEngineRequest
can
'
t
find
search
terms
key
"
)
;
return
;
}
let
url
=
targetUrl
;
if
(
typeof
url
=
=
"
string
"
)
{
url
=
Services
.
io
.
newURI
(
url
)
;
}
let
targetParams
=
new
URLSearchParams
(
url
.
query
)
;
if
(
!
targetParams
.
has
(
searchUrlQueryParamName
)
)
{
Cu
.
reportError
(
"
makeSearchEngineRequest
can
'
t
remove
target
search
terms
"
)
;
return
;
}
let
attributionUrl
=
Services
.
prefs
.
getStringPref
(
"
browser
.
partnerlink
.
attributionURL
"
"
"
)
;
attributionUrl
=
attributionUrl
+
cid
;
targetParams
.
delete
(
searchUrlQueryParamName
)
;
let
strippedTargetUrl
=
{
url
.
prePath
}
{
url
.
filePath
}
;
let
newParams
=
targetParams
.
toString
(
)
;
if
(
newParams
)
{
strippedTargetUrl
+
=
"
?
"
+
newParams
;
}
await
sendRequest
(
attributionUrl
"
searchurl
"
strippedTargetUrl
)
;
}
sendContextualServicesPing
(
payload
pingType
)
{
if
(
!
Object
.
values
(
CONTEXTUAL_SERVICES_PING_TYPES
)
.
includes
(
pingType
)
)
{
Cu
.
reportError
(
"
Invalid
Contextual
Services
ping
type
"
)
;
return
;
}
const
endpoint
=
makeEndpointUrl
(
pingType
"
1
"
)
;
payload
.
context_id
=
contextId
;
pingcentre
.
sendStructuredIngestionPing
(
payload
endpoint
)
;
}
get
_pingCentre
(
)
{
return
pingcentre
;
}
}
;
async
function
sendRequest
(
attributionUrl
source
targetURL
)
{
const
request
=
new
Request
(
attributionUrl
)
;
request
.
headers
.
set
(
"
X
-
Region
"
Region
.
home
)
;
request
.
headers
.
set
(
"
X
-
Source
"
source
)
;
request
.
headers
.
set
(
"
X
-
Target
-
URL
"
targetURL
)
;
const
response
=
await
fetch
(
request
)
;
return
response
.
ok
;
}
function
recordTelemetryEvent
(
{
method
objectString
value
}
)
{
Services
.
telemetry
.
setEventRecordingEnabled
(
"
partner_link
"
true
)
;
Services
.
telemetry
.
recordEvent
(
"
partner_link
"
method
objectString
value
)
;
}
function
makeEndpointUrl
(
pingType
version
)
{
const
docID
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
.
slice
(
1
-
1
)
;
const
extension
=
{
NAMESPACE_CONTEXUAL_SERVICES
}
/
{
pingType
}
/
{
version
}
/
{
docID
}
;
return
{
structuredIngestionEndpointBase
}
/
{
extension
}
;
}
