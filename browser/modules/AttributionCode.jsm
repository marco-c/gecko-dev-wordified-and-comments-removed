"
use
strict
"
;
this
.
EXPORTED_SYMBOLS
=
[
"
AttributionCode
"
]
;
const
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
'
AppConstants
'
'
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
'
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
'
OS
'
'
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
'
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
'
Services
'
'
resource
:
/
/
gre
/
modules
/
Services
.
jsm
'
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
'
Task
'
'
resource
:
/
/
gre
/
modules
/
Task
.
jsm
'
)
;
const
ATTR_CODE_MAX_LENGTH
=
200
;
const
ATTR_CODE_VALUE_CHARS
=
"
[
a
-
zA
-
Z0
-
9_
%
\
\
-
\
\
.
\
\
(
\
\
)
]
"
;
const
ATTR_CODE_REGEX
=
new
RegExp
(
"
^
source
%
3D
(
"
+
ATTR_CODE_VALUE_CHARS
+
"
*
)
%
26
"
+
"
medium
%
3D
(
"
+
ATTR_CODE_VALUE_CHARS
+
"
*
)
%
26
"
+
"
campaign
%
3D
(
"
+
ATTR_CODE_VALUE_CHARS
+
"
*
)
%
26
"
+
"
content
%
3D
(
"
+
ATTR_CODE_VALUE_CHARS
+
"
*
)
"
"
i
"
)
;
const
ATTR_CODE_REGEX_NUM_GROUPS
=
4
;
let
gCachedCode
=
null
;
function
getAttributionFile
(
)
{
let
file
=
Services
.
dirsvc
.
get
(
"
LocalAppData
"
Ci
.
nsIFile
)
;
file
.
append
(
Services
.
appinfo
.
vendor
|
|
"
mozilla
"
)
;
file
.
append
(
AppConstants
.
MOZ_APP_NAME
)
;
file
.
append
(
"
postSigningData
"
)
;
return
file
;
}
function
attributionCodeIsValid
(
code
)
{
let
matches
=
code
.
match
(
ATTR_CODE_REGEX
)
;
return
code
.
length
<
=
ATTR_CODE_MAX_LENGTH
&
&
matches
!
=
null
&
&
matches
.
length
=
=
(
ATTR_CODE_REGEX_NUM_GROUPS
+
1
)
;
}
var
AttributionCode
=
{
getCodeAsync
(
)
{
return
Task
.
spawn
(
function
*
(
)
{
if
(
gCachedCode
!
=
null
)
{
return
gCachedCode
;
}
try
{
let
bytes
=
yield
OS
.
File
.
read
(
getAttributionFile
(
)
.
path
)
;
let
decoder
=
new
TextDecoder
(
)
;
gCachedCode
=
decoder
.
decode
(
bytes
)
;
}
catch
(
ex
)
{
gCachedCode
=
"
"
;
}
if
(
!
attributionCodeIsValid
(
gCachedCode
)
)
{
gCachedCode
=
"
"
;
}
return
gCachedCode
;
}
)
;
}
deleteFileAsync
(
)
{
return
Task
.
spawn
(
function
*
(
)
{
try
{
yield
OS
.
File
.
remove
(
getAttributionFile
(
)
.
path
)
;
}
catch
(
ex
)
{
}
}
)
;
}
_clearCache
(
)
{
let
env
=
Cc
[
"
mozilla
.
org
/
process
/
environment
;
1
"
]
.
getService
(
Ci
.
nsIEnvironment
)
;
if
(
env
.
exists
(
"
XPCSHELL_TEST_PROFILE_DIR
"
)
)
{
gCachedCode
=
null
;
}
}
}
;
