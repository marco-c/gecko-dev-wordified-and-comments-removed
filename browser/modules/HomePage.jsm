"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
HomePage
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
PrivateBrowsingUtils
"
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
)
;
const
kPrefName
=
"
browser
.
startup
.
homepage
"
;
function
getHomepagePref
(
useDefault
)
{
let
homePage
;
let
prefs
=
Services
.
prefs
;
if
(
useDefault
)
{
prefs
=
prefs
.
getDefaultBranch
(
null
)
;
}
try
{
homePage
=
prefs
.
getComplexValue
(
kPrefName
Ci
.
nsIPrefLocalizedString
)
.
data
;
}
catch
(
ex
)
{
}
if
(
!
homePage
)
{
homePage
=
prefs
.
getStringPref
(
kPrefName
)
;
}
if
(
!
homePage
&
&
!
useDefault
)
{
Services
.
prefs
.
clearUserPref
(
kPrefName
)
;
homePage
=
getHomepagePref
(
true
)
;
}
return
homePage
;
}
let
HomePage
=
{
get
(
aWindow
)
{
if
(
PrivateBrowsingUtils
.
permanentPrivateBrowsing
|
|
(
aWindow
&
&
PrivateBrowsingUtils
.
isWindowPrivate
(
aWindow
)
)
)
{
return
this
.
getPrivate
(
)
;
}
return
getHomepagePref
(
)
;
}
getDefault
(
)
{
return
getHomepagePref
(
true
)
;
}
getPrivate
(
)
{
let
homePages
=
getHomepagePref
(
)
;
if
(
!
homePages
.
includes
(
"
moz
-
extension
"
)
)
{
return
homePages
;
}
let
privateHomePages
=
homePages
.
split
(
"
|
"
)
.
filter
(
page
=
>
{
let
url
=
new
URL
(
page
)
;
if
(
url
.
protocol
!
=
=
"
moz
-
extension
:
"
)
{
return
true
;
}
let
policy
=
WebExtensionPolicy
.
getByHostname
(
url
.
hostname
)
;
return
policy
&
&
policy
.
privateBrowsingAllowed
;
}
)
;
return
privateHomePages
.
join
(
"
|
"
)
|
|
this
.
getDefault
(
)
;
}
get
overridden
(
)
{
return
Services
.
prefs
.
prefHasUserValue
(
kPrefName
)
;
}
set
(
value
)
{
Services
.
prefs
.
setStringPref
(
kPrefName
value
)
;
}
reset
(
)
{
Services
.
prefs
.
clearUserPref
(
kPrefName
)
;
}
}
;
