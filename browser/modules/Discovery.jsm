"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
Discovery
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
ClientID
"
"
resource
:
/
/
gre
/
modules
/
ClientID
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
ContextualIdentityService
"
"
resource
:
/
/
gre
/
modules
/
ContextualIdentityService
.
jsm
"
)
;
const
RECOMMENDATION_ENABLED
=
"
browser
.
discovery
.
enabled
"
;
const
TELEMETRY_ENABLED
=
"
datareporting
.
healthreport
.
uploadEnabled
"
;
const
TAAR_COOKIE_NAME
=
"
taarId
"
;
const
Discovery
=
{
set
enabled
(
val
)
{
val
=
!
!
val
;
if
(
val
&
&
!
gTelemetryEnabled
)
{
throw
Error
(
"
unable
to
turn
on
recommendations
"
)
;
}
Services
.
prefs
.
setBoolPref
(
RECOMMENDATION_ENABLED
val
)
;
}
get
enabled
(
)
{
return
gTelemetryEnabled
&
&
gRecommendationEnabled
;
}
reset
(
)
{
return
DiscoveryInternal
.
update
(
true
)
;
}
update
(
)
{
return
DiscoveryInternal
.
update
(
)
;
}
}
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
gRecommendationEnabled
"
RECOMMENDATION_ENABLED
false
Discovery
.
update
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
gTelemetryEnabled
"
TELEMETRY_ENABLED
false
Discovery
.
update
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
gCachedClientID
"
"
toolkit
.
telemetry
.
cachedClientID
"
"
"
Discovery
.
reset
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
gContainersEnabled
"
"
browser
.
discovery
.
containers
.
enabled
"
false
Discovery
.
reset
)
;
Services
.
obs
.
addObserver
(
Discovery
.
update
"
contextual
-
identity
-
created
"
)
;
const
DiscoveryInternal
=
{
get
sites
(
)
{
delete
this
.
sites
;
this
.
sites
=
Services
.
prefs
.
getCharPref
(
"
browser
.
discovery
.
sites
"
"
"
)
.
split
(
"
"
)
;
return
this
.
sites
;
}
getContextualIDs
(
)
{
let
IDs
=
[
0
]
;
if
(
gContainersEnabled
)
{
ContextualIdentityService
.
getPublicIdentities
(
)
.
forEach
(
identity
=
>
{
IDs
.
push
(
identity
.
userContextId
)
;
}
)
;
}
return
IDs
;
}
async
update
(
reset
=
false
)
{
if
(
reset
|
|
!
Discovery
.
enabled
)
{
for
(
let
site
of
this
.
sites
)
{
Services
.
cookies
.
remove
(
site
TAAR_COOKIE_NAME
"
/
"
{
}
)
;
ContextualIdentityService
.
getPublicIdentities
(
)
.
forEach
(
identity
=
>
{
let
{
userContextId
}
=
identity
;
Services
.
cookies
.
remove
(
site
TAAR_COOKIE_NAME
"
/
"
{
userContextId
}
)
;
}
)
;
}
}
if
(
Discovery
.
enabled
)
{
if
(
!
gCachedClientID
)
{
return
;
}
let
id
=
await
ClientID
.
getClientIdHash
(
)
;
for
(
let
site
of
this
.
sites
)
{
for
(
let
userContextId
of
this
.
getContextualIDs
(
)
)
{
let
originAttributes
=
{
privateBrowsingId
:
0
}
;
if
(
userContextId
>
0
)
{
originAttributes
.
userContextId
=
userContextId
;
}
if
(
Services
.
cookies
.
cookieExists
(
site
"
/
"
TAAR_COOKIE_NAME
originAttributes
)
)
{
continue
;
}
Services
.
cookies
.
add
(
site
"
/
"
TAAR_COOKIE_NAME
id
true
true
true
Date
.
now
(
)
originAttributes
Ci
.
nsICookie
.
SAMESITE_LAX
)
;
}
}
}
}
}
;
