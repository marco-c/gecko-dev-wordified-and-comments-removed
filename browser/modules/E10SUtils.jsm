"
use
strict
"
;
this
.
EXPORTED_SYMBOLS
=
[
"
E10SUtils
"
]
;
const
{
interfaces
:
Ci
utils
:
Cu
classes
:
Cc
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
useRemoteWebExtensions
"
"
extensions
.
webextensions
.
remote
"
false
)
;
function
getAboutModule
(
aURL
)
{
let
moduleName
=
aURL
.
path
.
replace
(
/
[
#
?
]
.
*
/
"
"
)
.
toLowerCase
(
)
;
let
contract
=
"
mozilla
.
org
/
network
/
protocol
/
about
;
1
?
what
=
"
+
moduleName
;
try
{
return
Cc
[
contract
]
.
getService
(
Ci
.
nsIAboutModule
)
;
}
catch
(
e
)
{
return
null
;
}
}
this
.
E10SUtils
=
{
canLoadURIInProcess
:
function
(
aURL
aProcess
)
{
if
(
!
aURL
)
aURL
=
"
about
:
blank
"
;
if
(
aURL
.
startsWith
(
"
javascript
:
"
)
)
return
true
;
let
processIsRemote
=
aProcess
=
=
Ci
.
nsIXULRuntime
.
PROCESS_TYPE_CONTENT
;
let
canLoadRemote
=
true
;
let
mustLoadRemote
=
true
;
if
(
aURL
.
startsWith
(
"
about
:
"
)
)
{
let
url
=
Services
.
io
.
newURI
(
aURL
null
null
)
;
let
module
=
getAboutModule
(
url
)
;
if
(
module
)
{
let
flags
=
module
.
getURIFlags
(
url
)
;
canLoadRemote
=
!
!
(
flags
&
Ci
.
nsIAboutModule
.
URI_CAN_LOAD_IN_CHILD
)
;
mustLoadRemote
=
!
!
(
flags
&
Ci
.
nsIAboutModule
.
URI_MUST_LOAD_IN_CHILD
)
;
}
}
if
(
aURL
.
startsWith
(
"
chrome
:
"
)
)
{
let
url
;
try
{
url
=
Services
.
io
.
newURI
(
aURL
null
null
)
;
}
catch
(
ex
)
{
canLoadRemote
=
true
;
mustLoadRemote
=
false
;
}
if
(
url
)
{
let
chromeReg
=
Cc
[
"
mozilla
.
org
/
chrome
/
chrome
-
registry
;
1
"
]
.
getService
(
Ci
.
nsIXULChromeRegistry
)
;
canLoadRemote
=
chromeReg
.
canLoadURLRemotely
(
url
)
;
mustLoadRemote
=
chromeReg
.
mustLoadURLRemotely
(
url
)
;
}
}
if
(
aURL
.
startsWith
(
"
moz
-
extension
:
"
)
)
{
canLoadRemote
=
useRemoteWebExtensions
;
mustLoadRemote
=
useRemoteWebExtensions
;
}
if
(
aURL
.
startsWith
(
"
view
-
source
:
"
)
)
{
return
this
.
canLoadURIInProcess
(
aURL
.
substr
(
"
view
-
source
:
"
.
length
)
aProcess
)
;
}
if
(
mustLoadRemote
)
return
processIsRemote
;
if
(
!
canLoadRemote
&
&
processIsRemote
)
return
false
;
return
true
;
}
shouldLoadURI
:
function
(
aDocShell
aURI
aReferrer
)
{
if
(
aDocShell
.
QueryInterface
(
Ci
.
nsIDocShellTreeItem
)
.
sameTypeParent
)
return
true
;
return
this
.
canLoadURIInProcess
(
aURI
.
spec
Services
.
appinfo
.
processType
)
;
}
redirectLoad
:
function
(
aDocShell
aURI
aReferrer
aFreshProcess
)
{
let
messageManager
=
aDocShell
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIContentFrameMessageManager
)
;
let
sessionHistory
=
aDocShell
.
getInterface
(
Ci
.
nsIWebNavigation
)
.
sessionHistory
;
messageManager
.
sendAsyncMessage
(
"
Browser
:
LoadURI
"
{
loadOptions
:
{
uri
:
aURI
.
spec
flags
:
Ci
.
nsIWebNavigation
.
LOAD_FLAGS_NONE
referrer
:
aReferrer
?
aReferrer
.
spec
:
null
reloadInFreshProcess
:
!
!
aFreshProcess
}
historyIndex
:
sessionHistory
.
requestedIndex
}
)
;
return
false
;
}
wrapHandlingUserInput
:
function
(
aWindow
aIsHandling
aCallback
)
{
var
handlingUserInput
;
try
{
handlingUserInput
=
aWindow
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIDOMWindowUtils
)
.
setHandlingUserInput
(
aIsHandling
)
;
aCallback
(
)
;
}
finally
{
handlingUserInput
.
destruct
(
)
;
}
}
}
;
