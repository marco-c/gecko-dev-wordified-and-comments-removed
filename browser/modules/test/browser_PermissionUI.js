"
use
strict
"
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Integration
.
jsm
"
this
)
;
Cu
.
import
(
"
resource
:
/
/
/
modules
/
PermissionUI
.
jsm
"
this
)
;
function
makeMockPermissionRequest
(
browser
)
{
let
result
=
{
types
:
null
principal
:
browser
.
contentPrincipal
requester
:
null
_cancelled
:
false
cancel
(
)
{
this
.
_cancelled
=
true
;
}
_allowed
:
false
allow
(
)
{
this
.
_allowed
=
true
;
}
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsIContentPermissionRequest
]
)
}
;
if
(
browser
.
isRemoteBrowser
)
{
result
.
element
=
browser
;
}
else
{
result
.
window
=
browser
.
contentWindow
;
}
return
result
;
}
function
clickMainAction
(
)
{
let
removePromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popuphidden
"
)
;
let
popupNotification
=
getPopupNotificationNode
(
)
;
popupNotification
.
button
.
click
(
)
;
return
removePromise
;
}
function
clickSecondaryAction
(
index
)
{
let
removePromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popuphidden
"
)
;
let
popupNotification
=
getPopupNotificationNode
(
)
;
let
menuitems
=
popupNotification
.
children
;
menuitems
[
index
]
.
click
(
)
;
return
removePromise
;
}
function
getPopupNotificationNode
(
)
{
let
popupNotifications
=
PopupNotifications
.
panel
.
childNodes
;
Assert
.
equal
(
popupNotifications
.
length
1
"
Should
be
showing
a
<
xul
:
popupnotification
>
"
)
;
return
popupNotifications
[
0
]
;
}
add_task
(
function
*
test_permission_prompt_for_request
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
/
"
}
function
*
(
browser
)
{
const
kTestNotificationID
=
"
test
-
notification
"
;
const
kTestMessage
=
"
Test
message
"
;
let
mainAction
=
{
label
:
"
Main
"
accessKey
:
"
M
"
}
;
let
secondaryAction
=
{
label
:
"
Secondary
"
accessKey
:
"
S
"
}
;
let
mockRequest
=
makeMockPermissionRequest
(
browser
)
;
let
TestPrompt
=
{
__proto__
:
PermissionUI
.
PermissionPromptForRequestPrototype
request
:
mockRequest
notificationID
:
kTestNotificationID
message
:
kTestMessage
promptActions
:
[
mainAction
secondaryAction
]
}
;
let
shownPromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
TestPrompt
.
prompt
(
)
;
yield
shownPromise
;
let
notification
=
PopupNotifications
.
getNotification
(
kTestNotificationID
browser
)
;
Assert
.
ok
(
notification
"
Should
have
gotten
the
notification
"
)
;
Assert
.
equal
(
notification
.
message
kTestMessage
"
Should
be
showing
the
right
message
"
)
;
Assert
.
equal
(
notification
.
mainAction
.
label
mainAction
.
label
"
The
main
action
should
have
the
right
label
"
)
;
Assert
.
equal
(
notification
.
mainAction
.
accessKey
mainAction
.
accessKey
"
The
main
action
should
have
the
right
access
key
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
.
length
1
"
There
should
only
be
1
secondary
action
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
[
0
]
.
label
secondaryAction
.
label
"
The
secondary
action
should
have
the
right
label
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
[
0
]
.
accessKey
secondaryAction
.
accessKey
"
The
secondary
action
should
have
the
right
access
key
"
)
;
Assert
.
ok
(
notification
.
options
.
displayURI
.
equals
(
mockRequest
.
principal
.
URI
)
"
Should
be
showing
the
URI
of
the
requesting
page
"
)
;
let
removePromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popuphidden
"
)
;
notification
.
remove
(
)
;
yield
removePromise
;
}
)
;
}
)
;
add_task
(
function
*
test_permission_prompt_for_popupOptions
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
/
"
}
function
*
(
browser
)
{
const
kTestNotificationID
=
"
test
-
notification
"
;
const
kTestMessage
=
"
Test
message
"
;
let
mainAction
=
{
label
:
"
Main
"
accessKey
:
"
M
"
}
;
let
secondaryAction
=
{
label
:
"
Secondary
"
accessKey
:
"
S
"
}
;
let
mockRequest
=
makeMockPermissionRequest
(
browser
)
;
let
TestPrompt
=
{
__proto__
:
PermissionUI
.
PermissionPromptForRequestPrototype
request
:
mockRequest
notificationID
:
kTestNotificationID
message
:
kTestMessage
promptActions
:
[
mainAction
secondaryAction
]
popupOptions
:
{
displayURI
:
false
}
}
;
let
shownPromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
TestPrompt
.
prompt
(
)
;
yield
shownPromise
;
let
notification
=
PopupNotifications
.
getNotification
(
kTestNotificationID
browser
)
;
Assert
.
ok
(
!
notification
.
options
.
displayURI
"
Should
not
show
the
URI
of
the
requesting
page
"
)
;
let
removePromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popuphidden
"
)
;
notification
.
remove
(
)
;
yield
removePromise
;
}
)
;
}
)
;
add_task
(
function
*
test_with_permission_key
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
"
}
function
*
(
browser
)
{
const
kTestNotificationID
=
"
test
-
notification
"
;
const
kTestMessage
=
"
Test
message
"
;
const
kTestPermissionKey
=
"
test
-
permission
-
key
"
;
let
allowed
=
false
;
let
mainAction
=
{
label
:
"
Allow
"
accessKey
:
"
M
"
action
:
Ci
.
nsIPermissionManager
.
ALLOW_ACTION
expiryType
:
Ci
.
nsIPermissionManager
.
EXPIRE_SESSION
callback
:
function
(
)
{
allowed
=
true
;
}
}
;
let
denied
=
false
;
let
secondaryAction
=
{
label
:
"
Deny
"
accessKey
:
"
D
"
action
:
Ci
.
nsIPermissionManager
.
DENY_ACTION
expiryType
:
Ci
.
nsIPermissionManager
.
EXPIRE_SESSION
callback
:
function
(
)
{
denied
=
true
;
}
}
;
let
mockRequest
=
makeMockPermissionRequest
(
browser
)
;
let
principal
=
mockRequest
.
principal
;
registerCleanupFunction
(
function
(
)
{
Services
.
perms
.
removeFromPrincipal
(
principal
kTestPermissionKey
)
;
}
)
;
let
TestPrompt
=
{
__proto__
:
PermissionUI
.
PermissionPromptForRequestPrototype
request
:
mockRequest
notificationID
:
kTestNotificationID
permissionKey
:
kTestPermissionKey
message
:
kTestMessage
promptActions
:
[
mainAction
secondaryAction
]
}
;
let
shownPromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
TestPrompt
.
prompt
(
)
;
yield
shownPromise
;
let
notification
=
PopupNotifications
.
getNotification
(
kTestNotificationID
browser
)
;
Assert
.
ok
(
notification
"
Should
have
gotten
the
notification
"
)
;
let
curPerm
=
Services
.
perms
.
testPermissionFromPrincipal
(
principal
kTestPermissionKey
)
;
Assert
.
equal
(
curPerm
Ci
.
nsIPermissionManager
.
UNKNOWN_ACTION
"
Should
be
no
permission
set
to
begin
with
.
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
.
length
1
"
There
should
only
be
1
secondary
action
"
)
;
yield
clickSecondaryAction
(
0
)
;
curPerm
=
Services
.
perms
.
testPermissionFromPrincipal
(
principal
kTestPermissionKey
)
;
Assert
.
equal
(
curPerm
Ci
.
nsIPermissionManager
.
DENY_ACTION
"
Should
have
denied
the
action
"
)
;
Assert
.
ok
(
denied
"
The
secondaryAction
callback
should
have
fired
"
)
;
Assert
.
ok
(
!
allowed
"
The
mainAction
callback
should
not
have
fired
"
)
;
Assert
.
ok
(
mockRequest
.
_cancelled
"
The
request
should
have
been
cancelled
"
)
;
Assert
.
ok
(
!
mockRequest
.
_allowed
"
The
request
should
not
have
been
allowed
"
)
;
Services
.
perms
.
removeFromPrincipal
(
principal
kTestPermissionKey
)
;
denied
=
false
;
mockRequest
.
_cancelled
=
false
;
shownPromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
TestPrompt
.
prompt
(
)
;
yield
shownPromise
;
yield
clickMainAction
(
)
;
curPerm
=
Services
.
perms
.
testPermissionFromPrincipal
(
principal
kTestPermissionKey
)
;
Assert
.
equal
(
curPerm
Ci
.
nsIPermissionManager
.
ALLOW_ACTION
"
Should
have
allowed
the
action
"
)
;
Assert
.
ok
(
!
denied
"
The
secondaryAction
callback
should
not
have
fired
"
)
;
Assert
.
ok
(
allowed
"
The
mainAction
callback
should
have
fired
"
)
;
Assert
.
ok
(
!
mockRequest
.
_cancelled
"
The
request
should
not
have
been
cancelled
"
)
;
Assert
.
ok
(
mockRequest
.
_allowed
"
The
request
should
have
been
allowed
"
)
;
}
)
;
}
)
;
add_task
(
function
*
test_on_before_show
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
"
}
function
*
(
browser
)
{
const
kTestNotificationID
=
"
test
-
notification
"
;
const
kTestMessage
=
"
Test
message
"
;
let
mainAction
=
{
label
:
"
Test
action
"
accessKey
:
"
T
"
}
;
let
mockRequest
=
makeMockPermissionRequest
(
browser
)
;
let
beforeShown
=
false
;
let
TestPrompt
=
{
__proto__
:
PermissionUI
.
PermissionPromptForRequestPrototype
request
:
mockRequest
notificationID
:
kTestNotificationID
message
:
kTestMessage
promptActions
:
[
mainAction
]
onBeforeShow
(
)
{
beforeShown
=
true
;
}
}
;
let
shownPromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
TestPrompt
.
prompt
(
)
;
Assert
.
ok
(
beforeShown
"
Should
have
called
onBeforeShown
"
)
;
yield
shownPromise
;
let
notification
=
PopupNotifications
.
getNotification
(
kTestNotificationID
browser
)
;
let
removePromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popuphidden
"
)
;
notification
.
remove
(
)
;
yield
removePromise
;
}
)
;
}
)
;
add_task
(
function
*
test_no_request
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
"
}
function
*
(
browser
)
{
const
kTestNotificationID
=
"
test
-
notification
"
;
let
allowed
=
false
;
let
mainAction
=
{
label
:
"
Allow
"
accessKey
:
"
M
"
callback
:
function
(
)
{
allowed
=
true
;
}
}
;
let
denied
=
false
;
let
secondaryAction
=
{
label
:
"
Deny
"
accessKey
:
"
D
"
callback
:
function
(
)
{
denied
=
true
;
}
}
;
const
kTestMessage
=
"
Test
message
with
no
request
"
;
let
principal
=
browser
.
contentPrincipal
;
let
beforeShown
=
false
;
let
TestPrompt
=
{
__proto__
:
PermissionUI
.
PermissionPromptPrototype
notificationID
:
kTestNotificationID
principal
browser
message
:
kTestMessage
promptActions
:
[
mainAction
secondaryAction
]
onBeforeShow
(
)
{
beforeShown
=
true
;
}
}
;
let
shownPromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
TestPrompt
.
prompt
(
)
;
Assert
.
ok
(
beforeShown
"
Should
have
called
onBeforeShown
"
)
;
yield
shownPromise
;
let
notification
=
PopupNotifications
.
getNotification
(
kTestNotificationID
browser
)
;
Assert
.
equal
(
notification
.
message
kTestMessage
"
Should
be
showing
the
right
message
"
)
;
Assert
.
equal
(
notification
.
mainAction
.
label
mainAction
.
label
"
The
main
action
should
have
the
right
label
"
)
;
Assert
.
equal
(
notification
.
mainAction
.
accessKey
mainAction
.
accessKey
"
The
main
action
should
have
the
right
access
key
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
.
length
1
"
There
should
only
be
1
secondary
action
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
[
0
]
.
label
secondaryAction
.
label
"
The
secondary
action
should
have
the
right
label
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
[
0
]
.
accessKey
secondaryAction
.
accessKey
"
The
secondary
action
should
have
the
right
access
key
"
)
;
Assert
.
ok
(
notification
.
options
.
displayURI
.
equals
(
principal
.
URI
)
"
Should
be
showing
the
URI
of
the
requesting
page
"
)
;
Assert
.
equal
(
notification
.
secondaryActions
.
length
1
"
There
should
only
be
1
secondary
action
"
)
;
yield
clickSecondaryAction
(
0
)
;
Assert
.
ok
(
denied
"
The
secondaryAction
callback
should
have
fired
"
)
;
Assert
.
ok
(
!
allowed
"
The
mainAction
callback
should
not
have
fired
"
)
;
shownPromise
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
TestPrompt
.
prompt
(
)
;
yield
shownPromise
;
yield
clickMainAction
(
)
;
Assert
.
ok
(
allowed
"
The
mainAction
callback
should
have
fired
"
)
;
}
)
;
}
)
;
