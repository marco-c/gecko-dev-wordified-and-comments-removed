"
use
strict
"
;
const
{
UnsubmittedCrashHandler
}
=
Cu
.
import
(
"
resource
:
/
/
/
modules
/
ContentCrashHandlers
.
jsm
"
this
)
;
const
{
FileUtils
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
FileUtils
.
jsm
"
this
)
;
const
{
makeFakeAppDir
}
=
Cu
.
import
(
"
resource
:
/
/
testing
-
common
/
AppData
.
jsm
"
this
)
;
const
{
OS
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
this
)
;
const
DAY
=
24
*
60
*
60
*
1000
;
const
SERVER_URL
=
"
http
:
/
/
example
.
com
/
browser
/
toolkit
/
crashreporter
/
test
/
browser
/
crashreport
.
sjs
"
;
function
getPendingCrashReportDir
(
)
{
return
FileUtils
.
getDir
(
"
ProfD
"
[
"
UAppData
"
"
Crash
Reports
"
"
pending
"
]
false
)
;
}
function
clearPendingCrashReports
(
)
{
let
dir
=
getPendingCrashReportDir
(
)
;
let
entries
=
dir
.
directoryEntries
;
while
(
entries
.
hasMoreElements
(
)
)
{
let
entry
=
entries
.
getNext
(
)
.
QueryInterface
(
Ci
.
nsIFile
)
;
if
(
entry
.
isFile
(
)
)
{
entry
.
remove
(
false
)
;
}
}
}
function
*
createPendingCrashReports
(
howMany
accessDate
)
{
let
dir
=
getPendingCrashReportDir
(
)
;
if
(
!
accessDate
)
{
accessDate
=
new
Date
(
)
;
}
let
createFile
=
(
fileName
extension
accessDate
contents
)
=
>
{
let
file
=
dir
.
clone
(
)
;
file
.
append
(
fileName
+
"
.
"
+
extension
)
;
file
.
create
(
Ci
.
nsILocalFile
.
NORMAL_FILE_TYPE
FileUtils
.
PERMS_FILE
)
;
let
promises
=
[
OS
.
File
.
setDates
(
file
.
path
accessDate
)
]
;
if
(
contents
)
{
let
encoder
=
new
TextEncoder
(
)
;
let
array
=
encoder
.
encode
(
contents
)
;
promises
.
push
(
OS
.
File
.
writeAtomic
(
file
.
path
array
{
tmpPath
:
file
.
path
+
"
.
tmp
"
}
)
)
;
}
return
Promise
.
all
(
promises
)
;
}
let
uuidGenerator
=
Cc
[
"
mozilla
.
org
/
uuid
-
generator
;
1
"
]
.
getService
(
Ci
.
nsIUUIDGenerator
)
;
let
extraFileContents
=
"
ServerURL
=
"
+
SERVER_URL
;
return
Task
.
spawn
(
function
*
(
)
{
let
uuids
=
[
]
;
for
(
let
i
=
0
;
i
<
howMany
;
+
+
i
)
{
let
uuid
=
uuidGenerator
.
generateUUID
(
)
.
toString
(
)
;
uuid
=
uuid
.
substring
(
1
uuid
.
length
-
1
)
;
yield
createFile
(
uuid
"
dmp
"
accessDate
)
;
yield
createFile
(
uuid
"
extra
"
accessDate
extraFileContents
)
;
uuids
.
push
(
uuid
)
;
}
return
uuids
;
}
)
;
}
function
waitForSubmittedReports
(
reportIDs
)
{
let
promises
=
[
]
;
for
(
let
reportID
of
reportIDs
)
{
let
promise
=
TestUtils
.
topicObserved
(
"
crash
-
report
-
status
"
(
subject
data
)
=
>
{
if
(
data
=
=
"
success
"
)
{
let
propBag
=
subject
.
QueryInterface
(
Ci
.
nsIPropertyBag2
)
;
let
dumpID
=
propBag
.
getPropertyAsAString
(
"
minidumpID
"
)
;
if
(
dumpID
=
=
reportID
)
{
return
true
;
}
}
return
false
;
}
)
;
promises
.
push
(
promise
)
;
}
return
Promise
.
all
(
promises
)
;
}
function
waitForIgnoredReports
(
reportIDs
)
{
let
dir
=
getPendingCrashReportDir
(
)
;
let
promises
=
[
]
;
for
(
let
reportID
of
reportIDs
)
{
let
file
=
dir
.
clone
(
)
;
file
.
append
(
reportID
+
"
.
dmp
.
ignore
"
)
;
promises
.
push
(
OS
.
File
.
exists
(
file
.
path
)
)
;
}
return
Promise
.
all
(
promises
)
;
}
let
gNotificationBox
;
add_task
(
function
*
setup
(
)
{
yield
makeFakeAppDir
(
)
;
gNotificationBox
=
document
.
getElementById
(
"
global
-
notificationbox
"
)
;
let
notification
=
gNotificationBox
.
getNotificationWithValue
(
"
pending
-
crash
-
reports
"
)
;
if
(
notification
)
{
notification
.
close
(
)
;
}
let
env
=
Cc
[
"
mozilla
.
org
/
process
/
environment
;
1
"
]
.
getService
(
Components
.
interfaces
.
nsIEnvironment
)
;
let
oldServerURL
=
env
.
get
(
"
MOZ_CRASHREPORTER_URL
"
)
;
env
.
set
(
"
MOZ_CRASHREPORTER_URL
"
SERVER_URL
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
crashReports
.
unsubmittedCheck
.
enabled
"
true
]
]
}
)
;
UnsubmittedCrashHandler
.
init
(
)
;
registerCleanupFunction
(
function
(
)
{
gNotificationBox
=
null
;
clearPendingCrashReports
(
)
;
env
.
set
(
"
MOZ_CRASHREPORTER_URL
"
oldServerURL
)
;
}
)
;
}
)
;
add_task
(
function
*
test_no_pending_no_notification
(
)
{
clearPendingCrashReports
(
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
equal
(
notification
null
"
There
should
not
be
a
notification
if
there
are
no
"
+
"
pending
crash
reports
"
)
;
}
)
;
add_task
(
function
*
test_one_pending
(
)
{
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_several_pending
(
)
{
yield
createPendingCrashReports
(
3
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_several_pending
(
)
{
let
oldDate
=
new
Date
(
Date
.
now
(
)
-
(
30
*
DAY
)
)
;
yield
createPendingCrashReports
(
3
oldDate
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
equal
(
notification
null
"
There
should
not
be
a
notification
if
there
are
only
"
+
"
old
pending
crash
reports
"
)
;
yield
createPendingCrashReports
(
1
)
;
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_can_submit
(
)
{
let
reportIDs
=
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
let
buttons
=
notification
.
querySelectorAll
(
"
.
notification
-
button
"
)
;
let
submit
=
buttons
[
0
]
;
let
promiseReports
=
waitForSubmittedReports
(
reportIDs
)
;
info
(
"
Sending
crash
report
"
)
;
submit
.
click
(
)
;
info
(
"
Sent
!
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
info
(
"
Waiting
on
reports
to
be
received
.
"
)
;
yield
promiseReports
;
info
(
"
Received
!
"
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_can_submit_several
(
)
{
let
reportIDs
=
yield
createPendingCrashReports
(
3
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
let
buttons
=
notification
.
querySelectorAll
(
"
.
notification
-
button
"
)
;
let
submit
=
buttons
[
0
]
;
let
promiseReports
=
waitForSubmittedReports
(
reportIDs
)
;
info
(
"
Sending
crash
reports
"
)
;
submit
.
click
(
)
;
info
(
"
Sent
!
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
info
(
"
Waiting
on
reports
to
be
received
.
"
)
;
yield
promiseReports
;
info
(
"
Received
!
"
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_can_submit_always
(
)
{
let
pref
=
"
browser
.
crashReports
.
unsubmittedCheck
.
autoSubmit
"
;
Assert
.
equal
(
Services
.
prefs
.
getBoolPref
(
pref
)
false
"
We
should
not
be
auto
-
submitting
by
default
"
)
;
let
reportIDs
=
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
let
buttons
=
notification
.
querySelectorAll
(
"
.
notification
-
button
"
)
;
let
sendAll
=
buttons
[
1
]
;
let
promiseReports
=
waitForSubmittedReports
(
reportIDs
)
;
info
(
"
Sending
crash
reports
"
)
;
sendAll
.
click
(
)
;
info
(
"
Sent
!
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
info
(
"
Waiting
on
reports
to
be
received
.
"
)
;
yield
promiseReports
;
info
(
"
Received
!
"
)
;
Assert
.
equal
(
Services
.
prefs
.
getBoolPref
(
pref
)
true
"
The
autoSubmit
pref
should
have
been
set
"
)
;
Services
.
prefs
.
clearUserPref
(
pref
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_can_auto_submit
(
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
crashReports
.
unsubmittedCheck
.
autoSubmit
"
true
]
]
}
)
;
let
reportIDs
=
yield
createPendingCrashReports
(
3
)
;
let
promiseReports
=
waitForSubmittedReports
(
reportIDs
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
equal
(
notification
null
"
There
should
be
no
notification
"
)
;
info
(
"
Waiting
on
reports
to
be
received
.
"
)
;
yield
promiseReports
;
info
(
"
Received
!
"
)
;
clearPendingCrashReports
(
)
;
yield
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
function
*
test_can_ignore
(
)
{
let
reportIDs
=
yield
createPendingCrashReports
(
3
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
let
anonyNodes
=
document
.
getAnonymousNodes
(
notification
)
[
0
]
;
let
closeButton
=
anonyNodes
.
querySelector
(
"
.
close
-
icon
"
)
;
closeButton
.
click
(
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
yield
waitForIgnoredReports
(
reportIDs
)
;
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
equal
(
notification
null
"
There
should
be
no
notification
"
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_last_shown_date
(
)
{
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
let
today
=
new
Date
(
)
.
toLocaleFormat
(
"
%
Y
%
m
%
d
"
)
;
let
lastShownDate
=
UnsubmittedCrashHandler
.
prefs
.
getCharPref
(
"
lastShownDate
"
)
;
Assert
.
equal
(
today
lastShownDate
"
Last
shown
date
should
be
today
.
"
)
;
UnsubmittedCrashHandler
.
prefs
.
clearUserPref
(
"
lastShownDate
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_shutdown_while_showing
(
)
{
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
let
shutdownWhileShowing
=
UnsubmittedCrashHandler
.
prefs
.
getBoolPref
(
"
shutdownWhileShowing
"
)
;
Assert
.
ok
(
shutdownWhileShowing
"
We
should
have
noticed
that
we
uninitted
while
showing
"
+
"
the
notification
.
"
)
;
UnsubmittedCrashHandler
.
prefs
.
clearUserPref
(
"
shutdownWhileShowing
"
)
;
UnsubmittedCrashHandler
.
init
(
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_shutdown_while_not_showing
(
)
{
let
reportIDs
=
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
let
anonyNodes
=
document
.
getAnonymousNodes
(
notification
)
[
0
]
;
let
closeButton
=
anonyNodes
.
querySelector
(
"
.
close
-
icon
"
)
;
closeButton
.
click
(
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
yield
waitForIgnoredReports
(
reportIDs
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
Assert
.
throws
(
(
)
=
>
{
let
shutdownWhileShowing
=
UnsubmittedCrashHandler
.
prefs
.
getBoolPref
(
"
shutdownWhileShowing
"
)
;
}
"
We
should
have
noticed
that
the
notification
had
closed
before
"
+
"
uninitting
.
"
)
;
UnsubmittedCrashHandler
.
init
(
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_dont_decrement_chances_on_same_day
(
)
{
let
initChances
=
UnsubmittedCrashHandler
.
prefs
.
getIntPref
(
"
chancesUntilSuppress
"
)
;
Assert
.
ok
(
initChances
>
1
"
We
should
start
with
at
least
1
chance
.
"
)
;
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
let
shutdownWhileShowing
=
UnsubmittedCrashHandler
.
prefs
.
getBoolPref
(
"
shutdownWhileShowing
"
)
;
Assert
.
ok
(
shutdownWhileShowing
"
We
should
have
noticed
that
we
uninitted
while
showing
"
+
"
the
notification
.
"
)
;
let
today
=
new
Date
(
)
.
toLocaleFormat
(
"
%
Y
%
m
%
d
"
)
;
let
lastShownDate
=
UnsubmittedCrashHandler
.
prefs
.
getCharPref
(
"
lastShownDate
"
)
;
Assert
.
equal
(
today
lastShownDate
"
Last
shown
date
should
be
today
.
"
)
;
UnsubmittedCrashHandler
.
init
(
)
;
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
still
be
a
notification
"
)
;
let
chances
=
UnsubmittedCrashHandler
.
prefs
.
getIntPref
(
"
chancesUntilSuppress
"
)
;
Assert
.
equal
(
initChances
chances
"
We
should
not
have
decremented
chances
.
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_decrement_chances_on_other_day
(
)
{
let
initChances
=
UnsubmittedCrashHandler
.
prefs
.
getIntPref
(
"
chancesUntilSuppress
"
)
;
Assert
.
ok
(
initChances
>
1
"
We
should
start
with
at
least
1
chance
.
"
)
;
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
be
a
notification
"
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
let
shutdownWhileShowing
=
UnsubmittedCrashHandler
.
prefs
.
getBoolPref
(
"
shutdownWhileShowing
"
)
;
Assert
.
ok
(
shutdownWhileShowing
"
We
should
have
noticed
that
we
uninitted
while
showing
"
+
"
the
notification
.
"
)
;
let
yesterday
=
new
Date
(
Date
.
now
(
)
-
DAY
)
.
toLocaleFormat
(
"
%
Y
%
m
%
d
"
)
;
UnsubmittedCrashHandler
.
prefs
.
setCharPref
(
"
lastShownDate
"
yesterday
)
;
UnsubmittedCrashHandler
.
init
(
)
;
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
ok
(
notification
"
There
should
still
be
a
notification
"
)
;
let
chances
=
UnsubmittedCrashHandler
.
prefs
.
getIntPref
(
"
chancesUntilSuppress
"
)
;
Assert
.
equal
(
initChances
-
1
chances
"
We
should
have
decremented
our
chances
.
"
)
;
UnsubmittedCrashHandler
.
prefs
.
clearUserPref
(
"
chancesUntilSuppress
"
)
;
gNotificationBox
.
removeNotification
(
notification
true
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_can_suppress_after_chances
(
)
{
let
yesterday
=
new
Date
(
Date
.
now
(
)
-
DAY
)
.
toLocaleFormat
(
"
%
Y
%
m
%
d
"
)
;
UnsubmittedCrashHandler
.
prefs
.
setCharPref
(
"
lastShownDate
"
yesterday
)
;
UnsubmittedCrashHandler
.
prefs
.
setBoolPref
(
"
shutdownWhileShowing
"
true
)
;
UnsubmittedCrashHandler
.
prefs
.
setIntPref
(
"
chancesUntilSuppress
"
0
)
;
yield
createPendingCrashReports
(
1
)
;
let
notification
=
yield
UnsubmittedCrashHandler
.
checkForUnsubmittedCrashReports
(
)
;
Assert
.
equal
(
notification
null
"
There
should
be
no
notification
if
we
'
ve
run
out
of
chances
"
)
;
let
suppressUntilDate
=
UnsubmittedCrashHandler
.
prefs
.
getCharPref
(
"
suppressUntilDate
"
)
;
let
today
=
new
Date
(
)
.
toLocaleFormat
(
"
%
Y
%
m
%
d
"
)
;
Assert
.
ok
(
suppressUntilDate
>
today
"
We
should
be
suppressing
until
some
days
into
the
future
.
"
)
;
UnsubmittedCrashHandler
.
prefs
.
clearUserPref
(
"
chancesUntilSuppress
"
)
;
UnsubmittedCrashHandler
.
prefs
.
clearUserPref
(
"
suppressUntilDate
"
)
;
UnsubmittedCrashHandler
.
prefs
.
clearUserPref
(
"
lastShownDate
"
)
;
clearPendingCrashReports
(
)
;
}
)
;
add_task
(
function
*
test_suppression
(
)
{
let
future
=
new
Date
(
Date
.
now
(
)
+
(
DAY
*
5
)
)
.
toLocaleFormat
(
"
%
Y
%
m
%
d
"
)
;
UnsubmittedCrashHandler
.
prefs
.
setCharPref
(
"
suppressUntilDate
"
future
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
UnsubmittedCrashHandler
.
init
(
)
;
Assert
.
ok
(
UnsubmittedCrashHandler
.
suppressed
"
The
UnsubmittedCrashHandler
should
be
suppressed
.
"
)
;
UnsubmittedCrashHandler
.
prefs
.
clearUserPref
(
"
suppressUntilDate
"
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
UnsubmittedCrashHandler
.
init
(
)
;
}
)
;
add_task
(
function
*
test_end_suppression
(
)
{
let
yesterday
=
new
Date
(
Date
.
now
(
)
-
DAY
)
.
toLocaleFormat
(
"
%
Y
%
m
%
d
"
)
;
UnsubmittedCrashHandler
.
prefs
.
setCharPref
(
"
suppressUntilDate
"
yesterday
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
UnsubmittedCrashHandler
.
init
(
)
;
Assert
.
ok
(
!
UnsubmittedCrashHandler
.
suppressed
"
The
UnsubmittedCrashHandler
should
not
be
suppressed
.
"
)
;
Assert
.
ok
(
!
UnsubmittedCrashHandler
.
prefs
.
prefHasUserValue
(
"
suppressUntilDate
"
)
"
The
suppression
date
should
been
cleared
from
preferences
.
"
)
;
UnsubmittedCrashHandler
.
uninit
(
)
;
UnsubmittedCrashHandler
.
init
(
)
;
}
)
;
