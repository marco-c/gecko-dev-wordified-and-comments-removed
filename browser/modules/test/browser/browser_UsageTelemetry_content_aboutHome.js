"
use
strict
"
;
const
SCALAR_ABOUT_HOME
=
"
browser
.
engagement
.
navigation
.
about_home
"
;
add_task
(
async
function
setup
(
)
{
ignoreAllUncaughtExceptions
(
)
;
Services
.
search
.
addEngineWithDetails
(
"
MozSearch
"
"
"
"
mozalias
"
"
"
"
GET
"
"
http
:
/
/
example
.
com
/
?
q
=
{
searchTerms
}
"
)
;
Services
.
search
.
addEngineWithDetails
(
"
MozSearch2
"
"
"
"
mozalias2
"
"
"
"
GET
"
"
http
:
/
/
example
.
com
/
?
q
=
{
searchTerms
}
"
)
;
let
engineDefault
=
Services
.
search
.
getEngineByName
(
"
MozSearch
"
)
;
let
originalEngine
=
Services
.
search
.
currentEngine
;
Services
.
search
.
currentEngine
=
engineDefault
;
let
engineOneOff
=
Services
.
search
.
getEngineByName
(
"
MozSearch2
"
)
;
Services
.
search
.
moveEngine
(
engineOneOff
0
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
toolkit
.
telemetry
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
setEventRecordingEnabled
(
"
navigation
"
true
)
;
registerCleanupFunction
(
async
function
(
)
{
Services
.
search
.
currentEngine
=
originalEngine
;
Services
.
search
.
removeEngine
(
engineDefault
)
;
Services
.
search
.
removeEngine
(
engineOneOff
)
;
await
PlacesTestUtils
.
clearHistory
(
)
;
Services
.
telemetry
.
setEventRecordingEnabled
(
"
navigation
"
false
)
;
}
)
;
}
)
;
add_task
(
async
function
test_abouthome_simpleQuery
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
newtabpage
.
activity
-
stream
.
aboutHome
.
enabled
"
false
]
]
}
)
;
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
search_hist
=
getAndClearKeyedHistogram
(
"
SEARCH_COUNTS
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
info
(
"
Setup
waiting
for
AboutHomeLoadSnippetsCompleted
.
"
)
;
let
promiseAboutHomeLoaded
=
new
Promise
(
resolve
=
>
{
tab
.
linkedBrowser
.
addEventListener
(
"
AboutHomeLoadSnippetsCompleted
"
function
loadListener
(
event
)
{
tab
.
linkedBrowser
.
removeEventListener
(
"
AboutHomeLoadSnippetsCompleted
"
loadListener
true
)
;
resolve
(
)
;
}
true
true
)
;
}
)
;
info
(
"
Load
about
:
home
.
"
)
;
tab
.
linkedBrowser
.
loadURI
(
"
about
:
home
"
)
;
info
(
"
Wait
for
AboutHomeLoadSnippetsCompleted
.
"
)
;
await
promiseAboutHomeLoaded
;
info
(
"
Trigger
a
simple
serch
just
test
+
enter
.
"
)
;
let
p
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
await
typeInSearchField
(
tab
.
linkedBrowser
"
test
query
"
"
searchText
"
)
;
await
BrowserTestUtils
.
synthesizeKey
(
"
VK_RETURN
"
{
}
tab
.
linkedBrowser
)
;
await
p
;
const
scalars
=
getParentProcessScalars
(
Ci
.
nsITelemetry
.
DATASET_RELEASE_CHANNEL_OPTIN
true
false
)
;
checkKeyedScalar
(
scalars
SCALAR_ABOUT_HOME
"
search_enter
"
1
)
;
Assert
.
equal
(
Object
.
keys
(
scalars
[
SCALAR_ABOUT_HOME
]
)
.
length
1
"
This
search
must
only
increment
one
entry
in
the
scalar
.
"
)
;
checkKeyedHistogram
(
search_hist
"
other
-
MozSearch
.
abouthome
"
1
)
;
let
events
=
Services
.
telemetry
.
snapshotEvents
(
Ci
.
nsITelemetry
.
DATASET_RELEASE_CHANNEL_OPTIN
false
)
;
events
=
(
events
.
parent
|
|
[
]
)
.
filter
(
e
=
>
e
[
1
]
=
=
"
navigation
"
&
&
e
[
2
]
=
=
"
search
"
)
;
checkEvents
(
events
[
[
"
navigation
"
"
search
"
"
about_home
"
"
enter
"
{
engine
:
"
other
-
MozSearch
"
}
]
]
)
;
await
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_abouthome_activitystream_simpleQuery
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
newtabpage
.
activity
-
stream
.
aboutHome
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
search_hist
=
getAndClearKeyedHistogram
(
"
SEARCH_COUNTS
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
info
(
"
Setup
waiting
for
search
input
to
initialise
.
"
)
;
let
promiseAboutHomeSearchLoaded
=
new
Promise
(
resolve
=
>
{
tab
.
linkedBrowser
.
addEventListener
(
"
ContentSearchClient
"
function
loadListener
(
event
)
{
tab
.
linkedBrowser
.
removeEventListener
(
"
ContentSearchClient
"
loadListener
true
)
;
resolve
(
)
;
}
true
true
)
;
}
)
;
info
(
"
Load
about
:
home
.
"
)
;
tab
.
linkedBrowser
.
loadURI
(
"
about
:
home
"
)
;
info
(
"
Wait
for
ActivityStream
search
input
.
"
)
;
await
promiseAboutHomeSearchLoaded
;
info
(
"
Trigger
a
simple
serch
just
test
+
enter
.
"
)
;
let
p
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
await
typeInSearchField
(
tab
.
linkedBrowser
"
test
query
"
"
newtab
-
search
-
text
"
)
;
await
BrowserTestUtils
.
synthesizeKey
(
"
VK_RETURN
"
{
}
tab
.
linkedBrowser
)
;
await
p
;
const
scalars
=
getParentProcessScalars
(
Ci
.
nsITelemetry
.
DATASET_RELEASE_CHANNEL_OPTIN
true
false
)
;
checkKeyedScalar
(
scalars
SCALAR_ABOUT_HOME
"
search_enter
"
1
)
;
Assert
.
equal
(
Object
.
keys
(
scalars
[
SCALAR_ABOUT_HOME
]
)
.
length
1
"
This
search
must
only
increment
one
entry
in
the
scalar
.
"
)
;
checkKeyedHistogram
(
search_hist
"
other
-
MozSearch
.
abouthome
"
1
)
;
let
events
=
Services
.
telemetry
.
snapshotEvents
(
Ci
.
nsITelemetry
.
DATASET_RELEASE_CHANNEL_OPTIN
false
)
;
events
=
(
events
.
parent
|
|
[
]
)
.
filter
(
e
=
>
e
[
1
]
=
=
"
navigation
"
&
&
e
[
2
]
=
=
"
search
"
)
;
checkEvents
(
events
[
[
"
navigation
"
"
search
"
"
about_home
"
"
enter
"
{
engine
:
"
other
-
MozSearch
"
}
]
]
)
;
await
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
