Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
function
run_test
(
)
{
initApp
(
)
;
let
manifest
=
{
name
:
"
provider
1
"
origin
:
"
https
:
/
/
example1
.
com
"
}
;
MANIFEST_PREFS
.
setCharPref
(
manifest
.
origin
JSON
.
stringify
(
manifest
)
)
;
let
active
=
{
}
;
active
[
manifest
.
origin
]
=
1
;
Services
.
prefs
.
setStringPref
(
"
social
.
activeProviders
"
JSON
.
stringify
(
active
)
)
;
Services
.
prefs
.
setBoolPref
(
"
social
.
enabled
"
false
)
;
Cu
.
import
(
"
resource
:
/
/
/
modules
/
SocialService
.
jsm
"
)
;
let
runner
=
new
AsyncRunner
(
)
;
let
next
=
runner
.
next
.
bind
(
runner
)
;
runner
.
appendIterator
(
testMigration
(
manifest
next
)
)
;
runner
.
next
(
)
;
}
function
*
testMigration
(
manifest
next
)
{
do_check_true
(
Services
.
prefs
.
prefHasUserValue
(
"
social
.
enabled
"
)
)
;
do_check_true
(
MANIFEST_PREFS
.
prefHasUserValue
(
manifest
.
origin
)
)
;
yield
SocialService
.
getProviderList
(
next
)
;
do_check_false
(
SocialService
.
enabled
)
;
do_check_false
(
Services
.
prefs
.
prefHasUserValue
(
"
social
.
enabled
"
)
)
;
do_check_true
(
Services
.
prefs
.
prefHasUserValue
(
"
social
.
activeProviders
"
)
)
;
let
activeProviders
;
let
pref
=
Services
.
prefs
.
getStringPref
(
"
social
.
activeProviders
"
)
;
activeProviders
=
JSON
.
parse
(
pref
)
;
do_check_true
(
activeProviders
[
manifest
.
origin
]
=
=
undefined
)
;
do_check_true
(
MANIFEST_PREFS
.
prefHasUserValue
(
manifest
.
origin
)
)
;
}
