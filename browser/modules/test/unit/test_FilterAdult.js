"
use
strict
"
;
const
{
_FilterAdult
FilterAdult
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
FilterAdult
.
sys
.
mjs
"
)
;
const
{
FilterAdultComponent
}
=
ChromeUtils
.
importESModule
(
"
moz
-
src
:
/
/
/
toolkit
/
components
/
uniffi
-
bindgen
-
gecko
-
js
/
components
/
generated
/
RustFilterAdult
.
sys
.
mjs
"
)
;
const
{
sinon
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
Sinon
.
sys
.
mjs
"
)
;
let
originalPrefValue
;
const
FILTER_ADULT_ENABLED_PREF
=
"
browser
.
newtabpage
.
activity
-
stream
.
filterAdult
"
;
const
TEST_ADULT_SITE_URL
=
"
https
:
/
/
some
-
adult
-
site
.
com
/
"
;
const
TEST_ADULT_SITE_BASE_DOMAIN
=
Services
.
eTLD
.
getBaseDomain
(
Services
.
io
.
newURI
(
TEST_ADULT_SITE_URL
)
)
;
const
TEST_NON_ADULT_SITE_URL
=
"
https
:
/
/
mozilla
.
org
/
"
;
function
withFakeFilterAdult
(
sandbox
taskFn
)
{
let
fakeRustComponent
=
{
contains
:
sandbox
.
stub
(
)
}
;
sandbox
.
stub
(
FilterAdultComponent
"
init
"
)
.
returns
(
fakeRustComponent
)
;
let
instance
=
new
_FilterAdult
(
)
;
fakeRustComponent
.
contains
.
returns
(
false
)
;
fakeRustComponent
.
contains
.
withArgs
(
TEST_ADULT_SITE_BASE_DOMAIN
)
.
returns
(
true
)
;
taskFn
(
instance
fakeRustComponent
)
;
}
add_task
(
async
function
test_defaults_to_include_unexpected_urls
(
)
{
const
empty
=
{
}
;
const
result
=
FilterAdult
.
filter
(
[
empty
]
)
;
Assert
.
equal
(
result
.
length
1
"
Did
not
filter
any
items
.
"
)
;
Assert
.
equal
(
result
[
0
]
empty
"
The
items
were
not
changed
.
"
)
;
}
)
;
add_task
(
async
function
test_does_not_filter_non_adult_urls
(
)
{
const
link
=
{
url
:
TEST_NON_ADULT_SITE_URL
}
;
const
result
=
FilterAdult
.
filter
(
[
link
]
)
;
Assert
.
equal
(
result
.
length
1
"
Did
not
filter
any
items
.
"
)
;
Assert
.
equal
(
result
[
0
]
link
"
The
items
were
unchanged
.
"
)
;
}
)
;
add_task
(
async
function
test_filters_out_adult_urls
(
)
{
let
sandbox
=
sinon
.
createSandbox
(
)
;
withFakeFilterAdult
(
sandbox
instance
=
>
{
const
link
=
{
url
:
TEST_ADULT_SITE_URL
}
;
const
result
=
instance
.
filter
(
[
link
]
)
;
Assert
.
equal
(
result
.
length
0
"
Filtered
an
adult
site
link
.
"
)
;
}
)
;
sandbox
.
restore
(
)
;
}
)
;
add_task
(
async
function
test_does_not_filter_adult_urls_when_pref_off
(
)
{
let
sandbox
=
sinon
.
createSandbox
(
)
;
Services
.
prefs
.
setBoolPref
(
FILTER_ADULT_ENABLED_PREF
false
)
;
withFakeFilterAdult
(
sandbox
(
instance
fakeRustComponent
)
=
>
{
const
link
=
{
url
:
TEST_ADULT_SITE_URL
}
;
const
result
=
instance
.
filter
(
[
link
]
)
;
Assert
.
equal
(
result
.
length
1
"
Did
not
filter
an
adult
site
when
disabled
.
"
)
;
Assert
.
equal
(
result
[
0
]
link
"
Did
not
alter
an
adult
site
link
when
disabled
.
"
)
;
Assert
.
ok
(
fakeRustComponent
.
contains
.
notCalled
"
Rust
component
was
not
called
when
disabled
.
"
)
;
}
)
;
Services
.
prefs
.
setBoolPref
(
FILTER_ADULT_ENABLED_PREF
true
)
;
sandbox
.
restore
(
)
;
}
)
;
add_task
(
async
function
test_isAdultUrl_returns_false_for_unexpected_urls
(
)
{
const
result
=
FilterAdult
.
isAdultUrl
(
"
"
)
;
Assert
.
ok
(
!
result
"
Invalid
URLs
are
not
considered
adult
.
"
)
;
}
)
;
add_task
(
async
function
test_isAdultUrl_returns_false_for_non_adult_urls
(
)
{
const
result
=
FilterAdult
.
isAdultUrl
(
TEST_NON_ADULT_SITE_URL
)
;
Assert
.
ok
(
!
result
"
Non
-
adult
sites
are
not
considered
adult
.
"
)
;
}
)
;
add_task
(
async
function
test_isAdultUrl_returns_true_for_adult_urls
(
)
{
let
sandbox
=
sinon
.
createSandbox
(
)
;
withFakeFilterAdult
(
sandbox
instance
=
>
{
const
result
=
instance
.
isAdultUrl
(
TEST_ADULT_SITE_URL
)
;
Assert
.
ok
(
result
"
Site
was
classified
as
being
for
adults
.
"
)
;
}
)
;
sandbox
.
restore
(
)
;
}
)
;
add_task
(
async
function
test_isAdultUrl_returns_false_when_pref_off
(
)
{
let
sandbox
=
sinon
.
createSandbox
(
)
;
Services
.
prefs
.
setBoolPref
(
FILTER_ADULT_ENABLED_PREF
false
)
;
withFakeFilterAdult
(
sandbox
(
instance
fakeRustComponent
)
=
>
{
const
result
=
instance
.
isAdultUrl
(
TEST_ADULT_SITE_URL
)
;
Assert
.
ok
(
!
result
"
Site
was
NOT
classified
as
being
for
adults
because
filtering
is
disabled
.
"
)
;
Assert
.
ok
(
fakeRustComponent
.
contains
.
notCalled
"
Rust
component
was
not
called
when
disabled
.
"
)
;
}
)
;
Services
.
prefs
.
setBoolPref
(
FILTER_ADULT_ENABLED_PREF
true
)
;
sandbox
.
restore
(
)
;
}
)
;
