var
UnexpectedScriptLoadPanel
=
new
(
class
{
#
console
;
#
scriptName
=
"
"
;
get
console
(
)
{
if
(
!
this
.
#
console
)
{
this
.
#
console
=
console
.
createInstance
(
{
maxLogLevelPref
:
"
browser
.
unexpectedScriptLoad
.
logLevel
"
prefix
:
"
UnexpectedScriptLoad
"
}
)
;
}
return
this
.
#
console
;
}
#
lazyElements
;
get
elements
(
)
{
if
(
!
this
.
#
lazyElements
)
{
this
.
#
lazyElements
=
{
dialogCloseButton
:
document
.
querySelector
(
"
.
dialogClose
"
)
reportCheckbox
:
document
.
querySelector
(
"
#
reportCheckbox
"
)
emailCheckbox
:
document
.
querySelector
(
"
#
emailCheckbox
"
)
emailInput
:
document
.
querySelector
(
"
#
emailInput
"
)
allowButton
:
document
.
querySelector
(
"
#
allow
-
button
"
)
blockButton
:
document
.
querySelector
(
"
#
block
-
button
"
)
scriptUrl
:
document
.
querySelector
(
"
.
scriptUrl
"
)
unexpectedScriptLoadDetail1
:
document
.
querySelector
(
"
#
unexpected
-
script
-
load
-
detail
-
1
"
)
moreInfoLink
:
document
.
querySelector
(
"
#
more
-
info
-
link
"
)
learnMoreLink
:
document
.
querySelector
(
"
#
learn
-
more
-
link
"
)
}
;
}
return
this
.
#
lazyElements
;
}
init
(
)
{
this
.
console
?
.
log
(
"
UnexpectedScriptLoadPanel
initialized
"
)
;
let
args
=
window
.
arguments
[
0
]
;
let
action
=
args
.
action
;
this
.
#
scriptName
=
args
.
scriptName
;
this
.
elements
.
scriptUrl
.
textContent
=
this
.
#
scriptName
;
if
(
action
=
=
=
"
allow
"
)
{
this
.
setupAllowLayout
(
)
;
Glean
.
unexpectedScriptLoad
.
scriptAllowedOpened
.
record
(
)
;
}
else
if
(
action
=
=
=
"
block
"
)
{
Glean
.
unexpectedScriptLoad
.
scriptBlockedOpened
.
record
(
)
;
this
.
setupBlockLayout
(
)
;
}
this
.
setupEventHandlers
(
)
;
}
setupEventHandlers
(
)
{
this
.
elements
.
dialogCloseButton
.
addEventListener
(
"
click
"
(
)
=
>
{
this
.
close
(
true
)
;
}
)
;
this
.
elements
.
moreInfoLink
.
addEventListener
(
"
click
"
(
)
=
>
{
this
.
onLearnMoreLink
(
)
;
}
)
;
this
.
elements
.
learnMoreLink
.
addEventListener
(
"
click
"
(
)
=
>
{
this
.
onLearnMoreLink
(
)
;
}
)
;
this
.
elements
.
allowButton
.
addEventListener
(
"
click
"
(
)
=
>
{
this
.
onAllow
(
)
;
}
)
;
this
.
elements
.
blockButton
.
addEventListener
(
"
click
"
(
)
=
>
{
this
.
onBlock
(
)
;
}
)
;
this
.
elements
.
emailInput
.
addEventListener
(
"
change
"
e
=
>
{
const
hasEmail
=
this
.
elements
.
emailInput
.
value
.
trim
(
)
!
=
=
"
"
;
if
(
!
hasEmail
)
return
;
setTimeout
(
(
)
=
>
{
this
.
console
?
.
warn
(
Rechecking
checkboxes
)
;
if
(
this
.
elements
.
emailInput
.
value
.
trim
(
)
)
{
this
.
elements
.
emailCheckbox
.
checked
=
true
;
this
.
elements
.
reportCheckbox
.
checked
=
true
;
}
}
0
)
;
e
.
stopPropagation
(
)
;
}
)
;
this
.
elements
.
emailCheckbox
.
addEventListener
(
"
change
"
(
)
=
>
{
if
(
!
this
.
elements
.
emailCheckbox
.
checked
)
{
this
.
elements
.
emailInput
.
value
=
"
"
;
}
}
)
;
this
.
elements
.
reportCheckbox
.
addEventListener
(
"
change
"
(
)
=
>
{
if
(
!
this
.
elements
.
reportCheckbox
.
checked
)
{
this
.
elements
.
emailCheckbox
.
checked
=
false
;
this
.
elements
.
emailInput
.
value
=
"
"
;
}
}
)
;
}
setupAllowLayout
(
)
{
this
.
elements
.
unexpectedScriptLoadDetail1
.
setAttribute
(
"
data
-
l10n
-
id
"
"
unexpected
-
script
-
load
-
detail
-
1
-
allow
"
)
;
this
.
elements
.
allowButton
.
setAttribute
(
"
type
"
"
primary
"
)
;
this
.
elements
.
blockButton
.
setAttribute
(
"
type
"
"
"
)
;
}
setupBlockLayout
(
)
{
this
.
elements
.
unexpectedScriptLoadDetail1
.
setAttribute
(
"
data
-
l10n
-
id
"
"
unexpected
-
script
-
load
-
detail
-
1
-
block
"
)
;
this
.
elements
.
reportCheckbox
.
checked
=
true
;
this
.
elements
.
allowButton
.
setAttribute
(
"
type
"
"
"
)
;
this
.
elements
.
blockButton
.
setAttribute
(
"
type
"
"
primary
"
)
;
}
close
(
userDismissed
)
{
this
.
console
?
.
log
(
"
UnexpectedScriptLoadPanel
is
closing
"
)
;
if
(
userDismissed
)
{
Glean
.
unexpectedScriptLoad
.
dialogDismissed
.
record
(
)
;
}
window
.
close
(
)
;
GleanPings
.
unexpectedScriptLoad
.
submit
(
)
;
}
onLearnMoreLink
(
)
{
Glean
.
unexpectedScriptLoad
.
moreInfoOpened
.
record
(
)
;
this
.
close
(
false
)
;
window
.
top
.
document
.
documentElement
.
removeAttribute
(
"
window
-
modal
-
open
"
)
;
window
.
browsingContext
.
top
.
window
.
openTrustedLinkIn
(
"
https
:
/
/
support
.
mozilla
.
org
/
kb
/
unexpected
-
script
-
load
"
"
tab
"
)
;
}
maybeReport
(
)
{
if
(
this
.
elements
.
reportCheckbox
.
checked
)
{
let
extra
=
{
script_url
:
this
.
#
scriptName
}
;
if
(
this
.
elements
.
emailCheckbox
.
checked
)
{
extra
.
user_email
=
this
.
elements
.
emailInput
.
value
.
trim
(
)
;
}
Glean
.
unexpectedScriptLoad
.
scriptReported
.
record
(
extra
)
;
}
}
onBlock
(
)
{
this
.
console
?
.
log
(
"
UnexpectedScriptLoadPanel
.
onBlock
(
)
called
"
)
;
Glean
.
unexpectedScriptLoad
.
scriptBlocked
.
record
(
)
;
this
.
maybeReport
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
block_parent_unrestricted_js_loads
.
temporary
"
true
)
;
window
.
browsingContext
.
top
.
window
.
gNotificationBox
.
getNotificationWithValue
(
"
unexpected
-
script
-
notification
"
)
?
.
close
(
)
;
this
.
close
(
false
)
;
}
onAllow
(
)
{
this
.
console
?
.
log
(
"
UnexpectedScriptLoadPanel
.
onAllow
(
)
called
"
)
;
Glean
.
unexpectedScriptLoad
.
scriptAllowed
.
record
(
)
;
this
.
maybeReport
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
allow_parent_unrestricted_js_loads
"
true
)
;
window
.
browsingContext
.
top
.
window
.
gNotificationBox
.
getNotificationWithValue
(
"
unexpected
-
script
-
notification
"
)
?
.
close
(
)
;
this
.
close
(
false
)
;
}
}
)
(
)
;
UnexpectedScriptLoadPanel
.
init
(
)
;
