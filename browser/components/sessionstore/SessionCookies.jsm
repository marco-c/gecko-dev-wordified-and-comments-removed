"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
SessionCookies
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
PrivacyLevel
"
"
resource
:
/
/
gre
/
modules
/
sessionstore
/
PrivacyLevel
.
jsm
"
)
;
const
MAX_EXPIRY
=
Number
.
MAX_SAFE_INTEGER
;
var
SessionCookies
=
Object
.
freeze
(
{
collect
(
)
{
return
SessionCookiesInternal
.
collect
(
)
;
}
restore
(
cookies
)
{
SessionCookiesInternal
.
restore
(
cookies
)
;
}
}
)
;
var
SessionCookiesInternal
=
{
_initialized
:
false
collect
(
)
{
this
.
_ensureInitialized
(
)
;
return
CookieStore
.
toArray
(
)
;
}
restore
(
cookies
)
{
for
(
let
cookie
of
cookies
)
{
let
expiry
=
"
expiry
"
in
cookie
?
cookie
.
expiry
:
MAX_EXPIRY
;
let
exists
=
false
;
try
{
exists
=
Services
.
cookies
.
cookieExists
(
cookie
.
host
cookie
.
path
|
|
"
"
cookie
.
name
|
|
"
"
cookie
.
originAttributes
|
|
{
}
)
;
}
catch
(
ex
)
{
Cu
.
reportError
(
CookieService
:
:
CookieExists
failed
with
error
'
{
ex
}
'
for
'
{
JSON
.
stringify
(
cookie
)
}
'
.
)
;
}
if
(
!
exists
)
{
try
{
Services
.
cookies
.
add
(
cookie
.
host
cookie
.
path
|
|
"
"
cookie
.
name
|
|
"
"
cookie
.
value
!
!
cookie
.
secure
!
!
cookie
.
httponly
true
expiry
cookie
.
originAttributes
|
|
{
}
cookie
.
sameSite
|
|
Ci
.
nsICookie
.
SAMESITE_NONE
cookie
.
schemeMap
|
|
Ci
.
nsICookie
.
SCHEME_HTTPS
)
;
}
catch
(
ex
)
{
Cu
.
reportError
(
CookieService
:
:
Add
failed
with
error
'
{
ex
}
'
for
cookie
{
JSON
.
stringify
(
cookie
)
}
.
)
;
}
}
}
}
observe
(
subject
topic
data
)
{
switch
(
data
)
{
case
"
added
"
:
this
.
_addCookie
(
subject
)
;
break
;
case
"
changed
"
:
this
.
_updateCookie
(
subject
)
;
break
;
case
"
deleted
"
:
this
.
_removeCookie
(
subject
)
;
break
;
case
"
cleared
"
:
CookieStore
.
clear
(
)
;
break
;
case
"
batch
-
deleted
"
:
this
.
_removeCookies
(
subject
)
;
break
;
default
:
throw
new
Error
(
"
Unhandled
session
-
cookie
-
changed
notification
.
"
)
;
}
}
_ensureInitialized
(
)
{
if
(
this
.
_initialized
)
{
return
;
}
this
.
_reloadCookies
(
)
;
this
.
_initialized
=
true
;
Services
.
obs
.
addObserver
(
this
"
session
-
cookie
-
changed
"
)
;
Services
.
prefs
.
addObserver
(
"
browser
.
sessionstore
.
privacy_level
"
(
)
=
>
{
this
.
_reloadCookies
(
)
;
}
)
;
}
_addCookie
(
cookie
)
{
cookie
.
QueryInterface
(
Ci
.
nsICookie
)
;
if
(
cookie
.
isSession
&
&
PrivacyLevel
.
canSave
(
cookie
.
isSecure
)
)
{
CookieStore
.
add
(
cookie
)
;
}
}
_updateCookie
(
cookie
)
{
cookie
.
QueryInterface
(
Ci
.
nsICookie
)
;
if
(
cookie
.
isSession
&
&
PrivacyLevel
.
canSave
(
cookie
.
isSecure
)
)
{
CookieStore
.
add
(
cookie
)
;
}
else
{
CookieStore
.
delete
(
cookie
)
;
}
}
_removeCookie
(
cookie
)
{
cookie
.
QueryInterface
(
Ci
.
nsICookie
)
;
if
(
cookie
.
isSession
)
{
CookieStore
.
delete
(
cookie
)
;
}
}
_removeCookies
(
cookies
)
{
for
(
let
i
=
0
;
i
<
cookies
.
length
;
i
+
+
)
{
this
.
_removeCookie
(
cookies
.
queryElementAt
(
i
Ci
.
nsICookie
)
)
;
}
}
_reloadCookies
(
)
{
CookieStore
.
clear
(
)
;
if
(
!
PrivacyLevel
.
canSave
(
false
)
)
{
return
;
}
for
(
let
cookie
of
Services
.
cookies
.
sessionCookies
)
{
this
.
_addCookie
(
cookie
)
;
}
}
}
;
var
CookieStore
=
{
_entries
:
new
Map
(
)
add
(
cookie
)
{
let
jscookie
=
{
host
:
cookie
.
host
value
:
cookie
.
value
}
;
if
(
cookie
.
path
)
{
jscookie
.
path
=
cookie
.
path
;
}
if
(
cookie
.
name
)
{
jscookie
.
name
=
cookie
.
name
;
}
if
(
cookie
.
isSecure
)
{
jscookie
.
secure
=
true
;
}
if
(
cookie
.
isHttpOnly
)
{
jscookie
.
httponly
=
true
;
}
if
(
cookie
.
expiry
<
MAX_EXPIRY
)
{
jscookie
.
expiry
=
cookie
.
expiry
;
}
if
(
cookie
.
originAttributes
)
{
jscookie
.
originAttributes
=
cookie
.
originAttributes
;
}
if
(
cookie
.
sameSite
)
{
jscookie
.
sameSite
=
cookie
.
sameSite
;
}
if
(
cookie
.
schemeMap
)
{
jscookie
.
schemeMap
=
cookie
.
schemeMap
;
}
this
.
_entries
.
set
(
this
.
_getKeyForCookie
(
cookie
)
jscookie
)
;
}
delete
(
cookie
)
{
this
.
_entries
.
delete
(
this
.
_getKeyForCookie
(
cookie
)
)
;
}
clear
(
)
{
this
.
_entries
.
clear
(
)
;
}
toArray
(
)
{
return
[
.
.
.
this
.
_entries
.
values
(
)
]
;
}
_getKeyForCookie
(
cookie
)
{
return
JSON
.
stringify
(
{
host
:
cookie
.
host
name
:
cookie
.
name
path
:
cookie
.
path
attr
:
ChromeUtils
.
originAttributesToSuffix
(
cookie
.
originAttributes
)
}
)
;
}
}
;
