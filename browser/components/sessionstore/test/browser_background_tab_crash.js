"
use
strict
"
;
function
*
setupBackgroundTabs
(
testFn
)
{
const
REMOTE_PAGE
=
"
http
:
/
/
www
.
example
.
com
"
;
const
NON_REMOTE_PAGE
=
"
about
:
robots
"
;
let
initialTab
=
gBrowser
.
selectedTab
;
let
initialBrowser
=
initialTab
.
linkedBrowser
;
initialBrowser
.
loadURI
(
NON_REMOTE_PAGE
)
;
yield
BrowserTestUtils
.
browserLoaded
(
initialBrowser
)
;
let
tab1
=
yield
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
REMOTE_PAGE
)
;
let
remoteBrowser1
=
tab1
.
linkedBrowser
;
yield
TabStateFlusher
.
flush
(
remoteBrowser1
)
;
let
tab2
=
yield
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
REMOTE_PAGE
)
;
let
remoteBrowser2
=
tab2
.
linkedBrowser
;
yield
TabStateFlusher
.
flush
(
remoteBrowser2
)
;
Assert
.
ok
(
remoteBrowser1
.
isRemoteBrowser
"
Browser
should
be
remote
in
order
to
crash
.
"
)
;
Assert
.
ok
(
remoteBrowser2
.
isRemoteBrowser
"
Browser
should
be
remote
in
order
to
crash
.
"
)
;
Assert
.
equal
(
remoteBrowser1
.
frameLoader
.
childID
remoteBrowser2
.
frameLoader
.
childID
"
Both
remote
browsers
should
share
the
same
content
process
.
"
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
initialTab
)
;
yield
testFn
(
[
tab1
tab2
]
)
;
yield
BrowserTestUtils
.
removeTab
(
tab1
)
;
yield
BrowserTestUtils
.
removeTab
(
tab2
)
;
}
function
*
crashBackgroundTabs
(
tabs
)
{
Assert
.
ok
(
tabs
.
length
>
0
"
Need
to
crash
at
least
one
tab
.
"
)
;
for
(
let
tab
of
tabs
)
{
Assert
.
ok
(
tab
.
linkedBrowser
.
isRemoteBrowser
"
tab
is
remote
"
)
;
}
let
remotenessChangePromises
=
tabs
.
map
(
(
t
)
=
>
{
return
BrowserTestUtils
.
waitForEvent
(
t
"
TabRemotenessChange
"
)
;
}
)
;
let
tabsRevived
=
tabs
.
map
(
(
t
)
=
>
{
return
promiseTabRestoring
(
t
)
;
}
)
;
yield
BrowserTestUtils
.
crashBrowser
(
tabs
[
0
]
.
linkedBrowser
false
)
;
yield
Promise
.
all
(
remotenessChangePromises
)
;
yield
Promise
.
all
(
tabsRevived
)
;
for
(
let
tab
of
tabs
)
{
Assert
.
ok
(
!
tab
.
linkedBrowser
.
isRemoteBrowser
"
tab
is
not
remote
"
)
;
Assert
.
ok
(
!
tab
.
linkedBrowser
.
hasAttribute
(
"
crashed
"
)
"
tab
is
not
crashed
"
)
;
Assert
.
ok
(
tab
.
linkedBrowser
.
hasAttribute
(
"
pending
"
)
"
tab
is
pending
"
)
;
}
}
add_task
(
function
*
setup
(
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
ipc
.
processCount
"
1
]
]
}
)
;
requestLongerTimeout
(
5
)
;
}
)
;
add_task
(
function
*
test_background_crash_simple
(
)
{
yield
setupBackgroundTabs
(
function
*
(
[
tab1
tab2
]
)
{
yield
crashBackgroundTabs
(
[
tab1
tab2
]
)
;
let
tabCrashedPagePromise
=
BrowserTestUtils
.
waitForContentEvent
(
tab1
.
linkedBrowser
"
AboutTabCrashedReady
"
false
null
true
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab1
)
;
yield
tabCrashedPagePromise
;
let
tabRestored
=
promiseTabRestored
(
tab2
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab2
)
;
yield
tabRestored
;
}
)
;
}
)
;
add_task
(
function
*
test_background_crash_autosubmit_backlogged
(
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
crashReports
.
unsubmittedCheck
.
autoSubmit
"
true
]
]
}
)
;
yield
setupBackgroundTabs
(
function
*
(
[
tab1
tab2
]
)
{
yield
crashBackgroundTabs
(
[
tab1
tab2
]
)
;
let
tabRestored
=
promiseTabRestored
(
tab1
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab1
)
;
yield
tabRestored
;
tabRestored
=
promiseTabRestored
(
tab2
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab2
)
;
yield
tabRestored
;
}
)
;
yield
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
function
*
test_background_crash_multiple
(
)
{
let
initialTab
=
gBrowser
.
selectedTab
;
yield
setupBackgroundTabs
(
function
*
(
[
tab1
tab2
]
)
{
yield
crashBackgroundTabs
(
[
tab1
tab2
]
)
;
let
tabCrashedPagePromise
=
BrowserTestUtils
.
waitForContentEvent
(
tab1
.
linkedBrowser
"
AboutTabCrashedReady
"
false
null
true
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab1
)
;
yield
tabCrashedPagePromise
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
initialTab
)
;
yield
setupBackgroundTabs
(
function
*
(
[
tab3
tab4
]
)
{
yield
crashBackgroundTabs
(
[
tab3
tab4
]
)
;
let
tabRestored
=
promiseTabRestored
(
tab2
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab2
)
;
yield
tabRestored
;
let
tabCrashedPagePromise
=
BrowserTestUtils
.
waitForContentEvent
(
tab4
.
linkedBrowser
"
AboutTabCrashedReady
"
false
null
true
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab4
)
;
yield
tabCrashedPagePromise
;
tabRestored
=
promiseTabRestored
(
tab3
)
;
yield
BrowserTestUtils
.
switchTab
(
gBrowser
tab3
)
;
yield
tabRestored
;
}
)
;
}
)
;
}
)
;
