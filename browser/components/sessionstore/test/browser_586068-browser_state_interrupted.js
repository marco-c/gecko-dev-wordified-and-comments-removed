const
PREF_RESTORE_ON_DEMAND
=
"
browser
.
sessionstore
.
restore_on_demand
"
;
requestLongerTimeout
(
2
)
;
add_task
(
async
function
test
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF_RESTORE_ON_DEMAND
false
)
;
registerCleanupFunction
(
function
(
)
{
Services
.
prefs
.
clearUserPref
(
PREF_RESTORE_ON_DEMAND
)
;
}
)
;
let
state1
=
{
windows
:
[
{
tabs
:
[
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
1
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
2
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
3
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
4
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
]
selected
:
1
}
{
tabs
:
[
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
1
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
2
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
3
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
4
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
]
selected
:
3
}
]
}
;
let
state2
=
{
windows
:
[
{
tabs
:
[
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
5
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
6
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
7
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
org
#
8
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
]
selected
:
3
}
{
tabs
:
[
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
5
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
6
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
7
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
{
entries
:
[
{
url
:
"
http
:
/
/
example
.
com
#
8
"
triggeringPrincipal_base64
}
]
extData
:
{
"
uniq
"
:
r
(
)
}
}
]
selected
:
1
}
]
}
;
let
interruptedAfter
=
0
;
let
loadedWindow1
=
false
;
let
loadedWindow2
=
false
;
let
numTabs
=
state2
.
windows
[
0
]
.
tabs
.
length
+
state2
.
windows
[
1
]
.
tabs
.
length
;
let
loadCount
=
0
;
let
promiseRestoringTabs
=
new
Promise
(
resolve
=
>
{
gProgressListener
.
setCallback
(
function
(
aBrowser
aNeedRestore
aRestoring
aRestored
)
{
loadCount
+
+
;
if
(
aBrowser
.
currentURI
.
spec
=
=
state1
.
windows
[
0
]
.
tabs
[
2
]
.
entries
[
0
]
.
url
)
loadedWindow1
=
true
;
if
(
aBrowser
.
currentURI
.
spec
=
=
state1
.
windows
[
1
]
.
tabs
[
0
]
.
entries
[
0
]
.
url
)
loadedWindow2
=
true
;
if
(
!
interruptedAfter
&
&
loadedWindow1
&
&
loadedWindow2
)
{
interruptedAfter
=
loadCount
;
ss
.
setBrowserState
(
JSON
.
stringify
(
state2
)
)
;
return
;
}
if
(
loadCount
<
numTabs
+
interruptedAfter
)
return
;
is
(
loadCount
numTabs
+
interruptedAfter
"
all
tabs
were
restored
"
)
;
is
(
aNeedRestore
0
"
there
are
no
tabs
left
needing
restore
"
)
;
gProgressListener
.
unsetCallback
(
)
;
resolve
(
)
;
}
)
;
}
)
;
Services
.
ww
.
registerNotification
(
function
observer
(
aSubject
aTopic
aData
)
{
if
(
aTopic
=
=
"
domwindowopened
"
)
{
let
win
=
aSubject
.
QueryInterface
(
Ci
.
nsIDOMWindow
)
;
win
.
addEventListener
(
"
load
"
function
(
)
{
Services
.
ww
.
unregisterNotification
(
observer
)
;
win
.
gBrowser
.
addTabsProgressListener
(
gProgressListener
)
;
}
{
once
:
true
}
)
;
}
}
)
;
let
backupState
=
ss
.
getBrowserState
(
)
;
ss
.
setBrowserState
(
JSON
.
stringify
(
state1
)
)
;
await
promiseRestoringTabs
;
await
promiseAllButPrimaryWindowClosed
(
)
;
await
promiseBrowserState
(
backupState
)
;
}
)
;
