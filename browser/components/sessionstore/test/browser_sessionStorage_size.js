"
use
strict
"
;
const
RAND
=
Math
.
random
(
)
;
const
URL
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
"
+
"
browser
/
components
/
sessionstore
/
test
/
browser_sessionStorage
.
html
"
+
"
?
"
+
RAND
;
const
OUTER_VALUE
=
"
outer
-
value
-
"
+
RAND
;
add_task
(
async
function
test_telemetry
(
)
{
Services
.
telemetry
.
canRecordExtended
=
true
;
let
suffix
=
gMultiProcessBrowser
?
"
#
content
"
:
"
"
;
let
histogram
=
Services
.
telemetry
.
getHistogramById
(
"
FX_SESSION_RESTORE_DOM_STORAGE_SIZE_ESTIMATE_CHARS
"
+
suffix
)
;
let
snap1
=
histogram
.
snapshot
(
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
URL
)
;
let
browser
=
tab
.
linkedBrowser
;
await
promiseBrowserLoaded
(
browser
)
;
await
TabStateFlusher
.
flush
(
browser
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
histogram
.
snapshot
(
)
.
counts
[
4
]
>
snap1
.
counts
[
4
]
;
}
)
;
Assert
.
ok
(
true
)
;
await
promiseRemoveTab
(
tab
)
;
Services
.
telemetry
.
canRecordExtended
=
false
;
}
)
;
add_task
(
async
function
test_large_content
(
)
{
Services
.
prefs
.
setIntPref
(
"
browser
.
sessionstore
.
dom_storage_limit
"
5
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
URL
)
;
let
browser
=
tab
.
linkedBrowser
;
await
promiseBrowserLoaded
(
browser
)
;
await
TabStateFlusher
.
flush
(
browser
)
;
let
state
=
JSON
.
parse
(
ss
.
getTabState
(
tab
)
)
;
info
(
JSON
.
stringify
(
state
null
"
\
t
"
)
)
;
Assert
.
equal
(
state
.
storage
null
"
We
have
no
storage
for
the
tab
"
)
;
Assert
.
equal
(
state
.
entries
[
0
]
.
title
OUTER_VALUE
)
;
await
promiseRemoveTab
(
tab
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
sessionstore
.
dom_storage_limit
"
)
;
}
)
;
