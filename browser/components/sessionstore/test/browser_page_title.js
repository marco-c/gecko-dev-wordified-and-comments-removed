"
use
strict
"
;
const
URL
=
"
data
:
text
/
html
<
title
>
initial
title
<
/
title
>
"
;
add_task
(
async
function
(
)
{
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
URL
)
;
await
promiseBrowserLoaded
(
tab
.
linkedBrowser
)
;
await
promiseRemoveTabAndSessionState
(
tab
)
;
let
[
{
state
:
{
entries
}
}
]
=
JSON
.
parse
(
ss
.
getClosedTabData
(
window
)
)
;
is
(
entries
[
0
]
.
title
"
initial
title
"
"
correct
title
"
)
;
}
)
;
add_task
(
async
function
(
)
{
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
URL
)
;
let
browser
=
tab
.
linkedBrowser
;
await
promiseBrowserLoaded
(
browser
)
;
await
TabStateFlusher
.
flush
(
browser
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
function
(
)
{
return
new
Promise
(
resolve
=
>
{
docShell
.
chromeEventHandler
.
addEventListener
(
"
DOMTitleChanged
"
function
onTitleChanged
(
)
{
docShell
.
chromeEventHandler
.
removeEventListener
(
"
DOMTitleChanged
"
onTitleChanged
)
;
resolve
(
)
;
}
)
;
content
.
document
.
title
=
"
new
title
"
;
}
)
;
}
)
;
await
promiseRemoveTabAndSessionState
(
tab
)
;
let
[
{
state
:
{
entries
}
}
]
=
JSON
.
parse
(
ss
.
getClosedTabData
(
window
)
)
;
is
(
entries
[
0
]
.
title
"
new
title
"
"
correct
title
"
)
;
}
)
;
