add_setup
(
async
function
(
)
{
requestLongerTimeout
(
2
)
;
await
forceSaveState
(
)
;
forgetClosedWindows
(
)
;
is
(
ss
.
getClosedWindowCount
(
)
0
"
starting
with
no
closed
windows
"
)
;
}
)
;
add_task
(
async
function
new_window
(
)
{
let
newWin
;
try
{
newWin
=
await
promiseNewWindowLoaded
(
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
newWin
.
gBrowser
"
http
:
/
/
example
.
com
/
browser_625016
.
js
?
"
+
Math
.
random
(
)
)
;
await
promiseBrowserLoaded
(
tab
.
linkedBrowser
)
;
is
(
ss
.
getClosedWindowCount
(
)
0
"
no
closed
windows
on
first
save
"
)
;
await
BrowserTestUtils
.
closeWindow
(
newWin
)
;
newWin
=
null
;
let
state
=
JSON
.
parse
(
await
promiseRecoveryFileContents
(
)
)
;
is
(
state
.
windows
.
length
1
"
observe1
:
1
window
in
data
written
to
disk
"
)
;
is
(
state
.
_closedWindows
.
length
0
"
observe1
:
no
closed
windows
in
data
written
to
disk
"
)
;
is
(
ss
.
getClosedWindowCount
(
)
1
"
observe1
:
1
closed
window
according
to
API
"
)
;
}
finally
{
if
(
newWin
)
{
await
BrowserTestUtils
.
closeWindow
(
newWin
)
;
}
await
forceSaveState
(
)
;
}
}
)
;
add_task
(
async
function
new_tab
(
)
{
let
newTab
;
try
{
newTab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
about
:
mozilla
"
)
;
await
promiseBrowserLoaded
(
newTab
.
linkedBrowser
)
;
await
TabStateFlusher
.
flush
(
newTab
.
linkedBrowser
)
;
let
state
=
JSON
.
parse
(
await
promiseRecoveryFileContents
(
)
)
;
is
(
state
.
windows
.
length
1
"
observe2
:
1
window
in
data
being
written
to
disk
"
)
;
is
(
state
.
_closedWindows
.
length
1
"
observe2
:
1
closed
window
in
data
being
written
to
disk
"
)
;
is
(
ss
.
getClosedWindowCount
(
)
1
"
observe2
:
1
closed
window
according
to
API
"
)
;
}
finally
{
if
(
newTab
)
{
gBrowser
.
removeTab
(
newTab
)
;
}
}
}
)
;
add_task
(
async
function
done
(
)
{
await
promiseAllButPrimaryWindowClosed
(
)
;
forgetClosedWindows
(
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
sessionstore
.
interval
"
)
;
}
)
;
