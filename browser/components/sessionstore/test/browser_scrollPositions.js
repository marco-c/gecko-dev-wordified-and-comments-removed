"
use
strict
"
;
const
BASE
=
"
http
:
/
/
example
.
com
/
browser
/
browser
/
components
/
sessionstore
/
test
/
"
;
const
URL
=
BASE
+
"
browser_scrollPositions_sample
.
html
"
;
const
URL2
=
BASE
+
"
browser_scrollPositions_sample2
.
html
"
;
const
URL_FRAMESET
=
BASE
+
"
browser_scrollPositions_sample_frameset
.
html
"
;
const
SCROLL_X
=
Math
.
round
(
100
*
(
1
+
Math
.
random
(
)
)
)
;
const
SCROLL_Y
=
Math
.
round
(
200
*
(
1
+
Math
.
random
(
)
)
)
;
const
SCROLL_STR
=
SCROLL_X
+
"
"
+
SCROLL_Y
;
const
SCROLL2_X
=
Math
.
round
(
300
*
(
1
+
Math
.
random
(
)
)
)
;
const
SCROLL2_Y
=
Math
.
round
(
400
*
(
1
+
Math
.
random
(
)
)
)
;
const
SCROLL2_STR
=
SCROLL2_X
+
"
"
+
SCROLL2_Y
;
requestLongerTimeout
(
2
)
;
add_task
(
async
function
test_scroll
(
)
{
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
URL
)
;
let
browser
=
tab
.
linkedBrowser
;
await
promiseBrowserLoaded
(
browser
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
SCROLL_X
y
:
SCROLL_Y
}
)
;
await
checkScroll
(
tab
{
scroll
:
SCROLL_STR
}
"
scroll
is
fine
"
)
;
let
tab2
=
ss
.
duplicateTab
(
window
tab
)
;
let
browser2
=
tab2
.
linkedBrowser
;
await
promiseTabRestored
(
tab2
)
;
let
scroll
=
await
sendMessage
(
browser2
"
ss
-
test
:
getScrollPosition
"
)
;
is
(
JSON
.
stringify
(
scroll
)
JSON
.
stringify
(
{
x
:
SCROLL_X
y
:
SCROLL_Y
}
)
"
scroll
position
has
been
duplicated
correctly
"
)
;
browser2
.
reload
(
)
;
await
promiseBrowserLoaded
(
browser2
)
;
await
checkScroll
(
tab2
{
scroll
:
SCROLL_STR
}
"
reloading
retains
scroll
positions
"
)
;
browser2
.
reloadWithFlags
(
Ci
.
nsIWebNavigation
.
LOAD_FLAGS_BYPASS_CACHE
)
;
await
promiseBrowserLoaded
(
browser2
)
;
await
checkScroll
(
tab2
null
"
force
-
reload
resets
scroll
positions
"
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
0
y
:
0
}
)
;
await
checkScroll
(
tab
null
"
no
scroll
stored
"
)
;
await
promiseRemoveTab
(
tab
)
;
await
promiseRemoveTab
(
tab2
)
;
}
)
;
add_task
(
async
function
test_scroll_nested
(
)
{
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
URL_FRAMESET
)
;
let
browser
=
tab
.
linkedBrowser
;
await
promiseBrowserLoaded
(
browser
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
SCROLL_X
y
:
SCROLL_Y
frame
:
0
}
)
;
await
checkScroll
(
tab
{
children
:
[
{
scroll
:
SCROLL_STR
}
]
}
"
scroll
is
fine
"
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
SCROLL2_X
y
:
SCROLL2_Y
frame
:
1
}
)
;
await
checkScroll
(
tab
{
children
:
[
{
scroll
:
SCROLL_STR
}
{
scroll
:
SCROLL2_STR
}
]
}
"
scroll
is
fine
"
)
;
let
tab2
=
ss
.
duplicateTab
(
window
tab
)
;
let
browser2
=
tab2
.
linkedBrowser
;
await
promiseTabRestored
(
tab2
)
;
let
scroll
=
await
sendMessage
(
browser2
"
ss
-
test
:
getScrollPosition
"
{
frame
:
0
}
)
;
is
(
JSON
.
stringify
(
scroll
)
JSON
.
stringify
(
{
x
:
SCROLL_X
y
:
SCROLL_Y
}
)
"
scroll
position
#
1
has
been
duplicated
correctly
"
)
;
scroll
=
await
sendMessage
(
browser2
"
ss
-
test
:
getScrollPosition
"
{
frame
:
1
}
)
;
is
(
JSON
.
stringify
(
scroll
)
JSON
.
stringify
(
{
x
:
SCROLL2_X
y
:
SCROLL2_Y
}
)
"
scroll
position
#
2
has
been
duplicated
correctly
"
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
0
y
:
0
frame
:
0
}
)
;
await
checkScroll
(
tab
{
children
:
[
null
{
scroll
:
SCROLL2_STR
}
]
}
"
scroll
is
fine
"
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
0
y
:
0
frame
:
1
}
)
;
await
checkScroll
(
tab
null
"
no
scroll
stored
"
)
;
await
promiseRemoveTab
(
tab
)
;
await
promiseRemoveTab
(
tab2
)
;
}
)
;
add_task
(
async
function
test_scroll_background_tabs
(
)
{
pushPrefs
(
[
"
browser
.
sessionstore
.
restore_on_demand
"
true
]
)
;
let
newWin
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
let
tab
=
newWin
.
gBrowser
.
addTab
(
URL
)
;
let
browser
=
tab
.
linkedBrowser
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
SCROLL_X
y
:
SCROLL_Y
}
)
;
await
checkScroll
(
tab
{
scroll
:
SCROLL_STR
}
"
scroll
on
first
page
is
fine
"
)
;
browser
.
loadURI
(
URL2
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
await
sendMessage
(
browser
"
ss
-
test
:
setScrollPosition
"
{
x
:
SCROLL2_X
y
:
SCROLL2_Y
}
)
;
await
checkScroll
(
tab
{
scroll
:
SCROLL2_STR
}
"
scroll
on
second
page
is
fine
"
)
;
await
BrowserTestUtils
.
closeWindow
(
newWin
)
;
await
forceSaveState
(
)
;
newWin
=
ss
.
undoCloseWindow
(
0
)
;
await
BrowserTestUtils
.
waitForEvent
(
newWin
"
SSWindowStateReady
"
)
;
is
(
newWin
.
gBrowser
.
tabs
.
length
2
"
There
should
be
two
tabs
"
)
;
tab
=
newWin
.
gBrowser
.
tabs
[
1
]
;
ok
(
tab
.
hasAttribute
(
"
pending
"
)
"
Tab
should
be
pending
"
)
;
browser
=
tab
.
linkedBrowser
;
await
TabStateFlusher
.
flush
(
browser
)
;
newWin
.
gBrowser
.
selectedTab
=
tab
;
await
promiseTabRestored
(
tab
)
;
await
checkScroll
(
tab
{
scroll
:
SCROLL2_STR
}
"
scroll
is
still
fine
"
)
;
is
(
browser
.
canGoBack
true
"
can
go
back
"
)
;
browser
.
goBack
(
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
await
TabStateFlusher
.
flush
(
browser
)
;
await
checkScroll
(
tab
{
scroll
:
SCROLL_STR
}
"
scroll
is
still
fine
after
navigating
back
"
)
;
await
BrowserTestUtils
.
closeWindow
(
newWin
)
;
}
)
;
