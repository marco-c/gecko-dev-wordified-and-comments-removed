"
use
strict
"
;
Cu
.
import
(
"
resource
:
/
/
/
modules
/
sessionstore
/
SessionStore
.
jsm
"
)
;
async
function
openAndCloseTab
(
window
userContextId
url
)
{
let
tab
=
window
.
gBrowser
.
addTab
(
url
{
userContextId
}
)
;
await
promiseBrowserLoaded
(
tab
.
linkedBrowser
true
url
)
;
await
TabStateFlusher
.
flush
(
tab
.
linkedBrowser
)
;
await
promiseRemoveTab
(
tab
)
;
}
async
function
openTab
(
window
userContextId
url
)
{
let
tab
=
window
.
gBrowser
.
addTab
(
url
{
userContextId
}
)
;
await
promiseBrowserLoaded
(
tab
.
linkedBrowser
true
url
)
;
await
TabStateFlusher
.
flush
(
tab
.
linkedBrowser
)
;
}
async
function
openWindow
(
url
)
{
let
win
=
await
promiseNewWindowLoaded
(
)
;
let
flags
=
Ci
.
nsIWebNavigation
.
LOAD_FLAGS_REPLACE_HISTORY
;
win
.
gBrowser
.
selectedBrowser
.
loadURIWithFlags
(
url
flags
)
;
await
promiseBrowserLoaded
(
win
.
gBrowser
.
selectedBrowser
true
url
)
;
return
win
;
}
add_task
(
function
*
test_undoCloseById
(
)
{
forgetClosedWindows
(
)
;
while
(
SessionStore
.
getClosedTabCount
(
window
)
)
{
SessionStore
.
forgetClosedTab
(
window
0
)
;
}
let
win
=
yield
openWindow
(
"
about
:
robots
"
)
;
yield
openAndCloseTab
(
win
0
"
about
:
mozilla
"
)
;
is
(
SessionStore
.
lastClosedObjectType
"
tab
"
"
The
last
closed
object
is
a
tab
"
)
;
yield
openAndCloseTab
(
win
3
"
about
:
about
"
)
;
is
(
SessionStore
.
lastClosedObjectType
"
tab
"
"
The
last
closed
object
is
a
tab
"
)
;
let
tab
=
SessionStore
.
undoCloseTab
(
win
0
)
;
yield
promiseBrowserLoaded
(
tab
.
linkedBrowser
)
;
is
(
tab
.
linkedBrowser
.
currentURI
.
spec
"
about
:
about
"
"
The
expected
tab
was
re
-
opened
"
)
;
is
(
tab
.
getAttribute
(
"
usercontextid
"
)
3
"
No
userContextId
for
this
tab
"
)
;
yield
openTab
(
win
1
"
about
:
robots
"
)
;
yield
openTab
(
win
1
"
about
:
about
"
)
;
yield
openTab
(
win
2
"
about
:
profiles
"
)
;
ContextualIdentityService
.
closeContainerTabs
(
)
;
ContextualIdentityService
.
disableContainers
(
)
;
for
(
let
i
=
0
;
i
<
win
.
gBrowser
.
tabContainer
.
childNodes
.
length
;
+
+
i
)
{
let
tab
=
win
.
gBrowser
.
tabContainer
.
childNodes
[
i
]
;
ok
(
!
tab
.
hasAttribute
(
"
usercontextid
"
)
"
No
userContextId
for
this
tab
"
)
;
}
tab
=
SessionStore
.
undoCloseTab
(
win
0
)
;
yield
promiseBrowserLoaded
(
tab
.
linkedBrowser
)
;
is
(
tab
.
linkedBrowser
.
currentURI
.
spec
"
about
:
mozilla
"
"
The
expected
tab
was
re
-
opened
"
)
;
ok
(
!
tab
.
hasAttribute
(
"
usercontextid
"
)
"
No
userContextId
for
this
tab
"
)
;
yield
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
