const
PREF
=
"
browser
.
sessionstore
.
restore_on_demand
"
;
add_task
(
async
function
test
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF
true
)
;
registerCleanupFunction
(
(
)
=
>
Services
.
prefs
.
clearUserPref
(
PREF
)
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
about
:
robots
"
)
;
await
promiseBrowserLoaded
(
tab
.
linkedBrowser
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
gBrowser
.
getIcon
(
tab
)
!
=
null
;
}
"
wait
for
favicon
load
to
finish
"
100
5
)
;
ok
(
tab
.
hasAttribute
(
"
image
"
)
"
tab
.
image
exists
"
)
;
tab
.
toggleMuteAudio
(
)
;
ok
(
tab
.
hasAttribute
(
"
muted
"
)
"
tab
.
muted
exists
"
)
;
let
{
attributes
}
=
JSON
.
parse
(
ss
.
getTabState
(
tab
)
)
;
ok
(
!
(
"
image
"
in
attributes
)
"
'
image
'
attribute
not
saved
"
)
;
ok
(
!
(
"
muted
"
in
attributes
)
"
'
muted
'
attribute
not
saved
"
)
;
ok
(
!
(
"
customizemode
"
in
attributes
)
"
'
customizemode
'
attribute
not
saved
"
)
;
{
let
customizationReady
=
BrowserTestUtils
.
waitForEvent
(
gNavToolbox
"
customizationready
"
)
;
gCustomizeMode
.
enter
(
)
;
await
customizationReady
;
}
let
customizeIcon
=
gBrowser
.
getIcon
(
gBrowser
.
selectedTab
)
;
(
{
attributes
}
=
JSON
.
parse
(
ss
.
getTabState
(
gBrowser
.
selectedTab
)
)
)
;
ok
(
!
(
"
image
"
in
attributes
)
"
'
image
'
attribute
not
saved
"
)
;
is
(
attributes
.
customizemode
"
true
"
"
'
customizemode
'
attribute
is
correct
"
)
;
{
let
afterCustomization
=
BrowserTestUtils
.
waitForEvent
(
gNavToolbox
"
aftercustomization
"
)
;
gCustomizeMode
.
exit
(
)
;
await
afterCustomization
;
}
let
state
=
{
entries
:
[
]
attributes
:
{
customizemode
:
"
true
"
nonpersisted
:
"
true
"
}
}
;
let
principal
=
Services
.
scriptSecurityManager
.
createNullPrincipal
(
{
}
)
;
tab
.
linkedBrowser
.
createAboutBlankDocumentViewer
(
principal
principal
)
;
let
promise
=
promiseTabRestoring
(
tab
)
;
ss
.
setTabState
(
tab
JSON
.
stringify
(
state
)
)
;
await
promise
;
ok
(
tab
.
hasAttribute
(
"
pending
"
)
"
tab
is
pending
"
)
;
ok
(
tab
.
hasAttribute
(
"
customizemode
"
)
"
tab
is
in
customizemode
"
)
;
ok
(
!
tab
.
hasAttribute
(
"
nonpersisted
"
)
"
tab
has
no
nonpersisted
attribute
"
)
;
is
(
gBrowser
.
getIcon
(
tab
)
customizeIcon
"
tab
has
correct
icon
"
)
;
ok
(
!
state
.
attributes
.
image
"
'
image
'
attribute
not
saved
"
)
;
gBrowser
.
selectedTab
=
tab
;
(
{
attributes
}
=
JSON
.
parse
(
ss
.
getTabState
(
tab
)
)
)
;
ok
(
!
(
"
image
"
in
attributes
)
"
'
image
'
attribute
not
saved
"
)
;
ok
(
!
(
"
pending
"
in
attributes
)
"
'
pending
'
attribute
not
saved
"
)
;
ok
(
!
(
"
nonpersisted
"
in
attributes
)
"
'
nonpersisted
'
attribute
not
saved
"
)
;
is
(
attributes
.
customizemode
"
true
"
"
'
customizemode
'
attribute
is
correct
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
