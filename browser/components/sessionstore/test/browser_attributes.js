const
PREF
=
"
browser
.
sessionstore
.
restore_on_demand
"
;
add_task
(
async
function
test
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF
true
)
;
registerCleanupFunction
(
(
)
=
>
Services
.
prefs
.
clearUserPref
(
PREF
)
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
about
:
robots
"
)
;
await
promiseBrowserLoaded
(
tab
.
linkedBrowser
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
gBrowser
.
getIcon
(
tab
)
!
=
null
;
}
"
wait
for
favicon
load
to
finish
"
100
5
)
;
ok
(
tab
.
hasAttribute
(
"
image
"
)
"
tab
.
image
exists
"
)
;
tab
.
toggleMuteAudio
(
)
;
ok
(
tab
.
hasAttribute
(
"
muted
"
)
"
tab
.
muted
exists
"
)
;
ss
.
persistTabAttribute
(
"
image
"
)
;
ss
.
persistTabAttribute
(
"
muted
"
)
;
let
{
attributes
}
=
JSON
.
parse
(
ss
.
getTabState
(
tab
)
)
;
ok
(
!
(
"
image
"
in
attributes
)
"
'
image
'
attribute
not
saved
"
)
;
ok
(
!
(
"
muted
"
in
attributes
)
"
'
muted
'
attribute
not
saved
"
)
;
ok
(
!
(
"
custom
"
in
attributes
)
"
'
custom
'
attribute
not
saved
"
)
;
tab
.
setAttribute
(
"
custom
"
"
foobar
"
)
;
ss
.
persistTabAttribute
(
"
custom
"
)
;
(
{
attributes
}
=
JSON
.
parse
(
ss
.
getTabState
(
tab
)
)
)
;
is
(
attributes
.
custom
"
foobar
"
"
'
custom
'
attribute
is
correct
"
)
;
let
state
=
{
entries
:
[
{
url
:
"
about
:
mozilla
"
triggeringPrincipal_base64
}
]
attributes
:
{
custom
:
"
foobaz
"
}
image
:
gBrowser
.
getIcon
(
tab
)
}
;
let
promise
=
promiseTabRestoring
(
tab
)
;
ss
.
setTabState
(
tab
JSON
.
stringify
(
state
)
)
;
await
promise
;
ok
(
tab
.
hasAttribute
(
"
pending
"
)
"
tab
is
pending
"
)
;
is
(
gBrowser
.
getIcon
(
tab
)
state
.
image
"
tab
has
correct
icon
"
)
;
ok
(
!
state
.
attributes
.
image
"
'
image
'
attribute
not
saved
"
)
;
gBrowser
.
selectedTab
=
tab
;
await
promiseTabRestored
(
tab
)
;
(
{
attributes
}
=
JSON
.
parse
(
ss
.
getTabState
(
tab
)
)
)
;
ok
(
!
(
"
image
"
in
attributes
)
"
'
image
'
attribute
not
saved
"
)
;
ok
(
!
(
"
pending
"
in
attributes
)
"
'
pending
'
attribute
not
saved
"
)
;
is
(
attributes
.
custom
"
foobaz
"
"
'
custom
'
attribute
is
correct
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
