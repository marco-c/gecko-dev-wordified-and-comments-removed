"
use
strict
"
;
const
MAX_EXPIRY
=
Math
.
pow
(
2
62
)
;
function
addCookie
(
scheme
secure
=
false
)
{
let
cookie
=
createTestCookie
(
"
http
"
secure
)
;
Services
.
cookies
.
add
(
cookie
.
host
cookie
.
path
cookie
.
name
cookie
.
value
cookie
.
secure
false
true
MAX_EXPIRY
{
}
Ci
.
nsICookie
.
SAMESITE_NONE
)
;
return
cookie
;
}
function
createTestCookie
(
scheme
secure
=
false
)
{
let
r
=
Math
.
round
(
Math
.
random
(
)
*
100000
)
;
let
cookie
=
{
host
:
{
scheme
}
:
/
/
example
.
com
path
:
"
/
"
name
:
name
{
r
}
value
:
value
{
r
}
secure
}
;
return
cookie
;
}
function
getCookie
(
)
{
let
state
=
JSON
.
parse
(
ss
.
getBrowserState
(
)
)
;
let
cookies
=
state
.
cookies
|
|
[
]
;
return
cookies
[
0
]
;
}
function
compareCookies
(
a
)
{
let
b
=
getCookie
(
)
;
return
a
.
host
=
=
b
.
host
&
&
a
.
name
=
=
b
.
name
&
&
a
.
value
=
=
b
.
value
;
}
add_task
(
async
function
test_setup
(
)
{
Services
.
prefs
.
clearUserPref
(
"
browser
.
sessionstore
.
privacy_level
"
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
browser
.
sessionstore
.
privacy_level
"
)
;
Services
.
cookies
.
removeAll
(
)
;
}
)
;
}
)
;
add_task
(
async
function
test_level_none
(
)
{
Services
.
cookies
.
removeAll
(
)
;
Services
.
prefs
.
setIntPref
(
"
browser
.
sessionstore
.
privacy_level
"
0
)
;
ok
(
compareCookies
(
addCookie
(
"
http
"
)
)
"
non
-
secure
http
cookie
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
ok
(
compareCookies
(
addCookie
(
"
https
"
)
)
"
non
-
secure
https
cookie
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
ok
(
compareCookies
(
addCookie
(
"
https
"
true
)
)
"
secure
https
cookie
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
}
)
;
add_task
(
async
function
test_level_encrypted
(
)
{
Services
.
cookies
.
removeAll
(
)
;
Services
.
prefs
.
setIntPref
(
"
browser
.
sessionstore
.
privacy_level
"
1
)
;
ok
(
compareCookies
(
addCookie
(
"
http
"
)
)
"
non
-
secure
http
cookie
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
ok
(
compareCookies
(
addCookie
(
"
https
"
)
)
"
non
-
secure
https
cookie
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
ok
(
addCookie
(
"
https
"
true
)
&
&
!
getCookie
(
)
"
secure
https
cookie
not
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
}
)
;
add_task
(
async
function
test_level_full
(
)
{
Services
.
cookies
.
removeAll
(
)
;
Services
.
prefs
.
setIntPref
(
"
browser
.
sessionstore
.
privacy_level
"
2
)
;
ok
(
addCookie
(
"
http
"
)
&
&
!
getCookie
(
)
"
non
-
secure
http
cookie
not
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
ok
(
addCookie
(
"
https
"
)
&
&
!
getCookie
(
)
"
non
-
secure
https
cookie
not
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
ok
(
addCookie
(
"
https
"
true
)
&
&
!
getCookie
(
)
"
secure
https
cookie
not
stored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
}
)
;
