XPCOMUtils
.
defineLazyModuleGetters
(
this
{
UrlbarTestUtils
:
"
resource
:
/
/
testing
-
common
/
UrlbarTestUtils
.
jsm
"
UrlbarUtils
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
}
)
;
UrlbarTestUtils
.
init
(
this
)
;
add_task
(
async
function
test
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
"
true
]
[
"
browser
.
urlbar
.
update2
.
oneOffsRefresh
"
true
]
]
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
"
test
"
}
)
;
await
UrlbarTestUtils
.
enterSearchMode
(
window
{
source
:
UrlbarUtils
.
RESULT_SOURCE
.
HISTORY
}
)
;
let
state
=
JSON
.
parse
(
ss
.
getTabState
(
gBrowser
.
selectedTab
)
)
;
Assert
.
ok
(
"
searchMode
"
in
state
"
state
.
searchMode
is
present
after
entering
search
mode
"
)
;
Assert
.
deepEqual
(
state
.
searchMode
{
source
:
UrlbarUtils
.
RESULT_SOURCE
.
HISTORY
entry
:
"
oneoff
"
isPreview
:
false
}
"
state
.
searchMode
is
correct
"
)
;
await
UrlbarTestUtils
.
exitSearchMode
(
window
)
;
let
newState
=
JSON
.
parse
(
ss
.
getTabState
(
gBrowser
.
selectedTab
)
)
;
Assert
.
ok
(
!
newState
.
searchMode
"
state
.
searchMode
is
not
present
after
exiting
search
mode
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
