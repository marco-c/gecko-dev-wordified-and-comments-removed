add_task
(
async
function
test_label_and_icon
(
)
{
let
helper
=
Cc
[
"
mozilla
.
org
/
network
/
serialization
-
helper
;
1
"
]
.
getService
(
Ci
.
nsISerializationHelper
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
sessionstore
.
restore_on_demand
"
true
]
]
}
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
http
:
/
/
www
.
example
.
com
/
browser
/
browser
/
components
/
sessionstore
/
test
/
empty
.
html
"
)
;
let
browser
=
tab
.
linkedBrowser
;
await
promiseBrowserLoaded
(
browser
)
;
let
contentPrincipal
=
browser
.
contentPrincipal
;
let
serializedPrincipal
=
helper
.
serializeToString
(
contentPrincipal
)
;
await
TabStateFlusher
.
flush
(
browser
)
;
let
state
=
JSON
.
parse
(
ss
.
getTabState
(
tab
)
)
;
state
.
image
=
"
http
:
/
/
www
.
example
.
com
/
favicon
.
ico
"
;
state
.
iconLoadingPrincipal
=
serializedPrincipal
;
BrowserTestUtils
.
removeTab
(
tab
)
;
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
about
:
blank
"
)
;
ss
.
setTabState
(
tab
state
)
;
await
promiseTabRestoring
(
tab
)
;
is
(
gBrowser
.
getIcon
(
tab
)
"
http
:
/
/
www
.
example
.
com
/
favicon
.
ico
"
"
icon
is
set
"
)
;
is
(
tab
.
getAttribute
(
"
image
"
)
"
http
:
/
/
www
.
example
.
com
/
favicon
.
ico
"
"
tab
image
is
set
"
)
;
is
(
tab
.
getAttribute
(
"
iconloadingprincipal
"
)
serializedPrincipal
"
tab
image
loading
principal
is
set
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
