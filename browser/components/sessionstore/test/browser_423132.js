"
use
strict
"
;
add_task
(
async
function
(
)
{
const
testURL
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
"
+
"
browser
/
components
/
sessionstore
/
test
/
browser_423132_sample
.
html
"
;
Services
.
cookies
.
removeAll
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
sessionstore
.
interval
"
0
]
]
}
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
testURL
)
;
await
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
await
TabStateFlusher
.
flush
(
tab
.
linkedBrowser
)
;
let
state
=
ss
.
getBrowserState
(
)
;
let
enumerator
=
Services
.
cookies
.
enumerator
;
let
cookie
;
let
i
=
0
;
while
(
enumerator
.
hasMoreElements
(
)
)
{
cookie
=
enumerator
.
getNext
(
)
.
QueryInterface
(
Ci
.
nsICookie
)
;
i
+
+
;
}
Assert
.
equal
(
i
1
"
expected
one
cookie
"
)
;
Services
.
cookies
.
removeAll
(
)
;
ss
.
setBrowserState
(
state
)
;
await
promiseWindowRestored
(
window
)
;
enumerator
=
Services
.
cookies
.
enumerator
;
let
cookie2
;
while
(
enumerator
.
hasMoreElements
(
)
)
{
cookie2
=
enumerator
.
getNext
(
)
.
QueryInterface
(
Ci
.
nsICookie
)
;
if
(
cookie
.
name
=
=
cookie2
.
name
)
break
;
}
is
(
cookie
.
name
cookie2
.
name
"
cookie
name
successfully
restored
"
)
;
is
(
cookie
.
value
cookie2
.
value
"
cookie
value
successfully
restored
"
)
;
is
(
cookie
.
path
cookie2
.
path
"
cookie
path
successfully
restored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
await
promiseRemoveTab
(
gBrowser
.
tabs
[
1
]
)
;
}
)
;
