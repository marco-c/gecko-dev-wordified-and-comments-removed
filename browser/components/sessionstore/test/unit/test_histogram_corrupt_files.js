"
use
strict
"
;
const
Telemetry
=
Services
.
telemetry
;
const
HistogramId
=
"
FX_SESSION_RESTORE_ALL_FILES_CORRUPT
"
;
do_get_profile
(
)
;
const
{
SessionFile
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
sessionstore
/
SessionFile
.
jsm
"
)
;
function
promise_reset_session
(
backups
=
{
}
)
{
return
(
async
function
(
)
{
Telemetry
.
getHistogramById
(
HistogramId
)
.
clear
(
)
;
await
IOUtils
.
makeDirectory
(
SessionFile
.
Paths
.
backups
)
;
let
basePath
=
do_get_cwd
(
)
.
path
;
for
(
let
key
of
SessionFile
.
Paths
.
loadOrder
)
{
if
(
backups
.
hasOwnProperty
(
key
)
)
{
let
path
=
backups
[
key
]
;
const
fullPath
=
PathUtils
.
join
(
basePath
.
.
.
path
)
;
let
s
=
await
IOUtils
.
read
(
fullPath
)
;
await
IOUtils
.
write
(
SessionFile
.
Paths
[
key
]
s
{
compress
:
true
}
)
;
}
else
{
await
IOUtils
.
remove
(
SessionFile
.
Paths
[
key
]
)
;
}
}
}
)
(
)
;
}
add_task
(
async
function
test_ensure_histogram_exists_and_empty
(
)
{
let
s
=
Telemetry
.
getHistogramById
(
HistogramId
)
.
snapshot
(
)
;
Assert
.
equal
(
s
.
sum
0
"
Initially
the
sum
of
probes
is
0
"
)
;
}
)
;
add_task
(
async
function
test_no_files_exist
(
)
{
await
promise_reset_session
(
)
;
await
SessionFile
.
read
(
)
;
let
h
=
Telemetry
.
getHistogramById
(
HistogramId
)
;
let
s
=
h
.
snapshot
(
)
;
Assert
.
equal
(
s
.
values
[
0
]
1
"
One
probe
for
the
'
false
'
bucket
.
"
)
;
Assert
.
equal
(
s
.
values
[
1
]
0
"
No
probes
in
the
'
true
'
bucket
.
"
)
;
}
)
;
add_task
(
async
function
test_one_file_valid
(
)
{
let
invalidSession
=
[
"
data
"
"
sessionstore_invalid
.
js
"
]
;
let
validSession
=
[
"
data
"
"
sessionstore_valid
.
js
"
]
;
await
promise_reset_session
(
{
clean
:
invalidSession
cleanBackup
:
validSession
recovery
:
invalidSession
recoveryBackup
:
invalidSession
}
)
;
await
SessionFile
.
read
(
)
;
let
h
=
Telemetry
.
getHistogramById
(
HistogramId
)
;
let
s
=
h
.
snapshot
(
)
;
Assert
.
equal
(
s
.
values
[
0
]
1
"
One
probe
for
the
'
false
'
bucket
.
"
)
;
Assert
.
equal
(
s
.
values
[
1
]
0
"
No
probes
in
the
'
true
'
bucket
.
"
)
;
}
)
;
add_task
(
async
function
test_all_files_corrupt
(
)
{
let
invalidSession
=
[
"
data
"
"
sessionstore_invalid
.
js
"
]
;
await
promise_reset_session
(
{
clean
:
invalidSession
cleanBackup
:
invalidSession
recovery
:
invalidSession
recoveryBackup
:
invalidSession
}
)
;
await
SessionFile
.
read
(
)
;
let
h
=
Telemetry
.
getHistogramById
(
HistogramId
)
;
let
s
=
h
.
snapshot
(
)
;
Assert
.
equal
(
s
.
values
[
1
]
1
"
One
probe
for
the
'
true
'
bucket
.
"
)
;
Assert
.
equal
(
s
.
values
[
0
]
0
"
No
probes
in
the
'
false
'
bucket
.
"
)
;
}
)
;
