"
use
strict
"
;
const
TEST_HTTP_URL
=
"
http
:
/
/
example
.
com
"
;
const
TEST_HTTPS_URL
=
"
https
:
/
/
example
.
com
"
;
const
MAX_EXPIRY
=
Math
.
pow
(
2
62
)
;
function
getSingleCookie
(
)
{
let
cookies
=
Array
.
from
(
Services
.
cookies
.
cookies
)
;
Assert
.
equal
(
cookies
.
length
1
"
expected
one
cookie
"
)
;
return
cookies
[
0
]
;
}
async
function
verifyRestore
(
url
sameSiteSetting
)
{
Services
.
cookies
.
removeAll
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
sessionstore
.
interval
"
0
]
]
}
)
;
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
let
r
=
Math
.
floor
(
Math
.
random
(
)
*
MAX_EXPIRY
)
;
Services
.
cookies
.
add
(
url
"
/
"
"
name
"
+
r
"
value
"
+
r
false
false
true
MAX_EXPIRY
{
}
sameSiteSetting
url
.
startsWith
(
"
https
:
"
)
?
Ci
.
nsICookie
.
SCHEME_HTTPS
:
Ci
.
nsICookie
.
SCHEME_HTTP
)
;
await
TabStateFlusher
.
flush
(
tab
.
linkedBrowser
)
;
let
state
=
ss
.
getBrowserState
(
)
;
let
cookie
=
getSingleCookie
(
)
;
Services
.
cookies
.
removeAll
(
)
;
await
setBrowserState
(
state
)
;
let
cookie2
=
getSingleCookie
(
)
;
is
(
cookie2
.
sameSite
cookie
.
sameSite
"
cookie
same
-
site
flag
successfully
restored
"
)
;
is
(
cookie2
.
schemeMap
cookie
.
schemeMap
"
cookie
schemeMap
flag
successfully
restored
"
)
;
Services
.
cookies
.
removeAll
(
)
;
BrowserTestUtils
.
removeTab
(
gBrowser
.
tabs
[
1
]
)
;
}
add_task
(
async
function
(
)
{
await
verifyRestore
(
TEST_HTTP_URL
Ci
.
nsICookie
.
SAMESITE_NONE
)
;
await
verifyRestore
(
TEST_HTTP_URL
Ci
.
nsICookie
.
SAMESITE_LAX
)
;
await
verifyRestore
(
TEST_HTTP_URL
Ci
.
nsICookie
.
SAMESITE_STRICT
)
;
await
verifyRestore
(
TEST_HTTPS_URL
Ci
.
nsICookie
.
SAMESITE_NONE
)
;
await
verifyRestore
(
TEST_HTTPS_URL
Ci
.
nsICookie
.
SAMESITE_LAX
)
;
await
verifyRestore
(
TEST_HTTPS_URL
Ci
.
nsICookie
.
SAMESITE_STRICT
)
;
}
)
;
