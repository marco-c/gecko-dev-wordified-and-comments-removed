var
EXPORTED_SYMBOLS
=
[
"
WindowsSupport
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
SiteSpecificBrowserService
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
SiteSpecificBrowserService
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
OS
:
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
ImageTools
:
"
resource
:
/
/
/
modules
/
ssb
/
ImageTools
.
jsm
"
}
)
;
const
shellService
=
Cc
[
"
mozilla
.
org
/
browser
/
shell
-
service
;
1
"
]
.
getService
(
Ci
.
nsIWindowsShellService
)
;
const
uiUtils
=
Cc
[
"
mozilla
.
org
/
windows
-
ui
-
utils
;
1
"
]
.
getService
(
Ci
.
nsIWindowsUIUtils
)
;
const
File
=
Components
.
Constructor
(
"
mozilla
.
org
/
file
/
local
;
1
"
Ci
.
nsIFile
"
initWithPath
"
)
;
const
WindowsSupport
=
{
async
install
(
ssb
)
{
if
(
!
SiteSpecificBrowserService
.
useOSIntegration
)
{
return
;
}
let
desktop
=
Services
.
dirsvc
.
get
(
"
Desk
"
Ci
.
nsIFile
)
;
let
link
=
OS
.
Path
.
join
(
desktop
.
path
{
ssb
.
name
}
.
lnk
)
;
shellService
.
createShortcut
(
Services
.
dirsvc
.
get
(
"
XREExeF
"
Ci
.
nsIFile
)
[
"
-
profile
"
OS
.
Constants
.
Path
.
profileDir
"
-
start
-
ssb
"
ssb
.
id
]
ssb
.
name
new
File
(
link
)
)
;
}
async
uninstall
(
ssb
)
{
if
(
!
SiteSpecificBrowserService
.
useOSIntegration
)
{
return
;
}
let
desktop
=
Services
.
dirsvc
.
get
(
"
Desk
"
Ci
.
nsIFile
)
;
let
link
=
OS
.
Path
.
join
(
desktop
.
path
{
ssb
.
name
}
.
lnk
)
;
try
{
await
OS
.
File
.
remove
(
link
)
;
}
catch
(
e
)
{
console
.
error
(
e
)
;
}
}
async
applyOSIntegration
(
ssb
window
)
{
const
getIcon
=
async
size
=
>
{
let
icon
=
ssb
.
getIcon
(
size
)
;
if
(
!
icon
)
{
return
null
;
}
try
{
let
image
=
await
ImageTools
.
loadImage
(
Services
.
io
.
newURI
(
icon
.
src
)
)
;
return
image
.
container
;
}
catch
(
e
)
{
console
.
error
(
e
)
;
return
null
;
}
}
;
if
(
!
SiteSpecificBrowserService
.
useOSIntegration
)
{
return
;
}
let
icons
=
await
Promise
.
all
(
[
getIcon
(
uiUtils
.
systemSmallIconSize
)
getIcon
(
uiUtils
.
systemLargeIconSize
)
]
)
;
if
(
icons
[
0
]
|
|
icons
[
1
]
)
{
uiUtils
.
setWindowIcon
(
window
icons
[
0
]
icons
[
1
]
)
;
}
}
}
;
