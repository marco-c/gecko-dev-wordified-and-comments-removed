"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
UrlbarPrefs
"
"
UrlbarPrefsObserver
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
NimbusFeatures
:
"
resource
:
/
/
nimbus
/
ExperimentAPI
.
jsm
"
Region
:
"
resource
:
/
/
gre
/
modules
/
Region
.
jsm
"
UrlbarUtils
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
}
)
;
const
PREF_URLBAR_BRANCH
=
"
browser
.
urlbar
.
"
;
const
FIREFOX_SUGGEST_UPDATE_TOPIC
=
"
firefox
-
suggest
-
update
"
;
const
FIREFOX_SUGGEST_UPDATE_SKIPPED_TOPIC
=
"
firefox
-
suggest
-
update
-
skipped
"
;
const
PREF_URLBAR_DEFAULTS
=
new
Map
(
[
[
"
accessibility
.
tabToSearch
.
announceResults
"
true
]
[
"
autoFill
"
true
]
[
"
autoFill
.
searchEngines
"
false
]
[
"
autoFill
.
stddevMultiplier
"
[
0
.
0
"
float
"
]
]
[
"
bestMatch
.
blockingEnabled
"
false
]
[
"
bestMatch
.
enabled
"
true
]
[
"
ctrlCanonizesURLs
"
true
]
[
"
decodeURLsOnCopy
"
false
]
[
"
delay
"
50
]
[
"
disableExtendForTests
"
false
]
[
"
dnsResolveFullyQualifiedNames
"
true
]
[
"
dnsResolveSingleWordsAfterSearch
"
1
]
[
"
eventTelemetry
.
enabled
"
false
]
[
"
experimental
.
expandTextOnFocus
"
false
]
[
"
experimental
.
hideHeuristic
"
false
]
[
"
experimental
.
searchButton
"
false
]
[
"
extension
.
timeout
"
400
]
[
"
filter
.
javascript
"
true
]
[
"
formatting
.
enabled
"
true
]
[
"
groupLabels
.
enabled
"
true
]
[
"
keepPanelOpenDuringImeComposition
"
false
]
[
"
maxCharsForSearchSuggestions
"
100
]
[
"
maxHistoricalSearchSuggestions
"
0
]
[
"
maxRichResults
"
10
]
[
"
merino
.
clientVariants
"
"
"
]
[
"
merino
.
enabled
"
false
]
[
"
merino
.
endpointURL
"
"
https
:
/
/
merino
.
services
.
mozilla
.
com
/
api
/
v1
/
suggest
"
]
[
"
merino
.
providers
"
"
"
]
[
"
merino
.
timeoutMs
"
200
]
[
"
openintab
"
false
]
[
"
restyleSearches
"
false
]
[
"
resultGroups
"
"
"
]
[
"
richSuggestions
.
tail
"
true
]
[
"
searchTips
.
test
.
ignoreShowLimits
"
false
]
[
"
shortcuts
.
bookmarks
"
true
]
[
"
shortcuts
.
tabs
"
true
]
[
"
shortcuts
.
history
"
true
]
[
"
showSearchSuggestionsFirst
"
true
]
[
"
speculativeConnect
.
enabled
"
true
]
[
"
suggest
.
bestmatch
"
true
]
[
"
suggest
.
bookmark
"
true
]
[
"
suggest
.
calculator
"
false
]
[
"
suggest
.
engines
"
true
]
[
"
suggest
.
history
"
true
]
[
"
suggest
.
openpage
"
true
]
[
"
suggest
.
remotetab
"
true
]
[
"
suggest
.
quicksuggest
.
nonsponsored
"
false
]
[
"
suggest
.
quicksuggest
.
sponsored
"
false
]
[
"
suggest
.
searches
"
false
]
[
"
suggest
.
topsites
"
true
]
[
"
quickSuggest
.
blockedDigests
"
"
"
]
[
"
quicksuggest
.
enabled
"
false
]
[
"
quicksuggest
.
impressionCaps
.
nonSponsoredEnabled
"
false
]
[
"
quicksuggest
.
impressionCaps
.
sponsoredEnabled
"
false
]
[
"
quicksuggest
.
impressionCaps
.
stats
"
"
"
]
[
"
quicksuggest
.
log
"
false
]
[
"
quicksuggest
.
onboardingDialogChoice
"
"
"
]
[
"
quicksuggest
.
migrationVersion
"
0
]
[
"
quicksuggest
.
remoteSettings
.
enabled
"
true
]
[
"
quicksuggest
.
scenario
"
"
"
]
[
"
quicksuggest
.
dataCollection
.
enabled
"
false
]
[
"
quicksuggest
.
onboardingDialogVersion
"
"
"
]
[
"
quicksuggest
.
shouldShowOnboardingDialog
"
true
]
[
"
quicksuggest
.
showedOnboardingDialog
"
false
]
[
"
quicksuggest
.
seenRestarts
"
0
]
[
"
quicksuggest
.
allowPositionInSuggestions
"
true
]
[
"
switchTabs
.
adoptIntoActiveWindow
"
false
]
[
"
tabToSearch
.
onboard
.
interactionsLeft
"
3
]
[
"
tipShownCount
.
searchTip_onboard
"
0
]
[
"
tipShownCount
.
searchTip_redirect
"
0
]
[
"
trimURLs
"
true
]
[
"
sponsoredTopSites
"
false
]
[
"
unitConversion
.
enabled
"
false
]
[
"
unitConversion
.
suggestedIndex
"
1
]
[
"
usepreloadedtopurls
.
enabled
"
false
]
[
"
usepreloadedtopurls
.
expire_days
"
14
]
[
"
update2
.
emptySearchBehavior
"
0
]
]
)
;
const
PREF_OTHER_DEFAULTS
=
new
Map
(
[
[
"
browser
.
fixup
.
dns_first_for_single_words
"
false
]
[
"
browser
.
search
.
suggest
.
enabled
"
true
]
[
"
browser
.
search
.
suggest
.
enabled
.
private
"
false
]
[
"
keyword
.
enabled
"
true
]
[
"
ui
.
popup
.
disable_autohide
"
false
]
]
)
;
const
NIMBUS_DEFAULTS
=
{
experimentType
:
"
"
isBestMatchExperiment
:
false
}
;
const
SUGGEST_PREF_TO_BEHAVIOR
=
{
history
:
"
history
"
bookmark
:
"
bookmark
"
openpage
:
"
openpage
"
searches
:
"
search
"
}
;
const
PREF_TYPES
=
new
Map
(
[
[
"
boolean
"
"
Bool
"
]
[
"
float
"
"
Float
"
]
[
"
number
"
"
Int
"
]
[
"
string
"
"
Char
"
]
]
)
;
function
makeResultGroups
(
{
showSearchSuggestionsFirst
}
)
{
let
rootGroup
=
{
children
:
[
{
maxResultCount
:
1
children
:
[
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_TEST
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_EXTENSION
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_SEARCH_TIP
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_OMNIBOX
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_ENGINE_ALIAS
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_BOOKMARK_KEYWORD
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_AUTOFILL
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_PRELOADED
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_TOKEN_ALIAS_ENGINE
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
HEURISTIC_FALLBACK
}
]
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
OMNIBOX
availableSpan
:
UrlbarUtils
.
MAX_OMNIBOX_RESULT_COUNT
-
1
}
]
}
;
let
mainGroup
=
{
flexChildren
:
true
children
:
[
{
children
:
[
{
flexChildren
:
true
children
:
[
{
flex
:
2
group
:
UrlbarUtils
.
RESULT_GROUP
.
FORM_HISTORY
}
{
flex
:
4
group
:
UrlbarUtils
.
RESULT_GROUP
.
REMOTE_SUGGESTION
}
]
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
TAIL_SUGGESTION
}
]
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
GENERAL_PARENT
children
:
[
{
availableSpan
:
3
group
:
UrlbarUtils
.
RESULT_GROUP
.
INPUT_HISTORY
}
{
flexChildren
:
true
children
:
[
{
flex
:
1
group
:
UrlbarUtils
.
RESULT_GROUP
.
REMOTE_TAB
}
{
flex
:
2
group
:
UrlbarUtils
.
RESULT_GROUP
.
GENERAL
}
{
flex
:
2
group
:
UrlbarUtils
.
RESULT_GROUP
.
ABOUT_PAGES
}
{
flex
:
1
group
:
UrlbarUtils
.
RESULT_GROUP
.
PRELOADED
}
]
}
{
group
:
UrlbarUtils
.
RESULT_GROUP
.
INPUT_HISTORY
}
]
}
]
}
;
if
(
!
showSearchSuggestionsFirst
)
{
mainGroup
.
children
.
reverse
(
)
;
}
mainGroup
.
children
[
0
]
.
flex
=
2
;
mainGroup
.
children
[
1
]
.
flex
=
1
;
rootGroup
.
children
.
push
(
mainGroup
)
;
return
rootGroup
;
}
class
Preferences
{
constructor
(
)
{
this
.
_map
=
new
Map
(
)
;
this
.
QueryInterface
=
ChromeUtils
.
generateQI
(
[
"
nsIObserver
"
"
nsISupportsWeakReference
"
]
)
;
Services
.
prefs
.
addObserver
(
PREF_URLBAR_BRANCH
this
true
)
;
for
(
let
pref
of
PREF_OTHER_DEFAULTS
.
keys
(
)
)
{
Services
.
prefs
.
addObserver
(
pref
this
true
)
;
}
this
.
_observerWeakRefs
=
[
]
;
this
.
addObserver
(
this
)
;
this
.
shouldHandOffToSearchModePrefs
=
[
"
keyword
.
enabled
"
"
suggest
.
searches
"
]
;
this
.
_firefoxSuggestScenarioStartupPromise
=
new
Promise
(
resolve
=
>
(
this
.
_resolveFirefoxSuggestScenarioStartupPromise
=
resolve
)
)
;
this
.
_updatingFirefoxSuggestScenario
=
false
;
NimbusFeatures
.
urlbar
.
onUpdate
(
(
)
=
>
this
.
_onNimbusUpdate
(
)
)
;
}
get
(
pref
)
{
let
value
=
this
.
_map
.
get
(
pref
)
;
if
(
value
=
=
=
undefined
)
{
value
=
this
.
_getPrefValue
(
pref
)
;
this
.
_map
.
set
(
pref
value
)
;
}
return
value
;
}
set
(
pref
value
)
{
let
{
defaultValue
set
}
=
this
.
_getPrefDescriptor
(
pref
)
;
if
(
typeof
value
!
=
typeof
defaultValue
)
{
throw
new
Error
(
Invalid
value
type
{
typeof
value
}
for
pref
{
pref
}
)
;
}
set
(
pref
value
)
;
}
clear
(
pref
)
{
let
{
clear
}
=
this
.
_getPrefDescriptor
(
pref
)
;
clear
(
pref
)
;
}
makeResultGroups
(
options
)
{
return
makeResultGroups
(
options
)
;
}
migrateResultGroups
(
)
{
this
.
set
(
"
resultGroups
"
JSON
.
stringify
(
makeResultGroups
(
{
showSearchSuggestionsFirst
:
this
.
get
(
"
showSearchSuggestionsFirst
"
)
}
)
)
)
;
}
async
updateFirefoxSuggestScenario
(
testOverrides
=
null
)
{
if
(
this
.
_updatingFirefoxSuggestScenario
)
{
return
;
}
let
isStartup
=
!
this
.
_updateFirefoxSuggestScenarioCalled
|
|
!
!
testOverrides
?
.
isStartup
;
this
.
_updateFirefoxSuggestScenarioCalled
=
true
;
try
{
this
.
_updatingFirefoxSuggestScenario
=
true
;
await
Region
.
init
(
)
;
await
NimbusFeatures
.
urlbar
.
ready
(
)
;
this
.
_clearNimbusCache
(
)
;
this
.
_updateFirefoxSuggestScenarioHelper
(
isStartup
testOverrides
)
;
}
finally
{
this
.
_updatingFirefoxSuggestScenario
=
false
;
}
if
(
isStartup
&
&
this
.
_resolveFirefoxSuggestScenarioStartupPromise
)
{
this
.
_resolveFirefoxSuggestScenarioStartupPromise
(
)
;
this
.
_resolveFirefoxSuggestScenarioStartupPromise
=
null
;
}
}
_updateFirefoxSuggestScenarioHelper
(
isStartup
testOverrides
)
{
let
scenario
=
testOverrides
?
.
scenario
|
|
this
.
_getIntendedFirefoxSuggestScenario
(
)
;
let
defaultPrefs
=
testOverrides
?
.
defaultPrefs
|
|
this
.
FIREFOX_SUGGEST_DEFAULT_PREFS
;
let
prefs
=
{
.
.
.
defaultPrefs
[
scenario
]
}
;
for
(
let
[
variable
prefName
]
of
Object
.
entries
(
this
.
FIREFOX_SUGGEST_UI_PREFS_BY_VARIABLE
)
)
{
if
(
this
.
_nimbus
.
hasOwnProperty
(
variable
)
)
{
prefs
[
prefName
]
=
this
.
_nimbus
[
variable
]
;
}
}
let
defaults
=
Services
.
prefs
.
getDefaultBranch
(
"
browser
.
urlbar
.
"
)
;
for
(
let
[
name
value
]
of
Object
.
entries
(
prefs
)
)
{
defaults
.
setBoolPref
(
name
value
)
;
}
if
(
isStartup
)
{
this
.
_ensureFirefoxSuggestPrefsMigrated
(
scenario
testOverrides
)
;
}
this
.
set
(
"
quicksuggest
.
scenario
"
scenario
)
;
Services
.
obs
.
notifyObservers
(
null
FIREFOX_SUGGEST_UPDATE_TOPIC
)
;
}
_getIntendedFirefoxSuggestScenario
(
)
{
let
scenario
=
this
.
_nimbus
.
quickSuggestScenario
;
if
(
!
scenario
)
{
if
(
Region
.
home
=
=
"
US
"
&
&
Services
.
locale
.
appLocaleAsBCP47
.
substring
(
0
2
)
=
=
"
en
"
)
{
scenario
=
"
offline
"
;
}
else
{
scenario
=
"
history
"
;
}
}
if
(
!
this
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
hasOwnProperty
(
scenario
)
)
{
scenario
=
"
history
"
;
Cu
.
reportError
(
Unrecognized
Firefox
Suggest
scenario
"
{
scenario
}
"
)
;
}
return
scenario
;
}
get
FIREFOX_SUGGEST_UI_PREFS_BY_VARIABLE
(
)
{
return
{
quickSuggestNonSponsoredEnabled
:
"
suggest
.
quicksuggest
.
nonsponsored
"
quickSuggestSponsoredEnabled
:
"
suggest
.
quicksuggest
.
sponsored
"
quickSuggestDataCollectionEnabled
:
"
quicksuggest
.
dataCollection
.
enabled
"
}
;
}
get
FIREFOX_SUGGEST_DEFAULT_PREFS
(
)
{
return
{
history
:
{
"
quicksuggest
.
enabled
"
:
false
}
offline
:
{
"
quicksuggest
.
enabled
"
:
true
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
"
quicksuggest
.
shouldShowOnboardingDialog
"
:
false
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
online
:
{
"
quicksuggest
.
enabled
"
:
true
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
"
quicksuggest
.
shouldShowOnboardingDialog
"
:
true
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
;
}
get
FIREFOX_SUGGEST_MIGRATION_VERSION
(
)
{
return
2
;
}
_ensureFirefoxSuggestPrefsMigrated
(
scenario
testOverrides
)
{
let
currentVersion
=
testOverrides
?
.
migrationVersion
!
=
=
undefined
?
testOverrides
.
migrationVersion
:
this
.
FIREFOX_SUGGEST_MIGRATION_VERSION
;
let
lastSeenVersion
=
Math
.
max
(
0
this
.
get
(
"
quicksuggest
.
migrationVersion
"
)
)
;
if
(
currentVersion
<
=
lastSeenVersion
)
{
return
;
}
let
version
=
lastSeenVersion
;
if
(
!
version
&
&
scenario
=
=
"
online
"
&
&
2
<
=
currentVersion
)
{
this
.
_migrateFirefoxSuggestPrefsUnversionedTo2Online
(
)
;
version
=
2
;
}
for
(
;
version
<
currentVersion
;
version
+
+
)
{
let
nextVersion
=
version
+
1
;
let
methodName
=
"
_migrateFirefoxSuggestPrefsTo_
"
+
nextVersion
;
try
{
this
[
methodName
]
(
scenario
)
;
}
catch
(
error
)
{
Cu
.
reportError
(
Error
migrating
Firefox
Suggest
prefs
to
version
{
nextVersion
}
:
+
error
)
;
break
;
}
}
this
.
set
(
"
quicksuggest
.
migrationVersion
"
version
)
;
}
_migrateFirefoxSuggestPrefsUnversionedTo2Online
(
)
{
let
mainPref
=
"
browser
.
urlbar
.
suggest
.
quicksuggest
"
;
let
mainPrefHasUserValue
=
Services
.
prefs
.
prefHasUserValue
(
mainPref
)
;
if
(
mainPrefHasUserValue
)
{
this
.
set
(
"
suggest
.
quicksuggest
.
nonsponsored
"
Services
.
prefs
.
getBoolPref
(
mainPref
)
)
;
Services
.
prefs
.
clearUserPref
(
mainPref
)
;
}
if
(
!
this
.
get
(
"
quicksuggest
.
showedOnboardingDialog
"
)
)
{
if
(
mainPrefHasUserValue
&
&
!
this
.
get
(
"
suggest
.
quicksuggest
.
nonsponsored
"
)
)
{
this
.
set
(
"
suggest
.
quicksuggest
.
sponsored
"
false
)
;
}
return
;
}
if
(
mainPrefHasUserValue
&
&
this
.
get
(
"
suggest
.
quicksuggest
.
nonsponsored
"
)
)
{
this
.
set
(
"
quicksuggest
.
dataCollection
.
enabled
"
true
)
;
if
(
!
Services
.
prefs
.
prefHasUserValue
(
"
browser
.
urlbar
.
suggest
.
quicksuggest
.
sponsored
"
)
)
{
this
.
set
(
"
suggest
.
quicksuggest
.
sponsored
"
false
)
;
}
}
else
{
this
.
set
(
"
suggest
.
quicksuggest
.
nonsponsored
"
false
)
;
this
.
set
(
"
suggest
.
quicksuggest
.
sponsored
"
false
)
;
this
.
set
(
"
quicksuggest
.
dataCollection
.
enabled
"
false
)
;
}
}
_migrateFirefoxSuggestPrefsTo_1
(
scenario
)
{
let
suggestQuicksuggest
=
"
browser
.
urlbar
.
suggest
.
quicksuggest
"
;
if
(
Services
.
prefs
.
prefHasUserValue
(
suggestQuicksuggest
)
)
{
this
.
set
(
"
suggest
.
quicksuggest
.
nonsponsored
"
Services
.
prefs
.
getBoolPref
(
suggestQuicksuggest
)
)
;
Services
.
prefs
.
clearUserPref
(
suggestQuicksuggest
)
;
}
if
(
!
this
.
get
(
"
suggest
.
quicksuggest
.
nonsponsored
"
)
)
{
switch
(
scenario
)
{
case
"
offline
"
:
this
.
set
(
"
suggest
.
quicksuggest
.
sponsored
"
false
)
;
break
;
case
"
online
"
:
if
(
this
.
get
(
"
suggest
.
quicksuggest
.
sponsored
"
)
)
{
this
.
clear
(
"
suggest
.
quicksuggest
.
sponsored
"
)
;
}
break
;
}
}
if
(
scenario
=
=
"
online
"
&
&
this
.
get
(
"
suggest
.
quicksuggest
.
nonsponsored
"
)
)
{
this
.
set
(
"
quicksuggest
.
dataCollection
.
enabled
"
true
)
;
}
}
_migrateFirefoxSuggestPrefsTo_2
(
scenario
)
{
if
(
this
.
get
(
"
quicksuggest
.
scenario
"
)
=
=
"
online
"
)
{
if
(
!
Services
.
prefs
.
prefHasUserValue
(
"
browser
.
urlbar
.
suggest
.
quicksuggest
.
nonsponsored
"
)
)
{
this
.
set
(
"
suggest
.
quicksuggest
.
nonsponsored
"
false
)
;
}
if
(
!
Services
.
prefs
.
prefHasUserValue
(
"
browser
.
urlbar
.
suggest
.
quicksuggest
.
sponsored
"
)
)
{
this
.
set
(
"
suggest
.
quicksuggest
.
sponsored
"
false
)
;
}
}
}
get
firefoxSuggestScenarioStartupPromise
(
)
{
return
this
.
_firefoxSuggestScenarioStartupPromise
;
}
get
updatingFirefoxSuggestScenario
(
)
{
return
this
.
_updatingFirefoxSuggestScenario
;
}
addObserver
(
observer
)
{
this
.
_observerWeakRefs
.
push
(
Cu
.
getWeakReference
(
observer
)
)
;
}
observe
(
subject
topic
data
)
{
let
pref
=
data
.
replace
(
PREF_URLBAR_BRANCH
"
"
)
;
if
(
!
PREF_URLBAR_DEFAULTS
.
has
(
pref
)
&
&
!
PREF_OTHER_DEFAULTS
.
has
(
pref
)
)
{
return
;
}
for
(
let
i
=
0
;
i
<
this
.
_observerWeakRefs
.
length
;
)
{
let
observer
=
this
.
_observerWeakRefs
[
i
]
.
get
(
)
;
if
(
!
observer
)
{
this
.
_observerWeakRefs
.
splice
(
i
1
)
;
}
else
{
observer
.
onPrefChanged
(
pref
)
;
+
+
i
;
}
}
}
onPrefChanged
(
pref
)
{
this
.
_map
.
delete
(
pref
)
;
switch
(
pref
)
{
case
"
showSearchSuggestionsFirst
"
:
this
.
set
(
"
resultGroups
"
JSON
.
stringify
(
makeResultGroups
(
{
showSearchSuggestionsFirst
:
this
.
get
(
pref
)
}
)
)
)
;
return
;
}
if
(
pref
.
startsWith
(
"
suggest
.
"
)
)
{
this
.
_map
.
delete
(
"
defaultBehavior
"
)
;
}
if
(
this
.
shouldHandOffToSearchModePrefs
.
includes
(
pref
)
)
{
this
.
_map
.
delete
(
"
shouldHandOffToSearchMode
"
)
;
}
}
_onNimbusUpdate
(
)
{
let
oldNimbus
=
this
.
_clearNimbusCache
(
)
;
let
newNimbus
=
this
.
_nimbus
;
let
variables
=
[
"
quickSuggestScenario
"
.
.
.
Object
.
keys
(
this
.
FIREFOX_SUGGEST_UI_PREFS_BY_VARIABLE
)
]
;
for
(
let
name
of
variables
)
{
if
(
oldNimbus
[
name
]
!
=
newNimbus
[
name
]
)
{
this
.
updateFirefoxSuggestScenario
(
)
;
return
;
}
}
let
scenario
=
this
.
_getIntendedFirefoxSuggestScenario
(
)
;
let
intendedDefaultPrefs
=
this
.
FIREFOX_SUGGEST_DEFAULT_PREFS
[
scenario
]
;
let
defaults
=
Services
.
prefs
.
getDefaultBranch
(
"
browser
.
urlbar
.
"
)
;
for
(
let
[
name
value
]
of
Object
.
entries
(
intendedDefaultPrefs
)
)
{
if
(
defaults
.
getBoolPref
(
name
)
!
=
value
)
{
this
.
updateFirefoxSuggestScenario
(
)
;
return
;
}
}
Services
.
obs
.
notifyObservers
(
null
FIREFOX_SUGGEST_UPDATE_SKIPPED_TOPIC
)
;
}
_clearNimbusCache
(
)
{
let
nimbus
=
this
.
__nimbus
;
if
(
nimbus
)
{
for
(
let
key
of
Object
.
keys
(
nimbus
)
)
{
this
.
_map
.
delete
(
key
)
;
}
this
.
__nimbus
=
null
;
}
return
nimbus
|
|
{
}
;
}
get
_nimbus
(
)
{
if
(
!
this
.
__nimbus
)
{
this
.
__nimbus
=
NimbusFeatures
.
urlbar
.
getAllVariables
(
{
defaultValues
:
NIMBUS_DEFAULTS
}
)
;
}
return
this
.
__nimbus
;
}
_readPref
(
pref
)
{
let
{
defaultValue
get
}
=
this
.
_getPrefDescriptor
(
pref
)
;
return
get
(
pref
defaultValue
)
;
}
_getPrefValue
(
pref
)
{
switch
(
pref
)
{
case
"
defaultBehavior
"
:
{
let
val
=
0
;
for
(
let
type
of
Object
.
keys
(
SUGGEST_PREF_TO_BEHAVIOR
)
)
{
let
behavior
=
BEHAVIOR_
{
SUGGEST_PREF_TO_BEHAVIOR
[
type
]
.
toUpperCase
(
)
}
;
val
|
=
this
.
get
(
"
suggest
.
"
+
type
)
&
&
Ci
.
mozIPlacesAutoComplete
[
behavior
]
;
}
return
val
;
}
case
"
resultGroups
"
:
try
{
return
JSON
.
parse
(
this
.
_readPref
(
pref
)
)
;
}
catch
(
ex
)
{
}
return
makeResultGroups
(
{
showSearchSuggestionsFirst
:
this
.
get
(
"
showSearchSuggestionsFirst
"
)
}
)
;
case
"
shouldHandOffToSearchMode
"
:
return
this
.
shouldHandOffToSearchModePrefs
.
some
(
prefName
=
>
!
this
.
get
(
prefName
)
)
;
}
return
this
.
_readPref
(
pref
)
;
}
_getPrefDescriptor
(
pref
)
{
let
branch
=
Services
.
prefs
.
getBranch
(
PREF_URLBAR_BRANCH
)
;
let
defaultValue
=
PREF_URLBAR_DEFAULTS
.
get
(
pref
)
;
if
(
defaultValue
=
=
=
undefined
)
{
branch
=
Services
.
prefs
;
defaultValue
=
PREF_OTHER_DEFAULTS
.
get
(
pref
)
;
if
(
defaultValue
=
=
=
undefined
)
{
let
nimbus
=
this
.
_getNimbusDescriptor
(
pref
)
;
if
(
nimbus
)
{
return
nimbus
;
}
throw
new
Error
(
"
Trying
to
access
an
unknown
pref
"
+
pref
)
;
}
}
let
type
;
if
(
!
Array
.
isArray
(
defaultValue
)
)
{
type
=
PREF_TYPES
.
get
(
typeof
defaultValue
)
;
}
else
{
if
(
defaultValue
.
length
!
=
2
)
{
throw
new
Error
(
"
Malformed
pref
def
:
"
+
pref
)
;
}
[
defaultValue
type
]
=
defaultValue
;
type
=
PREF_TYPES
.
get
(
type
)
;
}
if
(
!
type
)
{
throw
new
Error
(
"
Unknown
pref
type
:
"
+
pref
)
;
}
return
{
defaultValue
get
:
branch
[
get
{
type
}
Pref
]
set
:
branch
[
set
{
type
=
=
"
Float
"
?
"
Char
"
:
type
}
Pref
]
clear
:
branch
.
clearUserPref
}
;
}
_getNimbusDescriptor
(
name
)
{
if
(
!
this
.
_nimbus
.
hasOwnProperty
(
name
)
)
{
return
null
;
}
return
{
defaultValue
:
this
.
_nimbus
[
name
]
get
:
(
)
=
>
this
.
_nimbus
[
name
]
set
(
)
{
throw
new
Error
(
'
{
name
}
'
is
a
Nimbus
value
and
cannot
be
set
)
;
}
clear
(
)
{
throw
new
Error
(
'
{
name
}
'
is
a
Nimbus
value
and
cannot
be
cleared
)
;
}
}
;
}
initializeShowSearchSuggestionsFirstPref
(
)
{
let
matchGroups
=
[
]
;
let
pref
=
Services
.
prefs
.
getCharPref
(
"
browser
.
urlbar
.
matchGroups
"
"
"
)
;
try
{
matchGroups
=
pref
.
split
(
"
"
)
.
map
(
v
=
>
{
let
group
=
v
.
split
(
"
:
"
)
;
return
[
group
[
0
]
.
trim
(
)
.
toLowerCase
(
)
Number
(
group
[
1
]
)
]
;
}
)
;
}
catch
(
ex
)
{
}
let
groupNames
=
matchGroups
.
map
(
group
=
>
group
[
0
]
)
;
let
suggestionIndex
=
groupNames
.
indexOf
(
"
suggestion
"
)
;
let
generalIndex
=
groupNames
.
indexOf
(
"
general
"
)
;
let
showSearchSuggestionsFirst
=
generalIndex
<
0
|
|
(
suggestionIndex
>
=
0
&
&
suggestionIndex
<
generalIndex
)
;
let
oldValue
=
Services
.
prefs
.
getBoolPref
(
"
browser
.
urlbar
.
showSearchSuggestionsFirst
"
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
urlbar
.
showSearchSuggestionsFirst
"
showSearchSuggestionsFirst
)
;
if
(
oldValue
=
=
showSearchSuggestionsFirst
)
{
this
.
onPrefChanged
(
"
showSearchSuggestionsFirst
"
)
;
}
}
}
var
UrlbarPrefs
=
new
Preferences
(
)
;
