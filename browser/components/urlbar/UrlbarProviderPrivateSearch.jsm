"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
UrlbarProviderPrivateSearch
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
SkippableTimer
UrlbarProvider
UrlbarUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
)
;
const
lazy
=
{
}
;
XPCOMUtils
.
defineLazyModuleGetters
(
lazy
{
UrlbarResult
:
"
resource
:
/
/
/
modules
/
UrlbarResult
.
jsm
"
UrlbarSearchUtils
:
"
resource
:
/
/
/
modules
/
UrlbarSearchUtils
.
jsm
"
UrlbarTokenizer
:
"
resource
:
/
/
/
modules
/
UrlbarTokenizer
.
jsm
"
}
)
;
class
ProviderPrivateSearch
extends
UrlbarProvider
{
constructor
(
)
{
super
(
)
;
this
.
openTabs
=
new
Map
(
)
;
}
get
name
(
)
{
return
"
PrivateSearch
"
;
}
get
type
(
)
{
return
UrlbarUtils
.
PROVIDER_TYPE
.
PROFILE
;
}
isActive
(
queryContext
)
{
return
(
lazy
.
UrlbarSearchUtils
.
separatePrivateDefaultUIEnabled
&
&
!
queryContext
.
isPrivate
&
&
queryContext
.
tokens
.
length
)
;
}
async
startQuery
(
queryContext
addCallback
)
{
let
searchString
=
queryContext
.
trimmedSearchString
;
if
(
queryContext
.
tokens
.
some
(
t
=
>
t
.
type
=
=
lazy
.
UrlbarTokenizer
.
TYPE
.
RESTRICT_SEARCH
)
)
{
if
(
queryContext
.
tokens
.
length
=
=
1
)
{
return
;
}
searchString
=
queryContext
.
tokens
.
filter
(
t
=
>
t
.
type
!
=
lazy
.
UrlbarTokenizer
.
TYPE
.
RESTRICT_SEARCH
)
.
map
(
t
=
>
t
.
value
)
.
join
(
"
"
)
;
}
let
instance
=
this
.
queryInstance
;
let
engine
=
queryContext
.
searchMode
?
.
engineName
?
Services
.
search
.
getEngineByName
(
queryContext
.
searchMode
.
engineName
)
:
await
Services
.
search
.
getDefaultPrivate
(
)
;
let
isPrivateEngine
=
lazy
.
UrlbarSearchUtils
.
separatePrivateDefault
&
&
engine
!
=
(
await
Services
.
search
.
getDefault
(
)
)
;
this
.
logger
.
info
(
isPrivateEngine
:
{
isPrivateEngine
}
)
;
await
new
SkippableTimer
(
{
name
:
"
ProviderPrivateSearch
"
time
:
100
logger
:
this
.
logger
}
)
.
promise
;
if
(
instance
!
=
this
.
queryInstance
)
{
return
;
}
let
result
=
new
lazy
.
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
.
.
.
lazy
.
UrlbarResult
.
payloadAndSimpleHighlights
(
queryContext
.
tokens
{
engine
:
[
engine
.
name
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
query
:
[
searchString
UrlbarUtils
.
HIGHLIGHT
.
NONE
]
icon
:
engine
.
iconURI
?
.
spec
inPrivateWindow
:
true
isPrivateEngine
}
)
)
;
result
.
suggestedIndex
=
1
;
addCallback
(
this
result
)
;
}
}
var
UrlbarProviderPrivateSearch
=
new
ProviderPrivateSearch
(
)
;
