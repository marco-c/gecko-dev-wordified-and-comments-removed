"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
UrlbarSearchUtils
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
SEARCH_ENGINE_TOPIC
=
"
browser
-
search
-
engine
-
modified
"
;
class
SearchUtils
{
constructor
(
)
{
this
.
_refreshEnginesByAliasPromise
=
Promise
.
resolve
(
)
;
this
.
QueryInterface
=
ChromeUtils
.
generateQI
(
[
"
nsIObserver
"
"
nsISupportsWeakReference
"
]
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
separatePrivateDefaultUIEnabled
"
"
browser
.
search
.
separatePrivateDefault
.
ui
.
enabled
"
false
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
separatePrivateDefault
"
"
browser
.
search
.
separatePrivateDefault
"
false
)
;
}
async
init
(
)
{
if
(
!
this
.
_initPromise
)
{
this
.
_initPromise
=
this
.
_initInternal
(
)
;
}
await
this
.
_initPromise
;
}
async
enginesForDomainPrefix
(
prefix
{
matchAllDomainLevels
=
false
}
=
{
}
)
{
await
this
.
init
(
)
;
prefix
=
prefix
.
toLowerCase
(
)
;
let
engines
=
[
]
;
let
partialMatchEngines
=
[
]
;
for
(
let
engine
of
await
Services
.
search
.
getVisibleEngines
(
)
)
{
let
domain
=
engine
.
getResultDomain
(
)
;
if
(
domain
.
startsWith
(
prefix
)
|
|
domain
.
startsWith
(
"
www
.
"
+
prefix
)
)
{
engines
.
push
(
engine
)
;
}
if
(
matchAllDomainLevels
)
{
domain
=
domain
.
substr
(
0
domain
.
length
-
engine
.
searchUrlPublicSuffix
.
length
)
;
let
parts
=
domain
.
split
(
"
.
"
)
;
for
(
let
i
=
1
;
i
<
parts
.
length
-
1
;
+
+
i
)
{
if
(
parts
.
slice
(
i
)
.
join
(
"
.
"
)
.
startsWith
(
prefix
)
)
{
partialMatchEngines
.
push
(
engine
)
;
}
}
}
}
return
engines
.
concat
(
partialMatchEngines
)
;
}
async
engineForAlias
(
alias
)
{
await
Promise
.
all
(
[
this
.
init
(
)
this
.
_refreshEnginesByAliasPromise
]
)
;
return
this
.
_enginesByAlias
.
get
(
alias
.
toLocaleLowerCase
(
)
)
|
|
null
;
}
async
tokenAliasEngines
(
)
{
await
this
.
init
(
)
;
let
tokenAliasEngines
=
[
]
;
for
(
let
engine
of
await
Services
.
search
.
getVisibleEngines
(
)
)
{
let
tokenAliases
=
this
.
_aliasesForEngine
(
engine
)
.
filter
(
a
=
>
a
.
startsWith
(
"
"
)
)
;
if
(
tokenAliases
.
length
)
{
tokenAliasEngines
.
push
(
{
engine
tokenAliases
}
)
;
}
}
return
tokenAliasEngines
;
}
getDefaultEngine
(
isPrivate
=
false
)
{
return
this
.
separatePrivateDefaultUIEnabled
&
&
this
.
separatePrivateDefault
&
&
isPrivate
?
Services
.
search
.
defaultPrivateEngine
:
Services
.
search
.
defaultEngine
;
}
async
_initInternal
(
)
{
await
Services
.
search
.
init
(
)
;
await
this
.
_refreshEnginesByAlias
(
)
;
Services
.
obs
.
addObserver
(
this
SEARCH_ENGINE_TOPIC
true
)
;
}
async
_refreshEnginesByAlias
(
)
{
this
.
_enginesByAlias
=
new
Map
(
)
;
for
(
let
engine
of
await
Services
.
search
.
getVisibleEngines
(
)
)
{
if
(
!
engine
.
hidden
)
{
for
(
let
alias
of
this
.
_aliasesForEngine
(
engine
)
)
{
this
.
_enginesByAlias
.
set
(
alias
engine
)
;
}
}
}
}
serpsAreEquivalent
(
historySerp
generatedSerp
ignoreParams
=
[
]
)
{
let
historyParams
=
new
URL
(
historySerp
)
.
searchParams
;
let
generatedParams
=
new
URL
(
generatedSerp
)
.
searchParams
;
if
(
!
Array
.
from
(
historyParams
.
entries
(
)
)
.
every
(
(
[
key
value
]
)
=
>
ignoreParams
.
includes
(
key
)
|
|
value
=
=
=
generatedParams
.
get
(
key
)
)
)
{
return
false
;
}
return
true
;
}
_aliasesForEngine
(
engine
)
{
return
engine
.
aliases
.
reduce
(
(
aliases
aliasWithCase
)
=
>
{
let
alias
=
aliasWithCase
.
toLocaleLowerCase
(
)
;
aliases
.
push
(
alias
)
;
if
(
!
alias
.
startsWith
(
"
"
)
)
{
aliases
.
push
(
"
"
+
alias
)
;
}
return
aliases
;
}
[
]
)
;
}
observe
(
subject
topic
data
)
{
switch
(
data
)
{
case
"
engine
-
added
"
:
case
"
engine
-
changed
"
:
case
"
engine
-
removed
"
:
case
"
engine
-
default
"
:
this
.
_refreshEnginesByAliasPromise
=
this
.
_refreshEnginesByAlias
(
)
;
break
;
}
}
}
var
UrlbarSearchUtils
=
new
SearchUtils
(
)
;
