"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
AppMenuNotifications
:
"
resource
:
/
/
gre
/
modules
/
AppMenuNotifications
.
sys
.
mjs
"
ProfileAge
:
"
resource
:
/
/
gre
/
modules
/
ProfileAge
.
sys
.
mjs
"
UrlbarPrefs
:
"
resource
:
/
/
/
modules
/
UrlbarPrefs
.
sys
.
mjs
"
UrlbarProviderSearchTips
:
"
resource
:
/
/
/
modules
/
UrlbarProviderSearchTips
.
sys
.
mjs
"
UrlbarUtils
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
sys
.
mjs
"
}
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
HttpServer
:
"
resource
:
/
/
testing
-
common
/
httpd
.
js
"
}
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
clipboardHelper
"
"
mozilla
.
org
/
widget
/
clipboardhelper
;
1
"
"
nsIClipboardHelper
"
)
;
const
MAX_SHOWN_COUNT
=
4
;
const
LAST_UPDATE_THRESHOLD_MS
=
24
*
60
*
60
*
1000
;
const
GOOGLE_DOMAINS
=
[
"
www
.
google
.
com
"
"
www
.
google
.
ca
"
"
www
.
google
.
co
.
uk
"
"
www
.
google
.
com
.
au
"
"
www
.
google
.
co
.
nz
"
]
;
const
SEARCH_TERM
=
"
chocolate
"
;
const
SEARCH_SERP_URL
=
https
:
/
/
example
.
com
/
?
q
=
{
SEARCH_TERM
}
;
add_setup
(
async
function
(
)
{
await
PlacesUtils
.
history
.
clear
(
)
;
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
browser
.
urlbar
.
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
0
]
[
browser
.
urlbar
.
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
}
0
]
[
browser
.
urlbar
.
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
}
0
]
]
}
)
;
let
age
=
await
ProfileAge
(
)
;
let
originalTimes
=
age
.
_times
;
let
date
=
Date
.
now
(
)
-
LAST_UPDATE_THRESHOLD_MS
-
30000
;
age
.
_times
=
{
created
:
date
firstUse
:
date
}
;
await
age
.
writeTimes
(
)
;
let
updateRootDir
=
Services
.
dirsvc
.
get
(
"
UpdRootD
"
Ci
.
nsIFile
)
;
let
updatesFile
=
updateRootDir
.
clone
(
)
;
updatesFile
.
append
(
"
updates
.
xml
"
)
;
let
activeUpdateFile
=
updateRootDir
.
clone
(
)
;
activeUpdateFile
.
append
(
"
active
-
update
.
xml
"
)
;
try
{
updatesFile
.
remove
(
false
)
;
}
catch
(
e
)
{
}
try
{
activeUpdateFile
.
remove
(
false
)
;
}
catch
(
e
)
{
}
let
defaultEngine
=
await
Services
.
search
.
getDefault
(
)
;
let
defaultEngineName
=
defaultEngine
.
name
;
Assert
.
equal
(
defaultEngineName
"
Google
"
"
Default
engine
should
be
Google
.
"
)
;
await
SearchTestUtils
.
installSearchExtension
(
)
;
registerCleanupFunction
(
async
(
)
=
>
{
let
age2
=
await
ProfileAge
(
)
;
age2
.
_times
=
originalTimes
;
await
age2
.
writeTimes
(
)
;
await
setDefaultEngine
(
defaultEngineName
)
;
resetSearchTipsProvider
(
)
;
}
)
;
}
)
;
add_task
(
async
function
pickButton_onboard
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
url
:
"
about
:
newtab
"
waitForLoad
:
false
}
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
false
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
let
button
=
result
.
element
.
row
.
_buttons
.
get
(
"
0
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
}
)
;
gURLBar
.
blur
(
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
click
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
)
MAX_SHOWN_COUNT
"
Onboarding
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
pickButton_redirect
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Google
"
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
await
withDNSRedirect
(
"
www
.
google
.
com
"
"
/
"
async
url
=
>
{
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
false
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
let
button
=
result
.
element
.
row
.
_buttons
.
get
(
"
0
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
}
)
;
gURLBar
.
blur
(
)
;
}
)
;
}
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
click
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
}
)
MAX_SHOWN_COUNT
"
Redirect
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
pickButton_persist
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
[
"
browser
.
urlbar
.
showSearchTerms
.
featureGate
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Example
"
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
let
browserLoadedPromise
=
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
false
SEARCH_SERP_URL
)
;
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
SEARCH_SERP_URL
)
;
await
browserLoadedPromise
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
false
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
let
button
=
result
.
element
.
row
.
_buttons
.
get
(
"
0
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
}
)
;
gURLBar
.
blur
(
)
;
Assert
.
equal
(
gURLBar
.
value
SEARCH_TERM
"
The
Urlbar
should
keep
its
existing
value
.
"
)
;
}
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
click
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
}
)
MAX_SHOWN_COUNT
"
Persist
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
clickInInput_onboard
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Google
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
url
:
"
about
:
newtab
"
waitForLoad
:
false
}
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
gURLBar
.
textbox
.
parentNode
{
}
)
;
}
)
;
gURLBar
.
blur
(
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
click
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
)
MAX_SHOWN_COUNT
"
Onboarding
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
openLocation_onboard
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Google
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
url
:
"
about
:
newtab
"
waitForLoad
:
false
}
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
document
.
getElementById
(
"
Browser
:
OpenLocation
"
)
.
doCommand
(
)
;
}
)
;
gURLBar
.
blur
(
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
enter
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
)
MAX_SHOWN_COUNT
"
Onboarding
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
clickInInput_redirect
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Google
"
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
await
withDNSRedirect
(
"
www
.
google
.
com
"
"
/
"
async
url
=
>
{
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
gURLBar
.
textbox
.
parentNode
{
}
)
;
}
)
;
gURLBar
.
blur
(
)
;
}
)
;
}
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
click
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
}
)
MAX_SHOWN_COUNT
"
Redirect
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
clickInInput_persist
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
[
"
browser
.
urlbar
.
showSearchTerms
.
featureGate
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Example
"
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
let
browserLoadedPromise
=
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
false
SEARCH_SERP_URL
)
;
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
SEARCH_SERP_URL
)
;
await
browserLoadedPromise
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
false
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
gURLBar
.
textbox
.
parentNode
{
}
)
;
}
)
;
gURLBar
.
blur
(
)
;
Assert
.
equal
(
gURLBar
.
value
SEARCH_TERM
"
The
Urlbar
should
keep
its
existing
value
.
"
)
;
}
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
click
"
value
:
"
typed
"
}
{
category
:
"
urlbar
"
method
:
"
abandonment
"
object
:
"
blur
"
value
:
"
returned
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
}
)
MAX_SHOWN_COUNT
"
Persist
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
openLocation_redirect
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Google
"
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
await
withDNSRedirect
(
"
www
.
google
.
com
"
"
/
"
async
url
=
>
{
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
document
.
getElementById
(
"
Browser
:
OpenLocation
"
)
.
doCommand
(
)
;
}
)
;
gURLBar
.
blur
(
)
;
}
)
;
}
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
enter
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
}
)
MAX_SHOWN_COUNT
"
Redirect
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
openLocation_persist
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
true
]
[
"
browser
.
urlbar
.
showSearchTerms
.
featureGate
"
true
]
]
}
)
;
Services
.
telemetry
.
clearEvents
(
)
;
await
setDefaultEngine
(
"
Example
"
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
let
browserLoadedPromise
=
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
false
SEARCH_SERP_URL
)
;
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
SEARCH_SERP_URL
)
;
await
browserLoadedPromise
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
document
.
getElementById
(
"
Browser
:
OpenLocation
"
)
.
doCommand
(
)
;
}
)
;
gURLBar
.
blur
(
)
;
Assert
.
equal
(
gURLBar
.
value
SEARCH_TERM
"
The
Urlbar
should
keep
its
existing
value
.
"
)
;
}
)
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
"
urlbar
.
tips
"
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
}
-
picked
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
category
:
"
urlbar
"
method
:
"
engagement
"
object
:
"
enter
"
value
:
"
typed
"
}
]
{
category
:
"
urlbar
"
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
PERSIST
}
)
MAX_SHOWN_COUNT
"
Persist
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
Assert
.
equal
(
gURLBar
.
value
"
"
"
The
Urlbar
should
be
empty
.
"
)
;
resetSearchTipsProvider
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
pickingTipDoesNotDisableOtherKinds
(
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
await
setDefaultEngine
(
"
Google
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
url
:
"
about
:
newtab
"
waitForLoad
:
false
}
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
false
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
let
button
=
result
.
element
.
row
.
_buttons
.
get
(
"
0
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
}
)
;
gURLBar
.
blur
(
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
tipShownCount
.
{
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
}
)
MAX_SHOWN_COUNT
"
Onboarding
tips
are
disabled
after
tip
button
is
picked
.
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
let
tab2
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
url
:
"
about
:
newtab
"
waitForLoad
:
false
}
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
NONE
)
;
await
withDNSRedirect
(
"
www
.
google
.
com
"
"
/
"
async
url
=
>
{
await
checkTab
(
window
url
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
)
;
}
)
;
BrowserTestUtils
.
removeTab
(
tab2
)
;
resetSearchTipsProvider
(
)
;
}
)
;
add_task
(
async
function
notification
(
)
{
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
let
box
=
gBrowser
.
getNotificationBox
(
)
;
let
note
=
box
.
appendNotification
(
"
urlbar
-
test
"
{
label
:
"
Test
"
priority
:
box
.
PRIORITY_INFO_HIGH
}
)
;
note
.
persistence
=
100
;
await
withDNSRedirect
(
"
www
.
google
.
com
"
"
/
"
async
url
=
>
{
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
NONE
)
;
box
.
removeNotification
(
note
true
)
;
}
)
;
}
)
;
resetSearchTipsProvider
(
)
;
}
)
;
add_task
(
async
function
tabSwitch
(
)
{
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
about
:
newtab
"
)
;
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
Services
.
telemetry
.
clearScalars
(
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
tab
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
resetSearchTipsProvider
(
)
;
}
)
;
add_task
(
async
function
ignoreEndsEngagement
(
)
{
await
setDefaultEngine
(
"
Google
"
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
(
)
=
>
{
await
withDNSRedirect
(
"
www
.
google
.
com
"
"
/
"
async
url
=
>
{
BrowserTestUtils
.
loadURIString
(
gBrowser
.
selectedBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
false
)
;
let
spring
=
gURLBar
.
inputField
.
closest
(
"
#
nav
-
bar
"
)
.
querySelector
(
"
toolbarspring
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
async
(
)
=
>
{
await
EventUtils
.
synthesizeMouseAtCenter
(
spring
{
}
)
;
}
)
;
Assert
.
ok
(
UrlbarProviderSearchTips
.
showedTipTypeInCurrentEngagement
=
=
UrlbarProviderSearchTips
.
TIP_TYPE
.
NONE
"
The
engagement
should
have
ended
after
the
tip
was
ignored
.
"
)
;
}
)
;
}
)
;
resetSearchTipsProvider
(
)
;
}
)
;
add_task
(
async
function
pasteAndGo_url
(
)
{
await
doPasteAndGoTest
(
"
http
:
/
/
example
.
com
/
"
"
http
:
/
/
example
.
com
/
"
)
;
}
)
;
add_task
(
async
function
pasteAndGo_nonURL
(
)
{
await
setDefaultEngine
(
"
Example
"
)
;
await
doPasteAndGoTest
(
"
pasteAndGo_nonURL
"
"
https
:
/
/
example
.
com
/
?
q
=
pasteAndGo_nonURL
"
)
;
await
setDefaultEngine
(
"
Google
"
)
;
}
)
;
async
function
doPasteAndGoTest
(
searchString
expectedURL
)
{
UrlbarProviderSearchTips
.
disableTipsForCurrentSession
=
false
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
{
gBrowser
url
:
"
about
:
newtab
"
waitForLoad
:
false
}
)
;
await
checkTip
(
window
UrlbarProviderSearchTips
.
TIP_TYPE
.
ONBOARD
false
)
;
await
SimpleTest
.
promiseClipboardChange
(
searchString
(
)
=
>
{
clipboardHelper
.
copyString
(
searchString
)
;
}
)
;
let
textBox
=
gURLBar
.
querySelector
(
"
moz
-
input
-
box
"
)
;
let
cxmenu
=
textBox
.
menupopup
;
let
cxmenuPromise
=
BrowserTestUtils
.
waitForEvent
(
cxmenu
"
popupshown
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
gURLBar
.
inputField
{
type
:
"
contextmenu
"
button
:
2
}
)
;
await
cxmenuPromise
;
let
menuitem
=
textBox
.
getMenuItem
(
"
paste
-
and
-
go
"
)
;
let
browserLoadedPromise
=
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
false
expectedURL
)
;
cxmenu
.
activateItem
(
menuitem
)
;
await
browserLoadedPromise
;
BrowserTestUtils
.
removeTab
(
tab
)
;
resetSearchTipsProvider
(
)
;
}
add_task
(
async
function
noActionWhenDisabled
(
)
{
await
setDefaultEngine
(
"
Bing
"
)
;
await
withDNSRedirect
(
"
www
.
bing
.
com
"
"
/
"
async
url
=
>
{
await
checkTab
(
window
url
UrlbarProviderSearchTips
.
TIP_TYPE
.
REDIRECT
)
;
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
newtabpage
.
activity
-
stream
.
asrouter
.
userprefs
.
cfr
.
features
"
false
]
]
}
)
;
await
withDNSRedirect
(
"
www
.
bing
.
com
"
"
/
"
async
url
=
>
{
Assert
.
ok
(
!
UrlbarTestUtils
.
isPopupOpen
(
window
)
"
The
UrlbarView
should
not
be
open
.
"
)
;
}
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
