"
use
strict
"
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
browser
/
components
/
urlbar
/
tests
/
ext
/
browser
/
head
-
common
.
js
"
this
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
Preferences
:
"
resource
:
/
/
gre
/
modules
/
Preferences
.
jsm
"
}
)
;
const
SCHEMA_BASENAME
=
"
schema
.
json
"
;
const
SCRIPT_BASENAME
=
"
api
.
js
"
;
const
SCHEMA_PATH
=
getTestFilePath
(
SCHEMA_BASENAME
)
;
const
SCRIPT_PATH
=
getTestFilePath
(
SCRIPT_BASENAME
)
;
let
schemaSource
;
let
scriptSource
;
add_task
(
async
function
loadSource
(
)
{
schemaSource
=
await
(
await
fetch
(
"
file
:
/
/
"
+
SCHEMA_PATH
)
)
.
text
(
)
;
scriptSource
=
await
(
await
fetch
(
"
file
:
/
/
"
+
SCRIPT_PATH
)
)
.
text
(
)
;
}
)
;
async
function
loadExtension
(
{
background
extraFiles
=
{
}
}
)
{
let
ext
=
ExtensionTestUtils
.
loadExtension
(
{
manifest
:
{
permissions
:
[
"
urlbar
"
]
experiment_apis
:
{
experiments_urlbar
:
{
schema
:
SCHEMA_BASENAME
parent
:
{
scopes
:
[
"
addon_parent
"
]
paths
:
[
[
"
experiments
"
"
urlbar
"
]
]
script
:
SCRIPT_BASENAME
}
}
}
}
files
:
{
[
SCHEMA_BASENAME
]
:
schemaSource
[
SCRIPT_BASENAME
]
:
scriptSource
.
.
.
extraFiles
}
isPrivileged
:
true
background
}
)
;
await
ext
.
startup
(
)
;
return
ext
;
}
function
add_settings_tasks
(
prefName
background
)
{
let
defaultPreferences
=
new
Preferences
(
{
defaultBranch
:
true
}
)
;
let
originalValue
=
defaultPreferences
.
get
(
prefName
)
;
registerCleanupFunction
(
(
)
=
>
{
defaultPreferences
.
set
(
prefName
originalValue
)
;
}
)
;
add_task
(
async
function
get
(
)
{
let
ext
=
await
loadExtension
(
{
background
}
)
;
defaultPreferences
.
set
(
prefName
false
)
;
ext
.
sendMessage
(
"
get
"
{
}
)
;
let
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
.
value
false
)
;
defaultPreferences
.
set
(
prefName
true
)
;
ext
.
sendMessage
(
"
get
"
{
}
)
;
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
.
value
true
)
;
await
ext
.
unload
(
)
;
}
)
;
add_task
(
async
function
set
(
)
{
let
ext
=
await
loadExtension
(
{
background
}
)
;
defaultPreferences
.
set
(
prefName
false
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
true
}
)
;
let
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
true
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
true
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
false
}
)
;
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
true
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
false
)
;
await
ext
.
unload
(
)
;
}
)
;
add_task
(
async
function
clear
(
)
{
defaultPreferences
.
set
(
prefName
false
)
;
let
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
clear
"
{
}
)
;
let
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
false
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
false
)
;
await
ext
.
unload
(
)
;
defaultPreferences
.
set
(
prefName
false
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
true
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
ext
.
sendMessage
(
"
clear
"
{
}
)
;
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
true
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
false
)
;
await
ext
.
unload
(
)
;
defaultPreferences
.
set
(
prefName
true
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
false
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
ext
.
sendMessage
(
"
clear
"
{
}
)
;
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
true
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
true
)
;
await
ext
.
unload
(
)
;
defaultPreferences
.
set
(
prefName
false
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
false
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
ext
.
sendMessage
(
"
clear
"
{
}
)
;
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
true
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
false
)
;
await
ext
.
unload
(
)
;
defaultPreferences
.
set
(
prefName
true
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
true
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
ext
.
sendMessage
(
"
clear
"
{
}
)
;
result
=
await
ext
.
awaitMessage
(
"
done
"
)
;
Assert
.
strictEqual
(
result
true
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
true
)
;
await
ext
.
unload
(
)
;
}
)
;
add_task
(
async
function
shutdown
(
)
{
defaultPreferences
.
set
(
prefName
false
)
;
let
ext
=
await
loadExtension
(
{
background
}
)
;
await
ext
.
unload
(
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
false
)
;
defaultPreferences
.
set
(
prefName
false
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
true
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
await
ext
.
unload
(
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
false
)
;
defaultPreferences
.
set
(
prefName
true
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
false
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
await
ext
.
unload
(
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
true
)
;
defaultPreferences
.
set
(
prefName
false
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
false
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
await
ext
.
unload
(
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
false
)
;
defaultPreferences
.
set
(
prefName
true
)
;
ext
=
await
loadExtension
(
{
background
}
)
;
ext
.
sendMessage
(
"
set
"
{
value
:
true
}
)
;
await
ext
.
awaitMessage
(
"
done
"
)
;
await
ext
.
unload
(
)
;
Assert
.
strictEqual
(
defaultPreferences
.
get
(
prefName
)
true
)
;
}
)
;
}
