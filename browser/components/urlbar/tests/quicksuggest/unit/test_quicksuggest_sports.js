"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
SportsSuggestions
:
"
moz
-
src
:
/
/
/
browser
/
components
/
urlbar
/
private
/
SportsSuggestions
.
sys
.
mjs
"
}
)
;
const
SUGGESTION_VALUE_SCHEDULED
=
{
sport
:
"
Sport
3
"
query
:
"
query
3
"
date
:
"
2025
-
11
-
01T17
:
00
:
00Z
"
home_team
:
{
name
:
"
Team
3
Home
"
score
:
null
}
away_team
:
{
name
:
"
Team
3
Away
"
score
:
null
}
status_type
:
"
scheduled
"
}
;
add_setup
(
async
function
init
(
)
{
await
Services
.
search
.
init
(
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
search
.
suggest
.
enabled
"
false
)
;
await
QuickSuggestTestUtils
.
setRegionAndLocale
(
{
locale
:
"
en
-
US
"
skipSuggestReset
:
true
}
)
;
await
QuickSuggestTestUtils
.
ensureQuickSuggestInit
(
{
merinoSuggestions
:
merinoSuggestions
(
[
SUGGESTION_VALUE_SCHEDULED
]
)
prefs
:
[
[
"
sports
.
featureGate
"
true
]
[
"
suggest
.
sports
"
true
]
[
"
suggest
.
quicksuggest
.
all
"
true
]
]
}
)
;
}
)
;
add_task
(
async
function
telemetryType
(
)
{
Assert
.
equal
(
QuickSuggest
.
getFeature
(
"
SportsSuggestions
"
)
.
getSuggestionTelemetryType
(
{
}
)
"
sports
"
"
Telemetry
type
should
be
as
expected
"
)
;
}
)
;
add_task
(
async
function
disabledPrefs
(
)
{
setNow
(
"
2025
-
10
-
31T14
:
00
:
00
-
04
:
00
[
-
04
:
00
]
"
)
;
let
prefs
=
[
"
quicksuggest
.
enabled
"
"
sports
.
featureGate
"
"
suggest
.
sports
"
"
suggest
.
quicksuggest
.
all
"
]
;
for
(
let
pref
of
prefs
)
{
info
(
"
Testing
pref
:
"
+
pref
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
expectedResult
(
[
{
query
:
"
query
3
"
sport
:
"
Sport
3
"
status_type
:
"
scheduled
"
date
:
"
2025
-
11
-
01T17
:
00
:
00Z
"
home_team
:
{
name
:
"
Team
3
Home
"
score
:
null
}
away_team
:
{
name
:
"
Team
3
Away
"
score
:
null
}
}
]
)
]
}
)
;
UrlbarPrefs
.
set
(
pref
false
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
]
}
)
;
UrlbarPrefs
.
set
(
pref
true
)
;
await
QuickSuggestTestUtils
.
forceSync
(
)
;
}
}
)
;
add_task
(
async
function
datesAndTimes
(
)
{
let
tests
=
[
{
now
:
"
2025
-
10
-
31T12
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
date
:
"
2013
-
05
-
11T04
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
-
Infinity
isFuture
:
false
}
}
{
now
:
[
"
2025
-
10
-
31T00
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
"
2025
-
10
-
31T23
:
59
:
59
-
07
:
00
[
-
07
:
00
]
"
]
date
:
[
"
2025
-
10
-
29T00
:
00
:
00
-
07
:
00
"
"
2025
-
10
-
29T23
:
59
:
59
-
07
:
00
"
]
expected
:
{
daysUntil
:
-
Infinity
isFuture
:
false
}
}
{
now
:
[
"
2025
-
10
-
31T00
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
"
2025
-
10
-
31T23
:
59
:
59
-
07
:
00
[
-
07
:
00
]
"
]
date
:
[
"
2025
-
10
-
30T00
:
00
:
00
-
07
:
00
"
"
2025
-
10
-
30T23
:
59
:
59
-
07
:
00
"
]
expected
:
{
daysUntil
:
-
1
isFuture
:
false
}
}
{
now
:
[
"
2025
-
10
-
31T12
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
"
2025
-
10
-
31T23
:
59
:
59
-
07
:
00
[
-
07
:
00
]
"
]
date
:
[
"
2025
-
10
-
31T00
:
00
:
00
-
07
:
00
"
"
2025
-
10
-
31T11
:
59
:
59
-
07
:
00
"
]
expected
:
{
daysUntil
:
0
isFuture
:
false
}
}
{
now
:
"
2025
-
10
-
31T12
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
date
:
"
2025
-
10
-
31T12
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
0
isFuture
:
false
}
}
{
now
:
[
"
2025
-
10
-
31T00
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
"
2025
-
10
-
31T12
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
]
date
:
[
"
2025
-
10
-
31T12
:
00
:
01
-
07
:
00
"
"
2025
-
10
-
31T23
:
59
:
59
-
07
:
00
"
]
expected
:
{
daysUntil
:
0
isFuture
:
true
}
}
{
now
:
[
"
2025
-
10
-
31T00
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
"
2025
-
10
-
31T23
:
59
:
59
-
07
:
00
[
-
07
:
00
]
"
]
date
:
[
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
"
"
2025
-
11
-
01T23
:
59
:
59
-
07
:
00
"
]
expected
:
{
daysUntil
:
1
isFuture
:
true
}
}
{
now
:
[
"
2025
-
10
-
31T00
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
"
2025
-
10
-
31T23
:
59
:
59
-
07
:
00
[
-
07
:
00
]
"
]
date
:
[
"
2025
-
11
-
02T00
:
00
:
00
-
07
:
00
"
"
2025
-
11
-
02T23
:
59
:
59
-
07
:
00
"
]
expected
:
{
daysUntil
:
Infinity
isFuture
:
true
}
}
{
now
:
"
2025
-
10
-
31T00
:
00
:
00
-
07
:
00
[
-
07
:
00
]
"
date
:
"
3013
-
05
-
11T04
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
Infinity
isFuture
:
true
}
}
]
;
for
(
let
{
now
date
expected
}
of
tests
)
{
let
nows
=
typeof
now
=
=
"
string
"
?
[
now
]
:
now
;
let
dates
=
typeof
date
=
=
"
string
"
?
[
date
]
:
date
;
for
(
let
n
of
nows
)
{
let
zonedNow
=
setNow
(
n
)
;
for
(
let
d
of
dates
)
{
Assert
.
deepEqual
(
SportsSuggestions
.
_parseDate
(
new
Date
(
d
)
)
{
.
.
.
expected
zonedNow
zonedDate
:
new
Date
(
d
)
.
toTemporalInstant
(
)
.
toZonedDateTimeISO
(
zonedNow
)
}
"
datesAndTimes
test
:
"
+
JSON
.
stringify
(
{
now
:
n
date
:
d
}
)
)
;
}
}
}
}
)
;
add_task
(
function
timeZoneTransition
(
)
{
let
tests
=
[
{
now
:
"
2025
-
10
-
02T12
:
00
:
00
-
07
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
10
-
01T00
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
-
1
isFuture
:
false
}
}
{
now
:
"
2025
-
11
-
03T00
:
00
:
00
-
08
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
-
Infinity
isFuture
:
false
}
}
{
now
:
"
2025
-
11
-
02T12
:
00
:
00
-
08
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
-
1
isFuture
:
false
}
}
{
now
:
"
2025
-
11
-
02T01
:
00
:
00
-
08
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
-
1
isFuture
:
false
}
}
{
now
:
"
2025
-
11
-
02T23
:
59
:
59
-
08
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
-
1
isFuture
:
false
}
}
{
now
:
"
2025
-
11
-
02T01
:
00
:
00
-
08
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
02T00
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
0
isFuture
:
false
}
}
{
now
:
"
2025
-
11
-
02T01
:
00
:
00
-
08
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
02T01
:
00
:
00
-
07
:
00
"
expected
:
{
daysUntil
:
0
isFuture
:
false
}
}
{
now
:
"
2025
-
11
-
02T01
:
00
:
00
-
07
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
02T01
:
00
:
00
-
08
:
00
"
expected
:
{
daysUntil
:
0
isFuture
:
true
}
}
{
now
:
"
2025
-
11
-
02T00
:
00
:
00
-
07
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
02T01
:
00
:
00
-
08
:
00
"
expected
:
{
daysUntil
:
0
isFuture
:
true
}
}
{
now
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
02T23
:
59
:
59
-
08
:
00
"
expected
:
{
daysUntil
:
1
isFuture
:
true
}
}
{
now
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
02T01
:
00
:
00
-
08
:
00
"
expected
:
{
daysUntil
:
1
isFuture
:
true
}
}
{
now
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
02T12
:
00
:
00
-
08
:
00
"
expected
:
{
daysUntil
:
1
isFuture
:
true
}
}
{
now
:
"
2025
-
11
-
01T00
:
00
:
00
-
07
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
03T00
:
00
:
00
-
08
:
00
"
expected
:
{
daysUntil
:
Infinity
isFuture
:
true
}
}
{
now
:
"
2025
-
11
-
11T12
:
00
:
00
-
08
:
00
[
America
/
Los_Angeles
]
"
date
:
"
2025
-
11
-
10T00
:
00
:
00
-
08
:
00
"
expected
:
{
daysUntil
:
-
1
isFuture
:
false
}
}
]
;
for
(
let
{
now
date
expected
}
of
tests
)
{
let
zonedNow
=
setNow
(
now
)
;
Assert
.
deepEqual
(
SportsSuggestions
.
_parseDate
(
new
Date
(
date
)
)
{
.
.
.
expected
zonedNow
zonedDate
:
new
Date
(
date
)
.
toTemporalInstant
(
)
.
toZonedDateTimeISO
(
zonedNow
)
}
"
timeZoneTransition
test
:
"
+
JSON
.
stringify
(
{
now
date
}
)
)
;
}
}
)
;
add_task
(
async
function
command_notInterested
(
)
{
setNow
(
"
2025
-
10
-
31T14
:
00
:
00
-
04
:
00
[
-
04
:
00
]
"
)
;
await
doDismissAllTest
(
{
result
:
expectedResult
(
[
{
query
:
"
query
3
"
sport
:
"
Sport
3
"
status_type
:
"
scheduled
"
date
:
"
2025
-
11
-
01T17
:
00
:
00Z
"
home_team
:
{
name
:
"
Team
3
Home
"
score
:
null
}
away_team
:
{
name
:
"
Team
3
Away
"
score
:
null
}
}
]
)
command
:
"
not_interested
"
feature
:
QuickSuggest
.
getFeature
(
"
SportsSuggestions
"
)
pref
:
"
suggest
.
sports
"
queries
:
[
{
query
:
"
test
"
}
]
}
)
;
}
)
;
add_task
(
async
function
command_showLessFrequently
(
)
{
setNow
(
"
2025
-
10
-
31T14
:
00
:
00
-
04
:
00
[
-
04
:
00
]
"
)
;
UrlbarPrefs
.
clear
(
"
sports
.
showLessFrequentlyCount
"
)
;
UrlbarPrefs
.
clear
(
"
sports
.
minKeywordLength
"
)
;
let
cleanUpNimbus
=
await
UrlbarTestUtils
.
initNimbusFeature
(
{
realtimeMinKeywordLength
:
0
realtimeShowLessFrequentlyCap
:
3
}
)
;
let
result
=
expectedResult
(
[
{
query
:
"
query
3
"
sport
:
"
Sport
3
"
status_type
:
"
scheduled
"
date
:
"
2025
-
11
-
01T17
:
00
:
00Z
"
home_team
:
{
name
:
"
Team
3
Home
"
score
:
null
}
away_team
:
{
name
:
"
Team
3
Away
"
score
:
null
}
}
]
)
;
const
testData
=
[
{
input
:
"
spo
"
before
:
{
canShowLessFrequently
:
true
showLessFrequentlyCount
:
0
minKeywordLength
:
0
}
after
:
{
canShowLessFrequently
:
true
showLessFrequentlyCount
:
1
minKeywordLength
:
4
}
}
{
input
:
"
sport
"
before
:
{
canShowLessFrequently
:
true
showLessFrequentlyCount
:
1
minKeywordLength
:
4
}
after
:
{
canShowLessFrequently
:
true
showLessFrequentlyCount
:
2
minKeywordLength
:
6
}
}
{
input
:
"
sports
"
before
:
{
canShowLessFrequently
:
true
showLessFrequentlyCount
:
2
minKeywordLength
:
6
}
after
:
{
canShowLessFrequently
:
false
showLessFrequentlyCount
:
3
minKeywordLength
:
7
}
}
]
;
for
(
let
{
input
before
after
}
of
testData
)
{
let
feature
=
QuickSuggest
.
getFeature
(
"
SportsSuggestions
"
)
;
await
check_results
(
{
context
:
createContext
(
input
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
result
]
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
sports
.
minKeywordLength
"
)
before
.
minKeywordLength
)
;
Assert
.
equal
(
feature
.
canShowLessFrequently
before
.
canShowLessFrequently
)
;
Assert
.
equal
(
feature
.
showLessFrequentlyCount
before
.
showLessFrequentlyCount
)
;
triggerCommand
(
{
result
feature
command
:
"
show_less_frequently
"
searchString
:
input
}
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
sports
.
minKeywordLength
"
)
after
.
minKeywordLength
)
;
Assert
.
equal
(
feature
.
canShowLessFrequently
after
.
canShowLessFrequently
)
;
Assert
.
equal
(
feature
.
showLessFrequentlyCount
after
.
showLessFrequentlyCount
)
;
await
check_results
(
{
context
:
createContext
(
input
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
]
}
)
;
}
await
cleanUpNimbus
(
)
;
UrlbarPrefs
.
clear
(
"
sports
.
showLessFrequentlyCount
"
)
;
UrlbarPrefs
.
clear
(
"
sports
.
minKeywordLength
"
)
;
}
)
;
let
gSandbox
;
let
gDateStub
;
function
setNow
(
dateStr
)
{
if
(
!
dateStr
)
{
gSandbox
?
.
restore
(
)
;
return
null
;
}
let
global
=
Cu
.
getGlobalForObject
(
SportsSuggestions
)
;
if
(
!
gSandbox
)
{
gSandbox
=
sinon
.
createSandbox
(
)
;
gDateStub
=
gSandbox
.
stub
(
SportsSuggestions
"
_zonedDateTimeISO
"
)
;
}
let
zonedNow
=
global
.
Temporal
.
ZonedDateTime
.
from
(
dateStr
)
;
gDateStub
.
returns
(
zonedNow
)
;
return
zonedNow
;
}
function
merinoSuggestions
(
values
)
{
return
[
{
provider
:
"
sports
"
is_sponsored
:
false
score
:
0
.
2
title
:
"
"
custom_details
:
{
sports
:
{
values
}
}
}
]
;
}
function
expectedResult
(
expectedItems
)
{
return
{
type
:
UrlbarUtils
.
RESULT_TYPE
.
DYNAMIC
source
:
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
isBestMatch
:
true
hideRowLabel
:
true
rowIndex
:
-
1
heuristic
:
false
exposureTelemetry
:
0
payload
:
{
items
:
expectedItems
source
:
"
merino
"
provider
:
"
sports
"
telemetryType
:
"
sports
"
isSponsored
:
false
engine
:
Services
.
search
.
defaultEngine
.
name
dynamicType
:
"
realtime
-
sports
"
}
}
;
}
