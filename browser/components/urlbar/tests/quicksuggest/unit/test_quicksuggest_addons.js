"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
AddonManager
:
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
sys
.
mjs
"
ExtensionTestCommon
:
"
resource
:
/
/
testing
-
common
/
ExtensionTestCommon
.
sys
.
mjs
"
}
)
;
const
MERINO_SUGGESTIONS
=
[
{
provider
:
"
amo
"
icon
:
"
icon
"
url
:
"
url
"
title
:
"
title
"
description
:
"
description
"
is_top_pick
:
true
custom_details
:
{
amo
:
{
rating
:
"
5
"
number_of_ratings
:
"
1234567
"
guid
:
"
test
addon
"
}
}
}
]
;
const
REMOTE_SETTINGS_RESULTS
=
[
{
type
:
"
amo
-
suggestions
"
attachment
:
[
{
url
:
"
https
:
/
/
example
.
com
/
first
-
addon
"
guid
:
"
first
addon
"
icon
:
"
https
:
/
/
example
.
com
/
first
-
addon
.
svg
"
title
:
"
First
Addon
"
rating
:
"
4
.
7
"
keywords
:
[
"
first
"
"
1st
"
"
two
words
"
"
a
b
c
"
]
description
:
"
Description
for
the
First
Addon
"
number_of_ratings
:
1256
is_top_pick
:
true
}
{
url
:
"
https
:
/
/
example
.
com
/
second
-
addon
"
guid
:
"
second
addon
"
icon
:
"
https
:
/
/
example
.
com
/
second
-
addon
.
svg
"
title
:
"
Second
Addon
"
rating
:
"
1
.
7
"
keywords
:
[
"
second
"
"
2nd
"
]
description
:
"
Description
for
the
Second
Addon
"
number_of_ratings
:
256
is_top_pick
:
false
}
{
url
:
"
https
:
/
/
example
.
com
/
third
-
addon
"
guid
:
"
third
addon
"
icon
:
"
https
:
/
/
example
.
com
/
third
-
addon
.
svg
"
title
:
"
Third
Addon
"
rating
:
"
3
.
7
"
keywords
:
[
"
third
"
"
3rd
"
]
description
:
"
Description
for
the
Third
Addon
"
number_of_ratings
:
3
}
]
}
]
;
add_setup
(
async
function
init
(
)
{
UrlbarPrefs
.
set
(
"
quicksuggest
.
enabled
"
true
)
;
UrlbarPrefs
.
set
(
"
bestMatch
.
enabled
"
true
)
;
UrlbarPrefs
.
set
(
"
suggest
.
quicksuggest
.
nonsponsored
"
true
)
;
UrlbarPrefs
.
set
(
"
addons
.
featureGate
"
true
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
search
.
suggest
.
enabled
"
false
)
;
await
QuickSuggestTestUtils
.
ensureQuickSuggestInit
(
{
remoteSettingsResults
:
REMOTE_SETTINGS_RESULTS
merinoSuggestions
:
MERINO_SUGGESTIONS
}
)
;
}
)
;
add_task
(
async
function
telemetryType
(
)
{
Assert
.
equal
(
QuickSuggest
.
getFeature
(
"
AddonSuggestions
"
)
.
getSuggestionTelemetryType
(
{
}
)
"
amo
"
"
Telemetry
type
should
be
'
amo
'
"
)
;
}
)
;
add_task
(
async
function
nonsponsoredDisabled
(
)
{
UrlbarPrefs
.
set
(
"
suggest
.
quicksuggest
.
sponsored
"
false
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
makeExpectedResult
(
{
suggestion
:
MERINO_SUGGESTIONS
[
0
]
source
:
"
merino
"
isTopPick
:
true
}
)
]
}
)
;
UrlbarPrefs
.
set
(
"
suggest
.
quicksuggest
.
nonsponsored
"
false
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
]
}
)
;
UrlbarPrefs
.
set
(
"
suggest
.
quicksuggest
.
nonsponsored
"
true
)
;
UrlbarPrefs
.
clear
(
"
suggest
.
quicksuggest
.
sponsored
"
)
;
}
)
;
add_task
(
async
function
addonSuggestionsSpecificPrefDisabled
(
)
{
const
prefs
=
[
"
suggest
.
addons
"
"
addons
.
featureGate
"
]
;
for
(
const
pref
of
prefs
)
{
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
makeExpectedResult
(
{
suggestion
:
MERINO_SUGGESTIONS
[
0
]
source
:
"
merino
"
isTopPick
:
true
}
)
]
}
)
;
UrlbarPrefs
.
set
(
pref
false
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
]
}
)
;
UrlbarPrefs
.
set
(
pref
true
)
;
}
}
)
;
add_task
(
async
function
nimbus
(
)
{
UrlbarPrefs
.
set
(
"
addons
.
featureGate
"
false
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
]
}
)
;
const
cleanUpNimbusEnable
=
await
UrlbarTestUtils
.
initNimbusFeature
(
{
addonsFeatureGate
:
true
}
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
makeExpectedResult
(
{
suggestion
:
MERINO_SUGGESTIONS
[
0
]
source
:
"
merino
"
isTopPick
:
true
}
)
]
}
)
;
await
cleanUpNimbusEnable
(
)
;
UrlbarPrefs
.
set
(
"
addons
.
featureGate
"
true
)
;
const
cleanUpNimbusDisable
=
await
UrlbarTestUtils
.
initNimbusFeature
(
{
addonsFeatureGate
:
false
}
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
]
}
)
;
await
cleanUpNimbusDisable
(
)
;
UrlbarPrefs
.
set
(
"
addons
.
featureGate
"
true
)
;
}
)
;
add_task
(
async
function
hideIfAlreadyInstalled
(
)
{
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
makeExpectedResult
(
{
suggestion
:
MERINO_SUGGESTIONS
[
0
]
source
:
"
merino
"
isTopPick
:
true
}
)
]
}
)
;
const
xpi
=
ExtensionTestCommon
.
generateXPI
(
{
manifest
:
{
browser_specific_settings
:
{
gecko
:
{
id
:
"
test
addon
"
}
}
}
}
)
;
const
addon
=
await
AddonManager
.
installTemporaryAddon
(
xpi
)
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
]
}
)
;
await
addon
.
uninstall
(
)
;
xpi
.
remove
(
false
)
;
}
)
;
add_task
(
async
function
remoteSettings
(
)
{
const
testCases
=
[
{
input
:
"
f
"
expected
:
null
}
{
input
:
"
fi
"
expected
:
null
}
{
input
:
"
fir
"
expected
:
null
}
{
input
:
"
firs
"
expected
:
null
}
{
input
:
"
first
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
1st
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
t
"
expected
:
null
}
{
input
:
"
tw
"
expected
:
null
}
{
input
:
"
two
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
two
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
two
w
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
two
wo
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
two
wor
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
two
word
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
two
words
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
a
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
a
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
a
b
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
a
b
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
a
b
c
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
second
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
1
]
source
:
"
remote
-
settings
"
isTopPick
:
false
}
)
}
{
input
:
"
2nd
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
1
]
source
:
"
remote
-
settings
"
isTopPick
:
false
}
)
}
{
input
:
"
third
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
2
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
{
input
:
"
3rd
"
expected
:
makeExpectedResult
(
{
suggestion
:
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
2
]
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
}
]
;
UrlbarPrefs
.
set
(
"
quicksuggest
.
dataCollection
.
enabled
"
false
)
;
for
(
const
{
input
expected
}
of
testCases
)
{
await
check_results
(
{
context
:
createContext
(
input
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
expected
?
[
expected
]
:
[
]
}
)
;
}
UrlbarPrefs
.
set
(
"
quicksuggest
.
dataCollection
.
enabled
"
true
)
;
}
)
;
add_task
(
async
function
merinoIsTopPick
(
)
{
const
suggestion
=
JSON
.
parse
(
JSON
.
stringify
(
MERINO_SUGGESTIONS
[
0
]
)
)
;
suggestion
.
is_top_pick
=
false
;
MerinoTestUtils
.
server
.
response
.
body
.
suggestions
=
[
suggestion
]
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
makeExpectedResult
(
{
suggestion
source
:
"
merino
"
isTopPick
:
false
}
)
]
}
)
;
delete
suggestion
.
is_top_pick
;
MerinoTestUtils
.
server
.
response
.
body
.
suggestions
=
[
suggestion
]
;
await
check_results
(
{
context
:
createContext
(
"
test
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
[
makeExpectedResult
(
{
suggestion
source
:
"
merino
"
isTopPick
:
true
}
)
]
}
)
;
}
)
;
add_task
(
async
function
showLessFrequently_rs
(
)
{
await
doShowLessFrequentlyTest
(
{
rs
:
{
show_less_frequently_cap
:
3
}
tests
:
[
{
showLessFrequentlyCount
:
0
canShowLessFrequently
:
true
searches
:
{
f
:
false
fi
:
false
fir
:
false
firs
:
false
first
:
true
t
:
false
tw
:
false
two
:
true
"
two
"
:
true
"
two
w
"
:
true
"
two
wo
"
:
true
"
two
wor
"
:
true
"
two
word
"
:
true
"
two
words
"
:
true
a
:
true
"
a
"
:
true
"
a
b
"
:
true
"
a
b
"
:
true
"
a
b
c
"
:
true
}
}
{
showLessFrequentlyCount
:
1
canShowLessFrequently
:
true
searches
:
{
first
:
false
two
:
false
a
:
false
}
}
{
showLessFrequentlyCount
:
2
canShowLessFrequently
:
true
searches
:
{
"
two
"
:
false
"
a
"
:
false
}
}
{
showLessFrequentlyCount
:
3
canShowLessFrequently
:
false
searches
:
{
"
two
w
"
:
false
"
a
b
"
:
false
}
}
{
showLessFrequentlyCount
:
3
canShowLessFrequently
:
false
searches
:
{
}
}
]
}
)
;
}
)
;
add_task
(
async
function
showLessFrequently_nimbus
(
)
{
await
doShowLessFrequentlyTest
(
{
nimbus
:
{
addonsShowLessFrequentlyCap
:
3
}
rs
:
{
show_less_frequently_cap
:
10
}
tests
:
[
{
showLessFrequentlyCount
:
0
canShowLessFrequently
:
true
searches
:
{
a
:
true
"
a
"
:
true
"
a
b
"
:
true
"
a
b
"
:
true
"
a
b
c
"
:
true
}
}
{
showLessFrequentlyCount
:
1
canShowLessFrequently
:
true
searches
:
{
a
:
false
}
}
{
showLessFrequentlyCount
:
2
canShowLessFrequently
:
true
searches
:
{
"
a
"
:
false
}
}
{
showLessFrequentlyCount
:
3
canShowLessFrequently
:
false
searches
:
{
"
a
b
"
:
false
}
}
{
showLessFrequentlyCount
:
3
canShowLessFrequently
:
false
searches
:
{
}
}
]
}
)
;
}
)
;
async
function
doShowLessFrequentlyTest
(
{
tests
rs
=
{
}
nimbus
=
{
}
}
)
{
UrlbarPrefs
.
set
(
"
quicksuggest
.
dataCollection
.
enabled
"
false
)
;
let
suggestion
=
REMOTE_SETTINGS_RESULTS
[
0
]
.
attachment
[
0
]
;
let
addonSuggestions
=
QuickSuggest
.
getFeature
(
"
AddonSuggestions
"
)
;
let
cleanUpNimbus
=
await
UrlbarTestUtils
.
initNimbusFeature
(
nimbus
)
;
await
QuickSuggestTestUtils
.
withConfig
(
{
config
:
rs
callback
:
async
(
)
=
>
{
let
cumulativeSearches
=
{
}
;
for
(
let
{
showLessFrequentlyCount
canShowLessFrequently
searches
}
of
tests
)
{
Assert
.
equal
(
addonSuggestions
.
showLessFrequentlyCount
showLessFrequentlyCount
"
showLessFrequentlyCount
should
be
correct
initially
"
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
addons
.
showLessFrequentlyCount
"
)
showLessFrequentlyCount
"
Pref
should
be
correct
initially
"
)
;
Assert
.
equal
(
addonSuggestions
.
canShowLessFrequently
canShowLessFrequently
"
canShowLessFrequently
should
be
correct
initially
"
)
;
cumulativeSearches
=
{
.
.
.
cumulativeSearches
.
.
.
searches
}
;
for
(
let
[
searchString
isExpected
]
of
Object
.
entries
(
cumulativeSearches
)
)
{
await
check_results
(
{
context
:
createContext
(
searchString
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
!
isExpected
?
[
]
:
[
makeExpectedResult
(
{
suggestion
source
:
"
remote
-
settings
"
isTopPick
:
true
}
)
]
}
)
;
}
addonSuggestions
.
incrementShowLessFrequentlyCount
(
)
;
}
}
}
)
;
await
cleanUpNimbus
(
)
;
UrlbarPrefs
.
clear
(
"
addons
.
showLessFrequentlyCount
"
)
;
UrlbarPrefs
.
set
(
"
quicksuggest
.
dataCollection
.
enabled
"
true
)
;
}
function
makeExpectedResult
(
{
suggestion
source
isTopPick
}
)
{
let
provider
;
let
rating
;
let
number_of_ratings
;
if
(
source
=
=
=
"
remote
-
settings
"
)
{
provider
=
"
AddonSuggestions
"
;
rating
=
suggestion
.
rating
;
number_of_ratings
=
suggestion
.
number_of_ratings
;
}
else
{
provider
=
"
amo
"
;
rating
=
suggestion
.
custom_details
.
amo
.
rating
;
number_of_ratings
=
suggestion
.
custom_details
.
amo
.
number_of_ratings
;
}
return
{
isBestMatch
:
isTopPick
suggestedIndex
:
isTopPick
?
1
:
-
1
type
:
UrlbarUtils
.
RESULT_TYPE
.
DYNAMIC
source
:
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
heuristic
:
false
payload
:
{
telemetryType
:
"
amo
"
dynamicType
:
"
addons
"
title
:
suggestion
.
title
url
:
suggestion
.
url
displayUrl
:
suggestion
.
url
.
replace
(
/
^
https
:
\
/
\
/
/
"
"
)
icon
:
suggestion
.
icon
description
:
suggestion
.
description
rating
:
Number
(
rating
)
reviews
:
Number
(
number_of_ratings
)
shouldNavigate
:
true
helpUrl
:
QuickSuggest
.
HELP_URL
source
provider
}
}
;
}
