"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
ExperimentManager
:
"
resource
:
/
/
nimbus
/
lib
/
ExperimentManager
.
sys
.
mjs
"
}
)
;
const
REMOTE_SETTINGS_RECORDS
=
[
{
type
:
"
exposure
-
suggestions
"
suggestion_type
:
"
aaa
"
attachment
:
{
keywords
:
[
"
aaa
keyword
"
"
aaa
bbb
keyword
"
"
amp
"
"
wikipedia
"
]
}
}
{
type
:
"
exposure
-
suggestions
"
suggestion_type
:
"
bbb
"
attachment
:
{
keywords
:
[
"
bbb
keyword
"
"
aaa
bbb
keyword
"
"
amp
"
"
wikipedia
"
]
}
}
{
type
:
"
data
"
attachment
:
[
QuickSuggestTestUtils
.
ampRemoteSettings
(
)
QuickSuggestTestUtils
.
wikipediaRemoteSettings
(
)
]
}
]
;
add_setup
(
async
function
(
)
{
info
(
"
Awaiting
ExperimentManager
.
onStartup
"
)
;
await
ExperimentManager
.
onStartup
(
)
;
info
(
"
Done
awaiting
ExperimentManager
.
onStartup
"
)
;
await
QuickSuggestTestUtils
.
ensureQuickSuggestInit
(
{
remoteSettingsRecords
:
REMOTE_SETTINGS_RECORDS
}
)
;
UrlbarPrefs
.
clear
(
"
quicksuggest
.
enabled
"
)
;
}
)
;
add_task
(
async
function
suggestEnabledLocales
(
)
{
let
tests
=
[
{
homeRegion
:
"
US
"
locales
:
[
"
en
-
US
"
"
en
-
CA
"
"
en
-
GB
"
]
expectedQuickSuggestEnabled
:
true
queries
:
[
{
query
:
"
amp
"
expectedResults
:
[
QuickSuggestTestUtils
.
ampResult
(
)
makeExpectedExposureResult
(
"
bbb
"
)
makeExpectedExposureResult
(
"
aaa
"
)
]
}
{
query
:
"
wikipedia
"
expectedResults
:
[
QuickSuggestTestUtils
.
wikipediaResult
(
)
makeExpectedExposureResult
(
"
bbb
"
)
makeExpectedExposureResult
(
"
aaa
"
)
]
}
{
query
:
"
aaa
keyword
"
expectedResults
:
[
makeExpectedExposureResult
(
"
aaa
"
)
]
}
{
query
:
"
aaa
bbb
keyword
"
expectedResults
:
[
makeExpectedExposureResult
(
"
bbb
"
)
makeExpectedExposureResult
(
"
aaa
"
)
]
}
]
}
]
;
for
(
let
test
of
tests
)
{
await
doLocaleTest
(
test
)
;
}
}
)
;
add_task
(
async
function
suggestDisabledLocales
(
)
{
let
queries
=
[
{
query
:
"
amp
"
expectedResults
:
[
makeExpectedExposureResult
(
"
bbb
"
)
makeExpectedExposureResult
(
"
aaa
"
)
]
}
{
query
:
"
wikipedia
"
expectedResults
:
[
makeExpectedExposureResult
(
"
bbb
"
)
makeExpectedExposureResult
(
"
aaa
"
)
]
}
{
query
:
"
aaa
keyword
"
expectedResults
:
[
makeExpectedExposureResult
(
"
aaa
"
)
]
}
{
query
:
"
aaa
bbb
keyword
"
expectedResults
:
[
makeExpectedExposureResult
(
"
bbb
"
)
makeExpectedExposureResult
(
"
aaa
"
)
]
}
]
;
let
tests
=
[
{
homeRegion
:
"
US
"
locales
:
[
"
de
"
"
fr
"
"
ja
"
]
expectedQuickSuggestEnabled
:
false
queries
}
{
homeRegion
:
"
CA
"
locales
:
[
"
en
-
US
"
"
en
-
CA
"
"
en
-
GB
"
"
fr
"
]
expectedQuickSuggestEnabled
:
false
queries
}
{
homeRegion
:
"
DE
"
locales
:
[
"
de
"
"
en
-
US
"
"
fr
"
]
expectedQuickSuggestEnabled
:
false
queries
}
]
;
for
(
let
test
of
tests
)
{
await
doLocaleTest
(
test
)
;
}
}
)
;
async
function
doLocaleTest
(
{
homeRegion
locales
expectedQuickSuggestEnabled
queries
}
)
{
for
(
let
locale
of
locales
)
{
info
(
"
Doing
locale
test
:
"
+
JSON
.
stringify
(
{
homeRegion
locale
}
)
)
;
await
QuickSuggestTestUtils
.
withLocales
(
{
homeRegion
locales
:
[
locale
]
callback
:
async
(
)
=
>
{
info
(
"
Updating
Suggest
scenario
"
)
;
await
UrlbarPrefs
.
updateFirefoxSuggestScenario
(
)
;
info
(
"
Done
updating
Suggest
scenario
"
)
;
assertSuggestPrefs
(
expectedQuickSuggestEnabled
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
quickSuggestEnabled
"
)
expectedQuickSuggestEnabled
"
quickSuggestEnabled
Nimbus
variable
should
be
correct
after
setting
locale
"
)
;
let
nimbusCleanup
=
await
UrlbarTestUtils
.
initNimbusFeature
(
{
quickSuggestEnabled
:
true
quickSuggestExposureSuggestionTypes
:
"
aaa
bbb
"
}
)
;
await
QuickSuggestTestUtils
.
forceSync
(
)
;
assertSuggestPrefs
(
expectedQuickSuggestEnabled
)
;
Assert
.
ok
(
UrlbarPrefs
.
get
(
"
quickSuggestEnabled
"
)
"
quickSuggestEnabled
Nimbus
variable
should
be
enabled
after
installing
experiment
"
)
;
for
(
let
{
query
expectedResults
}
of
queries
)
{
await
check_results
(
{
context
:
createContext
(
query
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
matches
:
expectedResults
}
)
;
}
await
nimbusCleanup
(
)
;
await
QuickSuggestTestUtils
.
forceSync
(
)
;
}
}
)
;
}
await
UrlbarPrefs
.
updateFirefoxSuggestScenario
(
)
;
}
function
assertSuggestPrefs
(
expectedEnabled
)
{
let
prefs
=
[
"
browser
.
urlbar
.
quicksuggest
.
enabled
"
"
browser
.
urlbar
.
suggest
.
quicksuggest
.
sponsored
"
"
browser
.
urlbar
.
suggest
.
quicksuggest
.
nonsponsored
"
]
;
for
(
let
p
of
prefs
)
{
Assert
.
equal
(
Services
.
prefs
.
getDefaultBranch
(
"
"
)
.
getBoolPref
(
p
)
expectedEnabled
"
Default
-
branch
value
should
be
correct
:
"
+
p
)
;
Assert
.
equal
(
Services
.
prefs
.
getBranch
(
"
"
)
.
getBoolPref
(
p
)
expectedEnabled
"
User
-
branch
value
should
be
correct
:
"
+
p
)
;
}
}
function
makeExpectedExposureResult
(
exposureSuggestionType
)
{
return
{
type
:
UrlbarUtils
.
RESULT_TYPE
.
DYNAMIC
source
:
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
heuristic
:
false
exposureTelemetry
:
UrlbarUtils
.
EXPOSURE_TELEMETRY
.
HIDDEN
payload
:
{
exposureSuggestionType
source
:
"
rust
"
dynamicType
:
"
exposure
"
provider
:
"
Exposure
"
telemetryType
:
"
exposure
"
}
}
;
}
