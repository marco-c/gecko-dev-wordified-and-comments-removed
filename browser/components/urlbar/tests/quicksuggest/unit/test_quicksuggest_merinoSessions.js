"
use
strict
"
;
add_setup
(
async
(
)
=
>
{
await
MerinoTestUtils
.
server
.
start
(
)
;
await
QuickSuggestTestUtils
.
ensureQuickSuggestInit
(
{
prefs
:
[
[
"
suggest
.
quicksuggest
.
sponsored
"
true
]
[
"
quicksuggest
.
dataCollection
.
enabled
"
true
]
]
}
)
;
}
)
;
add_task
(
async
function
singleEngagement
(
)
{
let
controller
=
UrlbarTestUtils
.
newMockController
(
)
;
for
(
let
i
=
0
;
i
<
3
;
i
+
+
)
{
let
searchString
=
"
search
"
+
i
;
await
controller
.
startQuery
(
createContext
(
searchString
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
)
;
MerinoTestUtils
.
server
.
checkAndClearRequests
(
[
{
params
:
{
[
MerinoTestUtils
.
SEARCH_PARAMS
.
QUERY
]
:
searchString
[
MerinoTestUtils
.
SEARCH_PARAMS
.
SEQUENCE_NUMBER
]
:
i
}
}
]
)
;
}
endEngagement
(
{
controller
}
)
;
}
)
;
add_task
(
async
function
manyEngagements_engagement
(
)
{
await
doManyEngagementsTest
(
"
engagement
"
)
;
}
)
;
add_task
(
async
function
manyEngagements_abandonment
(
)
{
await
doManyEngagementsTest
(
"
abandonment
"
)
;
}
)
;
async
function
doManyEngagementsTest
(
state
)
{
let
controller
=
UrlbarTestUtils
.
newMockController
(
)
;
for
(
let
i
=
0
;
i
<
3
;
i
+
+
)
{
let
searchString
=
"
search
"
+
i
;
let
context
=
createContext
(
searchString
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
;
await
controller
.
startQuery
(
context
)
;
MerinoTestUtils
.
server
.
checkAndClearRequests
(
[
{
params
:
{
[
MerinoTestUtils
.
SEARCH_PARAMS
.
QUERY
]
:
searchString
[
MerinoTestUtils
.
SEARCH_PARAMS
.
SEQUENCE_NUMBER
]
:
0
}
}
]
)
;
endEngagement
(
{
context
state
controller
}
)
;
}
}
add_task
(
async
function
canceledQueries
(
)
{
let
controller
=
UrlbarTestUtils
.
newMockController
(
)
;
for
(
let
i
=
0
;
i
<
3
;
i
+
+
)
{
MerinoTestUtils
.
server
.
response
.
delay
=
UrlbarPrefs
.
get
(
"
merino
.
timeoutMs
"
)
;
let
requestPromise
=
MerinoTestUtils
.
server
.
waitForNextRequest
(
)
;
let
searchString1
=
"
search
"
+
i
;
controller
.
startQuery
(
createContext
(
searchString1
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
)
;
await
requestPromise
;
delete
MerinoTestUtils
.
server
.
response
.
delay
;
let
searchString2
=
searchString1
+
"
again
"
;
await
controller
.
startQuery
(
createContext
(
searchString2
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
)
;
MerinoTestUtils
.
server
.
checkAndClearRequests
(
[
{
params
:
{
[
MerinoTestUtils
.
SEARCH_PARAMS
.
QUERY
]
:
searchString1
[
MerinoTestUtils
.
SEARCH_PARAMS
.
SEQUENCE_NUMBER
]
:
2
*
i
}
}
{
params
:
{
[
MerinoTestUtils
.
SEARCH_PARAMS
.
QUERY
]
:
searchString2
[
MerinoTestUtils
.
SEARCH_PARAMS
.
SEQUENCE_NUMBER
]
:
2
*
i
+
1
}
}
]
)
;
}
endEngagement
(
{
controller
}
)
;
}
)
;
function
endEngagement
(
{
controller
context
=
null
state
=
"
engagement
"
}
)
{
context
|
|
=
createContext
(
"
endEngagement
"
{
providers
:
[
UrlbarProviderQuickSuggest
.
name
]
isPrivate
:
false
}
)
;
let
details
=
{
selIndex
:
-
1
result
:
{
payload
:
{
}
}
}
;
let
quickSuggestProviderInstance
=
UrlbarProvidersManager
.
getProvider
(
UrlbarProviderQuickSuggest
.
name
)
;
switch
(
state
)
{
case
"
engagement
"
:
quickSuggestProviderInstance
.
onEngagement
(
context
controller
details
)
;
quickSuggestProviderInstance
.
onSearchSessionEnd
(
context
controller
details
)
;
break
;
case
"
abandonment
"
:
quickSuggestProviderInstance
.
onSearchSessionEnd
(
context
controller
details
)
;
break
;
default
:
throw
new
Error
(
"
Unrecognized
engagement
state
:
"
+
state
)
;
}
Assert
.
strictEqual
(
merinoClient
(
)
.
sessionID
null
"
sessionID
is
null
after
engagement
"
)
;
Assert
.
strictEqual
(
merinoClient
(
)
.
_test_sessionTimer
null
"
sessionTimer
is
null
after
engagement
"
)
;
}
function
merinoClient
(
)
{
return
QuickSuggest
.
getFeature
(
"
SuggestBackendMerino
"
)
?
.
client
;
}
