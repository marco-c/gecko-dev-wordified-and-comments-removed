"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
EnterprisePolicyTesting
:
"
resource
:
/
/
testing
-
common
/
EnterprisePolicyTesting
.
sys
.
mjs
"
sinon
:
"
resource
:
/
/
testing
-
common
/
Sinon
.
sys
.
mjs
"
}
)
;
const
POLICY_PREF
=
"
suggest
.
quicksuggest
.
nonsponsored
"
;
let
gDefaultBranch
=
Services
.
prefs
.
getDefaultBranch
(
"
browser
.
urlbar
.
"
)
;
let
gUserBranch
=
Services
.
prefs
.
getBranch
(
"
browser
.
urlbar
.
"
)
;
add_setup
(
async
function
(
)
{
await
QuickSuggestTestUtils
.
ensureQuickSuggestInit
(
)
;
}
)
;
add_task
(
async
function
test_indexes
(
)
{
await
QuickSuggestTestUtils
.
withExperiment
(
{
valueOverrides
:
{
quickSuggestNonSponsoredIndex
:
99
quickSuggestSponsoredIndex
:
-
1337
}
callback
:
(
)
=
>
{
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
quickSuggestNonSponsoredIndex
"
)
99
"
quickSuggestNonSponsoredIndex
"
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
quickSuggestSponsoredIndex
"
)
-
1337
"
quickSuggestSponsoredIndex
"
)
;
}
}
)
;
}
)
;
add_task
(
async
function
test_merino
(
)
{
await
QuickSuggestTestUtils
.
withExperiment
(
{
valueOverrides
:
{
merinoEndpointURL
:
"
http
:
/
/
example
.
com
/
test_merino_config
"
merinoClientVariants
:
"
test
-
client
-
variants
"
merinoProviders
:
"
test
-
providers
"
}
callback
:
(
)
=
>
{
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
merinoEndpointURL
"
)
"
http
:
/
/
example
.
com
/
test_merino_config
"
"
merinoEndpointURL
"
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
merinoClientVariants
"
)
"
test
-
client
-
variants
"
"
merinoClientVariants
"
)
;
Assert
.
equal
(
UrlbarPrefs
.
get
(
"
merinoProviders
"
)
"
test
-
providers
"
"
merinoProviders
"
)
;
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
[
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
valueOverrides
:
{
quickSuggestNonSponsoredEnabled
:
false
quickSuggestSponsoredEnabled
:
false
}
expectedPrefs
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
{
initialPrefsToSet
:
{
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
valueOverrides
:
{
quickSuggestNonSponsoredEnabled
:
false
quickSuggestSponsoredEnabled
:
false
}
expectedPrefs
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
}
]
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
valueOverrides
:
{
quickSuggestNonSponsoredEnabled
:
true
quickSuggestSponsoredEnabled
:
true
}
expectedPrefs
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
[
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
valueOverrides
:
{
quickSuggestNonSponsoredEnabled
:
true
quickSuggestSponsoredEnabled
:
true
}
expectedPrefs
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
}
{
initialPrefsToSet
:
{
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
valueOverrides
:
{
quickSuggestNonSponsoredEnabled
:
true
quickSuggestSponsoredEnabled
:
true
}
expectedPrefs
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
]
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
valueOverrides
:
{
quickSuggestNonSponsoredEnabled
:
false
quickSuggestSponsoredEnabled
:
false
}
expectedPrefs
:
{
defaultBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
userBranch
:
{
"
suggest
.
quicksuggest
.
nonsponsored
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
[
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
valueOverrides
:
{
quickSuggestDataCollectionEnabled
:
false
}
expectedPrefs
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
}
}
]
[
{
initialPrefsToSet
:
{
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
valueOverrides
:
{
quickSuggestDataCollectionEnabled
:
false
}
expectedPrefs
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
}
]
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
}
valueOverrides
:
{
quickSuggestDataCollectionEnabled
:
true
}
expectedPrefs
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
[
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
}
valueOverrides
:
{
quickSuggestDataCollectionEnabled
:
true
}
expectedPrefs
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
}
]
[
{
initialPrefsToSet
:
{
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
}
valueOverrides
:
{
quickSuggestDataCollectionEnabled
:
true
}
expectedPrefs
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
}
}
]
)
;
}
)
;
add_task
(
async
function
(
)
{
await
checkEnrollments
(
{
initialPrefsToSet
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
valueOverrides
:
{
quickSuggestDataCollectionEnabled
:
false
}
expectedPrefs
:
{
defaultBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
false
}
userBranch
:
{
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
}
)
;
}
)
;
async
function
checkEnrollments
(
options
)
{
info
(
"
Testing
:
"
+
JSON
.
stringify
(
options
)
)
;
let
enrollments
;
if
(
Array
.
isArray
(
options
)
)
{
enrollments
=
options
;
}
else
{
enrollments
=
[
options
]
;
}
for
(
let
i
=
0
;
i
<
enrollments
.
length
;
i
+
+
)
{
info
(
Starting
setup
for
enrollment
{
i
}
:
+
JSON
.
stringify
(
enrollments
[
i
]
)
)
;
let
{
initialPrefsToSet
valueOverrides
expectedPrefs
}
=
enrollments
[
i
]
;
let
{
defaultBranch
:
initialDefaultBranch
userBranch
:
initialUserBranch
}
=
initialPrefsToSet
;
initialDefaultBranch
=
initialDefaultBranch
|
|
{
}
;
initialUserBranch
=
initialUserBranch
|
|
{
}
;
for
(
let
name
of
Object
.
keys
(
initialDefaultBranch
)
)
{
gUserBranch
.
clearUserPref
(
name
)
;
}
for
(
let
[
branch
prefs
]
of
[
[
gDefaultBranch
initialDefaultBranch
]
[
gUserBranch
initialUserBranch
]
]
)
{
for
(
let
[
name
value
]
of
Object
.
entries
(
prefs
)
)
{
branch
.
setBoolPref
(
name
value
)
;
}
}
let
{
defaultBranch
:
expectedDefaultBranch
userBranch
:
expectedUserBranch
}
=
expectedPrefs
;
expectedDefaultBranch
=
expectedDefaultBranch
|
|
{
}
;
expectedUserBranch
=
expectedUserBranch
|
|
{
}
;
info
(
Installing
experiment
for
enrollment
{
i
}
)
;
await
QuickSuggestTestUtils
.
withExperiment
(
{
valueOverrides
callback
:
(
)
=
>
{
info
(
Installed
experiment
for
enrollment
{
i
}
now
checking
prefs
)
;
let
expectedEffectivePrefs
=
{
}
;
for
(
let
[
branch
prefs
branchType
]
of
[
[
gDefaultBranch
expectedDefaultBranch
"
default
"
]
[
gUserBranch
expectedUserBranch
"
user
"
]
]
)
{
for
(
let
[
name
value
]
of
Object
.
entries
(
prefs
)
)
{
expectedEffectivePrefs
[
name
]
=
value
;
Assert
.
equal
(
branch
.
getBoolPref
(
name
)
value
Pref
{
name
}
on
{
branchType
}
branch
)
;
if
(
branch
=
=
gUserBranch
)
{
Assert
.
ok
(
gUserBranch
.
prefHasUserValue
(
name
)
Pref
{
name
}
is
on
user
branch
)
;
}
}
}
for
(
let
name
of
Object
.
keys
(
initialDefaultBranch
)
)
{
if
(
!
expectedUserBranch
.
hasOwnProperty
(
name
)
)
{
Assert
.
ok
(
!
gUserBranch
.
prefHasUserValue
(
name
)
Pref
{
name
}
is
not
on
user
branch
)
;
}
}
for
(
let
[
name
value
]
of
Object
.
entries
(
expectedEffectivePrefs
)
)
{
Assert
.
equal
(
UrlbarPrefs
.
get
(
name
)
value
Pref
{
name
}
effective
value
)
;
}
info
(
Uninstalling
experiment
for
enrollment
{
i
}
)
;
}
}
)
;
info
(
Uninstalled
experiment
for
enrollment
{
i
}
now
checking
prefs
)
;
let
effectivePrefs
=
QuickSuggest
.
intendedDefaultPrefs
(
"
US
"
"
en
-
US
"
)
;
for
(
let
[
name
value
]
of
Object
.
entries
(
expectedUserBranch
)
)
{
effectivePrefs
[
name
]
=
value
;
}
Assert
.
greater
(
Object
.
entries
(
effectivePrefs
)
.
length
0
"
Sanity
check
:
effectivePrefs
should
not
be
empty
"
)
;
for
(
let
[
name
value
]
of
Object
.
entries
(
effectivePrefs
)
)
{
Assert
.
equal
(
UrlbarPrefs
.
get
(
name
)
value
Pref
{
name
}
effective
value
after
unenrolling
)
;
}
for
(
let
name
of
Object
.
keys
(
expectedUserBranch
)
)
{
UrlbarPrefs
.
clear
(
name
)
;
}
}
}
add_task
(
async
function
(
)
{
await
doPolicyTest
(
{
prefPolicy
:
{
Status
:
"
locked
"
Value
:
false
}
expectedDefault
:
false
expectedUser
:
undefined
expectedLocked
:
true
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doPolicyTest
(
{
prefPolicy
:
{
Status
:
"
locked
"
Value
:
true
}
expectedDefault
:
true
expectedUser
:
undefined
expectedLocked
:
true
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doPolicyTest
(
{
prefPolicy
:
{
Status
:
"
default
"
Value
:
false
}
expectedDefault
:
false
expectedUser
:
undefined
expectedLocked
:
false
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doPolicyTest
(
{
prefPolicy
:
{
Status
:
"
default
"
Value
:
true
}
expectedDefault
:
true
expectedUser
:
undefined
expectedLocked
:
false
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doPolicyTest
(
{
prefPolicy
:
{
Status
:
"
user
"
Value
:
false
}
expectedDefault
:
true
expectedUser
:
false
expectedLocked
:
false
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doPolicyTest
(
{
prefPolicy
:
{
Status
:
"
user
"
Value
:
true
}
expectedDefault
:
true
expectedUser
:
true
expectedLocked
:
false
}
)
;
}
)
;
async
function
doPolicyTest
(
{
prefPolicy
expectedDefault
expectedUser
expectedLocked
}
)
{
info
(
"
Starting
pref
policy
test
:
"
+
JSON
.
stringify
(
{
prefPolicy
expectedDefault
expectedUser
expectedLocked
}
)
)
;
let
pref
=
POLICY_PREF
;
Assert
.
ok
(
gDefaultBranch
.
getBoolPref
(
pref
)
{
pref
}
is
initially
true
on
default
branch
(
assuming
en
-
US
)
)
;
Assert
.
ok
(
!
gUserBranch
.
prefHasUserValue
(
pref
)
{
pref
}
does
not
have
initial
user
value
)
;
await
EnterprisePolicyTesting
.
setupPolicyEngineWithJson
(
{
policies
:
{
Preferences
:
{
[
browser
.
urlbar
.
{
pref
}
]
:
prefPolicy
}
}
}
)
;
Assert
.
equal
(
Services
.
policies
.
status
Ci
.
nsIEnterprisePolicies
.
ACTIVE
"
Policy
engine
is
active
"
)
;
Assert
.
equal
(
gDefaultBranch
.
getBoolPref
(
pref
)
expectedDefault
{
pref
}
has
expected
default
-
branch
value
after
setting
policy
)
;
Assert
.
equal
(
gUserBranch
.
prefHasUserValue
(
pref
)
expectedUser
!
=
=
undefined
{
pref
}
is
on
user
branch
as
expected
after
setting
policy
)
;
if
(
expectedUser
!
=
=
undefined
)
{
Assert
.
equal
(
gUserBranch
.
getBoolPref
(
pref
)
expectedUser
{
pref
}
has
expected
user
-
branch
value
after
setting
policy
)
;
}
Assert
.
equal
(
gDefaultBranch
.
prefIsLocked
(
pref
)
expectedLocked
{
pref
}
is
locked
as
expected
after
setting
policy
)
;
await
EnterprisePolicyTesting
.
setupPolicyEngineWithJson
(
"
"
)
;
Assert
.
equal
(
Services
.
policies
.
status
Ci
.
nsIEnterprisePolicies
.
INACTIVE
"
Policy
engine
is
inactive
"
)
;
gDefaultBranch
.
unlockPref
(
pref
)
;
gUserBranch
.
clearUserPref
(
pref
)
;
await
QuickSuggest
.
_test_reinit
(
)
;
Assert
.
ok
(
!
gDefaultBranch
.
prefIsLocked
(
pref
)
{
pref
}
is
not
locked
after
cleanup
)
;
Assert
.
ok
(
gDefaultBranch
.
getBoolPref
(
pref
)
{
pref
}
is
true
on
default
branch
after
cleanup
(
assuming
en
-
US
)
)
;
Assert
.
ok
(
!
gUserBranch
.
prefHasUserValue
(
pref
)
{
pref
}
does
not
have
user
value
after
cleanup
)
;
}
