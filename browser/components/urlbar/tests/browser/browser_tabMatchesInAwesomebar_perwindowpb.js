"
use
strict
"
;
const
TEST_URL
=
{
TEST_BASE_URL
}
dummy_page
.
html
;
add_task
(
async
function
(
)
{
let
normalWindow
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
let
privateWindow
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
runTest
(
normalWindow
privateWindow
false
)
;
await
BrowserTestUtils
.
closeWindow
(
normalWindow
)
;
await
BrowserTestUtils
.
closeWindow
(
privateWindow
)
;
normalWindow
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
privateWindow
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
runTest
(
privateWindow
normalWindow
false
)
;
await
BrowserTestUtils
.
closeWindow
(
normalWindow
)
;
await
BrowserTestUtils
.
closeWindow
(
privateWindow
)
;
privateWindow
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
runTest
(
privateWindow
privateWindow
true
)
;
await
BrowserTestUtils
.
closeWindow
(
privateWindow
)
;
normalWindow
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
await
runTest
(
normalWindow
normalWindow
true
)
;
await
BrowserTestUtils
.
closeWindow
(
normalWindow
)
;
}
)
;
async
function
runTest
(
aSourceWindow
aDestWindow
aExpectSwitch
)
{
BrowserTestUtils
.
addTab
(
aSourceWindow
.
gBrowser
TEST_URL
{
userContextId
:
1
}
)
;
await
BrowserTestUtils
.
openNewForegroundTab
(
aSourceWindow
.
gBrowser
TEST_URL
)
;
let
testTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
aDestWindow
.
gBrowser
)
;
info
(
"
waiting
for
focus
on
the
window
"
)
;
await
SimpleTest
.
promiseFocus
(
aDestWindow
)
;
info
(
"
got
focus
on
the
window
"
)
;
aDestWindow
.
gBrowser
.
selectedTab
=
testTab
;
let
sessionHistoryCount
=
await
new
Promise
(
resolve
=
>
{
SessionStore
.
getSessionHistory
(
gBrowser
.
selectedTab
function
(
sessionHistory
)
{
resolve
(
sessionHistory
.
entries
.
length
)
;
}
)
;
}
)
;
Assert
.
less
(
sessionHistoryCount
2
The
test
tab
has
1
or
fewer
history
entries
.
sessionHistoryCount
=
{
sessionHistoryCount
}
)
;
is
(
testTab
.
linkedBrowser
.
currentURI
.
spec
"
about
:
blank
"
"
The
test
tab
is
on
about
:
blank
"
)
;
await
SpecialPowers
.
spawn
(
testTab
.
linkedBrowser
[
]
async
function
(
)
{
ok
(
!
content
.
document
.
body
.
hasChildNodes
(
)
"
The
test
tab
has
no
child
nodes
"
)
;
}
)
;
ok
(
!
testTab
.
hasAttribute
(
"
busy
"
)
"
The
test
tab
doesn
'
t
have
the
busy
attribute
"
)
;
let
searchString
=
TEST_URL
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
:
aDestWindow
value
:
searchString
}
)
;
info
(
awesomebar
popup
appeared
.
aExpectSwitch
:
{
aExpectSwitch
}
)
;
while
(
UrlbarTestUtils
.
getSelectedRowIndex
(
aDestWindow
)
<
UrlbarTestUtils
.
getResultCount
(
aDestWindow
)
-
1
)
{
info
(
"
handling
key
navigation
for
DOM_VK_DOWN
key
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
{
}
aDestWindow
)
;
}
let
awaitTabSwitch
;
if
(
aExpectSwitch
)
{
awaitTabSwitch
=
BrowserTestUtils
.
waitForTabClosing
(
testTab
)
;
}
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
{
}
aDestWindow
)
;
info
(
"
sent
Enter
command
to
the
controller
"
)
;
if
(
aExpectSwitch
)
{
await
awaitTabSwitch
;
}
else
{
await
BrowserTestUtils
.
browserLoaded
(
testTab
.
linkedBrowser
)
;
}
}
add_task
(
async
function
same_url_both_windows
(
)
{
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
win
.
gBrowser
TEST_URL
)
;
let
privateWin
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
BrowserTestUtils
.
openNewForegroundTab
(
privateWin
.
gBrowser
TEST_URL
)
;
await
BrowserTestUtils
.
openNewForegroundTab
(
win
.
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
:
win
value
:
"
dummy_page
"
}
)
;
Assert
.
equal
(
2
UrlbarTestUtils
.
getResultCount
(
win
)
"
Check
results
count
"
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
win
0
)
;
Assert
.
ok
(
result
.
heuristic
"
First
result
is
heuristic
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
win
1
)
;
Assert
.
equal
(
UrlbarUtils
.
RESULT_TYPE
.
TAB_SWITCH
result
.
type
"
Second
result
is
tab
switch
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
:
win
value
:
"
dummy_page
"
}
)
;
Assert
.
equal
(
2
UrlbarTestUtils
.
getResultCount
(
win
)
"
Check
results
count
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
win
0
)
;
Assert
.
ok
(
result
.
heuristic
"
First
result
is
heuristic
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
win
1
)
;
Assert
.
notEqual
(
UrlbarUtils
.
RESULT_TYPE
.
TAB_SWITCH
result
.
type
"
Second
result
is
not
tab
switch
"
)
;
await
BrowserTestUtils
.
closeWindow
(
privateWin
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
