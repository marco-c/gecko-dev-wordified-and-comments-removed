"
use
strict
"
;
const
ALIAS
=
"
enginealias
"
;
let
aliasEngine
;
add_task
(
async
function
init
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
aliasEngine
=
await
Services
.
search
.
addEngineWithDetails
(
"
Test
"
{
alias
:
ALIAS
template
:
"
http
:
/
/
example
.
com
/
?
search
=
{
searchTerms
}
"
}
)
;
registerCleanupFunction
(
async
function
(
)
{
await
Services
.
search
.
removeEngine
(
aliasEngine
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
gURLBar
.
handleRevert
(
)
;
}
)
;
}
)
;
add_task
(
async
function
basic
(
)
{
gURLBar
.
blur
(
)
;
gURLBar
.
search
(
"
basic
"
)
;
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
url
bar
is
focused
"
)
;
await
assertUrlbarValue
(
"
basic
"
)
;
assertOneOffButtonsVisible
(
true
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
)
;
}
)
;
add_task
(
async
function
searchEngineAlias
(
)
{
gURLBar
.
blur
(
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
search
(
"
example
"
)
)
;
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
url
bar
is
focused
"
)
;
await
assertUrlbarValue
(
"
example
"
)
;
assertOneOffButtonsVisible
(
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
search
(
"
not
an
engine
alias
"
)
)
;
await
assertUrlbarValue
(
"
not
an
engine
alias
"
)
;
assertOneOffButtonsVisible
(
true
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
)
;
}
)
;
add_task
(
async
function
searchRestriction_legacy
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
"
false
]
]
}
)
;
gURLBar
.
blur
(
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
search
(
UrlbarTokenizer
.
RESTRICT
.
SEARCH
)
)
;
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
url
bar
is
focused
"
)
;
await
assertUrlbarValue
(
UrlbarTokenizer
.
RESTRICT
.
SEARCH
+
"
"
)
;
assertOneOffButtonsVisible
(
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
searchRestriction
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
"
true
]
]
}
)
;
gURLBar
.
blur
(
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
search
(
UrlbarTokenizer
.
RESTRICT
.
SEARCH
)
)
;
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
url
bar
is
focused
"
)
;
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
:
UrlbarSearchUtils
.
getDefaultEngine
(
)
.
name
source
:
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
entry
:
"
typed
"
}
)
;
assertOneOffButtonsVisible
(
true
)
;
await
UrlbarTestUtils
.
exitSearchMode
(
window
{
backspace
:
true
}
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
searchTwice
(
)
{
gURLBar
.
blur
(
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
search
(
"
test
"
)
)
;
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
url
bar
is
focused
"
)
;
await
assertUrlbarValue
(
"
test
"
)
;
assertOneOffButtonsVisible
(
true
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
search
(
"
test
"
)
)
;
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
url
bar
is
focused
"
)
;
await
assertUrlbarValue
(
"
test
"
)
;
assertOneOffButtonsVisible
(
true
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
searchIME
(
)
{
gURLBar
.
blur
(
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
search
(
"
test
"
)
)
;
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
url
bar
is
focused
"
)
;
await
assertUrlbarValue
(
"
test
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
(
)
=
>
EventUtils
.
synthesizeComposition
(
{
type
:
"
compositionstart
"
}
)
)
;
gURLBar
.
search
(
"
test
"
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
1000
)
)
;
ok
(
!
UrlbarTestUtils
.
isPopupOpen
(
window
)
"
The
panel
should
still
be
closed
"
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
EventUtils
.
synthesizeComposition
(
{
type
:
"
compositioncommitasis
"
}
)
)
;
assertOneOffButtonsVisible
(
true
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
searchWithAlias
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
"
true
]
]
}
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
searchWithAlias
(
ALIAS
"
test
"
"
test
"
)
)
;
Assert
.
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
Urlbar
is
focused
"
)
;
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
:
aliasEngine
.
name
entry
:
"
other
"
}
)
;
await
assertUrlbarValue
(
"
test
"
)
;
assertOneOffButtonsVisible
(
true
)
;
await
UrlbarTestUtils
.
exitSearchMode
(
window
{
backspace
:
true
}
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
searchWithAlias_legacy
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
"
false
]
]
}
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
searchWithAlias
(
ALIAS
"
test
"
"
test
"
)
)
;
Assert
.
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
Urlbar
is
focused
"
)
;
Assert
.
equal
(
gURLBar
.
value
{
ALIAS
}
test
)
;
await
UrlbarTestUtils
.
waitForAutocompleteResultAt
(
window
0
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
"
Should
have
type
search
for
the
first
result
"
)
;
Assert
.
equal
(
result
.
searchParams
.
query
"
test
"
"
Should
have
the
correct
query
for
the
first
result
"
)
;
assertOneOffButtonsVisible
(
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
searchWithAliasInvalidAlias
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
"
true
]
]
}
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
gURLBar
.
searchWithAlias
(
"
invalidalias
"
"
test
"
"
test
"
)
)
;
Assert
.
ok
(
gURLBar
.
hasAttribute
(
"
focused
"
)
"
Urlbar
is
focused
"
)
;
UrlbarTestUtils
.
assertSearchMode
(
window
null
)
;
await
assertUrlbarValue
(
"
invalidalias
test
"
)
;
assertOneOffButtonsVisible
(
false
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
function
assertOneOffButtonsVisible
(
visible
)
{
Assert
.
equal
(
UrlbarTestUtils
.
getOneOffSearchButtonsVisible
(
window
)
visible
"
Should
show
or
not
the
one
-
off
search
buttons
"
)
;
}
async
function
assertUrlbarValue
(
value
)
{
await
UrlbarTestUtils
.
waitForAutocompleteResultAt
(
window
0
)
;
Assert
.
equal
(
gURLBar
.
value
value
)
;
Assert
.
greater
(
UrlbarTestUtils
.
getResultCount
(
window
)
0
"
Should
have
at
least
one
result
"
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
"
Should
have
type
search
for
the
first
result
"
)
;
let
restrictTokens
=
Object
.
values
(
UrlbarTokenizer
.
RESTRICT
)
;
if
(
restrictTokens
.
includes
(
value
[
0
]
)
)
{
value
=
value
.
substring
(
1
)
.
trim
(
)
;
}
Assert
.
equal
(
result
.
searchParams
.
query
value
"
Should
have
the
correct
query
for
the
first
result
"
)
;
}
