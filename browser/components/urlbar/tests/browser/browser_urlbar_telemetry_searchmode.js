"
use
strict
"
;
const
ENTRY_SCALAR_PREFIX
=
"
urlbar
.
searchmode
.
"
;
const
PICKED_SCALAR_PREFIX
=
"
urlbar
.
picked
.
searchmode
.
"
;
const
ENGINE_ALIAS
=
"
alias
"
;
const
TEST_QUERY
=
"
test
"
;
let
engineName
;
let
engineDomain
;
const
SUGGEST_PREF
=
"
browser
.
search
.
suggest
.
enabled
"
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
AppConstants
:
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
SearchTelemetry
:
"
resource
:
/
/
/
modules
/
SearchTelemetry
.
jsm
"
UrlbarProviderTabToSearch
:
"
resource
:
/
/
/
modules
/
UrlbarProviderTabToSearch
.
jsm
"
UrlbarTestUtils
:
"
resource
:
/
/
testing
-
common
/
UrlbarTestUtils
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
TouchBarHelper
"
"
mozilla
.
org
/
widget
/
touchbarhelper
;
1
"
"
nsITouchBarHelper
"
)
;
function
assertSearchModeScalars
(
entry
engineOrSource
resultIndex
=
-
1
)
{
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
false
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
ENTRY_SCALAR_PREFIX
+
entry
engineOrSource
1
)
;
for
(
let
e
of
UrlbarUtils
.
SEARCH_MODE_ENTRY
)
{
if
(
e
=
=
entry
)
{
Assert
.
equal
(
Object
.
keys
(
scalars
[
ENTRY_SCALAR_PREFIX
+
entry
]
)
.
length
1
This
search
must
only
increment
one
entry
in
the
correct
scalar
:
{
e
}
)
;
}
else
{
Assert
.
ok
(
!
scalars
[
ENTRY_SCALAR_PREFIX
+
e
]
No
other
urlbar
.
searchmode
scalars
should
be
recorded
.
Checking
{
e
}
)
;
}
}
if
(
resultIndex
>
=
0
)
{
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
PICKED_SCALAR_PREFIX
+
entry
resultIndex
1
)
;
}
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
}
add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
"
true
]
[
"
browser
.
urlbar
.
update2
.
oneOffsRefresh
"
true
]
[
"
browser
.
urlbar
.
tabToSearch
.
onboard
.
interactionsLeft
"
0
]
]
}
)
;
const
url
=
getRootDirectory
(
gTestPath
)
+
"
urlbarTelemetrySearchSuggestions
.
xml
"
;
let
suggestionEngine
=
await
Services
.
search
.
addOpenSearchEngine
(
url
"
"
)
;
suggestionEngine
.
alias
=
ENGINE_ALIAS
;
engineDomain
=
suggestionEngine
.
getResultDomain
(
)
;
engineName
=
suggestionEngine
.
name
;
let
originalEngine
=
await
Services
.
search
.
getDefault
(
)
;
await
Services
.
search
.
setDefault
(
suggestionEngine
)
;
await
Services
.
search
.
moveEngine
(
suggestionEngine
0
)
;
let
oldCanRecord
=
Services
.
telemetry
.
canRecordExtended
;
Services
.
telemetry
.
canRecordExtended
=
true
;
await
PlacesUtils
.
history
.
clear
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
maxHistoricalSearchSuggestions
"
0
]
]
}
)
;
UrlbarTestUtils
.
init
(
this
)
;
registerCleanupFunction
(
async
function
(
)
{
Services
.
telemetry
.
canRecordExtended
=
oldCanRecord
;
await
Services
.
search
.
setDefault
(
originalEngine
)
;
await
Services
.
search
.
removeEngine
(
suggestionEngine
)
;
await
PlacesUtils
.
history
.
clear
(
)
;
Services
.
telemetry
.
setEventRecordingEnabled
(
"
navigation
"
false
)
;
UrlbarTestUtils
.
uninit
(
)
;
}
)
;
}
)
;
add_task
(
async
function
test_oneoff_remote
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
TEST_QUERY
}
)
;
await
UrlbarTestUtils
.
enterSearchMode
(
window
)
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
loadPromise
;
assertSearchModeScalars
(
"
oneoff
"
"
other
"
0
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_oneoff_local
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
TEST_QUERY
}
)
;
await
UrlbarTestUtils
.
enterSearchMode
(
window
{
source
:
UrlbarUtils
.
RESULT_SOURCE
.
HISTORY
}
)
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
loadPromise
;
assertSearchModeScalars
(
"
oneoff
"
"
history
"
0
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_oneoff_amazon
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
SUGGEST_PREF
false
]
]
}
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
TEST_QUERY
}
)
;
await
UrlbarTestUtils
.
enterSearchMode
(
window
{
engineName
:
"
Amazon
.
com
"
}
)
;
assertSearchModeScalars
(
"
oneoff
"
"
Amazon
"
)
;
await
UrlbarTestUtils
.
exitSearchMode
(
window
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_oneoff_wikipedia
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
SUGGEST_PREF
false
]
]
}
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
TEST_QUERY
}
)
;
await
UrlbarTestUtils
.
enterSearchMode
(
window
{
engineName
:
"
Wikipedia
(
en
)
"
}
)
;
assertSearchModeScalars
(
"
oneoff
"
"
Wikipedia
"
)
;
await
UrlbarTestUtils
.
exitSearchMode
(
window
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_shortcut
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
TEST_QUERY
}
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
EventUtils
.
synthesizeKey
(
"
k
"
{
accelKey
:
true
}
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
source
:
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
entry
:
"
shortcut
"
}
)
;
assertSearchModeScalars
(
"
shortcut
"
"
other
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_topsites_urlbar
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
SUGGEST_PREF
false
]
]
}
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
window
(
)
=
>
{
if
(
gURLBar
.
getAttribute
(
"
pageproxystate
"
)
=
=
"
invalid
"
)
{
gURLBar
.
handleRevert
(
)
;
}
EventUtils
.
synthesizeMouseAtCenter
(
gURLBar
.
inputField
{
}
)
;
}
)
;
await
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
let
amazonSearch
=
await
UrlbarTestUtils
.
waitForAutocompleteResultAt
(
window
0
)
;
Assert
.
equal
(
amazonSearch
.
result
.
payload
.
keyword
"
amazon
"
"
First
result
should
have
the
Amazon
keyword
.
"
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
EventUtils
.
synthesizeMouseAtCenter
(
amazonSearch
{
}
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
:
amazonSearch
.
result
.
payload
.
engine
entry
:
"
topsites_urlbar
"
}
)
;
assertSearchModeScalars
(
"
topsites_urlbar
"
"
Amazon
"
)
;
await
UrlbarTestUtils
.
exitSearchMode
(
window
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_keywordoffer
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
let
alias
=
"
"
+
ENGINE_ALIAS
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
alias
}
)
;
let
keywordOfferResult
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
Assert
.
equal
(
keywordOfferResult
.
searchParams
.
keyword
alias
"
The
first
result
should
be
a
keyword
search
result
with
the
correct
alias
.
"
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
entry
:
"
keywordoffer
"
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
"
foo
"
}
)
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
loadPromise
;
assertSearchModeScalars
(
"
keywordoffer
"
"
other
"
0
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_typed
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
{
ENGINE_ALIAS
}
}
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
EventUtils
.
synthesizeKey
(
"
"
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
entry
:
"
typed
"
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
"
foo
"
}
)
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
loadPromise
;
assertSearchModeScalars
(
"
typed
"
"
other
"
0
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_bookmarkmenu
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
PlacesCommandHook
.
searchBookmarks
(
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
source
:
UrlbarUtils
.
RESULT_SOURCE
.
BOOKMARKS
entry
:
"
bookmarkmenu
"
}
)
;
assertSearchModeScalars
(
"
bookmarkmenu
"
"
bookmarks
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_tabmenu
(
)
{
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
gTabsPanel
.
searchTabs
(
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
source
:
UrlbarUtils
.
RESULT_SOURCE
.
TABS
entry
:
"
tabmenu
"
}
)
;
assertSearchModeScalars
(
"
tabmenu
"
"
tabs
"
)
;
}
)
;
add_task
(
async
function
test_handoff_pbm
(
)
{
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
waitForTabURL
:
"
about
:
privatebrowsing
"
}
)
;
let
tab
=
win
.
gBrowser
.
selectedBrowser
;
await
SpecialPowers
.
spawn
(
tab
[
]
async
function
(
)
{
let
btn
=
content
.
document
.
getElementById
(
"
search
-
handoff
-
button
"
)
;
btn
.
click
(
)
;
}
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
win
)
;
await
new
Promise
(
r
=
>
EventUtils
.
synthesizeKey
(
"
f
"
{
}
win
r
)
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
win
{
engineName
entry
:
"
handoff
"
}
)
;
assertSearchModeScalars
(
"
handoff
"
"
other
"
)
;
await
UrlbarTestUtils
.
exitSearchMode
(
win
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
win
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
test_touchbar
(
)
{
if
(
AppConstants
.
platform
!
=
"
macosx
"
)
{
return
;
}
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
TEST_QUERY
}
)
;
TouchBarHelper
.
insertRestrictionInUrlbar
(
UrlbarTokenizer
.
RESTRICT
.
HISTORY
)
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
source
:
UrlbarUtils
.
RESULT_SOURCE
.
HISTORY
entry
:
"
touchbar
"
}
)
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
loadPromise
;
assertSearchModeScalars
(
"
touchbar
"
"
history
"
0
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_tabtosearch
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
.
tabToComplete
"
true
]
[
"
browser
.
urlbar
.
tabToSearch
.
onboard
.
interactionsLeft
"
0
]
]
}
)
;
await
PlacesTestUtils
.
addVisits
(
[
http
:
/
/
{
engineDomain
}
/
]
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
engineDomain
.
slice
(
0
4
)
}
)
;
let
tabToSearchResult
=
(
await
UrlbarTestUtils
.
waitForAutocompleteResultAt
(
window
1
)
)
.
result
;
Assert
.
equal
(
tabToSearchResult
.
providerName
"
TabToSearch
"
"
The
second
result
is
a
tab
-
to
-
search
result
.
"
)
;
Assert
.
equal
(
tabToSearchResult
.
payload
.
engine
engineName
"
The
tab
-
to
-
search
result
is
for
the
correct
engine
.
"
)
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
null
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
Assert
.
equal
(
UrlbarTestUtils
.
getSelectedRowIndex
(
window
)
1
"
Sanity
check
:
The
second
result
is
selected
.
"
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
entry
:
"
tabtosearch
"
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
"
foo
"
}
)
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
loadPromise
;
assertSearchModeScalars
(
"
tabtosearch
"
"
other
"
0
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
PlacesUtils
.
history
.
clear
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
add_task
(
async
function
test_tabtosearch_onboard
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
update2
.
tabToComplete
"
true
]
[
"
browser
.
urlbar
.
tabToSearch
.
onboard
.
interactionsLeft
"
3
]
]
}
)
;
await
PlacesTestUtils
.
addVisits
(
[
http
:
/
/
{
engineDomain
}
/
]
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
engineDomain
.
slice
(
0
4
)
}
)
;
let
tabToSearchResult
=
(
await
UrlbarTestUtils
.
waitForAutocompleteResultAt
(
window
1
)
)
.
result
;
Assert
.
equal
(
tabToSearchResult
.
providerName
"
TabToSearch
"
"
The
second
result
is
a
tab
-
to
-
search
result
.
"
)
;
Assert
.
equal
(
tabToSearchResult
.
payload
.
engine
engineName
"
The
tab
-
to
-
search
result
is
for
the
correct
engine
.
"
)
;
Assert
.
equal
(
tabToSearchResult
.
payload
.
dynamicType
"
onboardTabToSearch
"
"
The
tab
-
to
-
search
result
is
an
onboarding
result
.
"
)
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
null
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
Assert
.
equal
(
UrlbarTestUtils
.
getSelectedRowIndex
(
window
)
1
"
Sanity
check
:
The
second
result
is
selected
.
"
)
;
let
searchPromise
=
UrlbarTestUtils
.
promiseSearchComplete
(
window
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
searchPromise
;
await
UrlbarTestUtils
.
assertSearchMode
(
window
{
engineName
entry
:
"
tabtosearch_onboard
"
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
"
foo
"
}
)
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
loadPromise
;
assertSearchModeScalars
(
"
tabtosearch_onboard
"
"
other
"
0
)
;
UrlbarPrefs
.
set
(
"
tabToSearch
.
onboard
.
interactionsLeft
"
3
)
;
delete
UrlbarProviderTabToSearch
.
onboardingInteractionAtTime
;
BrowserTestUtils
.
removeTab
(
tab
)
;
await
PlacesUtils
.
history
.
clear
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
