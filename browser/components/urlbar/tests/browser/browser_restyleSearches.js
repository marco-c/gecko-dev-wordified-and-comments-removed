"
use
strict
"
;
const
RESTYLE_PREF
=
"
browser
.
urlbar
.
restyleSearches
"
;
const
SUGGEST_URLBAR_PREF
=
"
browser
.
urlbar
.
suggest
.
searches
"
;
const
PRIVATE_SEARCH_PREF
=
"
browser
.
search
.
separatePrivateDefault
.
ui
.
enabled
"
;
const
TEST_ENGINE_BASENAME
=
"
searchSuggestionEngineSlow
.
xml
"
;
const
TEST_ENGINE_2_BASENAME
=
"
searchSuggestionEngine2
.
xml
"
;
const
TEST_QUERY
=
"
test
query
"
;
let
gSearchUri
;
add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
SUGGEST_URLBAR_PREF
true
]
[
RESTYLE_PREF
true
]
[
PRIVATE_SEARCH_PREF
false
]
]
}
)
;
let
engine
=
await
SearchTestUtils
.
promiseNewSearchEngine
(
getRootDirectory
(
gTestPath
)
+
TEST_ENGINE_BASENAME
)
;
let
oldDefaultEngine
=
await
Services
.
search
.
getDefault
(
)
;
await
Services
.
search
.
setDefault
(
engine
)
;
gSearchUri
=
(
await
Services
.
search
.
getDefault
(
)
)
.
getSubmission
(
{
TEST_QUERY
}
foo
)
.
uri
;
await
PlacesTestUtils
.
addVisits
(
{
uri
:
gSearchUri
.
spec
title
:
{
TEST_QUERY
}
foo
}
)
;
registerCleanupFunction
(
async
(
)
=
>
{
Services
.
search
.
setDefault
(
oldDefaultEngine
)
;
await
PlacesUtils
.
history
.
clear
(
)
;
}
)
;
}
)
;
add_task
(
async
function
restyleSearches
(
)
{
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
waitForFocus
:
SimpleTest
.
waitForFocus
value
:
TEST_QUERY
}
)
;
Assert
.
equal
(
UrlbarTestUtils
.
getResultCount
(
window
)
3
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
1
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
)
;
Assert
.
ok
(
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
restyled
search
history
result
.
"
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
foo
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
2
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
bar
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
bar
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
displaySearchHistoryAndSuggestions
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
RESTYLE_PREF
false
]
]
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
waitForFocus
:
SimpleTest
.
waitForFocus
value
:
TEST_QUERY
}
)
;
Assert
.
equal
(
UrlbarTestUtils
.
getResultCount
(
window
)
4
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
1
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
foo
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
2
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
bar
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
bar
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
3
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
URL
)
;
Assert
.
equal
(
result
.
source
UrlbarUtils
.
RESULT_SOURCE
.
HISTORY
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
)
;
Assert
.
equal
(
result
.
url
gSearchUri
.
spec
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
alternateEngine
(
)
{
let
engine2
=
await
SearchTestUtils
.
promiseNewSearchEngine
(
getRootDirectory
(
gTestPath
)
+
TEST_ENGINE_2_BASENAME
)
;
let
previousTestEngine
=
await
Services
.
search
.
getDefault
(
)
;
await
Services
.
search
.
setDefault
(
engine2
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
waitForFocus
:
SimpleTest
.
waitForFocus
value
:
TEST_QUERY
}
)
;
Assert
.
equal
(
UrlbarTestUtils
.
getResultCount
(
window
)
4
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
1
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
foo
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
browser_searchSuggestionEngine2
searchSuggestionEngine2
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
2
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
bar
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
bar
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
browser_searchSuggestionEngine2
searchSuggestionEngine2
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
3
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
)
;
Assert
.
ok
(
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
restyled
search
history
result
.
"
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
foo
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
await
Services
.
search
.
setDefault
(
previousTestEngine
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
onlyRestyleWhenQueriesMatch
(
)
{
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
waitForFocus
:
SimpleTest
.
waitForFocus
value
:
"
mochi
"
}
)
;
Assert
.
equal
(
UrlbarTestUtils
.
getResultCount
(
window
)
4
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
1
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
"
mochifoo
"
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
"
mochifoo
"
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
2
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
"
mochibar
"
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
"
mochibar
"
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
3
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
URL
)
;
Assert
.
equal
(
result
.
source
UrlbarUtils
.
RESULT_SOURCE
.
HISTORY
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
)
;
Assert
.
equal
(
result
.
url
gSearchUri
.
spec
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
add_task
(
async
function
searchHistoryNotExactMatch
(
)
{
let
irrelevantSearchUri
=
{
gSearchUri
.
spec
}
&
irrelevantParameter
=
1
;
await
PlacesTestUtils
.
addVisits
(
{
uri
:
irrelevantSearchUri
title
:
{
TEST_QUERY
}
foo
irrelevant
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
waitForFocus
:
SimpleTest
.
waitForFocus
value
:
TEST_QUERY
}
)
;
Assert
.
equal
(
UrlbarTestUtils
.
getResultCount
(
window
)
4
)
;
let
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
1
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
)
;
Assert
.
ok
(
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
restyled
search
history
result
.
"
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
foo
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
2
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
bar
)
;
Assert
.
equal
(
result
.
searchParams
.
suggestion
{
TEST_QUERY
}
bar
)
;
Assert
.
ok
(
!
result
.
searchParams
.
isSearchHistory
"
This
result
should
be
a
normal
search
suggestion
.
"
)
;
Assert
.
equal
(
result
.
displayed
.
action
UrlbarUtils
.
strings
.
formatStringFromName
(
"
searchWithEngine
"
[
"
searchSuggestionEngineSlow
.
xml
"
]
)
"
Should
have
the
correct
action
text
"
)
;
result
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
3
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
URL
)
;
Assert
.
equal
(
result
.
source
UrlbarUtils
.
RESULT_SOURCE
.
HISTORY
)
;
Assert
.
equal
(
result
.
displayed
.
title
{
TEST_QUERY
}
foo
irrelevant
)
;
Assert
.
equal
(
result
.
url
irrelevantSearchUri
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
