"
use
strict
"
;
async
function
checkOpensOnFocus
(
win
=
window
)
{
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
win
.
gURLBar
.
blur
(
)
;
info
(
"
Check
the
keyboard
shortcut
.
"
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
win
(
)
=
>
{
win
.
document
.
getElementById
(
"
Browser
:
OpenLocation
"
)
.
doCommand
(
)
;
}
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
win
(
)
=
>
{
win
.
gURLBar
.
blur
(
)
;
}
)
;
info
(
"
Focus
with
the
mouse
.
"
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
win
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
win
.
gURLBar
.
inputField
{
}
win
)
;
}
)
;
}
async
function
checkDoesNotOpenOnFocus
(
win
=
window
)
{
Assert
.
ok
(
!
win
.
gURLBar
.
openViewOnFocusForCurrentTab
"
openViewOnFocusForCurrentTab
should
be
false
"
)
;
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
win
.
gURLBar
.
blur
(
)
;
info
(
"
Check
the
keyboard
shortcut
.
"
)
;
win
.
document
.
getElementById
(
"
Browser
:
OpenLocation
"
)
.
doCommand
(
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
500
)
)
;
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
win
.
gURLBar
.
blur
(
)
;
info
(
"
Focus
with
the
mouse
.
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
win
.
gURLBar
.
inputField
{
}
win
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
500
)
)
;
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
}
add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
megabar
"
true
]
]
}
)
;
await
PlacesTestUtils
.
addVisits
(
[
{
uri
:
"
http
:
/
/
mochi
.
test
:
8888
/
"
transition
:
PlacesUtils
.
history
.
TRANSITIONS
.
TYPED
}
]
)
;
registerCleanupFunction
(
PlacesUtils
.
history
.
clear
)
;
}
)
;
async
function
test_window
(
win
)
{
for
(
let
url
of
[
"
about
:
newtab
"
"
about
:
home
"
"
http
:
/
/
example
.
com
/
"
]
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
:
win
.
gBrowser
url
waitForLoad
:
false
}
async
browser
=
>
{
await
TestUtils
.
waitForCondition
(
(
)
=
>
win
.
gBrowser
.
currentURI
.
spec
=
=
url
"
Ensure
we
'
re
on
the
expected
page
"
)
;
info
(
"
The
panel
should
not
open
on
the
page
by
default
"
)
;
await
checkDoesNotOpenOnFocus
(
win
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
:
win
waitForFocus
value
:
"
foo
"
}
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
win
(
)
=
>
{
win
.
gURLBar
.
blur
(
)
;
}
)
;
info
(
"
The
panel
should
open
when
there
'
s
a
search
string
"
)
;
await
checkOpensOnFocus
(
win
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
win
(
)
=
>
{
win
.
gURLBar
.
blur
(
)
;
}
)
;
}
)
;
}
}
add_task
(
async
function
test_normalWindow
(
)
{
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
await
test_window
(
win
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
privateWindow
(
)
{
let
privateWin
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
test_window
(
privateWin
)
;
await
BrowserTestUtils
.
closeWindow
(
privateWin
)
;
}
)
;
