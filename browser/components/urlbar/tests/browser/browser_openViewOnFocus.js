"
use
strict
"
;
async
function
checkOpensOnFocus
(
win
=
window
)
{
win
.
gURLBar
.
blur
(
)
;
win
.
gURLBar
.
focus
(
)
;
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
win
.
gURLBar
.
blur
(
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
win
(
)
=
>
{
win
.
document
.
getElementById
(
"
Browser
:
OpenLocation
"
)
.
doCommand
(
)
;
}
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
win
(
)
=
>
{
win
.
gURLBar
.
blur
(
)
;
}
)
;
await
UrlbarTestUtils
.
promisePopupOpen
(
win
(
)
=
>
{
EventUtils
.
synthesizeMouseAtCenter
(
win
.
gURLBar
.
inputField
{
}
)
;
}
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
win
(
)
=
>
{
win
.
gURLBar
.
blur
(
)
;
}
)
;
}
async
function
checkDoesNotOpenOnFocus
(
win
=
window
)
{
win
.
gURLBar
.
blur
(
)
;
win
.
gURLBar
.
focus
(
)
;
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
win
.
gURLBar
.
blur
(
)
;
win
.
document
.
getElementById
(
"
Browser
:
OpenLocation
"
)
.
doCommand
(
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
500
)
)
;
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
win
.
gURLBar
.
blur
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
win
.
gURLBar
.
inputField
{
}
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
500
)
)
;
Assert
.
ok
(
!
win
.
gURLBar
.
view
.
isOpen
"
check
urlbar
panel
is
not
open
"
)
;
win
.
gURLBar
.
blur
(
)
;
}
add_task
(
async
function
setUp
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
openViewOnFocus
"
true
]
]
}
)
;
await
PlacesTestUtils
.
addVisits
(
[
{
uri
:
"
http
:
/
/
mochi
.
test
:
8888
/
"
transition
:
PlacesUtils
.
history
.
TRANSITIONS
.
TYPED
}
]
)
;
registerCleanupFunction
(
(
)
=
>
PlacesUtils
.
history
.
clear
(
)
)
;
}
)
;
add_task
(
async
function
test
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
async
browser
=
>
{
await
checkOpensOnFocus
(
)
;
}
)
;
}
)
;
add_task
(
async
function
newtabAndHome
(
)
{
for
(
let
url
of
[
"
about
:
newtab
"
"
about
:
home
"
]
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
waitForLoad
:
false
}
async
browser
=
>
{
await
TestUtils
.
waitForCondition
(
(
)
=
>
window
.
gBrowser
.
currentURI
.
spec
=
=
url
"
Ensure
we
'
re
on
the
expected
page
"
)
;
await
checkOpensOnFocus
(
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
/
"
}
async
otherBrowser
=
>
{
await
checkOpensOnFocus
(
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
gBrowser
.
getTabForBrowser
(
browser
)
)
;
await
checkOpensOnFocus
(
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
gBrowser
.
getTabForBrowser
(
otherBrowser
)
)
;
await
checkOpensOnFocus
(
)
;
}
)
;
await
checkOpensOnFocus
(
)
;
await
BrowserTestUtils
.
loadURI
(
gBrowser
.
selectedBrowser
"
http
:
/
/
example
.
com
/
"
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
await
checkOpensOnFocus
(
)
;
}
)
;
}
}
)
;
add_task
(
async
function
privateWindow
(
)
{
let
privateWin
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
checkDoesNotOpenOnFocus
(
privateWin
)
;
await
BrowserTestUtils
.
closeWindow
(
privateWin
)
;
}
)
;
