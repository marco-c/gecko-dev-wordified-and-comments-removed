"
use
strict
"
;
let
listService
;
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
strip_list
"
"
stripParam
"
]
[
"
privacy
.
query_stripping
.
enabled
"
false
]
]
}
)
;
listService
=
Cc
[
"
mozilla
.
org
/
query
-
stripping
-
list
-
service
;
1
"
]
.
getService
(
Ci
.
nsIURLQueryStrippingListService
)
;
await
listService
.
testWaitForInit
(
)
;
}
)
;
add_task
(
async
function
testQueryParamIsStripped
(
)
{
await
testMenuItemEnabled
(
false
)
;
}
)
;
add_task
(
async
function
testQueryParamIsStrippedSelectURL
(
)
{
await
testMenuItemEnabled
(
true
)
;
}
)
;
add_task
(
async
function
testUnknownQueryParam
(
)
{
await
testMenuItemDisabled
(
"
https
:
/
/
www
.
example
.
com
/
?
noStripParam
=
1234
"
true
false
)
;
}
)
;
add_task
(
async
function
testInvalidURI
(
)
{
await
testMenuItemDisabled
(
"
https
:
/
/
www
.
example
.
com
/
?
stripParam
=
1234
"
true
true
)
;
}
)
;
add_task
(
async
function
testPrefDisabled
(
)
{
await
testMenuItemDisabled
(
"
https
:
/
/
www
.
example
.
com
/
?
stripParam
=
1234
"
false
false
)
;
}
)
;
async
function
testMenuItemDisabled
(
url
prefEnabled
selection
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
strip_on_share
.
enabled
"
prefEnabled
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
url
async
function
(
browser
)
{
gURLBar
.
focus
(
)
;
if
(
selection
)
{
gURLBar
.
selectionStart
=
url
.
indexOf
(
"
example
"
)
;
gURLBar
.
selectionEnd
=
url
.
indexOf
(
"
4
"
)
;
}
let
menuitem
=
await
promiseContextualMenuitem
(
"
strip
-
on
-
share
"
)
;
Assert
.
ok
(
!
BrowserTestUtils
.
is_visible
(
menuitem
)
"
Menu
item
is
not
visible
"
)
;
let
hidePromise
=
BrowserTestUtils
.
waitForEvent
(
menuitem
.
parentElement
"
popuphidden
"
)
;
menuitem
.
parentElement
.
hidePopup
(
)
;
await
hidePromise
;
}
)
;
}
async
function
testMenuItemEnabled
(
selectWholeUrl
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
query_stripping
.
strip_on_share
.
enabled
"
true
]
]
}
)
;
let
validUrl
=
"
https
:
/
/
www
.
example
.
com
/
?
stripParam
=
1234
"
;
let
strippedUrl
=
"
https
:
/
/
www
.
example
.
com
/
"
;
await
BrowserTestUtils
.
withNewTab
(
validUrl
async
function
(
browser
)
{
gURLBar
.
focus
(
)
;
if
(
selectWholeUrl
)
{
gURLBar
.
select
(
)
;
}
let
menuitem
=
await
promiseContextualMenuitem
(
"
strip
-
on
-
share
"
)
;
Assert
.
ok
(
BrowserTestUtils
.
is_visible
(
menuitem
)
"
Menu
item
is
visible
"
)
;
let
hidePromise
=
BrowserTestUtils
.
waitForEvent
(
menuitem
.
parentElement
"
popuphidden
"
)
;
await
SimpleTest
.
promiseClipboardChange
(
strippedUrl
(
)
=
>
{
menuitem
.
closest
(
"
menupopup
"
)
.
activateItem
(
menuitem
)
;
}
)
;
await
hidePromise
;
}
)
;
}
