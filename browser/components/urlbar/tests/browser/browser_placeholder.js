"
use
strict
"
;
const
TEST_ENGINE_BASENAME
=
"
searchSuggestionEngine
.
xml
"
;
const
TEST_PRIVATE_ENGINE_BASENAME
=
"
searchSuggestionEngine2
.
xml
"
;
var
originalEngine
extraEngine
extraPrivateEngine
expectedString
;
var
tabs
=
[
]
;
add_task
(
async
function
setup
(
)
{
originalEngine
=
await
Services
.
search
.
getDefault
(
)
;
expectedString
=
gBrowserBundle
.
formatStringFromName
(
"
urlbar
.
placeholder
"
[
originalEngine
.
name
]
)
;
let
rootDir
=
getRootDirectory
(
gTestPath
)
;
extraEngine
=
await
SearchTestUtils
.
promiseNewSearchEngine
(
rootDir
+
TEST_ENGINE_BASENAME
)
;
extraPrivateEngine
=
await
SearchTestUtils
.
promiseNewSearchEngine
(
rootDir
+
TEST_PRIVATE_ENGINE_BASENAME
)
;
let
urlTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
mozilla
"
)
;
BrowserTestUtils
.
removeTab
(
urlTab
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
search
.
separatePrivateDefault
.
ui
.
enabled
"
true
]
[
"
browser
.
search
.
separatePrivateDefault
"
false
]
]
}
)
;
registerCleanupFunction
(
async
(
)
=
>
{
await
Services
.
search
.
setDefault
(
originalEngine
)
;
for
(
let
tab
of
tabs
)
{
BrowserTestUtils
.
removeTab
(
tab
)
;
}
}
)
;
}
)
;
add_task
(
async
function
test_change_default_engine_updates_placeholder
(
)
{
tabs
.
push
(
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
)
;
await
Services
.
search
.
setDefault
(
extraEngine
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
gURLBar
.
placeholder
=
=
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
"
The
placeholder
should
match
the
default
placeholder
for
non
-
built
-
in
engines
.
"
)
;
Assert
.
equal
(
gURLBar
.
placeholder
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
)
;
await
Services
.
search
.
setDefault
(
originalEngine
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
gURLBar
.
placeholder
=
=
expectedString
"
The
placeholder
should
include
the
engine
name
for
built
-
in
engines
.
"
)
;
Assert
.
equal
(
gURLBar
.
placeholder
expectedString
)
;
}
)
;
add_task
(
async
function
test_delayed_update_placeholder
(
)
{
Services
.
obs
.
removeObserver
(
BrowserSearch
"
browser
-
search
-
engine
-
modified
"
)
;
let
urlTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
mozilla
"
)
;
tabs
.
push
(
urlTab
)
;
let
blankTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
tabs
.
push
(
blankTab
)
;
await
Services
.
search
.
setDefault
(
extraEngine
)
;
BrowserSearch
.
_updateURLBarPlaceholder
(
extraEngine
.
name
false
true
)
;
Assert
.
equal
(
gURLBar
.
placeholder
expectedString
"
Placeholder
should
be
unchanged
.
"
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
urlTab
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
gURLBar
.
placeholder
=
=
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
"
The
placeholder
should
have
updated
in
the
background
.
"
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
blankTab
)
;
await
Services
.
search
.
setDefault
(
originalEngine
)
;
BrowserSearch
.
_updateURLBarPlaceholder
(
originalEngine
.
name
false
true
)
;
Assert
.
equal
(
gURLBar
.
placeholder
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
"
Placeholder
should
be
unchanged
.
"
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
urlTab
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
gURLBar
.
placeholder
=
=
expectedString
"
The
placeholder
should
include
the
engine
name
for
built
-
in
engines
.
"
)
;
BrowserSearch
.
_updateURLBarPlaceholder
(
extraEngine
.
name
false
)
;
Assert
.
equal
(
gURLBar
.
placeholder
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
"
Placeholder
should
be
the
default
.
"
)
;
Services
.
obs
.
addObserver
(
BrowserSearch
"
browser
-
search
-
engine
-
modified
"
)
;
}
)
;
add_task
(
async
function
test_private_window_no_separate_engine
(
)
{
const
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
Services
.
search
.
setDefault
(
extraEngine
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
win
.
gURLBar
.
placeholder
=
=
win
.
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
"
The
placeholder
should
match
the
default
placeholder
for
non
-
built
-
in
engines
.
"
)
;
Assert
.
equal
(
win
.
gURLBar
.
placeholder
win
.
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
)
;
await
Services
.
search
.
setDefault
(
originalEngine
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
win
.
gURLBar
.
placeholder
=
=
expectedString
"
The
placeholder
should
include
the
engine
name
for
built
-
in
engines
.
"
)
;
Assert
.
equal
(
win
.
gURLBar
.
placeholder
expectedString
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
test_private_window_separate_engine
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
search
.
separatePrivateDefault
"
true
]
]
}
)
;
const
originalPrivateEngine
=
await
Services
.
search
.
getDefaultPrivate
(
)
;
registerCleanupFunction
(
async
(
)
=
>
{
await
Services
.
search
.
setDefaultPrivate
(
originalPrivateEngine
)
;
}
)
;
const
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
true
}
)
;
await
Services
.
search
.
setDefault
(
originalEngine
)
;
await
Services
.
search
.
setDefaultPrivate
(
extraPrivateEngine
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
win
.
gURLBar
.
placeholder
=
=
win
.
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
"
The
placeholder
should
match
the
default
placeholder
for
non
-
built
-
in
engines
.
"
)
;
Assert
.
equal
(
win
.
gURLBar
.
placeholder
win
.
gURLBar
.
getAttribute
(
"
defaultPlaceholder
"
)
)
;
await
Services
.
search
.
setDefault
(
extraEngine
)
;
await
Services
.
search
.
setDefaultPrivate
(
originalEngine
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
win
.
gURLBar
.
placeholder
=
=
expectedString
"
The
placeholder
should
include
the
engine
name
for
built
-
in
engines
.
"
)
;
Assert
.
equal
(
win
.
gURLBar
.
placeholder
expectedString
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
