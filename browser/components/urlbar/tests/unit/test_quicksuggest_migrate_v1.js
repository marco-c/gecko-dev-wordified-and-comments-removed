"
use
strict
"
;
let
gDefaultBranch
=
Services
.
prefs
.
getDefaultBranch
(
"
browser
.
urlbar
.
"
)
;
let
gUserBranch
=
Services
.
prefs
.
getBranch
(
"
browser
.
urlbar
.
"
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
history
}
scenario
:
"
history
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
history
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
history
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
history
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
}
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
}
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
"
:
false
"
suggest
.
quicksuggest
.
sponsored
"
:
false
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
}
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
scenario
:
"
offline
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
}
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
doMigrateTest
(
{
initialPrefsToSet
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
offline
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
}
}
scenario
:
"
online
"
expectedPrefs
:
{
defaultBranch
:
UrlbarPrefs
.
FIREFOX_SUGGEST_DEFAULT_PREFS
.
online
userBranch
:
{
"
suggest
.
quicksuggest
"
:
true
"
suggest
.
quicksuggest
.
sponsored
"
:
true
"
quicksuggest
.
dataCollection
.
enabled
"
:
true
}
}
}
)
;
}
)
;
async
function
doMigrateTest
(
{
initialPrefsToSet
scenario
expectedPrefs
}
)
{
info
(
"
Testing
:
"
+
JSON
.
stringify
(
{
initialPrefsToSet
scenario
expectedPrefs
}
)
)
;
UrlbarPrefs
.
_updatingFirefoxSuggestScenario
=
true
;
let
{
defaultBranch
:
initialDefaultBranch
userBranch
:
initialUserBranch
}
=
initialPrefsToSet
;
initialDefaultBranch
=
initialDefaultBranch
|
|
{
}
;
initialUserBranch
=
initialUserBranch
|
|
{
}
;
for
(
let
name
of
Object
.
keys
(
initialDefaultBranch
)
)
{
gUserBranch
.
clearUserPref
(
name
)
;
}
UrlbarPrefs
.
clear
(
"
quicksuggest
.
migrationVersion
"
)
;
for
(
let
[
branch
prefs
]
of
[
[
gDefaultBranch
initialDefaultBranch
]
[
gUserBranch
initialUserBranch
]
]
)
{
for
(
let
[
name
value
]
of
Object
.
entries
(
prefs
)
)
{
branch
.
setBoolPref
(
name
value
)
;
}
}
UrlbarPrefs
.
_updatingFirefoxSuggestScenario
=
false
;
for
(
let
i
=
0
;
i
<
2
;
i
+
+
)
{
await
UrlbarPrefs
.
updateFirefoxSuggestScenario
(
true
scenario
)
;
let
expectedEffectivePrefs
=
{
}
;
let
{
defaultBranch
:
expectedDefaultBranch
userBranch
:
expectedUserBranch
}
=
expectedPrefs
;
expectedDefaultBranch
=
expectedDefaultBranch
|
|
{
}
;
expectedUserBranch
=
expectedUserBranch
|
|
{
}
;
for
(
let
[
branch
prefs
branchType
]
of
[
[
gDefaultBranch
expectedDefaultBranch
"
default
"
]
[
gUserBranch
expectedUserBranch
"
user
"
]
]
)
{
for
(
let
[
name
value
]
of
Object
.
entries
(
prefs
)
)
{
expectedEffectivePrefs
[
name
]
=
value
;
if
(
branch
=
=
gUserBranch
)
{
Assert
.
ok
(
gUserBranch
.
prefHasUserValue
(
name
)
Pref
{
name
}
is
on
user
branch
)
;
}
Assert
.
equal
(
branch
.
getBoolPref
(
name
)
value
Pref
{
name
}
on
{
branchType
}
branch
)
;
}
}
for
(
let
name
of
Object
.
keys
(
initialDefaultBranch
)
)
{
if
(
!
expectedUserBranch
.
hasOwnProperty
(
name
)
)
{
Assert
.
ok
(
!
gUserBranch
.
prefHasUserValue
(
name
)
Pref
{
name
}
is
not
on
user
branch
)
;
}
}
for
(
let
[
name
value
]
of
Object
.
entries
(
expectedEffectivePrefs
)
)
{
Assert
.
equal
(
UrlbarPrefs
.
get
(
name
)
value
Pref
{
name
}
effective
value
)
;
}
}
UrlbarPrefs
.
_updatingFirefoxSuggestScenario
=
true
;
UrlbarPrefs
.
clear
(
"
quicksuggest
.
migrationVersion
"
)
;
for
(
let
name
of
Object
.
keys
(
expectedPrefs
.
userBranch
|
|
{
}
)
)
{
UrlbarPrefs
.
clear
(
name
)
;
}
UrlbarPrefs
.
_updatingFirefoxSuggestScenario
=
false
;
}
