testEngine_setup
(
)
;
const
TRANSITIONS
=
{
link
:
PlacesUtils
.
history
.
TRANSITION_LINK
redirectPermanent
:
PlacesUtils
.
history
.
TRANSITION_REDIRECT_PERMANENT
redirectTemporary
:
PlacesUtils
.
history
.
TRANSITION_REDIRECT_TEMPORARY
typed
:
PlacesUtils
.
history
.
TRANSITION_TYPED
bookmark
:
PlacesUtils
.
history
.
TRANSITION_BOOKMARK
embed
:
PlacesUtils
.
history
.
TRANSITION_EMBED
download
:
PlacesUtils
.
history
.
TRANSITION_DOWNLOAD
framedLink
:
PlacesUtils
.
history
.
TRANSITION_FRAMED_LINK
reload
:
PlacesUtils
.
history
.
TRANSITION_RELOAD
}
;
const
EXPECTED_TRANSITION_ORDER
=
[
PlacesUtils
.
history
.
TRANSITION_BOOKMARK
PlacesUtils
.
history
.
TRANSITION_TYPED
PlacesUtils
.
history
.
TRANSITION_REDIRECT_TEMPORARY
PlacesUtils
.
history
.
TRANSITION_REDIRECT_PERMANENT
PlacesUtils
.
history
.
TRANSITION_LINK
]
;
async
function
createTestEntries
(
searchTerm
)
{
const
testEntries
=
[
]
;
for
(
let
[
transitionName
transitionType
]
of
Object
.
entries
(
TRANSITIONS
)
)
{
let
uri
=
Services
.
io
.
newURI
(
https
:
/
/
{
searchTerm
}
.
com
/
{
transitionName
}
/
)
;
let
title
=
{
searchTerm
}
{
transitionName
}
test
;
if
(
transitionType
=
=
=
PlacesUtils
.
history
.
TRANSITION_BOOKMARK
)
{
await
PlacesTestUtils
.
addBookmarkWithDetails
(
{
uri
title
}
)
;
}
await
PlacesTestUtils
.
addVisits
(
{
uri
title
transition
:
transitionType
}
)
;
if
(
transitionType
=
=
=
PlacesUtils
.
history
.
TRANSITION_TYPED
)
{
PlacesUtils
.
history
.
markPageAsTyped
(
uri
)
;
}
testEntries
.
push
(
{
uri
title
transitionType
transitionName
age
:
"
recent
"
}
)
;
}
const
OLD_TIME
=
(
Date
.
now
(
)
-
180
*
24
*
60
*
60
*
1000
)
*
1000
;
for
(
let
[
transitionName
transitionType
]
of
Object
.
entries
(
TRANSITIONS
)
)
{
let
uri
=
Services
.
io
.
newURI
(
https
:
/
/
{
searchTerm
}
.
com
/
old
/
{
transitionName
}
/
)
;
let
title
=
{
searchTerm
}
{
transitionName
}
test
;
if
(
transitionType
=
=
=
PlacesUtils
.
history
.
TRANSITION_BOOKMARK
)
{
await
PlacesTestUtils
.
addBookmarkWithDetails
(
{
uri
title
}
)
;
}
await
PlacesTestUtils
.
addVisits
(
{
uri
title
transition
:
transitionType
visitDate
:
OLD_TIME
}
)
;
if
(
transitionType
=
=
=
PlacesUtils
.
history
.
TRANSITION_TYPED
)
{
PlacesUtils
.
history
.
markPageAsTyped
(
uri
)
;
}
testEntries
.
push
(
{
uri
title
transitionType
transitionName
age
:
"
old
"
}
)
;
}
return
testEntries
;
}
add_task
(
async
function
test_frecency
(
)
{
const
searchTerm
=
"
frecency
"
;
const
testEntries
=
await
createTestEntries
(
searchTerm
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
urlbar
.
autoFill
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
urlbar
.
suggest
.
searches
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
urlbar
.
scotchBonnet
.
enableOverride
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
urlbar
.
suggest
.
history
"
true
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
urlbar
.
suggest
.
bookmarks
"
true
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
browser
.
urlbar
.
suggest
.
history
"
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
urlbar
.
suggest
.
bookmarks
"
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
urlbar
.
autoFill
"
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
urlbar
.
suggest
.
searches
"
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
urlbar
.
scotchBonnet
.
enableOverride
"
)
;
}
)
;
Services
.
prefs
.
setIntPref
(
"
browser
.
urlbar
.
maxRichResults
"
testEntries
.
length
+
1
)
;
await
PlacesTestUtils
.
promiseAsyncUpdates
(
)
;
let
context
=
createContext
(
searchTerm
{
isPrivate
:
false
}
)
;
let
expectedResults
=
[
makeSearchResult
(
context
{
engineName
:
SUGGESTIONS_ENGINE_NAME
heuristic
:
true
}
)
]
;
for
(
let
expectedTransition
of
EXPECTED_TRANSITION_ORDER
)
{
let
entry
=
testEntries
.
find
(
e
=
>
e
.
transitionType
=
=
expectedTransition
&
&
e
.
age
=
=
"
recent
"
)
;
if
(
expectedTransition
=
=
=
PlacesUtils
.
history
.
TRANSITION_BOOKMARK
)
{
expectedResults
.
push
(
makeBookmarkResult
(
context
{
uri
:
entry
.
uri
.
spec
title
:
entry
.
title
}
)
)
;
}
else
{
expectedResults
.
push
(
makeVisitResult
(
context
{
uri
:
entry
.
uri
.
spec
title
:
entry
.
title
}
)
)
;
}
}
for
(
let
expectedTransition
of
EXPECTED_TRANSITION_ORDER
)
{
let
entry
=
testEntries
.
find
(
e
=
>
e
.
transitionType
=
=
expectedTransition
&
&
e
.
age
=
=
"
old
"
)
;
if
(
expectedTransition
=
=
=
PlacesUtils
.
history
.
TRANSITION_BOOKMARK
)
{
expectedResults
.
push
(
makeBookmarkResult
(
context
{
uri
:
entry
.
uri
.
spec
title
:
entry
.
title
}
)
)
;
}
else
{
expectedResults
.
push
(
makeVisitResult
(
context
{
uri
:
entry
.
uri
.
spec
title
:
entry
.
title
}
)
)
;
}
}
await
check_results
(
{
context
matches
:
expectedResults
}
)
;
}
)
;
