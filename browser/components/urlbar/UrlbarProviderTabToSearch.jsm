"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
UrlbarProviderTabToSearch
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
UrlbarView
:
"
resource
:
/
/
/
modules
/
UrlbarView
.
jsm
"
UrlbarPrefs
:
"
resource
:
/
/
/
modules
/
UrlbarPrefs
.
jsm
"
UrlbarProvider
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
UrlbarResult
:
"
resource
:
/
/
/
modules
/
UrlbarResult
.
jsm
"
UrlbarSearchUtils
:
"
resource
:
/
/
/
modules
/
UrlbarSearchUtils
.
jsm
"
UrlbarUtils
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
}
)
;
const
DYNAMIC_RESULT_TYPE
=
"
onboardTabToSearch
"
;
const
VIEW_TEMPLATE
=
{
attributes
:
{
role
:
"
group
"
selectable
:
"
true
"
}
children
:
[
{
name
:
"
no
-
wrap
"
tag
:
"
span
"
classList
:
[
"
urlbarView
-
no
-
wrap
"
]
children
:
[
{
name
:
"
icon
"
tag
:
"
img
"
classList
:
[
"
urlbarView
-
favicon
"
]
}
{
name
:
"
text
-
container
"
tag
:
"
span
"
children
:
[
{
name
:
"
first
-
row
-
container
"
tag
:
"
span
"
children
:
[
{
name
:
"
title
"
tag
:
"
span
"
classList
:
[
"
urlbarView
-
title
"
]
children
:
[
{
name
:
"
titleStrong
"
tag
:
"
strong
"
}
]
}
{
name
:
"
title
-
separator
"
tag
:
"
span
"
classList
:
[
"
urlbarView
-
title
-
separator
"
]
}
{
name
:
"
action
"
tag
:
"
span
"
classList
:
[
"
urlbarView
-
action
"
]
attributes
:
{
"
slide
-
in
"
:
true
}
}
]
}
{
name
:
"
description
"
tag
:
"
span
"
}
]
}
]
}
]
}
;
function
initializeDynamicResult
(
)
{
UrlbarResult
.
addDynamicResultType
(
DYNAMIC_RESULT_TYPE
)
;
UrlbarView
.
addDynamicViewTemplate
(
DYNAMIC_RESULT_TYPE
VIEW_TEMPLATE
)
;
}
class
ProviderTabToSearch
extends
UrlbarProvider
{
constructor
(
)
{
super
(
)
;
}
get
name
(
)
{
return
"
TabToSearch
"
;
}
get
type
(
)
{
return
UrlbarUtils
.
PROVIDER_TYPE
.
PROFILE
;
}
async
isActive
(
queryContext
)
{
return
(
queryContext
.
searchString
&
&
queryContext
.
tokens
.
length
=
=
1
&
&
!
queryContext
.
searchMode
&
&
UrlbarPrefs
.
get
(
"
update2
"
)
&
&
UrlbarPrefs
.
get
(
"
update2
.
tabToComplete
"
)
)
;
}
getPriority
(
queryContext
)
{
return
0
;
}
getViewUpdate
(
result
)
{
return
{
icon
:
{
attributes
:
{
src
:
result
.
payload
.
icon
}
}
titleStrong
:
{
l10n
:
{
id
:
"
urlbar
-
result
-
action
-
search
-
w
-
engine
"
args
:
{
engine
:
result
.
payload
.
engine
}
}
}
action
:
{
l10n
:
{
id
:
UrlbarUtils
.
WEB_ENGINE_NAMES
.
has
(
result
.
payload
.
engine
)
?
"
urlbar
-
result
-
action
-
tabtosearch
-
web
"
:
"
urlbar
-
result
-
action
-
tabtosearch
-
other
-
engine
"
args
:
{
engine
:
result
.
payload
.
engine
}
}
}
description
:
{
l10n
:
{
id
:
"
urlbar
-
tabtosearch
-
onboard
"
}
}
}
;
}
pickResult
(
result
element
)
{
element
.
ownerGlobal
.
gURLBar
.
maybeConfirmSearchModeFromResult
(
{
result
checkValue
:
false
}
)
;
}
onSelection
(
result
element
)
{
if
(
result
.
payload
.
dynamicType
&
&
(
!
this
.
onboardingInteractionAtTime
|
|
this
.
onboardingInteractionAtTime
<
Date
.
now
(
)
-
1000
*
60
*
5
)
)
{
let
interactionsLeft
=
UrlbarPrefs
.
get
(
"
tabToSearch
.
onboard
.
interactionsLeft
"
)
;
if
(
interactionsLeft
>
0
)
{
UrlbarPrefs
.
set
(
"
tabToSearch
.
onboard
.
interactionsLeft
"
-
-
interactionsLeft
)
;
}
this
.
onboardingInteractionAtTime
=
Date
.
now
(
)
;
}
}
get
deferUserSelection
(
)
{
return
true
;
}
async
startQuery
(
queryContext
addCallback
)
{
let
[
searchStr
]
=
UrlbarUtils
.
stripPrefixAndTrim
(
queryContext
.
searchString
{
stripWww
:
true
trimSlash
:
true
}
)
;
let
engines
=
await
UrlbarSearchUtils
.
enginesForDomainPrefix
(
searchStr
{
matchAllDomainLevels
:
true
}
)
;
const
onboardingInteractionsLeft
=
UrlbarPrefs
.
get
(
"
tabToSearch
.
onboard
.
interactionsLeft
"
)
;
let
showedOnboarding
=
false
;
for
(
let
engine
of
engines
)
{
let
url
=
engine
.
getResultDomain
(
)
;
url
=
url
.
substr
(
0
url
.
length
-
engine
.
searchUrlPublicSuffix
.
length
)
;
let
result
;
if
(
onboardingInteractionsLeft
>
0
)
{
result
=
new
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
DYNAMIC
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
{
engine
:
engine
.
name
url
keywordOffer
:
UrlbarUtils
.
KEYWORD_OFFER
.
SHOW
icon
:
UrlbarUtils
.
ICON
.
SEARCH_GLASS_INVERTED
dynamicType
:
DYNAMIC_RESULT_TYPE
}
)
;
result
.
resultSpan
=
2
;
showedOnboarding
=
true
;
}
else
{
result
=
new
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
.
.
.
UrlbarResult
.
payloadAndSimpleHighlights
(
queryContext
.
tokens
{
engine
:
engine
.
name
url
keywordOffer
:
UrlbarUtils
.
KEYWORD_OFFER
.
SHOW
icon
:
UrlbarUtils
.
ICON
.
SEARCH_GLASS_INVERTED
query
:
"
"
}
)
)
;
}
result
.
suggestedIndex
=
1
;
addCallback
(
this
result
)
;
}
if
(
showedOnboarding
)
{
Services
.
telemetry
.
keyedScalarAdd
(
"
urlbar
.
tips
"
"
tabtosearch_onboard
-
shown
"
1
)
;
}
}
}
var
UrlbarProviderTabToSearch
=
new
ProviderTabToSearch
(
)
;
initializeDynamicResult
(
)
;
