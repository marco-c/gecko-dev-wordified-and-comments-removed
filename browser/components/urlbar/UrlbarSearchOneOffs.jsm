"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
UrlbarSearchOneOffs
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
SearchOneOffs
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
SearchOneOffs
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
UrlbarPrefs
:
"
resource
:
/
/
/
modules
/
UrlbarPrefs
.
jsm
"
UrlbarUtils
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
}
)
;
class
UrlbarSearchOneOffs
extends
SearchOneOffs
{
constructor
(
view
)
{
super
(
view
.
panel
.
querySelector
(
"
.
search
-
one
-
offs
"
)
)
;
this
.
view
=
view
;
this
.
input
=
view
.
input
;
UrlbarPrefs
.
addObserver
(
this
)
;
this
.
disableOneOffsHorizontalKeyNavigation
=
true
;
this
.
_webEngines
=
[
]
;
}
get
localButtons
(
)
{
return
this
.
getSelectableButtons
(
false
)
.
filter
(
b
=
>
b
.
source
)
;
}
updateWebEngines
(
engines
)
{
this
.
_webEngines
=
engines
;
this
.
invalidateCache
(
)
;
if
(
this
.
view
.
isOpen
)
{
this
.
_rebuild
(
)
;
}
}
enable
(
enable
)
{
if
(
enable
)
{
this
.
telemetryOrigin
=
"
urlbar
"
;
this
.
style
.
display
=
"
"
;
this
.
textbox
=
this
.
view
.
input
.
inputField
;
if
(
this
.
view
.
isOpen
)
{
this
.
_rebuild
(
)
;
}
this
.
view
.
controller
.
addQueryListener
(
this
)
;
}
else
{
this
.
telemetryOrigin
=
null
;
this
.
style
.
display
=
"
none
"
;
this
.
textbox
=
null
;
this
.
view
.
controller
.
removeQueryListener
(
this
)
;
}
}
onViewOpen
(
)
{
this
.
_on_popupshowing
(
)
;
}
onViewClose
(
)
{
this
.
_on_popuphidden
(
)
;
}
get
hasView
(
)
{
return
this
.
style
.
display
!
=
"
none
"
&
&
!
this
.
container
.
hidden
;
}
get
isViewOpen
(
)
{
return
this
.
view
.
isOpen
;
}
set
selectedButton
(
button
)
{
if
(
this
.
selectedButton
=
=
button
)
{
return
;
}
super
.
selectedButton
=
button
;
let
expectedSearchMode
;
if
(
button
&
&
button
!
=
this
.
view
.
oneOffSearchButtons
.
settingsButton
)
{
expectedSearchMode
=
{
engineName
:
button
.
engine
?
.
name
source
:
button
.
source
entry
:
"
oneoff
"
}
;
this
.
input
.
searchMode
=
expectedSearchMode
;
}
else
if
(
this
.
input
.
searchMode
)
{
this
.
input
.
restoreSearchModeState
(
)
;
}
}
get
selectedButton
(
)
{
return
super
.
selectedButton
;
}
get
selectedViewIndex
(
)
{
return
this
.
view
.
selectedElementIndex
;
}
set
selectedViewIndex
(
val
)
{
this
.
view
.
selectedElementIndex
=
val
;
}
closeView
(
)
{
if
(
this
.
view
)
{
this
.
view
.
close
(
)
;
}
}
handleSearchCommand
(
event
searchMode
)
{
if
(
this
.
selectedButton
=
=
this
.
view
.
oneOffSearchButtons
.
settingsButton
|
|
this
.
selectedButton
.
classList
.
contains
(
"
searchbar
-
engine
-
one
-
off
-
add
-
engine
"
)
)
{
this
.
input
.
controller
.
engagementEvent
.
discard
(
)
;
this
.
selectedButton
.
doCommand
(
)
;
this
.
selectedButton
=
null
;
return
;
}
let
startQueryParams
=
{
allowAutofill
:
!
searchMode
.
engineName
&
&
searchMode
.
source
!
=
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
event
}
;
let
userTypedSearchString
=
this
.
input
.
value
&
&
this
.
input
.
getAttribute
(
"
pageproxystate
"
)
!
=
"
valid
"
;
let
engine
=
Services
.
search
.
getEngineByName
(
searchMode
.
engineName
)
;
let
{
where
params
}
=
this
.
_whereToOpen
(
event
)
;
if
(
userTypedSearchString
&
&
engine
&
&
(
event
.
shiftKey
|
|
where
!
=
"
current
"
)
)
{
this
.
input
.
handleNavigation
(
{
event
oneOffParams
:
{
openWhere
:
where
openParams
:
params
engine
:
this
.
selectedButton
.
engine
}
}
)
;
this
.
selectedButton
=
null
;
return
;
}
switch
(
where
)
{
case
"
current
"
:
{
this
.
input
.
searchMode
=
searchMode
;
this
.
input
.
startQuery
(
startQueryParams
)
;
break
;
}
case
"
tab
"
:
{
searchMode
.
isPreview
=
false
;
let
newTab
=
this
.
input
.
window
.
gBrowser
.
addTrustedTab
(
"
about
:
newtab
"
)
;
this
.
input
.
setSearchMode
(
searchMode
newTab
.
linkedBrowser
)
;
if
(
userTypedSearchString
)
{
newTab
.
linkedBrowser
.
userTypedValue
=
this
.
input
.
value
;
}
if
(
!
params
?
.
inBackground
)
{
this
.
input
.
window
.
gBrowser
.
selectedTab
=
newTab
;
newTab
.
ownerGlobal
.
gURLBar
.
startQuery
(
startQueryParams
)
;
}
break
;
}
default
:
{
this
.
input
.
searchMode
=
searchMode
;
this
.
input
.
startQuery
(
startQueryParams
)
;
this
.
input
.
select
(
)
;
break
;
}
}
this
.
selectedButton
=
null
;
}
setTooltipForEngineButton
(
button
)
{
let
aliases
=
button
.
engine
.
aliases
;
if
(
!
aliases
.
length
)
{
super
.
setTooltipForEngineButton
(
button
)
;
return
;
}
this
.
document
.
l10n
.
setAttributes
(
button
"
search
-
one
-
offs
-
engine
-
with
-
alias
"
{
engineName
:
button
.
engine
.
name
alias
:
aliases
[
0
]
}
)
;
}
async
willHide
(
)
{
let
superWillHide
=
await
super
.
willHide
(
)
;
if
(
UrlbarUtils
.
LOCAL_SEARCH_MODES
.
some
(
m
=
>
UrlbarPrefs
.
get
(
m
.
pref
)
)
)
{
return
false
;
}
return
superWillHide
;
}
onPrefChanged
(
changedPref
)
{
if
(
[
.
.
.
UrlbarUtils
.
LOCAL_SEARCH_MODES
.
map
(
m
=
>
m
.
pref
)
]
.
includes
(
changedPref
)
)
{
this
.
invalidateCache
(
)
;
}
}
_getAddEngines
(
)
{
return
this
.
_webEngines
;
}
_rebuildEngineList
(
engines
addEngines
)
{
super
.
_rebuildEngineList
(
engines
addEngines
)
;
for
(
let
{
source
pref
restrict
}
of
UrlbarUtils
.
LOCAL_SEARCH_MODES
)
{
if
(
!
UrlbarPrefs
.
get
(
pref
)
)
{
continue
;
}
let
name
=
UrlbarUtils
.
getResultSourceName
(
source
)
;
let
button
=
this
.
document
.
createXULElement
(
"
button
"
)
;
button
.
id
=
urlbar
-
engine
-
one
-
off
-
item
-
{
name
}
;
button
.
setAttribute
(
"
class
"
"
searchbar
-
engine
-
one
-
off
-
item
"
)
;
button
.
setAttribute
(
"
tabindex
"
"
-
1
"
)
;
this
.
document
.
l10n
.
setAttributes
(
button
search
-
one
-
offs
-
{
name
}
{
restrict
}
)
;
button
.
source
=
source
;
this
.
buttons
.
appendChild
(
button
)
;
}
}
_on_click
(
event
)
{
if
(
event
.
button
=
=
2
)
{
return
;
}
let
button
=
event
.
originalTarget
;
if
(
!
button
.
engine
&
&
!
button
.
source
)
{
return
;
}
this
.
selectedButton
=
button
;
this
.
handleSearchCommand
(
event
{
engineName
:
button
.
engine
?
.
name
source
:
button
.
source
entry
:
"
oneoff
"
}
)
;
}
_on_contextmenu
(
event
)
{
event
.
preventDefault
(
)
;
}
}
