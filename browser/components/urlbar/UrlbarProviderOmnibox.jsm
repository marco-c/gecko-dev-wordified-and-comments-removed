"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
UrlbarProviderOmnibox
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
Log
:
"
resource
:
/
/
gre
/
modules
/
Log
.
jsm
"
ExtensionSearchHandler
:
"
resource
:
/
/
gre
/
modules
/
ExtensionSearchHandler
.
jsm
"
SkippableTimer
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
UrlbarProvider
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
UrlbarResult
:
"
resource
:
/
/
/
modules
/
UrlbarResult
.
jsm
"
UrlbarUtils
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
logger
"
(
)
=
>
Log
.
repository
.
getLogger
(
"
Urlbar
.
Provider
.
Omnibox
"
)
)
;
const
MAXIMUM_ALLOWED_EXTENSION_TIME_MS
=
3000
;
class
ProviderOmnibox
extends
UrlbarProvider
{
constructor
(
)
{
super
(
)
;
this
.
queries
=
new
Map
(
)
;
}
get
name
(
)
{
return
"
Omnibox
"
;
}
get
type
(
)
{
return
UrlbarUtils
.
PROVIDER_TYPE
.
EXTENSION
;
}
isActive
(
queryContext
)
{
if
(
queryContext
.
tokens
[
0
]
&
&
queryContext
.
tokens
[
0
]
.
value
.
length
&
&
ExtensionSearchHandler
.
isKeywordRegistered
(
queryContext
.
tokens
[
0
]
.
value
)
&
&
UrlbarUtils
.
substringAfter
(
queryContext
.
searchString
queryContext
.
tokens
[
0
]
.
value
)
)
{
return
true
;
}
if
(
ExtensionSearchHandler
.
hasActiveInputSession
(
)
)
{
ExtensionSearchHandler
.
handleInputCancelled
(
)
;
}
return
false
;
}
getPriority
(
queryContext
)
{
return
0
;
}
async
startQuery
(
queryContext
addCallback
)
{
logger
.
info
(
Starting
query
for
{
queryContext
.
searchString
}
)
;
let
instance
=
{
}
;
this
.
queries
.
set
(
queryContext
instance
)
;
let
data
=
{
keyword
:
queryContext
.
tokens
[
0
]
.
value
text
:
queryContext
.
searchString
inPrivateWindow
:
queryContext
.
isPrivate
}
;
this
.
_resultsPromise
=
ExtensionSearchHandler
.
handleSearch
(
data
suggestions
=
>
{
for
(
let
suggestion
of
suggestions
)
{
let
content
=
{
queryContext
.
tokens
[
0
]
.
value
}
{
suggestion
.
content
}
;
let
result
=
new
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
OMNIBOX
UrlbarUtils
.
RESULT_SOURCE
.
OTHER_NETWORK
.
.
.
UrlbarResult
.
payloadAndSimpleHighlights
(
queryContext
.
tokens
{
title
:
[
suggestion
.
description
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
content
:
[
content
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
keyword
:
[
queryContext
.
tokens
[
0
]
.
value
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
icon
:
UrlbarUtils
.
ICON
.
EXTENSION
}
)
)
;
addCallback
(
this
result
)
;
}
}
)
;
let
timeoutPromise
=
new
SkippableTimer
(
{
name
:
"
ProviderOmnibox
"
time
:
MAXIMUM_ALLOWED_EXTENSION_TIME_MS
logger
}
)
.
promise
;
await
Promise
.
race
(
[
timeoutPromise
this
.
_resultsPromise
]
)
.
catch
(
Cu
.
reportError
)
;
this
.
queries
.
delete
(
queryContext
)
;
}
cancelQuery
(
queryContext
)
{
this
.
queries
.
delete
(
queryContext
)
;
}
}
var
UrlbarProviderOmnibox
=
new
ProviderOmnibox
(
)
;
