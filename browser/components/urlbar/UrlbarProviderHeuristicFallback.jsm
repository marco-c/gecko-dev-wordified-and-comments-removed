"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
UrlbarProviderHeuristicFallback
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
UrlbarPrefs
:
"
resource
:
/
/
/
modules
/
UrlbarPrefs
.
jsm
"
UrlbarProvider
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
UrlbarResult
:
"
resource
:
/
/
/
modules
/
UrlbarResult
.
jsm
"
UrlbarSearchUtils
:
"
resource
:
/
/
/
modules
/
UrlbarSearchUtils
.
jsm
"
UrlbarTokenizer
:
"
resource
:
/
/
/
modules
/
UrlbarTokenizer
.
jsm
"
UrlbarUtils
:
"
resource
:
/
/
/
modules
/
UrlbarUtils
.
jsm
"
}
)
;
class
ProviderHeuristicFallback
extends
UrlbarProvider
{
constructor
(
)
{
super
(
)
;
}
get
name
(
)
{
return
"
HeuristicFallback
"
;
}
get
type
(
)
{
return
UrlbarUtils
.
PROVIDER_TYPE
.
HEURISTIC
;
}
isActive
(
queryContext
)
{
return
true
;
}
getPriority
(
queryContext
)
{
return
0
;
}
async
startQuery
(
queryContext
addCallback
)
{
let
instance
=
this
.
queryInstance
;
let
result
=
this
.
_matchUnknownUrl
(
queryContext
)
;
if
(
result
)
{
addCallback
(
this
result
)
;
let
str
=
queryContext
.
searchString
;
try
{
new
URL
(
str
)
;
}
catch
(
ex
)
{
if
(
UrlbarPrefs
.
get
(
"
keyword
.
enabled
"
)
&
&
(
UrlbarTokenizer
.
looksLikeOrigin
(
str
{
noIp
:
true
noPort
:
true
}
)
|
|
UrlbarTokenizer
.
REGEXP_COMMON_EMAIL
.
test
(
str
)
)
)
{
let
searchResult
=
this
.
_engineSearchResult
(
queryContext
)
;
if
(
instance
!
=
this
.
queryInstance
)
{
return
;
}
addCallback
(
this
searchResult
)
;
}
}
return
;
}
result
=
this
.
_searchModeKeywordResult
(
queryContext
)
;
if
(
result
)
{
addCallback
(
this
result
)
;
return
;
}
result
=
this
.
_engineSearchResult
(
queryContext
)
;
if
(
instance
!
=
this
.
queryInstance
)
{
return
;
}
if
(
result
)
{
result
.
heuristic
=
true
;
addCallback
(
this
result
)
;
}
}
_matchUnknownUrl
(
queryContext
)
{
if
(
queryContext
.
restrictSource
=
=
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
|
|
UrlbarTokenizer
.
SEARCH_MODE_RESTRICT
.
has
(
queryContext
.
restrictToken
?
.
value
)
|
|
queryContext
.
searchMode
)
{
return
null
;
}
let
unescapedSearchString
=
Services
.
textToSubURI
.
unEscapeURIForUI
(
queryContext
.
searchString
)
;
let
[
prefix
suffix
]
=
UrlbarUtils
.
stripURLPrefix
(
unescapedSearchString
)
;
if
(
!
suffix
&
&
prefix
)
{
return
null
;
}
let
searchUrl
=
queryContext
.
trimmedSearchString
;
if
(
queryContext
.
fixupError
)
{
if
(
queryContext
.
fixupError
=
=
Cr
.
NS_ERROR_MALFORMED_URI
&
&
!
UrlbarPrefs
.
get
(
"
keyword
.
enabled
"
)
)
{
let
result
=
new
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
URL
UrlbarUtils
.
RESULT_SOURCE
.
OTHER_LOCAL
.
.
.
UrlbarResult
.
payloadAndSimpleHighlights
(
queryContext
.
tokens
{
title
:
[
searchUrl
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
url
:
[
searchUrl
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
}
)
)
;
result
.
heuristic
=
true
;
return
result
;
}
return
null
;
}
if
(
!
queryContext
.
fixupInfo
?
.
href
|
|
queryContext
.
fixupInfo
?
.
isSearch
)
{
return
null
;
}
let
uri
=
new
URL
(
queryContext
.
fixupInfo
.
href
)
;
let
hostExpected
=
[
"
http
:
"
"
https
:
"
"
ftp
:
"
"
chrome
:
"
]
.
includes
(
uri
.
protocol
)
;
if
(
hostExpected
&
&
!
uri
.
host
)
{
return
null
;
}
let
escapedURL
=
uri
.
toString
(
)
;
let
displayURL
=
decodeURI
(
uri
)
;
let
iconUri
;
if
(
hostExpected
&
&
(
searchUrl
.
endsWith
(
"
/
"
)
|
|
uri
.
pathname
.
length
>
1
)
)
{
let
pathIndex
=
uri
.
toString
(
)
.
lastIndexOf
(
uri
.
pathname
)
;
let
prePath
=
uri
.
toString
(
)
.
slice
(
0
pathIndex
)
;
iconUri
=
page
-
icon
:
{
prePath
}
/
;
}
let
result
=
new
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
URL
UrlbarUtils
.
RESULT_SOURCE
.
OTHER_LOCAL
.
.
.
UrlbarResult
.
payloadAndSimpleHighlights
(
queryContext
.
tokens
{
title
:
[
displayURL
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
url
:
[
escapedURL
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
icon
:
iconUri
}
)
)
;
result
.
heuristic
=
true
;
return
result
;
}
_searchModeKeywordResult
(
queryContext
)
{
if
(
!
UrlbarPrefs
.
get
(
"
update2
"
)
)
{
return
null
;
}
if
(
!
queryContext
.
tokens
.
length
)
{
return
null
;
}
let
firstToken
=
queryContext
.
tokens
[
0
]
.
value
;
if
(
!
UrlbarTokenizer
.
SEARCH_MODE_RESTRICT
.
has
(
firstToken
)
)
{
return
null
;
}
let
query
=
UrlbarUtils
.
substringAfter
(
queryContext
.
searchString
firstToken
)
;
if
(
!
UrlbarTokenizer
.
REGEXP_SPACES_START
.
test
(
query
)
)
{
return
null
;
}
let
result
;
if
(
queryContext
.
restrictSource
=
=
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
)
{
result
=
this
.
_engineSearchResult
(
queryContext
firstToken
)
;
}
else
{
result
=
new
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
UrlbarUtils
.
RESULT_SOURCE
.
OTHER_LOCAL
.
.
.
UrlbarResult
.
payloadAndSimpleHighlights
(
queryContext
.
tokens
{
query
:
[
query
.
trimStart
(
)
UrlbarUtils
.
HIGHLIGHT
.
NONE
]
keyword
:
[
firstToken
UrlbarUtils
.
HIGHLIGHT
.
NONE
]
}
)
)
;
}
result
.
heuristic
=
true
;
return
result
;
}
_engineSearchResult
(
queryContext
keyword
=
null
)
{
let
engine
;
if
(
queryContext
.
searchMode
?
.
engineName
)
{
engine
=
Services
.
search
.
getEngineByName
(
queryContext
.
searchMode
.
engineName
)
;
}
else
{
engine
=
UrlbarSearchUtils
.
getDefaultEngine
(
queryContext
.
isPrivate
)
;
}
if
(
!
engine
)
{
return
null
;
}
let
query
=
queryContext
.
searchString
;
if
(
queryContext
.
tokens
[
0
]
&
&
queryContext
.
tokens
[
0
]
.
value
=
=
=
UrlbarTokenizer
.
RESTRICT
.
SEARCH
)
{
query
=
UrlbarUtils
.
substringAfter
(
query
queryContext
.
tokens
[
0
]
.
value
)
.
trim
(
)
;
}
return
new
UrlbarResult
(
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
UrlbarUtils
.
RESULT_SOURCE
.
SEARCH
.
.
.
UrlbarResult
.
payloadAndSimpleHighlights
(
queryContext
.
tokens
{
engine
:
[
engine
.
name
UrlbarUtils
.
HIGHLIGHT
.
TYPED
]
icon
:
engine
.
iconURI
?
.
spec
query
:
[
query
UrlbarUtils
.
HIGHLIGHT
.
NONE
]
keyword
:
keyword
?
[
keyword
UrlbarUtils
.
HIGHLIGHT
.
NONE
]
:
undefined
}
)
)
;
}
}
var
UrlbarProviderHeuristicFallback
=
new
ProviderHeuristicFallback
(
)
;
