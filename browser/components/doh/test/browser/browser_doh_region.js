"
use
strict
"
;
add_task
(
async
function
testPrefFirstRollout
(
)
{
await
setup
(
)
;
await
setupRegion
(
)
;
let
defaults
=
Services
.
prefs
.
getDefaultBranch
(
"
"
)
;
is
(
DoHConfigController
.
currentConfig
.
enabled
false
"
Rollout
should
not
be
enabled
"
)
;
setPassingHeuristics
(
)
;
let
configFlushedPromise
=
DoHTestUtils
.
waitForConfigFlush
(
)
;
defaults
.
setBoolPref
(
{
kRegionalPrefNamespace
}
.
enabled
true
)
;
await
configFlushedPromise
;
is
(
DoHConfigController
.
currentConfig
.
enabled
true
"
Rollout
should
be
enabled
"
)
;
await
ensureTRRMode
(
2
)
;
is
(
Preferences
.
get
(
"
doh
-
rollout
.
home
-
region
"
)
"
DE
"
"
Initial
region
should
be
DE
"
)
;
RegionTestUtils
.
setNetworkRegion
(
"
UK
"
)
;
await
Region
.
_fetchRegion
(
)
;
Region
.
_setHomeRegion
(
"
UK
"
)
;
await
ensureTRRMode
(
2
)
;
Services
.
obs
.
notifyObservers
(
null
"
idle
-
daily
"
)
;
is
(
Preferences
.
get
(
"
doh
-
rollout
.
home
-
region
"
)
"
UK
"
)
;
is
(
DoHConfigController
.
currentConfig
.
enabled
false
"
Rollout
should
not
be
enabled
for
new
region
"
)
;
await
ensureTRRMode
(
undefined
)
;
await
setupRegion
(
)
;
defaults
.
deleteBranch
(
doh
-
rollout
.
de
)
;
Preferences
.
reset
(
"
doh
-
rollout
.
home
-
region
-
changed
"
)
;
Preferences
.
reset
(
"
doh
-
rollout
.
home
-
region
"
)
;
}
)
;
