Components
.
utils
.
import
(
"
resource
:
/
/
services
-
sync
/
main
.
js
"
)
;
Components
.
utils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
FxAccountsCommon
"
function
(
)
{
return
Components
.
utils
.
import
(
"
resource
:
/
/
gre
/
modules
/
FxAccountsCommon
.
js
"
{
}
)
;
}
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
fxAccounts
"
"
resource
:
/
/
gre
/
modules
/
FxAccounts
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
UIState
"
"
resource
:
/
/
services
-
sync
/
UIState
.
jsm
"
)
;
const
FXA_PAGE_LOGGED_OUT
=
0
;
const
FXA_PAGE_LOGGED_IN
=
1
;
const
FXA_LOGIN_VERIFIED
=
0
;
const
FXA_LOGIN_UNVERIFIED
=
1
;
const
FXA_LOGIN_FAILED
=
2
;
Preferences
.
addAll
(
[
{
id
:
"
engine
.
addons
"
name
:
"
services
.
sync
.
engine
.
addons
"
type
:
"
bool
"
}
{
id
:
"
engine
.
bookmarks
"
name
:
"
services
.
sync
.
engine
.
bookmarks
"
type
:
"
bool
"
}
{
id
:
"
engine
.
history
"
name
:
"
services
.
sync
.
engine
.
history
"
type
:
"
bool
"
}
{
id
:
"
engine
.
tabs
"
name
:
"
services
.
sync
.
engine
.
tabs
"
type
:
"
bool
"
}
{
id
:
"
engine
.
prefs
"
name
:
"
services
.
sync
.
engine
.
prefs
"
type
:
"
bool
"
}
{
id
:
"
engine
.
passwords
"
name
:
"
services
.
sync
.
engine
.
passwords
"
type
:
"
bool
"
}
{
id
:
"
engine
.
addresses
"
name
:
"
services
.
sync
.
engine
.
addresses
"
type
:
"
bool
"
}
{
id
:
"
engine
.
creditcards
"
name
:
"
services
.
sync
.
engine
.
creditcards
"
type
:
"
bool
"
}
]
)
;
var
gSyncPane
=
{
get
page
(
)
{
return
document
.
getElementById
(
"
weavePrefsDeck
"
)
.
selectedIndex
;
}
set
page
(
val
)
{
document
.
getElementById
(
"
weavePrefsDeck
"
)
.
selectedIndex
=
val
;
}
init
(
)
{
this
.
_setupEventListeners
(
)
;
this
.
_adjustForPrefs
(
)
;
let
xps
=
Components
.
classes
[
"
mozilla
.
org
/
weave
/
service
;
1
"
]
.
getService
(
Components
.
interfaces
.
nsISupports
)
.
wrappedJSObject
;
if
(
xps
.
ready
)
{
this
.
_init
(
)
;
return
;
}
this
.
_showLoadPage
(
xps
)
;
let
onUnload
=
function
(
)
{
window
.
removeEventListener
(
"
unload
"
onUnload
)
;
try
{
Services
.
obs
.
removeObserver
(
onReady
"
weave
:
service
:
ready
"
)
;
}
catch
(
e
)
{
}
}
;
let
onReady
=
(
)
=
>
{
Services
.
obs
.
removeObserver
(
onReady
"
weave
:
service
:
ready
"
)
;
window
.
removeEventListener
(
"
unload
"
onUnload
)
;
this
.
_init
(
)
;
}
;
Services
.
obs
.
addObserver
(
onReady
"
weave
:
service
:
ready
"
)
;
window
.
addEventListener
(
"
unload
"
onUnload
)
;
xps
.
ensureLoaded
(
)
;
}
_adjustForPrefs
(
)
{
let
enginePrefs
=
[
[
"
services
.
sync
.
engine
.
addresses
.
available
"
"
engine
.
addresses
"
]
[
"
services
.
sync
.
engine
.
creditcards
.
available
"
"
engine
.
creditcards
"
]
]
;
let
numHidden
=
0
;
for
(
let
[
availablePref
prefName
]
of
enginePrefs
)
{
if
(
!
Services
.
prefs
.
getBoolPref
(
availablePref
)
)
{
let
checkbox
=
document
.
querySelector
(
"
[
preference
=
\
"
"
+
prefName
+
"
\
"
]
"
)
;
checkbox
.
hidden
=
true
;
numHidden
+
=
1
;
}
}
if
(
numHidden
=
=
2
)
{
let
history
=
document
.
querySelector
(
"
[
preference
=
\
"
engine
.
history
\
"
]
"
)
;
let
addons
=
document
.
querySelector
(
"
[
preference
=
\
"
engine
.
addons
\
"
]
"
)
;
addons
.
parentNode
.
insertBefore
(
history
addons
)
;
}
}
_showLoadPage
(
xps
)
{
let
username
=
Services
.
prefs
.
getCharPref
(
"
services
.
sync
.
username
"
"
"
)
;
if
(
!
username
)
{
this
.
page
=
FXA_PAGE_LOGGED_OUT
;
return
;
}
let
cachedComputerName
=
Services
.
prefs
.
getCharPref
(
"
services
.
sync
.
client
.
name
"
"
"
)
;
document
.
querySelector
(
"
.
fxaEmailAddress
"
)
.
value
=
username
;
this
.
_populateComputerName
(
cachedComputerName
)
;
this
.
page
=
FXA_PAGE_LOGGED_IN
;
}
_init
(
)
{
Weave
.
Svc
.
Obs
.
add
(
UIState
.
ON_UPDATE
this
.
updateWeavePrefs
this
)
;
window
.
addEventListener
(
"
unload
"
(
)
=
>
{
Weave
.
Svc
.
Obs
.
remove
(
UIState
.
ON_UPDATE
this
.
updateWeavePrefs
this
)
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
_accountsStringBundle
"
(
)
=
>
{
return
Services
.
strings
.
createBundle
(
"
chrome
:
/
/
browser
/
locale
/
accounts
.
properties
"
)
;
}
)
;
let
url
=
Services
.
prefs
.
getCharPref
(
"
identity
.
mobilepromo
.
android
"
)
+
"
sync
-
preferences
"
;
document
.
getElementById
(
"
fxaMobilePromo
-
android
"
)
.
setAttribute
(
"
href
"
url
)
;
document
.
getElementById
(
"
fxaMobilePromo
-
android
-
hasFxaAccount
"
)
.
setAttribute
(
"
href
"
url
)
;
url
=
Services
.
prefs
.
getCharPref
(
"
identity
.
mobilepromo
.
ios
"
)
+
"
sync
-
preferences
"
;
document
.
getElementById
(
"
fxaMobilePromo
-
ios
"
)
.
setAttribute
(
"
href
"
url
)
;
document
.
getElementById
(
"
fxaMobilePromo
-
ios
-
hasFxaAccount
"
)
.
setAttribute
(
"
href
"
url
)
;
document
.
getElementById
(
"
tosPP
-
small
-
ToS
"
)
.
setAttribute
(
"
href
"
Weave
.
Svc
.
Prefs
.
get
(
"
fxa
.
termsURL
"
)
)
;
document
.
getElementById
(
"
tosPP
-
small
-
PP
"
)
.
setAttribute
(
"
href
"
Weave
.
Svc
.
Prefs
.
get
(
"
fxa
.
privacyURL
"
)
)
;
fxAccounts
.
promiseAccountsSignUpURI
(
this
.
_getEntryPoint
(
)
)
.
then
(
signUpURI
=
>
{
document
.
getElementById
(
"
noFxaSignUp
"
)
.
setAttribute
(
"
href
"
signUpURI
)
;
}
)
;
this
.
updateWeavePrefs
(
)
;
Services
.
obs
.
notifyObservers
(
window
"
sync
-
pane
-
loaded
"
)
;
}
_toggleComputerNameControls
(
editMode
)
{
let
textbox
=
document
.
getElementById
(
"
fxaSyncComputerName
"
)
;
textbox
.
disabled
=
!
editMode
;
document
.
getElementById
(
"
fxaChangeDeviceName
"
)
.
hidden
=
editMode
;
document
.
getElementById
(
"
fxaCancelChangeDeviceName
"
)
.
hidden
=
!
editMode
;
document
.
getElementById
(
"
fxaSaveChangeDeviceName
"
)
.
hidden
=
!
editMode
;
}
_focusComputerNameTextbox
(
)
{
let
textbox
=
document
.
getElementById
(
"
fxaSyncComputerName
"
)
;
let
valLength
=
textbox
.
value
.
length
;
textbox
.
focus
(
)
;
textbox
.
setSelectionRange
(
valLength
valLength
)
;
}
_blurComputerNameTextbox
(
)
{
document
.
getElementById
(
"
fxaSyncComputerName
"
)
.
blur
(
)
;
}
_focusAfterComputerNameTextbox
(
)
{
Services
.
focus
.
moveFocus
(
window
document
.
getElementById
(
"
fxaSyncComputerName
"
)
Services
.
focus
.
MOVEFOCUS_FORWARD
0
)
;
}
_updateComputerNameValue
(
save
)
{
if
(
save
)
{
let
textbox
=
document
.
getElementById
(
"
fxaSyncComputerName
"
)
;
Weave
.
Service
.
clientsEngine
.
localName
=
textbox
.
value
;
}
this
.
_populateComputerName
(
Weave
.
Service
.
clientsEngine
.
localName
)
;
}
_setupEventListeners
(
)
{
function
setEventListener
(
aId
aEventType
aCallback
)
{
document
.
getElementById
(
aId
)
.
addEventListener
(
aEventType
aCallback
.
bind
(
gSyncPane
)
)
;
}
setEventListener
(
"
fxaChangeDeviceName
"
"
command
"
function
(
)
{
this
.
_toggleComputerNameControls
(
true
)
;
this
.
_focusComputerNameTextbox
(
)
;
}
)
;
setEventListener
(
"
fxaCancelChangeDeviceName
"
"
command
"
function
(
)
{
this
.
_blurComputerNameTextbox
(
)
;
this
.
_toggleComputerNameControls
(
false
)
;
this
.
_updateComputerNameValue
(
false
)
;
this
.
_focusAfterComputerNameTextbox
(
)
;
}
)
;
setEventListener
(
"
fxaSaveChangeDeviceName
"
"
command
"
function
(
)
{
this
.
_blurComputerNameTextbox
(
)
;
this
.
_toggleComputerNameControls
(
false
)
;
this
.
_updateComputerNameValue
(
true
)
;
this
.
_focusAfterComputerNameTextbox
(
)
;
}
)
;
setEventListener
(
"
noFxaSignIn
"
"
command
"
function
(
)
{
gSyncPane
.
signIn
(
)
;
return
false
;
}
)
;
setEventListener
(
"
fxaUnlinkButton
"
"
command
"
function
(
)
{
gSyncPane
.
unlinkFirefoxAccount
(
true
)
;
}
)
;
setEventListener
(
"
verifyFxaAccount
"
"
command
"
gSyncPane
.
verifyFirefoxAccount
)
;
setEventListener
(
"
unverifiedUnlinkFxaAccount
"
"
command
"
function
(
)
{
gSyncPane
.
unlinkFirefoxAccount
(
false
)
;
}
)
;
setEventListener
(
"
rejectReSignIn
"
"
command
"
gSyncPane
.
reSignIn
)
;
setEventListener
(
"
rejectUnlinkFxaAccount
"
"
command
"
function
(
)
{
gSyncPane
.
unlinkFirefoxAccount
(
true
)
;
}
)
;
setEventListener
(
"
fxaSyncComputerName
"
"
keypress
"
function
(
e
)
{
if
(
e
.
keyCode
=
=
KeyEvent
.
DOM_VK_RETURN
)
{
document
.
getElementById
(
"
fxaSaveChangeDeviceName
"
)
.
click
(
)
;
}
else
if
(
e
.
keyCode
=
=
KeyEvent
.
DOM_VK_ESCAPE
)
{
document
.
getElementById
(
"
fxaCancelChangeDeviceName
"
)
.
click
(
)
;
}
}
)
;
}
updateWeavePrefs
(
)
{
let
service
=
Components
.
classes
[
"
mozilla
.
org
/
weave
/
service
;
1
"
]
.
getService
(
Components
.
interfaces
.
nsISupports
)
.
wrappedJSObject
;
let
displayNameLabel
=
document
.
getElementById
(
"
fxaDisplayName
"
)
;
let
fxaEmailAddressLabels
=
document
.
querySelectorAll
(
"
.
fxaEmailAddress
"
)
;
displayNameLabel
.
hidden
=
true
;
this
.
_showLoadPage
(
service
)
;
let
state
=
UIState
.
get
(
)
;
if
(
state
.
status
=
=
UIState
.
STATUS_NOT_CONFIGURED
)
{
this
.
page
=
FXA_PAGE_LOGGED_OUT
;
return
;
}
this
.
page
=
FXA_PAGE_LOGGED_IN
;
let
fxaLoginStatus
=
document
.
getElementById
(
"
fxaLoginStatus
"
)
;
let
syncReady
=
false
;
if
(
state
.
status
=
=
UIState
.
STATUS_LOGIN_FAILED
)
{
fxaLoginStatus
.
selectedIndex
=
FXA_LOGIN_FAILED
;
}
else
if
(
state
.
status
=
=
UIState
.
STATUS_NOT_VERIFIED
)
{
fxaLoginStatus
.
selectedIndex
=
FXA_LOGIN_UNVERIFIED
;
}
else
{
fxaLoginStatus
.
selectedIndex
=
FXA_LOGIN_VERIFIED
;
syncReady
=
true
;
}
fxaEmailAddressLabels
.
forEach
(
(
label
)
=
>
{
label
.
value
=
state
.
email
;
}
)
;
this
.
_populateComputerName
(
Weave
.
Service
.
clientsEngine
.
localName
)
;
let
engines
=
document
.
getElementById
(
"
fxaSyncEngines
"
)
;
for
(
let
checkbox
of
engines
.
querySelectorAll
(
"
checkbox
"
)
)
{
checkbox
.
disabled
=
!
syncReady
;
}
document
.
getElementById
(
"
fxaChangeDeviceName
"
)
.
disabled
=
!
syncReady
;
document
.
querySelector
(
"
#
fxaLoginVerified
>
.
fxaProfileImage
"
)
.
style
.
removeProperty
(
"
list
-
style
-
image
"
)
;
if
(
state
.
displayName
)
{
fxaLoginStatus
.
setAttribute
(
"
hasName
"
true
)
;
displayNameLabel
.
hidden
=
false
;
displayNameLabel
.
textContent
=
state
.
displayName
;
}
else
{
fxaLoginStatus
.
removeAttribute
(
"
hasName
"
)
;
}
if
(
state
.
avatarURL
)
{
let
bgImage
=
"
url
(
\
"
"
+
state
.
avatarURL
+
"
\
"
)
"
;
let
profileImageElement
=
document
.
querySelector
(
"
#
fxaLoginVerified
>
.
fxaProfileImage
"
)
;
profileImageElement
.
style
.
listStyleImage
=
bgImage
;
let
img
=
new
Image
(
)
;
img
.
onerror
=
(
)
=
>
{
if
(
profileImageElement
.
style
.
listStyleImage
=
=
=
bgImage
)
{
profileImageElement
.
style
.
removeProperty
(
"
list
-
style
-
image
"
)
;
}
}
;
img
.
src
=
state
.
avatarURL
;
}
fxAccounts
.
promiseAccountsManageURI
(
this
.
_getEntryPoint
(
)
)
.
then
(
accountsManageURI
=
>
{
document
.
getElementById
(
"
verifiedManage
"
)
.
setAttribute
(
"
href
"
accountsManageURI
)
;
}
)
;
}
_getEntryPoint
(
)
{
let
params
=
new
URLSearchParams
(
document
.
URL
.
split
(
"
#
"
)
[
0
]
.
split
(
"
?
"
)
[
1
]
|
|
"
"
)
;
return
params
.
get
(
"
entrypoint
"
)
|
|
"
preferences
"
;
}
openContentInBrowser
(
url
options
)
{
let
win
=
Services
.
wm
.
getMostRecentWindow
(
"
navigator
:
browser
"
)
;
if
(
!
win
)
{
openUILinkIn
(
url
"
tab
"
)
;
return
;
}
win
.
switchToTabHavingURI
(
url
true
options
)
;
}
replaceTabWithUrl
(
url
)
{
let
browser
=
window
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebNavigation
)
.
QueryInterface
(
Ci
.
nsIDocShell
)
.
chromeEventHandler
;
browser
.
loadURI
(
url
)
;
}
async
signIn
(
)
{
const
url
=
await
fxAccounts
.
promiseAccountsSignInURI
(
this
.
_getEntryPoint
(
)
)
;
this
.
replaceTabWithUrl
(
url
)
;
}
async
reSignIn
(
)
{
let
entryPoint
=
this
.
_getEntryPoint
(
)
;
const
url
=
(
await
fxAccounts
.
promiseAccountsForceSigninURI
(
entryPoint
)
)
|
|
(
await
fxAccounts
.
promiseAccountsSignInURI
(
entryPoint
)
)
;
this
.
replaceTabWithUrl
(
url
)
;
}
clickOrSpaceOrEnterPressed
(
event
)
{
return
(
(
event
.
type
=
=
"
click
"
&
&
event
.
button
=
=
0
)
|
|
(
event
.
type
=
=
"
keypress
"
&
&
(
event
.
charCode
=
=
KeyEvent
.
DOM_VK_SPACE
|
|
event
.
keyCode
=
=
KeyEvent
.
DOM_VK_RETURN
)
)
)
;
}
openChangeProfileImage
(
event
)
{
if
(
this
.
clickOrSpaceOrEnterPressed
(
event
)
)
{
fxAccounts
.
promiseAccountsChangeProfileURI
(
this
.
_getEntryPoint
(
)
"
avatar
"
)
.
then
(
url
=
>
{
this
.
openContentInBrowser
(
url
{
replaceQueryString
:
true
triggeringPrincipal
:
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
}
)
;
}
)
;
event
.
preventDefault
(
)
;
}
}
openManageFirefoxAccount
(
event
)
{
if
(
this
.
clickOrSpaceOrEnterPressed
(
event
)
)
{
this
.
manageFirefoxAccount
(
)
;
event
.
preventDefault
(
)
;
}
}
manageFirefoxAccount
(
)
{
fxAccounts
.
promiseAccountsManageURI
(
this
.
_getEntryPoint
(
)
)
.
then
(
url
=
>
{
this
.
openContentInBrowser
(
url
{
replaceQueryString
:
true
triggeringPrincipal
:
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
}
)
;
}
)
;
}
verifyFirefoxAccount
(
)
{
let
showVerifyNotification
=
(
data
)
=
>
{
let
isError
=
!
data
;
let
maybeNot
=
isError
?
"
Not
"
:
"
"
;
let
sb
=
this
.
_accountsStringBundle
;
let
title
=
sb
.
GetStringFromName
(
"
verification
"
+
maybeNot
+
"
SentTitle
"
)
;
let
email
=
!
isError
&
&
data
?
data
.
email
:
"
"
;
let
body
=
sb
.
formatStringFromName
(
"
verification
"
+
maybeNot
+
"
SentBody
"
[
email
]
1
)
;
new
Notification
(
title
{
body
}
)
;
}
;
let
onError
=
(
)
=
>
{
showVerifyNotification
(
)
;
}
;
let
onSuccess
=
data
=
>
{
if
(
data
)
{
showVerifyNotification
(
data
)
;
}
else
{
onError
(
)
;
}
}
;
fxAccounts
.
resendVerificationEmail
(
)
.
then
(
fxAccounts
.
getSignedInUser
onError
)
.
then
(
onSuccess
onError
)
;
}
unlinkFirefoxAccount
(
confirm
)
{
if
(
confirm
)
{
let
sb
=
Services
.
strings
.
createBundle
(
"
chrome
:
/
/
browser
/
locale
/
syncSetup
.
properties
"
)
;
let
disconnectLabel
=
sb
.
GetStringFromName
(
"
disconnect
.
label
"
)
;
let
title
=
sb
.
GetStringFromName
(
"
disconnect
.
verify
.
title
"
)
;
let
body
=
sb
.
GetStringFromName
(
"
disconnect
.
verify
.
bodyHeading
"
)
+
"
\
n
\
n
"
+
sb
.
GetStringFromName
(
"
disconnect
.
verify
.
bodyText
"
)
;
let
ps
=
Services
.
prompt
;
let
buttonFlags
=
(
ps
.
BUTTON_POS_0
*
ps
.
BUTTON_TITLE_IS_STRING
)
+
(
ps
.
BUTTON_POS_1
*
ps
.
BUTTON_TITLE_CANCEL
)
+
ps
.
BUTTON_POS_1_DEFAULT
;
let
factory
=
Cc
[
"
mozilla
.
org
/
prompter
;
1
"
]
.
getService
(
Ci
.
nsIPromptFactory
)
;
let
prompt
=
factory
.
getPrompt
(
window
Ci
.
nsIPrompt
)
;
let
bag
=
prompt
.
QueryInterface
(
Ci
.
nsIWritablePropertyBag2
)
;
bag
.
setPropertyAsBool
(
"
allowTabModal
"
true
)
;
let
pressed
=
prompt
.
confirmEx
(
title
body
buttonFlags
disconnectLabel
null
null
null
{
}
)
;
if
(
pressed
!
=
0
)
{
return
;
}
}
fxAccounts
.
signOut
(
)
.
then
(
(
)
=
>
{
this
.
updateWeavePrefs
(
)
;
}
)
;
}
_populateComputerName
(
value
)
{
let
textbox
=
document
.
getElementById
(
"
fxaSyncComputerName
"
)
;
if
(
!
textbox
.
hasAttribute
(
"
placeholder
"
)
)
{
textbox
.
setAttribute
(
"
placeholder
"
Weave
.
Utils
.
getDefaultDeviceName
(
)
)
;
}
textbox
.
value
=
value
;
}
}
;
