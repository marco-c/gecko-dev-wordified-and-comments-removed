Preferences
.
addAll
(
[
{
id
:
"
browser
.
startup
.
homepage
"
type
:
"
wstring
"
}
{
id
:
"
pref
.
browser
.
homepage
.
disable_button
.
current_page
"
type
:
"
bool
"
}
{
id
:
"
pref
.
browser
.
homepage
.
disable_button
.
bookmark_page
"
type
:
"
bool
"
}
{
id
:
"
pref
.
browser
.
homepage
.
disable_button
.
restore_default
"
type
:
"
bool
"
}
{
id
:
"
browser
.
newtabpage
.
enabled
"
type
:
"
bool
"
}
]
)
;
const
HOMEPAGE_OVERRIDE_KEY
=
"
homepage_override
"
;
const
URL_OVERRIDES_TYPE
=
"
url_overrides
"
;
const
NEW_TAB_KEY
=
"
newTabURL
"
;
var
gHomePane
=
{
HOME_MODE_FIREFOX_HOME
:
"
0
"
HOME_MODE_BLANK
:
"
1
"
HOME_MODE_CUSTOM
:
"
2
"
HOMEPAGE_PREF
:
"
browser
.
startup
.
homepage
"
NEWTAB_ENABLED_PREF
:
"
browser
.
newtabpage
.
enabled
"
ACTIVITY_STREAM_PREF_BRANCH
:
"
browser
.
newtabpage
.
activity
-
stream
.
"
get
homePanePrefs
(
)
{
return
Preferences
.
getAll
(
)
.
filter
(
pref
=
>
pref
.
id
.
includes
(
this
.
ACTIVITY_STREAM_PREF_BRANCH
)
)
;
}
get
isPocketNewtabEnabled
(
)
{
const
value
=
Services
.
prefs
.
getStringPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
discoverystream
.
config
"
"
"
)
;
if
(
value
)
{
try
{
return
JSON
.
parse
(
value
)
.
enabled
;
}
catch
(
e
)
{
console
.
error
(
"
Failed
to
parse
Discovery
Stream
pref
.
"
)
;
}
}
return
false
;
}
async
_handleNewTabOverrides
(
)
{
const
isControlled
=
await
handleControllingExtension
(
URL_OVERRIDES_TYPE
NEW_TAB_KEY
)
;
const
el
=
document
.
getElementById
(
"
newTabMode
"
)
;
el
.
disabled
=
isControlled
;
}
watchNewTab
(
)
{
this
.
_handleNewTabOverrides
(
)
;
let
newTabObserver
=
{
observe
:
this
.
_handleNewTabOverrides
.
bind
(
this
)
}
;
Services
.
obs
.
addObserver
(
newTabObserver
"
newtab
-
url
-
changed
"
)
;
window
.
addEventListener
(
"
unload
"
(
)
=
>
{
Services
.
obs
.
removeObserver
(
newTabObserver
"
newtab
-
url
-
changed
"
)
;
}
)
;
}
watchHomeTabPrefChange
(
)
{
const
observer
=
(
)
=
>
this
.
toggleRestoreDefaultsBtn
(
)
;
Services
.
prefs
.
addObserver
(
this
.
ACTIVITY_STREAM_PREF_BRANCH
observer
)
;
Services
.
prefs
.
addObserver
(
this
.
HOMEPAGE_PREF
observer
)
;
Services
.
prefs
.
addObserver
(
this
.
NEWTAB_ENABLED_PREF
observer
)
;
window
.
addEventListener
(
"
unload
"
(
)
=
>
{
Services
.
prefs
.
removeObserver
(
this
.
ACTIVITY_STREAM_PREF_BRANCH
observer
)
;
Services
.
prefs
.
removeObserver
(
this
.
HOMEPAGE_PREF
observer
)
;
Services
.
prefs
.
removeObserver
(
this
.
NEWTAB_ENABLED_PREF
observer
)
;
}
)
;
}
_renderCustomSettings
(
options
=
{
}
)
{
let
{
shouldShow
isControlled
}
=
options
;
const
customSettingsContainerEl
=
document
.
getElementById
(
"
customSettings
"
)
;
const
customUrlEl
=
document
.
getElementById
(
"
homePageUrl
"
)
;
const
homePage
=
HomePage
.
get
(
)
;
const
isHomePageCustom
=
isControlled
|
|
(
!
this
.
_isHomePageDefaultValue
(
)
&
&
!
this
.
isHomePageBlank
(
)
)
;
if
(
typeof
shouldShow
=
=
=
"
undefined
"
)
{
shouldShow
=
isHomePageCustom
;
}
customSettingsContainerEl
.
hidden
=
!
shouldShow
;
let
newValue
;
if
(
homePage
=
=
=
"
about
:
blank
"
|
|
(
HomePage
.
isDefault
&
&
!
HomePage
.
locked
)
)
{
newValue
=
"
"
;
}
else
{
newValue
=
homePage
;
}
if
(
customUrlEl
.
value
!
=
=
newValue
)
{
customUrlEl
.
value
=
newValue
;
}
}
_isHomePageDefaultValue
(
)
{
const
startupPref
=
Preferences
.
get
(
"
browser
.
startup
.
page
"
)
;
return
(
startupPref
.
value
!
=
=
gMainPane
.
STARTUP_PREF_BLANK
&
&
HomePage
.
isDefault
)
;
}
isHomePageBlank
(
)
{
const
startupPref
=
Preferences
.
get
(
"
browser
.
startup
.
page
"
)
;
return
(
[
"
about
:
blank
"
"
"
]
.
includes
(
HomePage
.
get
(
)
)
|
|
startupPref
.
value
=
=
=
gMainPane
.
STARTUP_PREF_BLANK
)
;
}
isHomePageControlled
(
)
{
if
(
HomePage
.
locked
)
{
return
Promise
.
resolve
(
false
)
;
}
return
handleControllingExtension
(
PREF_SETTING_TYPE
HOMEPAGE_OVERRIDE_KEY
)
;
}
_isTabAboutPreferences
(
aTab
)
{
return
aTab
.
linkedBrowser
.
currentURI
.
spec
.
startsWith
(
"
about
:
preferences
"
)
;
}
_getTabsForHomePage
(
)
{
let
tabs
=
[
]
;
let
win
=
Services
.
wm
.
getMostRecentWindow
(
"
navigator
:
browser
"
)
;
if
(
win
&
&
win
.
document
.
documentElement
.
getAttribute
(
"
windowtype
"
)
=
=
=
"
navigator
:
browser
"
)
{
tabs
=
win
.
gBrowser
.
visibleTabs
.
slice
(
win
.
gBrowser
.
_numPinnedTabs
)
;
tabs
=
tabs
.
filter
(
tab
=
>
!
this
.
_isTabAboutPreferences
(
tab
)
)
;
tabs
=
tabs
.
filter
(
tab
=
>
!
tab
.
closing
)
;
}
return
tabs
;
}
_renderHomepageMode
(
isControlled
)
{
const
isDefault
=
this
.
_isHomePageDefaultValue
(
)
;
const
isBlank
=
this
.
isHomePageBlank
(
)
;
const
el
=
document
.
getElementById
(
"
homeMode
"
)
;
let
newValue
;
if
(
isControlled
)
{
newValue
=
this
.
HOME_MODE_CUSTOM
;
}
else
if
(
isDefault
)
{
newValue
=
this
.
HOME_MODE_FIREFOX_HOME
;
}
else
if
(
isBlank
)
{
newValue
=
this
.
HOME_MODE_BLANK
;
}
else
{
newValue
=
this
.
HOME_MODE_CUSTOM
;
}
if
(
el
.
value
!
=
=
newValue
)
{
el
.
value
=
newValue
;
}
}
_setInputDisabledStates
(
isControlled
)
{
let
tabCount
=
this
.
_getTabsForHomePage
(
)
.
length
;
document
.
querySelectorAll
(
"
.
check
-
home
-
page
-
controlled
"
)
.
forEach
(
element
=
>
{
let
isDisabled
;
let
pref
=
element
.
getAttribute
(
"
preference
"
)
|
|
element
.
getAttribute
(
"
data
-
preference
-
related
"
)
;
if
(
!
pref
)
{
throw
new
Error
(
Element
with
id
{
element
.
id
}
did
not
have
preference
or
data
-
preference
-
related
attribute
defined
.
)
;
}
if
(
pref
=
=
=
this
.
HOMEPAGE_PREF
)
{
isDisabled
=
HomePage
.
locked
|
|
isControlled
;
}
else
{
isDisabled
=
Preferences
.
get
(
pref
)
.
locked
|
|
isControlled
;
}
if
(
pref
=
=
=
"
pref
.
browser
.
disable_button
.
current_page
"
)
{
isDisabled
=
isDisabled
|
|
tabCount
<
1
;
}
element
.
disabled
=
isDisabled
;
}
)
;
}
async
_handleHomePageOverrides
(
)
{
if
(
HomePage
.
locked
)
{
hideControllingExtension
(
HOMEPAGE_OVERRIDE_KEY
)
;
this
.
_setInputDisabledStates
(
false
)
;
}
else
{
const
isControlled
=
await
this
.
isHomePageControlled
(
)
;
this
.
_setInputDisabledStates
(
isControlled
)
;
this
.
_renderCustomSettings
(
{
isControlled
}
)
;
this
.
_renderHomepageMode
(
isControlled
)
;
}
}
syncFromHomePref
(
)
{
this
.
_updateUseCurrentButton
(
)
;
this
.
_renderCustomSettings
(
)
;
this
.
_renderHomepageMode
(
)
;
this
.
_handleHomePageOverrides
(
)
;
}
syncFromNewTabPref
(
)
{
const
newtabPref
=
Preferences
.
get
(
this
.
NEWTAB_ENABLED_PREF
)
;
return
newtabPref
.
value
?
this
.
HOME_MODE_FIREFOX_HOME
:
this
.
HOME_MODE_BLANK
;
}
syncToNewTabPref
(
value
)
{
return
value
!
=
=
this
.
HOME_MODE_BLANK
;
}
onMenuChange
(
event
)
{
const
{
value
}
=
event
.
target
;
const
startupPref
=
Preferences
.
get
(
"
browser
.
startup
.
page
"
)
;
switch
(
value
)
{
case
this
.
HOME_MODE_FIREFOX_HOME
:
if
(
startupPref
.
value
=
=
=
gMainPane
.
STARTUP_PREF_BLANK
)
{
startupPref
.
value
=
gMainPane
.
STARTUP_PREF_HOMEPAGE
;
}
if
(
!
HomePage
.
isDefault
)
{
HomePage
.
reset
(
)
;
}
else
{
this
.
_renderCustomSettings
(
{
shouldShow
:
false
}
)
;
}
break
;
case
this
.
HOME_MODE_BLANK
:
if
(
HomePage
.
get
(
)
!
=
=
"
about
:
blank
"
)
{
HomePage
.
set
(
"
about
:
blank
"
)
;
}
else
{
this
.
_renderCustomSettings
(
{
shouldShow
:
false
}
)
;
}
break
;
case
this
.
HOME_MODE_CUSTOM
:
if
(
startupPref
.
value
=
=
=
gMainPane
.
STARTUP_PREF_BLANK
)
{
Services
.
prefs
.
clearUserPref
(
startupPref
.
id
)
;
}
this
.
_renderCustomSettings
(
{
shouldShow
:
true
}
)
;
break
;
}
}
async
_updateUseCurrentButton
(
)
{
let
useCurrent
=
document
.
getElementById
(
"
useCurrentBtn
"
)
;
let
tabs
=
this
.
_getTabsForHomePage
(
)
;
const
tabCount
=
tabs
.
length
;
document
.
l10n
.
setAttributes
(
useCurrent
"
use
-
current
-
pages
"
{
tabCount
}
)
;
if
(
await
getControllingExtensionInfo
(
PREF_SETTING_TYPE
HOMEPAGE_OVERRIDE_KEY
)
)
{
return
;
}
let
prefName
=
"
pref
.
browser
.
homepage
.
disable_button
.
current_page
"
;
if
(
Preferences
.
get
(
prefName
)
.
locked
)
{
return
;
}
useCurrent
.
disabled
=
tabCount
<
1
;
}
setHomePageToCurrent
(
)
{
let
tabs
=
this
.
_getTabsForHomePage
(
)
;
function
getTabURI
(
t
)
{
return
t
.
linkedBrowser
.
currentURI
.
spec
;
}
if
(
tabs
.
length
)
{
HomePage
.
set
(
tabs
.
map
(
getTabURI
)
.
join
(
"
|
"
)
)
;
}
Services
.
telemetry
.
scalarAdd
(
"
preferences
.
use_current_page
"
1
)
;
}
_setHomePageToBookmarkClosed
(
rv
aEvent
)
{
if
(
aEvent
.
detail
.
button
!
=
"
accept
"
)
{
return
;
}
if
(
rv
.
urls
&
&
rv
.
names
)
{
HomePage
.
set
(
rv
.
urls
.
join
(
"
|
"
)
)
;
}
}
setHomePageToBookmark
(
)
{
const
rv
=
{
urls
:
null
names
:
null
}
;
gSubDialog
.
open
(
"
chrome
:
/
/
browser
/
content
/
preferences
/
selectBookmark
.
xul
"
"
resizable
=
yes
modal
=
yes
"
rv
this
.
_setHomePageToBookmarkClosed
.
bind
(
this
rv
)
)
;
Services
.
telemetry
.
scalarAdd
(
"
preferences
.
use_bookmark
"
1
)
;
}
restoreDefaultHomePage
(
)
{
HomePage
.
reset
(
)
;
Services
.
prefs
.
clearUserPref
(
this
.
NEWTAB_ENABLED_PREF
)
;
}
onCustomHomePageInput
(
event
)
{
if
(
this
.
_telemetryHomePageTimer
)
{
clearTimeout
(
this
.
_telemetryHomePageTimer
)
;
}
let
browserHomePage
=
event
.
target
.
value
;
if
(
browserHomePage
.
length
>
4
&
&
browserHomePage
.
includes
(
"
.
"
)
)
{
this
.
_telemetryHomePageTimer
=
setTimeout
(
(
)
=
>
{
let
homePageNumber
=
browserHomePage
.
split
(
"
|
"
)
.
length
;
Services
.
telemetry
.
scalarAdd
(
"
preferences
.
browser_home_page_change
"
1
)
;
Services
.
telemetry
.
keyedScalarAdd
(
"
preferences
.
browser_home_page_count
"
homePageNumber
1
)
;
}
3000
)
;
}
}
onCustomHomePageChange
(
event
)
{
const
value
=
event
.
target
.
value
|
|
HomePage
.
getDefault
(
)
;
HomePage
.
set
(
value
)
;
}
_changedHomeTabDefaultPrefs
(
)
{
const
homeContentChanged
=
!
this
.
isPocketNewtabEnabled
&
&
this
.
homePanePrefs
.
some
(
pref
=
>
pref
.
hasUserValue
)
;
const
newtabPref
=
Preferences
.
get
(
this
.
NEWTAB_ENABLED_PREF
)
;
return
homeContentChanged
|
|
HomePage
.
overridden
|
|
newtabPref
.
hasUserValue
;
}
toggleRestoreDefaultsBtn
(
)
{
const
btn
=
document
.
getElementById
(
"
restoreDefaultHomePageBtn
"
)
;
const
prefChanged
=
this
.
_changedHomeTabDefaultPrefs
(
)
;
btn
.
style
.
visibility
=
prefChanged
?
"
visible
"
:
"
hidden
"
;
}
restoreDefaultPrefsForHome
(
)
{
this
.
restoreDefaultHomePage
(
)
;
if
(
!
this
.
isPocketNewtabEnabled
)
{
this
.
homePanePrefs
.
forEach
(
pref
=
>
Services
.
prefs
.
clearUserPref
(
pref
.
id
)
)
;
}
}
init
(
)
{
document
.
getElementById
(
"
homeMode
"
)
.
addEventListener
(
"
command
"
this
.
onMenuChange
.
bind
(
this
)
)
;
document
.
getElementById
(
"
homePageUrl
"
)
.
addEventListener
(
"
change
"
this
.
onCustomHomePageChange
.
bind
(
this
)
)
;
document
.
getElementById
(
"
homePageUrl
"
)
.
addEventListener
(
"
input
"
this
.
onCustomHomePageInput
.
bind
(
this
)
)
;
document
.
getElementById
(
"
useCurrentBtn
"
)
.
addEventListener
(
"
command
"
this
.
setHomePageToCurrent
.
bind
(
this
)
)
;
document
.
getElementById
(
"
useBookmarkBtn
"
)
.
addEventListener
(
"
command
"
this
.
setHomePageToBookmark
.
bind
(
this
)
)
;
document
.
getElementById
(
"
restoreDefaultHomePageBtn
"
)
.
addEventListener
(
"
command
"
this
.
restoreDefaultPrefsForHome
.
bind
(
this
)
)
;
Preferences
.
addSyncFromPrefListener
(
document
.
getElementById
(
"
homePrefHidden
"
)
(
)
=
>
this
.
syncFromHomePref
(
)
)
;
Preferences
.
addSyncFromPrefListener
(
document
.
getElementById
(
"
newTabMode
"
)
(
)
=
>
this
.
syncFromNewTabPref
(
)
)
;
Preferences
.
addSyncToPrefListener
(
document
.
getElementById
(
"
newTabMode
"
)
element
=
>
this
.
syncToNewTabPref
(
element
.
value
)
)
;
this
.
_updateUseCurrentButton
(
)
;
window
.
addEventListener
(
"
focus
"
this
.
_updateUseCurrentButton
.
bind
(
this
)
)
;
this
.
watchNewTab
(
)
;
document
.
getElementById
(
"
disableHomePageExtension
"
)
.
addEventListener
(
"
command
"
makeDisableControllingExtension
(
PREF_SETTING_TYPE
HOMEPAGE_OVERRIDE_KEY
)
)
;
document
.
getElementById
(
"
disableNewTabExtension
"
)
.
addEventListener
(
"
command
"
makeDisableControllingExtension
(
URL_OVERRIDES_TYPE
NEW_TAB_KEY
)
)
;
this
.
watchHomeTabPrefChange
(
)
;
Services
.
obs
.
notifyObservers
(
window
"
home
-
pane
-
loaded
"
)
;
}
}
;
