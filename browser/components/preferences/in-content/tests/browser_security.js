const
PREFS
=
[
"
browser
.
safebrowsing
.
phishing
.
enabled
"
"
browser
.
safebrowsing
.
malware
.
enabled
"
"
browser
.
safebrowsing
.
downloads
.
enabled
"
"
browser
.
safebrowsing
.
downloads
.
remote
.
block_potentially_unwanted
"
"
browser
.
safebrowsing
.
downloads
.
remote
.
block_uncommon
"
]
;
let
originals
=
PREFS
.
map
(
pref
=
>
[
pref
Services
.
prefs
.
getBoolPref
(
pref
)
]
)
let
originalMalwareTable
=
Services
.
prefs
.
getCharPref
(
"
urlclassifier
.
malwareTable
"
)
;
registerCleanupFunction
(
function
(
)
{
originals
.
forEach
(
(
[
pref
val
]
)
=
>
Services
.
prefs
.
setBoolPref
(
pref
val
)
)
Services
.
prefs
.
setCharPref
(
"
urlclassifier
.
malwareTable
"
originalMalwareTable
)
;
}
)
;
add_task
(
function
*
setup
(
)
{
yield
openPreferencesViaOpenPreferencesAPI
(
"
privacy
"
{
leaveOpen
:
true
}
)
;
registerCleanupFunction
(
function
*
(
)
{
yield
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
}
)
;
}
)
;
add_task
(
function
*
(
)
{
function
*
checkPrefSwitch
(
val1
val2
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
safebrowsing
.
phishing
.
enabled
"
val1
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
safebrowsing
.
malware
.
enabled
"
val2
)
;
gBrowser
.
reload
(
)
;
yield
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
checkbox
=
doc
.
getElementById
(
"
enableSafeBrowsing
"
)
;
let
blockDownloads
=
doc
.
getElementById
(
"
blockDownloads
"
)
;
let
blockUncommon
=
doc
.
getElementById
(
"
blockUncommonUnwanted
"
)
;
let
checked
=
checkbox
.
checked
;
is
(
checked
val1
&
&
val2
"
safebrowsing
preference
is
initialized
correctly
"
)
;
is
(
blockDownloads
.
hasAttribute
(
"
disabled
"
)
!
checked
"
block
downloads
checkbox
is
set
correctly
"
)
;
is
(
blockUncommon
.
hasAttribute
(
"
disabled
"
)
!
checked
"
block
uncommon
checkbox
is
set
correctly
"
)
;
checkbox
.
scrollIntoView
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
checkbox
{
}
gBrowser
.
selectedBrowser
.
contentWindow
)
;
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
safebrowsing
.
phishing
.
enabled
"
)
!
checked
"
safebrowsing
.
enabled
is
set
correctly
"
)
;
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
safebrowsing
.
malware
.
enabled
"
)
!
checked
"
safebrowsing
.
malware
.
enabled
is
set
correctly
"
)
;
checked
=
checkbox
.
checked
;
is
(
blockDownloads
.
hasAttribute
(
"
disabled
"
)
!
checked
"
block
downloads
checkbox
is
set
correctly
"
)
;
is
(
blockUncommon
.
hasAttribute
(
"
disabled
"
)
!
checked
|
|
!
blockDownloads
.
checked
"
block
uncommon
checkbox
is
set
correctly
"
)
;
}
yield
*
checkPrefSwitch
(
true
true
)
;
yield
*
checkPrefSwitch
(
false
true
)
;
yield
*
checkPrefSwitch
(
true
false
)
;
yield
*
checkPrefSwitch
(
false
false
)
;
}
)
;
add_task
(
function
*
(
)
{
function
*
checkPrefSwitch
(
val
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
safebrowsing
.
downloads
.
enabled
"
val
)
;
gBrowser
.
reload
(
)
;
yield
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
checkbox
=
doc
.
getElementById
(
"
blockDownloads
"
)
;
let
blockUncommon
=
doc
.
getElementById
(
"
blockUncommonUnwanted
"
)
;
let
checked
=
checkbox
.
checked
;
is
(
checked
val
"
downloads
preference
is
initialized
correctly
"
)
;
is
(
blockUncommon
.
hasAttribute
(
"
disabled
"
)
!
val
"
block
uncommon
checkbox
is
set
correctly
"
)
;
checkbox
.
scrollIntoView
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
checkbox
{
}
gBrowser
.
selectedBrowser
.
contentWindow
)
;
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
safebrowsing
.
downloads
.
enabled
"
)
!
checked
"
safebrowsing
.
downloads
preference
is
set
correctly
"
)
;
is
(
blockUncommon
.
hasAttribute
(
"
disabled
"
)
val
"
block
uncommon
checkbox
is
set
correctly
"
)
;
}
yield
*
checkPrefSwitch
(
true
)
;
yield
*
checkPrefSwitch
(
false
)
;
}
)
;
add_task
(
function
*
(
)
{
function
*
checkPrefSwitch
(
val1
val2
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
safebrowsing
.
downloads
.
remote
.
block_potentially_unwanted
"
val1
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
safebrowsing
.
downloads
.
remote
.
block_uncommon
"
val2
)
;
gBrowser
.
reload
(
)
;
yield
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
checkbox
=
doc
.
getElementById
(
"
blockUncommonUnwanted
"
)
;
let
checked
=
checkbox
.
checked
;
is
(
checked
val1
&
&
val2
"
unwanted
/
uncommon
preference
is
initialized
correctly
"
)
;
checkbox
.
scrollIntoView
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
checkbox
{
}
gBrowser
.
selectedBrowser
.
contentWindow
)
;
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
safebrowsing
.
downloads
.
remote
.
block_potentially_unwanted
"
)
!
checked
"
block_potentially_unwanted
is
set
correctly
"
)
;
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
safebrowsing
.
downloads
.
remote
.
block_uncommon
"
)
!
checked
"
block_uncommon
is
set
correctly
"
)
;
let
malwareTable
=
Services
.
prefs
.
getCharPref
(
"
urlclassifier
.
malwareTable
"
)
.
split
(
"
"
)
;
is
(
malwareTable
.
includes
(
"
goog
-
unwanted
-
shavar
"
)
!
checked
"
malware
table
doesn
'
t
include
goog
-
unwanted
-
shavar
"
)
;
is
(
malwareTable
.
includes
(
"
test
-
unwanted
-
simple
"
)
!
checked
"
malware
table
doesn
'
t
include
test
-
unwanted
-
simple
"
)
;
let
sortedMalware
=
malwareTable
.
slice
(
0
)
;
sortedMalware
.
sort
(
)
;
Assert
.
deepEqual
(
malwareTable
sortedMalware
"
malware
table
has
been
sorted
"
)
;
}
yield
*
checkPrefSwitch
(
true
true
)
;
yield
*
checkPrefSwitch
(
false
true
)
;
yield
*
checkPrefSwitch
(
true
false
)
;
yield
*
checkPrefSwitch
(
false
false
)
;
}
)
;
