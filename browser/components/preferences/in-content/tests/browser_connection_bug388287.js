var
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
function
test
(
)
{
waitForExplicitFinish
(
)
;
const
connectionURL
=
"
chrome
:
/
/
browser
/
content
/
preferences
/
connection
.
xul
"
;
let
closeable
=
false
;
let
finalTest
=
false
;
let
oldNetworkProxyType
=
Services
.
prefs
.
getIntPref
(
"
network
.
proxy
.
type
"
)
;
registerCleanupFunction
(
function
(
)
{
Services
.
prefs
.
setIntPref
(
"
network
.
proxy
.
type
"
oldNetworkProxyType
)
;
Services
.
prefs
.
clearUserPref
(
"
network
.
proxy
.
share_proxy_settings
"
)
;
for
(
let
proxyType
of
[
"
http
"
"
ssl
"
"
ftp
"
"
socks
"
]
)
{
Services
.
prefs
.
clearUserPref
(
"
network
.
proxy
.
"
+
proxyType
)
;
Services
.
prefs
.
clearUserPref
(
"
network
.
proxy
.
"
+
proxyType
+
"
_port
"
)
;
if
(
proxyType
=
=
"
http
"
)
{
continue
;
}
Services
.
prefs
.
clearUserPref
(
"
network
.
proxy
.
backup
.
"
+
proxyType
)
;
Services
.
prefs
.
clearUserPref
(
"
network
.
proxy
.
backup
.
"
+
proxyType
+
"
_port
"
)
;
}
}
)
;
open_preferences
(
async
function
tabOpened
(
aContentWindow
)
{
let
dialog
dialogClosingPromise
;
let
doc
proxyTypePref
sharePref
httpPref
httpPortPref
ftpPref
ftpPortPref
;
async
function
setDoc
(
)
{
if
(
closeable
)
{
let
dialogClosingEvent
=
await
dialogClosingPromise
;
ok
(
dialogClosingEvent
"
Connection
dialog
closed
"
)
;
}
if
(
finalTest
)
{
gBrowser
.
removeCurrentTab
(
)
;
finish
(
)
;
return
;
}
dialog
=
await
openAndLoadSubDialog
(
connectionURL
)
;
dialogClosingPromise
=
BrowserTestUtils
.
waitForEvent
(
dialog
.
document
.
documentElement
"
dialogclosing
"
)
;
doc
=
dialog
.
document
;
proxyTypePref
=
dialog
.
Preferences
.
get
(
"
network
.
proxy
.
type
"
)
;
sharePref
=
dialog
.
Preferences
.
get
(
"
network
.
proxy
.
share_proxy_settings
"
)
;
httpPref
=
dialog
.
Preferences
.
get
(
"
network
.
proxy
.
http
"
)
;
httpPortPref
=
dialog
.
Preferences
.
get
(
"
network
.
proxy
.
http_port
"
)
;
ftpPref
=
dialog
.
Preferences
.
get
(
"
network
.
proxy
.
ftp
"
)
;
ftpPortPref
=
dialog
.
Preferences
.
get
(
"
network
.
proxy
.
ftp_port
"
)
;
}
await
setDoc
(
)
;
proxyTypePref
.
value
=
1
;
sharePref
.
value
=
true
;
httpPref
.
value
=
"
localhost
"
;
httpPortPref
.
value
=
0
;
doc
.
documentElement
.
acceptDialog
(
)
;
sharePref
.
value
=
false
;
ftpPref
.
value
=
"
localhost
"
;
ftpPortPref
.
value
=
80
;
doc
.
documentElement
.
acceptDialog
(
)
;
httpPortPref
.
value
=
80
;
ftpPortPref
.
value
=
0
;
doc
.
documentElement
.
acceptDialog
(
)
;
closeable
=
true
;
httpPortPref
.
value
=
80
;
ftpPortPref
.
value
=
80
;
doc
.
documentElement
.
acceptDialog
(
)
;
await
setDoc
(
)
;
proxyTypePref
.
value
=
1
;
sharePref
.
value
=
true
;
ftpPref
.
value
=
"
localhost
"
;
httpPref
.
value
=
"
localhost
"
;
httpPortPref
.
value
=
80
;
ftpPortPref
.
value
=
0
;
doc
.
documentElement
.
acceptDialog
(
)
;
await
setDoc
(
)
;
proxyTypePref
.
value
=
1
;
sharePref
.
value
=
true
;
httpPref
.
value
=
"
"
;
httpPortPref
.
value
=
0
;
doc
.
documentElement
.
acceptDialog
(
)
;
await
setDoc
(
)
;
proxyTypePref
.
value
=
0
;
sharePref
.
value
=
true
;
httpPref
.
value
=
"
localhost
"
;
httpPortPref
.
value
=
0
;
finalTest
=
true
;
doc
.
documentElement
.
acceptDialog
(
)
;
await
setDoc
(
)
;
}
)
;
}
