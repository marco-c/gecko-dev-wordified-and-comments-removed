"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
SitePermissions
.
jsm
"
)
;
const
{
SiteDataManager
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
SiteDataManager
.
jsm
"
{
}
)
;
const
{
DownloadUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
DownloadUtils
.
jsm
"
{
}
)
;
const
TEST_QUOTA_USAGE_HOST
=
"
example
.
com
"
;
const
TEST_QUOTA_USAGE_ORIGIN
=
"
https
:
/
/
"
+
TEST_QUOTA_USAGE_HOST
;
const
TEST_QUOTA_USAGE_URL
=
TEST_QUOTA_USAGE_ORIGIN
+
"
/
browser
/
browser
/
components
/
preferences
/
in
-
content
/
tests
/
site_data_test
.
html
"
;
const
TEST_OFFLINE_HOST
=
"
example
.
org
"
;
const
TEST_OFFLINE_ORIGIN
=
"
https
:
/
/
"
+
TEST_OFFLINE_HOST
;
const
TEST_OFFLINE_URL
=
TEST_OFFLINE_ORIGIN
+
"
/
browser
/
browser
/
components
/
preferences
/
in
-
content
/
tests
/
offline
/
offline
.
html
"
;
const
TEST_SERVICE_WORKER_URL
=
TEST_OFFLINE_ORIGIN
+
"
/
browser
/
browser
/
components
/
preferences
/
in
-
content
/
tests
/
service_worker_test
.
html
"
;
const
cacheUsageGetter
=
{
_promise
:
null
_resolve
:
null
get
(
)
{
if
(
!
this
.
_promise
)
{
this
.
_promise
=
new
Promise
(
resolve
=
>
{
this
.
_resolve
=
resolve
;
Services
.
cache2
.
asyncGetDiskConsumption
(
this
)
;
}
)
;
}
return
this
.
_promise
;
}
onNetworkCacheDiskConsumption
(
usage
)
{
cacheUsageGetter
.
_promise
=
null
;
cacheUsageGetter
.
_resolve
(
usage
)
;
}
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Components
.
interfaces
.
nsICacheStorageConsumptionObserver
Components
.
interfaces
.
nsISupportsWeakReference
]
)
}
;
async
function
testClearData
(
clearSiteData
clearCache
)
{
let
quotaURI
=
Services
.
io
.
newURI
(
TEST_QUOTA_USAGE_ORIGIN
)
;
SitePermissions
.
set
(
quotaURI
"
persistent
-
storage
"
SitePermissions
.
ALLOW
)
;
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_OFFLINE_URL
)
;
await
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_QUOTA_USAGE_URL
false
)
;
await
BrowserTestUtils
.
waitForContentEvent
(
gBrowser
.
selectedBrowser
"
test
-
indexedDB
-
done
"
false
null
true
)
;
await
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
await
loadServiceWorkerTestPage
(
TEST_SERVICE_WORKER_URL
)
;
await
promiseServiceWorkerRegisteredFor
(
TEST_SERVICE_WORKER_URL
)
;
await
openPreferencesViaOpenPreferencesAPI
(
"
privacy
"
{
leaveOpen
:
true
}
)
;
let
cacheUsage
=
await
cacheUsageGetter
.
get
(
)
;
let
quotaUsage
=
await
getQuotaUsage
(
TEST_QUOTA_USAGE_ORIGIN
)
;
let
totalUsage
=
await
SiteDataManager
.
getTotalUsage
(
)
;
Assert
.
greater
(
cacheUsage
0
"
The
cache
usage
should
not
be
0
"
)
;
Assert
.
greater
(
quotaUsage
0
"
The
quota
usage
should
not
be
0
"
)
;
Assert
.
greater
(
totalUsage
0
"
The
total
usage
should
not
be
0
"
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
clearSiteDataButton
=
doc
.
getElementById
(
"
clearSiteDataButton
"
)
;
let
dialogOpened
=
promiseLoadSubDialog
(
"
chrome
:
/
/
browser
/
content
/
preferences
/
clearSiteData
.
xul
"
)
;
clearSiteDataButton
.
doCommand
(
)
;
let
dialogWin
=
await
dialogOpened
;
let
[
convertedTotalUsage
]
=
DownloadUtils
.
convertByteUnits
(
totalUsage
)
;
let
[
convertedCacheUsage
]
=
DownloadUtils
.
convertByteUnits
(
cacheUsage
)
;
let
clearSiteDataLabel
=
dialogWin
.
document
.
getElementById
(
"
clearSiteDataLabel
"
)
;
let
clearCacheLabel
=
dialogWin
.
document
.
getElementById
(
"
clearCacheLabel
"
)
;
await
Promise
.
all
(
[
TestUtils
.
waitForCondition
(
(
)
=
>
clearSiteDataLabel
.
value
.
includes
(
convertedTotalUsage
)
"
Should
show
the
quota
usage
"
500
200
)
TestUtils
.
waitForCondition
(
(
)
=
>
clearCacheLabel
.
value
.
includes
(
convertedCacheUsage
)
"
Should
show
the
cache
usage
"
500
200
)
]
)
;
let
clearSiteDataCheckbox
=
dialogWin
.
document
.
getElementById
(
"
clearSiteData
"
)
;
let
clearCacheCheckbox
=
dialogWin
.
document
.
getElementById
(
"
clearCache
"
)
;
clearSiteDataCheckbox
.
checked
=
clearSiteData
;
clearCacheCheckbox
.
checked
=
clearCache
;
let
acceptPromise
;
let
updatePromise
;
let
cookiesClearedPromise
;
if
(
clearSiteData
)
{
acceptPromise
=
promiseAlertDialogOpen
(
"
accept
"
)
;
updatePromise
=
promiseSiteDataManagerSitesUpdated
(
)
;
cookiesClearedPromise
=
promiseCookiesCleared
(
)
;
}
let
dialogClosed
=
BrowserTestUtils
.
waitForEvent
(
dialogWin
"
unload
"
)
;
let
clearButton
=
dialogWin
.
document
.
getElementById
(
"
clearButton
"
)
;
if
(
!
clearSiteData
&
&
!
clearCache
)
{
clearCacheCheckbox
.
doCommand
(
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
clearButton
.
disabled
"
Clear
button
should
be
disabled
"
)
;
let
cancelButton
=
dialogWin
.
document
.
getElementById
(
"
cancelButton
"
)
;
cancelButton
.
click
(
)
;
}
else
{
clearButton
.
click
(
)
;
}
if
(
clearSiteData
)
{
await
acceptPromise
;
}
await
dialogClosed
;
if
(
clearSiteData
)
{
await
updatePromise
;
await
cookiesClearedPromise
;
await
promiseServiceWorkersCleared
(
)
;
quotaUsage
=
await
getQuotaUsage
(
TEST_QUOTA_USAGE_ORIGIN
)
;
totalUsage
=
await
SiteDataManager
.
getTotalUsage
(
)
;
is
(
quotaUsage
0
"
The
quota
usage
should
be
removed
"
)
;
is
(
totalUsage
0
"
The
total
usage
should
be
removed
"
)
;
await
ContentTask
.
spawn
(
gBrowser
.
selectedBrowser
null
async
function
(
)
{
let
sizeLabel
=
content
.
document
.
getElementById
(
"
totalSiteDataSize
"
)
;
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
sizeLabel
.
textContent
.
includes
(
"
0
"
)
"
Site
data
size
label
should
have
updated
.
"
)
;
}
)
;
}
else
{
quotaUsage
=
await
getQuotaUsage
(
TEST_QUOTA_USAGE_ORIGIN
)
;
totalUsage
=
await
SiteDataManager
.
getTotalUsage
(
)
;
Assert
.
greater
(
quotaUsage
0
"
The
quota
usage
should
not
be
0
"
)
;
Assert
.
greater
(
totalUsage
0
"
The
total
usage
should
not
be
0
"
)
;
}
let
desiredPermissionState
=
clearSiteData
?
SitePermissions
.
UNKNOWN
:
SitePermissions
.
ALLOW
;
let
permission
=
SitePermissions
.
get
(
quotaURI
"
persistent
-
storage
"
)
;
is
(
permission
.
state
desiredPermissionState
"
Should
have
the
correct
permission
state
.
"
)
;
cacheUsage
=
await
cacheUsageGetter
.
get
(
)
;
if
(
clearCache
)
{
is
(
cacheUsage
0
"
The
cache
usage
should
be
removed
"
)
;
}
else
{
Assert
.
greater
(
cacheUsage
0
"
The
cache
usage
should
not
be
0
"
)
;
}
await
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
await
SiteDataManager
.
removeAll
(
)
;
}
add_task
(
async
function
(
)
{
await
testClearData
(
false
false
)
;
}
)
;
add_task
(
async
function
(
)
{
await
testClearData
(
true
false
)
;
}
)
;
add_task
(
async
function
(
)
{
await
testClearData
(
false
true
)
;
}
)
;
add_task
(
async
function
(
)
{
await
testClearData
(
true
true
)
;
}
)
;
