const
TRANSLATIONS_PERMISSION
=
"
translations
"
;
const
ALWAYS_TRANSLATE_LANGS_PREF
=
"
browser
.
translations
.
alwaysTranslateLanguages
"
;
const
NEVER_TRANSLATE_LANGS_PREF
=
"
browser
.
translations
.
neverTranslateLanguages
"
;
let
gTranslationsPane
=
{
alwaysTranslateLanguages
:
[
]
neverTranslateLanguages
:
[
]
neverTranslateSites
:
[
]
downloadPhases
:
new
Map
(
)
supportedLanguages
:
{
}
supportedLanguageTagsNames
:
[
]
async
init
(
)
{
document
.
getElementById
(
"
translations
-
settings
-
back
-
button
"
)
.
addEventListener
(
"
click
"
function
(
)
{
gotoPref
(
"
general
"
)
;
}
)
;
document
.
getElementById
(
"
translations
-
settings
-
always
-
translate
-
list
"
)
.
addEventListener
(
"
command
"
this
)
;
document
.
getElementById
(
"
translations
-
settings
-
never
-
translate
-
list
"
)
.
addEventListener
(
"
command
"
this
)
;
this
.
supportedLanguages
=
await
TranslationsParent
.
getSupportedLanguages
(
)
;
this
.
supportedLanguageTagsNames
=
TranslationsParent
.
getLanguageList
(
this
.
supportedLanguages
)
;
this
.
alwaysTranslateLanguages
=
TranslationsParent
.
getAlwaysTranslateLanguages
(
)
;
this
.
neverTranslateLanguages
=
TranslationsParent
.
getNeverTranslateLanguages
(
)
;
this
.
neverTranslateSites
=
TranslationsParent
.
listNeverTranslateSites
(
)
;
Services
.
obs
.
addObserver
(
this
"
perm
-
changed
"
)
;
Services
.
obs
.
addObserver
(
this
"
translations
:
always
-
translate
-
languages
-
changed
"
)
;
Services
.
obs
.
addObserver
(
this
"
translations
:
never
-
translate
-
languages
-
changed
"
)
;
window
.
addEventListener
(
"
unload
"
(
)
=
>
this
.
removeObservers
(
)
)
;
this
.
buildLanguageDropDowns
(
)
;
this
.
populateLanguageList
(
ALWAYS_TRANSLATE_LANGS_PREF
)
;
this
.
populateLanguageList
(
NEVER_TRANSLATE_LANGS_PREF
)
;
this
.
populateSiteList
(
)
;
await
this
.
initDownloadInfo
(
)
;
this
.
buildDownloadLanguageList
(
)
;
document
.
dispatchEvent
(
new
CustomEvent
(
"
translationsSettingsInit
"
{
bubbles
:
true
cancelable
:
true
}
)
)
;
}
buildLanguageDropDowns
(
)
{
const
{
fromLanguages
}
=
this
.
supportedLanguages
;
const
alwaysLangPopup
=
document
.
getElementById
(
"
translations
-
settings
-
always
-
translate
-
popup
"
)
;
const
neverLangPopup
=
document
.
getElementById
(
"
translations
-
settings
-
never
-
translate
-
popup
"
)
;
for
(
const
{
langTag
displayName
}
of
fromLanguages
)
{
const
alwaysLang
=
document
.
createXULElement
(
"
menuitem
"
)
;
alwaysLang
.
setAttribute
(
"
value
"
langTag
)
;
alwaysLang
.
setAttribute
(
"
label
"
displayName
)
;
alwaysLangPopup
.
appendChild
(
alwaysLang
)
;
const
neverLang
=
document
.
createXULElement
(
"
menuitem
"
)
;
neverLang
.
setAttribute
(
"
value
"
langTag
)
;
neverLang
.
setAttribute
(
"
label
"
displayName
)
;
neverLangPopup
.
appendChild
(
neverLang
)
;
}
}
async
initDownloadInfo
(
)
{
let
downloadCount
=
0
;
let
allDownloadSize
=
0
;
this
.
downloadPhases
=
new
Map
(
)
;
for
(
const
language
of
this
.
supportedLanguageTagsNames
)
{
let
downloadSize
=
await
TranslationsParent
.
getLanguageSize
(
language
.
langTag
)
;
allDownloadSize
+
=
downloadSize
;
const
hasAllFilesForLanguage
=
await
TranslationsParent
.
hasAllFilesForLanguage
(
language
.
langTag
)
;
const
downloadPhase
=
hasAllFilesForLanguage
?
"
downloaded
"
:
"
removed
"
;
this
.
downloadPhases
.
set
(
language
.
langTag
{
downloadPhase
size
:
downloadSize
}
)
;
downloadCount
+
=
downloadPhase
=
=
=
"
downloaded
"
?
1
:
0
;
}
const
allDownloadPhase
=
downloadCount
=
=
=
this
.
supportedLanguageTagsNames
.
length
?
"
downloaded
"
:
"
removed
"
;
this
.
downloadPhases
.
set
(
"
all
"
{
downloadPhase
:
allDownloadPhase
size
:
allDownloadSize
}
)
;
}
buildDownloadLanguageList
(
)
{
const
downloadList
=
document
.
querySelector
(
"
#
translations
-
settings
-
download
-
section
.
translations
-
settings
-
language
-
list
"
)
;
function
createSizeElement
(
downloadSize
)
{
const
languageSize
=
document
.
createElement
(
"
span
"
)
;
languageSize
.
classList
.
add
(
"
translations
-
settings
-
download
-
size
"
)
;
const
[
size
units
]
=
DownloadUtils
.
convertByteUnits
(
downloadSize
)
;
document
.
l10n
.
setAttributes
(
languageSize
"
translations
-
settings
-
download
-
size
"
{
size
:
size
+
"
"
+
units
}
)
;
return
languageSize
;
}
const
allLangElement
=
downloadList
.
children
[
0
]
;
let
allLangButton
=
allLangElement
.
querySelector
(
"
moz
-
button
"
)
;
allLangButton
.
addEventListener
(
"
click
"
this
)
;
for
(
const
language
of
this
.
supportedLanguageTagsNames
)
{
const
downloadSize
=
this
.
downloadPhases
.
get
(
language
.
langTag
)
.
size
;
const
languageSize
=
createSizeElement
(
downloadSize
)
;
const
languageLabel
=
this
.
createLangLabel
(
language
.
displayName
language
.
langTag
"
translations
-
settings
-
download
-
"
+
language
.
langTag
)
;
const
isDownloaded
=
this
.
downloadPhases
.
get
(
language
.
langTag
)
.
downloadPhase
=
=
=
"
downloaded
"
;
const
mozButton
=
isDownloaded
?
this
.
createIconButton
(
[
"
translations
-
settings
-
remove
-
icon
"
"
translations
-
settings
-
manage
-
downloaded
-
language
-
button
"
]
"
translations
-
settings
-
remove
-
button
"
language
.
displayName
)
:
this
.
createIconButton
(
[
"
translations
-
settings
-
download
-
icon
"
"
translations
-
settings
-
manage
-
downloaded
-
language
-
button
"
]
"
translations
-
settings
-
download
-
button
"
language
.
displayName
)
;
const
languageElement
=
this
.
createLangElement
(
[
mozButton
languageLabel
languageSize
]
)
;
downloadList
.
appendChild
(
languageElement
)
;
}
if
(
this
.
downloadPhases
.
get
(
"
all
"
)
.
downloadPhase
=
=
=
"
downloaded
"
)
{
this
.
changeButtonState
(
{
langButton
:
allLangButton
langTag
:
"
all
"
langState
:
"
downloaded
"
}
)
;
}
const
allDownloadSize
=
this
.
downloadPhases
.
get
(
"
all
"
)
.
size
;
const
languageSize
=
createSizeElement
(
allDownloadSize
)
;
allLangElement
.
appendChild
(
languageSize
)
;
}
handleEvent
(
event
)
{
const
eventNode
=
event
.
target
;
const
eventNodeParent
=
eventNode
.
parentNode
;
const
eventNodeClassList
=
eventNode
.
classList
;
switch
(
event
.
type
)
{
case
"
command
"
:
if
(
eventNodeParent
.
id
=
=
=
"
translations
-
settings
-
always
-
translate
-
popup
"
)
{
this
.
handleAddAlwaysTranslateLanguage
(
event
)
;
}
else
if
(
eventNodeParent
.
id
=
=
=
"
translations
-
settings
-
never
-
translate
-
popup
"
)
{
this
.
handleAddNeverTranslateLanguage
(
event
)
;
}
break
;
case
"
click
"
:
if
(
eventNodeClassList
.
contains
(
"
translations
-
settings
-
site
-
button
"
)
)
{
this
.
handleRemoveNeverTranslateSite
(
event
)
;
}
else
if
(
eventNodeClassList
.
contains
(
"
translations
-
settings
-
language
-
never
-
button
"
)
)
{
this
.
handleRemoveNeverTranslateLanguage
(
event
)
;
}
else
if
(
eventNodeClassList
.
contains
(
"
translations
-
settings
-
language
-
always
-
button
"
)
)
{
this
.
handleRemoveAlwaysTranslateLanguage
(
event
)
;
}
else
if
(
eventNodeClassList
.
contains
(
"
translations
-
settings
-
manage
-
downloaded
-
language
-
button
"
)
)
{
if
(
eventNodeClassList
.
contains
(
"
translations
-
settings
-
download
-
icon
"
)
)
{
if
(
eventNodeParent
.
querySelector
(
"
label
"
)
.
id
=
=
=
"
translations
-
settings
-
download
-
all
-
languages
"
)
{
this
.
handleDownloadAllLanguages
(
event
)
;
}
else
{
this
.
handleDownloadLanguage
(
event
)
;
}
}
else
if
(
eventNodeClassList
.
contains
(
"
translations
-
settings
-
remove
-
icon
"
)
)
{
if
(
eventNodeParent
.
querySelector
(
"
label
"
)
.
id
=
=
=
"
translations
-
settings
-
download
-
all
-
languages
"
)
{
this
.
handleRemoveAllLanguages
(
event
)
;
}
else
{
this
.
handleRemoveLanguage
(
event
)
;
}
}
}
break
;
}
}
async
handleAddAlwaysTranslateLanguage
(
event
)
{
const
menuList
=
document
.
getElementById
(
"
translations
-
settings
-
always
-
translate
-
section
"
)
.
querySelector
(
"
menulist
"
)
;
TranslationsParent
.
addLangTagToPref
(
event
.
target
.
getAttribute
(
"
value
"
)
ALWAYS_TRANSLATE_LANGS_PREF
)
;
await
document
.
l10n
.
translateElements
(
[
menuList
]
)
;
}
async
handleAddNeverTranslateLanguage
(
event
)
{
const
menuList
=
document
.
getElementById
(
"
translations
-
settings
-
never
-
translate
-
section
"
)
.
querySelector
(
"
menulist
"
)
;
TranslationsParent
.
addLangTagToPref
(
event
.
target
.
getAttribute
(
"
value
"
)
NEVER_TRANSLATE_LANGS_PREF
)
;
await
document
.
l10n
.
translateElements
(
[
menuList
]
)
;
}
setDifference
(
currentSet
newSet
)
{
const
added
=
newSet
.
filter
(
lang
=
>
!
currentSet
.
includes
(
lang
)
)
;
const
removed
=
currentSet
.
filter
(
lang
=
>
!
newSet
.
includes
(
lang
)
)
;
return
{
added
removed
}
;
}
populateLanguageList
(
pref
)
{
const
{
sectionId
curLangTags
otherPref
}
=
pref
=
=
=
NEVER_TRANSLATE_LANGS_PREF
?
{
sectionId
:
"
translations
-
settings
-
never
-
translate
-
section
"
curLangTags
:
Array
.
from
(
this
.
neverTranslateLanguages
)
otherPref
:
ALWAYS_TRANSLATE_LANGS_PREF
}
:
{
sectionId
:
"
translations
-
settings
-
always
-
translate
-
section
"
curLangTags
:
Array
.
from
(
this
.
alwaysTranslateLanguages
)
otherPref
:
NEVER_TRANSLATE_LANGS_PREF
}
;
const
updatedLangTags
=
pref
=
=
=
NEVER_TRANSLATE_LANGS_PREF
?
Array
.
from
(
TranslationsParent
.
getNeverTranslateLanguages
(
)
)
:
Array
.
from
(
TranslationsParent
.
getAlwaysTranslateLanguages
(
)
)
;
const
{
added
removed
}
=
this
.
setDifference
(
curLangTags
updatedLangTags
)
;
const
translateSection
=
document
.
getElementById
(
sectionId
)
;
const
languageList
=
translateSection
.
querySelector
(
"
.
translations
-
settings
-
language
-
list
label
"
)
;
for
(
const
lang
of
removed
)
{
this
.
removeLanguage
(
lang
sectionId
)
;
}
if
(
languageList
)
{
for
(
const
lang
of
added
)
{
this
.
addLanguage
(
lang
sectionId
)
;
TranslationsParent
.
removeLangTagFromPref
(
lang
otherPref
)
;
}
}
else
{
for
(
const
lang
of
updatedLangTags
)
{
this
.
addLanguage
(
lang
sectionId
)
;
TranslationsParent
.
removeLangTagFromPref
(
lang
otherPref
)
;
}
}
if
(
pref
=
=
=
NEVER_TRANSLATE_LANGS_PREF
)
{
this
.
neverTranslateLanguages
=
updatedLangTags
;
}
else
{
this
.
alwaysTranslateLanguages
=
updatedLangTags
;
}
}
addSite
(
site
)
{
const
translateSection
=
document
.
getElementById
(
"
translations
-
settings
-
never
-
sites
-
section
"
)
;
let
languageList
=
translateSection
.
querySelector
(
"
.
translations
-
settings
-
language
-
list
"
)
;
if
(
!
languageList
)
{
languageList
=
this
.
addLanguageList
(
translateSection
languageList
)
;
}
const
languageLabel
=
this
.
createLangLabel
(
site
site
"
translations
-
settings
-
"
+
site
)
;
const
mozButton
=
this
.
createIconButton
(
[
"
translations
-
settings
-
remove
-
icon
"
"
translations
-
settings
-
site
-
button
"
]
"
translations
-
settings
-
remove
-
site
-
button
-
2
"
site
)
;
const
languageElement
=
this
.
createLangElement
(
[
mozButton
languageLabel
]
)
;
languageList
.
insertBefore
(
languageElement
languageList
.
firstChild
)
;
}
removeSite
(
site
)
{
const
translateSection
=
document
.
getElementById
(
"
translations
-
settings
-
never
-
sites
-
section
"
)
;
const
languageList
=
translateSection
.
querySelector
(
"
.
translations
-
settings
-
language
-
list
"
)
;
const
langSite
=
languageList
.
querySelector
(
label
[
value
=
"
{
site
}
"
]
)
;
langSite
.
parentNode
.
remove
(
)
;
if
(
!
languageList
.
childElementCount
)
{
languageList
.
parentNode
.
remove
(
)
;
}
}
populateSiteList
(
)
{
const
siteList
=
TranslationsParent
.
listNeverTranslateSites
(
)
;
for
(
const
site
of
siteList
)
{
this
.
addSite
(
site
)
;
}
this
.
neverTranslateSites
=
siteList
;
}
observe
(
subject
topic
data
)
{
if
(
topic
=
=
=
"
perm
-
changed
"
)
{
if
(
data
=
=
=
"
cleared
"
)
{
const
translateSection
=
document
.
getElementById
(
"
translations
-
settings
-
never
-
sites
-
section
"
)
;
const
languageList
=
translateSection
.
querySelector
(
"
.
translations
-
settings
-
language
-
list
"
)
;
this
.
neverTranslateSites
=
[
]
;
if
(
languageList
)
{
languageList
.
parentNode
.
remove
(
)
;
}
}
else
{
const
perm
=
subject
.
QueryInterface
(
Ci
.
nsIPermission
)
;
if
(
perm
.
type
!
=
TRANSLATIONS_PERMISSION
)
{
return
;
}
if
(
data
=
=
=
"
added
"
)
{
if
(
perm
.
capability
!
=
Services
.
perms
.
DENY_ACTION
)
{
return
;
}
this
.
neverTranslateSites
=
TranslationsParent
.
listNeverTranslateSites
(
)
;
this
.
addSite
(
perm
.
principal
.
origin
)
;
}
else
if
(
data
=
=
=
"
deleted
"
)
{
this
.
neverTranslateSites
=
TranslationsParent
.
listNeverTranslateSites
(
)
;
this
.
removeSite
(
perm
.
principal
.
origin
)
;
}
}
}
else
if
(
topic
=
=
=
"
translations
:
never
-
translate
-
languages
-
changed
"
)
{
this
.
populateLanguageList
(
NEVER_TRANSLATE_LANGS_PREF
)
;
}
else
if
(
topic
=
=
=
"
translations
:
always
-
translate
-
languages
-
changed
"
)
{
this
.
populateLanguageList
(
ALWAYS_TRANSLATE_LANGS_PREF
)
;
}
}
removeObservers
(
)
{
Services
.
obs
.
removeObserver
(
this
"
perm
-
changed
"
)
;
Services
.
obs
.
removeObserver
(
this
"
translations
:
always
-
translate
-
languages
-
changed
"
)
;
Services
.
obs
.
removeObserver
(
this
"
translations
:
never
-
translate
-
languages
-
changed
"
)
;
}
createLangElement
(
langChildren
)
{
const
languageElement
=
document
.
createElement
(
"
div
"
)
;
languageElement
.
classList
.
add
(
"
translations
-
settings
-
language
"
)
;
for
(
const
child
of
langChildren
)
{
languageElement
.
appendChild
(
child
)
;
}
return
languageElement
;
}
createIconButton
(
classNames
buttonFluentID
accessibleName
)
{
const
mozButton
=
document
.
createElement
(
"
moz
-
button
"
)
;
for
(
const
className
of
classNames
)
{
mozButton
.
classList
.
add
(
className
)
;
}
mozButton
.
setAttribute
(
"
type
"
"
ghost
icon
"
)
;
document
.
l10n
.
setAttributes
(
mozButton
buttonFluentID
{
name
:
accessibleName
}
)
;
mozButton
.
addEventListener
(
"
click
"
this
)
;
return
mozButton
;
}
addLanguage
(
langTag
sectionId
)
{
const
translatePrefix
=
sectionId
=
=
=
"
translations
-
settings
-
never
-
translate
-
section
"
?
"
never
"
:
"
always
"
;
const
translateSection
=
document
.
getElementById
(
sectionId
)
;
let
languageList
=
translateSection
.
querySelector
(
"
.
translations
-
settings
-
language
-
list
"
)
;
if
(
!
languageList
)
{
languageList
=
this
.
addLanguageList
(
translateSection
languageList
)
;
}
const
languageDisplayName
=
TranslationsParent
.
getLanguageDisplayName
(
langTag
)
;
const
languageLabel
=
this
.
createLangLabel
(
languageDisplayName
langTag
"
translations
-
settings
-
language
-
"
+
translatePrefix
+
"
-
"
+
langTag
)
;
const
mozButton
=
this
.
createIconButton
(
[
"
translations
-
settings
-
remove
-
icon
"
"
translations
-
settings
-
language
-
"
+
translatePrefix
+
"
-
button
"
]
"
translations
-
settings
-
remove
-
language
-
button
-
2
"
languageDisplayName
)
;
const
languageElement
=
this
.
createLangElement
(
[
mozButton
languageLabel
]
)
;
languageList
.
insertBefore
(
languageElement
languageList
.
firstChild
)
;
}
createLangLabel
(
textContent
value
id
)
{
const
languageLabel
=
document
.
createElement
(
"
label
"
)
;
languageLabel
.
textContent
=
textContent
;
languageLabel
.
setAttribute
(
"
value
"
value
)
;
languageLabel
.
id
=
id
;
return
languageLabel
;
}
addLanguageList
(
translateSection
languageList
)
{
const
languageCard
=
document
.
createElement
(
"
div
"
)
;
languageCard
.
classList
.
add
(
"
translations
-
settings
-
languages
-
card
"
)
;
translateSection
.
appendChild
(
languageCard
)
;
const
languageHeader
=
document
.
createElement
(
"
h3
"
)
;
languageCard
.
appendChild
(
languageHeader
)
;
languageHeader
.
setAttribute
(
"
data
-
l10n
-
id
"
"
translations
-
settings
-
language
-
header
"
)
;
languageHeader
.
classList
.
add
(
"
translations
-
settings
-
language
-
header
"
)
;
languageList
=
document
.
createElement
(
"
div
"
)
;
languageList
.
classList
.
add
(
"
translations
-
settings
-
language
-
list
"
)
;
languageCard
.
appendChild
(
languageList
)
;
return
languageList
;
}
removeLanguage
(
lang
sectionId
)
{
const
translateSection
=
document
.
getElementById
(
sectionId
)
;
const
languageList
=
translateSection
.
querySelector
(
"
.
translations
-
settings
-
language
-
list
"
)
;
if
(
languageList
)
{
const
langElem
=
languageList
.
querySelector
(
label
[
value
=
{
lang
}
]
)
;
if
(
langElem
)
{
langElem
.
parentNode
.
remove
(
)
;
if
(
!
languageList
.
childElementCount
)
{
languageList
.
parentNode
.
remove
(
)
;
}
}
}
}
handleRemoveAlwaysTranslateLanguage
(
event
)
{
TranslationsParent
.
removeLangTagFromPref
(
event
.
target
.
parentNode
.
querySelector
(
"
label
"
)
.
getAttribute
(
"
value
"
)
ALWAYS_TRANSLATE_LANGS_PREF
)
;
}
handleRemoveNeverTranslateLanguage
(
event
)
{
TranslationsParent
.
removeLangTagFromPref
(
event
.
target
.
parentNode
.
querySelector
(
"
label
"
)
.
getAttribute
(
"
value
"
)
NEVER_TRANSLATE_LANGS_PREF
)
;
}
handleRemoveNeverTranslateSite
(
event
)
{
TranslationsParent
.
setNeverTranslateSiteByOrigin
(
false
event
.
target
.
parentNode
.
querySelector
(
"
label
"
)
.
getAttribute
(
"
value
"
)
)
;
}
updateDownloadPhase
(
langTag
downloadPhase
)
{
if
(
!
this
.
downloadPhases
.
has
(
langTag
)
)
{
console
.
error
(
Expected
downloadPhases
entry
for
{
langTag
}
but
found
none
.
)
;
}
else
{
this
.
downloadPhases
.
get
(
langTag
)
.
downloadPhase
=
downloadPhase
;
}
}
reloadDownloadPhases
(
)
{
const
downloadList
=
document
.
querySelector
(
"
#
translations
-
settings
-
download
-
section
.
translations
-
settings
-
language
-
list
"
)
;
while
(
downloadList
.
firstElementChild
)
{
downloadList
.
firstElementChild
.
remove
(
)
;
}
this
.
buildDownloadLanguageList
(
)
;
}
async
handleDownloadLanguage
(
event
)
{
let
eventButton
=
event
.
target
;
const
langTag
=
eventButton
.
parentNode
.
querySelector
(
"
label
"
)
.
getAttribute
(
"
value
"
)
;
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
langState
:
"
loading
"
}
)
;
try
{
await
TranslationsParent
.
downloadLanguageFiles
(
langTag
)
;
}
catch
(
error
)
{
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
langState
:
"
removed
"
}
)
;
console
.
error
(
error
)
;
return
;
}
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
langState
:
"
downloaded
"
}
)
;
const
haveRemovedItem
=
[
.
.
.
this
.
downloadPhases
]
.
some
(
(
[
k
v
]
)
=
>
v
.
downloadPhase
!
=
"
downloaded
"
&
&
k
!
=
"
all
"
)
;
if
(
!
haveRemovedItem
&
&
this
.
downloadPhases
.
get
(
"
all
"
)
.
downloadPhase
!
=
=
"
downloaded
"
)
{
this
.
changeButtonState
(
{
langButton
:
event
.
target
.
parentNode
.
parentNode
.
children
[
0
]
.
querySelector
(
"
moz
-
button
"
)
langTag
:
"
all
"
langState
:
"
downloaded
"
}
)
;
}
}
async
handleRemoveLanguage
(
event
)
{
let
eventButton
=
event
.
target
;
const
langTag
=
eventButton
.
parentNode
.
querySelector
(
"
label
"
)
.
getAttribute
(
"
value
"
)
;
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
langState
:
"
loading
"
}
)
;
try
{
await
TranslationsParent
.
deleteLanguageFiles
(
langTag
)
;
}
catch
(
error
)
{
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
langState
:
"
downloaded
"
}
)
;
console
.
error
(
error
)
;
return
;
}
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
langState
:
"
removed
"
}
)
;
if
(
this
.
downloadPhases
.
get
(
"
all
"
)
.
downloadPhase
=
=
=
"
downloaded
"
)
{
this
.
changeButtonState
(
{
langButton
:
event
.
target
.
parentNode
.
parentNode
.
children
[
0
]
.
querySelector
(
"
moz
-
button
"
)
langTag
:
"
all
"
langState
:
"
removed
"
}
)
;
}
}
async
handleDownloadAllLanguages
(
event
)
{
this
.
disableDownloadButtons
(
)
;
let
eventButton
=
event
.
target
;
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
:
"
all
"
langState
:
"
loading
"
}
)
;
try
{
await
TranslationsParent
.
downloadAllFiles
(
)
;
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
:
"
all
"
langState
:
"
downloaded
"
}
)
;
this
.
updateAllLanguageDownloadButtons
(
"
downloaded
"
)
;
}
catch
(
error
)
{
await
this
.
reloadDownloadPhases
(
)
;
console
.
error
(
error
)
;
}
}
async
handleRemoveAllLanguages
(
event
)
{
let
eventButton
=
event
.
target
;
this
.
disableDownloadButtons
(
)
;
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
:
"
all
"
langState
:
"
loading
"
}
)
;
try
{
await
TranslationsParent
.
deleteAllLanguageFiles
(
)
;
this
.
changeButtonState
(
{
langButton
:
eventButton
langTag
:
"
all
"
langState
:
"
removed
"
}
)
;
this
.
updateAllLanguageDownloadButtons
(
"
removed
"
)
;
}
catch
(
error
)
{
await
this
.
reloadDownloadPhases
(
)
;
console
.
error
(
error
)
;
}
}
disableDownloadButtons
(
)
{
const
downloadList
=
document
.
querySelector
(
"
#
translations
-
settings
-
download
-
section
.
translations
-
settings
-
language
-
list
"
)
;
for
(
const
langElem
of
downloadList
.
querySelectorAll
(
"
.
translations
-
settings
-
language
:
not
(
:
first
-
child
)
"
)
)
{
const
langButton
=
langElem
.
querySelector
(
"
moz
-
button
"
)
;
langButton
.
setAttribute
(
"
disabled
"
"
true
"
)
;
}
}
updateAllLanguageDownloadButtons
(
allLanguageDownloadStatus
)
{
const
downloadList
=
document
.
querySelector
(
"
#
translations
-
settings
-
download
-
section
.
translations
-
settings
-
language
-
list
"
)
;
for
(
const
langElem
of
downloadList
.
querySelectorAll
(
"
.
translations
-
settings
-
language
:
not
(
:
first
-
child
)
"
)
)
{
let
langButton
=
langElem
.
querySelector
(
"
moz
-
button
"
)
;
const
langLabel
=
langElem
.
querySelector
(
"
label
"
)
;
const
downloadPhase
=
this
.
downloadPhases
.
get
(
langLabel
.
getAttribute
(
"
value
"
)
)
.
downloadPhase
;
langButton
.
removeAttribute
(
"
disabled
"
)
;
if
(
downloadPhase
!
=
=
"
downloaded
"
&
&
allLanguageDownloadStatus
=
=
=
"
downloaded
"
)
{
this
.
changeButtonState
(
{
langButton
langTag
:
langLabel
.
getAttribute
(
"
value
"
)
langState
:
"
downloaded
"
}
)
;
}
else
if
(
downloadPhase
=
=
=
"
downloaded
"
&
&
allLanguageDownloadStatus
=
=
=
"
removed
"
)
{
this
.
changeButtonState
(
{
langButton
langTag
:
langLabel
.
getAttribute
(
"
value
"
)
langState
:
"
removed
"
}
)
;
}
}
}
changeButtonState
(
{
langButton
langTag
langState
}
)
{
langButton
.
classList
.
remove
(
"
translations
-
settings
-
download
-
icon
"
"
translations
-
settings
-
loading
-
icon
"
"
translations
-
settings
-
remove
-
icon
"
)
;
switch
(
langState
)
{
case
"
downloaded
"
:
langButton
.
classList
.
add
(
"
translations
-
settings
-
remove
-
icon
"
)
;
if
(
langTag
=
=
=
"
all
"
)
{
document
.
l10n
.
setAttributes
(
langButton
"
translations
-
settings
-
remove
-
all
-
button
"
)
;
}
else
{
document
.
l10n
.
setAttributes
(
langButton
"
translations
-
settings
-
remove
-
button
"
{
name
:
document
.
l10n
.
getAttributes
(
langButton
)
.
args
.
name
}
)
;
}
break
;
case
"
removed
"
:
langButton
.
classList
.
add
(
"
translations
-
settings
-
download
-
icon
"
)
;
if
(
langTag
=
=
=
"
all
"
)
{
document
.
l10n
.
setAttributes
(
langButton
"
translations
-
settings
-
download
-
all
-
button
"
)
;
}
else
{
document
.
l10n
.
setAttributes
(
langButton
"
translations
-
settings
-
download
-
button
"
{
name
:
document
.
l10n
.
getAttributes
(
langButton
)
.
args
.
name
}
)
;
}
break
;
case
"
loading
"
:
langButton
.
classList
.
add
(
"
translations
-
settings
-
loading
-
icon
"
)
;
if
(
langTag
=
=
=
"
all
"
)
{
document
.
l10n
.
setAttributes
(
langButton
"
translations
-
settings
-
loading
-
all
-
button
"
)
;
}
else
{
document
.
l10n
.
setAttributes
(
langButton
"
translations
-
settings
-
loading
-
button
"
{
name
:
document
.
l10n
.
getAttributes
(
langButton
)
.
args
.
name
}
)
;
}
break
;
}
this
.
updateDownloadPhase
(
langTag
langState
)
;
}
}
;
