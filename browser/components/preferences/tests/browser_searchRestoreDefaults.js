const
{
SearchTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
SearchTestUtils
.
sys
.
mjs
"
)
;
const
{
SearchUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
SearchUtils
.
sys
.
mjs
"
)
;
add_task
(
async
function
test_restore_functionality
(
)
{
for
(
let
engine
of
await
Services
.
search
.
getAppProvidedEngines
(
)
)
{
if
(
engine
.
hidden
)
{
engine
.
hidden
=
false
;
}
}
await
openPreferencesViaOpenPreferencesAPI
(
"
search
"
{
leaveOpen
:
true
}
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
restoreDefaultsButton
=
doc
.
getElementById
(
"
restoreDefaultSearchEngines
"
)
;
Assert
.
ok
(
restoreDefaultsButton
.
disabled
"
Should
have
disabled
the
restore
default
search
engines
button
on
open
"
)
;
let
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
let
tree
=
doc
.
querySelector
(
"
#
engineList
"
)
;
let
defaultEngines
=
await
Services
.
search
.
getAppProvidedEngines
(
)
;
for
(
let
i
=
0
;
i
<
defaultEngines
.
length
;
i
+
+
)
{
let
cellName
=
tree
.
view
.
getCellText
(
i
tree
.
columns
.
getNamedColumn
(
"
engineName
"
)
)
;
if
(
cellName
=
=
"
DuckDuckGo
"
)
{
tree
.
view
.
selection
.
select
(
i
)
;
break
;
}
}
doc
.
getElementById
(
"
removeEngineButton
"
)
.
click
(
)
;
await
updatedPromise
;
let
engine
=
await
Services
.
search
.
getEngineByName
(
"
DuckDuckGo
"
)
;
Assert
.
ok
(
engine
.
hidden
"
Should
have
hidden
the
engine
"
)
;
Assert
.
ok
(
!
restoreDefaultsButton
.
disabled
"
Should
have
enabled
the
restore
default
search
engines
button
"
)
;
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
restoreDefaultsButton
.
click
(
)
;
await
updatedPromise
;
await
new
Promise
(
resolve
=
>
Services
.
tm
.
dispatchToMainThread
(
resolve
)
)
;
Assert
.
ok
(
!
engine
.
hidden
"
Should
have
re
-
enabled
the
disabled
engine
"
)
;
Assert
.
ok
(
restoreDefaultsButton
.
disabled
"
Should
have
disabled
the
restore
default
search
engines
button
after
use
"
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
test_restoreEnabledOnOpenWithEngineHidden
(
)
{
let
engine
=
await
Services
.
search
.
getEngineByName
(
"
DuckDuckGo
"
)
;
engine
.
hidden
=
true
;
await
openPreferencesViaOpenPreferencesAPI
(
"
search
"
{
leaveOpen
:
true
}
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
restoreDefaultsButton
=
doc
.
getElementById
(
"
restoreDefaultSearchEngines
"
)
;
Assert
.
ok
(
!
restoreDefaultsButton
.
disabled
"
Should
have
enabled
the
restore
default
search
engines
button
on
open
"
)
;
let
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
restoreDefaultsButton
.
click
(
)
;
await
updatedPromise
;
await
new
Promise
(
resolve
=
>
Services
.
tm
.
dispatchToMainThread
(
resolve
)
)
;
Assert
.
ok
(
!
engine
.
hidden
"
Should
have
re
-
enabled
the
disabled
engine
"
)
;
Assert
.
ok
(
restoreDefaultsButton
.
disabled
"
Should
have
disabled
the
restore
default
search
engines
button
after
use
"
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
test_removeOutOfOrder
(
)
{
await
openPreferencesViaOpenPreferencesAPI
(
"
search
"
{
leaveOpen
:
true
}
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
restoreDefaultsButton
=
doc
.
getElementById
(
"
restoreDefaultSearchEngines
"
)
;
Assert
.
ok
(
restoreDefaultsButton
.
disabled
"
The
restore
-
defaults
button
is
disabled
initially
"
)
;
let
tree
=
doc
.
querySelector
(
"
#
engineList
"
)
;
let
removeEngineButton
=
doc
.
getElementById
(
"
removeEngineButton
"
)
;
removeEngineButton
.
scrollIntoView
(
)
;
let
defaultEngines
=
await
Services
.
search
.
getAppProvidedEngines
(
)
;
for
(
let
i
=
0
;
i
<
2
;
i
+
+
)
{
tree
.
view
.
selection
.
select
(
defaultEngines
.
length
-
i
-
1
)
;
let
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
removeEngineButton
.
click
(
)
;
await
updatedPromise
;
Assert
.
ok
(
removeEngineButton
.
disabled
"
The
remove
-
engine
button
is
disabled
because
a
local
shortcut
is
selected
"
)
;
Assert
.
ok
(
!
restoreDefaultsButton
.
disabled
"
The
restore
-
defaults
button
is
enabled
after
removing
an
engine
"
)
;
}
for
(
let
i
=
0
;
i
<
defaultEngines
.
length
-
3
;
i
+
+
)
{
tree
.
view
.
selection
.
select
(
0
)
;
if
(
defaultEngines
[
0
]
.
name
=
=
Services
.
search
.
defaultEngine
.
name
)
{
tree
.
view
.
selection
.
select
(
1
)
;
}
let
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
removeEngineButton
.
click
(
)
;
await
updatedPromise
;
Assert
.
ok
(
!
restoreDefaultsButton
.
disabled
"
The
restore
-
defaults
button
is
enabled
after
removing
an
engine
"
)
;
}
Assert
.
ok
(
removeEngineButton
.
disabled
"
The
remove
-
engine
button
is
disabled
because
only
one
engine
remains
"
)
;
let
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
restoreDefaultsButton
.
click
(
)
;
await
updatedPromise
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
restoreDefaultsButton
.
disabled
"
Waiting
for
the
restore
-
defaults
button
to
become
disabled
"
)
;
Assert
.
ok
(
restoreDefaultsButton
.
disabled
"
The
restore
-
defaults
button
is
disabled
after
restoring
defaults
"
)
;
Assert
.
equal
(
tree
.
view
.
rowCount
defaultEngines
.
length
+
UrlbarUtils
.
LOCAL_SEARCH_MODES
.
length
"
All
engines
are
restored
"
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
test_removeAndRestoreMultiple
(
)
{
await
openPreferencesViaOpenPreferencesAPI
(
"
search
"
{
leaveOpen
:
true
}
)
;
let
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
let
restoreDefaultsButton
=
doc
.
getElementById
(
"
restoreDefaultSearchEngines
"
)
;
let
tree
=
doc
.
querySelector
(
"
#
engineList
"
)
;
let
removeEngineButton
=
doc
.
getElementById
(
"
removeEngineButton
"
)
;
removeEngineButton
.
scrollIntoView
(
)
;
let
defaultEngines
=
await
Services
.
search
.
getAppProvidedEngines
(
)
;
for
(
let
i
=
0
;
i
<
2
;
i
+
+
)
{
tree
.
view
.
selection
.
select
(
i
*
2
+
1
)
;
let
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
removeEngineButton
.
click
(
)
;
await
updatedPromise
;
}
let
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
restoreDefaultsButton
.
click
(
)
;
await
updatedPromise
;
tree
.
view
.
selection
.
select
(
3
)
;
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
removeEngineButton
.
click
(
)
;
await
updatedPromise
;
updatedPromise
=
SearchTestUtils
.
promiseSearchNotification
(
SearchUtils
.
MODIFIED_TYPE
.
CHANGED
SearchUtils
.
TOPIC_ENGINE_MODIFIED
)
;
restoreDefaultsButton
.
click
(
)
;
await
updatedPromise
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
restoreDefaultsButton
.
disabled
"
Waiting
for
the
restore
-
defaults
button
to
become
disabled
"
)
;
Assert
.
equal
(
tree
.
view
.
rowCount
defaultEngines
.
length
+
UrlbarUtils
.
LOCAL_SEARCH_MODES
.
length
"
Should
have
the
correct
amount
of
engines
"
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
