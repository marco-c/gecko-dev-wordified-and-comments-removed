"
use
strict
"
;
const
HTTPS_ONLY_ENABLED
=
"
enabled
"
;
const
HTTPS_ONLY_PBM_ONLY
=
"
privateOnly
"
;
const
HTTPS_ONLY_DISABLED
=
"
disabled
"
;
add_task
(
async
function
httpsOnlyRadioGroupIsWorking
(
)
{
registerCleanupFunction
(
async
function
(
)
{
Services
.
prefs
.
clearUserPref
(
"
dom
.
security
.
https_only_mode
"
)
;
Services
.
prefs
.
clearUserPref
(
"
dom
.
security
.
https_only_mode_pbm
"
)
;
}
)
;
await
SpecialPowers
.
setBoolPref
(
"
dom
.
security
.
https_only_mode
"
false
)
;
await
SpecialPowers
.
setBoolPref
(
"
dom
.
security
.
https_only_mode_pbm
"
true
)
;
await
openPreferencesViaOpenPreferencesAPI
(
"
privacy
"
{
leaveOpen
:
true
}
)
;
const
doc
=
gBrowser
.
selectedBrowser
.
contentDocument
;
const
radioGroup
=
doc
.
getElementById
(
"
httpsOnlyRadioGroup
"
)
;
const
enableAllRadio
=
doc
.
getElementById
(
"
httpsOnlyRadioEnabled
"
)
;
const
enablePbmRadio
=
doc
.
getElementById
(
"
httpsOnlyRadioEnabledPBM
"
)
;
const
disableRadio
=
doc
.
getElementById
(
"
httpsOnlyRadioDisabled
"
)
;
check
(
radioGroup
HTTPS_ONLY_PBM_ONLY
)
;
await
SpecialPowers
.
setBoolPref
(
"
dom
.
security
.
https_only_mode_pbm
"
false
)
;
check
(
radioGroup
HTTPS_ONLY_DISABLED
)
;
let
changePromise
=
BrowserTestUtils
.
waitForEvent
(
radioGroup
"
change
"
)
;
enableAllRadio
.
click
(
)
;
await
changePromise
;
check
(
radioGroup
HTTPS_ONLY_ENABLED
)
;
enableAllRadio
.
click
(
)
;
await
TestUtils
.
waitForTick
(
)
;
check
(
radioGroup
HTTPS_ONLY_ENABLED
)
;
changePromise
=
BrowserTestUtils
.
waitForEvent
(
radioGroup
"
change
"
)
;
enablePbmRadio
.
click
(
)
;
await
changePromise
;
check
(
radioGroup
HTTPS_ONLY_PBM_ONLY
)
;
changePromise
=
BrowserTestUtils
.
waitForEvent
(
radioGroup
"
change
"
)
;
disableRadio
.
click
(
)
;
await
changePromise
;
check
(
radioGroup
HTTPS_ONLY_DISABLED
)
;
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
}
)
;
function
check
(
radioGroupElement
expectedValue
)
{
is
(
radioGroupElement
.
value
expectedValue
"
Radio
Group
value
should
match
expected
value
"
)
;
is
(
SpecialPowers
.
getBoolPref
(
"
dom
.
security
.
https_only_mode
"
)
expectedValue
=
=
=
HTTPS_ONLY_ENABLED
"
HTTPS
-
Only
pref
should
match
expected
value
.
"
)
;
is
(
SpecialPowers
.
getBoolPref
(
"
dom
.
security
.
https_only_mode_pbm
"
)
expectedValue
=
=
=
HTTPS_ONLY_PBM_ONLY
"
HTTPS
-
Only
PBM
pref
should
match
expected
value
.
"
)
;
}
add_task
(
async
function
httpsOnlyCorrectLabels
(
)
{
registerCleanupFunction
(
async
function
(
)
{
Services
.
prefs
.
clearUserPref
(
"
dom
.
security
.
https_first
"
)
;
}
)
;
function
ensureL10nIds
(
httpsFirstEnabled
)
{
return
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
httpsFirstEnabled
]
_httpsFirstEnabled
=
>
{
function
ensureL10nId
(
elementId
l10nId
)
{
const
element
=
content
.
document
.
getElementById
(
elementId
)
;
ok
(
element
{
elementId
}
should
be
on
the
settings
page
)
;
is
(
content
.
document
.
l10n
.
getAttributes
(
element
)
.
id
l10nId
{
elementId
}
should
have
the
correct
data
-
l10n
-
id
attribute
)
;
}
ensureL10nId
(
"
httpsOnlyRadioEnabled
"
"
httpsonly
-
radio
-
enabled
"
)
;
ensureL10nId
(
"
httpsOnlyRadioEnabledPBM
"
"
httpsonly
-
radio
-
enabled
-
pbm
"
)
;
ensureL10nId
(
"
httpsOnlyRadioDisabled
"
"
httpsonly
-
radio
-
disabled3
"
)
;
}
)
;
}
await
SpecialPowers
.
setBoolPref
(
"
dom
.
security
.
https_first
"
false
)
;
await
openPreferencesViaOpenPreferencesAPI
(
"
privacy
"
{
leaveOpen
:
true
}
)
;
await
ensureL10nIds
(
false
)
;
await
SpecialPowers
.
setBoolPref
(
"
dom
.
security
.
https_first
"
true
)
;
await
ensureL10nIds
(
true
)
;
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
await
SpecialPowers
.
setBoolPref
(
"
dom
.
security
.
https_first
"
true
)
;
await
openPreferencesViaOpenPreferencesAPI
(
"
privacy
"
{
leaveOpen
:
true
}
)
;
await
ensureL10nIds
(
true
)
;
await
SpecialPowers
.
setBoolPref
(
"
dom
.
security
.
https_first
"
false
)
;
await
ensureL10nIds
(
false
)
;
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
}
)
;
