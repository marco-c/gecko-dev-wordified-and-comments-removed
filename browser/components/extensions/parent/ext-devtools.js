"
use
strict
"
;
ChromeUtils
.
defineModuleGetter
(
this
"
DevToolsShim
"
"
chrome
:
/
/
devtools
-
startup
/
content
/
DevToolsShim
.
jsm
"
)
;
var
{
ExtensionParent
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ExtensionParent
.
jsm
"
)
;
var
{
HiddenExtensionPage
watchExtensionProxyContextLoad
}
=
ExtensionParent
;
function
getDevToolsPrefBranchName
(
extensionId
)
{
return
devtools
.
webextensions
.
{
extensionId
}
;
}
global
.
getTargetTabIdForToolbox
=
toolbox
=
>
{
let
{
descriptorFront
}
=
toolbox
;
if
(
!
descriptorFront
.
isLocalTab
)
{
throw
new
Error
(
"
Unexpected
target
type
:
only
local
tabs
are
currently
supported
.
"
)
;
}
let
parentWindow
=
descriptorFront
.
localTab
.
linkedBrowser
.
ownerGlobal
;
let
tab
=
parentWindow
.
gBrowser
.
getTabForBrowser
(
descriptorFront
.
localTab
.
linkedBrowser
)
;
return
tabTracker
.
getId
(
tab
)
;
}
;
global
.
getInspectedWindowFront
=
async
function
(
context
)
{
const
target
=
await
context
.
getCurrentDevToolsTarget
(
)
;
return
DevToolsShim
.
createWebExtensionInspectedWindowFront
(
target
)
;
}
;
global
.
getToolboxEvalOptions
=
async
function
(
context
)
{
const
options
=
{
}
;
const
toolbox
=
context
.
devToolsToolbox
;
const
selectedNode
=
toolbox
.
selection
;
if
(
selectedNode
&
&
selectedNode
.
nodeFront
)
{
options
.
toolboxSelectedNodeActorID
=
selectedNode
.
nodeFront
.
actorID
;
}
const
consoleFront
=
await
toolbox
.
target
.
getFront
(
"
console
"
)
;
options
.
toolboxConsoleActorID
=
consoleFront
.
actor
;
return
options
;
}
;
class
DevToolsPage
extends
HiddenExtensionPage
{
constructor
(
extension
options
)
{
super
(
extension
"
devtools_page
"
)
;
this
.
url
=
extension
.
baseURI
.
resolve
(
options
.
url
)
;
this
.
toolbox
=
options
.
toolbox
;
this
.
devToolsPageDefinition
=
options
.
devToolsPageDefinition
;
this
.
unwatchExtensionProxyContextLoad
=
null
;
this
.
waitForTopLevelContext
=
new
Promise
(
resolve
=
>
{
this
.
resolveTopLevelContext
=
resolve
;
}
)
;
}
async
build
(
)
{
await
this
.
createBrowserElement
(
)
;
this
.
unwatchExtensionProxyContextLoad
=
watchExtensionProxyContextLoad
(
this
context
=
>
{
context
.
devToolsToolbox
=
this
.
toolbox
;
if
(
!
this
.
topLevelContext
)
{
this
.
topLevelContext
=
context
;
this
.
topLevelContext
.
callOnClose
(
this
)
;
this
.
resolveTopLevelContext
(
context
)
;
}
}
)
;
extensions
.
emit
(
"
extension
-
browser
-
inserted
"
this
.
browser
{
devtoolsToolboxInfo
:
{
inspectedWindowTabId
:
getTargetTabIdForToolbox
(
this
.
toolbox
)
themeName
:
DevToolsShim
.
getTheme
(
)
}
}
)
;
this
.
browser
.
loadURI
(
this
.
url
{
triggeringPrincipal
:
this
.
extension
.
principal
}
)
;
await
this
.
waitForTopLevelContext
;
}
close
(
)
{
if
(
this
.
closed
)
{
throw
new
Error
(
"
Unable
to
shutdown
a
closed
DevToolsPage
instance
"
)
;
}
this
.
closed
=
true
;
this
.
devToolsPageDefinition
.
forgetForToolbox
(
this
.
toolbox
)
;
if
(
this
.
topLevelContext
)
{
this
.
topLevelContext
.
forgetOnClose
(
this
)
;
}
if
(
this
.
unwatchExtensionProxyContextLoad
)
{
this
.
unwatchExtensionProxyContextLoad
(
)
;
this
.
unwatchExtensionProxyContextLoad
=
null
;
}
super
.
shutdown
(
)
;
}
}
class
DevToolsPageDefinition
{
constructor
(
extension
url
)
{
this
.
url
=
url
;
this
.
extension
=
extension
;
this
.
devtoolsPageForToolbox
=
new
Map
(
)
;
}
onThemeChanged
(
themeName
)
{
Services
.
ppmm
.
broadcastAsyncMessage
(
"
Extension
:
DevToolsThemeChanged
"
{
themeName
}
)
;
}
buildForToolbox
(
toolbox
)
{
if
(
!
this
.
extension
.
canAccessWindow
(
toolbox
.
descriptorFront
.
localTab
.
ownerGlobal
)
)
{
return
;
}
if
(
this
.
devtoolsPageForToolbox
.
has
(
toolbox
)
)
{
return
Promise
.
reject
(
new
Error
(
"
DevtoolsPage
has
been
already
created
for
this
toolbox
"
)
)
;
}
const
devtoolsPage
=
new
DevToolsPage
(
this
.
extension
{
toolbox
url
:
this
.
url
devToolsPageDefinition
:
this
}
)
;
if
(
this
.
devtoolsPageForToolbox
.
size
=
=
=
0
)
{
DevToolsShim
.
on
(
"
theme
-
changed
"
this
.
onThemeChanged
)
;
}
this
.
devtoolsPageForToolbox
.
set
(
toolbox
devtoolsPage
)
;
return
devtoolsPage
.
build
(
)
;
}
shutdownForToolbox
(
toolbox
)
{
if
(
this
.
devtoolsPageForToolbox
.
has
(
toolbox
)
)
{
const
devtoolsPage
=
this
.
devtoolsPageForToolbox
.
get
(
toolbox
)
;
devtoolsPage
.
close
(
)
;
if
(
this
.
devtoolsPageForToolbox
.
has
(
toolbox
)
)
{
throw
new
Error
(
Leaked
DevToolsPage
instance
for
target
"
{
toolbox
.
descriptorFront
.
url
}
"
extension
"
{
this
.
extension
.
policy
.
debugName
}
"
)
;
}
if
(
this
.
devtoolsPageForToolbox
.
size
=
=
=
0
)
{
DevToolsShim
.
off
(
"
theme
-
changed
"
this
.
onThemeChanged
)
;
}
this
.
extension
.
emit
(
"
devtools
-
page
-
shutdown
"
toolbox
)
;
}
}
forgetForToolbox
(
toolbox
)
{
this
.
devtoolsPageForToolbox
.
delete
(
toolbox
)
;
}
build
(
)
{
for
(
let
toolbox
of
DevToolsShim
.
getToolboxes
(
)
)
{
if
(
!
toolbox
.
descriptorFront
.
isLocalTab
|
|
!
this
.
extension
.
canAccessWindow
(
toolbox
.
descriptorFront
.
localTab
.
ownerGlobal
)
)
{
continue
;
}
toolbox
.
registerWebExtension
(
this
.
extension
.
uuid
{
name
:
this
.
extension
.
name
pref
:
{
getDevToolsPrefBranchName
(
this
.
extension
.
id
)
}
.
enabled
}
)
;
this
.
buildForToolbox
(
toolbox
)
;
}
}
shutdown
(
)
{
for
(
let
toolbox
of
this
.
devtoolsPageForToolbox
.
keys
(
)
)
{
this
.
shutdownForToolbox
(
toolbox
)
;
}
if
(
this
.
devtoolsPageForToolbox
.
size
>
0
)
{
throw
new
Error
(
Leaked
{
this
.
devtoolsPageForToolbox
.
size
}
DevToolsPage
instances
in
devtoolsPageForToolbox
Map
)
;
}
}
}
this
.
devtools
=
class
extends
ExtensionAPI
{
constructor
(
extension
)
{
super
(
extension
)
;
this
.
_initialized
=
false
;
this
.
pageDefinition
=
null
;
this
.
onToolboxReady
=
this
.
onToolboxReady
.
bind
(
this
)
;
this
.
onToolboxDestroy
=
this
.
onToolboxDestroy
.
bind
(
this
)
;
extension
.
on
(
"
add
-
permissions
"
(
ignoreEvent
permissions
)
=
>
{
Services
.
prefs
.
setBoolPref
(
{
getDevToolsPrefBranchName
(
extension
.
id
)
}
.
enabled
true
)
;
if
(
permissions
.
permissions
.
includes
(
"
devtools
"
)
)
{
this
.
_initialize
(
)
;
}
}
)
;
extension
.
on
(
"
remove
-
permissions
"
(
ignoreEvent
permissions
)
=
>
{
Services
.
prefs
.
setBoolPref
(
{
getDevToolsPrefBranchName
(
extension
.
id
)
}
.
enabled
false
)
;
if
(
permissions
.
permissions
.
includes
(
"
devtools
"
)
)
{
this
.
_uninitialize
(
)
;
}
}
)
;
}
onManifestEntry
(
)
{
this
.
_initialize
(
)
;
}
static
onUninstall
(
extensionId
)
{
const
prefBranch
=
Services
.
prefs
.
getBranch
(
{
getDevToolsPrefBranchName
(
extensionId
)
}
.
)
;
prefBranch
.
deleteBranch
(
"
"
)
;
}
_initialize
(
)
{
const
{
extension
}
=
this
;
if
(
!
extension
.
hasPermission
(
"
devtools
"
)
|
|
this
.
_initialized
)
{
return
;
}
this
.
initDevToolsPref
(
)
;
this
.
pageDefinition
=
new
DevToolsPageDefinition
(
extension
extension
.
manifest
.
devtools_page
)
;
if
(
!
this
.
isDevToolsPageDisabled
(
)
)
{
this
.
pageDefinition
.
build
(
)
;
}
DevToolsShim
.
on
(
"
toolbox
-
ready
"
this
.
onToolboxReady
)
;
DevToolsShim
.
on
(
"
toolbox
-
destroy
"
this
.
onToolboxDestroy
)
;
this
.
_initialized
=
true
;
}
_uninitialize
(
)
{
if
(
!
this
.
_initialized
)
{
return
;
}
DevToolsShim
.
off
(
"
toolbox
-
ready
"
this
.
onToolboxReady
)
;
DevToolsShim
.
off
(
"
toolbox
-
destroy
"
this
.
onToolboxDestroy
)
;
this
.
pageDefinition
.
shutdown
(
)
;
this
.
pageDefinition
=
null
;
for
(
let
toolbox
of
DevToolsShim
.
getToolboxes
(
)
)
{
toolbox
.
unregisterWebExtension
(
this
.
extension
.
uuid
)
;
}
this
.
uninitDevToolsPref
(
)
;
this
.
_initialized
=
false
;
}
onShutdown
(
)
{
this
.
_uninitialize
(
)
;
}
getAPI
(
context
)
{
return
{
devtools
:
{
}
}
;
}
onToolboxReady
(
toolbox
)
{
if
(
!
toolbox
.
descriptorFront
.
isLocalTab
|
|
!
this
.
extension
.
canAccessWindow
(
toolbox
.
descriptorFront
.
localTab
.
ownerGlobal
)
)
{
return
;
}
toolbox
.
registerWebExtension
(
this
.
extension
.
uuid
{
name
:
this
.
extension
.
name
pref
:
{
getDevToolsPrefBranchName
(
this
.
extension
.
id
)
}
.
enabled
}
)
;
if
(
toolbox
.
isWebExtensionEnabled
(
this
.
extension
.
uuid
)
)
{
this
.
pageDefinition
.
buildForToolbox
(
toolbox
)
;
}
}
onToolboxDestroy
(
toolbox
)
{
if
(
!
toolbox
.
descriptorFront
.
isLocalTab
)
{
return
;
}
this
.
pageDefinition
.
shutdownForToolbox
(
toolbox
)
;
}
initDevToolsPref
(
)
{
const
prefBranch
=
Services
.
prefs
.
getBranch
(
{
getDevToolsPrefBranchName
(
this
.
extension
.
id
)
}
.
)
;
if
(
prefBranch
.
getPrefType
(
"
enabled
"
)
=
=
=
prefBranch
.
PREF_INVALID
)
{
prefBranch
.
setBoolPref
(
"
enabled
"
true
)
;
}
this
.
devtoolsPrefBranch
=
prefBranch
;
this
.
devtoolsPrefBranch
.
addObserver
(
"
enabled
"
this
)
;
}
uninitDevToolsPref
(
)
{
this
.
devtoolsPrefBranch
.
removeObserver
(
"
enabled
"
this
)
;
this
.
devtoolsPrefBranch
=
null
;
}
isDevToolsPageDisabled
(
)
{
return
!
this
.
devtoolsPrefBranch
.
getBoolPref
(
"
enabled
"
false
)
;
}
observe
(
subject
topic
prefName
)
{
if
(
subject
!
=
=
this
.
devtoolsPrefBranch
|
|
prefName
!
=
=
"
enabled
"
)
{
return
;
}
if
(
this
.
isDevToolsPageDisabled
(
)
)
{
this
.
pageDefinition
.
shutdown
(
)
;
}
else
{
this
.
pageDefinition
.
build
(
)
;
}
}
}
;
