"
use
strict
"
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
UrlbarContextualTip
:
"
resource
:
/
/
/
modules
/
UrlbarContextualTip
.
jsm
"
UrlbarPrefs
:
"
resource
:
/
/
/
modules
/
UrlbarPrefs
.
jsm
"
UrlbarProviderExtension
:
"
resource
:
/
/
/
modules
/
UrlbarProviderExtension
.
jsm
"
}
)
;
var
{
ExtensionPreferencesManager
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ExtensionPreferencesManager
.
jsm
"
)
;
var
{
getSettingsAPI
}
=
ExtensionPreferencesManager
;
var
{
ExtensionParent
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ExtensionParent
.
jsm
"
)
;
var
{
IconDetails
}
=
ExtensionParent
;
ExtensionPreferencesManager
.
addSetting
(
"
openViewOnFocus
"
{
prefNames
:
[
"
browser
.
urlbar
.
openViewOnFocus
"
]
setCallback
(
value
)
{
return
{
[
this
.
prefNames
[
0
]
]
:
value
}
;
}
}
)
;
ExtensionPreferencesManager
.
addSetting
(
"
engagementTelemetry
"
{
prefNames
:
[
"
browser
.
urlbar
.
eventTelemetry
.
enabled
"
]
setCallback
(
value
)
{
return
{
[
this
.
prefNames
[
0
]
]
:
value
}
;
}
}
)
;
let
idOfExtUsingContextualTip
=
null
;
this
.
urlbar
=
class
extends
ExtensionAPI
{
onShutdown
(
)
{
if
(
idOfExtUsingContextualTip
=
=
=
this
.
extension
.
id
)
{
for
(
let
w
of
windowTracker
.
browserWindows
(
)
)
{
w
.
gURLBar
.
view
.
removeContextualTip
(
)
;
}
idOfExtUsingContextualTip
=
null
;
}
}
_getStyleFromIconsObject
(
icons
)
{
let
getIcon
=
(
icon
theme
)
=
>
{
if
(
typeof
icon
=
=
=
"
object
"
)
{
return
IconDetails
.
escapeUrl
(
icon
[
theme
]
)
;
}
return
IconDetails
.
escapeUrl
(
icon
)
;
}
;
let
getStyle
=
(
name
icon
)
=
>
{
return
-
-
webextension
-
{
name
}
:
url
(
"
{
getIcon
(
icon
"
default
"
)
}
"
)
;
-
-
webextension
-
{
name
}
-
light
:
url
(
"
{
getIcon
(
icon
"
light
"
)
}
"
)
;
-
-
webextension
-
{
name
}
-
dark
:
url
(
"
{
getIcon
(
icon
"
dark
"
)
}
"
)
;
;
}
;
let
icon16
=
IconDetails
.
getPreferredIcon
(
icons
this
.
extension
16
)
.
icon
;
let
icon32
=
IconDetails
.
getPreferredIcon
(
icons
this
.
extension
32
)
.
icon
;
return
{
getStyle
(
"
contextual
-
tip
-
icon
"
icon16
)
}
{
getStyle
(
"
contextual
-
tip
-
icon
-
2x
"
icon32
)
}
;
}
_registerExtensionToUseContextualTip
(
)
{
if
(
idOfExtUsingContextualTip
=
=
null
)
{
idOfExtUsingContextualTip
=
this
.
extension
.
id
;
}
if
(
idOfExtUsingContextualTip
!
=
=
this
.
extension
.
id
)
{
throw
new
Error
(
"
There
was
an
attempt
to
use
the
contextual
tip
API
but
"
+
"
another
extension
is
already
using
the
contextual
tip
API
.
"
)
;
}
}
_registerClickListener
(
type
)
{
return
fire
=
>
{
this
.
_registerExtensionToUseContextualTip
(
)
;
const
listener
=
window
=
>
{
const
windowId
=
this
.
extension
.
windowManager
.
wrapWindow
(
window
)
.
id
;
fire
.
async
(
windowId
)
;
}
;
UrlbarContextualTip
.
addClickListener
(
type
listener
)
;
return
(
)
=
>
{
UrlbarContextualTip
.
removeClickListener
(
type
listener
)
;
}
;
}
;
}
getAPI
(
context
)
{
return
{
urlbar
:
{
closeView
(
)
{
let
window
=
windowTracker
.
getTopNormalWindow
(
context
)
;
window
.
gURLBar
.
view
.
close
(
)
;
}
focus
(
select
=
false
)
{
let
window
=
windowTracker
.
getTopNormalWindow
(
context
)
;
if
(
select
)
{
window
.
focusAndSelectUrlBar
(
)
;
}
else
{
window
.
gURLBar
.
focus
(
)
;
}
}
search
(
searchString
options
=
{
}
)
{
let
window
=
windowTracker
.
getTopNormalWindow
(
context
)
;
window
.
gURLBar
.
search
(
searchString
options
)
;
}
onBehaviorRequested
:
new
EventManager
(
{
context
name
:
"
urlbar
.
onBehaviorRequested
"
register
:
(
fire
providerName
)
=
>
{
let
provider
=
UrlbarProviderExtension
.
getOrCreate
(
providerName
)
;
provider
.
setEventListener
(
"
behaviorRequested
"
async
queryContext
=
>
{
if
(
queryContext
.
isPrivate
&
&
!
context
.
privateBrowsingAllowed
)
{
return
"
inactive
"
;
}
return
fire
.
async
(
queryContext
)
.
catch
(
error
=
>
{
throw
context
.
normalizeError
(
error
)
;
}
)
;
}
)
;
return
(
)
=
>
provider
.
setEventListener
(
"
behaviorRequested
"
null
)
;
}
}
)
.
api
(
)
onQueryCanceled
:
new
EventManager
(
{
context
name
:
"
urlbar
.
onQueryCanceled
"
register
:
(
fire
providerName
)
=
>
{
let
provider
=
UrlbarProviderExtension
.
getOrCreate
(
providerName
)
;
provider
.
setEventListener
(
"
queryCanceled
"
async
queryContext
=
>
{
if
(
queryContext
.
isPrivate
&
&
!
context
.
privateBrowsingAllowed
)
{
return
;
}
await
fire
.
async
(
queryContext
)
.
catch
(
error
=
>
{
throw
context
.
normalizeError
(
error
)
;
}
)
;
}
)
;
return
(
)
=
>
provider
.
setEventListener
(
"
queryCanceled
"
null
)
;
}
}
)
.
api
(
)
onResultsRequested
:
new
EventManager
(
{
context
name
:
"
urlbar
.
onResultsRequested
"
register
:
(
fire
providerName
)
=
>
{
let
provider
=
UrlbarProviderExtension
.
getOrCreate
(
providerName
)
;
provider
.
setEventListener
(
"
resultsRequested
"
async
queryContext
=
>
{
if
(
queryContext
.
isPrivate
&
&
!
context
.
privateBrowsingAllowed
)
{
return
[
]
;
}
return
fire
.
async
(
queryContext
)
.
catch
(
error
=
>
{
throw
context
.
normalizeError
(
error
)
;
}
)
;
}
)
;
return
(
)
=
>
provider
.
setEventListener
(
"
resultsRequested
"
null
)
;
}
}
)
.
api
(
)
onResultPicked
:
new
EventManager
(
{
context
name
:
"
urlbar
.
onResultPicked
"
register
:
(
fire
providerName
)
=
>
{
let
provider
=
UrlbarProviderExtension
.
getOrCreate
(
providerName
)
;
provider
.
setEventListener
(
"
resultPicked
"
async
resultPayload
=
>
{
return
fire
.
async
(
resultPayload
)
.
catch
(
error
=
>
{
throw
context
.
normalizeError
(
error
)
;
}
)
;
}
)
;
return
(
)
=
>
provider
.
setEventListener
(
"
resultPicked
"
null
)
;
}
}
)
.
api
(
)
openViewOnFocus
:
getSettingsAPI
(
context
.
extension
.
id
"
openViewOnFocus
"
(
)
=
>
UrlbarPrefs
.
get
(
"
openViewOnFocus
"
)
)
engagementTelemetry
:
getSettingsAPI
(
context
.
extension
.
id
"
engagementTelemetry
"
(
)
=
>
UrlbarPrefs
.
get
(
"
eventTelemetry
.
enabled
"
)
)
contextualTip
:
{
set
:
details
=
>
{
this
.
_registerExtensionToUseContextualTip
(
)
;
const
mostRecentWindow
=
windowTracker
.
getTopNormalWindow
(
context
)
;
const
iconPathFromDetails
=
details
.
icon
?
details
.
icon
.
defaultIcon
:
null
;
const
iconPathFromExtensionManifest
=
context
.
extension
.
manifest
.
icons
;
const
icons
=
IconDetails
.
normalize
(
{
path
:
iconPathFromDetails
|
|
iconPathFromExtensionManifest
iconType
:
"
contextualTip
"
themeIcons
:
details
.
icon
?
details
.
icon
.
themeIcons
:
null
}
context
.
extension
)
;
const
iconStyle
=
this
.
_getStyleFromIconsObject
(
icons
)
;
mostRecentWindow
.
gURLBar
.
view
.
setContextualTip
(
{
iconStyle
title
:
details
.
title
buttonTitle
:
details
.
buttonTitle
linkTitle
:
details
.
linkTitle
}
)
;
}
remove
:
(
)
=
>
{
this
.
_registerExtensionToUseContextualTip
(
)
;
const
mostRecentWindow
=
windowTracker
.
getTopNormalWindow
(
context
)
;
mostRecentWindow
.
gURLBar
.
view
.
hideContextualTip
(
)
;
}
onButtonClicked
:
new
EventManager
(
{
context
name
:
"
urlbar
.
contextualTip
.
onButtonClicked
"
register
:
this
.
_registerClickListener
(
"
button
"
)
}
)
.
api
(
)
onLinkClicked
:
new
EventManager
(
{
context
name
:
"
urlbar
.
contextualTip
.
onLinkClicked
"
register
:
this
.
_registerClickListener
(
"
link
"
)
}
)
.
api
(
)
}
}
}
;
}
}
;
