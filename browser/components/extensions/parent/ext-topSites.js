"
use
strict
"
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
AboutNewTab
:
"
resource
:
/
/
/
modules
/
AboutNewTab
.
jsm
"
NewTabUtils
:
"
resource
:
/
/
gre
/
modules
/
NewTabUtils
.
jsm
"
shortURL
:
"
resource
:
/
/
activity
-
stream
/
lib
/
ShortURL
.
jsm
"
getSearchProvider
:
"
resource
:
/
/
activity
-
stream
/
lib
/
SearchShortcuts
.
jsm
"
}
)
;
const
SHORTCUTS_PREF
=
"
browser
.
newtabpage
.
activity
-
stream
.
improvesearch
.
topSiteSearchShortcuts
"
;
this
.
topSites
=
class
extends
ExtensionAPI
{
getAPI
(
context
)
{
return
{
topSites
:
{
get
:
async
function
(
options
)
{
let
links
=
options
.
newtab
?
AboutNewTab
.
getTopSites
(
)
:
await
NewTabUtils
.
activityStreamLinks
.
getTopSites
(
{
ignoreBlocked
:
options
.
includeBlocked
onePerDomain
:
options
.
onePerDomain
numItems
:
options
.
limit
includeFavicon
:
options
.
includeFavicon
}
)
;
if
(
options
.
includePinned
&
&
!
options
.
newtab
)
{
let
pinnedLinks
=
NewTabUtils
.
pinnedLinks
.
links
;
if
(
options
.
includeFavicon
)
{
pinnedLinks
=
NewTabUtils
.
activityStreamProvider
.
_faviconBytesToDataURI
(
await
NewTabUtils
.
activityStreamProvider
.
_addFavicons
(
pinnedLinks
)
)
;
}
pinnedLinks
.
forEach
(
(
pinnedLink
index
)
=
>
{
if
(
pinnedLink
&
&
(
!
pinnedLink
.
searchTopSite
|
|
options
.
includeSearchShortcuts
)
)
{
links
=
links
.
filter
(
link
=
>
link
.
url
!
=
pinnedLink
.
url
&
&
(
!
options
.
onePerDomain
|
|
NewTabUtils
.
extractSite
(
link
.
url
)
!
=
pinnedLink
.
baseDomain
)
)
;
links
.
splice
(
index
0
pinnedLink
)
;
}
}
)
;
}
if
(
options
.
includeSearchShortcuts
&
&
Services
.
prefs
.
getBoolPref
(
SHORTCUTS_PREF
false
)
&
&
!
options
.
newtab
)
{
links
=
links
.
map
(
link
=
>
{
let
searchProvider
=
getSearchProvider
(
shortURL
(
link
)
)
;
if
(
searchProvider
)
{
link
.
searchTopSite
=
true
;
link
.
label
=
searchProvider
.
keyword
;
link
.
url
=
searchProvider
.
url
;
}
return
link
;
}
)
;
}
if
(
typeof
options
.
limit
=
=
"
number
"
)
{
links
=
links
.
slice
(
0
options
.
limit
)
;
}
return
links
.
map
(
link
=
>
{
let
newLink
;
if
(
link
.
searchTopSite
)
{
newLink
=
{
type
:
"
search
"
url
:
link
.
url
title
:
link
.
label
}
;
}
else
{
newLink
=
{
type
:
"
url
"
url
:
link
.
url
title
:
link
.
title
|
|
link
.
hostname
}
;
}
newLink
.
favicon
=
options
.
includeFavicon
?
link
.
favicon
|
|
link
.
tippyTopIcon
|
|
null
:
null
;
return
newLink
;
}
)
;
}
}
}
;
}
}
;
