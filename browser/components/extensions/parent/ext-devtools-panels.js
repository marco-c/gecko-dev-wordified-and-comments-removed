"
use
strict
"
;
var
{
ExtensionParent
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
ExtensionParent
.
jsm
"
)
;
var
{
IconDetails
watchExtensionProxyContextLoad
}
=
ExtensionParent
;
var
{
promiseDocumentLoaded
}
=
ExtensionUtils
;
const
WEBEXT_PANELS_URL
=
"
chrome
:
/
/
browser
/
content
/
webext
-
panels
.
xul
"
;
class
BaseDevToolsPanel
{
constructor
(
context
panelOptions
)
{
const
toolbox
=
context
.
devToolsToolbox
;
if
(
!
toolbox
)
{
throw
Error
(
"
Missing
mandatory
toolbox
"
)
;
}
this
.
context
=
context
;
this
.
extension
=
context
.
extension
;
this
.
toolbox
=
toolbox
;
this
.
viewType
=
"
devtools_panel
"
;
this
.
panelOptions
=
panelOptions
;
this
.
id
=
panelOptions
.
id
;
this
.
unwatchExtensionProxyContextLoad
=
null
;
this
.
browser
=
null
;
this
.
browserContainerWindow
=
null
;
}
async
createBrowserElement
(
window
)
{
const
{
toolbox
}
=
this
;
const
{
extension
}
=
this
.
context
;
const
{
url
}
=
this
.
panelOptions
|
|
{
url
:
"
about
:
blank
"
}
;
this
.
browser
=
await
window
.
getBrowser
(
{
extension
extensionUrl
:
url
browserStyle
:
false
viewType
:
"
devtools_panel
"
browserInsertedData
:
{
devtoolsToolboxInfo
:
{
toolboxPanelId
:
this
.
id
inspectedWindowTabId
:
getTargetTabIdForToolbox
(
toolbox
)
}
}
}
)
;
let
hasTopLevelContext
=
false
;
this
.
unwatchExtensionProxyContextLoad
=
watchExtensionProxyContextLoad
(
this
context
=
>
{
context
.
devToolsToolbox
=
toolbox
;
if
(
!
hasTopLevelContext
)
{
hasTopLevelContext
=
true
;
if
(
this
.
_resolveTopLevelContext
)
{
this
.
_resolveTopLevelContext
(
context
)
;
}
}
}
)
;
this
.
browser
.
loadURI
(
url
{
triggeringPrincipal
:
this
.
context
.
principal
}
)
;
}
destroyBrowserElement
(
)
{
const
{
browser
unwatchExtensionProxyContextLoad
}
=
this
;
if
(
unwatchExtensionProxyContextLoad
)
{
this
.
unwatchExtensionProxyContextLoad
=
null
;
unwatchExtensionProxyContextLoad
(
)
;
}
if
(
browser
)
{
browser
.
remove
(
)
;
this
.
browser
=
null
;
}
}
}
class
ParentDevToolsPanel
extends
BaseDevToolsPanel
{
constructor
(
context
panelOptions
)
{
super
(
context
panelOptions
)
;
this
.
visible
=
false
;
this
.
destroyed
=
false
;
this
.
context
.
callOnClose
(
this
)
;
this
.
onToolboxPanelSelect
=
this
.
onToolboxPanelSelect
.
bind
(
this
)
;
this
.
onToolboxHostWillChange
=
this
.
onToolboxHostWillChange
.
bind
(
this
)
;
this
.
onToolboxHostChanged
=
this
.
onToolboxHostChanged
.
bind
(
this
)
;
this
.
waitTopLevelContext
=
new
Promise
(
resolve
=
>
{
this
.
_resolveTopLevelContext
=
resolve
;
}
)
;
this
.
panelAdded
=
false
;
this
.
addPanel
(
)
;
}
addPanel
(
)
{
const
{
icon
title
}
=
this
.
panelOptions
;
const
extensionName
=
this
.
context
.
extension
.
name
;
this
.
toolbox
.
addAdditionalTool
(
{
id
:
this
.
id
extensionId
:
this
.
context
.
extension
.
id
url
:
WEBEXT_PANELS_URL
icon
:
icon
label
:
title
tooltip
:
DevTools
Panel
added
by
"
{
extensionName
}
"
add
-
on
.
isTargetSupported
:
target
=
>
target
.
isLocalTab
build
:
(
window
toolbox
)
=
>
{
if
(
toolbox
!
=
=
this
.
toolbox
)
{
throw
new
Error
(
"
Unexpected
toolbox
received
on
addAdditionalTool
build
property
"
)
;
}
const
destroy
=
this
.
buildPanel
(
window
)
;
return
{
toolbox
destroy
}
;
}
}
)
;
this
.
panelAdded
=
true
;
}
buildPanel
(
window
)
{
const
{
toolbox
}
=
this
;
this
.
createBrowserElement
(
window
)
;
this
.
browserContainerWindow
=
window
;
toolbox
.
on
(
"
select
"
this
.
onToolboxPanelSelect
)
;
toolbox
.
on
(
"
host
-
will
-
change
"
this
.
onToolboxHostWillChange
)
;
toolbox
.
on
(
"
host
-
changed
"
this
.
onToolboxHostChanged
)
;
return
(
)
=
>
{
this
.
destroyBrowserElement
(
)
;
this
.
browserContainerWindow
=
null
;
toolbox
.
off
(
"
select
"
this
.
onToolboxPanelSelect
)
;
toolbox
.
off
(
"
host
-
will
-
change
"
this
.
onToolboxHostWillChange
)
;
toolbox
.
off
(
"
host
-
changed
"
this
.
onToolboxHostChanged
)
;
}
;
}
onToolboxHostWillChange
(
)
{
if
(
this
.
browser
)
{
if
(
this
.
visible
)
{
this
.
context
.
parentMessageManager
.
sendAsyncMessage
(
"
Extension
:
DevToolsPanelHidden
"
{
toolboxPanelId
:
this
.
id
}
)
;
}
this
.
destroyBrowserElement
(
)
;
}
}
async
onToolboxHostChanged
(
)
{
if
(
this
.
browserContainerWindow
)
{
this
.
createBrowserElement
(
this
.
browserContainerWindow
)
;
if
(
this
.
visible
)
{
await
this
.
waitTopLevelContext
;
this
.
context
.
parentMessageManager
.
sendAsyncMessage
(
"
Extension
:
DevToolsPanelShown
"
{
toolboxPanelId
:
this
.
id
}
)
;
}
}
}
async
onToolboxPanelSelect
(
id
)
{
if
(
!
this
.
waitTopLevelContext
|
|
!
this
.
panelAdded
)
{
return
;
}
await
this
.
waitTopLevelContext
;
if
(
!
this
.
visible
&
&
id
=
=
=
this
.
id
)
{
this
.
visible
=
true
;
}
else
if
(
this
.
visible
&
&
id
!
=
=
this
.
id
)
{
this
.
visible
=
false
;
}
const
extensionMessage
=
Extension
:
DevToolsPanel
{
this
.
visible
?
"
Shown
"
:
"
Hidden
"
}
;
this
.
context
.
parentMessageManager
.
sendAsyncMessage
(
extensionMessage
{
toolboxPanelId
:
this
.
id
}
)
;
}
close
(
)
{
const
{
toolbox
}
=
this
;
if
(
!
toolbox
)
{
throw
new
Error
(
"
Unable
to
destroy
a
closed
devtools
panel
"
)
;
}
if
(
this
.
panelAdded
&
&
toolbox
.
isToolRegistered
(
this
.
id
)
)
{
this
.
destroyBrowserElement
(
)
;
toolbox
.
removeAdditionalTool
(
this
.
id
)
;
}
this
.
waitTopLevelContext
=
null
;
this
.
_resolveTopLevelContext
=
null
;
this
.
context
=
null
;
this
.
toolbox
=
null
;
this
.
browser
=
null
;
this
.
browserContainerWindow
=
null
;
}
destroyBrowserElement
(
)
{
super
.
destroyBrowserElement
(
)
;
this
.
waitTopLevelContext
=
new
Promise
(
resolve
=
>
{
this
.
_resolveTopLevelContext
=
resolve
;
}
)
;
}
}
class
DevToolsSelectionObserver
extends
EventEmitter
{
constructor
(
context
)
{
if
(
!
context
.
devToolsToolbox
)
{
throw
Error
(
"
Missing
mandatory
toolbox
"
)
;
}
super
(
)
;
context
.
callOnClose
(
this
)
;
this
.
toolbox
=
context
.
devToolsToolbox
;
this
.
onSelected
=
this
.
onSelected
.
bind
(
this
)
;
this
.
initialized
=
false
;
}
on
(
.
.
.
args
)
{
this
.
lazyInit
(
)
;
super
.
on
.
apply
(
this
args
)
;
}
once
(
.
.
.
args
)
{
this
.
lazyInit
(
)
;
super
.
once
.
apply
(
this
args
)
;
}
async
lazyInit
(
)
{
if
(
!
this
.
initialized
)
{
this
.
initialized
=
true
;
this
.
toolbox
.
on
(
"
selection
-
changed
"
this
.
onSelected
)
;
}
}
close
(
)
{
if
(
this
.
destroyed
)
{
throw
new
Error
(
"
Unable
to
close
a
destroyed
DevToolsSelectionObserver
"
)
;
}
if
(
this
.
initialized
)
{
this
.
toolbox
.
off
(
"
selection
-
changed
"
this
.
onSelected
)
;
}
this
.
toolbox
=
null
;
this
.
destroyed
=
true
;
}
onSelected
(
)
{
this
.
emit
(
"
selectionChanged
"
)
;
}
}
class
ParentDevToolsInspectorSidebar
extends
BaseDevToolsPanel
{
constructor
(
context
panelOptions
)
{
super
(
context
panelOptions
)
;
this
.
visible
=
false
;
this
.
destroyed
=
false
;
this
.
context
.
callOnClose
(
this
)
;
this
.
onSidebarSelect
=
this
.
onSidebarSelect
.
bind
(
this
)
;
this
.
onSidebarCreated
=
this
.
onSidebarCreated
.
bind
(
this
)
;
this
.
onExtensionPageMount
=
this
.
onExtensionPageMount
.
bind
(
this
)
;
this
.
onExtensionPageUnmount
=
this
.
onExtensionPageUnmount
.
bind
(
this
)
;
this
.
onToolboxHostWillChange
=
this
.
onToolboxHostWillChange
.
bind
(
this
)
;
this
.
onToolboxHostChanged
=
this
.
onToolboxHostChanged
.
bind
(
this
)
;
this
.
toolbox
.
once
(
extension
-
sidebar
-
created
-
{
this
.
id
}
this
.
onSidebarCreated
)
;
this
.
toolbox
.
on
(
"
inspector
-
sidebar
-
select
"
this
.
onSidebarSelect
)
;
this
.
toolbox
.
on
(
"
host
-
will
-
change
"
this
.
onToolboxHostWillChange
)
;
this
.
toolbox
.
on
(
"
host
-
changed
"
this
.
onToolboxHostChanged
)
;
this
.
_initializeSidebar
=
null
;
this
.
_lastObjectValueGrip
=
null
;
this
.
toolbox
.
registerInspectorExtensionSidebar
(
this
.
id
{
title
:
panelOptions
.
title
}
)
;
}
close
(
)
{
if
(
this
.
destroyed
)
{
throw
new
Error
(
"
Unable
to
close
a
destroyed
DevToolsSelectionObserver
"
)
;
}
if
(
this
.
extensionSidebar
)
{
this
.
extensionSidebar
.
off
(
"
extension
-
page
-
mount
"
this
.
onExtensionPageMount
)
;
this
.
extensionSidebar
.
off
(
"
extension
-
page
-
unmount
"
this
.
onExtensionPageUnmount
)
;
}
if
(
this
.
browser
)
{
this
.
destroyBrowserElement
(
)
;
this
.
browser
=
null
;
this
.
containerEl
=
null
;
}
this
.
_updateLastObjectValueGrip
(
null
)
;
this
.
toolbox
.
off
(
extension
-
sidebar
-
created
-
{
this
.
id
}
this
.
onSidebarCreated
)
;
this
.
toolbox
.
off
(
"
inspector
-
sidebar
-
select
"
this
.
onSidebarSelect
)
;
this
.
toolbox
.
off
(
"
host
-
changed
"
this
.
onToolboxHostChanged
)
;
this
.
toolbox
.
off
(
"
host
-
will
-
change
"
this
.
onToolboxHostWillChange
)
;
this
.
toolbox
.
unregisterInspectorExtensionSidebar
(
this
.
id
)
;
this
.
extensionSidebar
=
null
;
this
.
_lazySidebarInit
=
null
;
this
.
destroyed
=
true
;
}
onToolboxHostWillChange
(
)
{
if
(
this
.
browser
)
{
this
.
destroyBrowserElement
(
)
;
}
}
onToolboxHostChanged
(
)
{
if
(
this
.
containerEl
&
&
this
.
panelOptions
.
url
)
{
this
.
createBrowserElement
(
this
.
containerEl
.
contentWindow
)
;
}
}
onExtensionPageMount
(
containerEl
)
{
this
.
containerEl
=
containerEl
;
promiseDocumentLoaded
(
containerEl
.
contentDocument
)
.
then
(
(
)
=
>
{
this
.
createBrowserElement
(
containerEl
.
contentWindow
)
;
}
)
;
}
onExtensionPageUnmount
(
)
{
this
.
containerEl
=
null
;
this
.
destroyBrowserElement
(
)
;
}
onSidebarCreated
(
sidebar
)
{
this
.
extensionSidebar
=
sidebar
;
sidebar
.
on
(
"
extension
-
page
-
mount
"
this
.
onExtensionPageMount
)
;
sidebar
.
on
(
"
extension
-
page
-
unmount
"
this
.
onExtensionPageUnmount
)
;
const
{
_lazySidebarInit
}
=
this
;
this
.
_lazySidebarInit
=
null
;
if
(
typeof
_lazySidebarInit
=
=
=
"
function
"
)
{
_lazySidebarInit
(
)
;
}
}
onSidebarSelect
(
id
)
{
if
(
!
this
.
extensionSidebar
)
{
return
;
}
if
(
!
this
.
visible
&
&
id
=
=
=
this
.
id
)
{
this
.
visible
=
true
;
this
.
context
.
parentMessageManager
.
sendAsyncMessage
(
"
Extension
:
DevToolsInspectorSidebarShown
"
{
inspectorSidebarId
:
this
.
id
}
)
;
}
else
if
(
this
.
visible
&
&
id
!
=
=
this
.
id
)
{
this
.
visible
=
false
;
this
.
context
.
parentMessageManager
.
sendAsyncMessage
(
"
Extension
:
DevToolsInspectorSidebarHidden
"
{
inspectorSidebarId
:
this
.
id
}
)
;
}
}
setPage
(
extensionPageURL
)
{
this
.
panelOptions
.
url
=
extensionPageURL
;
if
(
this
.
extensionSidebar
)
{
if
(
this
.
browser
)
{
this
.
browser
.
loadURI
(
this
.
panelOptions
.
url
{
triggeringPrincipal
:
this
.
context
.
extension
.
principal
}
)
;
}
else
{
this
.
extensionSidebar
.
setExtensionPage
(
WEBEXT_PANELS_URL
)
;
}
}
else
{
this
.
_setLazySidebarInit
(
(
)
=
>
this
.
extensionSidebar
.
setExtensionPage
(
WEBEXT_PANELS_URL
)
)
;
}
}
setObject
(
object
rootTitle
)
{
delete
this
.
panelOptions
.
url
;
this
.
_updateLastObjectValueGrip
(
null
)
;
if
(
rootTitle
)
{
object
=
{
[
rootTitle
]
:
object
}
;
}
if
(
this
.
extensionSidebar
)
{
this
.
extensionSidebar
.
setObject
(
object
)
;
}
else
{
this
.
_setLazySidebarInit
(
(
)
=
>
this
.
extensionSidebar
.
setObject
(
object
)
)
;
}
}
_setLazySidebarInit
(
cb
)
{
this
.
_lazySidebarInit
=
cb
;
}
setObjectValueGrip
(
objectValueGrip
rootTitle
)
{
delete
this
.
panelOptions
.
url
;
this
.
_updateLastObjectValueGrip
(
objectValueGrip
)
;
if
(
this
.
extensionSidebar
)
{
this
.
extensionSidebar
.
setObjectValueGrip
(
objectValueGrip
rootTitle
)
;
}
else
{
this
.
_setLazySidebarInit
(
(
)
=
>
{
this
.
extensionSidebar
.
setObjectValueGrip
(
objectValueGrip
rootTitle
)
;
}
)
;
}
}
_updateLastObjectValueGrip
(
newObjectValueGrip
=
null
)
{
const
{
_lastObjectValueGrip
}
=
this
;
this
.
_lastObjectValueGrip
=
newObjectValueGrip
;
const
oldActor
=
_lastObjectValueGrip
&
&
_lastObjectValueGrip
.
actor
;
const
newActor
=
newObjectValueGrip
&
&
newObjectValueGrip
.
actor
;
if
(
oldActor
&
&
oldActor
!
=
=
newActor
)
{
this
.
toolbox
.
target
.
client
.
release
(
oldActor
)
;
}
}
}
const
sidebarsById
=
new
Map
(
)
;
this
.
devtools_panels
=
class
extends
ExtensionAPI
{
getAPI
(
context
)
{
let
waitForInspectedWindowFront
;
const
callerInfo
=
{
addonId
:
context
.
extension
.
id
url
:
context
.
extension
.
baseURI
.
spec
}
;
let
nextPanelId
=
0
;
const
toolboxSelectionObserver
=
new
DevToolsSelectionObserver
(
context
)
;
function
newBasePanelId
(
)
{
return
{
context
.
extension
.
id
}
-
{
context
.
contextId
}
-
{
nextPanelId
+
+
}
;
}
return
{
devtools
:
{
panels
:
{
elements
:
{
onSelectionChanged
:
new
EventManager
(
{
context
name
:
"
devtools
.
panels
.
elements
.
onSelectionChanged
"
register
:
fire
=
>
{
const
listener
=
(
eventName
)
=
>
{
fire
.
async
(
)
;
}
;
toolboxSelectionObserver
.
on
(
"
selectionChanged
"
listener
)
;
return
(
)
=
>
{
toolboxSelectionObserver
.
off
(
"
selectionChanged
"
listener
)
;
}
;
}
}
)
.
api
(
)
createSidebarPane
(
title
)
{
const
id
=
devtools
-
inspector
-
sidebar
-
{
makeWidgetId
(
newBasePanelId
(
)
)
}
;
const
parentSidebar
=
new
ParentDevToolsInspectorSidebar
(
context
{
title
id
}
)
;
sidebarsById
.
set
(
id
parentSidebar
)
;
context
.
callOnClose
(
{
close
(
)
{
sidebarsById
.
delete
(
id
)
;
}
}
)
;
return
Promise
.
resolve
(
id
)
;
}
Sidebar
:
{
setPage
(
sidebarId
extensionPageURL
)
{
const
sidebar
=
sidebarsById
.
get
(
sidebarId
)
;
return
sidebar
.
setPage
(
extensionPageURL
)
;
}
setObject
(
sidebarId
jsonObject
rootTitle
)
{
const
sidebar
=
sidebarsById
.
get
(
sidebarId
)
;
return
sidebar
.
setObject
(
jsonObject
rootTitle
)
;
}
async
setExpression
(
sidebarId
evalExpression
rootTitle
)
{
const
sidebar
=
sidebarsById
.
get
(
sidebarId
)
;
if
(
!
waitForInspectedWindowFront
)
{
waitForInspectedWindowFront
=
getInspectedWindowFront
(
context
)
;
}
const
front
=
await
waitForInspectedWindowFront
;
const
evalOptions
=
Object
.
assign
(
{
evalResultAsGrip
:
true
}
getToolboxEvalOptions
(
context
)
)
;
const
evalResult
=
await
front
.
eval
(
callerInfo
evalExpression
evalOptions
)
;
let
jsonObject
;
if
(
evalResult
.
exceptionInfo
)
{
jsonObject
=
evalResult
.
exceptionInfo
;
return
sidebar
.
setObject
(
jsonObject
rootTitle
)
;
}
return
sidebar
.
setObjectValueGrip
(
evalResult
.
valueGrip
rootTitle
)
;
}
}
}
create
(
title
icon
url
)
{
if
(
icon
=
=
=
"
"
&
&
context
.
extension
.
manifest
.
icons
)
{
const
iconInfo
=
IconDetails
.
getPreferredIcon
(
context
.
extension
.
manifest
.
icons
context
.
extension
128
)
;
icon
=
iconInfo
?
iconInfo
.
icon
:
"
"
;
}
icon
=
context
.
extension
.
baseURI
.
resolve
(
icon
)
;
url
=
context
.
extension
.
baseURI
.
resolve
(
url
)
;
const
id
=
webext
-
devtools
-
panel
-
{
makeWidgetId
(
newBasePanelId
(
)
)
}
;
new
ParentDevToolsPanel
(
context
{
title
icon
url
id
}
)
;
return
Promise
.
resolve
(
id
)
;
}
}
}
}
;
}
}
;
