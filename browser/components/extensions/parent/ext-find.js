"
use
strict
"
;
ChromeUtils
.
defineModuleGetter
(
this
"
PrivateBrowsingUtils
"
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
)
;
var
{
ExtensionError
}
=
ExtensionUtils
;
function
runFindOperation
(
context
params
message
)
{
let
{
tabId
}
=
params
;
let
tab
=
tabId
?
tabTracker
.
getTab
(
tabId
)
:
tabTracker
.
activeTab
;
let
browser
=
tab
.
linkedBrowser
;
let
mm
=
browser
.
messageManager
;
tabId
=
tabId
|
|
tabTracker
.
getId
(
tab
)
;
if
(
!
context
.
privateBrowsingAllowed
&
&
PrivateBrowsingUtils
.
isBrowserPrivate
(
browser
)
)
{
return
Promise
.
reject
(
{
message
:
Unable
to
search
:
{
tabId
}
}
)
;
}
if
(
tab
.
linkedBrowser
.
contentPrincipal
.
isSystemPrincipal
|
|
(
[
"
about
"
"
chrome
"
"
resource
"
]
.
includes
(
tab
.
linkedBrowser
.
currentURI
.
scheme
)
&
&
tab
.
linkedBrowser
.
currentURI
.
spec
!
=
"
about
:
blank
"
)
)
{
return
Promise
.
reject
(
{
message
:
Unable
to
search
:
{
tabId
}
}
)
;
}
return
new
Promise
(
(
resolve
reject
)
=
>
{
mm
.
addMessageListener
(
ext
-
Finder
:
{
message
}
Finished
function
messageListener
(
message
)
{
mm
.
removeMessageListener
(
ext
-
Finder
:
{
message
}
Finished
messageListener
)
;
switch
(
message
.
data
)
{
case
"
Success
"
:
resolve
(
)
;
break
;
case
"
OutOfRange
"
:
reject
(
{
message
:
"
index
supplied
was
out
of
range
"
}
)
;
break
;
case
"
NoResults
"
:
reject
(
{
message
:
"
no
search
results
to
highlight
"
}
)
;
break
;
}
resolve
(
message
.
data
)
;
}
)
;
mm
.
sendAsyncMessage
(
ext
-
Finder
:
{
message
}
params
)
;
}
)
;
}
this
.
find
=
class
extends
ExtensionAPI
{
getAPI
(
context
)
{
return
{
find
:
{
find
(
queryphrase
params
)
{
params
=
params
|
|
{
}
;
params
.
queryphrase
=
queryphrase
;
return
runFindOperation
(
context
params
"
CollectResults
"
)
;
}
highlightResults
(
params
)
{
params
=
params
|
|
{
}
;
return
runFindOperation
(
context
params
"
HighlightResults
"
)
;
}
removeHighlighting
(
tabId
)
{
let
tab
=
tabId
?
tabTracker
.
getTab
(
tabId
)
:
tabTracker
.
activeTab
;
if
(
!
context
.
privateBrowsingAllowed
&
&
PrivateBrowsingUtils
.
isBrowserPrivate
(
tab
.
linkedBrowser
)
)
{
throw
new
ExtensionError
(
Invalid
tab
ID
:
{
tabId
}
)
;
}
tab
.
linkedBrowser
.
messageManager
.
sendAsyncMessage
(
"
ext
-
Finder
:
clearHighlighting
"
)
;
}
}
}
;
}
}
;
