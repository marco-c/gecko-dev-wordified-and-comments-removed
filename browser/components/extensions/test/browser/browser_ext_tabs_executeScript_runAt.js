"
use
strict
"
;
add_task
(
async
function
testExecuteScript
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
true
)
;
async
function
background
(
)
{
let
tab
;
const
BASE
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
browser
/
components
/
extensions
/
test
/
browser
/
"
;
const
URL
=
BASE
+
"
file_slowed_document
.
sjs
"
;
const
MAX_TRIES
=
10
;
let
onUpdatedPromise
=
(
tabId
url
status
)
=
>
{
return
new
Promise
(
resolve
=
>
{
browser
.
tabs
.
onUpdated
.
addListener
(
function
listener
(
_
changed
tab
)
{
if
(
tabId
=
=
tab
.
id
&
&
changed
.
status
=
=
status
&
&
tab
.
url
=
=
url
)
{
browser
.
tabs
.
onUpdated
.
removeListener
(
listener
)
;
resolve
(
)
;
}
}
)
;
}
)
;
}
;
try
{
[
tab
]
=
await
browser
.
tabs
.
query
(
{
active
:
true
currentWindow
:
true
}
)
;
let
success
=
false
;
for
(
let
tries
=
0
;
!
success
&
&
tries
<
MAX_TRIES
;
tries
+
+
)
{
let
url
=
{
URL
}
?
with
-
iframe
&
r
=
{
Math
.
random
(
)
}
;
let
loadingPromise
=
onUpdatedPromise
(
tab
.
id
url
"
loading
"
)
;
let
completePromise
=
onUpdatedPromise
(
tab
.
id
url
"
complete
"
)
;
await
browser
.
tabs
.
update
(
{
url
}
)
;
await
loadingPromise
;
let
states
=
await
Promise
.
all
(
[
browser
.
tabs
.
executeScript
(
{
code
:
"
document
.
readyState
"
}
)
browser
.
tabs
.
executeScript
(
{
code
:
"
document
.
readyState
"
runAt
:
"
document_idle
"
}
)
browser
.
tabs
.
executeScript
(
{
code
:
"
document
.
readyState
"
runAt
:
"
document_end
"
}
)
browser
.
tabs
.
executeScript
(
{
code
:
"
document
.
readyState
"
runAt
:
"
document_start
"
}
)
]
.
reverse
(
)
)
;
browser
.
test
.
log
(
Got
states
:
{
states
}
)
;
browser
.
test
.
assertTrue
(
states
[
1
]
=
=
"
interactive
"
|
|
states
[
1
]
=
=
"
complete
"
document_end
state
is
valid
:
{
states
[
1
]
}
)
;
browser
.
test
.
assertTrue
(
states
[
2
]
=
=
"
interactive
"
|
|
states
[
2
]
=
=
"
complete
"
document_idle
state
is
valid
:
{
states
[
2
]
}
)
;
success
=
states
[
0
]
=
=
"
loading
"
&
&
states
[
1
]
=
=
"
interactive
"
&
&
states
[
2
]
=
=
"
interactive
"
&
&
states
[
3
]
=
=
"
interactive
"
;
await
completePromise
;
}
browser
.
test
.
assertTrue
(
success
"
Got
the
earliest
expected
states
at
least
once
"
)
;
browser
.
test
.
notifyPass
(
"
executeScript
-
runAt
"
)
;
}
catch
(
e
)
{
browser
.
test
.
fail
(
Error
:
{
e
}
:
:
{
e
.
stack
}
)
;
browser
.
test
.
notifyFail
(
"
executeScript
-
runAt
"
)
;
}
}
let
extension
=
ExtensionTestUtils
.
loadExtension
(
{
manifest
:
{
permissions
:
[
"
http
:
/
/
mochi
.
test
/
"
"
tabs
"
]
}
background
}
)
;
await
extension
.
startup
(
)
;
await
extension
.
awaitFinish
(
"
executeScript
-
runAt
"
)
;
await
extension
.
unload
(
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
