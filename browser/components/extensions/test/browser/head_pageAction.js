"
use
strict
"
;
function
*
runTests
(
options
)
{
function
background
(
getTests
)
{
let
tabs
;
let
tests
;
function
getDetails
(
)
{
return
new
Promise
(
resolve
=
>
{
return
browser
.
tabs
.
query
(
{
active
:
true
currentWindow
:
true
}
resolve
)
;
}
)
.
then
(
(
[
tab
]
)
=
>
{
let
tabId
=
tab
.
id
;
browser
.
test
.
log
(
Get
details
:
tab
=
{
id
:
{
tabId
}
url
:
{
JSON
.
stringify
(
tab
.
url
)
}
}
)
;
return
Promise
.
all
(
[
browser
.
pageAction
.
getTitle
(
{
tabId
}
)
browser
.
pageAction
.
getPopup
(
{
tabId
}
)
]
)
;
}
)
.
then
(
details
=
>
{
return
Promise
.
resolve
(
{
title
:
details
[
0
]
popup
:
details
[
1
]
}
)
;
}
)
;
}
function
nextTest
(
)
{
let
test
=
tests
.
shift
(
)
;
test
(
expecting
=
>
{
function
finish
(
)
{
browser
.
test
.
sendMessage
(
"
nextTest
"
expecting
tests
.
length
)
;
}
if
(
expecting
)
{
getDetails
(
)
.
then
(
details
=
>
{
browser
.
test
.
assertEq
(
expecting
.
title
details
.
title
"
expected
value
from
getTitle
"
)
;
browser
.
test
.
assertEq
(
expecting
.
popup
details
.
popup
"
expected
value
from
getPopup
"
)
;
finish
(
)
;
}
)
;
}
else
{
finish
(
)
;
}
}
)
;
}
function
runTests
(
)
{
tabs
=
[
]
;
tests
=
getTests
(
tabs
)
;
browser
.
tabs
.
query
(
{
active
:
true
currentWindow
:
true
}
resultTabs
=
>
{
tabs
[
0
]
=
resultTabs
[
0
]
.
id
;
nextTest
(
)
;
}
)
;
}
browser
.
test
.
onMessage
.
addListener
(
(
msg
)
=
>
{
if
(
msg
=
=
"
runTests
"
)
{
runTests
(
)
;
}
else
if
(
msg
=
=
"
runNextTest
"
)
{
nextTest
(
)
;
}
else
{
browser
.
test
.
fail
(
Unexpected
message
:
{
msg
}
)
;
}
}
)
;
runTests
(
)
;
}
let
extension
=
ExtensionTestUtils
.
loadExtension
(
{
manifest
:
options
.
manifest
files
:
options
.
files
|
|
{
}
background
:
(
{
background
}
)
(
{
options
.
getTests
}
)
}
)
;
let
pageActionId
;
let
currentWindow
=
window
;
let
windows
=
[
]
;
function
checkDetails
(
details
)
{
let
image
=
currentWindow
.
document
.
getElementById
(
pageActionId
)
;
if
(
details
=
=
null
)
{
ok
(
image
=
=
null
|
|
image
.
hidden
"
image
is
hidden
"
)
;
}
else
{
ok
(
image
"
image
exists
"
)
;
is
(
getListStyleImage
(
image
)
details
.
icon
"
icon
URL
is
correct
"
)
;
let
title
=
details
.
title
|
|
options
.
manifest
.
name
;
is
(
image
.
getAttribute
(
"
tooltiptext
"
)
title
"
image
title
is
correct
"
)
;
is
(
image
.
getAttribute
(
"
aria
-
label
"
)
title
"
image
aria
-
label
is
correct
"
)
;
}
}
let
testNewWindows
=
1
;
let
awaitFinish
=
new
Promise
(
resolve
=
>
{
extension
.
onMessage
(
"
nextTest
"
(
expecting
testsRemaining
)
=
>
{
if
(
!
pageActionId
)
{
pageActionId
=
{
makeWidgetId
(
extension
.
id
)
}
-
page
-
action
;
}
checkDetails
(
expecting
)
;
if
(
testsRemaining
)
{
extension
.
sendMessage
(
"
runNextTest
"
)
;
}
else
if
(
testNewWindows
)
{
testNewWindows
-
-
;
BrowserTestUtils
.
openNewBrowserWindow
(
)
.
then
(
window
=
>
{
windows
.
push
(
window
)
;
currentWindow
=
window
;
return
focusWindow
(
window
)
;
}
)
.
then
(
(
)
=
>
{
extension
.
sendMessage
(
"
runTests
"
)
;
}
)
;
}
else
{
resolve
(
)
;
}
}
)
;
}
)
;
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
general
.
useragent
.
locale
"
"
es
-
ES
"
]
]
}
)
;
yield
extension
.
startup
(
)
;
yield
awaitFinish
;
yield
extension
.
unload
(
)
;
yield
SpecialPowers
.
popPrefEnv
(
)
;
let
node
=
document
.
getElementById
(
pageActionId
)
;
is
(
node
null
"
pageAction
image
removed
from
document
"
)
;
currentWindow
=
null
;
for
(
let
win
of
windows
.
splice
(
0
)
)
{
node
=
win
.
document
.
getElementById
(
pageActionId
)
;
is
(
node
null
"
pageAction
image
removed
from
second
document
"
)
;
yield
BrowserTestUtils
.
closeWindow
(
win
)
;
}
}
