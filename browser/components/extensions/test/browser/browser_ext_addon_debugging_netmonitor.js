"
use
strict
"
;
ChromeUtils
.
defineModuleGetter
(
this
"
BrowserToolboxProcess
"
"
resource
:
/
/
devtools
/
client
/
framework
/
ToolboxProcess
.
jsm
"
)
;
async
function
setupToolboxProcessTest
(
toolboxProcessScript
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
devtools
.
chrome
.
enabled
"
true
]
[
"
devtools
.
debugger
.
remote
-
enabled
"
true
]
[
"
devtools
.
debugger
.
prompt
-
connection
"
false
]
[
"
devtools
.
browser
-
toolbox
.
allow
-
unsafe
-
script
"
true
]
]
}
)
;
let
env
=
Cc
[
"
mozilla
.
org
/
process
/
environment
;
1
"
]
.
getService
(
Ci
.
nsIEnvironment
)
;
env
.
set
(
"
MOZ_TOOLBOX_TEST_SCRIPT
"
(
{
toolboxProcessScript
}
)
(
)
;
)
;
registerCleanupFunction
(
(
)
=
>
{
env
.
set
(
"
MOZ_TOOLBOX_TEST_SCRIPT
"
"
"
)
;
}
)
;
}
add_task
(
async
function
test_addon_debugging_netmonitor_panel
(
)
{
const
EXTENSION_ID
=
"
test
-
monitor
-
panel
mozilla
"
;
function
background
(
)
{
let
expectedURL
;
window
.
doFetchHTTPRequest
=
async
function
(
urlToFetch
)
{
expectedURL
=
urlToFetch
;
await
fetch
(
urlToFetch
)
;
}
;
window
.
testNetworkRequestReceived
=
async
function
(
requests
)
{
browser
.
test
.
log
(
"
Addon
Debugging
Netmonitor
panel
collected
requests
:
"
+
JSON
.
stringify
(
requests
)
)
;
browser
.
test
.
assertEq
(
1
requests
.
length
"
Got
one
request
logged
"
)
;
browser
.
test
.
assertEq
(
"
GET
"
requests
[
0
]
.
method
"
Got
a
GET
request
"
)
;
browser
.
test
.
assertEq
(
expectedURL
requests
[
0
]
.
url
"
Got
the
expected
request
url
"
)
;
browser
.
test
.
notifyPass
(
"
netmonitor_request_logged
"
)
;
}
;
browser
.
test
.
sendMessage
(
"
ready
"
)
;
}
let
extension
=
ExtensionTestUtils
.
loadExtension
(
{
background
useAddonManager
:
"
temporary
"
manifest
:
{
permissions
:
[
"
http
:
/
/
mochi
.
test
/
"
]
applications
:
{
gecko
:
{
id
:
EXTENSION_ID
}
}
}
}
)
;
await
extension
.
startup
(
)
;
await
extension
.
awaitMessage
(
"
ready
"
)
;
const
toolboxProcessScript
=
async
function
(
)
{
async
function
waitFor
(
condition
)
{
while
(
!
condition
(
)
)
{
await
new
Promise
(
done
=
>
window
.
setTimeout
(
done
1000
)
)
;
}
}
const
console
=
await
toolbox
.
selectTool
(
"
webconsole
"
)
;
const
{
hud
}
=
console
;
const
{
jsterm
}
=
hud
;
const
netmonitor
=
await
toolbox
.
selectTool
(
"
netmonitor
"
)
;
const
expectedURL
=
"
http
:
/
/
mochi
.
test
:
8888
/
?
test_netmonitor
=
1
"
;
await
jsterm
.
execute
(
doFetchHTTPRequest
(
"
{
expectedURL
}
"
)
;
)
;
await
waitFor
(
(
)
=
>
{
return
!
netmonitor
.
panelWin
.
document
.
querySelector
(
"
.
request
-
list
-
empty
-
notice
"
)
;
}
)
;
let
{
store
}
=
netmonitor
.
panelWin
;
function
filterRequest
(
request
)
{
return
request
.
url
=
=
=
expectedURL
;
}
let
requests
;
await
waitFor
(
(
)
=
>
{
requests
=
Array
.
from
(
store
.
getState
(
)
.
requests
.
requests
.
values
(
)
)
.
filter
(
filterRequest
)
;
return
requests
.
length
>
0
;
}
)
;
await
jsterm
.
execute
(
testNetworkRequestReceived
(
{
JSON
.
stringify
(
requests
)
}
)
;
)
;
}
;
await
setupToolboxProcessTest
(
toolboxProcessScript
)
;
const
browserToolboxProcess
=
new
BrowserToolboxProcess
(
{
addonID
:
EXTENSION_ID
}
)
;
await
extension
.
awaitFinish
(
"
netmonitor_request_logged
"
)
;
let
onToolboxClose
=
browserToolboxProcess
.
once
(
"
close
"
)
;
await
browserToolboxProcess
.
close
(
)
;
await
onToolboxClose
;
info
(
"
Addon
Toolbox
closed
"
)
;
await
extension
.
unload
(
)
;
}
)
;
