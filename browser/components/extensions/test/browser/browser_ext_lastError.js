"
use
strict
"
;
function
*
sendMessage
(
options
)
{
function
background
(
options
)
{
browser
.
runtime
.
sendMessage
(
result
=
>
{
browser
.
test
.
assertEq
(
undefined
result
"
Argument
value
"
)
;
if
(
options
.
checkLastError
)
{
let
lastError
=
browser
[
options
.
checkLastError
]
.
lastError
;
browser
.
test
.
assertEq
(
"
runtime
.
sendMessage
'
s
message
argument
is
missing
"
lastError
&
&
lastError
.
message
"
lastError
value
"
)
;
}
browser
.
test
.
sendMessage
(
"
done
"
)
;
}
)
;
}
let
extension
=
ExtensionTestUtils
.
loadExtension
(
{
background
:
(
{
background
}
)
(
{
JSON
.
stringify
(
options
)
}
)
}
)
;
yield
extension
.
startup
(
)
;
yield
extension
.
awaitMessage
(
"
done
"
)
;
yield
extension
.
unload
(
)
;
}
add_task
(
async
function
testLastError
(
)
{
SimpleTest
.
waitForExplicitFinish
(
)
;
for
(
let
api
of
[
"
extension
"
"
runtime
"
]
)
{
let
waitForConsole
=
new
Promise
(
resolve
=
>
{
SimpleTest
.
monitorConsole
(
resolve
[
{
message
:
/
message
argument
is
missing
/
forbid
:
true
}
]
)
;
}
)
;
await
sendMessage
(
{
checkLastError
:
api
}
)
;
SimpleTest
.
endMonitorConsole
(
)
;
await
waitForConsole
;
}
let
waitForConsole
=
new
Promise
(
resolve
=
>
{
SimpleTest
.
monitorConsole
(
resolve
[
{
message
:
/
Unchecked
lastError
value
:
Error
:
runtime
.
sendMessage
'
s
message
argument
is
missing
/
}
]
)
;
}
)
;
await
sendMessage
(
{
}
)
;
SimpleTest
.
endMonitorConsole
(
)
;
await
waitForConsole
;
}
)
;
