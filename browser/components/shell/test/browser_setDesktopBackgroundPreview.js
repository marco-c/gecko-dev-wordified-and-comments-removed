add_task
(
async
function
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
logo
"
}
async
(
browser
)
=
>
{
const
dialogLoad
=
BrowserTestUtils
.
domWindowOpened
(
null
async
win
=
>
{
await
BrowserTestUtils
.
waitForEvent
(
win
"
load
"
)
;
Assert
.
equal
(
win
.
document
.
documentElement
.
getAttribute
(
"
windowtype
"
)
"
Shell
:
SetDesktopBackground
"
"
Opened
correct
window
"
)
;
return
true
;
}
)
;
const
image
=
content
.
document
.
images
[
0
]
;
EventUtils
.
synthesizeMouseAtCenter
(
image
{
type
:
"
contextmenu
"
}
)
;
const
menu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
menu
"
shown
"
)
;
document
.
getElementById
(
"
context
-
setDesktopBackground
"
)
.
click
(
)
;
const
menuClosed
=
BrowserTestUtils
.
waitForPopupEvent
(
menu
"
hidden
"
)
;
menu
.
hidePopup
(
)
;
const
win
=
await
dialogLoad
;
await
TestUtils
.
waitForTick
(
)
;
const
canvas
=
win
.
document
.
getElementById
(
"
screen
"
)
;
const
screenRatio
=
Math
.
floor
(
(
screen
.
width
/
screen
.
height
)
*
100
)
;
const
previewRatio
=
Math
.
floor
(
(
canvas
.
clientWidth
/
canvas
.
clientHeight
)
*
100
)
;
Assert
.
equal
(
previewRatio
screenRatio
"
Preview
'
s
aspect
ratio
matches
screen
'
s
"
)
;
win
.
close
(
)
;
await
menuClosed
;
}
)
;
}
)
;
