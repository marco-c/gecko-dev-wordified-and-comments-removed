"
use
strict
"
;
const
{
AboutWelcomeTelemetry
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
aboutwelcome
/
AboutWelcomeTelemetry
.
sys
.
mjs
"
)
;
const
{
AWToolbarButton
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
aboutwelcome
/
AWToolbarUtils
.
sys
.
mjs
"
)
;
const
TOOLBAR_PREF
=
"
browser
.
aboutwelcome
.
toolbarButtonEnabled
"
;
const
DID_SEE_FINAL_SCREEN_PREF
=
"
browser
.
aboutwelcome
.
didSeeFinalScreen
"
;
async
function
openNewTab
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
newtab
"
false
)
;
registerCleanupFunction
(
async
(
)
=
>
{
BrowserTestUtils
.
removeTab
(
tab
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
return
tab
.
linkedBrowser
;
}
async
function
assertTelemetryScalars
(
expectedScalars
)
{
let
processScalars
=
Services
.
telemetry
.
getSnapshotForKeyedScalars
(
"
main
"
true
)
?
.
parent
?
?
{
}
;
let
expectedKeys
=
Object
.
keys
(
expectedScalars
)
;
for
(
const
key
of
expectedKeys
)
{
const
expectedEvents
=
expectedScalars
[
key
]
;
const
actualEvents
=
processScalars
[
key
]
;
for
(
const
eventKey
of
Object
.
keys
(
expectedEvents
)
)
{
Assert
.
equal
(
expectedEvents
[
eventKey
]
actualEvents
[
eventKey
]
Expected
to
see
the
correct
value
for
scalar
{
eventKey
}
got
{
actualEvents
[
eventKey
]
}
)
;
}
}
}
add_task
(
async
function
test_add_and_destroy_toolbar_button
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
DID_SEE_FINAL_SCREEN_PREF
false
]
]
}
)
;
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
win
.
BrowserCommands
.
openTab
(
)
;
ok
(
win
"
browser
exists
"
)
;
await
AWToolbarButton
.
maybeAddSetupButton
(
)
;
ok
(
!
win
.
document
.
getElementById
(
"
aboutwelcome
-
button
"
)
"
Button
should
not
exist
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
TOOLBAR_PREF
true
]
]
}
)
;
await
AWToolbarButton
.
maybeAddSetupButton
(
)
;
ok
(
win
.
document
.
getElementById
(
"
aboutwelcome
-
button
"
)
"
Button
should
be
added
.
"
)
;
const
expectedScalarsCreate
=
{
"
aboutwelcome
-
button_add_na_bookmarks
-
bar_create
"
:
1
}
;
assertTelemetryScalars
(
expectedScalarsCreate
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
TOOLBAR_PREF
false
]
]
}
)
;
ok
(
!
win
.
document
.
getElementById
(
"
aboutwelcome
-
button
"
)
"
Button
should
be
removed
"
)
;
const
expectedScalarsDestroy
=
{
"
aboutwelcome
-
button_remove_bookmarks
-
bar_na_destroy
"
:
1
}
;
assertTelemetryScalars
(
expectedScalarsDestroy
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
