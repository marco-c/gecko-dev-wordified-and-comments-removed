"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
SchemaOrgPageData
"
]
;
const
{
PageDataCollector
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
pagedata
/
PageDataCollector
.
jsm
"
)
;
function
getProp
(
element
prop
)
{
const
parseUrl
=
(
urlElement
attr
)
=
>
{
if
(
!
urlElement
.
hasAttribute
(
attr
)
)
{
return
"
"
;
}
try
{
let
url
=
new
URL
(
urlElement
.
getAttribute
(
attr
)
urlElement
.
ownerDocument
.
documentURI
)
;
return
url
.
toString
(
)
;
}
catch
(
e
)
{
return
"
"
;
}
}
;
return
Array
.
from
(
element
.
querySelectorAll
(
[
itemprop
~
=
'
{
prop
}
'
]
:
not
(
[
itemscope
]
)
)
propElement
=
>
{
switch
(
propElement
.
localName
)
{
case
"
meta
"
:
return
propElement
.
getAttribute
(
"
content
"
)
?
?
"
"
;
case
"
audio
"
:
case
"
embed
"
:
case
"
iframe
"
:
case
"
img
"
:
case
"
source
"
:
case
"
track
"
:
case
"
video
"
:
return
parseUrl
(
propElement
"
src
"
)
;
case
"
object
"
:
return
parseUrl
(
propElement
"
data
"
)
;
case
"
a
"
:
case
"
area
"
:
case
"
link
"
:
return
parseUrl
(
propElement
"
href
"
)
;
case
"
data
"
:
case
"
meter
"
:
return
propElement
.
getAttribute
(
"
value
"
)
;
case
"
time
"
:
if
(
propElement
.
hasAtribute
(
"
datetime
"
)
)
{
return
propElement
.
getAttribute
(
"
datetime
"
)
;
}
return
propElement
.
textContent
;
default
:
if
(
propElement
.
hasAttribute
(
"
content
"
)
)
{
return
propElement
.
getAttribute
(
"
content
"
)
;
}
return
propElement
.
textContent
;
}
}
)
;
}
class
SchemaOrgPageData
extends
PageDataCollector
{
async
init
(
)
{
return
this
.
#
collect
(
)
;
}
#
collectProduct
(
element
)
{
return
{
gtin
:
getProp
(
element
"
gtin
"
)
[
0
]
name
:
getProp
(
element
"
name
"
)
[
0
]
image
:
getProp
(
element
"
image
"
)
[
0
]
|
|
undefined
url
:
getProp
(
element
"
url
"
)
[
0
]
|
|
undefined
price
:
getProp
(
element
"
price
"
)
[
0
]
currency
:
getProp
(
element
"
priceCurrency
"
)
[
0
]
}
;
}
#
collect
(
)
{
let
items
=
new
Map
(
)
;
let
insert
=
(
type
item
)
=
>
{
let
data
=
items
.
get
(
type
)
;
if
(
!
data
)
{
data
=
[
]
;
items
.
set
(
type
data
)
;
}
data
.
push
(
item
)
;
}
;
let
scopes
=
this
.
document
.
querySelectorAll
(
"
[
itemscope
]
[
itemtype
^
=
'
https
:
/
/
schema
.
org
/
'
]
"
)
;
for
(
let
scope
of
scopes
)
{
switch
(
scope
.
getAttribute
(
"
itemtype
"
)
)
{
case
"
https
:
/
/
schema
.
org
/
Product
"
:
insert
(
PageDataCollector
.
DATA_TYPE
.
PRODUCT
this
.
#
collectProduct
(
scope
)
)
;
break
;
}
}
return
Array
.
from
(
items
(
[
type
data
]
)
=
>
(
{
type
data
}
)
)
;
}
}
