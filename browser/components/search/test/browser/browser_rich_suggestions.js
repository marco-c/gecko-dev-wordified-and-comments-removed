const
CONFIG_DEFAULT
=
[
{
webExtension
:
{
id
:
"
basic
search
.
mozilla
.
org
"
}
urls
:
{
trending
:
{
fullPath
:
"
https
:
/
/
example
.
com
/
browser
/
browser
/
components
/
search
/
test
/
browser
/
trendingSuggestionEngine
.
sjs
?
richsuggestions
=
true
"
query
:
"
"
}
}
appliesTo
:
[
{
included
:
{
everywhere
:
true
}
}
]
default
:
"
yes
"
}
]
;
SearchTestUtils
.
init
(
this
)
;
add_setup
(
async
(
)
=
>
{
let
searchExtensions
=
getChromeDir
(
getResolvedURI
(
gTestPath
)
)
;
searchExtensions
.
append
(
"
search
-
engines
"
)
;
await
SearchTestUtils
.
useMochitestEngines
(
searchExtensions
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
suggest
.
searches
"
true
]
[
"
browser
.
urlbar
.
trending
.
featureGate
"
true
]
[
"
browser
.
urlbar
.
trending
.
requireSearchMode
"
false
]
[
"
browser
.
urlbar
.
tipShownCount
.
searchTip_persist
"
999
]
]
}
)
;
SearchTestUtils
.
useMockIdleService
(
)
;
await
SearchTestUtils
.
updateRemoteSettingsConfig
(
CONFIG_DEFAULT
)
;
registerCleanupFunction
(
async
(
)
=
>
{
let
settingsWritten
=
SearchTestUtils
.
promiseSearchNotification
(
"
write
-
settings
-
to
-
disk
-
complete
"
)
;
await
SearchTestUtils
.
updateRemoteSettingsConfig
(
)
;
await
settingsWritten
;
}
)
;
}
)
;
add_task
(
async
function
test_trending_results
(
)
{
await
check_results
(
{
featureEnabled
:
true
}
)
;
await
check_results
(
{
featureEnabled
:
false
}
)
;
}
)
;
async
function
check_results
(
{
featureEnabled
=
false
}
)
{
Services
.
telemetry
.
clearEvents
(
)
;
Services
.
telemetry
.
clearScalars
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
richSuggestions
.
featureGate
"
featureEnabled
]
]
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
"
"
waitForFocus
:
SimpleTest
.
waitForFocus
}
)
;
let
numResults
=
UrlbarTestUtils
.
getResultCount
(
window
)
;
for
(
let
i
=
0
;
i
<
numResults
;
i
+
+
)
{
let
{
result
}
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
i
)
;
Assert
.
equal
(
result
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
result
.
providerName
"
SearchSuggestions
"
)
;
Assert
.
equal
(
result
.
payload
.
engine
"
basic
"
)
;
Assert
.
equal
(
result
.
isRichSuggestion
featureEnabled
)
;
if
(
featureEnabled
)
{
Assert
.
equal
(
typeof
result
.
payload
.
description
"
string
"
)
;
Assert
.
ok
(
result
.
payload
.
icon
.
startsWith
(
"
data
:
"
)
)
;
}
}
info
(
"
Select
first
remote
search
suggestion
&
hit
Enter
.
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
{
}
window
)
;
EventUtils
.
synthesizeKey
(
"
VK_RETURN
"
{
}
window
)
;
let
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
TelemetryTestUtils
.
assertScalar
(
scalars
"
urlbar
.
engagement
"
1
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
add_task
(
async
function
test_richsuggestion_deduplication
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
richSuggestions
.
featureGate
"
true
]
]
}
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
"
test0
"
waitForFocus
:
SimpleTest
.
waitForFocus
}
)
;
let
{
result
:
heuristicResult
}
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
0
)
;
let
{
result
:
richResult
}
=
await
UrlbarTestUtils
.
getDetailsOfResultAt
(
window
1
)
;
Assert
.
equal
(
heuristicResult
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
heuristicResult
.
providerName
"
HeuristicFallback
"
)
;
Assert
.
equal
(
richResult
.
type
UrlbarUtils
.
RESULT_TYPE
.
SEARCH
)
;
Assert
.
equal
(
richResult
.
providerName
"
SearchSuggestions
"
)
;
Assert
.
equal
(
heuristicResult
.
payload
.
query
richResult
.
payload
.
lowerCaseSuggestion
)
;
await
UrlbarTestUtils
.
promisePopupClose
(
window
)
;
}
)
;
