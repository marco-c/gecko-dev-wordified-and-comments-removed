"
use
strict
"
;
const
SCALAR_SEARCHBAR
=
"
browser
.
engagement
.
navigation
.
searchbar
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
UrlbarTestUtils
:
"
resource
:
/
/
testing
-
common
/
UrlbarTestUtils
.
sys
.
mjs
"
}
)
;
let
suggestionEngine
;
function
checkHistogramResults
(
resultIndexes
expected
histogram
)
{
for
(
let
[
i
val
]
of
Object
.
entries
(
resultIndexes
.
values
)
)
{
if
(
i
=
=
expected
)
{
Assert
.
equal
(
val
1
expected
counts
should
match
for
{
histogram
}
index
{
i
}
)
;
}
else
{
Assert
.
equal
(
!
!
val
false
unexpected
counts
should
be
zero
for
{
histogram
}
index
{
i
}
)
;
}
}
}
function
clickSearchbarSuggestion
(
entryName
clickOptions
=
{
}
)
{
let
richlistbox
=
BrowserSearch
.
searchBar
.
textbox
.
popup
.
richlistbox
;
let
richlistitem
=
Array
.
prototype
.
find
.
call
(
richlistbox
.
children
item
=
>
item
.
getAttribute
(
"
ac
-
value
"
)
=
=
entryName
)
;
richlistbox
.
ensureElementIsVisible
(
richlistitem
)
;
EventUtils
.
synthesizeMouseAtCenter
(
richlistitem
clickOptions
)
;
}
add_setup
(
async
function
(
)
{
await
gCUITestUtils
.
addSearchBar
(
)
;
const
url
=
getRootDirectory
(
gTestPath
)
+
"
telemetrySearchSuggestions
.
xml
"
;
suggestionEngine
=
await
SearchTestUtils
.
installOpenSearchEngine
(
{
url
}
)
;
registerCleanupFunction
(
(
)
=
>
{
gCUITestUtils
.
removeSearchBar
(
)
;
}
)
;
await
SearchTestUtils
.
installSearchExtension
(
{
name
:
"
MozSearch
"
keyword
:
"
mozalias
"
}
{
setAsDefault
:
true
}
)
;
await
SearchTestUtils
.
installSearchExtension
(
{
name
:
"
MozSearch2
"
keyword
:
"
mozalias2
"
}
)
;
let
engineOneOff
=
Services
.
search
.
getEngineByName
(
"
MozSearch2
"
)
;
await
Services
.
search
.
moveEngine
(
engineOneOff
0
)
;
let
oldCanRecord
=
Services
.
telemetry
.
canRecordExtended
;
Services
.
telemetry
.
canRecordExtended
=
true
;
registerCleanupFunction
(
async
function
(
)
{
Services
.
telemetry
.
canRecordExtended
=
oldCanRecord
;
}
)
;
}
)
;
add_task
(
async
function
test_plainQuery
(
)
{
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
resultMethodHist
=
TelemetryTestUtils
.
getAndClearHistogram
(
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
let
search_hist
=
TelemetryTestUtils
.
getAndClearKeyedHistogram
(
"
SEARCH_COUNTS
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
Simulate
entering
a
simple
search
.
"
)
;
let
p
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
await
searchInSearchbar
(
"
simple
query
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
p
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
false
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
SCALAR_SEARCHBAR
"
search_enter
"
1
)
;
Assert
.
equal
(
Object
.
keys
(
scalars
[
SCALAR_SEARCHBAR
]
)
.
length
1
"
This
search
must
only
increment
one
entry
in
the
scalar
.
"
)
;
TelemetryTestUtils
.
assertKeyedHistogramSum
(
search_hist
"
other
-
MozSearch
.
searchbar
"
1
)
;
let
resultMethods
=
resultMethodHist
.
snapshot
(
)
;
checkHistogramResults
(
resultMethods
UrlbarTestUtils
.
SELECTED_RESULT_METHODS
.
enter
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_oneOff_enter
(
)
{
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
resultMethodHist
=
TelemetryTestUtils
.
getAndClearHistogram
(
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
let
search_hist
=
TelemetryTestUtils
.
getAndClearKeyedHistogram
(
"
SEARCH_COUNTS
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
Perform
a
one
-
off
search
using
the
first
engine
.
"
)
;
let
p
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
await
searchInSearchbar
(
"
query
"
)
;
info
(
"
Pressing
Alt
+
Down
to
highlight
the
first
one
off
engine
.
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
{
altKey
:
true
}
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
p
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
false
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
SCALAR_SEARCHBAR
"
search_oneoff
"
1
)
;
Assert
.
equal
(
Object
.
keys
(
scalars
[
SCALAR_SEARCHBAR
]
)
.
length
1
"
This
search
must
only
increment
one
entry
in
the
scalar
.
"
)
;
TelemetryTestUtils
.
assertKeyedHistogramSum
(
search_hist
"
other
-
MozSearch2
.
searchbar
"
1
)
;
let
resultMethods
=
resultMethodHist
.
snapshot
(
)
;
checkHistogramResults
(
resultMethods
UrlbarTestUtils
.
SELECTED_RESULT_METHODS
.
enter
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_oneOff_enterSelection
(
)
{
Services
.
telemetry
.
clearScalars
(
)
;
let
resultMethodHist
=
TelemetryTestUtils
.
getAndClearHistogram
(
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
let
previousEngine
=
await
Services
.
search
.
getDefault
(
)
;
await
Services
.
search
.
setDefault
(
suggestionEngine
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
Type
a
query
.
Suggestions
should
be
generated
by
the
test
engine
.
"
)
;
let
p
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
await
searchInSearchbar
(
"
query
"
)
;
info
(
"
Select
the
second
result
press
Alt
+
Down
to
take
us
to
the
first
one
-
off
engine
.
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
{
altKey
:
true
}
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
p
;
let
resultMethods
=
resultMethodHist
.
snapshot
(
)
;
checkHistogramResults
(
resultMethods
UrlbarTestUtils
.
SELECTED_RESULT_METHODS
.
enterSelection
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
await
Services
.
search
.
setDefault
(
previousEngine
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_oneOff_click
(
)
{
Services
.
telemetry
.
clearScalars
(
)
;
let
resultMethodHist
=
TelemetryTestUtils
.
getAndClearHistogram
(
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
Type
a
query
.
"
)
;
let
p
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
let
popup
=
await
searchInSearchbar
(
"
query
"
)
;
info
(
"
Click
the
first
one
-
off
button
.
"
)
;
popup
.
oneOffButtons
.
getSelectableButtons
(
false
)
[
0
]
.
click
(
)
;
await
p
;
let
resultMethods
=
resultMethodHist
.
snapshot
(
)
;
checkHistogramResults
(
resultMethods
UrlbarTestUtils
.
SELECTED_RESULT_METHODS
.
click
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
async
function
checkSuggestionClick
(
clickOptions
waitForActionFn
)
{
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
resultMethodHist
=
TelemetryTestUtils
.
getAndClearHistogram
(
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
let
search_hist
=
TelemetryTestUtils
.
getAndClearKeyedHistogram
(
"
SEARCH_COUNTS
"
)
;
let
previousEngine
=
await
Services
.
search
.
getDefault
(
)
;
await
Services
.
search
.
setDefault
(
suggestionEngine
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
Perform
a
one
-
off
search
using
the
first
engine
.
"
)
;
let
p
=
waitForActionFn
(
tab
)
;
await
searchInSearchbar
(
"
query
"
)
;
info
(
"
Clicking
the
searchbar
suggestion
.
"
)
;
clickSearchbarSuggestion
(
"
queryfoo
"
clickOptions
)
;
await
p
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
false
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
SCALAR_SEARCHBAR
"
search_suggestion
"
1
)
;
Assert
.
equal
(
Object
.
keys
(
scalars
[
SCALAR_SEARCHBAR
]
)
.
length
1
"
This
search
must
only
increment
one
entry
in
the
scalar
.
"
)
;
let
searchEngineId
=
"
other
-
"
+
suggestionEngine
.
name
;
TelemetryTestUtils
.
assertKeyedHistogramSum
(
search_hist
searchEngineId
+
"
.
searchbar
"
1
)
;
let
resultMethods
=
resultMethodHist
.
snapshot
(
)
;
checkHistogramResults
(
resultMethods
UrlbarTestUtils
.
SELECTED_RESULT_METHODS
.
click
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
await
Services
.
search
.
setDefault
(
previousEngine
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
add_task
(
async
function
test_suggestion_click
(
)
{
await
checkSuggestionClick
(
{
}
tab
=
>
{
return
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
}
)
;
}
)
;
add_task
(
async
function
test_suggestion_middle_click
(
)
{
let
openedTab
;
await
checkSuggestionClick
(
{
button
:
1
}
(
)
=
>
{
return
BrowserTestUtils
.
waitForNewTab
(
gBrowser
"
http
:
/
/
example
.
com
/
"
)
.
then
(
tab
=
>
(
openedTab
=
tab
)
)
;
}
)
;
BrowserTestUtils
.
removeTab
(
openedTab
)
;
}
)
;
add_task
(
async
function
test_suggestion_enterSelection
(
)
{
Services
.
telemetry
.
clearScalars
(
)
;
let
resultMethodHist
=
TelemetryTestUtils
.
getAndClearHistogram
(
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
let
previousEngine
=
await
Services
.
search
.
getDefault
(
)
;
await
Services
.
search
.
setDefault
(
suggestionEngine
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
Type
a
query
.
Suggestions
should
be
generated
by
the
test
engine
.
"
)
;
let
p
=
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
;
await
searchInSearchbar
(
"
query
"
)
;
info
(
"
Select
the
second
result
and
press
Return
.
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
p
;
let
resultMethods
=
resultMethodHist
.
snapshot
(
)
;
checkHistogramResults
(
resultMethods
UrlbarTestUtils
.
SELECTED_RESULT_METHODS
.
enterSelection
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
await
Services
.
search
.
setDefault
(
previousEngine
Ci
.
nsISearchService
.
CHANGE_REASON_UNKNOWN
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
