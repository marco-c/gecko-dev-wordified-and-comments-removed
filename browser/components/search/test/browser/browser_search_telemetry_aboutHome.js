"
use
strict
"
;
const
SCALAR_ABOUT_HOME
=
"
browser
.
engagement
.
navigation
.
about_home
"
;
add_task
(
async
function
setup
(
)
{
ignoreAllUncaughtExceptions
(
)
;
await
Services
.
search
.
addEngineWithDetails
(
"
MozSearch
"
{
alias
:
"
mozalias
"
method
:
"
GET
"
template
:
"
http
:
/
/
example
.
com
/
?
q
=
{
searchTerms
}
"
}
)
;
await
Services
.
search
.
addEngineWithDetails
(
"
MozSearch2
"
{
alias
:
"
mozalias2
"
method
:
"
GET
"
template
:
"
http
:
/
/
example
.
com
/
?
q
=
{
searchTerms
}
"
}
)
;
let
engineDefault
=
Services
.
search
.
getEngineByName
(
"
MozSearch
"
)
;
let
originalEngine
=
await
Services
.
search
.
getDefault
(
)
;
await
Services
.
search
.
setDefault
(
engineDefault
)
;
let
engineOneOff
=
Services
.
search
.
getEngineByName
(
"
MozSearch2
"
)
;
await
Services
.
search
.
moveEngine
(
engineOneOff
0
)
;
let
oldCanRecord
=
Services
.
telemetry
.
canRecordExtended
;
Services
.
telemetry
.
canRecordExtended
=
true
;
Services
.
telemetry
.
setEventRecordingEnabled
(
"
navigation
"
true
)
;
registerCleanupFunction
(
async
function
(
)
{
await
Services
.
search
.
setDefault
(
originalEngine
)
;
await
Services
.
search
.
removeEngine
(
engineDefault
)
;
await
Services
.
search
.
removeEngine
(
engineOneOff
)
;
await
PlacesUtils
.
history
.
clear
(
)
;
Services
.
telemetry
.
setEventRecordingEnabled
(
"
navigation
"
false
)
;
Services
.
telemetry
.
canRecordExtended
=
oldCanRecord
;
}
)
;
}
)
;
add_task
(
async
function
test_abouthome_activitystream_simpleQuery
(
)
{
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
let
search_hist
=
TelemetryTestUtils
.
getAndClearKeyedHistogram
(
"
SEARCH_COUNTS
"
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
info
(
"
Load
about
:
home
.
"
)
;
BrowserTestUtils
.
loadURI
(
tab
.
linkedBrowser
"
about
:
home
"
)
;
await
BrowserTestUtils
.
browserStopped
(
tab
.
linkedBrowser
"
about
:
home
"
)
;
info
(
"
Wait
for
ContentSearchUI
search
provider
to
initialize
.
"
)
;
await
SpecialPowers
.
spawn
(
tab
.
linkedBrowser
[
]
async
function
(
)
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
wrappedJSObject
.
gContentSearchController
.
defaultEngine
)
;
}
)
;
info
(
"
Trigger
a
simple
search
just
test
+
enter
.
"
)
;
let
p
=
BrowserTestUtils
.
browserStopped
(
tab
.
linkedBrowser
"
http
:
/
/
example
.
com
/
?
q
=
test
+
query
"
)
;
await
typeInSearchField
(
tab
.
linkedBrowser
"
test
query
"
"
newtab
-
search
-
text
"
)
;
await
BrowserTestUtils
.
synthesizeKey
(
"
VK_RETURN
"
{
}
tab
.
linkedBrowser
)
;
await
p
;
const
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
false
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
scalars
SCALAR_ABOUT_HOME
"
search_enter
"
1
)
;
Assert
.
equal
(
Object
.
keys
(
scalars
[
SCALAR_ABOUT_HOME
]
)
.
length
1
"
This
search
must
only
increment
one
entry
in
the
scalar
.
"
)
;
TelemetryTestUtils
.
assertKeyedHistogramSum
(
search_hist
"
other
-
MozSearch
.
abouthome
"
1
)
;
TelemetryTestUtils
.
assertEvents
(
[
{
object
:
"
about_home
"
value
:
"
enter
"
extra
:
{
engine
:
"
other
-
MozSearch
"
}
}
]
{
category
:
"
navigation
"
method
:
"
search
"
}
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
