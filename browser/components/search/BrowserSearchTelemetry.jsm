"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
BrowserSearchTelemetry
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
lazy
=
{
}
;
XPCOMUtils
.
defineLazyModuleGetters
(
lazy
{
PartnerLinkAttribution
:
"
resource
:
/
/
/
modules
/
PartnerLinkAttribution
.
jsm
"
PrivateBrowsingUtils
:
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
SearchSERPTelemetry
:
"
resource
:
/
/
/
modules
/
SearchSERPTelemetry
.
jsm
"
UrlbarSearchUtils
:
"
resource
:
/
/
/
modules
/
UrlbarSearchUtils
.
jsm
"
}
)
;
const
KNOWN_SEARCH_SOURCES
=
new
Map
(
[
[
"
abouthome
"
"
about_home
"
]
[
"
contextmenu
"
"
contextmenu
"
]
[
"
newtab
"
"
about_newtab
"
]
[
"
searchbar
"
"
searchbar
"
]
[
"
system
"
"
system
"
]
[
"
urlbar
"
"
urlbar
"
]
[
"
urlbar
-
handoff
"
"
urlbar_handoff
"
]
[
"
urlbar
-
searchmode
"
"
urlbar_searchmode
"
]
[
"
webextension
"
"
webextension
"
]
]
)
;
class
BrowserSearchTelemetryHandler
{
KNOWN_SEARCH_SOURCES
=
KNOWN_SEARCH_SOURCES
;
shouldRecordSearchCount
(
browser
)
{
return
(
!
lazy
.
PrivateBrowsingUtils
.
isWindowPrivate
(
browser
.
ownerGlobal
)
|
|
!
Services
.
prefs
.
getBoolPref
(
"
browser
.
engagement
.
search_counts
.
pbm
"
false
)
)
;
}
recordSearchSuggestionSelectionMethod
(
event
source
index
userSelectionBehavior
=
"
none
"
)
{
if
(
source
=
=
"
searchbar
"
&
&
userSelectionBehavior
!
=
"
none
"
)
{
throw
new
Error
(
"
Did
not
expect
a
selection
behavior
for
the
searchbar
.
"
)
;
}
let
histogram
=
Services
.
telemetry
.
getHistogramById
(
source
=
=
"
urlbar
"
?
"
FX_URLBAR_SELECTED_RESULT_METHOD
"
:
"
FX_SEARCHBAR_SELECTED_RESULT_METHOD
"
)
;
let
isClick
=
event
&
&
(
ChromeUtils
.
getClassName
(
event
)
=
=
"
MouseEvent
"
|
|
event
.
type
=
=
"
command
"
)
;
let
category
;
if
(
isClick
)
{
category
=
"
click
"
;
}
else
if
(
index
>
=
0
)
{
switch
(
userSelectionBehavior
)
{
case
"
tab
"
:
category
=
"
tabEnterSelection
"
;
break
;
case
"
arrow
"
:
category
=
"
arrowEnterSelection
"
;
break
;
case
"
rightClick
"
:
category
=
"
rightClickEnter
"
;
break
;
default
:
category
=
"
enterSelection
"
;
}
}
else
{
category
=
"
enter
"
;
}
histogram
.
add
(
category
)
;
}
recordSearchMode
(
searchMode
)
{
if
(
searchMode
.
isPreview
)
{
return
;
}
let
scalarKey
=
lazy
.
UrlbarSearchUtils
.
getSearchModeScalarKey
(
searchMode
)
;
Services
.
telemetry
.
keyedScalarAdd
(
"
urlbar
.
searchmode
.
"
+
searchMode
.
entry
scalarKey
1
)
;
}
recordSearch
(
browser
engine
source
details
=
{
}
)
{
try
{
if
(
!
this
.
shouldRecordSearchCount
(
browser
)
)
{
return
;
}
if
(
!
KNOWN_SEARCH_SOURCES
.
has
(
source
)
)
{
console
.
error
(
"
Unknown
source
for
search
:
"
source
)
;
return
;
}
const
countIdPrefix
=
{
engine
.
telemetryId
}
.
;
const
countIdSource
=
countIdPrefix
+
source
;
let
histogram
=
Services
.
telemetry
.
getKeyedHistogramById
(
"
SEARCH_COUNTS
"
)
;
if
(
details
.
alias
&
&
engine
.
isAppProvided
&
&
engine
.
aliases
.
includes
(
details
.
alias
)
)
{
histogram
.
add
(
countIdPrefix
+
"
alias
"
)
;
}
else
{
histogram
.
add
(
countIdSource
)
;
}
switch
(
source
)
{
case
"
urlbar
"
:
case
"
searchbar
"
:
case
"
urlbar
-
searchmode
"
:
case
"
urlbar
-
handoff
"
:
this
.
_handleSearchAndUrlbar
(
browser
engine
source
details
)
;
break
;
case
"
abouthome
"
:
case
"
newtab
"
:
this
.
_recordSearch
(
browser
engine
details
.
url
source
"
enter
"
)
;
break
;
default
:
this
.
_recordSearch
(
browser
engine
details
.
url
source
)
;
break
;
}
}
catch
(
ex
)
{
console
.
error
(
ex
)
;
}
}
_handleSearchAndUrlbar
(
browser
engine
source
details
)
{
const
isOneOff
=
!
!
details
.
isOneOff
;
let
action
=
"
enter
"
;
if
(
isOneOff
)
{
action
=
"
oneoff
"
;
}
else
if
(
details
.
isFormHistory
)
{
action
=
"
formhistory
"
;
}
else
if
(
details
.
isSuggestion
)
{
action
=
"
suggestion
"
;
}
else
if
(
details
.
alias
)
{
action
=
"
alias
"
;
}
this
.
_recordSearch
(
browser
engine
details
.
url
source
action
)
;
}
_recordSearch
(
browser
engine
url
source
action
=
null
)
{
if
(
url
)
{
lazy
.
PartnerLinkAttribution
.
makeSearchEngineRequest
(
engine
url
)
.
catch
(
Cu
.
reportError
)
;
}
let
scalarSource
=
KNOWN_SEARCH_SOURCES
.
get
(
source
)
;
lazy
.
SearchSERPTelemetry
.
recordBrowserSource
(
browser
scalarSource
)
;
let
scalarKey
=
action
?
"
search_
"
+
action
:
"
search
"
;
Services
.
telemetry
.
keyedScalarAdd
(
"
browser
.
engagement
.
navigation
.
"
+
scalarSource
scalarKey
1
)
;
Services
.
telemetry
.
recordEvent
(
"
navigation
"
"
search
"
scalarSource
action
{
engine
:
engine
.
telemetryId
}
)
;
}
}
var
BrowserSearchTelemetry
=
new
BrowserSearchTelemetryHandler
(
)
;
