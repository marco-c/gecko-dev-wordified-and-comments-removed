"
use
strict
"
;
const
BOOKMARKS_H2_2020_PREF
=
"
browser
.
toolbars
.
bookmarks
.
2h2020
"
;
const
bookmarksInfo
=
[
{
title
:
"
firefox
"
url
:
"
http
:
/
/
example
.
com
"
}
{
title
:
"
rules
"
url
:
"
http
:
/
/
example
.
com
/
2
"
}
{
title
:
"
yo
"
url
:
"
http
:
/
/
example
.
com
/
2
"
}
]
;
add_task
(
async
function
setup
(
)
{
let
toolbar
=
document
.
getElementById
(
"
PersonalToolbar
"
)
;
let
wasCollapsed
=
toolbar
.
collapsed
;
if
(
wasCollapsed
)
{
await
promiseSetToolbarVisibility
(
toolbar
true
)
;
}
registerCleanupFunction
(
async
(
)
=
>
{
if
(
wasCollapsed
)
{
await
promiseSetToolbarVisibility
(
toolbar
false
)
;
}
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
}
)
;
}
)
;
add_task
(
async
function
testShowingOtherBookmarksInToolbar
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
BOOKMARKS_H2_2020_PREF
true
]
]
}
)
;
info
(
"
Check
visibility
of
an
empty
Other
Bookmarks
folder
.
"
)
;
testIsOtherBookmarksHidden
(
true
)
;
info
(
"
Ensure
folder
appears
in
toolbar
when
a
new
bookmark
is
added
.
"
)
;
let
bookmarks
=
await
PlacesUtils
.
bookmarks
.
insertTree
(
{
guid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
children
:
bookmarksInfo
}
)
;
testIsOtherBookmarksHidden
(
false
)
;
info
(
"
Ensure
folder
disappears
from
toolbar
when
no
bookmarks
are
present
.
"
)
;
await
PlacesUtils
.
bookmarks
.
remove
(
bookmarks
)
;
testIsOtherBookmarksHidden
(
true
)
;
}
)
;
add_task
(
async
function
testOtherBookmarksVisibilityWhenMovingBookmarks
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
BOOKMARKS_H2_2020_PREF
true
]
]
}
)
;
info
(
"
Add
bookmarks
to
Bookmarks
Toolbar
.
"
)
;
let
bookmarks
=
await
PlacesUtils
.
bookmarks
.
insertTree
(
{
guid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
children
:
bookmarksInfo
}
)
;
testIsOtherBookmarksHidden
(
true
)
;
info
(
"
Move
toolbar
bookmarks
to
Other
Bookmarks
folder
.
"
)
;
await
PlacesUtils
.
bookmarks
.
moveToFolder
(
bookmarks
.
map
(
b
=
>
b
.
guid
)
PlacesUtils
.
bookmarks
.
unfiledGuid
PlacesUtils
.
bookmarks
.
DEFAULT_INDEX
)
;
testIsOtherBookmarksHidden
(
false
)
;
info
(
"
Move
bookmarks
from
Other
Bookmarks
back
to
the
toolbar
.
"
)
;
await
PlacesUtils
.
bookmarks
.
moveToFolder
(
bookmarks
.
map
(
b
=
>
b
.
guid
)
PlacesUtils
.
bookmarks
.
toolbarGuid
PlacesUtils
.
bookmarks
.
DEFAULT_INDEX
)
;
testIsOtherBookmarksHidden
(
true
)
;
}
)
;
add_task
(
async
function
testOtherBookmarksMenuPopup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
BOOKMARKS_H2_2020_PREF
true
]
]
}
)
;
info
(
"
Add
bookmarks
to
Other
Bookmarks
folder
.
"
)
;
let
bookmarks
=
await
PlacesUtils
.
bookmarks
.
insertTree
(
{
guid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
children
:
bookmarksInfo
}
)
;
testIsOtherBookmarksHidden
(
false
)
;
info
(
"
Check
the
popup
menu
has
correct
number
of
children
.
"
)
;
await
openMenuPopup
(
"
#
OtherBookmarksPopup
"
"
#
OtherBookmarks
"
)
;
testNumberOfMenuPopupChildren
(
"
#
OtherBookmarksPopup
"
3
)
;
await
closeMenuPopup
(
"
#
OtherBookmarksPopup
"
)
;
info
(
"
Remove
a
bookmark
.
"
)
;
await
PlacesUtils
.
bookmarks
.
remove
(
bookmarks
[
0
]
)
;
await
openMenuPopup
(
"
#
OtherBookmarksPopup
"
"
#
OtherBookmarks
"
)
;
testNumberOfMenuPopupChildren
(
"
#
OtherBookmarksPopup
"
2
)
;
await
closeMenuPopup
(
"
#
OtherBookmarksPopup
"
)
;
}
)
;
add_task
(
async
function
testFolderPopup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
BOOKMARKS_H2_2020_PREF
true
]
]
}
)
;
await
PlacesUtils
.
bookmarks
.
insertTree
(
{
guid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
children
:
[
{
title
:
"
folder
"
type
:
PlacesUtils
.
bookmarks
.
TYPE_FOLDER
children
:
[
{
title
:
"
example
"
url
:
"
http
:
/
/
example
.
com
/
3
"
}
]
}
]
}
)
;
info
(
"
Check
for
popup
showing
event
when
folder
menuitem
is
selected
.
"
)
;
await
openMenuPopup
(
"
#
OtherBookmarksPopup
"
"
#
OtherBookmarks
"
)
;
await
openMenuPopup
(
"
#
OtherBookmarksPopup
menu
menupopup
"
"
#
OtherBookmarksPopup
menu
"
)
;
ok
(
true
"
Folder
menu
stored
in
Other
Bookmarks
expands
.
"
)
;
testNumberOfMenuPopupChildren
(
"
#
OtherBookmarksPopup
menu
menupopup
"
1
)
;
await
closeMenuPopup
(
"
#
OtherBookmarksPopup
"
)
;
}
)
;
add_task
(
async
function
testOnlyShowOtherFolderInBookmarksToolbar
(
)
{
testIsOtherBookmarksHidden
(
false
)
;
let
widgetId
=
"
personal
-
bookmarks
"
;
CustomizableUI
.
addWidgetToArea
(
widgetId
CustomizableUI
.
AREA_NAVBAR
)
;
testIsOtherBookmarksHidden
(
true
)
;
CustomizableUI
.
reset
(
)
;
testIsOtherBookmarksHidden
(
false
)
;
}
)
;
add_task
(
async
function
testDeletingMenuItems
(
)
{
let
toolbar
=
document
.
getElementById
(
"
PersonalToolbar
"
)
;
let
wasCollapsed
=
toolbar
.
collapsed
;
if
(
wasCollapsed
)
{
await
promiseSetToolbarVisibility
(
toolbar
true
)
;
}
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
BOOKMARKS_H2_2020_PREF
true
]
]
}
)
;
await
PlacesUtils
.
bookmarks
.
insertTree
(
{
guid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
children
:
bookmarksInfo
}
)
;
await
openMenuPopup
(
"
#
OtherBookmarksPopup
"
"
#
OtherBookmarks
"
)
;
testNumberOfMenuPopupChildren
(
"
#
OtherBookmarksPopup
"
3
)
;
info
(
"
Open
context
menu
for
popup
.
"
)
;
let
placesContext
=
document
.
getElementById
(
"
placesContext
"
)
;
let
popupEventPromise
=
BrowserTestUtils
.
waitForPopupEvent
(
placesContext
"
shown
"
)
;
let
menuitem
=
document
.
querySelector
(
"
#
OtherBookmarksPopup
menuitem
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
menuitem
{
type
:
"
contextmenu
"
}
)
;
await
popupEventPromise
;
info
(
"
Delete
bookmark
menu
item
from
popup
.
"
)
;
let
deleteMenuItem
=
document
.
getElementById
(
"
placesContext_delete
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
deleteMenuItem
{
}
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
let
popup
=
document
.
querySelector
(
"
#
OtherBookmarksPopup
"
)
;
let
items
=
popup
.
querySelectorAll
(
"
menuitem
"
)
;
return
items
.
length
=
=
=
2
;
}
"
Failed
to
delete
bookmark
menuitem
.
Expected
2
menu
items
after
deletion
.
"
)
;
ok
(
true
"
Menu
item
was
removed
from
the
popup
.
"
)
;
await
closeMenuPopup
(
"
#
OtherBookmarksPopup
"
)
;
}
)
;
async
function
testIsOtherBookmarksHidden
(
expected
)
{
info
(
"
Test
whether
or
not
the
'
Other
Bookmarks
'
folder
is
visible
.
"
)
;
let
otherBookmarks
=
document
.
getElementById
(
"
OtherBookmarks
"
)
;
await
BrowserTestUtils
.
waitForAttribute
(
"
hidden
"
otherBookmarks
expected
)
;
ok
(
true
Other
Bookmarks
folder
"
hidden
"
state
should
be
{
expected
}
.
)
;
}
function
testNumberOfMenuPopupChildren
(
selector
expected
)
{
let
popup
=
document
.
querySelector
(
selector
)
;
let
items
=
popup
.
querySelectorAll
(
"
menuitem
"
)
;
is
(
items
.
length
expected
Number
of
menu
items
for
{
selector
}
should
be
{
expected
}
.
)
;
}
async
function
openMenuPopup
(
popupSelector
targetSelector
)
{
let
popup
=
document
.
querySelector
(
popupSelector
)
;
let
target
=
document
.
querySelector
(
targetSelector
)
;
EventUtils
.
synthesizeMouseAtCenter
(
target
{
}
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
popup
"
shown
"
)
;
}
async
function
closeMenuPopup
(
popupSelector
)
{
let
popup
=
document
.
querySelector
(
popupSelector
)
;
info
(
"
Closing
menu
popup
.
"
)
;
popup
.
hidePopup
(
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
popup
"
hidden
"
)
;
}
