"
use
strict
"
;
let
win
;
async
function
checkTagsSelector
(
aAvailableTags
aCheckedTags
)
{
let
tags
=
await
PlacesUtils
.
bookmarks
.
fetchTags
(
)
;
is
(
tags
.
length
aAvailableTags
.
length
"
Check
tags
list
"
)
;
let
tagsSelector
=
win
.
document
.
getElementById
(
"
editBMPanel_tagsSelector
"
)
;
let
children
=
tagsSelector
.
children
;
is
(
children
.
length
aAvailableTags
.
length
"
Found
expected
number
of
tags
in
the
tags
selector
"
)
;
Array
.
prototype
.
forEach
.
call
(
children
function
(
aChild
)
{
let
tag
=
aChild
.
querySelector
(
"
label
"
)
.
getAttribute
(
"
value
"
)
;
ok
(
true
"
Found
tag
'
"
+
tag
+
"
'
in
the
selector
"
)
;
ok
(
aAvailableTags
.
includes
(
tag
)
"
Found
expected
tag
"
)
;
let
checked
=
aChild
.
getAttribute
(
"
checked
"
)
=
=
"
true
"
;
is
(
checked
aCheckedTags
.
includes
(
tag
)
"
Tag
is
correctly
marked
"
)
;
}
)
;
}
async
function
promiseTagSelectorUpdated
(
task
)
{
let
tagsSelector
=
win
.
document
.
getElementById
(
"
editBMPanel_tagsSelector
"
)
;
let
promise
=
BrowserTestUtils
.
waitForEvent
(
tagsSelector
"
BookmarkTagsSelectorUpdated
"
)
;
await
task
(
)
;
return
promise
;
}
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
bookmarks
.
editDialog
.
delayedApply
.
enabled
"
false
]
]
}
)
;
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
registerCleanupFunction
(
async
(
)
=
>
{
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
}
)
;
add_task
(
async
function
(
)
{
const
TEST_URI
=
Services
.
io
.
newURI
(
"
http
:
/
/
www
.
test
.
me
/
"
)
;
const
TEST_URI2
=
Services
.
io
.
newURI
(
"
http
:
/
/
www
.
test
.
again
.
me
/
"
)
;
const
TEST_TAG
=
"
test
-
tag
"
;
ok
(
win
.
gEditItemOverlay
"
Sanity
check
:
gEditItemOverlay
is
in
context
"
)
;
win
.
StarUI
.
_createPanelIfNeeded
(
)
;
win
.
document
.
getElementById
(
"
editBMPanel_tagsSelectorRow
"
)
.
hidden
=
false
;
let
bm
=
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
index
:
PlacesUtils
.
bookmarks
.
DEFAULT_INDEX
type
:
PlacesUtils
.
bookmarks
.
TYPE_BOOKMARK
url
:
TEST_URI
.
spec
title
:
"
test
.
me
"
}
)
;
let
node
=
await
PlacesUIUtils
.
promiseNodeLikeFromFetchInfo
(
bm
)
;
await
win
.
gEditItemOverlay
.
initPanel
(
{
node
}
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
tagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
TEST_TAG
"
Correctly
added
tag
to
a
single
bookmark
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
TEST_TAG
"
Editing
a
single
bookmark
shows
the
added
tag
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
TEST_TAG
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
untagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
undefined
"
The
tag
has
been
removed
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
a
single
bookmark
should
not
show
any
tag
"
)
;
await
checkTagsSelector
(
[
]
[
]
)
;
let
bm2
=
await
PlacesUtils
.
bookmarks
.
insert
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
index
:
PlacesUtils
.
bookmarks
.
DEFAULT_INDEX
type
:
PlacesUtils
.
bookmarks
.
TYPE_BOOKMARK
title
:
"
test
.
again
.
me
"
url
:
TEST_URI2
.
spec
}
)
;
await
win
.
gEditItemOverlay
.
initPanel
(
{
uris
:
[
TEST_URI
TEST_URI2
]
}
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
tagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
TEST_TAG
"
Correctly
added
a
tag
to
the
first
bookmark
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
multiple
bookmarks
without
matching
tags
should
not
show
any
tag
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
tagURI
(
TEST_URI2
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI2
)
[
0
]
TEST_TAG
"
Correctly
added
a
tag
to
the
second
bookmark
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
TEST_TAG
"
Editing
multiple
bookmarks
should
show
matching
tags
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
TEST_TAG
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
untagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
undefined
"
Correctly
removed
tag
from
the
first
bookmark
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
multiple
bookmarks
without
matching
tags
should
not
show
any
tag
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
untagURI
(
TEST_URI2
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI2
)
[
0
]
undefined
"
Correctly
removed
tag
from
the
second
bookmark
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
multiple
bookmarks
without
matching
tags
should
not
show
any
tag
.
"
)
;
await
checkTagsSelector
(
[
]
[
]
)
;
await
win
.
gEditItemOverlay
.
initPanel
(
{
uris
:
[
TEST_URI
]
}
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
tagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
TEST_TAG
"
Correctly
added
tag
to
the
first
entry
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
TEST_TAG
"
Editing
a
single
nsIURI
entry
shows
the
added
tag
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
TEST_TAG
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
untagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
undefined
"
Correctly
removed
tag
from
the
nsIURI
entry
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
a
single
nsIURI
entry
should
not
show
any
tag
.
"
)
;
await
checkTagsSelector
(
[
]
[
]
)
;
await
win
.
gEditItemOverlay
.
initPanel
(
{
uris
:
[
TEST_URI
TEST_URI2
]
}
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
tagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
TEST_TAG
"
Tag
correctly
added
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
multiple
nsIURIs
without
matching
tags
should
not
show
any
tag
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
tagURI
(
TEST_URI2
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI2
)
[
0
]
TEST_TAG
"
Tag
correctly
added
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
TEST_TAG
"
Editing
multiple
nsIURIs
should
show
matching
tags
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
TEST_TAG
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
untagURI
(
TEST_URI
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI
)
[
0
]
undefined
"
Correctly
removed
tag
from
the
first
entry
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
multiple
nsIURIs
without
matching
tags
should
not
show
any
tag
.
"
)
;
await
checkTagsSelector
(
[
TEST_TAG
]
[
]
)
;
await
promiseTagSelectorUpdated
(
(
)
=
>
PlacesUtils
.
tagging
.
untagURI
(
TEST_URI2
[
TEST_TAG
]
)
)
;
is
(
PlacesUtils
.
tagging
.
getTagsForURI
(
TEST_URI2
)
[
0
]
undefined
"
Correctly
removed
tag
from
the
second
entry
.
"
)
;
Assert
.
equal
(
win
.
document
.
getElementById
(
"
editBMPanel_tagsField
"
)
.
value
"
"
"
Editing
multiple
nsIURIs
without
matching
tags
should
not
show
any
tag
.
"
)
;
await
checkTagsSelector
(
[
]
[
]
)
;
await
PlacesUtils
.
bookmarks
.
remove
(
bm
.
guid
)
;
await
PlacesUtils
.
bookmarks
.
remove
(
bm2
.
guid
)
;
}
)
;
