const
PREF_IMPORT_BOOKMARKS_HTML
=
"
browser
.
places
.
importBookmarksHTML
"
;
const
PREF_RESTORE_DEFAULT_BOOKMARKS
=
"
browser
.
bookmarks
.
restore_default_bookmarks
"
;
const
PREF_SMART_BOOKMARKS_VERSION
=
"
browser
.
places
.
smartBookmarksVersion
"
;
const
PREF_AUTO_EXPORT_HTML
=
"
browser
.
bookmarks
.
autoExportHTML
"
;
const
TOPIC_BROWSERGLUE_TEST
=
"
browser
-
glue
-
test
"
;
const
TOPICDATA_FORCE_PLACES_INIT
=
"
force
-
places
-
init
"
;
var
bg
=
Cc
[
"
mozilla
.
org
/
browser
/
browserglue
;
1
"
]
.
getService
(
Ci
.
nsIObserver
)
;
add_task
(
async
function
setup
(
)
{
create_bookmarks_html
(
"
bookmarks
.
glue
.
html
"
)
;
remove_all_JSON_backups
(
)
;
create_JSON_backup
(
"
bookmarks
.
glue
.
json
"
)
;
registerCleanupFunction
(
function
(
)
{
remove_bookmarks_html
(
)
;
remove_all_JSON_backups
(
)
;
return
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
}
)
;
}
)
;
function
simulatePlacesInit
(
)
{
info
(
"
Simulate
Places
init
"
)
;
bg
.
observe
(
null
TOPIC_BROWSERGLUE_TEST
TOPICDATA_FORCE_PLACES_INIT
)
;
return
promiseTopicObserved
(
"
places
-
browser
-
init
-
complete
"
)
;
}
add_task
(
async
function
test_checkPreferences
(
)
{
let
promiseComplete
=
promiseTopicObserved
(
"
places
-
browser
-
init
-
complete
"
)
;
Assert
.
equal
(
PlacesUtils
.
history
.
databaseStatus
PlacesUtils
.
history
.
DATABASE_STATUS_CREATE
)
;
await
promiseComplete
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_AUTO_EXPORT_HTML
)
)
;
Assert
.
throws
(
(
)
=
>
Services
.
prefs
.
getBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
)
/
NS_ERROR_UNEXPECTED
/
)
;
Assert
.
throws
(
(
)
=
>
Services
.
prefs
.
getBoolPref
(
PREF_RESTORE_DEFAULT_BOOKMARKS
)
/
NS_ERROR_UNEXPECTED
/
)
;
}
)
;
add_task
(
async
function
test_import
(
)
{
info
(
"
Import
from
bookmarks
.
html
if
importBookmarksHTML
is
true
.
"
)
;
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
Assert
.
ok
(
!
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
)
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
true
)
;
await
simulatePlacesInit
(
)
;
let
bm
=
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
SMART_BOOKMARKS_ON_TOOLBAR
}
)
;
Assert
.
equal
(
bm
.
title
"
example
"
)
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
)
)
;
}
)
;
add_task
(
async
function
test_import_noSmartBookmarks
(
)
{
info
(
"
import
from
bookmarks
.
html
but
don
'
t
create
smart
bookmarks
"
+
"
if
they
are
disabled
"
)
;
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
Assert
.
ok
(
!
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
)
)
;
Services
.
prefs
.
setIntPref
(
PREF_SMART_BOOKMARKS_VERSION
-
1
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
true
)
;
await
simulatePlacesInit
(
)
;
let
bm
=
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
;
Assert
.
equal
(
bm
.
title
"
example
"
)
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
)
)
;
}
)
;
add_task
(
async
function
test_import_autoExport_updatedSmartBookmarks
(
)
{
info
(
"
Import
from
bookmarks
.
html
but
don
'
t
create
smart
bookmarks
"
+
"
if
autoExportHTML
is
true
and
they
are
at
latest
version
"
)
;
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
Assert
.
ok
(
!
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
)
)
;
Services
.
prefs
.
setIntPref
(
PREF_SMART_BOOKMARKS_VERSION
999
)
;
Services
.
prefs
.
setBoolPref
(
PREF_AUTO_EXPORT_HTML
true
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
true
)
;
await
simulatePlacesInit
(
)
;
let
bm
=
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
;
Assert
.
equal
(
bm
.
title
"
example
"
)
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
)
)
;
Services
.
prefs
.
setBoolPref
(
PREF_AUTO_EXPORT_HTML
false
)
;
}
)
;
add_task
(
async
function
test_import_autoExport_oldSmartBookmarks
(
)
{
info
(
"
Import
from
bookmarks
.
html
and
create
smart
bookmarks
if
"
+
"
autoExportHTML
is
true
and
they
are
not
at
latest
version
.
"
)
;
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
Assert
.
ok
(
!
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
)
)
;
Services
.
prefs
.
setIntPref
(
PREF_SMART_BOOKMARKS_VERSION
0
)
;
Services
.
prefs
.
setBoolPref
(
PREF_AUTO_EXPORT_HTML
true
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
true
)
;
await
simulatePlacesInit
(
)
;
let
bm
=
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
SMART_BOOKMARKS_ON_TOOLBAR
}
)
;
Assert
.
equal
(
bm
.
title
"
example
"
)
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
)
)
;
Services
.
prefs
.
setBoolPref
(
PREF_AUTO_EXPORT_HTML
false
)
;
}
)
;
add_task
(
async
function
test_restore
(
)
{
info
(
"
restore
from
default
bookmarks
.
html
if
"
+
"
restore_default_bookmarks
is
true
.
"
)
;
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
Assert
.
ok
(
!
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
)
)
;
Services
.
prefs
.
setBoolPref
(
PREF_RESTORE_DEFAULT_BOOKMARKS
true
)
;
await
simulatePlacesInit
(
)
;
Assert
.
ok
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
SMART_BOOKMARKS_ON_TOOLBAR
}
)
)
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_RESTORE_DEFAULT_BOOKMARKS
)
)
;
}
)
;
add_task
(
async
function
test_restore_import
(
)
{
info
(
"
setting
both
importBookmarksHTML
and
"
+
"
restore_default_bookmarks
should
restore
defaults
.
"
)
;
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
Assert
.
ok
(
!
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
0
}
)
)
)
;
Services
.
prefs
.
setBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
true
)
;
Services
.
prefs
.
setBoolPref
(
PREF_RESTORE_DEFAULT_BOOKMARKS
true
)
;
await
simulatePlacesInit
(
)
;
Assert
.
ok
(
await
PlacesUtils
.
bookmarks
.
fetch
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
toolbarGuid
index
:
SMART_BOOKMARKS_ON_TOOLBAR
}
)
)
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_RESTORE_DEFAULT_BOOKMARKS
)
)
;
Assert
.
ok
(
!
Services
.
prefs
.
getBoolPref
(
PREF_IMPORT_BOOKMARKS_HTML
)
)
;
}
)
;
