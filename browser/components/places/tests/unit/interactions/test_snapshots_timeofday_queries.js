XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
snapshot_timeofday_interval_seconds
"
"
browser
.
places
.
interactions
.
snapshotTimeOfDayIntervalSeconds
"
3600
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
snapshot_timeofday_expected_interactions
"
"
browser
.
places
.
interactions
.
snapshotTimeOfDayExpectedInteractions
"
15
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
snapshot_timeofday_sessiondecay_start_s
"
"
browser
.
places
.
interactions
.
snapshotTimeOfDaySessionDecayStartSeconds
"
1800
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
snapshot_timeofday_sessiondecay_end_s
"
"
browser
.
places
.
interactions
.
snapshotTimeOfDaySessionDecayEndSeconds
"
28800
)
;
const
now
=
new
Date
(
)
;
add_task
(
async
function
setup
(
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
places
.
interactions
.
enabled
"
true
)
;
info
(
"
Sanity
check
:
add
random
non
-
snapshot
pages
at
15
minutes
intervals
.
"
)
;
let
nonSnapshotPages
=
[
]
;
for
(
let
i
=
7
*
24
*
4
;
i
>
=
0
;
-
-
i
)
{
nonSnapshotPages
.
push
(
{
uri
:
https
:
/
/
nonsnapshot
{
i
}
.
com
/
visitDate
:
PlacesUtils
.
toPRTime
(
now
-
i
*
15
*
60
*
60
*
1000
)
}
)
;
}
await
PlacesTestUtils
.
addVisits
(
nonSnapshotPages
)
;
}
)
;
add_task
(
async
function
test_query
(
)
{
await
reset
(
)
;
const
interactionCounts
=
{
min
:
1
max
:
snapshot_timeofday_expected_interactions
*
3
}
;
Assert
.
greater
(
interactionCounts
.
max
/
2
snapshot_timeofday_expected_interactions
"
Half
of
max
interactions
is
greater
than
expected
interactions
"
)
;
let
snapshots
=
[
{
url
:
"
https
:
/
/
snapshot1
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
1
)
}
{
url
:
"
https
:
/
/
snapshot2
.
com
/
"
created_at
:
new
Date
(
now
)
.
setMinutes
(
now
.
getMinutes
(
)
-
snapshot_timeofday_interval_seconds
/
60
/
4
)
}
{
url
:
"
https
:
/
/
snapshot3
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
1
)
}
{
url
:
"
https
:
/
/
snapshot4
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
3
)
interactionCount
:
interactionCounts
.
max
}
{
url
:
"
https
:
/
/
snapshot5
.
com
/
"
created_at
:
new
Date
(
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
1
)
)
.
setMinutes
(
now
.
getMinutes
(
)
-
snapshot_timeofday_interval_seconds
/
60
)
}
{
url
:
"
https
:
/
/
snapshot6
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
7
)
}
{
url
:
"
https
:
/
/
snapshot7
.
com
/
"
created_at
:
new
Date
(
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
7
)
)
.
setMinutes
(
now
.
getMinutes
(
)
-
snapshot_timeofday_interval_seconds
/
60
)
}
{
url
:
"
https
:
/
/
snapshot8
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
100
)
}
{
url
:
"
https
:
/
/
snapshot9
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
7
)
interactionCount
:
interactionCounts
.
max
/
2
}
{
url
:
"
https
:
/
/
snapshot10
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
7
)
interactionCount
:
snapshot_timeofday_expected_interactions
}
]
;
await
addInteractions
(
snapshots
)
;
for
(
let
snapshot
of
snapshots
)
{
await
Snapshots
.
add
(
snapshot
)
;
if
(
snapshot
.
interactionCount
)
{
let
t
=
0
;
let
additionalInteractions
=
new
Array
(
Math
.
round
(
snapshot
.
interactionCount
)
-
1
)
.
fill
(
snapshot
.
url
)
.
map
(
url
=
>
(
{
url
created_at
:
new
Date
(
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
4
)
)
.
setSeconds
(
+
+
t
)
}
)
)
;
await
addInteractions
(
additionalInteractions
)
;
}
}
await
addInteractions
(
[
{
url
:
"
https
:
/
/
snapshot6
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
100
)
}
]
)
;
const
daysThreshold
=
101
;
const
context
=
{
url
:
snapshots
[
0
]
.
url
time
:
now
.
getTime
(
)
}
;
await
assertTimeOfDaySnapshots
(
[
{
url
:
"
https
:
/
/
snapshot3
.
com
/
"
scoreEqualTo
:
Snapshots
.
timeOfDayScore
(
{
interactions
:
1
context
.
.
.
interactionCounts
}
)
daysThreshold
scoreLessThan
:
1
.
0
}
{
url
:
"
https
:
/
/
snapshot4
.
com
/
"
scoreEqualTo
:
1
.
0
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot6
.
com
/
"
scoreEqualTo
:
Snapshots
.
timeOfDayScore
(
{
interactions
:
1
context
.
.
.
interactionCounts
}
)
daysThreshold
scoreLessThan
:
1
.
0
}
{
url
:
"
https
:
/
/
snapshot9
.
com
/
"
scoreEqualTo
:
1
.
0
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot10
.
com
/
"
scoreEqualTo
:
Snapshots
.
timeOfDayScore
(
{
interactions
:
snapshot_timeofday_expected_interactions
context
.
.
.
interactionCounts
}
)
daysThreshold
scoreLessThan
:
1
.
0
}
]
context
)
;
}
)
;
add_task
(
async
function
test_session_decay
(
)
{
await
reset
(
)
;
Services
.
prefs
.
setIntPref
(
"
browser
.
places
.
interactions
.
snapshotTimeOfDayExpectedInteractions
"
1
)
;
let
snapshots
=
[
{
url
:
"
https
:
/
/
snapshot3
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
1
)
}
{
url
:
"
https
:
/
/
snapshot4
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
3
)
}
{
url
:
"
https
:
/
/
snapshot6
.
com
/
"
created_at
:
new
Date
(
now
)
.
setDate
(
now
.
getDate
(
)
-
7
)
}
]
;
await
addInteractions
(
snapshots
)
;
for
(
let
snapshot
of
snapshots
)
{
await
Snapshots
.
add
(
snapshot
)
;
}
const
daysThreshold
=
8
;
info
(
"
early
in
the
session
before
decay
start
"
)
;
await
assertTimeOfDaySnapshots
(
[
{
url
:
"
https
:
/
/
snapshot3
.
com
/
"
scoreEqualTo
:
1
.
0
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot4
.
com
/
"
scoreEqualTo
:
1
.
0
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot6
.
com
/
"
scoreEqualTo
:
1
.
0
daysThreshold
}
]
{
url
:
"
about
:
robots
"
time
:
now
.
getTime
(
)
sessionStartTime
:
new
Date
(
now
)
-
snapshot_timeofday_sessiondecay_start_s
*
1000
}
)
;
info
(
"
late
in
the
session
after
decay
end
"
)
;
await
assertTimeOfDaySnapshots
(
[
{
url
:
"
https
:
/
/
snapshot3
.
com
/
"
scoreEqualTo
:
0
.
1
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot4
.
com
/
"
scoreEqualTo
:
0
.
1
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot6
.
com
/
"
scoreEqualTo
:
0
.
1
daysThreshold
}
]
{
url
:
"
about
:
robots
"
time
:
now
.
getTime
(
)
sessionStartTime
:
new
Date
(
now
)
-
snapshot_timeofday_sessiondecay_end_s
*
1000
-
1000
}
)
;
info
(
"
between
decay
start
and
end
"
)
;
await
assertTimeOfDaySnapshots
(
[
{
url
:
"
https
:
/
/
snapshot3
.
com
/
"
scoreLessThan
:
1
.
0
scoreGreaterThan
:
0
.
1
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot4
.
com
/
"
scoreLessThan
:
1
.
0
scoreGreaterThan
:
0
.
1
daysThreshold
}
{
url
:
"
https
:
/
/
snapshot6
.
com
/
"
scoreLessThan
:
1
.
0
scoreGreaterThan
:
0
.
1
daysThreshold
}
]
{
url
:
"
about
:
robots
"
time
:
now
.
getTime
(
)
sessionStartTime
:
now
.
getTime
(
)
-
(
snapshot_timeofday_sessiondecay_start_s
+
(
snapshot_timeofday_sessiondecay_end_s
-
snapshot_timeofday_sessiondecay_start_s
)
/
2
)
*
1000
}
)
;
}
)
;
