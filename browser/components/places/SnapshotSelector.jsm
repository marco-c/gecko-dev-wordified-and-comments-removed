const
EXPORTED_SYMBOLS
=
[
"
SnapshotSelector
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
EventEmitter
:
"
resource
:
/
/
gre
/
modules
/
EventEmitter
.
jsm
"
DeferredTask
:
"
resource
:
/
/
gre
/
modules
/
DeferredTask
.
jsm
"
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
Snapshots
:
"
resource
:
/
/
/
modules
/
Snapshots
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
logConsole
"
function
(
)
{
return
console
.
createInstance
(
{
prefix
:
"
SnapshotSelector
"
maxLogLevel
:
Services
.
prefs
.
getBoolPref
(
"
browser
.
places
.
interactions
.
log
"
false
)
?
"
Debug
"
:
"
Warn
"
}
)
;
}
)
;
class
SnapshotSelector
extends
EventEmitter
{
static
#
selectors
=
new
Set
(
)
;
static
rebuildAll
(
)
{
for
(
let
selector
of
SnapshotSelector
.
#
selectors
)
{
selector
.
rebuild
(
)
;
}
}
#
context
=
{
count
:
undefined
url
:
undefined
type
:
undefined
}
;
#
task
=
null
;
constructor
(
count
=
5
)
{
super
(
)
;
this
.
#
task
=
new
DeferredTask
(
(
)
=
>
this
.
#
buildSnapshots
(
)
500
)
;
this
.
#
context
.
count
=
count
;
SnapshotSelector
.
#
selectors
.
add
(
this
)
;
}
destroy
(
)
{
this
.
#
task
.
disarm
(
)
;
this
.
#
task
.
finalize
(
)
;
this
.
#
task
=
null
;
SnapshotSelector
.
#
selectors
.
delete
(
this
)
;
}
rebuild
(
)
{
this
.
#
task
.
arm
(
)
;
}
#
snapshotsGenerated
(
snapshots
)
{
logConsole
.
debug
(
"
Generated
snapshots
"
snapshots
.
map
(
s
=
>
s
.
url
)
)
;
this
.
emit
(
"
snapshots
-
updated
"
snapshots
)
;
}
async
#
buildSnapshots
(
)
{
let
context
=
{
.
.
.
this
.
#
context
}
;
logConsole
.
debug
(
"
Building
snapshots
"
context
)
;
let
snapshots
=
await
Snapshots
.
query
(
{
limit
:
context
.
count
+
1
type
:
context
.
type
}
)
;
snapshots
=
snapshots
.
filter
(
snapshot
=
>
snapshot
.
url
!
=
context
.
url
)
.
slice
(
0
context
.
count
)
;
this
.
#
snapshotsGenerated
(
snapshots
)
;
}
setUrl
(
url
)
{
if
(
this
.
#
context
.
url
=
=
url
)
{
return
;
}
this
.
#
context
.
url
=
url
;
this
.
rebuild
(
)
;
}
async
setType
(
type
)
{
if
(
this
.
#
context
.
type
=
=
=
type
)
{
return
;
}
this
.
#
context
.
type
=
type
;
this
.
rebuild
(
)
;
}
}
Services
.
obs
.
addObserver
(
SnapshotSelector
.
rebuildAll
"
places
-
snapshots
-
added
"
)
;
Services
.
obs
.
addObserver
(
SnapshotSelector
.
rebuildAll
"
places
-
snapshots
-
deleted
"
)
;
Services
.
obs
.
addObserver
(
SnapshotSelector
.
rebuildAll
"
places
-
metadata
-
updated
"
)
;
