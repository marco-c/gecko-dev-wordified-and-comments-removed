"
use
strict
"
;
const
{
AppConstants
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
const
{
OS
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
async
function
writeAttributionFile
(
data
)
{
let
appDir
=
Services
.
dirsvc
.
get
(
"
LocalAppData
"
Ci
.
nsIFile
)
;
let
file
=
appDir
.
clone
(
)
;
file
.
append
(
Services
.
appinfo
.
vendor
|
|
"
mozilla
"
)
;
file
.
append
(
AppConstants
.
MOZ_APP_NAME
)
;
await
OS
.
File
.
makeDir
(
file
.
path
{
from
:
appDir
.
path
ignoreExisting
:
true
}
)
;
file
.
append
(
"
postSigningData
"
)
;
await
OS
.
File
.
writeAtomic
(
file
.
path
data
)
;
}
add_task
(
async
function
testValidAttrCodes
(
)
{
for
(
let
entry
of
validAttrCodes
)
{
AttributionCode
.
_clearCache
(
)
;
await
writeAttributionFile
(
entry
.
code
)
;
let
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
entry
.
parsed
"
Parsed
code
should
match
expected
value
code
was
:
"
+
entry
.
code
)
;
}
AttributionCode
.
_clearCache
(
)
;
}
)
;
add_task
(
async
function
testInvalidAttrCodes
(
)
{
for
(
let
code
of
invalidAttrCodes
)
{
AttributionCode
.
_clearCache
(
)
;
await
writeAttributionFile
(
code
)
;
let
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
{
}
"
Code
should
have
failed
to
parse
:
"
+
code
)
;
}
AttributionCode
.
_clearCache
(
)
;
}
)
;
add_task
(
async
function
testDeletedFile
(
)
{
await
writeAttributionFile
(
validAttrCodes
[
0
]
.
code
)
;
let
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
validAttrCodes
[
0
]
.
parsed
"
The
code
should
be
readable
directly
from
the
file
"
)
;
await
AttributionCode
.
deleteFileAsync
(
)
;
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
validAttrCodes
[
0
]
.
parsed
"
The
code
should
be
readable
from
the
cache
"
)
;
AttributionCode
.
_clearCache
(
)
;
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
{
}
"
Shouldn
'
t
be
able
to
get
a
code
after
file
is
deleted
and
cache
is
cleared
"
)
;
}
)
;
