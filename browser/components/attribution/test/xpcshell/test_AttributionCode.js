"
use
strict
"
;
const
{
AppConstants
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
const
{
OS
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
add_task
(
async
(
)
=
>
{
await
setupStubs
(
)
;
}
)
;
add_task
(
async
function
testValidAttrCodes
(
)
{
for
(
let
entry
of
validAttrCodes
)
{
AttributionCode
.
_clearCache
(
)
;
await
AttributionCode
.
writeAttributionFile
(
entry
.
code
)
;
let
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
entry
.
parsed
"
Parsed
code
should
match
expected
value
code
was
:
"
+
entry
.
code
)
;
}
AttributionCode
.
_clearCache
(
)
;
}
)
;
add_task
(
async
function
testInvalidAttrCodes
(
)
{
for
(
let
code
of
invalidAttrCodes
)
{
AttributionCode
.
_clearCache
(
)
;
await
AttributionCode
.
writeAttributionFile
(
code
)
;
let
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
{
}
"
Code
should
have
failed
to
parse
:
"
+
code
)
;
}
AttributionCode
.
_clearCache
(
)
;
}
)
;
add_task
(
async
function
testDeletedFile
(
)
{
await
AttributionCode
.
writeAttributionFile
(
validAttrCodes
[
0
]
.
code
)
;
let
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
validAttrCodes
[
0
]
.
parsed
"
The
code
should
be
readable
directly
from
the
file
"
)
;
await
AttributionCode
.
deleteFileAsync
(
)
;
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
validAttrCodes
[
0
]
.
parsed
"
The
code
should
be
readable
from
the
cache
"
)
;
AttributionCode
.
_clearCache
(
)
;
result
=
await
AttributionCode
.
getAttrDataAsync
(
)
;
Assert
.
deepEqual
(
result
{
}
"
Shouldn
'
t
be
able
to
get
a
code
after
file
is
deleted
and
cache
is
cleared
"
)
;
}
)
;
