const
{
TabsSetupFlowManager
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
firefox
-
view
-
tabs
-
setup
-
manager
.
sys
.
mjs
"
)
;
const
MOBILE_PROMO_DISMISSED_PREF
=
"
browser
.
tabs
.
firefox
-
view
.
mobilePromo
.
dismissed
"
;
const
FXA_CONTINUE_EVENT
=
[
[
"
firefoxview
"
"
entered
"
"
firefoxview
"
undefined
]
[
"
firefoxview
"
"
fxa_continue
"
"
sync
"
undefined
]
]
;
const
FXA_MOBILE_EVENT
=
[
[
"
firefoxview
"
"
entered
"
"
firefoxview
"
undefined
]
[
"
firefoxview
"
"
fxa_mobile
"
"
sync
"
undefined
{
has_devices
:
"
false
"
}
]
]
;
var
gMockFxaDevices
=
null
;
var
gUIStateStatus
;
var
gUIStateSyncEnabled
;
function
promiseSyncReady
(
)
{
let
service
=
Cc
[
"
mozilla
.
org
/
weave
/
service
;
1
"
]
.
getService
(
Ci
.
nsISupports
)
.
wrappedJSObject
;
return
service
.
whenLoaded
(
)
;
}
var
gSandbox
;
function
setupMocks
(
{
fxaDevices
=
null
state
syncEnabled
=
true
}
)
{
gUIStateStatus
=
state
|
|
UIState
.
STATUS_SIGNED_IN
;
gUIStateSyncEnabled
=
syncEnabled
;
if
(
gSandbox
)
{
gSandbox
.
restore
(
)
;
}
const
sandbox
=
(
gSandbox
=
sinon
.
createSandbox
(
)
)
;
gMockFxaDevices
=
fxaDevices
;
sandbox
.
stub
(
fxAccounts
.
device
"
recentDeviceList
"
)
.
get
(
(
)
=
>
fxaDevices
)
;
sandbox
.
stub
(
UIState
"
get
"
)
.
callsFake
(
(
)
=
>
{
return
{
status
:
gUIStateStatus
.
.
.
(
gUIStateSyncEnabled
!
=
undefined
&
&
{
syncEnabled
:
gUIStateSyncEnabled
}
)
}
;
}
)
;
return
sandbox
;
}
async
function
setupWithDesktopDevices
(
)
{
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_SIGNED_IN
fxaDevices
:
[
{
id
:
1
name
:
"
This
Device
"
isCurrentDevice
:
true
type
:
"
desktop
"
}
{
id
:
2
name
:
"
Other
Device
"
type
:
"
desktop
"
}
]
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
services
.
sync
.
engine
.
tabs
"
true
]
]
}
)
;
return
sandbox
;
}
async
function
tearDown
(
sandbox
)
{
sandbox
?
.
restore
(
)
;
Services
.
prefs
.
clearUserPref
(
"
services
.
sync
.
lastTabFetch
"
)
;
Services
.
prefs
.
clearUserPref
(
MOBILE_PROMO_DISMISSED_PREF
)
;
}
add_setup
(
async
function
(
)
{
registerCleanupFunction
(
(
)
=
>
{
TabsSetupFlowManager
.
resetInternalState
(
)
;
}
)
;
gSync
.
init
(
)
;
registerCleanupFunction
(
async
function
(
)
{
Services
.
prefs
.
clearUserPref
(
"
services
.
sync
.
engine
.
tabs
"
)
;
await
tearDown
(
gSandbox
)
;
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
services
.
sync
.
engine
.
tabs
"
false
]
]
}
)
;
}
)
;
add_task
(
async
function
test_unconfigured_initial_state
(
)
{
await
clearAllParentTelemetryEvents
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
firefox
-
view
.
feature
-
tour
"
JSON
.
stringify
(
{
screen
:
FEATURE_CALLOUT_1
complete
:
false
}
)
]
]
}
)
;
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_NOT_CONFIGURED
syncEnabled
:
false
}
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view1
"
}
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
'
button
[
data
-
action
=
"
view1
-
primary
-
action
"
]
'
{
}
browser
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
let
events
=
Services
.
telemetry
.
snapshotEvents
(
Ci
.
nsITelemetry
.
DATASET_PRERELEASE_CHANNELS
false
)
.
parent
;
return
events
&
&
events
.
length
>
=
2
;
}
"
Waiting
for
entered
and
fxa_continue
firefoxview
telemetry
events
.
"
200
100
)
;
TelemetryTestUtils
.
assertEvents
(
FXA_CONTINUE_EVENT
{
category
:
"
firefoxview
"
}
{
clear
:
true
process
:
"
parent
"
}
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_signed_in
(
)
{
await
clearAllParentTelemetryEvents
(
)
;
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_SIGNED_IN
fxaDevices
:
[
{
id
:
1
name
:
"
This
Device
"
isCurrentDevice
:
true
type
:
"
desktop
"
}
]
}
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view2
"
}
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
1
"
Just
1
device
connected
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
'
button
[
data
-
action
=
"
view2
-
primary
-
action
"
]
'
{
}
browser
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
let
events
=
Services
.
telemetry
.
snapshotEvents
(
Ci
.
nsITelemetry
.
DATASET_PRERELEASE_CHANNELS
false
)
.
parent
;
return
events
&
&
events
.
length
>
=
2
;
}
"
Waiting
for
entered
and
fxa_mobile
firefoxview
telemetry
events
.
"
200
100
)
;
TelemetryTestUtils
.
assertEvents
(
FXA_MOBILE_EVENT
{
category
:
"
firefoxview
"
}
{
clear
:
true
process
:
"
parent
"
}
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_2nd_desktop_connected
(
)
{
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_SIGNED_IN
fxaDevices
:
[
{
id
:
1
name
:
"
This
Device
"
isCurrentDevice
:
true
type
:
"
desktop
"
}
{
id
:
2
name
:
"
Other
Device
"
type
:
"
desktop
"
}
]
}
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
ok
(
!
Services
.
prefs
.
getBoolPref
(
"
services
.
sync
.
engine
.
tabs
"
false
)
"
services
.
sync
.
engine
.
tabs
is
initially
false
"
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view3
"
}
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
2
"
2
devices
connected
"
)
;
ok
(
fxAccounts
.
device
.
recentDeviceList
?
.
every
(
device
=
>
device
.
type
!
=
=
"
mobile
"
&
&
device
.
type
!
=
=
"
tablet
"
)
"
No
connected
device
is
type
:
mobile
or
type
:
tablet
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_mobile_connected
(
)
{
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_SIGNED_IN
fxaDevices
:
[
{
id
:
1
name
:
"
This
Device
"
isCurrentDevice
:
true
type
:
"
desktop
"
}
{
id
:
2
name
:
"
Other
Device
"
type
:
"
mobile
"
}
]
}
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
ok
(
!
Services
.
prefs
.
getBoolPref
(
"
services
.
sync
.
engine
.
tabs
"
false
)
"
services
.
sync
.
engine
.
tabs
is
initially
false
"
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view3
"
}
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
2
"
2
devices
connected
"
)
;
ok
(
fxAccounts
.
device
.
recentDeviceList
?
.
some
(
device
=
>
device
.
type
=
=
"
mobile
"
)
"
A
connected
device
is
type
:
mobile
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_tablet_connected
(
)
{
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_SIGNED_IN
fxaDevices
:
[
{
id
:
1
name
:
"
This
Device
"
isCurrentDevice
:
true
type
:
"
desktop
"
}
{
id
:
2
name
:
"
Other
Device
"
type
:
"
tablet
"
}
]
}
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
ok
(
!
Services
.
prefs
.
getBoolPref
(
"
services
.
sync
.
engine
.
tabs
"
false
)
"
services
.
sync
.
engine
.
tabs
is
initially
false
"
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view3
"
}
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
2
"
2
devices
connected
"
)
;
ok
(
fxAccounts
.
device
.
recentDeviceList
?
.
some
(
device
=
>
device
.
type
=
=
"
tablet
"
)
"
A
connected
device
is
type
:
tablet
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_tab_sync_enabled
(
)
{
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_SIGNED_IN
fxaDevices
:
[
{
id
:
1
name
:
"
This
Device
"
isCurrentDevice
:
true
type
:
"
desktop
"
}
{
id
:
2
name
:
"
Other
Device
"
type
:
"
mobile
"
}
]
}
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view3
"
}
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
services
.
sync
.
engine
.
tabs
"
true
]
]
}
)
;
await
waitForElementVisible
(
browser
"
#
tabpickup
-
steps
"
false
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view3
"
}
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
const
actionButton
=
browser
.
contentWindow
.
document
.
querySelector
(
"
#
tabpickup
-
steps
-
view3
button
.
primary
"
)
;
actionButton
.
click
(
)
;
await
waitForElementVisible
(
browser
"
#
tabpickup
-
steps
"
false
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
await
waitForElementVisible
(
browser
"
.
featureCallout
.
FEATURE_CALLOUT_1
"
)
;
ok
(
true
"
Tab
pickup
product
tour
screen
renders
when
sync
is
enabled
"
)
;
ok
(
Services
.
prefs
.
getBoolPref
(
"
services
.
sync
.
engine
.
tabs
"
false
)
"
tab
sync
pref
should
be
enabled
after
button
click
"
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_mobile_promo
(
)
{
const
sandbox
=
await
setupWithDesktopDevices
(
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
await
touchLastTabFetch
(
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForElementVisible
(
browser
"
.
synced
-
tabs
-
container
"
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
2
"
2
devices
connected
"
)
;
info
(
"
checking
mobile
promo
should
be
visible
now
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
true
mobileConfirmation
:
false
}
)
;
gMockFxaDevices
.
push
(
{
id
:
3
name
:
"
Mobile
Device
"
type
:
"
mobile
"
}
)
;
Services
.
obs
.
notifyObservers
(
null
"
fxaccounts
:
devicelist_updated
"
)
;
await
waitForElementVisible
(
browser
"
#
tab
-
pickup
-
container
>
.
promo
-
box
"
false
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
3
"
3
devices
connected
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
true
}
)
;
info
(
"
checking
mobile
promo
disappears
on
log
out
"
)
;
gMockFxaDevices
.
pop
(
)
;
Services
.
obs
.
notifyObservers
(
null
"
fxaccounts
:
devicelist_updated
"
)
;
await
waitForElementVisible
(
browser
"
#
tab
-
pickup
-
container
>
.
promo
-
box
"
true
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
true
mobileConfirmation
:
false
}
)
;
gUIStateStatus
=
UIState
.
STATUS_NOT_CONFIGURED
;
gUIStateSyncEnabled
=
undefined
;
info
(
"
notifying
that
we
'
ve
signed
out
of
fxa
UIState
.
get
(
)
.
status
:
"
+
UIState
.
get
(
)
.
status
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
info
(
"
waiting
for
setup
card
1
to
appear
again
"
)
;
await
waitForVisibleSetupStep
(
browser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view1
"
}
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_mobile_promo_pref
(
)
{
const
sandbox
=
await
setupWithDesktopDevices
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
MOBILE_PROMO_DISMISSED_PREF
true
]
]
}
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
info
(
"
starting
test
will
notify
of
UIState
update
"
)
;
await
touchLastTabFetch
(
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForElementVisible
(
browser
"
.
synced
-
tabs
-
container
"
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
2
"
2
devices
connected
"
)
;
info
(
"
checking
mobile
promo
should
be
still
hidden
because
of
the
pref
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
waitForElementVisible
(
browser
"
#
tab
-
pickup
-
container
>
.
promo
-
box
"
true
)
;
const
promoElem
=
browser
.
contentWindow
.
document
.
querySelector
(
"
#
tab
-
pickup
-
container
>
.
promo
-
box
"
)
;
const
promoElemClose
=
promoElem
.
querySelector
(
"
.
close
"
)
;
ok
(
promoElemClose
.
hasAttribute
(
"
aria
-
label
"
)
"
Button
has
an
a11y
name
"
)
;
info
(
"
Clicking
the
promo
close
button
:
"
+
promoElemClose
)
;
EventUtils
.
sendMouseEvent
(
{
type
:
"
click
"
}
promoElemClose
)
;
info
(
"
Check
the
promo
box
got
hidden
"
)
;
BrowserTestUtils
.
is_hidden
(
promoElem
)
;
ok
(
SpecialPowers
.
getBoolPref
(
MOBILE_PROMO_DISMISSED_PREF
)
"
Promo
pref
is
updated
when
close
is
clicked
"
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_mobile_promo_windows
(
)
{
const
sandbox
=
await
setupWithDesktopDevices
(
)
;
await
withFirefoxView
(
{
}
async
browser
=
>
{
await
touchLastTabFetch
(
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForElementVisible
(
browser
"
.
synced
-
tabs
-
container
"
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
2
"
2
devices
connected
"
)
;
info
(
"
checking
mobile
promo
is
visible
"
)
;
checkMobilePromo
(
browser
{
mobilePromo
:
true
mobileConfirmation
:
false
}
)
;
info
(
"
opening
new
window
pref
is
:
"
+
SpecialPowers
.
getBoolPref
(
"
browser
.
tabs
.
firefox
-
view
"
)
)
;
let
win2
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
info
(
"
Got
window
now
opening
Firefox
View
in
it
"
)
;
await
withFirefoxView
(
{
resetFlowManager
:
false
win
:
win2
}
async
win2Browser
=
>
{
info
(
"
In
withFirefoxView
taskFn
for
win2
"
)
;
info
(
"
check
mobile
promo
is
visible
in
the
new
window
"
)
;
checkMobilePromo
(
win2Browser
{
mobilePromo
:
true
mobileConfirmation
:
false
}
)
;
info
(
"
add
a
mobile
device
and
send
device_connected
notification
"
)
;
gMockFxaDevices
.
push
(
{
id
:
3
name
:
"
Mobile
Device
"
type
:
"
mobile
"
}
)
;
Services
.
obs
.
notifyObservers
(
null
"
fxaccounts
:
devicelist_updated
"
)
;
is
(
fxAccounts
.
device
.
recentDeviceList
?
.
length
3
"
3
devices
connected
"
)
;
info
(
"
waiting
for
the
confirmation
box
to
be
visible
"
)
;
await
waitForElementVisible
(
win2Browser
"
#
tab
-
pickup
-
container
>
.
promo
-
box
"
false
)
;
for
(
let
fxviewBrowser
of
[
browser
win2Browser
]
)
{
info
(
"
checking
promo
is
hidden
and
confirmation
is
visible
in
each
window
"
)
;
checkMobilePromo
(
fxviewBrowser
{
mobilePromo
:
false
mobileConfirmation
:
true
}
)
;
}
const
confirmBox
=
win2Browser
.
contentWindow
.
document
.
querySelector
(
"
#
tab
-
pickup
-
container
>
.
confirmation
-
message
-
box
"
)
;
const
closeButton
=
confirmBox
.
querySelector
(
"
.
close
"
)
;
ok
(
closeButton
.
hasAttribute
(
"
aria
-
label
"
)
"
Button
has
an
a11y
name
"
)
;
EventUtils
.
sendMouseEvent
(
{
type
:
"
click
"
}
closeButton
win2
)
;
BrowserTestUtils
.
is_hidden
(
confirmBox
)
;
for
(
let
fxviewBrowser
of
[
browser
win2Browser
]
)
{
checkMobilePromo
(
fxviewBrowser
{
mobilePromo
:
false
mobileConfirmation
:
false
}
)
;
}
}
)
;
await
BrowserTestUtils
.
closeWindow
(
win2
)
;
}
)
;
await
tearDown
(
sandbox
)
;
}
)
;
add_task
(
async
function
test_keyboard_focus_after_tab_pickup_opened
(
)
{
TabsSetupFlowManager
.
resetInternalState
(
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
tabs
.
firefox
-
view
.
ui
-
state
.
tab
-
pickup
.
open
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
firefox
-
view
.
feature
-
tour
"
JSON
.
stringify
(
{
screen
:
FEATURE_CALLOUT_1
complete
:
true
}
)
]
]
}
)
;
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_NOT_CONFIGURED
syncEnabled
:
false
}
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
firefoxview
"
}
async
browser
=
>
{
const
{
document
}
=
browser
.
contentWindow
;
is
(
document
.
activeElement
.
localName
"
body
"
"
document
body
element
is
initially
focused
"
)
;
const
tab
=
(
)
=
>
{
info
(
"
Tab
keypress
synthesized
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Tab
"
)
;
}
;
tab
(
)
;
let
tabPickupContainer
=
document
.
querySelector
(
"
#
tab
-
pickup
-
container
summary
.
page
-
section
-
header
"
)
;
is
(
document
.
activeElement
tabPickupContainer
"
tab
pickup
container
header
has
focus
"
)
;
tab
(
)
;
is
(
document
.
activeElement
.
id
"
firefoxview
-
tabpickup
-
step
-
signin
-
primarybutton
"
"
tab
pickup
primary
button
has
focus
"
)
;
}
)
;
await
tearDown
(
sandbox
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
async
function
mockFxaDeviceConnected
(
win
)
{
const
url
=
"
https
:
/
/
example
.
org
/
pair
/
auth
/
complete
"
;
is
(
win
.
gBrowser
.
tabs
.
length
3
"
Tabs
strip
should
contain
three
tabs
"
)
;
BrowserTestUtils
.
loadURI
(
win
.
gBrowser
.
selectedTab
.
linkedBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
win
.
gBrowser
.
selectedTab
.
linkedBrowser
null
url
)
;
is
(
win
.
gBrowser
.
selectedTab
.
linkedBrowser
.
currentURI
.
filePath
"
/
pair
/
auth
/
complete
"
"
/
pair
/
auth
/
complete
is
the
selected
tab
"
)
;
}
add_task
(
async
function
test_close_device_connected_tab
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
identity
.
fxaccounts
.
remote
.
root
"
"
https
:
/
/
example
.
org
/
"
]
]
}
)
;
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
let
fxViewTab
=
await
openFirefoxViewTab
(
win
)
;
await
waitForVisibleSetupStep
(
win
.
gBrowser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view1
"
}
)
;
let
actionButton
=
win
.
gBrowser
.
contentWindow
.
document
.
querySelector
(
"
#
tabpickup
-
steps
-
view1
button
.
primary
"
)
;
let
tabSwitched
=
BrowserTestUtils
.
waitForEvent
(
win
.
gBrowser
"
TabSwitchDone
"
)
;
actionButton
.
click
(
)
;
await
tabSwitched
;
await
mockFxaDeviceConnected
(
win
)
;
let
deviceConnectedTab
=
win
.
gBrowser
.
tabs
[
2
]
;
const
newTab
=
win
.
gBrowser
.
tabs
.
find
(
tab
=
>
tab
!
=
deviceConnectedTab
&
&
tab
!
=
fxViewTab
)
;
let
removedTab
=
BrowserTestUtils
.
waitForTabClosing
(
newTab
)
;
BrowserTestUtils
.
removeTab
(
newTab
)
;
await
removedTab
;
is
(
win
.
gBrowser
.
tabs
.
length
2
"
Tabs
strip
should
only
contain
two
tabs
"
)
;
is
(
win
.
gBrowser
.
selectedTab
.
linkedBrowser
.
currentURI
.
filePath
"
/
pair
/
auth
/
complete
"
"
/
pair
/
auth
/
complete
is
the
selected
tab
"
)
;
await
EventUtils
.
synthesizeMouseAtCenter
(
win
.
document
.
getElementById
(
"
firefox
-
view
-
button
"
)
{
type
:
"
mousedown
"
}
win
)
;
is
(
win
.
gBrowser
.
tabs
.
length
2
"
Tabs
strip
should
only
contain
two
tabs
"
)
;
is
(
win
.
gBrowser
.
tabs
[
0
]
.
linkedBrowser
.
currentURI
.
filePath
"
firefoxview
"
"
First
tab
is
Firefox
view
"
)
;
is
(
win
.
gBrowser
.
tabs
[
1
]
.
linkedBrowser
.
currentURI
.
filePath
"
newtab
"
"
Second
tab
is
about
:
newtab
"
)
;
const
sandbox
=
setupMocks
(
{
state
:
UIState
.
STATUS_SIGNED_IN
fxaDevices
:
[
{
id
:
1
name
:
"
This
Device
"
isCurrentDevice
:
true
type
:
"
desktop
"
}
]
}
)
;
Services
.
obs
.
notifyObservers
(
null
UIState
.
ON_UPDATE
)
;
await
waitForVisibleSetupStep
(
win
.
gBrowser
{
expectedVisible
:
"
#
tabpickup
-
steps
-
view2
"
}
)
;
actionButton
=
win
.
gBrowser
.
contentWindow
.
document
.
querySelector
(
"
#
tabpickup
-
steps
-
view2
button
.
primary
"
)
;
tabSwitched
=
BrowserTestUtils
.
waitForEvent
(
win
.
gBrowser
"
TabSwitchDone
"
)
;
actionButton
.
click
(
)
;
await
tabSwitched
;
await
mockFxaDeviceConnected
(
win
)
;
await
EventUtils
.
synthesizeMouseAtCenter
(
win
.
document
.
getElementById
(
"
firefox
-
view
-
button
"
)
{
type
:
"
mousedown
"
}
win
)
;
is
(
win
.
gBrowser
.
tabs
.
length
2
"
Tabs
strip
should
only
contain
two
tabs
"
)
;
is
(
win
.
gBrowser
.
tabs
[
0
]
.
linkedBrowser
.
currentURI
.
filePath
"
firefoxview
"
"
First
tab
is
Firefox
view
"
)
;
is
(
win
.
gBrowser
.
tabs
[
1
]
.
linkedBrowser
.
currentURI
.
filePath
"
newtab
"
"
Second
tab
is
about
:
newtab
"
)
;
await
tearDown
(
sandbox
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
