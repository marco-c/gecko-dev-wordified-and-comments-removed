const
{
classes
:
Cc
utils
:
Cu
interfaces
:
Ci
manager
:
Cm
}
=
Components
;
Cm
.
QueryInterface
(
Ci
.
nsIServiceManager
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
let
firstPaintNotification
=
"
widget
-
first
-
paint
"
;
if
(
AppConstants
.
platform
=
=
"
linux
"
)
firstPaintNotification
=
"
xul
-
window
-
visible
"
;
function
startupRecorder
(
)
{
this
.
wrappedJSObject
=
this
;
this
.
loader
=
Cc
[
"
mozilla
.
org
/
moz
/
jsloader
;
1
"
]
.
getService
(
Ci
.
xpcIJSModuleLoader
)
;
this
.
data
=
{
images
:
{
"
image
-
drawing
"
:
new
Set
(
)
"
image
-
loading
"
:
new
Set
(
)
}
code
:
{
}
}
;
this
.
done
=
new
Promise
(
resolve
=
>
{
this
.
_resolve
=
resolve
}
)
;
}
startupRecorder
.
prototype
=
{
classID
:
Components
.
ID
(
"
{
11c095b2
-
e42e
-
4bdf
-
9dd0
-
aed87595f6a4
}
"
)
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsIObserver
]
)
record
(
name
)
{
this
.
data
.
code
[
name
]
=
{
components
:
this
.
loader
.
loadedComponents
(
)
modules
:
this
.
loader
.
loadedModules
(
)
services
:
Object
.
keys
(
Cc
)
.
filter
(
c
=
>
{
try
{
Cm
.
isServiceInstantiatedByContractID
(
c
Ci
.
nsISupports
)
;
return
true
;
}
catch
(
e
)
{
return
false
;
}
}
)
}
;
}
observe
(
subject
topic
data
)
{
if
(
topic
=
=
"
app
-
startup
"
)
{
let
topics
=
[
"
profile
-
do
-
change
"
"
toplevel
-
window
-
ready
"
"
image
-
loading
"
"
image
-
drawing
"
firstPaintNotification
"
sessionstore
-
windows
-
restored
"
]
;
for
(
let
t
of
topics
)
Services
.
obs
.
addObserver
(
this
t
)
;
return
;
}
if
(
topic
=
=
"
image
-
drawing
"
|
|
topic
=
=
"
image
-
loading
"
)
{
this
.
data
.
images
[
topic
]
.
add
(
data
)
;
return
;
}
Services
.
obs
.
removeObserver
(
this
topic
)
;
if
(
topic
=
=
"
sessionstore
-
windows
-
restored
"
)
{
Services
.
tm
.
dispatchToMainThread
(
this
.
record
.
bind
(
this
"
before
handling
user
events
"
)
)
;
(
function
waitForIdle
(
callback
count
=
10
)
{
if
(
count
)
Services
.
tm
.
idleDispatchToMainThread
(
(
)
=
>
waitForIdle
(
callback
count
-
1
)
)
;
else
callback
(
)
;
}
)
(
(
)
=
>
{
this
.
record
(
"
before
becoming
idle
"
)
;
Services
.
obs
.
removeObserver
(
this
"
image
-
drawing
"
)
;
Services
.
obs
.
removeObserver
(
this
"
image
-
loading
"
)
;
this
.
_resolve
(
)
;
this
.
_resolve
=
null
;
}
)
;
}
else
{
const
topicsToNames
=
{
"
profile
-
do
-
change
"
:
"
before
profile
selection
"
"
toplevel
-
window
-
ready
"
:
"
before
opening
first
browser
window
"
}
;
topicsToNames
[
firstPaintNotification
]
=
"
before
first
paint
"
;
this
.
record
(
topicsToNames
[
topic
]
)
;
}
}
}
;
this
.
NSGetFactory
=
XPCOMUtils
.
generateNSGetFactory
(
[
startupRecorder
]
)
;
