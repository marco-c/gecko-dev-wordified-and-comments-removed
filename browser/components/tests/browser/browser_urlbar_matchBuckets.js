const
SEARCHBAR_WIDGET_ID
=
"
search
-
container
"
;
const
PREF_NAME
=
"
browser
.
urlbar
.
matchBuckets
"
;
const
SEARCHBAR_PRESENT_PREF_VALUE
=
"
general
:
5
suggestion
:
Infinity
"
;
add_task
(
async
function
waitForIdle
(
)
{
await
TestUtils
.
waitForIdle
(
)
;
}
)
;
add_task
(
async
function
test
(
)
{
Assert
.
equal
(
CustomizableUI
.
getPlacementOfWidget
(
SEARCHBAR_WIDGET_ID
)
null
"
Sanity
check
:
searchbar
should
not
be
placed
initially
"
)
;
Assert
.
equal
(
Services
.
prefs
.
getCharPref
(
PREF_NAME
"
"
)
"
"
"
Sanity
check
:
pref
should
be
cleared
initially
"
)
;
let
widgetPromise
=
promiseWidget
(
"
onWidgetAdded
"
)
;
CustomizableUI
.
addWidgetToArea
(
SEARCHBAR_WIDGET_ID
CustomizableUI
.
AREA_NAVBAR
)
;
info
(
"
Waiting
for
searchbar
to
be
added
"
)
;
await
widgetPromise
;
Assert
.
equal
(
Services
.
prefs
.
getCharPref
(
PREF_NAME
)
SEARCHBAR_PRESENT_PREF_VALUE
"
Pref
should
be
set
after
adding
searchbar
"
)
;
widgetPromise
=
promiseWidget
(
"
onWidgetRemoved
"
)
;
CustomizableUI
.
removeWidgetFromArea
(
SEARCHBAR_WIDGET_ID
)
;
info
(
"
Waiting
for
searchbar
to
be
removed
"
)
;
await
widgetPromise
;
Assert
.
equal
(
Services
.
prefs
.
getCharPref
(
PREF_NAME
"
"
)
"
"
"
Pref
should
be
cleared
after
removing
searchbar
"
)
;
let
customizedPref
=
"
extension
:
1
"
+
SEARCHBAR_PRESENT_PREF_VALUE
;
Services
.
prefs
.
setCharPref
(
PREF_NAME
customizedPref
)
;
widgetPromise
=
promiseWidget
(
"
onWidgetAdded
"
)
;
CustomizableUI
.
addWidgetToArea
(
SEARCHBAR_WIDGET_ID
CustomizableUI
.
AREA_NAVBAR
)
;
info
(
"
Waiting
for
searchbar
to
be
added
"
)
;
await
widgetPromise
;
Assert
.
equal
(
Services
.
prefs
.
getCharPref
(
PREF_NAME
)
customizedPref
"
Customized
pref
should
remain
same
after
adding
searchbar
"
)
;
widgetPromise
=
promiseWidget
(
"
onWidgetRemoved
"
)
;
CustomizableUI
.
removeWidgetFromArea
(
SEARCHBAR_WIDGET_ID
)
;
info
(
"
Waiting
for
searchbar
to
be
removed
"
)
;
await
widgetPromise
;
Assert
.
equal
(
Services
.
prefs
.
getCharPref
(
PREF_NAME
)
customizedPref
"
Customized
pref
should
remain
same
after
removing
searchbar
"
)
;
Services
.
prefs
.
clearUserPref
(
PREF_NAME
)
;
}
)
;
function
promiseWidget
(
observerName
)
{
return
new
Promise
(
resolve
=
>
{
let
listener
=
{
}
;
listener
[
observerName
]
=
widgetID
=
>
{
if
(
widgetID
=
=
SEARCHBAR_WIDGET_ID
)
{
CustomizableUI
.
removeListener
(
listener
)
;
executeSoon
(
resolve
)
;
}
}
;
CustomizableUI
.
addListener
(
listener
)
;
}
)
;
}
