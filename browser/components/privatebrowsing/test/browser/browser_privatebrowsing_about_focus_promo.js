const
{
Region
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
Region
.
sys
.
mjs
"
)
;
const
{
ASRouter
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouter
.
jsm
"
)
;
const
initialHomeRegion
=
Region
.
_home
;
const
intialCurrentRegion
=
Region
.
_current
;
const
initialLocale
=
Services
.
locale
.
appLocaleAsBCP47
;
async
function
setupRegions
(
home
current
)
{
Region
.
_setHomeRegion
(
home
|
|
"
"
)
;
Region
.
_setCurrentRegion
(
current
|
|
"
"
)
;
}
function
setLocale
(
locale
)
{
Services
.
locale
.
availableLocales
=
[
locale
]
;
Services
.
locale
.
requestedLocales
=
[
locale
]
;
}
add_task
(
async
function
test_focus_promo_in_allowed_region
(
)
{
ASRouter
.
resetMessageState
(
)
;
const
allowedRegion
=
"
ES
"
;
setupRegions
(
allowedRegion
allowedRegion
)
;
const
{
win
tab
}
=
await
openTabAndWaitForRender
(
)
;
await
SpecialPowers
.
spawn
(
tab
[
]
async
function
(
)
{
const
promoContainer
=
content
.
document
.
querySelector
(
"
.
promo
"
)
;
ok
(
promoContainer
"
Focus
promo
is
shown
for
allowed
region
"
)
;
}
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
setupRegions
(
initialHomeRegion
intialCurrentRegion
)
;
}
)
;
add_task
(
async
function
test_focus_promo_in_disallowed_region
(
)
{
ASRouter
.
resetMessageState
(
)
;
const
disallowedRegion
=
"
CN
"
;
setupRegions
(
disallowedRegion
)
;
const
{
win
tab
}
=
await
openTabAndWaitForRender
(
)
;
await
SpecialPowers
.
spawn
(
tab
[
]
async
function
(
)
{
const
promoContainer
=
content
.
document
.
querySelector
(
"
.
promo
"
)
;
ok
(
!
promoContainer
"
Focus
promo
is
not
shown
for
disallowed
region
"
)
;
}
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
setupRegions
(
initialHomeRegion
intialCurrentRegion
)
;
}
)
;
add_task
(
async
function
test_klar_promo_in_certain_regions_with_English_locale
(
)
{
const
testLocale
=
"
en
-
US
"
;
setLocale
(
testLocale
)
;
const
testRegion
=
async
region
=
>
{
setupRegions
(
region
)
;
ASRouter
.
resetMessageState
(
)
;
const
{
win
tab
}
=
await
openTabAndWaitForRender
(
)
;
await
SpecialPowers
.
spawn
(
tab
[
]
async
function
(
)
{
const
buttonText
=
content
.
document
.
querySelector
(
"
#
private
-
browsing
-
promo
-
link
"
)
.
textContent
;
Assert
.
equal
(
buttonText
"
Download
Firefox
Klar
"
"
The
promo
button
text
reads
'
Download
Firefox
Klar
'
"
)
;
}
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
;
await
testRegion
(
"
AT
"
)
;
await
testRegion
(
"
DE
"
)
;
await
testRegion
(
"
CH
"
)
;
setupRegions
(
initialHomeRegion
intialCurrentRegion
)
;
setLocale
(
initialLocale
)
;
}
)
;
