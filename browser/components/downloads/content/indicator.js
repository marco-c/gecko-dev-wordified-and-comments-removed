"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
const
DownloadsButton
=
{
get
_placeholder
(
)
{
return
document
.
getElementById
(
"
downloads
-
button
"
)
;
}
_customizing
:
false
initializeIndicator
(
)
{
DownloadsIndicatorView
.
ensureInitialized
(
)
;
}
_getAnchorInternal
(
)
{
let
indicator
=
DownloadsIndicatorView
.
indicator
;
if
(
!
indicator
)
{
return
null
;
}
indicator
.
open
=
this
.
_anchorRequested
;
let
widget
=
CustomizableUI
.
getWidget
(
"
downloads
-
button
"
)
;
if
(
!
isElementVisible
(
indicator
.
parentNode
)
&
&
widget
.
areaType
=
=
CustomizableUI
.
TYPE_TOOLBAR
)
{
return
null
;
}
return
DownloadsIndicatorView
.
indicatorAnchor
;
}
_anchorRequested
:
false
getAnchor
(
)
{
if
(
this
.
_customizing
)
{
return
null
;
}
this
.
_anchorRequested
=
true
;
return
this
.
_getAnchorInternal
(
)
;
}
releaseAnchor
(
)
{
this
.
_anchorRequested
=
false
;
this
.
_getAnchorInternal
(
)
;
}
unhide
(
includePalette
=
false
)
{
let
button
=
this
.
_placeholder
;
if
(
!
button
&
&
includePalette
)
{
button
=
gNavToolbox
.
palette
.
querySelector
(
"
#
downloads
-
button
"
)
;
}
if
(
button
&
&
button
.
hasAttribute
(
"
hidden
"
)
)
{
button
.
removeAttribute
(
"
hidden
"
)
;
if
(
this
.
_navBar
.
contains
(
button
)
)
{
this
.
_navBar
.
setAttribute
(
"
downloadsbuttonshown
"
"
true
"
)
;
}
}
}
hide
(
)
{
let
button
=
this
.
_placeholder
;
if
(
this
.
autoHideDownloadsButton
&
&
button
&
&
button
.
closest
(
"
toolbar
"
)
)
{
DownloadsPanel
.
hidePanel
(
)
;
button
.
setAttribute
(
"
hidden
"
"
true
"
)
;
this
.
_navBar
.
removeAttribute
(
"
downloadsbuttonshown
"
)
;
}
}
startAutoHide
(
)
{
if
(
DownloadsIndicatorView
.
hasDownloads
)
{
this
.
unhide
(
)
;
}
else
{
this
.
hide
(
)
;
}
}
checkForAutoHide
(
)
{
let
button
=
this
.
_placeholder
;
if
(
!
this
.
_customizing
&
&
this
.
autoHideDownloadsButton
&
&
button
&
&
button
.
closest
(
"
toolbar
"
)
)
{
this
.
startAutoHide
(
)
;
}
else
{
this
.
unhide
(
)
;
}
}
onWidgetAfterDOMChange
(
node
)
{
if
(
node
=
=
this
.
_placeholder
)
{
this
.
checkForAutoHide
(
)
;
}
}
onCustomizeStart
(
win
)
{
if
(
win
=
=
window
)
{
this
.
_customizing
=
true
;
this
.
_anchorRequested
=
false
;
this
.
unhide
(
true
)
;
}
}
onCustomizeEnd
(
win
)
{
if
(
win
=
=
window
)
{
this
.
_customizing
=
false
;
this
.
checkForAutoHide
(
)
;
DownloadsIndicatorView
.
afterCustomize
(
)
;
}
}
init
(
)
{
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
autoHideDownloadsButton
"
"
browser
.
download
.
autohideButton
"
true
this
.
checkForAutoHide
.
bind
(
this
)
)
;
CustomizableUI
.
addListener
(
this
)
;
this
.
checkForAutoHide
(
)
;
}
uninit
(
)
{
CustomizableUI
.
removeListener
(
this
)
;
}
get
_tabsToolbar
(
)
{
delete
this
.
_tabsToolbar
;
return
this
.
_tabsToolbar
=
document
.
getElementById
(
"
TabsToolbar
"
)
;
}
get
_navBar
(
)
{
delete
this
.
_navBar
;
return
this
.
_navBar
=
document
.
getElementById
(
"
nav
-
bar
"
)
;
}
}
;
Object
.
defineProperty
(
this
"
DownloadsButton
"
{
value
:
DownloadsButton
enumerable
:
true
writable
:
false
}
)
;
const
DownloadsIndicatorView
=
{
_initialized
:
false
_operational
:
false
ensureInitialized
(
)
{
if
(
this
.
_initialized
)
{
return
;
}
this
.
_initialized
=
true
;
window
.
addEventListener
(
"
unload
"
this
.
onWindowUnload
)
;
DownloadsCommon
.
getIndicatorData
(
window
)
.
addView
(
this
)
;
}
ensureTerminated
(
)
{
if
(
!
this
.
_initialized
)
{
return
;
}
this
.
_initialized
=
false
;
window
.
removeEventListener
(
"
unload
"
this
.
onWindowUnload
)
;
DownloadsCommon
.
getIndicatorData
(
window
)
.
removeView
(
this
)
;
this
.
percentComplete
=
0
;
this
.
attention
=
DownloadsCommon
.
ATTENTION_NONE
;
}
_ensureOperational
(
)
{
if
(
this
.
_operational
)
{
return
;
}
if
(
!
DownloadsButton
.
_placeholder
)
{
return
;
}
this
.
_operational
=
true
;
if
(
this
.
_initialized
)
{
DownloadsCommon
.
getIndicatorData
(
window
)
.
refreshView
(
this
)
;
}
}
_currentNotificationType
:
null
_nextNotificationType
:
null
_isAncestorPanelOpen
(
aNode
)
{
while
(
aNode
&
&
aNode
.
localName
!
=
"
panel
"
)
{
aNode
=
aNode
.
parentNode
;
}
return
aNode
&
&
aNode
.
state
=
=
"
open
"
;
}
showEventNotification
(
aType
)
{
if
(
!
this
.
_initialized
)
{
return
;
}
if
(
!
DownloadsCommon
.
animateNotifications
)
{
return
;
}
if
(
this
.
_currentNotificationType
)
{
if
(
this
.
_currentNotificationType
!
=
aType
)
{
this
.
_nextNotificationType
=
aType
;
}
}
else
{
this
.
_showNotification
(
aType
)
;
}
}
_showNotification
(
aType
)
{
if
(
DownloadsPanel
.
isPanelShowing
)
{
return
;
}
let
anchor
=
DownloadsButton
.
_placeholder
;
let
widgetGroup
=
CustomizableUI
.
getWidget
(
"
downloads
-
button
"
)
;
let
widget
=
widgetGroup
.
forWindow
(
window
)
;
if
(
widgetGroup
.
areaType
=
=
CustomizableUI
.
TYPE_MENU_PANEL
)
{
if
(
anchor
&
&
this
.
_isAncestorPanelOpen
(
anchor
)
)
{
return
;
}
anchor
=
widget
.
anchor
;
}
if
(
!
anchor
|
|
!
isElementVisible
(
anchor
.
parentNode
)
)
{
return
;
}
let
notifier
=
this
.
notifier
;
if
(
aType
=
=
"
start
"
)
{
notifier
.
removeAttribute
(
"
hidden
"
)
;
let
anchorRect
=
anchor
.
getBoundingClientRect
(
)
;
let
notifierRect
=
notifier
.
getBoundingClientRect
(
)
;
let
topDiff
=
anchorRect
.
top
-
notifierRect
.
top
;
let
leftDiff
=
anchorRect
.
left
-
notifierRect
.
left
;
let
heightDiff
=
anchorRect
.
height
-
notifierRect
.
height
;
let
widthDiff
=
anchorRect
.
width
-
notifierRect
.
width
;
let
translateX
=
(
leftDiff
+
.
5
*
widthDiff
)
+
"
px
"
;
let
translateY
=
(
topDiff
+
.
5
*
heightDiff
)
+
"
px
"
;
notifier
.
style
.
transform
=
"
translate
(
"
+
translateX
+
"
"
+
translateY
+
"
)
"
;
notifier
.
setAttribute
(
"
notification
"
aType
)
;
}
anchor
.
setAttribute
(
"
notification
"
aType
)
;
let
animationDuration
;
animationDuration
=
aType
=
=
"
start
"
?
760
:
850
;
this
.
_currentNotificationType
=
aType
;
setTimeout
(
(
)
=
>
{
requestAnimationFrame
(
(
)
=
>
{
notifier
.
setAttribute
(
"
hidden
"
"
true
"
)
;
notifier
.
removeAttribute
(
"
notification
"
)
;
notifier
.
style
.
transform
=
"
"
;
anchor
.
removeAttribute
(
"
notification
"
)
;
requestAnimationFrame
(
(
)
=
>
{
let
nextType
=
this
.
_nextNotificationType
;
this
.
_currentNotificationType
=
null
;
this
.
_nextNotificationType
=
null
;
if
(
nextType
)
{
this
.
_showNotification
(
nextType
)
;
}
}
)
;
}
)
;
}
animationDuration
)
;
}
set
hasDownloads
(
aValue
)
{
if
(
this
.
_hasDownloads
!
=
aValue
|
|
(
!
this
.
_operational
&
&
aValue
)
)
{
this
.
_hasDownloads
=
aValue
;
if
(
aValue
)
{
DownloadsButton
.
unhide
(
)
;
this
.
_ensureOperational
(
)
;
}
else
{
DownloadsButton
.
checkForAutoHide
(
)
;
}
}
return
aValue
;
}
get
hasDownloads
(
)
{
return
this
.
_hasDownloads
;
}
_hasDownloads
:
false
set
percentComplete
(
aValue
)
{
if
(
!
this
.
_operational
)
{
return
this
.
_percentComplete
;
}
if
(
this
.
_percentComplete
!
=
=
aValue
)
{
this
.
_percentComplete
=
aValue
;
this
.
_refreshAttention
(
)
;
if
(
this
.
_percentComplete
>
=
0
)
{
this
.
indicator
.
setAttribute
(
"
progress
"
"
true
"
)
;
this
.
_progressIcon
.
style
.
animationDelay
=
(
-
this
.
_percentComplete
)
+
"
s
"
;
}
else
{
this
.
indicator
.
removeAttribute
(
"
progress
"
)
;
this
.
_progressIcon
.
style
.
animationDelay
=
"
1s
"
;
}
}
return
aValue
;
}
_percentComplete
:
null
set
attention
(
aValue
)
{
if
(
!
this
.
_operational
)
{
return
this
.
_attention
;
}
if
(
this
.
_attention
!
=
aValue
)
{
this
.
_attention
=
aValue
;
this
.
_refreshAttention
(
)
;
}
return
this
.
_attention
;
}
_refreshAttention
(
)
{
let
widgetGroup
=
CustomizableUI
.
getWidget
(
"
downloads
-
button
"
)
;
let
inMenu
=
widgetGroup
.
areaType
=
=
CustomizableUI
.
TYPE_MENU_PANEL
;
let
suppressAttention
=
!
inMenu
&
&
this
.
_attention
=
=
DownloadsCommon
.
ATTENTION_SUCCESS
&
&
this
.
_percentComplete
>
=
0
;
if
(
suppressAttention
|
|
this
.
_attention
=
=
DownloadsCommon
.
ATTENTION_NONE
)
{
this
.
indicator
.
removeAttribute
(
"
attention
"
)
;
}
else
{
this
.
indicator
.
setAttribute
(
"
attention
"
this
.
_attention
)
;
}
}
_attention
:
DownloadsCommon
.
ATTENTION_NONE
onWindowUnload
(
)
{
DownloadsIndicatorView
.
ensureTerminated
(
)
;
}
onCommand
(
aEvent
)
{
if
(
aEvent
.
type
=
=
"
mousedown
"
&
&
aEvent
.
button
!
=
0
)
{
return
;
}
DownloadsPanel
.
showPanel
(
)
;
aEvent
.
stopPropagation
(
)
;
}
onDragOver
(
aEvent
)
{
browserDragAndDrop
.
dragOver
(
aEvent
)
;
}
onDrop
(
aEvent
)
{
let
dt
=
aEvent
.
dataTransfer
;
if
(
dt
.
mozGetDataAt
(
"
application
/
x
-
moz
-
file
"
0
)
)
return
;
let
links
=
browserDragAndDrop
.
dropLinks
(
aEvent
)
;
if
(
!
links
.
length
)
return
;
let
sourceDoc
=
dt
.
mozSourceNode
?
dt
.
mozSourceNode
.
ownerDocument
:
document
;
let
handled
=
false
;
for
(
let
link
of
links
)
{
if
(
link
.
url
.
startsWith
(
"
about
:
"
)
)
continue
;
saveURL
(
link
.
url
link
.
name
null
true
true
null
sourceDoc
)
;
handled
=
true
;
}
if
(
handled
)
{
aEvent
.
preventDefault
(
)
;
}
}
_indicator
:
null
__progressIcon
:
null
get
indicator
(
)
{
if
(
this
.
_indicator
)
{
return
this
.
_indicator
;
}
let
indicator
=
document
.
getElementById
(
"
downloads
-
button
"
)
;
if
(
!
indicator
|
|
indicator
.
getAttribute
(
"
indicator
"
)
!
=
"
true
"
)
{
return
null
;
}
return
this
.
_indicator
=
indicator
;
}
get
indicatorAnchor
(
)
{
let
widgetGroup
=
CustomizableUI
.
getWidget
(
"
downloads
-
button
"
)
;
if
(
widgetGroup
.
areaType
=
=
CustomizableUI
.
TYPE_MENU_PANEL
)
{
let
overflowIcon
=
widgetGroup
.
forWindow
(
window
)
.
anchor
;
return
document
.
getAnonymousElementByAttribute
(
overflowIcon
"
class
"
"
toolbarbutton
-
icon
"
)
;
}
return
document
.
getAnonymousElementByAttribute
(
this
.
indicator
"
class
"
"
toolbarbutton
-
badge
-
stack
"
)
;
}
get
_progressIcon
(
)
{
return
this
.
__progressIcon
|
|
(
this
.
__progressIcon
=
document
.
getElementById
(
"
downloads
-
indicator
-
progress
-
inner
"
)
)
;
}
get
notifier
(
)
{
return
this
.
_notifier
|
|
(
this
.
_notifier
=
document
.
getElementById
(
"
downloads
-
notification
-
anchor
"
)
)
;
}
_onCustomizedAway
(
)
{
this
.
_indicator
=
null
;
this
.
__progressIcon
=
null
;
}
afterCustomize
(
)
{
if
(
this
.
_indicator
!
=
document
.
getElementById
(
"
downloads
-
button
"
)
)
{
this
.
_onCustomizedAway
(
)
;
this
.
_operational
=
false
;
this
.
ensureTerminated
(
)
;
this
.
ensureInitialized
(
)
;
}
}
}
;
Object
.
defineProperty
(
this
"
DownloadsIndicatorView
"
{
value
:
DownloadsIndicatorView
enumerable
:
true
writable
:
false
}
)
;
