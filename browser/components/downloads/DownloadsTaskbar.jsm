"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
DownloadsTaskbar
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
lazy
=
{
}
;
XPCOMUtils
.
defineLazyModuleGetters
(
lazy
{
BrowserWindowTracker
:
"
resource
:
/
/
/
modules
/
BrowserWindowTracker
.
jsm
"
Downloads
:
"
resource
:
/
/
gre
/
modules
/
Downloads
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyGetter
(
lazy
"
gWinTaskbar
"
function
(
)
{
if
(
!
(
"
mozilla
.
org
/
windows
-
taskbar
;
1
"
in
Cc
)
)
{
return
null
;
}
let
winTaskbar
=
Cc
[
"
mozilla
.
org
/
windows
-
taskbar
;
1
"
]
.
getService
(
Ci
.
nsIWinTaskbar
)
;
return
winTaskbar
.
available
&
&
winTaskbar
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
lazy
"
gMacTaskbarProgress
"
function
(
)
{
return
(
"
mozilla
.
org
/
widget
/
macdocksupport
;
1
"
in
Cc
&
&
Cc
[
"
mozilla
.
org
/
widget
/
macdocksupport
;
1
"
]
.
getService
(
Ci
.
nsITaskbarProgress
)
)
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
lazy
"
gGtkTaskbarProgress
"
function
(
)
{
return
(
"
mozilla
.
org
/
widget
/
taskbarprogress
/
gtk
;
1
"
in
Cc
&
&
Cc
[
"
mozilla
.
org
/
widget
/
taskbarprogress
/
gtk
;
1
"
]
.
getService
(
Ci
.
nsIGtkTaskbarProgress
)
)
;
}
)
;
var
DownloadsTaskbar
=
{
_summary
:
null
_taskbarProgress
:
null
registerIndicator
(
aBrowserWindow
)
{
if
(
!
this
.
_taskbarProgress
)
{
if
(
lazy
.
gMacTaskbarProgress
)
{
this
.
_taskbarProgress
=
lazy
.
gMacTaskbarProgress
;
Services
.
obs
.
addObserver
(
(
)
=
>
{
this
.
_taskbarProgress
=
null
;
lazy
.
gMacTaskbarProgress
=
null
;
}
"
quit
-
application
-
granted
"
)
;
}
else
if
(
lazy
.
gWinTaskbar
)
{
this
.
_attachIndicator
(
aBrowserWindow
)
;
}
else
if
(
lazy
.
gGtkTaskbarProgress
)
{
this
.
_taskbarProgress
=
lazy
.
gGtkTaskbarProgress
;
this
.
_attachGtkTaskbarProgress
(
aBrowserWindow
)
;
}
else
{
return
;
}
}
if
(
!
this
.
_summary
)
{
lazy
.
Downloads
.
getSummary
(
lazy
.
Downloads
.
ALL
)
.
then
(
summary
=
>
{
if
(
this
.
_summary
)
{
return
undefined
;
}
this
.
_summary
=
summary
;
return
this
.
_summary
.
addView
(
this
)
;
}
)
.
catch
(
Cu
.
reportError
)
;
}
}
_attachIndicator
(
aWindow
)
{
let
{
docShell
}
=
aWindow
.
browsingContext
.
topChromeWindow
;
this
.
_taskbarProgress
=
lazy
.
gWinTaskbar
.
getTaskbarProgress
(
docShell
)
;
if
(
this
.
_summary
)
{
this
.
onSummaryChanged
(
)
;
}
aWindow
.
addEventListener
(
"
unload
"
(
)
=
>
{
let
browserWindow
=
lazy
.
BrowserWindowTracker
.
getTopWindow
(
)
;
if
(
browserWindow
)
{
this
.
_attachIndicator
(
browserWindow
)
;
}
else
{
this
.
_taskbarProgress
=
null
;
}
}
)
;
}
_attachGtkTaskbarProgress
(
aWindow
)
{
this
.
_taskbarProgress
.
setPrimaryWindow
(
aWindow
)
;
if
(
this
.
_summary
)
{
this
.
onSummaryChanged
(
)
;
}
aWindow
.
addEventListener
(
"
unload
"
(
)
=
>
{
let
browserWindow
=
lazy
.
BrowserWindowTracker
.
getTopWindow
(
)
;
if
(
browserWindow
)
{
this
.
_attachGtkTaskbarProgress
(
browserWindow
)
;
}
else
{
this
.
_taskbarProgress
=
null
;
}
}
)
;
}
onSummaryChanged
(
)
{
if
(
!
this
.
_taskbarProgress
)
{
return
;
}
if
(
this
.
_summary
.
allHaveStopped
|
|
this
.
_summary
.
progressTotalBytes
=
=
0
)
{
this
.
_taskbarProgress
.
setProgressState
(
Ci
.
nsITaskbarProgress
.
STATE_NO_PROGRESS
0
0
)
;
}
else
if
(
this
.
_summary
.
allUnknownSize
)
{
this
.
_taskbarProgress
.
setProgressState
(
Ci
.
nsITaskbarProgress
.
STATE_INDETERMINATE
0
0
)
;
}
else
{
let
progressCurrentBytes
=
Math
.
min
(
this
.
_summary
.
progressTotalBytes
this
.
_summary
.
progressCurrentBytes
)
;
this
.
_taskbarProgress
.
setProgressState
(
Ci
.
nsITaskbarProgress
.
STATE_NORMAL
progressCurrentBytes
this
.
_summary
.
progressTotalBytes
)
;
}
}
}
;
