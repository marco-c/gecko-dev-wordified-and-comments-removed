const
path
=
require
(
"
path
"
)
;
const
projectRoot
=
path
.
join
(
process
.
cwd
(
)
"
.
.
/
.
.
/
.
.
"
)
;
const
rewriteChromeUri
=
require
(
"
.
/
chrome
-
uri
-
utils
.
js
"
)
;
function
getReferencedChromeUris
(
source
)
{
const
chromeRegex
=
/
chrome
:
\
/
\
/
.
*
?
\
.
css
/
g
;
const
matches
=
new
Set
(
)
;
for
(
let
match
of
source
.
matchAll
(
chromeRegex
)
)
{
matches
.
add
(
match
[
0
]
)
;
}
return
[
.
.
.
matches
]
;
}
async
function
rewriteChromeUris
(
source
)
{
const
chromeUriToLocalPath
=
new
Map
(
)
;
let
chromeDependencies
=
getReferencedChromeUris
(
source
)
;
for
(
let
chromeUri
of
chromeDependencies
)
{
let
localRelativePath
=
rewriteChromeUri
(
chromeUri
)
;
if
(
localRelativePath
)
{
localRelativePath
=
localRelativePath
.
replaceAll
(
"
\
\
"
"
/
"
)
;
chromeUriToLocalPath
.
set
(
chromeUri
localRelativePath
)
;
this
.
addMissingDependency
(
path
.
join
(
projectRoot
localRelativePath
)
)
;
}
}
let
rewrittenSource
=
source
;
for
(
let
[
chromeUri
localPath
]
of
chromeUriToLocalPath
.
entries
(
)
)
{
let
cssImport
=
__chrome_styles_loader__
{
path
.
basename
(
localPath
"
.
css
"
)
.
replaceAll
(
"
-
"
"
"
)
}
Styles
;
if
(
path
.
basename
(
this
.
resourcePath
)
=
=
"
moz
-
label
.
mjs
"
|
|
this
.
resourcePath
.
endsWith
(
"
.
js
"
)
)
{
rewrittenSource
=
rewrittenSource
.
replaceAll
(
"
{
chromeUri
}
"
cssImport
)
;
}
else
{
rewrittenSource
=
rewrittenSource
.
replaceAll
(
chromeUri
\
\
{
{
cssImport
}
\
}
)
;
}
rewrittenSource
=
import
{
cssImport
}
from
"
{
localPath
}
"
;
\
n
+
rewrittenSource
;
}
return
rewrittenSource
;
}
module
.
exports
=
async
function
chromeUriLoader
(
source
)
{
const
callback
=
this
.
async
(
)
;
const
newSource
=
await
rewriteChromeUris
.
call
(
this
source
)
;
callback
(
null
newSource
)
;
}
;
