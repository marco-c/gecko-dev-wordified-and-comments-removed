const
path
=
require
(
"
path
"
)
;
const
projectRoot
=
path
.
resolve
(
__dirname
"
.
.
/
.
.
/
.
.
/
.
.
/
"
)
;
const
{
rewriteChromeUri
rewriteMozSrcUri
}
=
require
(
"
.
/
moz
-
uri
-
utils
.
js
"
)
;
function
getReferencedCssUris
(
source
)
{
const
cssRegexes
=
[
/
chrome
:
\
/
\
/
.
*
?
\
.
css
/
g
/
moz
-
src
:
\
/
\
/
\
/
.
*
?
\
.
css
/
g
]
;
const
matches
=
new
Set
(
)
;
for
(
let
regex
of
cssRegexes
)
{
for
(
let
match
of
source
.
matchAll
(
regex
)
)
{
matches
.
add
(
match
[
0
]
)
;
}
}
return
[
.
.
.
matches
]
;
}
function
resolveCssUri
(
cssUri
resourcePath
)
{
let
localPath
=
"
"
;
let
dependencyPath
=
"
"
;
if
(
cssUri
.
startsWith
(
"
chrome
:
/
/
"
)
)
{
localPath
=
rewriteChromeUri
(
cssUri
)
;
if
(
localPath
)
{
dependencyPath
=
path
.
join
(
projectRoot
localPath
)
;
}
}
if
(
cssUri
.
startsWith
(
"
moz
-
src
:
/
/
/
"
)
)
{
const
absolutePath
=
rewriteMozSrcUri
(
cssUri
)
;
if
(
absolutePath
)
{
localPath
=
path
.
relative
(
path
.
dirname
(
resourcePath
)
absolutePath
)
;
if
(
!
localPath
.
startsWith
(
"
.
"
)
)
{
localPath
=
.
/
{
localPath
}
;
}
dependencyPath
=
absolutePath
;
}
}
return
{
localPath
dependencyPath
}
;
}
async
function
rewriteCssUris
(
source
)
{
const
cssUriToLocalPath
=
new
Map
(
)
;
let
cssDependencies
=
getReferencedCssUris
(
source
)
;
for
(
let
cssUri
of
cssDependencies
)
{
const
{
localPath
dependencyPath
}
=
resolveCssUri
(
cssUri
this
.
resourcePath
)
;
if
(
localPath
)
{
cssUriToLocalPath
.
set
(
cssUri
localPath
)
;
this
.
addMissingDependency
(
dependencyPath
)
;
}
}
let
rewrittenSource
=
source
;
for
(
let
[
cssUri
localPath
]
of
cssUriToLocalPath
.
entries
(
)
)
{
let
cssImport
=
__chrome_styles_loader__
{
path
.
basename
(
localPath
"
.
css
"
)
.
replaceAll
(
"
-
"
"
"
)
}
Styles
;
if
(
path
.
basename
(
this
.
resourcePath
)
=
=
"
moz
-
label
.
mjs
"
|
|
this
.
resourcePath
.
endsWith
(
"
.
js
"
)
)
{
rewrittenSource
=
rewrittenSource
.
replaceAll
(
"
{
cssUri
}
"
cssImport
)
;
}
else
{
rewrittenSource
=
rewrittenSource
.
replaceAll
(
cssUri
\
\
{
{
cssImport
}
\
}
)
;
}
rewrittenSource
=
import
{
cssImport
}
from
"
{
localPath
}
"
;
\
n
+
rewrittenSource
;
}
return
rewrittenSource
;
}
module
.
exports
=
async
function
mozUriLoader
(
source
)
{
const
callback
=
this
.
async
(
)
;
const
newSource
=
await
rewriteCssUris
.
call
(
this
source
)
;
callback
(
null
newSource
)
;
}
;
