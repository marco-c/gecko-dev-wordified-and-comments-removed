ChromeUtils
.
defineModuleGetter
(
this
"
PrivateBrowsingUtils
"
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
ReaderMode
"
"
resource
:
/
/
gre
/
modules
/
ReaderMode
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
pktApi
"
"
chrome
:
/
/
pocket
/
content
/
pktApi
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
pktTelemetry
"
"
chrome
:
/
/
pocket
/
content
/
pktTelemetry
.
jsm
"
)
;
const
POCKET_ONSAVERECS_PREF
=
"
extensions
.
pocket
.
onSaveRecs
"
;
const
POCKET_ONSAVERECS_LOCLES_PREF
=
"
extensions
.
pocket
.
onSaveRecs
.
locales
"
;
var
pktUI
=
(
function
(
)
{
var
_panelId
=
0
;
let
_titleToSave
=
"
"
;
let
_urlToSave
=
"
"
;
const
initialPanelSize
=
{
signup
:
{
control
:
{
height
:
442
width
:
300
}
button_control
:
{
height
:
442
width
:
300
}
variant_a
:
{
height
:
408
width
:
300
}
variant_b
:
{
height
:
383
width
:
300
}
variant_c
:
{
height
:
424
width
:
300
}
button_variant
:
{
height
:
388
width
:
300
}
}
saved
:
{
control
:
{
height
:
133
width
:
350
}
}
}
;
var
onSaveRecsEnabledPref
;
var
onSaveRecsLocalesPref
;
function
initPrefs
(
)
{
onSaveRecsEnabledPref
=
Services
.
prefs
.
getBoolPref
(
POCKET_ONSAVERECS_PREF
false
)
;
onSaveRecsLocalesPref
=
Services
.
prefs
.
getStringPref
(
POCKET_ONSAVERECS_LOCLES_PREF
"
"
)
;
}
initPrefs
(
)
;
function
tryToSaveCurrentPage
(
)
{
tryToSaveUrl
(
getCurrentUrl
(
)
getCurrentTitle
(
)
)
;
}
function
tryToSaveUrl
(
url
title
)
{
if
(
typeof
url
!
=
=
"
undefined
"
&
&
url
.
startsWith
(
"
about
:
reader
?
url
=
"
)
)
{
url
=
ReaderMode
.
getOriginalUrl
(
url
)
;
}
if
(
pktApi
.
isUserLoggedIn
(
)
)
{
_titleToSave
=
title
;
_urlToSave
=
url
;
saveAndShowConfirmation
(
)
;
return
;
}
showSignUp
(
)
;
}
function
showSignUp
(
)
{
if
(
pktApi
.
getSignupPanelTabTestVariant
(
)
=
=
"
v2
"
)
{
let
site
=
Services
.
prefs
.
getCharPref
(
"
extensions
.
pocket
.
site
"
)
;
openTabWithUrl
(
"
https
:
/
/
"
+
site
+
"
/
firefox_learnmore
?
s
=
ffi
&
t
=
autoredirect
&
tv
=
page_learnmore
&
src
=
ff_ext
"
Services
.
scriptSecurityManager
.
createNullPrincipal
(
{
}
)
null
)
;
getPanel
(
)
.
hidePopup
(
)
;
return
;
}
getFirefoxAccountSignedInUser
(
function
(
userdata
)
{
var
controlvariant
=
pktApi
.
getSignupPanelTabTestVariant
(
)
=
=
"
control
"
;
var
variant
=
"
storyboard_lm
"
;
const
loggedOutVariant
=
Services
.
prefs
.
getCharPref
(
"
extensions
.
pocket
.
loggedOutVariant
"
)
|
|
"
control
"
;
let
sizes
=
initialPanelSize
.
signup
.
control
;
if
(
loggedOutVariant
&
&
initialPanelSize
.
signup
[
loggedOutVariant
]
)
{
sizes
=
initialPanelSize
.
signup
[
loggedOutVariant
]
;
}
showPanel
(
"
about
:
pocket
-
signup
?
pockethost
=
"
+
Services
.
prefs
.
getCharPref
(
"
extensions
.
pocket
.
site
"
)
+
"
&
loggedOutVariant
=
"
+
loggedOutVariant
+
"
&
variant
=
"
+
variant
+
"
&
controlvariant
=
"
+
controlvariant
+
"
&
locale
=
"
+
getUILocale
(
)
sizes
)
;
}
)
;
}
function
getAndShowRecsForItem
(
item
options
)
{
var
onSaveRecsEnabled
=
onSaveRecsEnabledPref
&
&
onSaveRecsLocalesPref
.
includes
(
getUILocale
(
)
)
;
if
(
onSaveRecsEnabled
&
&
item
&
&
item
.
resolved_id
&
&
item
.
resolved_id
!
=
=
"
0
"
)
{
pktApi
.
getRecsForItem
(
item
.
resolved_id
options
)
;
}
}
function
saveAndShowConfirmation
(
)
{
getFirefoxAccountSignedInUser
(
function
(
userdata
)
{
const
variant
=
"
control
"
;
const
sizes
=
initialPanelSize
.
saved
[
variant
]
;
showPanel
(
"
about
:
pocket
-
saved
?
pockethost
=
"
+
Services
.
prefs
.
getCharPref
(
"
extensions
.
pocket
.
site
"
)
+
"
&
premiumStatus
=
"
+
(
pktApi
.
isPremiumUser
(
)
?
"
1
"
:
"
0
"
)
+
"
&
fxasignedin
=
"
+
(
typeof
userdata
=
=
"
object
"
&
&
userdata
!
=
=
null
?
"
1
"
:
"
0
"
)
+
"
&
locale
=
"
+
getUILocale
(
)
sizes
)
;
}
)
;
}
function
showPanel
(
url
options
)
{
_panelId
+
=
1
;
url
+
=
"
&
panelId
=
"
+
_panelId
;
resizePanel
(
{
width
:
options
.
width
height
:
options
.
height
}
)
;
var
iframe
=
getPanelFrame
(
)
;
iframe
.
setAttribute
(
"
src
"
url
)
;
}
function
onShowSignup
(
)
{
pktTelemetry
.
sendStructuredIngestionEvent
(
pktTelemetry
.
createPingPayload
(
{
events
:
[
{
action
:
"
click
"
source
:
"
save_button
"
}
]
}
)
)
;
}
function
onShowSaved
(
)
{
var
saveLinkMessageId
=
"
PKT_saveLink
"
;
getPanelFrame
(
)
.
setAttribute
(
"
itemAdded
"
"
false
"
)
;
if
(
!
isValidURL
(
)
)
{
let
error
=
{
message
:
"
Only
links
can
be
saved
"
localizedKey
:
"
onlylinkssaved
"
}
;
pktUIMessaging
.
sendErrorMessageToPanel
(
saveLinkMessageId
_panelId
error
)
;
return
;
}
if
(
!
navigator
.
onLine
)
{
let
error
=
{
message
:
"
You
must
be
connected
to
the
Internet
in
order
to
save
to
Pocket
.
Please
connect
to
the
Internet
and
try
again
.
"
}
;
pktUIMessaging
.
sendErrorMessageToPanel
(
saveLinkMessageId
_panelId
error
)
;
return
;
}
pktTelemetry
.
sendStructuredIngestionEvent
(
pktTelemetry
.
createPingPayload
(
{
events
:
[
{
action
:
"
click
"
source
:
"
save_button
"
}
]
}
)
)
;
var
options
=
{
success
(
data
request
)
{
var
item
=
data
.
item
;
var
ho2
=
data
.
ho2
;
var
accountState
=
data
.
account_state
;
var
displayName
=
data
.
display_name
;
var
successResponse
=
{
status
:
"
success
"
accountState
displayName
item
ho2
}
;
pktUIMessaging
.
sendMessageToPanel
(
saveLinkMessageId
_panelId
successResponse
)
;
getPanelFrame
(
)
.
setAttribute
(
"
itemAdded
"
"
true
"
)
;
getAndShowRecsForItem
(
item
{
success
(
data
)
{
pktUIMessaging
.
sendMessageToPanel
(
"
PKT_renderItemRecs
"
_panelId
data
)
;
if
(
data
?
.
recommendations
?
.
[
0
]
?
.
experiment
)
{
const
payload
=
pktTelemetry
.
createPingPayload
(
{
model
:
data
.
recommendations
[
0
]
.
experiment
events
:
data
.
recommendations
.
map
(
(
item
index
)
=
>
(
{
action
:
"
impression
"
position
:
index
source
:
"
on_save_recs
"
}
)
)
}
)
;
pktTelemetry
.
sendStructuredIngestionEvent
(
payload
)
;
}
}
}
)
;
}
error
(
error
request
)
{
if
(
request
.
status
=
=
=
401
)
{
showSignUp
(
)
;
return
;
}
var
errorMessage
=
error
.
message
|
|
"
There
was
an
error
when
trying
to
save
to
Pocket
.
"
;
var
panelError
=
{
message
:
errorMessage
}
;
pktUIMessaging
.
sendErrorMessageToPanel
(
saveLinkMessageId
_panelId
panelError
)
;
}
}
;
if
(
typeof
_titleToSave
!
=
=
"
undefined
"
)
{
options
.
title
=
_titleToSave
;
}
pktApi
.
addLink
(
_urlToSave
options
)
;
}
function
resizePanel
(
options
=
{
}
)
{
var
iframe
=
getPanelFrame
(
)
;
iframe
.
style
.
width
=
options
.
width
+
"
px
"
;
iframe
.
style
.
height
=
options
.
height
+
"
px
"
;
}
function
openTabWithUrl
(
url
aTriggeringPrincipal
aCsp
)
{
let
recentWindow
=
Services
.
wm
.
getMostRecentWindow
(
"
navigator
:
browser
"
)
;
if
(
!
recentWindow
)
{
Cu
.
reportError
(
"
Pocket
:
No
open
browser
windows
to
openTabWithUrl
"
)
;
return
;
}
if
(
!
PrivateBrowsingUtils
.
isWindowPrivate
(
recentWindow
)
|
|
PrivateBrowsingUtils
.
permanentPrivateBrowsing
)
{
recentWindow
.
openWebLinkIn
(
url
"
tab
"
{
triggeringPrincipal
:
aTriggeringPrincipal
csp
:
aCsp
}
)
;
return
;
}
for
(
let
win
of
Services
.
wm
.
getEnumerator
(
"
navigator
:
browser
"
)
)
{
if
(
!
PrivateBrowsingUtils
.
isWindowPrivate
(
win
)
)
{
win
.
openWebLinkIn
(
url
"
tab
"
{
triggeringPrincipal
:
aTriggeringPrincipal
csp
:
aCsp
}
)
;
return
;
}
}
recentWindow
.
openWebLinkIn
(
url
"
window
"
{
triggeringPrincipal
:
aTriggeringPrincipal
csp
:
aCsp
}
)
;
}
function
onOpenTabWithUrl
(
panelId
data
contentPrincipal
csp
)
{
try
{
urlSecurityCheck
(
data
.
url
contentPrincipal
Services
.
scriptSecurityManager
.
DISALLOW_INHERIT_PRINCIPAL
)
;
}
catch
(
ex
)
{
return
;
}
if
(
data
.
source
)
{
const
payload
=
pktTelemetry
.
createPingPayload
(
{
events
:
[
{
action
:
"
click
"
source
:
data
.
source
}
]
}
)
;
pktTelemetry
.
sendStructuredIngestionEvent
(
payload
)
;
}
var
url
=
data
.
url
;
openTabWithUrl
(
url
contentPrincipal
csp
)
;
}
function
onOpenTabWithPocketUrl
(
panelId
data
contentPrincipal
csp
)
{
try
{
urlSecurityCheck
(
data
.
url
contentPrincipal
Services
.
scriptSecurityManager
.
DISALLOW_INHERIT_PRINCIPAL
)
;
}
catch
(
ex
)
{
return
;
}
const
{
url
position
model
}
=
data
;
if
(
model
&
&
(
position
|
|
position
=
=
=
0
)
)
{
const
payload
=
pktTelemetry
.
createPingPayload
(
{
model
events
:
[
{
action
:
"
click
"
position
source
:
"
on_save_recs
"
}
]
}
)
;
pktTelemetry
.
sendStructuredIngestionEvent
(
payload
)
;
}
openTabWithUrl
(
url
contentPrincipal
csp
)
;
}
function
getCurrentUrl
(
)
{
return
gBrowser
.
currentURI
.
spec
;
}
function
getCurrentTitle
(
)
{
return
gBrowser
.
contentTitle
;
}
function
closePanel
(
)
{
getPanel
(
)
.
hidePopup
(
)
;
}
function
getPanel
(
)
{
var
frame
=
getPanelFrame
(
)
;
var
panel
=
frame
;
while
(
panel
&
&
panel
.
localName
!
=
"
panel
"
)
{
panel
=
panel
.
parentNode
;
}
return
panel
;
}
var
photonPageActionPanelFrame
;
function
setPhotonPageActionPanelFrame
(
frame
)
{
photonPageActionPanelFrame
=
frame
;
}
function
getPanelFrame
(
)
{
return
photonPageActionPanelFrame
;
}
function
isValidURL
(
)
{
return
(
typeof
_urlToSave
!
=
=
"
undefined
"
&
&
(
_urlToSave
.
startsWith
(
"
http
"
)
|
|
_urlToSave
.
startsWith
(
"
https
"
)
)
)
;
}
function
getFirefoxAccountSignedInUser
(
callback
)
{
fxAccounts
.
getSignedInUser
(
)
.
then
(
userData
=
>
{
callback
(
userData
)
;
}
)
.
then
(
null
error
=
>
{
callback
(
)
;
}
)
;
}
function
getUILocale
(
)
{
return
Services
.
locale
.
appLocaleAsBCP47
;
}
return
{
setPhotonPageActionPanelFrame
getPanelFrame
initPrefs
openTabWithUrl
onOpenTabWithUrl
onOpenTabWithPocketUrl
onShowSaved
onShowSignup
getAndShowRecsForItem
tryToSaveUrl
tryToSaveCurrentPage
resizePanel
closePanel
}
;
}
)
(
)
;
var
pktUIMessaging
=
(
function
(
)
{
function
sendMessageToPanel
(
messageId
panelId
payload
)
{
if
(
!
isPanelIdValid
(
panelId
)
)
{
return
;
}
var
panelFrame
=
pktUI
.
getPanelFrame
(
)
;
if
(
!
isPocketPanelFrameValid
(
panelFrame
)
)
{
return
;
}
const
aboutPocketActor
=
panelFrame
?
.
browsingContext
?
.
currentWindowGlobal
?
.
getActor
(
"
AboutPocket
"
)
;
aboutPocketActor
?
.
sendAsyncMessage
(
{
messageId
}
_
{
panelId
}
payload
)
;
}
function
sendErrorMessageToPanel
(
messageId
panelId
error
)
{
var
errorResponse
=
{
status
:
"
error
"
error
}
;
sendMessageToPanel
(
messageId
panelId
errorResponse
)
;
}
function
isPanelIdValid
(
panelId
)
{
if
(
panelId
=
=
=
0
)
{
console
.
warn
(
"
Tried
to
send
message
to
panel
with
id
0
.
"
)
;
return
false
;
}
return
true
;
}
function
isPocketPanelFrameValid
(
panelFrame
)
{
if
(
typeof
panelFrame
=
=
=
"
undefined
"
)
{
console
.
warn
(
"
Pocket
panel
frame
is
undefined
"
)
;
return
false
;
}
var
contentWindow
=
panelFrame
.
contentWindow
;
if
(
typeof
contentWindow
=
=
"
undefined
"
)
{
console
.
warn
(
"
Pocket
panel
frame
content
window
is
undefined
"
)
;
return
false
;
}
var
doc
=
contentWindow
.
document
;
if
(
typeof
doc
=
=
=
"
undefined
"
)
{
console
.
warn
(
"
Pocket
panel
frame
content
window
document
is
undefined
"
)
;
return
false
;
}
var
documentElement
=
doc
.
documentElement
;
if
(
typeof
documentElement
=
=
=
"
undefined
"
)
{
console
.
warn
(
"
Pocket
panel
frame
content
window
document
document
element
is
undefined
"
)
;
return
false
;
}
return
true
;
}
return
{
sendMessageToPanel
sendErrorMessageToPanel
}
;
}
)
(
)
;
