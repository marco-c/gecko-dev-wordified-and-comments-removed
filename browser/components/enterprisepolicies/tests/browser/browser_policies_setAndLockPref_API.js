"
use
strict
"
;
let
{
Policies
setAndLockPref
setDefaultPref
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
policies
/
Policies
.
jsm
"
null
)
;
add_task
(
async
function
test_API_directly
(
)
{
await
setupPolicyEngineWithJson
(
"
"
)
;
setAndLockPref
(
"
policies
.
test
.
boolPref
"
true
)
;
checkLockedPref
(
"
policies
.
test
.
boolPref
"
true
)
;
setAndLockPref
(
"
policies
.
test
.
boolPref
"
false
)
;
checkLockedPref
(
"
policies
.
test
.
boolPref
"
false
)
;
setAndLockPref
(
"
policies
.
test
.
intPref
"
0
)
;
checkLockedPref
(
"
policies
.
test
.
intPref
"
0
)
;
setAndLockPref
(
"
policies
.
test
.
stringPref
"
"
policies
test
"
)
;
checkLockedPref
(
"
policies
.
test
.
stringPref
"
"
policies
test
"
)
;
Services
.
prefs
.
setBoolPref
(
"
policies
.
test
.
boolPref
"
true
)
;
checkLockedPref
(
"
policies
.
test
.
boolPref
"
false
)
;
Services
.
prefs
.
setIntPref
(
"
policies
.
test
.
intPref
"
10
)
;
checkLockedPref
(
"
policies
.
test
.
intPref
"
0
)
;
Services
.
prefs
.
setStringPref
(
"
policies
.
test
.
stringPref
"
"
policies
test
"
)
;
checkLockedPref
(
"
policies
.
test
.
stringPref
"
"
policies
test
"
)
;
try
{
setAndLockPref
(
"
policies
.
test
.
intPref
"
1
.
5
)
;
ok
(
false
"
Integer
value
should
be
rejected
"
)
;
}
catch
(
ex
)
{
ok
(
true
"
Integer
value
was
rejected
"
)
;
}
}
)
;
add_task
(
async
function
test_API_through_policies
(
)
{
Policies
.
bool_policy
=
{
onBeforeUIStartup
(
manager
param
)
{
setAndLockPref
(
"
policies
.
test2
.
boolPref
"
param
)
;
}
}
;
Policies
.
int_policy
=
{
onBeforeUIStartup
(
manager
param
)
{
setAndLockPref
(
"
policies
.
test2
.
intPref
"
param
)
;
}
}
;
Policies
.
string_policy
=
{
onBeforeUIStartup
(
manager
param
)
{
setAndLockPref
(
"
policies
.
test2
.
stringPref
"
param
)
;
}
}
;
await
setupPolicyEngineWithJson
(
{
"
policies
"
:
{
"
bool_policy
"
:
true
"
int_policy
"
:
42
"
string_policy
"
:
"
policies
test
2
"
}
}
{
properties
:
{
"
bool_policy
"
:
{
"
type
"
:
"
boolean
"
}
"
int_policy
"
:
{
"
type
"
:
"
integer
"
}
"
string_policy
"
:
{
"
type
"
:
"
string
"
}
}
}
)
;
is
(
Services
.
policies
.
status
Ci
.
nsIEnterprisePolicies
.
ACTIVE
"
Engine
is
active
"
)
;
checkLockedPref
(
"
policies
.
test2
.
boolPref
"
true
)
;
checkLockedPref
(
"
policies
.
test2
.
intPref
"
42
)
;
checkLockedPref
(
"
policies
.
test2
.
stringPref
"
"
policies
test
2
"
)
;
delete
Policies
.
bool_policy
;
delete
Policies
.
int_policy
;
delete
Policies
.
string_policy
;
}
)
;
add_task
(
async
function
test_pref_tracker
(
)
{
let
defaults
=
Services
.
prefs
.
getDefaultBranch
(
"
"
)
;
defaults
.
setIntPref
(
"
test1
.
pref1
"
10
)
;
defaults
.
setStringPref
(
"
test1
.
pref2
"
"
test
"
)
;
setAndLockPref
(
"
test1
.
pref1
"
20
)
;
setDefaultPref
(
"
test1
.
pref2
"
"
NEW
VALUE
"
)
;
setAndLockPref
(
"
test1
.
pref3
"
"
NEW
VALUE
"
)
;
setDefaultPref
(
"
test1
.
pref4
"
20
)
;
PoliciesPrefTracker
.
restoreDefaultValues
(
)
;
is
(
Services
.
prefs
.
getIntPref
(
"
test1
.
pref1
"
)
10
"
Expected
value
for
test1
.
pref1
"
)
;
is
(
Services
.
prefs
.
getStringPref
(
"
test1
.
pref2
"
)
"
test
"
"
Expected
value
for
test1
.
pref2
"
)
;
is
(
Services
.
prefs
.
prefIsLocked
(
"
test1
.
pref1
"
)
false
"
test1
.
pref1
got
unlocked
"
)
;
is
(
Services
.
prefs
.
getStringPref
(
"
test1
.
pref3
"
undefined
)
undefined
"
test1
.
pref3
should
have
had
its
value
unset
"
)
;
is
(
Services
.
prefs
.
getIntPref
(
"
test1
.
pref4
"
-
1
)
-
1
"
test1
.
pref4
should
have
had
its
value
unset
"
)
;
defaults
.
setIntPref
(
"
test2
.
pref1
"
10
)
;
Services
.
prefs
.
setIntPref
(
"
test2
.
pref1
"
20
)
;
setAndLockPref
(
"
test2
.
pref1
"
20
)
;
PoliciesPrefTracker
.
restoreDefaultValues
(
)
;
is
(
Services
.
prefs
.
getIntPref
(
"
test2
.
pref1
"
)
20
"
Correct
user
value
"
)
;
is
(
defaults
.
getIntPref
(
"
test2
.
pref1
"
)
10
"
Correct
default
value
"
)
;
is
(
Services
.
prefs
.
prefIsLocked
(
"
test2
.
pref1
"
)
false
"
felipe
pref
is
not
locked
"
)
;
}
)
;
