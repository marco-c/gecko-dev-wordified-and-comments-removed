"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
FileTestUtils
"
"
resource
:
/
/
testing
-
common
/
FileTestUtils
.
jsm
"
)
;
this
.
EXPORTED_SYMBOLS
=
[
"
EnterprisePolicyTesting
"
]
;
this
.
EnterprisePolicyTesting
=
{
setupPolicyEngineWithJson
:
async
function
setupPolicyEngineWithJson
(
json
customSchema
)
{
let
filePath
;
if
(
typeof
(
json
)
=
=
"
object
"
)
{
filePath
=
FileTestUtils
.
getTempFile
(
"
policies
.
json
"
)
.
path
;
await
OS
.
File
.
writeAtomic
(
filePath
JSON
.
stringify
(
json
)
{
encoding
:
"
utf
-
8
"
}
)
;
}
else
{
filePath
=
json
;
}
Services
.
prefs
.
setStringPref
(
"
browser
.
policies
.
alternatePath
"
filePath
)
;
let
promise
=
new
Promise
(
resolve
=
>
{
Services
.
obs
.
addObserver
(
function
observer
(
)
{
Services
.
obs
.
removeObserver
(
observer
"
EnterprisePolicies
:
AllPoliciesApplied
"
)
;
dump
(
bytesized
:
setupPolicyEngineWithJson
resolving
)
;
resolve
(
)
;
}
"
EnterprisePolicies
:
AllPoliciesApplied
"
)
;
}
)
;
Cu
.
unload
(
"
resource
:
/
/
/
modules
/
policies
/
schema
.
jsm
"
)
;
if
(
customSchema
)
{
let
schemaModule
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
policies
/
schema
.
jsm
"
{
}
)
;
schemaModule
.
schema
=
customSchema
;
}
Services
.
obs
.
notifyObservers
(
null
"
EnterprisePolicies
:
Restart
"
)
;
return
promise
;
}
resetRunOnceState
:
function
resetRunOnceState
(
)
{
const
runOnceBaseKeys
=
[
"
browser
.
policies
.
runonce
.
"
"
browser
.
policies
.
runOncePerModification
.
"
]
;
for
(
let
base
of
runOnceBaseKeys
)
{
for
(
let
key
of
Services
.
prefs
.
getChildList
(
base
{
}
)
)
{
if
(
Services
.
prefs
.
prefHasUserValue
(
key
)
)
Services
.
prefs
.
clearUserPref
(
key
)
;
}
}
}
}
;
