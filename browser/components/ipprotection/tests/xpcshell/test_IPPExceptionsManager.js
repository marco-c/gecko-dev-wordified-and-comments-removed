"
use
strict
"
;
const
{
IPPExceptionsManager
}
=
ChromeUtils
.
importESModule
(
"
moz
-
src
:
/
/
/
browser
/
components
/
ipprotection
/
IPPExceptionsManager
.
sys
.
mjs
"
)
;
const
ONBOARDING_MESSAGE_MASK_PREF
=
"
browser
.
ipProtection
.
onboardingMessageMask
"
;
add_task
(
async
function
test_IPPExceptionsManager_exclusions
(
)
{
const
site1
=
"
https
:
/
/
www
.
example
.
com
"
;
const
site2
=
"
https
:
/
/
www
.
another
.
example
.
com
"
;
IPPExceptionsManager
.
init
(
)
;
let
contentPrincipal1
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
site1
)
;
let
contentPrincipal2
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
site2
)
;
IPPExceptionsManager
.
addExclusion
(
contentPrincipal1
)
;
IPPExceptionsManager
.
addExclusion
(
contentPrincipal2
)
;
let
site1Exists
=
IPPExceptionsManager
.
hasExclusion
(
contentPrincipal1
)
;
let
site2Exists
=
IPPExceptionsManager
.
hasExclusion
(
contentPrincipal2
)
;
Assert
.
ok
(
site1Exists
hasExclusion
correctly
states
that
{
site1
}
exists
)
;
Assert
.
ok
(
site2Exists
hasExclusion
correctly
states
that
{
site2
}
exists
)
;
let
permissionObj1
=
IPPExceptionsManager
.
getExceptionPermissionObject
(
contentPrincipal1
)
;
let
permissionObj2
=
IPPExceptionsManager
.
getExceptionPermissionObject
(
contentPrincipal2
)
;
Assert
.
equal
(
permissionObj1
?
.
capability
Ci
.
nsIPermissionManager
.
DENY_ACTION
getExceptionPermissionObject
correctly
states
that
{
site1
}
exists
and
has
capability
DENY
)
;
Assert
.
equal
(
permissionObj2
?
.
capability
Ci
.
nsIPermissionManager
.
DENY_ACTION
getExceptionPermissionObject
correctly
states
that
{
site2
}
exists
and
has
capability
DENY
)
;
IPPExceptionsManager
.
removeExclusion
(
contentPrincipal1
)
;
IPPExceptionsManager
.
removeExclusion
(
contentPrincipal2
)
;
site1Exists
=
IPPExceptionsManager
.
hasExclusion
(
contentPrincipal1
)
;
site2Exists
=
IPPExceptionsManager
.
hasExclusion
(
contentPrincipal2
)
;
Assert
.
ok
(
!
site1Exists
hasExclusion
correctly
states
that
{
site1
}
no
longer
exists
)
;
Assert
.
ok
(
!
site2Exists
hasExclusion
correctly
states
that
{
site2
}
no
longer
exists
)
;
permissionObj1
=
IPPExceptionsManager
.
getExceptionPermissionObject
(
contentPrincipal1
)
;
permissionObj2
=
IPPExceptionsManager
.
getExceptionPermissionObject
(
contentPrincipal2
)
;
Assert
.
ok
(
!
permissionObj1
Permission
object
for
{
site1
}
no
longer
exists
)
;
Assert
.
ok
(
!
permissionObj2
Permission
object
for
{
site2
}
no
longer
exists
)
;
Services
.
prefs
.
clearUserPref
(
ONBOARDING_MESSAGE_MASK_PREF
)
;
IPPExceptionsManager
.
uninit
(
)
;
}
)
;
