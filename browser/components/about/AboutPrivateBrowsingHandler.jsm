"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
AboutPrivateBrowsingHandler
"
]
;
const
{
RemotePages
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
remotepagemanager
/
RemotePageManagerParent
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
SHOWN_PREF
=
"
browser
.
search
.
separatePrivateDefault
.
ui
.
banner
.
shown
"
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
MAX_SEARCH_BANNER_SHOW_COUNT
"
"
browser
.
search
.
separatePrivateDefault
.
ui
.
banner
.
max
"
0
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
isPrivateSearchUIEnabled
"
"
browser
.
search
.
separatePrivateDefault
.
ui
.
enabled
"
false
)
;
var
AboutPrivateBrowsingHandler
=
{
_inited
:
false
_searchBannerShownThisSession
:
false
_topics
:
[
"
OpenPrivateWindow
"
"
OpenSearchPreferences
"
"
SearchHandoff
"
"
ShouldShowSearchBanner
"
"
SearchBannerDismissed
"
]
init
(
)
{
if
(
this
.
_inited
)
{
return
;
}
this
.
receiveMessage
=
this
.
receiveMessage
.
bind
(
this
)
;
this
.
pageListener
=
new
RemotePages
(
"
about
:
privatebrowsing
"
)
;
for
(
let
topic
of
this
.
_topics
)
{
this
.
pageListener
.
addMessageListener
(
topic
this
.
receiveMessage
)
;
}
this
.
_inited
=
true
;
}
uninit
(
)
{
if
(
!
this
.
_inited
)
{
return
;
}
for
(
let
topic
of
this
.
_topics
)
{
this
.
pageListener
.
removeMessageListener
(
topic
this
.
receiveMessage
)
;
}
this
.
pageListener
.
destroy
(
)
;
}
receiveMessage
(
aMessage
)
{
switch
(
aMessage
.
name
)
{
case
"
OpenPrivateWindow
"
:
{
let
win
=
aMessage
.
target
.
browser
.
ownerGlobal
;
win
.
OpenBrowserWindow
(
{
private
:
true
}
)
;
break
;
}
case
"
OpenSearchPreferences
"
:
{
let
win
=
aMessage
.
target
.
browser
.
ownerGlobal
;
win
.
openPreferences
(
"
search
"
{
origin
:
"
about
-
privatebrowsing
"
}
)
;
break
;
}
case
"
SearchHandoff
"
:
{
let
searchAlias
=
"
"
;
let
searchAliases
=
Services
.
search
.
defaultPrivateEngine
.
wrappedJSObject
.
__internalAliases
;
if
(
searchAliases
&
&
searchAliases
.
length
)
{
searchAlias
=
{
searchAliases
[
0
]
}
;
}
let
urlBar
=
aMessage
.
target
.
browser
.
ownerGlobal
.
gURLBar
;
let
isFirstChange
=
true
;
if
(
!
aMessage
.
data
|
|
!
aMessage
.
data
.
text
)
{
urlBar
.
setHiddenFocus
(
)
;
}
else
{
urlBar
.
search
(
{
searchAlias
}
{
aMessage
.
data
.
text
}
)
;
isFirstChange
=
false
;
}
let
checkFirstChange
=
(
)
=
>
{
if
(
isFirstChange
)
{
isFirstChange
=
false
;
urlBar
.
removeHiddenFocus
(
)
;
urlBar
.
search
(
searchAlias
)
;
aMessage
.
target
.
sendAsyncMessage
(
"
HideSearch
"
)
;
urlBar
.
removeEventListener
(
"
compositionstart
"
checkFirstChange
)
;
urlBar
.
removeEventListener
(
"
paste
"
checkFirstChange
)
;
}
}
;
let
onKeydown
=
ev
=
>
{
if
(
ev
.
key
.
length
=
=
=
1
&
&
!
ev
.
altKey
&
&
!
ev
.
ctrlKey
&
&
!
ev
.
metaKey
)
{
checkFirstChange
(
)
;
}
if
(
ev
.
key
=
=
=
"
Escape
"
)
{
onDone
(
)
;
}
}
;
let
onDone
=
(
)
=
>
{
aMessage
.
target
.
sendAsyncMessage
(
"
ShowSearch
"
)
;
urlBar
.
removeHiddenFocus
(
)
;
urlBar
.
removeEventListener
(
"
keydown
"
onKeydown
)
;
urlBar
.
removeEventListener
(
"
mousedown
"
onDone
)
;
urlBar
.
removeEventListener
(
"
blur
"
onDone
)
;
urlBar
.
removeEventListener
(
"
compositionstart
"
checkFirstChange
)
;
urlBar
.
removeEventListener
(
"
paste
"
checkFirstChange
)
;
}
;
urlBar
.
addEventListener
(
"
keydown
"
onKeydown
)
;
urlBar
.
addEventListener
(
"
mousedown
"
onDone
)
;
urlBar
.
addEventListener
(
"
blur
"
onDone
)
;
urlBar
.
addEventListener
(
"
compositionstart
"
checkFirstChange
)
;
urlBar
.
addEventListener
(
"
paste
"
checkFirstChange
)
;
break
;
}
case
"
ShouldShowSearchBanner
"
:
{
if
(
aMessage
.
target
.
browser
.
getAttribute
(
"
preloadedState
"
)
=
=
=
"
preloaded
"
)
{
aMessage
.
target
.
sendAsyncMessage
(
"
ShowSearchBanner
"
{
show
:
false
}
)
;
return
;
}
if
(
!
isPrivateSearchUIEnabled
|
|
this
.
_searchBannerShownThisSession
)
{
aMessage
.
target
.
sendAsyncMessage
(
"
ShowSearchBanner
"
{
show
:
false
}
)
;
return
;
}
this
.
_searchBannerShownThisSession
=
true
;
const
shownTimes
=
Services
.
prefs
.
getIntPref
(
SHOWN_PREF
0
)
;
if
(
shownTimes
>
=
MAX_SEARCH_BANNER_SHOW_COUNT
)
{
aMessage
.
target
.
sendAsyncMessage
(
"
ShowSearchBanner
"
{
show
:
false
}
)
;
return
;
}
Services
.
prefs
.
setIntPref
(
SHOWN_PREF
shownTimes
+
1
)
;
Services
.
search
.
getDefaultPrivate
(
)
.
then
(
engine
=
>
{
aMessage
.
target
.
sendAsyncMessage
(
"
ShowSearchBanner
"
{
engineName
:
engine
.
name
show
:
true
}
)
;
}
)
;
break
;
}
case
"
SearchBannerDismissed
"
:
{
Services
.
prefs
.
setIntPref
(
SHOWN_PREF
MAX_SEARCH_BANNER_SHOW_COUNT
)
;
break
;
}
}
}
}
;
