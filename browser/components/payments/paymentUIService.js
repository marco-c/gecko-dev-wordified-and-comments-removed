"
use
strict
"
;
const
XHTML_NS
=
"
http
:
/
/
www
.
w3
.
org
/
1999
/
xhtml
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
BrowserWindowTracker
"
"
resource
:
/
/
/
modules
/
BrowserWindowTracker
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
paymentSrv
"
"
mozilla
.
org
/
dom
/
payments
/
payment
-
request
-
service
;
1
"
"
nsIPaymentRequestService
"
)
;
function
PaymentUIService
(
)
{
this
.
wrappedJSObject
=
this
;
XPCOMUtils
.
defineLazyGetter
(
this
"
log
"
(
)
=
>
{
let
{
ConsoleAPI
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Console
.
jsm
"
{
}
)
;
return
new
ConsoleAPI
(
{
maxLogLevelPref
:
"
dom
.
payments
.
loglevel
"
prefix
:
"
Payment
UI
Service
"
}
)
;
}
)
;
this
.
log
.
debug
(
"
constructor
"
)
;
}
PaymentUIService
.
prototype
=
{
classID
:
Components
.
ID
(
"
{
01f8bd55
-
9017
-
438b
-
85ec
-
7c15d2b35cdc
}
"
)
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIPaymentUIService
]
)
DIALOG_URL
:
"
chrome
:
/
/
payments
/
content
/
paymentDialogWrapper
.
xul
"
REQUEST_ID_PREFIX
:
"
paymentRequest
-
"
showPayment
(
requestId
)
{
this
.
log
.
debug
(
"
showPayment
:
"
requestId
)
;
let
request
=
paymentSrv
.
getPaymentRequestById
(
requestId
)
;
let
merchantBrowser
=
this
.
findBrowserByTabId
(
request
.
tabId
)
;
let
chromeWindow
=
merchantBrowser
.
ownerGlobal
;
let
{
gBrowser
}
=
chromeWindow
;
let
browserContainer
=
gBrowser
.
getBrowserContainer
(
merchantBrowser
)
;
let
container
=
chromeWindow
.
document
.
createElementNS
(
XHTML_NS
"
div
"
)
;
container
.
dataset
.
requestId
=
requestId
;
container
.
classList
.
add
(
"
paymentDialogContainer
"
)
;
container
.
hidden
=
true
;
let
paymentsBrowser
=
chromeWindow
.
document
.
createElementNS
(
XHTML_NS
"
iframe
"
)
;
paymentsBrowser
.
classList
.
add
(
"
paymentDialogContainerFrame
"
)
;
paymentsBrowser
.
setAttribute
(
"
type
"
"
content
"
)
;
paymentsBrowser
.
setAttribute
(
"
remote
"
"
true
"
)
;
paymentsBrowser
.
setAttribute
(
"
src
"
{
this
.
DIALOG_URL
}
?
requestId
=
{
requestId
}
)
;
container
.
appendChild
(
paymentsBrowser
)
;
browserContainer
.
prepend
(
container
)
;
paymentsBrowser
.
addEventListener
(
"
tabmodaldialogready
"
function
readyToShow
(
)
{
if
(
!
container
)
{
return
;
}
container
.
hidden
=
false
;
merchantBrowser
.
setAttribute
(
"
tabmodalPromptShowing
"
"
true
"
)
;
let
tabModalBackground
=
chromeWindow
.
document
.
createElement
(
"
box
"
)
;
tabModalBackground
.
classList
.
add
(
"
tabModalBackground
"
"
paymentDialogBackground
"
)
;
merchantBrowser
.
parentNode
.
insertBefore
(
tabModalBackground
merchantBrowser
.
nextElementSibling
)
;
}
{
once
:
true
}
)
;
}
abortPayment
(
requestId
)
{
this
.
log
.
debug
(
"
abortPayment
:
"
requestId
)
;
let
abortResponse
=
Cc
[
"
mozilla
.
org
/
dom
/
payments
/
payment
-
abort
-
action
-
response
;
1
"
]
.
createInstance
(
Ci
.
nsIPaymentAbortActionResponse
)
;
let
found
=
this
.
closeDialog
(
requestId
)
;
let
response
=
found
?
Ci
.
nsIPaymentActionResponse
.
ABORT_SUCCEEDED
:
Ci
.
nsIPaymentActionResponse
.
ABORT_FAILED
;
abortResponse
.
init
(
requestId
response
)
;
paymentSrv
.
respondPayment
(
abortResponse
)
;
}
completePayment
(
requestId
)
{
let
{
completeStatus
}
=
paymentSrv
.
getPaymentRequestById
(
requestId
)
;
this
.
log
.
debug
(
completePayment
:
requestId
:
{
requestId
}
completeStatus
:
{
completeStatus
}
)
;
let
closed
;
switch
(
completeStatus
)
{
case
"
fail
"
:
case
"
timeout
"
:
break
;
default
:
closed
=
this
.
closeDialog
(
requestId
)
;
break
;
}
let
dialogContainer
;
if
(
!
closed
)
{
dialogContainer
=
this
.
findDialog
(
requestId
)
.
dialogContainer
;
if
(
!
dialogContainer
)
{
this
.
log
.
error
(
"
completePayment
:
no
dialog
found
"
)
;
return
;
}
}
let
responseCode
=
closed
?
Ci
.
nsIPaymentActionResponse
.
COMPLETE_SUCCEEDED
:
Ci
.
nsIPaymentActionResponse
.
COMPLETE_FAILED
;
let
completeResponse
=
Cc
[
"
mozilla
.
org
/
dom
/
payments
/
payment
-
complete
-
action
-
response
;
1
"
]
.
createInstance
(
Ci
.
nsIPaymentCompleteActionResponse
)
;
completeResponse
.
init
(
requestId
responseCode
)
;
paymentSrv
.
respondPayment
(
completeResponse
.
QueryInterface
(
Ci
.
nsIPaymentActionResponse
)
)
;
if
(
!
closed
)
{
dialogContainer
.
querySelector
(
"
iframe
"
)
.
contentWindow
.
paymentDialogWrapper
.
updateRequest
(
)
;
}
}
updatePayment
(
requestId
)
{
let
{
dialogContainer
}
=
this
.
findDialog
(
requestId
)
;
this
.
log
.
debug
(
"
updatePayment
:
"
requestId
)
;
if
(
!
dialogContainer
)
{
this
.
log
.
error
(
"
updatePayment
:
no
dialog
found
"
)
;
return
;
}
dialogContainer
.
querySelector
(
"
iframe
"
)
.
contentWindow
.
paymentDialogWrapper
.
updateRequest
(
)
;
}
closePayment
(
requestId
)
{
this
.
closeDialog
(
requestId
)
;
}
closeDialog
(
requestId
)
{
let
{
browser
dialogContainer
}
=
this
.
findDialog
(
requestId
)
;
if
(
!
dialogContainer
)
{
return
false
;
}
this
.
log
.
debug
(
closing
:
{
requestId
}
)
;
dialogContainer
.
remove
(
)
;
if
(
!
dialogContainer
.
hidden
)
{
browser
.
parentElement
.
querySelector
(
"
.
paymentDialogBackground
"
)
.
remove
(
)
;
if
(
!
browser
.
tabModalPromptBox
|
|
browser
.
tabModalPromptBox
.
listPrompts
(
)
.
length
=
=
0
)
{
browser
.
removeAttribute
(
"
tabmodalPromptShowing
"
)
;
}
}
return
true
;
}
findDialog
(
requestId
)
{
for
(
let
win
of
BrowserWindowTracker
.
orderedWindows
)
{
for
(
let
dialogContainer
of
win
.
document
.
querySelectorAll
(
"
.
paymentDialogContainer
"
)
)
{
if
(
dialogContainer
.
dataset
.
requestId
=
=
requestId
)
{
return
{
dialogContainer
browser
:
dialogContainer
.
parentElement
.
querySelector
(
"
browser
"
)
}
;
}
}
}
return
{
}
;
}
findBrowserByTabId
(
tabId
)
{
for
(
let
win
of
BrowserWindowTracker
.
orderedWindows
)
{
for
(
let
browser
of
win
.
gBrowser
.
browsers
)
{
if
(
!
browser
.
frameLoader
|
|
!
browser
.
frameLoader
.
tabParent
)
{
continue
;
}
if
(
browser
.
frameLoader
.
tabParent
.
tabId
=
=
tabId
)
{
return
browser
;
}
}
}
this
.
log
.
error
(
"
findBrowserByTabId
:
No
browser
found
for
tabId
:
"
tabId
)
;
return
null
;
}
}
;
this
.
NSGetFactory
=
XPCOMUtils
.
generateNSGetFactory
(
[
PaymentUIService
]
)
;
