var
loop
=
loop
|
|
{
}
;
loop
.
StandaloneMozLoop
=
(
function
(
mozL10n
)
{
"
use
strict
"
;
var
ROOM_MAX_CLIENTS
=
2
;
function
validate
(
data
schema
)
{
if
(
!
schema
)
{
return
{
}
;
}
return
new
loop
.
validate
.
Validator
(
schema
)
.
validate
(
data
)
;
}
function
failureHandler
(
callback
xhrReq
)
{
var
jsonErr
=
JSON
.
parse
(
xhrReq
.
responseText
&
&
xhrReq
.
responseText
|
|
"
{
}
"
)
;
var
message
=
"
HTTP
"
+
xhrReq
.
status
+
"
"
+
xhrReq
.
statusText
;
var
err
=
new
Error
(
message
)
;
err
.
errno
=
jsonErr
.
errno
;
callback
(
err
)
;
}
var
StandaloneMozLoopRooms
=
function
(
options
)
{
options
=
options
|
|
{
}
;
if
(
!
options
.
baseServerUrl
)
{
throw
new
Error
(
"
missing
required
baseServerUrl
"
)
;
}
this
.
_baseServerUrl
=
options
.
baseServerUrl
;
}
;
StandaloneMozLoopRooms
.
prototype
=
{
get
:
function
(
roomToken
callback
)
{
var
url
=
this
.
_baseServerUrl
+
"
/
rooms
/
"
+
roomToken
;
this
.
_xhrReq
=
new
XMLHttpRequest
(
)
;
this
.
_xhrReq
.
open
(
"
GET
"
url
true
)
;
this
.
_xhrReq
.
setRequestHeader
(
"
Content
-
type
"
"
application
/
json
"
)
;
if
(
this
.
sessionToken
)
{
this
.
_xhrReq
.
setRequestHeader
(
"
Authorization
"
"
Basic
"
+
btoa
(
this
.
sessionToken
)
)
;
}
this
.
_xhrReq
.
onload
=
function
(
)
{
var
request
=
this
.
_xhrReq
;
var
responseJSON
=
JSON
.
parse
(
request
.
responseText
|
|
"
{
}
"
)
;
if
(
request
.
readyState
=
=
=
4
&
&
request
.
status
>
=
200
&
&
request
.
status
<
300
)
{
try
{
callback
(
null
validate
(
responseJSON
{
roomUrl
:
String
}
)
)
;
}
catch
(
err
)
{
console
.
error
(
"
Error
requesting
call
info
"
err
.
message
)
;
callback
(
err
)
;
}
}
else
{
failureHandler
(
callback
request
)
;
}
}
.
bind
(
this
)
;
this
.
_xhrReq
.
send
(
)
;
}
_postToRoom
:
function
(
roomToken
sessionToken
roomData
expectedProps
async
callback
)
{
var
url
=
this
.
_baseServerUrl
+
"
/
rooms
/
"
+
roomToken
;
var
xhrReq
=
new
XMLHttpRequest
(
)
;
xhrReq
.
open
(
"
POST
"
url
async
)
;
xhrReq
.
setRequestHeader
(
"
Content
-
type
"
"
application
/
json
"
)
;
if
(
sessionToken
)
{
xhrReq
.
setRequestHeader
(
"
Authorization
"
"
Basic
"
+
btoa
(
sessionToken
)
)
;
}
xhrReq
.
onload
=
function
(
)
{
var
request
=
xhrReq
;
var
responseJSON
=
JSON
.
parse
(
request
.
responseText
|
|
null
)
;
if
(
request
.
readyState
=
=
=
4
&
&
request
.
status
>
=
200
&
&
request
.
status
<
300
)
{
try
{
callback
(
null
validate
(
responseJSON
expectedProps
)
)
;
}
catch
(
err
)
{
console
.
error
(
"
Error
requesting
call
info
"
err
.
message
)
;
callback
(
err
)
;
}
}
else
{
failureHandler
(
callback
request
)
;
}
}
.
bind
(
this
xhrReq
)
;
xhrReq
.
send
(
JSON
.
stringify
(
roomData
)
)
;
}
join
:
function
(
roomToken
callback
)
{
function
callbackWrapper
(
err
result
)
{
if
(
result
)
{
this
.
sessionToken
=
result
.
sessionToken
;
}
callback
(
err
result
)
;
}
this
.
_postToRoom
(
roomToken
null
{
action
:
"
join
"
displayName
:
mozL10n
.
get
(
"
rooms_display_name_guest
"
)
clientMaxSize
:
ROOM_MAX_CLIENTS
}
{
apiKey
:
String
sessionId
:
String
sessionToken
:
String
expires
:
Number
}
true
callbackWrapper
.
bind
(
this
)
)
;
}
refreshMembership
:
function
(
roomToken
sessionToken
callback
)
{
this
.
_postToRoom
(
roomToken
sessionToken
{
action
:
"
refresh
"
sessionToken
:
sessionToken
}
{
expires
:
Number
}
true
callback
)
;
}
leave
:
function
(
roomToken
sessionToken
callback
)
{
if
(
!
callback
)
{
callback
=
function
(
error
)
{
if
(
error
)
{
console
.
error
(
error
)
;
}
}
;
}
this
.
_postToRoom
(
roomToken
sessionToken
{
action
:
"
leave
"
sessionToken
:
sessionToken
}
null
false
callback
)
;
}
sendConnectionStatus
:
function
(
roomToken
sessionToken
status
)
{
this
.
_postToRoom
(
roomToken
sessionToken
{
action
:
"
status
"
event
:
status
.
event
state
:
status
.
state
connections
:
status
.
connections
sendStreams
:
status
.
sendStreams
recvStreams
:
status
.
recvStreams
}
null
true
function
(
error
)
{
if
(
error
)
{
console
.
error
(
error
)
;
}
}
)
;
}
on
:
function
(
)
{
}
once
:
function
(
)
{
}
off
:
function
(
)
{
}
}
;
var
StandaloneMozLoop
=
function
(
options
)
{
options
=
options
|
|
{
}
;
if
(
!
options
.
baseServerUrl
)
{
throw
new
Error
(
"
missing
required
baseServerUrl
"
)
;
}
this
.
_baseServerUrl
=
options
.
baseServerUrl
;
this
.
rooms
=
new
StandaloneMozLoopRooms
(
options
)
;
}
;
StandaloneMozLoop
.
prototype
=
{
setLoopPref
:
function
(
prefName
value
)
{
localStorage
.
setItem
(
prefName
value
)
;
}
getLoopPref
:
function
(
prefName
)
{
return
localStorage
.
getItem
(
prefName
)
;
}
addConversationContext
:
function
(
)
{
}
setScreenShareState
:
function
(
)
{
}
}
;
return
StandaloneMozLoop
;
}
)
(
navigator
.
mozL10n
)
;
