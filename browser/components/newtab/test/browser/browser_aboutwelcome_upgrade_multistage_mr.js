"
use
strict
"
;
const
{
OnboardingMessageProvider
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
OnboardingMessageProvider
.
jsm
"
)
;
const
{
SpecialMessageActions
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
messaging
-
system
/
lib
/
SpecialMessageActions
.
jsm
"
)
;
const
{
TestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
TestUtils
.
jsm
"
)
;
const
HOMEPAGE_PREF
=
"
browser
.
startup
.
homepage
"
;
const
NEWTAB_PREF
=
"
browser
.
newtabpage
.
enabled
"
;
let
sandbox
;
add_setup
(
async
(
)
=
>
{
await
setAboutWelcomePref
(
true
)
;
sandbox
=
sinon
.
createSandbox
(
)
;
sandbox
.
stub
(
OnboardingMessageProvider
"
_doesAppNeedPin
"
)
.
resolves
(
false
)
;
sandbox
.
stub
(
OnboardingMessageProvider
"
_doesAppNeedDefault
"
)
.
resolves
(
false
)
;
sandbox
.
stub
(
SpecialMessageActions
"
pinFirefoxToTaskbar
"
)
.
resolves
(
)
;
registerCleanupFunction
(
async
(
)
=
>
{
await
popPrefs
(
)
;
sandbox
.
restore
(
)
;
}
)
;
}
)
;
async
function
openMRUpgradeWelcome
(
screensToTest
)
{
const
data
=
await
OnboardingMessageProvider
.
getUpgradeMessage
(
)
;
if
(
screensToTest
)
{
data
.
content
.
screens
=
data
.
content
.
screens
.
filter
(
screen
=
>
screensToTest
.
includes
(
screen
.
id
)
)
;
}
const
config
=
{
type
:
"
SHOW_SPOTLIGHT
"
data
}
;
SpecialMessageActions
.
handleAction
(
config
gBrowser
.
selectedBrowser
)
;
return
BrowserTestUtils
.
promiseAlertDialogOpen
(
null
"
chrome
:
/
/
browser
/
content
/
spotlight
.
html
"
{
isSubDialog
:
true
}
)
;
}
async
function
clickVisibleButton
(
browser
selector
)
{
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
browser
.
document
.
querySelector
(
selector
)
waiting
for
selector
{
selector
}
200
100
)
;
browser
.
document
.
querySelector
(
selector
)
.
click
(
)
;
}
async
function
test_upgrade_screen_content
(
browser
expected
=
[
]
unexpected
=
[
]
)
{
for
(
let
selector
of
expected
)
{
await
TestUtils
.
waitForCondition
(
(
)
=
>
browser
.
document
.
querySelector
(
selector
)
Should
render
{
selector
}
)
;
}
for
(
let
selector
of
unexpected
)
{
Assert
.
ok
(
!
browser
.
document
.
querySelector
(
selector
)
Should
not
render
{
selector
}
)
;
}
}
add_task
(
async
function
test_aboutwelcome_upgrade_mr_prefs_off
(
)
{
let
browser
=
await
openMRUpgradeWelcome
(
[
"
UPGRADE_GET_STARTED
"
"
UPGRADE_COLORWAY
"
]
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_GET_STARTED
"
]
[
"
main
.
PIN_FIREFOX
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
secondary
"
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_COLORWAY
"
]
[
"
main
.
action
-
checkbox
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
primary
"
)
;
await
BrowserTestUtils
.
waitForDialogClose
(
browser
.
top
.
document
.
getElementById
(
"
window
-
modal
-
dialog
"
)
)
;
Assert
.
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
HOMEPAGE_PREF
)
"
homepage
pref
should
be
default
"
)
;
Assert
.
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
NEWTAB_PREF
)
"
newtab
pref
should
be
default
"
)
;
}
)
;
add_task
(
async
function
test_aboutwelcome_upgrade_mr_prefs_non_default_unchecked
(
)
{
await
pushPrefs
(
[
HOMEPAGE_PREF
"
about
:
blank
"
]
[
NEWTAB_PREF
false
]
)
;
let
browser
=
await
openMRUpgradeWelcome
(
[
"
UPGRADE_GET_STARTED
"
"
UPGRADE_COLORWAY
"
]
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_GET_STARTED
"
]
[
"
main
.
PIN_FIREFOX
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
secondary
"
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_COLORWAY
"
"
#
action
-
checkbox
"
]
[
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
primary
"
)
;
await
BrowserTestUtils
.
waitForDialogClose
(
browser
.
top
.
document
.
getElementById
(
"
window
-
modal
-
dialog
"
)
)
;
Assert
.
ok
(
Services
.
prefs
.
prefHasUserValue
(
HOMEPAGE_PREF
)
"
homepage
pref
should
have
a
user
value
"
)
;
Assert
.
ok
(
Services
.
prefs
.
prefHasUserValue
(
NEWTAB_PREF
)
"
newtab
pref
should
have
a
user
value
"
)
;
await
popPrefs
(
)
;
}
)
;
add_task
(
async
function
test_aboutwelcome_upgrade_mr_prefs_non_default_checked
(
)
{
await
pushPrefs
(
[
HOMEPAGE_PREF
"
about
:
blank
"
]
[
NEWTAB_PREF
false
]
)
;
let
browser
=
await
openMRUpgradeWelcome
(
[
"
UPGRADE_GET_STARTED
"
"
UPGRADE_COLORWAY
"
]
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_GET_STARTED
"
]
[
"
main
.
PIN_FIREFOX
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
secondary
"
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_COLORWAY
"
"
#
action
-
checkbox
"
]
[
]
)
;
browser
.
document
.
querySelector
(
"
#
action
-
checkbox
"
)
.
click
(
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
primary
"
)
;
await
BrowserTestUtils
.
waitForDialogClose
(
browser
.
top
.
document
.
getElementById
(
"
window
-
modal
-
dialog
"
)
)
;
Assert
.
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
HOMEPAGE_PREF
)
"
homepage
pref
should
have
a
user
value
"
)
;
Assert
.
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
NEWTAB_PREF
)
"
newtab
pref
should
have
a
user
value
"
)
;
await
popPrefs
(
)
;
}
)
;
add_task
(
async
function
test_aboutwelcome_upgrade_mr_private_pin
(
)
{
OnboardingMessageProvider
.
_doesAppNeedPin
.
resolves
(
true
)
;
let
browser
=
await
openMRUpgradeWelcome
(
[
"
UPGRADE_PIN_FIREFOX
"
]
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_PIN_FIREFOX
"
"
input
#
action
-
checkbox
"
]
[
"
main
.
UPGRADE_COLORWAY
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
primary
"
)
;
await
BrowserTestUtils
.
waitForDialogClose
(
browser
.
top
.
document
.
getElementById
(
"
window
-
modal
-
dialog
"
)
)
;
const
pinStub
=
SpecialMessageActions
.
pinFirefoxToTaskbar
;
Assert
.
equal
(
pinStub
.
callCount
2
"
pinFirefoxToTaskbar
should
have
been
called
twice
"
)
;
Assert
.
ok
(
pinStub
.
firstCall
.
lastArg
!
=
pinStub
.
secondCall
.
lastArg
"
pinFirefoxToTaskbar
should
have
been
called
once
for
private
once
not
"
)
;
}
)
;
add_task
(
async
function
test_aboutwelcome_upgrade_mr_private_pin_get_started
(
)
{
OnboardingMessageProvider
.
_doesAppNeedPin
.
resolves
(
false
)
;
let
browser
=
await
openMRUpgradeWelcome
(
[
"
UPGRADE_GET_STARTED
"
]
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_GET_STARTED
"
]
[
"
input
#
action
-
checkbox
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
secondary
"
)
;
await
BrowserTestUtils
.
waitForDialogClose
(
browser
.
top
.
document
.
getElementById
(
"
window
-
modal
-
dialog
"
)
)
;
}
)
;
add_task
(
async
function
test_aboutwelcome_upgrade_mr_private_pin_not_needed
(
)
{
OnboardingMessageProvider
.
_doesAppNeedPin
.
resolves
(
true
)
.
withArgs
(
true
)
.
resolves
(
false
)
;
let
browser
=
await
openMRUpgradeWelcome
(
[
"
UPGRADE_PIN_FIREFOX
"
]
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_PIN_FIREFOX
"
]
[
"
input
#
action
-
checkbox
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
secondary
"
)
;
await
BrowserTestUtils
.
waitForDialogClose
(
browser
.
top
.
document
.
getElementById
(
"
window
-
modal
-
dialog
"
)
)
;
}
)
;
add_task
(
async
function
test_aboutwelcome_upgrade_mr_pin_not_needed_default_needed
(
)
{
OnboardingMessageProvider
.
_doesAppNeedPin
.
resolves
(
false
)
;
OnboardingMessageProvider
.
_doesAppNeedDefault
.
resolves
(
false
)
;
let
browser
=
await
openMRUpgradeWelcome
(
[
"
UPGRADE_GET_STARTED
"
]
)
;
await
test_upgrade_screen_content
(
browser
[
"
main
.
UPGRADE_GET_STARTED
"
]
[
"
input
#
action
-
checkbox
"
]
)
;
await
clickVisibleButton
(
browser
"
.
action
-
buttons
button
.
secondary
"
)
;
await
BrowserTestUtils
.
waitForDialogClose
(
browser
.
top
.
document
.
getElementById
(
"
window
-
modal
-
dialog
"
)
)
;
}
)
;
