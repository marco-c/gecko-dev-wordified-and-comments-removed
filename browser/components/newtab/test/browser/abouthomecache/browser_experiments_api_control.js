"
use
strict
"
;
const
{
ExperimentFakes
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
NimbusTestUtils
.
jsm
"
)
;
const
ENABLED_PREF
=
"
browser
.
startup
.
homepage
.
abouthome_cache
.
enabled
"
;
registerCleanupFunction
(
async
(
)
=
>
{
await
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
browser
=
>
{
await
simulateRestart
(
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
test_experiments_api_control
(
)
{
Services
.
prefs
.
clearUserPref
(
ENABLED_PREF
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
setBoolPref
(
ENABLED_PREF
true
)
;
}
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
browser
=
>
{
let
doEnrollmentCleanup
=
await
ExperimentFakes
.
enrollWithFeatureConfig
(
{
featureId
:
"
abouthomecache
"
value
:
{
enabled
:
false
}
}
)
;
Assert
.
ok
(
!
NimbusFeatures
.
abouthomecache
.
getVariable
(
"
enabled
"
)
"
NimbusFeatures
should
tell
us
that
the
about
:
home
startup
cache
"
+
"
is
disabled
"
)
;
await
simulateRestart
(
browser
)
;
await
ensureDynamicAboutHome
(
browser
AboutHomeStartupCache
.
CACHE_RESULT_SCALARS
.
DISABLED
)
;
await
doEnrollmentCleanup
(
)
;
}
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
browser
=
>
{
let
doEnrollmentCleanup
=
await
ExperimentFakes
.
enrollWithFeatureConfig
(
{
featureId
:
"
abouthomecache
"
value
:
{
enabled
:
true
}
}
)
;
Assert
.
ok
(
NimbusFeatures
.
abouthomecache
.
getVariable
(
"
enabled
"
)
"
NimbusFeatures
should
tell
us
that
the
about
:
home
startup
cache
"
+
"
is
enabled
"
)
;
await
simulateRestart
(
browser
)
;
await
ensureCachedAboutHome
(
browser
)
;
await
doEnrollmentCleanup
(
)
;
}
)
;
}
)
;
