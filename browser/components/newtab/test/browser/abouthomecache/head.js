"
use
strict
"
;
let
{
AboutHomeStartupCache
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
BrowserGlue
.
jsm
"
)
;
async
function
simulateRestart
(
browser
withAutoShutdownWrite
=
true
)
{
let
processManager
=
browser
.
messageManager
.
processMessageManager
;
if
(
processManager
.
remoteType
!
=
=
E10SUtils
.
PRIVILEGEDABOUT_REMOTE_TYPE
)
{
throw
new
Error
(
"
prepareLoadFromCache
should
only
be
called
on
a
browser
"
+
"
loaded
in
the
privileged
about
content
process
.
"
)
;
}
if
(
withAutoShutdownWrite
)
{
await
AboutHomeStartupCache
.
onShutdown
(
)
;
}
AboutHomeStartupCache
.
uninit
(
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
{
AboutHomeStartupCacheChild
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
AboutNewTabService
.
jsm
"
)
;
AboutHomeStartupCacheChild
.
uninit
(
)
;
}
)
;
AboutHomeStartupCache
.
init
(
)
;
AboutHomeStartupCache
.
sendCacheInputStreams
(
processManager
)
;
await
AboutHomeStartupCache
.
ensureCacheEntry
(
)
;
let
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
"
about
:
home
"
)
;
browser
.
reload
(
)
;
await
loaded
;
}
async
function
injectIntoCache
(
page
script
)
{
if
(
!
page
|
|
!
script
)
{
throw
new
Error
(
"
Cannot
injectIntoCache
with
falsey
values
"
)
;
}
await
AboutHomeStartupCache
.
ensureCacheEntry
(
)
;
let
pageInputStream
=
Cc
[
"
mozilla
.
org
/
io
/
string
-
input
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIStringInputStream
)
;
pageInputStream
.
setUTF8Data
(
page
)
;
let
scriptInputStream
=
Cc
[
"
mozilla
.
org
/
io
/
string
-
input
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIStringInputStream
)
;
scriptInputStream
.
setUTF8Data
(
script
)
;
await
AboutHomeStartupCache
.
populateCache
(
pageInputStream
scriptInputStream
)
;
}
function
clearCache
(
)
{
AboutHomeStartupCache
.
clearCache
(
)
;
}
async
function
ensureCachedAboutHome
(
browser
)
{
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
scripts
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
script
"
)
)
;
Assert
.
ok
(
!
!
scripts
.
length
"
There
should
be
page
scripts
.
"
)
;
let
[
lastScript
]
=
scripts
.
reverse
(
)
;
Assert
.
equal
(
lastScript
.
src
"
about
:
home
?
jscache
"
"
Found
about
:
home
?
jscache
script
tag
indicating
the
cached
doc
"
)
;
Assert
.
ok
(
Cu
.
waiveXrays
(
content
)
.
__FROM_STARTUP_CACHE__
"
Should
have
found
window
.
__FROM_STARTUP_CACHE__
"
)
;
Assert
.
ok
(
content
.
document
.
body
.
classList
.
contains
(
"
activity
-
stream
"
)
"
Should
have
found
activity
-
stream
class
on
<
body
>
element
"
)
;
Assert
.
ok
(
content
.
document
.
querySelector
(
"
[
data
-
section
-
id
=
'
topsites
'
]
"
)
"
Should
have
found
the
Discovery
Stream
top
sites
.
"
)
;
}
)
;
}
async
function
ensureDynamicAboutHome
(
browser
)
{
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
scripts
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
script
"
)
)
;
Assert
.
equal
(
scripts
.
length
0
"
There
should
be
no
page
scripts
.
"
)
;
Assert
.
equal
(
Cu
.
waiveXrays
(
content
)
.
__FROM_STARTUP_CACHE__
undefined
"
Should
not
have
found
window
.
__FROM_STARTUP_CACHE__
"
)
;
Assert
.
ok
(
content
.
document
.
body
.
classList
.
contains
(
"
activity
-
stream
"
)
"
Should
have
found
activity
-
stream
class
on
<
body
>
element
"
)
;
Assert
.
ok
(
content
.
document
.
querySelector
(
"
[
data
-
section
-
id
=
'
topsites
'
]
"
)
"
Should
have
found
the
Discovery
Stream
top
sites
.
"
)
;
}
)
;
}
