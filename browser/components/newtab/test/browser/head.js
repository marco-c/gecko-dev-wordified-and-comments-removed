"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
FeatureCallout
:
"
resource
:
/
/
/
modules
/
FeatureCallout
.
sys
.
mjs
"
FeatureCalloutBroker
:
"
resource
:
/
/
activity
-
stream
/
lib
/
FeatureCalloutBroker
.
sys
.
mjs
"
FeatureCalloutMessages
:
"
resource
:
/
/
activity
-
stream
/
lib
/
FeatureCalloutMessages
.
sys
.
mjs
"
ObjectUtils
:
"
resource
:
/
/
gre
/
modules
/
ObjectUtils
.
sys
.
mjs
"
PlacesTestUtils
:
"
resource
:
/
/
testing
-
common
/
PlacesTestUtils
.
sys
.
mjs
"
}
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
ASRouter
:
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouter
.
jsm
"
QueryCache
:
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouterTargeting
.
jsm
"
}
)
;
const
{
FxAccounts
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
FxAccounts
.
sys
.
mjs
"
)
;
const
{
sinon
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
Sinon
.
sys
.
mjs
"
)
;
const
ABOUT_WELCOME_OVERRIDE_CONTENT_PREF
=
"
browser
.
aboutwelcome
.
screens
"
;
const
win7Content
=
AppConstants
.
isPlatformAndVersionAtMost
(
"
win
"
"
6
.
1
"
)
;
const
calloutId
=
"
feature
-
callout
"
;
const
calloutSelector
=
#
{
calloutId
}
.
featureCallout
;
const
calloutCTASelector
=
#
{
calloutId
}
:
is
(
.
primary
.
secondary
)
;
const
calloutDismissSelector
=
#
{
calloutId
}
.
dismiss
-
button
;
function
popPrefs
(
)
{
return
SpecialPowers
.
popPrefEnv
(
)
;
}
function
pushPrefs
(
.
.
.
prefs
)
{
return
SpecialPowers
.
pushPrefEnv
(
{
set
:
prefs
}
)
;
}
async
function
getAboutWelcomeParent
(
browser
)
{
let
windowGlobalParent
=
browser
.
browsingContext
.
currentWindowGlobal
;
return
windowGlobalParent
.
getActor
(
"
AboutWelcome
"
)
;
}
async
function
setAboutWelcomeMultiStage
(
value
=
"
"
)
{
return
pushPrefs
(
[
ABOUT_WELCOME_OVERRIDE_CONTENT_PREF
value
]
)
;
}
async
function
test_screen_content
(
browser
experiment
expectedSelectors
=
[
]
unexpectedSelectors
=
[
]
)
{
await
ContentTask
.
spawn
(
browser
{
expectedSelectors
experiment
unexpectedSelectors
}
async
(
{
expectedSelectors
:
expected
experiment
:
experimentName
unexpectedSelectors
:
unexpected
}
)
=
>
{
for
(
let
selector
of
expected
)
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
querySelector
(
selector
)
Should
render
{
selector
}
in
{
experimentName
}
)
;
}
for
(
let
selector
of
unexpected
)
{
ok
(
!
content
.
document
.
querySelector
(
selector
)
Should
not
render
{
selector
}
in
{
experimentName
}
)
;
}
if
(
experimentName
=
=
=
"
home
"
)
{
Assert
.
equal
(
content
.
document
.
location
.
href
"
about
:
home
"
"
Navigated
to
about
:
home
"
)
;
}
else
{
Assert
.
equal
(
content
.
document
.
location
.
href
"
about
:
welcome
"
"
Navigated
to
a
welcome
screen
"
)
;
}
}
)
;
}
async
function
test_element_styles
(
browser
elementSelector
expectedStyles
=
{
}
unexpectedStyles
=
{
}
)
{
await
ContentTask
.
spawn
(
browser
[
elementSelector
expectedStyles
unexpectedStyles
]
async
(
[
selector
expected
unexpected
]
)
=
>
{
const
element
=
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
querySelector
(
selector
)
)
;
const
computedStyles
=
content
.
window
.
getComputedStyle
(
element
)
;
Object
.
entries
(
expected
)
.
forEach
(
(
[
attr
val
]
)
=
>
is
(
computedStyles
[
attr
]
val
{
selector
}
should
have
computed
{
attr
}
of
{
val
}
)
)
;
Object
.
entries
(
unexpected
)
.
forEach
(
(
[
attr
val
]
)
=
>
isnot
(
computedStyles
[
attr
]
val
{
selector
}
should
not
have
computed
{
attr
}
of
{
val
}
)
)
;
}
)
;
}
async
function
onButtonClick
(
browser
elementId
)
{
await
ContentTask
.
spawn
(
browser
{
elementId
}
async
(
{
elementId
:
buttonId
}
)
=
>
{
let
button
=
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
querySelector
(
buttonId
)
buttonId
)
;
button
.
click
(
)
;
}
)
;
}
async
function
toggleTopsitesPref
(
)
{
await
pushPrefs
(
[
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
system
.
topsites
"
false
]
)
;
await
pushPrefs
(
[
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
system
.
topsites
"
true
]
)
;
}
async
function
setDefaultTopSites
(
)
{
await
pushPrefs
(
[
"
browser
.
newtabpage
.
activity
-
stream
.
default
.
sites
"
"
https
:
/
/
www
.
youtube
.
com
/
https
:
/
/
www
.
facebook
.
com
/
https
:
/
/
www
.
amazon
.
com
/
https
:
/
/
www
.
reddit
.
com
/
https
:
/
/
www
.
wikipedia
.
org
/
https
:
/
/
twitter
.
com
/
"
]
)
;
await
toggleTopsitesPref
(
)
;
await
pushPrefs
(
[
"
browser
.
newtabpage
.
activity
-
stream
.
improvesearch
.
topSiteSearchShortcuts
"
true
]
)
;
}
async
function
setTestTopSites
(
)
{
await
pushPrefs
(
[
"
browser
.
newtabpage
.
activity
-
stream
.
improvesearch
.
topSiteSearchShortcuts
"
false
]
)
;
await
pushPrefs
(
[
"
browser
.
newtabpage
.
activity
-
stream
.
default
.
sites
"
"
https
:
/
/
example
.
com
/
"
]
)
;
await
toggleTopsitesPref
(
)
;
}
async
function
setAboutWelcomePref
(
value
)
{
return
pushPrefs
(
[
"
browser
.
aboutwelcome
.
enabled
"
value
]
)
;
}
async
function
openMRAboutWelcome
(
)
{
await
setAboutWelcomePref
(
true
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
welcome
"
true
)
;
return
{
browser
:
tab
.
linkedBrowser
cleanup
:
async
(
)
=
>
{
BrowserTestUtils
.
removeTab
(
tab
)
;
await
popPrefs
(
)
;
}
}
;
}
async
function
clearHistoryAndBookmarks
(
)
{
await
PlacesUtils
.
bookmarks
.
eraseEverything
(
)
;
await
PlacesUtils
.
history
.
clear
(
)
;
QueryCache
.
expireAll
(
)
;
}
async
function
waitForPreloaded
(
browser
)
{
let
readyState
=
await
ContentTask
.
spawn
(
browser
null
(
)
=
>
content
.
document
.
readyState
)
;
if
(
readyState
!
=
=
"
complete
"
)
{
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
}
}
async
function
waitForUrlLoad
(
url
)
{
let
browser
=
gBrowser
.
selectedBrowser
;
BrowserTestUtils
.
startLoadingURIString
(
browser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
false
url
)
;
}
function
refreshHighlightsFeed
(
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
section
.
highlights
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
section
.
highlights
"
true
)
;
}
async
function
addHighlightsBookmarks
(
count
)
{
const
bookmarks
=
new
Array
(
count
)
.
fill
(
null
)
.
map
(
(
entry
i
)
=
>
(
{
parentGuid
:
PlacesUtils
.
bookmarks
.
unfiledGuid
title
:
"
foo
"
url
:
https
:
/
/
mozilla
{
i
}
.
com
/
nowNew
}
)
)
;
for
(
let
placeInfo
of
bookmarks
)
{
await
PlacesUtils
.
bookmarks
.
insert
(
placeInfo
)
;
await
PlacesTestUtils
.
addVisits
(
placeInfo
.
url
)
;
}
refreshHighlightsFeed
(
)
;
}
function
addContentHelpers
(
)
{
const
{
document
}
=
content
;
Object
.
assign
(
content
{
async
openContextMenuAndGetOptions
(
selector
)
{
const
item
=
document
.
querySelector
(
selector
)
;
const
contextButton
=
item
.
querySelector
(
"
.
context
-
menu
-
button
"
)
;
contextButton
.
click
(
)
;
await
new
Promise
(
r
=
>
content
.
requestAnimationFrame
(
r
)
)
;
const
contextMenu
=
item
.
querySelector
(
"
.
context
-
menu
"
)
;
const
contextMenuList
=
contextMenu
.
querySelector
(
"
.
context
-
menu
-
list
"
)
;
return
[
.
.
.
contextMenuList
.
getElementsByClassName
(
"
context
-
menu
-
item
"
)
]
;
}
}
)
;
}
function
test_newtab
(
testInfo
browserURL
=
"
about
:
newtab
"
)
{
let
{
before
test
:
contentTask
after
}
=
testInfo
;
if
(
!
before
)
{
before
=
(
)
=
>
(
{
}
)
;
}
if
(
!
contentTask
)
{
contentTask
=
testInfo
;
}
if
(
!
after
)
{
after
=
(
)
=
>
{
}
;
}
let
needPopPrefs
=
false
;
let
scopedPushPrefs
=
async
(
.
.
.
args
)
=
>
{
needPopPrefs
=
true
;
await
pushPrefs
(
.
.
.
args
)
;
}
;
let
scopedPopPrefs
=
async
(
)
=
>
{
if
(
needPopPrefs
)
{
await
popPrefs
(
)
;
}
}
;
let
testTask
=
async
(
)
=
>
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
browserURL
false
)
;
let
browser
=
tab
.
linkedBrowser
;
await
waitForPreloaded
(
browser
)
;
SpecialPowers
.
spawn
(
browser
[
]
addContentHelpers
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
content
.
document
.
getElementById
(
"
root
"
)
.
children
.
length
)
"
Should
render
activity
stream
content
"
)
;
try
{
let
contentArg
=
await
before
(
{
pushPrefs
:
scopedPushPrefs
tab
}
)
;
let
contentResult
=
await
SpecialPowers
.
spawn
(
browser
[
contentArg
]
contentTask
)
;
await
after
(
contentResult
)
;
}
finally
{
await
scopedPopPrefs
(
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
}
;
Object
.
defineProperty
(
testTask
"
name
"
{
value
:
contentTask
.
name
}
)
;
add_task
(
testTask
)
;
}
async
function
waitForCalloutScreen
(
target
screenId
)
{
await
BrowserTestUtils
.
waitForMutationCondition
(
target
{
childList
:
true
subtree
:
true
attributeFilter
:
[
"
class
"
]
}
(
)
=
>
target
.
querySelector
(
{
calloutSelector
}
:
not
(
.
hidden
)
.
{
screenId
}
)
)
;
}
async
function
waitForCalloutRemoved
(
target
)
{
await
BrowserTestUtils
.
waitForMutationCondition
(
target
{
childList
:
true
subtree
:
true
}
(
)
=
>
!
target
.
querySelector
(
calloutSelector
)
)
;
}
