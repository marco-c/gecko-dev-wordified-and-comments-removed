"
use
strict
"
;
if
(
AppConstants
.
platform
=
=
=
"
macosx
"
)
{
requestLongerTimeout
(
2
)
;
}
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
NewTabUtils
:
"
resource
:
/
/
gre
/
modules
/
NewTabUtils
.
jsm
"
PlacesTestUtils
:
"
resource
:
/
/
testing
-
common
/
PlacesTestUtils
.
jsm
"
UrlbarTestUtils
:
"
resource
:
/
/
testing
-
common
/
UrlbarTestUtils
.
jsm
"
}
)
;
const
OPEN_TYPE
=
{
CURRENT_BY_CLICK
:
0
NEWTAB_BY_CLICK
:
1
NEWTAB_BY_CONTEXTMENU
:
2
}
;
const
{
VISIT_SOURCE_ORGANIC
VISIT_SOURCE_SPONSORED
}
=
PlacesUtils
.
history
;
async
function
assertDatabase
(
{
targetURL
expected
}
)
{
const
placesId
=
await
PlacesTestUtils
.
fieldInDB
(
targetURL
"
id
"
)
;
const
expectedTriggeringPlaceId
=
expected
.
triggerURL
?
await
PlacesTestUtils
.
fieldInDB
(
expected
.
triggerURL
"
id
"
)
:
null
;
const
db
=
await
PlacesUtils
.
promiseDBConnection
(
)
;
const
rows
=
await
db
.
execute
(
"
SELECT
source
triggeringPlaceId
FROM
moz_historyvisits
WHERE
place_id
=
:
place_id
AND
source
=
:
source
"
{
place_id
:
placesId
source
:
expected
.
source
}
)
;
Assert
.
equal
(
rows
.
length
1
)
;
Assert
.
equal
(
rows
[
0
]
.
getResultByName
(
"
triggeringPlaceId
"
)
expectedTriggeringPlaceId
The
triggeringPlaceId
in
database
is
correct
for
{
targetURL
}
)
;
}
async
function
openAndTest
(
{
linkSelector
linkURL
redirectTo
=
null
openType
=
OPEN_TYPE
.
CURRENT_BY_CLICK
expected
}
)
{
const
destinationURL
=
redirectTo
|
|
linkURL
;
info
(
"
Open
specific
link
and
wait
for
loading
.
"
)
;
const
isNewTab
=
openType
!
=
=
OPEN_TYPE
.
CURRENT_BY_CLICK
;
const
onLoad
=
isNewTab
?
BrowserTestUtils
.
waitForNewTab
(
gBrowser
destinationURL
true
)
:
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
false
destinationURL
)
;
const
onLocationChanged
=
new
Promise
(
resolve
=
>
{
gBrowser
.
addTabsProgressListener
(
{
async
onLocationChange
(
aBrowser
aWebProgress
aRequest
aLocation
)
{
if
(
aLocation
.
spec
=
=
=
destinationURL
)
{
gBrowser
.
removeTabsProgressListener
(
this
)
;
await
Promise
.
resolve
(
)
;
resolve
(
)
;
}
}
}
)
;
}
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
linkSelector
linkURL
]
async
(
selector
link
)
=
>
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
querySelector
(
selector
)
.
href
=
=
=
link
)
;
}
)
;
if
(
openType
=
=
=
OPEN_TYPE
.
NEWTAB_BY_CLICK
)
{
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
linkSelector
{
ctrlKey
:
isNewTab
metaKey
:
isNewTab
}
gBrowser
.
selectedBrowser
)
;
}
else
if
(
openType
=
=
=
OPEN_TYPE
.
NEWTAB_BY_CONTEXTMENU
)
{
const
onPopup
=
BrowserTestUtils
.
waitForEvent
(
document
"
popupshown
"
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
linkSelector
{
type
:
"
contextmenu
"
}
gBrowser
.
selectedBrowser
)
;
await
onPopup
;
const
contextMenu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
const
openLinkMenuItem
=
contextMenu
.
querySelector
(
"
#
context
-
openlinkintab
"
)
;
openLinkMenuItem
.
click
(
)
;
contextMenu
.
hidePopup
(
)
;
}
else
{
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
linkSelector
{
}
gBrowser
.
selectedBrowser
)
;
}
const
maybeNewTab
=
await
onLoad
;
await
onLocationChanged
;
if
(
isNewTab
)
{
BrowserTestUtils
.
removeTab
(
maybeNewTab
)
;
}
info
(
"
Check
database
for
the
destination
.
"
)
;
await
assertDatabase
(
{
targetURL
:
destinationURL
expected
}
)
;
}
async
function
pin
(
link
)
{
NewTabUtils
.
pinnedLinks
.
pin
(
link
0
)
;
await
toggleTopsitesPref
(
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
const
sites
=
AboutNewTab
.
getTopSites
(
)
;
return
(
sites
?
.
[
0
]
?
.
url
=
=
=
link
.
url
&
&
sites
[
0
]
.
sponsored_tile_id
=
=
=
link
.
sponsored_tile_id
)
;
}
"
Waiting
for
top
sites
to
be
updated
"
)
;
}
function
unpin
(
link
)
{
NewTabUtils
.
pinnedLinks
.
unpin
(
link
)
;
}
add_setup
(
async
function
(
)
{
await
clearHistoryAndBookmarks
(
)
;
registerCleanupFunction
(
async
(
)
=
>
{
await
clearHistoryAndBookmarks
(
)
;
}
)
;
}
)
;
add_task
(
async
function
basic
(
)
{
const
testData
=
[
{
description
:
"
Sponsored
tile
"
link
:
{
label
:
"
test_label
"
url
:
"
http
:
/
/
example
.
com
/
"
sponsored_position
:
1
sponsored_tile_id
:
12345
sponsored_impression_url
:
"
http
:
/
/
impression
.
example
.
com
/
"
sponsored_click_url
:
"
http
:
/
/
click
.
example
.
com
/
"
}
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
}
}
{
description
:
"
Organic
tile
"
link
:
{
label
:
"
test_label
"
url
:
"
http
:
/
/
example
.
com
/
"
}
expected
:
{
source
:
VISIT_SOURCE_ORGANIC
}
}
]
;
for
(
const
{
description
link
expected
}
of
testData
)
{
info
(
description
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
(
)
=
>
{
await
pin
(
link
)
;
await
openAndTest
(
{
linkSelector
:
"
.
top
-
site
-
button
"
linkURL
:
link
.
url
openType
:
OPEN_TYPE
.
NEWTAB_BY_CLICK
expected
}
)
;
await
clearHistoryAndBookmarks
(
)
;
await
openAndTest
(
{
linkSelector
:
"
.
top
-
site
-
button
"
linkURL
:
link
.
url
expected
}
)
;
await
clearHistoryAndBookmarks
(
)
;
unpin
(
link
)
;
}
)
;
}
}
)
;
add_task
(
async
function
redirection
(
)
{
await
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
(
)
=
>
{
const
redirectTo
=
"
http
:
/
/
example
.
com
/
"
;
const
link
=
{
label
:
"
test_label
"
url
:
"
http
:
/
/
example
.
com
/
browser
/
browser
/
components
/
newtab
/
test
/
browser
/
redirect_to
.
sjs
?
/
"
sponsored_position
:
1
sponsored_tile_id
:
12345
sponsored_impression_url
:
"
http
:
/
/
impression
.
example
.
com
/
"
sponsored_click_url
:
"
http
:
/
/
click
.
example
.
com
/
"
}
;
await
pin
(
link
)
;
await
openAndTest
(
{
linkSelector
:
"
.
top
-
site
-
button
"
linkURL
:
link
.
url
redirectTo
openType
:
OPEN_TYPE
.
NEWTAB_BY_CLICK
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
triggerURL
:
link
.
url
}
}
)
;
await
assertDatabase
(
{
targetURL
:
link
.
url
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
}
}
)
;
await
clearHistoryAndBookmarks
(
)
;
await
openAndTest
(
{
linkSelector
:
"
.
top
-
site
-
button
"
linkURL
:
link
.
url
redirectTo
openType
:
OPEN_TYPE
.
NEWTAB_BY_CLICK
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
triggerURL
:
link
.
url
}
}
)
;
await
assertDatabase
(
{
targetURL
:
link
.
url
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
}
}
)
;
await
clearHistoryAndBookmarks
(
)
;
unpin
(
link
)
;
}
)
;
}
)
;
add_task
(
async
function
inherit
(
)
{
const
host
=
"
https
:
/
/
example
.
com
/
"
;
const
sameBaseDomainHost
=
"
https
:
/
/
www
.
example
.
com
/
"
;
const
path
=
"
browser
/
browser
/
components
/
newtab
/
test
/
browser
/
"
;
const
firstURL
=
{
host
}
{
path
}
annotation_first
.
html
;
const
secondURL
=
{
host
}
{
path
}
annotation_second
.
html
;
const
thirdURL
=
{
sameBaseDomainHost
}
{
path
}
annotation_third
.
html
;
const
outsideURL
=
"
https
:
/
/
example
.
org
/
"
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
(
)
=
>
{
const
link
=
{
label
:
"
first
"
url
:
firstURL
sponsored_position
:
1
sponsored_tile_id
:
12345
sponsored_impression_url
:
"
http
:
/
/
impression
.
example
.
com
/
"
sponsored_click_url
:
"
http
:
/
/
click
.
example
.
com
/
"
}
;
await
pin
(
link
)
;
info
(
"
Open
the
tile
to
show
first
page
in
same
tab
"
)
;
await
openAndTest
(
{
linkSelector
:
"
.
top
-
site
-
button
"
linkURL
:
link
.
url
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
}
}
)
;
info
(
"
Open
link
on
first
page
to
show
second
page
in
new
tab
"
)
;
await
openAndTest
(
{
linkSelector
:
"
a
"
linkURL
:
secondURL
openType
:
OPEN_TYPE
.
NEWTAB_BY_CLICK
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
triggerURL
:
link
.
url
}
}
)
;
await
PlacesTestUtils
.
clearHistoryVisits
(
)
;
info
(
"
Open
link
on
first
page
to
show
second
page
in
same
tab
"
)
;
await
openAndTest
(
{
linkSelector
:
"
a
"
linkURL
:
secondURL
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
triggerURL
:
link
.
url
}
}
)
;
info
(
"
Open
link
on
second
page
to
show
third
page
in
new
tab
by
context
menu
"
)
;
await
openAndTest
(
{
linkSelector
:
"
a
"
linkURL
:
thirdURL
openType
:
OPEN_TYPE
.
NEWTAB_BY_CONTEXTMENU
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
triggerURL
:
link
.
url
}
}
)
;
await
PlacesTestUtils
.
clearHistoryVisits
(
)
;
info
(
"
Open
link
on
second
page
to
show
third
page
in
same
tab
"
)
;
await
openAndTest
(
{
linkSelector
:
"
a
"
linkURL
:
thirdURL
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
triggerURL
:
link
.
url
}
}
)
;
info
(
"
Open
link
on
third
page
to
show
outside
domain
page
in
same
tab
"
)
;
await
openAndTest
(
{
linkSelector
:
"
a
"
linkURL
:
outsideURL
expected
:
{
source
:
VISIT_SOURCE_ORGANIC
}
}
)
;
info
(
"
Visit
URL
that
has
the
same
domain
as
sponsored
link
from
URL
bar
"
)
;
const
onLoad
=
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
false
host
)
;
await
UrlbarTestUtils
.
promiseAutocompleteResultPopup
(
{
window
value
:
host
waitForFocus
:
SimpleTest
.
waitForFocus
}
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Enter
"
)
;
await
onLoad
;
await
assertDatabase
(
{
targetURL
:
host
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
triggerURL
:
link
.
url
}
}
)
;
unpin
(
link
)
;
await
clearHistoryAndBookmarks
(
)
;
}
)
;
}
)
;
add_task
(
async
function
timeout
(
)
{
const
base
=
"
https
:
/
/
example
.
com
/
browser
/
browser
/
components
/
newtab
/
test
/
browser
"
;
const
firstURL
=
{
base
}
/
annotation_first
.
html
;
const
secondURL
=
{
base
}
/
annotation_second
.
html
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
(
)
=
>
{
info
(
"
Set
timeout
second
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
places
.
sponsoredSession
.
timeOutSec
"
1
]
]
}
)
;
const
link
=
{
label
:
"
test
"
url
:
firstURL
sponsored_position
:
1
sponsored_tile_id
:
12345
sponsored_impression_url
:
"
http
:
/
/
impression
.
example
.
com
/
"
sponsored_click_url
:
"
http
:
/
/
click
.
example
.
com
/
"
}
;
await
pin
(
link
)
;
info
(
"
Open
the
tile
"
)
;
await
openAndTest
(
{
linkSelector
:
"
.
top
-
site
-
button
"
linkURL
:
link
.
url
expected
:
{
source
:
VISIT_SOURCE_SPONSORED
}
}
)
;
info
(
"
Wait
1
sec
"
)
;
await
new
Promise
(
r
=
>
setTimeout
(
r
1000
)
)
;
info
(
"
Open
link
on
first
page
to
show
second
page
in
new
tab
"
)
;
await
openAndTest
(
{
linkSelector
:
"
a
"
linkURL
:
secondURL
openType
:
OPEN_TYPE
.
NEWTAB_BY_CLICK
expected
:
{
source
:
VISIT_SOURCE_ORGANIC
}
}
)
;
await
PlacesTestUtils
.
clearHistoryVisits
(
)
;
info
(
"
Open
link
on
first
page
to
show
second
page
"
)
;
await
openAndTest
(
{
linkSelector
:
"
a
"
linkURL
:
secondURL
expected
:
{
source
:
VISIT_SOURCE_ORGANIC
}
}
)
;
unpin
(
link
)
;
await
clearHistoryAndBookmarks
(
)
;
}
)
;
}
)
;
