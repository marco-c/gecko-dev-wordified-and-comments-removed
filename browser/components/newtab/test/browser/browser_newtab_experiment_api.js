"
use
strict
"
;
const
{
ExperimentFakes
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
NimbusTestUtils
.
jsm
"
)
;
async
function
testWithExperimentFeatureValue
(
slug
featureValue
test
)
{
let
doExperimentCleanup
;
test_newtab
(
{
async
before
(
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
newNewtabExperience
.
enabled
"
false
)
;
doExperimentCleanup
=
await
ExperimentFakes
.
enrollWithFeatureConfig
(
{
featureId
:
"
newtab
"
enabled
:
true
value
:
featureValue
}
)
;
}
test
async
after
(
)
{
Services
.
prefs
.
clearUserPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
newNewtabExperience
.
enabled
"
)
;
await
doExperimentCleanup
(
)
;
}
}
)
;
}
testWithExperimentFeatureValue
(
mochitest
-
newtab
-
{
Date
.
now
(
)
}
{
prefsButtonIcon
:
"
icon
-
info
"
}
async
function
check_icon_changes_with_experiment
(
)
{
let
el
=
content
.
document
.
querySelector
(
"
.
prefs
-
button
.
icon
"
)
;
ok
(
el
"
there
should
be
a
settings
icon
"
)
;
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
querySelector
(
"
.
prefs
-
button
.
icon
"
)
.
classList
.
contains
(
"
icon
-
info
"
)
"
settings
icon
uses
prefsButtonIcon
value
set
in
the
experiment
"
)
;
}
)
;
testWithExperimentFeatureValue
(
mochitest
-
newtab
-
{
Date
.
now
(
)
}
null
async
function
check_icon_uses_default
(
)
{
let
el
=
content
.
document
.
querySelector
(
"
.
prefs
-
button
.
icon
"
)
;
ok
(
el
"
there
should
be
a
settings
icon
"
)
;
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
querySelector
(
"
.
prefs
-
button
.
icon
"
)
.
classList
.
contains
(
"
icon
-
settings
"
)
"
settings
icon
uses
default
value
"
)
;
}
)
;
