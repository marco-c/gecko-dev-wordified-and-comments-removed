"
use
strict
"
;
const
{
AddonTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
AddonTestUtils
.
sys
.
mjs
"
)
;
const
{
SearchTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
SearchTestUtils
.
sys
.
mjs
"
)
;
const
{
TestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
TestUtils
.
sys
.
mjs
"
)
;
const
{
sinon
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
Sinon
.
sys
.
mjs
"
)
;
const
{
DiscoveryStreamFeed
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
activity
-
stream
/
lib
/
DiscoveryStreamFeed
.
sys
.
mjs
"
)
;
SearchTestUtils
.
init
(
this
)
;
AddonTestUtils
.
init
(
this
)
;
AddonTestUtils
.
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
42
"
"
42
"
)
;
const
{
AboutNewTab
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
AboutNewTab
.
sys
.
mjs
"
)
;
const
{
PREFS_CONFIG
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ActivityStream
.
sys
.
mjs
"
)
;
ChromeUtils
.
defineESModuleGetters
(
this
{
BasePromiseWorker
:
"
resource
:
/
/
gre
/
modules
/
PromiseWorker
.
sys
.
mjs
"
}
)
;
const
CACHE_WORKER_URL
=
"
resource
:
/
/
activity
-
stream
/
lib
/
cache
.
worker
.
js
"
;
const
NEWTAB_RENDER_URL
=
"
resource
:
/
/
activity
-
stream
/
data
/
content
/
newtab
-
render
.
js
"
;
add_setup
(
async
function
(
)
{
do_get_profile
(
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
let
server
=
AddonTestUtils
.
createHttpServer
(
{
hosts
:
[
"
example
.
com
"
]
}
)
;
server
.
registerDirectory
(
"
/
"
do_get_cwd
(
)
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
section
.
topstories
"
true
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
system
.
topstories
"
true
)
;
Services
.
prefs
.
setStringPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
discoverystream
.
region
-
weather
-
config
"
"
"
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
newtabWallpapers
.
enabled
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
newtabWallpapers
.
v2
.
enabled
"
false
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
discoverystream
.
merino
-
provider
.
enabled
"
false
)
;
let
defaultDSConfig
=
JSON
.
parse
(
PREFS_CONFIG
.
get
(
"
discoverystream
.
config
"
)
.
getValue
(
{
geo
:
"
US
"
locale
:
"
en
-
US
"
}
)
)
;
const
sandbox
=
sinon
.
createSandbox
(
)
;
sandbox
.
stub
(
DiscoveryStreamFeed
.
prototype
"
generateFeedUrl
"
)
.
returns
(
"
http
:
/
/
example
.
com
/
topstories
.
json
"
)
;
Services
.
prefs
.
setCharPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
discoverystream
.
config
"
JSON
.
stringify
(
defaultDSConfig
)
)
;
Services
.
prefs
.
setCharPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
discoverystream
.
endpoints
"
http
:
/
/
example
.
com
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
telemetry
.
structuredIngestion
"
false
)
;
await
SearchTestUtils
.
installSearchExtension
(
{
name
:
"
Test
engine
"
keyword
:
"
testengine
"
search_url_get_params
:
"
s
=
{
searchTerms
}
"
}
{
setAsDefault
:
true
}
)
;
AboutNewTab
.
init
(
)
;
AboutNewTab
.
onBrowserReady
(
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
let
feed
=
AboutNewTab
.
activityStream
.
store
.
feeds
.
get
(
"
feeds
.
discoverystreamfeed
"
)
;
return
feed
?
.
loaded
;
}
)
;
}
)
;
add_task
(
async
function
test_cache_worker
(
)
{
Services
.
prefs
.
setBoolPref
(
"
security
.
allow_parent_unrestricted_js_loads
"
true
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
security
.
allow_parent_unrestricted_js_loads
"
)
;
}
)
;
let
state
=
AboutNewTab
.
activityStream
.
store
.
getState
(
)
;
let
cacheWorker
=
new
BasePromiseWorker
(
CACHE_WORKER_URL
)
;
let
{
page
script
}
=
await
cacheWorker
.
post
(
"
construct
"
[
state
]
)
;
ok
(
!
!
page
.
length
"
Got
page
content
"
)
;
ok
(
!
!
script
.
length
"
Got
script
content
"
)
;
equal
(
page
.
indexOf
(
"
{
{
MARKUP
}
}
"
)
-
1
"
Page
template
should
have
{
{
MARKUP
}
}
replaced
"
)
;
equal
(
page
.
indexOf
(
"
{
{
CACHE_TIME
}
}
"
)
-
1
"
Page
template
should
have
{
{
CACHE_TIME
}
}
replaced
"
)
;
equal
(
script
.
indexOf
(
"
{
{
STATE
}
}
"
)
-
1
"
Script
template
should
have
{
{
STATE
}
}
replaced
"
)
;
let
sandbox
=
Cu
.
Sandbox
(
Cu
.
getGlobalForObject
(
{
}
)
)
;
let
passedState
=
null
;
sandbox
.
window
=
{
NewtabRenderUtils
:
{
renderCache
(
aState
)
{
passedState
=
aState
;
}
}
}
;
Cu
.
evalInSandbox
(
script
sandbox
)
;
Services
.
scriptloader
.
loadSubScript
(
NEWTAB_RENDER_URL
sandbox
)
;
equal
(
sandbox
.
window
.
__FROM_STARTUP_CACHE__
true
"
Should
have
set
__FROM_STARTUP_CACHE__
to
true
"
)
;
state
.
App
.
isForStartupCache
=
true
;
state
=
JSON
.
parse
(
JSON
.
stringify
(
state
)
)
;
Assert
.
deepEqual
(
passedState
state
"
Should
have
called
renderCache
with
the
expected
state
"
)
;
let
parser
=
new
DOMParser
(
)
;
let
doc
=
parser
.
parseFromString
(
page
"
text
/
html
"
)
;
let
root
=
doc
.
getElementById
(
"
root
"
)
;
ok
(
root
.
childElementCount
"
There
are
children
on
the
root
node
"
)
;
equal
(
Array
.
from
(
root
.
querySelectorAll
(
"
.
ds
-
card
"
)
)
.
length
21
"
There
are
21
DSCards
"
)
;
let
cardHostname
=
doc
.
querySelector
(
"
[
data
-
section
-
id
=
'
topstories
'
]
.
source
"
)
.
innerText
;
equal
(
cardHostname
"
bbc
.
com
"
"
Card
hostname
is
bbc
.
com
"
)
;
let
placeholders
=
doc
.
querySelectorAll
(
"
.
ds
-
card
.
placeholder
"
)
;
equal
(
placeholders
.
length
20
"
There
should
be
20
placeholders
"
)
;
}
)
;
add_task
(
async
function
test_cache_worker_exception
(
)
{
let
cacheWorker
=
new
BasePromiseWorker
(
CACHE_WORKER_URL
)
;
let
{
page
script
}
=
await
cacheWorker
.
post
(
"
construct
"
[
null
]
)
;
equal
(
page
null
"
Should
have
gotten
a
null
page
nsIInputStream
"
)
;
equal
(
script
null
"
Should
have
gotten
a
null
script
nsIInputStream
"
)
;
}
)
;
