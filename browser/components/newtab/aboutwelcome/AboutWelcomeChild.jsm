"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
AboutWelcomeChild
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
DEFAULT_SITES
:
"
resource
:
/
/
activity
-
stream
/
lib
/
DefaultSites
.
jsm
"
ExperimentAPI
:
"
resource
:
/
/
nimbus
/
ExperimentAPI
.
jsm
"
shortURL
:
"
resource
:
/
/
activity
-
stream
/
lib
/
ShortURL
.
jsm
"
TippyTopProvider
:
"
resource
:
/
/
activity
-
stream
/
lib
/
TippyTopProvider
.
jsm
"
AboutWelcomeDefaults
:
"
resource
:
/
/
activity
-
stream
/
aboutwelcome
/
lib
/
AboutWelcomeDefaults
.
jsm
"
NimbusFeatures
:
"
resource
:
/
/
nimbus
/
ExperimentAPI
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
log
"
(
)
=
>
{
const
{
Logger
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
messaging
-
system
/
lib
/
Logger
.
jsm
"
)
;
return
new
Logger
(
"
AboutWelcomeChild
"
)
;
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
tippyTopProvider
"
(
)
=
>
(
async
(
)
=
>
{
const
provider
=
new
TippyTopProvider
(
)
;
await
provider
.
init
(
)
;
return
provider
;
}
)
(
)
)
;
const
SEARCH_REGION_PREF
=
"
browser
.
search
.
region
"
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
searchRegion
"
SEARCH_REGION_PREF
"
"
)
;
function
getImportableSites
(
child
)
{
return
(
getImportableSites
.
cache
?
?
(
getImportableSites
.
cache
=
(
async
(
)
=
>
{
const
tippyTop
=
await
tippyTopProvider
;
return
[
{
[
.
.
.
new
Set
(
(
await
child
.
sendQuery
(
"
AWPage
:
IMPORTABLE_SITES
"
)
)
.
map
(
url
=
>
{
const
site
=
{
url
}
;
tippyTop
.
processSite
(
site
"
*
"
)
;
return
JSON
.
stringify
(
{
icon
:
site
.
tippyTopIcon
label
:
shortURL
(
site
)
}
)
;
}
)
)
]
}
]
;
}
)
(
)
)
)
;
}
async
function
getDefaultSites
(
child
)
{
let
sites
=
DEFAULT_SITES
.
get
(
DEFAULT_SITES
.
has
(
searchRegion
)
?
searchRegion
:
"
"
)
;
const
tippyTop
=
await
tippyTopProvider
;
let
defaultSites
=
sites
.
split
(
"
"
)
.
map
(
link
=
>
{
let
site
=
{
url
:
link
}
;
tippyTop
.
processSite
(
site
)
;
return
{
icon
:
site
.
tippyTopIcon
title
:
shortURL
(
site
)
}
;
}
)
;
return
Cu
.
cloneInto
(
defaultSites
child
.
contentWindow
)
;
}
async
function
getSelectedTheme
(
child
)
{
let
activeThemeId
=
await
child
.
sendQuery
(
"
AWPage
:
GET_SELECTED_THEME
"
)
;
return
activeThemeId
;
}
class
AboutWelcomeChild
extends
JSWindowActorChild
{
actorCreated
(
)
{
this
.
exportFunctions
(
)
;
}
sendToPage
(
action
)
{
log
.
debug
(
Sending
to
page
:
{
action
.
type
}
)
;
const
win
=
this
.
document
.
defaultView
;
const
event
=
new
win
.
CustomEvent
(
"
AboutWelcomeChromeToContent
"
{
detail
:
Cu
.
cloneInto
(
action
win
)
}
)
;
win
.
dispatchEvent
(
event
)
;
}
exportFunctions
(
)
{
let
window
=
this
.
contentWindow
;
Cu
.
exportFunction
(
this
.
AWGetFeatureConfig
.
bind
(
this
)
window
{
defineAs
:
"
AWGetFeatureConfig
"
}
)
;
Cu
.
exportFunction
(
this
.
AWGetFxAMetricsFlowURI
.
bind
(
this
)
window
{
defineAs
:
"
AWGetFxAMetricsFlowURI
"
}
)
;
Cu
.
exportFunction
(
this
.
AWGetImportableSites
.
bind
(
this
)
window
{
defineAs
:
"
AWGetImportableSites
"
}
)
;
Cu
.
exportFunction
(
this
.
AWGetDefaultSites
.
bind
(
this
)
window
{
defineAs
:
"
AWGetDefaultSites
"
}
)
;
Cu
.
exportFunction
(
this
.
AWGetSelectedTheme
.
bind
(
this
)
window
{
defineAs
:
"
AWGetSelectedTheme
"
}
)
;
Cu
.
exportFunction
(
this
.
AWGetRegion
.
bind
(
this
)
window
{
defineAs
:
"
AWGetRegion
"
}
)
;
Cu
.
exportFunction
(
this
.
AWSelectTheme
.
bind
(
this
)
window
{
defineAs
:
"
AWSelectTheme
"
}
)
;
Cu
.
exportFunction
(
this
.
AWSendEventTelemetry
.
bind
(
this
)
window
{
defineAs
:
"
AWSendEventTelemetry
"
}
)
;
Cu
.
exportFunction
(
this
.
AWSendToParent
.
bind
(
this
)
window
{
defineAs
:
"
AWSendToParent
"
}
)
;
Cu
.
exportFunction
(
this
.
AWWaitForMigrationClose
.
bind
(
this
)
window
{
defineAs
:
"
AWWaitForMigrationClose
"
}
)
;
Cu
.
exportFunction
(
this
.
AWFinish
.
bind
(
this
)
window
{
defineAs
:
"
AWFinish
"
}
)
;
Cu
.
exportFunction
(
this
.
AWEnsureLangPackInstalled
.
bind
(
this
)
window
{
defineAs
:
"
AWEnsureLangPackInstalled
"
}
)
;
Cu
.
exportFunction
(
this
.
AWNegotiateLangPackForLanguageMismatch
.
bind
(
this
)
window
{
defineAs
:
"
AWNegotiateLangPackForLanguageMismatch
"
}
)
;
Cu
.
exportFunction
(
this
.
AWSetRequestedLocales
.
bind
(
this
)
window
{
defineAs
:
"
AWSetRequestedLocales
"
}
)
;
Cu
.
exportFunction
(
this
.
AWSendToDeviceEmailsSupported
.
bind
(
this
)
window
{
defineAs
:
"
AWSendToDeviceEmailsSupported
"
}
)
;
}
wrapPromise
(
promise
)
{
return
new
this
.
contentWindow
.
Promise
(
(
resolve
reject
)
=
>
promise
.
then
(
resolve
reject
)
)
;
}
sendQueryAndCloneForContent
(
.
.
.
sendQueryArgs
)
{
return
this
.
wrapPromise
(
(
async
(
)
=
>
{
return
Cu
.
cloneInto
(
await
this
.
sendQuery
(
.
.
.
sendQueryArgs
)
this
.
contentWindow
)
;
}
)
(
)
)
;
}
AWSelectTheme
(
data
)
{
return
this
.
wrapPromise
(
this
.
sendQuery
(
"
AWPage
:
SELECT_THEME
"
data
.
toUpperCase
(
)
)
)
;
}
async
getAWContent
(
)
{
let
attributionData
=
await
this
.
sendQuery
(
"
AWPage
:
GET_ATTRIBUTION_DATA
"
)
;
if
(
attributionData
?
.
template
)
{
log
.
debug
(
"
Loading
about
:
welcome
with
RTAMO
attribution
data
"
)
;
return
Cu
.
cloneInto
(
attributionData
this
.
contentWindow
)
;
}
else
if
(
attributionData
?
.
ua
)
{
log
.
debug
(
"
Loading
about
:
welcome
with
UA
attribution
"
)
;
}
let
experimentMetadata
=
ExperimentAPI
.
getExperimentMetaData
(
{
featureId
:
"
aboutwelcome
"
}
)
|
|
{
}
;
log
.
debug
(
Loading
about
:
welcome
with
{
experimentMetadata
?
.
slug
?
?
"
no
"
}
experiment
)
;
let
featureConfig
=
NimbusFeatures
.
aboutwelcome
.
getAllVariables
(
)
;
featureConfig
.
needDefault
=
await
this
.
sendQuery
(
"
AWPage
:
NEED_DEFAULT
"
)
;
featureConfig
.
needPin
=
await
this
.
sendQuery
(
"
AWPage
:
DOES_APP_NEED_PIN
"
)
;
if
(
featureConfig
.
languageMismatchEnabled
)
{
featureConfig
.
appAndSystemLocaleInfo
=
await
this
.
sendQuery
(
"
AWPage
:
GET_APP_AND_SYSTEM_LOCALE_INFO
"
)
;
}
let
defaults
=
AboutWelcomeDefaults
.
getDefaults
(
)
;
return
Cu
.
cloneInto
(
await
AboutWelcomeDefaults
.
prepareContentForReact
(
{
.
.
.
attributionData
.
.
.
experimentMetadata
.
.
.
defaults
.
.
.
featureConfig
screens
:
featureConfig
.
screens
?
?
defaults
.
screens
}
)
this
.
contentWindow
)
;
}
AWGetFeatureConfig
(
)
{
return
this
.
wrapPromise
(
this
.
getAWContent
(
)
)
;
}
AWGetFxAMetricsFlowURI
(
)
{
return
this
.
wrapPromise
(
this
.
sendQuery
(
"
AWPage
:
FXA_METRICS_FLOW_URI
"
)
)
;
}
AWGetImportableSites
(
)
{
return
this
.
wrapPromise
(
getImportableSites
(
this
)
)
;
}
AWGetDefaultSites
(
)
{
return
this
.
wrapPromise
(
getDefaultSites
(
this
)
)
;
}
AWGetSelectedTheme
(
)
{
return
this
.
wrapPromise
(
getSelectedTheme
(
this
)
)
;
}
AWSendEventTelemetry
(
eventData
)
{
this
.
AWSendToParent
(
"
TELEMETRY_EVENT
"
{
.
.
.
eventData
event_context
:
{
.
.
.
eventData
.
event_context
}
}
)
;
}
AWSendToParent
(
type
data
)
{
this
.
sendAsyncMessage
(
AWPage
:
{
type
}
data
)
;
}
AWWaitForMigrationClose
(
)
{
return
this
.
wrapPromise
(
this
.
sendQuery
(
"
AWPage
:
WAIT_FOR_MIGRATION_CLOSE
"
)
)
;
}
AWGetRegion
(
)
{
return
this
.
wrapPromise
(
this
.
sendQuery
(
"
AWPage
:
GET_REGION
"
)
)
;
}
AWFinish
(
)
{
this
.
contentWindow
.
location
.
href
=
"
about
:
home
"
;
}
AWEnsureLangPackInstalled
(
langPack
)
{
return
this
.
sendQueryAndCloneForContent
(
"
AWPage
:
ENSURE_LANG_PACK_INSTALLED
"
langPack
)
;
}
AWSetRequestedLocales
(
requestSystemLocales
)
{
return
this
.
sendQueryAndCloneForContent
(
"
AWPage
:
SET_REQUESTED_LOCALES
"
requestSystemLocales
)
;
}
AWNegotiateLangPackForLanguageMismatch
(
appAndSystemLocaleInfo
)
{
return
this
.
sendQueryAndCloneForContent
(
"
AWPage
:
NEGOTIATE_LANGPACK
"
appAndSystemLocaleInfo
)
;
}
AWSendToDeviceEmailsSupported
(
)
{
return
this
.
wrapPromise
(
this
.
sendQuery
(
"
AWPage
:
SEND_TO_DEVICE_EMAILS_SUPPORTED
"
)
)
;
}
handleEvent
(
event
)
{
log
.
debug
(
Received
page
event
{
event
.
type
}
)
;
}
}
