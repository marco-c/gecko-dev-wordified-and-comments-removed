"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
AboutWelcomeTelemetry
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
lazy
=
{
}
;
XPCOMUtils
.
defineLazyModuleGetters
(
lazy
{
PingCentre
:
"
resource
:
/
/
/
modules
/
PingCentre
.
jsm
"
ClientID
:
"
resource
:
/
/
gre
/
modules
/
ClientID
.
jsm
"
TelemetrySession
:
"
resource
:
/
/
gre
/
modules
/
TelemetrySession
.
jsm
"
AttributionCode
:
"
resource
:
/
/
/
modules
/
AttributionCode
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyPreferenceGetter
(
lazy
"
structuredIngestionEndpointBase
"
"
browser
.
newtabpage
.
activity
-
stream
.
telemetry
.
structuredIngestion
.
endpoint
"
"
"
)
;
XPCOMUtils
.
defineLazyGetter
(
lazy
"
telemetryClientId
"
(
)
=
>
lazy
.
ClientID
.
getClientID
(
)
)
;
XPCOMUtils
.
defineLazyGetter
(
lazy
"
browserSessionId
"
(
)
=
>
lazy
.
TelemetrySession
.
getMetadata
(
"
"
)
.
sessionId
)
;
const
TELEMETRY_TOPIC
=
"
about
:
welcome
"
;
const
PING_TYPE
=
"
onboarding
"
;
const
PING_VERSION
=
"
1
"
;
const
STRUCTURED_INGESTION_NAMESPACE_MS
=
"
messaging
-
system
"
;
class
AboutWelcomeTelemetry
{
constructor
(
)
{
XPCOMUtils
.
defineLazyPreferenceGetter
(
this
"
telemetryEnabled
"
"
browser
.
newtabpage
.
activity
-
stream
.
telemetry
"
false
)
;
}
get
pingCentre
(
)
{
Object
.
defineProperty
(
this
"
pingCentre
"
{
value
:
new
lazy
.
PingCentre
(
{
topic
:
TELEMETRY_TOPIC
}
)
}
)
;
return
this
.
pingCentre
;
}
_generateStructuredIngestionEndpoint
(
)
{
const
uuid
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
;
const
docID
=
uuid
.
slice
(
1
-
1
)
;
const
extension
=
{
STRUCTURED_INGESTION_NAMESPACE_MS
}
/
{
PING_TYPE
}
/
{
PING_VERSION
}
/
{
docID
}
;
return
{
lazy
.
structuredIngestionEndpointBase
}
/
{
extension
}
;
}
_maybeAttachAttribution
(
ping
)
{
const
attribution
=
lazy
.
AttributionCode
.
getCachedAttributionData
(
)
;
if
(
attribution
&
&
Object
.
keys
(
attribution
)
.
length
)
{
ping
.
attribution
=
attribution
;
}
return
ping
;
}
async
_createPing
(
event
)
{
if
(
event
.
event_context
&
&
typeof
event
.
event_context
=
=
=
"
object
"
)
{
event
.
event_context
=
JSON
.
stringify
(
event
.
event_context
)
;
}
let
ping
=
{
.
.
.
event
addon_version
:
Services
.
appinfo
.
appBuildID
locale
:
Services
.
locale
.
appLocaleAsBCP47
client_id
:
await
lazy
.
telemetryClientId
browser_session_id
:
lazy
.
browserSessionId
}
;
return
this
.
_maybeAttachAttribution
(
ping
)
;
}
async
sendTelemetry
(
event
)
{
if
(
!
this
.
telemetryEnabled
)
{
return
;
}
const
ping
=
await
this
.
_createPing
(
event
)
;
this
.
pingCentre
.
sendStructuredIngestionPing
(
ping
this
.
_generateStructuredIngestionEndpoint
(
)
)
;
}
}
