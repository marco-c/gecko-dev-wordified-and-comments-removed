"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
ASRouterDefaultConfig
"
]
;
const
{
ASRouter
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouter
.
jsm
"
)
;
const
{
TelemetryFeed
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
TelemetryFeed
.
jsm
"
)
;
const
{
ASRouterParentProcessMessageHandler
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouterParentProcessMessageHandler
.
jsm
"
)
;
const
{
SpecialMessageActions
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
messaging
-
system
/
lib
/
SpecialMessageActions
.
jsm
"
)
;
const
{
ASRouterPreferences
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouterPreferences
.
jsm
"
)
;
const
{
QueryCache
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ASRouterTargeting
.
jsm
"
)
;
const
{
ActivityStreamStorage
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ActivityStreamStorage
.
jsm
"
)
;
const
createStorage
=
async
telemetryFeed
=
>
{
const
dbStore
=
new
ActivityStreamStorage
(
{
storeNames
:
[
"
sectionPrefs
"
"
snippets
"
]
telemetry
:
{
handleUndesiredEvent
:
e
=
>
telemetryFeed
.
SendASRouterUndesiredEvent
(
e
)
}
}
)
;
try
{
await
dbStore
.
db
;
}
catch
(
e
)
{
return
Promise
.
reject
(
e
)
;
}
return
dbStore
.
getDbTable
(
"
snippets
"
)
;
}
;
const
ASRouterDefaultConfig
=
(
)
=
>
{
const
router
=
ASRouter
;
const
telemetry
=
new
TelemetryFeed
(
)
;
const
messageHandler
=
new
ASRouterParentProcessMessageHandler
(
{
router
preferences
:
ASRouterPreferences
specialMessageActions
:
SpecialMessageActions
queryCache
:
QueryCache
sendTelemetry
:
telemetry
.
onAction
.
bind
(
telemetry
)
}
)
;
return
{
router
messageHandler
createStorage
:
createStorage
.
bind
(
null
telemetry
)
}
;
}
;
