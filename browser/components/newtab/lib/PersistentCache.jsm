"
use
strict
"
;
this
.
PersistentCache
=
class
PersistentCache
{
constructor
(
name
preload
=
false
)
{
this
.
name
=
name
;
this
.
_filename
=
activity
-
stream
.
{
name
}
.
json
;
if
(
preload
)
{
this
.
_load
(
)
;
}
}
async
set
(
key
value
)
{
const
data
=
await
this
.
_load
(
)
;
data
[
key
]
=
value
;
await
this
.
_persist
(
data
)
;
}
async
get
(
key
)
{
const
data
=
await
this
.
_load
(
)
;
return
key
?
data
[
key
]
:
data
;
}
_load
(
)
{
return
(
this
.
_cache
|
|
(
this
.
_cache
=
new
Promise
(
async
(
resolve
reject
)
=
>
{
let
filepath
;
try
{
filepath
=
PathUtils
.
join
(
PathUtils
.
localProfileDir
this
.
_filename
)
;
}
catch
(
error
)
{
reject
(
error
)
;
return
;
}
let
data
=
{
}
;
try
{
data
=
await
IOUtils
.
readJSON
(
filepath
)
;
}
catch
(
error
)
{
if
(
!
DOMException
.
isInstance
(
error
)
|
|
error
.
name
!
=
=
"
NotFoundError
"
)
{
Cu
.
reportError
(
Failed
to
parse
{
this
.
_filename
}
:
{
error
.
message
}
)
;
}
}
resolve
(
data
)
;
}
)
)
)
;
}
async
_persist
(
data
)
{
const
filepath
=
PathUtils
.
join
(
PathUtils
.
localProfileDir
this
.
_filename
)
;
await
IOUtils
.
writeJSON
(
filepath
data
{
tmpPath
:
{
filepath
}
.
tmp
}
)
;
}
}
;
const
EXPORTED_SYMBOLS
=
[
"
PersistentCache
"
]
;
