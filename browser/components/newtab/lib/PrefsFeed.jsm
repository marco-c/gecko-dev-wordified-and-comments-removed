"
use
strict
"
;
const
{
actionCreators
:
ac
actionTypes
:
at
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
common
/
Actions
.
jsm
"
)
;
const
{
Prefs
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
activity
-
stream
/
lib
/
ActivityStreamPrefs
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
PrivateBrowsingUtils
"
"
resource
:
/
/
gre
/
modules
/
PrivateBrowsingUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
AppConstants
"
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
ExperimentAPI
"
"
resource
:
/
/
messaging
-
system
/
experiments
/
ExperimentAPI
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
Region
"
"
resource
:
/
/
gre
/
modules
/
Region
.
jsm
"
)
;
this
.
PrefsFeed
=
class
PrefsFeed
{
constructor
(
prefMap
)
{
this
.
_prefMap
=
prefMap
;
this
.
_prefs
=
new
Prefs
(
)
;
this
.
onExperimentUpdated
=
this
.
onExperimentUpdated
.
bind
(
this
)
;
}
onPrefChanged
(
name
value
)
{
const
prefItem
=
this
.
_prefMap
.
get
(
name
)
;
if
(
prefItem
)
{
this
.
store
.
dispatch
(
ac
[
prefItem
.
skipBroadcast
?
"
OnlyToMain
"
:
"
BroadcastToContent
"
]
(
{
type
:
at
.
PREF_CHANGED
data
:
{
name
value
}
}
)
)
;
}
}
_setStringPref
(
values
key
defaultValue
)
{
this
.
_setPref
(
values
key
defaultValue
Services
.
prefs
.
getStringPref
)
;
}
_setBoolPref
(
values
key
defaultValue
)
{
this
.
_setPref
(
values
key
defaultValue
Services
.
prefs
.
getBoolPref
)
;
}
_setIntPref
(
values
key
defaultValue
)
{
this
.
_setPref
(
values
key
defaultValue
Services
.
prefs
.
getIntPref
)
;
}
_setPref
(
values
key
defaultValue
getPrefFunction
)
{
let
value
=
getPrefFunction
(
browser
.
newtabpage
.
activity
-
stream
.
{
key
}
defaultValue
)
;
values
[
key
]
=
value
;
this
.
_prefMap
.
set
(
key
{
value
}
)
;
}
getFeatureConfigFromExperimentData
(
experimentData
)
{
return
{
prefsButtonIcon
:
"
icon
-
settings
"
.
.
.
(
experimentData
?
.
branch
?
.
feature
?
.
value
|
|
{
}
)
}
;
}
addExperimentDataToValues
(
values
)
{
let
experimentData
;
try
{
experimentData
=
ExperimentAPI
.
getExperiment
(
{
featureId
:
"
newtab
"
}
)
;
}
catch
(
e
)
{
Cu
.
reportError
(
e
)
;
}
values
.
experimentData
=
experimentData
;
values
.
featureConfig
=
this
.
getFeatureConfigFromExperimentData
(
experimentData
)
;
}
onExperimentUpdated
(
event
experimentData
)
{
this
.
store
.
dispatch
(
ac
.
BroadcastToContent
(
{
type
:
at
.
PREF_CHANGED
data
:
{
name
:
"
experimentData
"
value
:
experimentData
}
}
)
)
;
this
.
store
.
dispatch
(
ac
.
BroadcastToContent
(
{
type
:
at
.
PREF_CHANGED
data
:
{
name
:
"
featureConfig
"
value
:
this
.
getFeatureConfigFromExperimentData
(
experimentData
)
}
}
)
)
;
}
init
(
)
{
this
.
_prefs
.
observeBranch
(
this
)
;
ExperimentAPI
.
on
(
"
update
"
{
featureId
:
"
newtab
"
}
this
.
onExperimentUpdated
)
;
this
.
_storage
=
this
.
store
.
dbStorage
.
getDbTable
(
"
sectionPrefs
"
)
;
const
values
=
{
}
;
for
(
const
name
of
this
.
_prefMap
.
keys
(
)
)
{
values
[
name
]
=
this
.
_prefs
.
get
(
name
)
;
}
values
.
isPrivateBrowsingEnabled
=
PrivateBrowsingUtils
.
enabled
;
values
.
platform
=
AppConstants
.
platform
;
if
(
Region
.
home
)
{
values
.
region
=
Region
.
home
;
this
.
geo
=
values
.
region
;
}
else
if
(
this
.
geo
!
=
=
"
"
)
{
Services
.
obs
.
addObserver
(
this
Region
.
REGION_TOPIC
)
;
this
.
geo
=
"
"
;
}
values
.
fxa_endpoint
=
Services
.
prefs
.
getStringPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
fxaccounts
.
endpoint
"
"
https
:
/
/
accounts
.
firefox
.
com
"
)
;
values
.
appUpdateChannel
=
Services
.
prefs
.
getStringPref
(
"
app
.
update
.
channel
"
"
"
)
;
let
searchTopSiteExperimentPrefValue
=
Services
.
prefs
.
getBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
improvesearch
.
topSiteSearchShortcuts
"
)
;
values
[
"
improvesearch
.
topSiteSearchShortcuts
"
]
=
searchTopSiteExperimentPrefValue
;
this
.
_prefMap
.
set
(
"
improvesearch
.
topSiteSearchShortcuts
"
{
value
:
searchTopSiteExperimentPrefValue
}
)
;
let
handoffToAwesomebarPrefValue
=
Services
.
prefs
.
getBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
improvesearch
.
handoffToAwesomebar
"
)
;
values
[
"
improvesearch
.
handoffToAwesomebar
"
]
=
handoffToAwesomebarPrefValue
;
this
.
_prefMap
.
set
(
"
improvesearch
.
handoffToAwesomebar
"
{
value
:
handoffToAwesomebarPrefValue
}
)
;
this
.
addExperimentDataToValues
(
values
)
;
this
.
_setBoolPref
(
values
"
newNewtabExperience
.
enabled
"
false
)
;
this
.
_setBoolPref
(
values
"
customizationMenu
.
enabled
"
false
)
;
this
.
_setBoolPref
(
values
"
logowordmark
.
alwaysVisible
"
false
)
;
this
.
_setBoolPref
(
values
"
feeds
.
section
.
topstories
"
false
)
;
this
.
_setBoolPref
(
values
"
discoverystream
.
enabled
"
false
)
;
this
.
_setBoolPref
(
values
"
discoverystream
.
isCollectionDismissible
"
false
)
;
this
.
_setBoolPref
(
values
"
discoverystream
.
hardcoded
-
basic
-
layout
"
false
)
;
this
.
_setBoolPref
(
values
"
discoverystream
.
recs
.
personalized
"
false
)
;
this
.
_setBoolPref
(
values
"
discoverystream
.
spocs
.
personalized
"
false
)
;
this
.
_setStringPref
(
values
"
discoverystream
.
personalization
.
modelKeys
"
"
"
)
;
this
.
_setIntPref
(
values
"
discoverystream
.
personalization
.
version
"
1
)
;
this
.
_setIntPref
(
values
"
discoverystream
.
personalization
.
overrideVersion
"
)
;
this
.
_setStringPref
(
values
"
discoverystream
.
spocs
-
endpoint
"
"
"
)
;
this
.
store
.
dispatch
(
ac
.
BroadcastToContent
(
{
type
:
at
.
PREFS_INITIAL_VALUES
data
:
values
meta
:
{
isStartup
:
true
}
}
)
)
;
}
uninit
(
)
{
this
.
removeListeners
(
)
;
}
removeListeners
(
)
{
this
.
_prefs
.
ignoreBranch
(
this
)
;
ExperimentAPI
.
off
(
this
.
onExperimentUpdated
)
;
if
(
this
.
geo
=
=
=
"
"
)
{
Services
.
obs
.
removeObserver
(
this
Region
.
REGION_TOPIC
)
;
}
}
async
_setIndexedDBPref
(
id
value
)
{
const
name
=
id
=
=
=
"
topsites
"
?
id
:
feeds
.
section
.
{
id
}
;
try
{
await
this
.
_storage
.
set
(
name
value
)
;
}
catch
(
e
)
{
Cu
.
reportError
(
"
Could
not
set
section
preferences
.
"
)
;
}
}
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
Region
.
REGION_TOPIC
:
if
(
data
=
=
=
Region
.
REGION_UPDATED
)
{
this
.
store
.
dispatch
(
ac
.
BroadcastToContent
(
{
type
:
at
.
PREF_CHANGED
data
:
{
name
:
"
region
"
value
:
Region
.
home
}
}
)
)
;
}
break
;
}
}
onAction
(
action
)
{
switch
(
action
.
type
)
{
case
at
.
INIT
:
this
.
init
(
)
;
break
;
case
at
.
UNINIT
:
this
.
uninit
(
)
;
break
;
case
at
.
CLEAR_PREF
:
Services
.
prefs
.
clearUserPref
(
this
.
_prefs
.
_branchStr
+
action
.
data
.
name
)
;
break
;
case
at
.
SET_PREF
:
this
.
_prefs
.
set
(
action
.
data
.
name
action
.
data
.
value
)
;
break
;
case
at
.
UPDATE_SECTION_PREFS
:
this
.
_setIndexedDBPref
(
action
.
data
.
id
action
.
data
.
value
)
;
break
;
}
}
}
;
const
EXPORTED_SYMBOLS
=
[
"
PrefsFeed
"
]
;
