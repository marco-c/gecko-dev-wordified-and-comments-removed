const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
IDNService
"
"
mozilla
.
org
/
network
/
idn
-
service
;
1
"
"
nsIIDNService
"
)
;
XPCOMUtils
.
defineLazyGlobalGetters
(
this
[
"
URL
"
]
)
;
function
handleIDNHost
(
hostname
)
{
try
{
return
IDNService
.
convertToDisplayIDN
(
hostname
{
}
)
;
}
catch
(
e
)
{
return
hostname
;
}
}
function
getETLD
(
host
)
{
try
{
return
Services
.
eTLD
.
getPublicSuffixFromHost
(
host
)
;
}
catch
(
err
)
{
return
"
"
;
}
}
function
shortURL
(
{
url
}
)
{
if
(
!
url
)
{
return
"
"
;
}
let
parsed
;
try
{
parsed
=
new
URL
(
url
)
;
}
catch
(
ex
)
{
return
url
;
}
const
hostname
=
parsed
.
hostname
.
replace
(
/
^
www
\
.
/
i
"
"
)
;
const
eTLD
=
getETLD
(
hostname
)
;
const
eTLDExtra
=
eTLD
.
length
>
0
?
-
(
eTLD
.
length
+
1
)
:
Infinity
;
return
(
handleIDNHost
(
hostname
.
slice
(
0
eTLDExtra
)
|
|
hostname
)
|
|
parsed
.
pathname
|
|
parsed
.
href
)
;
}
const
EXPORTED_SYMBOLS
=
[
"
shortURL
"
"
getETLD
"
]
;
