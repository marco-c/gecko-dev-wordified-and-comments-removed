"
use
strict
"
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
AppConstants
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
const
{
E10SUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
E10SUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
AboutNewTab
"
"
resource
:
/
/
/
modules
/
AboutNewTab
.
jsm
"
)
;
const
TOPIC_APP_QUIT
=
"
quit
-
application
-
granted
"
;
const
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
=
"
content
-
document
-
interactive
"
;
const
ABOUT_URL
=
"
about
:
newtab
"
;
const
BASE_URL
=
"
resource
:
/
/
activity
-
stream
/
"
;
const
ACTIVITY_STREAM_PAGES
=
new
Set
(
[
"
home
"
"
newtab
"
"
welcome
"
]
)
;
const
IS_MAIN_PROCESS
=
Services
.
appinfo
.
processType
=
=
=
Services
.
appinfo
.
PROCESS_TYPE_DEFAULT
;
const
IS_PRIVILEGED_PROCESS
=
Services
.
appinfo
.
remoteType
=
=
=
E10SUtils
.
PRIVILEGEDABOUT_REMOTE_TYPE
;
const
IS_RELEASE_OR_BETA
=
AppConstants
.
RELEASE_OR_BETA
;
const
PREF_SEPARATE_PRIVILEGEDABOUT_CONTENT_PROCESS
=
"
browser
.
tabs
.
remote
.
separatePrivilegedContentProcess
"
;
const
PREF_ACTIVITY_STREAM_DEBUG
=
"
browser
.
newtabpage
.
activity
-
stream
.
debug
"
;
function
AboutNewTabService
(
)
{
Services
.
obs
.
addObserver
(
this
TOPIC_APP_QUIT
)
;
Services
.
prefs
.
addObserver
(
PREF_SEPARATE_PRIVILEGEDABOUT_CONTENT_PROCESS
this
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
Services
.
prefs
.
addObserver
(
PREF_ACTIVITY_STREAM_DEBUG
this
)
;
}
this
.
toggleActivityStream
(
true
)
;
this
.
initialized
=
true
;
this
.
alreadyRecordedTopsitesPainted
=
false
;
if
(
IS_MAIN_PROCESS
)
{
AboutNewTab
.
init
(
)
;
}
else
if
(
IS_PRIVILEGED_PROCESS
)
{
Services
.
obs
.
addObserver
(
this
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
)
;
}
}
AboutNewTabService
.
prototype
=
{
_newTabURL
:
ABOUT_URL
_activityStreamEnabled
:
false
_activityStreamDebug
:
false
_privilegedAboutContentProcess
:
false
_overridden
:
false
willNotifyUser
:
false
classID
:
Components
.
ID
(
"
{
dfcd2adc
-
7867
-
4d3a
-
ba70
-
17501f208142
}
"
)
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIAboutNewTabService
Ci
.
nsIObserver
]
)
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
nsPref
:
changed
"
:
if
(
data
=
=
=
PREF_SEPARATE_PRIVILEGEDABOUT_CONTENT_PROCESS
)
{
this
.
_privilegedAboutContentProcess
=
Services
.
prefs
.
getBoolPref
(
PREF_SEPARATE_PRIVILEGEDABOUT_CONTENT_PROCESS
)
;
this
.
notifyChange
(
)
;
}
else
if
(
!
IS_RELEASE_OR_BETA
&
&
data
=
=
=
PREF_ACTIVITY_STREAM_DEBUG
)
{
this
.
_activityStreamDebug
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_DEBUG
false
)
;
this
.
notifyChange
(
)
;
}
break
;
case
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
:
{
const
win
=
subject
.
defaultView
;
if
(
win
=
=
=
null
)
{
break
;
}
if
(
!
ACTIVITY_STREAM_PAGES
.
has
(
win
.
location
.
pathname
)
)
{
break
;
}
const
onLoaded
=
(
)
=
>
{
const
debugString
=
this
.
_activityStreamDebug
?
"
-
dev
"
:
"
"
;
const
scripts
=
[
"
chrome
:
/
/
browser
/
content
/
contentSearchUI
.
js
"
"
chrome
:
/
/
browser
/
content
/
contentTheme
.
js
"
{
BASE_URL
}
vendor
/
react
{
debugString
}
.
js
{
BASE_URL
}
vendor
/
react
-
dom
{
debugString
}
.
js
{
BASE_URL
}
vendor
/
prop
-
types
.
js
{
BASE_URL
}
vendor
/
redux
.
js
{
BASE_URL
}
vendor
/
react
-
redux
.
js
{
BASE_URL
}
data
/
content
/
activity
-
stream
.
bundle
.
js
]
;
for
(
let
script
of
scripts
)
{
Services
.
scriptloader
.
loadSubScript
(
script
win
)
;
}
}
;
subject
.
addEventListener
(
"
DOMContentLoaded
"
onLoaded
{
once
:
true
}
)
;
const
onUnloaded
=
(
)
=
>
{
subject
.
removeEventListener
(
"
DOMContentLoaded
"
onLoaded
)
;
}
;
subject
.
addEventListener
(
"
unload
"
onUnloaded
{
once
:
true
}
)
;
break
;
}
case
TOPIC_APP_QUIT
:
this
.
uninit
(
)
;
if
(
IS_MAIN_PROCESS
)
{
AboutNewTab
.
uninit
(
)
;
}
else
if
(
IS_PRIVILEGED_PROCESS
)
{
Services
.
obs
.
removeObserver
(
this
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
)
;
}
break
;
}
}
notifyChange
(
)
{
Services
.
obs
.
notifyObservers
(
null
"
newtab
-
url
-
changed
"
this
.
_newTabURL
)
;
}
toggleActivityStream
(
stateEnabled
forceState
=
false
)
{
if
(
!
forceState
&
&
(
this
.
overridden
|
|
stateEnabled
=
=
=
this
.
activityStreamEnabled
)
)
{
return
false
;
}
if
(
stateEnabled
)
{
this
.
_activityStreamEnabled
=
true
;
}
else
{
this
.
_activityStreamEnabled
=
false
;
}
this
.
_privilegedAboutContentProcess
=
Services
.
prefs
.
getBoolPref
(
PREF_SEPARATE_PRIVILEGEDABOUT_CONTENT_PROCESS
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
this
.
_activityStreamDebug
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_DEBUG
false
)
;
}
this
.
_newtabURL
=
ABOUT_URL
;
return
true
;
}
get
defaultURL
(
)
{
return
[
"
resource
:
/
/
activity
-
stream
/
prerendered
/
"
"
activity
-
stream
"
this
.
_activityStreamDebug
&
&
!
this
.
_privilegedAboutContentProcess
?
"
-
debug
"
:
"
"
this
.
_privilegedAboutContentProcess
?
"
-
noscripts
"
:
"
"
"
.
html
"
]
.
join
(
"
"
)
;
}
get
welcomeURL
(
)
{
return
this
.
defaultURL
;
}
get
newTabURL
(
)
{
return
this
.
_newTabURL
;
}
set
newTabURL
(
aNewTabURL
)
{
let
newTabURL
=
aNewTabURL
.
trim
(
)
;
if
(
newTabURL
=
=
=
ABOUT_URL
)
{
this
.
resetNewTabURL
(
)
;
return
;
}
else
if
(
newTabURL
=
=
=
"
"
)
{
newTabURL
=
"
about
:
blank
"
;
}
this
.
toggleActivityStream
(
false
)
;
this
.
_newTabURL
=
newTabURL
;
this
.
_overridden
=
true
;
this
.
notifyChange
(
)
;
}
get
overridden
(
)
{
return
this
.
_overridden
;
}
get
activityStreamEnabled
(
)
{
return
this
.
_activityStreamEnabled
;
}
get
activityStreamDebug
(
)
{
return
this
.
_activityStreamDebug
;
}
resetNewTabURL
(
)
{
this
.
_overridden
=
false
;
this
.
_newTabURL
=
ABOUT_URL
;
this
.
toggleActivityStream
(
true
true
)
;
this
.
notifyChange
(
)
;
}
maybeRecordTopsitesPainted
(
timestamp
)
{
if
(
this
.
alreadyRecordedTopsitesPainted
)
{
return
;
}
const
SCALAR_KEY
=
"
timestamps
.
about_home_topsites_first_paint
"
;
let
startupInfo
=
Services
.
startup
.
getStartupInfo
(
)
;
let
processStartTs
=
startupInfo
.
process
.
getTime
(
)
;
let
delta
=
Math
.
round
(
timestamp
-
processStartTs
)
;
Services
.
telemetry
.
scalarSet
(
SCALAR_KEY
delta
)
;
this
.
alreadyRecordedTopsitesPainted
=
true
;
}
uninit
(
)
{
if
(
!
this
.
initialized
)
{
return
;
}
Services
.
obs
.
removeObserver
(
this
TOPIC_APP_QUIT
)
;
Services
.
prefs
.
removeObserver
(
PREF_SEPARATE_PRIVILEGEDABOUT_CONTENT_PROCESS
this
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
Services
.
prefs
.
removeObserver
(
PREF_ACTIVITY_STREAM_DEBUG
this
)
;
}
this
.
initialized
=
false
;
}
}
;
const
EXPORTED_SYMBOLS
=
[
"
AboutNewTabService
"
]
;
