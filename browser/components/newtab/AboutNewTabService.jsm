"
use
strict
"
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
AppConstants
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
const
{
E10SUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
E10SUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
AboutNewTab
"
"
resource
:
/
/
/
modules
/
AboutNewTab
.
jsm
"
)
;
const
TOPIC_APP_QUIT
=
"
quit
-
application
-
granted
"
;
const
TOPIC_LOCALES_CHANGE
=
"
intl
:
app
-
locales
-
changed
"
;
const
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
=
"
content
-
document
-
interactive
"
;
const
ACTIVITY_STREAM_BCP47
=
"
en
-
US
ach
an
ar
ast
az
be
bg
bn
-
BD
bn
-
IN
br
bs
ca
cak
crh
cs
cy
da
de
dsb
el
en
-
CA
en
-
GB
eo
es
-
AR
es
-
CL
es
-
ES
es
-
MX
et
eu
fa
ff
fi
fr
fy
-
NL
ga
-
IE
gd
gl
gn
gu
-
IN
he
hi
-
IN
hr
hsb
hu
hy
-
AM
ia
id
is
it
ja
ja
-
JP
-
macos
ka
kab
kk
km
kn
ko
lij
lo
lt
ltg
lv
mai
mk
ml
mr
ms
my
nb
-
NO
ne
-
NP
nl
nn
-
NO
oc
pa
-
IN
pl
pt
-
BR
pt
-
PT
rm
ro
ru
si
sk
sl
sq
sr
sv
-
SE
ta
te
th
tl
tr
uk
ur
uz
vi
zh
-
CN
zh
-
TW
"
.
split
(
"
"
)
;
const
ABOUT_URL
=
"
about
:
newtab
"
;
const
BASE_URL
=
"
resource
:
/
/
activity
-
stream
/
"
;
const
ACTIVITY_STREAM_PAGES
=
new
Set
(
[
"
home
"
"
newtab
"
"
welcome
"
]
)
;
const
IS_MAIN_PROCESS
=
Services
.
appinfo
.
processType
=
=
=
Services
.
appinfo
.
PROCESS_TYPE_DEFAULT
;
const
IS_PRIVILEGED_PROCESS
=
Services
.
appinfo
.
remoteType
=
=
=
E10SUtils
.
PRIVILEGED_REMOTE_TYPE
;
const
IS_RELEASE_OR_BETA
=
AppConstants
.
RELEASE_OR_BETA
;
const
PREF_SEPARATE_PRIVILEGED_CONTENT_PROCESS
=
"
browser
.
tabs
.
remote
.
separatePrivilegedContentProcess
"
;
const
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
=
"
browser
.
newtabpage
.
activity
-
stream
.
prerender
"
;
const
PREF_ACTIVITY_STREAM_DEBUG
=
"
browser
.
newtabpage
.
activity
-
stream
.
debug
"
;
function
AboutNewTabService
(
)
{
Services
.
obs
.
addObserver
(
this
TOPIC_APP_QUIT
)
;
Services
.
obs
.
addObserver
(
this
TOPIC_LOCALES_CHANGE
)
;
Services
.
prefs
.
addObserver
(
PREF_SEPARATE_PRIVILEGED_CONTENT_PROCESS
this
)
;
Services
.
prefs
.
addObserver
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
this
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
Services
.
prefs
.
addObserver
(
PREF_ACTIVITY_STREAM_DEBUG
this
)
;
}
this
.
toggleActivityStream
(
true
)
;
this
.
initialized
=
true
;
this
.
alreadyRecordedTopsitesPainted
=
false
;
if
(
IS_MAIN_PROCESS
)
{
AboutNewTab
.
init
(
)
;
}
else
if
(
IS_PRIVILEGED_PROCESS
)
{
Services
.
obs
.
addObserver
(
this
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
)
;
}
}
AboutNewTabService
.
prototype
=
{
_newTabURL
:
ABOUT_URL
_activityStreamEnabled
:
false
_activityStreamPrerender
:
false
_activityStreamPath
:
"
"
_activityStreamDebug
:
false
_privilegedContentProcess
:
false
_overridden
:
false
willNotifyUser
:
false
classID
:
Components
.
ID
(
"
{
dfcd2adc
-
7867
-
4d3a
-
ba70
-
17501f208142
}
"
)
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIAboutNewTabService
Ci
.
nsIObserver
]
)
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
nsPref
:
changed
"
:
if
(
data
=
=
=
PREF_SEPARATE_PRIVILEGED_CONTENT_PROCESS
)
{
this
.
_privilegedContentProcess
=
Services
.
prefs
.
getBoolPref
(
PREF_SEPARATE_PRIVILEGED_CONTENT_PROCESS
)
;
this
.
updatePrerenderedPath
(
)
;
this
.
notifyChange
(
)
;
}
else
if
(
data
=
=
=
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
)
{
this
.
_activityStreamPrerender
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
)
;
this
.
notifyChange
(
)
;
}
else
if
(
!
IS_RELEASE_OR_BETA
&
&
data
=
=
=
PREF_ACTIVITY_STREAM_DEBUG
)
{
this
.
_activityStreamDebug
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_DEBUG
false
)
;
this
.
updatePrerenderedPath
(
)
;
this
.
notifyChange
(
)
;
}
break
;
case
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
:
{
const
win
=
subject
.
defaultView
;
if
(
win
=
=
=
null
)
{
break
;
}
if
(
!
ACTIVITY_STREAM_PAGES
.
has
(
win
.
location
.
pathname
)
)
{
break
;
}
const
onLoaded
=
(
)
=
>
{
const
debugString
=
this
.
_activityStreamDebug
?
"
-
dev
"
:
"
"
;
const
scripts
=
[
"
chrome
:
/
/
browser
/
content
/
contentSearchUI
.
js
"
"
chrome
:
/
/
browser
/
content
/
contentTheme
.
js
"
{
BASE_URL
}
vendor
/
react
{
debugString
}
.
js
{
BASE_URL
}
vendor
/
react
-
dom
{
debugString
}
.
js
{
BASE_URL
}
vendor
/
prop
-
types
.
js
{
BASE_URL
}
vendor
/
react
-
intl
.
js
{
BASE_URL
}
vendor
/
redux
.
js
{
BASE_URL
}
vendor
/
react
-
redux
.
js
{
BASE_URL
}
prerendered
/
{
this
.
activityStreamLocale
}
/
activity
-
stream
-
strings
.
js
{
BASE_URL
}
data
/
content
/
activity
-
stream
.
bundle
.
js
]
;
if
(
this
.
_activityStreamPrerender
)
{
scripts
.
unshift
(
{
BASE_URL
}
prerendered
/
static
/
activity
-
stream
-
initial
-
state
.
js
)
;
}
for
(
let
script
of
scripts
)
{
Services
.
scriptloader
.
loadSubScript
(
script
win
)
;
}
}
;
subject
.
addEventListener
(
"
DOMContentLoaded
"
onLoaded
{
once
:
true
}
)
;
const
onUnloaded
=
(
)
=
>
{
subject
.
removeEventListener
(
"
DOMContentLoaded
"
onLoaded
)
;
}
;
subject
.
addEventListener
(
"
unload
"
onUnloaded
{
once
:
true
}
)
;
break
;
}
case
TOPIC_APP_QUIT
:
this
.
uninit
(
)
;
if
(
IS_MAIN_PROCESS
)
{
AboutNewTab
.
uninit
(
)
;
}
else
if
(
IS_PRIVILEGED_PROCESS
)
{
Services
.
obs
.
removeObserver
(
this
TOPIC_CONTENT_DOCUMENT_INTERACTIVE
)
;
}
break
;
case
TOPIC_LOCALES_CHANGE
:
this
.
updatePrerenderedPath
(
)
;
this
.
notifyChange
(
)
;
break
;
}
}
notifyChange
(
)
{
Services
.
obs
.
notifyObservers
(
null
"
newtab
-
url
-
changed
"
this
.
_newTabURL
)
;
}
toggleActivityStream
(
stateEnabled
forceState
=
false
)
{
if
(
!
forceState
&
&
(
this
.
overridden
|
|
stateEnabled
=
=
=
this
.
activityStreamEnabled
)
)
{
return
false
;
}
if
(
stateEnabled
)
{
this
.
_activityStreamEnabled
=
true
;
}
else
{
this
.
_activityStreamEnabled
=
false
;
}
this
.
_privilegedContentProcess
=
Services
.
prefs
.
getBoolPref
(
PREF_SEPARATE_PRIVILEGED_CONTENT_PROCESS
)
;
this
.
_activityStreamPrerender
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
this
.
_activityStreamDebug
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_DEBUG
false
)
;
}
this
.
updatePrerenderedPath
(
)
;
this
.
_newtabURL
=
ABOUT_URL
;
return
true
;
}
updatePrerenderedPath
(
)
{
this
.
_activityStreamPath
=
{
this
.
_activityStreamDebug
&
&
!
this
.
_privilegedContentProcess
?
"
static
"
:
this
.
activityStreamLocale
}
/
;
}
get
defaultURL
(
)
{
return
[
"
resource
:
/
/
activity
-
stream
/
prerendered
/
"
this
.
_activityStreamPath
"
activity
-
stream
"
this
.
_activityStreamPrerender
?
"
-
prerendered
"
:
"
"
this
.
_activityStreamDebug
&
&
!
this
.
_privilegedContentProcess
?
"
-
debug
"
:
"
"
this
.
_privilegedContentProcess
?
"
-
noscripts
"
:
"
"
"
.
html
"
]
.
join
(
"
"
)
;
}
get
welcomeURL
(
)
{
const
prerenderEnabled
=
this
.
_activityStreamPrerender
;
this
.
_activityStreamPrerender
=
false
;
const
url
=
this
.
defaultURL
;
this
.
_activityStreamPrerender
=
prerenderEnabled
;
return
url
;
}
get
newTabURL
(
)
{
return
this
.
_newTabURL
;
}
set
newTabURL
(
aNewTabURL
)
{
let
newTabURL
=
aNewTabURL
.
trim
(
)
;
if
(
newTabURL
=
=
=
ABOUT_URL
)
{
this
.
resetNewTabURL
(
)
;
return
;
}
else
if
(
newTabURL
=
=
=
"
"
)
{
newTabURL
=
"
about
:
blank
"
;
}
this
.
toggleActivityStream
(
false
)
;
this
.
_newTabURL
=
newTabURL
;
this
.
_overridden
=
true
;
this
.
notifyChange
(
)
;
}
get
overridden
(
)
{
return
this
.
_overridden
;
}
get
activityStreamEnabled
(
)
{
return
this
.
_activityStreamEnabled
;
}
get
activityStreamPrerender
(
)
{
return
this
.
_activityStreamPrerender
;
}
get
activityStreamDebug
(
)
{
return
this
.
_activityStreamDebug
;
}
get
activityStreamLocale
(
)
{
return
Services
.
locale
.
negotiateLanguages
(
Services
.
locale
.
appLocalesAsBCP47
.
map
(
l
=
>
l
.
replace
(
/
^
(
ja
-
JP
-
mac
)
/
"
1os
"
)
)
ACTIVITY_STREAM_BCP47
"
en
-
US
"
Services
.
locale
.
langNegStrategyLookup
)
[
0
]
.
replace
(
/
^
(
ja
-
JP
-
mac
)
os
/
"
1
"
)
;
}
resetNewTabURL
(
)
{
this
.
_overridden
=
false
;
this
.
_newTabURL
=
ABOUT_URL
;
this
.
toggleActivityStream
(
true
true
)
;
this
.
notifyChange
(
)
;
}
maybeRecordTopsitesPainted
(
timestamp
)
{
if
(
this
.
alreadyRecordedTopsitesPainted
)
{
return
;
}
const
SCALAR_KEY
=
"
timestamps
.
about_home_topsites_first_paint
"
;
let
startupInfo
=
Services
.
startup
.
getStartupInfo
(
)
;
let
processStartTs
=
startupInfo
.
process
.
getTime
(
)
;
let
delta
=
Math
.
round
(
timestamp
-
processStartTs
)
;
Services
.
telemetry
.
scalarSet
(
SCALAR_KEY
delta
)
;
this
.
alreadyRecordedTopsitesPainted
=
true
;
}
uninit
(
)
{
if
(
!
this
.
initialized
)
{
return
;
}
Services
.
obs
.
removeObserver
(
this
TOPIC_APP_QUIT
)
;
Services
.
obs
.
removeObserver
(
this
TOPIC_LOCALES_CHANGE
)
;
Services
.
prefs
.
removeObserver
(
PREF_SEPARATE_PRIVILEGED_CONTENT_PROCESS
this
)
;
Services
.
prefs
.
removeObserver
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
this
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
Services
.
prefs
.
removeObserver
(
PREF_ACTIVITY_STREAM_DEBUG
this
)
;
}
this
.
initialized
=
false
;
}
}
;
var
EXPORTED_SYMBOLS
=
[
"
AboutNewTabService
"
]
;
