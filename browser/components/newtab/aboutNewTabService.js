"
use
strict
"
;
const
{
utils
:
Cu
interfaces
:
Ci
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
AboutNewTab
"
"
resource
:
/
/
/
modules
/
AboutNewTab
.
jsm
"
)
;
const
LOCAL_NEWTAB_URL
=
"
chrome
:
/
/
browser
/
content
/
newtab
/
newTab
.
xhtml
"
;
const
ACTIVITY_STREAM_URLS
=
{
"
"
:
"
resource
:
/
/
activity
-
stream
/
data
/
content
/
activity
-
stream
.
html
"
"
debug
"
:
"
resource
:
/
/
activity
-
stream
/
data
/
content
/
activity
-
stream
-
debug
.
html
"
"
prerender
"
:
"
resource
:
/
/
activity
-
stream
/
data
/
content
/
activity
-
stream
-
prerendered
.
html
"
"
prerenderdebug
"
:
"
resource
:
/
/
activity
-
stream
/
data
/
content
/
activity
-
stream
-
prerendered
-
debug
.
html
"
}
;
const
ABOUT_URL
=
"
about
:
newtab
"
;
const
IS_MAIN_PROCESS
=
Services
.
appinfo
.
processType
=
=
=
Services
.
appinfo
.
PROCESS_TYPE_DEFAULT
;
const
IS_RELEASE_OR_BETA
=
AppConstants
.
RELEASE_OR_BETA
;
const
PREF_ACTIVITY_STREAM_ENABLED
=
"
browser
.
newtabpage
.
activity
-
stream
.
enabled
"
;
const
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
=
"
browser
.
newtabpage
.
activity
-
stream
.
prerender
"
;
const
PREF_ACTIVITY_STREAM_DEBUG
=
"
browser
.
newtabpage
.
activity
-
stream
.
debug
"
;
function
AboutNewTabService
(
)
{
Services
.
obs
.
addObserver
(
this
"
quit
-
application
-
granted
"
)
;
Services
.
prefs
.
addObserver
(
PREF_ACTIVITY_STREAM_ENABLED
this
)
;
Services
.
prefs
.
addObserver
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
this
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
Services
.
prefs
.
addObserver
(
PREF_ACTIVITY_STREAM_DEBUG
this
)
;
}
this
.
toggleActivityStream
(
)
;
this
.
initialized
=
true
;
if
(
IS_MAIN_PROCESS
)
{
AboutNewTab
.
init
(
)
;
}
}
AboutNewTabService
.
prototype
=
{
_newTabURL
:
ABOUT_URL
_activityStreamEnabled
:
false
_activityStreamPrerender
:
false
_activityStreamDebug
:
false
_overridden
:
false
classID
:
Components
.
ID
(
"
{
dfcd2adc
-
7867
-
4d3a
-
ba70
-
17501f208142
}
"
)
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsIAboutNewTabService
Ci
.
nsIObserver
]
)
_xpcom_categories
:
[
{
service
:
true
}
]
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
nsPref
:
changed
"
:
if
(
data
=
=
=
PREF_ACTIVITY_STREAM_ENABLED
)
{
if
(
this
.
toggleActivityStream
(
)
)
{
Services
.
obs
.
notifyObservers
(
null
"
newtab
-
url
-
changed
"
ABOUT_URL
)
;
}
}
else
if
(
data
=
=
=
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
)
{
this
.
_activityStreamPrerender
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
)
;
Services
.
obs
.
notifyObservers
(
null
"
newtab
-
url
-
changed
"
ABOUT_URL
)
;
}
else
if
(
!
IS_RELEASE_OR_BETA
&
&
data
=
=
=
PREF_ACTIVITY_STREAM_DEBUG
)
{
this
.
_activityStreamDebug
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_DEBUG
false
)
;
Services
.
obs
.
notifyObservers
(
null
"
newtab
-
url
-
changed
"
ABOUT_URL
)
;
}
break
;
case
"
quit
-
application
-
granted
"
:
this
.
uninit
(
)
;
if
(
IS_MAIN_PROCESS
)
{
AboutNewTab
.
uninit
(
)
;
}
break
;
}
}
toggleActivityStream
(
stateEnabled
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_ENABLED
)
forceState
=
false
)
{
if
(
!
forceState
&
&
(
this
.
overridden
|
|
stateEnabled
=
=
=
this
.
activityStreamEnabled
)
)
{
return
false
;
}
if
(
stateEnabled
)
{
this
.
_activityStreamEnabled
=
true
;
}
else
{
this
.
_activityStreamEnabled
=
false
;
}
this
.
_activityStreamPrerender
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
this
.
_activityStreamDebug
=
Services
.
prefs
.
getBoolPref
(
PREF_ACTIVITY_STREAM_DEBUG
false
)
;
}
this
.
_newtabURL
=
ABOUT_URL
;
return
true
;
}
get
defaultURL
(
)
{
if
(
this
.
activityStreamEnabled
)
{
const
prerender
=
this
.
activityStreamPrerender
?
"
prerender
"
:
"
"
;
const
debug
=
this
.
activityStreamDebug
?
"
debug
"
:
"
"
;
return
ACTIVITY_STREAM_URLS
[
prerender
+
debug
]
;
}
return
LOCAL_NEWTAB_URL
;
}
get
newTabURL
(
)
{
return
this
.
_newTabURL
;
}
set
newTabURL
(
aNewTabURL
)
{
aNewTabURL
=
aNewTabURL
.
trim
(
)
;
if
(
aNewTabURL
=
=
=
ABOUT_URL
)
{
this
.
resetNewTabURL
(
)
;
return
;
}
else
if
(
aNewTabURL
=
=
=
"
"
)
{
aNewTabURL
=
"
about
:
blank
"
;
}
this
.
toggleActivityStream
(
false
)
;
this
.
_newTabURL
=
aNewTabURL
;
this
.
_overridden
=
true
;
Services
.
obs
.
notifyObservers
(
null
"
newtab
-
url
-
changed
"
this
.
_newTabURL
)
;
}
get
overridden
(
)
{
return
this
.
_overridden
;
}
get
activityStreamEnabled
(
)
{
return
this
.
_activityStreamEnabled
;
}
get
activityStreamPrerender
(
)
{
return
this
.
_activityStreamPrerender
;
}
get
activityStreamDebug
(
)
{
return
this
.
_activityStreamDebug
;
}
resetNewTabURL
(
)
{
this
.
_overridden
=
false
;
this
.
_newTabURL
=
ABOUT_URL
;
this
.
toggleActivityStream
(
undefined
true
)
;
Services
.
obs
.
notifyObservers
(
null
"
newtab
-
url
-
changed
"
this
.
_newTabURL
)
;
}
uninit
(
)
{
if
(
!
this
.
initialized
)
{
return
;
}
Services
.
obs
.
removeObserver
(
this
"
quit
-
application
-
granted
"
)
;
Services
.
prefs
.
removeObserver
(
PREF_ACTIVITY_STREAM_ENABLED
this
)
;
Services
.
prefs
.
removeObserver
(
PREF_ACTIVITY_STREAM_PRERENDER_ENABLED
this
)
;
if
(
!
IS_RELEASE_OR_BETA
)
{
Services
.
prefs
.
removeObserver
(
PREF_ACTIVITY_STREAM_DEBUG
this
)
;
}
this
.
initialized
=
false
;
}
}
;
this
.
NSGetFactory
=
XPCOMUtils
.
generateNSGetFactory
(
[
AboutNewTabService
]
)
;
