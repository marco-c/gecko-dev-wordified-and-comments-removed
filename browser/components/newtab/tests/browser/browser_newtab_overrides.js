"
use
strict
"
;
let
Cu
=
Components
.
utils
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Preferences
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
aboutNewTabService
"
"
mozilla
.
org
/
browser
/
aboutnewtab
-
service
;
1
"
"
nsIAboutNewTabService
"
)
;
registerCleanupFunction
(
function
(
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
enabled
"
false
)
;
aboutNewTabService
.
resetNewTabURL
(
)
;
}
)
;
add_task
(
async
function
redirector_ignores_override
(
)
{
let
overrides
=
[
"
chrome
:
/
/
browser
/
content
/
downloads
/
contentAreaDownloadsView
.
xul
"
"
about
:
home
"
]
;
for
(
let
overrideURL
of
overrides
)
{
let
notificationPromise
=
nextChangeNotificationPromise
(
overrideURL
newtab
page
now
points
to
{
overrideURL
}
)
;
aboutNewTabService
.
newTabURL
=
overrideURL
;
await
notificationPromise
;
Assert
.
ok
(
aboutNewTabService
.
overridden
"
url
has
been
overridden
"
)
;
let
tabOptions
=
{
gBrowser
url
:
"
about
:
newtab
"
}
;
await
BrowserTestUtils
.
withNewTab
(
tabOptions
async
function
(
browser
)
{
await
ContentTask
.
spawn
(
browser
{
}
async
function
(
)
{
Assert
.
equal
(
content
.
location
.
href
"
about
:
newtab
"
"
Got
right
URL
"
)
;
Assert
.
equal
(
content
.
document
.
location
.
href
"
about
:
newtab
"
"
Got
right
URL
"
)
;
Assert
.
equal
(
content
.
document
.
nodePrincipal
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
"
nodePrincipal
should
match
systemPrincipal
"
)
;
}
)
;
}
)
;
}
}
)
;
add_task
(
async
function
override_loads_in_browser
(
)
{
let
overrides
=
[
"
chrome
:
/
/
browser
/
content
/
downloads
/
contentAreaDownloadsView
.
xul
"
"
about
:
home
"
"
about
:
home
"
]
;
for
(
let
overrideURL
of
overrides
)
{
let
notificationPromise
=
nextChangeNotificationPromise
(
overrideURL
.
trim
(
)
newtab
page
now
points
to
{
overrideURL
}
)
;
aboutNewTabService
.
newTabURL
=
overrideURL
;
await
notificationPromise
;
Assert
.
ok
(
aboutNewTabService
.
overridden
"
url
has
been
overridden
"
)
;
BrowserOpenTab
(
)
;
let
browser
=
gBrowser
.
selectedBrowser
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
await
ContentTask
.
spawn
(
browser
{
url
:
overrideURL
}
async
function
(
args
)
{
Assert
.
equal
(
content
.
location
.
href
args
.
url
.
trim
(
)
"
Got
right
URL
"
)
;
Assert
.
equal
(
content
.
document
.
location
.
href
args
.
url
.
trim
(
)
"
Got
right
URL
"
)
;
}
)
;
await
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
}
}
)
;
add_task
(
async
function
override_blank_loads_in_browser
(
)
{
let
overrides
=
[
"
"
"
"
"
\
n
\
t
"
"
about
:
blank
"
]
;
for
(
let
overrideURL
of
overrides
)
{
let
notificationPromise
=
nextChangeNotificationPromise
(
"
about
:
blank
"
"
newtab
page
now
points
to
about
:
blank
"
)
;
aboutNewTabService
.
newTabURL
=
overrideURL
;
await
notificationPromise
;
Assert
.
ok
(
aboutNewTabService
.
overridden
"
url
has
been
overridden
"
)
;
BrowserOpenTab
(
)
;
let
browser
=
gBrowser
.
selectedBrowser
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
await
ContentTask
.
spawn
(
browser
{
}
async
function
(
)
{
Assert
.
equal
(
content
.
location
.
href
"
about
:
blank
"
"
Got
right
URL
"
)
;
Assert
.
equal
(
content
.
document
.
location
.
href
"
about
:
blank
"
"
Got
right
URL
"
)
;
}
)
;
await
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
}
}
)
;
function
nextChangeNotificationPromise
(
aNewURL
testMessage
)
{
return
TestUtils
.
topicObserved
(
"
newtab
-
url
-
changed
"
function
observer
(
aSubject
aData
)
{
Assert
.
equal
(
aData
aNewURL
testMessage
)
;
return
true
;
}
)
;
}
