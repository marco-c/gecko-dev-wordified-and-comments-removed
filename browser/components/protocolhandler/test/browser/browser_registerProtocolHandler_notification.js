const
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
com
"
)
;
const
SECURITY_DELAY
=
3000
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
security
.
notification_enable_delay
"
SECURITY_DELAY
]
]
}
)
;
let
notificationValue
=
"
Protocol
Registration
:
web
+
testprotocol
"
;
let
testURI
=
TEST_PATH
+
"
browser_registerProtocolHandler_notification
.
html
"
;
BrowserTestUtils
.
startLoadingURIString
(
window
.
gBrowser
.
selectedBrowser
testURI
)
;
await
TestUtils
.
waitForCondition
(
function
(
)
{
let
notificationBox
=
window
.
gBrowser
.
getNotificationBox
(
)
;
let
notification
=
notificationBox
.
getNotificationWithValue
(
notificationValue
)
;
return
notification
;
}
"
Still
can
not
get
notification
after
retrying
100
times
.
"
100
100
)
;
let
notificationBox
=
window
.
gBrowser
.
getNotificationBox
(
)
;
let
notification
=
notificationBox
.
getNotificationWithValue
(
notificationValue
)
;
ok
(
notification
"
Notification
box
should
be
displayed
"
)
;
if
(
notification
=
=
null
)
{
finish
(
)
;
return
;
}
is
(
notification
.
getAttribute
(
"
type
"
)
"
info
"
"
We
expect
this
notification
to
have
the
type
of
'
info
'
.
"
)
;
is
(
notification
.
messageImage
.
getAttribute
(
"
src
"
)
"
chrome
:
/
/
global
/
skin
/
icons
/
info
-
filled
.
svg
"
"
We
expect
this
notification
to
have
an
icon
.
"
)
;
let
buttons
=
notification
.
buttonContainer
.
getElementsByClassName
(
"
notification
-
button
"
)
;
is
(
buttons
.
length
1
"
We
expect
see
one
button
.
"
)
;
let
button
=
buttons
[
0
]
;
isnot
(
button
.
label
null
"
We
expect
the
add
button
to
have
a
label
.
"
)
;
todo
(
button
.
accesskey
"
We
expect
the
add
button
to
have
a
accesskey
.
"
)
;
ok
(
button
.
disabled
"
We
expect
the
button
to
be
disabled
initially
.
"
)
;
let
timeoutMS
=
SECURITY_DELAY
+
100
;
info
(
Wait
{
timeoutMS
}
ms
for
the
button
to
enable
.
)
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
SECURITY_DELAY
+
100
)
)
;
ok
(
!
button
.
disabled
"
We
expect
the
button
to
be
enabled
after
the
security
delay
.
"
)
;
}
)
;
