"
use
strict
"
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
toolkit
/
components
/
translations
/
tests
/
browser
/
shared
-
head
.
js
"
this
)
;
const
getIntlDisplayName
=
(
(
)
=
>
{
let
displayNames
=
null
;
return
langTag
=
>
{
if
(
!
displayNames
)
{
displayNames
=
new
Services
.
intl
.
DisplayNames
(
undefined
{
type
:
"
language
"
fallback
:
"
none
"
}
)
;
}
return
displayNames
.
of
(
langTag
)
;
}
;
}
)
(
)
;
class
FullPageTranslationsTestUtils
{
static
async
assertPageIsTranslated
(
fromLanguage
toLanguage
runInPage
message
=
null
)
{
if
(
message
)
{
info
(
message
)
;
}
info
(
"
Checking
that
the
page
is
translated
"
)
;
const
callback
=
async
(
TranslationsTest
{
fromLang
toLang
}
)
=
>
{
const
{
getH1
}
=
TranslationsTest
.
getSelectors
(
)
;
await
TranslationsTest
.
assertTranslationResult
(
"
The
page
'
s
H1
is
translated
.
"
getH1
DON
QUIJOTE
DE
LA
MANCHA
[
{
fromLang
}
to
{
toLang
}
html
]
)
;
}
;
await
runInPage
(
callback
{
fromLang
:
fromLanguage
toLang
:
toLanguage
}
)
;
await
assertLangTagIsShownOnTranslationsButton
(
fromLanguage
toLanguage
)
;
}
static
async
assertPageIsUntranslated
(
runInPage
message
=
null
)
{
if
(
message
)
{
info
(
message
)
;
}
info
(
"
Checking
that
the
page
is
untranslated
"
)
;
await
runInPage
(
async
TranslationsTest
=
>
{
const
{
getH1
}
=
TranslationsTest
.
getSelectors
(
)
;
await
TranslationsTest
.
assertTranslationResult
(
"
The
page
'
s
H1
is
untranslated
and
in
the
original
Spanish
.
"
getH1
"
Don
Quijote
de
La
Mancha
"
)
;
}
)
;
}
static
async
assertTranslationsButton
(
visibleAssertions
message
)
{
const
elements
=
{
button
:
document
.
getElementById
(
"
translations
-
button
"
)
icon
:
document
.
getElementById
(
"
translations
-
button
-
icon
"
)
circleArrows
:
document
.
getElementById
(
"
translations
-
button
-
circle
-
arrows
"
)
locale
:
document
.
getElementById
(
"
translations
-
button
-
locale
"
)
}
;
for
(
const
[
name
element
]
of
Object
.
entries
(
elements
)
)
{
if
(
!
element
)
{
throw
new
Error
(
"
Could
not
find
the
"
+
name
)
;
}
}
try
{
await
waitForCondition
(
(
)
=
>
{
for
(
const
[
name
visible
]
of
Object
.
entries
(
visibleAssertions
)
)
{
if
(
elements
[
name
]
.
hidden
=
=
=
visible
)
{
return
false
;
}
}
return
true
;
}
message
)
;
}
catch
(
error
)
{
for
(
const
[
name
expected
]
of
Object
.
entries
(
visibleAssertions
)
)
{
is
(
!
elements
[
name
]
.
hidden
expected
Visibility
for
"
{
name
}
"
)
;
}
}
ok
(
true
message
)
;
return
elements
;
}
static
async
openTranslationsPanel
(
{
onOpenPanel
=
null
openFromAppMenu
=
false
openWithKeyboard
=
false
}
)
{
logAction
(
)
;
await
closeTranslationsPanelIfOpen
(
)
;
if
(
openFromAppMenu
)
{
await
FullPageTranslationsTestUtils
.
#
openTranslationsPanelViaAppMenu
(
{
onOpenPanel
openWithKeyboard
}
)
;
}
else
{
await
FullPageTranslationsTestUtils
.
#
openTranslationsPanelViaTranslationsButton
(
{
onOpenPanel
openWithKeyboard
}
)
;
}
}
static
async
#
openTranslationsPanelViaAppMenu
(
{
onOpenPanel
=
null
openWithKeyboard
=
false
}
)
{
logAction
(
)
;
const
appMenuButton
=
getById
(
"
PanelUI
-
menu
-
button
"
)
;
if
(
openWithKeyboard
)
{
hitEnterKey
(
appMenuButton
"
Opening
the
app
-
menu
button
with
keyboard
"
)
;
}
else
{
click
(
appMenuButton
"
Opening
the
app
-
menu
button
"
)
;
}
await
BrowserTestUtils
.
waitForEvent
(
window
.
PanelUI
.
mainView
"
ViewShown
"
)
;
const
translateSiteButton
=
getById
(
"
appMenu
-
translate
-
button
"
)
;
is
(
translateSiteButton
.
disabled
false
"
The
app
-
menu
translate
button
should
be
enabled
"
)
;
await
waitForTranslationsPopupEvent
(
"
popupshown
"
(
)
=
>
{
if
(
openWithKeyboard
)
{
hitEnterKey
(
translateSiteButton
"
Opening
the
popup
with
keyboard
"
)
;
}
else
{
click
(
translateSiteButton
"
Opening
the
popup
"
)
;
}
}
onOpenPanel
)
;
}
static
async
#
openTranslationsPanelViaTranslationsButton
(
{
onOpenPanel
=
null
openWithKeyboard
=
false
}
)
{
logAction
(
)
;
const
{
button
}
=
await
FullPageTranslationsTestUtils
.
assertTranslationsButton
(
{
button
:
true
}
"
The
translations
button
is
visible
.
"
)
;
await
waitForTranslationsPopupEvent
(
"
popupshown
"
(
)
=
>
{
if
(
openWithKeyboard
)
{
hitEnterKey
(
button
"
Opening
the
popup
with
keyboard
"
)
;
}
else
{
click
(
button
"
Opening
the
popup
"
)
;
}
}
onOpenPanel
)
;
}
}
function
logAction
(
.
.
.
params
)
{
const
error
=
new
Error
(
)
;
const
stackLines
=
error
.
stack
.
split
(
"
\
n
"
)
;
const
actionName
=
stackLines
[
1
]
?
.
split
(
"
"
)
[
0
]
?
?
"
"
;
const
taskFileLocation
=
stackLines
[
2
]
?
.
split
(
"
"
)
[
1
]
?
?
"
"
;
if
(
taskFileLocation
.
includes
(
"
head
.
js
"
)
)
{
return
;
}
info
(
Action
:
{
actionName
}
(
{
params
.
join
(
"
"
)
}
)
)
;
info
(
Source
:
{
taskFileLocation
.
replace
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
"
"
"
)
}
)
;
}
async
function
openTranslationsSettingsMenu
(
)
{
logAction
(
)
;
const
gearIcons
=
getAllByL10nId
(
"
translations
-
panel
-
settings
-
button
"
)
;
for
(
const
gearIcon
of
gearIcons
)
{
if
(
gearIcon
.
hidden
)
{
continue
;
}
click
(
gearIcon
"
Open
the
settings
menu
"
)
;
info
(
"
Waiting
for
settings
menu
to
open
.
"
)
;
const
manageLanguages
=
await
waitForCondition
(
(
)
=
>
maybeGetByL10nId
(
"
translations
-
panel
-
settings
-
manage
-
languages
"
)
)
;
ok
(
manageLanguages
"
The
manage
languages
item
should
be
visible
in
the
settings
menu
.
"
)
;
return
;
}
}
function
switchSelectedFromLanguage
(
langTag
)
{
logAction
(
langTag
)
;
const
{
fromMenuList
}
=
TranslationsPanel
.
elements
;
fromMenuList
.
value
=
langTag
;
fromMenuList
.
dispatchEvent
(
new
Event
(
"
command
"
)
)
;
}
function
assertSelectedFromLanguage
(
langTag
)
{
info
(
Checking
that
the
selected
from
-
language
matches
{
langTag
}
)
;
const
{
fromMenuList
}
=
TranslationsPanel
.
elements
;
is
(
fromMenuList
.
value
langTag
"
Expected
selected
from
-
language
to
match
the
given
language
tag
"
)
;
}
function
switchSelectedToLanguage
(
langTag
)
{
logAction
(
langTag
)
;
const
{
toMenuList
}
=
TranslationsPanel
.
elements
;
toMenuList
.
value
=
langTag
;
toMenuList
.
dispatchEvent
(
new
Event
(
"
command
"
)
)
;
}
function
assertSelectedToLanguage
(
langTag
)
{
info
(
Checking
that
the
selected
to
-
language
matches
{
langTag
}
)
;
const
{
toMenuList
}
=
TranslationsPanel
.
elements
;
is
(
toMenuList
.
value
langTag
"
Expected
selected
to
-
language
to
match
the
given
language
tag
"
)
;
}
async
function
clickSettingsMenuItemByL10nId
(
l10nId
)
{
logAction
(
l10nId
)
;
info
(
Toggling
the
"
{
l10nId
}
"
settings
menu
item
.
)
;
click
(
getByL10nId
(
l10nId
)
Clicking
the
"
{
l10nId
}
"
settings
menu
item
.
)
;
await
closeSettingsMenuIfOpen
(
)
;
}
async
function
clickAlwaysOfferTranslations
(
)
{
logAction
(
)
;
await
clickSettingsMenuItemByL10nId
(
"
translations
-
panel
-
settings
-
always
-
offer
-
translation
"
)
;
}
async
function
clickAlwaysTranslateLanguage
(
{
downloadHandler
=
null
pivotTranslation
=
false
}
=
{
}
)
{
logAction
(
)
;
await
clickSettingsMenuItemByL10nId
(
"
translations
-
panel
-
settings
-
always
-
translate
-
language
"
)
;
if
(
downloadHandler
)
{
await
FullPageTranslationsTestUtils
.
assertTranslationsButton
(
{
button
:
true
circleArrows
:
true
locale
:
false
icon
:
true
}
"
The
icon
presents
the
loading
indicator
.
"
)
;
await
downloadHandler
(
pivotTranslation
?
2
:
1
)
;
}
}
async
function
clickNeverTranslateLanguage
(
)
{
logAction
(
)
;
await
clickSettingsMenuItemByL10nId
(
"
translations
-
panel
-
settings
-
never
-
translate
-
language
"
)
;
}
async
function
clickNeverTranslateSite
(
)
{
logAction
(
)
;
await
clickSettingsMenuItemByL10nId
(
"
translations
-
panel
-
settings
-
never
-
translate
-
site
"
)
;
}
async
function
clickManageLanguages
(
)
{
logAction
(
)
;
await
clickSettingsMenuItemByL10nId
(
"
translations
-
panel
-
settings
-
manage
-
languages
"
)
;
}
async
function
assertIsAlwaysOfferTranslationsEnabled
(
checked
)
{
info
(
Checking
that
always
-
offer
-
translations
is
{
checked
?
"
enabled
"
:
"
disabled
"
}
)
;
await
assertCheckboxState
(
"
translations
-
panel
-
settings
-
always
-
offer
-
translation
"
{
checked
}
)
;
}
async
function
assertIsAlwaysTranslateLanguage
(
langTag
{
checked
=
true
disabled
=
false
}
)
{
info
(
Checking
that
always
-
translate
is
{
checked
?
"
enabled
"
:
"
disabled
"
}
for
"
{
langTag
}
"
)
;
await
assertCheckboxState
(
"
translations
-
panel
-
settings
-
always
-
translate
-
language
"
{
langTag
checked
disabled
}
)
;
}
async
function
assertIsNeverTranslateLanguage
(
langTag
{
checked
=
true
disabled
=
false
}
)
{
info
(
Checking
that
never
-
translate
is
{
checked
?
"
enabled
"
:
"
disabled
"
}
for
"
{
langTag
}
"
)
;
await
assertCheckboxState
(
"
translations
-
panel
-
settings
-
never
-
translate
-
language
"
{
langTag
checked
disabled
}
)
;
}
async
function
assertIsNeverTranslateSite
(
url
{
checked
=
true
disabled
=
false
}
)
{
info
(
Checking
that
never
-
translate
is
{
checked
?
"
enabled
"
:
"
disabled
"
}
for
"
{
url
}
"
)
;
await
assertCheckboxState
(
"
translations
-
panel
-
settings
-
never
-
translate
-
site
"
{
checked
disabled
}
)
;
}
async
function
assertCheckboxState
(
dataL10nId
{
langTag
=
null
checked
=
true
disabled
=
false
}
)
{
const
menuItems
=
getAllByL10nId
(
dataL10nId
)
;
for
(
const
menuItem
of
menuItems
)
{
if
(
langTag
)
{
const
{
args
:
{
language
}
}
=
document
.
l10n
.
getAttributes
(
menuItem
)
;
is
(
language
getIntlDisplayName
(
langTag
)
Should
match
expected
language
display
name
for
{
dataL10nId
}
)
;
}
is
(
menuItem
.
disabled
disabled
Should
match
expected
disabled
state
for
{
dataL10nId
}
)
;
await
waitForCondition
(
(
)
=
>
menuItem
.
getAttribute
(
"
checked
"
)
=
=
=
(
checked
?
"
true
"
:
"
false
"
)
"
Waiting
for
checkbox
state
"
)
;
is
(
menuItem
.
getAttribute
(
"
checked
"
)
checked
?
"
true
"
:
"
false
"
Should
match
expected
checkbox
state
for
{
dataL10nId
}
)
;
}
}
async
function
assertLangTagIsShownOnTranslationsButton
(
fromLanguage
toLanguage
)
{
info
(
Ensuring
that
the
translations
button
displays
the
language
tag
"
{
toLanguage
}
"
)
;
const
{
button
locale
}
=
await
FullPageTranslationsTestUtils
.
assertTranslationsButton
(
{
button
:
true
circleArrows
:
false
locale
:
true
icon
:
true
}
"
The
icon
presents
the
locale
.
"
)
;
is
(
locale
.
innerText
toLanguage
The
expected
language
tag
"
{
toLanguage
}
"
is
shown
.
)
;
is
(
button
.
getAttribute
(
"
data
-
l10n
-
id
"
)
"
urlbar
-
translations
-
button
-
translated
"
)
;
const
fromLangDisplay
=
getIntlDisplayName
(
fromLanguage
)
;
const
toLangDisplay
=
getIntlDisplayName
(
toLanguage
)
;
is
(
button
.
getAttribute
(
"
data
-
l10n
-
args
"
)
{
"
fromLanguage
"
:
"
{
fromLangDisplay
}
"
"
toLanguage
"
:
"
{
toLangDisplay
}
"
}
)
;
}
async
function
clickCancelButton
(
)
{
logAction
(
)
;
const
{
cancelButton
}
=
TranslationsPanel
.
elements
;
assertIsVisible
(
true
{
element
:
cancelButton
}
)
;
await
waitForTranslationsPopupEvent
(
"
popuphidden
"
(
)
=
>
{
click
(
cancelButton
"
Clicking
the
cancel
button
"
)
;
}
)
;
}
async
function
clickRestoreButton
(
)
{
logAction
(
)
;
const
{
restoreButton
}
=
TranslationsPanel
.
elements
;
assertIsVisible
(
true
{
element
:
restoreButton
}
)
;
await
waitForTranslationsPopupEvent
(
"
popuphidden
"
(
)
=
>
{
click
(
restoreButton
"
Click
the
restore
-
page
button
"
)
;
}
)
;
}
async
function
clickDismissErrorButton
(
)
{
logAction
(
)
;
const
{
dismissErrorButton
}
=
TranslationsPanel
.
elements
;
assertIsVisible
(
true
{
element
:
dismissErrorButton
}
)
;
await
waitForTranslationsPopupEvent
(
"
popuphidden
"
(
)
=
>
{
click
(
dismissErrorButton
"
Click
the
dismiss
-
error
button
"
)
;
}
)
;
}
async
function
clickTranslateButton
(
{
downloadHandler
=
null
pivotTranslation
=
false
}
=
{
}
)
{
logAction
(
)
;
const
{
translateButton
}
=
TranslationsPanel
.
elements
;
assertIsVisible
(
true
{
element
:
translateButton
}
)
;
await
waitForTranslationsPopupEvent
(
"
popuphidden
"
(
)
=
>
{
click
(
translateButton
)
;
}
)
;
if
(
downloadHandler
)
{
await
FullPageTranslationsTestUtils
.
assertTranslationsButton
(
{
button
:
true
circleArrows
:
true
locale
:
false
icon
:
true
}
"
The
icon
presents
the
loading
indicator
.
"
)
;
await
downloadHandler
(
pivotTranslation
?
2
:
1
)
;
}
}
async
function
clickChangeSourceLanguageButton
(
{
firstShow
=
false
}
=
{
}
)
{
logAction
(
)
;
const
{
changeSourceLanguageButton
}
=
TranslationsPanel
.
elements
;
assertIsVisible
(
true
{
element
:
changeSourceLanguageButton
}
)
;
await
waitForTranslationsPopupEvent
(
"
popupshown
"
(
)
=
>
{
click
(
changeSourceLanguageButton
"
Click
the
change
-
source
-
language
button
"
)
;
}
firstShow
?
assertPanelFirstShowView
:
assertPanelDefaultView
)
;
}
function
assertPanelElementVisibility
(
expectations
=
{
}
)
{
const
finalExpectations
=
{
cancelButton
:
false
changeSourceLanguageButton
:
false
dismissErrorButton
:
false
error
:
false
fromMenuList
:
false
fromLabel
:
false
header
:
false
intro
:
false
introLearnMoreLink
:
false
langSelection
:
false
restoreButton
:
false
toLabel
:
false
toMenuList
:
false
translateButton
:
false
unsupportedHeader
:
false
unsupportedHint
:
false
unsupportedLearnMoreLink
:
false
.
.
.
expectations
}
;
const
elements
=
TranslationsPanel
.
elements
;
for
(
const
propertyName
in
finalExpectations
)
{
ok
(
elements
.
hasOwnProperty
(
propertyName
)
Expected
translations
panel
elements
to
have
property
{
propertyName
}
)
;
if
(
finalExpectations
.
hasOwnProperty
(
propertyName
)
)
{
assertIsVisible
(
finalExpectations
[
propertyName
]
{
element
:
elements
[
propertyName
]
}
)
;
}
}
}
function
assertPanelMainViewId
(
expectedId
)
{
const
mainViewId
=
TranslationsPanel
.
elements
.
multiview
.
getAttribute
(
"
mainViewId
"
)
;
is
(
mainViewId
expectedId
"
The
TranslationsPanel
mainViewId
should
match
its
expected
value
"
)
;
}
const
defaultViewVisibilityExpectations
=
{
cancelButton
:
true
fromMenuList
:
true
fromLabel
:
true
header
:
true
langSelection
:
true
toMenuList
:
true
toLabel
:
true
translateButton
:
true
}
;
function
assertDefaultHeaderL10nId
(
l10nId
)
{
const
{
header
}
=
TranslationsPanel
.
elements
;
is
(
header
.
getAttribute
(
"
data
-
l10n
-
id
"
)
l10nId
"
The
translations
panel
header
should
match
the
expected
data
-
l10n
-
id
"
)
;
}
function
assertPanelDefaultView
(
)
{
info
(
"
Checking
that
the
panel
shows
the
default
view
"
)
;
assertPanelMainViewId
(
"
translations
-
panel
-
view
-
default
"
)
;
assertPanelElementVisibility
(
{
.
.
.
defaultViewVisibilityExpectations
}
)
;
assertDefaultHeaderL10nId
(
"
translations
-
panel
-
header
"
)
;
}
function
assertPanelLoadingView
(
)
{
info
(
"
Checking
that
the
panel
shows
the
loading
view
"
)
;
assertPanelDefaultView
(
)
;
const
loadingButton
=
getByL10nId
(
"
translations
-
panel
-
translate
-
button
-
loading
"
)
;
ok
(
loadingButton
"
The
loading
button
is
present
"
)
;
ok
(
loadingButton
.
disabled
"
The
loading
button
is
disabled
"
)
;
}
function
assertPanelErrorView
(
)
{
info
(
"
Checking
that
the
panel
shows
the
error
view
"
)
;
assertPanelMainViewId
(
"
translations
-
panel
-
view
-
default
"
)
;
assertPanelElementVisibility
(
{
error
:
true
.
.
.
defaultViewVisibilityExpectations
}
)
;
assertDefaultHeaderL10nId
(
"
translations
-
panel
-
header
"
)
;
}
function
assertPanelFirstShowView
(
)
{
info
(
"
Checking
that
the
panel
shows
the
first
-
show
view
"
)
;
assertPanelMainViewId
(
"
translations
-
panel
-
view
-
default
"
)
;
assertPanelElementVisibility
(
{
intro
:
true
introLearnMoreLink
:
true
.
.
.
defaultViewVisibilityExpectations
}
)
;
assertDefaultHeaderL10nId
(
"
translations
-
panel
-
intro
-
header
"
)
;
}
function
assertPanelFirstShowErrorView
(
)
{
info
(
"
Checking
that
the
panel
shows
the
first
-
show
error
view
"
)
;
assertPanelMainViewId
(
"
translations
-
panel
-
view
-
default
"
)
;
assertPanelElementVisibility
(
{
error
:
true
intro
:
true
introLearnMoreLink
:
true
.
.
.
defaultViewVisibilityExpectations
}
)
;
assertDefaultHeaderL10nId
(
"
translations
-
panel
-
intro
-
header
"
)
;
}
function
assertPanelRevisitView
(
)
{
info
(
"
Checking
that
the
panel
shows
the
revisit
view
"
)
;
assertPanelMainViewId
(
"
translations
-
panel
-
view
-
default
"
)
;
assertPanelElementVisibility
(
{
header
:
true
langSelection
:
true
restoreButton
:
true
toLabel
:
true
toMenuList
:
true
translateButton
:
true
}
)
;
assertDefaultHeaderL10nId
(
"
translations
-
panel
-
revisit
-
header
"
)
;
}
function
assertPanelUnsupportedLanguageView
(
)
{
info
(
"
Checking
that
the
panel
shows
the
unsupported
-
language
view
"
)
;
assertPanelMainViewId
(
"
translations
-
panel
-
view
-
unsupported
-
language
"
)
;
assertPanelElementVisibility
(
{
changeSourceLanguageButton
:
true
dismissErrorButton
:
true
unsupportedHeader
:
true
unsupportedHint
:
true
unsupportedLearnMoreLink
:
true
}
)
;
}
async
function
navigate
(
message
{
url
onOpenPanel
=
null
downloadHandler
=
null
pivotTranslation
=
false
}
)
{
logAction
(
)
;
await
closeTranslationsPanelIfOpen
(
)
;
info
(
message
)
;
BrowserTestUtils
.
startLoadingURIString
(
gBrowser
.
selectedBrowser
BLANK_PAGE
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
const
loadTargetPage
=
async
(
)
=
>
{
BrowserTestUtils
.
startLoadingURIString
(
gBrowser
.
selectedBrowser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
if
(
downloadHandler
)
{
await
FullPageTranslationsTestUtils
.
assertTranslationsButton
(
{
button
:
true
circleArrows
:
true
locale
:
false
icon
:
true
}
"
The
icon
presents
the
loading
indicator
.
"
)
;
await
downloadHandler
(
pivotTranslation
?
2
:
1
)
;
}
}
;
info
(
Loading
url
:
"
{
url
}
"
)
;
if
(
onOpenPanel
)
{
await
waitForTranslationsPopupEvent
(
"
popupshown
"
loadTargetPage
onOpenPanel
)
;
}
else
{
await
loadTargetPage
(
)
;
}
}
async
function
toggleReaderMode
(
)
{
logAction
(
)
;
const
readerButton
=
document
.
getElementById
(
"
reader
-
mode
-
button
"
)
;
await
waitForCondition
(
(
)
=
>
readerButton
.
hidden
=
=
=
false
)
;
readerButton
.
getAttribute
(
"
readeractive
"
)
?
info
(
"
Exiting
reader
mode
"
)
:
info
(
"
Entering
reader
mode
"
)
;
const
readyPromise
=
readerButton
.
getAttribute
(
"
readeractive
"
)
?
waitForCondition
(
(
)
=
>
!
readerButton
.
getAttribute
(
"
readeractive
"
)
)
:
BrowserTestUtils
.
waitForContentEvent
(
gBrowser
.
selectedBrowser
"
AboutReaderContentReady
"
)
;
click
(
readerButton
"
Clicking
the
reader
-
mode
button
"
)
;
await
readyPromise
;
}
async
function
addTab
(
url
)
{
logAction
(
url
)
;
const
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
url
true
)
;
return
{
tab
removeTab
(
)
{
BrowserTestUtils
.
removeTab
(
tab
)
;
}
}
;
}
async
function
switchTab
(
tab
name
)
{
logAction
(
"
tab
"
name
)
;
gBrowser
.
selectedTab
=
tab
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
0
)
)
;
}
function
click
(
element
message
)
{
logAction
(
message
)
;
return
new
Promise
(
resolve
=
>
{
element
.
addEventListener
(
"
click
"
function
(
)
{
resolve
(
)
;
}
{
once
:
true
}
)
;
EventUtils
.
synthesizeMouseAtCenter
(
element
{
type
:
"
mousedown
"
isSynthesized
:
false
}
)
;
EventUtils
.
synthesizeMouseAtCenter
(
element
{
type
:
"
mouseup
"
isSynthesized
:
false
}
)
;
}
)
;
}
function
isVisible
(
element
)
{
if
(
element
.
offsetParent
=
=
=
null
)
{
return
false
;
}
const
win
=
element
.
ownerDocument
.
ownerGlobal
;
const
{
visibility
display
}
=
win
.
getComputedStyle
(
element
)
;
return
visibility
=
=
=
"
visible
"
&
&
display
!
=
=
"
none
"
;
}
function
assertIsVisible
(
expected
{
element
id
}
)
{
if
(
id
&
&
element
)
{
throw
new
Error
(
"
assertIsVisible
(
)
expects
either
an
element
or
an
id
but
both
were
specified
.
"
)
;
}
if
(
element
)
{
return
is
(
isVisible
(
element
)
expected
Expected
element
with
id
'
{
element
.
id
}
'
to
be
{
expected
?
"
visible
"
:
"
invisible
"
}
.
)
;
}
if
(
id
)
{
return
is
(
maybeGetById
(
id
)
!
=
=
null
expected
Expected
element
with
id
'
{
id
}
'
to
be
{
expected
?
"
visible
"
:
"
invisible
"
}
.
)
;
}
throw
new
Error
(
"
assertIsVisible
(
)
was
called
with
no
specified
element
or
id
.
"
)
;
}
async
function
openContextMenu
(
runInPage
{
selectFirstParagraph
selectSpanishParagraph
openAtFirstParagraph
openAtSpanishParagraph
openAtEnglishHyperlink
openAtSpanishHyperlink
}
)
{
logAction
(
)
;
if
(
selectFirstParagraph
=
=
=
true
)
{
await
runInPage
(
async
TranslationsTest
=
>
{
const
{
getFirstParagraph
}
=
TranslationsTest
.
getSelectors
(
)
;
const
paragraph
=
getFirstParagraph
(
)
;
TranslationsTest
.
selectContentElement
(
paragraph
)
;
}
)
;
}
if
(
selectSpanishParagraph
=
=
=
true
)
{
await
runInPage
(
async
TranslationsTest
=
>
{
const
{
getSpanishParagraph
}
=
TranslationsTest
.
getSelectors
(
)
;
const
paragraph
=
getSpanishParagraph
(
)
;
TranslationsTest
.
selectContentElement
(
paragraph
)
;
}
)
;
}
if
(
openAtFirstParagraph
=
=
=
true
)
{
await
runInPage
(
async
TranslationsTest
=
>
{
const
{
getFirstParagraph
}
=
TranslationsTest
.
getSelectors
(
)
;
const
paragraph
=
getFirstParagraph
(
)
;
await
TranslationsTest
.
rightClickContentElement
(
paragraph
)
;
}
)
;
return
;
}
if
(
openAtSpanishParagraph
=
=
=
true
)
{
await
runInPage
(
async
TranslationsTest
=
>
{
const
{
getSpanishParagraph
}
=
TranslationsTest
.
getSelectors
(
)
;
const
paragraph
=
getSpanishParagraph
(
)
;
await
TranslationsTest
.
rightClickContentElement
(
paragraph
)
;
}
)
;
return
;
}
if
(
openAtEnglishHyperlink
=
=
=
true
)
{
await
runInPage
(
async
TranslationsTest
=
>
{
const
{
getEnglishHyperlink
}
=
TranslationsTest
.
getSelectors
(
)
;
const
hyperlink
=
getEnglishHyperlink
(
)
;
await
TranslationsTest
.
rightClickContentElement
(
hyperlink
)
;
}
)
;
return
;
}
if
(
openAtSpanishHyperlink
=
=
=
true
)
{
await
runInPage
(
async
TranslationsTest
=
>
{
const
{
getSpanishHyperlink
}
=
TranslationsTest
.
getSelectors
(
)
;
const
hyperlink
=
getSpanishHyperlink
(
)
;
await
TranslationsTest
.
rightClickContentElement
(
hyperlink
)
;
}
)
;
return
;
}
throw
new
Error
(
"
openContextMenu
(
)
was
not
provided
a
declaration
for
which
element
to
open
the
menu
at
.
"
)
;
}
async
function
assertContextMenuTranslateSelectionItem
(
runInPage
{
selectFirstParagraph
selectSpanishParagraph
expectMenuItemIsVisible
expectedTargetLanguage
openAtFirstParagraph
openAtSpanishParagraph
openAtEnglishHyperlink
openAtSpanishHyperlink
}
message
)
{
logAction
(
)
;
if
(
message
)
{
info
(
message
)
;
}
await
closeTranslationsPanelIfOpen
(
)
;
await
closeContextMenuIfOpen
(
)
;
await
openContextMenu
(
runInPage
{
selectFirstParagraph
selectSpanishParagraph
openAtFirstParagraph
openAtSpanishParagraph
openAtEnglishHyperlink
openAtSpanishHyperlink
}
)
;
const
menuItem
=
maybeGetById
(
"
context
-
translate
-
selection
"
false
)
;
if
(
expectMenuItemIsVisible
!
=
=
undefined
)
{
assertIsVisible
(
expectMenuItemIsVisible
{
element
:
menuItem
}
)
;
}
if
(
expectMenuItemIsVisible
=
=
=
true
)
{
if
(
expectedTargetLanguage
)
{
const
expectedL10nId
=
selectFirstParagraph
=
=
=
true
|
|
selectSpanishParagraph
=
=
=
true
?
"
main
-
context
-
menu
-
translate
-
selection
-
to
-
language
"
:
"
main
-
context
-
menu
-
translate
-
link
-
text
-
to
-
language
"
;
await
waitForCondition
(
(
)
=
>
menuItem
.
getAttribute
(
"
data
-
l10n
-
id
"
)
=
=
=
expectedL10nId
Waiting
for
translate
-
selection
context
menu
item
to
localize
with
target
language
{
expectedTargetLanguage
}
)
;
is
(
menuItem
.
getAttribute
(
"
data
-
l10n
-
id
"
)
expectedL10nId
"
Expected
the
translate
-
selection
context
menu
item
to
be
localized
with
a
target
language
.
"
)
;
const
l10nArgs
=
JSON
.
parse
(
menuItem
.
getAttribute
(
"
data
-
l10n
-
args
"
)
)
;
is
(
l10nArgs
.
language
getIntlDisplayName
(
expectedTargetLanguage
)
Expected
the
translate
-
selection
context
menu
item
to
have
the
target
language
'
{
expectedTargetLanguage
}
'
.
)
;
}
else
{
const
expectedL10nId
=
selectFirstParagraph
=
=
=
true
|
|
selectSpanishParagraph
=
=
=
true
?
"
main
-
context
-
menu
-
translate
-
selection
"
:
"
main
-
context
-
menu
-
translate
-
link
-
text
"
;
await
waitForCondition
(
(
)
=
>
menuItem
.
getAttribute
(
"
data
-
l10n
-
id
"
)
=
=
=
expectedL10nId
"
Waiting
for
translate
-
selection
context
menu
item
to
localize
without
target
language
.
"
)
;
is
(
menuItem
.
getAttribute
(
"
data
-
l10n
-
id
"
)
expectedL10nId
"
Expected
the
translate
-
selection
context
menu
item
to
be
localized
without
a
target
language
.
"
)
;
}
}
await
closeContextMenuIfOpen
(
)
;
}
function
getByL10nId
(
l10nId
doc
=
document
)
{
const
elements
=
doc
.
querySelectorAll
(
[
data
-
l10n
-
id
=
"
{
l10nId
}
"
]
)
;
if
(
elements
.
length
=
=
=
0
)
{
throw
new
Error
(
"
Could
not
find
the
element
by
l10n
id
:
"
+
l10nId
)
;
}
for
(
const
element
of
elements
)
{
if
(
isVisible
(
element
)
)
{
return
element
;
}
}
throw
new
Error
(
"
The
element
is
not
visible
in
the
DOM
:
"
+
l10nId
)
;
}
function
getAllByL10nId
(
l10nId
doc
=
document
)
{
const
elements
=
doc
.
querySelectorAll
(
[
data
-
l10n
-
id
=
"
{
l10nId
}
"
]
)
;
console
.
log
(
doc
)
;
if
(
elements
.
length
=
=
=
0
)
{
throw
new
Error
(
"
Could
not
find
the
element
by
l10n
id
:
"
+
l10nId
)
;
}
return
elements
;
}
function
getById
(
id
doc
=
document
)
{
const
element
=
maybeGetById
(
id
true
doc
)
;
if
(
!
element
)
{
throw
new
Error
(
"
The
element
is
not
visible
in
the
DOM
:
#
"
+
id
)
;
}
return
element
;
}
function
maybeGetById
(
id
ensureIsVisible
=
true
doc
=
document
)
{
const
element
=
doc
.
getElementById
(
id
)
;
if
(
!
element
)
{
throw
new
Error
(
"
Could
not
find
the
element
by
id
:
#
"
+
id
)
;
}
if
(
!
ensureIsVisible
)
{
return
element
;
}
if
(
isVisible
(
element
)
)
{
return
element
;
}
return
null
;
}
function
maybeGetByL10nId
(
l10nId
doc
=
document
)
{
const
selector
=
[
data
-
l10n
-
id
=
"
{
l10nId
}
"
]
;
const
elements
=
doc
.
querySelectorAll
(
selector
)
;
for
(
const
element
of
elements
)
{
if
(
isVisible
(
element
)
)
{
return
element
;
}
}
return
null
;
}
async
function
waitForTranslationsPopupEvent
(
eventName
callback
postEventAssertion
=
null
)
{
TranslationsPanel
.
elements
;
const
panel
=
document
.
getElementById
(
"
translations
-
panel
"
)
;
if
(
!
panel
)
{
throw
new
Error
(
"
Unable
to
find
the
translations
panel
element
.
"
)
;
}
const
promise
=
BrowserTestUtils
.
waitForEvent
(
panel
eventName
)
;
await
callback
(
)
;
info
(
"
Waiting
for
the
translations
panel
popup
to
be
shown
"
)
;
await
promise
;
if
(
postEventAssertion
)
{
postEventAssertion
(
)
;
}
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
0
)
)
;
}
async
function
waitForViewShown
(
callback
)
{
const
panel
=
document
.
getElementById
(
"
translations
-
panel
"
)
;
if
(
!
panel
)
{
throw
new
Error
(
"
Unable
to
find
the
translations
panel
element
.
"
)
;
}
const
promise
=
BrowserTestUtils
.
waitForEvent
(
panel
"
ViewShown
"
)
;
callback
(
)
;
info
(
"
Waiting
for
the
translations
panel
view
to
be
shown
"
)
;
await
promise
;
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
0
)
)
;
}
async
function
openAboutPreferencesTranslationsSettingsPane
(
settingsButton
)
{
const
document
=
gBrowser
.
selectedBrowser
.
contentDocument
;
const
promise
=
BrowserTestUtils
.
waitForEvent
(
document
"
paneshown
"
false
event
=
>
event
.
detail
.
category
=
=
=
"
paneTranslations
"
)
;
click
(
settingsButton
"
Click
settings
button
"
)
;
await
promise
;
const
elements
=
{
backButton
:
document
.
getElementById
(
"
translations
-
settings
-
back
-
button
"
)
header
:
document
.
getElementById
(
"
translations
-
settings
-
header
"
)
}
;
return
elements
;
}
