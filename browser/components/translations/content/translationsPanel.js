var
TranslationsPanel
=
new
(
class
{
#
console
;
detectedLanguages
=
null
;
get
console
(
)
{
if
(
!
this
.
#
console
)
{
this
.
#
console
=
console
.
createInstance
(
{
maxLogLevelPref
:
"
browser
.
translations
.
logLevel
"
prefix
:
"
Translations
"
}
)
;
}
return
this
.
#
console
;
}
#
lazyElements
;
get
elements
(
)
{
if
(
!
this
.
#
lazyElements
)
{
const
wrapper
=
document
.
getElementById
(
"
template
-
translations
-
panel
"
)
;
const
panel
=
wrapper
.
content
.
firstElementChild
;
wrapper
.
replaceWith
(
wrapper
.
content
)
;
const
settingsButton
=
document
.
getElementById
(
"
translations
-
panel
-
settings
"
)
;
for
(
const
header
of
panel
.
querySelectorAll
(
"
.
panel
-
header
"
)
)
{
if
(
header
.
contains
(
settingsButton
)
)
{
continue
;
}
header
.
appendChild
(
settingsButton
.
cloneNode
(
true
)
)
;
}
this
.
#
lazyElements
=
{
panel
settingsButton
}
;
const
getter
=
(
name
id
)
=
>
{
let
element
;
Object
.
defineProperty
(
this
.
#
lazyElements
name
{
get
:
(
)
=
>
{
if
(
!
element
)
{
element
=
document
.
getElementById
(
id
)
;
}
if
(
!
element
)
{
throw
new
Error
(
Could
not
find
"
{
name
}
"
at
"
#
{
id
}
"
.
)
;
}
return
element
;
}
}
)
;
}
;
getter
(
"
button
"
"
translations
-
button
"
)
;
getter
(
"
buttonLocale
"
"
translations
-
button
-
locale
"
)
;
getter
(
"
buttonCircleArrows
"
"
translations
-
button
-
circle
-
arrows
"
)
;
getter
(
"
defaultDescription
"
"
translations
-
panel
-
default
-
description
"
)
;
getter
(
"
defaultToMenuList
"
"
translations
-
panel
-
default
-
to
"
)
;
getter
(
"
dualFromMenuList
"
"
translations
-
panel
-
dual
-
from
"
)
;
getter
(
"
dualToMenuList
"
"
translations
-
panel
-
dual
-
to
"
)
;
getter
(
"
dualTranslate
"
"
translations
-
panel
-
dual
-
translate
"
)
;
getter
(
"
error
"
"
translations
-
panel
-
error
"
)
;
getter
(
"
errorMessage
"
"
translations
-
panel
-
error
-
message
"
)
;
getter
(
"
multiview
"
"
translations
-
panel
-
multiview
"
)
;
getter
(
"
notNow
"
"
translations
-
panel
-
not
-
now
"
)
;
getter
(
"
revisitHeader
"
"
translations
-
panel
-
revisit
-
header
"
)
;
getter
(
"
revisitMenuList
"
"
translations
-
panel
-
revisit
-
to
"
)
;
getter
(
"
revisitTranslate
"
"
translations
-
panel
-
revisit
-
translate
"
)
;
}
return
this
.
#
lazyElements
;
}
#
getTranslationsActor
(
)
{
const
actor
=
gBrowser
.
selectedBrowser
.
browsingContext
.
currentWindowGlobal
.
getActor
(
"
Translations
"
)
;
if
(
!
actor
)
{
throw
new
Error
(
"
Unable
to
get
the
TranslationsParent
"
)
;
}
return
actor
;
}
async
#
fetchDetectedLanguages
(
)
{
this
.
detectedLanguages
=
await
this
.
#
getTranslationsActor
(
)
.
getLangTagsForTranslation
(
)
;
return
this
.
detectedLanguages
;
}
async
#
getCachedDetectedLanguages
(
)
{
if
(
!
this
.
detectedLanguages
)
{
return
this
.
#
fetchDetectedLanguages
(
)
;
}
return
this
.
detectedLanguages
;
}
#
langListsPhase
=
"
uninitialized
"
;
async
#
ensureLangListsBuilt
(
)
{
switch
(
this
.
#
langListsPhase
)
{
case
"
initialized
"
:
return
;
case
"
error
"
:
this
.
#
langListsPhase
=
"
uninitialized
"
;
break
;
case
"
uninitialized
"
:
break
;
default
:
this
.
console
.
error
(
"
Unknown
langList
phase
"
this
.
#
langListsPhase
)
;
}
try
{
const
{
languagePairs
fromLanguages
toLanguages
}
=
await
this
.
#
getTranslationsActor
(
)
.
getSupportedLanguages
(
)
;
if
(
languagePairs
.
length
=
=
=
0
)
{
throw
new
Error
(
"
No
translation
languages
were
retrieved
.
"
)
;
}
const
{
panel
}
=
this
.
elements
;
const
fromPopups
=
panel
.
querySelectorAll
(
"
.
translations
-
panel
-
language
-
menupopup
-
from
"
)
;
const
toPopups
=
panel
.
querySelectorAll
(
"
.
translations
-
panel
-
language
-
menupopup
-
to
"
)
;
for
(
const
popup
of
fromPopups
)
{
for
(
const
{
langTag
isBeta
displayName
}
of
fromLanguages
)
{
const
fromMenuItem
=
document
.
createXULElement
(
"
menuitem
"
)
;
fromMenuItem
.
setAttribute
(
"
value
"
langTag
)
;
if
(
isBeta
)
{
document
.
l10n
.
setAttributes
(
fromMenuItem
"
translations
-
panel
-
displayname
-
beta
"
{
language
:
displayName
}
)
;
}
else
{
fromMenuItem
.
setAttribute
(
"
label
"
displayName
)
;
}
popup
.
appendChild
(
fromMenuItem
)
;
}
}
for
(
const
popup
of
toPopups
)
{
for
(
const
{
langTag
isBeta
displayName
}
of
toLanguages
)
{
const
toMenuItem
=
document
.
createXULElement
(
"
menuitem
"
)
;
toMenuItem
.
setAttribute
(
"
value
"
langTag
)
;
if
(
isBeta
)
{
document
.
l10n
.
setAttributes
(
toMenuItem
"
translations
-
panel
-
displayname
-
beta
"
{
language
:
displayName
}
)
;
}
else
{
toMenuItem
.
setAttribute
(
"
label
"
displayName
)
;
}
popup
.
appendChild
(
toMenuItem
)
;
}
}
this
.
#
langListsPhase
=
"
initialized
"
;
}
catch
(
error
)
{
this
.
console
.
error
(
error
)
;
this
.
#
langListsPhase
=
"
error
"
;
}
}
showDualView
(
)
{
const
{
dualTranslate
dualFromMenuList
dualToMenuList
multiview
defaultToMenuList
panel
}
=
this
.
elements
;
dualFromMenuList
.
value
=
"
"
;
dualToMenuList
.
value
=
defaultToMenuList
.
value
;
dualTranslate
.
disabled
=
true
;
multiview
.
showSubView
(
"
translations
-
panel
-
view
-
dual
"
)
;
panel
.
addEventListener
(
"
ViewShown
"
(
)
=
>
{
dualFromMenuList
.
focus
(
)
;
}
{
once
:
true
}
)
;
}
async
#
showDefaultView
(
)
{
await
this
.
#
ensureLangListsBuilt
(
)
;
const
actor
=
this
.
#
getTranslationsActor
(
)
;
const
{
defaultToMenuList
defaultDescription
multiview
}
=
this
.
elements
;
multiview
.
setAttribute
(
"
mainViewId
"
"
translations
-
panel
-
view
-
default
"
)
;
defaultToMenuList
.
value
=
"
"
;
const
langTags
=
await
actor
.
getLangTagsForTranslation
(
)
;
if
(
langTags
)
{
const
{
docLangTag
appLangTag
}
=
langTags
;
defaultToMenuList
.
value
=
appLangTag
;
this
.
#
docLangTag
=
docLangTag
;
}
else
{
this
.
#
docLangTag
=
"
en
"
;
this
.
console
.
error
(
"
No
language
tags
for
translation
were
found
.
"
)
;
}
const
displayNames
=
new
Services
.
intl
.
DisplayNames
(
undefined
{
type
:
"
language
"
}
)
;
document
.
l10n
.
setAttributes
(
defaultDescription
"
translations
-
panel
-
default
-
description
"
{
pageLanguage
:
displayNames
.
of
(
this
.
#
docLangTag
)
}
)
;
if
(
!
this
.
#
wasPanelShown
)
{
this
.
#
wasPanelShown
=
true
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
translations
.
panel
.
wasShown
"
true
)
;
}
for
(
const
menuitem
of
defaultToMenuList
.
querySelectorAll
(
"
menuitem
"
)
)
{
menuitem
.
disabled
=
menuitem
.
value
=
=
=
this
.
#
docLangTag
;
}
}
async
#
updateSettingsMenuLanguageCheckboxStates
(
)
{
const
{
docLangTag
isDocLangTagSupported
}
=
await
this
.
#
getCachedDetectedLanguages
(
)
;
const
{
panel
}
=
this
.
elements
;
const
alwaysTranslateMenuItems
=
panel
.
querySelectorAll
(
"
.
always
-
translate
-
language
-
menuitem
"
)
;
const
neverTranslateMenuItems
=
panel
.
querySelectorAll
(
"
.
never
-
translate
-
language
-
menuitem
"
)
;
if
(
!
docLangTag
|
|
!
isDocLangTagSupported
|
|
docLangTag
=
=
=
new
Intl
.
Locale
(
Services
.
locale
.
appLocaleAsBCP47
)
.
language
)
{
for
(
const
menuitem
of
alwaysTranslateMenuItems
)
{
menuitem
.
disabled
=
true
;
}
for
(
const
menuitem
of
neverTranslateMenuItems
)
{
menuitem
.
disabled
=
true
;
}
return
;
}
const
alwaysTranslateLanguage
=
TranslationsParent
.
shouldAlwaysTranslateLanguage
(
docLangTag
)
;
const
neverTranslateLanguage
=
TranslationsParent
.
shouldNeverTranslateLanguage
(
docLangTag
)
;
for
(
const
menuitem
of
alwaysTranslateMenuItems
)
{
menuitem
.
setAttribute
(
"
checked
"
alwaysTranslateLanguage
?
"
true
"
:
"
false
"
)
;
menuitem
.
disabled
=
false
;
}
for
(
const
menuitem
of
neverTranslateMenuItems
)
{
menuitem
.
setAttribute
(
"
checked
"
neverTranslateLanguage
?
"
true
"
:
"
false
"
)
;
menuitem
.
disabled
=
false
;
}
}
async
#
updateSettingsMenuSiteCheckboxStates
(
)
{
const
{
panel
}
=
this
.
elements
;
const
neverTranslateSiteMenuItems
=
panel
.
querySelectorAll
(
"
.
never
-
translate
-
site
-
menuitem
"
)
;
const
neverTranslateSite
=
await
this
.
#
getTranslationsActor
(
)
.
shouldNeverTranslateSite
(
)
;
for
(
const
menuitem
of
neverTranslateSiteMenuItems
)
{
menuitem
.
setAttribute
(
"
checked
"
neverTranslateSite
?
"
true
"
:
"
false
"
)
;
}
}
async
#
populateSettingsMenuItems
(
)
{
const
{
docLangTag
}
=
await
this
.
#
getCachedDetectedLanguages
(
)
;
const
{
panel
}
=
this
.
elements
;
const
alwaysTranslateMenuItems
=
panel
.
querySelectorAll
(
"
.
always
-
translate
-
language
-
menuitem
"
)
;
const
neverTranslateMenuItems
=
panel
.
querySelectorAll
(
"
.
never
-
translate
-
language
-
menuitem
"
)
;
let
docLangDisplayName
;
if
(
docLangTag
)
{
const
displayNames
=
new
Services
.
intl
.
DisplayNames
(
undefined
{
type
:
"
language
"
fallback
:
"
none
"
}
)
;
docLangDisplayName
=
displayNames
.
of
(
docLangTag
)
;
}
for
(
const
menuitem
of
alwaysTranslateMenuItems
)
{
if
(
docLangDisplayName
)
{
document
.
l10n
.
setAttributes
(
menuitem
"
translations
-
panel
-
settings
-
always
-
translate
-
language
"
{
language
:
docLangDisplayName
}
)
;
}
else
{
document
.
l10n
.
setAttributes
(
menuitem
"
translations
-
panel
-
settings
-
always
-
translate
-
unknown
-
language
"
)
;
}
}
for
(
const
menuitem
of
neverTranslateMenuItems
)
{
if
(
docLangDisplayName
)
{
document
.
l10n
.
setAttributes
(
menuitem
"
translations
-
panel
-
settings
-
never
-
translate
-
language
"
{
language
:
docLangDisplayName
}
)
;
}
else
{
document
.
l10n
.
setAttributes
(
menuitem
"
translations
-
panel
-
settings
-
never
-
translate
-
unknown
-
language
"
)
;
}
}
await
Promise
.
all
(
[
this
.
#
updateSettingsMenuLanguageCheckboxStates
(
)
this
.
#
updateSettingsMenuSiteCheckboxStates
(
)
]
)
;
}
async
#
showRevisitView
(
{
fromLanguage
toLanguage
}
)
{
const
{
multiview
revisitHeader
revisitMenuList
revisitTranslate
}
=
this
.
elements
;
await
this
.
#
ensureLangListsBuilt
(
)
;
revisitMenuList
.
value
=
"
"
;
revisitTranslate
.
disabled
=
true
;
multiview
.
setAttribute
(
"
mainViewId
"
"
translations
-
panel
-
view
-
revisit
"
)
;
const
displayNames
=
new
Services
.
intl
.
DisplayNames
(
undefined
{
type
:
"
language
"
}
)
;
for
(
const
menuitem
of
revisitMenuList
.
querySelectorAll
(
"
menuitem
"
)
)
{
menuitem
.
disabled
=
menuitem
.
value
=
=
=
toLanguage
;
}
document
.
l10n
.
setAttributes
(
revisitHeader
"
translations
-
panel
-
revisit
-
header
"
{
fromLanguage
:
displayNames
.
of
(
fromLanguage
)
toLanguage
:
displayNames
.
of
(
toLanguage
)
}
)
;
}
onChangeRevisitTo
(
)
{
const
{
revisitTranslate
revisitMenuList
}
=
this
.
elements
;
revisitTranslate
.
disabled
=
!
revisitMenuList
.
value
;
}
onChangeDualLanguages
(
)
{
const
{
dualTranslate
dualToMenuList
dualFromMenuList
}
=
this
.
elements
;
dualTranslate
.
disabled
=
dualToMenuList
.
value
=
=
=
dualFromMenuList
.
value
|
|
!
dualFromMenuList
.
value
;
}
async
open
(
event
)
{
const
{
panel
button
}
=
this
.
elements
;
const
{
requestedTranslationPair
}
=
this
.
#
getTranslationsActor
(
)
.
languageState
;
if
(
requestedTranslationPair
)
{
await
this
.
#
showRevisitView
(
requestedTranslationPair
)
.
catch
(
error
=
>
{
this
.
console
.
error
(
error
)
;
}
)
;
}
else
{
await
this
.
#
showDefaultView
(
)
.
catch
(
error
=
>
{
this
.
console
.
error
(
error
)
;
}
)
;
}
this
.
#
populateSettingsMenuItems
(
)
;
PanelMultiView
.
openPopup
(
panel
button
{
position
:
"
bottomright
topright
"
triggerEvent
:
event
}
)
.
catch
(
error
=
>
this
.
console
.
error
(
error
)
)
;
}
#
hideTranslationsButton
(
)
{
const
{
button
buttonLocale
buttonCircleArrows
}
=
this
.
elements
;
button
.
hidden
=
true
;
buttonLocale
.
hidden
=
true
;
buttonCircleArrows
.
hidden
=
true
;
button
.
removeAttribute
(
"
translationsactive
"
)
;
}
#
isTranslationsActive
(
)
{
const
{
requestedTranslationPair
}
=
this
.
#
getTranslationsActor
(
)
.
languageState
;
return
requestedTranslationPair
!
=
=
null
;
}
async
onDefaultTranslate
(
)
{
PanelMultiView
.
hidePopup
(
this
.
elements
.
panel
)
;
const
actor
=
this
.
#
getTranslationsActor
(
)
;
const
docLangTag
=
await
this
.
#
getDocLangTag
(
)
;
actor
.
translate
(
docLangTag
this
.
elements
.
defaultToMenuList
.
value
)
;
}
async
onDualTranslate
(
)
{
PanelMultiView
.
hidePopup
(
this
.
elements
.
panel
)
;
const
actor
=
this
.
#
getTranslationsActor
(
)
;
actor
.
translate
(
this
.
elements
.
dualFromMenuList
.
value
this
.
elements
.
dualToMenuList
.
value
)
;
}
async
onRevisitTranslate
(
)
{
PanelMultiView
.
hidePopup
(
this
.
elements
.
panel
)
;
const
actor
=
this
.
#
getTranslationsActor
(
)
;
const
docLangTag
=
await
this
.
#
getDocLangTag
(
)
;
actor
.
translate
(
docLangTag
this
.
elements
.
revisitMenuList
.
value
)
;
}
onCancel
(
)
{
PanelMultiView
.
hidePopup
(
this
.
elements
.
panel
)
;
}
openSettingsPopup
(
button
)
{
this
.
#
updateSettingsMenuLanguageCheckboxStates
(
)
;
this
.
#
updateSettingsMenuSiteCheckboxStates
(
)
;
const
popup
=
button
.
querySelector
(
"
menupopup
"
)
;
popup
.
openPopup
(
button
)
;
}
openManageLanguages
(
)
{
const
window
=
gBrowser
.
selectedBrowser
.
browsingContext
.
top
.
embedderElement
.
ownerGlobal
;
window
.
openTrustedLinkIn
(
"
about
:
preferences
#
general
-
translations
"
"
tab
"
)
;
}
async
onAlwaysTranslateLanguage
(
)
{
const
{
docLangTag
}
=
await
this
.
#
getCachedDetectedLanguages
(
)
;
if
(
!
docLangTag
)
{
throw
new
Error
(
"
Expected
to
have
a
document
language
tag
.
"
)
;
}
const
toggledOn
=
TranslationsParent
.
toggleAlwaysTranslateLanguagePref
(
docLangTag
)
;
const
translationsActive
=
this
.
#
isTranslationsActive
(
)
;
this
.
#
updateSettingsMenuLanguageCheckboxStates
(
)
;
if
(
toggledOn
&
&
!
translationsActive
)
{
await
this
.
onDefaultTranslate
(
)
;
}
else
if
(
!
toggledOn
&
&
translationsActive
)
{
await
this
.
onRestore
(
)
;
}
}
async
onNeverTranslateLanguage
(
)
{
const
{
docLangTag
}
=
await
this
.
#
getCachedDetectedLanguages
(
)
;
if
(
!
docLangTag
)
{
throw
new
Error
(
"
Expected
to
have
a
document
language
tag
.
"
)
;
}
TranslationsParent
.
toggleNeverTranslateLanguagePref
(
docLangTag
)
;
this
.
#
updateSettingsMenuLanguageCheckboxStates
(
)
;
if
(
this
.
#
isTranslationsActive
(
)
)
{
await
this
.
onRestore
(
)
;
}
else
{
this
.
#
hideTranslationsButton
(
)
;
}
}
async
onNeverTranslateSite
(
)
{
await
this
.
#
getTranslationsActor
(
)
.
toggleNeverTranslateSitePermissions
(
)
;
this
.
#
updateSettingsMenuSiteCheckboxStates
(
)
;
if
(
this
.
#
isTranslationsActive
(
)
)
{
await
this
.
onRestore
(
)
;
}
else
{
this
.
#
hideTranslationsButton
(
)
;
}
}
async
onRestore
(
)
{
const
{
panel
}
=
this
.
elements
;
PanelMultiView
.
hidePopup
(
panel
)
;
const
{
docLangTag
}
=
await
this
.
#
getCachedDetectedLanguages
(
)
;
if
(
!
docLangTag
)
{
throw
new
Error
(
"
Expected
to
have
a
document
language
tag
.
"
)
;
}
this
.
#
getTranslationsActor
(
)
.
restorePage
(
docLangTag
)
;
}
handleEvent
=
async
event
=
>
{
switch
(
event
.
type
)
{
case
"
TranslationsParent
:
LanguageState
"
:
const
{
detectedLanguages
requestedTranslationPair
error
isEngineReady
}
=
event
.
detail
;
const
{
panel
button
buttonLocale
buttonCircleArrows
}
=
this
.
elements
;
const
hasSupportedLanguage
=
detectedLanguages
?
.
docLangTag
&
&
detectedLanguages
?
.
userLangTag
&
&
detectedLanguages
?
.
isDocLangTagSupported
;
if
(
detectedLanguages
)
{
TranslationsPanel
.
detectedLanguages
=
detectedLanguages
;
}
const
shouldNeverTranslate
=
async
(
)
=
>
{
return
Boolean
(
TranslationsParent
.
shouldNeverTranslateLanguage
(
detectedLanguages
?
.
docLangTag
)
|
|
(
await
this
.
#
getTranslationsActor
(
)
.
shouldNeverTranslateSite
(
)
)
)
;
}
;
if
(
requestedTranslationPair
|
|
error
|
|
(
hasSupportedLanguage
&
&
!
(
await
shouldNeverTranslate
(
)
)
)
)
{
button
.
hidden
=
false
;
if
(
requestedTranslationPair
)
{
button
.
setAttribute
(
"
translationsactive
"
true
)
;
if
(
isEngineReady
)
{
buttonLocale
.
hidden
=
false
;
buttonCircleArrows
.
hidden
=
true
;
buttonLocale
.
innerText
=
requestedTranslationPair
.
toLanguage
;
}
else
{
buttonCircleArrows
.
hidden
=
false
;
buttonLocale
.
hidden
=
true
;
}
}
else
{
button
.
removeAttribute
(
"
translationsactive
"
)
;
buttonLocale
.
hidden
=
true
;
buttonCircleArrows
.
hidden
=
true
;
}
}
else
{
this
.
#
hideTranslationsButton
(
)
;
}
switch
(
error
)
{
case
null
:
this
.
elements
.
error
.
hidden
=
true
;
this
.
elements
.
notNow
.
hidden
=
false
;
break
;
case
"
engine
-
load
-
failure
"
:
this
.
elements
.
error
.
hidden
=
false
;
this
.
elements
.
notNow
.
hidden
=
true
;
document
.
l10n
.
setAttributes
(
this
.
elements
.
errorMessage
"
translations
-
panel
-
error
-
translating
"
)
;
PanelMultiView
.
openPopup
(
panel
button
{
position
:
"
bottomright
topright
"
}
)
.
catch
(
panelError
=
>
this
.
console
.
error
(
panelError
)
)
;
break
;
default
:
console
.
error
(
"
Unknown
translation
error
"
error
)
;
}
break
;
}
}
;
}
)
(
)
;
