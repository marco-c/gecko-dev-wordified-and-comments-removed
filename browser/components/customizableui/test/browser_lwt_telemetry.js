"
use
strict
"
;
add_task
(
function
clearTelemetry
(
)
{
Services
.
telemetry
.
clearEvents
(
)
;
}
)
;
add_task
(
async
function
testCustomize
(
)
{
let
getMoreURL
=
"
about
:
blank
#
getMoreThemes
"
;
Services
.
prefs
.
clearUserPref
(
"
lightweightThemes
.
recommendedThemes
"
)
;
Services
.
prefs
.
clearUserPref
(
"
lightweightThemes
.
usedThemes
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
lightweightThemes
.
getMoreURL
"
getMoreURL
]
]
}
)
;
await
startCustomizing
(
)
;
let
themePanel
=
document
.
getElementById
(
"
customization
-
lwtheme
-
menu
"
)
;
themePanel
.
openPopup
(
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
themePanel
"
shown
"
)
;
let
recommendedLabel
=
document
.
getElementById
(
"
customization
-
lwtheme
-
menu
-
recommended
"
)
;
let
themeButton
=
recommendedLabel
.
nextElementSibling
;
let
themeId
=
{
themeButton
.
theme
.
id
}
personas
.
mozilla
.
org
;
let
themeChanged
=
TestUtils
.
topicObserved
(
"
lightweight
-
theme
-
changed
"
)
;
themeButton
.
click
(
)
;
await
themeChanged
;
await
BrowserTestUtils
.
waitForPopupEvent
(
themePanel
"
hidden
"
)
;
let
installedThemes
=
document
.
querySelectorAll
(
"
.
customization
-
lwtheme
-
menu
-
theme
"
)
;
let
defaultId
=
"
default
-
theme
mozilla
.
org
"
;
let
defaultThemeIndex
=
Array
.
from
(
installedThemes
)
.
findIndex
(
btn
=
>
btn
.
theme
.
id
=
=
defaultId
)
;
let
defaultThemeButton
=
installedThemes
[
defaultThemeIndex
]
;
themeChanged
=
TestUtils
.
topicObserved
(
"
lightweight
-
theme
-
changed
"
)
;
defaultThemeButton
.
click
(
)
;
await
themeChanged
;
let
footerRow
=
document
.
getElementById
(
"
customization
-
lwtheme
-
menu
-
footer
"
)
;
let
[
manageButton
getMoreButton
]
=
footerRow
.
childNodes
;
let
waitForNewTab
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
"
about
:
addons
"
)
;
manageButton
.
click
(
)
;
let
addonsTab
=
await
waitForNewTab
;
is
(
gBrowser
.
currentURI
.
spec
"
about
:
addons
"
"
Manage
opened
about
:
addons
"
)
;
BrowserTestUtils
.
removeTab
(
addonsTab
)
;
waitForNewTab
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
getMoreURL
)
;
getMoreButton
.
click
(
)
;
addonsTab
=
await
waitForNewTab
;
is
(
gBrowser
.
currentURI
.
spec
getMoreURL
"
Get
more
opened
AMO
"
)
;
BrowserTestUtils
.
removeTab
(
addonsTab
)
;
let
snapshot
=
Services
.
telemetry
.
snapshotEvents
(
Ci
.
nsITelemetry
.
DATASET_RELEASE_CHANNEL_OPTIN
true
)
;
ok
(
snapshot
.
parent
&
&
snapshot
.
parent
.
length
>
0
"
Got
parent
telemetry
events
in
the
snapshot
"
)
;
let
relatedEvents
=
snapshot
.
parent
.
filter
(
(
[
timestamp
category
method
object
]
)
=
>
category
=
=
"
addonsManager
"
&
&
object
=
=
"
customize
"
)
.
map
(
relatedEvent
=
>
relatedEvent
.
slice
(
2
6
)
)
;
Assert
.
deepEqual
(
relatedEvents
[
[
"
action
"
"
customize
"
"
recommended
"
{
action
:
"
enable
"
addonId
:
themeId
type
:
"
theme
"
}
]
[
"
action
"
"
customize
"
null
{
action
:
"
enable
"
addonId
:
defaultId
type
:
"
theme
"
}
]
[
"
link
"
"
customize
"
"
manageThemes
"
]
[
"
link
"
"
customize
"
"
getThemes
"
]
]
"
The
events
are
recorded
correctly
"
)
;
Services
.
prefs
.
clearUserPref
(
"
lightweightThemes
.
recommendedThemes
"
)
;
Services
.
prefs
.
clearUserPref
(
"
lightweightThemes
.
usedThemes
"
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
document
.
documentElement
.
getAttribute
(
"
customizing
"
)
=
=
"
true
"
)
;
await
endCustomizing
(
)
;
}
)
;
