"
use
strict
"
;
logActiveElement
(
)
;
async
function
waitForSearchBarFocus
(
)
{
let
searchbar
=
document
.
getElementById
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
search
.
widget
.
new
"
)
?
"
searchbar
-
new
"
:
"
searchbar
"
)
;
await
TestUtils
.
waitForCondition
(
function
(
)
{
logActiveElement
(
)
;
return
document
.
activeElement
=
=
=
searchbar
.
inputField
;
}
)
;
}
add_task
(
async
function
check_shortcut_when_in_closed_overflow_panel_closed
(
)
{
CustomizableUI
.
addWidgetToArea
(
"
search
-
container
"
CustomizableUI
.
AREA_FIXED_OVERFLOW_PANEL
)
;
let
shownPanelPromise
=
promiseOverflowShown
(
window
)
;
sendWebSearchKeyCommand
(
)
;
await
shownPanelPromise
;
await
waitForSearchBarFocus
(
)
;
let
hiddenPanelPromise
=
promiseOverflowHidden
(
window
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
hiddenPanelPromise
;
CustomizableUI
.
reset
(
)
;
}
)
;
add_task
(
async
function
check_shortcut_when_in_opened_overflow_panel
(
)
{
CustomizableUI
.
addWidgetToArea
(
"
search
-
container
"
CustomizableUI
.
AREA_FIXED_OVERFLOW_PANEL
)
;
await
document
.
getElementById
(
"
nav
-
bar
"
)
.
overflowable
.
show
(
)
;
sendWebSearchKeyCommand
(
)
;
await
waitForSearchBarFocus
(
)
;
let
hiddenPanelPromise
=
promiseOverflowHidden
(
window
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
hiddenPanelPromise
;
CustomizableUI
.
reset
(
)
;
}
)
;
add_task
(
async
function
check_shortcut_when_in_overflow
(
)
{
this
.
originalWindowWidth
=
window
.
outerWidth
;
let
navbar
=
document
.
getElementById
(
CustomizableUI
.
AREA_NAVBAR
)
;
ok
(
!
navbar
.
hasAttribute
(
"
overflowing
"
)
"
Should
start
with
a
non
-
overflowing
toolbar
.
"
)
;
ok
(
CustomizableUI
.
inDefaultState
"
Should
start
in
default
state
.
"
)
;
await
gCUITestUtils
.
addSearchBar
(
)
;
window
.
resizeTo
(
kForceOverflowWidthPx
window
.
outerHeight
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
return
(
navbar
.
getAttribute
(
"
overflowing
"
)
=
=
"
true
"
&
&
!
navbar
.
querySelector
(
"
#
search
-
container
"
)
)
;
}
)
;
ok
(
!
navbar
.
querySelector
(
"
#
search
-
container
"
)
"
Search
container
should
be
overflowing
"
)
;
let
shownPanelPromise
=
promiseOverflowShown
(
window
)
;
sendWebSearchKeyCommand
(
)
;
await
shownPanelPromise
;
let
chevron
=
document
.
getElementById
(
"
nav
-
bar
-
overflow
-
button
"
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
chevron
.
open
)
;
await
waitForSearchBarFocus
(
)
;
let
hiddenPanelPromise
=
promiseOverflowHidden
(
window
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
hiddenPanelPromise
;
gCUITestUtils
.
removeSearchBar
(
)
;
navbar
=
document
.
getElementById
(
CustomizableUI
.
AREA_NAVBAR
)
;
window
.
resizeTo
(
this
.
originalWindowWidth
window
.
outerHeight
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
!
navbar
.
hasAttribute
(
"
overflowing
"
)
)
;
ok
(
!
navbar
.
hasAttribute
(
"
overflowing
"
)
"
Should
not
have
an
overflowing
toolbar
.
"
)
;
}
)
;
add_task
(
async
function
check_shortcut_when_not_in_overflow
(
)
{
await
gCUITestUtils
.
addSearchBar
(
)
;
let
placement
=
CustomizableUI
.
getPlacementOfWidget
(
"
search
-
container
"
)
;
is
(
placement
.
area
CustomizableUI
.
AREA_NAVBAR
"
Should
be
in
nav
-
bar
"
)
;
sendWebSearchKeyCommand
(
)
;
await
waitForSearchBarFocus
(
)
;
gCUITestUtils
.
removeSearchBar
(
)
;
}
)
;
function
sendWebSearchKeyCommand
(
)
{
document
.
documentElement
.
focus
(
)
;
EventUtils
.
synthesizeKey
(
"
k
"
{
accelKey
:
true
}
)
;
}
function
logActiveElement
(
)
{
let
element
=
document
.
activeElement
;
let
str
=
"
"
;
while
(
element
&
&
element
.
parentNode
)
{
str
=
"
(
"
+
element
.
localName
+
"
#
"
+
element
.
id
+
"
.
"
+
[
.
.
.
element
.
classList
]
.
join
(
"
.
"
)
+
"
)
>
"
+
str
;
element
=
element
.
parentNode
;
}
info
(
"
Active
element
:
"
+
element
?
str
:
"
null
"
)
;
}
