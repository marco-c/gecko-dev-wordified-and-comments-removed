"
use
strict
"
;
let
CustomizableUIBSPass
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
CustomizableUI
.
jsm
"
null
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
HomePage
"
"
resource
:
/
/
/
modules
/
HomePage
.
jsm
"
)
;
const
kPrefProtonToolbarEnabled
=
"
browser
.
proton
.
toolbar
.
enabled
"
;
const
kPrefProtonToolbarVersion
=
"
browser
.
proton
.
toolbar
.
version
"
;
const
kPrefHomeButtonUsed
=
"
browser
.
engagement
.
home
-
button
.
has
-
used
"
;
const
kPrefLibraryButtonUsed
=
"
browser
.
engagement
.
library
-
button
.
has
-
used
"
;
async
function
testToolbarButtons
(
shouldRemoveHomeButton
shouldRemoveLibraryButton
shouldUpdateVersion
)
{
const
defaultPlacements
=
[
"
back
-
button
"
"
forward
-
button
"
"
stop
-
reload
-
button
"
"
home
-
button
"
"
customizableui
-
special
-
spring1
"
"
urlbar
-
container
"
"
customizableui
-
special
-
spring2
"
"
downloads
-
button
"
"
library
-
button
"
"
sidebar
-
button
"
"
fxa
-
toolbar
-
menu
-
button
"
]
;
let
oldState
=
CustomizableUIBSPass
.
gSavedState
;
Assert
.
equal
(
Services
.
prefs
.
getIntPref
(
kPrefProtonToolbarVersion
)
0
"
Toolbar
proton
version
is
0
"
)
;
let
{
CustomizableUIInternal
}
=
CustomizableUIBSPass
;
CustomizableUIBSPass
.
gSavedState
=
{
placements
:
{
"
nav
-
bar
"
:
defaultPlacements
}
}
;
CustomizableUIInternal
.
_updateForNewProtonVersion
(
)
;
let
navbarPlacements
=
CustomizableUIBSPass
.
gSavedState
.
placements
[
"
nav
-
bar
"
]
;
let
includesHomeButton
=
navbarPlacements
.
includes
(
"
home
-
button
"
)
;
let
includesLibraryButton
=
navbarPlacements
.
includes
(
"
library
-
button
"
)
;
Assert
.
equal
(
!
includesHomeButton
shouldRemoveHomeButton
"
Correctly
handles
home
button
"
)
;
Assert
.
equal
(
!
includesLibraryButton
shouldRemoveLibraryButton
"
Correctly
handles
library
button
"
)
;
let
toolbarVersion
=
Services
.
prefs
.
getIntPref
(
kPrefProtonToolbarVersion
)
;
if
(
shouldUpdateVersion
)
{
Assert
.
ok
(
toolbarVersion
>
=
1
"
Toolbar
proton
version
updated
"
)
;
}
else
{
Assert
.
ok
(
toolbarVersion
=
=
0
"
Toolbar
proton
version
not
updated
"
)
;
}
CustomizableUIBSPass
.
gSavedState
=
oldState
;
}
add_task
(
async
function
testButtonRemoval
(
)
{
let
tests
=
[
{
prefs
:
[
[
kPrefProtonToolbarEnabled
true
]
]
shouldRemoveHomeButton
:
true
shouldRemoveLibraryButton
:
true
shouldUpdateVersion
:
true
}
{
prefs
:
[
[
kPrefProtonToolbarEnabled
true
]
[
kPrefHomeButtonUsed
true
]
]
shouldRemoveHomeButton
:
false
shouldRemoveLibraryButton
:
true
shouldUpdateVersion
:
true
}
{
prefs
:
[
[
kPrefProtonToolbarEnabled
false
]
]
shouldRemoveHomeButton
:
false
shouldRemoveLibraryButton
:
false
shouldUpdateVersion
:
false
}
{
prefs
:
[
[
kPrefProtonToolbarEnabled
true
]
]
shouldRemoveHomeButton
:
false
shouldRemoveLibraryButton
:
true
shouldUpdateVersion
:
true
async
fn
(
)
{
HomePage
.
safeSet
(
"
https
:
/
/
example
.
com
"
)
;
}
}
{
prefs
:
[
[
kPrefProtonToolbarEnabled
true
]
[
kPrefLibraryButtonUsed
true
]
]
shouldRemoveHomeButton
:
true
shouldRemoveLibraryButton
:
false
shouldUpdateVersion
:
true
}
]
;
for
(
let
test
of
tests
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
kPrefProtonToolbarVersion
0
]
.
.
.
test
.
prefs
]
}
)
;
if
(
test
.
fn
)
{
await
test
.
fn
(
)
;
}
testToolbarButtons
(
test
.
shouldRemoveHomeButton
test
.
shouldRemoveLibraryButton
test
.
shouldUpdateVersion
)
;
HomePage
.
reset
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
}
)
;
add_task
(
async
function
testNullSavedState
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
kPrefProtonToolbarVersion
0
]
[
kPrefProtonToolbarEnabled
true
]
]
}
)
;
let
oldState
=
CustomizableUIBSPass
.
gSavedState
;
Assert
.
equal
(
Services
.
prefs
.
getIntPref
(
kPrefProtonToolbarVersion
)
0
"
Toolbar
proton
version
is
0
"
)
;
let
{
CustomizableUIInternal
}
=
CustomizableUIBSPass
;
CustomizableUIInternal
.
_updateForNewProtonVersion
(
)
;
Assert
.
ok
(
Services
.
prefs
.
getIntPref
(
kPrefProtonToolbarVersion
)
>
=
1
"
Toolbar
proton
version
updated
"
)
;
CustomizableUIBSPass
.
gSavedState
=
oldState
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
