const
TEST_FILE
=
fileURL
(
"
dummy_page
.
html
"
)
;
const
TEST_HTTP
=
httpURL
(
"
tab_that_closes
.
html
"
)
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
allow_scripts_to_close_windows
"
false
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_FILE
async
function
(
fileBrowser
)
{
info
(
"
Tab
ready
"
)
;
info
(
"
Creating
promise
"
)
;
var
newTabPromise
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
url
=
>
{
return
url
.
endsWith
(
"
tab_that_closes
.
html
"
)
;
}
true
false
)
;
info
(
"
Creating
and
clicking
link
"
)
;
await
SpecialPowers
.
spawn
(
fileBrowser
[
TEST_HTTP
]
target
=
>
{
content
.
open
(
target
)
;
}
)
;
info
(
"
Waiting
for
load
"
)
;
var
newTab
=
await
newTabPromise
;
ok
(
newTab
"
Tab
is
loaded
"
)
;
info
(
"
waiting
for
it
to
close
"
)
;
await
BrowserTestUtils
.
waitForTabClosing
(
newTab
)
;
ok
(
true
"
The
test
completes
without
a
timeout
"
)
;
}
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
