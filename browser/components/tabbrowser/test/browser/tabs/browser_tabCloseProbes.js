"
use
strict
"
;
var
gAnimHistogram
=
Services
.
telemetry
.
getHistogramById
(
"
FX_TAB_CLOSE_TIME_ANIM_MS
"
)
;
var
gNoAnimHistogram
=
Services
.
telemetry
.
getHistogramById
(
"
FX_TAB_CLOSE_TIME_NO_ANIM_MS
"
)
;
function
snapshotCount
(
snapshot
)
{
return
Object
.
values
(
snapshot
.
values
)
.
reduce
(
(
a
b
)
=
>
a
+
b
0
)
;
}
function
assertCount
(
snapshot
expectedCount
)
{
Assert
.
equal
(
snapshotCount
(
snapshot
)
expectedCount
Should
only
be
{
expectedCount
}
collected
value
.
)
;
}
function
waitForSnapshotCount
(
histogram
expectedCount
)
{
return
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
snapshotCount
(
histogram
.
snapshot
(
)
)
=
=
expectedCount
;
}
Collected
value
should
become
{
expectedCount
}
.
)
;
}
async
function
testCloseTimeProbe
(
animate
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
tab
.
_fullyOpen
)
;
gAnimHistogram
.
clear
(
)
;
gNoAnimHistogram
.
clear
(
)
;
BrowserTestUtils
.
removeTab
(
tab
{
animate
}
)
;
await
waitForSnapshotCount
(
gAnimHistogram
animate
?
1
:
0
)
;
assertCount
(
gNoAnimHistogram
.
snapshot
(
)
animate
?
0
:
1
)
;
gAnimHistogram
.
clear
(
)
;
gNoAnimHistogram
.
clear
(
)
;
}
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
test
.
wait300msAfterTabSwitch
"
true
]
]
}
)
;
gReduceMotionOverride
=
false
;
let
oldCanRecord
=
Services
.
telemetry
.
canRecordExtended
;
Services
.
telemetry
.
canRecordExtended
=
true
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
telemetry
.
canRecordExtended
=
oldCanRecord
;
}
)
;
}
)
;
add_task
(
async
function
test_close_time_anim_probe
(
)
{
await
testCloseTimeProbe
(
true
)
;
}
)
;
add_task
(
async
function
test_close_time_no_anim_probe
(
)
{
await
testCloseTimeProbe
(
false
)
;
}
)
;
