const
uuidGenerator
=
Services
.
uuid
;
const
DUMMY_FILE
=
"
dummy_page
.
html
"
;
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
test
.
wait300msAfterTabSwitch
"
true
]
]
}
)
;
}
)
;
add_task
(
async
function
(
)
{
let
dummyPage
=
getChromeDir
(
getResolvedURI
(
gTestPath
)
)
;
dummyPage
.
append
(
DUMMY_FILE
)
;
let
disappearingPage
=
Services
.
dirsvc
.
get
(
"
TmpD
"
Ci
.
nsIFile
)
;
let
uniqueName
=
uuidGenerator
.
generateUUID
(
)
.
toString
(
)
;
dummyPage
.
copyTo
(
disappearingPage
uniqueName
)
;
disappearingPage
.
append
(
uniqueName
)
;
const
uriString
=
Services
.
io
.
newFileURI
(
disappearingPage
)
.
spec
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
uriString
)
;
registerCleanupFunction
(
async
function
(
)
{
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
disappearingPage
.
remove
(
false
)
;
document
.
getElementById
(
"
reload
-
button
"
)
.
doCommand
(
)
;
await
BrowserTestUtils
.
waitForErrorPage
(
tab
.
linkedBrowser
)
;
await
SpecialPowers
.
spawn
(
tab
.
linkedBrowser
[
]
function
(
)
{
ok
(
content
.
document
.
documentURI
.
startsWith
(
"
about
:
neterror
"
)
"
Check
that
a
neterror
page
was
loaded
.
"
)
;
}
)
;
}
)
;
