"
use
strict
"
;
async
function
openCreatePanel
(
tabgroupPanel
tab
)
{
let
panelShown
=
BrowserTestUtils
.
waitForPopupEvent
(
tabgroupPanel
"
shown
"
)
;
gBrowser
.
addTabGroup
(
[
tab
]
{
isUserTriggered
:
true
}
)
;
await
panelShown
;
}
add_task
(
async
function
test_smart_tab_group_suggestions_checkbox_selection
(
)
{
Services
.
fog
.
testResetFOG
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
tabs
.
groups
.
enabled
"
true
]
[
"
browser
.
tabs
.
groups
.
smart
.
enabled
"
true
]
[
"
browser
.
tabs
.
groups
.
smart
.
userEnabled
"
true
]
[
"
browser
.
tabs
.
groups
.
smart
.
optin
"
true
]
[
"
browser
.
ml
.
enable
"
true
]
]
}
)
;
const
origSmartTabGroupingForGroup
=
SmartTabGroupingManager
.
prototype
.
smartTabGroupingForGroup
;
const
origHandleSuggestTelemetry
=
SmartTabGroupingManager
.
prototype
.
handleSuggestTelemetry
;
const
origHandleLabelTelemetry
=
SmartTabGroupingManager
.
prototype
.
handleLabelTelemetry
;
let
suggestedTabs
;
SmartTabGroupingManager
.
prototype
.
smartTabGroupingForGroup
=
async
function
(
_group
_tabs
)
{
return
suggestedTabs
;
}
;
SmartTabGroupingManager
.
prototype
.
handleSuggestTelemetry
=
function
(
)
{
}
;
SmartTabGroupingManager
.
prototype
.
handleLabelTelemetry
=
function
(
)
{
}
;
registerCleanupFunction
(
(
)
=
>
{
SmartTabGroupingManager
.
prototype
.
smartTabGroupingForGroup
=
origSmartTabGroupingForGroup
;
SmartTabGroupingManager
.
prototype
.
handleSuggestTelemetry
=
origHandleSuggestTelemetry
;
SmartTabGroupingManager
.
prototype
.
handleLabelTelemetry
=
origHandleLabelTelemetry
;
Services
.
fog
.
testResetFOG
(
)
;
}
)
;
let
baseTab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
about
:
blank
"
)
;
let
tab1
=
BrowserTestUtils
.
addTab
(
gBrowser
"
https
:
/
/
example
.
com
/
1
"
)
;
let
tab2
=
BrowserTestUtils
.
addTab
(
gBrowser
"
https
:
/
/
example
.
com
/
2
"
)
;
let
tab3
=
BrowserTestUtils
.
addTab
(
gBrowser
"
https
:
/
/
example
.
com
/
3
"
)
;
suggestedTabs
=
[
tab1
tab2
tab3
]
;
registerCleanupFunction
(
(
)
=
>
{
for
(
let
t
of
[
baseTab
tab1
tab2
tab3
]
)
{
if
(
t
&
&
!
t
.
closing
&
&
gBrowser
.
tabs
.
includes
(
t
)
)
{
BrowserTestUtils
.
removeTab
(
t
)
;
}
}
}
)
;
let
tabgroupEditor
=
document
.
getElementById
(
"
tab
-
group
-
editor
"
)
;
Assert
.
ok
(
tabgroupEditor
"
We
should
have
the
built
-
in
<
tabgroup
-
menu
id
=
'
tab
-
group
-
editor
'
>
element
"
)
;
let
tabgroupPanel
=
tabgroupEditor
.
panel
;
Assert
.
ok
(
tabgroupPanel
"
tab
-
group
-
editor
should
expose
a
panel
property
"
)
;
await
openCreatePanel
(
tabgroupPanel
baseTab
)
;
let
group
=
tabgroupEditor
.
activeGroup
;
Assert
.
ok
(
group
"
tabgroup
-
editor
should
have
an
activeGroup
after
open
"
)
;
let
suggestButton
=
tabgroupPanel
.
querySelector
(
"
#
tab
-
group
-
suggestion
-
button
"
)
;
Assert
.
ok
(
suggestButton
"
Suggestion
button
should
exist
in
the
tab
group
panel
"
)
;
Assert
.
ok
(
!
suggestButton
.
hidden
"
Suggestion
button
should
be
visible
when
smart
tab
groups
is
enabled
"
)
;
suggestButton
.
click
(
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
tabgroupPanel
.
querySelectorAll
(
"
.
tab
-
group
-
suggestion
-
checkbox
"
)
.
length
=
=
=
suggestedTabs
.
length
"
Waiting
for
suggestion
checkboxes
to
be
created
"
)
;
let
checkboxes
=
tabgroupPanel
.
querySelectorAll
(
"
.
tab
-
group
-
suggestion
-
checkbox
"
)
;
Assert
.
equal
(
checkboxes
.
length
suggestedTabs
.
length
"
We
should
have
one
checkbox
per
suggested
tab
"
)
;
for
(
let
checkbox
of
checkboxes
)
{
Assert
.
ok
(
checkbox
.
checked
"
Each
suggestion
checkbox
starts
checked
"
)
;
}
checkboxes
[
1
]
.
click
(
)
;
Assert
.
ok
(
!
checkboxes
[
1
]
.
checked
"
Second
suggestion
checkbox
should
now
be
unchecked
"
)
;
let
doneButton
=
tabgroupPanel
.
querySelector
(
"
#
tab
-
group
-
create
-
suggestions
-
button
"
)
;
Assert
.
ok
(
doneButton
"
Should
find
the
'
Done
'
suggestions
button
"
)
;
let
tab1Grouped
=
BrowserTestUtils
.
waitForEvent
(
group
"
TabGrouped
"
false
e
=
>
e
.
detail
=
=
tab1
)
;
let
tab3Grouped
=
BrowserTestUtils
.
waitForEvent
(
group
"
TabGrouped
"
false
e
=
>
e
.
detail
=
=
tab3
)
;
let
panelHidden
=
BrowserTestUtils
.
waitForPopupEvent
(
tabgroupPanel
"
hidden
"
)
;
doneButton
.
click
(
)
;
await
Promise
.
all
(
[
panelHidden
tab1Grouped
tab3Grouped
]
)
;
Assert
.
ok
(
!
tab2
.
group
"
tab
2
should
not
have
been
grouped
because
it
was
deselected
"
)
;
}
)
;
