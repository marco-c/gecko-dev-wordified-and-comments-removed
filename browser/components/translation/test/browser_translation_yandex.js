"
use
strict
"
;
const
{
PromiseTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
PromiseTestUtils
.
jsm
"
)
;
PromiseTestUtils
.
allowMatchingRejectionsGlobally
(
/
NS_ERROR_ILLEGAL_VALUE
/
)
;
const
kEnginePref
=
"
browser
.
translation
.
engine
"
;
const
kApiKeyPref
=
"
browser
.
translation
.
yandex
.
apiKeyOverride
"
;
const
kDetectLanguagePref
=
"
browser
.
translation
.
detectLanguage
"
;
const
kShowUIPref
=
"
browser
.
translation
.
ui
.
show
"
;
const
{
Translation
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
translation
/
TranslationParent
.
jsm
"
)
;
add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
kEnginePref
"
Yandex
"
]
[
kApiKeyPref
"
yandexValidKey
"
]
[
kDetectLanguagePref
true
]
[
kShowUIPref
true
]
]
}
)
;
}
)
;
add_task
(
async
function
test_yandex_translation
(
)
{
let
url
=
constructFixtureURL
(
"
bug1022725
-
fr
.
html
"
)
;
let
tab
=
await
promiseTestPageLoad
(
url
)
;
gBrowser
.
selectedTab
=
tab
;
let
browser
=
tab
.
linkedBrowser
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
function
(
)
{
const
{
TranslationDocument
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
translation
/
TranslationDocument
.
jsm
"
)
;
const
{
YandexTranslator
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
translation
/
YandexTranslator
.
jsm
"
)
;
let
client
=
new
YandexTranslator
(
new
TranslationDocument
(
content
.
document
)
"
fr
"
"
en
"
)
;
let
result
=
await
client
.
translate
(
)
;
Assert
.
ok
(
result
"
There
should
be
a
result
.
"
)
;
}
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_yandex_attribution
(
)
{
let
url
=
constructFixtureURL
(
"
bug1022725
-
fr
.
html
"
)
;
let
tab
=
await
promiseTestPageLoad
(
url
)
;
info
(
"
Show
an
info
bar
saying
the
current
page
is
in
French
"
)
;
let
notif
=
showTranslationUI
(
tab
"
fr
"
)
;
let
attribution
=
notif
.
_getAnonElt
(
"
translationEngine
"
)
.
selectedIndex
;
Assert
.
equal
(
attribution
1
"
Yandex
attribution
should
be
shown
.
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_preference_attribution
(
)
{
let
prefUrl
=
"
about
:
preferences
#
general
"
;
let
waitPrefLoaded
=
TestUtils
.
topicObserved
(
"
sync
-
pane
-
loaded
"
(
)
=
>
true
)
;
let
tab
=
await
promiseTestPageLoad
(
prefUrl
)
;
await
waitPrefLoaded
;
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
let
win
=
browser
.
contentWindow
;
let
bingAttribution
=
win
.
document
.
getElementById
(
"
bingAttribution
"
)
;
ok
(
bingAttribution
"
Bing
attribution
should
exist
.
"
)
;
ok
(
bingAttribution
.
hidden
"
Bing
attribution
should
be
hidden
.
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
function
constructFixtureURL
(
filename
)
{
let
server
=
Services
.
prefs
.
getCharPref
(
"
browser
.
translation
.
yandex
.
translateURLOverride
"
)
.
replace
(
"
http
:
/
/
"
"
"
)
;
server
=
server
.
substr
(
0
server
.
indexOf
(
"
/
"
)
)
;
let
url
=
"
http
:
/
/
"
+
server
+
"
/
browser
/
browser
/
components
/
translation
/
test
/
fixtures
/
"
+
filename
;
return
url
;
}
function
promiseTestPageLoad
(
url
)
{
return
new
Promise
(
resolve
=
>
{
let
tab
=
(
gBrowser
.
selectedTab
=
BrowserTestUtils
.
addTab
(
gBrowser
url
)
)
;
let
browser
=
gBrowser
.
selectedBrowser
;
BrowserTestUtils
.
browserLoaded
(
browser
false
loadurl
=
>
loadurl
!
=
"
about
:
blank
"
)
.
then
(
(
)
=
>
{
info
(
"
Page
loaded
:
"
+
browser
.
currentURI
.
spec
)
;
resolve
(
tab
)
;
}
)
;
}
)
;
}
function
showTranslationUI
(
tab
aDetectedLanguage
)
{
let
browser
=
gBrowser
.
selectedBrowser
;
let
actor
=
browser
.
browsingContext
.
currentWindowGlobal
.
getActor
(
"
Translation
"
)
;
actor
.
documentStateReceived
(
{
state
:
Translation
.
STATE_OFFER
originalShown
:
true
detectedLanguage
:
aDetectedLanguage
}
)
;
return
actor
.
notificationBox
.
getNotificationWithValue
(
"
translation
"
)
;
}
