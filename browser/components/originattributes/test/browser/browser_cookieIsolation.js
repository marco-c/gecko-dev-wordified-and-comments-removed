const
TEST_PAGE
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
browser
/
components
/
"
+
"
originattributes
/
test
/
browser
/
file_firstPartyBasic
.
html
"
;
const
key
=
"
key
"
+
Math
.
random
(
)
.
toString
(
)
;
const
re
=
new
RegExp
(
key
+
"
=
(
[
0
-
9
.
]
+
)
"
)
;
async
function
setupPrefs
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
security
.
https_first
"
false
]
[
"
network
.
cookie
.
sameSite
.
laxByDefault
"
false
]
]
}
)
;
}
function
doTest
(
aBrowser
)
{
return
SpecialPowers
.
spawn
(
aBrowser
[
key
re
]
function
(
contentKey
contentRe
)
{
let
result
=
contentRe
.
exec
(
content
.
document
.
cookie
)
;
if
(
result
)
{
return
result
[
1
]
;
}
let
value
=
Math
.
random
(
)
.
toString
(
)
;
content
.
document
.
cookie
=
contentKey
+
"
=
"
+
value
;
return
value
;
}
)
;
}
registerCleanupFunction
(
(
)
=
>
{
Services
.
cookies
.
removeAll
(
)
;
}
)
;
IsolationTestTools
.
runTests
(
TEST_PAGE
doTest
null
setupPrefs
)
;
