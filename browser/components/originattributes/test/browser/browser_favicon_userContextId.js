if
(
SpecialPowers
.
useRemoteSubframes
)
{
requestLongerTimeout
(
2
)
;
}
ChromeUtils
.
defineESModuleGetters
(
this
{
PlacesTestUtils
:
"
resource
:
/
/
testing
-
common
/
PlacesTestUtils
.
sys
.
mjs
"
}
)
;
const
TEST_SITE
=
"
https
:
/
/
example
.
org
"
;
const
TEST_THIRD_PARTY_SITE
=
"
https
:
/
/
example
.
net
"
;
const
TEST_PAGE
=
TEST_SITE
+
"
/
browser
/
browser
/
components
/
originattributes
/
"
+
"
test
/
browser
/
file_favicon
.
html
"
;
const
FAVICON_URI
=
TEST_SITE
+
"
/
browser
/
browser
/
components
/
originattributes
/
"
+
"
test
/
browser
/
file_favicon
.
png
"
;
const
TEST_THIRD_PARTY_PAGE
=
TEST_THIRD_PARTY_SITE
+
"
/
browser
/
browser
/
components
/
originattributes
/
"
+
"
test
/
browser
/
file_favicon_thirdParty
.
html
"
;
const
THIRD_PARTY_FAVICON_URI
=
TEST_THIRD_PARTY_SITE
+
"
/
browser
/
browser
/
components
/
"
+
"
originattributes
/
test
/
browser
/
file_favicon
.
png
"
;
const
USER_CONTEXT_ID_PERSONAL
=
1
;
const
USER_CONTEXT_ID_WORK
=
2
;
let
systemPrincipal
=
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
;
function
clearAllImageCaches
(
)
{
var
tools
=
SpecialPowers
.
Cc
[
"
mozilla
.
org
/
image
/
tools
;
1
"
]
.
getService
(
SpecialPowers
.
Ci
.
imgITools
)
;
var
imageCache
=
tools
.
getImgCacheForDocument
(
window
.
document
)
;
imageCache
.
clearCache
(
true
)
;
imageCache
.
clearCache
(
false
)
;
}
function
clearAllPlacesFavicons
(
)
{
let
faviconService
=
Cc
[
"
mozilla
.
org
/
browser
/
favicon
-
service
;
1
"
]
.
getService
(
Ci
.
nsIFaviconService
)
;
return
new
Promise
(
resolve
=
>
{
let
observer
=
{
observe
(
aSubject
aTopic
)
{
if
(
aTopic
=
=
=
"
places
-
favicons
-
expired
"
)
{
resolve
(
)
;
Services
.
obs
.
removeObserver
(
observer
"
places
-
favicons
-
expired
"
)
;
}
}
}
;
Services
.
obs
.
addObserver
(
observer
"
places
-
favicons
-
expired
"
)
;
faviconService
.
expireAllFavicons
(
)
;
}
)
;
}
function
FaviconObserver
(
aUserContextId
aExpectedCookie
aPageURI
aFaviconURL
)
{
this
.
reset
(
aUserContextId
aExpectedCookie
aPageURI
aFaviconURL
)
;
}
FaviconObserver
.
prototype
=
{
observe
(
aSubject
aTopic
)
{
if
(
aTopic
=
=
=
"
http
-
on
-
modify
-
request
"
)
{
let
httpChannel
=
aSubject
.
QueryInterface
(
Ci
.
nsIHttpChannel
)
;
let
reqLoadInfo
=
httpChannel
.
loadInfo
;
let
loadingPrincipal
triggeringPrincipal
;
if
(
httpChannel
.
URI
.
spec
!
=
=
this
.
_faviconURL
)
{
return
;
}
if
(
reqLoadInfo
)
{
loadingPrincipal
=
reqLoadInfo
.
loadingPrincipal
;
triggeringPrincipal
=
reqLoadInfo
.
triggeringPrincipal
;
}
is
(
reqLoadInfo
.
originAttributes
.
userContextId
this
.
_curUserContextId
"
The
loadInfo
has
correct
userContextId
"
)
;
ok
(
loadingPrincipal
.
equals
(
this
.
_expectedPrincipal
)
"
The
loadingPrincipal
of
favicon
loading
from
content
should
be
the
content
prinicpal
"
)
;
ok
(
triggeringPrincipal
.
equals
(
this
.
_expectedPrincipal
)
"
The
triggeringPrincipal
of
favicon
loading
from
content
should
be
the
content
prinicpal
"
)
;
let
faviconCookie
=
httpChannel
.
getRequestHeader
(
"
cookie
"
)
;
is
(
faviconCookie
this
.
_expectedCookie
"
The
cookie
of
the
favicon
loading
is
correct
.
"
)
;
}
else
{
ok
(
false
"
Received
unexpected
topic
:
"
aTopic
)
;
}
this
.
_faviconLoaded
.
resolve
(
)
;
}
reset
(
aUserContextId
aExpectedCookie
aPageURI
aFaviconURL
)
{
this
.
_curUserContextId
=
aUserContextId
;
this
.
_expectedCookie
=
aExpectedCookie
;
this
.
_expectedPrincipal
=
Services
.
scriptSecurityManager
.
createContentPrincipal
(
aPageURI
{
userContextId
:
aUserContextId
}
)
;
this
.
_faviconURL
=
aFaviconURL
;
this
.
_faviconLoaded
=
Promise
.
withResolvers
(
)
;
}
get
promise
(
)
{
return
this
.
_faviconLoaded
.
promise
;
}
}
;
function
waitOnFaviconLoaded
(
aFaviconURL
)
{
return
PlacesTestUtils
.
waitForNotification
(
"
favicon
-
changed
"
events
=
>
events
.
some
(
e
=
>
e
.
faviconUrl
=
=
aFaviconURL
)
)
;
}
async
function
generateCookies
(
aHost
)
{
let
cookies
=
[
]
;
cookies
.
push
(
Math
.
random
(
)
.
toString
(
)
)
;
cookies
.
push
(
Math
.
random
(
)
.
toString
(
)
)
;
let
tabInfoA
=
await
openTabInUserContext
(
aHost
USER_CONTEXT_ID_PERSONAL
)
;
let
tabInfoB
=
await
openTabInUserContext
(
aHost
USER_CONTEXT_ID_WORK
)
;
await
SpecialPowers
.
spawn
(
tabInfoA
.
browser
[
cookies
[
0
]
]
async
function
(
value
)
{
content
.
document
.
cookie
=
value
;
}
)
;
await
SpecialPowers
.
spawn
(
tabInfoB
.
browser
[
cookies
[
1
]
]
async
function
(
value
)
{
content
.
document
.
cookie
=
value
;
}
)
;
BrowserTestUtils
.
removeTab
(
tabInfoA
.
tab
)
;
BrowserTestUtils
.
removeTab
(
tabInfoB
.
tab
)
;
return
cookies
;
}
async
function
doTest
(
aTestPage
aFaviconHost
aFaviconURL
)
{
let
cookies
=
await
generateCookies
(
aFaviconHost
)
;
let
pageURI
=
makeURI
(
aTestPage
)
;
let
observer
=
new
FaviconObserver
(
USER_CONTEXT_ID_PERSONAL
cookies
[
0
]
pageURI
aFaviconURL
)
;
let
promiseWaitOnFaviconLoaded
=
waitOnFaviconLoaded
(
aFaviconURL
)
;
Services
.
obs
.
addObserver
(
observer
"
http
-
on
-
modify
-
request
"
)
;
let
tabInfo
=
await
openTabInUserContext
(
aTestPage
USER_CONTEXT_ID_PERSONAL
)
;
await
observer
.
promise
;
await
promiseWaitOnFaviconLoaded
;
BrowserTestUtils
.
removeTab
(
tabInfo
.
tab
)
;
await
new
Promise
(
executeSoon
)
;
observer
.
reset
(
USER_CONTEXT_ID_WORK
cookies
[
1
]
pageURI
aFaviconURL
)
;
tabInfo
=
await
openTabInUserContext
(
aTestPage
USER_CONTEXT_ID_WORK
)
;
await
observer
.
promise
;
Services
.
obs
.
removeObserver
(
observer
"
http
-
on
-
modify
-
request
"
)
;
BrowserTestUtils
.
removeTab
(
tabInfo
.
tab
)
;
}
function
assertIconIsData
(
item
)
{
is
(
item
.
getAttribute
(
"
image
"
)
.
substring
(
0
5
)
"
data
:
"
"
Expected
the
image
element
to
be
a
data
URI
"
)
;
}
async
function
doTestForAllTabsFavicon
(
aTestPage
aFaviconHost
aFaviconURL
)
{
await
generateCookies
(
aFaviconHost
)
;
let
tabBrowser
=
document
.
getElementById
(
"
tabbrowser
-
tabs
"
)
;
tabBrowser
.
setAttribute
(
"
overflow
"
true
)
;
let
promiseWaitOnFaviconLoaded
=
waitOnFaviconLoaded
(
aFaviconURL
)
;
let
tabInfo
=
await
openTabInUserContext
(
aTestPage
USER_CONTEXT_ID_PERSONAL
)
;
await
promiseWaitOnFaviconLoaded
;
clearAllImageCaches
(
)
;
gTabsPanel
.
init
(
)
;
let
allTabsView
=
document
.
getElementById
(
"
allTabsMenu
-
allTabsView
"
)
;
let
allTabsPopupShownPromise
=
BrowserTestUtils
.
waitForEvent
(
allTabsView
"
ViewShown
"
)
;
gTabsPanel
.
showAllTabsPanel
(
)
;
await
allTabsPopupShownPromise
;
assertIconIsData
(
gTabsPanel
.
allTabsViewTabs
.
lastElementChild
.
firstElementChild
)
;
let
allTabsPopupHiddenPromise
=
BrowserTestUtils
.
waitForEvent
(
allTabsView
.
panelMultiView
"
PanelMultiViewHidden
"
)
;
gTabsPanel
.
hideAllTabsPanel
(
)
;
await
allTabsPopupHiddenPromise
;
BrowserTestUtils
.
removeTab
(
tabInfo
.
tab
)
;
await
new
Promise
(
executeSoon
)
;
promiseWaitOnFaviconLoaded
=
waitOnFaviconLoaded
(
aFaviconURL
)
;
tabInfo
=
await
openTabInUserContext
(
aTestPage
USER_CONTEXT_ID_WORK
)
;
await
promiseWaitOnFaviconLoaded
;
clearAllImageCaches
(
)
;
allTabsPopupShownPromise
=
BrowserTestUtils
.
waitForEvent
(
allTabsView
"
ViewShown
"
)
;
gTabsPanel
.
showAllTabsPanel
(
)
;
await
allTabsPopupShownPromise
;
assertIconIsData
(
gTabsPanel
.
allTabsViewTabs
.
lastElementChild
.
firstElementChild
)
;
allTabsPopupHiddenPromise
=
BrowserTestUtils
.
waitForEvent
(
allTabsView
.
panelMultiView
"
PanelMultiViewHidden
"
)
;
gTabsPanel
.
hideAllTabsPanel
(
)
;
await
allTabsPopupHiddenPromise
;
BrowserTestUtils
.
removeTab
(
tabInfo
.
tab
)
;
tabBrowser
.
removeAttribute
(
"
overflow
"
)
;
}
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
privacy
.
userContext
.
enabled
"
true
]
]
}
)
;
}
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
cookies
.
removeAll
(
)
;
clearAllImageCaches
(
)
;
Services
.
cache2
.
clear
(
)
;
clearAllPlacesFavicons
(
)
;
}
)
;
add_task
(
async
function
test_favicon_userContextId
(
)
{
clearAllImageCaches
(
)
;
Services
.
cache2
.
clear
(
)
;
await
clearAllPlacesFavicons
(
)
;
await
doTest
(
TEST_PAGE
TEST_SITE
FAVICON_URI
)
;
}
)
;
add_task
(
async
function
test_thirdPartyFavicon_userContextId
(
)
{
clearAllImageCaches
(
)
;
Services
.
cache2
.
clear
(
)
;
await
clearAllPlacesFavicons
(
)
;
await
doTest
(
TEST_THIRD_PARTY_PAGE
TEST_THIRD_PARTY_SITE
THIRD_PARTY_FAVICON_URI
)
;
}
)
;
add_task
(
async
function
test_allTabs_favicon_userContextId
(
)
{
clearAllImageCaches
(
)
;
Services
.
cache2
.
clear
(
)
;
await
clearAllPlacesFavicons
(
)
;
await
doTestForAllTabsFavicon
(
TEST_PAGE
TEST_SITE
FAVICON_URI
)
;
}
)
;
add_task
(
async
function
test_allTabs_thirdPartyFavicon_userContextId
(
)
{
clearAllImageCaches
(
)
;
Services
.
cache2
.
clear
(
)
;
await
clearAllPlacesFavicons
(
)
;
await
doTestForAllTabsFavicon
(
TEST_THIRD_PARTY_PAGE
TEST_THIRD_PARTY_SITE
THIRD_PARTY_FAVICON_URI
)
;
}
)
;
