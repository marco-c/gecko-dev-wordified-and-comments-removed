const
{
classes
:
Cc
Constructor
:
CC
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
const
FIRST_PARTY_OPENER
=
"
example
.
com
"
;
const
FIRST_PARTY_TARGET
=
"
example
.
org
"
;
const
OPENER_PAGE
=
"
http
:
/
/
"
+
FIRST_PARTY_OPENER
+
"
/
browser
/
browser
/
components
/
"
+
"
originattributes
/
test
/
browser
/
file_windowOpenerRestriction
.
html
"
;
const
TARGET_PAGE
=
"
http
:
/
/
"
+
FIRST_PARTY_TARGET
+
"
/
browser
/
browser
/
components
/
"
+
"
originattributes
/
test
/
browser
/
file_windowOpenerRestrictionTarget
.
html
"
;
function
*
testPref
(
aIsPrefEnabled
)
{
let
cookieStr
=
"
key
"
+
Math
.
random
(
)
.
toString
(
)
+
"
=
"
+
Math
.
random
(
)
.
toString
(
)
;
let
tab
=
gBrowser
.
addTab
(
OPENER_PAGE
)
;
gBrowser
.
selectedTab
=
tab
;
tab
.
ownerGlobal
.
focus
(
)
;
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
yield
BrowserTestUtils
.
browserLoaded
(
browser
)
;
yield
ContentTask
.
spawn
(
browser
{
cookieStr
page
:
TARGET_PAGE
isPrefEnabled
:
aIsPrefEnabled
}
function
*
(
obj
)
{
let
childFrame
=
content
.
document
.
getElementById
(
"
child
"
)
;
childFrame
.
contentDocument
.
cookie
=
obj
.
cookieStr
;
let
openedPath
=
obj
.
page
;
if
(
!
obj
.
isPrefEnabled
)
{
openedPath
+
=
"
?
"
+
obj
.
cookieStr
;
}
this
.
openedWindow
=
content
.
open
(
openedPath
)
;
this
.
openedWindow
.
focus
(
)
;
}
)
;
let
targetBrowser
=
gBrowser
.
getBrowserForTab
(
gBrowser
.
selectedTab
)
;
yield
BrowserTestUtils
.
browserLoaded
(
targetBrowser
)
;
is
(
targetBrowser
.
contentTitle
"
pass
"
"
The
behavior
of
window
.
opener
is
correct
.
"
)
;
yield
ContentTask
.
spawn
(
browser
null
function
*
(
)
{
this
.
openedWindow
.
close
(
)
;
}
)
;
yield
BrowserTestUtils
.
removeTab
(
tab
)
;
Services
.
cookies
.
removeAll
(
)
;
}
add_task
(
function
*
runTests
(
)
{
let
tests
=
[
true
false
]
;
yield
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
privacy
.
firstparty
.
isolate
"
true
]
]
}
)
;
for
(
let
enabled
of
tests
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
privacy
.
firstparty
.
isolate
.
restrict_opener_access
"
enabled
]
]
}
)
;
yield
testPref
(
enabled
)
;
}
yield
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
privacy
.
firstparty
.
isolate
"
false
]
]
}
)
;
for
(
let
enabled
of
tests
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
privacy
.
firstparty
.
isolate
.
restrict_opener_access
"
enabled
]
]
}
)
;
yield
testPref
(
false
)
;
}
}
)
;
