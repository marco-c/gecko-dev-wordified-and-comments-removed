const
PREF_MODIFY_BOOLEAN
=
"
test
.
aboutconfig
.
modify
.
boolean
"
;
const
PREF_MODIFY_NUMBER
=
"
test
.
aboutconfig
.
modify
.
number
"
;
const
PREF_MODIFY_STRING
=
"
test
.
aboutconfig
.
modify
.
string
"
;
add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
PREF_MODIFY_BOOLEAN
true
]
[
PREF_MODIFY_NUMBER
1337
]
[
PREF_MODIFY_STRING
"
the
answer
to
the
life
the
universe
and
everything
"
]
]
}
)
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
PREF_BOOLEAN_DEFAULT_TRUE
)
;
Services
.
prefs
.
clearUserPref
(
PREF_NUMBER_DEFAULT_ZERO
)
;
Services
.
prefs
.
clearUserPref
(
PREF_STRING_DEFAULT_EMPTY
)
;
}
)
;
}
)
;
add_task
(
async
function
test_add_user_pref
(
)
{
Assert
.
equal
(
Services
.
prefs
.
getPrefType
(
PREF_NEW
)
Ci
.
nsIPrefBranch
.
PREF_INVALID
)
;
await
AboutConfigTest
.
withNewTab
(
async
function
(
)
{
Assert
.
ok
(
!
this
.
getRow
(
PREF_NEW
)
)
;
this
.
search
(
PREF_NEW
)
;
let
row
=
this
.
getRow
(
PREF_NEW
)
;
Assert
.
ok
(
row
.
hasClass
(
"
deleted
"
)
)
;
for
(
let
[
radioIndex
expectedValue
expectedEditingMode
]
of
[
[
0
true
false
]
[
1
0
true
]
[
2
"
"
true
]
]
)
{
row
.
element
.
querySelectorAll
(
"
input
"
)
[
radioIndex
]
.
click
(
)
;
row
.
editColumnButton
.
click
(
)
;
Assert
.
ok
(
!
row
.
hasClass
(
"
deleted
"
)
)
;
Assert
.
ok
(
Preferences
.
get
(
PREF_NEW
)
=
=
=
expectedValue
)
;
Assert
.
equal
(
!
!
row
.
valueInput
expectedEditingMode
)
;
this
.
search
(
PREF_NEW
)
;
row
=
this
.
getRow
(
PREF_NEW
)
;
Assert
.
ok
(
!
row
.
hasClass
(
"
deleted
"
)
)
;
Assert
.
ok
(
!
row
.
valueInput
)
;
row
.
resetColumnButton
.
click
(
)
;
Assert
.
equal
(
Services
.
prefs
.
getPrefType
(
PREF_NEW
)
Ci
.
nsIPrefBranch
.
PREF_INVALID
)
;
}
}
)
;
}
)
;
add_task
(
async
function
test_delete_user_pref
(
)
{
for
(
let
[
radioIndex
testValue
]
of
[
[
0
false
]
[
1
-
1
]
[
2
"
value
"
]
]
)
{
Preferences
.
set
(
PREF_NEW
testValue
)
;
await
AboutConfigTest
.
withNewTab
(
async
function
(
)
{
let
row
=
this
.
getRow
(
PREF_NEW
)
;
row
.
resetColumnButton
.
click
(
)
;
Assert
.
ok
(
row
.
hasClass
(
"
deleted
"
)
)
;
Assert
.
equal
(
Services
.
prefs
.
getPrefType
(
PREF_NEW
)
Ci
.
nsIPrefBranch
.
PREF_INVALID
)
;
Assert
.
ok
(
row
.
element
.
querySelectorAll
(
"
input
"
)
[
radioIndex
]
.
checked
)
;
row
.
editColumnButton
.
click
(
)
;
Assert
.
ok
(
!
row
.
hasClass
(
"
deleted
"
)
)
;
Assert
.
ok
(
Preferences
.
get
(
PREF_NEW
)
=
=
=
testValue
)
;
row
.
resetColumnButton
.
click
(
)
;
this
.
showAll
(
)
;
Assert
.
ok
(
!
this
.
getRow
(
PREF_NEW
)
)
;
}
)
;
}
}
)
;
add_task
(
async
function
test_click_type_label_multiple_forms
(
)
{
const
PREF_TO_DELETE
=
"
test
.
aboutconfig
.
modify
.
boolean
"
;
const
PREF_NEW_WHILE_DELETED
=
"
test
.
aboutconfig
.
modify
.
"
;
await
AboutConfigTest
.
withNewTab
(
async
function
(
)
{
this
.
search
(
PREF_NEW_WHILE_DELETED
)
;
let
existingRow
=
this
.
getRow
(
PREF_TO_DELETE
)
;
existingRow
.
resetColumnButton
.
click
(
)
;
let
newRow
=
this
.
getRow
(
PREF_NEW_WHILE_DELETED
)
;
for
(
let
[
radioIndex
expectedValue
]
of
[
[
0
true
]
[
1
0
]
[
2
"
"
]
]
)
{
let
radioLabels
=
newRow
.
element
.
querySelectorAll
(
"
label
>
span
"
)
;
await
this
.
document
.
l10n
.
translateElements
(
radioLabels
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
radioLabels
[
radioIndex
]
{
}
this
.
browser
)
;
newRow
.
editColumnButton
.
click
(
)
;
Assert
.
ok
(
Preferences
.
get
(
PREF_NEW_WHILE_DELETED
)
=
=
=
expectedValue
)
;
newRow
.
resetColumnButton
.
click
(
)
;
}
existingRow
.
editColumnButton
.
click
(
)
;
Assert
.
ok
(
Preferences
.
get
(
PREF_TO_DELETE
)
=
=
=
true
)
;
}
)
;
}
)
;
add_task
(
async
function
test_reset_user_pref
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
PREF_BOOLEAN_DEFAULT_TRUE
false
]
[
PREF_STRING_LOCALIZED_MISSING
"
user
-
value
"
]
]
}
)
;
await
AboutConfigTest
.
withNewTab
(
async
function
(
)
{
let
row
=
this
.
getRow
(
PREF_BOOLEAN_DEFAULT_TRUE
)
;
row
.
resetColumnButton
.
click
(
)
;
Assert
.
ok
(
!
row
.
hasClass
(
"
has
-
user
-
value
"
)
)
;
Assert
.
ok
(
!
row
.
resetColumnButton
)
;
Assert
.
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
PREF_BOOLEAN_DEFAULT_TRUE
)
)
;
Assert
.
equal
(
this
.
getRow
(
PREF_BOOLEAN_DEFAULT_TRUE
)
.
value
"
true
"
)
;
this
.
showAll
(
)
;
row
=
this
.
getRow
(
PREF_BOOLEAN_DEFAULT_TRUE
)
;
Assert
.
ok
(
!
row
.
hasClass
(
"
has
-
user
-
value
"
)
)
;
Assert
.
ok
(
!
row
.
resetColumnButton
)
;
Assert
.
equal
(
this
.
getRow
(
PREF_BOOLEAN_DEFAULT_TRUE
)
.
value
"
true
"
)
;
row
=
this
.
getRow
(
PREF_STRING_LOCALIZED_MISSING
)
;
Assert
.
equal
(
row
.
value
"
user
-
value
"
)
;
row
.
resetColumnButton
.
click
(
)
;
Assert
.
ok
(
!
row
.
hasClass
(
"
has
-
user
-
value
"
)
)
;
Assert
.
ok
(
!
row
.
resetColumnButton
)
;
Assert
.
ok
(
!
Services
.
prefs
.
prefHasUserValue
(
PREF_STRING_LOCALIZED_MISSING
)
)
;
Assert
.
equal
(
this
.
getRow
(
PREF_STRING_LOCALIZED_MISSING
)
.
value
"
"
)
;
}
)
;
}
)
;
add_task
(
async
function
test_modify
(
)
{
await
AboutConfigTest
.
withNewTab
(
async
function
(
)
{
for
(
let
nameOfBoolPref
of
[
PREF_MODIFY_BOOLEAN
PREF_BOOLEAN_DEFAULT_TRUE
]
)
{
let
row
=
this
.
getRow
(
nameOfBoolPref
)
;
for
(
let
i
=
0
;
i
<
2
;
i
+
+
)
{
row
.
editColumnButton
.
click
(
)
;
Assert
.
equal
(
this
.
getRow
(
nameOfBoolPref
)
.
value
"
"
+
Preferences
.
get
(
nameOfBoolPref
)
)
;
let
prefHasUserValue
=
Services
.
prefs
.
prefHasUserValue
(
nameOfBoolPref
)
;
Assert
.
equal
(
row
.
hasClass
(
"
has
-
user
-
value
"
)
prefHasUserValue
)
;
Assert
.
equal
(
!
!
row
.
resetColumnButton
prefHasUserValue
)
;
}
}
let
row
=
this
.
getRow
(
PREF_MODIFY_STRING
)
;
row
.
editColumnButton
.
click
(
)
;
row
.
valueInput
.
value
=
"
test
"
;
let
intRow
=
this
.
getRow
(
PREF_MODIFY_NUMBER
)
;
intRow
.
editColumnButton
.
click
(
)
;
Assert
.
equal
(
intRow
.
valueInput
.
value
Preferences
.
get
(
PREF_MODIFY_NUMBER
)
)
;
Assert
.
ok
(
!
row
.
valueInput
)
;
Assert
.
equal
(
row
.
value
Preferences
.
get
(
PREF_MODIFY_STRING
)
)
;
for
(
let
invalidValue
of
[
"
"
"
"
"
a
"
"
1
.
5
"
"
-
2147483649
"
"
2147483648
"
]
)
{
intRow
.
valueInput
.
value
=
invalidValue
;
intRow
.
editColumnButton
.
click
(
)
;
Assert
.
ok
(
intRow
.
valueInput
)
;
}
for
(
let
[
prefName
willDelete
]
of
[
[
PREF_MODIFY_STRING
true
]
[
PREF_MODIFY_NUMBER
true
]
[
PREF_NUMBER_DEFAULT_ZERO
false
]
[
PREF_STRING_DEFAULT_EMPTY
false
]
]
)
{
row
=
this
.
getRow
(
prefName
)
;
row
.
editColumnButton
.
click
(
)
;
Assert
.
equal
(
row
.
valueInput
.
value
Preferences
.
get
(
prefName
)
)
;
row
.
valueInput
.
value
=
"
42
"
;
row
.
editColumnButton
.
click
(
)
;
Assert
.
equal
(
Preferences
.
get
(
prefName
)
"
42
"
)
;
Assert
.
equal
(
row
.
value
"
42
"
)
;
Assert
.
ok
(
row
.
hasClass
(
"
has
-
user
-
value
"
)
)
;
row
.
editColumnButton
.
click
(
)
;
Assert
.
equal
(
row
.
valueInput
.
value
Preferences
.
get
(
prefName
)
)
;
row
.
resetColumnButton
.
click
(
)
;
Assert
.
ok
(
!
row
.
hasClass
(
"
has
-
user
-
value
"
)
)
;
Assert
.
equal
(
row
.
hasClass
(
"
deleted
"
)
willDelete
)
;
}
}
)
;
}
)
;
add_task
(
async
function
test_edit_field_selected
(
)
{
let
prefsToCheck
=
[
[
PREF_MODIFY_STRING
"
A
string
"
"
A
new
string
"
]
[
PREF_MODIFY_NUMBER
"
100
"
"
500
"
]
]
;
await
AboutConfigTest
.
withNewTab
(
async
function
(
)
{
for
(
let
[
prefName
startValue
endValue
]
of
prefsToCheck
)
{
Preferences
.
set
(
prefName
startValue
)
;
let
row
=
this
.
getRow
(
prefName
)
;
Assert
.
equal
(
row
.
value
startValue
)
;
row
.
editColumnButton
.
click
(
)
;
Assert
.
equal
(
row
.
valueInput
.
value
startValue
)
;
EventUtils
.
sendString
(
endValue
this
.
window
)
;
row
.
editColumnButton
.
click
(
)
;
Assert
.
equal
(
row
.
value
endValue
)
;
Assert
.
equal
(
Preferences
.
get
(
prefName
)
endValue
)
;
}
}
)
;
}
)
;
