"
use
strict
"
;
const
{
QRCodeGenerator
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
QRCodeGenerator
.
sys
.
mjs
"
)
;
function
createMockDocument
(
)
{
return
{
createElementNS
:
(
ns
tagName
)
=
>
{
if
(
tagName
=
=
=
"
canvas
"
)
{
return
{
width
:
0
height
:
0
getContext
:
(
)
=
>
(
{
imageSmoothingEnabled
:
false
imageSmoothingQuality
:
"
high
"
fillStyle
:
"
white
"
beginPath
:
(
)
=
>
{
}
arc
:
(
)
=
>
{
}
fill
:
(
)
=
>
{
}
drawImage
:
(
)
=
>
{
}
}
)
toDataURL
:
(
)
=
>
"
data
:
image
/
png
;
base64
mock
"
}
;
}
else
if
(
tagName
=
=
=
"
img
"
)
{
return
{
onload
:
null
onerror
:
null
set
src
(
value
)
{
Services
.
tm
.
dispatchToMainThread
(
(
)
=
>
{
if
(
this
.
onload
)
{
this
.
onload
(
)
;
}
}
)
;
}
}
;
}
return
{
}
;
}
}
;
}
add_task
(
async
function
test_generator_uses_worker
(
)
{
info
(
"
Testing
QRCodeGenerator
generates
QR
code
using
worker
"
)
;
const
mockDocument
=
createMockDocument
(
)
;
const
testUrl
=
"
https
:
/
/
mozilla
.
org
"
;
const
dataUri
=
await
QRCodeGenerator
.
generateQRCode
(
testUrl
mockDocument
)
;
Assert
.
ok
(
dataUri
"
Should
get
a
data
URI
from
generateQRCode
"
)
;
Assert
.
ok
(
dataUri
.
startsWith
(
"
data
:
image
/
"
)
"
Should
be
a
data
URI
"
)
;
}
)
;
add_task
(
async
function
test_generator_multiple_generations
(
)
{
info
(
"
Testing
QRCodeGenerator
can
generate
multiple
QR
codes
"
)
;
const
dataUri1
=
await
QRCodeGenerator
.
generateQRCode
(
"
https
:
/
/
mozilla
.
org
"
createMockDocument
(
)
)
;
Assert
.
ok
(
dataUri1
"
Should
get
first
data
URI
"
)
;
const
dataUri2
=
await
QRCodeGenerator
.
generateQRCode
(
"
https
:
/
/
firefox
.
com
"
createMockDocument
(
)
)
;
Assert
.
ok
(
dataUri2
"
Should
get
second
data
URI
"
)
;
}
)
;
