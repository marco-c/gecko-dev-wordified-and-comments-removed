#
include
"
file_sink
.
h
"
#
include
<
iostream
>
#
include
<
string
>
#
include
<
windows
.
h
>
bool
FileSink
:
:
open
(
std
:
:
wstring
&
filename
)
{
mFilename
.
assign
(
filename
)
;
fileHandle
.
own
(
CreateFileW
(
filename
.
c_str
(
)
GENERIC_WRITE
FILE_SHARE_READ
|
FILE_SHARE_WRITE
nullptr
CREATE_NEW
FILE_ATTRIBUTE_NORMAL
nullptr
)
)
;
if
(
fileHandle
.
get
(
)
=
=
INVALID_HANDLE_VALUE
)
{
return
false
;
}
else
{
return
true
;
}
}
bool
FileSink
:
:
accept
(
char
*
buf
int
bytesToWrite
)
{
while
(
bytesToWrite
>
0
)
{
DWORD
bytesWritten
=
0
;
if
(
!
WriteFile
(
fileHandle
buf
bytesToWrite
&
bytesWritten
nullptr
)
)
{
std
:
:
cout
<
<
"
Failed
to
write
!
"
<
<
GetLastError
(
)
<
<
std
:
:
endl
;
return
false
;
}
bytesToWrite
-
=
bytesWritten
;
}
return
true
;
}
bool
FileSink
:
:
freeze
(
)
{
HANDLE
readOnlyHandle
=
CreateFileW
(
mFilename
.
c_str
(
)
GENERIC_READ
FILE_SHARE_READ
|
FILE_SHARE_WRITE
nullptr
OPEN_EXISTING
FILE_ATTRIBUTE_NORMAL
nullptr
)
;
if
(
readOnlyHandle
=
=
INVALID_HANDLE_VALUE
)
{
return
false
;
}
fileHandle
.
own
(
readOnlyHandle
)
;
return
true
;
}
