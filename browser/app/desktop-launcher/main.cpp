#
include
<
iostream
>
#
include
<
optional
>
#
include
<
rpc
.
h
>
#
include
<
shellapi
.
h
>
#
include
<
string
>
#
include
<
windows
.
h
>
#
include
"
download_firefox
.
h
"
#
include
"
file_sink
.
h
"
#
include
"
find_firefox
.
h
"
#
include
"
tempfile_name
.
h
"
#
define
DOWNLOAD_PAGE
L
"
https
:
/
/
www
.
mozilla
.
org
/
firefox
/
new
/
"
#
define
STUB_INSTALLER_ARGS
L
"
/
Prompt
/
LaunchedBy
:
desktoplauncher
"
static
bool
ExecuteAndWaitForIdle
(
const
std
:
:
wstring
&
path
const
wchar_t
*
params
)
{
SHELLEXECUTEINFOW
sei
=
{
0
}
;
sei
.
cbSize
=
sizeof
(
sei
)
;
sei
.
fMask
=
SEE_MASK_WAITFORINPUTIDLE
|
SEE_MASK_NOASYNC
;
sei
.
lpFile
=
path
.
c_str
(
)
;
sei
.
lpParameters
=
params
;
sei
.
nShow
=
SW_SHOWNORMAL
;
ShellExecuteExW
(
&
sei
)
;
return
(
uintptr_t
)
sei
.
hInstApp
>
32
;
}
int
wmain
(
)
{
if
(
!
SetEnvironmentVariableW
(
L
"
FIREFOX_LAUNCHED_BY_DESKTOP_LAUNCHER
"
L
"
TRUE
"
)
)
{
std
:
:
wcout
<
<
L
"
Could
not
set
env
variable
FIREFOX_LAUNCHED_BY_DESKTOP_LAUNCHER
"
<
<
std
:
:
endl
;
}
std
:
:
optional
<
std
:
:
wstring
>
firefox_path
=
lookupFirefoxPath
(
)
;
if
(
firefox_path
.
has_value
(
)
)
{
std
:
:
wcout
<
<
L
"
Found
Firefox
at
path
"
<
<
firefox_path
.
value
(
)
<
<
std
:
:
endl
;
if
(
ExecuteAndWaitForIdle
(
firefox_path
.
value
(
)
nullptr
)
)
{
std
:
:
wcout
<
<
L
"
Firefox
launched
"
<
<
std
:
:
endl
;
return
0
;
}
}
bool
download_completed
=
false
;
std
:
:
optional
<
std
:
:
wstring
>
tempfileName
=
get_tempfile_name
(
)
;
std
:
:
unique_ptr
<
FileSink
>
fileSink
;
if
(
tempfileName
.
has_value
(
)
)
{
fileSink
=
std
:
:
make_unique
<
FileSink
>
(
)
;
if
(
fileSink
-
>
open
(
tempfileName
.
value
(
)
)
)
{
ErrCode
rc
=
download_firefox
(
fileSink
.
get
(
)
)
;
if
(
rc
=
=
ErrCode
:
:
OK
)
{
std
:
:
wcout
<
<
L
"
Firefox
installer
successfully
downloaded
"
<
<
std
:
:
endl
;
download_completed
=
true
;
}
}
}
if
(
download_completed
)
{
if
(
fileSink
-
>
freeze
(
)
&
&
ExecuteAndWaitForIdle
(
tempfileName
.
value
(
)
STUB_INSTALLER_ARGS
)
)
{
std
:
:
wcout
<
<
L
"
Firefox
installer
launched
"
<
<
std
:
:
endl
;
return
0
;
}
}
if
(
ExecuteAndWaitForIdle
(
DOWNLOAD_PAGE
nullptr
)
)
{
std
:
:
wcout
<
<
L
"
Opened
default
browser
to
the
download
page
"
<
<
std
:
:
endl
;
}
return
0
;
}
