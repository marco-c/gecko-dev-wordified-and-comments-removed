#
include
"
LaunchUnelevated
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
CmdLineAndEnvUtils
.
h
"
#
include
"
mozilla
/
LauncherResult
.
h
"
#
include
"
mozilla
/
mscom
/
ProcessRuntime
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
ShellHeaderOnlyUtils
.
h
"
#
include
"
nsWindowsHelpers
.
h
"
#
include
<
windows
.
h
>
static
mozilla
:
:
LauncherResult
<
TOKEN_ELEVATION_TYPE
>
GetElevationType
(
const
nsAutoHandle
&
aToken
)
{
DWORD
retLen
;
TOKEN_ELEVATION_TYPE
elevationType
;
if
(
!
:
:
GetTokenInformation
(
aToken
.
get
(
)
TokenElevationType
&
elevationType
sizeof
(
elevationType
)
&
retLen
)
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
return
elevationType
;
}
static
mozilla
:
:
LauncherResult
<
bool
>
IsHighIntegrity
(
const
nsAutoHandle
&
aToken
)
{
DWORD
reqdLen
;
if
(
!
:
:
GetTokenInformation
(
aToken
.
get
(
)
TokenIntegrityLevel
nullptr
0
&
reqdLen
)
)
{
DWORD
err
=
:
:
GetLastError
(
)
;
if
(
err
!
=
ERROR_INSUFFICIENT_BUFFER
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
err
)
;
}
}
auto
buf
=
mozilla
:
:
MakeUnique
<
char
[
]
>
(
reqdLen
)
;
if
(
!
:
:
GetTokenInformation
(
aToken
.
get
(
)
TokenIntegrityLevel
buf
.
get
(
)
reqdLen
&
reqdLen
)
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
auto
tokenLabel
=
reinterpret_cast
<
PTOKEN_MANDATORY_LABEL
>
(
buf
.
get
(
)
)
;
DWORD
subAuthCount
=
*
:
:
GetSidSubAuthorityCount
(
tokenLabel
-
>
Label
.
Sid
)
;
DWORD
integrityLevel
=
*
:
:
GetSidSubAuthority
(
tokenLabel
-
>
Label
.
Sid
subAuthCount
-
1
)
;
return
integrityLevel
>
SECURITY_MANDATORY_MEDIUM_RID
;
}
static
mozilla
:
:
LauncherResult
<
HANDLE
>
GetMediumIntegrityToken
(
const
nsAutoHandle
&
aProcessToken
)
{
HANDLE
rawResult
;
if
(
!
:
:
DuplicateTokenEx
(
aProcessToken
.
get
(
)
0
nullptr
SecurityImpersonation
TokenPrimary
&
rawResult
)
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
nsAutoHandle
result
(
rawResult
)
;
BYTE
mediumIlSid
[
SECURITY_MAX_SID_SIZE
]
;
DWORD
mediumIlSidSize
=
sizeof
(
mediumIlSid
)
;
if
(
!
:
:
CreateWellKnownSid
(
WinMediumLabelSid
nullptr
mediumIlSid
&
mediumIlSidSize
)
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
TOKEN_MANDATORY_LABEL
integrityLevel
=
{
}
;
integrityLevel
.
Label
.
Attributes
=
SE_GROUP_INTEGRITY
;
integrityLevel
.
Label
.
Sid
=
reinterpret_cast
<
PSID
>
(
mediumIlSid
)
;
if
(
!
:
:
SetTokenInformation
(
rawResult
TokenIntegrityLevel
&
integrityLevel
sizeof
(
integrityLevel
)
)
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
return
result
.
disown
(
)
;
}
namespace
mozilla
{
LauncherVoidResult
LaunchUnelevated
(
int
aArgc
wchar_t
*
aArgv
[
]
)
{
mozilla
:
:
mscom
:
:
ProcessRuntime
mscom
(
GeckoProcessType_Default
)
;
if
(
!
mscom
)
{
return
LAUNCHER_ERROR_FROM_HRESULT
(
mscom
.
GetHResult
(
)
)
;
}
UniquePtr
<
wchar_t
[
]
>
cmdLine
(
MakeCommandLine
(
aArgc
-
1
aArgv
+
1
)
)
;
if
(
!
cmdLine
)
{
return
LAUNCHER_ERROR_GENERIC
(
)
;
}
_bstr_t
exe
(
aArgv
[
0
]
)
;
_variant_t
args
(
cmdLine
.
get
(
)
)
;
_variant_t
operation
(
L
"
open
"
)
;
_variant_t
directory
;
_variant_t
showCmd
(
SW_SHOWNORMAL
)
;
return
ShellExecuteByExplorer
(
exe
args
operation
directory
showCmd
)
;
}
LauncherResult
<
ElevationState
>
GetElevationState
(
mozilla
:
:
LauncherFlags
aFlags
nsAutoHandle
&
aOutMediumIlToken
)
{
aOutMediumIlToken
.
reset
(
)
;
const
DWORD
tokenFlags
=
TOKEN_QUERY
|
TOKEN_DUPLICATE
|
TOKEN_ADJUST_DEFAULT
|
TOKEN_ASSIGN_PRIMARY
;
HANDLE
rawToken
;
if
(
!
:
:
OpenProcessToken
(
:
:
GetCurrentProcess
(
)
tokenFlags
&
rawToken
)
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
nsAutoHandle
token
(
rawToken
)
;
LauncherResult
<
TOKEN_ELEVATION_TYPE
>
elevationType
=
GetElevationType
(
token
)
;
if
(
elevationType
.
isErr
(
)
)
{
return
LAUNCHER_ERROR_FROM_RESULT
(
elevationType
)
;
}
switch
(
elevationType
.
unwrap
(
)
)
{
case
TokenElevationTypeLimited
:
return
ElevationState
:
:
eNormalUser
;
case
TokenElevationTypeFull
:
if
(
(
aFlags
&
(
mozilla
:
:
LauncherFlags
:
:
eWaitForBrowser
|
mozilla
:
:
LauncherFlags
:
:
eNoDeelevate
)
)
=
=
mozilla
:
:
LauncherFlags
:
:
eWaitForBrowser
)
{
LauncherResult
<
HANDLE
>
tokenResult
=
GetMediumIntegrityToken
(
token
)
;
if
(
tokenResult
.
isOk
(
)
)
{
aOutMediumIlToken
.
own
(
tokenResult
.
unwrap
(
)
)
;
}
else
{
return
LAUNCHER_ERROR_FROM_RESULT
(
tokenResult
)
;
}
}
return
ElevationState
:
:
eElevated
;
case
TokenElevationTypeDefault
:
break
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Was
a
new
value
added
to
the
enumeration
?
"
)
;
return
LAUNCHER_ERROR_GENERIC
(
)
;
}
LauncherResult
<
bool
>
isHighIntegrity
=
IsHighIntegrity
(
token
)
;
if
(
isHighIntegrity
.
isErr
(
)
)
{
return
LAUNCHER_ERROR_FROM_RESULT
(
isHighIntegrity
)
;
}
if
(
!
isHighIntegrity
.
unwrap
(
)
)
{
return
ElevationState
:
:
eNormalUser
;
}
if
(
!
(
aFlags
&
mozilla
:
:
LauncherFlags
:
:
eNoDeelevate
)
)
{
LauncherResult
<
HANDLE
>
tokenResult
=
GetMediumIntegrityToken
(
token
)
;
if
(
tokenResult
.
isOk
(
)
)
{
aOutMediumIlToken
.
own
(
tokenResult
.
unwrap
(
)
)
;
}
else
{
return
LAUNCHER_ERROR_FROM_RESULT
(
tokenResult
)
;
}
}
return
ElevationState
:
:
eHighIntegrityNoUAC
;
}
}
