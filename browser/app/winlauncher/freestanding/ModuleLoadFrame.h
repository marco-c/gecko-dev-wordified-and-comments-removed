#
ifndef
mozilla_freestanding_ModuleLoadFrame_h
#
define
mozilla_freestanding_ModuleLoadFrame_h
#
include
"
mozilla
/
LoaderAPIInterfaces
.
h
"
#
include
"
mozilla
/
NativeNt
.
h
"
#
include
"
mozilla
/
ThreadLocal
.
h
"
#
include
"
SafeThreadLocal
.
h
"
namespace
mozilla
{
namespace
freestanding
{
class
MOZ_RAII
ModuleLoadFrame
final
{
public
:
explicit
ModuleLoadFrame
(
PCUNICODE_STRING
aRequestedDllName
)
;
~
ModuleLoadFrame
(
)
;
static
void
NotifyLSPSubstitutionRequired
(
PCUNICODE_STRING
aLeafName
)
;
static
void
NotifySectionMap
(
nt
:
:
AllocatedUnicodeString
&
&
aSectionName
const
void
*
aMapBaseAddr
NTSTATUS
aMapNtStatus
ModuleLoadInfo
:
:
Status
aLoadStatus
bool
aIsDependent
)
;
static
bool
ExistsTopFrame
(
)
;
NTSTATUS
SetLoadStatus
(
NTSTATUS
aNtStatus
PHANDLE
aOutHandle
)
;
ModuleLoadFrame
(
const
ModuleLoadFrame
&
)
=
delete
;
ModuleLoadFrame
(
ModuleLoadFrame
&
&
)
=
delete
;
ModuleLoadFrame
&
operator
=
(
const
ModuleLoadFrame
&
)
=
delete
;
ModuleLoadFrame
&
operator
=
(
ModuleLoadFrame
&
&
)
=
delete
;
private
:
ModuleLoadFrame
(
nt
:
:
AllocatedUnicodeString
&
&
aSectionName
const
void
*
aMapBaseAddr
NTSTATUS
aNtStatus
ModuleLoadInfo
:
:
Status
aLoadStatus
bool
aIsDependent
)
;
void
SetLSPSubstitutionRequired
(
PCUNICODE_STRING
aLeafName
)
;
void
OnSectionMap
(
nt
:
:
AllocatedUnicodeString
&
&
aSectionName
const
void
*
aMapBaseAddr
NTSTATUS
aMapNtStatus
ModuleLoadInfo
:
:
Status
aLoadStatus
bool
aIsDependent
)
;
static
void
OnBareSectionMap
(
nt
:
:
AllocatedUnicodeString
&
&
aSectionName
const
void
*
aMapBaseAddr
NTSTATUS
aMapNtStatus
ModuleLoadInfo
:
:
Status
aLoadStatus
bool
aIsDependent
)
;
private
:
ModuleLoadFrame
*
mPrev
;
void
*
mContext
;
bool
mLSPSubstitutionRequired
;
NTSTATUS
mLoadNtStatus
;
ModuleLoadInfo
mLoadInfo
;
static
SafeThreadLocal
<
ModuleLoadFrame
*
>
sTopFrame
;
}
;
}
}
#
endif
