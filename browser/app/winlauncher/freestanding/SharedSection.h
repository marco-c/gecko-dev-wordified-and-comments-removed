#
ifndef
mozilla_freestanding_SharedSection_h
#
define
mozilla_freestanding_SharedSection_h
#
include
"
mozilla
/
NativeNt
.
h
"
#
include
"
mozilla
/
interceptor
/
MMPolicies
.
h
"
#
define
MOZ_LITERAL_UNICODE_STRING
(
s
)
\
{
\
/
*
Length
of
the
string
in
bytes
less
the
null
terminator
*
/
\
sizeof
(
s
)
-
sizeof
(
wchar_t
)
\
/
*
Length
of
the
string
in
bytes
including
the
null
terminator
*
/
\
sizeof
(
s
)
\
/
*
Pointer
to
the
buffer
*
/
\
const_cast
<
wchar_t
*
>
(
s
)
\
}
namespace
mozilla
{
namespace
freestanding
{
class
SharedSectionTestHelper
;
struct
MOZ_TRIVIAL_CTOR_DTOR
Kernel32ExportsSolver
final
:
interceptor
:
:
MMPolicyInProcessEarlyStage
:
:
Kernel32Exports
{
void
Init
(
)
;
bool
Resolve
(
)
;
}
;
class
MOZ_TRIVIAL_CTOR_DTOR
SharedSection
final
{
struct
Layout
final
{
enum
class
State
{
kUninitialized
kInitialized
kResolved
}
mState
;
Kernel32ExportsSolver
mK32Exports
;
wchar_t
mModulePathArray
[
1
]
;
Span
<
wchar_t
>
GetModulePathArray
(
)
{
return
Span
<
wchar_t
>
(
mModulePathArray
(
kSharedViewSize
-
(
reinterpret_cast
<
uintptr_t
>
(
mModulePathArray
)
-
reinterpret_cast
<
uintptr_t
>
(
this
)
)
)
/
sizeof
(
wchar_t
)
)
;
}
Layout
(
)
=
delete
;
bool
Resolve
(
)
;
}
;
static
HANDLE
sSectionHandle
;
static
Layout
*
sWriteCopyView
;
static
RTL_RUN_ONCE
sEnsureOnce
;
static
ULONG
NTAPI
EnsureWriteCopyViewOnce
(
PRTL_RUN_ONCE
PVOID
PVOID
*
)
;
static
Layout
*
EnsureWriteCopyView
(
)
;
static
constexpr
size_t
kSharedViewSize
=
0x1000
;
friend
class
SharedSectionTestHelper
;
public
:
static
void
Reset
(
HANDLE
aNewSectionObject
=
sSectionHandle
)
;
static
void
ConvertToReadOnly
(
)
;
static
LauncherVoidResult
Init
(
)
;
static
LauncherVoidResult
AddDependentModule
(
PCUNICODE_STRING
aNtPath
)
;
Kernel32ExportsSolver
*
GetKernel32Exports
(
)
;
Span
<
const
wchar_t
>
GetDependentModules
(
)
;
static
LauncherVoidResult
TransferHandle
(
nt
:
:
CrossExecTransferManager
&
aTransferMgr
DWORD
aDesiredAccess
HANDLE
*
aDestinationAddress
=
&
sSectionHandle
)
;
}
;
extern
SharedSection
gSharedSection
;
}
}
#
endif
