#
ifndef
mozilla_freestanding_SharedSection_h
#
define
mozilla_freestanding_SharedSection_h
#
include
"
mozilla
/
NativeNt
.
h
"
#
include
"
mozilla
/
interceptor
/
MMPolicies
.
h
"
namespace
mozilla
{
namespace
freestanding
{
class
MOZ_TRIVIAL_CTOR_DTOR
Kernel32ExportsSolver
final
:
public
interceptor
:
:
MMPolicyInProcessEarlyStage
:
:
Kernel32Exports
{
enum
class
State
{
Uninitialized
Initialized
Resolved
}
mState
;
static
ULONG
NTAPI
ResolveOnce
(
PRTL_RUN_ONCE
aRunOnce
PVOID
aParameter
PVOID
*
)
;
void
ResolveInternal
(
)
;
public
:
Kernel32ExportsSolver
(
)
=
default
;
Kernel32ExportsSolver
(
const
Kernel32ExportsSolver
&
)
=
delete
;
Kernel32ExportsSolver
(
Kernel32ExportsSolver
&
&
)
=
delete
;
Kernel32ExportsSolver
&
operator
=
(
const
Kernel32ExportsSolver
&
)
=
delete
;
Kernel32ExportsSolver
&
operator
=
(
Kernel32ExportsSolver
&
&
)
=
delete
;
bool
IsInitialized
(
)
const
;
bool
IsResolved
(
)
const
;
void
Init
(
)
;
void
Resolve
(
RTL_RUN_ONCE
&
aRunOnce
)
;
}
;
class
MOZ_TRIVIAL_CTOR_DTOR
SharedSection
final
{
static
HANDLE
sSectionHandle
;
static
void
*
sWriteCopyView
;
static
constexpr
size_t
kSharedViewSize
=
0x1000
;
public
:
struct
Layout
final
{
Kernel32ExportsSolver
mK32Exports
;
wchar_t
mModulePathArray
[
1
]
;
Layout
(
)
=
delete
;
}
;
static
void
Reset
(
HANDLE
aNewSecionObject
=
sSectionHandle
)
;
static
void
ConvertToReadOnly
(
)
;
static
LauncherVoidResult
Init
(
const
nt
:
:
PEHeaders
&
aPEHeaders
)
;
static
LauncherVoidResult
AddDepenentModule
(
PCUNICODE_STRING
aNtPath
)
;
static
LauncherResult
<
Layout
*
>
GetView
(
)
;
static
LauncherVoidResult
TransferHandle
(
nt
:
:
CrossExecTransferManager
&
aTransferMgr
DWORD
aDesiredAccess
HANDLE
*
aDestinationAddress
=
&
sSectionHandle
)
;
}
;
extern
SharedSection
gSharedSection
;
}
}
#
endif
