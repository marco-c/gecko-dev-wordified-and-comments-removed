#
define
MOZ_USE_LAUNCHER_ERROR
#
include
"
nsWindowsDllInterceptor
.
h
"
#
include
"
mozilla
/
ArrayUtils
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
BinarySearch
.
h
"
#
include
"
mozilla
/
ImportDir
.
h
"
#
include
"
mozilla
/
NativeNt
.
h
"
#
include
"
mozilla
/
Types
.
h
"
#
include
"
mozilla
/
WindowsDllBlocklist
.
h
"
#
include
"
mozilla
/
WinHeaderOnlyUtils
.
h
"
#
include
"
DllBlocklistInit
.
h
"
#
include
"
freestanding
/
DllBlocklist
.
h
"
#
include
"
freestanding
/
FunctionTableResolver
.
h
"
#
if
defined
(
_MSC_VER
)
extern
"
C
"
IMAGE_DOS_HEADER
__ImageBase
;
#
endif
namespace
{
template
<
typename
T
>
T
*
GetRemoteAddress
(
T
*
aLocalAddress
HMODULE
aLocal
HMODULE
aRemote
)
{
ptrdiff_t
diff
=
nt
:
:
PEHeaders
:
:
HModuleToBaseAddr
<
uint8_t
*
>
(
aRemote
)
-
nt
:
:
PEHeaders
:
:
HModuleToBaseAddr
<
uint8_t
*
>
(
aLocal
)
;
return
reinterpret_cast
<
T
*
>
(
reinterpret_cast
<
uint8_t
*
>
(
aLocalAddress
)
+
diff
)
;
}
}
namespace
mozilla
{
#
if
defined
(
MOZ_ASAN
)
|
|
defined
(
_M_ARM64
)
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOP
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
const
IMAGE_THUNK_DATA
*
)
{
return
mozilla
:
:
Ok
(
)
;
}
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOPFromLauncher
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
)
{
return
mozilla
:
:
Ok
(
)
;
}
#
else
static
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOPInternal
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
const
IMAGE_THUNK_DATA
*
aCachedNtdllThunk
)
{
freestanding
:
:
gK32
.
Init
(
)
;
if
(
freestanding
:
:
gK32
.
IsInitialized
(
)
)
{
freestanding
:
:
gK32
.
Transfer
(
aChildProcess
&
freestanding
:
:
gK32
)
;
}
CrossProcessDllInterceptor
intcpt
(
aChildProcess
)
;
intcpt
.
Init
(
L
"
ntdll
.
dll
"
)
;
bool
ok
=
freestanding
:
:
stub_NtMapViewOfSection
.
SetDetour
(
aChildProcess
intcpt
"
NtMapViewOfSection
"
&
freestanding
:
:
patched_NtMapViewOfSection
)
;
if
(
!
ok
)
{
return
LAUNCHER_ERROR_GENERIC_WITH_DETOUR_ERROR
(
intcpt
.
GetLastError
(
)
)
;
}
ok
=
freestanding
:
:
stub_LdrLoadDll
.
SetDetour
(
aChildProcess
intcpt
"
LdrLoadDll
"
&
freestanding
:
:
patched_LdrLoadDll
)
;
if
(
!
ok
)
{
return
LAUNCHER_ERROR_GENERIC_WITH_DETOUR_ERROR
(
intcpt
.
GetLastError
(
)
)
;
}
HMODULE
ourModule
;
#
if
defined
(
_MSC_VER
)
ourModule
=
reinterpret_cast
<
HMODULE
>
(
&
__ImageBase
)
;
#
else
ourModule
=
:
:
GetModuleHandleW
(
nullptr
)
;
#
endif
mozilla
:
:
nt
:
:
PEHeaders
ourExeImage
(
ourModule
)
;
if
(
!
ourExeImage
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
LauncherResult
<
HMODULE
>
remoteImageBaseResult
=
nt
:
:
GetProcessExeModule
(
aChildProcess
)
;
if
(
remoteImageBaseResult
.
isErr
(
)
)
{
return
remoteImageBaseResult
.
propagateErr
(
)
;
}
HMODULE
remoteImageBase
=
remoteImageBaseResult
.
unwrap
(
)
;
LauncherVoidResult
importDirRestored
=
RestoreImportDirectory
(
aFullImagePath
ourExeImage
aChildProcess
remoteImageBase
)
;
if
(
importDirRestored
.
isErr
(
)
)
{
return
importDirRestored
;
}
mozilla
:
:
nt
:
:
PEHeaders
ntdllImage
(
:
:
GetModuleHandleW
(
L
"
ntdll
.
dll
"
)
)
;
if
(
!
ntdllImage
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
Maybe
<
Span
<
IMAGE_THUNK_DATA
>
>
ntdllThunks
;
if
(
aCachedNtdllThunk
)
{
ntdllThunks
=
ourExeImage
.
GetIATThunksForModule
(
"
ntdll
.
dll
"
)
;
}
else
{
Maybe
<
Range
<
const
uint8_t
>
>
ntdllBoundaries
=
ntdllImage
.
GetBounds
(
)
;
if
(
!
ntdllBoundaries
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
ntdllThunks
=
ourExeImage
.
GetIATThunksForModule
(
"
ntdll
.
dll
"
ntdllBoundaries
.
ptr
(
)
)
;
}
if
(
!
ntdllThunks
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_INVALID_DATA
)
;
}
SIZE_T
bytesWritten
;
{
PIMAGE_THUNK_DATA
firstIatThunkDst
=
ntdllThunks
.
value
(
)
.
data
(
)
;
const
IMAGE_THUNK_DATA
*
firstIatThunkSrc
=
aCachedNtdllThunk
?
aCachedNtdllThunk
:
firstIatThunkDst
;
SIZE_T
iatLength
=
ntdllThunks
.
value
(
)
.
LengthBytes
(
)
;
firstIatThunkDst
=
GetRemoteAddress
(
firstIatThunkDst
ourModule
remoteImageBase
)
;
AutoVirtualProtect
prot
(
firstIatThunkDst
iatLength
PAGE_READWRITE
aChildProcess
)
;
if
(
!
prot
)
{
return
LAUNCHER_ERROR_FROM_MOZ_WINDOWS_ERROR
(
prot
.
GetError
(
)
)
;
}
ok
=
!
!
:
:
WriteProcessMemory
(
aChildProcess
firstIatThunkDst
firstIatThunkSrc
iatLength
&
bytesWritten
)
;
if
(
!
ok
|
|
bytesWritten
!
=
iatLength
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
}
uint32_t
newFlags
=
eDllBlocklistInitFlagWasBootstrapped
;
if
(
gBlocklistInitFlags
&
eDllBlocklistInitFlagWasBootstrapped
)
{
newFlags
|
=
eDllBlocklistInitFlagIsChildProcess
;
}
ok
=
!
!
:
:
WriteProcessMemory
(
aChildProcess
GetRemoteAddress
(
&
gBlocklistInitFlags
ourModule
remoteImageBase
)
&
newFlags
sizeof
(
newFlags
)
&
bytesWritten
)
;
if
(
!
ok
|
|
bytesWritten
!
=
sizeof
(
newFlags
)
)
{
return
LAUNCHER_ERROR_FROM_LAST
(
)
;
}
return
Ok
(
)
;
}
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOP
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
const
IMAGE_THUNK_DATA
*
aCachedNtdllThunk
)
{
if
(
!
(
gBlocklistInitFlags
&
eDllBlocklistInitFlagWasBootstrapped
)
)
{
HMODULE
exeImageBase
;
#
if
defined
(
_MSC_VER
)
exeImageBase
=
reinterpret_cast
<
HMODULE
>
(
&
__ImageBase
)
;
#
else
exeImageBase
=
:
:
GetModuleHandleW
(
nullptr
)
;
#
endif
mozilla
:
:
nt
:
:
PEHeaders
localImage
(
exeImageBase
)
;
if
(
!
localImage
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
return
RestoreImportDirectory
(
aFullImagePath
localImage
aChildProcess
)
;
}
return
InitializeDllBlocklistOOPInternal
(
aFullImagePath
aChildProcess
aCachedNtdllThunk
)
;
}
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOPFromLauncher
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
)
{
return
InitializeDllBlocklistOOPInternal
(
aFullImagePath
aChildProcess
nullptr
)
;
}
#
endif
}
