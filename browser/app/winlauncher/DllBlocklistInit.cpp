#
define
MOZ_USE_LAUNCHER_ERROR
#
include
"
nsWindowsDllInterceptor
.
h
"
#
include
"
mozilla
/
ArrayUtils
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
BinarySearch
.
h
"
#
include
"
mozilla
/
ImportDir
.
h
"
#
include
"
mozilla
/
NativeNt
.
h
"
#
include
"
mozilla
/
Types
.
h
"
#
include
"
mozilla
/
WindowsDllBlocklist
.
h
"
#
include
"
mozilla
/
WinHeaderOnlyUtils
.
h
"
#
include
"
DllBlocklistInit
.
h
"
#
include
"
freestanding
/
DllBlocklist
.
h
"
#
include
"
freestanding
/
FunctionTableResolver
.
h
"
namespace
mozilla
{
#
if
defined
(
MOZ_ASAN
)
|
|
defined
(
_M_ARM64
)
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOP
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
const
IMAGE_THUNK_DATA
*
)
{
return
mozilla
:
:
Ok
(
)
;
}
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOPFromLauncher
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
)
{
return
mozilla
:
:
Ok
(
)
;
}
#
else
static
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOPInternal
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
const
IMAGE_THUNK_DATA
*
aCachedNtdllThunk
)
{
nt
:
:
CrossExecTransferManager
transferMgr
(
aChildProcess
)
;
if
(
!
transferMgr
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
freestanding
:
:
gK32
.
Init
(
)
;
if
(
freestanding
:
:
gK32
.
IsInitialized
(
)
)
{
Unused
<
<
freestanding
:
:
gK32
.
Transfer
(
transferMgr
&
freestanding
:
:
gK32
)
;
}
CrossProcessDllInterceptor
intcpt
(
aChildProcess
)
;
intcpt
.
Init
(
L
"
ntdll
.
dll
"
)
;
bool
ok
=
freestanding
:
:
stub_NtMapViewOfSection
.
SetDetour
(
transferMgr
intcpt
"
NtMapViewOfSection
"
&
freestanding
:
:
patched_NtMapViewOfSection
)
;
if
(
!
ok
)
{
return
LAUNCHER_ERROR_FROM_DETOUR_ERROR
(
intcpt
.
GetLastDetourError
(
)
)
;
}
ok
=
freestanding
:
:
stub_LdrLoadDll
.
SetDetour
(
transferMgr
intcpt
"
LdrLoadDll
"
&
freestanding
:
:
patched_LdrLoadDll
)
;
if
(
!
ok
)
{
return
LAUNCHER_ERROR_FROM_DETOUR_ERROR
(
intcpt
.
GetLastDetourError
(
)
)
;
}
const
nt
:
:
PEHeaders
&
ourExeImage
=
transferMgr
.
LocalPEHeaders
(
)
;
LauncherVoidResult
importDirRestored
=
RestoreImportDirectory
(
aFullImagePath
transferMgr
)
;
if
(
importDirRestored
.
isErr
(
)
)
{
return
importDirRestored
;
}
mozilla
:
:
nt
:
:
PEHeaders
ntdllImage
(
:
:
GetModuleHandleW
(
L
"
ntdll
.
dll
"
)
)
;
if
(
!
ntdllImage
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
Maybe
<
Span
<
IMAGE_THUNK_DATA
>
>
ntdllThunks
;
if
(
aCachedNtdllThunk
)
{
ntdllThunks
=
ourExeImage
.
GetIATThunksForModule
(
"
ntdll
.
dll
"
)
;
}
else
{
Maybe
<
Range
<
const
uint8_t
>
>
ntdllBoundaries
=
ntdllImage
.
GetBounds
(
)
;
if
(
!
ntdllBoundaries
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
ntdllThunks
=
ourExeImage
.
GetIATThunksForModule
(
"
ntdll
.
dll
"
ntdllBoundaries
.
ptr
(
)
)
;
}
if
(
!
ntdllThunks
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_INVALID_DATA
)
;
}
{
PIMAGE_THUNK_DATA
firstIatThunkDst
=
ntdllThunks
.
value
(
)
.
data
(
)
;
const
IMAGE_THUNK_DATA
*
firstIatThunkSrc
=
aCachedNtdllThunk
?
aCachedNtdllThunk
:
firstIatThunkDst
;
SIZE_T
iatLength
=
ntdllThunks
.
value
(
)
.
LengthBytes
(
)
;
AutoVirtualProtect
prot
=
transferMgr
.
Protect
(
firstIatThunkDst
iatLength
PAGE_READWRITE
)
;
if
(
!
prot
)
{
return
LAUNCHER_ERROR_FROM_MOZ_WINDOWS_ERROR
(
prot
.
GetError
(
)
)
;
}
LauncherVoidResult
writeResult
=
transferMgr
.
Transfer
(
firstIatThunkDst
firstIatThunkSrc
iatLength
)
;
if
(
writeResult
.
isErr
(
)
)
{
return
writeResult
.
propagateErr
(
)
;
}
}
uint32_t
newFlags
=
eDllBlocklistInitFlagWasBootstrapped
;
if
(
gBlocklistInitFlags
&
eDllBlocklistInitFlagWasBootstrapped
)
{
newFlags
|
=
eDllBlocklistInitFlagIsChildProcess
;
}
LauncherVoidResult
writeResult
=
transferMgr
.
Transfer
(
&
gBlocklistInitFlags
&
newFlags
sizeof
(
newFlags
)
)
;
if
(
writeResult
.
isErr
(
)
)
{
return
writeResult
.
propagateErr
(
)
;
}
return
Ok
(
)
;
}
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOP
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
const
IMAGE_THUNK_DATA
*
aCachedNtdllThunk
)
{
if
(
!
(
gBlocklistInitFlags
&
eDllBlocklistInitFlagWasBootstrapped
)
)
{
nt
:
:
CrossExecTransferManager
transferMgr
(
aChildProcess
)
;
if
(
!
transferMgr
)
{
return
LAUNCHER_ERROR_FROM_WIN32
(
ERROR_BAD_EXE_FORMAT
)
;
}
return
RestoreImportDirectory
(
aFullImagePath
transferMgr
)
;
}
return
InitializeDllBlocklistOOPInternal
(
aFullImagePath
aChildProcess
aCachedNtdllThunk
)
;
}
LauncherVoidResultWithLineInfo
InitializeDllBlocklistOOPFromLauncher
(
const
wchar_t
*
aFullImagePath
HANDLE
aChildProcess
)
{
return
InitializeDllBlocklistOOPInternal
(
aFullImagePath
aChildProcess
nullptr
)
;
}
#
endif
}
