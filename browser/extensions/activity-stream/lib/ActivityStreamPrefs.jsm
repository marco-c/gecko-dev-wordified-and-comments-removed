"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Preferences
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
ACTIVITY_STREAM_PREF_BRANCH
=
"
browser
.
newtabpage
.
activity
-
stream
.
"
;
this
.
Prefs
=
class
Prefs
extends
Preferences
{
constructor
(
branch
=
ACTIVITY_STREAM_PREF_BRANCH
)
{
super
(
{
branch
}
)
;
this
.
_branchName
=
branch
;
this
.
_branchObservers
=
new
Map
(
)
;
}
get
branchName
(
)
{
return
this
.
_branchName
;
}
ignoreBranch
(
listener
)
{
const
observer
=
this
.
_branchObservers
.
get
(
listener
)
;
this
.
_prefBranch
.
removeObserver
(
"
"
observer
)
;
this
.
_branchObservers
.
delete
(
listener
)
;
}
observeBranch
(
listener
)
{
const
observer
=
(
subject
topic
pref
)
=
>
{
listener
.
onPrefChanged
(
pref
this
.
get
(
pref
)
)
;
}
;
this
.
_prefBranch
.
addObserver
(
"
"
observer
)
;
this
.
_branchObservers
.
set
(
listener
observer
)
;
}
}
;
this
.
DefaultPrefs
=
class
DefaultPrefs
{
constructor
(
config
branch
=
ACTIVITY_STREAM_PREF_BRANCH
)
{
this
.
_config
=
config
;
this
.
branch
=
Services
.
prefs
.
getDefaultBranch
(
branch
)
;
}
setDefaultPref
(
key
val
)
{
switch
(
typeof
val
)
{
case
"
boolean
"
:
this
.
branch
.
setBoolPref
(
key
val
)
;
break
;
case
"
number
"
:
this
.
branch
.
setIntPref
(
key
val
)
;
break
;
case
"
string
"
:
this
.
branch
.
setStringPref
(
key
val
)
;
break
;
}
}
init
(
)
{
const
IS_UNOFFICIAL_BUILD
=
!
AppConstants
.
MOZILLA_OFFICIAL
;
for
(
const
pref
of
this
.
_config
.
keys
(
)
)
{
const
prefConfig
=
this
.
_config
.
get
(
pref
)
;
let
value
;
if
(
IS_UNOFFICIAL_BUILD
&
&
"
value_local_dev
"
in
prefConfig
)
{
value
=
prefConfig
.
value_local_dev
;
}
else
{
value
=
prefConfig
.
value
;
}
this
.
setDefaultPref
(
pref
value
)
;
}
}
reset
(
)
{
for
(
const
name
of
this
.
_config
.
keys
(
)
)
{
this
.
branch
.
clearUserPref
(
name
)
;
}
}
}
;
const
EXPORTED_SYMBOLS
=
[
"
DefaultPrefs
"
"
Prefs
"
]
;
