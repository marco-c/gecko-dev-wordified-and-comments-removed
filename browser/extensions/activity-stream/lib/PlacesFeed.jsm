"
use
strict
"
;
const
{
utils
:
Cu
interfaces
:
Ci
}
=
Components
;
const
{
actionTypes
:
at
actionCreators
:
ac
}
=
Cu
.
import
(
"
resource
:
/
/
activity
-
stream
/
common
/
Actions
.
jsm
"
{
}
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
NewTabUtils
"
"
resource
:
/
/
gre
/
modules
/
NewTabUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
PlacesUtils
"
"
resource
:
/
/
gre
/
modules
/
PlacesUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
Services
"
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
LINK_BLOCKED_EVENT
=
"
newtab
-
linkBlocked
"
;
class
Observer
{
constructor
(
dispatch
observerInterface
)
{
this
.
dispatch
=
dispatch
;
this
.
QueryInterface
=
XPCOMUtils
.
generateQI
(
[
observerInterface
Ci
.
nsISupportsWeakReference
]
)
;
}
}
class
HistoryObserver
extends
Observer
{
constructor
(
dispatch
)
{
super
(
dispatch
Ci
.
nsINavHistoryObserver
)
;
}
onDeleteURI
(
uri
)
{
this
.
dispatch
(
{
type
:
at
.
PLACES_LINK_DELETED
data
:
{
url
:
uri
.
spec
}
}
)
;
}
onClearHistory
(
)
{
this
.
dispatch
(
{
type
:
at
.
PLACES_HISTORY_CLEARED
}
)
;
}
}
class
BookmarksObserver
extends
Observer
{
constructor
(
dispatch
)
{
super
(
dispatch
Ci
.
nsINavBookmarkObserver
)
;
}
async
onItemAdded
(
.
.
.
args
)
{
const
type
=
args
[
3
]
;
const
guid
=
args
[
7
]
;
if
(
type
!
=
=
PlacesUtils
.
bookmarks
.
TYPE_BOOKMARK
)
{
return
;
}
try
{
const
bookmark
=
await
NewTabUtils
.
activityStreamProvider
.
getBookmark
(
guid
)
;
this
.
dispatch
(
{
type
:
at
.
PLACES_BOOKMARK_ADDED
data
:
bookmark
}
)
;
}
catch
(
e
)
{
Cu
.
reportError
(
e
)
;
}
}
onItemRemoved
(
id
folderId
index
type
uri
guid
)
{
if
(
type
=
=
=
PlacesUtils
.
bookmarks
.
TYPE_BOOKMARK
)
{
this
.
dispatch
(
{
type
:
at
.
PLACES_BOOKMARK_REMOVED
data
:
{
url
:
uri
.
spec
bookmarkGuid
:
guid
}
}
)
;
}
}
async
onItemChanged
(
.
.
.
args
)
{
const
property
=
args
[
1
]
;
const
type
=
args
[
5
]
;
const
guid
=
args
[
7
]
;
if
(
type
!
=
=
PlacesUtils
.
bookmarks
.
TYPE_BOOKMARK
|
|
!
[
"
uri
"
"
title
"
]
.
includes
(
property
)
)
{
return
;
}
try
{
const
bookmark
=
await
NewTabUtils
.
activityStreamProvider
.
getBookmark
(
guid
)
;
this
.
dispatch
(
{
type
:
at
.
PLACES_BOOKMARK_CHANGED
data
:
bookmark
}
)
;
}
catch
(
e
)
{
Cu
.
reportError
(
e
)
;
}
}
}
class
PlacesFeed
{
constructor
(
)
{
this
.
historyObserver
=
new
HistoryObserver
(
action
=
>
this
.
store
.
dispatch
(
ac
.
BroadcastToContent
(
action
)
)
)
;
this
.
bookmarksObserver
=
new
BookmarksObserver
(
action
=
>
this
.
store
.
dispatch
(
ac
.
BroadcastToContent
(
action
)
)
)
;
}
addObservers
(
)
{
PlacesUtils
.
history
.
addObserver
(
this
.
historyObserver
true
)
;
PlacesUtils
.
bookmarks
.
addObserver
(
this
.
bookmarksObserver
true
)
;
Services
.
obs
.
addObserver
(
this
LINK_BLOCKED_EVENT
)
;
}
removeObservers
(
)
{
PlacesUtils
.
history
.
removeObserver
(
this
.
historyObserver
)
;
PlacesUtils
.
bookmarks
.
removeObserver
(
this
.
bookmarksObserver
)
;
Services
.
obs
.
removeObserver
(
this
LINK_BLOCKED_EVENT
)
;
}
observe
(
subject
topic
value
)
{
if
(
topic
=
=
=
LINK_BLOCKED_EVENT
)
{
this
.
store
.
dispatch
(
ac
.
BroadcastToContent
(
{
type
:
at
.
PLACES_LINK_BLOCKED
data
:
{
url
:
value
}
}
)
)
;
}
}
onAction
(
action
)
{
switch
(
action
.
type
)
{
case
at
.
INIT
:
this
.
addObservers
(
)
;
break
;
case
at
.
UNINIT
:
this
.
removeObservers
(
)
;
break
;
case
at
.
BLOCK_URL
:
NewTabUtils
.
activityStreamLinks
.
blockURL
(
{
url
:
action
.
data
}
)
;
break
;
case
at
.
BOOKMARK_URL
:
NewTabUtils
.
activityStreamLinks
.
addBookmark
(
action
.
data
)
;
break
;
case
at
.
DELETE_BOOKMARK_BY_ID
:
NewTabUtils
.
activityStreamLinks
.
deleteBookmark
(
action
.
data
)
;
break
;
case
at
.
DELETE_HISTORY_URL
:
NewTabUtils
.
activityStreamLinks
.
deleteHistoryEntry
(
action
.
data
)
;
break
;
}
}
}
this
.
PlacesFeed
=
PlacesFeed
;
PlacesFeed
.
HistoryObserver
=
HistoryObserver
;
PlacesFeed
.
BookmarksObserver
=
BookmarksObserver
;
this
.
EXPORTED_SYMBOLS
=
[
"
PlacesFeed
"
]
;
