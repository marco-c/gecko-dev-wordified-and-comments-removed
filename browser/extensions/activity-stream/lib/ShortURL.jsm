const
{
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
IDNService
"
"
mozilla
.
org
/
network
/
idn
-
service
;
1
"
"
nsIIDNService
"
)
;
Cu
.
importGlobalProperties
(
[
"
URL
"
]
)
;
function
handleIDNHost
(
hostname
)
{
try
{
return
IDNService
.
convertToDisplayIDN
(
hostname
{
}
)
;
}
catch
(
e
)
{
return
hostname
;
}
}
function
getETLD
(
url
)
{
try
{
return
Services
.
eTLD
.
getPublicSuffix
(
Services
.
io
.
newURI
(
url
)
)
;
}
catch
(
err
)
{
return
"
"
;
}
}
this
.
getETLD
=
getETLD
;
this
.
shortURL
=
function
shortURL
(
link
)
{
if
(
!
link
.
url
)
{
return
"
"
;
}
const
eTLD
=
getETLD
(
link
.
url
)
;
const
eTLDExtra
=
eTLD
.
length
>
0
?
-
(
eTLD
.
length
+
1
)
:
Infinity
;
const
hostname
=
(
new
URL
(
link
.
url
)
.
hostname
)
.
replace
(
/
^
www
\
.
/
i
"
"
)
;
return
handleIDNHost
(
hostname
.
slice
(
0
eTLDExtra
)
.
toLowerCase
(
)
)
|
|
link
.
title
|
|
link
.
url
;
}
;
this
.
EXPORTED_SYMBOLS
=
[
"
shortURL
"
"
getETLD
"
]
;
