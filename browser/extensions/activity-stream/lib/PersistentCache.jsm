"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
OS
"
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
gTextDecoder
"
(
)
=
>
new
TextDecoder
(
)
)
;
this
.
PersistentCache
=
class
PersistentCache
{
constructor
(
name
preload
=
false
)
{
this
.
name
=
name
;
this
.
_filename
=
activity
-
stream
.
{
name
}
.
json
;
if
(
preload
)
{
this
.
_load
(
)
;
}
}
async
set
(
key
value
)
{
const
data
=
await
this
.
_load
(
)
;
data
[
key
]
=
value
;
this
.
_persist
(
data
)
;
}
async
get
(
key
)
{
const
data
=
await
this
.
_load
(
)
;
return
key
?
data
[
key
]
:
data
;
}
_load
(
)
{
return
this
.
_cache
|
|
(
this
.
_cache
=
new
Promise
(
async
resolve
=
>
{
let
data
=
{
}
;
try
{
const
filepath
=
OS
.
Path
.
join
(
OS
.
Constants
.
Path
.
localProfileDir
this
.
_filename
)
;
const
fileExists
=
await
OS
.
File
.
exists
(
filepath
)
;
if
(
fileExists
)
{
const
binaryData
=
await
OS
.
File
.
read
(
filepath
)
;
const
json
=
gTextDecoder
.
decode
(
binaryData
)
;
data
=
JSON
.
parse
(
json
)
;
}
}
catch
(
error
)
{
Cu
.
reportError
(
Failed
to
load
{
this
.
_filename
}
:
{
error
.
message
}
)
;
}
resolve
(
data
)
;
}
)
)
;
}
_persist
(
data
)
{
const
filepath
=
OS
.
Path
.
join
(
OS
.
Constants
.
Path
.
localProfileDir
this
.
_filename
)
;
OS
.
File
.
writeAtomic
(
filepath
JSON
.
stringify
(
data
)
{
tmpPath
:
{
filepath
}
.
tmp
}
)
;
}
}
;
const
EXPORTED_SYMBOLS
=
[
"
PersistentCache
"
]
;
