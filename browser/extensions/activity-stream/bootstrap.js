"
use
strict
"
;
const
{
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Preferences
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
ActivityStream
"
"
resource
:
/
/
activity
-
stream
/
lib
/
ActivityStream
.
jsm
"
)
;
const
BROWSER_READY_NOTIFICATION
=
"
browser
-
ui
-
startup
-
complete
"
;
const
ACTIVITY_STREAM_ENABLED_PREF
=
"
browser
.
newtabpage
.
activity
-
stream
.
enabled
"
;
const
REASON_STARTUP_ON_PREF_CHANGE
=
"
PREF_ON
"
;
const
REASON_SHUTDOWN_ON_PREF_CHANGE
=
"
PREF_OFF
"
;
const
ACTIVITY_STREAM_OPTIONS
=
{
newTabURL
:
"
about
:
newtab
"
}
;
let
activityStream
;
let
startupData
;
let
startupReason
;
function
init
(
reason
)
{
if
(
activityStream
&
&
activityStream
.
initialized
)
{
return
;
}
const
options
=
Object
.
assign
(
{
}
startupData
|
|
{
}
ACTIVITY_STREAM_OPTIONS
)
;
activityStream
=
new
ActivityStream
(
options
)
;
activityStream
.
init
(
reason
)
;
}
function
uninit
(
reason
)
{
if
(
activityStream
)
{
activityStream
.
uninit
(
reason
)
;
activityStream
=
null
;
}
}
function
onPrefChanged
(
isEnabled
)
{
if
(
isEnabled
)
{
init
(
REASON_STARTUP_ON_PREF_CHANGE
)
;
}
else
{
uninit
(
REASON_SHUTDOWN_ON_PREF_CHANGE
)
;
}
}
function
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
BROWSER_READY_NOTIFICATION
:
Preferences
.
observe
(
ACTIVITY_STREAM_ENABLED_PREF
onPrefChanged
)
;
if
(
Preferences
.
get
(
ACTIVITY_STREAM_ENABLED_PREF
)
)
{
init
(
startupReason
)
;
Services
.
obs
.
removeObserver
(
this
BROWSER_READY_NOTIFICATION
)
;
}
break
;
}
}
this
.
install
=
function
install
(
data
reason
)
{
}
;
this
.
startup
=
function
startup
(
data
reason
)
{
Services
.
obs
.
addObserver
(
observe
BROWSER_READY_NOTIFICATION
)
;
startupData
=
data
;
startupReason
=
reason
;
}
;
this
.
shutdown
=
function
shutdown
(
data
reason
)
{
startupData
=
null
;
startupReason
=
null
;
uninit
(
reason
)
;
Preferences
.
ignore
(
ACTIVITY_STREAM_ENABLED_PREF
onPrefChanged
)
;
}
;
this
.
uninstall
=
function
uninstall
(
data
reason
)
{
}
;
