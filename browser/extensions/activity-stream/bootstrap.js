"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyGlobalGetters
(
this
[
"
fetch
"
]
)
;
ChromeUtils
.
defineModuleGetter
(
this
"
Services
"
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
resProto
"
"
mozilla
.
org
/
network
/
protocol
;
1
?
name
=
resource
"
"
nsISubstitutingProtocolHandler
"
)
;
const
RESOURCE_HOST
=
"
activity
-
stream
"
;
const
BROWSER_READY_NOTIFICATION
=
"
sessionstore
-
windows
-
restored
"
;
const
RESOURCE_BASE
=
"
resource
:
/
/
activity
-
stream
"
;
const
ACTIVITY_STREAM_OPTIONS
=
{
newTabURL
:
"
about
:
newtab
"
}
;
let
activityStream
;
let
modulesToUnload
=
new
Set
(
)
;
let
startupData
;
let
startupReason
;
let
waitingForBrowserReady
=
true
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
ActivityStream
"
"
resource
:
/
/
activity
-
stream
/
lib
/
ActivityStream
.
jsm
"
null
null
(
)
=
>
{
const
processListing
=
async
(
uri
cb
)
=
>
{
try
{
(
await
(
await
fetch
(
uri
)
)
.
text
(
)
)
.
split
(
"
\
n
"
)
.
slice
(
2
)
.
forEach
(
line
=
>
cb
(
line
.
split
(
"
"
)
.
slice
(
1
)
)
)
;
}
catch
(
e
)
{
}
}
;
processListing
(
RESOURCE_BASE
(
[
directory
type
]
)
=
>
{
if
(
type
=
=
=
"
DIRECTORY
"
)
{
const
subDir
=
{
RESOURCE_BASE
}
/
{
directory
}
;
processListing
(
subDir
(
[
name
]
)
=
>
{
if
(
name
&
&
name
.
search
(
/
\
.
jsm
/
)
!
=
=
-
1
)
{
modulesToUnload
.
add
(
{
subDir
}
/
{
name
}
)
;
}
}
)
;
}
}
)
;
}
)
;
function
init
(
reason
)
{
if
(
activityStream
&
&
activityStream
.
initialized
)
{
return
;
}
const
options
=
Object
.
assign
(
{
}
startupData
|
|
{
}
ACTIVITY_STREAM_OPTIONS
)
;
activityStream
=
new
ActivityStream
(
options
)
;
try
{
activityStream
.
init
(
reason
)
;
}
catch
(
e
)
{
Cu
.
reportError
(
e
)
;
}
}
function
uninit
(
reason
)
{
if
(
activityStream
)
{
activityStream
.
uninit
(
reason
)
;
activityStream
=
null
;
}
}
function
migratePref
(
oldPrefName
cbIfNotDefault
)
{
if
(
!
Services
.
prefs
.
prefHasUserValue
(
oldPrefName
)
)
{
return
;
}
let
prefGetter
;
switch
(
Services
.
prefs
.
getPrefType
(
oldPrefName
)
)
{
case
Services
.
prefs
.
PREF_BOOL
:
prefGetter
=
"
getBoolPref
"
;
break
;
case
Services
.
prefs
.
PREF_INT
:
prefGetter
=
"
getIntPref
"
;
break
;
case
Services
.
prefs
.
PREF_STRING
:
prefGetter
=
"
getStringPref
"
;
break
;
}
cbIfNotDefault
(
Services
.
prefs
[
prefGetter
]
(
oldPrefName
)
)
;
Services
.
prefs
.
clearUserPref
(
oldPrefName
)
;
}
function
onBrowserReady
(
)
{
waitingForBrowserReady
=
false
;
init
(
startupReason
)
;
migratePref
(
"
browser
.
newtabpage
.
rows
"
rows
=
>
{
if
(
rows
<
=
0
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
topsites
"
false
)
;
}
else
{
Services
.
prefs
.
setIntPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
topSitesRows
"
rows
)
;
}
}
)
;
migratePref
(
"
browser
.
newtabpage
.
activity
-
stream
.
showTopSites
"
value
=
>
{
if
(
value
=
=
=
false
)
{
Services
.
prefs
.
setBoolPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
feeds
.
topsites
"
false
)
;
}
}
)
;
migratePref
(
"
browser
.
newtabpage
.
activity
-
stream
.
topSitesCount
"
count
=
>
{
Services
.
prefs
.
setIntPref
(
"
browser
.
newtabpage
.
activity
-
stream
.
topSitesRows
"
Math
.
ceil
(
count
/
6
)
)
;
}
)
;
}
function
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
BROWSER_READY_NOTIFICATION
:
Services
.
obs
.
removeObserver
(
observe
BROWSER_READY_NOTIFICATION
)
;
Services
.
tm
.
dispatchToMainThread
(
(
)
=
>
onBrowserReady
(
)
)
;
break
;
}
}
this
.
install
=
function
install
(
data
reason
)
{
}
;
this
.
startup
=
function
startup
(
data
reason
)
{
resProto
.
setSubstitutionWithFlags
(
RESOURCE_HOST
Services
.
io
.
newURI
(
"
chrome
/
content
/
"
null
data
.
resourceURI
)
resProto
.
ALLOW_CONTENT_ACCESS
)
;
startupData
=
data
;
startupReason
=
reason
;
if
(
Services
.
startup
.
startingUp
)
{
Services
.
obs
.
addObserver
(
observe
BROWSER_READY_NOTIFICATION
)
;
}
else
{
onBrowserReady
(
)
;
}
}
;
this
.
shutdown
=
function
shutdown
(
data
reason
)
{
resProto
.
setSubstitution
(
RESOURCE_HOST
null
)
;
startupData
=
null
;
startupReason
=
null
;
uninit
(
reason
)
;
if
(
waitingForBrowserReady
)
{
Services
.
obs
.
removeObserver
(
observe
BROWSER_READY_NOTIFICATION
)
;
}
modulesToUnload
.
forEach
(
Cu
.
unload
)
;
}
;
this
.
uninstall
=
function
uninstall
(
data
reason
)
{
if
(
activityStream
)
{
activityStream
.
uninstall
(
reason
)
;
activityStream
=
null
;
}
}
;
