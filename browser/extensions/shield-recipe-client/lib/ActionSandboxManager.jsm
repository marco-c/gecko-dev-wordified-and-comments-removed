"
use
strict
"
;
const
{
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
shield
-
recipe
-
client
/
lib
/
NormandyDriver
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
shield
-
recipe
-
client
/
lib
/
SandboxManager
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
shield
-
recipe
-
client
/
lib
/
LogManager
.
jsm
"
)
;
this
.
EXPORTED_SYMBOLS
=
[
"
ActionSandboxManager
"
]
;
const
log
=
LogManager
.
getLogger
(
"
recipe
-
sandbox
-
manager
"
)
;
this
.
ActionSandboxManager
=
class
extends
SandboxManager
{
constructor
(
actionScript
)
{
super
(
)
;
const
driver
=
new
NormandyDriver
(
this
)
;
this
.
cloneIntoGlobal
(
"
sandboxedDriver
"
driver
{
cloneFunctions
:
true
}
)
;
this
.
evalInSandbox
(
/
/
Shim
old
API
for
registering
actions
function
registerAction
(
name
Action
)
{
registerAsyncCallback
(
"
action
"
(
driver
recipe
)
=
>
{
return
new
Action
(
driver
recipe
)
.
execute
(
)
;
}
)
;
}
;
this
.
asyncCallbacks
=
new
Map
(
)
;
function
registerAsyncCallback
(
name
callback
)
{
asyncCallbacks
.
set
(
name
callback
)
;
}
this
.
window
=
this
;
this
.
setTimeout
=
sandboxedDriver
.
setTimeout
;
this
.
clearTimeout
=
sandboxedDriver
.
clearTimeout
;
)
;
this
.
evalInSandbox
(
actionScript
)
;
}
async
runAsyncCallback
(
callbackName
.
.
.
args
)
{
const
callbackWasRegistered
=
this
.
evalInSandbox
(
asyncCallbacks
.
has
(
"
{
callbackName
}
"
)
)
;
if
(
!
callbackWasRegistered
)
{
log
.
debug
(
Script
did
not
register
a
callback
with
the
name
"
{
callbackName
}
"
)
;
return
undefined
;
}
this
.
cloneIntoGlobal
(
"
callbackArgs
"
args
)
;
const
result
=
await
this
.
evalInSandbox
(
asyncCallbacks
.
get
(
"
{
callbackName
}
"
)
(
sandboxedDriver
.
.
.
callbackArgs
)
;
)
;
return
Cu
.
cloneInto
(
result
{
}
)
;
}
}
;
