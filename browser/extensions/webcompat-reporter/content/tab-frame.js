const
TABDATA_MESSAGE
=
"
WebCompat
:
SendTabData
"
;
let
getScreenshot
=
function
(
win
)
{
return
new
Promise
(
resolve
=
>
{
let
url
=
win
.
location
.
href
;
try
{
let
dpr
=
win
.
devicePixelRatio
;
let
canvas
=
win
.
document
.
createElement
(
"
canvas
"
)
;
let
ctx
=
canvas
.
getContext
(
"
2d
"
)
;
let
x
=
win
.
document
.
documentElement
.
scrollLeft
;
let
y
=
win
.
document
.
documentElement
.
scrollTop
;
let
w
=
win
.
innerWidth
;
let
h
=
win
.
innerHeight
;
canvas
.
width
=
dpr
*
w
;
canvas
.
height
=
dpr
*
h
;
ctx
.
scale
(
dpr
dpr
)
;
ctx
.
drawWindow
(
win
x
y
w
h
"
#
fff
"
)
;
canvas
.
toBlob
(
blob
=
>
{
resolve
(
{
url
blob
}
)
;
}
)
;
}
catch
(
ex
)
{
Cu
.
reportError
(
WebCompatReporter
:
getting
a
screenshot
failed
:
{
ex
}
)
;
resolve
(
{
url
}
)
;
}
}
)
;
}
;
getScreenshot
(
content
)
.
then
(
data
=
>
sendAsyncMessage
(
TABDATA_MESSAGE
data
)
)
;
