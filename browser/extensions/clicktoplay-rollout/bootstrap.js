"
use
strict
"
;
const
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
UpdateUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
TelemetryEnvironment
.
jsm
"
)
;
const
TEST_THRESHOLD
=
{
"
beta
"
:
0
.
5
"
release
"
:
0
.
05
}
;
if
(
AppConstants
.
RELEASE_OR_BETA
)
{
TEST_THRESHOLD
.
default
=
TEST_THRESHOLD
.
release
;
}
const
PREF_COHORT_SAMPLE
=
"
plugins
.
ctprollout
.
cohortSample
"
;
const
PREF_COHORT_NAME
=
"
plugins
.
ctprollout
.
cohort
"
;
const
PREF_FLASH_STATE
=
"
plugin
.
state
.
flash
"
;
function
startup
(
)
{
defineCohort
(
)
;
}
function
defineCohort
(
)
{
let
updateChannel
=
UpdateUtils
.
getUpdateChannel
(
false
)
;
if
(
!
(
updateChannel
in
TEST_THRESHOLD
)
)
{
return
;
}
let
cohort
=
Services
.
prefs
.
getStringPref
(
PREF_COHORT_NAME
)
;
if
(
!
cohort
)
{
let
currentPluginState
=
Services
.
prefs
.
getIntPref
(
PREF_FLASH_STATE
)
;
switch
(
currentPluginState
)
{
case
Ci
.
nsIPluginTag
.
STATE_CLICKTOPLAY
:
cohort
=
"
early
-
adopter
-
ctp
"
;
break
;
case
Ci
.
nsIPluginTag
.
STATE_DISABLED
:
cohort
=
"
early
-
adopter
-
disabled
"
;
break
;
default
:
break
;
}
}
switch
(
cohort
)
{
case
undefined
:
case
"
test
"
:
case
"
control
"
:
{
let
testThreshold
=
TEST_THRESHOLD
[
updateChannel
]
;
let
userSample
=
getUserSample
(
)
;
if
(
userSample
<
testThreshold
)
{
cohort
=
"
test
"
;
let
defaultPrefs
=
Services
.
prefs
.
getDefaultBranch
(
"
"
)
;
defaultPrefs
.
setIntPref
(
PREF_FLASH_STATE
Ci
.
nsIPluginTag
.
STATE_CLICKTOPLAY
)
;
}
else
if
(
userSample
>
=
1
.
0
-
testThreshold
)
{
cohort
=
"
control
"
;
}
else
{
cohort
=
"
excluded
"
;
}
setCohort
(
cohort
)
;
watchForPrefChanges
(
)
;
break
;
}
case
"
early
-
adopter
-
ctp
"
:
case
"
early
-
adopter
-
disabled
"
:
default
:
setCohort
(
cohort
)
;
break
;
}
}
function
getUserSample
(
)
{
let
prefType
=
Services
.
prefs
.
getPrefType
(
PREF_COHORT_SAMPLE
)
;
if
(
prefType
=
=
Ci
.
nsIPrefBranch
.
PREF_STRING
)
{
return
parseFloat
(
Services
.
prefs
.
getStringPref
(
PREF_COHORT_SAMPLE
)
10
)
;
}
let
value
=
Math
.
random
(
)
;
Services
.
prefs
.
setStringPref
(
PREF_COHORT_SAMPLE
value
.
toString
(
)
.
substr
(
0
8
)
)
;
return
value
;
}
function
setCohort
(
cohortName
)
{
Services
.
prefs
.
setStringPref
(
PREF_COHORT_NAME
cohortName
)
;
TelemetryEnvironment
.
setExperimentActive
(
"
clicktoplay
-
rollout
"
cohortName
)
;
try
{
if
(
Ci
.
nsICrashReporter
)
{
Services
.
appinfo
.
QueryInterface
(
Ci
.
nsICrashReporter
)
.
annotateCrashReport
(
"
CTPCohort
"
cohortName
)
;
}
}
catch
(
e
)
{
}
}
function
watchForPrefChanges
(
)
{
Services
.
prefs
.
addObserver
(
PREF_FLASH_STATE
function
prefWatcher
(
)
{
let
currentCohort
=
Services
.
prefs
.
getStringPref
(
PREF_COHORT_NAME
"
unknown
"
)
;
setCohort
(
user
-
changed
-
from
-
{
currentCohort
}
)
;
Services
.
prefs
.
removeObserver
(
PREF_FLASH_STATE
prefWatcher
)
;
}
)
;
}
function
install
(
)
{
}
function
shutdown
(
data
reason
)
{
}
function
uninstall
(
)
{
}
