"
use
strict
"
;
const
GLOBAL_CANARY
=
"
use
-
application
-
dns
.
net
"
;
const
NXDOMAIN_ERR
=
"
NS_ERROR_UNKNOWN_HOST
"
;
async
function
dnsLookup
(
hostname
)
{
let
flags
=
[
"
disable_trr
"
"
disable_ipv6
"
"
bypass_cache
"
]
;
let
addresses
err
;
try
{
let
response
=
await
browser
.
dns
.
resolve
(
hostname
flags
)
;
addresses
=
response
.
addresses
;
}
catch
(
e
)
{
addresses
=
[
null
]
;
err
=
e
.
message
;
}
return
{
addresses
err
}
;
}
async
function
dnsListLookup
(
domainList
)
{
let
results
=
[
]
;
for
(
let
domain
of
domainList
)
{
let
{
addresses
}
=
await
dnsLookup
(
domain
)
;
results
=
results
.
concat
(
addresses
)
;
}
return
results
;
}
async
function
safeSearch
(
)
{
const
providerList
=
[
{
name
:
"
google
"
unfiltered
:
[
"
www
.
google
.
com
"
"
google
.
com
"
]
safeSearch
:
[
"
forcesafesearch
.
google
.
com
"
]
}
{
name
:
"
youtube
"
unfiltered
:
[
"
www
.
youtube
.
com
"
"
m
.
youtube
.
com
"
"
youtubei
.
googleapis
.
com
"
"
youtube
.
googleapis
.
com
"
"
www
.
youtube
-
nocookie
.
com
"
]
safeSearch
:
[
"
restrict
.
youtube
.
com
"
"
restrictmoderate
.
youtube
.
com
"
]
}
]
;
let
safeSearchChecks
=
{
}
;
for
(
let
provider
of
providerList
)
{
let
providerName
=
provider
.
name
;
safeSearchChecks
[
providerName
]
=
"
enable_doh
"
;
let
results
=
{
}
;
results
.
unfilteredAnswers
=
await
dnsListLookup
(
provider
.
unfiltered
)
;
results
.
safeSearchAnswers
=
await
dnsListLookup
(
provider
.
safeSearch
)
;
for
(
let
answer
of
results
.
safeSearchAnswers
)
{
if
(
answer
&
&
results
.
unfilteredAnswers
.
includes
(
answer
)
)
{
safeSearchChecks
[
providerName
]
=
"
disable_doh
"
;
}
}
}
return
safeSearchChecks
;
}
async
function
zscalerCanary
(
)
{
const
ZSCALER_CANARY
=
"
sitereview
.
zscaler
.
com
"
;
let
{
addresses
}
=
await
dnsLookup
(
ZSCALER_CANARY
)
;
for
(
let
address
of
addresses
)
{
if
(
[
"
213
.
152
.
228
.
242
"
"
199
.
168
.
151
.
251
"
"
8
.
25
.
203
.
30
"
]
.
includes
(
address
)
)
{
return
"
disable_doh
"
;
}
}
return
"
enable_doh
"
;
}
async
function
globalCanary
(
)
{
let
{
addresses
err
}
=
await
dnsLookup
(
GLOBAL_CANARY
)
;
if
(
err
=
=
=
NXDOMAIN_ERR
|
|
!
addresses
.
length
)
{
return
"
disable_doh
"
;
}
return
"
enable_doh
"
;
}
async
function
modifiedRoots
(
)
{
let
rootsEnabled
=
await
browser
.
experiments
.
preferences
.
getBoolPref
(
"
security
.
enterprise_roots
.
enabled
"
false
)
;
if
(
rootsEnabled
)
{
return
"
disable_doh
"
;
}
return
"
enable_doh
"
;
}
async
function
runHeuristics
(
)
{
let
safeSearchChecks
=
await
safeSearch
(
)
;
let
zscalerCheck
=
await
zscalerCanary
(
)
;
let
canaryCheck
=
await
globalCanary
(
)
;
let
modifiedRootsCheck
=
await
modifiedRoots
(
)
;
let
browserParentCheck
=
await
browser
.
experiments
.
heuristics
.
checkParentalControls
(
)
;
let
enterpriseCheck
=
await
browser
.
experiments
.
heuristics
.
checkEnterprisePolicies
(
)
;
let
thirdPartyRootsCheck
=
await
browser
.
experiments
.
heuristics
.
checkThirdPartyRoots
(
)
;
return
{
google
:
safeSearchChecks
.
google
youtube
:
safeSearchChecks
.
youtube
zscalerCanary
:
zscalerCheck
canary
:
canaryCheck
modifiedRoots
:
modifiedRootsCheck
browserParent
:
browserParentCheck
thirdPartyRoots
:
thirdPartyRootsCheck
policy
:
enterpriseCheck
}
;
}
