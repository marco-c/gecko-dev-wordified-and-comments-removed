"
use
strict
"
;
const
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
results
:
Cr
}
=
Components
;
const
EDIT_PROFILE_URL
=
"
chrome
:
/
/
formautofill
/
content
/
editProfile
.
xhtml
"
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
formautofill
/
FormAutofillUtils
.
jsm
"
)
;
this
.
log
=
null
;
FormAutofillUtils
.
defineLazyLogGetter
(
this
"
manageProfiles
"
)
;
function
ManageProfileDialog
(
)
{
window
.
addEventListener
(
"
DOMContentLoaded
"
this
{
once
:
true
}
)
;
}
ManageProfileDialog
.
prototype
=
{
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsISupports
Ci
.
nsIObserver
]
)
_elements
:
{
}
_pendingChangeCount
:
0
get
_selectedOptions
(
)
{
return
Array
.
from
(
this
.
_elements
.
profiles
.
selectedOptions
)
;
}
init
(
)
{
this
.
_elements
=
{
profiles
:
document
.
getElementById
(
"
profiles
"
)
controlsContainer
:
document
.
getElementById
(
"
controls
-
container
"
)
remove
:
document
.
getElementById
(
"
remove
"
)
add
:
document
.
getElementById
(
"
add
"
)
edit
:
document
.
getElementById
(
"
edit
"
)
}
;
this
.
attachEventListeners
(
)
;
}
uninit
(
)
{
log
.
debug
(
"
uninit
"
)
;
this
.
detachEventListeners
(
)
;
this
.
_elements
=
null
;
}
loadProfiles
(
)
{
return
this
.
getProfiles
(
)
.
then
(
profiles
=
>
{
log
.
debug
(
"
profiles
:
"
profiles
)
;
profiles
.
sort
(
(
a
b
)
=
>
b
.
timeLastModified
-
a
.
timeLastModified
)
;
this
.
renderProfileElements
(
profiles
)
;
this
.
updateButtonsStates
(
this
.
_selectedOptions
.
length
)
;
}
)
;
}
getProfiles
(
)
{
return
new
Promise
(
resolve
=
>
{
Services
.
cpmm
.
addMessageListener
(
"
FormAutofill
:
Profiles
"
function
getResult
(
result
)
{
Services
.
cpmm
.
removeMessageListener
(
"
FormAutofill
:
Profiles
"
getResult
)
;
resolve
(
result
.
data
)
;
}
)
;
Services
.
cpmm
.
sendAsyncMessage
(
"
FormAutofill
:
GetProfiles
"
{
}
)
;
}
)
;
}
renderProfileElements
(
profiles
)
{
let
selectedGuids
=
this
.
_selectedOptions
.
map
(
option
=
>
option
.
value
)
;
this
.
clearProfileElements
(
)
;
for
(
let
profile
of
profiles
)
{
let
option
=
new
Option
(
this
.
getProfileLabel
(
profile
)
profile
.
guid
false
selectedGuids
.
includes
(
profile
.
guid
)
)
;
option
.
profile
=
profile
;
this
.
_elements
.
profiles
.
appendChild
(
option
)
;
}
}
clearProfileElements
(
)
{
let
parent
=
this
.
_elements
.
profiles
;
while
(
parent
.
lastChild
)
{
parent
.
removeChild
(
parent
.
lastChild
)
;
}
}
removeProfiles
(
guids
)
{
this
.
_pendingChangeCount
+
=
guids
.
length
-
1
;
Services
.
cpmm
.
sendAsyncMessage
(
"
FormAutofill
:
RemoveProfiles
"
{
guids
}
)
;
}
getProfileLabel
(
profile
)
{
const
fieldOrder
=
[
"
name
"
"
street
-
address
"
"
address
-
level2
"
"
organization
"
"
address
-
level1
"
"
country
"
"
postal
-
code
"
"
tel
"
"
email
"
]
;
let
parts
=
[
]
;
for
(
const
fieldName
of
fieldOrder
)
{
let
string
=
profile
[
fieldName
]
;
if
(
string
)
{
parts
.
push
(
string
)
;
}
if
(
parts
.
length
=
=
2
)
{
break
;
}
}
return
parts
.
join
(
"
"
)
;
}
openEditDialog
(
profile
)
{
window
.
openDialog
(
EDIT_PROFILE_URL
null
"
chrome
centerscreen
modal
width
=
600
height
=
450
"
profile
)
;
}
updateButtonsStates
(
selectedCount
)
{
log
.
debug
(
"
updateButtonsStates
:
"
selectedCount
)
;
if
(
selectedCount
=
=
0
)
{
this
.
_elements
.
edit
.
setAttribute
(
"
disabled
"
"
disabled
"
)
;
this
.
_elements
.
remove
.
setAttribute
(
"
disabled
"
"
disabled
"
)
;
}
else
if
(
selectedCount
=
=
1
)
{
this
.
_elements
.
edit
.
removeAttribute
(
"
disabled
"
)
;
this
.
_elements
.
remove
.
removeAttribute
(
"
disabled
"
)
;
}
else
if
(
selectedCount
>
1
)
{
this
.
_elements
.
edit
.
setAttribute
(
"
disabled
"
"
disabled
"
)
;
this
.
_elements
.
remove
.
removeAttribute
(
"
disabled
"
)
;
}
}
handleEvent
(
event
)
{
switch
(
event
.
type
)
{
case
"
DOMContentLoaded
"
:
{
this
.
init
(
)
;
this
.
loadProfiles
(
)
;
break
;
}
case
"
click
"
:
{
this
.
handleClick
(
event
)
;
break
;
}
case
"
change
"
:
{
this
.
updateButtonsStates
(
this
.
_selectedOptions
.
length
)
;
break
;
}
case
"
unload
"
:
{
this
.
uninit
(
)
;
break
;
}
}
}
handleClick
(
event
)
{
if
(
event
.
target
=
=
this
.
_elements
.
remove
)
{
this
.
removeProfiles
(
this
.
_selectedOptions
.
map
(
option
=
>
option
.
value
)
)
;
}
else
if
(
event
.
target
=
=
this
.
_elements
.
add
)
{
this
.
openEditDialog
(
)
;
}
else
if
(
event
.
target
=
=
this
.
_elements
.
edit
)
{
this
.
openEditDialog
(
this
.
_selectedOptions
[
0
]
.
profile
)
;
}
}
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
formautofill
-
storage
-
changed
"
:
{
if
(
this
.
_pendingChangeCount
)
{
this
.
_pendingChangeCount
-
=
1
;
return
;
}
this
.
loadProfiles
(
)
;
}
}
}
attachEventListeners
(
)
{
window
.
addEventListener
(
"
unload
"
this
{
once
:
true
}
)
;
this
.
_elements
.
profiles
.
addEventListener
(
"
change
"
this
)
;
this
.
_elements
.
controlsContainer
.
addEventListener
(
"
click
"
this
)
;
Services
.
obs
.
addObserver
(
this
"
formautofill
-
storage
-
changed
"
)
;
}
detachEventListeners
(
)
{
this
.
_elements
.
profiles
.
removeEventListener
(
"
change
"
this
)
;
this
.
_elements
.
controlsContainer
.
removeEventListener
(
"
click
"
this
)
;
Services
.
obs
.
removeObserver
(
this
"
formautofill
-
storage
-
changed
"
)
;
}
}
;
new
ManageProfileDialog
(
)
;
