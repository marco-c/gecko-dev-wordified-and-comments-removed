"
use
strict
"
;
const
PAGE_URL
=
"
https
:
/
/
example
.
org
/
browser
/
browser
/
extensions
/
formautofill
/
test
/
fixtures
/
autocomplete_multiple_emails_checkout
.
html
"
;
add_task
(
async
function
test_email_field_is_address_dropdown
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rememberSignons
"
true
]
]
}
)
;
await
setStorage
(
TEST_ADDRESS_1
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE_URL
}
async
function
(
browser
)
{
const
focusInput
=
"
#
email
"
;
await
focusAndWaitForFieldsIdentified
(
browser
"
#
given
-
name
"
)
;
await
openPopupOn
(
browser
focusInput
)
;
const
item
=
getDisplayedPopupItems
(
browser
)
[
2
]
;
is
(
item
.
getAttribute
(
"
ac
-
value
"
)
"
Manage
addresses
"
"
Address
popup
should
show
a
valid
email
suggestion
"
)
;
await
closePopup
(
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
test_email_field_shows_login_dropdown_when_no_saved_address
(
)
{
await
removeAllRecords
(
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE_URL
}
async
function
(
browser
)
{
const
focusInput
=
"
#
email
"
;
await
focusAndWaitForFieldsIdentified
(
browser
"
#
given
-
name
"
)
;
await
openPopupOn
(
browser
focusInput
)
;
const
item
=
getDisplayedPopupItems
(
browser
)
[
0
]
;
is
(
item
.
getAttribute
(
"
ac
-
value
"
)
"
Manage
Passwords
"
"
Login
Manager
should
be
shown
"
)
;
await
closePopup
(
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
test_email_field_is_address_dropdown_onfocus
(
)
{
await
removeAllRecords
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
signon
.
rememberSignons
"
true
]
]
}
)
;
await
setStorage
(
TEST_ADDRESS_1
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE_URL
}
async
function
(
browser
)
{
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
{
content
.
document
.
getElementById
(
"
email
"
)
.
focus
(
)
;
}
)
;
await
runAndWaitForAutocompletePopupOpen
(
browser
(
)
=
>
{
}
)
;
const
item
=
getDisplayedPopupItems
(
browser
)
[
2
]
;
is
(
item
.
getAttribute
(
"
ac
-
value
"
)
"
Manage
addresses
"
"
Address
popup
should
show
a
valid
email
suggestion
"
)
;
await
closePopup
(
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
test_email_field_shows_login_dropdown_when_no_saved_address_onfocus
(
)
{
await
removeAllRecords
(
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE_URL
}
async
function
(
browser
)
{
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
{
content
.
document
.
getElementById
(
"
email
"
)
.
focus
(
)
;
}
)
;
await
runAndWaitForAutocompletePopupOpen
(
browser
(
)
=
>
{
}
)
;
const
item
=
getDisplayedPopupItems
(
browser
)
[
0
]
;
is
(
item
.
getAttribute
(
"
ac
-
value
"
)
"
Manage
Passwords
"
"
Login
Manager
should
be
shown
"
)
;
await
closePopup
(
browser
)
;
}
)
;
}
)
;
