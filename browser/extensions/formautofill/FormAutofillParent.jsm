"
use
strict
"
;
const
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
results
:
Cr
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
OS
"
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
ProfileStorage
"
"
resource
:
/
/
formautofill
/
ProfileStorage
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
FormAutofillPreferences
"
"
resource
:
/
/
formautofill
/
FormAutofillPreferences
.
jsm
"
)
;
const
PROFILE_JSON_FILE_NAME
=
"
autofill
-
profiles
.
json
"
;
const
ENABLED_PREF
=
"
browser
.
formautofill
.
enabled
"
;
function
FormAutofillParent
(
)
{
}
FormAutofillParent
.
prototype
=
{
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsISupports
Ci
.
nsIObserver
]
)
_profileStore
:
null
_enabled
:
false
init
(
)
{
let
storePath
=
OS
.
Path
.
join
(
OS
.
Constants
.
Path
.
profileDir
PROFILE_JSON_FILE_NAME
)
;
this
.
_profileStore
=
new
ProfileStorage
(
storePath
)
;
this
.
_profileStore
.
initialize
(
)
;
Services
.
obs
.
addObserver
(
this
"
advanced
-
pane
-
loaded
"
false
)
;
Services
.
prefs
.
addObserver
(
ENABLED_PREF
this
false
)
;
this
.
_enabled
=
this
.
_getStatus
(
)
;
this
.
_onStatusChanged
(
)
;
Services
.
ppmm
.
addMessageListener
(
"
FormAutofill
:
getEnabledStatus
"
this
)
;
}
observe
(
subject
topic
data
)
{
switch
(
topic
)
{
case
"
advanced
-
pane
-
loaded
"
:
{
let
formAutofillPreferences
=
new
FormAutofillPreferences
(
)
;
let
document
=
subject
.
document
;
let
prefGroup
=
formAutofillPreferences
.
init
(
document
)
;
let
parentNode
=
document
.
getElementById
(
"
mainPrefPane
"
)
;
let
insertBeforeNode
=
document
.
getElementById
(
"
locationBarGroup
"
)
;
parentNode
.
insertBefore
(
prefGroup
insertBeforeNode
)
;
break
;
}
case
"
nsPref
:
changed
"
:
{
let
currentStatus
=
this
.
_getStatus
(
)
;
if
(
currentStatus
!
=
=
this
.
_enabled
)
{
this
.
_enabled
=
currentStatus
;
this
.
_onStatusChanged
(
)
;
}
break
;
}
default
:
{
throw
new
Error
(
FormAutofillParent
:
Unexpected
topic
observed
:
{
topic
}
)
;
}
}
}
_onStatusChanged
(
)
{
if
(
this
.
_enabled
)
{
Services
.
ppmm
.
addMessageListener
(
"
FormAutofill
:
PopulateFieldValues
"
this
)
;
Services
.
ppmm
.
addMessageListener
(
"
FormAutofill
:
GetProfiles
"
this
)
;
}
else
{
Services
.
ppmm
.
removeMessageListener
(
"
FormAutofill
:
PopulateFieldValues
"
this
)
;
Services
.
ppmm
.
removeMessageListener
(
"
FormAutofill
:
GetProfiles
"
this
)
;
}
Services
.
ppmm
.
broadcastAsyncMessage
(
"
FormAutofill
:
enabledStatus
"
this
.
_enabled
)
;
}
_getStatus
(
)
{
return
Services
.
prefs
.
getBoolPref
(
ENABLED_PREF
)
;
}
receiveMessage
(
{
name
data
target
}
)
{
switch
(
name
)
{
case
"
FormAutofill
:
PopulateFieldValues
"
:
this
.
_populateFieldValues
(
data
target
)
;
break
;
case
"
FormAutofill
:
GetProfiles
"
:
this
.
_getProfiles
(
data
target
)
;
break
;
case
"
FormAutofill
:
getEnabledStatus
"
:
Services
.
ppmm
.
broadcastAsyncMessage
(
"
FormAutofill
:
enabledStatus
"
this
.
_enabled
)
;
break
;
}
}
getProfileStore
(
)
{
return
this
.
_profileStore
;
}
_uninit
(
)
{
if
(
this
.
_profileStore
)
{
this
.
_profileStore
.
_saveImmediately
(
)
;
this
.
_profileStore
=
null
;
}
Services
.
ppmm
.
removeMessageListener
(
"
FormAutofill
:
PopulateFieldValues
"
this
)
;
Services
.
ppmm
.
removeMessageListener
(
"
FormAutofill
:
GetProfiles
"
this
)
;
Services
.
obs
.
removeObserver
(
this
"
advanced
-
pane
-
loaded
"
)
;
Services
.
prefs
.
removeObserver
(
ENABLED_PREF
this
)
;
}
_populateFieldValues
(
{
guid
fields
}
target
)
{
this
.
_profileStore
.
notifyUsed
(
guid
)
;
this
.
_fillInFields
(
this
.
_profileStore
.
get
(
guid
)
fields
)
;
target
.
sendAsyncMessage
(
"
FormAutofill
:
fillForm
"
{
fields
}
)
;
}
_getProfiles
(
{
searchString
info
}
target
)
{
let
profiles
=
[
]
;
if
(
info
&
&
info
.
fieldName
)
{
profiles
=
this
.
_profileStore
.
getByFilter
(
{
searchString
info
}
)
;
}
else
{
profiles
=
this
.
_profileStore
.
getAll
(
)
;
}
target
.
sendAsyncMessage
(
"
FormAutofill
:
Profiles
"
profiles
)
;
}
_getDataByFieldName
(
profile
fieldName
)
{
return
profile
[
fieldName
]
;
}
_fillInFields
(
profile
fields
)
{
for
(
let
field
of
fields
)
{
let
value
=
this
.
_getDataByFieldName
(
profile
field
.
fieldName
)
;
if
(
value
!
=
=
undefined
)
{
field
.
value
=
value
;
}
}
}
}
;
this
.
EXPORTED_SYMBOLS
=
[
"
FormAutofillParent
"
]
;
