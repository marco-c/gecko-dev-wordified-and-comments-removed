"
use
strict
"
;
this
.
EXPORTED_SYMBOLS
=
[
"
MasterPassword
"
]
;
const
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
results
:
Cr
}
=
Components
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
cryptoSDR
"
"
mozilla
.
org
/
login
-
manager
/
crypto
/
SDR
;
1
"
Ci
.
nsILoginManagerCrypto
)
;
this
.
MasterPassword
=
{
get
_token
(
)
{
let
tokendb
=
Cc
[
"
mozilla
.
org
/
security
/
pk11tokendb
;
1
"
]
.
createInstance
(
Ci
.
nsIPK11TokenDB
)
;
return
tokendb
.
getInternalKeyToken
(
)
;
}
get
isEnabled
(
)
{
return
this
.
_token
.
hasPassword
;
}
get
isLoggedIn
(
)
{
return
Services
.
logins
.
isLoggedIn
;
}
get
isUIBusy
(
)
{
return
Services
.
logins
.
uiBusy
;
}
async
ensureLoggedIn
(
reauth
=
false
)
{
if
(
!
this
.
isEnabled
)
{
return
true
;
}
if
(
this
.
isLoggedIn
&
&
!
reauth
)
{
return
true
;
}
if
(
this
.
isUIBusy
)
{
return
this
.
waitForExistingDialog
(
)
;
}
let
token
=
this
.
_token
;
try
{
token
.
login
(
true
)
;
}
catch
(
e
)
{
}
if
(
token
.
isLoggedIn
(
)
)
{
Services
.
obs
.
notifyObservers
(
null
"
passwordmgr
-
crypto
-
login
"
)
;
}
else
{
Services
.
obs
.
notifyObservers
(
null
"
passwordmgr
-
crypto
-
loginCanceled
"
)
;
}
return
token
.
isLoggedIn
(
)
;
}
async
decrypt
(
cipherText
reauth
=
false
)
{
if
(
!
await
this
.
ensureLoggedIn
(
reauth
)
)
{
throw
Components
.
Exception
(
"
User
canceled
master
password
entry
"
Cr
.
NS_ERROR_ABORT
)
;
}
return
cryptoSDR
.
decrypt
(
cipherText
)
;
}
decryptSync
(
cipherText
)
{
if
(
this
.
isUIBusy
)
{
throw
Components
.
Exception
(
"
\
"
ensureLoggedIn
(
)
\
"
should
be
called
first
"
Cr
.
NS_ERROR_UNEXPECTED
)
;
}
return
cryptoSDR
.
decrypt
(
cipherText
)
;
}
async
encrypt
(
plainText
)
{
if
(
!
await
this
.
ensureLoggedIn
(
)
)
{
throw
Components
.
Exception
(
"
User
canceled
master
password
entry
"
Cr
.
NS_ERROR_ABORT
)
;
}
return
cryptoSDR
.
encrypt
(
plainText
)
;
}
encryptSync
(
plainText
)
{
if
(
this
.
isUIBusy
)
{
throw
Components
.
Exception
(
"
\
"
ensureLoggedIn
(
)
\
"
should
be
called
first
"
Cr
.
NS_ERROR_UNEXPECTED
)
;
}
return
cryptoSDR
.
encrypt
(
plainText
)
;
}
async
waitForExistingDialog
(
)
{
if
(
!
this
.
isUIBusy
)
{
log
.
debug
(
"
waitForExistingDialog
:
Dialog
isn
'
t
showing
.
isLoggedIn
:
"
this
.
isLoggedIn
)
;
return
this
.
isLoggedIn
;
}
return
new
Promise
(
(
resolve
)
=
>
{
log
.
debug
(
"
waitForExistingDialog
:
Observing
the
open
dialog
"
)
;
let
observer
=
{
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsIObserver
Ci
.
nsISupportsWeakReference
]
)
observe
(
subject
topic
data
)
{
log
.
debug
(
"
waitForExistingDialog
:
Got
notification
:
"
topic
)
;
Services
.
obs
.
removeObserver
(
this
"
passwordmgr
-
crypto
-
login
"
)
;
Services
.
obs
.
removeObserver
(
this
"
passwordmgr
-
crypto
-
loginCanceled
"
)
;
if
(
topic
=
=
"
passwordmgr
-
crypto
-
loginCanceled
"
)
{
resolve
(
false
)
;
return
;
}
resolve
(
true
)
;
}
}
;
Services
.
obs
.
addObserver
(
observer
"
passwordmgr
-
crypto
-
login
"
)
;
Services
.
obs
.
addObserver
(
observer
"
passwordmgr
-
crypto
-
loginCanceled
"
)
;
let
promptWin
=
Services
.
wm
.
getMostRecentWindow
(
"
prompt
:
promptPassword
"
)
;
promptWin
.
focus
(
)
;
promptWin
.
getAttention
(
)
;
}
)
;
}
}
;
XPCOMUtils
.
defineLazyGetter
(
this
"
log
"
(
)
=
>
{
let
ConsoleAPI
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Console
.
jsm
"
{
}
)
.
ConsoleAPI
;
return
new
ConsoleAPI
(
{
maxLogLevelPref
:
"
masterPassword
.
loglevel
"
prefix
:
"
Master
Password
"
}
)
;
}
)
;
