"
use
strict
"
;
console
.
warn
(
When
using
oauth
Firefox
calls
the
Storage
Access
API
on
behalf
of
the
site
.
See
https
:
/
/
bugzilla
.
mozilla
.
org
/
show_bug
.
cgi
?
id
=
1776869
for
details
.
)
;
const
GOOGLE_OAUTH_PATH_PREFIX
=
"
https
:
/
/
accounts
.
google
.
com
/
ServiceLogin
"
;
async
function
requestGrantedAccess
(
)
{
const
storageAccessPermission
=
await
navigator
.
permissions
.
query
(
{
name
:
"
storage
-
access
"
}
)
;
const
hasStorageAccess
=
await
document
.
hasStorageAccess
(
)
;
if
(
storageAccessPermission
.
state
=
=
=
"
granted
"
&
&
!
hasStorageAccess
)
{
await
document
.
requestStorageAccess
(
)
;
location
.
reload
(
)
;
}
}
requestGrantedAccess
(
)
;
const
origOpen
=
window
.
wrappedJSObject
.
open
;
Object
.
defineProperty
(
window
.
wrappedJSObject
"
open
"
{
value
:
exportFunction
(
(
url
.
.
.
args
)
=
>
{
if
(
!
url
.
startsWith
(
GOOGLE_OAUTH_PATH_PREFIX
)
)
{
return
origOpen
(
url
.
.
.
args
)
;
}
document
.
requestStorageAccess
(
)
.
then
(
(
)
=
>
{
origOpen
(
url
.
.
.
args
)
;
}
)
;
return
null
;
}
window
)
}
)
;
