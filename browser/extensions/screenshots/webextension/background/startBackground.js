const
startTime
=
Date
.
now
(
)
;
this
.
startBackground
=
(
function
(
)
{
let
exports
=
{
startTime
}
;
const
backgroundScripts
=
[
"
log
.
js
"
"
makeUuid
.
js
"
"
catcher
.
js
"
"
blobConverters
.
js
"
"
background
/
selectorLoader
.
js
"
"
background
/
communication
.
js
"
"
background
/
auth
.
js
"
"
background
/
senderror
.
js
"
"
build
/
raven
.
js
"
"
build
/
shot
.
js
"
"
build
/
thumbnailGenerator
.
js
"
"
background
/
analytics
.
js
"
"
background
/
deviceInfo
.
js
"
"
background
/
takeshot
.
js
"
"
background
/
main
.
js
"
]
;
browser
.
contextMenus
.
create
(
{
id
:
"
create
-
screenshot
"
title
:
browser
.
i18n
.
getMessage
(
"
contextMenuLabel
"
)
contexts
:
[
"
page
"
]
documentUrlPatterns
:
[
"
<
all_urls
>
"
]
}
)
;
browser
.
contextMenus
.
onClicked
.
addListener
(
(
info
tab
)
=
>
{
loadIfNecessary
(
)
.
then
(
(
)
=
>
{
main
.
onClickedContextMenu
(
info
tab
)
;
}
)
.
catch
(
(
error
)
=
>
{
console
.
error
(
"
Error
loading
Screenshots
:
"
error
)
;
}
)
;
}
)
;
browser
.
runtime
.
onMessage
.
addListener
(
(
req
sender
sendResponse
)
=
>
{
loadIfNecessary
(
)
.
then
(
(
)
=
>
{
return
communication
.
onMessage
(
req
sender
sendResponse
)
;
}
)
.
catch
(
(
error
)
=
>
{
console
.
error
(
"
Error
loading
Screenshots
:
"
error
)
;
}
)
;
return
true
;
}
)
;
let
photonPageActionPort
=
null
;
initPhotonPageAction
(
)
;
let
loadedPromise
;
function
loadIfNecessary
(
)
{
if
(
loadedPromise
)
{
return
loadedPromise
;
}
loadedPromise
=
Promise
.
resolve
(
)
;
backgroundScripts
.
forEach
(
(
script
)
=
>
{
loadedPromise
=
loadedPromise
.
then
(
(
)
=
>
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
tag
=
document
.
createElement
(
"
script
"
)
;
tag
.
src
=
browser
.
extension
.
getURL
(
script
)
;
tag
.
onload
=
(
)
=
>
{
resolve
(
)
;
}
;
tag
.
onerror
=
(
error
)
=
>
{
let
exc
=
new
Error
(
Error
loading
script
:
{
error
.
message
}
)
;
exc
.
scriptName
=
script
;
reject
(
exc
)
;
}
;
document
.
head
.
appendChild
(
tag
)
;
}
)
;
}
)
;
}
)
;
return
loadedPromise
;
}
function
initPhotonPageAction
(
)
{
photonPageActionPort
=
browser
.
runtime
.
connect
(
{
name
:
"
photonPageActionPort
"
}
)
;
photonPageActionPort
.
onMessage
.
addListener
(
(
message
)
=
>
{
switch
(
message
.
type
)
{
case
"
click
"
:
loadIfNecessary
(
)
.
then
(
(
)
=
>
{
return
browser
.
tabs
.
get
(
message
.
tab
.
id
)
;
}
)
.
then
(
(
tab
)
=
>
{
main
.
onClicked
(
tab
)
;
}
)
.
catch
(
(
error
)
=
>
{
console
.
error
(
"
Error
loading
Screenshots
:
"
error
)
;
}
)
;
break
;
default
:
console
.
error
(
"
Unrecognized
message
:
"
message
)
;
break
;
}
}
)
;
photonPageActionPort
.
postMessage
(
{
type
:
"
setProperties
"
title
:
browser
.
i18n
.
getMessage
(
"
contextMenuLabel
"
)
}
)
;
Object
.
defineProperties
(
exports
{
"
photonPageActionPort
"
:
{
enumerable
:
true
get
(
)
{
return
photonPageActionPort
;
}
}
}
)
;
}
return
exports
;
}
)
(
)
;
