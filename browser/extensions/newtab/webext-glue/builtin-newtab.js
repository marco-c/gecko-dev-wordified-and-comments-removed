"
use
strict
"
;
const
{
AppConstants
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
AppConstants
.
sys
.
mjs
"
)
;
XPCOMUtils
.
defineLazyServiceGetter
(
this
"
resProto
"
"
mozilla
.
org
/
network
/
protocol
;
1
?
name
=
resource
"
"
nsISubstitutingProtocolHandler
"
)
;
const
SUPPORTED_LOCALES
=
#
include
locales
/
supported
-
locales
.
json
const
lazy
=
{
}
;
ChromeUtils
.
defineESModuleGetters
(
lazy
{
AboutHomeStartupCache
:
"
resource
:
/
/
/
modules
/
AboutHomeStartupCache
.
sys
.
mjs
"
NewTabGleanUtils
:
"
resource
:
/
/
newtab
/
lib
/
NewTabGleanUtils
.
sys
.
mjs
"
}
)
;
const
ResourceSubstitution
=
"
newtab
"
;
this
.
builtin_newtab
=
class
extends
ExtensionAPI
{
#
chromeHandle
=
null
;
async
registerMetricsFromJson
(
)
{
const
version
=
AppConstants
.
MOZ_APP_VERSION
.
match
(
/
\
d
+
/
)
[
0
]
;
const
metricsPath
=
webext
-
glue
/
metrics
/
runtime
-
metrics
-
{
version
}
.
json
;
lazy
.
NewTabGleanUtils
.
registerMetricsAndPings
(
resource
:
/
/
newtab
/
{
metricsPath
}
)
;
}
onStartup
(
)
{
if
(
!
AppConstants
.
BROWSER_NEWTAB_AS_ADDON
)
{
return
;
}
const
{
rootURI
}
=
this
.
extension
;
resProto
.
setSubstitutionWithFlags
(
ResourceSubstitution
rootURI
Ci
.
nsISubstitutingProtocolHandler
.
ALLOW_CONTENT_ACCESS
)
;
let
aomStartup
=
Cc
[
"
mozilla
.
org
/
addons
/
addon
-
manager
-
startup
;
1
"
]
.
getService
(
Ci
.
amIAddonManagerStartup
)
;
const
manifestURI
=
Services
.
io
.
newURI
(
"
manifest
.
json
"
null
this
.
extension
.
rootURI
)
;
this
.
#
chromeHandle
=
aomStartup
.
registerChrome
(
manifestURI
[
[
"
content
"
"
newtab
"
"
data
/
content
"
"
contentaccessible
=
yes
"
]
]
)
;
let
redirector
=
Cc
[
"
mozilla
.
org
/
network
/
protocol
/
about
;
1
?
what
=
newtab
"
]
.
getService
(
Ci
.
nsIAboutModule
)
.
wrappedJSObject
;
if
(
this
.
extension
.
rootURI
.
spec
.
endsWith
(
"
newtab
mozilla
.
org
.
xpi
!
/
"
)
)
{
const
newtabFileSource
=
new
L10nFileSource
(
"
newtab
"
"
app
"
SUPPORTED_LOCALES
resource
:
/
/
newtab
/
locales
/
{
locale
}
/
)
;
L10nRegistry
.
getInstance
(
)
.
registerSources
(
[
newtabFileSource
]
)
;
this
.
registerMetricsFromJson
(
)
;
}
redirector
.
builtInAddonInitialized
(
)
;
}
onShutdown
(
)
{
if
(
!
AppConstants
.
BROWSER_NEWTAB_AS_ADDON
)
{
return
;
}
resProto
.
setSubstitution
(
ResourceSubstitution
null
)
;
this
.
#
chromeHandle
.
destruct
(
)
;
this
.
#
chromeHandle
=
null
;
}
getAPI
(
_context
)
{
return
{
builtin
:
{
newtab
:
{
handleUpdateAvailable
(
)
{
lazy
.
AboutHomeStartupCache
.
clearCacheAndUninit
(
)
;
}
}
}
}
;
}
}
;
