"
use
strict
"
;
let
{
AboutHomeStartupCache
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
AboutHomeStartupCache
.
sys
.
mjs
"
)
;
const
{
sinon
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
Sinon
.
sys
.
mjs
"
)
;
const
{
DiscoveryStreamFeed
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
newtab
/
lib
/
DiscoveryStreamFeed
.
sys
.
mjs
"
)
;
const
{
PREFS_CONFIG
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
newtab
/
lib
/
ActivityStream
.
sys
.
mjs
"
)
;
async
function
withFullyLoadedAboutHome
(
taskFn
)
{
let
defaultDSConfig
=
JSON
.
parse
(
PREFS_CONFIG
.
get
(
"
discoverystream
.
config
"
)
.
getValue
(
{
geo
:
"
US
"
locale
:
"
en
-
US
"
}
)
)
;
const
sandbox
=
sinon
.
createSandbox
(
)
;
sandbox
.
stub
(
DiscoveryStreamFeed
.
prototype
"
generateFeedUrl
"
)
.
returns
(
"
https
:
/
/
example
.
com
/
browser
/
browser
/
extensions
/
newtab
/
test
/
browser
/
topstories
.
json
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
ui
.
prefersReducedMotion
"
1
]
[
"
browser
.
newtabpage
.
activity
-
stream
.
discoverystream
.
config
"
JSON
.
stringify
(
defaultDSConfig
)
]
]
}
)
;
return
BrowserTestUtils
.
withNewTab
(
"
about
:
home
"
async
browser
=
>
{
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
content
.
document
.
querySelectorAll
(
"
[
data
-
section
-
id
=
'
topstories
'
]
.
ds
-
card
-
link
"
)
.
length
"
Waiting
for
Discovery
Stream
to
be
rendered
.
"
)
;
}
)
;
await
taskFn
(
browser
)
;
sandbox
.
restore
(
)
;
}
)
;
}
async
function
simulateRestart
(
browser
{
withAutoShutdownWrite
=
true
ensureCacheWinsRace
=
true
expectTimeout
=
false
skipAboutHomeLoad
=
false
}
=
{
}
)
{
info
(
"
Simulating
restart
of
the
browser
"
)
;
if
(
browser
.
remoteType
!
=
=
E10SUtils
.
PRIVILEGEDABOUT_REMOTE_TYPE
)
{
throw
new
Error
(
"
prepareLoadFromCache
should
only
be
called
on
a
browser
"
+
"
loaded
in
the
privileged
about
content
process
.
"
)
;
}
if
(
withAutoShutdownWrite
&
&
AboutHomeStartupCache
.
initted
)
{
info
(
"
Simulating
shutdown
write
"
)
;
let
timedOut
=
!
(
await
AboutHomeStartupCache
.
onShutdown
(
expectTimeout
)
)
;
if
(
timedOut
&
&
!
expectTimeout
)
{
Assert
.
ok
(
false
"
AboutHomeStartupCache
shutdown
unexpectedly
timed
out
.
"
)
;
}
else
if
(
!
timedOut
&
&
expectTimeout
)
{
Assert
.
ok
(
false
"
AboutHomeStartupCache
shutdown
failed
to
time
out
.
"
)
;
}
info
(
"
Shutdown
write
done
"
)
;
}
else
{
info
(
"
Intentionally
skipping
shutdown
write
"
)
;
}
AboutHomeStartupCache
.
uninit
(
)
;
info
(
"
Waiting
for
AboutHomeStartupCacheChild
to
uninit
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
{
AboutHomeStartupCacheChild
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
AboutNewTabRedirector
.
sys
.
mjs
"
)
;
AboutHomeStartupCacheChild
.
uninit
(
)
;
}
)
;
info
(
"
AboutHomeStartupCacheChild
uninitted
"
)
;
AboutHomeStartupCache
.
init
(
)
;
if
(
AboutHomeStartupCache
.
initted
)
{
let
processManager
=
browser
.
messageManager
.
processMessageManager
;
let
pp
=
browser
.
browsingContext
.
currentWindowGlobal
.
domProcess
;
let
{
childID
}
=
pp
;
AboutHomeStartupCache
.
onContentProcessCreated
(
childID
processManager
pp
)
;
info
(
"
Waiting
for
AboutHomeStartupCache
cache
entry
"
)
;
await
AboutHomeStartupCache
.
ensureCacheEntry
(
)
;
info
(
"
Got
AboutHomeStartupCache
cache
entry
"
)
;
if
(
ensureCacheWinsRace
)
{
info
(
"
Ensuring
cache
bytes
are
available
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
{
AboutHomeStartupCacheChild
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
AboutNewTabRedirector
.
sys
.
mjs
"
)
;
let
pageStream
=
AboutHomeStartupCacheChild
.
_pageInputStream
;
let
scriptStream
=
AboutHomeStartupCacheChild
.
_scriptInputStream
;
await
ContentTaskUtils
.
waitForCondition
(
(
)
=
>
{
return
pageStream
.
available
(
)
&
&
scriptStream
.
available
(
)
;
}
)
;
}
)
;
}
}
if
(
!
skipAboutHomeLoad
)
{
info
(
"
Waiting
for
about
:
home
to
load
"
)
;
let
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
"
about
:
home
"
)
;
BrowserTestUtils
.
startLoadingURIString
(
browser
"
about
:
home
"
)
;
await
loaded
;
info
(
"
about
:
home
loaded
"
)
;
}
}
async
function
injectIntoCache
(
page
script
)
{
if
(
!
page
|
|
!
script
)
{
throw
new
Error
(
"
Cannot
injectIntoCache
with
falsey
values
"
)
;
}
if
(
!
page
.
includes
(
id
=
"
root
"
)
)
{
throw
new
Error
(
"
Page
markup
must
include
a
root
node
.
"
)
;
}
await
AboutHomeStartupCache
.
ensureCacheEntry
(
)
;
let
pageInputStream
=
Cc
[
"
mozilla
.
org
/
io
/
string
-
input
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIStringInputStream
)
;
pageInputStream
.
setUTF8Data
(
page
)
;
let
scriptInputStream
=
Cc
[
"
mozilla
.
org
/
io
/
string
-
input
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIStringInputStream
)
;
scriptInputStream
.
setUTF8Data
(
script
)
;
await
AboutHomeStartupCache
.
populateCache
(
pageInputStream
scriptInputStream
)
;
}
async
function
clearCache
(
)
{
info
(
"
Test
is
clearing
the
cache
"
)
;
AboutHomeStartupCache
.
clearCache
(
)
;
await
AboutHomeStartupCache
.
ensureCacheEntry
(
)
;
info
(
"
Test
has
cleared
the
cache
.
"
)
;
}
function
assertCacheResultScalar
(
cacheResultScalar
)
{
let
parentScalars
=
Services
.
telemetry
.
getSnapshotForScalars
(
"
main
"
)
.
parent
;
Assert
.
equal
(
parentScalars
[
"
browser
.
startup
.
abouthome_cache_result
"
]
cacheResultScalar
"
Expected
the
right
value
set
to
browser
.
startup
.
abouthome_cache_result
"
+
"
scalar
.
"
)
;
}
async
function
ensureCachedAboutHome
(
browser
)
{
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
syncScripts
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
script
:
not
(
[
type
=
'
module
'
]
)
"
)
)
;
Assert
.
ok
(
!
!
syncScripts
.
length
"
There
should
be
page
scripts
.
"
)
;
let
[
lastSyncScript
]
=
syncScripts
.
reverse
(
)
;
Assert
.
equal
(
lastSyncScript
.
src
"
about
:
home
?
jscache
"
"
Found
about
:
home
?
jscache
script
tag
indicating
the
cached
doc
"
)
;
Assert
.
ok
(
Cu
.
waiveXrays
(
content
)
.
__FROM_STARTUP_CACHE__
"
Should
have
found
window
.
__FROM_STARTUP_CACHE__
"
)
;
Assert
.
ok
(
content
.
document
.
body
.
classList
.
contains
(
"
activity
-
stream
"
)
"
Should
have
found
activity
-
stream
class
on
<
body
>
element
"
)
;
Assert
.
ok
(
content
.
document
.
querySelector
(
"
[
data
-
section
-
id
=
'
topsites
'
]
"
)
"
Should
have
found
the
Discovery
Stream
top
sites
.
"
)
;
}
)
;
assertCacheResultScalar
(
AboutHomeStartupCache
.
CACHE_RESULT_SCALARS
.
VALID_AND_USED
)
;
}
async
function
ensureDynamicAboutHome
(
browser
expectedResultScalar
)
{
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
syncScripts
=
Array
.
from
(
content
.
document
.
querySelectorAll
(
"
script
:
not
(
[
type
=
'
module
'
]
)
"
)
)
;
Assert
.
equal
(
syncScripts
.
length
0
"
There
should
be
no
page
scripts
.
"
)
;
Assert
.
equal
(
Cu
.
waiveXrays
(
content
)
.
__FROM_STARTUP_CACHE__
undefined
"
Should
not
have
found
window
.
__FROM_STARTUP_CACHE__
"
)
;
Assert
.
ok
(
content
.
document
.
body
.
classList
.
contains
(
"
activity
-
stream
"
)
"
Should
have
found
activity
-
stream
class
on
<
body
>
element
"
)
;
Assert
.
ok
(
content
.
document
.
querySelector
(
"
[
data
-
section
-
id
=
'
topsites
'
]
"
)
"
Should
have
found
the
Discovery
Stream
top
sites
.
"
)
;
}
)
;
assertCacheResultScalar
(
expectedResultScalar
)
;
}
