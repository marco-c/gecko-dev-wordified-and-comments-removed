"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
SearchSERPTelemetryChild
"
"
ADLINK_CHECK_TIMEOUT_MS
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
clearTimeout
:
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
setTimeout
:
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
}
)
;
const
SHARED_DATA_KEY
=
"
SearchTelemetry
:
ProviderInfo
"
;
const
ADLINK_CHECK_TIMEOUT_MS
=
1000
;
class
SearchProviders
{
constructor
(
)
{
this
.
_searchProviderInfo
=
null
;
Services
.
cpmm
.
sharedData
.
addEventListener
(
"
change
"
this
)
;
}
get
info
(
)
{
if
(
this
.
_searchProviderInfo
)
{
return
this
.
_searchProviderInfo
;
}
this
.
_searchProviderInfo
=
Services
.
cpmm
.
sharedData
.
get
(
SHARED_DATA_KEY
)
;
if
(
!
this
.
_searchProviderInfo
)
{
return
null
;
}
this
.
_searchProviderInfo
=
this
.
_searchProviderInfo
.
filter
(
p
=
>
"
extraAdServersRegexps
"
in
p
)
.
map
(
p
=
>
{
return
{
.
.
.
p
searchPageRegexp
:
new
RegExp
(
p
.
searchPageRegexp
)
extraAdServersRegexps
:
p
.
extraAdServersRegexps
.
map
(
r
=
>
new
RegExp
(
r
)
)
}
;
}
)
;
return
this
.
_searchProviderInfo
;
}
handleEvent
(
event
)
{
switch
(
event
.
type
)
{
case
"
change
"
:
{
if
(
event
.
changedKeys
.
includes
(
SHARED_DATA_KEY
)
)
{
this
.
_searchProviderInfo
=
null
;
}
break
;
}
}
}
}
const
searchProviders
=
new
SearchProviders
(
)
;
class
SearchSERPTelemetryChild
extends
JSWindowActorChild
{
_getProviderInfoForUrl
(
url
)
{
return
searchProviders
.
info
?
.
find
(
info
=
>
info
.
searchPageRegexp
.
test
(
url
)
)
;
}
_checkForAdLink
(
)
{
try
{
if
(
!
this
.
contentWindow
)
{
return
;
}
}
catch
(
ex
)
{
return
;
}
let
doc
=
this
.
document
;
let
url
=
doc
.
documentURI
;
let
providerInfo
=
this
.
_getProviderInfoForUrl
(
url
)
;
if
(
!
providerInfo
)
{
return
;
}
let
regexps
=
providerInfo
.
extraAdServersRegexps
;
let
anchors
=
doc
.
getElementsByTagName
(
"
a
"
)
;
let
hasAds
=
false
;
for
(
let
anchor
of
anchors
)
{
if
(
!
anchor
.
href
)
{
continue
;
}
for
(
let
regexp
of
regexps
)
{
if
(
regexp
.
test
(
anchor
.
href
)
)
{
hasAds
=
true
;
break
;
}
}
if
(
hasAds
)
{
break
;
}
}
if
(
hasAds
)
{
this
.
sendAsyncMessage
(
"
SearchTelemetry
:
PageInfo
"
{
hasAds
:
true
url
}
)
;
}
}
handleEvent
(
event
)
{
const
cancelCheck
=
(
)
=
>
{
if
(
this
.
_waitForContentTimeout
)
{
clearTimeout
(
this
.
_waitForContentTimeout
)
;
}
}
;
const
check
=
(
)
=
>
{
cancelCheck
(
)
;
this
.
_waitForContentTimeout
=
setTimeout
(
(
)
=
>
{
this
.
_checkForAdLink
(
)
;
}
ADLINK_CHECK_TIMEOUT_MS
)
;
}
;
switch
(
event
.
type
)
{
case
"
pageshow
"
:
{
if
(
event
.
persisted
)
{
check
(
)
;
}
break
;
}
case
"
DOMContentLoaded
"
:
{
check
(
)
;
break
;
}
case
"
load
"
:
{
check
(
)
;
break
;
}
case
"
unload
"
:
{
cancelCheck
(
)
;
break
;
}
}
}
}
