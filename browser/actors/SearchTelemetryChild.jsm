"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
SearchTelemetryChild
"
"
ADLINK_CHECK_TIMEOUT_MS
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
ActorChild
:
"
resource
:
/
/
gre
/
modules
/
ActorChild
.
jsm
"
clearTimeout
:
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
setTimeout
:
"
resource
:
/
/
gre
/
modules
/
Timer
.
jsm
"
}
)
;
const
SHARED_DATA_KEY
=
"
SearchTelemetry
:
ProviderInfo
"
;
const
ADLINK_CHECK_TIMEOUT_MS
=
1000
;
class
SearchProviders
{
constructor
(
)
{
this
.
_searchProviderInfo
=
null
;
Services
.
cpmm
.
sharedData
.
addEventListener
(
"
change
"
this
)
;
}
get
info
(
)
{
if
(
this
.
_searchProviderInfo
)
{
return
this
.
_searchProviderInfo
;
}
this
.
_searchProviderInfo
=
Services
.
cpmm
.
sharedData
.
get
(
SHARED_DATA_KEY
)
;
if
(
!
this
.
_searchProviderInfo
)
{
return
null
;
}
for
(
let
[
providerName
info
]
of
Object
.
entries
(
this
.
_searchProviderInfo
)
)
{
if
(
!
(
"
extraAdServersRegexps
"
in
info
)
)
{
delete
this
.
_searchProviderInfo
[
providerName
]
;
}
}
return
this
.
_searchProviderInfo
;
}
handleEvent
(
event
)
{
switch
(
event
.
type
)
{
case
"
change
"
:
{
if
(
event
.
changedKeys
.
includes
(
SHARED_DATA_KEY
)
)
{
this
.
_searchProviderInfo
=
null
;
}
break
;
}
}
}
}
const
searchProviders
=
new
SearchProviders
(
)
;
class
SearchTelemetryChild
extends
ActorChild
{
_getProviderInfoForUrl
(
url
)
{
return
Object
.
entries
(
searchProviders
.
info
|
|
[
]
)
.
find
(
(
[
_
info
]
)
=
>
info
.
regexp
.
test
(
url
)
)
;
}
_checkForAdLink
(
)
{
if
(
!
this
.
content
)
{
return
;
}
let
doc
=
this
.
content
.
document
;
let
url
=
doc
.
documentURI
;
let
providerInfo
=
this
.
_getProviderInfoForUrl
(
url
)
;
if
(
!
providerInfo
)
{
return
;
}
let
regexps
=
providerInfo
[
1
]
.
extraAdServersRegexps
;
let
anchors
=
doc
.
getElementsByTagName
(
"
a
"
)
;
let
hasAds
=
false
;
for
(
let
anchor
of
anchors
)
{
if
(
!
anchor
.
href
)
{
continue
;
}
for
(
let
regexp
of
regexps
)
{
if
(
regexp
.
test
(
anchor
.
href
)
)
{
hasAds
=
true
;
break
;
}
}
if
(
hasAds
)
{
break
;
}
}
if
(
hasAds
)
{
this
.
sendAsyncMessage
(
"
SearchTelemetry
:
PageInfo
"
{
hasAds
:
true
url
}
)
;
}
}
handleEvent
(
event
)
{
if
(
event
.
target
.
ownerGlobal
!
=
this
.
content
)
{
return
;
}
const
cancelCheck
=
(
)
=
>
{
if
(
this
.
_waitForContentTimeout
)
{
clearTimeout
(
this
.
_waitForContentTimeout
)
;
}
}
;
const
check
=
(
)
=
>
{
cancelCheck
(
)
;
this
.
_waitForContentTimeout
=
setTimeout
(
(
)
=
>
{
this
.
_checkForAdLink
(
)
;
}
ADLINK_CHECK_TIMEOUT_MS
)
;
}
;
switch
(
event
.
type
)
{
case
"
pageshow
"
:
{
if
(
event
.
persisted
)
{
check
(
)
;
}
break
;
}
case
"
DOMContentLoaded
"
:
{
check
(
)
;
break
;
}
case
"
unload
"
:
{
cancelCheck
(
)
;
break
;
}
}
}
}
