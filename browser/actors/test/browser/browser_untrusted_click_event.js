"
use
strict
"
;
const
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
com
"
)
;
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
test
.
wait300msAfterTabSwitch
"
true
]
]
}
)
;
}
)
;
add_task
(
async
function
test_untrusted_click_opens_tab
(
)
{
await
BrowserTestUtils
.
withNewTab
(
TEST_PATH
+
"
click
.
html
"
async
browser
=
>
{
let
newTabOpened
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
"
https
:
/
/
example
.
org
/
"
true
)
;
info
(
"
clicking
link
with
modifier
pressed
.
"
)
;
let
eventObj
=
{
}
;
eventObj
[
AppConstants
.
platform
=
=
"
macosx
"
?
"
metaKey
"
:
"
ctrlKey
"
]
=
true
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
test
"
eventObj
browser
)
;
info
(
"
Waiting
for
new
tab
to
open
from
frontend
;
if
we
timeout
the
test
is
broken
.
"
)
;
let
newTab
=
await
newTabOpened
;
ok
(
newTab
"
New
tab
should
be
opened
.
"
)
;
BrowserTestUtils
.
removeTab
(
newTab
)
;
}
)
;
}
)
;
add_task
(
async
function
test_unused_click_doesnt_consume_activation
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
disable_open_during_load
"
true
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_PATH
+
"
click
.
html
"
async
browser
=
>
{
let
newTabOpened
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
"
https
:
/
/
example
.
com
/
"
true
)
;
info
(
"
clicking
button
that
generates
link
press
.
"
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
fire
-
untrusted
"
{
}
browser
)
;
info
(
"
Waiting
for
new
tab
to
open
through
gecko
;
if
we
timeout
the
test
is
broken
.
"
)
;
let
newTab
=
await
newTabOpened
;
ok
(
newTab
"
New
tab
should
be
opened
.
"
)
;
BrowserTestUtils
.
removeTab
(
newTab
)
;
}
)
;
}
)
;
add_task
(
async
function
test_click_without_href_doesnt_consume_activation
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
disable_open_during_load
"
true
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_PATH
+
"
click
.
html
"
async
browser
=
>
{
let
newTabOpened
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
clicking
link
that
generates
link
click
on
target
-
less
link
.
"
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
fire
-
targetless
-
link
"
{
}
browser
)
;
info
(
"
Waiting
for
new
tab
to
open
after
targetless
link
;
if
we
timeout
the
test
is
broken
.
"
)
;
let
newTab
=
await
newTabOpened
;
ok
(
newTab
"
New
tab
should
be
opened
.
"
)
;
BrowserTestUtils
.
removeTab
(
newTab
)
;
newTabOpened
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
"
about
:
blank
"
)
;
info
(
"
clicking
link
that
generates
button
click
.
"
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
fire
-
button
"
{
}
browser
)
;
info
(
"
Waiting
for
new
tab
to
open
after
button
redirect
;
if
we
timeout
the
test
is
broken
.
"
)
;
newTab
=
await
newTabOpened
;
ok
(
newTab
"
New
tab
should
be
opened
.
"
)
;
BrowserTestUtils
.
removeTab
(
newTab
)
;
}
)
;
}
)
;
