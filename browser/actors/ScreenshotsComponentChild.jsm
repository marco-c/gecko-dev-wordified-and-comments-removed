"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
ScreenshotsComponentChild
"
]
;
class
ScreenshotsComponentChild
extends
JSWindowActorChild
{
receiveMessage
(
message
)
{
switch
(
message
.
name
)
{
case
"
Screenshots
:
ShowOverlay
"
:
return
this
.
startScreenshotsOverlay
(
)
;
case
"
Screenshots
:
HideOverlay
"
:
return
this
.
endScreenshotsOverlay
(
)
;
case
"
Screenshots
:
getFullPageBounds
"
:
return
this
.
getFullPageBounds
(
)
;
case
"
Screenshots
:
getVisibleBounds
"
:
return
this
.
getVisibleBounds
(
)
;
}
return
null
;
}
documentIsReady
(
)
{
const
document
=
this
.
document
;
function
readyEnough
(
)
{
return
(
document
.
readyState
!
=
=
"
uninitialized
"
&
&
document
.
documentElement
)
;
}
if
(
readyEnough
(
)
)
{
return
Promise
.
resolve
(
)
;
}
return
new
Promise
(
(
resolve
reject
)
=
>
{
function
onChange
(
event
)
{
if
(
event
.
type
=
=
=
"
pagehide
"
)
{
document
.
removeEventListener
(
"
readystatechange
"
onChange
)
;
this
.
contentWindow
.
removeEventListener
(
"
pagehide
"
onChange
)
;
reject
(
new
Error
(
"
document
unloaded
before
it
was
ready
"
)
)
;
}
else
if
(
readyEnough
(
)
)
{
document
.
removeEventListener
(
"
readystatechange
"
onChange
)
;
this
.
contentWindow
.
removeEventListener
(
"
pagehide
"
onChange
)
;
resolve
(
)
;
}
}
document
.
addEventListener
(
"
readystatechange
"
onChange
)
;
this
.
contentWindow
.
addEventListener
(
"
pagehide
"
onChange
{
once
:
true
}
)
;
}
)
;
}
async
startScreenshotsOverlay
(
details
=
{
}
)
{
try
{
await
this
.
documentIsReady
(
)
;
}
catch
(
ex
)
{
console
.
warn
(
ScreenshotsComponentChild
:
{
ex
.
message
}
)
;
return
false
;
}
return
true
;
}
endScreenshotsOverlay
(
)
{
return
true
;
}
getFullPageBounds
(
)
{
let
doc
=
this
.
document
.
documentElement
;
let
rect
=
new
DOMRect
(
doc
.
clientLeft
doc
.
clientTop
doc
.
scrollWidth
doc
.
scrollHeight
)
;
let
devicePixelRatio
=
this
.
document
.
ownerGlobal
.
devicePixelRatio
;
return
{
devicePixelRatio
rect
}
;
}
getVisibleBounds
(
)
{
let
doc
=
this
.
document
.
documentElement
;
let
rect
=
new
DOMRect
(
doc
.
scrollLeft
doc
.
scrollTop
doc
.
clientWidth
doc
.
clientHeight
)
;
let
devicePixelRatio
=
this
.
document
.
ownerGlobal
.
devicePixelRatio
;
return
{
devicePixelRatio
rect
}
;
}
}
