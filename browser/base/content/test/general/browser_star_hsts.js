var
secureURL
=
"
https
:
/
/
example
.
com
/
browser
/
browser
/
base
/
content
/
test
/
general
/
browser_star_hsts
.
sjs
"
;
var
unsecureURL
=
"
http
:
/
/
example
.
com
/
browser
/
browser
/
base
/
content
/
test
/
general
/
browser_star_hsts
.
sjs
"
;
add_task
(
async
function
test_star_redirect
(
)
{
registerCleanupFunction
(
function
(
)
{
let
sss
=
Cc
[
"
mozilla
.
org
/
ssservice
;
1
"
]
.
getService
(
Ci
.
nsISiteSecurityService
)
;
sss
.
removeState
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
NetUtil
.
newURI
(
"
http
:
/
/
example
.
com
/
"
)
0
)
;
PlacesUtils
.
bookmarks
.
removeFolderChildren
(
PlacesUtils
.
unfiledBookmarksFolderId
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
let
tab
=
gBrowser
.
selectedTab
=
BrowserTestUtils
.
addTab
(
gBrowser
)
;
await
promiseTabLoadEvent
(
tab
secureURL
secureURL
)
;
await
promiseTabLoadEvent
(
tab
unsecureURL
secureURL
)
;
await
promiseStarState
(
BookmarkingUI
.
STATUS_UNSTARRED
)
;
let
bookmarkPanel
=
document
.
getElementById
(
"
editBookmarkPanel
"
)
;
let
shownPromise
=
promisePopupShown
(
bookmarkPanel
)
;
BookmarkingUI
.
star
.
click
(
)
;
await
shownPromise
;
is
(
BookmarkingUI
.
status
BookmarkingUI
.
STATUS_STARRED
"
The
star
is
starred
"
)
;
}
)
;
function
promiseStarState
(
aValue
)
{
return
new
Promise
(
resolve
=
>
{
let
expectedStatus
=
aValue
?
BookmarkingUI
.
STATUS_STARRED
:
BookmarkingUI
.
STATUS_UNSTARRED
;
(
function
checkState
(
)
{
if
(
BookmarkingUI
.
status
=
=
BookmarkingUI
.
STATUS_UPDATING
|
|
BookmarkingUI
.
status
!
=
expectedStatus
)
{
info
(
"
Waiting
for
star
button
change
.
"
)
;
setTimeout
(
checkState
1000
)
;
}
else
{
resolve
(
)
;
}
}
)
(
)
;
}
)
;
}
function
promiseTabLoadEvent
(
aTab
aURL
aFinalURL
)
{
if
(
!
aFinalURL
)
aFinalURL
=
aURL
;
return
new
Promise
(
resolve
=
>
{
info
(
"
Wait
for
load
tab
event
"
)
;
aTab
.
linkedBrowser
.
addEventListener
(
"
load
"
function
load
(
event
)
{
if
(
event
.
originalTarget
!
=
aTab
.
linkedBrowser
.
contentDocument
|
|
event
.
target
.
location
.
href
=
=
"
about
:
blank
"
|
|
event
.
target
.
location
.
href
!
=
aFinalURL
)
{
info
(
"
skipping
spurious
load
event
"
)
;
return
;
}
aTab
.
linkedBrowser
.
removeEventListener
(
"
load
"
load
true
)
;
info
(
"
Tab
load
event
received
"
)
;
resolve
(
)
;
}
true
true
)
;
aTab
.
linkedBrowser
.
loadURI
(
aURL
)
;
}
)
;
}
