const
URL
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
browser
/
base
/
content
/
test
/
general
/
offlineQuotaNotification
.
html
"
;
registerCleanupFunction
(
function
(
)
{
let
uri
=
Services
.
io
.
newURI
(
URL
null
null
)
;
let
principal
=
Services
.
scriptSecurityManager
.
createCodebasePrincipal
(
uri
{
}
)
;
Services
.
perms
.
removeFromPrincipal
(
principal
"
offline
-
app
"
)
;
Services
.
prefs
.
clearUserPref
(
"
offline
-
apps
.
quota
.
warn
"
)
;
Services
.
prefs
.
clearUserPref
(
"
offline
-
apps
.
allow_by_default
"
)
;
}
)
;
function
checkInContentPreferences
(
win
)
{
let
doc
=
win
.
document
;
let
sel
=
doc
.
getElementById
(
"
categories
"
)
.
selectedItems
[
0
]
.
id
;
let
tab
=
doc
.
getElementById
(
"
advancedPrefs
"
)
.
selectedTab
.
id
;
is
(
gBrowser
.
currentURI
.
spec
"
about
:
preferences
#
advanced
"
"
about
:
preferences
loaded
"
)
;
is
(
sel
"
category
-
advanced
"
"
Advanced
pane
was
selected
"
)
;
is
(
tab
"
networkTab
"
"
Network
tab
is
selected
"
)
;
win
.
close
(
)
;
finish
(
)
;
}
function
test
(
)
{
waitForExplicitFinish
(
)
;
Services
.
prefs
.
setBoolPref
(
"
offline
-
apps
.
allow_by_default
"
false
)
;
gBrowser
.
selectedTab
=
gBrowser
.
addTab
(
URL
)
;
registerCleanupFunction
(
(
)
=
>
gBrowser
.
removeCurrentTab
(
)
)
;
Promise
.
all
(
[
promiseNotification
(
)
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
]
)
.
then
(
(
)
=
>
{
gBrowser
.
selectedBrowser
.
contentWindow
.
applicationCache
.
oncached
=
function
(
)
{
executeSoon
(
function
(
)
{
let
notification
=
PopupNotifications
.
getNotification
(
'
offline
-
app
-
usage
'
)
;
ok
(
notification
"
have
offline
-
app
-
usage
notification
"
)
;
PopupNotifications
.
panel
.
firstElementChild
.
button
.
click
(
)
;
let
newTabBrowser
=
gBrowser
.
getBrowserForTab
(
gBrowser
.
selectedTab
)
;
newTabBrowser
.
addEventListener
(
"
Initialized
"
function
PrefInit
(
)
{
newTabBrowser
.
removeEventListener
(
"
Initialized
"
PrefInit
true
)
;
executeSoon
(
function
(
)
{
checkInContentPreferences
(
newTabBrowser
.
contentWindow
)
;
}
)
}
true
)
;
}
)
;
}
;
Services
.
prefs
.
setIntPref
(
"
offline
-
apps
.
quota
.
warn
"
1
)
;
PopupNotifications
.
panel
.
firstElementChild
.
button
.
click
(
)
;
}
)
;
}
function
promiseNotification
(
)
{
return
new
Promise
(
resolve
=
>
{
PopupNotifications
.
panel
.
addEventListener
(
"
popupshown
"
function
onShown
(
)
{
PopupNotifications
.
panel
.
removeEventListener
(
"
popupshown
"
onShown
)
;
resolve
(
)
;
}
)
;
}
)
;
}
