add_task
(
async
function
(
)
{
await
pushPrefs
(
[
"
ui
.
key
.
contentAccess
"
5
]
[
"
ui
.
key
.
chromeAccess
"
5
]
)
;
const
gPageURL1
=
"
data
:
text
/
html
<
body
>
<
p
>
"
+
"
<
button
id
=
'
button
'
accesskey
=
'
y
'
>
Button
<
/
button
>
"
+
"
<
input
id
=
'
checkbox
'
type
=
'
checkbox
'
accesskey
=
'
z
'
>
Checkbox
"
+
"
<
/
p
>
<
/
body
>
"
;
let
tab1
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
gPageURL1
)
;
tab1
.
linkedBrowser
.
messageManager
.
loadFrameScript
(
"
data
:
(
"
+
childHandleFocus
.
toString
(
)
+
"
)
(
)
;
"
false
)
;
Services
.
focus
.
clearFocus
(
window
)
;
let
focusedId
=
await
performAccessKey
(
"
y
"
)
;
is
(
focusedId
"
button
"
"
button
accesskey
"
)
;
focusedId
=
await
performAccessKey
(
"
z
"
)
;
is
(
focusedId
"
checkbox
"
"
checkbox
accesskey
"
)
;
let
newButton
=
document
.
createXULElement
(
"
button
"
)
;
newButton
.
id
=
"
chromebutton
"
;
newButton
.
setAttribute
(
"
accesskey
"
"
z
"
)
;
document
.
documentElement
.
appendChild
(
newButton
)
;
Services
.
focus
.
clearFocus
(
window
)
;
focusedId
=
await
performAccessKeyForChrome
(
"
z
"
)
;
is
(
focusedId
"
chromebutton
"
"
chromebutton
accesskey
"
)
;
const
gPageURL2
=
"
data
:
text
/
html
<
body
>
"
+
"
<
button
id
=
'
tab2button
'
accesskey
=
'
y
'
>
Button
in
Tab
2
<
/
button
>
"
+
"
<
/
body
>
"
;
let
tab2
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
gPageURL2
)
;
tab2
.
linkedBrowser
.
messageManager
.
loadFrameScript
(
"
data
:
(
"
+
childHandleFocus
.
toString
(
)
+
"
)
(
)
;
"
false
)
;
Services
.
focus
.
clearFocus
(
window
)
;
focusedId
=
await
performAccessKey
(
"
y
"
)
;
is
(
focusedId
"
tab2button
"
"
button
accesskey
in
tab2
"
)
;
focusedId
=
await
performAccessKeyForChrome
(
"
z
"
)
;
is
(
focusedId
"
chromebutton
"
"
chromebutton
accesskey
"
)
;
gBrowser
.
removeTab
(
tab1
)
;
gBrowser
.
removeTab
(
tab2
)
;
const
gPageURL3
=
"
data
:
text
/
html
<
body
id
=
'
tab3body
'
>
"
+
"
<
button
id
=
'
tab3button
'
accesskey
=
'
y
'
>
Button
in
Tab
3
<
/
button
>
"
+
"
<
script
>
"
+
"
document
.
body
.
addEventListener
(
'
keydown
'
(
event
)
=
>
{
event
.
preventDefault
(
)
;
}
)
;
"
+
"
<
/
script
>
<
/
body
>
"
;
let
tab3
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
gPageURL3
)
;
tab3
.
linkedBrowser
.
messageManager
.
loadFrameScript
(
"
data
:
(
"
+
childHandleFocus
.
toString
(
)
+
"
)
(
)
;
"
false
)
;
Services
.
focus
.
clearFocus
(
window
)
;
focusedId
=
await
performAccessKey
(
"
y
"
)
;
is
(
focusedId
"
tab3button
"
"
button
accesskey
in
tab3
should
be
focused
"
)
;
newButton
.
onfocus
=
(
)
=
>
{
ok
(
false
"
chromebutton
shouldn
'
t
get
focus
during
testing
with
tab3
"
)
;
}
;
focusedId
=
await
performAccessKey
(
"
z
"
)
;
is
(
focusedId
"
tab3body
"
"
button
accesskey
in
tab3
should
keep
having
focus
"
)
;
newButton
.
onfocus
=
null
;
gBrowser
.
removeTab
(
tab3
)
;
const
gPageURL4
=
"
data
:
text
/
html
<
body
id
=
'
tab4body
'
>
"
+
"
<
button
id
=
'
tab4button
'
accesskey
=
'
y
'
>
Button
in
Tab
4
<
/
button
>
"
+
"
<
script
>
"
+
"
document
.
body
.
addEventListener
(
'
keypress
'
(
event
)
=
>
{
event
.
preventDefault
(
)
;
}
)
;
"
+
"
<
/
script
>
<
/
body
>
"
;
let
tab4
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
gPageURL4
)
;
tab4
.
linkedBrowser
.
messageManager
.
loadFrameScript
(
"
data
:
(
"
+
childHandleFocus
.
toString
(
)
+
"
)
(
)
;
"
false
)
;
Services
.
focus
.
clearFocus
(
window
)
;
focusedId
=
await
performAccessKey
(
"
y
"
)
;
is
(
focusedId
"
tab4button
"
"
button
accesskey
in
tab4
should
be
focused
"
)
;
newButton
.
onfocus
=
(
)
=
>
{
todo
(
false
"
chromebutton
shouldn
'
t
get
focus
during
testing
with
tab4
"
)
;
}
;
focusedId
=
await
performAccessKey
(
"
z
"
)
;
is
(
focusedId
"
tab4body
"
"
button
accesskey
in
tab4
should
keep
having
focus
"
)
;
newButton
.
onfocus
=
null
;
gBrowser
.
removeTab
(
tab4
)
;
newButton
.
remove
(
)
;
}
)
;
function
childHandleFocus
(
)
{
var
sent
=
false
;
content
.
document
.
body
.
firstElementChild
.
addEventListener
(
"
focus
"
function
focused
(
event
)
{
sent
=
true
;
let
focusedElement
=
content
.
document
.
activeElement
;
focusedElement
.
blur
(
)
;
sendAsyncMessage
(
"
Test
:
FocusFromAccessKey
"
{
focus
:
focusedElement
.
id
}
)
;
}
true
)
;
content
.
document
.
body
.
addEventListener
(
"
keydown
"
function
keydown
(
event
)
{
sent
=
false
;
}
true
)
;
content
.
document
.
body
.
addEventListener
(
"
keyup
"
function
keyup
(
event
)
{
if
(
!
sent
)
{
sent
=
true
;
let
focusedElement
=
content
.
document
.
activeElement
;
sendAsyncMessage
(
"
Test
:
FocusFromAccessKey
"
{
focus
:
focusedElement
.
id
}
)
;
}
}
)
;
}
function
performAccessKey
(
key
)
{
return
new
Promise
(
resolve
=
>
{
let
mm
=
gBrowser
.
selectedBrowser
.
messageManager
;
mm
.
addMessageListener
(
"
Test
:
FocusFromAccessKey
"
function
listenForFocus
(
msg
)
{
mm
.
removeMessageListener
(
"
Test
:
FocusFromAccessKey
"
listenForFocus
)
;
resolve
(
msg
.
data
.
focus
)
;
}
)
;
EventUtils
.
synthesizeKey
(
key
{
altKey
:
true
shiftKey
:
true
}
)
;
}
)
;
}
async
function
performAccessKeyForChrome
(
key
inChild
)
{
let
waitFocusChangePromise
=
BrowserTestUtils
.
waitForEvent
(
document
"
focus
"
true
)
;
EventUtils
.
synthesizeKey
(
key
{
altKey
:
true
shiftKey
:
true
}
)
;
await
waitFocusChangePromise
;
return
document
.
activeElement
.
id
;
}
