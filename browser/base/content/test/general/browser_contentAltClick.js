"
use
strict
"
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
Downloads
"
"
resource
:
/
/
gre
/
modules
/
Downloads
.
jsm
"
)
;
function
setup
(
)
{
gPrefService
.
setBoolPref
(
"
browser
.
altClickSave
"
true
)
;
let
testPage
=
'
data
:
text
/
html
'
+
'
<
p
>
<
a
id
=
"
commonlink
"
href
=
"
http
:
/
/
mochi
.
test
/
moz
/
"
>
Common
link
<
/
a
>
<
/
p
>
'
+
'
<
p
>
<
math
id
=
"
mathxlink
"
xmlns
=
"
http
:
/
/
www
.
w3
.
org
/
1998
/
Math
/
MathML
"
xlink
:
type
=
"
simple
"
xlink
:
href
=
"
http
:
/
/
mochi
.
test
/
moz
/
"
>
<
mtext
>
MathML
XLink
<
/
mtext
>
<
/
math
>
<
/
p
>
'
+
'
<
p
>
<
svg
id
=
"
svgxlink
"
xmlns
=
"
http
:
/
/
www
.
w3
.
org
/
2000
/
svg
"
width
=
"
100px
"
height
=
"
50px
"
version
=
"
1
.
1
"
>
<
a
xlink
:
type
=
"
simple
"
xlink
:
href
=
"
http
:
/
/
mochi
.
test
/
moz
/
"
>
<
text
transform
=
"
translate
(
10
25
)
"
>
SVG
XLink
<
/
text
>
<
/
a
>
<
/
svg
>
<
/
p
>
'
;
return
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
testPage
)
;
}
function
clean_up
(
)
{
gBrowser
.
removeCurrentTab
(
)
;
gPrefService
.
clearUserPref
(
"
browser
.
altClickSave
"
)
;
}
add_task
(
function
*
test_alt_click
(
)
{
yield
setup
(
)
;
let
downloadList
=
yield
Downloads
.
getList
(
Downloads
.
ALL
)
;
let
downloads
=
[
]
;
let
downloadView
;
let
finishedAllDownloads
=
new
Promise
(
(
resolve
)
=
>
{
downloadView
=
{
onDownloadAdded
:
function
(
aDownload
)
{
downloads
.
push
(
aDownload
)
;
downloadList
.
remove
(
aDownload
)
;
resolve
(
)
;
}
}
;
}
)
;
yield
downloadList
.
addView
(
downloadView
)
;
yield
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
commonlink
"
{
altKey
:
true
}
gBrowser
.
selectedBrowser
)
;
yield
finishedAllDownloads
;
is
(
downloads
.
length
1
"
1
downloads
"
)
;
is
(
downloads
[
0
]
.
source
.
url
"
http
:
/
/
mochi
.
test
/
moz
/
"
"
Downloaded
#
commonlink
element
"
)
;
clean_up
(
)
;
}
)
;
add_task
(
function
*
test_alt_click_on_xlinks
(
)
{
yield
setup
(
)
;
let
downloadList
=
yield
Downloads
.
getList
(
Downloads
.
ALL
)
;
let
downloads
=
[
]
;
let
downloadView
;
let
finishedAllDownloads
=
new
Promise
(
(
resolve
)
=
>
{
downloadView
=
{
onDownloadAdded
:
function
(
aDownload
)
{
downloads
.
push
(
aDownload
)
;
downloadList
.
remove
(
aDownload
)
;
if
(
downloads
.
length
=
=
2
)
{
resolve
(
)
;
}
}
}
;
}
)
;
yield
downloadList
.
addView
(
downloadView
)
;
yield
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
mathxlink
"
{
altKey
:
true
}
gBrowser
.
selectedBrowser
)
;
yield
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
svgxlink
"
{
altKey
:
true
}
gBrowser
.
selectedBrowser
)
;
yield
finishedAllDownloads
;
is
(
downloads
.
length
2
"
2
downloads
"
)
;
is
(
downloads
[
0
]
.
source
.
url
"
http
:
/
/
mochi
.
test
/
moz
/
"
"
Downloaded
#
mathxlink
element
"
)
;
is
(
downloads
[
1
]
.
source
.
url
"
http
:
/
/
mochi
.
test
/
moz
/
"
"
Downloaded
#
svgxlink
element
"
)
;
clean_up
(
)
;
}
)
;
