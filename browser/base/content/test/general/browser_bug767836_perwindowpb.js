"
use
strict
"
;
let
gNewTabService
=
Cc
[
"
mozilla
.
org
/
browser
/
aboutnewtab
-
service
;
1
"
]
.
getService
(
Ci
.
nsIAboutNewTabService
)
;
async
function
doTest
(
isPrivate
)
{
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
isPrivate
}
)
;
let
defaultURL
=
gNewTabService
.
newTabURL
;
let
newTabURL
;
let
mode
;
let
testURL
=
"
http
:
/
/
example
.
com
/
"
;
if
(
isPrivate
)
{
mode
=
"
per
window
private
browsing
"
;
newTabURL
=
"
about
:
privatebrowsing
"
;
}
else
{
mode
=
"
normal
"
;
newTabURL
=
"
about
:
newtab
"
;
}
await
openNewTab
(
win
newTabURL
)
;
is
(
win
.
gBrowser
.
selectedBrowser
.
currentURI
.
spec
newTabURL
"
URL
of
NewTab
should
be
"
+
newTabURL
+
"
in
"
+
mode
+
"
mode
"
)
;
gNewTabService
.
newTabURL
=
testURL
;
is
(
gNewTabService
.
newTabURL
testURL
"
Custom
newtab
url
is
set
"
)
;
await
openNewTab
(
win
testURL
)
;
is
(
win
.
gBrowser
.
selectedBrowser
.
currentURI
.
spec
testURL
"
URL
of
NewTab
should
be
the
custom
url
"
)
;
gNewTabService
.
resetNewTabURL
(
)
;
is
(
gNewTabService
.
newTabURL
defaultURL
"
No
custom
newtab
url
is
set
"
)
;
win
.
gBrowser
.
removeTab
(
win
.
gBrowser
.
selectedTab
)
;
win
.
gBrowser
.
removeTab
(
win
.
gBrowser
.
selectedTab
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
add_task
(
async
function
test_newTabService
(
)
{
ok
(
!
gNewTabService
.
overridden
"
No
custom
newtab
url
is
set
"
)
;
await
doTest
(
false
)
;
await
doTest
(
true
)
;
}
)
;
async
function
openNewTab
(
aWindow
aExpectedURL
)
{
aWindow
.
BrowserOpenTab
(
)
;
let
browser
=
aWindow
.
gBrowser
.
selectedBrowser
;
let
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
browser
false
aExpectedURL
)
;
let
alreadyLoaded
=
await
SpecialPowers
.
spawn
(
browser
[
aExpectedURL
]
url
=
>
{
let
doc
=
content
.
document
;
return
doc
&
&
doc
.
readyState
=
=
=
"
complete
"
&
&
doc
.
location
.
href
=
=
url
;
}
)
;
if
(
!
alreadyLoaded
)
{
await
loadPromise
;
}
}
