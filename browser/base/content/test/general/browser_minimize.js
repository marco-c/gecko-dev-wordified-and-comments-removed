add_task
(
async
function
(
)
{
registerCleanupFunction
(
function
(
)
{
window
.
restore
(
)
;
}
)
;
function
isActive
(
)
{
return
gBrowser
.
selectedTab
.
linkedBrowser
.
docShellIsActive
;
}
ok
(
isActive
(
)
"
Docshell
should
be
active
when
starting
the
test
"
)
;
ok
(
!
document
.
hidden
"
Top
level
window
should
be
visible
"
)
;
info
(
"
Calling
window
.
minimize
"
)
;
let
promiseSizeModeChange
=
BrowserTestUtils
.
waitForEvent
(
window
"
sizemodechange
"
)
.
then
(
(
)
=
>
ok
(
true
"
Got
sizemodechange
.
"
)
(
)
=
>
ok
(
false
"
Rejected
sizemodechange
.
"
)
)
;
let
promiseBrowserInactive
=
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
!
isActive
(
)
"
Docshell
should
be
inactive
.
"
)
.
then
(
(
)
=
>
ok
(
true
"
Got
inactive
.
"
)
(
)
=
>
ok
(
false
"
Rejected
inactive
.
"
)
)
;
window
.
minimize
(
)
;
await
Promise
.
all
(
[
promiseSizeModeChange
promiseBrowserInactive
]
)
;
ok
(
document
.
hidden
"
Top
level
window
should
be
hidden
"
)
;
info
(
"
Calling
window
.
restore
"
)
;
promiseSizeModeChange
=
BrowserTestUtils
.
waitForEvent
(
window
"
sizemodechange
"
)
.
then
(
(
)
=
>
ok
(
true
"
Got
sizemodechange
.
"
)
(
)
=
>
ok
(
false
"
Rejected
sizemodechange
.
"
)
)
;
let
promiseBrowserActive
=
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
isActive
(
)
"
Docshell
should
be
active
.
"
)
.
then
(
(
)
=
>
ok
(
true
"
Got
active
.
"
)
(
)
=
>
ok
(
false
"
Rejected
active
.
"
)
)
;
window
.
restore
(
)
;
await
Promise
.
race
(
[
Promise
.
all
(
[
promiseSizeModeChange
promiseBrowserActive
]
)
new
Promise
(
(
resolve
reject
)
=
>
setTimeout
(
(
)
=
>
{
reject
(
"
timed
out
waiting
for
sizemodechange
event
"
)
;
}
5000
)
)
]
)
;
ok
(
!
document
.
hidden
"
Top
level
window
should
be
visible
"
)
;
}
)
;
