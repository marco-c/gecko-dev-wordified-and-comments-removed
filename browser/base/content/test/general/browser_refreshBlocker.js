"
use
strict
"
;
const
META_PAGE
=
"
http
:
/
/
example
.
org
/
browser
/
browser
/
base
/
content
/
test
/
general
/
refresh_meta
.
sjs
"
;
const
HEADER_PAGE
=
"
http
:
/
/
example
.
org
/
browser
/
browser
/
base
/
content
/
test
/
general
/
refresh_header
.
sjs
"
;
const
TARGET_PAGE
=
"
http
:
/
/
example
.
org
/
browser
/
browser
/
base
/
content
/
test
/
general
/
dummy_page
.
html
"
;
const
PREF
=
"
accessibility
.
blockautorefresh
"
;
async
function
attemptFakeRefresh
(
browser
expectRefresh
)
{
await
SpecialPowers
.
spawn
(
browser
[
expectRefresh
]
async
function
(
contentExpectRefresh
)
{
let
URI
=
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
currentURI
;
let
refresher
=
docShell
.
QueryInterface
(
Ci
.
nsIRefreshURI
)
;
refresher
.
refreshURI
(
URI
null
0
)
;
Assert
.
equal
(
refresher
.
refreshPending
contentExpectRefresh
"
Got
the
right
refreshPending
state
"
)
;
if
(
refresher
.
refreshPending
)
{
refresher
.
cancelRefreshURITimers
(
)
;
}
content
.
location
=
URI
.
spec
+
"
#
foo
"
;
}
)
;
}
add_task
(
async
function
test_can_enable_and_block
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
TARGET_PAGE
}
async
function
(
browser
)
{
await
attemptFakeRefresh
(
browser
true
)
;
await
pushPrefs
(
[
"
accessibility
.
blockautorefresh
"
true
]
)
;
let
notificationPromise
=
BrowserTestUtils
.
waitForNotificationBar
(
gBrowser
browser
"
refresh
-
blocked
"
)
;
await
attemptFakeRefresh
(
browser
false
)
;
await
notificationPromise
;
await
pushPrefs
(
[
"
accessibility
.
blockautorefresh
"
false
]
)
;
await
attemptFakeRefresh
(
browser
true
)
;
}
)
;
}
)
;
async
function
testRealRefresh
(
refreshPage
delay
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
async
function
(
browser
)
{
await
pushPrefs
(
[
"
accessibility
.
blockautorefresh
"
true
]
)
;
BrowserTestUtils
.
loadURI
(
browser
refreshPage
+
"
?
p
=
"
+
TARGET_PAGE
+
"
&
d
=
"
+
delay
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
let
notificationBox
=
gBrowser
.
getNotificationBox
(
browser
)
;
let
notification
=
notificationBox
.
currentNotification
;
ok
(
notification
"
Notification
should
be
visible
"
)
;
is
(
notification
.
getAttribute
(
"
value
"
)
"
refresh
-
blocked
"
"
Should
be
showing
the
right
notification
"
)
;
let
buttons
=
notification
.
buttonContainer
.
querySelectorAll
(
"
.
notification
-
button
"
)
;
is
(
buttons
.
length
1
"
Should
have
one
button
.
"
)
;
let
refreshPromise
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
buttons
[
0
]
.
click
(
)
;
await
refreshPromise
;
}
)
;
}
add_task
(
async
function
test_can_allow_refresh
(
)
{
await
testRealRefresh
(
META_PAGE
0
)
;
await
testRealRefresh
(
META_PAGE
100
)
;
await
testRealRefresh
(
META_PAGE
500
)
;
}
)
;
add_task
(
async
function
test_can_block_refresh_from_header
(
)
{
await
testRealRefresh
(
HEADER_PAGE
0
)
;
await
testRealRefresh
(
HEADER_PAGE
100
)
;
await
testRealRefresh
(
HEADER_PAGE
500
)
;
}
)
;
add_task
(
async
function
test_can_update_notification
(
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
async
function
(
browser
)
{
await
pushPrefs
(
[
"
accessibility
.
blockautorefresh
"
true
]
)
;
BrowserTestUtils
.
loadURI
(
browser
META_PAGE
+
"
?
d
=
0
&
p
=
"
+
TARGET_PAGE
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
)
;
let
notificationBox
=
gBrowser
.
getNotificationBox
(
browser
)
;
let
notification
=
notificationBox
.
currentNotification
;
let
message
=
notification
.
messageText
.
querySelector
(
"
span
"
)
;
is
(
message
.
dataset
.
l10nId
"
refresh
-
blocked
-
redirect
-
label
"
"
Should
be
showing
the
redirect
message
"
)
;
await
attemptFakeRefresh
(
browser
false
)
;
message
=
notification
.
messageText
.
querySelector
(
"
span
"
)
;
is
(
message
.
dataset
.
l10nId
"
refresh
-
blocked
-
refresh
-
label
"
"
Should
be
showing
the
refresh
message
"
)
;
}
)
;
}
)
;
