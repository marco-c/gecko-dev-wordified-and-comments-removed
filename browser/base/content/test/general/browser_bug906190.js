requestLongerTimeout
(
2
)
;
const
gHttpTestRoot1
=
"
https
:
/
/
test1
.
example
.
com
/
browser
/
browser
/
base
/
content
/
test
/
general
/
"
;
const
gHttpTestRoot2
=
"
https
:
/
/
test2
.
example
.
com
/
browser
/
browser
/
base
/
content
/
test
/
general
/
"
;
function
*
doTest
(
parentTabSpec
childTabSpec
testTaskFn
waitForMetaRefresh
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
parentTabSpec
}
function
*
(
browser
)
{
yield
assertMixedContentBlockingState
(
gBrowser
{
activeLoaded
:
false
activeBlocked
:
true
passiveLoaded
:
false
}
)
;
let
promiseReloaded
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
gIdentityHandler
.
disableMixedContentProtection
(
)
;
yield
promiseReloaded
;
let
testDiv
=
content
.
document
.
getElementById
(
'
mctestdiv
'
)
;
yield
promiseWaitForCondition
(
(
)
=
>
testDiv
.
innerHTML
=
=
"
Mixed
Content
Blocker
disabled
"
)
;
let
mainDiv
=
content
.
document
.
createElement
(
"
div
"
)
;
mainDiv
.
innerHTML
=
'
<
p
>
<
a
id
=
"
linkToOpenInNewTab
"
href
=
"
'
+
childTabSpec
+
'
"
>
Link
<
/
a
>
<
/
p
>
'
;
content
.
document
.
body
.
appendChild
(
mainDiv
)
;
for
(
let
openFn
of
[
simulateCtrlClick
simulateContextMenuOpenInTab
]
)
{
let
promiseTabLoaded
=
waitForSomeTabToLoad
(
)
;
openFn
(
browser
)
;
yield
promiseTabLoaded
;
gBrowser
.
selectTabAtIndex
(
2
)
;
if
(
waitForMetaRefresh
)
{
yield
waitForSomeTabToLoad
(
)
;
}
yield
testTaskFn
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
}
)
;
}
function
simulateCtrlClick
(
browser
)
{
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
linkToOpenInNewTab
"
{
ctrlKey
:
true
metaKey
:
true
}
browser
)
;
}
function
simulateContextMenuOpenInTab
(
browser
)
{
BrowserTestUtils
.
waitForEvent
(
document
"
popupshown
"
false
event
=
>
{
document
.
getElementById
(
"
context
-
openlinkintab
"
)
.
doCommand
(
)
;
event
.
target
.
hidePopup
(
)
;
return
true
;
}
)
;
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
linkToOpenInNewTab
"
{
type
:
"
contextmenu
"
button
:
2
}
browser
)
;
}
function
waitForSomeTabToLoad
(
)
{
return
new
Promise
(
resolve
=
>
{
gBrowser
.
addEventListener
(
"
load
"
function
onLoad
(
event
)
{
let
tab
=
gBrowser
.
_getTabForContentWindow
(
event
.
target
.
defaultView
.
top
)
;
if
(
tab
)
{
gBrowser
.
removeEventListener
(
"
load
"
onLoad
true
)
;
resolve
(
)
;
}
}
true
)
;
}
)
;
}
add_task
(
function
*
test_initialize
(
)
{
yield
new
Promise
(
resolve
=
>
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
security
.
mixed_content
.
block_active_content
"
true
]
]
}
resolve
)
)
;
}
)
;
add_task
(
function
*
test_same_origin
(
)
{
yield
doTest
(
gHttpTestRoot1
+
"
file_bug906190_1
.
html
"
gHttpTestRoot1
+
"
file_bug906190_2
.
html
"
function
*
(
)
{
yield
assertMixedContentBlockingState
(
gBrowser
{
activeLoaded
:
true
activeBlocked
:
false
passiveLoaded
:
false
}
)
;
is
(
content
.
document
.
getElementById
(
'
mctestdiv
'
)
.
innerHTML
"
Mixed
Content
Blocker
disabled
"
"
OK
:
Executed
mixed
script
"
)
;
}
)
;
}
)
;
add_task
(
function
*
test_different_origin
(
)
{
yield
doTest
(
gHttpTestRoot1
+
"
file_bug906190_2
.
html
"
gHttpTestRoot2
+
"
file_bug906190_2
.
html
"
function
*
(
)
{
yield
assertMixedContentBlockingState
(
gBrowser
{
activeLoaded
:
false
activeBlocked
:
true
passiveLoaded
:
false
}
)
;
is
(
content
.
document
.
getElementById
(
'
mctestdiv
'
)
.
innerHTML
"
Mixed
Content
Blocker
enabled
"
"
OK
:
Blocked
mixed
script
"
)
;
}
)
;
}
)
;
add_task
(
function
*
test_same_origin_metarefresh_same_origin
(
)
{
yield
doTest
(
gHttpTestRoot1
+
"
file_bug906190_1
.
html
"
gHttpTestRoot1
+
"
file_bug906190_3_4
.
html
"
function
*
(
)
{
yield
assertMixedContentBlockingState
(
gBrowser
{
activeLoaded
:
true
activeBlocked
:
false
passiveLoaded
:
false
}
)
;
is
(
content
.
document
.
getElementById
(
'
mctestdiv
'
)
.
innerHTML
"
Mixed
Content
Blocker
disabled
"
"
OK
:
Executed
mixed
script
"
)
;
}
true
)
;
}
)
;
add_task
(
function
*
test_same_origin_metarefresh_different_origin
(
)
{
yield
doTest
(
gHttpTestRoot2
+
"
file_bug906190_1
.
html
"
gHttpTestRoot2
+
"
file_bug906190_3_4
.
html
"
function
*
(
)
{
yield
assertMixedContentBlockingState
(
gBrowser
{
activeLoaded
:
false
activeBlocked
:
true
passiveLoaded
:
false
}
)
;
is
(
content
.
document
.
getElementById
(
'
mctestdiv
'
)
.
innerHTML
"
Mixed
Content
Blocker
enabled
"
"
OK
:
Blocked
mixed
script
"
)
;
}
true
)
;
}
)
;
add_task
(
function
*
test_same_origin_302redirect_same_origin
(
)
{
yield
doTest
(
gHttpTestRoot1
+
"
file_bug906190_1
.
html
"
gHttpTestRoot1
+
"
file_bug906190
.
sjs
"
function
*
(
)
{
ok
(
!
gIdentityHandler
.
_identityBox
.
classList
.
contains
(
"
mixedActiveBlocked
"
)
"
OK
:
Mixed
Content
is
NOT
being
blocked
"
)
;
is
(
content
.
document
.
getElementById
(
'
mctestdiv
'
)
.
innerHTML
"
Mixed
Content
Blocker
disabled
"
"
OK
:
Executed
mixed
script
"
)
;
}
)
;
}
)
;
add_task
(
function
*
test_same_origin_302redirect_different_origin
(
)
{
yield
doTest
(
gHttpTestRoot2
+
"
file_bug906190_1
.
html
"
gHttpTestRoot2
+
"
file_bug906190
.
sjs
"
function
*
(
)
{
yield
assertMixedContentBlockingState
(
gBrowser
{
activeLoaded
:
false
activeBlocked
:
true
passiveLoaded
:
false
}
)
;
is
(
content
.
document
.
getElementById
(
'
mctestdiv
'
)
.
innerHTML
"
Mixed
Content
Blocker
enabled
"
"
OK
:
Blocked
mixed
script
"
)
;
}
)
;
}
)
;
add_task
(
function
*
test_bad_redirection
(
)
{
yield
doTest
(
gHttpTestRoot2
+
"
file_bug906190_1
.
html
"
gHttpTestRoot2
+
"
file_bug906190
.
sjs
?
bad
-
redirection
=
1
"
function
*
(
)
{
ok
(
true
"
Nothing
to
do
"
)
;
}
)
;
}
)
;
