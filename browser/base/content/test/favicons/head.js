ChromeUtils
.
defineESModuleGetters
(
this
{
LinkHandlerParent
:
"
resource
:
/
/
/
actors
/
LinkHandlerParent
.
sys
.
mjs
"
PlacesTestUtils
:
"
resource
:
/
/
testing
-
common
/
PlacesTestUtils
.
sys
.
mjs
"
PlacesUtils
:
"
resource
:
/
/
gre
/
modules
/
PlacesUtils
.
sys
.
mjs
"
XPCShellContentUtils
:
"
resource
:
/
/
testing
-
common
/
XPCShellContentUtils
.
sys
.
mjs
"
}
)
;
Services
.
cache2
.
clear
(
)
;
function
waitForFaviconMessage
(
isTabIcon
=
undefined
expectedURL
=
undefined
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
listener
=
(
name
data
)
=
>
{
if
(
name
!
=
"
SetIcon
"
&
&
name
!
=
"
SetFailedIcon
"
)
{
return
;
}
if
(
isTabIcon
!
=
undefined
&
&
isTabIcon
!
=
data
.
canUseForTab
)
{
return
;
}
if
(
expectedURL
&
&
data
.
originalURL
!
=
expectedURL
)
{
return
;
}
LinkHandlerParent
.
removeListenerForTests
(
listener
)
;
if
(
name
=
=
"
SetIcon
"
)
{
resolve
(
{
iconURL
:
data
.
originalURL
dataURL
:
data
.
iconURL
canUseForTab
:
data
.
canUseForTab
isRichIcon
:
data
.
isRichIcon
}
)
;
}
else
{
reject
(
{
iconURL
:
data
.
originalURL
canUseForTab
:
data
.
canUseForTab
isRichIcon
:
data
.
isRichIcon
}
)
;
}
}
;
LinkHandlerParent
.
addListenerForTests
(
listener
)
;
}
)
;
}
function
waitForFavicon
(
browser
url
)
{
return
new
Promise
(
resolve
=
>
{
let
listener
=
{
onLinkIconAvailable
(
b
dataURI
iconURI
)
{
if
(
b
!
=
=
browser
|
|
iconURI
!
=
url
)
{
return
;
}
gBrowser
.
removeTabsProgressListener
(
listener
)
;
resolve
(
)
;
}
}
;
gBrowser
.
addTabsProgressListener
(
listener
)
;
}
)
;
}
function
waitForLinkAvailable
(
browser
)
{
let
resolve
reject
;
let
listener
=
{
onLinkIconAvailable
(
b
dataURI
iconURI
)
{
if
(
browser
!
=
=
b
|
|
!
iconURI
)
{
return
;
}
gBrowser
.
removeTabsProgressListener
(
listener
)
;
resolve
(
iconURI
)
;
}
}
;
let
promise
=
new
Promise
(
(
res
rej
)
=
>
{
resolve
=
res
;
reject
=
rej
;
gBrowser
.
addTabsProgressListener
(
listener
)
;
}
)
;
promise
.
cancel
=
(
)
=
>
{
gBrowser
.
removeTabsProgressListener
(
listener
)
;
reject
(
)
;
}
;
return
promise
;
}
