"
use
strict
"
;
requestLongerTimeout
(
5
)
;
const
EXPECTED_REFLOWS_FIRST_OPEN
=
[
{
stack
:
[
"
_rebuild
chrome
:
/
/
browser
/
content
/
search
/
search
.
xml
"
"
set_popup
chrome
:
/
/
browser
/
content
/
search
/
search
.
xml
"
"
enableOneOffSearches
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
_enableOrDisableOneOffSearches
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
urlbar_XBL_Constructor
/
<
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
}
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
handleOverUnderflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_reuseAcItem
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_appendCurrentResult
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
maxCount
:
60
}
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
handleOverUnderflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
maxCount
:
6
}
{
stack
:
[
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
}
]
;
if
(
AppConstants
.
RELEASE_OR_BETA
)
{
EXPECTED_REFLOWS_FIRST_OPEN
.
push
(
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_onUnderflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
onunderflow
chrome
:
/
/
browser
/
content
/
browser
.
xul
"
]
maxCount
:
6
}
)
;
EXPECTED_REFLOWS_FIRST_OPEN
.
push
(
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_onOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
onoverflow
chrome
:
/
/
browser
/
content
/
browser
.
xul
"
]
maxCount
:
6
}
)
;
EXPECTED_REFLOWS_FIRST_OPEN
.
push
(
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_adjustAcItem
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_appendCurrentResult
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
maxCount
:
12
}
)
;
}
async
function
promiseSearchComplete
(
win
)
{
let
URLBar
=
win
.
gURLBar
;
if
(
URLBar
.
popup
.
state
!
=
"
open
"
)
{
await
BrowserTestUtils
.
waitForEvent
(
URLBar
.
popup
"
popupshown
"
)
;
}
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
URLBar
.
controller
.
searchStatus
>
=
Ci
.
nsIAutoCompleteController
.
STATUS_COMPLETE_NO_MATCH
;
}
)
;
await
new
Promise
(
resolve
=
>
win
.
requestIdleCallback
(
resolve
{
timeout
:
1000
}
)
)
;
}
add_task
(
async
function
setup
(
)
{
await
addDummyHistoryEntries
(
)
;
}
)
;
add_task
(
async
function
(
)
{
let
win
=
await
prepareSettledWindow
(
)
;
let
URLBar
=
win
.
gURLBar
;
let
popup
=
URLBar
.
popup
;
URLBar
.
focus
(
)
;
URLBar
.
value
=
"
"
;
let
dropmarkerRect
=
document
.
getAnonymousElementByAttribute
(
gURLBar
"
anonid
"
"
historydropmarker
"
)
.
getBoundingClientRect
(
)
;
let
textBoxRect
=
document
.
getAnonymousElementByAttribute
(
gURLBar
"
anonid
"
"
moz
-
input
-
box
"
)
.
getBoundingClientRect
(
)
;
await
withPerfObserver
(
async
function
(
)
{
let
oldInvalidate
=
popup
.
invalidate
.
bind
(
popup
)
;
let
oldResultsAdded
=
popup
.
onResultsAdded
.
bind
(
popup
)
;
popup
.
invalidate
=
(
reason
)
=
>
{
dirtyFrame
(
win
)
;
oldInvalidate
(
reason
)
;
}
;
popup
.
onResultsAdded
=
(
)
=
>
{
dirtyFrame
(
win
)
;
oldResultsAdded
(
)
;
}
;
const
SEARCH_TERM
=
"
ows
-
10
"
;
for
(
let
i
=
0
;
i
<
SEARCH_TERM
.
length
;
+
+
i
)
{
let
char
=
SEARCH_TERM
[
i
]
;
EventUtils
.
synthesizeKey
(
char
{
}
win
)
;
await
promiseSearchComplete
(
win
)
;
}
let
hiddenPromise
=
BrowserTestUtils
.
waitForEvent
(
URLBar
.
popup
"
popuphidden
"
)
;
EventUtils
.
synthesizeKey
(
"
VK_ESCAPE
"
{
}
win
)
;
await
hiddenPromise
;
}
{
expectedReflows
:
EXPECTED_REFLOWS_FIRST_OPEN
frames
:
{
filter
:
rects
=
>
rects
.
filter
(
r
=
>
!
(
(
r
.
x1
>
=
textBoxRect
.
left
&
&
r
.
x2
<
=
textBoxRect
.
right
&
&
r
.
y1
>
=
textBoxRect
.
top
&
&
r
.
y2
<
=
textBoxRect
.
bottom
)
|
|
(
r
.
x1
>
=
dropmarkerRect
.
left
-
1
&
&
r
.
x2
<
=
dropmarkerRect
.
right
+
1
&
&
r
.
y1
>
=
dropmarkerRect
.
top
&
&
r
.
y2
<
=
dropmarkerRect
.
bottom
)
)
)
}
}
win
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
