"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
CustomizableUITestUtils
.
jsm
"
this
)
;
let
gCUITestUtils
=
new
CustomizableUITestUtils
(
window
)
;
const
EXPECTED_APPMENU_OPEN_REFLOWS
=
[
{
stack
:
[
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
"
openPopup
/
this
.
_openPopupPromise
<
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
]
}
{
stack
:
[
"
get_alignmentPosition
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
"
adjustArrowPosition
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
"
onxblpopuppositioned
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
]
}
{
stack
:
[
"
get_alignmentPosition
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
"
_calculateMaxHeight
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
"
handleEvent
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
]
}
{
stack
:
[
"
_calculateMaxHeight
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
"
handleEvent
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
]
maxCount
:
6
}
]
;
add_task
(
async
function
(
)
{
await
ensureNoPreloadedBrowser
(
)
;
await
withReflowObserver
(
(
)
=
>
gCUITestUtils
.
openMainMenu
(
)
EXPECTED_APPMENU_OPEN_REFLOWS
)
;
await
withReflowObserver
(
async
function
(
)
{
async
function
openSubViewsRecursively
(
currentView
)
{
let
navButtons
=
Array
.
from
(
currentView
.
querySelectorAll
(
"
.
subviewbutton
-
nav
"
)
)
;
if
(
!
navButtons
)
{
return
;
}
for
(
let
button
of
navButtons
)
{
info
(
"
Click
"
+
button
.
id
)
;
let
promiseViewShown
=
BrowserTestUtils
.
waitForEvent
(
PanelUI
.
panel
"
ViewShown
"
)
;
button
.
click
(
)
;
let
viewShownEvent
=
await
promiseViewShown
;
let
container
=
PanelUI
.
multiView
.
querySelector
(
"
.
panel
-
viewcontainer
"
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
!
container
.
hasAttribute
(
"
width
"
)
;
}
)
;
info
(
"
Shown
"
+
viewShownEvent
.
originalTarget
.
id
)
;
await
openSubViewsRecursively
(
viewShownEvent
.
originalTarget
)
;
promiseViewShown
=
BrowserTestUtils
.
waitForEvent
(
currentView
"
ViewShown
"
)
;
PanelUI
.
multiView
.
goBack
(
)
;
await
promiseViewShown
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
!
container
.
hasAttribute
(
"
width
"
)
;
}
)
;
}
}
await
openSubViewsRecursively
(
PanelUI
.
mainView
)
;
await
gCUITestUtils
.
hideMainMenu
(
)
;
}
[
]
)
;
}
)
;
