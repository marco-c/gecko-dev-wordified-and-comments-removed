"
use
strict
"
;
requestLongerTimeout
(
5
)
;
XPCOMUtils
.
defineLazyModuleGetter
(
this
"
PlacesTestUtils
"
"
resource
:
/
/
testing
-
common
/
PlacesTestUtils
.
jsm
"
)
;
const
EXPECTED_REFLOWS_FIRST_OPEN
=
[
{
stack
:
[
"
_rebuild
chrome
:
/
/
browser
/
content
/
search
/
search
.
xml
"
"
set_popup
chrome
:
/
/
browser
/
content
/
search
/
search
.
xml
"
"
enableOneOffSearches
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
_enableOrDisableOneOffSearches
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
urlbar_XBL_Constructor
/
<
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
1
}
{
stack
:
[
"
adjustSiteIconStart
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_siteIconStart
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
}
{
stack
:
[
"
adjustSiteIconStart
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_reuseAcItem
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_appendCurrentResult
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
9
}
{
stack
:
[
"
adjustHeight
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
onxblpopupshown
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
5
}
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
handleOverUnderflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_siteIconStart
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
6
}
{
stack
:
[
"
adjustHeight
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_invalidate
/
this
.
_adjustHeightTimeout
<
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
3
}
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
handleOverUnderflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_reuseAcItem
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_appendCurrentResult
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
390
}
{
stack
:
[
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
3
}
{
stack
:
[
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
}
]
;
const
EXPECTED_REFLOWS_SECOND_OPEN
=
[
{
stack
:
[
"
adjustHeight
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
onxblpopupshown
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
3
}
{
stack
:
[
"
adjustHeight
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_invalidate
/
this
.
_adjustHeightTimeout
<
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
3
}
{
stack
:
[
"
_handleOverflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
handleOverUnderflow
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_reuseAcItem
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_appendCurrentResult
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
_invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
invalidate
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
444
}
{
stack
:
[
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
times
:
3
}
{
stack
:
[
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
popup
.
xml
"
"
_openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openAutocompletePopup
chrome
:
/
/
browser
/
content
/
urlbarBindings
.
xml
"
"
openPopup
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
"
set_popupOpen
chrome
:
/
/
global
/
content
/
bindings
/
autocomplete
.
xml
"
]
}
]
;
async
function
promiseAutocompleteResultPopup
(
win
)
{
let
URLBar
=
win
.
gURLBar
;
URLBar
.
controller
.
startSearch
(
URLBar
.
value
)
;
await
BrowserTestUtils
.
waitForEvent
(
URLBar
.
popup
"
popupshown
"
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
URLBar
.
controller
.
searchStatus
>
=
Ci
.
nsIAutoCompleteController
.
STATUS_COMPLETE_NO_MATCH
;
}
)
;
let
matchCount
=
URLBar
.
popup
.
_matchCount
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
URLBar
.
popup
.
richlistbox
.
childNodes
.
length
=
=
matchCount
;
}
)
;
URLBar
.
controller
.
stopSearch
(
)
;
await
new
Promise
(
resolve
=
>
win
.
requestIdleCallback
(
resolve
{
timeout
:
1000
}
)
)
;
let
hiddenPromise
=
BrowserTestUtils
.
waitForEvent
(
URLBar
.
popup
"
popuphidden
"
)
;
EventUtils
.
synthesizeKey
(
"
VK_ESCAPE
"
{
}
win
)
;
await
hiddenPromise
;
}
const
SEARCH_TERM
=
"
urlbar
-
reflows
"
;
add_task
(
async
function
setup
(
)
{
const
NUM_VISITS
=
10
;
let
visits
=
[
]
;
for
(
let
i
=
0
;
i
<
NUM_VISITS
;
+
+
i
)
{
visits
.
push
(
{
uri
:
http
:
/
/
example
.
com
/
urlbar
-
reflows
-
{
i
}
title
:
Reflow
test
for
URL
bar
entry
#
{
i
}
}
)
;
}
await
PlacesTestUtils
.
addVisits
(
visits
)
;
registerCleanupFunction
(
async
function
(
)
{
await
PlacesTestUtils
.
clearHistory
(
)
;
}
)
;
}
)
;
add_task
(
async
function
(
)
{
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
await
ensureNoPreloadedBrowser
(
win
)
;
let
URLBar
=
win
.
gURLBar
;
let
popup
=
URLBar
.
popup
;
URLBar
.
focus
(
)
;
URLBar
.
value
=
SEARCH_TERM
;
let
testFn
=
async
function
(
dirtyFrameFn
)
{
let
oldInvalidate
=
popup
.
invalidate
.
bind
(
popup
)
;
let
oldResultsAdded
=
popup
.
onResultsAdded
.
bind
(
popup
)
;
popup
.
invalidate
=
(
reason
)
=
>
{
dirtyFrameFn
(
)
;
oldInvalidate
(
reason
)
;
}
;
popup
.
onResultsAdded
=
(
)
=
>
{
dirtyFrameFn
(
)
;
oldResultsAdded
(
)
;
}
;
await
promiseAutocompleteResultPopup
(
win
)
;
}
;
await
withReflowObserver
(
testFn
EXPECTED_REFLOWS_FIRST_OPEN
win
)
;
await
withReflowObserver
(
testFn
EXPECTED_REFLOWS_SECOND_OPEN
win
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
