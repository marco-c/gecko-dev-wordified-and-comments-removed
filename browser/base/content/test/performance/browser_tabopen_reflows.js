"
use
strict
"
;
const
EXPECTED_REFLOWS
=
[
[
"
select
chrome
:
/
/
global
/
content
/
bindings
/
textbox
.
xml
"
"
focusAndSelectUrlBar
chrome
:
/
/
browser
/
content
/
browser
.
js
"
"
openLinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
openUILinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
BrowserOpenTab
chrome
:
/
/
browser
/
content
/
browser
.
js
"
]
[
"
select
chrome
:
/
/
global
/
content
/
bindings
/
textbox
.
xml
"
"
focusAndSelectUrlBar
chrome
:
/
/
browser
/
content
/
browser
.
js
"
"
openLinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
openUILinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
BrowserOpenTab
chrome
:
/
/
browser
/
content
/
browser
.
js
"
]
[
"
select
chrome
:
/
/
global
/
content
/
bindings
/
textbox
.
xml
"
"
focusAndSelectUrlBar
chrome
:
/
/
browser
/
content
/
browser
.
js
"
"
openLinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
openUILinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
BrowserOpenTab
chrome
:
/
/
browser
/
content
/
browser
.
js
"
]
[
"
openLinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
openUILinkIn
chrome
:
/
/
browser
/
content
/
utilityOverlay
.
js
"
"
BrowserOpenTab
chrome
:
/
/
browser
/
content
/
browser
.
js
"
]
[
"
_adjustFocusAfterTabSwitch
chrome
:
/
/
browser
/
content
/
tabbrowser
.
xml
"
"
updateDisplay
chrome
:
/
/
browser
/
content
/
tabbrowser
.
xml
"
"
postActions
chrome
:
/
/
browser
/
content
/
tabbrowser
.
xml
"
"
requestTab
chrome
:
/
/
browser
/
content
/
tabbrowser
.
xml
"
]
]
;
if
(
!
gMultiProcessBrowser
)
{
EXPECTED_REFLOWS
.
push
(
[
"
_adjustFocusAfterTabSwitch
chrome
:
/
/
browser
/
content
/
tabbrowser
.
xml
"
"
updateCurrentBrowser
chrome
:
/
/
browser
/
content
/
tabbrowser
.
xml
"
"
onselect
chrome
:
/
/
browser
/
content
/
browser
.
xul
"
]
)
;
}
add_task
(
async
function
(
)
{
let
preloaded
=
gBrowser
.
_getPreloadedBrowser
(
)
;
if
(
preloaded
)
{
preloaded
.
remove
(
)
;
}
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
newtab
.
preload
"
false
]
]
}
)
;
let
aboutNewTabService
=
Cc
[
"
mozilla
.
org
/
browser
/
aboutnewtab
-
service
;
1
"
]
.
getService
(
Ci
.
nsIAboutNewTabService
)
;
aboutNewTabService
.
newTabURL
=
"
about
:
blank
"
;
registerCleanupFunction
(
(
)
=
>
{
aboutNewTabService
.
resetNewTabURL
(
)
;
}
)
;
let
origTab
=
gBrowser
.
selectedTab
;
await
withReflowObserver
(
async
function
(
)
{
let
switchDone
=
BrowserTestUtils
.
waitForEvent
(
window
"
TabSwitchDone
"
)
;
BrowserOpenTab
(
)
;
await
BrowserTestUtils
.
waitForEvent
(
gBrowser
.
selectedTab
"
transitionend
"
false
e
=
>
e
.
propertyName
=
=
=
"
max
-
width
"
)
;
await
switchDone
;
}
EXPECTED_REFLOWS
window
origTab
)
;
let
switchDone
=
BrowserTestUtils
.
waitForEvent
(
window
"
TabSwitchDone
"
)
;
await
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
await
switchDone
;
}
)
;
