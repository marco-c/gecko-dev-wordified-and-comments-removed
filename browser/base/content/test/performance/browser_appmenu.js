"
use
strict
"
;
const
{
CustomizableUITestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
CustomizableUITestUtils
.
jsm
"
)
;
let
gCUITestUtils
=
new
CustomizableUITestUtils
(
window
)
;
const
EXPECTED_APPMENU_OPEN_REFLOWS
=
[
{
stack
:
[
"
openPopup
/
this
.
_openPopupPromise
<
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
]
}
{
stack
:
[
"
_calculateMaxHeight
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
"
handleEvent
resource
:
/
/
/
modules
/
PanelMultiView
.
jsm
"
]
maxCount
:
7
}
]
;
add_task
(
async
function
(
)
{
await
ensureNoPreloadedBrowser
(
)
;
await
disableFxaBadge
(
)
;
let
textBoxRect
=
gURLBar
.
querySelector
(
"
moz
-
input
-
box
"
)
.
getBoundingClientRect
(
)
;
let
menuButtonRect
=
document
.
getElementById
(
"
PanelUI
-
menu
-
button
"
)
.
getBoundingClientRect
(
)
;
let
firstTabRect
=
gBrowser
.
selectedTab
.
getBoundingClientRect
(
)
;
let
frameExpectations
=
{
filter
:
rects
=
>
{
return
rects
.
filter
(
r
=
>
!
rectInBoundingClientRect
(
r
menuButtonRect
)
)
;
}
exceptions
:
[
{
name
:
"
the
urlbar
placeholder
moves
up
and
down
by
a
few
pixels
"
condition
:
r
=
>
rectInBoundingClientRect
(
r
textBoxRect
)
}
{
name
:
"
bug
1547341
-
a
first
tab
gets
drawn
early
"
condition
:
r
=
>
rectInBoundingClientRect
(
r
firstTabRect
)
}
]
}
;
await
withPerfObserver
(
(
)
=
>
gCUITestUtils
.
openMainMenu
(
)
{
expectedReflows
:
EXPECTED_APPMENU_OPEN_REFLOWS
frames
:
frameExpectations
}
)
;
await
withPerfObserver
(
async
function
(
)
{
async
function
openSubViewsRecursively
(
currentView
)
{
let
navButtons
=
Array
.
from
(
currentView
.
querySelectorAll
(
"
.
subviewbutton
-
nav
:
not
(
[
disabled
]
)
"
)
)
;
if
(
!
navButtons
)
{
return
;
}
for
(
let
button
of
navButtons
)
{
info
(
"
Click
"
+
button
.
id
)
;
let
promiseViewShown
=
BrowserTestUtils
.
waitForEvent
(
PanelUI
.
panel
"
ViewShown
"
)
;
button
.
click
(
)
;
let
viewShownEvent
=
await
promiseViewShown
;
let
container
=
PanelUI
.
multiView
.
querySelector
(
"
.
panel
-
viewcontainer
"
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
return
!
container
.
hasAttribute
(
"
width
"
)
;
}
)
;
info
(
"
Shown
"
+
viewShownEvent
.
originalTarget
.
id
)
;
await
openSubViewsRecursively
(
viewShownEvent
.
originalTarget
)
;
promiseViewShown
=
BrowserTestUtils
.
waitForEvent
(
currentView
"
ViewShown
"
)
;
PanelUI
.
multiView
.
goBack
(
)
;
await
promiseViewShown
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
return
!
container
.
hasAttribute
(
"
width
"
)
;
}
)
;
}
}
await
openSubViewsRecursively
(
PanelUI
.
mainView
)
;
await
gCUITestUtils
.
hideMainMenu
(
)
;
}
{
expectedReflows
:
[
]
frames
:
frameExpectations
}
)
;
}
)
;
