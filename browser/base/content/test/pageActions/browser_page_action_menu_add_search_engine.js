"
use
strict
"
;
add_task
(
async
function
none
(
)
{
let
url
=
"
http
:
/
/
mochi
.
test
:
8888
/
"
;
await
BrowserTestUtils
.
withNewTab
(
url
async
(
)
=
>
{
await
promisePageActionPanelOpen
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
BrowserPageActions
.
mainButtonNode
{
}
)
;
await
promisePageActionPanelHidden
(
)
;
let
actions
=
PageActions
.
actionsInPanel
(
window
)
;
Assert
.
ok
(
!
actions
.
some
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
"
Action
should
not
be
present
in
panel
"
)
;
let
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
button
"
Action
button
should
not
be
in
panel
"
)
;
}
)
;
}
)
;
add_task
(
async
function
one
(
)
{
let
url
=
getRootDirectory
(
gTestPath
)
+
"
page_action_menu_add_search_engine_one
.
html
"
;
await
BrowserTestUtils
.
withNewTab
(
url
async
(
)
=
>
{
await
promisePageActionPanelOpen
(
)
;
let
actions
=
PageActions
.
actionsInPanel
(
window
)
;
let
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
panel
"
)
;
let
expectedTitle
=
"
Add
Search
Engine
"
;
Assert
.
equal
(
action
.
getTitle
(
window
)
expectedTitle
"
Action
title
"
)
;
let
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
button
"
Button
should
be
in
panel
"
)
;
Assert
.
equal
(
button
.
label
expectedTitle
"
Button
label
"
)
;
Assert
.
equal
(
button
.
classList
.
contains
(
"
subviewbutton
-
nav
"
)
false
"
Button
should
not
expand
into
a
subview
"
)
;
let
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_0
"
)
;
let
hiddenPromise
=
promisePageActionPanelHidden
(
)
;
let
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
await
hiddenPromise
;
let
engine
=
await
enginePromise
;
let
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
)
;
await
promisePageActionPanelOpen
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
BrowserPageActions
.
mainButtonNode
{
}
)
;
await
promisePageActionPanelHidden
(
)
;
actions
=
PageActions
.
actionsInPanel
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
action
"
Action
should
not
be
present
in
panel
"
)
;
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
button
"
Action
button
should
not
be
in
panel
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_0
"
)
;
await
Services
.
search
.
removeEngine
(
engine
)
;
await
enginePromise
;
await
promisePageActionPanelOpen
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
BrowserPageActions
.
mainButtonNode
{
}
)
;
await
promisePageActionPanelHidden
(
)
;
actions
=
PageActions
.
actionsInPanel
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
panel
"
)
;
Assert
.
equal
(
action
.
getTitle
(
window
)
expectedTitle
"
Action
title
"
)
;
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
button
"
Action
button
should
be
in
panel
"
)
;
Assert
.
equal
(
button
.
label
expectedTitle
"
Button
label
"
)
;
Assert
.
equal
(
button
.
classList
.
contains
(
"
subviewbutton
-
nav
"
)
false
"
Button
should
not
expand
into
a
subview
"
)
;
}
)
;
}
)
;
add_task
(
async
function
many
(
)
{
let
url
=
getRootDirectory
(
gTestPath
)
+
"
page_action_menu_add_search_engine_many
.
html
"
;
await
BrowserTestUtils
.
withNewTab
(
url
async
(
)
=
>
{
await
promisePageActionPanelOpen
(
)
;
let
actions
=
PageActions
.
actionsInPanel
(
window
)
;
let
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
panel
"
)
;
let
expectedTitle
=
"
Add
Search
Engine
"
;
Assert
.
equal
(
action
.
getTitle
(
window
)
expectedTitle
"
Action
title
"
)
;
let
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
button
"
Action
button
should
be
in
panel
"
)
;
Assert
.
equal
(
button
.
label
expectedTitle
"
Button
label
"
)
;
Assert
.
equal
(
button
.
classList
.
contains
(
"
subviewbutton
-
nav
"
)
true
"
Button
should
expand
into
a
subview
"
)
;
let
viewPromise
=
promisePageActionViewShown
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
let
view
=
await
viewPromise
;
let
viewID
=
BrowserPageActions
.
_panelViewNodeIDForActionID
(
"
addSearchEngine
"
false
)
;
Assert
.
equal
(
view
.
id
viewID
"
View
ID
"
)
;
let
bodyID
=
viewID
+
"
-
body
"
;
let
body
=
document
.
getElementById
(
bodyID
)
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_0
"
"
page_action_menu_add_search_engine_1
"
"
page_action_menu_add_search_engine_2
"
]
"
Subview
children
"
)
;
let
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_0
"
)
;
let
hiddenPromise
=
promisePageActionPanelHidden
(
)
;
let
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
body
.
children
[
0
]
{
}
)
;
await
hiddenPromise
;
let
engines
=
[
]
;
let
engine
=
await
enginePromise
;
engines
.
push
(
engine
)
;
let
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
"
Feedback
text
"
)
;
await
promisePageActionPanelOpen
(
)
;
viewPromise
=
promisePageActionViewShown
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
await
viewPromise
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_1
"
"
page_action_menu_add_search_engine_2
"
]
"
Subview
children
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_1
"
)
;
hiddenPromise
=
promisePageActionPanelHidden
(
)
;
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
body
.
children
[
0
]
{
}
)
;
await
hiddenPromise
;
engine
=
await
enginePromise
;
engines
.
push
(
engine
)
;
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
"
Feedback
text
"
)
;
await
promisePageActionPanelOpen
(
)
;
actions
=
PageActions
.
actionsInPanel
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
panel
"
)
;
expectedTitle
=
"
Add
Search
Engine
"
;
Assert
.
equal
(
action
.
getTitle
(
window
)
expectedTitle
"
Action
title
"
)
;
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
button
"
Button
should
be
present
in
panel
"
)
;
Assert
.
equal
(
button
.
label
expectedTitle
"
Button
label
"
)
;
Assert
.
equal
(
button
.
classList
.
contains
(
"
subviewbutton
-
nav
"
)
false
"
Button
should
not
expand
into
a
subview
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_2
"
)
;
hiddenPromise
=
promisePageActionPanelHidden
(
)
;
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
await
hiddenPromise
;
engine
=
await
enginePromise
;
engines
.
push
(
engine
)
;
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
"
Feedback
text
"
)
;
await
promisePageActionPanelOpen
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
BrowserPageActions
.
mainButtonNode
{
}
)
;
await
promisePageActionPanelHidden
(
)
;
actions
=
PageActions
.
actionsInPanel
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
action
"
Action
should
be
gone
"
)
;
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
button
"
Button
should
not
be
in
panel
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_0
"
)
;
await
Services
.
search
.
removeEngine
(
engines
.
shift
(
)
)
;
await
enginePromise
;
await
promisePageActionPanelOpen
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
BrowserPageActions
.
mainButtonNode
{
}
)
;
await
promisePageActionPanelHidden
(
)
;
actions
=
PageActions
.
actionsInPanel
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
panel
"
)
;
expectedTitle
=
"
Add
Search
Engine
"
;
Assert
.
equal
(
action
.
getTitle
(
window
)
expectedTitle
"
Action
title
"
)
;
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
button
"
Button
should
be
present
in
panel
"
)
;
Assert
.
equal
(
button
.
label
expectedTitle
"
Button
label
"
)
;
Assert
.
equal
(
button
.
classList
.
contains
(
"
subviewbutton
-
nav
"
)
false
"
Button
should
not
expand
into
a
subview
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_1
"
)
;
await
Services
.
search
.
removeEngine
(
engines
.
shift
(
)
)
;
await
enginePromise
;
await
promisePageActionPanelOpen
(
)
;
actions
=
PageActions
.
actionsInPanel
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
panel
"
)
;
expectedTitle
=
"
Add
Search
Engine
"
;
Assert
.
equal
(
action
.
getTitle
(
window
)
expectedTitle
"
Action
title
"
)
;
button
=
BrowserPageActions
.
panelButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
button
"
Button
should
be
in
panel
"
)
;
Assert
.
equal
(
button
.
label
expectedTitle
"
Button
label
"
)
;
Assert
.
equal
(
button
.
classList
.
contains
(
"
subviewbutton
-
nav
"
)
true
"
Button
should
expand
into
a
subview
"
)
;
viewPromise
=
promisePageActionViewShown
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
await
viewPromise
;
body
=
document
.
getElementById
(
bodyID
)
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_0
"
"
page_action_menu_add_search_engine_1
"
]
"
Subview
children
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
BrowserPageActions
.
mainButtonNode
{
}
)
;
await
promisePageActionPanelHidden
(
)
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_2
"
)
;
await
Services
.
search
.
removeEngine
(
engines
.
shift
(
)
)
;
await
enginePromise
;
await
promisePageActionPanelOpen
(
)
;
viewPromise
=
promisePageActionViewShown
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
await
viewPromise
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_0
"
"
page_action_menu_add_search_engine_1
"
"
page_action_menu_add_search_engine_2
"
]
"
Subview
children
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
BrowserPageActions
.
mainButtonNode
{
}
)
;
await
promisePageActionPanelHidden
(
)
;
}
)
;
}
)
;
add_task
(
async
function
urlbarOne
(
)
{
let
url
=
getRootDirectory
(
gTestPath
)
+
"
page_action_menu_add_search_engine_one
.
html
"
;
await
BrowserTestUtils
.
withNewTab
(
url
async
(
)
=
>
{
await
promiseNodeVisible
(
BrowserPageActions
.
mainButtonNode
)
;
let
placedPromise
=
promisePlacedInUrlbar
(
)
;
PageActions
.
actionForID
(
"
addSearchEngine
"
)
.
pinnedToUrlbar
=
true
;
let
button
=
await
placedPromise
;
let
actions
=
PageActions
.
actionsInUrlbar
(
window
)
;
let
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
urlbar
"
)
;
Assert
.
ok
(
button
"
Action
button
should
be
in
urlbar
"
)
;
let
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_0
"
)
;
let
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
let
engine
=
await
enginePromise
;
let
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
)
;
actions
=
PageActions
.
actionsInUrlbar
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
action
"
Action
should
not
be
present
in
urlbar
"
)
;
button
=
BrowserPageActions
.
urlbarButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
button
"
Action
button
should
not
be
in
urlbar
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_0
"
)
;
placedPromise
=
promisePlacedInUrlbar
(
)
;
await
Services
.
search
.
removeEngine
(
engine
)
;
await
enginePromise
;
button
=
await
placedPromise
;
actions
=
PageActions
.
actionsInUrlbar
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
urlbar
"
)
;
Assert
.
ok
(
button
"
Action
button
should
be
in
urlbar
"
)
;
PageActions
.
actionForID
(
"
addSearchEngine
"
)
.
pinnedToUrlbar
=
false
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
!
BrowserPageActions
.
urlbarButtonNodeForActionID
(
"
addSearchEngine
"
)
;
}
)
;
}
)
;
}
)
;
add_task
(
async
function
urlbarMany
(
)
{
let
url
=
getRootDirectory
(
gTestPath
)
+
"
page_action_menu_add_search_engine_many
.
html
"
;
await
BrowserTestUtils
.
withNewTab
(
url
async
(
)
=
>
{
await
promiseNodeVisible
(
BrowserPageActions
.
mainButtonNode
)
;
let
placedPromise
=
promisePlacedInUrlbar
(
)
;
PageActions
.
actionForID
(
"
addSearchEngine
"
)
.
pinnedToUrlbar
=
true
;
let
button
=
await
placedPromise
;
let
actions
=
PageActions
.
actionsInUrlbar
(
window
)
;
let
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
urlbar
"
)
;
Assert
.
ok
(
button
"
Action
button
should
be
in
urlbar
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
let
view
=
await
waitForActivatedActionPanel
(
)
;
let
viewID
=
BrowserPageActions
.
_panelViewNodeIDForActionID
(
"
addSearchEngine
"
true
)
;
Assert
.
equal
(
view
.
id
viewID
"
View
ID
"
)
;
let
body
=
view
.
firstElementChild
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_0
"
"
page_action_menu_add_search_engine_1
"
"
page_action_menu_add_search_engine_2
"
]
"
Subview
children
"
)
;
let
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_0
"
)
;
let
hiddenPromise
=
promisePanelHidden
(
BrowserPageActions
.
activatedActionPanelNode
)
;
let
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
body
.
children
[
0
]
{
}
)
;
await
hiddenPromise
;
let
engines
=
[
]
;
let
engine
=
await
enginePromise
;
engines
.
push
(
engine
)
;
let
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
"
Feedback
text
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
view
=
await
waitForActivatedActionPanel
(
)
;
body
=
view
.
firstElementChild
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_1
"
"
page_action_menu_add_search_engine_2
"
]
"
Subview
children
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_1
"
)
;
hiddenPromise
=
promisePanelHidden
(
BrowserPageActions
.
activatedActionPanelNode
)
;
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
body
.
children
[
0
]
{
}
)
;
await
hiddenPromise
;
engine
=
await
enginePromise
;
engines
.
push
(
engine
)
;
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
"
Feedback
text
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
added
"
"
page_action_menu_add_search_engine_2
"
)
;
feedbackPromise
=
promiseFeedbackPanelShownAndHidden
(
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
engine
=
await
enginePromise
;
engines
.
push
(
engine
)
;
feedbackText
=
await
feedbackPromise
;
Assert
.
equal
(
feedbackText
"
Search
engine
added
!
"
"
Feedback
text
"
)
;
actions
=
PageActions
.
actionsInUrlbar
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
action
"
Action
should
be
gone
"
)
;
button
=
BrowserPageActions
.
urlbarButtonNodeForActionID
(
"
addSearchEngine
"
)
;
Assert
.
ok
(
!
button
"
Button
should
not
be
in
urlbar
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_0
"
)
;
placedPromise
=
promisePlacedInUrlbar
(
)
;
await
Services
.
search
.
removeEngine
(
engines
.
shift
(
)
)
;
await
enginePromise
;
button
=
await
placedPromise
;
actions
=
PageActions
.
actionsInUrlbar
(
window
)
;
action
=
actions
.
find
(
a
=
>
a
.
id
=
=
"
addSearchEngine
"
)
;
Assert
.
ok
(
action
"
Action
should
be
present
in
urlbar
"
)
;
Assert
.
ok
(
button
"
Button
should
be
in
urlbar
"
)
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_1
"
)
;
await
Services
.
search
.
removeEngine
(
engines
.
shift
(
)
)
;
await
enginePromise
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
view
=
await
waitForActivatedActionPanel
(
)
;
body
=
view
.
firstElementChild
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_0
"
"
page_action_menu_add_search_engine_1
"
]
"
Subview
children
"
)
;
hiddenPromise
=
promisePanelHidden
(
BrowserPageActions
.
activatedActionPanelNode
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
await
hiddenPromise
;
enginePromise
=
promiseEngine
(
"
engine
-
removed
"
"
page_action_menu_add_search_engine_2
"
)
;
await
Services
.
search
.
removeEngine
(
engines
.
shift
(
)
)
;
await
enginePromise
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
view
=
await
waitForActivatedActionPanel
(
)
;
body
=
view
.
firstElementChild
;
Assert
.
deepEqual
(
Array
.
map
(
body
.
children
n
=
>
n
.
label
)
[
"
page_action_menu_add_search_engine_0
"
"
page_action_menu_add_search_engine_1
"
"
page_action_menu_add_search_engine_2
"
]
"
Subview
children
"
)
;
hiddenPromise
=
promisePanelHidden
(
BrowserPageActions
.
activatedActionPanelNode
)
;
EventUtils
.
synthesizeMouseAtCenter
(
button
{
}
)
;
await
hiddenPromise
;
PageActions
.
actionForID
(
"
addSearchEngine
"
)
.
pinnedToUrlbar
=
false
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
return
!
BrowserPageActions
.
urlbarButtonNodeForActionID
(
"
addSearchEngine
"
)
;
}
)
;
}
)
;
}
)
;
function
promiseEngine
(
expectedData
expectedEngineName
)
{
info
(
Waiting
for
engine
{
expectedData
}
)
;
return
TestUtils
.
topicObserved
(
"
browser
-
search
-
engine
-
modified
"
(
engine
data
)
=
>
{
info
(
Got
engine
{
engine
.
wrappedJSObject
.
name
}
{
data
}
)
;
return
expectedData
=
=
data
&
&
expectedEngineName
=
=
engine
.
wrappedJSObject
.
name
;
}
)
.
then
(
(
[
engine
data
]
)
=
>
engine
)
;
}
function
promiseFeedbackPanelShownAndHidden
(
)
{
info
(
"
Waiting
for
feedback
panel
popupshown
"
)
;
return
BrowserTestUtils
.
waitForEvent
(
ConfirmationHint
.
_panel
"
popupshown
"
)
.
then
(
(
)
=
>
{
info
(
"
Got
feedback
panel
popupshown
.
Now
waiting
for
popuphidden
"
)
;
return
BrowserTestUtils
.
waitForEvent
(
ConfirmationHint
.
_panel
"
popuphidden
"
)
.
then
(
(
)
=
>
ConfirmationHint
.
_message
.
textContent
)
;
}
)
;
}
function
promisePlacedInUrlbar
(
)
{
let
action
=
PageActions
.
actionForID
(
"
addSearchEngine
"
)
;
return
new
Promise
(
resolve
=
>
{
let
onPlaced
=
action
.
_onPlacedInUrlbar
;
action
.
_onPlacedInUrlbar
=
button
=
>
{
action
.
_onPlacedInUrlbar
=
onPlaced
;
if
(
action
.
_onPlacedInUrlbar
)
{
action
.
_onPlacedInUrlbar
(
button
)
;
}
promiseNodeVisible
(
button
)
.
then
(
(
)
=
>
resolve
(
button
)
)
;
}
;
}
)
;
}
