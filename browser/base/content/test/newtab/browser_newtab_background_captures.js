const
CAPTURE_PREF
=
"
browser
.
pagethumbnails
.
capturing_disabled
"
;
add_task
(
function
*
(
)
{
let
imports
=
{
}
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
PageThumbs
.
jsm
"
imports
)
;
yield
pushPrefs
(
[
CAPTURE_PREF
false
]
)
;
let
url
=
"
http
:
/
/
example
.
com
/
"
;
let
path
=
imports
.
PageThumbsStorage
.
getFilePathForURL
(
url
)
;
let
file
=
Cc
[
"
mozilla
.
org
/
file
/
local
;
1
"
]
.
createInstance
(
Ci
.
nsIFile
)
;
file
.
initWithPath
(
path
)
;
try
{
file
.
remove
(
false
)
;
}
catch
(
err
)
{
}
yield
setLinks
(
"
-
1
"
)
;
gBrowser
.
_createPreloadBrowser
(
)
;
if
(
gBrowser
.
_preloadedBrowser
.
contentDocument
.
readyState
!
=
"
complete
"
)
{
yield
BrowserTestUtils
.
waitForEvent
(
gBrowser
.
_preloadedBrowser
"
load
"
true
)
;
}
BrowserOpenTab
(
)
;
let
tab
=
gBrowser
.
selectedTab
;
let
thumbnailCreatedPromise
=
new
Promise
(
resolve
=
>
{
Services
.
obs
.
addObserver
(
function
onCreate
(
subj
topic
data
)
{
if
(
data
!
=
url
)
return
;
Services
.
obs
.
removeObserver
(
onCreate
"
page
-
thumbnail
:
create
"
)
;
ok
(
true
"
thumbnail
created
after
preloaded
tab
was
shown
"
)
;
resolve
(
)
;
}
"
page
-
thumbnail
:
create
"
)
;
}
)
;
yield
pushPrefs
(
[
CAPTURE_PREF
false
]
)
;
yield
thumbnailCreatedPromise
;
gBrowser
.
removeTab
(
tab
)
;
file
.
remove
(
false
)
;
}
)
;
