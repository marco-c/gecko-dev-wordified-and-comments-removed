"
use
strict
"
;
const
PAGE
=
"
data
:
text
/
html
<
html
>
<
body
>
A
%
20regular
%
20everyday
%
20normal
%
20page
.
"
;
async
function
assertIsAtRestartRequiredPage
(
browser
)
{
let
doc
=
browser
.
contentDocument
;
if
(
doc
.
readyState
=
=
"
loading
"
)
{
await
BrowserTestUtils
.
waitForEvent
(
browser
.
contentWindow
"
DOMContentLoaded
"
)
;
}
let
title
=
doc
.
getElementById
(
"
title
"
)
;
let
description
=
doc
.
getElementById
(
"
errorLongContent
"
)
;
let
restartButton
=
doc
.
getElementById
(
"
restart
"
)
;
Assert
.
ok
(
title
"
Title
element
exists
.
"
)
;
Assert
.
ok
(
description
"
Description
element
exists
.
"
)
;
Assert
.
ok
(
restartButton
"
Restart
button
exists
.
"
)
;
}
function
crashTabTestHelper
(
)
{
return
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE
}
async
function
(
browser
)
{
TabCrashHandler
.
testBuildIDMismatch
=
true
;
await
BrowserTestUtils
.
crashFrame
(
browser
false
)
;
await
assertIsAtRestartRequiredPage
(
browser
)
;
TabCrashHandler
.
testBuildIDMismatch
=
false
;
}
)
;
}
add_task
(
async
function
test_default
(
)
{
await
crashTabTestHelper
(
)
;
}
)
;
add_task
(
async
function
test_restart_required_foreground
(
)
{
await
BrowserTestUtils
.
withNewTab
(
"
http
:
/
/
example
.
com
"
async
browser
=
>
{
let
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
null
true
)
;
await
BrowserTestUtils
.
simulateProcessLaunchFail
(
browser
true
)
;
Assert
.
equal
(
0
TabCrashHandler
.
queuedCrashedBrowsers
"
No
crashed
browsers
should
be
queued
.
"
)
;
await
loaded
;
await
assertIsAtRestartRequiredPage
(
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
test_launchfail_background
(
)
{
let
originalTab
=
gBrowser
.
selectedTab
;
await
BrowserTestUtils
.
withNewTab
(
"
http
:
/
/
example
.
com
"
async
browser
=
>
{
let
tab
=
gBrowser
.
getTabForBrowser
(
browser
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
originalTab
)
;
await
BrowserTestUtils
.
simulateProcessLaunchFail
(
browser
true
)
;
Assert
.
equal
(
0
TabCrashHandler
.
queuedCrashedBrowsers
"
No
crashed
browsers
should
be
queued
.
"
)
;
let
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
null
true
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
tab
)
;
await
loaded
;
await
assertIsAtRestartRequiredPage
(
browser
)
;
}
)
;
}
)
;
