"
use
strict
"
;
const
PAGE
=
"
data
:
text
/
html
<
html
>
<
body
>
A
%
20regular
%
20everyday
%
20normal
%
20page
.
"
;
const
COMMENTS
=
"
Here
'
s
my
test
comment
!
"
;
requestLongerTimeout
(
2
)
;
add_setup
(
async
function
(
)
{
await
setupLocalCrashReportServer
(
)
;
}
)
;
function
crashTabTestHelper
(
fieldValues
expectedExtra
)
{
return
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE
}
async
function
(
browser
)
{
let
prefs
=
TabCrashHandler
.
prefs
;
let
originalSendReport
=
prefs
.
getBoolPref
(
"
sendReport
"
)
;
let
originalIncludeURL
=
prefs
.
getBoolPref
(
"
includeURL
"
)
;
let
tab
=
gBrowser
.
getTabForBrowser
(
browser
)
;
await
BrowserTestUtils
.
crashFrame
(
browser
)
;
let
doc
=
browser
.
contentDocument
;
let
comments
=
doc
.
getElementById
(
"
comments
"
)
;
let
includeURL
=
doc
.
getElementById
(
"
includeURL
"
)
;
if
(
fieldValues
.
hasOwnProperty
(
"
comments
"
)
)
{
comments
.
value
=
fieldValues
.
comments
;
}
if
(
fieldValues
.
hasOwnProperty
(
"
includeURL
"
)
)
{
includeURL
.
checked
=
fieldValues
.
includeURL
;
}
let
crashReport
=
promiseCrashReport
(
expectedExtra
)
;
let
restoreTab
=
browser
.
contentDocument
.
getElementById
(
"
restoreTab
"
)
;
restoreTab
.
click
(
)
;
await
BrowserTestUtils
.
waitForEvent
(
tab
"
SSTabRestored
"
)
;
await
crashReport
;
prefs
.
setBoolPref
(
"
sendReport
"
originalSendReport
)
;
prefs
.
setBoolPref
(
"
includeURL
"
originalIncludeURL
)
;
}
)
;
}
add_task
(
async
function
test_default
(
)
{
await
crashTabTestHelper
(
{
}
{
Comments
:
null
URL
:
"
"
}
)
;
}
)
;
add_task
(
async
function
test_just_a_comment
(
)
{
await
crashTabTestHelper
(
{
comments
:
COMMENTS
}
{
Comments
:
COMMENTS
URL
:
"
"
}
)
;
}
)
;
add_task
(
async
function
test_send_URL
(
)
{
await
crashTabTestHelper
(
{
includeURL
:
true
}
{
Comments
:
null
URL
:
PAGE
}
)
;
}
)
;
add_task
(
async
function
test_send_all
(
)
{
await
crashTabTestHelper
(
{
includeURL
:
true
comments
:
COMMENTS
}
{
Comments
:
COMMENTS
URL
:
PAGE
}
)
;
}
)
;
