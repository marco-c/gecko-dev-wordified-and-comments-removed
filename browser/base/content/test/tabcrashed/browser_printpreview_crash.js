"
use
strict
"
;
const
TEST_URL
=
"
http
:
/
/
example
.
com
/
browser
/
browser
/
base
/
content
/
test
/
tabcrashed
/
file_contains_emptyiframe
.
html
"
;
const
DOMAIN
=
"
example
.
com
"
;
add_task
(
async
function
test
(
)
{
let
newTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_URL
)
;
let
browser
=
newTab
.
linkedBrowser
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
function
(
)
{
const
iframe
=
content
.
document
.
querySelector
(
"
iframe
"
)
;
const
loaded
=
new
Promise
(
resolve
=
>
{
iframe
.
addEventListener
(
"
load
"
(
)
=
>
{
resolve
(
)
;
}
{
once
:
true
}
)
;
}
)
;
iframe
.
src
=
"
http
:
/
/
test1
.
example
.
com
/
browser
/
browser
/
base
/
content
/
test
/
tabcrashed
/
file_iframe
.
html
"
;
await
loaded
;
}
)
;
await
SpecialPowers
.
spawn
(
browser
[
DOMAIN
]
async
function
(
domain
)
{
content
.
document
.
domain
=
domain
;
}
)
;
const
iframe
=
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
{
return
content
.
document
.
querySelector
(
"
iframe
"
)
.
browsingContext
;
}
)
;
await
SpecialPowers
.
spawn
(
iframe
[
DOMAIN
]
domain
=
>
{
content
.
document
.
domain
=
domain
;
}
)
;
ok
(
!
document
.
querySelector
(
"
.
printPreviewBrowser
"
)
"
Should
NOT
be
in
print
preview
mode
at
the
start
of
this
test
.
"
)
;
document
.
getElementById
(
"
cmd_printPreview
"
)
.
doCommand
(
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
{
let
preview
=
document
.
querySelector
(
"
.
printPreviewBrowser
"
)
;
return
preview
&
&
BrowserTestUtils
.
is_visible
(
preview
)
;
}
)
;
let
ppBrowser
=
document
.
querySelector
(
"
.
printPreviewBrowser
[
previewtype
=
source
]
"
)
;
ok
(
ppBrowser
"
Print
preview
browser
was
created
"
)
;
ok
(
true
"
We
did
not
crash
.
"
)
;
gBrowser
.
getTabDialogBox
(
gBrowser
.
selectedBrowser
)
.
abortAllDialogs
(
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
!
document
.
querySelector
(
"
.
printPreviewBrowser
"
)
)
;
info
(
"
We
are
not
in
print
preview
anymore
.
"
)
;
BrowserTestUtils
.
removeTab
(
newTab
)
;
}
)
;
