const
{
Sanitizer
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
Sanitizer
.
jsm
"
)
;
const
{
SiteDataTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
SiteDataTestUtils
.
jsm
"
)
;
function
checkDataForAboutURL
(
)
{
return
new
Promise
(
resolve
=
>
{
let
data
=
true
;
let
uri
=
Services
.
io
.
newURI
(
"
about
:
newtab
"
)
;
let
principal
=
Services
.
scriptSecurityManager
.
createCodebasePrincipal
(
uri
{
}
)
;
let
request
=
indexedDB
.
openForPrincipal
(
principal
"
TestDatabase
"
1
)
;
request
.
onupgradeneeded
=
function
(
e
)
{
data
=
false
;
}
;
request
.
onsuccess
=
function
(
e
)
{
resolve
(
data
)
;
}
;
}
)
;
}
function
createIndexedDB
(
host
originAttributes
)
{
return
SiteDataTestUtils
.
addToIndexedDB
(
"
https
:
/
/
"
+
host
"
foo
"
"
bar
"
originAttributes
)
;
}
function
checkIndexedDB
(
host
originAttributes
)
{
return
new
Promise
(
resolve
=
>
{
let
data
=
true
;
let
uri
=
Services
.
io
.
newURI
(
"
https
:
/
/
"
+
host
)
;
let
principal
=
Services
.
scriptSecurityManager
.
createCodebasePrincipal
(
uri
originAttributes
)
;
let
request
=
indexedDB
.
openForPrincipal
(
principal
"
TestDatabase
"
1
)
;
request
.
onupgradeneeded
=
function
(
e
)
{
data
=
false
;
}
;
request
.
onsuccess
=
function
(
e
)
{
resolve
(
data
)
;
}
;
}
)
;
}
function
createHostCookie
(
host
originAttributes
)
{
Services
.
cookies
.
add
(
host
"
/
test
"
"
foo
"
"
bar
"
false
false
false
Date
.
now
(
)
+
24000
*
60
*
60
originAttributes
Ci
.
nsICookie2
.
SAMESITE_UNSET
)
;
}
function
createDomainCookie
(
host
originAttributes
)
{
Services
.
cookies
.
add
(
"
.
"
+
host
"
/
test
"
"
foo
"
"
bar
"
false
false
false
Date
.
now
(
)
+
24000
*
60
*
60
originAttributes
Ci
.
nsICookie2
.
SAMESITE_UNSET
)
;
}
function
checkCookie
(
host
originAttributes
)
{
for
(
let
cookie
of
Services
.
cookies
.
enumerator
)
{
if
(
ChromeUtils
.
isOriginAttributesEqual
(
originAttributes
cookie
.
originAttributes
)
&
&
cookie
.
host
.
includes
(
host
)
)
{
return
true
;
}
}
return
false
;
}
async
function
deleteOnShutdown
(
opt
)
{
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
resolve
)
;
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
network
.
cookie
.
lifetimePolicy
"
opt
.
lifetimePolicy
]
[
"
browser
.
sanitizer
.
loglevel
"
"
All
"
]
]
}
)
;
if
(
opt
.
cookiePermission
!
=
=
undefined
)
{
let
uri
=
Services
.
io
.
newURI
(
"
https
:
/
/
www
.
example
.
com
"
)
;
Services
.
perms
.
add
(
uri
"
cookie
"
opt
.
cookiePermission
)
;
}
await
opt
.
createData
(
(
opt
.
fullHost
?
"
www
.
"
:
"
"
)
+
"
example
.
org
"
opt
.
originAttributes
)
;
ok
(
await
opt
.
checkData
(
(
opt
.
fullHost
?
"
www
.
"
:
"
"
)
+
"
example
.
org
"
opt
.
originAttributes
)
"
We
have
data
for
www
.
example
.
org
"
)
;
await
opt
.
createData
(
(
opt
.
fullHost
?
"
www
.
"
:
"
"
)
+
"
example
.
com
"
opt
.
originAttributes
)
;
ok
(
await
opt
.
checkData
(
(
opt
.
fullHost
?
"
www
.
"
:
"
"
)
+
"
example
.
com
"
opt
.
originAttributes
)
"
We
have
data
for
www
.
example
.
com
"
)
;
await
Sanitizer
.
runSanitizeOnShutdown
(
)
;
is
(
!
!
(
await
opt
.
checkData
(
(
opt
.
fullHost
?
"
www
.
"
:
"
"
)
+
"
example
.
org
"
opt
.
originAttributes
)
)
opt
.
expectedForOrg
"
Do
we
have
data
for
www
.
example
.
org
?
"
)
;
is
(
!
!
(
await
opt
.
checkData
(
(
opt
.
fullHost
?
"
www
.
"
:
"
"
)
+
"
example
.
com
"
opt
.
originAttributes
)
)
opt
.
expectedForCom
"
Do
we
have
data
for
www
.
example
.
com
?
"
)
;
await
Sanitizer
.
sanitize
(
[
"
cookies
"
"
offlineApps
"
]
)
;
if
(
opt
.
cookiePermission
!
=
=
undefined
)
{
let
uri
=
Services
.
io
.
newURI
(
"
https
:
/
/
www
.
example
.
com
"
)
;
Services
.
perms
.
remove
(
uri
"
cookie
"
)
;
}
}
let
tests
=
[
{
name
:
"
IDB
"
createData
:
createIndexedDB
checkData
:
checkIndexedDB
}
{
name
:
"
Host
Cookie
"
createData
:
createHostCookie
checkData
:
checkCookie
}
{
name
:
"
Domain
Cookie
"
createData
:
createDomainCookie
checkData
:
checkCookie
}
]
;
let
attributes
=
[
{
name
:
"
default
"
oa
:
{
}
}
{
name
:
"
container
"
oa
:
{
userContextId
:
1
}
}
]
;
tests
.
forEach
(
methods
=
>
{
attributes
.
forEach
(
originAttributes
=
>
{
add_task
(
async
function
deleteStorageOnShutdown
(
)
{
info
(
methods
.
name
+
"
:
Delete
all
no
custom
permission
data
in
example
.
com
cookie
permission
set
for
www
.
example
.
com
-
OA
:
"
+
originAttributes
.
name
)
;
await
deleteOnShutdown
(
{
lifetimePolicy
:
Ci
.
nsICookieService
.
ACCEPT_SESSION
createData
:
methods
.
createData
checkData
:
methods
.
checkData
originAttributes
:
originAttributes
.
oa
cookiePermission
:
undefined
expectedForOrg
:
false
expectedForCom
:
false
fullHost
:
false
}
)
;
}
)
;
}
)
;
}
)
;
tests
.
forEach
(
methods
=
>
{
attributes
.
forEach
(
originAttributes
=
>
{
add_task
(
async
function
deleteStorageOnShutdown
(
)
{
info
(
methods
.
name
+
"
:
Delete
all
no
custom
permission
data
in
www
.
example
.
com
cookie
permission
set
for
www
.
example
.
com
-
OA
:
"
+
originAttributes
.
name
)
;
await
deleteOnShutdown
(
{
lifetimePolicy
:
Ci
.
nsICookieService
.
ACCEPT_SESSION
createData
:
methods
.
createData
checkData
:
methods
.
checkData
originAttributes
:
originAttributes
.
oa
cookiePermission
:
undefined
expectedForOrg
:
false
expectedForCom
:
false
fullHost
:
true
}
)
;
}
)
;
}
)
;
}
)
;
tests
.
forEach
(
methods
=
>
{
attributes
.
forEach
(
originAttributes
=
>
{
add_task
(
async
function
deleteStorageWithCustomPermission
(
)
{
info
(
methods
.
name
+
"
:
All
is
session
but
with
ALLOW
custom
permission
data
in
example
.
com
cookie
permission
set
for
www
.
example
.
com
-
OA
:
"
+
originAttributes
.
name
)
;
await
deleteOnShutdown
(
{
lifetimePolicy
:
Ci
.
nsICookieService
.
ACCEPT_SESSION
createData
:
methods
.
createData
checkData
:
methods
.
checkData
originAttributes
:
originAttributes
.
oa
cookiePermission
:
Ci
.
nsICookiePermission
.
ACCESS_ALLOW
expectedForOrg
:
false
expectedForCom
:
true
fullHost
:
false
}
)
;
}
)
;
}
)
;
}
)
;
tests
.
forEach
(
methods
=
>
{
attributes
.
forEach
(
originAttributes
=
>
{
add_task
(
async
function
deleteStorageWithCustomPermission
(
)
{
info
(
methods
.
name
+
"
:
All
is
session
but
with
ALLOW
custom
permission
data
in
www
.
example
.
com
cookie
permission
set
for
www
.
example
.
com
-
OA
:
"
+
originAttributes
.
name
)
;
await
deleteOnShutdown
(
{
lifetimePolicy
:
Ci
.
nsICookieService
.
ACCEPT_SESSION
createData
:
methods
.
createData
checkData
:
methods
.
checkData
originAttributes
:
originAttributes
.
oa
cookiePermission
:
Ci
.
nsICookiePermission
.
ACCESS_ALLOW
expectedForOrg
:
false
expectedForCom
:
true
fullHost
:
true
}
)
;
}
)
;
}
)
;
}
)
;
tests
.
forEach
(
methods
=
>
{
attributes
.
forEach
(
originAttributes
=
>
{
add_task
(
async
function
deleteStorageOnlyCustomPermission
(
)
{
info
(
methods
.
name
+
"
:
All
is
default
but
with
SESSION
custom
permission
data
in
example
.
com
cookie
permission
set
for
www
.
example
.
com
-
OA
:
"
+
originAttributes
.
name
)
;
await
deleteOnShutdown
(
{
lifetimePolicy
:
Ci
.
nsICookieService
.
ACCEPT_NORMALLY
createData
:
methods
.
createData
checkData
:
methods
.
checkData
originAttributes
:
originAttributes
.
oa
cookiePermission
:
Ci
.
nsICookiePermission
.
ACCESS_SESSION
expectedForOrg
:
true
expectedForCom
:
false
fullHost
:
false
}
)
;
}
)
;
}
)
;
}
)
;
tests
.
forEach
(
methods
=
>
{
attributes
.
forEach
(
originAttributes
=
>
{
add_task
(
async
function
deleteStorageOnlyCustomPermission
(
)
{
info
(
methods
.
name
+
"
:
All
is
default
but
with
SESSION
custom
permission
data
in
www
.
example
.
com
cookie
permission
set
for
www
.
example
.
com
-
OA
:
"
+
originAttributes
.
name
)
;
await
deleteOnShutdown
(
{
lifetimePolicy
:
Ci
.
nsICookieService
.
ACCEPT_NORMALLY
createData
:
methods
.
createData
checkData
:
methods
.
checkData
originAttributes
:
originAttributes
.
oa
cookiePermission
:
Ci
.
nsICookiePermission
.
ACCESS_SESSION
expectedForOrg
:
true
expectedForCom
:
false
fullHost
:
true
}
)
;
}
)
;
}
)
;
}
)
;
tests
.
forEach
(
methods
=
>
{
attributes
.
forEach
(
originAttributes
=
>
{
add_task
(
async
function
deleteStorageOnlyCustomPermission
(
)
{
info
(
methods
.
name
+
"
:
All
is
session
only
but
with
unsupported
custom
custom
permission
data
in
www
.
example
.
com
cookie
permission
set
for
www
.
example
.
com
-
OA
:
"
+
originAttributes
.
name
)
;
await
deleteOnShutdown
(
{
lifetimePolicy
:
Ci
.
nsICookieService
.
ACCEPT_SESSION
createData
:
methods
.
createData
checkData
:
methods
.
checkData
originAttributes
:
originAttributes
.
oa
cookiePermission
:
123
expectedForOrg
:
false
expectedForCom
:
false
fullHost
:
true
}
)
;
}
)
;
}
)
;
}
)
;
add_task
(
async
function
deleteStorageInAboutURL
(
)
{
info
(
"
Test
about
:
newtab
"
)
;
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
resolve
)
;
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
network
.
cookie
.
lifetimePolicy
"
Ci
.
nsICookieService
.
ACCEPT_SESSION
]
[
"
browser
.
sanitizer
.
loglevel
"
"
All
"
]
]
}
)
;
await
SiteDataTestUtils
.
addToIndexedDB
(
"
about
:
newtab
"
"
foo
"
"
bar
"
{
}
)
;
ok
(
await
checkDataForAboutURL
(
)
"
We
have
data
for
about
:
newtab
"
)
;
await
Sanitizer
.
runSanitizeOnShutdown
(
)
;
ok
(
await
checkDataForAboutURL
(
)
"
about
:
newtab
data
is
not
deleted
.
"
)
;
await
Sanitizer
.
sanitize
(
[
"
cookies
"
"
offlineApps
"
]
)
;
let
principal
=
Services
.
scriptSecurityManager
.
createCodebasePrincipalFromOrigin
(
"
about
:
newtab
"
)
;
await
new
Promise
(
aResolve
=
>
{
let
req
=
Services
.
qms
.
clearStoragesForPrincipal
(
principal
)
;
req
.
callback
=
(
)
=
>
{
aResolve
(
)
;
}
;
}
)
;
}
)
;
add_task
(
async
function
deleteStorageOnlyCustomPermissionInAboutURL
(
)
{
info
(
"
Test
about
:
newtab
+
permissions
"
)
;
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
resolve
)
;
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
network
.
cookie
.
lifetimePolicy
"
Ci
.
nsICookieService
.
ACCEPT_NORMALLY
]
[
"
browser
.
sanitizer
.
loglevel
"
"
All
"
]
]
}
)
;
let
uri
=
Services
.
io
.
newURI
(
"
about
:
newtab
"
)
;
Services
.
perms
.
add
(
uri
"
cookie
"
Ci
.
nsICookiePermission
.
ACCESS_SESSION
)
;
await
SiteDataTestUtils
.
addToIndexedDB
(
"
about
:
newtab
"
"
foo
"
"
bar
"
{
}
)
;
ok
(
await
checkDataForAboutURL
(
)
"
We
have
data
for
about
:
newtab
"
)
;
await
Sanitizer
.
runSanitizeOnShutdown
(
)
;
ok
(
await
checkDataForAboutURL
(
)
"
about
:
newtab
data
is
not
deleted
.
"
)
;
await
Sanitizer
.
sanitize
(
[
"
cookies
"
"
offlineApps
"
]
)
;
let
principal
=
Services
.
scriptSecurityManager
.
createCodebasePrincipalFromOrigin
(
"
about
:
newtab
"
)
;
await
new
Promise
(
aResolve
=
>
{
let
req
=
Services
.
qms
.
clearStoragesForPrincipal
(
principal
)
;
req
.
callback
=
(
)
=
>
{
aResolve
(
)
;
}
;
}
)
;
Services
.
perms
.
remove
(
uri
"
cookie
"
)
;
}
)
;
add_task
(
async
function
subDomains
(
)
{
info
(
"
Test
subdomains
and
custom
setting
"
)
;
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_ALL
resolve
)
;
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
network
.
cookie
.
lifetimePolicy
"
Ci
.
nsICookieService
.
ACCEPT_NORMALLY
]
[
"
browser
.
sanitizer
.
loglevel
"
"
All
"
]
]
}
)
;
let
uriA
=
Services
.
io
.
newURI
(
"
https
:
/
/
www
.
mozilla
.
org
"
)
;
Services
.
perms
.
add
(
uriA
"
cookie
"
Ci
.
nsICookiePermission
.
ACCESS_SESSION
)
;
Services
.
cookies
.
add
(
uriA
.
host
"
/
test
"
"
a
"
"
b
"
false
false
false
Date
.
now
(
)
+
24000
*
60
*
60
{
}
Ci
.
nsICookie2
.
SAMESITE_UNSET
)
;
await
createIndexedDB
(
uriA
.
host
{
}
)
;
let
uriB
=
Services
.
io
.
newURI
(
"
https
:
/
/
mozilla
.
org
"
)
;
Services
.
perms
.
add
(
uriB
"
cookie
"
Ci
.
nsICookiePermission
.
ACCESS_ALLOW
)
;
Services
.
cookies
.
add
(
uriB
.
host
"
/
test
"
"
c
"
"
d
"
false
false
false
Date
.
now
(
)
+
24000
*
60
*
60
{
}
Ci
.
nsICookie2
.
SAMESITE_UNSET
)
;
await
createIndexedDB
(
uriB
.
host
{
}
)
;
ok
(
await
checkCookie
(
uriA
.
host
{
}
)
"
We
have
cookies
for
URI
:
"
+
uriA
.
host
)
;
ok
(
await
checkIndexedDB
(
uriA
.
host
{
}
)
"
We
have
IDB
for
URI
:
"
+
uriA
.
host
)
;
ok
(
await
checkCookie
(
uriB
.
host
{
}
)
"
We
have
cookies
for
URI
:
"
+
uriB
.
host
)
;
ok
(
await
checkIndexedDB
(
uriB
.
host
{
}
)
"
We
have
IDB
for
URI
:
"
+
uriB
.
host
)
;
await
Sanitizer
.
runSanitizeOnShutdown
(
)
;
ok
(
!
(
await
checkCookie
(
uriA
.
host
{
}
)
)
"
We
should
not
have
cookies
for
URI
:
"
+
uriA
.
host
)
;
ok
(
!
(
await
checkIndexedDB
(
uriA
.
host
{
}
)
)
"
We
should
not
have
IDB
for
URI
:
"
+
uriA
.
host
)
;
ok
(
!
(
await
checkCookie
(
uriB
.
host
{
}
)
)
"
We
should
not
have
cookies
for
URI
:
"
+
uriB
.
host
)
;
ok
(
await
checkIndexedDB
(
uriB
.
host
{
}
)
"
We
should
have
IDB
for
URI
:
"
+
uriB
.
host
)
;
Services
.
perms
.
remove
(
uriA
"
cookie
"
)
;
Services
.
perms
.
remove
(
uriB
"
cookie
"
)
;
}
)
;
