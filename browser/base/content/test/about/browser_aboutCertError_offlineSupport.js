"
use
strict
"
;
const
PREF_OFFLINE_SUPPORT_ENABLED
=
"
security
.
certerrors
.
offlineSupport
.
enabled
"
;
const
BAD_CERT_PAGE
=
"
https
:
/
/
expired
.
example
.
com
"
;
const
DUMMY_SUPPORT_BASE_PATH
=
"
/
1
/
firefox
/
fxVersion
/
OSVersion
/
language
/
"
;
const
DUMMY_SUPPORT_URL
=
BAD_CERT_PAGE
+
DUMMY_SUPPORT_BASE_PATH
;
const
OFFLINE_SUPPORT_PAGE
=
"
chrome
:
/
/
browser
/
content
/
supportpages
/
time
-
errors
.
html
"
;
add_task
(
async
function
testOfflineSupportPage
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF_OFFLINE_SUPPORT_ENABLED
true
)
;
let
originalBaseURL
=
Services
.
prefs
.
getCharPref
(
"
app
.
support
.
baseURL
"
)
;
Services
.
prefs
.
setCharPref
(
"
app
.
support
.
baseURL
"
DUMMY_SUPPORT_URL
)
;
let
certErrorLoaded
;
let
errorTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
(
)
=
>
{
let
tab
=
BrowserTestUtils
.
addTab
(
gBrowser
BAD_CERT_PAGE
)
;
gBrowser
.
selectedTab
=
tab
;
let
browser
=
gBrowser
.
selectedBrowser
;
certErrorLoaded
=
BrowserTestUtils
.
waitForErrorPage
(
browser
)
;
return
tab
;
}
false
)
;
await
certErrorLoaded
;
let
offlineSupportPromise
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
DUMMY_SUPPORT_URL
+
"
time
-
errors
"
)
;
await
SpecialPowers
.
spawn
(
errorTab
.
linkedBrowser
[
DUMMY_SUPPORT_URL
]
async
expectedURL
=
>
{
let
doc
=
content
.
document
;
let
learnMoreLink
=
doc
.
getElementById
(
"
learnMoreLink
"
)
;
let
supportPageURL
=
learnMoreLink
.
getAttribute
(
"
href
"
)
;
ok
(
supportPageURL
=
=
expectedURL
+
"
time
-
errors
"
"
Correct
support
page
URL
has
been
set
"
)
;
await
EventUtils
.
synthesizeMouseAtCenter
(
learnMoreLink
{
}
content
)
;
}
)
;
let
offlineSupportTab
=
await
offlineSupportPromise
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
false
OFFLINE_SUPPORT_PAGE
)
;
Services
.
prefs
.
clearUserPref
(
PREF_OFFLINE_SUPPORT_ENABLED
)
;
Services
.
prefs
.
setCharPref
(
"
app
.
support
.
baseURL
"
originalBaseURL
)
;
await
BrowserTestUtils
.
removeTab
(
offlineSupportTab
)
;
await
BrowserTestUtils
.
removeTab
(
errorTab
)
;
}
)
;
