"
use
strict
"
;
const
PREF_SERVICES_SETTINGS_CLOCK_SKEW_SECONDS
=
"
services
.
settings
.
clock_skew_seconds
"
;
const
PREF_SERVICES_SETTINGS_LAST_FETCHED
=
"
services
.
settings
.
last_update_seconds
"
;
const
PREF_NEW_CERT_ERRORS
=
"
browser
.
security
.
newcerterrorpage
.
enabled
"
;
add_task
(
async
function
checkWrongSystemTimeWarning
(
)
{
Services
.
prefs
.
setBoolPref
(
PREF_NEW_CERT_ERRORS
true
)
;
async
function
setUpPage
(
)
{
let
browser
;
let
certErrorLoaded
;
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
(
)
=
>
{
gBrowser
.
selectedTab
=
BrowserTestUtils
.
addTab
(
gBrowser
"
https
:
/
/
expired
.
example
.
com
/
"
)
;
browser
=
gBrowser
.
selectedBrowser
;
certErrorLoaded
=
BrowserTestUtils
.
waitForErrorPage
(
browser
)
;
}
false
)
;
info
(
"
Loading
and
waiting
for
the
cert
error
"
)
;
await
certErrorLoaded
;
return
ContentTask
.
spawn
(
browser
null
async
function
(
)
{
let
doc
=
content
.
document
;
let
div
=
doc
.
getElementById
(
"
errorShortDescText
"
)
;
let
systemDateDiv
=
doc
.
getElementById
(
"
wrongSystemTime_systemDate1
"
)
;
let
learnMoreLink
=
doc
.
getElementById
(
"
learnMoreLink
"
)
;
return
{
divDisplay
:
content
.
getComputedStyle
(
div
)
.
display
text
:
div
.
textContent
systemDate
:
systemDateDiv
.
textContent
learnMoreLink
:
learnMoreLink
.
href
}
;
}
)
;
}
Services
.
prefs
.
setIntPref
(
PREF_SERVICES_SETTINGS_LAST_FETCHED
Math
.
floor
(
Date
.
now
(
)
/
1000
)
)
;
let
formatter
=
new
Services
.
intl
.
DateTimeFormat
(
undefined
{
dateStyle
:
"
short
"
}
)
;
let
expiredDate
=
new
Date
(
"
2010
/
01
/
06
"
)
;
let
localDate
=
Date
.
now
(
)
;
let
skew
=
Math
.
floor
(
(
localDate
-
expiredDate
)
/
1000
)
;
Services
.
prefs
.
setIntPref
(
PREF_SERVICES_SETTINGS_CLOCK_SKEW_SECONDS
skew
)
;
let
localDateFmt
=
formatter
.
format
(
localDate
)
;
info
(
"
Loading
a
bad
cert
page
with
a
skewed
clock
"
)
;
let
message
=
await
setUpPage
(
)
;
isnot
(
message
.
divDisplay
"
none
"
"
Wrong
time
message
information
is
visible
"
)
;
ok
(
message
.
text
.
includes
(
"
update
your
computer
clock
"
)
"
Correct
error
message
found
"
)
;
ok
(
message
.
text
.
includes
(
"
expired
.
example
.
com
"
)
"
URL
found
in
error
message
"
)
;
ok
(
message
.
systemDate
.
includes
(
localDateFmt
)
"
Correct
local
date
displayed
"
)
;
ok
(
message
.
learnMoreLink
.
includes
(
"
time
-
errors
"
)
"
time
-
errors
in
the
Learn
More
URL
"
)
;
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
Services
.
prefs
.
clearUserPref
(
PREF_SERVICES_SETTINGS_LAST_FETCHED
)
;
Services
.
prefs
.
clearUserPref
(
PREF_SERVICES_SETTINGS_CLOCK_SKEW_SECONDS
)
;
Services
.
prefs
.
clearUserPref
(
PREF_NEW_CERT_ERRORS
)
;
}
)
;
