async
function
checkSwitchPageToOnlineMode
(
useFelt
)
{
Services
.
io
.
offline
=
true
;
let
proxyPrefValue
=
SpecialPowers
.
getIntPref
(
"
network
.
proxy
.
type
"
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
network
.
proxy
.
type
"
0
]
[
"
browser
.
cache
.
disk
.
enable
"
false
]
[
"
browser
.
cache
.
memory
.
enable
"
false
]
[
"
security
.
certerrors
.
felt
-
privacy
-
v1
"
useFelt
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
function
(
browser
)
{
let
netErrorLoaded
=
BrowserTestUtils
.
waitForErrorPage
(
browser
)
;
BrowserTestUtils
.
startLoadingURIString
(
browser
"
http
:
/
/
example
.
com
/
"
)
;
await
netErrorLoaded
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
network
.
proxy
.
type
"
proxyPrefValue
]
]
}
)
;
let
changeObserved
=
TestUtils
.
topicObserved
(
"
network
:
offline
-
status
-
changed
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
useFelt
]
async
function
(
use_felt
)
{
ok
(
content
.
document
.
documentURI
.
startsWith
(
"
about
:
neterror
?
e
=
netOffline
"
)
"
Should
be
showing
error
page
"
)
;
const
button
=
use_felt
?
content
.
document
.
querySelector
(
"
net
-
error
-
card
"
)
.
wrappedJSObject
.
tryAgainButton
:
content
.
document
.
querySelector
(
"
#
netErrorButtonContainer
>
.
try
-
again
"
)
;
button
.
click
(
)
;
}
)
;
await
changeObserved
;
ok
(
!
Services
.
io
.
offline
"
After
clicking
the
'
Try
Again
'
button
we
'
re
back
online
.
"
)
;
}
)
;
}
add_task
(
async
function
runCheckSwitchPageToOnlineMode
(
)
{
for
(
const
useFelt
of
[
true
false
]
)
{
await
checkSwitchPageToOnlineMode
(
useFelt
)
;
}
}
)
;
registerCleanupFunction
(
function
(
)
{
Services
.
io
.
offline
=
false
;
}
)
;
