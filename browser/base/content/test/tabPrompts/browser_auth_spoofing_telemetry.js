"
use
strict
"
;
let
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
com
"
)
;
let
TEST_PATH_AUTH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
org
"
)
;
const
CROSS_DOMAIN_URL
=
TEST_PATH
+
"
redirect
-
crossDomain
.
html
"
;
const
SAME_DOMAIN_URL
=
TEST_PATH
+
"
redirect
-
sameDomain
.
html
"
;
const
CROSS_DOMAIN_SUB_URL
=
TEST_PATH
+
"
cross
-
domain
-
iframe
.
html
"
;
const
SAME_DOMAIN_SUB_URL
=
TEST_PATH
+
"
same
-
domain
-
iframe
.
html
"
;
const
AUTH_URL
=
TEST_PATH_AUTH
+
"
auth
-
route
.
sjs
"
;
const
TOP_LEVEL_SAME_DOMAIN
=
0
;
const
TOP_LEVEL_CROSS_DOMAIN
=
1
;
const
SAME_DOMAIN_SUBRESOURCE
=
2
;
const
CROSS_DOMAIN_SUBRESOURCE
=
3
;
async
function
loadAndHandlePrompt
(
urlToLoad
index
)
{
let
histogram
=
TelemetryTestUtils
.
getAndClearHistogram
(
"
HTTP_AUTH_RESOURCE_TYPE
"
)
;
let
dialogShown
=
waitForDialog
(
index
histogram
)
;
await
BrowserTestUtils
.
withNewTab
(
urlToLoad
async
function
(
)
{
await
dialogShown
;
}
)
;
await
new
Promise
(
resolve
=
>
{
Services
.
clearData
.
deleteData
(
Ci
.
nsIClearDataService
.
CLEAR_AUTH_CACHE
resolve
)
;
}
)
;
}
add_task
(
async
function
testCrossDomainTopLevel
(
)
{
await
loadAndHandlePrompt
(
CROSS_DOMAIN_URL
TOP_LEVEL_CROSS_DOMAIN
)
;
}
)
;
add_task
(
async
function
testSameDomainTopLevel
(
)
{
await
loadAndHandlePrompt
(
SAME_DOMAIN_URL
TOP_LEVEL_SAME_DOMAIN
)
;
}
)
;
add_task
(
async
function
testCrossDomainSubresource
(
)
{
await
loadAndHandlePrompt
(
CROSS_DOMAIN_SUB_URL
CROSS_DOMAIN_SUBRESOURCE
)
;
}
)
;
add_task
(
async
function
testSameDomainSubresource
(
)
{
await
loadAndHandlePrompt
(
SAME_DOMAIN_SUB_URL
SAME_DOMAIN_SUBRESOURCE
)
;
}
)
;
