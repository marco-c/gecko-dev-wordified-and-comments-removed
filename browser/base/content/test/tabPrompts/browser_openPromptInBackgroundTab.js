"
use
strict
"
;
const
ROOT
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
/
"
"
http
:
/
/
example
.
com
/
"
)
;
let
pageWithAlert
=
ROOT
+
"
openPromptOffTimeout
.
html
"
;
registerCleanupFunction
(
function
(
)
{
Services
.
perms
.
removeAll
(
)
;
}
)
;
add_task
(
async
function
(
)
{
let
firstTab
=
gBrowser
.
selectedTab
;
let
openedTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
pageWithAlert
true
)
;
let
openedTabGotAttentionPromise
=
BrowserTestUtils
.
waitForAttribute
(
"
attention
"
openedTab
"
true
"
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
firstTab
)
;
await
openedTabGotAttentionPromise
;
is
(
openedTab
.
getAttribute
(
"
attention
"
)
"
true
"
"
Tab
with
alert
should
have
'
attention
'
attribute
.
"
)
;
ok
(
!
openedTab
.
selected
"
Tab
with
alert
should
not
be
selected
"
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
openedTab
)
;
let
prompts
=
openedTab
.
linkedBrowser
.
parentNode
.
querySelectorAll
(
"
tabmodalprompt
"
)
;
is
(
prompts
.
length
1
"
There
should
be
1
prompt
"
)
;
let
ourPrompt
=
prompts
[
0
]
;
let
row
=
ourPrompt
.
querySelector
(
"
row
"
)
;
ok
(
row
"
Should
have
found
the
row
with
our
checkbox
"
)
;
let
checkbox
=
row
.
querySelector
(
"
checkbox
[
label
*
=
'
example
.
com
'
]
"
)
;
ok
(
checkbox
"
The
checkbox
should
be
there
"
)
;
ok
(
!
checkbox
.
checked
"
Checkbox
shouldn
'
t
be
checked
"
)
;
checkbox
.
checked
=
true
;
ourPrompt
.
onButtonClick
(
0
)
;
await
new
Promise
(
function
(
resolve
)
{
Services
.
tm
.
dispatchToMainThread
(
resolve
)
;
}
)
;
let
ps
=
Services
.
perms
;
is
(
ps
.
ALLOW_ACTION
ps
.
testPermission
(
makeURI
(
pageWithAlert
)
"
focus
-
tab
-
by
-
prompt
"
)
"
Tab
switching
should
now
be
allowed
"
)
;
let
shown
=
BrowserTestUtils
.
waitForEvent
(
gIdentityHandler
.
_identityPopup
"
popupshown
"
)
;
gIdentityHandler
.
_identityBox
.
click
(
)
;
await
shown
;
let
labelText
=
SitePermissions
.
getPermissionLabel
(
"
focus
-
tab
-
by
-
prompt
"
)
;
let
permissionsList
=
document
.
getElementById
(
"
identity
-
popup
-
permission
-
list
"
)
;
let
label
=
permissionsList
.
querySelector
(
"
.
identity
-
popup
-
permission
-
label
"
)
;
is
(
label
.
textContent
labelText
)
;
gIdentityHandler
.
_identityPopup
.
hidePopup
(
)
;
ok
(
gIdentityHandler
.
_identityBox
.
classList
.
contains
(
"
grantedPermissions
"
)
"
identity
-
box
signals
granted
permissions
"
)
;
let
openedTabSelectedPromise
=
BrowserTestUtils
.
waitForAttribute
(
"
selected
"
openedTab
"
true
"
)
;
await
BrowserTestUtils
.
switchTab
(
gBrowser
firstTab
)
;
await
openedTabSelectedPromise
;
ok
(
openedTab
.
selected
"
Ta
-
dah
the
other
tab
should
now
be
selected
again
!
"
)
;
await
TestUtils
.
waitForTick
(
)
;
await
BrowserTestUtils
.
removeTab
(
openedTab
)
;
}
)
;
