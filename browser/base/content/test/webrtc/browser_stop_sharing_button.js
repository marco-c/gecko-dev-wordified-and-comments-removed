"
use
strict
"
;
const
TEST_ROOT
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
/
"
"
https
:
/
/
example
.
com
/
"
)
;
const
TEST_PAGE
=
TEST_ROOT
+
"
get_user_media
.
html
"
;
add_task
(
async
function
test_close_indicator
(
)
{
let
prefs
=
[
[
PREF_PERMISSION_FAKE
true
]
[
PREF_AUDIO_LOOPBACK
"
"
]
[
PREF_VIDEO_LOOPBACK
"
"
]
[
PREF_FAKE_STREAMS
true
]
[
PREF_FOCUS_SOURCE
false
]
]
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
prefs
}
)
;
await
BrowserTestUtils
.
withNewTab
(
TEST_PAGE
async
browser
=
>
{
let
indicatorPromise
=
promiseIndicatorWindow
(
)
;
let
promise
=
promisePopupNotificationShown
(
"
webRTC
-
shareDevices
"
null
window
)
;
await
promiseRequestDevice
(
true
true
null
null
browser
)
;
await
promise
;
checkDeviceSelectors
(
true
true
)
;
let
observerPromise1
=
expectObserverCalled
(
"
getUserMedia
:
response
:
allow
"
)
;
let
observerPromise2
=
expectObserverCalled
(
"
recording
-
device
-
events
"
)
;
promise
=
promiseMessage
(
"
ok
"
(
)
=
>
{
PopupNotifications
.
panel
.
firstElementChild
.
button
.
click
(
)
;
}
)
;
await
observerPromise1
;
await
observerPromise2
;
await
promise
;
promise
=
promisePopupNotificationShown
(
"
webRTC
-
shareDevices
"
null
window
)
;
await
promiseRequestDevice
(
false
true
null
"
screen
"
browser
)
;
await
promise
;
checkDeviceSelectors
(
false
false
true
window
)
;
let
document
=
window
.
document
;
let
menulist
=
document
.
getElementById
(
"
webRTC
-
selectWindow
-
menulist
"
)
;
menulist
.
getItemAtIndex
(
menulist
.
itemCount
-
1
)
.
doCommand
(
)
;
let
notification
=
window
.
PopupNotifications
.
panel
.
firstElementChild
;
observerPromise1
=
expectObserverCalled
(
"
getUserMedia
:
response
:
allow
"
)
;
observerPromise2
=
expectObserverCalled
(
"
recording
-
device
-
events
"
)
;
await
promiseMessage
(
"
ok
"
(
)
=
>
{
notification
.
button
.
click
(
)
;
}
1
browser
)
;
await
observerPromise1
;
await
observerPromise2
;
let
indicator
=
await
indicatorPromise
;
let
indicatorDoc
=
indicator
.
document
;
let
isSharingScreen
=
indicatorDoc
.
documentElement
.
hasAttribute
(
"
sharingscreen
"
)
;
let
stopSharingID
=
isSharingScreen
?
"
stop
-
sharing
-
screen
"
:
"
stop
-
sharing
-
window
"
;
let
stopSharingButton
=
indicator
.
document
.
getElementById
(
stopSharingID
)
;
let
stopSharingPromise
=
expectObserverCalled
(
"
recording
-
device
-
events
"
)
;
stopSharingButton
.
click
(
)
;
await
stopSharingPromise
;
await
checkSharingUI
(
{
audio
:
true
video
:
true
}
)
;
}
)
;
}
)
;
