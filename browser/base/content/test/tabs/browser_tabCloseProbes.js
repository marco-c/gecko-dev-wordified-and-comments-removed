"
use
strict
"
;
var
gAnimHistogram
=
Services
.
telemetry
.
getHistogramById
(
"
FX_TAB_CLOSE_TIME_ANIM_MS
"
)
;
var
gNoAnimHistogram
=
Services
.
telemetry
.
getHistogramById
(
"
FX_TAB_CLOSE_TIME_NO_ANIM_MS
"
)
;
function
assertCount
(
snapshot
expectedCount
)
{
Assert
.
equal
(
snapshot
.
counts
.
reduce
(
(
a
b
)
=
>
a
+
b
)
expectedCount
Should
only
be
{
expectedCount
}
collected
value
.
)
;
}
add_task
(
function
*
setup
(
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
toolkit
.
telemetry
.
enabled
"
true
]
]
}
)
;
let
oldCanRecord
=
Services
.
telemetry
.
canRecordExtended
;
Services
.
telemetry
.
canRecordExtended
=
true
;
registerCleanupFunction
(
(
)
=
>
{
Services
.
telemetry
.
canRecordExtended
=
oldCanRecord
;
}
)
;
}
)
;
add_task
(
function
*
test_close_time_anim_probe
(
)
{
let
tab
=
yield
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
yield
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
tab
.
_fullyOpen
)
;
gAnimHistogram
.
clear
(
)
;
gNoAnimHistogram
.
clear
(
)
;
yield
BrowserTestUtils
.
removeTab
(
tab
{
animate
:
true
}
)
;
assertCount
(
gAnimHistogram
.
snapshot
(
)
1
)
;
assertCount
(
gNoAnimHistogram
.
snapshot
(
)
0
)
;
gAnimHistogram
.
clear
(
)
;
gNoAnimHistogram
.
clear
(
)
;
}
)
;
add_task
(
function
*
test_close_time_no_anim_probe
(
)
{
let
tab
=
yield
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
)
;
yield
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
tab
.
_fullyOpen
)
;
gAnimHistogram
.
clear
(
)
;
gNoAnimHistogram
.
clear
(
)
;
yield
BrowserTestUtils
.
removeTab
(
tab
{
animate
:
false
}
)
;
assertCount
(
gAnimHistogram
.
snapshot
(
)
0
)
;
assertCount
(
gNoAnimHistogram
.
snapshot
(
)
1
)
;
gAnimHistogram
.
clear
(
)
;
gNoAnimHistogram
.
clear
(
)
;
}
)
;
