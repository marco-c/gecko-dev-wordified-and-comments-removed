function
test
(
)
{
waitForExplicitFinish
(
)
;
ok
(
PopupNotifications
"
PopupNotifications
object
exists
"
)
;
ok
(
PopupNotifications
.
panel
"
PopupNotifications
panel
exists
"
)
;
setup
(
)
;
}
var
tests
=
[
{
id
:
"
Test
#
1
"
async
run
(
)
{
this
.
oldSelectedTab
=
gBrowser
.
selectedTab
;
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
this
.
notifyObj
=
new
BasicNotification
(
this
.
id
)
;
this
.
notifyObj
.
anchorID
=
"
geo
-
notification
-
icon
"
;
this
.
notification
=
showNotification
(
this
.
notifyObj
)
;
}
onShown
(
popup
)
{
checkPopup
(
popup
this
.
notifyObj
)
;
is
(
document
.
getElementById
(
"
geo
-
notification
-
icon
"
)
.
boxObject
.
width
0
"
geo
anchor
shouldn
'
t
be
visible
"
)
;
is
(
popup
.
anchorNode
.
id
"
identity
-
icon
"
"
notification
anchored
to
identity
icon
"
)
;
dismissNotification
(
popup
)
;
}
onHidden
(
popup
)
{
this
.
notification
.
remove
(
)
;
gBrowser
.
removeTab
(
gBrowser
.
selectedTab
)
;
gBrowser
.
selectedTab
=
this
.
oldSelectedTab
;
}
}
{
id
:
"
Test
#
2
"
async
run
(
)
{
this
.
oldSelectedTab
=
gBrowser
.
selectedTab
;
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
http
:
/
/
example
.
com
/
"
)
;
this
.
notifyObj
=
new
BasicNotification
(
this
.
id
)
;
this
.
notifyObj
.
anchorID
=
"
geo
-
notification
-
icon
"
;
this
.
notifyObj
.
addOptions
(
{
persistence
:
1
}
)
;
this
.
notification
=
showNotification
(
this
.
notifyObj
)
;
}
async
onShown
(
popup
)
{
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
"
about
:
blank
"
)
;
checkPopup
(
popup
this
.
notifyObj
)
;
is
(
document
.
getElementById
(
"
geo
-
notification
-
icon
"
)
.
boxObject
.
width
0
"
geo
anchor
shouldn
'
t
be
visible
"
)
;
is
(
popup
.
anchorNode
.
id
"
identity
-
icon
"
"
notification
anchored
to
identity
icon
"
)
;
dismissNotification
(
popup
)
;
}
onHidden
(
popup
)
{
this
.
notification
.
remove
(
)
;
gBrowser
.
removeTab
(
gBrowser
.
selectedTab
)
;
gBrowser
.
selectedTab
=
this
.
oldSelectedTab
;
}
}
{
id
:
"
Test
#
3
"
async
run
(
)
{
this
.
oldSelectedTab
=
gBrowser
.
selectedTab
;
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
about
:
blank
"
)
;
this
.
notifyObj
=
new
BasicNotification
(
this
.
id
)
;
this
.
notifyObj
.
anchorID
=
"
geo
-
notification
-
icon
"
;
this
.
notifyObj
.
addOptions
(
{
dismissed
:
true
persistence
:
1
}
)
;
this
.
notification
=
showNotification
(
this
.
notifyObj
)
;
is
(
document
.
getElementById
(
"
geo
-
notification
-
icon
"
)
.
boxObject
.
width
0
"
geo
anchor
shouldn
'
t
be
visible
"
)
;
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
"
http
:
/
/
example
.
com
/
"
)
;
isnot
(
document
.
getElementById
(
"
geo
-
notification
-
icon
"
)
.
boxObject
.
width
0
"
geo
anchor
should
be
visible
"
)
;
EventUtils
.
synthesizeMouse
(
document
.
getElementById
(
"
geo
-
notification
-
icon
"
)
0
0
{
}
)
;
}
onShown
(
popup
)
{
checkPopup
(
popup
this
.
notifyObj
)
;
dismissNotification
(
popup
)
;
}
onHidden
(
popup
)
{
this
.
notification
.
remove
(
)
;
gBrowser
.
removeTab
(
gBrowser
.
selectedTab
)
;
gBrowser
.
selectedTab
=
this
.
oldSelectedTab
;
}
}
{
id
:
"
Test
#
4
"
*
run
(
)
{
for
(
let
persistent
of
[
false
true
]
)
{
let
shown
=
waitForNotificationPanel
(
)
;
this
.
notifyObj
=
new
BasicNotification
(
this
.
id
)
;
this
.
notifyObj
.
anchorID
=
"
geo
-
notification
-
icon
"
;
this
.
notifyObj
.
addOptions
(
{
persistent
}
)
;
this
.
notification
=
showNotification
(
this
.
notifyObj
)
;
yield
shown
;
checkPopup
(
PopupNotifications
.
panel
this
.
notifyObj
)
;
let
hidden
=
waitForNotificationPanelHidden
(
)
;
gURLBar
.
select
(
)
;
EventUtils
.
synthesizeKey
(
"
*
"
{
}
)
;
yield
hidden
;
is
(
document
.
getElementById
(
"
geo
-
notification
-
icon
"
)
.
boxObject
.
width
0
"
geo
anchor
shouldn
'
t
be
visible
"
)
;
shown
=
waitForNotificationPanel
(
)
;
EventUtils
.
synthesizeKey
(
"
VK_BACK_SPACE
"
{
}
)
;
EventUtils
.
synthesizeKey
(
"
VK_TAB
"
{
}
)
;
yield
shown
;
is
(
PopupNotifications
.
panel
.
anchorNode
.
id
"
identity
-
icon
"
"
notification
anchored
to
identity
icon
"
)
;
hidden
=
waitForNotificationPanelHidden
(
)
;
EventUtils
.
synthesizeKey
(
"
VK_TAB
"
{
shiftKey
:
true
}
)
;
yield
hidden
;
shown
=
waitForNotificationPanel
(
)
;
EventUtils
.
synthesizeKey
(
"
VK_ESCAPE
"
{
}
)
;
yield
shown
;
checkPopup
(
PopupNotifications
.
panel
this
.
notifyObj
)
;
hidden
=
waitForNotificationPanelHidden
(
)
;
this
.
notification
.
remove
(
)
;
yield
hidden
;
}
goNext
(
)
;
}
}
{
id
:
"
Test
#
5
"
*
run
(
)
{
for
(
let
persistent
of
[
false
true
]
)
{
gURLBar
.
select
(
)
;
EventUtils
.
synthesizeKey
(
"
*
"
{
}
)
;
EventUtils
.
synthesizeKey
(
"
VK_BACK_SPACE
"
{
}
)
;
let
notShowing
=
promiseTopicObserved
(
"
PopupNotifications
-
updateNotShowing
"
)
;
this
.
notifyObj
=
new
BasicNotification
(
this
.
id
)
;
this
.
notifyObj
.
anchorID
=
"
geo
-
notification
-
icon
"
;
this
.
notifyObj
.
addOptions
(
{
persistent
}
)
;
this
.
notification
=
showNotification
(
this
.
notifyObj
)
;
yield
notShowing
;
let
shown
=
waitForNotificationPanel
(
)
;
EventUtils
.
synthesizeKey
(
"
VK_ESCAPE
"
{
}
)
;
yield
shown
;
checkPopup
(
PopupNotifications
.
panel
this
.
notifyObj
)
;
let
hidden
=
waitForNotificationPanelHidden
(
)
;
this
.
notification
.
remove
(
)
;
yield
hidden
;
}
goNext
(
)
;
}
}
{
id
:
"
Test
#
6
"
async
run
(
)
{
let
shown
=
waitForNotificationPanel
(
)
;
this
.
notifyObj
=
new
BasicNotification
(
this
.
id
)
;
this
.
notifyObj
.
anchorID
=
"
geo
-
notification
-
icon
"
;
this
.
notifyObj
.
addOptions
(
{
persistent
:
true
}
)
;
this
.
notification
=
showNotification
(
this
.
notifyObj
)
;
await
shown
;
let
hidden
=
waitForNotificationPanelHidden
(
)
;
this
.
oldSelectedTab
=
gBrowser
.
selectedTab
;
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
http
:
/
/
example
.
com
/
"
)
;
await
hidden
;
gURLBar
.
select
(
)
;
EventUtils
.
synthesizeKey
(
"
*
"
{
}
)
;
shown
=
waitForNotificationPanel
(
)
;
gBrowser
.
removeTab
(
gBrowser
.
selectedTab
)
;
gBrowser
.
selectedTab
=
this
.
oldSelectedTab
;
await
shown
;
checkPopup
(
PopupNotifications
.
panel
this
.
notifyObj
)
;
hidden
=
waitForNotificationPanelHidden
(
)
;
this
.
notification
.
remove
(
)
;
await
hidden
;
goNext
(
)
;
}
}
]
;
