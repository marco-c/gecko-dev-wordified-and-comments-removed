const
TEST_PATH
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
com
"
)
;
const
PERMISSIONS_PAGE
=
TEST_PATH
+
"
permissions
.
html
"
;
CustomizableUI
.
removeWidgetFromArea
(
"
developer
-
button
"
)
;
registerCleanupFunction
(
async
function
resetToolbar
(
)
{
await
CustomizableUI
.
reset
(
)
;
}
)
;
add_task
(
async
function
setupHomeButton
(
)
{
CustomizableUI
.
addWidgetToArea
(
"
home
-
button
"
"
nav
-
bar
"
CustomizableUI
.
getPlacementOfWidget
(
"
stop
-
reload
-
button
"
)
.
position
+
1
)
;
}
)
;
function
synthesizeKeyAndWaitForFocus
(
element
keyCode
options
)
{
let
focused
=
BrowserTestUtils
.
waitForEvent
(
element
"
focus
"
)
;
EventUtils
.
synthesizeKey
(
keyCode
options
)
;
return
focused
;
}
add_task
(
async
function
testWithoutNotifications
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
accessibility
.
tabfocus
"
7
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
"
https
:
/
/
example
.
com
"
async
function
(
)
{
await
synthesizeKeyAndWaitForFocus
(
gURLBar
"
l
"
{
accelKey
:
true
}
)
;
is
(
document
.
activeElement
gURLBar
.
inputField
"
urlbar
should
be
focused
"
)
;
await
synthesizeKeyAndWaitForFocus
(
gProtectionsHandler
.
_trackingProtectionIconContainer
"
VK_TAB
"
{
shiftKey
:
true
}
)
;
is
(
document
.
activeElement
gProtectionsHandler
.
_trackingProtectionIconContainer
"
tracking
protection
icon
container
should
be
focused
"
)
;
}
)
;
}
)
;
add_task
(
async
function
testWithNotifications
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
accessibility
.
tabfocus
"
7
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
PERMISSIONS_PAGE
async
function
(
browser
)
{
let
popupshown
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
geo
"
{
}
browser
)
;
await
popupshown
;
await
synthesizeKeyAndWaitForFocus
(
gURLBar
"
l
"
{
accelKey
:
true
}
)
;
is
(
document
.
activeElement
gURLBar
.
inputField
"
urlbar
should
be
focused
"
)
;
await
synthesizeKeyAndWaitForFocus
(
gProtectionsHandler
.
_trackingProtectionIconContainer
"
VK_TAB
"
{
shiftKey
:
true
}
)
;
is
(
document
.
activeElement
gProtectionsHandler
.
_trackingProtectionIconContainer
"
tracking
protection
icon
container
should
be
focused
"
)
;
await
synthesizeKeyAndWaitForFocus
(
gIdentityHandler
.
_identityIconBox
"
ArrowRight
"
)
;
is
(
document
.
activeElement
gIdentityHandler
.
_identityIconBox
"
identity
block
should
be
focused
"
)
;
let
geoIcon
=
document
.
getElementById
(
"
geo
-
notification
-
icon
"
)
;
await
synthesizeKeyAndWaitForFocus
(
geoIcon
"
ArrowRight
"
)
;
is
(
document
.
activeElement
geoIcon
"
notification
anchor
should
be
focused
"
)
;
}
)
;
}
)
;
add_task
(
async
function
testInvalidPageProxyState
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
accessibility
.
tabfocus
"
7
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
async
function
(
browser
)
{
if
(
document
.
activeElement
!
=
gURLBar
.
inputField
)
{
await
synthesizeKeyAndWaitForFocus
(
gURLBar
"
l
"
{
accelKey
:
true
}
)
;
}
is
(
document
.
activeElement
gURLBar
.
inputField
"
urlbar
should
be
focused
"
)
;
await
synthesizeKeyAndWaitForFocus
(
document
.
getElementById
(
"
home
-
button
"
)
"
VK_TAB
"
{
shiftKey
:
true
}
)
;
await
synthesizeKeyAndWaitForFocus
(
gBrowser
.
getTabForBrowser
(
browser
)
"
VK_TAB
"
{
shiftKey
:
true
}
)
;
isnot
(
document
.
activeElement
gProtectionsHandler
.
_trackingProtectionIconContainer
"
tracking
protection
icon
container
should
not
be
focused
"
)
;
gURLBar
.
focus
(
)
;
}
)
;
}
)
;
