"
use
strict
"
;
add_task
(
async
function
testTempPermissionOnReload
(
)
{
let
origin
=
"
https
:
/
/
example
.
com
/
"
;
let
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
origin
)
;
let
id
=
"
geo
"
;
await
BrowserTestUtils
.
withNewTab
(
origin
async
function
(
browser
)
{
SitePermissions
.
setForPrincipal
(
principal
id
SitePermissions
.
BLOCK
SitePermissions
.
SCOPE_TEMPORARY
browser
)
;
let
reloaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
origin
)
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
principal
id
browser
)
{
state
:
SitePermissions
.
BLOCK
scope
:
SitePermissions
.
SCOPE_TEMPORARY
}
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
content
.
document
.
location
.
reload
(
)
)
;
await
reloaded
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
principal
id
browser
)
{
state
:
SitePermissions
.
BLOCK
scope
:
SitePermissions
.
SCOPE_TEMPORARY
}
)
;
reloaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
origin
)
;
BrowserReload
(
)
;
await
reloaded
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
principal
id
browser
)
{
state
:
SitePermissions
.
UNKNOWN
scope
:
SitePermissions
.
SCOPE_PERSISTENT
}
)
;
SitePermissions
.
setForPrincipal
(
principal
id
SitePermissions
.
BLOCK
SitePermissions
.
SCOPE_TEMPORARY
browser
)
;
let
contextMenu
=
document
.
getElementById
(
"
tabContextMenu
"
)
;
gBrowser
.
selectedTab
.
focus
(
)
;
let
popupShownPromise
=
BrowserTestUtils
.
waitForEvent
(
contextMenu
"
popupshown
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
gBrowser
.
selectedTab
{
type
:
"
contextmenu
"
button
:
2
}
)
;
await
popupShownPromise
;
let
reloadMenuItem
=
document
.
getElementById
(
"
context_reloadTab
"
)
;
reloaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
origin
)
;
EventUtils
.
synthesizeMouseAtCenter
(
reloadMenuItem
{
}
)
;
await
reloaded
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
principal
id
browser
)
{
state
:
SitePermissions
.
UNKNOWN
scope
:
SitePermissions
.
SCOPE_PERSISTENT
}
)
;
SitePermissions
.
setForPrincipal
(
principal
id
SitePermissions
.
BLOCK
SitePermissions
.
SCOPE_TEMPORARY
browser
)
;
let
urlBarInput
=
document
.
getElementById
(
"
urlbar
-
input
"
)
;
await
EventUtils
.
synthesizeMouseAtCenter
(
urlBarInput
{
}
)
;
reloaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
origin
)
;
EventUtils
.
synthesizeAndWaitKey
(
"
VK_RETURN
"
{
}
)
;
await
reloaded
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
principal
id
browser
)
{
state
:
SitePermissions
.
UNKNOWN
scope
:
SitePermissions
.
SCOPE_PERSISTENT
}
)
;
SitePermissions
.
removeFromPrincipal
(
principal
id
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
testTempPermissionOnReloadAllTabs
(
)
{
let
origin
=
"
https
:
/
/
example
.
com
/
"
;
let
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
origin
)
;
let
id
=
"
geo
"
;
await
BrowserTestUtils
.
withNewTab
(
origin
async
function
(
browser
)
{
SitePermissions
.
setForPrincipal
(
principal
id
SitePermissions
.
BLOCK
SitePermissions
.
SCOPE_TEMPORARY
browser
)
;
gBrowser
.
selectAllTabs
(
)
;
let
contextMenu
=
document
.
getElementById
(
"
tabContextMenu
"
)
;
gBrowser
.
selectedTab
.
focus
(
)
;
let
popupShownPromise
=
BrowserTestUtils
.
waitForEvent
(
contextMenu
"
popupshown
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
gBrowser
.
selectedTab
{
type
:
"
contextmenu
"
button
:
2
}
)
;
await
popupShownPromise
;
let
reloadMenuItem
=
document
.
getElementById
(
"
context_reloadSelectedTabs
"
)
;
let
reloaded
=
Promise
.
all
(
gBrowser
.
visibleTabs
.
map
(
tab
=
>
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
getBrowserForTab
(
tab
)
)
)
)
;
EventUtils
.
synthesizeMouseAtCenter
(
reloadMenuItem
{
}
)
;
await
reloaded
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
principal
id
browser
)
{
state
:
SitePermissions
.
BLOCK
scope
:
SitePermissions
.
SCOPE_TEMPORARY
}
)
;
SitePermissions
.
removeFromPrincipal
(
principal
id
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
testTempPermissionOnNavigation
(
)
{
let
origin
=
"
https
:
/
/
example
.
com
/
"
;
let
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
origin
)
;
let
id
=
"
geo
"
;
await
BrowserTestUtils
.
withNewTab
(
origin
async
function
(
browser
)
{
SitePermissions
.
setForPrincipal
(
principal
id
SitePermissions
.
BLOCK
SitePermissions
.
SCOPE_TEMPORARY
browser
)
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
principal
id
browser
)
{
state
:
SitePermissions
.
BLOCK
scope
:
SitePermissions
.
SCOPE_TEMPORARY
}
)
;
let
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
"
https
:
/
/
example
.
org
/
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
(
content
.
document
.
location
=
"
https
:
/
/
example
.
org
/
"
)
)
;
await
loaded
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
browser
.
contentPrincipal
id
browser
)
{
state
:
SitePermissions
.
UNKNOWN
scope
:
SitePermissions
.
SCOPE_PERSISTENT
}
)
;
loaded
=
BrowserTestUtils
.
browserLoaded
(
browser
false
origin
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
(
)
=
>
(
content
.
document
.
location
=
"
https
:
/
/
example
.
com
/
"
)
)
;
await
loaded
;
Assert
.
deepEqual
(
SitePermissions
.
getForPrincipal
(
browser
.
contentPrincipal
id
browser
)
{
state
:
SitePermissions
.
BLOCK
scope
:
SitePermissions
.
SCOPE_TEMPORARY
}
)
;
SitePermissions
.
removeFromPrincipal
(
browser
.
contentPrincipal
id
browser
)
;
}
)
;
}
)
;
