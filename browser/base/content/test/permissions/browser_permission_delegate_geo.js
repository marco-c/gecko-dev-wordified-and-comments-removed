"
use
strict
"
;
const
ORIGIN
=
"
https
:
/
/
example
.
com
"
;
const
CROSS_SUBFRAME_PAGE
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
ORIGIN
)
+
"
temporary_permissions_subframe
.
html
"
;
const
PromptResult
=
{
ALLOW
:
"
allow
"
DENY
:
"
deny
"
PROMPT
:
"
prompt
"
}
;
var
Perms
=
Services
.
perms
;
var
uri
=
NetUtil
.
newURI
(
ORIGIN
)
;
var
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipal
(
uri
{
}
)
;
add_task
(
async
function
setup
(
)
{
await
new
Promise
(
r
=
>
{
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
security
.
featurePolicy
.
enabled
"
true
]
[
"
dom
.
security
.
featurePolicy
.
header
.
enabled
"
true
]
[
"
dom
.
security
.
featurePolicy
.
webidl
.
enabled
"
true
]
[
"
permissions
.
delegation
.
enabled
"
true
]
]
}
r
)
;
}
)
;
}
)
;
add_task
(
async
function
testUseTempPermissionsFirstParty
(
)
{
await
BrowserTestUtils
.
withNewTab
(
CROSS_SUBFRAME_PAGE
async
function
(
browser
)
{
SitePermissions
.
setForPrincipal
(
principal
"
geo
"
SitePermissions
.
BLOCK
SitePermissions
.
SCOPE_TEMPORARY
browser
)
;
await
ContentTask
.
spawn
(
browser
uri
.
host
async
function
(
host0
)
{
let
frame
=
content
.
document
.
getElementById
(
"
frame
"
)
;
function
onMessage
(
event
)
{
is
(
event
.
data
"
deny
"
"
Expected
deny
for
third
party
"
)
;
content
.
window
.
removeEventListener
(
"
message
"
onMessage
)
;
}
content
.
window
.
addEventListener
(
"
message
"
onMessage
)
;
await
content
.
SpecialPowers
.
spawn
(
frame
[
host0
]
async
function
(
host
)
{
const
{
E10SUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
E10SUtils
.
jsm
"
)
;
E10SUtils
.
wrapHandlingUserInput
(
this
.
content
true
function
(
)
{
let
frameDoc
=
this
.
content
.
document
;
frameDoc
.
getElementById
(
"
geo
"
)
.
click
(
)
;
}
)
;
}
)
;
}
)
;
SitePermissions
.
removeFromPrincipal
(
principal
"
geo
"
browser
)
;
}
)
;
}
)
;
add_task
(
async
function
testUsePersistentPermissionsFirstParty
(
)
{
await
BrowserTestUtils
.
withNewTab
(
CROSS_SUBFRAME_PAGE
async
function
(
browser
)
{
async
function
checkPermission
(
aPermission
aExpect
)
{
PermissionTestUtils
.
add
(
uri
"
geo
"
aPermission
)
;
let
waitForPrompt
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popupshown
"
)
;
await
ContentTask
.
spawn
(
browser
{
host
:
uri
.
host
expect
:
aExpect
}
async
function
(
args
)
{
let
frame
=
content
.
document
.
getElementById
(
"
frame
"
)
;
if
(
args
.
expect
!
=
"
prompt
"
)
{
function
onMessage
(
event
)
{
is
(
event
.
data
args
.
expect
"
Expected
correct
permission
for
third
party
"
)
;
content
.
window
.
removeEventListener
(
"
message
"
onMessage
)
;
}
content
.
window
.
addEventListener
(
"
message
"
onMessage
)
;
}
await
content
.
SpecialPowers
.
spawn
(
frame
[
args
.
host
]
async
function
(
host
)
{
const
{
E10SUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
E10SUtils
.
jsm
"
)
;
E10SUtils
.
wrapHandlingUserInput
(
this
.
content
true
function
(
)
{
let
frameDoc
=
this
.
content
.
document
;
frameDoc
.
getElementById
(
"
geo
"
)
.
click
(
)
;
}
)
;
}
)
;
}
)
;
if
(
aExpect
=
=
PromptResult
.
PROMPT
)
{
await
waitForPrompt
;
let
popuphidden
=
BrowserTestUtils
.
waitForEvent
(
PopupNotifications
.
panel
"
popuphidden
"
)
;
let
notification
=
PopupNotifications
.
panel
.
firstElementChild
;
is
(
PopupNotifications
.
getNotification
(
"
geolocation
"
)
.
options
.
name
uri
.
host
"
Use
first
party
'
s
origin
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
notification
.
secondaryButton
{
}
)
;
await
popuphidden
;
SitePermissions
.
removeFromPrincipal
(
null
"
geo
"
browser
)
;
}
PermissionTestUtils
.
remove
(
uri
"
geo
"
)
;
}
await
checkPermission
(
Perms
.
PROMPT_ACTION
PromptResult
.
PROMPT
)
;
await
checkPermission
(
Perms
.
DENY_ACTION
PromptResult
.
DENY
)
;
await
checkPermission
(
Perms
.
ALLOW_ACTION
PromptResult
.
ALLOW
)
;
}
)
;
}
)
;
