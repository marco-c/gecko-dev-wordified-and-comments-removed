add_task
(
async
function
setup
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
extensions
.
install
.
requireBuiltInCerts
"
false
]
[
"
extensions
.
update
.
requireBuiltInCerts
"
false
]
[
"
xpinstall
.
signatures
.
required
"
false
]
[
"
extensions
.
update
.
url
"
{
BASE
}
/
browser_webext_update
.
json
]
]
}
)
;
}
)
;
async
function
testUpdateNoPrompt
(
filename
id
initialVersion
=
"
1
.
0
"
updateVersion
=
"
2
.
0
"
)
{
BrowserTestUtils
.
loadURI
(
gBrowser
.
selectedBrowser
"
about
:
robots
"
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
let
addon
=
await
promiseInstallAddon
(
{
BASE
}
/
{
filename
}
)
;
ok
(
addon
"
Addon
was
installed
"
)
;
is
(
addon
.
version
initialVersion
"
Version
1
of
the
addon
is
installed
"
)
;
let
win
=
await
BrowserOpenAddonsMgr
(
"
addons
:
/
/
list
/
extension
"
)
;
await
BrowserTestUtils
.
waitForEvent
(
win
.
document
"
ViewChanged
"
)
;
let
sawPopup
=
false
;
function
popupListener
(
)
{
sawPopup
=
true
;
}
PopupNotifications
.
panel
.
addEventListener
(
"
popupshown
"
popupListener
)
;
let
updatePromise
=
waitForUpdate
(
addon
)
;
triggerPageOptionsAction
(
win
"
check
-
for
-
updates
"
)
;
await
updatePromise
;
addon
=
await
AddonManager
.
getAddonByID
(
id
)
;
is
(
addon
.
version
updateVersion
"
Should
have
upgraded
"
)
;
ok
(
!
sawPopup
"
Should
not
have
seen
a
permission
notification
"
)
;
PopupNotifications
.
panel
.
removeEventListener
(
"
popupshown
"
popupListener
)
;
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
await
addon
.
uninstall
(
)
;
}
add_task
(
(
)
=
>
testUpdateNoPrompt
(
"
browser_webext_update_perms1
.
xpi
"
"
update_perms
tests
.
mozilla
.
org
"
)
)
;
add_task
(
(
)
=
>
testUpdateNoPrompt
(
"
browser_webext_update_origins1
.
xpi
"
"
update_origins
tests
.
mozilla
.
org
"
)
)
;
