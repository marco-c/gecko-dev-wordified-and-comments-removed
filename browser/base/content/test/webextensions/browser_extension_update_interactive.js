const
{
AddonManagerPrivate
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
AddonManager
.
jsm
"
{
}
)
;
const
ID
=
"
update2
tests
.
mozilla
.
org
"
;
const
ID_LEGACY
=
"
legacy_update
tests
.
mozilla
.
org
"
;
add_task
(
function
*
setup
(
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
extensions
.
install
.
requireBuiltInCerts
"
false
]
[
"
extensions
.
update
.
requireBuiltInCerts
"
false
]
[
"
extensions
.
webextPermissionPrompts
"
true
]
]
}
)
;
}
)
;
function
*
interactiveUpdateTest
(
autoUpdate
checkFn
)
{
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
extensions
.
update
.
autoUpdateDefault
"
autoUpdate
]
[
"
extensions
.
update
.
url
"
{
BASE
}
/
browser_webext_update
.
json
]
]
}
)
;
function
*
triggerUpdate
(
win
addon
)
{
let
manualUpdatePromise
;
if
(
!
autoUpdate
)
{
manualUpdatePromise
=
new
Promise
(
resolve
=
>
{
let
listener
=
{
onNewInstall
(
)
{
AddonManager
.
removeInstallListener
(
listener
)
;
resolve
(
)
;
}
}
;
AddonManager
.
addInstallListener
(
listener
)
;
}
)
;
}
checkFn
(
win
addon
)
;
if
(
manualUpdatePromise
)
{
yield
manualUpdatePromise
;
let
list
=
win
.
document
.
getElementById
(
"
addon
-
list
"
)
;
list
.
clientHeight
;
let
item
=
list
.
children
.
find
(
_item
=
>
_item
.
value
=
=
ID
)
;
EventUtils
.
synthesizeMouseAtCenter
(
item
.
_updateBtn
{
}
win
)
;
}
}
gBrowser
.
selectedBrowser
.
loadURI
(
"
about
:
robots
"
)
;
yield
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
let
addon
=
yield
promiseInstallAddon
(
{
BASE
}
/
browser_webext_update1
.
xpi
)
;
ok
(
addon
"
Addon
was
installed
"
)
;
is
(
addon
.
version
"
1
.
0
"
"
Version
1
of
the
addon
is
installed
"
)
;
let
win
=
yield
BrowserOpenAddonsMgr
(
"
addons
:
/
/
list
/
extension
"
)
;
let
popupPromise
=
promisePopupNotificationShown
(
"
addon
-
webext
-
permissions
"
)
;
yield
triggerUpdate
(
win
addon
)
;
let
panel
=
yield
popupPromise
;
let
cancelPromise
=
promiseInstallEvent
(
addon
"
onInstallCancelled
"
)
;
panel
.
secondaryButton
.
click
(
)
;
yield
cancelPromise
;
addon
=
yield
AddonManager
.
getAddonByID
(
ID
)
;
is
(
addon
.
version
"
1
.
0
"
"
Should
still
be
running
the
old
version
"
)
;
popupPromise
=
promisePopupNotificationShown
(
"
addon
-
webext
-
permissions
"
)
;
yield
triggerUpdate
(
win
addon
)
;
let
updatePromise
=
promiseInstallEvent
(
addon
"
onInstallEnded
"
)
;
panel
=
yield
popupPromise
;
panel
.
button
.
click
(
)
;
addon
=
yield
updatePromise
;
is
(
addon
.
version
"
2
.
0
"
"
Should
have
upgraded
"
)
;
yield
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
addon
.
uninstall
(
)
;
yield
SpecialPowers
.
popPrefEnv
(
)
;
}
function
checkAll
(
win
)
{
win
.
gViewController
.
doCommand
(
"
cmd_findAllUpdates
"
)
;
}
add_task
(
(
)
=
>
interactiveUpdateTest
(
true
checkAll
)
)
;
add_task
(
(
)
=
>
interactiveUpdateTest
(
false
checkAll
)
)
;
function
checkOne
(
win
addon
)
{
win
.
gViewController
.
doCommand
(
"
cmd_findItemUpdates
"
addon
)
;
}
add_task
(
(
)
=
>
interactiveUpdateTest
(
true
checkOne
)
)
;
add_task
(
(
)
=
>
interactiveUpdateTest
(
false
checkOne
)
)
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
extensions
.
update
.
url
"
{
BASE
}
/
browser_webext_update
.
json
]
]
}
)
;
gBrowser
.
selectedBrowser
.
loadURI
(
"
about
:
robots
"
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
.
selectedBrowser
)
;
let
addon
=
await
promiseInstallAddon
(
{
BASE
}
/
browser_legacy
.
xpi
)
;
ok
(
addon
"
Addon
was
installed
"
)
;
is
(
addon
.
version
"
1
.
1
"
"
Version
1
of
the
addon
is
installed
"
)
;
let
win
=
await
BrowserOpenAddonsMgr
(
"
addons
:
/
/
list
/
extension
"
)
;
let
sawPopup
=
false
;
PopupNotifications
.
panel
.
addEventListener
(
"
popupshown
"
(
)
=
>
sawPopup
=
true
{
once
:
true
}
)
;
let
updatePromise
=
promiseInstallEvent
(
addon
"
onInstallEnded
"
)
;
win
.
gViewController
.
doCommand
(
"
cmd_findAllUpdates
"
)
;
await
updatePromise
;
addon
=
await
AddonManager
.
getAddonByID
(
ID_LEGACY
)
;
is
(
addon
.
version
"
2
.
0
"
"
Should
have
upgraded
"
)
;
ok
(
!
sawPopup
"
Should
not
have
seen
a
permission
notification
"
)
;
await
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
addon
.
uninstall
(
)
;
await
SpecialPowers
.
popPrefEnv
(
)
;
}
)
;
