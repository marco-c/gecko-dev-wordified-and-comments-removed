var
gTestBrowser
=
null
;
var
gTestRoot
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
/
"
"
http
:
/
/
127
.
0
.
0
.
1
:
8888
/
"
)
;
var
gChromeRoot
=
getRootDirectory
(
gTestPath
)
;
add_task
(
async
function
(
)
{
registerCleanupFunction
(
async
function
(
)
{
clearAllPluginPermissions
(
)
;
Services
.
prefs
.
clearUserPref
(
"
extensions
.
blocklist
.
suppressUI
"
)
;
setTestPluginEnabledState
(
Ci
.
nsIPluginTag
.
STATE_ENABLED
"
Test
Plug
-
in
"
)
;
setTestPluginEnabledState
(
Ci
.
nsIPluginTag
.
STATE_ENABLED
"
Second
Test
Plug
-
in
"
)
;
await
asyncSetAndUpdateBlocklist
(
gTestRoot
+
"
blockNoPlugins
"
gTestBrowser
)
;
gBrowser
.
removeCurrentTab
(
)
;
window
.
focus
(
)
;
gTestBrowser
=
null
;
}
)
;
}
)
;
add_task
(
async
function
(
)
{
Services
.
prefs
.
setBoolPref
(
"
extensions
.
blocklist
.
suppressUI
"
true
)
;
gBrowser
.
selectedTab
=
BrowserTestUtils
.
addTab
(
gBrowser
)
;
gTestBrowser
=
gBrowser
.
selectedBrowser
;
setTestPluginEnabledState
(
Ci
.
nsIPluginTag
.
STATE_ENABLED
"
Test
Plug
-
in
"
)
;
setTestPluginEnabledState
(
Ci
.
nsIPluginTag
.
STATE_ENABLED
"
Second
Test
Plug
-
in
"
)
;
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
"
data
:
text
/
html
<
html
>
<
/
html
>
"
)
;
}
)
;
add_task
(
async
function
(
)
{
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
gTestRoot
+
"
plugin_test
.
html
"
)
;
await
asyncSetAndUpdateBlocklist
(
gTestRoot
+
"
blockNoPlugins
"
gTestBrowser
)
;
await
promiseUpdatePluginBindings
(
gTestBrowser
)
;
await
SpecialPowers
.
spawn
(
gTestBrowser
[
]
async
function
(
)
{
let
test
=
content
.
document
.
getElementById
(
"
test
"
)
;
Assert
.
ok
(
test
.
activated
"
task
1a
:
test
plugin
should
be
activated
!
"
)
;
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
"
data
:
text
/
html
<
html
>
GO
!
<
/
html
>
"
)
;
await
asyncSetAndUpdateBlocklist
(
gTestRoot
+
"
blockPluginHard
"
gTestBrowser
)
;
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
gTestRoot
+
"
plugin_test
.
html
"
)
;
await
promiseUpdatePluginBindings
(
gTestBrowser
)
;
await
SpecialPowers
.
spawn
(
gTestBrowser
[
]
async
function
(
)
{
let
test
=
content
.
document
.
getElementById
(
"
test
"
)
;
ok
(
!
test
.
activated
"
task
2a
:
test
plugin
shouldn
'
t
activate
!
"
)
;
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
"
data
:
text
/
html
<
html
>
GO
!
<
/
html
>
"
)
;
await
asyncSetAndUpdateBlocklist
(
gTestRoot
+
"
blockNoPlugins
"
gTestBrowser
)
;
let
base
=
gChromeRoot
.
slice
(
0
-
1
)
;
let
actor
=
{
child
:
{
moduleURI
:
{
base
}
/
BlocklistTestProxy
.
jsm
observer
:
[
"
webnavigation
-
create
"
]
}
}
;
ChromeUtils
.
registerProcessActor
(
"
BlocklistTestProxy
"
actor
)
;
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
gTestRoot
+
"
plugin_test
.
html
"
)
;
await
promiseUpdatePluginBindings
(
gTestBrowser
)
;
await
SpecialPowers
.
spawn
(
gTestBrowser
[
]
async
function
(
)
{
let
test
=
content
.
document
.
getElementById
(
"
test
"
)
;
Assert
.
ok
(
test
.
activated
"
task
3a
:
test
plugin
should
be
activated
!
"
)
;
}
)
;
registerCleanupFunction
(
async
function
(
)
{
let
dp
=
gBrowser
.
selectedBrowser
.
browsingContext
.
currentWindowGlobal
.
domProcess
;
await
dp
.
getActor
(
"
BlocklistTestProxy
"
)
.
sendQuery
(
"
unload
"
)
;
ChromeUtils
.
unregisterProcessActor
(
"
BlocklistTestProxy
"
actor
)
;
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
"
data
:
text
/
html
<
html
>
GO
!
<
/
html
>
"
)
;
await
asyncSetAndUpdateBlocklist
(
gTestRoot
+
"
blockPluginHard
"
gTestBrowser
)
;
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
gTestRoot
+
"
plugin_test
.
html
"
)
;
await
promiseUpdatePluginBindings
(
gTestBrowser
)
;
await
SpecialPowers
.
spawn
(
gTestBrowser
[
]
async
function
(
)
{
let
test
=
content
.
document
.
getElementById
(
"
test
"
)
;
Assert
.
ok
(
!
test
.
activated
"
task
4a
:
test
plugin
shouldn
'
t
activate
!
"
)
;
}
)
;
await
asyncSetAndUpdateBlocklist
(
gTestRoot
+
"
blockNoPlugins
"
gTestBrowser
)
;
}
)
;
