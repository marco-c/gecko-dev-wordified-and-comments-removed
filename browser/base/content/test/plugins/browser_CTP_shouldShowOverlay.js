"
use
strict
"
;
var
rootDir
=
getRootDirectory
(
gTestPath
)
;
const
gTestRoot
=
rootDir
.
replace
(
"
chrome
:
/
/
mochitests
/
content
/
"
"
http
:
/
/
127
.
0
.
0
.
1
:
8888
/
"
)
;
var
gTestBrowser
=
null
;
add_task
(
async
function
(
)
{
registerCleanupFunction
(
function
(
)
{
clearAllPluginPermissions
(
)
;
setTestPluginEnabledState
(
Ci
.
nsIPluginTag
.
STATE_ENABLED
"
Test
Plug
-
in
"
)
;
gBrowser
.
removeCurrentTab
(
)
;
gTestBrowser
=
null
;
}
)
;
}
)
;
add_task
(
async
function
(
)
{
gBrowser
.
selectedTab
=
BrowserTestUtils
.
addTab
(
gBrowser
)
;
gTestBrowser
=
gBrowser
.
selectedBrowser
;
setTestPluginEnabledState
(
Ci
.
nsIPluginTag
.
STATE_CLICKTOPLAY
"
Test
Plug
-
in
"
)
;
let
popupNotification
=
PopupNotifications
.
getNotification
(
"
click
-
to
-
play
-
plugins
"
gTestBrowser
)
;
ok
(
!
popupNotification
"
Sanity
check
should
not
have
a
click
-
to
-
play
notification
"
)
;
await
promiseTabLoadEvent
(
gBrowser
.
selectedTab
gTestRoot
+
"
plugin_shouldShowOverlay
.
html
"
)
;
await
promiseUpdatePluginBindings
(
gTestBrowser
)
;
await
ContentTask
.
spawn
(
gTestBrowser
null
async
function
(
)
{
let
doc
=
content
.
document
;
let
testcases
=
doc
.
querySelectorAll
(
"
.
testcase
"
)
;
for
(
let
testcase
of
testcases
)
{
let
plugin
=
testcase
.
querySelector
(
"
object
"
)
;
Assert
.
ok
(
plugin
plugin
exists
in
{
testcase
.
id
}
)
;
let
overlay
=
plugin
.
openOrClosedShadowRoot
.
getElementById
(
"
main
"
)
;
Assert
.
ok
(
overlay
overlay
exists
in
{
testcase
.
id
}
)
;
let
expectedVisibility
=
testcase
.
getAttribute
(
"
shouldshow
"
)
=
=
"
true
"
;
Assert
.
ok
(
(
overlay
.
getAttribute
(
"
sizing
"
)
!
=
"
blank
"
)
=
=
expectedVisibility
The
expected
visibility
is
correct
in
{
testcase
.
id
}
)
;
}
}
)
;
}
)
;
