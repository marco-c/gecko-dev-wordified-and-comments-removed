"
use
strict
"
;
const
{
SitePermissions
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
/
modules
/
SitePermissions
.
jsm
"
)
;
const
{
PermissionTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
PermissionTestUtils
.
jsm
"
)
;
const
baseURL
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
http
:
/
/
example
.
com
"
)
;
const
URL
=
baseURL
+
"
popup_blocker2
.
html
"
;
const
URI
=
Services
.
io
.
newURI
(
URL
)
;
const
PRINCIPAL
=
Services
.
scriptSecurityManager
.
createContentPrincipal
(
URI
{
}
)
;
function
openPermissionPopup
(
)
{
let
promise
=
BrowserTestUtils
.
waitForEvent
(
window
"
popupshown
"
true
event
=
>
event
.
target
=
=
gPermissionPanel
.
_permissionPopup
)
;
gPermissionPanel
.
_identityPermissionBox
.
click
(
)
;
return
promise
;
}
function
closePermissionPopup
(
)
{
let
promise
=
BrowserTestUtils
.
waitForEvent
(
gPermissionPanel
.
_permissionPopup
"
popuphidden
"
)
;
gPermissionPanel
.
_permissionPopup
.
hidePopup
(
)
;
return
promise
;
}
add_task
(
async
function
enable_popup_blocker
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
disable_open_during_load
"
true
]
]
}
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
disable_open_click_delay
"
0
]
]
}
)
;
}
)
;
add_task
(
async
function
check_blocked_popup_indicator
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
URL
)
;
await
openPermissionPopup
(
)
;
Assert
.
equal
(
document
.
getElementById
(
"
blocked
-
popup
-
indicator
-
item
"
)
null
)
;
await
closePermissionPopup
(
)
;
let
icon
=
gPermissionPanel
.
_identityPermissionBox
.
querySelector
(
"
.
blocked
-
permission
-
icon
[
data
-
permission
-
id
=
'
popup
'
]
"
)
;
Assert
.
equal
(
icon
.
hasAttribute
(
"
showing
"
)
false
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
async
(
)
=
>
{
let
open
=
content
.
document
.
getElementById
(
"
pop
"
)
;
open
.
click
(
)
;
}
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
gBrowser
.
getNotificationBox
(
)
.
getNotificationWithValue
(
"
popup
-
blocked
"
)
)
;
document
.
getElementById
(
"
identity
-
permission
-
box
"
)
.
click
(
)
;
await
openPermissionPopup
(
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
document
.
getElementById
(
"
blocked
-
popup
-
indicator
-
item
"
)
!
=
=
null
)
;
let
menulist
=
document
.
getElementById
(
"
permission
-
popup
-
menulist
"
)
;
Assert
.
equal
(
menulist
.
value
"
0
"
)
;
Assert
.
equal
(
menulist
.
label
"
Block
"
)
;
await
closePermissionPopup
(
)
;
Assert
.
equal
(
icon
.
getAttribute
(
"
showing
"
)
"
true
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
check_popup_showing
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
URL
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
async
(
)
=
>
{
let
open
=
content
.
document
.
getElementById
(
"
pop
"
)
;
open
.
click
(
)
;
}
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
gBrowser
.
getNotificationBox
(
)
.
getNotificationWithValue
(
"
popup
-
blocked
"
)
)
;
let
popup
;
function
onTabOpen
(
event
)
{
popup
=
event
.
target
;
}
gBrowser
.
tabContainer
.
addEventListener
(
"
TabOpen
"
onTabOpen
)
;
await
openPermissionPopup
(
)
;
let
e
=
document
.
getElementById
(
"
blocked
-
popup
-
indicator
-
item
"
)
;
let
text
=
e
.
getElementsByTagName
(
"
label
"
)
[
0
]
;
text
.
click
(
)
;
await
BrowserTestUtils
.
waitForEvent
(
gBrowser
.
tabContainer
"
TabOpen
"
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
popup
.
linkedBrowser
.
currentURI
.
spec
!
=
"
about
:
blank
"
)
;
gBrowser
.
tabContainer
.
removeEventListener
(
"
TabOpen
"
onTabOpen
)
;
ok
(
popup
.
linkedBrowser
.
currentURI
.
spec
.
endsWith
(
"
popup_blocker_a
.
html
"
)
"
Popup
a
"
)
;
gBrowser
.
removeTab
(
popup
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
check_permission_state_change
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
URL
)
;
let
state
=
SitePermissions
.
getForPrincipal
(
PRINCIPAL
"
popup
"
gBrowser
)
.
state
;
Assert
.
equal
(
state
SitePermissions
.
BLOCK
)
;
await
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
async
(
)
=
>
{
let
open
=
content
.
document
.
getElementById
(
"
pop
"
)
;
open
.
click
(
)
;
}
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
gBrowser
.
getNotificationBox
(
)
.
getNotificationWithValue
(
"
popup
-
blocked
"
)
)
;
await
openPermissionPopup
(
)
;
let
menulist
=
document
.
getElementById
(
"
permission
-
popup
-
menulist
"
)
;
menulist
.
menupopup
.
openPopup
(
)
;
let
menuitem
=
menulist
.
getElementsByTagName
(
"
menuitem
"
)
[
0
]
;
menuitem
.
click
(
)
;
await
closePermissionPopup
(
)
;
state
=
SitePermissions
.
getForPrincipal
(
PRINCIPAL
"
popup
"
gBrowser
)
.
state
;
Assert
.
equal
(
state
SitePermissions
.
ALLOW
)
;
let
popup
;
function
onTabOpen
(
event
)
{
popup
=
event
.
target
;
}
gBrowser
.
tabContainer
.
addEventListener
(
"
TabOpen
"
onTabOpen
)
;
await
Promise
.
all
(
[
SpecialPowers
.
spawn
(
gBrowser
.
selectedBrowser
[
]
(
)
=
>
{
let
open
=
content
.
document
.
getElementById
(
"
pop
"
)
;
open
.
click
(
)
;
}
)
BrowserTestUtils
.
waitForEvent
(
gBrowser
.
tabContainer
"
TabOpen
"
)
]
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
popup
.
linkedBrowser
.
currentURI
.
spec
!
=
"
about
:
blank
"
)
;
gBrowser
.
tabContainer
.
removeEventListener
(
"
TabOpen
"
onTabOpen
)
;
ok
(
popup
.
linkedBrowser
.
currentURI
.
spec
.
endsWith
(
"
popup_blocker_a
.
html
"
)
"
Popup
a
"
)
;
gBrowser
.
removeTab
(
popup
)
;
await
openPermissionPopup
(
)
;
menulist
=
document
.
getElementById
(
"
permission
-
popup
-
menulist
"
)
;
menulist
.
menupopup
.
openPopup
(
)
;
menuitem
=
menulist
.
getElementsByTagName
(
"
menuitem
"
)
[
1
]
;
menuitem
.
click
(
)
;
await
closePermissionPopup
(
)
;
state
=
SitePermissions
.
getForPrincipal
(
PRINCIPAL
"
popup
"
gBrowser
)
.
state
;
Assert
.
equal
(
state
SitePermissions
.
BLOCK
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
check_explicit_default_permission
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
URL
)
;
PermissionTestUtils
.
add
(
URI
"
popup
"
Ci
.
nsIPermissionManager
.
DENY_ACTION
)
;
await
openPermissionPopup
(
)
;
let
menulist
=
document
.
getElementById
(
"
permission
-
popup
-
menulist
"
)
;
Assert
.
equal
(
menulist
.
value
"
0
"
)
;
Assert
.
equal
(
menulist
.
label
"
Block
"
)
;
await
closePermissionPopup
(
)
;
PermissionTestUtils
.
add
(
URI
"
popup
"
Services
.
perms
.
ALLOW_ACTION
)
;
await
openPermissionPopup
(
)
;
menulist
=
document
.
getElementById
(
"
permission
-
popup
-
menulist
"
)
;
Assert
.
equal
(
menulist
.
value
"
1
"
)
;
Assert
.
equal
(
menulist
.
label
"
Allow
"
)
;
await
closePermissionPopup
(
)
;
PermissionTestUtils
.
remove
(
URI
"
popup
"
)
;
gBrowser
.
removeTab
(
tab
)
;
}
)
;
