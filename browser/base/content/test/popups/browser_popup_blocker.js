const
baseURL
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
http
:
/
/
example
.
com
"
)
;
function
clearAllPermissionsByPrefix
(
aPrefix
)
{
let
perms
=
Services
.
perms
.
enumerator
;
while
(
perms
.
hasMoreElements
(
)
)
{
let
perm
=
perms
.
getNext
(
)
;
if
(
perm
.
type
.
startsWith
(
aPrefix
)
)
{
Services
.
perms
.
removePermission
(
perm
)
;
}
}
}
add_task
(
async
function
test_opening_blocked_popups
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
disable_open_during_load
"
true
]
]
}
)
;
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
baseURL
+
"
popup_blocker
.
html
"
)
;
let
notification
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
notification
=
gBrowser
.
getNotificationBox
(
)
.
getNotificationWithValue
(
"
popup
-
blocked
"
)
)
;
let
popupShown
=
BrowserTestUtils
.
waitForEvent
(
window
"
popupshown
"
)
;
let
popupFilled
=
BrowserTestUtils
.
waitForMessage
(
gBrowser
.
selectedBrowser
.
messageManager
"
PopupBlocking
:
ReplyGetBlockedPopupList
"
)
;
notification
.
querySelector
(
"
button
"
)
.
doCommand
(
)
;
let
popup_event
=
await
popupShown
;
let
menu
=
popup_event
.
target
;
is
(
menu
.
id
"
blockedPopupOptions
"
"
Blocked
popup
menu
shown
"
)
;
await
popupFilled
;
await
new
Promise
(
resolve
=
>
executeSoon
(
resolve
)
)
;
let
sep
=
menu
.
querySelector
(
"
menuseparator
"
)
;
let
popupCount
=
0
;
for
(
let
i
=
sep
.
nextElementSibling
;
i
;
i
=
i
.
nextElementSibling
)
{
popupCount
+
+
;
}
is
(
popupCount
2
"
Two
popups
were
blocked
"
)
;
let
popupTabs
=
[
]
;
function
onTabOpen
(
event
)
{
popupTabs
.
push
(
event
.
target
)
;
}
gBrowser
.
tabContainer
.
addEventListener
(
"
TabOpen
"
onTabOpen
)
;
let
allow
=
menu
.
querySelector
(
"
[
observes
=
'
blockedPopupAllowSite
'
]
"
)
;
allow
.
doCommand
(
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
popupTabs
.
length
=
=
2
&
&
popupTabs
.
every
(
aTab
=
>
aTab
.
linkedBrowser
.
currentURI
.
spec
!
=
"
about
:
blank
"
)
)
;
gBrowser
.
tabContainer
.
removeEventListener
(
"
TabOpen
"
onTabOpen
)
;
ok
(
popupTabs
[
0
]
.
linkedBrowser
.
currentURI
.
spec
.
endsWith
(
"
popup_blocker_a
.
html
"
)
"
Popup
a
"
)
;
ok
(
popupTabs
[
1
]
.
linkedBrowser
.
currentURI
.
spec
.
endsWith
(
"
popup_blocker_b
.
html
"
)
"
Popup
b
"
)
;
gBrowser
.
removeTab
(
tab
)
;
for
(
let
popup
of
popupTabs
)
{
gBrowser
.
removeTab
(
popup
)
;
}
clearAllPermissionsByPrefix
(
"
popup
"
)
;
menu
.
hidePopup
(
)
;
}
)
;
