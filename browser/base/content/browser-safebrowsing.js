var
gSafeBrowsing
=
{
setReportPhishingMenu
(
)
{
var
docURI
=
gBrowser
.
selectedBrowser
.
documentURI
;
var
isPhishingPage
=
docURI
&
&
docURI
.
spec
.
startsWith
(
"
about
:
blocked
?
e
=
deceptiveBlocked
"
)
;
const
reportMenu
=
document
.
getElementById
(
"
menu_HelpPopup_reportPhishingtoolmenu
"
)
;
reportMenu
.
hidden
=
isPhishingPage
;
const
reportErrorMenu
=
document
.
getElementById
(
"
menu_HelpPopup_reportPhishingErrortoolmenu
"
)
;
reportErrorMenu
.
hidden
=
!
isPhishingPage
;
const
uri
=
gBrowser
.
currentURI
;
const
isReportablePage
=
uri
&
&
(
uri
.
schemeIs
(
"
http
"
)
|
|
uri
.
schemeIs
(
"
https
"
)
)
;
const
disabledByPolicy
=
!
Services
.
policies
.
isAllowed
(
"
feedbackCommands
"
)
;
if
(
disabledByPolicy
|
|
isPhishingPage
|
|
!
isReportablePage
)
{
reportMenu
.
setAttribute
(
"
disabled
"
"
true
"
)
;
}
else
{
reportMenu
.
removeAttribute
(
"
disabled
"
)
;
}
if
(
disabledByPolicy
|
|
!
isPhishingPage
|
|
!
isReportablePage
)
{
reportErrorMenu
.
setAttribute
(
"
disabled
"
"
true
"
)
;
}
else
{
reportErrorMenu
.
removeAttribute
(
"
disabled
"
)
;
}
}
getReportURL
(
name
info
)
{
let
reportInfo
=
info
;
if
(
!
reportInfo
)
{
let
pageUri
=
gBrowser
.
currentURI
;
if
(
pageUri
instanceof
Ci
.
nsIURL
)
{
pageUri
=
pageUri
.
mutate
(
)
.
setQuery
(
"
"
)
.
finalize
(
)
;
}
reportInfo
=
{
uri
:
pageUri
.
asciiSpec
}
;
}
return
SafeBrowsing
.
getReportURL
(
name
reportInfo
)
;
}
reportFalseDeceptiveSite
(
)
{
let
contextsToVisit
=
[
gBrowser
.
selectedBrowser
.
browsingContext
]
;
while
(
contextsToVisit
.
length
)
{
let
currentContext
=
contextsToVisit
.
pop
(
)
;
let
global
=
currentContext
.
currentWindowGlobal
;
if
(
!
global
)
{
continue
;
}
let
docURI
=
global
.
documentURI
;
if
(
docURI
&
&
docURI
.
spec
.
startsWith
(
"
about
:
blocked
?
e
=
deceptiveBlocked
"
)
)
{
let
actor
=
global
.
getActor
(
"
BlockedSite
"
)
;
actor
.
sendQuery
(
"
DeceptiveBlockedDetails
"
)
.
then
(
data
=
>
{
let
reportUrl
=
gSafeBrowsing
.
getReportURL
(
"
PhishMistake
"
data
.
blockedInfo
)
;
if
(
reportUrl
)
{
openTrustedLinkIn
(
reportUrl
"
tab
"
)
;
}
else
{
let
bundle
=
Services
.
strings
.
createBundle
(
"
chrome
:
/
/
browser
/
locale
/
safebrowsing
/
safebrowsing
.
properties
"
)
;
Services
.
prompt
.
alert
(
window
bundle
.
GetStringFromName
(
"
errorReportFalseDeceptiveTitle
"
)
bundle
.
formatStringFromName
(
"
errorReportFalseDeceptiveMessage
"
[
data
.
blockedInfo
.
provider
]
)
)
;
}
}
)
;
}
contextsToVisit
.
push
(
.
.
.
currentContext
.
children
)
;
}
}
}
;
