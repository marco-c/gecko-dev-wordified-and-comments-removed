var
AboutTabCrashed
=
{
hasReport
:
false
MESSAGES
:
[
"
SetCrashReportAvailable
"
"
CrashReportSent
"
"
UpdateCount
"
]
CLICK_TARGETS
:
[
"
closeTab
"
"
restoreTab
"
"
restoreAll
"
"
sendReport
"
]
get
pageData
(
)
{
delete
this
.
pageData
;
let
URL
=
document
.
documentURI
;
let
queryString
=
URL
.
replace
(
/
^
about
:
tabcrashed
?
e
=
tabcrashed
/
"
"
)
;
let
titleMatch
=
queryString
.
match
(
/
d
=
(
[
^
&
]
*
)
/
)
;
let
URLMatch
=
queryString
.
match
(
/
u
=
(
[
^
&
]
*
)
/
)
;
return
this
.
pageData
=
{
title
:
titleMatch
&
&
titleMatch
[
1
]
?
decodeURIComponent
(
titleMatch
[
1
]
)
:
"
"
URL
:
URLMatch
&
&
URLMatch
[
1
]
?
decodeURIComponent
(
URLMatch
[
1
]
)
:
"
"
}
;
}
init
(
)
{
this
.
MESSAGES
.
forEach
(
(
msg
)
=
>
addMessageListener
(
msg
this
.
receiveMessage
.
bind
(
this
)
)
)
;
addEventListener
(
"
DOMContentLoaded
"
this
)
;
document
.
title
=
this
.
pageData
.
title
;
}
receiveMessage
(
message
)
{
switch
(
message
.
name
)
{
case
"
UpdateCount
"
:
{
this
.
showRestoreAll
(
message
.
data
.
count
>
1
)
;
break
;
}
case
"
SetCrashReportAvailable
"
:
{
this
.
onSetCrashReportAvailable
(
message
)
;
break
;
}
case
"
CrashReportSent
"
:
{
this
.
onCrashReportSent
(
)
;
break
;
}
}
}
handleEvent
(
event
)
{
switch
(
event
.
type
)
{
case
"
DOMContentLoaded
"
:
{
this
.
onDOMContentLoaded
(
)
;
break
;
}
case
"
click
"
:
{
this
.
onClick
(
event
)
;
break
;
}
}
}
onDOMContentLoaded
(
)
{
this
.
CLICK_TARGETS
.
forEach
(
(
targetID
)
=
>
{
let
el
=
document
.
getElementById
(
targetID
)
;
el
.
addEventListener
(
"
click
"
this
)
;
}
)
;
let
event
=
new
CustomEvent
(
"
AboutTabCrashedLoad
"
{
bubbles
:
true
}
)
;
document
.
dispatchEvent
(
event
)
;
sendAsyncMessage
(
"
Load
"
)
;
}
onClick
(
event
)
{
switch
(
event
.
target
.
id
)
{
case
"
closeTab
"
:
{
this
.
sendMessage
(
"
closeTab
"
)
;
break
;
}
case
"
restoreTab
"
:
{
this
.
sendMessage
(
"
restoreTab
"
)
;
break
;
}
case
"
restoreAll
"
:
{
this
.
sendMessage
(
"
restoreAll
"
)
;
break
;
}
case
"
sendReport
"
:
{
this
.
showCrashReportUI
(
event
.
target
.
checked
)
;
break
;
}
}
}
onSetCrashReportAvailable
(
message
)
{
if
(
message
.
data
.
hasReport
)
{
this
.
hasReport
=
true
;
document
.
documentElement
.
classList
.
add
(
"
crashDumpAvailable
"
)
;
let
data
=
message
.
data
;
document
.
getElementById
(
"
sendReport
"
)
.
checked
=
data
.
sendReport
;
document
.
getElementById
(
"
includeURL
"
)
.
checked
=
data
.
includeURL
;
document
.
getElementById
(
"
emailMe
"
)
.
checked
=
data
.
emailMe
;
if
(
data
.
emailMe
)
{
document
.
getElementById
(
"
email
"
)
.
value
=
data
.
email
;
}
this
.
showCrashReportUI
(
data
.
sendReport
)
;
}
let
event
=
new
CustomEvent
(
"
AboutTabCrashedReady
"
{
bubbles
:
true
}
)
;
document
.
dispatchEvent
(
event
)
;
}
onCrashReportSent
(
)
{
document
.
documentElement
.
classList
.
remove
(
"
crashDumpAvailable
"
)
;
document
.
documentElement
.
classList
.
add
(
"
crashDumpSubmitted
"
)
;
}
showCrashReportUI
(
shouldShow
)
{
let
container
=
document
.
getElementById
(
"
crash
-
reporter
-
container
"
)
;
container
.
hidden
=
!
shouldShow
;
}
showRestoreAll
(
shouldShow
)
{
let
restoreAll
=
document
.
getElementById
(
"
restoreAll
"
)
;
let
restoreTab
=
document
.
getElementById
(
"
restoreTab
"
)
;
if
(
shouldShow
)
{
restoreAll
.
removeAttribute
(
"
hidden
"
)
;
restoreTab
.
classList
.
remove
(
"
primary
"
)
;
}
else
{
restoreAll
.
setAttribute
(
"
hidden
"
true
)
;
restoreTab
.
classList
.
add
(
"
primary
"
)
;
}
}
sendMessage
(
messageName
)
{
let
comments
=
"
"
;
let
email
=
"
"
;
let
URL
=
"
"
;
let
sendReport
=
false
;
let
emailMe
=
false
;
let
includeURL
=
false
;
if
(
this
.
hasReport
)
{
sendReport
=
document
.
getElementById
(
"
sendReport
"
)
.
checked
;
if
(
sendReport
)
{
comments
=
document
.
getElementById
(
"
comments
"
)
.
value
.
trim
(
)
;
includeURL
=
document
.
getElementById
(
"
includeURL
"
)
.
checked
;
if
(
includeURL
)
{
URL
=
this
.
pageData
.
URL
.
trim
(
)
;
}
emailMe
=
document
.
getElementById
(
"
emailMe
"
)
.
checked
;
if
(
emailMe
)
{
email
=
document
.
getElementById
(
"
email
"
)
.
value
.
trim
(
)
;
}
}
}
sendAsyncMessage
(
messageName
{
sendReport
comments
email
emailMe
includeURL
URL
}
)
;
}
}
;
AboutTabCrashed
.
init
(
)
;
