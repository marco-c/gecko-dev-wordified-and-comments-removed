const
{
AddonManager
AppConstants
document
:
gDoc
getShellService
Services
}
=
window
.
docShell
.
chromeEventHandler
.
ownerGlobal
;
const
COMPACT_MODE_HEIGHT
=
679
;
const
SHELL
=
getShellService
(
)
;
const
IS_DEFAULT
=
SHELL
.
isDefaultBrowser
(
)
;
const
NEED_PIN
=
SHELL
.
doesAppNeedPin
(
)
;
const
PIN_OR_THEME_STRING
=
NEED_PIN
.
then
(
pin
=
>
pin
?
"
upgrade
-
dialog
-
new
-
primary
-
pin
-
button
"
:
"
upgrade
-
dialog
-
new
-
primary
-
theme
-
button
"
)
;
const
PRIMARY_OR_DEFAULT_STRING
=
NEED_PIN
.
then
(
pin
=
>
pin
?
"
upgrade
-
dialog
-
new
-
primary
-
primary
-
button
"
:
"
upgrade
-
dialog
-
new
-
primary
-
default
-
button
"
)
;
const
SCREEN_STRINGS
=
[
{
title
:
"
upgrade
-
dialog
-
new
-
title
"
primary
:
IS_DEFAULT
?
PIN_OR_THEME_STRING
:
PRIMARY_OR_DEFAULT_STRING
secondary
:
"
upgrade
-
dialog
-
new
-
secondary
-
button
"
}
{
title
:
"
upgrade
-
dialog
-
theme
-
title
"
primary
:
"
upgrade
-
dialog
-
theme
-
primary
-
button
"
secondary
:
"
upgrade
-
dialog
-
theme
-
secondary
-
button
"
}
]
;
const
THEME_IDS
=
[
"
default
-
theme
mozilla
.
org
"
"
firefox
-
compact
-
light
mozilla
.
org
"
"
firefox
-
compact
-
dark
mozilla
.
org
"
"
firefox
-
alpenglow
mozilla
.
org
"
]
;
const
CLEANUP
=
[
]
;
addEventListener
(
"
pagehide
"
(
)
=
>
CLEANUP
.
forEach
(
f
=
>
f
(
)
)
{
once
:
true
}
)
;
let
gPrevTheme
=
AddonManager
.
getAddonsByTypes
(
[
"
theme
"
]
)
.
then
(
addons
=
>
{
for
(
const
{
id
isActive
screenshots
}
of
addons
)
{
if
(
isActive
)
{
if
(
!
THEME_IDS
.
includes
(
id
)
)
{
THEME_IDS
.
push
(
id
)
;
}
CLEANUP
.
push
(
(
)
=
>
gPrevTheme
&
&
enableTheme
(
id
)
)
;
return
{
id
swatch
:
screenshots
?
.
[
0
]
.
url
}
;
}
}
return
{
id
:
THEME_IDS
[
0
]
}
;
}
)
;
async
function
enableTheme
(
id
)
{
(
await
AddonManager
.
getAddonByID
(
id
)
)
.
enable
(
)
;
}
function
adjustModalBackdrop
(
)
{
const
{
classList
}
=
gDoc
.
getElementById
(
"
window
-
modal
-
dialog
"
)
;
classList
.
add
(
"
showToolbar
"
)
;
CLEANUP
.
push
(
(
)
=
>
classList
.
remove
(
"
showToolbar
"
)
)
;
}
function
recordEvent
(
obj
val
)
{
Services
.
telemetry
.
recordEvent
(
"
upgrade_dialog
"
"
content
"
obj
{
val
}
)
;
}
let
gCloseReason
=
"
external
"
;
CLEANUP
.
push
(
(
)
=
>
recordEvent
(
"
close
"
gCloseReason
)
)
;
function
closeDialog
(
reason
)
{
gCloseReason
=
reason
;
close
(
)
;
}
const
QUIT_TOPIC
=
"
quit
-
application
-
requested
"
;
const
QUIT_OBSERVER
=
(
)
=
>
closeDialog
(
QUIT_TOPIC
)
;
Services
.
obs
.
addObserver
(
QUIT_OBSERVER
QUIT_TOPIC
)
;
CLEANUP
.
push
(
(
)
=
>
Services
.
obs
.
removeObserver
(
QUIT_OBSERVER
QUIT_TOPIC
)
)
;
function
onLoad
(
ready
)
{
const
win7Content
=
AppConstants
.
isPlatformAndVersionAtMost
(
"
win
"
"
6
.
1
"
)
;
const
{
body
head
}
=
document
;
const
title
=
document
.
getElementById
(
"
title
"
)
;
const
subtitle
=
document
.
getElementById
(
"
subtitle
"
)
;
const
items
=
document
.
querySelector
(
"
.
items
"
)
;
const
themes
=
document
.
querySelector
(
"
.
themes
"
)
;
const
primary
=
document
.
getElementById
(
"
primary
"
)
;
const
secondary
=
document
.
getElementById
(
"
secondary
"
)
;
const
steps
=
document
.
querySelector
(
"
.
steps
"
)
;
let
current
=
-
1
;
(
async
function
advance
(
{
target
}
=
{
}
)
{
if
(
target
)
{
recordEvent
(
"
button
"
target
.
dataset
.
l10nId
)
;
}
switch
(
+
+
current
)
{
case
0
:
primary
.
addEventListener
(
"
click
"
advance
)
;
secondary
.
addEventListener
(
"
click
"
advance
)
;
if
(
gDoc
.
ownerGlobal
.
outerHeight
<
COMPACT_MODE_HEIGHT
)
{
body
.
classList
.
add
(
"
compact
"
)
;
recordEvent
(
"
show
"
"
compact
"
)
;
}
if
(
win7Content
)
{
steps
.
style
.
visibility
=
"
hidden
"
;
if
(
IS_DEFAULT
)
{
head
.
appendChild
(
head
.
querySelector
(
"
[
rel
=
localization
]
"
)
.
cloneNode
(
)
)
.
href
=
"
browser
/
newtab
/
asrouter
.
ftl
"
;
SCREEN_STRINGS
[
current
]
.
primary
=
"
cfr
-
doorhanger
-
doh
-
primary
-
button
-
2
"
;
secondary
.
style
.
display
=
"
none
"
;
}
}
break
;
case
1
:
if
(
target
=
=
=
primary
)
{
if
(
!
IS_DEFAULT
)
{
SHELL
.
setAsDefault
(
)
;
}
SHELL
.
pinToTaskbar
(
)
;
}
else
if
(
target
=
=
=
secondary
&
&
IS_DEFAULT
&
&
!
(
await
NEED_PIN
)
)
{
closeDialog
(
"
early
"
)
;
return
;
}
if
(
win7Content
)
{
closeDialog
(
"
win7
"
)
;
return
;
}
const
{
id
swatch
}
=
await
gPrevTheme
;
themes
.
children
[
THEME_IDS
.
indexOf
(
id
)
]
.
checked
=
true
;
themes
.
addEventListener
(
"
click
"
(
{
target
:
button
}
)
=
>
{
if
(
button
.
parentNode
=
=
=
themes
)
{
const
index
=
[
.
.
.
themes
.
children
]
.
indexOf
(
button
)
;
enableTheme
(
THEME_IDS
[
index
]
)
;
recordEvent
(
"
theme
"
index
)
;
}
}
)
;
if
(
themes
.
childElementCount
>
THEME_IDS
.
length
)
{
themes
.
removeChild
(
themes
.
lastElementChild
)
;
}
else
if
(
swatch
)
{
themes
.
lastElementChild
.
style
.
setProperty
(
"
-
-
theme
-
swatch
"
url
(
"
{
swatch
}
"
)
)
;
}
[
.
.
.
themes
.
children
]
.
forEach
(
input
=
>
{
new
Image
(
)
.
src
=
getComputedStyle
(
input
"
:
:
before
"
)
.
backgroundImage
.
match
(
/
resource
:
[
^
"
]
+
/
)
?
.
[
0
]
;
}
)
;
subtitle
.
remove
(
)
;
items
.
remove
(
)
;
themes
.
classList
.
remove
(
"
hidden
"
)
;
steps
.
appendChild
(
steps
.
firstChild
)
;
adjustModalBackdrop
(
)
;
break
;
case
2
:
if
(
target
=
=
=
primary
)
{
gPrevTheme
=
null
;
}
closeDialog
(
"
complete
"
)
;
return
;
}
const
strings
=
SCREEN_STRINGS
[
current
]
;
document
.
l10n
.
setAttributes
(
title
strings
.
title
)
;
document
.
l10n
.
setAttributes
(
primary
await
strings
.
primary
)
;
document
.
l10n
.
setAttributes
(
secondary
strings
.
secondary
)
;
await
document
.
l10n
.
ready
;
requestAnimationFrame
(
(
)
=
>
{
primary
.
focus
(
)
;
if
(
current
=
=
=
0
)
{
body
.
style
.
minHeight
=
getComputedStyle
(
body
)
.
height
;
recordEvent
(
"
show
"
primary
.
dataset
.
l10nId
)
;
ready
(
)
;
}
dispatchEvent
(
new
CustomEvent
(
"
ready
"
)
)
;
}
)
;
recordEvent
(
"
show
"
current
)
;
}
)
(
)
;
}
document
.
mozSubdialogReady
=
new
Promise
(
resolve
=
>
document
.
addEventListener
(
"
DOMContentLoaded
"
(
)
=
>
onLoad
(
resolve
)
{
once
:
true
}
)
)
;
