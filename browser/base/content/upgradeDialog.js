const
{
AddonManager
AppConstants
document
:
gDoc
getShellService
Services
}
=
window
.
docShell
.
chromeEventHandler
.
ownerGlobal
;
const
COMPACT_MODE_HEIGHT
=
649
;
const
SHELL
=
getShellService
(
)
;
const
IS_DEFAULT
=
SHELL
.
isDefaultBrowser
(
)
;
const
NEED_PIN
=
SHELL
.
doesAppNeedPin
(
)
;
const
SCREEN_STRINGS
=
[
NEED_PIN
.
then
(
pin
=
>
pin
?
{
title
:
"
upgrade
-
dialog
-
pin
-
title
"
subtitle
:
"
upgrade
-
dialog
-
pin
-
subtitle
"
primary
:
"
upgrade
-
dialog
-
pin
-
primary
-
button
"
secondary
:
"
upgrade
-
dialog
-
pin
-
secondary
-
button
"
}
:
{
title
:
"
upgrade
-
dialog
-
new
-
title
"
subtitle
:
"
upgrade
-
dialog
-
new
-
subtitle
"
primary
:
IS_DEFAULT
?
"
upgrade
-
dialog
-
new
-
primary
-
theme
-
button
"
:
"
upgrade
-
dialog
-
new
-
primary
-
default
-
button
"
secondary
:
"
upgrade
-
dialog
-
new
-
secondary
-
button
"
}
)
{
title
:
"
upgrade
-
dialog
-
default
-
title
-
2
"
subtitle
:
"
upgrade
-
dialog
-
default
-
subtitle
-
2
"
primary
:
"
upgrade
-
dialog
-
default
-
primary
-
button
-
2
"
secondary
:
"
upgrade
-
dialog
-
default
-
secondary
-
button
"
}
{
title
:
"
upgrade
-
dialog
-
theme
-
title
-
2
"
primary
:
"
upgrade
-
dialog
-
theme
-
primary
-
button
"
secondary
:
"
upgrade
-
dialog
-
theme
-
secondary
-
button
"
}
]
;
const
THEME_IDS
=
[
"
default
-
theme
mozilla
.
org
"
"
firefox
-
compact
-
light
mozilla
.
org
"
"
firefox
-
compact
-
dark
mozilla
.
org
"
"
firefox
-
alpenglow
mozilla
.
org
"
]
;
const
CLEANUP
=
[
]
;
addEventListener
(
"
pagehide
"
(
)
=
>
CLEANUP
.
forEach
(
f
=
>
f
(
)
)
{
once
:
true
}
)
;
let
gPrevTheme
=
AddonManager
.
getAddonsByTypes
(
[
"
theme
"
]
)
.
then
(
addons
=
>
{
for
(
const
{
id
isActive
screenshots
}
of
addons
)
{
if
(
isActive
)
{
if
(
!
THEME_IDS
.
includes
(
id
)
)
{
THEME_IDS
.
push
(
id
)
;
}
CLEANUP
.
push
(
(
)
=
>
gPrevTheme
&
&
enableTheme
(
id
)
)
;
return
{
id
swatch
:
screenshots
?
.
[
0
]
.
url
}
;
}
}
return
{
id
:
THEME_IDS
[
0
]
}
;
}
)
;
async
function
enableTheme
(
id
)
{
(
await
AddonManager
.
getAddonByID
(
id
)
)
.
enable
(
)
;
}
function
adjustModalBackdrop
(
)
{
const
{
classList
}
=
gDoc
.
getElementById
(
"
window
-
modal
-
dialog
"
)
;
classList
.
add
(
"
showToolbar
"
)
;
CLEANUP
.
push
(
(
)
=
>
classList
.
remove
(
"
showToolbar
"
)
)
;
}
function
recordEvent
(
obj
val
)
{
Services
.
telemetry
.
recordEvent
(
"
upgrade_dialog
"
"
content
"
obj
{
val
}
)
;
}
let
gCloseReason
=
"
external
"
;
CLEANUP
.
push
(
(
)
=
>
recordEvent
(
"
close
"
gCloseReason
)
)
;
function
closeDialog
(
reason
)
{
gCloseReason
=
reason
;
close
(
)
;
}
const
QUIT_TOPIC
=
"
quit
-
application
-
requested
"
;
const
QUIT_OBSERVER
=
(
)
=
>
closeDialog
(
QUIT_TOPIC
)
;
Services
.
obs
.
addObserver
(
QUIT_OBSERVER
QUIT_TOPIC
)
;
CLEANUP
.
push
(
(
)
=
>
Services
.
obs
.
removeObserver
(
QUIT_OBSERVER
QUIT_TOPIC
)
)
;
function
onLoad
(
ready
)
{
const
win7Content
=
AppConstants
.
isPlatformAndVersionAtMost
(
"
win
"
"
6
.
1
"
)
;
const
{
body
}
=
document
;
const
title
=
document
.
getElementById
(
"
title
"
)
;
const
subtitle
=
document
.
getElementById
(
"
subtitle
"
)
;
const
items
=
document
.
querySelector
(
"
.
items
"
)
;
const
themes
=
document
.
querySelector
(
"
.
themes
"
)
;
const
primary
=
document
.
getElementById
(
"
primary
"
)
;
const
secondary
=
document
.
getElementById
(
"
secondary
"
)
;
const
steps
=
document
.
querySelector
(
"
.
steps
"
)
;
let
current
=
-
1
;
(
async
function
advance
(
{
target
}
=
{
}
)
{
if
(
target
)
{
recordEvent
(
"
button
"
target
.
dataset
.
l10nId
)
;
}
const
strings
=
await
SCREEN_STRINGS
[
+
+
current
]
;
let
toFocus
=
primary
;
switch
(
current
)
{
case
0
:
primary
.
addEventListener
(
"
click
"
advance
)
;
secondary
.
addEventListener
(
"
click
"
advance
)
;
if
(
gDoc
.
ownerGlobal
.
outerHeight
<
COMPACT_MODE_HEIGHT
)
{
body
.
classList
.
add
(
"
compact
"
)
;
recordEvent
(
"
show
"
"
compact
"
)
;
}
if
(
win7Content
)
{
steps
.
style
.
visibility
=
"
hidden
"
;
if
(
IS_DEFAULT
)
{
strings
.
primary
=
"
upgrade
-
dialog
-
new
-
primary
-
win7
-
button
"
;
secondary
.
style
.
display
=
"
none
"
;
}
}
let
removeDefaultScreen
=
true
;
if
(
await
NEED_PIN
)
{
items
.
remove
(
)
;
removeDefaultScreen
=
IS_DEFAULT
;
}
if
(
removeDefaultScreen
)
{
SCREEN_STRINGS
.
splice
(
1
1
)
;
}
recordEvent
(
"
show
"
{
SCREEN_STRINGS
.
length
}
-
screens
)
;
for
(
let
i
=
SCREEN_STRINGS
.
length
;
i
>
1
;
i
-
-
)
{
steps
.
append
(
steps
.
lastChild
.
cloneNode
(
true
)
)
;
}
steps
.
lastChild
.
classList
.
add
(
"
current
"
)
;
break
;
default
:
const
{
l10nId
}
=
primary
.
dataset
;
if
(
target
=
=
=
primary
)
{
switch
(
l10nId
)
{
case
"
upgrade
-
dialog
-
new
-
primary
-
default
-
button
"
:
case
"
upgrade
-
dialog
-
default
-
primary
-
button
-
2
"
:
SHELL
.
setAsDefault
(
)
;
break
;
case
"
upgrade
-
dialog
-
pin
-
primary
-
button
"
:
SHELL
.
pinToTaskbar
(
)
;
break
;
}
}
else
if
(
target
=
=
=
secondary
&
&
l10nId
=
=
=
"
upgrade
-
dialog
-
new
-
primary
-
theme
-
button
"
)
{
closeDialog
(
"
early
"
)
;
return
;
}
if
(
win7Content
)
{
closeDialog
(
"
win7
"
)
;
return
;
}
if
(
current
!
=
=
SCREEN_STRINGS
.
length
-
1
)
{
break
;
}
const
{
id
swatch
}
=
await
gPrevTheme
;
toFocus
=
themes
.
children
[
THEME_IDS
.
indexOf
(
id
)
]
;
toFocus
.
checked
=
true
;
themes
.
addEventListener
(
"
click
"
(
{
target
:
button
}
)
=
>
{
if
(
button
.
parentNode
=
=
=
themes
)
{
const
index
=
[
.
.
.
themes
.
children
]
.
indexOf
(
button
)
;
enableTheme
(
THEME_IDS
[
index
]
)
;
recordEvent
(
"
theme
"
index
)
;
}
}
)
;
if
(
themes
.
childElementCount
>
THEME_IDS
.
length
)
{
themes
.
removeChild
(
themes
.
lastElementChild
)
;
}
else
if
(
swatch
)
{
themes
.
lastElementChild
.
style
.
setProperty
(
"
-
-
theme
-
swatch
"
url
(
"
{
swatch
}
"
)
)
;
}
[
.
.
.
themes
.
children
]
.
forEach
(
input
=
>
{
new
Image
(
)
.
src
=
getComputedStyle
(
input
"
:
:
before
"
)
.
backgroundImage
.
match
(
/
resource
:
[
^
"
]
+
/
)
?
.
[
0
]
;
}
)
;
subtitle
.
remove
(
)
;
items
.
remove
(
)
;
themes
.
classList
.
remove
(
"
hidden
"
)
;
adjustModalBackdrop
(
)
;
break
;
case
SCREEN_STRINGS
.
length
:
if
(
target
=
=
=
primary
)
{
gPrevTheme
=
null
;
}
closeDialog
(
"
complete
"
)
;
return
;
}
steps
.
prepend
(
steps
.
lastChild
)
;
await
document
.
l10n
.
ready
;
const
translatedElements
=
[
]
;
for
(
let
el
of
[
title
subtitle
primary
secondary
]
)
{
const
stringId
=
strings
[
el
.
id
]
;
if
(
stringId
)
{
document
.
l10n
.
setAttributes
(
el
stringId
)
;
translatedElements
.
push
(
el
)
;
}
}
await
document
.
l10n
.
translateElements
(
translatedElements
)
;
requestAnimationFrame
(
(
)
=
>
{
toFocus
.
focus
(
{
preventFocusRing
:
true
}
)
;
if
(
current
=
=
=
0
)
{
body
.
style
.
minHeight
=
getComputedStyle
(
body
)
.
height
;
ready
(
)
;
}
dispatchEvent
(
new
CustomEvent
(
"
ready
"
)
)
;
}
)
;
recordEvent
(
"
show
"
primary
.
dataset
.
l10nId
)
;
}
)
(
)
;
}
document
.
mozSubdialogReady
=
new
Promise
(
resolve
=
>
document
.
addEventListener
(
"
DOMContentLoaded
"
(
)
=
>
onLoad
(
resolve
)
{
once
:
true
}
)
)
;
