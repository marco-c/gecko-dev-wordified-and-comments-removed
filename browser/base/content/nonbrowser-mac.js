let
delayedStartupTimeoutId
=
null
;
function
OpenBrowserWindowFromDockMenu
(
options
)
{
let
win
=
OpenBrowserWindow
(
options
)
;
win
.
addEventListener
(
"
load
"
function
(
)
{
let
dockSupport
=
Cc
[
"
mozilla
.
org
/
widget
/
macdocksupport
;
1
"
]
.
getService
(
Ci
.
nsIMacDockSupport
)
;
dockSupport
.
activateApplication
(
true
)
;
}
{
once
:
true
}
)
;
return
win
;
}
function
nonBrowserWindowStartup
(
)
{
var
disabledItems
=
[
"
Browser
:
SavePage
"
"
Browser
:
SendLink
"
"
cmd_pageSetup
"
"
cmd_print
"
"
cmd_find
"
"
cmd_findAgain
"
"
viewToolbarsMenu
"
"
viewSidebarMenuMenu
"
"
Browser
:
Reload
"
"
viewFullZoomMenu
"
"
pageStyleMenu
"
"
charsetMenu
"
"
View
:
PageSource
"
"
View
:
FullScreen
"
"
viewHistorySidebar
"
"
Browser
:
AddBookmarkAs
"
"
Browser
:
BookmarkAllTabs
"
"
View
:
PageInfo
"
"
History
:
UndoCloseTab
"
]
;
var
element
;
for
(
let
disabledItem
of
disabledItems
)
{
element
=
document
.
getElementById
(
disabledItem
)
;
if
(
element
)
element
.
setAttribute
(
"
disabled
"
"
true
"
)
;
}
let
shownItems
=
[
"
menu_openLocation
"
]
;
for
(
let
shownItem
of
shownItems
)
{
element
=
document
.
getElementById
(
shownItem
)
;
if
(
element
)
element
.
removeAttribute
(
"
hidden
"
)
;
}
if
(
window
.
location
.
href
=
=
"
chrome
:
/
/
browser
/
content
/
hiddenWindow
.
xul
"
)
{
var
hiddenWindowDisabledItems
=
[
"
cmd_close
"
"
minimizeWindow
"
"
zoomWindow
"
]
;
for
(
let
hiddenWindowDisabledItem
of
hiddenWindowDisabledItems
)
{
element
=
document
.
getElementById
(
hiddenWindowDisabledItem
)
;
if
(
element
)
element
.
setAttribute
(
"
disabled
"
"
true
"
)
;
}
element
=
document
.
getElementById
(
"
sep
-
window
-
list
"
)
;
element
.
setAttribute
(
"
hidden
"
"
true
"
)
;
let
dockMenuElement
=
document
.
getElementById
(
"
menu_mac_dockmenu
"
)
;
if
(
dockMenuElement
!
=
null
)
{
let
nativeMenu
=
Cc
[
"
mozilla
.
org
/
widget
/
standalonenativemenu
;
1
"
]
.
createInstance
(
Ci
.
nsIStandaloneNativeMenu
)
;
try
{
nativeMenu
.
init
(
dockMenuElement
)
;
let
dockSupport
=
Cc
[
"
mozilla
.
org
/
widget
/
macdocksupport
;
1
"
]
.
getService
(
Ci
.
nsIMacDockSupport
)
;
dockSupport
.
dockMenu
=
nativeMenu
;
}
catch
(
e
)
{
}
}
}
if
(
PrivateBrowsingUtils
.
permanentPrivateBrowsing
)
{
document
.
getElementById
(
"
macDockMenuNewWindow
"
)
.
hidden
=
true
;
}
if
(
!
PrivateBrowsingUtils
.
enabled
)
{
document
.
getElementById
(
"
macDockMenuNewPrivateWindow
"
)
.
hidden
=
true
;
}
delayedStartupTimeoutId
=
setTimeout
(
nonBrowserWindowDelayedStartup
0
)
;
}
function
nonBrowserWindowDelayedStartup
(
)
{
delayedStartupTimeoutId
=
null
;
BrowserOffline
.
init
(
)
;
gPrivateBrowsingUI
.
init
(
)
;
}
function
nonBrowserWindowShutdown
(
)
{
let
dockSupport
=
Cc
[
"
mozilla
.
org
/
widget
/
macdocksupport
;
1
"
]
.
getService
(
Ci
.
nsIMacDockSupport
)
;
dockSupport
.
dockMenu
=
null
;
if
(
delayedStartupTimeoutId
)
{
clearTimeout
(
delayedStartupTimeoutId
)
;
return
;
}
BrowserOffline
.
uninit
(
)
;
}
addEventListener
(
"
load
"
nonBrowserWindowStartup
false
)
;
addEventListener
(
"
unload
"
nonBrowserWindowShutdown
false
)
;
