#
ifndef
__SECURITY_SANDBOX_SANDBOXBROKER_H__
#
define
__SECURITY_SANDBOX_SANDBOXBROKER_H__
#
include
<
stdint
.
h
>
#
include
<
windows
.
h
>
#
include
"
build
/
build_config
.
h
"
#
include
"
mozilla
/
ipc
/
EnvironmentMap
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
mozilla
/
ipc
/
UtilityProcessSandboxing
.
h
"
namespace
sandbox
{
class
BrokerServices
;
class
TargetPolicy
;
}
namespace
mozilla
{
class
AbstractSandboxBroker
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
AbstractSandboxBroker
)
static
AbstractSandboxBroker
*
Create
(
GeckoProcessType
aProcessType
)
;
virtual
void
Shutdown
(
)
=
0
;
virtual
bool
LaunchApp
(
const
wchar_t
*
aPath
const
wchar_t
*
aArguments
base
:
:
EnvironmentMap
&
aEnvironment
GeckoProcessType
aProcessType
const
bool
aEnableLogging
const
IMAGE_THUNK_DATA
*
aCachedNtdllThunk
void
*
*
aProcessHandle
)
=
0
;
virtual
void
SetSecurityLevelForContentProcess
(
int32_t
aSandboxLevel
bool
aIsFileProcess
)
=
0
;
virtual
void
SetSecurityLevelForGPUProcess
(
int32_t
aSandboxLevel
const
nsCOMPtr
<
nsIFile
>
&
aProfileDir
)
=
0
;
virtual
bool
SetSecurityLevelForRDDProcess
(
)
=
0
;
virtual
bool
SetSecurityLevelForSocketProcess
(
)
=
0
;
virtual
bool
SetSecurityLevelForUtilityProcess
(
mozilla
:
:
ipc
:
:
SandboxingKind
aSandbox
)
=
0
;
enum
SandboxLevel
{
LockDown
Restricted
}
;
virtual
bool
SetSecurityLevelForGMPlugin
(
SandboxLevel
aLevel
bool
aIsRemoteLaunch
=
false
)
=
0
;
virtual
bool
AllowReadFile
(
wchar_t
const
*
file
)
=
0
;
virtual
void
AddHandleToShare
(
HANDLE
aHandle
)
=
0
;
virtual
bool
IsWin32kLockedDown
(
)
=
0
;
protected
:
virtual
~
AbstractSandboxBroker
(
)
{
}
}
;
class
SandboxBroker
:
public
AbstractSandboxBroker
{
public
:
SandboxBroker
(
)
;
static
void
Initialize
(
sandbox
:
:
BrokerServices
*
aBrokerServices
)
;
void
Shutdown
(
)
override
{
}
static
void
GeckoDependentInitialize
(
)
;
bool
LaunchApp
(
const
wchar_t
*
aPath
const
wchar_t
*
aArguments
base
:
:
EnvironmentMap
&
aEnvironment
GeckoProcessType
aProcessType
const
bool
aEnableLogging
const
IMAGE_THUNK_DATA
*
aCachedNtdllThunk
void
*
*
aProcessHandle
)
override
;
virtual
~
SandboxBroker
(
)
;
void
SetSecurityLevelForContentProcess
(
int32_t
aSandboxLevel
bool
aIsFileProcess
)
override
;
void
SetSecurityLevelForGPUProcess
(
int32_t
aSandboxLevel
const
nsCOMPtr
<
nsIFile
>
&
aProfileDir
)
override
;
bool
SetSecurityLevelForRDDProcess
(
)
override
;
bool
SetSecurityLevelForSocketProcess
(
)
override
;
bool
SetSecurityLevelForGMPlugin
(
SandboxLevel
aLevel
bool
aIsRemoteLaunch
=
false
)
override
;
bool
SetSecurityLevelForUtilityProcess
(
mozilla
:
:
ipc
:
:
SandboxingKind
aSandbox
)
override
;
bool
AllowReadFile
(
wchar_t
const
*
file
)
override
;
static
bool
AddTargetPeer
(
HANDLE
aPeerProcess
)
;
void
AddHandleToShare
(
HANDLE
aHandle
)
override
;
bool
IsWin32kLockedDown
(
)
final
;
void
ApplyLoggingPolicy
(
)
;
private
:
static
sandbox
:
:
BrokerServices
*
sBrokerService
;
static
bool
sRunningFromNetworkDrive
;
sandbox
:
:
TargetPolicy
*
mPolicy
;
}
;
}
#
endif
