#
include
"
SandboxInitialization
.
h
"
#
include
"
sandbox
/
win
/
src
/
restricted_token
.
h
"
#
include
"
sandbox
/
win
/
src
/
sandbox_factory
.
h
"
#
include
"
mozilla
/
sandboxing
/
permissionsService
.
h
"
namespace
mozilla
{
namespace
sandboxing
{
static
sandbox
:
:
TargetServices
*
InitializeTargetServices
(
)
{
sandbox
:
:
TargetServices
*
targetServices
=
sandbox
:
:
SandboxFactory
:
:
GetTargetServices
(
)
;
if
(
!
targetServices
)
{
return
nullptr
;
}
if
(
targetServices
-
>
Init
(
)
!
=
sandbox
:
:
SBOX_ALL_OK
)
{
return
nullptr
;
}
return
targetServices
;
}
sandbox
:
:
TargetServices
*
GetInitializedTargetServices
(
)
{
static
sandbox
:
:
TargetServices
*
sInitializedTargetServices
=
InitializeTargetServices
(
)
;
return
sInitializedTargetServices
;
}
void
LowerSandbox
(
)
{
GetInitializedTargetServices
(
)
-
>
LowerToken
(
)
;
}
static
sandbox
:
:
BrokerServices
*
InitializeBrokerServices
(
)
{
sandbox
:
:
BrokerServices
*
brokerServices
=
sandbox
:
:
SandboxFactory
:
:
GetBrokerServices
(
)
;
if
(
!
brokerServices
)
{
return
nullptr
;
}
if
(
brokerServices
-
>
Init
(
)
!
=
sandbox
:
:
SBOX_ALL_OK
)
{
return
nullptr
;
}
sandbox
:
:
TargetPolicy
*
policy
=
brokerServices
-
>
CreatePolicy
(
)
;
sandbox
:
:
ResultCode
result
=
policy
-
>
CreateAlternateDesktop
(
true
)
;
policy
-
>
Release
(
)
;
return
brokerServices
;
}
sandbox
:
:
BrokerServices
*
GetInitializedBrokerServices
(
)
{
static
sandbox
:
:
BrokerServices
*
sInitializedBrokerServices
=
InitializeBrokerServices
(
)
;
return
sInitializedBrokerServices
;
}
void
NetworkDriveCheck
(
)
{
wchar_t
exePath
[
MAX_PATH
]
;
if
(
!
:
:
GetModuleFileNameW
(
nullptr
exePath
MAX_PATH
)
)
{
return
;
}
wchar_t
volPath
[
MAX_PATH
]
;
if
(
!
:
:
GetVolumePathNameW
(
exePath
volPath
MAX_PATH
)
)
{
return
;
}
sandbox
:
:
gUseRestricting
=
(
:
:
GetDriveTypeW
(
volPath
)
!
=
DRIVE_REMOTE
)
;
}
PermissionsService
*
GetPermissionsService
(
)
{
return
PermissionsService
:
:
GetInstance
(
)
;
}
}
}
