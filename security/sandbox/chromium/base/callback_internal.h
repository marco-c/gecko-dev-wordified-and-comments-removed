#
ifndef
BASE_CALLBACK_INTERNAL_H_
#
define
BASE_CALLBACK_INTERNAL_H_
#
include
"
base
/
base_export
.
h
"
#
include
"
base
/
callback_forward
.
h
"
#
include
"
base
/
macros
.
h
"
#
include
"
base
/
memory
/
ref_counted
.
h
"
namespace
base
{
struct
FakeBindState
;
namespace
internal
{
class
CallbackBase
;
class
CallbackBaseCopyable
;
class
BindStateBase
;
template
<
typename
Functor
typename
.
.
.
BoundArgs
>
struct
BindState
;
struct
BindStateBaseRefCountTraits
{
static
void
Destruct
(
const
BindStateBase
*
)
;
}
;
class
BASE_EXPORT
BindStateBase
:
public
RefCountedThreadSafe
<
BindStateBase
BindStateBaseRefCountTraits
>
{
public
:
REQUIRE_ADOPTION_FOR_REFCOUNTED_TYPE
(
)
;
using
InvokeFuncStorage
=
void
(
*
)
(
)
;
private
:
BindStateBase
(
InvokeFuncStorage
polymorphic_invoke
void
(
*
destructor
)
(
const
BindStateBase
*
)
)
;
BindStateBase
(
InvokeFuncStorage
polymorphic_invoke
void
(
*
destructor
)
(
const
BindStateBase
*
)
bool
(
*
is_cancelled
)
(
const
BindStateBase
*
)
)
;
~
BindStateBase
(
)
=
default
;
friend
struct
BindStateBaseRefCountTraits
;
friend
class
RefCountedThreadSafe
<
BindStateBase
BindStateBaseRefCountTraits
>
;
friend
class
CallbackBase
;
friend
class
CallbackBaseCopyable
;
template
<
typename
Functor
typename
.
.
.
BoundArgs
>
friend
struct
BindState
;
friend
struct
:
:
base
:
:
FakeBindState
;
bool
IsCancelled
(
)
const
{
return
is_cancelled_
(
this
)
;
}
InvokeFuncStorage
polymorphic_invoke_
;
void
(
*
destructor_
)
(
const
BindStateBase
*
)
;
bool
(
*
is_cancelled_
)
(
const
BindStateBase
*
)
;
DISALLOW_COPY_AND_ASSIGN
(
BindStateBase
)
;
}
;
class
BASE_EXPORT
CallbackBase
{
public
:
CallbackBase
(
CallbackBase
&
&
c
)
;
CallbackBase
&
operator
=
(
CallbackBase
&
&
c
)
;
explicit
CallbackBase
(
const
CallbackBaseCopyable
&
c
)
;
CallbackBase
&
operator
=
(
const
CallbackBaseCopyable
&
c
)
;
explicit
CallbackBase
(
CallbackBaseCopyable
&
&
c
)
;
CallbackBase
&
operator
=
(
CallbackBaseCopyable
&
&
c
)
;
bool
is_null
(
)
const
{
return
!
bind_state_
;
}
explicit
operator
bool
(
)
const
{
return
!
is_null
(
)
;
}
bool
IsCancelled
(
)
const
;
void
Reset
(
)
;
protected
:
using
InvokeFuncStorage
=
BindStateBase
:
:
InvokeFuncStorage
;
bool
EqualsInternal
(
const
CallbackBase
&
other
)
const
;
explicit
CallbackBase
(
BindStateBase
*
bind_state
)
;
InvokeFuncStorage
polymorphic_invoke
(
)
const
{
return
bind_state_
-
>
polymorphic_invoke_
;
}
~
CallbackBase
(
)
;
scoped_refptr
<
BindStateBase
>
bind_state_
;
}
;
class
BASE_EXPORT
CallbackBaseCopyable
:
public
CallbackBase
{
public
:
CallbackBaseCopyable
(
const
CallbackBaseCopyable
&
c
)
;
CallbackBaseCopyable
(
CallbackBaseCopyable
&
&
c
)
;
CallbackBaseCopyable
&
operator
=
(
const
CallbackBaseCopyable
&
c
)
;
CallbackBaseCopyable
&
operator
=
(
CallbackBaseCopyable
&
&
c
)
;
protected
:
explicit
CallbackBaseCopyable
(
BindStateBase
*
bind_state
)
:
CallbackBase
(
bind_state
)
{
}
~
CallbackBaseCopyable
(
)
{
}
}
;
}
}
#
endif
