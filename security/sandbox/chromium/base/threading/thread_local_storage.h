#
ifndef
BASE_THREADING_THREAD_LOCAL_STORAGE_H_
#
define
BASE_THREADING_THREAD_LOCAL_STORAGE_H_
#
include
<
stdint
.
h
>
#
include
"
base
/
base_export
.
h
"
#
include
"
build
/
build_config
.
h
"
#
if
BUILDFLAG
(
IS_WIN
)
#
include
"
base
/
win
/
windows_types
.
h
"
#
elif
BUILDFLAG
(
IS_POSIX
)
|
|
BUILDFLAG
(
IS_FUCHSIA
)
#
include
<
pthread
.
h
>
#
endif
namespace
base
{
class
SamplingHeapProfiler
;
namespace
debug
{
class
GlobalActivityTracker
;
}
namespace
trace_event
{
class
MallocDumpProvider
;
}
namespace
internal
{
class
ThreadLocalStorageTestInternal
;
class
BASE_EXPORT
PlatformThreadLocalStorage
{
public
:
#
if
BUILDFLAG
(
IS_WIN
)
typedef
unsigned
long
TLSKey
;
enum
:
unsigned
{
TLS_KEY_OUT_OF_INDEXES
=
TLS_OUT_OF_INDEXES
}
;
#
elif
BUILDFLAG
(
IS_POSIX
)
|
|
BUILDFLAG
(
IS_FUCHSIA
)
typedef
pthread_key_t
TLSKey
;
enum
{
TLS_KEY_OUT_OF_INDEXES
=
0x7FFFFFFF
}
;
#
endif
static
bool
AllocTLS
(
TLSKey
*
key
)
;
static
void
FreeTLS
(
TLSKey
key
)
;
static
void
SetTLSValue
(
TLSKey
key
void
*
value
)
;
static
void
*
GetTLSValue
(
TLSKey
key
)
{
#
if
BUILDFLAG
(
IS_WIN
)
return
TlsGetValue
(
key
)
;
#
elif
BUILDFLAG
(
IS_POSIX
)
|
|
BUILDFLAG
(
IS_FUCHSIA
)
return
pthread_getspecific
(
key
)
;
#
endif
}
#
if
BUILDFLAG
(
IS_WIN
)
static
void
OnThreadExit
(
)
;
#
elif
BUILDFLAG
(
IS_POSIX
)
|
|
BUILDFLAG
(
IS_FUCHSIA
)
static
void
OnThreadExit
(
void
*
value
)
;
#
endif
}
;
}
class
BASE_EXPORT
ThreadLocalStorage
{
public
:
typedef
void
(
*
TLSDestructorFunc
)
(
void
*
value
)
;
class
BASE_EXPORT
Slot
final
{
public
:
explicit
Slot
(
TLSDestructorFunc
destructor
=
nullptr
)
;
Slot
(
const
Slot
&
)
=
delete
;
Slot
&
operator
=
(
const
Slot
&
)
=
delete
;
~
Slot
(
)
;
void
*
Get
(
)
const
;
void
Set
(
void
*
value
)
;
private
:
void
Initialize
(
TLSDestructorFunc
destructor
)
;
void
Free
(
)
;
static
constexpr
size_t
kInvalidSlotValue
=
static_cast
<
size_t
>
(
-
1
)
;
size_t
slot_
=
kInvalidSlotValue
;
uint32_t
version_
=
0
;
}
;
ThreadLocalStorage
(
const
ThreadLocalStorage
&
)
=
delete
;
ThreadLocalStorage
&
operator
=
(
const
ThreadLocalStorage
&
)
=
delete
;
private
:
friend
class
SequenceCheckerImpl
;
friend
class
SamplingHeapProfiler
;
friend
class
ThreadCheckerImpl
;
friend
class
internal
:
:
ThreadLocalStorageTestInternal
;
friend
class
trace_event
:
:
MallocDumpProvider
;
friend
class
debug
:
:
GlobalActivityTracker
;
static
bool
HasBeenDestroyed
(
)
;
}
;
}
#
endif
