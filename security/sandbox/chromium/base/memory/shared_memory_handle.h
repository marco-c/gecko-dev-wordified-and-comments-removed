#
ifndef
BASE_MEMORY_SHARED_MEMORY_HANDLE_H_
#
define
BASE_MEMORY_SHARED_MEMORY_HANDLE_H_
#
include
<
stddef
.
h
>
#
include
"
base
/
unguessable_token
.
h
"
#
include
"
build
/
build_config
.
h
"
#
if
defined
(
OS_WIN
)
#
include
"
base
/
process
/
process_handle
.
h
"
#
include
"
base
/
win
/
windows_types
.
h
"
#
elif
defined
(
OS_MACOSX
)
&
&
!
defined
(
OS_IOS
)
#
include
<
mach
/
mach
.
h
>
#
include
"
base
/
base_export
.
h
"
#
include
"
base
/
macros
.
h
"
#
include
"
base
/
process
/
process_handle
.
h
"
#
elif
defined
(
OS_POSIX
)
#
include
<
sys
/
types
.
h
>
#
include
"
base
/
file_descriptor_posix
.
h
"
#
elif
defined
(
OS_FUCHSIA
)
#
include
<
zircon
/
types
.
h
>
#
endif
namespace
base
{
class
BASE_EXPORT
SharedMemoryHandle
{
public
:
SharedMemoryHandle
(
)
;
SharedMemoryHandle
(
const
SharedMemoryHandle
&
handle
)
;
SharedMemoryHandle
&
operator
=
(
const
SharedMemoryHandle
&
handle
)
;
void
Close
(
)
const
;
void
SetOwnershipPassesToIPC
(
bool
ownership_passes
)
;
bool
OwnershipPassesToIPC
(
)
const
;
bool
IsValid
(
)
const
;
SharedMemoryHandle
Duplicate
(
)
const
;
base
:
:
UnguessableToken
GetGUID
(
)
const
;
size_t
GetSize
(
)
const
;
#
if
defined
(
OS_WIN
)
SharedMemoryHandle
(
HANDLE
h
size_t
size
const
base
:
:
UnguessableToken
&
guid
)
;
HANDLE
GetHandle
(
)
const
;
#
elif
defined
(
OS_FUCHSIA
)
SharedMemoryHandle
(
zx_handle_t
h
size_t
size
const
base
:
:
UnguessableToken
&
guid
)
;
zx_handle_t
GetHandle
(
)
const
;
#
elif
defined
(
OS_MACOSX
)
&
&
!
defined
(
OS_IOS
)
SharedMemoryHandle
(
mach_vm_size_t
size
const
base
:
:
UnguessableToken
&
guid
)
;
SharedMemoryHandle
(
mach_port_t
memory_object
mach_vm_size_t
size
const
base
:
:
UnguessableToken
&
guid
)
;
mach_port_t
GetMemoryObject
(
)
const
;
bool
MapAt
(
off_t
offset
size_t
bytes
void
*
*
memory
bool
read_only
)
;
#
elif
defined
(
OS_POSIX
)
static
SharedMemoryHandle
ImportHandle
(
int
fd
size_t
size
)
;
int
GetHandle
(
)
const
;
int
Release
(
)
;
#
endif
#
if
defined
(
OS_ANDROID
)
void
SetReadOnly
(
)
{
read_only_
=
true
;
}
bool
IsReadOnly
(
)
const
{
return
read_only_
;
}
bool
IsRegionReadOnly
(
)
const
;
bool
SetRegionReadOnly
(
)
const
;
#
endif
#
if
defined
(
OS_POSIX
)
&
&
!
(
defined
(
OS_MACOSX
)
&
&
!
defined
(
OS_IOS
)
)
SharedMemoryHandle
(
const
base
:
:
FileDescriptor
&
file_descriptor
size_t
size
const
base
:
:
UnguessableToken
&
guid
)
;
#
endif
private
:
#
if
defined
(
OS_WIN
)
HANDLE
handle_
=
nullptr
;
bool
ownership_passes_to_ipc_
=
false
;
#
elif
defined
(
OS_FUCHSIA
)
zx_handle_t
handle_
=
ZX_HANDLE_INVALID
;
bool
ownership_passes_to_ipc_
=
false
;
#
elif
defined
(
OS_MACOSX
)
&
&
!
defined
(
OS_IOS
)
friend
class
SharedMemory
;
friend
bool
CheckReadOnlySharedMemoryHandleForTesting
(
SharedMemoryHandle
handle
)
;
mach_port_t
memory_object_
=
MACH_PORT_NULL
;
bool
ownership_passes_to_ipc_
=
false
;
#
elif
defined
(
OS_ANDROID
)
friend
class
SharedMemory
;
FileDescriptor
file_descriptor_
;
bool
read_only_
=
false
;
#
elif
defined
(
OS_POSIX
)
FileDescriptor
file_descriptor_
;
#
endif
base
:
:
UnguessableToken
guid_
;
size_t
size_
=
0
;
}
;
}
#
endif
