#
ifndef
BASE_SYNCHRONIZATION_LOCK_IMPL_H_
#
define
BASE_SYNCHRONIZATION_LOCK_IMPL_H_
#
include
"
base
/
base_export
.
h
"
#
include
"
base
/
logging
.
h
"
#
include
"
base
/
macros
.
h
"
#
include
"
build
/
build_config
.
h
"
#
if
defined
(
OS_WIN
)
#
include
<
windows
.
h
>
#
elif
defined
(
OS_POSIX
)
#
include
<
errno
.
h
>
#
include
<
pthread
.
h
>
#
endif
namespace
base
{
namespace
internal
{
class
BASE_EXPORT
LockImpl
{
public
:
#
if
defined
(
OS_WIN
)
using
NativeHandle
=
SRWLOCK
;
#
elif
defined
(
OS_POSIX
)
using
NativeHandle
=
pthread_mutex_t
;
#
endif
LockImpl
(
)
;
~
LockImpl
(
)
;
bool
Try
(
)
;
void
Lock
(
)
;
inline
void
Unlock
(
)
;
NativeHandle
*
native_handle
(
)
{
return
&
native_handle_
;
}
#
if
defined
(
OS_POSIX
)
static
bool
PriorityInheritanceAvailable
(
)
;
#
endif
private
:
NativeHandle
native_handle_
;
DISALLOW_COPY_AND_ASSIGN
(
LockImpl
)
;
}
;
#
if
defined
(
OS_WIN
)
void
LockImpl
:
:
Unlock
(
)
{
:
:
ReleaseSRWLockExclusive
(
&
native_handle_
)
;
}
#
elif
defined
(
OS_POSIX
)
void
LockImpl
:
:
Unlock
(
)
{
int
rv
=
pthread_mutex_unlock
(
&
native_handle_
)
;
DCHECK_EQ
(
rv
0
)
<
<
"
.
"
<
<
strerror
(
rv
)
;
}
#
endif
}
}
#
endif
