#
ifndef
BASE_SYNCHRONIZATION_LOCK_H_
#
define
BASE_SYNCHRONIZATION_LOCK_H_
#
include
"
base
/
base_export
.
h
"
#
include
"
base
/
dcheck_is_on
.
h
"
#
include
"
base
/
synchronization
/
lock_impl
.
h
"
#
include
"
base
/
thread_annotations
.
h
"
#
include
"
build
/
build_config
.
h
"
#
if
DCHECK_IS_ON
(
)
#
include
"
base
/
threading
/
platform_thread_ref
.
h
"
#
endif
namespace
base
{
class
LOCKABLE
BASE_EXPORT
Lock
{
public
:
#
if
!
DCHECK_IS_ON
(
)
Lock
(
)
:
lock_
(
)
{
}
Lock
(
const
Lock
&
)
=
delete
;
Lock
&
operator
=
(
const
Lock
&
)
=
delete
;
~
Lock
(
)
{
}
void
Acquire
(
)
EXCLUSIVE_LOCK_FUNCTION
(
)
{
lock_
.
Lock
(
)
;
}
void
Release
(
)
UNLOCK_FUNCTION
(
)
{
lock_
.
Unlock
(
)
;
}
bool
Try
(
)
EXCLUSIVE_TRYLOCK_FUNCTION
(
true
)
{
return
lock_
.
Try
(
)
;
}
void
AssertAcquired
(
)
const
ASSERT_EXCLUSIVE_LOCK
(
)
{
}
void
AssertNotHeld
(
)
const
{
}
#
else
Lock
(
)
;
~
Lock
(
)
;
void
Acquire
(
)
EXCLUSIVE_LOCK_FUNCTION
(
)
{
lock_
.
Lock
(
)
;
CheckUnheldAndMark
(
)
;
}
void
Release
(
)
UNLOCK_FUNCTION
(
)
{
CheckHeldAndUnmark
(
)
;
lock_
.
Unlock
(
)
;
}
bool
Try
(
)
EXCLUSIVE_TRYLOCK_FUNCTION
(
true
)
{
bool
rv
=
lock_
.
Try
(
)
;
if
(
rv
)
{
CheckUnheldAndMark
(
)
;
}
return
rv
;
}
void
AssertAcquired
(
)
const
ASSERT_EXCLUSIVE_LOCK
(
)
;
void
AssertNotHeld
(
)
const
;
#
endif
static
bool
HandlesMultipleThreadPriorities
(
)
{
#
if
BUILDFLAG
(
IS_WIN
)
return
true
;
#
elif
BUILDFLAG
(
IS_POSIX
)
|
|
BUILDFLAG
(
IS_FUCHSIA
)
return
internal
:
:
LockImpl
:
:
PriorityInheritanceAvailable
(
)
;
#
else
#
error
Unsupported
platform
#
endif
}
friend
class
ConditionVariable
;
private
:
#
if
DCHECK_IS_ON
(
)
void
CheckHeldAndUnmark
(
)
;
void
CheckUnheldAndMark
(
)
;
base
:
:
PlatformThreadRef
owning_thread_ref_
;
#
endif
internal
:
:
LockImpl
lock_
;
}
;
using
AutoLock
=
internal
:
:
BasicAutoLock
<
Lock
>
;
using
AutoTryLock
=
internal
:
:
BasicAutoTryLock
<
Lock
>
;
using
AutoUnlock
=
internal
:
:
BasicAutoUnlock
<
Lock
>
;
using
AutoLockMaybe
=
internal
:
:
BasicAutoLockMaybe
<
Lock
>
;
using
ReleasableAutoLock
=
internal
:
:
BasicReleasableAutoLock
<
Lock
>
;
}
#
endif
