#
ifndef
SANDBOX_WIN_SRC_POLICY_LOW_LEVEL_H_
#
define
SANDBOX_WIN_SRC_POLICY_LOW_LEVEL_H_
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
<
list
>
#
include
<
string
>
#
include
"
base
/
memory
/
raw_ptr
.
h
"
#
include
"
sandbox
/
win
/
src
/
ipc_tags
.
h
"
#
include
"
sandbox
/
win
/
src
/
policy_engine_opcodes
.
h
"
#
include
"
sandbox
/
win
/
src
/
policy_engine_params
.
h
"
namespace
sandbox
{
struct
PolicyGlobal
{
PolicyBuffer
*
entry
[
kMaxServiceCount
]
;
size_t
data_size
;
PolicyBuffer
data
[
1
]
;
}
;
class
PolicyRule
;
class
LowLevelPolicy
{
public
:
LowLevelPolicy
(
)
=
delete
;
explicit
LowLevelPolicy
(
PolicyGlobal
*
policy_store
)
;
LowLevelPolicy
(
const
LowLevelPolicy
&
)
=
delete
;
LowLevelPolicy
&
operator
=
(
const
LowLevelPolicy
&
)
=
delete
;
~
LowLevelPolicy
(
)
;
bool
AddRule
(
IpcTag
service
PolicyRule
*
rule
)
;
bool
Done
(
)
;
private
:
struct
RuleNode
{
raw_ptr
<
const
PolicyRule
DanglingUntriaged
>
rule
;
IpcTag
service
;
}
;
std
:
:
list
<
RuleNode
>
rules_
;
raw_ptr
<
PolicyGlobal
DanglingUntriaged
>
policy_store_
;
}
;
enum
RuleType
{
IF
=
0
IF_NOT
=
1
}
;
enum
RuleOp
{
EQUAL
AND
RANGE
}
;
class
PolicyRule
{
friend
class
LowLevelPolicy
;
public
:
explicit
PolicyRule
(
EvalResult
action
)
;
PolicyRule
(
const
PolicyRule
&
other
)
;
~
PolicyRule
(
)
;
bool
AddStringMatch
(
RuleType
rule_type
uint8_t
parameter
const
wchar_t
*
string
StringMatchOptions
match_opts
)
;
bool
AddNumberMatch
(
RuleType
rule_type
uint8_t
parameter
uint32_t
number
RuleOp
comparison_op
)
;
size_t
GetOpcodeCount
(
)
const
{
return
buffer_
-
>
opcode_count
;
}
bool
Done
(
)
;
private
:
void
operator
=
(
const
PolicyRule
&
)
;
bool
GenStringOpcode
(
RuleType
rule_type
StringMatchOptions
match_opts
uint8_t
parameter
int
state
bool
last_call
int
*
skip_count
std
:
:
wstring
*
fragment
)
;
bool
RebindCopy
(
PolicyOpcode
*
opcode_start
size_t
opcode_size
char
*
data_start
size_t
*
data_size
)
const
;
raw_ptr
<
PolicyBuffer
>
buffer_
;
raw_ptr
<
OpcodeFactory
>
opcode_factory_
;
EvalResult
action_
;
bool
done_
;
}
;
}
#
endif
