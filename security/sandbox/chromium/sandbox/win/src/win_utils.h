#
ifndef
SANDBOX_SRC_WIN_UTILS_H_
#
define
SANDBOX_SRC_WIN_UTILS_H_
#
include
<
stddef
.
h
>
#
include
<
windows
.
h
>
#
include
<
memory
>
#
include
<
string
>
#
include
"
base
/
macros
.
h
"
#
include
"
base
/
stl_util
.
h
"
#
include
"
sandbox
/
win
/
src
/
nt_internals
.
h
"
namespace
sandbox
{
const
wchar_t
kNTPrefix
[
]
=
L
"
\
\
?
?
\
\
"
;
const
size_t
kNTPrefixLen
=
base
:
:
size
(
kNTPrefix
)
-
1
;
const
wchar_t
kNTDevicePrefix
[
]
=
L
"
\
\
Device
\
\
"
;
const
size_t
kNTDevicePrefixLen
=
base
:
:
size
(
kNTDevicePrefix
)
-
1
;
class
AutoLock
{
public
:
explicit
AutoLock
(
CRITICAL_SECTION
*
lock
)
:
lock_
(
lock
)
{
:
:
EnterCriticalSection
(
lock
)
;
}
~
AutoLock
(
)
{
:
:
LeaveCriticalSection
(
lock_
)
;
}
private
:
CRITICAL_SECTION
*
lock_
;
DISALLOW_IMPLICIT_CONSTRUCTORS
(
AutoLock
)
;
}
;
template
<
typename
Derived
>
class
SingletonBase
{
public
:
static
Derived
*
GetInstance
(
)
{
static
Derived
*
instance
=
nullptr
;
if
(
!
instance
)
{
instance
=
new
Derived
(
)
;
_onexit
(
OnExit
)
;
}
return
instance
;
}
private
:
static
int
__cdecl
OnExit
(
)
{
delete
GetInstance
(
)
;
return
0
;
}
}
;
struct
LocalFreeDeleter
{
inline
void
operator
(
)
(
void
*
ptr
)
const
{
:
:
LocalFree
(
ptr
)
;
}
}
;
bool
ConvertToLongPath
(
std
:
:
wstring
*
path
const
std
:
:
wstring
*
drive_letter
=
nullptr
)
;
DWORD
IsReparsePoint
(
const
std
:
:
wstring
&
full_path
)
;
bool
SameObject
(
HANDLE
handle
const
wchar_t
*
full_path
)
;
bool
GetPathFromHandle
(
HANDLE
handle
std
:
:
wstring
*
path
)
;
bool
GetNtPathFromWin32Path
(
const
std
:
:
wstring
&
path
std
:
:
wstring
*
nt_path
)
;
HKEY
GetReservedKeyFromName
(
const
std
:
:
wstring
&
name
)
;
bool
ResolveRegistryName
(
std
:
:
wstring
name
std
:
:
wstring
*
resolved_name
)
;
bool
WriteProtectedChildMemory
(
HANDLE
child_process
void
*
address
const
void
*
buffer
size_t
length
)
;
bool
CopyToChildMemory
(
HANDLE
child
const
void
*
local_buffer
size_t
buffer_bytes
void
*
*
remote_buffer
)
;
bool
IsPipe
(
const
std
:
:
wstring
&
path
)
;
DWORD
GetLastErrorFromNtStatus
(
NTSTATUS
status
)
;
void
*
GetProcessBaseAddress
(
HANDLE
process
)
;
DWORD
GetTokenInformation
(
HANDLE
token
TOKEN_INFORMATION_CLASS
info_class
std
:
:
unique_ptr
<
BYTE
[
]
>
*
buffer
)
;
}
void
ResolveNTFunctionPtr
(
const
char
*
name
void
*
ptr
)
;
#
endif
