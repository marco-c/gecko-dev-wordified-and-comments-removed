#
ifndef
SANDBOX_WIN_SRC_SANDBOX_H_
#
define
SANDBOX_WIN_SRC_SANDBOX_H_
#
if
!
defined
(
SANDBOX_FUZZ_TARGET
)
#
include
<
windows
.
h
>
#
else
#
include
"
sandbox
/
win
/
fuzzer
/
fuzzer_types
.
h
"
#
endif
#
include
<
stddef
.
h
>
#
include
<
memory
>
#
include
<
vector
>
#
include
"
base
/
memory
/
ref_counted
.
h
"
#
include
"
sandbox
/
win
/
src
/
sandbox_policy
.
h
"
#
include
"
sandbox
/
win
/
src
/
sandbox_types
.
h
"
namespace
sandbox
{
class
BrokerServices
;
class
PolicyDiagnosticsReceiver
;
class
ProcessState
;
class
TargetPolicy
;
class
TargetServices
;
class
BrokerServices
{
public
:
virtual
ResultCode
Init
(
)
=
0
;
virtual
scoped_refptr
<
TargetPolicy
>
CreatePolicy
(
)
=
0
;
virtual
ResultCode
SpawnTarget
(
const
wchar_t
*
exe_path
const
wchar_t
*
command_line
base
:
:
EnvironmentMap
&
env_map
scoped_refptr
<
TargetPolicy
>
policy
ResultCode
*
last_warning
DWORD
*
last_error
PROCESS_INFORMATION
*
target
)
=
0
;
virtual
ResultCode
WaitForAllTargets
(
)
=
0
;
virtual
ResultCode
AddTargetPeer
(
HANDLE
peer_process
)
=
0
;
virtual
ResultCode
GetPolicyDiagnostics
(
std
:
:
unique_ptr
<
PolicyDiagnosticsReceiver
>
receiver
)
=
0
;
virtual
bool
DeriveCapabilitySidFromName
(
const
wchar_t
*
name
PSID
derived_sid
DWORD
sid_buffer_length
)
=
0
;
protected
:
~
BrokerServices
(
)
{
}
}
;
class
TargetServices
{
public
:
virtual
ResultCode
Init
(
)
=
0
;
virtual
void
LowerToken
(
)
=
0
;
virtual
ProcessState
*
GetState
(
)
=
0
;
virtual
ResultCode
DuplicateHandle
(
HANDLE
source_handle
DWORD
target_process_id
HANDLE
*
target_handle
DWORD
desired_access
DWORD
options
)
=
0
;
virtual
ResultCode
GetComplexLineBreaks
(
const
WCHAR
*
text
uint32_t
length
uint8_t
*
break_before
)
=
0
;
protected
:
~
TargetServices
(
)
{
}
}
;
class
PolicyInfo
{
public
:
virtual
const
char
*
JsonString
(
)
=
0
;
virtual
~
PolicyInfo
(
)
{
}
}
;
class
PolicyList
{
public
:
virtual
std
:
:
vector
<
std
:
:
unique_ptr
<
PolicyInfo
>
>
:
:
iterator
begin
(
)
=
0
;
virtual
std
:
:
vector
<
std
:
:
unique_ptr
<
PolicyInfo
>
>
:
:
iterator
end
(
)
=
0
;
virtual
size_t
size
(
)
const
=
0
;
virtual
~
PolicyList
(
)
{
}
}
;
class
PolicyDiagnosticsReceiver
{
public
:
virtual
void
ReceiveDiagnostics
(
std
:
:
unique_ptr
<
PolicyList
>
policies
)
=
0
;
virtual
void
OnError
(
ResultCode
code
)
=
0
;
virtual
~
PolicyDiagnosticsReceiver
(
)
{
}
}
;
}
#
endif
