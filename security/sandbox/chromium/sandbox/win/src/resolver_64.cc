#
include
"
sandbox
/
win
/
src
/
resolver
.
h
"
#
include
<
windows
.
h
>
#
include
<
ntstatus
.
h
>
#
include
<
stddef
.
h
>
#
include
<
new
>
namespace
{
#
if
defined
(
_M_X64
)
const
USHORT
kMovRax
=
0xB848
;
const
USHORT
kJmpRax
=
0xe0ff
;
#
pragma
pack
(
push
1
)
struct
InternalThunk
{
InternalThunk
(
)
{
mov_rax
=
kMovRax
;
jmp_rax
=
kJmpRax
;
interceptor_function
=
0
;
}
USHORT
mov_rax
;
ULONG_PTR
interceptor_function
;
USHORT
jmp_rax
;
}
;
#
pragma
pack
(
pop
)
#
elif
defined
(
_M_ARM64
)
const
ULONG
kLdrX16Pc4
=
0x58000050
;
const
ULONG
kBrX16
=
0xD61F0200
;
#
pragma
pack
(
push
4
)
struct
InternalThunk
{
InternalThunk
(
)
{
ldr_x16_pc4
=
kLdrX16Pc4
;
br_x16
=
kBrX16
;
interceptor_function
=
0
;
}
ULONG
ldr_x16_pc4
;
ULONG
br_x16
;
ULONG_PTR
interceptor_function
;
}
;
#
pragma
pack
(
pop
)
#
else
#
error
"
Unsupported
Windows
64
-
bit
Arch
"
#
endif
}
namespace
sandbox
{
size_t
ResolverThunk
:
:
GetInternalThunkSize
(
)
const
{
return
sizeof
(
InternalThunk
)
;
}
bool
ResolverThunk
:
:
SetInternalThunk
(
void
*
storage
size_t
storage_bytes
const
void
*
original_function
const
void
*
interceptor
)
{
if
(
storage_bytes
<
sizeof
(
InternalThunk
)
)
return
false
;
InternalThunk
*
thunk
=
new
(
storage
)
InternalThunk
;
thunk
-
>
interceptor_function
=
reinterpret_cast
<
ULONG_PTR
>
(
interceptor
)
;
return
true
;
}
NTSTATUS
ResolverThunk
:
:
ResolveTarget
(
const
void
*
module
const
char
*
function_name
void
*
*
address
)
{
return
STATUS_NOT_IMPLEMENTED
;
}
}
