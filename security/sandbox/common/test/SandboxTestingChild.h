#
ifndef
mozilla_SandboxTestingChild_h
#
define
mozilla_SandboxTestingChild_h
#
include
"
mozilla
/
PSandboxTestingChild
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsISupports
.
h
"
#
ifdef
XP_UNIX
#
include
"
nsString
.
h
"
#
endif
#
if
!
defined
(
MOZ_SANDBOX
)
|
|
!
defined
(
MOZ_DEBUG
)
|
|
!
defined
(
ENABLE_TESTS
)
#
error
"
This
file
should
not
be
used
outside
of
debug
with
tests
"
#
endif
namespace
mozilla
{
class
SandboxTestingThread
;
class
SandboxTestingChild
:
public
PSandboxTestingChild
{
public
:
static
bool
Initialize
(
Endpoint
<
PSandboxTestingChild
>
&
&
aSandboxTestingEndpoint
)
;
static
SandboxTestingChild
*
GetInstance
(
)
;
static
void
Destroy
(
)
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
SandboxTestingChild
override
)
bool
IsTestThread
(
)
;
void
PostToTestThread
(
already_AddRefed
<
nsIRunnable
>
&
&
runnable
)
;
void
ActorDestroy
(
ActorDestroyReason
aWhy
)
override
;
virtual
ipc
:
:
IPCResult
RecvShutDown
(
)
;
inline
void
ReportNoTests
(
)
;
void
PosixTest
(
const
nsCString
&
aName
bool
aExpectSuccess
int
aStatus
Maybe
<
int
>
aExpectedError
=
Nothing
(
)
)
;
template
<
typename
F
>
void
ErrnoTest
(
const
nsCString
&
aName
bool
aExpectSuccess
F
&
&
aFunction
)
;
template
<
typename
F
>
void
ErrnoValueTest
(
const
nsCString
&
aName
int
aExpectedErrno
F
&
&
aFunction
)
;
private
:
explicit
SandboxTestingChild
(
SandboxTestingThread
*
aThread
Endpoint
<
PSandboxTestingChild
>
&
&
aEndpoint
)
;
~
SandboxTestingChild
(
)
;
void
Bind
(
Endpoint
<
PSandboxTestingChild
>
&
&
aEndpoint
)
;
UniquePtr
<
SandboxTestingThread
>
mThread
;
static
StaticRefPtr
<
SandboxTestingChild
>
sInstance
;
}
;
}
#
endif
