#
include
"
nss
.
h
"
#
include
"
secpkcs7
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
nss_scoped_ptrs
.
h
"
namespace
nss_test
{
static
const
uint8_t
p7_with_unknown_hashes
[
]
=
{
0x30
0x4d
0x06
0x09
0x2a
0x86
0x48
0x86
0xf7
0x0d
0x01
0x07
0x02
0xa0
0x40
0x30
0x3e
0x02
0x01
0x20
0x31
0x27
0x30
0x0b
0x06
0x09
0x60
0x86
0x48
0x01
0x65
0x03
0x04
0x02
0x05
0x30
0x0b
0x06
0x09
0x60
0x86
0x48
0x01
0x65
0x03
0x04
0x02
0x05
0x30
0x0b
0x06
0x09
0x60
0x86
0x48
0x01
0x65
0x03
0x04
0x02
0x04
0x30
0x10
0x06
0x09
0x2a
0x86
0x48
0x86
0xf7
0x0d
0x01
0x07
0x01
0xa0
0x03
0x04
0x01
0x00
}
;
static
const
uint8_t
p7_with_multiple_hashes
[
]
=
{
0x30
0x4d
0x06
0x09
0x2a
0x86
0x48
0x86
0xf7
0x0d
0x01
0x07
0x02
0xa0
0x40
0x30
0x3e
0x02
0x01
0x20
0x31
0x27
0x30
0x0b
0x06
0x09
0x60
0x86
0x48
0x01
0x65
0x03
0x04
0x02
0x03
0x30
0x0b
0x06
0x09
0x60
0x86
0x48
0x01
0x65
0x03
0x04
0x02
0x02
0x30
0x0b
0x06
0x09
0x60
0x86
0x48
0x01
0x65
0x03
0x04
0x02
0x04
0x30
0x10
0x06
0x09
0x2a
0x86
0x48
0x86
0xf7
0x0d
0x01
0x07
0x01
0xa0
0x03
0x04
0x01
0x00
}
;
class
P7ImportTest
:
public
:
:
testing
:
:
Test
{
}
;
TEST_F
(
P7ImportTest
FailSafeWithUnknownHashes
)
{
ScopedSEC_PKCS7DecoderContext
dcx
(
SEC_PKCS7DecoderStart
(
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
)
)
;
ASSERT_TRUE
(
dcx
)
;
SECStatus
rv
=
SEC_PKCS7DecoderUpdate
(
dcx
.
get
(
)
reinterpret_cast
<
const
char
*
>
(
p7_with_unknown_hashes
)
sizeof
(
p7_with_unknown_hashes
)
)
;
ASSERT_EQ
(
SECFailure
rv
)
;
}
TEST_F
(
P7ImportTest
NoLeakWithMultipleHashes
)
{
ScopedSEC_PKCS7DecoderContext
dcx
(
SEC_PKCS7DecoderStart
(
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
)
)
;
ASSERT_TRUE
(
dcx
)
;
SECStatus
rv
=
SEC_PKCS7DecoderUpdate
(
dcx
.
get
(
)
reinterpret_cast
<
const
char
*
>
(
p7_with_multiple_hashes
)
sizeof
(
p7_with_multiple_hashes
)
)
;
ASSERT_EQ
(
SECFailure
rv
)
;
}
}
