#
include
"
gtest_utils
.
h
"
#
include
"
ssl
.
h
"
#
include
"
tls_connect
.
h
"
namespace
nss_test
{
class
SslOptionTest
:
public
:
:
testing
:
:
Test
{
}
;
static
PRInt32
nextOption
(
PRInt32
index
)
{
switch
(
+
+
index
)
{
case
SSL_SOCKS
:
case
4
:
case
SSL_ENABLE_SSL2
:
case
SSL_V2_COMPATIBLE_HELLO
:
case
SSL_ENABLE_TLS
:
case
SSL_NO_STEP_DOWN
:
case
SSL_BYPASS_PKCS11
:
case
SSL_ENABLE_NPN
:
case
SSL_RECORD_SIZE_LIMIT
:
return
nextOption
(
index
)
;
}
return
index
;
}
TEST_F
(
SslOptionTest
OptionSetDefault
)
{
PRIntn
original
modified
;
PRInt32
index
=
nextOption
(
0
)
;
while
(
SECSuccess
=
=
SSL_OptionGetDefault
(
index
&
original
)
)
{
EXPECT_EQ
(
SECSuccess
SSL_OptionSetDefault
(
index
1
^
original
)
)
;
EXPECT_EQ
(
SECSuccess
SSL_OptionGetDefault
(
index
&
modified
)
)
;
EXPECT_EQ
(
modified
1
^
original
)
;
EXPECT_EQ
(
SECSuccess
SSL_OptionSetDefault
(
index
original
)
)
;
index
=
nextOption
(
index
)
;
}
EXPECT_EQ
(
index
SSL_DB_LOAD_CERTIFICATE_CHAIN
+
1
)
;
}
TEST_F
(
TlsConnectStreamTls13
OptionSet
)
{
EnsureTlsSetup
(
)
;
PRIntn
original
modified
;
PRInt32
index
=
nextOption
(
0
)
;
while
(
SECSuccess
=
=
SSL_OptionGetDefault
(
index
&
original
)
)
{
EXPECT_EQ
(
SECSuccess
SSL_OptionSet
(
client_
-
>
ssl_fd
(
)
index
1
^
original
)
)
;
EXPECT_EQ
(
SECSuccess
SSL_OptionGet
(
client_
-
>
ssl_fd
(
)
index
&
modified
)
)
;
EXPECT_EQ
(
modified
1
^
original
)
;
EXPECT_EQ
(
SECSuccess
SSL_OptionSet
(
client_
-
>
ssl_fd
(
)
index
original
)
)
;
index
=
nextOption
(
index
)
;
}
EXPECT_EQ
(
index
SSL_DB_LOAD_CERTIFICATE_CHAIN
+
1
)
;
Connect
(
)
;
}
TEST_P
(
TlsConnectTls12Plus
NoLocksHandshake
)
{
EnsureTlsSetup
(
)
;
EXPECT_EQ
(
SECSuccess
SSL_OptionSet
(
client_
-
>
ssl_fd
(
)
SSL_NO_LOCKS
PR_TRUE
)
)
;
EXPECT_EQ
(
SECSuccess
SSL_OptionSet
(
server_
-
>
ssl_fd
(
)
SSL_NO_LOCKS
PR_TRUE
)
)
;
Connect
(
)
;
}
}
