#
ifndef
tls_filter_h_
#
define
tls_filter_h_
#
include
<
functional
>
#
include
<
memory
>
#
include
<
vector
>
#
include
"
test_io
.
h
"
#
include
"
tls_parser
.
h
"
#
include
"
tls_protect
.
h
"
extern
"
C
"
{
#
include
"
libssl_internals
.
h
"
}
namespace
nss_test
{
class
TlsCipherSpec
;
class
TlsAgent
;
class
TlsVersioned
{
public
:
TlsVersioned
(
)
:
version_
(
0
)
{
}
explicit
TlsVersioned
(
uint16_t
version
)
:
version_
(
version
)
{
}
bool
is_dtls
(
)
const
{
return
IsDtls
(
version_
)
;
}
uint16_t
version
(
)
const
{
return
version_
;
}
void
WriteStream
(
std
:
:
ostream
&
stream
)
const
;
protected
:
uint16_t
version_
;
}
;
class
TlsRecordHeader
:
public
TlsVersioned
{
public
:
TlsRecordHeader
(
)
:
TlsVersioned
(
)
content_type_
(
0
)
sequence_number_
(
0
)
{
}
TlsRecordHeader
(
uint16_t
version
uint8_t
content_type
uint64_t
sequence_number
)
:
TlsVersioned
(
version
)
content_type_
(
content_type
)
sequence_number_
(
sequence_number
)
{
}
uint8_t
content_type
(
)
const
{
return
content_type_
;
}
uint64_t
sequence_number
(
)
const
{
return
sequence_number_
;
}
size_t
header_length
(
)
const
{
return
is_dtls
(
)
?
11
:
3
;
}
bool
Parse
(
TlsParser
*
parser
DataBuffer
*
body
)
;
size_t
Write
(
DataBuffer
*
buffer
size_t
offset
const
DataBuffer
&
body
)
const
;
private
:
uint8_t
content_type_
;
uint64_t
sequence_number_
;
}
;
class
TlsRecordFilter
:
public
PacketFilter
{
public
:
TlsRecordFilter
(
)
:
agent_
(
nullptr
)
count_
(
0
)
cipher_spec_
(
)
{
}
void
SetAgent
(
const
TlsAgent
*
agent
)
{
agent_
=
agent
;
}
const
TlsAgent
*
agent
(
)
const
{
return
agent_
;
}
PacketFilter
:
:
Action
Filter
(
const
DataBuffer
&
input
DataBuffer
*
output
)
;
size_t
filtered_packets
(
)
const
{
return
count_
;
}
void
EnableDecryption
(
)
;
bool
Unprotect
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
cipherText
uint8_t
*
inner_content_type
DataBuffer
*
plaintext
)
;
bool
Protect
(
const
TlsRecordHeader
&
header
uint8_t
inner_content_type
const
DataBuffer
&
plaintext
DataBuffer
*
ciphertext
)
;
protected
:
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
record
size_t
*
offset
DataBuffer
*
output
)
;
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
data
DataBuffer
*
changed
)
{
return
KEEP
;
}
private
:
static
void
CipherSpecChanged
(
void
*
arg
PRBool
sending
ssl3CipherSpec
*
newSpec
)
;
const
TlsAgent
*
agent_
;
size_t
count_
;
std
:
:
unique_ptr
<
TlsCipherSpec
>
cipher_spec_
;
}
;
inline
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
stream
TlsVersioned
v
)
{
v
.
WriteStream
(
stream
)
;
return
stream
;
}
inline
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
stream
TlsRecordHeader
&
hdr
)
{
hdr
.
WriteStream
(
stream
)
;
stream
<
<
'
'
;
switch
(
hdr
.
content_type
(
)
)
{
case
kTlsChangeCipherSpecType
:
stream
<
<
"
CCS
"
;
break
;
case
kTlsAlertType
:
stream
<
<
"
Alert
"
;
break
;
case
kTlsHandshakeType
:
stream
<
<
"
Handshake
"
;
break
;
case
kTlsApplicationDataType
:
stream
<
<
"
Data
"
;
break
;
default
:
stream
<
<
'
<
'
<
<
hdr
.
content_type
(
)
<
<
'
>
'
;
break
;
}
return
stream
<
<
'
'
<
<
std
:
:
hex
<
<
hdr
.
sequence_number
(
)
<
<
std
:
:
dec
;
}
class
TlsHandshakeFilter
:
public
TlsRecordFilter
{
public
:
TlsHandshakeFilter
(
)
{
}
class
HandshakeHeader
:
public
TlsVersioned
{
public
:
HandshakeHeader
(
)
:
TlsVersioned
(
)
handshake_type_
(
0
)
message_seq_
(
0
)
{
}
uint8_t
handshake_type
(
)
const
{
return
handshake_type_
;
}
bool
Parse
(
TlsParser
*
parser
const
TlsRecordHeader
&
record_header
DataBuffer
*
body
)
;
size_t
Write
(
DataBuffer
*
buffer
size_t
offset
const
DataBuffer
&
body
)
const
;
size_t
WriteFragment
(
DataBuffer
*
buffer
size_t
offset
const
DataBuffer
&
body
size_t
fragment_offset
size_t
fragment_length
)
const
;
private
:
bool
ReadLength
(
TlsParser
*
parser
const
TlsRecordHeader
&
header
uint32_t
*
length
)
;
uint8_t
handshake_type_
;
uint16_t
message_seq_
;
}
;
protected
:
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
;
virtual
PacketFilter
:
:
Action
FilterHandshake
(
const
HandshakeHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
=
0
;
private
:
}
;
class
TlsInspectorRecordHandshakeMessage
:
public
TlsHandshakeFilter
{
public
:
TlsInspectorRecordHandshakeMessage
(
uint8_t
handshake_type
)
:
handshake_type_
(
handshake_type
)
buffer_
(
)
{
}
virtual
PacketFilter
:
:
Action
FilterHandshake
(
const
HandshakeHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
;
const
DataBuffer
&
buffer
(
)
const
{
return
buffer_
;
}
private
:
uint8_t
handshake_type_
;
DataBuffer
buffer_
;
}
;
class
TlsInspectorReplaceHandshakeMessage
:
public
TlsHandshakeFilter
{
public
:
TlsInspectorReplaceHandshakeMessage
(
uint8_t
handshake_type
const
DataBuffer
&
replacement
)
:
handshake_type_
(
handshake_type
)
buffer_
(
replacement
)
{
}
virtual
PacketFilter
:
:
Action
FilterHandshake
(
const
HandshakeHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
;
private
:
uint8_t
handshake_type_
;
DataBuffer
buffer_
;
}
;
class
TlsConversationRecorder
:
public
TlsRecordFilter
{
public
:
TlsConversationRecorder
(
DataBuffer
&
buffer
)
:
buffer_
(
buffer
)
{
}
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
;
private
:
DataBuffer
&
buffer_
;
}
;
class
TlsAlertRecorder
:
public
TlsRecordFilter
{
public
:
TlsAlertRecorder
(
)
:
level_
(
255
)
description_
(
255
)
{
}
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
;
uint8_t
level
(
)
const
{
return
level_
;
}
uint8_t
description
(
)
const
{
return
description_
;
}
private
:
uint8_t
level_
;
uint8_t
description_
;
}
;
class
ChainedPacketFilter
:
public
PacketFilter
{
public
:
ChainedPacketFilter
(
)
{
}
ChainedPacketFilter
(
const
std
:
:
vector
<
std
:
:
shared_ptr
<
PacketFilter
>
>
filters
)
:
filters_
(
filters
.
begin
(
)
filters
.
end
(
)
)
{
}
virtual
~
ChainedPacketFilter
(
)
{
}
virtual
PacketFilter
:
:
Action
Filter
(
const
DataBuffer
&
input
DataBuffer
*
output
)
;
void
Add
(
std
:
:
shared_ptr
<
PacketFilter
>
filter
)
{
filters_
.
push_back
(
filter
)
;
}
private
:
std
:
:
vector
<
std
:
:
shared_ptr
<
PacketFilter
>
>
filters_
;
}
;
class
TlsExtensionFilter
:
public
TlsHandshakeFilter
{
protected
:
PacketFilter
:
:
Action
FilterHandshake
(
const
HandshakeHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
override
;
virtual
PacketFilter
:
:
Action
FilterExtension
(
uint16_t
extension_type
const
DataBuffer
&
input
DataBuffer
*
output
)
=
0
;
public
:
static
bool
FindClientHelloExtensions
(
TlsParser
*
parser
const
TlsVersioned
&
header
)
;
static
bool
FindServerHelloExtensions
(
TlsParser
*
parser
)
;
private
:
PacketFilter
:
:
Action
FilterExtensions
(
TlsParser
*
parser
const
DataBuffer
&
input
DataBuffer
*
output
)
;
}
;
class
TlsExtensionCapture
:
public
TlsExtensionFilter
{
public
:
TlsExtensionCapture
(
uint16_t
ext
bool
last
=
false
)
:
extension_
(
ext
)
captured_
(
false
)
last_
(
last
)
data_
(
)
{
}
const
DataBuffer
&
extension
(
)
const
{
return
data_
;
}
bool
captured
(
)
const
{
return
captured_
;
}
protected
:
PacketFilter
:
:
Action
FilterExtension
(
uint16_t
extension_type
const
DataBuffer
&
input
DataBuffer
*
output
)
override
;
private
:
const
uint16_t
extension_
;
bool
captured_
;
bool
last_
;
DataBuffer
data_
;
}
;
class
TlsExtensionReplacer
:
public
TlsExtensionFilter
{
public
:
TlsExtensionReplacer
(
uint16_t
extension
const
DataBuffer
&
data
)
:
extension_
(
extension
)
data_
(
data
)
{
}
PacketFilter
:
:
Action
FilterExtension
(
uint16_t
extension_type
const
DataBuffer
&
input
DataBuffer
*
output
)
override
;
private
:
const
uint16_t
extension_
;
const
DataBuffer
data_
;
}
;
class
TlsExtensionDropper
:
public
TlsExtensionFilter
{
public
:
TlsExtensionDropper
(
uint16_t
extension
)
:
extension_
(
extension
)
{
}
PacketFilter
:
:
Action
FilterExtension
(
uint16_t
extension_type
const
DataBuffer
&
DataBuffer
*
)
override
;
private
:
uint16_t
extension_
;
}
;
class
TlsAgent
;
typedef
std
:
:
function
<
void
(
void
)
>
VoidFunction
;
class
AfterRecordN
:
public
TlsRecordFilter
{
public
:
AfterRecordN
(
std
:
:
shared_ptr
<
TlsAgent
>
&
src
std
:
:
shared_ptr
<
TlsAgent
>
&
dest
unsigned
int
record
VoidFunction
func
)
:
src_
(
src
)
dest_
(
dest
)
record_
(
record
)
func_
(
func
)
counter_
(
0
)
{
}
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
body
DataBuffer
*
out
)
override
;
private
:
std
:
:
weak_ptr
<
TlsAgent
>
src_
;
std
:
:
weak_ptr
<
TlsAgent
>
dest_
;
unsigned
int
record_
;
VoidFunction
func_
;
unsigned
int
counter_
;
}
;
class
TlsInspectorClientHelloVersionChanger
:
public
TlsHandshakeFilter
{
public
:
TlsInspectorClientHelloVersionChanger
(
std
:
:
shared_ptr
<
TlsAgent
>
&
server
)
:
server_
(
server
)
{
}
virtual
PacketFilter
:
:
Action
FilterHandshake
(
const
HandshakeHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
;
private
:
std
:
:
weak_ptr
<
TlsAgent
>
server_
;
}
;
class
SelectiveDropFilter
:
public
PacketFilter
{
public
:
SelectiveDropFilter
(
uint32_t
pattern
)
:
pattern_
(
pattern
)
counter_
(
0
)
{
}
protected
:
virtual
PacketFilter
:
:
Action
Filter
(
const
DataBuffer
&
input
DataBuffer
*
output
)
override
;
private
:
const
uint32_t
pattern_
;
uint8_t
counter_
;
}
;
class
TlsInspectorClientHelloVersionSetter
:
public
TlsHandshakeFilter
{
public
:
TlsInspectorClientHelloVersionSetter
(
uint16_t
version
)
:
version_
(
version
)
{
}
virtual
PacketFilter
:
:
Action
FilterHandshake
(
const
HandshakeHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
;
private
:
uint16_t
version_
;
}
;
}
#
endif
