#
include
"
blapi
.
h
"
#
include
"
ssl
.
h
"
#
include
"
sslimpl
.
h
"
#
include
"
tls_connect
.
h
"
#
include
"
gtest
/
gtest
.
h
"
namespace
nss_test
{
#
ifdef
UNSAFE_FUZZER_MODE
#
define
FUZZ_F
(
c
f
)
TEST_F
(
c
Fuzz_
#
#
f
)
#
define
FUZZ_P
(
c
f
)
TEST_P
(
c
Fuzz_
#
#
f
)
#
else
#
define
FUZZ_F
(
c
f
)
TEST_F
(
c
DISABLED_Fuzz_
#
#
f
)
#
define
FUZZ_P
(
c
f
)
TEST_P
(
c
DISABLED_Fuzz_
#
#
f
)
#
endif
const
uint8_t
kShortEmptyFinished
[
8
]
=
{
0
}
;
const
uint8_t
kLongEmptyFinished
[
128
]
=
{
0
}
;
class
TlsFuzzTest
:
public
:
:
testing
:
:
Test
{
}
;
class
TlsApplicationDataRecorder
:
public
TlsRecordFilter
{
public
:
TlsApplicationDataRecorder
(
)
:
buffer_
(
)
{
}
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
TlsRecordHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
{
if
(
header
.
content_type
(
)
=
=
kTlsApplicationDataType
)
{
buffer_
.
Append
(
input
)
;
}
return
KEEP
;
}
const
DataBuffer
&
buffer
(
)
const
{
return
buffer_
;
}
private
:
DataBuffer
buffer_
;
}
;
class
TlsSignatureDamager
:
public
TlsHandshakeFilter
{
public
:
TlsSignatureDamager
(
uint8_t
type
)
:
type_
(
type
)
{
}
virtual
PacketFilter
:
:
Action
FilterHandshake
(
const
TlsHandshakeFilter
:
:
HandshakeHeader
&
header
const
DataBuffer
&
input
DataBuffer
*
output
)
{
if
(
header
.
handshake_type
(
)
!
=
type_
)
{
return
KEEP
;
}
*
output
=
input
;
output
-
>
data
(
)
[
output
-
>
len
(
)
-
1
]
+
+
;
return
CHANGE
;
}
private
:
uint8_t
type_
;
}
;
FUZZ_F
(
TlsFuzzTest
SSL_Time_Constant
)
{
PRUint32
now
=
ssl_Time
(
)
;
PR_Sleep
(
PR_SecondsToInterval
(
2
)
)
;
EXPECT_EQ
(
ssl_Time
(
)
now
)
;
}
FUZZ_P
(
TlsConnectGeneric
DeterministicExporter
)
{
const
char
kLabel
[
]
=
"
label
"
;
std
:
:
vector
<
unsigned
char
>
out1
(
32
)
out2
(
32
)
;
Connect
(
)
;
Reset
(
)
;
ConfigureSessionCache
(
RESUME_NONE
RESUME_NONE
)
;
DisableECDHEServerKeyReuse
(
)
;
EXPECT_EQ
(
SECSuccess
RNG_RandomUpdate
(
NULL
0
)
)
;
Connect
(
)
;
SECStatus
rv
=
SSL_ExportKeyingMaterial
(
client_
-
>
ssl_fd
(
)
kLabel
strlen
(
kLabel
)
false
NULL
0
out1
.
data
(
)
out1
.
size
(
)
)
;
EXPECT_EQ
(
SECSuccess
rv
)
;
Reset
(
)
;
ConfigureSessionCache
(
RESUME_NONE
RESUME_NONE
)
;
DisableECDHEServerKeyReuse
(
)
;
EXPECT_EQ
(
SECSuccess
RNG_RandomUpdate
(
NULL
0
)
)
;
Connect
(
)
;
rv
=
SSL_ExportKeyingMaterial
(
client_
-
>
ssl_fd
(
)
kLabel
strlen
(
kLabel
)
false
NULL
0
out2
.
data
(
)
out2
.
size
(
)
)
;
EXPECT_EQ
(
SECSuccess
rv
)
;
EXPECT_EQ
(
out1
out2
)
;
}
FUZZ_P
(
TlsConnectGeneric
DeterministicTranscript
)
{
Connect
(
)
;
DataBuffer
last
;
for
(
size_t
i
=
0
;
i
<
5
;
i
+
+
)
{
Reset
(
)
;
ConfigureSessionCache
(
RESUME_NONE
RESUME_NONE
)
;
DisableECDHEServerKeyReuse
(
)
;
DataBuffer
buffer
;
client_
-
>
SetPacketFilter
(
std
:
:
make_shared
<
TlsConversationRecorder
>
(
buffer
)
)
;
server_
-
>
SetPacketFilter
(
std
:
:
make_shared
<
TlsConversationRecorder
>
(
buffer
)
)
;
EXPECT_EQ
(
SECSuccess
RNG_RandomUpdate
(
NULL
0
)
)
;
Connect
(
)
;
client_
-
>
DeletePacketFilter
(
)
;
server_
-
>
DeletePacketFilter
(
)
;
if
(
last
.
len
(
)
>
0
)
{
EXPECT_EQ
(
last
buffer
)
;
}
last
=
buffer
;
}
}
FUZZ_P
(
TlsConnectGeneric
ConnectSendReceive_NullCipher
)
{
EnsureTlsSetup
(
)
;
auto
client_recorder
=
std
:
:
make_shared
<
TlsApplicationDataRecorder
>
(
)
;
client_
-
>
SetPacketFilter
(
client_recorder
)
;
auto
server_recorder
=
std
:
:
make_shared
<
TlsApplicationDataRecorder
>
(
)
;
server_
-
>
SetPacketFilter
(
server_recorder
)
;
Connect
(
)
;
DataBuffer
buf
;
buf
.
Allocate
(
50
)
;
for
(
size_t
i
=
0
;
i
<
buf
.
len
(
)
;
+
+
i
)
{
buf
.
data
(
)
[
i
]
=
i
&
0xff
;
}
client_
-
>
SendBuffer
(
buf
)
;
server_
-
>
SendBuffer
(
buf
)
;
Receive
(
buf
.
len
(
)
)
;
EXPECT_EQ
(
buf
client_recorder
-
>
buffer
(
)
)
;
EXPECT_EQ
(
buf
server_recorder
-
>
buffer
(
)
)
;
}
FUZZ_P
(
TlsConnectGeneric
BogusClientFinished
)
{
EnsureTlsSetup
(
)
;
auto
i1
=
std
:
:
make_shared
<
TlsInspectorReplaceHandshakeMessage
>
(
kTlsHandshakeFinished
DataBuffer
(
kShortEmptyFinished
sizeof
(
kShortEmptyFinished
)
)
)
;
client_
-
>
SetPacketFilter
(
i1
)
;
Connect
(
)
;
SendReceive
(
)
;
}
FUZZ_P
(
TlsConnectGeneric
BogusServerFinished
)
{
EnsureTlsSetup
(
)
;
auto
i1
=
std
:
:
make_shared
<
TlsInspectorReplaceHandshakeMessage
>
(
kTlsHandshakeFinished
DataBuffer
(
kLongEmptyFinished
sizeof
(
kLongEmptyFinished
)
)
)
;
server_
-
>
SetPacketFilter
(
i1
)
;
Connect
(
)
;
SendReceive
(
)
;
}
FUZZ_P
(
TlsConnectGeneric
BogusServerAuthSignature
)
{
EnsureTlsSetup
(
)
;
uint8_t
msg_type
=
version_
=
=
SSL_LIBRARY_VERSION_TLS_1_3
?
kTlsHandshakeCertificateVerify
:
kTlsHandshakeServerKeyExchange
;
server_
-
>
SetPacketFilter
(
std
:
:
make_shared
<
TlsSignatureDamager
>
(
msg_type
)
)
;
Connect
(
)
;
SendReceive
(
)
;
}
FUZZ_P
(
TlsConnectGeneric
BogusClientAuthSignature
)
{
EnsureTlsSetup
(
)
;
client_
-
>
SetupClientAuth
(
)
;
server_
-
>
RequestClientAuth
(
true
)
;
client_
-
>
SetPacketFilter
(
std
:
:
make_shared
<
TlsSignatureDamager
>
(
kTlsHandshakeCertificateVerify
)
)
;
Connect
(
)
;
}
FUZZ_P
(
TlsConnectGeneric
SessionTicketResumption
)
{
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
Connect
(
)
;
SendReceive
(
)
;
Reset
(
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
ExpectResumption
(
RESUME_TICKET
)
;
Connect
(
)
;
SendReceive
(
)
;
}
class
TlsSessionTicketMacDamager
:
public
TlsExtensionFilter
{
public
:
TlsSessionTicketMacDamager
(
)
{
}
virtual
PacketFilter
:
:
Action
FilterExtension
(
uint16_t
extension_type
const
DataBuffer
&
input
DataBuffer
*
output
)
{
if
(
extension_type
!
=
ssl_session_ticket_xtn
&
&
extension_type
!
=
ssl_tls13_pre_shared_key_xtn
)
{
return
KEEP
;
}
*
output
=
input
;
if
(
extension_type
=
=
ssl_session_ticket_xtn
)
{
output
-
>
data
(
)
[
output
-
>
len
(
)
-
1
]
^
=
0xff
;
}
if
(
extension_type
=
=
ssl_tls13_pre_shared_key_xtn
)
{
TlsParser
parser
(
input
)
;
uint32_t
ids_len
;
EXPECT_TRUE
(
parser
.
Read
(
&
ids_len
2
)
&
&
ids_len
>
0
)
;
uint32_t
ticket_len
;
EXPECT_TRUE
(
parser
.
Read
(
&
ticket_len
2
)
&
&
ticket_len
>
0
)
;
output
-
>
data
(
)
[
2
+
2
+
ticket_len
-
1
]
^
=
0xff
;
}
return
CHANGE
;
}
}
;
FUZZ_P
(
TlsConnectGeneric
SessionTicketResumptionBadMac
)
{
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
Connect
(
)
;
SendReceive
(
)
;
Reset
(
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
SetPacketFilter
(
std
:
:
make_shared
<
TlsSessionTicketMacDamager
>
(
)
)
;
Connect
(
)
;
SendReceive
(
)
;
}
FUZZ_P
(
TlsConnectGeneric
UnencryptedSessionTickets
)
{
ConfigureSessionCache
(
RESUME_TICKET
RESUME_TICKET
)
;
auto
i1
=
std
:
:
make_shared
<
TlsInspectorRecordHandshakeMessage
>
(
kTlsHandshakeNewSessionTicket
)
;
server_
-
>
SetPacketFilter
(
i1
)
;
Connect
(
)
;
size_t
offset
=
4
;
if
(
version_
=
=
SSL_LIBRARY_VERSION_TLS_1_3
)
{
offset
+
=
1
+
1
+
1
+
1
;
}
offset
+
=
2
+
16
+
16
+
2
+
2
;
uint32_t
tls_version
=
0
;
EXPECT_TRUE
(
i1
-
>
buffer
(
)
.
Read
(
offset
sizeof
(
version_
)
&
tls_version
)
)
;
EXPECT_EQ
(
version_
static_cast
<
decltype
(
version_
)
>
(
tls_version
)
)
;
uint32_t
suite
=
0
;
EXPECT_TRUE
(
i1
-
>
buffer
(
)
.
Read
(
offset
+
sizeof
(
version_
)
2
&
suite
)
)
;
client_
-
>
CheckCipherSuite
(
static_cast
<
uint16_t
>
(
suite
)
)
;
}
}
