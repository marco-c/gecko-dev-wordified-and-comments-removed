#
include
<
functional
>
#
include
<
memory
>
#
include
"
secerr
.
h
"
#
include
"
ssl
.
h
"
#
include
"
sslerr
.
h
"
#
include
"
sslproto
.
h
"
#
include
"
gtest_utils
.
h
"
#
include
"
tls_connect
.
h
"
namespace
nss_test
{
TEST_P
(
TlsConnectStreamPre13
RenegotiateClient
)
{
Connect
(
)
;
server_
-
>
PrepareForRenegotiate
(
)
;
client_
-
>
StartRenegotiate
(
)
;
Handshake
(
)
;
CheckConnected
(
)
;
}
TEST_P
(
TlsConnectStreamPre13
RenegotiateServer
)
{
Connect
(
)
;
client_
-
>
PrepareForRenegotiate
(
)
;
server_
-
>
StartRenegotiate
(
)
;
Handshake
(
)
;
CheckConnected
(
)
;
}
TEST_F
(
TlsConnectTest
RenegotiationConfigTls13
)
{
EnsureTlsSetup
(
)
;
ConfigureVersion
(
SSL_LIBRARY_VERSION_TLS_1_3
)
;
server_
-
>
SetOption
(
SSL_ENABLE_RENEGOTIATION
SSL_RENEGOTIATE_UNRESTRICTED
)
;
server_
-
>
SetOption
(
SSL_REQUIRE_SAFE_NEGOTIATION
PR_TRUE
)
;
Connect
(
)
;
SendReceive
(
)
;
CheckKeys
(
)
;
}
TEST_P
(
TlsConnectStream
ConnectTls10AndServerRenegotiateHigher
)
{
if
(
version_
=
=
SSL_LIBRARY_VERSION_TLS_1_0
)
{
return
;
}
client_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_0
version_
)
;
server_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_0
SSL_LIBRARY_VERSION_TLS_1_0
)
;
uint16_t
test_version
=
version_
;
version_
=
SSL_LIBRARY_VERSION_TLS_1_0
;
Connect
(
)
;
client_
-
>
PrepareForRenegotiate
(
)
;
server_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_0
test_version
)
;
server_
-
>
ResetPreliminaryInfo
(
)
;
server_
-
>
StartRenegotiate
(
)
;
if
(
test_version
>
=
SSL_LIBRARY_VERSION_TLS_1_3
)
{
ExpectAlert
(
server_
kTlsAlertUnexpectedMessage
)
;
}
else
{
ExpectAlert
(
client_
kTlsAlertIllegalParameter
)
;
}
Handshake
(
)
;
if
(
test_version
>
=
SSL_LIBRARY_VERSION_TLS_1_3
)
{
client_
-
>
CheckErrorCode
(
SSL_ERROR_HANDSHAKE_UNEXPECTED_ALERT
)
;
server_
-
>
CheckErrorCode
(
SSL_ERROR_RENEGOTIATION_NOT_ALLOWED
)
;
}
else
{
client_
-
>
CheckErrorCode
(
SSL_ERROR_UNSUPPORTED_VERSION
)
;
server_
-
>
CheckErrorCode
(
SSL_ERROR_ILLEGAL_PARAMETER_ALERT
)
;
}
}
TEST_P
(
TlsConnectStream
ConnectTls10AndClientRenegotiateHigher
)
{
if
(
version_
=
=
SSL_LIBRARY_VERSION_TLS_1_0
)
{
return
;
}
client_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_0
version_
)
;
server_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_0
SSL_LIBRARY_VERSION_TLS_1_0
)
;
uint16_t
test_version
=
version_
;
version_
=
SSL_LIBRARY_VERSION_TLS_1_0
;
Connect
(
)
;
server_
-
>
PrepareForRenegotiate
(
)
;
server_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_0
test_version
)
;
server_
-
>
ResetPreliminaryInfo
(
)
;
client_
-
>
StartRenegotiate
(
)
;
if
(
test_version
>
=
SSL_LIBRARY_VERSION_TLS_1_3
)
{
ExpectAlert
(
server_
kTlsAlertUnexpectedMessage
)
;
}
else
{
ExpectAlert
(
client_
kTlsAlertIllegalParameter
)
;
}
Handshake
(
)
;
if
(
test_version
>
=
SSL_LIBRARY_VERSION_TLS_1_3
)
{
client_
-
>
CheckErrorCode
(
SSL_ERROR_HANDSHAKE_UNEXPECTED_ALERT
)
;
server_
-
>
CheckErrorCode
(
SSL_ERROR_RENEGOTIATION_NOT_ALLOWED
)
;
}
else
{
client_
-
>
CheckErrorCode
(
SSL_ERROR_UNSUPPORTED_VERSION
)
;
server_
-
>
CheckErrorCode
(
SSL_ERROR_ILLEGAL_PARAMETER_ALERT
)
;
}
}
TEST_F
(
TlsConnectTest
Tls13RejectsRehandshakeClient
)
{
EnsureTlsSetup
(
)
;
ConfigureVersion
(
SSL_LIBRARY_VERSION_TLS_1_3
)
;
Connect
(
)
;
SECStatus
rv
=
SSL_ReHandshake
(
client_
-
>
ssl_fd
(
)
PR_TRUE
)
;
EXPECT_EQ
(
SECFailure
rv
)
;
EXPECT_EQ
(
SSL_ERROR_RENEGOTIATION_NOT_ALLOWED
PORT_GetError
(
)
)
;
}
TEST_F
(
TlsConnectTest
Tls13RejectsRehandshakeServer
)
{
EnsureTlsSetup
(
)
;
ConfigureVersion
(
SSL_LIBRARY_VERSION_TLS_1_3
)
;
Connect
(
)
;
SECStatus
rv
=
SSL_ReHandshake
(
server_
-
>
ssl_fd
(
)
PR_TRUE
)
;
EXPECT_EQ
(
SECFailure
rv
)
;
EXPECT_EQ
(
SSL_ERROR_RENEGOTIATION_NOT_ALLOWED
PORT_GetError
(
)
)
;
}
}
