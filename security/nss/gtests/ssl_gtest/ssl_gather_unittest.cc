#
include
"
gtest_utils
.
h
"
#
include
"
tls_connect
.
h
"
namespace
nss_test
{
class
GatherV2ClientHelloTest
:
public
TlsConnectTestBase
{
public
:
GatherV2ClientHelloTest
(
)
:
TlsConnectTestBase
(
STREAM
0
)
{
}
void
ConnectExpectMalformedClientHello
(
const
DataBuffer
&
data
)
{
EnsureTlsSetup
(
)
;
auto
alert_recorder
=
std
:
:
make_shared
<
TlsAlertRecorder
>
(
)
;
server_
-
>
SetPacketFilter
(
alert_recorder
)
;
client_
-
>
SendDirect
(
data
)
;
server_
-
>
StartConnect
(
)
;
server_
-
>
Handshake
(
)
;
ASSERT_TRUE_WAIT
(
(
server_
-
>
error_code
(
)
=
=
SSL_ERROR_RX_MALFORMED_CLIENT_HELLO
)
2000
)
;
EXPECT_EQ
(
kTlsAlertFatal
alert_recorder
-
>
level
(
)
)
;
EXPECT_EQ
(
illegal_parameter
alert_recorder
-
>
description
(
)
)
;
}
}
;
TEST_F
(
TlsConnectTest
GatherEmptyV3Record
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x16
1
)
;
idx
=
buffer
.
Write
(
idx
0x0301
2
)
;
(
void
)
buffer
.
Write
(
idx
0U
2
)
;
EnsureTlsSetup
(
)
;
client_
-
>
SendDirect
(
buffer
)
;
Connect
(
)
;
}
TEST_F
(
TlsConnectTest
GatherExcessiveV3Record
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x16
1
)
;
idx
=
buffer
.
Write
(
idx
0x0301
2
)
;
(
void
)
buffer
.
Write
(
idx
MAX_FRAGMENT_LENGTH
+
2048
+
1
2
)
;
EnsureTlsSetup
(
)
;
auto
alert_recorder
=
std
:
:
make_shared
<
TlsAlertRecorder
>
(
)
;
server_
-
>
SetPacketFilter
(
alert_recorder
)
;
client_
-
>
SendDirect
(
buffer
)
;
server_
-
>
StartConnect
(
)
;
server_
-
>
Handshake
(
)
;
ASSERT_TRUE_WAIT
(
(
server_
-
>
error_code
(
)
=
=
SSL_ERROR_RX_RECORD_TOO_LONG
)
2000
)
;
EXPECT_EQ
(
kTlsAlertFatal
alert_recorder
-
>
level
(
)
)
;
EXPECT_EQ
(
record_overflow
alert_recorder
-
>
description
(
)
)
;
}
TEST_F
(
GatherV2ClientHelloTest
GatherV2RecordLongHeader
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x0002
2
)
;
idx
=
buffer
.
Write
(
idx
0U
1
)
;
(
void
)
buffer
.
Write
(
idx
0U
2
)
;
ConnectExpectMalformedClientHello
(
buffer
)
;
}
TEST_F
(
GatherV2ClientHelloTest
GatherV2RecordLongHeader2
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x0001
2
)
;
idx
=
buffer
.
Write
(
idx
0U
1
)
;
idx
=
buffer
.
Write
(
idx
0U
1
)
;
(
void
)
buffer
.
Write
(
idx
0U
1
)
;
ConnectExpectMalformedClientHello
(
buffer
)
;
}
TEST_F
(
GatherV2ClientHelloTest
GatherEmptyV2RecordLongHeader
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0U
2
)
;
idx
=
buffer
.
Write
(
idx
0U
1
)
;
(
void
)
buffer
.
Write
(
idx
0U
2
)
;
ConnectExpectMalformedClientHello
(
buffer
)
;
}
TEST_F
(
GatherV2ClientHelloTest
GatherV2RecordShortHeader
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x8003
2
)
;
(
void
)
buffer
.
Write
(
idx
0U
3
)
;
ConnectExpectMalformedClientHello
(
buffer
)
;
}
TEST_F
(
GatherV2ClientHelloTest
GatherEmptyV2RecordShortHeader2
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x8002
2
)
;
idx
=
buffer
.
Write
(
idx
0U
2
)
;
(
void
)
buffer
.
Write
(
idx
0U
1
)
;
ConnectExpectMalformedClientHello
(
buffer
)
;
}
TEST_F
(
GatherV2ClientHelloTest
GatherEmptyV2RecordShortHeader3
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x8001
2
)
;
idx
=
buffer
.
Write
(
idx
0U
1
)
;
(
void
)
buffer
.
Write
(
idx
0U
2
)
;
ConnectExpectMalformedClientHello
(
buffer
)
;
}
TEST_F
(
GatherV2ClientHelloTest
GatherEmptyV2RecordShortHeader
)
{
DataBuffer
buffer
;
size_t
idx
=
0
;
idx
=
buffer
.
Write
(
idx
0x8000
2
)
;
(
void
)
buffer
.
Write
(
idx
0U
3
)
;
ConnectExpectMalformedClientHello
(
buffer
)
;
}
}
