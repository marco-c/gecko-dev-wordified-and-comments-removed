#
include
"
secerr
.
h
"
#
include
"
ssl
.
h
"
#
include
"
sslerr
.
h
"
#
include
"
sslexp
.
h
"
#
include
"
sslproto
.
h
"
extern
"
C
"
{
#
include
"
libssl_internals
.
h
"
}
#
include
"
gtest_utils
.
h
"
#
include
"
nss_scoped_ptrs
.
h
"
#
include
"
tls_connect
.
h
"
#
include
"
tls_filter
.
h
"
#
include
"
tls_parser
.
h
"
namespace
nss_test
{
TEST_P
(
TlsConnectTls13
ZeroRtt
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
true
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttServerRejectByOption
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
false
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttApplicationReject
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
auto
reject_0rtt
=
[
]
(
PRBool
firstHello
const
PRUint8
*
clientToken
unsigned
int
clientTokenLen
PRUint8
*
appToken
unsigned
int
*
appTokenLen
unsigned
int
appTokenMax
void
*
arg
)
{
auto
*
called
=
reinterpret_cast
<
bool
*
>
(
arg
)
;
*
called
=
true
;
EXPECT_TRUE
(
firstHello
)
;
EXPECT_EQ
(
0U
clientTokenLen
)
;
return
ssl_hello_retry_reject_0rtt
;
}
;
bool
cb_run
=
false
;
EXPECT_EQ
(
SECSuccess
SSL_HelloRetryRequestCallback
(
server_
-
>
ssl_fd
(
)
reject_0rtt
&
cb_run
)
)
;
ZeroRttSendReceive
(
true
false
)
;
Handshake
(
)
;
EXPECT_TRUE
(
cb_run
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttApparentReplayAfterRestart
)
{
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
ConfigureVersion
(
SSL_LIBRARY_VERSION_TLS_1_3
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
Connect
(
)
;
SendReceive
(
)
;
CheckKeys
(
)
;
Reset
(
)
;
StartConnect
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
false
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
class
TlsZeroRttReplayTest
:
public
TlsConnectTls13
{
private
:
class
SaveFirstPacket
:
public
PacketFilter
{
public
:
PacketFilter
:
:
Action
Filter
(
const
DataBuffer
&
input
DataBuffer
*
output
)
override
{
if
(
!
packet_
.
len
(
)
&
&
input
.
len
(
)
)
{
packet_
=
input
;
}
return
KEEP
;
}
const
DataBuffer
&
packet
(
)
const
{
return
packet_
;
}
private
:
DataBuffer
packet_
;
}
;
protected
:
void
RunTest
(
bool
rollover
)
{
SetupForZeroRtt
(
)
;
auto
first_packet
=
std
:
:
make_shared
<
SaveFirstPacket
>
(
)
;
client_
-
>
SetFilter
(
first_packet
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
true
)
;
Handshake
(
)
;
EXPECT_LT
(
0U
first_packet
-
>
packet
(
)
.
len
(
)
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
if
(
rollover
)
{
RolloverAntiReplay
(
)
;
}
Reset
(
)
;
server_
-
>
StartConnect
(
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
auto
early_data_ext
=
MakeTlsFilter
<
TlsExtensionCapture
>
(
server_
ssl_tls13_early_data_xtn
)
;
server_
-
>
adapter
(
)
-
>
PacketReceived
(
first_packet
-
>
packet
(
)
)
;
server_
-
>
Handshake
(
)
;
EXPECT_FALSE
(
early_data_ext
-
>
captured
(
)
)
;
}
}
;
TEST_P
(
TlsZeroRttReplayTest
ZeroRttReplay
)
{
RunTest
(
false
)
;
}
TEST_P
(
TlsZeroRttReplayTest
ZeroRttReplayAfterRollover
)
{
RunTest
(
true
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttOptionsSetLate
)
{
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
Connect
(
)
;
SendReceive
(
)
;
CheckKeys
(
ssl_kea_ecdh
ssl_auth_rsa_sign
)
;
Reset
(
)
;
StartConnect
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
false
false
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttServerForgetTicket
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ClearServerCache
(
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
ExpectResumption
(
RESUME_NONE
)
;
ZeroRttSendReceive
(
true
false
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttServerOnly
)
{
ExpectResumption
(
RESUME_NONE
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
StartConnect
(
)
;
client_
-
>
Handshake
(
)
;
uint8_t
buf
[
100
]
;
PRInt32
rv
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buf
sizeof
(
buf
)
)
;
EXPECT_EQ
(
SECFailure
rv
)
;
EXPECT_EQ
(
PR_WOULD_BLOCK_ERROR
PORT_GetError
(
)
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
CheckKeys
(
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttRejectOldTicket
)
{
static
const
PRTime
kWindow
=
10
*
PR_USEC_PER_SEC
;
ResetAntiReplay
(
kWindow
)
;
SetupForZeroRtt
(
)
;
Reset
(
)
;
StartConnect
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
false
[
this
]
(
)
{
AdvanceTime
(
1
+
kWindow
/
2
)
;
return
true
;
}
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
false
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
ZeroRttRejectPrematureTicket
)
{
static
const
PRTime
kWindow
=
10
*
PR_USEC_PER_SEC
;
ResetAntiReplay
(
kWindow
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
ConfigureVersion
(
SSL_LIBRARY_VERSION_TLS_1_3
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
StartConnect
(
)
;
client_
-
>
Handshake
(
)
;
server_
-
>
Handshake
(
)
;
AdvanceTime
(
1
+
kWindow
/
2
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
CheckKeys
(
)
;
Reset
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ExpectEarlyDataAccepted
(
false
)
;
StartConnect
(
)
;
ZeroRttSendReceive
(
true
false
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
TestTls13ZeroRttAlpn
)
{
EnableAlpn
(
)
;
SetupForZeroRtt
(
)
;
EnableAlpn
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ExpectEarlyDataAccepted
(
true
)
;
ZeroRttSendReceive
(
true
true
[
this
]
(
)
{
client_
-
>
CheckAlpn
(
SSL_NEXT_PROTO_EARLY_VALUE
"
a
"
)
;
return
true
;
}
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
CheckAlpn
(
"
a
"
)
;
}
TEST_P
(
TlsConnectTls13
TestTls13ZeroRttAlpnChangeServer
)
{
EnableAlpn
(
)
;
SetupForZeroRtt
(
)
;
static
const
uint8_t
client_alpn
[
]
=
{
0x01
0x61
0x01
0x62
}
;
static
const
uint8_t
server_alpn
[
]
=
{
0x01
0x62
}
;
client_
-
>
EnableAlpn
(
client_alpn
sizeof
(
client_alpn
)
)
;
server_
-
>
EnableAlpn
(
server_alpn
sizeof
(
server_alpn
)
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
false
[
this
]
(
)
{
client_
-
>
CheckAlpn
(
SSL_NEXT_PROTO_EARLY_VALUE
"
a
"
)
;
return
true
;
}
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
CheckAlpn
(
"
b
"
)
;
}
TEST_P
(
TlsConnectTls13
TestTls13ZeroRttNoAlpnServer
)
{
EnableAlpn
(
)
;
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
EnableAlpn
(
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
true
[
this
]
(
)
{
PRUint8
b
[
]
=
{
'
b
'
}
;
client_
-
>
CheckAlpn
(
SSL_NEXT_PROTO_EARLY_VALUE
"
a
"
)
;
EXPECT_EQ
(
SECSuccess
SSLInt_Set0RttAlpn
(
client_
-
>
ssl_fd
(
)
b
sizeof
(
b
)
)
)
;
client_
-
>
CheckAlpn
(
SSL_NEXT_PROTO_EARLY_VALUE
"
b
"
)
;
client_
-
>
ExpectSendAlert
(
kTlsAlertIllegalParameter
)
;
return
true
;
}
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
server_
-
>
ExpectSendAlert
(
kTlsAlertBadRecordMac
)
;
Handshake
(
)
;
server_
-
>
CheckErrorCode
(
SSL_ERROR_BAD_MAC_READ
)
;
}
else
{
client_
-
>
Handshake
(
)
;
}
client_
-
>
CheckErrorCode
(
SSL_ERROR_NEXT_PROTOCOL_DATA_INVALID
)
;
}
TEST_P
(
TlsConnectTls13
TestTls13ZeroRttNoAlpnClient
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
true
[
this
]
(
)
{
PRUint8
b
[
]
=
{
'
b
'
}
;
EXPECT_EQ
(
SECSuccess
SSLInt_Set0RttAlpn
(
client_
-
>
ssl_fd
(
)
b
1
)
)
;
client_
-
>
CheckAlpn
(
SSL_NEXT_PROTO_EARLY_VALUE
"
b
"
)
;
client_
-
>
ExpectSendAlert
(
kTlsAlertIllegalParameter
)
;
return
true
;
}
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
server_
-
>
ExpectSendAlert
(
kTlsAlertBadRecordMac
)
;
Handshake
(
)
;
server_
-
>
CheckErrorCode
(
SSL_ERROR_BAD_MAC_READ
)
;
}
else
{
client_
-
>
Handshake
(
)
;
}
client_
-
>
CheckErrorCode
(
SSL_ERROR_NEXT_PROTOCOL_DATA_INVALID
)
;
}
TEST_P
(
TlsConnectTls13
TestTls13ZeroRttAlpnChangeBoth
)
{
EnableAlpn
(
)
;
SetupForZeroRtt
(
)
;
static
const
std
:
:
vector
<
uint8_t
>
alpn
(
{
0x01
0x62
}
)
;
EnableAlpn
(
alpn
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
false
[
this
]
(
)
{
client_
-
>
CheckAlpn
(
SSL_NEXT_PROTO_NO_SUPPORT
)
;
return
false
;
}
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
CheckAlpn
(
"
b
"
)
;
}
TEST_P
(
TlsConnectTls13
TestTls13ZeroRttDowngrade
)
{
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
Connect
(
)
;
SendReceive
(
)
;
CheckKeys
(
)
;
Reset
(
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
client_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_2
SSL_LIBRARY_VERSION_TLS_1_3
)
;
server_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_2
SSL_LIBRARY_VERSION_TLS_1_2
)
;
StartConnect
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
client_
-
>
ExpectSendAlert
(
kTlsAlertIllegalParameter
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
server_
-
>
ExpectSendAlert
(
kTlsAlertUnexpectedMessage
)
;
}
client_
-
>
Handshake
(
)
;
server_
-
>
Handshake
(
)
;
ASSERT_TRUE_WAIT
(
(
client_
-
>
error_code
(
)
=
=
SSL_ERROR_DOWNGRADE_WITH_EARLY_DATA
)
2000
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
ASSERT_TRUE_WAIT
(
(
server_
-
>
error_code
(
)
=
=
SSL_ERROR_RX_UNEXPECTED_APPLICATION_DATA
)
2000
)
;
}
}
TEST_P
(
TlsConnectTls13
TestTls13ZeroRttDowngradeEarlyData
)
{
const
char
*
k0RttData
=
"
ABCDEF
"
;
const
PRInt32
k0RttDataLen
=
static_cast
<
PRInt32
>
(
strlen
(
k0RttData
)
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
Connect
(
)
;
SendReceive
(
)
;
CheckKeys
(
)
;
Reset
(
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
client_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_2
SSL_LIBRARY_VERSION_TLS_1_3
)
;
server_
-
>
SetVersionRange
(
SSL_LIBRARY_VERSION_TLS_1_2
SSL_LIBRARY_VERSION_TLS_1_2
)
;
StartConnect
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
client_
-
>
Handshake
(
)
;
PRInt32
rv
=
PR_Write
(
client_
-
>
ssl_fd
(
)
k0RttData
k0RttDataLen
)
;
EXPECT_EQ
(
k0RttDataLen
rv
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
server_
-
>
ExpectSendAlert
(
kTlsAlertUnexpectedMessage
)
;
server_
-
>
Handshake
(
)
;
EXPECT_EQ
(
TlsAgent
:
:
STATE_ERROR
server_
-
>
state
(
)
)
;
server_
-
>
CheckErrorCode
(
SSL_ERROR_RX_UNEXPECTED_APPLICATION_DATA
)
;
}
else
{
server_
-
>
Handshake
(
)
;
EXPECT_EQ
(
TlsAgent
:
:
STATE_CONNECTING
server_
-
>
state
(
)
)
;
}
ASSERT_EQ
(
TlsAgent
:
:
STATE_CONNECTING
client_
-
>
state
(
)
)
;
client_
-
>
ExpectSendAlert
(
kTlsAlertIllegalParameter
)
;
client_
-
>
Handshake
(
)
;
client_
-
>
CheckErrorCode
(
SSL_ERROR_DOWNGRADE_WITH_EARLY_DATA
)
;
}
static
void
CheckEarlyDataLimit
(
const
std
:
:
shared_ptr
<
TlsAgent
>
&
agent
size_t
expected_size
)
{
SSLPreliminaryChannelInfo
preinfo
;
SECStatus
rv
=
SSL_GetPreliminaryChannelInfo
(
agent
-
>
ssl_fd
(
)
&
preinfo
sizeof
(
preinfo
)
)
;
EXPECT_EQ
(
SECSuccess
rv
)
;
EXPECT_EQ
(
expected_size
static_cast
<
size_t
>
(
preinfo
.
maxEarlyDataSize
)
)
;
}
TEST_P
(
TlsConnectTls13
SendTooMuchEarlyData
)
{
EnsureTlsSetup
(
)
;
const
char
*
big_message
=
"
0123456789abcdef
"
;
const
size_t
short_size
=
strlen
(
big_message
)
-
1
;
const
PRInt32
short_length
=
static_cast
<
PRInt32
>
(
short_size
)
;
EXPECT_EQ
(
SECSuccess
SSL_SetMaxEarlyDataSize
(
server_
-
>
ssl_fd
(
)
static_cast
<
PRUint32
>
(
short_size
)
)
)
;
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
CheckEarlyDataLimit
(
client_
short_size
)
;
PRInt32
sent
;
if
(
variant_
=
=
ssl_variant_stream
)
{
sent
=
PR_Write
(
client_
-
>
ssl_fd
(
)
big_message
static_cast
<
PRInt32
>
(
strlen
(
big_message
)
)
)
;
}
else
{
sent
=
PR_Write
(
client_
-
>
ssl_fd
(
)
big_message
static_cast
<
PRInt32
>
(
strlen
(
big_message
)
)
)
;
EXPECT_GE
(
0
sent
)
;
EXPECT_EQ
(
PR_WOULD_BLOCK_ERROR
PORT_GetError
(
)
)
;
sent
=
PR_Write
(
client_
-
>
ssl_fd
(
)
big_message
short_length
)
;
}
EXPECT_EQ
(
short_length
sent
)
;
sent
=
PR_Write
(
client_
-
>
ssl_fd
(
)
big_message
1
)
;
EXPECT_GE
(
0
sent
)
;
EXPECT_EQ
(
PR_WOULD_BLOCK_ERROR
PORT_GetError
(
)
)
;
server_
-
>
Handshake
(
)
;
CheckEarlyDataLimit
(
server_
short_size
)
;
std
:
:
vector
<
uint8_t
>
buf
(
short_size
+
1
)
;
PRInt32
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buf
.
data
(
)
buf
.
capacity
(
)
)
;
EXPECT_EQ
(
short_length
read
)
;
EXPECT_EQ
(
0
memcmp
(
big_message
buf
.
data
(
)
short_size
)
)
;
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buf
.
data
(
)
buf
.
capacity
(
)
)
;
EXPECT_EQ
(
SECFailure
read
)
;
EXPECT_EQ
(
PR_WOULD_BLOCK_ERROR
PORT_GetError
(
)
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
}
TEST_P
(
TlsConnectTls13
ReceiveTooMuchEarlyData
)
{
EnsureTlsSetup
(
)
;
const
size_t
limit
=
5
;
EXPECT_EQ
(
SECSuccess
SSL_SetMaxEarlyDataSize
(
server_
-
>
ssl_fd
(
)
limit
)
)
;
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
CheckEarlyDataLimit
(
client_
limit
)
;
server_
-
>
Handshake
(
)
;
EXPECT_EQ
(
SECSuccess
SSLInt_SetSocketMaxEarlyDataSize
(
client_
-
>
ssl_fd
(
)
1000
)
)
;
const
char
*
message
=
"
0123456789abcdef
"
;
const
PRInt32
message_len
=
static_cast
<
PRInt32
>
(
strlen
(
message
)
)
;
EXPECT_EQ
(
message_len
PR_Write
(
client_
-
>
ssl_fd
(
)
message
message_len
)
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
ExpectAlert
(
server_
kTlsAlertUnexpectedMessage
)
;
}
server_
-
>
Handshake
(
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
server_
-
>
CheckErrorCode
(
SSL_ERROR_TOO_MUCH_EARLY_DATA
)
;
}
else
{
EXPECT_EQ
(
TlsAgent
:
:
STATE_CONNECTING
server_
-
>
state
(
)
)
;
}
CheckEarlyDataLimit
(
server_
limit
)
;
std
:
:
vector
<
uint8_t
>
buf
(
strlen
(
message
)
+
1
)
;
EXPECT_GT
(
0
PR_Read
(
server_
-
>
ssl_fd
(
)
buf
.
data
(
)
buf
.
capacity
(
)
)
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
EXPECT_EQ
(
SSL_ERROR_HANDSHAKE_FAILED
PORT_GetError
(
)
)
;
}
else
{
EXPECT_EQ
(
PR_WOULD_BLOCK_ERROR
PORT_GetError
(
)
)
;
}
client_
-
>
Handshake
(
)
;
if
(
variant_
=
=
ssl_variant_stream
)
{
client_
-
>
Handshake
(
)
;
client_
-
>
CheckErrorCode
(
SSL_ERROR_HANDSHAKE_UNEXPECTED_ALERT
)
;
}
else
{
server_
-
>
Handshake
(
)
;
EXPECT_EQ
(
TlsAgent
:
:
STATE_CONNECTED
server_
-
>
state
(
)
)
;
}
}
class
PacketCoalesceFilter
:
public
PacketFilter
{
public
:
PacketCoalesceFilter
(
)
:
packet_data_
(
)
{
}
void
SendCoalesced
(
std
:
:
shared_ptr
<
TlsAgent
>
agent
)
{
agent
-
>
SendDirect
(
packet_data_
)
;
}
protected
:
PacketFilter
:
:
Action
Filter
(
const
DataBuffer
&
input
DataBuffer
*
output
)
override
{
packet_data_
.
Write
(
packet_data_
.
len
(
)
input
)
;
return
DROP
;
}
private
:
DataBuffer
packet_data_
;
}
;
TEST_P
(
TlsConnectTls13
ZeroRttOrdering
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
auto
coalesce
=
std
:
:
make_shared
<
PacketCoalesceFilter
>
(
)
;
client_
-
>
SetFilter
(
coalesce
)
;
static
const
std
:
:
vector
<
uint8_t
>
early_data
=
{
3
2
1
}
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
early_data
.
size
(
)
)
PR_Write
(
client_
-
>
ssl_fd
(
)
early_data
.
data
(
)
early_data
.
size
(
)
)
)
;
server_
-
>
Handshake
(
)
;
client_
-
>
Handshake
(
)
;
static
const
std
:
:
vector
<
uint8_t
>
late_data
=
{
7
8
9
10
}
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
late_data
.
size
(
)
)
PR_Write
(
client_
-
>
ssl_fd
(
)
late_data
.
data
(
)
late_data
.
size
(
)
)
)
;
coalesce
-
>
SendCoalesced
(
client_
)
;
size_t
step
=
0
;
server_
-
>
SetHandshakeCallback
(
[
&
step
]
(
TlsAgent
*
)
{
EXPECT_EQ
(
1U
step
)
;
+
+
step
;
}
)
;
std
:
:
vector
<
uint8_t
>
buf
(
10
)
;
PRInt32
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buf
.
data
(
)
buf
.
size
(
)
)
;
ASSERT_EQ
(
static_cast
<
PRInt32
>
(
early_data
.
size
(
)
)
read
)
;
buf
.
resize
(
read
)
;
EXPECT_EQ
(
early_data
buf
)
;
EXPECT_EQ
(
0U
step
)
;
+
+
step
;
buf
.
resize
(
10
)
;
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buf
.
data
(
)
buf
.
size
(
)
)
;
ASSERT_EQ
(
static_cast
<
PRInt32
>
(
late_data
.
size
(
)
)
read
)
;
buf
.
resize
(
read
)
;
EXPECT_EQ
(
late_data
buf
)
;
EXPECT_EQ
(
2U
step
)
;
}
TEST_F
(
TlsConnectStreamTls13
ZeroRttLateReadTls
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
const
uint8_t
data
[
]
=
{
1
2
3
4
5
6
7
8
}
;
PRInt32
rv
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
sizeof
(
data
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
rv
)
;
server_
-
>
Handshake
(
)
;
std
:
:
vector
<
uint8_t
>
small_buffer
(
1
+
sizeof
(
data
)
/
2
)
;
rv
=
PR_Read
(
server_
-
>
ssl_fd
(
)
small_buffer
.
data
(
)
small_buffer
.
size
(
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
small_buffer
.
size
(
)
)
rv
)
;
EXPECT_EQ
(
0
memcmp
(
data
small_buffer
.
data
(
)
small_buffer
.
size
(
)
)
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
uint8_t
big_buf
[
100
]
;
rv
=
PR_Read
(
server_
-
>
ssl_fd
(
)
big_buf
sizeof
(
big_buf
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
-
small_buffer
.
size
(
)
)
rv
)
;
EXPECT_EQ
(
0
memcmp
(
&
data
[
small_buffer
.
size
(
)
]
big_buf
sizeof
(
data
)
-
small_buffer
.
size
(
)
)
)
;
rv
=
PR_Read
(
server_
-
>
ssl_fd
(
)
big_buf
sizeof
(
big_buf
)
)
;
EXPECT_GT
(
0
rv
)
;
EXPECT_EQ
(
PR_WOULD_BLOCK_ERROR
PORT_GetError
(
)
)
;
}
TEST_F
(
TlsConnectDatagram13
ZeroRttLateReadDtls
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
const
uint8_t
data
[
]
=
{
1
2
3
}
;
PRInt32
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
sizeof
(
data
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
written
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
uint8_t
buf
[
sizeof
(
data
)
+
1
]
=
{
0
}
;
PRInt32
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buf
sizeof
(
buf
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
read
)
;
EXPECT_EQ
(
0
memcmp
(
data
buf
sizeof
(
data
)
)
)
;
}
class
PacketHolder
:
public
PacketFilter
{
public
:
PacketHolder
(
)
=
default
;
virtual
Action
Filter
(
const
DataBuffer
&
input
DataBuffer
*
output
)
{
packet_
=
input
;
Disable
(
)
;
return
DROP
;
}
const
DataBuffer
&
packet
(
)
const
{
return
packet_
;
}
private
:
DataBuffer
packet_
;
}
;
TEST_F
(
TlsConnectDatagram13
ZeroRttLateArrivalDtls
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
const
uint8_t
data
[
]
=
{
1
2
3
}
;
PRInt32
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
sizeof
(
data
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
written
)
;
auto
holder
=
std
:
:
make_shared
<
PacketHolder
>
(
)
;
client_
-
>
SetFilter
(
holder
)
;
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
sizeof
(
data
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
written
)
;
EXPECT_FALSE
(
holder
-
>
enabled
(
)
)
<
<
"
the
filter
should
disable
itself
"
;
server_
-
>
Handshake
(
)
;
std
:
:
vector
<
uint8_t
>
small_buffer
(
sizeof
(
data
)
)
;
PRInt32
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
small_buffer
.
data
(
)
small_buffer
.
size
(
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
small_buffer
.
size
(
)
)
read
)
;
EXPECT_EQ
(
0
memcmp
(
data
small_buffer
.
data
(
)
small_buffer
.
size
(
)
)
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
server_
-
>
SendDirect
(
holder
-
>
packet
(
)
)
;
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
small_buffer
.
data
(
)
small_buffer
.
size
(
)
)
;
EXPECT_GT
(
0
read
)
;
EXPECT_EQ
(
PR_WOULD_BLOCK_ERROR
PORT_GetError
(
)
)
;
}
TEST_F
(
TlsConnectStreamTls13
ZeroRttCoalesceReadTls
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
const
uint8_t
data
[
]
=
{
1
2
3
4
5
6
}
;
PRInt32
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
1
)
;
EXPECT_EQ
(
1
written
)
;
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
+
1
sizeof
(
data
)
-
1
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
-
1
)
written
)
;
server_
-
>
Handshake
(
)
;
std
:
:
vector
<
uint8_t
>
buffer
(
sizeof
(
data
)
)
;
PRInt32
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buffer
.
data
(
)
buffer
.
size
(
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
read
)
;
EXPECT_EQ
(
0
memcmp
(
data
buffer
.
data
(
)
sizeof
(
data
)
)
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
}
TEST_F
(
TlsConnectDatagram13
ZeroRttNoCoalesceReadDtls
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
const
uint8_t
data
[
]
=
{
1
2
3
4
5
6
}
;
PRInt32
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
1
)
;
EXPECT_EQ
(
1
written
)
;
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
+
1
sizeof
(
data
)
-
1
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
-
1
)
written
)
;
server_
-
>
Handshake
(
)
;
std
:
:
vector
<
uint8_t
>
buffer
(
sizeof
(
data
)
)
;
PRInt32
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buffer
.
data
(
)
buffer
.
size
(
)
)
;
EXPECT_EQ
(
1
read
)
;
EXPECT_EQ
(
0
memcmp
(
data
buffer
.
data
(
)
1
)
)
;
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buffer
.
data
(
)
buffer
.
size
(
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
-
1
)
read
)
;
EXPECT_EQ
(
0
memcmp
(
data
+
1
buffer
.
data
(
)
sizeof
(
data
)
-
1
)
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
}
TEST_F
(
TlsConnectDatagram13
ZeroRttShortReadDtls
)
{
SetupForZeroRtt
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
client_
-
>
Handshake
(
)
;
const
uint8_t
data
[
]
=
{
1
2
3
4
5
6
}
;
PRInt32
written
=
PR_Write
(
client_
-
>
ssl_fd
(
)
data
sizeof
(
data
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
written
)
;
server_
-
>
Handshake
(
)
;
std
:
:
vector
<
uint8_t
>
buffer
(
sizeof
(
data
)
)
;
PRInt32
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buffer
.
data
(
)
1
)
;
EXPECT_GT
(
0
read
)
;
EXPECT_EQ
(
SSL_ERROR_RX_SHORT_DTLS_READ
PORT_GetError
(
)
)
;
read
=
PR_Read
(
server_
-
>
ssl_fd
(
)
buffer
.
data
(
)
buffer
.
size
(
)
)
;
EXPECT_EQ
(
static_cast
<
PRInt32
>
(
sizeof
(
data
)
)
read
)
;
EXPECT_EQ
(
0
memcmp
(
data
buffer
.
data
(
)
sizeof
(
data
)
)
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
true
)
;
CheckConnected
(
)
;
}
TEST_F
(
TlsConnectStreamTls13
TimePassesByDefault
)
{
client_
-
>
EnsureTlsSetup
(
)
;
server_
-
>
EnsureTlsSetup
(
)
;
client_
-
>
StartConnect
(
)
;
server_
-
>
StartConnect
(
)
;
static
const
unsigned
int
kTinyWindowMs
=
5
;
ResetAntiReplay
(
static_cast
<
PRTime
>
(
kTinyWindowMs
*
PR_USEC_PER_MSEC
)
)
;
server_
-
>
SetAntiReplayContext
(
anti_replay_
)
;
ConfigureSessionCache
(
RESUME_BOTH
RESUME_TICKET
)
;
ConfigureVersion
(
SSL_LIBRARY_VERSION_TLS_1_3
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
Handshake
(
)
;
CheckConnected
(
)
;
SendReceive
(
)
;
CheckKeys
(
)
;
PR_Sleep
(
PR_MillisecondsToInterval
(
kTinyWindowMs
)
)
;
Reset
(
)
;
client_
-
>
EnsureTlsSetup
(
)
;
server_
-
>
EnsureTlsSetup
(
)
;
client_
-
>
StartConnect
(
)
;
server_
-
>
StartConnect
(
)
;
client_
-
>
Set0RttEnabled
(
true
)
;
server_
-
>
Set0RttEnabled
(
true
)
;
ExpectResumption
(
RESUME_TICKET
)
;
ZeroRttSendReceive
(
true
false
[
]
(
)
{
PR_Sleep
(
PR_MillisecondsToInterval
(
1000
)
)
;
return
true
;
}
)
;
Handshake
(
)
;
ExpectEarlyDataAccepted
(
false
)
;
CheckConnected
(
)
;
}
TEST_F
(
TlsConnectStreamTls13
BadAntiReplayArgs
)
{
SSLAntiReplayContext
*
p
;
EXPECT_EQ
(
SECFailure
SSL_CreateAntiReplayContext
(
0
-
1
1
1
&
p
)
)
;
EXPECT_EQ
(
SEC_ERROR_INVALID_ARGS
PORT_GetError
(
)
)
;
EXPECT_EQ
(
SECFailure
SSL_CreateAntiReplayContext
(
0
0
1
1
&
p
)
)
;
EXPECT_EQ
(
SEC_ERROR_INVALID_ARGS
PORT_GetError
(
)
)
;
EXPECT_EQ
(
SECFailure
SSL_CreateAntiReplayContext
(
0
1
0
1
&
p
)
)
;
EXPECT_EQ
(
SEC_ERROR_INVALID_ARGS
PORT_GetError
(
)
)
;
EXPECT_EQ
(
SECFailure
SSL_CreateAntiReplayContext
(
0
1
1
0
&
p
)
)
;
EXPECT_EQ
(
SEC_ERROR_INVALID_ARGS
PORT_GetError
(
)
)
;
EXPECT_EQ
(
SECFailure
SSL_CreateAntiReplayContext
(
0
1
1
1
nullptr
)
)
;
EXPECT_EQ
(
SEC_ERROR_INVALID_ARGS
PORT_GetError
(
)
)
;
EXPECT_EQ
(
SECSuccess
SSL_CreateAntiReplayContext
(
0
1
1
1
&
p
)
)
;
ASSERT_NE
(
nullptr
p
)
;
ScopedSSLAntiReplayContext
ctx
(
p
)
;
client_
-
>
EnsureTlsSetup
(
)
;
EXPECT_EQ
(
SECSuccess
SSL_SetAntiReplayContext
(
client_
-
>
ssl_fd
(
)
ctx
.
get
(
)
)
)
;
EXPECT_EQ
(
SECSuccess
SSL_SetAntiReplayContext
(
client_
-
>
ssl_fd
(
)
nullptr
)
)
;
}
#
ifndef
NSS_DISABLE_TLS_1_3
INSTANTIATE_TEST_CASE_P
(
Tls13ZeroRttReplayTest
TlsZeroRttReplayTest
TlsConnectTestBase
:
:
kTlsVariantsAll
)
;
#
endif
}
