#
include
"
secerr
.
h
"
#
include
"
ssl
.
h
"
#
include
"
sslerr
.
h
"
#
include
"
sslproto
.
h
"
extern
"
C
"
{
#
include
"
libssl_internals
.
h
"
}
#
include
"
scoped_ptrs
.
h
"
#
include
"
tls_parser
.
h
"
#
include
"
tls_filter
.
h
"
#
include
"
tls_connect
.
h
"
#
include
"
gtest_utils
.
h
"
namespace
nss_test
{
TEST_P
(
TlsConnectGeneric
ClientAuth
)
{
client_
-
>
SetupClientAuth
(
)
;
server_
-
>
RequestClientAuth
(
true
)
;
Connect
(
)
;
CheckKeys
(
ssl_kea_ecdh
ssl_auth_rsa_sign
)
;
}
TEST_P
(
TlsConnectStream
DISABLED_ClientAuthRequiredRejected
)
{
server_
-
>
RequestClientAuth
(
true
)
;
ConnectExpectFail
(
)
;
}
TEST_P
(
TlsConnectGeneric
ClientAuthRequestedRejected
)
{
server_
-
>
RequestClientAuth
(
false
)
;
Connect
(
)
;
CheckKeys
(
ssl_kea_ecdh
ssl_auth_rsa_sign
)
;
}
TEST_P
(
TlsConnectGeneric
ClientAuthEcdsa
)
{
Reset
(
TlsAgent
:
:
kServerEcdsa
)
;
client_
-
>
SetupClientAuth
(
)
;
server_
-
>
RequestClientAuth
(
true
)
;
Connect
(
)
;
CheckKeys
(
ssl_kea_ecdh
ssl_auth_ecdsa
)
;
}
static
const
SSLSignatureAndHashAlg
SignatureEcdsaSha384
[
]
=
{
{
ssl_hash_sha384
ssl_sign_ecdsa
}
}
;
static
const
SSLSignatureAndHashAlg
SignatureEcdsaSha256
[
]
=
{
{
ssl_hash_sha256
ssl_sign_ecdsa
}
}
;
static
const
SSLSignatureAndHashAlg
SignatureRsaSha384
[
]
=
{
{
ssl_hash_sha384
ssl_sign_rsa
}
}
;
static
const
SSLSignatureAndHashAlg
SignatureRsaSha256
[
]
=
{
{
ssl_hash_sha256
ssl_sign_rsa
}
}
;
TEST_P
(
TlsConnectGeneric
SignatureAlgorithmServerAuth
)
{
client_
-
>
SetSignatureAlgorithms
(
SignatureEcdsaSha384
PR_ARRAY_SIZE
(
SignatureEcdsaSha384
)
)
;
server_
-
>
SetSignatureAlgorithms
(
SignatureEcdsaSha384
PR_ARRAY_SIZE
(
SignatureEcdsaSha384
)
)
;
Reset
(
TlsAgent
:
:
kServerEcdsa
)
;
Connect
(
)
;
}
TEST_P
(
TlsConnectGeneric
SignatureAlgorithmClientOnly
)
{
const
SSLSignatureAndHashAlg
clientAlgorithms
[
]
=
{
{
ssl_hash_sha384
ssl_sign_ecdsa
}
{
ssl_hash_sha384
ssl_sign_rsa
}
{
ssl_hash_md5
ssl_sign_ecdsa
}
}
;
client_
-
>
SetSignatureAlgorithms
(
clientAlgorithms
PR_ARRAY_SIZE
(
clientAlgorithms
)
)
;
Reset
(
TlsAgent
:
:
kServerEcdsa
)
;
Connect
(
)
;
}
TEST_P
(
TlsConnectGeneric
SignatureAlgorithmServerOnly
)
{
server_
-
>
SetSignatureAlgorithms
(
SignatureEcdsaSha384
PR_ARRAY_SIZE
(
SignatureEcdsaSha384
)
)
;
Reset
(
TlsAgent
:
:
kServerEcdsa
)
;
Connect
(
)
;
}
TEST_P
(
TlsConnectGenericPre13
SignatureAlgorithmNoOverlapStaticRsa
)
{
client_
-
>
SetSignatureAlgorithms
(
SignatureRsaSha384
PR_ARRAY_SIZE
(
SignatureRsaSha384
)
)
;
server_
-
>
SetSignatureAlgorithms
(
SignatureRsaSha256
PR_ARRAY_SIZE
(
SignatureRsaSha256
)
)
;
EnableOnlyStaticRsaCiphers
(
)
;
Connect
(
)
;
CheckKeys
(
ssl_kea_rsa
ssl_auth_rsa_decrypt
)
;
}
TEST_P
(
TlsConnectTls12
SignatureAlgorithmNoOverlapEcdsa
)
{
Reset
(
TlsAgent
:
:
kServerEcdsa
)
;
client_
-
>
SetSignatureAlgorithms
(
SignatureEcdsaSha384
PR_ARRAY_SIZE
(
SignatureEcdsaSha384
)
)
;
server_
-
>
SetSignatureAlgorithms
(
SignatureEcdsaSha256
PR_ARRAY_SIZE
(
SignatureEcdsaSha256
)
)
;
ConnectExpectFail
(
)
;
}
TEST_P
(
TlsConnectPre12
SignatureAlgorithmNoOverlapEcdsa
)
{
Reset
(
TlsAgent
:
:
kServerEcdsa
)
;
client_
-
>
SetSignatureAlgorithms
(
SignatureEcdsaSha384
PR_ARRAY_SIZE
(
SignatureEcdsaSha384
)
)
;
server_
-
>
SetSignatureAlgorithms
(
SignatureEcdsaSha256
PR_ARRAY_SIZE
(
SignatureEcdsaSha256
)
)
;
Connect
(
)
;
}
TEST_P
(
TlsConnectTls12Plus
RequestClientAuthWithSha384
)
{
server_
-
>
SetSignatureAlgorithms
(
SignatureRsaSha384
PR_ARRAY_SIZE
(
SignatureRsaSha384
)
)
;
server_
-
>
RequestClientAuth
(
false
)
;
Connect
(
)
;
}
class
BeforeFinished
:
public
TlsRecordFilter
{
private
:
enum
HandshakeState
{
BEFORE_CCS
AFTER_CCS
DONE
}
;
public
:
BeforeFinished
(
TlsAgent
*
client
TlsAgent
*
server
VoidFunction
before_ccs
VoidFunction
before_finished
)
:
client_
(
client
)
server_
(
server
)
before_ccs_
(
before_ccs
)
before_finished_
(
before_finished
)
state_
(
BEFORE_CCS
)
{
}
protected
:
virtual
PacketFilter
:
:
Action
FilterRecord
(
const
RecordHeader
&
header
const
DataBuffer
&
body
DataBuffer
*
out
)
{
switch
(
state_
)
{
case
BEFORE_CCS
:
if
(
header
.
content_type
(
)
=
=
kTlsChangeCipherSpecType
)
{
before_ccs_
(
)
;
DataBuffer
ccs
;
header
.
Write
(
&
ccs
0
body
)
;
server_
-
>
SendDirect
(
ccs
)
;
client_
-
>
Handshake
(
)
;
state_
=
AFTER_CCS
;
return
DROP
;
}
break
;
case
AFTER_CCS
:
EXPECT_EQ
(
kTlsHandshakeType
header
.
content_type
(
)
)
;
before_finished_
(
)
;
state_
=
DONE
;
break
;
case
DONE
:
break
;
}
return
KEEP
;
}
private
:
TlsAgent
*
client_
;
TlsAgent
*
server_
;
VoidFunction
before_ccs_
;
VoidFunction
before_finished_
;
HandshakeState
state_
;
}
;
class
BeforeFinished13
:
public
PacketFilter
{
private
:
enum
HandshakeState
{
INIT
BEFORE_FIRST_FRAGMENT
BEFORE_SECOND_FRAGMENT
DONE
}
;
public
:
BeforeFinished13
(
TlsAgent
*
client
TlsAgent
*
server
VoidFunction
before_finished
)
:
client_
(
client
)
server_
(
server
)
before_finished_
(
before_finished
)
records_
(
0
)
{
}
protected
:
virtual
PacketFilter
:
:
Action
Filter
(
const
DataBuffer
&
input
DataBuffer
*
output
)
{
switch
(
+
+
records_
)
{
case
1
:
EXPECT_EQ
(
SECSuccess
SSLInt_SetMTU
(
server_
-
>
ssl_fd
(
)
input
.
len
(
)
-
1
)
)
;
return
DROP
;
case
3
:
client_
-
>
Handshake
(
)
;
before_finished_
(
)
;
break
;
default
:
break
;
}
return
KEEP
;
}
private
:
TlsAgent
*
client_
;
TlsAgent
*
server_
;
VoidFunction
before_finished_
;
size_t
records_
;
}
;
#
ifdef
NSS_ENABLE_TLS_1_3
TEST_F
(
TlsConnectDatagram13
AuthCompleteBeforeFinished
)
{
client_
-
>
SetAuthCertificateCallback
(
[
]
(
TlsAgent
&
PRBool
PRBool
)
-
>
SECStatus
{
return
SECWouldBlock
;
}
)
;
server_
-
>
SetPacketFilter
(
new
BeforeFinished13
(
client_
server_
[
this
]
(
)
{
EXPECT_EQ
(
SECSuccess
SSL_AuthCertificateComplete
(
client_
-
>
ssl_fd
(
)
0
)
)
;
}
)
)
;
Connect
(
)
;
}
static
void
TriggerAuthComplete
(
PollTarget
*
target
Event
event
)
{
std
:
:
cerr
<
<
"
client
:
call
SSL_AuthCertificateComplete
"
<
<
std
:
:
endl
;
EXPECT_EQ
(
TIMER_EVENT
event
)
;
TlsAgent
*
client
=
static_cast
<
TlsAgent
*
>
(
target
)
;
EXPECT_EQ
(
SECSuccess
SSL_AuthCertificateComplete
(
client
-
>
ssl_fd
(
)
0
)
)
;
}
TEST_F
(
TlsConnectDatagram13
AuthCompleteAfterFinished
)
{
client_
-
>
SetAuthCertificateCallback
(
[
this
]
(
TlsAgent
&
PRBool
PRBool
)
-
>
SECStatus
{
Poller
:
:
Timer
*
timer_handle
;
Poller
:
:
Instance
(
)
-
>
SetTimer
(
1U
client_
TriggerAuthComplete
&
timer_handle
)
;
return
SECWouldBlock
;
}
)
;
Connect
(
)
;
}
#
endif
TEST_P
(
TlsConnectGenericPre13
ClientWriteBetweenCCSAndFinishedWithFalseStart
)
{
client_
-
>
EnableFalseStart
(
)
;
server_
-
>
SetPacketFilter
(
new
BeforeFinished
(
client_
server_
[
this
]
(
)
{
EXPECT_TRUE
(
client_
-
>
can_falsestart_hook_called
(
)
)
;
}
[
this
]
(
)
{
client_
-
>
SendData
(
10
)
;
}
)
)
;
Connect
(
)
;
server_
-
>
SendData
(
10
)
;
Receive
(
10
)
;
}
TEST_P
(
TlsConnectGenericPre13
AuthCompleteBeforeFinishedWithFalseStart
)
{
client_
-
>
EnableFalseStart
(
)
;
client_
-
>
SetAuthCertificateCallback
(
[
]
(
TlsAgent
&
PRBool
PRBool
)
-
>
SECStatus
{
return
SECWouldBlock
;
}
)
;
server_
-
>
SetPacketFilter
(
new
BeforeFinished
(
client_
server_
[
]
(
)
{
}
[
this
]
(
)
{
EXPECT_FALSE
(
client_
-
>
can_falsestart_hook_called
(
)
)
;
EXPECT_EQ
(
SECSuccess
SSL_AuthCertificateComplete
(
client_
-
>
ssl_fd
(
)
0
)
)
;
EXPECT_TRUE
(
client_
-
>
can_falsestart_hook_called
(
)
)
;
client_
-
>
SendData
(
10
)
;
}
)
)
;
Connect
(
)
;
server_
-
>
SendData
(
10
)
;
Receive
(
10
)
;
}
}
