#
include
"
seccomon
.
h
"
#
include
"
lgdb
.
h
"
#
include
"
blapi
.
h
"
#
if
defined
(
USE_INIT_PRAGMA
)
#
pragma
init
(
lg_startup_tests
)
#
endif
#
if
defined
(
__GNUC__
)
&
&
!
defined
(
NSS_NO_INIT_SUPPORT
)
#
define
INIT_FUNCTION
__attribute__
(
(
constructor
)
)
#
else
#
define
INIT_FUNCTION
#
endif
static
void
INIT_FUNCTION
lg_startup_tests
(
void
)
;
#
if
defined
(
XP_WIN
)
&
&
!
defined
(
NSS_NO_INIT_SUPPORT
)
#
include
<
windows
.
h
>
BOOL
WINAPI
DllMain
(
HINSTANCE
hinstDLL
DWORD
fdwReason
LPVOID
lpReserved
)
{
switch
(
fdwReason
)
{
case
DLL_PROCESS_ATTACH
:
lg_startup_tests
(
)
;
break
;
case
DLL_THREAD_ATTACH
:
break
;
case
DLL_THREAD_DETACH
:
break
;
case
DLL_PROCESS_DETACH
:
break
;
}
return
TRUE
;
}
#
endif
static
PRBool
lg_self_tests_ran
=
PR_FALSE
;
static
PRBool
lg_self_tests_success
=
PR_FALSE
;
static
void
lg_local_function
(
void
)
{
}
static
void
lg_startup_tests
(
void
)
{
const
char
*
libraryName
=
LG_LIB_NAME
;
PORT_Assert
(
!
lg_self_tests_ran
)
;
PORT_Assert
(
!
lg_self_tests_success
)
;
lg_self_tests_ran
=
PR_TRUE
;
lg_self_tests_success
=
PR_FALSE
;
if
(
!
BLAPI_SHVerify
(
libraryName
(
PRFuncPtr
)
&
lg_local_function
)
)
{
return
;
}
lg_self_tests_success
=
PR_TRUE
;
}
PRBool
lg_FIPSEntryOK
(
)
{
#
ifdef
NSS_NO_INIT_SUPPORT
if
(
!
lg_self_tests_ran
)
{
lg_startup_tests
(
)
;
}
#
endif
return
lg_self_tests_success
;
}
