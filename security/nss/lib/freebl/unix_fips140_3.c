#
include
<
fcntl
.
h
>
#
include
<
unistd
.
h
>
#
include
<
errno
.
h
>
#
include
"
secerr
.
h
"
#
include
"
secrng
.
h
"
#
include
"
prprf
.
h
"
#
include
<
sys
/
random
.
h
>
#
include
"
prinit
.
h
"
#
ifndef
GRND_RANDOM
PR_STATIC_ASSERT
(
"
You
'
ll
need
to
add
our
platform
specific
solution
for
FIPS
140
-
3
RNG
"
=
=
NULL
)
;
#
endif
#
define
GETENTROPY_MAX_BYTES
256
void
RNG_SystemInfoForRNG
(
void
)
{
PRUint8
bytes
[
SYSTEM_RNG_SEED_COUNT
]
;
size_t
numBytes
=
RNG_SystemRNG
(
bytes
SYSTEM_RNG_SEED_COUNT
)
;
if
(
!
numBytes
)
{
return
;
}
RNG_RandomUpdate
(
bytes
numBytes
)
;
PORT_SaveZero
(
bytes
sizeof
(
bytes
)
)
;
}
static
unsigned
int
rng_grndFlags
=
0
;
static
PRCallOnceType
rng_KernelFips
;
static
PRStatus
rng_getKernelFips
(
)
{
if
(
NSS_GetSystemFIPSEnabled
(
)
)
{
rng_grndFlags
=
GRND_RANDOM
;
}
return
PR_SUCCESS
;
}
size_t
RNG_SystemRNG
(
void
*
dest
size_t
maxLen
)
{
size_t
fileBytes
=
0
;
unsigned
char
*
buffer
=
dest
;
ssize_t
result
;
PR_CallOnce
(
&
rng_KernelFips
rng_getKernelFips
)
;
while
(
fileBytes
<
maxLen
)
{
size_t
getBytes
=
maxLen
-
fileBytes
;
if
(
getBytes
>
GETENTROPY_MAX_BYTES
)
{
getBytes
=
GETENTROPY_MAX_BYTES
;
}
result
=
getrandom
(
buffer
getBytes
rng_grndFlags
)
;
if
(
result
<
0
)
{
break
;
}
fileBytes
+
=
result
;
buffer
+
=
result
;
}
if
(
fileBytes
=
=
maxLen
)
{
return
maxLen
;
}
PORT_SetError
(
SEC_ERROR_NEED_RANDOM
)
;
return
0
;
}
