#
ifdef
FREEBL_NO_DEPEND
#
include
"
stubs
.
h
"
#
endif
#
include
"
blapii
.
h
"
#
include
"
mpi
.
h
"
#
include
"
secerr
.
h
"
#
include
"
prtypes
.
h
"
#
include
"
prinit
.
h
"
#
include
"
prenv
.
h
"
#
if
defined
(
_MSC_VER
)
&
&
!
defined
(
_M_IX86
)
#
include
<
intrin
.
h
>
#
endif
static
PRCallOnceType
coFreeblInit
;
static
PRBool
aesni_support_
=
PR_FALSE
;
static
PRBool
clmul_support_
=
PR_FALSE
;
static
PRBool
avx_support_
=
PR_FALSE
;
#
ifdef
NSS_X86_OR_X64
static
PRBool
check_xcr0_ymm
(
)
{
PRUint32
xcr0
;
#
if
defined
(
_MSC_VER
)
#
if
defined
(
_M_IX86
)
__asm
{
mov
ecx
0
xgetbv
mov
xcr0
eax
}
#
else
xcr0
=
(
PRUint32
)
_xgetbv
(
0
)
;
#
endif
#
else
__asm__
(
"
.
byte
0x0F
0x01
0xd0
"
:
"
=
a
"
(
xcr0
)
:
"
c
"
(
0
)
:
"
%
edx
"
)
;
#
endif
return
(
xcr0
&
6
)
=
=
6
;
}
#
define
ECX_AESNI
(
1
<
<
25
)
#
define
ECX_CLMUL
(
1
<
<
1
)
#
define
ECX_XSAVE
(
1
<
<
26
)
#
define
ECX_OSXSAVE
(
1
<
<
27
)
#
define
ECX_AVX
(
1
<
<
28
)
#
define
AVX_BITS
(
ECX_XSAVE
|
ECX_OSXSAVE
|
ECX_AVX
)
void
CheckX86CPUSupport
(
)
{
unsigned
long
eax
ebx
ecx
edx
;
char
*
disable_hw_aes
=
PR_GetEnvSecure
(
"
NSS_DISABLE_HW_AES
"
)
;
char
*
disable_pclmul
=
PR_GetEnvSecure
(
"
NSS_DISABLE_PCLMUL
"
)
;
char
*
disable_avx
=
PR_GetEnvSecure
(
"
NSS_DISABLE_AVX
"
)
;
freebl_cpuid
(
1
&
eax
&
ebx
&
ecx
&
edx
)
;
aesni_support_
=
(
PRBool
)
(
(
ecx
&
ECX_AESNI
)
!
=
0
&
&
disable_hw_aes
=
=
NULL
)
;
clmul_support_
=
(
PRBool
)
(
(
ecx
&
ECX_CLMUL
)
!
=
0
&
&
disable_pclmul
=
=
NULL
)
;
avx_support_
=
(
PRBool
)
(
(
ecx
&
AVX_BITS
)
=
=
AVX_BITS
)
&
&
check_xcr0_ymm
(
)
&
&
disable_avx
=
=
NULL
;
}
#
endif
PRBool
aesni_support
(
)
{
return
aesni_support_
;
}
PRBool
clmul_support
(
)
{
return
clmul_support_
;
}
PRBool
avx_support
(
)
{
return
avx_support_
;
}
static
PRStatus
FreeblInit
(
void
)
{
#
ifdef
NSS_X86_OR_X64
CheckX86CPUSupport
(
)
;
#
endif
return
PR_SUCCESS
;
}
SECStatus
BL_Init
(
)
{
if
(
PR_CallOnce
(
&
coFreeblInit
FreeblInit
)
!
=
PR_SUCCESS
)
{
PORT_SetError
(
SEC_ERROR_LIBRARY_FAILURE
)
;
return
SECFailure
;
}
RSA_Init
(
)
;
return
SECSuccess
;
}
