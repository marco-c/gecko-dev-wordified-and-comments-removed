#
include
"
CTLogVerifier
.
h
"
#
include
"
CTTestUtils
.
h
"
#
include
"
nss
.
h
"
#
include
"
gtest
/
gtest
.
h
"
namespace
mozilla
{
namespace
ct
{
using
namespace
pkix
;
class
CTLogVerifierTest
:
public
:
:
testing
:
:
Test
{
public
:
void
SetUp
(
)
override
{
MOZ_RELEASE_ASSERT
(
NSS_NoDB_Init
(
nullptr
)
=
=
SECSuccess
)
;
ASSERT_EQ
(
Success
mLog
.
Init
(
InputForBuffer
(
GetTestPublicKey
(
)
)
)
)
;
ASSERT_EQ
(
GetTestPublicKeyId
(
)
mLog
.
keyId
(
)
)
;
}
protected
:
CTLogVerifier
mLog
;
}
;
TEST_F
(
CTLogVerifierTest
VerifiesCertSCT
)
{
LogEntry
certEntry
;
GetX509CertLogEntry
(
certEntry
)
;
SignedCertificateTimestamp
certSct
;
GetX509CertSCT
(
certSct
)
;
EXPECT_EQ
(
Success
mLog
.
Verify
(
certEntry
certSct
)
)
;
}
TEST_F
(
CTLogVerifierTest
VerifiesPrecertSCT
)
{
LogEntry
precertEntry
;
GetPrecertLogEntry
(
precertEntry
)
;
SignedCertificateTimestamp
precertSct
;
GetPrecertSCT
(
precertSct
)
;
EXPECT_EQ
(
Success
mLog
.
Verify
(
precertEntry
precertSct
)
)
;
}
TEST_F
(
CTLogVerifierTest
FailsInvalidTimestamp
)
{
LogEntry
certEntry
;
GetX509CertLogEntry
(
certEntry
)
;
SignedCertificateTimestamp
certSct
;
GetX509CertSCT
(
certSct
)
;
certSct
.
timestamp
=
0
;
EXPECT_EQ
(
Result
:
:
ERROR_BAD_SIGNATURE
mLog
.
Verify
(
certEntry
certSct
)
)
;
}
TEST_F
(
CTLogVerifierTest
FailsInvalidSignature
)
{
LogEntry
certEntry
;
GetX509CertLogEntry
(
certEntry
)
;
SignedCertificateTimestamp
certSct
;
GetX509CertSCT
(
certSct
)
;
certSct
.
signature
.
signatureData
[
20
]
^
=
'
\
xFF
'
;
EXPECT_EQ
(
Result
:
:
ERROR_BAD_SIGNATURE
mLog
.
Verify
(
certEntry
certSct
)
)
;
SignedCertificateTimestamp
certSct2
;
GetX509CertSCT
(
certSct2
)
;
certSct2
.
signature
.
signatureData
[
0
]
^
=
'
\
xFF
'
;
EXPECT_EQ
(
Result
:
:
ERROR_BAD_SIGNATURE
mLog
.
Verify
(
certEntry
certSct2
)
)
;
}
TEST_F
(
CTLogVerifierTest
FailsInvalidLogID
)
{
LogEntry
certEntry
;
GetX509CertLogEntry
(
certEntry
)
;
SignedCertificateTimestamp
certSct
;
GetX509CertSCT
(
certSct
)
;
MOZ_RELEASE_ASSERT
(
certSct
.
logId
.
append
(
'
\
x0
'
)
)
;
EXPECT_EQ
(
Result
:
:
FATAL_ERROR_INVALID_ARGS
mLog
.
Verify
(
certEntry
certSct
)
)
;
}
TEST_F
(
CTLogVerifierTest
VerifiesValidSTH
)
{
SignedTreeHead
sth
;
GetSampleSignedTreeHead
(
sth
)
;
EXPECT_EQ
(
Success
mLog
.
VerifySignedTreeHead
(
sth
)
)
;
}
TEST_F
(
CTLogVerifierTest
DoesNotVerifyInvalidSTH
)
{
SignedTreeHead
sth
;
GetSampleSignedTreeHead
(
sth
)
;
sth
.
sha256RootHash
[
0
]
^
=
'
\
xFF
'
;
EXPECT_EQ
(
Result
:
:
ERROR_BAD_SIGNATURE
mLog
.
VerifySignedTreeHead
(
sth
)
)
;
}
TEST_F
(
CTLogVerifierTest
ExcessDataInPublicKey
)
{
Buffer
key
=
GetTestPublicKey
(
)
;
MOZ_RELEASE_ASSERT
(
key
.
append
(
"
extra
"
5
)
)
;
CTLogVerifier
log
;
EXPECT_NE
(
Success
log
.
Init
(
InputForBuffer
(
key
)
)
)
;
}
}
}
