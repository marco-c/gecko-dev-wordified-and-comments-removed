#
ifndef
CertVerifier_h
#
define
CertVerifier_h
#
include
"
BRNameMatchingPolicy
.
h
"
#
include
"
CTPolicyEnforcer
.
h
"
#
include
"
CTVerifyResult
.
h
"
#
include
"
OCSPCache
.
h
"
#
include
"
ScopedNSSTypes
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsString
.
h
"
#
include
"
pkix
/
pkixtypes
.
h
"
#
if
defined
(
_MSC_VER
)
#
pragma
warning
(
push
)
#
pragma
warning
(
disable
:
4324
)
#
endif
#
include
"
mozilla
/
BasePrincipal
.
h
"
#
if
defined
(
_MSC_VER
)
#
pragma
warning
(
pop
)
/
*
popping
the
pragma
in
this
file
*
/
#
endif
namespace
mozilla
{
namespace
ct
{
class
MultiLogCTVerifier
;
class
CTDiversityPolicy
;
}
}
namespace
mozilla
{
namespace
psm
{
typedef
mozilla
:
:
pkix
:
:
Result
Result
;
enum
class
KeySizeStatus
{
NeverChecked
=
0
LargeMinimumSucceeded
=
1
CompatibilityRisk
=
2
AlreadyBad
=
3
}
;
enum
class
SHA1ModeResult
{
NeverChecked
=
0
SucceededWithoutSHA1
=
1
SucceededWithImportedRoot
=
2
SucceededWithImportedRootOrSHA1Before2016
=
3
SucceededWithSHA1
=
4
Failed
=
5
}
;
enum
class
DistrustedCAPolicy
:
uint32_t
{
Permit
=
0
DistrustSymantecRoots
=
1
}
;
enum
class
NetscapeStepUpPolicy
:
uint32_t
;
class
PinningTelemetryInfo
{
public
:
PinningTelemetryInfo
(
)
:
certPinningResultHistogram
{
static_cast
<
Telemetry
:
:
HistogramID
>
(
0
)
}
certPinningResultBucket
{
}
rootBucket
{
}
{
Reset
(
)
;
}
bool
accumulateResult
;
Telemetry
:
:
HistogramID
certPinningResultHistogram
;
int32_t
certPinningResultBucket
;
bool
accumulateForRoot
;
int32_t
rootBucket
;
void
Reset
(
)
{
accumulateForRoot
=
false
;
accumulateResult
=
false
;
}
}
;
class
CertificateTransparencyInfo
{
public
:
CertificateTransparencyInfo
(
)
:
enabled
{
false
}
policyCompliance
{
mozilla
:
:
ct
:
:
CTPolicyCompliance
:
:
Unknown
}
{
Reset
(
)
;
}
bool
enabled
;
mozilla
:
:
ct
:
:
CTVerifyResult
verifyResult
;
mozilla
:
:
ct
:
:
CTPolicyCompliance
policyCompliance
;
void
Reset
(
)
;
}
;
class
NSSCertDBTrustDomain
;
class
CertVerifier
{
public
:
typedef
unsigned
int
Flags
;
static
const
Flags
FLAG_LOCAL_ONLY
;
static
const
Flags
FLAG_MUST_BE_EV
;
static
const
Flags
FLAG_TLS_IGNORE_STATUS_REQUEST
;
enum
OCSPStaplingStatus
{
OCSP_STAPLING_NEVER_CHECKED
=
0
OCSP_STAPLING_GOOD
=
1
OCSP_STAPLING_NONE
=
2
OCSP_STAPLING_EXPIRED
=
3
OCSP_STAPLING_INVALID
=
4
}
;
mozilla
:
:
pkix
:
:
Result
VerifyCert
(
CERTCertificate
*
cert
SECCertificateUsage
usage
mozilla
:
:
pkix
:
:
Time
time
void
*
pinArg
const
char
*
hostname
UniqueCERTCertList
&
builtChain
Flags
flags
=
0
const
SECItem
*
stapledOCSPResponse
=
nullptr
const
SECItem
*
sctsFromTLS
=
nullptr
const
OriginAttributes
&
originAttributes
=
OriginAttributes
(
)
SECOidTag
*
evOidPolicy
=
nullptr
OCSPStaplingStatus
*
ocspStaplingStatus
=
nullptr
KeySizeStatus
*
keySizeStatus
=
nullptr
SHA1ModeResult
*
sha1ModeResult
=
nullptr
PinningTelemetryInfo
*
pinningTelemetryInfo
=
nullptr
CertificateTransparencyInfo
*
ctInfo
=
nullptr
)
;
mozilla
:
:
pkix
:
:
Result
VerifySSLServerCert
(
const
UniqueCERTCertificate
&
peerCert
const
SECItem
*
stapledOCSPResponse
const
SECItem
*
sctsFromTLS
mozilla
:
:
pkix
:
:
Time
time
void
*
pinarg
const
nsACString
&
hostname
UniqueCERTCertList
&
builtChain
bool
saveIntermediatesInPermanentDatabase
=
false
Flags
flags
=
0
const
OriginAttributes
&
originAttributes
=
OriginAttributes
(
)
SECOidTag
*
evOidPolicy
=
nullptr
OCSPStaplingStatus
*
ocspStaplingStatus
=
nullptr
KeySizeStatus
*
keySizeStatus
=
nullptr
SHA1ModeResult
*
sha1ModeResult
=
nullptr
PinningTelemetryInfo
*
pinningTelemetryInfo
=
nullptr
CertificateTransparencyInfo
*
ctInfo
=
nullptr
)
;
enum
PinningMode
{
pinningDisabled
=
0
pinningAllowUserCAMITM
=
1
pinningStrict
=
2
pinningEnforceTestMode
=
3
}
;
enum
class
SHA1Mode
{
Allowed
=
0
Forbidden
=
1
UsedToBeBefore2016ButNowIsForbidden
=
2
ImportedRoot
=
3
ImportedRootOrBefore2016
=
4
}
;
enum
OcspDownloadConfig
{
ocspOff
=
0
ocspOn
=
1
ocspEVOnly
=
2
}
;
enum
OcspStrictConfig
{
ocspRelaxed
=
0
ocspStrict
}
;
enum
OcspGetConfig
{
ocspGetDisabled
=
0
ocspGetEnabled
=
1
}
;
enum
class
CertificateTransparencyMode
{
Disabled
=
0
TelemetryOnly
=
1
}
;
CertVerifier
(
OcspDownloadConfig
odc
OcspStrictConfig
osc
OcspGetConfig
ogc
mozilla
:
:
TimeDuration
ocspTimeoutSoft
mozilla
:
:
TimeDuration
ocspTimeoutHard
uint32_t
certShortLifetimeInDays
PinningMode
pinningMode
SHA1Mode
sha1Mode
BRNameMatchingPolicy
:
:
Mode
nameMatchingMode
NetscapeStepUpPolicy
netscapeStepUpPolicy
CertificateTransparencyMode
ctMode
DistrustedCAPolicy
distrustedCAPolicy
)
;
~
CertVerifier
(
)
;
void
ClearOCSPCache
(
)
{
mOCSPCache
.
Clear
(
)
;
}
const
OcspDownloadConfig
mOCSPDownloadConfig
;
const
bool
mOCSPStrict
;
const
bool
mOCSPGETEnabled
;
const
mozilla
:
:
TimeDuration
mOCSPTimeoutSoft
;
const
mozilla
:
:
TimeDuration
mOCSPTimeoutHard
;
const
uint32_t
mCertShortLifetimeInDays
;
const
PinningMode
mPinningMode
;
const
SHA1Mode
mSHA1Mode
;
const
BRNameMatchingPolicy
:
:
Mode
mNameMatchingMode
;
const
NetscapeStepUpPolicy
mNetscapeStepUpPolicy
;
const
CertificateTransparencyMode
mCTMode
;
const
DistrustedCAPolicy
mDistrustedCAPolicy
;
private
:
OCSPCache
mOCSPCache
;
UniquePtr
<
mozilla
:
:
ct
:
:
MultiLogCTVerifier
>
mCTVerifier
;
UniquePtr
<
mozilla
:
:
ct
:
:
CTDiversityPolicy
>
mCTDiversityPolicy
;
void
LoadKnownCTLogs
(
)
;
mozilla
:
:
pkix
:
:
Result
VerifyCertificateTransparencyPolicy
(
NSSCertDBTrustDomain
&
trustDomain
const
UniqueCERTCertList
&
builtChain
mozilla
:
:
pkix
:
:
Input
sctsFromTLS
mozilla
:
:
pkix
:
:
Time
time
CertificateTransparencyInfo
*
ctInfo
)
;
bool
SHA1ModeMoreRestrictiveThanGivenMode
(
SHA1Mode
mode
)
;
}
;
mozilla
:
:
pkix
:
:
Result
IsCertBuiltInRoot
(
CERTCertificate
*
cert
bool
&
result
)
;
mozilla
:
:
pkix
:
:
Result
CertListContainsExpectedKeys
(
const
CERTCertList
*
certList
const
char
*
hostname
mozilla
:
:
pkix
:
:
Time
time
CertVerifier
:
:
PinningMode
pinningMode
)
;
}
}
#
endif
