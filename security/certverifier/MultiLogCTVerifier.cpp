#
include
"
MultiLogCTVerifier
.
h
"
#
include
"
CTObjectsExtractor
.
h
"
#
include
"
CTSerialization
.
h
"
#
include
"
mozilla
/
Move
.
h
"
namespace
mozilla
{
namespace
ct
{
using
namespace
mozilla
:
:
pkix
;
enum
class
SCTVerifyStatus
{
UnknownLog
Invalid
OK
}
;
static
Result
StoreVerifiedSct
(
CTVerifyResult
&
result
SignedCertificateTimestamp
&
&
sct
SCTVerifyStatus
status
)
{
SCTList
*
target
;
switch
(
status
)
{
case
SCTVerifyStatus
:
:
UnknownLog
:
target
=
&
result
.
unknownLogsScts
;
break
;
case
SCTVerifyStatus
:
:
Invalid
:
target
=
&
result
.
invalidScts
;
break
;
case
SCTVerifyStatus
:
:
OK
:
target
=
&
result
.
verifiedScts
;
break
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Unexpected
SCTVerifyStatus
type
"
)
;
return
Result
:
:
FATAL_ERROR_LIBRARY_FAILURE
;
}
if
(
!
target
-
>
append
(
Move
(
sct
)
)
)
{
return
Result
:
:
FATAL_ERROR_NO_MEMORY
;
}
return
Success
;
}
void
CTVerifyResult
:
:
Reset
(
)
{
verifiedScts
.
clear
(
)
;
invalidScts
.
clear
(
)
;
unknownLogsScts
.
clear
(
)
;
decodingErrors
=
0
;
}
Result
MultiLogCTVerifier
:
:
AddLog
(
Input
publicKey
)
{
CTLogVerifier
log
;
Result
rv
=
log
.
Init
(
publicKey
)
;
if
(
rv
!
=
Success
)
{
return
rv
;
}
if
(
!
mLogs
.
append
(
Move
(
log
)
)
)
{
return
Result
:
:
FATAL_ERROR_NO_MEMORY
;
}
return
Success
;
}
Result
MultiLogCTVerifier
:
:
Verify
(
Input
cert
Input
issuerSubjectPublicKeyInfo
Input
sctListFromCert
Input
sctListFromOCSPResponse
Input
sctListFromTLSExtension
uint64_t
time
CTVerifyResult
&
result
)
{
MOZ_ASSERT
(
cert
.
GetLength
(
)
>
0
)
;
result
.
Reset
(
)
;
Result
rv
;
if
(
issuerSubjectPublicKeyInfo
.
GetLength
(
)
>
0
&
&
sctListFromCert
.
GetLength
(
)
>
0
)
{
LogEntry
precertEntry
;
rv
=
GetPrecertLogEntry
(
cert
issuerSubjectPublicKeyInfo
precertEntry
)
;
if
(
rv
!
=
Success
)
{
return
rv
;
}
rv
=
VerifySCTs
(
sctListFromCert
precertEntry
SignedCertificateTimestamp
:
:
Origin
:
:
Embedded
time
result
)
;
if
(
rv
!
=
Success
)
{
return
rv
;
}
}
LogEntry
x509Entry
;
rv
=
GetX509LogEntry
(
cert
x509Entry
)
;
if
(
rv
!
=
Success
)
{
return
rv
;
}
if
(
sctListFromOCSPResponse
.
GetLength
(
)
>
0
)
{
rv
=
VerifySCTs
(
sctListFromOCSPResponse
x509Entry
SignedCertificateTimestamp
:
:
Origin
:
:
OCSPResponse
time
result
)
;
if
(
rv
!
=
Success
)
{
return
rv
;
}
}
if
(
sctListFromTLSExtension
.
GetLength
(
)
>
0
)
{
rv
=
VerifySCTs
(
sctListFromTLSExtension
x509Entry
SignedCertificateTimestamp
:
:
Origin
:
:
TLSExtension
time
result
)
;
if
(
rv
!
=
Success
)
{
return
rv
;
}
}
return
Success
;
}
Result
MultiLogCTVerifier
:
:
VerifySCTs
(
Input
encodedSctList
const
LogEntry
&
expectedEntry
SignedCertificateTimestamp
:
:
Origin
origin
uint64_t
time
CTVerifyResult
&
result
)
{
Reader
listReader
;
Result
rv
=
DecodeSCTList
(
encodedSctList
listReader
)
;
if
(
rv
!
=
Success
)
{
result
.
decodingErrors
+
+
;
return
Success
;
}
while
(
!
listReader
.
AtEnd
(
)
)
{
Input
encodedSct
;
rv
=
ReadSCTListItem
(
listReader
encodedSct
)
;
if
(
rv
!
=
Success
)
{
result
.
decodingErrors
+
+
;
return
Success
;
}
Reader
encodedSctReader
(
encodedSct
)
;
SignedCertificateTimestamp
sct
;
rv
=
DecodeSignedCertificateTimestamp
(
encodedSctReader
sct
)
;
if
(
rv
!
=
Success
)
{
result
.
decodingErrors
+
+
;
continue
;
}
sct
.
origin
=
origin
;
rv
=
VerifySingleSCT
(
Move
(
sct
)
expectedEntry
time
result
)
;
if
(
rv
!
=
Success
)
{
return
rv
;
}
}
return
Success
;
}
Result
MultiLogCTVerifier
:
:
VerifySingleSCT
(
SignedCertificateTimestamp
&
&
sct
const
LogEntry
&
expectedEntry
uint64_t
time
CTVerifyResult
&
result
)
{
CTLogVerifier
*
matchingLog
=
nullptr
;
for
(
auto
&
log
:
mLogs
)
{
if
(
log
.
keyId
(
)
=
=
sct
.
logId
)
{
matchingLog
=
&
log
;
break
;
}
}
if
(
!
matchingLog
)
{
return
StoreVerifiedSct
(
result
Move
(
sct
)
SCTVerifyStatus
:
:
UnknownLog
)
;
}
if
(
!
matchingLog
-
>
SignatureParametersMatch
(
sct
.
signature
)
)
{
return
StoreVerifiedSct
(
result
Move
(
sct
)
SCTVerifyStatus
:
:
Invalid
)
;
}
Result
rv
=
matchingLog
-
>
Verify
(
expectedEntry
sct
)
;
if
(
rv
!
=
Success
)
{
if
(
rv
=
=
Result
:
:
ERROR_BAD_SIGNATURE
)
{
return
StoreVerifiedSct
(
result
Move
(
sct
)
SCTVerifyStatus
:
:
Invalid
)
;
}
return
rv
;
}
if
(
sct
.
timestamp
>
time
)
{
return
StoreVerifiedSct
(
result
Move
(
sct
)
SCTVerifyStatus
:
:
Invalid
)
;
}
return
StoreVerifiedSct
(
result
Move
(
sct
)
SCTVerifyStatus
:
:
OK
)
;
}
}
}
