#
include
"
OSReauthenticator
.
h
"
#
include
"
nsCocoaUtils
.
h
"
using
namespace
mozilla
;
#
include
<
CoreFoundation
/
CoreFoundation
.
h
>
#
include
<
LocalAuthentication
/
LocalAuthentication
.
h
>
static
const
int32_t
kPasswordNotSetErrorCode
=
-
1000
;
nsresult
ReauthenticateUserMacOS
(
const
nsAString
&
aPrompt
bool
&
aReauthenticated
)
{
LAContext
*
context
=
[
[
LAContext
alloc
]
init
]
;
NSString
*
prompt
=
nsCocoaUtils
:
:
ToNSString
(
aPrompt
)
;
dispatch_semaphore_t
sema
=
dispatch_semaphore_create
(
0
)
;
__block
BOOL
biometricSuccess
=
NO
;
[
context
evaluatePolicy
:
LAPolicyDeviceOwnerAuthentication
localizedReason
:
prompt
reply
:
^
(
BOOL
success
NSError
*
error
)
{
dispatch_async
(
dispatch_get_main_queue
(
)
^
{
if
(
success
|
|
[
error
code
]
=
=
kPasswordNotSetErrorCode
)
{
biometricSuccess
=
YES
;
}
dispatch_semaphore_signal
(
sema
)
;
}
)
;
}
]
;
dispatch_semaphore_wait
(
sema
DISPATCH_TIME_FOREVER
)
;
dispatch_release
(
sema
)
;
sema
=
NULL
;
aReauthenticated
=
biometricSuccess
;
[
context
release
]
;
return
NS_OK
;
}
