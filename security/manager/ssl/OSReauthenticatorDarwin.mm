#
include
"
OSReauthenticator
.
h
"
#
include
"
mozilla
/
MacStringHelpers
.
h
"
using
namespace
mozilla
;
#
include
<
CoreFoundation
/
CoreFoundation
.
h
>
#
include
<
LocalAuthentication
/
LocalAuthentication
.
h
>
static
const
int32_t
kPasswordNotSetErrorCode
=
-
1000
;
nsresult
ReauthenticateUserMacOS
(
const
nsAString
&
aPrompt
bool
&
aReauthenticated
bool
&
aIsBlankPassword
)
{
LAContext
*
context
=
[
[
LAContext
alloc
]
init
]
;
NSString
*
prompt
=
mozilla
:
:
XPCOMStringToNSString
(
aPrompt
)
;
dispatch_semaphore_t
sema
=
dispatch_semaphore_create
(
0
)
;
__block
BOOL
biometricSuccess
=
NO
;
__block
BOOL
errorPasswordNotSet
=
NO
;
[
context
evaluatePolicy
:
LAPolicyDeviceOwnerAuthentication
localizedReason
:
prompt
reply
:
^
(
BOOL
success
NSError
*
error
)
{
dispatch_async
(
dispatch_get_main_queue
(
)
^
{
errorPasswordNotSet
=
error
&
&
[
error
code
]
=
=
kPasswordNotSetErrorCode
;
biometricSuccess
=
success
|
|
errorPasswordNotSet
;
dispatch_semaphore_signal
(
sema
)
;
}
)
;
}
]
;
dispatch_semaphore_wait
(
sema
DISPATCH_TIME_FOREVER
)
;
dispatch_release
(
sema
)
;
sema
=
NULL
;
aReauthenticated
=
biometricSuccess
;
aIsBlankPassword
=
errorPasswordNotSet
;
[
context
release
]
;
return
NS_OK
;
}
