#
include
"
CryptoTask
.
h
"
#
include
"
nsNSSComponent
.
h
"
namespace
mozilla
{
nsresult
CryptoTask
:
:
Dispatch
(
const
nsACString
&
taskThreadName
)
{
MOZ_ASSERT
(
taskThreadName
.
Length
(
)
<
=
15
)
;
if
(
!
EnsureNSSInitializedChromeOrContent
(
)
)
{
return
NS_ERROR_FAILURE
;
}
nsresult
rv
=
NS_NewNamedThread
(
taskThreadName
getter_AddRefs
(
mThread
)
nullptr
nsIThreadManager
:
:
DEFAULT_STACK_SIZE
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
return
mThread
-
>
Dispatch
(
this
NS_DISPATCH_NORMAL
)
;
}
NS_IMETHODIMP
CryptoTask
:
:
Run
(
)
{
if
(
!
NS_IsMainThread
(
)
)
{
mRv
=
CalculateResult
(
)
;
NS_DispatchToMainThread
(
this
)
;
}
else
{
CallCallback
(
mRv
)
;
if
(
mThread
)
{
mThread
-
>
Shutdown
(
)
;
}
}
return
NS_OK
;
}
}
