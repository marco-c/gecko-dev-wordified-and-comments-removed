#
include
"
nsSecureBrowserUIImpl
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIChannel
.
h
"
#
include
"
nsDocShell
.
h
"
#
include
"
nsIDocShellTreeItem
.
h
"
#
include
"
nsGlobalWindow
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsITransportSecurityInfo
.
h
"
#
include
"
nsIWebProgress
.
h
"
using
namespace
mozilla
;
LazyLogModule
gSecureBrowserUILog
(
"
nsSecureBrowserUI
"
)
;
nsSecureBrowserUIImpl
:
:
nsSecureBrowserUIImpl
(
)
:
mState
(
0
)
mEvent
(
0
)
mIsSecureContext
(
false
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
NS_IMPL_ISUPPORTS
(
nsSecureBrowserUIImpl
nsISecureBrowserUI
nsIWebProgressListener
nsISupportsWeakReference
)
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
Init
(
nsIDocShell
*
aDocShell
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG
(
aDocShell
)
;
aDocShell
-
>
SetSecurityUI
(
this
)
;
nsresult
rv
;
mDocShell
=
do_GetWeakReference
(
aDocShell
&
rv
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
nsCOMPtr
<
nsIWebProgress
>
wp
(
do_GetInterface
(
aDocShell
)
)
;
if
(
!
wp
)
{
return
NS_ERROR_FAILURE
;
}
mWebProgress
=
do_GetWeakReference
(
wp
&
rv
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
return
wp
-
>
AddProgressListener
(
this
nsIWebProgress
:
:
NOTIFY_LOCATION
)
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
GetState
(
uint32_t
*
aState
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG
(
aState
)
;
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
GetState
%
p
"
this
)
)
;
CheckForMixedContent
(
)
;
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
mState
:
%
x
"
mState
)
)
;
*
aState
=
mState
;
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
GetIsSecureContext
(
bool
*
aIsSecureContext
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG
(
aIsSecureContext
)
;
*
aIsSecureContext
=
mIsSecureContext
;
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
GetContentBlockingEvent
(
uint32_t
*
aEvent
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG
(
aEvent
)
;
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
GetContentBlockingEvent
%
p
"
this
)
)
;
CheckForContentBlockingEvents
(
)
;
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
mEvent
:
%
x
"
mEvent
)
)
;
*
aEvent
=
mEvent
;
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
GetSecInfo
(
nsITransportSecurityInfo
*
*
result
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG_POINTER
(
result
)
;
*
result
=
mTopLevelSecurityInfo
;
NS_IF_ADDREF
(
*
result
)
;
return
NS_OK
;
}
already_AddRefed
<
dom
:
:
Document
>
nsSecureBrowserUIImpl
:
:
PrepareForContentChecks
(
)
{
nsCOMPtr
<
nsIDocShell
>
docShell
=
do_QueryReferent
(
mDocShell
)
;
if
(
!
docShell
)
{
return
nullptr
;
}
if
(
docShell
-
>
ItemType
(
)
=
=
nsIDocShellTreeItem
:
:
typeContent
)
{
nsCOMPtr
<
nsIDocShellTreeItem
>
docShellTreeItem
(
docShell
)
;
nsCOMPtr
<
nsIDocShellTreeItem
>
sameTypeRoot
;
Unused
<
<
docShellTreeItem
-
>
GetInProcessSameTypeRootTreeItem
(
getter_AddRefs
(
sameTypeRoot
)
)
;
MOZ_ASSERT
(
sameTypeRoot
"
No
document
shell
root
tree
item
from
document
shell
tree
item
!
"
)
;
docShell
=
do_QueryInterface
(
sameTypeRoot
)
;
if
(
!
docShell
)
{
return
nullptr
;
}
}
RefPtr
<
dom
:
:
Document
>
doc
=
docShell
-
>
GetDocument
(
)
;
return
doc
.
forget
(
)
;
}
void
nsSecureBrowserUIImpl
:
:
CheckForMixedContent
(
)
{
RefPtr
<
dom
:
:
Document
>
doc
=
PrepareForContentChecks
(
)
;
if
(
!
doc
)
{
return
;
}
if
(
(
(
mState
&
STATE_IS_SECURE
)
!
=
0
)
|
|
(
(
mState
&
STATE_IS_BROKEN
)
!
=
0
)
)
{
if
(
doc
-
>
GetHasMixedActiveContentLoaded
(
)
)
{
mState
|
=
STATE_IS_BROKEN
|
STATE_LOADED_MIXED_ACTIVE_CONTENT
;
mState
&
=
~
STATE_IS_SECURE
;
}
if
(
doc
-
>
GetHasMixedDisplayContentLoaded
(
)
)
{
mState
|
=
STATE_IS_BROKEN
|
STATE_LOADED_MIXED_DISPLAY_CONTENT
;
mState
&
=
~
STATE_IS_SECURE
;
}
if
(
doc
-
>
GetHasMixedActiveContentBlocked
(
)
)
{
mState
|
=
STATE_BLOCKED_MIXED_ACTIVE_CONTENT
;
}
if
(
doc
-
>
GetHasMixedDisplayContentBlocked
(
)
)
{
mState
|
=
STATE_BLOCKED_MIXED_DISPLAY_CONTENT
;
}
}
}
void
nsSecureBrowserUIImpl
:
:
CheckForContentBlockingEvents
(
)
{
RefPtr
<
dom
:
:
Document
>
doc
=
PrepareForContentChecks
(
)
;
if
(
!
doc
)
{
return
;
}
if
(
doc
-
>
GetHasTrackingContentBlocked
(
)
)
{
mEvent
|
=
STATE_BLOCKED_TRACKING_CONTENT
;
}
if
(
doc
-
>
GetHasTrackingContentLoaded
(
)
)
{
mEvent
|
=
STATE_LOADED_TRACKING_CONTENT
;
}
if
(
doc
-
>
GetHasFingerprintingContentBlocked
(
)
)
{
mEvent
|
=
STATE_BLOCKED_FINGERPRINTING_CONTENT
;
}
if
(
doc
-
>
GetHasFingerprintingContentLoaded
(
)
)
{
mEvent
|
=
STATE_LOADED_FINGERPRINTING_CONTENT
;
}
if
(
doc
-
>
GetHasCryptominingContentBlocked
(
)
)
{
mEvent
|
=
STATE_BLOCKED_CRYPTOMINING_CONTENT
;
}
if
(
doc
-
>
GetHasCryptominingContentLoaded
(
)
)
{
mEvent
|
=
STATE_LOADED_CRYPTOMINING_CONTENT
;
}
if
(
doc
-
>
GetHasSocialTrackingContentBlocked
(
)
)
{
mEvent
|
=
STATE_BLOCKED_SOCIALTRACKING_CONTENT
;
}
if
(
doc
-
>
GetHasSocialTrackingContentLoaded
(
)
)
{
mEvent
|
=
STATE_LOADED_SOCIALTRACKING_CONTENT
;
}
if
(
doc
-
>
GetHasCookiesBlockedByPermission
(
)
)
{
mEvent
|
=
STATE_COOKIES_BLOCKED_BY_PERMISSION
;
}
if
(
doc
-
>
GetHasTrackingCookiesBlocked
(
)
)
{
mEvent
|
=
STATE_COOKIES_BLOCKED_TRACKER
;
}
if
(
doc
-
>
GetHasForeignCookiesBlocked
(
)
)
{
mEvent
|
=
STATE_COOKIES_BLOCKED_FOREIGN
;
}
if
(
doc
-
>
GetHasAllCookiesBlocked
(
)
)
{
mEvent
|
=
STATE_COOKIES_BLOCKED_ALL
;
}
if
(
doc
-
>
GetHasCookiesLoaded
(
)
)
{
mEvent
|
=
STATE_COOKIES_LOADED
;
}
if
(
doc
-
>
GetHasTrackerCookiesLoaded
(
)
)
{
mEvent
|
=
STATE_COOKIES_LOADED_TRACKER
;
}
if
(
doc
-
>
GetHasSocialTrackerCookiesLoaded
(
)
)
{
mEvent
|
=
STATE_COOKIES_LOADED_SOCIALTRACKER
;
}
}
static
nsresult
URICanBeConsideredSecure
(
nsIURI
*
uri
bool
&
canBeConsideredSecure
)
{
MOZ_ASSERT
(
uri
)
;
NS_ENSURE_ARG
(
uri
)
;
canBeConsideredSecure
=
false
;
nsCOMPtr
<
nsIURI
>
innermostURI
=
NS_GetInnermostURI
(
uri
)
;
if
(
!
innermostURI
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
couldn
'
t
get
innermost
URI
"
)
)
;
return
NS_ERROR_FAILURE
;
}
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
innermost
URI
is
'
%
s
'
"
innermostURI
-
>
GetSpecOrDefault
(
)
.
get
(
)
)
)
;
canBeConsideredSecure
=
innermostURI
-
>
SchemeIs
(
"
https
"
)
;
return
NS_OK
;
}
static
void
GetSecurityInfoFromChannel
(
nsIChannel
*
channel
nsITransportSecurityInfo
*
*
securityInfoOut
)
{
MOZ_ASSERT
(
channel
)
;
MOZ_ASSERT
(
securityInfoOut
)
;
NS_ENSURE_TRUE_VOID
(
channel
)
;
NS_ENSURE_TRUE_VOID
(
securityInfoOut
)
;
*
securityInfoOut
=
nullptr
;
nsCOMPtr
<
nsISupports
>
securityInfoSupports
;
nsresult
rv
=
channel
-
>
GetSecurityInfo
(
getter_AddRefs
(
securityInfoSupports
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
nsCOMPtr
<
nsITransportSecurityInfo
>
securityInfo
(
do_QueryInterface
(
securityInfoSupports
)
)
;
securityInfo
.
forget
(
securityInfoOut
)
;
}
nsresult
nsSecureBrowserUIImpl
:
:
UpdateStateAndSecurityInfo
(
nsIChannel
*
channel
nsIURI
*
uri
)
{
MOZ_ASSERT
(
channel
)
;
MOZ_ASSERT
(
uri
)
;
NS_ENSURE_ARG
(
channel
)
;
NS_ENSURE_ARG
(
uri
)
;
mState
=
STATE_IS_INSECURE
;
mTopLevelSecurityInfo
=
nullptr
;
bool
canBeConsideredSecure
;
nsresult
rv
=
URICanBeConsideredSecure
(
uri
canBeConsideredSecure
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
if
(
!
canBeConsideredSecure
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
URI
can
'
t
be
considered
secure
"
)
)
;
return
NS_OK
;
}
nsCOMPtr
<
nsITransportSecurityInfo
>
securityInfo
;
GetSecurityInfoFromChannel
(
channel
getter_AddRefs
(
securityInfo
)
)
;
if
(
securityInfo
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
we
have
a
security
info
%
p
"
securityInfo
.
get
(
)
)
)
;
rv
=
securityInfo
-
>
GetSecurityState
(
&
mState
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
if
(
mState
=
=
STATE_IS_INSECURE
)
{
return
NS_OK
;
}
mTopLevelSecurityInfo
=
securityInfo
;
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
set
mTopLevelSecurityInfo
"
)
)
;
bool
isEV
;
rv
=
mTopLevelSecurityInfo
-
>
GetIsExtendedValidation
(
&
isEV
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
if
(
isEV
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
is
EV
"
)
)
;
mState
|
=
STATE_IDENTITY_EV_TOPLEVEL
;
}
CheckForMixedContent
(
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
OnLocationChange
(
nsIWebProgress
*
aWebProgress
nsIRequest
*
aRequest
nsIURI
*
aLocation
uint32_t
aFlags
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG
(
aWebProgress
)
;
NS_ENSURE_ARG
(
aLocation
)
;
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
%
p
OnLocationChange
:
%
p
%
p
%
s
%
x
"
this
aWebProgress
aRequest
aLocation
-
>
GetSpecOrDefault
(
)
.
get
(
)
aFlags
)
)
;
nsCOMPtr
<
nsIWebProgress
>
originalWebProgress
=
do_QueryReferent
(
mWebProgress
)
;
if
(
aWebProgress
!
=
originalWebProgress
)
{
return
NS_OK
;
}
if
(
aFlags
&
LOCATION_CHANGE_SAME_DOCUMENT
)
{
return
NS_OK
;
}
mState
=
0
;
mEvent
=
0
;
mIsSecureContext
=
false
;
mTopLevelSecurityInfo
=
nullptr
;
if
(
aFlags
&
LOCATION_CHANGE_ERROR_PAGE
)
{
mState
=
STATE_IS_INSECURE
;
mTopLevelSecurityInfo
=
nullptr
;
}
else
{
nsCOMPtr
<
nsIChannel
>
channel
(
do_QueryInterface
(
aRequest
)
)
;
if
(
channel
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
we
have
a
channel
%
p
"
channel
.
get
(
)
)
)
;
nsresult
rv
=
UpdateStateAndSecurityInfo
(
channel
aLocation
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
Failed
to
update
security
info
.
"
"
Setting
everything
to
'
not
secure
'
to
be
safe
.
"
)
)
;
mState
=
STATE_IS_INSECURE
;
mTopLevelSecurityInfo
=
nullptr
;
}
}
nsCOMPtr
<
mozIDOMWindowProxy
>
domWindow
;
aWebProgress
-
>
GetDOMWindow
(
getter_AddRefs
(
domWindow
)
)
;
if
(
domWindow
)
{
nsPIDOMWindowOuter
*
outerWindow
=
nsPIDOMWindowOuter
:
:
From
(
domWindow
)
;
if
(
outerWindow
)
{
nsGlobalWindowInner
*
innerWindow
=
nsGlobalWindowInner
:
:
Cast
(
outerWindow
-
>
GetCurrentInnerWindow
(
)
)
;
if
(
innerWindow
)
{
mIsSecureContext
=
innerWindow
-
>
IsSecureContext
(
)
;
}
}
}
}
nsCOMPtr
<
nsIDocShell
>
docShell
=
do_QueryReferent
(
mDocShell
)
;
if
(
docShell
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
calling
OnSecurityChange
%
p
%
x
"
aRequest
mState
)
)
;
nsDocShell
:
:
Cast
(
docShell
)
-
>
nsDocLoader
:
:
OnSecurityChange
(
aRequest
mState
)
;
}
else
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
no
docShell
?
"
)
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
OnStateChange
(
nsIWebProgress
*
nsIRequest
*
uint32_t
nsresult
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Should
have
been
excluded
in
AddProgressListener
(
)
"
)
;
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
OnProgressChange
(
nsIWebProgress
*
nsIRequest
*
int32_t
int32_t
int32_t
int32_t
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Should
have
been
excluded
in
AddProgressListener
(
)
"
)
;
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUIImpl
:
:
OnStatusChange
(
nsIWebProgress
*
nsIRequest
*
nsresult
const
char16_t
*
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Should
have
been
excluded
in
AddProgressListener
(
)
"
)
;
return
NS_OK
;
}
nsresult
nsSecureBrowserUIImpl
:
:
OnSecurityChange
(
nsIWebProgress
*
nsIRequest
*
uint32_t
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Should
have
been
excluded
in
AddProgressListener
(
)
"
)
;
return
NS_OK
;
}
nsresult
nsSecureBrowserUIImpl
:
:
OnContentBlockingEvent
(
nsIWebProgress
*
nsIRequest
*
uint32_t
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Should
have
been
excluded
in
AddProgressListener
(
)
"
)
;
return
NS_OK
;
}
