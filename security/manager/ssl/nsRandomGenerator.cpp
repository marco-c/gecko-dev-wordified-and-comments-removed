#
include
"
nsRandomGenerator
.
h
"
#
include
"
ScopedNSSTypes
.
h
"
#
include
"
nsNSSComponent
.
h
"
#
include
"
pk11pub
.
h
"
#
include
"
prerror
.
h
"
#
include
"
secerr
.
h
"
NS_IMPL_ISUPPORTS
(
nsRandomGenerator
nsIRandomGenerator
)
NS_IMETHODIMP
nsRandomGenerator
:
:
GenerateRandomBytes
(
uint32_t
aLength
uint8_t
*
*
aBuffer
)
{
NS_ENSURE_ARG_POINTER
(
aBuffer
)
;
*
aBuffer
=
nullptr
;
if
(
isAlreadyShutDown
(
)
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
mozilla
:
:
UniquePK11SlotInfo
slot
(
PK11_GetInternalSlot
(
)
)
;
if
(
!
slot
)
{
return
NS_ERROR_FAILURE
;
}
auto
buf
=
static_cast
<
uint8_t
*
>
(
moz_xmalloc
(
aLength
)
)
;
if
(
!
buf
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
SECStatus
srv
=
PK11_GenerateRandomOnSlot
(
slot
.
get
(
)
buf
aLength
)
;
if
(
srv
!
=
SECSuccess
)
{
free
(
buf
)
;
return
NS_ERROR_FAILURE
;
}
*
aBuffer
=
buf
;
return
NS_OK
;
}
nsRandomGenerator
:
:
~
nsRandomGenerator
(
)
{
if
(
isAlreadyShutDown
(
)
)
{
return
;
}
shutdown
(
ShutdownCalledFrom
:
:
Object
)
;
}
