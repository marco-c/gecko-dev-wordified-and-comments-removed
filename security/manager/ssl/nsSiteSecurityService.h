#
ifndef
__nsSiteSecurityService_h__
#
define
__nsSiteSecurityService_h__
#
include
"
mozilla
/
BasePrincipal
.
h
"
#
include
"
mozilla
/
Dafsa
.
h
"
#
include
"
mozilla
/
DataStorage
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsISiteSecurityService
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
mozpkix
/
pkixtypes
.
h
"
#
include
"
prtime
.
h
"
class
nsIURI
;
class
nsITransportSecurityInfo
;
using
mozilla
:
:
OriginAttributes
;
#
define
NS_SITE_SECURITY_SERVICE_CID
\
{
\
0x16955eee
0x6c48
0x4152
{
\
0x93
0x09
0xc4
0x2a
0x46
0x51
0x38
0xa1
\
}
\
}
enum
SecurityPropertyState
{
SecurityPropertyUnset
=
nsISiteSecurityState
:
:
SECURITY_PROPERTY_UNSET
SecurityPropertySet
=
nsISiteSecurityState
:
:
SECURITY_PROPERTY_SET
SecurityPropertyKnockout
=
nsISiteSecurityState
:
:
SECURITY_PROPERTY_KNOCKOUT
SecurityPropertyNegative
=
nsISiteSecurityState
:
:
SECURITY_PROPERTY_NEGATIVE
}
;
enum
SecurityPropertySource
{
SourceUnknown
=
nsISiteSecurityService
:
:
SOURCE_UNKNOWN
SourcePreload
=
nsISiteSecurityService
:
:
SOURCE_PRELOAD_LIST
SourceOrganic
=
nsISiteSecurityService
:
:
SOURCE_ORGANIC_REQUEST
}
;
class
SiteHPKPState
:
public
nsISiteHPKPState
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSISITEHPKPSTATE
NS_DECL_NSISITESECURITYSTATE
SiteHPKPState
(
)
;
SiteHPKPState
(
const
nsCString
&
aHost
const
OriginAttributes
&
aOriginAttributes
const
nsCString
&
aStateString
)
;
SiteHPKPState
(
const
nsCString
&
aHost
const
OriginAttributes
&
aOriginAttributes
PRTime
aExpireTime
SecurityPropertyState
aState
bool
aIncludeSubdomains
const
nsTArray
<
nsCString
>
&
SHA256keys
)
;
nsCString
mHostname
;
OriginAttributes
mOriginAttributes
;
PRTime
mExpireTime
;
SecurityPropertyState
mState
;
bool
mIncludeSubdomains
;
nsTArray
<
nsCString
>
mSHA256keys
;
bool
IsExpired
(
mozilla
:
:
pkix
:
:
Time
aTime
)
{
if
(
aTime
>
mozilla
:
:
pkix
:
:
TimeFromEpochInSeconds
(
mExpireTime
/
PR_MSEC_PER_SEC
)
)
{
return
true
;
}
return
false
;
}
void
ToString
(
nsCString
&
aString
)
;
protected
:
virtual
~
SiteHPKPState
(
)
{
}
;
}
;
class
SiteHSTSState
:
public
nsISiteHSTSState
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSISITEHSTSSTATE
NS_DECL_NSISITESECURITYSTATE
SiteHSTSState
(
const
nsCString
&
aHost
const
OriginAttributes
&
aOriginAttributes
const
nsCString
&
aStateString
)
;
SiteHSTSState
(
const
nsCString
&
aHost
const
OriginAttributes
&
aOriginAttributes
PRTime
aHSTSExpireTime
SecurityPropertyState
aHSTSState
bool
aHSTSIncludeSubdomains
SecurityPropertySource
aSource
)
;
nsCString
mHostname
;
OriginAttributes
mOriginAttributes
;
PRTime
mHSTSExpireTime
;
SecurityPropertyState
mHSTSState
;
bool
mHSTSIncludeSubdomains
;
SecurityPropertySource
mHSTSSource
;
bool
IsExpired
(
uint32_t
aType
)
{
if
(
mHSTSExpireTime
=
=
0
)
{
return
false
;
}
PRTime
now
=
PR_Now
(
)
/
PR_USEC_PER_MSEC
;
if
(
now
>
mHSTSExpireTime
)
{
return
true
;
}
return
false
;
}
void
ToString
(
nsCString
&
aString
)
;
protected
:
virtual
~
SiteHSTSState
(
)
{
}
}
;
struct
nsSTSPreload
;
class
nsSiteSecurityService
:
public
nsISiteSecurityService
public
nsIObserver
{
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIOBSERVER
NS_DECL_NSISITESECURITYSERVICE
nsSiteSecurityService
(
)
;
nsresult
Init
(
)
;
protected
:
virtual
~
nsSiteSecurityService
(
)
;
private
:
nsresult
GetHost
(
nsIURI
*
aURI
nsACString
&
aResult
)
;
nsresult
SetHSTSState
(
uint32_t
aType
const
char
*
aHost
int64_t
maxage
bool
includeSubdomains
uint32_t
flags
SecurityPropertyState
aHSTSState
SecurityPropertySource
aSource
const
OriginAttributes
&
aOriginAttributes
)
;
nsresult
ProcessHeaderInternal
(
uint32_t
aType
nsIURI
*
aSourceURI
const
nsCString
&
aHeader
nsITransportSecurityInfo
*
aSecInfo
uint32_t
aFlags
SecurityPropertySource
aSource
const
OriginAttributes
&
aOriginAttributes
uint64_t
*
aMaxAge
bool
*
aIncludeSubdomains
uint32_t
*
aFailureResult
)
;
nsresult
ProcessSTSHeader
(
nsIURI
*
aSourceURI
const
nsCString
&
aHeader
uint32_t
flags
SecurityPropertySource
aSource
const
OriginAttributes
&
aOriginAttributes
uint64_t
*
aMaxAge
bool
*
aIncludeSubdomains
uint32_t
*
aFailureResult
)
;
nsresult
ProcessPKPHeader
(
nsIURI
*
aSourceURI
const
nsCString
&
aHeader
nsITransportSecurityInfo
*
aSecInfo
uint32_t
flags
const
OriginAttributes
&
aOriginAttributes
uint64_t
*
aMaxAge
bool
*
aIncludeSubdomains
uint32_t
*
aFailureResult
)
;
nsresult
SetHPKPState
(
const
char
*
aHost
SiteHPKPState
&
entry
uint32_t
flags
bool
aIsPreload
const
OriginAttributes
&
aOriginAttributes
)
;
nsresult
MarkHostAsNotHSTS
(
uint32_t
aType
const
nsAutoCString
&
aHost
uint32_t
aFlags
bool
aIsPreload
const
OriginAttributes
&
aOriginAttributes
)
;
nsresult
ResetStateInternal
(
uint32_t
aType
nsIURI
*
aURI
uint32_t
aFlags
const
OriginAttributes
&
aOriginAttributes
)
;
bool
HostHasHSTSEntry
(
const
nsAutoCString
&
aHost
bool
aRequireIncludeSubdomains
uint32_t
aFlags
const
OriginAttributes
&
aOriginAttributes
bool
*
aResult
bool
*
aCached
SecurityPropertySource
*
aSource
)
;
bool
GetPreloadStatus
(
const
nsACString
&
aHost
bool
*
aIncludeSubdomains
=
nullptr
)
const
;
nsresult
IsSecureHost
(
uint32_t
aType
const
nsACString
&
aHost
uint32_t
aFlags
const
OriginAttributes
&
aOriginAttributes
bool
*
aCached
SecurityPropertySource
*
aSource
bool
*
aResult
)
;
uint64_t
mMaxMaxAge
;
bool
mUsePreloadList
;
int64_t
mPreloadListTimeOffset
;
bool
mHPKPEnabled
;
bool
mProcessPKPHeadersFromNonBuiltInRoots
;
RefPtr
<
mozilla
:
:
DataStorage
>
mSiteStateStorage
;
RefPtr
<
mozilla
:
:
DataStorage
>
mPreloadStateStorage
;
const
mozilla
:
:
Dafsa
mDafsa
;
}
;
#
endif
