#
ifndef
_INC_NSSShutDown_H
#
define
_INC_NSSShutDown_H
#
include
"
nscore
.
h
"
#
include
"
nspr
.
h
"
#
include
"
PLDHashTable
.
h
"
#
include
"
mozilla
/
CondVar
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
class
nsNSSShutDownObject
;
class
nsOnPK11LogoutCancelObject
;
class
nsNSSActivityState
{
public
:
nsNSSActivityState
(
)
;
~
nsNSSActivityState
(
)
;
void
enter
(
)
;
void
leave
(
)
;
PRStatus
restrictActivityToCurrentThread
(
)
;
void
releaseCurrentThreadActivityRestriction
(
)
;
private
:
mozilla
:
:
Mutex
mNSSActivityStateLock
;
mozilla
:
:
CondVar
mNSSActivityChanged
;
int
mNSSActivityCounter
;
PRThread
*
mNSSRestrictedThread
;
}
;
class
nsNSSShutDownPreventionLock
{
public
:
nsNSSShutDownPreventionLock
(
)
;
~
nsNSSShutDownPreventionLock
(
)
;
}
;
class
nsNSSShutDownList
{
public
:
static
void
shutdown
(
)
;
static
void
remember
(
nsNSSShutDownObject
*
o
)
;
static
void
forget
(
nsNSSShutDownObject
*
o
)
;
static
void
remember
(
nsOnPK11LogoutCancelObject
*
o
)
;
static
void
forget
(
nsOnPK11LogoutCancelObject
*
o
)
;
static
nsresult
evaporateAllNSSResources
(
)
;
static
nsresult
doPK11Logout
(
)
;
static
void
enterActivityState
(
)
;
static
void
leaveActivityState
(
)
;
private
:
static
bool
construct
(
const
mozilla
:
:
StaticMutexAutoLock
&
)
;
nsNSSShutDownList
(
)
;
~
nsNSSShutDownList
(
)
;
protected
:
PLDHashTable
mObjects
;
PLDHashTable
mPK11LogoutCancelObjects
;
nsNSSActivityState
mActivityState
;
}
;
class
nsNSSShutDownObject
{
public
:
enum
CalledFromType
{
calledFromList
calledFromObject
}
;
nsNSSShutDownObject
(
)
{
mAlreadyShutDown
=
false
;
nsNSSShutDownList
:
:
remember
(
this
)
;
}
virtual
~
nsNSSShutDownObject
(
)
{
}
void
shutdown
(
CalledFromType
calledFrom
)
{
if
(
!
mAlreadyShutDown
)
{
if
(
calledFromObject
=
=
calledFrom
)
{
nsNSSShutDownList
:
:
forget
(
this
)
;
}
if
(
calledFromList
=
=
calledFrom
)
{
virtualDestroyNSSReference
(
)
;
}
mAlreadyShutDown
=
true
;
}
}
bool
isAlreadyShutDown
(
)
const
{
return
mAlreadyShutDown
;
}
protected
:
virtual
void
virtualDestroyNSSReference
(
)
=
0
;
private
:
volatile
bool
mAlreadyShutDown
;
}
;
class
nsOnPK11LogoutCancelObject
{
public
:
nsOnPK11LogoutCancelObject
(
)
:
mIsLoggedOut
(
false
)
{
nsNSSShutDownList
:
:
remember
(
this
)
;
}
virtual
~
nsOnPK11LogoutCancelObject
(
)
{
nsNSSShutDownList
:
:
forget
(
this
)
;
}
void
logout
(
)
{
mIsLoggedOut
=
true
;
}
bool
isPK11LoggedOut
(
)
{
return
mIsLoggedOut
;
}
private
:
volatile
bool
mIsLoggedOut
;
}
;
#
endif
