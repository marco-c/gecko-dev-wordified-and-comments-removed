#
include
"
nsSecureBrowserUI
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIChannel
.
h
"
#
include
"
nsDocShell
.
h
"
#
include
"
nsIDocShellTreeItem
.
h
"
#
include
"
nsGlobalWindow
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsITransportSecurityInfo
.
h
"
#
include
"
nsIWebProgress
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
mozilla
/
dom
/
CanonicalBrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
WindowGlobalParent
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
nsIBrowser
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
LazyLogModule
gSecureBrowserUILog
(
"
nsSecureBrowserUI
"
)
;
nsSecureBrowserUI
:
:
nsSecureBrowserUI
(
CanonicalBrowsingContext
*
aBrowsingContext
)
:
mState
(
0
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
mBrowsingContextId
=
aBrowsingContext
-
>
Id
(
)
;
}
NS_IMPL_ISUPPORTS
(
nsSecureBrowserUI
nsISecureBrowserUI
nsISupportsWeakReference
)
NS_IMETHODIMP
nsSecureBrowserUI
:
:
GetState
(
uint32_t
*
aState
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG
(
aState
)
;
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
GetState
%
p
mState
:
%
x
"
this
mState
)
)
;
*
aState
=
mState
;
return
NS_OK
;
}
static
bool
GetWebProgressListener
(
CanonicalBrowsingContext
*
aBrowsingContext
nsIBrowser
*
*
aOutBrowser
nsIWebProgress
*
*
aOutManager
nsIWebProgressListener
*
*
aOutListener
)
{
MOZ_ASSERT
(
aOutBrowser
)
;
MOZ_ASSERT
(
aOutManager
)
;
MOZ_ASSERT
(
aOutListener
)
;
nsCOMPtr
<
nsIBrowser
>
browser
;
RefPtr
<
Element
>
currentElement
=
aBrowsingContext
-
>
GetEmbedderElement
(
)
;
while
(
currentElement
)
{
browser
=
currentElement
-
>
AsBrowser
(
)
;
if
(
browser
)
{
break
;
}
BrowsingContext
*
browsingContext
=
currentElement
-
>
OwnerDoc
(
)
-
>
GetBrowsingContext
(
)
;
currentElement
=
browsingContext
?
browsingContext
-
>
GetEmbedderElement
(
)
:
nullptr
;
}
if
(
!
browser
)
{
return
false
;
}
nsCOMPtr
<
nsIWebProgress
>
manager
;
nsresult
rv
=
browser
-
>
GetRemoteWebProgressManager
(
getter_AddRefs
(
manager
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
browser
.
forget
(
aOutBrowser
)
;
return
true
;
}
nsCOMPtr
<
nsIWebProgressListener
>
listener
=
do_QueryInterface
(
manager
)
;
if
(
!
listener
)
{
browser
.
forget
(
aOutBrowser
)
;
manager
.
forget
(
aOutManager
)
;
return
true
;
}
browser
.
forget
(
aOutBrowser
)
;
manager
.
forget
(
aOutManager
)
;
listener
.
forget
(
aOutListener
)
;
return
true
;
}
void
nsSecureBrowserUI
:
:
UpdateForLocationOrMixedContentChange
(
)
{
RefPtr
<
WindowGlobalParent
>
win
=
GetCurrentWindow
(
)
;
mState
=
nsIWebProgressListener
:
:
STATE_IS_INSECURE
;
nsCOMPtr
<
nsITransportSecurityInfo
>
securityInfo
;
if
(
win
&
&
win
-
>
GetIsSecure
(
)
)
{
securityInfo
=
win
-
>
GetSecurityInfo
(
)
;
if
(
securityInfo
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
we
have
a
security
info
%
p
"
securityInfo
.
get
(
)
)
)
;
nsresult
rv
=
securityInfo
-
>
GetSecurityState
(
&
mState
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
mState
!
=
nsIWebProgressListener
:
:
STATE_IS_INSECURE
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
set
mTopLevelSecurityInfo
"
)
)
;
bool
isEV
;
rv
=
securityInfo
-
>
GetIsExtendedValidation
(
&
isEV
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
isEV
)
{
MOZ_LOG
(
gSecureBrowserUILog
LogLevel
:
:
Debug
(
"
is
EV
"
)
)
;
mState
|
=
nsIWebProgressListener
:
:
STATE_IDENTITY_EV_TOPLEVEL
;
}
}
}
}
if
(
win
)
{
mState
|
=
win
-
>
GetMixedContentSecurityFlags
(
)
;
}
static
const
uint32_t
kLoadedMixedContentFlags
=
nsIWebProgressListener
:
:
STATE_LOADED_MIXED_DISPLAY_CONTENT
|
nsIWebProgressListener
:
:
STATE_LOADED_MIXED_ACTIVE_CONTENT
;
if
(
win
&
&
win
-
>
GetIsSecure
(
)
&
&
(
mState
&
kLoadedMixedContentFlags
)
)
{
mState
=
mState
>
>
4
<
<
4
;
mState
|
=
nsIWebProgressListener
:
:
STATE_IS_BROKEN
;
}
RefPtr
<
CanonicalBrowsingContext
>
ctx
=
CanonicalBrowsingContext
:
:
Get
(
mBrowsingContextId
)
;
if
(
!
ctx
)
{
return
;
}
nsCOMPtr
<
nsIBrowser
>
browser
;
nsCOMPtr
<
nsIWebProgress
>
manager
;
nsCOMPtr
<
nsIWebProgressListener
>
managerAsListener
;
if
(
!
GetWebProgressListener
(
ctx
getter_AddRefs
(
browser
)
getter_AddRefs
(
manager
)
getter_AddRefs
(
managerAsListener
)
)
)
{
return
;
}
if
(
managerAsListener
)
{
Unused
<
<
managerAsListener
-
>
OnSecurityChange
(
nullptr
nullptr
mState
)
;
}
if
(
ctx
-
>
GetDocShell
(
)
)
{
nsDocShell
*
nativeDocShell
=
nsDocShell
:
:
Cast
(
ctx
-
>
GetDocShell
(
)
)
;
nativeDocShell
-
>
nsDocLoader
:
:
OnSecurityChange
(
nullptr
mState
)
;
}
}
NS_IMETHODIMP
nsSecureBrowserUI
:
:
GetIsSecureContext
(
bool
*
aIsSecureContext
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG
(
aIsSecureContext
)
;
if
(
WindowGlobalParent
*
parent
=
GetCurrentWindow
(
)
)
{
*
aIsSecureContext
=
parent
-
>
GetIsSecureContext
(
)
;
}
else
{
*
aIsSecureContext
=
false
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsSecureBrowserUI
:
:
GetSecInfo
(
nsITransportSecurityInfo
*
*
result
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
NS_ENSURE_ARG_POINTER
(
result
)
;
if
(
WindowGlobalParent
*
parent
=
GetCurrentWindow
(
)
)
{
*
result
=
parent
-
>
GetSecurityInfo
(
)
;
}
NS_IF_ADDREF
(
*
result
)
;
return
NS_OK
;
}
WindowGlobalParent
*
nsSecureBrowserUI
:
:
GetCurrentWindow
(
)
{
RefPtr
<
CanonicalBrowsingContext
>
ctx
=
CanonicalBrowsingContext
:
:
Get
(
mBrowsingContextId
)
;
if
(
!
ctx
)
{
return
nullptr
;
}
return
ctx
-
>
GetCurrentWindowGlobal
(
)
;
}
