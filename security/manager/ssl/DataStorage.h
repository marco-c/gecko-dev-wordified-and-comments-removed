#
ifndef
mozilla_DataStorage_h
#
define
mozilla_DataStorage_h
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
#
include
"
nsString
.
h
"
class
psm_DataStorageTest
;
namespace
mozilla
{
class
DataStorageMemoryReporter
;
namespace
dom
{
class
ContentChild
;
class
DataStorageEntry
;
class
DataStorageItem
;
}
enum
DataStorageType
{
DataStorage_Persistent
DataStorage_Temporary
DataStorage_Private
}
;
enum
class
DataStorageClass
{
#
define
DATA_STORAGE
(
_
)
_
#
include
"
mozilla
/
DataStorageList
.
h
"
#
undef
DATA_STORAGE
}
;
class
DataStorage
:
public
nsIObserver
{
typedef
dom
:
:
DataStorageItem
DataStorageItem
;
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIOBSERVER
static
already_AddRefed
<
DataStorage
>
Get
(
DataStorageClass
aFilename
)
;
static
already_AddRefed
<
DataStorage
>
GetIfExists
(
DataStorageClass
aFilename
)
;
nsresult
Init
(
bool
&
aDataWillPersist
const
InfallibleTArray
<
mozilla
:
:
dom
:
:
DataStorageItem
>
*
aItems
=
nullptr
)
;
nsCString
Get
(
const
nsCString
&
aKey
DataStorageType
aType
)
;
nsresult
Put
(
const
nsCString
&
aKey
const
nsCString
&
aValue
DataStorageType
aType
)
;
void
Remove
(
const
nsCString
&
aKey
DataStorageType
aType
)
;
nsresult
Clear
(
)
;
static
void
GetAllFileNames
(
nsTArray
<
nsString
>
&
aItems
)
;
static
void
GetAllChildProcessData
(
nsTArray
<
mozilla
:
:
dom
:
:
DataStorageEntry
>
&
aEntries
)
;
void
GetAll
(
InfallibleTArray
<
DataStorageItem
>
*
aItems
)
;
static
void
SetCachedStorageEntries
(
const
InfallibleTArray
<
mozilla
:
:
dom
:
:
DataStorageEntry
>
&
aEntries
)
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
private
:
explicit
DataStorage
(
const
nsString
&
aFilename
)
;
virtual
~
DataStorage
(
)
;
static
already_AddRefed
<
DataStorage
>
GetFromRawFileName
(
const
nsString
&
aFilename
)
;
friend
class
:
:
psm_DataStorageTest
;
friend
class
mozilla
:
:
dom
:
:
ContentChild
;
friend
class
mozilla
:
:
DataStorageMemoryReporter
;
class
Writer
;
class
Reader
;
class
Entry
{
public
:
Entry
(
)
;
bool
UpdateScore
(
)
;
uint32_t
mScore
;
int32_t
mLastAccessed
;
nsCString
mValue
;
}
;
class
KeyAndEntry
{
public
:
nsCString
mKey
;
Entry
mEntry
;
}
;
typedef
nsDataHashtable
<
nsCStringHashKey
Entry
>
DataStorageTable
;
typedef
nsRefPtrHashtable
<
nsStringHashKey
DataStorage
>
DataStorages
;
void
WaitForReady
(
)
;
nsresult
AsyncWriteData
(
const
MutexAutoLock
&
aProofOfLock
)
;
nsresult
AsyncReadData
(
bool
&
aHaveProfileDir
const
MutexAutoLock
&
aProofOfLock
)
;
nsresult
AsyncSetTimer
(
const
MutexAutoLock
&
aProofOfLock
)
;
nsresult
DispatchShutdownTimer
(
const
MutexAutoLock
&
aProofOfLock
)
;
static
nsresult
ValidateKeyAndValue
(
const
nsCString
&
aKey
const
nsCString
&
aValue
)
;
static
void
TimerCallback
(
nsITimer
*
aTimer
void
*
aClosure
)
;
void
SetTimer
(
)
;
void
ShutdownTimer
(
)
;
void
NotifyObservers
(
const
char
*
aTopic
)
;
void
PrefChanged
(
const
char
*
aPref
)
;
bool
GetInternal
(
const
nsCString
&
aKey
Entry
*
aEntry
DataStorageType
aType
const
MutexAutoLock
&
aProofOfLock
)
;
nsresult
PutInternal
(
const
nsCString
&
aKey
Entry
&
aEntry
DataStorageType
aType
const
MutexAutoLock
&
aProofOfLock
)
;
void
MaybeEvictOneEntry
(
DataStorageType
aType
const
MutexAutoLock
&
aProofOfLock
)
;
DataStorageTable
&
GetTableForType
(
DataStorageType
aType
const
MutexAutoLock
&
aProofOfLock
)
;
void
ReadAllFromTable
(
DataStorageType
aType
InfallibleTArray
<
DataStorageItem
>
*
aItems
const
MutexAutoLock
&
aProofOfLock
)
;
Mutex
mMutex
;
DataStorageTable
mPersistentDataTable
;
DataStorageTable
mTemporaryDataTable
;
DataStorageTable
mPrivateDataTable
;
nsCOMPtr
<
nsIFile
>
mBackingFile
;
nsCOMPtr
<
nsITimer
>
mTimer
;
uint32_t
mTimerDelay
;
bool
mPendingWrite
;
bool
mShuttingDown
;
mozilla
:
:
Atomic
<
bool
>
mInitCalled
;
Monitor
mReadyMonitor
;
bool
mReady
;
const
nsString
mFilename
;
static
StaticAutoPtr
<
DataStorages
>
sDataStorages
;
}
;
}
#
endif
