#
include
"
gtest
/
gtest
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIPrefService
.
h
"
#
include
"
nsISimpleEnumerator
.
h
"
#
include
"
nsIX509Cert
.
h
"
#
include
"
nsIX509CertDB
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
TEST
(
psm_CertDB
Test
)
{
{
nsCOMPtr
<
nsIPrefBranch
>
prefs
(
do_GetService
(
NS_PREFSERVICE_CONTRACTID
)
)
;
ASSERT_TRUE
(
prefs
)
<
<
"
couldn
'
t
get
nsIPrefBranch
"
;
nsresult
rv
=
prefs
-
>
SetBoolPref
(
"
intl
.
locale
.
matchOS
"
true
)
;
ASSERT_TRUE
(
NS_SUCCEEDED
(
rv
)
)
<
<
"
couldn
'
t
set
pref
'
intl
.
locale
.
matchOS
'
"
;
nsCOMPtr
<
nsIX509CertDB
>
certdb
(
do_GetService
(
NS_X509CERTDB_CONTRACTID
)
)
;
ASSERT_TRUE
(
certdb
)
<
<
"
couldn
'
t
get
certdb
"
;
nsTArray
<
RefPtr
<
nsIX509Cert
>
>
certList
;
rv
=
certdb
-
>
GetCerts
(
certList
)
;
ASSERT_TRUE
(
NS_SUCCEEDED
(
rv
)
)
<
<
"
couldn
'
t
get
list
of
certificates
"
;
bool
foundBuiltIn
=
false
;
for
(
const
auto
&
cert
:
certList
)
{
ASSERT_TRUE
(
cert
)
<
<
"
certlist
shouldn
'
t
have
null
certificate
"
;
ASSERT_TRUE
(
NS_SUCCEEDED
(
cert
-
>
GetIsBuiltInRoot
(
&
foundBuiltIn
)
)
)
<
<
"
GetIsBuiltInRoot
failed
"
;
if
(
foundBuiltIn
)
{
break
;
}
}
ASSERT_TRUE
(
foundBuiltIn
)
<
<
"
didn
'
t
load
any
built
-
in
certificates
"
;
printf
(
"
successfully
loaded
at
least
one
built
-
in
certificate
\
n
"
)
;
}
}
