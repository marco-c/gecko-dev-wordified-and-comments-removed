"
use
strict
"
;
function
shouldBeImminentlyDistrusted
(
aTransportSecurityInfo
)
{
let
isDistrust
=
aTransportSecurityInfo
.
securityState
&
Ci
.
nsIWebProgressListener
.
STATE_CERT_DISTRUST_IMMINENT
;
Assert
.
ok
(
isDistrust
"
This
host
should
be
imminently
distrusted
"
)
;
}
do_get_profile
(
)
;
const
certDB
=
Cc
[
"
mozilla
.
org
/
security
/
x509certdb
;
1
"
]
.
getService
(
Ci
.
nsIX509CertDB
)
;
add_tls_server_setup
(
"
SanctionsTestServer
"
"
test_sanctions
"
false
)
;
addCertFromFile
(
certDB
"
test_sanctions
/
symantec
-
test
-
ca
.
pem
"
"
CTu
u
u
"
)
;
add_test
(
function
(
)
{
addCertFromFile
(
certDB
"
test_sanctions
/
symantec
-
intermediate
-
whitelisted
.
pem
"
"
"
)
;
addCertFromFile
(
certDB
"
test_sanctions
/
symantec
-
intermediate
-
other
.
pem
"
"
"
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
distrust_ca_policy
"
0b01
)
;
run_next_test
(
)
;
}
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
after
-
cutoff
.
example
.
com
"
PRErrorCodeSuccess
null
shouldBeImminentlyDistrusted
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
before
-
cutoff
.
example
.
com
"
MOZILLA_PKIX_ERROR_ADDITIONAL_POLICY_CONSTRAINT_FAILED
null
null
)
;
add_test
(
function
(
)
{
clearSessionCache
(
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
distrust_ca_policy
"
0b10
)
;
run_next_test
(
)
;
}
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
before
-
cutoff
.
example
.
com
"
MOZILLA_PKIX_ERROR_ADDITIONAL_POLICY_CONSTRAINT_FAILED
null
null
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
after
-
cutoff
.
example
.
com
"
MOZILLA_PKIX_ERROR_ADDITIONAL_POLICY_CONSTRAINT_FAILED
null
null
)
;
add_test
(
function
(
)
{
clearSessionCache
(
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
distrust_ca_policy
"
0b00
)
;
run_next_test
(
)
;
}
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
before
-
cutoff
.
example
.
com
"
PRErrorCodeSuccess
null
shouldBeImminentlyDistrusted
)
;
add_test
(
function
(
)
{
clearSessionCache
(
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
pki
.
distrust_ca_policy
"
)
;
run_next_test
(
)
;
}
)
;
add_test
(
function
(
)
{
addCertFromFile
(
certDB
"
test_sanctions
/
symantec
-
intermediate
-
other
-
crossigned
.
pem
"
"
"
)
;
run_next_test
(
)
;
}
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
before
-
cutoff
.
example
.
com
"
MOZILLA_PKIX_ERROR_ADDITIONAL_POLICY_CONSTRAINT_FAILED
null
null
)
;
add_task
(
async
function
(
)
{
addCertFromFile
(
certDB
"
test_sanctions
/
apple
-
ist
-
ca
-
8
-
g1
-
intermediate
.
pem
"
"
"
)
;
let
whitelistedCert
=
constructCertFromFile
(
"
test_sanctions
/
gspe72
-
4
-
ssl
-
ls
-
apple
-
com
.
pem
"
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
0
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
distrust_ca_policy
"
0b01
)
;
const
VALIDATION_TIME
=
1577836800
;
await
checkCertErrorGenericAtTime
(
certDB
whitelistedCert
PRErrorCodeSuccess
certificateUsageSSLServer
VALIDATION_TIME
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
distrust_ca_policy
"
0b10
)
;
await
checkCertErrorGenericAtTime
(
certDB
whitelistedCert
PRErrorCodeSuccess
certificateUsageSSLServer
VALIDATION_TIME
)
;
}
)
;
add_test
(
function
(
)
{
clearSessionCache
(
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
distrust_ca_policy
"
0b1111
)
;
run_next_test
(
)
;
}
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
before
-
cutoff
.
example
.
com
"
MOZILLA_PKIX_ERROR_ADDITIONAL_POLICY_CONSTRAINT_FAILED
null
null
)
;
add_connection_test
(
"
symantec
-
not
-
whitelisted
-
after
-
cutoff
.
example
.
com
"
PRErrorCodeSuccess
null
shouldBeImminentlyDistrusted
)
;
