"
use
strict
"
;
var
gExpectOCSPRequest
;
function
add_ocsp_test
(
aHost
aExpectedResult
aStaplingEnabled
aExpectOCSPRequest
=
false
aWithSecurityInfo
=
undefined
)
{
add_connection_test
(
aHost
aExpectedResult
function
(
)
{
gExpectOCSPRequest
=
aExpectOCSPRequest
;
clearOCSPCache
(
)
;
clearSessionCache
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
ssl
.
enable_ocsp_stapling
"
aStaplingEnabled
)
;
}
aWithSecurityInfo
)
;
}
function
add_tests
(
)
{
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
ee
-
with
-
must
-
staple
-
int
.
example
.
com
"
PRErrorCodeSuccess
true
false
function
(
aSecInfo
)
{
Services
.
prefs
.
setBoolPref
(
"
security
.
cert_pinning
.
hpkp
.
enabled
"
true
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
cert_pinning
.
enforcement_level
"
1
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
cert_pinning
.
process_headers_from_non_builtin_roots
"
true
)
;
let
uri
=
Services
.
io
.
newURI
(
"
https
:
/
/
ocsp
-
stapling
-
must
-
staple
-
ee
-
with
-
must
-
staple
-
int
.
example
.
com
"
)
;
let
keyHash
=
"
VCIlmPM9NkgFQtrs4Oa5TeFcDu6MWRTKSNdePEhOgD8
=
"
;
let
backupKeyHash
=
"
KHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAN
=
"
;
let
header
=
max
-
age
=
1000
;
pin
-
sha256
=
"
{
keyHash
}
"
;
pin
-
sha256
=
"
{
backupKeyHash
}
"
;
let
ssservice
=
Cc
[
"
mozilla
.
org
/
ssservice
;
1
"
]
.
getService
(
Ci
.
nsISiteSecurityService
)
;
ssservice
.
processHeader
(
Ci
.
nsISiteSecurityService
.
HEADER_HPKP
uri
header
aSecInfo
0
Ci
.
nsISiteSecurityService
.
SOURCE_ORGANIC_REQUEST
)
;
ok
(
ssservice
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HPKP
uri
0
)
"
ocsp
-
stapling
-
must
-
staple
-
ee
-
with
-
must
-
staple
-
int
.
example
.
com
should
have
HPKP
set
"
)
;
ssservice
.
resetState
(
Ci
.
nsISiteSecurityService
.
HEADER_HPKP
uri
0
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
cert_pinning
.
process_headers_from_non_builtin_roots
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
cert_pinning
.
hpkp
.
enabled
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
cert_pinning
.
enforcement_level
"
)
;
}
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
plain
-
ee
-
with
-
must
-
staple
-
int
.
example
.
com
"
MOZILLA_PKIX_ERROR_REQUIRED_TLS_FEATURE_MISSING
true
)
;
add_ocsp_test
(
"
multi
-
tls
-
feature
-
good
.
example
.
com
"
PRErrorCodeSuccess
false
)
;
add_ocsp_test
(
"
multi
-
tls
-
feature
-
bad
.
example
.
com
"
MOZILLA_PKIX_ERROR_REQUIRED_TLS_FEATURE_MISSING
false
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
.
example
.
com
"
PRErrorCodeSuccess
true
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
revoked
.
example
.
com
"
SEC_ERROR_REVOKED_CERTIFICATE
true
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
missing
.
example
.
com
"
MOZILLA_PKIX_ERROR_REQUIRED_TLS_FEATURE_MISSING
true
true
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
empty
.
example
.
com
"
SEC_ERROR_OCSP_MALFORMED_RESPONSE
true
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
missing
.
example
.
com
"
PRErrorCodeSuccess
false
true
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
expired
.
example
.
com
"
SEC_ERROR_OCSP_OLD_RESPONSE
true
true
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
try
-
later
.
example
.
com
"
SEC_ERROR_OCSP_TRY_SERVER_LATER
true
true
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
invalid
-
signer
.
example
.
com
"
SEC_ERROR_OCSP_INVALID_SIGNING_CERT
true
true
)
;
add_test
(
function
(
)
{
clearSessionCache
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
ssl
.
enable_ocsp_must_staple
"
false
)
;
run_next_test
(
)
;
}
)
;
add_ocsp_test
(
"
ocsp
-
stapling
-
must
-
staple
-
missing
.
example
.
com
"
PRErrorCodeSuccess
true
true
)
;
}
function
run_test
(
)
{
do_get_profile
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
ssl
.
enable_ocsp_must_staple
"
true
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
timeoutMilliseconds
.
soft
"
5000
)
;
let
fakeOCSPResponder
=
new
HttpServer
(
)
;
fakeOCSPResponder
.
registerPrefixHandler
(
"
/
"
function
(
request
response
)
{
response
.
setStatusLine
(
request
.
httpVersion
500
"
Internal
Server
Error
"
)
;
ok
(
gExpectOCSPRequest
"
Should
be
getting
an
OCSP
request
only
when
expected
"
)
;
}
)
;
fakeOCSPResponder
.
start
(
8888
)
;
add_tls_server_setup
(
"
OCSPStaplingServer
"
"
ocsp_certs
"
)
;
add_tests
(
)
;
add_test
(
function
(
)
{
fakeOCSPResponder
.
stop
(
run_next_test
)
;
}
)
;
run_next_test
(
)
;
}
