"
use
strict
"
;
do_get_profile
(
)
;
const
certDB
=
Cc
[
"
mozilla
.
org
/
security
/
x509certdb
;
1
"
]
.
getService
(
Ci
.
nsIX509CertDB
)
;
const
SERVER_PORT
=
8888
;
function
getOCSPResponder
(
expectedCertNames
)
{
let
expectedPaths
=
expectedCertNames
.
slice
(
)
;
return
startOCSPResponder
(
SERVER_PORT
"
www
.
example
.
com
"
[
]
"
test_keysize_ev
/
"
expectedCertNames
expectedPaths
)
;
}
function
loadCert
(
certName
trustString
)
{
let
certFilename
=
"
test_keysize_ev
/
"
+
certName
+
"
.
pem
"
;
addCertFromFile
(
certDB
certFilename
trustString
)
;
return
constructCertFromFile
(
certFilename
)
;
}
function
addKeySizeTestForEV
(
expectedNamesForOCSP
rootCertFileName
intCertFileNames
endEntityCertFileName
expectedResult
)
{
add_test
(
function
(
)
{
clearOCSPCache
(
)
;
let
ocspResponder
=
getOCSPResponder
(
expectedNamesForOCSP
)
;
loadCert
(
rootCertFileName
"
CTu
CTu
CTu
"
)
;
for
(
let
intCertFileName
of
intCertFileNames
)
{
loadCert
(
intCertFileName
"
"
)
;
}
checkEVStatus
(
certDB
constructCertFromFile
(
test_keysize_ev
/
{
endEntityCertFileName
}
.
pem
)
certificateUsageSSLServer
expectedResult
)
;
ocspResponder
.
stop
(
run_next_test
)
;
}
)
;
}
function
checkRSAChains
(
inadequateKeySize
adequateKeySize
)
{
let
rootOKCertFileName
=
"
.
.
/
test_ev_certs
/
evroot
"
;
let
rootOKName
=
"
evroot
"
;
let
rootNotOKName
=
"
ev_root_rsa_
"
+
inadequateKeySize
;
let
intOKName
=
"
ev_int_rsa_
"
+
adequateKeySize
;
let
intNotOKName
=
"
ev_int_rsa_
"
+
inadequateKeySize
;
let
eeOKName
=
"
ev_ee_rsa_
"
+
adequateKeySize
;
let
eeNotOKName
=
"
ev_ee_rsa_
"
+
inadequateKeySize
;
let
intFullName
=
intOKName
+
"
-
"
+
rootOKName
;
let
eeFullName
=
eeOKName
+
"
-
"
+
intOKName
+
"
-
"
+
rootOKName
;
let
expectedNamesForOCSP
=
gEVExpected
?
[
intFullName
eeFullName
]
:
[
eeFullName
]
;
addKeySizeTestForEV
(
expectedNamesForOCSP
rootOKCertFileName
[
intFullName
]
eeFullName
gEVExpected
)
;
intFullName
=
intOKName
+
"
-
"
+
rootNotOKName
;
eeFullName
=
eeOKName
+
"
-
"
+
intOKName
+
"
-
"
+
rootNotOKName
;
expectedNamesForOCSP
=
[
eeFullName
]
;
addKeySizeTestForEV
(
expectedNamesForOCSP
rootNotOKName
[
intFullName
]
eeFullName
false
)
;
intFullName
=
intNotOKName
+
"
-
"
+
rootOKName
;
eeFullName
=
eeOKName
+
"
-
"
+
intNotOKName
+
"
-
"
+
rootOKName
;
expectedNamesForOCSP
=
[
eeFullName
]
;
addKeySizeTestForEV
(
expectedNamesForOCSP
rootOKCertFileName
[
intFullName
]
eeFullName
false
)
;
intFullName
=
intOKName
+
"
-
"
+
rootOKName
;
eeFullName
=
eeNotOKName
+
"
-
"
+
intOKName
+
"
-
"
+
rootOKName
;
expectedNamesForOCSP
=
gEVExpected
?
[
intFullName
eeFullName
]
:
[
eeFullName
]
;
addKeySizeTestForEV
(
expectedNamesForOCSP
rootOKCertFileName
[
intFullName
]
eeFullName
false
)
;
}
function
run_test
(
)
{
Services
.
prefs
.
setCharPref
(
"
network
.
dns
.
localDomains
"
"
www
.
example
.
com
"
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
let
smallKeyEVRoot
=
constructCertFromFile
(
"
test_keysize_ev
/
ev_root_rsa_2040
.
pem
"
)
;
equal
(
smallKeyEVRoot
.
sha256Fingerprint
"
28
:
79
:
B9
:
6C
:
08
:
71
:
6C
:
7D
:
CE
:
38
:
8C
:
AB
:
7E
:
EB
:
08
:
A6
:
"
+
"
F7
:
2C
:
CE
:
E4
:
47
:
F5
:
72
:
A1
:
EB
:
16
:
9B
:
C3
:
49
:
49
:
72
:
5D
"
"
test
sanity
check
:
the
small
-
key
EV
root
must
have
the
same
"
+
"
fingerprint
as
the
corresponding
entry
in
ExtendedValidation
.
cpp
"
)
;
checkRSAChains
(
2040
2048
)
;
run_next_test
(
)
;
}
