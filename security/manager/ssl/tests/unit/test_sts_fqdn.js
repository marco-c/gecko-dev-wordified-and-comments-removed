"
use
strict
"
;
function
run_test
(
)
{
let
SSService
=
Cc
[
"
mozilla
.
org
/
ssservice
;
1
"
]
.
getService
(
Ci
.
nsISiteSecurityService
)
;
let
uri
=
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
com
"
)
;
let
uri1
=
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
com
.
"
)
;
let
uri2
=
Services
.
io
.
newURI
(
"
https
:
/
/
example
.
com
.
.
"
)
;
ok
(
!
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
0
)
)
;
ok
(
!
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri1
0
)
)
;
ok
(
!
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri2
0
)
)
;
let
secInfo
=
new
FakeTransportSecurityInfo
(
)
;
SSService
.
processHeader
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
"
max
-
age
=
1000
;
includeSubdomains
"
secInfo
0
Ci
.
nsISiteSecurityService
.
SOURCE_ORGANIC_REQUEST
)
;
ok
(
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
0
)
)
;
ok
(
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri1
0
)
)
;
ok
(
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri2
0
)
)
;
SSService
.
removeState
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
0
)
;
ok
(
!
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
0
)
)
;
ok
(
!
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri1
0
)
)
;
ok
(
!
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri2
0
)
)
;
uri
=
Services
.
io
.
newURI
(
"
https
:
/
/
.
.
/
foo
"
)
;
equal
(
uri
.
host
"
.
.
"
)
;
throws
(
(
)
=
>
{
SSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
0
)
;
}
/
NS_ERROR_UNEXPECTED
/
"
Malformed
URI
should
be
rejected
"
)
;
}
