"
use
strict
"
;
var
gOCSPRequestCount
=
0
;
var
gOCSPResponse
;
function
run_test
(
)
{
do_get_profile
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
OCSP
.
require
"
true
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
add_tls_server_setup
(
"
OCSPStaplingServer
"
"
ocsp_certs
"
)
;
let
args
=
[
[
"
bad
-
signature
"
"
default
-
ee
"
"
unused
"
0
]
]
;
let
ocspResponses
=
generateOCSPResponses
(
args
"
ocsp_certs
"
)
;
gOCSPResponse
=
ocspResponses
[
0
]
;
let
ocspResponder
=
new
HttpServer
(
)
;
ocspResponder
.
registerPrefixHandler
(
"
/
"
function
(
request
response
)
{
response
.
setStatusLine
(
request
.
httpVersion
200
"
OK
"
)
;
response
.
setHeader
(
"
Content
-
Type
"
"
application
/
ocsp
-
response
"
)
;
response
.
write
(
gOCSPResponse
)
;
gOCSPRequestCount
+
+
;
}
)
;
ocspResponder
.
start
(
8888
)
;
add_tests
(
)
;
add_test
(
function
(
)
{
ocspResponder
.
stop
(
run_next_test
)
;
}
)
;
run_next_test
(
)
;
}
function
add_tests
(
)
{
add_connection_test
(
"
ocsp
-
stapling
-
none
.
example
.
com
"
SEC_ERROR_OCSP_BAD_SIGNATURE
function
(
)
{
}
function
(
aTransportSecurityInfo
)
{
Assert
.
ok
(
aTransportSecurityInfo
.
madeOCSPRequests
"
An
OCSP
Request
should
have
been
made
.
"
)
;
}
)
;
add_connection_test
(
"
ocsp
-
stapling
-
none
.
example
.
com
"
SEC_ERROR_OCSP_BAD_SIGNATURE
function
(
)
{
}
function
(
aTransportSecurityInfo
)
{
Assert
.
ok
(
!
aTransportSecurityInfo
.
madeOCSPRequests
"
An
OCSP
Request
should
not
have
been
made
.
"
)
;
}
)
;
add_test
(
function
(
)
{
equal
(
gOCSPRequestCount
1
"
OCSP
request
count
should
be
1
due
to
OCSP
response
caching
"
)
;
gOCSPRequestCount
=
0
;
gOCSPResponse
=
"
"
;
clearOCSPCache
(
)
;
run_next_test
(
)
;
}
)
;
add_connection_test
(
"
ocsp
-
stapling
-
none
.
example
.
com
"
SEC_ERROR_OCSP_MALFORMED_RESPONSE
function
(
)
{
}
function
(
aTransportSecurityInfo
)
{
Assert
.
ok
(
aTransportSecurityInfo
.
madeOCSPRequests
"
An
OCSP
Request
should
have
been
made
.
"
)
;
}
)
;
}
