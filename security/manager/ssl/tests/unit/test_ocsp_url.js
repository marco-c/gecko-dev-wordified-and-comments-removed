"
use
strict
"
;
do_get_profile
(
)
;
const
certdb
=
Cc
[
"
mozilla
.
org
/
security
/
x509certdb
;
1
"
]
.
getService
(
Ci
.
nsIX509CertDB
)
;
const
SERVER_PORT
=
8888
;
function
failingOCSPResponder
(
)
{
return
getFailingHttpServer
(
SERVER_PORT
[
"
www
.
example
.
com
"
]
)
;
}
function
start_ocsp_responder
(
expectedCertNames
expectedPaths
)
{
return
startOCSPResponder
(
SERVER_PORT
"
www
.
example
.
com
"
"
test_ocsp_url
"
expectedCertNames
expectedPaths
)
;
}
function
check_cert_err
(
cert_name
expected_error
)
{
let
cert
=
constructCertFromFile
(
"
test_ocsp_url
/
"
+
cert_name
+
"
.
pem
"
)
;
return
checkCertErrorGeneric
(
certdb
cert
expected_error
certificateUsageSSLServer
)
;
}
add_task
(
async
function
(
)
{
addCertFromFile
(
certdb
"
test_ocsp_url
/
ca
.
pem
"
"
CTu
CTu
CTu
"
)
;
addCertFromFile
(
certdb
"
test_ocsp_url
/
int
.
pem
"
"
"
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
OCSP
.
require
"
true
)
;
Services
.
prefs
.
setCharPref
(
"
network
.
dns
.
localDomains
"
"
www
.
example
.
com
"
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
clearOCSPCache
(
)
;
let
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
bad
-
scheme
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
empty
-
scheme
-
url
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
ftp
-
url
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
https
-
url
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
start_ocsp_responder
(
[
"
hTTp
-
url
"
]
[
"
hTTp
-
url
"
]
)
;
await
check_cert_err
(
"
hTTp
-
url
"
PRErrorCodeSuccess
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
negative
-
port
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
no
-
host
-
url
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
start_ocsp_responder
(
[
"
no
-
path
-
url
"
]
[
"
"
]
)
;
await
check_cert_err
(
"
no
-
path
-
url
"
PRErrorCodeSuccess
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
no
-
scheme
-
host
-
port
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
no
-
scheme
-
url
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
failingOCSPResponder
(
)
;
await
check_cert_err
(
"
unknown
-
scheme
"
SEC_ERROR_CERT_BAD_ACCESS_LOCATION
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
start_ocsp_responder
(
[
"
user
-
pass
"
]
[
"
"
]
)
;
await
check_cert_err
(
"
user
-
pass
"
PRErrorCodeSuccess
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
}
)
;
