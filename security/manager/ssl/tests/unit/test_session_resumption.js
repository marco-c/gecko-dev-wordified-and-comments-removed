"
use
strict
"
;
do_get_profile
(
)
;
const
certdb
=
Cc
[
"
mozilla
.
org
/
security
/
x509certdb
;
1
"
]
.
getService
(
Ci
.
nsIX509CertDB
)
;
do_register_cleanup
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
security
.
OCSP
.
enabled
"
)
;
}
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
addCertFromFile
(
certdb
"
bad_certs
/
evroot
.
pem
"
"
CTu
"
)
;
addCertFromFile
(
certdb
"
bad_certs
/
ev
-
test
-
intermediate
.
pem
"
"
"
)
;
function
add_resume_non_ev_with_override_test
(
)
{
add_cert_override_test
(
"
expired
.
example
.
com
"
Ci
.
nsICertOverrideService
.
ERROR_TIME
SEC_ERROR_EXPIRED_CERTIFICATE
)
;
add_connection_test
(
"
expired
.
example
.
com
"
PRErrorCodeSuccess
null
(
transportSecurityInfo
)
=
>
{
ok
(
transportSecurityInfo
.
securityState
&
Ci
.
nsIWebProgressListener
.
STATE_CERT_USER_OVERRIDDEN
"
expired
.
example
.
com
should
have
STATE_CERT_USER_OVERRIDDEN
flag
"
)
;
let
sslStatus
=
transportSecurityInfo
.
QueryInterface
(
Ci
.
nsISSLStatusProvider
)
.
SSLStatus
;
ok
(
!
sslStatus
.
isDomainMismatch
"
expired
.
example
.
com
should
not
have
isDomainMismatch
set
"
)
;
ok
(
sslStatus
.
isNotValidAtThisTime
"
expired
.
example
.
com
should
have
isNotValidAtThisTime
set
"
)
;
ok
(
!
sslStatus
.
isUntrusted
"
expired
.
example
.
com
should
not
have
isUntrusted
set
"
)
;
ok
(
!
sslStatus
.
isExtendedValidation
"
expired
.
example
.
com
should
not
have
isExtendedValidation
set
"
)
;
}
)
;
}
function
add_one_ev_test
(
)
{
add_connection_test
(
"
ev
-
test
.
example
.
com
"
PRErrorCodeSuccess
null
(
transportSecurityInfo
)
=
>
{
ok
(
!
(
transportSecurityInfo
.
securityState
&
Ci
.
nsIWebProgressListener
.
STATE_CERT_USER_OVERRIDDEN
)
"
ev
-
test
.
example
.
com
should
not
have
STATE_CERT_USER_OVERRIDDEN
flag
"
)
;
let
sslStatus
=
transportSecurityInfo
.
QueryInterface
(
Ci
.
nsISSLStatusProvider
)
.
SSLStatus
;
ok
(
!
sslStatus
.
isDomainMismatch
"
ev
-
test
.
example
.
com
should
not
have
isDomainMismatch
set
"
)
;
ok
(
!
sslStatus
.
isNotValidAtThisTime
"
ev
-
test
.
example
.
com
should
not
have
isNotValidAtThisTime
set
"
)
;
ok
(
!
sslStatus
.
isUntrusted
"
ev
-
test
.
example
.
com
should
not
have
isUntrusted
set
"
)
;
ok
(
!
gEVExpected
|
|
sslStatus
.
isExtendedValidation
"
ev
-
test
.
example
.
com
should
have
isExtendedValidation
set
"
+
"
(
or
this
is
a
non
-
debug
build
)
"
)
;
}
)
;
}
function
add_resume_ev_test
(
)
{
const
SERVER_PORT
=
8888
;
let
expectedRequestPaths
=
gEVExpected
?
[
"
ev
-
test
-
intermediate
"
"
ev
-
test
"
]
:
[
"
ev
-
test
"
]
;
let
responseTypes
=
gEVExpected
?
[
"
good
"
"
good
"
]
:
[
"
good
"
]
;
let
ocspResponder
=
startOCSPResponder
(
SERVER_PORT
"
localhost
"
"
bad_certs
"
expectedRequestPaths
expectedRequestPaths
.
slice
(
)
null
responseTypes
)
;
add_one_ev_test
(
)
;
add_one_ev_test
(
)
;
add_test
(
(
)
=
>
{
ocspResponder
.
stop
(
run_next_test
)
;
}
)
;
}
function
run_test
(
)
{
add_tls_server_setup
(
"
BadCertServer
"
"
bad_certs
"
)
;
add_resume_non_ev_with_override_test
(
)
;
add_resume_ev_test
(
)
;
run_next_test
(
)
;
}
