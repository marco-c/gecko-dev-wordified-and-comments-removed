"
use
strict
"
;
do_get_profile
(
)
;
const
gCertDB
=
Cc
[
"
mozilla
.
org
/
security
/
x509certdb
;
1
"
]
.
getService
(
Ci
.
nsIX509CertDB
)
;
const
SERVER_PORT
=
8888
;
function
certFromFile
(
filename
)
{
return
constructCertFromFile
(
test_ev_certs
/
{
filename
}
.
pem
)
;
}
function
loadCert
(
certName
trustString
)
{
addCertFromFile
(
gCertDB
test_ev_certs
/
{
certName
}
.
pem
trustString
)
;
}
function
getFailingOCSPResponder
(
)
{
return
getFailingHttpServer
(
SERVER_PORT
[
"
www
.
example
.
com
"
]
)
;
}
function
getOCSPResponder
(
expectedCertNames
)
{
return
startOCSPResponder
(
SERVER_PORT
"
www
.
example
.
com
"
"
test_ev_certs
"
expectedCertNames
[
]
)
;
}
async
function
testOff
(
)
{
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
0
)
;
info
(
"
Setting
security
.
OCSP
.
enabled
to
0
"
)
;
clearOCSPCache
(
)
;
let
ocspResponder
=
getFailingOCSPResponder
(
)
;
await
checkEVStatus
(
gCertDB
certFromFile
(
"
test
-
oid
-
path
-
ee
"
)
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
false
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
getFailingOCSPResponder
(
)
;
await
checkCertErrorGeneric
(
gCertDB
certFromFile
(
"
non
-
ev
-
root
-
path
-
ee
"
)
PRErrorCodeSuccess
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
}
async
function
testOn
(
)
{
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
info
(
"
Setting
security
.
OCSP
.
enabled
to
1
"
)
;
clearOCSPCache
(
)
;
let
ocspResponder
=
getOCSPResponder
(
[
"
test
-
oid
-
path
-
ee
"
]
)
;
await
checkEVStatus
(
gCertDB
certFromFile
(
"
test
-
oid
-
path
-
ee
"
)
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
gEVExpected
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
getOCSPResponder
(
[
"
non
-
ev
-
root
-
path
-
ee
"
]
)
;
await
checkCertErrorGeneric
(
gCertDB
certFromFile
(
"
non
-
ev
-
root
-
path
-
ee
"
)
PRErrorCodeSuccess
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
}
async
function
testCRLiteEnforced
(
)
{
Services
.
prefs
.
setBoolPref
(
"
security
.
OCSP
.
require
"
false
)
;
info
(
"
Setting
security
.
OCSP
.
require
to
false
"
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
info
(
"
Setting
security
.
OCSP
.
enabled
to
1
"
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
crlite_mode
"
2
)
;
info
(
"
Setting
security
.
pki
.
crlite_mode
to
2
"
)
;
clearOCSPCache
(
)
;
let
ocspResponder
=
getOCSPResponder
(
[
"
non
-
ev
-
root
-
path
-
ee
"
]
)
;
await
checkCertErrorGeneric
(
gCertDB
certFromFile
(
"
non
-
ev
-
root
-
path
-
ee
"
)
PRErrorCodeSuccess
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
if
(
!
AppConstants
.
DEBUG
)
{
return
;
}
let
nonEVRootCert
=
certFromFile
(
"
non
-
evroot
-
ca
"
)
;
Services
.
prefs
.
setCharPref
(
"
security
.
test
.
built_in_root_hash
"
nonEVRootCert
.
sha256Fingerprint
)
;
info
(
"
Setting
security
.
test
.
built_in_root_hash
to
"
+
nonEVRootCert
.
sha256Fingerprint
)
;
clearOCSPCache
(
)
;
ocspResponder
=
getOCSPResponder
(
[
]
)
;
await
checkCertErrorGeneric
(
gCertDB
certFromFile
(
"
non
-
ev
-
root
-
path
-
ee
"
)
PRErrorCodeSuccess
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
OCSP
.
require
"
true
)
;
info
(
"
Setting
security
.
OCSP
.
require
to
true
"
)
;
clearOCSPCache
(
)
;
ocspResponder
=
getOCSPResponder
(
[
"
non
-
ev
-
root
-
path
-
ee
"
]
)
;
await
checkCertErrorGeneric
(
gCertDB
certFromFile
(
"
non
-
ev
-
root
-
path
-
ee
"
)
PRErrorCodeSuccess
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
OCSP
.
require
"
true
)
;
info
(
"
Setting
security
.
OCSP
.
require
to
true
"
)
;
let
evroot
=
certFromFile
(
"
evroot
"
)
;
Services
.
prefs
.
setCharPref
(
"
security
.
test
.
built_in_root_hash
"
evroot
.
sha256Fingerprint
)
;
info
(
"
Setting
security
.
test
.
built_in_root_hash
to
"
+
evroot
.
sha256Fingerprint
)
;
clearOCSPCache
(
)
;
ocspResponder
=
getOCSPResponder
(
[
"
test
-
oid
-
path
-
ee
"
]
)
;
await
checkEVStatus
(
gCertDB
certFromFile
(
"
test
-
oid
-
path
-
ee
"
)
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
gEVExpected
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
}
async
function
testEVOnly
(
)
{
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
2
)
;
info
(
"
Setting
security
.
OCSP
.
enabled
to
2
"
)
;
clearOCSPCache
(
)
;
let
ocspResponder
=
gEVExpected
?
getOCSPResponder
(
[
"
test
-
oid
-
path
-
ee
"
]
)
:
getFailingOCSPResponder
(
)
;
await
checkEVStatus
(
gCertDB
certFromFile
(
"
test
-
oid
-
path
-
ee
"
)
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
gEVExpected
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
clearOCSPCache
(
)
;
ocspResponder
=
getFailingOCSPResponder
(
)
;
await
checkCertErrorGeneric
(
gCertDB
certFromFile
(
"
non
-
ev
-
root
-
path
-
ee
"
)
PRErrorCodeSuccess
Ci
.
nsIX509CertDB
.
verifyUsageTLSServer
)
;
await
stopOCSPResponder
(
ocspResponder
)
;
}
add_task
(
async
function
(
)
{
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
network
.
dns
.
localDomains
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
OCSP
.
enabled
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
OCSP
.
require
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
pki
.
crlite_mode
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
test
.
built_in_root_hash
"
)
;
}
)
;
Services
.
prefs
.
setCharPref
(
"
network
.
dns
.
localDomains
"
"
www
.
example
.
com
"
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
OCSP
.
require
"
true
)
;
loadCert
(
"
evroot
"
"
CTu
"
)
;
loadCert
(
"
test
-
oid
-
path
-
int
"
"
"
)
;
loadCert
(
"
non
-
evroot
-
ca
"
"
CTu
"
)
;
loadCert
(
"
non
-
ev
-
root
-
path
-
int
"
"
"
)
;
await
testOff
(
)
;
await
testOn
(
)
;
await
testEVOnly
(
)
;
await
testCRLiteEnforced
(
)
;
}
)
;
