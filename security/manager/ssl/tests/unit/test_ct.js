"
use
strict
"
;
do_get_profile
(
)
;
function
expectCT
(
value
)
{
return
securityInfo
=
>
{
Assert
.
equal
(
securityInfo
.
certificateTransparencyStatus
value
"
actual
and
expected
CT
status
should
match
"
)
;
}
;
}
registerCleanupFunction
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
security
.
pki
.
certificate_transparency
.
mode
"
)
;
let
cert
=
constructCertFromFile
(
"
test_ct
/
ct
-
valid
.
example
.
com
.
pem
"
)
;
setCertTrust
(
cert
"
"
)
;
}
)
;
function
run_test
(
)
{
Services
.
prefs
.
setIntPref
(
"
security
.
pki
.
certificate_transparency
.
mode
"
1
)
;
add_tls_server_setup
(
"
BadCertAndPinningServer
"
"
test_ct
"
)
;
add_connection_test
(
"
ct
-
valid
.
example
.
com
"
PRErrorCodeSuccess
null
expectCT
(
Ci
.
nsITransportSecurityInfo
.
CERTIFICATE_TRANSPARENCY_POLICY_COMPLIANT
)
)
;
add_connection_test
(
"
ct
-
insufficient
-
scts
.
example
.
com
"
PRErrorCodeSuccess
null
expectCT
(
Ci
.
nsITransportSecurityInfo
.
CERTIFICATE_TRANSPARENCY_POLICY_NOT_ENOUGH_SCTS
)
)
;
add_test
(
(
)
=
>
{
let
cert
=
constructCertFromFile
(
"
test_ct
/
ct
-
valid
.
example
.
com
.
pem
"
)
;
setCertTrust
(
cert
"
CTu
"
)
;
clearSessionCache
(
)
;
run_next_test
(
)
;
}
)
;
add_connection_test
(
"
ct
-
valid
.
example
.
com
"
PRErrorCodeSuccess
null
expectCT
(
Ci
.
nsITransportSecurityInfo
.
CERTIFICATE_TRANSPARENCY_POLICY_NOT_ENOUGH_SCTS
)
)
;
run_next_test
(
)
;
}
