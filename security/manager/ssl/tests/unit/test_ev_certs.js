"
use
strict
"
;
do_get_profile
(
)
;
const
certdb
=
Cc
[
"
mozilla
.
org
/
security
/
x509certdb
;
1
"
]
.
getService
(
Ci
.
nsIX509CertDB
)
;
do_register_cleanup
(
(
)
=
>
{
Services
.
prefs
.
clearUserPref
(
"
network
.
dns
.
localDomains
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
OCSP
.
enabled
"
)
;
}
)
;
Services
.
prefs
.
setCharPref
(
"
network
.
dns
.
localDomains
"
"
www
.
example
.
com
"
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
OCSP
.
enabled
"
1
)
;
const
evroot
=
addCertFromFile
(
certdb
"
test_ev_certs
/
evroot
.
pem
"
"
CTu
"
)
;
addCertFromFile
(
certdb
"
test_ev_certs
/
non
-
evroot
-
ca
.
pem
"
"
CTu
"
)
;
const
SERVER_PORT
=
8888
;
function
failingOCSPResponder
(
)
{
return
getFailingHttpServer
(
SERVER_PORT
[
"
www
.
example
.
com
"
]
)
;
}
class
EVCertVerificationResult
{
constructor
(
testcase
expectedPRErrorCode
expectedEV
resolve
ocspResponder
)
{
this
.
testcase
=
testcase
;
this
.
expectedPRErrorCode
=
expectedPRErrorCode
;
this
.
expectedEV
=
expectedEV
;
this
.
resolve
=
resolve
;
this
.
ocspResponder
=
ocspResponder
;
}
verifyCertFinished
(
prErrorCode
verifiedChain
hasEVPolicy
)
{
equal
(
prErrorCode
this
.
expectedPRErrorCode
{
this
.
testcase
}
should
have
expected
error
code
)
;
equal
(
hasEVPolicy
this
.
expectedEV
{
this
.
testcase
}
should
result
in
expected
EV
status
)
;
this
.
ocspResponder
.
stop
(
this
.
resolve
)
;
}
}
function
asyncTestEV
(
cert
expectedPRErrorCode
expectedEV
expectedOCSPRequestPaths
ocspResponseTypes
=
undefined
)
{
let
now
=
Date
.
now
(
)
/
1000
;
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
ocspResponder
=
expectedOCSPRequestPaths
.
length
>
0
?
startOCSPResponder
(
SERVER_PORT
"
www
.
example
.
com
"
"
test_ev_certs
"
expectedOCSPRequestPaths
expectedOCSPRequestPaths
.
slice
(
)
null
ocspResponseTypes
)
:
failingOCSPResponder
(
)
;
let
result
=
new
EVCertVerificationResult
(
cert
.
subjectName
expectedPRErrorCode
expectedEV
resolve
ocspResponder
)
;
certdb
.
asyncVerifyCertAtTime
(
cert
certificateUsageSSLServer
0
"
ev
-
test
.
example
.
com
"
now
result
)
;
}
)
;
}
function
ensureVerifiesAsEV
(
testcase
)
{
let
cert
=
constructCertFromFile
(
test_ev_certs
/
{
testcase
}
-
ee
.
pem
)
;
addCertFromFile
(
certdb
test_ev_certs
/
{
testcase
}
-
int
.
pem
"
"
)
;
let
expectedOCSPRequestPaths
=
gEVExpected
?
[
{
testcase
}
-
int
{
testcase
}
-
ee
]
:
[
{
testcase
}
-
ee
]
;
return
asyncTestEV
(
cert
PRErrorCodeSuccess
gEVExpected
expectedOCSPRequestPaths
)
;
}
function
ensureVerifiesAsEVWithNoOCSPRequests
(
testcase
)
{
let
cert
=
constructCertFromFile
(
test_ev_certs
/
{
testcase
}
-
ee
.
pem
)
;
addCertFromFile
(
certdb
test_ev_certs
/
{
testcase
}
-
int
.
pem
"
"
)
;
return
asyncTestEV
(
cert
PRErrorCodeSuccess
gEVExpected
[
]
)
;
}
function
ensureVerifiesAsDV
(
testcase
expectedOCSPRequestPaths
=
undefined
)
{
let
cert
=
constructCertFromFile
(
test_ev_certs
/
{
testcase
}
-
ee
.
pem
)
;
addCertFromFile
(
certdb
test_ev_certs
/
{
testcase
}
-
int
.
pem
"
"
)
;
return
asyncTestEV
(
cert
PRErrorCodeSuccess
false
expectedOCSPRequestPaths
?
expectedOCSPRequestPaths
:
[
{
testcase
}
-
ee
]
)
;
}
function
ensureVerificationFails
(
testcase
expectedPRErrorCode
)
{
let
cert
=
constructCertFromFile
(
test_ev_certs
/
{
testcase
}
-
ee
.
pem
)
;
addCertFromFile
(
certdb
test_ev_certs
/
{
testcase
}
-
int
.
pem
"
"
)
;
return
asyncTestEV
(
cert
expectedPRErrorCode
false
[
]
)
;
}
function
verifyWithFlags_LOCAL_ONLY_and_MUST_BE_EV
(
testcase
expectSuccess
)
{
let
cert
=
constructCertFromFile
(
test_ev_certs
/
{
testcase
}
-
ee
.
pem
)
;
addCertFromFile
(
certdb
test_ev_certs
/
{
testcase
}
-
int
.
pem
"
"
)
;
let
now
=
Date
.
now
(
)
/
1000
;
let
expectedErrorCode
=
SEC_ERROR_POLICY_VALIDATION_FAILED
;
if
(
expectSuccess
&
&
gEVExpected
)
{
expectedErrorCode
=
PRErrorCodeSuccess
;
}
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
ocspResponder
=
failingOCSPResponder
(
)
;
let
result
=
new
EVCertVerificationResult
(
cert
.
subjectName
expectedErrorCode
expectSuccess
&
&
gEVExpected
resolve
ocspResponder
)
;
let
flags
=
Ci
.
nsIX509CertDB
.
FLAG_LOCAL_ONLY
|
Ci
.
nsIX509CertDB
.
FLAG_MUST_BE_EV
;
certdb
.
asyncVerifyCertAtTime
(
cert
certificateUsageSSLServer
flags
"
ev
-
test
.
example
.
com
"
now
result
)
;
}
)
;
}
function
ensureNoOCSPMeansNoEV
(
testcase
)
{
return
verifyWithFlags_LOCAL_ONLY_and_MUST_BE_EV
(
testcase
false
)
;
}
function
ensureVerifiesAsEVWithFLAG_LOCAL_ONLY
(
testcase
)
{
return
verifyWithFlags_LOCAL_ONLY_and_MUST_BE_EV
(
testcase
true
)
;
}
function
ensureOneCRLSkipsOCSPForIntermediates
(
testcase
)
{
let
cert
=
constructCertFromFile
(
test_ev_certs
/
{
testcase
}
-
ee
.
pem
)
;
addCertFromFile
(
certdb
test_ev_certs
/
{
testcase
}
-
int
.
pem
"
"
)
;
return
asyncTestEV
(
cert
PRErrorCodeSuccess
gEVExpected
[
{
testcase
}
-
ee
]
)
;
}
function
verifyWithDifferentOCSPResponseTypes
(
testcase
responses
expectEV
)
{
let
cert
=
constructCertFromFile
(
test_ev_certs
/
{
testcase
}
-
ee
.
pem
)
;
addCertFromFile
(
certdb
test_ev_certs
/
{
testcase
}
-
int
.
pem
"
"
)
;
let
expectedOCSPRequestPaths
=
gEVExpected
?
[
{
testcase
}
-
int
{
testcase
}
-
ee
]
:
[
{
testcase
}
-
ee
]
;
let
ocspResponseTypes
=
gEVExpected
?
responses
:
responses
.
slice
(
1
)
;
return
asyncTestEV
(
cert
PRErrorCodeSuccess
gEVExpected
&
&
expectEV
expectedOCSPRequestPaths
ocspResponseTypes
)
;
}
function
ensureVerifiesAsEVWithOldIntermediateOCSPResponse
(
testcase
)
{
return
verifyWithDifferentOCSPResponseTypes
(
testcase
[
"
longvalidityalmostold
"
"
good
"
]
true
)
;
}
function
ensureVerifiesAsDVWithOldEndEntityOCSPResponse
(
testcase
)
{
return
verifyWithDifferentOCSPResponseTypes
(
testcase
[
"
good
"
"
longvalidityalmostold
"
]
false
)
;
}
function
ensureVerifiesAsDVWithVeryOldEndEntityOCSPResponse
(
testcase
)
{
return
verifyWithDifferentOCSPResponseTypes
(
testcase
[
"
good
"
"
ancientstillvalid
"
]
false
)
;
}
add_task
(
function
*
plainExpectSuccessEVTests
(
)
{
yield
ensureVerifiesAsEV
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
test
-
oid
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
cabforum
-
oid
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
cabforum
-
and
-
test
-
oid
-
ee
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
test
-
and
-
cabforum
-
oid
-
ee
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
reverse
-
order
-
oids
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
cabforum
-
and
-
test
-
oid
-
ee
-
cabforum
-
oid
-
int
-
path
"
)
;
}
)
;
add_task
(
function
*
expectDVFallbackTests
(
)
{
yield
ensureVerifiesAsDV
(
"
anyPolicy
-
ee
-
path
"
)
;
yield
ensureVerifiesAsDV
(
"
non
-
ev
-
root
-
path
"
)
;
yield
ensureVerifiesAsDV
(
"
no
-
ocsp
-
ee
-
path
"
gEVExpected
?
[
"
no
-
ocsp
-
ee
-
path
-
int
"
]
:
[
]
)
;
yield
ensureVerifiesAsDV
(
"
no
-
ocsp
-
int
-
path
"
)
;
yield
ensureVerifiesAsDV
(
"
test
-
oid
-
ee
-
cabforum
-
oid
-
int
-
path
"
)
;
yield
ensureVerifiesAsDV
(
"
test
-
and
-
cabforum
-
oid
-
ee
-
cabforum
-
oid
-
int
-
path
"
)
;
}
)
;
add_task
(
function
*
evRootTrustTests
(
)
{
clearOCSPCache
(
)
;
do_print
(
"
untrusting
evroot
"
)
;
certdb
.
setCertTrust
(
evroot
Ci
.
nsIX509Cert
.
CA_CERT
Ci
.
nsIX509CertDB
.
UNTRUSTED
)
;
yield
ensureVerificationFails
(
"
test
-
oid
-
path
"
SEC_ERROR_UNKNOWN_ISSUER
)
;
do_print
(
"
re
-
trusting
evroot
"
)
;
certdb
.
setCertTrust
(
evroot
Ci
.
nsIX509Cert
.
CA_CERT
Ci
.
nsIX509CertDB
.
TRUSTED_SSL
)
;
yield
ensureVerifiesAsEV
(
"
test
-
oid
-
path
"
)
;
}
)
;
add_task
(
function
*
localOnlyMustBeEVTests
(
)
{
clearOCSPCache
(
)
;
yield
ensureNoOCSPMeansNoEV
(
"
anyPolicy
-
ee
-
path
"
)
;
yield
ensureNoOCSPMeansNoEV
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureNoOCSPMeansNoEV
(
"
non
-
ev
-
root
-
path
"
)
;
yield
ensureNoOCSPMeansNoEV
(
"
no
-
ocsp
-
ee
-
path
"
)
;
yield
ensureNoOCSPMeansNoEV
(
"
no
-
ocsp
-
int
-
path
"
)
;
yield
ensureNoOCSPMeansNoEV
(
"
test
-
oid
-
path
"
)
;
}
)
;
add_task
(
function
*
oneCRLTests
(
)
{
clearOCSPCache
(
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
onecrl
.
maximum_staleness_in_seconds
"
108000
)
;
Services
.
prefs
.
setIntPref
(
"
services
.
blocklist
.
onecrl
.
checked
"
Math
.
floor
(
Date
.
now
(
)
/
1000
)
-
1
)
;
Services
.
prefs
.
setIntPref
(
"
app
.
update
.
lastUpdateTime
.
blocklist
-
background
-
update
-
timer
"
Math
.
floor
(
Date
.
now
(
)
/
1000
)
-
1
)
;
yield
ensureOneCRLSkipsOCSPForIntermediates
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureOneCRLSkipsOCSPForIntermediates
(
"
no
-
ocsp
-
int
-
path
"
)
;
yield
ensureOneCRLSkipsOCSPForIntermediates
(
"
test
-
oid
-
path
"
)
;
clearOCSPCache
(
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
onecrl
.
maximum_staleness_in_seconds
"
0
)
;
yield
ensureVerifiesAsEV
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsDV
(
"
no
-
ocsp
-
int
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
test
-
oid
-
path
"
)
;
clearOCSPCache
(
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
onecrl
.
maximum_staleness_in_seconds
"
108000
)
;
Services
.
prefs
.
setIntPref
(
"
services
.
blocklist
.
onecrl
.
checked
"
Math
.
floor
(
Date
.
now
(
)
/
1000
)
-
108080
)
;
Services
.
prefs
.
setIntPref
(
"
app
.
update
.
lastUpdateTime
.
blocklist
-
background
-
update
-
timer
"
Math
.
floor
(
Date
.
now
(
)
/
1000
)
-
108080
)
;
yield
ensureVerifiesAsEV
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsDV
(
"
no
-
ocsp
-
int
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
test
-
oid
-
path
"
)
;
clearOCSPCache
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
onecrl
.
via
.
amo
"
false
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
onecrl
.
maximum_staleness_in_seconds
"
108000
)
;
Services
.
prefs
.
setIntPref
(
"
app
.
update
.
lastUpdateTime
.
blocklist
-
background
-
update
-
timer
"
Math
.
floor
(
Date
.
now
(
)
/
1000
)
-
1
)
;
yield
ensureVerifiesAsEV
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsDV
(
"
no
-
ocsp
-
int
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
test
-
oid
-
path
"
)
;
clearOCSPCache
(
)
;
Services
.
prefs
.
setBoolPref
(
"
security
.
onecrl
.
via
.
amo
"
false
)
;
Services
.
prefs
.
setIntPref
(
"
security
.
onecrl
.
maximum_staleness_in_seconds
"
108000
)
;
Services
.
prefs
.
setIntPref
(
"
services
.
blocklist
.
onecrl
.
checked
"
Math
.
floor
(
Date
.
now
(
)
/
1000
)
-
1
)
;
yield
ensureOneCRLSkipsOCSPForIntermediates
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureOneCRLSkipsOCSPForIntermediates
(
"
no
-
ocsp
-
int
-
path
"
)
;
yield
ensureOneCRLSkipsOCSPForIntermediates
(
"
test
-
oid
-
path
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
onecrl
.
via
.
amo
"
)
;
Services
.
prefs
.
clearUserPref
(
"
security
.
onecrl
.
maximum_staleness_in_seconds
"
)
;
Services
.
prefs
.
clearUserPref
(
"
services
.
blocklist
.
onecrl
.
checked
"
)
;
Services
.
prefs
.
clearUserPref
(
"
app
.
update
.
lastUpdateTime
.
blocklist
-
background
-
update
-
timer
"
)
;
}
)
;
add_task
(
function
*
ocspCachingTests
(
)
{
clearOCSPCache
(
)
;
yield
ensureVerifiesAsEV
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsEV
(
"
test
-
oid
-
path
"
)
;
yield
ensureVerifiesAsEVWithNoOCSPRequests
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsEVWithNoOCSPRequests
(
"
test
-
oid
-
path
"
)
;
yield
ensureVerifiesAsEVWithFLAG_LOCAL_ONLY
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsEVWithFLAG_LOCAL_ONLY
(
"
test
-
oid
-
path
"
)
;
}
)
;
add_task
(
function
*
oldOCSPResponseTests
(
)
{
clearOCSPCache
(
)
;
yield
ensureVerifiesAsEVWithOldIntermediateOCSPResponse
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsEVWithOldIntermediateOCSPResponse
(
"
test
-
oid
-
path
"
)
;
clearOCSPCache
(
)
;
yield
ensureVerifiesAsDVWithOldEndEntityOCSPResponse
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsDVWithOldEndEntityOCSPResponse
(
"
test
-
oid
-
path
"
)
;
clearOCSPCache
(
)
;
yield
ensureVerifiesAsDVWithVeryOldEndEntityOCSPResponse
(
"
anyPolicy
-
int
-
path
"
)
;
yield
ensureVerifiesAsDVWithVeryOldEndEntityOCSPResponse
(
"
test
-
oid
-
path
"
)
;
}
)
;
