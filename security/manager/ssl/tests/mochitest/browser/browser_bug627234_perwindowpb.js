"
use
strict
"
;
var
FakeSSLStatus
=
function
(
)
{
}
;
FakeSSLStatus
.
prototype
=
{
serverCert
:
null
cipherName
:
null
keyLength
:
2048
isDomainMismatch
:
false
isNotValidAtThisTime
:
false
isUntrusted
:
false
isExtendedValidation
:
false
getInterface
(
aIID
)
{
return
this
.
QueryInterface
(
aIID
)
;
}
QueryInterface
(
aIID
)
{
if
(
aIID
.
equals
(
Ci
.
nsISSLStatus
)
|
|
aIID
.
equals
(
Ci
.
nsISupports
)
)
{
return
this
;
}
throw
new
Error
(
Cr
.
NS_ERROR_NO_INTERFACE
)
;
}
}
;
function
whenNewWindowLoaded
(
aOptions
aCallback
)
{
let
win
=
OpenBrowserWindow
(
aOptions
)
;
win
.
addEventListener
(
"
load
"
function
(
)
{
aCallback
(
win
)
;
}
{
once
:
true
}
)
;
}
function
test
(
)
{
waitForExplicitFinish
(
)
;
let
windowsToClose
=
[
]
;
let
testURI
=
"
about
:
blank
"
;
let
uri
;
let
gSSService
=
Cc
[
"
mozilla
.
org
/
ssservice
;
1
"
]
.
getService
(
Ci
.
nsISiteSecurityService
)
;
function
privacyFlags
(
aIsPrivateMode
)
{
return
aIsPrivateMode
?
Ci
.
nsISocketProvider
.
NO_PERMANENT_STORAGE
:
0
;
}
function
doTest
(
aIsPrivateMode
aWindow
aCallback
)
{
BrowserTestUtils
.
browserLoaded
(
aWindow
.
gBrowser
.
selectedBrowser
)
.
then
(
(
)
=
>
{
let
sslStatus
=
new
FakeSSLStatus
(
)
;
uri
=
aWindow
.
Services
.
io
.
newURI
(
"
https
:
/
/
localhost
/
img
.
png
"
)
;
gSSService
.
processHeader
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
"
max
-
age
=
1000
"
sslStatus
privacyFlags
(
aIsPrivateMode
)
Ci
.
nsISiteSecurityService
.
SOURCE_ORGANIC_REQUEST
)
;
ok
(
gSSService
.
isSecureURI
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
privacyFlags
(
aIsPrivateMode
)
)
"
checking
sts
host
"
)
;
aCallback
(
)
;
}
)
;
aWindow
.
gBrowser
.
selectedBrowser
.
loadURI
(
testURI
)
;
}
function
testOnWindow
(
aOptions
aCallback
)
{
whenNewWindowLoaded
(
aOptions
function
(
aWin
)
{
windowsToClose
.
push
(
aWin
)
;
executeSoon
(
function
(
)
{
aCallback
(
aWin
)
;
}
)
;
}
)
;
}
registerCleanupFunction
(
function
(
)
{
windowsToClose
.
forEach
(
function
(
aWin
)
{
aWin
.
close
(
)
;
}
)
;
uri
=
Services
.
io
.
newURI
(
"
http
:
/
/
localhost
"
)
;
gSSService
.
removeState
(
Ci
.
nsISiteSecurityService
.
HEADER_HSTS
uri
0
)
;
}
)
;
testOnWindow
(
{
private
:
true
}
function
(
aWin
)
{
doTest
(
true
aWin
function
(
)
{
testOnWindow
(
{
}
function
(
aWin
)
{
doTest
(
false
aWin
function
(
)
{
testOnWindow
(
{
private
:
true
}
function
(
aWin
)
{
doTest
(
true
aWin
function
(
)
{
finish
(
)
;
}
)
;
}
)
;
}
)
;
}
)
;
}
)
;
}
)
;
}
