"
use
strict
"
;
function
whenNewWindowLoaded
(
aPrivate
aCallback
)
{
BrowserTestUtils
.
openNewBrowserWindow
(
{
private
:
aPrivate
}
)
.
then
(
aCallback
)
;
}
function
test
(
)
{
waitForExplicitFinish
(
)
;
let
windowsToClose
=
[
]
;
let
testURI
=
"
about
:
blank
"
;
let
uri
;
let
gSSService
=
Cc
[
"
mozilla
.
org
/
ssservice
;
1
"
]
.
getService
(
Ci
.
nsISiteSecurityService
)
;
function
originAttributes
(
aIsPrivateMode
)
{
return
aIsPrivateMode
?
{
privateBrowsingId
:
1
}
:
{
}
;
}
function
doTest
(
aIsPrivateMode
aWindow
aCallback
)
{
BrowserTestUtils
.
browserLoaded
(
aWindow
.
gBrowser
.
selectedBrowser
{
wantLoad
:
testURI
}
)
.
then
(
(
)
=
>
{
uri
=
aWindow
.
Services
.
io
.
newURI
(
"
https
:
/
/
localhost
/
img
.
png
"
)
;
gSSService
.
processHeader
(
uri
"
max
-
age
=
1000
"
originAttributes
(
aIsPrivateMode
)
)
;
ok
(
gSSService
.
isSecureURI
(
uri
originAttributes
(
aIsPrivateMode
)
)
"
checking
sts
host
"
)
;
aCallback
(
)
;
}
)
;
BrowserTestUtils
.
startLoadingURIString
(
aWindow
.
gBrowser
.
selectedBrowser
testURI
)
;
}
function
testOnWindow
(
aPrivate
aCallback
)
{
whenNewWindowLoaded
(
aPrivate
function
(
aWin
)
{
windowsToClose
.
push
(
aWin
)
;
executeSoon
(
function
(
)
{
aCallback
(
aWin
)
;
}
)
;
}
)
;
}
registerCleanupFunction
(
function
(
)
{
windowsToClose
.
forEach
(
function
(
aWin
)
{
aWin
.
close
(
)
;
}
)
;
uri
=
Services
.
io
.
newURI
(
"
http
:
/
/
localhost
"
)
;
gSSService
.
resetState
(
uri
)
;
}
)
;
testOnWindow
(
true
function
(
aWin
)
{
doTest
(
true
aWin
function
(
)
{
testOnWindow
(
false
function
(
aWin
)
{
doTest
(
false
aWin
function
(
)
{
testOnWindow
(
true
function
(
aWin
)
{
doTest
(
true
aWin
function
(
)
{
finish
(
)
;
}
)
;
}
)
;
}
)
;
}
)
;
}
)
;
}
)
;
}
