"
use
strict
"
;
var
{
OS
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
osfile
.
jsm
"
{
}
)
;
add_task
(
async
function
testCAandTitle
(
)
{
let
cert
=
await
readCertificate
(
"
ca
.
pem
"
"
CTu
CTu
CTu
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkUsages
(
win
[
"
SSL
Certificate
Authority
"
]
)
;
checkDetailsPane
(
win
[
"
ca
"
]
)
;
Assert
.
equal
(
win
.
document
.
title
"
Certificate
Viewer
:
\
u201Cca
\
u201D
"
"
Actual
and
expected
title
should
match
"
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testSSLEndEntity
(
)
{
let
cert
=
await
readCertificate
(
"
ssl
-
ee
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkUsages
(
win
[
"
SSL
Server
Certificate
"
"
SSL
Client
Certificate
"
]
)
;
checkDetailsPane
(
win
[
"
ca
"
"
ssl
-
ee
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testEmailEndEntity
(
)
{
let
cert
=
await
readCertificate
(
"
email
-
ee
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkUsages
(
win
[
"
Email
Recipient
Certificate
"
"
Email
Signer
Certificate
"
]
)
;
checkDetailsPane
(
win
[
"
ca
"
"
email
-
ee
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testCodeSignEndEntity
(
)
{
let
cert
=
await
readCertificate
(
"
code
-
ee
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkError
(
win
"
Could
not
verify
this
certificate
for
unknown
reasons
.
"
)
;
checkDetailsPane
(
win
[
"
code
-
ee
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testExpired
(
)
{
let
cert
=
await
readCertificate
(
"
expired
-
ca
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkError
(
win
"
Could
not
verify
this
certificate
because
it
has
expired
.
"
)
;
checkDetailsPane
(
win
[
"
expired
-
ca
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
let
eeCert
=
await
readCertificate
(
"
ee
-
from
-
expired
-
ca
.
pem
"
"
"
)
;
let
eeWin
=
await
displayCertificate
(
eeCert
)
;
checkError
(
eeWin
"
Could
not
verify
this
certificate
because
the
CA
certificate
"
+
"
is
invalid
.
"
)
;
checkDetailsPane
(
eeWin
[
"
ee
-
from
-
expired
-
ca
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
eeWin
)
;
}
)
;
add_task
(
async
function
testUnknownIssuer
(
)
{
let
cert
=
await
readCertificate
(
"
unknown
-
issuer
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkError
(
win
"
Could
not
verify
this
certificate
because
the
issuer
is
"
+
"
unknown
.
"
)
;
checkDetailsPane
(
win
[
"
unknown
-
issuer
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testInsecureAlgo
(
)
{
let
cert
=
await
readCertificate
(
"
md5
-
ee
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkError
(
win
"
Could
not
verify
this
certificate
because
it
was
signed
using
"
+
"
a
signature
algorithm
that
was
disabled
because
that
algorithm
"
+
"
is
not
secure
.
"
)
;
checkDetailsPane
(
win
[
"
md5
-
ee
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testUntrusted
(
)
{
let
cert
=
await
readCertificate
(
"
untrusted
-
ca
.
pem
"
"
p
p
p
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkError
(
win
"
Could
not
verify
this
certificate
because
it
is
not
trusted
.
"
)
;
checkDetailsPane
(
win
[
"
untrusted
-
ca
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
let
eeCert
=
await
readCertificate
(
"
ee
-
from
-
untrusted
-
ca
.
pem
"
"
"
)
;
let
eeWin
=
await
displayCertificate
(
eeCert
)
;
checkError
(
eeWin
"
Could
not
verify
this
certificate
because
the
issuer
is
not
"
+
"
trusted
.
"
)
;
checkDetailsPane
(
eeWin
[
"
ee
-
from
-
untrusted
-
ca
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
eeWin
)
;
}
)
;
add_task
(
async
function
testRevoked
(
)
{
let
certBlocklist
=
Cc
[
"
mozilla
.
org
/
security
/
certblocklist
;
1
"
]
.
getService
(
Ci
.
nsICertBlocklist
)
;
certBlocklist
.
revokeCertBySubjectAndPubKey
(
"
MBIxEDAOBgNVBAMMB3Jldm9rZWQ
=
"
"
VCIlmPM9NkgFQtrs4Oa5TeFcDu6MWRTKSNdePEhOgD8
=
"
)
;
let
cert
=
await
readCertificate
(
"
revoked
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkUsages
(
win
[
"
Email
Recipient
Certificate
"
"
Email
Signer
Certificate
"
"
SSL
Client
Certificate
"
]
)
;
checkDetailsPane
(
win
[
"
ca
"
"
revoked
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testInvalid
(
)
{
let
cert
=
await
readCertificate
(
"
invalid
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkError
(
win
"
Could
not
verify
this
certificate
for
unknown
reasons
.
"
)
;
checkDetailsPane
(
win
[
"
invalid
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
add_task
(
async
function
testLongOID
(
)
{
let
cert
=
await
readCertificate
(
"
longOID
.
pem
"
"
"
)
;
let
win
=
await
displayCertificate
(
cert
)
;
checkDetailsPane
(
win
[
"
Long
OID
"
]
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
}
)
;
function
displayCertificate
(
certificate
)
{
let
win
=
window
.
openDialog
(
"
chrome
:
/
/
pippki
/
content
/
certViewer
.
xul
"
"
"
"
"
certificate
)
;
return
TestUtils
.
topicObserved
(
"
ViewCertDetails
:
CertUsagesDone
"
(
subject
data
)
=
>
subject
=
=
win
)
.
then
(
(
[
subject
data
]
)
=
>
subject
error
=
>
{
throw
error
;
}
)
;
}
function
getUsages
(
win
)
{
let
determinedUsages
=
[
]
;
let
verifyInfoBox
=
win
.
document
.
getElementById
(
"
verify_info_box
"
)
;
Array
.
from
(
verifyInfoBox
.
children
)
.
forEach
(
child
=
>
{
if
(
child
.
getAttribute
(
"
hidden
"
)
!
=
"
true
"
&
&
child
.
getAttribute
(
"
id
"
)
!
=
"
verified
"
)
{
determinedUsages
.
push
(
child
.
getAttribute
(
"
value
"
)
)
;
}
}
)
;
return
determinedUsages
.
sort
(
)
;
}
function
getError
(
win
)
{
return
win
.
document
.
getElementById
(
"
verified
"
)
.
textContent
;
}
function
checkUsages
(
win
usages
)
{
Assert
.
equal
(
getError
(
win
)
"
This
certificate
has
been
verified
for
the
following
uses
:
"
"
should
have
successful
verification
message
"
)
;
let
determinedUsages
=
getUsages
(
win
)
;
usages
.
sort
(
)
;
Assert
.
equal
(
determinedUsages
.
length
usages
.
length
"
number
of
usages
as
determined
by
cert
viewer
should
be
equal
"
)
;
while
(
usages
.
length
>
0
)
{
Assert
.
equal
(
determinedUsages
.
pop
(
)
usages
.
pop
(
)
"
usages
as
determined
by
cert
viewer
should
be
equal
"
)
;
}
}
function
checkError
(
win
error
)
{
let
determinedUsages
=
getUsages
(
win
)
;
Assert
.
equal
(
determinedUsages
.
length
0
"
should
not
have
any
successful
usages
in
error
case
"
)
;
Assert
.
equal
(
getError
(
win
)
error
"
determined
error
should
be
the
same
as
expected
error
"
)
;
}
function
checkDetailsPane
(
win
names
)
{
let
tree
=
win
.
document
.
getElementById
(
"
treesetDump
"
)
;
let
nodes
=
tree
.
querySelectorAll
(
"
treecell
"
)
;
Assert
.
equal
(
nodes
.
length
names
.
length
"
details
pane
:
should
have
the
expected
number
of
cert
names
"
)
;
for
(
let
i
=
0
;
i
<
names
.
length
;
i
+
+
)
{
Assert
.
equal
(
nodes
[
i
]
.
getAttribute
(
"
label
"
)
names
[
i
]
"
details
pain
:
should
have
expected
cert
name
"
)
;
}
}
