"
use
strict
"
;
var
loadAsInsecure
=
false
;
var
bypassNavigationTest
=
false
;
var
navigateToInsecure
=
false
;
var
openTwoWindows
=
false
;
var
testPage
=
"
"
;
var
testCleanUp
=
null
;
var
hasMixedActiveContent
=
false
;
var
_windowCount
=
0
;
window
.
onload
=
function
onLoad
(
)
{
if
(
location
.
search
=
=
"
?
runtest
"
)
{
try
{
if
(
history
.
length
=
=
1
)
{
runTest
(
)
;
}
else
{
afterNavigationTest
(
)
;
}
}
catch
(
ex
)
{
ok
(
false
"
Exception
thrown
during
test
:
"
+
ex
)
;
finish
(
)
;
}
}
else
{
window
.
addEventListener
(
"
message
"
onMessageReceived
)
;
let
secureTestLocation
=
loadAsInsecure
?
"
http
:
/
/
example
.
com
"
:
"
https
:
/
/
example
.
com
"
;
secureTestLocation
+
=
location
.
pathname
;
if
(
testPage
!
=
"
"
)
{
let
array
=
secureTestLocation
.
split
(
"
/
"
)
;
array
.
pop
(
)
;
array
.
push
(
testPage
)
;
secureTestLocation
=
array
.
join
(
"
/
"
)
;
}
secureTestLocation
+
=
"
?
runtest
"
;
if
(
hasMixedActiveContent
)
{
SpecialPowers
.
pushPrefEnv
(
{
"
set
"
:
[
[
"
security
.
mixed_content
.
block_active_content
"
false
]
]
}
null
)
;
}
if
(
openTwoWindows
)
{
_windowCount
=
2
;
window
.
open
(
secureTestLocation
"
_new1
"
"
"
)
;
window
.
open
(
secureTestLocation
"
_new2
"
"
"
)
;
}
else
{
_windowCount
=
1
;
window
.
open
(
secureTestLocation
)
;
}
}
}
;
function
onMessageReceived
(
event
)
{
switch
(
event
.
data
)
{
case
"
done
"
:
if
(
-
-
_windowCount
=
=
0
)
{
if
(
testCleanUp
)
{
testCleanUp
(
)
;
}
if
(
hasMixedActiveContent
)
{
SpecialPowers
.
popPrefEnv
(
null
)
;
}
SimpleTest
.
finish
(
)
;
}
break
;
default
:
SimpleTest
.
ok
(
!
event
.
data
.
match
(
/
^
FAILURE
/
)
event
.
data
)
;
break
;
}
}
function
postMsg
(
message
)
{
opener
.
postMessage
(
message
"
http
:
/
/
mochi
.
test
:
8888
"
)
;
}
function
finish
(
)
{
if
(
history
.
length
=
=
1
&
&
!
bypassNavigationTest
)
{
window
.
setTimeout
(
(
)
=
>
{
window
.
location
.
assign
(
navigateToInsecure
?
"
http
:
/
/
example
.
com
/
tests
/
security
/
manager
/
ssl
/
tests
/
mochitest
/
mixedcontent
/
backward
.
html
"
:
"
https
:
/
/
example
.
com
/
tests
/
security
/
manager
/
ssl
/
tests
/
mochitest
/
mixedcontent
/
backward
.
html
"
)
;
}
0
)
;
}
else
{
postMsg
(
"
done
"
)
;
window
.
close
(
)
;
}
}
function
ok
(
a
message
)
{
if
(
!
a
)
{
postMsg
(
"
FAILURE
:
"
+
message
)
;
}
else
{
postMsg
(
message
)
;
}
}
function
is
(
a
b
message
)
{
if
(
a
!
=
b
)
{
postMsg
(
FAILURE
:
{
message
}
expected
{
b
}
got
{
a
}
)
;
}
else
{
postMsg
(
{
message
}
expected
{
b
}
got
{
a
}
)
;
}
}
function
isSecurityState
(
expectedState
message
test
)
{
if
(
!
test
)
{
test
=
ok
;
}
let
ui
=
SpecialPowers
.
wrap
(
window
)
.
docShell
.
securityUI
;
let
isInsecure
=
!
ui
|
|
(
ui
.
state
&
SpecialPowers
.
Ci
.
nsIWebProgressListener
.
STATE_IS_INSECURE
)
;
let
isBroken
=
ui
&
&
(
ui
.
state
&
SpecialPowers
.
Ci
.
nsIWebProgressListener
.
STATE_IS_BROKEN
)
;
let
isEV
=
ui
&
&
(
ui
.
state
&
SpecialPowers
.
Ci
.
nsIWebProgressListener
.
STATE_IDENTITY_EV_TOPLEVEL
)
;
let
gotState
=
"
secure
"
;
if
(
isInsecure
)
{
gotState
=
"
insecure
"
;
}
else
if
(
isBroken
)
{
gotState
=
"
broken
"
;
}
else
if
(
isEV
)
{
gotState
=
"
EV
"
;
}
test
(
gotState
=
=
expectedState
(
message
|
|
"
"
)
+
"
expected
"
+
expectedState
+
"
got
"
+
gotState
)
;
switch
(
expectedState
)
{
case
"
insecure
"
:
test
(
isInsecure
&
&
!
isBroken
&
&
!
isEV
"
for
'
insecure
'
excpected
flags
[
1
0
0
]
"
+
(
message
|
|
"
"
)
)
;
break
;
case
"
broken
"
:
test
(
ui
&
&
!
isInsecure
&
&
isBroken
&
&
!
isEV
"
for
'
broken
'
expected
flags
[
0
1
0
]
"
+
(
message
|
|
"
"
)
)
;
break
;
case
"
secure
"
:
test
(
ui
&
&
!
isInsecure
&
&
!
isBroken
&
&
!
isEV
"
for
'
secure
'
expected
flags
[
0
0
0
]
"
+
(
message
|
|
"
"
)
)
;
break
;
case
"
EV
"
:
test
(
ui
&
&
!
isInsecure
&
&
!
isBroken
&
&
isEV
"
for
'
EV
'
expected
flags
[
0
0
1
]
"
+
(
message
|
|
"
"
)
)
;
break
;
default
:
throw
new
Error
(
"
Invalid
isSecurityState
state
"
)
;
}
}
function
waitForSecurityState
(
expectedState
callback
)
{
let
roundsLeft
=
200
;
let
interval
=
window
.
setInterval
(
(
)
=
>
{
isSecurityState
(
expectedState
"
"
isok
=
>
{
if
(
isok
)
{
roundsLeft
=
0
;
}
}
)
;
if
(
!
roundsLeft
-
-
)
{
window
.
clearInterval
(
interval
)
;
callback
(
)
;
}
}
100
)
;
}
