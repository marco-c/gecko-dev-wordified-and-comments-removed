#
include
"
nsNSSModule
.
h
"
#
include
"
ContentSignatureVerifier
.
h
"
#
include
"
OSKeyStore
.
h
"
#
include
"
OSReauthenticator
.
h
"
#
include
"
PKCS11ModuleDB
.
h
"
#
include
"
SecretDecoderRing
.
h
"
#
include
"
TransportSecurityInfo
.
h
"
#
include
"
mozilla
/
MacroArgs
.
h
"
#
include
"
mozilla
/
ModuleUtils
.
h
"
#
include
"
mozilla
/
SyncRunnable
.
h
"
#
include
"
nsCertTree
.
h
"
#
include
"
nsCryptoHash
.
h
"
#
include
"
nsNSSCertificateDB
.
h
"
#
include
"
nsPK11TokenDB
.
h
"
#
include
"
nsRandomGenerator
.
h
"
#
include
"
nsXULAppAPI
.
h
"
namespace
mozilla
{
namespace
psm
{
template
<
class
InstanceClass
nsresult
(
InstanceClass
:
:
*
InitMethod
)
(
)
>
MOZ_ALWAYS_INLINE
static
nsresult
Instantiate
(
REFNSIID
aIID
void
*
*
aResult
)
{
InstanceClass
*
inst
=
new
InstanceClass
(
)
;
NS_ADDREF
(
inst
)
;
nsresult
rv
=
InitMethod
!
=
nullptr
?
(
inst
-
>
*
InitMethod
)
(
)
:
NS_OK
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
rv
=
inst
-
>
QueryInterface
(
aIID
aResult
)
;
}
NS_RELEASE
(
inst
)
;
return
rv
;
}
enum
class
ThreadRestriction
{
MainThreadOnly
AnyThread
}
;
enum
class
ProcessRestriction
{
ParentProcessOnly
AnyProcess
}
;
template
<
class
InstanceClass
nsresult
(
InstanceClass
:
:
*
InitMethod
)
(
)
=
nullptr
ProcessRestriction
processRestriction
=
ProcessRestriction
:
:
ParentProcessOnly
ThreadRestriction
threadRestriction
=
ThreadRestriction
:
:
AnyThread
>
static
nsresult
Constructor
(
REFNSIID
aIID
void
*
*
aResult
)
{
*
aResult
=
nullptr
;
if
(
processRestriction
=
=
ProcessRestriction
:
:
ParentProcessOnly
&
&
!
XRE_IsParentProcess
(
)
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
if
(
!
EnsureNSSInitializedChromeOrContent
(
)
)
{
return
NS_ERROR_FAILURE
;
}
if
(
threadRestriction
=
=
ThreadRestriction
:
:
MainThreadOnly
&
&
!
NS_IsMainThread
(
)
)
{
return
NS_ERROR_NOT_SAME_THREAD
;
}
return
Instantiate
<
InstanceClass
InitMethod
>
(
aIID
aResult
)
;
}
#
define
IMPL
(
type
.
.
.
)
\
template
<
>
\
nsresult
NSSConstructor
<
type
>
(
const
nsIID
&
aIID
void
*
*
aResult
)
{
\
return
Constructor
<
type
__VA_ARGS__
>
(
aIID
aResult
)
;
\
}
IMPL
(
SecretDecoderRing
nullptr
)
IMPL
(
nsPK11TokenDB
nullptr
)
IMPL
(
PKCS11ModuleDB
nullptr
)
IMPL
(
nsNSSCertificateDB
nullptr
)
IMPL
(
nsCertTree
nullptr
)
IMPL
(
nsCryptoHash
nullptr
ProcessRestriction
:
:
AnyProcess
)
IMPL
(
ContentSignatureVerifier
nullptr
)
IMPL
(
nsRandomGenerator
nullptr
ProcessRestriction
:
:
AnyProcess
)
IMPL
(
TransportSecurityInfo
nullptr
ProcessRestriction
:
:
AnyProcess
)
IMPL
(
OSKeyStore
nullptr
ProcessRestriction
:
:
ParentProcessOnly
ThreadRestriction
:
:
MainThreadOnly
)
IMPL
(
OSReauthenticator
nullptr
ProcessRestriction
:
:
ParentProcessOnly
ThreadRestriction
:
:
MainThreadOnly
)
#
undef
IMPL
}
}
