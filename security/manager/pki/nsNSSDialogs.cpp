#
include
"
nsNSSDialogs
.
h
"
#
include
"
mozIDOMWindow
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Casting
.
h
"
#
include
"
nsArray
.
h
"
#
include
"
nsEmbedCID
.
h
"
#
include
"
nsIDialogParamBlock
.
h
"
#
include
"
nsIInterfaceRequestor
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsIKeygenThread
.
h
"
#
include
"
nsIPromptService
.
h
"
#
include
"
nsIProtectedAuthThread
.
h
"
#
include
"
nsIWindowWatcher
.
h
"
#
include
"
nsIX509CertDB
.
h
"
#
include
"
nsIX509Cert
.
h
"
#
include
"
nsNSSDialogHelper
.
h
"
#
include
"
nsString
.
h
"
#
define
PIPSTRING_BUNDLE_URL
"
chrome
:
/
/
pippki
/
locale
/
pippki
.
properties
"
nsNSSDialogs
:
:
nsNSSDialogs
(
)
{
}
nsNSSDialogs
:
:
~
nsNSSDialogs
(
)
{
}
NS_IMPL_ISUPPORTS
(
nsNSSDialogs
nsITokenPasswordDialogs
nsICertificateDialogs
nsIClientAuthDialogs
nsITokenDialogs
nsIGeneratingKeypairInfoDialogs
)
nsresult
nsNSSDialogs
:
:
Init
(
)
{
nsresult
rv
;
nsCOMPtr
<
nsIStringBundleService
>
service
=
do_GetService
(
NS_STRINGBUNDLE_CONTRACTID
&
rv
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
rv
=
service
-
>
CreateBundle
(
PIPSTRING_BUNDLE_URL
getter_AddRefs
(
mPIPStringBundle
)
)
;
return
rv
;
}
nsresult
nsNSSDialogs
:
:
SetPassword
(
nsIInterfaceRequestor
*
ctx
const
char16_t
*
tokenName
bool
*
_canceled
)
{
nsresult
rv
;
*
_canceled
=
false
;
nsCOMPtr
<
mozIDOMWindowProxy
>
parent
=
do_GetInterface
(
ctx
)
;
nsCOMPtr
<
nsIDialogParamBlock
>
block
=
do_CreateInstance
(
NS_DIALOGPARAMBLOCK_CONTRACTID
)
;
if
(
!
block
)
return
NS_ERROR_FAILURE
;
rv
=
block
-
>
SetString
(
1
tokenName
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
rv
=
nsNSSDialogHelper
:
:
openDialog
(
parent
"
chrome
:
/
/
pippki
/
content
/
changepassword
.
xul
"
block
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
int32_t
status
;
rv
=
block
-
>
GetInt
(
1
&
status
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
*
_canceled
=
(
status
=
=
0
)
?
true
:
false
;
return
rv
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
ConfirmDownloadCACert
(
nsIInterfaceRequestor
*
ctx
nsIX509Cert
*
cert
uint32_t
*
_trust
bool
*
_retval
)
{
nsresult
rv
;
nsCOMPtr
<
nsIMutableArray
>
dlgArray
=
nsArrayBase
:
:
Create
(
)
;
if
(
!
dlgArray
)
{
return
NS_ERROR_FAILURE
;
}
rv
=
dlgArray
-
>
AppendElement
(
cert
false
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
nsCOMPtr
<
nsIDialogParamBlock
>
dlgParamBlock
(
do_CreateInstance
(
NS_DIALOGPARAMBLOCK_CONTRACTID
)
)
;
if
(
!
dlgParamBlock
)
{
return
NS_ERROR_FAILURE
;
}
rv
=
dlgParamBlock
-
>
SetObjects
(
dlgArray
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
nsCOMPtr
<
mozIDOMWindowProxy
>
parent
=
do_GetInterface
(
ctx
)
;
rv
=
nsNSSDialogHelper
:
:
openDialog
(
parent
"
chrome
:
/
/
pippki
/
content
/
downloadcert
.
xul
"
dlgParamBlock
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
int32_t
status
;
int32_t
ssl
email
objsign
;
rv
=
dlgParamBlock
-
>
GetInt
(
1
&
status
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
rv
=
dlgParamBlock
-
>
GetInt
(
2
&
ssl
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
rv
=
dlgParamBlock
-
>
GetInt
(
3
&
email
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
rv
=
dlgParamBlock
-
>
GetInt
(
4
&
objsign
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
*
_trust
=
nsIX509CertDB
:
:
UNTRUSTED
;
*
_trust
|
=
(
ssl
)
?
nsIX509CertDB
:
:
TRUSTED_SSL
:
0
;
*
_trust
|
=
(
email
)
?
nsIX509CertDB
:
:
TRUSTED_EMAIL
:
0
;
*
_trust
|
=
(
objsign
)
?
nsIX509CertDB
:
:
TRUSTED_OBJSIGN
:
0
;
*
_retval
=
(
status
!
=
0
)
;
return
rv
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
ChooseCertificate
(
nsIInterfaceRequestor
*
ctx
const
nsACString
&
hostname
int32_t
port
const
nsACString
&
organization
const
nsACString
&
issuerOrg
nsIArray
*
certList
uint32_t
*
selectedIndex
bool
*
certificateChosen
)
{
NS_ENSURE_ARG_POINTER
(
ctx
)
;
NS_ENSURE_ARG_POINTER
(
certList
)
;
NS_ENSURE_ARG_POINTER
(
selectedIndex
)
;
NS_ENSURE_ARG_POINTER
(
certificateChosen
)
;
*
certificateChosen
=
false
;
nsCOMPtr
<
nsIDialogParamBlock
>
block
=
do_CreateInstance
(
NS_DIALOGPARAMBLOCK_CONTRACTID
)
;
if
(
!
block
)
{
return
NS_ERROR_FAILURE
;
}
nsCOMPtr
<
nsIMutableArray
>
paramBlockArray
=
nsArrayBase
:
:
Create
(
)
;
if
(
!
paramBlockArray
)
{
return
NS_ERROR_FAILURE
;
}
nsresult
rv
=
paramBlockArray
-
>
AppendElement
(
certList
false
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
block
-
>
SetObjects
(
paramBlockArray
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
block
-
>
SetNumberStrings
(
3
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
block
-
>
SetString
(
0
NS_ConvertUTF8toUTF16
(
hostname
)
.
get
(
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
block
-
>
SetString
(
1
NS_ConvertUTF8toUTF16
(
organization
)
.
get
(
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
block
-
>
SetString
(
2
NS_ConvertUTF8toUTF16
(
issuerOrg
)
.
get
(
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
block
-
>
SetInt
(
0
port
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
nsNSSDialogHelper
:
:
openDialog
(
nullptr
"
chrome
:
/
/
pippki
/
content
/
clientauthask
.
xul
"
block
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
int32_t
status
;
rv
=
block
-
>
GetInt
(
0
&
status
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
nsCOMPtr
<
nsIClientAuthUserDecision
>
extraResult
=
do_QueryInterface
(
ctx
)
;
if
(
extraResult
)
{
int32_t
rememberSelection
;
rv
=
block
-
>
GetInt
(
2
&
rememberSelection
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
extraResult
-
>
SetRememberClientAuthCertificate
(
rememberSelection
!
=
0
)
;
}
}
*
certificateChosen
=
(
status
!
=
0
)
;
if
(
*
certificateChosen
)
{
int32_t
index
=
0
;
rv
=
block
-
>
GetInt
(
1
&
index
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
if
(
index
<
0
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Selected
index
should
never
be
negative
"
)
;
return
NS_ERROR_FAILURE
;
}
*
selectedIndex
=
mozilla
:
:
AssertedCast
<
uint32_t
>
(
index
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
SetPKCS12FilePassword
(
nsIInterfaceRequestor
*
ctx
nsAString
&
_password
bool
*
_retval
)
{
nsresult
rv
;
*
_retval
=
true
;
nsCOMPtr
<
mozIDOMWindowProxy
>
parent
=
do_GetInterface
(
ctx
)
;
nsCOMPtr
<
nsIDialogParamBlock
>
block
=
do_CreateInstance
(
NS_DIALOGPARAMBLOCK_CONTRACTID
)
;
if
(
!
block
)
return
NS_ERROR_FAILURE
;
rv
=
nsNSSDialogHelper
:
:
openDialog
(
parent
"
chrome
:
/
/
pippki
/
content
/
setp12password
.
xul
"
block
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
int32_t
status
;
rv
=
block
-
>
GetInt
(
1
&
status
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
*
_retval
=
(
status
=
=
0
)
?
false
:
true
;
if
(
*
_retval
)
{
char16_t
*
pw
;
rv
=
block
-
>
GetString
(
2
&
pw
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
_password
=
pw
;
free
(
pw
)
;
}
}
return
rv
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
GetPKCS12FilePassword
(
nsIInterfaceRequestor
*
ctx
nsAString
&
_password
bool
*
_retval
)
{
*
_retval
=
false
;
nsCOMPtr
<
nsIPromptService
>
promptSvc
(
do_GetService
(
NS_PROMPTSERVICE_CONTRACTID
)
)
;
if
(
!
promptSvc
)
{
return
NS_ERROR_FAILURE
;
}
nsAutoString
msg
;
nsresult
rv
=
mPIPStringBundle
-
>
GetStringFromName
(
u
"
getPKCS12FilePasswordMessage
"
getter_Copies
(
msg
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
nsCOMPtr
<
mozIDOMWindowProxy
>
parent
=
do_GetInterface
(
ctx
)
;
bool
ignored
=
false
;
char16_t
*
pwTemp
=
nullptr
;
rv
=
promptSvc
-
>
PromptPassword
(
parent
nullptr
msg
.
get
(
)
&
pwTemp
nullptr
&
ignored
_retval
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
if
(
*
_retval
)
{
_password
.
Assign
(
pwTemp
)
;
free
(
pwTemp
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
ViewCert
(
nsIInterfaceRequestor
*
ctx
nsIX509Cert
*
cert
)
{
NS_ENSURE_ARG
(
cert
)
;
nsCOMPtr
<
mozIDOMWindowProxy
>
parent
=
do_GetInterface
(
ctx
)
;
return
nsNSSDialogHelper
:
:
openDialog
(
parent
"
chrome
:
/
/
pippki
/
content
/
certViewer
.
xul
"
cert
false
)
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
DisplayGeneratingKeypairInfo
(
nsIInterfaceRequestor
*
aCtx
nsIKeygenThread
*
runnable
)
{
nsresult
rv
;
nsCOMPtr
<
mozIDOMWindowProxy
>
parent
=
do_GetInterface
(
aCtx
)
;
rv
=
nsNSSDialogHelper
:
:
openDialog
(
parent
"
chrome
:
/
/
pippki
/
content
/
createCertInfo
.
xul
"
runnable
)
;
return
rv
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
ChooseToken
(
nsIInterfaceRequestor
*
aCtx
const
char16_t
*
*
aTokenList
uint32_t
aCount
char16_t
*
*
aTokenChosen
bool
*
aCanceled
)
{
nsresult
rv
;
uint32_t
i
;
*
aCanceled
=
false
;
nsCOMPtr
<
nsIDialogParamBlock
>
block
=
do_CreateInstance
(
NS_DIALOGPARAMBLOCK_CONTRACTID
)
;
if
(
!
block
)
return
NS_ERROR_FAILURE
;
block
-
>
SetNumberStrings
(
aCount
)
;
for
(
i
=
0
;
i
<
aCount
;
i
+
+
)
{
rv
=
block
-
>
SetString
(
i
aTokenList
[
i
]
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
}
rv
=
block
-
>
SetInt
(
0
aCount
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
rv
=
nsNSSDialogHelper
:
:
openDialog
(
nullptr
"
chrome
:
/
/
pippki
/
content
/
choosetoken
.
xul
"
block
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
int32_t
status
;
rv
=
block
-
>
GetInt
(
0
&
status
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
*
aCanceled
=
(
status
=
=
0
)
?
true
:
false
;
if
(
!
*
aCanceled
)
{
rv
=
block
-
>
GetString
(
0
aTokenChosen
)
;
}
return
rv
;
}
NS_IMETHODIMP
nsNSSDialogs
:
:
DisplayProtectedAuth
(
nsIInterfaceRequestor
*
aCtx
nsIProtectedAuthThread
*
runnable
)
{
nsresult
rv
=
NS_ERROR_FAILURE
;
nsCOMPtr
<
mozIDOMWindowProxy
>
parent
=
do_GetInterface
(
aCtx
)
;
nsCOMPtr
<
nsIWindowWatcher
>
windowWatcher
=
do_GetService
(
"
mozilla
.
org
/
embedcomp
/
window
-
watcher
;
1
"
&
rv
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
if
(
!
parent
)
{
windowWatcher
-
>
GetActiveWindow
(
getter_AddRefs
(
parent
)
)
;
}
nsCOMPtr
<
mozIDOMWindowProxy
>
newWindow
;
rv
=
windowWatcher
-
>
OpenWindow
(
parent
"
chrome
:
/
/
pippki
/
content
/
protectedAuth
.
xul
"
"
_blank
"
"
centerscreen
chrome
modal
titlebar
close
=
no
"
runnable
getter_AddRefs
(
newWindow
)
)
;
return
rv
;
}
