"
use
strict
"
;
const
{
TabStateFlusher
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
/
modules
/
sessionstore
/
TabStateFlusher
.
sys
.
mjs
"
)
;
const
ABOUT_BLANK_FROM_CONTENT_STATE
=
{
entries
:
[
{
url
:
"
about
:
blank
"
principalToInherit_base64
:
'
{
"
1
"
:
{
"
0
"
:
"
https
:
/
/
example
.
com
/
"
}
}
'
triggeringPrincipal_base64
:
'
{
"
1
"
:
{
"
0
"
:
"
https
:
/
/
example
.
com
/
"
}
}
'
}
]
index
:
1
}
;
add_task
(
async
function
test_about_blank_tab_state_matches_fixture
(
)
{
const
openerTab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
https
:
/
/
example
.
com
/
"
)
;
const
newTabPromise
=
BrowserTestUtils
.
waitForNewTab
(
gBrowser
"
about
:
blank
"
true
)
;
await
SpecialPowers
.
spawn
(
openerTab
.
linkedBrowser
[
]
(
)
=
>
{
content
.
open
(
"
about
:
blank
"
)
;
}
)
;
const
aboutBlankTab
=
await
newTabPromise
;
await
TabStateFlusher
.
flush
(
aboutBlankTab
.
linkedBrowser
)
;
const
state
=
JSON
.
parse
(
SessionStore
.
getTabState
(
aboutBlankTab
)
)
;
is
(
state
.
entries
.
length
1
"
Got
one
SH
entry
"
)
;
const
actualEntryFixture
=
{
url
:
state
.
entries
[
0
]
.
url
principalToInherit_base64
:
state
.
entries
[
0
]
.
principalToInherit_base64
triggeringPrincipal_base64
:
state
.
entries
[
0
]
.
triggeringPrincipal_base64
}
;
Assert
.
deepEqual
(
actualEntryFixture
ABOUT_BLANK_FROM_CONTENT_STATE
.
entries
[
0
]
)
;
BrowserTestUtils
.
removeTab
(
aboutBlankTab
)
;
BrowserTestUtils
.
removeTab
(
openerTab
)
;
}
)
;
add_task
(
async
function
test_restore_initial_about_blank_with_content_principal
(
)
{
const
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
)
;
let
restored
=
BrowserTestUtils
.
waitForEvent
(
win
.
gBrowser
.
tabContainer
"
SSTabRestored
"
)
;
const
windowState
=
{
windows
:
[
{
tabs
:
[
ABOUT_BLANK_FROM_CONTENT_STATE
]
selected
:
1
}
]
selectedWindow
:
1
}
;
SessionStore
.
setWindowState
(
win
JSON
.
stringify
(
windowState
)
true
)
;
await
restored
;
ok
(
true
"
Did
not
crash
"
)
;
const
tab
=
win
.
gBrowser
.
selectedTab
;
await
SpecialPowers
.
spawn
(
tab
.
linkedBrowser
[
]
function
(
)
{
let
principal
=
content
.
document
.
nodePrincipal
;
const
isInitialCommitted
=
content
.
document
.
isInitialDocument
&
&
!
content
.
document
.
isUncommittedInitialDocument
;
Assert
.
ok
(
!
isInitialCommitted
"
about
:
blank
was
not
restored
as
initial
document
"
)
;
Assert
.
ok
(
principal
.
isContentPrincipal
"
Restored
about
:
blank
document
has
a
content
principal
"
)
;
Assert
.
equal
(
principal
.
origin
"
https
:
/
/
example
.
com
"
"
Restored
about
:
blank
inherits
the
origin
from
https
:
/
/
example
.
com
/
"
)
;
}
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
