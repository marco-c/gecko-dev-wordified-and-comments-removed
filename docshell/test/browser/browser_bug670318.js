const
URL
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
docshell
/
test
/
browser
/
file_bug670318
.
html
"
;
add_task
(
function
*
test
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
function
*
(
browser
)
{
yield
ContentTask
.
spawn
(
browser
URL
function
*
(
URL
)
{
let
history
=
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
sessionHistory
;
let
count
=
0
;
let
testDone
=
{
}
;
testDone
.
promise
=
new
Promise
(
resolve
=
>
{
testDone
.
resolve
=
resolve
;
}
)
;
let
listener
=
{
OnHistoryNewEntry
:
function
(
aNewURI
)
{
if
(
aNewURI
.
spec
=
=
URL
&
&
5
=
=
+
+
count
)
{
addEventListener
(
"
load
"
function
onLoad
(
)
{
removeEventListener
(
"
load
"
onLoad
true
)
;
ok
(
history
.
index
<
history
.
count
"
history
.
index
is
valid
"
)
;
testDone
.
resolve
(
)
;
}
true
)
;
history
.
removeSHistoryListener
(
listener
)
;
content
.
setTimeout
(
(
)
=
>
{
content
.
location
.
reload
(
)
;
}
0
)
;
}
return
true
;
}
OnHistoryReload
:
(
)
=
>
true
OnHistoryGoBack
:
(
)
=
>
true
OnHistoryGoForward
:
(
)
=
>
true
OnHistoryGotoIndex
:
(
)
=
>
true
OnHistoryPurge
:
(
)
=
>
true
OnHistoryReplaceEntry
:
(
)
=
>
{
+
+
count
;
return
true
;
}
QueryInterface
:
XPCOMUtils
.
generateQI
(
[
Ci
.
nsISHistoryListener
Ci
.
nsISupportsWeakReference
]
)
}
;
history
.
addSHistoryListener
(
listener
)
;
content
.
location
=
URL
;
yield
testDone
.
promise
;
}
)
;
}
)
;
}
)
;
