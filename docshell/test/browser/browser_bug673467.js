var
doc
=
"
data
:
text
/
html
<
html
>
<
body
onload
=
'
load
(
)
'
>
"
+
"
<
script
>
"
+
"
var
iframe
=
document
.
createElement
(
'
iframe
'
)
;
"
+
"
iframe
.
id
=
'
iframe
'
;
"
+
"
document
.
documentElement
.
appendChild
(
iframe
)
;
"
+
"
function
load
(
)
{
"
+
"
iframe
.
src
=
'
data
:
text
/
html
Hello
!
'
;
"
+
"
}
"
+
"
<
/
script
>
"
+
"
<
/
body
>
<
/
html
>
"
function
test
(
)
{
waitForExplicitFinish
(
)
;
let
tab
=
gBrowser
.
addTab
(
doc
)
;
let
tabBrowser
=
tab
.
linkedBrowser
;
BrowserTestUtils
.
browserLoaded
(
tab
.
linkedBrowser
)
.
then
(
(
)
=
>
{
return
ContentTask
.
spawn
(
tab
.
linkedBrowser
null
(
)
=
>
{
return
new
Promise
(
resolve
=
>
{
let
iframe
=
content
.
document
.
getElementById
(
'
iframe
'
)
;
iframe
.
addEventListener
(
'
load
'
function
listener
(
aEvent
)
{
if
(
!
iframe
.
src
)
return
;
iframe
.
removeEventListener
(
'
load
'
listener
true
)
;
let
shistory
=
content
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsIWebNavigation
)
.
sessionHistory
;
Assert
.
equal
(
shistory
.
count
1
"
shistory
count
should
be
1
.
"
)
;
resolve
(
)
;
}
true
)
;
}
)
;
}
)
;
}
)
.
then
(
(
)
=
>
{
gBrowser
.
removeTab
(
tab
)
;
finish
(
)
;
}
)
;
}
