"
use
strict
"
;
const
{
ExtensionTestUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
testing
-
common
/
ExtensionXPCShellUtils
.
jsm
"
)
;
AddonTestUtils
.
init
(
this
)
;
ExtensionTestUtils
.
init
(
this
)
;
const
server
=
AddonTestUtils
.
createHttpServer
(
{
hosts
:
[
"
example
.
com
"
]
}
)
;
function
registerSlowPage
(
path
)
{
let
result
=
{
url
:
http
:
/
/
example
.
com
/
{
path
}
}
;
let
finishedPromise
=
new
Promise
(
resolve
=
>
{
result
.
finish
=
resolve
;
}
)
;
server
.
registerPathHandler
(
/
{
path
}
async
(
request
response
)
=
>
{
response
.
processAsync
(
)
;
response
.
setHeader
(
"
Content
-
Type
"
"
text
/
html
"
)
;
response
.
write
(
"
<
html
>
<
body
>
Hello
.
<
/
body
>
<
/
html
>
"
)
;
await
finishedPromise
;
response
.
finish
(
)
;
}
)
;
return
result
;
}
let
topFrameRequest
=
registerSlowPage
(
"
top
.
html
"
)
;
let
subFrameRequest
=
registerSlowPage
(
"
frame
.
html
"
)
;
let
thunks
=
new
Set
(
)
;
function
promiseStateStop
(
webProgress
)
{
return
new
Promise
(
resolve
=
>
{
let
listener
=
{
onStateChange
(
aWebProgress
request
stateFlags
status
)
{
if
(
stateFlags
&
Ci
.
nsIWebProgressListener
.
STATE_STOP
)
{
webProgress
.
removeProgressListener
(
listener
)
;
thunks
.
delete
(
listener
)
;
resolve
(
)
;
}
}
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIWebProgressListener
"
"
nsISupportsWeakReference
"
]
)
}
;
thunks
.
add
(
listener
)
;
webProgress
.
addProgressListener
(
listener
Ci
.
nsIWebProgress
.
NOTIFY_STATE_REQUEST
)
;
}
)
;
}
async
function
runTest
(
waitForErrorPage
)
{
let
page
=
await
ExtensionTestUtils
.
loadContentPage
(
"
about
:
blank
"
{
remote
:
false
}
)
;
let
{
browser
}
=
page
;
let
requestPromise
=
TestUtils
.
topicObserved
(
"
http
-
on
-
modify
-
request
"
subject
=
>
subject
.
QueryInterface
(
Ci
.
nsIRequest
)
.
name
=
=
topFrameRequest
.
url
)
;
let
doc
=
browser
.
contentDocument
;
let
frame
=
doc
.
createElement
(
"
iframe
"
)
;
frame
.
src
=
topFrameRequest
.
url
;
doc
.
body
.
appendChild
(
frame
)
;
let
frameDoc
=
frame
.
contentDocument
;
let
subframe
=
frameDoc
.
createElement
(
"
iframe
"
)
;
subframe
.
src
=
subFrameRequest
.
url
;
frameDoc
.
body
.
appendChild
(
subframe
)
;
let
[
req
]
=
await
requestPromise
;
info
(
"
Cancel
request
for
parent
frame
"
)
;
req
.
cancel
(
Cr
.
NS_ERROR_PROXY_CONNECTION_REFUSED
)
;
await
promiseStateStop
(
browser
.
docShell
.
nsIInterfaceRequestor
.
getInterface
(
Ci
.
nsIWebProgress
)
)
;
await
new
Promise
(
executeSoon
)
;
if
(
waitForErrorPage
)
{
await
TestUtils
.
waitForCondition
(
(
)
=
>
frame
.
contentDocument
.
documentURI
.
startsWith
(
"
about
:
neterror
?
"
)
)
;
}
info
(
"
Remove
frame
"
)
;
frame
.
remove
(
)
;
await
page
.
close
(
)
;
}
add_task
(
async
function
testRemoveFrameImmediately
(
)
{
await
runTest
(
false
)
;
}
)
;
add_task
(
async
function
testRemoveFrameAfterErrorPage
(
)
{
await
runTest
(
true
)
;
}
)
;
add_task
(
async
function
(
)
{
topFrameRequest
.
finish
(
)
;
subFrameRequest
.
finish
(
)
;
}
)
;
