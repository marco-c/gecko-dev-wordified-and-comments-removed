var
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
AddonTestUtils
:
"
resource
:
/
/
testing
-
common
/
AddonTestUtils
.
jsm
"
SearchUtils
:
"
resource
:
/
/
gre
/
modules
/
SearchUtils
.
jsm
"
SearchTestUtils
:
"
resource
:
/
/
testing
-
common
/
SearchTestUtils
.
jsm
"
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
}
)
;
var
dirSvc
=
Services
.
dirSvc
;
var
profileDir
=
do_get_profile
(
)
;
const
kSearchEngineID
=
"
test_urifixup_search_engine
"
;
const
kSearchEngineURL
=
"
https
:
/
/
www
.
example
.
org
/
?
search
=
{
searchTerms
}
"
;
const
kPrivateSearchEngineID
=
"
test_urifixup_search_engine_private
"
;
const
kPrivateSearchEngineURL
=
"
https
:
/
/
www
.
example
.
org
/
?
private
=
{
searchTerms
}
"
;
const
SEARCH_CONFIG
=
[
{
appliesTo
:
[
{
included
:
{
everywhere
:
true
}
}
]
default
:
"
yes
"
webExtension
:
{
id
:
"
fixup_search
search
.
mozilla
.
org
"
}
}
]
;
async
function
setupSearchService
(
)
{
SearchTestUtils
.
init
(
Assert
registerCleanupFunction
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
search
.
modernConfig
"
true
)
;
AddonTestUtils
.
init
(
this
)
;
AddonTestUtils
.
overrideCertDB
(
)
;
AddonTestUtils
.
createAppInfo
(
"
xpcshell
tests
.
mozilla
.
org
"
"
XPCShell
"
"
1
"
"
42
"
)
;
await
SearchTestUtils
.
useTestEngines
(
"
.
"
null
SEARCH_CONFIG
)
;
await
AddonTestUtils
.
promiseStartupManager
(
)
;
await
Services
.
search
.
init
(
)
;
}
async
function
addTestEngines
(
)
{
await
Services
.
search
.
addPolicyEngine
(
{
description
:
"
urifixup
search
engine
"
chrome_settings_overrides
:
{
search_provider
:
{
name
:
"
test_urifixup_search_engine
"
search_url
:
"
https
:
/
/
www
.
example
.
org
/
?
search
=
{
searchTerms
}
"
}
}
}
)
;
await
Services
.
search
.
addPolicyEngine
(
{
description
:
"
urifixup
private
search
engine
"
chrome_settings_overrides
:
{
search_provider
:
{
name
:
"
test_urifixup_search_engine_private
"
search_url
:
"
https
:
/
/
www
.
example
.
org
/
?
private
=
{
searchTerms
}
"
}
}
}
)
;
}
