add_task
(
async
function
(
)
{
var
URL
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
docshell
/
test
/
navigation
/
bug343515_pg1
.
html
"
;
var
URL2
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
docshell
/
test
/
navigation
/
bug343515_pg3_1
.
html
"
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
URL
}
async
function
(
browser
)
{
if
(
SpecialPowers
.
Services
.
appinfo
.
sessionHistoryInParent
)
{
let
sh
=
browser
.
browsingContext
.
sessionHistory
;
is
(
sh
.
count
1
"
We
should
have
entry
in
session
history
because
we
haven
'
t
changed
gHistoryMaxSize
to
be
0
yet
"
)
;
is
(
sh
.
index
0
"
Shistory
'
s
current
index
should
be
0
because
we
haven
'
t
purged
history
yet
"
)
;
}
else
{
await
ContentTask
.
spawn
(
browser
null
(
)
=
>
{
var
sh
=
content
.
window
.
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
sessionHistory
.
legacySHistory
;
is
(
sh
.
count
1
"
We
should
have
entry
in
session
history
because
we
haven
'
t
changed
gHistoryMaxSize
to
be
0
yet
"
)
;
is
(
sh
.
index
0
"
Shistory
'
s
current
index
should
be
0
because
we
haven
'
t
purged
history
yet
"
)
;
}
)
;
}
var
loadPromise
=
BrowserTestUtils
.
browserLoaded
(
browser
false
URL2
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
sessionhistory
.
max_entries
"
0
]
]
}
)
;
BrowserTestUtils
.
loadURI
(
browser
URL2
)
;
await
loadPromise
;
var
promise
=
BrowserTestUtils
.
browserLoaded
(
browser
)
;
browser
.
reloadWithFlags
(
Ci
.
nsIWebNavigation
.
LOAD_FLAGS_BYPASS_CACHE
)
;
await
promise
;
if
(
SpecialPowers
.
Services
.
appinfo
.
sessionHistoryInParent
)
{
let
sh
=
browser
.
browsingContext
.
sessionHistory
;
is
(
sh
.
count
0
"
We
should
not
save
any
entries
in
session
history
"
)
;
is
(
sh
.
index
-
1
)
;
is
(
sh
.
requestedIndex
-
1
)
;
}
else
{
await
ContentTask
.
spawn
(
browser
null
(
)
=
>
{
var
sh
=
content
.
window
.
docShell
.
QueryInterface
(
Ci
.
nsIWebNavigation
)
.
sessionHistory
.
legacySHistory
;
is
(
sh
.
count
0
"
We
should
not
save
any
entries
in
session
history
"
)
;
is
(
sh
.
index
-
1
)
;
is
(
sh
.
requestedIndex
-
1
)
;
}
)
;
}
}
)
;
}
)
;
