#
ifndef
nsSHistory_h
#
define
nsSHistory_h
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsExpirationTracker
.
h
"
#
include
"
nsIPartialSHistoryListener
.
h
"
#
include
"
nsISHistory
.
h
"
#
include
"
nsISHistoryInternal
.
h
"
#
include
"
nsISimpleEnumerator
.
h
"
#
include
"
nsIWebNavigation
.
h
"
#
include
"
nsSHEntryShared
.
h
"
#
include
"
nsTObserverArray
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
class
nsIDocShell
;
class
nsSHEnumerator
;
class
nsSHistoryObserver
;
class
nsISHEntry
;
class
nsISHTransaction
;
class
nsSHistory
final
:
public
mozilla
:
:
LinkedListElement
<
nsSHistory
>
public
nsISHistory
public
nsISHistoryInternal
public
nsIWebNavigation
public
nsSupportsWeakReference
{
public
:
class
HistoryTracker
final
:
public
nsExpirationTracker
<
nsSHEntryShared
3
>
{
public
:
explicit
HistoryTracker
(
nsSHistory
*
aSHistory
uint32_t
aTimeout
nsIEventTarget
*
aEventTarget
)
:
nsExpirationTracker
(
1000
*
aTimeout
/
2
"
HistoryTracker
"
aEventTarget
)
{
MOZ_ASSERT
(
aSHistory
)
;
mSHistory
=
aSHistory
;
}
protected
:
virtual
void
NotifyExpired
(
nsSHEntryShared
*
aObj
)
{
RemoveObject
(
aObj
)
;
mSHistory
-
>
EvictExpiredContentViewerForEntry
(
aObj
)
;
}
private
:
nsSHistory
*
mSHistory
;
}
;
nsSHistory
(
)
;
NS_DECL_ISUPPORTS
NS_DECL_NSISHISTORY
NS_DECL_NSISHISTORYINTERNAL
NS_DECL_NSIWEBNAVIGATION
static
nsresult
Startup
(
)
;
static
void
Shutdown
(
)
;
static
void
UpdatePrefs
(
)
;
static
uint32_t
GetMaxTotalViewers
(
)
{
return
sHistoryMaxTotalViewers
;
}
private
:
virtual
~
nsSHistory
(
)
;
friend
class
nsSHEnumerator
;
friend
class
nsSHistoryObserver
;
NS_IMETHOD
GetTransactionAtIndex
(
int32_t
aIndex
nsISHTransaction
*
*
aResult
)
;
nsresult
LoadDifferingEntries
(
nsISHEntry
*
aPrevEntry
nsISHEntry
*
aNextEntry
nsIDocShell
*
aRootDocShell
long
aLoadType
bool
&
aDifferenceFound
)
;
nsresult
InitiateLoad
(
nsISHEntry
*
aFrameEntry
nsIDocShell
*
aFrameDS
long
aLoadType
)
;
NS_IMETHOD
LoadEntry
(
int32_t
aIndex
long
aLoadType
uint32_t
aHistCmd
)
;
#
ifdef
DEBUG
nsresult
PrintHistory
(
)
;
#
endif
void
EvictOutOfRangeWindowContentViewers
(
int32_t
aIndex
)
;
void
EvictContentViewerForTransaction
(
nsISHTransaction
*
aTrans
)
;
static
void
GloballyEvictContentViewers
(
)
;
static
void
GloballyEvictAllContentViewers
(
)
;
static
uint32_t
CalcMaxTotalViewers
(
)
;
nsresult
LoadNextPossibleEntry
(
int32_t
aNewIndex
long
aLoadType
uint32_t
aHistCmd
)
;
bool
RemoveDuplicate
(
int32_t
aIndex
bool
aKeepNext
)
;
mozilla
:
:
UniquePtr
<
HistoryTracker
>
mHistoryTracker
;
nsCOMPtr
<
nsISHTransaction
>
mListRoot
;
int32_t
mIndex
;
int32_t
mLength
;
int32_t
mRequestedIndex
;
int32_t
mGlobalIndexOffset
;
int32_t
mEntriesInFollowingPartialHistories
;
nsAutoTObserverArray
<
nsWeakPtr
2
>
mListeners
;
nsWeakPtr
mPartialHistoryListener
;
nsIDocShell
*
mRootDocShell
;
bool
mIsPartial
;
static
int32_t
sHistoryMaxTotalViewers
;
}
;
class
nsSHEnumerator
:
public
nsISimpleEnumerator
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSISIMPLEENUMERATOR
explicit
nsSHEnumerator
(
nsSHistory
*
aHistory
)
;
protected
:
friend
class
nsSHistory
;
virtual
~
nsSHEnumerator
(
)
;
private
:
int32_t
mIndex
;
nsSHistory
*
mSHistory
;
}
;
#
endif
