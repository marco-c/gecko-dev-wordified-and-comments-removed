#
include
"
nsWebNavigationInfo
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContext
.
h
"
#
include
"
nsIWebNavigation
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsIDocumentLoaderFactory
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
imgLoader
.
h
"
#
include
"
nsPluginHost
.
h
"
NS_IMPL_ISUPPORTS
(
nsWebNavigationInfo
nsIWebNavigationInfo
)
NS_IMETHODIMP
nsWebNavigationInfo
:
:
IsTypeSupported
(
const
nsACString
&
aType
nsIWebNavigation
*
aWebNav
uint32_t
*
aIsTypeSupported
)
{
MOZ_ASSERT
(
aIsTypeSupported
"
null
out
param
?
"
)
;
*
aIsTypeSupported
=
IsTypeSupported
(
aType
aWebNav
)
;
return
NS_OK
;
}
uint32_t
nsWebNavigationInfo
:
:
IsTypeSupported
(
const
nsACString
&
aType
nsIWebNavigation
*
aWebNav
)
{
nsCOMPtr
<
nsIDocShell
>
docShell
(
do_QueryInterface
(
aWebNav
)
)
;
auto
*
browsingContext
=
docShell
?
docShell
-
>
GetBrowsingContext
(
)
:
nullptr
;
bool
pluginsAllowed
=
browsingContext
?
browsingContext
-
>
GetAllowPlugins
(
)
:
true
;
return
IsTypeSupported
(
aType
pluginsAllowed
)
;
}
uint32_t
nsWebNavigationInfo
:
:
IsTypeSupported
(
const
nsACString
&
aType
bool
aPluginsAllowed
)
{
if
(
aType
.
LowerCaseEqualsLiteral
(
"
application
/
pdf
"
)
&
&
nsContentUtils
:
:
IsPDFJSEnabled
(
)
)
{
return
nsIWebNavigationInfo
:
:
UNSUPPORTED
;
;
}
const
nsCString
&
flatType
=
PromiseFlatCString
(
aType
)
;
return
IsTypeSupportedInternal
(
flatType
)
;
}
uint32_t
nsWebNavigationInfo
:
:
IsTypeSupportedInternal
(
const
nsCString
&
aType
)
{
nsContentUtils
:
:
ContentViewerType
vtype
=
nsContentUtils
:
:
TYPE_UNSUPPORTED
;
nsCOMPtr
<
nsIDocumentLoaderFactory
>
docLoaderFactory
=
nsContentUtils
:
:
FindInternalContentViewer
(
aType
&
vtype
)
;
switch
(
vtype
)
{
case
nsContentUtils
:
:
TYPE_UNSUPPORTED
:
return
nsIWebNavigationInfo
:
:
UNSUPPORTED
;
case
nsContentUtils
:
:
TYPE_PLUGIN
:
return
nsIWebNavigationInfo
:
:
PLUGIN
;
case
nsContentUtils
:
:
TYPE_UNKNOWN
:
return
nsIWebNavigationInfo
:
:
OTHER
;
case
nsContentUtils
:
:
TYPE_CONTENT
:
if
(
imgLoader
:
:
SupportImageWithMimeType
(
aType
.
get
(
)
)
)
{
return
nsIWebNavigationInfo
:
:
IMAGE
;
}
else
{
return
nsIWebNavigationInfo
:
:
OTHER
;
}
}
return
nsIWebNavigationInfo
:
:
UNSUPPORTED
;
}
