#
include
"
mozilla
/
dom
/
ChildProcessChannelListener
.
h
"
namespace
mozilla
{
namespace
dom
{
static
StaticRefPtr
<
ChildProcessChannelListener
>
sCPCLSingleton
;
void
ChildProcessChannelListener
:
:
RegisterCallback
(
uint64_t
aIdentifier
Callback
&
&
aCallback
)
{
if
(
auto
channel
=
mChannels
.
GetAndRemove
(
aIdentifier
)
)
{
aCallback
(
*
channel
)
;
}
else
{
mCallbacks
.
Put
(
aIdentifier
std
:
:
move
(
aCallback
)
)
;
}
}
NS_IMETHODIMP
ChildProcessChannelListener
:
:
OnChannelReady
(
nsIChildChannel
*
aChannel
uint64_t
aIdentifier
)
{
if
(
auto
callback
=
mCallbacks
.
GetAndRemove
(
aIdentifier
)
)
{
(
*
callback
)
(
aChannel
)
;
}
else
{
mChannels
.
Put
(
aIdentifier
aChannel
)
;
}
return
NS_OK
;
}
ChildProcessChannelListener
:
:
ChildProcessChannelListener
(
)
=
default
;
ChildProcessChannelListener
:
:
~
ChildProcessChannelListener
(
)
=
default
;
already_AddRefed
<
ChildProcessChannelListener
>
ChildProcessChannelListener
:
:
GetSingleton
(
)
{
if
(
!
sCPCLSingleton
)
{
sCPCLSingleton
=
new
ChildProcessChannelListener
(
)
;
ClearOnShutdown
(
&
sCPCLSingleton
)
;
}
RefPtr
<
ChildProcessChannelListener
>
cpcl
=
sCPCLSingleton
;
return
cpcl
.
forget
(
)
;
}
NS_IMPL_ISUPPORTS
(
ChildProcessChannelListener
nsIChildProcessChannelListener
)
;
}
}
