#
ifndef
mozilla_TimelineConsumers_h_
#
define
mozilla_TimelineConsumers_h_
#
include
"
nsIObserver
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
TimelineMarkerEnums
.
h
"
class
nsDocShell
;
class
nsIDocShell
;
struct
JSContext
;
namespace
mozilla
{
class
TimeStamp
;
class
MarkersStorage
;
class
AbstractTimelineMarker
;
namespace
dom
{
struct
ProfileTimelineMarker
;
}
class
TimelineConsumers
:
public
nsIObserver
{
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIOBSERVER
private
:
TimelineConsumers
(
)
;
TimelineConsumers
(
const
TimelineConsumers
&
aOther
)
=
delete
;
void
operator
=
(
const
TimelineConsumers
&
aOther
)
=
delete
;
virtual
~
TimelineConsumers
(
)
=
default
;
bool
RemoveObservers
(
)
;
public
:
static
void
Init
(
)
;
static
already_AddRefed
<
TimelineConsumers
>
Get
(
)
;
void
AddConsumer
(
nsDocShell
*
aDocShell
)
;
void
RemoveConsumer
(
nsDocShell
*
aDocShell
)
;
bool
HasConsumer
(
nsIDocShell
*
aDocShell
)
;
bool
IsEmpty
(
)
;
void
AddMarkerForDocShell
(
nsDocShell
*
aDocShell
const
char
*
aName
MarkerTracingType
aTracingType
MarkerStackRequest
aStackRequest
=
MarkerStackRequest
:
:
STACK
)
;
void
AddMarkerForDocShell
(
nsIDocShell
*
aDocShell
const
char
*
aName
MarkerTracingType
aTracingType
MarkerStackRequest
aStackRequest
=
MarkerStackRequest
:
:
STACK
)
;
void
AddMarkerForDocShell
(
nsDocShell
*
aDocShell
const
char
*
aName
const
TimeStamp
&
aTime
MarkerTracingType
aTracingType
MarkerStackRequest
aStackRequest
=
MarkerStackRequest
:
:
STACK
)
;
void
AddMarkerForDocShell
(
nsIDocShell
*
aDocShell
const
char
*
aName
const
TimeStamp
&
aTime
MarkerTracingType
aTracingType
MarkerStackRequest
aStackRequest
=
MarkerStackRequest
:
:
STACK
)
;
void
AddMarkerForDocShell
(
nsDocShell
*
aDocShell
UniquePtr
<
AbstractTimelineMarker
>
&
&
aMarker
)
;
void
AddMarkerForDocShell
(
nsIDocShell
*
aDocShell
UniquePtr
<
AbstractTimelineMarker
>
&
&
aMarker
)
;
void
AddMarkerForAllObservedDocShells
(
const
char
*
aName
MarkerTracingType
aTracingType
MarkerStackRequest
aStackRequest
=
MarkerStackRequest
:
:
STACK
)
;
void
AddMarkerForAllObservedDocShells
(
const
char
*
aName
const
TimeStamp
&
aTime
MarkerTracingType
aTracingType
MarkerStackRequest
aStackRequest
=
MarkerStackRequest
:
:
STACK
)
;
void
AddMarkerForAllObservedDocShells
(
UniquePtr
<
AbstractTimelineMarker
>
&
aMarker
)
;
void
PopMarkers
(
nsDocShell
*
aDocShell
JSContext
*
aCx
nsTArray
<
dom
:
:
ProfileTimelineMarker
>
&
aStore
)
;
private
:
static
StaticRefPtr
<
TimelineConsumers
>
sInstance
;
static
Atomic
<
bool
>
sInShutdown
;
unsigned
long
mActiveConsumers
;
LinkedList
<
MarkersStorage
>
mMarkersStores
;
static
StaticMutex
sMutex
MOZ_UNANNOTATED
;
}
;
}
#
endif
