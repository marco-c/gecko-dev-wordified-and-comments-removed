#
include
"
mozilla
/
dom
/
CanonicalBrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContextGroup
.
h
"
#
include
"
mozilla
/
dom
/
WindowGlobalParent
.
h
"
#
include
"
mozilla
/
dom
/
ContentProcessManager
.
h
"
namespace
mozilla
{
namespace
dom
{
extern
mozilla
:
:
LazyLogModule
gUserInteractionPRLog
;
#
define
USER_ACTIVATION_LOG
(
msg
.
.
.
)
\
MOZ_LOG
(
gUserInteractionPRLog
LogLevel
:
:
Debug
(
msg
#
#
__VA_ARGS__
)
)
CanonicalBrowsingContext
:
:
CanonicalBrowsingContext
(
BrowsingContext
*
aParent
BrowsingContext
*
aOpener
const
nsAString
&
aName
uint64_t
aBrowsingContextId
uint64_t
aProcessId
BrowsingContext
:
:
Type
aType
)
:
BrowsingContext
(
aParent
aOpener
aName
aBrowsingContextId
aType
)
mProcessId
(
aProcessId
)
{
MOZ_RELEASE_ASSERT
(
XRE_IsParentProcess
(
)
)
;
}
already_AddRefed
<
CanonicalBrowsingContext
>
CanonicalBrowsingContext
:
:
Get
(
uint64_t
aId
)
{
MOZ_RELEASE_ASSERT
(
XRE_IsParentProcess
(
)
)
;
return
BrowsingContext
:
:
Get
(
aId
)
.
downcast
<
CanonicalBrowsingContext
>
(
)
;
}
CanonicalBrowsingContext
*
CanonicalBrowsingContext
:
:
Cast
(
BrowsingContext
*
aContext
)
{
MOZ_RELEASE_ASSERT
(
XRE_IsParentProcess
(
)
)
;
return
static_cast
<
CanonicalBrowsingContext
*
>
(
aContext
)
;
}
const
CanonicalBrowsingContext
*
CanonicalBrowsingContext
:
:
Cast
(
const
BrowsingContext
*
aContext
)
{
MOZ_RELEASE_ASSERT
(
XRE_IsParentProcess
(
)
)
;
return
static_cast
<
const
CanonicalBrowsingContext
*
>
(
aContext
)
;
}
ContentParent
*
CanonicalBrowsingContext
:
:
GetContentParent
(
)
const
{
if
(
mProcessId
=
=
0
)
{
return
nullptr
;
}
ContentProcessManager
*
cpm
=
ContentProcessManager
:
:
GetSingleton
(
)
;
return
cpm
-
>
GetContentProcessById
(
ContentParentId
(
mProcessId
)
)
;
}
void
CanonicalBrowsingContext
:
:
GetWindowGlobals
(
nsTArray
<
RefPtr
<
WindowGlobalParent
>
>
&
aWindows
)
{
aWindows
.
SetCapacity
(
mWindowGlobals
.
Count
(
)
)
;
for
(
auto
iter
=
mWindowGlobals
.
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
aWindows
.
AppendElement
(
iter
.
Get
(
)
-
>
GetKey
(
)
)
;
}
}
void
CanonicalBrowsingContext
:
:
RegisterWindowGlobal
(
WindowGlobalParent
*
aGlobal
)
{
MOZ_ASSERT
(
!
mWindowGlobals
.
Contains
(
aGlobal
)
"
Global
already
registered
!
"
)
;
mWindowGlobals
.
PutEntry
(
aGlobal
)
;
}
void
CanonicalBrowsingContext
:
:
UnregisterWindowGlobal
(
WindowGlobalParent
*
aGlobal
)
{
MOZ_ASSERT
(
mWindowGlobals
.
Contains
(
aGlobal
)
"
Global
not
registered
!
"
)
;
mWindowGlobals
.
RemoveEntry
(
aGlobal
)
;
if
(
aGlobal
=
=
mCurrentWindowGlobal
)
{
mCurrentWindowGlobal
=
nullptr
;
}
}
void
CanonicalBrowsingContext
:
:
SetCurrentWindowGlobal
(
WindowGlobalParent
*
aGlobal
)
{
MOZ_ASSERT
(
mWindowGlobals
.
Contains
(
aGlobal
)
"
Global
not
registered
!
"
)
;
mCurrentWindowGlobal
=
aGlobal
;
}
bool
CanonicalBrowsingContext
:
:
ValidateTransaction
(
const
Transaction
&
aTransaction
ContentParent
*
aProcess
)
{
if
(
NS_WARN_IF
(
aProcess
&
&
mProcessId
!
=
aProcess
-
>
ChildID
(
)
)
)
{
return
false
;
}
return
true
;
}
JSObject
*
CanonicalBrowsingContext
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
CanonicalBrowsingContext_Binding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
void
CanonicalBrowsingContext
:
:
Traverse
(
nsCycleCollectionTraversalCallback
&
cb
)
{
CanonicalBrowsingContext
*
tmp
=
this
;
NS_IMPL_CYCLE_COLLECTION_TRAVERSE
(
mWindowGlobals
)
;
}
void
CanonicalBrowsingContext
:
:
Unlink
(
)
{
CanonicalBrowsingContext
*
tmp
=
this
;
NS_IMPL_CYCLE_COLLECTION_UNLINK
(
mWindowGlobals
)
;
}
}
}
