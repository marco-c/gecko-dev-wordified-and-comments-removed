#
ifndef
mozilla_dom_CanonicalBrowsingContext_h
#
define
mozilla_dom_CanonicalBrowsingContext_h
#
include
"
mozilla
/
dom
/
BrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
MediaControlKeySource
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContextWebProgress
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsISecureBrowserUI
.
h
"
class
nsISHistory
;
class
nsSHistory
;
class
nsBrowserStatusFilter
;
class
nsSecureBrowserUI
;
namespace
mozilla
{
namespace
net
{
class
DocumentLoadListener
;
}
namespace
dom
{
class
BrowserParent
;
struct
LoadURIOptions
;
class
MediaController
;
struct
LoadingSessionHistoryInfo
;
class
SessionHistoryEntry
;
class
WindowGlobalParent
;
class
CanonicalBrowsingContext
final
:
public
BrowsingContext
{
public
:
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED
(
CanonicalBrowsingContext
BrowsingContext
)
static
already_AddRefed
<
CanonicalBrowsingContext
>
Get
(
uint64_t
aId
)
;
static
CanonicalBrowsingContext
*
Cast
(
BrowsingContext
*
aContext
)
;
static
const
CanonicalBrowsingContext
*
Cast
(
const
BrowsingContext
*
aContext
)
;
static
already_AddRefed
<
CanonicalBrowsingContext
>
Cast
(
already_AddRefed
<
BrowsingContext
>
&
&
aContext
)
;
bool
IsOwnedByProcess
(
uint64_t
aProcessId
)
const
{
return
mProcessId
=
=
aProcessId
;
}
bool
IsEmbeddedInProcess
(
uint64_t
aProcessId
)
const
{
return
mEmbedderProcessId
=
=
aProcessId
;
}
uint64_t
OwnerProcessId
(
)
const
{
return
mProcessId
;
}
uint64_t
EmbedderProcessId
(
)
const
{
return
mEmbedderProcessId
;
}
ContentParent
*
GetContentParent
(
)
const
;
void
GetCurrentRemoteType
(
nsACString
&
aRemoteType
ErrorResult
&
aRv
)
const
;
void
SetOwnerProcessId
(
uint64_t
aProcessId
)
;
void
SetInFlightProcessId
(
uint64_t
aProcessId
)
;
void
ClearInFlightProcessId
(
uint64_t
aProcessId
)
;
uint64_t
GetInFlightProcessId
(
)
const
{
return
mInFlightProcessId
;
}
void
GetWindowGlobals
(
nsTArray
<
RefPtr
<
WindowGlobalParent
>
>
&
aWindows
)
;
WindowGlobalParent
*
GetCurrentWindowGlobal
(
)
const
;
CanonicalBrowsingContext
*
GetParent
(
)
{
return
Cast
(
BrowsingContext
:
:
GetParent
(
)
)
;
}
CanonicalBrowsingContext
*
Top
(
)
{
return
Cast
(
BrowsingContext
:
:
Top
(
)
)
;
}
WindowGlobalParent
*
GetParentWindowContext
(
)
;
WindowGlobalParent
*
GetTopWindowContext
(
)
;
already_AddRefed
<
nsIWidget
>
GetParentProcessWidgetContaining
(
)
;
already_AddRefed
<
WindowGlobalParent
>
GetEmbedderWindowGlobal
(
)
const
;
already_AddRefed
<
CanonicalBrowsingContext
>
GetParentCrossChromeBoundary
(
)
;
Nullable
<
WindowProxyHolder
>
GetTopChromeWindow
(
)
;
nsISHistory
*
GetSessionHistory
(
)
;
SessionHistoryEntry
*
GetActiveSessionHistoryEntry
(
)
;
UniquePtr
<
LoadingSessionHistoryInfo
>
CreateLoadingSessionHistoryEntryForLoad
(
nsDocShellLoadState
*
aLoadState
nsIChannel
*
aChannel
)
;
void
SessionHistoryCommit
(
uint64_t
aLoadId
const
nsID
&
aChangeID
)
;
void
NotifyOnHistoryReload
(
bool
&
aCanReload
Maybe
<
RefPtr
<
nsDocShellLoadState
>
>
&
aLoadState
Maybe
<
bool
>
&
aReloadActiveEntry
)
;
void
SetActiveSessionHistoryEntryForTop
(
const
Maybe
<
nsPoint
>
&
aPreviousScrollPos
SessionHistoryInfo
*
aInfo
uint32_t
aLoadType
const
nsID
&
aChangeID
)
;
void
SetActiveSessionHistoryEntryForFrame
(
const
Maybe
<
nsPoint
>
&
aPreviousScrollPos
SessionHistoryInfo
*
aInfo
int32_t
aChildOffset
const
nsID
&
aChangeID
)
;
void
ReplaceActiveSessionHistoryEntry
(
SessionHistoryInfo
*
aInfo
)
;
void
RemoveDynEntriesFromActiveSessionHistoryEntry
(
)
;
void
RemoveFromSessionHistory
(
)
;
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
void
DispatchWheelZoomChange
(
bool
aIncrease
)
;
void
NotifyStartDelayedAutoplayMedia
(
)
;
void
NotifyMediaMutedChanged
(
bool
aMuted
ErrorResult
&
aRv
)
;
static
uint32_t
CountSiteOrigins
(
GlobalObject
&
aGlobal
const
Sequence
<
mozilla
:
:
OwningNonNull
<
BrowsingContext
>
>
&
aRoots
)
;
void
UpdateMediaControlAction
(
const
MediaControlAction
&
aAction
)
;
using
BrowsingContext
:
:
LoadURI
;
void
LoadURI
(
const
nsAString
&
aURI
const
LoadURIOptions
&
aOptions
ErrorResult
&
aError
)
;
void
GoBack
(
const
Optional
<
int32_t
>
&
aCancelContentJSEpoch
bool
aRequireUserInteraction
)
;
void
GoForward
(
const
Optional
<
int32_t
>
&
aCancelContentJSEpoch
bool
aRequireUserInteraction
)
;
void
GoToIndex
(
int32_t
aIndex
const
Optional
<
int32_t
>
&
aCancelContentJSEpoch
)
;
void
Reload
(
uint32_t
aReloadFlags
)
;
void
Stop
(
uint32_t
aStopFlags
)
;
using
RemotenessPromise
=
MozPromise
<
RefPtr
<
BrowserParent
>
nsresult
false
>
;
RefPtr
<
RemotenessPromise
>
ChangeRemoteness
(
const
nsACString
&
aRemoteType
uint64_t
aPendingSwitchId
bool
aReplaceBrowsingContext
uint64_t
aSpecificGroupId
)
;
MediaController
*
GetMediaController
(
)
;
bool
LoadInParent
(
nsDocShellLoadState
*
aLoadState
bool
aSetNavigating
)
;
bool
AttemptSpeculativeLoadInParent
(
nsDocShellLoadState
*
aLoadState
)
;
nsISecureBrowserUI
*
GetSecureBrowserUI
(
)
;
BrowsingContextWebProgress
*
GetWebProgress
(
)
{
return
mWebProgress
;
}
void
UpdateSecurityStateForLocationOrMixedContentChange
(
)
;
void
MaybeAddAsProgressListener
(
nsIWebProgress
*
aWebProgress
)
;
void
ReplacedBy
(
CanonicalBrowsingContext
*
aNewContext
)
;
bool
HasHistoryEntry
(
nsISHEntry
*
aEntry
)
;
void
SwapHistoryEntries
(
nsISHEntry
*
aOldEntry
nsISHEntry
*
aNewEntry
)
;
protected
:
void
CanonicalDiscard
(
)
;
using
Type
=
BrowsingContext
:
:
Type
;
CanonicalBrowsingContext
(
WindowContext
*
aParentWindow
BrowsingContextGroup
*
aGroup
uint64_t
aBrowsingContextId
uint64_t
aOwnerProcessId
uint64_t
aEmbedderProcessId
Type
aType
FieldValues
&
&
aInit
)
;
private
:
friend
class
BrowsingContext
;
~
CanonicalBrowsingContext
(
)
=
default
;
class
PendingRemotenessChange
{
public
:
NS_INLINE_DECL_REFCOUNTING
(
PendingRemotenessChange
)
PendingRemotenessChange
(
CanonicalBrowsingContext
*
aTarget
RemotenessPromise
:
:
Private
*
aPromise
uint64_t
aPendingSwitchId
bool
aReplaceBrowsingContext
)
;
void
Cancel
(
nsresult
aRv
)
;
private
:
friend
class
CanonicalBrowsingContext
;
~
PendingRemotenessChange
(
)
;
void
ProcessReady
(
)
;
void
Finish
(
)
;
void
Clear
(
)
;
RefPtr
<
CanonicalBrowsingContext
>
mTarget
;
RefPtr
<
RemotenessPromise
:
:
Private
>
mPromise
;
RefPtr
<
GenericPromise
>
mPrepareToChangePromise
;
RefPtr
<
ContentParent
>
mContentParent
;
RefPtr
<
BrowsingContextGroup
>
mSpecificGroup
;
uint64_t
mPendingSwitchId
;
bool
mReplaceBrowsingContext
;
}
;
friend
class
net
:
:
DocumentLoadListener
;
bool
StartDocumentLoad
(
net
:
:
DocumentLoadListener
*
aLoad
)
;
void
EndDocumentLoad
(
bool
aForProcessSwitch
)
;
bool
SupportsLoadingInParent
(
nsDocShellLoadState
*
aLoadState
uint64_t
*
aOuterWindowId
)
;
uint64_t
mProcessId
;
uint64_t
mEmbedderProcessId
;
uint64_t
mInFlightProcessId
=
0
;
RefPtr
<
PendingRemotenessChange
>
mPendingRemotenessChange
;
RefPtr
<
nsSHistory
>
mSessionHistory
;
RefPtr
<
MediaController
>
mTabMediaController
;
RefPtr
<
net
:
:
DocumentLoadListener
>
mCurrentLoad
;
struct
LoadingSessionHistoryEntry
{
uint64_t
mLoadId
=
0
;
RefPtr
<
SessionHistoryEntry
>
mEntry
;
}
;
nsTArray
<
LoadingSessionHistoryEntry
>
mLoadingEntries
;
RefPtr
<
SessionHistoryEntry
>
mActiveEntry
;
RefPtr
<
nsSecureBrowserUI
>
mSecureBrowserUI
;
RefPtr
<
BrowsingContextWebProgress
>
mWebProgress
;
RefPtr
<
nsBrowserStatusFilter
>
mStatusFilter
;
}
;
}
}
#
endif
