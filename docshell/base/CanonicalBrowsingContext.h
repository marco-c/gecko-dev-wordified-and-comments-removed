#
ifndef
mozilla_dom_CanonicalBrowsingContext_h
#
define
mozilla_dom_CanonicalBrowsingContext_h
#
include
"
mozilla
/
dom
/
BrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
MediaControlKeysEvent
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsISHistory
.
h
"
namespace
mozilla
{
namespace
dom
{
class
BrowserParent
;
class
MediaController
;
class
WindowGlobalParent
;
class
CanonicalBrowsingContext
final
:
public
BrowsingContext
{
public
:
static
already_AddRefed
<
CanonicalBrowsingContext
>
Get
(
uint64_t
aId
)
;
static
CanonicalBrowsingContext
*
Cast
(
BrowsingContext
*
aContext
)
;
static
const
CanonicalBrowsingContext
*
Cast
(
const
BrowsingContext
*
aContext
)
;
bool
IsOwnedByProcess
(
uint64_t
aProcessId
)
const
{
return
mProcessId
=
=
aProcessId
;
}
uint64_t
OwnerProcessId
(
)
const
{
return
mProcessId
;
}
ContentParent
*
GetContentParent
(
)
const
;
void
GetCurrentRemoteType
(
nsAString
&
aRemoteType
ErrorResult
&
aRv
)
const
;
void
SetOwnerProcessId
(
uint64_t
aProcessId
)
;
void
SetInFlightProcessId
(
uint64_t
aProcessId
)
;
uint64_t
GetInFlightProcessId
(
)
const
{
return
mInFlightProcessId
;
}
void
GetWindowGlobals
(
nsTArray
<
RefPtr
<
WindowGlobalParent
>
>
&
aWindows
)
;
void
RegisterWindowGlobal
(
WindowGlobalParent
*
aGlobal
)
;
void
UnregisterWindowGlobal
(
WindowGlobalParent
*
aGlobal
)
;
WindowGlobalParent
*
GetCurrentWindowGlobal
(
)
const
{
return
mCurrentWindowGlobal
;
}
void
SetCurrentWindowGlobal
(
WindowGlobalParent
*
aGlobal
)
;
already_AddRefed
<
WindowGlobalParent
>
GetEmbedderWindowGlobal
(
)
const
;
nsISHistory
*
GetSessionHistory
(
)
;
void
SetSessionHistory
(
nsISHistory
*
aSHistory
)
{
mSessionHistory
=
aSHistory
;
}
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
void
NotifyStartDelayedAutoplayMedia
(
)
;
void
NotifyMediaMutedChanged
(
bool
aMuted
)
;
static
uint32_t
CountSiteOrigins
(
GlobalObject
&
aGlobal
const
Sequence
<
mozilla
:
:
OwningNonNull
<
BrowsingContext
>
>
&
aRoots
)
;
void
UpdateMediaControlKeysEvent
(
MediaControlKeysEvent
aEvent
)
;
using
BrowsingContext
:
:
LoadURI
;
void
LoadURI
(
const
nsAString
&
aURI
const
LoadURIOptions
&
aOptions
ErrorResult
&
aError
)
;
using
RemotenessPromise
=
MozPromise
<
RefPtr
<
BrowserParent
>
nsresult
false
>
;
RefPtr
<
RemotenessPromise
>
ChangeFrameRemoteness
(
const
nsAString
&
aRemoteType
uint64_t
aPendingSwitchId
)
;
already_AddRefed
<
Promise
>
ChangeFrameRemoteness
(
const
nsAString
&
aRemoteType
uint64_t
aPendingSwitchId
ErrorResult
&
aRv
)
;
MediaController
*
GetMediaController
(
)
;
protected
:
void
Traverse
(
nsCycleCollectionTraversalCallback
&
cb
)
;
void
Unlink
(
)
;
void
CanonicalDiscard
(
)
;
using
Type
=
BrowsingContext
:
:
Type
;
CanonicalBrowsingContext
(
BrowsingContext
*
aParent
BrowsingContextGroup
*
aGroup
uint64_t
aBrowsingContextId
uint64_t
aProcessId
Type
aType
FieldTuple
&
&
aFields
)
;
private
:
friend
class
BrowsingContext
;
class
PendingRemotenessChange
{
public
:
NS_INLINE_DECL_REFCOUNTING
(
PendingRemotenessChange
)
PendingRemotenessChange
(
CanonicalBrowsingContext
*
aTarget
RemotenessPromise
:
:
Private
*
aPromise
uint64_t
aPendingSwitchId
)
:
mTarget
(
aTarget
)
mPromise
(
aPromise
)
mPendingSwitchId
(
aPendingSwitchId
)
{
}
void
Cancel
(
nsresult
aRv
)
;
void
Complete
(
ContentParent
*
aContentParent
)
;
private
:
~
PendingRemotenessChange
(
)
;
void
Clear
(
)
;
RefPtr
<
CanonicalBrowsingContext
>
mTarget
;
RefPtr
<
RemotenessPromise
:
:
Private
>
mPromise
;
uint64_t
mPendingSwitchId
;
}
;
uint64_t
mProcessId
;
uint64_t
mInFlightProcessId
=
0
;
nsTHashtable
<
nsRefPtrHashKey
<
WindowGlobalParent
>
>
mWindowGlobals
;
RefPtr
<
WindowGlobalParent
>
mCurrentWindowGlobal
;
RefPtr
<
PendingRemotenessChange
>
mPendingRemotenessChange
;
nsCOMPtr
<
nsISHistory
>
mSessionHistory
;
RefPtr
<
MediaController
>
mTabMediaController
;
}
;
}
}
#
endif
