#
include
"
ScrollAnimationMSDPhysics
.
h
"
#
include
"
gfxPrefs
.
h
"
using
namespace
mozilla
;
ScrollAnimationMSDPhysics
:
:
ScrollAnimationMSDPhysics
(
const
nsPoint
&
aStartPos
)
:
mStartPos
(
aStartPos
)
mModelX
(
0
0
0
gfxPrefs
:
:
SmoothScrollMSDPhysicsRegularSpringConstant
(
)
1
)
mModelY
(
0
0
0
gfxPrefs
:
:
SmoothScrollMSDPhysicsRegularSpringConstant
(
)
1
)
mIsFirstIteration
(
true
)
{
}
void
ScrollAnimationMSDPhysics
:
:
Update
(
const
TimeStamp
&
aTime
const
nsPoint
&
aDestination
const
nsSize
&
aCurrentVelocity
)
{
double
springConstant
=
ComputeSpringConstant
(
aTime
)
;
if
(
mLastSimulatedTime
&
&
aTime
<
mLastSimulatedTime
)
{
mStartTime
=
mLastSimulatedTime
;
}
else
{
mStartTime
=
aTime
;
}
if
(
!
mIsFirstIteration
)
{
mStartPos
=
PositionAt
(
mStartTime
)
;
}
mLastSimulatedTime
=
mStartTime
;
mDestination
=
aDestination
;
mModelX
=
AxisPhysicsMSDModel
(
mStartPos
.
x
aDestination
.
x
aCurrentVelocity
.
width
springConstant
1
)
;
mModelY
=
AxisPhysicsMSDModel
(
mStartPos
.
y
aDestination
.
y
aCurrentVelocity
.
height
springConstant
1
)
;
mIsFirstIteration
=
false
;
}
double
ScrollAnimationMSDPhysics
:
:
ComputeSpringConstant
(
const
TimeStamp
&
aTime
)
{
if
(
!
mPreviousEventTime
)
{
mPreviousEventTime
=
aTime
;
mPreviousDelta
=
TimeDuration
(
)
;
return
gfxPrefs
:
:
SmoothScrollMSDPhysicsMotionBeginSpringConstant
(
)
;
}
TimeDuration
delta
=
aTime
-
mPreviousEventTime
;
TimeDuration
previousDelta
=
mPreviousDelta
;
mPreviousEventTime
=
aTime
;
mPreviousDelta
=
delta
;
double
deltaMS
=
delta
.
ToMilliseconds
(
)
;
if
(
deltaMS
>
=
gfxPrefs
:
:
SmoothScrollMSDPhysicsContinuousMotionMaxDeltaMS
(
)
)
{
return
gfxPrefs
:
:
SmoothScrollMSDPhysicsMotionBeginSpringConstant
(
)
;
}
if
(
previousDelta
&
&
deltaMS
>
=
gfxPrefs
:
:
SmoothScrollMSDPhysicsSlowdownMinDeltaMS
(
)
&
&
deltaMS
>
=
previousDelta
.
ToMilliseconds
(
)
*
gfxPrefs
:
:
SmoothScrollMSDPhysicsSlowdownMinDeltaRatio
(
)
)
{
return
gfxPrefs
:
:
SmoothScrollMSDPhysicsSlowdownSpringConstant
(
)
;
}
return
gfxPrefs
:
:
SmoothScrollMSDPhysicsRegularSpringConstant
(
)
;
}
void
ScrollAnimationMSDPhysics
:
:
SimulateUntil
(
const
TimeStamp
&
aTime
)
{
if
(
!
mLastSimulatedTime
|
|
aTime
<
mLastSimulatedTime
)
{
return
;
}
TimeDuration
delta
=
aTime
-
mLastSimulatedTime
;
mModelX
.
Simulate
(
delta
)
;
mModelY
.
Simulate
(
delta
)
;
mLastSimulatedTime
=
aTime
;
}
nsPoint
ScrollAnimationMSDPhysics
:
:
PositionAt
(
const
TimeStamp
&
aTime
)
{
SimulateUntil
(
aTime
)
;
return
nsPoint
(
NSToCoordRound
(
mModelX
.
GetPosition
(
)
)
NSToCoordRound
(
mModelY
.
GetPosition
(
)
)
)
;
}
nsSize
ScrollAnimationMSDPhysics
:
:
VelocityAt
(
const
TimeStamp
&
aTime
)
{
SimulateUntil
(
aTime
)
;
return
nsSize
(
NSToCoordRound
(
mModelX
.
GetVelocity
(
)
)
NSToCoordRound
(
mModelY
.
GetVelocity
(
)
)
)
;
}
