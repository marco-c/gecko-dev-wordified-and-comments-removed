#
ifndef
nsVideoFrame_h___
#
define
nsVideoFrame_h___
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsContainerFrame
.
h
"
#
include
"
nsIAnonymousContentCreator
.
h
"
#
include
"
nsIReflowCallback
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsTArrayForwardDeclare
.
h
"
class
nsPresContext
;
class
nsDisplayItem
;
class
nsVideoFrame
final
:
public
nsContainerFrame
public
nsIReflowCallback
public
nsIAnonymousContentCreator
{
public
:
template
<
typename
T
>
using
Maybe
=
mozilla
:
:
Maybe
<
T
>
;
using
Nothing
=
mozilla
:
:
Nothing
;
using
Visibility
=
mozilla
:
:
Visibility
;
explicit
nsVideoFrame
(
ComputedStyle
*
nsPresContext
*
)
;
NS_DECL_QUERYFRAME
NS_DECL_FRAMEARENA_HELPERS
(
nsVideoFrame
)
void
ReflowCallbackCanceled
(
)
final
{
mReflowCallbackPosted
=
false
;
}
bool
ReflowFinished
(
)
final
;
void
BuildDisplayList
(
nsDisplayListBuilder
*
aBuilder
const
nsDisplayListSet
&
aLists
)
override
;
nsresult
AttributeChanged
(
int32_t
aNameSpaceID
nsAtom
*
aAttribute
int32_t
aModType
)
override
;
void
OnVisibilityChange
(
Visibility
aNewVisibility
const
Maybe
<
OnNonvisible
>
&
aNonvisibleAction
=
Nothing
(
)
)
override
;
mozilla
:
:
IntrinsicSize
GetIntrinsicSize
(
)
override
;
mozilla
:
:
AspectRatio
GetIntrinsicRatio
(
)
const
override
;
SizeComputationResult
ComputeSize
(
gfxContext
*
aRenderingContext
mozilla
:
:
WritingMode
aWM
const
mozilla
:
:
LogicalSize
&
aCBSize
nscoord
aAvailableISize
const
mozilla
:
:
LogicalSize
&
aMargin
const
mozilla
:
:
LogicalSize
&
aBorderPadding
const
mozilla
:
:
StyleSizeOverrides
&
aSizeOverrides
mozilla
:
:
ComputeSizeFlags
aFlags
)
override
;
nscoord
GetMinISize
(
gfxContext
*
aRenderingContext
)
override
;
nscoord
GetPrefISize
(
gfxContext
*
aRenderingContext
)
override
;
void
DestroyFrom
(
nsIFrame
*
aDestructRoot
PostDestroyData
&
aPostDestroyData
)
override
;
void
Reflow
(
nsPresContext
*
aPresContext
ReflowOutput
&
aDesiredSize
const
ReflowInput
&
aReflowInput
nsReflowStatus
&
aStatus
)
override
;
#
ifdef
ACCESSIBILITY
mozilla
:
:
a11y
:
:
AccType
AccessibleType
(
)
override
;
#
endif
bool
IsFrameOfType
(
uint32_t
aFlags
)
const
override
{
if
(
(
aFlags
&
nsIFrame
:
:
eSupportsAspectRatio
)
&
&
!
HasVideoElement
(
)
)
{
return
false
;
}
return
nsSplittableFrame
:
:
IsFrameOfType
(
aFlags
&
~
(
nsIFrame
:
:
eReplaced
|
nsIFrame
:
:
eReplacedSizing
)
)
;
}
nsresult
CreateAnonymousContent
(
nsTArray
<
ContentInfo
>
&
aElements
)
override
;
void
AppendAnonymousContentTo
(
nsTArray
<
nsIContent
*
>
&
aElements
uint32_t
aFilters
)
override
;
mozilla
:
:
dom
:
:
Element
*
GetPosterImage
(
)
const
{
return
mPosterImage
;
}
bool
ShouldDisplayPoster
(
)
const
;
nsIContent
*
GetCaptionOverlay
(
)
const
{
return
mCaptionDiv
;
}
nsIContent
*
GetVideoControls
(
)
const
;
#
ifdef
DEBUG_FRAME_DUMP
nsresult
GetFrameName
(
nsAString
&
aResult
)
const
override
;
#
endif
protected
:
bool
HasVideoElement
(
)
const
;
bool
HasVideoData
(
)
const
;
mozilla
:
:
Maybe
<
nsSize
>
PosterImageSize
(
)
const
;
void
UpdatePosterSource
(
bool
aNotify
)
;
void
UpdateTextTrack
(
)
;
virtual
~
nsVideoFrame
(
)
;
RefPtr
<
mozilla
:
:
dom
:
:
Element
>
mPosterImage
;
nsCOMPtr
<
nsIContent
>
mCaptionDiv
;
nsSize
mControlsTrackedSize
{
-
1
-
1
}
;
nsSize
mCaptionTrackedSize
{
-
1
-
1
}
;
bool
mReflowCallbackPosted
=
false
;
}
;
#
endif
