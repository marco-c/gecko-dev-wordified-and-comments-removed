#
ifndef
nsCanvasFrame_h___
#
define
nsCanvasFrame_h___
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
nsContainerFrame
.
h
"
#
include
"
nsIScrollPositionListener
.
h
"
#
include
"
nsIRootBox
.
h
"
#
include
"
nsDisplayList
.
h
"
#
include
"
nsIAnonymousContentCreator
.
h
"
#
include
"
gfxPrefs
.
h
"
class
nsPresContext
;
class
gfxContext
;
class
nsPopupSetFrame
;
class
nsCanvasFrame
final
:
public
nsContainerFrame
public
nsIScrollPositionListener
public
nsIAnonymousContentCreator
public
nsIRootBox
{
public
:
explicit
nsCanvasFrame
(
ComputedStyle
*
aStyle
)
:
nsContainerFrame
(
aStyle
kClassID
)
mDoPaintFocus
(
false
)
mAddedScrollPositionListener
(
false
)
mPopupSetFrame
(
nullptr
)
{
}
NS_DECL_QUERYFRAME
NS_DECL_FRAMEARENA_HELPERS
(
nsCanvasFrame
)
nsPopupSetFrame
*
GetPopupSetFrame
(
)
override
;
void
SetPopupSetFrame
(
nsPopupSetFrame
*
aPopupSet
)
override
;
Element
*
GetDefaultTooltip
(
)
override
;
void
SetDefaultTooltip
(
Element
*
aTooltip
)
override
;
virtual
void
DestroyFrom
(
nsIFrame
*
aDestructRoot
PostDestroyData
&
aPostDestroyData
)
override
;
virtual
void
SetInitialChildList
(
ChildListID
aListID
nsFrameList
&
aChildList
)
override
;
virtual
void
AppendFrames
(
ChildListID
aListID
nsFrameList
&
aFrameList
)
override
;
virtual
void
InsertFrames
(
ChildListID
aListID
nsIFrame
*
aPrevFrame
nsFrameList
&
aFrameList
)
override
;
#
ifdef
DEBUG
virtual
void
RemoveFrame
(
ChildListID
aListID
nsIFrame
*
aOldFrame
)
override
;
#
endif
virtual
nscoord
GetMinISize
(
gfxContext
*
aRenderingContext
)
override
;
virtual
nscoord
GetPrefISize
(
gfxContext
*
aRenderingContext
)
override
;
virtual
void
Reflow
(
nsPresContext
*
aPresContext
ReflowOutput
&
aDesiredSize
const
ReflowInput
&
aReflowInput
nsReflowStatus
&
aStatus
)
override
;
virtual
bool
IsFrameOfType
(
uint32_t
aFlags
)
const
override
{
return
nsContainerFrame
:
:
IsFrameOfType
(
aFlags
&
~
(
nsIFrame
:
:
eCanContainOverflowContainers
)
)
;
}
virtual
nsresult
CreateAnonymousContent
(
nsTArray
<
ContentInfo
>
&
aElements
)
override
;
virtual
void
AppendAnonymousContentTo
(
nsTArray
<
nsIContent
*
>
&
aElements
uint32_t
aFilter
)
override
;
mozilla
:
:
dom
:
:
Element
*
GetCustomContentContainer
(
)
const
{
return
mCustomContentContainer
;
}
void
ShowCustomContentContainer
(
)
;
void
HideCustomContentContainer
(
)
;
NS_IMETHOD
SetHasFocus
(
bool
aHasFocus
)
;
virtual
void
BuildDisplayList
(
nsDisplayListBuilder
*
aBuilder
const
nsDisplayListSet
&
aLists
)
override
;
void
PaintFocus
(
mozilla
:
:
gfx
:
:
DrawTarget
*
aRenderingContext
nsPoint
aPt
)
;
virtual
void
ScrollPositionWillChange
(
nscoord
aX
nscoord
aY
)
override
;
virtual
void
ScrollPositionDidChange
(
nscoord
aX
nscoord
aY
)
override
{
}
#
ifdef
DEBUG_FRAME_DUMP
virtual
nsresult
GetFrameName
(
nsAString
&
aResult
)
const
override
;
#
endif
virtual
nsresult
GetContentForEvent
(
mozilla
:
:
WidgetEvent
*
aEvent
nsIContent
*
*
aContent
)
override
;
nsRect
CanvasArea
(
)
const
;
protected
:
void
MaybePropagateRootElementWritingMode
(
)
;
bool
mDoPaintFocus
;
bool
mAddedScrollPositionListener
;
nsCOMPtr
<
mozilla
:
:
dom
:
:
Element
>
mCustomContentContainer
;
private
:
nsPopupSetFrame
*
mPopupSetFrame
;
nsCOMPtr
<
mozilla
:
:
dom
:
:
Element
>
mPopupgroupContent
;
}
;
class
nsDisplayCanvasBackgroundColor
:
public
nsDisplaySolidColorBase
{
public
:
nsDisplayCanvasBackgroundColor
(
nsDisplayListBuilder
*
aBuilder
nsIFrame
*
aFrame
)
:
nsDisplaySolidColorBase
(
aBuilder
aFrame
NS_RGBA
(
0
0
0
0
)
)
{
}
virtual
bool
ComputeVisibility
(
nsDisplayListBuilder
*
aBuilder
nsRegion
*
aVisibleRegion
)
override
{
return
NS_GET_A
(
mColor
)
>
0
;
}
virtual
nsRect
GetBounds
(
nsDisplayListBuilder
*
aBuilder
bool
*
aSnap
)
const
override
{
nsCanvasFrame
*
frame
=
static_cast
<
nsCanvasFrame
*
>
(
mFrame
)
;
*
aSnap
=
true
;
return
frame
-
>
CanvasArea
(
)
+
ToReferenceFrame
(
)
;
}
virtual
void
HitTest
(
nsDisplayListBuilder
*
aBuilder
const
nsRect
&
aRect
HitTestState
*
aState
nsTArray
<
nsIFrame
*
>
*
aOutFrames
)
override
{
aOutFrames
-
>
AppendElement
(
mFrame
)
;
}
virtual
already_AddRefed
<
Layer
>
BuildLayer
(
nsDisplayListBuilder
*
aBuilder
LayerManager
*
aManager
const
ContainerLayerParameters
&
aContainerParameters
)
override
;
virtual
bool
CreateWebRenderCommands
(
mozilla
:
:
wr
:
:
DisplayListBuilder
&
aBuilder
mozilla
:
:
wr
:
:
IpcResourceUpdateQueue
&
aResources
const
StackingContextHelper
&
aSc
mozilla
:
:
layers
:
:
WebRenderLayerManager
*
aManager
nsDisplayListBuilder
*
aDisplayListBuilder
)
override
;
virtual
LayerState
GetLayerState
(
nsDisplayListBuilder
*
aBuilder
LayerManager
*
aManager
const
ContainerLayerParameters
&
aParameters
)
override
{
if
(
ForceActiveLayers
(
)
)
{
return
mozilla
:
:
LAYER_ACTIVE
;
}
return
mozilla
:
:
LAYER_NONE
;
}
virtual
void
Paint
(
nsDisplayListBuilder
*
aBuilder
gfxContext
*
aCtx
)
override
;
void
SetExtraBackgroundColor
(
nscolor
aColor
)
{
mColor
=
aColor
;
}
NS_DISPLAY_DECL_NAME
(
"
CanvasBackgroundColor
"
TYPE_CANVAS_BACKGROUND_COLOR
)
#
ifdef
MOZ_DUMP_PAINTING
virtual
void
WriteDebugInfo
(
std
:
:
stringstream
&
aStream
)
override
;
#
endif
}
;
class
nsDisplayCanvasBackgroundImage
:
public
nsDisplayBackgroundImage
{
public
:
explicit
nsDisplayCanvasBackgroundImage
(
nsDisplayListBuilder
*
aBuilder
const
InitData
&
aInitData
)
:
nsDisplayBackgroundImage
(
aBuilder
aInitData
)
{
}
virtual
void
Paint
(
nsDisplayListBuilder
*
aBuilder
gfxContext
*
aCtx
)
override
;
virtual
bool
SupportsOptimizingToImage
(
)
const
override
{
return
false
;
}
bool
IsSingleFixedPositionImage
(
nsDisplayListBuilder
*
aBuilder
const
nsRect
&
aClipRect
gfxRect
*
aDestRect
)
;
NS_DISPLAY_DECL_NAME
(
"
CanvasBackgroundImage
"
TYPE_CANVAS_BACKGROUND_IMAGE
)
}
;
class
nsDisplayCanvasThemedBackground
:
public
nsDisplayThemedBackground
{
public
:
nsDisplayCanvasThemedBackground
(
nsDisplayListBuilder
*
aBuilder
nsIFrame
*
aFrame
)
:
nsDisplayThemedBackground
(
aBuilder
aFrame
aFrame
-
>
GetRectRelativeToSelf
(
)
+
aBuilder
-
>
ToReferenceFrame
(
aFrame
)
)
{
}
virtual
void
Paint
(
nsDisplayListBuilder
*
aBuilder
gfxContext
*
aCtx
)
override
;
NS_DISPLAY_DECL_NAME
(
"
CanvasThemedBackground
"
TYPE_CANVAS_THEMED_BACKGROUND
)
}
;
#
endif
