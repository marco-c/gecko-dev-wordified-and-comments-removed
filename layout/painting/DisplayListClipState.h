#
ifndef
DISPLAYLISTCLIPSTATE_H_
#
define
DISPLAYLISTCLIPSTATE_H_
#
include
"
DisplayItemClip
.
h
"
#
include
"
DisplayItemClipChain
.
h
"
#
include
"
DisplayItemScrollClip
.
h
"
#
include
"
mozilla
/
DebugOnly
.
h
"
class
nsIFrame
;
class
nsIScrollableFrame
;
class
nsDisplayListBuilder
;
namespace
mozilla
{
class
DisplayListClipState
{
public
:
DisplayListClipState
(
)
:
mClipContentDescendants
(
nullptr
)
mClipContainingBlockDescendants
(
nullptr
)
mCurrentCombinedClip
(
nullptr
)
mScrollClipContentDescendants
(
nullptr
)
mScrollClipContainingBlockDescendants
(
nullptr
)
mClipContentDescendantsScrollClip
(
nullptr
)
mStackingContextAncestorSC
(
nullptr
)
{
}
const
DisplayItemClip
*
GetCurrentCombinedClip
(
nsDisplayListBuilder
*
aBuilder
)
;
const
DisplayItemClip
*
GetClipForContainingBlockDescendants
(
)
const
{
return
mClipContainingBlockDescendants
;
}
const
DisplayItemClip
*
GetClipForContentDescendants
(
)
const
{
return
mClipContentDescendants
;
}
const
DisplayItemScrollClip
*
GetCurrentInnermostScrollClip
(
)
;
const
DisplayItemScrollClip
*
CurrentAncestorScrollClipForStackingContextContents
(
)
{
return
mStackingContextAncestorSC
;
}
class
AutoSaveRestore
;
friend
class
AutoSaveRestore
;
class
AutoClipContainingBlockDescendantsToContentBox
;
friend
class
AutoClipContainingBlockDescendantsToContentBox
;
class
AutoClipMultiple
;
friend
class
AutoClipMultiple
;
enum
{
ASSUME_DRAWING_RESTRICTED_TO_CONTENT_RECT
=
0x01
}
;
private
:
void
SetClipForContainingBlockDescendants
(
const
DisplayItemClip
*
aClip
)
{
mClipContainingBlockDescendants
=
aClip
;
mCurrentCombinedClip
=
nullptr
;
}
void
SetScrollClipForContainingBlockDescendants
(
nsDisplayListBuilder
*
aBuilder
const
DisplayItemScrollClip
*
aScrollClip
)
;
void
Clear
(
)
{
mClipContentDescendants
=
nullptr
;
mClipContainingBlockDescendants
=
nullptr
;
mCurrentCombinedClip
=
nullptr
;
}
void
EnterStackingContextContents
(
bool
aClear
)
{
if
(
aClear
)
{
mClipContentDescendants
=
nullptr
;
mClipContainingBlockDescendants
=
nullptr
;
mCurrentCombinedClip
=
nullptr
;
mScrollClipContentDescendants
=
nullptr
;
mScrollClipContainingBlockDescendants
=
nullptr
;
mStackingContextAncestorSC
=
nullptr
;
}
else
{
mStackingContextAncestorSC
=
GetCurrentInnermostScrollClip
(
)
;
}
}
void
TurnClipIntoScrollClipForContentDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
;
void
TurnClipIntoScrollClipForContainingBlockDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
;
DisplayItemScrollClip
*
InsertInactiveScrollClipForContentDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
;
DisplayItemScrollClip
*
InsertInactiveScrollClipForContainingBlockDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
;
DisplayItemScrollClip
*
CreateInactiveScrollClip
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
;
void
ClipContainingBlockDescendants
(
const
nsRect
&
aRect
const
nscoord
*
aRadii
DisplayItemClip
&
aClipOnStack
)
;
void
ClipContentDescendants
(
const
nsRect
&
aRect
const
nscoord
*
aRadii
DisplayItemClip
&
aClipOnStack
)
;
void
ClipContentDescendants
(
const
nsRect
&
aRect
const
nsRect
&
aRoundedRect
const
nscoord
*
aRadii
DisplayItemClip
&
aClipOnStack
)
;
void
ClipContainingBlockDescendantsToContentBox
(
nsDisplayListBuilder
*
aBuilder
nsIFrame
*
aFrame
DisplayItemClip
&
aClipOnStack
uint32_t
aFlags
)
;
const
DisplayItemClip
*
mClipContentDescendants
;
const
DisplayItemClip
*
mClipContainingBlockDescendants
;
const
DisplayItemClip
*
mCurrentCombinedClip
;
const
DisplayItemScrollClip
*
mScrollClipContentDescendants
;
const
DisplayItemScrollClip
*
mScrollClipContainingBlockDescendants
;
const
DisplayItemScrollClip
*
mClipContentDescendantsScrollClip
;
const
DisplayItemScrollClip
*
mStackingContextAncestorSC
;
}
;
class
DisplayListClipState
:
:
AutoSaveRestore
{
public
:
explicit
AutoSaveRestore
(
nsDisplayListBuilder
*
aBuilder
)
;
void
Restore
(
)
{
if
(
!
mClearedForStackingContextContents
)
{
mSavedState
.
mStackingContextAncestorSC
=
DisplayItemScrollClip
:
:
PickAncestor
(
mSavedState
.
mStackingContextAncestorSC
mState
.
mStackingContextAncestorSC
)
;
}
mState
=
mSavedState
;
#
ifdef
DEBUG
mRestored
=
true
;
#
endif
}
~
AutoSaveRestore
(
)
{
Restore
(
)
;
}
void
Clear
(
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
mState
.
Clear
(
)
;
#
ifdef
DEBUG
mClipUsed
=
false
;
#
endif
}
void
EnterStackingContextContents
(
bool
aClear
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
mState
.
EnterStackingContextContents
(
aClear
)
;
mClearedForStackingContextContents
=
aClear
;
}
void
ExitStackingContextContents
(
const
DisplayItemScrollClip
*
*
aOutContainerSC
)
{
if
(
mClearedForStackingContextContents
)
{
*
aOutContainerSC
=
mSavedState
.
GetCurrentInnermostScrollClip
(
)
;
}
else
{
*
aOutContainerSC
=
mState
.
CurrentAncestorScrollClipForStackingContextContents
(
)
;
}
Restore
(
)
;
}
bool
SavedStateHasRoundedCorners
(
)
{
const
DisplayItemScrollClip
*
scrollClip
=
mSavedState
.
GetCurrentInnermostScrollClip
(
)
;
if
(
scrollClip
&
&
scrollClip
-
>
HasRoundedCorners
(
)
)
{
return
true
;
}
const
DisplayItemClip
*
clip
=
mSavedState
.
GetClipForContainingBlockDescendants
(
)
;
if
(
clip
&
&
clip
-
>
GetRoundedRectCount
(
)
>
0
)
{
return
true
;
}
clip
=
mSavedState
.
GetClipForContentDescendants
(
)
;
if
(
clip
&
&
clip
-
>
GetRoundedRectCount
(
)
>
0
)
{
return
true
;
}
return
false
;
}
void
TurnClipIntoScrollClipForContentDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
mState
.
TurnClipIntoScrollClipForContentDescendants
(
aBuilder
aScrollableFrame
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
}
void
TurnClipIntoScrollClipForContainingBlockDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
mState
.
TurnClipIntoScrollClipForContainingBlockDescendants
(
aBuilder
aScrollableFrame
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
}
DisplayItemScrollClip
*
InsertInactiveScrollClipForContentDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
DisplayItemScrollClip
*
scrollClip
=
mState
.
InsertInactiveScrollClipForContentDescendants
(
aBuilder
aScrollableFrame
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
return
scrollClip
;
}
DisplayItemScrollClip
*
InsertInactiveScrollClipForContainingBlockDescendants
(
nsDisplayListBuilder
*
aBuilder
nsIScrollableFrame
*
aScrollableFrame
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
DisplayItemScrollClip
*
scrollClip
=
mState
.
InsertInactiveScrollClipForContainingBlockDescendants
(
aBuilder
aScrollableFrame
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
return
scrollClip
;
}
void
ClipContainingBlockDescendants
(
const
nsRect
&
aRect
const
nscoord
*
aRadii
=
nullptr
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
NS_ASSERTION
(
!
mClipUsed
"
mClip
already
used
"
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
mState
.
ClipContainingBlockDescendants
(
aRect
aRadii
mClip
)
;
}
void
ClipContentDescendants
(
const
nsRect
&
aRect
const
nscoord
*
aRadii
=
nullptr
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
NS_ASSERTION
(
!
mClipUsed
"
mClip
already
used
"
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
mState
.
ClipContentDescendants
(
aRect
aRadii
mClip
)
;
}
void
ClipContentDescendants
(
const
nsRect
&
aRect
const
nsRect
&
aRoundedRect
const
nscoord
*
aRadii
=
nullptr
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
NS_ASSERTION
(
!
mClipUsed
"
mClip
already
used
"
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
mState
.
ClipContentDescendants
(
aRect
aRoundedRect
aRadii
mClip
)
;
}
void
ClipContainingBlockDescendantsToContentBox
(
nsDisplayListBuilder
*
aBuilder
nsIFrame
*
aFrame
uint32_t
aFlags
=
0
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
NS_ASSERTION
(
!
mClipUsed
"
mClip
already
used
"
)
;
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
mState
.
ClipContainingBlockDescendantsToContentBox
(
aBuilder
aFrame
mClip
aFlags
)
;
}
protected
:
DisplayListClipState
&
mState
;
DisplayListClipState
mSavedState
;
DisplayItemClip
mClip
;
#
ifdef
DEBUG
bool
mClipUsed
;
bool
mRestored
;
#
endif
bool
mClearedForStackingContextContents
;
}
;
class
DisplayListClipState
:
:
AutoClipContainingBlockDescendantsToContentBox
:
public
AutoSaveRestore
{
public
:
AutoClipContainingBlockDescendantsToContentBox
(
nsDisplayListBuilder
*
aBuilder
nsIFrame
*
aFrame
uint32_t
aFlags
=
0
)
:
AutoSaveRestore
(
aBuilder
)
{
#
ifdef
DEBUG
mClipUsed
=
true
;
#
endif
mState
.
ClipContainingBlockDescendantsToContentBox
(
aBuilder
aFrame
mClip
aFlags
)
;
}
}
;
class
DisplayListClipState
:
:
AutoClipMultiple
:
public
AutoSaveRestore
{
public
:
explicit
AutoClipMultiple
(
nsDisplayListBuilder
*
aBuilder
)
:
AutoSaveRestore
(
aBuilder
)
#
ifdef
DEBUG
mExtraClipUsed
(
false
)
#
endif
{
}
void
SetClipForContainingBlockDescendants
(
const
DisplayItemClip
*
aClip
)
{
mState
.
SetClipForContainingBlockDescendants
(
aClip
)
;
}
void
SetScrollClipForContainingBlockDescendants
(
nsDisplayListBuilder
*
aBuilder
const
DisplayItemScrollClip
*
aScrollClip
)
{
mState
.
SetScrollClipForContainingBlockDescendants
(
aBuilder
aScrollClip
)
;
}
void
ClipContainingBlockDescendantsExtra
(
const
nsRect
&
aRect
const
nscoord
*
aRadii
)
{
NS_ASSERTION
(
!
mRestored
"
Already
restored
!
"
)
;
NS_ASSERTION
(
!
mExtraClipUsed
"
mExtraClip
already
used
"
)
;
#
ifdef
DEBUG
mExtraClipUsed
=
true
;
#
endif
mState
.
ClipContainingBlockDescendants
(
aRect
aRadii
mExtraClip
)
;
}
protected
:
DisplayItemClip
mExtraClip
;
#
ifdef
DEBUG
bool
mExtraClipUsed
;
#
endif
}
;
}
#
endif
