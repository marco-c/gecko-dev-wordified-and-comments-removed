#
include
"
nsPagePrintTimer
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsPrintJob
.
h
"
#
include
"
nsPrintObject
.
h
"
using
namespace
mozilla
;
NS_IMPL_ISUPPORTS_INHERITED
(
nsPagePrintTimer
mozilla
:
:
Runnable
nsITimerCallback
)
nsPagePrintTimer
:
:
nsPagePrintTimer
(
nsPrintJob
*
aPrintJob
nsIDocumentViewerPrint
*
aDocViewerPrint
mozilla
:
:
dom
:
:
Document
*
aDocument
uint32_t
aDelay
)
:
Runnable
(
"
nsPagePrintTimer
"
)
mPrintJob
(
aPrintJob
)
mDocViewerPrint
(
aDocViewerPrint
)
mDocument
(
aDocument
)
mDelay
(
aDelay
)
mFiringCount
(
0
)
mPrintObj
(
nullptr
)
mWatchDogCount
(
0
)
mDone
(
false
)
{
MOZ_ASSERT
(
aDocViewerPrint
&
&
aDocument
)
;
mDocViewerPrint
-
>
IncrementDestroyBlockedCount
(
)
;
}
nsPagePrintTimer
:
:
~
nsPagePrintTimer
(
)
{
Disconnect
(
)
;
}
void
nsPagePrintTimer
:
:
Disconnect
(
)
{
mPrintJob
=
nullptr
;
mPrintObj
=
nullptr
;
if
(
mDocViewerPrint
)
{
mDocViewerPrint
-
>
DecrementDestroyBlockedCount
(
)
;
mDocViewerPrint
=
nullptr
;
}
}
nsresult
nsPagePrintTimer
:
:
StartTimer
(
bool
aUseDelay
)
{
uint32_t
delay
=
0
;
if
(
aUseDelay
)
{
if
(
mFiringCount
<
10
)
{
delay
=
mDelay
+
(
(
10
-
mFiringCount
)
*
100
)
;
}
else
{
delay
=
mDelay
;
}
}
return
NS_NewTimerWithCallback
(
getter_AddRefs
(
mTimer
)
this
delay
nsITimer
:
:
TYPE_ONE_SHOT
GetMainThreadSerialEventTarget
(
)
)
;
}
nsresult
nsPagePrintTimer
:
:
StartWatchDogTimer
(
)
{
if
(
mWatchDogTimer
)
{
mWatchDogTimer
-
>
Cancel
(
)
;
}
return
NS_NewTimerWithCallback
(
getter_AddRefs
(
mWatchDogTimer
)
this
WATCH_DOG_INTERVAL
nsITimer
:
:
TYPE_ONE_SHOT
GetMainThreadSerialEventTarget
(
)
)
;
}
void
nsPagePrintTimer
:
:
StopWatchDogTimer
(
)
{
if
(
mWatchDogTimer
)
{
mWatchDogTimer
-
>
Cancel
(
)
;
mWatchDogTimer
=
nullptr
;
}
}
NS_IMETHODIMP
nsPagePrintTimer
:
:
Run
(
)
{
bool
initNewTimer
=
true
;
bool
inRange
;
bool
donePrinting
;
donePrinting
=
!
mPrintJob
|
|
mPrintJob
-
>
PrintSheet
(
mPrintObj
inRange
)
;
if
(
donePrinting
)
{
if
(
mWaitingForRemotePrint
|
|
(
!
mPrintJob
|
|
mPrintJob
-
>
DonePrintingSheets
(
mPrintObj
NS_OK
)
)
)
{
initNewTimer
=
false
;
mDone
=
true
;
}
}
Stop
(
)
;
if
(
initNewTimer
)
{
+
+
mFiringCount
;
nsresult
result
=
StartTimer
(
inRange
)
;
if
(
NS_FAILED
(
result
)
)
{
mDone
=
true
;
if
(
mPrintJob
)
{
mPrintJob
-
>
SetIsPrinting
(
false
)
;
}
}
}
return
NS_OK
;
}
NS_IMETHODIMP
nsPagePrintTimer
:
:
Notify
(
nsITimer
*
timer
)
{
if
(
mDone
)
{
return
NS_OK
;
}
if
(
!
timer
)
{
mWatchDogCount
=
0
;
}
else
if
(
timer
=
=
mTimer
)
{
mWatchDogCount
=
0
;
mTimer
=
nullptr
;
}
else
if
(
timer
=
=
mWaitingForRemotePrint
)
{
mWaitingForRemotePrint
=
nullptr
;
if
(
mTimer
)
{
return
NS_OK
;
}
}
else
if
(
timer
=
=
mWatchDogTimer
)
{
mWatchDogCount
+
+
;
if
(
mWatchDogCount
>
WATCH_DOG_MAX_COUNT
)
{
Fail
(
)
;
return
NS_OK
;
}
}
bool
donePrePrint
=
true
;
if
(
mPrintJob
&
&
!
mWaitingForRemotePrint
)
{
donePrePrint
=
mPrintJob
-
>
PrePrintSheet
(
)
;
}
if
(
donePrePrint
&
&
!
mWaitingForRemotePrint
)
{
StopWatchDogTimer
(
)
;
mDocument
-
>
Dispatch
(
do_AddRef
(
this
)
)
;
}
else
{
StartWatchDogTimer
(
)
;
}
return
NS_OK
;
}
void
nsPagePrintTimer
:
:
WaitForRemotePrint
(
)
{
mWaitingForRemotePrint
=
NS_NewTimer
(
)
;
if
(
!
mWaitingForRemotePrint
)
{
NS_WARNING
(
"
Failed
to
wait
for
remote
print
we
might
time
-
out
.
"
)
;
}
}
void
nsPagePrintTimer
:
:
RemotePrintFinished
(
)
{
if
(
!
mWaitingForRemotePrint
)
{
return
;
}
if
(
mDone
&
&
mPrintJob
)
{
mDone
=
mPrintJob
-
>
DonePrintingSheets
(
mPrintObj
NS_OK
)
;
}
mWaitingForRemotePrint
-
>
SetTarget
(
GetMainThreadSerialEventTarget
(
)
)
;
mozilla
:
:
Unused
<
<
mWaitingForRemotePrint
-
>
InitWithCallback
(
this
0
nsITimer
:
:
TYPE_ONE_SHOT
)
;
}
nsresult
nsPagePrintTimer
:
:
Start
(
nsPrintObject
*
aPO
)
{
mPrintObj
=
aPO
;
mDone
=
false
;
return
StartTimer
(
false
)
;
}
void
nsPagePrintTimer
:
:
Stop
(
)
{
if
(
mTimer
)
{
mTimer
-
>
Cancel
(
)
;
mTimer
=
nullptr
;
}
StopWatchDogTimer
(
)
;
}
void
nsPagePrintTimer
:
:
Fail
(
)
{
NS_WARNING
(
"
nsPagePrintTimer
:
:
Fail
called
"
)
;
mDone
=
true
;
Stop
(
)
;
if
(
mPrintJob
)
{
mPrintJob
-
>
CleanupOnFailure
(
NS_OK
false
)
;
}
}
