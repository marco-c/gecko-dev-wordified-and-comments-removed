#
include
"
RemotePrintJobChild
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsPagePrintTimer
.
h
"
#
include
"
nsPrintJob
.
h
"
#
include
"
private
/
pprio
.
h
"
namespace
mozilla
{
namespace
layout
{
NS_IMPL_ISUPPORTS
(
RemotePrintJobChild
nsIWebProgressListener
)
RemotePrintJobChild
:
:
RemotePrintJobChild
(
)
{
}
nsresult
RemotePrintJobChild
:
:
InitializePrint
(
const
nsString
&
aDocumentTitle
const
nsString
&
aPrintToFile
const
int32_t
&
aStartPage
const
int32_t
&
aEndPage
)
{
Unused
<
<
SendInitializePrint
(
aDocumentTitle
aPrintToFile
aStartPage
aEndPage
)
;
mozilla
:
:
SpinEventLoopUntil
(
[
&
]
(
)
{
return
mPrintInitialized
;
}
)
;
return
mInitializationResult
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobChild
:
:
RecvPrintInitializationResult
(
const
nsresult
&
aRv
const
mozilla
:
:
ipc
:
:
FileDescriptor
&
aFd
)
{
mPrintInitialized
=
true
;
mInitializationResult
=
aRv
;
if
(
NS_SUCCEEDED
(
aRv
)
)
{
SetNextPageFD
(
aFd
)
;
}
return
IPC_OK
(
)
;
}
PRFileDesc
*
RemotePrintJobChild
:
:
GetNextPageFD
(
)
{
MOZ_ASSERT
(
mNextPageFD
)
;
PRFileDesc
*
fd
=
mNextPageFD
;
mNextPageFD
=
nullptr
;
return
fd
;
}
void
RemotePrintJobChild
:
:
SetNextPageFD
(
const
mozilla
:
:
ipc
:
:
FileDescriptor
&
aFd
)
{
auto
handle
=
aFd
.
ClonePlatformHandle
(
)
;
mNextPageFD
=
PR_ImportFile
(
PROsfd
(
handle
.
release
(
)
)
)
;
}
void
RemotePrintJobChild
:
:
ProcessPage
(
)
{
MOZ_ASSERT
(
mPagePrintTimer
)
;
mPagePrintTimer
-
>
WaitForRemotePrint
(
)
;
if
(
!
mDestroyed
)
{
Unused
<
<
SendProcessPage
(
)
;
}
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobChild
:
:
RecvPageProcessed
(
const
mozilla
:
:
ipc
:
:
FileDescriptor
&
aFd
)
{
MOZ_ASSERT
(
mPagePrintTimer
)
;
SetNextPageFD
(
aFd
)
;
mPagePrintTimer
-
>
RemotePrintFinished
(
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobChild
:
:
RecvAbortPrint
(
const
nsresult
&
aRv
)
{
MOZ_ASSERT
(
mPrintJob
)
;
mPrintJob
-
>
CleanupOnFailure
(
aRv
true
)
;
return
IPC_OK
(
)
;
}
void
RemotePrintJobChild
:
:
SetPagePrintTimer
(
nsPagePrintTimer
*
aPagePrintTimer
)
{
MOZ_ASSERT
(
aPagePrintTimer
)
;
mPagePrintTimer
=
aPagePrintTimer
;
}
void
RemotePrintJobChild
:
:
SetPrintJob
(
nsPrintJob
*
aPrintJob
)
{
MOZ_ASSERT
(
aPrintJob
)
;
mPrintJob
=
aPrintJob
;
}
NS_IMETHODIMP
RemotePrintJobChild
:
:
OnStateChange
(
nsIWebProgress
*
aProgress
nsIRequest
*
aRequest
uint32_t
aStateFlags
nsresult
aStatus
)
{
if
(
!
mDestroyed
)
{
Unused
<
<
SendStateChange
(
aStateFlags
aStatus
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
RemotePrintJobChild
:
:
OnProgressChange
(
nsIWebProgress
*
aProgress
nsIRequest
*
aRequest
int32_t
aCurSelfProgress
int32_t
aMaxSelfProgress
int32_t
aCurTotalProgress
int32_t
aMaxTotalProgress
)
{
if
(
!
mDestroyed
)
{
Unused
<
<
SendProgressChange
(
aCurSelfProgress
aMaxSelfProgress
aCurTotalProgress
aMaxTotalProgress
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
RemotePrintJobChild
:
:
OnLocationChange
(
nsIWebProgress
*
aProgress
nsIRequest
*
aRequest
nsIURI
*
aURI
uint32_t
aFlags
)
{
return
NS_OK
;
}
NS_IMETHODIMP
RemotePrintJobChild
:
:
OnStatusChange
(
nsIWebProgress
*
aProgress
nsIRequest
*
aRequest
nsresult
aStatus
const
char16_t
*
aMessage
)
{
if
(
NS_SUCCEEDED
(
mInitializationResult
)
&
&
!
mDestroyed
)
{
Unused
<
<
SendStatusChange
(
aStatus
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
RemotePrintJobChild
:
:
OnSecurityChange
(
nsIWebProgress
*
aProgress
nsIRequest
*
aRequest
uint32_t
aState
)
{
return
NS_OK
;
}
RemotePrintJobChild
:
:
~
RemotePrintJobChild
(
)
{
}
void
RemotePrintJobChild
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
mPagePrintTimer
=
nullptr
;
mPrintJob
=
nullptr
;
mDestroyed
=
true
;
}
}
}
