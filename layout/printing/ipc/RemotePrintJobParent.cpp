#
include
"
RemotePrintJobParent
.
h
"
#
include
<
istream
>
#
include
"
gfxContext
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsDeviceContext
.
h
"
#
include
"
nsIDeviceContextSpec
.
h
"
#
include
"
nsIPrintSettings
.
h
"
#
include
"
nsIWebProgressListener
.
h
"
#
include
"
PrintTranslator
.
h
"
namespace
mozilla
{
namespace
layout
{
RemotePrintJobParent
:
:
RemotePrintJobParent
(
nsIPrintSettings
*
aPrintSettings
)
:
mPrintSettings
(
aPrintSettings
)
{
MOZ_COUNT_CTOR
(
RemotePrintJobParent
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobParent
:
:
RecvInitializePrint
(
const
nsString
&
aDocumentTitle
const
nsString
&
aPrintToFile
const
int32_t
&
aStartPage
const
int32_t
&
aEndPage
)
{
nsresult
rv
=
InitializePrintDevice
(
aDocumentTitle
aPrintToFile
aStartPage
aEndPage
)
;
if
(
NS_FAILED
(
rv
)
)
{
Unused
<
<
SendPrintInitializationResult
(
rv
)
;
Unused
<
<
Send__delete__
(
this
)
;
return
IPC_OK
(
)
;
}
mPrintTranslator
.
reset
(
new
PrintTranslator
(
mPrintDeviceContext
)
)
;
Unused
<
<
SendPrintInitializationResult
(
NS_OK
)
;
return
IPC_OK
(
)
;
}
nsresult
RemotePrintJobParent
:
:
InitializePrintDevice
(
const
nsString
&
aDocumentTitle
const
nsString
&
aPrintToFile
const
int32_t
&
aStartPage
const
int32_t
&
aEndPage
)
{
nsresult
rv
;
nsCOMPtr
<
nsIDeviceContextSpec
>
deviceContextSpec
=
do_CreateInstance
(
"
mozilla
.
org
/
gfx
/
devicecontextspec
;
1
"
&
rv
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
rv
=
deviceContextSpec
-
>
Init
(
nullptr
mPrintSettings
false
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
mPrintDeviceContext
=
new
nsDeviceContext
(
)
;
rv
=
mPrintDeviceContext
-
>
InitForPrinting
(
deviceContextSpec
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
rv
=
mPrintDeviceContext
-
>
BeginDocument
(
aDocumentTitle
aPrintToFile
aStartPage
aEndPage
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobParent
:
:
RecvProcessPage
(
Shmem
&
&
aStoredPage
)
{
nsresult
rv
=
PrintPage
(
aStoredPage
)
;
if
(
!
DeallocShmem
(
aStoredPage
)
)
{
NS_WARNING
(
"
Failed
to
deallocated
shared
memory
remote
print
will
abort
.
"
)
;
rv
=
NS_ERROR_FAILURE
;
}
if
(
NS_FAILED
(
rv
)
)
{
Unused
<
<
SendAbortPrint
(
rv
)
;
}
else
{
Unused
<
<
SendPageProcessed
(
)
;
}
return
IPC_OK
(
)
;
}
nsresult
RemotePrintJobParent
:
:
PrintPage
(
const
Shmem
&
aStoredPage
)
{
MOZ_ASSERT
(
mPrintDeviceContext
)
;
nsresult
rv
=
mPrintDeviceContext
-
>
BeginPage
(
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
std
:
:
istringstream
recording
(
std
:
:
string
(
aStoredPage
.
get
<
char
>
(
)
aStoredPage
.
Size
<
char
>
(
)
)
)
;
if
(
!
mPrintTranslator
-
>
TranslateRecording
(
recording
)
)
{
return
NS_ERROR_FAILURE
;
}
rv
=
mPrintDeviceContext
-
>
EndPage
(
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobParent
:
:
RecvFinalizePrint
(
)
{
if
(
mPrintDeviceContext
)
{
DebugOnly
<
nsresult
>
rv
=
mPrintDeviceContext
-
>
EndDocument
(
)
;
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
EndDocument
failed
"
)
;
}
Unused
<
<
Send__delete__
(
this
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobParent
:
:
RecvAbortPrint
(
const
nsresult
&
aRv
)
{
if
(
mPrintDeviceContext
)
{
Unused
<
<
mPrintDeviceContext
-
>
AbortDocument
(
)
;
}
Unused
<
<
Send__delete__
(
this
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobParent
:
:
RecvStateChange
(
const
long
&
aStateFlags
const
nsresult
&
aStatus
)
{
uint32_t
numberOfListeners
=
mPrintProgressListeners
.
Length
(
)
;
for
(
uint32_t
i
=
0
;
i
<
numberOfListeners
;
+
+
i
)
{
nsIWebProgressListener
*
listener
=
mPrintProgressListeners
.
SafeElementAt
(
i
)
;
listener
-
>
OnStateChange
(
nullptr
nullptr
aStateFlags
aStatus
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobParent
:
:
RecvProgressChange
(
const
long
&
aCurSelfProgress
const
long
&
aMaxSelfProgress
const
long
&
aCurTotalProgress
const
long
&
aMaxTotalProgress
)
{
uint32_t
numberOfListeners
=
mPrintProgressListeners
.
Length
(
)
;
for
(
uint32_t
i
=
0
;
i
<
numberOfListeners
;
+
+
i
)
{
nsIWebProgressListener
*
listener
=
mPrintProgressListeners
.
SafeElementAt
(
i
)
;
listener
-
>
OnProgressChange
(
nullptr
nullptr
aCurSelfProgress
aMaxSelfProgress
aCurTotalProgress
aMaxTotalProgress
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RemotePrintJobParent
:
:
RecvStatusChange
(
const
nsresult
&
aStatus
)
{
uint32_t
numberOfListeners
=
mPrintProgressListeners
.
Length
(
)
;
for
(
uint32_t
i
=
0
;
i
<
numberOfListeners
;
+
+
i
)
{
nsIWebProgressListener
*
listener
=
mPrintProgressListeners
.
SafeElementAt
(
i
)
;
listener
-
>
OnStatusChange
(
nullptr
nullptr
aStatus
nullptr
)
;
}
return
IPC_OK
(
)
;
}
void
RemotePrintJobParent
:
:
RegisterListener
(
nsIWebProgressListener
*
aListener
)
{
MOZ_ASSERT
(
aListener
)
;
mPrintProgressListeners
.
AppendElement
(
aListener
)
;
}
already_AddRefed
<
nsIPrintSettings
>
RemotePrintJobParent
:
:
GetPrintSettings
(
)
{
nsCOMPtr
<
nsIPrintSettings
>
printSettings
=
mPrintSettings
;
return
printSettings
.
forget
(
)
;
}
RemotePrintJobParent
:
:
~
RemotePrintJobParent
(
)
{
MOZ_COUNT_DTOR
(
RemotePrintJobParent
)
;
}
void
RemotePrintJobParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
}
}
}
