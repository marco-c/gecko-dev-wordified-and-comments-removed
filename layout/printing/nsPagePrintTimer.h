#
ifndef
nsPagePrintTimer_h___
#
define
nsPagePrintTimer_h___
#
include
"
nsITimer
.
h
"
#
include
"
nsIDocumentViewerPrint
.
h
"
#
include
"
nsPrintObject
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsThreadUtils
.
h
"
class
nsPrintEngine
;
class
nsIDocument
;
class
nsPagePrintTimer
final
:
public
mozilla
:
:
Runnable
public
nsITimerCallback
{
public
:
NS_DECL_ISUPPORTS_INHERITED
nsPagePrintTimer
(
nsPrintEngine
*
aPrintEngine
nsIDocumentViewerPrint
*
aDocViewerPrint
nsIDocument
*
aDocument
uint32_t
aDelay
)
:
Runnable
(
"
nsPagePrintTimer
"
)
mPrintEngine
(
aPrintEngine
)
mDocViewerPrint
(
aDocViewerPrint
)
mDocument
(
aDocument
)
mDelay
(
aDelay
)
mFiringCount
(
0
)
mPrintObj
(
nullptr
)
mWatchDogCount
(
0
)
mDone
(
false
)
{
MOZ_ASSERT
(
aDocument
)
;
mDocViewerPrint
-
>
IncrementDestroyRefCount
(
)
;
}
NS_DECL_NSITIMERCALLBACK
nsresult
Start
(
nsPrintObject
*
aPO
)
;
NS_IMETHOD
Run
(
)
override
;
void
Stop
(
)
;
void
WaitForRemotePrint
(
)
;
void
RemotePrintFinished
(
)
;
void
Disconnect
(
)
{
mPrintEngine
=
nullptr
;
mPrintObj
=
nullptr
;
}
private
:
~
nsPagePrintTimer
(
)
;
nsresult
StartTimer
(
bool
aUseDelay
)
;
nsresult
StartWatchDogTimer
(
)
;
void
StopWatchDogTimer
(
)
;
void
Fail
(
)
;
nsPrintEngine
*
mPrintEngine
;
nsCOMPtr
<
nsIDocumentViewerPrint
>
mDocViewerPrint
;
nsCOMPtr
<
nsIDocument
>
mDocument
;
nsCOMPtr
<
nsITimer
>
mTimer
;
nsCOMPtr
<
nsITimer
>
mWatchDogTimer
;
nsCOMPtr
<
nsITimer
>
mWaitingForRemotePrint
;
uint32_t
mDelay
;
uint32_t
mFiringCount
;
nsPrintObject
*
mPrintObj
;
uint32_t
mWatchDogCount
;
bool
mDone
;
static
const
uint32_t
WATCH_DOG_INTERVAL
=
1000
;
static
const
uint32_t
WATCH_DOG_MAX_COUNT
=
#
ifdef
DEBUG
30
#
else
10
#
endif
;
}
;
#
endif
