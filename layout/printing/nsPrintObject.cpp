#
include
"
nsPrintObject
.
h
"
#
include
"
nsIContentViewer
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsPIDOMWindow
.
h
"
#
include
"
nsGkAtoms
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsIDocShellTreeItem
.
h
"
#
include
"
nsIBaseWindow
.
h
"
#
include
"
nsIDocument
.
h
"
nsPrintObject
:
:
nsPrintObject
(
)
:
mContent
(
nullptr
)
mFrameType
(
eFrame
)
mParent
(
nullptr
)
mHasBeenPrinted
(
false
)
mDontPrint
(
true
)
mPrintAsIs
(
false
)
mInvisible
(
false
)
mPrintPreview
(
false
)
mDidCreateDocShell
(
false
)
mShrinkRatio
(
1
.
0
)
mZoomRatio
(
1
.
0
)
{
MOZ_COUNT_CTOR
(
nsPrintObject
)
;
}
nsPrintObject
:
:
~
nsPrintObject
(
)
{
MOZ_COUNT_DTOR
(
nsPrintObject
)
;
DestroyPresentation
(
)
;
if
(
mDidCreateDocShell
&
&
mDocShell
)
{
nsCOMPtr
<
nsIBaseWindow
>
baseWin
(
do_QueryInterface
(
mDocShell
)
)
;
if
(
baseWin
)
{
baseWin
-
>
Destroy
(
)
;
}
}
mDocShell
=
nullptr
;
mTreeOwner
=
nullptr
;
}
nsresult
nsPrintObject
:
:
Init
(
nsIDocShell
*
aDocShell
nsIDocument
*
aDoc
bool
aPrintPreview
)
{
NS_ENSURE_STATE
(
aDoc
)
;
mPrintPreview
=
aPrintPreview
;
if
(
mPrintPreview
|
|
mParent
)
{
mDocShell
=
aDocShell
;
}
else
{
mTreeOwner
=
do_GetInterface
(
aDocShell
)
;
mDocShell
=
do_CreateInstance
(
"
mozilla
.
org
/
docshell
;
1
"
)
;
NS_ENSURE_TRUE
(
mDocShell
NS_ERROR_OUT_OF_MEMORY
)
;
mDidCreateDocShell
=
true
;
mDocShell
-
>
SetItemType
(
aDocShell
-
>
ItemType
(
)
)
;
mDocShell
-
>
SetTreeOwner
(
mTreeOwner
)
;
}
NS_ENSURE_TRUE
(
mDocShell
NS_ERROR_FAILURE
)
;
nsCOMPtr
<
nsIDocument
>
dummy
=
do_GetInterface
(
mDocShell
)
;
mozilla
:
:
Unused
<
<
dummy
;
nsCOMPtr
<
nsIContentViewer
>
viewer
;
mDocShell
-
>
GetContentViewer
(
getter_AddRefs
(
viewer
)
)
;
NS_ENSURE_STATE
(
viewer
)
;
if
(
mParent
)
{
nsCOMPtr
<
nsPIDOMWindowOuter
>
window
=
aDoc
-
>
GetWindow
(
)
;
if
(
window
)
{
mContent
=
window
-
>
GetFrameElementInternal
(
)
;
}
mDocument
=
aDoc
;
return
NS_OK
;
}
mDocument
=
aDoc
-
>
CreateStaticClone
(
mDocShell
)
;
NS_ENSURE_STATE
(
mDocument
)
;
viewer
-
>
SetDocument
(
mDocument
)
;
return
NS_OK
;
}
void
nsPrintObject
:
:
DestroyPresentation
(
)
{
if
(
mPresShell
)
{
mPresShell
-
>
EndObservingDocument
(
)
;
nsAutoScriptBlocker
scriptBlocker
;
nsCOMPtr
<
nsIPresShell
>
shell
=
mPresShell
;
mPresShell
=
nullptr
;
shell
-
>
Destroy
(
)
;
}
mPresContext
=
nullptr
;
mViewManager
=
nullptr
;
}
