#
include
"
base
/
basictypes
.
h
"
#
include
"
mozilla
/
dom
/
ContentParent
.
h
"
#
include
"
mozilla
/
dom
/
TabParent
.
h
"
#
include
"
mozilla
/
layers
/
CompositorBridgeParent
.
h
"
#
include
"
mozilla
/
layers
/
CompositorTypes
.
h
"
#
include
"
mozilla
/
layers
/
LayerTransactionParent
.
h
"
#
include
"
nsFrameLoader
.
h
"
#
include
"
nsStyleStructInlines
.
h
"
#
include
"
nsSubDocumentFrame
.
h
"
#
include
"
RenderFrame
.
h
"
#
include
"
mozilla
/
gfx
/
GPUProcessManager
.
h
"
#
include
"
mozilla
/
layers
/
CompositorBridgeChild
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayerManager
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderScrollData
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderAPI
.
h
"
using
namespace
mozilla
:
:
dom
;
using
namespace
mozilla
:
:
gfx
;
using
namespace
mozilla
:
:
layers
;
namespace
mozilla
{
namespace
layout
{
static
already_AddRefed
<
LayerManager
>
GetLayerManager
(
TabParent
*
aTabParent
)
{
if
(
Element
*
element
=
aTabParent
-
>
GetOwnerElement
(
)
)
{
if
(
RefPtr
<
LayerManager
>
lm
=
nsContentUtils
:
:
LayerManagerForContent
(
element
)
)
{
return
lm
.
forget
(
)
;
}
return
nsContentUtils
:
:
LayerManagerForDocument
(
element
-
>
OwnerDoc
(
)
)
;
}
return
nullptr
;
}
RenderFrame
:
:
RenderFrame
(
)
:
mLayersId
{
0
}
mTabParent
(
nullptr
)
mLayerManager
(
nullptr
)
mInitialized
(
false
)
mLayersConnected
(
false
)
{
}
RenderFrame
:
:
~
RenderFrame
(
)
{
}
bool
RenderFrame
:
:
Initialize
(
TabParent
*
aTabParent
)
{
if
(
mInitialized
|
|
!
aTabParent
)
{
return
false
;
}
mTabParent
=
aTabParent
;
RefPtr
<
LayerManager
>
lm
=
GetLayerManager
(
mTabParent
)
;
PCompositorBridgeChild
*
compositor
=
lm
?
lm
-
>
GetCompositorBridgeChild
(
)
:
nullptr
;
mTabProcessId
=
mTabParent
-
>
Manager
(
)
-
>
AsContentParent
(
)
-
>
OtherPid
(
)
;
GPUProcessManager
*
gpm
=
GPUProcessManager
:
:
Get
(
)
;
mLayersConnected
=
gpm
-
>
AllocateAndConnectLayerTreeId
(
compositor
mTabProcessId
&
mLayersId
&
mCompositorOptions
)
;
mInitialized
=
true
;
return
true
;
}
void
RenderFrame
:
:
Destroy
(
)
{
if
(
mLayersId
.
IsValid
(
)
)
{
GPUProcessManager
:
:
Get
(
)
-
>
UnmapLayerTreeId
(
mLayersId
mTabProcessId
)
;
}
mTabParent
=
nullptr
;
mLayerManager
=
nullptr
;
}
void
RenderFrame
:
:
EnsureLayersConnected
(
CompositorOptions
*
aCompositorOptions
)
{
RefPtr
<
LayerManager
>
lm
=
GetLayerManager
(
mTabParent
)
;
if
(
!
lm
)
{
return
;
}
if
(
!
lm
-
>
GetCompositorBridgeChild
(
)
)
{
return
;
}
mLayersConnected
=
lm
-
>
GetCompositorBridgeChild
(
)
-
>
SendNotifyChildRecreated
(
mLayersId
&
mCompositorOptions
)
;
*
aCompositorOptions
=
mCompositorOptions
;
}
LayerManager
*
RenderFrame
:
:
AttachLayerManager
(
)
{
RefPtr
<
LayerManager
>
lm
;
if
(
mTabParent
)
{
lm
=
GetLayerManager
(
mTabParent
)
;
}
if
(
lm
&
&
lm
-
>
GetCompositorBridgeChild
(
)
&
&
lm
!
=
mLayerManager
)
{
mLayersConnected
=
lm
-
>
GetCompositorBridgeChild
(
)
-
>
SendAdoptChild
(
mLayersId
)
;
FrameLayerBuilder
:
:
InvalidateAllLayers
(
lm
)
;
}
mLayerManager
=
lm
.
forget
(
)
;
return
mLayerManager
;
}
void
RenderFrame
:
:
OwnerContentChanged
(
)
{
Unused
<
<
AttachLayerManager
(
)
;
}
void
RenderFrame
:
:
GetTextureFactoryIdentifier
(
TextureFactoryIdentifier
*
aTextureFactoryIdentifier
)
const
{
RefPtr
<
LayerManager
>
lm
=
mTabParent
?
GetLayerManager
(
mTabParent
)
:
nullptr
;
if
(
lm
)
{
*
aTextureFactoryIdentifier
=
lm
-
>
GetTextureFactoryIdentifier
(
)
;
}
else
{
*
aTextureFactoryIdentifier
=
TextureFactoryIdentifier
(
)
;
}
}
}
}
static
mozilla
:
:
LayoutDeviceIntPoint
GetContentRectLayerOffset
(
nsIFrame
*
aContainerFrame
nsDisplayListBuilder
*
aBuilder
)
{
nscoord
auPerDevPixel
=
aContainerFrame
-
>
PresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
;
nsPoint
frameOffset
=
aBuilder
-
>
ToReferenceFrame
(
aContainerFrame
)
+
aContainerFrame
-
>
GetContentRectRelativeToSelf
(
)
.
TopLeft
(
)
;
return
mozilla
:
:
LayoutDeviceIntPoint
:
:
FromAppUnitsToNearest
(
frameOffset
auPerDevPixel
)
;
}
inline
static
bool
IsTempLayerManager
(
mozilla
:
:
layers
:
:
LayerManager
*
aManager
)
{
return
(
mozilla
:
:
layers
:
:
LayersBackend
:
:
LAYERS_BASIC
=
=
aManager
-
>
GetBackendType
(
)
&
&
!
static_cast
<
BasicLayerManager
*
>
(
aManager
)
-
>
IsRetained
(
)
)
;
}
nsDisplayRemote
:
:
nsDisplayRemote
(
nsDisplayListBuilder
*
aBuilder
nsSubDocumentFrame
*
aFrame
)
:
nsDisplayItem
(
aBuilder
aFrame
)
mTabId
{
0
}
mEventRegionsOverride
(
EventRegionsOverride
:
:
NoOverride
)
{
bool
frameIsPointerEventsNone
=
aFrame
-
>
StyleUI
(
)
-
>
GetEffectivePointerEvents
(
aFrame
)
=
=
NS_STYLE_POINTER_EVENTS_NONE
;
if
(
aBuilder
-
>
IsInsidePointerEventsNoneDoc
(
)
|
|
frameIsPointerEventsNone
)
{
mEventRegionsOverride
|
=
EventRegionsOverride
:
:
ForceEmptyHitRegion
;
}
if
(
nsLayoutUtils
:
:
HasDocumentLevelListenersForApzAwareEvents
(
aFrame
-
>
PresShell
(
)
)
)
{
mEventRegionsOverride
|
=
EventRegionsOverride
:
:
ForceDispatchToContent
;
}
nsFrameLoader
*
frameLoader
=
GetRenderFrame
(
)
-
>
GetFrameLoader
(
)
;
if
(
frameLoader
)
{
TabParent
*
browser
=
TabParent
:
:
GetFrom
(
frameLoader
)
;
if
(
browser
)
{
mTabId
=
browser
-
>
GetTabId
(
)
;
}
}
}
mozilla
:
:
LayerState
nsDisplayRemote
:
:
GetLayerState
(
nsDisplayListBuilder
*
aBuilder
LayerManager
*
aManager
const
ContainerLayerParameters
&
aParameters
)
{
if
(
IsTempLayerManager
(
aManager
)
)
{
return
mozilla
:
:
LAYER_NONE
;
}
return
mozilla
:
:
LAYER_ACTIVE_FORCE
;
}
bool
nsDisplayRemote
:
:
HasDeletedFrame
(
)
const
{
return
!
GetRenderFrame
(
)
|
|
nsDisplayItem
:
:
HasDeletedFrame
(
)
;
}
already_AddRefed
<
Layer
>
nsDisplayRemote
:
:
BuildLayer
(
nsDisplayListBuilder
*
aBuilder
LayerManager
*
aManager
const
ContainerLayerParameters
&
aContainerParameters
)
{
MOZ_ASSERT
(
GetRenderFrame
(
)
)
;
MOZ_ASSERT
(
mFrame
"
Makes
no
sense
to
have
a
shadow
tree
without
a
frame
"
)
;
if
(
IsTempLayerManager
(
aManager
)
)
{
if
(
!
aContainerParameters
.
mForEventsAndPluginsOnly
)
{
NS_WARNING
(
"
Remote
iframe
not
rendered
"
)
;
}
return
nullptr
;
}
LayersId
remoteId
=
GetRenderFrame
(
)
-
>
GetLayersId
(
)
;
if
(
!
remoteId
.
IsValid
(
)
)
{
return
nullptr
;
}
RefPtr
<
Layer
>
layer
=
aManager
-
>
GetLayerBuilder
(
)
-
>
GetLeafLayerFor
(
aBuilder
this
)
;
if
(
!
layer
)
{
layer
=
aManager
-
>
CreateRefLayer
(
)
;
}
if
(
!
layer
)
{
return
nullptr
;
}
static_cast
<
RefLayer
*
>
(
layer
.
get
(
)
)
-
>
SetReferentId
(
remoteId
)
;
LayoutDeviceIntPoint
offset
=
GetContentRectLayerOffset
(
Frame
(
)
aBuilder
)
;
MOZ_ASSERT
(
aContainerParameters
.
mOffset
=
=
nsIntPoint
(
)
)
;
Matrix4x4
m
=
Matrix4x4
:
:
Translation
(
offset
.
x
offset
.
y
0
.
0
)
;
m
.
PreScale
(
aContainerParameters
.
mXScale
aContainerParameters
.
mYScale
1
.
0
)
;
layer
-
>
SetBaseTransform
(
m
)
;
if
(
layer
-
>
AsRefLayer
(
)
)
{
layer
-
>
AsRefLayer
(
)
-
>
SetEventRegionsOverride
(
mEventRegionsOverride
)
;
}
return
layer
.
forget
(
)
;
}
void
nsDisplayRemote
:
:
Paint
(
nsDisplayListBuilder
*
aBuilder
gfxContext
*
aCtx
)
{
DrawTarget
*
target
=
aCtx
-
>
GetDrawTarget
(
)
;
if
(
!
target
-
>
IsRecording
(
)
|
|
mTabId
=
=
0
)
{
NS_WARNING
(
"
Remote
iframe
not
rendered
"
)
;
return
;
}
int32_t
appUnitsPerDevPixel
=
mFrame
-
>
PresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
;
Rect
destRect
=
mozilla
:
:
NSRectToSnappedRect
(
GetContentRect
(
)
appUnitsPerDevPixel
*
target
)
;
target
-
>
DrawDependentSurface
(
mTabId
destRect
)
;
}
bool
nsDisplayRemote
:
:
CreateWebRenderCommands
(
mozilla
:
:
wr
:
:
DisplayListBuilder
&
aBuilder
mozilla
:
:
wr
:
:
IpcResourceUpdateQueue
&
aResources
const
StackingContextHelper
&
aSc
mozilla
:
:
layers
:
:
RenderRootStateManager
*
aManager
nsDisplayListBuilder
*
aDisplayListBuilder
)
{
mOffset
=
GetContentRectLayerOffset
(
mFrame
aDisplayListBuilder
)
;
LayoutDeviceRect
rect
=
LayoutDeviceRect
:
:
FromAppUnits
(
mFrame
-
>
GetContentRectRelativeToSelf
(
)
mFrame
-
>
PresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
)
;
rect
+
=
mOffset
;
aBuilder
.
PushIFrame
(
mozilla
:
:
wr
:
:
ToRoundedLayoutRect
(
rect
)
!
BackfaceIsHidden
(
)
mozilla
:
:
wr
:
:
AsPipelineId
(
GetRemoteLayersId
(
)
)
true
)
;
return
true
;
}
bool
nsDisplayRemote
:
:
UpdateScrollData
(
mozilla
:
:
layers
:
:
WebRenderScrollData
*
aData
mozilla
:
:
layers
:
:
WebRenderLayerScrollData
*
aLayerData
)
{
if
(
aLayerData
)
{
aLayerData
-
>
SetReferentId
(
GetRemoteLayersId
(
)
)
;
aLayerData
-
>
SetTransform
(
mozilla
:
:
gfx
:
:
Matrix4x4
:
:
Translation
(
mOffset
.
x
mOffset
.
y
0
.
0
)
)
;
aLayerData
-
>
SetEventRegionsOverride
(
mEventRegionsOverride
)
;
}
return
true
;
}
LayersId
nsDisplayRemote
:
:
GetRemoteLayersId
(
)
const
{
MOZ_ASSERT
(
GetRenderFrame
(
)
)
;
return
GetRenderFrame
(
)
-
>
GetLayersId
(
)
;
}
mozilla
:
:
layout
:
:
RenderFrame
*
nsDisplayRemote
:
:
GetRenderFrame
(
)
const
{
return
mFrame
?
static_cast
<
nsSubDocumentFrame
*
>
(
mFrame
)
-
>
GetRenderFrame
(
)
:
nullptr
;
}
