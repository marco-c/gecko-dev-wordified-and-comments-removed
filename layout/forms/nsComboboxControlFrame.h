#
ifndef
nsComboboxControlFrame_h___
#
define
nsComboboxControlFrame_h___
#
ifdef
DEBUG_evaughan
#
endif
#
ifdef
DEBUG_rods
#
endif
#
define
NS_SKIP_NOTIFY_INDEX
-
2
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsBlockFrame
.
h
"
#
include
"
nsIFormControlFrame
.
h
"
#
include
"
nsIAnonymousContentCreator
.
h
"
#
include
"
nsISelectControlFrame
.
h
"
#
include
"
nsIRollupListener
.
h
"
#
include
"
nsIStatefulFrame
.
h
"
#
include
"
nsThreadUtils
.
h
"
class
nsListControlFrame
;
class
nsComboboxDisplayFrame
;
class
nsIDOMEventListener
;
class
nsIScrollableFrame
;
class
nsTextNode
;
namespace
mozilla
{
namespace
gfx
{
class
DrawTarget
;
}
}
class
nsComboboxControlFrame
final
:
public
nsBlockFrame
public
nsIFormControlFrame
public
nsIAnonymousContentCreator
public
nsISelectControlFrame
public
nsIRollupListener
public
nsIStatefulFrame
{
typedef
mozilla
:
:
gfx
:
:
DrawTarget
DrawTarget
;
public
:
friend
nsComboboxControlFrame
*
NS_NewComboboxControlFrame
(
nsIPresShell
*
aPresShell
ComputedStyle
*
aStyle
nsFrameState
aFlags
)
;
friend
class
nsComboboxDisplayFrame
;
explicit
nsComboboxControlFrame
(
ComputedStyle
*
aStyle
nsPresContext
*
aPresContext
)
;
~
nsComboboxControlFrame
(
)
;
NS_DECL_QUERYFRAME
NS_DECL_FRAMEARENA_HELPERS
(
nsComboboxControlFrame
)
virtual
nsresult
CreateAnonymousContent
(
nsTArray
<
ContentInfo
>
&
aElements
)
override
;
virtual
void
AppendAnonymousContentTo
(
nsTArray
<
nsIContent
*
>
&
aElements
uint32_t
aFilter
)
override
;
nsIContent
*
GetDisplayNode
(
)
const
;
nsIFrame
*
CreateFrameForDisplayNode
(
)
;
#
ifdef
ACCESSIBILITY
virtual
mozilla
:
:
a11y
:
:
AccType
AccessibleType
(
)
override
;
#
endif
virtual
nscoord
GetMinISize
(
gfxContext
*
aRenderingContext
)
override
;
virtual
nscoord
GetPrefISize
(
gfxContext
*
aRenderingContext
)
override
;
virtual
void
Reflow
(
nsPresContext
*
aCX
ReflowOutput
&
aDesiredSize
const
ReflowInput
&
aReflowInput
nsReflowStatus
&
aStatus
)
override
;
virtual
nsresult
HandleEvent
(
nsPresContext
*
aPresContext
mozilla
:
:
WidgetGUIEvent
*
aEvent
nsEventStatus
*
aEventStatus
)
override
;
virtual
void
BuildDisplayList
(
nsDisplayListBuilder
*
aBuilder
const
nsDisplayListSet
&
aLists
)
override
;
void
PaintFocus
(
DrawTarget
&
aDrawTarget
nsPoint
aPt
)
;
virtual
bool
IsFrameOfType
(
uint32_t
aFlags
)
const
override
{
return
nsBlockFrame
:
:
IsFrameOfType
(
aFlags
&
~
(
nsIFrame
:
:
eReplaced
|
nsIFrame
:
:
eReplacedContainsBlock
)
)
;
}
virtual
nsIScrollableFrame
*
GetScrollTargetFrame
(
)
override
{
return
do_QueryFrame
(
mDropdownFrame
)
;
}
#
ifdef
DEBUG_FRAME_DUMP
virtual
nsresult
GetFrameName
(
nsAString
&
aResult
)
const
override
;
#
endif
virtual
void
DestroyFrom
(
nsIFrame
*
aDestructRoot
PostDestroyData
&
aPostDestroyData
)
override
;
virtual
void
SetInitialChildList
(
ChildListID
aListID
nsFrameList
&
aChildList
)
override
;
virtual
const
nsFrameList
&
GetChildList
(
ChildListID
aListID
)
const
override
;
virtual
void
GetChildLists
(
nsTArray
<
ChildList
>
*
aLists
)
const
override
;
virtual
nsContainerFrame
*
GetContentInsertionFrame
(
)
override
;
void
AppendDirectlyOwnedAnonBoxes
(
nsTArray
<
OwnedAnonBox
>
&
aResult
)
override
;
virtual
nsresult
SetFormProperty
(
nsAtom
*
aName
const
nsAString
&
aValue
)
override
;
MOZ_CAN_RUN_SCRIPT_BOUNDARY
virtual
void
SetFocus
(
bool
aOn
bool
aRepaint
)
override
;
bool
IsDroppedDown
(
)
{
return
mDroppedDown
;
}
void
ShowDropDown
(
bool
aDoDropDown
)
;
nsIFrame
*
GetDropDown
(
)
;
void
SetDropDown
(
nsIFrame
*
aDropDownFrame
)
;
void
RollupFromList
(
)
;
void
GetAvailableDropdownSpace
(
mozilla
:
:
WritingMode
aWM
nscoord
*
aBefore
nscoord
*
aAfter
mozilla
:
:
LogicalPoint
*
aTranslation
)
;
int32_t
GetIndexOfDisplayArea
(
)
;
nsresult
RedisplaySelectedText
(
)
;
int32_t
UpdateRecentIndex
(
int32_t
aIndex
)
;
void
OnContentReset
(
)
;
bool
IsOpenInParentProcess
(
)
{
return
mIsOpenInParentProcess
;
}
void
SetOpenInParentProcess
(
bool
aVal
)
{
mIsOpenInParentProcess
=
aVal
;
}
bool
IsDroppedDownOrHasParentPopup
(
)
{
return
IsDroppedDown
(
)
|
|
IsOpenInParentProcess
(
)
;
}
NS_IMETHOD
AddOption
(
int32_t
index
)
override
;
NS_IMETHOD
RemoveOption
(
int32_t
index
)
override
;
NS_IMETHOD
DoneAddingChildren
(
bool
aIsDone
)
override
;
NS_IMETHOD
OnOptionSelected
(
int32_t
aIndex
bool
aSelected
)
override
;
NS_IMETHOD_
(
void
)
OnSetSelectedIndex
(
int32_t
aOldIndex
int32_t
aNewIndex
)
override
;
virtual
bool
Rollup
(
uint32_t
aCount
bool
aFlush
const
nsIntPoint
*
pos
nsIContent
*
*
aLastRolledUp
)
override
;
virtual
void
NotifyGeometryChange
(
)
override
;
virtual
bool
ShouldRollupOnMouseWheelEvent
(
)
override
{
return
true
;
}
virtual
bool
ShouldConsumeOnMouseWheelEvent
(
)
override
{
return
false
;
}
virtual
bool
ShouldRollupOnMouseActivate
(
)
override
{
return
false
;
}
virtual
uint32_t
GetSubmenuWidgetChain
(
nsTArray
<
nsIWidget
*
>
*
aWidgetChain
)
override
{
return
0
;
}
virtual
nsIWidget
*
GetRollupWidget
(
)
override
;
mozilla
:
:
UniquePtr
<
mozilla
:
:
PresState
>
SaveState
(
)
override
;
NS_IMETHOD
RestoreState
(
mozilla
:
:
PresState
*
aState
)
override
;
NS_IMETHOD
GenerateStateKey
(
nsIContent
*
aContent
mozilla
:
:
dom
:
:
Document
*
aDocument
nsACString
&
aKey
)
override
;
static
bool
ToolkitHasNativePopup
(
)
;
protected
:
friend
class
RedisplayTextEvent
;
friend
class
nsAsyncResize
;
friend
class
nsResizeDropdownAtFinalPosition
;
void
ReflowDropdown
(
nsPresContext
*
aPresContext
const
ReflowInput
&
aReflowInput
)
;
bool
HasDropDownButton
(
)
const
;
enum
DropDownPositionState
{
eDropDownPositionSuppressed
eDropDownPositionPendingResize
eDropDownPositionFinal
}
;
DropDownPositionState
AbsolutelyPositionDropDown
(
)
;
nscoord
GetIntrinsicISize
(
gfxContext
*
aRenderingContext
nsLayoutUtils
:
:
IntrinsicISizeType
aType
)
;
class
RedisplayTextEvent
:
public
mozilla
:
:
Runnable
{
public
:
NS_DECL_NSIRUNNABLE
explicit
RedisplayTextEvent
(
nsComboboxControlFrame
*
c
)
:
mozilla
:
:
Runnable
(
"
nsComboboxControlFrame
:
:
RedisplayTextEvent
"
)
mControlFrame
(
c
)
{
}
void
Revoke
(
)
{
mControlFrame
=
nullptr
;
}
private
:
nsComboboxControlFrame
*
mControlFrame
;
}
;
void
ShowPopup
(
bool
aShowPopup
)
;
bool
ShowList
(
bool
aShowList
)
;
void
CheckFireOnChange
(
)
;
void
FireValueChangeEvent
(
)
;
nsresult
RedisplayText
(
)
;
void
HandleRedisplayTextEvent
(
)
;
void
ActuallyDisplayText
(
bool
aNotify
)
;
private
:
nsPoint
GetCSSTransformTranslation
(
)
;
protected
:
nsFrameList
mPopupFrames
;
RefPtr
<
nsTextNode
>
mDisplayContent
;
RefPtr
<
Element
>
mButtonContent
;
nsContainerFrame
*
mDisplayFrame
;
nsIFrame
*
mButtonFrame
;
nsIFrame
*
mDropdownFrame
;
nsListControlFrame
*
mListControlFrame
;
nscoord
mDisplayISize
;
nsRevocableEventPtr
<
RedisplayTextEvent
>
mRedisplayTextEvent
;
int32_t
mRecentSelectedIndex
;
int32_t
mDisplayedIndex
;
nsString
mDisplayedOptionTextOrPreview
;
nsCOMPtr
<
nsIDOMEventListener
>
mButtonListener
;
nscoord
mLastDropDownBeforeScreenBCoord
;
nscoord
mLastDropDownAfterScreenBCoord
;
bool
mDroppedDown
;
bool
mInRedisplayText
;
bool
mDelayedShowDropDown
;
bool
mIsOpenInParentProcess
;
static
nsComboboxControlFrame
*
sFocused
;
#
ifdef
DO_REFLOW_COUNTER
int32_t
mReflowId
;
#
endif
}
;
#
endif
