#
include
"
nsAutoPtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIServiceManager
.
h
"
#
include
"
nsResizerFrame
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsGkAtoms
.
h
"
#
include
"
nsNameSpaceManager
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsFrameManager
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsIDocShellTreeOwner
.
h
"
#
include
"
nsIBaseWindow
.
h
"
#
include
"
nsPIDOMWindow
.
h
"
#
include
"
mozilla
/
MouseEvents
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsMenuPopupFrame
.
h
"
#
include
"
nsIScreenManager
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
mozilla
/
dom
/
MouseEventBinding
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsICSSDeclaration
.
h
"
#
include
"
nsStyledElement
.
h
"
#
include
<
algorithm
>
using
namespace
mozilla
;
nsIFrame
*
NS_NewResizerFrame
(
nsIPresShell
*
aPresShell
ComputedStyle
*
aStyle
)
{
return
new
(
aPresShell
)
nsResizerFrame
(
aStyle
aPresShell
-
>
GetPresContext
(
)
)
;
}
NS_IMPL_FRAMEARENA_HELPERS
(
nsResizerFrame
)
nsResizerFrame
:
:
nsResizerFrame
(
ComputedStyle
*
aStyle
nsPresContext
*
aPresContext
)
:
nsTitleBarFrame
(
aStyle
aPresContext
kClassID
)
{
}
nsresult
nsResizerFrame
:
:
HandleEvent
(
nsPresContext
*
aPresContext
WidgetGUIEvent
*
aEvent
nsEventStatus
*
aEventStatus
)
{
NS_ENSURE_ARG_POINTER
(
aEventStatus
)
;
if
(
nsEventStatus_eConsumeNoDefault
=
=
*
aEventStatus
)
{
return
NS_OK
;
}
AutoWeakFrame
weakFrame
(
this
)
;
bool
doDefault
=
true
;
switch
(
aEvent
-
>
mMessage
)
{
case
eTouchStart
:
case
eMouseDown
:
{
if
(
aEvent
-
>
mClass
=
=
eTouchEventClass
|
|
(
aEvent
-
>
mClass
=
=
eMouseEventClass
&
&
aEvent
-
>
AsMouseEvent
(
)
-
>
button
=
=
WidgetMouseEvent
:
:
eLeftButton
)
)
{
nsCOMPtr
<
nsIBaseWindow
>
window
;
nsIPresShell
*
presShell
=
aPresContext
-
>
GetPresShell
(
)
;
nsIContent
*
contentToResize
=
GetContentToResize
(
presShell
getter_AddRefs
(
window
)
)
;
if
(
contentToResize
)
{
nsIFrame
*
frameToResize
=
contentToResize
-
>
GetPrimaryFrame
(
)
;
if
(
!
frameToResize
)
break
;
nsRect
rect
=
frameToResize
-
>
GetScreenRectInAppUnits
(
)
;
if
(
frameToResize
-
>
StylePosition
(
)
-
>
mBoxSizing
=
=
StyleBoxSizing
:
:
Content
)
{
rect
.
Deflate
(
frameToResize
-
>
GetUsedBorderAndPadding
(
)
)
;
}
mMouseDownRect
=
LayoutDeviceIntRect
:
:
FromAppUnitsToNearest
(
rect
aPresContext
-
>
AppUnitsPerDevPixel
(
)
)
;
doDefault
=
false
;
}
else
{
if
(
!
window
)
break
;
doDefault
=
false
;
Direction
direction
=
GetDirection
(
)
;
nsresult
rv
=
aEvent
-
>
mWidget
-
>
BeginResizeDrag
(
aEvent
direction
.
mHorizontal
direction
.
mVertical
)
;
if
(
rv
!
=
NS_ERROR_NOT_IMPLEMENTED
)
break
;
window
-
>
GetPositionAndSize
(
&
mMouseDownRect
.
x
&
mMouseDownRect
.
y
&
mMouseDownRect
.
width
&
mMouseDownRect
.
height
)
;
}
LayoutDeviceIntPoint
refPoint
;
if
(
!
GetEventPoint
(
aEvent
refPoint
)
)
return
NS_OK
;
mMouseDownPoint
=
refPoint
+
aEvent
-
>
mWidget
-
>
WidgetToScreenOffset
(
)
;
mTrackingMouseMove
=
true
;
nsIPresShell
:
:
SetCapturingContent
(
GetContent
(
)
CAPTURE_IGNOREALLOWED
)
;
}
}
break
;
case
eTouchEnd
:
case
eMouseUp
:
{
if
(
aEvent
-
>
mClass
=
=
eTouchEventClass
|
|
(
aEvent
-
>
mClass
=
=
eMouseEventClass
&
&
aEvent
-
>
AsMouseEvent
(
)
-
>
button
=
=
WidgetMouseEvent
:
:
eLeftButton
)
)
{
mTrackingMouseMove
=
false
;
nsIPresShell
:
:
SetCapturingContent
(
nullptr
0
)
;
doDefault
=
false
;
}
}
break
;
case
eTouchMove
:
case
eMouseMove
:
{
if
(
mTrackingMouseMove
)
{
nsCOMPtr
<
nsIBaseWindow
>
window
;
nsIPresShell
*
presShell
=
aPresContext
-
>
GetPresShell
(
)
;
nsCOMPtr
<
nsIContent
>
contentToResize
=
GetContentToResize
(
presShell
getter_AddRefs
(
window
)
)
;
nsMenuPopupFrame
*
menuPopupFrame
=
nullptr
;
if
(
contentToResize
)
{
menuPopupFrame
=
do_QueryFrame
(
contentToResize
-
>
GetPrimaryFrame
(
)
)
;
}
LayoutDeviceIntPoint
refPoint
;
if
(
!
GetEventPoint
(
aEvent
refPoint
)
)
return
NS_OK
;
LayoutDeviceIntPoint
screenPoint
=
refPoint
+
aEvent
-
>
mWidget
-
>
WidgetToScreenOffset
(
)
;
LayoutDeviceIntPoint
mouseMove
(
screenPoint
-
mMouseDownPoint
)
;
Direction
direction
=
GetDirection
(
)
;
if
(
window
|
|
menuPopupFrame
)
{
if
(
menuPopupFrame
)
{
menuPopupFrame
-
>
CanAdjustEdges
(
(
direction
.
mHorizontal
=
=
-
1
)
?
eSideLeft
:
eSideRight
(
direction
.
mVertical
=
=
-
1
)
?
eSideTop
:
eSideBottom
mouseMove
)
;
}
}
else
if
(
!
contentToResize
)
{
break
;
}
LayoutDeviceIntRect
rect
=
mMouseDownRect
;
widget
:
:
SizeConstraints
sizeConstraints
;
if
(
window
)
{
nsCOMPtr
<
nsIWidget
>
widget
;
window
-
>
GetMainWidget
(
getter_AddRefs
(
widget
)
)
;
sizeConstraints
=
widget
-
>
GetSizeConstraints
(
)
;
}
AdjustDimensions
(
&
rect
.
x
&
rect
.
width
sizeConstraints
.
mMinSize
.
width
sizeConstraints
.
mMaxSize
.
width
mouseMove
.
x
direction
.
mHorizontal
)
;
AdjustDimensions
(
&
rect
.
y
&
rect
.
height
sizeConstraints
.
mMinSize
.
height
sizeConstraints
.
mMaxSize
.
height
mouseMove
.
y
direction
.
mVertical
)
;
if
(
window
)
{
nsCOMPtr
<
nsIScreen
>
screen
;
nsCOMPtr
<
nsIScreenManager
>
sm
(
do_GetService
(
"
mozilla
.
org
/
gfx
/
screenmanager
;
1
"
)
)
;
if
(
sm
)
{
CSSIntRect
frameRect
=
GetScreenRect
(
)
;
double
scale
;
window
-
>
GetUnscaledDevicePixelsPerCSSPixel
(
&
scale
)
;
sm
-
>
ScreenForRect
(
NSToIntRound
(
frameRect
.
x
/
scale
)
NSToIntRound
(
frameRect
.
y
/
scale
)
1
1
getter_AddRefs
(
screen
)
)
;
if
(
screen
)
{
LayoutDeviceIntRect
screenRect
;
screen
-
>
GetRect
(
&
screenRect
.
x
&
screenRect
.
y
&
screenRect
.
width
&
screenRect
.
height
)
;
rect
.
IntersectRect
(
rect
screenRect
)
;
}
}
}
else
if
(
menuPopupFrame
)
{
nsRect
frameRect
=
menuPopupFrame
-
>
GetScreenRectInAppUnits
(
)
;
nsIFrame
*
rootFrame
=
aPresContext
-
>
PresShell
(
)
-
>
GetRootFrame
(
)
;
nsRect
rootScreenRect
=
rootFrame
-
>
GetScreenRectInAppUnits
(
)
;
nsPopupLevel
popupLevel
=
menuPopupFrame
-
>
PopupLevel
(
)
;
int32_t
appPerDev
=
aPresContext
-
>
AppUnitsPerDevPixel
(
)
;
LayoutDeviceIntRect
screenRect
=
menuPopupFrame
-
>
GetConstraintRect
(
LayoutDeviceIntRect
:
:
FromAppUnitsToNearest
(
frameRect
appPerDev
)
LayoutDeviceIntRect
:
:
FromAppUnitsToInside
(
rootScreenRect
appPerDev
)
popupLevel
)
;
rect
.
IntersectRect
(
rect
screenRect
)
;
}
if
(
contentToResize
)
{
nsRect
appUnitsRect
=
ToAppUnits
(
rect
.
ToUnknownRect
(
)
aPresContext
-
>
AppUnitsPerDevPixel
(
)
)
;
if
(
appUnitsRect
.
width
<
mRect
.
width
&
&
mouseMove
.
x
)
appUnitsRect
.
width
=
mRect
.
width
;
if
(
appUnitsRect
.
height
<
mRect
.
height
&
&
mouseMove
.
y
)
appUnitsRect
.
height
=
mRect
.
height
;
nsIntRect
cssRect
=
appUnitsRect
.
ToInsidePixels
(
AppUnitsPerCSSPixel
(
)
)
;
LayoutDeviceIntRect
oldRect
;
AutoWeakFrame
weakFrame
(
menuPopupFrame
)
;
if
(
menuPopupFrame
)
{
nsCOMPtr
<
nsIWidget
>
widget
=
menuPopupFrame
-
>
GetWidget
(
)
;
if
(
widget
)
oldRect
=
widget
-
>
GetScreenBounds
(
)
;
LayoutDeviceIntPoint
clientOffset
=
widget
-
>
GetClientOffset
(
)
;
rect
.
x
-
=
clientOffset
.
x
;
rect
.
y
-
=
clientOffset
.
y
;
}
SizeInfo
sizeInfo
originalSizeInfo
;
sizeInfo
.
width
.
AppendInt
(
cssRect
.
width
)
;
sizeInfo
.
height
.
AppendInt
(
cssRect
.
height
)
;
ResizeContent
(
contentToResize
direction
sizeInfo
&
originalSizeInfo
)
;
MaybePersistOriginalSize
(
contentToResize
originalSizeInfo
)
;
if
(
weakFrame
.
IsAlive
(
)
&
&
(
oldRect
.
x
!
=
rect
.
x
|
|
oldRect
.
y
!
=
rect
.
y
)
&
&
(
!
menuPopupFrame
-
>
IsAnchored
(
)
|
|
menuPopupFrame
-
>
PopupLevel
(
)
!
=
ePopupLevelParent
)
)
{
CSSPoint
cssPos
=
rect
.
TopLeft
(
)
/
aPresContext
-
>
CSSToDevPixelScale
(
)
;
menuPopupFrame
-
>
MoveTo
(
RoundedToInt
(
cssPos
)
true
)
;
}
}
else
{
window
-
>
SetPositionAndSize
(
rect
.
x
rect
.
y
rect
.
width
rect
.
height
nsIBaseWindow
:
:
eRepaint
)
;
}
doDefault
=
false
;
}
}
break
;
case
eMouseClick
:
{
WidgetMouseEvent
*
mouseEvent
=
aEvent
-
>
AsMouseEvent
(
)
;
if
(
mouseEvent
-
>
IsLeftClickEvent
(
)
)
{
MouseClicked
(
mouseEvent
)
;
}
break
;
}
case
eMouseDoubleClick
:
if
(
aEvent
-
>
AsMouseEvent
(
)
-
>
button
=
=
WidgetMouseEvent
:
:
eLeftButton
)
{
nsCOMPtr
<
nsIBaseWindow
>
window
;
nsIPresShell
*
presShell
=
aPresContext
-
>
GetPresShell
(
)
;
nsIContent
*
contentToResize
=
GetContentToResize
(
presShell
getter_AddRefs
(
window
)
)
;
if
(
contentToResize
)
{
nsMenuPopupFrame
*
menuPopupFrame
=
do_QueryFrame
(
contentToResize
-
>
GetPrimaryFrame
(
)
)
;
if
(
menuPopupFrame
)
break
;
RestoreOriginalSize
(
contentToResize
)
;
}
}
break
;
default
:
break
;
}
if
(
!
doDefault
)
*
aEventStatus
=
nsEventStatus_eConsumeNoDefault
;
if
(
doDefault
&
&
weakFrame
.
IsAlive
(
)
)
return
nsTitleBarFrame
:
:
HandleEvent
(
aPresContext
aEvent
aEventStatus
)
;
return
NS_OK
;
}
nsIContent
*
nsResizerFrame
:
:
GetContentToResize
(
nsIPresShell
*
aPresShell
nsIBaseWindow
*
*
aWindow
)
{
*
aWindow
=
nullptr
;
nsAutoString
elementid
;
mContent
-
>
AsElement
(
)
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
element
elementid
)
;
if
(
elementid
.
IsEmpty
(
)
)
{
nsIFrame
*
popup
=
GetParent
(
)
;
while
(
popup
)
{
nsMenuPopupFrame
*
popupFrame
=
do_QueryFrame
(
popup
)
;
if
(
popupFrame
)
{
return
popupFrame
-
>
GetContent
(
)
;
}
popup
=
popup
-
>
GetParent
(
)
;
}
nsCOMPtr
<
nsIDocShellTreeItem
>
dsti
=
aPresShell
-
>
GetPresContext
(
)
-
>
GetDocShell
(
)
;
if
(
!
dsti
|
|
dsti
-
>
ItemType
(
)
!
=
nsIDocShellTreeItem
:
:
typeChrome
)
{
nsIContent
*
nonNativeAnon
=
mContent
-
>
FindFirstNonChromeOnlyAccessContent
(
)
;
if
(
!
nonNativeAnon
|
|
nonNativeAnon
-
>
GetParent
(
)
)
{
return
nullptr
;
}
}
if
(
nsPIDOMWindowOuter
*
domWindow
=
aPresShell
-
>
GetDocument
(
)
-
>
GetWindow
(
)
)
{
nsCOMPtr
<
nsIDocShell
>
docShell
=
domWindow
-
>
GetDocShell
(
)
;
if
(
docShell
)
{
nsCOMPtr
<
nsIDocShellTreeOwner
>
treeOwner
;
docShell
-
>
GetTreeOwner
(
getter_AddRefs
(
treeOwner
)
)
;
if
(
treeOwner
)
{
CallQueryInterface
(
treeOwner
aWindow
)
;
}
}
}
return
nullptr
;
}
if
(
elementid
.
EqualsLiteral
(
"
_parent
"
)
)
{
nsIContent
*
parent
=
mContent
-
>
GetParent
(
)
;
return
parent
?
parent
-
>
FindFirstNonChromeOnlyAccessContent
(
)
:
nullptr
;
}
return
aPresShell
-
>
GetDocument
(
)
-
>
GetElementById
(
elementid
)
;
}
void
nsResizerFrame
:
:
AdjustDimensions
(
int32_t
*
aPos
int32_t
*
aSize
int32_t
aMinSize
int32_t
aMaxSize
int32_t
aMovement
int8_t
aResizerDirection
)
{
int32_t
oldSize
=
*
aSize
;
*
aSize
+
=
aResizerDirection
*
aMovement
;
if
(
*
aSize
<
1
)
*
aSize
=
1
;
*
aSize
=
std
:
:
max
(
aMinSize
std
:
:
min
(
aMaxSize
*
aSize
)
)
;
if
(
aResizerDirection
=
=
-
1
)
*
aPos
+
=
oldSize
-
*
aSize
;
}
void
nsResizerFrame
:
:
ResizeContent
(
nsIContent
*
aContent
const
Direction
&
aDirection
const
SizeInfo
&
aSizeInfo
SizeInfo
*
aOriginalSizeInfo
)
{
if
(
aContent
-
>
IsXULElement
(
)
)
{
if
(
aOriginalSizeInfo
)
{
aContent
-
>
AsElement
(
)
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
width
aOriginalSizeInfo
-
>
width
)
;
aContent
-
>
AsElement
(
)
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
height
aOriginalSizeInfo
-
>
height
)
;
}
if
(
aDirection
.
mHorizontal
)
{
aContent
-
>
AsElement
(
)
-
>
SetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
width
aSizeInfo
.
width
true
)
;
}
if
(
aDirection
.
mVertical
)
{
aContent
-
>
AsElement
(
)
-
>
SetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
height
aSizeInfo
.
height
true
)
;
}
}
else
{
nsCOMPtr
<
nsStyledElement
>
inlineStyleContent
=
do_QueryInterface
(
aContent
)
;
if
(
inlineStyleContent
)
{
nsICSSDeclaration
*
decl
=
inlineStyleContent
-
>
Style
(
)
;
if
(
aOriginalSizeInfo
)
{
decl
-
>
GetPropertyValue
(
NS_LITERAL_STRING
(
"
width
"
)
aOriginalSizeInfo
-
>
width
)
;
decl
-
>
GetPropertyValue
(
NS_LITERAL_STRING
(
"
height
"
)
aOriginalSizeInfo
-
>
height
)
;
}
if
(
aDirection
.
mHorizontal
)
{
nsAutoString
widthstr
(
aSizeInfo
.
width
)
;
if
(
!
widthstr
.
IsEmpty
(
)
&
&
!
Substring
(
widthstr
widthstr
.
Length
(
)
-
2
2
)
.
EqualsLiteral
(
"
px
"
)
)
widthstr
.
AppendLiteral
(
"
px
"
)
;
decl
-
>
SetProperty
(
NS_LITERAL_STRING
(
"
width
"
)
widthstr
EmptyString
(
)
)
;
}
if
(
aDirection
.
mVertical
)
{
nsAutoString
heightstr
(
aSizeInfo
.
height
)
;
if
(
!
heightstr
.
IsEmpty
(
)
&
&
!
Substring
(
heightstr
heightstr
.
Length
(
)
-
2
2
)
.
EqualsLiteral
(
"
px
"
)
)
heightstr
.
AppendLiteral
(
"
px
"
)
;
decl
-
>
SetProperty
(
NS_LITERAL_STRING
(
"
height
"
)
heightstr
EmptyString
(
)
)
;
}
}
}
}
void
nsResizerFrame
:
:
MaybePersistOriginalSize
(
nsIContent
*
aContent
const
SizeInfo
&
aSizeInfo
)
{
nsresult
rv
;
aContent
-
>
GetProperty
(
nsGkAtoms
:
:
_moz_original_size
&
rv
)
;
if
(
rv
!
=
NS_PROPTABLE_PROP_NOT_THERE
)
return
;
nsAutoPtr
<
SizeInfo
>
sizeInfo
(
new
SizeInfo
(
aSizeInfo
)
)
;
rv
=
aContent
-
>
SetProperty
(
nsGkAtoms
:
:
_moz_original_size
sizeInfo
.
get
(
)
nsINode
:
:
DeleteProperty
<
nsResizerFrame
:
:
SizeInfo
>
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
sizeInfo
.
forget
(
)
;
}
void
nsResizerFrame
:
:
RestoreOriginalSize
(
nsIContent
*
aContent
)
{
nsresult
rv
;
SizeInfo
*
sizeInfo
=
static_cast
<
SizeInfo
*
>
(
aContent
-
>
GetProperty
(
nsGkAtoms
:
:
_moz_original_size
&
rv
)
)
;
if
(
NS_FAILED
(
rv
)
)
return
;
NS_ASSERTION
(
sizeInfo
"
We
set
a
null
sizeInfo
!
?
"
)
;
Direction
direction
=
{
1
1
}
;
ResizeContent
(
aContent
direction
*
sizeInfo
nullptr
)
;
aContent
-
>
DeleteProperty
(
nsGkAtoms
:
:
_moz_original_size
)
;
}
nsResizerFrame
:
:
Direction
nsResizerFrame
:
:
GetDirection
(
)
{
static
const
Element
:
:
AttrValuesArray
strings
[
]
=
{
nsGkAtoms
:
:
topleft
nsGkAtoms
:
:
top
nsGkAtoms
:
:
topright
nsGkAtoms
:
:
left
nsGkAtoms
:
:
right
nsGkAtoms
:
:
bottomleft
nsGkAtoms
:
:
bottom
nsGkAtoms
:
:
bottomright
nsGkAtoms
:
:
bottomstart
nsGkAtoms
:
:
bottomend
nullptr
}
;
static
const
Direction
directions
[
]
=
{
{
-
1
-
1
}
{
0
-
1
}
{
1
-
1
}
{
-
1
0
}
{
1
0
}
{
-
1
1
}
{
0
1
}
{
1
1
}
{
-
1
1
}
{
1
1
}
}
;
if
(
!
GetContent
(
)
)
{
return
directions
[
0
]
;
}
int32_t
index
=
mContent
-
>
AsElement
(
)
-
>
FindAttrValueIn
(
kNameSpaceID_None
nsGkAtoms
:
:
dir
strings
eCaseMatters
)
;
if
(
index
<
0
)
{
return
directions
[
0
]
;
}
if
(
index
>
=
8
)
{
WritingMode
wm
=
GetWritingMode
(
)
;
if
(
!
(
wm
.
IsVertical
(
)
?
wm
.
IsVerticalLR
(
)
:
wm
.
IsBidiLTR
(
)
)
)
{
Direction
direction
=
directions
[
index
]
;
direction
.
mHorizontal
*
=
-
1
;
return
direction
;
}
}
return
directions
[
index
]
;
}
void
nsResizerFrame
:
:
MouseClicked
(
WidgetMouseEvent
*
aEvent
)
{
nsContentUtils
:
:
DispatchXULCommand
(
mContent
false
nullptr
nullptr
aEvent
-
>
IsControl
(
)
aEvent
-
>
IsAlt
(
)
aEvent
-
>
IsShift
(
)
aEvent
-
>
IsMeta
(
)
aEvent
-
>
inputSource
)
;
}
