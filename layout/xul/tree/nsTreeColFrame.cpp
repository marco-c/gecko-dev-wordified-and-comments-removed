#
include
"
nsCOMPtr
.
h
"
#
include
"
nsTreeColFrame
.
h
"
#
include
"
nsGkAtoms
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
mozilla
/
ComputedStyle
.
h
"
#
include
"
nsNameSpaceManager
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
nsTreeColumns
.
h
"
#
include
"
nsDisplayList
.
h
"
#
include
"
nsTreeBodyFrame
.
h
"
#
include
"
nsXULElement
.
h
"
#
include
"
mozilla
/
dom
/
XULTreeElement
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
nsIFrame
*
NS_NewTreeColFrame
(
nsIPresShell
*
aPresShell
ComputedStyle
*
aStyle
)
{
return
new
(
aPresShell
)
nsTreeColFrame
(
aStyle
aPresShell
-
>
GetPresContext
(
)
)
;
}
NS_IMPL_FRAMEARENA_HELPERS
(
nsTreeColFrame
)
nsTreeColFrame
:
:
~
nsTreeColFrame
(
)
{
}
void
nsTreeColFrame
:
:
Init
(
nsIContent
*
aContent
nsContainerFrame
*
aParent
nsIFrame
*
aPrevInFlow
)
{
nsBoxFrame
:
:
Init
(
aContent
aParent
aPrevInFlow
)
;
InvalidateColumns
(
)
;
}
void
nsTreeColFrame
:
:
DestroyFrom
(
nsIFrame
*
aDestructRoot
PostDestroyData
&
aPostDestroyData
)
{
InvalidateColumns
(
false
)
;
nsBoxFrame
:
:
DestroyFrom
(
aDestructRoot
aPostDestroyData
)
;
}
class
nsDisplayXULTreeColSplitterTarget
final
:
public
nsDisplayItem
{
public
:
nsDisplayXULTreeColSplitterTarget
(
nsDisplayListBuilder
*
aBuilder
nsIFrame
*
aFrame
)
:
nsDisplayItem
(
aBuilder
aFrame
)
{
MOZ_COUNT_CTOR
(
nsDisplayXULTreeColSplitterTarget
)
;
}
#
ifdef
NS_BUILD_REFCNT_LOGGING
virtual
~
nsDisplayXULTreeColSplitterTarget
(
)
{
MOZ_COUNT_DTOR
(
nsDisplayXULTreeColSplitterTarget
)
;
}
#
endif
virtual
void
HitTest
(
nsDisplayListBuilder
*
aBuilder
const
nsRect
&
aRect
HitTestState
*
aState
nsTArray
<
nsIFrame
*
>
*
aOutFrames
)
override
;
NS_DISPLAY_DECL_NAME
(
"
XULTreeColSplitterTarget
"
TYPE_XUL_TREE_COL_SPLITTER_TARGET
)
}
;
void
nsDisplayXULTreeColSplitterTarget
:
:
HitTest
(
nsDisplayListBuilder
*
aBuilder
const
nsRect
&
aRect
HitTestState
*
aState
nsTArray
<
nsIFrame
*
>
*
aOutFrames
)
{
nsRect
rect
=
aRect
-
ToReferenceFrame
(
)
;
bool
left
=
false
;
bool
right
=
false
;
if
(
mFrame
-
>
GetSize
(
)
.
width
-
nsPresContext
:
:
CSSPixelsToAppUnits
(
4
)
<
=
rect
.
XMost
(
)
)
{
right
=
true
;
}
else
if
(
nsPresContext
:
:
CSSPixelsToAppUnits
(
4
)
>
rect
.
x
)
{
left
=
true
;
}
if
(
mFrame
-
>
StyleVisibility
(
)
-
>
mDirection
=
=
NS_STYLE_DIRECTION_RTL
)
{
bool
tmp
=
left
;
left
=
right
;
right
=
tmp
;
}
if
(
left
|
|
right
)
{
nsIFrame
*
child
;
if
(
left
)
child
=
mFrame
-
>
GetPrevSibling
(
)
;
else
child
=
mFrame
-
>
GetNextSibling
(
)
;
if
(
child
&
&
child
-
>
GetContent
(
)
-
>
NodeInfo
(
)
-
>
Equals
(
nsGkAtoms
:
:
splitter
kNameSpaceID_XUL
)
)
{
aOutFrames
-
>
AppendElement
(
child
)
;
}
}
}
void
nsTreeColFrame
:
:
BuildDisplayListForChildren
(
nsDisplayListBuilder
*
aBuilder
const
nsDisplayListSet
&
aLists
)
{
if
(
!
aBuilder
-
>
IsForEventDelivery
(
)
)
{
nsBoxFrame
:
:
BuildDisplayListForChildren
(
aBuilder
aLists
)
;
return
;
}
nsDisplayListCollection
set
(
aBuilder
)
;
nsBoxFrame
:
:
BuildDisplayListForChildren
(
aBuilder
set
)
;
WrapListsInRedirector
(
aBuilder
set
aLists
)
;
aLists
.
Content
(
)
-
>
AppendToTop
(
MakeDisplayItem
<
nsDisplayXULTreeColSplitterTarget
>
(
aBuilder
this
)
)
;
}
nsresult
nsTreeColFrame
:
:
AttributeChanged
(
int32_t
aNameSpaceID
nsAtom
*
aAttribute
int32_t
aModType
)
{
nsresult
rv
=
nsBoxFrame
:
:
AttributeChanged
(
aNameSpaceID
aAttribute
aModType
)
;
if
(
aAttribute
=
=
nsGkAtoms
:
:
ordinal
|
|
aAttribute
=
=
nsGkAtoms
:
:
primary
)
{
InvalidateColumns
(
)
;
}
return
rv
;
}
void
nsTreeColFrame
:
:
SetXULBounds
(
nsBoxLayoutState
&
aBoxLayoutState
const
nsRect
&
aRect
bool
aRemoveOverflowArea
)
{
nscoord
oldWidth
=
mRect
.
width
;
nsBoxFrame
:
:
SetXULBounds
(
aBoxLayoutState
aRect
aRemoveOverflowArea
)
;
if
(
mRect
.
width
!
=
oldWidth
)
{
RefPtr
<
XULTreeElement
>
tree
=
GetTree
(
)
;
if
(
tree
)
{
tree
-
>
Invalidate
(
)
;
}
}
}
XULTreeElement
*
nsTreeColFrame
:
:
GetTree
(
)
{
nsIContent
*
parent
=
mContent
-
>
GetParent
(
)
;
return
parent
?
XULTreeElement
:
:
FromNodeOrNull
(
parent
-
>
GetParent
(
)
)
:
nullptr
;
}
void
nsTreeColFrame
:
:
InvalidateColumns
(
bool
aCanWalkFrameTree
)
{
RefPtr
<
XULTreeElement
>
tree
=
GetTree
(
)
;
if
(
!
tree
)
{
return
;
}
nsTreeBodyFrame
*
body
=
aCanWalkFrameTree
?
tree
-
>
GetTreeBodyFrame
(
FlushType
:
:
None
)
:
tree
-
>
GetCachedTreeBodyFrame
(
)
;
if
(
!
body
)
{
return
;
}
RefPtr
<
nsTreeColumns
>
columns
=
body
-
>
Columns
(
)
;
if
(
!
columns
)
{
return
;
}
columns
-
>
InvalidateColumns
(
)
;
}
