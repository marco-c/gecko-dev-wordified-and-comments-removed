#
include
"
nsHTMLCSSStyleSheet
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
css
/
StyleRule
.
h
"
#
include
"
nsIStyleRuleProcessor
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsRuleWalker
.
h
"
#
include
"
nsRuleProcessorData
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
nsAttrValue
.
h
"
#
include
"
nsAttrValueInlines
.
h
"
#
include
"
nsCSSPseudoElements
.
h
"
#
include
"
mozilla
/
RestyleManagerHandle
.
h
"
#
include
"
mozilla
/
RestyleManagerHandleInlines
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
nsHTMLCSSStyleSheet
:
:
nsHTMLCSSStyleSheet
(
)
{
}
nsHTMLCSSStyleSheet
:
:
~
nsHTMLCSSStyleSheet
(
)
{
for
(
auto
iter
=
mCachedStyleAttrs
.
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
MiscContainer
*
&
value
=
iter
.
Data
(
)
;
switch
(
value
-
>
mType
)
{
case
nsAttrValue
:
:
eGeckoCSSDeclaration
:
{
css
:
:
Declaration
*
declaration
=
value
-
>
mValue
.
mGeckoCSSDeclaration
;
declaration
-
>
SetHTMLCSSStyleSheet
(
nullptr
)
;
break
;
}
case
nsAttrValue
:
:
eServoCSSDeclaration
:
{
RawServoDeclarationBlock
*
declarations
=
value
-
>
mValue
.
mServoCSSDeclaration
;
Servo_DeclarationBlock_ClearCachePointer
(
declarations
)
;
break
;
}
default
:
MOZ_ASSERT_UNREACHABLE
(
"
unexpected
cached
nsAttrValue
type
"
)
;
break
;
}
value
-
>
mValue
.
mCached
=
0
;
iter
.
Remove
(
)
;
}
}
NS_IMPL_ISUPPORTS
(
nsHTMLCSSStyleSheet
nsIStyleRuleProcessor
)
void
nsHTMLCSSStyleSheet
:
:
RulesMatching
(
ElementRuleProcessorData
*
aData
)
{
ElementRulesMatching
(
aData
-
>
mPresContext
aData
-
>
mElement
aData
-
>
mRuleWalker
)
;
}
void
nsHTMLCSSStyleSheet
:
:
ElementRulesMatching
(
nsPresContext
*
aPresContext
Element
*
aElement
nsRuleWalker
*
aRuleWalker
)
{
css
:
:
Declaration
*
declaration
=
aElement
-
>
GetInlineStyleDeclaration
(
)
;
if
(
declaration
)
{
declaration
-
>
SetImmutable
(
)
;
aRuleWalker
-
>
Forward
(
declaration
)
;
}
declaration
=
aElement
-
>
GetSMILOverrideStyleDeclaration
(
)
;
if
(
declaration
)
{
MOZ_ASSERT
(
aPresContext
-
>
RestyleManager
(
)
-
>
IsGecko
(
)
"
stylo
:
ElementRulesMatching
must
not
be
called
when
we
have
"
"
a
Servo
-
backed
style
system
"
)
;
RestyleManager
*
restyleManager
=
aPresContext
-
>
RestyleManager
(
)
-
>
AsGecko
(
)
;
if
(
!
restyleManager
-
>
SkipAnimationRules
(
)
)
{
declaration
-
>
SetImmutable
(
)
;
aRuleWalker
-
>
Forward
(
declaration
)
;
}
}
}
void
nsHTMLCSSStyleSheet
:
:
PseudoElementRulesMatching
(
Element
*
aPseudoElement
CSSPseudoElementType
aPseudoType
nsRuleWalker
*
aRuleWalker
)
{
MOZ_ASSERT
(
nsCSSPseudoElements
:
:
PseudoElementSupportsStyleAttribute
(
aPseudoType
)
)
;
MOZ_ASSERT
(
aPseudoElement
)
;
css
:
:
Declaration
*
declaration
=
aPseudoElement
-
>
GetInlineStyleDeclaration
(
)
;
if
(
declaration
)
{
declaration
-
>
SetImmutable
(
)
;
aRuleWalker
-
>
Forward
(
declaration
)
;
}
}
void
nsHTMLCSSStyleSheet
:
:
RulesMatching
(
PseudoElementRuleProcessorData
*
aData
)
{
if
(
nsCSSPseudoElements
:
:
PseudoElementSupportsStyleAttribute
(
aData
-
>
mPseudoType
)
&
&
aData
-
>
mPseudoElement
)
{
PseudoElementRulesMatching
(
aData
-
>
mPseudoElement
aData
-
>
mPseudoType
aData
-
>
mRuleWalker
)
;
}
}
void
nsHTMLCSSStyleSheet
:
:
RulesMatching
(
AnonBoxRuleProcessorData
*
aData
)
{
}
#
ifdef
MOZ_XUL
void
nsHTMLCSSStyleSheet
:
:
RulesMatching
(
XULTreeRuleProcessorData
*
aData
)
{
}
#
endif
nsRestyleHint
nsHTMLCSSStyleSheet
:
:
HasStateDependentStyle
(
StateRuleProcessorData
*
aData
)
{
return
nsRestyleHint
(
0
)
;
}
nsRestyleHint
nsHTMLCSSStyleSheet
:
:
HasStateDependentStyle
(
PseudoElementStateRuleProcessorData
*
aData
)
{
return
nsRestyleHint
(
0
)
;
}
bool
nsHTMLCSSStyleSheet
:
:
HasDocumentStateDependentStyle
(
StateRuleProcessorData
*
aData
)
{
return
false
;
}
nsRestyleHint
nsHTMLCSSStyleSheet
:
:
HasAttributeDependentStyle
(
AttributeRuleProcessorData
*
aData
RestyleHintData
&
aRestyleHintDataResult
)
{
if
(
aData
-
>
mAttrHasChanged
&
&
aData
-
>
mAttribute
=
=
nsGkAtoms
:
:
style
)
{
return
eRestyle_StyleAttribute
;
}
return
nsRestyleHint
(
0
)
;
}
bool
nsHTMLCSSStyleSheet
:
:
MediumFeaturesChanged
(
nsPresContext
*
aPresContext
)
{
return
false
;
}
size_t
nsHTMLCSSStyleSheet
:
:
SizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
{
size_t
n
=
0
;
n
+
=
mCachedStyleAttrs
.
ShallowSizeOfExcludingThis
(
aMallocSizeOf
)
;
for
(
auto
iter
=
mCachedStyleAttrs
.
ConstIter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
n
+
=
iter
.
Key
(
)
.
SizeOfExcludingThisIfUnshared
(
aMallocSizeOf
)
;
}
return
n
;
}
size_t
nsHTMLCSSStyleSheet
:
:
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
{
return
aMallocSizeOf
(
this
)
+
SizeOfExcludingThis
(
aMallocSizeOf
)
;
}
void
nsHTMLCSSStyleSheet
:
:
CacheStyleAttr
(
const
nsAString
&
aSerialized
MiscContainer
*
aValue
)
{
mCachedStyleAttrs
.
Put
(
aSerialized
aValue
)
;
}
void
nsHTMLCSSStyleSheet
:
:
EvictStyleAttr
(
const
nsAString
&
aSerialized
MiscContainer
*
aValue
)
{
#
ifdef
DEBUG
{
NS_ASSERTION
(
aValue
=
=
mCachedStyleAttrs
.
Get
(
aSerialized
)
"
Cached
value
does
not
match
?
!
"
)
;
}
#
endif
mCachedStyleAttrs
.
Remove
(
aSerialized
)
;
}
MiscContainer
*
nsHTMLCSSStyleSheet
:
:
LookupStyleAttr
(
const
nsAString
&
aSerialized
)
{
return
mCachedStyleAttrs
.
Get
(
aSerialized
)
;
}
