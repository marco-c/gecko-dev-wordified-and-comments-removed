#
ifndef
mozilla_dom_FontFaceImpl_h
#
define
mozilla_dom_FontFaceImpl_h
#
include
"
mozilla
/
dom
/
FontFaceBinding
.
h
"
#
include
"
mozilla
/
FontPropertyTypes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
ServoStyleConsts
.
h
"
#
include
"
gfxUserFontSet
.
h
"
#
include
"
nsCSSPropertyID
.
h
"
#
include
"
nsCSSValue
.
h
"
class
gfxFontFaceBufferSource
;
struct
RawServoFontFaceRule
;
namespace
mozilla
{
struct
CSSFontFaceDescriptors
;
class
PostTraversalTask
;
namespace
dom
{
class
CSSFontFaceRule
;
class
FontFace
;
class
FontFaceBufferSource
;
struct
FontFaceDescriptors
;
class
FontFaceSetImpl
;
class
UTF8StringOrArrayBufferOrArrayBufferView
;
}
}
namespace
mozilla
:
:
dom
{
class
FontFaceImpl
final
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
FontFaceImpl
)
friend
class
mozilla
:
:
PostTraversalTask
;
friend
class
FontFaceBufferSource
;
friend
class
Entry
;
public
:
class
Entry
final
:
public
gfxUserFontEntry
{
friend
class
FontFaceImpl
;
public
:
Entry
(
gfxUserFontSet
*
aFontSet
const
nsTArray
<
gfxFontFaceSrc
>
&
aFontFaceSrcList
WeightRange
aWeight
StretchRange
aStretch
SlantStyleRange
aStyle
const
nsTArray
<
gfxFontFeature
>
&
aFeatureSettings
const
nsTArray
<
gfxFontVariation
>
&
aVariationSettings
uint32_t
aLanguageOverride
gfxCharacterMap
*
aUnicodeRanges
StyleFontDisplay
aFontDisplay
RangeFlags
aRangeFlags
float
aAscentOverride
float
aDescentOverride
float
aLineGapOverride
float
aSizeAdjust
)
:
gfxUserFontEntry
(
aFontSet
aFontFaceSrcList
aWeight
aStretch
aStyle
aFeatureSettings
aVariationSettings
aLanguageOverride
aUnicodeRanges
aFontDisplay
aRangeFlags
aAscentOverride
aDescentOverride
aLineGapOverride
aSizeAdjust
)
{
}
virtual
void
SetLoadState
(
UserFontLoadState
aLoadState
)
override
;
virtual
void
GetUserFontSets
(
nsTArray
<
gfxUserFontSet
*
>
&
aResult
)
override
;
const
AutoTArray
<
FontFaceImpl
*
1
>
&
GetFontFaces
(
)
{
return
mFontFaces
;
}
protected
:
AutoTArray
<
FontFaceImpl
*
1
>
mFontFaces
;
}
;
FontFace
*
GetOwner
(
)
const
{
return
mOwner
;
}
static
already_AddRefed
<
FontFaceImpl
>
CreateForRule
(
FontFace
*
aOwner
FontFaceSetImpl
*
aFontFaceSet
RawServoFontFaceRule
*
aRule
)
;
RawServoFontFaceRule
*
GetRule
(
)
{
return
mRule
;
}
bool
HasLocalSrc
(
)
const
;
Maybe
<
StyleComputedFontWeightRange
>
GetFontWeight
(
)
const
;
Maybe
<
StyleComputedFontStretchRange
>
GetFontStretch
(
)
const
;
Maybe
<
StyleComputedFontStyleDescriptor
>
GetFontStyle
(
)
const
;
Maybe
<
StyleFontDisplay
>
GetFontDisplay
(
)
const
;
void
GetFontFeatureSettings
(
nsTArray
<
gfxFontFeature
>
&
)
const
;
void
GetFontVariationSettings
(
nsTArray
<
gfxFontVariation
>
&
)
const
;
void
GetSources
(
nsTArray
<
StyleFontFaceSourceListComponent
>
&
)
const
;
Maybe
<
StyleFontLanguageOverride
>
GetFontLanguageOverride
(
)
const
;
Maybe
<
StylePercentage
>
GetAscentOverride
(
)
const
;
Maybe
<
StylePercentage
>
GetDescentOverride
(
)
const
;
Maybe
<
StylePercentage
>
GetLineGapOverride
(
)
const
;
Maybe
<
StylePercentage
>
GetSizeAdjust
(
)
const
;
gfxUserFontEntry
*
CreateUserFontEntry
(
)
;
gfxUserFontEntry
*
GetUserFontEntry
(
)
const
{
return
mUserFontEntry
;
}
void
SetUserFontEntry
(
gfxUserFontEntry
*
aEntry
)
;
bool
IsInFontFaceSet
(
FontFaceSetImpl
*
aFontFaceSet
)
const
;
void
AddFontFaceSet
(
FontFaceSetImpl
*
aFontFaceSet
)
;
void
RemoveFontFaceSet
(
FontFaceSetImpl
*
aFontFaceSet
)
;
FontFaceSetImpl
*
GetPrimaryFontFaceSet
(
)
const
{
return
mFontFaceSet
;
}
nsAtom
*
GetFamilyName
(
)
const
;
bool
HasRule
(
)
const
{
return
mRule
;
}
void
DisconnectFromRule
(
)
;
bool
HasFontData
(
)
const
;
already_AddRefed
<
gfxFontFaceBufferSource
>
TakeBufferSource
(
)
;
bool
GetData
(
uint8_t
*
&
aBuffer
uint32_t
&
aLength
)
;
gfxCharacterMap
*
GetUnicodeRangeAsCharacterMap
(
)
;
void
GetFamily
(
nsACString
&
aResult
)
;
void
SetFamily
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetStyle
(
nsACString
&
aResult
)
;
void
SetStyle
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetWeight
(
nsACString
&
aResult
)
;
void
SetWeight
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetStretch
(
nsACString
&
aResult
)
;
void
SetStretch
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetUnicodeRange
(
nsACString
&
aResult
)
;
void
SetUnicodeRange
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetVariant
(
nsACString
&
aResult
)
;
void
SetVariant
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetFeatureSettings
(
nsACString
&
aResult
)
;
void
SetFeatureSettings
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetVariationSettings
(
nsACString
&
aResult
)
;
void
SetVariationSettings
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetDisplay
(
nsACString
&
aResult
)
;
void
SetDisplay
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetAscentOverride
(
nsACString
&
aResult
)
;
void
SetAscentOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetDescentOverride
(
nsACString
&
aResult
)
;
void
SetDescentOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetLineGapOverride
(
nsACString
&
aResult
)
;
void
SetLineGapOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetSizeAdjust
(
nsACString
&
aResult
)
;
void
SetSizeAdjust
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
FontFaceLoadStatus
Status
(
)
;
void
Load
(
ErrorResult
&
aRv
)
;
void
Destroy
(
)
;
FontFaceImpl
(
FontFace
*
aOwner
FontFaceSetImpl
*
aFontFaceSet
)
;
void
InitializeSourceURL
(
const
nsACString
&
aURL
)
;
void
InitializeSourceBuffer
(
uint8_t
*
aBuffer
uint32_t
aLength
)
;
bool
SetDescriptors
(
const
nsACString
&
aFamily
const
FontFaceDescriptors
&
aDescriptors
)
;
private
:
~
FontFaceImpl
(
)
;
void
DoLoad
(
)
;
void
UpdateOwnerPromise
(
)
;
bool
SetDescriptor
(
nsCSSFontDesc
aFontDesc
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
DescriptorUpdated
(
)
;
void
SetStatus
(
FontFaceLoadStatus
aStatus
)
;
void
GetDesc
(
nsCSSFontDesc
aDescID
nsACString
&
aResult
)
const
;
RawServoFontFaceRule
*
GetData
(
)
const
{
return
HasRule
(
)
?
mRule
:
mDescriptors
;
}
void
TakeBuffer
(
uint8_t
*
&
aBuffer
uint32_t
&
aLength
)
;
FontFace
*
MOZ_NON_OWNING_REF
mOwner
;
RefPtr
<
RawServoFontFaceRule
>
mRule
;
RefPtr
<
Entry
>
mUserFontEntry
;
FontFaceLoadStatus
mStatus
;
enum
SourceType
{
eSourceType_FontFaceRule
=
1
eSourceType_URLs
eSourceType_Buffer
}
;
SourceType
mSourceType
;
RefPtr
<
FontFaceBufferSource
>
mBufferSource
;
RefPtr
<
RawServoFontFaceRule
>
mDescriptors
;
RefPtr
<
gfxCharacterMap
>
mUnicodeRange
;
RefPtr
<
FontFaceSetImpl
>
mFontFaceSet
;
nsTArray
<
RefPtr
<
FontFaceSetImpl
>
>
mOtherFontFaceSets
;
bool
mUnicodeRangeDirty
;
bool
mInFontFaceSet
;
}
;
}
#
endif
