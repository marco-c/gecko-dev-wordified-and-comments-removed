#
ifndef
mozilla_dom_FontFaceImpl_h
#
define
mozilla_dom_FontFaceImpl_h
#
include
"
mozilla
/
dom
/
FontFaceBinding
.
h
"
#
include
"
mozilla
/
FontPropertyTypes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
ServoStyleConsts
.
h
"
#
include
"
gfxUserFontSet
.
h
"
#
include
"
nsCSSPropertyID
.
h
"
#
include
"
nsCSSValue
.
h
"
#
include
"
nsTHashSet
.
h
"
class
gfxFontFaceBufferSource
;
struct
RawServoFontFaceRule
;
namespace
mozilla
{
struct
CSSFontFaceDescriptors
;
class
PostTraversalTask
;
namespace
dom
{
class
CSSFontFaceRule
;
class
FontFace
;
class
FontFaceBufferSource
;
struct
FontFaceDescriptors
;
class
FontFaceSetImpl
;
class
UTF8StringOrArrayBufferOrArrayBufferView
;
}
}
namespace
mozilla
:
:
dom
{
class
FontFaceImpl
final
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
FontFaceImpl
)
friend
class
mozilla
:
:
PostTraversalTask
;
friend
class
FontFaceBufferSource
;
friend
class
Entry
;
public
:
class
Entry
final
:
public
gfxUserFontEntry
{
friend
class
FontFaceImpl
;
public
:
Entry
(
gfxUserFontSet
*
aFontSet
nsTArray
<
gfxFontFaceSrc
>
&
&
aFontFaceSrcList
gfxUserFontAttributes
&
&
aAttr
)
:
gfxUserFontEntry
(
std
:
:
move
(
aFontFaceSrcList
)
std
:
:
move
(
aAttr
)
)
mMutex
(
"
FontFaceImpl
:
:
Entry
:
:
mMutex
"
)
mFontSet
(
aFontSet
)
{
}
void
SetLoadState
(
UserFontLoadState
aLoadState
)
override
;
void
GetUserFontSets
(
nsTArray
<
RefPtr
<
gfxUserFontSet
>
>
&
aResult
)
override
;
already_AddRefed
<
gfxUserFontSet
>
GetUserFontSet
(
)
const
override
;
void
CheckUserFontSet
(
)
{
MutexAutoLock
lock
(
mMutex
)
;
CheckUserFontSetLocked
(
)
;
}
#
ifdef
DEBUG
bool
HasUserFontSet
(
gfxUserFontSet
*
aFontSet
)
const
{
MutexAutoLock
lock
(
mMutex
)
;
return
mFontSet
=
=
aFontSet
;
}
#
endif
void
AddFontFace
(
FontFaceImpl
*
aOwner
)
;
void
RemoveFontFace
(
FontFaceImpl
*
aOwner
)
;
void
FindFontFaceOwners
(
nsTHashSet
<
FontFace
*
>
&
aOwners
)
;
protected
:
void
CheckUserFontSetLocked
(
)
MOZ_REQUIRES
(
mMutex
)
;
mutable
Mutex
mMutex
;
gfxUserFontSet
*
MOZ_NON_OWNING_REF
mFontSet
MOZ_GUARDED_BY
(
mMutex
)
;
AutoTArray
<
FontFaceImpl
*
1
>
mFontFaces
MOZ_GUARDED_BY
(
mMutex
)
;
}
;
#
ifdef
DEBUG
void
AssertIsOnOwningThread
(
)
const
;
#
else
void
AssertIsOnOwningThread
(
)
const
{
}
#
endif
FontFace
*
GetOwner
(
)
const
{
AssertIsOnOwningThread
(
)
;
return
mOwner
;
}
static
already_AddRefed
<
FontFaceImpl
>
CreateForRule
(
FontFace
*
aOwner
FontFaceSetImpl
*
aFontFaceSet
RawServoFontFaceRule
*
aRule
)
;
RawServoFontFaceRule
*
GetRule
(
)
{
return
mRule
;
}
bool
HasLocalSrc
(
)
const
;
bool
GetAttributes
(
gfxUserFontAttributes
&
aAttr
)
;
gfxUserFontEntry
*
CreateUserFontEntry
(
)
;
gfxUserFontEntry
*
GetUserFontEntry
(
)
const
{
return
mUserFontEntry
;
}
void
SetUserFontEntry
(
gfxUserFontEntry
*
aEntry
)
;
bool
IsInFontFaceSet
(
FontFaceSetImpl
*
aFontFaceSet
)
const
;
void
AddFontFaceSet
(
FontFaceSetImpl
*
aFontFaceSet
)
;
void
RemoveFontFaceSet
(
FontFaceSetImpl
*
aFontFaceSet
)
;
FontFaceSetImpl
*
GetPrimaryFontFaceSet
(
)
const
{
return
mFontFaceSet
;
}
nsAtom
*
GetFamilyName
(
)
const
;
bool
HasRule
(
)
const
{
return
mRule
;
}
void
DisconnectFromRule
(
)
;
bool
HasFontData
(
)
const
;
already_AddRefed
<
gfxFontFaceBufferSource
>
TakeBufferSource
(
)
;
bool
GetData
(
uint8_t
*
&
aBuffer
uint32_t
&
aLength
)
;
gfxCharacterMap
*
GetUnicodeRangeAsCharacterMap
(
)
;
void
GetFamily
(
nsACString
&
aResult
)
;
void
SetFamily
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetStyle
(
nsACString
&
aResult
)
;
void
SetStyle
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetWeight
(
nsACString
&
aResult
)
;
void
SetWeight
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetStretch
(
nsACString
&
aResult
)
;
void
SetStretch
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetUnicodeRange
(
nsACString
&
aResult
)
;
void
SetUnicodeRange
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetVariant
(
nsACString
&
aResult
)
;
void
SetVariant
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetFeatureSettings
(
nsACString
&
aResult
)
;
void
SetFeatureSettings
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetVariationSettings
(
nsACString
&
aResult
)
;
void
SetVariationSettings
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetDisplay
(
nsACString
&
aResult
)
;
void
SetDisplay
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetAscentOverride
(
nsACString
&
aResult
)
;
void
SetAscentOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetDescentOverride
(
nsACString
&
aResult
)
;
void
SetDescentOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetLineGapOverride
(
nsACString
&
aResult
)
;
void
SetLineGapOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetSizeAdjust
(
nsACString
&
aResult
)
;
void
SetSizeAdjust
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
FontFaceLoadStatus
Status
(
)
;
void
Load
(
ErrorResult
&
aRv
)
;
void
Destroy
(
)
;
FontFaceImpl
(
FontFace
*
aOwner
FontFaceSetImpl
*
aFontFaceSet
)
;
void
InitializeSourceURL
(
const
nsACString
&
aURL
)
;
void
InitializeSourceBuffer
(
uint8_t
*
aBuffer
uint32_t
aLength
)
;
bool
SetDescriptors
(
const
nsACString
&
aFamily
const
FontFaceDescriptors
&
aDescriptors
)
;
private
:
~
FontFaceImpl
(
)
;
void
DoLoad
(
)
;
void
UpdateOwnerPromise
(
)
;
bool
SetDescriptor
(
nsCSSFontDesc
aFontDesc
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
DescriptorUpdated
(
)
;
void
SetStatus
(
FontFaceLoadStatus
aStatus
)
;
void
GetDesc
(
nsCSSFontDesc
aDescID
nsACString
&
aResult
)
const
;
RawServoFontFaceRule
*
GetData
(
)
const
{
AssertIsOnOwningThread
(
)
;
return
HasRule
(
)
?
mRule
:
mDescriptors
;
}
void
TakeBuffer
(
uint8_t
*
&
aBuffer
uint32_t
&
aLength
)
;
FontFace
*
MOZ_NON_OWNING_REF
mOwner
;
RefPtr
<
RawServoFontFaceRule
>
mRule
;
RefPtr
<
Entry
>
mUserFontEntry
;
FontFaceLoadStatus
mStatus
;
enum
SourceType
{
eSourceType_FontFaceRule
=
1
eSourceType_URLs
eSourceType_Buffer
}
;
SourceType
mSourceType
;
RefPtr
<
FontFaceBufferSource
>
mBufferSource
;
RefPtr
<
RawServoFontFaceRule
>
mDescriptors
;
RefPtr
<
gfxCharacterMap
>
mUnicodeRange
;
RefPtr
<
FontFaceSetImpl
>
mFontFaceSet
;
nsTArray
<
RefPtr
<
FontFaceSetImpl
>
>
mOtherFontFaceSets
;
bool
mUnicodeRangeDirty
;
bool
mInFontFaceSet
;
}
;
}
#
endif
