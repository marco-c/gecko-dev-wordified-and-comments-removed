#
include
"
nsDOMCSSDeclaration
.
h
"
#
include
"
nsCSSParser
.
h
"
#
include
"
mozilla
/
DeclarationBlockInlines
.
h
"
#
include
"
mozilla
/
StyleSheetInlines
.
h
"
#
include
"
mozilla
/
css
/
Rule
.
h
"
#
include
"
mozilla
/
dom
/
CSS2PropertiesBinding
.
h
"
#
include
"
nsCSSProps
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
mozAutoDocUpdate
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
mozilla
/
dom
/
BindingUtils
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsQueryObject
.
h
"
#
include
"
mozilla
/
layers
/
ScrollLinkedEffectDetector
.
h
"
using
namespace
mozilla
;
nsDOMCSSDeclaration
:
:
~
nsDOMCSSDeclaration
(
)
{
}
JSObject
*
nsDOMCSSDeclaration
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
dom
:
:
CSS2PropertiesBinding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
NS_IMPL_QUERY_INTERFACE
(
nsDOMCSSDeclaration
nsICSSDeclaration
)
nsresult
nsDOMCSSDeclaration
:
:
GetPropertyValue
(
const
nsCSSPropertyID
aPropID
nsAString
&
aValue
)
{
NS_PRECONDITION
(
aPropID
!
=
eCSSProperty_UNKNOWN
"
Should
never
pass
eCSSProperty_UNKNOWN
around
"
)
;
aValue
.
Truncate
(
)
;
if
(
DeclarationBlock
*
decl
=
GetCSSDeclaration
(
eOperation_Read
)
)
{
decl
-
>
GetPropertyValueByID
(
aPropID
aValue
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
SetPropertyValue
(
const
nsCSSPropertyID
aPropID
const
nsAString
&
aValue
nsIPrincipal
*
aSubjectPrincipal
)
{
switch
(
aPropID
)
{
case
eCSSProperty_background_position
:
case
eCSSProperty_background_position_x
:
case
eCSSProperty_background_position_y
:
case
eCSSProperty_transform
:
case
eCSSProperty_top
:
case
eCSSProperty_left
:
case
eCSSProperty_bottom
:
case
eCSSProperty_right
:
case
eCSSProperty_margin
:
case
eCSSProperty_margin_top
:
case
eCSSProperty_margin_left
:
case
eCSSProperty_margin_bottom
:
case
eCSSProperty_margin_right
:
case
eCSSProperty_margin_inline_start
:
case
eCSSProperty_margin_inline_end
:
case
eCSSProperty_margin_block_start
:
case
eCSSProperty_margin_block_end
:
mozilla
:
:
layers
:
:
ScrollLinkedEffectDetector
:
:
PositioningPropertyMutated
(
)
;
break
;
default
:
break
;
}
if
(
aValue
.
IsEmpty
(
)
)
{
return
RemovePropertyInternal
(
aPropID
)
;
}
return
ParsePropertyValue
(
aPropID
aValue
false
aSubjectPrincipal
)
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
GetCssText
(
nsAString
&
aCssText
)
{
DeclarationBlock
*
decl
=
GetCSSDeclaration
(
eOperation_Read
)
;
aCssText
.
Truncate
(
)
;
if
(
decl
)
{
decl
-
>
ToString
(
aCssText
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
SetCssText
(
const
nsAString
&
aCssText
nsIPrincipal
*
aSubjectPrincipal
)
{
DeclarationBlock
*
olddecl
=
GetCSSDeclaration
(
eOperation_Modify
)
;
if
(
!
olddecl
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
mozAutoDocConditionalContentUpdateBatch
autoUpdate
(
DocToUpdate
(
)
true
)
;
RefPtr
<
DeclarationBlock
>
newdecl
;
if
(
olddecl
-
>
IsServo
(
)
)
{
ServoCSSParsingEnvironment
servoEnv
=
GetServoCSSParsingEnvironment
(
aSubjectPrincipal
)
;
if
(
!
servoEnv
.
mUrlExtraData
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
newdecl
=
ServoDeclarationBlock
:
:
FromCssText
(
aCssText
servoEnv
.
mUrlExtraData
servoEnv
.
mCompatMode
servoEnv
.
mLoader
)
;
}
else
{
CSSParsingEnvironment
geckoEnv
;
GetCSSParsingEnvironment
(
geckoEnv
aSubjectPrincipal
)
;
if
(
!
geckoEnv
.
mPrincipal
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
RefPtr
<
css
:
:
Declaration
>
decl
(
new
css
:
:
Declaration
(
)
)
;
decl
-
>
InitializeEmpty
(
)
;
nsCSSParser
cssParser
(
geckoEnv
.
mCSSLoader
)
;
bool
changed
;
nsresult
result
=
cssParser
.
ParseDeclarations
(
aCssText
geckoEnv
.
mSheetURI
geckoEnv
.
mBaseURI
geckoEnv
.
mPrincipal
decl
&
changed
)
;
if
(
NS_FAILED
(
result
)
|
|
!
changed
)
{
return
result
;
}
newdecl
=
decl
.
forget
(
)
;
}
return
SetCSSDeclaration
(
newdecl
)
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
GetLength
(
uint32_t
*
aLength
)
{
DeclarationBlock
*
decl
=
GetCSSDeclaration
(
eOperation_Read
)
;
if
(
decl
)
{
*
aLength
=
decl
-
>
Count
(
)
;
}
else
{
*
aLength
=
0
;
}
return
NS_OK
;
}
already_AddRefed
<
dom
:
:
CSSValue
>
nsDOMCSSDeclaration
:
:
GetPropertyCSSValue
(
const
nsAString
&
aPropertyName
ErrorResult
&
aRv
)
{
return
nullptr
;
}
void
nsDOMCSSDeclaration
:
:
IndexedGetter
(
uint32_t
aIndex
bool
&
aFound
nsAString
&
aPropName
)
{
DeclarationBlock
*
decl
=
GetCSSDeclaration
(
eOperation_Read
)
;
aFound
=
decl
&
&
decl
-
>
GetNthProperty
(
aIndex
aPropName
)
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
GetPropertyValue
(
const
nsAString
&
aPropertyName
nsAString
&
aReturn
)
{
aReturn
.
Truncate
(
)
;
if
(
DeclarationBlock
*
decl
=
GetCSSDeclaration
(
eOperation_Read
)
)
{
decl
-
>
GetPropertyValue
(
aPropertyName
aReturn
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
GetPropertyPriority
(
const
nsAString
&
aPropertyName
nsAString
&
aReturn
)
{
DeclarationBlock
*
decl
=
GetCSSDeclaration
(
eOperation_Read
)
;
aReturn
.
Truncate
(
)
;
if
(
decl
&
&
decl
-
>
GetPropertyIsImportant
(
aPropertyName
)
)
{
aReturn
.
AssignLiteral
(
"
important
"
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
SetProperty
(
const
nsAString
&
aPropertyName
const
nsAString
&
aValue
const
nsAString
&
aPriority
nsIPrincipal
*
aSubjectPrincipal
)
{
if
(
aValue
.
IsEmpty
(
)
)
{
return
RemovePropertyInternal
(
aPropertyName
)
;
}
nsCSSPropertyID
propID
=
nsCSSProps
:
:
LookupProperty
(
aPropertyName
CSSEnabledState
:
:
eForAllContent
)
;
if
(
propID
=
=
eCSSProperty_UNKNOWN
)
{
return
NS_OK
;
}
bool
important
;
if
(
aPriority
.
IsEmpty
(
)
)
{
important
=
false
;
}
else
if
(
aPriority
.
EqualsLiteral
(
"
important
"
)
)
{
important
=
true
;
}
else
{
return
NS_OK
;
}
if
(
propID
=
=
eCSSPropertyExtra_variable
)
{
return
ParseCustomPropertyValue
(
aPropertyName
aValue
important
aSubjectPrincipal
)
;
}
return
ParsePropertyValue
(
propID
aValue
important
aSubjectPrincipal
)
;
}
NS_IMETHODIMP
nsDOMCSSDeclaration
:
:
RemoveProperty
(
const
nsAString
&
aPropertyName
nsAString
&
aReturn
)
{
nsresult
rv
=
GetPropertyValue
(
aPropertyName
aReturn
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
return
RemovePropertyInternal
(
aPropertyName
)
;
}
void
nsDOMCSSDeclaration
:
:
GetCSSParsingEnvironmentForRule
(
css
:
:
Rule
*
aRule
CSSParsingEnvironment
&
aCSSParseEnv
)
{
StyleSheet
*
sheet
=
aRule
?
aRule
-
>
GetStyleSheet
(
)
:
nullptr
;
if
(
!
sheet
)
{
aCSSParseEnv
.
mPrincipal
=
nullptr
;
return
;
}
nsIDocument
*
document
=
sheet
-
>
GetAssociatedDocument
(
)
;
aCSSParseEnv
.
mSheetURI
=
sheet
-
>
GetSheetURI
(
)
;
aCSSParseEnv
.
mBaseURI
=
sheet
-
>
GetBaseURI
(
)
;
aCSSParseEnv
.
mPrincipal
=
sheet
-
>
Principal
(
)
;
aCSSParseEnv
.
mCSSLoader
=
document
?
document
-
>
CSSLoader
(
)
:
nullptr
;
}
nsDOMCSSDeclaration
:
:
ServoCSSParsingEnvironment
nsDOMCSSDeclaration
:
:
GetServoCSSParsingEnvironmentForRule
(
const
css
:
:
Rule
*
aRule
)
{
StyleSheet
*
sheet
=
aRule
?
aRule
-
>
GetStyleSheet
(
)
:
nullptr
;
if
(
!
sheet
)
{
return
{
nullptr
eCompatibility_FullStandards
nullptr
}
;
}
if
(
nsIDocument
*
document
=
aRule
-
>
GetDocument
(
)
)
{
return
{
sheet
-
>
AsServo
(
)
-
>
URLData
(
)
document
-
>
GetCompatibilityMode
(
)
document
-
>
CSSLoader
(
)
}
;
}
return
{
sheet
-
>
AsServo
(
)
-
>
URLData
(
)
eCompatibility_FullStandards
nullptr
}
;
}
template
<
typename
GeckoFunc
typename
ServoFunc
>
nsresult
nsDOMCSSDeclaration
:
:
ModifyDeclaration
(
nsIPrincipal
*
aSubjectPrincipal
GeckoFunc
aGeckoFunc
ServoFunc
aServoFunc
)
{
DeclarationBlock
*
olddecl
=
GetCSSDeclaration
(
eOperation_Modify
)
;
if
(
!
olddecl
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
mozAutoDocConditionalContentUpdateBatch
autoUpdate
(
DocToUpdate
(
)
true
)
;
RefPtr
<
DeclarationBlock
>
decl
=
olddecl
-
>
EnsureMutable
(
)
;
bool
changed
;
if
(
decl
-
>
IsGecko
(
)
)
{
CSSParsingEnvironment
geckoEnv
;
GetCSSParsingEnvironment
(
geckoEnv
aSubjectPrincipal
)
;
if
(
!
geckoEnv
.
mPrincipal
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
aGeckoFunc
(
decl
-
>
AsGecko
(
)
geckoEnv
&
changed
)
;
}
else
{
ServoCSSParsingEnvironment
servoEnv
=
GetServoCSSParsingEnvironment
(
aSubjectPrincipal
)
;
if
(
!
servoEnv
.
mUrlExtraData
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
changed
=
aServoFunc
(
decl
-
>
AsServo
(
)
servoEnv
)
;
}
if
(
!
changed
)
{
return
NS_OK
;
}
return
SetCSSDeclaration
(
decl
)
;
}
nsresult
nsDOMCSSDeclaration
:
:
ParsePropertyValue
(
const
nsCSSPropertyID
aPropID
const
nsAString
&
aPropValue
bool
aIsImportant
nsIPrincipal
*
aSubjectPrincipal
)
{
return
ModifyDeclaration
(
aSubjectPrincipal
[
&
]
(
css
:
:
Declaration
*
decl
CSSParsingEnvironment
&
env
bool
*
changed
)
{
nsCSSParser
cssParser
(
env
.
mCSSLoader
)
;
cssParser
.
ParseProperty
(
aPropID
aPropValue
env
.
mSheetURI
env
.
mBaseURI
env
.
mPrincipal
decl
changed
aIsImportant
)
;
}
[
&
]
(
ServoDeclarationBlock
*
decl
ServoCSSParsingEnvironment
&
env
)
{
NS_ConvertUTF16toUTF8
value
(
aPropValue
)
;
return
Servo_DeclarationBlock_SetPropertyById
(
decl
-
>
Raw
(
)
aPropID
&
value
aIsImportant
env
.
mUrlExtraData
ParsingMode
:
:
Default
env
.
mCompatMode
env
.
mLoader
)
;
}
)
;
}
nsresult
nsDOMCSSDeclaration
:
:
ParseCustomPropertyValue
(
const
nsAString
&
aPropertyName
const
nsAString
&
aPropValue
bool
aIsImportant
nsIPrincipal
*
aSubjectPrincipal
)
{
MOZ_ASSERT
(
nsCSSProps
:
:
IsCustomPropertyName
(
aPropertyName
)
)
;
return
ModifyDeclaration
(
aSubjectPrincipal
[
&
]
(
css
:
:
Declaration
*
decl
CSSParsingEnvironment
&
env
bool
*
changed
)
{
nsCSSParser
cssParser
(
env
.
mCSSLoader
)
;
auto
propName
=
Substring
(
aPropertyName
CSS_CUSTOM_NAME_PREFIX_LENGTH
)
;
cssParser
.
ParseVariable
(
propName
aPropValue
env
.
mSheetURI
env
.
mBaseURI
env
.
mPrincipal
decl
changed
aIsImportant
)
;
}
[
&
]
(
ServoDeclarationBlock
*
decl
ServoCSSParsingEnvironment
&
env
)
{
NS_ConvertUTF16toUTF8
property
(
aPropertyName
)
;
NS_ConvertUTF16toUTF8
value
(
aPropValue
)
;
return
Servo_DeclarationBlock_SetProperty
(
decl
-
>
Raw
(
)
&
property
&
value
aIsImportant
env
.
mUrlExtraData
ParsingMode
:
:
Default
env
.
mCompatMode
env
.
mLoader
)
;
}
)
;
}
nsresult
nsDOMCSSDeclaration
:
:
RemovePropertyInternal
(
nsCSSPropertyID
aPropID
)
{
DeclarationBlock
*
olddecl
=
GetCSSDeclaration
(
eOperation_RemoveProperty
)
;
if
(
!
olddecl
)
{
return
NS_OK
;
}
mozAutoDocConditionalContentUpdateBatch
autoUpdate
(
DocToUpdate
(
)
true
)
;
RefPtr
<
DeclarationBlock
>
decl
=
olddecl
-
>
EnsureMutable
(
)
;
decl
-
>
RemovePropertyByID
(
aPropID
)
;
return
SetCSSDeclaration
(
decl
)
;
}
nsresult
nsDOMCSSDeclaration
:
:
RemovePropertyInternal
(
const
nsAString
&
aPropertyName
)
{
DeclarationBlock
*
olddecl
=
GetCSSDeclaration
(
eOperation_RemoveProperty
)
;
if
(
!
olddecl
)
{
return
NS_OK
;
}
mozAutoDocConditionalContentUpdateBatch
autoUpdate
(
DocToUpdate
(
)
true
)
;
RefPtr
<
DeclarationBlock
>
decl
=
olddecl
-
>
EnsureMutable
(
)
;
decl
-
>
RemoveProperty
(
aPropertyName
)
;
return
SetCSSDeclaration
(
decl
)
;
}
