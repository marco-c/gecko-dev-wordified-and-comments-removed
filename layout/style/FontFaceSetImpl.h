#
ifndef
mozilla_dom_FontFaceSetImpl_h
#
define
mozilla_dom_FontFaceSetImpl_h
#
include
"
mozilla
/
dom
/
FontFace
.
h
"
#
include
"
mozilla
/
dom
/
FontFaceSetBinding
.
h
"
#
include
"
mozilla
/
DOMEventTargetHelper
.
h
"
#
include
"
mozilla
/
FontPropertyTypes
.
h
"
#
include
"
gfxUserFontSet
.
h
"
#
include
"
nsICSSLoaderObserver
.
h
"
#
include
"
nsIDOMEventListener
.
h
"
struct
gfxFontFaceSrc
;
class
gfxFontSrcPrincipal
;
class
gfxUserFontEntry
;
class
nsFontFaceLoader
;
class
nsIPrincipal
;
class
nsPIDOMWindowInner
;
struct
RawServoFontFaceRule
;
namespace
mozilla
{
class
PostTraversalTask
;
class
SharedFontList
;
namespace
dom
{
class
FontFace
;
}
}
namespace
mozilla
:
:
dom
{
class
FontFaceSetImpl
final
:
public
gfxUserFontSet
public
nsIDOMEventListener
public
nsICSSLoaderObserver
{
NS_DECL_THREADSAFE_ISUPPORTS
public
:
already_AddRefed
<
gfxFontSrcPrincipal
>
GetStandardFontLoadPrincipal
(
)
const
override
{
return
RefPtr
{
mStandardFontLoadPrincipal
}
.
forget
(
)
;
}
nsPresContext
*
GetPresContext
(
)
const
override
;
bool
IsFontLoadAllowed
(
const
gfxFontFaceSrc
&
)
override
;
nsresult
StartLoad
(
gfxUserFontEntry
*
aUserFontEntry
uint32_t
aSrcIndex
)
override
;
void
RecordFontLoadDone
(
uint32_t
aFontSize
TimeStamp
aDoneTime
)
override
;
bool
BypassCache
(
)
final
{
return
mBypassCache
;
}
protected
:
bool
GetPrivateBrowsing
(
)
override
{
return
mPrivateBrowsing
;
}
nsresult
SyncLoadFontData
(
gfxUserFontEntry
*
aFontToLoad
const
gfxFontFaceSrc
*
aFontFaceSrc
uint8_t
*
&
aBuffer
uint32_t
&
aBufferLength
)
override
;
nsresult
LogMessage
(
gfxUserFontEntry
*
aUserFontEntry
uint32_t
aSrcIndex
const
char
*
aMessage
uint32_t
aFlags
=
nsIScriptError
:
:
errorFlag
nsresult
aStatus
=
NS_OK
)
override
;
void
DoRebuildUserFontSet
(
)
override
;
already_AddRefed
<
gfxUserFontEntry
>
CreateUserFontEntry
(
const
nsTArray
<
gfxFontFaceSrc
>
&
aFontFaceSrcList
WeightRange
aWeight
StretchRange
aStretch
SlantStyleRange
aStyle
const
nsTArray
<
gfxFontFeature
>
&
aFeatureSettings
const
nsTArray
<
gfxFontVariation
>
&
aVariationSettings
uint32_t
aLanguageOverride
gfxCharacterMap
*
aUnicodeRanges
StyleFontDisplay
aFontDisplay
RangeFlags
aRangeFlags
float
aAscentOverride
float
aDescentOverride
float
aLineGapOverride
float
aSizeAdjust
)
override
;
public
:
NS_DECL_NSIDOMEVENTLISTENER
FontFaceSetImpl
(
FontFaceSet
*
aOwner
dom
:
:
Document
*
aDocument
)
;
void
Initialize
(
)
;
void
Destroy
(
)
;
void
RemoveLoader
(
nsFontFaceLoader
*
aLoader
)
;
bool
UpdateRules
(
const
nsTArray
<
nsFontFaceRuleContainer
>
&
aRules
)
;
RawServoFontFaceRule
*
FindRuleForEntry
(
gfxFontEntry
*
aFontEntry
)
;
static
already_AddRefed
<
gfxUserFontEntry
>
FindOrCreateUserFontEntryFromFontFace
(
FontFaceImpl
*
aFontFace
)
;
void
OnFontFaceStatusChanged
(
FontFaceImpl
*
aFontFace
)
;
void
DidRefresh
(
)
;
static
bool
PrefEnabled
(
)
;
NS_IMETHOD
StyleSheetLoaded
(
StyleSheet
*
aSheet
bool
aWasDeferred
nsresult
aStatus
)
override
;
void
FlushUserFontSet
(
)
;
static
nsPresContext
*
GetPresContextFor
(
gfxUserFontSet
*
aUserFontSet
)
{
const
auto
*
set
=
static_cast
<
FontFaceSetImpl
*
>
(
aUserFontSet
)
;
return
set
?
set
-
>
GetPresContext
(
)
:
nullptr
;
}
void
RefreshStandardFontLoadPrincipal
(
)
;
dom
:
:
Document
*
Document
(
)
const
{
return
mDocument
;
}
void
EnsureReady
(
)
;
dom
:
:
FontFaceSetLoadStatus
Status
(
)
;
bool
Add
(
FontFaceImpl
*
aFontFace
ErrorResult
&
aRv
)
;
void
Clear
(
)
;
bool
Delete
(
FontFaceImpl
*
aFontFace
)
;
void
CacheFontLoadability
(
)
;
void
MarkUserFontSetDirty
(
)
;
void
CheckLoadingFinished
(
)
;
void
FindMatchingFontFaces
(
const
nsACString
&
aFont
const
nsAString
&
aText
nsTArray
<
FontFace
*
>
&
aFontFaces
ErrorResult
&
aRv
)
;
void
DispatchCheckLoadingFinishedAfterDelay
(
)
;
private
:
~
FontFaceSetImpl
(
)
;
bool
HasAvailableFontFace
(
FontFaceImpl
*
aFontFace
)
;
void
RemoveDOMContentLoadedListener
(
)
;
bool
MightHavePendingFontLoads
(
)
;
void
CheckLoadingStarted
(
)
;
void
CheckLoadingFinishedAfterDelay
(
)
;
struct
FontFaceRecord
{
RefPtr
<
FontFaceImpl
>
mFontFace
;
Maybe
<
StyleOrigin
>
mOrigin
;
}
;
static
already_AddRefed
<
gfxUserFontEntry
>
FindOrCreateUserFontEntryFromFontFace
(
const
nsACString
&
aFamilyName
FontFaceImpl
*
aFontFace
StyleOrigin
)
;
RawServoFontFaceRule
*
FindRuleForUserFontEntry
(
gfxUserFontEntry
*
aUserFontEntry
)
;
already_AddRefed
<
gfxFontSrcPrincipal
>
GetStandardFontLoadPrincipal
(
)
;
nsresult
CheckFontLoad
(
const
gfxFontFaceSrc
*
aFontFaceSrc
gfxFontSrcPrincipal
*
*
aPrincipal
bool
*
aBypassCache
)
;
void
InsertRuleFontFace
(
FontFaceImpl
*
aFontFace
FontFace
*
aFontFaceOwner
StyleOrigin
aOrigin
nsTArray
<
FontFaceRecord
>
&
aOldRecords
bool
&
aFontSetModified
)
;
void
InsertNonRuleFontFace
(
FontFaceImpl
*
aFontFace
bool
&
aFontSetModified
)
;
#
ifdef
DEBUG
bool
HasRuleFontFace
(
FontFaceImpl
*
aFontFace
)
;
#
endif
bool
HasLoadingFontFaces
(
)
;
bool
ReadyPromiseIsPending
(
)
const
;
void
UpdateHasLoadingFontFaces
(
)
;
void
ParseFontShorthandForMatching
(
const
nsACString
&
aFont
StyleFontFamilyList
&
aFamilyList
FontWeight
&
aWeight
FontStretch
&
aStretch
FontSlantStyle
&
aStyle
ErrorResult
&
aRv
)
;
TimeStamp
GetNavigationStartTimeStamp
(
)
;
FontFaceSet
*
MOZ_NON_OWNING_REF
mOwner
;
RefPtr
<
dom
:
:
Document
>
mDocument
;
RefPtr
<
gfxFontSrcPrincipal
>
mStandardFontLoadPrincipal
;
nsTHashtable
<
nsPtrHashKey
<
nsFontFaceLoader
>
>
mLoaders
;
nsTArray
<
FontFaceRecord
>
mRuleFaces
;
nsTArray
<
FontFaceRecord
>
mNonRuleFaces
;
dom
:
:
FontFaceSetLoadStatus
mStatus
;
nsTHashMap
<
nsPtrHashKey
<
const
gfxFontFaceSrc
>
bool
>
mAllowedFontLoads
;
bool
mNonRuleFacesDirty
;
bool
mHasLoadingFontFaces
;
bool
mHasLoadingFontFacesIsDirty
;
bool
mDelayedLoadCheck
;
bool
mBypassCache
;
bool
mPrivateBrowsing
;
}
;
}
#
endif
