#
include
"
mozilla
/
css
/
GroupRule
.
h
"
#
include
"
mozilla
/
dom
/
CSSRuleList
.
h
"
using
namespace
mozilla
:
:
dom
;
namespace
mozilla
{
namespace
css
{
#
define
CALL_INNER
(
inner_
call_
)
\
(
(
inner_
)
.
is
<
DummyGroupRuleRules
>
(
)
\
?
(
inner_
)
.
as
<
DummyGroupRuleRules
>
(
)
.
call_
\
:
(
inner_
)
.
as
<
ServoGroupRuleRules
>
(
)
.
call_
)
ServoGroupRuleRules
:
:
~
ServoGroupRuleRules
(
)
{
if
(
mRuleList
)
{
mRuleList
-
>
DropReference
(
)
;
}
}
#
ifdef
DEBUG
void
ServoGroupRuleRules
:
:
List
(
FILE
*
out
int32_t
aIndent
)
const
{
}
#
endif
size_t
ServoGroupRuleRules
:
:
SizeOfExcludingThis
(
MallocSizeOf
aMallocSizeOf
)
const
{
return
0
;
}
GroupRule
:
:
GroupRule
(
uint32_t
aLineNumber
uint32_t
aColumnNumber
)
:
Rule
(
aLineNumber
aColumnNumber
)
mInner
(
DummyGroupRuleRules
(
)
)
{
}
GroupRule
:
:
GroupRule
(
already_AddRefed
<
ServoCssRules
>
aRules
uint32_t
aLineNumber
uint32_t
aColumnNumber
)
:
Rule
(
aLineNumber
aColumnNumber
)
mInner
(
ServoGroupRuleRules
(
Move
(
aRules
)
)
)
{
mInner
.
as
<
ServoGroupRuleRules
>
(
)
.
SetParentRule
(
this
)
;
}
GroupRule
:
:
GroupRule
(
const
GroupRule
&
aCopy
)
:
Rule
(
aCopy
)
mInner
(
aCopy
.
mInner
)
{
CALL_INNER
(
mInner
SetParentRule
(
this
)
)
;
}
GroupRule
:
:
~
GroupRule
(
)
{
MOZ_ASSERT
(
!
mSheet
"
SetStyleSheet
should
have
been
called
"
)
;
}
NS_IMPL_ADDREF_INHERITED
(
GroupRule
Rule
)
NS_IMPL_RELEASE_INHERITED
(
GroupRule
Rule
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
GroupRule
)
NS_INTERFACE_MAP_END_INHERITING
(
Rule
)
bool
GroupRule
:
:
IsCCLeaf
(
)
const
{
return
false
;
}
NS_IMPL_CYCLE_COLLECTION_CLASS
(
GroupRule
)
NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED
(
GroupRule
Rule
)
CALL_INNER
(
tmp
-
>
mInner
SetParentRule
(
nullptr
)
)
;
if
(
tmp
-
>
GetStyleSheet
(
)
)
{
CALL_INNER
(
tmp
-
>
mInner
SetStyleSheet
(
nullptr
)
)
;
}
CALL_INNER
(
tmp
-
>
mInner
Clear
(
)
)
;
NS_IMPL_CYCLE_COLLECTION_UNLINK_END
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED
(
GroupRule
Rule
)
CALL_INNER
(
tmp
-
>
mInner
Traverse
(
cb
)
)
;
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
void
GroupRule
:
:
SetStyleSheet
(
StyleSheet
*
aSheet
)
{
if
(
aSheet
!
=
GetStyleSheet
(
)
)
{
CALL_INNER
(
mInner
SetStyleSheet
(
aSheet
)
)
;
Rule
:
:
SetStyleSheet
(
aSheet
)
;
}
}
CSSRuleList
*
GroupRule
:
:
CssRules
(
)
{
return
CALL_INNER
(
mInner
CssRules
(
this
)
)
;
}
uint32_t
GroupRule
:
:
InsertRule
(
const
nsAString
&
aRule
uint32_t
aIndex
ErrorResult
&
aRv
)
{
StyleSheet
*
sheet
=
GetStyleSheet
(
)
;
if
(
NS_WARN_IF
(
!
sheet
)
)
{
aRv
.
Throw
(
NS_ERROR_FAILURE
)
;
return
0
;
}
uint32_t
count
=
StyleRuleCount
(
)
;
if
(
aIndex
>
count
)
{
aRv
.
Throw
(
NS_ERROR_DOM_INDEX_SIZE_ERR
)
;
return
0
;
}
NS_ASSERTION
(
count
<
=
INT32_MAX
"
Too
many
style
rules
!
"
)
;
nsresult
rv
=
sheet
-
>
InsertRuleIntoGroup
(
aRule
this
aIndex
)
;
if
(
NS_FAILED
(
rv
)
)
{
aRv
.
Throw
(
rv
)
;
return
0
;
}
return
aIndex
;
}
void
GroupRule
:
:
DeleteRule
(
uint32_t
aIndex
ErrorResult
&
aRv
)
{
StyleSheet
*
sheet
=
GetStyleSheet
(
)
;
if
(
NS_WARN_IF
(
!
sheet
)
)
{
aRv
.
Throw
(
NS_ERROR_FAILURE
)
;
return
;
}
uint32_t
count
=
StyleRuleCount
(
)
;
if
(
aIndex
>
=
count
)
{
aRv
.
Throw
(
NS_ERROR_DOM_INDEX_SIZE_ERR
)
;
return
;
}
NS_ASSERTION
(
count
<
=
INT32_MAX
"
Too
many
style
rules
!
"
)
;
nsresult
rv
=
sheet
-
>
DeleteRuleFromGroup
(
this
aIndex
)
;
if
(
NS_FAILED
(
rv
)
)
{
aRv
.
Throw
(
rv
)
;
}
}
#
undef
CALL_INNER
}
}
