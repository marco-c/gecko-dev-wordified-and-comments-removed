#
ifndef
mozilla_ServoStyleSet_h
#
define
mozilla_ServoStyleSet_h
#
include
"
mozilla
/
EnumeratedArray
.
h
"
#
include
"
mozilla
/
EventStates
.
h
"
#
include
"
mozilla
/
PostTraversalTask
.
h
"
#
include
"
mozilla
/
ServoBindingTypes
.
h
"
#
include
"
mozilla
/
ServoElementSnapshot
.
h
"
#
include
"
mozilla
/
ServoUtils
.
h
"
#
include
"
mozilla
/
StyleSheetInlines
.
h
"
#
include
"
mozilla
/
SheetType
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
MainThreadUtils
.
h
"
#
include
"
nsCSSPseudoElements
.
h
"
#
include
"
nsCSSAnonBoxes
.
h
"
#
include
"
nsChangeHint
.
h
"
#
include
"
nsIAtom
.
h
"
#
include
"
nsTArray
.
h
"
namespace
mozilla
{
namespace
dom
{
class
Element
;
}
class
CSSStyleSheet
;
class
ServoRestyleManager
;
class
ServoStyleSheet
;
struct
Keyframe
;
struct
ServoComputedValuesWithParent
;
class
ServoElementSnapshotTable
;
}
class
nsCSSCounterStyleRule
;
class
nsIContent
;
class
nsIDocument
;
class
nsStyleContext
;
class
nsPresContext
;
struct
nsTimingFunction
;
struct
RawServoRuleNode
;
struct
TreeMatchContext
;
namespace
mozilla
{
class
ServoStyleSet
{
friend
class
ServoRestyleManager
;
typedef
ServoElementSnapshotTable
SnapshotTable
;
public
:
class
AutoAllowStaleStyles
{
public
:
explicit
AutoAllowStaleStyles
(
ServoStyleSet
*
aStyleSet
)
:
mStyleSet
(
aStyleSet
)
{
if
(
mStyleSet
)
{
MOZ_ASSERT
(
!
mStyleSet
-
>
mAllowResolveStaleStyles
)
;
mStyleSet
-
>
mAllowResolveStaleStyles
=
true
;
}
}
~
AutoAllowStaleStyles
(
)
{
if
(
mStyleSet
)
{
mStyleSet
-
>
mAllowResolveStaleStyles
=
false
;
}
}
private
:
ServoStyleSet
*
mStyleSet
;
}
;
static
bool
IsInServoTraversal
(
)
{
MOZ_ASSERT
(
sInServoTraversal
|
|
NS_IsMainThread
(
)
)
;
return
sInServoTraversal
;
}
static
ServoStyleSet
*
Current
(
)
{
return
sInServoTraversal
;
}
ServoStyleSet
(
)
;
~
ServoStyleSet
(
)
;
void
Init
(
nsPresContext
*
aPresContext
)
;
void
BeginShutdown
(
)
;
void
Shutdown
(
)
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
const
RawServoStyleSet
&
RawSet
(
)
const
{
return
*
mRawSet
;
}
bool
GetAuthorStyleDisabled
(
)
const
;
nsresult
SetAuthorStyleDisabled
(
bool
aStyleDisabled
)
;
void
BeginUpdate
(
)
;
nsresult
EndUpdate
(
)
;
already_AddRefed
<
nsStyleContext
>
ResolveStyleFor
(
dom
:
:
Element
*
aElement
nsStyleContext
*
aParentContext
LazyComputeBehavior
aMayCompute
)
;
already_AddRefed
<
nsStyleContext
>
ResolveStyleFor
(
dom
:
:
Element
*
aElement
nsStyleContext
*
aParentContext
LazyComputeBehavior
aMayCompute
TreeMatchContext
&
aTreeMatchContext
)
;
already_AddRefed
<
nsStyleContext
>
ResolveStyleForText
(
nsIContent
*
aTextNode
nsStyleContext
*
aParentContext
)
;
already_AddRefed
<
nsStyleContext
>
ResolveStyleForFirstLetterContinuation
(
nsStyleContext
*
aParentContext
)
;
already_AddRefed
<
nsStyleContext
>
ResolveStyleForPlaceholder
(
)
;
already_AddRefed
<
nsStyleContext
>
ResolvePseudoElementStyle
(
dom
:
:
Element
*
aOriginatingElement
CSSPseudoElementType
aType
nsStyleContext
*
aParentContext
dom
:
:
Element
*
aPseudoElement
)
;
already_AddRefed
<
nsStyleContext
>
ResolveTransientStyle
(
dom
:
:
Element
*
aElement
nsIAtom
*
aPseudoTag
CSSPseudoElementType
aPseudoType
)
;
already_AddRefed
<
ServoComputedValues
>
ResolveTransientServoStyle
(
dom
:
:
Element
*
aElement
CSSPseudoElementType
aPseudoTag
)
;
already_AddRefed
<
nsStyleContext
>
ResolveInheritingAnonymousBoxStyle
(
nsIAtom
*
aPseudoTag
nsStyleContext
*
aParentContext
)
;
already_AddRefed
<
nsStyleContext
>
ResolveNonInheritingAnonymousBoxStyle
(
nsIAtom
*
aPseudoTag
)
;
nsresult
AppendStyleSheet
(
SheetType
aType
ServoStyleSheet
*
aSheet
)
;
nsresult
PrependStyleSheet
(
SheetType
aType
ServoStyleSheet
*
aSheet
)
;
nsresult
RemoveStyleSheet
(
SheetType
aType
ServoStyleSheet
*
aSheet
)
;
nsresult
ReplaceSheets
(
SheetType
aType
const
nsTArray
<
RefPtr
<
ServoStyleSheet
>
>
&
aNewSheets
)
;
nsresult
InsertStyleSheetBefore
(
SheetType
aType
ServoStyleSheet
*
aNewSheet
ServoStyleSheet
*
aReferenceSheet
)
;
int32_t
SheetCount
(
SheetType
aType
)
const
;
ServoStyleSheet
*
StyleSheetAt
(
SheetType
aType
int32_t
aIndex
)
const
;
nsresult
RemoveDocStyleSheet
(
ServoStyleSheet
*
aSheet
)
;
nsresult
AddDocStyleSheet
(
ServoStyleSheet
*
aSheet
nsIDocument
*
aDocument
)
;
already_AddRefed
<
nsStyleContext
>
ProbePseudoElementStyle
(
dom
:
:
Element
*
aOriginatingElement
mozilla
:
:
CSSPseudoElementType
aType
nsStyleContext
*
aParentContext
)
;
already_AddRefed
<
nsStyleContext
>
ProbePseudoElementStyle
(
dom
:
:
Element
*
aOriginatingElement
mozilla
:
:
CSSPseudoElementType
aType
nsStyleContext
*
aParentContext
TreeMatchContext
&
aTreeMatchContext
dom
:
:
Element
*
aPseudoElement
=
nullptr
)
;
nsRestyleHint
HasStateDependentStyle
(
dom
:
:
Element
*
aElement
EventStates
aStateMask
)
;
nsRestyleHint
HasStateDependentStyle
(
dom
:
:
Element
*
aElement
mozilla
:
:
CSSPseudoElementType
aPseudoType
dom
:
:
Element
*
aPseudoElement
EventStates
aStateMask
)
;
bool
StyleDocument
(
)
;
void
StyleNewSubtree
(
dom
:
:
Element
*
aRoot
)
;
void
StyleNewChildren
(
dom
:
:
Element
*
aParent
)
;
void
StyleSubtreeForReconstruct
(
dom
:
:
Element
*
aRoot
)
;
void
NoteStyleSheetsChanged
(
)
;
#
ifdef
DEBUG
void
AssertTreeIsClean
(
)
;
#
else
void
AssertTreeIsClean
(
)
{
}
#
endif
void
RebuildData
(
)
;
already_AddRefed
<
ServoComputedValues
>
ResolveServoStyle
(
dom
:
:
Element
*
aElement
)
;
bool
GetKeyframesForName
(
const
nsString
&
aName
const
nsTimingFunction
&
aTimingFunction
const
ServoComputedValues
*
aComputedValues
nsTArray
<
Keyframe
>
&
aKeyframes
)
;
nsTArray
<
ComputedKeyframeValues
>
GetComputedKeyframeValuesFor
(
const
nsTArray
<
Keyframe
>
&
aKeyframes
dom
:
:
Element
*
aElement
const
ServoComputedValuesWithParent
&
aServoValues
)
;
bool
AppendFontFaceRules
(
nsTArray
<
nsFontFaceRuleContainer
>
&
aArray
)
;
nsCSSCounterStyleRule
*
CounterStyleRuleForName
(
nsIAtom
*
aName
)
;
already_AddRefed
<
ServoComputedValues
>
GetBaseComputedValuesForElement
(
dom
:
:
Element
*
aElement
CSSPseudoElementType
aPseudoType
)
;
already_AddRefed
<
ServoComputedValues
>
ResolveForDeclarations
(
ServoComputedValuesBorrowedOrNull
aParentOrNull
RawServoDeclarationBlockBorrowed
aDeclarations
)
;
already_AddRefed
<
RawServoAnimationValue
>
ComputeAnimationValue
(
RawServoDeclarationBlock
*
aDeclaration
const
ServoComputedValuesWithParent
&
aComputedValues
)
;
void
AppendTask
(
PostTraversalTask
aTask
)
{
MOZ_ASSERT
(
IsInServoTraversal
(
)
)
;
AssertIsMainThreadOrServoFontMetricsLocked
(
)
;
mPostTraversalTasks
.
AppendElement
(
aTask
)
;
}
private
:
class
MOZ_STACK_CLASS
AutoSetInServoTraversal
{
public
:
explicit
AutoSetInServoTraversal
(
ServoStyleSet
*
aSet
)
:
mSet
(
aSet
)
{
MOZ_ASSERT
(
!
sInServoTraversal
)
;
MOZ_ASSERT
(
aSet
)
;
sInServoTraversal
=
aSet
;
}
~
AutoSetInServoTraversal
(
)
{
MOZ_ASSERT
(
sInServoTraversal
)
;
sInServoTraversal
=
nullptr
;
mSet
-
>
RunPostTraversalTasks
(
)
;
}
private
:
ServoStyleSet
*
mSet
;
}
;
already_AddRefed
<
nsStyleContext
>
GetContext
(
already_AddRefed
<
ServoComputedValues
>
nsStyleContext
*
aParentContext
nsIAtom
*
aPseudoTag
CSSPseudoElementType
aPseudoType
dom
:
:
Element
*
aElementForAnimation
)
;
already_AddRefed
<
nsStyleContext
>
GetContext
(
nsIContent
*
aContent
nsStyleContext
*
aParentContext
nsIAtom
*
aPseudoTag
CSSPseudoElementType
aPseudoType
LazyComputeBehavior
aMayCompute
)
;
const
SnapshotTable
&
Snapshots
(
)
;
void
ResolveMappedAttrDeclarationBlocks
(
)
;
bool
PrepareAndTraverseSubtree
(
RawGeckoElementBorrowed
aRoot
TraversalRootBehavior
aRootBehavior
TraversalRestyleBehavior
aRestyleBehavior
)
;
void
ClearNonInheritingStyleContexts
(
)
;
void
PreTraverse
(
dom
:
:
Element
*
aRoot
=
nullptr
)
;
void
PreTraverseSync
(
)
;
void
RebuildStylist
(
)
;
void
MaybeRebuildStylist
(
)
{
if
(
mStylistMayNeedRebuild
)
{
RebuildStylist
(
)
;
}
}
already_AddRefed
<
ServoComputedValues
>
ResolveStyleLazily
(
dom
:
:
Element
*
aElement
CSSPseudoElementType
aPseudoType
)
;
void
RunPostTraversalTasks
(
)
;
void
PrependSheetOfType
(
SheetType
aType
ServoStyleSheet
*
aSheet
)
;
void
AppendSheetOfType
(
SheetType
aType
ServoStyleSheet
*
aSheet
)
;
void
InsertSheetOfType
(
SheetType
aType
ServoStyleSheet
*
aSheet
ServoStyleSheet
*
aBeforeSheet
)
;
void
RemoveSheetOfType
(
SheetType
aType
ServoStyleSheet
*
aSheet
)
;
nsPresContext
*
mPresContext
;
UniquePtr
<
RawServoStyleSet
>
mRawSet
;
EnumeratedArray
<
SheetType
SheetType
:
:
Count
nsTArray
<
RefPtr
<
ServoStyleSheet
>
>
>
mSheets
;
bool
mAllowResolveStaleStyles
;
bool
mAuthorStyleDisabled
;
bool
mStylistMayNeedRebuild
;
EnumeratedArray
<
nsCSSAnonBoxes
:
:
NonInheriting
nsCSSAnonBoxes
:
:
NonInheriting
:
:
_Count
RefPtr
<
nsStyleContext
>
>
mNonInheritingStyleContexts
;
nsTArray
<
PostTraversalTask
>
mPostTraversalTasks
;
static
ServoStyleSet
*
sInServoTraversal
;
}
;
}
#
endif
