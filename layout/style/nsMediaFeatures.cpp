#
include
"
nsMediaFeatures
.
h
"
#
include
"
nsGkAtoms
.
h
"
#
include
"
nsStyleConsts
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsCSSProps
.
h
"
#
include
"
nsCSSValue
.
h
"
#
include
"
mozilla
/
LookAndFeel
.
h
"
#
include
"
nsDeviceContext
.
h
"
#
include
"
nsIBaseWindow
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsIPrintSettings
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
DocumentInlines
.
h
"
#
include
"
nsIWidget
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
mozilla
/
RelativeLuminanceUtils
.
h
"
#
include
"
mozilla
/
StaticPrefs_browser
.
h
"
#
include
"
mozilla
/
StyleSheet
.
h
"
#
include
"
mozilla
/
StyleSheetInlines
.
h
"
#
include
"
mozilla
/
GeckoBindings
.
h
"
#
include
"
PreferenceSheet
.
h
"
#
include
"
nsGlobalWindowOuter
.
h
"
using
namespace
mozilla
;
using
mozilla
:
:
dom
:
:
Document
;
static
nsTArray
<
const
nsStaticAtom
*
>
*
sSystemMetrics
=
nullptr
;
static
nsSize
GetSize
(
const
Document
*
aDocument
)
{
nsPresContext
*
pc
=
aDocument
-
>
GetPresContext
(
)
;
if
(
!
pc
)
{
return
{
}
;
}
if
(
pc
-
>
IsRootPaginatedDocument
(
)
)
{
return
pc
-
>
GetPageSize
(
)
;
}
return
pc
-
>
GetVisibleArea
(
)
.
Size
(
)
;
}
static
nsSize
GetDeviceSize
(
const
Document
*
aDocument
)
{
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
return
GetSize
(
aDocument
)
;
}
Maybe
<
CSSIntSize
>
deviceSize
=
nsGlobalWindowOuter
:
:
GetRDMDeviceSize
(
*
aDocument
)
;
if
(
deviceSize
.
isSome
(
)
)
{
return
CSSPixel
:
:
ToAppUnits
(
deviceSize
.
value
(
)
)
;
}
nsPresContext
*
pc
=
aDocument
-
>
GetPresContext
(
)
;
if
(
!
pc
)
{
return
{
}
;
}
if
(
pc
-
>
IsRootPaginatedDocument
(
)
)
{
return
pc
-
>
GetPageSize
(
)
;
}
nsSize
size
;
pc
-
>
DeviceContext
(
)
-
>
GetDeviceSurfaceDimensions
(
size
.
width
size
.
height
)
;
return
size
;
}
bool
Gecko_MediaFeatures_IsResourceDocument
(
const
Document
*
aDocument
)
{
return
aDocument
-
>
IsResourceDoc
(
)
;
}
static
nsDeviceContext
*
GetDeviceContextFor
(
const
Document
*
aDocument
)
{
nsPresContext
*
pc
=
aDocument
-
>
GetPresContext
(
)
;
if
(
!
pc
)
{
return
nullptr
;
}
return
pc
-
>
DeviceContext
(
)
;
}
void
Gecko_MediaFeatures_GetDeviceSize
(
const
Document
*
aDocument
nscoord
*
aWidth
nscoord
*
aHeight
)
{
nsSize
size
=
GetDeviceSize
(
aDocument
)
;
*
aWidth
=
size
.
width
;
*
aHeight
=
size
.
height
;
}
uint32_t
Gecko_MediaFeatures_GetMonochromeBitsPerPixel
(
const
Document
*
aDocument
)
{
static
constexpr
uint32_t
kDefaultMonochromeBpp
=
8
;
nsPresContext
*
pc
=
aDocument
-
>
GetPresContext
(
)
;
if
(
!
pc
)
{
return
0
;
}
nsIPrintSettings
*
ps
=
pc
-
>
GetPrintSettings
(
)
;
if
(
!
ps
)
{
return
0
;
}
bool
color
=
true
;
ps
-
>
GetPrintInColor
(
&
color
)
;
return
color
?
0
:
kDefaultMonochromeBpp
;
}
uint32_t
Gecko_MediaFeatures_GetColorDepth
(
const
Document
*
aDocument
)
{
if
(
Gecko_MediaFeatures_GetMonochromeBitsPerPixel
(
aDocument
)
!
=
0
)
{
return
0
;
}
uint32_t
depth
=
24
;
if
(
!
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
if
(
nsDeviceContext
*
dx
=
GetDeviceContextFor
(
aDocument
)
)
{
dx
-
>
GetDepth
(
depth
)
;
}
}
return
depth
/
3
;
}
float
Gecko_MediaFeatures_GetResolution
(
const
Document
*
aDocument
)
{
nsPresContext
*
pc
=
aDocument
-
>
GetPresContext
(
)
;
if
(
!
pc
)
{
return
1
.
;
}
if
(
pc
-
>
GetOverrideDPPX
(
)
>
0
.
)
{
return
pc
-
>
GetOverrideDPPX
(
)
;
}
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
return
pc
-
>
DeviceContext
(
)
-
>
GetFullZoom
(
)
;
}
return
float
(
AppUnitsPerCSSPixel
(
)
)
/
pc
-
>
DeviceContext
(
)
-
>
AppUnitsPerDevPixel
(
)
;
}
static
const
Document
*
TopDocument
(
const
Document
*
aDocument
)
{
const
Document
*
current
=
aDocument
;
while
(
const
Document
*
parent
=
current
-
>
GetInProcessParentDocument
(
)
)
{
current
=
parent
;
}
return
current
;
}
StyleDisplayMode
Gecko_MediaFeatures_GetDisplayMode
(
const
Document
*
aDocument
)
{
const
Document
*
rootDocument
=
TopDocument
(
aDocument
)
;
nsCOMPtr
<
nsISupports
>
container
=
rootDocument
-
>
GetContainer
(
)
;
if
(
nsCOMPtr
<
nsIBaseWindow
>
baseWindow
=
do_QueryInterface
(
container
)
)
{
nsCOMPtr
<
nsIWidget
>
mainWidget
;
baseWindow
-
>
GetMainWidget
(
getter_AddRefs
(
mainWidget
)
)
;
if
(
mainWidget
&
&
mainWidget
-
>
SizeMode
(
)
=
=
nsSizeMode_Fullscreen
)
{
return
StyleDisplayMode
:
:
Fullscreen
;
}
}
static_assert
(
nsIDocShell
:
:
DISPLAY_MODE_BROWSER
=
=
static_cast
<
int32_t
>
(
StyleDisplayMode
:
:
Browser
)
&
&
nsIDocShell
:
:
DISPLAY_MODE_MINIMAL_UI
=
=
static_cast
<
int32_t
>
(
StyleDisplayMode
:
:
MinimalUi
)
&
&
nsIDocShell
:
:
DISPLAY_MODE_STANDALONE
=
=
static_cast
<
int32_t
>
(
StyleDisplayMode
:
:
Standalone
)
&
&
nsIDocShell
:
:
DISPLAY_MODE_FULLSCREEN
=
=
static_cast
<
int32_t
>
(
StyleDisplayMode
:
:
Fullscreen
)
"
nsIDocShell
display
modes
must
mach
nsStyleConsts
.
h
"
)
;
nsIDocShell
*
docShell
=
rootDocument
-
>
GetDocShell
(
)
;
if
(
!
docShell
)
{
return
StyleDisplayMode
:
:
Browser
;
}
return
static_cast
<
StyleDisplayMode
>
(
docShell
-
>
GetDisplayMode
(
)
)
;
}
bool
Gecko_MediaFeatures_HasSystemMetric
(
const
Document
*
aDocument
nsAtom
*
aMetric
bool
aIsAccessibleFromContent
)
{
if
(
aIsAccessibleFromContent
&
&
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
return
false
;
}
nsMediaFeatures
:
:
InitSystemMetrics
(
)
;
return
sSystemMetrics
-
>
IndexOf
(
aMetric
)
!
=
sSystemMetrics
-
>
NoIndex
;
}
nsAtom
*
Gecko_MediaFeatures_GetOperatingSystemVersion
(
const
Document
*
aDocument
)
{
using
OperatingSystemVersion
=
LookAndFeel
:
:
OperatingSystemVersion
;
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
return
nullptr
;
}
int32_t
metricResult
;
if
(
NS_FAILED
(
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
OperatingSystemVersionIdentifier
&
metricResult
)
)
)
{
return
nullptr
;
}
switch
(
OperatingSystemVersion
(
metricResult
)
)
{
case
OperatingSystemVersion
:
:
Windows7
:
return
nsGkAtoms
:
:
windows_win7
;
case
OperatingSystemVersion
:
:
Windows8
:
return
nsGkAtoms
:
:
windows_win8
;
case
OperatingSystemVersion
:
:
Windows10
:
return
nsGkAtoms
:
:
windows_win10
;
default
:
return
nullptr
;
}
}
bool
Gecko_MediaFeatures_PrefersReducedMotion
(
const
Document
*
aDocument
)
{
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
return
false
;
}
return
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
PrefersReducedMotion
0
)
=
=
1
;
}
StylePrefersColorScheme
Gecko_MediaFeatures_PrefersColorScheme
(
const
Document
*
aDocument
)
{
return
aDocument
-
>
PrefersColorScheme
(
)
;
}
StyleContrastPref
Gecko_MediaFeatures_PrefersContrast
(
const
Document
*
aDocument
const
bool
aForcedColors
)
{
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
return
StyleContrastPref
:
:
NoPreference
;
}
if
(
!
!
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
UseAccessibilityTheme
0
)
)
{
return
StyleContrastPref
:
:
More
;
}
return
StyleContrastPref
:
:
NoPreference
;
}
static
PointerCapabilities
GetPointerCapabilities
(
const
Document
*
aDocument
LookAndFeel
:
:
IntID
aID
)
{
MOZ_ASSERT
(
aID
=
=
LookAndFeel
:
:
IntID
:
:
PrimaryPointerCapabilities
|
|
aID
=
=
LookAndFeel
:
:
IntID
:
:
AllPointerCapabilities
)
;
MOZ_ASSERT
(
aDocument
)
;
if
(
nsIDocShell
*
docShell
=
aDocument
-
>
GetDocShell
(
)
)
{
if
(
docShell
-
>
GetTouchEventsOverride
(
)
=
=
nsIDocShell
:
:
TOUCHEVENTS_OVERRIDE_ENABLED
)
{
return
PointerCapabilities
:
:
Coarse
;
}
}
const
PointerCapabilities
kDefaultCapabilities
=
#
ifdef
ANDROID
PointerCapabilities
:
:
Coarse
;
#
else
PointerCapabilities
:
:
Fine
|
PointerCapabilities
:
:
Hover
;
#
endif
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
aDocument
)
)
{
return
kDefaultCapabilities
;
}
int32_t
intValue
;
nsresult
rv
=
LookAndFeel
:
:
GetInt
(
aID
&
intValue
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
kDefaultCapabilities
;
}
return
static_cast
<
PointerCapabilities
>
(
intValue
)
;
}
PointerCapabilities
Gecko_MediaFeatures_PrimaryPointerCapabilities
(
const
Document
*
aDocument
)
{
return
GetPointerCapabilities
(
aDocument
LookAndFeel
:
:
IntID
:
:
PrimaryPointerCapabilities
)
;
}
PointerCapabilities
Gecko_MediaFeatures_AllPointerCapabilities
(
const
Document
*
aDocument
)
{
return
GetPointerCapabilities
(
aDocument
LookAndFeel
:
:
IntID
:
:
AllPointerCapabilities
)
;
}
void
nsMediaFeatures
:
:
InitSystemMetrics
(
)
{
if
(
sSystemMetrics
)
return
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
sSystemMetrics
=
new
nsTArray
<
const
nsStaticAtom
*
>
;
int32_t
metricResult
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
ScrollArrowStyle
)
;
if
(
metricResult
&
LookAndFeel
:
:
eScrollArrow_StartBackward
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_scrollbar_start_backward
)
;
}
if
(
metricResult
&
LookAndFeel
:
:
eScrollArrow_StartForward
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_scrollbar_start_forward
)
;
}
if
(
metricResult
&
LookAndFeel
:
:
eScrollArrow_EndBackward
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_scrollbar_end_backward
)
;
}
if
(
metricResult
&
LookAndFeel
:
:
eScrollArrow_EndForward
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_scrollbar_end_forward
)
;
}
metricResult
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
ScrollSliderStyle
)
;
if
(
metricResult
!
=
LookAndFeel
:
:
eScrollThumbStyle_Normal
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_scrollbar_thumb_proportional
)
;
}
metricResult
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
UseOverlayScrollbars
)
;
if
(
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_overlay_scrollbars
)
;
}
metricResult
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
MenuBarDrag
)
;
if
(
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_menubar_drag
)
;
}
nsresult
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
WindowsDefaultTheme
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_windows_default_theme
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
MacGraphiteTheme
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_mac_graphite_theme
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
MacYosemiteTheme
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_mac_yosemite_theme
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
WindowsAccentColorInTitlebar
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_windows_accent_color_in_titlebar
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
DWMCompositor
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_windows_compositor
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
WindowsGlass
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_windows_glass
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
WindowsClassic
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_windows_classic
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
SwipeAnimationEnabled
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_swipe_animation_enabled
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
GTKCSDAvailable
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_gtk_csd_available
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
GTKCSDHideTitlebarByDefault
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_gtk_csd_hide_titlebar_by_default
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
GTKCSDTransparentBackground
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_gtk_csd_transparent_background
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
GTKCSDMinimizeButton
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_gtk_csd_minimize_button
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
GTKCSDMaximizeButton
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_gtk_csd_maximize_button
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
GTKCSDCloseButton
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_gtk_csd_close_button
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
GTKCSDReversedPlacement
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_gtk_csd_reversed_placement
)
;
}
rv
=
LookAndFeel
:
:
GetInt
(
LookAndFeel
:
:
IntID
:
:
SystemUsesDarkTheme
&
metricResult
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
metricResult
)
{
sSystemMetrics
-
>
AppendElement
(
(
nsStaticAtom
*
)
nsGkAtoms
:
:
_moz_system_dark_theme
)
;
}
}
void
nsMediaFeatures
:
:
FreeSystemMetrics
(
)
{
delete
sSystemMetrics
;
sSystemMetrics
=
nullptr
;
}
void
nsMediaFeatures
:
:
Shutdown
(
)
{
FreeSystemMetrics
(
)
;
}
