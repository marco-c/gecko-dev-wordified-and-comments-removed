#
ifndef
mozilla_dom_FontFace_h
#
define
mozilla_dom_FontFace_h
#
include
"
mozilla
/
dom
/
FontFaceBinding
.
h
"
#
include
"
mozilla
/
FontPropertyTypes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
ServoStyleConsts
.
h
"
#
include
"
gfxUserFontSet
.
h
"
#
include
"
nsCSSPropertyID
.
h
"
#
include
"
nsCSSValue
.
h
"
#
include
"
nsWrapperCache
.
h
"
class
gfxFontFaceBufferSource
;
struct
RawServoFontFaceRule
;
namespace
mozilla
{
struct
CSSFontFaceDescriptors
;
class
PostTraversalTask
;
namespace
dom
{
class
CSSFontFaceRule
;
class
FontFaceBufferSource
;
struct
FontFaceDescriptors
;
class
FontFaceSet
;
class
Promise
;
class
UTF8StringOrArrayBufferOrArrayBufferView
;
}
}
namespace
mozilla
{
namespace
dom
{
class
FontFace
final
:
public
nsISupports
public
nsWrapperCache
{
friend
class
mozilla
:
:
PostTraversalTask
;
friend
class
FontFaceBufferSource
;
friend
class
Entry
;
public
:
class
Entry
final
:
public
gfxUserFontEntry
{
friend
class
FontFace
;
public
:
Entry
(
gfxUserFontSet
*
aFontSet
const
nsTArray
<
gfxFontFaceSrc
>
&
aFontFaceSrcList
WeightRange
aWeight
StretchRange
aStretch
SlantStyleRange
aStyle
const
nsTArray
<
gfxFontFeature
>
&
aFeatureSettings
const
nsTArray
<
gfxFontVariation
>
&
aVariationSettings
uint32_t
aLanguageOverride
gfxCharacterMap
*
aUnicodeRanges
StyleFontDisplay
aFontDisplay
RangeFlags
aRangeFlags
)
:
gfxUserFontEntry
(
aFontSet
aFontFaceSrcList
aWeight
aStretch
aStyle
aFeatureSettings
aVariationSettings
aLanguageOverride
aUnicodeRanges
aFontDisplay
aRangeFlags
)
{
}
virtual
void
SetLoadState
(
UserFontLoadState
aLoadState
)
override
;
virtual
void
GetUserFontSets
(
nsTArray
<
gfxUserFontSet
*
>
&
aResult
)
override
;
const
AutoTArray
<
FontFace
*
1
>
&
GetFontFaces
(
)
{
return
mFontFaces
;
}
protected
:
AutoTArray
<
FontFace
*
1
>
mFontFaces
;
}
;
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS
(
FontFace
)
nsISupports
*
GetParentObject
(
)
const
{
return
mParent
;
}
virtual
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
static
already_AddRefed
<
FontFace
>
CreateForRule
(
nsISupports
*
aGlobal
FontFaceSet
*
aFontFaceSet
RawServoFontFaceRule
*
aRule
)
;
RawServoFontFaceRule
*
GetRule
(
)
{
return
mRule
;
}
bool
HasLocalSrc
(
)
const
;
Maybe
<
StyleComputedFontWeightRange
>
GetFontWeight
(
)
const
;
Maybe
<
StyleComputedFontStretchRange
>
GetFontStretch
(
)
const
;
Maybe
<
StyleComputedFontStyleDescriptor
>
GetFontStyle
(
)
const
;
Maybe
<
StyleFontDisplay
>
GetFontDisplay
(
)
const
;
void
GetFontFeatureSettings
(
nsTArray
<
gfxFontFeature
>
&
)
const
;
void
GetFontVariationSettings
(
nsTArray
<
gfxFontVariation
>
&
)
const
;
void
GetSources
(
nsTArray
<
StyleFontFaceSourceListComponent
>
&
)
const
;
Maybe
<
StyleFontLanguageOverride
>
GetFontLanguageOverride
(
)
const
;
Maybe
<
StylePercentage
>
GetAscentOverride
(
)
const
;
Maybe
<
StylePercentage
>
GetDescentOverride
(
)
const
;
Maybe
<
StylePercentage
>
GetLineGapOverride
(
)
const
;
gfxUserFontEntry
*
CreateUserFontEntry
(
)
;
gfxUserFontEntry
*
GetUserFontEntry
(
)
const
{
return
mUserFontEntry
;
}
void
SetUserFontEntry
(
gfxUserFontEntry
*
aEntry
)
;
bool
IsInFontFaceSet
(
FontFaceSet
*
aFontFaceSet
)
const
;
void
AddFontFaceSet
(
FontFaceSet
*
aFontFaceSet
)
;
void
RemoveFontFaceSet
(
FontFaceSet
*
aFontFaceSet
)
;
FontFaceSet
*
GetPrimaryFontFaceSet
(
)
const
{
return
mFontFaceSet
;
}
nsAtom
*
GetFamilyName
(
)
const
;
bool
HasRule
(
)
const
{
return
mRule
;
}
void
DisconnectFromRule
(
)
;
bool
HasFontData
(
)
const
;
already_AddRefed
<
gfxFontFaceBufferSource
>
CreateBufferSource
(
)
;
bool
GetData
(
uint8_t
*
&
aBuffer
uint32_t
&
aLength
)
;
gfxCharacterMap
*
GetUnicodeRangeAsCharacterMap
(
)
;
static
already_AddRefed
<
FontFace
>
Constructor
(
const
GlobalObject
&
aGlobal
const
nsACString
&
aFamily
const
UTF8StringOrArrayBufferOrArrayBufferView
&
aSource
const
FontFaceDescriptors
&
aDescriptors
ErrorResult
&
aRV
)
;
void
GetFamily
(
nsACString
&
aResult
)
;
void
SetFamily
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetStyle
(
nsACString
&
aResult
)
;
void
SetStyle
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetWeight
(
nsACString
&
aResult
)
;
void
SetWeight
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetStretch
(
nsACString
&
aResult
)
;
void
SetStretch
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetUnicodeRange
(
nsACString
&
aResult
)
;
void
SetUnicodeRange
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetVariant
(
nsACString
&
aResult
)
;
void
SetVariant
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetFeatureSettings
(
nsACString
&
aResult
)
;
void
SetFeatureSettings
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetVariationSettings
(
nsACString
&
aResult
)
;
void
SetVariationSettings
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetDisplay
(
nsACString
&
aResult
)
;
void
SetDisplay
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetAscentOverride
(
nsACString
&
aResult
)
;
void
SetAscentOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetDescentOverride
(
nsACString
&
aResult
)
;
void
SetDescentOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
void
GetLineGapOverride
(
nsACString
&
aResult
)
;
void
SetLineGapOverride
(
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
FontFaceLoadStatus
Status
(
)
;
Promise
*
Load
(
ErrorResult
&
aRv
)
;
Promise
*
GetLoaded
(
ErrorResult
&
aRv
)
;
private
:
FontFace
(
nsISupports
*
aParent
FontFaceSet
*
aFontFaceSet
)
;
~
FontFace
(
)
;
void
InitializeSource
(
const
UTF8StringOrArrayBufferOrArrayBufferView
&
)
;
void
DoLoad
(
)
;
bool
SetDescriptor
(
nsCSSFontDesc
aFontDesc
const
nsACString
&
aValue
ErrorResult
&
aRv
)
;
bool
SetDescriptors
(
const
nsACString
&
aFamily
const
FontFaceDescriptors
&
aDescriptors
)
;
void
DescriptorUpdated
(
)
;
void
SetStatus
(
FontFaceLoadStatus
aStatus
)
;
void
GetDesc
(
nsCSSFontDesc
aDescID
nsACString
&
aResult
)
const
;
already_AddRefed
<
URLExtraData
>
GetURLExtraData
(
)
const
;
RawServoFontFaceRule
*
GetData
(
)
const
{
return
HasRule
(
)
?
mRule
:
mDescriptors
;
}
void
TakeBuffer
(
uint8_t
*
&
aBuffer
uint32_t
&
aLength
)
;
void
Reject
(
nsresult
aResult
)
;
void
EnsurePromise
(
)
;
void
DoResolve
(
)
;
void
DoReject
(
nsresult
aResult
)
;
nsCOMPtr
<
nsISupports
>
mParent
;
RefPtr
<
Promise
>
mLoaded
;
nsresult
mLoadedRejection
;
RefPtr
<
RawServoFontFaceRule
>
mRule
;
RefPtr
<
Entry
>
mUserFontEntry
;
FontFaceLoadStatus
mStatus
;
enum
SourceType
{
eSourceType_FontFaceRule
=
1
eSourceType_URLs
eSourceType_Buffer
}
;
SourceType
mSourceType
;
uint8_t
*
mSourceBuffer
;
uint32_t
mSourceBufferLength
;
RefPtr
<
RawServoFontFaceRule
>
mDescriptors
;
RefPtr
<
gfxCharacterMap
>
mUnicodeRange
;
RefPtr
<
FontFaceSet
>
mFontFaceSet
;
nsTArray
<
RefPtr
<
FontFaceSet
>
>
mOtherFontFaceSets
;
bool
mUnicodeRangeDirty
;
bool
mInFontFaceSet
;
}
;
}
}
#
endif
