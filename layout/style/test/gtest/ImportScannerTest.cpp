#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
ImportScanner
.
h
"
#
include
"
mozilla
/
StaticPrefs_layout
.
h
"
using
namespace
mozilla
;
static
nsTArray
<
nsString
>
Scan
(
const
char
*
aCssCode
)
{
nsTArray
<
nsString
>
urls
;
ImportScanner
scanner
;
scanner
.
Start
(
)
;
urls
.
AppendElements
(
scanner
.
Scan
(
NS_ConvertUTF8toUTF16
(
aCssCode
)
)
)
;
urls
.
AppendElements
(
scanner
.
Stop
(
)
)
;
return
urls
;
}
TEST
(
ImportScanner
Simple
)
{
auto
urls
=
Scan
(
"
/
*
Something
something
*
/
"
"
charset
\
"
utf
-
8
\
"
;
"
"
import
url
(
bar
)
;
"
"
import
uRL
(
baz
)
;
"
"
import
\
"
bazz
)
\
"
"
)
;
ASSERT_EQ
(
urls
.
Length
(
)
3u
)
;
ASSERT_EQ
(
urls
[
0
]
u
"
bar
"
_ns
)
;
ASSERT_EQ
(
urls
[
1
]
u
"
baz
"
_ns
)
;
ASSERT_EQ
(
urls
[
2
]
u
"
bazz
)
"
_ns
)
;
}
TEST
(
ImportScanner
UrlWithQuotes
)
{
auto
urls
=
Scan
(
"
/
*
Something
something
*
/
"
"
import
url
(
\
"
bar
\
"
)
;
"
"
import
\
tuRL
(
\
"
baz
\
"
)
;
"
"
imPort
\
turL
(
'
bazz
'
)
;
"
"
something
else
{
}
"
"
import
\
turL
(
'
bazz
'
)
;
"
)
;
ASSERT_EQ
(
urls
.
Length
(
)
3u
)
;
ASSERT_EQ
(
urls
[
0
]
u
"
bar
"
_ns
)
;
ASSERT_EQ
(
urls
[
1
]
u
"
baz
"
_ns
)
;
ASSERT_EQ
(
urls
[
2
]
u
"
bazz
"
_ns
)
;
}
TEST
(
ImportScanner
MediaIsIgnored
)
{
auto
urls
=
Scan
(
"
chArset
\
"
utf
-
8
\
"
;
"
"
import
url
(
\
"
bar
\
"
)
print
;
"
"
/
*
Something
something
*
/
"
"
import
\
tuRL
(
\
"
baz
\
"
)
(
min
-
width
:
100px
)
;
"
"
import
\
turL
(
bazz
)
(
max
-
width
:
100px
)
;
"
)
;
ASSERT_EQ
(
urls
.
Length
(
)
3u
)
;
ASSERT_EQ
(
urls
[
0
]
u
"
bar
"
_ns
)
;
ASSERT_EQ
(
urls
[
1
]
u
"
baz
"
_ns
)
;
ASSERT_EQ
(
urls
[
2
]
u
"
bazz
"
_ns
)
;
}
TEST
(
ImportScanner
Layers
)
{
auto
urls
=
Scan
(
"
layer
foo
bar
;
\
n
"
"
import
url
(
\
"
bar
\
"
)
layer
(
foo
)
;
"
"
import
url
(
\
"
baz
\
"
)
;
"
"
import
url
(
bazz
)
;
"
"
layer
block
{
}
"
"
import
\
turL
(
'
bazzz
'
)
;
"
)
;
ASSERT_EQ
(
urls
.
Length
(
)
3u
)
;
ASSERT_EQ
(
urls
[
0
]
u
"
bar
"
_ns
)
;
ASSERT_EQ
(
urls
[
1
]
u
"
baz
"
_ns
)
;
ASSERT_EQ
(
urls
[
2
]
u
"
bazz
"
_ns
)
;
}
TEST
(
ImportScanner
Supports
)
{
auto
urls
=
Scan
(
"
import
url
(
bar
)
supports
(
display
:
block
)
;
"
"
import
url
(
baz
)
supports
(
foo
:
bar
)
;
"
"
import
url
(
bazz
)
supports
(
(
display
:
flex
)
and
(
display
:
block
)
)
;
"
"
import
url
(
bazzz
)
supports
(
selector
(
foo
:
bar
(
baz
)
)
)
;
"
"
import
url
(
bazzzz
)
layer
(
A
.
B
)
supports
(
display
:
flex
)
(
max
-
width
:
"
"
100px
)
"
)
;
if
(
StaticPrefs
:
:
layout_css_import_supports_enabled
(
)
)
{
ASSERT_EQ
(
urls
.
Length
(
)
3u
)
;
ASSERT_EQ
(
urls
[
0
]
u
"
bar
"
_ns
)
;
ASSERT_EQ
(
urls
[
1
]
u
"
bazz
"
_ns
)
;
ASSERT_EQ
(
urls
[
2
]
u
"
bazzzz
"
_ns
)
;
}
else
{
ASSERT_EQ
(
urls
.
Length
(
)
5u
)
;
ASSERT_EQ
(
urls
[
0
]
u
"
bar
"
_ns
)
;
ASSERT_EQ
(
urls
[
1
]
u
"
baz
"
_ns
)
;
ASSERT_EQ
(
urls
[
2
]
u
"
bazz
"
_ns
)
;
ASSERT_EQ
(
urls
[
3
]
u
"
bazzz
"
_ns
)
;
ASSERT_EQ
(
urls
[
4
]
u
"
bazzzz
"
_ns
)
;
}
}
