var
mediaQueryCSSLine
=
function
(
key
val
color
)
{
return
(
"
media
(
"
+
key
+
"
:
"
+
val
+
"
)
{
#
"
+
key
+
"
{
background
-
color
:
"
+
color
+
"
;
}
}
\
n
"
)
;
}
;
var
green
=
"
rgb
(
0
128
0
)
"
;
var
blue
=
"
rgb
(
0
0
255
)
"
;
var
pushPref
=
function
(
key
value
)
{
return
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
key
value
]
]
}
)
;
}
;
var
checkColorForPref
=
async
function
(
setting
testDivs
expectedColor
)
{
await
pushPref
(
"
privacy
.
resistFingerprinting
"
setting
)
;
for
(
let
div
of
testDivs
)
{
let
color
=
window
.
getComputedStyle
(
div
)
.
backgroundColor
;
is
(
color
expectedColor
"
background
for
'
"
+
div
.
id
+
"
'
is
"
+
color
)
;
}
}
;
var
test
=
async
function
(
spoofedWidth
spoofedHeight
)
{
let
spoofedScreen
;
let
sizes
=
[
[
1920
1080
]
[
3840
2160
]
[
7680
4320
]
]
;
for
(
let
s
of
sizes
)
{
spoofedScreen
=
s
;
if
(
window
.
outerWidth
<
=
s
[
0
]
&
&
window
.
outerHeight
<
=
s
[
1
]
)
{
break
;
}
}
var
expected_values
=
[
[
"
device
-
aspect
-
ratio
"
{
screen
.
width
}
/
{
screen
.
height
}
{
spoofedScreen
[
0
]
}
/
{
spoofedScreen
[
1
]
}
]
[
"
device
-
height
"
{
screen
.
height
}
px
{
spoofedScreen
[
1
]
}
px
]
[
"
device
-
width
"
{
screen
.
width
}
px
{
spoofedScreen
[
0
]
}
px
]
]
;
let
skipTest
=
false
;
for
(
let
[
key
offVal
onVal
]
of
expected_values
)
{
if
(
offVal
=
=
onVal
)
{
todo
(
false
"
Unable
to
test
because
'
"
+
key
+
"
'
is
invariant
"
)
;
return
;
}
}
let
css
=
"
.
test
{
margin
:
1em
;
padding
:
1em
;
color
:
white
;
width
:
max
-
content
;
font
:
2em
monospace
}
\
n
"
;
let
testDivs
=
[
]
;
for
(
let
[
key
offVal
onVal
]
of
expected_values
)
{
let
div
=
document
.
createElement
(
"
div
"
)
;
div
.
textContent
=
key
;
div
.
setAttribute
(
"
class
"
"
test
"
)
;
div
.
setAttribute
(
"
id
"
key
)
;
testDivs
.
push
(
div
)
;
document
.
getElementById
(
"
display
"
)
.
appendChild
(
div
)
;
css
+
=
mediaQueryCSSLine
(
key
onVal
"
green
"
)
;
css
+
=
mediaQueryCSSLine
(
key
offVal
"
blue
"
)
;
}
document
.
getElementById
(
"
test
-
css
"
)
.
textContent
=
css
;
await
checkColorForPref
(
true
testDivs
green
)
;
await
checkColorForPref
(
false
testDivs
blue
)
;
await
checkColorForPref
(
true
testDivs
green
)
;
}
;
