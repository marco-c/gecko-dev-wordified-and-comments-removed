#
ifndef
mozilla_ServoUtils_h
#
define
mozilla_ServoUtils_h
#
include
"
mozilla
/
TypeTraits
.
h
"
#
include
"
MainThreadUtils
.
h
"
namespace
mozilla
{
void
AssertIsMainThreadOrServoFontMetricsLocked
(
)
;
class
ServoStyleSet
;
extern
ServoStyleSet
*
sInServoTraversal
;
inline
bool
IsInServoTraversal
(
)
{
MOZ_ASSERT
(
sInServoTraversal
|
|
NS_IsMainThread
(
)
)
;
return
sInServoTraversal
;
}
}
#
ifdef
MOZ_STYLO
#
define
MOZ_DECL_STYLO_CHECK_METHODS
\
bool
IsGecko
(
)
const
{
return
!
IsServo
(
)
;
}
\
bool
IsServo
(
)
const
{
return
mType
=
=
StyleBackendType
:
:
Servo
;
}
#
else
#
define
MOZ_DECL_STYLO_CHECK_METHODS
\
bool
IsGecko
(
)
const
{
return
true
;
}
\
bool
IsServo
(
)
const
{
return
false
;
}
#
endif
#
define
MOZ_DECL_STYLO_CONVERT_METHODS
(
geckotype_
servotype_
)
\
inline
geckotype_
*
AsGecko
(
)
;
\
inline
servotype_
*
AsServo
(
)
;
\
inline
const
geckotype_
*
AsGecko
(
)
const
;
\
inline
const
servotype_
*
AsServo
(
)
const
;
\
inline
geckotype_
*
GetAsGecko
(
)
;
\
inline
servotype_
*
GetAsServo
(
)
;
\
inline
const
geckotype_
*
GetAsGecko
(
)
const
;
\
inline
const
servotype_
*
GetAsServo
(
)
const
;
#
define
MOZ_DECL_STYLO_METHODS
(
geckotype_
servotype_
)
\
MOZ_DECL_STYLO_CHECK_METHODS
\
MOZ_DECL_STYLO_CONVERT_METHODS
(
geckotype_
servotype_
)
#
define
MOZ_DEFINE_STYLO_METHODS
(
type_
geckotype_
servotype_
)
\
geckotype_
*
type_
:
:
AsGecko
(
)
{
\
MOZ_ASSERT
(
IsGecko
(
)
)
;
\
return
static_cast
<
geckotype_
*
>
(
this
)
;
\
}
\
servotype_
*
type_
:
:
AsServo
(
)
{
\
MOZ_ASSERT
(
IsServo
(
)
)
;
\
return
static_cast
<
servotype_
*
>
(
this
)
;
\
}
\
const
geckotype_
*
type_
:
:
AsGecko
(
)
const
{
\
MOZ_ASSERT
(
IsGecko
(
)
)
;
\
return
static_cast
<
const
geckotype_
*
>
(
this
)
;
\
}
\
const
servotype_
*
type_
:
:
AsServo
(
)
const
{
\
MOZ_ASSERT
(
IsServo
(
)
)
;
\
return
static_cast
<
const
servotype_
*
>
(
this
)
;
\
}
\
geckotype_
*
type_
:
:
GetAsGecko
(
)
{
\
return
IsGecko
(
)
?
AsGecko
(
)
:
nullptr
;
\
}
\
servotype_
*
type_
:
:
GetAsServo
(
)
{
\
return
IsServo
(
)
?
AsServo
(
)
:
nullptr
;
\
}
\
const
geckotype_
*
type_
:
:
GetAsGecko
(
)
const
{
\
return
IsGecko
(
)
?
AsGecko
(
)
:
nullptr
;
\
}
\
const
servotype_
*
type_
:
:
GetAsServo
(
)
const
{
\
return
IsServo
(
)
?
AsServo
(
)
:
nullptr
;
\
}
#
define
MOZ_STYLO_THIS_TYPE
mozilla
:
:
RemovePointer
<
decltype
(
this
)
>
:
:
Type
#
define
MOZ_STYLO_GECKO_TYPE
mozilla
:
:
RemovePointer
<
decltype
(
AsGecko
(
)
)
>
:
:
Type
#
define
MOZ_STYLO_SERVO_TYPE
mozilla
:
:
RemovePointer
<
decltype
(
AsServo
(
)
)
>
:
:
Type
#
define
MOZ_STYLO_FORWARD_CONCRETE
(
method_
geckoargs_
servoargs_
)
\
static_assert
(
!
mozilla
:
:
IsSame
<
decltype
(
&
MOZ_STYLO_THIS_TYPE
:
:
method_
)
\
decltype
(
&
MOZ_STYLO_GECKO_TYPE
:
:
method_
)
>
\
:
:
value
"
Gecko
subclass
should
define
its
own
"
#
method_
)
;
\
static_assert
(
!
mozilla
:
:
IsSame
<
decltype
(
&
MOZ_STYLO_THIS_TYPE
:
:
method_
)
\
decltype
(
&
MOZ_STYLO_SERVO_TYPE
:
:
method_
)
>
\
:
:
value
"
Servo
subclass
should
define
its
own
"
#
method_
)
;
\
if
(
IsServo
(
)
)
{
\
return
AsServo
(
)
-
>
method_
servoargs_
;
\
}
\
return
AsGecko
(
)
-
>
method_
geckoargs_
;
#
define
MOZ_STYLO_FORWARD
(
method_
args_
)
\
MOZ_STYLO_FORWARD_CONCRETE
(
method_
args_
args_
)
#
define
NS_ASSERTION_STYLO_WARNING_EXPAND
(
X
)
X
#
ifdef
MOZ_STYLO
#
define
NS_ASSERTION_STYLO_WARNING
(
.
.
.
)
\
NS_ASSERTION_STYLO_WARNING_EXPAND
(
NS_WARNING_ASSERTION
(
__VA_ARGS__
)
)
#
else
#
define
NS_ASSERTION_STYLO_WARNING
(
.
.
.
)
\
NS_ASSERTION_STYLO_WARNING_EXPAND
(
NS_ASSERTION
(
__VA_ARGS__
)
)
#
endif
#
endif
