#
ifndef
nsDOMCSSDeclaration_h___
#
define
nsDOMCSSDeclaration_h___
#
include
"
nsICSSDeclaration
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
URLExtraData
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsCompatibility
.
h
"
class
nsIPrincipal
;
class
nsIDocument
;
struct
JSContext
;
class
JSObject
;
namespace
mozilla
{
class
DeclarationBlock
;
namespace
css
{
class
Loader
;
class
Rule
;
}
}
class
nsDOMCSSDeclaration
:
public
nsICSSDeclaration
{
public
:
NS_IMETHOD
QueryInterface
(
REFNSIID
aIID
void
*
*
aInstancePtr
)
override
;
NS_IMETHOD_
(
MozExternalRefCountType
)
AddRef
(
)
override
=
0
;
NS_IMETHOD_
(
MozExternalRefCountType
)
Release
(
)
override
=
0
;
NS_DECL_NSICSSDECLARATION
using
nsICSSDeclaration
:
:
GetLength
;
virtual
nsresult
GetPropertyValue
(
const
nsCSSPropertyID
aPropID
nsAString
&
aValue
)
;
NS_IMETHOD
GetCssText
(
nsAString
&
aCssText
)
override
;
NS_IMETHOD
SetCssText
(
const
nsAString
&
aCssText
nsIPrincipal
*
aSubjectPrincipal
)
override
;
NS_IMETHOD
GetPropertyValue
(
const
nsAString
&
propertyName
nsAString
&
_retval
)
override
;
virtual
already_AddRefed
<
mozilla
:
:
dom
:
:
CSSValue
>
GetPropertyCSSValue
(
const
nsAString
&
propertyName
mozilla
:
:
ErrorResult
&
aRv
)
override
;
using
nsICSSDeclaration
:
:
GetPropertyCSSValue
;
NS_IMETHOD
RemoveProperty
(
const
nsAString
&
propertyName
nsAString
&
_retval
)
override
;
NS_IMETHOD
GetPropertyPriority
(
const
nsAString
&
propertyName
nsAString
&
_retval
)
override
;
NS_IMETHOD
SetProperty
(
const
nsAString
&
propertyName
const
nsAString
&
value
const
nsAString
&
priority
nsIPrincipal
*
aSubjectPrincipal
)
override
;
NS_IMETHOD
GetLength
(
uint32_t
*
aLength
)
override
;
#
define
CSS_PROP_PUBLIC_OR_PRIVATE
(
publicname_
privatename_
)
publicname_
#
define
CSS_PROP
(
name_
id_
method_
flags_
pref_
parsevariant_
\
kwtable_
stylestruct_
stylestructoffset_
animtype_
)
\
void
\
Get
#
#
method_
(
nsAString
&
aValue
mozilla
:
:
ErrorResult
&
rv
)
\
{
\
rv
=
GetPropertyValue
(
eCSSProperty_
#
#
id_
aValue
)
;
\
}
\
\
void
\
Set
#
#
method_
(
const
nsAString
&
aValue
nsIPrincipal
*
aSubjectPrincipal
\
mozilla
:
:
ErrorResult
&
rv
)
\
{
\
rv
=
SetPropertyValue
(
eCSSProperty_
#
#
id_
aValue
aSubjectPrincipal
)
;
\
}
#
define
CSS_PROP_LIST_EXCLUDE_INTERNAL
#
define
CSS_PROP_LIST_INCLUDE_LOGICAL
#
define
CSS_PROP_SHORTHAND
(
name_
id_
method_
flags_
pref_
)
\
CSS_PROP
(
name_
id_
method_
flags_
pref_
X
X
X
X
X
)
#
include
"
nsCSSPropList
.
h
"
#
define
CSS_PROP_ALIAS
(
aliasname_
aliasid_
propid_
aliasmethod_
pref_
)
\
CSS_PROP
(
X
propid_
aliasmethod_
X
pref_
X
X
X
X
X
)
#
include
"
nsCSSPropAliasList
.
h
"
#
undef
CSS_PROP_ALIAS
#
undef
CSS_PROP_SHORTHAND
#
undef
CSS_PROP_LIST_INCLUDE_LOGICAL
#
undef
CSS_PROP_LIST_EXCLUDE_INTERNAL
#
undef
CSS_PROP
#
undef
CSS_PROP_PUBLIC_OR_PRIVATE
virtual
void
IndexedGetter
(
uint32_t
aIndex
bool
&
aFound
nsAString
&
aPropName
)
override
;
virtual
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
struct
MOZ_STACK_CLASS
ServoCSSParsingEnvironment
{
RefPtr
<
mozilla
:
:
URLExtraData
>
mUrlExtraData
;
nsCompatibility
mCompatMode
;
mozilla
:
:
css
:
:
Loader
*
mLoader
;
ServoCSSParsingEnvironment
(
mozilla
:
:
URLExtraData
*
aUrlData
nsCompatibility
aCompatMode
mozilla
:
:
css
:
:
Loader
*
aLoader
)
:
mUrlExtraData
(
aUrlData
)
mCompatMode
(
aCompatMode
)
mLoader
(
aLoader
)
{
}
ServoCSSParsingEnvironment
(
already_AddRefed
<
mozilla
:
:
URLExtraData
>
aUrlData
nsCompatibility
aCompatMode
mozilla
:
:
css
:
:
Loader
*
aLoader
)
:
mUrlExtraData
(
aUrlData
)
mCompatMode
(
aCompatMode
)
mLoader
(
aLoader
)
{
}
}
;
protected
:
enum
Operation
{
eOperation_Read
eOperation_Modify
eOperation_RemoveProperty
}
;
virtual
mozilla
:
:
DeclarationBlock
*
GetCSSDeclaration
(
Operation
aOperation
)
=
0
;
virtual
nsresult
SetCSSDeclaration
(
mozilla
:
:
DeclarationBlock
*
aDecl
)
=
0
;
virtual
nsIDocument
*
DocToUpdate
(
)
=
0
;
struct
CSSParsingEnvironment
{
nsIURI
*
MOZ_UNSAFE_REF
(
"
user
of
CSSParsingEnviroment
must
hold
an
owning
"
"
reference
;
reference
counting
here
has
unacceptable
"
"
performance
overhead
(
see
bug
649163
)
"
)
mSheetURI
;
nsCOMPtr
<
nsIURI
>
mBaseURI
;
nsIPrincipal
*
MOZ_UNSAFE_REF
(
"
user
of
CSSParsingEnviroment
must
hold
an
owning
"
"
reference
;
reference
counting
here
has
unacceptable
"
"
performance
overhead
(
see
bug
649163
)
"
)
mPrincipal
;
mozilla
:
:
css
:
:
Loader
*
MOZ_UNSAFE_REF
(
"
user
of
CSSParsingEnviroment
must
hold
an
owning
"
"
reference
;
reference
counting
here
has
unacceptable
"
"
performance
overhead
(
see
bug
649163
)
"
)
mCSSLoader
;
}
;
virtual
void
GetCSSParsingEnvironment
(
CSSParsingEnvironment
&
aCSSParseEnv
nsIPrincipal
*
aSubjectPrincipal
=
nullptr
)
=
0
;
virtual
ServoCSSParsingEnvironment
GetServoCSSParsingEnvironment
(
nsIPrincipal
*
aSubjectPrincipal
=
nullptr
)
const
=
0
;
static
void
GetCSSParsingEnvironmentForRule
(
mozilla
:
:
css
:
:
Rule
*
aRule
CSSParsingEnvironment
&
aCSSParseEnv
)
;
static
ServoCSSParsingEnvironment
GetServoCSSParsingEnvironmentForRule
(
const
mozilla
:
:
css
:
:
Rule
*
aRule
)
;
nsresult
ParsePropertyValue
(
const
nsCSSPropertyID
aPropID
const
nsAString
&
aPropValue
bool
aIsImportant
nsIPrincipal
*
aSubjectPrincipal
)
;
nsresult
ParseCustomPropertyValue
(
const
nsAString
&
aPropertyName
const
nsAString
&
aPropValue
bool
aIsImportant
nsIPrincipal
*
aSubjectPrincipal
)
;
nsresult
RemovePropertyInternal
(
nsCSSPropertyID
aPropID
)
;
nsresult
RemovePropertyInternal
(
const
nsAString
&
aProperty
)
;
protected
:
virtual
~
nsDOMCSSDeclaration
(
)
;
private
:
template
<
typename
GeckoFunc
typename
ServoFunc
>
inline
nsresult
ModifyDeclaration
(
nsIPrincipal
*
aSubjectPrincipal
GeckoFunc
aGeckoFunc
ServoFunc
aServoFunc
)
;
}
;
#
endif
