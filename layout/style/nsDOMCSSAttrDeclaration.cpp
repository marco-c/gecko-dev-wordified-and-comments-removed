#
include
"
nsDOMCSSAttrDeclaration
.
h
"
#
include
"
mozilla
/
DeclarationBlock
.
h
"
#
include
"
mozilla
/
DeclarationBlockInlines
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
mozilla
/
dom
/
MutationEventBinding
.
h
"
#
include
"
mozilla
/
InternalMutationEvent
.
h
"
#
include
"
mozilla
/
ServoDeclarationBlock
.
h
"
#
include
"
mozAutoDocUpdate
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIDocument
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsNodeUtils
.
h
"
#
include
"
nsSMILCSSValueType
.
h
"
#
include
"
nsWrapperCacheInlines
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
ActiveLayerTracker
.
h
"
using
namespace
mozilla
;
nsDOMCSSAttributeDeclaration
:
:
nsDOMCSSAttributeDeclaration
(
dom
:
:
Element
*
aElement
bool
aIsSMILOverride
)
:
mElement
(
aElement
)
mIsSMILOverride
(
aIsSMILOverride
)
{
NS_ASSERTION
(
aElement
"
Inline
style
for
a
NULL
element
?
"
)
;
}
nsDOMCSSAttributeDeclaration
:
:
~
nsDOMCSSAttributeDeclaration
(
)
{
}
NS_IMPL_CYCLE_COLLECTION_WRAPPERCACHE
(
nsDOMCSSAttributeDeclaration
mElement
)
NS_IMPL_CYCLE_COLLECTION_CAN_SKIP_BEGIN
(
nsDOMCSSAttributeDeclaration
)
if
(
tmp
-
>
mElement
&
&
Element
:
:
CanSkip
(
tmp
-
>
mElement
true
)
)
{
if
(
tmp
-
>
PreservingWrapper
(
)
)
{
tmp
-
>
MarkWrapperLive
(
)
;
}
return
true
;
}
return
tmp
-
>
HasKnownLiveWrapper
(
)
;
NS_IMPL_CYCLE_COLLECTION_CAN_SKIP_END
NS_IMPL_CYCLE_COLLECTION_CAN_SKIP_IN_CC_BEGIN
(
nsDOMCSSAttributeDeclaration
)
return
tmp
-
>
HasKnownLiveWrapper
(
)
|
|
(
tmp
-
>
mElement
&
&
Element
:
:
CanSkipInCC
(
tmp
-
>
mElement
)
)
;
NS_IMPL_CYCLE_COLLECTION_CAN_SKIP_IN_CC_END
NS_IMPL_CYCLE_COLLECTION_CAN_SKIP_THIS_BEGIN
(
nsDOMCSSAttributeDeclaration
)
return
tmp
-
>
HasKnownLiveWrapper
(
)
|
|
(
tmp
-
>
mElement
&
&
Element
:
:
CanSkipThis
(
tmp
-
>
mElement
)
)
;
NS_IMPL_CYCLE_COLLECTION_CAN_SKIP_THIS_END
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
nsDOMCSSAttributeDeclaration
)
NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
NS_IMPL_QUERY_TAIL_INHERITING
(
nsDOMCSSDeclaration
)
NS_IMPL_CYCLE_COLLECTING_ADDREF
(
nsDOMCSSAttributeDeclaration
)
NS_IMPL_CYCLE_COLLECTING_RELEASE
(
nsDOMCSSAttributeDeclaration
)
nsresult
nsDOMCSSAttributeDeclaration
:
:
SetCSSDeclaration
(
DeclarationBlock
*
aDecl
)
{
NS_ASSERTION
(
mElement
"
Must
have
Element
to
set
the
declaration
!
"
)
;
aDecl
-
>
SetDirty
(
)
;
return
mIsSMILOverride
?
mElement
-
>
SetSMILOverrideStyleDeclaration
(
aDecl
true
)
:
mElement
-
>
SetInlineStyleDeclaration
(
aDecl
nullptr
true
)
;
}
nsIDocument
*
nsDOMCSSAttributeDeclaration
:
:
DocToUpdate
(
)
{
return
mElement
-
>
OwnerDoc
(
)
;
}
DeclarationBlock
*
nsDOMCSSAttributeDeclaration
:
:
GetCSSDeclaration
(
Operation
aOperation
)
{
if
(
!
mElement
)
return
nullptr
;
DeclarationBlock
*
declaration
;
if
(
mIsSMILOverride
)
{
declaration
=
mElement
-
>
GetSMILOverrideStyleDeclaration
(
)
;
}
else
{
declaration
=
mElement
-
>
GetInlineStyleDeclaration
(
)
;
}
if
(
!
mIsSMILOverride
&
&
(
(
aOperation
=
=
eOperation_Modify
)
|
|
(
aOperation
=
=
eOperation_RemoveProperty
&
&
declaration
)
)
)
{
nsNodeUtils
:
:
AttributeWillChange
(
mElement
kNameSpaceID_None
nsGkAtoms
:
:
style
dom
:
:
MutationEventBinding
:
:
MODIFICATION
nullptr
)
;
}
if
(
declaration
)
{
if
(
aOperation
!
=
eOperation_Read
&
&
nsContentUtils
:
:
HasMutationListeners
(
mElement
NS_EVENT_BITS_MUTATION_ATTRMODIFIED
mElement
)
)
{
declaration
-
>
SetImmutable
(
)
;
}
return
declaration
;
}
if
(
aOperation
!
=
eOperation_Modify
)
{
return
nullptr
;
}
RefPtr
<
DeclarationBlock
>
decl
=
new
ServoDeclarationBlock
(
)
;
nsresult
rv
;
if
(
mIsSMILOverride
)
{
rv
=
mElement
-
>
SetSMILOverrideStyleDeclaration
(
decl
false
)
;
}
else
{
rv
=
mElement
-
>
SetInlineStyleDeclaration
(
decl
nullptr
false
)
;
}
if
(
NS_FAILED
(
rv
)
)
{
return
nullptr
;
}
return
decl
;
}
nsDOMCSSDeclaration
:
:
ParsingEnvironment
nsDOMCSSAttributeDeclaration
:
:
GetParsingEnvironment
(
nsIPrincipal
*
aSubjectPrincipal
)
const
{
return
{
mElement
-
>
GetURLDataForStyleAttr
(
aSubjectPrincipal
)
mElement
-
>
OwnerDoc
(
)
-
>
GetCompatibilityMode
(
)
mElement
-
>
OwnerDoc
(
)
-
>
CSSLoader
(
)
}
;
}
nsresult
nsDOMCSSAttributeDeclaration
:
:
SetSMILValue
(
const
nsCSSPropertyID
aPropID
const
nsSMILValue
&
aValue
)
{
MOZ_ASSERT
(
mIsSMILOverride
)
;
DeclarationBlock
*
olddecl
=
GetCSSDeclaration
(
eOperation_Modify
)
;
if
(
!
olddecl
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
mozAutoDocUpdate
autoUpdate
(
DocToUpdate
(
)
true
)
;
RefPtr
<
DeclarationBlock
>
decl
=
olddecl
-
>
EnsureMutable
(
)
;
bool
changed
=
nsSMILCSSValueType
:
:
SetPropertyValues
(
aValue
*
decl
)
;
if
(
changed
)
{
SetCSSDeclaration
(
decl
)
;
}
return
NS_OK
;
}
nsresult
nsDOMCSSAttributeDeclaration
:
:
SetPropertyValue
(
const
nsCSSPropertyID
aPropID
const
nsAString
&
aValue
nsIPrincipal
*
aSubjectPrincipal
)
{
if
(
aPropID
=
=
eCSSProperty_opacity
|
|
aPropID
=
=
eCSSProperty_transform
|
|
aPropID
=
=
eCSSProperty_left
|
|
aPropID
=
=
eCSSProperty_top
|
|
aPropID
=
=
eCSSProperty_right
|
|
aPropID
=
=
eCSSProperty_bottom
|
|
aPropID
=
=
eCSSProperty_background_position_x
|
|
aPropID
=
=
eCSSProperty_background_position_y
|
|
aPropID
=
=
eCSSProperty_background_position
)
{
nsIFrame
*
frame
=
mElement
-
>
GetPrimaryFrame
(
)
;
if
(
frame
)
{
ActiveLayerTracker
:
:
NotifyInlineStyleRuleModified
(
frame
aPropID
aValue
this
)
;
}
}
return
nsDOMCSSDeclaration
:
:
SetPropertyValue
(
aPropID
aValue
aSubjectPrincipal
)
;
}
