#
include
"
TouchManager
.
h
"
#
include
"
gfxPrefs
.
h
"
#
include
"
mozilla
/
dom
/
EventTarget
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsView
.
h
"
#
include
"
PositionedEventTargeting
.
h
"
using
namespace
mozilla
:
:
dom
;
namespace
mozilla
{
nsDataHashtable
<
nsUint32HashKey
TouchManager
:
:
TouchInfo
>
*
TouchManager
:
:
sCaptureTouchList
;
void
TouchManager
:
:
InitializeStatics
(
)
{
NS_ASSERTION
(
!
sCaptureTouchList
"
InitializeStatics
called
multiple
times
!
"
)
;
sCaptureTouchList
=
new
nsDataHashtable
<
nsUint32HashKey
TouchManager
:
:
TouchInfo
>
;
}
void
TouchManager
:
:
ReleaseStatics
(
)
{
NS_ASSERTION
(
sCaptureTouchList
"
ReleaseStatics
called
without
Initialize
!
"
)
;
delete
sCaptureTouchList
;
sCaptureTouchList
=
nullptr
;
}
void
TouchManager
:
:
Init
(
PresShell
*
aPresShell
Document
*
aDocument
)
{
mPresShell
=
aPresShell
;
mDocument
=
aDocument
;
}
void
TouchManager
:
:
Destroy
(
)
{
EvictTouches
(
)
;
mDocument
=
nullptr
;
mPresShell
=
nullptr
;
}
static
nsIContent
*
GetNonAnonymousAncestor
(
EventTarget
*
aTarget
)
{
nsCOMPtr
<
nsIContent
>
content
(
do_QueryInterface
(
aTarget
)
)
;
if
(
content
&
&
content
-
>
IsInNativeAnonymousSubtree
(
)
)
{
content
=
content
-
>
FindFirstNonChromeOnlyAccessContent
(
)
;
}
return
content
;
}
void
TouchManager
:
:
EvictTouchPoint
(
RefPtr
<
Touch
>
&
aTouch
Document
*
aLimitToDocument
)
{
nsCOMPtr
<
nsINode
>
node
(
do_QueryInterface
(
aTouch
-
>
mOriginalTarget
)
)
;
if
(
node
)
{
Document
*
doc
=
node
-
>
GetComposedDoc
(
)
;
if
(
doc
&
&
(
!
aLimitToDocument
|
|
aLimitToDocument
=
=
doc
)
)
{
nsIPresShell
*
presShell
=
doc
-
>
GetShell
(
)
;
if
(
presShell
)
{
nsIFrame
*
frame
=
presShell
-
>
GetRootFrame
(
)
;
if
(
frame
)
{
nsPoint
pt
(
aTouch
-
>
mRefPoint
.
x
aTouch
-
>
mRefPoint
.
y
)
;
nsCOMPtr
<
nsIWidget
>
widget
=
frame
-
>
GetView
(
)
-
>
GetNearestWidget
(
&
pt
)
;
if
(
widget
)
{
WidgetTouchEvent
event
(
true
eTouchEnd
widget
)
;
event
.
mTime
=
PR_IntervalNow
(
)
;
event
.
mTouches
.
AppendElement
(
aTouch
)
;
nsEventStatus
status
;
widget
-
>
DispatchEvent
(
&
event
status
)
;
}
}
}
}
}
if
(
!
node
|
|
!
aLimitToDocument
|
|
node
-
>
OwnerDoc
(
)
=
=
aLimitToDocument
)
{
sCaptureTouchList
-
>
Remove
(
aTouch
-
>
Identifier
(
)
)
;
}
}
void
TouchManager
:
:
AppendToTouchList
(
WidgetTouchEvent
:
:
TouchArray
*
aTouchList
)
{
for
(
auto
iter
=
sCaptureTouchList
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
RefPtr
<
Touch
>
&
touch
=
iter
.
Data
(
)
.
mTouch
;
touch
-
>
mChanged
=
false
;
aTouchList
-
>
AppendElement
(
touch
)
;
}
}
void
TouchManager
:
:
EvictTouches
(
)
{
WidgetTouchEvent
:
:
AutoTouchArray
touches
;
AppendToTouchList
(
&
touches
)
;
for
(
uint32_t
i
=
0
;
i
<
touches
.
Length
(
)
;
+
+
i
)
{
EvictTouchPoint
(
touches
[
i
]
mDocument
)
;
}
}
nsIFrame
*
TouchManager
:
:
SetupTarget
(
WidgetTouchEvent
*
aEvent
nsIFrame
*
aFrame
)
{
MOZ_ASSERT
(
aEvent
)
;
if
(
!
aEvent
|
|
aEvent
-
>
mMessage
!
=
eTouchStart
)
{
return
aFrame
;
}
uint32_t
flags
=
0
;
if
(
gfxPrefs
:
:
APZAllowZooming
(
)
)
{
flags
|
=
INPUT_IGNORE_ROOT_SCROLL_FRAME
;
}
nsIFrame
*
target
=
aFrame
;
for
(
int32_t
i
=
aEvent
-
>
mTouches
.
Length
(
)
;
i
;
)
{
-
-
i
;
dom
:
:
Touch
*
touch
=
aEvent
-
>
mTouches
[
i
]
;
int32_t
id
=
touch
-
>
Identifier
(
)
;
if
(
!
TouchManager
:
:
HasCapturedTouch
(
id
)
)
{
nsPoint
eventPoint
=
nsLayoutUtils
:
:
GetEventCoordinatesRelativeTo
(
aEvent
touch
-
>
mRefPoint
aFrame
)
;
target
=
FindFrameTargetedByInputEvent
(
aEvent
aFrame
eventPoint
flags
)
;
if
(
target
)
{
nsCOMPtr
<
nsIContent
>
targetContent
;
target
-
>
GetContentForEvent
(
aEvent
getter_AddRefs
(
targetContent
)
)
;
while
(
targetContent
&
&
!
targetContent
-
>
IsElement
(
)
)
{
targetContent
=
targetContent
-
>
GetParent
(
)
;
}
touch
-
>
SetTouchTarget
(
targetContent
)
;
}
else
{
aEvent
-
>
mTouches
.
RemoveElementAt
(
i
)
;
}
}
else
{
touch
-
>
mChanged
=
false
;
RefPtr
<
dom
:
:
Touch
>
oldTouch
=
TouchManager
:
:
GetCapturedTouch
(
id
)
;
if
(
oldTouch
)
{
touch
-
>
SetTouchTarget
(
oldTouch
-
>
mOriginalTarget
)
;
}
}
}
return
target
;
}
nsIFrame
*
TouchManager
:
:
SuppressInvalidPointsAndGetTargetedFrame
(
WidgetTouchEvent
*
aEvent
)
{
MOZ_ASSERT
(
aEvent
)
;
if
(
!
aEvent
|
|
aEvent
-
>
mMessage
!
=
eTouchStart
)
{
return
nullptr
;
}
nsCOMPtr
<
nsIContent
>
anyTarget
;
if
(
aEvent
-
>
mTouches
.
Length
(
)
>
1
)
{
anyTarget
=
TouchManager
:
:
GetAnyCapturedTouchTarget
(
)
;
}
nsIFrame
*
frame
=
nullptr
;
for
(
int32_t
i
=
aEvent
-
>
mTouches
.
Length
(
)
;
i
;
)
{
-
-
i
;
dom
:
:
Touch
*
touch
=
aEvent
-
>
mTouches
[
i
]
;
if
(
TouchManager
:
:
HasCapturedTouch
(
touch
-
>
Identifier
(
)
)
)
{
continue
;
}
MOZ_ASSERT
(
touch
-
>
mOriginalTarget
)
;
nsCOMPtr
<
nsIContent
>
targetContent
=
do_QueryInterface
(
touch
-
>
GetTarget
(
)
)
;
nsIFrame
*
targetFrame
=
targetContent
?
targetContent
-
>
GetPrimaryFrame
(
)
:
nullptr
;
if
(
targetFrame
&
&
!
anyTarget
)
{
anyTarget
=
targetContent
;
}
else
{
nsIFrame
*
newTargetFrame
=
nullptr
;
for
(
nsIFrame
*
f
=
targetFrame
;
f
;
f
=
nsLayoutUtils
:
:
GetParentOrPlaceholderForCrossDoc
(
f
)
)
{
if
(
f
-
>
PresContext
(
)
-
>
Document
(
)
=
=
anyTarget
-
>
OwnerDoc
(
)
)
{
newTargetFrame
=
f
;
break
;
}
f
=
f
-
>
PresShell
(
)
-
>
GetRootFrame
(
)
;
}
if
(
!
newTargetFrame
)
{
touch
-
>
mIsTouchEventSuppressed
=
true
;
}
else
{
targetFrame
=
newTargetFrame
;
targetFrame
-
>
GetContentForEvent
(
aEvent
getter_AddRefs
(
targetContent
)
)
;
while
(
targetContent
&
&
!
targetContent
-
>
IsElement
(
)
)
{
targetContent
=
targetContent
-
>
GetParent
(
)
;
}
touch
-
>
SetTouchTarget
(
targetContent
)
;
}
}
if
(
targetFrame
)
{
frame
=
targetFrame
;
}
}
return
frame
;
}
bool
TouchManager
:
:
PreHandleEvent
(
WidgetEvent
*
aEvent
nsEventStatus
*
aStatus
bool
&
aTouchIsNew
bool
&
aIsHandlingUserInput
nsCOMPtr
<
nsIContent
>
&
aCurrentEventContent
)
{
switch
(
aEvent
-
>
mMessage
)
{
case
eTouchStart
:
{
aIsHandlingUserInput
=
true
;
WidgetTouchEvent
*
touchEvent
=
aEvent
-
>
AsTouchEvent
(
)
;
if
(
touchEvent
-
>
mTouches
.
Length
(
)
=
=
1
)
{
WidgetTouchEvent
:
:
AutoTouchArray
touches
;
AppendToTouchList
(
&
touches
)
;
for
(
uint32_t
i
=
0
;
i
<
touches
.
Length
(
)
;
+
+
i
)
{
EvictTouchPoint
(
touches
[
i
]
)
;
}
}
WidgetTouchEvent
:
:
TouchArray
&
touches
=
touchEvent
-
>
mTouches
;
for
(
int32_t
i
=
touches
.
Length
(
)
;
i
;
)
{
-
-
i
;
Touch
*
touch
=
touches
[
i
]
;
int32_t
id
=
touch
-
>
Identifier
(
)
;
if
(
!
sCaptureTouchList
-
>
Get
(
id
nullptr
)
)
{
touch
-
>
mChanged
=
true
;
}
touch
-
>
mMessage
=
aEvent
-
>
mMessage
;
TouchInfo
info
=
{
touch
GetNonAnonymousAncestor
(
touch
-
>
mOriginalTarget
)
true
}
;
sCaptureTouchList
-
>
Put
(
id
info
)
;
if
(
touch
-
>
mIsTouchEventSuppressed
)
{
touches
.
RemoveElementAt
(
i
)
;
continue
;
}
}
break
;
}
case
eTouchMove
:
{
WidgetTouchEvent
*
touchEvent
=
aEvent
-
>
AsTouchEvent
(
)
;
WidgetTouchEvent
:
:
TouchArray
&
touches
=
touchEvent
-
>
mTouches
;
bool
haveChanged
=
false
;
for
(
int32_t
i
=
touches
.
Length
(
)
;
i
;
)
{
-
-
i
;
Touch
*
touch
=
touches
[
i
]
;
if
(
!
touch
)
{
continue
;
}
int32_t
id
=
touch
-
>
Identifier
(
)
;
touch
-
>
mMessage
=
aEvent
-
>
mMessage
;
TouchInfo
info
;
if
(
!
sCaptureTouchList
-
>
Get
(
id
&
info
)
)
{
touches
.
RemoveElementAt
(
i
)
;
continue
;
}
RefPtr
<
Touch
>
oldTouch
=
info
.
mTouch
;
if
(
!
touch
-
>
Equals
(
oldTouch
)
)
{
touch
-
>
mChanged
=
true
;
haveChanged
=
true
;
}
nsCOMPtr
<
EventTarget
>
targetPtr
=
oldTouch
-
>
mOriginalTarget
;
if
(
!
targetPtr
)
{
touches
.
RemoveElementAt
(
i
)
;
continue
;
}
nsCOMPtr
<
nsINode
>
targetNode
(
do_QueryInterface
(
targetPtr
)
)
;
if
(
!
targetNode
-
>
IsInComposedDoc
(
)
)
{
targetPtr
=
info
.
mNonAnonymousTarget
;
}
touch
-
>
SetTouchTarget
(
targetPtr
)
;
info
.
mTouch
=
touch
;
sCaptureTouchList
-
>
Put
(
id
info
)
;
if
(
oldTouch
-
>
mMessage
!
=
touch
-
>
mMessage
)
{
aTouchIsNew
=
true
;
}
if
(
oldTouch
-
>
mIsTouchEventSuppressed
)
{
touch
-
>
mIsTouchEventSuppressed
=
true
;
touches
.
RemoveElementAt
(
i
)
;
continue
;
}
}
if
(
!
haveChanged
)
{
if
(
aTouchIsNew
)
{
for
(
uint32_t
i
=
0
;
i
<
touchEvent
-
>
mTouches
.
Length
(
)
;
+
+
i
)
{
if
(
touchEvent
-
>
mTouches
[
i
]
)
{
touchEvent
-
>
mTouches
[
i
]
-
>
mChanged
=
true
;
break
;
}
}
}
else
{
return
false
;
}
}
break
;
}
case
eTouchEnd
:
aIsHandlingUserInput
=
true
;
MOZ_FALLTHROUGH
;
case
eTouchCancel
:
{
WidgetTouchEvent
*
touchEvent
=
aEvent
-
>
AsTouchEvent
(
)
;
WidgetTouchEvent
:
:
TouchArray
&
touches
=
touchEvent
-
>
mTouches
;
for
(
int32_t
i
=
touches
.
Length
(
)
;
i
;
)
{
-
-
i
;
Touch
*
touch
=
touches
[
i
]
;
if
(
!
touch
)
{
continue
;
}
touch
-
>
mMessage
=
aEvent
-
>
mMessage
;
touch
-
>
mChanged
=
true
;
int32_t
id
=
touch
-
>
Identifier
(
)
;
TouchInfo
info
;
if
(
!
sCaptureTouchList
-
>
Get
(
id
&
info
)
)
{
continue
;
}
nsCOMPtr
<
EventTarget
>
targetPtr
=
info
.
mTouch
-
>
mOriginalTarget
;
nsCOMPtr
<
nsINode
>
targetNode
(
do_QueryInterface
(
targetPtr
)
)
;
if
(
targetNode
&
&
!
targetNode
-
>
IsInComposedDoc
(
)
)
{
targetPtr
=
info
.
mNonAnonymousTarget
;
}
aCurrentEventContent
=
do_QueryInterface
(
targetPtr
)
;
touch
-
>
SetTouchTarget
(
targetPtr
)
;
sCaptureTouchList
-
>
Remove
(
id
)
;
if
(
info
.
mTouch
-
>
mIsTouchEventSuppressed
)
{
touches
.
RemoveElementAt
(
i
)
;
continue
;
}
}
AppendToTouchList
(
&
touches
)
;
break
;
}
case
eTouchPointerCancel
:
{
WidgetTouchEvent
*
touchEvent
=
aEvent
-
>
AsTouchEvent
(
)
;
WidgetTouchEvent
:
:
TouchArray
&
touches
=
touchEvent
-
>
mTouches
;
for
(
uint32_t
i
=
0
;
i
<
touches
.
Length
(
)
;
+
+
i
)
{
Touch
*
touch
=
touches
[
i
]
;
if
(
!
touch
)
{
continue
;
}
int32_t
id
=
touch
-
>
Identifier
(
)
;
TouchInfo
info
;
if
(
!
sCaptureTouchList
-
>
Get
(
id
&
info
)
)
{
continue
;
}
info
.
mConvertToPointer
=
false
;
sCaptureTouchList
-
>
Put
(
id
info
)
;
}
break
;
}
default
:
break
;
}
return
true
;
}
already_AddRefed
<
nsIContent
>
TouchManager
:
:
GetAnyCapturedTouchTarget
(
)
{
nsCOMPtr
<
nsIContent
>
result
=
nullptr
;
if
(
sCaptureTouchList
-
>
Count
(
)
=
=
0
)
{
return
result
.
forget
(
)
;
}
for
(
auto
iter
=
sCaptureTouchList
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
RefPtr
<
Touch
>
&
touch
=
iter
.
Data
(
)
.
mTouch
;
if
(
touch
)
{
EventTarget
*
target
=
touch
-
>
GetTarget
(
)
;
if
(
target
)
{
result
=
do_QueryInterface
(
target
)
;
break
;
}
}
}
return
result
.
forget
(
)
;
}
bool
TouchManager
:
:
HasCapturedTouch
(
int32_t
aId
)
{
return
sCaptureTouchList
-
>
Contains
(
aId
)
;
}
already_AddRefed
<
Touch
>
TouchManager
:
:
GetCapturedTouch
(
int32_t
aId
)
{
RefPtr
<
Touch
>
touch
;
TouchInfo
info
;
if
(
sCaptureTouchList
-
>
Get
(
aId
&
info
)
)
{
touch
=
info
.
mTouch
;
}
return
touch
.
forget
(
)
;
}
bool
TouchManager
:
:
ShouldConvertTouchToPointer
(
const
Touch
*
aTouch
const
WidgetTouchEvent
*
aEvent
)
{
if
(
!
aTouch
|
|
!
aTouch
-
>
convertToPointer
)
{
return
false
;
}
TouchInfo
info
;
if
(
!
sCaptureTouchList
-
>
Get
(
aTouch
-
>
Identifier
(
)
&
info
)
)
{
return
aEvent
-
>
mMessage
=
=
eTouchStart
;
}
return
info
.
mConvertToPointer
&
&
aEvent
-
>
mMessage
!
=
eTouchStart
;
}
}
