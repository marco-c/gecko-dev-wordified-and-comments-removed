#
ifndef
nsPresContext_h___
#
define
nsPresContext_h___
#
include
"
mozilla
/
intl
/
Bidi
.
h
"
#
include
"
mozilla
/
AppUnits
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
EnumeratedArray
.
h
"
#
include
"
mozilla
/
MediaEmulationData
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
NotNull
.
h
"
#
include
"
mozilla
/
PreferenceSheet
.
h
"
#
include
"
mozilla
/
PresShellForwards
.
h
"
#
include
"
mozilla
/
ScrollStyles
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
#
include
"
mozilla
/
widget
/
ThemeChangeKind
.
h
"
#
include
"
nsColor
.
h
"
#
include
"
nsCompatibility
.
h
"
#
include
"
nsCoord
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsFontMetrics
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsRect
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsTHashSet
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
nsAtom
.
h
"
#
include
"
nsIWidgetListener
.
h
"
#
include
"
nsGkAtoms
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsChangeHint
.
h
"
#
include
"
gfxTypes
.
h
"
#
include
"
gfxRect
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
Units
.
h
"
class
nsIPrintSettings
;
class
nsDocShell
;
class
nsIDocShell
;
class
nsITheme
;
class
nsITimer
;
class
nsIContent
;
class
nsIFrame
;
class
nsFrameManager
;
class
nsAtom
;
class
nsIRunnable
;
class
gfxFontFamily
;
class
gfxFontFeatureValueSet
;
class
gfxUserFontEntry
;
class
gfxUserFontSet
;
class
gfxTextPerfMetrics
;
class
nsCSSFontFeatureValuesRule
;
class
nsCSSFrameConstructor
;
class
nsFontCache
;
class
nsTransitionManager
;
class
nsAnimationManager
;
class
nsRefreshDriver
;
class
nsIWidget
;
class
nsDeviceContext
;
class
gfxMissingFontRecorder
;
namespace
mozilla
{
class
AnimationEventDispatcher
;
class
EffectCompositor
;
class
Encoding
;
class
EventStateManager
;
class
CounterStyleManager
;
class
ManagedPostRefreshObserver
;
class
PresShell
;
class
RestyleManager
;
class
ServoStyleSet
;
class
StaticPresData
;
struct
MediaFeatureChange
;
enum
class
MediaFeatureChangePropagation
:
uint8_t
;
enum
class
ColorScheme
:
uint8_t
;
namespace
layers
{
class
ContainerLayer
;
class
LayerManager
;
}
namespace
dom
{
class
Document
;
class
Element
;
enum
class
PrefersColorSchemeOverride
:
uint8_t
;
}
}
enum
nsPresContext_CachedIntPrefType
{
kPresContext_ScrollbarSide
=
1
kPresContext_BidiDirection
}
;
const
uint8_t
kPresContext_DefaultVariableFont_ID
=
0x00
;
const
uint8_t
kPresContext_DefaultFixedFont_ID
=
0x01
;
#
ifdef
DEBUG
struct
nsAutoLayoutPhase
;
enum
class
nsLayoutPhase
:
uint8_t
{
Paint
DisplayListBuilding
Reflow
FrameC
COUNT
}
;
#
endif
class
nsRootPresContext
;
class
nsPresContext
:
public
nsISupports
public
mozilla
:
:
SupportsWeakPtr
{
public
:
using
Encoding
=
mozilla
:
:
Encoding
;
template
<
typename
T
>
using
NotNull
=
mozilla
:
:
NotNull
<
T
>
;
template
<
typename
T
>
using
Maybe
=
mozilla
:
:
Maybe
<
T
>
;
using
MediaEmulationData
=
mozilla
:
:
MediaEmulationData
;
typedef
mozilla
:
:
ScrollStyles
ScrollStyles
;
using
TransactionId
=
mozilla
:
:
layers
:
:
TransactionId
;
NS_DECL_CYCLE_COLLECTING_ISUPPORTS_FINAL
NS_DECL_CYCLE_COLLECTION_CLASS
(
nsPresContext
)
enum
nsPresContextType
:
uint8_t
{
eContext_Galley
eContext_PrintPreview
eContext_Print
eContext_PageLayout
}
;
nsPresContext
(
mozilla
:
:
dom
:
:
Document
*
aDocument
nsPresContextType
aType
)
;
nsresult
Init
(
nsDeviceContext
*
aDeviceContext
)
;
void
InitFontCache
(
)
;
void
UpdateFontCacheUserFonts
(
gfxUserFontSet
*
aUserFontSet
)
;
FontVisibility
GetFontVisibility
(
)
const
{
return
mFontVisibility
;
}
void
ReportBlockedFontFamily
(
const
mozilla
:
:
fontlist
:
:
Family
&
aFamily
)
;
void
ReportBlockedFontFamily
(
const
gfxFontFamily
&
aFamily
)
;
already_AddRefed
<
nsFontMetrics
>
GetMetricsFor
(
const
nsFont
&
aFont
const
nsFontMetrics
:
:
Params
&
aParams
)
;
nsresult
FontMetricsDeleted
(
const
nsFontMetrics
*
aFontMetrics
)
;
nsresult
FlushFontCache
(
)
;
void
AttachPresShell
(
mozilla
:
:
PresShell
*
aPresShell
)
;
void
DetachPresShell
(
)
;
nsPresContextType
Type
(
)
const
{
return
mType
;
}
mozilla
:
:
PresShell
*
PresShell
(
)
const
{
NS_ASSERTION
(
mPresShell
"
Null
pres
shell
"
)
;
return
mPresShell
;
}
mozilla
:
:
PresShell
*
GetPresShell
(
)
const
{
return
mPresShell
;
}
void
DocumentCharSetChanged
(
NotNull
<
const
Encoding
*
>
aCharSet
)
;
nsPresContext
*
GetParentPresContext
(
)
const
;
nsPresContext
*
GetInProcessRootContentDocumentPresContext
(
)
;
nsIWidget
*
GetNearestWidget
(
nsPoint
*
aOffset
=
nullptr
)
;
already_AddRefed
<
nsIWidget
>
GetRootWidget
(
)
const
;
already_AddRefed
<
nsIWidget
>
GetTextInputHandlingWidget
(
)
const
{
return
GetRootWidget
(
)
;
}
nsRootPresContext
*
GetRootPresContext
(
)
const
;
virtual
bool
IsRoot
(
)
{
return
false
;
}
mozilla
:
:
dom
:
:
Document
*
Document
(
)
const
{
#
ifdef
DEBUG
ValidatePresShellAndDocumentReleation
(
)
;
#
endif
return
mDocument
;
}
inline
mozilla
:
:
ServoStyleSet
*
StyleSet
(
)
const
;
bool
HasPendingMediaQueryUpdates
(
)
const
{
return
!
!
mPendingMediaFeatureValuesChange
;
}
inline
nsCSSFrameConstructor
*
FrameConstructor
(
)
const
;
mozilla
:
:
AnimationEventDispatcher
*
AnimationEventDispatcher
(
)
{
return
mAnimationEventDispatcher
;
}
mozilla
:
:
EffectCompositor
*
EffectCompositor
(
)
{
return
mEffectCompositor
;
}
nsTransitionManager
*
TransitionManager
(
)
{
return
mTransitionManager
.
get
(
)
;
}
nsAnimationManager
*
AnimationManager
(
)
{
return
mAnimationManager
.
get
(
)
;
}
const
nsAnimationManager
*
AnimationManager
(
)
const
{
return
mAnimationManager
.
get
(
)
;
}
nsRefreshDriver
*
RefreshDriver
(
)
{
return
mRefreshDriver
;
}
mozilla
:
:
RestyleManager
*
RestyleManager
(
)
{
MOZ_ASSERT
(
mRestyleManager
)
;
return
mRestyleManager
.
get
(
)
;
}
mozilla
:
:
CounterStyleManager
*
CounterStyleManager
(
)
const
{
return
mCounterStyleManager
;
}
void
RebuildAllStyleData
(
nsChangeHint
const
mozilla
:
:
RestyleHint
&
)
;
void
PostRebuildAllStyleDataEvent
(
nsChangeHint
const
mozilla
:
:
RestyleHint
&
)
;
void
ContentLanguageChanged
(
)
;
bool
FlushPendingMediaFeatureValuesChanged
(
)
;
void
MediaFeatureValuesChanged
(
const
mozilla
:
:
MediaFeatureChange
&
mozilla
:
:
MediaFeatureChangePropagation
)
;
void
SizeModeChanged
(
nsSizeMode
aSizeMode
)
;
nsCompatibility
CompatibilityMode
(
)
const
;
uint16_t
ImageAnimationMode
(
)
const
{
return
mImageAnimationMode
;
}
void
SetImageAnimationMode
(
uint16_t
aMode
)
;
const
nsAtom
*
Medium
(
)
{
MOZ_ASSERT
(
mMedium
)
;
return
mMediaEmulationData
.
mMedium
?
mMediaEmulationData
.
mMedium
.
get
(
)
:
mMedium
;
}
void
EmulateMedium
(
nsAtom
*
aMediaType
)
;
int32_t
GetCachedIntPref
(
nsPresContext_CachedIntPrefType
aPrefType
)
const
{
switch
(
aPrefType
)
{
case
kPresContext_ScrollbarSide
:
return
mPrefScrollbarSide
;
case
kPresContext_BidiDirection
:
return
mPrefBidiDirection
;
default
:
NS_ERROR
(
"
invalid
arg
passed
to
GetCachedIntPref
"
)
;
}
return
false
;
}
const
mozilla
:
:
PreferenceSheet
:
:
Prefs
&
PrefSheetPrefs
(
)
const
{
return
mozilla
:
:
PreferenceSheet
:
:
PrefsFor
(
*
mDocument
)
;
}
bool
ForcingColors
(
)
const
{
return
mozilla
:
:
PreferenceSheet
:
:
MayForceColors
(
)
&
&
!
PrefSheetPrefs
(
)
.
mUseDocumentColors
;
}
mozilla
:
:
ColorScheme
DefaultBackgroundColorScheme
(
)
const
;
nscolor
DefaultBackgroundColor
(
)
const
;
nsISupports
*
GetContainerWeak
(
)
const
;
nsDocShell
*
GetDocShell
(
)
const
;
nsRect
GetVisibleArea
(
)
const
{
return
mVisibleArea
;
}
void
SetVisibleArea
(
const
nsRect
&
r
)
;
nsSize
GetSizeForViewportUnits
(
)
const
{
return
mSizeForViewportUnits
;
}
MOZ_CAN_RUN_SCRIPT
void
SetDynamicToolbarMaxHeight
(
mozilla
:
:
ScreenIntCoord
aHeight
)
;
mozilla
:
:
ScreenIntCoord
GetDynamicToolbarMaxHeight
(
)
const
{
MOZ_ASSERT
(
IsRootContentDocumentCrossProcess
(
)
)
;
return
mDynamicToolbarMaxHeight
;
}
bool
HasDynamicToolbar
(
)
const
{
MOZ_ASSERT
(
IsRootContentDocumentCrossProcess
(
)
)
;
return
mDynamicToolbarMaxHeight
>
0
;
}
void
UpdateDynamicToolbarOffset
(
mozilla
:
:
ScreenIntCoord
aOffset
)
;
mozilla
:
:
ScreenIntCoord
GetDynamicToolbarHeight
(
)
const
{
MOZ_ASSERT
(
IsRootContentDocumentCrossProcess
(
)
)
;
return
mDynamicToolbarHeight
;
}
mozilla
:
:
DynamicToolbarState
GetDynamicToolbarState
(
)
const
;
bool
IsPaginated
(
)
const
{
return
mPaginated
;
}
void
SetPaginatedScrolling
(
bool
aResult
)
;
bool
HasPaginatedScrolling
(
)
const
{
return
mCanPaginatedScroll
;
}
const
nsSize
&
GetPageSize
(
)
const
{
return
mPageSize
;
}
const
nsMargin
&
GetDefaultPageMargin
(
)
const
{
return
mDefaultPageMargin
;
}
void
SetPageSize
(
nsSize
aSize
)
{
mPageSize
=
aSize
;
}
bool
IsRootPaginatedDocument
(
)
{
return
mIsRootPaginatedDocument
;
}
void
SetIsRootPaginatedDocument
(
bool
aIsRootPaginatedDocument
)
{
mIsRootPaginatedDocument
=
aIsRootPaginatedDocument
;
}
float
GetPageScale
(
)
{
return
mPageScale
;
}
void
SetPageScale
(
float
aScale
)
{
mPageScale
=
aScale
;
}
float
GetPrintPreviewScaleForSequenceFrame
(
)
{
return
mPPScale
;
}
void
SetPrintPreviewScale
(
float
aScale
)
{
mPPScale
=
aScale
;
}
nsDeviceContext
*
DeviceContext
(
)
const
{
return
mDeviceContext
;
}
mozilla
:
:
EventStateManager
*
EventStateManager
(
)
{
return
mEventManager
;
}
float
GetSystemFontScale
(
)
const
{
return
mSystemFontScale
;
}
void
SetSystemFontScale
(
float
aFontScale
)
{
MOZ_ASSERT
(
aFontScale
>
0
.
0f
"
invalid
font
scale
"
)
;
if
(
aFontScale
=
=
mSystemFontScale
|
|
IsPrintingOrPrintPreview
(
)
)
{
return
;
}
mSystemFontScale
=
aFontScale
;
UpdateEffectiveTextZoom
(
)
;
}
float
TextZoom
(
)
const
{
return
mTextZoom
;
}
float
EffectiveTextZoom
(
)
const
{
return
mEffectiveTextZoom
;
}
void
SetSafeAreaInsets
(
const
mozilla
:
:
ScreenIntMargin
&
aInsets
)
;
mozilla
:
:
ScreenIntMargin
GetSafeAreaInsets
(
)
const
{
return
mSafeAreaInsets
;
}
void
RegisterManagedPostRefreshObserver
(
mozilla
:
:
ManagedPostRefreshObserver
*
)
;
void
UnregisterManagedPostRefreshObserver
(
mozilla
:
:
ManagedPostRefreshObserver
*
)
;
protected
:
void
CancelManagedPostRefreshObservers
(
)
;
void
UpdateEffectiveTextZoom
(
)
;
#
ifdef
DEBUG
void
ValidatePresShellAndDocumentReleation
(
)
const
;
#
endif
void
SetTextZoom
(
float
aZoom
)
{
MOZ_ASSERT
(
aZoom
>
0
.
0f
"
invalid
zoom
factor
"
)
;
if
(
aZoom
=
=
mTextZoom
)
return
;
mTextZoom
=
aZoom
;
UpdateEffectiveTextZoom
(
)
;
}
void
SetFullZoom
(
float
aZoom
)
;
void
SetOverrideDPPX
(
float
)
;
public
:
float
GetFullZoom
(
)
{
return
mFullZoom
;
}
float
GetDeviceFullZoom
(
)
;
float
GetOverrideDPPX
(
)
const
{
return
mMediaEmulationData
.
mDPPX
;
}
Maybe
<
mozilla
:
:
ColorScheme
>
GetOverriddenOrEmbedderColorScheme
(
)
const
;
void
RecomputeBrowsingContextDependentData
(
)
;
void
SetColorSchemeOverride
(
mozilla
:
:
dom
:
:
PrefersColorSchemeOverride
)
;
mozilla
:
:
CSSCoord
GetAutoQualityMinFontSize
(
)
const
{
return
DevPixelsToFloatCSSPixels
(
mAutoQualityMinFontSizePixelsPref
)
;
}
gfxSize
ScreenSizeInchesForFontInflation
(
bool
*
aChanged
=
nullptr
)
;
int32_t
AppUnitsPerDevPixel
(
)
const
{
return
mCurAppUnitsPerDevPixel
;
}
static
nscoord
CSSPixelsToAppUnits
(
int32_t
aPixels
)
{
return
NSToCoordRoundWithClamp
(
float
(
aPixels
)
*
float
(
mozilla
:
:
AppUnitsPerCSSPixel
(
)
)
)
;
}
static
nscoord
CSSPixelsToAppUnits
(
float
aPixels
)
{
return
NSToCoordRoundWithClamp
(
aPixels
*
float
(
mozilla
:
:
AppUnitsPerCSSPixel
(
)
)
)
;
}
static
int32_t
AppUnitsToIntCSSPixels
(
nscoord
aAppUnits
)
{
return
NSAppUnitsToIntPixels
(
aAppUnits
float
(
mozilla
:
:
AppUnitsPerCSSPixel
(
)
)
)
;
}
static
float
AppUnitsToFloatCSSPixels
(
nscoord
aAppUnits
)
{
return
NSAppUnitsToFloatPixels
(
aAppUnits
float
(
mozilla
:
:
AppUnitsPerCSSPixel
(
)
)
)
;
}
static
double
AppUnitsToDoubleCSSPixels
(
nscoord
aAppUnits
)
{
return
NSAppUnitsToDoublePixels
(
aAppUnits
double
(
mozilla
:
:
AppUnitsPerCSSPixel
(
)
)
)
;
}
nscoord
DevPixelsToAppUnits
(
int32_t
aPixels
)
const
{
return
NSIntPixelsToAppUnits
(
aPixels
AppUnitsPerDevPixel
(
)
)
;
}
int32_t
AppUnitsToDevPixels
(
nscoord
aAppUnits
)
const
{
return
NSAppUnitsToIntPixels
(
aAppUnits
float
(
AppUnitsPerDevPixel
(
)
)
)
;
}
float
AppUnitsToFloatDevPixels
(
nscoord
aAppUnits
)
{
return
aAppUnits
/
float
(
AppUnitsPerDevPixel
(
)
)
;
}
int32_t
CSSPixelsToDevPixels
(
int32_t
aPixels
)
{
return
AppUnitsToDevPixels
(
CSSPixelsToAppUnits
(
aPixels
)
)
;
}
float
CSSPixelsToDevPixels
(
float
aPixels
)
{
return
NSAppUnitsToFloatPixels
(
CSSPixelsToAppUnits
(
aPixels
)
float
(
AppUnitsPerDevPixel
(
)
)
)
;
}
int32_t
DevPixelsToIntCSSPixels
(
int32_t
aPixels
)
{
return
AppUnitsToIntCSSPixels
(
DevPixelsToAppUnits
(
aPixels
)
)
;
}
mozilla
:
:
CSSIntPoint
DevPixelsToIntCSSPixels
(
const
mozilla
:
:
LayoutDeviceIntPoint
&
aPoint
)
{
return
mozilla
:
:
CSSIntPoint
(
AppUnitsToIntCSSPixels
(
DevPixelsToAppUnits
(
aPoint
.
x
)
)
AppUnitsToIntCSSPixels
(
DevPixelsToAppUnits
(
aPoint
.
y
)
)
)
;
}
float
DevPixelsToFloatCSSPixels
(
int32_t
aPixels
)
const
{
return
AppUnitsToFloatCSSPixels
(
DevPixelsToAppUnits
(
aPixels
)
)
;
}
mozilla
:
:
CSSToLayoutDeviceScale
CSSToDevPixelScale
(
)
const
{
return
mozilla
:
:
CSSToLayoutDeviceScale
(
float
(
mozilla
:
:
AppUnitsPerCSSPixel
(
)
)
/
float
(
AppUnitsPerDevPixel
(
)
)
)
;
}
nscoord
GfxUnitsToAppUnits
(
gfxFloat
aGfxUnits
)
const
;
gfxFloat
AppUnitsToGfxUnits
(
nscoord
aAppUnits
)
const
;
gfxRect
AppUnitsToGfxUnits
(
const
nsRect
&
aAppRect
)
const
{
return
gfxRect
(
AppUnitsToGfxUnits
(
aAppRect
.
x
)
AppUnitsToGfxUnits
(
aAppRect
.
y
)
AppUnitsToGfxUnits
(
aAppRect
.
Width
(
)
)
AppUnitsToGfxUnits
(
aAppRect
.
Height
(
)
)
)
;
}
static
nscoord
CSSTwipsToAppUnits
(
float
aTwips
)
{
return
NSToCoordRoundWithClamp
(
mozilla
:
:
AppUnitsPerCSSInch
(
)
*
NS_TWIPS_TO_INCHES
(
aTwips
)
)
;
}
static
nsMargin
CSSTwipsToAppUnits
(
const
nsIntMargin
&
marginInTwips
)
{
return
nsMargin
(
CSSTwipsToAppUnits
(
float
(
marginInTwips
.
top
)
)
CSSTwipsToAppUnits
(
float
(
marginInTwips
.
right
)
)
CSSTwipsToAppUnits
(
float
(
marginInTwips
.
bottom
)
)
CSSTwipsToAppUnits
(
float
(
marginInTwips
.
left
)
)
)
;
}
static
nscoord
CSSPointsToAppUnits
(
float
aPoints
)
{
return
NSToCoordRound
(
aPoints
*
mozilla
:
:
AppUnitsPerCSSInch
(
)
/
POINTS_PER_INCH_FLOAT
)
;
}
nscoord
PhysicalMillimetersToAppUnits
(
float
aMM
)
const
;
nscoord
RoundAppUnitsToNearestDevPixels
(
nscoord
aAppUnits
)
const
{
return
DevPixelsToAppUnits
(
AppUnitsToDevPixels
(
aAppUnits
)
)
;
}
mozilla
:
:
dom
:
:
Element
*
UpdateViewportScrollStylesOverride
(
)
;
mozilla
:
:
dom
:
:
Element
*
GetViewportScrollStylesOverrideElement
(
)
const
{
return
mViewportScrollOverrideElement
;
}
const
ScrollStyles
&
GetViewportScrollStylesOverride
(
)
const
{
return
mViewportScrollStyles
;
}
bool
ElementWouldPropagateScrollStyles
(
const
mozilla
:
:
dom
:
:
Element
&
)
;
bool
GetBackgroundImageDraw
(
)
const
{
return
mDrawImageBackground
;
}
bool
GetBackgroundColorDraw
(
)
const
{
return
mDrawColorBackground
;
}
bool
BidiEnabled
(
)
const
;
void
SetBidiEnabled
(
)
const
;
void
SetVisualMode
(
bool
aIsVisual
)
{
mIsVisual
=
aIsVisual
;
}
bool
IsVisualMode
(
)
const
{
return
mIsVisual
;
}
enum
class
InteractionType
:
uint32_t
{
ClickInteraction
KeyInteraction
MouseMoveInteraction
ScrollInteraction
}
;
void
RecordInteractionTime
(
InteractionType
aType
const
mozilla
:
:
TimeStamp
&
aTimeStamp
)
;
void
DisableInteractionTimeRecording
(
)
{
mInteractionTimeEnabled
=
false
;
}
void
SetBidi
(
uint32_t
aBidiOptions
)
;
uint32_t
GetBidi
(
)
const
;
nsITheme
*
Theme
(
)
MOZ_NONNULL_RETURN
{
if
(
MOZ_LIKELY
(
mTheme
)
)
{
return
mTheme
;
}
return
EnsureTheme
(
)
;
}
void
RecomputeTheme
(
)
;
bool
UseOverlayScrollbars
(
)
const
;
void
ThemeChanged
(
mozilla
:
:
widget
:
:
ThemeChangeKind
)
;
void
UIResolutionChanged
(
)
;
void
UIResolutionChangedSync
(
)
;
void
SetPrintSettings
(
nsIPrintSettings
*
aPrintSettings
)
;
nsIPrintSettings
*
GetPrintSettings
(
)
{
return
mPrintSettings
;
}
bool
EnsureVisible
(
)
;
#
ifdef
MOZ_REFLOW_PERF
void
CountReflows
(
const
char
*
aName
nsIFrame
*
aFrame
)
;
#
endif
void
ConstructedFrame
(
)
{
+
+
mFramesConstructed
;
}
void
ReflowedFrame
(
)
{
+
+
mFramesReflowed
;
}
uint64_t
FramesConstructedCount
(
)
{
return
mFramesConstructed
;
}
uint64_t
FramesReflowedCount
(
)
{
return
mFramesReflowed
;
}
static
nscoord
GetBorderWidthForKeyword
(
unsigned
int
aBorderWidthKeyword
)
{
static
const
nscoord
kBorderWidths
[
]
=
{
CSSPixelsToAppUnits
(
1
)
CSSPixelsToAppUnits
(
3
)
CSSPixelsToAppUnits
(
5
)
}
;
MOZ_ASSERT
(
size_t
(
aBorderWidthKeyword
)
<
mozilla
:
:
ArrayLength
(
kBorderWidths
)
)
;
return
kBorderWidths
[
aBorderWidthKeyword
]
;
}
gfxTextPerfMetrics
*
GetTextPerfMetrics
(
)
{
return
mTextPerf
.
get
(
)
;
}
bool
IsDynamic
(
)
const
{
return
mType
=
=
eContext_PageLayout
|
|
mType
=
=
eContext_Galley
;
}
bool
IsScreen
(
)
const
{
return
mMedium
=
=
nsGkAtoms
:
:
screen
|
|
mType
=
=
eContext_PageLayout
|
|
mType
=
=
eContext_PrintPreview
;
}
bool
IsPrintingOrPrintPreview
(
)
const
{
return
mType
=
=
eContext_Print
|
|
mType
=
=
eContext_PrintPreview
;
}
bool
IsChrome
(
)
const
;
bool
SuppressingResizeReflow
(
)
const
{
return
mSuppressResizeReflow
;
}
gfxUserFontSet
*
GetUserFontSet
(
)
;
void
UserFontSetUpdated
(
gfxUserFontEntry
*
aUpdatedFont
=
nullptr
)
;
gfxMissingFontRecorder
*
MissingFontRecorder
(
)
{
return
mMissingFonts
.
get
(
)
;
}
void
NotifyMissingFonts
(
)
;
void
FlushCounterStyles
(
)
;
void
MarkCounterStylesDirty
(
)
;
void
FlushFontFeatureValues
(
)
;
void
MarkFontFeatureValuesDirty
(
)
{
mFontFeatureValuesDirty
=
true
;
}
void
EnsureSafeToHandOutCSSRules
(
)
;
void
NotifyInvalidation
(
TransactionId
aTransactionId
const
nsRect
&
aRect
)
;
void
NotifyInvalidation
(
TransactionId
aTransactionId
const
nsIntRect
&
aRect
)
;
void
NotifyDidPaintForSubtree
(
TransactionId
aTransactionId
=
TransactionId
{
0
}
const
mozilla
:
:
TimeStamp
&
aTimeStamp
=
mozilla
:
:
TimeStamp
(
)
)
;
void
NotifyRevokingDidPaint
(
TransactionId
aTransactionId
)
;
MOZ_CAN_RUN_SCRIPT_BOUNDARY
void
FireDOMPaintEvent
(
nsTArray
<
nsRect
>
*
aList
TransactionId
aTransactionId
mozilla
:
:
TimeStamp
aTimeStamp
=
mozilla
:
:
TimeStamp
(
)
)
;
bool
IsDOMPaintEventPending
(
)
;
uint64_t
GetRestyleGeneration
(
)
const
;
uint64_t
GetUndisplayedRestyleGeneration
(
)
const
;
bool
HasPendingRestyleOrReflow
(
)
;
void
ReflowStarted
(
bool
aInterruptible
)
;
class
InterruptPreventer
;
friend
class
InterruptPreventer
;
class
MOZ_STACK_CLASS
InterruptPreventer
{
public
:
explicit
InterruptPreventer
(
nsPresContext
*
aCtx
)
:
mCtx
(
aCtx
)
mInterruptsEnabled
(
aCtx
-
>
mInterruptsEnabled
)
mHasPendingInterrupt
(
aCtx
-
>
mHasPendingInterrupt
)
{
mCtx
-
>
mInterruptsEnabled
=
false
;
mCtx
-
>
mHasPendingInterrupt
=
false
;
}
~
InterruptPreventer
(
)
{
mCtx
-
>
mInterruptsEnabled
=
mInterruptsEnabled
;
mCtx
-
>
mHasPendingInterrupt
=
mHasPendingInterrupt
;
}
private
:
nsPresContext
*
mCtx
;
bool
mInterruptsEnabled
;
bool
mHasPendingInterrupt
;
}
;
bool
CheckForInterrupt
(
nsIFrame
*
aFrame
)
;
bool
HasPendingInterrupt
(
)
{
return
mHasPendingInterrupt
;
}
void
SetPendingInterruptFromTest
(
)
{
mPendingInterruptFromTest
=
true
;
}
nsIFrame
*
GetPrimaryFrameFor
(
nsIContent
*
aContent
)
;
virtual
size_t
SizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
virtual
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
{
return
aMallocSizeOf
(
this
)
+
SizeOfExcludingThis
(
aMallocSizeOf
)
;
}
bool
IsRootContentDocument
(
)
const
;
bool
IsRootContentDocumentInProcess
(
)
const
;
bool
IsRootContentDocumentCrossProcess
(
)
const
;
bool
HadNonBlankPaint
(
)
const
{
return
mHadNonBlankPaint
;
}
bool
HadContentfulPaint
(
)
const
{
return
mHadContentfulPaint
;
}
void
NotifyNonBlankPaint
(
)
;
void
NotifyContentfulPaint
(
)
;
void
NotifyPaintStatusReset
(
)
;
void
NotifyDOMContentFlushed
(
)
;
bool
HasEverBuiltInvisibleText
(
)
const
{
return
mHasEverBuiltInvisibleText
;
}
void
SetBuiltInvisibleText
(
)
{
mHasEverBuiltInvisibleText
=
true
;
}
bool
UsesFontMetricDependentFontUnits
(
)
const
{
return
mUsesFontMetricDependentFontUnits
;
}
void
SetUsesFontMetricDependentFontUnits
(
bool
aValue
)
{
mUsesFontMetricDependentFontUnits
=
aValue
;
}
bool
IsDeviceSizePageSize
(
)
;
bool
HasWarnedAboutPositionedTableParts
(
)
const
{
return
mHasWarnedAboutPositionedTableParts
;
}
void
SetHasWarnedAboutPositionedTableParts
(
)
{
mHasWarnedAboutPositionedTableParts
=
true
;
}
bool
HasWarnedAboutTooLargeDashedOrDottedRadius
(
)
const
{
return
mHasWarnedAboutTooLargeDashedOrDottedRadius
;
}
void
SetHasWarnedAboutTooLargeDashedOrDottedRadius
(
)
{
mHasWarnedAboutTooLargeDashedOrDottedRadius
=
true
;
}
void
RegisterContainerQueryFrame
(
nsIFrame
*
aFrame
)
;
void
UnregisterContainerQueryFrame
(
nsIFrame
*
aFrame
)
;
bool
HasContainerQueryFrames
(
)
const
{
return
!
mContainerQueryFrames
.
IsEmpty
(
)
;
}
void
FinishedContainerQueryUpdate
(
)
;
bool
UpdateContainerQueryStyles
(
)
;
mozilla
:
:
intl
:
:
Bidi
&
GetBidiEngine
(
)
;
gfxFontFeatureValueSet
*
GetFontFeatureValuesLookup
(
)
const
{
return
mFontFeatureValuesLookup
;
}
protected
:
friend
class
nsRunnableMethod
<
nsPresContext
>
;
void
ThemeChangedInternal
(
)
;
void
RefreshSystemMetrics
(
)
;
void
UIResolutionChangedInternal
(
)
;
void
SetImgAnimations
(
nsIContent
*
aParent
uint16_t
aMode
)
;
void
SetSMILAnimations
(
mozilla
:
:
dom
:
:
Document
*
aDoc
uint16_t
aNewMode
uint16_t
aOldMode
)
;
static
void
PreferenceChanged
(
const
char
*
aPrefName
void
*
aSelf
)
;
void
PreferenceChanged
(
const
char
*
aPrefName
)
;
void
GetUserPreferences
(
)
;
void
UpdateCharSet
(
NotNull
<
const
Encoding
*
>
aCharSet
)
;
void
DoForceReflowForFontInfoUpdateFromStyle
(
)
;
public
:
void
ForceReflowForFontInfoUpdate
(
bool
aNeedsReframe
)
;
void
ForceReflowForFontInfoUpdateFromStyle
(
)
;
bool
MayHavePaintEventListener
(
)
;
void
InvalidatePaintedLayers
(
)
;
uint32_t
GetNextFrameRateMultiplier
(
)
const
{
return
mNextFrameRateMultiplier
;
}
void
DidUseFrameRateMultiplier
(
)
{
if
(
!
mNextFrameRateMultiplier
)
{
mNextFrameRateMultiplier
=
1
;
}
else
if
(
mNextFrameRateMultiplier
<
8
)
{
mNextFrameRateMultiplier
=
mNextFrameRateMultiplier
*
2
;
}
}
protected
:
void
Destroy
(
)
;
void
AppUnitsPerDevPixelChanged
(
)
;
bool
HavePendingInputEvent
(
)
;
already_AddRefed
<
nsITimer
>
CreateTimer
(
nsTimerCallbackFunc
aCallback
const
char
*
aName
uint32_t
aDelay
)
;
struct
TransactionInvalidations
{
TransactionId
mTransactionId
;
nsTArray
<
nsRect
>
mInvalidations
;
bool
mIsWaitingForPreviousTransaction
=
false
;
}
;
TransactionInvalidations
*
GetInvalidations
(
TransactionId
aTransactionId
)
;
void
AdjustSizeForViewportUnits
(
)
;
bool
UpdateFontVisibility
(
)
;
void
ReportBlockedFontFamilyName
(
const
nsCString
&
aFamily
FontVisibility
aVisibility
)
;
mozilla
:
:
PresShell
*
MOZ_NON_OWNING_REF
mPresShell
;
RefPtr
<
mozilla
:
:
dom
:
:
Document
>
mDocument
;
RefPtr
<
nsDeviceContext
>
mDeviceContext
;
RefPtr
<
nsFontCache
>
mFontCache
;
RefPtr
<
mozilla
:
:
EventStateManager
>
mEventManager
;
RefPtr
<
nsRefreshDriver
>
mRefreshDriver
;
RefPtr
<
mozilla
:
:
AnimationEventDispatcher
>
mAnimationEventDispatcher
;
RefPtr
<
mozilla
:
:
EffectCompositor
>
mEffectCompositor
;
mozilla
:
:
UniquePtr
<
nsTransitionManager
>
mTransitionManager
;
mozilla
:
:
UniquePtr
<
nsAnimationManager
>
mAnimationManager
;
mozilla
:
:
UniquePtr
<
mozilla
:
:
RestyleManager
>
mRestyleManager
;
RefPtr
<
mozilla
:
:
CounterStyleManager
>
mCounterStyleManager
;
const
nsStaticAtom
*
mMedium
;
RefPtr
<
gfxFontFeatureValueSet
>
mFontFeatureValuesLookup
;
MediaEmulationData
mMediaEmulationData
;
float
mSystemFontScale
;
float
mTextZoom
;
float
mEffectiveTextZoom
;
float
mFullZoom
;
gfxSize
mLastFontInflationScreenSize
;
int32_t
mCurAppUnitsPerDevPixel
;
int32_t
mAutoQualityMinFontSizePixelsPref
;
nsCOMPtr
<
nsITheme
>
mTheme
;
nsCOMPtr
<
nsIPrintSettings
>
mPrintSettings
;
mozilla
:
:
UniquePtr
<
mozilla
:
:
intl
:
:
Bidi
>
mBidiEngine
;
AutoTArray
<
TransactionInvalidations
4
>
mTransactions
;
mozilla
:
:
UniquePtr
<
gfxTextPerfMetrics
>
mTextPerf
;
mozilla
:
:
UniquePtr
<
gfxMissingFontRecorder
>
mMissingFonts
;
nsRect
mVisibleArea
;
nsSize
mSizeForViewportUnits
;
mozilla
:
:
ScreenIntCoord
mDynamicToolbarMaxHeight
;
mozilla
:
:
ScreenIntCoord
mDynamicToolbarHeight
;
mozilla
:
:
ScreenIntMargin
mSafeAreaInsets
;
nsSize
mPageSize
;
nsMargin
mDefaultPageMargin
;
float
mPageScale
;
float
mPPScale
;
mozilla
:
:
dom
:
:
Element
*
MOZ_NON_OWNING_REF
mViewportScrollOverrideElement
;
uint64_t
mElementsRestyled
;
uint64_t
mFramesConstructed
;
uint64_t
mFramesReflowed
;
mozilla
:
:
TimeStamp
mReflowStartTime
;
Maybe
<
TransactionId
>
mFirstContentfulPaintTransactionId
;
mozilla
:
:
UniquePtr
<
mozilla
:
:
MediaFeatureChange
>
mPendingMediaFeatureValuesChange
;
mozilla
:
:
TimeStamp
mFirstNonBlankPaintTime
;
mozilla
:
:
TimeStamp
mFirstClickTime
;
mozilla
:
:
TimeStamp
mFirstKeyTime
;
mozilla
:
:
TimeStamp
mFirstMouseMoveTime
;
mozilla
:
:
TimeStamp
mFirstScrollTime
;
mozilla
:
:
TimeStamp
mLastStyleUpdateForAllAnimations
;
uint32_t
mInterruptChecksToSkip
;
uint32_t
mNextFrameRateMultiplier
;
nsTArray
<
RefPtr
<
mozilla
:
:
ManagedPostRefreshObserver
>
>
mManagedPostRefreshObservers
;
nsTHashSet
<
nsCString
>
mBlockedFonts
;
nsTHashSet
<
nsIFrame
*
>
mContainerQueryFrames
;
nsTHashSet
<
nsIContent
*
>
mUpdatedContainerQueryContents
;
ScrollStyles
mViewportScrollStyles
;
uint16_t
mImageAnimationMode
;
uint16_t
mImageAnimationModePref
;
nsPresContextType
mType
;
public
:
bool
mInflationDisabledForShrinkWrap
;
protected
:
static
constexpr
size_t
kThemeChangeKindBits
=
2
;
static_assert
(
unsigned
(
mozilla
:
:
widget
:
:
ThemeChangeKind
:
:
AllBits
)
<
=
(
1u
<
<
kThemeChangeKindBits
)
-
1
"
theme
change
kind
doesn
'
t
fit
"
)
;
unsigned
mInteractionTimeEnabled
:
1
;
unsigned
mHasPendingInterrupt
:
1
;
unsigned
mHasEverBuiltInvisibleText
:
1
;
unsigned
mPendingInterruptFromTest
:
1
;
unsigned
mInterruptsEnabled
:
1
;
unsigned
mSendAfterPaintToContent
:
1
;
unsigned
mDrawImageBackground
:
1
;
unsigned
mDrawColorBackground
:
1
;
unsigned
mNeverAnimate
:
1
;
unsigned
mPaginated
:
1
;
unsigned
mCanPaginatedScroll
:
1
;
unsigned
mDoScaledTwips
:
1
;
unsigned
mIsRootPaginatedDocument
:
1
;
unsigned
mPrefBidiDirection
:
1
;
unsigned
mPrefScrollbarSide
:
2
;
unsigned
mPendingThemeChanged
:
1
;
unsigned
mPendingThemeChangeKind
:
kThemeChangeKindBits
;
unsigned
mPendingUIResolutionChanged
:
1
;
unsigned
mPendingFontInfoUpdateReflowFromStyle
:
1
;
unsigned
mIsGlyph
:
1
;
unsigned
mUsesFontMetricDependentFontUnits
:
1
;
unsigned
mCounterStylesDirty
:
1
;
unsigned
mFontFeatureValuesDirty
:
1
;
unsigned
mSuppressResizeReflow
:
1
;
unsigned
mIsVisual
:
1
;
unsigned
mHasWarnedAboutPositionedTableParts
:
1
;
unsigned
mHasWarnedAboutTooLargeDashedOrDottedRadius
:
1
;
unsigned
mQuirkSheetAdded
:
1
;
unsigned
mHadNonBlankPaint
:
1
;
unsigned
mHadContentfulPaint
:
1
;
unsigned
mHadNonTickContentfulPaint
:
1
;
unsigned
mHadContentfulPaintComposite
:
1
;
#
ifdef
DEBUG
unsigned
mInitialized
:
1
;
#
endif
FontVisibility
mFontVisibility
=
FontVisibility
:
:
Unknown
;
mozilla
:
:
dom
:
:
PrefersColorSchemeOverride
mOverriddenOrEmbedderColorScheme
;
protected
:
virtual
~
nsPresContext
(
)
;
void
LastRelease
(
)
;
nsITheme
*
EnsureTheme
(
)
;
#
ifdef
DEBUG
private
:
friend
struct
nsAutoLayoutPhase
;
mozilla
:
:
EnumeratedArray
<
nsLayoutPhase
nsLayoutPhase
:
:
COUNT
uint32_t
>
mLayoutPhaseCount
;
public
:
uint32_t
LayoutPhaseCount
(
nsLayoutPhase
aPhase
)
{
return
mLayoutPhaseCount
[
aPhase
]
;
}
#
endif
}
;
class
nsRootPresContext
final
:
public
nsPresContext
{
public
:
nsRootPresContext
(
mozilla
:
:
dom
:
:
Document
*
aDocument
nsPresContextType
aType
)
;
virtual
bool
IsRoot
(
)
override
{
return
true
;
}
void
AddWillPaintObserver
(
nsIRunnable
*
aRunnable
)
;
void
FlushWillPaintObservers
(
)
;
virtual
size_t
SizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
override
;
protected
:
class
RunWillPaintObservers
:
public
mozilla
:
:
Runnable
{
public
:
explicit
RunWillPaintObservers
(
nsRootPresContext
*
aPresContext
)
:
Runnable
(
"
nsPresContextType
:
:
RunWillPaintObservers
"
)
mPresContext
(
aPresContext
)
{
}
void
Revoke
(
)
{
mPresContext
=
nullptr
;
}
NS_IMETHOD
Run
(
)
override
{
if
(
mPresContext
)
{
mPresContext
-
>
FlushWillPaintObservers
(
)
;
}
return
NS_OK
;
}
nsRootPresContext
*
MOZ_NON_OWNING_REF
mPresContext
;
}
;
friend
class
nsPresContext
;
nsTArray
<
nsCOMPtr
<
nsIRunnable
>
>
mWillPaintObservers
;
nsRevocableEventPtr
<
RunWillPaintObservers
>
mWillPaintFallbackEvent
;
}
;
#
ifdef
MOZ_REFLOW_PERF
#
define
DO_GLOBAL_REFLOW_COUNT
(
_name
)
\
aPresContext
-
>
CountReflows
(
(
_name
)
(
nsIFrame
*
)
this
)
;
#
else
#
define
DO_GLOBAL_REFLOW_COUNT
(
_name
)
#
endif
#
endif
