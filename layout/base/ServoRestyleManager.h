#
ifndef
mozilla_ServoRestyleManager_h
#
define
mozilla_ServoRestyleManager_h
#
include
"
mozilla
/
EventStates
.
h
"
#
include
"
mozilla
/
RestyleManager
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
ServoElementSnapshot
.
h
"
#
include
"
mozilla
/
ServoElementSnapshotTable
.
h
"
#
include
"
nsChangeHint
.
h
"
#
include
"
nsPresContext
.
h
"
namespace
mozilla
{
namespace
dom
{
class
Element
;
}
}
class
nsAttrValue
;
class
nsIAtom
;
class
nsIContent
;
class
nsIFrame
;
class
nsStyleChangeList
;
namespace
mozilla
{
class
ServoRestyleState
{
public
:
ServoRestyleState
(
ServoStyleSet
&
aStyleSet
nsStyleChangeList
&
aChangeList
nsTArray
<
nsIFrame
*
>
&
aPendingWrapperRestyles
)
:
mStyleSet
(
aStyleSet
)
mChangeList
(
aChangeList
)
mPendingWrapperRestyles
(
aPendingWrapperRestyles
)
mPendingWrapperRestyleOffset
(
aPendingWrapperRestyles
.
Length
(
)
)
mChangesHandled
(
nsChangeHint
(
0
)
)
{
}
enum
class
Type
{
InFlow
OutOfFlow
}
;
ServoRestyleState
(
const
nsIFrame
&
aOwner
ServoRestyleState
&
aParentState
nsChangeHint
aHintForThisFrame
Type
aType
bool
aAssertWrapperRestyleLength
=
true
)
:
mStyleSet
(
aParentState
.
mStyleSet
)
mChangeList
(
aParentState
.
mChangeList
)
mPendingWrapperRestyles
(
aParentState
.
mPendingWrapperRestyles
)
mPendingWrapperRestyleOffset
(
aParentState
.
mPendingWrapperRestyles
.
Length
(
)
)
mChangesHandled
(
aType
=
=
Type
:
:
InFlow
?
aParentState
.
mChangesHandled
|
aHintForThisFrame
:
aHintForThisFrame
)
#
ifdef
DEBUG
mOwner
(
&
aOwner
)
mAssertWrapperRestyleLength
(
aAssertWrapperRestyleLength
)
#
endif
{
if
(
aType
=
=
Type
:
:
InFlow
)
{
AssertOwner
(
aParentState
)
;
}
}
~
ServoRestyleState
(
)
{
MOZ_ASSERT
(
!
mAssertWrapperRestyleLength
|
|
mPendingWrapperRestyles
.
Length
(
)
=
=
mPendingWrapperRestyleOffset
"
Someone
forgot
to
call
ProcessWrapperRestyles
!
"
)
;
}
nsStyleChangeList
&
ChangeList
(
)
{
return
mChangeList
;
}
ServoStyleSet
&
StyleSet
(
)
{
return
mStyleSet
;
}
#
ifdef
DEBUG
void
AssertOwner
(
const
ServoRestyleState
&
aParentState
)
const
;
nsChangeHint
ChangesHandledFor
(
const
nsIFrame
&
)
const
;
#
else
void
AssertOwner
(
const
ServoRestyleState
&
)
const
{
}
nsChangeHint
ChangesHandledFor
(
const
nsIFrame
&
)
const
{
return
mChangesHandled
;
}
#
endif
void
AddPendingWrapperRestyle
(
nsIFrame
*
aWrapperFrame
)
;
void
ProcessWrapperRestyles
(
nsIFrame
*
aParentFrame
)
;
static
nsIFrame
*
TableAwareParentFor
(
const
nsIFrame
*
aChild
)
;
private
:
size_t
ProcessMaybeNestedWrapperRestyle
(
nsIFrame
*
aParent
size_t
aIndex
)
;
ServoStyleSet
&
mStyleSet
;
nsStyleChangeList
&
mChangeList
;
nsTArray
<
nsIFrame
*
>
&
mPendingWrapperRestyles
;
size_t
mPendingWrapperRestyleOffset
;
const
nsChangeHint
mChangesHandled
;
#
ifdef
DEBUG
const
nsIFrame
*
mOwner
{
nullptr
}
;
#
endif
#
ifdef
DEBUG
const
bool
mAssertWrapperRestyleLength
=
true
;
#
endif
}
;
class
ServoRestyleManager
:
public
RestyleManager
{
friend
class
ServoStyleSet
;
public
:
typedef
ServoElementSnapshotTable
SnapshotTable
;
typedef
RestyleManager
base_type
;
explicit
ServoRestyleManager
(
nsPresContext
*
aPresContext
)
;
void
PostRestyleEvent
(
dom
:
:
Element
*
aElement
nsRestyleHint
aRestyleHint
nsChangeHint
aMinChangeHint
)
;
void
PostRestyleEventForCSSRuleChanges
(
)
;
void
RebuildAllStyleData
(
nsChangeHint
aExtraHint
nsRestyleHint
aRestyleHint
)
;
void
PostRebuildAllStyleDataEvent
(
nsChangeHint
aExtraHint
nsRestyleHint
aRestyleHint
)
;
void
ProcessPendingRestyles
(
)
;
void
UpdateAnimationStylesForHitTesting
(
)
;
void
ContentStateChanged
(
nsIContent
*
aContent
EventStates
aStateMask
)
;
void
AttributeWillChange
(
dom
:
:
Element
*
aElement
int32_t
aNameSpaceID
nsIAtom
*
aAttribute
int32_t
aModType
const
nsAttrValue
*
aNewValue
)
;
void
ClassAttributeWillBeChangedBySMIL
(
dom
:
:
Element
*
aElement
)
;
void
AttributeChanged
(
dom
:
:
Element
*
aElement
int32_t
aNameSpaceID
nsIAtom
*
aAttribute
int32_t
aModType
const
nsAttrValue
*
aOldValue
)
;
nsresult
ReparentStyleContext
(
nsIFrame
*
aFrame
)
;
static
nsIFrame
*
FrameForPseudoElement
(
const
Element
*
aElement
nsIAtom
*
aPseudoTagOrNull
)
;
static
void
ClearServoDataFromSubtree
(
Element
*
aElement
)
;
static
void
ClearRestyleStateFromSubtree
(
Element
*
aElement
)
;
void
PostRestyleEventForAnimations
(
dom
:
:
Element
*
aElement
CSSPseudoElementType
aPseudoType
nsRestyleHint
aRestyleHint
)
;
protected
:
~
ServoRestyleManager
(
)
override
{
MOZ_ASSERT
(
!
mReentrantChanges
)
;
}
private
:
bool
ProcessPostTraversal
(
Element
*
aElement
ServoStyleContext
*
aParentContext
ServoRestyleState
&
aRestyleState
ServoTraversalFlags
aFlags
bool
aParentWasRestyled
)
;
struct
TextPostTraversalState
;
bool
ProcessPostTraversalForText
(
nsIContent
*
aTextNode
TextPostTraversalState
&
aState
ServoRestyleState
&
aRestyleState
bool
aParentWasRestyled
)
;
inline
ServoStyleSet
*
StyleSet
(
)
const
{
MOZ_ASSERT
(
PresContext
(
)
-
>
StyleSet
(
)
-
>
IsServo
(
)
"
ServoRestyleManager
should
only
be
used
with
a
Servo
-
flavored
"
"
style
backend
"
)
;
return
PresContext
(
)
-
>
StyleSet
(
)
-
>
AsServo
(
)
;
}
const
SnapshotTable
&
Snapshots
(
)
const
{
return
mSnapshots
;
}
void
ClearSnapshots
(
)
;
ServoElementSnapshot
&
SnapshotFor
(
mozilla
:
:
dom
:
:
Element
*
aElement
)
;
void
TakeSnapshotForAttributeChange
(
mozilla
:
:
dom
:
:
Element
*
aElement
int32_t
aNameSpaceID
nsIAtom
*
aAttribute
)
;
void
DoProcessPendingRestyles
(
ServoTraversalFlags
aFlags
)
;
void
DoReparentStyleContext
(
nsIFrame
*
aFrame
ServoStyleSet
&
aStyleSet
)
;
struct
ReentrantChange
{
nsCOMPtr
<
nsIContent
>
mContent
;
nsChangeHint
mHint
;
}
;
typedef
AutoTArray
<
ReentrantChange
10
>
ReentrantChangeList
;
ReentrantChangeList
*
mReentrantChanges
;
bool
mHaveNonAnimationRestyles
=
false
;
bool
mRestyleForCSSRuleChanges
=
false
;
SnapshotTable
mSnapshots
;
}
;
}
#
endif
