#
ifndef
AccessibleCaretEventHub_h
#
define
AccessibleCaretEventHub_h
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDocShell
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsIReflowObserver
.
h
"
#
include
"
nsIScrollObserver
.
h
"
#
include
"
nsISelectionListener
.
h
"
#
include
"
nsPoint
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsWeakReference
.
h
"
class
nsIPresShell
;
class
nsITimer
;
namespace
mozilla
{
class
AccessibleCaretManager
;
class
WidgetKeyboardEvent
;
class
WidgetMouseEvent
;
class
WidgetTouchEvent
;
class
AccessibleCaretEventHub
:
public
nsIReflowObserver
public
nsIScrollObserver
public
nsISelectionListener
public
nsSupportsWeakReference
{
public
:
explicit
AccessibleCaretEventHub
(
nsIPresShell
*
aPresShell
)
;
void
Init
(
)
;
void
Terminate
(
)
;
MOZ_CAN_RUN_SCRIPT
nsEventStatus
HandleEvent
(
WidgetEvent
*
aEvent
)
;
MOZ_CAN_RUN_SCRIPT
void
NotifyBlur
(
bool
aIsLeavingDocument
)
;
NS_DECL_ISUPPORTS
MOZ_CAN_RUN_SCRIPT
NS_IMETHOD
Reflow
(
DOMHighResTimeStamp
start
DOMHighResTimeStamp
end
)
final
;
MOZ_CAN_RUN_SCRIPT
NS_IMETHOD
ReflowInterruptible
(
DOMHighResTimeStamp
start
DOMHighResTimeStamp
end
)
final
;
MOZ_CAN_RUN_SCRIPT
NS_IMETHOD
NotifySelectionChanged
(
nsIDOMDocument
*
doc
nsISelection
*
sel
int16_t
reason
)
final
;
MOZ_CAN_RUN_SCRIPT
virtual
void
ScrollPositionChanged
(
)
override
;
MOZ_CAN_RUN_SCRIPT
virtual
void
AsyncPanZoomStarted
(
)
override
;
MOZ_CAN_RUN_SCRIPT
virtual
void
AsyncPanZoomStopped
(
)
override
;
class
State
;
State
*
GetState
(
)
const
;
protected
:
virtual
~
AccessibleCaretEventHub
(
)
=
default
;
#
define
MOZ_DECL_STATE_CLASS_GETTER
(
aClassName
)
\
class
aClassName
;
\
static
State
*
aClassName
(
)
;
#
define
MOZ_IMPL_STATE_CLASS_GETTER
(
aClassName
)
\
AccessibleCaretEventHub
:
:
State
*
AccessibleCaretEventHub
:
:
aClassName
(
)
\
{
\
static
class
aClassName
singleton
;
\
return
&
singleton
;
\
}
MOZ_DECL_STATE_CLASS_GETTER
(
NoActionState
)
MOZ_DECL_STATE_CLASS_GETTER
(
PressCaretState
)
MOZ_DECL_STATE_CLASS_GETTER
(
DragCaretState
)
MOZ_DECL_STATE_CLASS_GETTER
(
PressNoCaretState
)
MOZ_DECL_STATE_CLASS_GETTER
(
ScrollState
)
MOZ_DECL_STATE_CLASS_GETTER
(
LongTapState
)
void
SetState
(
State
*
aState
)
;
MOZ_CAN_RUN_SCRIPT
nsEventStatus
HandleMouseEvent
(
WidgetMouseEvent
*
aEvent
)
;
MOZ_CAN_RUN_SCRIPT
nsEventStatus
HandleTouchEvent
(
WidgetTouchEvent
*
aEvent
)
;
MOZ_CAN_RUN_SCRIPT
nsEventStatus
HandleKeyboardEvent
(
WidgetKeyboardEvent
*
aEvent
)
;
virtual
nsPoint
GetTouchEventPosition
(
WidgetTouchEvent
*
aEvent
int32_t
aIdentifier
)
const
;
virtual
nsPoint
GetMouseEventPosition
(
WidgetMouseEvent
*
aEvent
)
const
;
bool
MoveDistanceIsLarge
(
const
nsPoint
&
aPoint
)
const
;
void
LaunchLongTapInjector
(
)
;
void
CancelLongTapInjector
(
)
;
MOZ_CAN_RUN_SCRIPT_BOUNDARY
static
void
FireLongTap
(
nsITimer
*
aTimer
void
*
aAccessibleCaretEventHub
)
;
void
LaunchScrollEndInjector
(
)
;
void
CancelScrollEndInjector
(
)
;
MOZ_CAN_RUN_SCRIPT_BOUNDARY
static
void
FireScrollEnd
(
nsITimer
*
aTimer
void
*
aAccessibleCaretEventHub
)
;
State
*
mState
=
NoActionState
(
)
;
nsIPresShell
*
MOZ_NON_OWNING_REF
mPresShell
=
nullptr
;
UniquePtr
<
AccessibleCaretManager
>
mManager
;
WeakPtr
<
nsDocShell
>
mDocShell
;
nsCOMPtr
<
nsITimer
>
mLongTapInjectorTimer
;
nsPoint
mPressPoint
{
NS_UNCONSTRAINEDSIZE
NS_UNCONSTRAINEDSIZE
}
;
int32_t
mActiveTouchId
=
kInvalidTouchId
;
bool
mInitialized
=
false
;
bool
mIsInReflowCallback
=
false
;
static
bool
sUseLongTapInjector
;
static
const
int32_t
kMoveStartToleranceInPixel
=
5
;
static
const
int32_t
kInvalidTouchId
=
-
1
;
static
const
int32_t
kDefaultTouchId
=
0
;
}
;
class
AccessibleCaretEventHub
:
:
State
{
public
:
virtual
const
char
*
Name
(
)
const
{
return
"
"
;
}
virtual
nsEventStatus
OnPress
(
AccessibleCaretEventHub
*
aContext
const
nsPoint
&
aPoint
int32_t
aTouchId
EventClassID
aEventClass
)
{
return
nsEventStatus_eIgnore
;
}
virtual
nsEventStatus
OnMove
(
AccessibleCaretEventHub
*
aContext
const
nsPoint
&
aPoint
)
{
return
nsEventStatus_eIgnore
;
}
virtual
nsEventStatus
OnRelease
(
AccessibleCaretEventHub
*
aContext
)
{
return
nsEventStatus_eIgnore
;
}
virtual
nsEventStatus
OnLongTap
(
AccessibleCaretEventHub
*
aContext
const
nsPoint
&
aPoint
)
{
return
nsEventStatus_eIgnore
;
}
virtual
void
OnScrollStart
(
AccessibleCaretEventHub
*
aContext
)
{
}
virtual
void
OnScrollEnd
(
AccessibleCaretEventHub
*
aContext
)
{
}
virtual
void
OnScrollPositionChanged
(
AccessibleCaretEventHub
*
aContext
)
{
}
virtual
void
OnBlur
(
AccessibleCaretEventHub
*
aContext
bool
aIsLeavingDocument
)
{
}
virtual
void
OnSelectionChanged
(
AccessibleCaretEventHub
*
aContext
nsIDOMDocument
*
aDoc
nsISelection
*
aSel
int16_t
aReason
)
{
}
virtual
void
OnReflow
(
AccessibleCaretEventHub
*
aContext
)
{
}
virtual
void
Enter
(
AccessibleCaretEventHub
*
aContext
)
{
}
virtual
void
Leave
(
AccessibleCaretEventHub
*
aContext
)
{
}
explicit
State
(
)
=
default
;
virtual
~
State
(
)
=
default
;
State
(
const
State
&
)
=
delete
;
State
&
operator
=
(
const
State
&
)
=
delete
;
}
;
}
#
endif
