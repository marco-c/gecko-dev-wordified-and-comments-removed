#
include
"
MobileViewportManager
.
h
"
#
include
"
gfxPrefs
.
h
"
#
include
"
LayersLogging
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
dom
/
Event
.
h
"
#
include
"
mozilla
/
dom
/
EventTarget
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
nsViewManager
.
h
"
#
include
"
nsViewportInfo
.
h
"
#
include
"
UnitTransforms
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
define
MVM_LOG
(
.
.
.
)
NS_IMPL_ISUPPORTS
(
MobileViewportManager
nsIDOMEventListener
nsIObserver
)
#
define
DOM_META_ADDED
NS_LITERAL_STRING
(
"
DOMMetaAdded
"
)
#
define
DOM_META_CHANGED
NS_LITERAL_STRING
(
"
DOMMetaChanged
"
)
#
define
FULL_ZOOM_CHANGE
NS_LITERAL_STRING
(
"
FullZoomChange
"
)
#
define
LOAD
NS_LITERAL_STRING
(
"
load
"
)
#
define
BEFORE_FIRST_PAINT
NS_LITERAL_CSTRING
(
"
before
-
first
-
paint
"
)
using
namespace
mozilla
;
using
namespace
mozilla
:
:
layers
;
MobileViewportManager
:
:
MobileViewportManager
(
nsIPresShell
*
aPresShell
Document
*
aDocument
)
:
mDocument
(
aDocument
)
mPresShell
(
aPresShell
)
mIsFirstPaint
(
false
)
mPainted
(
false
)
{
MOZ_ASSERT
(
mPresShell
)
;
MOZ_ASSERT
(
mDocument
)
;
MVM_LOG
(
"
%
p
:
creating
with
presShell
%
p
document
%
p
\
n
"
this
mPresShell
aDocument
)
;
if
(
nsCOMPtr
<
nsPIDOMWindowOuter
>
window
=
mDocument
-
>
GetWindow
(
)
)
{
mEventTarget
=
window
-
>
GetChromeEventHandler
(
)
;
}
if
(
mEventTarget
)
{
mEventTarget
-
>
AddEventListener
(
DOM_META_ADDED
this
false
)
;
mEventTarget
-
>
AddEventListener
(
DOM_META_CHANGED
this
false
)
;
mEventTarget
-
>
AddEventListener
(
FULL_ZOOM_CHANGE
this
false
)
;
mEventTarget
-
>
AddEventListener
(
LOAD
this
true
)
;
}
nsCOMPtr
<
nsIObserverService
>
observerService
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
observerService
)
{
observerService
-
>
AddObserver
(
this
BEFORE_FIRST_PAINT
.
Data
(
)
false
)
;
}
}
MobileViewportManager
:
:
~
MobileViewportManager
(
)
{
}
void
MobileViewportManager
:
:
Destroy
(
)
{
MVM_LOG
(
"
%
p
:
destroying
\
n
"
this
)
;
if
(
mEventTarget
)
{
mEventTarget
-
>
RemoveEventListener
(
DOM_META_ADDED
this
false
)
;
mEventTarget
-
>
RemoveEventListener
(
DOM_META_CHANGED
this
false
)
;
mEventTarget
-
>
RemoveEventListener
(
FULL_ZOOM_CHANGE
this
false
)
;
mEventTarget
-
>
RemoveEventListener
(
LOAD
this
true
)
;
mEventTarget
=
nullptr
;
}
nsCOMPtr
<
nsIObserverService
>
observerService
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
if
(
observerService
)
{
observerService
-
>
RemoveObserver
(
this
BEFORE_FIRST_PAINT
.
Data
(
)
)
;
}
mDocument
=
nullptr
;
mPresShell
=
nullptr
;
}
void
MobileViewportManager
:
:
SetRestoreResolution
(
float
aResolution
LayoutDeviceIntSize
aDisplaySize
)
{
SetRestoreResolution
(
aResolution
)
;
ScreenIntSize
restoreDisplaySize
=
ViewAs
<
ScreenPixel
>
(
aDisplaySize
PixelCastJustification
:
:
LayoutDeviceIsScreenForBounds
)
;
mRestoreDisplaySize
=
Some
(
restoreDisplaySize
)
;
}
void
MobileViewportManager
:
:
SetRestoreResolution
(
float
aResolution
)
{
mRestoreResolution
=
Some
(
aResolution
)
;
}
float
MobileViewportManager
:
:
ComputeIntrinsicResolution
(
)
const
{
ScreenIntSize
displaySize
=
ViewAs
<
ScreenPixel
>
(
mDisplaySize
PixelCastJustification
:
:
LayoutDeviceIsScreenForBounds
)
;
CSSToScreenScale
intrinsicScale
=
ComputeIntrinsicScale
(
mDocument
-
>
GetViewportInfo
(
displaySize
)
displaySize
mMobileViewportSize
)
;
CSSToLayoutDeviceScale
cssToDev
=
mPresShell
-
>
GetPresContext
(
)
-
>
CSSToDevPixelScale
(
)
;
return
(
intrinsicScale
/
cssToDev
)
.
scale
;
}
mozilla
:
:
CSSToScreenScale
MobileViewportManager
:
:
ComputeIntrinsicScale
(
const
nsViewportInfo
&
aViewportInfo
const
mozilla
:
:
ScreenIntSize
&
aDisplaySize
const
mozilla
:
:
CSSSize
&
aViewportOrContentSize
)
const
{
CSSToScreenScale
intrinsicScale
=
MaxScaleRatio
(
ScreenSize
(
aDisplaySize
)
aViewportOrContentSize
)
;
MVM_LOG
(
"
%
p
:
Intrinsic
computed
zoom
is
%
f
\
n
"
this
intrinsicScale
.
scale
)
;
return
ClampZoom
(
intrinsicScale
aViewportInfo
)
;
}
void
MobileViewportManager
:
:
RequestReflow
(
)
{
MVM_LOG
(
"
%
p
:
got
a
reflow
request
\
n
"
this
)
;
RefreshViewportSize
(
false
)
;
}
void
MobileViewportManager
:
:
ResolutionUpdated
(
)
{
MVM_LOG
(
"
%
p
:
resolution
updated
\
n
"
this
)
;
if
(
!
mPainted
)
{
SetRestoreResolution
(
mPresShell
-
>
GetResolution
(
)
)
;
}
RefreshVisualViewportSize
(
)
;
}
NS_IMETHODIMP
MobileViewportManager
:
:
HandleEvent
(
dom
:
:
Event
*
event
)
{
nsAutoString
type
;
event
-
>
GetType
(
type
)
;
if
(
type
.
Equals
(
DOM_META_ADDED
)
)
{
MVM_LOG
(
"
%
p
:
got
a
dom
-
meta
-
added
event
\
n
"
this
)
;
RefreshViewportSize
(
mPainted
)
;
}
else
if
(
type
.
Equals
(
DOM_META_CHANGED
)
)
{
MVM_LOG
(
"
%
p
:
got
a
dom
-
meta
-
changed
event
\
n
"
this
)
;
RefreshViewportSize
(
mPainted
)
;
}
else
if
(
type
.
Equals
(
FULL_ZOOM_CHANGE
)
)
{
MVM_LOG
(
"
%
p
:
got
a
full
-
zoom
-
change
event
\
n
"
this
)
;
RefreshViewportSize
(
false
)
;
}
else
if
(
type
.
Equals
(
LOAD
)
)
{
MVM_LOG
(
"
%
p
:
got
a
load
event
\
n
"
this
)
;
if
(
!
mPainted
)
{
SetInitialViewport
(
)
;
}
}
return
NS_OK
;
}
NS_IMETHODIMP
MobileViewportManager
:
:
Observe
(
nsISupports
*
aSubject
const
char
*
aTopic
const
char16_t
*
aData
)
{
if
(
SameCOMIdentity
(
aSubject
ToSupports
(
mDocument
)
)
&
&
BEFORE_FIRST_PAINT
.
EqualsASCII
(
aTopic
)
)
{
MVM_LOG
(
"
%
p
:
got
a
before
-
first
-
paint
event
\
n
"
this
)
;
if
(
!
mPainted
)
{
SetInitialViewport
(
)
;
}
}
return
NS_OK
;
}
void
MobileViewportManager
:
:
SetInitialViewport
(
)
{
MVM_LOG
(
"
%
p
:
setting
initial
viewport
\
n
"
this
)
;
mIsFirstPaint
=
true
;
mPainted
=
true
;
RefreshViewportSize
(
false
)
;
}
CSSToScreenScale
MobileViewportManager
:
:
ClampZoom
(
const
CSSToScreenScale
&
aZoom
const
nsViewportInfo
&
aViewportInfo
)
const
{
CSSToScreenScale
zoom
=
aZoom
;
if
(
zoom
<
aViewportInfo
.
GetMinZoom
(
)
)
{
zoom
=
aViewportInfo
.
GetMinZoom
(
)
;
MVM_LOG
(
"
%
p
:
Clamped
to
%
f
\
n
"
this
zoom
.
scale
)
;
}
if
(
zoom
>
aViewportInfo
.
GetMaxZoom
(
)
)
{
zoom
=
aViewportInfo
.
GetMaxZoom
(
)
;
MVM_LOG
(
"
%
p
:
Clamped
to
%
f
\
n
"
this
zoom
.
scale
)
;
}
return
zoom
;
}
CSSToScreenScale
MobileViewportManager
:
:
ScaleZoomWithDisplayWidth
(
const
CSSToScreenScale
&
aZoom
const
float
&
aDisplayWidthChangeRatio
const
CSSSize
&
aNewViewport
const
CSSSize
&
aOldViewport
)
{
float
cssViewportChangeRatio
=
(
aOldViewport
.
width
=
=
0
)
?
1
.
0f
:
aNewViewport
.
width
/
aOldViewport
.
width
;
CSSToScreenScale
newZoom
(
aZoom
.
scale
*
aDisplayWidthChangeRatio
/
cssViewportChangeRatio
)
;
MVM_LOG
(
"
%
p
:
Old
zoom
was
%
f
changed
by
%
f
/
%
f
to
%
f
\
n
"
this
aZoom
.
scale
aDisplayWidthChangeRatio
cssViewportChangeRatio
newZoom
.
scale
)
;
return
newZoom
;
}
static
CSSToScreenScale
ResolutionToZoom
(
LayoutDeviceToLayerScale
aResolution
CSSToLayoutDeviceScale
aCssToDev
)
{
return
ViewTargetAs
<
ScreenPixel
>
(
aCssToDev
*
aResolution
/
ParentLayerToLayerScale
(
1
)
PixelCastJustification
:
:
ScreenIsParentLayerForRoot
)
;
}
static
LayoutDeviceToLayerScale
ZoomToResolution
(
CSSToScreenScale
aZoom
CSSToLayoutDeviceScale
aCssToDev
)
{
return
ViewTargetAs
<
ParentLayerPixel
>
(
aZoom
PixelCastJustification
:
:
ScreenIsParentLayerForRoot
)
/
aCssToDev
*
ParentLayerToLayerScale
(
1
)
;
}
void
MobileViewportManager
:
:
UpdateResolution
(
const
nsViewportInfo
&
aViewportInfo
const
ScreenIntSize
&
aDisplaySize
const
CSSSize
&
aViewportOrContentSize
const
Maybe
<
float
>
&
aDisplayWidthChangeRatio
UpdateType
aType
)
{
CSSToLayoutDeviceScale
cssToDev
=
mPresShell
-
>
GetPresContext
(
)
-
>
CSSToDevPixelScale
(
)
;
LayoutDeviceToLayerScale
res
(
mPresShell
-
>
GetResolution
(
)
)
;
CSSToScreenScale
zoom
=
ResolutionToZoom
(
res
cssToDev
)
;
Maybe
<
CSSToScreenScale
>
newZoom
;
ScreenIntSize
compositionSize
=
GetCompositionSize
(
aDisplaySize
)
;
CSSToScreenScale
intrinsicScale
=
ComputeIntrinsicScale
(
aViewportInfo
compositionSize
aViewportOrContentSize
)
;
if
(
aType
=
=
UpdateType
:
:
ViewportSize
)
{
const
CSSSize
&
viewportSize
=
aViewportOrContentSize
;
if
(
mIsFirstPaint
)
{
CSSToScreenScale
defaultZoom
;
if
(
mRestoreResolution
)
{
LayoutDeviceToLayerScale
restoreResolution
(
mRestoreResolution
.
value
(
)
)
;
CSSToScreenScale
restoreZoom
=
ResolutionToZoom
(
restoreResolution
cssToDev
)
;
if
(
mRestoreDisplaySize
)
{
CSSSize
prevViewport
=
mDocument
-
>
GetViewportInfo
(
mRestoreDisplaySize
.
value
(
)
)
.
GetSize
(
)
;
float
restoreDisplayWidthChangeRatio
=
(
mRestoreDisplaySize
.
value
(
)
.
width
>
0
)
?
(
float
)
compositionSize
.
width
/
(
float
)
mRestoreDisplaySize
.
value
(
)
.
width
:
1
.
0f
;
restoreZoom
=
ScaleZoomWithDisplayWidth
(
restoreZoom
restoreDisplayWidthChangeRatio
viewportSize
prevViewport
)
;
}
defaultZoom
=
restoreZoom
;
MVM_LOG
(
"
%
p
:
restored
zoom
is
%
f
\
n
"
this
defaultZoom
.
scale
)
;
defaultZoom
=
ClampZoom
(
defaultZoom
aViewportInfo
)
;
}
else
{
defaultZoom
=
aViewportInfo
.
GetDefaultZoom
(
)
;
MVM_LOG
(
"
%
p
:
default
zoom
from
viewport
is
%
f
\
n
"
this
defaultZoom
.
scale
)
;
if
(
!
aViewportInfo
.
IsDefaultZoomValid
(
)
)
{
defaultZoom
=
intrinsicScale
;
}
}
MOZ_ASSERT
(
aViewportInfo
.
GetMinZoom
(
)
<
=
defaultZoom
&
&
defaultZoom
<
=
aViewportInfo
.
GetMaxZoom
(
)
)
;
newZoom
=
Some
(
defaultZoom
)
;
}
else
{
if
(
aDisplayWidthChangeRatio
)
{
newZoom
=
Some
(
ScaleZoomWithDisplayWidth
(
zoom
aDisplayWidthChangeRatio
.
value
(
)
viewportSize
mMobileViewportSize
)
)
;
}
}
}
else
{
MOZ_ASSERT
(
aType
=
=
UpdateType
:
:
ContentSize
)
;
MOZ_ASSERT
(
aDisplayWidthChangeRatio
.
isNothing
(
)
)
;
if
(
mIsFirstPaint
&
&
!
mRestoreResolution
&
&
!
aViewportInfo
.
IsDefaultZoomValid
(
)
)
{
if
(
zoom
!
=
intrinsicScale
)
{
newZoom
=
Some
(
intrinsicScale
)
;
}
}
else
{
if
(
zoom
<
intrinsicScale
)
{
newZoom
=
Some
(
intrinsicScale
)
;
}
}
}
if
(
newZoom
)
{
LayoutDeviceToLayerScale
resolution
=
ZoomToResolution
(
*
newZoom
cssToDev
)
;
MVM_LOG
(
"
%
p
:
setting
resolution
%
f
\
n
"
this
resolution
.
scale
)
;
mPresShell
-
>
SetResolutionAndScaleTo
(
resolution
.
scale
nsIPresShell
:
:
ChangeOrigin
:
:
eMainThread
)
;
MVM_LOG
(
"
%
p
:
New
zoom
is
%
f
\
n
"
this
newZoom
-
>
scale
)
;
}
if
(
newZoom
|
|
aType
=
=
UpdateType
:
:
ViewportSize
)
{
UpdateVisualViewportSize
(
aDisplaySize
newZoom
?
*
newZoom
:
zoom
)
;
}
}
ScreenIntSize
MobileViewportManager
:
:
GetCompositionSize
(
const
ScreenIntSize
&
aDisplaySize
)
const
{
ScreenIntSize
compositionSize
(
aDisplaySize
)
;
ScreenMargin
scrollbars
=
LayoutDeviceMargin
:
:
FromAppUnits
(
nsLayoutUtils
:
:
ScrollbarAreaToExcludeFromCompositionBoundsFor
(
mPresShell
-
>
GetRootScrollFrame
(
)
)
mPresShell
-
>
GetPresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
)
*
LayoutDeviceToScreenScale
(
1
.
0f
)
;
compositionSize
.
width
-
=
scrollbars
.
LeftRight
(
)
;
compositionSize
.
height
-
=
scrollbars
.
TopBottom
(
)
;
return
compositionSize
;
}
void
MobileViewportManager
:
:
UpdateVisualViewportSize
(
const
ScreenIntSize
&
aDisplaySize
const
CSSToScreenScale
&
aZoom
)
{
ScreenSize
compositionSize
=
ScreenSize
(
GetCompositionSize
(
aDisplaySize
)
)
;
CSSSize
compSize
=
compositionSize
/
aZoom
;
MVM_LOG
(
"
%
p
:
Setting
VVPS
%
s
\
n
"
this
Stringify
(
compSize
)
.
c_str
(
)
)
;
nsLayoutUtils
:
:
SetVisualViewportSize
(
mPresShell
compSize
)
;
}
void
MobileViewportManager
:
:
UpdateDisplayPortMargins
(
)
{
if
(
nsIFrame
*
root
=
mPresShell
-
>
GetRootScrollFrame
(
)
)
{
bool
hasDisplayPort
=
nsLayoutUtils
:
:
HasDisplayPort
(
root
-
>
GetContent
(
)
)
;
bool
hasResolution
=
mPresShell
-
>
GetResolution
(
)
!
=
1
.
0f
;
if
(
!
hasDisplayPort
&
&
!
hasResolution
)
{
return
;
}
nsRect
displayportBase
=
nsRect
(
nsPoint
(
0
0
)
nsLayoutUtils
:
:
CalculateCompositionSizeForFrame
(
root
)
)
;
MOZ_ASSERT
(
mPresShell
-
>
GetPresContext
(
)
-
>
IsRootContentDocument
(
)
)
;
nsLayoutUtils
:
:
SetDisplayPortBaseIfNotSet
(
root
-
>
GetContent
(
)
displayportBase
)
;
nsIScrollableFrame
*
scrollable
=
do_QueryFrame
(
root
)
;
nsLayoutUtils
:
:
CalculateAndSetDisplayPortMargins
(
scrollable
nsLayoutUtils
:
:
RepaintMode
:
:
DoNotRepaint
)
;
}
}
void
MobileViewportManager
:
:
RefreshVisualViewportSize
(
)
{
ScreenIntSize
displaySize
=
ViewAs
<
ScreenPixel
>
(
mDisplaySize
PixelCastJustification
:
:
LayoutDeviceIsScreenForBounds
)
;
CSSToLayoutDeviceScale
cssToDev
=
mPresShell
-
>
GetPresContext
(
)
-
>
CSSToDevPixelScale
(
)
;
LayoutDeviceToLayerScale
res
(
mPresShell
-
>
GetResolution
(
)
)
;
CSSToScreenScale
zoom
=
ViewTargetAs
<
ScreenPixel
>
(
cssToDev
*
res
/
ParentLayerToLayerScale
(
1
)
PixelCastJustification
:
:
ScreenIsParentLayerForRoot
)
;
UpdateVisualViewportSize
(
displaySize
zoom
)
;
}
void
MobileViewportManager
:
:
RefreshViewportSize
(
bool
aForceAdjustResolution
)
{
Maybe
<
float
>
displayWidthChangeRatio
;
LayoutDeviceIntSize
newDisplaySize
;
if
(
nsLayoutUtils
:
:
GetContentViewerSize
(
mPresShell
-
>
GetPresContext
(
)
newDisplaySize
)
)
{
if
(
mDisplaySize
.
width
>
0
)
{
if
(
aForceAdjustResolution
|
|
mDisplaySize
.
width
!
=
newDisplaySize
.
width
)
{
displayWidthChangeRatio
=
Some
(
(
float
)
newDisplaySize
.
width
/
(
float
)
mDisplaySize
.
width
)
;
}
}
else
if
(
aForceAdjustResolution
)
{
displayWidthChangeRatio
=
Some
(
1
.
0f
)
;
}
MVM_LOG
(
"
%
p
:
Display
width
change
ratio
is
%
f
\
n
"
this
displayWidthChangeRatio
.
valueOr
(
0
.
0f
)
)
;
mDisplaySize
=
newDisplaySize
;
}
MVM_LOG
(
"
%
p
:
Computing
CSS
viewport
using
%
d
%
d
\
n
"
this
mDisplaySize
.
width
mDisplaySize
.
height
)
;
if
(
mDisplaySize
.
width
=
=
0
|
|
mDisplaySize
.
height
=
=
0
)
{
return
;
}
ScreenIntSize
displaySize
=
ViewAs
<
ScreenPixel
>
(
mDisplaySize
PixelCastJustification
:
:
LayoutDeviceIsScreenForBounds
)
;
nsViewportInfo
viewportInfo
=
mDocument
-
>
GetViewportInfo
(
displaySize
)
;
CSSSize
viewport
=
viewportInfo
.
GetSize
(
)
;
MVM_LOG
(
"
%
p
:
Computed
CSS
viewport
%
s
\
n
"
this
Stringify
(
viewport
)
.
c_str
(
)
)
;
if
(
!
mIsFirstPaint
&
&
mMobileViewportSize
=
=
viewport
)
{
return
;
}
MVM_LOG
(
"
%
p
:
Updating
properties
because
%
d
|
|
%
d
\
n
"
this
mIsFirstPaint
mMobileViewportSize
!
=
viewport
)
;
if
(
gfxPrefs
:
:
APZAllowZooming
(
)
)
{
UpdateResolution
(
viewportInfo
displaySize
viewport
displayWidthChangeRatio
UpdateType
:
:
ViewportSize
)
;
}
else
{
RefreshVisualViewportSize
(
)
;
}
if
(
gfxPlatform
:
:
AsyncPanZoomEnabled
(
)
)
{
UpdateDisplayPortMargins
(
)
;
}
CSSSize
oldSize
=
mMobileViewportSize
;
mMobileViewportSize
=
viewport
;
mPresShell
-
>
ResizeReflowIgnoreOverride
(
nsPresContext
:
:
CSSPixelsToAppUnits
(
viewport
.
width
)
nsPresContext
:
:
CSSPixelsToAppUnits
(
viewport
.
height
)
nsPresContext
:
:
CSSPixelsToAppUnits
(
oldSize
.
width
)
nsPresContext
:
:
CSSPixelsToAppUnits
(
oldSize
.
height
)
)
;
ShrinkToDisplaySizeIfNeeded
(
viewportInfo
displaySize
)
;
mIsFirstPaint
=
false
;
}
void
MobileViewportManager
:
:
ShrinkToDisplaySizeIfNeeded
(
nsViewportInfo
&
aViewportInfo
const
ScreenIntSize
&
aDisplaySize
)
{
if
(
!
gfxPrefs
:
:
APZAllowZooming
(
)
)
{
return
;
}
nsIScrollableFrame
*
rootScrollableFrame
=
mPresShell
-
>
GetRootScrollFrameAsScrollable
(
)
;
if
(
rootScrollableFrame
)
{
nsRect
scrollableRect
=
nsLayoutUtils
:
:
CalculateScrollableRectForFrame
(
rootScrollableFrame
nullptr
)
;
CSSSize
contentSize
=
CSSSize
:
:
FromAppUnits
(
scrollableRect
.
Size
(
)
)
;
UpdateResolution
(
aViewportInfo
aDisplaySize
contentSize
Nothing
(
)
UpdateType
:
:
ContentSize
)
;
}
}
