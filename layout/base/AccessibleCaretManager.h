#
ifndef
AccessibleCaretManager_h
#
define
AccessibleCaretManager_h
#
include
"
AccessibleCaret
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsCoord
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsISelectionListener
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
"
mozilla
/
dom
/
CaretStateChangedEvent
.
h
"
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
class
nsFrameSelection
;
class
nsIContent
;
class
nsIPresShell
;
struct
nsPoint
;
namespace
mozilla
{
namespace
dom
{
class
Element
;
class
Selection
;
}
class
AccessibleCaretManager
{
public
:
explicit
AccessibleCaretManager
(
nsIPresShell
*
aPresShell
)
;
virtual
~
AccessibleCaretManager
(
)
;
void
Terminate
(
)
;
virtual
nsresult
PressCaret
(
const
nsPoint
&
aPoint
)
;
virtual
nsresult
DragCaret
(
const
nsPoint
&
aPoint
)
;
virtual
nsresult
ReleaseCaret
(
)
;
virtual
nsresult
TapCaret
(
const
nsPoint
&
aPoint
)
;
virtual
nsresult
SelectWordOrShortcut
(
const
nsPoint
&
aPoint
)
;
virtual
void
OnScrollStart
(
)
;
virtual
void
OnScrollEnd
(
)
;
virtual
void
OnScrollPositionChanged
(
)
;
virtual
void
OnReflow
(
)
;
virtual
void
OnBlur
(
)
;
virtual
nsresult
OnSelectionChanged
(
nsIDOMDocument
*
aDoc
nsISelection
*
aSel
int16_t
aReason
)
;
virtual
void
OnKeyboardEvent
(
)
;
protected
:
enum
class
CaretMode
:
uint8_t
{
None
Cursor
Selection
}
;
friend
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
CaretMode
&
aCaretMode
)
;
enum
class
UpdateCaretsHint
:
uint8_t
{
Default
RespectOldAppearance
}
;
friend
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
UpdateCaretsHint
&
aResult
)
;
void
UpdateCarets
(
UpdateCaretsHint
aHint
=
UpdateCaretsHint
:
:
Default
)
;
void
HideCarets
(
)
;
void
DoNotShowCarets
(
)
;
void
UpdateCaretsForCursorMode
(
UpdateCaretsHint
aHint
)
;
void
UpdateCaretsForSelectionMode
(
UpdateCaretsHint
aHint
)
;
void
ProvideHapticFeedback
(
)
;
nsIFrame
*
GetFocusableFrame
(
nsIFrame
*
aFrame
)
const
;
void
ChangeFocusToOrClearOldFocus
(
nsIFrame
*
aFrame
)
const
;
nsresult
SelectWord
(
nsIFrame
*
aFrame
const
nsPoint
&
aPoint
)
const
;
void
SetSelectionDragState
(
bool
aState
)
const
;
void
SetSelectionDirection
(
nsDirection
aDir
)
const
;
nsIFrame
*
FindFirstNodeWithFrame
(
bool
aBackward
int32_t
*
aOutOffset
)
const
;
nsresult
DragCaretInternal
(
const
nsPoint
&
aPoint
)
;
nsPoint
AdjustDragBoundary
(
const
nsPoint
&
aPoint
)
const
;
void
ClearMaintainedSelection
(
)
const
;
void
FlushLayout
(
)
const
;
dom
:
:
Element
*
GetEditingHostForFrame
(
nsIFrame
*
aFrame
)
const
;
dom
:
:
Selection
*
GetSelection
(
)
const
;
already_AddRefed
<
nsFrameSelection
>
GetFrameSelection
(
)
const
;
nsRect
GetContentBoundaryForFrame
(
nsIFrame
*
aFrame
)
const
;
bool
CompareRangeWithContentOffset
(
nsIFrame
:
:
ContentOffsets
&
aOffsets
)
;
uint32_t
CaretTimeoutMs
(
)
const
;
void
LaunchCaretTimeoutTimer
(
)
;
void
CancelCaretTimeoutTimer
(
)
;
virtual
bool
IsTerminated
(
)
const
{
return
!
mPresShell
;
}
virtual
CaretMode
GetCaretMode
(
)
const
;
virtual
bool
CompareTreePosition
(
nsIFrame
*
aStartFrame
nsIFrame
*
aEndFrame
)
const
;
virtual
void
UpdateCaretsForTilt
(
)
;
virtual
bool
IsCaretDisplayableInCursorMode
(
nsIFrame
*
*
aOutFrame
=
nullptr
int32_t
*
aOutOffset
=
nullptr
)
const
;
virtual
bool
HasNonEmptyTextContent
(
nsINode
*
aNode
)
const
;
virtual
void
DispatchCaretStateChangedEvent
(
dom
:
:
CaretChangedReason
aReason
)
const
;
nscoord
mOffsetYToCaretLogicalPosition
=
NS_UNCONSTRAINEDSIZE
;
nsIPresShell
*
MOZ_NON_OWNING_REF
mPresShell
=
nullptr
;
UniquePtr
<
AccessibleCaret
>
mFirstCaret
;
UniquePtr
<
AccessibleCaret
>
mSecondCaret
;
AccessibleCaret
*
mActiveCaret
=
nullptr
;
nsCOMPtr
<
nsITimer
>
mCaretTimeoutTimer
;
CaretMode
mLastUpdateCaretMode
=
CaretMode
:
:
None
;
AccessibleCaret
:
:
Appearance
mFirstCaretAppearanceOnScrollStart
=
AccessibleCaret
:
:
Appearance
:
:
None
;
AccessibleCaret
:
:
Appearance
mSecondCaretAppearanceOnScrollStart
=
AccessibleCaret
:
:
Appearance
:
:
None
;
static
const
int32_t
kAutoScrollTimerDelay
=
30
;
static
const
int32_t
kBoundaryAppUnits
=
61
;
static
bool
sSelectionBarEnabled
;
static
bool
sCaretShownWhenLongTappingOnEmptyContent
;
static
bool
sCaretsExtendedVisibility
;
static
bool
sCaretsScriptUpdates
;
static
bool
sHapticFeedback
;
}
;
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
AccessibleCaretManager
:
:
CaretMode
&
aCaretMode
)
;
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
AccessibleCaretManager
:
:
UpdateCaretsHint
&
aResult
)
;
}
#
endif
