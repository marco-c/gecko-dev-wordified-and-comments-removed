#
ifndef
AccessibleCaretManager_h
#
define
AccessibleCaretManager_h
#
include
"
AccessibleCaret
.
h
"
#
include
"
mozilla
/
dom
/
CaretStateChangedEvent
.
h
"
#
include
"
mozilla
/
EnumSet
.
h
"
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsCoord
.
h
"
#
include
"
nsIDOMMouseEvent
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsISelectionListener
.
h
"
class
nsFrameSelection
;
class
nsIContent
;
class
nsIPresShell
;
struct
nsPoint
;
namespace
mozilla
{
namespace
dom
{
class
Element
;
class
Selection
;
}
class
AccessibleCaretManager
{
public
:
explicit
AccessibleCaretManager
(
nsIPresShell
*
aPresShell
)
;
virtual
~
AccessibleCaretManager
(
)
;
void
Terminate
(
)
;
virtual
nsresult
PressCaret
(
const
nsPoint
&
aPoint
EventClassID
aEventClass
)
;
virtual
nsresult
DragCaret
(
const
nsPoint
&
aPoint
)
;
virtual
nsresult
ReleaseCaret
(
)
;
virtual
nsresult
TapCaret
(
const
nsPoint
&
aPoint
)
;
virtual
nsresult
SelectWordOrShortcut
(
const
nsPoint
&
aPoint
)
;
virtual
void
OnScrollStart
(
)
;
virtual
void
OnScrollEnd
(
)
;
virtual
void
OnScrollPositionChanged
(
)
;
virtual
void
OnReflow
(
)
;
virtual
void
OnBlur
(
)
;
virtual
nsresult
OnSelectionChanged
(
nsIDOMDocument
*
aDoc
nsISelection
*
aSel
int16_t
aReason
)
;
virtual
void
OnKeyboardEvent
(
)
;
virtual
void
OnFrameReconstruction
(
)
;
void
SetLastInputSource
(
uint16_t
aInputSource
)
;
protected
:
enum
class
CaretMode
:
uint8_t
{
None
Cursor
Selection
}
;
friend
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
CaretMode
&
aCaretMode
)
;
enum
class
UpdateCaretsHint
:
uint8_t
{
Default
RespectOldAppearance
DispatchNoEvent
}
;
using
UpdateCaretsHintSet
=
mozilla
:
:
EnumSet
<
UpdateCaretsHint
>
;
friend
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
UpdateCaretsHint
&
aResult
)
;
void
UpdateCarets
(
const
UpdateCaretsHintSet
&
aHints
=
UpdateCaretsHint
:
:
Default
)
;
void
HideCarets
(
)
;
void
UpdateCaretsForCursorMode
(
const
UpdateCaretsHintSet
&
aHints
)
;
void
UpdateCaretsForSelectionMode
(
const
UpdateCaretsHintSet
&
aHints
)
;
void
ProvideHapticFeedback
(
)
;
nsIFrame
*
GetFocusableFrame
(
nsIFrame
*
aFrame
)
const
;
void
ChangeFocusToOrClearOldFocus
(
nsIFrame
*
aFrame
)
const
;
nsresult
SelectWord
(
nsIFrame
*
aFrame
const
nsPoint
&
aPoint
)
const
;
void
SetSelectionDragState
(
bool
aState
)
const
;
bool
IsPhoneNumber
(
nsAString
&
aCandidate
)
const
;
void
SelectMoreIfPhoneNumber
(
)
const
;
void
ExtendPhoneNumberSelection
(
const
nsAString
&
aDirection
)
const
;
void
SetSelectionDirection
(
nsDirection
aDir
)
const
;
nsIFrame
*
GetFrameForFirstRangeStartOrLastRangeEnd
(
nsDirection
aDirection
int32_t
*
aOutOffset
nsIContent
*
*
aOutContent
=
nullptr
int32_t
*
aOutContentOffset
=
nullptr
)
const
;
nsresult
DragCaretInternal
(
const
nsPoint
&
aPoint
)
;
nsPoint
AdjustDragBoundary
(
const
nsPoint
&
aPoint
)
const
;
void
StartSelectionAutoScrollTimer
(
const
nsPoint
&
aPoint
)
const
;
void
StopSelectionAutoScrollTimer
(
)
const
;
void
ClearMaintainedSelection
(
)
const
;
MOZ_MUST_USE
bool
FlushLayout
(
)
;
dom
:
:
Element
*
GetEditingHostForFrame
(
nsIFrame
*
aFrame
)
const
;
dom
:
:
Selection
*
GetSelection
(
)
const
;
already_AddRefed
<
nsFrameSelection
>
GetFrameSelection
(
)
const
;
nsAutoString
StringifiedSelection
(
)
const
;
nsRect
GetAllChildFrameRectsUnion
(
nsIFrame
*
aFrame
)
const
;
bool
RestrictCaretDraggingOffsets
(
nsIFrame
:
:
ContentOffsets
&
aOffsets
)
;
virtual
bool
IsTerminated
(
)
const
{
return
!
mPresShell
;
}
virtual
CaretMode
GetCaretMode
(
)
const
;
virtual
bool
CompareTreePosition
(
nsIFrame
*
aStartFrame
nsIFrame
*
aEndFrame
)
const
;
virtual
bool
UpdateCaretsForOverlappingTilt
(
)
;
virtual
void
UpdateCaretsForAlwaysTilt
(
nsIFrame
*
aStartFrame
nsIFrame
*
aEndFrame
)
;
virtual
bool
IsCaretDisplayableInCursorMode
(
nsIFrame
*
*
aOutFrame
=
nullptr
int32_t
*
aOutOffset
=
nullptr
)
const
;
virtual
bool
HasNonEmptyTextContent
(
nsINode
*
aNode
)
const
;
virtual
void
DispatchCaretStateChangedEvent
(
dom
:
:
CaretChangedReason
aReason
)
;
nscoord
mOffsetYToCaretLogicalPosition
=
NS_UNCONSTRAINEDSIZE
;
nsIPresShell
*
MOZ_NON_OWNING_REF
mPresShell
=
nullptr
;
UniquePtr
<
AccessibleCaret
>
mFirstCaret
;
UniquePtr
<
AccessibleCaret
>
mSecondCaret
;
AccessibleCaret
*
mActiveCaret
=
nullptr
;
CaretMode
mLastUpdateCaretMode
=
CaretMode
:
:
None
;
AccessibleCaret
:
:
Appearance
mFirstCaretAppearanceOnScrollStart
=
AccessibleCaret
:
:
Appearance
:
:
None
;
AccessibleCaret
:
:
Appearance
mSecondCaretAppearanceOnScrollStart
=
AccessibleCaret
:
:
Appearance
:
:
None
;
uint16_t
mLastInputSource
=
nsIDOMMouseEvent
:
:
MOZ_SOURCE_UNKNOWN
;
bool
mIsScrollStarted
=
false
;
bool
mFlushingLayout
=
false
;
static
const
int32_t
kAutoScrollTimerDelay
=
30
;
static
const
int32_t
kBoundaryAppUnits
=
61
;
static
bool
sSelectionBarEnabled
;
static
bool
sExtendSelectionForPhoneNumber
;
static
bool
sCaretShownWhenLongTappingOnEmptyContent
;
static
bool
sCaretsAlwaysTilt
;
static
bool
sCaretsAlwaysShowWhenScrolling
;
static
bool
sCaretsScriptUpdates
;
static
bool
sCaretsAllowDraggingAcrossOtherCaret
;
static
bool
sHapticFeedback
;
static
bool
sHideCaretsForMouseInput
;
}
;
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
AccessibleCaretManager
:
:
CaretMode
&
aCaretMode
)
;
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
AccessibleCaretManager
:
:
UpdateCaretsHint
&
aResult
)
;
}
#
endif
