#
include
"
nsQuoteList
.
h
"
#
include
"
nsReadableUtils
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
mozilla
/
dom
/
Text
.
h
"
using
namespace
mozilla
;
bool
nsQuoteNode
:
:
InitTextFrame
(
nsGenConList
*
aList
nsIFrame
*
aPseudoFrame
nsIFrame
*
aTextFrame
)
{
nsGenConNode
:
:
InitTextFrame
(
aList
aPseudoFrame
aTextFrame
)
;
nsQuoteList
*
quoteList
=
static_cast
<
nsQuoteList
*
>
(
aList
)
;
bool
dirty
=
false
;
quoteList
-
>
Insert
(
this
)
;
if
(
quoteList
-
>
IsLast
(
this
)
)
quoteList
-
>
Calc
(
this
)
;
else
dirty
=
true
;
if
(
IsRealQuote
(
)
)
{
aTextFrame
-
>
GetContent
(
)
-
>
AsText
(
)
-
>
SetText
(
*
Text
(
)
false
)
;
}
return
dirty
;
}
const
nsString
*
nsQuoteNode
:
:
Text
(
)
{
NS_ASSERTION
(
mType
=
=
StyleContentType
:
:
OpenQuote
|
|
mType
=
=
StyleContentType
:
:
CloseQuote
"
should
only
be
called
when
mText
should
be
non
-
null
"
)
;
const
nsStyleQuoteValues
:
:
QuotePairArray
&
quotePairs
=
mPseudoFrame
-
>
StyleList
(
)
-
>
GetQuotePairs
(
)
;
int32_t
quotesCount
=
quotePairs
.
Length
(
)
;
int32_t
quoteDepth
=
Depth
(
)
;
if
(
quoteDepth
>
=
quotesCount
)
quoteDepth
=
quotesCount
-
1
;
const
nsString
*
result
;
if
(
quoteDepth
=
=
-
1
)
{
result
=
&
EmptyString
(
)
;
}
else
{
result
=
StyleContentType
:
:
OpenQuote
=
=
mType
?
&
quotePairs
[
quoteDepth
]
.
first
:
&
quotePairs
[
quoteDepth
]
.
second
;
}
return
result
;
}
void
nsQuoteList
:
:
Calc
(
nsQuoteNode
*
aNode
)
{
if
(
aNode
=
=
FirstNode
(
)
)
{
aNode
-
>
mDepthBefore
=
0
;
}
else
{
aNode
-
>
mDepthBefore
=
Prev
(
aNode
)
-
>
DepthAfter
(
)
;
}
}
void
nsQuoteList
:
:
RecalcAll
(
)
{
for
(
nsQuoteNode
*
node
=
FirstNode
(
)
;
node
;
node
=
Next
(
node
)
)
{
int32_t
oldDepth
=
node
-
>
mDepthBefore
;
Calc
(
node
)
;
if
(
node
-
>
mDepthBefore
!
=
oldDepth
&
&
node
-
>
mText
&
&
node
-
>
IsRealQuote
(
)
)
node
-
>
mText
-
>
SetData
(
*
node
-
>
Text
(
)
IgnoreErrors
(
)
)
;
}
}
#
ifdef
DEBUG
void
nsQuoteList
:
:
PrintChain
(
)
{
printf
(
"
Chain
:
\
n
"
)
;
for
(
nsQuoteNode
*
node
=
FirstNode
(
)
;
node
;
node
=
Next
(
node
)
)
{
printf
(
"
%
p
%
d
-
"
static_cast
<
void
*
>
(
node
)
node
-
>
mDepthBefore
)
;
switch
(
node
-
>
mType
)
{
case
StyleContentType
:
:
OpenQuote
:
printf
(
"
open
"
)
;
break
;
case
StyleContentType
:
:
NoOpenQuote
:
printf
(
"
noOpen
"
)
;
break
;
case
StyleContentType
:
:
CloseQuote
:
printf
(
"
close
"
)
;
break
;
case
StyleContentType
:
:
NoCloseQuote
:
printf
(
"
noClose
"
)
;
break
;
default
:
printf
(
"
unknown
!
!
!
"
)
;
}
printf
(
"
%
d
-
%
d
"
node
-
>
Depth
(
)
node
-
>
DepthAfter
(
)
)
;
if
(
node
-
>
mText
)
{
nsAutoString
data
;
node
-
>
mText
-
>
GetData
(
data
)
;
printf
(
"
\
"
%
s
\
"
"
NS_ConvertUTF16toUTF8
(
data
)
.
get
(
)
)
;
}
printf
(
"
\
n
"
)
;
}
}
#
endif
