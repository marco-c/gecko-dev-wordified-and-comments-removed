#
ifndef
MobileViewportManager_h_
#
define
MobileViewportManager_h_
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
MVMContext
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIDOMEventListener
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
Units
.
h
"
class
nsViewportInfo
;
namespace
mozilla
{
class
MVMContext
;
namespace
dom
{
class
Document
;
class
EventTarget
;
}
}
class
MobileViewportManager
final
:
public
nsIDOMEventListener
public
nsIObserver
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIDOMEVENTLISTENER
NS_DECL_NSIOBSERVER
explicit
MobileViewportManager
(
mozilla
:
:
MVMContext
*
aContext
)
;
void
Destroy
(
)
;
void
SetRestoreResolution
(
float
aResolution
mozilla
:
:
LayoutDeviceIntSize
aDisplaySize
)
;
float
ComputeIntrinsicResolution
(
)
const
;
void
HandleDOMMetaAdded
(
)
;
private
:
void
SetRestoreResolution
(
float
aResolution
)
;
public
:
void
RequestReflow
(
bool
aForceAdjustResolution
)
;
void
ResolutionUpdated
(
mozilla
:
:
ResolutionChangeOrigin
aOrigin
)
;
void
SetInitialViewport
(
)
;
const
mozilla
:
:
LayoutDeviceIntSize
&
DisplaySize
(
)
const
{
return
mDisplaySize
;
}
;
void
ShrinkToDisplaySizeIfNeeded
(
nsViewportInfo
&
aViewportInfo
const
mozilla
:
:
ScreenIntSize
&
aDisplaySize
)
;
void
UpdateVisualViewportSizeByDynamicToolbar
(
mozilla
:
:
ScreenIntCoord
aToolbarHeight
)
;
nsSize
GetVisualViewportSizeUpdatedByDynamicToolbar
(
)
const
{
return
mVisualViewportSizeUpdatedByDynamicToolbar
;
}
private
:
~
MobileViewportManager
(
)
;
void
RefreshViewportSize
(
bool
aForceAdjustResolution
)
;
void
RefreshVisualViewportSize
(
)
;
mozilla
:
:
CSSToScreenScale
ClampZoom
(
const
mozilla
:
:
CSSToScreenScale
&
aZoom
const
nsViewportInfo
&
aViewportInfo
)
const
;
mozilla
:
:
CSSToScreenScale
ScaleZoomWithDisplayWidth
(
const
mozilla
:
:
CSSToScreenScale
&
aZoom
const
float
&
aDisplayWidthChangeRatio
const
mozilla
:
:
CSSSize
&
aNewViewport
const
mozilla
:
:
CSSSize
&
aOldViewport
)
;
enum
class
UpdateType
{
ViewportSize
ContentSize
}
;
void
UpdateResolution
(
const
nsViewportInfo
&
aViewportInfo
const
mozilla
:
:
ScreenIntSize
&
aDisplaySize
const
mozilla
:
:
CSSSize
&
aViewportOrContentSize
const
mozilla
:
:
Maybe
<
float
>
&
aDisplayWidthChangeRatio
UpdateType
aType
)
;
void
UpdateVisualViewportSize
(
const
mozilla
:
:
ScreenIntSize
&
aDisplaySize
const
mozilla
:
:
CSSToScreenScale
&
aZoom
)
;
void
UpdateDisplayPortMargins
(
)
;
mozilla
:
:
CSSToScreenScale
ComputeIntrinsicScale
(
const
nsViewportInfo
&
aViewportInfo
const
mozilla
:
:
ScreenIntSize
&
aDisplaySize
const
mozilla
:
:
CSSSize
&
aViewportOrContentSize
)
const
;
mozilla
:
:
ScreenIntSize
GetCompositionSize
(
const
mozilla
:
:
ScreenIntSize
&
aDisplaySize
)
const
;
mozilla
:
:
CSSToScreenScale
GetZoom
(
)
const
;
RefPtr
<
mozilla
:
:
MVMContext
>
mContext
;
bool
mIsFirstPaint
;
bool
mPainted
;
mozilla
:
:
LayoutDeviceIntSize
mDisplaySize
;
mozilla
:
:
CSSSize
mMobileViewportSize
;
mozilla
:
:
Maybe
<
float
>
mRestoreResolution
;
mozilla
:
:
Maybe
<
mozilla
:
:
ScreenIntSize
>
mRestoreDisplaySize
;
nsSize
mVisualViewportSizeUpdatedByDynamicToolbar
;
}
;
#
endif
