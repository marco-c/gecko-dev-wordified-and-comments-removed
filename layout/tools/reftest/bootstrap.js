const
Cm
=
Components
.
manager
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
function
processTerminated
(
)
{
return
new
Promise
(
resolve
=
>
{
Services
.
obs
.
addObserver
(
function
observe
(
subject
topic
)
{
if
(
topic
=
=
"
ipc
:
content
-
shutdown
"
)
{
Services
.
obs
.
removeObserver
(
observe
topic
)
;
resolve
(
)
;
}
}
"
ipc
:
content
-
shutdown
"
)
;
}
)
;
}
var
WindowListener
=
{
onOpenWindow
:
function
(
xulWin
)
{
Services
.
wm
.
removeListener
(
WindowListener
)
;
let
win
=
xulWin
.
docShell
.
domWindow
;
win
.
addEventListener
(
"
load
"
function
listener
(
)
{
for
(
win
of
Services
.
wm
.
getEnumerator
(
"
navigator
:
browser
"
)
)
{
break
;
}
ChromeUtils
.
import
(
"
resource
:
/
/
reftest
/
reftest
.
jsm
"
)
;
win
.
addEventListener
(
"
pageshow
"
function
(
)
{
win
.
setTimeout
(
function
(
)
{
OnRefTestLoad
(
win
)
;
}
0
)
;
}
{
once
:
true
}
)
;
}
{
once
:
true
}
)
;
}
}
;
function
startup
(
data
reason
)
{
if
(
Services
.
appinfo
.
OS
=
=
"
Android
"
)
{
Cm
.
addBootstrappedManifestLocation
(
data
.
installPath
)
;
Services
.
wm
.
addListener
(
WindowListener
)
;
return
;
}
let
resProto
=
Cc
[
"
mozilla
.
org
/
network
/
protocol
;
1
?
name
=
resource
"
]
.
getService
(
Ci
.
nsISubstitutingProtocolHandler
)
;
let
uri
=
Services
.
io
.
newURI
(
"
chrome
/
reftest
/
res
/
"
null
data
.
resourceURI
)
;
resProto
.
setSubstitutionWithFlags
(
"
reftest
"
uri
resProto
.
ALLOW_CONTENT_ACCESS
)
;
let
orig
=
Services
.
wm
.
getMostRecentWindow
(
"
navigator
:
browser
"
)
;
let
ios
=
Cc
[
"
mozilla
.
org
/
network
/
io
-
service
;
1
"
]
.
getService
(
Ci
.
nsIIOService
)
;
ios
.
manageOfflineStatus
=
false
;
ios
.
offline
=
false
;
let
wwatch
=
Cc
[
"
mozilla
.
org
/
embedcomp
/
window
-
watcher
;
1
"
]
.
getService
(
Ci
.
nsIWindowWatcher
)
;
let
dummy
=
wwatch
.
openWindow
(
null
"
about
:
blank
"
"
dummy
"
"
chrome
dialog
=
no
left
=
800
height
=
200
width
=
200
all
"
null
)
;
dummy
.
onload
=
async
function
(
)
{
orig
.
close
(
)
;
ChromeUtils
.
import
(
"
resource
:
/
/
reftest
/
PerTestCoverageUtils
.
jsm
"
)
;
if
(
PerTestCoverageUtils
.
enabled
)
{
await
processTerminated
(
)
;
}
dummy
.
focus
(
)
;
wwatch
.
openWindow
(
null
"
chrome
:
/
/
reftest
/
content
/
reftest
.
xul
"
"
_blank
"
"
chrome
dialog
=
no
all
"
{
}
)
;
}
;
}
function
shutdown
(
data
reason
)
{
if
(
Services
.
appinfo
.
OS
=
=
"
Android
"
)
{
Services
.
wm
.
removeListener
(
WindowListener
)
;
Cm
.
removedBootstrappedManifestLocation
(
data
.
installPath
)
;
OnRefTestUnload
(
)
;
Cu
.
unload
(
"
resource
:
/
/
reftest
/
reftest
.
jsm
"
)
;
}
}
function
install
(
data
reason
)
{
}
function
uninstall
(
data
reason
)
{
}
