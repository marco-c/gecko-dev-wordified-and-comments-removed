#
ifndef
MOZILLA_SVGCONTEXTPAINT_H_
#
define
MOZILLA_SVGCONTEXTPAINT_H_
#
include
"
DrawMode
.
h
"
#
include
"
gfxMatrix
.
h
"
#
include
"
gfxPattern
.
h
"
#
include
"
gfxTypes
.
h
"
#
include
"
mozilla
/
AlreadyAddRefed
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
gfx
/
2D
.
h
"
#
include
"
nsColor
.
h
"
#
include
"
nsStyleStruct
.
h
"
#
include
"
nsTArray
.
h
"
class
gfxContext
;
class
nsIDocument
;
class
nsSVGPaintServerFrame
;
namespace
mozilla
{
class
SVGContextPaint
:
public
RefCounted
<
SVGContextPaint
>
{
protected
:
typedef
mozilla
:
:
gfx
:
:
DrawTarget
DrawTarget
;
SVGContextPaint
(
)
{
}
public
:
MOZ_DECLARE_REFCOUNTED_TYPENAME
(
SVGContextPaint
)
virtual
~
SVGContextPaint
(
)
{
}
virtual
already_AddRefed
<
gfxPattern
>
GetFillPattern
(
const
DrawTarget
*
aDrawTarget
float
aOpacity
const
gfxMatrix
&
aCTM
)
=
0
;
virtual
already_AddRefed
<
gfxPattern
>
GetStrokePattern
(
const
DrawTarget
*
aDrawTarget
float
aOpacity
const
gfxMatrix
&
aCTM
)
=
0
;
virtual
float
GetFillOpacity
(
)
const
=
0
;
virtual
float
GetStrokeOpacity
(
)
const
=
0
;
already_AddRefed
<
gfxPattern
>
GetFillPattern
(
const
DrawTarget
*
aDrawTarget
const
gfxMatrix
&
aCTM
)
{
return
GetFillPattern
(
aDrawTarget
GetFillOpacity
(
)
aCTM
)
;
}
already_AddRefed
<
gfxPattern
>
GetStrokePattern
(
const
DrawTarget
*
aDrawTarget
const
gfxMatrix
&
aCTM
)
{
return
GetStrokePattern
(
aDrawTarget
GetStrokeOpacity
(
)
aCTM
)
;
}
static
SVGContextPaint
*
GetContextPaint
(
nsIContent
*
aContent
)
;
void
InitStrokeGeometry
(
gfxContext
*
aContext
float
devUnitsPerSVGUnit
)
;
FallibleTArray
<
gfxFloat
>
&
GetStrokeDashArray
(
)
{
return
mDashes
;
}
gfxFloat
GetStrokeDashOffset
(
)
{
return
mDashOffset
;
}
gfxFloat
GetStrokeWidth
(
)
{
return
mStrokeWidth
;
}
virtual
uint32_t
Hash
(
)
const
{
MOZ_ASSERT_UNREACHABLE
(
"
Only
VectorImage
needs
to
hash
and
that
should
"
"
only
be
operating
on
our
SVGEmbeddingContextPaint
"
"
subclass
"
)
;
return
0
;
}
private
:
FallibleTArray
<
gfxFloat
>
mDashes
;
MOZ_INIT_OUTSIDE_CTOR
gfxFloat
mDashOffset
;
MOZ_INIT_OUTSIDE_CTOR
gfxFloat
mStrokeWidth
;
}
;
class
MOZ_RAII
AutoSetRestoreSVGContextPaint
{
public
:
AutoSetRestoreSVGContextPaint
(
const
SVGContextPaint
*
aContextPaint
nsIDocument
*
aSVGDocument
)
;
~
AutoSetRestoreSVGContextPaint
(
)
;
private
:
nsIDocument
*
mSVGDocument
;
void
*
mOuterContextPaint
;
}
;
struct
SVGContextPaintImpl
:
public
SVGContextPaint
{
protected
:
typedef
mozilla
:
:
gfx
:
:
DrawTarget
DrawTarget
;
public
:
DrawMode
Init
(
const
DrawTarget
*
aDrawTarget
const
gfxMatrix
&
aContextMatrix
nsIFrame
*
aFrame
SVGContextPaint
*
aOuterContextPaint
)
;
already_AddRefed
<
gfxPattern
>
GetFillPattern
(
const
DrawTarget
*
aDrawTarget
float
aOpacity
const
gfxMatrix
&
aCTM
)
override
;
already_AddRefed
<
gfxPattern
>
GetStrokePattern
(
const
DrawTarget
*
aDrawTarget
float
aOpacity
const
gfxMatrix
&
aCTM
)
override
;
void
SetFillOpacity
(
float
aOpacity
)
{
mFillOpacity
=
aOpacity
;
}
float
GetFillOpacity
(
)
const
override
{
return
mFillOpacity
;
}
void
SetStrokeOpacity
(
float
aOpacity
)
{
mStrokeOpacity
=
aOpacity
;
}
float
GetStrokeOpacity
(
)
const
override
{
return
mStrokeOpacity
;
}
struct
Paint
{
Paint
(
)
:
mPaintType
(
eStyleSVGPaintType_None
)
{
}
void
SetPaintServer
(
nsIFrame
*
aFrame
const
gfxMatrix
&
aContextMatrix
nsSVGPaintServerFrame
*
aPaintServerFrame
)
{
mPaintType
=
eStyleSVGPaintType_Server
;
mPaintDefinition
.
mPaintServerFrame
=
aPaintServerFrame
;
mFrame
=
aFrame
;
mContextMatrix
=
aContextMatrix
;
}
void
SetColor
(
const
nscolor
&
aColor
)
{
mPaintType
=
eStyleSVGPaintType_Color
;
mPaintDefinition
.
mColor
=
aColor
;
}
void
SetContextPaint
(
SVGContextPaint
*
aContextPaint
nsStyleSVGPaintType
aPaintType
)
{
NS_ASSERTION
(
aPaintType
=
=
eStyleSVGPaintType_ContextFill
|
|
aPaintType
=
=
eStyleSVGPaintType_ContextStroke
"
Invalid
context
paint
type
"
)
;
mPaintType
=
aPaintType
;
mPaintDefinition
.
mContextPaint
=
aContextPaint
;
}
union
{
nsSVGPaintServerFrame
*
mPaintServerFrame
;
SVGContextPaint
*
mContextPaint
;
nscolor
mColor
;
}
mPaintDefinition
;
MOZ_INIT_OUTSIDE_CTOR
nsIFrame
*
mFrame
;
gfxMatrix
mContextMatrix
;
nsStyleSVGPaintType
mPaintType
;
gfxMatrix
mPatternMatrix
;
nsRefPtrHashtable
<
nsFloatHashKey
gfxPattern
>
mPatternCache
;
already_AddRefed
<
gfxPattern
>
GetPattern
(
const
DrawTarget
*
aDrawTarget
float
aOpacity
nsStyleSVGPaint
nsStyleSVG
:
:
*
aFillOrStroke
const
gfxMatrix
&
aCTM
)
;
}
;
Paint
mFillPaint
;
Paint
mStrokePaint
;
float
mFillOpacity
;
float
mStrokeOpacity
;
}
;
class
SVGEmbeddingContextPaint
:
public
SVGContextPaint
{
public
:
SVGEmbeddingContextPaint
(
)
{
}
void
SetFill
(
nscolor
aFill
)
;
void
SetStroke
(
nscolor
aStroke
)
;
already_AddRefed
<
gfxPattern
>
GetFillPattern
(
const
DrawTarget
*
aDrawTarget
float
aOpacity
const
gfxMatrix
&
aCTM
)
override
{
return
do_AddRef
(
mFill
)
;
}
already_AddRefed
<
gfxPattern
>
GetStrokePattern
(
const
DrawTarget
*
aDrawTarget
float
aOpacity
const
gfxMatrix
&
aCTM
)
override
{
return
do_AddRef
(
mStroke
)
;
}
float
GetFillOpacity
(
)
const
override
{
return
1
.
0f
;
}
;
float
GetStrokeOpacity
(
)
const
override
{
return
1
.
0f
;
}
;
uint32_t
Hash
(
)
const
override
;
private
:
RefPtr
<
gfxPattern
>
mFill
;
RefPtr
<
gfxPattern
>
mStroke
;
}
;
}
#
endif
