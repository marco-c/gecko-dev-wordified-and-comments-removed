#
ifndef
__NS_SVGFILTERINSTANCE_H__
#
define
__NS_SVGFILTERINSTANCE_H__
#
include
"
gfxMatrix
.
h
"
#
include
"
gfxRect
.
h
"
#
include
"
SVGAnimatedNumber
.
h
"
#
include
"
SVGAnimatedNumberPair
.
h
"
#
include
"
SVGFilters
.
h
"
#
include
"
mozilla
/
ServoStyleConsts
.
h
"
class
nsSVGFilterFrame
;
namespace
mozilla
{
namespace
dom
{
class
SVGFilterElement
;
}
}
class
nsSVGFilterInstance
{
using
StyleFilter
=
mozilla
:
:
StyleFilter
;
typedef
mozilla
:
:
SVGAnimatedNumber
SVGAnimatedNumber
;
typedef
mozilla
:
:
SVGAnimatedNumberPair
SVGAnimatedNumberPair
;
typedef
mozilla
:
:
gfx
:
:
Point3D
Point3D
;
typedef
mozilla
:
:
gfx
:
:
IntRect
IntRect
;
typedef
mozilla
:
:
gfx
:
:
SourceSurface
SourceSurface
;
typedef
mozilla
:
:
gfx
:
:
FilterPrimitiveDescription
FilterPrimitiveDescription
;
typedef
mozilla
:
:
dom
:
:
SVGFE
SVGFE
;
typedef
mozilla
:
:
dom
:
:
UserSpaceMetrics
UserSpaceMetrics
;
public
:
nsSVGFilterInstance
(
const
StyleFilter
&
aFilter
nsIFrame
*
aTargetFrame
nsIContent
*
aTargetContent
const
UserSpaceMetrics
&
aMetrics
const
gfxRect
&
aTargetBBox
const
gfxSize
&
aUserSpaceToFilterSpaceScale
)
;
bool
IsInitialized
(
)
const
{
return
mInitialized
;
}
nsresult
BuildPrimitives
(
nsTArray
<
FilterPrimitiveDescription
>
&
aPrimitiveDescrs
nsTArray
<
RefPtr
<
SourceSurface
>
>
&
aInputImages
bool
aInputIsTainted
)
;
float
GetPrimitiveNumber
(
uint8_t
aCtxType
const
SVGAnimatedNumber
*
aNumber
)
const
{
return
GetPrimitiveNumber
(
aCtxType
aNumber
-
>
GetAnimValue
(
)
)
;
}
float
GetPrimitiveNumber
(
uint8_t
aCtxType
const
SVGAnimatedNumberPair
*
aNumberPair
SVGAnimatedNumberPair
:
:
PairIndex
aIndex
)
const
{
return
GetPrimitiveNumber
(
aCtxType
aNumberPair
-
>
GetAnimValue
(
aIndex
)
)
;
}
Point3D
ConvertLocation
(
const
Point3D
&
aPoint
)
const
;
gfxRect
UserSpaceToFilterSpace
(
const
gfxRect
&
aUserSpaceRect
)
const
;
private
:
nsSVGFilterFrame
*
GetFilterFrame
(
nsIFrame
*
aTargetFrame
)
;
IntRect
ComputeFilterPrimitiveSubregion
(
SVGFE
*
aFilterElement
const
nsTArray
<
FilterPrimitiveDescription
>
&
aPrimitiveDescrs
const
nsTArray
<
int32_t
>
&
aInputIndices
)
;
void
GetInputsAreTainted
(
const
nsTArray
<
FilterPrimitiveDescription
>
&
aPrimitiveDescrs
const
nsTArray
<
int32_t
>
&
aInputIndices
bool
aFilterInputIsTainted
nsTArray
<
bool
>
&
aOutInputsAreTainted
)
;
float
GetPrimitiveNumber
(
uint8_t
aCtxType
float
aValue
)
const
;
gfxMatrix
GetUserSpaceToFrameSpaceInCSSPxTransform
(
)
const
;
int32_t
GetOrCreateSourceAlphaIndex
(
nsTArray
<
FilterPrimitiveDescription
>
&
aPrimitiveDescrs
)
;
nsresult
GetSourceIndices
(
SVGFE
*
aPrimitiveElement
nsTArray
<
FilterPrimitiveDescription
>
&
aPrimitiveDescrs
const
nsDataHashtable
<
nsStringHashKey
int32_t
>
&
aImageTable
nsTArray
<
int32_t
>
&
aSourceIndices
)
;
bool
ComputeBounds
(
)
;
const
StyleFilter
&
mFilter
;
nsIContent
*
mTargetContent
;
const
UserSpaceMetrics
&
mMetrics
;
const
mozilla
:
:
dom
:
:
SVGFilterElement
*
mFilterElement
;
nsSVGFilterFrame
*
mFilterFrame
;
gfxRect
mTargetBBox
;
nsIntRect
mFilterSpaceBounds
;
gfxSize
mUserSpaceToFilterSpaceScale
;
uint16_t
mPrimitiveUnits
;
MOZ_INIT_OUTSIDE_CTOR
int32_t
mSourceGraphicIndex
;
MOZ_INIT_OUTSIDE_CTOR
int32_t
mSourceAlphaIndex
;
int32_t
mSourceAlphaAvailable
;
bool
mInitialized
;
}
;
#
endif
