import
{
ReplaceError
Schema
Slice
Node
}
from
"
prosemirror
-
model
"
import
{
StepMap
Mappable
}
from
"
.
/
map
"
const
stepsByID
:
{
[
id
:
string
]
:
{
fromJSON
(
schema
:
Schema
json
:
any
)
:
Step
}
}
=
Object
.
create
(
null
)
export
abstract
class
Step
{
abstract
apply
(
doc
:
Node
)
:
StepResult
getMap
(
)
:
StepMap
{
return
StepMap
.
empty
}
abstract
invert
(
doc
:
Node
)
:
Step
abstract
map
(
mapping
:
Mappable
)
:
Step
|
null
merge
(
other
:
Step
)
:
Step
|
null
{
return
null
}
abstract
toJSON
(
)
:
any
static
fromJSON
(
schema
:
Schema
json
:
any
)
:
Step
{
if
(
!
json
|
|
!
json
.
stepType
)
throw
new
RangeError
(
"
Invalid
input
for
Step
.
fromJSON
"
)
let
type
=
stepsByID
[
json
.
stepType
]
if
(
!
type
)
throw
new
RangeError
(
No
step
type
{
json
.
stepType
}
defined
)
return
type
.
fromJSON
(
schema
json
)
}
static
jsonID
(
id
:
string
stepClass
:
{
fromJSON
(
schema
:
Schema
json
:
any
)
:
Step
}
)
{
if
(
id
in
stepsByID
)
throw
new
RangeError
(
"
Duplicate
use
of
step
JSON
ID
"
+
id
)
stepsByID
[
id
]
=
stepClass
;
(
stepClass
as
any
)
.
prototype
.
jsonID
=
id
return
stepClass
}
}
export
class
StepResult
{
constructor
(
readonly
doc
:
Node
|
null
readonly
failed
:
string
|
null
)
{
}
static
ok
(
doc
:
Node
)
{
return
new
StepResult
(
doc
null
)
}
static
fail
(
message
:
string
)
{
return
new
StepResult
(
null
message
)
}
static
fromReplace
(
doc
:
Node
from
:
number
to
:
number
slice
:
Slice
)
{
try
{
return
StepResult
.
ok
(
doc
.
replace
(
from
to
slice
)
)
}
catch
(
e
)
{
if
(
e
instanceof
ReplaceError
)
return
StepResult
.
fail
(
e
.
message
)
throw
e
}
}
}
