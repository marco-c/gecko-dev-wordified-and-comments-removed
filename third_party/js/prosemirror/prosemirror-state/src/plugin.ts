import
{
type
EditorView
type
EditorProps
}
from
"
prosemirror
-
view
"
import
{
EditorState
EditorStateConfig
}
from
"
.
/
state
"
import
{
Transaction
}
from
"
.
/
transaction
"
export
interface
PluginSpec
<
PluginState
>
{
props
?
:
EditorProps
<
Plugin
<
PluginState
>
>
state
?
:
StateField
<
PluginState
>
key
?
:
PluginKey
view
?
:
(
view
:
EditorView
)
=
>
PluginView
filterTransaction
?
:
(
tr
:
Transaction
state
:
EditorState
)
=
>
boolean
appendTransaction
?
:
(
transactions
:
readonly
Transaction
[
]
oldState
:
EditorState
newState
:
EditorState
)
=
>
Transaction
|
null
|
undefined
[
key
:
string
]
:
any
}
export
type
PluginView
=
{
update
?
:
(
view
:
EditorView
prevState
:
EditorState
)
=
>
void
destroy
?
:
(
)
=
>
void
}
function
bindProps
(
obj
:
{
[
prop
:
string
]
:
any
}
self
:
any
target
:
{
[
prop
:
string
]
:
any
}
)
{
for
(
let
prop
in
obj
)
{
let
val
=
obj
[
prop
]
if
(
val
instanceof
Function
)
val
=
val
.
bind
(
self
)
else
if
(
prop
=
=
"
handleDOMEvents
"
)
val
=
bindProps
(
val
self
{
}
)
target
[
prop
]
=
val
}
return
target
}
export
class
Plugin
<
PluginState
=
any
>
{
constructor
(
readonly
spec
:
PluginSpec
<
PluginState
>
)
{
if
(
spec
.
props
)
bindProps
(
spec
.
props
this
this
.
props
)
this
.
key
=
spec
.
key
?
spec
.
key
.
key
:
createKey
(
"
plugin
"
)
}
readonly
props
:
EditorProps
<
Plugin
<
PluginState
>
>
=
{
}
key
:
string
getState
(
state
:
EditorState
)
:
PluginState
|
undefined
{
return
(
state
as
any
)
[
this
.
key
]
}
}
export
interface
StateField
<
T
>
{
init
:
(
config
:
EditorStateConfig
instance
:
EditorState
)
=
>
T
apply
:
(
tr
:
Transaction
value
:
T
oldState
:
EditorState
newState
:
EditorState
)
=
>
T
toJSON
?
:
(
value
:
T
)
=
>
any
fromJSON
?
:
(
config
:
EditorStateConfig
value
:
any
state
:
EditorState
)
=
>
T
}
const
keys
=
Object
.
create
(
null
)
function
createKey
(
name
:
string
)
{
if
(
name
in
keys
)
return
name
+
"
"
+
+
+
keys
[
name
]
keys
[
name
]
=
0
return
name
+
"
"
}
export
class
PluginKey
<
PluginState
=
any
>
{
key
:
string
constructor
(
name
=
"
key
"
)
{
this
.
key
=
createKey
(
name
)
}
get
(
state
:
EditorState
)
:
Plugin
<
PluginState
>
|
undefined
{
return
state
.
config
.
pluginsByKey
[
this
.
key
]
}
getState
(
state
:
EditorState
)
:
PluginState
|
undefined
{
return
(
state
as
any
)
[
this
.
key
]
}
}
