#
pragma
once
#
include
<
cstddef
>
#
include
<
cstring
>
#
include
<
string
>
#
include
"
opentelemetry
/
nostd
/
string_view
.
h
"
#
include
"
opentelemetry
/
version
.
h
"
OPENTELEMETRY_BEGIN_NAMESPACE
namespace
sdk
{
namespace
common
{
template
<
typename
Ty
size_t
Size
>
struct
FnvPrime
;
template
<
typename
Ty
>
struct
FnvPrime
<
Ty
4
>
{
static
constexpr
Ty
value
=
static_cast
<
Ty
>
(
0x01000193U
)
;
}
;
template
<
typename
Ty
>
struct
FnvPrime
<
Ty
8
>
{
static
constexpr
Ty
value
=
static_cast
<
Ty
>
(
0x100000001b3ULL
)
;
}
;
template
<
typename
Ty
size_t
Size
>
struct
FnvOffset
;
template
<
typename
Ty
>
struct
FnvOffset
<
Ty
4
>
{
static
constexpr
Ty
value
=
static_cast
<
Ty
>
(
0x811C9DC5U
)
;
static
constexpr
Ty
Fix
(
Ty
hval
)
noexcept
{
return
hval
;
}
}
;
template
<
typename
Ty
>
struct
FnvOffset
<
Ty
8
>
{
static
constexpr
Ty
value
=
static_cast
<
Ty
>
(
0xCBF29CE484222325ULL
)
;
static
constexpr
Ty
Fix
(
Ty
hval
)
noexcept
{
return
hval
^
(
hval
>
>
32
)
;
}
}
;
template
<
typename
Ty
>
inline
Ty
Fnv1a
(
const
void
*
buf
size_t
len
Ty
hval
=
FnvOffset
<
Ty
sizeof
(
Ty
)
>
:
:
value
)
noexcept
{
const
unsigned
char
*
bp
=
reinterpret_cast
<
const
unsigned
char
*
>
(
buf
)
;
const
unsigned
char
*
be
=
bp
+
len
;
Ty
prime
=
FnvPrime
<
Ty
sizeof
(
Ty
)
>
:
:
value
;
while
(
bp
<
be
)
{
hval
^
=
static_cast
<
Ty
>
(
*
bp
+
+
)
;
hval
*
=
prime
;
}
return
FnvOffset
<
Ty
sizeof
(
Ty
)
>
:
:
Fix
(
hval
)
;
}
struct
StringViewHash
{
#
if
defined
(
OPENTELEMETRY_STL_VERSION
)
#
if
OPENTELEMETRY_STL_VERSION
>
=
2020
using
is_transparent
=
void
;
#
endif
#
endif
std
:
:
size_t
operator
(
)
(
const
std
:
:
string
&
s
)
const
noexcept
{
return
Fnv1a
<
std
:
:
size_t
>
(
s
.
data
(
)
s
.
size
(
)
)
;
}
std
:
:
size_t
operator
(
)
(
opentelemetry
:
:
nostd
:
:
string_view
sv
)
const
noexcept
{
return
Fnv1a
<
std
:
:
size_t
>
(
sv
.
data
(
)
sv
.
size
(
)
)
;
}
}
;
struct
StringViewEqual
{
#
if
defined
(
OPENTELEMETRY_STL_VERSION
)
#
if
OPENTELEMETRY_STL_VERSION
>
=
2020
using
is_transparent
=
void
;
#
endif
#
endif
template
<
typename
Lhs
typename
Rhs
>
bool
operator
(
)
(
const
Lhs
&
lhs
const
Rhs
&
rhs
)
const
noexcept
{
opentelemetry
:
:
nostd
:
:
string_view
lsv
(
lhs
)
;
opentelemetry
:
:
nostd
:
:
string_view
rsv
(
rhs
)
;
return
lsv
.
size
(
)
=
=
rsv
.
size
(
)
&
&
std
:
:
memcmp
(
lsv
.
data
(
)
rsv
.
data
(
)
lsv
.
size
(
)
)
=
=
0
;
}
}
;
template
<
typename
MapType
>
inline
auto
find_heterogeneous
(
MapType
&
&
map
opentelemetry
:
:
nostd
:
:
string_view
key
)
{
#
if
defined
(
_LIBCPP_VERSION
)
|
|
\
(
!
defined
(
OPENTELEMETRY_STL_VERSION
)
|
|
OPENTELEMETRY_STL_VERSION
<
2020
)
return
map
.
find
(
std
:
:
string
(
key
)
)
;
#
else
return
map
.
find
(
key
)
;
#
endif
}
}
}
OPENTELEMETRY_END_NAMESPACE
