#
include
<
mprio
.
h
>
#
include
<
stdio
.
h
>
#
include
<
stdlib
.
h
>
#
include
"
prio
/
util
.
h
"
int
verify_full
(
void
)
{
SECStatus
rv
=
SECSuccess
;
PublicKey
pkA
=
NULL
;
PublicKey
pkB
=
NULL
;
PrivateKey
skA
=
NULL
;
PrivateKey
skB
=
NULL
;
PrioConfig
cfg
=
NULL
;
PrioServer
sA
=
NULL
;
PrioServer
sB
=
NULL
;
PrioVerifier
vA
=
NULL
;
PrioVerifier
vB
=
NULL
;
PrioPacketVerify1
p1A
=
NULL
;
PrioPacketVerify1
p1B
=
NULL
;
PrioPacketVerify2
p2A
=
NULL
;
PrioPacketVerify2
p2B
=
NULL
;
PrioTotalShare
tA
=
NULL
;
PrioTotalShare
tB
=
NULL
;
unsigned
char
*
for_server_a
=
NULL
;
unsigned
char
*
for_server_b
=
NULL
;
const
unsigned
char
*
batch_id
=
(
unsigned
char
*
)
"
prio_batch_2018
-
04
-
17
"
;
const
unsigned
int
batch_id_len
=
strlen
(
(
char
*
)
batch_id
)
;
P_CHECKC
(
Prio_init
(
)
)
;
const
int
ndata
=
100
;
const
int
nclients
=
10
;
{
bool
data_items
[
ndata
]
;
P_CHECKC
(
Keypair_new
(
&
skA
&
pkA
)
)
;
P_CHECKC
(
Keypair_new
(
&
skB
&
pkB
)
)
;
P_CHECKA
(
cfg
=
PrioConfig_new
(
ndata
pkA
pkB
batch_id
batch_id_len
)
)
;
PrioPRGSeed
server_secret
;
P_CHECKC
(
PrioPRGSeed_randomize
(
&
server_secret
)
)
;
P_CHECKA
(
sA
=
PrioServer_new
(
cfg
PRIO_SERVER_A
skA
server_secret
)
)
;
P_CHECKA
(
sB
=
PrioServer_new
(
cfg
PRIO_SERVER_B
skB
server_secret
)
)
;
P_CHECKA
(
vA
=
PrioVerifier_new
(
sA
)
)
;
P_CHECKA
(
vB
=
PrioVerifier_new
(
sB
)
)
;
P_CHECKA
(
tA
=
PrioTotalShare_new
(
)
)
;
P_CHECKA
(
tB
=
PrioTotalShare_new
(
)
)
;
P_CHECKA
(
p1A
=
PrioPacketVerify1_new
(
)
)
;
P_CHECKA
(
p1B
=
PrioPacketVerify1_new
(
)
)
;
P_CHECKA
(
p2A
=
PrioPacketVerify2_new
(
)
)
;
P_CHECKA
(
p2B
=
PrioPacketVerify2_new
(
)
)
;
for
(
int
c
=
0
;
c
<
nclients
;
c
+
+
)
{
for
(
int
i
=
0
;
i
<
ndata
;
i
+
+
)
{
data_items
[
i
]
=
(
i
%
3
=
=
1
)
|
|
(
c
%
5
=
=
3
)
;
}
unsigned
int
aLen
bLen
;
P_CHECKC
(
PrioClient_encode
(
cfg
data_items
&
for_server_a
&
aLen
&
for_server_b
&
bLen
)
)
;
P_CHECKC
(
PrioVerifier_set_data
(
vA
for_server_a
aLen
)
)
;
P_CHECKC
(
PrioVerifier_set_data
(
vB
for_server_b
bLen
)
)
;
P_CHECKC
(
PrioPacketVerify1_set_data
(
p1A
vA
)
)
;
P_CHECKC
(
PrioPacketVerify1_set_data
(
p1B
vB
)
)
;
P_CHECKC
(
PrioPacketVerify2_set_data
(
p2A
vA
p1A
p1B
)
)
;
P_CHECKC
(
PrioPacketVerify2_set_data
(
p2B
vB
p1A
p1B
)
)
;
P_CHECKC
(
PrioVerifier_isValid
(
vA
p2A
p2B
)
)
;
P_CHECKC
(
PrioVerifier_isValid
(
vB
p2A
p2B
)
)
;
P_CHECKC
(
PrioServer_aggregate
(
sA
vA
)
)
;
P_CHECKC
(
PrioServer_aggregate
(
sB
vB
)
)
;
free
(
for_server_a
)
;
free
(
for_server_b
)
;
for_server_a
=
NULL
;
for_server_b
=
NULL
;
}
P_CHECKC
(
PrioTotalShare_set_data
(
tA
sA
)
)
;
P_CHECKC
(
PrioTotalShare_set_data
(
tB
sB
)
)
;
unsigned
long
output
[
ndata
]
;
P_CHECKC
(
PrioTotalShare_final
(
cfg
output
tA
tB
)
)
;
for
(
int
i
=
0
;
i
<
ndata
;
i
+
+
)
printf
(
"
output
[
%
d
]
=
%
lu
\
n
"
i
output
[
i
]
)
;
}
cleanup
:
if
(
rv
!
=
SECSuccess
)
{
fprintf
(
stderr
"
Warning
:
unexpected
failure
.
\
n
"
)
;
}
if
(
for_server_a
)
free
(
for_server_a
)
;
if
(
for_server_b
)
free
(
for_server_b
)
;
PrioTotalShare_clear
(
tA
)
;
PrioTotalShare_clear
(
tB
)
;
PrioPacketVerify2_clear
(
p2A
)
;
PrioPacketVerify2_clear
(
p2B
)
;
PrioPacketVerify1_clear
(
p1A
)
;
PrioPacketVerify1_clear
(
p1B
)
;
PrioVerifier_clear
(
vA
)
;
PrioVerifier_clear
(
vB
)
;
PrioServer_clear
(
sA
)
;
PrioServer_clear
(
sB
)
;
PrioConfig_clear
(
cfg
)
;
PublicKey_clear
(
pkA
)
;
PublicKey_clear
(
pkB
)
;
PrivateKey_clear
(
skA
)
;
PrivateKey_clear
(
skB
)
;
Prio_clear
(
)
;
return
!
(
rv
=
=
SECSuccess
)
;
}
int
main
(
void
)
{
puts
(
"
This
utility
demonstrates
how
to
invoke
the
Prio
API
.
"
)
;
return
verify_full
(
)
;
}
