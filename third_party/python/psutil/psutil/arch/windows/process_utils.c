#
include
<
Python
.
h
>
#
include
<
windows
.
h
>
#
include
<
Psapi
.
h
>
#
include
"
.
.
/
.
.
/
_psutil_common
.
h
"
#
include
"
process_utils
.
h
"
DWORD
*
psutil_get_pids
(
DWORD
*
numberOfReturnedPIDs
)
{
DWORD
*
procArray
=
NULL
;
DWORD
procArrayByteSz
;
int
procArraySz
=
0
;
DWORD
enumReturnSz
=
0
;
do
{
procArraySz
+
=
1024
;
if
(
procArray
!
=
NULL
)
free
(
procArray
)
;
procArrayByteSz
=
procArraySz
*
sizeof
(
DWORD
)
;
procArray
=
malloc
(
procArrayByteSz
)
;
if
(
procArray
=
=
NULL
)
{
PyErr_NoMemory
(
)
;
return
NULL
;
}
if
(
!
EnumProcesses
(
procArray
procArrayByteSz
&
enumReturnSz
)
)
{
free
(
procArray
)
;
PyErr_SetFromWindowsErr
(
0
)
;
return
NULL
;
}
}
while
(
enumReturnSz
=
=
procArraySz
*
sizeof
(
DWORD
)
)
;
*
numberOfReturnedPIDs
=
enumReturnSz
/
sizeof
(
DWORD
)
;
return
procArray
;
}
int
psutil_pid_in_pids
(
DWORD
pid
)
{
DWORD
*
proclist
=
NULL
;
DWORD
numberOfReturnedPIDs
;
DWORD
i
;
proclist
=
psutil_get_pids
(
&
numberOfReturnedPIDs
)
;
if
(
proclist
=
=
NULL
)
return
-
1
;
for
(
i
=
0
;
i
<
numberOfReturnedPIDs
;
i
+
+
)
{
if
(
proclist
[
i
]
=
=
pid
)
{
free
(
proclist
)
;
return
1
;
}
}
free
(
proclist
)
;
return
0
;
}
HANDLE
psutil_check_phandle
(
HANDLE
hProcess
DWORD
pid
)
{
DWORD
exitCode
;
if
(
hProcess
=
=
NULL
)
{
if
(
GetLastError
(
)
=
=
ERROR_INVALID_PARAMETER
)
{
NoSuchProcess
(
"
OpenProcess
"
)
;
return
NULL
;
}
PyErr_SetFromOSErrnoWithSyscall
(
"
OpenProcess
"
)
;
return
NULL
;
}
if
(
GetExitCodeProcess
(
hProcess
&
exitCode
)
)
{
if
(
exitCode
=
=
STILL_ACTIVE
)
{
return
hProcess
;
}
if
(
psutil_pid_in_pids
(
pid
)
=
=
1
)
{
return
hProcess
;
}
CloseHandle
(
hProcess
)
;
NoSuchProcess
(
"
GetExitCodeProcess
!
=
STILL_ACTIVE
"
)
;
return
NULL
;
}
if
(
GetLastError
(
)
=
=
ERROR_ACCESS_DENIED
)
{
psutil_debug
(
"
GetExitCodeProcess
-
>
ERROR_ACCESS_DENIED
(
ignored
)
"
)
;
SetLastError
(
0
)
;
return
hProcess
;
}
PyErr_SetFromOSErrnoWithSyscall
(
"
GetExitCodeProcess
"
)
;
CloseHandle
(
hProcess
)
;
return
NULL
;
}
HANDLE
psutil_handle_from_pid
(
DWORD
pid
DWORD
access
)
{
HANDLE
hProcess
;
if
(
pid
=
=
0
)
{
return
AccessDenied
(
"
automatically
set
for
PID
0
"
)
;
}
hProcess
=
OpenProcess
(
access
FALSE
pid
)
;
if
(
(
hProcess
=
=
NULL
)
&
&
(
GetLastError
(
)
=
=
ERROR_ACCESS_DENIED
)
)
{
PyErr_SetFromOSErrnoWithSyscall
(
"
OpenProcess
"
)
;
return
NULL
;
}
hProcess
=
psutil_check_phandle
(
hProcess
pid
)
;
return
hProcess
;
}
int
psutil_pid_is_running
(
DWORD
pid
)
{
HANDLE
hProcess
;
if
(
pid
=
=
0
)
return
1
;
if
(
pid
<
0
)
return
0
;
hProcess
=
OpenProcess
(
PROCESS_QUERY_LIMITED_INFORMATION
FALSE
pid
)
;
if
(
(
hProcess
=
=
NULL
)
&
&
(
GetLastError
(
)
=
=
ERROR_ACCESS_DENIED
)
)
return
1
;
hProcess
=
psutil_check_phandle
(
hProcess
pid
)
;
if
(
hProcess
!
=
NULL
)
{
CloseHandle
(
hProcess
)
;
return
1
;
}
CloseHandle
(
hProcess
)
;
PyErr_Clear
(
)
;
return
psutil_pid_in_pids
(
pid
)
;
}
