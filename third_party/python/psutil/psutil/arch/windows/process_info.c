#
include
<
Python
.
h
>
#
include
<
windows
.
h
>
#
include
"
.
.
/
.
.
/
_psutil_common
.
h
"
#
include
"
process_info
.
h
"
#
include
"
process_utils
.
h
"
#
ifndef
_WIN64
typedef
NTSTATUS
(
NTAPI
*
__NtQueryInformationProcess
)
(
HANDLE
ProcessHandle
DWORD
ProcessInformationClass
PVOID
ProcessInformation
DWORD
ProcessInformationLength
PDWORD
ReturnLength
)
;
#
endif
static
int
psutil_get_process_region_size
(
HANDLE
hProcess
LPCVOID
src
SIZE_T
*
psize
)
{
MEMORY_BASIC_INFORMATION
info
;
if
(
!
VirtualQueryEx
(
hProcess
src
&
info
sizeof
(
info
)
)
)
{
PyErr_SetFromOSErrnoWithSyscall
(
"
VirtualQueryEx
"
)
;
return
-
1
;
}
*
psize
=
info
.
RegionSize
-
(
(
char
*
)
src
-
(
char
*
)
info
.
BaseAddress
)
;
return
0
;
}
enum
psutil_process_data_kind
{
KIND_CMDLINE
KIND_CWD
KIND_ENVIRON
}
;
static
int
psutil_get_process_data
(
DWORD
pid
enum
psutil_process_data_kind
kind
WCHAR
*
*
pdata
SIZE_T
*
psize
)
{
SIZE_T
size
=
0
;
#
ifndef
_WIN64
static
__NtQueryInformationProcess
NtWow64QueryInformationProcess64
=
NULL
;
static
_NtWow64ReadVirtualMemory64
NtWow64ReadVirtualMemory64
=
NULL
;
#
endif
HANDLE
hProcess
=
NULL
;
LPCVOID
src
;
WCHAR
*
buffer
=
NULL
;
#
ifdef
_WIN64
LPVOID
ppeb32
=
NULL
;
#
else
PVOID64
src64
;
BOOL
weAreWow64
;
BOOL
theyAreWow64
;
#
endif
DWORD
access
=
PROCESS_QUERY_INFORMATION
|
PROCESS_VM_READ
;
NTSTATUS
status
;
hProcess
=
psutil_handle_from_pid
(
pid
access
)
;
if
(
hProcess
=
=
NULL
)
return
-
1
;
#
ifdef
_WIN64
status
=
NtQueryInformationProcess
(
hProcess
ProcessWow64Information
&
ppeb32
sizeof
(
LPVOID
)
NULL
)
;
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtQueryInformationProcess
(
ProcessWow64Information
)
"
)
;
goto
error
;
}
if
(
ppeb32
!
=
NULL
)
{
PEB32
peb32
;
RTL_USER_PROCESS_PARAMETERS32
procParameters32
;
if
(
!
ReadProcessMemory
(
hProcess
ppeb32
&
peb32
sizeof
(
peb32
)
NULL
)
)
{
PyErr_SetFromWindowsErr
(
0
)
;
goto
error
;
}
if
(
!
ReadProcessMemory
(
hProcess
UlongToPtr
(
peb32
.
ProcessParameters
)
&
procParameters32
sizeof
(
procParameters32
)
NULL
)
)
{
PyErr_SetFromWindowsErr
(
0
)
;
goto
error
;
}
switch
(
kind
)
{
case
KIND_CMDLINE
:
src
=
UlongToPtr
(
procParameters32
.
CommandLine
.
Buffer
)
size
=
procParameters32
.
CommandLine
.
Length
;
break
;
case
KIND_CWD
:
src
=
UlongToPtr
(
procParameters32
.
CurrentDirectoryPath
.
Buffer
)
;
size
=
procParameters32
.
CurrentDirectoryPath
.
Length
;
break
;
case
KIND_ENVIRON
:
src
=
UlongToPtr
(
procParameters32
.
env
)
;
break
;
}
}
else
#
else
if
(
!
IsWow64Process
(
GetCurrentProcess
(
)
&
weAreWow64
)
|
|
!
IsWow64Process
(
hProcess
&
theyAreWow64
)
)
{
PyErr_SetFromOSErrnoWithSyscall
(
"
IsWow64Process
"
)
;
goto
error
;
}
if
(
weAreWow64
&
&
!
theyAreWow64
)
{
PROCESS_BASIC_INFORMATION64
pbi64
;
PEB64
peb64
;
RTL_USER_PROCESS_PARAMETERS64
procParameters64
;
if
(
NtWow64QueryInformationProcess64
=
=
NULL
)
{
NtWow64QueryInformationProcess64
=
\
psutil_GetProcAddressFromLib
(
"
ntdll
.
dll
"
"
NtWow64QueryInformationProcess64
"
)
;
if
(
NtWow64QueryInformationProcess64
=
=
NULL
)
{
PyErr_Clear
(
)
;
AccessDenied
(
"
can
'
t
query
64
-
bit
process
in
32
-
bit
-
WoW
mode
"
)
;
goto
error
;
}
}
if
(
NtWow64ReadVirtualMemory64
=
=
NULL
)
{
NtWow64ReadVirtualMemory64
=
\
psutil_GetProcAddressFromLib
(
"
ntdll
.
dll
"
"
NtWow64ReadVirtualMemory64
"
)
;
if
(
NtWow64ReadVirtualMemory64
=
=
NULL
)
{
PyErr_Clear
(
)
;
AccessDenied
(
"
can
'
t
query
64
-
bit
process
in
32
-
bit
-
WoW
mode
"
)
;
goto
error
;
}
}
status
=
NtWow64QueryInformationProcess64
(
hProcess
ProcessBasicInformation
&
pbi64
sizeof
(
pbi64
)
NULL
)
;
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtWow64QueryInformationProcess64
(
ProcessBasicInformation
)
"
)
;
goto
error
;
}
status
=
NtWow64ReadVirtualMemory64
(
hProcess
pbi64
.
PebBaseAddress
&
peb64
sizeof
(
peb64
)
NULL
)
;
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtWow64ReadVirtualMemory64
"
)
;
goto
error
;
}
status
=
NtWow64ReadVirtualMemory64
(
hProcess
peb64
.
ProcessParameters
&
procParameters64
sizeof
(
procParameters64
)
NULL
)
;
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtWow64ReadVirtualMemory64
(
ProcessParameters
)
"
)
;
goto
error
;
}
switch
(
kind
)
{
case
KIND_CMDLINE
:
src64
=
procParameters64
.
CommandLine
.
Buffer
;
size
=
procParameters64
.
CommandLine
.
Length
;
break
;
case
KIND_CWD
:
src64
=
procParameters64
.
CurrentDirectoryPath
.
Buffer
size
=
procParameters64
.
CurrentDirectoryPath
.
Length
;
break
;
case
KIND_ENVIRON
:
src64
=
procParameters64
.
env
;
break
;
}
}
else
#
endif
{
PROCESS_BASIC_INFORMATION
pbi
;
PEB_
peb
;
RTL_USER_PROCESS_PARAMETERS_
procParameters
;
status
=
NtQueryInformationProcess
(
hProcess
ProcessBasicInformation
&
pbi
sizeof
(
pbi
)
NULL
)
;
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtQueryInformationProcess
(
ProcessBasicInformation
)
"
)
;
goto
error
;
}
if
(
!
ReadProcessMemory
(
hProcess
pbi
.
PebBaseAddress
&
peb
sizeof
(
peb
)
NULL
)
)
{
PyErr_SetFromWindowsErr
(
0
)
;
goto
error
;
}
if
(
!
ReadProcessMemory
(
hProcess
peb
.
ProcessParameters
&
procParameters
sizeof
(
procParameters
)
NULL
)
)
{
PyErr_SetFromWindowsErr
(
0
)
;
goto
error
;
}
switch
(
kind
)
{
case
KIND_CMDLINE
:
src
=
procParameters
.
CommandLine
.
Buffer
;
size
=
procParameters
.
CommandLine
.
Length
;
break
;
case
KIND_CWD
:
src
=
procParameters
.
CurrentDirectoryPath
.
Buffer
;
size
=
procParameters
.
CurrentDirectoryPath
.
Length
;
break
;
case
KIND_ENVIRON
:
src
=
procParameters
.
env
;
break
;
}
}
if
(
kind
=
=
KIND_ENVIRON
)
{
#
ifndef
_WIN64
if
(
weAreWow64
&
&
!
theyAreWow64
)
{
AccessDenied
(
"
can
'
t
query
64
-
bit
process
in
32
-
bit
-
WoW
mode
"
)
;
goto
error
;
}
else
#
endif
if
(
psutil_get_process_region_size
(
hProcess
src
&
size
)
!
=
0
)
goto
error
;
}
buffer
=
calloc
(
size
+
2
1
)
;
if
(
buffer
=
=
NULL
)
{
PyErr_NoMemory
(
)
;
goto
error
;
}
#
ifndef
_WIN64
if
(
weAreWow64
&
&
!
theyAreWow64
)
{
status
=
NtWow64ReadVirtualMemory64
(
hProcess
src64
buffer
size
NULL
)
;
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtWow64ReadVirtualMemory64
"
)
;
goto
error
;
}
}
else
#
endif
if
(
!
ReadProcessMemory
(
hProcess
src
buffer
size
NULL
)
)
{
PyErr_SetFromWindowsErr
(
0
)
;
goto
error
;
}
CloseHandle
(
hProcess
)
;
*
pdata
=
buffer
;
*
psize
=
size
;
return
0
;
error
:
if
(
hProcess
!
=
NULL
)
CloseHandle
(
hProcess
)
;
if
(
buffer
!
=
NULL
)
free
(
buffer
)
;
return
-
1
;
}
static
int
psutil_cmdline_query_proc
(
DWORD
pid
WCHAR
*
*
pdata
SIZE_T
*
psize
)
{
HANDLE
hProcess
=
NULL
;
ULONG
bufLen
=
0
;
NTSTATUS
status
;
char
*
buffer
=
NULL
;
WCHAR
*
bufWchar
=
NULL
;
PUNICODE_STRING
tmp
=
NULL
;
size_t
size
;
int
ProcessCommandLineInformation
=
60
;
if
(
PSUTIL_WINVER
<
PSUTIL_WINDOWS_8_1
)
{
PyErr_SetString
(
PyExc_RuntimeError
"
requires
Windows
8
.
1
+
"
)
;
goto
error
;
}
hProcess
=
psutil_handle_from_pid
(
pid
PROCESS_QUERY_LIMITED_INFORMATION
)
;
if
(
hProcess
=
=
NULL
)
goto
error
;
status
=
NtQueryInformationProcess
(
hProcess
ProcessCommandLineInformation
NULL
0
&
bufLen
)
;
if
(
status
=
=
STATUS_NOT_FOUND
)
{
AccessDenied
(
"
NtQueryInformationProcess
(
ProcessBasicInformation
)
-
>
"
"
STATUS_NOT_FOUND
translated
into
PermissionError
"
)
;
goto
error
;
}
if
(
status
!
=
STATUS_BUFFER_OVERFLOW
&
&
\
status
!
=
STATUS_BUFFER_TOO_SMALL
&
&
\
status
!
=
STATUS_INFO_LENGTH_MISMATCH
)
{
psutil_SetFromNTStatusErr
(
status
"
NtQueryInformationProcess
(
ProcessBasicInformation
)
"
)
;
goto
error
;
}
buffer
=
calloc
(
bufLen
1
)
;
if
(
buffer
=
=
NULL
)
{
PyErr_NoMemory
(
)
;
goto
error
;
}
status
=
NtQueryInformationProcess
(
hProcess
ProcessCommandLineInformation
buffer
bufLen
&
bufLen
)
;
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtQueryInformationProcess
(
ProcessCommandLineInformation
)
"
)
;
goto
error
;
}
tmp
=
(
PUNICODE_STRING
)
buffer
;
size
=
wcslen
(
tmp
-
>
Buffer
)
+
1
;
bufWchar
=
(
WCHAR
*
)
calloc
(
size
sizeof
(
WCHAR
)
)
;
if
(
bufWchar
=
=
NULL
)
{
PyErr_NoMemory
(
)
;
goto
error
;
}
wcscpy_s
(
bufWchar
size
tmp
-
>
Buffer
)
;
*
pdata
=
bufWchar
;
*
psize
=
size
*
sizeof
(
WCHAR
)
;
free
(
buffer
)
;
CloseHandle
(
hProcess
)
;
return
0
;
error
:
if
(
buffer
!
=
NULL
)
free
(
buffer
)
;
if
(
hProcess
!
=
NULL
)
CloseHandle
(
hProcess
)
;
return
-
1
;
}
PyObject
*
psutil_get_cmdline
(
DWORD
pid
int
use_peb
)
{
PyObject
*
ret
=
NULL
;
WCHAR
*
data
=
NULL
;
SIZE_T
size
;
PyObject
*
py_retlist
=
NULL
;
PyObject
*
py_unicode
=
NULL
;
LPWSTR
*
szArglist
=
NULL
;
int
nArgs
i
;
int
func_ret
;
if
(
use_peb
=
=
1
)
func_ret
=
psutil_get_process_data
(
pid
KIND_CMDLINE
&
data
&
size
)
;
else
func_ret
=
psutil_cmdline_query_proc
(
pid
&
data
&
size
)
;
if
(
func_ret
!
=
0
)
goto
out
;
szArglist
=
CommandLineToArgvW
(
data
&
nArgs
)
;
if
(
szArglist
=
=
NULL
)
{
PyErr_SetFromOSErrnoWithSyscall
(
"
CommandLineToArgvW
"
)
;
goto
out
;
}
py_retlist
=
PyList_New
(
nArgs
)
;
if
(
py_retlist
=
=
NULL
)
goto
out
;
for
(
i
=
0
;
i
<
nArgs
;
i
+
+
)
{
py_unicode
=
PyUnicode_FromWideChar
(
szArglist
[
i
]
wcslen
(
szArglist
[
i
]
)
)
;
if
(
py_unicode
=
=
NULL
)
goto
out
;
PyList_SET_ITEM
(
py_retlist
i
py_unicode
)
;
py_unicode
=
NULL
;
}
ret
=
py_retlist
;
py_retlist
=
NULL
;
out
:
if
(
szArglist
!
=
NULL
)
LocalFree
(
szArglist
)
;
if
(
data
!
=
NULL
)
free
(
data
)
;
Py_XDECREF
(
py_unicode
)
;
Py_XDECREF
(
py_retlist
)
;
return
ret
;
}
PyObject
*
psutil_get_cwd
(
DWORD
pid
)
{
PyObject
*
ret
=
NULL
;
WCHAR
*
data
=
NULL
;
SIZE_T
size
;
if
(
psutil_get_process_data
(
pid
KIND_CWD
&
data
&
size
)
!
=
0
)
goto
out
;
ret
=
PyUnicode_FromWideChar
(
data
wcslen
(
data
)
)
;
out
:
if
(
data
!
=
NULL
)
free
(
data
)
;
return
ret
;
}
PyObject
*
psutil_get_environ
(
DWORD
pid
)
{
PyObject
*
ret
=
NULL
;
WCHAR
*
data
=
NULL
;
SIZE_T
size
;
if
(
psutil_get_process_data
(
pid
KIND_ENVIRON
&
data
&
size
)
!
=
0
)
goto
out
;
ret
=
PyUnicode_FromWideChar
(
data
size
/
2
)
;
out
:
if
(
data
!
=
NULL
)
free
(
data
)
;
return
ret
;
}
int
psutil_get_proc_info
(
DWORD
pid
PSYSTEM_PROCESS_INFORMATION
*
retProcess
PVOID
*
retBuffer
)
{
static
ULONG
initialBufferSize
=
0x4000
;
NTSTATUS
status
;
PVOID
buffer
;
ULONG
bufferSize
;
PSYSTEM_PROCESS_INFORMATION
process
;
bufferSize
=
initialBufferSize
;
buffer
=
malloc
(
bufferSize
)
;
if
(
buffer
=
=
NULL
)
{
PyErr_NoMemory
(
)
;
goto
error
;
}
while
(
TRUE
)
{
status
=
NtQuerySystemInformation
(
SystemProcessInformation
buffer
bufferSize
&
bufferSize
)
;
if
(
status
=
=
STATUS_BUFFER_TOO_SMALL
|
|
status
=
=
STATUS_INFO_LENGTH_MISMATCH
)
{
free
(
buffer
)
;
buffer
=
malloc
(
bufferSize
)
;
if
(
buffer
=
=
NULL
)
{
PyErr_NoMemory
(
)
;
goto
error
;
}
}
else
{
break
;
}
}
if
(
!
NT_SUCCESS
(
status
)
)
{
psutil_SetFromNTStatusErr
(
status
"
NtQuerySystemInformation
(
SystemProcessInformation
)
"
)
;
goto
error
;
}
if
(
bufferSize
<
=
0x20000
)
initialBufferSize
=
bufferSize
;
process
=
PSUTIL_FIRST_PROCESS
(
buffer
)
;
do
{
if
(
(
ULONG_PTR
)
process
-
>
UniqueProcessId
=
=
pid
)
{
*
retProcess
=
process
;
*
retBuffer
=
buffer
;
return
1
;
}
}
while
(
(
process
=
PSUTIL_NEXT_PROCESS
(
process
)
)
)
;
NoSuchProcess
(
"
NtQuerySystemInformation
(
no
PID
found
)
"
)
;
goto
error
;
error
:
if
(
buffer
!
=
NULL
)
free
(
buffer
)
;
return
0
;
}
PyObject
*
psutil_proc_info
(
PyObject
*
self
PyObject
*
args
)
{
DWORD
pid
;
PSYSTEM_PROCESS_INFORMATION
process
;
PVOID
buffer
;
ULONG
i
;
ULONG
ctx_switches
=
0
;
double
user_time
;
double
kernel_time
;
double
create_time
;
PyObject
*
py_retlist
;
if
(
!
PyArg_ParseTuple
(
args
_Py_PARSE_PID
&
pid
)
)
return
NULL
;
if
(
!
psutil_get_proc_info
(
pid
&
process
&
buffer
)
)
return
NULL
;
for
(
i
=
0
;
i
<
process
-
>
NumberOfThreads
;
i
+
+
)
ctx_switches
+
=
process
-
>
Threads
[
i
]
.
ContextSwitches
;
user_time
=
(
double
)
process
-
>
UserTime
.
HighPart
*
HI_T
+
\
(
double
)
process
-
>
UserTime
.
LowPart
*
LO_T
;
kernel_time
=
(
double
)
process
-
>
KernelTime
.
HighPart
*
HI_T
+
\
(
double
)
process
-
>
KernelTime
.
LowPart
*
LO_T
;
if
(
0
=
=
pid
|
|
4
=
=
pid
)
{
create_time
=
0
;
}
else
{
create_time
=
psutil_LargeIntegerToUnixTime
(
process
-
>
CreateTime
)
;
}
py_retlist
=
Py_BuildValue
(
#
if
defined
(
_WIN64
)
"
kkdddiKKKKKK
"
"
kKKKKKKKKK
"
#
else
"
kkdddiKKKKKK
"
"
kIIIIIIIII
"
#
endif
process
-
>
HandleCount
ctx_switches
user_time
kernel_time
create_time
(
int
)
process
-
>
NumberOfThreads
process
-
>
ReadOperationCount
.
QuadPart
process
-
>
WriteOperationCount
.
QuadPart
process
-
>
ReadTransferCount
.
QuadPart
process
-
>
WriteTransferCount
.
QuadPart
process
-
>
OtherOperationCount
.
QuadPart
process
-
>
OtherTransferCount
.
QuadPart
process
-
>
PageFaultCount
process
-
>
PeakWorkingSetSize
process
-
>
WorkingSetSize
process
-
>
QuotaPeakPagedPoolUsage
process
-
>
QuotaPagedPoolUsage
process
-
>
QuotaPeakNonPagedPoolUsage
process
-
>
QuotaNonPagedPoolUsage
process
-
>
PagefileUsage
process
-
>
PeakPagefileUsage
process
-
>
PrivatePageCount
)
;
free
(
buffer
)
;
return
py_retlist
;
}
