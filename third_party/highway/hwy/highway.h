#
include
"
hwy
/
base
.
h
"
#
include
"
hwy
/
detect_compiler_arch
.
h
"
#
include
"
hwy
/
detect_targets
.
h
"
#
include
"
hwy
/
highway_export
.
h
"
#
include
"
hwy
/
targets
.
h
"
#
if
HWY_CXX_LANG
<
201703L
#
define
HWY_DISPATCH_MAP
1
#
else
#
define
HWY_DISPATCH_MAP
0
#
endif
#
ifndef
HWY_HIGHWAY_INCLUDED
#
define
HWY_HIGHWAY_INCLUDED
namespace
hwy
{
#
define
HWY_FULL1
(
T
)
hwy
:
:
HWY_NAMESPACE
:
:
ScalableTag
<
T
>
#
define
HWY_FULL2
(
T
LMUL
)
\
hwy
:
:
HWY_NAMESPACE
:
:
ScalableTag
<
T
hwy
:
:
CeilLog2
(
HWY_MAX
(
0
LMUL
)
)
>
#
define
HWY_3TH_ARG
(
arg1
arg2
arg3
.
.
.
)
arg3
#
define
HWY_FULL_RECOMPOSER
(
args_with_paren
)
HWY_3TH_ARG
args_with_paren
#
define
HWY_CHOOSE_FULL
(
.
.
.
)
\
HWY_FULL_RECOMPOSER
(
(
__VA_ARGS__
HWY_FULL2
HWY_FULL1
)
)
#
define
HWY_FULL
(
.
.
.
)
HWY_CHOOSE_FULL
(
__VA_ARGS__
(
)
)
(
__VA_ARGS__
)
#
define
HWY_CAPPED
(
T
MAX_N
)
hwy
:
:
HWY_NAMESPACE
:
:
CappedTag
<
T
MAX_N
>
#
ifndef
HWY_ONCE
#
define
HWY_ONCE
1
#
endif
#
if
HWY_STATIC_TARGET
=
=
HWY_SCALAR
#
define
HWY_STATIC_NAMESPACE
N_SCALAR
#
elif
HWY_STATIC_TARGET
=
=
HWY_EMU128
#
define
HWY_STATIC_NAMESPACE
N_EMU128
#
elif
HWY_STATIC_TARGET
=
=
HWY_WASM
#
define
HWY_STATIC_NAMESPACE
N_WASM
#
elif
HWY_STATIC_TARGET
=
=
HWY_WASM_EMU256
#
define
HWY_STATIC_NAMESPACE
N_WASM_EMU256
#
elif
HWY_STATIC_TARGET
=
=
HWY_Z14
#
define
HWY_STATIC_NAMESPACE
N_Z14
#
elif
HWY_STATIC_TARGET
=
=
HWY_Z15
#
define
HWY_STATIC_NAMESPACE
N_Z15
#
elif
HWY_STATIC_TARGET
=
=
HWY_PPC8
#
define
HWY_STATIC_NAMESPACE
N_PPC8
#
elif
HWY_STATIC_TARGET
=
=
HWY_PPC9
#
define
HWY_STATIC_NAMESPACE
N_PPC9
#
elif
HWY_STATIC_TARGET
=
=
HWY_PPC10
#
define
HWY_STATIC_NAMESPACE
N_PPC10
#
elif
HWY_STATIC_TARGET
=
=
HWY_LSX
#
define
HWY_STATIC_NAMESPACE
N_LSX
#
elif
HWY_STATIC_TARGET
=
=
HWY_LASX
#
define
HWY_STATIC_NAMESPACE
N_LASX
#
elif
HWY_STATIC_TARGET
=
=
HWY_RVV
#
define
HWY_STATIC_NAMESPACE
N_RVV
#
elif
HWY_STATIC_TARGET
=
=
HWY_NEON_WITHOUT_AES
#
define
HWY_STATIC_NAMESPACE
N_NEON_WITHOUT_AES
#
elif
HWY_STATIC_TARGET
=
=
HWY_NEON
#
define
HWY_STATIC_NAMESPACE
N_NEON
#
elif
HWY_STATIC_TARGET
=
=
HWY_NEON_BF16
#
define
HWY_STATIC_NAMESPACE
N_NEON_BF16
#
elif
HWY_STATIC_TARGET
=
=
HWY_SVE
#
define
HWY_STATIC_NAMESPACE
N_SVE
#
elif
HWY_STATIC_TARGET
=
=
HWY_SVE2
#
define
HWY_STATIC_NAMESPACE
N_SVE2
#
elif
HWY_STATIC_TARGET
=
=
HWY_SVE_256
#
define
HWY_STATIC_NAMESPACE
N_SVE_256
#
elif
HWY_STATIC_TARGET
=
=
HWY_SVE2_128
#
define
HWY_STATIC_NAMESPACE
N_SVE2_128
#
elif
HWY_STATIC_TARGET
=
=
HWY_SSE2
#
define
HWY_STATIC_NAMESPACE
N_SSE2
#
elif
HWY_STATIC_TARGET
=
=
HWY_SSSE3
#
define
HWY_STATIC_NAMESPACE
N_SSSE3
#
elif
HWY_STATIC_TARGET
=
=
HWY_SSE4
#
define
HWY_STATIC_NAMESPACE
N_SSE4
#
elif
HWY_STATIC_TARGET
=
=
HWY_AVX2
#
define
HWY_STATIC_NAMESPACE
N_AVX2
#
elif
HWY_STATIC_TARGET
=
=
HWY_AVX3
#
define
HWY_STATIC_NAMESPACE
N_AVX3
#
elif
HWY_STATIC_TARGET
=
=
HWY_AVX3_DL
#
define
HWY_STATIC_NAMESPACE
N_AVX3_DL
#
elif
HWY_STATIC_TARGET
=
=
HWY_AVX3_ZEN4
#
define
HWY_STATIC_NAMESPACE
N_AVX3_ZEN4
#
elif
HWY_STATIC_TARGET
=
=
HWY_AVX3_SPR
#
define
HWY_STATIC_NAMESPACE
N_AVX3_SPR
#
elif
HWY_STATIC_TARGET
=
=
HWY_AVX10_2
#
define
HWY_STATIC_NAMESPACE
N_AVX10_2
#
endif
#
define
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
HWY_STATIC_NAMESPACE
:
:
FUNC_NAME
#
if
HWY_TARGETS
&
HWY_EMU128
#
define
HWY_CHOOSE_FALLBACK
(
FUNC_NAME
)
&
N_EMU128
:
:
FUNC_NAME
#
define
HWY_VISIT_FALLBACK
(
VISITOR
)
VISITOR
(
HWY_EMU128
N_EMU128
)
#
elif
HWY_TARGETS
&
HWY_SCALAR
#
define
HWY_CHOOSE_FALLBACK
(
FUNC_NAME
)
&
N_SCALAR
:
:
FUNC_NAME
#
define
HWY_VISIT_FALLBACK
(
VISITOR
)
VISITOR
(
HWY_SCALAR
N_SCALAR
)
#
else
#
define
HWY_CHOOSE_FALLBACK
(
FUNC_NAME
)
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
#
define
HWY_VISIT_FALLBACK
(
VISITOR
)
\
VISITOR
(
HWY_STATIC_TARGET
HWY_STATIC_NAMESPACE
)
#
endif
#
if
HWY_TARGETS
&
HWY_WASM
#
define
HWY_CHOOSE_WASM
(
FUNC_NAME
)
&
N_WASM
:
:
FUNC_NAME
#
define
HWY_VISIT_WASM
(
VISITOR
)
VISITOR
(
HWY_WASM
N_WASM
)
#
else
#
define
HWY_CHOOSE_WASM
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_WASM
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_WASM_EMU256
#
define
HWY_CHOOSE_WASM_EMU256
(
FUNC_NAME
)
&
N_WASM_EMU256
:
:
FUNC_NAME
#
define
HWY_VISIT_WASM_EMU256
(
VISITOR
)
VISITOR
(
HWY_WASM_EMU256
N_WASM_EMU256
)
#
else
#
define
HWY_CHOOSE_WASM_EMU256
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_WASM_EMU256
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_Z14
#
define
HWY_CHOOSE_Z14
(
FUNC_NAME
)
&
N_Z14
:
:
FUNC_NAME
#
define
HWY_VISIT_Z14
(
VISITOR
)
VISITOR
(
HWY_Z14
N_Z14
)
#
else
#
define
HWY_CHOOSE_Z14
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_Z14
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_Z15
#
define
HWY_CHOOSE_Z15
(
FUNC_NAME
)
&
N_Z15
:
:
FUNC_NAME
#
define
HWY_VISIT_Z15
(
VISITOR
)
VISITOR
(
HWY_Z15
N_Z15
)
#
else
#
define
HWY_CHOOSE_Z15
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_Z15
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_PPC8
#
define
HWY_CHOOSE_PPC8
(
FUNC_NAME
)
&
N_PPC8
:
:
FUNC_NAME
#
define
HWY_VISIT_PPC8
(
VISITOR
)
VISITOR
(
HWY_PPC8
N_PPC8
)
#
else
#
define
HWY_CHOOSE_PPC8
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_PPC8
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_PPC9
#
define
HWY_CHOOSE_PPC9
(
FUNC_NAME
)
&
N_PPC9
:
:
FUNC_NAME
#
define
HWY_VISIT_PPC9
(
VISITOR
)
VISITOR
(
HWY_PPC9
N_PPC9
)
#
else
#
define
HWY_CHOOSE_PPC9
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_PPC9
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_LSX
#
define
HWY_CHOOSE_LSX
(
FUNC_NAME
)
&
N_LSX
:
:
FUNC_NAME
#
define
HWY_VISIT_LSX
(
VISITOR
)
VISITOR
(
HWY_LSX
N_LSX
)
#
else
#
define
HWY_CHOOSE_LSX
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_LSX
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_LASX
#
define
HWY_CHOOSE_LASX
(
FUNC_NAME
)
&
N_LASX
:
:
FUNC_NAME
#
define
HWY_VISIT_LASX
(
VISITOR
)
VISITOR
(
HWY_LASX
N_LASX
)
#
else
#
define
HWY_CHOOSE_LASX
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_LASX
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_PPC10
#
define
HWY_CHOOSE_PPC10
(
FUNC_NAME
)
&
N_PPC10
:
:
FUNC_NAME
#
define
HWY_VISIT_PPC10
(
VISITOR
)
VISITOR
(
HWY_PPC10
N_PPC10
)
#
else
#
define
HWY_CHOOSE_PPC10
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_PPC10
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_RVV
#
define
HWY_CHOOSE_RVV
(
FUNC_NAME
)
&
N_RVV
:
:
FUNC_NAME
#
define
HWY_VISIT_RVV
(
VISITOR
)
VISITOR
(
HWY_RVV
N_RVV
)
#
else
#
define
HWY_CHOOSE_RVV
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_RVV
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_NEON_WITHOUT_AES
#
define
HWY_CHOOSE_NEON_WITHOUT_AES
(
FUNC_NAME
)
&
N_NEON_WITHOUT_AES
:
:
FUNC_NAME
#
define
HWY_VISIT_NEON_WITHOUT_AES
(
VISITOR
)
\
VISITOR
(
HWY_NEON_WITHOUT_AES
N_NEON_WITHOUT_AES
)
#
else
#
define
HWY_CHOOSE_NEON_WITHOUT_AES
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_NEON_WITHOUT_AES
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_NEON
#
define
HWY_CHOOSE_NEON
(
FUNC_NAME
)
&
N_NEON
:
:
FUNC_NAME
#
define
HWY_VISIT_NEON
(
VISITOR
)
VISITOR
(
HWY_NEON
N_NEON
)
#
else
#
define
HWY_CHOOSE_NEON
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_NEON
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_NEON_BF16
#
define
HWY_CHOOSE_NEON_BF16
(
FUNC_NAME
)
&
N_NEON_BF16
:
:
FUNC_NAME
#
define
HWY_VISIT_NEON_BF16
(
VISITOR
)
VISITOR
(
HWY_NEON_BF16
N_NEON_BF16
)
#
else
#
define
HWY_CHOOSE_NEON_BF16
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_NEON_BF16
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_SVE
#
define
HWY_CHOOSE_SVE
(
FUNC_NAME
)
&
N_SVE
:
:
FUNC_NAME
#
define
HWY_VISIT_SVE
(
VISITOR
)
VISITOR
(
HWY_SVE
N_SVE
)
#
else
#
define
HWY_CHOOSE_SVE
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_SVE
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_SVE2
#
define
HWY_CHOOSE_SVE2
(
FUNC_NAME
)
&
N_SVE2
:
:
FUNC_NAME
#
define
HWY_VISIT_SVE2
(
VISITOR
)
VISITOR
(
HWY_SVE2
N_SVE2
)
#
else
#
define
HWY_CHOOSE_SVE2
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_SVE2
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_SVE_256
#
define
HWY_CHOOSE_SVE_256
(
FUNC_NAME
)
&
N_SVE_256
:
:
FUNC_NAME
#
define
HWY_VISIT_SVE_256
(
VISITOR
)
VISITOR
(
HWY_SVE_256
N_SVE_256
)
#
else
#
define
HWY_CHOOSE_SVE_256
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_SVE_256
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_SVE2_128
#
define
HWY_CHOOSE_SVE2_128
(
FUNC_NAME
)
&
N_SVE2_128
:
:
FUNC_NAME
#
define
HWY_VISIT_SVE2_128
(
VISITOR
)
VISITOR
(
HWY_SVE2_128
N_SVE2_128
)
#
else
#
define
HWY_CHOOSE_SVE2_128
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_SVE2_128
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_SSE2
#
define
HWY_CHOOSE_SSE2
(
FUNC_NAME
)
&
N_SSE2
:
:
FUNC_NAME
#
define
HWY_VISIT_SSE2
(
VISITOR
)
VISITOR
(
HWY_SSE2
N_SSE2
)
#
else
#
define
HWY_CHOOSE_SSE2
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_SSE2
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_SSSE3
#
define
HWY_CHOOSE_SSSE3
(
FUNC_NAME
)
&
N_SSSE3
:
:
FUNC_NAME
#
define
HWY_VISIT_SSSE3
(
VISITOR
)
VISITOR
(
HWY_SSSE3
N_SSSE3
)
#
else
#
define
HWY_CHOOSE_SSSE3
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_SSSE3
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_SSE4
#
define
HWY_CHOOSE_SSE4
(
FUNC_NAME
)
&
N_SSE4
:
:
FUNC_NAME
#
define
HWY_VISIT_SSE4
(
VISITOR
)
VISITOR
(
HWY_SSE4
N_SSE4
)
#
else
#
define
HWY_CHOOSE_SSE4
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_SSE4
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_AVX2
#
define
HWY_CHOOSE_AVX2
(
FUNC_NAME
)
&
N_AVX2
:
:
FUNC_NAME
#
define
HWY_VISIT_AVX2
(
VISITOR
)
VISITOR
(
HWY_AVX2
N_AVX2
)
#
else
#
define
HWY_CHOOSE_AVX2
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_AVX2
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_AVX3
#
define
HWY_CHOOSE_AVX3
(
FUNC_NAME
)
&
N_AVX3
:
:
FUNC_NAME
#
define
HWY_VISIT_AVX3
(
VISITOR
)
VISITOR
(
HWY_AVX3
N_AVX3
)
#
else
#
define
HWY_CHOOSE_AVX3
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_AVX3
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_AVX3_DL
#
define
HWY_CHOOSE_AVX3_DL
(
FUNC_NAME
)
&
N_AVX3_DL
:
:
FUNC_NAME
#
define
HWY_VISIT_AVX3_DL
(
VISITOR
)
VISITOR
(
HWY_AVX3_DL
N_AVX3_DL
)
#
else
#
define
HWY_CHOOSE_AVX3_DL
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_AVX3_DL
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_AVX3_ZEN4
#
define
HWY_CHOOSE_AVX3_ZEN4
(
FUNC_NAME
)
&
N_AVX3_ZEN4
:
:
FUNC_NAME
#
define
HWY_VISIT_AVX3_ZEN4
(
VISITOR
)
VISITOR
(
HWY_AVX3_ZEN4
N_AVX3_ZEN4
)
#
else
#
define
HWY_CHOOSE_AVX3_ZEN4
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_AVX3_ZEN4
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_AVX3_SPR
#
define
HWY_CHOOSE_AVX3_SPR
(
FUNC_NAME
)
&
N_AVX3_SPR
:
:
FUNC_NAME
#
define
HWY_VISIT_AVX3_SPR
(
VISITOR
)
VISITOR
(
HWY_AVX3_SPR
N_AVX3_SPR
)
#
else
#
define
HWY_CHOOSE_AVX3_SPR
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_AVX3_SPR
(
VISITOR
)
#
endif
#
if
HWY_TARGETS
&
HWY_AVX10_2
#
define
HWY_CHOOSE_AVX10_2
(
FUNC_NAME
)
&
N_AVX10_2
:
:
FUNC_NAME
#
define
HWY_VISIT_AVX10_2
(
VISITOR
)
VISITOR
(
HWY_AVX10_2
N_AVX10_2
)
#
else
#
define
HWY_CHOOSE_AVX10_2
(
FUNC_NAME
)
nullptr
#
define
HWY_VISIT_AVX10_2
(
VISITOR
)
#
endif
#
if
(
HWY_COMPILER_MSVC
&
&
HWY_COMPILER_MSVC
<
1915
)
|
|
\
(
HWY_COMPILER_GCC_ACTUAL
&
&
HWY_COMPILER_GCC_ACTUAL
<
700
)
#
define
HWY_DISPATCH_WORKAROUND
1
#
else
#
define
HWY_DISPATCH_WORKAROUND
0
#
endif
#
if
HWY_DISPATCH_MAP
struct
AllExports
{
template
<
class
FuncPtr
class
ExportsKey
uint64_t
kHash
>
static
const
FuncPtr
*
&
GetRefToExportsPtr
(
)
{
static
const
FuncPtr
*
s_exports
=
nullptr
;
return
s_exports
;
}
}
;
#
endif
template
<
typename
RetType
typename
.
.
.
Args
>
struct
FunctionCache
{
public
:
typedef
RetType
(
FuncType
)
(
Args
.
.
.
)
;
using
FuncPtr
=
FuncType
*
;
#
if
HWY_DISPATCH_MAP
template
<
class
ExportsKey
uint64_t
kHash
>
static
RetType
ChooseAndCall
(
Args
.
.
.
args
)
{
ChosenTarget
&
chosen_target
=
GetChosenTarget
(
)
;
chosen_target
.
Update
(
SupportedTargets
(
)
)
;
const
FuncPtr
*
table
=
AllExports
:
:
template
GetRefToExportsPtr
<
FuncPtr
RemoveCvRef
<
ExportsKey
>
kHash
>
(
)
;
HWY_ASSERT
(
table
)
;
return
(
table
[
chosen_target
.
GetIndex
(
)
]
)
(
args
.
.
.
)
;
}
#
if
!
HWY_DISPATCH_WORKAROUND
template
<
const
FuncPtr
*
table
>
static
RetType
TableChooseAndCall
(
Args
.
.
.
args
)
{
ChosenTarget
&
chosen_target
=
GetChosenTarget
(
)
;
chosen_target
.
Update
(
SupportedTargets
(
)
)
;
return
(
table
[
chosen_target
.
GetIndex
(
)
]
)
(
args
.
.
.
)
;
}
#
endif
#
else
template
<
const
FuncPtr
*
table
>
static
RetType
ChooseAndCall
(
Args
.
.
.
args
)
{
ChosenTarget
&
chosen_target
=
GetChosenTarget
(
)
;
chosen_target
.
Update
(
SupportedTargets
(
)
)
;
return
(
table
[
chosen_target
.
GetIndex
(
)
]
)
(
args
.
.
.
)
;
}
#
endif
}
;
template
<
typename
RetType
typename
.
.
.
Args
>
FunctionCache
<
RetType
Args
.
.
.
>
DeduceFunctionCache
(
RetType
(
*
)
(
Args
.
.
.
)
)
{
return
FunctionCache
<
RetType
Args
.
.
.
>
(
)
;
}
#
define
HWY_DISPATCH_TABLE
(
FUNC_NAME
)
\
HWY_CONCAT
(
FUNC_NAME
HighwayDispatchTable
)
#
if
HWY_IDE
|
|
(
(
HWY_TARGETS
&
(
HWY_TARGETS
-
1
)
)
=
=
0
)
#
define
HWY_EXPORT_T
(
TABLE_NAME
FUNC_NAME
)
\
HWY_MAYBE_UNUSED
static
decltype
(
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
)
const
\
HWY_DISPATCH_TABLE
(
TABLE_NAME
)
[
1
]
=
{
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
}
#
define
HWY_DYNAMIC_POINTER_T
(
TABLE_NAME
)
(
HWY_DISPATCH_TABLE
(
TABLE_NAME
)
[
0
]
)
#
define
HWY_DYNAMIC_DISPATCH_T
(
TABLE_NAME
)
\
(
*
(
HWY_DYNAMIC_POINTER_T
(
TABLE_NAME
)
)
)
#
define
HWY_EXPORT
(
FUNC_NAME
)
HWY_EXPORT_T
(
FUNC_NAME
FUNC_NAME
)
#
define
HWY_DYNAMIC_POINTER
(
FUNC_NAME
)
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
#
define
HWY_DYNAMIC_DISPATCH
(
FUNC_NAME
)
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
#
else
#
if
HWY_DISPATCH_MAP
static
constexpr
uint64_t
FNV
(
const
char
*
name
)
{
return
*
name
?
static_cast
<
uint64_t
>
(
static_cast
<
uint8_t
>
(
*
name
)
)
^
(
0x100000001b3ULL
*
FNV
(
name
+
1
)
)
:
0xcbf29ce484222325ULL
;
}
template
<
uint64_t
kHash
>
struct
AddExport
{
template
<
class
ExportsKey
class
FuncPtr
>
AddExport
(
ExportsKey
const
char
*
table_name
const
FuncPtr
*
table
)
{
using
FuncCache
=
decltype
(
DeduceFunctionCache
(
hwy
:
:
DeclVal
<
FuncPtr
>
(
)
)
)
;
static_assert
(
hwy
:
:
IsSame
<
RemoveCvRef
<
FuncPtr
>
typename
FuncCache
:
:
FuncPtr
>
(
)
"
FuncPtr
should
be
same
type
as
FuncCache
:
:
FuncPtr
"
)
;
const
FuncPtr
*
&
exports_ptr
=
AllExports
:
:
template
GetRefToExportsPtr
<
RemoveCvRef
<
FuncPtr
>
RemoveCvRef
<
ExportsKey
>
kHash
>
(
)
;
if
(
exports_ptr
&
&
exports_ptr
!
=
table
)
{
HWY_ABORT
(
"
Hash
collision
for
%
s
rename
the
function
\
n
"
table_name
)
;
}
else
{
exports_ptr
=
table
;
}
}
}
;
#
define
HWY_EXPORT_T
(
TABLE_NAME
FUNC_NAME
)
\
static
const
struct
{
\
}
HWY_CONCAT
(
TABLE_NAME
HighwayDispatchExportsKey
)
=
{
}
;
\
static
decltype
(
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
)
const
HWY_DISPATCH_TABLE
(
\
TABLE_NAME
)
[
static_cast
<
size_t
>
(
HWY_MAX_DYNAMIC_TARGETS
+
2
)
]
=
{
\
/
*
The
first
entry
in
the
table
initializes
the
global
cache
and
\
*
calls
the
appropriate
function
.
*
/
\
&
decltype
(
hwy
:
:
DeduceFunctionCache
(
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
)
)
:
:
\
template
ChooseAndCall
<
decltype
(
HWY_CONCAT
(
\
TABLE_NAME
HighwayDispatchExportsKey
)
)
\
hwy
:
:
FNV
(
#
TABLE_NAME
)
>
\
HWY_CHOOSE_TARGET_LIST
(
FUNC_NAME
)
\
HWY_CHOOSE_FALLBACK
(
FUNC_NAME
)
\
}
;
\
HWY_MAYBE_UNUSED
static
hwy
:
:
AddExport
<
hwy
:
:
FNV
(
#
TABLE_NAME
)
>
HWY_CONCAT
(
\
HighwayAddTable
__LINE__
)
(
\
HWY_CONCAT
(
TABLE_NAME
HighwayDispatchExportsKey
)
#
TABLE_NAME
\
HWY_DISPATCH_TABLE
(
TABLE_NAME
)
)
#
if
HWY_DISPATCH_WORKAROUND
#
define
HWY_EXPORT
(
FUNC_NAME
)
HWY_EXPORT_T
(
FUNC_NAME
FUNC_NAME
)
#
else
#
define
HWY_EXPORT
(
FUNC_NAME
)
\
static
decltype
(
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
)
const
HWY_DISPATCH_TABLE
(
\
FUNC_NAME
)
[
static_cast
<
size_t
>
(
HWY_MAX_DYNAMIC_TARGETS
+
2
)
]
=
{
\
/
*
The
first
entry
in
the
table
initializes
the
global
cache
and
\
*
calls
the
appropriate
function
.
*
/
\
&
decltype
(
hwy
:
:
DeduceFunctionCache
(
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
)
)
:
:
\
template
TableChooseAndCall
<
HWY_DISPATCH_TABLE
(
FUNC_NAME
)
>
\
HWY_CHOOSE_TARGET_LIST
(
FUNC_NAME
)
\
HWY_CHOOSE_FALLBACK
(
FUNC_NAME
)
\
}
#
endif
#
else
#
define
HWY_EXPORT_T
(
TABLE_NAME
FUNC_NAME
)
\
static
decltype
(
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
)
const
HWY_DISPATCH_TABLE
(
\
TABLE_NAME
)
[
static_cast
<
size_t
>
(
HWY_MAX_DYNAMIC_TARGETS
+
2
)
]
=
{
\
/
*
The
first
entry
in
the
table
initializes
the
global
cache
and
\
*
calls
the
appropriate
function
.
*
/
\
&
decltype
(
hwy
:
:
DeduceFunctionCache
(
&
HWY_STATIC_DISPATCH
(
FUNC_NAME
)
)
)
:
:
\
template
ChooseAndCall
<
HWY_DISPATCH_TABLE
(
TABLE_NAME
)
>
\
HWY_CHOOSE_TARGET_LIST
(
FUNC_NAME
)
\
HWY_CHOOSE_FALLBACK
(
FUNC_NAME
)
\
}
#
define
HWY_EXPORT
(
FUNC_NAME
)
HWY_EXPORT_T
(
FUNC_NAME
FUNC_NAME
)
#
endif
#
define
HWY_DYNAMIC_POINTER
(
FUNC_NAME
)
\
(
HWY_DISPATCH_TABLE
(
FUNC_NAME
)
[
hwy
:
:
GetChosenTarget
(
)
.
GetIndex
(
)
]
)
#
if
HWY_COMPILER_GCC
|
|
HWY_COMPILER_CLANG
#
define
HWY_DYNAMIC_DISPATCH
(
FUNC_NAME
)
\
__extension__
(
{
\
auto
HWY_CONCAT
(
hwy_tmp_
__LINE__
)
=
*
(
HWY_DYNAMIC_POINTER
(
FUNC_NAME
)
)
;
\
hwy
:
:
PreventElision
(
HWY_CONCAT
(
hwy_tmp_
__LINE__
)
)
;
\
HWY_CONCAT
(
hwy_tmp_
__LINE__
)
;
\
}
)
#
else
#
define
HWY_DYNAMIC_DISPATCH
(
FUNC_NAME
)
(
*
(
HWY_DYNAMIC_POINTER
(
FUNC_NAME
)
)
)
#
endif
#
define
HWY_DYNAMIC_DISPATCH_T
(
TABLE_NAME
)
HWY_DYNAMIC_DISPATCH
(
TABLE_NAME
)
#
define
HWY_DYNAMIC_POINTER_T
(
TABLE_NAME
)
HWY_DYNAMIC_POINTER
(
TABLE_NAME
)
#
endif
#
define
HWY_DISPATCH_TABLE_T
(
)
HWY_CONCAT
(
HighwayDispatchTableT
__LINE__
)
#
define
HWY_EXPORT_AND_DYNAMIC_DISPATCH_T
(
FUNC_NAME
)
\
HWY_EXPORT_T
(
HWY_DISPATCH_TABLE_T
(
)
FUNC_NAME
)
;
\
HWY_DYNAMIC_DISPATCH_T
(
HWY_DISPATCH_TABLE_T
(
)
)
#
define
HWY_CAP_INTEGER64
HWY_HAVE_INTEGER64
#
define
HWY_CAP_FLOAT16
HWY_HAVE_FLOAT16
#
define
HWY_CAP_FLOAT64
HWY_HAVE_FLOAT64
}
#
endif
#
if
defined
(
HWY_HIGHWAY_PER_TARGET
)
=
=
defined
(
HWY_TARGET_TOGGLE
)
#
ifdef
HWY_HIGHWAY_PER_TARGET
#
undef
HWY_HIGHWAY_PER_TARGET
#
else
#
define
HWY_HIGHWAY_PER_TARGET
#
endif
#
if
HWY_ENABLED_BASELINE
=
=
0
#
if
HWY_TARGET
!
=
0
#
error
"
Why
is
HWY_TARGET
not
0
when
HWY_ENABLED_BASELINE
=
=
0
?
"
#
endif
#
if
HWY_STATIC_TARGET
!
=
0
#
error
"
Why
is
HWY_STATIC_TARGET
not
0
when
HWY_ENABLED_BASELINE
=
=
0
?
"
#
endif
#
else
#
if
HWY_TARGET
=
=
HWY_SSE2
|
|
HWY_TARGET
=
=
HWY_SSSE3
|
|
HWY_TARGET
=
=
HWY_SSE4
#
include
"
hwy
/
ops
/
x86_128
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_AVX2
#
include
"
hwy
/
ops
/
x86_256
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_AVX3
|
|
HWY_TARGET
=
=
HWY_AVX3_DL
|
|
\
HWY_TARGET
=
=
HWY_AVX3_ZEN4
|
|
HWY_TARGET
=
=
HWY_AVX3_SPR
|
|
\
HWY_TARGET
=
=
HWY_AVX10_2
#
include
"
hwy
/
ops
/
x86_avx3
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_Z14
|
|
HWY_TARGET
=
=
HWY_Z15
|
|
\
(
HWY_TARGET
&
HWY_ALL_PPC
)
#
include
"
hwy
/
ops
/
ppc_vsx
-
inl
.
h
"
#
elif
HWY_TARGET
&
HWY_ALL_NEON
#
include
"
hwy
/
ops
/
arm_neon
-
inl
.
h
"
#
elif
HWY_TARGET
&
HWY_ALL_SVE
#
include
"
hwy
/
ops
/
arm_sve
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_WASM_EMU256
#
include
"
hwy
/
ops
/
wasm_256
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_WASM
#
include
"
hwy
/
ops
/
wasm_128
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_RVV
#
include
"
hwy
/
ops
/
rvv
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_LSX
#
include
"
hwy
/
ops
/
loongarch_lsx
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_LASX
#
include
"
hwy
/
ops
/
loongarch_lasx
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_EMU128
#
include
"
hwy
/
ops
/
emu128
-
inl
.
h
"
#
elif
HWY_TARGET
=
=
HWY_SCALAR
#
include
"
hwy
/
ops
/
scalar
-
inl
.
h
"
#
else
#
pragma
message
(
"
HWY_TARGET
does
not
match
any
known
target
"
)
#
endif
#
include
"
hwy
/
ops
/
generic_ops
-
inl
.
h
"
#
endif
#
endif
