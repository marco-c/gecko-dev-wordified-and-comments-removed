#
if
defined
(
HIGHWAY_HWY_TIMER_INL_H_
)
=
=
defined
(
HWY_TARGET_TOGGLE
)
#
ifdef
HIGHWAY_HWY_TIMER_INL_H_
#
undef
HIGHWAY_HWY_TIMER_INL_H_
#
else
#
define
HIGHWAY_HWY_TIMER_INL_H_
#
endif
#
include
"
hwy
/
highway
.
h
"
#
include
"
hwy
/
timer
.
h
"
#
if
defined
(
_WIN32
)
|
|
defined
(
_WIN64
)
#
ifndef
NOMINMAX
#
define
NOMINMAX
#
endif
#
include
<
windows
.
h
>
#
endif
#
if
defined
(
__APPLE__
)
#
include
<
mach
/
mach
.
h
>
#
include
<
mach
/
mach_time
.
h
>
#
endif
#
if
defined
(
__HAIKU__
)
#
include
<
OS
.
h
>
#
endif
#
if
HWY_ARCH_PPC
&
&
defined
(
__GLIBC__
)
&
&
defined
(
__powerpc64__
)
#
include
<
sys
/
platform
/
ppc
.
h
>
#
endif
#
if
HWY_ARCH_X86
&
&
HWY_COMPILER_MSVC
#
include
<
intrin
.
h
>
#
endif
#
include
<
time
.
h
>
HWY_BEFORE_NAMESPACE
(
)
;
namespace
hwy
{
namespace
HWY_NAMESPACE
{
namespace
timer
{
using
Ticks
=
uint64_t
;
inline
Ticks
Start
(
)
{
Ticks
t
;
#
if
HWY_ARCH_PPC
&
&
defined
(
__GLIBC__
)
&
&
defined
(
__powerpc64__
)
asm
volatile
(
"
mfspr
%
0
%
1
"
:
"
=
r
"
(
t
)
:
"
i
"
(
268
)
)
;
#
elif
HWY_ARCH_ARM_A64
&
&
!
HWY_COMPILER_MSVC
asm
volatile
(
"
mrs
%
0
cntvct_el0
"
:
"
=
r
"
(
t
)
)
;
#
elif
HWY_ARCH_X86
&
&
HWY_COMPILER_MSVC
_ReadWriteBarrier
(
)
;
_mm_lfence
(
)
;
_ReadWriteBarrier
(
)
;
t
=
__rdtsc
(
)
;
_ReadWriteBarrier
(
)
;
_mm_lfence
(
)
;
_ReadWriteBarrier
(
)
;
#
elif
HWY_ARCH_X86_64
asm
volatile
(
"
lfence
\
n
\
t
"
"
rdtsc
\
n
\
t
"
"
shl
32
%
%
rdx
\
n
\
t
"
"
or
%
%
rdx
%
0
\
n
\
t
"
"
lfence
"
:
"
=
a
"
(
t
)
:
:
"
rdx
"
"
memory
"
"
cc
"
)
;
#
elif
HWY_ARCH_RVV
asm
volatile
(
"
rdtime
%
0
"
:
"
=
r
"
(
t
)
)
;
#
elif
defined
(
_WIN32
)
|
|
defined
(
_WIN64
)
LARGE_INTEGER
counter
;
(
void
)
QueryPerformanceCounter
(
&
counter
)
;
t
=
counter
.
QuadPart
;
#
elif
defined
(
__APPLE__
)
t
=
mach_absolute_time
(
)
;
#
elif
defined
(
__HAIKU__
)
t
=
system_time_nsecs
(
)
;
#
else
timespec
ts
;
clock_gettime
(
CLOCK_MONOTONIC
&
ts
)
;
t
=
static_cast
<
Ticks
>
(
ts
.
tv_sec
*
1000000000LL
+
ts
.
tv_nsec
)
;
#
endif
return
t
;
}
inline
Ticks
Stop
(
)
{
uint64_t
t
;
#
if
HWY_ARCH_PPC
&
&
defined
(
__GLIBC__
)
&
&
defined
(
__powerpc64__
)
asm
volatile
(
"
mfspr
%
0
%
1
"
:
"
=
r
"
(
t
)
:
"
i
"
(
268
)
)
;
#
elif
HWY_ARCH_ARM_A64
&
&
!
HWY_COMPILER_MSVC
asm
volatile
(
"
mrs
%
0
cntvct_el0
"
:
"
=
r
"
(
t
)
)
;
#
elif
HWY_ARCH_X86
&
&
HWY_COMPILER_MSVC
_ReadWriteBarrier
(
)
;
unsigned
aux
;
t
=
__rdtscp
(
&
aux
)
;
_ReadWriteBarrier
(
)
;
_mm_lfence
(
)
;
_ReadWriteBarrier
(
)
;
#
elif
HWY_ARCH_X86_64
asm
volatile
(
"
rdtscp
\
n
\
t
"
"
shl
32
%
%
rdx
\
n
\
t
"
"
or
%
%
rdx
%
0
\
n
\
t
"
"
lfence
"
:
"
=
a
"
(
t
)
:
:
"
rcx
"
"
rdx
"
"
memory
"
"
cc
"
)
;
#
else
t
=
Start
(
)
;
#
endif
return
t
;
}
}
}
}
HWY_AFTER_NAMESPACE
(
)
;
#
endif
