#
ifndef
HIGHWAY_HWY_CONTRIB_SORT_SHARED_INL_H_
#
define
HIGHWAY_HWY_CONTRIB_SORT_SHARED_INL_H_
#
include
"
hwy
/
base
.
h
"
namespace
hwy
{
static
HWY_INLINE
uint64_t
RandomBits
(
uint64_t
*
HWY_RESTRICT
state
)
{
const
uint64_t
a
=
state
[
0
]
;
const
uint64_t
b
=
state
[
1
]
;
const
uint64_t
w
=
state
[
2
]
+
1
;
const
uint64_t
next
=
a
^
w
;
state
[
0
]
=
(
b
+
(
b
<
<
3
)
)
^
(
b
>
>
11
)
;
const
uint64_t
rot
=
(
b
<
<
24
)
|
(
b
>
>
40
)
;
state
[
1
]
=
rot
+
next
;
state
[
2
]
=
w
;
return
next
;
}
struct
SortConstants
{
#
if
HWY_COMPILER_MSVC
|
|
HWY_IS_DEBUG_BUILD
static
constexpr
size_t
kMaxCols
=
8
;
#
else
static
constexpr
size_t
kMaxCols
=
16
;
#
endif
static
constexpr
size_t
kMaxRows
=
16
;
template
<
size_t
kLPK
>
static
constexpr
HWY_INLINE
size_t
BaseCaseNumLanes
(
size_t
N
)
{
return
(
(
(
N
/
kLPK
)
>
=
4
)
?
kMaxRows
:
8
)
*
HWY_MIN
(
N
kMaxCols
)
;
}
static
constexpr
size_t
kPartitionUnroll
=
4
;
static
constexpr
HWY_INLINE
size_t
LanesPerChunk
(
size_t
sizeof_t
)
{
return
64
/
sizeof_t
;
}
template
<
typename
T
>
static
constexpr
HWY_INLINE
size_t
SampleLanes
(
)
{
return
2
*
LanesPerChunk
(
sizeof
(
T
)
)
;
}
static
constexpr
HWY_INLINE
size_t
PartitionBufNum
(
size_t
N
)
{
return
2
*
(
3
*
kPartitionUnroll
+
1
)
*
N
;
}
template
<
typename
T
size_t
kLPK
>
static
constexpr
HWY_INLINE
size_t
BufNum
(
size_t
N
)
{
return
HWY_MAX
(
SampleLanes
<
T
>
(
)
+
BaseCaseNumLanes
<
kLPK
>
(
N
)
+
N
PartitionBufNum
(
N
)
)
;
}
template
<
typename
T
size_t
kLPK
>
static
constexpr
HWY_INLINE
size_t
BufBytes
(
size_t
vector_size
)
{
return
BufNum
<
T
kLPK
>
(
vector_size
/
sizeof
(
T
)
)
*
sizeof
(
T
)
;
}
template
<
size_t
kLPK
>
static
constexpr
HWY_INLINE
size_t
MaxBufBytes
(
size_t
vector_size
)
{
return
kLPK
=
=
2
?
BufBytes
<
uint64_t
2
>
(
vector_size
)
:
HWY_MAX
(
(
BufBytes
<
uint16_t
1
>
(
vector_size
)
)
HWY_MAX
(
(
BufBytes
<
uint32_t
1
>
(
vector_size
)
)
(
BufBytes
<
uint64_t
1
>
(
vector_size
)
)
)
)
;
}
}
;
static_assert
(
SortConstants
:
:
MaxBufBytes
<
1
>
(
64
)
<
=
1664
"
Unexpectedly
high
"
)
;
static_assert
(
SortConstants
:
:
MaxBufBytes
<
2
>
(
64
)
<
=
1664
"
Unexpectedly
high
"
)
;
}
#
endif
#
if
defined
(
HIGHWAY_HWY_CONTRIB_SORT_SHARED_TOGGLE
)
=
=
defined
(
HWY_TARGET_TOGGLE
)
#
ifdef
HIGHWAY_HWY_CONTRIB_SORT_SHARED_TOGGLE
#
undef
HIGHWAY_HWY_CONTRIB_SORT_SHARED_TOGGLE
#
else
#
define
HIGHWAY_HWY_CONTRIB_SORT_SHARED_TOGGLE
#
endif
#
include
"
hwy
/
highway
.
h
"
#
undef
VQSORT_ENABLED
#
undef
VQSORT_COMPILER_COMPATIBLE
#
if
(
HWY_COMPILER_MSVC
&
&
!
HWY_IS_DEBUG_BUILD
)
|
|
\
(
HWY_ARCH_ARM_V7
&
&
HWY_IS_DEBUG_BUILD
)
|
|
\
(
HWY_ARCH_ARM_A64
&
&
HWY_IS_ASAN
)
|
|
\
(
HWY_ARCH_RISCV
&
&
HWY_COMPILER_GCC_ACTUAL
<
1400
)
#
define
VQSORT_COMPILER_COMPATIBLE
0
#
else
#
define
VQSORT_COMPILER_COMPATIBLE
1
#
endif
#
if
(
HWY_TARGET
=
=
HWY_SCALAR
)
|
|
!
VQSORT_COMPILER_COMPATIBLE
|
|
\
defined
(
HWY_DISABLE_VQSORT
)
#
define
VQSORT_ENABLED
0
#
else
#
define
VQSORT_ENABLED
1
#
endif
namespace
hwy
{
namespace
HWY_NAMESPACE
{
#
if
HWY_TARGET
=
=
HWY_RVV
template
<
typename
T
>
using
SortTag
=
ScalableTag
<
T
-
1
>
;
#
else
template
<
typename
T
>
using
SortTag
=
ScalableTag
<
T
>
;
#
endif
}
}
#
endif
