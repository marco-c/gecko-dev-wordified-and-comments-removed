#
ifndef
RTC_BASE_PROXYSERVER_H_
#
define
RTC_BASE_PROXYSERVER_H_
#
include
<
list
>
#
include
<
memory
>
#
include
"
rtc_base
/
asyncsocket
.
h
"
#
include
"
rtc_base
/
constructormagic
.
h
"
#
include
"
rtc_base
/
socketadapters
.
h
"
#
include
"
rtc_base
/
socketaddress
.
h
"
#
include
"
rtc_base
/
stream
.
h
"
namespace
rtc
{
class
SocketFactory
;
class
ProxyBinding
:
public
sigslot
:
:
has_slots
<
>
{
public
:
ProxyBinding
(
AsyncProxyServerSocket
*
in_socket
AsyncSocket
*
out_socket
)
;
~
ProxyBinding
(
)
override
;
sigslot
:
:
signal1
<
ProxyBinding
*
>
SignalDestroyed
;
private
:
void
OnConnectRequest
(
AsyncProxyServerSocket
*
socket
const
SocketAddress
&
addr
)
;
void
OnInternalRead
(
AsyncSocket
*
socket
)
;
void
OnInternalWrite
(
AsyncSocket
*
socket
)
;
void
OnInternalClose
(
AsyncSocket
*
socket
int
err
)
;
void
OnExternalConnect
(
AsyncSocket
*
socket
)
;
void
OnExternalRead
(
AsyncSocket
*
socket
)
;
void
OnExternalWrite
(
AsyncSocket
*
socket
)
;
void
OnExternalClose
(
AsyncSocket
*
socket
int
err
)
;
static
void
Read
(
AsyncSocket
*
socket
FifoBuffer
*
buffer
)
;
static
void
Write
(
AsyncSocket
*
socket
FifoBuffer
*
buffer
)
;
void
Destroy
(
)
;
static
const
int
kBufferSize
=
4096
;
std
:
:
unique_ptr
<
AsyncProxyServerSocket
>
int_socket_
;
std
:
:
unique_ptr
<
AsyncSocket
>
ext_socket_
;
bool
connected_
;
FifoBuffer
out_buffer_
;
FifoBuffer
in_buffer_
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
ProxyBinding
)
;
}
;
class
ProxyServer
:
public
sigslot
:
:
has_slots
<
>
{
public
:
ProxyServer
(
SocketFactory
*
int_factory
const
SocketAddress
&
int_addr
SocketFactory
*
ext_factory
const
SocketAddress
&
ext_ip
)
;
~
ProxyServer
(
)
override
;
SocketAddress
GetServerAddress
(
)
;
protected
:
void
OnAcceptEvent
(
AsyncSocket
*
socket
)
;
virtual
AsyncProxyServerSocket
*
WrapSocket
(
AsyncSocket
*
socket
)
=
0
;
void
OnBindingDestroyed
(
ProxyBinding
*
binding
)
;
private
:
typedef
std
:
:
list
<
ProxyBinding
*
>
BindingList
;
SocketFactory
*
ext_factory_
;
SocketAddress
ext_ip_
;
std
:
:
unique_ptr
<
AsyncSocket
>
server_socket_
;
BindingList
bindings_
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
ProxyServer
)
;
}
;
class
SocksProxyServer
:
public
ProxyServer
{
public
:
SocksProxyServer
(
SocketFactory
*
int_factory
const
SocketAddress
&
int_addr
SocketFactory
*
ext_factory
const
SocketAddress
&
ext_ip
)
:
ProxyServer
(
int_factory
int_addr
ext_factory
ext_ip
)
{
}
protected
:
AsyncProxyServerSocket
*
WrapSocket
(
AsyncSocket
*
socket
)
override
;
RTC_DISALLOW_COPY_AND_ASSIGN
(
SocksProxyServer
)
;
}
;
}
#
endif
