#
ifndef
MODULES_AUDIO_CODING_NETEQ_NETEQ_IMPL_H_
#
define
MODULES_AUDIO_CODING_NETEQ_NETEQ_IMPL_H_
#
include
<
memory
>
#
include
<
string
>
#
include
"
api
/
optional
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
audio_multi_vector
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
defines
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
include
/
neteq
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
packet
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
random_vector
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
rtcp
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
statistics_calculator
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
tick_timer
.
h
"
#
include
"
modules
/
include
/
module_common_types
.
h
"
#
include
"
rtc_base
/
constructormagic
.
h
"
#
include
"
rtc_base
/
criticalsection
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
#
include
"
typedefs
.
h
"
namespace
webrtc
{
class
Accelerate
;
class
BackgroundNoise
;
class
BufferLevelFilter
;
class
ComfortNoise
;
class
DecisionLogic
;
class
DecoderDatabase
;
class
DelayManager
;
class
DelayPeakDetector
;
class
DtmfBuffer
;
class
DtmfToneGenerator
;
class
Expand
;
class
Merge
;
class
NackTracker
;
class
Normal
;
class
PacketBuffer
;
class
RedPayloadSplitter
;
class
PostDecodeVad
;
class
PreemptiveExpand
;
class
RandomVector
;
class
SyncBuffer
;
class
TimestampScaler
;
struct
AccelerateFactory
;
struct
DtmfEvent
;
struct
ExpandFactory
;
struct
PreemptiveExpandFactory
;
class
NetEqImpl
:
public
webrtc
:
:
NetEq
{
public
:
enum
class
OutputType
{
kNormalSpeech
kPLC
kCNG
kPLCCNG
kVadPassive
}
;
enum
ErrorCodes
{
kNoError
=
0
kOtherError
kUnknownRtpPayloadType
kDecoderNotFound
kInvalidPointer
kAccelerateError
kPreemptiveExpandError
kComfortNoiseErrorCode
kDecoderErrorCode
kOtherDecoderError
kInvalidOperation
kDtmfParsingError
kDtmfInsertError
kSampleUnderrun
kDecodedTooMuch
kRedundancySplitError
kPacketBufferCorruption
}
;
struct
Dependencies
{
explicit
Dependencies
(
const
NetEq
:
:
Config
&
config
const
rtc
:
:
scoped_refptr
<
AudioDecoderFactory
>
&
decoder_factory
)
;
~
Dependencies
(
)
;
std
:
:
unique_ptr
<
TickTimer
>
tick_timer
;
std
:
:
unique_ptr
<
BufferLevelFilter
>
buffer_level_filter
;
std
:
:
unique_ptr
<
DecoderDatabase
>
decoder_database
;
std
:
:
unique_ptr
<
DelayPeakDetector
>
delay_peak_detector
;
std
:
:
unique_ptr
<
DelayManager
>
delay_manager
;
std
:
:
unique_ptr
<
DtmfBuffer
>
dtmf_buffer
;
std
:
:
unique_ptr
<
DtmfToneGenerator
>
dtmf_tone_generator
;
std
:
:
unique_ptr
<
PacketBuffer
>
packet_buffer
;
std
:
:
unique_ptr
<
RedPayloadSplitter
>
red_payload_splitter
;
std
:
:
unique_ptr
<
TimestampScaler
>
timestamp_scaler
;
std
:
:
unique_ptr
<
AccelerateFactory
>
accelerate_factory
;
std
:
:
unique_ptr
<
ExpandFactory
>
expand_factory
;
std
:
:
unique_ptr
<
PreemptiveExpandFactory
>
preemptive_expand_factory
;
}
;
NetEqImpl
(
const
NetEq
:
:
Config
&
config
Dependencies
&
&
deps
bool
create_components
=
true
)
;
~
NetEqImpl
(
)
override
;
int
InsertPacket
(
const
RTPHeader
&
rtp_header
rtc
:
:
ArrayView
<
const
uint8_t
>
payload
uint32_t
receive_timestamp
)
override
;
void
InsertEmptyPacket
(
const
RTPHeader
&
rtp_header
)
override
;
int
GetAudio
(
AudioFrame
*
audio_frame
bool
*
muted
)
override
;
void
SetCodecs
(
const
std
:
:
map
<
int
SdpAudioFormat
>
&
codecs
)
override
;
int
RegisterPayloadType
(
NetEqDecoder
codec
const
std
:
:
string
&
codec_name
uint8_t
rtp_payload_type
)
override
;
int
RegisterExternalDecoder
(
AudioDecoder
*
decoder
NetEqDecoder
codec
const
std
:
:
string
&
codec_name
uint8_t
rtp_payload_type
)
override
;
bool
RegisterPayloadType
(
int
rtp_payload_type
const
SdpAudioFormat
&
audio_format
)
override
;
int
RemovePayloadType
(
uint8_t
rtp_payload_type
)
override
;
void
RemoveAllPayloadTypes
(
)
override
;
bool
SetMinimumDelay
(
int
delay_ms
)
override
;
bool
SetMaximumDelay
(
int
delay_ms
)
override
;
int
LeastRequiredDelayMs
(
)
const
override
;
int
SetTargetDelay
(
)
override
;
int
TargetDelayMs
(
)
const
override
;
int
CurrentDelayMs
(
)
const
override
;
int
FilteredCurrentDelayMs
(
)
const
override
;
void
SetPlayoutMode
(
NetEqPlayoutMode
mode
)
override
;
NetEqPlayoutMode
PlayoutMode
(
)
const
override
;
int
NetworkStatistics
(
NetEqNetworkStatistics
*
stats
)
override
;
void
GetRtcpStatistics
(
RtcpStatistics
*
stats
)
override
;
NetEqLifetimeStatistics
GetLifetimeStatistics
(
)
const
override
;
void
GetRtcpStatisticsNoReset
(
RtcpStatistics
*
stats
)
override
;
void
EnableVad
(
)
override
;
void
DisableVad
(
)
override
;
rtc
:
:
Optional
<
uint32_t
>
GetPlayoutTimestamp
(
)
const
override
;
int
last_output_sample_rate_hz
(
)
const
override
;
rtc
:
:
Optional
<
CodecInst
>
GetDecoder
(
int
payload_type
)
const
override
;
rtc
:
:
Optional
<
SdpAudioFormat
>
GetDecoderFormat
(
int
payload_type
)
const
override
;
int
SetTargetNumberOfChannels
(
)
override
;
int
SetTargetSampleRate
(
)
override
;
void
FlushBuffers
(
)
override
;
void
PacketBufferStatistics
(
int
*
current_num_packets
int
*
max_num_packets
)
const
override
;
void
EnableNack
(
size_t
max_nack_list_size
)
override
;
void
DisableNack
(
)
override
;
std
:
:
vector
<
uint16_t
>
GetNackList
(
int64_t
round_trip_time_ms
)
const
override
;
std
:
:
vector
<
uint32_t
>
LastDecodedTimestamps
(
)
const
override
;
int
SyncBufferSizeMs
(
)
const
override
;
const
SyncBuffer
*
sync_buffer_for_test
(
)
const
;
Operations
last_operation_for_test
(
)
const
;
protected
:
static
const
int
kOutputSizeMs
=
10
;
static
const
size_t
kMaxFrameSize
=
5760
;
static
const
size_t
kSyncBufferSize
=
kMaxFrameSize
+
60
*
48
;
int
InsertPacketInternal
(
const
RTPHeader
&
rtp_header
rtc
:
:
ArrayView
<
const
uint8_t
>
payload
uint32_t
receive_timestamp
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
GetAudioInternal
(
AudioFrame
*
audio_frame
bool
*
muted
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
GetDecision
(
Operations
*
operation
PacketList
*
packet_list
DtmfEvent
*
dtmf_event
bool
*
play_dtmf
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
Decode
(
PacketList
*
packet_list
Operations
*
operation
int
*
decoded_length
AudioDecoder
:
:
SpeechType
*
speech_type
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DecodeCng
(
AudioDecoder
*
decoder
int
*
decoded_length
AudioDecoder
:
:
SpeechType
*
speech_type
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DecodeLoop
(
PacketList
*
packet_list
const
Operations
&
operation
AudioDecoder
*
decoder
int
*
decoded_length
AudioDecoder
:
:
SpeechType
*
speech_type
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
void
DoNormal
(
const
int16_t
*
decoded_buffer
size_t
decoded_length
AudioDecoder
:
:
SpeechType
speech_type
bool
play_dtmf
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
void
DoMerge
(
int16_t
*
decoded_buffer
size_t
decoded_length
AudioDecoder
:
:
SpeechType
speech_type
bool
play_dtmf
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DoExpand
(
bool
play_dtmf
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DoAccelerate
(
int16_t
*
decoded_buffer
size_t
decoded_length
AudioDecoder
:
:
SpeechType
speech_type
bool
play_dtmf
bool
fast_accelerate
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DoPreemptiveExpand
(
int16_t
*
decoded_buffer
size_t
decoded_length
AudioDecoder
:
:
SpeechType
speech_type
bool
play_dtmf
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DoRfc3389Cng
(
PacketList
*
packet_list
bool
play_dtmf
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
void
DoCodecInternalCng
(
const
int16_t
*
decoded_buffer
size_t
decoded_length
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DoDtmf
(
const
DtmfEvent
&
dtmf_event
bool
*
play_dtmf
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
void
DoAlternativePlc
(
bool
increase_timestamp
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
DtmfOverdub
(
const
DtmfEvent
&
dtmf_event
size_t
num_channels
int16_t
*
output
)
const
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
int
ExtractPackets
(
size_t
required_samples
PacketList
*
packet_list
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
void
SetSampleRateAndChannels
(
int
fs_hz
size_t
channels
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
OutputType
LastOutputType
(
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
virtual
void
UpdatePlcComponents
(
int
fs_hz
size_t
channels
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
virtual
void
CreateDecisionLogic
(
)
RTC_EXCLUSIVE_LOCKS_REQUIRED
(
crit_sect_
)
;
rtc
:
:
CriticalSection
crit_sect_
;
const
std
:
:
unique_ptr
<
TickTimer
>
tick_timer_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
BufferLevelFilter
>
buffer_level_filter_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
DecoderDatabase
>
decoder_database_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
DelayManager
>
delay_manager_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
DelayPeakDetector
>
delay_peak_detector_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
DtmfBuffer
>
dtmf_buffer_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
DtmfToneGenerator
>
dtmf_tone_generator_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
PacketBuffer
>
packet_buffer_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
RedPayloadSplitter
>
red_payload_splitter_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
TimestampScaler
>
timestamp_scaler_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
PostDecodeVad
>
vad_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
ExpandFactory
>
expand_factory_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
AccelerateFactory
>
accelerate_factory_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
std
:
:
unique_ptr
<
PreemptiveExpandFactory
>
preemptive_expand_factory_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
BackgroundNoise
>
background_noise_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
DecisionLogic
>
decision_logic_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
AudioMultiVector
>
algorithm_buffer_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
SyncBuffer
>
sync_buffer_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
Expand
>
expand_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
Normal
>
normal_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
Merge
>
merge_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
Accelerate
>
accelerate_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
PreemptiveExpand
>
preemptive_expand_
RTC_GUARDED_BY
(
crit_sect_
)
;
RandomVector
random_vector_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
ComfortNoise
>
comfort_noise_
RTC_GUARDED_BY
(
crit_sect_
)
;
Rtcp
rtcp_
RTC_GUARDED_BY
(
crit_sect_
)
;
StatisticsCalculator
stats_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
fs_hz_
RTC_GUARDED_BY
(
crit_sect_
)
;
int
fs_mult_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
atomic
<
int
>
last_output_sample_rate_hz_
;
size_t
output_size_samples_
RTC_GUARDED_BY
(
crit_sect_
)
;
size_t
decoder_frame_length_
RTC_GUARDED_BY
(
crit_sect_
)
;
Modes
last_mode_
RTC_GUARDED_BY
(
crit_sect_
)
;
Operations
last_operation_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
int16_t
[
]
>
mute_factor_array_
RTC_GUARDED_BY
(
crit_sect_
)
;
size_t
decoded_buffer_length_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
int16_t
[
]
>
decoded_buffer_
RTC_GUARDED_BY
(
crit_sect_
)
;
uint32_t
playout_timestamp_
RTC_GUARDED_BY
(
crit_sect_
)
;
bool
new_codec_
RTC_GUARDED_BY
(
crit_sect_
)
;
uint32_t
timestamp_
RTC_GUARDED_BY
(
crit_sect_
)
;
bool
reset_decoder_
RTC_GUARDED_BY
(
crit_sect_
)
;
rtc
:
:
Optional
<
uint8_t
>
current_rtp_payload_type_
RTC_GUARDED_BY
(
crit_sect_
)
;
rtc
:
:
Optional
<
uint8_t
>
current_cng_rtp_payload_type_
RTC_GUARDED_BY
(
crit_sect_
)
;
uint32_t
ssrc_
RTC_GUARDED_BY
(
crit_sect_
)
;
bool
first_packet_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
BackgroundNoiseMode
background_noise_mode_
RTC_GUARDED_BY
(
crit_sect_
)
;
NetEqPlayoutMode
playout_mode_
RTC_GUARDED_BY
(
crit_sect_
)
;
bool
enable_fast_accelerate_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
unique_ptr
<
NackTracker
>
nack_
RTC_GUARDED_BY
(
crit_sect_
)
;
bool
nack_enabled_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
bool
enable_muted_state_
RTC_GUARDED_BY
(
crit_sect_
)
;
AudioFrame
:
:
VADActivity
last_vad_activity_
RTC_GUARDED_BY
(
crit_sect_
)
=
AudioFrame
:
:
kVadPassive
;
std
:
:
unique_ptr
<
TickTimer
:
:
Stopwatch
>
generated_noise_stopwatch_
RTC_GUARDED_BY
(
crit_sect_
)
;
std
:
:
vector
<
uint32_t
>
last_decoded_timestamps_
RTC_GUARDED_BY
(
crit_sect_
)
;
const
bool
use_dtx_delay_fix_
RTC_GUARDED_BY
(
crit_sect_
)
;
private
:
RTC_DISALLOW_COPY_AND_ASSIGN
(
NetEqImpl
)
;
}
;
}
#
endif
