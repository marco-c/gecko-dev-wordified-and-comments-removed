#
include
"
modules
/
audio_coding
/
neteq
/
statistics_calculator
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
TEST
(
LifetimeStatistics
TotalSamplesReceived
)
{
StatisticsCalculator
stats
;
for
(
int
i
=
0
;
i
<
10
;
+
+
i
)
{
stats
.
IncreaseCounter
(
480
48000
)
;
}
EXPECT_EQ
(
10
*
480u
stats
.
GetLifetimeStatistics
(
)
.
total_samples_received
)
;
}
TEST
(
LifetimeStatistics
SamplesConcealed
)
{
StatisticsCalculator
stats
;
stats
.
ExpandedVoiceSamples
(
100
false
)
;
stats
.
ExpandedNoiseSamples
(
17
false
)
;
EXPECT_EQ
(
100u
+
17u
stats
.
GetLifetimeStatistics
(
)
.
concealed_samples
)
;
}
TEST
(
LifetimeStatistics
SamplesConcealedCorrection
)
{
StatisticsCalculator
stats
;
stats
.
ExpandedVoiceSamples
(
100
false
)
;
EXPECT_EQ
(
100u
stats
.
GetLifetimeStatistics
(
)
.
concealed_samples
)
;
stats
.
ExpandedVoiceSamplesCorrection
(
-
10
)
;
EXPECT_EQ
(
100u
stats
.
GetLifetimeStatistics
(
)
.
concealed_samples
)
;
stats
.
ExpandedVoiceSamplesCorrection
(
20
)
;
EXPECT_EQ
(
110u
stats
.
GetLifetimeStatistics
(
)
.
concealed_samples
)
;
stats
.
ExpandedVoiceSamplesCorrection
(
-
17
)
;
EXPECT_EQ
(
110u
stats
.
GetLifetimeStatistics
(
)
.
concealed_samples
)
;
stats
.
ExpandedVoiceSamples
(
100
false
)
;
EXPECT_EQ
(
110u
+
100u
-
17u
stats
.
GetLifetimeStatistics
(
)
.
concealed_samples
)
;
}
TEST
(
LifetimeStatistics
NoUpdateOnTimeStretch
)
{
StatisticsCalculator
stats
;
stats
.
ExpandedVoiceSamples
(
100
false
)
;
stats
.
AcceleratedSamples
(
4711
)
;
stats
.
PreemptiveExpandedSamples
(
17
)
;
stats
.
ExpandedVoiceSamples
(
100
false
)
;
EXPECT_EQ
(
200u
stats
.
GetLifetimeStatistics
(
)
.
concealed_samples
)
;
}
TEST
(
StatisticsCalculator
ExpandedSamplesCorrection
)
{
StatisticsCalculator
stats
;
NetEqNetworkStatistics
stats_output
;
constexpr
int
kSampleRateHz
=
48000
;
constexpr
int
k10MsSamples
=
kSampleRateHz
/
100
;
constexpr
int
kPacketSizeMs
=
20
;
constexpr
size_t
kSamplesPerPacket
=
kPacketSizeMs
*
kSampleRateHz
/
1000
;
constexpr
size_t
kNumSamplesInBuffer
=
2
*
kSamplesPerPacket
;
stats
.
IncreaseCounter
(
k10MsSamples
kSampleRateHz
)
;
stats
.
GetNetworkStatistics
(
kSampleRateHz
kNumSamplesInBuffer
kSamplesPerPacket
&
stats_output
)
;
EXPECT_EQ
(
0u
stats_output
.
expand_rate
)
;
EXPECT_EQ
(
0u
stats_output
.
speech_expand_rate
)
;
stats
.
ExpandedVoiceSamplesCorrection
(
-
100
)
;
stats
.
ExpandedNoiseSamplesCorrection
(
-
100
)
;
stats
.
IncreaseCounter
(
k10MsSamples
kSampleRateHz
)
;
stats
.
GetNetworkStatistics
(
kSampleRateHz
kNumSamplesInBuffer
kSamplesPerPacket
&
stats_output
)
;
EXPECT_EQ
(
0u
stats_output
.
expand_rate
)
;
EXPECT_EQ
(
0u
stats_output
.
speech_expand_rate
)
;
stats
.
ExpandedVoiceSamplesCorrection
(
50
)
;
stats
.
ExpandedNoiseSamplesCorrection
(
200
)
;
stats
.
IncreaseCounter
(
k10MsSamples
kSampleRateHz
)
;
stats
.
GetNetworkStatistics
(
kSampleRateHz
kNumSamplesInBuffer
kSamplesPerPacket
&
stats_output
)
;
EXPECT_EQ
(
(
(
50u
+
200u
)
<
<
14
)
/
k10MsSamples
stats_output
.
expand_rate
)
;
EXPECT_EQ
(
(
50u
<
<
14
)
/
k10MsSamples
stats_output
.
speech_expand_rate
)
;
}
}
