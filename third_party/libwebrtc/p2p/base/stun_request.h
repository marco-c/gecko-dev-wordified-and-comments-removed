#
ifndef
P2P_BASE_STUN_REQUEST_H_
#
define
P2P_BASE_STUN_REQUEST_H_
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
<
functional
>
#
include
<
map
>
#
include
<
memory
>
#
include
<
string
>
#
include
"
api
/
transport
/
stun
.
h
"
#
include
"
rtc_base
/
message_handler
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
namespace
cricket
{
class
StunRequest
;
const
int
kAllRequests
=
0
;
const
int
STUN_TOTAL_TIMEOUT
=
39750
;
class
StunRequestManager
{
public
:
StunRequestManager
(
rtc
:
:
Thread
*
thread
std
:
:
function
<
void
(
const
void
*
size_t
StunRequest
*
)
>
send_packet
)
;
~
StunRequestManager
(
)
;
void
Send
(
StunRequest
*
request
)
;
void
SendDelayed
(
StunRequest
*
request
int
delay
)
;
void
FlushForTest
(
int
msg_type
)
;
bool
HasRequestForTest
(
int
msg_type
)
;
void
Clear
(
)
;
bool
CheckResponse
(
StunMessage
*
msg
)
;
bool
CheckResponse
(
const
char
*
data
size_t
size
)
;
void
OnRequestTimedOut
(
StunRequest
*
request
)
;
bool
empty
(
)
const
;
rtc
:
:
Thread
*
network_thread
(
)
const
{
return
thread_
;
}
void
SendPacket
(
const
void
*
data
size_t
size
StunRequest
*
request
)
;
private
:
typedef
std
:
:
map
<
std
:
:
string
std
:
:
unique_ptr
<
StunRequest
>
>
RequestMap
;
rtc
:
:
Thread
*
const
thread_
;
RequestMap
requests_
RTC_GUARDED_BY
(
thread_
)
;
const
std
:
:
function
<
void
(
const
void
*
size_t
StunRequest
*
)
>
send_packet_
;
}
;
class
StunRequest
:
public
rtc
:
:
MessageHandler
{
public
:
explicit
StunRequest
(
StunRequestManager
&
manager
)
;
StunRequest
(
StunRequestManager
&
manager
std
:
:
unique_ptr
<
StunMessage
>
message
)
;
~
StunRequest
(
)
override
;
void
Construct
(
)
;
StunRequestManager
*
manager
(
)
{
return
&
manager_
;
}
const
std
:
:
string
&
id
(
)
const
{
return
msg_
-
>
transaction_id
(
)
;
}
uint32_t
reduced_transaction_id
(
)
const
{
return
msg_
-
>
reduced_transaction_id
(
)
;
}
int
type
(
)
;
const
StunMessage
*
msg
(
)
const
;
int
Elapsed
(
)
const
;
protected
:
friend
class
StunRequestManager
;
virtual
void
Prepare
(
StunMessage
*
message
)
{
}
virtual
void
OnResponse
(
StunMessage
*
response
)
{
}
virtual
void
OnErrorResponse
(
StunMessage
*
response
)
{
}
virtual
void
OnTimeout
(
)
{
}
virtual
void
OnSent
(
)
;
virtual
int
resend_delay
(
)
;
webrtc
:
:
TaskQueueBase
*
network_thread
(
)
const
{
return
manager_
.
network_thread
(
)
;
}
void
set_timed_out
(
)
;
private
:
void
OnMessage
(
rtc
:
:
Message
*
pmsg
)
override
;
StunRequestManager
&
manager_
;
const
std
:
:
unique_ptr
<
StunMessage
>
msg_
;
int64_t
tstamp_
RTC_GUARDED_BY
(
network_thread
(
)
)
;
int
count_
RTC_GUARDED_BY
(
network_thread
(
)
)
;
bool
timeout_
RTC_GUARDED_BY
(
network_thread
(
)
)
;
}
;
}
#
endif
