#
ifndef
P2P_BASE_CONNECTION_H_
#
define
P2P_BASE_CONNECTION_H_
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
functional
>
#
include
<
memory
>
#
include
<
optional
>
#
include
<
string
>
#
include
<
utility
>
#
include
<
vector
>
#
include
"
absl
/
functional
/
any_invocable
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
candidate
.
h
"
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
rtc_error
.
h
"
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
api
/
task_queue
/
task_queue_base
.
h
"
#
include
"
api
/
transport
/
stun
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
logging
/
rtc_event_log
/
events
/
rtc_event_ice_candidate_pair
.
h
"
#
include
"
logging
/
rtc_event_log
/
events
/
rtc_event_ice_candidate_pair_config
.
h
"
#
include
"
logging
/
rtc_event_log
/
ice_logger
.
h
"
#
include
"
p2p
/
base
/
candidate_pair_interface
.
h
"
#
include
"
p2p
/
base
/
connection_info
.
h
"
#
include
"
p2p
/
base
/
p2p_transport_channel_ice_field_trials
.
h
"
#
include
"
p2p
/
base
/
port_interface
.
h
"
#
include
"
p2p
/
base
/
stun_request
.
h
"
#
include
"
p2p
/
base
/
transport_description
.
h
"
#
include
"
p2p
/
dtls
/
dtls_stun_piggyback_callbacks
.
h
"
#
include
"
rtc_base
/
async_packet_socket
.
h
"
#
include
"
rtc_base
/
network
.
h
"
#
include
"
rtc_base
/
network
/
received_packet
.
h
"
#
include
"
rtc_base
/
numerics
/
event_based_exponential_moving_average
.
h
"
#
include
"
rtc_base
/
rate_tracker
.
h
"
#
include
"
rtc_base
/
system
/
rtc_export
.
h
"
#
include
"
rtc_base
/
third_party
/
sigslot
/
sigslot
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
#
include
"
rtc_base
/
weak_ptr
.
h
"
namespace
webrtc
{
constexpr
int
kGoogPingVersion
=
1
;
constexpr
int
kMaxStunBindingLength
=
1200
-
24
-
8
;
class
RTC_EXPORT
Connection
:
public
CandidatePairInterface
{
public
:
struct
SentPing
{
SentPing
(
absl
:
:
string_view
id
Timestamp
sent_time
uint32_t
nomination
)
:
id
(
id
)
sent_time
(
sent_time
)
nomination
(
nomination
)
{
}
std
:
:
string
id
;
Timestamp
sent_time
;
uint32_t
nomination
;
}
;
~
Connection
(
)
override
;
uint32_t
id
(
)
const
{
return
id_
;
}
TaskQueueBase
*
network_thread
(
)
const
;
const
Candidate
&
local_candidate
(
)
const
override
;
const
Candidate
&
remote_candidate
(
)
const
override
;
virtual
const
Network
*
network
(
)
const
;
virtual
int
generation
(
)
const
;
virtual
uint64_t
priority
(
)
const
;
enum
WriteState
{
STATE_WRITABLE
=
0
STATE_WRITE_UNRELIABLE
=
1
STATE_WRITE_INIT
=
2
STATE_WRITE_TIMEOUT
=
3
}
;
WriteState
write_state
(
)
const
;
bool
writable
(
)
const
;
bool
receiving
(
)
const
;
const
PortInterface
*
port
(
)
const
{
RTC_DCHECK_RUN_ON
(
network_thread_
)
;
return
port_
.
get
(
)
;
}
bool
connected
(
)
const
;
bool
weak
(
)
const
;
bool
active
(
)
const
;
bool
pending_delete
(
)
const
{
RTC_DCHECK_RUN_ON
(
network_thread_
)
;
return
!
port_
;
}
bool
dead
(
Timestamp
now
)
const
;
int
rtt
(
)
const
{
return
Rtt
(
)
.
ms
(
)
;
}
TimeDelta
Rtt
(
)
const
;
TimeDelta
UnwritableTimeout
(
)
const
;
void
set_unwritable_timeout
(
const
std
:
:
optional
<
int
>
&
value_ms
)
{
if
(
value_ms
.
has_value
(
)
)
{
SetUnwritableTimeout
(
TimeDelta
:
:
Millis
(
*
value_ms
)
)
;
}
else
{
SetUnwritableTimeout
(
std
:
:
nullopt
)
;
}
}
void
SetUnwritableTimeout
(
std
:
:
optional
<
TimeDelta
>
value
)
;
int
unwritable_min_checks
(
)
const
;
void
set_unwritable_min_checks
(
const
std
:
:
optional
<
int
>
&
value
)
;
void
set_inactive_timeout
(
const
std
:
:
optional
<
int
>
&
value
)
{
if
(
value
.
has_value
(
)
)
{
SetInactiveTimeout
(
TimeDelta
:
:
Millis
(
*
value
)
)
;
}
else
{
SetInactiveTimeout
(
std
:
:
nullopt
)
;
}
}
TimeDelta
InactiveTimeout
(
)
const
;
void
SetInactiveTimeout
(
std
:
:
optional
<
TimeDelta
>
value
)
;
ConnectionInfo
stats
(
)
;
sigslot
:
:
signal1
<
Connection
*
>
SignalStateChange
;
sigslot
:
:
signal1
<
Connection
*
>
SignalDestroyed
;
virtual
int
Send
(
const
void
*
data
size_t
size
const
AsyncSocketPacketOptions
&
options
)
=
0
;
virtual
int
GetError
(
)
=
0
;
void
RegisterReceivedPacketCallback
(
absl
:
:
AnyInvocable
<
void
(
Connection
*
const
ReceivedIpPacket
&
)
>
received_packet_callback
)
;
void
DeregisterReceivedPacketCallback
(
)
;
sigslot
:
:
signal1
<
Connection
*
>
SignalReadyToSend
;
void
OnReadPacket
(
const
ReceivedIpPacket
&
packet
)
;
[
[
deprecated
(
"
Pass
a
ReceivedIpPacket
"
)
]
]
void
OnReadPacket
(
const
char
*
data
size_t
size
int64_t
packet_time_us
)
;
void
OnReadyToSend
(
)
;
bool
pruned
(
)
const
;
void
Prune
(
)
;
bool
use_candidate_attr
(
)
const
;
void
set_use_candidate_attr
(
bool
enable
)
;
void
set_nomination
(
uint32_t
value
)
;
uint32_t
remote_nomination
(
)
const
;
bool
nominated
(
)
const
;
TimeDelta
ReceivingTimeout
(
)
const
;
void
set_receiving_timeout
(
std
:
:
optional
<
int
>
receiving_timeout_ms
)
{
if
(
receiving_timeout_ms
.
has_value
(
)
)
{
SetReceivingTimeout
(
TimeDelta
:
:
Millis
(
*
receiving_timeout_ms
)
)
;
}
else
{
SetReceivingTimeout
(
std
:
:
nullopt
)
;
}
}
void
SetReceivingTimeout
(
std
:
:
optional
<
TimeDelta
>
receiving_timeout
)
;
void
Destroy
(
)
;
bool
Shutdown
(
)
;
void
FailAndPrune
(
)
;
void
UpdateState
(
int64_t
now
)
{
UpdateState
(
Timestamp
:
:
Millis
(
now
)
)
;
}
void
UpdateState
(
Timestamp
now
)
;
void
UpdateLocalIceParameters
(
int
component
absl
:
:
string_view
username_fragment
absl
:
:
string_view
password
)
;
int64_t
last_ping_sent
(
)
const
{
return
LastPingSent
(
)
.
ms
(
)
;
}
Timestamp
LastPingSent
(
)
const
;
void
Ping
(
int64_t
now
std
:
:
unique_ptr
<
StunByteStringAttribute
>
delta
=
nullptr
)
{
Ping
(
Timestamp
:
:
Millis
(
now
)
std
:
:
move
(
delta
)
)
;
}
void
Ping
(
)
;
void
Ping
(
Timestamp
now
std
:
:
unique_ptr
<
StunByteStringAttribute
>
delta
=
nullptr
)
;
void
ReceivedPingResponse
(
int
rtt
absl
:
:
string_view
request_id
const
std
:
:
optional
<
uint32_t
>
&
nomination
=
std
:
:
nullopt
)
{
ReceivedPingResponse
(
TimeDelta
:
:
Millis
(
rtt
)
request_id
nomination
)
;
}
void
ReceivedPingResponse
(
TimeDelta
rtt
absl
:
:
string_view
request_id
const
std
:
:
optional
<
uint32_t
>
&
nomination
=
std
:
:
nullopt
)
;
std
:
:
unique_ptr
<
IceMessage
>
BuildPingRequest
(
std
:
:
unique_ptr
<
StunByteStringAttribute
>
delta
)
RTC_RUN_ON
(
network_thread_
)
;
int64_t
last_ping_response_received
(
)
const
{
return
LastPingResponseReceived
(
)
.
ms
(
)
;
}
Timestamp
LastPingResponseReceived
(
)
const
;
const
std
:
:
optional
<
std
:
:
string
>
&
last_ping_id_received
(
)
const
;
int
rtt_samples
(
)
const
;
int64_t
last_ping_received
(
)
const
{
return
LastPingReceived
(
)
.
ms
(
)
;
}
Timestamp
LastPingReceived
(
)
const
;
void
ReceivedPing
(
const
std
:
:
optional
<
std
:
:
string
>
&
request_id
=
std
:
:
nullopt
)
;
void
HandleStunBindingOrGoogPingRequest
(
IceMessage
*
msg
)
;
void
HandlePiggybackCheckAcknowledgementIfAny
(
StunMessage
*
msg
)
;
Timestamp
LastSendData
(
)
const
;
int64_t
last_data_received
(
)
const
{
return
LastDataReceived
(
)
.
ms
(
)
;
}
Timestamp
LastDataReceived
(
)
const
;
std
:
:
string
ToDebugId
(
)
const
;
std
:
:
string
ToString
(
)
const
;
std
:
:
string
ToSensitiveString
(
)
const
;
const
IceCandidatePairDescription
&
ToLogDescription
(
)
;
void
set_ice_event_log
(
IceEventLog
*
ice_event_log
)
;
void
PrintPingsSinceLastResponse
(
std
:
:
string
*
pings
size_t
max
)
;
bool
selected
(
)
const
;
void
set_selected
(
bool
selected
)
;
sigslot
:
:
signal1
<
Connection
*
>
SignalNominated
;
IceCandidatePairState
state
(
)
const
;
int
num_pings_sent
(
)
const
;
uint32_t
ComputeNetworkCost
(
)
const
;
void
MaybeSetRemoteIceParametersAndGeneration
(
const
IceParameters
&
params
int
generation
)
;
void
MaybeUpdatePeerReflexiveCandidate
(
const
Candidate
&
new_candidate
)
;
Timestamp
LastReceived
(
)
const
;
int64_t
receiving_unchanged_since
(
)
const
{
return
ReceivingUnchangedSince
(
)
.
ms
(
)
;
}
Timestamp
ReceivingUnchangedSince
(
)
const
;
uint32_t
prflx_priority
(
)
const
;
bool
stable
(
int64_t
now
)
const
{
return
stable
(
Timestamp
:
:
Millis
(
now
)
)
;
}
bool
stable
(
Timestamp
now
)
const
;
bool
TooManyOutstandingPings
(
const
std
:
:
optional
<
int
>
&
val
)
const
;
void
SetLocalCandidateNetworkCost
(
uint16_t
cost
)
;
void
SetIceFieldTrials
(
const
IceFieldTrials
*
field_trials
)
;
const
EventBasedExponentialMovingAverage
&
GetRttEstimate
(
)
const
{
return
rtt_estimate_
;
}
void
ForgetLearnedState
(
)
;
void
SendStunBindingResponse
(
const
StunMessage
*
message
)
;
void
SendGoogPingResponse
(
const
StunMessage
*
message
)
;
void
SendResponseMessage
(
const
StunMessage
&
response
)
;
PortInterface
*
PortForTest
(
)
{
RTC_DCHECK_RUN_ON
(
network_thread_
)
;
return
port_
.
get
(
)
;
}
const
PortInterface
*
PortForTest
(
)
const
{
RTC_DCHECK_RUN_ON
(
network_thread_
)
;
return
port_
.
get
(
)
;
}
std
:
:
unique_ptr
<
IceMessage
>
BuildPingRequestForTest
(
)
{
RTC_DCHECK_RUN_ON
(
network_thread_
)
;
return
BuildPingRequest
(
nullptr
)
;
}
uint32_t
acked_nomination
(
)
const
;
void
set_remote_nomination
(
uint32_t
remote_nomination
)
;
const
std
:
:
string
&
remote_password_for_test
(
)
const
{
return
remote_candidate
(
)
.
password
(
)
;
}
void
set_remote_password_for_test
(
absl
:
:
string_view
pwd
)
{
remote_candidate_
.
set_password
(
pwd
)
;
}
void
SetStunDictConsumer
(
std
:
:
function
<
std
:
:
unique_ptr
<
StunAttribute
>
(
const
StunByteStringAttribute
*
)
>
goog_delta_consumer
std
:
:
function
<
void
(
RTCErrorOr
<
const
StunUInt64Attribute
*
>
)
>
goog_delta_ack_consumer
)
{
goog_delta_consumer_
=
std
:
:
move
(
goog_delta_consumer
)
;
goog_delta_ack_consumer_
=
std
:
:
move
(
goog_delta_ack_consumer
)
;
}
void
ClearStunDictConsumer
(
)
{
goog_delta_consumer_
=
std
:
:
nullopt
;
goog_delta_ack_consumer_
=
std
:
:
nullopt
;
}
void
RegisterDtlsPiggyback
(
DtlsStunPiggybackCallbacks
&
&
callbacks
)
{
dtls_stun_piggyback_callbacks_
=
std
:
:
move
(
callbacks
)
;
}
void
DeregisterDtlsPiggyback
(
)
{
dtls_stun_piggyback_callbacks_
.
reset
(
)
;
}
static
constexpr
Timestamp
AlignTime
(
Timestamp
time
)
{
return
Timestamp
:
:
Millis
(
time
.
us
(
)
/
1000
)
;
}
protected
:
class
ConnectionRequest
;
Connection
(
const
Environment
&
env
WeakPtr
<
PortInterface
>
port
size_t
index
const
Candidate
&
candidate
)
;
void
OnSendStunPacket
(
const
void
*
data
size_t
size
StunRequest
*
req
)
;
virtual
void
OnConnectionRequestResponse
(
StunRequest
*
req
StunMessage
*
response
)
;
void
OnConnectionRequestErrorResponse
(
ConnectionRequest
*
req
StunMessage
*
response
)
RTC_RUN_ON
(
network_thread_
)
;
void
OnConnectionRequestTimeout
(
ConnectionRequest
*
req
)
RTC_RUN_ON
(
network_thread_
)
;
void
OnConnectionRequestSent
(
ConnectionRequest
*
req
)
RTC_RUN_ON
(
network_thread_
)
;
bool
rtt_converged
(
)
const
;
bool
missing_responses
(
Timestamp
now
)
const
;
void
set_write_state
(
WriteState
value
)
;
void
UpdateReceiving
(
Timestamp
now
)
;
void
set_state
(
IceCandidatePairState
state
)
;
void
set_connected
(
bool
value
)
;
PortInterface
*
port
(
)
{
RTC_DCHECK_RUN_ON
(
network_thread_
)
;
return
port_
.
get
(
)
;
}
const
Environment
&
env
(
)
{
return
env_
;
}
ConnectionInfo
&
mutable_stats
(
)
{
return
stats_
;
}
RateTracker
&
send_rate_tracker
(
)
{
return
send_rate_tracker_
;
}
void
set_last_send_data
(
Timestamp
now
)
{
last_send_data_
=
AlignTime
(
now
)
;
}
private
:
void
MaybeUpdateLocalCandidate
(
StunRequest
*
request
StunMessage
*
response
)
RTC_RUN_ON
(
network_thread_
)
;
void
LogCandidatePairConfig
(
IceCandidatePairConfigType
type
)
RTC_RUN_ON
(
network_thread_
)
;
void
LogCandidatePairEvent
(
IceCandidatePairEventType
type
uint32_t
transaction_id
)
RTC_RUN_ON
(
network_thread_
)
;
bool
ShouldSendGoogPing
(
const
StunMessage
*
message
)
RTC_RUN_ON
(
network_thread_
)
;
const
Environment
env_
;
TaskQueueBase
*
const
network_thread_
;
const
uint32_t
id_
;
WeakPtr
<
PortInterface
>
port_
RTC_GUARDED_BY
(
network_thread_
)
;
Candidate
local_candidate_
RTC_GUARDED_BY
(
network_thread_
)
;
Candidate
remote_candidate_
;
ConnectionInfo
stats_
;
RateTracker
recv_rate_tracker_
;
RateTracker
send_rate_tracker_
;
Timestamp
last_send_data_
;
WriteState
write_state_
RTC_GUARDED_BY
(
network_thread_
)
;
bool
receiving_
RTC_GUARDED_BY
(
network_thread_
)
;
bool
connected_
RTC_GUARDED_BY
(
network_thread_
)
;
bool
pruned_
RTC_GUARDED_BY
(
network_thread_
)
;
bool
selected_
RTC_GUARDED_BY
(
network_thread_
)
=
false
;
bool
use_candidate_attr_
RTC_GUARDED_BY
(
network_thread_
)
;
uint32_t
nomination_
RTC_GUARDED_BY
(
network_thread_
)
=
0
;
uint32_t
acked_nomination_
RTC_GUARDED_BY
(
network_thread_
)
=
0
;
uint32_t
remote_nomination_
RTC_GUARDED_BY
(
network_thread_
)
=
0
;
StunRequestManager
requests_
RTC_GUARDED_BY
(
network_thread_
)
;
TimeDelta
rtt_
RTC_GUARDED_BY
(
network_thread_
)
;
int
rtt_samples_
RTC_GUARDED_BY
(
network_thread_
)
=
0
;
TimeDelta
total_round_trip_time_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
optional
<
TimeDelta
>
current_round_trip_time_
RTC_GUARDED_BY
(
network_thread_
)
;
Timestamp
last_ping_sent_
RTC_GUARDED_BY
(
network_thread_
)
;
Timestamp
last_ping_received_
RTC_GUARDED_BY
(
network_thread_
)
;
Timestamp
last_data_received_
RTC_GUARDED_BY
(
network_thread_
)
;
Timestamp
last_ping_response_received_
RTC_GUARDED_BY
(
network_thread_
)
;
Timestamp
receiving_unchanged_since_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
vector
<
SentPing
>
pings_since_last_response_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
optional
<
std
:
:
string
>
last_ping_id_received_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
optional
<
TimeDelta
>
unwritable_timeout_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
optional
<
int
>
unwritable_min_checks_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
optional
<
TimeDelta
>
inactive_timeout_
RTC_GUARDED_BY
(
network_thread_
)
;
IceCandidatePairState
state_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
optional
<
TimeDelta
>
receiving_timeout_
RTC_GUARDED_BY
(
network_thread_
)
;
const
Timestamp
time_created_
RTC_GUARDED_BY
(
network_thread_
)
;
const
TimeDelta
delta_internal_unix_epoch_
RTC_GUARDED_BY
(
network_thread_
)
;
int
num_pings_sent_
RTC_GUARDED_BY
(
network_thread_
)
=
0
;
std
:
:
optional
<
IceCandidatePairDescription
>
log_description_
RTC_GUARDED_BY
(
network_thread_
)
;
IceEventLog
*
ice_event_log_
RTC_GUARDED_BY
(
network_thread_
)
=
nullptr
;
std
:
:
optional
<
bool
>
remote_support_goog_ping_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
unique_ptr
<
StunMessage
>
cached_stun_binding_
RTC_GUARDED_BY
(
network_thread_
)
;
const
IceFieldTrials
*
field_trials_
;
EventBasedExponentialMovingAverage
rtt_estimate_
RTC_GUARDED_BY
(
network_thread_
)
;
std
:
:
optional
<
std
:
:
function
<
std
:
:
unique_ptr
<
StunAttribute
>
(
const
StunByteStringAttribute
*
)
>
>
goog_delta_consumer_
;
std
:
:
optional
<
std
:
:
function
<
void
(
RTCErrorOr
<
const
StunUInt64Attribute
*
>
)
>
>
goog_delta_ack_consumer_
;
absl
:
:
AnyInvocable
<
void
(
Connection
*
const
ReceivedIpPacket
&
)
>
received_packet_callback_
;
void
MaybeAddDtlsPiggybackingAttributes
(
StunMessage
*
msg
)
;
void
MaybeHandleDtlsPiggybackingAttributes
(
const
StunMessage
*
msg
const
StunRequest
*
original_request
)
;
DtlsStunPiggybackCallbacks
dtls_stun_piggyback_callbacks_
;
}
;
class
ProxyConnection
:
public
Connection
{
public
:
ProxyConnection
(
const
Environment
&
env
WeakPtr
<
PortInterface
>
port
size_t
index
const
Candidate
&
remote_candidate
)
;
int
Send
(
const
void
*
data
size_t
size
const
AsyncSocketPacketOptions
&
options
)
override
;
int
GetError
(
)
override
;
private
:
int
error_
=
0
;
}
;
}
#
endif
