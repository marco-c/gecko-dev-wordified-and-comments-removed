#
include
"
test
/
network
/
simulated_network
.
h
"
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
memory
>
#
include
<
optional
>
#
include
<
utility
>
#
include
<
vector
>
#
include
"
api
/
test
/
network_emulation
/
leaky_bucket_network_queue
.
h
"
#
include
"
api
/
test
/
simulated_network
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
data_size
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
using
:
:
testing
:
:
ElementsAre
;
using
:
:
testing
:
:
Field
;
using
:
:
testing
:
:
MockFunction
;
using
:
:
testing
:
:
SizeIs
;
using
:
:
testing
:
:
UnorderedElementsAre
;
PacketInFlightInfo
PacketWithSize
(
size_t
size
)
{
return
PacketInFlightInfo
(
size
0
1
)
;
}
TEST
(
SimulatedNetworkTest
NextDeliveryTimeIsUnknownOnEmptyNetwork
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
}
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
std
:
:
nullopt
)
;
}
TEST
(
SimulatedNetworkTest
EnqueueFirstPacketOnNetworkWithInfiniteCapacity
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketWithSize
(
1
'
000
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
0
)
;
}
TEST
(
SimulatedNetworkTest
EnqueueFirstPacketOnNetworkWithLimitedCapacity
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketWithSize
(
125
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
}
TEST
(
SimulatedNetworkTest
EnqueuePacketsButNextDeliveryIsBasedOnFirstEnqueuedPacket
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
100
2
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
2
)
.
us
(
)
3
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
}
TEST
(
SimulatedNetworkTest
EnqueueFailsWhenQueueLengthIsReached
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
queue_length_packets
=
1
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
EXPECT_FALSE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
0
.
5
)
.
us
(
)
2
)
)
)
;
EXPECT_FALSE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
2
)
.
us
(
)
3
)
)
)
;
}
TEST
(
SimulatedNetworkTest
CanChangeQueueLength
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
2
)
)
)
;
network
.
SetConfig
(
{
.
queue_length_packets
=
1
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
EXPECT_FALSE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
3
)
)
)
;
}
TEST
(
SimulatedNetworkTest
PacketOverhead
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
.
packet_overhead
=
125
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketWithSize
(
125
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
2
)
.
us
(
)
)
;
}
TEST
(
SimulatedNetworkTest
DequeueDeliverablePacketsLeavesPacketsInCapacityLink
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
2
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
packet_id
1ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
receive_time_us
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
2
)
.
us
(
)
)
;
}
TEST
(
SimulatedNetworkTest
DequeueDeliverablePacketsAppliesConfigChangesToCapacityLink
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
const
PacketInFlightInfo
packet_1
=
PacketInFlightInfo
(
125
0
1
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
packet_1
)
)
;
PacketInFlightInfo
packet_2
=
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
2
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
packet_2
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
network
.
SetConfig
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
10
)
}
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Millis
(
100
)
.
us
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
EXPECT_THAT
(
delivered_packets
ElementsAre
(
PacketDeliveryInfo
(
packet_1
TimeDelta
:
:
Millis
(
100
)
.
us
(
)
)
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
1100
)
.
us
(
)
)
;
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Millis
(
1100
)
.
us
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
EXPECT_THAT
(
delivered_packets
ElementsAre
(
PacketDeliveryInfo
(
packet_2
TimeDelta
:
:
Millis
(
1100
)
.
us
(
)
)
)
)
;
}
TEST
(
SimulatedNetworkTest
SetConfigUpdateNextDeliveryTimeIfLinkCapacityChange
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
MockFunction
<
void
(
)
>
delivery_time_changed_callback
;
network
.
RegisterDeliveryTimeChangedCallback
(
delivery_time_changed_callback
.
AsStdFunction
(
)
)
;
const
PacketInFlightInfo
packet_1
=
PacketInFlightInfo
(
125
0
1
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
packet_1
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
EXPECT_CALL
(
delivery_time_changed_callback
Call
)
.
WillOnce
(
[
&
]
(
)
{
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
500
+
50
)
.
us
(
)
)
;
}
)
;
network
.
SetConfig
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
10
)
}
Timestamp
:
:
Millis
(
500
)
)
;
}
TEST
(
SimulatedNetworkTest
SetConfigUpdateNextDeliveryTimeIfLinkCapacityChangeFromZero
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
Zero
(
)
}
)
;
MockFunction
<
void
(
)
>
delivery_time_changed_callback
;
network
.
RegisterDeliveryTimeChangedCallback
(
delivery_time_changed_callback
.
AsStdFunction
(
)
)
;
const
PacketInFlightInfo
packet_1
=
PacketInFlightInfo
(
125
0
1
)
;
const
PacketInFlightInfo
packet_2
=
PacketInFlightInfo
(
125
0
2
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
packet_1
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
packet_2
)
)
;
EXPECT_FALSE
(
network
.
NextDeliveryTimeUs
(
)
.
has_value
(
)
)
;
:
:
testing
:
:
Sequence
s
;
EXPECT_CALL
(
delivery_time_changed_callback
Call
)
.
InSequence
(
s
)
.
WillOnce
(
[
&
]
(
)
{
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
500
+
100
)
.
us
(
)
)
;
}
)
;
EXPECT_CALL
(
delivery_time_changed_callback
Call
)
.
InSequence
(
s
)
.
WillOnce
(
[
&
]
(
)
{
EXPECT_FALSE
(
network
.
NextDeliveryTimeUs
(
)
.
has_value
(
)
)
;
}
)
;
EXPECT_CALL
(
delivery_time_changed_callback
Call
)
.
InSequence
(
s
)
.
WillOnce
(
[
&
]
(
)
{
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
610
+
90
)
.
us
(
)
)
;
}
)
;
network
.
SetConfig
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
10
)
}
Timestamp
:
:
Millis
(
500
)
)
;
network
.
SetConfig
(
{
.
link_capacity
=
DataRate
:
:
Zero
(
)
}
Timestamp
:
:
Millis
(
510
)
)
;
network
.
SetConfig
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
10
)
}
Timestamp
:
:
Millis
(
610
)
)
;
}
TEST
(
SimulatedNetworkTest
SetConfigUpdateQueueDelayAfterDelivery
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
queue_delay_ms
=
1000
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1000
)
}
)
;
MockFunction
<
void
(
)
>
delivery_time_changed_callback
;
network
.
RegisterDeliveryTimeChangedCallback
(
delivery_time_changed_callback
.
AsStdFunction
(
)
)
;
EXPECT_CALL
(
delivery_time_changed_callback
Call
)
.
Times
(
0
)
;
const
PacketInFlightInfo
packet_1
=
PacketInFlightInfo
(
125
0
1
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
packet_1
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
1
)
.
us
(
)
)
;
EXPECT_TRUE
(
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Millis
(
1
)
.
us
(
)
)
.
empty
(
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
1000
+
1
)
.
us
(
)
)
;
network
.
SetConfig
(
{
.
queue_delay_ms
=
1
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
100
)
}
Timestamp
:
:
Millis
(
500
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
1000
+
1
)
.
us
(
)
)
;
const
PacketInFlightInfo
packet_2
=
PacketInFlightInfo
(
125
TimeDelta
:
:
Millis
(
500
)
.
us
(
)
2
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
packet_2
)
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
1000
+
1
)
.
us
(
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Millis
(
1000
+
1
)
.
us
(
)
)
;
ASSERT_THAT
(
delivered_packets
SizeIs
(
2
)
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
receive_time_us
delivered_packets
[
1
]
.
receive_time_us
)
;
}
TEST
(
SimulatedNetworkTest
NetworkEmptyAfterLastPacketDequeued
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketWithSize
(
125
)
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
std
:
:
nullopt
)
;
}
TEST
(
SimulatedNetworkTest
DequeueDeliverablePacketsOnLateCall
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
2
)
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
3
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
2ul
)
;
}
TEST
(
SimulatedNetworkTest
DequeueDeliverablePacketsOnEarlyCallReturnsNoPackets
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketWithSize
(
125
)
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
0
.
5
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
0ul
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
}
TEST
(
SimulatedNetworkTest
QueueDelayMsWithoutStandardDeviation
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
queue_delay_ms
=
100
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketWithSize
(
125
)
)
)
;
ASSERT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
0ul
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Millis
(
1100
)
.
us
(
)
)
;
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Millis
(
1100
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
}
TEST
(
SimulatedNetworkTest
QueueDelayMsWithStandardDeviationAndReorderNotAllowed
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
queue_delay_ms
=
100
.
delay_standard_deviation_ms
=
90
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
.
allow_reordering
=
false
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
2
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
3
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
4
)
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
5
)
.
us
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
4ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
packet_id
1ul
)
;
EXPECT_EQ
(
delivered_packets
[
1
]
.
packet_id
2ul
)
;
EXPECT_GE
(
delivered_packets
[
1
]
.
receive_time_us
delivered_packets
[
0
]
.
receive_time_us
)
;
EXPECT_EQ
(
delivered_packets
[
2
]
.
packet_id
3ul
)
;
EXPECT_GE
(
delivered_packets
[
2
]
.
receive_time_us
delivered_packets
[
1
]
.
receive_time_us
)
;
EXPECT_EQ
(
delivered_packets
[
3
]
.
packet_id
4ul
)
;
EXPECT_GE
(
delivered_packets
[
3
]
.
receive_time_us
delivered_packets
[
2
]
.
receive_time_us
)
;
}
TEST
(
SimulatedNetworkTest
QueueDelayMsWithStandardDeviationAndReorderAllowed
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
queue_delay_ms
=
100
.
delay_standard_deviation_ms
=
90
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
.
allow_reordering
=
true
}
1
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
2
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
3
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
4
)
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
5
)
.
us
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
4ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
packet_id
3ul
)
;
EXPECT_EQ
(
delivered_packets
[
1
]
.
packet_id
1ul
)
;
EXPECT_GE
(
delivered_packets
[
1
]
.
receive_time_us
delivered_packets
[
0
]
.
receive_time_us
)
;
EXPECT_EQ
(
delivered_packets
[
2
]
.
packet_id
2ul
)
;
EXPECT_GE
(
delivered_packets
[
2
]
.
receive_time_us
delivered_packets
[
1
]
.
receive_time_us
)
;
EXPECT_EQ
(
delivered_packets
[
3
]
.
packet_id
4ul
)
;
EXPECT_GE
(
delivered_packets
[
3
]
.
receive_time_us
delivered_packets
[
2
]
.
receive_time_us
)
;
}
TEST
(
SimulatedNetworkTest
PacketLoss
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
loss_percent
=
50
}
1
)
;
for
(
int
i
=
0
;
i
<
8
;
i
+
+
)
{
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
i
+
1
)
)
)
;
}
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
5
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
8ul
)
;
int
lost_packets
=
0
;
for
(
const
auto
&
packet
:
delivered_packets
)
{
if
(
packet
.
receive_time_us
=
=
PacketDeliveryInfo
:
:
kNotReceived
)
{
lost_packets
+
+
;
}
}
EXPECT_EQ
(
lost_packets
4
)
;
}
TEST
(
SimulatedNetworkTest
NextDeliveryTimeSetAfterLostPackets
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
queue_delay_ms
=
10
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1000
)
.
loss_percent
=
50
}
1
)
;
for
(
int
i
=
0
;
i
<
8
;
i
+
+
)
{
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
i
+
1
)
)
)
;
}
int64_t
time_us
=
0
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
;
while
(
delivered_packets
.
size
(
)
!
=
8
)
{
ASSERT_TRUE
(
network
.
NextDeliveryTimeUs
(
)
.
has_value
(
)
)
;
time_us
=
*
network
.
NextDeliveryTimeUs
(
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
packets
=
network
.
DequeueDeliverablePackets
(
time_us
)
;
delivered_packets
.
insert
(
delivered_packets
.
end
(
)
packets
.
begin
(
)
packets
.
end
(
)
)
;
}
int
lost_packets
=
0
;
int
received_packets
=
0
;
for
(
const
auto
&
packet
:
delivered_packets
)
{
if
(
packet
.
receive_time_us
=
=
PacketDeliveryInfo
:
:
kNotReceived
)
{
lost_packets
+
+
;
}
else
{
received_packets
+
+
;
}
}
EXPECT_EQ
(
delivered_packets
.
back
(
)
.
receive_time_us
Timestamp
:
:
Millis
(
10
+
8
)
.
us
(
)
)
;
EXPECT_EQ
(
lost_packets
4
)
;
EXPECT_EQ
(
received_packets
4
)
;
}
TEST
(
SimulatedNetworkTest
PacketLossBurst
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
loss_percent
=
50
.
avg_burst_loss_length
=
100
}
1
)
;
for
(
int
i
=
0
;
i
<
20
;
i
+
+
)
{
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
1
0
i
+
1
)
)
)
;
}
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
5
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
20ul
)
;
int
num_lost_packets
=
0
;
for
(
const
auto
&
packet
:
delivered_packets
)
{
if
(
packet
.
receive_time_us
=
=
PacketDeliveryInfo
:
:
kNotReceived
)
{
num_lost_packets
+
+
;
}
if
(
num_lost_packets
>
0
)
{
EXPECT_EQ
(
packet
.
receive_time_us
PacketDeliveryInfo
:
:
kNotReceived
)
;
}
}
EXPECT_GT
(
num_lost_packets
5
)
;
}
TEST
(
SimulatedNetworkTest
PauseTransmissionUntil
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
1
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
2
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
3
)
)
)
;
ASSERT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
network
.
PauseTransmissionUntil
(
TimeDelta
:
:
Seconds
(
5
)
.
us
(
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
0ul
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
5
)
.
us
(
)
)
;
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
5
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
EXPECT_EQ
(
network
.
NextDeliveryTimeUs
(
)
TimeDelta
:
:
Seconds
(
6
)
.
us
(
)
)
;
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
7
)
.
us
(
)
)
;
EXPECT_EQ
(
delivered_packets
.
size
(
)
2ul
)
;
}
TEST
(
SimulatedNetworkTest
CongestedNetworkRespectsLinkCapacity
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
for
(
size_t
i
=
0
;
i
<
1
'
000
;
+
+
i
)
{
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
0
i
)
)
)
;
}
PacketDeliveryInfo
last_delivered_packet
{
PacketInFlightInfo
(
0
0
0
)
0
}
;
while
(
network
.
NextDeliveryTimeUs
(
)
.
has_value
(
)
)
{
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
network
.
NextDeliveryTimeUs
(
)
.
value
(
)
)
;
if
(
!
delivered_packets
.
empty
(
)
)
{
last_delivered_packet
=
delivered_packets
.
back
(
)
;
}
}
EXPECT_EQ
(
last_delivered_packet
.
receive_time_us
TimeDelta
:
:
Seconds
(
1000
)
.
us
(
)
)
;
EXPECT_EQ
(
last_delivered_packet
.
packet_id
999ul
)
;
}
TEST
(
SimulatedNetworkTest
EnqueuePacketWithSubSecondNonMonotonicBehaviour
)
{
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
0
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
125
TimeDelta
:
:
Seconds
(
1
)
.
us
(
)
-
1
1
)
)
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
2
)
.
us
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
packet_id
0ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
receive_time_us
TimeDelta
:
:
Seconds
(
2
)
.
us
(
)
)
;
delivered_packets
=
network
.
DequeueDeliverablePackets
(
TimeDelta
:
:
Seconds
(
3
)
.
us
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
1ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
packet_id
1ul
)
;
EXPECT_EQ
(
delivered_packets
[
0
]
.
receive_time_us
TimeDelta
:
:
Seconds
(
3
)
.
us
(
)
)
;
}
TEST
(
SimulatedNetworkTest
CanUseInjectedQueueAndDropPacketsAtQueueHead
)
{
auto
queue
=
std
:
:
make_unique
<
LeakyBucketNetworkQueue
>
(
)
;
LeakyBucketNetworkQueue
*
queue_ptr
=
queue
.
get
(
)
;
SimulatedNetwork
network
=
SimulatedNetwork
(
{
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1
)
}
1
std
:
:
move
(
queue
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
DataSize
:
:
Bytes
(
125
)
Timestamp
:
:
Seconds
(
1
)
0
)
)
)
;
ASSERT_TRUE
(
network
.
EnqueuePacket
(
PacketInFlightInfo
(
DataSize
:
:
Bytes
(
125
)
Timestamp
:
:
Seconds
(
1
)
1
)
)
)
;
queue_ptr
-
>
DropOldestPacket
(
)
;
std
:
:
vector
<
PacketDeliveryInfo
>
delivered_packets
=
network
.
DequeueDeliverablePackets
(
network
.
NextDeliveryTimeUs
(
)
.
value
(
)
)
;
ASSERT_EQ
(
delivered_packets
.
size
(
)
2ul
)
;
EXPECT_THAT
(
delivered_packets
UnorderedElementsAre
(
Field
(
&
PacketDeliveryInfo
:
:
packet_id
0
)
AllOf
(
Field
(
&
PacketDeliveryInfo
:
:
packet_id
1
)
Field
(
&
PacketDeliveryInfo
:
:
receive_time_us
PacketDeliveryInfo
:
:
kNotReceived
)
)
)
)
;
}
}
}
