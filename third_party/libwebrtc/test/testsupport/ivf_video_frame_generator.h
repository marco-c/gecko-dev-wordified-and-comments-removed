#
ifndef
TEST_TESTSUPPORT_IVF_VIDEO_FRAME_GENERATOR_H_
#
define
TEST_TESTSUPPORT_IVF_VIDEO_FRAME_GENERATOR_H_
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
memory
>
#
include
<
optional
>
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
test
/
frame_generator_interface
.
h
"
#
include
"
api
/
video
/
video_frame
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder
.
h
"
#
include
"
modules
/
video_coding
/
utility
/
ivf_file_reader
.
h
"
#
include
"
rtc_base
/
event
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
namespace
webrtc
{
namespace
test
{
class
IvfVideoFrameGenerator
:
public
FrameGeneratorInterface
{
public
:
IvfVideoFrameGenerator
(
const
Environment
&
env
absl
:
:
string_view
file_name
std
:
:
optional
<
int
>
fps_hint
)
;
~
IvfVideoFrameGenerator
(
)
override
;
VideoFrameData
NextFrame
(
)
override
;
void
SkipNextFrame
(
)
override
;
void
ChangeResolution
(
size_t
width
size_t
height
)
override
;
Resolution
GetResolution
(
)
const
override
;
std
:
:
optional
<
int
>
fps
(
)
const
override
{
return
fps_hint_
;
}
private
:
class
DecodedCallback
:
public
DecodedImageCallback
{
public
:
explicit
DecodedCallback
(
IvfVideoFrameGenerator
*
reader
)
:
reader_
(
reader
)
{
}
int32_t
Decoded
(
VideoFrame
&
decoded_image
)
override
;
int32_t
Decoded
(
VideoFrame
&
decoded_image
int64_t
decode_time_ms
)
override
;
void
Decoded
(
VideoFrame
&
decoded_image
std
:
:
optional
<
int32_t
>
decode_time_ms
std
:
:
optional
<
uint8_t
>
qp
)
override
;
private
:
IvfVideoFrameGenerator
*
const
reader_
;
}
;
void
OnFrameDecoded
(
const
VideoFrame
&
decoded_frame
)
;
DecodedCallback
callback_
;
std
:
:
unique_ptr
<
IvfFileReader
>
file_reader_
;
std
:
:
unique_ptr
<
VideoDecoder
>
video_decoder_
;
Resolution
original_resolution_
;
std
:
:
optional
<
Resolution
>
output_resolution_
;
std
:
:
optional
<
int
>
fps_hint_
;
Mutex
lock_
;
Mutex
frame_decode_lock_
;
Event
next_frame_decoded_
;
std
:
:
optional
<
VideoFrame
>
next_frame_
RTC_GUARDED_BY
(
frame_decode_lock_
)
;
}
;
}
}
#
endif
