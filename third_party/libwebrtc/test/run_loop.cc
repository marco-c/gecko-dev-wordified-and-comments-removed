#
include
"
test
/
run_loop
.
h
"
#
include
"
api
/
task_queue
/
task_queue_base
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
rtc_base
/
socket
.
h
"
#
include
"
rtc_base
/
socket_server
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
rtc_base
/
time_utils
.
h
"
namespace
webrtc
{
namespace
test
{
RunLoop
:
:
RunLoop
(
)
{
worker_thread_
.
WrapCurrent
(
)
;
}
RunLoop
:
:
~
RunLoop
(
)
{
worker_thread_
.
UnwrapCurrent
(
)
;
}
TaskQueueBase
*
RunLoop
:
:
task_queue
(
)
{
return
&
worker_thread_
;
}
void
RunLoop
:
:
Run
(
)
{
worker_thread_
.
ProcessMessages
(
WorkerThread
:
:
kForever
)
;
}
void
RunLoop
:
:
Quit
(
)
{
socket_server_
.
FailNextWait
(
)
;
}
void
RunLoop
:
:
Flush
(
)
{
worker_thread_
.
PostTask
(
[
this
]
(
)
{
socket_server_
.
FailNextWait
(
)
;
}
)
;
int
cms
=
GetClockForTesting
(
)
?
0
:
1000
;
worker_thread_
.
ProcessMessages
(
cms
)
;
}
RunLoop
:
:
FakeSocketServer
:
:
FakeSocketServer
(
)
=
default
;
RunLoop
:
:
FakeSocketServer
:
:
~
FakeSocketServer
(
)
=
default
;
void
RunLoop
:
:
FakeSocketServer
:
:
FailNextWait
(
)
{
fail_next_wait_
=
true
;
}
bool
RunLoop
:
:
FakeSocketServer
:
:
Wait
(
TimeDelta
max_wait_duration
bool
process_io
)
{
if
(
fail_next_wait_
)
{
fail_next_wait_
=
false
;
return
false
;
}
return
true
;
}
void
RunLoop
:
:
FakeSocketServer
:
:
WakeUp
(
)
{
}
Socket
*
RunLoop
:
:
FakeSocketServer
:
:
CreateSocket
(
int
family
int
type
)
{
return
nullptr
;
}
RunLoop
:
:
WorkerThread
:
:
WorkerThread
(
SocketServer
*
ss
)
:
Thread
(
ss
)
tq_setter_
(
this
)
{
}
}
}
