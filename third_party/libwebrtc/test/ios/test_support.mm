#
import
<
UIKit
/
UIKit
.
h
>
#
include
"
test
/
ios
/
coverage_util_ios
.
h
"
#
include
"
test
/
ios
/
google_test_runner_delegate
.
h
"
#
include
"
test
/
ios
/
test_support
.
h
"
#
include
"
test
/
testsupport
/
perf_test
.
h
"
#
import
"
sdk
/
objc
/
helpers
/
NSString
+
StdString
.
h
"
const
char
kEnableRunIOSUnittestsWithXCTest
[
]
=
"
enable
-
run
-
ios
-
unittests
-
with
-
xctest
"
;
static
int
(
*
g_test_suite
)
(
void
)
=
NULL
;
static
int
g_argc
;
static
char
*
*
g_argv
;
static
bool
g_write_perf_output
;
static
absl
:
:
optional
<
bool
>
g_is_xctest
;
static
absl
:
:
optional
<
std
:
:
vector
<
std
:
:
string
>
>
g_metrics_to_plot
;
interface
UIApplication
(
Testing
)
-
(
void
)
_terminateWithStatus
:
(
int
)
status
;
end
interface
WebRtcUnitTestDelegate
:
NSObject
<
GoogleTestRunnerDelegate
>
{
UIWindow
*
_window
;
}
-
(
void
)
runTests
;
end
implementation
WebRtcUnitTestDelegate
-
(
BOOL
)
application
:
(
UIApplication
*
)
application
didFinishLaunchingWithOptions
:
(
NSDictionary
*
)
launchOptions
{
CGRect
bounds
=
[
[
UIScreen
mainScreen
]
bounds
]
;
_window
=
[
[
UIWindow
alloc
]
initWithFrame
:
bounds
]
;
[
_window
setBackgroundColor
:
[
UIColor
whiteColor
]
]
;
[
_window
makeKeyAndVisible
]
;
UILabel
*
label
=
[
[
UILabel
alloc
]
initWithFrame
:
bounds
]
;
label
.
text
=
[
[
NSProcessInfo
processInfo
]
processName
]
;
label
.
textAlignment
=
NSTextAlignmentCenter
;
[
_window
addSubview
:
label
]
;
[
_window
setRootViewController
:
[
[
UIViewController
alloc
]
init
]
]
;
if
(
!
rtc
:
:
test
:
:
ShouldRunIOSUnittestsWithXCTest
(
)
)
{
[
self
performSelector
:
selector
(
runTests
)
withObject
:
nil
afterDelay
:
0
.
1
]
;
}
return
YES
;
}
-
(
BOOL
)
supportsRunningGoogleTests
{
return
rtc
:
:
test
:
:
ShouldRunIOSUnittestsWithXCTest
(
)
;
}
-
(
int
)
runGoogleTests
{
rtc
:
:
test
:
:
ConfigureCoverageReportPath
(
)
;
int
exitStatus
=
g_test_suite
(
)
;
if
(
g_write_perf_output
)
{
NSString
*
fileName
=
"
perftest
-
output
.
pb
"
;
NSArray
<
NSString
*
>
*
outputDirectories
=
NSSearchPathForDirectoriesInDomains
(
NSDocumentDirectory
NSUserDomainMask
YES
)
;
if
(
[
outputDirectories
count
]
!
=
0
)
{
NSString
*
outputPath
=
[
outputDirectories
[
0
]
stringByAppendingPathComponent
:
fileName
]
;
if
(
!
webrtc
:
:
test
:
:
WritePerfResults
(
[
NSString
stdStringForString
:
outputPath
]
)
)
{
return
1
;
}
}
}
if
(
g_metrics_to_plot
)
{
webrtc
:
:
test
:
:
PrintPlottableResults
(
*
g_metrics_to_plot
)
;
}
return
exitStatus
;
}
-
(
void
)
runTests
{
RTC_DCHECK
(
!
rtc
:
:
test
:
:
ShouldRunIOSUnittestsWithXCTest
(
)
)
;
rtc
:
:
test
:
:
ConfigureCoverageReportPath
(
)
;
int
exitStatus
=
[
self
runGoogleTests
]
;
[
NSThread
sleepUntilDate
:
[
NSDate
dateWithTimeIntervalSinceNow
:
2
.
0
]
]
;
UIApplication
*
application
=
[
UIApplication
sharedApplication
]
;
[
application
_terminateWithStatus
:
exitStatus
]
;
exit
(
exitStatus
)
;
}
end
namespace
rtc
{
namespace
test
{
void
InitTestSuite
(
int
(
*
test_suite
)
(
void
)
int
argc
char
*
argv
[
]
bool
write_perf_output
absl
:
:
optional
<
std
:
:
vector
<
std
:
:
string
>
>
metrics_to_plot
)
{
g_test_suite
=
test_suite
;
g_argc
=
argc
;
g_argv
=
argv
;
g_write_perf_output
=
write_perf_output
;
g_metrics_to_plot
=
std
:
:
move
(
metrics_to_plot
)
;
}
void
RunTestsFromIOSApp
(
)
{
autoreleasepool
{
exit
(
UIApplicationMain
(
g_argc
g_argv
nil
"
WebRtcUnitTestDelegate
"
)
)
;
}
}
bool
ShouldRunIOSUnittestsWithXCTest
(
)
{
if
(
g_is_xctest
.
has_value
(
)
)
{
return
g_is_xctest
.
value
(
)
;
}
char
*
*
argv
=
g_argv
;
while
(
*
argv
!
=
nullptr
)
{
if
(
strstr
(
*
argv
kEnableRunIOSUnittestsWithXCTest
)
!
=
nullptr
)
{
g_is_xctest
=
absl
:
:
optional
<
bool
>
(
true
)
;
return
true
;
}
argv
+
+
;
}
g_is_xctest
=
absl
:
:
optional
<
bool
>
(
false
)
;
return
false
;
}
}
}
