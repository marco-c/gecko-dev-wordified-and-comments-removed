#
import
<
UIKit
/
UIKit
.
h
>
#
include
"
test
/
ios
/
coverage_util_ios
.
h
"
#
include
"
test
/
ios
/
test_support
.
h
"
#
include
"
test
/
testsupport
/
perf_test
.
h
"
#
import
"
sdk
/
objc
/
helpers
/
NSString
+
StdString
.
h
"
static
int
(
*
g_test_suite
)
(
void
)
=
NULL
;
static
int
g_argc
;
static
char
*
*
g_argv
;
static
bool
g_write_perf_output
;
static
absl
:
:
optional
<
std
:
:
vector
<
std
:
:
string
>
>
g_metrics_to_plot
;
interface
UIApplication
(
Testing
)
-
(
void
)
_terminateWithStatus
:
(
int
)
status
;
end
interface
WebRtcUnitTestDelegate
:
NSObject
{
UIWindow
*
_window
;
}
-
(
void
)
runTests
;
end
implementation
WebRtcUnitTestDelegate
-
(
BOOL
)
application
:
(
UIApplication
*
)
application
didFinishLaunchingWithOptions
:
(
NSDictionary
*
)
launchOptions
{
CGRect
bounds
=
[
[
UIScreen
mainScreen
]
bounds
]
;
_window
=
[
[
UIWindow
alloc
]
initWithFrame
:
bounds
]
;
[
_window
setBackgroundColor
:
[
UIColor
whiteColor
]
]
;
[
_window
makeKeyAndVisible
]
;
UILabel
*
label
=
[
[
UILabel
alloc
]
initWithFrame
:
bounds
]
;
label
.
text
=
[
[
NSProcessInfo
processInfo
]
processName
]
;
label
.
textAlignment
=
NSTextAlignmentCenter
;
[
_window
addSubview
:
label
]
;
[
_window
setRootViewController
:
[
[
UIViewController
alloc
]
init
]
]
;
[
self
performSelector
:
selector
(
runTests
)
withObject
:
nil
afterDelay
:
0
.
1
]
;
return
YES
;
}
-
(
void
)
runTests
{
rtc
:
:
test
:
:
ConfigureCoverageReportPath
(
)
;
int
exitStatus
=
g_test_suite
(
)
;
if
(
g_write_perf_output
)
{
NSString
*
fileName
=
"
perftest
-
output
.
pb
"
;
NSArray
<
NSString
*
>
*
outputDirectories
=
NSSearchPathForDirectoriesInDomains
(
NSDocumentDirectory
NSUserDomainMask
YES
)
;
if
(
[
outputDirectories
count
]
!
=
0
)
{
NSString
*
outputPath
=
[
outputDirectories
[
0
]
stringByAppendingPathComponent
:
fileName
]
;
if
(
!
webrtc
:
:
test
:
:
WritePerfResults
(
[
NSString
stdStringForString
:
outputPath
]
)
)
{
exit
(
1
)
;
}
}
}
if
(
g_metrics_to_plot
)
{
webrtc
:
:
test
:
:
PrintPlottableResults
(
*
g_metrics_to_plot
)
;
}
[
NSThread
sleepUntilDate
:
[
NSDate
dateWithTimeIntervalSinceNow
:
2
.
0
]
]
;
UIApplication
*
application
=
[
UIApplication
sharedApplication
]
;
[
application
_terminateWithStatus
:
exitStatus
]
;
exit
(
exitStatus
)
;
}
end
namespace
rtc
{
namespace
test
{
void
InitTestSuite
(
int
(
*
test_suite
)
(
void
)
int
argc
char
*
argv
[
]
bool
write_perf_output
absl
:
:
optional
<
std
:
:
vector
<
std
:
:
string
>
>
metrics_to_plot
)
{
g_test_suite
=
test_suite
;
g_argc
=
argc
;
g_argv
=
argv
;
g_write_perf_output
=
write_perf_output
;
g_metrics_to_plot
=
std
:
:
move
(
metrics_to_plot
)
;
}
void
RunTestsFromIOSApp
(
)
{
autoreleasepool
{
exit
(
UIApplicationMain
(
g_argc
g_argv
nil
"
WebRtcUnitTestDelegate
"
)
)
;
}
}
}
}
