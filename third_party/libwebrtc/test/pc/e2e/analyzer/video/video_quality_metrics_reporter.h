#
ifndef
TEST_PC_E2E_ANALYZER_VIDEO_VIDEO_QUALITY_METRICS_REPORTER_H_
#
define
TEST_PC_E2E_ANALYZER_VIDEO_VIDEO_QUALITY_METRICS_REPORTER_H_
#
include
<
map
>
#
include
<
string
>
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
numerics
/
samples_stats_counter
.
h
"
#
include
"
api
/
test
/
metrics
/
metrics_logger_and_exporter
.
h
"
#
include
"
api
/
test
/
peerconnection_quality_test_fixture
.
h
"
#
include
"
api
/
test
/
track_id_stream_info_map
.
h
"
#
include
"
api
/
units
/
data_size
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
test
/
testsupport
/
perf_test
.
h
"
namespace
webrtc
{
namespace
webrtc_pc_e2e
{
struct
VideoBweStats
{
SamplesStatsCounter
available_send_bandwidth
;
SamplesStatsCounter
transmission_bitrate
;
SamplesStatsCounter
retransmission_bitrate
;
}
;
class
VideoQualityMetricsReporter
:
public
PeerConnectionE2EQualityTestFixture
:
:
QualityMetricsReporter
{
public
:
explicit
VideoQualityMetricsReporter
(
Clock
*
const
clock
)
:
VideoQualityMetricsReporter
(
clock
nullptr
)
{
}
explicit
VideoQualityMetricsReporter
(
Clock
*
const
clock
test
:
:
MetricsLoggerAndExporter
*
const
metrics_logger
)
:
clock_
(
clock
)
metrics_logger_
(
metrics_logger
)
{
}
~
VideoQualityMetricsReporter
(
)
override
=
default
;
void
Start
(
absl
:
:
string_view
test_case_name
const
TrackIdStreamInfoMap
*
reporter_helper
)
override
;
void
OnStatsReports
(
absl
:
:
string_view
pc_label
const
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
&
report
)
override
;
void
StopAndReportResults
(
)
override
;
private
:
struct
StatsSample
{
DataSize
bytes_sent
=
DataSize
:
:
Zero
(
)
;
DataSize
header_bytes_sent
=
DataSize
:
:
Zero
(
)
;
DataSize
retransmitted_bytes_sent
=
DataSize
:
:
Zero
(
)
;
Timestamp
sample_time
=
Timestamp
:
:
Zero
(
)
;
}
;
std
:
:
string
GetTestCaseName
(
const
std
:
:
string
&
stream_label
)
const
;
void
ReportVideoBweResults
(
const
std
:
:
string
&
test_case_name
const
VideoBweStats
&
video_bwe_stats
)
;
static
void
ReportResult
(
const
std
:
:
string
&
metric_name
const
std
:
:
string
&
test_case_name
const
SamplesStatsCounter
&
counter
const
std
:
:
string
&
unit
webrtc
:
:
test
:
:
ImproveDirection
improve_direction
=
webrtc
:
:
test
:
:
ImproveDirection
:
:
kNone
)
;
Timestamp
Now
(
)
const
{
return
clock_
-
>
CurrentTime
(
)
;
}
Clock
*
const
clock_
;
test
:
:
MetricsLoggerAndExporter
*
const
metrics_logger_
;
std
:
:
string
test_case_name_
;
absl
:
:
optional
<
Timestamp
>
start_time_
;
Mutex
video_bwe_stats_lock_
;
std
:
:
map
<
std
:
:
string
VideoBweStats
>
video_bwe_stats_
RTC_GUARDED_BY
(
video_bwe_stats_lock_
)
;
std
:
:
map
<
std
:
:
string
StatsSample
>
last_stats_sample_
RTC_GUARDED_BY
(
video_bwe_stats_lock_
)
;
}
;
}
}
#
endif
