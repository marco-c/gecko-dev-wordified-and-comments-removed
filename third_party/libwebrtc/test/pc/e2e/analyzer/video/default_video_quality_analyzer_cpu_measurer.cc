#
include
"
test
/
pc
/
e2e
/
analyzer
/
video
/
default_video_quality_analyzer_cpu_measurer
.
h
"
#
include
"
rtc_base
/
cpu_time
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
rtc_base
/
system_time
.
h
"
namespace
webrtc
{
void
DefaultVideoQualityAnalyzerCpuMeasurer
:
:
StartMeasuringCpuProcessTime
(
)
{
MutexLock
lock
(
&
mutex_
)
;
cpu_time_
-
=
rtc
:
:
GetProcessCpuTimeNanos
(
)
;
wallclock_time_
-
=
rtc
:
:
SystemTimeNanos
(
)
;
}
void
DefaultVideoQualityAnalyzerCpuMeasurer
:
:
StopMeasuringCpuProcessTime
(
)
{
MutexLock
lock
(
&
mutex_
)
;
cpu_time_
+
=
rtc
:
:
GetProcessCpuTimeNanos
(
)
;
wallclock_time_
+
=
rtc
:
:
SystemTimeNanos
(
)
;
}
void
DefaultVideoQualityAnalyzerCpuMeasurer
:
:
StartExcludingCpuThreadTime
(
)
{
MutexLock
lock
(
&
mutex_
)
;
cpu_time_
+
=
rtc
:
:
GetThreadCpuTimeNanos
(
)
;
}
void
DefaultVideoQualityAnalyzerCpuMeasurer
:
:
StopExcludingCpuThreadTime
(
)
{
MutexLock
lock
(
&
mutex_
)
;
cpu_time_
-
=
rtc
:
:
GetThreadCpuTimeNanos
(
)
;
}
double
DefaultVideoQualityAnalyzerCpuMeasurer
:
:
GetCpuUsagePercent
(
)
const
{
MutexLock
lock
(
&
mutex_
)
;
return
static_cast
<
double
>
(
cpu_time_
)
/
wallclock_time_
*
100
.
0
;
}
}
