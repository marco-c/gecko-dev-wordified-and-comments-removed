#
ifndef
TEST_PC_E2E_ANALYZER_VIDEO_QUALITY_ANALYZING_VIDEO_DECODER_H_
#
define
TEST_PC_E2E_ANALYZER_VIDEO_QUALITY_ANALYZING_VIDEO_DECODER_H_
#
include
<
map
>
#
include
<
memory
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
test
/
video_quality_analyzer_interface
.
h
"
#
include
"
api
/
video
/
encoded_image
.
h
"
#
include
"
api
/
video
/
video_frame
.
h
"
#
include
"
api
/
video_codecs
/
sdp_video_format
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder_factory
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
test
/
pc
/
e2e
/
analyzer
/
video
/
encoded_image_data_injector
.
h
"
#
include
"
test
/
pc
/
e2e
/
analyzer
/
video
/
id_generator
.
h
"
namespace
webrtc
{
namespace
webrtc_pc_e2e
{
class
QualityAnalyzingVideoDecoder
:
public
VideoDecoder
{
public
:
QualityAnalyzingVideoDecoder
(
int
id
absl
:
:
string_view
peer_name
std
:
:
unique_ptr
<
VideoDecoder
>
delegate
EncodedImageDataExtractor
*
extractor
VideoQualityAnalyzerInterface
*
analyzer
)
;
~
QualityAnalyzingVideoDecoder
(
)
override
;
int32_t
InitDecode
(
const
VideoCodec
*
codec_settings
int32_t
number_of_cores
)
override
;
int32_t
Decode
(
const
EncodedImage
&
input_image
bool
missing_frames
int64_t
render_time_ms
)
override
;
int32_t
RegisterDecodeCompleteCallback
(
DecodedImageCallback
*
callback
)
override
;
int32_t
Release
(
)
override
;
const
char
*
ImplementationName
(
)
const
override
;
private
:
class
DecoderCallback
:
public
DecodedImageCallback
{
public
:
explicit
DecoderCallback
(
QualityAnalyzingVideoDecoder
*
decoder
)
;
~
DecoderCallback
(
)
override
;
void
SetDelegateCallback
(
DecodedImageCallback
*
delegate
)
;
int32_t
Decoded
(
VideoFrame
&
decodedImage
)
override
;
int32_t
Decoded
(
VideoFrame
&
decodedImage
int64_t
decode_time_ms
)
override
;
void
Decoded
(
VideoFrame
&
decodedImage
absl
:
:
optional
<
int32_t
>
decode_time_ms
absl
:
:
optional
<
uint8_t
>
qp
)
override
;
int32_t
IrrelevantSimulcastStreamDecoded
(
uint16_t
frame_id
uint32_t
timestamp_ms
)
;
private
:
rtc
:
:
scoped_refptr
<
webrtc
:
:
VideoFrameBuffer
>
GetDummyFrameBuffer
(
)
;
QualityAnalyzingVideoDecoder
*
const
decoder_
;
rtc
:
:
scoped_refptr
<
webrtc
:
:
VideoFrameBuffer
>
dummy_frame_buffer_
;
Mutex
callback_lock_
;
DecodedImageCallback
*
delegate_callback_
RTC_GUARDED_BY
(
callback_lock_
)
;
}
;
void
OnFrameDecoded
(
VideoFrame
*
frame
absl
:
:
optional
<
int32_t
>
decode_time_ms
absl
:
:
optional
<
uint8_t
>
qp
)
;
const
int
id_
;
const
std
:
:
string
peer_name_
;
const
std
:
:
string
implementation_name_
;
std
:
:
unique_ptr
<
VideoDecoder
>
delegate_
;
EncodedImageDataExtractor
*
const
extractor_
;
VideoQualityAnalyzerInterface
*
const
analyzer_
;
std
:
:
unique_ptr
<
DecoderCallback
>
analyzing_callback_
;
Mutex
lock_
;
std
:
:
map
<
uint32_t
uint16_t
>
timestamp_to_frame_id_
RTC_GUARDED_BY
(
lock_
)
;
std
:
:
map
<
uint16_t
EncodedImage
>
decoding_images_
RTC_GUARDED_BY
(
lock_
)
;
}
;
class
QualityAnalyzingVideoDecoderFactory
:
public
VideoDecoderFactory
{
public
:
QualityAnalyzingVideoDecoderFactory
(
absl
:
:
string_view
peer_name
std
:
:
unique_ptr
<
VideoDecoderFactory
>
delegate
IdGenerator
<
int
>
*
id_generator
EncodedImageDataExtractor
*
extractor
VideoQualityAnalyzerInterface
*
analyzer
)
;
~
QualityAnalyzingVideoDecoderFactory
(
)
override
;
std
:
:
vector
<
SdpVideoFormat
>
GetSupportedFormats
(
)
const
override
;
std
:
:
unique_ptr
<
VideoDecoder
>
CreateVideoDecoder
(
const
SdpVideoFormat
&
format
)
override
;
std
:
:
unique_ptr
<
VideoDecoder
>
LegacyCreateVideoDecoder
(
const
SdpVideoFormat
&
format
const
std
:
:
string
&
receive_stream_id
)
override
;
private
:
const
std
:
:
string
peer_name_
;
std
:
:
unique_ptr
<
VideoDecoderFactory
>
delegate_
;
IdGenerator
<
int
>
*
const
id_generator_
;
EncodedImageDataExtractor
*
const
extractor_
;
VideoQualityAnalyzerInterface
*
const
analyzer_
;
}
;
}
}
#
endif
