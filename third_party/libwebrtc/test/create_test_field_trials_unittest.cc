#
include
"
test
/
create_test_field_trials
.
h
"
#
include
<
string
>
#
include
"
absl
/
flags
/
declare
.
h
"
#
include
"
absl
/
flags
/
flag
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
field_trials
.
h
"
#
include
"
test
/
gtest
.
h
"
ABSL_DECLARE_FLAG
(
std
:
:
string
force_fieldtrials
)
;
namespace
webrtc
{
namespace
{
class
ScopedSetFlag
{
public
:
explicit
ScopedSetFlag
(
absl
:
:
string_view
value
)
{
old_value_
=
absl
:
:
GetFlag
(
FLAGS_force_fieldtrials
)
;
absl
:
:
SetFlag
(
&
FLAGS_force_fieldtrials
value
)
;
}
~
ScopedSetFlag
(
)
{
absl
:
:
SetFlag
(
&
FLAGS_force_fieldtrials
old_value_
)
;
}
private
:
std
:
:
string
old_value_
;
}
;
TEST
(
CreateTestFieldTrialsTest
UsesCommandLineFlag
)
{
ScopedSetFlag
override_flag
(
"
Trial1
/
Value1
/
Trial2
/
Value2
/
"
)
;
FieldTrials
field_trials
=
CreateTestFieldTrials
(
)
;
field_trials
.
RegisterKeysForTesting
(
{
"
Trial1
"
"
Trial2
"
}
)
;
EXPECT_EQ
(
field_trials
.
Lookup
(
"
Trial1
"
)
"
Value1
"
)
;
EXPECT_EQ
(
field_trials
.
Lookup
(
"
Trial2
"
)
"
Value2
"
)
;
}
TEST
(
CreateTestFieldTrialsTest
UsesConstructionParameter
)
{
FieldTrials
field_trials
=
CreateTestFieldTrials
(
"
Trial1
/
Value1
/
Trial2
/
Value2
/
"
)
;
field_trials
.
RegisterKeysForTesting
(
{
"
Trial1
"
"
Trial2
"
}
)
;
EXPECT_EQ
(
field_trials
.
Lookup
(
"
Trial1
"
)
"
Value1
"
)
;
EXPECT_EQ
(
field_trials
.
Lookup
(
"
Trial2
"
)
"
Value2
"
)
;
}
TEST
(
CreateTestFieldTrialsTest
ConstructionParameterTakesPrecedenceOverCommandLine
)
{
ScopedSetFlag
override_flag
(
"
TrialCommon
/
ValueF
/
TrialFlag
/
FlagValue
/
"
)
;
FieldTrials
field_trials
=
CreateTestFieldTrials
(
"
TrialCommon
/
ValueC
/
TrialConstructor
/
ConstructorValue
/
"
)
;
field_trials
.
RegisterKeysForTesting
(
{
"
TrialCommon
"
"
TrialFlag
"
"
TrialConstructor
"
}
)
;
EXPECT_EQ
(
field_trials
.
Lookup
(
"
TrialCommon
"
)
"
ValueC
"
)
;
EXPECT_EQ
(
field_trials
.
Lookup
(
"
TrialFlag
"
)
"
FlagValue
"
)
;
EXPECT_EQ
(
field_trials
.
Lookup
(
"
TrialConstructor
"
)
"
ConstructorValue
"
)
;
}
}
}
