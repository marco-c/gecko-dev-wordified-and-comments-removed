#
include
"
modules
/
pacing
/
task_queue_paced_sender
.
h
"
#
include
<
algorithm
>
#
include
<
atomic
>
#
include
<
list
>
#
include
<
memory
>
#
include
<
string
>
#
include
<
utility
>
#
include
<
vector
>
#
include
"
absl
/
functional
/
any_invocable
.
h
"
#
include
"
api
/
task_queue
/
task_queue_base
.
h
"
#
include
"
api
/
transport
/
network_types
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
modules
/
pacing
/
packet_router
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
scoped_key_value_config
.
h
"
#
include
"
test
/
time_controller
/
simulated_time_controller
.
h
"
using
:
:
testing
:
:
_
;
using
:
:
testing
:
:
AtLeast
;
using
:
:
testing
:
:
Return
;
using
:
:
testing
:
:
SaveArg
;
namespace
webrtc
{
namespace
{
constexpr
uint32_t
kAudioSsrc
=
12345
;
constexpr
uint32_t
kVideoSsrc
=
234565
;
constexpr
uint32_t
kVideoRtxSsrc
=
34567
;
constexpr
uint32_t
kFlexFecSsrc
=
45678
;
constexpr
size_t
kDefaultPacketSize
=
1234
;
class
MockPacketRouter
:
public
PacketRouter
{
public
:
MOCK_METHOD
(
void
SendPacket
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
const
PacedPacketInfo
&
cluster_info
)
(
override
)
)
;
MOCK_METHOD
(
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
FetchFec
(
)
(
override
)
)
;
MOCK_METHOD
(
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
GeneratePadding
(
DataSize
target_size
)
(
override
)
)
;
}
;
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
GeneratePadding
(
DataSize
target_size
)
{
const
DataSize
kMaxPaddingPacketSize
=
DataSize
:
:
Bytes
(
224
)
;
DataSize
padding_generated
=
DataSize
:
:
Zero
(
)
;
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
padding_packets
;
while
(
padding_generated
<
target_size
)
{
DataSize
packet_size
=
std
:
:
min
(
target_size
-
padding_generated
kMaxPaddingPacketSize
)
;
padding_generated
+
=
packet_size
;
auto
padding_packet
=
std
:
:
make_unique
<
RtpPacketToSend
>
(
nullptr
)
;
padding_packet
-
>
set_packet_type
(
RtpPacketMediaType
:
:
kPadding
)
;
padding_packet
-
>
SetPadding
(
packet_size
.
bytes
(
)
)
;
padding_packets
.
push_back
(
std
:
:
move
(
padding_packet
)
)
;
}
return
padding_packets
;
}
class
TaskQueueWithFakePrecisionFactory
:
public
TaskQueueFactory
{
public
:
explicit
TaskQueueWithFakePrecisionFactory
(
TaskQueueFactory
*
task_queue_factory
)
:
task_queue_factory_
(
task_queue_factory
)
{
}
std
:
:
unique_ptr
<
TaskQueueBase
TaskQueueDeleter
>
CreateTaskQueue
(
absl
:
:
string_view
name
Priority
priority
)
const
override
{
return
std
:
:
unique_ptr
<
TaskQueueBase
TaskQueueDeleter
>
(
new
TaskQueueWithFakePrecision
(
const_cast
<
TaskQueueWithFakePrecisionFactory
*
>
(
this
)
task_queue_factory_
)
)
;
}
int
delayed_low_precision_count
(
)
const
{
return
delayed_low_precision_count_
;
}
int
delayed_high_precision_count
(
)
const
{
return
delayed_high_precision_count_
;
}
private
:
friend
class
TaskQueueWithFakePrecision
;
class
TaskQueueWithFakePrecision
:
public
TaskQueueBase
{
public
:
TaskQueueWithFakePrecision
(
TaskQueueWithFakePrecisionFactory
*
parent_factory
TaskQueueFactory
*
task_queue_factory
)
:
parent_factory_
(
parent_factory
)
task_queue_
(
task_queue_factory
-
>
CreateTaskQueue
(
"
TaskQueueWithFakePrecision
"
TaskQueueFactory
:
:
Priority
:
:
NORMAL
)
)
{
}
~
TaskQueueWithFakePrecision
(
)
override
{
}
void
Delete
(
)
override
{
delete
this
;
}
void
PostTask
(
absl
:
:
AnyInvocable
<
void
(
)
&
&
>
task
)
override
{
task_queue_
-
>
PostTask
(
WrapTask
(
std
:
:
move
(
task
)
)
)
;
}
void
PostDelayedTask
(
absl
:
:
AnyInvocable
<
void
(
)
&
&
>
task
TimeDelta
delay
)
override
{
+
+
parent_factory_
-
>
delayed_low_precision_count_
;
task_queue_
-
>
PostDelayedTask
(
WrapTask
(
std
:
:
move
(
task
)
)
delay
)
;
}
void
PostDelayedHighPrecisionTask
(
absl
:
:
AnyInvocable
<
void
(
)
&
&
>
task
TimeDelta
delay
)
override
{
+
+
parent_factory_
-
>
delayed_high_precision_count_
;
task_queue_
-
>
PostDelayedHighPrecisionTask
(
WrapTask
(
std
:
:
move
(
task
)
)
delay
)
;
}
private
:
absl
:
:
AnyInvocable
<
void
(
)
&
&
>
WrapTask
(
absl
:
:
AnyInvocable
<
void
(
)
&
&
>
task
)
{
return
[
this
task
=
std
:
:
move
(
task
)
]
(
)
mutable
{
CurrentTaskQueueSetter
set_current
(
this
)
;
std
:
:
move
(
task
)
(
)
;
}
;
}
TaskQueueWithFakePrecisionFactory
*
parent_factory_
;
std
:
:
unique_ptr
<
TaskQueueBase
TaskQueueDeleter
>
task_queue_
;
}
;
TaskQueueFactory
*
task_queue_factory_
;
std
:
:
atomic
<
int
>
delayed_low_precision_count_
=
0u
;
std
:
:
atomic
<
int
>
delayed_high_precision_count_
=
0u
;
}
;
}
namespace
test
{
std
:
:
unique_ptr
<
RtpPacketToSend
>
BuildRtpPacket
(
RtpPacketMediaType
type
)
{
auto
packet
=
std
:
:
make_unique
<
RtpPacketToSend
>
(
nullptr
)
;
packet
-
>
set_packet_type
(
type
)
;
switch
(
type
)
{
case
RtpPacketMediaType
:
:
kAudio
:
packet
-
>
SetSsrc
(
kAudioSsrc
)
;
break
;
case
RtpPacketMediaType
:
:
kVideo
:
packet
-
>
SetSsrc
(
kVideoSsrc
)
;
break
;
case
RtpPacketMediaType
:
:
kRetransmission
:
case
RtpPacketMediaType
:
:
kPadding
:
packet
-
>
SetSsrc
(
kVideoRtxSsrc
)
;
break
;
case
RtpPacketMediaType
:
:
kForwardErrorCorrection
:
packet
-
>
SetSsrc
(
kFlexFecSsrc
)
;
break
;
}
packet
-
>
SetPayloadSize
(
kDefaultPacketSize
)
;
return
packet
;
}
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
GeneratePackets
(
RtpPacketMediaType
type
size_t
num_packets
)
{
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
packets
;
for
(
size_t
i
=
0
;
i
<
num_packets
;
+
+
i
)
{
packets
.
push_back
(
BuildRtpPacket
(
type
)
)
;
}
return
packets
;
}
constexpr
char
kSendPacketOnWorkerThreadFieldTrial
[
]
=
"
WebRTC
-
SendPacketsOnWorkerThread
/
Enabled
/
"
;
std
:
:
vector
<
std
:
:
string
>
ParameterizedFieldTrials
(
)
{
return
{
{
"
"
}
{
kSendPacketOnWorkerThreadFieldTrial
}
}
;
}
bool
UsingWorkerThread
(
absl
:
:
string_view
field_trials
)
{
return
field_trials
.
find
(
kSendPacketOnWorkerThreadFieldTrial
)
!
=
std
:
:
string
:
:
npos
;
}
class
TaskQueuePacedSenderTest
:
public
:
:
testing
:
:
TestWithParam
<
std
:
:
string
>
{
}
;
INSTANTIATE_TEST_SUITE_P
(
TaskQueuePacedSenderTest
TaskQueuePacedSenderTest
testing
:
:
ValuesIn
(
ParameterizedFieldTrials
(
)
)
[
]
(
const
testing
:
:
TestParamInfo
<
std
:
:
string
>
&
info
)
{
return
UsingWorkerThread
(
info
.
param
)
?
"
UsingWt
"
:
"
OwnedTQ
"
;
}
)
;
TEST_P
(
TaskQueuePacedSenderTest
PacesPackets
)
{
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
static
constexpr
size_t
kPacketsToSend
=
42
;
SequenceChecker
sequence_checker
;
pacer
.
SetPacingRates
(
DataRate
:
:
BitsPerSec
(
kDefaultPacketSize
*
8
*
kPacketsToSend
)
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketsToSend
)
)
;
size_t
packets_sent
=
0
;
Timestamp
end_time
=
Timestamp
:
:
PlusInfinity
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
WillRepeatedly
(
[
&
]
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
const
PacedPacketInfo
&
cluster_info
)
{
+
+
packets_sent
;
if
(
packets_sent
=
=
kPacketsToSend
)
{
end_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
;
}
EXPECT_EQ
(
sequence_checker
.
IsCurrent
(
)
UsingWorkerThread
(
GetParam
(
)
)
)
;
}
)
;
const
Timestamp
start_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
EXPECT_EQ
(
packets_sent
kPacketsToSend
)
;
ASSERT_TRUE
(
end_time
.
IsFinite
(
)
)
;
EXPECT_NEAR
(
(
end_time
-
start_time
)
.
ms
<
double
>
(
)
1000
.
0
50
.
0
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
ReschedulesProcessOnRateChange
)
{
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
const
size_t
kPacketsPerSecond
=
5
;
const
DataRate
kPacingRate
=
DataRate
:
:
BitsPerSec
(
kDefaultPacketSize
*
8
*
kPacketsPerSecond
)
;
pacer
.
SetPacingRates
(
kPacingRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
kPacketsPerSecond
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketsPerSecond
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
Timestamp
first_packet_time
=
Timestamp
:
:
MinusInfinity
(
)
;
Timestamp
second_packet_time
=
Timestamp
:
:
MinusInfinity
(
)
;
Timestamp
third_packet_time
=
Timestamp
:
:
MinusInfinity
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
3
)
.
WillRepeatedly
(
[
&
]
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
const
PacedPacketInfo
&
cluster_info
)
{
if
(
first_packet_time
.
IsInfinite
(
)
)
{
first_packet_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
;
}
else
if
(
second_packet_time
.
IsInfinite
(
)
)
{
second_packet_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
;
time_controller
.
GetMainThread
(
)
-
>
PostTask
(
[
&
]
{
pacer
.
SetPacingRates
(
2
*
kPacingRate
DataRate
:
:
Zero
(
)
)
;
}
)
;
}
else
{
third_packet_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
;
}
}
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
3
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
500
)
)
;
ASSERT_TRUE
(
third_packet_time
.
IsFinite
(
)
)
;
EXPECT_NEAR
(
(
second_packet_time
-
first_packet_time
)
.
ms
<
double
>
(
)
200
.
0
1
.
0
)
;
EXPECT_NEAR
(
(
third_packet_time
-
second_packet_time
)
.
ms
<
double
>
(
)
100
.
0
1
.
0
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
SendsAudioImmediately
)
{
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
const
DataRate
kPacingDataRate
=
DataRate
:
:
KilobitsPerSec
(
125
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
kPacketSize
/
kPacingDataRate
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
10
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
:
:
testing
:
:
Mock
:
:
VerifyAndClearExpectations
(
&
packet_router
)
;
time_controller
.
AdvanceTime
(
kPacketPacingTime
/
2
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kAudio
1
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
:
:
testing
:
:
Mock
:
:
VerifyAndClearExpectations
(
&
packet_router
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
SleepsDuringCoalscingWindow
)
{
const
TimeDelta
kCoalescingWindow
=
TimeDelta
:
:
Millis
(
5
)
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
kCoalescingWindow
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
TimeDelta
:
:
Millis
(
1
)
;
const
DataRate
kPacingDataRate
=
kPacketSize
/
kPacketPacingTime
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
10
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
:
:
testing
:
:
Mock
:
:
VerifyAndClearExpectations
(
&
packet_router
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
0
)
;
time_controller
.
AdvanceTime
(
kCoalescingWindow
-
TimeDelta
:
:
Millis
(
1
)
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
5
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
1
)
)
;
:
:
testing
:
:
Mock
:
:
VerifyAndClearExpectations
(
&
packet_router
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
ProbingOverridesCoalescingWindow
)
{
const
TimeDelta
kCoalescingWindow
=
TimeDelta
:
:
Millis
(
5
)
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
kCoalescingWindow
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
TimeDelta
:
:
Millis
(
1
)
;
const
DataRate
kPacingDataRate
=
kPacketSize
/
kPacketPacingTime
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
AtLeast
(
1
)
)
;
pacer
.
CreateProbeClusters
(
{
{
.
at_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
.
target_data_rate
=
kPacingDataRate
*
2
.
target_duration
=
TimeDelta
:
:
Millis
(
15
)
.
target_probe_count
=
5
.
id
=
17
}
}
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
10
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
:
:
testing
:
:
Mock
:
:
VerifyAndClearExpectations
(
&
packet_router
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
AtLeast
(
1
)
)
;
time_controller
.
AdvanceTime
(
kCoalescingWindow
-
TimeDelta
:
:
Millis
(
1
)
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
SchedulesProbeAtSentTime
)
{
ScopedKeyValueConfig
trials
(
GetParam
(
)
+
"
WebRTC
-
Bwe
-
ProbingBehavior
/
min_probe_delta
:
1ms
/
"
)
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
TimeDelta
:
:
Millis
(
4
)
;
const
DataRate
kPacingDataRate
=
kPacketSize
/
kPacketPacingTime
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
EXPECT_CALL
(
packet_router
FetchFec
)
.
WillRepeatedly
(
[
]
(
)
{
return
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
(
)
;
}
)
;
EXPECT_CALL
(
packet_router
GeneratePadding
(
_
)
)
.
WillRepeatedly
(
[
]
(
DataSize
target_size
)
{
return
GeneratePadding
(
target_size
)
;
}
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
2
)
)
;
const
int
kNotAProbe
=
PacedPacketInfo
:
:
kNotAProbe
;
EXPECT_CALL
(
packet_router
SendPacket
(
_
:
:
testing
:
:
Field
(
&
PacedPacketInfo
:
:
probe_cluster_id
kNotAProbe
)
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Micros
(
1001
)
)
;
const
DataRate
kProbeRate
=
2
*
kPacingDataRate
;
const
int
kProbeClusterId
=
1
;
pacer
.
CreateProbeClusters
(
{
{
.
at_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
.
target_data_rate
=
kProbeRate
.
target_duration
=
TimeDelta
:
:
Millis
(
15
)
.
target_probe_count
=
4
.
id
=
kProbeClusterId
}
}
)
;
const
TimeDelta
kProbeTimeDelta
=
TimeDelta
:
:
Millis
(
2
)
;
const
DataSize
kProbeSize
=
kProbeRate
*
kProbeTimeDelta
;
const
size_t
kNumPacketsInProbe
=
(
kProbeSize
+
kPacketSize
-
DataSize
:
:
Bytes
(
1
)
)
/
kPacketSize
;
EXPECT_CALL
(
packet_router
SendPacket
(
_
:
:
testing
:
:
Field
(
&
PacedPacketInfo
:
:
probe_cluster_id
kProbeClusterId
)
)
)
.
Times
(
kNumPacketsInProbe
+
1
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kNumPacketsInProbe
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
EXPECT_CALL
(
packet_router
SendPacket
(
_
:
:
testing
:
:
Field
(
&
PacedPacketInfo
:
:
probe_cluster_id
kProbeClusterId
)
)
)
.
Times
(
AtLeast
(
1
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
2
)
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
NoMinSleepTimeWhenProbing
)
{
const
TimeDelta
kMinProbeDelta
=
TimeDelta
:
:
Micros
(
200
)
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
+
"
WebRTC
-
Bwe
-
ProbingBehavior
/
min_probe_delta
:
200us
/
"
)
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
TimeDelta
:
:
Millis
(
4
)
;
const
DataRate
kPacingDataRate
=
kPacketSize
/
kPacketPacingTime
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
EXPECT_CALL
(
packet_router
FetchFec
)
.
WillRepeatedly
(
[
]
(
)
{
return
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
(
)
;
}
)
;
EXPECT_CALL
(
packet_router
GeneratePadding
)
.
WillRepeatedly
(
[
]
(
DataSize
target_size
)
{
return
GeneratePadding
(
target_size
)
;
}
)
;
const
int
kProbeClusterId
=
1
;
DataRate
kProbingRate
=
kPacingDataRate
*
10
;
pacer
.
CreateProbeClusters
(
{
{
.
at_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
.
target_data_rate
=
kProbingRate
.
target_duration
=
TimeDelta
:
:
Millis
(
15
)
.
target_probe_count
=
5
.
id
=
kProbeClusterId
}
}
)
;
DataSize
data_sent
=
DataSize
:
:
Zero
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
(
_
:
:
testing
:
:
Field
(
&
PacedPacketInfo
:
:
probe_cluster_id
kProbeClusterId
)
)
)
.
Times
(
AtLeast
(
4
)
)
.
WillRepeatedly
(
[
&
]
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
const
PacedPacketInfo
&
)
{
data_sent
+
=
DataSize
:
:
Bytes
(
packet
-
>
payload_size
(
)
+
packet
-
>
padding_size
(
)
)
;
}
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
1
)
)
;
time_controller
.
AdvanceTime
(
kMinProbeDelta
)
;
const
DataSize
kMinProbeSize
=
kMinProbeDelta
*
kProbingRate
;
EXPECT_EQ
(
data_sent
DataSize
:
:
Bytes
(
1
)
+
kPacketSize
+
4
*
kMinProbeSize
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
PacketBasedCoalescing
)
{
const
TimeDelta
kFixedCoalescingWindow
=
TimeDelta
:
:
Millis
(
10
)
;
const
int
kPacketBasedHoldback
=
5
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
kFixedCoalescingWindow
kPacketBasedHoldback
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
TimeDelta
:
:
Millis
(
1
)
;
const
DataRate
kPacingDataRate
=
kPacketSize
/
kPacketPacingTime
;
const
TimeDelta
kExpectedHoldbackWindow
=
kPacketPacingTime
*
kPacketBasedHoldback
;
ASSERT_GE
(
kFixedCoalescingWindow
kExpectedHoldbackWindow
)
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
EXPECT_CALL
(
packet_router
FetchFec
)
.
WillRepeatedly
(
[
]
(
)
{
return
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
(
)
;
}
)
;
pacer
.
EnsureStarted
(
)
;
const
int
kNumWarmupPackets
=
40
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
kNumWarmupPackets
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kNumWarmupPackets
)
)
;
time_controller
.
AdvanceTime
(
kPacketPacingTime
*
(
kNumWarmupPackets
*
2
)
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
1
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketBasedHoldback
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
0
)
;
time_controller
.
AdvanceTime
(
kExpectedHoldbackWindow
-
TimeDelta
:
:
Millis
(
1
)
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
kPacketBasedHoldback
-
1
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
1
)
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
FixedHoldBackHasPriorityOverPackets
)
{
const
TimeDelta
kFixedCoalescingWindow
=
TimeDelta
:
:
Millis
(
2
)
;
const
int
kPacketBasedHoldback
=
5
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
kFixedCoalescingWindow
kPacketBasedHoldback
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
TimeDelta
:
:
Millis
(
1
)
;
const
DataRate
kPacingDataRate
=
kPacketSize
/
kPacketPacingTime
;
const
TimeDelta
kExpectedPacketHoldbackWindow
=
kPacketPacingTime
*
kPacketBasedHoldback
;
ASSERT_LT
(
kFixedCoalescingWindow
kExpectedPacketHoldbackWindow
)
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
EXPECT_CALL
(
packet_router
FetchFec
)
.
WillRepeatedly
(
[
]
(
)
{
return
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
(
)
;
}
)
;
pacer
.
EnsureStarted
(
)
;
const
int
kNumWarmupPackets
=
40
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
kNumWarmupPackets
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kNumWarmupPackets
)
)
;
time_controller
.
AdvanceTime
(
kPacketPacingTime
*
(
kNumWarmupPackets
*
2
)
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
1
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketBasedHoldback
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
AtLeast
(
1
)
)
;
time_controller
.
AdvanceTime
(
kFixedCoalescingWindow
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
ProbingStopDuringSendLoop
)
{
ScopedKeyValueConfig
trials
(
GetParam
(
)
+
"
WebRTC
-
Bwe
-
ProbingBehavior
/
min_probe_delta
:
100us
/
"
)
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
MockPacketRouter
packet_router
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
const
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
)
;
const
TimeDelta
kPacketPacingTime
=
TimeDelta
:
:
Millis
(
1
)
;
const
DataRate
kPacingDataRate
=
2
*
kPacketSize
/
kPacketPacingTime
;
pacer
.
SetPacingRates
(
kPacingDataRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
EXPECT_CALL
(
packet_router
FetchFec
)
.
WillRepeatedly
(
[
]
(
)
{
return
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
(
)
;
}
)
;
EXPECT_CALL
(
packet_router
GeneratePadding
(
_
)
)
.
WillRepeatedly
(
[
]
(
DataSize
target_size
)
{
return
GeneratePadding
(
target_size
)
;
}
)
;
const
int
kProbeClusterId
=
1
;
const
DataRate
kProbingRate
=
kPacingDataRate
;
pacer
.
CreateProbeClusters
(
{
{
.
at_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
.
target_data_rate
=
kProbingRate
.
target_duration
=
TimeDelta
:
:
Millis
(
15
)
.
target_probe_count
=
4
.
id
=
kProbeClusterId
}
}
)
;
const
int
kPacketsToSend
=
100
;
const
TimeDelta
kPacketsPacedTime
=
std
:
:
max
(
kPacketsToSend
*
kPacketSize
/
kPacingDataRate
kPacketsToSend
*
kPacketSize
/
kProbingRate
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
kPacketsToSend
+
1
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketsToSend
)
)
;
time_controller
.
AdvanceTime
(
kPacketsPacedTime
+
TimeDelta
:
:
Millis
(
1
)
)
;
}
TEST_P
(
TaskQueuePacedSenderTest
Stats
)
{
static
constexpr
Timestamp
kStartTime
=
Timestamp
:
:
Millis
(
1234
)
;
GlobalSimulatedTimeController
time_controller
(
kStartTime
)
;
MockPacketRouter
packet_router
;
ScopedKeyValueConfig
trials
(
GetParam
(
)
)
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
time_controller
.
GetTaskQueueFactory
(
)
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
static
constexpr
size_t
kPacketsToSend
=
200
;
static
constexpr
DataRate
kPacingRate
=
DataRate
:
:
BytesPerSec
(
kDefaultPacketSize
*
kPacketsToSend
)
;
pacer
.
SetPacingRates
(
kPacingRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
static
constexpr
size_t
kAllowedPacketsDeviation
=
1
;
static
constexpr
DataSize
kAllowedQueueSizeDeviation
=
DataSize
:
:
Bytes
(
kDefaultPacketSize
*
kAllowedPacketsDeviation
)
;
static
constexpr
TimeDelta
kAllowedQueueTimeDeviation
=
kAllowedQueueSizeDeviation
/
kPacingRate
;
DataSize
expected_queue_size
=
DataSize
:
:
MinusInfinity
(
)
;
TimeDelta
expected_queue_time
=
TimeDelta
:
:
MinusInfinity
(
)
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
Times
(
kPacketsToSend
)
;
EXPECT_TRUE
(
pacer
.
OldestPacketWaitTime
(
)
.
IsZero
(
)
)
;
EXPECT_FALSE
(
pacer
.
FirstSentPacketTime
(
)
.
has_value
(
)
)
;
EXPECT_TRUE
(
pacer
.
QueueSizeData
(
)
.
IsZero
(
)
)
;
EXPECT_TRUE
(
pacer
.
ExpectedQueueTime
(
)
.
IsZero
(
)
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketsToSend
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
200
)
)
;
EXPECT_EQ
(
pacer
.
OldestPacketWaitTime
(
)
TimeDelta
:
:
Millis
(
200
)
)
;
EXPECT_EQ
(
pacer
.
FirstSentPacketTime
(
)
kStartTime
)
;
expected_queue_size
=
kPacingRate
*
TimeDelta
:
:
Millis
(
800
)
;
expected_queue_time
=
expected_queue_size
/
kPacingRate
;
EXPECT_NEAR
(
pacer
.
QueueSizeData
(
)
.
bytes
(
)
expected_queue_size
.
bytes
(
)
kAllowedQueueSizeDeviation
.
bytes
(
)
)
;
EXPECT_NEAR
(
pacer
.
ExpectedQueueTime
(
)
.
ms
(
)
expected_queue_time
.
ms
(
)
kAllowedQueueTimeDeviation
.
ms
(
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
300
)
)
;
EXPECT_EQ
(
pacer
.
OldestPacketWaitTime
(
)
TimeDelta
:
:
Millis
(
500
)
)
;
EXPECT_EQ
(
pacer
.
FirstSentPacketTime
(
)
kStartTime
)
;
expected_queue_size
=
kPacingRate
*
TimeDelta
:
:
Millis
(
500
)
;
expected_queue_time
=
expected_queue_size
/
kPacingRate
;
EXPECT_NEAR
(
pacer
.
QueueSizeData
(
)
.
bytes
(
)
expected_queue_size
.
bytes
(
)
kAllowedQueueSizeDeviation
.
bytes
(
)
)
;
EXPECT_NEAR
(
pacer
.
ExpectedQueueTime
(
)
.
ms
(
)
expected_queue_time
.
ms
(
)
kAllowedQueueTimeDeviation
.
ms
(
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
500
)
+
kAllowedQueueTimeDeviation
)
;
EXPECT_TRUE
(
pacer
.
OldestPacketWaitTime
(
)
.
IsZero
(
)
)
;
EXPECT_EQ
(
pacer
.
FirstSentPacketTime
(
)
kStartTime
)
;
EXPECT_TRUE
(
pacer
.
QueueSizeData
(
)
.
IsZero
(
)
)
;
EXPECT_TRUE
(
pacer
.
ExpectedQueueTime
(
)
.
IsZero
(
)
)
;
}
TEST
(
TaskQueuePacedSenderTest
HighPrecisionPacingWhenSlackIsDisabled
)
{
ScopedKeyValueConfig
trials
(
"
WebRTC
-
SlackedTaskQueuePacedSender
/
Disabled
/
"
)
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
TaskQueueWithFakePrecisionFactory
task_queue_factory
(
time_controller
.
GetTaskQueueFactory
(
)
)
;
MockPacketRouter
packet_router
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
&
task_queue_factory
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
static
constexpr
size_t
kPacketsToSend
=
42
;
static
constexpr
DataRate
kPacingRate
=
DataRate
:
:
BitsPerSec
(
kDefaultPacketSize
*
8
*
kPacketsToSend
)
;
pacer
.
SetPacingRates
(
kPacingRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketsToSend
)
)
;
size_t
packets_sent
=
0
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
WillRepeatedly
(
[
&
]
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
const
PacedPacketInfo
&
cluster_info
)
{
+
+
packets_sent
;
}
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
EXPECT_EQ
(
packets_sent
kPacketsToSend
)
;
EXPECT_EQ
(
task_queue_factory
.
delayed_low_precision_count
(
)
0
)
;
EXPECT_GT
(
task_queue_factory
.
delayed_high_precision_count
(
)
0
)
;
pacer
.
CreateProbeClusters
(
{
{
.
at_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
.
target_data_rate
=
kPacingRate
.
target_duration
=
TimeDelta
:
:
Millis
(
15
)
.
target_probe_count
=
4
.
id
=
123
}
}
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
1
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
EXPECT_EQ
(
task_queue_factory
.
delayed_low_precision_count
(
)
0
)
;
EXPECT_GT
(
task_queue_factory
.
delayed_high_precision_count
(
)
0
)
;
}
TEST
(
TaskQueuePacedSenderTest
LowPrecisionPacingWhenSlackIsEnabled
)
{
ScopedKeyValueConfig
trials
(
"
WebRTC
-
SlackedTaskQueuePacedSender
/
Enabled
/
"
)
;
GlobalSimulatedTimeController
time_controller
(
Timestamp
:
:
Millis
(
1234
)
)
;
TaskQueueWithFakePrecisionFactory
task_queue_factory
(
time_controller
.
GetTaskQueueFactory
(
)
)
;
MockPacketRouter
packet_router
;
TaskQueuePacedSender
pacer
(
time_controller
.
GetClock
(
)
&
packet_router
trials
&
task_queue_factory
PacingController
:
:
kMinSleepTime
TaskQueuePacedSender
:
:
kNoPacketHoldback
)
;
static
constexpr
size_t
kPacketsToSend
=
42
;
static
constexpr
DataRate
kPacingRate
=
DataRate
:
:
BitsPerSec
(
kDefaultPacketSize
*
8
*
kPacketsToSend
)
;
pacer
.
SetPacingRates
(
kPacingRate
DataRate
:
:
Zero
(
)
)
;
pacer
.
EnsureStarted
(
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
kPacketsToSend
)
)
;
size_t
packets_sent
=
0
;
EXPECT_CALL
(
packet_router
SendPacket
)
.
WillRepeatedly
(
[
&
]
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
const
PacedPacketInfo
&
cluster_info
)
{
+
+
packets_sent
;
}
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
EXPECT_EQ
(
packets_sent
kPacketsToSend
)
;
EXPECT_GT
(
task_queue_factory
.
delayed_low_precision_count
(
)
0
)
;
EXPECT_EQ
(
task_queue_factory
.
delayed_high_precision_count
(
)
0
)
;
pacer
.
CreateProbeClusters
(
{
{
.
at_time
=
time_controller
.
GetClock
(
)
-
>
CurrentTime
(
)
.
target_data_rate
=
kPacingRate
.
target_duration
=
TimeDelta
:
:
Millis
(
15
)
.
target_probe_count
=
4
.
id
=
123
}
}
)
;
pacer
.
EnqueuePackets
(
GeneratePackets
(
RtpPacketMediaType
:
:
kVideo
1
)
)
;
time_controller
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
EXPECT_GT
(
task_queue_factory
.
delayed_high_precision_count
(
)
0
)
;
}
}
}
