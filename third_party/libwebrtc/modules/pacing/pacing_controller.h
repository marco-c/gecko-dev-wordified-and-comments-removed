#
ifndef
MODULES_PACING_PACING_CONTROLLER_H_
#
define
MODULES_PACING_PACING_CONTROLLER_H_
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
<
atomic
>
#
include
<
memory
>
#
include
<
vector
>
#
include
"
absl
/
types
/
optional
.
h
"
#
include
"
api
/
function_view
.
h
"
#
include
"
api
/
rtc_event_log
/
rtc_event_log
.
h
"
#
include
"
api
/
transport
/
field_trial_based_config
.
h
"
#
include
"
api
/
transport
/
network_types
.
h
"
#
include
"
api
/
transport
/
webrtc_key_value_config
.
h
"
#
include
"
modules
/
pacing
/
bitrate_prober
.
h
"
#
include
"
modules
/
pacing
/
interval_budget
.
h
"
#
include
"
modules
/
pacing
/
round_robin_packet_queue
.
h
"
#
include
"
modules
/
pacing
/
rtp_packet_pacer
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
rtp_packet_sender
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
rtp_rtcp_defines
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_packet_to_send
.
h
"
#
include
"
rtc_base
/
experiments
/
field_trial_parser
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
namespace
webrtc
{
class
PacingController
{
public
:
enum
class
ProcessMode
{
kPeriodic
kDynamic
}
;
class
PacketSender
{
public
:
virtual
~
PacketSender
(
)
=
default
;
virtual
void
SendPacket
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
const
PacedPacketInfo
&
cluster_info
)
=
0
;
virtual
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
FetchFec
(
)
=
0
;
virtual
std
:
:
vector
<
std
:
:
unique_ptr
<
RtpPacketToSend
>
>
GeneratePadding
(
DataSize
size
)
=
0
;
}
;
static
const
TimeDelta
kMaxExpectedQueueLength
;
static
const
float
kDefaultPaceMultiplier
;
static
const
TimeDelta
kPausedProcessInterval
;
static
const
TimeDelta
kMinSleepTime
;
PacingController
(
Clock
*
clock
PacketSender
*
packet_sender
RtcEventLog
*
event_log
const
WebRtcKeyValueConfig
*
field_trials
ProcessMode
mode
)
;
~
PacingController
(
)
;
void
EnqueuePacket
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
)
;
void
CreateProbeCluster
(
DataRate
bitrate
int
cluster_id
)
;
void
Pause
(
)
;
void
Resume
(
)
;
bool
IsPaused
(
)
const
;
void
SetCongestionWindow
(
DataSize
congestion_window_size
)
;
void
UpdateOutstandingData
(
DataSize
outstanding_data
)
;
void
SetPacingRates
(
DataRate
pacing_rate
DataRate
padding_rate
)
;
void
SetAccountForAudioPackets
(
bool
account_for_audio
)
;
void
SetIncludeOverhead
(
)
;
void
SetTransportOverhead
(
DataSize
overhead_per_packet
)
;
TimeDelta
OldestPacketWaitTime
(
)
const
;
size_t
QueueSizePackets
(
)
const
;
DataSize
QueueSizeData
(
)
const
;
DataSize
CurrentBufferLevel
(
)
const
;
absl
:
:
optional
<
Timestamp
>
FirstSentPacketTime
(
)
const
;
TimeDelta
ExpectedQueueTime
(
)
const
;
void
SetQueueTimeLimit
(
TimeDelta
limit
)
;
void
SetProbingEnabled
(
bool
enabled
)
;
Timestamp
NextSendTime
(
)
const
;
void
ProcessPackets
(
)
;
bool
Congested
(
)
const
;
bool
IsProbing
(
)
const
;
private
:
void
EnqueuePacketInternal
(
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
int
priority
)
;
TimeDelta
UpdateTimeAndGetElapsed
(
Timestamp
now
)
;
bool
ShouldSendKeepalive
(
Timestamp
now
)
const
;
void
UpdateBudgetWithElapsedTime
(
TimeDelta
delta
)
;
void
UpdateBudgetWithSentData
(
DataSize
size
)
;
DataSize
PaddingToAdd
(
DataSize
recommended_probe_size
DataSize
data_sent
)
const
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
GetPendingPacket
(
const
PacedPacketInfo
&
pacing_info
Timestamp
target_send_time
Timestamp
now
)
;
void
OnPacketSent
(
RtpPacketMediaType
packet_type
DataSize
packet_size
Timestamp
send_time
)
;
void
OnPaddingSent
(
DataSize
padding_sent
)
;
Timestamp
CurrentTime
(
)
const
;
const
ProcessMode
mode_
;
Clock
*
const
clock_
;
PacketSender
*
const
packet_sender_
;
const
std
:
:
unique_ptr
<
FieldTrialBasedConfig
>
fallback_field_trials_
;
const
WebRtcKeyValueConfig
*
field_trials_
;
const
bool
drain_large_queues_
;
const
bool
send_padding_if_silent_
;
const
bool
pace_audio_
;
const
bool
ignore_transport_overhead_
;
const
TimeDelta
padding_target_duration_
;
TimeDelta
min_packet_limit_
;
DataSize
transport_overhead_per_packet_
;
mutable
Timestamp
last_timestamp_
;
bool
paused_
;
IntervalBudget
media_budget_
;
IntervalBudget
padding_budget_
;
DataSize
media_debt_
;
DataSize
padding_debt_
;
DataRate
media_rate_
;
DataRate
padding_rate_
;
BitrateProber
prober_
;
bool
probing_send_failure_
;
DataRate
pacing_bitrate_
;
Timestamp
last_process_time_
;
Timestamp
last_send_time_
;
absl
:
:
optional
<
Timestamp
>
first_sent_packet_time_
;
RoundRobinPacketQueue
packet_queue_
;
uint64_t
packet_counter_
;
DataSize
congestion_window_size_
;
DataSize
outstanding_data_
;
TimeDelta
queue_time_limit
;
bool
account_for_audio_
;
bool
include_overhead_
;
}
;
}
#
endif
