#
ifndef
MODULES_VIDEO_CAPTURE_MAIN_SOURCE_VIDEO_CAPTURE_IMPL_H_
#
define
MODULES_VIDEO_CAPTURE_MAIN_SOURCE_VIDEO_CAPTURE_IMPL_H_
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
video
/
video_frame
.
h
"
#
include
"
api
/
video
/
video_rotation
.
h
"
#
include
"
api
/
video
/
video_sink_interface
.
h
"
#
include
"
modules
/
video_capture
/
video_capture
.
h
"
#
include
"
modules
/
video_capture
/
video_capture_config
.
h
"
#
include
"
modules
/
video_capture
/
video_capture_defines
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
namespace
webrtc
{
namespace
videocapturemodule
{
class
VideoCaptureImpl
:
public
VideoCaptureModule
{
public
:
static
rtc
:
:
scoped_refptr
<
VideoCaptureModule
>
Create
(
const
char
*
deviceUniqueIdUTF8
)
;
static
DeviceInfo
*
CreateDeviceInfo
(
)
;
static
int32_t
RotationFromDegrees
(
int
degrees
VideoRotation
*
rotation
)
;
static
int32_t
RotationInDegrees
(
VideoRotation
rotation
int
*
degrees
)
;
void
RegisterCaptureDataCallback
(
rtc
:
:
VideoSinkInterface
<
VideoFrame
>
*
dataCallback
)
override
;
virtual
void
RegisterCaptureDataCallback
(
RawVideoSinkInterface
*
dataCallback
)
override
;
void
DeRegisterCaptureDataCallback
(
rtc
:
:
VideoSinkInterface
<
VideoFrame
>
*
dataCallback
)
override
;
int32_t
StopCaptureIfAllClientsClose
(
)
override
;
int32_t
SetCaptureRotation
(
VideoRotation
rotation
)
override
;
bool
SetApplyRotation
(
bool
enable
)
override
;
bool
GetApplyRotation
(
)
override
;
const
char
*
CurrentDeviceName
(
)
const
override
;
int32_t
IncomingFrame
(
uint8_t
*
videoFrame
size_t
videoFrameLength
const
VideoCaptureCapability
&
frameInfo
int64_t
captureTime
=
0
)
;
int32_t
StartCapture
(
const
VideoCaptureCapability
&
capability
)
override
;
int32_t
StopCapture
(
)
override
;
bool
CaptureStarted
(
)
override
;
int32_t
CaptureSettings
(
VideoCaptureCapability
&
)
override
;
protected
:
VideoCaptureImpl
(
)
;
~
VideoCaptureImpl
(
)
override
;
int32_t
DeliverCapturedFrame
(
VideoFrame
&
captureFrame
)
;
char
*
_deviceUniqueId
;
Mutex
api_lock_
;
VideoCaptureCapability
_requestedCapability
;
private
:
void
UpdateFrameCount
(
)
;
uint32_t
CalculateFrameRate
(
int64_t
now_ns
)
;
void
DeliverRawFrame
(
uint8_t
*
videoFrame
size_t
videoFrameLength
const
VideoCaptureCapability
&
frameInfo
int64_t
captureTime
)
;
int64_t
_lastProcessTimeNanos
;
int64_t
_lastFrameRateCallbackTimeNanos
;
std
:
:
set
<
rtc
:
:
VideoSinkInterface
<
VideoFrame
>
*
>
_dataCallBacks
;
RawVideoSinkInterface
*
_rawDataCallBack
;
int64_t
_lastProcessFrameTimeNanos
;
int64_t
_incomingFrameTimesNanos
[
kFrameRateCountHistorySize
]
;
VideoRotation
_rotateFrame
;
bool
apply_rotation_
;
}
;
}
}
#
endif
