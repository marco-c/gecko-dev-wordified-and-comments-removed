#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_dependency_descriptor_extension
.
h
"
#
include
<
bitset
>
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
cstring
>
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
transport
/
rtp
/
dependency_descriptor
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
using
:
:
testing
:
:
Each
;
TEST
(
RtpDependencyDescriptorExtensionTest
Writer3BytesForPerfectTemplate
)
{
uint8_t
buffer
[
3
]
;
FrameDependencyStructure
structure
;
structure
.
num_decode_targets
=
2
;
structure
.
num_chains
=
2
;
structure
.
templates
=
{
FrameDependencyTemplate
(
)
.
Dtis
(
"
SR
"
)
.
FrameDiffs
(
{
1
}
)
.
ChainDiffs
(
{
2
2
}
)
}
;
DependencyDescriptor
descriptor
;
descriptor
.
frame_dependencies
=
structure
.
templates
[
0
]
;
EXPECT_EQ
(
RtpDependencyDescriptorExtension
:
:
ValueSize
(
structure
descriptor
)
3u
)
;
EXPECT_TRUE
(
RtpDependencyDescriptorExtension
:
:
Write
(
buffer
structure
descriptor
)
)
;
}
TEST
(
RtpDependencyDescriptorExtensionTest
WriteZeroInUnusedBits
)
{
uint8_t
buffer
[
32
]
;
std
:
:
memset
(
buffer
0xff
sizeof
(
buffer
)
)
;
FrameDependencyStructure
structure
;
structure
.
num_decode_targets
=
2
;
structure
.
num_chains
=
2
;
structure
.
templates
=
{
FrameDependencyTemplate
(
)
.
Dtis
(
"
SR
"
)
.
FrameDiffs
(
{
1
}
)
.
ChainDiffs
(
{
1
1
}
)
}
;
DependencyDescriptor
descriptor
;
descriptor
.
frame_dependencies
=
structure
.
templates
[
0
]
;
descriptor
.
frame_dependencies
.
frame_diffs
=
{
2
}
;
size_t
value_size
=
RtpDependencyDescriptorExtension
:
:
ValueSize
(
structure
descriptor
)
;
ASSERT_LT
(
value_size
sizeof
(
buffer
)
)
;
ASSERT_TRUE
(
RtpDependencyDescriptorExtension
:
:
Write
(
buffer
structure
descriptor
)
)
;
const
uint8_t
*
unused_bytes
=
buffer
+
value_size
;
size_t
num_unused_bytes
=
buffer
+
sizeof
(
buffer
)
-
unused_bytes
;
EXPECT_THAT
(
MakeArrayView
(
unused_bytes
num_unused_bytes
)
Each
(
0
)
)
;
}
TEST
(
RtpDependencyDescriptorExtensionTest
TemplateMatchingSkipsInactiveChains
)
{
uint8_t
buffer
[
3
]
;
FrameDependencyStructure
structure
;
structure
.
num_decode_targets
=
2
;
structure
.
num_chains
=
2
;
structure
.
templates
=
{
FrameDependencyTemplate
(
)
.
Dtis
(
"
SR
"
)
.
ChainDiffs
(
{
2
2
}
)
}
;
DependencyDescriptor
descriptor
;
descriptor
.
frame_dependencies
=
structure
.
templates
[
0
]
;
std
:
:
bitset
<
32
>
active_chains
=
0b01
;
descriptor
.
frame_dependencies
.
chain_diffs
[
1
]
=
1000
;
EXPECT_EQ
(
RtpDependencyDescriptorExtension
:
:
ValueSize
(
structure
active_chains
descriptor
)
3u
)
;
EXPECT_TRUE
(
RtpDependencyDescriptorExtension
:
:
Write
(
buffer
structure
active_chains
descriptor
)
)
;
}
TEST
(
RtpDependencyDescriptorExtensionTest
AcceptsInvalidChainDiffForInactiveChainWhenChainsAreCustom
)
{
uint8_t
buffer
[
256
]
;
FrameDependencyStructure
structure
;
structure
.
num_decode_targets
=
2
;
structure
.
num_chains
=
2
;
structure
.
templates
=
{
FrameDependencyTemplate
(
)
.
Dtis
(
"
SR
"
)
.
ChainDiffs
(
{
2
2
}
)
}
;
DependencyDescriptor
descriptor
;
descriptor
.
frame_dependencies
=
structure
.
templates
[
0
]
;
std
:
:
bitset
<
32
>
active_chains
=
0b01
;
descriptor
.
frame_dependencies
.
chain_diffs
[
0
]
=
1
;
descriptor
.
frame_dependencies
.
chain_diffs
[
1
]
=
1000
;
EXPECT_GT
(
RtpDependencyDescriptorExtension
:
:
ValueSize
(
structure
active_chains
descriptor
)
3u
)
;
EXPECT_TRUE
(
RtpDependencyDescriptorExtension
:
:
Write
(
buffer
structure
active_chains
descriptor
)
)
;
}
TEST
(
RtpDependencyDescriptorExtensionTest
FailsToWriteInvalidDescriptor
)
{
uint8_t
buffer
[
256
]
;
FrameDependencyStructure
structure
;
structure
.
num_decode_targets
=
2
;
structure
.
num_chains
=
2
;
structure
.
templates
=
{
FrameDependencyTemplate
(
)
.
T
(
0
)
.
Dtis
(
"
SR
"
)
.
ChainDiffs
(
{
2
2
}
)
}
;
DependencyDescriptor
descriptor
;
descriptor
.
frame_dependencies
=
structure
.
templates
[
0
]
;
descriptor
.
frame_dependencies
.
temporal_id
=
1
;
EXPECT_EQ
(
RtpDependencyDescriptorExtension
:
:
ValueSize
(
structure
0b11
descriptor
)
0u
)
;
EXPECT_FALSE
(
RtpDependencyDescriptorExtension
:
:
Write
(
buffer
structure
0b11
descriptor
)
)
;
}
TEST
(
RtpDependencyDescriptorExtensionTest
FailsToWriteWhenNumberOfChainsMismatch
)
{
uint8_t
buffer
[
256
]
;
FrameDependencyStructure
structure
;
structure
.
num_decode_targets
=
2
;
structure
.
num_chains
=
2
;
structure
.
templates
=
{
FrameDependencyTemplate
(
)
.
T
(
0
)
.
Dtis
(
"
SR
"
)
.
ChainDiffs
(
{
2
2
}
)
}
;
DependencyDescriptor
descriptor
;
descriptor
.
frame_dependencies
=
structure
.
templates
[
0
]
;
descriptor
.
frame_dependencies
.
chain_diffs
=
{
2
}
;
EXPECT_EQ
(
RtpDependencyDescriptorExtension
:
:
ValueSize
(
structure
0b11
descriptor
)
0u
)
;
EXPECT_FALSE
(
RtpDependencyDescriptorExtension
:
:
Write
(
buffer
structure
0b11
descriptor
)
)
;
}
TEST
(
RtpDependencyDescriptorExtensionTest
FailsToWriteWhenNumberOfDecodeTargetsMismatch
)
{
uint8_t
buffer
[
256
]
;
FrameDependencyStructure
structure
;
structure
.
num_decode_targets
=
2
;
structure
.
num_chains
=
2
;
structure
.
templates
=
{
FrameDependencyTemplate
(
)
.
T
(
0
)
.
Dtis
(
"
SR
"
)
.
ChainDiffs
(
{
2
2
}
)
}
;
DependencyDescriptor
descriptor
;
descriptor
.
frame_dependencies
=
structure
.
templates
[
0
]
;
descriptor
.
frame_dependencies
.
decode_target_indications
=
{
DecodeTargetIndication
:
:
kSwitch
}
;
EXPECT_EQ
(
RtpDependencyDescriptorExtension
:
:
ValueSize
(
structure
0b11
descriptor
)
0u
)
;
EXPECT_FALSE
(
RtpDependencyDescriptorExtension
:
:
Write
(
buffer
structure
0b11
descriptor
)
)
;
}
}
}
