#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_format_vp8
.
h
"
#
include
<
cstddef
>
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_format
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_format_vp8_test_helper
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp8
/
include
/
vp8_globals
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
constexpr
RtpPacketizer
:
:
PayloadSizeLimits
kNoSizeLimits
;
TEST
(
RtpPacketizerVp8Test
EmptyPayload
)
{
RTPVideoHeaderVP8
hdr_info
;
hdr_info
.
InitRTPVideoHeaderVP8
(
)
;
hdr_info
.
pictureId
=
200
;
RtpFormatVp8TestHelper
helper
(
&
hdr_info
30
)
;
RtpPacketizer
:
:
PayloadSizeLimits
limits
;
limits
.
max_payload_len
=
12
;
RtpPacketizerVp8
packetizer
(
{
}
limits
hdr_info
)
;
EXPECT_EQ
(
packetizer
.
NumPackets
(
)
0u
)
;
}
TEST
(
RtpPacketizerVp8Test
ResultPacketsAreAlmostEqualSize
)
{
RTPVideoHeaderVP8
hdr_info
;
hdr_info
.
InitRTPVideoHeaderVP8
(
)
;
hdr_info
.
pictureId
=
200
;
RtpFormatVp8TestHelper
helper
(
&
hdr_info
30
)
;
RtpPacketizer
:
:
PayloadSizeLimits
limits
;
limits
.
max_payload_len
=
12
;
RtpPacketizerVp8
packetizer
(
helper
.
payload
(
)
limits
hdr_info
)
;
const
size_t
kExpectedSizes
[
]
=
{
11
11
12
12
}
;
helper
.
GetAllPacketsAndCheck
(
&
packetizer
kExpectedSizes
)
;
}
TEST
(
RtpPacketizerVp8Test
EqualSizeWithLastPacketReduction
)
{
RTPVideoHeaderVP8
hdr_info
;
hdr_info
.
InitRTPVideoHeaderVP8
(
)
;
hdr_info
.
pictureId
=
200
;
RtpFormatVp8TestHelper
helper
(
&
hdr_info
43
)
;
RtpPacketizer
:
:
PayloadSizeLimits
limits
;
limits
.
max_payload_len
=
15
;
limits
.
last_packet_reduction_len
=
5
;
RtpPacketizerVp8
packetizer
(
helper
.
payload
(
)
limits
hdr_info
)
;
const
size_t
kExpectedSizes
[
]
=
{
13
13
14
14
9
}
;
helper
.
GetAllPacketsAndCheck
(
&
packetizer
kExpectedSizes
)
;
}
TEST
(
RtpPacketizerVp8Test
NonReferenceBit
)
{
RTPVideoHeaderVP8
hdr_info
;
hdr_info
.
InitRTPVideoHeaderVP8
(
)
;
hdr_info
.
nonReference
=
true
;
RtpFormatVp8TestHelper
helper
(
&
hdr_info
30
)
;
RtpPacketizer
:
:
PayloadSizeLimits
limits
;
limits
.
max_payload_len
=
25
;
RtpPacketizerVp8
packetizer
(
helper
.
payload
(
)
limits
hdr_info
)
;
const
size_t
kExpectedSizes
[
]
=
{
16
16
}
;
helper
.
GetAllPacketsAndCheck
(
&
packetizer
kExpectedSizes
)
;
}
TEST
(
RtpPacketizerVp8Test
Tl0PicIdxAndTID
)
{
RTPVideoHeaderVP8
hdr_info
;
hdr_info
.
InitRTPVideoHeaderVP8
(
)
;
hdr_info
.
tl0PicIdx
=
117
;
hdr_info
.
temporalIdx
=
2
;
hdr_info
.
layerSync
=
true
;
RtpFormatVp8TestHelper
helper
(
&
hdr_info
30
)
;
RtpPacketizerVp8
packetizer
(
helper
.
payload
(
)
kNoSizeLimits
hdr_info
)
;
const
size_t
kExpectedSizes
[
1
]
=
{
helper
.
payload_size
(
)
+
4
}
;
helper
.
GetAllPacketsAndCheck
(
&
packetizer
kExpectedSizes
)
;
}
TEST
(
RtpPacketizerVp8Test
KeyIdx
)
{
RTPVideoHeaderVP8
hdr_info
;
hdr_info
.
InitRTPVideoHeaderVP8
(
)
;
hdr_info
.
keyIdx
=
17
;
RtpFormatVp8TestHelper
helper
(
&
hdr_info
30
)
;
RtpPacketizerVp8
packetizer
(
helper
.
payload
(
)
kNoSizeLimits
hdr_info
)
;
const
size_t
kExpectedSizes
[
1
]
=
{
helper
.
payload_size
(
)
+
3
}
;
helper
.
GetAllPacketsAndCheck
(
&
packetizer
kExpectedSizes
)
;
}
TEST
(
RtpPacketizerVp8Test
TIDAndKeyIdx
)
{
RTPVideoHeaderVP8
hdr_info
;
hdr_info
.
InitRTPVideoHeaderVP8
(
)
;
hdr_info
.
temporalIdx
=
1
;
hdr_info
.
keyIdx
=
5
;
RtpFormatVp8TestHelper
helper
(
&
hdr_info
30
)
;
RtpPacketizerVp8
packetizer
(
helper
.
payload
(
)
kNoSizeLimits
hdr_info
)
;
const
size_t
kExpectedSizes
[
1
]
=
{
helper
.
payload_size
(
)
+
3
}
;
helper
.
GetAllPacketsAndCheck
(
&
packetizer
kExpectedSizes
)
;
}
}
}
