#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_packet_history
.
h
"
#
include
<
memory
>
#
include
<
utility
>
#
include
"
modules
/
rtp_rtcp
/
include
/
rtp_rtcp_defines
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_packet_to_send
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
constexpr
uint16_t
kStartSeqNum
=
65534u
;
uint16_t
To16u
(
size_t
sequence_number
)
{
return
static_cast
<
uint16_t
>
(
sequence_number
&
0xFFFF
)
;
}
}
using
StorageMode
=
RtpPacketHistory
:
:
StorageMode
;
class
RtpPacketHistoryTest
:
public
:
:
testing
:
:
TestWithParam
<
bool
>
{
protected
:
RtpPacketHistoryTest
(
)
:
fake_clock_
(
123456
)
hist_
(
&
fake_clock_
GetParam
(
)
)
{
}
SimulatedClock
fake_clock_
;
RtpPacketHistory
hist_
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
CreateRtpPacket
(
uint16_t
seq_num
)
{
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
(
new
RtpPacketToSend
(
nullptr
)
)
;
packet
-
>
SetSequenceNumber
(
seq_num
)
;
packet
-
>
set_capture_time
(
fake_clock_
.
CurrentTime
(
)
)
;
packet
-
>
set_allow_retransmission
(
true
)
;
return
packet
;
}
}
;
TEST_P
(
RtpPacketHistoryTest
SetStoreStatus
)
{
EXPECT_EQ
(
StorageMode
:
:
kDisabled
hist_
.
GetStorageMode
(
)
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
EXPECT_EQ
(
StorageMode
:
:
kStoreAndCull
hist_
.
GetStorageMode
(
)
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
EXPECT_EQ
(
StorageMode
:
:
kStoreAndCull
hist_
.
GetStorageMode
(
)
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kDisabled
0
)
;
EXPECT_EQ
(
StorageMode
:
:
kDisabled
hist_
.
GetStorageMode
(
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
ClearsHistoryAfterSetStoreStatus
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
absl
:
:
nullopt
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
StartSeqResetAfterReset
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
absl
:
:
nullopt
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
1
)
)
absl
:
:
nullopt
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
RtpPacketHistory
:
:
kPacketCullingDelayFactor
*
RtpPacketHistory
:
:
kMinPacketDurationMs
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
2
)
)
absl
:
:
nullopt
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
2
)
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
NoStoreStatus
)
{
EXPECT_EQ
(
StorageMode
:
:
kDisabled
hist_
.
GetStorageMode
(
)
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
absl
:
:
nullopt
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
GetRtpPacket_NotStored
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
0
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
PutRtpPacket
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
absl
:
:
nullopt
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
GetRtpPacket
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
Timestamp
capture_time
=
Timestamp
:
:
Millis
(
1
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
packet
-
>
set_capture_time
(
capture_time
)
;
rtc
:
:
CopyOnWriteBuffer
buffer
=
packet
-
>
Buffer
(
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
absl
:
:
nullopt
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet_out
=
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
;
EXPECT_TRUE
(
packet_out
)
;
EXPECT_EQ
(
buffer
packet_out
-
>
Buffer
(
)
)
;
EXPECT_EQ
(
capture_time
packet_out
-
>
capture_time
(
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
PacketStateIsCorrect
)
{
const
uint32_t
kSsrc
=
92384762
;
const
int64_t
kRttMs
=
100
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
hist_
.
SetRtt
(
kRttMs
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
packet
-
>
SetSsrc
(
kSsrc
)
;
packet
-
>
SetPayloadSize
(
1234
)
;
const
size_t
packet_size
=
packet
-
>
size
(
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
absl
:
:
optional
<
RtpPacketHistory
:
:
PacketState
>
state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_TRUE
(
state
)
;
EXPECT_EQ
(
state
-
>
rtp_sequence_number
kStartSeqNum
)
;
EXPECT_EQ
(
state
-
>
send_time_ms
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_EQ
(
state
-
>
capture_time_ms
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_EQ
(
state
-
>
ssrc
kSsrc
)
;
EXPECT_EQ
(
state
-
>
packet_size
packet_size
)
;
EXPECT_EQ
(
state
-
>
times_retransmitted
0u
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kRttMs
+
1
)
;
state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_TRUE
(
state
)
;
EXPECT_EQ
(
state
-
>
times_retransmitted
1u
)
;
}
TEST_P
(
RtpPacketHistoryTest
MinResendTimeWithPacer
)
{
static
const
int64_t
kMinRetransmitIntervalMs
=
100
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
hist_
.
SetRtt
(
kMinRetransmitIntervalMs
)
;
int64_t
capture_time_ms
=
fake_clock_
.
TimeInMilliseconds
(
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
size_t
len
=
packet
-
>
size
(
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
absl
:
:
nullopt
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
absl
:
:
optional
<
RtpPacketHistory
:
:
PacketState
>
packet_state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
EXPECT_TRUE
(
packet_state
)
;
EXPECT_EQ
(
len
packet_state
-
>
packet_size
)
;
EXPECT_EQ
(
capture_time_ms
packet_state
-
>
capture_time_ms
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kMinRetransmitIntervalMs
-
1
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
MinResendTimeWithoutPacer
)
{
static
const
int64_t
kMinRetransmitIntervalMs
=
100
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
hist_
.
SetRtt
(
kMinRetransmitIntervalMs
)
;
Timestamp
capture_time
=
fake_clock_
.
CurrentTime
(
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
size_t
len
=
packet
-
>
size
(
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
packet
=
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
;
EXPECT_TRUE
(
packet
)
;
EXPECT_EQ
(
len
packet
-
>
size
(
)
)
;
EXPECT_EQ
(
packet
-
>
capture_time
(
)
capture_time
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kMinRetransmitIntervalMs
-
1
)
;
EXPECT_FALSE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
RemovesOldestSentPacketWhenAtMaxSize
)
{
const
size_t
kMaxNumPackets
=
10
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
kMaxNumPackets
)
;
const
int64_t
kPacketIntervalMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
/
kMaxNumPackets
;
for
(
size_t
i
=
0
;
i
<
kMaxNumPackets
;
+
+
i
)
{
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
i
)
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kPacketIntervalMs
)
;
}
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
kMaxNumPackets
)
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
RemovesOldestPacketWhenAtMaxCapacity
)
{
const
size_t
kMaxNumPackets
=
RtpPacketHistory
:
:
kMaxCapacity
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
RtpPacketHistory
:
:
kMaxCapacity
)
;
for
(
size_t
i
=
0
;
i
<
kMaxNumPackets
;
+
+
i
)
{
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
i
)
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
absl
:
:
nullopt
)
;
}
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
kMaxNumPackets
)
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
RemovesLowestPrioPaddingWhenAtMaxCapacity
)
{
if
(
!
GetParam
(
)
)
{
return
;
}
const
size_t
kMaxNumPackets
=
RtpPacketHistory
:
:
kMaxPaddingHistory
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
kMaxNumPackets
*
2
)
;
hist_
.
SetRtt
(
1
)
;
for
(
size_t
i
=
0
;
i
<
kMaxNumPackets
+
1
;
+
+
i
)
{
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
i
)
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
}
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
for
(
size_t
i
=
kMaxNumPackets
-
1
;
i
>
0
;
-
-
i
)
{
auto
packet
=
hist_
.
GetPayloadPaddingPacket
(
)
;
ASSERT_TRUE
(
packet
)
;
EXPECT_EQ
(
packet
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
i
+
1
)
)
;
}
auto
packet
=
hist_
.
GetPayloadPaddingPacket
(
)
;
ASSERT_TRUE
(
packet
)
;
EXPECT_EQ
(
packet
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
kMaxNumPackets
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
DontRemoveUnsentPackets
)
{
const
size_t
kMaxNumPackets
=
10
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
kMaxNumPackets
)
;
for
(
size_t
i
=
0
;
i
<
kMaxNumPackets
;
+
+
i
)
{
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
i
)
)
absl
:
:
nullopt
)
;
}
fake_clock_
.
AdvanceTimeMilliseconds
(
RtpPacketHistory
:
:
kMinPacketDurationMs
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
kMaxNumPackets
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
for
(
size_t
i
=
0
;
i
<
=
kMaxNumPackets
;
+
+
i
)
{
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
To16u
(
kStartSeqNum
+
i
)
)
)
;
}
fake_clock_
.
AdvanceTimeMilliseconds
(
RtpPacketHistory
:
:
kMinPacketDurationMs
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
kMaxNumPackets
+
1
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
2
)
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
DontRemoveTooRecentlyTransmittedPackets
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
RtpPacketHistory
:
:
kMinPacketDurationMs
-
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
1
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
2
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
DontRemoveTooRecentlyTransmittedPacketsHighRtt
)
{
const
int64_t
kRttMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
2
;
const
int64_t
kPacketTimeoutMs
=
kRttMs
*
RtpPacketHistory
:
:
kMinPacketDurationRtt
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
SetRtt
(
kRttMs
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kPacketTimeoutMs
-
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
1
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
2
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
RemovesOldWithCulling
)
{
const
size_t
kMaxNumPackets
=
10
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
kMaxNumPackets
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
int64_t
kMaxPacketDurationMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
RtpPacketHistory
:
:
kPacketCullingDelayFactor
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kMaxPacketDurationMs
-
1
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
1
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
RemovesOldWithCullingHighRtt
)
{
const
size_t
kMaxNumPackets
=
10
;
const
int64_t
kRttMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
2
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
kMaxNumPackets
)
;
hist_
.
SetRtt
(
kRttMs
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
int64_t
kMaxPacketDurationMs
=
kRttMs
*
RtpPacketHistory
:
:
kMinPacketDurationRtt
*
RtpPacketHistory
:
:
kPacketCullingDelayFactor
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kMaxPacketDurationMs
-
1
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
1
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
CullWithAcks
)
{
const
int64_t
kPacketLifetime
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
RtpPacketHistory
:
:
kPacketCullingDelayFactor
;
const
int64_t
start_time
=
fake_clock_
.
TimeInMilliseconds
(
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
packet
-
>
SetPayloadSize
(
50
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
33
)
;
packet
=
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
1
)
)
;
packet
-
>
SetPayloadSize
(
50
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
GetPacketAndSetSendTime
(
To16u
(
kStartSeqNum
+
1
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
33
)
;
packet
=
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
2
)
)
;
packet
-
>
SetPayloadSize
(
50
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
GetPacketAndSetSendTime
(
To16u
(
kStartSeqNum
+
2
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
.
has_value
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
.
has_value
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
2
)
)
.
has_value
(
)
)
;
std
:
:
vector
<
uint16_t
>
acked_sequence_numbers
=
{
To16u
(
kStartSeqNum
+
1
)
}
;
hist_
.
CullAcknowledgedPackets
(
acked_sequence_numbers
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
.
has_value
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
.
has_value
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
2
)
)
.
has_value
(
)
)
;
int64_t
second_packet_expiry_time
=
start_time
+
kPacketLifetime
+
33
+
1
;
fake_clock_
.
AdvanceTimeMilliseconds
(
second_packet_expiry_time
-
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
SetRtt
(
1
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
.
has_value
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
.
has_value
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
2
)
)
.
has_value
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
33
)
;
hist_
.
SetRtt
(
1
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
.
has_value
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
1
)
)
.
has_value
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketState
(
To16u
(
kStartSeqNum
+
2
)
)
.
has_value
(
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
SetsPendingTransmissionState
)
{
const
int64_t
kRttMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
2
;
hist_
.
SetRtt
(
kRttMs
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
absl
:
:
nullopt
)
;
absl
:
:
optional
<
RtpPacketHistory
:
:
PacketState
>
packet_state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_TRUE
(
packet_state
.
has_value
(
)
)
;
EXPECT_TRUE
(
packet_state
-
>
pending_transmission
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
packet_state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_TRUE
(
packet_state
.
has_value
(
)
)
;
EXPECT_FALSE
(
packet_state
-
>
pending_transmission
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kRttMs
)
;
EXPECT_TRUE
(
hist_
.
SetPendingTransmission
(
kStartSeqNum
)
)
;
packet_state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_TRUE
(
packet_state
.
has_value
(
)
)
;
EXPECT_TRUE
(
packet_state
-
>
pending_transmission
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
ASSERT_FALSE
(
hist_
.
GetPacketState
(
kStartSeqNum
)
.
has_value
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kRttMs
)
;
packet_state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_TRUE
(
packet_state
.
has_value
(
)
)
;
EXPECT_FALSE
(
packet_state
-
>
pending_transmission
)
;
}
TEST_P
(
RtpPacketHistoryTest
GetPacketAndSetSent
)
{
const
int64_t
kRttMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
2
;
hist_
.
SetRtt
(
kRttMs
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMicroseconds
(
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kRttMs
)
;
EXPECT_FALSE
(
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
)
)
;
hist_
.
MarkPacketAsSent
(
kStartSeqNum
)
;
EXPECT_FALSE
(
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kRttMs
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
GetPacketWithEncapsulation
)
{
const
uint32_t
kSsrc
=
92384762
;
const
int64_t
kRttMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
2
;
hist_
.
SetRtt
(
kRttMs
)
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
kStartSeqNum
)
;
packet
-
>
SetSsrc
(
kSsrc
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMicroseconds
(
)
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
retransmit_packet
=
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
[
]
(
const
RtpPacketToSend
&
packet
)
{
auto
encapsulated_packet
=
std
:
:
make_unique
<
RtpPacketToSend
>
(
packet
)
;
encapsulated_packet
-
>
SetSsrc
(
packet
.
Ssrc
(
)
+
1
)
;
return
encapsulated_packet
;
}
)
;
ASSERT_TRUE
(
retransmit_packet
)
;
EXPECT_EQ
(
retransmit_packet
-
>
Ssrc
(
)
kSsrc
+
1
)
;
}
TEST_P
(
RtpPacketHistoryTest
GetPacketWithEncapsulationAbortOnNullptr
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMicroseconds
(
)
)
;
EXPECT_FALSE
(
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
[
]
(
const
RtpPacketToSend
&
)
{
return
nullptr
;
}
)
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
DontRemovePendingTransmissions
)
{
const
int64_t
kRttMs
=
RtpPacketHistory
:
:
kMinPacketDurationMs
*
2
;
const
int64_t
kPacketTimeoutMs
=
kRttMs
*
RtpPacketHistory
:
:
kMinPacketDurationRtt
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
SetRtt
(
kRttMs
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
kPacketTimeoutMs
-
1
)
;
EXPECT_TRUE
(
hist_
.
SetPendingTransmission
(
kStartSeqNum
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
absl
:
:
optional
<
RtpPacketHistory
:
:
PacketState
>
packet_state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_TRUE
(
packet_state
.
has_value
(
)
)
;
EXPECT_TRUE
(
packet_state
-
>
pending_transmission
)
;
EXPECT_TRUE
(
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
)
;
hist_
.
SetRtt
(
kRttMs
)
;
packet_state
=
hist_
.
GetPacketState
(
kStartSeqNum
)
;
ASSERT_FALSE
(
packet_state
.
has_value
(
)
)
;
}
TEST_P
(
RtpPacketHistoryTest
PrioritizedPayloadPadding
)
{
if
(
!
GetParam
(
)
)
{
return
;
}
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
+
1
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
kStartSeqNum
+
1
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
kStartSeqNum
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
kStartSeqNum
+
1
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
kStartSeqNum
)
;
hist_
.
CullAcknowledgedPackets
(
std
:
:
vector
<
uint16_t
>
{
kStartSeqNum
+
1
}
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
kStartSeqNum
)
;
hist_
.
CullAcknowledgedPackets
(
std
:
:
vector
<
uint16_t
>
{
kStartSeqNum
}
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
nullptr
)
;
}
TEST_P
(
RtpPacketHistoryTest
NoPendingPacketAsPadding
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
kStartSeqNum
)
;
hist_
.
SetPendingTransmission
(
kStartSeqNum
)
;
EXPECT_EQ
(
nullptr
hist_
.
GetPayloadPaddingPacket
(
)
)
;
hist_
.
GetPacketAndSetSendTime
(
kStartSeqNum
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
kStartSeqNum
)
;
}
TEST_P
(
RtpPacketHistoryTest
PayloadPaddingWithEncapsulation
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
1
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
EXPECT_EQ
(
nullptr
hist_
.
GetPayloadPaddingPacket
(
[
]
(
const
RtpPacketToSend
&
)
{
return
nullptr
;
}
)
)
;
auto
padding_packet
=
hist_
.
GetPayloadPaddingPacket
(
[
&
]
(
const
RtpPacketToSend
&
packet
)
{
auto
encapsulated_packet
=
std
:
:
make_unique
<
RtpPacketToSend
>
(
packet
)
;
encapsulated_packet
-
>
SetSequenceNumber
(
kStartSeqNum
+
1
)
;
return
encapsulated_packet
;
}
)
;
ASSERT_TRUE
(
padding_packet
)
;
EXPECT_EQ
(
padding_packet
-
>
SequenceNumber
(
)
kStartSeqNum
+
1
)
;
}
TEST_P
(
RtpPacketHistoryTest
NackAfterAckIsNoop
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
2
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
kStartSeqNum
+
1
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
CullAcknowledgedPackets
(
std
:
:
vector
<
uint16_t
>
{
kStartSeqNum
+
1
}
)
;
auto
packet
=
hist_
.
GetPacketAndMarkAsPending
(
kStartSeqNum
+
1
)
;
EXPECT_EQ
(
packet
.
get
(
)
nullptr
)
;
}
TEST_P
(
RtpPacketHistoryTest
OutOfOrderInsertRemoval
)
{
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
10
)
;
const
int
seq_offsets
[
]
=
{
0
1
-
1
2
-
2
3
-
3
}
;
const
int64_t
start_time_ms
=
fake_clock_
.
TimeInMilliseconds
(
)
;
for
(
int
offset
:
seq_offsets
)
{
uint16_t
seq_no
=
To16u
(
kStartSeqNum
+
offset
)
;
std
:
:
unique_ptr
<
RtpPacketToSend
>
packet
=
CreateRtpPacket
(
seq_no
)
;
packet
-
>
SetPayloadSize
(
50
)
;
hist_
.
PutRtpPacket
(
std
:
:
move
(
packet
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
GetPacketAndSetSendTime
(
seq_no
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
33
)
;
}
int64_t
expected_time_offset_ms
=
0
;
for
(
int
offset
:
seq_offsets
)
{
uint16_t
seq_no
=
To16u
(
kStartSeqNum
+
offset
)
;
absl
:
:
optional
<
RtpPacketHistory
:
:
PacketState
>
packet_state
=
hist_
.
GetPacketState
(
seq_no
)
;
ASSERT_TRUE
(
packet_state
.
has_value
(
)
)
;
EXPECT_EQ
(
packet_state
-
>
send_time_ms
start_time_ms
+
expected_time_offset_ms
)
;
std
:
:
vector
<
uint16_t
>
acked_sequence_numbers
=
{
seq_no
}
;
hist_
.
CullAcknowledgedPackets
(
acked_sequence_numbers
)
;
expected_time_offset_ms
+
=
33
;
}
}
TEST_P
(
RtpPacketHistoryTest
UsesLastPacketAsPaddingWithPrioOff
)
{
if
(
GetParam
(
)
)
{
return
;
}
const
size_t
kHistorySize
=
10
;
hist_
.
SetStorePacketsStatus
(
StorageMode
:
:
kStoreAndCull
kHistorySize
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
nullptr
)
;
for
(
size_t
i
=
0
;
i
<
kHistorySize
;
+
+
i
)
{
hist_
.
PutRtpPacket
(
CreateRtpPacket
(
To16u
(
kStartSeqNum
+
i
)
)
fake_clock_
.
TimeInMilliseconds
(
)
)
;
hist_
.
MarkPacketAsSent
(
To16u
(
kStartSeqNum
+
i
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
1
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
i
)
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
i
)
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
i
)
)
;
}
for
(
size_t
i
=
kHistorySize
-
1
;
i
>
0
;
-
-
i
)
{
hist_
.
CullAcknowledgedPackets
(
std
:
:
vector
<
uint16_t
>
{
To16u
(
kStartSeqNum
+
i
)
}
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
i
-
1
)
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
i
-
1
)
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
-
>
SequenceNumber
(
)
To16u
(
kStartSeqNum
+
i
-
1
)
)
;
}
hist_
.
CullAcknowledgedPackets
(
std
:
:
vector
<
uint16_t
>
{
kStartSeqNum
}
)
;
EXPECT_EQ
(
hist_
.
GetPayloadPaddingPacket
(
)
nullptr
)
;
}
INSTANTIATE_TEST_SUITE_P
(
WithAndWithoutPaddingPrio
RtpPacketHistoryTest
:
:
testing
:
:
Bool
(
)
)
;
}
