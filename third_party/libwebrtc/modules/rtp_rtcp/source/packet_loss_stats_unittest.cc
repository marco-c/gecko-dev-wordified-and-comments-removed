#
include
"
modules
/
rtp_rtcp
/
source
/
packet_loss_stats
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
class
PacketLossStatsTest
:
public
:
:
testing
:
:
Test
{
protected
:
PacketLossStats
stats_
;
}
;
TEST_F
(
PacketLossStatsTest
EveryOtherPacket
)
{
for
(
int
i
=
0
;
i
<
1000
;
i
+
=
2
)
{
stats_
.
AddLostPacket
(
i
)
;
}
EXPECT_EQ
(
500
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
0
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
0
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
EveryOtherPacketWrapped
)
{
for
(
int
i
=
65500
;
i
<
66500
;
i
+
=
2
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
EXPECT_EQ
(
500
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
0
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
0
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
EveryOtherPacketWrappedAtEnd
)
{
for
(
int
i
=
64600
;
i
<
65600
;
i
+
=
2
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
EXPECT_EQ
(
500
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
0
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
0
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
FirstThreeOfEight
)
{
for
(
int
i
=
0
;
i
<
1000
;
+
+
i
)
{
if
(
(
i
&
7
)
<
3
)
{
stats_
.
AddLostPacket
(
i
)
;
}
}
EXPECT_EQ
(
0
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
125
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
375
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
FirstThreeOfEightWrapped
)
{
for
(
int
i
=
65500
;
i
<
66500
;
+
+
i
)
{
if
(
(
i
&
7
)
<
3
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
}
EXPECT_EQ
(
0
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
125
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
375
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
FirstThreeOfEightWrappedAtEnd
)
{
for
(
int
i
=
64600
;
i
<
65600
;
+
+
i
)
{
if
(
(
i
&
7
)
<
3
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
}
EXPECT_EQ
(
0
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
125
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
375
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
FirstThreeAndFifthOfEight
)
{
for
(
int
i
=
0
;
i
<
1000
;
+
+
i
)
{
if
(
(
i
&
7
)
<
3
|
|
(
i
&
7
)
=
=
4
)
{
stats_
.
AddLostPacket
(
i
)
;
}
}
EXPECT_EQ
(
125
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
125
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
375
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
FirstThreeAndFifthOfEightWrapped
)
{
for
(
int
i
=
65500
;
i
<
66500
;
+
+
i
)
{
if
(
(
i
&
7
)
<
3
|
|
(
i
&
7
)
=
=
4
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
}
EXPECT_EQ
(
125
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
125
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
375
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
FirstThreeAndFifthOfEightWrappedAtEnd
)
{
for
(
int
i
=
64600
;
i
<
65600
;
+
+
i
)
{
if
(
(
i
&
7
)
<
3
|
|
(
i
&
7
)
=
=
4
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
}
EXPECT_EQ
(
125
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
125
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
375
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
MultipleLossEventWrapped
)
{
for
(
int
i
=
60000
;
i
<
60500
;
i
+
=
2
)
{
stats_
.
AddLostPacket
(
i
)
;
}
for
(
int
i
=
65530
;
i
<
65540
;
+
+
i
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
EXPECT_EQ
(
250
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
1
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
10
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
MultipleLossEventWrappedPushedOut
)
{
for
(
int
i
=
60000
;
i
<
60500
;
i
+
=
2
)
{
stats_
.
AddLostPacket
(
i
)
;
}
for
(
int
i
=
65530
;
i
<
65540
;
+
+
i
)
{
stats_
.
AddLostPacket
(
i
&
0xFFFF
)
;
}
for
(
int
i
=
1000
;
i
<
1500
;
i
+
=
2
)
{
stats_
.
AddLostPacket
(
i
)
;
}
EXPECT_EQ
(
500
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
1
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
10
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
OutOfOrder
)
{
for
(
int
i
=
0
;
i
<
1000
;
i
+
=
10
)
{
stats_
.
AddLostPacket
(
i
+
5
)
;
stats_
.
AddLostPacket
(
i
+
7
)
;
stats_
.
AddLostPacket
(
i
+
4
)
;
stats_
.
AddLostPacket
(
i
+
1
)
;
stats_
.
AddLostPacket
(
i
+
2
)
;
}
EXPECT_EQ
(
100
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
200
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
400
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
TEST_F
(
PacketLossStatsTest
OutOfOrderWrapped
)
{
for
(
int
i
=
65000
;
i
<
66000
;
i
+
=
10
)
{
stats_
.
AddLostPacket
(
(
i
+
5
)
&
0xFFFF
)
;
stats_
.
AddLostPacket
(
(
i
+
7
)
&
0xFFFF
)
;
stats_
.
AddLostPacket
(
(
i
+
4
)
&
0xFFFF
)
;
stats_
.
AddLostPacket
(
(
i
+
1
)
&
0xFFFF
)
;
stats_
.
AddLostPacket
(
(
i
+
2
)
&
0xFFFF
)
;
}
EXPECT_EQ
(
100
stats_
.
GetSingleLossCount
(
)
)
;
EXPECT_EQ
(
200
stats_
.
GetMultipleLossEventCount
(
)
)
;
EXPECT_EQ
(
400
stats_
.
GetMultipleLossPacketCount
(
)
)
;
}
}
