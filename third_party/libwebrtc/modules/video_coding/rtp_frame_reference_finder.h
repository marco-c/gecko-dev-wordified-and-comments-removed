#
ifndef
MODULES_VIDEO_CODING_RTP_FRAME_REFERENCE_FINDER_H_
#
define
MODULES_VIDEO_CODING_RTP_FRAME_REFERENCE_FINDER_H_
#
include
<
array
>
#
include
<
deque
>
#
include
<
map
>
#
include
<
memory
>
#
include
<
set
>
#
include
<
utility
>
#
include
"
modules
/
include
/
module_common_types_public
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_video_header
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
vp9
/
include
/
vp9_globals
.
h
"
#
include
"
rtc_base
/
numerics
/
sequence_number_util
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
namespace
webrtc
{
namespace
video_coding
{
class
EncodedFrame
;
class
RtpFrameObject
;
class
OnCompleteFrameCallback
{
public
:
virtual
~
OnCompleteFrameCallback
(
)
{
}
virtual
void
OnCompleteFrame
(
std
:
:
unique_ptr
<
EncodedFrame
>
frame
)
=
0
;
}
;
class
RtpFrameReferenceFinder
{
public
:
explicit
RtpFrameReferenceFinder
(
OnCompleteFrameCallback
*
frame_callback
)
;
explicit
RtpFrameReferenceFinder
(
OnCompleteFrameCallback
*
frame_callback
int64_t
picture_id_offset
)
;
~
RtpFrameReferenceFinder
(
)
;
void
ManageFrame
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
;
void
PaddingReceived
(
uint16_t
seq_num
)
;
void
ClearTo
(
uint16_t
seq_num
)
;
private
:
static
const
uint16_t
kPicIdLength
=
1
<
<
15
;
static
const
uint8_t
kMaxTemporalLayers
=
5
;
static
const
int
kMaxLayerInfo
=
50
;
static
const
int
kMaxStashedFrames
=
100
;
static
const
int
kMaxNotYetReceivedFrames
=
100
;
static
const
int
kMaxGofSaved
=
50
;
static
const
int
kMaxPaddingAge
=
100
;
enum
FrameDecision
{
kStash
kHandOff
kDrop
}
;
struct
GofInfo
{
GofInfo
(
GofInfoVP9
*
gof
uint16_t
last_picture_id
)
:
gof
(
gof
)
last_picture_id
(
last_picture_id
)
{
}
GofInfoVP9
*
gof
;
uint16_t
last_picture_id
;
}
;
void
UpdateLastPictureIdWithPadding
(
uint16_t
seq_num
)
;
void
RetryStashedFrames
(
)
;
void
HandOffFrame
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
;
FrameDecision
ManageFrameInternal
(
RtpFrameObject
*
frame
)
;
FrameDecision
ManageFrameGeneric
(
RtpFrameObject
*
frame
const
RTPVideoHeader
:
:
GenericDescriptorInfo
&
descriptor
)
;
FrameDecision
ManageFramePidOrSeqNum
(
RtpFrameObject
*
frame
int
picture_id
)
;
FrameDecision
ManageFrameVp8
(
RtpFrameObject
*
frame
)
;
void
UpdateLayerInfoVp8
(
RtpFrameObject
*
frame
int64_t
unwrapped_tl0
uint8_t
temporal_idx
)
;
FrameDecision
ManageFrameVp9
(
RtpFrameObject
*
frame
)
;
bool
MissingRequiredFrameVp9
(
uint16_t
picture_id
const
GofInfo
&
info
)
;
void
FrameReceivedVp9
(
uint16_t
picture_id
GofInfo
*
info
)
;
bool
UpSwitchInIntervalVp9
(
uint16_t
picture_id
uint8_t
temporal_idx
uint16_t
pid_ref
)
;
void
UnwrapPictureIds
(
RtpFrameObject
*
frame
)
;
std
:
:
map
<
uint16_t
std
:
:
pair
<
uint16_t
uint16_t
>
DescendingSeqNumComp
<
uint16_t
>
>
last_seq_num_gop_
;
int
last_picture_id_
;
std
:
:
set
<
uint16_t
DescendingSeqNumComp
<
uint16_t
>
>
stashed_padding_
;
std
:
:
set
<
uint16_t
DescendingSeqNumComp
<
uint16_t
kPicIdLength
>
>
not_yet_received_frames_
;
std
:
:
set
<
uint16_t
DescendingSeqNumComp
<
uint16_t
>
>
not_yet_received_seq_num_
;
std
:
:
deque
<
std
:
:
unique_ptr
<
RtpFrameObject
>
>
stashed_frames_
;
std
:
:
map
<
int64_t
std
:
:
array
<
int64_t
kMaxTemporalLayers
>
>
layer_info_
;
uint8_t
current_ss_idx_
;
std
:
:
array
<
GofInfoVP9
kMaxGofSaved
>
scalability_structures_
;
std
:
:
map
<
int64_t
GofInfo
>
gof_info_
;
std
:
:
map
<
uint16_t
uint8_t
DescendingSeqNumComp
<
uint16_t
kPicIdLength
>
>
up_switch_
;
std
:
:
array
<
std
:
:
set
<
uint16_t
DescendingSeqNumComp
<
uint16_t
kPicIdLength
>
>
kMaxTemporalLayers
>
missing_frames_for_layer_
;
int
cleared_to_seq_num_
;
OnCompleteFrameCallback
*
frame_callback_
;
SeqNumUnwrapper
<
uint16_t
>
rtp_seq_num_unwrapper_
;
SeqNumUnwrapper
<
uint16_t
kPicIdLength
>
unwrapper_
;
SeqNumUnwrapper
<
uint8_t
>
tl0_unwrapper_
;
const
int64_t
picture_id_offset_
;
}
;
}
}
#
endif
