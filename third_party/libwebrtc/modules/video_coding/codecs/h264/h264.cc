#
include
"
modules
/
video_coding
/
codecs
/
h264
/
include
/
h264
.
h
"
#
include
<
memory
>
#
include
<
string
>
#
include
"
absl
/
types
/
optional
.
h
"
#
include
"
api
/
video_codecs
/
sdp_video_format
.
h
"
#
include
"
media
/
base
/
media_constants
.
h
"
#
if
defined
(
WEBRTC_USE_H264
)
#
include
"
modules
/
video_coding
/
codecs
/
h264
/
h264_decoder_impl
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
h264
/
h264_encoder_impl
.
h
"
#
endif
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
namespace
webrtc
{
namespace
{
#
if
defined
(
WEBRTC_USE_H264
)
bool
g_rtc_use_h264
=
true
;
#
endif
bool
IsH264CodecSupported
(
)
{
#
if
defined
(
WEBRTC_USE_H264
)
return
g_rtc_use_h264
;
#
else
return
false
;
#
endif
}
}
SdpVideoFormat
CreateH264Format
(
H264Profile
profile
H264Level
level
const
std
:
:
string
&
packetization_mode
)
{
const
absl
:
:
optional
<
std
:
:
string
>
profile_string
=
H264ProfileLevelIdToString
(
H264ProfileLevelId
(
profile
level
)
)
;
RTC_CHECK
(
profile_string
)
;
return
SdpVideoFormat
(
cricket
:
:
kH264CodecName
{
{
cricket
:
:
kH264FmtpProfileLevelId
*
profile_string
}
{
cricket
:
:
kH264FmtpLevelAsymmetryAllowed
"
1
"
}
{
cricket
:
:
kH264FmtpPacketizationMode
packetization_mode
}
}
)
;
}
void
DisableRtcUseH264
(
)
{
#
if
defined
(
WEBRTC_USE_H264
)
g_rtc_use_h264
=
false
;
#
endif
}
std
:
:
vector
<
SdpVideoFormat
>
SupportedH264Codecs
(
)
{
if
(
!
IsH264CodecSupported
(
)
)
return
std
:
:
vector
<
SdpVideoFormat
>
(
)
;
return
{
CreateH264Format
(
H264Profile
:
:
kProfileBaseline
H264Level
:
:
kLevel3_1
"
1
"
)
CreateH264Format
(
H264Profile
:
:
kProfileBaseline
H264Level
:
:
kLevel3_1
"
0
"
)
CreateH264Format
(
H264Profile
:
:
kProfileConstrainedBaseline
H264Level
:
:
kLevel3_1
"
1
"
)
CreateH264Format
(
H264Profile
:
:
kProfileConstrainedBaseline
H264Level
:
:
kLevel3_1
"
0
"
)
}
;
}
std
:
:
unique_ptr
<
H264Encoder
>
H264Encoder
:
:
Create
(
const
cricket
:
:
VideoCodec
&
codec
)
{
RTC_DCHECK
(
H264Encoder
:
:
IsSupported
(
)
)
;
#
if
defined
(
WEBRTC_USE_H264
)
RTC_CHECK
(
g_rtc_use_h264
)
;
RTC_LOG
(
LS_INFO
)
<
<
"
Creating
H264EncoderImpl
.
"
;
return
std
:
:
make_unique
<
H264EncoderImpl
>
(
codec
)
;
#
else
RTC_NOTREACHED
(
)
;
return
nullptr
;
#
endif
}
bool
H264Encoder
:
:
IsSupported
(
)
{
return
IsH264CodecSupported
(
)
;
}
std
:
:
unique_ptr
<
H264Decoder
>
H264Decoder
:
:
Create
(
)
{
RTC_DCHECK
(
H264Decoder
:
:
IsSupported
(
)
)
;
#
if
defined
(
WEBRTC_USE_H264
)
RTC_CHECK
(
g_rtc_use_h264
)
;
RTC_LOG
(
LS_INFO
)
<
<
"
Creating
H264DecoderImpl
.
"
;
return
std
:
:
make_unique
<
H264DecoderImpl
>
(
)
;
#
else
RTC_NOTREACHED
(
)
;
return
nullptr
;
#
endif
}
bool
H264Decoder
:
:
IsSupported
(
)
{
return
IsH264CodecSupported
(
)
;
}
}
