#
include
"
modules
/
video_coding
/
codecs
/
h264
/
h264_encoder_impl
.
h
"
#
include
"
api
/
video_codecs
/
video_encoder
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
const
int
kMaxPayloadSize
=
1024
;
const
int
kNumCores
=
1
;
const
VideoEncoder
:
:
Capabilities
kCapabilities
(
false
)
;
const
VideoEncoder
:
:
Settings
kSettings
(
kCapabilities
kNumCores
kMaxPayloadSize
)
;
void
SetDefaultSettings
(
VideoCodec
*
codec_settings
)
{
codec_settings
-
>
codecType
=
kVideoCodecH264
;
codec_settings
-
>
maxFramerate
=
60
;
codec_settings
-
>
width
=
640
;
codec_settings
-
>
height
=
480
;
codec_settings
-
>
SetFrameDropEnabled
(
true
)
;
codec_settings
-
>
startBitrate
=
2000
;
codec_settings
-
>
maxBitrate
=
4000
;
}
TEST
(
H264EncoderImplTest
CanInitializeWithDefaultParameters
)
{
H264EncoderImpl
encoder
(
cricket
:
:
VideoCodec
(
"
H264
"
)
)
;
VideoCodec
codec_settings
;
SetDefaultSettings
(
&
codec_settings
)
;
EXPECT_EQ
(
WEBRTC_VIDEO_CODEC_OK
encoder
.
InitEncode
(
&
codec_settings
kSettings
)
)
;
EXPECT_EQ
(
H264PacketizationMode
:
:
NonInterleaved
encoder
.
PacketizationModeForTesting
(
)
)
;
}
TEST
(
H264EncoderImplTest
CanInitializeWithNonInterleavedModeExplicitly
)
{
cricket
:
:
VideoCodec
codec
(
"
H264
"
)
;
codec
.
SetParam
(
cricket
:
:
kH264FmtpPacketizationMode
"
1
"
)
;
H264EncoderImpl
encoder
(
codec
)
;
VideoCodec
codec_settings
;
SetDefaultSettings
(
&
codec_settings
)
;
EXPECT_EQ
(
WEBRTC_VIDEO_CODEC_OK
encoder
.
InitEncode
(
&
codec_settings
kSettings
)
)
;
EXPECT_EQ
(
H264PacketizationMode
:
:
NonInterleaved
encoder
.
PacketizationModeForTesting
(
)
)
;
}
TEST
(
H264EncoderImplTest
CanInitializeWithSingleNalUnitModeExplicitly
)
{
cricket
:
:
VideoCodec
codec
(
"
H264
"
)
;
codec
.
SetParam
(
cricket
:
:
kH264FmtpPacketizationMode
"
0
"
)
;
H264EncoderImpl
encoder
(
codec
)
;
VideoCodec
codec_settings
;
SetDefaultSettings
(
&
codec_settings
)
;
EXPECT_EQ
(
WEBRTC_VIDEO_CODEC_OK
encoder
.
InitEncode
(
&
codec_settings
kSettings
)
)
;
EXPECT_EQ
(
H264PacketizationMode
:
:
SingleNalUnit
encoder
.
PacketizationModeForTesting
(
)
)
;
}
TEST
(
H264EncoderImplTest
CanInitializeWithRemovedParameter
)
{
cricket
:
:
VideoCodec
codec
(
"
H264
"
)
;
codec
.
RemoveParam
(
cricket
:
:
kH264FmtpPacketizationMode
)
;
H264EncoderImpl
encoder
(
codec
)
;
VideoCodec
codec_settings
;
SetDefaultSettings
(
&
codec_settings
)
;
EXPECT_EQ
(
WEBRTC_VIDEO_CODEC_OK
encoder
.
InitEncode
(
&
codec_settings
kSettings
)
)
;
EXPECT_EQ
(
H264PacketizationMode
:
:
SingleNalUnit
encoder
.
PacketizationModeForTesting
(
)
)
;
}
}
}
