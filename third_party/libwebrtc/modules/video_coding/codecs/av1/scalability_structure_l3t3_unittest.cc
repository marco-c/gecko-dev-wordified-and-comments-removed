#
include
"
modules
/
video_coding
/
codecs
/
av1
/
scalability_structure_l3t3
.
h
"
#
include
"
modules
/
video_coding
/
codecs
/
av1
/
scalability_structure_test_helpers
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
using
:
:
testing
:
:
IsEmpty
;
using
:
:
testing
:
:
SizeIs
;
TEST
(
ScalabilityStructureL3T3Test
SkipS1T1FrameKeepsStructureValid
)
{
ScalabilityStructureL3T3
structure
;
ScalabilityStructureWrapper
wrapper
(
structure
)
;
structure
.
OnRatesUpdated
(
EnableTemporalLayers
(
3
3
)
)
;
auto
frames
=
wrapper
.
GenerateFrames
(
1
)
;
EXPECT_THAT
(
frames
SizeIs
(
2
)
)
;
EXPECT_EQ
(
frames
[
0
]
.
temporal_id
0
)
;
frames
=
wrapper
.
GenerateFrames
(
1
)
;
EXPECT_THAT
(
frames
SizeIs
(
2
)
)
;
EXPECT_EQ
(
frames
[
0
]
.
temporal_id
2
)
;
structure
.
OnRatesUpdated
(
EnableTemporalLayers
(
3
0
)
)
;
frames
=
wrapper
.
GenerateFrames
(
1
)
;
EXPECT_THAT
(
frames
SizeIs
(
1
)
)
;
EXPECT_EQ
(
frames
[
0
]
.
temporal_id
1
)
;
structure
.
OnRatesUpdated
(
EnableTemporalLayers
(
3
3
)
)
;
frames
=
wrapper
.
GenerateFrames
(
1
)
;
EXPECT_THAT
(
frames
SizeIs
(
2
)
)
;
EXPECT_EQ
(
frames
[
0
]
.
temporal_id
2
)
;
}
TEST
(
ScalabilityStructureL3T3Test
SwitchSpatialLayerBeforeT1Frame
)
{
ScalabilityStructureL3T3
structure
;
ScalabilityStructureWrapper
wrapper
(
structure
)
;
structure
.
OnRatesUpdated
(
EnableTemporalLayers
(
2
0
)
)
;
EXPECT_THAT
(
wrapper
.
GenerateFrames
(
1
)
SizeIs
(
1
)
)
;
structure
.
OnRatesUpdated
(
EnableTemporalLayers
(
0
2
)
)
;
auto
frames
=
wrapper
.
GenerateFrames
(
1
)
;
ASSERT_THAT
(
frames
SizeIs
(
1
)
)
;
EXPECT_THAT
(
frames
[
0
]
.
frame_diffs
IsEmpty
(
)
)
;
EXPECT_EQ
(
frames
[
0
]
.
temporal_id
0
)
;
}
}
}
