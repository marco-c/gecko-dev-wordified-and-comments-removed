#
include
"
modules
/
video_coding
/
codecs
/
test
/
android_codec_factory_helper
.
h
"
#
include
<
pthread
.
h
>
#
include
<
memory
>
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
ignore_wundef
.
h
"
#
include
"
sdk
/
android
/
native_api
/
base
/
init
.
h
"
#
include
"
sdk
/
android
/
native_api
/
codecs
/
wrapper
.
h
"
#
include
"
sdk
/
android
/
native_api
/
jni
/
class_loader
.
h
"
#
include
"
sdk
/
android
/
native_api
/
jni
/
jvm
.
h
"
#
include
"
sdk
/
android
/
native_api
/
jni
/
scoped_java_ref
.
h
"
RTC_PUSH_IGNORING_WUNDEF
(
)
#
include
"
base
/
android
/
jni_android
.
h
"
RTC_POP_IGNORING_WUNDEF
(
)
namespace
webrtc
{
namespace
test
{
namespace
{
static
pthread_once_t
g_initialize_once
=
PTHREAD_ONCE_INIT
;
void
EnsureInitializedOnce
(
)
{
RTC_CHECK
(
:
:
base
:
:
android
:
:
IsVMInitialized
(
)
)
;
JNIEnv
*
env
=
:
:
base
:
:
android
:
:
AttachCurrentThread
(
)
;
JavaVM
*
jvm
=
nullptr
;
RTC_CHECK_EQ
(
0
env
-
>
GetJavaVM
(
&
jvm
)
)
;
InitAndroid
(
jvm
)
;
}
}
void
InitializeAndroidObjects
(
)
{
RTC_CHECK_EQ
(
0
pthread_once
(
&
g_initialize_once
&
EnsureInitializedOnce
)
)
;
}
std
:
:
unique_ptr
<
VideoEncoderFactory
>
CreateAndroidEncoderFactory
(
)
{
JNIEnv
*
env
=
AttachCurrentThreadIfNeeded
(
)
;
ScopedJavaLocalRef
<
jclass
>
factory_class
=
GetClass
(
env
"
org
/
webrtc
/
HardwareVideoEncoderFactory
"
)
;
jmethodID
factory_constructor
=
env
-
>
GetMethodID
(
factory_class
.
obj
(
)
"
<
init
>
"
"
(
Lorg
/
webrtc
/
EglBase
Context
;
ZZ
)
V
"
)
;
ScopedJavaLocalRef
<
jobject
>
factory_object
(
env
env
-
>
NewObject
(
factory_class
.
obj
(
)
factory_constructor
nullptr
false
true
)
)
;
return
JavaToNativeVideoEncoderFactory
(
env
factory_object
.
obj
(
)
)
;
}
std
:
:
unique_ptr
<
VideoDecoderFactory
>
CreateAndroidDecoderFactory
(
)
{
JNIEnv
*
env
=
AttachCurrentThreadIfNeeded
(
)
;
ScopedJavaLocalRef
<
jclass
>
factory_class
=
GetClass
(
env
"
org
/
webrtc
/
HardwareVideoDecoderFactory
"
)
;
jmethodID
factory_constructor
=
env
-
>
GetMethodID
(
factory_class
.
obj
(
)
"
<
init
>
"
"
(
Lorg
/
webrtc
/
EglBase
Context
;
)
V
"
)
;
ScopedJavaLocalRef
<
jobject
>
factory_object
(
env
env
-
>
NewObject
(
factory_class
.
obj
(
)
factory_constructor
nullptr
)
)
;
return
JavaToNativeVideoDecoderFactory
(
env
factory_object
.
obj
(
)
)
;
}
}
}
