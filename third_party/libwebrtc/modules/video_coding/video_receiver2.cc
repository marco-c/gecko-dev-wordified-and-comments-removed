#
include
"
modules
/
video_coding
/
video_receiver2
.
h
"
#
include
<
stddef
.
h
>
#
include
<
cstdint
>
#
include
<
memory
>
#
include
<
utility
>
#
include
"
api
/
field_trials_view
.
h
"
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
api
/
video
/
encoded_frame
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder
.
h
"
#
include
"
common_video
/
include
/
corruption_score_calculator
.
h
"
#
include
"
modules
/
video_coding
/
decoder_database
.
h
"
#
include
"
modules
/
video_coding
/
generic_decoder
.
h
"
#
include
"
modules
/
video_coding
/
include
/
video_coding_defines
.
h
"
#
include
"
modules
/
video_coding
/
timing
/
timing
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
trace_event
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
namespace
webrtc
{
VideoReceiver2
:
:
VideoReceiver2
(
Clock
*
clock
VCMTiming
*
timing
const
FieldTrialsView
&
field_trials
CorruptionScoreCalculator
*
corruption_score_calculator
)
:
clock_
(
clock
)
decoded_frame_callback_
(
timing
clock_
field_trials
corruption_score_calculator
)
codec_database_
(
)
{
decoder_sequence_checker_
.
Detach
(
)
;
}
VideoReceiver2
:
:
~
VideoReceiver2
(
)
{
RTC_DCHECK_RUN_ON
(
&
construction_sequence_checker_
)
;
}
int32_t
VideoReceiver2
:
:
RegisterReceiveCallback
(
VCMReceiveCallback
*
receive_callback
)
{
RTC_DCHECK_RUN_ON
(
&
construction_sequence_checker_
)
;
decoded_frame_callback_
.
SetUserReceiveCallback
(
receive_callback
)
;
return
VCM_OK
;
}
void
VideoReceiver2
:
:
RegisterExternalDecoder
(
std
:
:
unique_ptr
<
VideoDecoder
>
decoder
uint8_t
payload_type
)
{
RTC_DCHECK_RUN_ON
(
&
decoder_sequence_checker_
)
;
RTC_DCHECK
(
decoded_frame_callback_
.
UserReceiveCallback
(
)
)
;
if
(
decoder
)
{
RTC_DCHECK
(
!
codec_database_
.
IsExternalDecoderRegistered
(
payload_type
)
)
;
codec_database_
.
RegisterExternalDecoder
(
payload_type
std
:
:
move
(
decoder
)
)
;
}
else
{
codec_database_
.
DeregisterExternalDecoder
(
payload_type
)
;
}
}
bool
VideoReceiver2
:
:
IsExternalDecoderRegistered
(
uint8_t
payload_type
)
const
{
RTC_DCHECK_RUN_ON
(
&
decoder_sequence_checker_
)
;
return
codec_database_
.
IsExternalDecoderRegistered
(
payload_type
)
;
}
int32_t
VideoReceiver2
:
:
Decode
(
const
EncodedFrame
*
frame
)
{
RTC_DCHECK_RUN_ON
(
&
decoder_sequence_checker_
)
;
TRACE_EVENT0
(
"
webrtc
"
"
VideoReceiver2
:
:
Decode
"
)
;
VCMGenericDecoder
*
decoder
=
codec_database_
.
GetDecoder
(
*
frame
&
decoded_frame_callback_
)
;
if
(
decoder
=
=
nullptr
)
{
return
VCM_NO_CODEC_REGISTERED
;
}
return
decoder
-
>
Decode
(
*
frame
clock_
-
>
CurrentTime
(
)
)
;
}
void
VideoReceiver2
:
:
RegisterReceiveCodec
(
uint8_t
payload_type
const
VideoDecoder
:
:
Settings
&
settings
)
{
RTC_DCHECK_RUN_ON
(
&
construction_sequence_checker_
)
;
codec_database_
.
RegisterReceiveCodec
(
payload_type
settings
)
;
}
void
VideoReceiver2
:
:
DeregisterReceiveCodec
(
uint8_t
payload_type
)
{
RTC_DCHECK_RUN_ON
(
&
construction_sequence_checker_
)
;
codec_database_
.
DeregisterReceiveCodec
(
payload_type
)
;
}
void
VideoReceiver2
:
:
DeregisterReceiveCodecs
(
)
{
RTC_DCHECK_RUN_ON
(
&
construction_sequence_checker_
)
;
codec_database_
.
DeregisterReceiveCodecs
(
)
;
}
}
