#
include
"
modules
/
video_coding
/
timing
/
codec_timer
.
h
"
#
include
<
cstdint
>
namespace
webrtc
{
namespace
{
const
int
kIgnoredSampleCount
=
5
;
const
float
kPercentile
=
0
.
95f
;
const
int64_t
kTimeLimitMs
=
10000
;
}
CodecTimer
:
:
CodecTimer
(
)
:
ignored_sample_count_
(
0
)
filter_
(
kPercentile
)
{
}
CodecTimer
:
:
~
CodecTimer
(
)
=
default
;
void
CodecTimer
:
:
AddTiming
(
int64_t
decode_time_ms
int64_t
now_ms
)
{
if
(
ignored_sample_count_
<
kIgnoredSampleCount
)
{
+
+
ignored_sample_count_
;
return
;
}
filter_
.
Insert
(
decode_time_ms
)
;
history_
.
emplace
(
decode_time_ms
now_ms
)
;
while
(
!
history_
.
empty
(
)
&
&
now_ms
-
history_
.
front
(
)
.
sample_time_ms
>
kTimeLimitMs
)
{
filter_
.
Erase
(
history_
.
front
(
)
.
decode_time_ms
)
;
history_
.
pop
(
)
;
}
}
int64_t
CodecTimer
:
:
RequiredDecodeTimeMs
(
)
const
{
return
filter_
.
GetPercentileValue
(
)
;
}
CodecTimer
:
:
Sample
:
:
Sample
(
int64_t
decode_time_ms
int64_t
sample_time_ms
)
:
decode_time_ms
(
decode_time_ms
)
sample_time_ms
(
sample_time_ms
)
{
}
}
