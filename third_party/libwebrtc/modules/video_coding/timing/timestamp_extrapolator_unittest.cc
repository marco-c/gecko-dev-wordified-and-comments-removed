#
include
"
modules
/
video_coding
/
timing
/
timestamp_extrapolator
.
h
"
#
include
<
stdint
.
h
>
#
include
<
limits
>
#
include
<
optional
>
#
include
<
string
>
#
include
"
api
/
units
/
frequency
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
#
include
"
system_wrappers
/
include
/
metrics
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
using
:
:
testing
:
:
Eq
;
using
:
:
testing
:
:
Optional
;
namespace
{
constexpr
Frequency
kRtpHz
=
Frequency
:
:
KiloHertz
(
90
)
;
constexpr
Frequency
k25Fps
=
Frequency
:
:
Hertz
(
25
)
;
constexpr
TimeDelta
k25FpsDelay
=
1
/
k25Fps
;
}
TEST
(
TimestampExtrapolatorTest
ExtrapolationOccursAfter2Packets
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
90000
)
Eq
(
std
:
:
nullopt
)
)
;
uint32_t
rtp
=
90000
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
+
90000
)
Optional
(
clock
.
CurrentTime
(
)
+
TimeDelta
:
:
Seconds
(
1
)
)
)
;
}
TEST
(
TimestampExtrapolatorTest
ResetsAfter10SecondPause
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
90000
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
rtp
+
=
10
*
kRtpHz
.
hertz
(
)
;
clock
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
10
)
+
TimeDelta
:
:
Micros
(
1
)
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
}
TEST
(
TimestampExtrapolatorTest
TimestampExtrapolatesMultipleRtpWrapArounds
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
rtp
+
=
static_cast
<
uint32_t
>
(
kRtpHz
/
k25Fps
)
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
+
90000
)
Optional
(
clock
.
CurrentTime
(
)
+
TimeDelta
:
:
Seconds
(
1
)
)
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
-
90000
)
Optional
(
clock
.
CurrentTime
(
)
-
TimeDelta
:
:
Millis
(
999
)
)
)
;
constexpr
TimeDelta
kRtpOverflowDelay
=
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
/
kRtpHz
;
const
Timestamp
overflow_time
=
clock
.
CurrentTime
(
)
+
kRtpOverflowDelay
*
2
;
while
(
clock
.
CurrentTime
(
)
<
overflow_time
)
{
clock
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
10
)
)
;
rtp
+
=
static_cast
<
uint32_t
>
(
kRtpHz
*
TimeDelta
:
:
Seconds
(
10
)
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
}
}
TEST
(
TimestampExtrapolatorTest
NegativeRtpTimestampWrapAround
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
0
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
rtp
-
=
static_cast
<
uint32_t
>
(
kRtpHz
.
hertz
(
)
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
-
TimeDelta
:
:
Seconds
(
1
)
)
)
;
}
TEST
(
TimestampExtrapolatorTest
NegativeRtpTimestampWrapAroundSecondScenario
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
0
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
rtp
-
=
static_cast
<
uint32_t
>
(
kRtpHz
*
TimeDelta
:
:
Seconds
(
10
)
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
std
:
:
nullopt
)
;
}
TEST
(
TimestampExtrapolatorTest
Slow90KHzClock
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
constexpr
TimeDelta
k24FpsDelay
=
1
/
Frequency
:
:
Hertz
(
24
)
;
uint32_t
rtp
=
90000
;
for
(
int
i
=
0
;
i
<
25
;
+
+
i
)
{
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k24FpsDelay
)
;
}
constexpr
Frequency
kSlowRtpHz
=
90000
/
(
25
*
k24FpsDelay
)
;
auto
ts
=
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
+
kSlowRtpHz
.
hertz
(
)
)
;
ASSERT_TRUE
(
ts
.
has_value
(
)
)
;
EXPECT_EQ
(
ts
-
>
ms
(
)
clock
.
TimeInMilliseconds
(
)
+
1000
)
;
}
TEST
(
TimestampExtrapolatorTest
Fast90KHzClock
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
constexpr
TimeDelta
k26FpsDelay
=
1
/
Frequency
:
:
Hertz
(
26
)
;
uint32_t
rtp
=
90000
;
for
(
int
i
=
0
;
i
<
25
;
+
+
i
)
{
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k26FpsDelay
)
;
}
constexpr
Frequency
kSlowRtpHz
=
90000
/
(
25
*
k26FpsDelay
)
;
auto
ts
=
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
+
kSlowRtpHz
.
hertz
(
)
)
;
ASSERT_TRUE
(
ts
.
has_value
(
)
)
;
EXPECT_EQ
(
ts
-
>
ms
(
)
clock
.
TimeInMilliseconds
(
)
+
1000
)
;
}
TEST
(
TimestampExtrapolatorTest
TimestampJump
)
{
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
90000
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
+
90000
)
Optional
(
clock
.
CurrentTime
(
)
+
TimeDelta
:
:
Seconds
(
1
)
)
)
;
uint32_t
new_rtp
=
1337
*
90000
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
new_rtp
)
;
new_rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
new_rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
new_rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
}
TEST
(
TimestampExtrapolatorTest
GapInReceivedFrames
)
{
SimulatedClock
clock
(
Timestamp
:
:
Seconds
(
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
/
90000
-
31
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
30
*
90000
;
clock
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
30
)
)
;
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
EXPECT_THAT
(
ts_extrapolator
.
ExtrapolateLocalTime
(
rtp
)
Optional
(
clock
.
CurrentTime
(
)
)
)
;
}
TEST
(
TimestampExtrapolatorTest
EstimatedClockDriftHistogram
)
{
const
std
:
:
string
kHistogramName
=
"
WebRTC
.
Video
.
EstimatedClockDrift_ppm
"
;
constexpr
int
kPpmTolerance
=
50
;
constexpr
int
kToPpmFactor
=
1e6
;
constexpr
int
kMinimumSamples
=
3000
;
constexpr
Frequency
k24Fps
=
Frequency
:
:
Hertz
(
24
)
;
constexpr
TimeDelta
k24FpsDelay
=
1
/
k24Fps
;
{
metrics
:
:
Reset
(
)
;
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
90000
;
for
(
int
i
=
0
;
i
<
kMinimumSamples
;
+
+
i
)
{
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
}
}
EXPECT_EQ
(
metrics
:
:
NumSamples
(
kHistogramName
)
1
)
;
const
int
kExpectedIdealClockDriftPpm
=
0
;
EXPECT_NEAR
(
kExpectedIdealClockDriftPpm
metrics
:
:
MinSample
(
kHistogramName
)
kPpmTolerance
)
;
{
metrics
:
:
Reset
(
)
;
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
90000
;
for
(
int
i
=
0
;
i
<
kMinimumSamples
;
+
+
i
)
{
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
kRtpHz
/
k25Fps
;
clock
.
AdvanceTime
(
k24FpsDelay
)
;
}
}
EXPECT_EQ
(
metrics
:
:
NumSamples
(
kHistogramName
)
1
)
;
const
int
kExpectedSlowClockDriftPpm
=
std
:
:
abs
(
k24Fps
/
k25Fps
-
1
.
0
)
*
kToPpmFactor
;
EXPECT_NEAR
(
kExpectedSlowClockDriftPpm
metrics
:
:
MinSample
(
kHistogramName
)
kPpmTolerance
)
;
{
metrics
:
:
Reset
(
)
;
SimulatedClock
clock
(
Timestamp
:
:
Millis
(
1337
)
)
;
TimestampExtrapolator
ts_extrapolator
(
clock
.
CurrentTime
(
)
)
;
uint32_t
rtp
=
90000
;
for
(
int
i
=
0
;
i
<
kMinimumSamples
;
+
+
i
)
{
ts_extrapolator
.
Update
(
clock
.
CurrentTime
(
)
rtp
)
;
rtp
+
=
kRtpHz
/
k24Fps
;
clock
.
AdvanceTime
(
k25FpsDelay
)
;
}
}
EXPECT_EQ
(
metrics
:
:
NumSamples
(
kHistogramName
)
1
)
;
const
int
kExpectedFastClockDriftPpm
=
(
k25Fps
/
k24Fps
-
1
.
0
)
*
kToPpmFactor
;
EXPECT_NEAR
(
kExpectedFastClockDriftPpm
metrics
:
:
MinSample
(
kHistogramName
)
kPpmTolerance
)
;
}
}
