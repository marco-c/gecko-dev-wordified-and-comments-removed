#
ifndef
MODULES_VIDEO_CODING_JITTER_ESTIMATOR_H_
#
define
MODULES_VIDEO_CODING_JITTER_ESTIMATOR_H_
#
include
"
absl
/
types
/
optional
.
h
"
#
include
"
api
/
units
/
data_size
.
h
"
#
include
"
api
/
units
/
frequency
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
modules
/
video_coding
/
rtt_filter
.
h
"
#
include
"
rtc_base
/
rolling_accumulator
.
h
"
namespace
webrtc
{
class
Clock
;
class
VCMJitterEstimator
{
public
:
explicit
VCMJitterEstimator
(
Clock
*
clock
)
;
virtual
~
VCMJitterEstimator
(
)
;
VCMJitterEstimator
(
const
VCMJitterEstimator
&
)
=
delete
;
VCMJitterEstimator
&
operator
=
(
const
VCMJitterEstimator
&
)
=
delete
;
void
Reset
(
)
;
void
UpdateEstimate
(
TimeDelta
frame_delay
DataSize
frame_size
bool
incomplete_frame
=
false
)
;
virtual
TimeDelta
GetJitterEstimate
(
double
rtt_multiplier
absl
:
:
optional
<
TimeDelta
>
rtt_mult_add_cap
)
;
void
FrameNacked
(
)
;
void
UpdateRtt
(
TimeDelta
rtt
)
;
static
constexpr
TimeDelta
OPERATING_SYSTEM_JITTER
=
TimeDelta
:
:
Millis
(
10
)
;
protected
:
double
theta_
[
2
]
;
double
var_noise_
;
private
:
void
KalmanEstimateChannel
(
TimeDelta
frame_delay
double
delta_frame_size_bytes
)
;
void
EstimateRandomJitter
(
double
d_dT
bool
incomplete_frame
)
;
double
NoiseThreshold
(
)
const
;
TimeDelta
CalculateEstimate
(
)
;
void
PostProcessEstimate
(
)
;
double
DeviationFromExpectedDelay
(
TimeDelta
frame_delay
double
delta_frame_size_bytes
)
const
;
Frequency
GetFrameRate
(
)
const
;
double
theta_cov_
[
2
]
[
2
]
;
double
q_cov_
[
2
]
[
2
]
;
static
constexpr
DataSize
kDefaultAvgAndMaxFrameSize
=
DataSize
:
:
Bytes
(
500
)
;
DataSize
avg_frame_size_
=
kDefaultAvgAndMaxFrameSize
;
double
var_frame_size_
;
DataSize
max_frame_size_
=
kDefaultAvgAndMaxFrameSize
;
DataSize
frame_size_sum_
=
DataSize
:
:
Zero
(
)
;
uint32_t
frame_size_count_
;
absl
:
:
optional
<
Timestamp
>
last_update_time_
;
absl
:
:
optional
<
TimeDelta
>
prev_estimate_
;
absl
:
:
optional
<
DataSize
>
prev_frame_size_
;
double
avg_noise_
;
uint32_t
alpha_count_
;
TimeDelta
filter_jitter_estimate_
=
TimeDelta
:
:
Zero
(
)
;
uint32_t
startup_count_
;
Timestamp
latest_nack_
=
Timestamp
:
:
Zero
(
)
;
uint32_t
nack_count_
;
VCMRttFilter
rtt_filter_
;
rtc
:
:
RollingAccumulator
<
uint64_t
>
fps_counter_
;
const
double
time_deviation_upper_bound_
;
const
bool
enable_reduced_delay_
;
Clock
*
clock_
;
}
;
}
#
endif
