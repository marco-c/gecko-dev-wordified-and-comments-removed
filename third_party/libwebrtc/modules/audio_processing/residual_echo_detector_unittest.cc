#
include
"
modules
/
audio_processing
/
residual_echo_detector
.
h
"
#
include
<
vector
>
#
include
"
rtc_base
/
ref_counted_object
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
TEST
(
ResidualEchoDetectorTests
Echo
)
{
auto
echo_detector
=
rtc
:
:
make_ref_counted
<
ResidualEchoDetector
>
(
)
;
echo_detector
-
>
SetReliabilityForTest
(
1
.
0f
)
;
std
:
:
vector
<
float
>
ones
(
160
1
.
f
)
;
std
:
:
vector
<
float
>
zeros
(
160
0
.
f
)
;
for
(
int
i
=
0
;
i
<
1000
;
i
+
+
)
{
if
(
i
%
20
=
=
0
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
ones
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
else
if
(
i
%
20
=
=
10
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
ones
)
;
}
else
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
}
auto
ed_metrics
=
echo_detector
-
>
GetMetrics
(
)
;
ASSERT_TRUE
(
ed_metrics
.
echo_likelihood
)
;
EXPECT_NEAR
(
1
.
f
ed_metrics
.
echo_likelihood
.
value
(
)
0
.
01f
)
;
}
TEST
(
ResidualEchoDetectorTests
NoEcho
)
{
auto
echo_detector
=
rtc
:
:
make_ref_counted
<
ResidualEchoDetector
>
(
)
;
echo_detector
-
>
SetReliabilityForTest
(
1
.
0f
)
;
std
:
:
vector
<
float
>
ones
(
160
1
.
f
)
;
std
:
:
vector
<
float
>
zeros
(
160
0
.
f
)
;
for
(
int
i
=
0
;
i
<
1000
;
i
+
+
)
{
if
(
i
%
20
=
=
0
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
ones
)
;
}
else
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
}
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
auto
ed_metrics
=
echo_detector
-
>
GetMetrics
(
)
;
ASSERT_TRUE
(
ed_metrics
.
echo_likelihood
)
;
EXPECT_NEAR
(
0
.
f
ed_metrics
.
echo_likelihood
.
value
(
)
0
.
01f
)
;
}
TEST
(
ResidualEchoDetectorTests
EchoWithRenderClockDrift
)
{
auto
echo_detector
=
rtc
:
:
make_ref_counted
<
ResidualEchoDetector
>
(
)
;
echo_detector
-
>
SetReliabilityForTest
(
1
.
0f
)
;
std
:
:
vector
<
float
>
ones
(
160
1
.
f
)
;
std
:
:
vector
<
float
>
zeros
(
160
0
.
f
)
;
for
(
int
i
=
0
;
i
<
1000
;
i
+
+
)
{
if
(
i
%
20
=
=
0
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
ones
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
else
if
(
i
%
20
=
=
10
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
ones
)
;
}
else
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
if
(
i
%
100
=
=
0
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
}
}
auto
ed_metrics
=
echo_detector
-
>
GetMetrics
(
)
;
ASSERT_TRUE
(
ed_metrics
.
echo_likelihood
)
;
EXPECT_GT
(
ed_metrics
.
echo_likelihood
.
value
(
)
0
.
75f
)
;
}
TEST
(
ResidualEchoDetectorTests
EchoWithCaptureClockDrift
)
{
auto
echo_detector
=
rtc
:
:
make_ref_counted
<
ResidualEchoDetector
>
(
)
;
echo_detector
-
>
SetReliabilityForTest
(
1
.
0f
)
;
std
:
:
vector
<
float
>
ones
(
160
1
.
f
)
;
std
:
:
vector
<
float
>
zeros
(
160
0
.
f
)
;
for
(
int
i
=
0
;
i
<
1000
;
i
+
+
)
{
if
(
i
%
20
=
=
0
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
ones
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
else
if
(
i
%
20
=
=
10
)
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
ones
)
;
}
else
{
echo_detector
-
>
AnalyzeRenderAudio
(
zeros
)
;
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
if
(
i
%
100
=
=
0
)
{
echo_detector
-
>
AnalyzeCaptureAudio
(
zeros
)
;
}
}
auto
ed_metrics
=
echo_detector
-
>
GetMetrics
(
)
;
ASSERT_TRUE
(
ed_metrics
.
echo_likelihood
)
;
EXPECT_NEAR
(
1
.
f
ed_metrics
.
echo_likelihood
.
value
(
)
0
.
01f
)
;
}
}
