#
include
"
modules
/
audio_processing
/
aec3
/
reverb_model_estimator
.
h
"
namespace
webrtc
{
ReverbModelEstimator
:
:
ReverbModelEstimator
(
const
EchoCanceller3Config
&
config
size_t
num_capture_channels
)
:
reverb_decay_estimators_
(
num_capture_channels
)
reverb_frequency_responses_
(
num_capture_channels
ReverbFrequencyResponse
(
config
.
ep_strength
.
use_conservative_tail_frequency_response
)
)
{
for
(
size_t
ch
=
0
;
ch
<
reverb_decay_estimators_
.
size
(
)
;
+
+
ch
)
{
reverb_decay_estimators_
[
ch
]
=
std
:
:
make_unique
<
ReverbDecayEstimator
>
(
config
)
;
}
}
ReverbModelEstimator
:
:
~
ReverbModelEstimator
(
)
=
default
;
void
ReverbModelEstimator
:
:
Update
(
ArrayView
<
const
std
:
:
vector
<
float
>
>
impulse_responses
ArrayView
<
const
std
:
:
vector
<
std
:
:
array
<
float
kFftLengthBy2Plus1
>
>
>
frequency_responses
ArrayView
<
const
std
:
:
optional
<
float
>
>
linear_filter_qualities
ArrayView
<
const
int
>
filter_delays_blocks
const
std
:
:
vector
<
bool
>
&
usable_linear_estimates
bool
stationary_block
)
{
const
size_t
num_capture_channels
=
reverb_decay_estimators_
.
size
(
)
;
RTC_DCHECK_EQ
(
num_capture_channels
impulse_responses
.
size
(
)
)
;
RTC_DCHECK_EQ
(
num_capture_channels
frequency_responses
.
size
(
)
)
;
RTC_DCHECK_EQ
(
num_capture_channels
usable_linear_estimates
.
size
(
)
)
;
for
(
size_t
ch
=
0
;
ch
<
num_capture_channels
;
+
+
ch
)
{
reverb_frequency_responses_
[
ch
]
.
Update
(
frequency_responses
[
ch
]
filter_delays_blocks
[
ch
]
linear_filter_qualities
[
ch
]
stationary_block
)
;
reverb_decay_estimators_
[
ch
]
-
>
Update
(
impulse_responses
[
ch
]
linear_filter_qualities
[
ch
]
filter_delays_blocks
[
ch
]
usable_linear_estimates
[
ch
]
stationary_block
)
;
}
}
}
