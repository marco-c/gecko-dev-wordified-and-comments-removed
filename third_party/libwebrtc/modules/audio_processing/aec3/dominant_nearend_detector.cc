#
include
"
modules
/
audio_processing
/
aec3
/
dominant_nearend_detector
.
h
"
#
include
<
numeric
>
namespace
webrtc
{
DominantNearendDetector
:
:
DominantNearendDetector
(
const
EchoCanceller3Config
:
:
Suppressor
:
:
DominantNearendDetection
&
config
size_t
num_capture_channels
)
:
enr_threshold_
(
config
.
enr_threshold
)
enr_exit_threshold_
(
config
.
enr_exit_threshold
)
snr_threshold_
(
config
.
snr_threshold
)
hold_duration_
(
config
.
hold_duration
)
trigger_threshold_
(
config
.
trigger_threshold
)
use_during_initial_phase_
(
config
.
use_during_initial_phase
)
num_capture_channels_
(
num_capture_channels
)
trigger_counters_
(
num_capture_channels_
)
hold_counters_
(
num_capture_channels_
)
{
}
void
DominantNearendDetector
:
:
Update
(
ArrayView
<
const
std
:
:
array
<
float
kFftLengthBy2Plus1
>
>
nearend_spectrum
ArrayView
<
const
std
:
:
array
<
float
kFftLengthBy2Plus1
>
>
residual_echo_spectrum
ArrayView
<
const
std
:
:
array
<
float
kFftLengthBy2Plus1
>
>
comfort_noise_spectrum
bool
initial_state
)
{
nearend_state_
=
false
;
auto
low_frequency_energy
=
[
]
(
ArrayView
<
const
float
>
spectrum
)
{
RTC_DCHECK_LE
(
16
spectrum
.
size
(
)
)
;
return
std
:
:
accumulate
(
spectrum
.
begin
(
)
+
1
spectrum
.
begin
(
)
+
16
0
.
f
)
;
}
;
for
(
size_t
ch
=
0
;
ch
<
num_capture_channels_
;
+
+
ch
)
{
const
float
ne_sum
=
low_frequency_energy
(
nearend_spectrum
[
ch
]
)
;
const
float
echo_sum
=
low_frequency_energy
(
residual_echo_spectrum
[
ch
]
)
;
const
float
noise_sum
=
low_frequency_energy
(
comfort_noise_spectrum
[
ch
]
)
;
if
(
(
!
initial_state
|
|
use_during_initial_phase_
)
&
&
echo_sum
<
enr_threshold_
*
ne_sum
&
&
ne_sum
>
snr_threshold_
*
noise_sum
)
{
if
(
+
+
trigger_counters_
[
ch
]
>
=
trigger_threshold_
)
{
hold_counters_
[
ch
]
=
hold_duration_
;
trigger_counters_
[
ch
]
=
trigger_threshold_
;
}
}
else
{
trigger_counters_
[
ch
]
=
std
:
:
max
(
0
trigger_counters_
[
ch
]
-
1
)
;
}
if
(
echo_sum
>
enr_exit_threshold_
*
ne_sum
&
&
echo_sum
>
snr_threshold_
*
noise_sum
)
{
hold_counters_
[
ch
]
=
0
;
}
hold_counters_
[
ch
]
=
std
:
:
max
(
0
hold_counters_
[
ch
]
-
1
)
;
nearend_state_
=
nearend_state_
|
|
hold_counters_
[
ch
]
>
0
;
}
}
}
