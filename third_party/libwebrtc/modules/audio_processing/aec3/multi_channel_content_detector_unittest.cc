#
include
"
modules
/
audio_processing
/
aec3
/
multi_channel_content_detector
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
TEST
(
MultiChannelContentDetector
HandlingOfMono
)
{
MultiChannelContentDetector
mc
(
true
1
0
.
0f
0
0
.
0f
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
TEST
(
MultiChannelContentDetector
HandlingOfMonoAndDetectionOff
)
{
MultiChannelContentDetector
mc
(
false
1
0
.
0f
0
0
.
0f
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
TEST
(
MultiChannelContentDetector
HandlingOfDetectionOff
)
{
MultiChannelContentDetector
mc
(
false
2
0
.
0f
0
0
.
0f
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
frame
(
1
std
:
:
vector
<
std
:
:
vector
<
float
>
>
(
2
std
:
:
vector
<
float
>
(
160
0
.
0f
)
)
)
;
std
:
:
fill
(
frame
[
0
]
[
0
]
.
begin
(
)
frame
[
0
]
[
0
]
.
end
(
)
100
.
0f
)
;
std
:
:
fill
(
frame
[
0
]
[
1
]
.
begin
(
)
frame
[
0
]
[
1
]
.
end
(
)
101
.
0f
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
}
TEST
(
MultiChannelContentDetector
InitialDetectionOfStereo
)
{
MultiChannelContentDetector
mc
(
true
2
0
.
0f
0
0
.
0f
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
TEST
(
MultiChannelContentDetector
DetectionWhenFakeStereo
)
{
MultiChannelContentDetector
mc
(
true
2
0
.
0f
0
0
.
0f
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
frame
(
1
std
:
:
vector
<
std
:
:
vector
<
float
>
>
(
2
std
:
:
vector
<
float
>
(
160
0
.
0f
)
)
)
;
std
:
:
fill
(
frame
[
0
]
[
0
]
.
begin
(
)
frame
[
0
]
[
0
]
.
end
(
)
100
.
0f
)
;
std
:
:
fill
(
frame
[
0
]
[
1
]
.
begin
(
)
frame
[
0
]
[
1
]
.
end
(
)
100
.
0f
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
}
TEST
(
MultiChannelContentDetector
DetectionWhenStereo
)
{
MultiChannelContentDetector
mc
(
true
2
0
.
0f
0
0
.
0f
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
frame
(
1
std
:
:
vector
<
std
:
:
vector
<
float
>
>
(
2
std
:
:
vector
<
float
>
(
160
0
.
0f
)
)
)
;
std
:
:
fill
(
frame
[
0
]
[
0
]
.
begin
(
)
frame
[
0
]
[
0
]
.
end
(
)
100
.
0f
)
;
std
:
:
fill
(
frame
[
0
]
[
1
]
.
begin
(
)
frame
[
0
]
[
1
]
.
end
(
)
101
.
0f
)
;
EXPECT_TRUE
(
mc
.
UpdateDetection
(
frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
}
TEST
(
MultiChannelContentDetector
DetectionWhenStereoAfterAWhile
)
{
MultiChannelContentDetector
mc
(
true
2
0
.
0f
0
0
.
0f
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
frame
(
1
std
:
:
vector
<
std
:
:
vector
<
float
>
>
(
2
std
:
:
vector
<
float
>
(
160
0
.
0f
)
)
)
;
std
:
:
fill
(
frame
[
0
]
[
0
]
.
begin
(
)
frame
[
0
]
[
0
]
.
end
(
)
100
.
0f
)
;
std
:
:
fill
(
frame
[
0
]
[
1
]
.
begin
(
)
frame
[
0
]
[
1
]
.
end
(
)
100
.
0f
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
std
:
:
fill
(
frame
[
0
]
[
0
]
.
begin
(
)
frame
[
0
]
[
0
]
.
end
(
)
100
.
0f
)
;
std
:
:
fill
(
frame
[
0
]
[
1
]
.
begin
(
)
frame
[
0
]
[
1
]
.
end
(
)
101
.
0f
)
;
EXPECT_TRUE
(
mc
.
UpdateDetection
(
frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
}
TEST
(
MultiChannelContentDetector
DetectionWithStereoBelowThreshold
)
{
constexpr
float
kThreshold
=
1
.
0f
;
MultiChannelContentDetector
mc
(
true
2
kThreshold
0
0
.
0f
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
frame
(
1
std
:
:
vector
<
std
:
:
vector
<
float
>
>
(
2
std
:
:
vector
<
float
>
(
160
0
.
0f
)
)
)
;
std
:
:
fill
(
frame
[
0
]
[
0
]
.
begin
(
)
frame
[
0
]
[
0
]
.
end
(
)
100
.
0f
)
;
std
:
:
fill
(
frame
[
0
]
[
1
]
.
begin
(
)
frame
[
0
]
[
1
]
.
end
(
)
100
.
0f
+
kThreshold
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
}
TEST
(
MultiChannelContentDetector
DetectionWithStereoAboveThreshold
)
{
constexpr
float
kThreshold
=
1
.
0f
;
MultiChannelContentDetector
mc
(
true
2
kThreshold
0
0
.
0f
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
frame
(
1
std
:
:
vector
<
std
:
:
vector
<
float
>
>
(
2
std
:
:
vector
<
float
>
(
160
0
.
0f
)
)
)
;
std
:
:
fill
(
frame
[
0
]
[
0
]
.
begin
(
)
frame
[
0
]
[
0
]
.
end
(
)
100
.
0f
)
;
std
:
:
fill
(
frame
[
0
]
[
1
]
.
begin
(
)
frame
[
0
]
[
1
]
.
end
(
)
100
.
0f
+
kThreshold
+
0
.
1f
)
;
EXPECT_TRUE
(
mc
.
UpdateDetection
(
frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
UpdateDetection
(
frame
)
)
;
}
class
MultiChannelContentDetectorTimeoutBehavior
:
public
:
:
testing
:
:
Test
public
:
:
testing
:
:
WithParamInterface
<
std
:
:
tuple
<
bool
int
>
>
{
}
;
INSTANTIATE_TEST_SUITE_P
(
MultiChannelContentDetector
MultiChannelContentDetectorTimeoutBehavior
:
:
testing
:
:
Combine
(
:
:
testing
:
:
Values
(
false
true
)
:
:
testing
:
:
Values
(
0
1
10
)
)
)
;
TEST_P
(
MultiChannelContentDetectorTimeoutBehavior
TimeOutBehaviorForNonTrueStereo
)
{
constexpr
int
kNumFramesPerSecond
=
100
;
const
bool
detect_stereo_content
=
std
:
:
get
<
0
>
(
GetParam
(
)
)
;
const
int
stereo_detection_timeout_threshold_seconds
=
std
:
:
get
<
1
>
(
GetParam
(
)
)
;
const
int
stereo_detection_timeout_threshold_frames
=
stereo_detection_timeout_threshold_seconds
*
kNumFramesPerSecond
;
MultiChannelContentDetector
mc
(
detect_stereo_content
2
0
.
0f
stereo_detection_timeout_threshold_seconds
0
.
0f
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
true_stereo_frame
=
{
{
std
:
:
vector
<
float
>
(
160
100
.
0f
)
std
:
:
vector
<
float
>
(
160
101
.
0f
)
}
}
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
fake_stereo_frame
=
{
{
std
:
:
vector
<
float
>
(
160
100
.
0f
)
std
:
:
vector
<
float
>
(
160
100
.
0f
)
}
}
;
for
(
int
k
=
0
;
k
<
10
;
+
+
k
)
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
if
(
detect_stereo_content
)
{
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
else
{
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
}
if
(
detect_stereo_content
)
{
EXPECT_TRUE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
}
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
for
(
int
k
=
0
;
k
<
stereo_detection_timeout_threshold_frames
-
1
;
+
+
k
)
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
if
(
detect_stereo_content
&
&
stereo_detection_timeout_threshold_frames
>
0
)
{
EXPECT_TRUE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
for
(
int
k
=
0
;
k
<
10
;
+
+
k
)
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
if
(
detect_stereo_content
&
&
stereo_detection_timeout_threshold_frames
>
0
)
{
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
else
{
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
}
}
class
MultiChannelContentDetectorHysteresisBehavior
:
public
:
:
testing
:
:
Test
public
:
:
testing
:
:
WithParamInterface
<
std
:
:
tuple
<
bool
float
>
>
{
}
;
INSTANTIATE_TEST_SUITE_P
(
MultiChannelContentDetector
MultiChannelContentDetectorHysteresisBehavior
:
:
testing
:
:
Combine
(
:
:
testing
:
:
Values
(
false
true
)
:
:
testing
:
:
Values
(
0
.
0f
0
.
1f
0
.
2f
)
)
)
;
TEST_P
(
MultiChannelContentDetectorHysteresisBehavior
PeriodBeforeStereoDetectionIsTriggered
)
{
constexpr
int
kNumFramesPerSecond
=
100
;
const
bool
detect_stereo_content
=
std
:
:
get
<
0
>
(
GetParam
(
)
)
;
const
int
stereo_detection_hysteresis_seconds
=
std
:
:
get
<
1
>
(
GetParam
(
)
)
;
const
int
stereo_detection_hysteresis_frames
=
stereo_detection_hysteresis_seconds
*
kNumFramesPerSecond
;
MultiChannelContentDetector
mc
(
detect_stereo_content
2
0
.
0f
0
stereo_detection_hysteresis_seconds
)
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
true_stereo_frame
=
{
{
std
:
:
vector
<
float
>
(
160
100
.
0f
)
std
:
:
vector
<
float
>
(
160
101
.
0f
)
}
}
;
std
:
:
vector
<
std
:
:
vector
<
std
:
:
vector
<
float
>
>
>
fake_stereo_frame
=
{
{
std
:
:
vector
<
float
>
(
160
100
.
0f
)
std
:
:
vector
<
float
>
(
160
100
.
0f
)
}
}
;
for
(
int
k
=
0
;
k
<
10
;
+
+
k
)
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
if
(
detect_stereo_content
)
{
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
else
{
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
}
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
ASSERT_TRUE
(
stereo_detection_hysteresis_frames
>
2
|
|
stereo_detection_hysteresis_frames
=
=
0
)
;
for
(
int
k
=
0
;
k
<
2
;
+
+
k
)
{
if
(
detect_stereo_content
)
{
if
(
stereo_detection_hysteresis_seconds
=
=
0
.
0f
)
{
if
(
k
=
=
0
)
{
EXPECT_TRUE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
}
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_TRUE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
}
if
(
stereo_detection_hysteresis_seconds
=
=
0
.
0f
)
{
return
;
}
for
(
int
k
=
0
;
k
<
stereo_detection_hysteresis_frames
-
3
;
+
+
k
)
{
if
(
detect_stereo_content
)
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_FALSE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_TRUE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
}
if
(
detect_stereo_content
)
{
EXPECT_TRUE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
if
(
detect_stereo_content
)
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
true_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
if
(
detect_stereo_content
)
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
else
{
EXPECT_FALSE
(
mc
.
UpdateDetection
(
fake_stereo_frame
)
)
;
EXPECT_TRUE
(
mc
.
IsProperMultiChannelContentDetected
(
)
)
;
EXPECT_FALSE
(
mc
.
IsTemporaryMultiChannelContentDetectedForTesting
(
)
)
;
}
}
}
