#
include
"
modules
/
audio_processing
/
aec3
/
neural_feature_extractor
.
h
"
#
include
<
algorithm
>
#
include
<
cmath
>
#
include
<
cstring
>
#
include
<
vector
>
#
include
"
api
/
array_view
.
h
"
#
include
"
common_audio
/
window_generator
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
third_party
/
pffft
/
src
/
pffft
.
h
"
namespace
webrtc
{
namespace
{
constexpr
float
kScale
=
1
.
0f
/
32768
;
constexpr
float
kSpectrumCompressionExponent
=
0
.
15f
;
std
:
:
vector
<
float
>
GetSqrtHanningWindow
(
int
frame_size
float
scale
)
{
std
:
:
vector
<
float
>
window
(
frame_size
)
;
WindowGenerator
:
:
Hanning
(
frame_size
window
.
data
(
)
)
;
std
:
:
transform
(
window
.
begin
(
)
window
.
end
(
)
window
.
begin
(
)
[
scale
]
(
float
x
)
{
return
scale
*
std
:
:
sqrt
(
x
)
;
}
)
;
return
window
;
}
}
void
TimeDomainFeatureExtractor
:
:
PushFeaturesToModelInput
(
std
:
:
vector
<
float
>
&
frame
ArrayView
<
float
>
input
)
{
std
:
:
copy
(
input
.
begin
(
)
+
frame
.
size
(
)
input
.
end
(
)
input
.
begin
(
)
)
;
std
:
:
transform
(
frame
.
begin
(
)
frame
.
end
(
)
input
.
end
(
)
-
frame
.
size
(
)
[
]
(
float
x
)
{
return
x
*
kScale
;
}
)
;
frame
.
clear
(
)
;
}
FrequencyDomainFeatureExtractor
:
:
FrequencyDomainFeatureExtractor
(
int
step_size
)
:
step_size_
(
step_size
)
frame_size_
(
2
*
step_size_
)
sqrt_hanning_
(
GetSqrtHanningWindow
(
frame_size_
kScale
)
)
data_
(
static_cast
<
float
*
>
(
pffft_aligned_malloc
(
frame_size_
*
sizeof
(
float
)
)
)
)
spectrum_
(
static_cast
<
float
*
>
(
pffft_aligned_malloc
(
frame_size_
*
sizeof
(
float
)
)
)
)
pffft_setup_
(
pffft_new_setup
(
frame_size_
PFFFT_REAL
)
)
{
std
:
:
memset
(
data_
0
sizeof
(
float
)
*
frame_size_
)
;
std
:
:
memset
(
spectrum_
0
sizeof
(
float
)
*
frame_size_
)
;
}
FrequencyDomainFeatureExtractor
:
:
~
FrequencyDomainFeatureExtractor
(
)
{
pffft_destroy_setup
(
pffft_setup_
)
;
pffft_aligned_free
(
spectrum_
)
;
pffft_aligned_free
(
data_
)
;
}
void
FrequencyDomainFeatureExtractor
:
:
PushFeaturesToModelInput
(
std
:
:
vector
<
float
>
&
frame
ArrayView
<
float
>
input
)
{
std
:
:
memcpy
(
data_
+
step_size_
frame
.
data
(
)
sizeof
(
float
)
*
step_size_
)
;
for
(
int
k
=
0
;
k
<
frame_size_
;
+
+
k
)
{
data_
[
k
]
*
=
sqrt_hanning_
[
k
]
;
}
pffft_transform_ordered
(
pffft_setup_
data_
spectrum_
nullptr
PFFFT_FORWARD
)
;
RTC_CHECK_EQ
(
input
.
size
(
)
step_size_
+
1
)
;
input
[
0
]
=
spectrum_
[
0
]
*
spectrum_
[
0
]
;
input
[
step_size_
]
=
spectrum_
[
1
]
*
spectrum_
[
1
]
;
for
(
int
k
=
1
;
k
<
step_size_
;
k
+
+
)
{
input
[
k
]
=
spectrum_
[
2
*
k
]
*
spectrum_
[
2
*
k
]
+
spectrum_
[
2
*
k
+
1
]
*
spectrum_
[
2
*
k
+
1
]
;
}
std
:
:
transform
(
input
.
begin
(
)
input
.
end
(
)
input
.
begin
(
)
[
]
(
float
a
)
{
return
std
:
:
pow
(
a
kSpectrumCompressionExponent
)
;
}
)
;
std
:
:
memcpy
(
data_
frame
.
data
(
)
sizeof
(
float
)
*
step_size_
)
;
}
}
