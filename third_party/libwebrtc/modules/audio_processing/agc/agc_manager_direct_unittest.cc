#
include
"
modules
/
audio_processing
/
agc
/
agc_manager_direct
.
h
"
#
include
<
fstream
>
#
include
<
limits
>
#
include
<
vector
>
#
include
"
modules
/
audio_processing
/
agc
/
gain_control
.
h
"
#
include
"
modules
/
audio_processing
/
agc
/
mock_agc
.
h
"
#
include
"
modules
/
audio_processing
/
include
/
mock_audio_processing
.
h
"
#
include
"
rtc_base
/
numerics
/
safe_minmax
.
h
"
#
include
"
rtc_base
/
strings
/
string_builder
.
h
"
#
include
"
test
/
field_trial
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
testsupport
/
file_utils
.
h
"
using
:
:
testing
:
:
_
;
using
:
:
testing
:
:
AtLeast
;
using
:
:
testing
:
:
DoAll
;
using
:
:
testing
:
:
Return
;
using
:
:
testing
:
:
SetArgPointee
;
namespace
webrtc
{
namespace
{
constexpr
int
kSampleRateHz
=
32000
;
constexpr
int
kNumChannels
=
1
;
constexpr
int
kInitialInputVolume
=
128
;
constexpr
int
kClippedMin
=
165
;
constexpr
float
kAboveClippedThreshold
=
0
.
2f
;
constexpr
int
kMinMicLevel
=
12
;
constexpr
int
kClippedLevelStep
=
15
;
constexpr
float
kClippedRatioThreshold
=
0
.
1f
;
constexpr
int
kClippedWaitFrames
=
300
;
constexpr
float
kMinSample
=
std
:
:
numeric_limits
<
int16_t
>
:
:
min
(
)
;
constexpr
float
kMaxSample
=
std
:
:
numeric_limits
<
int16_t
>
:
:
max
(
)
;
using
AnalogAgcConfig
=
AudioProcessing
:
:
Config
:
:
GainController1
:
:
AnalogGainController
;
using
ClippingPredictorConfig
=
AudioProcessing
:
:
Config
:
:
GainController1
:
:
AnalogGainController
:
:
ClippingPredictor
;
constexpr
AnalogAgcConfig
kDefaultAnalogConfig
{
}
;
class
MockGainControl
:
public
GainControl
{
public
:
virtual
~
MockGainControl
(
)
{
}
MOCK_METHOD
(
int
set_stream_analog_level
(
int
level
)
(
override
)
)
;
MOCK_METHOD
(
int
stream_analog_level
(
)
(
const
override
)
)
;
MOCK_METHOD
(
int
set_mode
(
Mode
mode
)
(
override
)
)
;
MOCK_METHOD
(
Mode
mode
(
)
(
const
override
)
)
;
MOCK_METHOD
(
int
set_target_level_dbfs
(
int
level
)
(
override
)
)
;
MOCK_METHOD
(
int
target_level_dbfs
(
)
(
const
override
)
)
;
MOCK_METHOD
(
int
set_compression_gain_db
(
int
gain
)
(
override
)
)
;
MOCK_METHOD
(
int
compression_gain_db
(
)
(
const
override
)
)
;
MOCK_METHOD
(
int
enable_limiter
(
bool
enable
)
(
override
)
)
;
MOCK_METHOD
(
bool
is_limiter_enabled
(
)
(
const
override
)
)
;
MOCK_METHOD
(
int
set_analog_level_limits
(
int
minimum
int
maximum
)
(
override
)
)
;
MOCK_METHOD
(
int
analog_level_minimum
(
)
(
const
override
)
)
;
MOCK_METHOD
(
int
analog_level_maximum
(
)
(
const
override
)
)
;
MOCK_METHOD
(
bool
stream_is_saturated
(
)
(
const
override
)
)
;
}
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
CreateAgcManagerDirect
(
int
startup_min_volume
int
clipped_level_step
float
clipped_ratio_threshold
int
clipped_wait_frames
const
ClippingPredictorConfig
&
clipping_predictor_config
=
kDefaultAnalogConfig
.
clipping_predictor
)
{
AnalogAgcConfig
config
;
config
.
startup_min_volume
=
startup_min_volume
;
config
.
clipped_level_min
=
kClippedMin
;
config
.
enable_digital_adaptive
=
false
;
config
.
clipped_level_step
=
clipped_level_step
;
config
.
clipped_ratio_threshold
=
clipped_ratio_threshold
;
config
.
clipped_wait_frames
=
clipped_wait_frames
;
config
.
clipping_predictor
=
clipping_predictor_config
;
return
std
:
:
make_unique
<
AgcManagerDirect
>
(
1
config
)
;
}
void
CallPreProcessAudioBuffer
(
int
num_calls
float
peak_ratio
AgcManagerDirect
&
manager
)
{
RTC_DCHECK_LE
(
peak_ratio
1
.
0f
)
;
AudioBuffer
audio_buffer
(
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
)
;
const
int
num_channels
=
audio_buffer
.
num_channels
(
)
;
const
int
num_frames
=
audio_buffer
.
num_frames
(
)
;
for
(
int
ch
=
0
;
ch
<
num_channels
;
+
+
ch
)
{
for
(
int
i
=
0
;
i
<
num_frames
;
i
+
=
2
)
{
audio_buffer
.
channels
(
)
[
ch
]
[
i
]
=
peak_ratio
*
32767
.
0f
;
audio_buffer
.
channels
(
)
[
ch
]
[
i
+
1
]
=
0
.
0f
;
}
}
for
(
int
n
=
0
;
n
<
num_calls
/
2
;
+
+
n
)
{
manager
.
AnalyzePreProcess
(
audio_buffer
)
;
}
for
(
int
ch
=
0
;
ch
<
num_channels
;
+
+
ch
)
{
for
(
int
i
=
0
;
i
<
num_frames
;
+
+
i
)
{
audio_buffer
.
channels
(
)
[
ch
]
[
i
]
=
peak_ratio
*
32767
.
0f
;
}
}
for
(
int
n
=
0
;
n
<
num_calls
-
num_calls
/
2
;
+
+
n
)
{
manager
.
AnalyzePreProcess
(
audio_buffer
)
;
}
}
constexpr
char
kMinMicLevelFieldTrial
[
]
=
"
WebRTC
-
Audio
-
2ndAgcMinMicLevelExperiment
"
;
std
:
:
string
GetAgcMinMicLevelExperimentFieldTrial
(
const
std
:
:
string
&
value
)
{
char
field_trial_buffer
[
64
]
;
rtc
:
:
SimpleStringBuilder
builder
(
field_trial_buffer
)
;
builder
<
<
kMinMicLevelFieldTrial
<
<
"
/
"
<
<
value
<
<
"
/
"
;
return
builder
.
str
(
)
;
}
std
:
:
string
GetAgcMinMicLevelExperimentFieldTrialEnabled
(
int
enabled_value
const
std
:
:
string
&
suffix
=
"
"
)
{
RTC_DCHECK_GE
(
enabled_value
0
)
;
RTC_DCHECK_LE
(
enabled_value
255
)
;
char
field_trial_buffer
[
64
]
;
rtc
:
:
SimpleStringBuilder
builder
(
field_trial_buffer
)
;
builder
<
<
kMinMicLevelFieldTrial
<
<
"
/
Enabled
-
"
<
<
enabled_value
<
<
suffix
<
<
"
/
"
;
return
builder
.
str
(
)
;
}
std
:
:
string
GetAgcMinMicLevelExperimentFieldTrial
(
absl
:
:
optional
<
int
>
min_mic_level
)
{
if
(
min_mic_level
.
has_value
(
)
)
{
return
GetAgcMinMicLevelExperimentFieldTrialEnabled
(
*
min_mic_level
)
;
}
return
GetAgcMinMicLevelExperimentFieldTrial
(
"
Disabled
"
)
;
}
void
WriteAudioBufferSamples
(
float
samples_value
float
clipped_ratio
AudioBuffer
&
audio_buffer
)
{
RTC_DCHECK_GE
(
samples_value
kMinSample
)
;
RTC_DCHECK_LE
(
samples_value
kMaxSample
)
;
RTC_DCHECK_GE
(
clipped_ratio
0
.
0f
)
;
RTC_DCHECK_LE
(
clipped_ratio
1
.
0f
)
;
int
num_channels
=
audio_buffer
.
num_channels
(
)
;
int
num_samples
=
audio_buffer
.
num_frames
(
)
;
int
num_clipping_samples
=
clipped_ratio
*
num_samples
;
for
(
int
ch
=
0
;
ch
<
num_channels
;
+
+
ch
)
{
int
i
=
0
;
for
(
;
i
<
num_clipping_samples
;
+
+
i
)
{
audio_buffer
.
channels
(
)
[
ch
]
[
i
]
=
32767
.
0f
;
}
for
(
;
i
<
num_samples
;
+
+
i
)
{
audio_buffer
.
channels
(
)
[
ch
]
[
i
]
=
samples_value
;
}
}
}
void
CallPreProcessAndProcess
(
int
num_calls
const
AudioBuffer
&
audio_buffer
AgcManagerDirect
&
manager
)
{
for
(
int
n
=
0
;
n
<
num_calls
;
+
+
n
)
{
manager
.
AnalyzePreProcess
(
audio_buffer
)
;
manager
.
Process
(
audio_buffer
)
;
}
}
class
SpeechSamplesReader
{
private
:
static
constexpr
int
kPcmSampleRateHz
=
16000
;
static
constexpr
int
kPcmNumChannels
=
1
;
static
constexpr
int
kPcmBytesPerSamples
=
sizeof
(
int16_t
)
;
public
:
SpeechSamplesReader
(
)
:
is_
(
test
:
:
ResourcePath
(
"
audio_processing
/
agc
/
agc_audio
"
"
pcm
"
)
std
:
:
ios
:
:
binary
|
std
:
:
ios
:
:
ate
)
audio_buffer_
(
kPcmSampleRateHz
kPcmNumChannels
kPcmSampleRateHz
kPcmNumChannels
kPcmSampleRateHz
kPcmNumChannels
)
buffer_
(
audio_buffer_
.
num_frames
(
)
)
buffer_num_bytes_
(
buffer_
.
size
(
)
*
kPcmBytesPerSamples
)
{
RTC_CHECK
(
is_
)
;
}
void
Feed
(
int
num_frames
int
gain_db
AgcManagerDirect
&
agc
)
{
float
gain
=
std
:
:
pow
(
10
.
0f
gain_db
/
20
.
0f
)
;
is_
.
seekg
(
0
is_
.
beg
)
;
for
(
int
i
=
0
;
i
<
num_frames
;
+
+
i
)
{
is_
.
read
(
reinterpret_cast
<
char
*
>
(
buffer_
.
data
(
)
)
buffer_num_bytes_
)
;
if
(
is_
.
gcount
(
)
<
buffer_num_bytes_
)
{
break
;
}
std
:
:
transform
(
buffer_
.
begin
(
)
buffer_
.
end
(
)
audio_buffer_
.
channels
(
)
[
0
]
[
gain
]
(
int16_t
v
)
-
>
float
{
return
rtc
:
:
SafeClamp
(
static_cast
<
float
>
(
v
)
*
gain
kMinSample
kMaxSample
)
;
}
)
;
agc
.
AnalyzePreProcess
(
audio_buffer_
)
;
agc
.
Process
(
audio_buffer_
)
;
}
}
private
:
std
:
:
ifstream
is_
;
AudioBuffer
audio_buffer_
;
std
:
:
vector
<
int16_t
>
buffer_
;
const
std
:
:
streamsize
buffer_num_bytes_
;
}
;
}
constexpr
AnalogAgcConfig
GetAnalogAgcTestConfig
(
)
{
AnalogAgcConfig
config
;
config
.
enabled
=
true
;
config
.
startup_min_volume
=
kInitialInputVolume
;
config
.
clipped_level_min
=
kClippedMin
;
config
.
enable_digital_adaptive
=
true
;
config
.
clipped_level_step
=
kClippedLevelStep
;
config
.
clipped_ratio_threshold
=
kClippedRatioThreshold
;
config
.
clipped_wait_frames
=
kClippedWaitFrames
;
config
.
clipping_predictor
=
kDefaultAnalogConfig
.
clipping_predictor
;
return
config
;
}
constexpr
AnalogAgcConfig
GetDisabledAnalogAgcConfig
(
)
{
AnalogAgcConfig
config
=
GetAnalogAgcTestConfig
(
)
;
config
.
enabled
=
false
;
return
config
;
}
class
AgcManagerDirectTestHelper
{
public
:
AgcManagerDirectTestHelper
(
)
:
audio_buffer
(
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
)
mock_agc
(
new
:
:
testing
:
:
NiceMock
<
MockAgc
>
(
)
)
manager
(
GetAnalogAgcTestConfig
(
)
mock_agc
)
{
manager
.
Initialize
(
)
;
manager
.
SetupDigitalGainControl
(
mock_gain_control
)
;
WriteAudioBufferSamples
(
0
.
0f
0
.
0f
audio_buffer
)
;
}
int
CallAgcSequence
(
int
applied_input_volume
)
{
manager
.
set_stream_analog_level
(
applied_input_volume
)
;
manager
.
AnalyzePreProcess
(
audio_buffer
)
;
manager
.
Process
(
audio_buffer
)
;
absl
:
:
optional
<
int
>
digital_gain
=
manager
.
GetDigitalComressionGain
(
)
;
if
(
digital_gain
)
{
mock_gain_control
.
set_compression_gain_db
(
*
digital_gain
)
;
}
return
manager
.
recommended_analog_level
(
)
;
}
void
CallProcess
(
int
num_calls
)
{
for
(
int
i
=
0
;
i
<
num_calls
;
+
+
i
)
{
EXPECT_CALL
(
*
mock_agc
Process
(
_
)
)
.
WillOnce
(
Return
(
)
)
;
manager
.
Process
(
audio_buffer
)
;
absl
:
:
optional
<
int
>
new_digital_gain
=
manager
.
GetDigitalComressionGain
(
)
;
if
(
new_digital_gain
)
{
mock_gain_control
.
set_compression_gain_db
(
*
new_digital_gain
)
;
}
}
}
void
CallPreProc
(
int
num_calls
float
clipped_ratio
)
{
RTC_DCHECK_GE
(
clipped_ratio
0
.
0f
)
;
RTC_DCHECK_LE
(
clipped_ratio
1
.
0f
)
;
WriteAudioBufferSamples
(
0
.
0f
clipped_ratio
audio_buffer
)
;
for
(
int
i
=
0
;
i
<
num_calls
;
+
+
i
)
{
manager
.
AnalyzePreProcess
(
audio_buffer
)
;
}
}
void
CallPreProcForChangingAudio
(
int
num_calls
float
peak_ratio
)
{
RTC_DCHECK_GE
(
peak_ratio
0
.
0f
)
;
RTC_DCHECK_LE
(
peak_ratio
1
.
0f
)
;
const
float
samples_value
=
peak_ratio
*
32767
.
0f
;
WriteAudioBufferSamples
(
samples_value
0
.
0f
audio_buffer
)
;
for
(
size_t
ch
=
0
;
ch
<
audio_buffer
.
num_channels
(
)
;
+
+
ch
)
{
for
(
size_t
k
=
1
;
k
<
audio_buffer
.
num_frames
(
)
;
k
+
=
2
)
{
audio_buffer
.
channels
(
)
[
ch
]
[
k
]
=
0
.
0f
;
}
}
for
(
int
i
=
0
;
i
<
num_calls
/
2
;
+
+
i
)
{
manager
.
AnalyzePreProcess
(
audio_buffer
)
;
}
WriteAudioBufferSamples
(
samples_value
0
.
0f
audio_buffer
)
;
for
(
int
i
=
0
;
i
<
num_calls
-
num_calls
/
2
;
+
+
i
)
{
manager
.
AnalyzePreProcess
(
audio_buffer
)
;
}
}
AudioBuffer
audio_buffer
;
MockAgc
*
mock_agc
;
AgcManagerDirect
manager
;
MockGainControl
mock_gain_control
;
}
;
class
AgcManagerDirectParametrizedTest
:
public
:
:
testing
:
:
TestWithParam
<
absl
:
:
optional
<
int
>
>
{
protected
:
AgcManagerDirectParametrizedTest
(
)
:
field_trials_
(
GetAgcMinMicLevelExperimentFieldTrial
(
GetParam
(
)
)
)
{
}
bool
IsMinMicLevelOverridden
(
)
const
{
return
GetParam
(
)
.
has_value
(
)
;
}
int
GetMinMicLevel
(
)
const
{
return
GetParam
(
)
.
value_or
(
kMinMicLevel
)
;
}
private
:
test
:
:
ScopedFieldTrials
field_trials_
;
}
;
INSTANTIATE_TEST_SUITE_P
(
AgcManagerDirectParametrizedTest
testing
:
:
Values
(
absl
:
:
nullopt
12
20
)
)
;
TEST_P
(
AgcManagerDirectParametrizedTest
DisabledAnalogAgcDoesNotAdaptDownwards
)
{
AgcManagerDirect
manager_no_analog_agc
(
kNumChannels
GetDisabledAnalogAgcConfig
(
)
)
;
manager_no_analog_agc
.
Initialize
(
)
;
AgcManagerDirect
manager_with_analog_agc
(
kNumChannels
GetAnalogAgcTestConfig
(
)
)
;
manager_with_analog_agc
.
Initialize
(
)
;
AudioBuffer
audio_buffer
(
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
)
;
constexpr
int
kAnalogLevel
=
250
;
static_assert
(
kAnalogLevel
>
kInitialInputVolume
"
Increase
kAnalogLevel
.
"
)
;
manager_no_analog_agc
.
set_stream_analog_level
(
kAnalogLevel
)
;
manager_with_analog_agc
.
set_stream_analog_level
(
kAnalogLevel
)
;
WriteAudioBufferSamples
(
0
.
0f
0
.
0f
audio_buffer
)
;
manager_no_analog_agc
.
AnalyzePreProcess
(
audio_buffer
)
;
manager_with_analog_agc
.
AnalyzePreProcess
(
audio_buffer
)
;
manager_no_analog_agc
.
Process
(
audio_buffer
)
;
manager_with_analog_agc
.
Process
(
audio_buffer
)
;
WriteAudioBufferSamples
(
0
.
0f
0
.
2f
audio_buffer
)
;
manager_no_analog_agc
.
AnalyzePreProcess
(
audio_buffer
)
;
manager_with_analog_agc
.
AnalyzePreProcess
(
audio_buffer
)
;
manager_no_analog_agc
.
Process
(
audio_buffer
)
;
manager_with_analog_agc
.
Process
(
audio_buffer
)
;
EXPECT_EQ
(
manager_no_analog_agc
.
recommended_analog_level
(
)
kAnalogLevel
)
;
ASSERT_LT
(
manager_with_analog_agc
.
recommended_analog_level
(
)
kAnalogLevel
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
DisabledAnalogAgcDoesNotAdaptUpwards
)
{
AgcManagerDirect
manager_no_analog_agc
(
kNumChannels
GetDisabledAnalogAgcConfig
(
)
)
;
manager_no_analog_agc
.
Initialize
(
)
;
AgcManagerDirect
manager_with_analog_agc
(
kNumChannels
GetAnalogAgcTestConfig
(
)
)
;
manager_with_analog_agc
.
Initialize
(
)
;
constexpr
int
kAnalogLevel
=
kInitialInputVolume
;
manager_no_analog_agc
.
set_stream_analog_level
(
kAnalogLevel
)
;
manager_with_analog_agc
.
set_stream_analog_level
(
kAnalogLevel
)
;
constexpr
int
kNumFrames
=
125
;
constexpr
int
kGainDb
=
-
20
;
SpeechSamplesReader
reader
;
reader
.
Feed
(
kNumFrames
kGainDb
manager_no_analog_agc
)
;
reader
.
Feed
(
kNumFrames
kGainDb
manager_with_analog_agc
)
;
EXPECT_EQ
(
manager_no_analog_agc
.
recommended_analog_level
(
)
kAnalogLevel
)
;
ASSERT_GT
(
manager_with_analog_agc
.
recommended_analog_level
(
)
kAnalogLevel
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
StartupMinVolumeConfigurationIsRespected
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_EQ
(
kInitialInputVolume
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
MicVolumeResponseToRmsError
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
130
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
20
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
168
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
167
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
163
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
9
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
129
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
MicVolumeIsLimited
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
183
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
243
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
255
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
254
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
194
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
137
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
88
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
54
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
33
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
std
:
:
max
(
18
GetMinMicLevel
(
)
)
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
std
:
:
max
(
12
GetMinMicLevel
(
)
)
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
CompressorStepsTowardsTarget
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
9
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
5
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
9
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
20
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
CompressorErrorIsDeemphasized
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
7
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
6
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
_
)
)
.
Times
(
0
)
;
helper
.
CallProcess
(
20
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
CompressorReachesMaximum
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
10
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
10
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
11
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
12
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
CompressorReachesMinimum
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
0
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
6
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
5
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
4
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
3
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
2
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
NoActionWhileMuted
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
helper
.
manager
.
HandleCaptureOutputUsedChange
(
false
)
;
helper
.
manager
.
Process
(
helper
.
audio_buffer
)
;
absl
:
:
optional
<
int
>
new_digital_gain
=
helper
.
manager
.
GetDigitalComressionGain
(
)
;
if
(
new_digital_gain
)
{
helper
.
mock_gain_control
.
set_compression_gain_db
(
*
new_digital_gain
)
;
}
}
TEST_P
(
AgcManagerDirectParametrizedTest
UnmutingChecksVolumeWithoutRaising
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
helper
.
manager
.
HandleCaptureOutputUsedChange
(
false
)
;
helper
.
manager
.
HandleCaptureOutputUsedChange
(
true
)
;
constexpr
int
kInputVolume
=
127
;
helper
.
manager
.
set_stream_analog_level
(
kInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
Return
(
false
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
127
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
UnmutingRaisesTooLowVolume
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
helper
.
manager
.
HandleCaptureOutputUsedChange
(
false
)
;
helper
.
manager
.
HandleCaptureOutputUsedChange
(
true
)
;
constexpr
int
kInputVolume
=
11
;
helper
.
manager
.
set_stream_analog_level
(
kInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
Return
(
false
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
GetMinMicLevel
(
)
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ManualLevelChangeResultsInNoSetMicCall
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
ASSERT_NE
(
helper
.
manager
.
recommended_analog_level
(
)
154
)
;
helper
.
manager
.
set_stream_analog_level
(
154
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
154
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
manager
.
set_stream_analog_level
(
100
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
100
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
99
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
RecoveryAfterManualLevelChangeFromMax
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
183
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
243
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
255
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
manager
.
set_stream_analog_level
(
50
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
50
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
20
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
69
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST
(
AgcManagerDirectTest
RecoveryAfterManualLevelChangeBelowMin
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
manager
.
set_stream_analog_level
(
1
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
1
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
2
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
11
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
20
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
18
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
RecoveryAfterManualLevelChangeBelowMin
)
{
if
(
!
IsMinMicLevelOverridden
(
)
)
{
GTEST_SKIP
(
)
<
<
"
Skipped
.
Min
mic
level
not
overridden
.
"
;
}
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
1
)
Return
(
true
)
)
)
;
helper
.
manager
.
set_stream_analog_level
(
1
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
GetMinMicLevel
(
)
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
NoClippingHasNoImpact
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
helper
.
CallPreProc
(
100
0
)
;
EXPECT_EQ
(
128
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingUnderThresholdHasNoImpact
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
helper
.
CallPreProc
(
1
0
.
099
)
;
EXPECT_EQ
(
128
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingLowersVolume
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
255
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
0
.
2
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
WaitingPeriodBetweenClippingChecks
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
255
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
0
)
;
helper
.
CallPreProc
(
300
kAboveClippedThreshold
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
225
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingLoweringIsLimited
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
180
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
kClippedMin
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
0
)
;
helper
.
CallPreProc
(
1000
kAboveClippedThreshold
)
;
EXPECT_EQ
(
kClippedMin
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingMaxIsRespectedWhenEqualToLevel
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
255
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
10
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingMaxIsRespectedWhenHigherThanLevel
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
200
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
185
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallProcess
(
10
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
MaxCompressionIsIncreasedAfterClipping
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
210
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
195
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
11
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
8
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
9
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
10
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
11
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
12
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
13
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
helper
.
CallPreProc
(
300
kAboveClippedThreshold
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
180
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallPreProc
(
300
kAboveClippedThreshold
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
kClippedMin
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallPreProc
(
300
kAboveClippedThreshold
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
helper
.
CallPreProc
(
300
kAboveClippedThreshold
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
helper
.
CallPreProc
(
300
kAboveClippedThreshold
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
16
)
Return
(
true
)
)
)
.
WillRepeatedly
(
Return
(
false
)
)
;
helper
.
CallProcess
(
19
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
14
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
15
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
16
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
17
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
20
)
;
EXPECT_CALL
(
helper
.
mock_gain_control
set_compression_gain_db
(
18
)
)
.
WillOnce
(
Return
(
0
)
)
;
helper
.
CallProcess
(
1
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
UserCanRaiseVolumeAfterClipping
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
225
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
210
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
14
)
Return
(
true
)
)
)
;
helper
.
manager
.
set_stream_analog_level
(
250
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
AtLeast
(
1
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
250
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
-
10
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
210
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
40
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
250
helper
.
manager
.
recommended_analog_level
(
)
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillOnce
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
CallProcess
(
1
)
;
EXPECT_EQ
(
250
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingDoesNotPullLowVolumeBackUp
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
80
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
Reset
(
)
)
.
Times
(
0
)
;
int
initial_volume
=
helper
.
manager
.
recommended_analog_level
(
)
;
helper
.
CallPreProc
(
1
kAboveClippedThreshold
)
;
EXPECT_EQ
(
initial_volume
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
TakesNoActionOnZeroMicVolume
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
kInitialInputVolume
)
;
EXPECT_CALL
(
*
helper
.
mock_agc
GetRmsErrorDb
(
_
)
)
.
WillRepeatedly
(
DoAll
(
SetArgPointee
<
0
>
(
30
)
Return
(
true
)
)
)
;
helper
.
manager
.
set_stream_analog_level
(
0
)
;
helper
.
CallProcess
(
10
)
;
EXPECT_EQ
(
0
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingDetectionLowersVolume
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
255
)
;
EXPECT_EQ
(
255
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallPreProcForChangingAudio
(
100
0
.
99f
)
;
EXPECT_EQ
(
255
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallPreProcForChangingAudio
(
100
1
.
0f
)
;
EXPECT_EQ
(
240
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
DisabledClippingPredictorDoesNotLowerVolume
)
{
AgcManagerDirectTestHelper
helper
;
helper
.
CallAgcSequence
(
255
)
;
EXPECT_FALSE
(
helper
.
manager
.
clipping_predictor_enabled
(
)
)
;
EXPECT_EQ
(
255
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallPreProcForChangingAudio
(
100
0
.
99f
)
;
EXPECT_EQ
(
255
helper
.
manager
.
recommended_analog_level
(
)
)
;
helper
.
CallPreProcForChangingAudio
(
100
0
.
99f
)
;
EXPECT_EQ
(
255
helper
.
manager
.
recommended_analog_level
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
DisableDigitalDisablesDigital
)
{
auto
agc
=
std
:
:
unique_ptr
<
Agc
>
(
new
:
:
testing
:
:
NiceMock
<
MockAgc
>
(
)
)
;
MockGainControl
mock_gain_control
;
EXPECT_CALL
(
mock_gain_control
set_mode
(
GainControl
:
:
kFixedDigital
)
)
;
EXPECT_CALL
(
mock_gain_control
set_target_level_dbfs
(
0
)
)
;
EXPECT_CALL
(
mock_gain_control
set_compression_gain_db
(
0
)
)
;
EXPECT_CALL
(
mock_gain_control
enable_limiter
(
false
)
)
;
AnalogAgcConfig
config
;
config
.
enable_digital_adaptive
=
false
;
auto
manager
=
std
:
:
make_unique
<
AgcManagerDirect
>
(
kNumChannels
config
)
;
manager
-
>
Initialize
(
)
;
manager
-
>
SetupDigitalGainControl
(
mock_gain_control
)
;
}
TEST
(
AgcManagerDirectTest
AgcMinMicLevelExperimentDefault
)
{
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
min_mic_level
(
)
kMinMicLevel
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
startup_min_level
(
)
kInitialInputVolume
)
;
}
TEST
(
AgcManagerDirectTest
AgcMinMicLevelExperimentDisabled
)
{
for
(
const
std
:
:
string
&
field_trial_suffix
:
{
"
"
"
_20220210
"
}
)
{
test
:
:
ScopedFieldTrials
field_trial
(
GetAgcMinMicLevelExperimentFieldTrial
(
"
Disabled
"
+
field_trial_suffix
)
)
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
min_mic_level
(
)
kMinMicLevel
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
startup_min_level
(
)
kInitialInputVolume
)
;
}
}
TEST
(
AgcManagerDirectTest
AgcMinMicLevelExperimentOutOfRangeAbove
)
{
test
:
:
ScopedFieldTrials
field_trial
(
GetAgcMinMicLevelExperimentFieldTrial
(
"
Enabled
-
256
"
)
)
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
min_mic_level
(
)
kMinMicLevel
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
startup_min_level
(
)
kInitialInputVolume
)
;
}
TEST
(
AgcManagerDirectTest
AgcMinMicLevelExperimentOutOfRangeBelow
)
{
test
:
:
ScopedFieldTrials
field_trial
(
GetAgcMinMicLevelExperimentFieldTrial
(
"
Enabled
-
-
1
"
)
)
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
min_mic_level
(
)
kMinMicLevel
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
startup_min_level
(
)
kInitialInputVolume
)
;
}
TEST
(
AgcManagerDirectTest
AgcMinMicLevelExperimentEnabled50
)
{
constexpr
int
kMinMicLevelOverride
=
50
;
for
(
const
std
:
:
string
&
field_trial_suffix
:
{
"
"
"
_20220210
"
}
)
{
SCOPED_TRACE
(
field_trial_suffix
)
;
test
:
:
ScopedFieldTrials
field_trial
(
GetAgcMinMicLevelExperimentFieldTrialEnabled
(
kMinMicLevelOverride
field_trial_suffix
)
)
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
min_mic_level
(
)
kMinMicLevelOverride
)
;
EXPECT_EQ
(
manager
-
>
channel_agcs_
[
0
]
-
>
startup_min_level
(
)
kInitialInputVolume
)
;
}
}
TEST
(
AgcManagerDirectTest
AgcMinMicLevelExperimentCheckMinLevelWithClipping
)
{
constexpr
int
kMinMicLevelOverride
=
250
;
const
auto
factory
=
[
]
(
)
{
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
)
;
manager
-
>
Initialize
(
)
;
manager
-
>
set_stream_analog_level
(
kInitialInputVolume
)
;
return
manager
;
}
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
factory
(
)
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager_with_override
;
{
test
:
:
ScopedFieldTrials
field_trial
(
GetAgcMinMicLevelExperimentFieldTrialEnabled
(
kMinMicLevelOverride
)
)
;
manager_with_override
=
factory
(
)
;
}
AudioBuffer
audio_buffer
(
kSampleRateHz
1
kSampleRateHz
1
kSampleRateHz
1
)
;
WriteAudioBufferSamples
(
4000
.
0f
0
.
8f
audio_buffer
)
;
CallPreProcessAndProcess
(
400
audio_buffer
*
manager
)
;
CallPreProcessAndProcess
(
400
audio_buffer
*
manager_with_override
)
;
ASSERT_GT
(
manager
-
>
recommended_analog_level
(
)
0
)
;
EXPECT_GT
(
manager_with_override
-
>
recommended_analog_level
(
)
manager
-
>
recommended_analog_level
(
)
)
;
EXPECT_EQ
(
manager_with_override
-
>
recommended_analog_level
(
)
kMinMicLevelOverride
)
;
}
TEST
(
AgcManagerDirectTest
AgcMinMicLevelExperimentCompareMicLevelWithClipping
)
{
const
auto
factory
=
[
]
(
)
{
AnalogAgcConfig
config
=
kDefaultAnalogConfig
;
config
.
startup_min_volume
=
kInitialInputVolume
;
config
.
enable_digital_adaptive
=
false
;
config
.
clipped_level_step
=
64
;
config
.
clipped_ratio_threshold
=
kClippedRatioThreshold
;
config
.
clipped_wait_frames
=
kClippedWaitFrames
;
auto
controller
=
std
:
:
make_unique
<
AgcManagerDirect
>
(
1
config
)
;
controller
-
>
Initialize
(
)
;
controller
-
>
set_stream_analog_level
(
kInitialInputVolume
)
;
return
controller
;
}
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
factory
(
)
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager_with_override
;
{
constexpr
int
kMinMicLevelOverride
=
20
;
static_assert
(
kDefaultAnalogConfig
.
clipped_level_min
>
=
kMinMicLevelOverride
"
Use
a
lower
override
value
.
"
)
;
test
:
:
ScopedFieldTrials
field_trial
(
GetAgcMinMicLevelExperimentFieldTrialEnabled
(
kMinMicLevelOverride
)
)
;
manager_with_override
=
factory
(
)
;
}
AudioBuffer
audio_buffer
(
kSampleRateHz
1
kSampleRateHz
1
kSampleRateHz
1
)
;
WriteAudioBufferSamples
(
4000
.
0f
0
.
8f
audio_buffer
)
;
CallPreProcessAndProcess
(
400
audio_buffer
*
manager
)
;
CallPreProcessAndProcess
(
400
audio_buffer
*
manager_with_override
)
;
ASSERT_GT
(
manager
-
>
recommended_analog_level
(
)
0
)
;
EXPECT_EQ
(
manager
-
>
recommended_analog_level
(
)
manager_with_override
-
>
recommended_analog_level
(
)
)
;
EXPECT_EQ
(
manager_with_override
-
>
recommended_analog_level
(
)
kDefaultAnalogConfig
.
clipped_level_min
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingParametersVerified
)
{
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
)
;
manager
-
>
Initialize
(
)
;
EXPECT_EQ
(
manager
-
>
clipped_level_step_
kClippedLevelStep
)
;
EXPECT_EQ
(
manager
-
>
clipped_ratio_threshold_
kClippedRatioThreshold
)
;
EXPECT_EQ
(
manager
-
>
clipped_wait_frames_
kClippedWaitFrames
)
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager_custom
=
CreateAgcManagerDirect
(
kInitialInputVolume
10
0
.
2f
50
)
;
manager_custom
-
>
Initialize
(
)
;
EXPECT_EQ
(
manager_custom
-
>
clipped_level_step_
10
)
;
EXPECT_EQ
(
manager_custom
-
>
clipped_ratio_threshold_
0
.
2f
)
;
EXPECT_EQ
(
manager_custom
-
>
clipped_wait_frames_
50
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
DisableClippingPredictorDisablesClippingPredictor
)
{
ClippingPredictorConfig
config
;
config
.
enabled
=
false
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
config
)
;
manager
-
>
Initialize
(
)
;
EXPECT_FALSE
(
manager
-
>
clipping_predictor_enabled
(
)
)
;
EXPECT_FALSE
(
manager
-
>
use_clipping_predictor_step
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
ClippingPredictorDisabledByDefault
)
{
constexpr
ClippingPredictorConfig
kDefaultConfig
;
EXPECT_FALSE
(
kDefaultConfig
.
enabled
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
EnableClippingPredictorEnablesClippingPredictor
)
{
ClippingPredictorConfig
config
;
config
.
enabled
=
true
;
config
.
use_predicted_step
=
true
;
std
:
:
unique_ptr
<
AgcManagerDirect
>
manager
=
CreateAgcManagerDirect
(
kInitialInputVolume
kClippedLevelStep
kClippedRatioThreshold
kClippedWaitFrames
config
)
;
manager
-
>
Initialize
(
)
;
EXPECT_TRUE
(
manager
-
>
clipping_predictor_enabled
(
)
)
;
EXPECT_TRUE
(
manager
-
>
use_clipping_predictor_step
(
)
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
DisableClippingPredictorDoesNotLowerVolume
)
{
AudioBuffer
audio_buffer
(
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
)
;
AnalogAgcConfig
config
=
GetAnalogAgcTestConfig
(
)
;
config
.
clipping_predictor
.
enabled
=
false
;
AgcManagerDirect
manager
(
config
new
:
:
testing
:
:
NiceMock
<
MockAgc
>
(
)
)
;
manager
.
Initialize
(
)
;
manager
.
set_stream_analog_level
(
255
)
;
EXPECT_FALSE
(
manager
.
clipping_predictor_enabled
(
)
)
;
EXPECT_FALSE
(
manager
.
use_clipping_predictor_step
(
)
)
;
EXPECT_EQ
(
manager
.
recommended_analog_level
(
)
255
)
;
manager
.
Process
(
audio_buffer
)
;
CallPreProcessAudioBuffer
(
10
0
.
99f
manager
)
;
EXPECT_EQ
(
manager
.
recommended_analog_level
(
)
255
)
;
CallPreProcessAudioBuffer
(
300
0
.
99f
manager
)
;
EXPECT_EQ
(
manager
.
recommended_analog_level
(
)
255
)
;
CallPreProcessAudioBuffer
(
10
0
.
99f
manager
)
;
EXPECT_EQ
(
manager
.
recommended_analog_level
(
)
255
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
UsedClippingPredictionsProduceLowerAnalogLevels
)
{
AudioBuffer
audio_buffer
(
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
)
;
AnalogAgcConfig
config_with_prediction
=
GetAnalogAgcTestConfig
(
)
;
config_with_prediction
.
clipping_predictor
.
enabled
=
true
;
config_with_prediction
.
clipping_predictor
.
use_predicted_step
=
true
;
AnalogAgcConfig
config_without_prediction
=
GetAnalogAgcTestConfig
(
)
;
config_without_prediction
.
clipping_predictor
.
enabled
=
false
;
AgcManagerDirect
manager_with_prediction
(
config_with_prediction
new
:
:
testing
:
:
NiceMock
<
MockAgc
>
(
)
)
;
AgcManagerDirect
manager_without_prediction
(
config_without_prediction
new
:
:
testing
:
:
NiceMock
<
MockAgc
>
(
)
)
;
manager_with_prediction
.
Initialize
(
)
;
manager_without_prediction
.
Initialize
(
)
;
constexpr
int
kInitialLevel
=
255
;
constexpr
float
kClippingPeakRatio
=
1
.
0f
;
constexpr
float
kCloseToClippingPeakRatio
=
0
.
99f
;
constexpr
float
kZeroPeakRatio
=
0
.
0f
;
manager_with_prediction
.
set_stream_analog_level
(
kInitialLevel
)
;
manager_without_prediction
.
set_stream_analog_level
(
kInitialLevel
)
;
manager_with_prediction
.
Process
(
audio_buffer
)
;
manager_without_prediction
.
Process
(
audio_buffer
)
;
EXPECT_TRUE
(
manager_with_prediction
.
clipping_predictor_enabled
(
)
)
;
EXPECT_FALSE
(
manager_without_prediction
.
clipping_predictor_enabled
(
)
)
;
EXPECT_TRUE
(
manager_with_prediction
.
use_clipping_predictor_step
(
)
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
kClippedLevelStep
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kCloseToClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kCloseToClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
kClippedLevelStep
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
2
*
kClippedLevelStep
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
CallPreProcessAudioBuffer
(
2
*
kClippedWaitFrames
kZeroPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
2
*
kClippedWaitFrames
kZeroPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
2
*
kClippedLevelStep
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
3
*
kClippedLevelStep
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
kClippedLevelStep
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
3
*
kClippedLevelStep
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
kClippedLevelStep
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
4
*
kClippedLevelStep
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
-
2
*
kClippedLevelStep
)
;
}
TEST_P
(
AgcManagerDirectParametrizedTest
UnusedClippingPredictionsProduceEqualAnalogLevels
)
{
AudioBuffer
audio_buffer
(
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
kSampleRateHz
kNumChannels
)
;
AnalogAgcConfig
config_with_prediction
=
GetAnalogAgcTestConfig
(
)
;
config_with_prediction
.
clipping_predictor
.
enabled
=
true
;
config_with_prediction
.
clipping_predictor
.
use_predicted_step
=
false
;
AnalogAgcConfig
config_without_prediction
=
GetAnalogAgcTestConfig
(
)
;
config_without_prediction
.
clipping_predictor
.
enabled
=
false
;
AgcManagerDirect
manager_with_prediction
(
config_with_prediction
new
:
:
testing
:
:
NiceMock
<
MockAgc
>
(
)
)
;
AgcManagerDirect
manager_without_prediction
(
config_without_prediction
new
:
:
testing
:
:
NiceMock
<
MockAgc
>
(
)
)
;
constexpr
int
kInitialLevel
=
255
;
constexpr
float
kClippingPeakRatio
=
1
.
0f
;
constexpr
float
kCloseToClippingPeakRatio
=
0
.
99f
;
constexpr
float
kZeroPeakRatio
=
0
.
0f
;
manager_with_prediction
.
Initialize
(
)
;
manager_without_prediction
.
Initialize
(
)
;
manager_with_prediction
.
set_stream_analog_level
(
kInitialLevel
)
;
manager_without_prediction
.
set_stream_analog_level
(
kInitialLevel
)
;
manager_with_prediction
.
Process
(
audio_buffer
)
;
manager_without_prediction
.
Process
(
audio_buffer
)
;
EXPECT_TRUE
(
manager_with_prediction
.
clipping_predictor_enabled
(
)
)
;
EXPECT_FALSE
(
manager_without_prediction
.
clipping_predictor_enabled
(
)
)
;
EXPECT_FALSE
(
manager_with_prediction
.
use_clipping_predictor_step
(
)
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
EXPECT_EQ
(
manager_without_prediction
.
recommended_analog_level
(
)
kInitialLevel
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
manager_without_prediction
.
recommended_analog_level
(
)
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kCloseToClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kCloseToClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
manager_without_prediction
.
recommended_analog_level
(
)
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
10
kCloseToClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
manager_without_prediction
.
recommended_analog_level
(
)
)
;
CallPreProcessAudioBuffer
(
2
*
kClippedWaitFrames
kZeroPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
2
*
kClippedWaitFrames
kZeroPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
manager_without_prediction
.
recommended_analog_level
(
)
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
manager_without_prediction
.
recommended_analog_level
(
)
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
kClippedWaitFrames
kClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
manager_without_prediction
.
recommended_analog_level
(
)
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_with_prediction
)
;
CallPreProcessAudioBuffer
(
1
kClippingPeakRatio
manager_without_prediction
)
;
EXPECT_EQ
(
manager_with_prediction
.
recommended_analog_level
(
)
manager_without_prediction
.
recommended_analog_level
(
)
)
;
}
}
