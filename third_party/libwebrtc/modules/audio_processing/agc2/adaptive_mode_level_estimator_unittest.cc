#
include
"
modules
/
audio_processing
/
agc2
/
adaptive_mode_level_estimator
.
h
"
#
include
"
modules
/
audio_processing
/
agc2
/
agc2_common
.
h
"
#
include
"
modules
/
audio_processing
/
logging
/
apm_data_dumper
.
h
"
#
include
"
rtc_base
/
gunit
.
h
"
namespace
webrtc
{
namespace
{
void
RunOnConstantLevel
(
int
num_iterations
VadWithLevel
:
:
LevelAndProbability
vad_data
AdaptiveModeLevelEstimator
*
level_estimator
)
{
for
(
int
i
=
0
;
i
<
num_iterations
;
+
+
i
)
{
level_estimator
-
>
UpdateEstimation
(
vad_data
)
;
}
}
}
TEST
(
AutomaticGainController2AdaptiveModeLevelEstimator
EstimatorShouldNotCrash
)
{
ApmDataDumper
apm_data_dumper
(
0
)
;
AdaptiveModeLevelEstimator
level_estimator
(
&
apm_data_dumper
)
;
VadWithLevel
:
:
LevelAndProbability
vad_data
(
1
.
f
-
20
.
f
-
10
.
f
)
;
level_estimator
.
UpdateEstimation
(
vad_data
)
;
static_cast
<
void
>
(
level_estimator
.
LatestLevelEstimate
(
)
)
;
}
TEST
(
AutomaticGainController2AdaptiveModeLevelEstimator
LevelShouldStabilize
)
{
ApmDataDumper
apm_data_dumper
(
0
)
;
AdaptiveModeLevelEstimator
level_estimator
(
&
apm_data_dumper
)
;
constexpr
float
kSpeechPeakDbfs
=
-
15
.
f
;
RunOnConstantLevel
(
100
VadWithLevel
:
:
LevelAndProbability
(
1
.
f
kSpeechPeakDbfs
-
GetInitialSaturationMarginDb
(
)
kSpeechPeakDbfs
)
&
level_estimator
)
;
EXPECT_NEAR
(
level_estimator
.
LatestLevelEstimate
(
)
-
GetExtraSaturationMarginOffsetDb
(
)
kSpeechPeakDbfs
0
.
1f
)
;
}
TEST
(
AutomaticGainController2AdaptiveModeLevelEstimator
EstimatorIgnoresZeroProbabilityFrames
)
{
ApmDataDumper
apm_data_dumper
(
0
)
;
AdaptiveModeLevelEstimator
level_estimator
(
&
apm_data_dumper
)
;
constexpr
float
kSpeechRmsDbfs
=
-
25
.
f
;
RunOnConstantLevel
(
100
VadWithLevel
:
:
LevelAndProbability
(
1
.
f
kSpeechRmsDbfs
-
GetInitialSaturationMarginDb
(
)
kSpeechRmsDbfs
)
&
level_estimator
)
;
constexpr
float
kNoiseRmsDbfs
=
0
.
f
;
RunOnConstantLevel
(
100
VadWithLevel
:
:
LevelAndProbability
(
0
.
f
kNoiseRmsDbfs
kNoiseRmsDbfs
)
&
level_estimator
)
;
EXPECT_NEAR
(
level_estimator
.
LatestLevelEstimate
(
)
-
GetExtraSaturationMarginOffsetDb
(
)
kSpeechRmsDbfs
0
.
1f
)
;
}
TEST
(
AutomaticGainController2AdaptiveModeLevelEstimator
TimeToAdapt
)
{
ApmDataDumper
apm_data_dumper
(
0
)
;
AdaptiveModeLevelEstimator
level_estimator
(
&
apm_data_dumper
)
;
constexpr
float
kInitialSpeechRmsDbfs
=
-
30
.
f
;
RunOnConstantLevel
(
kFullBufferSizeMs
/
kFrameDurationMs
VadWithLevel
:
:
LevelAndProbability
(
1
.
f
kInitialSpeechRmsDbfs
-
GetInitialSaturationMarginDb
(
)
kInitialSpeechRmsDbfs
)
&
level_estimator
)
;
constexpr
float
kDifferentSpeechRmsDbfs
=
-
10
.
f
;
const
float
kMaxDifferenceDb
=
0
.
25
*
std
:
:
abs
(
kDifferentSpeechRmsDbfs
-
kInitialSpeechRmsDbfs
)
;
RunOnConstantLevel
(
static_cast
<
int
>
(
kFullBufferSizeMs
/
kFrameDurationMs
/
2
)
VadWithLevel
:
:
LevelAndProbability
(
1
.
f
kDifferentSpeechRmsDbfs
-
GetInitialSaturationMarginDb
(
)
kDifferentSpeechRmsDbfs
)
&
level_estimator
)
;
EXPECT_GT
(
std
:
:
abs
(
kDifferentSpeechRmsDbfs
-
level_estimator
.
LatestLevelEstimate
(
)
)
kMaxDifferenceDb
)
;
RunOnConstantLevel
(
static_cast
<
int
>
(
3
*
kFullBufferSizeMs
/
kFrameDurationMs
)
VadWithLevel
:
:
LevelAndProbability
(
1
.
f
kDifferentSpeechRmsDbfs
-
GetInitialSaturationMarginDb
(
)
kDifferentSpeechRmsDbfs
)
&
level_estimator
)
;
EXPECT_NEAR
(
level_estimator
.
LatestLevelEstimate
(
)
-
GetExtraSaturationMarginOffsetDb
(
)
kDifferentSpeechRmsDbfs
kMaxDifferenceDb
*
0
.
5f
)
;
}
TEST
(
AutomaticGainController2AdaptiveModeLevelEstimator
ResetGivesFastAdaptation
)
{
ApmDataDumper
apm_data_dumper
(
0
)
;
AdaptiveModeLevelEstimator
level_estimator
(
&
apm_data_dumper
)
;
constexpr
float
kInitialSpeechRmsDbfs
=
-
30
.
f
;
RunOnConstantLevel
(
kFullBufferSizeMs
/
kFrameDurationMs
VadWithLevel
:
:
LevelAndProbability
(
1
.
f
kInitialSpeechRmsDbfs
-
GetInitialSaturationMarginDb
(
)
kInitialSpeechRmsDbfs
)
&
level_estimator
)
;
constexpr
float
kDifferentSpeechRmsDbfs
=
-
10
.
f
;
level_estimator
.
Reset
(
)
;
RunOnConstantLevel
(
kFullBufferSizeMs
/
kFrameDurationMs
/
2
VadWithLevel
:
:
LevelAndProbability
(
1
.
f
kDifferentSpeechRmsDbfs
-
GetInitialSaturationMarginDb
(
)
kDifferentSpeechRmsDbfs
)
&
level_estimator
)
;
const
float
kMaxDifferenceDb
=
0
.
1f
*
std
:
:
abs
(
kDifferentSpeechRmsDbfs
-
kInitialSpeechRmsDbfs
)
;
EXPECT_LT
(
std
:
:
abs
(
kDifferentSpeechRmsDbfs
-
(
level_estimator
.
LatestLevelEstimate
(
)
-
GetExtraSaturationMarginOffsetDb
(
)
)
)
kMaxDifferenceDb
)
;
}
}
