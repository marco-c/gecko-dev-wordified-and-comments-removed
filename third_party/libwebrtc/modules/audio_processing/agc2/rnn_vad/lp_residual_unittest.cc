#
include
"
modules
/
audio_processing
/
agc2
/
rnn_vad
/
lp_residual
.
h
"
#
include
<
algorithm
>
#
include
<
array
>
#
include
<
vector
>
#
include
"
modules
/
audio_processing
/
agc2
/
rnn_vad
/
common
.
h
"
#
include
"
modules
/
audio_processing
/
agc2
/
rnn_vad
/
test_utils
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
rnn_vad
{
namespace
{
TEST
(
RnnVadTest
LpResidualOfEmptyFrame
)
{
std
:
:
array
<
float
kFrameSize10ms24kHz
>
empty_frame
;
empty_frame
.
fill
(
0
.
f
)
;
std
:
:
array
<
float
kNumLpcCoefficients
>
lpc
;
ComputeAndPostProcessLpcCoefficients
(
empty_frame
lpc
)
;
std
:
:
array
<
float
kFrameSize10ms24kHz
>
lp_residual
;
ComputeLpResidual
(
lpc
empty_frame
lp_residual
)
;
}
TEST
(
RnnVadTest
LpResidualPipelineBitExactness
)
{
ChunksFileReader
pitch_buffer_reader
=
CreatePitchBuffer24kHzReader
(
)
;
ChunksFileReader
lp_pitch_reader
=
CreateLpResidualAndPitchInfoReader
(
)
;
std
:
:
vector
<
float
>
pitch_buffer_24kHz
(
kBufSize24kHz
)
;
std
:
:
array
<
float
kNumLpcCoefficients
>
lpc
;
std
:
:
vector
<
float
>
computed_lp_residual
(
kBufSize24kHz
)
;
std
:
:
vector
<
float
>
expected_lp_residual
(
kBufSize24kHz
)
;
const
int
num_frames
=
std
:
:
min
(
pitch_buffer_reader
.
num_chunks
300
)
;
ASSERT_GE
(
lp_pitch_reader
.
num_chunks
num_frames
)
;
for
(
int
i
=
0
;
i
<
num_frames
;
+
+
i
)
{
SCOPED_TRACE
(
i
)
;
ASSERT_TRUE
(
pitch_buffer_reader
.
reader
-
>
ReadChunk
(
pitch_buffer_24kHz
)
)
;
ASSERT_TRUE
(
lp_pitch_reader
.
reader
-
>
ReadChunk
(
expected_lp_residual
)
)
;
lp_pitch_reader
.
reader
-
>
SeekForward
(
2
)
;
if
(
i
%
20
=
=
0
)
{
ComputeAndPostProcessLpcCoefficients
(
pitch_buffer_24kHz
lpc
)
;
ComputeLpResidual
(
lpc
pitch_buffer_24kHz
computed_lp_residual
)
;
ExpectNearAbsolute
(
expected_lp_residual
computed_lp_residual
kFloatMin
)
;
}
}
}
}
}
}
