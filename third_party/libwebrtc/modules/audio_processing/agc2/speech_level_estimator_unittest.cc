#
include
"
modules
/
audio_processing
/
agc2
/
speech_level_estimator
.
h
"
#
include
<
memory
>
#
include
"
modules
/
audio_processing
/
agc2
/
agc2_common
.
h
"
#
include
"
modules
/
audio_processing
/
include
/
audio_processing
.
h
"
#
include
"
modules
/
audio_processing
/
logging
/
apm_data_dumper
.
h
"
#
include
"
rtc_base
/
gunit
.
h
"
namespace
webrtc
{
namespace
{
using
AdaptiveDigitalConfig
=
AudioProcessing
:
:
Config
:
:
GainController2
:
:
AdaptiveDigital
;
constexpr
int
kNumFramesToConfidence
=
kLevelEstimatorTimeToConfidenceMs
/
kFrameDurationMs
;
static_assert
(
kNumFramesToConfidence
>
0
"
"
)
;
constexpr
float
kConvergenceSpeedTestsLevelTolerance
=
0
.
5f
;
void
RunOnConstantLevel
(
int
num_iterations
float
rms_dbfs
float
peak_dbfs
float
speech_probability
SpeechLevelEstimator
&
level_estimator
)
{
for
(
int
i
=
0
;
i
<
num_iterations
;
+
+
i
)
{
level_estimator
.
Update
(
rms_dbfs
peak_dbfs
speech_probability
)
;
}
}
constexpr
AdaptiveDigitalConfig
GetAdaptiveDigitalConfig
(
int
adjacent_speech_frames_threshold
)
{
AdaptiveDigitalConfig
config
;
config
.
adjacent_speech_frames_threshold
=
adjacent_speech_frames_threshold
;
return
config
;
}
constexpr
float
kNoSpeechProbability
=
0
.
0f
;
constexpr
float
kLowSpeechProbability
=
kVadConfidenceThreshold
/
2
.
0f
;
constexpr
float
kMaxSpeechProbability
=
1
.
0f
;
struct
TestLevelEstimator
{
explicit
TestLevelEstimator
(
int
adjacent_speech_frames_threshold
)
:
data_dumper
(
0
)
estimator
(
std
:
:
make_unique
<
SpeechLevelEstimator
>
(
&
data_dumper
GetAdaptiveDigitalConfig
(
adjacent_speech_frames_threshold
)
)
)
initial_speech_level_dbfs
(
estimator
-
>
level_dbfs
(
)
)
level_rms_dbfs
(
initial_speech_level_dbfs
/
2
.
0f
)
level_peak_dbfs
(
initial_speech_level_dbfs
/
3
.
0f
)
{
RTC_DCHECK_LT
(
level_rms_dbfs
level_peak_dbfs
)
;
RTC_DCHECK_LT
(
initial_speech_level_dbfs
level_rms_dbfs
)
;
RTC_DCHECK_GT
(
level_rms_dbfs
-
initial_speech_level_dbfs
5
.
0f
)
<
<
"
Adjust
level_rms_dbfs
so
that
the
difference
from
the
initial
"
"
level
is
wide
enough
for
the
tests
"
;
}
ApmDataDumper
data_dumper
;
std
:
:
unique_ptr
<
SpeechLevelEstimator
>
estimator
;
const
float
initial_speech_level_dbfs
;
const
float
level_rms_dbfs
;
const
float
level_peak_dbfs
;
}
;
TEST
(
GainController2SpeechLevelEstimator
LevelStabilizes
)
{
TestLevelEstimator
level_estimator
(
1
)
;
RunOnConstantLevel
(
kNumFramesToConfidence
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
const
float
estimated_level_dbfs
=
level_estimator
.
estimator
-
>
level_dbfs
(
)
;
RunOnConstantLevel
(
1
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
EXPECT_NEAR
(
level_estimator
.
estimator
-
>
level_dbfs
(
)
estimated_level_dbfs
0
.
1f
)
;
}
TEST
(
GainController2SpeechLevelEstimator
IsNotConfident
)
{
TestLevelEstimator
level_estimator
(
1
)
;
RunOnConstantLevel
(
kNumFramesToConfidence
/
2
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
EXPECT_FALSE
(
level_estimator
.
estimator
-
>
IsConfident
(
)
)
;
}
TEST
(
GainController2SpeechLevelEstimator
IsConfident
)
{
TestLevelEstimator
level_estimator
(
1
)
;
RunOnConstantLevel
(
kNumFramesToConfidence
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
EXPECT_TRUE
(
level_estimator
.
estimator
-
>
IsConfident
(
)
)
;
}
TEST
(
GainController2SpeechLevelEstimator
EstimatorIgnoresNonSpeechFrames
)
{
TestLevelEstimator
level_estimator
(
1
)
;
RunOnConstantLevel
(
kNumFramesToConfidence
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
const
float
estimated_level_dbfs
=
level_estimator
.
estimator
-
>
level_dbfs
(
)
;
RunOnConstantLevel
(
kNumFramesToConfidence
0
.
0f
0
.
0f
kNoSpeechProbability
*
level_estimator
.
estimator
)
;
EXPECT_FLOAT_EQ
(
level_estimator
.
estimator
-
>
level_dbfs
(
)
estimated_level_dbfs
)
;
}
TEST
(
GainController2SpeechLevelEstimator
ConvergenceSpeedBeforeConfidence
)
{
TestLevelEstimator
level_estimator
(
1
)
;
RunOnConstantLevel
(
kNumFramesToConfidence
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
EXPECT_NEAR
(
level_estimator
.
estimator
-
>
level_dbfs
(
)
level_estimator
.
level_rms_dbfs
kConvergenceSpeedTestsLevelTolerance
)
;
}
TEST
(
GainController2SpeechLevelEstimator
ConvergenceSpeedAfterConfidence
)
{
TestLevelEstimator
level_estimator
(
1
)
;
RunOnConstantLevel
(
kNumFramesToConfidence
level_estimator
.
initial_speech_level_dbfs
level_estimator
.
initial_speech_level_dbfs
+
6
.
0f
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
ASSERT_FLOAT_EQ
(
level_estimator
.
estimator
-
>
level_dbfs
(
)
level_estimator
.
initial_speech_level_dbfs
)
;
ASSERT_TRUE
(
level_estimator
.
estimator
-
>
IsConfident
(
)
)
;
constexpr
float
kConvergenceTimeAfterConfidenceNumFrames
=
600
;
static_assert
(
kConvergenceTimeAfterConfidenceNumFrames
>
kNumFramesToConfidence
"
"
)
;
RunOnConstantLevel
(
kConvergenceTimeAfterConfidenceNumFrames
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
*
level_estimator
.
estimator
)
;
EXPECT_NEAR
(
level_estimator
.
estimator
-
>
level_dbfs
(
)
level_estimator
.
level_rms_dbfs
kConvergenceSpeedTestsLevelTolerance
)
;
}
class
SpeechLevelEstimatorParametrization
:
public
:
:
testing
:
:
TestWithParam
<
int
>
{
protected
:
int
adjacent_speech_frames_threshold
(
)
const
{
return
GetParam
(
)
;
}
}
;
TEST_P
(
SpeechLevelEstimatorParametrization
DoNotAdaptToShortSpeechSegments
)
{
TestLevelEstimator
level_estimator
(
adjacent_speech_frames_threshold
(
)
)
;
const
float
initial_level
=
level_estimator
.
estimator
-
>
level_dbfs
(
)
;
ASSERT_LT
(
initial_level
level_estimator
.
level_peak_dbfs
)
;
for
(
int
i
=
0
;
i
<
adjacent_speech_frames_threshold
(
)
-
1
;
+
+
i
)
{
SCOPED_TRACE
(
i
)
;
level_estimator
.
estimator
-
>
Update
(
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
)
;
EXPECT_EQ
(
initial_level
level_estimator
.
estimator
-
>
level_dbfs
(
)
)
;
}
level_estimator
.
estimator
-
>
Update
(
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kLowSpeechProbability
)
;
EXPECT_EQ
(
initial_level
level_estimator
.
estimator
-
>
level_dbfs
(
)
)
;
}
TEST_P
(
SpeechLevelEstimatorParametrization
AdaptToEnoughSpeechSegments
)
{
TestLevelEstimator
level_estimator
(
adjacent_speech_frames_threshold
(
)
)
;
const
float
initial_level
=
level_estimator
.
estimator
-
>
level_dbfs
(
)
;
ASSERT_LT
(
initial_level
level_estimator
.
level_peak_dbfs
)
;
for
(
int
i
=
0
;
i
<
adjacent_speech_frames_threshold
(
)
;
+
+
i
)
{
level_estimator
.
estimator
-
>
Update
(
level_estimator
.
level_rms_dbfs
level_estimator
.
level_peak_dbfs
kMaxSpeechProbability
)
;
}
EXPECT_LT
(
initial_level
level_estimator
.
estimator
-
>
level_dbfs
(
)
)
;
}
INSTANTIATE_TEST_SUITE_P
(
GainController2
SpeechLevelEstimatorParametrization
:
:
testing
:
:
Values
(
1
9
17
)
)
;
}
}
