#
ifndef
MODULES_AUDIO_PROCESSING_AGC2_SATURATION_PROTECTOR_H_
#
define
MODULES_AUDIO_PROCESSING_AGC2_SATURATION_PROTECTOR_H_
#
include
<
array
>
#
include
"
absl
/
types
/
optional
.
h
"
#
include
"
modules
/
audio_processing
/
agc2
/
agc2_common
.
h
"
namespace
webrtc
{
class
ApmDataDumper
;
class
SaturationProtector
{
public
:
explicit
SaturationProtector
(
ApmDataDumper
*
apm_data_dumper
)
;
SaturationProtector
(
ApmDataDumper
*
apm_data_dumper
float
initial_saturation_margin_db
float
extra_saturation_margin_db
)
;
void
Reset
(
)
;
void
UpdateMargin
(
float
speech_peak_dbfs
float
speech_level_dbfs
)
;
float
GetMarginDb
(
)
const
;
void
DebugDumpEstimate
(
)
const
;
private
:
class
RingBuffer
{
public
:
void
Reset
(
)
;
void
PushBack
(
float
v
)
;
absl
:
:
optional
<
float
>
Front
(
)
const
;
private
:
std
:
:
array
<
float
kPeakEnveloperBufferSize
>
buffer_
;
int
next_
=
0
;
int
size_
=
0
;
}
;
float
GetDelayedPeakDbfs
(
)
const
;
ApmDataDumper
*
apm_data_dumper_
;
const
float
initial_saturation_margin_db_
;
const
float
extra_saturation_margin_db_
;
float
margin_db_
;
RingBuffer
peak_delay_buffer_
;
float
max_peaks_dbfs_
;
int
time_since_push_ms_
;
}
;
}
#
endif
