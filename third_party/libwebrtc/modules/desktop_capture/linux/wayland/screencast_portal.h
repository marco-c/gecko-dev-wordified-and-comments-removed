#
ifndef
MODULES_DESKTOP_CAPTURE_LINUX_WAYLAND_SCREENCAST_PORTAL_H_
#
define
MODULES_DESKTOP_CAPTURE_LINUX_WAYLAND_SCREENCAST_PORTAL_H_
#
include
<
gio
/
gio
.
h
>
#
include
<
string
>
#
include
"
absl
/
types
/
optional
.
h
"
namespace
webrtc
{
class
ScreenCastPortal
{
public
:
enum
class
CaptureSourceType
:
uint32_t
{
kScreen
=
0b01
kWindow
=
0b10
kAnyScreenContent
=
kScreen
|
kWindow
}
;
enum
class
CursorMode
:
uint32_t
{
kHidden
=
0b01
kEmbedded
=
0b10
kMetadata
=
0b100
}
;
enum
class
RequestResponse
{
kSuccess
kUserCancelled
kError
kMaxValue
=
kError
}
;
class
PortalNotifier
{
public
:
virtual
void
OnScreenCastRequestResult
(
RequestResponse
result
uint32_t
stream_node_id
int
fd
)
=
0
;
virtual
void
OnScreenCastSessionClosed
(
)
=
0
;
protected
:
PortalNotifier
(
)
=
default
;
virtual
~
PortalNotifier
(
)
=
default
;
}
;
explicit
ScreenCastPortal
(
CaptureSourceType
source_type
PortalNotifier
*
notifier
)
;
~
ScreenCastPortal
(
)
;
void
Start
(
)
;
private
:
PortalNotifier
*
notifier_
;
uint32_t
pw_stream_node_id_
=
0
;
int
pw_fd_
=
-
1
;
CaptureSourceType
capture_source_type_
=
ScreenCastPortal
:
:
CaptureSourceType
:
:
kScreen
;
CursorMode
cursor_mode_
=
ScreenCastPortal
:
:
CursorMode
:
:
kEmbedded
;
GDBusConnection
*
connection_
=
nullptr
;
GDBusProxy
*
proxy_
=
nullptr
;
GCancellable
*
cancellable_
=
nullptr
;
std
:
:
string
portal_handle_
;
std
:
:
string
session_handle_
;
std
:
:
string
sources_handle_
;
std
:
:
string
start_handle_
;
guint
session_request_signal_id_
=
0
;
guint
sources_request_signal_id_
=
0
;
guint
start_request_signal_id_
=
0
;
guint
session_closed_signal_id_
=
0
;
void
PortalFailed
(
RequestResponse
result
)
;
uint32_t
SetupRequestResponseSignal
(
const
char
*
object_path
GDBusSignalCallback
callback
)
;
static
void
OnProxyRequested
(
GObject
*
object
GAsyncResult
*
result
gpointer
user_data
)
;
static
std
:
:
string
PrepareSignalHandle
(
GDBusConnection
*
connection
const
char
*
token
)
;
void
SessionRequest
(
)
;
static
void
OnSessionRequested
(
GDBusProxy
*
proxy
GAsyncResult
*
result
gpointer
user_data
)
;
static
void
OnSessionRequestResponseSignal
(
GDBusConnection
*
connection
const
char
*
sender_name
const
char
*
object_path
const
char
*
interface_name
const
char
*
signal_name
GVariant
*
parameters
gpointer
user_data
)
;
static
void
OnSessionClosedSignal
(
GDBusConnection
*
connection
const
char
*
sender_name
const
char
*
object_path
const
char
*
interface_name
const
char
*
signal_name
GVariant
*
parameters
gpointer
user_data
)
;
void
SourcesRequest
(
)
;
static
void
OnSourcesRequested
(
GDBusProxy
*
proxy
GAsyncResult
*
result
gpointer
user_data
)
;
static
void
OnSourcesRequestResponseSignal
(
GDBusConnection
*
connection
const
char
*
sender_name
const
char
*
object_path
const
char
*
interface_name
const
char
*
signal_name
GVariant
*
parameters
gpointer
user_data
)
;
void
StartRequest
(
)
;
static
void
OnStartRequested
(
GDBusProxy
*
proxy
GAsyncResult
*
result
gpointer
user_data
)
;
static
void
OnStartRequestResponseSignal
(
GDBusConnection
*
connection
const
char
*
sender_name
const
char
*
object_path
const
char
*
interface_name
const
char
*
signal_name
GVariant
*
parameters
gpointer
user_data
)
;
void
OpenPipeWireRemote
(
)
;
static
void
OnOpenPipeWireRemoteRequested
(
GDBusProxy
*
proxy
GAsyncResult
*
result
gpointer
user_data
)
;
}
;
}
#
endif
