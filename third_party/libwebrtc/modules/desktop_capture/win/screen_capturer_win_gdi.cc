#
include
"
modules
/
desktop_capture
/
win
/
screen_capturer_win_gdi
.
h
"
#
include
<
utility
>
#
include
"
modules
/
desktop_capture
/
desktop_capture_metrics_helper
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_capture_options
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_capture_types
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_frame
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_frame_win
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_region
.
h
"
#
include
"
modules
/
desktop_capture
/
mouse_cursor
.
h
"
#
include
"
modules
/
desktop_capture
/
win
/
cursor
.
h
"
#
include
"
modules
/
desktop_capture
/
win
/
desktop
.
h
"
#
include
"
modules
/
desktop_capture
/
win
/
screen_capture_utils
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
time_utils
.
h
"
#
include
"
rtc_base
/
trace_event
.
h
"
#
include
"
system_wrappers
/
include
/
metrics
.
h
"
namespace
webrtc
{
namespace
{
const
UINT
DWM_EC_DISABLECOMPOSITION
=
0
;
const
UINT
DWM_EC_ENABLECOMPOSITION
=
1
;
const
wchar_t
kDwmapiLibraryName
[
]
=
L
"
dwmapi
.
dll
"
;
}
ScreenCapturerWinGdi
:
:
ScreenCapturerWinGdi
(
const
DesktopCaptureOptions
&
options
)
{
if
(
options
.
disable_effects
(
)
)
{
if
(
!
dwmapi_library_
)
dwmapi_library_
=
LoadLibraryW
(
kDwmapiLibraryName
)
;
if
(
dwmapi_library_
)
{
composition_func_
=
reinterpret_cast
<
DwmEnableCompositionFunc
>
(
GetProcAddress
(
dwmapi_library_
"
DwmEnableComposition
"
)
)
;
}
}
}
ScreenCapturerWinGdi
:
:
~
ScreenCapturerWinGdi
(
)
{
if
(
desktop_dc_
)
ReleaseDC
(
NULL
desktop_dc_
)
;
if
(
memory_dc_
)
DeleteDC
(
memory_dc_
)
;
if
(
composition_func_
)
(
*
composition_func_
)
(
DWM_EC_ENABLECOMPOSITION
)
;
if
(
dwmapi_library_
)
FreeLibrary
(
dwmapi_library_
)
;
}
void
ScreenCapturerWinGdi
:
:
SetSharedMemoryFactory
(
std
:
:
unique_ptr
<
SharedMemoryFactory
>
shared_memory_factory
)
{
shared_memory_factory_
=
std
:
:
move
(
shared_memory_factory
)
;
}
void
ScreenCapturerWinGdi
:
:
CaptureFrame
(
)
{
TRACE_EVENT0
(
"
webrtc
"
"
ScreenCapturerWinGdi
:
:
CaptureFrame
"
)
;
int64_t
capture_start_time_nanos
=
rtc
:
:
TimeNanos
(
)
;
queue_
.
MoveToNextFrame
(
)
;
if
(
queue_
.
current_frame
(
)
&
&
queue_
.
current_frame
(
)
-
>
IsShared
(
)
)
{
RTC_DLOG
(
LS_WARNING
)
<
<
"
Overwriting
frame
that
is
still
shared
.
"
;
}
PrepareCaptureResources
(
)
;
if
(
!
CaptureImage
(
)
)
{
RTC_LOG
(
LS_WARNING
)
<
<
"
Failed
to
capture
screen
by
GDI
.
"
;
callback_
-
>
OnCaptureResult
(
Result
:
:
ERROR_TEMPORARY
nullptr
)
;
return
;
}
std
:
:
unique_ptr
<
DesktopFrame
>
frame
=
queue_
.
current_frame
(
)
-
>
Share
(
)
;
frame
-
>
set_dpi
(
DesktopVector
(
GetDeviceCaps
(
desktop_dc_
LOGPIXELSX
)
GetDeviceCaps
(
desktop_dc_
LOGPIXELSY
)
)
)
;
frame
-
>
mutable_updated_region
(
)
-
>
SetRect
(
DesktopRect
:
:
MakeSize
(
frame
-
>
size
(
)
)
)
;
int
capture_time_ms
=
(
rtc
:
:
TimeNanos
(
)
-
capture_start_time_nanos
)
/
rtc
:
:
kNumNanosecsPerMillisec
;
RTC_HISTOGRAM_COUNTS_1000
(
"
WebRTC
.
DesktopCapture
.
Win
.
ScreenGdiCapturerFrameTime
"
capture_time_ms
)
;
frame
-
>
set_capture_time_ms
(
capture_time_ms
)
;
frame
-
>
set_capturer_id
(
DesktopCapturerId
:
:
kScreenCapturerWinGdi
)
;
callback_
-
>
OnCaptureResult
(
Result
:
:
SUCCESS
std
:
:
move
(
frame
)
)
;
}
bool
ScreenCapturerWinGdi
:
:
GetSourceList
(
SourceList
*
sources
)
{
return
webrtc
:
:
GetScreenList
(
sources
)
;
}
bool
ScreenCapturerWinGdi
:
:
SelectSource
(
SourceId
id
)
{
bool
valid
=
IsScreenValid
(
id
&
current_device_key_
)
;
if
(
valid
)
current_screen_id_
=
id
;
return
valid
;
}
void
ScreenCapturerWinGdi
:
:
Start
(
Callback
*
callback
)
{
RTC_DCHECK
(
!
callback_
)
;
RTC_DCHECK
(
callback
)
;
RecordCapturerImpl
(
DesktopCapturerId
:
:
kScreenCapturerWinGdi
)
;
callback_
=
callback
;
if
(
composition_func_
)
(
*
composition_func_
)
(
DWM_EC_DISABLECOMPOSITION
)
;
}
void
ScreenCapturerWinGdi
:
:
PrepareCaptureResources
(
)
{
std
:
:
unique_ptr
<
Desktop
>
input_desktop
(
Desktop
:
:
GetInputDesktop
(
)
)
;
if
(
input_desktop
&
&
!
desktop_
.
IsSame
(
*
input_desktop
)
)
{
if
(
desktop_dc_
)
{
ReleaseDC
(
NULL
desktop_dc_
)
;
desktop_dc_
=
nullptr
;
}
if
(
memory_dc_
)
{
DeleteDC
(
memory_dc_
)
;
memory_dc_
=
nullptr
;
}
desktop_
.
SetThreadDesktop
(
input_desktop
.
release
(
)
)
;
if
(
composition_func_
)
{
(
*
composition_func_
)
(
DWM_EC_DISABLECOMPOSITION
)
;
}
}
if
(
display_configuration_monitor_
.
IsChanged
(
kFullDesktopScreenId
)
)
{
if
(
desktop_dc_
)
{
ReleaseDC
(
NULL
desktop_dc_
)
;
desktop_dc_
=
nullptr
;
}
if
(
memory_dc_
)
{
DeleteDC
(
memory_dc_
)
;
memory_dc_
=
nullptr
;
}
}
if
(
!
desktop_dc_
)
{
RTC_DCHECK
(
!
memory_dc_
)
;
desktop_dc_
=
GetDC
(
nullptr
)
;
RTC_CHECK
(
desktop_dc_
)
;
memory_dc_
=
CreateCompatibleDC
(
desktop_dc_
)
;
RTC_CHECK
(
memory_dc_
)
;
queue_
.
Reset
(
)
;
}
}
bool
ScreenCapturerWinGdi
:
:
CaptureImage
(
)
{
RTC_DCHECK
(
IsGUIThread
(
false
)
)
;
DesktopRect
screen_rect
=
GetScreenRect
(
current_screen_id_
current_device_key_
)
;
if
(
screen_rect
.
is_empty
(
)
)
{
RTC_LOG
(
LS_WARNING
)
<
<
"
Failed
to
get
screen
rect
.
"
;
return
false
;
}
DesktopSize
size
=
screen_rect
.
size
(
)
;
if
(
!
queue_
.
current_frame
(
)
|
|
!
queue_
.
current_frame
(
)
-
>
size
(
)
.
equals
(
screen_rect
.
size
(
)
)
)
{
RTC_DCHECK
(
desktop_dc_
)
;
RTC_DCHECK
(
memory_dc_
)
;
std
:
:
unique_ptr
<
DesktopFrame
>
buffer
=
DesktopFrameWin
:
:
Create
(
size
shared_memory_factory_
.
get
(
)
desktop_dc_
)
;
if
(
!
buffer
)
{
RTC_LOG
(
LS_WARNING
)
<
<
"
Failed
to
create
frame
buffer
.
"
;
return
false
;
}
queue_
.
ReplaceCurrentFrame
(
SharedDesktopFrame
:
:
Wrap
(
std
:
:
move
(
buffer
)
)
)
;
}
queue_
.
current_frame
(
)
-
>
set_top_left
(
screen_rect
.
top_left
(
)
.
subtract
(
GetFullscreenRect
(
)
.
top_left
(
)
)
)
;
DesktopFrameWin
*
current
=
static_cast
<
DesktopFrameWin
*
>
(
queue_
.
current_frame
(
)
-
>
GetUnderlyingFrame
(
)
)
;
HGDIOBJ
previous_object
=
SelectObject
(
memory_dc_
current
-
>
bitmap
(
)
)
;
if
(
!
previous_object
|
|
previous_object
=
=
HGDI_ERROR
)
{
RTC_LOG
(
LS_WARNING
)
<
<
"
Failed
to
select
current
bitmap
into
memery
dc
.
"
;
return
false
;
}
bool
result
=
(
BitBlt
(
memory_dc_
0
0
screen_rect
.
width
(
)
screen_rect
.
height
(
)
desktop_dc_
screen_rect
.
left
(
)
screen_rect
.
top
(
)
SRCCOPY
|
CAPTUREBLT
)
!
=
FALSE
)
;
if
(
!
result
)
{
RTC_LOG_GLE
(
LS_WARNING
)
<
<
"
BitBlt
failed
"
;
}
SelectObject
(
memory_dc_
previous_object
)
;
return
result
;
}
}
