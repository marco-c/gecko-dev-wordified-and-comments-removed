#
ifndef
MODULES_DESKTOP_CAPTURE_WIN_WGC_CAPTURE_SESSION_H_
#
define
MODULES_DESKTOP_CAPTURE_WIN_WGC_CAPTURE_SESSION_H_
#
include
<
d3d11
.
h
>
#
include
<
shellscalingapi
.
h
>
#
include
<
windows
.
graphics
.
capture
.
h
>
#
include
<
windows
.
graphics
.
h
>
#
include
<
wrl
/
client
.
h
>
#
include
<
wrl
/
implements
.
h
>
#
include
<
cstdint
>
#
include
<
memory
>
#
include
<
optional
>
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_capture_options
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_frame
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_region
.
h
"
#
include
"
modules
/
desktop_capture
/
screen_capture_frame_queue
.
h
"
#
include
"
modules
/
desktop_capture
/
shared_desktop_frame
.
h
"
#
include
"
rtc_base
/
event
.
h
"
namespace
webrtc
{
class
WgcCaptureSession
final
{
public
:
WgcCaptureSession
(
intptr_t
source_id
Microsoft
:
:
WRL
:
:
ComPtr
<
ID3D11Device
>
d3d11_device
Microsoft
:
:
WRL
:
:
ComPtr
<
ABI
:
:
Windows
:
:
Graphics
:
:
Capture
:
:
IGraphicsCaptureItem
>
item
ABI
:
:
Windows
:
:
Graphics
:
:
SizeInt32
size
)
;
WgcCaptureSession
(
const
WgcCaptureSession
&
)
=
delete
;
WgcCaptureSession
&
operator
=
(
const
WgcCaptureSession
&
)
=
delete
;
~
WgcCaptureSession
(
)
;
HRESULT
StartCapture
(
const
DesktopCaptureOptions
&
options
)
;
bool
GetFrame
(
std
:
:
unique_ptr
<
DesktopFrame
>
*
output_frame
bool
source_should_be_capturable
)
;
bool
IsCaptureStarted
(
)
const
{
RTC_DCHECK_RUN_ON
(
&
sequence_checker_
)
;
return
is_capture_started_
;
}
static
constexpr
int
kNumBuffers
=
2
;
private
:
class
RefCountedEvent
:
public
RefCountedNonVirtual
<
RefCountedEvent
>
public
Event
{
public
:
RefCountedEvent
(
bool
manual_reset
bool
initially_signaled
)
;
private
:
friend
class
RefCountedNonVirtual
<
RefCountedEvent
>
;
~
RefCountedEvent
(
)
;
}
;
class
AgileFrameArrivedHandler
:
public
Microsoft
:
:
WRL
:
:
RuntimeClass
<
Microsoft
:
:
WRL
:
:
RuntimeClassFlags
<
Microsoft
:
:
WRL
:
:
ClassicCom
>
ABI
:
:
Windows
:
:
Foundation
:
:
ITypedEventHandler
<
ABI
:
:
Windows
:
:
Graphics
:
:
Capture
:
:
Direct3D11CaptureFramePool
*
IInspectable
*
>
IAgileObject
>
{
public
:
AgileFrameArrivedHandler
(
scoped_refptr
<
RefCountedEvent
>
event
)
;
IFACEMETHODIMP
Invoke
(
ABI
:
:
Windows
:
:
Graphics
:
:
Capture
:
:
IDirect3D11CaptureFramePool
*
sender
IInspectable
*
args
)
override
;
private
:
scoped_refptr
<
RefCountedEvent
>
frame_arrived_event_
;
}
;
HRESULT
CreateMappedTexture
(
Microsoft
:
:
WRL
:
:
ComPtr
<
ID3D11Texture2D
>
src_texture
UINT
width
=
0
UINT
height
=
0
)
;
HRESULT
OnItemClosed
(
ABI
:
:
Windows
:
:
Graphics
:
:
Capture
:
:
IGraphicsCaptureItem
*
sender
IInspectable
*
event_args
)
;
bool
WaitForFirstFrame
(
)
;
void
EnsureFrame
(
)
;
HRESULT
ProcessFrame
(
)
;
void
RemoveEventHandlers
(
)
;
void
RemoveItemClosedEventHandler
(
)
;
void
RemoveFrameArrivedEventHandler
(
)
;
HRESULT
AddFrameArrivedEventHandler
(
)
;
bool
FrameContentCanBeCompared
(
)
;
bool
allow_zero_hertz
(
)
const
{
return
allow_zero_hertz_
;
}
std
:
:
unique_ptr
<
EventRegistrationToken
>
item_closed_token_
;
std
:
:
unique_ptr
<
EventRegistrationToken
>
frame_arrived_token_
;
Microsoft
:
:
WRL
:
:
ComPtr
<
ID3D11Device
>
d3d11_device_
;
Microsoft
:
:
WRL
:
:
ComPtr
<
ABI
:
:
Windows
:
:
Graphics
:
:
Capture
:
:
IGraphicsCaptureItem
>
item_
;
Microsoft
:
:
WRL
:
:
ComPtr
<
ABI
:
:
Windows
:
:
Graphics
:
:
DirectX
:
:
Direct3D11
:
:
IDirect3DDevice
>
direct3d_device_
;
Microsoft
:
:
WRL
:
:
ComPtr
<
ABI
:
:
Windows
:
:
Graphics
:
:
Capture
:
:
IDirect3D11CaptureFramePool
>
frame_pool_
;
Microsoft
:
:
WRL
:
:
ComPtr
<
ID3D11Texture2D
>
mapped_texture_
;
ABI
:
:
Windows
:
:
Graphics
:
:
SizeInt32
size_
;
Microsoft
:
:
WRL
:
:
ComPtr
<
ABI
:
:
Windows
:
:
Graphics
:
:
Capture
:
:
IGraphicsCaptureSession
>
session_
;
ScreenCaptureFrameQueue
<
SharedDesktopFrame
>
queue_
;
bool
item_closed_
=
false
;
bool
is_capture_started_
=
false
;
bool
allow_zero_hertz_
=
false
;
DesktopRegion
damage_region_
;
intptr_t
source_id_
;
std
:
:
optional
<
HMONITOR
>
monitor_
;
bool
is_window_source_
;
scoped_refptr
<
RefCountedEvent
>
has_first_frame_arrived_event_
;
bool
has_first_frame_arrived_
=
false
;
SequenceChecker
sequence_checker_
;
}
;
}
#
endif
