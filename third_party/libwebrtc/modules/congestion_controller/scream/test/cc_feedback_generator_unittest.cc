#
include
"
modules
/
congestion_controller
/
scream
/
test
/
cc_feedback_generator
.
h
"
#
include
"
api
/
transport
/
ecn_marking
.
h
"
#
include
"
api
/
transport
/
network_types
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
data_size
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
network
/
simulated_network
.
h
"
namespace
webrtc
{
namespace
{
constexpr
DataSize
kPacketSize
=
DataSize
:
:
Bytes
(
1000
)
;
TEST
(
CcFeedbackGeneratorTest
BasicFeedback
)
{
SimulatedClock
clock
(
Timestamp
:
:
Seconds
(
1234
)
)
;
CcFeedbackGenerator
feedback_generator
(
{
.
network_config
=
{
.
queue_delay_ms
=
25
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1000
)
}
.
time_between_feedback
=
TimeDelta
:
:
Millis
(
50
)
}
)
;
TransportPacketsFeedback
feedback_1
=
feedback_generator
.
ProcessUntilNextFeedback
(
DataRate
:
:
KilobitsPerSec
(
500
)
clock
)
;
EXPECT_EQ
(
feedback_1
.
feedback_time
clock
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
feedback_1
.
smoothed_rtt
TimeDelta
:
:
Millis
(
58
)
)
;
EXPECT_EQ
(
feedback_1
.
data_in_flight
3
*
kPacketSize
)
;
for
(
const
PacketResult
&
packet
:
feedback_1
.
packet_feedbacks
)
{
EXPECT_EQ
(
(
packet
.
receive_time
-
packet
.
sent_packet
.
send_time
)
TimeDelta
:
:
Millis
(
25
+
8
)
)
;
EXPECT_EQ
(
packet
.
ecn
EcnMarking
:
:
kEct1
)
;
}
TransportPacketsFeedback
feedback_2
=
feedback_generator
.
ProcessUntilNextFeedback
(
DataRate
:
:
KilobitsPerSec
(
500
)
clock
)
;
EXPECT_EQ
(
(
feedback_2
.
feedback_time
-
feedback_1
.
feedback_time
)
.
ms
(
)
50
)
;
}
TEST
(
CcFeedbackGeneratorTest
CeMarksPacketsIfSendRateIsTooHigh
)
{
SimulatedClock
clock
(
Timestamp
:
:
Seconds
(
1234
)
)
;
CcFeedbackGenerator
feedback_generator
(
{
.
network_config
=
{
.
queue_delay_ms
=
25
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1000
)
}
}
)
;
int
number_of_ce_marks
=
0
;
for
(
int
i
=
0
;
i
<
5
;
+
+
i
)
{
TransportPacketsFeedback
feedback
=
feedback_generator
.
ProcessUntilNextFeedback
(
DataRate
:
:
KilobitsPerSec
(
1100
)
clock
)
;
number_of_ce_marks
+
=
CcFeedbackGenerator
:
:
CountCeMarks
(
feedback
)
;
}
EXPECT_GE
(
number_of_ce_marks
2
)
;
}
TEST
(
CcFeedbackGeneratorTest
NoCeMarksIfSendRateIsBelowLinkCapacity
)
{
SimulatedClock
clock
(
Timestamp
:
:
Seconds
(
1234
)
)
;
CcFeedbackGenerator
feedback_generator
(
{
.
network_config
=
{
.
queue_delay_ms
=
25
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1000
)
}
.
time_between_feedback
=
TimeDelta
:
:
Millis
(
25
)
}
)
;
int
number_of_ce_marks
=
0
;
for
(
int
i
=
0
;
i
<
5
;
+
+
i
)
{
TransportPacketsFeedback
feedback
=
feedback_generator
.
ProcessUntilNextFeedback
(
DataRate
:
:
KilobitsPerSec
(
1000
)
clock
)
;
number_of_ce_marks
+
=
CcFeedbackGenerator
:
:
CountCeMarks
(
feedback
)
;
}
EXPECT_EQ
(
number_of_ce_marks
0
)
;
}
TEST
(
CcFeedbackGeneratorTest
DropPacketsIfSendRateIsTooHigh
)
{
SimulatedClock
clock
(
Timestamp
:
:
Seconds
(
1234
)
)
;
SimulatedNetwork
:
:
Config
network_config
=
{
.
queue_length_packets
=
1
.
queue_delay_ms
=
25
.
link_capacity
=
DataRate
:
:
KilobitsPerSec
(
1000
)
}
;
CcFeedbackGenerator
feedback_generator
(
{
.
network_config
=
network_config
.
send_as_ect1
=
false
}
)
;
int
number_of_lost_packets
=
0
;
for
(
int
i
=
0
;
i
<
5
;
+
+
i
)
{
TransportPacketsFeedback
feedback
=
feedback_generator
.
ProcessUntilNextFeedback
(
DataRate
:
:
KilobitsPerSec
(
1100
)
clock
)
;
number_of_lost_packets
+
=
feedback
.
LostWithSendInfo
(
)
.
size
(
)
;
}
EXPECT_GE
(
number_of_lost_packets
2
)
;
}
}
}
