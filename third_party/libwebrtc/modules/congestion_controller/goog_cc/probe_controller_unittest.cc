#
include
"
modules
/
congestion_controller
/
goog_cc
/
probe_controller
.
h
"
#
include
<
memory
>
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
logging
/
rtc_event_log
/
mock
/
mock_rtc_event_log
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
#
include
"
test
/
explicit_key_value_config
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
using
:
:
testing
:
:
NiceMock
;
namespace
webrtc
{
namespace
test
{
namespace
{
constexpr
DataRate
kMinBitrate
=
DataRate
:
:
BitsPerSec
(
100
)
;
constexpr
DataRate
kStartBitrate
=
DataRate
:
:
BitsPerSec
(
300
)
;
constexpr
DataRate
kMaxBitrate
=
DataRate
:
:
BitsPerSec
(
10000
)
;
constexpr
TimeDelta
kExponentialProbingTimeout
=
TimeDelta
:
:
Seconds
(
5
)
;
constexpr
TimeDelta
kAlrProbeInterval
=
TimeDelta
:
:
Seconds
(
5
)
;
constexpr
TimeDelta
kAlrEndedTimeout
=
TimeDelta
:
:
Seconds
(
3
)
;
constexpr
TimeDelta
kBitrateDropTimeout
=
TimeDelta
:
:
Seconds
(
5
)
;
}
class
ProbeControllerFixture
{
public
:
explicit
ProbeControllerFixture
(
absl
:
:
string_view
field_trials
=
"
"
)
:
field_trial_config_
(
field_trials
)
clock_
(
100000000L
)
{
}
std
:
:
unique_ptr
<
ProbeController
>
CreateController
(
)
{
return
std
:
:
make_unique
<
ProbeController
>
(
&
field_trial_config_
&
mock_rtc_event_log
)
;
}
Timestamp
CurrentTime
(
)
{
return
clock_
.
CurrentTime
(
)
;
}
void
AdvanceTime
(
TimeDelta
delta
)
{
clock_
.
AdvanceTime
(
delta
)
;
}
ExplicitKeyValueConfig
field_trial_config_
;
SimulatedClock
clock_
;
NiceMock
<
MockRtcEventLog
>
mock_rtc_event_log
;
}
;
TEST
(
ProbeControllerTest
InitiatesProbingAtStart
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_GE
(
probes
.
size
(
)
2u
)
;
}
TEST
(
ProbeControllerTest
SetsDefaultTargetDurationAndTargetProbeCount
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
std
:
:
vector
<
ProbeClusterConfig
>
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
ASSERT_GE
(
probes
.
size
(
)
2u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_duration
TimeDelta
:
:
Millis
(
15
)
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_probe_count
5
)
;
}
TEST
(
ProbeControllerTest
FieldTrialsOverrideDefaultTargetDurationAndTargetProbeCount
)
{
ProbeControllerFixture
fixture
(
"
WebRTC
-
Bwe
-
ProbingBehavior
/
"
"
min_probe_packets_sent
:
2
min_probe_duration
:
123ms
/
"
)
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
std
:
:
vector
<
ProbeClusterConfig
>
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
ASSERT_GE
(
probes
.
size
(
)
2u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_duration
TimeDelta
:
:
Millis
(
123
)
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_probe_count
2
)
;
}
TEST
(
ProbeControllerTest
ProbeOnlyWhenNetworkIsUp
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
OnNetworkAvailability
(
{
.
at_time
=
fixture
.
CurrentTime
(
)
.
network_available
=
false
}
)
;
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
probes
=
probe_controller
-
>
OnNetworkAvailability
(
{
.
at_time
=
fixture
.
CurrentTime
(
)
.
network_available
=
true
}
)
;
EXPECT_GE
(
probes
.
size
(
)
2u
)
;
}
TEST
(
ProbeControllerTest
InitiatesProbingOnMaxBitrateIncrease
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
kExponentialProbingTimeout
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
kStartBitrate
false
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
+
DataRate
:
:
BitsPerSec
(
100
)
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
kMaxBitrate
.
bps
(
)
+
100
)
;
}
TEST
(
ProbeControllerTest
ProbesOnMaxBitrateIncreaseOnlyWhenInAlr
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
kMaxBitrate
-
DataRate
:
:
BitsPerSec
(
1
)
false
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
kExponentialProbingTimeout
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
probes
=
probe_controller
-
>
OnMaxTotalAllocatedBitrate
(
kMaxBitrate
+
DataRate
:
:
BitsPerSec
(
1
)
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
2u
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
absl
:
:
nullopt
)
;
probes
=
probe_controller
-
>
OnMaxTotalAllocatedBitrate
(
kMaxBitrate
+
DataRate
:
:
BitsPerSec
(
2
)
fixture
.
CurrentTime
(
)
)
;
EXPECT_TRUE
(
probes
.
empty
(
)
)
;
}
TEST
(
ProbeControllerTest
InitiatesProbingOnMaxBitrateIncreaseAtMaxBitrate
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
kExponentialProbingTimeout
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
kStartBitrate
false
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
kMaxBitrate
false
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
+
DataRate
:
:
BitsPerSec
(
100
)
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
kMaxBitrate
+
DataRate
:
:
BitsPerSec
(
100
)
)
;
}
TEST
(
ProbeControllerTest
TestExponentialProbing
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
1000
)
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
1800
)
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
2
*
1800
)
;
}
TEST
(
ProbeControllerTest
TestExponentialProbingTimeout
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
kExponentialProbingTimeout
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
1800
)
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
}
TEST
(
ProbeControllerTest
RequestProbeInAlr
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_GE
(
probes
.
size
(
)
2u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
kAlrProbeInterval
+
TimeDelta
:
:
Millis
(
1
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
250
)
false
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
RequestProbe
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
0
.
85
*
500
)
;
}
TEST
(
ProbeControllerTest
RequestProbeWhenAlrEndedRecently
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
2u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
absl
:
:
nullopt
)
;
fixture
.
AdvanceTime
(
kAlrProbeInterval
+
TimeDelta
:
:
Millis
(
1
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
250
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrEndedTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
kAlrEndedTimeout
-
TimeDelta
:
:
Millis
(
1
)
)
;
probes
=
probe_controller
-
>
RequestProbe
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
0
.
85
*
500
)
;
}
TEST
(
ProbeControllerTest
RequestProbeWhenAlrNotEndedRecently
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
2u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
absl
:
:
nullopt
)
;
fixture
.
AdvanceTime
(
kAlrProbeInterval
+
TimeDelta
:
:
Millis
(
1
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
250
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrEndedTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
kAlrEndedTimeout
+
TimeDelta
:
:
Millis
(
1
)
)
;
probes
=
probe_controller
-
>
RequestProbe
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
}
TEST
(
ProbeControllerTest
RequestProbeWhenBweDropNotRecent
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
2u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
kAlrProbeInterval
+
TimeDelta
:
:
Millis
(
1
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
250
)
false
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
kBitrateDropTimeout
+
TimeDelta
:
:
Millis
(
1
)
)
;
probes
=
probe_controller
-
>
RequestProbe
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
}
TEST
(
ProbeControllerTest
PeriodicProbing
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
probe_controller
-
>
EnablePeriodicAlrProbing
(
true
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
2u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
Timestamp
start_time
=
fixture
.
CurrentTime
(
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
start_time
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
1000
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
start_time
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
4
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
start_time
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
}
TEST
(
ProbeControllerTest
PeriodicProbingAfterReset
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
Timestamp
alr_start_time
=
fixture
.
CurrentTime
(
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
alr_start_time
.
ms
(
)
)
;
probe_controller
-
>
EnablePeriodicAlrProbing
(
true
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
Reset
(
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
10
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
2u
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
10
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
kStartBitrate
*
2
)
;
}
TEST
(
ProbeControllerTest
TestExponentialProbingOverflow
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
const
DataRate
kMbpsMultiplier
=
DataRate
:
:
KilobitsPerSec
(
1000
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
10
*
kMbpsMultiplier
100
*
kMbpsMultiplier
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
60
*
kMbpsMultiplier
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
100
*
kMbpsMultiplier
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
100
*
kMbpsMultiplier
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
}
TEST
(
ProbeControllerTest
TestAllocatedBitrateCap
)
{
ProbeControllerFixture
fixture
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
const
DataRate
kMbpsMultiplier
=
DataRate
:
:
KilobitsPerSec
(
1000
)
;
const
DataRate
kMaxBitrate
=
100
*
kMbpsMultiplier
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
10
*
kMbpsMultiplier
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
EnablePeriodicAlrProbing
(
true
)
;
Timestamp
alr_start_time
=
fixture
.
CurrentTime
(
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
alr_start_time
.
ms
(
)
)
;
DataRate
estimated_bitrate
=
kMaxBitrate
/
10
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
estimated_bitrate
false
fixture
.
CurrentTime
(
)
)
;
DataRate
max_allocated
=
estimated_bitrate
-
1
*
kMbpsMultiplier
;
probes
=
probe_controller
-
>
OnMaxTotalAllocatedBitrate
(
max_allocated
fixture
.
CurrentTime
(
)
)
;
EXPECT_TRUE
(
probes
.
empty
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
2
*
max_allocated
)
;
EXPECT_TRUE
(
probe_controller
-
>
OnMaxTotalAllocatedBitrate
(
DataRate
:
:
Zero
(
)
fixture
.
CurrentTime
(
)
)
.
empty
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
estimated_bitrate
*
2
)
;
}
TEST
(
ProbeControllerTest
ConfigurableProbingFieldTrial
)
{
ProbeControllerFixture
fixture
(
"
WebRTC
-
Bwe
-
ProbingConfiguration
/
"
"
p1
:
2
p2
:
5
step_size
:
3
further_probe_threshold
:
0
.
8
"
"
alloc_p1
:
2
alloc_p2
/
"
)
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
DataRate
:
:
KilobitsPerSec
(
5000
)
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
2u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
600
)
;
EXPECT_EQ
(
probes
[
1
]
.
target_data_rate
.
bps
(
)
1500
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
1100
)
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
0u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
1250
)
false
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
3
*
1250
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
probes
=
probe_controller
-
>
OnMaxTotalAllocatedBitrate
(
DataRate
:
:
KilobitsPerSec
(
200
)
fixture
.
CurrentTime
(
)
)
;
EXPECT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
.
bps
(
)
400
'
000
)
;
}
TEST
(
ProbeControllerTest
PauseAlrProbeWhenLossBasedBweLimited
)
{
ProbeControllerFixture
fixture
(
"
WebRTC
-
Bwe
-
ProbingConfiguration
/
"
"
probe_if_bwe_limited_due_to_loss
:
false
/
"
)
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
probe_controller
-
>
EnablePeriodicAlrProbing
(
true
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
ASSERT_EQ
(
probes
.
size
(
)
1u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
true
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
6
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_TRUE
(
probes
.
empty
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
6
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_TRUE
(
!
probes
.
empty
(
)
)
;
}
TEST
(
ProbeControllerTest
AlrProbeStartWhenNotLossBasedBweLimited
)
{
ProbeControllerFixture
fixture
(
"
WebRTC
-
Bwe
-
ProbingConfiguration
/
"
"
probe_if_bwe_limited_due_to_loss
:
false
/
"
)
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
probe_controller
-
>
EnablePeriodicAlrProbing
(
true
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
true
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_TRUE
(
probes
.
empty
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
1
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_TRUE
(
!
probes
.
empty
(
)
)
;
}
TEST
(
ProbeControllerTest
PeriodicProbeAtUpperNetworkStateEstimate
)
{
ProbeControllerFixture
fixture
(
"
WebRTC
-
Bwe
-
ProbingConfiguration
/
network_state_interval
:
5s
/
"
)
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
5000
)
false
fixture
.
CurrentTime
(
)
)
;
NetworkStateEstimate
state_estimate
;
state_estimate
.
link_capacity_upper
=
DataRate
:
:
KilobitsPerSec
(
6
)
;
probe_controller
-
>
SetNetworkStateEstimate
(
state_estimate
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
ASSERT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
state_estimate
.
link_capacity_upper
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
ASSERT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
state_estimate
.
link_capacity_upper
)
;
}
TEST
(
ProbeControllerTest
PausePeriodicProbeAtUpperNetworkStateEstimateIfLossBasedLimited
)
{
ProbeControllerFixture
fixture
(
"
WebRTC
-
Bwe
-
ProbingConfiguration
/
"
"
network_state_interval
:
5s
probe_if_bwe_limited_due_to_loss
:
false
/
"
)
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
NetworkStateEstimate
state_estimate
;
state_estimate
.
link_capacity_upper
=
DataRate
:
:
KilobitsPerSec
(
600
)
;
probe_controller
-
>
SetNetworkStateEstimate
(
state_estimate
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
ASSERT_EQ
(
probes
.
size
(
)
1u
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
true
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_TRUE
(
probes
.
empty
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
BitsPerSec
(
500
)
false
fixture
.
CurrentTime
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
EXPECT_FALSE
(
probes
.
empty
(
)
)
;
}
TEST
(
ProbeControllerTest
AlrProbesLimitedByNetworkStateEstimate
)
{
ProbeControllerFixture
fixture
(
"
WebRTC
-
Bwe
-
ProbingConfiguration
/
network_state_interval
:
5s
/
"
)
;
std
:
:
unique_ptr
<
ProbeController
>
probe_controller
=
fixture
.
CreateController
(
)
;
probe_controller
-
>
EnablePeriodicAlrProbing
(
true
)
;
auto
probes
=
probe_controller
-
>
SetBitrates
(
kMinBitrate
kStartBitrate
kMaxBitrate
fixture
.
CurrentTime
(
)
)
;
probes
=
probe_controller
-
>
SetEstimatedBitrate
(
DataRate
:
:
KilobitsPerSec
(
6
)
false
fixture
.
CurrentTime
(
)
)
;
probe_controller
-
>
SetAlrStartTimeMs
(
fixture
.
CurrentTime
(
)
.
ms
(
)
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
ASSERT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
kMaxBitrate
)
;
NetworkStateEstimate
state_estimate
;
state_estimate
.
link_capacity_upper
=
DataRate
:
:
BitsPerSec
(
8000
)
;
probe_controller
-
>
SetNetworkStateEstimate
(
state_estimate
)
;
fixture
.
AdvanceTime
(
TimeDelta
:
:
Seconds
(
5
)
)
;
probes
=
probe_controller
-
>
Process
(
fixture
.
CurrentTime
(
)
)
;
ASSERT_EQ
(
probes
.
size
(
)
1u
)
;
EXPECT_EQ
(
probes
[
0
]
.
target_data_rate
state_estimate
.
link_capacity_upper
)
;
}
}
}
