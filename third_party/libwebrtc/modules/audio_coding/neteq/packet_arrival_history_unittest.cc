#
include
"
modules
/
audio_coding
/
neteq
/
packet_arrival_history
.
h
"
#
include
<
cstdint
>
#
include
<
limits
>
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
constexpr
int
kFs
=
8000
;
constexpr
int
kFsKhz
=
kFs
/
1000
;
constexpr
int
kFrameSizeMs
=
20
;
constexpr
int
kWindowSizeMs
=
1000
;
class
PacketArrivalHistoryTest
:
public
testing
:
:
Test
{
public
:
PacketArrivalHistoryTest
(
)
:
history_
(
kWindowSizeMs
)
{
history_
.
set_sample_rate
(
kFs
)
;
}
void
IncrementTime
(
int
delta_ms
)
{
time_ms_
+
=
delta_ms
;
}
int
InsertPacketAndGetDelay
(
int
timestamp_delta_ms
)
{
uint32_t
timestamp
=
timestamp_
+
timestamp_delta_ms
*
kFsKhz
;
if
(
timestamp_delta_ms
>
0
)
{
timestamp_
=
timestamp
;
}
history_
.
Insert
(
timestamp
time_ms_
)
;
EXPECT_EQ
(
history_
.
IsNewestRtpTimestamp
(
timestamp
)
timestamp_delta_ms
>
=
0
)
;
return
history_
.
GetDelayMs
(
timestamp
time_ms_
)
;
}
protected
:
int64_t
time_ms_
=
0
;
PacketArrivalHistory
history_
;
uint32_t
timestamp_
=
0x12345678
;
}
;
TEST_F
(
PacketArrivalHistoryTest
RelativeArrivalDelay
)
{
EXPECT_EQ
(
InsertPacketAndGetDelay
(
0
)
0
)
;
IncrementTime
(
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
0
)
;
IncrementTime
(
2
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
20
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
-
2
*
kFrameSizeMs
)
60
)
;
IncrementTime
(
2
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
40
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
4
*
kFrameSizeMs
)
0
)
;
IncrementTime
(
2
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
20
)
;
EXPECT_EQ
(
history_
.
GetMaxDelayMs
(
)
100
)
;
}
TEST_F
(
PacketArrivalHistoryTest
ReorderedPackets
)
{
EXPECT_EQ
(
InsertPacketAndGetDelay
(
0
)
0
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
-
80
)
80
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
-
kFrameSizeMs
)
20
)
;
IncrementTime
(
4
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
60
)
;
EXPECT_EQ
(
history_
.
GetMaxDelayMs
(
)
80
)
;
}
TEST_F
(
PacketArrivalHistoryTest
MaxHistorySize
)
{
EXPECT_EQ
(
InsertPacketAndGetDelay
(
0
)
0
)
;
IncrementTime
(
2
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
20
)
;
EXPECT_EQ
(
history_
.
GetMaxDelayMs
(
)
20
)
;
IncrementTime
(
kWindowSizeMs
+
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
+
kWindowSizeMs
)
0
)
;
EXPECT_EQ
(
history_
.
GetMaxDelayMs
(
)
0
)
;
}
TEST_F
(
PacketArrivalHistoryTest
TimestampWraparound
)
{
timestamp_
=
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
0
)
0
)
;
IncrementTime
(
2
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
-
2
*
kFrameSizeMs
)
3
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
0
)
;
EXPECT_EQ
(
history_
.
GetMaxDelayMs
(
)
3
*
kFrameSizeMs
)
;
}
TEST_F
(
PacketArrivalHistoryTest
TimestampWraparoundBackwards
)
{
timestamp_
=
0
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
0
)
0
)
;
IncrementTime
(
2
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
-
2
*
kFrameSizeMs
)
3
*
kFrameSizeMs
)
;
EXPECT_EQ
(
InsertPacketAndGetDelay
(
kFrameSizeMs
)
0
)
;
EXPECT_EQ
(
history_
.
GetMaxDelayMs
(
)
3
*
kFrameSizeMs
)
;
}
}
}
