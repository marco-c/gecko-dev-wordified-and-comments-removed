#
ifndef
MODULES_AUDIO_CODING_NETEQ_PACKET_ARRIVAL_HISTORY_H_
#
define
MODULES_AUDIO_CODING_NETEQ_PACKET_ARRIVAL_HISTORY_H_
#
include
<
cstdint
>
#
include
<
deque
>
#
include
"
absl
/
types
/
optional
.
h
"
#
include
"
api
/
neteq
/
tick_timer
.
h
"
#
include
"
rtc_base
/
numerics
/
sequence_number_unwrapper
.
h
"
namespace
webrtc
{
class
PacketArrivalHistory
{
public
:
explicit
PacketArrivalHistory
(
int
window_size_ms
)
;
virtual
~
PacketArrivalHistory
(
)
=
default
;
void
Insert
(
uint32_t
rtp_timestamp
int64_t
arrival_time_ms
)
;
virtual
int
GetDelayMs
(
uint32_t
rtp_timestamp
int64_t
time_ms
)
const
;
virtual
int
GetMaxDelayMs
(
)
const
;
bool
IsNewestRtpTimestamp
(
uint32_t
rtp_timestamp
)
const
;
void
Reset
(
)
;
void
set_sample_rate
(
int
sample_rate
)
{
sample_rate_khz_
=
sample_rate
/
1000
;
}
size_t
size
(
)
const
{
return
history_
.
size
(
)
;
}
private
:
struct
PacketArrival
{
PacketArrival
(
int64_t
rtp_timestamp_ms
int64_t
arrival_time_ms
)
:
rtp_timestamp_ms
(
rtp_timestamp_ms
)
arrival_time_ms
(
arrival_time_ms
)
{
}
int64_t
rtp_timestamp_ms
;
int64_t
arrival_time_ms
;
bool
operator
<
=
(
const
PacketArrival
&
other
)
const
{
return
arrival_time_ms
-
rtp_timestamp_ms
<
=
other
.
arrival_time_ms
-
other
.
rtp_timestamp_ms
;
}
bool
operator
>
=
(
const
PacketArrival
&
other
)
const
{
return
arrival_time_ms
-
rtp_timestamp_ms
>
=
other
.
arrival_time_ms
-
other
.
rtp_timestamp_ms
;
}
}
;
std
:
:
deque
<
PacketArrival
>
history_
;
int
GetPacketArrivalDelayMs
(
const
PacketArrival
&
packet_arrival
)
const
;
void
MaybeUpdateCachedArrivals
(
const
PacketArrival
&
packet
)
;
const
PacketArrival
*
min_packet_arrival_
=
nullptr
;
const
PacketArrival
*
max_packet_arrival_
=
nullptr
;
const
int
window_size_ms_
;
RtpTimestampUnwrapper
timestamp_unwrapper_
;
absl
:
:
optional
<
int64_t
>
newest_rtp_timestamp_
;
int
sample_rate_khz_
=
0
;
}
;
}
#
endif
