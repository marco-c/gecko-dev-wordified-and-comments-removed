#
include
"
modules
/
audio_coding
/
neteq
/
delay_manager
.
h
"
#
include
<
math
.
h
>
#
include
<
memory
>
#
include
"
modules
/
audio_coding
/
neteq
/
histogram
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
mock
/
mock_histogram
.
h
"
#
include
"
modules
/
audio_coding
/
neteq
/
mock
/
mock_statistics_calculator
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
test
/
field_trial
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
constexpr
int
kMaxNumberOfPackets
=
240
;
constexpr
int
kMinDelayMs
=
0
;
constexpr
int
kTimeStepMs
=
10
;
constexpr
int
kFs
=
8000
;
constexpr
int
kFrameSizeMs
=
20
;
constexpr
int
kTsIncrement
=
kFrameSizeMs
*
kFs
/
1000
;
constexpr
int
kMaxBufferSizeMs
=
kMaxNumberOfPackets
*
kFrameSizeMs
;
constexpr
int
kDefaultHistogramQuantile
=
1020054733
;
constexpr
int
kMaxIat
=
64
;
constexpr
int
kForgetFactor
=
32745
;
}
using
:
:
testing
:
:
_
;
using
:
:
testing
:
:
Return
;
class
DelayManagerTest
:
public
:
:
testing
:
:
Test
{
protected
:
DelayManagerTest
(
)
;
virtual
void
SetUp
(
)
;
void
RecreateDelayManager
(
)
;
void
SetPacketAudioLength
(
int
lengt_ms
)
;
absl
:
:
optional
<
int
>
InsertNextPacket
(
)
;
void
IncreaseTime
(
int
inc_ms
)
;
std
:
:
unique_ptr
<
DelayManager
>
dm_
;
TickTimer
tick_timer_
;
MockStatisticsCalculator
stats_
;
MockHistogram
*
mock_histogram_
;
uint16_t
seq_no_
;
uint32_t
ts_
;
bool
enable_rtx_handling_
=
false
;
bool
use_mock_histogram_
=
false
;
}
;
DelayManagerTest
:
:
DelayManagerTest
(
)
:
dm_
(
nullptr
)
seq_no_
(
0x1234
)
ts_
(
0x12345678
)
{
}
void
DelayManagerTest
:
:
SetUp
(
)
{
RecreateDelayManager
(
)
;
}
void
DelayManagerTest
:
:
RecreateDelayManager
(
)
{
if
(
use_mock_histogram_
)
{
mock_histogram_
=
new
MockHistogram
(
kMaxIat
kForgetFactor
)
;
std
:
:
unique_ptr
<
Histogram
>
histogram
(
mock_histogram_
)
;
dm_
=
std
:
:
make_unique
<
DelayManager
>
(
kMaxNumberOfPackets
kMinDelayMs
kDefaultHistogramQuantile
enable_rtx_handling_
&
tick_timer_
std
:
:
move
(
histogram
)
)
;
}
else
{
dm_
=
DelayManager
:
:
Create
(
kMaxNumberOfPackets
kMinDelayMs
enable_rtx_handling_
&
tick_timer_
)
;
}
}
void
DelayManagerTest
:
:
SetPacketAudioLength
(
int
lengt_ms
)
{
dm_
-
>
SetPacketAudioLength
(
lengt_ms
)
;
}
absl
:
:
optional
<
int
>
DelayManagerTest
:
:
InsertNextPacket
(
)
{
auto
relative_delay
=
dm_
-
>
Update
(
seq_no_
ts_
kFs
)
;
seq_no_
+
=
1
;
ts_
+
=
kTsIncrement
;
return
relative_delay
;
}
void
DelayManagerTest
:
:
IncreaseTime
(
int
inc_ms
)
{
for
(
int
t
=
0
;
t
<
inc_ms
;
t
+
=
kTimeStepMs
)
{
tick_timer_
.
Increment
(
)
;
}
}
TEST_F
(
DelayManagerTest
CreateAndDestroy
)
{
}
TEST_F
(
DelayManagerTest
SetPacketAudioLength
)
{
const
int
kLengthMs
=
30
;
EXPECT_EQ
(
0
dm_
-
>
SetPacketAudioLength
(
kLengthMs
)
)
;
EXPECT_EQ
(
-
1
dm_
-
>
SetPacketAudioLength
(
-
1
)
)
;
}
TEST_F
(
DelayManagerTest
UpdateNormal
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
1
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
EXPECT_EQ
(
1
dm_
-
>
base_target_level
(
)
)
;
int
lower
higher
;
dm_
-
>
BufferLimits
(
&
lower
&
higher
)
;
EXPECT_EQ
(
(
1
<
<
8
)
*
3
/
4
lower
)
;
EXPECT_EQ
(
lower
+
(
20
<
<
8
)
/
kFrameSizeMs
higher
)
;
}
TEST_F
(
DelayManagerTest
UpdateLongInterArrivalTime
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
2
*
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
2
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
EXPECT_EQ
(
2
dm_
-
>
base_target_level
(
)
)
;
int
lower
higher
;
dm_
-
>
BufferLimits
(
&
lower
&
higher
)
;
EXPECT_EQ
(
(
2
<
<
8
)
*
3
/
4
lower
)
;
EXPECT_EQ
(
lower
+
(
20
<
<
8
)
/
kFrameSizeMs
higher
)
;
}
TEST_F
(
DelayManagerTest
MaxDelay
)
{
const
int
kExpectedTarget
=
5
;
const
int
kTimeIncrement
=
kExpectedTarget
*
kFrameSizeMs
;
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kTimeIncrement
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
kExpectedTarget
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
int
kMaxDelayPackets
=
kExpectedTarget
-
2
;
int
kMaxDelayMs
=
kMaxDelayPackets
*
kFrameSizeMs
;
EXPECT_TRUE
(
dm_
-
>
SetMaximumDelay
(
kMaxDelayMs
)
)
;
IncreaseTime
(
kTimeIncrement
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
kMaxDelayPackets
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
EXPECT_FALSE
(
dm_
-
>
SetMaximumDelay
(
kFrameSizeMs
-
1
)
)
;
}
TEST_F
(
DelayManagerTest
MinDelay
)
{
const
int
kExpectedTarget
=
5
;
const
int
kTimeIncrement
=
kExpectedTarget
*
kFrameSizeMs
;
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kTimeIncrement
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
kExpectedTarget
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
int
kMinDelayPackets
=
kExpectedTarget
+
2
;
int
kMinDelayMs
=
kMinDelayPackets
*
kFrameSizeMs
;
dm_
-
>
SetMinimumDelay
(
kMinDelayMs
)
;
IncreaseTime
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
kMinDelayPackets
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDelayCheckValidRange
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
EXPECT_FALSE
(
dm_
-
>
SetBaseMinimumDelay
(
-
1
)
)
;
EXPECT_FALSE
(
dm_
-
>
SetBaseMinimumDelay
(
10001
)
)
;
EXPECT_EQ
(
dm_
-
>
GetBaseMinimumDelay
(
)
0
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
7999
)
)
;
EXPECT_EQ
(
dm_
-
>
GetBaseMinimumDelay
(
)
7999
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDelayLowerThanMinimumDelay
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
constexpr
int
kBaseMinimumDelayMs
=
100
;
constexpr
int
kMinimumDelayMs
=
200
;
RTC_DCHECK_LT
(
kBaseMinimumDelayMs
kMinimumDelayMs
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
kMinimumDelayMs
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kMinimumDelayMs
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDelayGreaterThanMinimumDelay
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
constexpr
int
kBaseMinimumDelayMs
=
70
;
constexpr
int
kMinimumDelayMs
=
30
;
RTC_DCHECK_GT
(
kBaseMinimumDelayMs
kMinimumDelayMs
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
kMinimumDelayMs
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kBaseMinimumDelayMs
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDelayGreaterThanBufferSize
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
constexpr
int
kBaseMinimumDelayMs
=
kMaxBufferSizeMs
+
1
;
constexpr
int
kMinimumDelayMs
=
12
;
constexpr
int
kMaximumDelayMs
=
20
;
constexpr
int
kMaxBufferSizeMsQ75
=
3
*
kMaxBufferSizeMs
/
4
;
EXPECT_TRUE
(
dm_
-
>
SetMaximumDelay
(
kMaximumDelayMs
)
)
;
RTC_DCHECK_GT
(
kBaseMinimumDelayMs
kMinimumDelayMs
)
;
RTC_DCHECK_GT
(
kBaseMinimumDelayMs
kMaxBufferSizeMs
)
;
RTC_DCHECK_GT
(
kBaseMinimumDelayMs
kMaximumDelayMs
)
;
RTC_DCHECK_LT
(
kMaximumDelayMs
kMaxBufferSizeMsQ75
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
kMinimumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMaximumDelay
(
0
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kMaxBufferSizeMsQ75
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDelayGreaterThanMaximumDelay
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
constexpr
int
kMaximumDelayMs
=
400
;
constexpr
int
kBaseMinimumDelayMs
=
kMaximumDelayMs
+
1
;
constexpr
int
kMinimumDelayMs
=
20
;
RTC_DCHECK_GT
(
kBaseMinimumDelayMs
kMinimumDelayMs
)
;
RTC_DCHECK_GT
(
kBaseMinimumDelayMs
kMaximumDelayMs
)
;
RTC_DCHECK_LT
(
kMaximumDelayMs
kMaxBufferSizeMs
)
;
EXPECT_TRUE
(
dm_
-
>
SetMaximumDelay
(
kMaximumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
kMinimumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMs
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kMaximumDelayMs
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDelayLowerThanMaxSize
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
constexpr
int
kMaximumDelayMs
=
400
;
constexpr
int
kBaseMinimumDelayMs
=
kMaximumDelayMs
-
1
;
constexpr
int
kMinimumDelayMs
=
20
;
RTC_DCHECK_GT
(
kBaseMinimumDelayMs
kMinimumDelayMs
)
;
RTC_DCHECK_LT
(
kBaseMinimumDelayMs
kMaximumDelayMs
)
;
EXPECT_TRUE
(
dm_
-
>
SetMaximumDelay
(
kMaximumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
kMinimumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMs
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kBaseMinimumDelayMs
)
;
}
TEST_F
(
DelayManagerTest
MinimumDelayMemorization
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
constexpr
int
kBaseMinimumDelayMsLow
=
10
;
constexpr
int
kMinimumDelayMs
=
20
;
constexpr
int
kBaseMinimumDelayMsHigh
=
30
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMsLow
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
kMinimumDelayMs
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kMinimumDelayMs
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMsHigh
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kBaseMinimumDelayMsHigh
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMsLow
)
)
;
EXPECT_EQ
(
dm_
-
>
effective_minimum_delay_ms_for_test
(
)
kMinimumDelayMs
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDelay
)
{
const
int
kExpectedTarget
=
5
;
const
int
kTimeIncrement
=
kExpectedTarget
*
kFrameSizeMs
;
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kTimeIncrement
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
kExpectedTarget
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
constexpr
int
kBaseMinimumDelayPackets
=
kExpectedTarget
+
2
;
constexpr
int
kBaseMinimumDelayMs
=
kBaseMinimumDelayPackets
*
kFrameSizeMs
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMs
)
)
;
EXPECT_EQ
(
dm_
-
>
GetBaseMinimumDelay
(
)
kBaseMinimumDelayMs
)
;
IncreaseTime
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
dm_
-
>
GetBaseMinimumDelay
(
)
kBaseMinimumDelayMs
)
;
EXPECT_EQ
(
kBaseMinimumDelayPackets
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
}
TEST_F
(
DelayManagerTest
BaseMinimumDealyAffectTargetLevel
)
{
const
int
kExpectedTarget
=
5
;
const
int
kTimeIncrement
=
kExpectedTarget
*
kFrameSizeMs
;
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kTimeIncrement
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
kExpectedTarget
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
constexpr
int
kMinimumDelayPackets
=
kExpectedTarget
+
1
;
constexpr
int
kBaseMinimumDelayPackets
=
kExpectedTarget
+
2
;
constexpr
int
kMinimumDelayMs
=
kMinimumDelayPackets
*
kFrameSizeMs
;
constexpr
int
kBaseMinimumDelayMs
=
kBaseMinimumDelayPackets
*
kFrameSizeMs
;
EXPECT_TRUE
(
kMinimumDelayMs
<
kBaseMinimumDelayMs
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
kMinimumDelayMs
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetBaseMinimumDelay
(
kBaseMinimumDelayMs
)
)
;
EXPECT_EQ
(
dm_
-
>
GetBaseMinimumDelay
(
)
kBaseMinimumDelayMs
)
;
IncreaseTime
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
dm_
-
>
GetBaseMinimumDelay
(
)
kBaseMinimumDelayMs
)
;
EXPECT_EQ
(
kBaseMinimumDelayPackets
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
}
TEST_F
(
DelayManagerTest
EnableRtxHandling
)
{
enable_rtx_handling_
=
true
;
use_mock_histogram_
=
true
;
RecreateDelayManager
(
)
;
EXPECT_TRUE
(
mock_histogram_
)
;
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
2
)
)
;
dm_
-
>
Update
(
seq_no_
-
3
ts_
-
3
*
kFrameSizeMs
kFs
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
1
)
)
;
dm_
-
>
Update
(
seq_no_
-
2
ts_
-
2
*
kFrameSizeMs
kFs
)
;
IncreaseTime
(
kFrameSizeMs
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
0
)
)
;
InsertNextPacket
(
)
;
}
TEST_F
(
DelayManagerTest
EmptyPacketsReported
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kFrameSizeMs
)
;
seq_no_
+
=
10
;
for
(
int
j
=
0
;
j
<
10
;
+
+
j
)
{
dm_
-
>
RegisterEmptyPacket
(
)
;
}
InsertNextPacket
(
)
;
EXPECT_EQ
(
1
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
}
TEST_F
(
DelayManagerTest
EmptyPacketsNotReported
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kFrameSizeMs
)
;
seq_no_
+
=
10
;
InsertNextPacket
(
)
;
EXPECT_EQ
(
1
<
<
8
dm_
-
>
TargetLevel
(
)
)
;
}
TEST_F
(
DelayManagerTest
Failures
)
{
EXPECT_EQ
(
absl
:
:
nullopt
dm_
-
>
Update
(
0
0
-
1
)
)
;
EXPECT_EQ
(
-
1
dm_
-
>
SetPacketAudioLength
(
0
)
)
;
EXPECT_EQ
(
-
1
dm_
-
>
SetPacketAudioLength
(
-
1
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMaximumDelay
(
10
)
)
;
EXPECT_FALSE
(
dm_
-
>
SetMinimumDelay
(
20
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMaximumDelay
(
100
)
)
;
EXPECT_TRUE
(
dm_
-
>
SetMinimumDelay
(
80
)
)
;
EXPECT_FALSE
(
dm_
-
>
SetMaximumDelay
(
60
)
)
;
}
TEST_F
(
DelayManagerTest
DelayHistogramFieldTrial
)
{
{
test
:
:
ScopedFieldTrials
field_trial
(
"
WebRTC
-
Audio
-
NetEqDelayHistogram
/
Enabled
-
96
-
0
.
998
/
"
)
;
RecreateDelayManager
(
)
;
EXPECT_EQ
(
1030792151
dm_
-
>
histogram_quantile
(
)
)
;
EXPECT_EQ
(
32702
dm_
-
>
histogram
(
)
-
>
base_forget_factor_for_testing
(
)
)
;
EXPECT_FALSE
(
dm_
-
>
histogram
(
)
-
>
start_forget_weight_for_testing
(
)
)
;
}
{
test
:
:
ScopedFieldTrials
field_trial
(
"
WebRTC
-
Audio
-
NetEqDelayHistogram
/
Enabled
-
97
.
5
-
0
.
998
/
"
)
;
RecreateDelayManager
(
)
;
EXPECT_EQ
(
1046898278
dm_
-
>
histogram_quantile
(
)
)
;
EXPECT_EQ
(
32702
dm_
-
>
histogram
(
)
-
>
base_forget_factor_for_testing
(
)
)
;
EXPECT_FALSE
(
dm_
-
>
histogram
(
)
-
>
start_forget_weight_for_testing
(
)
)
;
}
{
test
:
:
ScopedFieldTrials
field_trial
(
"
WebRTC
-
Audio
-
NetEqDelayHistogram
/
Enabled
-
96
-
0
.
998
-
1
/
"
)
;
RecreateDelayManager
(
)
;
EXPECT_EQ
(
dm_
-
>
histogram
(
)
-
>
start_forget_weight_for_testing
(
)
.
value
(
)
1
.
0
)
;
}
{
test
:
:
ScopedFieldTrials
field_trial
(
"
WebRTC
-
Audio
-
NetEqDelayHistogram
/
Enabled
-
96
-
0
.
998
-
1
.
5
/
"
)
;
RecreateDelayManager
(
)
;
EXPECT_EQ
(
dm_
-
>
histogram
(
)
-
>
start_forget_weight_for_testing
(
)
.
value
(
)
1
.
5
)
;
}
{
test
:
:
ScopedFieldTrials
field_trial
(
"
WebRTC
-
Audio
-
NetEqDelayHistogram
/
Enabled
-
96
-
0
.
998
-
0
.
5
/
"
)
;
RecreateDelayManager
(
)
;
EXPECT_FALSE
(
dm_
-
>
histogram
(
)
-
>
start_forget_weight_for_testing
(
)
)
;
}
}
TEST_F
(
DelayManagerTest
RelativeArrivalDelay
)
{
use_mock_histogram_
=
true
;
RecreateDelayManager
(
)
;
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
kFrameSizeMs
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
0
)
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
2
*
kFrameSizeMs
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
1
)
)
;
dm_
-
>
Update
(
seq_no_
ts_
kFs
)
;
IncreaseTime
(
2
*
kFrameSizeMs
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
2
)
)
;
dm_
-
>
Update
(
seq_no_
+
1
ts_
+
kTsIncrement
kFs
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
1
)
)
;
dm_
-
>
Update
(
seq_no_
ts_
kFs
)
;
}
TEST_F
(
DelayManagerTest
MaxDelayHistory
)
{
use_mock_histogram_
=
true
;
RecreateDelayManager
(
)
;
SetPacketAudioLength
(
kFrameSizeMs
)
;
InsertNextPacket
(
)
;
IncreaseTime
(
2
*
kFrameSizeMs
)
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
1
)
)
;
InsertNextPacket
(
)
;
constexpr
int
kMaxHistoryMs
=
2000
;
IncreaseTime
(
kMaxHistoryMs
+
kFrameSizeMs
)
;
ts_
+
=
kFs
*
kMaxHistoryMs
/
1000
;
EXPECT_CALL
(
*
mock_histogram_
Add
(
0
)
)
;
dm_
-
>
Update
(
seq_no_
ts_
kFs
)
;
}
TEST_F
(
DelayManagerTest
RelativeArrivalDelayStatistic
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
EXPECT_EQ
(
absl
:
:
nullopt
InsertNextPacket
(
)
)
;
IncreaseTime
(
kFrameSizeMs
)
;
EXPECT_EQ
(
0
InsertNextPacket
(
)
)
;
IncreaseTime
(
2
*
kFrameSizeMs
)
;
EXPECT_EQ
(
20
InsertNextPacket
(
)
)
;
}
TEST_F
(
DelayManagerTest
DecelerationTargetLevelOffset
)
{
SetPacketAudioLength
(
kFrameSizeMs
)
;
constexpr
int
kDecelerationTargetLevelOffsetMs
=
85
<
<
8
;
constexpr
int
kBoarderTargetLevel
=
kDecelerationTargetLevelOffsetMs
*
4
;
{
const
int
target_level_ms
=
kBoarderTargetLevel
/
kFrameSizeMs
-
1
;
int
lower
higher
;
dm_
-
>
BufferLimits
(
target_level_ms
&
lower
&
higher
)
;
EXPECT_EQ
(
target_level_ms
*
3
/
4
lower
)
;
EXPECT_EQ
(
target_level_ms
higher
)
;
}
{
const
int
target_level_ms
=
kBoarderTargetLevel
/
kFrameSizeMs
+
1
;
int
lower
higher
;
dm_
-
>
BufferLimits
(
target_level_ms
&
lower
&
higher
)
;
EXPECT_EQ
(
target_level_ms
-
kDecelerationTargetLevelOffsetMs
/
kFrameSizeMs
lower
)
;
EXPECT_EQ
(
target_level_ms
higher
)
;
}
}
}
