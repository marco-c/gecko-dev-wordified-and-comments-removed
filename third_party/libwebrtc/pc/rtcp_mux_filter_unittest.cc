#
include
"
pc
/
rtcp_mux_filter
.
h
"
#
include
"
pc
/
session_description
.
h
"
#
include
"
test
/
gtest
.
h
"
TEST
(
RtcpMuxFilterTest
IsActiveSender
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
filter
.
SetOffer
(
true
webrtc
:
:
CS_LOCAL
)
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
filter
.
SetAnswer
(
true
webrtc
:
:
CS_REMOTE
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
IsFullyActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
ReceivePrAnswer
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
filter
.
SetOffer
(
true
webrtc
:
:
CS_LOCAL
)
;
EXPECT_TRUE
(
filter
.
SetProvisionalAnswer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetProvisionalAnswer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
IsFullyActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
IsActiveReceiver
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
filter
.
SetAnswer
(
true
webrtc
:
:
CS_LOCAL
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
IsFullyActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
SendPrAnswer
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
;
EXPECT_TRUE
(
filter
.
SetProvisionalAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetProvisionalAnswer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsFullyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
IsProvisionallyActive
(
)
)
;
EXPECT_TRUE
(
filter
.
IsFullyActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
EnableFilterDuringUpdate
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetOffer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
SetOffer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_FALSE
(
filter
.
SetAnswer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
SetOfferTwice
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
EXPECT_TRUE
(
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
webrtc
:
:
RtcpMuxFilter
filter2
;
EXPECT_TRUE
(
filter2
.
SetOffer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter2
.
SetOffer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter2
.
SetAnswer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_FALSE
(
filter2
.
IsActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
EnableFilterTwiceDuringUpdate
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
EXPECT_TRUE
(
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
KeepFilterDisabledDuringUpdate
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
EXPECT_TRUE
(
filter
.
SetOffer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetOffer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_FALSE
(
filter
.
IsActive
(
)
)
;
}
TEST
(
RtcpMuxFilterTest
SetActiveCantDeactivate
)
{
webrtc
:
:
RtcpMuxFilter
filter
;
filter
.
SetActive
(
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
SetOffer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetOffer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
SetProvisionalAnswer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetProvisionalAnswer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
SetAnswer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
SetOffer
(
false
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetOffer
(
true
webrtc
:
:
CS_REMOTE
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
SetProvisionalAnswer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetProvisionalAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_FALSE
(
filter
.
SetAnswer
(
false
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
EXPECT_TRUE
(
filter
.
SetAnswer
(
true
webrtc
:
:
CS_LOCAL
)
)
;
EXPECT_TRUE
(
filter
.
IsActive
(
)
)
;
}
