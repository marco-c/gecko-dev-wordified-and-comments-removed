#
include
<
stdint
.
h
>
#
include
<
algorithm
>
#
include
<
memory
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
absl
/
types
/
optional
.
h
"
#
include
"
api
/
data_channel_interface
.
h
"
#
include
"
api
/
dtmf_sender_interface
.
h
"
#
include
"
api
/
peer_connection_interface
.
h
"
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
pc
/
test
/
integration_test_helpers
.
h
"
#
include
"
pc
/
test
/
mock_peer_connection_observers
.
h
"
#
include
"
rtc_base
/
fake_clock
.
h
"
#
include
"
rtc_base
/
gunit
.
h
"
#
include
"
rtc_base
/
ref_counted_object
.
h
"
#
include
"
rtc_base
/
virtual_socket_server
.
h
"
namespace
webrtc
{
namespace
{
class
DataChannelIntegrationTest
:
public
PeerConnectionIntegrationBaseTest
public
:
:
testing
:
:
WithParamInterface
<
SdpSemantics
>
{
protected
:
DataChannelIntegrationTest
(
)
:
PeerConnectionIntegrationBaseTest
(
GetParam
(
)
)
{
}
}
;
GTEST_ALLOW_UNINSTANTIATED_PARAMETERIZED_TEST
(
DataChannelIntegrationTest
)
;
class
FakeClockForTest
:
public
rtc
:
:
ScopedFakeClock
{
protected
:
FakeClockForTest
(
)
{
AdvanceTime
(
webrtc
:
:
TimeDelta
:
:
Seconds
(
1
)
)
;
}
ScopedFakeClock
&
FakeClock
(
)
{
return
*
this
;
}
}
;
class
DataChannelIntegrationTestWithFakeClock
:
public
FakeClockForTest
public
DataChannelIntegrationTest
{
}
;
class
DataChannelIntegrationTestPlanB
:
public
PeerConnectionIntegrationBaseTest
{
protected
:
DataChannelIntegrationTestPlanB
(
)
:
PeerConnectionIntegrationBaseTest
(
SdpSemantics
:
:
kPlanB
)
{
}
}
;
GTEST_ALLOW_UNINSTANTIATED_PARAMETERIZED_TEST
(
DataChannelIntegrationTestWithFakeClock
)
;
class
DataChannelIntegrationTestUnifiedPlan
:
public
PeerConnectionIntegrationBaseTest
{
protected
:
DataChannelIntegrationTestUnifiedPlan
(
)
:
PeerConnectionIntegrationBaseTest
(
SdpSemantics
:
:
kUnifiedPlan
)
{
}
}
;
#
ifdef
WEBRTC_HAVE_SCTP
TEST_P
(
DataChannelIntegrationTest
DataChannelWhileDisconnected
)
{
CreatePeerConnectionWrappers
(
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
kDefaultTimeout
)
;
std
:
:
string
data1
=
"
hello
first
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data1
)
)
;
EXPECT_EQ_WAIT
(
data1
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
virtual_socket_server
(
)
-
>
set_drop_probability
(
1
.
0
)
;
EXPECT_EQ_WAIT
(
PeerConnectionInterface
:
:
kIceConnectionDisconnected
caller
(
)
-
>
standardized_ice_connection_state
(
)
kDefaultTimeout
)
;
std
:
:
string
data2
=
"
hello
second
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data2
)
)
;
virtual_socket_server
(
)
-
>
set_drop_probability
(
0
.
0
)
;
EXPECT_EQ_WAIT
(
data2
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
TEST_P
(
DataChannelIntegrationTest
DataChannelWhileDisconnectedIceRestart
)
{
CreatePeerConnectionWrappers
(
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
kDefaultTimeout
)
;
std
:
:
string
data1
=
"
hello
first
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data1
)
)
;
EXPECT_EQ_WAIT
(
data1
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
virtual_socket_server
(
)
-
>
set_drop_probability
(
1
.
0
)
;
ASSERT_EQ_WAIT
(
PeerConnectionInterface
:
:
kIceConnectionDisconnected
caller
(
)
-
>
standardized_ice_connection_state
(
)
kDefaultTimeout
)
;
std
:
:
string
data2
=
"
hello
second
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data2
)
)
;
caller
(
)
-
>
SetOfferAnswerOptions
(
IceRestartOfferAnswerOptions
(
)
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
virtual_socket_server
(
)
-
>
set_drop_probability
(
0
.
0
)
;
EXPECT_EQ_WAIT
(
data2
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
#
endif
TEST_P
(
DataChannelIntegrationTest
EndToEndCallWithRtpDataChannel
)
{
PeerConnectionInterface
:
:
RTCConfiguration
rtc_config
;
rtc_config
.
enable_rtp_data_channel
=
true
;
rtc_config
.
enable_dtls_srtp
=
false
;
ASSERT_TRUE
(
CreatePeerConnectionWrappersWithConfig
(
rtc_config
rtc_config
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
MediaExpectations
media_expectations
;
media_expectations
.
ExpectBidirectionalAudioAndVideo
(
)
;
ASSERT_TRUE
(
ExpectNewFrames
(
media_expectations
)
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_NE
(
nullptr
callee
(
)
-
>
data_channel
(
)
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
std
:
:
string
data
=
"
hello
world
"
;
SendRtpDataWithRetries
(
caller
(
)
-
>
data_channel
(
)
data
5
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
SendRtpDataWithRetries
(
callee
(
)
-
>
data_channel
(
)
data
5
)
;
EXPECT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
TEST_P
(
DataChannelIntegrationTest
RtpDataChannelWorksAfterRollback
)
{
PeerConnectionInterface
:
:
RTCConfiguration
rtc_config
;
rtc_config
.
enable_rtp_data_channel
=
true
;
rtc_config
.
enable_dtls_srtp
=
false
;
ASSERT_TRUE
(
CreatePeerConnectionWrappersWithConfig
(
rtc_config
rtc_config
)
)
;
ConnectFakeSignaling
(
)
;
auto
data_channel
=
caller
(
)
-
>
pc
(
)
-
>
CreateDataChannel
(
"
label_1
"
nullptr
)
;
ASSERT_TRUE
(
data_channel
.
get
(
)
!
=
nullptr
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
caller
(
)
-
>
CreateDataChannel
(
"
label_2
"
nullptr
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
observer
(
new
rtc
:
:
RefCountedObject
<
MockSetSessionDescriptionObserver
>
(
)
)
;
caller
(
)
-
>
pc
(
)
-
>
SetLocalDescription
(
observer
caller
(
)
-
>
CreateOfferAndWait
(
)
.
release
(
)
)
;
EXPECT_TRUE_WAIT
(
observer
-
>
called
(
)
kDefaultTimeout
)
;
caller
(
)
-
>
Rollback
(
)
;
std
:
:
string
data
=
"
hello
world
"
;
SendRtpDataWithRetries
(
data_channel
data
5
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
TEST_P
(
DataChannelIntegrationTest
RtpDataChannelSignaledClosedInCalleeOffer
)
{
PeerConnectionInterface
:
:
RTCConfiguration
rtc_config
;
rtc_config
.
enable_rtp_data_channel
=
true
;
rtc_config
.
enable_dtls_srtp
=
false
;
ASSERT_TRUE
(
CreatePeerConnectionWrappersWithConfig
(
rtc_config
rtc_config
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_NE
(
nullptr
callee
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Close
(
)
;
callee
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
EXPECT_FALSE
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
)
;
EXPECT_FALSE
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
)
;
}
#
if
!
defined
(
THREAD_SANITIZER
)
TEST_P
(
DataChannelIntegrationTestWithFakeClock
DataBufferedUntilRtpDataChannelObserverRegistered
)
{
virtual_socket_server
(
)
-
>
set_delay_mean
(
5
)
;
virtual_socket_server
(
)
-
>
UpdateDelayDistribution
(
)
;
PeerConnectionInterface
:
:
RTCConfiguration
rtc_config
;
rtc_config
.
enable_rtp_data_channel
=
true
;
rtc_config
.
enable_dtls_srtp
=
false
;
ASSERT_TRUE
(
CreatePeerConnectionWrappersWithConfig
(
rtc_config
rtc_config
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE
(
caller
(
)
-
>
data_channel
(
)
!
=
nullptr
)
;
ASSERT_TRUE_SIMULATED_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
FakeClock
(
)
)
;
ASSERT_TRUE_SIMULATED_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
FakeClock
(
)
)
;
ASSERT_EQ_SIMULATED_WAIT
(
DataChannelInterface
:
:
kOpen
callee
(
)
-
>
data_channel
(
)
-
>
state
(
)
kDefaultTimeout
FakeClock
(
)
)
;
callee
(
)
-
>
data_channel
(
)
-
>
UnregisterObserver
(
)
;
std
:
:
string
data
=
"
hello
world
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
SIMULATED_WAIT
(
false
50
FakeClock
(
)
)
;
MockDataChannelObserver
new_observer
(
callee
(
)
-
>
data_channel
(
)
)
;
EXPECT_EQ_SIMULATED_WAIT
(
data
new_observer
.
last_message
(
)
kDefaultTimeout
FakeClock
(
)
)
;
}
#
endif
TEST_P
(
DataChannelIntegrationTest
RtpDataChannelsRejectedByCallee
)
{
PeerConnectionInterface
:
:
RTCConfiguration
rtc_config_1
;
rtc_config_1
.
enable_rtp_data_channel
=
true
;
rtc_config_1
.
enable_dtls_srtp
=
false
;
PeerConnectionInterface
:
:
RTCConfiguration
rtc_config_2
;
rtc_config_2
.
enable_dtls_srtp
=
false
;
rtc_config_2
.
enable_dtls_srtp
=
false
;
ASSERT_TRUE
(
CreatePeerConnectionWrappersWithConfig
(
rtc_config_1
rtc_config_2
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
ASSERT_TRUE
(
caller
(
)
-
>
data_channel
(
)
!
=
nullptr
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
EXPECT_TRUE
(
caller
(
)
-
>
data_channel
(
)
!
=
nullptr
)
;
EXPECT_FALSE
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
)
;
EXPECT_EQ
(
nullptr
callee
(
)
-
>
data_channel
(
)
)
;
}
TEST_P
(
DataChannelIntegrationTest
AddRtpDataChannelInSubsequentOffer
)
{
PeerConnectionInterface
:
:
RTCConfiguration
rtc_config
;
rtc_config
.
enable_rtp_data_channel
=
true
;
rtc_config
.
enable_dtls_srtp
=
false
;
ASSERT_TRUE
(
CreatePeerConnectionWrappersWithConfig
(
rtc_config
rtc_config
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_NE
(
nullptr
callee
(
)
-
>
data_channel
(
)
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
std
:
:
string
data
=
"
hello
world
"
;
SendRtpDataWithRetries
(
caller
(
)
-
>
data_channel
(
)
data
5
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
SendRtpDataWithRetries
(
callee
(
)
-
>
data_channel
(
)
data
5
)
;
EXPECT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
#
ifdef
WEBRTC_HAVE_SCTP
TEST_P
(
DataChannelIntegrationTest
EndToEndCallWithSctpDataChannel
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
MediaExpectations
media_expectations
;
media_expectations
.
ExpectBidirectionalAudioAndVideo
(
)
;
ASSERT_TRUE
(
ExpectNewFrames
(
media_expectations
)
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
std
:
:
string
data
=
"
hello
world
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
TEST_P
(
DataChannelIntegrationTest
EndToEndCallWithSctpDataChannelVariousSizes
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
for
(
int
message_size
=
1
;
message_size
<
100000
;
message_size
*
=
2
)
{
std
:
:
string
data
(
message_size
'
a
'
)
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
for
(
int
message_size
=
1100
;
message_size
<
1300
;
message_size
+
=
1
)
{
std
:
:
string
data
(
message_size
'
a
'
)
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
}
TEST_P
(
DataChannelIntegrationTest
EndToEndCallWithSctpDataChannelLowestSafeMtu
)
{
const
size_t
kLowestSafePayloadSizeLimit
=
1225
;
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
virtual_socket_server
(
)
-
>
set_max_udp_payload
(
kLowestSafePayloadSizeLimit
)
;
for
(
int
message_size
=
1140
;
message_size
<
1240
;
message_size
+
=
1
)
{
std
:
:
string
data
(
message_size
'
a
'
)
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
ASSERT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
ASSERT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
}
TEST_P
(
DataChannelIntegrationTest
EndToEndCallWithSctpDataChannelHarmfulMtu
)
{
const
size_t
kLowestSafePayloadSizeLimit
=
1225
;
const
size_t
kMessageSizeThatIsNotDelivered
=
1157
;
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
virtual_socket_server
(
)
-
>
set_max_udp_payload
(
kLowestSafePayloadSizeLimit
-
1
)
;
bool
failure_seen
=
false
;
for
(
size_t
message_size
=
1110
;
message_size
<
1400
;
message_size
+
+
)
{
const
size_t
message_count
=
callee
(
)
-
>
data_observer
(
)
-
>
received_message_count
(
)
;
const
std
:
:
string
data
(
message_size
'
a
'
)
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
received_message_count
(
)
>
message_count
100
)
;
if
(
callee
(
)
-
>
data_observer
(
)
-
>
received_message_count
(
)
=
=
message_count
)
{
ASSERT_EQ
(
kMessageSizeThatIsNotDelivered
message_size
)
;
failure_seen
=
true
;
break
;
}
}
ASSERT_TRUE
(
failure_seen
)
;
}
TEST_P
(
DataChannelIntegrationTest
CalleeClosesSctpDataChannel
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Close
(
)
;
EXPECT_TRUE_WAIT
(
!
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
!
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
}
TEST_P
(
DataChannelIntegrationTest
SctpDataChannelConfigSentToOtherSide
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
webrtc
:
:
DataChannelInit
init
;
init
.
id
=
53
;
init
.
maxRetransmits
=
52
;
caller
(
)
-
>
CreateDataChannel
(
"
data
-
channel
"
&
init
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_NE
(
init
.
id
callee
(
)
-
>
data_channel
(
)
-
>
id
(
)
)
;
EXPECT_EQ
(
"
data
-
channel
"
callee
(
)
-
>
data_channel
(
)
-
>
label
(
)
)
;
EXPECT_EQ
(
init
.
maxRetransmits
callee
(
)
-
>
data_channel
(
)
-
>
maxRetransmits
(
)
)
;
EXPECT_FALSE
(
callee
(
)
-
>
data_channel
(
)
-
>
negotiated
(
)
)
;
}
TEST_P
(
DataChannelIntegrationTest
StressTestUnorderedSctpDataChannel
)
{
virtual_socket_server
(
)
-
>
set_delay_mean
(
20
)
;
virtual_socket_server
(
)
-
>
set_delay_stddev
(
5
)
;
virtual_socket_server
(
)
-
>
UpdateDelayDistribution
(
)
;
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
webrtc
:
:
DataChannelInit
init
;
init
.
ordered
=
false
;
caller
(
)
-
>
CreateDataChannel
(
&
init
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
static
constexpr
int
kNumMessages
=
100
;
static
constexpr
size_t
kMaxMessageSize
=
4096
;
std
:
:
vector
<
std
:
:
string
>
sent_messages
;
for
(
int
i
=
0
;
i
<
kNumMessages
;
+
+
i
)
{
size_t
length
=
(
rand
(
)
%
kMaxMessageSize
)
+
1
;
std
:
:
string
message
;
ASSERT_TRUE
(
rtc
:
:
CreateRandomString
(
length
&
message
)
)
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
message
)
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
message
)
)
;
sent_messages
.
push_back
(
message
)
;
}
EXPECT_EQ_WAIT
(
rtc
:
:
checked_cast
<
size_t
>
(
kNumMessages
)
caller
(
)
-
>
data_observer
(
)
-
>
received_message_count
(
)
kDefaultTimeout
)
;
EXPECT_EQ_WAIT
(
rtc
:
:
checked_cast
<
size_t
>
(
kNumMessages
)
callee
(
)
-
>
data_observer
(
)
-
>
received_message_count
(
)
kDefaultTimeout
)
;
std
:
:
vector
<
std
:
:
string
>
caller_received_messages
=
caller
(
)
-
>
data_observer
(
)
-
>
messages
(
)
;
std
:
:
vector
<
std
:
:
string
>
callee_received_messages
=
callee
(
)
-
>
data_observer
(
)
-
>
messages
(
)
;
absl
:
:
c_sort
(
sent_messages
)
;
absl
:
:
c_sort
(
caller_received_messages
)
;
absl
:
:
c_sort
(
callee_received_messages
)
;
EXPECT_EQ
(
sent_messages
caller_received_messages
)
;
EXPECT_EQ
(
sent_messages
callee_received_messages
)
;
}
TEST_P
(
DataChannelIntegrationTest
AddSctpDataChannelInSubsequentOffer
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_NE
(
nullptr
caller
(
)
-
>
data_channel
(
)
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
std
:
:
string
data
=
"
hello
world
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
TEST_P
(
DataChannelIntegrationTest
SctpDataChannelToAudioVideoUpgrade
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
MediaExpectations
media_expectations
;
media_expectations
.
ExpectBidirectionalAudioAndVideo
(
)
;
ASSERT_TRUE
(
ExpectNewFrames
(
media_expectations
)
)
;
}
static
void
MakeSpecCompliantSctpOffer
(
cricket
:
:
SessionDescription
*
desc
)
{
cricket
:
:
SctpDataContentDescription
*
dcd_offer
=
GetFirstSctpDataContentDescription
(
desc
)
;
ASSERT_TRUE
(
dcd_offer
)
;
dcd_offer
-
>
set_use_sctpmap
(
false
)
;
dcd_offer
-
>
set_protocol
(
"
UDP
/
DTLS
/
SCTP
"
)
;
}
TEST_P
(
DataChannelIntegrationTest
DataChannelWorksWhenSpecCompliantSctpOfferReceived
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
SetGeneratedSdpMunger
(
MakeSpecCompliantSctpOffer
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
!
=
nullptr
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
EXPECT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
std
:
:
string
data
=
"
hello
world
"
;
caller
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
callee
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Send
(
DataBuffer
(
data
)
)
;
EXPECT_EQ_WAIT
(
data
caller
(
)
-
>
data_observer
(
)
-
>
last_message
(
)
kDefaultTimeout
)
;
}
#
endif
TEST_P
(
DataChannelIntegrationTest
ClosingConnectionStopsPacketFlow
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
#
ifdef
WEBRTC_HAVE_SCTP
caller
(
)
-
>
CreateDataChannel
(
)
;
#
endif
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
MediaExpectations
media_expectations
;
media_expectations
.
CalleeExpectsSomeAudioAndVideo
(
)
;
ASSERT_TRUE
(
ExpectNewFrames
(
media_expectations
)
)
;
ClosePeerConnections
(
)
;
uint32_t
sent_packets_a
=
virtual_socket_server
(
)
-
>
sent_packets
(
)
;
WAIT
(
false
1000
)
;
uint32_t
sent_packets_b
=
virtual_socket_server
(
)
-
>
sent_packets
(
)
;
EXPECT_EQ
(
sent_packets_a
sent_packets_b
)
;
}
#
ifdef
WEBRTC_HAVE_SCTP
TEST_P
(
DataChannelIntegrationTest
TransportStatsReportedForDataChannelOnlyConnection
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
kDefaultTimeout
)
;
auto
caller_report
=
caller
(
)
-
>
NewGetStats
(
)
;
EXPECT_EQ
(
1u
caller_report
-
>
GetStatsOfType
<
RTCTransportStats
>
(
)
.
size
(
)
)
;
auto
callee_report
=
callee
(
)
-
>
NewGetStats
(
)
;
EXPECT_EQ
(
1u
callee_report
-
>
GetStatsOfType
<
RTCTransportStats
>
(
)
.
size
(
)
)
;
}
INSTANTIATE_TEST_SUITE_P
(
DataChannelIntegrationTest
DataChannelIntegrationTest
Values
(
SdpSemantics
:
:
kPlanB
SdpSemantics
:
:
kUnifiedPlan
)
)
;
INSTANTIATE_TEST_SUITE_P
(
DataChannelIntegrationTest
DataChannelIntegrationTestWithFakeClock
Values
(
SdpSemantics
:
:
kPlanB
SdpSemantics
:
:
kUnifiedPlan
)
)
;
TEST_F
(
DataChannelIntegrationTestUnifiedPlan
EndToEndCallWithBundledSctpDataChannel
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
AddAudioVideoTracks
(
)
;
callee
(
)
-
>
AddAudioVideoTracks
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
network_thread
(
)
-
>
Invoke
<
void
>
(
RTC_FROM_HERE
[
this
]
{
ASSERT_EQ_WAIT
(
SctpTransportState
:
:
kConnected
caller
(
)
-
>
pc
(
)
-
>
GetSctpTransport
(
)
-
>
Information
(
)
.
state
(
)
kDefaultTimeout
)
;
}
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
}
TEST_F
(
DataChannelIntegrationTestUnifiedPlan
EndToEndCallWithDataChannelOnlyConnects
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_channel
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
ASSERT_TRUE
(
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
)
;
}
TEST_F
(
DataChannelIntegrationTestUnifiedPlan
DataChannelClosesWhenClosed
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
caller
(
)
-
>
data_channel
(
)
-
>
Close
(
)
;
ASSERT_TRUE_WAIT
(
!
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
}
TEST_F
(
DataChannelIntegrationTestUnifiedPlan
DataChannelClosesWhenClosedReverse
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
callee
(
)
-
>
data_channel
(
)
-
>
Close
(
)
;
ASSERT_TRUE_WAIT
(
!
caller
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
}
TEST_F
(
DataChannelIntegrationTestUnifiedPlan
DataChannelClosesWhenPeerConnectionClosed
)
{
ASSERT_TRUE
(
CreatePeerConnectionWrappers
(
)
)
;
ConnectFakeSignaling
(
)
;
caller
(
)
-
>
CreateDataChannel
(
)
;
caller
(
)
-
>
CreateAndSetAndSignalOffer
(
)
;
ASSERT_TRUE_WAIT
(
SignalingStateStable
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
kDefaultTimeout
)
;
ASSERT_TRUE_WAIT
(
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
caller
(
)
-
>
pc
(
)
-
>
Close
(
)
;
ASSERT_TRUE_WAIT
(
!
callee
(
)
-
>
data_observer
(
)
-
>
IsOpen
(
)
kDefaultTimeout
)
;
}
#
endif
}
}
