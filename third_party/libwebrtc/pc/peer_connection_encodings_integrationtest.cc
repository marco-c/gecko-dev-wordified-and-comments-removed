#
include
<
algorithm
>
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
iterator
>
#
include
<
memory
>
#
include
<
optional
>
#
include
<
set
>
#
include
<
string
>
#
include
<
string_view
>
#
include
<
vector
>
#
include
"
absl
/
algorithm
/
container
.
h
"
#
include
"
absl
/
strings
/
match
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
audio_codecs
/
builtin_audio_decoder_factory
.
h
"
#
include
"
api
/
audio_codecs
/
builtin_audio_encoder_factory
.
h
"
#
include
"
api
/
audio_options
.
h
"
#
include
"
api
/
field_trials_view
.
h
"
#
include
"
api
/
jsep
.
h
"
#
include
"
api
/
make_ref_counted
.
h
"
#
include
"
api
/
media_stream_interface
.
h
"
#
include
"
api
/
media_types
.
h
"
#
include
"
api
/
rtc_error
.
h
"
#
include
"
api
/
rtp_parameters
.
h
"
#
include
"
api
/
rtp_sender_interface
.
h
"
#
include
"
api
/
rtp_transceiver_direction
.
h
"
#
include
"
api
/
rtp_transceiver_interface
.
h
"
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
stats
/
rtc_stats_report
.
h
"
#
include
"
api
/
stats
/
rtcstats_objects
.
h
"
#
include
"
api
/
test
/
rtc_error_matchers
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
video
/
resolution
.
h
"
#
include
"
pc
/
sdp_utils
.
h
"
#
include
"
pc
/
session_description
.
h
"
#
include
"
pc
/
simulcast_description
.
h
"
#
include
"
pc
/
test
/
mock_peer_connection_observers
.
h
"
#
include
"
pc
/
test
/
peer_connection_test_wrapper
.
h
"
#
include
"
pc
/
test
/
simulcast_layer_util
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
gunit
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
physical_socket_server
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
scoped_key_value_config
.
h
"
#
include
"
test
/
wait_until
.
h
"
using
:
:
testing
:
:
AllOf
;
using
:
:
testing
:
:
Each
;
using
:
:
testing
:
:
Eq
;
using
:
:
testing
:
:
Field
;
using
:
:
testing
:
:
Gt
;
using
:
:
testing
:
:
Optional
;
using
:
:
testing
:
:
SizeIs
;
using
:
:
testing
:
:
StrCaseEq
;
using
:
:
testing
:
:
StrEq
;
namespace
webrtc
{
namespace
{
constexpr
TimeDelta
kDefaultTimeout
=
TimeDelta
:
:
Seconds
(
5
)
;
constexpr
TimeDelta
kLongTimeoutForRampingUp
=
TimeDelta
:
:
Minutes
(
1
)
;
constexpr
DataRate
kVp9ExpectedMaxBitrateForL1T3
=
DataRate
:
:
KilobitsPerSec
(
1500
)
;
auto
HasEncoderImplementation
(
absl
:
:
string_view
impl
)
{
return
Field
(
"
encoder_implementation
"
&
RTCOutboundRtpStreamStats
:
:
encoder_implementation
Optional
(
StrEq
(
impl
)
)
)
;
}
auto
HasNoScalabilityMode
(
)
{
return
Field
(
"
scalability_mode
"
&
RTCOutboundRtpStreamStats
:
:
scalability_mode
Eq
(
std
:
:
nullopt
)
)
;
}
auto
HasScalabilityMode
(
absl
:
:
string_view
mode
)
{
return
Field
(
"
scalability_mode
"
&
RTCOutboundRtpStreamStats
:
:
scalability_mode
Optional
(
StrEq
(
mode
)
)
)
;
}
struct
StringParamToString
{
std
:
:
string
operator
(
)
(
const
:
:
testing
:
:
TestParamInfo
<
std
:
:
string
>
&
info
)
{
return
info
.
param
;
}
}
;
std
:
:
string
GetCurrentCodecMimeType
(
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
const
RTCOutboundRtpStreamStats
&
outbound_rtp
)
{
return
outbound_rtp
.
codec_id
.
has_value
(
)
?
*
report
-
>
GetAs
<
RTCCodecStats
>
(
*
outbound_rtp
.
codec_id
)
-
>
mime_type
:
"
"
;
}
struct
RidAndResolution
{
std
:
:
string
rid
;
uint32_t
width
;
uint32_t
height
;
}
;
const
RTCOutboundRtpStreamStats
*
FindOutboundRtpByRid
(
const
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
&
outbound_rtps
const
absl
:
:
string_view
&
rid
)
{
for
(
const
auto
*
outbound_rtp
:
outbound_rtps
)
{
if
(
outbound_rtp
-
>
rid
.
has_value
(
)
&
&
*
outbound_rtp
-
>
rid
=
=
rid
)
{
return
outbound_rtp
;
}
}
return
nullptr
;
}
}
class
PeerConnectionEncodingsIntegrationTest
:
public
:
:
testing
:
:
Test
{
public
:
PeerConnectionEncodingsIntegrationTest
(
)
:
background_thread_
(
std
:
:
make_unique
<
rtc
:
:
Thread
>
(
&
pss_
)
)
{
RTC_CHECK
(
background_thread_
-
>
Start
(
)
)
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
CreatePc
(
)
{
auto
pc_wrapper
=
rtc
:
:
make_ref_counted
<
PeerConnectionTestWrapper
>
(
"
pc
"
&
pss_
background_thread_
.
get
(
)
background_thread_
.
get
(
)
field_trials_
)
;
pc_wrapper
-
>
CreatePc
(
{
}
CreateBuiltinAudioEncoderFactory
(
)
CreateBuiltinAudioDecoderFactory
(
)
)
;
return
pc_wrapper
;
}
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
AddTransceiverWithSimulcastLayers
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
init_layers
)
{
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local
-
>
GetUserMedia
(
false
cricket
:
:
AudioOptions
(
)
true
{
.
width
=
1280
.
height
=
720
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
RTCErrorOr
<
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
>
transceiver_or_error
=
local
-
>
pc
(
)
-
>
AddTransceiver
(
track
CreateTransceiverInit
(
init_layers
)
)
;
EXPECT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
return
transceiver_or_error
.
value
(
)
;
}
bool
HasReceiverVideoCodecCapability
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
absl
:
:
string_view
codec_name
)
{
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpReceiverCapabilities
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
.
codecs
;
return
std
:
:
find_if
(
codecs
.
begin
(
)
codecs
.
end
(
)
[
&
codec_name
]
(
const
RtpCodecCapability
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
codec_name
)
;
}
)
!
=
codecs
.
end
(
)
;
}
std
:
:
vector
<
RtpCodecCapability
>
GetCapabilitiesAndRestrictToCodec
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
absl
:
:
string_view
codec_name
)
{
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpReceiverCapabilities
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
.
codecs
;
codecs
.
erase
(
std
:
:
remove_if
(
codecs
.
begin
(
)
codecs
.
end
(
)
[
&
codec_name
]
(
const
RtpCodecCapability
&
codec
)
{
return
!
codec
.
IsResiliencyCodec
(
)
&
&
!
absl
:
:
EqualsIgnoreCase
(
codec
.
name
codec_name
)
;
}
)
codecs
.
end
(
)
)
;
RTC_DCHECK
(
std
:
:
find_if
(
codecs
.
begin
(
)
codecs
.
end
(
)
[
&
codec_name
]
(
const
RtpCodecCapability
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
codec_name
)
;
}
)
!
=
codecs
.
end
(
)
)
;
return
codecs
;
}
void
ExchangeIceCandidates
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
)
{
local_pc_wrapper
-
>
SignalOnIceCandidateReady
.
connect
(
remote_pc_wrapper
.
get
(
)
&
PeerConnectionTestWrapper
:
:
AddIceCandidate
)
;
remote_pc_wrapper
-
>
SignalOnIceCandidateReady
.
connect
(
local_pc_wrapper
.
get
(
)
&
PeerConnectionTestWrapper
:
:
AddIceCandidate
)
;
}
void
Negotiate
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
)
{
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
offer
=
CreateOffer
(
local_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p1
=
SetLocalDescription
(
local_pc_wrapper
offer
.
get
(
)
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p2
=
SetRemoteDescription
(
remote_pc_wrapper
offer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
answer
=
CreateAnswer
(
remote_pc_wrapper
)
;
p1
=
SetLocalDescription
(
remote_pc_wrapper
answer
.
get
(
)
)
;
p2
=
SetRemoteDescription
(
local_pc_wrapper
answer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
}
void
NegotiateWithSimulcastTweaks
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
)
{
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
offer
=
CreateOffer
(
local_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p1
=
SetLocalDescription
(
local_pc_wrapper
offer
.
get
(
)
)
;
cricket
:
:
SimulcastDescription
simulcast_description
=
RemoveSimulcast
(
offer
.
get
(
)
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p2
=
SetRemoteDescription
(
remote_pc_wrapper
offer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
answer
=
CreateAnswer
(
remote_pc_wrapper
)
;
EXPECT_TRUE
(
answer
)
;
p1
=
SetLocalDescription
(
remote_pc_wrapper
answer
.
get
(
)
)
;
cricket
:
:
MediaContentDescription
*
mcd_answer
=
answer
-
>
description
(
)
-
>
contents
(
)
[
0
]
.
media_description
(
)
;
mcd_answer
-
>
mutable_streams
(
)
.
clear
(
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
simulcast_layers
=
simulcast_description
.
send_layers
(
)
.
GetAllLayers
(
)
;
cricket
:
:
SimulcastLayerList
&
receive_layers
=
mcd_answer
-
>
simulcast_description
(
)
.
receive_layers
(
)
;
for
(
const
auto
&
layer
:
simulcast_layers
)
{
receive_layers
.
AddLayer
(
layer
)
;
}
p2
=
SetRemoteDescription
(
local_pc_wrapper
answer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
}
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
GetStats
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
)
{
auto
callback
=
rtc
:
:
make_ref_counted
<
MockRTCStatsCollectorCallback
>
(
)
;
pc_wrapper
-
>
pc
(
)
-
>
GetStats
(
callback
.
get
(
)
)
;
EXPECT_TRUE_WAIT
(
callback
-
>
called
(
)
kDefaultTimeout
.
ms
(
)
)
;
return
callback
-
>
report
(
)
;
}
bool
IsCodecIdDifferent
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
size_t
index
const
std
:
:
string
&
codec_id
)
{
return
IsCodecIdDifferentWithScalabilityMode
(
pc_wrapper
index
codec_id
std
:
:
nullopt
)
;
}
bool
IsCodecIdDifferentWithScalabilityMode
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
size_t
index
const
std
:
:
string
&
codec_id
std
:
:
optional
<
std
:
:
string
>
wanted_scalability_mode
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
return
outbound_rtps
[
index
]
-
>
codec_id
.
value
(
)
!
=
codec_id
&
&
(
!
wanted_scalability_mode
|
|
(
outbound_rtps
[
index
]
-
>
scalability_mode
.
has_value
(
)
&
&
outbound_rtps
[
index
]
-
>
scalability_mode
.
value
(
)
=
=
wanted_scalability_mode
)
)
;
}
bool
HasOutboundRtpBytesSent
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
size_t
num_layers
)
{
return
HasOutboundRtpBytesSent
(
pc_wrapper
num_layers
num_layers
)
;
}
bool
HasOutboundRtpBytesSent
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
size_t
num_layers
size_t
num_active_layers
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
if
(
outbound_rtps
.
size
(
)
!
=
num_layers
)
{
return
false
;
}
size_t
num_sending_layers
=
0
;
for
(
const
auto
*
outbound_rtp
:
outbound_rtps
)
{
if
(
outbound_rtp
-
>
bytes_sent
.
has_value
(
)
&
&
*
outbound_rtp
-
>
bytes_sent
>
0u
)
{
+
+
num_sending_layers
;
}
}
return
num_sending_layers
=
=
num_active_layers
;
}
int
EncodedFrames
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
std
:
:
string_view
rid
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
for
(
const
auto
*
outbound_rtp
:
outbound_rtps
)
{
if
(
outbound_rtp
-
>
rid
.
value_or
(
"
"
)
=
=
rid
)
{
return
outbound_rtp
-
>
frames_encoded
.
value_or
(
0
)
;
}
}
return
0
;
}
bool
EncodingIsActive
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
std
:
:
string_view
rid
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
for
(
const
auto
*
outbound_rtp
:
outbound_rtps
)
{
if
(
outbound_rtp
-
>
rid
.
value_or
(
"
"
)
=
=
rid
)
{
return
*
outbound_rtp
-
>
active
;
}
}
RTC_CHECK
(
false
)
<
<
"
Rid
not
found
:
"
<
<
rid
;
return
false
;
}
std
:
:
string
GetEncoderImplementationName
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
for
(
const
auto
*
outbound_rtp
:
outbound_rtps
)
{
if
(
outbound_rtp
-
>
encoder_implementation
.
has_value
(
)
)
{
return
*
outbound_rtp
-
>
encoder_implementation
;
}
}
return
"
unknown
"
;
}
Resolution
GetEncodingResolution
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
std
:
:
string_view
rid
=
"
"
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
for
(
const
auto
*
outbound_rtp
:
outbound_rtps
)
{
if
(
outbound_rtp
-
>
rid
.
value_or
(
"
"
)
=
=
rid
)
{
return
{
.
width
=
static_cast
<
int
>
(
outbound_rtp
-
>
frame_width
.
value_or
(
0
)
)
.
height
=
static_cast
<
int
>
(
outbound_rtp
-
>
frame_height
.
value_or
(
0
)
)
}
;
}
}
RTC_CHECK
(
false
)
<
<
"
Rid
not
found
:
"
<
<
rid
;
return
{
}
;
}
bool
HasOutboundRtpWithRidAndScalabilityMode
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
absl
:
:
string_view
rid
absl
:
:
string_view
expected_scalability_mode
uint32_t
frame_height
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
auto
*
outbound_rtp
=
FindOutboundRtpByRid
(
outbound_rtps
rid
)
;
if
(
!
outbound_rtp
|
|
!
outbound_rtp
-
>
scalability_mode
.
has_value
(
)
|
|
*
outbound_rtp
-
>
scalability_mode
!
=
expected_scalability_mode
)
{
RTC_LOG
(
LS_INFO
)
<
<
"
Waiting
for
scalability
mode
(
"
<
<
(
outbound_rtp
?
outbound_rtp
-
>
scalability_mode
.
value_or
(
"
nullopt
"
)
:
"
not
found
"
)
<
<
"
)
to
be
"
<
<
expected_scalability_mode
;
rtc
:
:
Thread
:
:
Current
(
)
-
>
SleepMs
(
1000
)
;
return
false
;
}
if
(
outbound_rtp
-
>
frame_height
.
has_value
(
)
)
{
RTC_LOG
(
LS_INFO
)
<
<
"
Waiting
for
target
resolution
(
"
<
<
frame_height
<
<
"
p
)
.
Currently
at
"
<
<
*
outbound_rtp
-
>
frame_height
<
<
"
p
.
.
.
"
;
}
else
{
RTC_LOG
(
LS_INFO
)
<
<
"
Waiting
for
target
resolution
.
No
frames
encoded
yet
.
.
.
"
;
}
if
(
!
outbound_rtp
-
>
frame_height
.
has_value
(
)
|
|
*
outbound_rtp
-
>
frame_height
!
=
frame_height
)
{
rtc
:
:
Thread
:
:
Current
(
)
-
>
SleepMs
(
1000
)
;
return
false
;
}
return
true
;
}
bool
OutboundRtpResolutionsAreLessThanOrEqualToExpectations
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
std
:
:
vector
<
RidAndResolution
>
resolutions
)
{
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
for
(
const
RidAndResolution
&
resolution
:
resolutions
)
{
const
RTCOutboundRtpStreamStats
*
outbound_rtp
=
nullptr
;
if
(
!
resolution
.
rid
.
empty
(
)
)
{
outbound_rtp
=
FindOutboundRtpByRid
(
outbound_rtps
resolution
.
rid
)
;
}
else
if
(
outbound_rtps
.
size
(
)
=
=
1u
)
{
outbound_rtp
=
outbound_rtps
[
0
]
;
}
if
(
!
outbound_rtp
|
|
!
outbound_rtp
-
>
frame_width
.
has_value
(
)
|
|
!
outbound_rtp
-
>
frame_height
.
has_value
(
)
)
{
RTC_LOG
(
LS_ERROR
)
<
<
"
rid
=
"
<
<
resolution
.
rid
<
<
"
does
not
have
"
<
<
"
resolution
metrics
"
;
return
false
;
}
if
(
*
outbound_rtp
-
>
frame_width
>
resolution
.
width
|
|
*
outbound_rtp
-
>
frame_height
>
resolution
.
height
)
{
RTC_LOG
(
LS_ERROR
)
<
<
"
rid
=
"
<
<
resolution
.
rid
<
<
"
is
"
<
<
*
outbound_rtp
-
>
frame_width
<
<
"
x
"
<
<
*
outbound_rtp
-
>
frame_height
<
<
"
this
is
greater
than
the
"
<
<
"
expected
"
<
<
resolution
.
width
<
<
"
x
"
<
<
resolution
.
height
;
return
false
;
}
}
return
true
;
}
protected
:
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
CreateOffer
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
)
{
auto
observer
=
rtc
:
:
make_ref_counted
<
MockCreateSessionDescriptionObserver
>
(
)
;
pc_wrapper
-
>
pc
(
)
-
>
CreateOffer
(
observer
.
get
(
)
{
}
)
;
EXPECT_EQ_WAIT
(
true
observer
-
>
called
(
)
kDefaultTimeout
.
ms
(
)
)
;
return
observer
-
>
MoveDescription
(
)
;
}
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
CreateAnswer
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
)
{
auto
observer
=
rtc
:
:
make_ref_counted
<
MockCreateSessionDescriptionObserver
>
(
)
;
pc_wrapper
-
>
pc
(
)
-
>
CreateAnswer
(
observer
.
get
(
)
{
}
)
;
EXPECT_EQ_WAIT
(
true
observer
-
>
called
(
)
kDefaultTimeout
.
ms
(
)
)
;
return
observer
-
>
MoveDescription
(
)
;
}
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
SetLocalDescription
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
SessionDescriptionInterface
*
sdp
)
{
auto
observer
=
rtc
:
:
make_ref_counted
<
MockSetSessionDescriptionObserver
>
(
)
;
pc_wrapper
-
>
pc
(
)
-
>
SetLocalDescription
(
observer
.
get
(
)
CloneSessionDescription
(
sdp
)
.
release
(
)
)
;
return
observer
;
}
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
SetRemoteDescription
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
SessionDescriptionInterface
*
sdp
)
{
auto
observer
=
rtc
:
:
make_ref_counted
<
MockSetSessionDescriptionObserver
>
(
)
;
pc_wrapper
-
>
pc
(
)
-
>
SetRemoteDescription
(
observer
.
get
(
)
CloneSessionDescription
(
sdp
)
.
release
(
)
)
;
return
observer
;
}
bool
Await
(
std
:
:
vector
<
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
>
observers
)
{
for
(
auto
&
observer
:
observers
)
{
EXPECT_EQ_WAIT
(
true
observer
-
>
called
(
)
kDefaultTimeout
.
ms
(
)
)
;
if
(
!
observer
-
>
result
(
)
)
{
return
false
;
}
}
return
true
;
}
test
:
:
ScopedKeyValueConfig
field_trials_
;
rtc
:
:
PhysicalSocketServer
pss_
;
std
:
:
unique_ptr
<
rtc
:
:
Thread
>
background_thread_
;
}
;
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP8_SingleEncodingDefaultsToL1T1
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP8
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
1u
)
kDefaultTimeout
.
ms
(
)
)
;
EXPECT_TRUE
(
OutboundRtpResolutionsAreLessThanOrEqualToExpectations
(
local_pc_wrapper
{
{
"
"
1280
720
}
}
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
1u
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
StrCaseEq
(
"
video
/
VP8
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
0
]
-
>
scalability_mode
StrEq
(
"
L1T1
"
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP8_RejectsSvcAndDefaultsToL1T1
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
local_pc_wrapper
"
VP8
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
EXPECT_FALSE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Eq
(
std
:
:
nullopt
)
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
1u
)
kDefaultTimeout
.
ms
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
1u
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
StrCaseEq
(
"
video
/
VP8
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
0
]
-
>
scalability_mode
StrEq
(
"
L1T1
"
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Eq
(
std
:
:
nullopt
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersWithScalabilityModeNotSupportedBySubsequentNegotiation
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
local_pc_wrapper
"
VP8
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Eq
(
"
L1T2
"
)
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
1u
)
kDefaultTimeout
.
ms
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
1u
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
StrCaseEq
(
"
video
/
VP8
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
0
]
-
>
scalability_mode
StrEq
(
"
L1T2
"
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Eq
(
"
L1T2
"
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP8_FallbackFromSvcResultsInL1T2
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
.
codecs
;
EXPECT_THAT
(
codecs
[
0
]
.
name
StrCaseEq
(
"
VP8
"
)
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L3T3_KEY
"
)
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L1T2
"
)
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
1u
)
kDefaultTimeout
.
ms
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
1u
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
StrCaseEq
(
"
video
/
VP8
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
0
]
-
>
scalability_mode
StrEq
(
"
L1T2
"
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
EXPECT_FALSE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_LegacySvcWhenScalabilityModeNotSpecified
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
1u
)
kDefaultTimeout
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
f
"
"
L3T3_KEY
"
720
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
std
:
:
vector
<
RtpEncodingParameters
>
encodings
=
sender
-
>
GetParameters
(
)
.
encodings
;
ASSERT_EQ
(
encodings
.
size
(
)
3u
)
;
EXPECT_FALSE
(
encodings
[
0
]
.
scalability_mode
.
has_value
(
)
)
;
EXPECT_FALSE
(
encodings
[
1
]
.
scalability_mode
.
has_value
(
)
)
;
EXPECT_FALSE
(
encodings
[
2
]
.
scalability_mode
.
has_value
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_StandardSvcWithOnlyOneEncoding
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
1u
)
kDefaultTimeout
.
ms
(
)
)
;
EXPECT_TRUE
(
OutboundRtpResolutionsAreLessThanOrEqualToExpectations
(
local_pc_wrapper
{
{
"
"
1280
720
}
}
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
1u
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
StrCaseEq
(
"
video
/
VP9
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
0
]
-
>
scalability_mode
StrEq
(
"
L3T3_KEY
"
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
1u
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L3T3_KEY
"
)
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_StandardSvcWithSingleActiveEncoding
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
active
=
false
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
1u
)
kDefaultTimeout
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
f
"
"
L3T3_KEY
"
720
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L3T3_KEY
"
)
)
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
1
]
.
scalability_mode
.
has_value
(
)
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
2
]
.
scalability_mode
.
has_value
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_SwitchFromLegacySvcToStandardSingleActiveEncodingSvc
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
active
=
true
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L2T2_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
2
.
0
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
std
:
:
nullopt
;
parameters
.
encodings
[
2
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
std
:
:
nullopt
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
1u
)
kDefaultTimeout
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
f
"
"
L2T2_KEY
"
720
/
2
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L2T2_KEY
"
)
)
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
1
]
.
scalability_mode
.
has_value
(
)
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
2
]
.
scalability_mode
.
has_value
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_SimulcastDeactiveActiveLayer_StandardSvc
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
constexpr
absl
:
:
string_view
kCodec
=
"
VP9
"
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
kCodec
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
active
=
true
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
4
.
0
;
parameters
.
encodings
[
1
]
.
active
=
true
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
2
.
0
;
parameters
.
encodings
[
2
]
.
active
=
true
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
=
1
.
0
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_THAT
(
WaitUntil
(
[
&
]
{
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
GetStats
(
local_pc_wrapper
)
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
std
:
:
vector
<
size_t
>
bytes_sent
;
bytes_sent
.
reserve
(
outbound_rtps
.
size
(
)
)
;
for
(
const
auto
*
outbound_rtp
:
outbound_rtps
)
{
bytes_sent
.
push_back
(
outbound_rtp
-
>
bytes_sent
.
value_or
(
0
)
)
;
}
return
bytes_sent
;
}
AllOf
(
SizeIs
(
3
)
Each
(
Gt
(
0
)
)
)
{
.
timeout
=
kLongTimeoutForRampingUp
}
)
IsRtcOk
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
ASSERT_TRUE
(
report
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
EXPECT_THAT
(
outbound_rtps
Each
(
HasEncoderImplementation
(
"
SimulcastEncoderAdapter
(
libvpx
libvpx
libvpx
)
"
)
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
StrEq
(
"
L1T3
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
1
]
.
scalability_mode
Optional
(
StrEq
(
"
L1T1
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
2
]
.
scalability_mode
Optional
(
StrEq
(
"
L1T1
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
Eq
(
1
.
0
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
Eq
(
2
.
0
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
Eq
(
4
.
0
)
)
;
parameters
.
encodings
[
2
]
.
active
=
false
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
ASSERT_THAT
(
WaitUntil
(
[
&
]
(
)
{
return
GetStats
(
local_pc_wrapper
)
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
}
AllOf
(
Each
(
HasEncoderImplementation
(
"
SimulcastEncoderAdapter
(
libvpx
libvpx
)
"
)
)
UnorderedElementsAre
(
HasScalabilityMode
(
"
L1T3
"
)
HasScalabilityMode
(
"
L1T1
"
)
HasNoScalabilityMode
(
)
)
)
)
IsRtcOk
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_SimulcastMultiplLayersActive_StandardSvc
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
active
=
true
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
4
.
0
;
parameters
.
encodings
[
1
]
.
active
=
true
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
2
.
0
;
parameters
.
encodings
[
2
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
std
:
:
nullopt
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
2u
)
kDefaultTimeout
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
q
"
"
L1T3
"
720
/
4
)
kLongTimeoutForRampingUp
.
ms
(
)
/
2
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
h
"
"
L1T1
"
720
/
2
)
kLongTimeoutForRampingUp
.
ms
(
)
/
2
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
ASSERT_TRUE
(
report
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
EXPECT_THAT
(
outbound_rtps
Each
(
HasEncoderImplementation
(
"
SimulcastEncoderAdapter
(
libvpx
libvpx
)
"
)
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
StrEq
(
"
L1T3
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
1
]
.
scalability_mode
Optional
(
StrEq
(
"
L1T1
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
2
]
.
scalability_mode
Eq
(
std
:
:
nullopt
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_Simulcast_SwitchToLegacySvc
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
active
=
false
;
parameters
.
encodings
[
1
]
.
active
=
true
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
2
.
0
;
parameters
.
encodings
[
2
]
.
active
=
true
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
=
4
.
0
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
2u
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
q
"
"
L1T3
"
720
/
4
)
kLongTimeoutForRampingUp
.
ms
(
)
/
2
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
h
"
"
L1T1
"
720
/
2
)
kLongTimeoutForRampingUp
.
ms
(
)
/
2
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Eq
(
std
:
:
nullopt
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
1
]
.
scalability_mode
Optional
(
StrEq
(
"
L1T1
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
2
]
.
scalability_mode
Optional
(
StrEq
(
"
L1T3
"
)
)
)
;
parameters
.
encodings
[
0
]
.
active
=
true
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
std
:
:
nullopt
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
std
:
:
nullopt
;
parameters
.
encodings
[
1
]
.
active
=
true
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
std
:
:
nullopt
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
std
:
:
nullopt
;
parameters
.
encodings
[
2
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
std
:
:
nullopt
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
=
std
:
:
nullopt
;
EXPECT_TRUE
(
sender
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
f
"
"
L2T3_KEY
"
720
/
2
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_OneLayerActive_LegacySvc
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
active
=
true
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
active
=
false
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
f
"
"
L1T3
"
720
/
4
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_AllLayersInactive_LegacySvc
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
active
=
false
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
active
=
false
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
Thread
:
:
Current
(
)
-
>
SleepMs
(
1000
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
1u
)
)
;
EXPECT_EQ
(
*
outbound_rtps
[
0
]
-
>
bytes_sent
0u
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_AllLayersInactive_StandardSvc
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3_KEY
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
parameters
.
encodings
[
0
]
.
active
=
false
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
active
=
false
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
Thread
:
:
Current
(
)
-
>
SleepMs
(
1000
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
3u
)
)
;
EXPECT_EQ
(
*
outbound_rtps
[
0
]
-
>
bytes_sent
0u
)
;
EXPECT_EQ
(
*
outbound_rtps
[
1
]
-
>
bytes_sent
0u
)
;
EXPECT_EQ
(
*
outbound_rtps
[
2
]
-
>
bytes_sent
0u
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_TargetBitrate_LegacyL1T3
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
active
=
false
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
active
=
true
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
f
"
"
L1T3
"
720
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
rtc
:
:
Thread
:
:
Current
(
)
-
>
SleepMs
(
1000
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
1
)
)
;
DataRate
target_bitrate
=
DataRate
:
:
BitsPerSec
(
*
outbound_rtps
[
0
]
-
>
target_bitrate
)
;
EXPECT_LE
(
target_bitrate
.
kbps
(
)
kVp9ExpectedMaxBitrateForL1T3
.
kbps
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
VP9_TargetBitrate_StandardL1T3
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP9
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
active
=
true
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
.
0
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
active
=
false
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpWithRidAndScalabilityMode
(
local_pc_wrapper
"
f
"
"
L1T3
"
720
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
rtc
:
:
Thread
:
:
Current
(
)
-
>
SleepMs
(
1000
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
3
)
)
;
auto
*
outbound_rtp
=
FindOutboundRtpByRid
(
outbound_rtps
"
f
"
)
;
ASSERT_TRUE
(
outbound_rtp
)
;
DataRate
target_bitrate
=
DataRate
:
:
BitsPerSec
(
*
outbound_rtp
-
>
target_bitrate
)
;
EXPECT_LE
(
target_bitrate
.
kbps
(
)
kVp9ExpectedMaxBitrateForL1T3
.
kbps
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SimulcastProducesUniqueSsrcAndRtxSsrcs
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
"
VP8
"
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
3u
)
)
;
std
:
:
set
<
uint32_t
>
ssrcs
;
std
:
:
set
<
uint32_t
>
rtx_ssrcs
;
for
(
const
auto
&
outbound_rtp
:
outbound_rtps
)
{
ASSERT_TRUE
(
outbound_rtp
-
>
ssrc
.
has_value
(
)
)
;
ASSERT_TRUE
(
outbound_rtp
-
>
rtx_ssrc
.
has_value
(
)
)
;
ssrcs
.
insert
(
*
outbound_rtp
-
>
ssrc
)
;
rtx_ssrcs
.
insert
(
*
outbound_rtp
-
>
rtx_ssrc
)
;
}
EXPECT_EQ
(
ssrcs
.
size
(
)
3u
)
;
EXPECT_EQ
(
rtx_ssrcs
.
size
(
)
3u
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsEmptyWhenCreatedAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
0
]
.
codec
.
has_value
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsEmptyWhenCreatedVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
0
]
.
codec
.
has_value
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsSetByAddTransceiverAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
true
{
}
false
{
}
)
;
rtc
:
:
scoped_refptr
<
AudioTrackInterface
>
track
=
stream
-
>
GetAudioTracks
(
)
[
0
]
;
std
:
:
optional
<
RtpCodecCapability
>
pcmu
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
pcmu
"
)
;
ASSERT_TRUE
(
pcmu
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
codec
=
pcmu
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
init
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
*
parameters
.
encodings
[
0
]
.
codec
*
pcmu
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
ASSERT_TRUE
(
local_pc_wrapper
-
>
WaitForConnection
(
)
)
;
ASSERT_TRUE
(
remote_pc_wrapper
-
>
WaitForConnection
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASEEQ
(
(
"
audio
/
"
+
pcmu
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsSetByAddTransceiverVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
false
{
}
true
{
.
width
=
1280
.
height
=
720
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp9
"
)
;
ASSERT_TRUE
(
vp9
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
codec
=
vp9
;
encoding_parameters
.
scalability_mode
=
"
L3T3
"
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
init
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
*
parameters
.
encodings
[
0
]
.
codec
*
vp9
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
EXPECT_TRUE_WAIT
(
IsCodecIdDifferentWithScalabilityMode
(
local_pc_wrapper
0
"
"
"
L3T3
"
)
kDefaultTimeout
.
ms
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
EXPECT_EQ
(
outbound_rtps
[
0
]
-
>
scalability_mode
.
value
(
)
"
L3T3
"
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsSetBySetParametersBeforeNegotiationAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
true
{
}
false
{
}
)
;
rtc
:
:
scoped_refptr
<
AudioTrackInterface
>
track
=
stream
-
>
GetAudioTracks
(
)
[
0
]
;
std
:
:
optional
<
RtpCodecCapability
>
pcmu
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
pcmu
"
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
pcmu
;
EXPECT_TRUE
(
audio_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
pcmu
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASEEQ
(
(
"
audio
/
"
+
pcmu
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsSetBySetParametersAfterNegotiationAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
true
{
}
false
{
}
)
;
rtc
:
:
scoped_refptr
<
AudioTrackInterface
>
track
=
stream
-
>
GetAudioTracks
(
)
[
0
]
;
std
:
:
optional
<
RtpCodecCapability
>
pcmu
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
pcmu
"
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASENE
(
(
"
audio
/
"
+
pcmu
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
std
:
:
string
last_codec_id
=
outbound_rtps
[
0
]
-
>
codec_id
.
value
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
pcmu
;
EXPECT_TRUE
(
audio_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
pcmu
)
;
EXPECT_TRUE_WAIT
(
IsCodecIdDifferent
(
local_pc_wrapper
0
last_codec_id
)
kDefaultTimeout
.
ms
(
)
)
;
report
=
GetStats
(
local_pc_wrapper
)
;
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASEEQ
(
(
"
audio
/
"
+
pcmu
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsSetBySetParametersBeforeNegotiationVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
false
{
}
true
{
.
width
=
1280
.
height
=
720
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp9
"
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
vp9
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3
"
;
EXPECT_TRUE
(
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
vp9
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
scalability_mode
"
L3T3
"
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
EXPECT_TRUE_WAIT
(
IsCodecIdDifferentWithScalabilityMode
(
local_pc_wrapper
0
"
"
"
L3T3
"
)
kDefaultTimeout
.
ms
(
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
EXPECT_EQ
(
outbound_rtps
[
0
]
-
>
scalability_mode
.
value_or
(
"
"
)
"
L3T3
"
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParameterCodecIsSetBySetParametersAfterNegotiationVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
false
{
}
true
{
.
width
=
1280
.
height
=
720
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp9
"
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
std
:
:
string
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASENE
(
(
"
audio
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
std
:
:
string
last_codec_id
=
outbound_rtps
[
0
]
-
>
codec_id
.
value
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
vp9
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3
"
;
EXPECT_TRUE
(
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
.
ok
(
)
)
;
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
vp9
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
scalability_mode
"
L3T3
"
)
;
EXPECT_TRUE_WAIT
(
IsCodecIdDifferentWithScalabilityMode
(
local_pc_wrapper
0
last_codec_id
"
L3T3
"
)
kDefaultTimeout
.
ms
(
)
)
;
report
=
GetStats
(
local_pc_wrapper
)
;
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_EQ
(
outbound_rtps
.
size
(
)
1u
)
;
codec_name
=
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
;
EXPECT_STRCASEEQ
(
(
"
video
/
"
+
vp9
-
>
name
)
.
c_str
(
)
codec_name
.
c_str
(
)
)
;
EXPECT_EQ
(
outbound_rtps
[
0
]
-
>
scalability_mode
.
value
(
)
"
L3T3
"
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
AddTransceiverRejectsUnknownCodecParameterAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
RtpCodec
dummy_codec
;
dummy_codec
.
kind
=
cricket
:
:
MEDIA_TYPE_AUDIO
;
dummy_codec
.
name
=
"
FOOBAR
"
;
dummy_codec
.
clock_rate
=
90000
;
dummy_codec
.
num_channels
=
2
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
codec
=
dummy_codec
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_AUDIO
init
)
;
EXPECT_FALSE
(
transceiver_or_error
.
ok
(
)
)
;
EXPECT_EQ
(
transceiver_or_error
.
error
(
)
.
type
(
)
RTCErrorType
:
:
UNSUPPORTED_OPERATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
AddTransceiverRejectsUnknownCodecParameterVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
RtpCodec
dummy_codec
;
dummy_codec
.
kind
=
cricket
:
:
MEDIA_TYPE_VIDEO
;
dummy_codec
.
name
=
"
FOOBAR
"
;
dummy_codec
.
clock_rate
=
90000
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
codec
=
dummy_codec
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
EXPECT_FALSE
(
transceiver_or_error
.
ok
(
)
)
;
EXPECT_EQ
(
transceiver_or_error
.
error
(
)
.
type
(
)
RTCErrorType
:
:
UNSUPPORTED_OPERATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersRejectsUnknownCodecParameterAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
RtpCodec
dummy_codec
;
dummy_codec
.
kind
=
cricket
:
:
MEDIA_TYPE_AUDIO
;
dummy_codec
.
name
=
"
FOOBAR
"
;
dummy_codec
.
clock_rate
=
90000
;
dummy_codec
.
num_channels
=
2
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
dummy_codec
;
RTCError
error
=
audio_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersRejectsUnknownCodecParameterVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
RtpCodec
dummy_codec
;
dummy_codec
.
kind
=
cricket
:
:
MEDIA_TYPE_VIDEO
;
dummy_codec
.
name
=
"
FOOBAR
"
;
dummy_codec
.
clock_rate
=
90000
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
dummy_codec
;
RTCError
error
=
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersRejectsNonNegotiatedCodecParameterAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
opus
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
opus
"
)
;
ASSERT_TRUE
(
opus
)
;
std
:
:
vector
<
RtpCodecCapability
>
not_opus_codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
.
codecs
;
not_opus_codecs
.
erase
(
std
:
:
remove_if
(
not_opus_codecs
.
begin
(
)
not_opus_codecs
.
end
(
)
[
&
]
(
const
auto
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
opus
-
>
name
)
;
}
)
not_opus_codecs
.
end
(
)
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
ASSERT_TRUE
(
audio_transceiver
-
>
SetCodecPreferences
(
not_opus_codecs
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
opus
;
RTCError
error
=
audio_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersRejectsNonRemotelyNegotiatedCodecParameterAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
opus
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
opus
"
)
;
ASSERT_TRUE
(
opus
)
;
std
:
:
vector
<
RtpCodecCapability
>
not_opus_codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
.
codecs
;
not_opus_codecs
.
erase
(
std
:
:
remove_if
(
not_opus_codecs
.
begin
(
)
not_opus_codecs
.
end
(
)
[
&
]
(
const
auto
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
opus
-
>
name
)
;
}
)
not_opus_codecs
.
end
(
)
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
offer
=
CreateOffer
(
local_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p1
=
SetLocalDescription
(
local_pc_wrapper
offer
.
get
(
)
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p2
=
SetRemoteDescription
(
remote_pc_wrapper
offer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
std
:
:
vector
<
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
>
remote_transceivers
=
remote_pc_wrapper
-
>
pc
(
)
-
>
GetTransceivers
(
)
;
ASSERT_TRUE
(
!
remote_transceivers
.
empty
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
remote_audio_transceiver
=
remote_transceivers
[
0
]
;
ASSERT_TRUE
(
remote_audio_transceiver
-
>
SetCodecPreferences
(
not_opus_codecs
)
.
ok
(
)
)
;
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
answer
=
CreateAnswer
(
remote_pc_wrapper
)
;
p1
=
SetLocalDescription
(
remote_pc_wrapper
answer
.
get
(
)
)
;
p2
=
SetRemoteDescription
(
local_pc_wrapper
answer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
opus
;
RTCError
error
=
audio_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersRejectsNonNegotiatedCodecParameterVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp8
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
std
:
:
vector
<
RtpCodecCapability
>
not_vp8_codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
.
codecs
;
not_vp8_codecs
.
erase
(
std
:
:
remove_if
(
not_vp8_codecs
.
begin
(
)
not_vp8_codecs
.
end
(
)
[
&
]
(
const
auto
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
vp8
-
>
name
)
;
}
)
not_vp8_codecs
.
end
(
)
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
ASSERT_TRUE
(
video_transceiver
-
>
SetCodecPreferences
(
not_vp8_codecs
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
vp8
;
RTCError
error
=
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersRejectsNonRemotelyNegotiatedCodecParameterVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp8
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
std
:
:
vector
<
RtpCodecCapability
>
not_vp8_codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
.
codecs
;
not_vp8_codecs
.
erase
(
std
:
:
remove_if
(
not_vp8_codecs
.
begin
(
)
not_vp8_codecs
.
end
(
)
[
&
]
(
const
auto
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
vp8
-
>
name
)
;
}
)
not_vp8_codecs
.
end
(
)
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
offer
=
CreateOffer
(
local_pc_wrapper
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p1
=
SetLocalDescription
(
local_pc_wrapper
offer
.
get
(
)
)
;
rtc
:
:
scoped_refptr
<
MockSetSessionDescriptionObserver
>
p2
=
SetRemoteDescription
(
remote_pc_wrapper
offer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
std
:
:
vector
<
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
>
remote_transceivers
=
remote_pc_wrapper
-
>
pc
(
)
-
>
GetTransceivers
(
)
;
ASSERT_TRUE
(
!
remote_transceivers
.
empty
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
remote_video_transceiver
=
remote_transceivers
[
0
]
;
ASSERT_TRUE
(
remote_video_transceiver
-
>
SetCodecPreferences
(
not_vp8_codecs
)
.
ok
(
)
)
;
std
:
:
unique_ptr
<
SessionDescriptionInterface
>
answer
=
CreateAnswer
(
remote_pc_wrapper
)
;
p1
=
SetLocalDescription
(
remote_pc_wrapper
answer
.
get
(
)
)
;
p2
=
SetRemoteDescription
(
local_pc_wrapper
answer
.
get
(
)
)
;
EXPECT_TRUE
(
Await
(
{
p1
p2
}
)
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
codec
=
vp8
;
RTCError
error
=
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParametersCodecRemovedAfterNegotiationAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
opus
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
opus
"
)
;
ASSERT_TRUE
(
opus
)
;
std
:
:
vector
<
RtpCodecCapability
>
not_opus_codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
.
codecs
;
not_opus_codecs
.
erase
(
std
:
:
remove_if
(
not_opus_codecs
.
begin
(
)
not_opus_codecs
.
end
(
)
[
&
]
(
const
auto
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
opus
-
>
name
)
;
}
)
not_opus_codecs
.
end
(
)
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
codec
=
opus
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_AUDIO
init
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
opus
)
;
ASSERT_TRUE
(
audio_transceiver
-
>
SetCodecPreferences
(
not_opus_codecs
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
0
]
.
codec
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParametersRedEnabledBeforeNegotiationAudio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
RtpCodecCapability
>
send_codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_AUDIO
)
.
codecs
;
std
:
:
optional
<
RtpCodecCapability
>
opus
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
opus
"
)
;
ASSERT_TRUE
(
opus
)
;
std
:
:
optional
<
RtpCodecCapability
>
red
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_AUDIO
"
red
"
)
;
ASSERT_TRUE
(
red
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
codec
=
opus
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_AUDIO
init
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
audio_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
send_codecs
[
0
]
=
red
.
value
(
)
;
send_codecs
[
1
]
=
opus
.
value
(
)
;
ASSERT_TRUE
(
audio_transceiver
-
>
SetCodecPreferences
(
send_codecs
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
RtpParameters
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
opus
)
;
EXPECT_EQ
(
parameters
.
codecs
[
0
]
.
name
red
-
>
name
)
;
send_codecs
[
0
]
=
opus
.
value
(
)
;
send_codecs
[
1
]
=
red
.
value
(
)
;
ASSERT_TRUE
(
audio_transceiver
-
>
SetCodecPreferences
(
send_codecs
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
parameters
=
audio_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
opus
)
;
EXPECT_EQ
(
parameters
.
codecs
[
0
]
.
name
opus
-
>
name
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
SetParametersRejectsScalabilityModeForSelectedCodec
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp8
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
codec
=
vp8
;
encoding_parameters
.
scalability_mode
=
"
L1T3
"
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L3T3
"
;
RTCError
error
=
video_transceiver
-
>
sender
(
)
-
>
SetParameters
(
parameters
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
EncodingParametersCodecRemovedByNegotiationVideo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp8
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
std
:
:
vector
<
RtpCodecCapability
>
not_vp8_codecs
=
local_pc_wrapper
-
>
pc_factory
(
)
-
>
GetRtpSenderCapabilities
(
cricket
:
:
MEDIA_TYPE_VIDEO
)
.
codecs
;
not_vp8_codecs
.
erase
(
std
:
:
remove_if
(
not_vp8_codecs
.
begin
(
)
not_vp8_codecs
.
end
(
)
[
&
]
(
const
auto
&
codec
)
{
return
absl
:
:
EqualsIgnoreCase
(
codec
.
name
vp8
-
>
name
)
;
}
)
not_vp8_codecs
.
end
(
)
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
rid
=
"
h
"
;
encoding_parameters
.
codec
=
vp8
;
encoding_parameters
.
scale_resolution_down_by
=
2
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
encoding_parameters
.
rid
=
"
f
"
;
encoding_parameters
.
scale_resolution_down_by
=
1
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
video_transceiver
=
transceiver_or_error
.
MoveValue
(
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
RtpParameters
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
ASSERT_EQ
(
parameters
.
encodings
.
size
(
)
2u
)
;
EXPECT_EQ
(
parameters
.
encodings
[
0
]
.
codec
vp8
)
;
EXPECT_EQ
(
parameters
.
encodings
[
1
]
.
codec
vp8
)
;
ASSERT_TRUE
(
video_transceiver
-
>
SetCodecPreferences
(
not_vp8_codecs
)
.
ok
(
)
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
parameters
=
video_transceiver
-
>
sender
(
)
-
>
GetParameters
(
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
0
]
.
codec
)
;
EXPECT_FALSE
(
parameters
.
encodings
[
1
]
.
codec
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
AddTransceiverRejectsMixedCodecSimulcast
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp8
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp9
"
)
;
ASSERT_TRUE
(
vp9
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
rid
=
"
h
"
;
encoding_parameters
.
codec
=
vp8
;
encoding_parameters
.
scale_resolution_down_by
=
2
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
encoding_parameters
.
rid
=
"
f
"
;
encoding_parameters
.
codec
=
vp9
;
encoding_parameters
.
scale_resolution_down_by
=
1
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
ASSERT_FALSE
(
transceiver_or_error
.
ok
(
)
)
;
EXPECT_EQ
(
transceiver_or_error
.
error
(
)
.
type
(
)
RTCErrorType
:
:
UNSUPPORTED_OPERATION
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
AddTransceiverAcceptsMixedCodecSimulcast
)
{
test
:
:
ScopedKeyValueConfig
field_trials
(
field_trials_
"
WebRTC
-
MixedCodecSimulcast
/
Enabled
/
"
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp8
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp8
"
)
;
ASSERT_TRUE
(
vp8
)
;
std
:
:
optional
<
RtpCodecCapability
>
vp9
=
local_pc_wrapper
-
>
FindFirstSendCodecWithName
(
cricket
:
:
MEDIA_TYPE_VIDEO
"
vp9
"
)
;
ASSERT_TRUE
(
vp9
)
;
RtpTransceiverInit
init
;
init
.
direction
=
RtpTransceiverDirection
:
:
kSendOnly
;
RtpEncodingParameters
encoding_parameters
;
encoding_parameters
.
rid
=
"
h
"
;
encoding_parameters
.
codec
=
vp8
;
encoding_parameters
.
scale_resolution_down_by
=
2
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
encoding_parameters
.
rid
=
"
f
"
;
encoding_parameters
.
codec
=
vp9
;
encoding_parameters
.
scale_resolution_down_by
=
1
;
init
.
send_encodings
.
push_back
(
encoding_parameters
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
ScaleToParameterChecking
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
pc_wrapper
=
CreatePc
(
)
;
RtpTransceiverInit
init
;
RtpEncodingParameters
encoding
;
encoding
.
scale_resolution_down_to
=
std
:
:
nullopt
;
init
.
send_encodings
.
push_back
(
encoding
)
;
encoding
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
720
}
;
init
.
send_encodings
.
push_back
(
encoding
)
;
auto
transceiver_or_error
=
pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
EXPECT_FALSE
(
transceiver_or_error
.
ok
(
)
)
;
EXPECT_EQ
(
transceiver_or_error
.
error
(
)
.
type
(
)
RTCErrorType
:
:
UNSUPPORTED_OPERATION
)
;
init
.
send_encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
0
}
;
init
.
send_encodings
[
1
]
.
scale_resolution_down_to
=
{
.
width
=
0
.
height
=
720
}
;
transceiver_or_error
=
pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
EXPECT_FALSE
(
transceiver_or_error
.
ok
(
)
)
;
EXPECT_EQ
(
transceiver_or_error
.
error
(
)
.
type
(
)
RTCErrorType
:
:
UNSUPPORTED_OPERATION
)
;
init
.
send_encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
480
}
;
init
.
send_encodings
[
0
]
.
scale_resolution_down_by
=
1
.
0
;
init
.
send_encodings
[
1
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
720
}
;
init
.
send_encodings
[
1
]
.
scale_resolution_down_by
=
2
.
0
;
transceiver_or_error
=
pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
cricket
:
:
MEDIA_TYPE_VIDEO
init
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
auto
sender
=
transceiver_or_error
.
value
(
)
-
>
sender
(
)
;
auto
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
480
}
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_to
=
std
:
:
nullopt
;
auto
error
=
sender
-
>
SetParameters
(
parameters
)
;
EXPECT_FALSE
(
error
.
ok
(
)
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
480
}
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_to
=
std
:
:
nullopt
;
error
=
sender
-
>
SetParameters
(
parameters
)
;
EXPECT_TRUE
(
error
.
ok
(
)
)
;
sender
=
transceiver_or_error
.
value
(
)
-
>
sender
(
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
0
}
;
parameters
.
encodings
[
1
]
.
active
=
true
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_to
=
{
.
width
=
0
.
height
=
720
}
;
error
=
sender
-
>
SetParameters
(
parameters
)
;
EXPECT_FALSE
(
error
.
ok
(
)
)
;
EXPECT_EQ
(
error
.
type
(
)
RTCErrorType
:
:
INVALID_MODIFICATION
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
480
}
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
2
.
0
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
720
}
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
1
.
0
;
error
=
sender
-
>
SetParameters
(
parameters
)
;
EXPECT_TRUE
(
error
.
ok
(
)
)
;
}
TEST_F
(
PeerConnectionEncodingsIntegrationTest
ScaleResolutionDownByIsIgnoredWhenScaleToIsSpecified
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
false
{
}
true
{
.
width
=
640
.
height
=
360
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
RtpTransceiverInit
init
;
RtpEncodingParameters
encoding
;
encoding
.
scale_resolution_down_by
=
2
.
0
;
encoding
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
360
}
;
init
.
send_encodings
.
push_back
(
encoding
)
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
init
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
Negotiate
(
local_pc_wrapper
remote_pc_wrapper
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
)
=
=
(
Resolution
{
.
width
=
640
.
height
=
360
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
class
PeerConnectionEncodingsIntegrationParameterizedTest
:
public
PeerConnectionEncodingsIntegrationTest
public
:
:
testing
:
:
WithParamInterface
<
std
:
:
string
>
{
public
:
PeerConnectionEncodingsIntegrationParameterizedTest
(
)
:
codec_name_
(
GetParam
(
)
)
mime_type_
(
"
video
/
"
+
codec_name_
)
{
}
bool
SkipTestDueToAv1Missing
(
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
)
{
if
(
codec_name_
=
=
"
AV1
"
&
&
!
HasReceiverVideoCodecCapability
(
local_pc_wrapper
"
AV1
"
)
)
{
RTC_LOG
(
LS_WARNING
)
<
<
"
\
n
*
*
*
\
nAV1
is
not
available
skipping
test
.
\
n
*
*
*
"
;
return
true
;
}
return
false
;
}
protected
:
const
std
:
:
string
codec_name_
;
const
std
:
:
string
mime_type_
;
}
;
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
AllLayersInactive
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
"
h
"
"
q
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
1
;
parameters
.
encodings
[
0
]
.
active
=
false
;
parameters
.
encodings
[
1
]
.
active
=
false
;
parameters
.
encodings
[
2
]
.
active
=
false
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
Thread
:
:
Current
(
)
-
>
SleepMs
(
1000
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
3u
)
)
;
EXPECT_EQ
(
*
outbound_rtps
[
0
]
-
>
bytes_sent
0u
)
;
EXPECT_EQ
(
*
outbound_rtps
[
1
]
-
>
bytes_sent
0u
)
;
EXPECT_EQ
(
*
outbound_rtps
[
2
]
-
>
bytes_sent
0u
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
Simulcast
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
4
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
2
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
=
1
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L1T3
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
1
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L1T3
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
2
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L1T3
"
)
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
EXPECT_TRUE
(
OutboundRtpResolutionsAreLessThanOrEqualToExpectations
(
local_pc_wrapper
{
{
"
q
"
320
180
}
{
"
h
"
640
360
}
{
"
f
"
1280
720
}
}
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
3u
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
StrCaseEq
(
mime_type_
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
1
]
)
StrCaseEq
(
mime_type_
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
2
]
)
StrCaseEq
(
mime_type_
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
0
]
-
>
scalability_mode
StrEq
(
"
L1T3
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
1
]
-
>
scalability_mode
StrEq
(
"
L1T3
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
2
]
-
>
scalability_mode
StrEq
(
"
L1T3
"
)
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
SimulcastWithScaleTo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
320
.
height
=
180
}
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
360
}
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
720
}
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
0
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L1T3
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
1
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L1T3
"
)
)
)
;
EXPECT_THAT
(
parameters
.
encodings
[
2
]
.
scalability_mode
Optional
(
std
:
:
string
(
"
L1T3
"
)
)
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
EXPECT_TRUE
(
OutboundRtpResolutionsAreLessThanOrEqualToExpectations
(
local_pc_wrapper
{
{
"
q
"
320
180
}
{
"
h
"
640
360
}
{
"
f
"
1280
720
}
}
)
)
;
rtc
:
:
scoped_refptr
<
const
RTCStatsReport
>
report
=
GetStats
(
local_pc_wrapper
)
;
std
:
:
vector
<
const
RTCOutboundRtpStreamStats
*
>
outbound_rtps
=
report
-
>
GetStatsOfType
<
RTCOutboundRtpStreamStats
>
(
)
;
ASSERT_THAT
(
outbound_rtps
SizeIs
(
3u
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
0
]
)
StrCaseEq
(
mime_type_
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
1
]
)
StrCaseEq
(
mime_type_
)
)
;
EXPECT_THAT
(
GetCurrentCodecMimeType
(
report
*
outbound_rtps
[
2
]
)
StrCaseEq
(
mime_type_
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
0
]
-
>
scalability_mode
StrEq
(
"
L1T3
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
1
]
-
>
scalability_mode
StrEq
(
"
L1T3
"
)
)
;
EXPECT_THAT
(
*
outbound_rtps
[
2
]
-
>
scalability_mode
StrEq
(
"
L1T3
"
)
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
SimulcastScaleDownByNoLongerPowerOfTwo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
4
.
0
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
2
.
0
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
=
1
.
0
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
4
.
0
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
2
.
0
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
=
1
.
333333
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
q
"
)
=
=
Resolution
(
{
.
width
=
320
.
height
=
180
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
h
"
)
=
=
Resolution
(
{
.
width
=
640
.
height
=
360
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
f
"
)
=
=
Resolution
(
{
.
width
=
960
.
height
=
540
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
int
q_frames_encoded
=
EncodedFrames
(
local_pc_wrapper
"
q
"
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
q
"
)
>
q_frames_encoded
kLongTimeoutForRampingUp
.
ms
(
)
)
;
int
h_frames_encoded
=
EncodedFrames
(
local_pc_wrapper
"
h
"
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
h
"
)
>
h_frames_encoded
kLongTimeoutForRampingUp
.
ms
(
)
)
;
int
f_frames_encoded
=
EncodedFrames
(
local_pc_wrapper
"
f
"
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
f
"
)
>
f_frames_encoded
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
SimulcastScaleToNoLongerPowerOfTwo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
320
.
height
=
180
}
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
360
}
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
"
L1T1
"
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
720
}
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
320
.
height
=
180
}
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
360
}
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_to
=
{
.
width
=
960
.
height
=
540
}
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
q
"
)
=
=
Resolution
(
{
.
width
=
320
.
height
=
180
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
h
"
)
=
=
Resolution
(
{
.
width
=
640
.
height
=
360
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
f
"
)
=
=
Resolution
(
{
.
width
=
960
.
height
=
540
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
int
q_frames_encoded
=
EncodedFrames
(
local_pc_wrapper
"
q
"
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
q
"
)
>
q_frames_encoded
kLongTimeoutForRampingUp
.
ms
(
)
)
;
int
h_frames_encoded
=
EncodedFrames
(
local_pc_wrapper
"
h
"
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
h
"
)
>
h_frames_encoded
kLongTimeoutForRampingUp
.
ms
(
)
)
;
int
f_frames_encoded
=
EncodedFrames
(
local_pc_wrapper
"
f
"
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
f
"
)
>
f_frames_encoded
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
LowResolutionSimulcastWithScaleTo
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
RtpTransceiverInit
init
;
RtpEncodingParameters
encoding
;
encoding
.
scalability_mode
=
"
L1T3
"
;
encoding
.
rid
=
"
q
"
;
encoding
.
scale_resolution_down_to
=
{
.
width
=
40
.
height
=
20
}
;
init
.
send_encodings
.
push_back
(
encoding
)
;
encoding
.
rid
=
"
h
"
;
encoding
.
scale_resolution_down_to
=
{
.
width
=
80
.
height
=
40
}
;
init
.
send_encodings
.
push_back
(
encoding
)
;
encoding
.
rid
=
"
f
"
;
encoding
.
scale_resolution_down_to
=
{
.
width
=
160
.
height
=
80
}
;
init
.
send_encodings
.
push_back
(
encoding
)
;
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
stream
=
local_pc_wrapper
-
>
GetUserMedia
(
false
{
}
true
{
.
width
=
160
.
height
=
80
}
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
track
=
stream
-
>
GetVideoTracks
(
)
[
0
]
;
auto
transceiver_or_error
=
local_pc_wrapper
-
>
pc
(
)
-
>
AddTransceiver
(
track
init
)
;
ASSERT_TRUE
(
transceiver_or_error
.
ok
(
)
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
transceiver_or_error
.
value
(
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
HasOutboundRtpBytesSent
(
local_pc_wrapper
3u
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
q
"
)
=
=
Resolution
(
{
.
width
=
40
.
height
=
20
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
h
"
)
=
=
Resolution
(
{
.
width
=
80
.
height
=
40
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
"
f
"
)
=
=
Resolution
(
{
.
width
=
160
.
height
=
80
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
SimulcastEncodingStopWhenRtpEncodingChangeToInactive
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
q
"
"
h
"
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
local_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
ASSERT_EQ
(
parameters
.
encodings
[
0
]
.
rid
"
q
"
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_by
=
4
;
ASSERT_EQ
(
parameters
.
encodings
[
1
]
.
rid
"
h
"
)
;
parameters
.
encodings
[
1
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
1
]
.
scale_resolution_down_by
=
2
;
ASSERT_EQ
(
parameters
.
encodings
[
2
]
.
rid
"
f
"
)
;
parameters
.
encodings
[
2
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
2
]
.
scale_resolution_down_by
=
1
;
sender
-
>
SetParameters
(
parameters
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
f
"
)
>
1
kLongTimeoutForRampingUp
.
ms
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
3
)
)
;
parameters
.
encodings
[
2
]
.
active
=
false
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
!
EncodingIsActive
(
local_pc_wrapper
"
f
"
)
kDefaultTimeout
.
ms
(
)
)
;
int
encoded_frames_f
=
EncodedFrames
(
local_pc_wrapper
"
f
"
)
;
int
encoded_frames_h
=
EncodedFrames
(
local_pc_wrapper
"
h
"
)
;
int
encoded_frames_q
=
EncodedFrames
(
local_pc_wrapper
"
q
"
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
q
"
)
>
encoded_frames_q
+
10
kDefaultTimeout
.
ms
(
)
)
;
ASSERT_TRUE_WAIT
(
EncodedFrames
(
local_pc_wrapper
"
h
"
)
>
encoded_frames_h
+
10
kDefaultTimeout
.
ms
(
)
)
;
EXPECT_LE
(
EncodedFrames
(
local_pc_wrapper
"
f
"
)
-
encoded_frames_f
2
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
ScaleToDownscaleAndThenUpscale
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
1
)
)
;
parameters
.
encodings
[
0
]
.
scalability_mode
=
"
L1T3
"
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
640
.
height
=
360
}
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
)
=
=
(
Resolution
{
.
width
=
640
.
height
=
360
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
parameters
=
sender
-
>
GetParameters
(
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
720
}
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
)
=
=
(
Resolution
{
.
width
=
1280
.
height
=
720
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
ScaleToIsOrientationAgnostic
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
1
)
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
360
.
height
=
640
}
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
)
=
=
(
Resolution
{
.
width
=
640
.
height
=
360
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
TEST_P
(
PeerConnectionEncodingsIntegrationParameterizedTest
ScaleToMaintainsAspectRatio
)
{
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
local_pc_wrapper
=
CreatePc
(
)
;
if
(
SkipTestDueToAv1Missing
(
local_pc_wrapper
)
)
{
return
;
}
rtc
:
:
scoped_refptr
<
PeerConnectionTestWrapper
>
remote_pc_wrapper
=
CreatePc
(
)
;
ExchangeIceCandidates
(
local_pc_wrapper
remote_pc_wrapper
)
;
std
:
:
vector
<
cricket
:
:
SimulcastLayer
>
layers
=
CreateLayers
(
{
"
f
"
}
true
)
;
rtc
:
:
scoped_refptr
<
RtpTransceiverInterface
>
transceiver
=
AddTransceiverWithSimulcastLayers
(
local_pc_wrapper
remote_pc_wrapper
layers
)
;
std
:
:
vector
<
RtpCodecCapability
>
codecs
=
GetCapabilitiesAndRestrictToCodec
(
remote_pc_wrapper
codec_name_
)
;
transceiver
-
>
SetCodecPreferences
(
codecs
)
;
NegotiateWithSimulcastTweaks
(
local_pc_wrapper
remote_pc_wrapper
)
;
local_pc_wrapper
-
>
WaitForConnection
(
)
;
remote_pc_wrapper
-
>
WaitForConnection
(
)
;
rtc
:
:
scoped_refptr
<
RtpSenderInterface
>
sender
=
transceiver
-
>
sender
(
)
;
RtpParameters
parameters
=
sender
-
>
GetParameters
(
)
;
ASSERT_THAT
(
parameters
.
encodings
SizeIs
(
1
)
)
;
parameters
.
encodings
[
0
]
.
scale_resolution_down_to
=
{
.
width
=
1280
.
height
=
360
}
;
sender
-
>
SetParameters
(
parameters
)
;
ASSERT_TRUE_WAIT
(
GetEncodingResolution
(
local_pc_wrapper
)
=
=
(
Resolution
{
.
width
=
640
.
height
=
360
}
)
kLongTimeoutForRampingUp
.
ms
(
)
)
;
}
INSTANTIATE_TEST_SUITE_P
(
StandardPath
PeerConnectionEncodingsIntegrationParameterizedTest
:
:
testing
:
:
Values
(
"
VP8
"
"
VP9
"
#
if
defined
(
WEBRTC_USE_H264
)
"
H264
"
#
endif
"
AV1
"
)
StringParamToString
(
)
)
;
}
