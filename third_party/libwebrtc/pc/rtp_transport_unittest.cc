#
include
"
pc
/
rtp_transport
.
h
"
#
include
<
cerrno
>
#
include
<
cstdint
>
#
include
<
optional
>
#
include
"
api
/
test
/
rtc_error_matchers
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
call
/
rtp_demuxer
.
h
"
#
include
"
p2p
/
base
/
packet_transport_internal
.
h
"
#
include
"
p2p
/
test
/
fake_packet_transport
.
h
"
#
include
"
pc
/
test
/
rtp_transport_test_util
.
h
"
#
include
"
rtc_base
/
buffer
.
h
"
#
include
"
rtc_base
/
containers
/
flat_set
.
h
"
#
include
"
rtc_base
/
copy_on_write_buffer
.
h
"
#
include
"
rtc_base
/
network
/
ecn_marking
.
h
"
#
include
"
rtc_base
/
network
/
sent_packet
.
h
"
#
include
"
rtc_base
/
network_route
.
h
"
#
include
"
rtc_base
/
third_party
/
sigslot
/
sigslot
.
h
"
#
include
"
test
/
explicit_key_value_config
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
run_loop
.
h
"
#
include
"
test
/
wait_until
.
h
"
namespace
webrtc
{
using
test
:
:
ExplicitKeyValueConfig
;
constexpr
bool
kMuxDisabled
=
false
;
constexpr
bool
kMuxEnabled
=
true
;
constexpr
uint16_t
kLocalNetId
=
1
;
constexpr
uint16_t
kRemoteNetId
=
2
;
constexpr
int
kLastPacketId
=
100
;
constexpr
int
kTransportOverheadPerPacket
=
28
;
class
SignalObserver
:
public
sigslot
:
:
has_slots
<
>
{
public
:
explicit
SignalObserver
(
RtpTransport
*
transport
)
{
transport_
=
transport
;
transport
-
>
SubscribeReadyToSend
(
this
[
this
]
(
bool
ready
)
{
OnReadyToSend
(
ready
)
;
}
)
;
transport
-
>
SubscribeNetworkRouteChanged
(
this
[
this
]
(
std
:
:
optional
<
rtc
:
:
NetworkRoute
>
route
)
{
OnNetworkRouteChanged
(
route
)
;
}
)
;
if
(
transport
-
>
rtp_packet_transport
(
)
)
{
transport
-
>
rtp_packet_transport
(
)
-
>
SignalSentPacket
.
connect
(
this
&
SignalObserver
:
:
OnSentPacket
)
;
}
if
(
transport
-
>
rtcp_packet_transport
(
)
)
{
transport
-
>
rtcp_packet_transport
(
)
-
>
SignalSentPacket
.
connect
(
this
&
SignalObserver
:
:
OnSentPacket
)
;
}
}
bool
ready
(
)
const
{
return
ready_
;
}
void
OnReadyToSend
(
bool
ready
)
{
ready_
=
ready
;
}
std
:
:
optional
<
NetworkRoute
>
network_route
(
)
{
return
network_route_
;
}
void
OnNetworkRouteChanged
(
std
:
:
optional
<
NetworkRoute
>
network_route
)
{
network_route_
=
network_route
;
}
void
OnSentPacket
(
PacketTransportInternal
*
packet_transport
const
rtc
:
:
SentPacket
&
sent_packet
)
{
if
(
packet_transport
=
=
transport_
-
>
rtp_packet_transport
(
)
)
{
rtp_transport_sent_count_
+
+
;
}
else
{
ASSERT_EQ
(
transport_
-
>
rtcp_packet_transport
(
)
packet_transport
)
;
rtcp_transport_sent_count_
+
+
;
}
}
int
rtp_transport_sent_count
(
)
{
return
rtp_transport_sent_count_
;
}
int
rtcp_transport_sent_count
(
)
{
return
rtcp_transport_sent_count_
;
}
private
:
int
rtp_transport_sent_count_
=
0
;
int
rtcp_transport_sent_count_
=
0
;
RtpTransport
*
transport_
=
nullptr
;
bool
ready_
=
false
;
std
:
:
optional
<
NetworkRoute
>
network_route_
;
}
;
TEST
(
RtpTransportTest
SettingRtcpAndRtpSignalsReady
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
SignalObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtcp
(
"
fake_rtcp
"
)
;
fake_rtcp
.
SetWritable
(
true
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetWritable
(
true
)
;
transport
.
SetRtcpPacketTransport
(
&
fake_rtcp
)
;
EXPECT_FALSE
(
observer
.
ready
(
)
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
EXPECT_TRUE
(
observer
.
ready
(
)
)
;
}
TEST
(
RtpTransportTest
SettingRtpAndRtcpSignalsReady
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
SignalObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtcp
(
"
fake_rtcp
"
)
;
fake_rtcp
.
SetWritable
(
true
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetWritable
(
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
EXPECT_FALSE
(
observer
.
ready
(
)
)
;
transport
.
SetRtcpPacketTransport
(
&
fake_rtcp
)
;
EXPECT_TRUE
(
observer
.
ready
(
)
)
;
}
TEST
(
RtpTransportTest
SettingRtpWithRtcpMuxEnabledSignalsReady
)
{
RtpTransport
transport
(
kMuxEnabled
ExplicitKeyValueConfig
(
"
"
)
)
;
SignalObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetWritable
(
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
EXPECT_TRUE
(
observer
.
ready
(
)
)
;
}
TEST
(
RtpTransportTest
DisablingRtcpMuxSignalsNotReady
)
{
RtpTransport
transport
(
kMuxEnabled
ExplicitKeyValueConfig
(
"
"
)
)
;
SignalObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetWritable
(
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
EXPECT_TRUE
(
observer
.
ready
(
)
)
;
transport
.
SetRtcpMuxEnabled
(
false
)
;
EXPECT_FALSE
(
observer
.
ready
(
)
)
;
}
TEST
(
RtpTransportTest
EnablingRtcpMuxSignalsReady
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
SignalObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetWritable
(
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
EXPECT_FALSE
(
observer
.
ready
(
)
)
;
transport
.
SetRtcpMuxEnabled
(
true
)
;
EXPECT_TRUE
(
observer
.
ready
(
)
)
;
}
TEST
(
RtpTransportTest
SetRtpTransportWithNetworkRouteChanged
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
SignalObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
EXPECT_FALSE
(
observer
.
network_route
(
)
)
;
NetworkRoute
network_route
;
network_route
.
connected
=
true
;
network_route
.
local
=
RouteEndpoint
:
:
CreateWithNetworkId
(
kLocalNetId
)
;
network_route
.
remote
=
RouteEndpoint
:
:
CreateWithNetworkId
(
kRemoteNetId
)
;
network_route
.
last_sent_packet_id
=
kLastPacketId
;
network_route
.
packet_overhead
=
kTransportOverheadPerPacket
;
fake_rtp
.
SetNetworkRoute
(
std
:
:
optional
<
NetworkRoute
>
(
network_route
)
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
ASSERT_TRUE
(
observer
.
network_route
(
)
)
;
EXPECT_TRUE
(
observer
.
network_route
(
)
-
>
connected
)
;
EXPECT_EQ
(
kLocalNetId
observer
.
network_route
(
)
-
>
local
.
network_id
(
)
)
;
EXPECT_EQ
(
kRemoteNetId
observer
.
network_route
(
)
-
>
remote
.
network_id
(
)
)
;
EXPECT_EQ
(
kTransportOverheadPerPacket
observer
.
network_route
(
)
-
>
packet_overhead
)
;
EXPECT_EQ
(
kLastPacketId
observer
.
network_route
(
)
-
>
last_sent_packet_id
)
;
transport
.
SetRtpPacketTransport
(
nullptr
)
;
EXPECT_FALSE
(
observer
.
network_route
(
)
)
;
}
TEST
(
RtpTransportTest
SetRtcpTransportWithNetworkRouteChanged
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
SignalObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtcp
(
"
fake_rtcp
"
)
;
EXPECT_FALSE
(
observer
.
network_route
(
)
)
;
NetworkRoute
network_route
;
network_route
.
connected
=
true
;
network_route
.
local
=
RouteEndpoint
:
:
CreateWithNetworkId
(
kLocalNetId
)
;
network_route
.
remote
=
RouteEndpoint
:
:
CreateWithNetworkId
(
kRemoteNetId
)
;
network_route
.
last_sent_packet_id
=
kLastPacketId
;
network_route
.
packet_overhead
=
kTransportOverheadPerPacket
;
fake_rtcp
.
SetNetworkRoute
(
std
:
:
optional
<
NetworkRoute
>
(
network_route
)
)
;
transport
.
SetRtcpPacketTransport
(
&
fake_rtcp
)
;
ASSERT_TRUE
(
observer
.
network_route
(
)
)
;
EXPECT_TRUE
(
observer
.
network_route
(
)
-
>
connected
)
;
EXPECT_EQ
(
kLocalNetId
observer
.
network_route
(
)
-
>
local
.
network_id
(
)
)
;
EXPECT_EQ
(
kRemoteNetId
observer
.
network_route
(
)
-
>
remote
.
network_id
(
)
)
;
EXPECT_EQ
(
kTransportOverheadPerPacket
observer
.
network_route
(
)
-
>
packet_overhead
)
;
EXPECT_EQ
(
kLastPacketId
observer
.
network_route
(
)
-
>
last_sent_packet_id
)
;
transport
.
SetRtcpPacketTransport
(
nullptr
)
;
EXPECT_FALSE
(
observer
.
network_route
(
)
)
;
}
TEST
(
RtpTransportTest
RtcpPacketSentOverCorrectTransport
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
FakePacketTransport
fake_rtcp
(
"
fake_rtcp
"
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
transport
.
SetRtcpPacketTransport
(
&
fake_rtcp
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
SignalObserver
observer
(
&
transport
)
;
fake_rtp
.
SetDestination
(
&
fake_rtp
true
)
;
fake_rtcp
.
SetDestination
(
&
fake_rtcp
true
)
;
rtc
:
:
CopyOnWriteBuffer
packet
;
EXPECT_TRUE
(
transport
.
SendRtcpPacket
(
&
packet
rtc
:
:
PacketOptions
(
)
0
)
)
;
EXPECT_EQ
(
1
observer
.
rtcp_transport_sent_count
(
)
)
;
transport
.
SetRtcpMuxEnabled
(
true
)
;
EXPECT_TRUE
(
transport
.
SendRtcpPacket
(
&
packet
rtc
:
:
PacketOptions
(
)
0
)
)
;
EXPECT_EQ
(
1
observer
.
rtp_transport_sent_count
(
)
)
;
}
TEST
(
RtpTransportTest
ChangingReadyToSendStateOnlySignalsWhenChanged
)
{
RtpTransport
transport
(
kMuxEnabled
ExplicitKeyValueConfig
(
"
"
)
)
;
TransportObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetWritable
(
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
EXPECT_EQ
(
observer
.
ready_to_send_signal_count
(
)
1
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
EXPECT_EQ
(
observer
.
ready_to_send_signal_count
(
)
1
)
;
transport
.
SetRtcpMuxEnabled
(
true
)
;
EXPECT_EQ
(
observer
.
ready_to_send_signal_count
(
)
1
)
;
transport
.
SetRtcpMuxEnabled
(
false
)
;
EXPECT_EQ
(
observer
.
ready_to_send_signal_count
(
)
2
)
;
}
TEST
(
RtpTransportTest
SignalDemuxedRtcp
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetDestination
(
&
fake_rtp
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
TransportObserver
observer
(
&
transport
)
;
const
unsigned
char
data
[
]
=
{
0x80
73
0
0
}
;
const
int
len
=
4
;
const
rtc
:
:
PacketOptions
options
;
const
int
flags
=
0
;
fake_rtp
.
SendPacket
(
reinterpret_cast
<
const
char
*
>
(
data
)
len
options
flags
)
;
EXPECT_EQ
(
0
observer
.
rtp_count
(
)
)
;
EXPECT_EQ
(
1
observer
.
rtcp_count
(
)
)
;
}
static
const
unsigned
char
kRtpData
[
]
=
{
0x80
0x11
0
0
0
0
0
0
0
0
0
0
}
;
static
const
int
kRtpLen
=
12
;
TEST
(
RtpTransportTest
SignalHandledRtpPayloadType
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetDestination
(
&
fake_rtp
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
TransportObserver
observer
(
&
transport
)
;
RtpDemuxerCriteria
demuxer_criteria
;
demuxer_criteria
.
payload_types
(
)
.
insert
(
0x11
)
;
transport
.
RegisterRtpDemuxerSink
(
demuxer_criteria
&
observer
)
;
const
rtc
:
:
PacketOptions
options
;
const
int
flags
=
0
;
rtc
:
:
Buffer
rtp_data
(
kRtpData
kRtpLen
)
;
fake_rtp
.
SendPacket
(
rtp_data
.
data
<
char
>
(
)
kRtpLen
options
flags
)
;
EXPECT_EQ
(
1
observer
.
rtp_count
(
)
)
;
EXPECT_EQ
(
0
observer
.
un_demuxable_rtp_count
(
)
)
;
EXPECT_EQ
(
0
observer
.
rtcp_count
(
)
)
;
transport
.
UnregisterRtpDemuxerSink
(
&
observer
)
;
}
TEST
(
RtpTransportTest
ReceivedPacketEcnMarkingPropagatedToDemuxedPacket
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetDestination
(
&
fake_rtp
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
TransportObserver
observer
(
&
transport
)
;
RtpDemuxerCriteria
demuxer_criteria
;
demuxer_criteria
.
payload_types
(
)
.
insert
(
0x11
)
;
transport
.
RegisterRtpDemuxerSink
(
demuxer_criteria
&
observer
)
;
rtc
:
:
PacketOptions
options
;
options
.
ecn_1
=
true
;
const
int
flags
=
0
;
rtc
:
:
Buffer
rtp_data
(
kRtpData
kRtpLen
)
;
fake_rtp
.
SendPacket
(
rtp_data
.
data
<
char
>
(
)
kRtpLen
options
flags
)
;
ASSERT_EQ
(
observer
.
rtp_count
(
)
1
)
;
EXPECT_EQ
(
observer
.
last_recv_rtp_packet
(
)
.
ecn
(
)
rtc
:
:
EcnMarking
:
:
kEct1
)
;
transport
.
UnregisterRtpDemuxerSink
(
&
observer
)
;
}
TEST
(
RtpTransportTest
DontSignalUnhandledRtpPayloadType
)
{
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetDestination
(
&
fake_rtp
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
TransportObserver
observer
(
&
transport
)
;
RtpDemuxerCriteria
demuxer_criteria
;
demuxer_criteria
.
payload_types
(
)
.
insert
(
0x12
)
;
transport
.
RegisterRtpDemuxerSink
(
demuxer_criteria
&
observer
)
;
const
rtc
:
:
PacketOptions
options
;
const
int
flags
=
0
;
rtc
:
:
Buffer
rtp_data
(
kRtpData
kRtpLen
)
;
fake_rtp
.
SendPacket
(
rtp_data
.
data
<
char
>
(
)
kRtpLen
options
flags
)
;
EXPECT_EQ
(
0
observer
.
rtp_count
(
)
)
;
EXPECT_EQ
(
1
observer
.
un_demuxable_rtp_count
(
)
)
;
EXPECT_EQ
(
0
observer
.
rtcp_count
(
)
)
;
transport
.
UnregisterRtpDemuxerSink
(
&
observer
)
;
}
TEST
(
RtpTransportTest
DontChangeReadyToSendStateOnSendFailure
)
{
RtpTransport
transport
(
kMuxEnabled
ExplicitKeyValueConfig
(
"
"
)
)
;
TransportObserver
observer
(
&
transport
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
fake_rtp
.
SetDestination
(
&
fake_rtp
true
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
fake_rtp
.
SetWritable
(
true
)
;
EXPECT_TRUE
(
observer
.
ready_to_send
(
)
)
;
EXPECT_EQ
(
observer
.
ready_to_send_signal_count
(
)
1
)
;
rtc
:
:
CopyOnWriteBuffer
packet
;
EXPECT_TRUE
(
transport
.
SendRtpPacket
(
&
packet
rtc
:
:
PacketOptions
(
)
0
)
)
;
fake_rtp
.
SetError
(
ENOTCONN
)
;
EXPECT_FALSE
(
transport
.
SendRtpPacket
(
&
packet
rtc
:
:
PacketOptions
(
)
0
)
)
;
EXPECT_TRUE
(
observer
.
ready_to_send
(
)
)
;
EXPECT_EQ
(
observer
.
ready_to_send_signal_count
(
)
1
)
;
}
TEST
(
RtpTransportTest
RecursiveSetSendDoesNotCrash
)
{
const
int
kShortTimeout
=
100
;
test
:
:
RunLoop
loop
;
RtpTransport
transport
(
kMuxEnabled
ExplicitKeyValueConfig
(
"
WebRTC
-
SetReadyToSendFalseIfSendFail
/
Enabled
/
"
)
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
TransportObserver
observer
(
&
transport
)
;
observer
.
SetActionOnReadyToSend
(
[
&
]
(
bool
ready
)
{
const
rtc
:
:
PacketOptions
options
;
const
int
flags
=
0
;
rtc
:
:
CopyOnWriteBuffer
rtp_data
(
kRtpData
kRtpLen
)
;
transport
.
SendRtpPacket
(
&
rtp_data
options
flags
)
;
}
)
;
fake_rtp
.
SetError
(
ENOTCONN
)
;
fake_rtp
.
SetWritable
(
true
)
;
EXPECT_TRUE
(
observer
.
ready_to_send
(
)
)
;
EXPECT_EQ
(
observer
.
ready_to_send_signal_count
(
)
1
)
;
EXPECT_THAT
(
WaitUntil
(
[
&
]
{
return
observer
.
ready_to_send_signal_count
(
)
;
}
:
:
testing
:
:
Eq
(
2
)
{
.
timeout
=
webrtc
:
:
TimeDelta
:
:
Millis
(
kShortTimeout
)
}
)
IsRtcOk
(
)
)
;
EXPECT_FALSE
(
observer
.
ready_to_send
(
)
)
;
}
TEST
(
RtpTransportTest
RecursiveOnSentPacketDoesNotCrash
)
{
const
int
kShortTimeout
=
100
;
test
:
:
RunLoop
loop
;
RtpTransport
transport
(
kMuxDisabled
ExplicitKeyValueConfig
(
"
"
)
)
;
FakePacketTransport
fake_rtp
(
"
fake_rtp
"
)
;
transport
.
SetRtpPacketTransport
(
&
fake_rtp
)
;
fake_rtp
.
SetDestination
(
&
fake_rtp
true
)
;
TransportObserver
observer
(
&
transport
)
;
const
rtc
:
:
PacketOptions
options
;
const
int
flags
=
0
;
fake_rtp
.
SetWritable
(
true
)
;
observer
.
SetActionOnSentPacket
(
[
&
]
(
)
{
rtc
:
:
CopyOnWriteBuffer
rtp_data
(
kRtpData
kRtpLen
)
;
if
(
observer
.
sent_packet_count
(
)
<
2
)
{
transport
.
SendRtpPacket
(
&
rtp_data
options
flags
)
;
}
}
)
;
rtc
:
:
CopyOnWriteBuffer
rtp_data
(
kRtpData
kRtpLen
)
;
transport
.
SendRtpPacket
(
&
rtp_data
options
flags
)
;
EXPECT_EQ
(
observer
.
sent_packet_count
(
)
1
)
;
EXPECT_THAT
(
WaitUntil
(
[
&
]
{
return
observer
.
sent_packet_count
(
)
;
}
:
:
testing
:
:
Eq
(
2
)
{
.
timeout
=
webrtc
:
:
TimeDelta
:
:
Millis
(
kShortTimeout
)
}
)
IsRtcOk
(
)
)
;
}
}
