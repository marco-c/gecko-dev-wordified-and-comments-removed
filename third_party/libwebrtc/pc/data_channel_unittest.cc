#
include
<
stdint
.
h
>
#
include
<
string
.
h
>
#
include
<
memory
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
api
/
data_channel_interface
.
h
"
#
include
"
api
/
rtc_error
.
h
"
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
transport
/
data_channel_transport_interface
.
h
"
#
include
"
media
/
base
/
media_channel
.
h
"
#
include
"
media
/
sctp
/
sctp_transport_internal
.
h
"
#
include
"
pc
/
sctp_data_channel
.
h
"
#
include
"
pc
/
sctp_utils
.
h
"
#
include
"
pc
/
test
/
fake_data_channel_controller
.
h
"
#
include
"
rtc_base
/
copy_on_write_buffer
.
h
"
#
include
"
rtc_base
/
gunit
.
h
"
#
include
"
rtc_base
/
ssl_stream_adapter
.
h
"
#
include
"
rtc_base
/
third_party
/
sigslot
/
sigslot
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
test
/
gtest
.
h
"
using
webrtc
:
:
DataChannelInterface
;
using
webrtc
:
:
SctpDataChannel
;
using
webrtc
:
:
SctpSidAllocator
;
static
constexpr
int
kDefaultTimeout
=
10000
;
class
FakeDataChannelObserver
:
public
webrtc
:
:
DataChannelObserver
{
public
:
FakeDataChannelObserver
(
)
:
messages_received_
(
0
)
on_state_change_count_
(
0
)
on_buffered_amount_change_count_
(
0
)
{
}
void
OnStateChange
(
)
{
+
+
on_state_change_count_
;
}
void
OnBufferedAmountChange
(
uint64_t
previous_amount
)
{
+
+
on_buffered_amount_change_count_
;
}
void
OnMessage
(
const
webrtc
:
:
DataBuffer
&
buffer
)
{
+
+
messages_received_
;
}
size_t
messages_received
(
)
const
{
return
messages_received_
;
}
void
ResetOnStateChangeCount
(
)
{
on_state_change_count_
=
0
;
}
void
ResetOnBufferedAmountChangeCount
(
)
{
on_buffered_amount_change_count_
=
0
;
}
size_t
on_state_change_count
(
)
const
{
return
on_state_change_count_
;
}
size_t
on_buffered_amount_change_count
(
)
const
{
return
on_buffered_amount_change_count_
;
}
private
:
size_t
messages_received_
;
size_t
on_state_change_count_
;
size_t
on_buffered_amount_change_count_
;
}
;
class
SctpDataChannelTest
:
public
:
:
testing
:
:
Test
{
protected
:
SctpDataChannelTest
(
)
:
controller_
(
new
FakeDataChannelController
(
)
)
webrtc_data_channel_
(
SctpDataChannel
:
:
Create
(
controller_
.
get
(
)
"
test
"
init_
rtc
:
:
Thread
:
:
Current
(
)
rtc
:
:
Thread
:
:
Current
(
)
)
)
{
}
void
SetChannelReady
(
)
{
controller_
-
>
set_transport_available
(
true
)
;
webrtc_data_channel_
-
>
OnTransportChannelCreated
(
)
;
if
(
webrtc_data_channel_
-
>
id
(
)
<
0
)
{
webrtc_data_channel_
-
>
SetSctpSid
(
0
)
;
}
controller_
-
>
set_ready_to_send
(
true
)
;
}
void
AddObserver
(
)
{
observer_
.
reset
(
new
FakeDataChannelObserver
(
)
)
;
webrtc_data_channel_
-
>
RegisterObserver
(
observer_
.
get
(
)
)
;
}
webrtc
:
:
InternalDataChannelInit
init_
;
std
:
:
unique_ptr
<
FakeDataChannelController
>
controller_
;
std
:
:
unique_ptr
<
FakeDataChannelObserver
>
observer_
;
rtc
:
:
scoped_refptr
<
SctpDataChannel
>
webrtc_data_channel_
;
}
;
class
StateSignalsListener
:
public
sigslot
:
:
has_slots
<
>
{
public
:
int
opened_count
(
)
const
{
return
opened_count_
;
}
int
closed_count
(
)
const
{
return
closed_count_
;
}
void
OnSignalOpened
(
DataChannelInterface
*
data_channel
)
{
+
+
opened_count_
;
}
void
OnSignalClosed
(
DataChannelInterface
*
data_channel
)
{
+
+
closed_count_
;
}
private
:
int
opened_count_
=
0
;
int
closed_count_
=
0
;
}
;
TEST_F
(
SctpDataChannelTest
ConnectedToTransportOnCreated
)
{
controller_
-
>
set_transport_available
(
true
)
;
rtc
:
:
scoped_refptr
<
SctpDataChannel
>
dc
=
SctpDataChannel
:
:
Create
(
controller_
.
get
(
)
"
test1
"
init_
rtc
:
:
Thread
:
:
Current
(
)
rtc
:
:
Thread
:
:
Current
(
)
)
;
EXPECT_TRUE
(
controller_
-
>
IsConnected
(
dc
.
get
(
)
)
)
;
EXPECT_FALSE
(
controller_
-
>
IsSendStreamAdded
(
dc
-
>
id
(
)
)
)
;
EXPECT_FALSE
(
controller_
-
>
IsRecvStreamAdded
(
dc
-
>
id
(
)
)
)
;
dc
-
>
SetSctpSid
(
0
)
;
EXPECT_TRUE
(
controller_
-
>
IsSendStreamAdded
(
dc
-
>
id
(
)
)
)
;
EXPECT_TRUE
(
controller_
-
>
IsRecvStreamAdded
(
dc
-
>
id
(
)
)
)
;
}
TEST_F
(
SctpDataChannelTest
ConnectedAfterTransportBecomesAvailable
)
{
EXPECT_FALSE
(
controller_
-
>
IsConnected
(
webrtc_data_channel_
.
get
(
)
)
)
;
controller_
-
>
set_transport_available
(
true
)
;
webrtc_data_channel_
-
>
OnTransportChannelCreated
(
)
;
EXPECT_TRUE
(
controller_
-
>
IsConnected
(
webrtc_data_channel_
.
get
(
)
)
)
;
}
TEST_F
(
SctpDataChannelTest
StateTransition
)
{
StateSignalsListener
state_signals_listener
;
webrtc_data_channel_
-
>
SignalOpened
.
connect
(
&
state_signals_listener
&
StateSignalsListener
:
:
OnSignalOpened
)
;
webrtc_data_channel_
-
>
SignalClosed
.
connect
(
&
state_signals_listener
&
StateSignalsListener
:
:
OnSignalClosed
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kConnecting
webrtc_data_channel_
-
>
state
(
)
)
;
EXPECT_EQ
(
state_signals_listener
.
opened_count
(
)
0
)
;
EXPECT_EQ
(
state_signals_listener
.
closed_count
(
)
0
)
;
SetChannelReady
(
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
webrtc_data_channel_
-
>
state
(
)
)
;
EXPECT_EQ
(
state_signals_listener
.
opened_count
(
)
1
)
;
EXPECT_EQ
(
state_signals_listener
.
closed_count
(
)
0
)
;
webrtc_data_channel_
-
>
Close
(
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kClosed
webrtc_data_channel_
-
>
state
(
)
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
error
(
)
.
ok
(
)
)
;
EXPECT_EQ
(
state_signals_listener
.
opened_count
(
)
1
)
;
EXPECT_EQ
(
state_signals_listener
.
closed_count
(
)
1
)
;
EXPECT_FALSE
(
controller_
-
>
IsConnected
(
webrtc_data_channel_
.
get
(
)
)
)
;
}
TEST_F
(
SctpDataChannelTest
BufferedAmountWhenBlocked
)
{
AddObserver
(
)
;
SetChannelReady
(
)
;
webrtc
:
:
DataBuffer
buffer
(
"
abcd
"
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffer
)
)
;
size_t
successful_send_count
=
1
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
buffered_amount
(
)
)
;
EXPECT_EQ
(
successful_send_count
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
controller_
-
>
set_send_blocked
(
true
)
;
const
int
number_of_packets
=
3
;
for
(
int
i
=
0
;
i
<
number_of_packets
;
+
+
i
)
{
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffer
)
)
;
}
EXPECT_EQ
(
buffer
.
data
.
size
(
)
*
number_of_packets
webrtc_data_channel_
-
>
buffered_amount
(
)
)
;
EXPECT_EQ
(
successful_send_count
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
controller_
-
>
set_send_blocked
(
false
)
;
successful_send_count
+
=
number_of_packets
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
buffered_amount
(
)
)
;
EXPECT_EQ
(
successful_send_count
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
QueuedDataSentWhenUnblocked
)
{
AddObserver
(
)
;
SetChannelReady
(
)
;
webrtc
:
:
DataBuffer
buffer
(
"
abcd
"
)
;
controller_
-
>
set_send_blocked
(
true
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffer
)
)
;
EXPECT_EQ
(
0U
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
controller_
-
>
set_send_blocked
(
false
)
;
SetChannelReady
(
)
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
buffered_amount
(
)
)
;
EXPECT_EQ
(
1U
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
BlockedWhenSendQueuedDataNoCrash
)
{
AddObserver
(
)
;
SetChannelReady
(
)
;
webrtc
:
:
DataBuffer
buffer
(
"
abcd
"
)
;
controller_
-
>
set_send_blocked
(
true
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffer
)
)
;
EXPECT_EQ
(
0U
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
SetChannelReady
(
)
;
EXPECT_EQ
(
buffer
.
size
(
)
webrtc_data_channel_
-
>
buffered_amount
(
)
)
;
EXPECT_EQ
(
0U
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
controller_
-
>
set_send_blocked
(
false
)
;
SetChannelReady
(
)
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
buffered_amount
(
)
)
;
EXPECT_EQ
(
1U
observer_
-
>
on_buffered_amount_change_count
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
VerifyMessagesAndBytesSent
)
{
AddObserver
(
)
;
SetChannelReady
(
)
;
std
:
:
vector
<
webrtc
:
:
DataBuffer
>
buffers
(
{
webrtc
:
:
DataBuffer
(
"
message
1
"
)
webrtc
:
:
DataBuffer
(
"
msg
2
"
)
webrtc
:
:
DataBuffer
(
"
message
three
"
)
webrtc
:
:
DataBuffer
(
"
quadra
message
"
)
webrtc
:
:
DataBuffer
(
"
fifthmsg
"
)
webrtc
:
:
DataBuffer
(
"
message
of
the
beast
"
)
}
)
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
messages_sent
(
)
)
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
bytes_sent
(
)
)
;
controller_
-
>
set_send_blocked
(
false
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffers
[
0
]
)
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffers
[
1
]
)
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffers
[
2
]
)
)
;
size_t
bytes_sent
=
buffers
[
0
]
.
size
(
)
+
buffers
[
1
]
.
size
(
)
+
buffers
[
2
]
.
size
(
)
;
EXPECT_EQ_WAIT
(
0U
webrtc_data_channel_
-
>
buffered_amount
(
)
kDefaultTimeout
)
;
EXPECT_EQ
(
3U
webrtc_data_channel_
-
>
messages_sent
(
)
)
;
EXPECT_EQ
(
bytes_sent
webrtc_data_channel_
-
>
bytes_sent
(
)
)
;
controller_
-
>
set_send_blocked
(
true
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffers
[
3
]
)
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffers
[
4
]
)
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffers
[
5
]
)
)
;
size_t
bytes_queued
=
buffers
[
3
]
.
size
(
)
+
buffers
[
4
]
.
size
(
)
+
buffers
[
5
]
.
size
(
)
;
EXPECT_EQ
(
bytes_queued
webrtc_data_channel_
-
>
buffered_amount
(
)
)
;
EXPECT_EQ
(
3U
webrtc_data_channel_
-
>
messages_sent
(
)
)
;
EXPECT_EQ
(
bytes_sent
webrtc_data_channel_
-
>
bytes_sent
(
)
)
;
controller_
-
>
set_send_blocked
(
false
)
;
EXPECT_EQ_WAIT
(
0U
webrtc_data_channel_
-
>
buffered_amount
(
)
kDefaultTimeout
)
;
bytes_sent
+
=
bytes_queued
;
EXPECT_EQ
(
6U
webrtc_data_channel_
-
>
messages_sent
(
)
)
;
EXPECT_EQ
(
bytes_sent
webrtc_data_channel_
-
>
bytes_sent
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
OpenMessageSent
)
{
EXPECT_EQ
(
-
1
webrtc_data_channel_
-
>
id
(
)
)
;
SetChannelReady
(
)
;
EXPECT_GE
(
webrtc_data_channel_
-
>
id
(
)
0
)
;
EXPECT_EQ
(
webrtc
:
:
DataMessageType
:
:
kControl
controller_
-
>
last_send_data_params
(
)
.
type
)
;
EXPECT_EQ
(
controller_
-
>
last_sid
(
)
webrtc_data_channel_
-
>
id
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
QueuedOpenMessageSent
)
{
controller_
-
>
set_send_blocked
(
true
)
;
SetChannelReady
(
)
;
controller_
-
>
set_send_blocked
(
false
)
;
EXPECT_EQ
(
webrtc
:
:
DataMessageType
:
:
kControl
controller_
-
>
last_send_data_params
(
)
.
type
)
;
EXPECT_EQ
(
controller_
-
>
last_sid
(
)
webrtc_data_channel_
-
>
id
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
LateCreatedChannelTransitionToOpen
)
{
SetChannelReady
(
)
;
webrtc
:
:
InternalDataChannelInit
init
;
init
.
id
=
1
;
rtc
:
:
scoped_refptr
<
SctpDataChannel
>
dc
=
SctpDataChannel
:
:
Create
(
controller_
.
get
(
)
"
test1
"
init
rtc
:
:
Thread
:
:
Current
(
)
rtc
:
:
Thread
:
:
Current
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kConnecting
dc
-
>
state
(
)
)
;
EXPECT_TRUE_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
=
=
dc
-
>
state
(
)
1000
)
;
}
TEST_F
(
SctpDataChannelTest
SendUnorderedAfterReceivesOpenAck
)
{
SetChannelReady
(
)
;
webrtc
:
:
InternalDataChannelInit
init
;
init
.
id
=
1
;
init
.
ordered
=
false
;
rtc
:
:
scoped_refptr
<
SctpDataChannel
>
dc
=
SctpDataChannel
:
:
Create
(
controller_
.
get
(
)
"
test1
"
init
rtc
:
:
Thread
:
:
Current
(
)
rtc
:
:
Thread
:
:
Current
(
)
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
dc
-
>
state
(
)
1000
)
;
webrtc
:
:
DataBuffer
buffer
(
"
some
data
"
)
;
ASSERT_TRUE
(
dc
-
>
Send
(
buffer
)
)
;
EXPECT_TRUE
(
controller_
-
>
last_send_data_params
(
)
.
ordered
)
;
cricket
:
:
ReceiveDataParams
params
;
params
.
sid
=
init
.
id
;
params
.
type
=
webrtc
:
:
DataMessageType
:
:
kControl
;
rtc
:
:
CopyOnWriteBuffer
payload
;
webrtc
:
:
WriteDataChannelOpenAckMessage
(
&
payload
)
;
dc
-
>
OnDataReceived
(
params
payload
)
;
ASSERT_TRUE
(
dc
-
>
Send
(
buffer
)
)
;
EXPECT_FALSE
(
controller_
-
>
last_send_data_params
(
)
.
ordered
)
;
}
TEST_F
(
SctpDataChannelTest
SendUnorderedAfterReceiveData
)
{
SetChannelReady
(
)
;
webrtc
:
:
InternalDataChannelInit
init
;
init
.
id
=
1
;
init
.
ordered
=
false
;
rtc
:
:
scoped_refptr
<
SctpDataChannel
>
dc
=
SctpDataChannel
:
:
Create
(
controller_
.
get
(
)
"
test1
"
init
rtc
:
:
Thread
:
:
Current
(
)
rtc
:
:
Thread
:
:
Current
(
)
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
dc
-
>
state
(
)
1000
)
;
cricket
:
:
ReceiveDataParams
params
;
params
.
sid
=
init
.
id
;
params
.
type
=
webrtc
:
:
DataMessageType
:
:
kText
;
webrtc
:
:
DataBuffer
buffer
(
"
data
"
)
;
dc
-
>
OnDataReceived
(
params
buffer
.
data
)
;
ASSERT_TRUE
(
dc
-
>
Send
(
buffer
)
)
;
EXPECT_FALSE
(
controller_
-
>
last_send_data_params
(
)
.
ordered
)
;
}
TEST_F
(
SctpDataChannelTest
OpenWaitsForOpenMesssage
)
{
webrtc
:
:
DataBuffer
buffer
(
"
foo
"
)
;
controller_
-
>
set_send_blocked
(
true
)
;
SetChannelReady
(
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kConnecting
webrtc_data_channel_
-
>
state
(
)
)
;
controller_
-
>
set_send_blocked
(
false
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
webrtc_data_channel_
-
>
state
(
)
1000
)
;
EXPECT_EQ
(
webrtc
:
:
DataMessageType
:
:
kControl
controller_
-
>
last_send_data_params
(
)
.
type
)
;
}
TEST_F
(
SctpDataChannelTest
QueuedCloseFlushes
)
{
webrtc
:
:
DataBuffer
buffer
(
"
foo
"
)
;
controller_
-
>
set_send_blocked
(
true
)
;
SetChannelReady
(
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kConnecting
webrtc_data_channel_
-
>
state
(
)
)
;
controller_
-
>
set_send_blocked
(
false
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
webrtc_data_channel_
-
>
state
(
)
1000
)
;
controller_
-
>
set_send_blocked
(
true
)
;
webrtc_data_channel_
-
>
Send
(
buffer
)
;
webrtc_data_channel_
-
>
Close
(
)
;
controller_
-
>
set_send_blocked
(
false
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kClosed
webrtc_data_channel_
-
>
state
(
)
1000
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
error
(
)
.
ok
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
DataMessageType
:
:
kText
controller_
-
>
last_send_data_params
(
)
.
type
)
;
}
TEST_F
(
SctpDataChannelTest
SendDataId
)
{
webrtc_data_channel_
-
>
SetSctpSid
(
1
)
;
SetChannelReady
(
)
;
webrtc
:
:
DataBuffer
buffer
(
"
data
"
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffer
)
)
;
EXPECT_EQ
(
1
controller_
-
>
last_sid
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
ReceiveDataWithInvalidId
)
{
webrtc_data_channel_
-
>
SetSctpSid
(
1
)
;
SetChannelReady
(
)
;
AddObserver
(
)
;
cricket
:
:
ReceiveDataParams
params
;
params
.
sid
=
0
;
webrtc
:
:
DataBuffer
buffer
(
"
abcd
"
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffer
.
data
)
;
EXPECT_EQ
(
0U
observer_
-
>
messages_received
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
ReceiveDataWithValidId
)
{
webrtc_data_channel_
-
>
SetSctpSid
(
1
)
;
SetChannelReady
(
)
;
AddObserver
(
)
;
cricket
:
:
ReceiveDataParams
params
;
params
.
sid
=
1
;
webrtc
:
:
DataBuffer
buffer
(
"
abcd
"
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffer
.
data
)
;
EXPECT_EQ
(
1U
observer_
-
>
messages_received
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
NoMsgSentIfNegotiatedAndNotFromOpenMsg
)
{
webrtc
:
:
InternalDataChannelInit
config
;
config
.
id
=
1
;
config
.
negotiated
=
true
;
config
.
open_handshake_role
=
webrtc
:
:
InternalDataChannelInit
:
:
kNone
;
SetChannelReady
(
)
;
rtc
:
:
scoped_refptr
<
SctpDataChannel
>
dc
=
SctpDataChannel
:
:
Create
(
controller_
.
get
(
)
"
test1
"
config
rtc
:
:
Thread
:
:
Current
(
)
rtc
:
:
Thread
:
:
Current
(
)
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
dc
-
>
state
(
)
1000
)
;
EXPECT_EQ
(
0
controller_
-
>
last_sid
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
VerifyMessagesAndBytesReceived
)
{
AddObserver
(
)
;
std
:
:
vector
<
webrtc
:
:
DataBuffer
>
buffers
(
{
webrtc
:
:
DataBuffer
(
"
message
1
"
)
webrtc
:
:
DataBuffer
(
"
msg
2
"
)
webrtc
:
:
DataBuffer
(
"
message
three
"
)
webrtc
:
:
DataBuffer
(
"
quadra
message
"
)
webrtc
:
:
DataBuffer
(
"
fifthmsg
"
)
webrtc
:
:
DataBuffer
(
"
message
of
the
beast
"
)
}
)
;
webrtc_data_channel_
-
>
SetSctpSid
(
1
)
;
cricket
:
:
ReceiveDataParams
params
;
params
.
sid
=
1
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
messages_received
(
)
)
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
bytes_received
(
)
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffers
[
0
]
.
data
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffers
[
1
]
.
data
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffers
[
2
]
.
data
)
;
EXPECT_EQ
(
0U
observer_
-
>
messages_received
(
)
)
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
messages_received
(
)
)
;
EXPECT_EQ
(
0U
webrtc_data_channel_
-
>
bytes_received
(
)
)
;
SetChannelReady
(
)
;
size_t
bytes_received
=
buffers
[
0
]
.
size
(
)
+
buffers
[
1
]
.
size
(
)
+
buffers
[
2
]
.
size
(
)
;
EXPECT_EQ
(
3U
observer_
-
>
messages_received
(
)
)
;
EXPECT_EQ
(
3U
webrtc_data_channel_
-
>
messages_received
(
)
)
;
EXPECT_EQ
(
bytes_received
webrtc_data_channel_
-
>
bytes_received
(
)
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffers
[
3
]
.
data
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffers
[
4
]
.
data
)
;
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffers
[
5
]
.
data
)
;
bytes_received
+
=
buffers
[
3
]
.
size
(
)
+
buffers
[
4
]
.
size
(
)
+
buffers
[
5
]
.
size
(
)
;
EXPECT_EQ
(
6U
observer_
-
>
messages_received
(
)
)
;
EXPECT_EQ
(
6U
webrtc_data_channel_
-
>
messages_received
(
)
)
;
EXPECT_EQ
(
bytes_received
webrtc_data_channel_
-
>
bytes_received
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
OpenAckSentIfCreatedFromOpenMessage
)
{
webrtc
:
:
InternalDataChannelInit
config
;
config
.
id
=
1
;
config
.
negotiated
=
true
;
config
.
open_handshake_role
=
webrtc
:
:
InternalDataChannelInit
:
:
kAcker
;
SetChannelReady
(
)
;
rtc
:
:
scoped_refptr
<
SctpDataChannel
>
dc
=
SctpDataChannel
:
:
Create
(
controller_
.
get
(
)
"
test1
"
config
rtc
:
:
Thread
:
:
Current
(
)
rtc
:
:
Thread
:
:
Current
(
)
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
dc
-
>
state
(
)
1000
)
;
EXPECT_EQ
(
config
.
id
controller_
-
>
last_sid
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
DataMessageType
:
:
kControl
controller_
-
>
last_send_data_params
(
)
.
type
)
;
}
TEST_F
(
SctpDataChannelTest
OpenAckRoleInitialization
)
{
webrtc
:
:
InternalDataChannelInit
init
;
EXPECT_EQ
(
webrtc
:
:
InternalDataChannelInit
:
:
kOpener
init
.
open_handshake_role
)
;
EXPECT_FALSE
(
init
.
negotiated
)
;
webrtc
:
:
DataChannelInit
base
;
base
.
negotiated
=
true
;
webrtc
:
:
InternalDataChannelInit
init2
(
base
)
;
EXPECT_EQ
(
webrtc
:
:
InternalDataChannelInit
:
:
kNone
init2
.
open_handshake_role
)
;
}
TEST_F
(
SctpDataChannelTest
OpenWhenSendBufferFull
)
{
SetChannelReady
(
)
;
const
size_t
packetSize
=
1024
;
rtc
:
:
CopyOnWriteBuffer
buffer
(
packetSize
)
;
memset
(
buffer
.
MutableData
(
)
0
buffer
.
size
(
)
)
;
webrtc
:
:
DataBuffer
packet
(
buffer
true
)
;
controller_
-
>
set_send_blocked
(
true
)
;
for
(
size_t
i
=
0
;
i
<
webrtc
:
:
DataChannelInterface
:
:
MaxSendQueueSize
(
)
/
packetSize
;
+
+
i
)
{
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
packet
)
)
;
}
EXPECT_FALSE
(
webrtc_data_channel_
-
>
Send
(
packet
)
)
;
EXPECT_TRUE
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
=
=
webrtc_data_channel_
-
>
state
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
ClosedOnTransportError
)
{
SetChannelReady
(
)
;
webrtc
:
:
DataBuffer
buffer
(
"
abcd
"
)
;
controller_
-
>
set_transport_error
(
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffer
)
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kClosed
webrtc_data_channel_
-
>
state
(
)
)
;
EXPECT_FALSE
(
webrtc_data_channel_
-
>
error
(
)
.
ok
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorType
:
:
NETWORK_ERROR
webrtc_data_channel_
-
>
error
(
)
.
type
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorDetailType
:
:
NONE
webrtc_data_channel_
-
>
error
(
)
.
error_detail
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
ClosedWhenReceivedBufferFull
)
{
SetChannelReady
(
)
;
rtc
:
:
CopyOnWriteBuffer
buffer
(
1024
)
;
memset
(
buffer
.
MutableData
(
)
0
buffer
.
size
(
)
)
;
cricket
:
:
ReceiveDataParams
params
;
params
.
sid
=
0
;
for
(
size_t
i
=
0
;
i
<
16
*
1024
+
1
;
+
+
i
)
{
webrtc_data_channel_
-
>
OnDataReceived
(
params
buffer
)
;
}
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kClosed
webrtc_data_channel_
-
>
state
(
)
)
;
EXPECT_FALSE
(
webrtc_data_channel_
-
>
error
(
)
.
ok
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorType
:
:
RESOURCE_EXHAUSTED
webrtc_data_channel_
-
>
error
(
)
.
type
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorDetailType
:
:
NONE
webrtc_data_channel_
-
>
error
(
)
.
error_detail
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
SendEmptyData
)
{
webrtc_data_channel_
-
>
SetSctpSid
(
1
)
;
SetChannelReady
(
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
webrtc_data_channel_
-
>
state
(
)
)
;
webrtc
:
:
DataBuffer
buffer
(
"
"
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
buffer
)
)
;
EXPECT_EQ
(
webrtc
:
:
DataChannelInterface
:
:
kOpen
webrtc_data_channel_
-
>
state
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
NeverOpened
)
{
controller_
-
>
set_transport_available
(
true
)
;
webrtc_data_channel_
-
>
OnTransportChannelCreated
(
)
;
webrtc_data_channel_
-
>
Close
(
)
;
}
TEST_F
(
SctpDataChannelTest
TransportDestroyedWhileDataBuffered
)
{
SetChannelReady
(
)
;
rtc
:
:
CopyOnWriteBuffer
buffer
(
1024
)
;
memset
(
buffer
.
MutableData
(
)
0
buffer
.
size
(
)
)
;
webrtc
:
:
DataBuffer
packet
(
buffer
true
)
;
controller_
-
>
set_send_blocked
(
true
)
;
EXPECT_TRUE
(
webrtc_data_channel_
-
>
Send
(
packet
)
)
;
webrtc
:
:
RTCError
error
(
webrtc
:
:
RTCErrorType
:
:
OPERATION_ERROR_WITH_DATA
"
"
)
;
error
.
set_error_detail
(
webrtc
:
:
RTCErrorDetailType
:
:
SCTP_FAILURE
)
;
webrtc_data_channel_
-
>
OnTransportChannelClosed
(
error
)
;
controller_
.
reset
(
nullptr
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kClosed
webrtc_data_channel_
-
>
state
(
)
kDefaultTimeout
)
;
EXPECT_FALSE
(
webrtc_data_channel_
-
>
error
(
)
.
ok
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorType
:
:
OPERATION_ERROR_WITH_DATA
webrtc_data_channel_
-
>
error
(
)
.
type
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorDetailType
:
:
SCTP_FAILURE
webrtc_data_channel_
-
>
error
(
)
.
error_detail
(
)
)
;
}
TEST_F
(
SctpDataChannelTest
TransportGotErrorCode
)
{
SetChannelReady
(
)
;
webrtc
:
:
RTCError
error
(
webrtc
:
:
RTCErrorType
:
:
OPERATION_ERROR_WITH_DATA
"
Transport
channel
closed
"
)
;
error
.
set_error_detail
(
webrtc
:
:
RTCErrorDetailType
:
:
SCTP_FAILURE
)
;
error
.
set_sctp_cause_code
(
static_cast
<
uint16_t
>
(
cricket
:
:
SctpErrorCauseCode
:
:
kProtocolViolation
)
)
;
webrtc_data_channel_
-
>
OnTransportChannelClosed
(
error
)
;
controller_
.
reset
(
nullptr
)
;
EXPECT_EQ_WAIT
(
webrtc
:
:
DataChannelInterface
:
:
kClosed
webrtc_data_channel_
-
>
state
(
)
kDefaultTimeout
)
;
EXPECT_FALSE
(
webrtc_data_channel_
-
>
error
(
)
.
ok
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorType
:
:
OPERATION_ERROR_WITH_DATA
webrtc_data_channel_
-
>
error
(
)
.
type
(
)
)
;
EXPECT_EQ
(
webrtc
:
:
RTCErrorDetailType
:
:
SCTP_FAILURE
webrtc_data_channel_
-
>
error
(
)
.
error_detail
(
)
)
;
EXPECT_EQ
(
static_cast
<
uint16_t
>
(
cricket
:
:
SctpErrorCauseCode
:
:
kProtocolViolation
)
webrtc_data_channel_
-
>
error
(
)
.
sctp_cause_code
(
)
)
;
}
class
SctpSidAllocatorTest
:
public
:
:
testing
:
:
Test
{
protected
:
SctpSidAllocator
allocator_
;
}
;
TEST_F
(
SctpSidAllocatorTest
SctpIdAllocationBasedOnRole
)
{
int
id
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_SERVER
&
id
)
)
;
EXPECT_EQ
(
1
id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_CLIENT
&
id
)
)
;
EXPECT_EQ
(
0
id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_SERVER
&
id
)
)
;
EXPECT_EQ
(
3
id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_CLIENT
&
id
)
)
;
EXPECT_EQ
(
2
id
)
;
}
TEST_F
(
SctpSidAllocatorTest
SctpIdAllocationNoReuse
)
{
int
old_id
=
1
;
EXPECT_TRUE
(
allocator_
.
ReserveSid
(
old_id
)
)
;
int
new_id
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_SERVER
&
new_id
)
)
;
EXPECT_NE
(
old_id
new_id
)
;
old_id
=
0
;
EXPECT_TRUE
(
allocator_
.
ReserveSid
(
old_id
)
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_CLIENT
&
new_id
)
)
;
EXPECT_NE
(
old_id
new_id
)
;
}
TEST_F
(
SctpSidAllocatorTest
SctpIdReusedForRemovedDataChannel
)
{
int
odd_id
=
1
;
int
even_id
=
0
;
EXPECT_TRUE
(
allocator_
.
ReserveSid
(
odd_id
)
)
;
EXPECT_TRUE
(
allocator_
.
ReserveSid
(
even_id
)
)
;
int
allocated_id
=
-
1
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_SERVER
&
allocated_id
)
)
;
EXPECT_EQ
(
odd_id
+
2
allocated_id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_CLIENT
&
allocated_id
)
)
;
EXPECT_EQ
(
even_id
+
2
allocated_id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_SERVER
&
allocated_id
)
)
;
EXPECT_EQ
(
odd_id
+
4
allocated_id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_CLIENT
&
allocated_id
)
)
;
EXPECT_EQ
(
even_id
+
4
allocated_id
)
;
allocator_
.
ReleaseSid
(
odd_id
)
;
allocator_
.
ReleaseSid
(
even_id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_SERVER
&
allocated_id
)
)
;
EXPECT_EQ
(
odd_id
allocated_id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_CLIENT
&
allocated_id
)
)
;
EXPECT_EQ
(
even_id
allocated_id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_SERVER
&
allocated_id
)
)
;
EXPECT_EQ
(
odd_id
+
6
allocated_id
)
;
EXPECT_TRUE
(
allocator_
.
AllocateSid
(
rtc
:
:
SSL_CLIENT
&
allocated_id
)
)
;
EXPECT_EQ
(
even_id
+
6
allocated_id
)
;
}
