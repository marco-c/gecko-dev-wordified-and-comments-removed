#
ifndef
PC_VIDEO_RTP_RECEIVER_H_
#
define
PC_VIDEO_RTP_RECEIVER_H_
#
include
<
stdint
.
h
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
absl
/
types
/
optional
.
h
"
#
include
"
api
/
crypto
/
frame_decryptor_interface
.
h
"
#
include
"
api
/
dtls_transport_interface
.
h
"
#
include
"
api
/
frame_transformer_interface
.
h
"
#
include
"
api
/
media_stream_interface
.
h
"
#
include
"
api
/
media_stream_track_proxy
.
h
"
#
include
"
api
/
media_types
.
h
"
#
include
"
api
/
rtp_parameters
.
h
"
#
include
"
api
/
rtp_receiver_interface
.
h
"
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
api
/
transport
/
rtp
/
rtp_source
.
h
"
#
include
"
api
/
video
/
video_frame
.
h
"
#
include
"
api
/
video
/
video_sink_interface
.
h
"
#
include
"
api
/
video
/
video_source_interface
.
h
"
#
include
"
media
/
base
/
media_channel
.
h
"
#
include
"
pc
/
jitter_buffer_delay
.
h
"
#
include
"
pc
/
rtp_receiver
.
h
"
#
include
"
pc
/
video_rtp_track_source
.
h
"
#
include
"
pc
/
video_track
.
h
"
#
include
"
rtc_base
/
ref_counted_object
.
h
"
#
include
"
rtc_base
/
system
/
no_unique_address
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
namespace
webrtc
{
class
VideoRtpReceiver
:
public
RtpReceiverInternal
{
public
:
VideoRtpReceiver
(
rtc
:
:
Thread
*
worker_thread
std
:
:
string
receiver_id
std
:
:
vector
<
std
:
:
string
>
streams_ids
)
;
VideoRtpReceiver
(
rtc
:
:
Thread
*
worker_thread
const
std
:
:
string
&
receiver_id
const
std
:
:
vector
<
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
>
&
streams
)
;
virtual
~
VideoRtpReceiver
(
)
;
rtc
:
:
scoped_refptr
<
VideoTrackInterface
>
video_track
(
)
const
{
return
track_
;
}
rtc
:
:
scoped_refptr
<
MediaStreamTrackInterface
>
track
(
)
const
override
{
return
track_
;
}
rtc
:
:
scoped_refptr
<
DtlsTransportInterface
>
dtls_transport
(
)
const
override
;
std
:
:
vector
<
std
:
:
string
>
stream_ids
(
)
const
override
;
std
:
:
vector
<
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
>
streams
(
)
const
override
;
cricket
:
:
MediaType
media_type
(
)
const
override
{
return
cricket
:
:
MEDIA_TYPE_VIDEO
;
}
std
:
:
string
id
(
)
const
override
{
return
id_
;
}
RtpParameters
GetParameters
(
)
const
override
;
void
SetFrameDecryptor
(
rtc
:
:
scoped_refptr
<
FrameDecryptorInterface
>
frame_decryptor
)
override
;
rtc
:
:
scoped_refptr
<
FrameDecryptorInterface
>
GetFrameDecryptor
(
)
const
override
;
void
SetDepacketizerToDecoderFrameTransformer
(
rtc
:
:
scoped_refptr
<
FrameTransformerInterface
>
frame_transformer
)
override
;
void
Stop
(
)
override
;
void
StopAndEndTrack
(
)
override
;
void
SetupMediaChannel
(
uint32_t
ssrc
)
override
;
void
SetupUnsignaledMediaChannel
(
)
override
;
uint32_t
ssrc
(
)
const
override
;
void
NotifyFirstPacketReceived
(
)
override
;
void
set_stream_ids
(
std
:
:
vector
<
std
:
:
string
>
stream_ids
)
override
;
void
set_transport
(
rtc
:
:
scoped_refptr
<
DtlsTransportInterface
>
dtls_transport
)
override
;
void
SetStreams
(
const
std
:
:
vector
<
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
>
&
streams
)
override
;
void
SetObserver
(
RtpReceiverObserverInterface
*
observer
)
override
;
void
SetJitterBufferMinimumDelay
(
absl
:
:
optional
<
double
>
delay_seconds
)
override
;
void
SetMediaChannel
(
cricket
:
:
MediaChannel
*
media_channel
)
override
;
int
AttachmentId
(
)
const
override
{
return
attachment_id_
;
}
std
:
:
vector
<
RtpSource
>
GetSources
(
)
const
override
;
private
:
void
RestartMediaChannel
(
absl
:
:
optional
<
uint32_t
>
ssrc
)
;
void
SetSink
(
rtc
:
:
VideoSinkInterface
<
VideoFrame
>
*
sink
)
RTC_RUN_ON
(
worker_thread_
)
;
void
SetMediaChannel_w
(
cricket
:
:
MediaChannel
*
media_channel
)
RTC_RUN_ON
(
worker_thread_
)
;
void
OnGenerateKeyFrame
(
)
;
void
OnEncodedSinkEnabled
(
bool
enable
)
;
void
SetEncodedSinkEnabled
(
bool
enable
)
RTC_RUN_ON
(
worker_thread_
)
;
class
SourceCallback
:
public
VideoRtpTrackSource
:
:
Callback
{
public
:
explicit
SourceCallback
(
VideoRtpReceiver
*
receiver
)
:
receiver_
(
receiver
)
{
}
~
SourceCallback
(
)
override
=
default
;
private
:
void
OnGenerateKeyFrame
(
)
override
{
receiver_
-
>
OnGenerateKeyFrame
(
)
;
}
void
OnEncodedSinkEnabled
(
bool
enable
)
override
{
receiver_
-
>
OnEncodedSinkEnabled
(
enable
)
;
}
VideoRtpReceiver
*
const
receiver_
;
}
source_callback_
{
this
}
;
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
signaling_thread_checker_
;
rtc
:
:
Thread
*
const
worker_thread_
;
const
std
:
:
string
id_
;
cricket
:
:
VideoMediaChannel
*
media_channel_
RTC_GUARDED_BY
(
worker_thread_
)
=
nullptr
;
absl
:
:
optional
<
uint32_t
>
ssrc_
RTC_GUARDED_BY
(
worker_thread_
)
;
const
rtc
:
:
scoped_refptr
<
VideoRtpTrackSource
>
source_
;
const
rtc
:
:
scoped_refptr
<
VideoTrackProxyWithInternal
<
VideoTrack
>
>
track_
;
std
:
:
vector
<
rtc
:
:
scoped_refptr
<
MediaStreamInterface
>
>
streams_
RTC_GUARDED_BY
(
&
signaling_thread_checker_
)
;
bool
stopped_
RTC_GUARDED_BY
(
&
signaling_thread_checker_
)
=
true
;
RtpReceiverObserverInterface
*
observer_
RTC_GUARDED_BY
(
&
signaling_thread_checker_
)
=
nullptr
;
bool
received_first_packet_
RTC_GUARDED_BY
(
&
signaling_thread_checker_
)
=
false
;
const
int
attachment_id_
;
rtc
:
:
scoped_refptr
<
FrameDecryptorInterface
>
frame_decryptor_
RTC_GUARDED_BY
(
worker_thread_
)
;
rtc
:
:
scoped_refptr
<
DtlsTransportInterface
>
dtls_transport_
RTC_GUARDED_BY
(
&
signaling_thread_checker_
)
;
rtc
:
:
scoped_refptr
<
FrameTransformerInterface
>
frame_transformer_
RTC_GUARDED_BY
(
worker_thread_
)
;
JitterBufferDelay
delay_
RTC_GUARDED_BY
(
worker_thread_
)
;
bool
saved_generate_keyframe_
RTC_GUARDED_BY
(
worker_thread_
)
=
false
;
bool
saved_encoded_sink_enabled_
RTC_GUARDED_BY
(
worker_thread_
)
=
false
;
}
;
}
#
endif
