#
include
"
pc
/
data_channel_controller
.
h
"
#
include
<
memory
>
#
include
"
pc
/
peer_connection_internal
.
h
"
#
include
"
pc
/
sctp_data_channel
.
h
"
#
include
"
pc
/
test
/
mock_peer_connection_internal
.
h
"
#
include
"
rtc_base
/
null_socket_server
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
run_loop
.
h
"
namespace
webrtc
{
namespace
{
using
:
:
testing
:
:
NiceMock
;
using
:
:
testing
:
:
Return
;
class
MockDataChannelTransport
:
public
webrtc
:
:
DataChannelTransportInterface
{
public
:
~
MockDataChannelTransport
(
)
override
{
}
MOCK_METHOD
(
RTCError
OpenChannel
(
int
channel_id
)
(
override
)
)
;
MOCK_METHOD
(
RTCError
SendData
(
int
channel_id
const
SendDataParams
&
params
const
rtc
:
:
CopyOnWriteBuffer
&
buffer
)
(
override
)
)
;
MOCK_METHOD
(
RTCError
CloseChannel
(
int
channel_id
)
(
override
)
)
;
MOCK_METHOD
(
void
SetDataSink
(
DataChannelSink
*
sink
)
(
override
)
)
;
MOCK_METHOD
(
bool
IsReadyToSend
(
)
(
const
override
)
)
;
}
;
class
DataChannelControllerTest
:
public
:
:
testing
:
:
Test
{
protected
:
DataChannelControllerTest
(
)
:
network_thread_
(
std
:
:
make_unique
<
rtc
:
:
NullSocketServer
>
(
)
)
{
network_thread_
.
Start
(
)
;
pc_
=
rtc
:
:
make_ref_counted
<
NiceMock
<
MockPeerConnectionInternal
>
>
(
)
;
ON_CALL
(
*
pc_
signaling_thread
)
.
WillByDefault
(
Return
(
rtc
:
:
Thread
:
:
Current
(
)
)
)
;
ON_CALL
(
*
pc_
network_thread
)
.
WillByDefault
(
Return
(
&
network_thread_
)
)
;
}
~
DataChannelControllerTest
(
)
override
{
run_loop_
.
Flush
(
)
;
network_thread_
.
Stop
(
)
;
}
test
:
:
RunLoop
run_loop_
;
rtc
:
:
Thread
network_thread_
;
rtc
:
:
scoped_refptr
<
NiceMock
<
MockPeerConnectionInternal
>
>
pc_
;
}
;
TEST_F
(
DataChannelControllerTest
CreateAndDestroy
)
{
DataChannelController
dcc
(
pc_
.
get
(
)
)
;
}
TEST_F
(
DataChannelControllerTest
CreateDataChannelEarlyRelease
)
{
DataChannelController
dcc
(
pc_
.
get
(
)
)
;
auto
channel
=
dcc
.
InternalCreateDataChannelWithProxy
(
"
label
"
InternalDataChannelInit
(
DataChannelInit
(
)
)
)
;
channel
=
nullptr
;
}
TEST_F
(
DataChannelControllerTest
CreateDataChannelEarlyClose
)
{
DataChannelController
dcc
(
pc_
.
get
(
)
)
;
EXPECT_FALSE
(
dcc
.
HasDataChannels
(
)
)
;
EXPECT_FALSE
(
dcc
.
HasUsedDataChannels
(
)
)
;
auto
channel
=
dcc
.
InternalCreateDataChannelWithProxy
(
"
label
"
InternalDataChannelInit
(
DataChannelInit
(
)
)
)
;
EXPECT_TRUE
(
dcc
.
HasDataChannels
(
)
)
;
EXPECT_TRUE
(
dcc
.
HasUsedDataChannels
(
)
)
;
channel
-
>
Close
(
)
;
EXPECT_FALSE
(
dcc
.
HasDataChannels
(
)
)
;
EXPECT_TRUE
(
dcc
.
HasUsedDataChannels
(
)
)
;
}
TEST_F
(
DataChannelControllerTest
CreateDataChannelLateRelease
)
{
auto
dcc
=
std
:
:
make_unique
<
DataChannelController
>
(
pc_
.
get
(
)
)
;
auto
channel
=
dcc
-
>
InternalCreateDataChannelWithProxy
(
"
label
"
InternalDataChannelInit
(
DataChannelInit
(
)
)
)
;
dcc
.
reset
(
)
;
channel
=
nullptr
;
}
TEST_F
(
DataChannelControllerTest
CloseAfterControllerDestroyed
)
{
auto
dcc
=
std
:
:
make_unique
<
DataChannelController
>
(
pc_
.
get
(
)
)
;
auto
channel
=
dcc
-
>
InternalCreateDataChannelWithProxy
(
"
label
"
InternalDataChannelInit
(
DataChannelInit
(
)
)
)
;
dcc
.
reset
(
)
;
channel
-
>
Close
(
)
;
}
TEST_F
(
DataChannelControllerTest
AsyncChannelCloseTeardown
)
{
DataChannelController
dcc
(
pc_
.
get
(
)
)
;
rtc
:
:
scoped_refptr
<
DataChannelInterface
>
channel
=
dcc
.
InternalCreateDataChannelWithProxy
(
"
label
"
InternalDataChannelInit
(
DataChannelInit
(
)
)
)
;
SctpDataChannel
*
inner_channel
=
DowncastProxiedDataChannelInterfaceToSctpDataChannelForTesting
(
channel
.
get
(
)
)
;
inner_channel
-
>
AddRef
(
)
;
channel
=
nullptr
;
EXPECT_TRUE
(
dcc
.
HasDataChannels
(
)
)
;
inner_channel
-
>
Close
(
)
;
EXPECT_FALSE
(
dcc
.
HasDataChannels
(
)
)
;
ASSERT_NE
(
inner_channel
-
>
Release
(
)
rtc
:
:
RefCountReleaseStatus
:
:
kDroppedLastRef
)
;
inner_channel
-
>
AddRef
(
)
;
run_loop_
.
Flush
(
)
;
EXPECT_EQ
(
inner_channel
-
>
Release
(
)
rtc
:
:
RefCountReleaseStatus
:
:
kDroppedLastRef
)
;
}
TEST_F
(
DataChannelControllerTest
MaxChannels
)
{
NiceMock
<
MockDataChannelTransport
>
transport
;
int
channel_id
=
0
;
ON_CALL
(
*
pc_
GetSctpSslRole_n
)
.
WillByDefault
(
[
&
]
(
)
{
return
absl
:
:
optional
<
rtc
:
:
SSLRole
>
(
(
channel_id
&
1
)
?
rtc
:
:
SSL_SERVER
:
rtc
:
:
SSL_CLIENT
)
;
}
)
;
DataChannelController
dcc
(
pc_
.
get
(
)
)
;
pc_
-
>
network_thread
(
)
-
>
BlockingCall
(
[
&
]
{
dcc
.
set_data_channel_transport
(
&
transport
)
;
}
)
;
for
(
channel_id
=
0
;
channel_id
<
=
cricket
:
:
kMaxSctpStreams
;
+
+
channel_id
)
{
rtc
:
:
scoped_refptr
<
DataChannelInterface
>
channel
=
dcc
.
InternalCreateDataChannelWithProxy
(
"
label
"
InternalDataChannelInit
(
DataChannelInit
(
)
)
)
;
if
(
channel_id
=
=
cricket
:
:
kMaxSctpStreams
)
{
EXPECT_FALSE
(
channel
.
get
(
)
)
;
}
else
{
EXPECT_TRUE
(
channel
.
get
(
)
)
;
}
}
}
}
}
