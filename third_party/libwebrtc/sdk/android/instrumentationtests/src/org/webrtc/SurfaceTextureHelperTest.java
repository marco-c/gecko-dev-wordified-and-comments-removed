package
org
.
webrtc
;
import
static
org
.
junit
.
Assert
.
assertEquals
;
import
static
org
.
junit
.
Assert
.
assertTrue
;
import
static
org
.
junit
.
Assert
.
fail
;
import
android
.
opengl
.
GLES20
;
import
android
.
os
.
SystemClock
;
import
androidx
.
annotation
.
Nullable
;
import
androidx
.
test
.
filters
.
MediumTest
;
import
androidx
.
test
.
filters
.
SmallTest
;
import
java
.
nio
.
ByteBuffer
;
import
java
.
util
.
concurrent
.
CountDownLatch
;
import
org
.
junit
.
Before
;
import
org
.
junit
.
Test
;
public
class
SurfaceTextureHelperTest
{
public
static
final
class
MockTextureListener
implements
VideoSink
{
private
final
Object
lock
=
new
Object
(
)
;
private
Nullable
VideoFrame
.
TextureBuffer
textureBuffer
;
private
final
Nullable
Thread
expectedThread
;
MockTextureListener
(
)
{
this
.
expectedThread
=
null
;
}
MockTextureListener
(
Thread
expectedThread
)
{
this
.
expectedThread
=
expectedThread
;
}
Override
public
void
onFrame
(
VideoFrame
frame
)
{
if
(
expectedThread
!
=
null
&
&
Thread
.
currentThread
(
)
!
=
expectedThread
)
{
throw
new
IllegalStateException
(
"
onTextureFrameAvailable
called
on
wrong
thread
.
"
)
;
}
synchronized
(
lock
)
{
this
.
textureBuffer
=
(
VideoFrame
.
TextureBuffer
)
frame
.
getBuffer
(
)
;
textureBuffer
.
retain
(
)
;
lock
.
notifyAll
(
)
;
}
}
public
VideoFrame
.
TextureBuffer
waitForTextureBuffer
(
)
throws
InterruptedException
{
synchronized
(
lock
)
{
while
(
true
)
{
final
VideoFrame
.
TextureBuffer
textureBufferToReturn
=
textureBuffer
;
if
(
textureBufferToReturn
!
=
null
)
{
textureBuffer
=
null
;
return
textureBufferToReturn
;
}
lock
.
wait
(
)
;
}
}
}
public
void
assertNoFrameIsDelivered
(
final
long
waitPeriodMs
)
throws
InterruptedException
{
final
long
startTimeMs
=
SystemClock
.
elapsedRealtime
(
)
;
long
timeRemainingMs
=
waitPeriodMs
;
synchronized
(
lock
)
{
while
(
textureBuffer
=
=
null
&
&
timeRemainingMs
>
0
)
{
lock
.
wait
(
timeRemainingMs
)
;
final
long
elapsedTimeMs
=
SystemClock
.
elapsedRealtime
(
)
-
startTimeMs
;
timeRemainingMs
=
waitPeriodMs
-
elapsedTimeMs
;
}
assertTrue
(
textureBuffer
=
=
null
)
;
}
}
}
public
static
void
assertClose
(
int
threshold
int
expected
int
actual
)
{
if
(
Math
.
abs
(
expected
-
actual
)
<
=
threshold
)
return
;
fail
(
"
Not
close
enough
threshold
"
+
threshold
+
"
.
Expected
:
"
+
expected
+
"
Actual
:
"
+
actual
)
;
}
Before
public
void
setUp
(
)
{
NativeLibrary
.
initialize
(
new
NativeLibrary
.
DefaultLoader
(
)
TestConstants
.
NATIVE_LIBRARY
)
;
}
Test
MediumTest
public
void
testThreeConstantColorFrames
(
)
throws
InterruptedException
{
final
int
width
=
16
;
final
int
height
=
16
;
final
EglBase
eglBase
=
EglBase
.
create
(
null
EglBase
.
CONFIG_PIXEL_BUFFER
)
;
eglBase
.
createPbufferSurface
(
width
height
)
;
final
GlRectDrawer
drawer
=
new
GlRectDrawer
(
)
;
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
eglBase
.
getEglBaseContext
(
)
)
;
final
MockTextureListener
listener
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
surfaceTextureHelper
.
setTextureSize
(
width
height
)
;
final
EglBase
eglOesBase
=
EglBase
.
create
(
eglBase
.
getEglBaseContext
(
)
EglBase
.
CONFIG_PLAIN
)
;
eglOesBase
.
createSurface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
;
assertEquals
(
eglOesBase
.
surfaceWidth
(
)
width
)
;
assertEquals
(
eglOesBase
.
surfaceHeight
(
)
height
)
;
final
int
red
[
]
=
new
int
[
]
{
79
144
185
}
;
final
int
green
[
]
=
new
int
[
]
{
66
210
162
}
;
final
int
blue
[
]
=
new
int
[
]
{
161
117
158
}
;
for
(
int
i
=
0
;
i
<
3
;
+
+
i
)
{
eglOesBase
.
makeCurrent
(
)
;
GLES20
.
glClearColor
(
red
[
i
]
/
255
.
0f
green
[
i
]
/
255
.
0f
blue
[
i
]
/
255
.
0f
1
.
0f
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglOesBase
.
swapBuffers
(
)
;
final
VideoFrame
.
TextureBuffer
textureBuffer
=
listener
.
waitForTextureBuffer
(
)
;
eglBase
.
makeCurrent
(
)
;
drawer
.
drawOes
(
textureBuffer
.
getTextureId
(
)
RendererCommon
.
convertMatrixFromAndroidGraphicsMatrix
(
textureBuffer
.
getTransformMatrix
(
)
)
width
height
0
0
width
height
)
;
textureBuffer
.
release
(
)
;
final
ByteBuffer
rgbaData
=
ByteBuffer
.
allocateDirect
(
width
*
height
*
4
)
;
GLES20
.
glReadPixels
(
0
0
width
height
GLES20
.
GL_RGBA
GLES20
.
GL_UNSIGNED_BYTE
rgbaData
)
;
GlUtil
.
checkNoGLES2Error
(
"
glReadPixels
"
)
;
while
(
rgbaData
.
hasRemaining
(
)
)
{
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
red
[
i
]
)
;
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
green
[
i
]
)
;
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
blue
[
i
]
)
;
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
255
)
;
}
}
drawer
.
release
(
)
;
surfaceTextureHelper
.
dispose
(
)
;
eglBase
.
release
(
)
;
}
Test
MediumTest
public
void
testLateReturnFrame
(
)
throws
InterruptedException
{
final
int
width
=
16
;
final
int
height
=
16
;
final
EglBase
eglBase
=
EglBase
.
create
(
null
EglBase
.
CONFIG_PIXEL_BUFFER
)
;
eglBase
.
createPbufferSurface
(
width
height
)
;
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
eglBase
.
getEglBaseContext
(
)
)
;
final
MockTextureListener
listener
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
surfaceTextureHelper
.
setTextureSize
(
width
height
)
;
final
EglBase
eglOesBase
=
EglBase
.
create
(
eglBase
.
getEglBaseContext
(
)
EglBase
.
CONFIG_PLAIN
)
;
eglOesBase
.
createSurface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
;
assertEquals
(
eglOesBase
.
surfaceWidth
(
)
width
)
;
assertEquals
(
eglOesBase
.
surfaceHeight
(
)
height
)
;
final
int
red
=
79
;
final
int
green
=
66
;
final
int
blue
=
161
;
eglOesBase
.
makeCurrent
(
)
;
GLES20
.
glClearColor
(
red
/
255
.
0f
green
/
255
.
0f
blue
/
255
.
0f
1
.
0f
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglOesBase
.
swapBuffers
(
)
;
eglOesBase
.
release
(
)
;
final
VideoFrame
.
TextureBuffer
textureBuffer
=
listener
.
waitForTextureBuffer
(
)
;
surfaceTextureHelper
.
dispose
(
)
;
eglBase
.
makeCurrent
(
)
;
final
GlRectDrawer
drawer
=
new
GlRectDrawer
(
)
;
drawer
.
drawOes
(
textureBuffer
.
getTextureId
(
)
RendererCommon
.
convertMatrixFromAndroidGraphicsMatrix
(
textureBuffer
.
getTransformMatrix
(
)
)
width
height
0
0
width
height
)
;
drawer
.
release
(
)
;
final
ByteBuffer
rgbaData
=
ByteBuffer
.
allocateDirect
(
width
*
height
*
4
)
;
GLES20
.
glReadPixels
(
0
0
width
height
GLES20
.
GL_RGBA
GLES20
.
GL_UNSIGNED_BYTE
rgbaData
)
;
GlUtil
.
checkNoGLES2Error
(
"
glReadPixels
"
)
;
eglBase
.
release
(
)
;
while
(
rgbaData
.
hasRemaining
(
)
)
{
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
red
)
;
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
green
)
;
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
blue
)
;
assertEquals
(
rgbaData
.
get
(
)
&
0xFF
255
)
;
}
textureBuffer
.
release
(
)
;
}
Test
MediumTest
public
void
testDispose
(
)
throws
InterruptedException
{
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
null
)
;
final
MockTextureListener
listener
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
final
EglBase
eglBase
=
EglBase
.
create
(
null
EglBase
.
CONFIG_PLAIN
)
;
surfaceTextureHelper
.
setTextureSize
(
32
32
)
;
eglBase
.
createSurface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
;
eglBase
.
makeCurrent
(
)
;
listener
.
assertNoFrameIsDelivered
(
1
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglBase
.
swapBuffers
(
)
;
listener
.
waitForTextureBuffer
(
)
.
release
(
)
;
surfaceTextureHelper
.
dispose
(
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglBase
.
swapBuffers
(
)
;
listener
.
assertNoFrameIsDelivered
(
500
)
;
eglBase
.
release
(
)
;
}
Test
SmallTest
public
void
testDisposeImmediately
(
)
{
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
null
)
;
surfaceTextureHelper
.
dispose
(
)
;
}
Test
MediumTest
public
void
testStopListening
(
)
throws
InterruptedException
{
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
null
)
;
surfaceTextureHelper
.
setTextureSize
(
32
32
)
;
final
MockTextureListener
listener
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
final
EglBase
eglBase
=
EglBase
.
create
(
null
EglBase
.
CONFIG_PLAIN
)
;
eglBase
.
createSurface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
;
eglBase
.
makeCurrent
(
)
;
listener
.
assertNoFrameIsDelivered
(
1
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglBase
.
swapBuffers
(
)
;
listener
.
waitForTextureBuffer
(
)
.
release
(
)
;
surfaceTextureHelper
.
stopListening
(
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglBase
.
swapBuffers
(
)
;
listener
.
assertNoFrameIsDelivered
(
500
)
;
surfaceTextureHelper
.
dispose
(
)
;
eglBase
.
release
(
)
;
}
Test
SmallTest
public
void
testStopListeningImmediately
(
)
throws
InterruptedException
{
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
null
)
;
final
MockTextureListener
listener
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
surfaceTextureHelper
.
stopListening
(
)
;
surfaceTextureHelper
.
dispose
(
)
;
}
Test
SmallTest
public
void
testStopListeningImmediatelyOnHandlerThread
(
)
throws
InterruptedException
{
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
null
)
;
final
MockTextureListener
listener
=
new
MockTextureListener
(
)
;
final
CountDownLatch
stopListeningBarrier
=
new
CountDownLatch
(
1
)
;
final
CountDownLatch
stopListeningBarrierDone
=
new
CountDownLatch
(
1
)
;
surfaceTextureHelper
.
getHandler
(
)
.
post
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
ThreadUtils
.
awaitUninterruptibly
(
stopListeningBarrier
)
;
surfaceTextureHelper
.
stopListening
(
)
;
stopListeningBarrierDone
.
countDown
(
)
;
}
}
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
stopListeningBarrier
.
countDown
(
)
;
stopListeningBarrierDone
.
await
(
)
;
final
CountDownLatch
barrier
=
new
CountDownLatch
(
1
)
;
surfaceTextureHelper
.
getHandler
(
)
.
post
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
barrier
.
countDown
(
)
;
}
}
)
;
ThreadUtils
.
awaitUninterruptibly
(
barrier
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
surfaceTextureHelper
.
dispose
(
)
;
}
Test
MediumTest
public
void
testRestartListeningWithNewListener
(
)
throws
InterruptedException
{
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
null
)
;
surfaceTextureHelper
.
setTextureSize
(
32
32
)
;
final
MockTextureListener
listener1
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener1
)
;
final
EglBase
eglBase
=
EglBase
.
create
(
null
EglBase
.
CONFIG_PLAIN
)
;
eglBase
.
createSurface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
;
eglBase
.
makeCurrent
(
)
;
listener1
.
assertNoFrameIsDelivered
(
1
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglBase
.
swapBuffers
(
)
;
listener1
.
waitForTextureBuffer
(
)
.
release
(
)
;
surfaceTextureHelper
.
stopListening
(
)
;
final
MockTextureListener
listener2
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener2
)
;
listener2
.
assertNoFrameIsDelivered
(
1
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglBase
.
swapBuffers
(
)
;
listener2
.
waitForTextureBuffer
(
)
.
release
(
)
;
listener1
.
assertNoFrameIsDelivered
(
1
)
;
surfaceTextureHelper
.
dispose
(
)
;
eglBase
.
release
(
)
;
}
Test
MediumTest
public
void
testTexturetoYuv
(
)
throws
InterruptedException
{
final
int
width
=
16
;
final
int
height
=
16
;
final
EglBase
eglBase
=
EglBase
.
create
(
null
EglBase
.
CONFIG_PLAIN
)
;
final
SurfaceTextureHelper
surfaceTextureHelper
=
SurfaceTextureHelper
.
create
(
"
SurfaceTextureHelper
test
"
eglBase
.
getEglBaseContext
(
)
)
;
final
MockTextureListener
listener
=
new
MockTextureListener
(
)
;
surfaceTextureHelper
.
startListening
(
listener
)
;
surfaceTextureHelper
.
setTextureSize
(
width
height
)
;
eglBase
.
createSurface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
;
assertEquals
(
eglBase
.
surfaceWidth
(
)
width
)
;
assertEquals
(
eglBase
.
surfaceHeight
(
)
height
)
;
final
int
red
[
]
=
new
int
[
]
{
79
144
185
}
;
final
int
green
[
]
=
new
int
[
]
{
66
210
162
}
;
final
int
blue
[
]
=
new
int
[
]
{
161
117
158
}
;
final
int
ref_y
[
]
=
new
int
[
]
{
85
170
161
}
;
final
int
ref_u
[
]
=
new
int
[
]
{
168
97
123
}
;
final
int
ref_v
[
]
=
new
int
[
]
{
127
106
138
}
;
for
(
int
i
=
0
;
i
<
3
;
+
+
i
)
{
eglBase
.
makeCurrent
(
)
;
GLES20
.
glClearColor
(
red
[
i
]
/
255
.
0f
green
[
i
]
/
255
.
0f
blue
[
i
]
/
255
.
0f
1
.
0f
)
;
GLES20
.
glClear
(
GLES20
.
GL_COLOR_BUFFER_BIT
)
;
eglBase
.
swapBuffers
(
)
;
final
VideoFrame
.
TextureBuffer
textureBuffer
=
listener
.
waitForTextureBuffer
(
)
;
final
VideoFrame
.
I420Buffer
i420
=
textureBuffer
.
toI420
(
)
;
textureBuffer
.
release
(
)
;
final
ByteBuffer
dataY
=
i420
.
getDataY
(
)
;
final
int
strideY
=
i420
.
getStrideY
(
)
;
for
(
int
y
=
0
;
y
<
height
;
y
+
+
)
{
for
(
int
x
=
0
;
x
<
width
;
x
+
+
)
{
assertClose
(
1
ref_y
[
i
]
dataY
.
get
(
y
*
strideY
+
x
)
&
0xFF
)
;
}
}
final
int
chromaWidth
=
width
/
2
;
final
int
chromaHeight
=
height
/
2
;
final
ByteBuffer
dataU
=
i420
.
getDataU
(
)
;
final
ByteBuffer
dataV
=
i420
.
getDataV
(
)
;
final
int
strideU
=
i420
.
getStrideU
(
)
;
final
int
strideV
=
i420
.
getStrideV
(
)
;
for
(
int
y
=
0
;
y
<
chromaHeight
;
y
+
+
)
{
for
(
int
x
=
0
;
x
<
chromaWidth
;
x
+
+
)
{
assertClose
(
1
ref_u
[
i
]
dataU
.
get
(
y
*
strideU
+
x
)
&
0xFF
)
;
assertClose
(
1
ref_v
[
i
]
dataV
.
get
(
y
*
strideV
+
x
)
&
0xFF
)
;
}
}
i420
.
release
(
)
;
}
surfaceTextureHelper
.
dispose
(
)
;
eglBase
.
release
(
)
;
}
}
