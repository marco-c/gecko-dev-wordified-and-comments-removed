package
org
.
webrtc
;
import
android
.
app
.
Activity
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
hardware
.
display
.
DisplayManager
;
import
android
.
hardware
.
display
.
VirtualDisplay
;
import
android
.
media
.
projection
.
MediaProjection
;
import
android
.
media
.
projection
.
MediaProjectionManager
;
import
android
.
os
.
Build
.
VERSION
;
import
android
.
os
.
Build
.
VERSION_CODES
;
import
android
.
view
.
Surface
;
import
androidx
.
annotation
.
Nullable
;
public
class
ScreenCapturerAndroid
implements
VideoCapturer
VideoSink
{
private
static
final
int
DISPLAY_FLAGS
=
DisplayManager
.
VIRTUAL_DISPLAY_FLAG_PUBLIC
|
DisplayManager
.
VIRTUAL_DISPLAY_FLAG_PRESENTATION
;
private
static
final
int
VIRTUAL_DISPLAY_DPI
=
400
;
private
final
Intent
mediaProjectionPermissionResultData
;
private
final
MediaProjection
.
Callback
mediaProjectionCallback
;
private
int
width
;
private
int
height
;
Nullable
private
VirtualDisplay
virtualDisplay
;
Nullable
private
SurfaceTextureHelper
surfaceTextureHelper
;
Nullable
private
CapturerObserver
capturerObserver
;
private
long
numCapturedFrames
;
Nullable
private
MediaProjection
mediaProjection
;
private
boolean
isDisposed
;
Nullable
private
MediaProjectionManager
mediaProjectionManager
;
public
ScreenCapturerAndroid
(
Intent
mediaProjectionPermissionResultData
MediaProjection
.
Callback
mediaProjectionCallback
)
{
this
.
mediaProjectionPermissionResultData
=
mediaProjectionPermissionResultData
;
this
.
mediaProjectionCallback
=
mediaProjectionCallback
;
}
private
void
checkNotDisposed
(
)
{
if
(
isDisposed
)
{
throw
new
RuntimeException
(
"
capturer
is
disposed
.
"
)
;
}
}
Nullable
public
MediaProjection
getMediaProjection
(
)
{
return
mediaProjection
;
}
Override
SuppressWarnings
(
"
NoSynchronizedMethodCheck
"
)
public
synchronized
void
initialize
(
final
SurfaceTextureHelper
surfaceTextureHelper
final
Context
applicationContext
final
CapturerObserver
capturerObserver
)
{
checkNotDisposed
(
)
;
if
(
capturerObserver
=
=
null
)
{
throw
new
RuntimeException
(
"
capturerObserver
not
set
.
"
)
;
}
this
.
capturerObserver
=
capturerObserver
;
if
(
surfaceTextureHelper
=
=
null
)
{
throw
new
RuntimeException
(
"
surfaceTextureHelper
not
set
.
"
)
;
}
this
.
surfaceTextureHelper
=
surfaceTextureHelper
;
mediaProjectionManager
=
(
MediaProjectionManager
)
applicationContext
.
getSystemService
(
Context
.
MEDIA_PROJECTION_SERVICE
)
;
}
Override
SuppressWarnings
(
"
NoSynchronizedMethodCheck
"
)
public
synchronized
void
startCapture
(
final
int
width
final
int
height
final
int
ignoredFramerate
)
{
checkNotDisposed
(
)
;
this
.
width
=
width
;
this
.
height
=
height
;
mediaProjection
=
mediaProjectionManager
.
getMediaProjection
(
Activity
.
RESULT_OK
mediaProjectionPermissionResultData
)
;
mediaProjection
.
registerCallback
(
mediaProjectionCallback
surfaceTextureHelper
.
getHandler
(
)
)
;
updateVirtualDisplay
(
)
;
capturerObserver
.
onCapturerStarted
(
true
)
;
surfaceTextureHelper
.
startListening
(
ScreenCapturerAndroid
.
this
)
;
}
Override
SuppressWarnings
(
"
NoSynchronizedMethodCheck
"
)
public
synchronized
void
stopCapture
(
)
{
checkNotDisposed
(
)
;
ThreadUtils
.
invokeAtFrontUninterruptibly
(
surfaceTextureHelper
.
getHandler
(
)
new
Runnable
(
)
{
Override
public
void
run
(
)
{
surfaceTextureHelper
.
stopListening
(
)
;
capturerObserver
.
onCapturerStopped
(
)
;
if
(
virtualDisplay
!
=
null
)
{
virtualDisplay
.
release
(
)
;
virtualDisplay
=
null
;
}
if
(
mediaProjection
!
=
null
)
{
mediaProjection
.
unregisterCallback
(
mediaProjectionCallback
)
;
mediaProjection
.
stop
(
)
;
mediaProjection
=
null
;
}
}
}
)
;
}
Override
SuppressWarnings
(
"
NoSynchronizedMethodCheck
"
)
public
synchronized
void
dispose
(
)
{
isDisposed
=
true
;
}
Override
SuppressWarnings
(
"
NoSynchronizedMethodCheck
"
)
public
synchronized
void
changeCaptureFormat
(
final
int
width
final
int
height
final
int
ignoredFramerate
)
{
checkNotDisposed
(
)
;
this
.
width
=
width
;
this
.
height
=
height
;
if
(
virtualDisplay
=
=
null
)
{
return
;
}
ThreadUtils
.
invokeAtFrontUninterruptibly
(
surfaceTextureHelper
.
getHandler
(
)
this
:
:
updateVirtualDisplay
)
;
}
private
void
updateVirtualDisplay
(
)
{
surfaceTextureHelper
.
setTextureSize
(
width
height
)
;
if
(
virtualDisplay
=
=
null
|
|
VERSION
.
SDK_INT
<
VERSION_CODES
.
S
)
{
createVirtualDisplay
(
)
;
}
else
{
virtualDisplay
.
resize
(
width
height
VIRTUAL_DISPLAY_DPI
)
;
virtualDisplay
.
setSurface
(
new
Surface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
)
;
}
}
private
void
createVirtualDisplay
(
)
{
if
(
virtualDisplay
!
=
null
)
{
virtualDisplay
.
release
(
)
;
}
virtualDisplay
=
mediaProjection
.
createVirtualDisplay
(
"
WebRTC_ScreenCapture
"
width
height
VIRTUAL_DISPLAY_DPI
DISPLAY_FLAGS
new
Surface
(
surfaceTextureHelper
.
getSurfaceTexture
(
)
)
null
null
)
;
}
Override
public
void
onFrame
(
VideoFrame
frame
)
{
numCapturedFrames
+
+
;
capturerObserver
.
onFrameCaptured
(
frame
)
;
}
Override
public
boolean
isScreencast
(
)
{
return
true
;
}
public
long
getNumCapturedFrames
(
)
{
return
numCapturedFrames
;
}
}
