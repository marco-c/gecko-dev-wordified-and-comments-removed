#
include
"
sdk
/
objc
/
native
/
src
/
objc_network_monitor
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
task_queue
/
to_queued_task
.
h
"
#
include
<
algorithm
>
#
include
"
rtc_base
/
logging
.
h
"
#
include
"
rtc_base
/
string_utils
.
h
"
namespace
webrtc
{
rtc
:
:
NetworkMonitorInterface
*
ObjCNetworkMonitorFactory
:
:
CreateNetworkMonitor
(
const
FieldTrialsView
&
field_trials
)
{
return
new
ObjCNetworkMonitor
(
)
;
}
ObjCNetworkMonitor
:
:
ObjCNetworkMonitor
(
)
{
safety_flag_
=
PendingTaskSafetyFlag
:
:
Create
(
)
;
}
ObjCNetworkMonitor
:
:
~
ObjCNetworkMonitor
(
)
{
[
network_monitor_
stop
]
;
network_monitor_
=
nil
;
}
void
ObjCNetworkMonitor
:
:
Start
(
)
{
if
(
started_
)
{
return
;
}
thread_
=
rtc
:
:
Thread
:
:
Current
(
)
;
RTC_DCHECK_RUN_ON
(
thread_
)
;
safety_flag_
-
>
SetAlive
(
)
;
network_monitor_
=
[
[
RTCNetworkMonitor
alloc
]
initWithObserver
:
this
]
;
if
(
network_monitor_
=
=
nil
)
{
RTC_LOG
(
LS_WARNING
)
<
<
"
Failed
to
create
RTCNetworkMonitor
;
not
available
on
this
OS
?
"
;
}
started_
=
true
;
}
void
ObjCNetworkMonitor
:
:
Stop
(
)
{
RTC_DCHECK_RUN_ON
(
thread_
)
;
if
(
!
started_
)
{
return
;
}
safety_flag_
-
>
SetNotAlive
(
)
;
[
network_monitor_
stop
]
;
network_monitor_
=
nil
;
started_
=
false
;
}
rtc
:
:
NetworkMonitorInterface
:
:
InterfaceInfo
ObjCNetworkMonitor
:
:
GetInterfaceInfo
(
absl
:
:
string_view
interface_name
)
{
RTC_DCHECK_RUN_ON
(
thread_
)
;
if
(
adapter_type_by_name_
.
empty
(
)
)
{
return
{
.
adapter_type
=
rtc
:
:
ADAPTER_TYPE_UNKNOWN
.
available
=
true
}
;
}
auto
iter
=
adapter_type_by_name_
.
find
(
interface_name
)
;
if
(
iter
=
=
adapter_type_by_name_
.
end
(
)
)
{
return
{
.
adapter_type
=
rtc
:
:
ADAPTER_TYPE_UNKNOWN
.
available
=
false
}
;
}
return
{
.
adapter_type
=
iter
-
>
second
.
available
=
true
}
;
}
void
ObjCNetworkMonitor
:
:
OnPathUpdate
(
std
:
:
map
<
std
:
:
string
rtc
:
:
AdapterType
rtc
:
:
AbslStringViewCmp
>
adapter_type_by_name
)
{
RTC_DCHECK
(
network_monitor_
!
=
nil
)
;
thread_
-
>
PostTask
(
ToQueuedTask
(
safety_flag_
[
this
adapter_type_by_name
]
{
RTC_DCHECK_RUN_ON
(
thread_
)
;
adapter_type_by_name_
=
adapter_type_by_name
;
InvokeNetworksChangedCallback
(
)
;
}
)
)
;
}
}
