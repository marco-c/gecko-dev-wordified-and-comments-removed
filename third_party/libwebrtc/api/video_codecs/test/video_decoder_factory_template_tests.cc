#
include
"
api
/
test
/
mock_video_decoder
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder_factory_template
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder_factory_template_dav1d_adapter
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder_factory_template_libvpx_vp8_adapter
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder_factory_template_libvpx_vp9_adapter
.
h
"
#
include
"
api
/
video_codecs
/
video_decoder_factory_template_open_h264_adapter
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
using
:
:
testing
:
:
Contains
;
using
:
:
testing
:
:
Each
;
using
:
:
testing
:
:
Eq
;
using
:
:
testing
:
:
Field
;
using
:
:
testing
:
:
IsEmpty
;
using
:
:
testing
:
:
Ne
;
using
:
:
testing
:
:
Not
;
using
:
:
testing
:
:
UnorderedElementsAre
;
namespace
webrtc
{
namespace
{
const
SdpVideoFormat
kFooSdp
(
"
Foo
"
)
;
const
SdpVideoFormat
kBarLowSdp
(
"
Bar
"
{
{
"
profile
"
"
low
"
}
}
)
;
const
SdpVideoFormat
kBarHighSdp
(
"
Bar
"
{
{
"
profile
"
"
high
"
}
}
)
;
struct
FooDecoderTemplateAdapter
{
static
std
:
:
vector
<
SdpVideoFormat
>
SupportedFormats
(
)
{
return
{
kFooSdp
}
;
}
static
std
:
:
unique_ptr
<
VideoDecoder
>
CreateDecoder
(
const
SdpVideoFormat
&
format
)
{
return
std
:
:
make_unique
<
testing
:
:
StrictMock
<
MockVideoDecoder
>
>
(
)
;
}
}
;
struct
BarDecoderTemplateAdapter
{
static
std
:
:
vector
<
SdpVideoFormat
>
SupportedFormats
(
)
{
return
{
kBarLowSdp
kBarHighSdp
}
;
}
static
std
:
:
unique_ptr
<
VideoDecoder
>
CreateDecoder
(
const
SdpVideoFormat
&
format
)
{
return
std
:
:
make_unique
<
testing
:
:
StrictMock
<
MockVideoDecoder
>
>
(
)
;
}
}
;
TEST
(
VideoDecoderFactoryTemplate
OneTemplateAdapterCreateDecoder
)
{
VideoDecoderFactoryTemplate
<
FooDecoderTemplateAdapter
>
factory
;
EXPECT_THAT
(
factory
.
GetSupportedFormats
(
)
UnorderedElementsAre
(
kFooSdp
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
kFooSdp
)
Ne
(
nullptr
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
SdpVideoFormat
(
"
FooX
"
)
)
Eq
(
nullptr
)
)
;
}
TEST
(
VideoDecoderFactoryTemplate
TwoTemplateAdaptersNoDuplicates
)
{
VideoDecoderFactoryTemplate
<
FooDecoderTemplateAdapter
FooDecoderTemplateAdapter
>
factory
;
EXPECT_THAT
(
factory
.
GetSupportedFormats
(
)
UnorderedElementsAre
(
kFooSdp
)
)
;
}
TEST
(
VideoDecoderFactoryTemplate
TwoTemplateAdaptersCreateDecoders
)
{
VideoDecoderFactoryTemplate
<
FooDecoderTemplateAdapter
BarDecoderTemplateAdapter
>
factory
;
EXPECT_THAT
(
factory
.
GetSupportedFormats
(
)
UnorderedElementsAre
(
kFooSdp
kBarLowSdp
kBarHighSdp
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
kFooSdp
)
Ne
(
nullptr
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
kBarLowSdp
)
Ne
(
nullptr
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
kBarHighSdp
)
Ne
(
nullptr
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
SdpVideoFormat
(
"
FooX
"
)
)
Eq
(
nullptr
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
SdpVideoFormat
(
"
Bar
"
)
)
Eq
(
nullptr
)
)
;
}
TEST
(
VideoDecoderFactoryTemplate
LibvpxVp8
)
{
VideoDecoderFactoryTemplate
<
LibvpxVp8DecoderTemplateAdapter
>
factory
;
auto
formats
=
factory
.
GetSupportedFormats
(
)
;
EXPECT_THAT
(
formats
.
size
(
)
1
)
;
EXPECT_THAT
(
formats
[
0
]
Field
(
&
SdpVideoFormat
:
:
name
"
VP8
"
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
formats
[
0
]
)
Ne
(
nullptr
)
)
;
}
TEST
(
VideoDecoderFactoryTemplate
LibvpxVp9
)
{
VideoDecoderFactoryTemplate
<
LibvpxVp9DecoderTemplateAdapter
>
factory
;
auto
formats
=
factory
.
GetSupportedFormats
(
)
;
EXPECT_THAT
(
formats
Not
(
IsEmpty
(
)
)
)
;
EXPECT_THAT
(
formats
Each
(
Field
(
&
SdpVideoFormat
:
:
name
"
VP9
"
)
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
formats
[
0
]
)
Ne
(
nullptr
)
)
;
}
#
if
defined
(
WEBRTC_USE_H264
)
TEST
(
VideoDecoderFactoryTemplate
OpenH264
)
{
VideoDecoderFactoryTemplate
<
OpenH264DecoderTemplateAdapter
>
factory
;
auto
formats
=
factory
.
GetSupportedFormats
(
)
;
EXPECT_THAT
(
formats
Not
(
IsEmpty
(
)
)
)
;
EXPECT_THAT
(
formats
Each
(
Field
(
&
SdpVideoFormat
:
:
name
"
H264
"
)
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
formats
[
0
]
)
Ne
(
nullptr
)
)
;
}
#
endif
TEST
(
VideoDecoderFactoryTemplate
Dav1d
)
{
VideoDecoderFactoryTemplate
<
Dav1dDecoderTemplateAdapter
>
factory
;
auto
formats
=
factory
.
GetSupportedFormats
(
)
;
EXPECT_THAT
(
formats
.
size
(
)
1
)
;
EXPECT_THAT
(
formats
[
0
]
Field
(
&
SdpVideoFormat
:
:
name
"
AV1
"
)
)
;
EXPECT_THAT
(
factory
.
CreateVideoDecoder
(
formats
[
0
]
)
Ne
(
nullptr
)
)
;
}
}
}
