#
ifndef
API_TEST_SIMULATED_NETWORK_H_
#
define
API_TEST_SIMULATED_NETWORK_H_
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
<
functional
>
#
include
<
optional
>
#
include
<
vector
>
#
include
"
absl
/
functional
/
any_invocable
.
h
"
#
include
"
api
/
transport
/
ecn_marking
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
data_size
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
namespace
webrtc
{
struct
PacketInFlightInfo
{
PacketInFlightInfo
(
size_t
size
int64_t
send_time_us
uint64_t
packet_id
EcnMarking
ecn
)
:
size
(
size
)
send_time_us
(
send_time_us
)
packet_id
(
packet_id
)
ecn
(
ecn
)
{
}
PacketInFlightInfo
(
DataSize
size
Timestamp
send_time
uint64_t
packet_id
EcnMarking
ecn
)
:
PacketInFlightInfo
(
size
.
bytes
(
)
send_time
.
us
(
)
packet_id
ecn
)
{
}
PacketInFlightInfo
(
DataSize
size
Timestamp
send_time
uint64_t
packet_id
)
:
PacketInFlightInfo
(
size
.
bytes
(
)
send_time
.
us
(
)
packet_id
EcnMarking
:
:
kNotEct
)
{
}
PacketInFlightInfo
(
size_t
size
int64_t
send_time_us
uint64_t
packet_id
)
:
PacketInFlightInfo
(
size
send_time_us
packet_id
EcnMarking
:
:
kNotEct
)
{
}
DataSize
packet_size
(
)
const
{
return
DataSize
:
:
Bytes
(
size
)
;
}
Timestamp
send_time
(
)
const
{
return
Timestamp
:
:
Micros
(
send_time_us
)
;
}
size_t
size
;
int64_t
send_time_us
;
uint64_t
packet_id
;
EcnMarking
ecn
;
}
;
struct
PacketDeliveryInfo
{
static
constexpr
int
kNotReceived
=
-
1
;
PacketDeliveryInfo
(
PacketInFlightInfo
source
int64_t
receive_time_us
)
:
receive_time_us
(
receive_time_us
)
packet_id
(
source
.
packet_id
)
ecn
(
source
.
ecn
)
{
}
bool
operator
=
=
(
const
PacketDeliveryInfo
&
other
)
const
{
return
receive_time_us
=
=
other
.
receive_time_us
&
&
packet_id
=
=
other
.
packet_id
;
}
int64_t
receive_time_us
;
uint64_t
packet_id
;
EcnMarking
ecn
;
}
;
struct
BuiltInNetworkBehaviorConfig
{
size_t
queue_length_packets
=
0
;
int
queue_delay_ms
=
0
;
int
delay_standard_deviation_ms
=
0
;
DataRate
link_capacity
=
DataRate
:
:
Infinity
(
)
;
double
loss_percent
=
0
.
;
bool
allow_reordering
=
false
;
int
avg_burst_loss_length
=
-
1
;
int
packet_overhead
=
0
;
}
;
class
NetworkBehaviorInterface
{
public
:
virtual
bool
EnqueuePacket
(
PacketInFlightInfo
packet_info
)
=
0
;
virtual
std
:
:
vector
<
PacketDeliveryInfo
>
DequeueDeliverablePackets
(
int64_t
receive_time_us
)
=
0
;
virtual
std
:
:
optional
<
int64_t
>
NextDeliveryTimeUs
(
)
const
=
0
;
virtual
void
RegisterDeliveryTimeChangedCallback
(
absl
:
:
AnyInvocable
<
void
(
)
>
)
{
}
virtual
~
NetworkBehaviorInterface
(
)
=
default
;
}
;
class
SimulatedNetworkInterface
:
public
NetworkBehaviorInterface
{
public
:
virtual
void
SetConfig
(
const
BuiltInNetworkBehaviorConfig
&
config
)
=
0
;
virtual
void
UpdateConfig
(
std
:
:
function
<
void
(
BuiltInNetworkBehaviorConfig
*
)
>
config_modifier
)
=
0
;
virtual
void
PauseTransmissionUntil
(
int64_t
until_us
)
=
0
;
}
;
}
#
endif
