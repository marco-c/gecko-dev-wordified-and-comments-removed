#
ifndef
API_TEST_NETWORK_EMULATION_DUAL_PI2_NETWORK_QUEUE_H_
#
define
API_TEST_NETWORK_EMULATION_DUAL_PI2_NETWORK_QUEUE_H_
#
include
<
cstddef
>
#
include
<
memory
>
#
include
<
optional
>
#
include
<
queue
>
#
include
<
random
>
#
include
<
vector
>
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
api
/
test
/
network_emulation
/
network_queue
.
h
"
#
include
"
api
/
test
/
simulated_network
.
h
"
#
include
"
api
/
units
/
data_rate
.
h
"
#
include
"
api
/
units
/
data_size
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
namespace
webrtc
{
class
DualPi2NetworkQueue
:
public
NetworkQueue
{
public
:
struct
Config
{
TimeDelta
target_delay
=
TimeDelta
:
:
Micros
(
500
)
;
DataRate
link_rate
=
DataRate
:
:
PlusInfinity
(
)
;
double
alpha
=
0
.
16
;
double
beta
=
3
.
2
;
int
k
=
2
;
TimeDelta
probability_update_interval
=
TimeDelta
:
:
Millis
(
16
)
;
int
seed
=
1
;
}
;
DualPi2NetworkQueue
(
)
:
DualPi2NetworkQueue
(
Config
(
)
)
{
}
explicit
DualPi2NetworkQueue
(
const
Config
&
config
)
;
void
SetMaxPacketCapacity
(
size_t
max_packet_capacity
)
override
;
bool
EnqueuePacket
(
const
PacketInFlightInfo
&
packet_info
)
override
;
std
:
:
optional
<
PacketInFlightInfo
>
PeekNextPacket
(
)
const
override
;
std
:
:
optional
<
PacketInFlightInfo
>
DequeuePacket
(
Timestamp
time_now
)
override
;
std
:
:
vector
<
PacketInFlightInfo
>
DequeueDroppedPackets
(
)
override
{
return
{
}
;
}
bool
empty
(
)
const
override
;
double
l4s_marking_probability
(
)
const
{
return
base_marking_probability_
*
config_
.
k
;
}
double
classic_drop_probability
(
)
const
{
return
(
base_marking_probability_
*
base_marking_probability_
)
;
}
private
:
void
UpdateBaseMarkingProbability
(
Timestamp
time_now
)
;
bool
ShouldTakeAction
(
double
marking_probability
)
;
TimeDelta
l4s_queue_delay
(
Timestamp
time_now
)
const
{
return
l4s_queue_
.
empty
(
)
?
TimeDelta
:
:
Zero
(
)
:
time_now
-
l4s_queue_
.
front
(
)
.
send_time
(
)
;
}
TimeDelta
classic_queue_delay
(
Timestamp
time_now
)
const
{
return
classic_queue_
.
empty
(
)
?
TimeDelta
:
:
Zero
(
)
:
time_now
-
classic_queue_
.
front
(
)
.
send_time
(
)
;
}
SequenceChecker
sequence_checker_
;
const
Config
config_
;
const
DataSize
step_threshold_
;
std
:
:
queue
<
PacketInFlightInfo
>
l4s_queue_
;
std
:
:
queue
<
PacketInFlightInfo
>
classic_queue_
;
std
:
:
mt19937
random_
;
std
:
:
uniform_real_distribution
<
double
>
distribution_
;
std
:
:
optional
<
size_t
>
max_packet_capacity_
;
DataSize
total_queued_size_
;
double
base_marking_probability_
=
0
;
Timestamp
last_probability_update_time_
=
Timestamp
:
:
MinusInfinity
(
)
;
TimeDelta
previous_sojourn_time_
=
TimeDelta
:
:
Zero
(
)
;
}
;
class
DualPi2NetworkQueueFactory
:
public
NetworkQueueFactory
{
public
:
explicit
DualPi2NetworkQueueFactory
(
const
DualPi2NetworkQueue
:
:
Config
&
config
)
:
config_
(
config
)
{
}
std
:
:
unique_ptr
<
NetworkQueue
>
CreateQueue
(
)
override
{
return
std
:
:
make_unique
<
DualPi2NetworkQueue
>
(
config_
)
;
}
private
:
const
DualPi2NetworkQueue
:
:
Config
config_
;
}
;
}
#
endif
