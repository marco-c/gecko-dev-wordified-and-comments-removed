#
include
"
common_audio
/
smoothing_filter
.
h
"
#
include
<
cmath
>
#
include
<
optional
>
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
using
:
:
testing
:
:
FloatNear
;
using
:
:
testing
:
:
Optional
;
constexpr
float
kMaxAbsError
=
1e
-
5f
;
struct
SmoothingFilterStates
{
explicit
SmoothingFilterStates
(
int
init_time_ms
)
:
now
(
Timestamp
:
:
Millis
(
123
'
456
)
)
smoothing_filter
(
init_time_ms
)
{
}
Timestamp
now
;
SmoothingFilterImpl
smoothing_filter
;
}
;
void
CheckOutput
(
SmoothingFilterStates
*
states
float
sample
int
advance_time_ms
float
expected_ouput
)
{
states
-
>
smoothing_filter
.
AddSample
(
sample
states
-
>
now
)
;
states
-
>
now
+
=
TimeDelta
:
:
Millis
(
advance_time_ms
)
;
EXPECT_THAT
(
states
-
>
smoothing_filter
.
GetAverage
(
states
-
>
now
)
Optional
(
FloatNear
(
expected_ouput
kMaxAbsError
)
)
)
;
}
}
TEST
(
SmoothingFilterTest
NoOutputWhenNoSampleAdded
)
{
constexpr
int
kInitTimeMs
=
100
;
SmoothingFilterStates
states
(
kInitTimeMs
)
;
EXPECT_EQ
(
states
.
smoothing_filter
.
GetAverage
(
states
.
now
)
std
:
:
nullopt
)
;
}
TEST
(
SmoothingFilterTest
CheckBehaviorAroundInitTime
)
{
constexpr
int
kInitTimeMs
=
795
;
SmoothingFilterStates
states
(
kInitTimeMs
)
;
CheckOutput
(
&
states
1
.
0f
500
1
.
0f
)
;
CheckOutput
(
&
states
0
.
5f
100
0
.
680562264029f
)
;
CheckOutput
(
&
states
1
.
0f
100
0
.
794207139813f
)
;
CheckOutput
(
&
states
1
.
0f
100
0
.
829803409752f
)
;
CheckOutput
(
&
states
0
.
5f
100
0
.
790821764210f
)
;
CheckOutput
(
&
states
1
.
0f
100
0
.
815545922911f
)
;
}
TEST
(
SmoothingFilterTest
InitTimeEqualsZero
)
{
constexpr
int
kInitTimeMs
=
0
;
SmoothingFilterStates
states
(
kInitTimeMs
)
;
CheckOutput
(
&
states
1
.
0f
1
1
.
0f
)
;
CheckOutput
(
&
states
0
.
5f
1
0
.
5f
)
;
}
TEST
(
SmoothingFilterTest
InitTimeEqualsOne
)
{
constexpr
int
kInitTimeMs
=
1
;
SmoothingFilterStates
states
(
kInitTimeMs
)
;
CheckOutput
(
&
states
1
.
0f
1
1
.
0f
)
;
CheckOutput
(
&
states
0
.
5f
1
1
.
0f
*
std
:
:
exp
(
-
1
.
0f
)
+
(
1
.
0f
-
std
:
:
exp
(
-
1
.
0f
)
)
*
0
.
5f
)
;
}
TEST
(
SmoothingFilterTest
GetAverageOutputsEmptyBeforeFirstSample
)
{
constexpr
int
kInitTimeMs
=
100
;
SmoothingFilterStates
states
(
kInitTimeMs
)
;
EXPECT_FALSE
(
states
.
smoothing_filter
.
GetAverage
(
states
.
now
)
)
;
constexpr
float
kFirstSample
=
1
.
2345f
;
states
.
smoothing_filter
.
AddSample
(
kFirstSample
states
.
now
)
;
EXPECT_EQ
(
kFirstSample
states
.
smoothing_filter
.
GetAverage
(
states
.
now
)
)
;
}
TEST
(
SmoothingFilterTest
CannotChangeTimeConstantDuringInitialization
)
{
constexpr
int
kInitTimeMs
=
100
;
SmoothingFilterStates
states
(
kInitTimeMs
)
;
states
.
smoothing_filter
.
AddSample
(
0
.
0
states
.
now
)
;
states
.
now
+
=
TimeDelta
:
:
Millis
(
kInitTimeMs
-
1
)
;
states
.
smoothing_filter
.
AddSample
(
0
.
0
states
.
now
)
;
EXPECT_FALSE
(
states
.
smoothing_filter
.
SetTimeConstantMs
(
kInitTimeMs
*
2
)
)
;
EXPECT_NE
(
std
:
:
exp
(
-
1
.
0f
/
(
kInitTimeMs
*
2
)
)
states
.
smoothing_filter
.
alpha
(
)
)
;
states
.
now
+
=
TimeDelta
:
:
Millis
(
1
)
;
states
.
smoothing_filter
.
AddSample
(
0
.
0
states
.
now
)
;
EXPECT_FLOAT_EQ
(
std
:
:
exp
(
-
1
.
0f
/
kInitTimeMs
)
states
.
smoothing_filter
.
alpha
(
)
)
;
EXPECT_TRUE
(
states
.
smoothing_filter
.
SetTimeConstantMs
(
kInitTimeMs
*
2
)
)
;
EXPECT_FLOAT_EQ
(
std
:
:
exp
(
-
1
.
0f
/
(
kInitTimeMs
*
2
)
)
states
.
smoothing_filter
.
alpha
(
)
)
;
}
}
