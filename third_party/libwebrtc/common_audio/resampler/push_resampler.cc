#
include
"
common_audio
/
resampler
/
include
/
push_resampler
.
h
"
#
include
<
stdint
.
h
>
#
include
<
string
.
h
>
#
include
<
memory
>
#
include
"
api
/
audio
/
audio_frame
.
h
"
#
include
"
common_audio
/
include
/
audio_util
.
h
"
#
include
"
common_audio
/
resampler
/
push_sinc_resampler
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
namespace
webrtc
{
template
<
typename
T
>
PushResampler
<
T
>
:
:
PushResampler
(
)
=
default
;
template
<
typename
T
>
PushResampler
<
T
>
:
:
~
PushResampler
(
)
=
default
;
template
<
typename
T
>
int
PushResampler
<
T
>
:
:
InitializeIfNeeded
(
int
src_sample_rate_hz
int
dst_sample_rate_hz
size_t
num_channels
)
{
RTC_CHECK_GT
(
src_sample_rate_hz
0
)
;
RTC_CHECK_GT
(
dst_sample_rate_hz
0
)
;
RTC_CHECK_GT
(
num_channels
0
)
;
const
size_t
src_size_10ms_mono
=
static_cast
<
size_t
>
(
src_sample_rate_hz
/
100
)
;
const
size_t
dst_size_10ms_mono
=
static_cast
<
size_t
>
(
dst_sample_rate_hz
/
100
)
;
if
(
src_size_10ms_mono
=
=
SamplesPerChannel
(
source_view_
)
&
&
dst_size_10ms_mono
=
=
SamplesPerChannel
(
destination_view_
)
&
&
num_channels
=
=
NumChannels
(
source_view_
)
)
{
return
0
;
}
source_
.
reset
(
new
T
[
src_size_10ms_mono
*
num_channels
]
)
;
destination_
.
reset
(
new
T
[
dst_size_10ms_mono
*
num_channels
]
)
;
source_view_
=
DeinterleavedView
<
T
>
(
source_
.
get
(
)
src_size_10ms_mono
num_channels
)
;
destination_view_
=
DeinterleavedView
<
T
>
(
destination_
.
get
(
)
dst_size_10ms_mono
num_channels
)
;
resamplers_
.
resize
(
num_channels
)
;
for
(
size_t
i
=
0
;
i
<
num_channels
;
+
+
i
)
{
resamplers_
[
i
]
=
std
:
:
make_unique
<
PushSincResampler
>
(
src_size_10ms_mono
dst_size_10ms_mono
)
;
}
return
0
;
}
template
<
typename
T
>
int
PushResampler
<
T
>
:
:
Resample
(
InterleavedView
<
const
T
>
src
InterleavedView
<
T
>
dst
)
{
RTC_DCHECK_EQ
(
NumChannels
(
src
)
NumChannels
(
source_view_
)
)
;
RTC_DCHECK_EQ
(
NumChannels
(
dst
)
NumChannels
(
destination_view_
)
)
;
RTC_DCHECK_EQ
(
SamplesPerChannel
(
src
)
SamplesPerChannel
(
source_view_
)
)
;
RTC_DCHECK_EQ
(
SamplesPerChannel
(
dst
)
SamplesPerChannel
(
destination_view_
)
)
;
if
(
SamplesPerChannel
(
src
)
=
=
SamplesPerChannel
(
dst
)
)
{
CopySamples
(
dst
src
)
;
return
static_cast
<
int
>
(
src
.
data
(
)
.
size
(
)
)
;
}
Deinterleave
(
src
source_view_
)
;
for
(
size_t
i
=
0
;
i
<
resamplers_
.
size
(
)
;
+
+
i
)
{
size_t
dst_length_mono
=
resamplers_
[
i
]
-
>
Resample
(
source_view_
[
i
]
destination_view_
[
i
]
)
;
RTC_DCHECK_EQ
(
dst_length_mono
SamplesPerChannel
(
dst
)
)
;
}
Interleave
<
T
>
(
destination_view_
dst
)
;
return
static_cast
<
int
>
(
dst
.
size
(
)
)
;
}
template
class
PushResampler
<
int16_t
>
;
template
class
PushResampler
<
float
>
;
}
