#
ifndef
LOGGING_RTC_EVENT_LOG_EVENTS_RTC_EVENT_FIELD_ENCODING_PARSER_H_
#
define
LOGGING_RTC_EVENT_LOG_EVENTS_RTC_EVENT_FIELD_ENCODING_PARSER_H_
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
optional
>
#
include
<
string
>
#
include
<
type_traits
>
#
include
<
vector
>
#
include
"
absl
/
base
/
attributes
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
logging
/
rtc_event_log
/
events
/
fixed_length_encoding_parameters_v3
.
h
"
#
include
"
logging
/
rtc_event_log
/
events
/
rtc_event_field_encoding
.
h
"
#
include
"
logging
/
rtc_event_log
/
events
/
rtc_event_field_extraction
.
h
"
#
include
"
logging
/
rtc_event_log
/
events
/
rtc_event_log_parse_status
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
namespace
webrtc
{
class
EventParser
{
public
:
struct
ValueAndPostionView
{
ArrayView
<
uint64_t
>
values
;
ArrayView
<
uint8_t
>
positions
;
}
;
EventParser
(
)
=
default
;
RtcEventLogParseStatus
Initialize
(
absl
:
:
string_view
s
bool
batched
)
;
RtcEventLogParseStatusOr
<
ArrayView
<
absl
:
:
string_view
>
>
ParseStringField
(
const
FieldParameters
&
params
bool
required_field
=
true
)
;
RtcEventLogParseStatusOr
<
ArrayView
<
uint64_t
>
>
ParseNumericField
(
const
FieldParameters
&
params
bool
required_field
=
true
)
;
RtcEventLogParseStatusOr
<
ValueAndPostionView
>
ParseOptionalNumericField
(
const
FieldParameters
&
params
bool
required_field
=
true
)
;
uint64_t
NumEventsInBatch
(
)
const
{
return
num_events_
;
}
size_t
RemainingBytes
(
)
const
{
return
pending_data_
.
size
(
)
;
}
private
:
uint64_t
ReadLittleEndian
(
uint8_t
bytes
)
;
uint64_t
ReadVarInt
(
)
;
uint64_t
ReadSingleValue
(
FieldType
field_type
)
;
uint64_t
ReadOptionalValuePositions
(
)
;
void
ReadDeltasAndPopulateValues
(
FixedLengthEncodingParametersV3
params
uint64_t
num_deltas
uint64_t
base
)
;
RtcEventLogParseStatus
ParseNumericFieldInternal
(
uint64_t
value_bit_width
FieldType
field_type
)
;
RtcEventLogParseStatus
ParseStringFieldInternal
(
)
;
RtcEventLogParseStatus
ParseField
(
const
FieldParameters
&
params
)
;
void
SetError
(
)
{
error_
=
true
;
}
bool
Ok
(
)
const
{
return
!
error_
;
}
ArrayView
<
uint64_t
>
GetValues
(
)
{
return
values_
;
}
ArrayView
<
uint8_t
>
GetPositions
(
)
{
return
positions_
;
}
ArrayView
<
absl
:
:
string_view
>
GetStrings
(
)
{
return
strings_
;
}
void
ClearTemporaries
(
)
{
positions_
.
clear
(
)
;
values_
.
clear
(
)
;
strings_
.
clear
(
)
;
}
bool
error_
=
false
;
std
:
:
vector
<
uint8_t
>
positions_
;
std
:
:
vector
<
uint64_t
>
values_
;
std
:
:
vector
<
absl
:
:
string_view
>
strings_
;
absl
:
:
string_view
pending_data_
;
uint64_t
num_events_
=
1
;
uint64_t
last_field_id_
=
FieldParameters
:
:
kTimestampField
;
}
;
template
<
typename
T
typename
E
std
:
:
enable_if_t
<
std
:
:
is_integral
<
T
>
:
:
value
bool
>
=
true
>
ABSL_MUST_USE_RESULT
RtcEventLogParseStatus
PopulateRtcEventMember
(
const
ArrayView
<
uint64_t
>
values
T
E
:
:
*
member
ArrayView
<
E
>
output
)
{
size_t
batch_size
=
values
.
size
(
)
;
RTC_CHECK_EQ
(
output
.
size
(
)
batch_size
)
;
for
(
size_t
i
=
0
;
i
<
batch_size
;
+
+
i
)
{
output
[
i
]
.
*
member
=
DecodeFromUnsignedToType
<
T
>
(
values
[
i
]
)
;
}
return
RtcEventLogParseStatus
:
:
Success
(
)
;
}
template
<
typename
T
typename
E
std
:
:
enable_if_t
<
std
:
:
is_integral
<
T
>
:
:
value
bool
>
=
true
>
ABSL_MUST_USE_RESULT
RtcEventLogParseStatus
PopulateRtcEventMember
(
const
ArrayView
<
uint8_t
>
positions
const
ArrayView
<
uint64_t
>
values
std
:
:
optional
<
T
>
E
:
:
*
member
ArrayView
<
E
>
output
)
{
size_t
batch_size
=
positions
.
size
(
)
;
RTC_CHECK_EQ
(
output
.
size
(
)
batch_size
)
;
RTC_CHECK_LE
(
values
.
size
(
)
batch_size
)
;
auto
value_it
=
values
.
begin
(
)
;
for
(
size_t
i
=
0
;
i
<
batch_size
;
+
+
i
)
{
if
(
positions
[
i
]
)
{
RTC_CHECK
(
value_it
!
=
values
.
end
(
)
)
;
output
[
i
]
.
*
member
=
DecodeFromUnsignedToType
<
T
>
(
value_it
)
;
+
+
value_it
;
}
else
{
output
[
i
]
.
*
member
=
std
:
:
nullopt
;
}
}
RTC_CHECK
(
value_it
=
=
values
.
end
(
)
)
;
return
RtcEventLogParseStatus
:
:
Success
(
)
;
}
template
<
typename
T
typename
E
std
:
:
enable_if_t
<
std
:
:
is_enum
<
T
>
:
:
value
bool
>
=
true
>
ABSL_MUST_USE_RESULT
RtcEventLogParseStatus
PopulateRtcEventMember
(
const
ArrayView
<
uint64_t
>
values
T
E
:
:
*
member
ArrayView
<
E
>
output
)
{
size_t
batch_size
=
values
.
size
(
)
;
RTC_CHECK_EQ
(
output
.
size
(
)
batch_size
)
;
for
(
size_t
i
=
0
;
i
<
batch_size
;
+
+
i
)
{
auto
result
=
RtcEventLogEnum
<
T
>
:
:
Decode
(
values
[
i
]
)
;
if
(
!
result
.
ok
(
)
)
{
return
result
.
status
(
)
;
}
output
[
i
]
.
*
member
=
result
.
value
(
)
;
}
return
RtcEventLogParseStatus
:
:
Success
(
)
;
}
template
<
typename
E
>
ABSL_MUST_USE_RESULT
RtcEventLogParseStatus
PopulateRtcEventMember
(
const
ArrayView
<
absl
:
:
string_view
>
values
std
:
:
string
E
:
:
*
member
ArrayView
<
E
>
output
)
{
size_t
batch_size
=
values
.
size
(
)
;
RTC_CHECK_EQ
(
output
.
size
(
)
batch_size
)
;
for
(
size_t
i
=
0
;
i
<
batch_size
;
+
+
i
)
{
output
[
i
]
.
*
member
=
values
[
i
]
;
}
return
RtcEventLogParseStatus
:
:
Success
(
)
;
}
template
<
typename
E
>
ABSL_MUST_USE_RESULT
RtcEventLogParseStatus
PopulateRtcEventTimestamp
(
const
ArrayView
<
uint64_t
>
&
values
Timestamp
E
:
:
*
timestamp
ArrayView
<
E
>
output
)
{
size_t
batch_size
=
values
.
size
(
)
;
RTC_CHECK_EQ
(
batch_size
output
.
size
(
)
)
;
for
(
size_t
i
=
0
;
i
<
batch_size
;
+
+
i
)
{
output
[
i
]
.
*
timestamp
=
Timestamp
:
:
Millis
(
DecodeFromUnsignedToType
<
int64_t
>
(
values
[
i
]
)
)
;
}
return
RtcEventLogParseStatus
:
:
Success
(
)
;
}
template
<
typename
E
>
ArrayView
<
E
>
ExtendLoggedBatch
(
std
:
:
vector
<
E
>
&
output
size_t
new_elements
)
{
size_t
old_size
=
output
.
size
(
)
;
output
.
insert
(
output
.
end
(
)
old_size
+
new_elements
E
(
)
)
;
ArrayView
<
E
>
output_batch
=
output
;
output_batch
.
subview
(
old_size
)
;
RTC_DCHECK_EQ
(
output_batch
.
size
(
)
new_elements
)
;
return
output_batch
;
}
}
#
endif
