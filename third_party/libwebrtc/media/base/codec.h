#
ifndef
MEDIA_BASE_CODEC_H_
#
define
MEDIA_BASE_CODEC_H_
#
include
<
cstddef
>
#
include
<
optional
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
absl
/
container
/
inlined_vector
.
h
"
#
include
"
absl
/
strings
/
str_format
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
audio_codecs
/
audio_format
.
h
"
#
include
"
api
/
rtp_parameters
.
h
"
#
include
"
api
/
video_codecs
/
scalability_mode
.
h
"
#
include
"
api
/
video_codecs
/
sdp_video_format
.
h
"
#
include
"
media
/
base
/
media_constants
.
h
"
#
include
"
rtc_base
/
system
/
rtc_export
.
h
"
namespace
webrtc
{
class
FeedbackParam
{
public
:
FeedbackParam
(
)
=
default
;
FeedbackParam
(
absl
:
:
string_view
id
const
std
:
:
string
&
param
)
:
id_
(
id
)
param_
(
param
)
{
}
explicit
FeedbackParam
(
absl
:
:
string_view
id
)
:
id_
(
id
)
param_
(
kParamValueEmpty
)
{
}
bool
operator
=
=
(
const
FeedbackParam
&
other
)
const
;
bool
operator
!
=
(
const
FeedbackParam
&
c
)
const
{
return
!
(
*
this
=
=
c
)
;
}
const
std
:
:
string
&
id
(
)
const
{
return
id_
;
}
const
std
:
:
string
&
param
(
)
const
{
return
param_
;
}
private
:
std
:
:
string
id_
;
std
:
:
string
param_
;
}
;
class
FeedbackParams
{
public
:
FeedbackParams
(
)
;
~
FeedbackParams
(
)
;
bool
operator
=
=
(
const
FeedbackParams
&
other
)
const
;
bool
operator
!
=
(
const
FeedbackParams
&
c
)
const
{
return
!
(
*
this
=
=
c
)
;
}
bool
Has
(
const
FeedbackParam
&
param
)
const
;
void
Add
(
const
FeedbackParam
&
param
)
;
bool
Remove
(
const
FeedbackParam
&
param
)
;
void
Intersect
(
const
FeedbackParams
&
from
)
;
const
std
:
:
vector
<
FeedbackParam
>
&
params
(
)
const
{
return
params_
;
}
private
:
bool
HasDuplicateEntries
(
)
const
;
std
:
:
vector
<
FeedbackParam
>
params_
;
}
;
constexpr
int
kDefaultVideoClockRateHz
=
90
'
000
;
constexpr
int
kDefaultAudioClockRateHz
=
8
'
000
;
struct
RTC_EXPORT
Codec
{
enum
class
Type
{
kAudio
kVideo
}
;
enum
class
ResiliencyType
{
kNone
kRed
kUlpfec
kFlexfec
kRtx
}
;
static
const
int
kIdNotSet
=
-
1
;
Type
type
;
int
id
;
std
:
:
string
name
;
int
clockrate
;
int
bitrate
;
size_t
channels
;
std
:
:
optional
<
std
:
:
string
>
packetization
;
absl
:
:
InlinedVector
<
ScalabilityMode
kScalabilityModeCount
>
scalability_modes
;
std
:
:
optional
<
std
:
:
string
>
tx_mode
;
CodecParameterMap
params
;
FeedbackParams
feedback_params
;
Codec
(
const
Codec
&
c
)
;
Codec
(
Codec
&
&
c
)
;
virtual
~
Codec
(
)
;
bool
Matches
(
const
Codec
&
codec
)
const
;
bool
MatchesRtpCodec
(
const
RtpCodec
&
capability
)
const
;
bool
GetParam
(
const
std
:
:
string
&
key
std
:
:
string
*
out
)
const
;
bool
GetParam
(
const
std
:
:
string
&
key
int
*
out
)
const
;
void
SetParam
(
const
std
:
:
string
&
key
const
std
:
:
string
&
value
)
;
void
SetParam
(
const
std
:
:
string
&
key
int
value
)
;
bool
RemoveParam
(
const
std
:
:
string
&
key
)
;
bool
HasFeedbackParam
(
const
FeedbackParam
&
param
)
const
;
void
AddFeedbackParam
(
const
FeedbackParam
&
param
)
;
void
IntersectFeedbackParams
(
const
Codec
&
other
)
;
virtual
RtpCodecParameters
ToCodecParameters
(
)
const
;
bool
IsMediaCodec
(
)
const
;
bool
IsResiliencyCodec
(
)
const
;
ResiliencyType
GetResiliencyType
(
)
const
;
bool
ValidateCodecFormat
(
)
const
;
std
:
:
string
ToString
(
)
const
;
Codec
(
)
:
Codec
(
Type
:
:
kAudio
kIdNotSet
"
"
kDefaultAudioClockRateHz
)
{
}
Codec
&
operator
=
(
const
Codec
&
c
)
;
Codec
&
operator
=
(
Codec
&
&
c
)
;
bool
operator
=
=
(
const
Codec
&
c
)
const
;
bool
operator
!
=
(
const
Codec
&
c
)
const
{
return
!
(
*
this
=
=
c
)
;
}
template
<
typename
Sink
>
friend
void
AbslStringify
(
Sink
&
sink
const
Codec
&
c
)
{
absl
:
:
Format
(
&
sink
"
[
%
d
:
"
c
.
id
)
;
switch
(
c
.
type
)
{
case
Codec
:
:
Type
:
:
kAudio
:
sink
.
Append
(
"
audio
/
"
)
;
break
;
case
Codec
:
:
Type
:
:
kVideo
:
sink
.
Append
(
"
video
/
"
)
;
}
absl
:
:
Format
(
&
sink
"
%
s
/
%
d
/
%
d
"
c
.
name
c
.
clockrate
c
.
channels
)
;
if
(
c
.
packetization
)
{
absl
:
:
Format
(
&
sink
"
packetization
=
%
s
"
*
c
.
packetization
)
;
}
for
(
auto
param
:
c
.
params
)
{
sink
.
Append
(
"
;
"
)
;
sink
.
Append
(
param
.
first
)
;
sink
.
Append
(
"
=
"
)
;
sink
.
Append
(
param
.
second
)
;
}
sink
.
Append
(
"
]
"
)
;
}
protected
:
explicit
Codec
(
Type
type
)
;
Codec
(
Type
type
int
id
const
std
:
:
string
&
name
int
clockrate
)
;
Codec
(
Type
type
int
id
const
std
:
:
string
&
name
int
clockrate
size_t
channels
)
;
explicit
Codec
(
const
SdpAudioFormat
&
c
)
;
explicit
Codec
(
const
SdpVideoFormat
&
c
)
;
friend
Codec
CreateAudioCodec
(
int
id
const
std
:
:
string
&
name
int
clockrate
size_t
channels
)
;
friend
Codec
CreateAudioCodec
(
const
SdpAudioFormat
&
c
)
;
friend
Codec
CreateAudioRtxCodec
(
int
rtx_payload_type
int
associated_payload_type
)
;
friend
Codec
CreateVideoCodec
(
int
id
const
std
:
:
string
&
name
)
;
friend
Codec
CreateVideoCodec
(
const
SdpVideoFormat
&
c
)
;
friend
Codec
CreateVideoRtxCodec
(
int
rtx_payload_type
int
associated_payload_type
)
;
}
;
using
Codecs
=
std
:
:
vector
<
Codec
>
;
Codec
CreateAudioCodec
(
int
id
const
std
:
:
string
&
name
int
clockrate
size_t
channels
)
;
Codec
CreateAudioCodec
(
const
SdpAudioFormat
&
c
)
;
Codec
CreateAudioRtxCodec
(
int
rtx_payload_type
int
associated_payload_type
)
;
Codec
CreateVideoCodec
(
const
std
:
:
string
&
name
)
;
Codec
CreateVideoCodec
(
int
id
const
std
:
:
string
&
name
)
;
Codec
CreateVideoCodec
(
const
SdpVideoFormat
&
c
)
;
Codec
CreateVideoCodec
(
int
id
const
SdpVideoFormat
&
sdp
)
;
Codec
CreateVideoRtxCodec
(
int
rtx_payload_type
int
associated_payload_type
)
;
const
Codec
*
FindCodecById
(
const
std
:
:
vector
<
Codec
>
&
codecs
int
payload_type
)
;
bool
HasLntf
(
const
Codec
&
codec
)
;
bool
HasNack
(
const
Codec
&
codec
)
;
bool
HasRemb
(
const
Codec
&
codec
)
;
bool
HasRrtr
(
const
Codec
&
codec
)
;
const
Codec
*
FindMatchingVideoCodec
(
const
std
:
:
vector
<
Codec
>
&
supported_codecs
const
Codec
&
codec
)
;
std
:
:
vector
<
const
Codec
*
>
FindAllMatchingCodecs
(
const
std
:
:
vector
<
Codec
>
&
supported_codecs
const
Codec
&
codec
)
;
RTC_EXPORT
void
AddH264ConstrainedBaselineProfileToSupportedFormats
(
std
:
:
vector
<
SdpVideoFormat
>
*
supported_formats
)
;
}
#
endif
