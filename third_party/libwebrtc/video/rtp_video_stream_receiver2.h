#
ifndef
VIDEO_RTP_VIDEO_STREAM_RECEIVER2_H_
#
define
VIDEO_RTP_VIDEO_STREAM_RECEIVER2_H_
#
include
<
array
>
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
map
>
#
include
<
memory
>
#
include
<
optional
>
#
include
<
variant
>
#
include
<
vector
>
#
include
"
api
/
crypto
/
frame_decryptor_interface
.
h
"
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
frame_transformer_interface
.
h
"
#
include
"
api
/
rtp_headers
.
h
"
#
include
"
api
/
rtp_packet_info
.
h
"
#
include
"
api
/
rtp_parameters
.
h
"
#
include
"
api
/
scoped_refptr
.
h
"
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
api
/
task_queue
/
task_queue_base
.
h
"
#
include
"
api
/
transport
/
rtp
/
dependency_descriptor
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
api
/
video
/
color_space
.
h
"
#
include
"
api
/
video
/
encoded_frame
.
h
"
#
include
"
api
/
video
/
video_codec_constants
.
h
"
#
include
"
api
/
video
/
video_codec_type
.
h
"
#
include
"
call
/
rtp_packet_sink_interface
.
h
"
#
include
"
call
/
syncable
.
h
"
#
include
"
call
/
video_receive_stream
.
h
"
#
include
"
common_video
/
frame_instrumentation_data
.
h
"
#
include
"
modules
/
include
/
module_common_types
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
receive_statistics
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
recovered_packet_receiver
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
remote_ntp_time_estimator
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
rtcp_statistics
.
h
"
#
include
"
modules
/
rtp_rtcp
/
include
/
rtp_rtcp_defines
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
absolute_capture_time_interpolator
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
capture_clock_offset_updater
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
frame_object
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_packet_received
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_rtcp_impl2
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_rtcp_interface
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_video_header
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_video_stream_receiver_frame_transformer_delegate
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
video_rtp_depacketizer
.
h
"
#
include
"
modules
/
video_coding
/
h264_sps_pps_tracker
.
h
"
#
include
"
modules
/
video_coding
/
h26x_packet_buffer
.
h
"
#
include
"
modules
/
video_coding
/
loss_notification_controller
.
h
"
#
include
"
modules
/
video_coding
/
nack_requester
.
h
"
#
include
"
modules
/
video_coding
/
packet_buffer
.
h
"
#
include
"
modules
/
video_coding
/
rtp_frame_reference_finder
.
h
"
#
include
"
rtc_base
/
copy_on_write_buffer
.
h
"
#
include
"
rtc_base
/
experiments
/
field_trial_parser
.
h
"
#
include
"
rtc_base
/
numerics
/
sequence_number_unwrapper
.
h
"
#
include
"
rtc_base
/
system
/
no_unique_address
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
#
include
"
video
/
buffered_frame_decryptor
.
h
"
#
include
"
video
/
unique_timestamp_counter
.
h
"
#
include
"
video
/
video_stream_buffer_controller
.
h
"
namespace
webrtc
{
class
NackRequester
;
class
PacketRouter
;
class
ReceiveStatistics
;
class
RtcpRttStats
;
class
RtpPacketReceived
;
class
Transport
;
class
UlpfecReceiver
;
class
RtpVideoStreamReceiver2
:
public
LossNotificationSender
public
RecoveredPacketReceiver
public
RtpPacketSinkInterface
public
KeyFrameRequestSender
public
NackSender
public
OnDecryptedFrameCallback
public
OnDecryptionStatusChangeCallback
public
RtpVideoFrameReceiver
{
public
:
class
OnCompleteFrameCallback
{
public
:
virtual
~
OnCompleteFrameCallback
(
)
{
}
virtual
void
OnCompleteFrame
(
std
:
:
unique_ptr
<
EncodedFrame
>
frame
)
=
0
;
}
;
RtpVideoStreamReceiver2
(
const
Environment
&
env
TaskQueueBase
*
current_queue
Transport
*
transport
RtcpRttStats
*
rtt_stats
PacketRouter
*
packet_router
const
VideoReceiveStreamInterface
:
:
Config
*
config
ReceiveStatistics
*
rtp_receive_statistics
RtcpPacketTypeCounterObserver
*
rtcp_packet_type_counter_observer
RtcpCnameCallback
*
rtcp_cname_callback
NackPeriodicProcessor
*
nack_periodic_processor
VideoStreamBufferControllerStatsObserver
*
vcm_receive_statistics
OnCompleteFrameCallback
*
complete_frame_callback
scoped_refptr
<
FrameDecryptorInterface
>
frame_decryptor
scoped_refptr
<
FrameTransformerInterface
>
frame_transformer
)
;
~
RtpVideoStreamReceiver2
(
)
override
;
void
AddReceiveCodec
(
uint8_t
payload_type
VideoCodecType
video_codec
const
webrtc
:
:
CodecParameterMap
&
codec_params
bool
raw_payload
)
;
void
RemoveReceiveCodecs
(
)
;
void
StartReceive
(
)
;
void
StopReceive
(
)
;
std
:
:
optional
<
Syncable
:
:
Info
>
GetSyncInfo
(
)
const
;
bool
DeliverRtcp
(
const
uint8_t
*
rtcp_packet
size_t
rtcp_packet_length
)
;
void
FrameContinuous
(
int64_t
seq_num
)
;
void
FrameDecoded
(
int64_t
seq_num
)
;
void
SignalNetworkState
(
NetworkState
state
)
;
int
GetUniqueFramesSeen
(
)
const
{
RTC_DCHECK_RUN_ON
(
&
packet_sequence_checker_
)
;
return
frame_counter_
.
GetUniqueSeen
(
)
;
}
void
OnRtpPacket
(
const
RtpPacketReceived
&
packet
)
override
;
bool
OnReceivedPayloadData
(
CopyOnWriteBuffer
codec_payload
const
RtpPacketReceived
&
rtp_packet
const
RTPVideoHeader
&
video
int
times_nacked
)
;
void
OnRecoveredPacket
(
const
RtpPacketReceived
&
packet
)
override
;
void
RequestKeyFrame
(
)
override
;
void
SendNack
(
const
std
:
:
vector
<
uint16_t
>
&
sequence_numbers
bool
buffering_allowed
)
override
;
void
SendLossNotification
(
uint16_t
last_decoded_seq_num
uint16_t
last_received_seq_num
bool
decodability_flag
bool
buffering_allowed
)
override
;
bool
IsDecryptable
(
)
const
;
void
OnDecryptedFrame
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
override
;
void
OnDecryptionStatusChange
(
FrameDecryptorInterface
:
:
Status
status
)
override
;
void
SetFrameDecryptor
(
scoped_refptr
<
FrameDecryptorInterface
>
frame_decryptor
)
;
void
SetDepacketizerToDecoderFrameTransformer
(
scoped_refptr
<
FrameTransformerInterface
>
frame_transformer
)
;
void
UpdateRtt
(
int64_t
max_rtt_ms
)
;
void
OnLocalSsrcChange
(
uint32_t
local_ssrc
)
;
void
SetRtcpMode
(
RtcpMode
mode
)
;
void
SetReferenceTimeReport
(
bool
enabled
)
;
void
SetPacketSink
(
RtpPacketSinkInterface
*
packet_sink
)
;
void
SetLossNotificationEnabled
(
bool
enabled
)
;
void
SetNackHistory
(
TimeDelta
history
)
;
int
ulpfec_payload_type
(
)
const
;
int
red_payload_type
(
)
const
;
void
SetProtectionPayloadTypes
(
int
red_payload_type
int
ulpfec_payload_type
)
;
std
:
:
optional
<
int64_t
>
LastReceivedPacketMs
(
)
const
;
std
:
:
optional
<
uint32_t
>
LastReceivedFrameRtpTimestamp
(
)
const
;
std
:
:
optional
<
int64_t
>
LastReceivedKeyframePacketMs
(
)
const
;
std
:
:
optional
<
RtpRtcpInterface
:
:
SenderReportStats
>
GetSenderReportStats
(
)
const
;
void
RemoteRTCPSenderInfo
(
uint32_t
*
packet_count
uint32_t
*
octet_count
int64_t
*
ntp_timestamp_ms
int64_t
*
remote_ntp_timestamp_ms
)
const
;
private
:
void
ManageFrame
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
override
;
void
OnCompleteFrames
(
RtpFrameReferenceFinder
:
:
ReturnVector
frame
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
class
RtcpFeedbackBuffer
:
public
KeyFrameRequestSender
public
NackSender
public
LossNotificationSender
{
public
:
RtcpFeedbackBuffer
(
KeyFrameRequestSender
*
key_frame_request_sender
NackSender
*
nack_sender
LossNotificationSender
*
loss_notification_sender
)
;
~
RtcpFeedbackBuffer
(
)
override
=
default
;
void
RequestKeyFrame
(
)
override
;
void
SendNack
(
const
std
:
:
vector
<
uint16_t
>
&
sequence_numbers
bool
buffering_allowed
)
override
;
void
SendLossNotification
(
uint16_t
last_decoded_seq_num
uint16_t
last_received_seq_num
bool
decodability_flag
bool
buffering_allowed
)
override
;
void
SendBufferedRtcpFeedback
(
)
;
void
ClearLossNotificationState
(
)
;
private
:
struct
LossNotificationState
{
LossNotificationState
(
uint16_t
last_decoded_seq_num
uint16_t
last_received_seq_num
bool
decodability_flag
)
:
last_decoded_seq_num
(
last_decoded_seq_num
)
last_received_seq_num
(
last_received_seq_num
)
decodability_flag
(
decodability_flag
)
{
}
uint16_t
last_decoded_seq_num
;
uint16_t
last_received_seq_num
;
bool
decodability_flag
;
}
;
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
packet_sequence_checker_
;
KeyFrameRequestSender
*
const
key_frame_request_sender_
;
NackSender
*
const
nack_sender_
;
LossNotificationSender
*
const
loss_notification_sender_
;
bool
request_key_frame_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
vector
<
uint16_t
>
nack_sequence_numbers_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
optional
<
LossNotificationState
>
lntf_state_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
}
;
enum
ParseGenericDependenciesResult
{
kStashPacket
kDropPacket
kHasGenericDescriptor
kNoGenericDescriptor
}
;
void
ReceivePacket
(
const
RtpPacketReceived
&
packet
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
void
ParseAndHandleEncapsulatingHeader
(
const
RtpPacketReceived
&
packet
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
void
NotifyReceiverOfEmptyPacket
(
uint16_t
seq_num
std
:
:
optional
<
VideoCodecType
>
codec
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
bool
IsRedEnabled
(
)
const
;
void
InsertSpsPpsIntoTracker
(
uint8_t
payload_type
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
void
OnInsertedPacket
(
video_coding
:
:
PacketBuffer
:
:
InsertResult
result
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
ParseGenericDependenciesResult
ParseGenericDependenciesExtension
(
const
RtpPacketReceived
&
rtp_packet
RTPVideoHeader
*
video_header
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
void
OnAssembledFrame
(
std
:
:
unique_ptr
<
RtpFrameObject
>
frame
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
void
UpdatePacketReceiveTimestamps
(
const
RtpPacketReceived
&
packet
bool
is_keyframe
)
RTC_RUN_ON
(
packet_sequence_checker_
)
;
void
SetLastCorruptionDetectionIndex
(
const
std
:
:
variant
<
FrameInstrumentationSyncData
FrameInstrumentationData
>
&
frame_instrumentation_data
int
spatial_idx
)
;
std
:
:
optional
<
VideoCodecType
>
GetCodecFromPayloadType
(
uint8_t
payload_type
)
const
RTC_RUN_ON
(
packet_sequence_checker_
)
;
bool
UseH26xPacketBuffer
(
std
:
:
optional
<
VideoCodecType
>
codec
)
const
RTC_RUN_ON
(
packet_sequence_checker_
)
;
const
Environment
env_
;
TaskQueueBase
*
const
worker_queue_
;
const
VideoReceiveStreamInterface
:
:
Config
&
config_
;
PacketRouter
*
const
packet_router_
;
RemoteNtpTimeEstimator
ntp_estimator_
;
FieldTrialOptional
<
int
>
forced_playout_delay_max_ms_
;
FieldTrialOptional
<
int
>
forced_playout_delay_min_ms_
;
ReceiveStatistics
*
const
rtp_receive_statistics_
;
std
:
:
unique_ptr
<
UlpfecReceiver
>
ulpfec_receiver_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
int
red_payload_type_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
worker_task_checker_
;
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
packet_sequence_checker_
;
RtpPacketSinkInterface
*
packet_sink_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
bool
receiving_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
int64_t
last_packet_log_ms_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
const
std
:
:
unique_ptr
<
ModuleRtpRtcpImpl2
>
rtp_rtcp_
;
NackPeriodicProcessor
*
const
nack_periodic_processor_
;
OnCompleteFrameCallback
*
complete_frame_callback_
;
const
KeyFrameReqMethod
keyframe_request_method_
;
RtcpFeedbackBuffer
rtcp_feedback_buffer_
;
std
:
:
unique_ptr
<
NackRequester
>
nack_module_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
unique_ptr
<
LossNotificationController
>
loss_notification_controller_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
VideoStreamBufferControllerStatsObserver
*
const
vcm_receive_statistics_
;
video_coding
:
:
PacketBuffer
packet_buffer_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
unique_ptr
<
H26xPacketBuffer
>
h26x_packet_buffer_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
UniqueTimestampCounter
frame_counter_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
SeqNumUnwrapper
<
uint16_t
>
frame_id_unwrapper_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
unique_ptr
<
FrameDependencyStructure
>
video_structure_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
optional
<
int64_t
>
video_structure_frame_id_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
Timestamp
last_logged_failed_to_parse_dd_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
=
Timestamp
:
:
MinusInfinity
(
)
;
std
:
:
unique_ptr
<
RtpFrameReferenceFinder
>
reference_finder_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
optional
<
VideoCodecType
>
current_codec_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
uint32_t
last_assembled_frame_rtp_timestamp_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
map
<
int64_t
uint16_t
>
last_seq_num_for_pic_id_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
video_coding
:
:
H264SpsPpsTracker
tracker_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
map
<
uint8_t
std
:
:
unique_ptr
<
VideoRtpDepacketizer
>
>
payload_type_map_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
map
<
uint8_t
webrtc
:
:
CodecParameterMap
>
pt_codec_params_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
map
<
uint8_t
webrtc
:
:
VideoCodecType
>
pt_codec_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
int16_t
last_payload_type_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
=
-
1
;
bool
has_received_frame_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
optional
<
uint32_t
>
last_received_rtp_timestamp_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
optional
<
uint32_t
>
last_received_keyframe_rtp_timestamp_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
optional
<
Timestamp
>
last_received_rtp_system_time_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
optional
<
Timestamp
>
last_received_keyframe_rtp_system_time_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
unique_ptr
<
BufferedFrameDecryptor
>
buffered_frame_decryptor_
RTC_PT_GUARDED_BY
(
packet_sequence_checker_
)
;
bool
frames_decryptable_
RTC_GUARDED_BY
(
worker_task_checker_
)
;
std
:
:
optional
<
ColorSpace
>
last_color_space_
;
AbsoluteCaptureTimeInterpolator
absolute_capture_time_interpolator_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
CaptureClockOffsetUpdater
capture_clock_offset_updater_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
int64_t
last_completed_picture_id_
=
0
;
scoped_refptr
<
RtpVideoStreamReceiverFrameTransformerDelegate
>
frame_transformer_delegate_
;
SeqNumUnwrapper
<
uint16_t
>
rtp_seq_num_unwrapper_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
map
<
int64_t
RtpPacketInfo
>
packet_infos_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
std
:
:
vector
<
RtpPacketReceived
>
stashed_packets_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
Timestamp
next_keyframe_request_for_missing_video_structure_
=
Timestamp
:
:
MinusInfinity
(
)
;
bool
sps_pps_idr_is_h264_keyframe_
=
false
;
struct
CorruptionDetectionLayerState
{
int
sequence_index
=
0
;
std
:
:
optional
<
uint32_t
>
timestamp
;
}
;
std
:
:
array
<
CorruptionDetectionLayerState
kMaxSpatialLayers
>
last_corruption_detection_state_by_layer_
;
}
;
}
#
endif
