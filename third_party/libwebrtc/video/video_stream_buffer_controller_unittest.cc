#
include
"
video
/
video_stream_buffer_controller
.
h
"
#
include
<
stdint
.
h
>
#
include
<
cstddef
>
#
include
<
limits
>
#
include
<
memory
>
#
include
<
optional
>
#
include
<
string
>
#
include
<
tuple
>
#
include
<
utility
>
#
include
<
variant
>
#
include
<
vector
>
#
include
"
api
/
field_trials
.
h
"
#
include
"
api
/
metronome
/
test
/
fake_metronome
.
h
"
#
include
"
api
/
units
/
frequency
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
api
/
video
/
encoded_frame
.
h
"
#
include
"
api
/
video
/
video_content_type
.
h
"
#
include
"
api
/
video
/
video_timing
.
h
"
#
include
"
modules
/
video_coding
/
timing
/
timing
.
h
"
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
#
include
"
test
/
create_test_field_trials
.
h
"
#
include
"
test
/
fake_encoded_frame
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
time_controller
/
simulated_time_controller
.
h
"
#
include
"
video
/
decode_synchronizer
.
h
"
#
include
"
video
/
task_queue_frame_decode_scheduler
.
h
"
using
:
:
testing
:
:
_
;
using
:
:
testing
:
:
AllOf
;
using
:
:
testing
:
:
Contains
;
using
:
:
testing
:
:
Each
;
using
:
:
testing
:
:
Eq
;
using
:
:
testing
:
:
IsEmpty
;
using
:
:
testing
:
:
Matches
;
using
:
:
testing
:
:
Ne
;
using
:
:
testing
:
:
Not
;
using
:
:
testing
:
:
Optional
;
using
:
:
testing
:
:
Pointee
;
using
:
:
testing
:
:
SizeIs
;
using
:
:
testing
:
:
VariantWith
;
namespace
webrtc
{
namespace
{
constexpr
size_t
kFrameSize
=
10
;
constexpr
uint32_t
kFps30Rtp
=
90000
/
30
;
constexpr
TimeDelta
kFps30Delay
=
1
/
Frequency
:
:
Hertz
(
30
)
;
constexpr
Timestamp
kClockStart
=
Timestamp
:
:
Millis
(
1000
)
;
auto
TimedOut
(
)
{
return
Optional
(
VariantWith
<
TimeDelta
>
(
_
)
)
;
}
auto
Frame
(
testing
:
:
Matcher
<
EncodedFrame
>
m
)
{
return
Optional
(
VariantWith
<
std
:
:
unique_ptr
<
EncodedFrame
>
>
(
Pointee
(
m
)
)
)
;
}
std
:
:
unique_ptr
<
test
:
:
FakeEncodedFrame
>
WithReceiveTimeFromRtpTimestamp
(
std
:
:
unique_ptr
<
test
:
:
FakeEncodedFrame
>
frame
)
{
if
(
frame
-
>
RtpTimestamp
(
)
=
=
0
)
{
frame
-
>
SetReceivedTime
(
kClockStart
.
ms
(
)
)
;
}
else
{
frame
-
>
SetReceivedTime
(
TimeDelta
:
:
Seconds
(
frame
-
>
RtpTimestamp
(
)
/
90000
.
0
)
.
ms
(
)
+
kClockStart
.
ms
(
)
)
;
}
return
frame
;
}
class
VCMTimingTest
:
public
VCMTiming
{
public
:
using
VCMTiming
:
:
VCMTiming
;
void
IncomingTimestamp
(
uint32_t
rtp_timestamp
Timestamp
last_packet_time
)
override
{
IncomingTimestampMocked
(
rtp_timestamp
last_packet_time
)
;
VCMTiming
:
:
IncomingTimestamp
(
rtp_timestamp
last_packet_time
)
;
}
MOCK_METHOD
(
void
IncomingTimestampMocked
(
uint32_t
rtp_timestamp
Timestamp
last_packet_time
)
(
)
)
;
}
;
class
VideoStreamBufferControllerStatsObserverMock
:
public
VideoStreamBufferControllerStatsObserver
{
public
:
MOCK_METHOD
(
void
OnCompleteFrame
(
bool
is_keyframe
size_t
size_bytes
VideoContentType
content_type
)
(
override
)
)
;
MOCK_METHOD
(
void
OnDroppedFrames
(
uint32_t
num_dropped
)
(
override
)
)
;
MOCK_METHOD
(
void
OnDecodableFrame
(
TimeDelta
jitter_buffer_delay
TimeDelta
target_delay
TimeDelta
minimum_delay
)
(
override
)
)
;
MOCK_METHOD
(
void
OnFrameBufferTimingsUpdated
(
int
estimated_max_decode_time_ms
int
current_delay_ms
int
target_delay_ms
int
jitter_delay_ms
int
min_playout_delay_ms
int
render_delay_ms
)
(
override
)
)
;
MOCK_METHOD
(
void
OnTimingFrameInfoUpdated
(
const
TimingFrameInfo
&
info
)
(
override
)
)
;
}
;
}
constexpr
auto
kMaxWaitForKeyframe
=
TimeDelta
:
:
Millis
(
500
)
;
constexpr
auto
kMaxWaitForFrame
=
TimeDelta
:
:
Millis
(
1500
)
;
class
VideoStreamBufferControllerFixture
:
public
:
:
testing
:
:
WithParamInterface
<
std
:
:
tuple
<
bool
std
:
:
string
>
>
public
FrameSchedulingReceiver
{
public
:
VideoStreamBufferControllerFixture
(
)
:
sync_decoding_
(
std
:
:
get
<
0
>
(
GetParam
(
)
)
)
field_trials_
(
CreateTestFieldTrials
(
std
:
:
get
<
1
>
(
GetParam
(
)
)
)
)
time_controller_
(
kClockStart
)
clock_
(
time_controller_
.
GetClock
(
)
)
fake_metronome_
(
TimeDelta
:
:
Millis
(
16
)
)
decode_sync_
(
clock_
&
fake_metronome_
time_controller_
.
GetMainThread
(
)
)
timing_
(
clock_
field_trials_
)
buffer_
(
std
:
:
make_unique
<
VideoStreamBufferController
>
(
clock_
time_controller_
.
GetMainThread
(
)
&
timing_
&
stats_callback_
this
kMaxWaitForKeyframe
kMaxWaitForFrame
sync_decoding_
?
decode_sync_
.
CreateSynchronizedFrameScheduler
(
)
:
std
:
:
make_unique
<
TaskQueueFrameDecodeScheduler
>
(
clock_
time_controller_
.
GetMainThread
(
)
)
field_trials_
)
)
{
timing_
.
set_min_playout_delay
(
TimeDelta
:
:
Millis
(
10
)
)
;
ON_CALL
(
stats_callback_
OnDroppedFrames
)
.
WillByDefault
(
[
this
]
(
auto
num_dropped
)
{
dropped_frames_
+
=
num_dropped
;
}
)
;
}
~
VideoStreamBufferControllerFixture
(
)
override
{
if
(
buffer_
)
{
buffer_
-
>
Stop
(
)
;
}
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
}
void
OnEncodedFrame
(
std
:
:
unique_ptr
<
EncodedFrame
>
frame
)
override
{
RTC_DCHECK
(
frame
)
;
SetWaitResult
(
std
:
:
move
(
frame
)
)
;
}
void
OnDecodableFrameTimeout
(
TimeDelta
wait_time
)
override
{
SetWaitResult
(
wait_time
)
;
}
using
WaitResult
=
std
:
:
variant
<
std
:
:
unique_ptr
<
EncodedFrame
>
TimeDelta
>
;
std
:
:
optional
<
WaitResult
>
WaitForFrameOrTimeout
(
TimeDelta
wait
)
{
if
(
wait_result_
)
{
return
std
:
:
move
(
wait_result_
)
;
}
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
if
(
wait_result_
)
{
return
std
:
:
move
(
wait_result_
)
;
}
Timestamp
now
=
clock_
-
>
CurrentTime
(
)
;
TimeDelta
potential_extra_wait
=
Timestamp
:
:
Millis
(
(
now
+
wait
)
.
ms
(
)
)
-
(
now
+
wait
)
;
time_controller_
.
AdvanceTime
(
wait
)
;
if
(
potential_extra_wait
>
TimeDelta
:
:
Zero
(
)
)
{
time_controller_
.
AdvanceTime
(
potential_extra_wait
)
;
}
return
std
:
:
move
(
wait_result_
)
;
}
void
StartNextDecode
(
)
{
ResetLastResult
(
)
;
buffer_
-
>
StartNextDecode
(
false
)
;
}
void
StartNextDecodeForceKeyframe
(
)
{
ResetLastResult
(
)
;
buffer_
-
>
StartNextDecode
(
true
)
;
}
void
ResetLastResult
(
)
{
wait_result_
.
reset
(
)
;
}
int
dropped_frames
(
)
const
{
return
dropped_frames_
;
}
protected
:
const
bool
sync_decoding_
;
FieldTrials
field_trials_
;
GlobalSimulatedTimeController
time_controller_
;
Clock
*
const
clock_
;
test
:
:
FakeMetronome
fake_metronome_
;
DecodeSynchronizer
decode_sync_
;
:
:
testing
:
:
NiceMock
<
VCMTimingTest
>
timing_
;
:
:
testing
:
:
NiceMock
<
VideoStreamBufferControllerStatsObserverMock
>
stats_callback_
;
std
:
:
unique_ptr
<
VideoStreamBufferController
>
buffer_
;
private
:
void
SetWaitResult
(
WaitResult
result
)
{
RTC_DCHECK
(
!
wait_result_
)
;
if
(
std
:
:
holds_alternative
<
std
:
:
unique_ptr
<
EncodedFrame
>
>
(
result
)
)
{
RTC_DCHECK
(
std
:
:
get
<
std
:
:
unique_ptr
<
EncodedFrame
>
>
(
result
)
)
;
}
wait_result_
.
emplace
(
std
:
:
move
(
result
)
)
;
}
uint32_t
dropped_frames_
=
0
;
std
:
:
optional
<
WaitResult
>
wait_result_
;
}
;
class
VideoStreamBufferControllerTest
:
public
:
:
testing
:
:
Test
public
VideoStreamBufferControllerFixture
{
}
;
TEST_P
(
VideoStreamBufferControllerTest
InitialTimeoutAfterKeyframeTimeoutPeriod
)
{
StartNextDecodeForceKeyframe
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForKeyframe
)
TimedOut
(
)
)
;
ResetLastResult
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForKeyframe
)
Eq
(
std
:
:
nullopt
)
)
;
StartNextDecodeForceKeyframe
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForKeyframe
)
TimedOut
(
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
KeyFramesAreScheduled
)
{
StartNextDecodeForceKeyframe
(
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
50
)
)
;
auto
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
DeltaFrameTimeoutAfterKeyframeExtracted
)
{
StartNextDecodeForceKeyframe
(
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
50
)
)
;
auto
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForKeyframe
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
50
)
)
;
const
int
expected_timeouts
=
5
;
for
(
int
i
=
0
;
i
<
expected_timeouts
;
+
+
i
)
{
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForFrame
)
TimedOut
(
)
)
;
StartNextDecode
(
)
;
}
}
TEST_P
(
VideoStreamBufferControllerTest
DependantFramesAreScheduled
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
1
)
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
SpatialLayersAreScheduled
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
SpatialLayer
(
0
)
.
Time
(
0
)
.
Build
(
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
SpatialLayer
(
1
)
.
Time
(
0
)
.
Build
(
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
SpatialLayer
(
2
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
AllOf
(
test
:
:
WithId
(
0
)
test
:
:
FrameWithSize
(
3
*
kFrameSize
)
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
3
)
.
Time
(
kFps30Rtp
)
.
SpatialLayer
(
0
)
.
Build
(
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
4
)
.
Time
(
kFps30Rtp
)
.
SpatialLayer
(
1
)
.
Build
(
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
5
)
.
Time
(
kFps30Rtp
)
.
SpatialLayer
(
2
)
.
AsLast
(
)
.
Build
(
)
)
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
*
10
)
Frame
(
AllOf
(
test
:
:
WithId
(
3
)
test
:
:
FrameWithSize
(
3
*
kFrameSize
)
)
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
OutstandingFrameTasksAreCancelledAfterDeletion
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
)
;
buffer_
-
>
Stop
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForFrame
*
2
)
Eq
(
std
:
:
nullopt
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
FramesWaitForDecoderToComplete
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
ResetLastResult
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Eq
(
std
:
:
nullopt
)
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
1
)
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
LateFrameDropped
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
*
2
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
2
*
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
2
)
)
)
;
StartNextDecode
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
1
*
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForFrame
)
TimedOut
(
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
FramesFastForwardOnSystemHalt
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
2
*
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
*
2
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
2
)
)
)
;
EXPECT_EQ
(
dropped_frames
(
)
1
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
ForceKeyFrame
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
AsLast
(
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
kFps30Rtp
*
2
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
*
3
)
Frame
(
test
:
:
WithId
(
2
)
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
SlowDecoderDropsTemporalLayers
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
1
*
kFps30Rtp
)
.
Refs
(
{
0
}
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
2
*
kFps30Rtp
)
.
Refs
(
{
0
}
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
*
1
.
5
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
*
2
)
Frame
(
test
:
:
WithId
(
2
)
)
)
;
EXPECT_EQ
(
dropped_frames
(
)
1
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
/
2
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
3
)
.
Time
(
3
*
kFps30Rtp
)
.
Refs
(
{
1
2
}
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
/
2
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
4
)
.
Time
(
4
*
kFps30Rtp
)
.
Refs
(
{
2
}
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
/
2
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
4
)
)
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
5
)
.
Time
(
5
*
kFps30Rtp
)
.
Refs
(
{
3
4
}
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
/
2
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
10
)
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForFrame
)
TimedOut
(
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
NewFrameInsertedWhileWaitingToReleaseFrame
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
/
2
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
Refs
(
{
0
}
)
.
AsLast
(
)
.
Build
(
)
)
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Eq
(
std
:
:
nullopt
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
kFps30Rtp
*
2
)
.
Refs
(
{
0
}
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
1
)
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
SameFrameNotScheduledTwice
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Millis
(
15
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
2
*
kFps30Rtp
)
.
AsLast
(
)
.
Build
(
)
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
3
)
.
Time
(
3
*
kFps30Rtp
)
.
AsLast
(
)
.
Build
(
)
)
)
;
time_controller_
.
AdvanceTime
(
kFps30Delay
/
2
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
1
*
kFps30Rtp
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
2
)
)
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
3
)
)
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForFrame
)
TimedOut
(
)
)
;
EXPECT_EQ
(
dropped_frames
(
)
1
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
TestStatsCallback
)
{
EXPECT_CALL
(
stats_callback_
OnCompleteFrame
(
true
kFrameSize
VideoContentType
:
:
UNSPECIFIED
)
)
;
EXPECT_CALL
(
stats_callback_
OnDecodableFrame
)
;
EXPECT_CALL
(
stats_callback_
OnFrameBufferTimingsUpdated
)
;
timing_
.
StopDecodeTimer
(
TimeDelta
:
:
Millis
(
1
)
clock_
-
>
CurrentTime
(
)
)
;
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
FrameCompleteCalledOnceForDuplicateFrame
)
{
EXPECT_CALL
(
stats_callback_
OnCompleteFrame
(
true
kFrameSize
VideoContentType
:
:
UNSPECIFIED
)
)
.
Times
(
1
)
;
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
FrameCompleteCalledOnceForSingleTemporalUnit
)
{
StartNextDecodeForceKeyframe
(
)
;
EXPECT_CALL
(
stats_callback_
OnCompleteFrame
(
_
_
_
)
)
.
Times
(
0
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
Build
(
)
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
0
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
:
:
testing
:
:
Mock
:
:
VerifyAndClearExpectations
(
&
stats_callback_
)
;
EXPECT_CALL
(
stats_callback_
OnCompleteFrame
(
false
kFrameSize
VideoContentType
:
:
UNSPECIFIED
)
)
.
Times
(
1
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
0
)
.
Refs
(
{
0
1
}
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
FrameCompleteCalledOnceForCompleteTemporalUnit
)
{
StartNextDecodeForceKeyframe
(
)
;
EXPECT_CALL
(
stats_callback_
OnCompleteFrame
(
_
_
_
)
)
.
Times
(
0
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
Build
(
)
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
0
)
.
Refs
(
{
0
1
}
)
.
AsLast
(
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
:
:
testing
:
:
Mock
:
:
VerifyAndClearExpectations
(
&
stats_callback_
)
;
EXPECT_CALL
(
stats_callback_
OnCompleteFrame
(
false
kFrameSize
VideoContentType
:
:
UNSPECIFIED
)
)
.
Times
(
1
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
0
)
.
Refs
(
{
0
}
)
.
Build
(
)
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Zero
(
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
NextFrameWithOldTimestamp
)
{
StartNextDecodeForceKeyframe
(
)
;
constexpr
uint32_t
kBaseRtp
=
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
/
2
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
kBaseRtp
)
.
ReceivedTime
(
clock_
-
>
CurrentTime
(
)
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kBaseRtp
+
kFps30Rtp
)
.
ReceivedTime
(
clock_
-
>
CurrentTime
(
)
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
1
)
)
)
;
constexpr
uint32_t
kLastRtp
=
kBaseRtp
+
kFps30Rtp
;
constexpr
uint32_t
kRolloverRtp
=
kLastRtp
+
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
/
2
+
1
;
constexpr
Frequency
kRtpHz
=
Frequency
:
:
KiloHertz
(
90
)
;
constexpr
TimeDelta
kRolloverDelay
=
(
std
:
:
numeric_limits
<
uint32_t
>
:
:
max
(
)
/
2
+
1
)
/
kRtpHz
;
ResetLastResult
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForFrame
)
Eq
(
std
:
:
nullopt
)
)
;
time_controller_
.
AdvanceTime
(
kRolloverDelay
-
kMaxWaitForFrame
)
;
StartNextDecode
(
)
;
buffer_
-
>
InsertFrame
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
kRolloverRtp
)
.
ReceivedTime
(
clock_
-
>
CurrentTime
(
)
)
.
AsLast
(
)
.
Build
(
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
2
)
)
)
;
}
TEST_P
(
VideoStreamBufferControllerTest
FrameNotSetForDecodedIfFrameBufferBecomesNonDecodable
)
{
StartNextDecodeForceKeyframe
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
SpatialLayer
(
1
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
11
)
.
Time
(
kFps30Rtp
)
.
Refs
(
{
0
}
)
.
SpatialLayer
(
1
)
.
AsLast
(
)
.
Build
(
)
)
)
;
StartNextDecode
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
10
)
.
Time
(
kFps30Rtp
)
.
SpatialLayer
(
0
)
.
Refs
(
{
2
}
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kMaxWaitForFrame
)
TimedOut
(
)
)
;
StartNextDecode
(
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
Time
(
kFps30Rtp
/
2
)
.
SpatialLayer
(
0
)
.
Refs
(
{
0
}
)
.
AsLast
(
)
.
Build
(
)
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
2
)
)
)
;
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
kFps30Delay
)
Frame
(
test
:
:
WithId
(
10
)
)
)
;
}
INSTANTIATE_TEST_SUITE_P
(
VideoStreamBufferController
VideoStreamBufferControllerTest
:
:
testing
:
:
Combine
(
:
:
testing
:
:
Bool
(
)
:
:
testing
:
:
Values
(
"
"
)
)
[
]
(
const
auto
&
info
)
{
return
std
:
:
get
<
0
>
(
info
.
param
)
?
"
SyncDecoding
"
:
"
UnsyncedDecoding
"
;
}
)
;
class
LowLatencyVideoStreamBufferControllerTest
:
public
:
:
testing
:
:
Test
public
VideoStreamBufferControllerFixture
{
}
;
TEST_P
(
LowLatencyVideoStreamBufferControllerTest
FramesDecodedInstantlyWithLowLatencyRendering
)
{
StartNextDecodeForceKeyframe
(
)
;
timing_
.
set_playout_delay
(
{
TimeDelta
:
:
Zero
(
)
TimeDelta
:
:
Millis
(
10
)
}
)
;
auto
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
PlayoutDelay
(
{
TimeDelta
:
:
Zero
(
)
TimeDelta
:
:
Millis
(
10
)
}
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
PlayoutDelay
(
{
TimeDelta
:
:
Zero
(
)
TimeDelta
:
:
Millis
(
10
)
}
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Eq
(
std
:
:
nullopt
)
)
;
time_controller_
.
AdvanceTime
(
TimeDelta
:
:
Millis
(
16
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
1
)
)
)
;
}
TEST_P
(
LowLatencyVideoStreamBufferControllerTest
ZeroPlayoutDelayFullQueue
)
{
StartNextDecodeForceKeyframe
(
)
;
timing_
.
set_playout_delay
(
{
TimeDelta
:
:
Zero
(
)
TimeDelta
:
:
Millis
(
10
)
}
)
;
auto
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
PlayoutDelay
(
{
TimeDelta
:
:
Zero
(
)
TimeDelta
:
:
Millis
(
10
)
}
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
for
(
int
id
=
1
;
id
<
=
6
;
+
+
id
)
{
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
id
)
.
Time
(
kFps30Rtp
*
id
)
.
PlayoutDelay
(
{
TimeDelta
:
:
Zero
(
)
TimeDelta
:
:
Millis
(
10
)
}
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
}
StartNextDecode
(
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
1
)
)
)
;
}
TEST_P
(
LowLatencyVideoStreamBufferControllerTest
MinMaxDelayZeroLowLatencyMode
)
{
StartNextDecodeForceKeyframe
(
)
;
timing_
.
set_playout_delay
(
{
TimeDelta
:
:
Zero
(
)
TimeDelta
:
:
Zero
(
)
}
)
;
auto
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
Time
(
0
)
.
PlayoutDelay
(
VideoPlayoutDelay
:
:
Minimal
(
)
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
0
)
)
)
;
StartNextDecode
(
)
;
frame
=
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
Time
(
kFps30Rtp
)
.
PlayoutDelay
(
VideoPlayoutDelay
:
:
Minimal
(
)
)
.
AsLast
(
)
.
Build
(
)
;
buffer_
-
>
InsertFrame
(
std
:
:
move
(
frame
)
)
;
EXPECT_THAT
(
WaitForFrameOrTimeout
(
TimeDelta
:
:
Zero
(
)
)
Frame
(
test
:
:
WithId
(
1
)
)
)
;
}
INSTANTIATE_TEST_SUITE_P
(
VideoStreamBufferController
LowLatencyVideoStreamBufferControllerTest
:
:
testing
:
:
Combine
(
:
:
testing
:
:
Bool
(
)
:
:
testing
:
:
Values
(
"
WebRTC
-
ZeroPlayoutDelay
/
min_pacing
:
16ms
max_decode_queue_size
:
5
/
"
"
WebRTC
-
ZeroPlayoutDelay
/
"
"
min_pacing
:
16ms
max_decode_queue_size
:
5
/
"
)
)
)
;
class
IncomingTimestampVideoStreamBufferControllerTest
:
public
:
:
testing
:
:
Test
public
VideoStreamBufferControllerFixture
{
}
;
TEST_P
(
IncomingTimestampVideoStreamBufferControllerTest
IncomingTimestampOnMarkerBitOnly
)
{
StartNextDecodeForceKeyframe
(
)
;
EXPECT_CALL
(
timing_
IncomingTimestampMocked
)
.
Times
(
field_trials_
.
IsDisabled
(
"
WebRTC
-
IncomingTimestampOnMarkerBitOnly
"
)
?
3
:
1
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
0
)
.
SpatialLayer
(
0
)
.
Time
(
0
)
.
Build
(
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
1
)
.
SpatialLayer
(
1
)
.
Time
(
0
)
.
Build
(
)
)
)
;
buffer_
-
>
InsertFrame
(
WithReceiveTimeFromRtpTimestamp
(
test
:
:
FakeFrameBuilder
(
)
.
Id
(
2
)
.
SpatialLayer
(
2
)
.
Time
(
0
)
.
AsLast
(
)
.
Build
(
)
)
)
;
}
INSTANTIATE_TEST_SUITE_P
(
VideoStreamBufferController
IncomingTimestampVideoStreamBufferControllerTest
:
:
testing
:
:
Combine
(
:
:
testing
:
:
Bool
(
)
:
:
testing
:
:
Values
(
"
WebRTC
-
IncomingTimestampOnMarkerBitOnly
/
Enabled
/
"
"
WebRTC
-
IncomingTimestampOnMarkerBitOnly
/
Disabled
/
"
)
)
)
;
}
