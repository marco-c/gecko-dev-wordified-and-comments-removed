#
include
"
video
/
adaptation
/
bitrate_constraint
.
h
"
#
include
<
utility
>
#
include
<
vector
>
#
include
"
api
/
video_codecs
/
video_encoder
.
h
"
#
include
"
call
/
adaptation
/
encoder_settings
.
h
"
#
include
"
call
/
adaptation
/
test
/
fake_frame_rate_provider
.
h
"
#
include
"
call
/
adaptation
/
video_source_restrictions
.
h
"
#
include
"
call
/
adaptation
/
video_stream_input_state_provider
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
namespace
{
const
VideoSourceRestrictions
k360p
{
640
*
360
640
*
360
30
}
;
const
VideoSourceRestrictions
k720p
{
1280
*
720
1280
*
720
30
}
;
void
FillCodecConfig
(
VideoCodec
*
video_codec
VideoEncoderConfig
*
encoder_config
int
width_px
int
height_px
std
:
:
vector
<
bool
>
active_flags
)
{
size_t
num_layers
=
active_flags
.
size
(
)
;
video_codec
-
>
codecType
=
kVideoCodecVP8
;
video_codec
-
>
numberOfSimulcastStreams
=
num_layers
;
encoder_config
-
>
number_of_streams
=
num_layers
;
encoder_config
-
>
simulcast_layers
.
resize
(
num_layers
)
;
for
(
size_t
layer_idx
=
0
;
layer_idx
<
num_layers
;
+
+
layer_idx
)
{
int
layer_width_px
=
width_px
>
>
(
num_layers
-
1
-
layer_idx
)
;
int
layer_height_px
=
height_px
>
>
(
num_layers
-
1
-
layer_idx
)
;
video_codec
-
>
simulcastStream
[
layer_idx
]
.
active
=
active_flags
[
layer_idx
]
;
video_codec
-
>
simulcastStream
[
layer_idx
]
.
width
=
layer_width_px
;
video_codec
-
>
simulcastStream
[
layer_idx
]
.
height
=
layer_height_px
;
encoder_config
-
>
simulcast_layers
[
layer_idx
]
.
active
=
active_flags
[
layer_idx
]
;
encoder_config
-
>
simulcast_layers
[
layer_idx
]
.
width
=
layer_width_px
;
encoder_config
-
>
simulcast_layers
[
layer_idx
]
.
height
=
layer_height_px
;
}
}
constexpr
int
kStartBitrateBps720p
=
1000000
;
VideoEncoder
:
:
EncoderInfo
MakeEncoderInfo
(
)
{
VideoEncoder
:
:
EncoderInfo
encoder_info
;
encoder_info
.
resolution_bitrate_limits
=
{
{
640
*
360
500000
0
5000000
}
{
1280
*
720
kStartBitrateBps720p
0
5000000
}
{
1920
*
1080
2000000
0
5000000
}
}
;
return
encoder_info
;
}
}
class
BitrateConstraintTest
:
public
:
:
testing
:
:
Test
{
public
:
BitrateConstraintTest
(
)
:
frame_rate_provider_
(
)
input_state_provider_
(
&
frame_rate_provider_
)
{
}
protected
:
void
OnEncoderSettingsUpdated
(
int
width_px
int
height_px
std
:
:
vector
<
bool
>
active_flags
)
{
VideoCodec
video_codec
;
VideoEncoderConfig
encoder_config
;
FillCodecConfig
(
&
video_codec
&
encoder_config
width_px
height_px
active_flags
)
;
EncoderSettings
encoder_settings
(
MakeEncoderInfo
(
)
std
:
:
move
(
encoder_config
)
video_codec
)
;
bitrate_constraint_
.
OnEncoderSettingsUpdated
(
encoder_settings
)
;
input_state_provider_
.
OnEncoderSettingsChanged
(
encoder_settings
)
;
}
FakeFrameRateProvider
frame_rate_provider_
;
VideoStreamInputStateProvider
input_state_provider_
;
BitrateConstraint
bitrate_constraint_
;
}
;
TEST_F
(
BitrateConstraintTest
AdaptUpAllowedAtSinglecastIfBitrateIsEnough
)
{
OnEncoderSettingsUpdated
(
640
360
{
true
}
)
;
bitrate_constraint_
.
OnEncoderTargetBitrateUpdated
(
kStartBitrateBps720p
)
;
EXPECT_TRUE
(
bitrate_constraint_
.
IsAdaptationUpAllowed
(
input_state_provider_
.
InputState
(
)
k360p
k720p
)
)
;
}
TEST_F
(
BitrateConstraintTest
AdaptUpDisallowedAtSinglecastIfBitrateIsNotEnough
)
{
OnEncoderSettingsUpdated
(
640
360
{
true
}
)
;
bitrate_constraint_
.
OnEncoderTargetBitrateUpdated
(
kStartBitrateBps720p
-
1
)
;
EXPECT_FALSE
(
bitrate_constraint_
.
IsAdaptationUpAllowed
(
input_state_provider_
.
InputState
(
)
k360p
k720p
)
)
;
}
TEST_F
(
BitrateConstraintTest
AdaptUpAllowedAtSinglecastUpperLayerActiveIfBitrateIsEnough
)
{
OnEncoderSettingsUpdated
(
640
360
{
false
true
}
)
;
bitrate_constraint_
.
OnEncoderTargetBitrateUpdated
(
kStartBitrateBps720p
)
;
EXPECT_TRUE
(
bitrate_constraint_
.
IsAdaptationUpAllowed
(
input_state_provider_
.
InputState
(
)
k360p
k720p
)
)
;
}
TEST_F
(
BitrateConstraintTest
AdaptUpDisallowedAtSinglecastUpperLayerActiveIfBitrateIsNotEnough
)
{
OnEncoderSettingsUpdated
(
640
360
{
false
true
}
)
;
bitrate_constraint_
.
OnEncoderTargetBitrateUpdated
(
kStartBitrateBps720p
-
1
)
;
EXPECT_FALSE
(
bitrate_constraint_
.
IsAdaptationUpAllowed
(
input_state_provider_
.
InputState
(
)
k360p
k720p
)
)
;
}
TEST_F
(
BitrateConstraintTest
AdaptUpAllowedAtSinglecastLowestLayerActiveIfBitrateIsNotEnough
)
{
OnEncoderSettingsUpdated
(
640
360
{
true
false
}
)
;
bitrate_constraint_
.
OnEncoderTargetBitrateUpdated
(
kStartBitrateBps720p
-
1
)
;
EXPECT_TRUE
(
bitrate_constraint_
.
IsAdaptationUpAllowed
(
input_state_provider_
.
InputState
(
)
k360p
k720p
)
)
;
}
TEST_F
(
BitrateConstraintTest
AdaptUpAllowedAtSimulcastIfBitrateIsNotEnough
)
{
OnEncoderSettingsUpdated
(
640
360
{
true
true
}
)
;
bitrate_constraint_
.
OnEncoderTargetBitrateUpdated
(
kStartBitrateBps720p
-
1
)
;
EXPECT_TRUE
(
bitrate_constraint_
.
IsAdaptationUpAllowed
(
input_state_provider_
.
InputState
(
)
k360p
k720p
)
)
;
}
TEST_F
(
BitrateConstraintTest
AdaptUpInFpsAllowedAtNoResolutionIncreaseIfBitrateIsNotEnough
)
{
OnEncoderSettingsUpdated
(
640
360
{
true
}
)
;
bitrate_constraint_
.
OnEncoderTargetBitrateUpdated
(
1
)
;
EXPECT_TRUE
(
bitrate_constraint_
.
IsAdaptationUpAllowed
(
input_state_provider_
.
InputState
(
)
k360p
k360p
)
)
;
}
}
