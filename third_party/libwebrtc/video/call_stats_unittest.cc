#
include
"
video
/
call_stats
.
h
"
#
include
<
memory
>
#
include
"
modules
/
rtp_rtcp
/
include
/
rtp_rtcp_defines
.
h
"
#
include
"
modules
/
utility
/
include
/
process_thread
.
h
"
#
include
"
rtc_base
/
event
.
h
"
#
include
"
rtc_base
/
location
.
h
"
#
include
"
rtc_base
/
task_utils
/
to_queued_task
.
h
"
#
include
"
system_wrappers
/
include
/
metrics
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
using
:
:
testing
:
:
AnyNumber
;
using
:
:
testing
:
:
InvokeWithoutArgs
;
using
:
:
testing
:
:
Return
;
namespace
webrtc
{
class
MockStatsObserver
:
public
CallStatsObserver
{
public
:
MockStatsObserver
(
)
{
}
virtual
~
MockStatsObserver
(
)
{
}
MOCK_METHOD
(
void
OnRttUpdate
(
int64_t
int64_t
)
(
override
)
)
;
}
;
class
CallStatsTest
:
public
:
:
testing
:
:
Test
{
public
:
CallStatsTest
(
)
{
process_thread_
-
>
RegisterModule
(
&
call_stats_
RTC_FROM_HERE
)
;
process_thread_
-
>
Start
(
)
;
}
~
CallStatsTest
(
)
override
{
process_thread_
-
>
Stop
(
)
;
process_thread_
-
>
DeRegisterModule
(
&
call_stats_
)
;
}
void
AsyncSimulateRttUpdate
(
int64_t
rtt
)
{
RtcpRttStats
*
rtcp_rtt_stats
=
&
call_stats_
;
process_thread_
-
>
PostTask
(
ToQueuedTask
(
[
rtcp_rtt_stats
rtt
]
{
rtcp_rtt_stats
-
>
OnRttUpdate
(
rtt
)
;
}
)
)
;
}
protected
:
std
:
:
unique_ptr
<
ProcessThread
>
process_thread_
{
ProcessThread
:
:
Create
(
"
CallStats
"
)
}
;
SimulatedClock
fake_clock_
{
12345
}
;
CallStats
call_stats_
{
&
fake_clock_
process_thread_
.
get
(
)
}
;
}
;
TEST_F
(
CallStatsTest
AddAndTriggerCallback
)
{
rtc
:
:
Event
event
;
static
constexpr
const
int64_t
kRtt
=
25
;
MockStatsObserver
stats_observer
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
event
]
{
event
.
Set
(
)
;
}
)
)
;
RtcpRttStats
*
rtcp_rtt_stats
=
&
call_stats_
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer
)
;
EXPECT_EQ
(
-
1
rtcp_rtt_stats
-
>
LastProcessedRtt
(
)
)
;
AsyncSimulateRttUpdate
(
kRtt
)
;
EXPECT_TRUE
(
event
.
Wait
(
1000
)
)
;
EXPECT_EQ
(
kRtt
rtcp_rtt_stats
-
>
LastProcessedRtt
(
)
)
;
call_stats_
.
DeregisterStatsObserver
(
&
stats_observer
)
;
}
TEST_F
(
CallStatsTest
ProcessTime
)
{
rtc
:
:
Event
event
;
static
constexpr
const
int64_t
kRtt
=
100
;
static
constexpr
const
int64_t
kRtt2
=
80
;
RtcpRttStats
*
rtcp_rtt_stats
=
&
call_stats_
;
MockStatsObserver
stats_observer
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
2
)
.
WillOnce
(
InvokeWithoutArgs
(
[
this
]
{
fake_clock_
.
AdvanceTimeMilliseconds
(
CallStats
:
:
kUpdateIntervalMs
)
;
}
)
)
.
WillRepeatedly
(
InvokeWithoutArgs
(
[
this
rtcp_rtt_stats
]
{
rtcp_rtt_stats
-
>
OnRttUpdate
(
kRtt2
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
CallStats
:
:
kUpdateIntervalMs
-
1
)
;
}
)
)
;
static
constexpr
const
int64_t
kLastAvg
=
94
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kLastAvg
kRtt2
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
event
]
{
event
.
Set
(
)
;
}
)
)
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer
)
;
AsyncSimulateRttUpdate
(
kRtt
)
;
EXPECT_TRUE
(
event
.
Wait
(
1000
)
)
;
call_stats_
.
DeregisterStatsObserver
(
&
stats_observer
)
;
}
TEST_F
(
CallStatsTest
MultipleObservers
)
{
MockStatsObserver
stats_observer_1
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer_1
)
;
MockStatsObserver
stats_observer_2
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer_2
)
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer_2
)
;
static
constexpr
const
int64_t
kRtt
=
100
;
rtc
:
:
Event
ev1
;
rtc
:
:
Event
ev2
;
EXPECT_CALL
(
stats_observer_1
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
AnyNumber
(
)
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
ev1
]
{
ev1
.
Set
(
)
;
}
)
)
.
WillRepeatedly
(
Return
(
)
)
;
EXPECT_CALL
(
stats_observer_2
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
AnyNumber
(
)
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
ev2
]
{
ev2
.
Set
(
)
;
}
)
)
.
WillRepeatedly
(
Return
(
)
)
;
AsyncSimulateRttUpdate
(
kRtt
)
;
ASSERT_TRUE
(
ev1
.
Wait
(
100
)
)
;
ASSERT_TRUE
(
ev2
.
Wait
(
100
)
)
;
call_stats_
.
DeregisterStatsObserver
(
&
stats_observer_2
)
;
EXPECT_CALL
(
stats_observer_1
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
AnyNumber
(
)
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
ev1
]
{
ev1
.
Set
(
)
;
}
)
)
.
WillRepeatedly
(
Return
(
)
)
;
EXPECT_CALL
(
stats_observer_2
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
0
)
;
AsyncSimulateRttUpdate
(
kRtt
)
;
ASSERT_TRUE
(
ev1
.
Wait
(
100
)
)
;
call_stats_
.
DeregisterStatsObserver
(
&
stats_observer_1
)
;
EXPECT_CALL
(
stats_observer_1
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
0
)
;
EXPECT_CALL
(
stats_observer_2
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
0
)
;
AsyncSimulateRttUpdate
(
kRtt
)
;
process_thread_
-
>
WakeUp
(
&
call_stats_
)
;
rtc
:
:
Event
event
;
process_thread_
-
>
PostTask
(
ToQueuedTask
(
[
&
event
]
{
event
.
Set
(
)
;
}
)
)
;
event
.
Wait
(
rtc
:
:
Event
:
:
kForever
)
;
}
TEST_F
(
CallStatsTest
ChangeRtt
)
{
MockStatsObserver
stats_observer
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer
)
;
RtcpRttStats
*
rtcp_rtt_stats
=
&
call_stats_
;
rtc
:
:
Event
event
;
static
constexpr
const
int64_t
kFirstRtt
=
100
;
static
constexpr
const
int64_t
kLowRtt
=
kFirstRtt
-
20
;
static
constexpr
const
int64_t
kHighRtt
=
kFirstRtt
+
20
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kFirstRtt
kFirstRtt
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
rtcp_rtt_stats
this
]
{
fake_clock_
.
AdvanceTimeMilliseconds
(
1000
)
;
rtcp_rtt_stats
-
>
OnRttUpdate
(
kHighRtt
)
;
}
)
)
;
static
constexpr
const
int64_t
kAvgRtt1
=
103
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kAvgRtt1
kHighRtt
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
rtcp_rtt_stats
this
]
{
fake_clock_
.
AdvanceTimeMilliseconds
(
1000
)
;
rtcp_rtt_stats
-
>
OnRttUpdate
(
kLowRtt
)
;
}
)
)
;
static
constexpr
const
int64_t
kAvgRtt2
=
102
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kAvgRtt2
kHighRtt
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
this
]
{
fake_clock_
.
AdvanceTimeMilliseconds
(
1000
)
;
}
)
)
;
static
constexpr
const
int64_t
kAvgRtt3
=
95
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kAvgRtt3
kLowRtt
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
&
event
]
{
event
.
Set
(
)
;
}
)
)
;
AsyncSimulateRttUpdate
(
kFirstRtt
)
;
EXPECT_TRUE
(
event
.
Wait
(
1000
)
)
;
call_stats_
.
DeregisterStatsObserver
(
&
stats_observer
)
;
}
TEST_F
(
CallStatsTest
LastProcessedRtt
)
{
rtc
:
:
Event
event
;
MockStatsObserver
stats_observer
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer
)
;
RtcpRttStats
*
rtcp_rtt_stats
=
&
call_stats_
;
static
constexpr
const
int64_t
kRttLow
=
10
;
static
constexpr
const
int64_t
kRttHigh
=
30
;
static
constexpr
const
int64_t
kAvgRtt1
=
13
;
static
constexpr
const
int64_t
kAvgRtt2
=
15
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kRttLow
kRttLow
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
rtcp_rtt_stats
]
{
EXPECT_EQ
(
kRttLow
rtcp_rtt_stats
-
>
LastProcessedRtt
(
)
)
;
rtcp_rtt_stats
-
>
OnRttUpdate
(
kRttHigh
)
;
}
)
)
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kAvgRtt1
kRttHigh
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
rtcp_rtt_stats
this
]
{
EXPECT_EQ
(
kAvgRtt1
rtcp_rtt_stats
-
>
LastProcessedRtt
(
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
CallStats
:
:
kUpdateIntervalMs
)
;
rtcp_rtt_stats
-
>
OnRttUpdate
(
kRttLow
)
;
rtcp_rtt_stats
-
>
OnRttUpdate
(
kRttHigh
)
;
}
)
)
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kAvgRtt2
kRttHigh
)
)
.
Times
(
1
)
.
WillOnce
(
InvokeWithoutArgs
(
[
rtcp_rtt_stats
&
event
]
{
EXPECT_EQ
(
kAvgRtt2
rtcp_rtt_stats
-
>
LastProcessedRtt
(
)
)
;
event
.
Set
(
)
;
}
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
CallStats
:
:
kUpdateIntervalMs
)
;
AsyncSimulateRttUpdate
(
kRttLow
)
;
EXPECT_TRUE
(
event
.
Wait
(
1000
)
)
;
EXPECT_EQ
(
kAvgRtt2
rtcp_rtt_stats
-
>
LastProcessedRtt
(
)
)
;
call_stats_
.
DeregisterStatsObserver
(
&
stats_observer
)
;
}
TEST_F
(
CallStatsTest
ProducesHistogramMetrics
)
{
metrics
:
:
Reset
(
)
;
rtc
:
:
Event
event
;
static
constexpr
const
int64_t
kRtt
=
123
;
MockStatsObserver
stats_observer
;
call_stats_
.
RegisterStatsObserver
(
&
stats_observer
)
;
EXPECT_CALL
(
stats_observer
OnRttUpdate
(
kRtt
kRtt
)
)
.
Times
(
AnyNumber
(
)
)
.
WillRepeatedly
(
InvokeWithoutArgs
(
[
&
event
]
{
event
.
Set
(
)
;
}
)
)
;
AsyncSimulateRttUpdate
(
kRtt
)
;
EXPECT_TRUE
(
event
.
Wait
(
1000
)
)
;
fake_clock_
.
AdvanceTimeMilliseconds
(
metrics
:
:
kMinRunTimeInSeconds
*
CallStats
:
:
kUpdateIntervalMs
)
;
AsyncSimulateRttUpdate
(
kRtt
)
;
EXPECT_TRUE
(
event
.
Wait
(
1000
)
)
;
call_stats_
.
DeregisterStatsObserver
(
&
stats_observer
)
;
process_thread_
-
>
Stop
(
)
;
call_stats_
.
UpdateHistogramsForTest
(
)
;
EXPECT_METRIC_EQ
(
1
metrics
:
:
NumSamples
(
"
WebRTC
.
Video
.
AverageRoundTripTimeInMilliseconds
"
)
)
;
EXPECT_METRIC_EQ
(
1
metrics
:
:
NumEvents
(
"
WebRTC
.
Video
.
AverageRoundTripTimeInMilliseconds
"
kRtt
)
)
;
}
}
