#
include
"
video
/
quality_convergence_controller
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
scoped_key_value_config
.
h
"
namespace
webrtc
{
namespace
{
constexpr
int
kStaticQpThreshold
=
15
;
TEST
(
QualityConvergenceController
Singlecast
)
{
test
:
:
ScopedKeyValueConfig
field_trials
;
QualityConvergenceController
controller
;
controller
.
Initialize
(
1
kStaticQpThreshold
kVideoCodecVP8
field_trials
)
;
EXPECT_FALSE
(
controller
.
AddSampleAndCheckTargetQuality
(
0
kStaticQpThreshold
+
1
false
)
)
;
EXPECT_TRUE
(
controller
.
AddSampleAndCheckTargetQuality
(
0
kStaticQpThreshold
false
)
)
;
}
TEST
(
QualityConvergenceController
Simulcast
)
{
test
:
:
ScopedKeyValueConfig
field_trials
;
QualityConvergenceController
controller
;
controller
.
Initialize
(
2
kStaticQpThreshold
kVideoCodecVP8
field_trials
)
;
EXPECT_FALSE
(
controller
.
AddSampleAndCheckTargetQuality
(
0
kStaticQpThreshold
+
1
false
)
)
;
EXPECT_FALSE
(
controller
.
AddSampleAndCheckTargetQuality
(
1
kStaticQpThreshold
+
1
false
)
)
;
EXPECT_TRUE
(
controller
.
AddSampleAndCheckTargetQuality
(
0
kStaticQpThreshold
false
)
)
;
EXPECT_FALSE
(
controller
.
AddSampleAndCheckTargetQuality
(
1
kStaticQpThreshold
+
1
false
)
)
;
EXPECT_TRUE
(
controller
.
AddSampleAndCheckTargetQuality
(
0
kStaticQpThreshold
true
)
)
;
EXPECT_FALSE
(
controller
.
AddSampleAndCheckTargetQuality
(
1
kStaticQpThreshold
+
1
true
)
)
;
}
TEST
(
QualityConvergenceController
InvalidLayerIndex
)
{
test
:
:
ScopedKeyValueConfig
field_trials
;
QualityConvergenceController
controller
;
controller
.
Initialize
(
2
kStaticQpThreshold
kVideoCodecVP8
field_trials
)
;
EXPECT_FALSE
(
controller
.
AddSampleAndCheckTargetQuality
(
-
1
kStaticQpThreshold
false
)
)
;
EXPECT_FALSE
(
controller
.
AddSampleAndCheckTargetQuality
(
3
kStaticQpThreshold
false
)
)
;
}
}
}
