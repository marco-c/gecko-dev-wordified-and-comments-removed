#
ifndef
ABSL_BASE_PREFETCH_H_
#
define
ABSL_BASE_PREFETCH_H_
#
include
"
absl
/
base
/
attributes
.
h
"
#
include
"
absl
/
base
/
config
.
h
"
#
if
defined
(
ABSL_INTERNAL_HAVE_SSE
)
#
include
<
xmmintrin
.
h
>
#
endif
#
if
defined
(
_MSC_VER
)
&
&
_MSC_VER
>
=
1900
&
&
\
(
defined
(
_M_X64
)
|
|
defined
(
_M_IX86
)
)
#
include
<
intrin
.
h
>
#
pragma
intrinsic
(
_mm_prefetch
)
#
endif
namespace
absl
{
ABSL_NAMESPACE_BEGIN
void
PrefetchToLocalCache
(
const
void
*
addr
)
;
void
PrefetchToLocalCacheNta
(
const
void
*
addr
)
;
void
PrefetchToLocalCacheForWrite
(
const
void
*
addr
)
;
#
if
ABSL_HAVE_BUILTIN
(
__builtin_prefetch
)
|
|
defined
(
__GNUC__
)
#
define
ABSL_HAVE_PREFETCH
1
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCache
(
const
void
*
addr
)
{
__builtin_prefetch
(
addr
0
3
)
;
}
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCacheNta
(
const
void
*
addr
)
{
__builtin_prefetch
(
addr
0
0
)
;
}
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCacheForWrite
(
const
void
*
addr
)
{
#
if
defined
(
__x86_64__
)
asm
(
"
prefetchw
(
%
0
)
"
:
:
"
r
"
(
addr
)
)
;
#
else
__builtin_prefetch
(
addr
1
3
)
;
#
endif
}
#
elif
defined
(
ABSL_INTERNAL_HAVE_SSE
)
#
define
ABSL_HAVE_PREFETCH
1
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCache
(
const
void
*
addr
)
{
_mm_prefetch
(
reinterpret_cast
<
const
char
*
>
(
addr
)
_MM_HINT_T0
)
;
}
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCacheNta
(
const
void
*
addr
)
{
_mm_prefetch
(
reinterpret_cast
<
const
char
*
>
(
addr
)
_MM_HINT_NTA
)
;
}
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCacheForWrite
(
const
void
*
addr
)
{
#
if
defined
(
_MM_HINT_ET0
)
_mm_prefetch
(
reinterpret_cast
<
const
char
*
>
(
addr
)
_MM_HINT_ET0
)
;
#
elif
!
defined
(
_MSC_VER
)
&
&
defined
(
__x86_64__
)
asm
(
"
prefetchw
(
%
0
)
"
:
:
"
r
"
(
addr
)
)
;
#
endif
}
#
else
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCache
(
const
void
*
addr
)
{
}
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCacheNta
(
const
void
*
addr
)
{
}
ABSL_ATTRIBUTE_ALWAYS_INLINE
inline
void
PrefetchToLocalCacheForWrite
(
const
void
*
addr
)
{
}
#
endif
ABSL_NAMESPACE_END
}
#
endif
