#
include
"
absl
/
debugging
/
stacktrace
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
absl
/
base
/
macros
.
h
"
#
include
"
absl
/
base
/
optimization
.
h
"
namespace
{
#
if
defined
(
__linux__
)
&
&
(
defined
(
__x86_64__
)
|
|
defined
(
__aarch64__
)
)
ABSL_ATTRIBUTE_NOINLINE
void
Unwind
(
void
*
p
)
{
ABSL_ATTRIBUTE_UNUSED
static
void
*
volatile
sink
=
p
;
constexpr
int
kSize
=
16
;
void
*
stack
[
kSize
]
;
int
frames
[
kSize
]
;
absl
:
:
GetStackTrace
(
stack
kSize
0
)
;
absl
:
:
GetStackFrames
(
stack
frames
kSize
0
)
;
}
ABSL_ATTRIBUTE_NOINLINE
void
HugeFrame
(
)
{
char
buffer
[
1
<
<
20
]
;
Unwind
(
buffer
)
;
ABSL_BLOCK_TAIL_CALL_OPTIMIZATION
(
)
;
}
TEST
(
StackTrace
HugeFrame
)
{
HugeFrame
(
)
;
ABSL_BLOCK_TAIL_CALL_OPTIMIZATION
(
)
;
}
#
endif
}
