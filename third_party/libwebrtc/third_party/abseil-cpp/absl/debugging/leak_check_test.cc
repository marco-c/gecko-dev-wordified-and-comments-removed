#
include
<
string
>
#
include
"
gtest
/
gtest
.
h
"
#
include
"
absl
/
base
/
internal
/
raw_logging
.
h
"
#
include
"
absl
/
debugging
/
leak_check
.
h
"
namespace
{
TEST
(
LeakCheckTest
DetectLeakSanitizer
)
{
#
ifdef
ABSL_EXPECT_LEAK_SANITIZER
EXPECT_TRUE
(
absl
:
:
HaveLeakSanitizer
(
)
)
;
EXPECT_TRUE
(
absl
:
:
LeakCheckerIsActive
(
)
)
;
#
else
EXPECT_FALSE
(
absl
:
:
HaveLeakSanitizer
(
)
)
;
EXPECT_FALSE
(
absl
:
:
LeakCheckerIsActive
(
)
)
;
#
endif
}
TEST
(
LeakCheckTest
IgnoreLeakSuppressesLeakedMemoryErrors
)
{
auto
foo
=
absl
:
:
IgnoreLeak
(
new
std
:
:
string
(
"
some
ignored
leaked
string
"
)
)
;
ABSL_RAW_LOG
(
INFO
"
Ignoring
leaked
string
%
s
"
foo
-
>
c_str
(
)
)
;
}
TEST
(
LeakCheckTest
LeakCheckDisablerIgnoresLeak
)
{
absl
:
:
LeakCheckDisabler
disabler
;
auto
foo
=
new
std
:
:
string
(
"
some
string
leaked
while
checks
are
disabled
"
)
;
ABSL_RAW_LOG
(
INFO
"
Ignoring
leaked
string
%
s
"
foo
-
>
c_str
(
)
)
;
}
}
