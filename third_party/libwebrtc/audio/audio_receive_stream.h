#
ifndef
AUDIO_AUDIO_RECEIVE_STREAM_H_
#
define
AUDIO_AUDIO_RECEIVE_STREAM_H_
#
include
<
map
>
#
include
<
memory
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
api
/
audio
/
audio_mixer
.
h
"
#
include
"
api
/
neteq
/
neteq_factory
.
h
"
#
include
"
api
/
rtp_headers
.
h
"
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
audio
/
audio_state
.
h
"
#
include
"
call
/
audio_receive_stream
.
h
"
#
include
"
call
/
syncable
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
source_tracker
.
h
"
#
include
"
rtc_base
/
system
/
no_unique_address
.
h
"
#
include
"
system_wrappers
/
include
/
clock
.
h
"
namespace
webrtc
{
class
PacketRouter
;
class
ProcessThread
;
class
RtcEventLog
;
class
RtpPacketReceived
;
class
RtpStreamReceiverControllerInterface
;
class
RtpStreamReceiverInterface
;
namespace
voe
{
class
ChannelReceiveInterface
;
}
namespace
internal
{
class
AudioSendStream
;
class
AudioReceiveStream
final
:
public
webrtc
:
:
AudioReceiveStream
public
AudioMixer
:
:
Source
public
Syncable
{
public
:
AudioReceiveStream
(
Clock
*
clock
PacketRouter
*
packet_router
NetEqFactory
*
neteq_factory
const
webrtc
:
:
AudioReceiveStream
:
:
Config
&
config
const
rtc
:
:
scoped_refptr
<
webrtc
:
:
AudioState
>
&
audio_state
webrtc
:
:
RtcEventLog
*
event_log
)
;
AudioReceiveStream
(
Clock
*
clock
PacketRouter
*
packet_router
const
webrtc
:
:
AudioReceiveStream
:
:
Config
&
config
const
rtc
:
:
scoped_refptr
<
webrtc
:
:
AudioState
>
&
audio_state
webrtc
:
:
RtcEventLog
*
event_log
std
:
:
unique_ptr
<
voe
:
:
ChannelReceiveInterface
>
channel_receive
)
;
AudioReceiveStream
(
)
=
delete
;
AudioReceiveStream
(
const
AudioReceiveStream
&
)
=
delete
;
AudioReceiveStream
&
operator
=
(
const
AudioReceiveStream
&
)
=
delete
;
~
AudioReceiveStream
(
)
override
;
void
RegisterWithTransport
(
RtpStreamReceiverControllerInterface
*
receiver_controller
)
;
void
UnregisterFromTransport
(
)
;
void
Start
(
)
override
;
void
Stop
(
)
override
;
const
RtpConfig
&
rtp_config
(
)
const
override
{
return
config_
.
rtp
;
}
bool
IsRunning
(
)
const
override
;
void
SetDepacketizerToDecoderFrameTransformer
(
rtc
:
:
scoped_refptr
<
webrtc
:
:
FrameTransformerInterface
>
frame_transformer
)
override
;
void
SetDecoderMap
(
std
:
:
map
<
int
SdpAudioFormat
>
decoder_map
)
override
;
void
SetUseTransportCcAndNackHistory
(
bool
use_transport_cc
int
history_ms
)
override
;
void
SetFrameDecryptor
(
rtc
:
:
scoped_refptr
<
webrtc
:
:
FrameDecryptorInterface
>
frame_decryptor
)
override
;
void
SetRtpExtensions
(
std
:
:
vector
<
RtpExtension
>
extensions
)
override
;
webrtc
:
:
AudioReceiveStream
:
:
Stats
GetStats
(
bool
get_and_clear_legacy_stats
)
const
override
;
void
SetSink
(
AudioSinkInterface
*
sink
)
override
;
void
SetGain
(
float
gain
)
override
;
bool
SetBaseMinimumPlayoutDelayMs
(
int
delay_ms
)
override
;
int
GetBaseMinimumPlayoutDelayMs
(
)
const
override
;
std
:
:
vector
<
webrtc
:
:
RtpSource
>
GetSources
(
)
const
override
;
AudioFrameInfo
GetAudioFrameWithInfo
(
int
sample_rate_hz
AudioFrame
*
audio_frame
)
override
;
int
Ssrc
(
)
const
override
;
int
PreferredSampleRate
(
)
const
override
;
uint32_t
id
(
)
const
override
;
absl
:
:
optional
<
Syncable
:
:
Info
>
GetInfo
(
)
const
override
;
bool
GetPlayoutRtpTimestamp
(
uint32_t
*
rtp_timestamp
int64_t
*
time_ms
)
const
override
;
void
SetEstimatedPlayoutNtpTimestampMs
(
int64_t
ntp_timestamp_ms
int64_t
time_ms
)
override
;
bool
SetMinimumPlayoutDelay
(
int
delay_ms
)
override
;
void
AssociateSendStream
(
AudioSendStream
*
send_stream
)
;
void
DeliverRtcp
(
const
uint8_t
*
packet
size_t
length
)
;
void
SetSyncGroup
(
const
std
:
:
string
&
sync_group
)
;
void
SetLocalSsrc
(
uint32_t
local_ssrc
)
;
uint32_t
local_ssrc
(
)
const
;
uint32_t
remote_ssrc
(
)
const
{
return
config_
.
rtp
.
remote_ssrc
;
}
const
webrtc
:
:
AudioReceiveStream
:
:
Config
&
config
(
)
const
;
const
AudioSendStream
*
GetAssociatedSendStreamForTesting
(
)
const
;
void
ReconfigureForTesting
(
const
webrtc
:
:
AudioReceiveStream
:
:
Config
&
config
)
;
private
:
AudioState
*
audio_state
(
)
const
;
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
worker_thread_checker_
;
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
packet_sequence_checker_
;
webrtc
:
:
AudioReceiveStream
:
:
Config
config_
;
rtc
:
:
scoped_refptr
<
webrtc
:
:
AudioState
>
audio_state_
;
SourceTracker
source_tracker_
;
const
std
:
:
unique_ptr
<
voe
:
:
ChannelReceiveInterface
>
channel_receive_
;
AudioSendStream
*
associated_send_stream_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
=
nullptr
;
bool
playing_
RTC_GUARDED_BY
(
worker_thread_checker_
)
=
false
;
std
:
:
unique_ptr
<
RtpStreamReceiverInterface
>
rtp_stream_receiver_
RTC_GUARDED_BY
(
packet_sequence_checker_
)
;
}
;
}
}
#
endif
