#
ifndef
AUDIO_VOIP_AUDIO_EGRESS_H_
#
define
AUDIO_VOIP_AUDIO_EGRESS_H_
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
memory
>
#
include
<
optional
>
#
include
"
api
/
audio_codecs
/
audio_format
.
h
"
#
include
"
api
/
environment
/
environment
.
h
"
#
include
"
api
/
sequence_checker
.
h
"
#
include
"
api
/
task_queue
/
task_queue_base
.
h
"
#
include
"
audio
/
audio_level
.
h
"
#
include
"
call
/
audio_sender
.
h
"
#
include
"
modules
/
audio_coding
/
include
/
audio_coding_module
.
h
"
#
include
"
modules
/
audio_coding
/
include
/
audio_coding_module_typedefs
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_rtcp_interface
.
h
"
#
include
"
modules
/
rtp_rtcp
/
source
/
rtp_sender_audio
.
h
"
#
include
"
rtc_base
/
synchronization
/
mutex
.
h
"
#
include
"
rtc_base
/
system
/
no_unique_address
.
h
"
#
include
"
rtc_base
/
thread_annotations
.
h
"
namespace
webrtc
{
class
AudioEgress
:
public
AudioSender
public
AudioPacketizationCallback
{
public
:
AudioEgress
(
const
Environment
&
env
RtpRtcpInterface
*
rtp_rtcp
)
;
~
AudioEgress
(
)
override
;
void
SetEncoder
(
int
payload_type
const
SdpAudioFormat
&
encoder_format
std
:
:
unique_ptr
<
AudioEncoder
>
encoder
)
;
bool
StartSend
(
)
;
void
StopSend
(
)
;
bool
IsSending
(
)
const
;
void
SetMute
(
bool
mute
)
;
std
:
:
optional
<
SdpAudioFormat
>
GetEncoderFormat
(
)
const
{
MutexLock
lock
(
&
lock_
)
;
return
encoder_format_
;
}
void
RegisterTelephoneEventType
(
int
rtp_payload_type
int
sample_rate_hz
)
;
bool
SendTelephoneEvent
(
int
dtmf_event
int
duration_ms
)
;
int
GetInputAudioLevel
(
)
const
{
return
input_audio_level_
.
LevelFullRange
(
)
;
}
double
GetInputTotalEnergy
(
)
const
{
return
input_audio_level_
.
TotalEnergy
(
)
;
}
double
GetInputTotalDuration
(
)
const
{
return
input_audio_level_
.
TotalDuration
(
)
;
}
void
SendAudioData
(
std
:
:
unique_ptr
<
AudioFrame
>
audio_frame
)
override
;
int32_t
SendData
(
AudioFrameType
frame_type
uint8_t
payload_type
uint32_t
timestamp
const
uint8_t
*
payload_data
size_t
payload_size
)
override
;
private
:
void
SetEncoderFormat
(
const
SdpAudioFormat
&
encoder_format
)
{
MutexLock
lock
(
&
lock_
)
;
encoder_format_
=
encoder_format
;
}
mutable
Mutex
lock_
;
std
:
:
optional
<
SdpAudioFormat
>
encoder_format_
RTC_GUARDED_BY
(
lock_
)
;
RtpRtcpInterface
*
const
rtp_rtcp_
;
RTPSenderAudio
rtp_sender_audio_
;
const
std
:
:
unique_ptr
<
AudioCodingModule
>
audio_coding_
;
voe
:
:
AudioLevel
input_audio_level_
;
struct
EncoderContext
{
uint32_t
frame_rtp_timestamp_
=
0
;
bool
mute_
=
false
;
bool
previously_muted_
=
false
;
}
;
EncoderContext
encoder_context_
RTC_GUARDED_BY
(
encoder_queue_checker_
)
;
std
:
:
unique_ptr
<
TaskQueueBase
TaskQueueDeleter
>
encoder_queue_
;
RTC_NO_UNIQUE_ADDRESS
SequenceChecker
encoder_queue_checker_
;
}
;
}
#
endif
