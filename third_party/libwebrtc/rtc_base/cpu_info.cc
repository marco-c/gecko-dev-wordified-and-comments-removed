#
include
"
rtc_base
/
cpu_info
.
h
"
#
include
<
cstdint
>
#
if
defined
(
WEBRTC_WIN
)
#
include
<
windows
.
h
>
#
elif
defined
(
WEBRTC_LINUX
)
|
|
defined
(
WEBRTC_BSD
)
#
include
<
unistd
.
h
>
#
elif
defined
(
WEBRTC_MAC
)
#
include
<
sys
/
sysctl
.
h
>
#
elif
defined
(
WEBRTC_FUCHSIA
)
#
include
<
zircon
/
syscalls
.
h
>
#
endif
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
logging
.
h
"
namespace
{
uint32_t
DetectNumberOfCores
(
)
{
int
number_of_cores
=
0
;
#
if
defined
(
WEBRTC_WIN
)
SYSTEM_INFO
si
;
GetNativeSystemInfo
(
&
si
)
;
number_of_cores
=
static_cast
<
int
>
(
si
.
dwNumberOfProcessors
)
;
#
elif
defined
(
WEBRTC_LINUX
)
|
|
defined
(
WEBRTC_ANDROID
)
|
|
defined
(
WEBRTC_BSD
)
number_of_cores
=
static_cast
<
int
>
(
sysconf
(
_SC_NPROCESSORS_ONLN
)
)
;
if
(
number_of_cores
<
=
0
)
{
RTC_LOG
(
LS_ERROR
)
<
<
"
Failed
to
get
number
of
cores
"
;
number_of_cores
=
1
;
}
#
elif
defined
(
WEBRTC_MAC
)
|
|
defined
(
WEBRTC_IOS
)
int
name
[
]
=
{
CTL_HW
HW_AVAILCPU
}
;
size_t
size
=
sizeof
(
number_of_cores
)
;
if
(
0
!
=
sysctl
(
name
2
&
number_of_cores
&
size
NULL
0
)
)
{
RTC_LOG
(
LS_ERROR
)
<
<
"
Failed
to
get
number
of
cores
"
;
number_of_cores
=
1
;
}
#
elif
defined
(
WEBRTC_FUCHSIA
)
number_of_cores
=
zx_system_get_num_cpus
(
)
;
#
else
RTC_LOG
(
LS_ERROR
)
<
<
"
No
function
to
get
number
of
cores
"
;
number_of_cores
=
1
;
#
endif
RTC_LOG
(
LS_INFO
)
<
<
"
Available
number
of
cores
:
"
<
<
number_of_cores
;
RTC_CHECK_GT
(
number_of_cores
0
)
;
return
static_cast
<
uint32_t
>
(
number_of_cores
)
;
}
}
namespace
webrtc
{
namespace
cpu_info
{
uint32_t
DetectNumberOfCores
(
)
{
static
const
uint32_t
logical_cpus
=
:
:
DetectNumberOfCores
(
)
;
return
logical_cpus
;
}
}
}
