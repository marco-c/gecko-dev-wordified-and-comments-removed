#
ifndef
RTC_BASE_MEMORY_ALWAYS_VALID_POINTER_H_
#
define
RTC_BASE_MEMORY_ALWAYS_VALID_POINTER_H_
#
include
<
cstddef
>
#
include
<
memory
>
#
include
<
type_traits
>
#
include
<
utility
>
#
include
"
rtc_base
/
checks
.
h
"
namespace
webrtc
{
template
<
typename
Interface
typename
Default
=
Interface
>
class
AlwaysValidPointer
{
public
:
explicit
AlwaysValidPointer
(
Interface
*
pointer
)
:
owned_instance_
(
pointer
?
nullptr
:
std
:
:
make_unique
<
Default
>
(
)
)
pointer_
(
pointer
?
pointer
:
owned_instance_
.
get
(
)
)
{
RTC_DCHECK
(
pointer_
)
;
}
template
<
typename
Arg
typename
std
:
:
enable_if
<
!
(
std
:
:
is_invocable
<
Arg
>
:
:
value
)
bool
>
:
:
type
=
true
>
AlwaysValidPointer
(
Interface
*
pointer
Arg
arg
)
:
owned_instance_
(
pointer
?
nullptr
:
std
:
:
make_unique
<
Default
>
(
std
:
:
move
(
arg
)
)
)
pointer_
(
pointer
?
pointer
:
owned_instance_
.
get
(
)
)
{
RTC_DCHECK
(
pointer_
)
;
}
template
<
typename
Arg1
typename
.
.
.
Args
>
AlwaysValidPointer
(
Interface
*
pointer
Arg1
arg1
Args
.
.
.
args
)
:
owned_instance_
(
pointer
?
nullptr
:
std
:
:
make_unique
<
Default
>
(
std
:
:
move
(
arg1
)
std
:
:
move
(
args
.
.
.
)
)
)
pointer_
(
pointer
?
pointer
:
owned_instance_
.
get
(
)
)
{
RTC_DCHECK
(
pointer_
)
;
}
template
<
typename
Func
typename
std
:
:
enable_if
<
std
:
:
is_invocable
<
Func
>
:
:
value
bool
>
:
:
type
=
true
>
AlwaysValidPointer
(
Interface
*
pointer
Func
function
)
:
owned_instance_
(
pointer
?
nullptr
:
function
(
)
)
pointer_
(
owned_instance_
?
owned_instance_
.
get
(
)
:
pointer
)
{
RTC_DCHECK
(
pointer_
)
;
}
AlwaysValidPointer
(
std
:
:
unique_ptr
<
Interface
>
&
&
instance
Interface
*
pointer
)
:
owned_instance_
(
instance
?
std
:
:
move
(
instance
)
:
(
pointer
=
=
nullptr
?
std
:
:
make_unique
<
Default
>
(
)
:
nullptr
)
)
pointer_
(
owned_instance_
?
owned_instance_
.
get
(
)
:
pointer
)
{
RTC_DCHECK
(
pointer_
)
;
}
template
<
typename
.
.
.
Args
>
AlwaysValidPointer
(
std
:
:
unique_ptr
<
Interface
>
&
&
instance
Interface
*
pointer
Args
.
.
.
args
)
:
owned_instance_
(
instance
?
std
:
:
move
(
instance
)
:
(
pointer
=
=
nullptr
?
std
:
:
make_unique
<
Default
>
(
std
:
:
move
(
args
.
.
.
)
)
:
nullptr
)
)
pointer_
(
owned_instance_
?
owned_instance_
.
get
(
)
:
pointer
)
{
RTC_DCHECK
(
pointer_
)
;
}
Interface
*
get
(
)
{
return
pointer_
;
}
Interface
*
operator
-
>
(
)
{
return
pointer_
;
}
Interface
&
operator
*
(
)
{
return
*
pointer_
;
}
Interface
*
get
(
)
const
{
return
pointer_
;
}
Interface
*
operator
-
>
(
)
const
{
return
pointer_
;
}
Interface
&
operator
*
(
)
const
{
return
*
pointer_
;
}
private
:
const
std
:
:
unique_ptr
<
Interface
>
owned_instance_
;
Interface
*
const
pointer_
;
}
;
template
<
typename
Interface
>
class
AlwaysValidPointerNoDefault
{
public
:
explicit
AlwaysValidPointerNoDefault
(
Interface
*
pointer
)
:
pointer_
(
pointer
)
{
RTC_CHECK
(
pointer_
)
;
}
explicit
AlwaysValidPointerNoDefault
(
std
:
:
unique_ptr
<
Interface
>
instance
Interface
*
pointer
=
nullptr
)
:
owned_instance_
(
std
:
:
move
(
instance
)
)
pointer_
(
owned_instance_
?
owned_instance_
.
get
(
)
:
pointer
)
{
RTC_CHECK
(
pointer_
)
;
}
Interface
*
get
(
)
{
return
pointer_
;
}
Interface
*
operator
-
>
(
)
{
return
pointer_
;
}
Interface
&
operator
*
(
)
{
return
*
pointer_
;
}
Interface
*
get
(
)
const
{
return
pointer_
;
}
Interface
*
operator
-
>
(
)
const
{
return
pointer_
;
}
Interface
&
operator
*
(
)
const
{
return
*
pointer_
;
}
private
:
const
std
:
:
unique_ptr
<
Interface
>
owned_instance_
;
Interface
*
const
pointer_
;
}
;
template
<
typename
T
typename
U
typename
V
typename
W
>
bool
operator
=
=
(
const
AlwaysValidPointer
<
T
U
>
&
a
const
AlwaysValidPointer
<
V
W
>
&
b
)
{
return
a
.
get
(
)
=
=
b
.
get
(
)
;
}
template
<
typename
T
typename
U
typename
V
typename
W
>
bool
operator
!
=
(
const
AlwaysValidPointer
<
T
U
>
&
a
const
AlwaysValidPointer
<
V
W
>
&
b
)
{
return
!
(
a
=
=
b
)
;
}
template
<
typename
T
typename
U
>
bool
operator
=
=
(
const
AlwaysValidPointer
<
T
U
>
&
a
std
:
:
nullptr_t
)
{
return
a
.
get
(
)
=
=
nullptr
;
}
template
<
typename
T
typename
U
>
bool
operator
!
=
(
const
AlwaysValidPointer
<
T
U
>
&
a
std
:
:
nullptr_t
)
{
return
!
(
a
=
=
nullptr
)
;
}
template
<
typename
T
typename
U
>
bool
operator
=
=
(
std
:
:
nullptr_t
const
AlwaysValidPointer
<
T
U
>
&
a
)
{
return
a
.
get
(
)
=
=
nullptr
;
}
template
<
typename
T
typename
U
>
bool
operator
!
=
(
std
:
:
nullptr_t
const
AlwaysValidPointer
<
T
U
>
&
a
)
{
return
!
(
a
=
=
nullptr
)
;
}
template
<
typename
T
typename
U
>
bool
operator
=
=
(
const
AlwaysValidPointerNoDefault
<
T
>
&
a
const
AlwaysValidPointerNoDefault
<
U
>
&
b
)
{
return
a
.
get
(
)
=
=
b
.
get
(
)
;
}
template
<
typename
T
typename
U
>
bool
operator
!
=
(
const
AlwaysValidPointerNoDefault
<
T
>
&
a
const
AlwaysValidPointerNoDefault
<
U
>
&
b
)
{
return
!
(
a
=
=
b
)
;
}
template
<
typename
T
>
bool
operator
=
=
(
const
AlwaysValidPointerNoDefault
<
T
>
&
a
std
:
:
nullptr_t
)
{
return
a
.
get
(
)
=
=
nullptr
;
}
template
<
typename
T
>
bool
operator
!
=
(
const
AlwaysValidPointerNoDefault
<
T
>
&
a
std
:
:
nullptr_t
)
{
return
!
(
a
=
=
nullptr
)
;
}
template
<
typename
T
>
bool
operator
=
=
(
std
:
:
nullptr_t
const
AlwaysValidPointerNoDefault
<
T
>
&
a
)
{
return
a
.
get
(
)
=
=
nullptr
;
}
template
<
typename
T
>
bool
operator
!
=
(
std
:
:
nullptr_t
const
AlwaysValidPointerNoDefault
<
T
>
&
a
)
{
return
!
(
a
=
=
nullptr
)
;
}
template
<
typename
T
typename
U
typename
V
>
bool
operator
=
=
(
const
AlwaysValidPointer
<
T
U
>
&
a
const
V
*
b
)
{
return
a
.
get
(
)
=
=
b
;
}
template
<
typename
T
typename
U
typename
V
>
bool
operator
!
=
(
const
AlwaysValidPointer
<
T
U
>
&
a
const
V
*
b
)
{
return
!
(
a
=
=
b
)
;
}
template
<
typename
T
typename
U
typename
V
>
bool
operator
=
=
(
const
T
*
a
const
AlwaysValidPointer
<
U
V
>
&
b
)
{
return
a
=
=
b
.
get
(
)
;
}
template
<
typename
T
typename
U
typename
V
>
bool
operator
!
=
(
const
T
*
a
const
AlwaysValidPointer
<
U
V
>
&
b
)
{
return
!
(
a
=
=
b
)
;
}
template
<
typename
T
typename
U
>
bool
operator
=
=
(
const
AlwaysValidPointerNoDefault
<
T
>
&
a
const
U
*
b
)
{
return
a
.
get
(
)
=
=
b
;
}
template
<
typename
T
typename
U
>
bool
operator
!
=
(
const
AlwaysValidPointerNoDefault
<
T
>
&
a
const
U
*
b
)
{
return
!
(
a
=
=
b
)
;
}
template
<
typename
T
typename
U
>
bool
operator
=
=
(
const
T
*
a
const
AlwaysValidPointerNoDefault
<
U
>
&
b
)
{
return
a
=
=
b
.
get
(
)
;
}
template
<
typename
T
typename
U
>
bool
operator
!
=
(
const
T
*
a
const
AlwaysValidPointerNoDefault
<
U
>
&
b
)
{
return
!
(
a
=
=
b
)
;
}
}
#
endif
