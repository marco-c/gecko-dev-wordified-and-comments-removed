#
include
"
rtc_base
/
memory
/
fifo_buffer
.
h
"
#
include
<
string
.
h
>
#
include
<
cstdint
>
#
include
"
api
/
array_view
.
h
"
#
include
"
rtc_base
/
stream
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
webrtc
{
TEST
(
FifoBufferTest
TestAll
)
{
AutoThread
main_thread
;
const
size_t
kSize
=
16
;
const
uint8_t
in
[
kSize
*
2
+
1
]
=
"
0123456789ABCDEFGHIJKLMNOPQRSTUV
"
;
uint8_t
out
[
kSize
*
2
]
;
void
*
p
;
const
void
*
q
;
size_t
bytes
;
FifoBuffer
buf
(
kSize
)
;
EXPECT_EQ
(
SS_OPEN
buf
.
GetState
(
)
)
;
int
error
;
EXPECT_EQ
(
SR_BLOCK
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_TRUE
(
nullptr
!
=
buf
.
GetWriteBuffer
(
&
bytes
)
)
;
EXPECT_EQ
(
kSize
bytes
)
;
buf
.
ConsumeWriteBuffer
(
0
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
bytes
)
;
EXPECT_EQ
(
SR_BLOCK
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
)
)
;
EXPECT_EQ
(
SR_BLOCK
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
*
2
)
bytes
error
)
)
;
EXPECT_EQ
(
bytes
kSize
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
*
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
/
2
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
/
2
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
/
2
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
*
3
/
4
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
*
3
/
4
bytes
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
/
2
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
4
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
4
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
+
kSize
/
2
out
kSize
/
4
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
/
2
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
/
2
)
)
;
buf
.
GetWriteBuffer
(
&
bytes
)
;
buf
.
ConsumeWriteBuffer
(
0
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
)
bytes
error
)
)
;
q
=
buf
.
GetReadData
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
q
)
;
EXPECT_EQ
(
kSize
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
q
in
kSize
)
)
;
buf
.
ConsumeReadData
(
kSize
)
;
EXPECT_EQ
(
SR_BLOCK
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
)
bytes
error
)
)
;
q
=
buf
.
GetReadData
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
q
)
;
EXPECT_EQ
(
kSize
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
q
in
kSize
/
2
)
)
;
buf
.
ConsumeReadData
(
kSize
/
2
)
;
q
=
buf
.
GetReadData
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
q
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
q
in
+
kSize
/
2
kSize
/
2
)
)
;
buf
.
ConsumeReadData
(
kSize
/
2
)
;
EXPECT_EQ
(
SR_BLOCK
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
*
3
/
4
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
q
=
buf
.
GetReadData
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
q
)
;
EXPECT_EQ
(
kSize
/
4
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
q
in
+
kSize
*
3
/
4
kSize
/
4
)
)
;
buf
.
ConsumeReadData
(
kSize
/
4
)
;
q
=
buf
.
GetReadData
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
q
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
q
in
kSize
/
2
)
)
;
buf
.
ConsumeReadData
(
kSize
/
2
)
;
buf
.
GetWriteBuffer
(
&
bytes
)
;
buf
.
ConsumeWriteBuffer
(
0
)
;
p
=
buf
.
GetWriteBuffer
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
p
)
;
EXPECT_EQ
(
kSize
bytes
)
;
memcpy
(
p
in
kSize
)
;
buf
.
ConsumeWriteBuffer
(
kSize
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
)
)
;
p
=
buf
.
GetWriteBuffer
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
p
)
;
EXPECT_EQ
(
kSize
bytes
)
;
memcpy
(
p
in
kSize
/
2
)
;
buf
.
ConsumeWriteBuffer
(
kSize
/
2
)
;
p
=
buf
.
GetWriteBuffer
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
p
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
memcpy
(
p
in
+
kSize
/
2
kSize
/
2
)
;
buf
.
ConsumeWriteBuffer
(
kSize
/
2
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
*
3
/
4
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
p
=
buf
.
GetWriteBuffer
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
p
)
;
EXPECT_EQ
(
kSize
/
4
bytes
)
;
memcpy
(
p
in
kSize
/
4
)
;
buf
.
ConsumeWriteBuffer
(
kSize
/
4
)
;
p
=
buf
.
GetWriteBuffer
(
&
bytes
)
;
EXPECT_TRUE
(
nullptr
!
=
p
)
;
EXPECT_EQ
(
kSize
/
2
bytes
)
;
memcpy
(
p
in
+
kSize
/
4
kSize
/
4
)
;
buf
.
ConsumeWriteBuffer
(
kSize
/
4
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
*
3
/
4
)
bytes
error
)
)
;
EXPECT_EQ
(
kSize
*
3
/
4
bytes
)
;
EXPECT_EQ
(
0
memcmp
(
in
+
kSize
/
2
out
kSize
/
4
)
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
+
kSize
/
4
kSize
/
4
)
)
;
EXPECT_EQ
(
SR_BLOCK
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
buf
.
Close
(
)
;
EXPECT_EQ
(
SS_CLOSED
buf
.
GetState
(
)
)
;
EXPECT_EQ
(
SR_EOS
buf
.
Write
(
rtc
:
:
MakeArrayView
(
in
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
SR_SUCCESS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
EXPECT_EQ
(
0
memcmp
(
in
out
kSize
/
2
)
)
;
EXPECT_EQ
(
SR_EOS
buf
.
Read
(
rtc
:
:
MakeArrayView
(
out
kSize
/
2
)
bytes
error
)
)
;
}
TEST
(
FifoBufferTest
FullBufferCheck
)
{
AutoThread
main_thread
;
FifoBuffer
buff
(
10
)
;
buff
.
ConsumeWriteBuffer
(
10
)
;
size_t
free
;
EXPECT_TRUE
(
buff
.
GetWriteBuffer
(
&
free
)
!
=
nullptr
)
;
EXPECT_EQ
(
0U
free
)
;
}
}
