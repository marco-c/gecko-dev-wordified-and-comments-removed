#
include
"
rtc_base
/
null_socket_server
.
h
"
#
include
<
cstdint
>
#
include
<
memory
>
#
include
"
api
/
test
/
rtc_error_matchers
.
h
"
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
rtc_base
/
socket_server
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
rtc_base
/
time_utils
.
h
"
#
include
"
test
/
gmock
.
h
"
#
include
"
test
/
gtest
.
h
"
#
include
"
test
/
wait_until
.
h
"
namespace
webrtc
{
TEST
(
NullSocketServerTest
WaitAndSet
)
{
AutoThread
main_thread
;
NullSocketServer
ss
;
auto
thread
=
Thread
:
:
Create
(
)
;
EXPECT_TRUE
(
thread
-
>
Start
(
)
)
;
thread
-
>
PostTask
(
[
&
ss
]
{
ss
.
WakeUp
(
)
;
}
)
;
const
bool
process_io
=
true
;
EXPECT_THAT
(
WaitUntil
(
[
&
]
{
return
ss
.
Wait
(
SocketServer
:
:
kForever
process_io
)
;
}
:
:
testing
:
:
IsTrue
(
)
{
.
timeout
=
TimeDelta
:
:
Millis
(
5
'
000
)
}
)
IsRtcOk
(
)
)
;
}
TEST
(
NullSocketServerTest
TestWait
)
{
NullSocketServer
ss
;
int64_t
start
=
TimeMillis
(
)
;
ss
.
Wait
(
TimeDelta
:
:
Millis
(
200
)
true
)
;
EXPECT_GE
(
TimeSince
(
start
)
180
)
;
}
}
