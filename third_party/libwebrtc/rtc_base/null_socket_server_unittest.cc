#
include
"
rtc_base
/
null_socket_server
.
h
"
#
include
<
stdint
.
h
>
#
include
<
memory
>
#
include
"
api
/
units
/
time_delta
.
h
"
#
include
"
rtc_base
/
gunit
.
h
"
#
include
"
rtc_base
/
location
.
h
"
#
include
"
rtc_base
/
message_handler
.
h
"
#
include
"
rtc_base
/
thread
.
h
"
#
include
"
rtc_base
/
time_utils
.
h
"
#
include
"
test
/
gtest
.
h
"
namespace
rtc
{
static
const
uint32_t
kTimeout
=
5000U
;
class
NullSocketServerTest
:
public
:
:
testing
:
:
Test
public
MessageHandlerAutoCleanup
{
protected
:
void
OnMessage
(
Message
*
message
)
override
{
ss_
.
WakeUp
(
)
;
}
NullSocketServer
ss_
;
}
;
TEST_F
(
NullSocketServerTest
WaitAndSet
)
{
auto
thread
=
Thread
:
:
Create
(
)
;
EXPECT_TRUE
(
thread
-
>
Start
(
)
)
;
thread
-
>
Post
(
RTC_FROM_HERE
this
0
)
;
const
bool
process_io
=
true
;
EXPECT_TRUE_WAIT
(
ss_
.
Wait
(
SocketServer
:
:
kForever
process_io
)
kTimeout
)
;
}
TEST_F
(
NullSocketServerTest
TestWait
)
{
int64_t
start
=
TimeMillis
(
)
;
ss_
.
Wait
(
webrtc
:
:
TimeDelta
:
:
Millis
(
200
)
true
)
;
EXPECT_GE
(
TimeSince
(
start
)
180
)
;
}
}
