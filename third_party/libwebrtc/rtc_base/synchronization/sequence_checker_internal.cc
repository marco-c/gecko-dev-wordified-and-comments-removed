#
include
"
rtc_base
/
synchronization
/
sequence_checker_internal
.
h
"
#
include
<
string
>
#
if
defined
(
WEBRTC_MAC
)
#
include
<
dispatch
/
dispatch
.
h
>
#
endif
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
strings
/
string_builder
.
h
"
namespace
webrtc
{
namespace
webrtc_sequence_checker_internal
{
namespace
{
const
void
*
GetSystemQueueRef
(
)
{
#
if
defined
(
WEBRTC_MAC
)
return
dispatch_queue_get_label
(
DISPATCH_CURRENT_QUEUE_LABEL
)
;
#
else
return
nullptr
;
#
endif
}
}
SequenceCheckerImpl
:
:
SequenceCheckerImpl
(
)
:
attached_
(
true
)
valid_thread_
(
rtc
:
:
CurrentThreadRef
(
)
)
valid_queue_
(
TaskQueueBase
:
:
Current
(
)
)
valid_system_queue_
(
GetSystemQueueRef
(
)
)
{
}
bool
SequenceCheckerImpl
:
:
IsCurrent
(
)
const
{
const
TaskQueueBase
*
const
current_queue
=
TaskQueueBase
:
:
Current
(
)
;
const
rtc
:
:
PlatformThreadRef
current_thread
=
rtc
:
:
CurrentThreadRef
(
)
;
const
void
*
const
current_system_queue
=
GetSystemQueueRef
(
)
;
MutexLock
scoped_lock
(
&
lock_
)
;
if
(
!
attached_
)
{
attached_
=
true
;
valid_thread_
=
current_thread
;
valid_queue_
=
current_queue
;
valid_system_queue_
=
current_system_queue
;
return
true
;
}
if
(
valid_queue_
|
|
current_queue
)
{
return
valid_queue_
=
=
current_queue
;
}
if
(
valid_system_queue_
&
&
valid_system_queue_
=
=
current_system_queue
)
{
return
true
;
}
return
rtc
:
:
IsThreadRefEqual
(
valid_thread_
current_thread
)
;
}
void
SequenceCheckerImpl
:
:
Detach
(
)
{
MutexLock
scoped_lock
(
&
lock_
)
;
attached_
=
false
;
}
#
if
RTC_DCHECK_IS_ON
std
:
:
string
SequenceCheckerImpl
:
:
ExpectationToString
(
)
const
{
const
TaskQueueBase
*
const
current_queue
=
TaskQueueBase
:
:
Current
(
)
;
const
rtc
:
:
PlatformThreadRef
current_thread
=
rtc
:
:
CurrentThreadRef
(
)
;
const
void
*
const
current_system_queue
=
GetSystemQueueRef
(
)
;
MutexLock
scoped_lock
(
&
lock_
)
;
if
(
!
attached_
)
return
"
Checker
currently
not
attached
.
"
;
rtc
:
:
StringBuilder
message
;
message
.
AppendFormat
(
"
#
Expected
:
TQ
:
%
p
SysQ
:
%
p
Thread
:
%
p
\
n
"
"
#
Actual
:
TQ
:
%
p
SysQ
:
%
p
Thread
:
%
p
\
n
"
valid_queue_
valid_system_queue_
reinterpret_cast
<
const
void
*
>
(
valid_thread_
)
current_queue
current_system_queue
reinterpret_cast
<
const
void
*
>
(
current_thread
)
)
;
if
(
(
valid_queue_
|
|
current_queue
)
&
&
valid_queue_
!
=
current_queue
)
{
message
<
<
"
TaskQueue
doesn
'
t
match
\
n
"
;
}
else
if
(
valid_system_queue_
&
&
valid_system_queue_
!
=
current_system_queue
)
{
message
<
<
"
System
queue
doesn
'
t
match
\
n
"
;
}
else
if
(
!
rtc
:
:
IsThreadRefEqual
(
valid_thread_
current_thread
)
)
{
message
<
<
"
Threads
don
'
t
match
\
n
"
;
}
return
message
.
Release
(
)
;
}
#
endif
std
:
:
string
ExpectationToString
(
const
SequenceCheckerImpl
*
checker
)
{
#
if
RTC_DCHECK_IS_ON
return
checker
-
>
ExpectationToString
(
)
;
#
endif
return
std
:
:
string
(
)
;
}
}
}
