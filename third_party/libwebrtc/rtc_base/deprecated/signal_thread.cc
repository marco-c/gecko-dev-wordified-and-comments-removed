#
include
"
rtc_base
/
deprecated
/
signal_thread
.
h
"
#
include
<
memory
>
#
include
"
rtc_base
/
checks
.
h
"
#
include
"
rtc_base
/
location
.
h
"
#
include
"
rtc_base
/
null_socket_server
.
h
"
#
include
"
rtc_base
/
socket_server
.
h
"
namespace
rtc
{
DEPRECATED_SignalThread
:
:
DEPRECATED_SignalThread
(
)
:
main_
(
Thread
:
:
Current
(
)
)
worker_
(
this
)
state_
(
kInit
)
refcount_
(
1
)
{
main_
-
>
SignalQueueDestroyed
.
connect
(
this
&
DEPRECATED_SignalThread
:
:
OnMainThreadDestroyed
)
;
worker_
.
SetName
(
"
SignalThread
"
this
)
;
}
DEPRECATED_SignalThread
:
:
~
DEPRECATED_SignalThread
(
)
{
webrtc
:
:
MutexLock
lock
(
&
mutex_
)
;
RTC_DCHECK
(
refcount_
=
=
0
)
;
}
bool
DEPRECATED_SignalThread
:
:
SetName
(
const
std
:
:
string
&
name
const
void
*
obj
)
{
EnterExit
ee
(
this
)
;
RTC_DCHECK
(
!
destroy_called_
)
;
RTC_DCHECK
(
main_
-
>
IsCurrent
(
)
)
;
RTC_DCHECK
(
kInit
=
=
state_
)
;
return
worker_
.
SetName
(
name
obj
)
;
}
void
DEPRECATED_SignalThread
:
:
Start
(
)
{
EnterExit
ee
(
this
)
;
RTC_DCHECK
(
!
destroy_called_
)
;
RTC_DCHECK
(
main_
-
>
IsCurrent
(
)
)
;
if
(
kInit
=
=
state_
|
|
kComplete
=
=
state_
)
{
state_
=
kRunning
;
OnWorkStart
(
)
;
worker_
.
Start
(
)
;
}
else
{
RTC_NOTREACHED
(
)
;
}
}
void
DEPRECATED_SignalThread
:
:
Destroy
(
bool
wait
)
{
EnterExit
ee
(
this
)
;
RTC_DCHECK
(
!
destroy_called_
)
;
destroy_called_
=
true
;
if
(
(
kInit
=
=
state_
)
|
|
(
kComplete
=
=
state_
)
)
{
refcount_
-
-
;
}
else
if
(
kRunning
=
=
state_
|
|
kReleasing
=
=
state_
)
{
state_
=
kStopping
;
worker_
.
Quit
(
)
;
OnWorkStop
(
)
;
if
(
wait
)
{
mutex_
.
Unlock
(
)
;
worker_
.
Stop
(
)
;
mutex_
.
Lock
(
)
;
refcount_
-
-
;
}
}
else
{
RTC_NOTREACHED
(
)
;
}
}
void
DEPRECATED_SignalThread
:
:
Release
(
)
RTC_NO_THREAD_SAFETY_ANALYSIS
{
RTC_DCHECK
(
!
destroy_called_
)
;
RTC_DCHECK
(
main_
-
>
IsCurrent
(
)
)
;
if
(
kComplete
=
=
state_
)
{
refcount_
-
-
;
}
else
if
(
kRunning
=
=
state_
)
{
state_
=
kReleasing
;
}
else
{
RTC_NOTREACHED
(
)
;
}
}
bool
DEPRECATED_SignalThread
:
:
ContinueWork
(
)
{
EnterExit
ee
(
this
)
;
RTC_DCHECK
(
!
destroy_called_
)
;
RTC_DCHECK
(
worker_
.
IsCurrent
(
)
)
;
return
worker_
.
ProcessMessages
(
0
)
;
}
void
DEPRECATED_SignalThread
:
:
OnMessage
(
Message
*
msg
)
{
EnterExit
ee
(
this
)
;
if
(
ST_MSG_WORKER_DONE
=
=
msg
-
>
message_id
)
{
RTC_DCHECK
(
main_
-
>
IsCurrent
(
)
)
;
OnWorkDone
(
)
;
bool
do_delete
=
false
;
if
(
kRunning
=
=
state_
)
{
state_
=
kComplete
;
}
else
{
do_delete
=
true
;
}
if
(
kStopping
!
=
state_
)
{
worker_
.
Stop
(
)
;
SignalWorkDone
(
this
)
;
}
if
(
do_delete
)
{
refcount_
-
-
;
}
}
}
DEPRECATED_SignalThread
:
:
Worker
:
:
Worker
(
DEPRECATED_SignalThread
*
parent
)
:
Thread
(
std
:
:
make_unique
<
NullSocketServer
>
(
)
false
)
parent_
(
parent
)
{
DoInit
(
)
;
}
DEPRECATED_SignalThread
:
:
Worker
:
:
~
Worker
(
)
{
Stop
(
)
;
}
void
DEPRECATED_SignalThread
:
:
Worker
:
:
Run
(
)
{
parent_
-
>
Run
(
)
;
}
void
DEPRECATED_SignalThread
:
:
Run
(
)
{
DoWork
(
)
;
{
EnterExit
ee
(
this
)
;
if
(
main_
)
{
main_
-
>
Post
(
RTC_FROM_HERE
this
ST_MSG_WORKER_DONE
)
;
}
}
}
void
DEPRECATED_SignalThread
:
:
OnMainThreadDestroyed
(
)
{
EnterExit
ee
(
this
)
;
main_
=
nullptr
;
}
bool
DEPRECATED_SignalThread
:
:
Worker
:
:
IsProcessingMessagesForTesting
(
)
{
return
false
;
}
}
