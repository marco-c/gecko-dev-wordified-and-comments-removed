#
ifndef
RTC_BASE_SSL_STREAM_ADAPTER_H_
#
define
RTC_BASE_SSL_STREAM_ADAPTER_H_
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
<
memory
>
#
include
<
optional
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
absl
/
functional
/
any_invocable
.
h
"
#
include
"
absl
/
strings
/
string_view
.
h
"
#
include
"
api
/
array_view
.
h
"
#
include
"
api
/
field_trials_view
.
h
"
#
include
"
rtc_base
/
buffer
.
h
"
#
include
"
rtc_base
/
ssl_certificate
.
h
"
#
include
"
rtc_base
/
ssl_identity
.
h
"
#
include
"
rtc_base
/
stream
.
h
"
namespace
webrtc
{
constexpr
int
kTlsNullWithNullNull
=
0
;
constexpr
int
kSslCipherSuiteMaxValue
=
0xFFFF
;
constexpr
int
kSrtpInvalidCryptoSuite
=
0
;
constexpr
int
kSrtpAes128CmSha1_80
=
0x0001
;
constexpr
int
kSrtpAes128CmSha1_32
=
0x0002
;
constexpr
int
kSrtpAeadAes128Gcm
=
0x0007
;
constexpr
int
kSrtpAeadAes256Gcm
=
0x0008
;
constexpr
int
kSrtpCryptoSuiteMaxValue
=
0xFFFF
;
constexpr
int
kSslSignatureAlgorithmUnknown
=
0
;
constexpr
int
kSslSignatureAlgorithmMaxValue
=
0xFFFF
;
extern
const
char
kCsAesCm128HmacSha1_80
[
]
;
extern
const
char
kCsAesCm128HmacSha1_32
[
]
;
extern
const
char
kCsAeadAes128Gcm
[
]
;
extern
const
char
kCsAeadAes256Gcm
[
]
;
std
:
:
string
SrtpCryptoSuiteToName
(
int
crypto_suite
)
;
bool
GetSrtpKeyAndSaltLengths
(
int
crypto_suite
int
*
key_length
int
*
salt_length
)
;
bool
IsGcmCryptoSuite
(
int
crypto_suite
)
;
enum
SSLRole
{
SSL_CLIENT
SSL_SERVER
}
;
enum
SSLMode
{
SSL_MODE_TLS
SSL_MODE_DTLS
}
;
enum
SSLProtocolVersion
{
SSL_PROTOCOL_NOT_GIVEN
=
-
1
SSL_PROTOCOL_TLS_10
=
0
SSL_PROTOCOL_TLS_11
=
1
SSL_PROTOCOL_TLS_12
=
2
SSL_PROTOCOL_TLS_13
=
3
SSL_PROTOCOL_DTLS_10
=
1
SSL_PROTOCOL_DTLS_12
=
SSL_PROTOCOL_TLS_12
SSL_PROTOCOL_DTLS_13
=
SSL_PROTOCOL_TLS_13
}
;
const
uint16_t
kDtls10VersionBytes
=
0xfeff
;
const
uint16_t
kDtls12VersionBytes
=
0xfefd
;
const
uint16_t
kDtls13VersionBytes
=
0xfefc
;
enum
class
SSLPeerCertificateDigestError
{
NONE
UNKNOWN_ALGORITHM
INVALID_LENGTH
VERIFICATION_FAILED
}
;
enum
{
SSE_MSG_TRUNC
=
0xff0001
}
;
enum
class
SSLHandshakeError
{
UNKNOWN
INCOMPATIBLE_CIPHERSUITE
MAX_VALUE
}
;
class
SSLStreamAdapter
:
public
StreamInterface
{
public
:
static
std
:
:
unique_ptr
<
SSLStreamAdapter
>
Create
(
std
:
:
unique_ptr
<
StreamInterface
>
stream
absl
:
:
AnyInvocable
<
void
(
webrtc
:
:
SSLHandshakeError
)
>
handshake_error
=
nullptr
const
FieldTrialsView
*
field_trials
=
nullptr
)
;
SSLStreamAdapter
(
)
=
default
;
~
SSLStreamAdapter
(
)
override
=
default
;
virtual
void
SetIdentity
(
std
:
:
unique_ptr
<
rtc
:
:
SSLIdentity
>
identity
)
=
0
;
virtual
rtc
:
:
SSLIdentity
*
GetIdentityForTesting
(
)
const
=
0
;
virtual
void
SetServerRole
(
SSLRole
role
=
SSL_SERVER
)
=
0
;
[
[
deprecated
(
"
Only
DTLS
is
supported
by
the
stream
adapter
"
)
]
]
virtual
void
SetMode
(
SSLMode
mode
)
=
0
;
virtual
void
SetMaxProtocolVersion
(
SSLProtocolVersion
version
)
=
0
;
virtual
void
SetInitialRetransmissionTimeout
(
int
timeout_ms
)
=
0
;
virtual
int
StartSSL
(
)
=
0
;
virtual
SSLPeerCertificateDigestError
SetPeerCertificateDigest
(
absl
:
:
string_view
digest_alg
rtc
:
:
ArrayView
<
const
uint8_t
>
digest_val
)
=
0
;
[
[
deprecated
(
"
Use
SetPeerCertificateDigest
with
ArrayView
instead
"
)
]
]
virtual
bool
SetPeerCertificateDigest
(
absl
:
:
string_view
digest_alg
const
unsigned
char
*
digest_val
size_t
digest_len
SSLPeerCertificateDigestError
*
error
=
nullptr
)
;
virtual
std
:
:
unique_ptr
<
rtc
:
:
SSLCertChain
>
GetPeerSSLCertChain
(
)
const
=
0
;
virtual
bool
GetSslCipherSuite
(
int
*
cipher_suite
)
const
=
0
;
virtual
std
:
:
optional
<
absl
:
:
string_view
>
GetTlsCipherSuiteName
(
)
const
=
0
;
[
[
deprecated
(
"
Use
GetSslVersionBytes
"
)
]
]
virtual
SSLProtocolVersion
GetSslVersion
(
)
const
=
0
;
virtual
bool
GetSslVersionBytes
(
int
*
version
)
const
=
0
;
virtual
bool
ExportSrtpKeyingMaterial
(
rtc
:
:
ZeroOnFreeBuffer
<
uint8_t
>
&
keying_material
)
=
0
;
virtual
uint16_t
GetPeerSignatureAlgorithm
(
)
const
=
0
;
virtual
bool
SetDtlsSrtpCryptoSuites
(
const
std
:
:
vector
<
int
>
&
crypto_suites
)
=
0
;
virtual
bool
GetDtlsSrtpCryptoSuite
(
int
*
crypto_suite
)
const
=
0
;
virtual
bool
IsTlsConnected
(
)
=
0
;
static
bool
IsBoringSsl
(
)
;
static
bool
IsAcceptableCipher
(
int
cipher
rtc
:
:
KeyType
key_type
)
;
static
bool
IsAcceptableCipher
(
absl
:
:
string_view
cipher
rtc
:
:
KeyType
key_type
)
;
static
void
EnableTimeCallbackForTesting
(
)
;
static
SSLProtocolVersion
GetMaxSupportedDTLSProtocolVersion
(
)
;
void
SetClientAuthEnabledForTesting
(
bool
enabled
)
{
client_auth_enabled_
=
enabled
;
}
bool
GetClientAuthEnabled
(
)
const
{
return
client_auth_enabled_
;
}
private
:
bool
client_auth_enabled_
=
true
;
}
;
}
namespace
rtc
{
using
:
:
webrtc
:
:
GetSrtpKeyAndSaltLengths
;
using
:
:
webrtc
:
:
IsGcmCryptoSuite
;
using
:
:
webrtc
:
:
kCsAeadAes128Gcm
;
using
:
:
webrtc
:
:
kCsAeadAes256Gcm
;
using
:
:
webrtc
:
:
kCsAesCm128HmacSha1_32
;
using
:
:
webrtc
:
:
kCsAesCm128HmacSha1_80
;
using
:
:
webrtc
:
:
kDtls10VersionBytes
;
using
:
:
webrtc
:
:
kDtls12VersionBytes
;
using
:
:
webrtc
:
:
kDtls13VersionBytes
;
using
:
:
webrtc
:
:
kSrtpAeadAes128Gcm
;
using
:
:
webrtc
:
:
kSrtpAeadAes256Gcm
;
using
:
:
webrtc
:
:
kSrtpAes128CmSha1_32
;
using
:
:
webrtc
:
:
kSrtpAes128CmSha1_80
;
using
:
:
webrtc
:
:
kSrtpCryptoSuiteMaxValue
;
using
:
:
webrtc
:
:
kSrtpInvalidCryptoSuite
;
using
:
:
webrtc
:
:
kSslCipherSuiteMaxValue
;
using
:
:
webrtc
:
:
kSslSignatureAlgorithmMaxValue
;
using
:
:
webrtc
:
:
kSslSignatureAlgorithmUnknown
;
using
:
:
webrtc
:
:
kTlsNullWithNullNull
;
using
:
:
webrtc
:
:
SrtpCryptoSuiteToName
;
using
:
:
webrtc
:
:
SSE_MSG_TRUNC
;
using
:
:
webrtc
:
:
SSL_CLIENT
;
using
:
:
webrtc
:
:
SSL_MODE_DTLS
;
using
:
:
webrtc
:
:
SSL_MODE_TLS
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_DTLS_10
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_DTLS_12
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_DTLS_13
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_NOT_GIVEN
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_TLS_10
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_TLS_11
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_TLS_12
;
using
:
:
webrtc
:
:
SSL_PROTOCOL_TLS_13
;
using
:
:
webrtc
:
:
SSL_SERVER
;
using
:
:
webrtc
:
:
SSLHandshakeError
;
using
:
:
webrtc
:
:
SSLMode
;
using
:
:
webrtc
:
:
SSLPeerCertificateDigestError
;
using
:
:
webrtc
:
:
SSLProtocolVersion
;
using
:
:
webrtc
:
:
SSLRole
;
using
:
:
webrtc
:
:
SSLStreamAdapter
;
}
#
endif
