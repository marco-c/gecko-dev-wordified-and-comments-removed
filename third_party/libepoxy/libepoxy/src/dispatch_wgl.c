#
include
<
assert
.
h
>
#
include
<
string
.
h
>
#
include
<
stdio
.
h
>
#
include
"
dispatch_common
.
h
"
static
bool
first_context_current
=
false
;
static
bool
already_switched_to_dispatch_table
=
false
;
bool
epoxy_conservative_has_wgl_extension
(
const
char
*
ext
)
{
HDC
hdc
=
wglGetCurrentDC
(
)
;
if
(
!
hdc
)
return
true
;
return
epoxy_has_wgl_extension
(
hdc
ext
)
;
}
bool
epoxy_has_wgl_extension
(
HDC
hdc
const
char
*
ext
)
{
PFNWGLGETEXTENSIONSSTRINGARBPROC
getext
;
getext
=
(
void
*
)
wglGetProcAddress
(
"
wglGetExtensionsStringARB
"
)
;
if
(
!
getext
)
{
fputs
(
"
Implementation
unexpectedly
missing
"
"
WGL_ARB_extensions_string
.
Probably
a
libepoxy
bug
.
\
n
"
stderr
)
;
return
false
;
}
return
epoxy_extension_in_string
(
getext
(
hdc
)
ext
)
;
}
void
epoxy_handle_external_wglMakeCurrent
(
void
)
{
if
(
!
first_context_current
)
{
first_context_current
=
true
;
}
else
{
if
(
!
already_switched_to_dispatch_table
)
{
already_switched_to_dispatch_table
=
true
;
gl_switch_to_dispatch_table
(
)
;
wgl_switch_to_dispatch_table
(
)
;
}
gl_init_dispatch_table
(
)
;
wgl_init_dispatch_table
(
)
;
}
}
BOOL
WINAPI
DllMain
(
HINSTANCE
dll
DWORD
reason
LPVOID
reserved
)
;
BOOL
WINAPI
DllMain
(
HINSTANCE
dll
DWORD
reason
LPVOID
reserved
)
{
void
*
data
;
switch
(
reason
)
{
case
DLL_PROCESS_ATTACH
:
gl_tls_index
=
TlsAlloc
(
)
;
if
(
gl_tls_index
=
=
TLS_OUT_OF_INDEXES
)
return
FALSE
;
wgl_tls_index
=
TlsAlloc
(
)
;
if
(
wgl_tls_index
=
=
TLS_OUT_OF_INDEXES
)
return
FALSE
;
first_context_current
=
false
;
case
DLL_THREAD_ATTACH
:
data
=
LocalAlloc
(
LPTR
gl_tls_size
)
;
TlsSetValue
(
gl_tls_index
data
)
;
data
=
LocalAlloc
(
LPTR
wgl_tls_size
)
;
TlsSetValue
(
wgl_tls_index
data
)
;
break
;
case
DLL_THREAD_DETACH
:
case
DLL_PROCESS_DETACH
:
data
=
TlsGetValue
(
gl_tls_index
)
;
LocalFree
(
data
)
;
data
=
TlsGetValue
(
wgl_tls_index
)
;
LocalFree
(
data
)
;
if
(
reason
=
=
DLL_PROCESS_DETACH
)
{
TlsFree
(
gl_tls_index
)
;
TlsFree
(
wgl_tls_index
)
;
}
break
;
}
return
TRUE
;
}
WRAPPER_VISIBILITY
(
BOOL
)
WRAPPER
(
epoxy_wglMakeCurrent
)
(
HDC
hdc
HGLRC
hglrc
)
{
BOOL
ret
=
epoxy_wglMakeCurrent_unwrapped
(
hdc
hglrc
)
;
epoxy_handle_external_wglMakeCurrent
(
)
;
return
ret
;
}
WRAPPER_VISIBILITY
(
BOOL
)
WRAPPER
(
epoxy_wglMakeContextCurrentARB
)
(
HDC
hDrawDC
HDC
hReadDC
HGLRC
hglrc
)
{
BOOL
ret
=
epoxy_wglMakeContextCurrentARB_unwrapped
(
hDrawDC
hReadDC
hglrc
)
;
epoxy_handle_external_wglMakeCurrent
(
)
;
return
ret
;
}
WRAPPER_VISIBILITY
(
BOOL
)
WRAPPER
(
epoxy_wglMakeContextCurrentEXT
)
(
HDC
hDrawDC
HDC
hReadDC
HGLRC
hglrc
)
{
BOOL
ret
=
epoxy_wglMakeContextCurrentEXT_unwrapped
(
hDrawDC
hReadDC
hglrc
)
;
epoxy_handle_external_wglMakeCurrent
(
)
;
return
ret
;
}
WRAPPER_VISIBILITY
(
BOOL
)
WRAPPER
(
epoxy_wglMakeAssociatedContextCurrentAMD
)
(
HGLRC
hglrc
)
{
BOOL
ret
=
epoxy_wglMakeAssociatedContextCurrentAMD_unwrapped
(
hglrc
)
;
epoxy_handle_external_wglMakeCurrent
(
)
;
return
ret
;
}
PFNWGLMAKECURRENTPROC
epoxy_wglMakeCurrent
=
epoxy_wglMakeCurrent_wrapped
;
PFNWGLMAKECONTEXTCURRENTEXTPROC
epoxy_wglMakeContextCurrentEXT
=
epoxy_wglMakeContextCurrentEXT_wrapped
;
PFNWGLMAKECONTEXTCURRENTARBPROC
epoxy_wglMakeContextCurrentARB
=
epoxy_wglMakeContextCurrentARB_wrapped
;
PFNWGLMAKEASSOCIATEDCONTEXTCURRENTAMDPROC
epoxy_wglMakeAssociatedContextCurrentEXT
=
epoxy_wglMakeAssociatedContextCurrentAMD_wrapped
;
