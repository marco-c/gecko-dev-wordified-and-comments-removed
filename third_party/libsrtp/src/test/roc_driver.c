#
ifdef
HAVE_CONFIG_H
#
include
<
config
.
h
>
#
endif
#
include
<
stdio
.
h
>
#
if
ROC_NEEDS_TO_BE_TESTED
#
define
ROC_TEST
#
endif
#
include
"
rdbx
.
h
"
#
include
"
ut_sim
.
h
"
srtp_err_status_t
roc_test
(
int
num_trials
)
;
int
main
(
void
)
{
srtp_err_status_t
status
;
printf
(
"
rollover
counter
test
driver
\
n
"
"
David
A
.
McGrew
\
n
"
"
Cisco
Systems
Inc
.
\
n
"
)
;
printf
(
"
testing
index
functions
.
.
.
"
)
;
status
=
roc_test
(
1
<
<
18
)
;
if
(
status
)
{
printf
(
"
failed
\
n
"
)
;
exit
(
status
)
;
}
printf
(
"
passed
\
n
"
)
;
return
0
;
}
#
define
ROC_VERBOSE
0
srtp_err_status_t
roc_test
(
int
num_trials
)
{
srtp_xtd_seq_num_t
local
est
ref
;
ut_connection
utc
;
int
i
num_bad_est
=
0
;
int
delta
;
uint32_t
ircvd
;
double
failure_rate
;
srtp_index_init
(
&
local
)
;
srtp_index_init
(
&
ref
)
;
srtp_index_init
(
&
est
)
;
printf
(
"
\
n
\
ttesting
sequential
insertion
.
.
.
"
)
;
for
(
i
=
0
;
i
<
2048
;
i
+
+
)
{
srtp_index_guess
(
&
local
&
est
(
uint16_t
)
ref
)
;
#
if
ROC_VERBOSE
printf
(
"
%
lld
%
lld
%
d
\
n
"
ref
est
i
)
;
#
endif
if
(
ref
!
=
est
)
{
#
if
ROC_VERBOSE
printf
(
"
*
bad
estimate
*
\
n
"
)
;
#
endif
+
+
num_bad_est
;
}
srtp_index_advance
(
&
ref
1
)
;
}
failure_rate
=
(
double
)
num_bad_est
/
num_trials
;
if
(
failure_rate
>
0
.
01
)
{
printf
(
"
error
:
failure
rate
too
high
(
%
d
bad
estimates
in
%
d
trials
)
\
n
"
num_bad_est
num_trials
)
;
return
srtp_err_status_algo_fail
;
}
printf
(
"
done
\
n
"
)
;
printf
(
"
\
ttesting
non
-
sequential
insertion
.
.
.
"
)
;
srtp_index_init
(
&
local
)
;
srtp_index_init
(
&
ref
)
;
srtp_index_init
(
&
est
)
;
ut_init
(
&
utc
)
;
for
(
i
=
0
;
i
<
num_trials
;
i
+
+
)
{
ircvd
=
ut_next_index
(
&
utc
)
;
ref
=
ircvd
;
delta
=
srtp_index_guess
(
&
local
&
est
(
uint16_t
)
ref
)
;
#
if
ROC_VERBOSE
printf
(
"
ref
:
%
lld
local
:
%
lld
est
:
%
lld
ircvd
:
%
d
delta
:
%
d
\
n
"
ref
local
est
ircvd
delta
)
;
#
endif
if
(
local
+
delta
!
=
est
)
{
printf
(
"
*
bad
delta
*
:
local
%
llu
+
delta
%
d
!
=
est
%
llu
\
n
"
(
unsigned
long
long
)
local
delta
(
unsigned
long
long
)
est
)
;
return
srtp_err_status_algo_fail
;
}
if
(
delta
>
0
)
srtp_index_advance
(
&
local
delta
)
;
if
(
ref
!
=
est
)
{
#
if
ROC_VERBOSE
printf
(
"
*
bad
estimate
*
\
n
"
)
;
#
endif
+
+
num_bad_est
;
local
=
ref
;
}
}
failure_rate
=
(
double
)
num_bad_est
/
num_trials
;
if
(
failure_rate
>
0
.
01
)
{
printf
(
"
error
:
failure
rate
too
high
(
%
d
bad
estimates
in
%
d
trials
)
\
n
"
num_bad_est
num_trials
)
;
return
srtp_err_status_algo_fail
;
}
printf
(
"
done
\
n
"
)
;
return
srtp_err_status_ok
;
}
