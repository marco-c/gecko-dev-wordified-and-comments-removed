#
ifdef
HAVE_CONFIG_H
#
include
<
config
.
h
>
#
endif
#
include
"
rdb
.
h
"
#
define
rdb_bits_in_bitmask
(
8
*
sizeof
(
v128_t
)
)
srtp_err_status_t
srtp_rdb_init
(
srtp_rdb_t
*
rdb
)
{
v128_set_to_zero
(
&
rdb
-
>
bitmask
)
;
rdb
-
>
window_start
=
0
;
return
srtp_err_status_ok
;
}
srtp_err_status_t
srtp_rdb_check
(
const
srtp_rdb_t
*
rdb
uint32_t
p_index
)
{
if
(
p_index
>
=
rdb
-
>
window_start
+
rdb_bits_in_bitmask
)
{
return
srtp_err_status_ok
;
}
if
(
p_index
<
rdb
-
>
window_start
)
{
return
srtp_err_status_replay_old
;
}
if
(
v128_get_bit
(
&
rdb
-
>
bitmask
(
p_index
-
rdb
-
>
window_start
)
)
=
=
1
)
{
return
srtp_err_status_replay_fail
;
}
return
srtp_err_status_ok
;
}
srtp_err_status_t
srtp_rdb_add_index
(
srtp_rdb_t
*
rdb
uint32_t
p_index
)
{
unsigned
int
delta
;
if
(
p_index
<
rdb
-
>
window_start
)
return
srtp_err_status_replay_fail
;
delta
=
(
p_index
-
rdb
-
>
window_start
)
;
if
(
delta
<
rdb_bits_in_bitmask
)
{
v128_set_bit
(
&
rdb
-
>
bitmask
delta
)
;
}
else
{
delta
-
=
rdb_bits_in_bitmask
-
1
;
v128_left_shift
(
&
rdb
-
>
bitmask
delta
)
;
v128_set_bit
(
&
rdb
-
>
bitmask
rdb_bits_in_bitmask
-
1
)
;
rdb
-
>
window_start
+
=
delta
;
}
return
srtp_err_status_ok
;
}
srtp_err_status_t
srtp_rdb_increment
(
srtp_rdb_t
*
rdb
)
{
if
(
rdb
-
>
window_start
>
=
0x7fffffff
)
{
return
srtp_err_status_key_expired
;
}
+
+
rdb
-
>
window_start
;
return
srtp_err_status_ok
;
}
uint32_t
srtp_rdb_get_value
(
const
srtp_rdb_t
*
rdb
)
{
return
rdb
-
>
window_start
;
}
