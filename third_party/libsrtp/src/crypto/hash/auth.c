#
ifdef
HAVE_CONFIG_H
#
include
<
config
.
h
>
#
endif
#
include
"
auth
.
h
"
#
include
"
err
.
h
"
#
include
"
datatypes
.
h
"
srtp_debug_module_t
srtp_mod_auth
=
{
0
"
auth
func
"
}
;
int
srtp_auth_get_key_length
(
const
srtp_auth_t
*
a
)
{
return
a
-
>
key_len
;
}
int
srtp_auth_get_tag_length
(
const
srtp_auth_t
*
a
)
{
return
a
-
>
out_len
;
}
int
srtp_auth_get_prefix_length
(
const
srtp_auth_t
*
a
)
{
return
a
-
>
prefix_len
;
}
#
define
SELF_TEST_TAG_BUF_OCTETS
32
srtp_err_status_t
srtp_auth_type_test
(
const
srtp_auth_type_t
*
at
const
srtp_auth_test_case_t
*
test_data
)
{
const
srtp_auth_test_case_t
*
test_case
=
test_data
;
srtp_auth_t
*
a
;
srtp_err_status_t
status
;
uint8_t
tag
[
SELF_TEST_TAG_BUF_OCTETS
]
;
int
i
case_num
=
0
;
debug_print
(
srtp_mod_auth
"
running
self
-
test
for
auth
function
%
s
"
at
-
>
description
)
;
if
(
test_case
=
=
NULL
)
{
return
srtp_err_status_cant_check
;
}
while
(
test_case
!
=
NULL
)
{
if
(
test_case
-
>
tag_length_octets
>
SELF_TEST_TAG_BUF_OCTETS
)
{
return
srtp_err_status_bad_param
;
}
status
=
srtp_auth_type_alloc
(
at
&
a
test_case
-
>
key_length_octets
test_case
-
>
tag_length_octets
)
;
if
(
status
)
{
return
status
;
}
status
=
srtp_auth_init
(
a
test_case
-
>
key
)
;
if
(
status
)
{
srtp_auth_dealloc
(
a
)
;
return
status
;
}
status
=
srtp_auth_start
(
a
)
;
if
(
status
)
{
srtp_auth_dealloc
(
a
)
;
return
status
;
}
octet_string_set_to_zero
(
tag
test_case
-
>
tag_length_octets
)
;
status
=
srtp_auth_compute
(
a
test_case
-
>
data
test_case
-
>
data_length_octets
tag
)
;
if
(
status
)
{
srtp_auth_dealloc
(
a
)
;
return
status
;
}
debug_print
(
srtp_mod_auth
"
key
:
%
s
"
srtp_octet_string_hex_string
(
test_case
-
>
key
test_case
-
>
key_length_octets
)
)
;
debug_print
(
srtp_mod_auth
"
data
:
%
s
"
srtp_octet_string_hex_string
(
test_case
-
>
data
test_case
-
>
data_length_octets
)
)
;
debug_print
(
srtp_mod_auth
"
tag
computed
:
%
s
"
srtp_octet_string_hex_string
(
tag
test_case
-
>
tag_length_octets
)
)
;
debug_print
(
srtp_mod_auth
"
tag
expected
:
%
s
"
srtp_octet_string_hex_string
(
test_case
-
>
tag
test_case
-
>
tag_length_octets
)
)
;
status
=
srtp_err_status_ok
;
for
(
i
=
0
;
i
<
test_case
-
>
tag_length_octets
;
i
+
+
)
{
if
(
tag
[
i
]
!
=
test_case
-
>
tag
[
i
]
)
{
status
=
srtp_err_status_algo_fail
;
debug_print
(
srtp_mod_auth
"
test
case
%
d
failed
"
case_num
)
;
debug_print
(
srtp_mod_auth
"
(
mismatch
at
octet
%
d
)
"
i
)
;
}
}
if
(
status
)
{
srtp_auth_dealloc
(
a
)
;
return
srtp_err_status_algo_fail
;
}
status
=
srtp_auth_dealloc
(
a
)
;
if
(
status
)
{
return
status
;
}
test_case
=
test_case
-
>
next_test_case
;
+
+
case_num
;
}
return
srtp_err_status_ok
;
}
srtp_err_status_t
srtp_auth_type_self_test
(
const
srtp_auth_type_t
*
at
)
{
return
srtp_auth_type_test
(
at
at
-
>
test_data
)
;
}
