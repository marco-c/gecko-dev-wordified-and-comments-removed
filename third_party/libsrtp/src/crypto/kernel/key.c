#
ifdef
HAVE_CONFIG_H
#
include
<
config
.
h
>
#
endif
#
include
"
key
.
h
"
#
define
soft_limit
0x10000
srtp_err_status_t
srtp_key_limit_set
(
srtp_key_limit_t
key
const
srtp_xtd_seq_num_t
s
)
{
#
ifdef
NO_64BIT_MATH
if
(
high32
(
s
)
=
=
0
&
&
low32
(
s
)
<
soft_limit
)
{
return
srtp_err_status_bad_param
;
}
#
else
if
(
s
<
soft_limit
)
{
return
srtp_err_status_bad_param
;
}
#
endif
key
-
>
num_left
=
s
;
key
-
>
state
=
srtp_key_state_normal
;
return
srtp_err_status_ok
;
}
srtp_err_status_t
srtp_key_limit_clone
(
srtp_key_limit_t
original
srtp_key_limit_t
*
new_key
)
{
if
(
original
=
=
NULL
)
{
return
srtp_err_status_bad_param
;
}
*
new_key
=
original
;
return
srtp_err_status_ok
;
}
srtp_key_event_t
srtp_key_limit_update
(
srtp_key_limit_t
key
)
{
#
ifdef
NO_64BIT_MATH
if
(
low32
(
key
-
>
num_left
)
=
=
0
)
{
key
-
>
num_left
=
make64
(
high32
(
key
-
>
num_left
)
-
1
low32
(
key
-
>
num_left
)
-
1
)
;
}
else
{
key
-
>
num_left
=
make64
(
high32
(
key
-
>
num_left
)
low32
(
key
-
>
num_left
)
-
1
)
;
}
if
(
high32
(
key
-
>
num_left
)
!
=
0
|
|
low32
(
key
-
>
num_left
)
>
=
soft_limit
)
{
return
srtp_key_event_normal
;
}
#
else
key
-
>
num_left
-
-
;
if
(
key
-
>
num_left
>
=
soft_limit
)
{
return
srtp_key_event_normal
;
}
#
endif
if
(
key
-
>
state
=
=
srtp_key_state_normal
)
{
key
-
>
state
=
srtp_key_state_past_soft_limit
;
}
#
ifdef
NO_64BIT_MATH
if
(
low32
(
key
-
>
num_left
)
=
=
0
&
&
high32
(
key
-
>
num_left
=
=
0
)
)
#
else
if
(
key
-
>
num_left
<
1
)
#
endif
{
key
-
>
state
=
srtp_key_state_expired
;
return
srtp_key_event_hard_limit
;
}
return
srtp_key_event_soft_limit
;
}
