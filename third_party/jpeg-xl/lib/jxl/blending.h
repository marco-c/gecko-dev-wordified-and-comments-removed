#
ifndef
LIB_JXL_BLENDING_H_
#
define
LIB_JXL_BLENDING_H_
#
include
"
lib
/
jxl
/
dec_cache
.
h
"
#
include
"
lib
/
jxl
/
dec_patch_dictionary
.
h
"
#
include
"
lib
/
jxl
/
image_bundle
.
h
"
namespace
jxl
{
Status
PerformBlending
(
const
float
*
const
*
bg
const
float
*
const
*
fg
float
*
const
*
out
size_t
xsize
const
PatchBlending
&
color_blending
const
PatchBlending
*
ec_blending
const
std
:
:
vector
<
ExtraChannelInfo
>
&
extra_channel_info
)
;
class
ImageBlender
{
public
:
class
RectBlender
{
public
:
Status
DoBlending
(
size_t
y
)
;
bool
done
(
)
const
{
return
done_
;
}
private
:
friend
class
ImageBlender
;
explicit
RectBlender
(
bool
done
)
:
done_
(
done
)
{
}
bool
done_
;
Rect
current_overlap_
;
Rect
current_cropbox_
;
const
std
:
:
vector
<
ExtraChannelInfo
>
*
extra_channel_info_
;
std
:
:
vector
<
const
float
*
>
fg_ptrs_
;
std
:
:
vector
<
size_t
>
fg_strides_
;
std
:
:
vector
<
const
float
*
>
bg_ptrs_
;
std
:
:
vector
<
size_t
>
bg_strides_
;
std
:
:
vector
<
float
*
>
out_ptrs_
;
std
:
:
vector
<
size_t
>
out_strides_
;
std
:
:
vector
<
const
float
*
>
fg_row_ptrs_
;
std
:
:
vector
<
const
float
*
>
bg_row_ptrs_
;
std
:
:
vector
<
float
*
>
out_row_ptrs_
;
std
:
:
vector
<
PatchBlending
>
blending_info_
;
}
;
static
bool
NeedsBlending
(
PassesDecoderState
*
dec_state
)
;
Status
PrepareBlending
(
PassesDecoderState
*
dec_state
FrameOrigin
foreground_origin
size_t
foreground_xsize
size_t
foreground_ysize
const
std
:
:
vector
<
ExtraChannelInfo
>
*
extra_channel_info
const
ColorEncoding
&
frame_color_encoding
const
Rect
&
frame_rect
Image3F
*
output
const
Rect
&
output_rect
std
:
:
vector
<
ImageF
>
*
output_extra_channels
std
:
:
vector
<
Rect
>
output_extra_channels_rects
)
;
ImageBlender
:
:
RectBlender
PrepareRect
(
const
Rect
&
rect
const
Image3F
&
foreground
const
std
:
:
vector
<
ImageF
>
&
extra_channels
const
Rect
&
input_rect
)
const
;
bool
done
(
)
const
{
return
done_
;
}
private
:
BlendingInfo
info_
;
const
std
:
:
vector
<
ExtraChannelInfo
>
*
extra_channel_info_
;
Rect
frame_rect_
;
Image3F
*
output_
;
ImageBundle
*
bg_
;
Rect
output_rect_
;
std
:
:
vector
<
ImageF
>
*
output_extra_channels_
;
std
:
:
vector
<
Rect
>
output_extra_channels_rects_
;
Rect
cropbox_
;
Rect
overlap_
;
bool
done_
=
false
;
const
std
:
:
vector
<
BlendingInfo
>
*
ec_info_
;
FrameOrigin
o_
{
}
;
}
;
}
#
endif
