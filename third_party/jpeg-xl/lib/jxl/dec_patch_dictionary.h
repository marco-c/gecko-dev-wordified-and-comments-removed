#
ifndef
LIB_JXL_DEC_PATCH_DICTIONARY_H_
#
define
LIB_JXL_DEC_PATCH_DICTIONARY_H_
#
include
<
jxl
/
memory_manager
.
h
>
#
include
<
sys
/
types
.
h
>
#
include
<
array
>
#
include
<
cstddef
>
#
include
<
cstdint
>
#
include
<
cstring
>
#
include
<
memory
>
#
include
<
utility
>
#
include
<
vector
>
#
include
"
lib
/
jxl
/
base
/
status
.
h
"
#
include
"
lib
/
jxl
/
dec_bit_reader
.
h
"
#
include
"
lib
/
jxl
/
image_bundle
.
h
"
#
include
"
lib
/
jxl
/
image_metadata
.
h
"
namespace
jxl
{
struct
ReferceFrame
{
std
:
:
unique_ptr
<
ImageBundle
>
frame
;
bool
ib_is_in_xyb
=
false
;
}
;
enum
class
PatchBlendMode
:
uint8_t
{
kNone
=
0
kReplace
=
1
kAdd
=
2
kMul
=
3
kBlendAbove
=
4
kBlendBelow
=
5
kAlphaWeightedAddAbove
=
6
kAlphaWeightedAddBelow
=
7
}
;
constexpr
uint8_t
kNumPatchBlendModes
=
static_cast
<
uint8_t
>
(
PatchBlendMode
:
:
kAlphaWeightedAddBelow
)
+
1
;
inline
bool
UsesAlpha
(
PatchBlendMode
mode
)
{
return
mode
=
=
PatchBlendMode
:
:
kBlendAbove
|
|
mode
=
=
PatchBlendMode
:
:
kBlendBelow
|
|
mode
=
=
PatchBlendMode
:
:
kAlphaWeightedAddAbove
|
|
mode
=
=
PatchBlendMode
:
:
kAlphaWeightedAddBelow
;
}
inline
bool
UsesClamp
(
PatchBlendMode
mode
)
{
return
UsesAlpha
(
mode
)
|
|
mode
=
=
PatchBlendMode
:
:
kMul
;
}
struct
PatchBlending
{
PatchBlendMode
mode
;
uint32_t
alpha_channel
;
bool
clamp
;
}
;
struct
PatchReferencePosition
{
size_t
ref
x0
y0
xsize
ysize
;
}
;
struct
PatchPosition
{
size_t
x
y
;
size_t
ref_pos_idx
;
}
;
struct
PassesSharedState
;
class
PatchDictionaryEncoder
;
class
PatchDictionary
{
public
:
explicit
PatchDictionary
(
JxlMemoryManager
*
memory_manager
)
:
memory_manager_
(
memory_manager
)
{
}
void
SetShared
(
const
std
:
:
array
<
ReferceFrame
4
>
*
reference_frames
)
{
reference_frames_
=
reference_frames
;
}
bool
HasAny
(
)
const
{
return
!
positions_
.
empty
(
)
;
}
Status
Decode
(
JxlMemoryManager
*
memory_manager
BitReader
*
br
size_t
xsize
size_t
ysize
size_t
num_extra_channels
bool
*
uses_extra_channels
)
;
void
Clear
(
)
{
positions_
.
clear
(
)
;
ComputePatchTree
(
)
;
}
Status
AddOneRow
(
float
*
const
*
inout
size_t
y
size_t
x0
size_t
xsize
const
std
:
:
vector
<
ExtraChannelInfo
>
&
extra_channel_info
)
const
;
int
GetReferences
(
)
const
;
std
:
:
vector
<
size_t
>
GetPatchesForRow
(
size_t
y
)
const
;
private
:
friend
class
PatchDictionaryEncoder
;
JxlMemoryManager
*
memory_manager_
;
const
std
:
:
array
<
ReferceFrame
4
>
*
reference_frames_
;
std
:
:
vector
<
PatchPosition
>
positions_
;
std
:
:
vector
<
PatchReferencePosition
>
ref_positions_
;
std
:
:
vector
<
PatchBlending
>
blendings_
;
size_t
blendings_stride_
;
struct
PatchTreeNode
{
ssize_t
left_child
;
ssize_t
right_child
;
size_t
y_center
;
size_t
start
;
size_t
num
;
}
;
std
:
:
vector
<
PatchTreeNode
>
patch_tree_
;
std
:
:
vector
<
size_t
>
num_patches_
;
std
:
:
vector
<
std
:
:
pair
<
size_t
size_t
>
>
sorted_patches_y0_
;
std
:
:
vector
<
std
:
:
pair
<
size_t
size_t
>
>
sorted_patches_y1_
;
void
ComputePatchTree
(
)
;
}
;
}
#
endif
