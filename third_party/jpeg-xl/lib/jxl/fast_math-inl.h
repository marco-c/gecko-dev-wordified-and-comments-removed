#
if
defined
(
LIB_JXL_FAST_MATH_INL_H_
)
=
=
defined
(
HWY_TARGET_TOGGLE
)
#
ifdef
LIB_JXL_FAST_MATH_INL_H_
#
undef
LIB_JXL_FAST_MATH_INL_H_
#
else
#
define
LIB_JXL_FAST_MATH_INL_H_
#
endif
#
include
<
hwy
/
highway
.
h
>
#
include
"
lib
/
jxl
/
common
.
h
"
#
include
"
lib
/
jxl
/
rational_polynomial
-
inl
.
h
"
HWY_BEFORE_NAMESPACE
(
)
;
namespace
jxl
{
namespace
HWY_NAMESPACE
{
using
hwy
:
:
HWY_NAMESPACE
:
:
Abs
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Add
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Eq
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Floor
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Ge
;
using
hwy
:
:
HWY_NAMESPACE
:
:
GetLane
;
using
hwy
:
:
HWY_NAMESPACE
:
:
IfThenElse
;
using
hwy
:
:
HWY_NAMESPACE
:
:
IfThenZeroElse
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Le
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Min
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Mul
;
using
hwy
:
:
HWY_NAMESPACE
:
:
MulAdd
;
using
hwy
:
:
HWY_NAMESPACE
:
:
NegMulAdd
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Rebind
;
using
hwy
:
:
HWY_NAMESPACE
:
:
ShiftLeft
;
using
hwy
:
:
HWY_NAMESPACE
:
:
ShiftRight
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Sub
;
using
hwy
:
:
HWY_NAMESPACE
:
:
Xor
;
template
<
class
DF
class
V
>
V
FastLog2f
(
const
DF
df
V
x
)
{
HWY_ALIGN
const
float
p
[
4
*
(
2
+
1
)
]
=
{
HWY_REP4
(
-
1
.
8503833400518310E
-
06f
)
HWY_REP4
(
1
.
4287160470083755E
+
00f
)
HWY_REP4
(
7
.
4245873327820566E
-
01f
)
}
;
HWY_ALIGN
const
float
q
[
4
*
(
2
+
1
)
]
=
{
HWY_REP4
(
9
.
9032814277590719E
-
01f
)
HWY_REP4
(
1
.
0096718572241148E
+
00f
)
HWY_REP4
(
1
.
7409343003366853E
-
01f
)
}
;
const
Rebind
<
int32_t
DF
>
di
;
const
auto
x_bits
=
BitCast
(
di
x
)
;
const
auto
exp_bits
=
Sub
(
x_bits
Set
(
di
0x3f2aaaab
)
)
;
const
auto
exp_shifted
=
ShiftRight
<
23
>
(
exp_bits
)
;
const
auto
mantissa
=
BitCast
(
df
Sub
(
x_bits
ShiftLeft
<
23
>
(
exp_shifted
)
)
)
;
const
auto
exp_val
=
ConvertTo
(
df
exp_shifted
)
;
return
Add
(
EvalRationalPolynomial
(
df
Sub
(
mantissa
Set
(
df
1
.
0f
)
)
p
q
)
exp_val
)
;
}
template
<
class
DF
class
V
>
V
FastPow2f
(
const
DF
df
V
x
)
{
const
Rebind
<
int32_t
DF
>
di
;
auto
floorx
=
Floor
(
x
)
;
auto
exp
=
BitCast
(
df
ShiftLeft
<
23
>
(
Add
(
ConvertTo
(
di
floorx
)
Set
(
di
127
)
)
)
)
;
auto
frac
=
Sub
(
x
floorx
)
;
auto
num
=
Add
(
frac
Set
(
df
1
.
01749063e
+
01
)
)
;
num
=
MulAdd
(
num
frac
Set
(
df
4
.
88687798e
+
01
)
)
;
num
=
MulAdd
(
num
frac
Set
(
df
9
.
85506591e
+
01
)
)
;
num
=
Mul
(
num
exp
)
;
auto
den
=
MulAdd
(
frac
Set
(
df
2
.
10242958e
-
01
)
Set
(
df
-
2
.
22328856e
-
02
)
)
;
den
=
MulAdd
(
den
frac
Set
(
df
-
1
.
94414990e
+
01
)
)
;
den
=
MulAdd
(
den
frac
Set
(
df
9
.
85506633e
+
01
)
)
;
return
Div
(
num
den
)
;
}
template
<
class
DF
class
V
>
V
FastPowf
(
const
DF
df
V
base
V
exponent
)
{
return
FastPow2f
(
df
Mul
(
FastLog2f
(
df
base
)
exponent
)
)
;
}
template
<
class
DF
class
V
>
V
FastCosf
(
const
DF
df
V
x
)
{
const
auto
pi2
=
Set
(
df
kPi
*
2
.
0f
)
;
const
auto
pi2_inv
=
Set
(
df
0
.
5f
/
kPi
)
;
const
auto
npi2
=
Mul
(
Floor
(
Mul
(
x
pi2_inv
)
)
pi2
)
;
const
auto
xmodpi2
=
Sub
(
x
npi2
)
;
const
auto
x_pi
=
Min
(
xmodpi2
Sub
(
pi2
xmodpi2
)
)
;
const
auto
above_pihalf
=
Ge
(
x_pi
Set
(
df
kPi
/
2
.
0f
)
)
;
const
auto
x_pihalf
=
IfThenElse
(
above_pihalf
Sub
(
Set
(
df
kPi
)
x_pi
)
x_pi
)
;
const
auto
xs
=
Mul
(
x_pihalf
Set
(
df
0
.
25f
)
)
;
const
auto
x2
=
Mul
(
xs
xs
)
;
const
auto
x4
=
Mul
(
x2
x2
)
;
const
auto
cosx_prescaling
=
MulAdd
(
x4
Set
(
df
0
.
06960438
)
MulAdd
(
x2
Set
(
df
-
0
.
84087373
)
Set
(
df
1
.
68179268
)
)
)
;
const
auto
cosx_scale1
=
MulAdd
(
cosx_prescaling
cosx_prescaling
Set
(
df
-
1
.
414213562
)
)
;
const
auto
cosx_scale2
=
MulAdd
(
cosx_scale1
cosx_scale1
Set
(
df
-
1
)
)
;
const
Rebind
<
uint32_t
DF
>
du
;
auto
signbit
=
ShiftLeft
<
31
>
(
BitCast
(
du
VecFromMask
(
df
above_pihalf
)
)
)
;
return
BitCast
(
df
Xor
(
signbit
BitCast
(
du
cosx_scale2
)
)
)
;
}
template
<
class
DF
class
V
>
V
FastErff
(
const
DF
df
V
x
)
{
const
auto
xle0
=
Le
(
x
Zero
(
df
)
)
;
const
auto
absx
=
Abs
(
x
)
;
const
auto
denom1
=
MulAdd
(
absx
Set
(
df
7
.
77394369e
-
02
)
Set
(
df
2
.
05260015e
-
04
)
)
;
const
auto
denom2
=
MulAdd
(
denom1
absx
Set
(
df
2
.
32120216e
-
01
)
)
;
const
auto
denom3
=
MulAdd
(
denom2
absx
Set
(
df
2
.
77820801e
-
01
)
)
;
const
auto
denom4
=
MulAdd
(
denom3
absx
Set
(
df
1
.
0f
)
)
;
const
auto
denom5
=
Mul
(
denom4
denom4
)
;
const
auto
inv_denom5
=
Div
(
Set
(
df
1
.
0f
)
denom5
)
;
const
auto
result
=
NegMulAdd
(
inv_denom5
inv_denom5
Set
(
df
1
.
0f
)
)
;
const
Rebind
<
uint32_t
DF
>
du
;
auto
signbit
=
ShiftLeft
<
31
>
(
BitCast
(
du
VecFromMask
(
df
xle0
)
)
)
;
return
BitCast
(
df
Xor
(
signbit
BitCast
(
du
result
)
)
)
;
}
inline
float
FastLog2f
(
float
f
)
{
HWY_CAPPED
(
float
1
)
D
;
return
GetLane
(
FastLog2f
(
D
Set
(
D
f
)
)
)
;
}
inline
float
FastPow2f
(
float
f
)
{
HWY_CAPPED
(
float
1
)
D
;
return
GetLane
(
FastPow2f
(
D
Set
(
D
f
)
)
)
;
}
inline
float
FastPowf
(
float
b
float
e
)
{
HWY_CAPPED
(
float
1
)
D
;
return
GetLane
(
FastPowf
(
D
Set
(
D
b
)
Set
(
D
e
)
)
)
;
}
inline
float
FastCosf
(
float
f
)
{
HWY_CAPPED
(
float
1
)
D
;
return
GetLane
(
FastCosf
(
D
Set
(
D
f
)
)
)
;
}
inline
float
FastErff
(
float
f
)
{
HWY_CAPPED
(
float
1
)
D
;
return
GetLane
(
FastErff
(
D
Set
(
D
f
)
)
)
;
}
template
<
class
V
>
V
CubeRootAndAdd
(
const
V
x
const
V
add
)
{
const
HWY_FULL
(
float
)
df
;
const
HWY_FULL
(
int32_t
)
di
;
const
auto
kExpBias
=
Set
(
di
0x54800000
)
;
const
auto
kExpMul
=
Set
(
di
0x002AAAAA
)
;
const
auto
k1_3
=
Set
(
df
1
.
0f
/
3
)
;
const
auto
k4_3
=
Set
(
df
4
.
0f
/
3
)
;
const
auto
xa
=
x
;
const
auto
xa_3
=
Mul
(
k1_3
xa
)
;
const
auto
m1
=
BitCast
(
di
xa
)
;
const
auto
m2
=
IfThenZeroElse
(
Eq
(
m1
Zero
(
di
)
)
Sub
(
kExpBias
Mul
(
(
ShiftRight
<
23
>
(
m1
)
)
kExpMul
)
)
)
;
auto
r
=
BitCast
(
df
m2
)
;
for
(
int
i
=
0
;
i
<
3
;
i
+
+
)
{
const
auto
r2
=
Mul
(
r
r
)
;
r
=
NegMulAdd
(
xa_3
Mul
(
r2
r2
)
Mul
(
k4_3
r
)
)
;
}
auto
r2
=
Mul
(
r
r
)
;
r
=
MulAdd
(
k1_3
NegMulAdd
(
xa
Mul
(
r2
r2
)
r
)
r
)
;
r2
=
Mul
(
r
r
)
;
r
=
MulAdd
(
r2
x
add
)
;
return
r
;
}
}
}
HWY_AFTER_NAMESPACE
(
)
;
#
endif
#
if
HWY_ONCE
#
ifndef
FAST_MATH_ONCE
#
define
FAST_MATH_ONCE
namespace
jxl
{
inline
float
FastLog2f
(
float
f
)
{
return
HWY_STATIC_DISPATCH
(
FastLog2f
)
(
f
)
;
}
inline
float
FastPow2f
(
float
f
)
{
return
HWY_STATIC_DISPATCH
(
FastPow2f
)
(
f
)
;
}
inline
float
FastPowf
(
float
b
float
e
)
{
return
HWY_STATIC_DISPATCH
(
FastPowf
)
(
b
e
)
;
}
inline
float
FastCosf
(
float
f
)
{
return
HWY_STATIC_DISPATCH
(
FastCosf
)
(
f
)
;
}
inline
float
FastErff
(
float
f
)
{
return
HWY_STATIC_DISPATCH
(
FastErff
)
(
f
)
;
}
}
#
endif
#
endif
