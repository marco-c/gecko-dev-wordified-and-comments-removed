#
include
<
jxl
/
cms
.
h
>
#
include
<
cstdint
>
#
include
<
string
>
#
include
<
vector
>
#
include
"
lib
/
extras
/
codec
.
h
"
#
include
"
lib
/
jxl
/
base
/
data_parallel
.
h
"
#
include
"
lib
/
jxl
/
base
/
span
.
h
"
#
include
"
lib
/
jxl
/
codec_in_out
.
h
"
#
include
"
lib
/
jxl
/
enc_butteraugli_comparator
.
h
"
#
include
"
lib
/
jxl
/
enc_cache
.
h
"
#
include
"
lib
/
jxl
/
enc_params
.
h
"
#
include
"
lib
/
jxl
/
image
.
h
"
#
include
"
lib
/
jxl
/
image_test_utils
.
h
"
#
include
"
lib
/
jxl
/
test_utils
.
h
"
#
include
"
lib
/
jxl
/
testing
.
h
"
namespace
jxl
{
namespace
{
struct
SpeedTierTestParams
{
explicit
SpeedTierTestParams
(
const
SpeedTier
speed_tier
const
bool
shrink8
=
false
)
:
speed_tier
(
speed_tier
)
shrink8
(
shrink8
)
{
}
SpeedTier
speed_tier
;
bool
shrink8
;
}
;
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
os
SpeedTierTestParams
params
)
{
auto
previous_flags
=
os
.
flags
(
)
;
os
<
<
std
:
:
boolalpha
;
os
<
<
"
SpeedTierTestParams
{
"
<
<
static_cast
<
size_t
>
(
params
.
speed_tier
)
<
<
"
/
*
shrink8
=
*
/
"
<
<
params
.
shrink8
<
<
"
}
"
;
os
.
flags
(
previous_flags
)
;
return
os
;
}
class
SpeedTierTest
:
public
testing
:
:
TestWithParam
<
SpeedTierTestParams
>
{
}
;
JXL_GTEST_INSTANTIATE_TEST_SUITE_P
(
SpeedTierTestInstantiation
SpeedTierTest
testing
:
:
Values
(
SpeedTierTestParams
{
SpeedTier
:
:
kCheetah
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kCheetah
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kThunder
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kThunder
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kLightning
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kLightning
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kFalcon
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kFalcon
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kHare
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kHare
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kWombat
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kWombat
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kSquirrel
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kSquirrel
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kKitten
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kTortoise
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kGlacier
true
}
)
)
;
TEST_P
(
SpeedTierTest
Roundtrip
)
{
const
std
:
:
vector
<
uint8_t
>
orig
=
jxl
:
:
test
:
:
ReadTestData
(
"
external
/
wesaturate
/
500px
/
u76c0g_bliznaca_srgb8
.
png
"
)
;
CodecInOut
io
;
test
:
:
ThreadPoolForTests
pool
(
8
)
;
ASSERT_TRUE
(
SetFromBytes
(
Bytes
(
orig
)
&
io
&
pool
)
)
;
const
SpeedTierTestParams
&
params
=
GetParam
(
)
;
if
(
params
.
speed_tier
=
=
SpeedTier
:
:
kGlacier
)
{
io
.
ShrinkTo
(
8
8
)
;
}
else
if
(
params
.
shrink8
)
{
io
.
ShrinkTo
(
io
.
xsize
(
)
/
8
io
.
ysize
(
)
/
8
)
;
}
CompressParams
cparams
;
cparams
.
speed_tier
=
params
.
speed_tier
;
cparams
.
SetCms
(
*
JxlGetDefaultCms
(
)
)
;
CodecInOut
io2
io3
;
JXL_EXPECT_OK
(
test
:
:
Roundtrip
(
&
io
cparams
{
}
&
io2
_
)
)
;
EXPECT_LE
(
ButteraugliDistance
(
io
.
frames
io2
.
frames
ButteraugliParams
(
)
*
JxlGetDefaultCms
(
)
nullptr
nullptr
)
1
.
6
)
;
if
(
params
.
shrink8
)
{
cparams
.
SetLossless
(
)
;
JXL_EXPECT_OK
(
test
:
:
Roundtrip
(
&
io
cparams
{
}
&
io3
_
)
)
;
JXL_EXPECT_OK
(
SamePixels
(
*
io
.
Main
(
)
.
color
(
)
*
io3
.
Main
(
)
.
color
(
)
_
)
)
;
}
}
}
}
