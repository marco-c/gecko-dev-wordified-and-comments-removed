#
include
<
string
>
#
include
"
gtest
/
gtest
.
h
"
#
include
"
lib
/
extras
/
codec
.
h
"
#
include
"
lib
/
jxl
/
aux_out
.
h
"
#
include
"
lib
/
jxl
/
base
/
data_parallel
.
h
"
#
include
"
lib
/
jxl
/
base
/
padded_bytes
.
h
"
#
include
"
lib
/
jxl
/
base
/
thread_pool_internal
.
h
"
#
include
"
lib
/
jxl
/
codec_in_out
.
h
"
#
include
"
lib
/
jxl
/
enc_butteraugli_comparator
.
h
"
#
include
"
lib
/
jxl
/
enc_cache
.
h
"
#
include
"
lib
/
jxl
/
enc_file
.
h
"
#
include
"
lib
/
jxl
/
enc_params
.
h
"
#
include
"
lib
/
jxl
/
image
.
h
"
#
include
"
lib
/
jxl
/
image_test_utils
.
h
"
#
include
"
lib
/
jxl
/
test_utils
.
h
"
#
include
"
lib
/
jxl
/
testdata
.
h
"
namespace
jxl
{
namespace
{
struct
SpeedTierTestParams
{
explicit
SpeedTierTestParams
(
const
SpeedTier
speed_tier
const
bool
shrink8
=
false
)
:
speed_tier
(
speed_tier
)
shrink8
(
shrink8
)
{
}
SpeedTier
speed_tier
;
bool
shrink8
;
}
;
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
os
SpeedTierTestParams
params
)
{
auto
previous_flags
=
os
.
flags
(
)
;
os
<
<
std
:
:
boolalpha
;
os
<
<
"
SpeedTierTestParams
{
"
<
<
SpeedTierName
(
params
.
speed_tier
)
<
<
"
/
*
shrink8
=
*
/
"
<
<
params
.
shrink8
<
<
"
}
"
;
os
.
flags
(
previous_flags
)
;
return
os
;
}
class
SpeedTierTest
:
public
testing
:
:
TestWithParam
<
SpeedTierTestParams
>
{
}
;
JXL_GTEST_INSTANTIATE_TEST_SUITE_P
(
SpeedTierTestInstantiation
SpeedTierTest
testing
:
:
Values
(
SpeedTierTestParams
{
SpeedTier
:
:
kCheetah
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kCheetah
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kThunder
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kThunder
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kLightning
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kLightning
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kFalcon
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kFalcon
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kHare
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kHare
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kWombat
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kWombat
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kSquirrel
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kSquirrel
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kKitten
true
}
SpeedTierTestParams
{
SpeedTier
:
:
kKitten
false
}
SpeedTierTestParams
{
SpeedTier
:
:
kTortoise
true
}
)
)
;
TEST_P
(
SpeedTierTest
Roundtrip
)
{
const
PaddedBytes
orig
=
ReadTestData
(
"
external
/
wesaturate
/
500px
/
u76c0g_bliznaca_srgb8
.
png
"
)
;
CodecInOut
io
;
ThreadPoolInternal
pool
(
8
)
;
ASSERT_TRUE
(
SetFromBytes
(
Span
<
const
uint8_t
>
(
orig
)
&
io
&
pool
)
)
;
const
SpeedTierTestParams
&
params
=
GetParam
(
)
;
if
(
params
.
shrink8
)
{
io
.
ShrinkTo
(
io
.
xsize
(
)
/
8
io
.
ysize
(
)
/
8
)
;
}
CompressParams
cparams
;
cparams
.
speed_tier
=
params
.
speed_tier
;
CodecInOut
io2
;
test
:
:
Roundtrip
(
&
io
cparams
{
}
nullptr
&
io2
)
;
EXPECT_LE
(
ButteraugliDistance
(
io
io2
cparams
.
ba_params
GetJxlCms
(
)
nullptr
nullptr
)
2
.
8
)
;
}
}
}
