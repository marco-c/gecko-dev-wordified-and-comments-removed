#
ifndef
LIB_PROFILER_TSC_TIMER_H_
#
define
LIB_PROFILER_TSC_TIMER_H_
#
include
<
stdint
.
h
>
#
include
<
ctime
>
#
include
<
hwy
/
cache_control
.
h
>
#
include
"
lib
/
jxl
/
base
/
arch_macros
.
h
"
#
include
"
lib
/
jxl
/
base
/
compiler_specific
.
h
"
namespace
jxl
{
static
inline
uint64_t
TicksBefore
(
)
{
uint64_t
t
;
#
if
JXL_ARCH_PPC
asm
volatile
(
"
mfspr
%
0
%
1
"
:
"
=
r
"
(
t
)
:
"
i
"
(
268
)
)
;
#
elif
JXL_ARCH_X64
&
&
JXL_COMPILER_MSVC
hwy
:
:
LoadFence
(
)
;
JXL_COMPILER_FENCE
;
t
=
__rdtsc
(
)
;
hwy
:
:
LoadFence
(
)
;
JXL_COMPILER_FENCE
;
#
elif
JXL_ARCH_X64
&
&
(
JXL_COMPILER_CLANG
|
|
JXL_COMPILER_GCC
)
asm
volatile
(
"
lfence
\
n
\
t
"
"
rdtsc
\
n
\
t
"
"
shl
32
%
%
rdx
\
n
\
t
"
"
or
%
%
rdx
%
0
\
n
\
t
"
"
lfence
"
:
"
=
a
"
(
t
)
:
:
"
rdx
"
"
memory
"
"
cc
"
)
;
#
else
timespec
ts
;
clock_gettime
(
CLOCK_MONOTONIC
&
ts
)
;
t
=
ts
.
tv_sec
*
1000000000LL
+
ts
.
tv_nsec
;
#
endif
return
t
;
}
static
inline
uint64_t
TicksAfter
(
)
{
uint64_t
t
;
#
if
JXL_ARCH_X64
&
&
JXL_COMPILER_MSVC
JXL_COMPILER_FENCE
;
unsigned
aux
;
t
=
__rdtscp
(
&
aux
)
;
hwy
:
:
LoadFence
(
)
;
JXL_COMPILER_FENCE
;
#
elif
JXL_ARCH_X64
&
&
(
JXL_COMPILER_CLANG
|
|
JXL_COMPILER_GCC
)
asm
volatile
(
"
rdtscp
\
n
\
t
"
"
shl
32
%
%
rdx
\
n
\
t
"
"
or
%
%
rdx
%
0
\
n
\
t
"
"
lfence
"
:
"
=
a
"
(
t
)
:
:
"
rcx
"
"
rdx
"
"
memory
"
"
cc
"
)
;
#
else
t
=
TicksBefore
(
)
;
#
endif
return
t
;
}
}
#
endif
