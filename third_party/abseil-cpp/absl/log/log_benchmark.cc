#
include
"
absl
/
base
/
attributes
.
h
"
#
include
"
absl
/
base
/
log_severity
.
h
"
#
include
"
absl
/
flags
/
flag
.
h
"
#
include
"
absl
/
log
/
check
.
h
"
#
include
"
absl
/
log
/
globals
.
h
"
#
include
"
absl
/
log
/
internal
/
flags
.
h
"
#
include
"
absl
/
log
/
log
.
h
"
#
include
"
absl
/
log
/
log_entry
.
h
"
#
include
"
absl
/
log
/
log_sink
.
h
"
#
include
"
absl
/
log
/
log_sink_registry
.
h
"
#
include
"
absl
/
log
/
vlog_is_on
.
h
"
#
include
"
benchmark
/
benchmark
.
h
"
namespace
{
class
NullLogSink
:
public
absl
:
:
LogSink
{
public
:
NullLogSink
(
)
{
absl
:
:
AddLogSink
(
this
)
;
}
~
NullLogSink
(
)
override
{
absl
:
:
RemoveLogSink
(
this
)
;
}
void
Send
(
const
absl
:
:
LogEntry
&
)
override
{
}
}
;
constexpr
int
x
=
-
1
;
void
BM_SuccessfulBinaryCheck
(
benchmark
:
:
State
&
state
)
{
int
n
=
0
;
while
(
state
.
KeepRunningBatch
(
8
)
)
{
CHECK_GE
(
n
x
)
;
CHECK_GE
(
n
x
)
;
CHECK_GE
(
n
x
)
;
CHECK_GE
(
n
x
)
;
CHECK_GE
(
n
x
)
;
CHECK_GE
(
n
x
)
;
CHECK_GE
(
n
x
)
;
CHECK_GE
(
n
x
)
;
+
+
n
;
}
benchmark
:
:
DoNotOptimize
(
n
)
;
}
BENCHMARK
(
BM_SuccessfulBinaryCheck
)
;
static
void
BM_SuccessfulUnaryCheck
(
benchmark
:
:
State
&
state
)
{
int
n
=
0
;
while
(
state
.
KeepRunningBatch
(
8
)
)
{
CHECK
(
n
>
=
x
)
;
CHECK
(
n
>
=
x
)
;
CHECK
(
n
>
=
x
)
;
CHECK
(
n
>
=
x
)
;
CHECK
(
n
>
=
x
)
;
CHECK
(
n
>
=
x
)
;
CHECK
(
n
>
=
x
)
;
CHECK
(
n
>
=
x
)
;
+
+
n
;
}
benchmark
:
:
DoNotOptimize
(
n
)
;
}
BENCHMARK
(
BM_SuccessfulUnaryCheck
)
;
static
void
BM_DisabledLogOverhead
(
benchmark
:
:
State
&
state
)
{
absl
:
:
ScopedStderrThreshold
disable_stderr_logging
(
absl
:
:
LogSeverityAtLeast
:
:
kInfinity
)
;
absl
:
:
log_internal
:
:
ScopedMinLogLevel
scoped_min_log_level
(
absl
:
:
LogSeverityAtLeast
:
:
kInfinity
)
;
for
(
auto
_
:
state
)
{
LOG
(
INFO
)
;
}
}
BENCHMARK
(
BM_DisabledLogOverhead
)
;
static
void
BM_EnabledLogOverhead
(
benchmark
:
:
State
&
state
)
{
absl
:
:
ScopedStderrThreshold
stderr_logging
(
absl
:
:
LogSeverityAtLeast
:
:
kInfinity
)
;
absl
:
:
log_internal
:
:
ScopedMinLogLevel
scoped_min_log_level
(
absl
:
:
LogSeverityAtLeast
:
:
kInfo
)
;
ABSL_ATTRIBUTE_UNUSED
NullLogSink
null_sink
;
for
(
auto
_
:
state
)
{
LOG
(
INFO
)
;
}
}
BENCHMARK
(
BM_EnabledLogOverhead
)
;
static
void
BM_VlogIsOnOverhead
(
benchmark
:
:
State
&
state
)
{
absl
:
:
SetFlag
(
&
FLAGS_v
0
)
;
while
(
state
.
KeepRunningBatch
(
10
)
)
{
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
0
)
)
;
}
}
BENCHMARK
(
BM_VlogIsOnOverhead
)
-
>
ThreadRange
(
1
64
)
;
static
void
BM_VlogIsNotOnOverhead
(
benchmark
:
:
State
&
state
)
{
absl
:
:
SetFlag
(
&
FLAGS_v
0
)
;
while
(
state
.
KeepRunningBatch
(
10
)
)
{
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
benchmark
:
:
DoNotOptimize
(
VLOG_IS_ON
(
1
)
)
;
}
}
BENCHMARK
(
BM_VlogIsNotOnOverhead
)
-
>
ThreadRange
(
1
64
)
;
static
void
BM_LogEveryNOverhead
(
benchmark
:
:
State
&
state
)
{
absl
:
:
ScopedStderrThreshold
disable_stderr_logging
(
absl
:
:
LogSeverityAtLeast
:
:
kInfinity
)
;
absl
:
:
SetMinLogLevel
(
absl
:
:
LogSeverityAtLeast
:
:
kInfinity
)
;
ABSL_ATTRIBUTE_UNUSED
NullLogSink
null_sink
;
while
(
state
.
KeepRunningBatch
(
10
)
)
{
LOG_EVERY_N_SEC
(
INFO
10
)
;
LOG_EVERY_N_SEC
(
INFO
20
)
;
LOG_EVERY_N_SEC
(
INFO
30
)
;
LOG_EVERY_N_SEC
(
INFO
40
)
;
LOG_EVERY_N_SEC
(
INFO
50
)
;
LOG_EVERY_N_SEC
(
INFO
60
)
;
LOG_EVERY_N_SEC
(
INFO
70
)
;
LOG_EVERY_N_SEC
(
INFO
80
)
;
LOG_EVERY_N_SEC
(
INFO
90
)
;
LOG_EVERY_N_SEC
(
INFO
100
)
;
}
}
BENCHMARK
(
BM_LogEveryNOverhead
)
-
>
ThreadRange
(
1
64
)
;
}
