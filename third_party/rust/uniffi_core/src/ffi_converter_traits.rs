use
std
:
:
{
borrow
:
:
Borrow
sync
:
:
Arc
}
;
use
anyhow
:
:
bail
;
use
bytes
:
:
Buf
;
use
crate
:
:
{
FfiDefault
MetadataBuffer
Result
RustBuffer
UnexpectedUniFFICallbackError
}
;
pub
unsafe
trait
FfiConverter
<
UT
>
:
Sized
{
type
FfiType
:
FfiDefault
;
fn
lower
(
obj
:
Self
)
-
>
Self
:
:
FfiType
;
fn
try_lift
(
v
:
Self
:
:
FfiType
)
-
>
Result
<
Self
>
;
fn
write
(
obj
:
Self
buf
:
&
mut
Vec
<
u8
>
)
;
fn
try_read
(
buf
:
&
mut
&
[
u8
]
)
-
>
Result
<
Self
>
;
const
TYPE_ID_META
:
MetadataBuffer
;
}
pub
unsafe
trait
FfiConverterArc
<
UT
>
:
Send
+
Sync
{
type
FfiType
:
FfiDefault
;
fn
lower
(
obj
:
Arc
<
Self
>
)
-
>
Self
:
:
FfiType
;
fn
try_lift
(
v
:
Self
:
:
FfiType
)
-
>
Result
<
Arc
<
Self
>
>
;
fn
write
(
obj
:
Arc
<
Self
>
buf
:
&
mut
Vec
<
u8
>
)
;
fn
try_read
(
buf
:
&
mut
&
[
u8
]
)
-
>
Result
<
Arc
<
Self
>
>
;
const
TYPE_ID_META
:
MetadataBuffer
;
}
unsafe
impl
<
T
UT
>
FfiConverter
<
UT
>
for
Arc
<
T
>
where
T
:
FfiConverterArc
<
UT
>
+
?
Sized
{
type
FfiType
=
T
:
:
FfiType
;
fn
lower
(
obj
:
Self
)
-
>
Self
:
:
FfiType
{
T
:
:
lower
(
obj
)
}
fn
try_lift
(
v
:
Self
:
:
FfiType
)
-
>
Result
<
Self
>
{
T
:
:
try_lift
(
v
)
}
fn
write
(
obj
:
Self
buf
:
&
mut
Vec
<
u8
>
)
{
T
:
:
write
(
obj
buf
)
}
fn
try_read
(
buf
:
&
mut
&
[
u8
]
)
-
>
Result
<
Self
>
{
T
:
:
try_read
(
buf
)
}
const
TYPE_ID_META
:
MetadataBuffer
=
T
:
:
TYPE_ID_META
;
}
pub
unsafe
trait
Lift
<
UT
>
:
Sized
{
type
FfiType
;
fn
try_lift
(
v
:
Self
:
:
FfiType
)
-
>
Result
<
Self
>
;
fn
try_read
(
buf
:
&
mut
&
[
u8
]
)
-
>
Result
<
Self
>
;
fn
try_lift_from_rust_buffer
(
v
:
RustBuffer
)
-
>
Result
<
Self
>
{
let
vec
=
v
.
destroy_into_vec
(
)
;
let
mut
buf
=
vec
.
as_slice
(
)
;
let
value
=
Self
:
:
try_read
(
&
mut
buf
)
?
;
match
Buf
:
:
remaining
(
&
buf
)
{
0
=
>
Ok
(
value
)
n
=
>
bail
!
(
"
junk
data
left
in
buffer
after
lifting
(
count
:
{
n
}
)
"
)
}
}
const
TYPE_ID_META
:
MetadataBuffer
;
}
pub
unsafe
trait
Lower
<
UT
>
:
Sized
{
type
FfiType
:
FfiDefault
;
fn
lower
(
obj
:
Self
)
-
>
Self
:
:
FfiType
;
fn
write
(
obj
:
Self
buf
:
&
mut
Vec
<
u8
>
)
;
fn
lower_into_rust_buffer
(
obj
:
Self
)
-
>
RustBuffer
{
let
mut
buf
=
:
:
std
:
:
vec
:
:
Vec
:
:
new
(
)
;
Self
:
:
write
(
obj
&
mut
buf
)
;
RustBuffer
:
:
from_vec
(
buf
)
}
const
TYPE_ID_META
:
MetadataBuffer
;
}
pub
unsafe
trait
LowerReturn
<
UT
>
:
Sized
{
type
ReturnType
:
FfiDefault
;
fn
lower_return
(
obj
:
Self
)
-
>
Result
<
Self
:
:
ReturnType
RustBuffer
>
;
fn
handle_failed_lift
(
arg_name
:
&
str
e
:
anyhow
:
:
Error
)
-
>
Self
{
panic
!
(
"
Failed
to
convert
arg
'
{
arg_name
}
'
:
{
e
}
"
)
}
const
TYPE_ID_META
:
MetadataBuffer
;
}
pub
unsafe
trait
LiftReturn
<
UT
>
:
Sized
{
fn
lift_callback_return
(
buf
:
RustBuffer
)
-
>
Self
;
fn
lift_callback_error
(
_buf
:
RustBuffer
)
-
>
Self
{
panic
!
(
"
Callback
interface
method
returned
unexpected
error
"
)
}
fn
handle_callback_unexpected_error
(
e
:
UnexpectedUniFFICallbackError
)
-
>
Self
{
panic
!
(
"
Callback
interface
failure
:
{
e
}
"
)
}
const
TYPE_ID_META
:
MetadataBuffer
;
}
pub
unsafe
trait
LiftRef
<
UT
>
{
type
LiftType
:
Lift
<
UT
>
+
Borrow
<
Self
>
;
}
pub
trait
ConvertError
<
UT
>
:
Sized
{
fn
try_convert_unexpected_callback_error
(
e
:
UnexpectedUniFFICallbackError
)
-
>
Result
<
Self
>
;
}
#
[
macro_export
]
#
[
allow
(
clippy
:
:
crate_in_macro_def
)
]
macro_rules
!
derive_ffi_traits
{
(
blanket
ty
:
ty
)
=
>
{
crate
:
:
derive_ffi_traits
!
(
impl
<
UT
>
Lower
<
UT
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
<
UT
>
Lift
<
UT
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
<
UT
>
LowerReturn
<
UT
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
<
UT
>
LiftReturn
<
UT
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
<
UT
>
LiftRef
<
UT
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
<
UT
>
ConvertError
<
UT
>
for
ty
)
;
}
;
(
local
ty
:
ty
)
=
>
{
crate
:
:
derive_ffi_traits
!
(
impl
Lower
<
crate
:
:
UniFfiTag
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
Lift
<
crate
:
:
UniFfiTag
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
LowerReturn
<
crate
:
:
UniFfiTag
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
LiftReturn
<
crate
:
:
UniFfiTag
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
LiftRef
<
crate
:
:
UniFfiTag
>
for
ty
)
;
crate
:
:
derive_ffi_traits
!
(
impl
ConvertError
<
crate
:
:
UniFfiTag
>
for
ty
)
;
}
;
(
impl
(
<
(
generic
:
ident
)
*
>
)
?
(
:
:
uniffi
:
:
)
?
Lower
<
ut
:
path
>
for
ty
:
ty
(
where
(
where
:
tt
)
*
)
?
)
=
>
{
unsafe
impl
(
<
(
generic
)
*
>
)
*
crate
:
:
Lower
<
ut
>
for
ty
(
where
(
where
)
*
)
*
{
type
FfiType
=
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
FfiType
;
fn
lower
(
obj
:
Self
)
-
>
Self
:
:
FfiType
{
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
lower
(
obj
)
}
fn
write
(
obj
:
Self
buf
:
&
mut
:
:
std
:
:
vec
:
:
Vec
<
u8
>
)
{
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
write
(
obj
buf
)
}
const
TYPE_ID_META
:
crate
:
:
MetadataBuffer
=
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
TYPE_ID_META
;
}
}
;
(
impl
(
<
(
generic
:
ident
)
*
>
)
?
(
:
:
uniffi
:
:
)
?
Lift
<
ut
:
path
>
for
ty
:
ty
(
where
(
where
:
tt
)
*
)
?
)
=
>
{
unsafe
impl
(
<
(
generic
)
*
>
)
*
crate
:
:
Lift
<
ut
>
for
ty
(
where
(
where
)
*
)
*
{
type
FfiType
=
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
FfiType
;
fn
try_lift
(
v
:
Self
:
:
FfiType
)
-
>
crate
:
:
deps
:
:
anyhow
:
:
Result
<
Self
>
{
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
try_lift
(
v
)
}
fn
try_read
(
buf
:
&
mut
&
[
u8
]
)
-
>
crate
:
:
deps
:
:
anyhow
:
:
Result
<
Self
>
{
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
try_read
(
buf
)
}
const
TYPE_ID_META
:
crate
:
:
MetadataBuffer
=
<
Self
as
crate
:
:
FfiConverter
<
ut
>
>
:
:
TYPE_ID_META
;
}
}
;
(
impl
(
<
(
generic
:
ident
)
*
>
)
?
(
:
:
uniffi
:
:
)
?
LowerReturn
<
ut
:
path
>
for
ty
:
ty
(
where
(
where
:
tt
)
*
)
?
)
=
>
{
unsafe
impl
(
<
(
generic
)
*
>
)
*
crate
:
:
LowerReturn
<
ut
>
for
ty
(
where
(
where
)
*
)
*
{
type
ReturnType
=
<
Self
as
crate
:
:
Lower
<
ut
>
>
:
:
FfiType
;
fn
lower_return
(
obj
:
Self
)
-
>
crate
:
:
deps
:
:
anyhow
:
:
Result
<
Self
:
:
ReturnType
crate
:
:
RustBuffer
>
{
Ok
(
<
Self
as
crate
:
:
Lower
<
ut
>
>
:
:
lower
(
obj
)
)
}
const
TYPE_ID_META
:
crate
:
:
MetadataBuffer
=
<
Self
as
crate
:
:
Lower
<
ut
>
>
:
:
TYPE_ID_META
;
}
}
;
(
impl
(
<
(
generic
:
ident
)
*
>
)
?
(
:
:
uniffi
:
:
)
?
LiftReturn
<
ut
:
path
>
for
ty
:
ty
(
where
(
where
:
tt
)
*
)
?
)
=
>
{
unsafe
impl
(
<
(
generic
)
*
>
)
*
crate
:
:
LiftReturn
<
ut
>
for
ty
(
where
(
where
)
*
)
*
{
fn
lift_callback_return
(
buf
:
crate
:
:
RustBuffer
)
-
>
Self
{
<
Self
as
crate
:
:
Lift
<
ut
>
>
:
:
try_lift_from_rust_buffer
(
buf
)
.
expect
(
"
Error
reading
callback
interface
result
"
)
}
const
TYPE_ID_META
:
crate
:
:
MetadataBuffer
=
<
Self
as
crate
:
:
Lift
<
ut
>
>
:
:
TYPE_ID_META
;
}
}
;
(
impl
(
<
(
generic
:
ident
)
*
>
)
?
(
:
:
uniffi
:
:
)
?
LiftRef
<
ut
:
path
>
for
ty
:
ty
(
where
(
where
:
tt
)
*
)
?
)
=
>
{
unsafe
impl
(
<
(
generic
)
*
>
)
*
crate
:
:
LiftRef
<
ut
>
for
ty
(
where
(
where
)
*
)
*
{
type
LiftType
=
Self
;
}
}
;
(
impl
(
<
(
generic
:
ident
)
*
>
)
?
(
:
:
uniffi
:
:
)
?
ConvertError
<
ut
:
path
>
for
ty
:
ty
(
where
(
where
:
tt
)
*
)
?
)
=
>
{
impl
(
<
(
generic
)
*
>
)
*
crate
:
:
ConvertError
<
ut
>
for
ty
(
where
(
where
)
*
)
*
{
fn
try_convert_unexpected_callback_error
(
e
:
crate
:
:
UnexpectedUniFFICallbackError
)
-
>
crate
:
:
deps
:
:
anyhow
:
:
Result
<
Self
>
{
crate
:
:
convert_unexpected_error
!
(
e
ty
)
}
}
}
;
}
