#
include
<
stdio
.
h
>
#
include
<
stdarg
.
h
>
#
include
"
c99_math
.
h
"
#
include
"
imports
.
h
"
#
include
"
context
.
h
"
#
include
"
version
.
h
"
#
ifdef
_GNU_SOURCE
#
include
<
locale
.
h
>
#
ifdef
__APPLE__
#
include
<
xlocale
.
h
>
#
endif
#
endif
#
ifdef
_WIN32
#
define
vsnprintf
_vsnprintf
#
elif
defined
(
__IBMC__
)
|
|
defined
(
__IBMCPP__
)
extern
int
vsnprintf
(
char
*
str
size_t
count
const
char
*
fmt
va_list
arg
)
;
#
endif
void
*
_mesa_align_malloc
(
size_t
bytes
unsigned
long
alignment
)
{
#
if
defined
(
HAVE_POSIX_MEMALIGN
)
void
*
mem
;
int
err
=
posix_memalign
(
&
mem
alignment
bytes
)
;
if
(
err
)
return
NULL
;
return
mem
;
#
elif
defined
(
_WIN32
)
return
_aligned_malloc
(
bytes
alignment
)
;
#
else
uintptr_t
ptr
buf
;
assert
(
alignment
>
0
)
;
ptr
=
(
uintptr_t
)
malloc
(
bytes
+
alignment
+
sizeof
(
void
*
)
)
;
if
(
!
ptr
)
return
NULL
;
buf
=
(
ptr
+
alignment
+
sizeof
(
void
*
)
)
&
~
(
uintptr_t
)
(
alignment
-
1
)
;
*
(
uintptr_t
*
)
(
buf
-
sizeof
(
void
*
)
)
=
ptr
;
#
ifndef
NDEBUG
while
(
ptr
<
buf
-
sizeof
(
void
*
)
)
{
*
(
unsigned
long
*
)
ptr
=
0xcdcdcdcd
;
ptr
+
=
sizeof
(
unsigned
long
)
;
}
#
endif
return
(
void
*
)
buf
;
#
endif
}
void
*
_mesa_align_calloc
(
size_t
bytes
unsigned
long
alignment
)
{
#
if
defined
(
HAVE_POSIX_MEMALIGN
)
void
*
mem
;
mem
=
_mesa_align_malloc
(
bytes
alignment
)
;
if
(
mem
!
=
NULL
)
{
(
void
)
memset
(
mem
0
bytes
)
;
}
return
mem
;
#
elif
defined
(
_WIN32
)
void
*
mem
;
mem
=
_aligned_malloc
(
bytes
alignment
)
;
if
(
mem
!
=
NULL
)
{
(
void
)
memset
(
mem
0
bytes
)
;
}
return
mem
;
#
else
uintptr_t
ptr
buf
;
assert
(
alignment
>
0
)
;
ptr
=
(
uintptr_t
)
calloc
(
1
bytes
+
alignment
+
sizeof
(
void
*
)
)
;
if
(
!
ptr
)
return
NULL
;
buf
=
(
ptr
+
alignment
+
sizeof
(
void
*
)
)
&
~
(
uintptr_t
)
(
alignment
-
1
)
;
*
(
uintptr_t
*
)
(
buf
-
sizeof
(
void
*
)
)
=
ptr
;
#
ifndef
NDEBUG
while
(
ptr
<
buf
-
sizeof
(
void
*
)
)
{
*
(
unsigned
long
*
)
ptr
=
0xcdcdcdcd
;
ptr
+
=
sizeof
(
unsigned
long
)
;
}
#
endif
return
(
void
*
)
buf
;
#
endif
}
void
_mesa_align_free
(
void
*
ptr
)
{
#
if
defined
(
HAVE_POSIX_MEMALIGN
)
free
(
ptr
)
;
#
elif
defined
(
_WIN32
)
_aligned_free
(
ptr
)
;
#
else
if
(
ptr
)
{
void
*
*
cubbyHole
=
(
void
*
*
)
(
(
char
*
)
ptr
-
sizeof
(
void
*
)
)
;
void
*
realAddr
=
*
cubbyHole
;
free
(
realAddr
)
;
}
#
endif
}
void
*
_mesa_align_realloc
(
void
*
oldBuffer
size_t
oldSize
size_t
newSize
unsigned
long
alignment
)
{
#
if
defined
(
_WIN32
)
(
void
)
oldSize
;
return
_aligned_realloc
(
oldBuffer
newSize
alignment
)
;
#
else
const
size_t
copySize
=
(
oldSize
<
newSize
)
?
oldSize
:
newSize
;
void
*
newBuf
=
_mesa_align_malloc
(
newSize
alignment
)
;
if
(
newBuf
&
&
oldBuffer
&
&
copySize
>
0
)
{
memcpy
(
newBuf
oldBuffer
copySize
)
;
}
_mesa_align_free
(
oldBuffer
)
;
return
newBuf
;
#
endif
}
int
_mesa_vsnprintf
(
char
*
str
size_t
size
const
char
*
fmt
va_list
args
)
{
return
vsnprintf
(
str
size
fmt
args
)
;
}
int
_mesa_snprintf
(
char
*
str
size_t
size
const
char
*
fmt
.
.
.
)
{
int
r
;
va_list
args
;
va_start
(
args
fmt
)
;
r
=
vsnprintf
(
str
size
fmt
args
)
;
va_end
(
args
)
;
return
r
;
}
