#
include
"
pipe
/
p_config
.
h
"
#
include
"
util
/
u_math
.
h
"
#
include
"
util
/
u_cpu_detect
.
h
"
#
if
defined
(
PIPE_ARCH_SSE
)
#
include
<
xmmintrin
.
h
>
#
ifndef
_MM_DENORMALS_ZERO_MASK
#
define
_MM_DENORMALS_ZERO_MASK
0x0040
#
endif
#
endif
float
pow2_table
[
POW2_TABLE_SIZE
]
;
static
void
init_pow2_table
(
void
)
{
int
i
;
for
(
i
=
0
;
i
<
POW2_TABLE_SIZE
;
i
+
+
)
pow2_table
[
i
]
=
exp2f
(
(
i
-
POW2_TABLE_OFFSET
)
/
POW2_TABLE_SCALE
)
;
}
float
log2_table
[
LOG2_TABLE_SIZE
]
;
static
void
init_log2_table
(
void
)
{
unsigned
i
;
for
(
i
=
0
;
i
<
LOG2_TABLE_SIZE
;
i
+
+
)
log2_table
[
i
]
=
(
float
)
log2
(
1
.
0
+
i
*
(
1
.
0
/
LOG2_TABLE_SCALE
)
)
;
}
void
util_init_math
(
void
)
{
static
bool
initialized
=
false
;
if
(
!
initialized
)
{
init_pow2_table
(
)
;
init_log2_table
(
)
;
initialized
=
true
;
}
}
unsigned
util_fpstate_get
(
void
)
{
unsigned
mxcsr
=
0
;
#
if
defined
(
PIPE_ARCH_SSE
)
if
(
util_cpu_caps
.
has_sse
)
{
mxcsr
=
_mm_getcsr
(
)
;
}
#
endif
return
mxcsr
;
}
unsigned
util_fpstate_set_denorms_to_zero
(
unsigned
current_mxcsr
)
{
#
if
defined
(
PIPE_ARCH_SSE
)
if
(
util_cpu_caps
.
has_sse
)
{
current_mxcsr
|
=
_MM_FLUSH_ZERO_MASK
;
if
(
util_cpu_caps
.
has_daz
)
{
current_mxcsr
|
=
_MM_DENORMALS_ZERO_MASK
;
}
util_fpstate_set
(
current_mxcsr
)
;
}
#
endif
return
current_mxcsr
;
}
void
util_fpstate_set
(
unsigned
mxcsr
)
{
#
if
defined
(
PIPE_ARCH_SSE
)
if
(
util_cpu_caps
.
has_sse
)
{
_mm_setcsr
(
mxcsr
)
;
}
#
endif
}
