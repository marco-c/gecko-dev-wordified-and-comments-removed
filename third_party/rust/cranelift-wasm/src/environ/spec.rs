use
crate
:
:
state
:
:
{
FuncTranslationState
ModuleTranslationState
}
;
use
crate
:
:
translation_utils
:
:
{
DataIndex
ElemIndex
FuncIndex
Global
GlobalIndex
Memory
MemoryIndex
SignatureIndex
Table
TableIndex
}
;
use
core
:
:
convert
:
:
From
;
use
cranelift_codegen
:
:
cursor
:
:
FuncCursor
;
use
cranelift_codegen
:
:
ir
:
:
immediates
:
:
Offset32
;
use
cranelift_codegen
:
:
ir
:
:
{
self
InstBuilder
}
;
use
cranelift_codegen
:
:
isa
:
:
TargetFrontendConfig
;
use
cranelift_frontend
:
:
FunctionBuilder
;
use
std
:
:
boxed
:
:
Box
;
use
thiserror
:
:
Error
;
use
wasmparser
:
:
BinaryReaderError
;
use
wasmparser
:
:
Operator
;
pub
use
wasmparser
:
:
{
FuncType
as
WasmFuncType
Type
as
WasmType
}
;
#
[
derive
(
Clone
Copy
)
]
pub
enum
GlobalVariable
{
Const
(
ir
:
:
Value
)
Memory
{
gv
:
ir
:
:
GlobalValue
offset
:
Offset32
ty
:
ir
:
:
Type
}
Custom
}
#
[
derive
(
Error
Debug
)
]
pub
enum
WasmError
{
#
[
error
(
"
Invalid
input
WebAssembly
code
at
offset
{
offset
}
:
{
message
}
"
)
]
InvalidWebAssembly
{
message
:
std
:
:
string
:
:
String
offset
:
usize
}
#
[
error
(
"
Unsupported
feature
:
{
0
}
"
)
]
Unsupported
(
std
:
:
string
:
:
String
)
#
[
error
(
"
Implementation
limit
exceeded
"
)
]
ImplLimitExceeded
#
[
error
(
"
User
error
:
{
0
}
"
)
]
User
(
std
:
:
string
:
:
String
)
}
#
[
macro_export
]
macro_rules
!
wasm_unsupported
{
(
(
arg
:
tt
)
*
)
=
>
{
crate
:
:
environ
:
:
WasmError
:
:
Unsupported
(
format
!
(
(
arg
)
*
)
)
}
}
impl
From
<
BinaryReaderError
>
for
WasmError
{
fn
from
(
e
:
BinaryReaderError
)
-
>
Self
{
Self
:
:
InvalidWebAssembly
{
message
:
e
.
message
(
)
.
into
(
)
offset
:
e
.
offset
(
)
}
}
}
pub
type
WasmResult
<
T
>
=
Result
<
T
WasmError
>
;
#
[
derive
(
Copy
Clone
PartialEq
Eq
Debug
)
]
pub
enum
ReturnMode
{
NormalReturns
FallthroughReturn
}
pub
trait
TargetEnvironment
{
fn
target_config
(
&
self
)
-
>
TargetFrontendConfig
;
fn
pointer_type
(
&
self
)
-
>
ir
:
:
Type
{
ir
:
:
Type
:
:
int
(
u16
:
:
from
(
self
.
target_config
(
)
.
pointer_bits
(
)
)
)
.
unwrap
(
)
}
fn
pointer_bytes
(
&
self
)
-
>
u8
{
self
.
target_config
(
)
.
pointer_bytes
(
)
}
fn
reference_type
(
&
self
)
-
>
ir
:
:
Type
{
match
self
.
pointer_type
(
)
{
ir
:
:
types
:
:
I32
=
>
ir
:
:
types
:
:
R32
ir
:
:
types
:
:
I64
=
>
ir
:
:
types
:
:
R64
_
=
>
panic
!
(
"
unsupported
pointer
type
"
)
}
}
}
pub
trait
FuncEnvironment
:
TargetEnvironment
{
fn
is_wasm_parameter
(
&
self
signature
:
&
ir
:
:
Signature
index
:
usize
)
-
>
bool
{
signature
.
params
[
index
]
.
purpose
=
=
ir
:
:
ArgumentPurpose
:
:
Normal
}
fn
is_wasm_return
(
&
self
signature
:
&
ir
:
:
Signature
index
:
usize
)
-
>
bool
{
signature
.
returns
[
index
]
.
purpose
=
=
ir
:
:
ArgumentPurpose
:
:
Normal
}
fn
return_mode
(
&
self
)
-
>
ReturnMode
{
ReturnMode
:
:
NormalReturns
}
fn
make_global
(
&
mut
self
func
:
&
mut
ir
:
:
Function
index
:
GlobalIndex
)
-
>
WasmResult
<
GlobalVariable
>
;
fn
make_heap
(
&
mut
self
func
:
&
mut
ir
:
:
Function
index
:
MemoryIndex
)
-
>
WasmResult
<
ir
:
:
Heap
>
;
fn
make_table
(
&
mut
self
func
:
&
mut
ir
:
:
Function
index
:
TableIndex
)
-
>
WasmResult
<
ir
:
:
Table
>
;
fn
make_indirect_sig
(
&
mut
self
func
:
&
mut
ir
:
:
Function
index
:
SignatureIndex
)
-
>
WasmResult
<
ir
:
:
SigRef
>
;
fn
make_direct_func
(
&
mut
self
func
:
&
mut
ir
:
:
Function
index
:
FuncIndex
)
-
>
WasmResult
<
ir
:
:
FuncRef
>
;
#
[
cfg_attr
(
feature
=
"
cargo
-
clippy
"
allow
(
clippy
:
:
too_many_arguments
)
)
]
fn
translate_call_indirect
(
&
mut
self
pos
:
FuncCursor
table_index
:
TableIndex
table
:
ir
:
:
Table
sig_index
:
SignatureIndex
sig_ref
:
ir
:
:
SigRef
callee
:
ir
:
:
Value
call_args
:
&
[
ir
:
:
Value
]
)
-
>
WasmResult
<
ir
:
:
Inst
>
;
fn
translate_call
(
&
mut
self
mut
pos
:
FuncCursor
_callee_index
:
FuncIndex
callee
:
ir
:
:
FuncRef
call_args
:
&
[
ir
:
:
Value
]
)
-
>
WasmResult
<
ir
:
:
Inst
>
{
Ok
(
pos
.
ins
(
)
.
call
(
callee
call_args
)
)
}
fn
translate_memory_grow
(
&
mut
self
pos
:
FuncCursor
index
:
MemoryIndex
heap
:
ir
:
:
Heap
val
:
ir
:
:
Value
)
-
>
WasmResult
<
ir
:
:
Value
>
;
fn
translate_memory_size
(
&
mut
self
pos
:
FuncCursor
index
:
MemoryIndex
heap
:
ir
:
:
Heap
)
-
>
WasmResult
<
ir
:
:
Value
>
;
fn
translate_memory_copy
(
&
mut
self
pos
:
FuncCursor
index
:
MemoryIndex
heap
:
ir
:
:
Heap
dst
:
ir
:
:
Value
src
:
ir
:
:
Value
len
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
fn
translate_memory_fill
(
&
mut
self
pos
:
FuncCursor
index
:
MemoryIndex
heap
:
ir
:
:
Heap
dst
:
ir
:
:
Value
val
:
ir
:
:
Value
len
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
#
[
allow
(
clippy
:
:
too_many_arguments
)
]
fn
translate_memory_init
(
&
mut
self
pos
:
FuncCursor
index
:
MemoryIndex
heap
:
ir
:
:
Heap
seg_index
:
u32
dst
:
ir
:
:
Value
src
:
ir
:
:
Value
len
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
fn
translate_data_drop
(
&
mut
self
pos
:
FuncCursor
seg_index
:
u32
)
-
>
WasmResult
<
(
)
>
;
fn
translate_table_size
(
&
mut
self
pos
:
FuncCursor
index
:
TableIndex
table
:
ir
:
:
Table
)
-
>
WasmResult
<
ir
:
:
Value
>
;
fn
translate_table_grow
(
&
mut
self
pos
:
FuncCursor
table_index
:
TableIndex
delta
:
ir
:
:
Value
init_value
:
ir
:
:
Value
)
-
>
WasmResult
<
ir
:
:
Value
>
;
fn
translate_table_get
(
&
mut
self
pos
:
FuncCursor
table_index
:
TableIndex
index
:
ir
:
:
Value
)
-
>
WasmResult
<
ir
:
:
Value
>
;
fn
translate_table_set
(
&
mut
self
pos
:
FuncCursor
table_index
:
TableIndex
value
:
ir
:
:
Value
index
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
#
[
allow
(
clippy
:
:
too_many_arguments
)
]
fn
translate_table_copy
(
&
mut
self
pos
:
FuncCursor
dst_table_index
:
TableIndex
dst_table
:
ir
:
:
Table
src_table_index
:
TableIndex
src_table
:
ir
:
:
Table
dst
:
ir
:
:
Value
src
:
ir
:
:
Value
len
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
fn
translate_table_fill
(
&
mut
self
pos
:
FuncCursor
table_index
:
TableIndex
dst
:
ir
:
:
Value
val
:
ir
:
:
Value
len
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
#
[
allow
(
clippy
:
:
too_many_arguments
)
]
fn
translate_table_init
(
&
mut
self
pos
:
FuncCursor
seg_index
:
u32
table_index
:
TableIndex
table
:
ir
:
:
Table
dst
:
ir
:
:
Value
src
:
ir
:
:
Value
len
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
fn
translate_elem_drop
(
&
mut
self
pos
:
FuncCursor
seg_index
:
u32
)
-
>
WasmResult
<
(
)
>
;
fn
translate_ref_func
(
&
mut
self
pos
:
FuncCursor
func_index
:
u32
)
-
>
WasmResult
<
ir
:
:
Value
>
;
fn
translate_custom_global_get
(
&
mut
self
pos
:
FuncCursor
global_index
:
GlobalIndex
)
-
>
WasmResult
<
ir
:
:
Value
>
;
fn
translate_custom_global_set
(
&
mut
self
pos
:
FuncCursor
global_index
:
GlobalIndex
val
:
ir
:
:
Value
)
-
>
WasmResult
<
(
)
>
;
fn
translate_loop_header
(
&
mut
self
_pos
:
FuncCursor
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
before_translate_operator
(
&
mut
self
_op
:
&
Operator
_builder
:
&
mut
FunctionBuilder
_state
:
&
FuncTranslationState
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
after_translate_operator
(
&
mut
self
_op
:
&
Operator
_builder
:
&
mut
FunctionBuilder
_state
:
&
FuncTranslationState
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
}
pub
trait
ModuleEnvironment
<
'
data
>
:
TargetEnvironment
{
fn
reserve_signatures
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_signature
(
&
mut
self
wasm_func_type
:
&
WasmFuncType
sig
:
ir
:
:
Signature
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_imports
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_func_import
(
&
mut
self
sig_index
:
SignatureIndex
module
:
&
'
data
str
field
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
declare_table_import
(
&
mut
self
table
:
Table
module
:
&
'
data
str
field
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
declare_memory_import
(
&
mut
self
memory
:
Memory
module
:
&
'
data
str
field
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
declare_global_import
(
&
mut
self
global
:
Global
module
:
&
'
data
str
field
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
finish_imports
(
&
mut
self
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
reserve_func_types
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_func_type
(
&
mut
self
sig_index
:
SignatureIndex
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_tables
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_table
(
&
mut
self
table
:
Table
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_memories
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_memory
(
&
mut
self
memory
:
Memory
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_globals
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_global
(
&
mut
self
global
:
Global
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_exports
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_func_export
(
&
mut
self
func_index
:
FuncIndex
name
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
declare_table_export
(
&
mut
self
table_index
:
TableIndex
name
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
declare_memory_export
(
&
mut
self
memory_index
:
MemoryIndex
name
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
declare_global_export
(
&
mut
self
global_index
:
GlobalIndex
name
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
;
fn
finish_exports
(
&
mut
self
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_start_func
(
&
mut
self
index
:
FuncIndex
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_table_elements
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_table_elements
(
&
mut
self
table_index
:
TableIndex
base
:
Option
<
GlobalIndex
>
offset
:
usize
elements
:
Box
<
[
FuncIndex
]
>
)
-
>
WasmResult
<
(
)
>
;
fn
declare_passive_element
(
&
mut
self
index
:
ElemIndex
elements
:
Box
<
[
FuncIndex
]
>
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_passive_data
(
&
mut
self
count
:
u32
)
-
>
WasmResult
<
(
)
>
{
let
_
=
count
;
Ok
(
(
)
)
}
fn
declare_passive_data
(
&
mut
self
data_index
:
DataIndex
data
:
&
'
data
[
u8
]
)
-
>
WasmResult
<
(
)
>
;
fn
define_function_body
(
&
mut
self
module_translation_state
:
&
ModuleTranslationState
body_bytes
:
&
'
data
[
u8
]
body_offset
:
usize
)
-
>
WasmResult
<
(
)
>
;
fn
reserve_data_initializers
(
&
mut
self
_num
:
u32
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_data_initialization
(
&
mut
self
memory_index
:
MemoryIndex
base
:
Option
<
GlobalIndex
>
offset
:
usize
data
:
&
'
data
[
u8
]
)
-
>
WasmResult
<
(
)
>
;
fn
declare_module_name
(
&
mut
self
_name
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
declare_func_name
(
&
mut
self
_func_index
:
FuncIndex
_name
:
&
'
data
str
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
fn
custom_section
(
&
mut
self
_name
:
&
'
data
str
_data
:
&
'
data
[
u8
]
)
-
>
WasmResult
<
(
)
>
{
Ok
(
(
)
)
}
}
