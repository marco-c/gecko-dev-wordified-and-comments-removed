#
include
"
config
.
h
"
#
include
<
stddef
.
h
>
#
include
<
sys
/
types
.
h
>
#
include
"
backtrace
.
h
"
#
include
"
internal
.
h
"
static
void
swap
(
char
*
a
char
*
b
size_t
size
)
{
size_t
i
;
for
(
i
=
0
;
i
<
size
;
i
+
+
a
+
+
b
+
+
)
{
char
t
;
t
=
*
a
;
*
a
=
*
b
;
*
b
=
t
;
}
}
void
backtrace_qsort
(
void
*
basearg
size_t
count
size_t
size
int
(
*
compar
)
(
const
void
*
const
void
*
)
)
{
char
*
base
=
(
char
*
)
basearg
;
size_t
i
;
size_t
mid
;
tail_recurse
:
if
(
count
<
2
)
return
;
swap
(
base
base
+
(
count
/
2
)
*
size
size
)
;
mid
=
0
;
for
(
i
=
1
;
i
<
count
;
i
+
+
)
{
if
(
(
*
compar
)
(
base
base
+
i
*
size
)
>
0
)
{
+
+
mid
;
if
(
i
!
=
mid
)
swap
(
base
+
mid
*
size
base
+
i
*
size
size
)
;
}
}
if
(
mid
>
0
)
swap
(
base
base
+
mid
*
size
size
)
;
if
(
2
*
mid
<
count
)
{
backtrace_qsort
(
base
mid
size
compar
)
;
base
+
=
(
mid
+
1
)
*
size
;
count
-
=
mid
+
1
;
goto
tail_recurse
;
}
else
{
backtrace_qsort
(
base
+
(
mid
+
1
)
*
size
count
-
(
mid
+
1
)
size
compar
)
;
count
=
mid
;
goto
tail_recurse
;
}
}
