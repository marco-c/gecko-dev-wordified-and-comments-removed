#
include
"
config
.
h
"
#
include
<
errno
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
sys
/
types
.
h
>
#
include
<
unistd
.
h
>
#
include
"
backtrace
.
h
"
#
include
"
internal
.
h
"
int
backtrace_get_view
(
struct
backtrace_state
*
state
int
descriptor
off_t
offset
size_t
size
backtrace_error_callback
error_callback
void
*
data
struct
backtrace_view
*
view
)
{
ssize_t
got
;
if
(
lseek
(
descriptor
offset
SEEK_SET
)
<
0
)
{
error_callback
(
data
"
lseek
"
errno
)
;
return
0
;
}
view
-
>
base
=
backtrace_alloc
(
state
size
error_callback
data
)
;
if
(
view
-
>
base
=
=
NULL
)
return
0
;
view
-
>
data
=
view
-
>
base
;
view
-
>
len
=
size
;
got
=
read
(
descriptor
view
-
>
base
size
)
;
if
(
got
<
0
)
{
error_callback
(
data
"
read
"
errno
)
;
free
(
view
-
>
base
)
;
return
0
;
}
if
(
(
size_t
)
got
<
size
)
{
error_callback
(
data
"
file
too
short
"
0
)
;
free
(
view
-
>
base
)
;
return
0
;
}
return
1
;
}
void
backtrace_release_view
(
struct
backtrace_state
*
state
struct
backtrace_view
*
view
backtrace_error_callback
error_callback
void
*
data
)
{
backtrace_free
(
state
view
-
>
base
view
-
>
len
error_callback
data
)
;
view
-
>
data
=
NULL
;
view
-
>
base
=
NULL
;
}
