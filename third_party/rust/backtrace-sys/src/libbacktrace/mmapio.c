#
include
"
config
.
h
"
#
include
<
errno
.
h
>
#
include
<
sys
/
types
.
h
>
#
include
<
sys
/
mman
.
h
>
#
include
<
unistd
.
h
>
#
include
"
backtrace
.
h
"
#
include
"
internal
.
h
"
#
ifndef
MAP_FAILED
#
define
MAP_FAILED
(
(
void
*
)
-
1
)
#
endif
int
backtrace_get_view
(
struct
backtrace_state
*
state
ATTRIBUTE_UNUSED
int
descriptor
off_t
offset
size_t
size
backtrace_error_callback
error_callback
void
*
data
struct
backtrace_view
*
view
)
{
size_t
pagesize
;
unsigned
int
inpage
;
off_t
pageoff
;
void
*
map
;
pagesize
=
getpagesize
(
)
;
inpage
=
offset
%
pagesize
;
pageoff
=
offset
-
inpage
;
size
+
=
inpage
;
size
=
(
size
+
(
pagesize
-
1
)
)
&
~
(
pagesize
-
1
)
;
map
=
mmap
(
NULL
size
PROT_READ
MAP_PRIVATE
descriptor
pageoff
)
;
if
(
map
=
=
MAP_FAILED
)
{
error_callback
(
data
"
mmap
"
errno
)
;
return
0
;
}
view
-
>
data
=
(
char
*
)
map
+
inpage
;
view
-
>
base
=
map
;
view
-
>
len
=
size
;
return
1
;
}
void
backtrace_release_view
(
struct
backtrace_state
*
state
ATTRIBUTE_UNUSED
struct
backtrace_view
*
view
backtrace_error_callback
error_callback
void
*
data
)
{
union
{
const
void
*
cv
;
void
*
v
;
}
const_cast
;
const_cast
.
cv
=
view
-
>
base
;
if
(
munmap
(
const_cast
.
v
view
-
>
len
)
<
0
)
error_callback
(
data
"
munmap
"
errno
)
;
}
