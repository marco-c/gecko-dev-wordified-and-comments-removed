#
include
"
config
.
h
"
#
include
"
unwind
.
h
"
#
include
"
backtrace
.
h
"
struct
backtrace_simple_data
{
int
skip
;
struct
backtrace_state
*
state
;
backtrace_simple_callback
callback
;
backtrace_error_callback
error_callback
;
void
*
data
;
int
ret
;
}
;
static
_Unwind_Reason_Code
simple_unwind
(
struct
_Unwind_Context
*
context
void
*
vdata
)
{
struct
backtrace_simple_data
*
bdata
=
(
struct
backtrace_simple_data
*
)
vdata
;
uintptr_t
pc
;
int
ip_before_insn
=
0
;
#
ifdef
HAVE_GETIPINFO
pc
=
_Unwind_GetIPInfo
(
context
&
ip_before_insn
)
;
#
else
pc
=
_Unwind_GetIP
(
context
)
;
#
endif
if
(
bdata
-
>
skip
>
0
)
{
-
-
bdata
-
>
skip
;
return
_URC_NO_REASON
;
}
if
(
!
ip_before_insn
)
-
-
pc
;
bdata
-
>
ret
=
bdata
-
>
callback
(
bdata
-
>
data
pc
)
;
if
(
bdata
-
>
ret
!
=
0
)
return
_URC_END_OF_STACK
;
return
_URC_NO_REASON
;
}
int
backtrace_simple
(
struct
backtrace_state
*
state
int
skip
backtrace_simple_callback
callback
backtrace_error_callback
error_callback
void
*
data
)
{
struct
backtrace_simple_data
bdata
;
bdata
.
skip
=
skip
+
1
;
bdata
.
state
=
state
;
bdata
.
callback
=
callback
;
bdata
.
error_callback
=
error_callback
;
bdata
.
data
=
data
;
bdata
.
ret
=
0
;
_Unwind_Backtrace
(
simple_unwind
&
bdata
)
;
return
bdata
.
ret
;
}
