#
!
[
no_std
]
extern
crate
alloc
;
mod
cabi_realloc
;
pub
fn
maybe_link_cabi_realloc
(
)
{
#
[
cfg
(
target_family
=
"
wasm
"
)
]
{
extern
"
C
"
{
fn
cabi_realloc
(
old_ptr
:
*
mut
u8
old_len
:
usize
align
:
usize
new_len
:
usize
)
-
>
*
mut
u8
;
}
#
[
used
]
static
_NAME_DOES_NOT_MATTER
:
unsafe
extern
"
C
"
fn
(
*
mut
u8
usize
usize
usize
)
-
>
*
mut
u8
=
cabi_realloc
;
}
}
pub
unsafe
fn
cabi_realloc
(
old_ptr
:
*
mut
u8
old_len
:
usize
align
:
usize
new_len
:
usize
)
-
>
*
mut
u8
{
use
self
:
:
alloc
:
:
alloc
:
:
{
self
Layout
}
;
let
layout
;
let
ptr
=
if
old_len
=
=
0
{
if
new_len
=
=
0
{
return
align
as
*
mut
u8
;
}
layout
=
Layout
:
:
from_size_align_unchecked
(
new_len
align
)
;
alloc
:
:
alloc
(
layout
)
}
else
{
debug_assert_ne
!
(
new_len
0
"
non
-
zero
old_len
requires
non
-
zero
new_len
!
"
)
;
layout
=
Layout
:
:
from_size_align_unchecked
(
old_len
align
)
;
alloc
:
:
realloc
(
old_ptr
layout
new_len
)
}
;
if
ptr
.
is_null
(
)
{
if
cfg
!
(
debug_assertions
)
{
alloc
:
:
handle_alloc_error
(
layout
)
;
}
else
{
#
[
cfg
(
target_arch
=
"
wasm32
"
)
]
core
:
:
arch
:
:
wasm32
:
:
unreachable
(
)
;
#
[
cfg
(
not
(
target_arch
=
"
wasm32
"
)
)
]
unreachable
!
(
)
;
}
}
return
ptr
;
}
