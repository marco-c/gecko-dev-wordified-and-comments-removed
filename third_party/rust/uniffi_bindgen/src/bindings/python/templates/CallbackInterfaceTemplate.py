{
%
import
"
macros
.
py
"
as
py
%
}
{
%
-
let
cbi
=
self
.
inner
(
)
%
}
{
%
-
let
canonical_name
=
cbi
|
canonical_name
%
}
{
%
-
let
ffi_converter
=
cbi
|
ffi_converter_name
%
}
{
%
-
let
foreign_callback
=
format
!
(
"
foreignCallback
{
}
"
canonical_name
)
%
}
class
{
{
cbi
|
type_name
}
}
:
    
{
%
for
meth
in
cbi
.
methods
(
)
-
%
}
    
def
{
{
meth
.
name
(
)
|
fn_name
}
}
(
{
%
call
py
:
:
arg_list_decl
(
meth
)
%
}
)
:
        
raise
NotImplementedError
    
{
%
endfor
%
}
def
py_
{
{
foreign_callback
}
}
(
handle
method
args
buf_ptr
)
:
    
{
%
for
meth
in
cbi
.
methods
(
)
-
%
}
    
{
%
let
method_name
=
format
!
(
"
invoke_
{
}
"
meth
.
name
(
)
)
|
fn_name
%
}
    
def
{
{
method_name
}
}
(
python_callback
args
)
:
        
{
        
rval
=
None
        
{
%
-
if
meth
.
arguments
(
)
.
len
(
)
!
=
0
-
%
}
        
{
        
with
args
.
consumeWithStream
(
)
as
buf
:
            
rval
=
python_callback
.
{
{
meth
.
name
(
)
|
fn_name
}
}
(
                
{
%
for
arg
in
meth
.
arguments
(
)
-
%
}
                
{
{
arg
|
read_fn
}
}
(
buf
)
                
{
%
-
if
!
loop
.
last
%
}
{
%
endif
%
}
                
{
%
endfor
-
%
}
            
)
        
{
%
else
%
}
        
rval
=
python_callback
.
{
{
meth
.
name
(
)
|
fn_name
}
}
(
)
        
{
%
endif
-
%
}
        
{
        
{
%
-
match
meth
.
return_type
(
)
-
%
}
        
{
%
-
when
Some
with
(
return_type
)
-
%
}
        
with
RustBuffer
.
allocWithBuilder
(
)
as
builder
:
            
{
{
return_type
|
write_fn
}
}
(
rval
builder
)
            
return
builder
.
finalize
(
)
        
{
%
-
else
-
%
}
        
return
RustBuffer
.
alloc
(
0
)
        
{
%
endmatch
-
%
}
    
{
%
endfor
%
}
    
cb
=
{
{
ffi_converter
}
}
.
lift
(
handle
)
    
if
not
cb
:
        
raise
InternalError
(
"
No
callback
in
handlemap
;
this
is
a
Uniffi
bug
"
)
    
if
method
=
=
IDX_CALLBACK_FREE
:
        
{
{
ffi_converter
}
}
.
drop
(
handle
)
        
return
0
    
{
%
for
meth
in
cbi
.
methods
(
)
-
%
}
    
{
%
let
method_name
=
format
!
(
"
invoke_
{
}
"
meth
.
name
(
)
)
|
fn_name
-
%
}
    
if
method
=
=
{
{
loop
.
index
}
}
:
        
buf_ptr
[
0
]
=
{
{
method_name
}
}
(
cb
args
)
        
return
1
    
{
%
endfor
%
}
    
return
-
1
{
{
foreign_callback
}
}
=
FOREIGN_CALLBACK_T
(
py_
{
{
foreign_callback
}
}
)
rust_call
(
lambda
err
:
_UniFFILib
.
{
{
cbi
.
ffi_init_callback
(
)
.
name
(
)
}
}
(
{
{
foreign_callback
}
}
err
)
)
{
{
ffi_converter
}
}
=
FfiConverterCallbackInterface
(
{
{
foreign_callback
}
}
)
