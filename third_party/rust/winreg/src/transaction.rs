#
!
[
cfg
(
feature
=
"
transactions
"
)
]
use
std
:
:
ptr
;
use
std
:
:
io
;
use
winapi
:
:
um
:
:
winnt
;
use
winapi
:
:
um
:
:
handleapi
;
use
winapi
:
:
um
:
:
ktmw32
;
#
[
derive
(
Debug
)
]
pub
struct
Transaction
{
pub
handle
:
winnt
:
:
HANDLE
}
impl
Transaction
{
pub
fn
new
(
)
-
>
io
:
:
Result
<
Transaction
>
{
unsafe
{
let
handle
=
ktmw32
:
:
CreateTransaction
(
ptr
:
:
null_mut
(
)
ptr
:
:
null_mut
(
)
0
0
0
0
ptr
:
:
null_mut
(
)
)
;
if
handle
=
=
handleapi
:
:
INVALID_HANDLE_VALUE
{
return
Err
(
io
:
:
Error
:
:
last_os_error
(
)
)
}
;
Ok
(
Transaction
{
handle
:
handle
}
)
}
}
pub
fn
commit
(
&
self
)
-
>
io
:
:
Result
<
(
)
>
{
unsafe
{
match
ktmw32
:
:
CommitTransaction
(
self
.
handle
)
{
0
=
>
Err
(
io
:
:
Error
:
:
last_os_error
(
)
)
_
=
>
Ok
(
(
)
)
}
}
}
pub
fn
rollback
(
&
self
)
-
>
io
:
:
Result
<
(
)
>
{
unsafe
{
match
ktmw32
:
:
RollbackTransaction
(
self
.
handle
)
{
0
=
>
Err
(
io
:
:
Error
:
:
last_os_error
(
)
)
_
=
>
Ok
(
(
)
)
}
}
}
fn
close_
(
&
mut
self
)
-
>
io
:
:
Result
<
(
)
>
{
unsafe
{
match
handleapi
:
:
CloseHandle
(
self
.
handle
)
{
0
=
>
Err
(
io
:
:
Error
:
:
last_os_error
(
)
)
_
=
>
Ok
(
(
)
)
}
}
}
}
impl
Drop
for
Transaction
{
fn
drop
(
&
mut
self
)
{
self
.
close_
(
)
.
unwrap_or
(
(
)
)
;
}
}
