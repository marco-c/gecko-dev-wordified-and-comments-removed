use
mls_platform_api
:
:
MessageOrAck
;
use
mls_platform_api
:
:
PlatformError
;
#
[
test
]
fn
test_group_join
(
)
-
>
Result
<
(
)
PlatformError
>
{
let
group_config
=
mls_platform_api
:
:
GroupConfig
:
:
default
(
)
;
let
mut
state_global
=
mls_platform_api
:
:
state_access
(
"
global
.
db
"
&
[
0u8
;
32
]
)
?
;
let
alice_cred
=
mls_platform_api
:
:
mls_generate_credential_basic
(
"
alice
"
.
as_bytes
(
)
)
?
;
let
bob_cred
=
mls_platform_api
:
:
mls_generate_credential_basic
(
"
bob
"
.
as_bytes
(
)
)
?
;
println
!
(
"
\
nAlice
credential
:
{
}
"
hex
:
:
encode
(
&
alice_cred
)
)
;
println
!
(
"
Bob
credential
:
{
}
"
hex
:
:
encode
(
&
bob_cred
)
)
;
let
alice_id
=
mls_platform_api
:
:
mls_generate_identity
(
&
state_global
group_config
.
ciphersuite
)
?
;
let
bob_id
=
mls_platform_api
:
:
mls_generate_identity
(
&
state_global
group_config
.
ciphersuite
)
?
;
println
!
(
"
\
nAlice
identifier
:
{
}
"
hex
:
:
encode
(
&
alice_id
)
)
;
println
!
(
"
Bob
identifier
:
{
}
"
hex
:
:
encode
(
&
bob_id
)
)
;
let
bob_kp
=
mls_platform_api
:
:
mls_generate_key_package
(
&
state_global
&
bob_id
&
bob_cred
&
Default
:
:
default
(
)
)
?
;
let
gide
=
mls_platform_api
:
:
mls_group_create
(
&
mut
state_global
&
alice_id
&
alice_cred
None
None
&
Default
:
:
default
(
)
)
?
;
println
!
(
"
\
nGroup
created
by
Alice
:
{
}
"
hex
:
:
encode
(
&
gide
.
group_id
)
)
;
let
members
=
mls_platform_api
:
:
mls_group_details
(
&
state_global
&
gide
.
group_id
&
alice_id
)
?
;
println
!
(
"
Members
(
alice
before
adding
bob
)
:
{
members
:
?
}
"
)
;
println
!
(
"
\
nAlice
adds
Bob
to
the
Group
"
)
;
let
commit_output
=
mls_platform_api
:
:
mls_group_add
(
&
mut
state_global
&
gide
.
group_id
&
alice_id
vec
!
[
bob_kp
]
)
?
;
let
welcome
=
commit_output
.
welcome
.
first
(
)
.
expect
(
"
No
welcome
messages
found
"
)
.
clone
(
)
;
println
!
(
"
\
nAlice
process
her
commit
to
add
Bob
to
the
Group
"
)
;
mls_platform_api
:
:
mls_receive
(
&
state_global
&
alice_id
&
MessageOrAck
:
:
MlsMessage
(
commit_output
.
commit
.
clone
(
)
)
)
?
;
let
members
=
mls_platform_api
:
:
mls_group_details
(
&
state_global
&
gide
.
group_id
&
alice_id
)
?
;
println
!
(
"
Members
(
alice
after
adding
bob
)
:
{
members
:
?
}
"
)
;
println
!
(
"
\
nBob
joins
the
group
created
by
Alice
"
)
;
let
gide_2
=
mls_platform_api
:
:
mls_group_join
(
&
state_global
&
bob_id
&
welcome
None
)
?
;
let
members_2
=
mls_platform_api
:
:
mls_group_details
(
&
state_global
&
gide
.
group_id
&
bob_id
)
?
;
println
!
(
"
Members
(
bob
after
joining
the
group
)
:
{
members_2
:
?
}
"
)
;
assert
!
(
gide
.
group_id
=
=
gide_2
.
group_id
)
;
assert
!
(
members
=
=
members_2
)
;
Ok
(
(
)
)
}
#
[
test
]
fn
test_group_join_multiple_adds
(
)
-
>
Result
<
(
)
PlatformError
>
{
let
group_config
=
mls_platform_api
:
:
GroupConfig
:
:
default
(
)
;
let
mut
state_global
=
mls_platform_api
:
:
state_access
(
"
global
.
db
"
&
[
0u8
;
32
]
)
?
;
let
alice_cred
=
mls_platform_api
:
:
mls_generate_credential_basic
(
"
alice
"
.
as_bytes
(
)
)
?
;
let
bob_cred
=
mls_platform_api
:
:
mls_generate_credential_basic
(
"
bob
"
.
as_bytes
(
)
)
?
;
let
charlie_cred
=
mls_platform_api
:
:
mls_generate_credential_basic
(
"
charlie
"
.
as_bytes
(
)
)
?
;
println
!
(
"
\
nAlice
credential
:
{
}
"
hex
:
:
encode
(
&
alice_cred
)
)
;
println
!
(
"
Bob
credential
:
{
}
"
hex
:
:
encode
(
&
bob_cred
)
)
;
println
!
(
"
Charlie
credential
:
{
}
"
hex
:
:
encode
(
&
charlie_cred
)
)
;
let
alice_id
=
mls_platform_api
:
:
mls_generate_identity
(
&
state_global
group_config
.
ciphersuite
)
?
;
let
bob_id
=
mls_platform_api
:
:
mls_generate_identity
(
&
state_global
group_config
.
ciphersuite
)
?
;
let
charlie_id
=
mls_platform_api
:
:
mls_generate_identity
(
&
state_global
group_config
.
ciphersuite
)
?
;
println
!
(
"
\
nAlice
identifier
:
{
}
"
hex
:
:
encode
(
&
alice_id
)
)
;
println
!
(
"
Bob
identifier
:
{
}
"
hex
:
:
encode
(
&
bob_id
)
)
;
println
!
(
"
Charlie
identifier
:
{
}
"
hex
:
:
encode
(
&
charlie_id
)
)
;
let
bob_kp
=
mls_platform_api
:
:
mls_generate_key_package
(
&
state_global
&
bob_id
&
bob_cred
&
Default
:
:
default
(
)
)
?
;
let
charlie_kp
=
mls_platform_api
:
:
mls_generate_key_package
(
&
state_global
&
charlie_id
&
charlie_cred
&
Default
:
:
default
(
)
)
?
;
let
gide
=
mls_platform_api
:
:
mls_group_create
(
&
mut
state_global
&
alice_id
&
alice_cred
None
None
&
Default
:
:
default
(
)
)
?
;
println
!
(
"
\
nGroup
created
by
Alice
:
{
}
"
hex
:
:
encode
(
&
gide
.
group_id
)
)
;
let
members
=
mls_platform_api
:
:
mls_group_details
(
&
state_global
&
gide
.
group_id
&
alice_id
)
?
;
println
!
(
"
Members
(
alice
before
adding
bob
and
charlie
)
:
{
members
:
?
}
"
)
;
println
!
(
"
\
nAlice
adds
Bob
and
Charlie
to
the
Group
"
)
;
let
commit_output
=
mls_platform_api
:
:
mls_group_add
(
&
mut
state_global
&
gide
.
group_id
&
alice_id
vec
!
[
bob_kp
charlie_kp
]
)
?
;
let
welcome
=
commit_output
.
welcome
.
first
(
)
.
expect
(
"
No
welcome
messages
found
"
)
.
clone
(
)
;
println
!
(
"
\
nAlice
process
her
commit
to
add
Bob
and
Charlie
to
the
Group
"
)
;
mls_platform_api
:
:
mls_receive
(
&
state_global
&
alice_id
&
MessageOrAck
:
:
MlsMessage
(
commit_output
.
commit
.
clone
(
)
)
)
?
;
let
members
=
mls_platform_api
:
:
mls_group_details
(
&
state_global
&
gide
.
group_id
&
alice_id
)
?
;
println
!
(
"
Members
(
alice
after
adding
bob
and
charlie
)
:
{
members
:
?
}
"
)
;
println
!
(
"
\
nBob
joins
the
group
created
by
Alice
"
)
;
let
gide_2
=
mls_platform_api
:
:
mls_group_join
(
&
state_global
&
bob_id
&
welcome
None
)
?
;
println
!
(
"
\
nCharlie
joins
the
group
created
by
Alice
"
)
;
let
gide_3
=
mls_platform_api
:
:
mls_group_join
(
&
state_global
&
charlie_id
&
welcome
None
)
?
;
let
members_2
=
mls_platform_api
:
:
mls_group_details
(
&
state_global
&
gide
.
group_id
&
bob_id
)
?
;
println
!
(
"
Members
(
bob
after
joining
the
group
)
:
{
members_2
:
?
}
"
)
;
let
members_3
=
mls_platform_api
:
:
mls_group_details
(
&
state_global
&
gide
.
group_id
&
charlie_id
)
?
;
println
!
(
"
Members
(
charlie
after
joining
the
group
)
:
{
members_3
:
?
}
"
)
;
assert
!
(
gide
.
group_id
=
=
gide_2
.
group_id
)
;
assert
!
(
gide
.
group_id
=
=
gide_3
.
group_id
)
;
assert
!
(
members
=
=
members_2
)
;
assert
!
(
members
=
=
members_3
)
;
Ok
(
(
)
)
}
