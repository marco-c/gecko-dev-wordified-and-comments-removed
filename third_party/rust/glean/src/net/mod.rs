use
std
:
:
sync
:
:
{
atomic
:
:
{
AtomicBool
Ordering
}
Arc
}
;
use
std
:
:
thread
;
use
std
:
:
time
:
:
Duration
;
use
glean_core
:
:
upload
:
:
PingUploadTask
;
pub
use
glean_core
:
:
upload
:
:
{
PingRequest
UploadResult
UploadTaskAction
}
;
pub
use
http_uploader
:
:
*
;
mod
http_uploader
;
pub
trait
PingUploader
:
std
:
:
fmt
:
:
Debug
+
Send
+
Sync
{
fn
upload
(
&
self
url
:
String
body
:
Vec
<
u8
>
headers
:
Vec
<
(
String
String
)
>
)
-
>
UploadResult
;
}
#
[
derive
(
Debug
)
]
pub
(
crate
)
struct
UploadManager
{
inner
:
Arc
<
Inner
>
}
#
[
derive
(
Debug
)
]
struct
Inner
{
server_endpoint
:
String
uploader
:
Box
<
dyn
PingUploader
+
'
static
>
thread_running
:
AtomicBool
}
impl
UploadManager
{
pub
(
crate
)
fn
new
(
server_endpoint
:
String
new_uploader
:
Box
<
dyn
PingUploader
+
'
static
>
)
-
>
Self
{
Self
{
inner
:
Arc
:
:
new
(
Inner
{
server_endpoint
uploader
:
new_uploader
thread_running
:
AtomicBool
:
:
new
(
false
)
}
)
}
}
pub
(
crate
)
fn
trigger_upload
(
&
self
)
{
if
self
.
inner
.
thread_running
.
compare_exchange
(
false
true
Ordering
:
:
SeqCst
Ordering
:
:
SeqCst
)
.
is_err
(
)
{
return
;
}
let
inner
=
Arc
:
:
clone
(
&
self
.
inner
)
;
thread
:
:
Builder
:
:
new
(
)
.
name
(
"
glean
.
upload
"
.
into
(
)
)
.
spawn
(
move
|
|
{
log
:
:
trace
!
(
"
Started
glean
.
upload
thread
"
)
;
loop
{
let
incoming_task
=
glean_core
:
:
glean_get_upload_task
(
)
;
match
incoming_task
{
PingUploadTask
:
:
Upload
{
request
}
=
>
{
log
:
:
trace
!
(
"
Received
upload
task
with
request
{
:
?
}
"
request
)
;
let
doc_id
=
request
.
document_id
.
clone
(
)
;
let
upload_url
=
format
!
(
"
{
}
{
}
"
inner
.
server_endpoint
request
.
path
)
;
let
headers
:
Vec
<
(
String
String
)
>
=
request
.
headers
.
into_iter
(
)
.
collect
(
)
;
let
result
=
inner
.
uploader
.
upload
(
upload_url
request
.
body
headers
)
;
match
glean_core
:
:
glean_process_ping_upload_response
(
doc_id
result
)
{
UploadTaskAction
:
:
Next
=
>
continue
UploadTaskAction
:
:
End
=
>
break
}
}
PingUploadTask
:
:
Wait
{
time
}
=
>
{
log
:
:
trace
!
(
"
Instructed
to
wait
for
{
:
?
}
ms
"
time
)
;
thread
:
:
sleep
(
Duration
:
:
from_millis
(
time
)
)
;
}
PingUploadTask
:
:
Done
{
.
.
}
=
>
{
log
:
:
trace
!
(
"
Received
PingUploadTask
:
:
Done
.
Exiting
.
"
)
;
break
;
}
}
}
inner
.
thread_running
.
store
(
false
Ordering
:
:
SeqCst
)
;
}
)
.
expect
(
"
Failed
to
spawn
Glean
'
s
uploader
thread
"
)
;
}
}
