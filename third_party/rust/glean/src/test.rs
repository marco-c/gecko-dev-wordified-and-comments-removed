use
crate
:
:
private
:
:
{
BooleanMetric
CounterMetric
}
;
use
once_cell
:
:
sync
:
:
Lazy
;
use
std
:
:
path
:
:
PathBuf
;
use
std
:
:
sync
:
:
Mutex
;
use
super
:
:
*
;
static
GLOBAL_LOCK
:
Lazy
<
Mutex
<
(
)
>
>
=
Lazy
:
:
new
(
|
|
Mutex
:
:
new
(
(
)
)
)
;
const
GLOBAL_APPLICATION_ID
:
&
str
=
"
org
.
mozilla
.
rlb
.
test
"
;
fn
new_glean
(
configuration
:
Option
<
Configuration
>
clear_stores
:
bool
)
-
>
tempfile
:
:
TempDir
{
let
dir
=
tempfile
:
:
tempdir
(
)
.
unwrap
(
)
;
let
tmpname
=
dir
.
path
(
)
.
display
(
)
.
to_string
(
)
;
let
cfg
=
match
configuration
{
Some
(
c
)
=
>
c
None
=
>
Configuration
{
data_path
:
tmpname
application_id
:
GLOBAL_APPLICATION_ID
.
into
(
)
upload_enabled
:
true
max_events
:
None
delay_ping_lifetime_io
:
false
channel
:
Some
(
"
testing
"
.
into
(
)
)
server_endpoint
:
Some
(
"
invalid
-
test
-
host
"
.
into
(
)
)
uploader
:
None
}
}
;
crate
:
:
reset_glean
(
cfg
ClientInfoMetrics
:
:
unknown
(
)
clear_stores
)
;
dir
}
#
[
test
]
fn
send_a_ping
(
)
{
let
_lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
let
(
s
r
)
=
crossbeam_channel
:
:
bounded
:
:
<
String
>
(
1
)
;
#
[
derive
(
Debug
)
]
pub
struct
FakeUploader
{
sender
:
crossbeam_channel
:
:
Sender
<
String
>
}
;
impl
net
:
:
PingUploader
for
FakeUploader
{
fn
upload
(
&
self
url
:
String
_body
:
Vec
<
u8
>
_headers
:
Vec
<
(
String
String
)
>
)
-
>
net
:
:
UploadResult
{
self
.
sender
.
send
(
url
)
.
unwrap
(
)
;
net
:
:
UploadResult
:
:
HttpStatus
(
200
)
}
}
let
dir
=
tempfile
:
:
tempdir
(
)
.
unwrap
(
)
;
let
tmpname
=
dir
.
path
(
)
.
display
(
)
.
to_string
(
)
;
let
cfg
=
Configuration
{
data_path
:
tmpname
application_id
:
GLOBAL_APPLICATION_ID
.
into
(
)
upload_enabled
:
true
max_events
:
None
delay_ping_lifetime_io
:
false
channel
:
Some
(
"
testing
"
.
into
(
)
)
server_endpoint
:
Some
(
"
invalid
-
test
-
host
"
.
into
(
)
)
uploader
:
Some
(
Box
:
:
new
(
FakeUploader
{
sender
:
s
}
)
)
}
;
let
_t
=
new_glean
(
Some
(
cfg
)
true
)
;
crate
:
:
dispatcher
:
:
block_on_queue
(
)
;
const
PING_NAME
:
&
str
=
"
test
-
ping
"
;
let
custom_ping
=
private
:
:
PingType
:
:
new
(
PING_NAME
true
true
vec
!
[
]
)
;
custom_ping
.
submit
(
None
)
;
let
url
=
r
.
recv
(
)
.
unwrap
(
)
;
assert_eq
!
(
url
.
contains
(
PING_NAME
)
true
)
;
}
#
[
test
]
fn
disabling_upload_disables_metrics_recording
(
)
{
let
_lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
let
_t
=
new_glean
(
None
true
)
;
crate
:
:
dispatcher
:
:
block_on_queue
(
)
;
let
metric
=
BooleanMetric
:
:
new
(
CommonMetricData
{
name
:
"
bool_metric
"
.
into
(
)
category
:
"
test
"
.
into
(
)
send_in_pings
:
vec
!
[
"
store1
"
.
into
(
)
]
lifetime
:
Lifetime
:
:
Application
disabled
:
false
dynamic_label
:
None
}
)
;
crate
:
:
set_upload_enabled
(
false
)
;
assert
!
(
metric
.
test_get_value
(
"
store1
"
)
.
is_none
(
)
)
}
#
[
test
]
fn
test_experiments_recording
(
)
{
let
_lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
let
_t
=
new_glean
(
None
true
)
;
set_experiment_active
(
"
experiment_test
"
.
to_string
(
)
"
branch_a
"
.
to_string
(
)
None
)
;
let
mut
extra
=
HashMap
:
:
new
(
)
;
extra
.
insert
(
"
test_key
"
.
to_string
(
)
"
value
"
.
to_string
(
)
)
;
set_experiment_active
(
"
experiment_api
"
.
to_string
(
)
"
branch_b
"
.
to_string
(
)
Some
(
extra
)
)
;
assert
!
(
test_is_experiment_active
(
"
experiment_test
"
.
to_string
(
)
)
)
;
assert
!
(
test_is_experiment_active
(
"
experiment_api
"
.
to_string
(
)
)
)
;
set_experiment_inactive
(
"
experiment_test
"
.
to_string
(
)
)
;
assert
!
(
!
test_is_experiment_active
(
"
experiment_test
"
.
to_string
(
)
)
)
;
assert
!
(
test_is_experiment_active
(
"
experiment_api
"
.
to_string
(
)
)
)
;
let
stored_data
=
test_get_experiment_data
(
"
experiment_api
"
.
to_string
(
)
)
;
assert_eq
!
(
"
branch_b
"
stored_data
.
branch
)
;
assert_eq
!
(
"
value
"
stored_data
.
extra
.
unwrap
(
)
[
"
test_key
"
]
)
;
}
#
[
test
]
fn
test_experiments_recording_before_glean_inits
(
)
{
let
_lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
if
was_initialize_called
(
)
{
if
global_glean
(
)
.
is_some
(
)
{
with_glean_mut
(
|
glean
|
{
glean
.
test_clear_all_stores
(
)
;
glean
.
destroy_db
(
)
;
}
)
;
}
INITIALIZE_CALLED
.
store
(
false
Ordering
:
:
SeqCst
)
;
dispatcher
:
:
reset_dispatcher
(
)
;
}
set_experiment_active
(
"
experiment_set_preinit
"
.
to_string
(
)
"
branch_a
"
.
to_string
(
)
None
)
;
set_experiment_active
(
"
experiment_preinit_disabled
"
.
to_string
(
)
"
branch_a
"
.
to_string
(
)
None
)
;
set_experiment_inactive
(
"
experiment_preinit_disabled
"
.
to_string
(
)
)
;
let
dir
=
tempfile
:
:
tempdir
(
)
.
unwrap
(
)
;
let
tmpname
=
dir
.
path
(
)
.
display
(
)
.
to_string
(
)
;
reset_glean
(
Configuration
{
data_path
:
tmpname
application_id
:
GLOBAL_APPLICATION_ID
.
into
(
)
upload_enabled
:
true
max_events
:
None
delay_ping_lifetime_io
:
false
channel
:
Some
(
"
testing
"
.
into
(
)
)
server_endpoint
:
Some
(
"
invalid
-
test
-
host
"
.
into
(
)
)
uploader
:
None
}
ClientInfoMetrics
:
:
unknown
(
)
false
)
;
crate
:
:
dispatcher
:
:
block_on_queue
(
)
;
assert
!
(
test_is_experiment_active
(
"
experiment_set_preinit
"
.
to_string
(
)
)
)
;
assert
!
(
!
test_is_experiment_active
(
"
experiment_preinit_disabled
"
.
to_string
(
)
)
)
;
}
#
[
test
]
#
[
ignore
]
fn
test_sending_of_foreground_background_pings
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
test_sending_of_startup_baseline_ping
(
)
{
todo
!
(
)
}
#
[
test
]
fn
initialize_must_not_crash_if_data_dir_is_messed_up
(
)
{
let
_lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
let
dir
=
tempfile
:
:
tempdir
(
)
.
unwrap
(
)
;
let
tmpdirname
=
dir
.
path
(
)
.
display
(
)
.
to_string
(
)
;
let
file_path
=
PathBuf
:
:
from
(
tmpdirname
)
.
join
(
"
notadir
"
)
;
std
:
:
fs
:
:
write
(
file_path
.
clone
(
)
"
test
"
)
.
expect
(
"
The
test
Glean
dir
file
must
be
created
"
)
;
let
cfg
=
Configuration
{
data_path
:
file_path
.
to_string_lossy
(
)
.
to_string
(
)
application_id
:
GLOBAL_APPLICATION_ID
.
into
(
)
upload_enabled
:
true
max_events
:
None
delay_ping_lifetime_io
:
false
channel
:
Some
(
"
testing
"
.
into
(
)
)
server_endpoint
:
Some
(
"
invalid
-
test
-
host
"
.
into
(
)
)
uploader
:
None
}
;
reset_glean
(
cfg
ClientInfoMetrics
:
:
unknown
(
)
false
)
;
std
:
:
thread
:
:
sleep
(
std
:
:
time
:
:
Duration
:
:
from_secs
(
3
)
)
;
}
#
[
test
]
fn
queued_recorded_metrics_correctly_record_during_init
(
)
{
let
_lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
destroy_glean
(
true
)
;
let
metric
=
CounterMetric
:
:
new
(
CommonMetricData
{
name
:
"
counter_metric
"
.
into
(
)
category
:
"
test
"
.
into
(
)
send_in_pings
:
vec
!
[
"
store1
"
.
into
(
)
]
lifetime
:
Lifetime
:
:
Application
disabled
:
false
dynamic_label
:
None
}
)
;
for
_
in
0
.
.
3
{
metric
.
add
(
1
)
;
}
let
_
=
new_glean
(
None
false
)
;
assert
!
(
metric
.
test_get_value
(
None
)
.
is_some
(
)
"
Value
must
exist
"
)
;
assert_eq
!
(
3
metric
.
test_get_value
(
None
)
.
unwrap
(
)
"
Value
must
match
"
)
;
}
#
[
test
]
fn
initializing_twice_is_a_noop
(
)
{
let
_lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
let
dir
=
tempfile
:
:
tempdir
(
)
.
unwrap
(
)
;
let
tmpname
=
dir
.
path
(
)
.
display
(
)
.
to_string
(
)
;
reset_glean
(
Configuration
{
data_path
:
tmpname
.
clone
(
)
application_id
:
GLOBAL_APPLICATION_ID
.
into
(
)
upload_enabled
:
true
max_events
:
None
delay_ping_lifetime_io
:
false
channel
:
Some
(
"
testing
"
.
into
(
)
)
server_endpoint
:
Some
(
"
invalid
-
test
-
host
"
.
into
(
)
)
uploader
:
None
}
ClientInfoMetrics
:
:
unknown
(
)
true
)
;
dispatcher
:
:
block_on_queue
(
)
;
reset_glean
(
Configuration
{
data_path
:
tmpname
application_id
:
GLOBAL_APPLICATION_ID
.
into
(
)
upload_enabled
:
true
max_events
:
None
delay_ping_lifetime_io
:
false
channel
:
Some
(
"
testing
"
.
into
(
)
)
server_endpoint
:
Some
(
"
invalid
-
test
-
host
"
.
into
(
)
)
uploader
:
None
}
ClientInfoMetrics
:
:
unknown
(
)
false
)
;
std
:
:
thread
:
:
sleep
(
std
:
:
time
:
:
Duration
:
:
from_secs
(
3
)
)
;
}
#
[
test
]
#
[
ignore
]
fn
dont_handle_events_when_uninitialized
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
the_app_channel_must_be_correctly_set_if_requested
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
ping_collection_must_happen_after_concurrently_scheduled_metrics_recordings
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
basic_metrics_should_be_cleared_when_disabling_uploading
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
core_metrics_should_be_cleared_and_restored_when_disabling_and_enabling_uploading
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
overflowing_the_task_queue_records_telemetry
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
sending_deletion_ping_if_disabled_outside_of_run
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
no_sending_of_deletion_ping_if_unchanged_outside_of_run
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
test_sending_of_startup_baseline_ping_with_application_lifetime_metric
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
test_dirty_flag_is_reset_to_false
(
)
{
todo
!
(
)
}
#
[
test
]
#
[
ignore
]
fn
flipping_upload_enabled_respects_order_of_events
(
)
{
todo
!
(
)
}
