use
crate
:
:
ClientInfoMetrics
;
use
crate
:
:
Configuration
;
use
std
:
:
sync
:
:
{
Mutex
MutexGuard
}
;
use
once_cell
:
:
sync
:
:
Lazy
;
pub
(
crate
)
const
GLOBAL_APPLICATION_ID
:
&
str
=
"
org
.
mozilla
.
rlb
.
test
"
;
pub
(
crate
)
fn
lock_test
(
)
-
>
MutexGuard
<
'
static
(
)
>
{
static
GLOBAL_LOCK
:
Lazy
<
Mutex
<
(
)
>
>
=
Lazy
:
:
new
(
|
|
Mutex
:
:
new
(
(
)
)
)
;
env_logger
:
:
try_init
(
)
.
ok
(
)
;
let
lock
=
GLOBAL_LOCK
.
lock
(
)
.
unwrap
(
)
;
lock
}
pub
(
crate
)
fn
new_glean
(
configuration
:
Option
<
Configuration
>
clear_stores
:
bool
)
-
>
tempfile
:
:
TempDir
{
let
dir
=
tempfile
:
:
tempdir
(
)
.
unwrap
(
)
;
let
tmpname
=
dir
.
path
(
)
.
display
(
)
.
to_string
(
)
;
let
cfg
=
match
configuration
{
Some
(
c
)
=
>
c
None
=
>
Configuration
{
data_path
:
tmpname
application_id
:
GLOBAL_APPLICATION_ID
.
into
(
)
upload_enabled
:
true
max_events
:
None
delay_ping_lifetime_io
:
false
channel
:
Some
(
"
testing
"
.
into
(
)
)
server_endpoint
:
Some
(
"
invalid
-
test
-
host
"
.
into
(
)
)
uploader
:
None
}
}
;
crate
:
:
test_reset_glean
(
cfg
ClientInfoMetrics
:
:
unknown
(
)
clear_stores
)
;
dir
}
