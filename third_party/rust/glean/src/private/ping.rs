use
std
:
:
sync
:
:
{
Arc
Mutex
}
;
type
BoxedCallback
=
Box
<
dyn
FnOnce
(
Option
<
&
str
>
)
+
Send
+
'
static
>
;
#
[
derive
(
Clone
)
]
pub
struct
PingType
{
pub
(
crate
)
inner
:
glean_core
:
:
metrics
:
:
PingType
test_callback
:
Arc
<
Mutex
<
Option
<
BoxedCallback
>
>
>
}
impl
PingType
{
pub
fn
new
<
A
:
Into
<
String
>
>
(
name
:
A
include_client_id
:
bool
send_if_empty
:
bool
precise_timestamps
:
bool
reason_codes
:
Vec
<
String
>
)
-
>
Self
{
let
inner
=
glean_core
:
:
metrics
:
:
PingType
:
:
new
(
name
.
into
(
)
include_client_id
send_if_empty
precise_timestamps
reason_codes
)
;
Self
{
inner
test_callback
:
Arc
:
:
new
(
Default
:
:
default
(
)
)
}
}
pub
fn
submit
(
&
self
reason
:
Option
<
&
str
>
)
{
let
mut
cb
=
self
.
test_callback
.
lock
(
)
.
unwrap
(
)
;
let
cb
=
cb
.
take
(
)
;
if
let
Some
(
cb
)
=
cb
{
cb
(
reason
)
}
self
.
inner
.
submit
(
reason
.
map
(
|
s
|
s
.
to_string
(
)
)
)
}
pub
fn
test_before_next_submit
(
&
self
cb
:
impl
FnOnce
(
Option
<
&
str
>
)
+
Send
+
'
static
)
{
let
mut
test_callback
=
self
.
test_callback
.
lock
(
)
.
unwrap
(
)
;
let
cb
=
Box
:
:
new
(
cb
)
;
*
test_callback
=
Some
(
cb
)
;
}
}
