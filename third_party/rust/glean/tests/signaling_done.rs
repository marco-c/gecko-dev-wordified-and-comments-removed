mod
common
;
use
std
:
:
collections
:
:
HashMap
;
use
std
:
:
sync
:
:
Arc
;
use
std
:
:
sync
:
:
Barrier
;
use
std
:
:
sync
:
:
Mutex
;
use
std
:
:
thread
;
use
std
:
:
thread
:
:
ThreadId
;
use
glean
:
:
net
;
use
glean
:
:
ConfigurationBuilder
;
mod
pings
{
use
super
:
:
*
;
use
glean
:
:
private
:
:
PingType
;
use
once_cell
:
:
sync
:
:
Lazy
;
#
[
allow
(
non_upper_case_globals
)
]
pub
static
custom_ping
:
Lazy
<
PingType
>
=
Lazy
:
:
new
(
|
|
{
common
:
:
PingBuilder
:
:
new
(
"
test
-
ping
"
)
.
with_send_if_empty
(
true
)
.
build
(
)
}
)
;
}
#
[
derive
(
Debug
)
]
pub
struct
FakeUploader
{
barrier
:
Arc
<
Barrier
>
counter
:
Arc
<
Mutex
<
HashMap
<
ThreadId
u32
>
>
>
}
impl
net
:
:
PingUploader
for
FakeUploader
{
fn
upload
(
&
self
_upload_request
:
net
:
:
CapablePingUploadRequest
)
-
>
net
:
:
UploadResult
{
let
mut
map
=
self
.
counter
.
lock
(
)
.
unwrap
(
)
;
*
map
.
entry
(
thread
:
:
current
(
)
.
id
(
)
)
.
or_insert
(
0
)
+
=
1
;
self
.
barrier
.
wait
(
)
;
net
:
:
UploadResult
:
:
done
(
)
}
}
#
[
test
]
fn
signaling_done
(
)
{
common
:
:
enable_test_logging
(
)
;
let
dir
=
tempfile
:
:
tempdir
(
)
.
unwrap
(
)
;
let
tmpname
=
dir
.
path
(
)
.
to_path_buf
(
)
;
let
barrier
=
Arc
:
:
new
(
Barrier
:
:
new
(
2
)
)
;
let
call_count
=
Arc
:
:
new
(
Mutex
:
:
default
(
)
)
;
let
cfg
=
ConfigurationBuilder
:
:
new
(
true
tmpname
"
glean
-
signaling
-
done
"
)
.
with_server_endpoint
(
"
invalid
-
test
-
host
"
)
.
with_uploader
(
FakeUploader
{
barrier
:
Arc
:
:
clone
(
&
barrier
)
counter
:
Arc
:
:
clone
(
&
call_count
)
}
)
.
with_internal_pings
(
false
)
.
build
(
)
;
common
:
:
initialize
(
cfg
)
;
pings
:
:
custom_ping
.
submit
(
None
)
;
pings
:
:
custom_ping
.
submit
(
None
)
;
barrier
.
wait
(
)
;
std
:
:
thread
:
:
yield_now
(
)
;
std
:
:
thread
:
:
sleep
(
std
:
:
time
:
:
Duration
:
:
from_millis
(
100
)
)
;
pings
:
:
custom_ping
.
submit
(
None
)
;
barrier
.
wait
(
)
;
std
:
:
thread
:
:
sleep
(
std
:
:
time
:
:
Duration
:
:
from_millis
(
100
)
)
;
let
map
=
call_count
.
lock
(
)
.
unwrap
(
)
;
assert_eq
!
(
2
map
.
len
(
)
"
should
have
launched
2
uploader
threads
"
)
;
for
&
count
in
map
.
values
(
)
{
assert_eq
!
(
1
count
"
each
thread
should
call
upload
only
once
"
)
;
}
}
