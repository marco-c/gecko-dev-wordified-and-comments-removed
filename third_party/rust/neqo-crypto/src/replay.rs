use
crate
:
:
err
:
:
{
Error
Res
}
;
use
crate
:
:
ssl
:
:
PRFileDesc
;
use
crate
:
:
time
:
:
{
Interval
PRTime
Time
}
;
use
std
:
:
convert
:
:
{
TryFrom
TryInto
}
;
use
std
:
:
ops
:
:
{
Deref
DerefMut
}
;
use
std
:
:
os
:
:
raw
:
:
c_uint
;
use
std
:
:
ptr
:
:
{
null_mut
NonNull
}
;
use
std
:
:
time
:
:
{
Duration
Instant
}
;
#
[
allow
(
clippy
:
:
empty_enum
)
]
pub
enum
SSLAntiReplayContext
{
}
experimental_api
!
(
SSL_CreateAntiReplayContext
(
now
:
PRTime
window
:
PRTime
k
:
c_uint
bits
:
c_uint
ctx
:
*
mut
*
mut
SSLAntiReplayContext
)
)
;
experimental_api
!
(
SSL_ReleaseAntiReplayContext
(
ctx
:
*
mut
SSLAntiReplayContext
)
)
;
experimental_api
!
(
SSL_SetAntiReplayContext
(
fd
:
*
mut
PRFileDesc
ctx
:
*
mut
SSLAntiReplayContext
)
)
;
scoped_ptr
!
(
AntiReplayContext
SSLAntiReplayContext
SSL_ReleaseAntiReplayContext
)
;
#
[
allow
(
clippy
:
:
module_name_repetitions
)
]
pub
struct
AntiReplay
{
ctx
:
AntiReplayContext
}
impl
AntiReplay
{
pub
fn
new
(
now
:
Instant
window
:
Duration
k
:
usize
bits
:
usize
)
-
>
Res
<
Self
>
{
let
mut
ctx
:
*
mut
SSLAntiReplayContext
=
null_mut
(
)
;
unsafe
{
SSL_CreateAntiReplayContext
(
Time
:
:
from
(
now
)
.
try_into
(
)
?
Interval
:
:
from
(
window
)
.
try_into
(
)
?
c_uint
:
:
try_from
(
k
)
?
c_uint
:
:
try_from
(
bits
)
?
&
mut
ctx
)
}
?
;
match
NonNull
:
:
new
(
ctx
)
{
Some
(
ctx_nn
)
=
>
Ok
(
Self
{
ctx
:
AntiReplayContext
:
:
new
(
ctx_nn
)
}
)
None
=
>
Err
(
Error
:
:
InternalError
)
}
}
pub
(
crate
)
fn
config_socket
(
&
self
fd
:
*
mut
PRFileDesc
)
-
>
Res
<
(
)
>
{
unsafe
{
SSL_SetAntiReplayContext
(
fd
*
self
.
ctx
)
}
}
}
