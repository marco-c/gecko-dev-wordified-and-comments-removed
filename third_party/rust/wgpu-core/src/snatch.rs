#
!
[
allow
(
unused
)
]
use
parking_lot
:
:
{
RwLock
RwLockReadGuard
RwLockWriteGuard
}
;
use
std
:
:
cell
:
:
UnsafeCell
;
pub
struct
SnatchGuard
<
'
a
>
(
RwLockReadGuard
<
'
a
(
)
>
)
;
pub
struct
ExclusiveSnatchGuard
<
'
a
>
(
RwLockWriteGuard
<
'
a
(
)
>
)
;
pub
struct
Snatchable
<
T
>
{
value
:
UnsafeCell
<
Option
<
T
>
>
}
impl
<
T
>
Snatchable
<
T
>
{
pub
fn
new
(
val
:
T
)
-
>
Self
{
Snatchable
{
value
:
UnsafeCell
:
:
new
(
Some
(
val
)
)
}
}
pub
fn
get
(
&
self
_guard
:
&
SnatchGuard
)
-
>
Option
<
&
T
>
{
unsafe
{
(
*
self
.
value
.
get
(
)
)
.
as_ref
(
)
}
}
pub
fn
get_mut
(
&
self
_guard
:
&
mut
ExclusiveSnatchGuard
)
-
>
Option
<
&
mut
T
>
{
unsafe
{
(
*
self
.
value
.
get
(
)
)
.
as_mut
(
)
}
}
pub
fn
snatch
(
&
self
_guard
:
ExclusiveSnatchGuard
)
-
>
Option
<
T
>
{
unsafe
{
(
*
self
.
value
.
get
(
)
)
.
take
(
)
}
}
pub
fn
take
(
&
mut
self
)
-
>
Option
<
T
>
{
self
.
value
.
get_mut
(
)
.
take
(
)
}
}
impl
<
T
>
std
:
:
fmt
:
:
Debug
for
Snatchable
<
T
>
{
fn
fmt
(
&
self
f
:
&
mut
std
:
:
fmt
:
:
Formatter
)
-
>
std
:
:
fmt
:
:
Result
{
write
!
(
f
"
<
snatchable
>
"
)
}
}
unsafe
impl
<
T
>
Sync
for
Snatchable
<
T
>
{
}
pub
struct
SnatchLock
{
lock
:
RwLock
<
(
)
>
}
impl
SnatchLock
{
pub
unsafe
fn
new
(
)
-
>
Self
{
SnatchLock
{
lock
:
RwLock
:
:
new
(
(
)
)
}
}
pub
fn
read
(
&
self
)
-
>
SnatchGuard
{
SnatchGuard
(
self
.
lock
.
read
(
)
)
}
pub
fn
write
(
&
self
)
-
>
ExclusiveSnatchGuard
{
ExclusiveSnatchGuard
(
self
.
lock
.
write
(
)
)
}
}
