use
crate
:
:
limits
:
:
MAX_WASM_CANONICAL_OPTIONS
;
use
crate
:
:
prelude
:
:
*
;
use
crate
:
:
{
BinaryReader
BinaryReaderError
ComponentValType
FromReader
Result
SectionLimited
}
;
#
[
derive
(
Debug
Clone
Copy
PartialEq
Eq
)
]
pub
enum
CanonicalOption
{
UTF8
UTF16
CompactUTF16
Memory
(
u32
)
Realloc
(
u32
)
PostReturn
(
u32
)
Async
Callback
(
u32
)
}
#
[
derive
(
Debug
Clone
Eq
PartialEq
)
]
pub
enum
CanonicalFunction
{
Lift
{
core_func_index
:
u32
type_index
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
Lower
{
func_index
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
ResourceNew
{
resource
:
u32
}
ResourceDrop
{
resource
:
u32
}
ResourceRep
{
resource
:
u32
}
ThreadSpawn
{
func_ty_index
:
u32
}
ThreadHwConcurrency
TaskBackpressure
TaskReturn
{
result
:
Option
<
ComponentValType
>
}
TaskWait
{
async_
:
bool
memory
:
u32
}
TaskPoll
{
async_
:
bool
memory
:
u32
}
TaskYield
{
async_
:
bool
}
SubtaskDrop
StreamNew
{
ty
:
u32
}
StreamRead
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
StreamWrite
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
StreamCancelRead
{
ty
:
u32
async_
:
bool
}
StreamCancelWrite
{
ty
:
u32
async_
:
bool
}
StreamCloseReadable
{
ty
:
u32
}
StreamCloseWritable
{
ty
:
u32
}
FutureNew
{
ty
:
u32
}
FutureRead
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
FutureWrite
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
FutureCancelRead
{
ty
:
u32
async_
:
bool
}
FutureCancelWrite
{
ty
:
u32
async_
:
bool
}
FutureCloseReadable
{
ty
:
u32
}
FutureCloseWritable
{
ty
:
u32
}
ErrorContextNew
{
options
:
Box
<
[
CanonicalOption
]
>
}
ErrorContextDebugMessage
{
options
:
Box
<
[
CanonicalOption
]
>
}
ErrorContextDrop
}
pub
type
ComponentCanonicalSectionReader
<
'
a
>
=
SectionLimited
<
'
a
CanonicalFunction
>
;
impl
<
'
a
>
FromReader
<
'
a
>
for
CanonicalFunction
{
fn
from_reader
(
reader
:
&
mut
BinaryReader
<
'
a
>
)
-
>
Result
<
CanonicalFunction
>
{
Ok
(
match
reader
.
read_u8
(
)
?
{
0x00
=
>
match
reader
.
read_u8
(
)
?
{
0x00
=
>
{
let
core_func_index
=
reader
.
read_var_u32
(
)
?
;
let
options
=
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
;
let
type_index
=
reader
.
read_var_u32
(
)
?
;
CanonicalFunction
:
:
Lift
{
core_func_index
options
type_index
}
}
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
function
lift
"
)
}
0x01
=
>
match
reader
.
read_u8
(
)
?
{
0x00
=
>
CanonicalFunction
:
:
Lower
{
func_index
:
reader
.
read_var_u32
(
)
?
options
:
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
}
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
function
lower
"
)
}
0x02
=
>
CanonicalFunction
:
:
ResourceNew
{
resource
:
reader
.
read
(
)
?
}
0x03
=
>
CanonicalFunction
:
:
ResourceDrop
{
resource
:
reader
.
read
(
)
?
}
0x04
=
>
CanonicalFunction
:
:
ResourceRep
{
resource
:
reader
.
read
(
)
?
}
0x05
=
>
CanonicalFunction
:
:
ThreadSpawn
{
func_ty_index
:
reader
.
read
(
)
?
}
0x06
=
>
CanonicalFunction
:
:
ThreadHwConcurrency
0x08
=
>
CanonicalFunction
:
:
TaskBackpressure
0x09
=
>
CanonicalFunction
:
:
TaskReturn
{
result
:
match
reader
.
read_u8
(
)
?
{
0x00
=
>
Some
(
reader
.
read
(
)
?
)
0x01
=
>
{
if
reader
.
read_u8
(
)
?
=
=
0
{
None
}
else
{
return
Err
(
BinaryReaderError
:
:
new
(
"
named
results
not
allowed
for
task
.
return
intrinsic
"
reader
.
original_position
(
)
-
2
)
)
;
}
}
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
task
.
return
result
"
)
}
}
0x0a
=
>
CanonicalFunction
:
:
TaskWait
{
async_
:
reader
.
read
(
)
?
memory
:
reader
.
read
(
)
?
}
0x0b
=
>
CanonicalFunction
:
:
TaskPoll
{
async_
:
reader
.
read
(
)
?
memory
:
reader
.
read
(
)
?
}
0x0c
=
>
CanonicalFunction
:
:
TaskYield
{
async_
:
reader
.
read
(
)
?
}
0x0d
=
>
CanonicalFunction
:
:
SubtaskDrop
0x0e
=
>
CanonicalFunction
:
:
StreamNew
{
ty
:
reader
.
read
(
)
?
}
0x0f
=
>
CanonicalFunction
:
:
StreamRead
{
ty
:
reader
.
read
(
)
?
options
:
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
}
0x10
=
>
CanonicalFunction
:
:
StreamWrite
{
ty
:
reader
.
read
(
)
?
options
:
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
}
0x11
=
>
CanonicalFunction
:
:
StreamCancelRead
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x12
=
>
CanonicalFunction
:
:
StreamCancelWrite
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x13
=
>
CanonicalFunction
:
:
StreamCloseReadable
{
ty
:
reader
.
read
(
)
?
}
0x14
=
>
CanonicalFunction
:
:
StreamCloseWritable
{
ty
:
reader
.
read
(
)
?
}
0x15
=
>
CanonicalFunction
:
:
FutureNew
{
ty
:
reader
.
read
(
)
?
}
0x16
=
>
CanonicalFunction
:
:
FutureRead
{
ty
:
reader
.
read
(
)
?
options
:
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
}
0x17
=
>
CanonicalFunction
:
:
FutureWrite
{
ty
:
reader
.
read
(
)
?
options
:
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
}
0x18
=
>
CanonicalFunction
:
:
FutureCancelRead
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x19
=
>
CanonicalFunction
:
:
FutureCancelWrite
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x1a
=
>
CanonicalFunction
:
:
FutureCloseReadable
{
ty
:
reader
.
read
(
)
?
}
0x1b
=
>
CanonicalFunction
:
:
FutureCloseWritable
{
ty
:
reader
.
read
(
)
?
}
0x1c
=
>
CanonicalFunction
:
:
ErrorContextNew
{
options
:
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
}
0x1d
=
>
CanonicalFunction
:
:
ErrorContextDebugMessage
{
options
:
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
?
}
0x1e
=
>
CanonicalFunction
:
:
ErrorContextDrop
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
function
"
)
}
)
}
}
impl
<
'
a
>
FromReader
<
'
a
>
for
CanonicalOption
{
fn
from_reader
(
reader
:
&
mut
BinaryReader
<
'
a
>
)
-
>
Result
<
Self
>
{
Ok
(
match
reader
.
read_u8
(
)
?
{
0x00
=
>
CanonicalOption
:
:
UTF8
0x01
=
>
CanonicalOption
:
:
UTF16
0x02
=
>
CanonicalOption
:
:
CompactUTF16
0x03
=
>
CanonicalOption
:
:
Memory
(
reader
.
read_var_u32
(
)
?
)
0x04
=
>
CanonicalOption
:
:
Realloc
(
reader
.
read_var_u32
(
)
?
)
0x05
=
>
CanonicalOption
:
:
PostReturn
(
reader
.
read_var_u32
(
)
?
)
0x06
=
>
CanonicalOption
:
:
Async
0x07
=
>
CanonicalOption
:
:
Callback
(
reader
.
read_var_u32
(
)
?
)
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
option
"
)
}
)
}
}
