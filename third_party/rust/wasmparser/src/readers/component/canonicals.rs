use
crate
:
:
limits
:
:
MAX_WASM_CANONICAL_OPTIONS
;
use
crate
:
:
prelude
:
:
*
;
use
crate
:
:
{
BinaryReader
ComponentValType
FromReader
Result
SectionLimited
}
;
#
[
derive
(
Debug
Clone
Copy
PartialEq
Eq
)
]
pub
enum
CanonicalOption
{
UTF8
UTF16
CompactUTF16
Memory
(
u32
)
Realloc
(
u32
)
PostReturn
(
u32
)
Async
Callback
(
u32
)
CoreType
(
u32
)
Gc
}
#
[
derive
(
Debug
Clone
Eq
PartialEq
)
]
pub
enum
CanonicalFunction
{
Lift
{
core_func_index
:
u32
type_index
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
Lower
{
func_index
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
ResourceNew
{
resource
:
u32
}
ResourceDrop
{
resource
:
u32
}
ResourceDropAsync
{
resource
:
u32
}
ResourceRep
{
resource
:
u32
}
ThreadSpawnRef
{
func_ty_index
:
u32
}
ThreadSpawnIndirect
{
func_ty_index
:
u32
table_index
:
u32
}
ThreadAvailableParallelism
BackpressureSet
BackpressureInc
BackpressureDec
TaskReturn
{
result
:
Option
<
ComponentValType
>
options
:
Box
<
[
CanonicalOption
]
>
}
TaskCancel
ContextGet
(
u32
)
ContextSet
(
u32
)
ThreadYield
{
cancellable
:
bool
}
SubtaskDrop
SubtaskCancel
{
async_
:
bool
}
StreamNew
{
ty
:
u32
}
StreamRead
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
StreamWrite
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
StreamCancelRead
{
ty
:
u32
async_
:
bool
}
StreamCancelWrite
{
ty
:
u32
async_
:
bool
}
StreamDropReadable
{
ty
:
u32
}
StreamDropWritable
{
ty
:
u32
}
FutureNew
{
ty
:
u32
}
FutureRead
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
FutureWrite
{
ty
:
u32
options
:
Box
<
[
CanonicalOption
]
>
}
FutureCancelRead
{
ty
:
u32
async_
:
bool
}
FutureCancelWrite
{
ty
:
u32
async_
:
bool
}
FutureDropReadable
{
ty
:
u32
}
FutureDropWritable
{
ty
:
u32
}
ErrorContextNew
{
options
:
Box
<
[
CanonicalOption
]
>
}
ErrorContextDebugMessage
{
options
:
Box
<
[
CanonicalOption
]
>
}
ErrorContextDrop
WaitableSetNew
WaitableSetWait
{
cancellable
:
bool
memory
:
u32
}
WaitableSetPoll
{
cancellable
:
bool
memory
:
u32
}
WaitableSetDrop
WaitableJoin
ThreadIndex
ThreadNewIndirect
{
func_ty_index
:
u32
table_index
:
u32
}
ThreadSwitchTo
{
cancellable
:
bool
}
ThreadSuspend
{
cancellable
:
bool
}
ThreadResumeLater
ThreadYieldTo
{
cancellable
:
bool
}
}
pub
type
ComponentCanonicalSectionReader
<
'
a
>
=
SectionLimited
<
'
a
CanonicalFunction
>
;
impl
<
'
a
>
FromReader
<
'
a
>
for
CanonicalFunction
{
fn
from_reader
(
reader
:
&
mut
BinaryReader
<
'
a
>
)
-
>
Result
<
CanonicalFunction
>
{
Ok
(
match
reader
.
read_u8
(
)
?
{
0x00
=
>
match
reader
.
read_u8
(
)
?
{
0x00
=
>
CanonicalFunction
:
:
Lift
{
core_func_index
:
reader
.
read_var_u32
(
)
?
options
:
read_opts
(
reader
)
?
type_index
:
reader
.
read_var_u32
(
)
?
}
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
function
lift
"
)
}
0x01
=
>
match
reader
.
read_u8
(
)
?
{
0x00
=
>
CanonicalFunction
:
:
Lower
{
func_index
:
reader
.
read_var_u32
(
)
?
options
:
read_opts
(
reader
)
?
}
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
function
lower
"
)
}
0x02
=
>
CanonicalFunction
:
:
ResourceNew
{
resource
:
reader
.
read
(
)
?
}
0x03
=
>
CanonicalFunction
:
:
ResourceDrop
{
resource
:
reader
.
read
(
)
?
}
0x07
=
>
CanonicalFunction
:
:
ResourceDropAsync
{
resource
:
reader
.
read
(
)
?
}
0x04
=
>
CanonicalFunction
:
:
ResourceRep
{
resource
:
reader
.
read
(
)
?
}
0x08
=
>
CanonicalFunction
:
:
BackpressureSet
0x24
=
>
CanonicalFunction
:
:
BackpressureInc
0x25
=
>
CanonicalFunction
:
:
BackpressureDec
0x09
=
>
CanonicalFunction
:
:
TaskReturn
{
result
:
crate
:
:
read_resultlist
(
reader
)
?
options
:
read_opts
(
reader
)
?
}
0x0a
=
>
match
reader
.
read_u8
(
)
?
{
0x7f
=
>
CanonicalFunction
:
:
ContextGet
(
reader
.
read_var_u32
(
)
?
)
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
context
.
get
intrinsic
type
"
)
}
0x0b
=
>
match
reader
.
read_u8
(
)
?
{
0x7f
=
>
CanonicalFunction
:
:
ContextSet
(
reader
.
read_var_u32
(
)
?
)
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
context
.
set
intrinsic
type
"
)
}
0x0c
=
>
CanonicalFunction
:
:
ThreadYield
{
cancellable
:
reader
.
read
(
)
?
}
0x0d
=
>
CanonicalFunction
:
:
SubtaskDrop
0x0e
=
>
CanonicalFunction
:
:
StreamNew
{
ty
:
reader
.
read
(
)
?
}
0x0f
=
>
CanonicalFunction
:
:
StreamRead
{
ty
:
reader
.
read
(
)
?
options
:
read_opts
(
reader
)
?
}
0x10
=
>
CanonicalFunction
:
:
StreamWrite
{
ty
:
reader
.
read
(
)
?
options
:
read_opts
(
reader
)
?
}
0x11
=
>
CanonicalFunction
:
:
StreamCancelRead
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x12
=
>
CanonicalFunction
:
:
StreamCancelWrite
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x13
=
>
CanonicalFunction
:
:
StreamDropReadable
{
ty
:
reader
.
read
(
)
?
}
0x14
=
>
CanonicalFunction
:
:
StreamDropWritable
{
ty
:
reader
.
read
(
)
?
}
0x15
=
>
CanonicalFunction
:
:
FutureNew
{
ty
:
reader
.
read
(
)
?
}
0x16
=
>
CanonicalFunction
:
:
FutureRead
{
ty
:
reader
.
read
(
)
?
options
:
read_opts
(
reader
)
?
}
0x17
=
>
CanonicalFunction
:
:
FutureWrite
{
ty
:
reader
.
read
(
)
?
options
:
read_opts
(
reader
)
?
}
0x18
=
>
CanonicalFunction
:
:
FutureCancelRead
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x19
=
>
CanonicalFunction
:
:
FutureCancelWrite
{
ty
:
reader
.
read
(
)
?
async_
:
reader
.
read
(
)
?
}
0x1a
=
>
CanonicalFunction
:
:
FutureDropReadable
{
ty
:
reader
.
read
(
)
?
}
0x1b
=
>
CanonicalFunction
:
:
FutureDropWritable
{
ty
:
reader
.
read
(
)
?
}
0x1c
=
>
CanonicalFunction
:
:
ErrorContextNew
{
options
:
read_opts
(
reader
)
?
}
0x1d
=
>
CanonicalFunction
:
:
ErrorContextDebugMessage
{
options
:
read_opts
(
reader
)
?
}
0x1e
=
>
CanonicalFunction
:
:
ErrorContextDrop
0x1f
=
>
CanonicalFunction
:
:
WaitableSetNew
0x20
=
>
CanonicalFunction
:
:
WaitableSetWait
{
cancellable
:
reader
.
read
(
)
?
memory
:
reader
.
read
(
)
?
}
0x21
=
>
CanonicalFunction
:
:
WaitableSetPoll
{
cancellable
:
reader
.
read
(
)
?
memory
:
reader
.
read
(
)
?
}
0x22
=
>
CanonicalFunction
:
:
WaitableSetDrop
0x23
=
>
CanonicalFunction
:
:
WaitableJoin
0x26
=
>
CanonicalFunction
:
:
ThreadIndex
0x27
=
>
CanonicalFunction
:
:
ThreadNewIndirect
{
func_ty_index
:
reader
.
read
(
)
?
table_index
:
reader
.
read
(
)
?
}
0x28
=
>
CanonicalFunction
:
:
ThreadSwitchTo
{
cancellable
:
reader
.
read
(
)
?
}
0x29
=
>
CanonicalFunction
:
:
ThreadSuspend
{
cancellable
:
reader
.
read
(
)
?
}
0x2a
=
>
CanonicalFunction
:
:
ThreadResumeLater
0x2b
=
>
CanonicalFunction
:
:
ThreadYieldTo
{
cancellable
:
reader
.
read
(
)
?
}
0x06
=
>
CanonicalFunction
:
:
SubtaskCancel
{
async_
:
reader
.
read
(
)
?
}
0x05
=
>
CanonicalFunction
:
:
TaskCancel
0x40
=
>
CanonicalFunction
:
:
ThreadSpawnRef
{
func_ty_index
:
reader
.
read
(
)
?
}
0x41
=
>
CanonicalFunction
:
:
ThreadSpawnIndirect
{
func_ty_index
:
reader
.
read
(
)
?
table_index
:
reader
.
read
(
)
?
}
0x42
=
>
CanonicalFunction
:
:
ThreadAvailableParallelism
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
function
"
)
}
)
}
}
fn
read_opts
(
reader
:
&
mut
BinaryReader
<
'
_
>
)
-
>
Result
<
Box
<
[
CanonicalOption
]
>
>
{
reader
.
read_iter
(
MAX_WASM_CANONICAL_OPTIONS
"
canonical
options
"
)
?
.
collect
:
:
<
Result
<
_
>
>
(
)
}
impl
<
'
a
>
FromReader
<
'
a
>
for
CanonicalOption
{
fn
from_reader
(
reader
:
&
mut
BinaryReader
<
'
a
>
)
-
>
Result
<
Self
>
{
Ok
(
match
reader
.
read_u8
(
)
?
{
0x00
=
>
CanonicalOption
:
:
UTF8
0x01
=
>
CanonicalOption
:
:
UTF16
0x02
=
>
CanonicalOption
:
:
CompactUTF16
0x03
=
>
CanonicalOption
:
:
Memory
(
reader
.
read_var_u32
(
)
?
)
0x04
=
>
CanonicalOption
:
:
Realloc
(
reader
.
read_var_u32
(
)
?
)
0x05
=
>
CanonicalOption
:
:
PostReturn
(
reader
.
read_var_u32
(
)
?
)
0x06
=
>
CanonicalOption
:
:
Async
0x07
=
>
CanonicalOption
:
:
Callback
(
reader
.
read_var_u32
(
)
?
)
0x08
=
>
CanonicalOption
:
:
CoreType
(
reader
.
read_var_u32
(
)
?
)
0x09
=
>
CanonicalOption
:
:
Gc
x
=
>
return
reader
.
invalid_leading_byte
(
x
"
canonical
option
"
)
}
)
}
}
