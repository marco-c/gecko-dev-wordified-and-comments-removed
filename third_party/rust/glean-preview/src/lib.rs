#
!
[
deny
(
missing_docs
)
]
use
once_cell
:
:
sync
:
:
OnceCell
;
use
std
:
:
sync
:
:
Mutex
;
pub
use
glean_core
:
:
{
Configuration
Error
Glean
Result
}
;
pub
mod
metrics
;
static
GLEAN
:
OnceCell
<
Mutex
<
Glean
>
>
=
OnceCell
:
:
new
(
)
;
fn
global_glean
(
)
-
>
&
'
static
Mutex
<
Glean
>
{
GLEAN
.
get
(
)
.
unwrap
(
)
}
fn
setup_glean
(
glean
:
Glean
)
-
>
Result
<
(
)
>
{
if
GLEAN
.
get
(
)
.
is_none
(
)
{
GLEAN
.
set
(
Mutex
:
:
new
(
glean
)
)
.
unwrap
(
)
;
}
else
{
let
mut
lock
=
GLEAN
.
get
(
)
.
unwrap
(
)
.
lock
(
)
.
unwrap
(
)
;
*
lock
=
glean
;
}
Ok
(
(
)
)
}
fn
with_glean
<
F
R
>
(
f
:
F
)
-
>
R
where
F
:
Fn
(
&
Glean
)
-
>
R
{
let
lock
=
global_glean
(
)
.
lock
(
)
.
unwrap
(
)
;
f
(
&
lock
)
}
fn
with_glean_mut
<
F
R
>
(
f
:
F
)
-
>
R
where
F
:
Fn
(
&
mut
Glean
)
-
>
R
{
let
mut
lock
=
global_glean
(
)
.
lock
(
)
.
unwrap
(
)
;
f
(
&
mut
lock
)
}
pub
fn
initialize
(
cfg
:
Configuration
)
-
>
Result
<
(
)
>
{
let
glean
=
Glean
:
:
new
(
cfg
)
?
;
setup_glean
(
glean
)
?
;
Ok
(
(
)
)
}
pub
fn
set_upload_enabled
(
flag
:
bool
)
-
>
bool
{
with_glean_mut
(
|
glean
|
{
glean
.
set_upload_enabled
(
flag
)
;
glean
.
is_upload_enabled
(
)
}
)
}
pub
fn
is_upload_enabled
(
)
-
>
bool
{
with_glean
(
|
glean
|
glean
.
is_upload_enabled
(
)
)
}
pub
fn
register_ping_type
(
ping
:
&
metrics
:
:
PingType
)
{
with_glean_mut
(
|
glean
|
{
glean
.
register_ping_type
(
&
ping
.
ping_type
)
;
}
)
}
pub
fn
send_ping
(
ping
:
&
metrics
:
:
PingType
)
-
>
bool
{
send_ping_by_name
(
&
ping
.
name
)
}
pub
fn
send_ping_by_name
(
ping
:
&
str
)
-
>
bool
{
send_pings_by_name
(
&
[
ping
.
to_string
(
)
]
)
}
pub
fn
send_pings_by_name
(
pings
:
&
[
String
]
)
-
>
bool
{
with_glean
(
|
glean
|
glean
.
send_pings_by_name
(
pings
)
)
}
