#
include
"
config
.
h
"
#
include
<
errno
.
h
>
#
include
<
sys
/
types
.
h
>
#
include
<
sys
/
stat
.
h
>
#
include
<
fcntl
.
h
>
#
include
<
unistd
.
h
>
#
include
"
backtrace
.
h
"
#
include
"
internal
.
h
"
#
ifndef
O_BINARY
#
define
O_BINARY
0
#
endif
#
ifndef
O_CLOEXEC
#
define
O_CLOEXEC
0
#
endif
#
ifndef
FD_CLOEXEC
#
define
FD_CLOEXEC
1
#
endif
int
backtrace_open
(
const
char
*
filename
backtrace_error_callback
error_callback
void
*
data
int
*
does_not_exist
)
{
int
descriptor
;
if
(
does_not_exist
!
=
NULL
)
*
does_not_exist
=
0
;
descriptor
=
open
(
filename
(
int
)
(
O_RDONLY
|
O_BINARY
|
O_CLOEXEC
)
)
;
if
(
descriptor
<
0
)
{
if
(
does_not_exist
!
=
NULL
&
&
errno
=
=
ENOENT
)
*
does_not_exist
=
1
;
else
error_callback
(
data
filename
errno
)
;
return
-
1
;
}
#
ifdef
HAVE_FCNTL
fcntl
(
descriptor
F_SETFD
FD_CLOEXEC
)
;
#
endif
return
descriptor
;
}
int
backtrace_close
(
int
descriptor
backtrace_error_callback
error_callback
void
*
data
)
{
if
(
close
(
descriptor
)
<
0
)
{
error_callback
(
data
"
close
"
errno
)
;
return
0
;
}
return
1
;
}
