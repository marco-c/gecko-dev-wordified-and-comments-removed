use
crate
:
:
ConnExt
;
use
rusqlite
:
:
{
Connection
Result
}
;
pub
fn
run_maintenance
(
conn
:
&
Connection
)
-
>
Result
<
(
)
>
{
vacuum
(
conn
)
?
;
conn
.
execute_one
(
"
PRAGMA
optimize
"
)
?
;
conn
.
execute_one
(
"
PRAGMA
wal_checkpoint
(
PASSIVE
)
"
)
?
;
Ok
(
(
)
)
}
fn
vacuum
(
conn
:
&
Connection
)
-
>
Result
<
(
)
>
{
let
auto_vacuum_setting
:
u32
=
conn
.
query_one
(
"
PRAGMA
auto_vacuum
"
)
?
;
if
auto_vacuum_setting
=
=
2
{
conn
.
execute_one
(
"
PRAGMA
incremental_vacuum
(
2
)
"
)
?
;
}
else
{
error_support
:
:
warn
!
(
"
run_maintenance_vacuum
:
Need
to
run
a
full
vacuum
to
set
auto_vacuum
=
incremental
"
)
;
conn
.
execute_one
(
"
PRAGMA
auto_vacuum
=
incremental
"
)
?
;
conn
.
execute_one
(
"
VACUUM
"
)
?
;
}
Ok
(
(
)
)
}
