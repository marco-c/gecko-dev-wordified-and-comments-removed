use
alloc
:
:
string
:
:
String
;
use
crate
:
:
Backends
;
#
[
cfg
(
doc
)
]
use
crate
:
:
{
Backend
DownlevelFlags
}
;
#
[
derive
(
Clone
Debug
Default
)
]
pub
struct
InstanceDescriptor
{
pub
backends
:
Backends
pub
flags
:
InstanceFlags
pub
memory_budget_thresholds
:
MemoryBudgetThresholds
pub
backend_options
:
BackendOptions
}
impl
InstanceDescriptor
{
#
[
must_use
]
pub
fn
from_env_or_default
(
)
-
>
Self
{
Self
:
:
default
(
)
.
with_env
(
)
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
let
backends
=
self
.
backends
.
with_env
(
)
;
let
flags
=
self
.
flags
.
with_env
(
)
;
let
backend_options
=
self
.
backend_options
.
with_env
(
)
;
Self
{
backends
flags
memory_budget_thresholds
:
MemoryBudgetThresholds
:
:
default
(
)
backend_options
}
}
}
bitflags
:
:
bitflags
!
{
/
/
/
Instance
debugging
flags
.
/
/
/
/
/
/
These
are
not
part
of
the
WebGPU
standard
.
/
/
/
/
/
/
Defaults
to
enabling
debugging
-
related
flags
if
the
build
configuration
has
debug_assertions
.
#
[
repr
(
transparent
)
]
#
[
derive
(
Debug
Copy
Clone
PartialEq
Eq
Hash
)
]
pub
struct
InstanceFlags
:
u32
{
/
/
/
Generate
debug
information
in
shaders
and
objects
.
/
/
/
/
/
/
When
Self
:
:
from_env
(
)
is
used
takes
value
from
WGPU_DEBUG
environment
variable
.
const
DEBUG
=
1
<
<
0
;
/
/
/
Enable
validation
in
the
backend
API
if
possible
:
/
/
/
/
/
/
-
On
the
Direct3D
dx12
backend
this
calls
[
ID3D12Debug
:
:
EnableDebugLayer
]
[
dx12
]
.
/
/
/
/
/
/
-
On
the
Vulkan
backend
this
enables
the
[
Vulkan
Validation
Layer
]
[
vvl
]
.
/
/
/
/
/
/
-
On
the
gles
backend
driving
Windows
OpenGL
this
enables
[
debug
/
/
/
output
]
[
gl
:
do
]
effectively
calling
glEnable
(
GL_DEBUG_OUTPUT
)
.
/
/
/
/
/
/
-
On
non
-
Windows
gles
backends
this
calls
/
/
/
[
eglDebugMessageControlKHR
]
[
gl
:
dm
]
to
enable
all
debugging
messages
.
/
/
/
If
the
GLES
implementation
is
ANGLE
running
on
Vulkan
this
also
/
/
/
enables
the
Vulkan
validation
layers
by
setting
/
/
/
[
EGL_PLATFORM_ANGLE_DEBUG_LAYERS_ENABLED
]
[
gl
:
av
]
.
/
/
/
/
/
/
When
Self
:
:
from_env
(
)
is
used
this
bit
is
set
if
the
WGPU_VALIDATION
/
/
/
environment
variable
has
any
value
but
"
0
"
.
/
/
/
/
/
/
[
dx12
]
:
https
:
/
/
learn
.
microsoft
.
com
/
en
-
us
/
windows
/
win32
/
api
/
d3d12sdklayers
/
nf
-
d3d12sdklayers
-
id3d12debug
-
enabledebuglayer
/
/
/
[
vvl
]
:
https
:
/
/
github
.
com
/
KhronosGroup
/
Vulkan
-
ValidationLayers
/
/
/
[
gl
:
dm
]
:
https
:
/
/
registry
.
khronos
.
org
/
EGL
/
extensions
/
KHR
/
EGL_KHR_debug
.
txt
/
/
/
[
gl
:
do
]
:
https
:
/
/
www
.
khronos
.
org
/
opengl
/
wiki
/
Debug_Output
/
/
/
[
gl
:
av
]
:
https
:
/
/
chromium
.
googlesource
.
com
/
angle
/
angle
/
+
/
HEAD
/
extensions
/
EGL_ANGLE_platform_angle
.
txt
const
VALIDATION
=
1
<
<
1
;
/
/
/
Don
'
t
pass
labels
to
wgpu
-
hal
.
/
/
/
/
/
/
When
Self
:
:
from_env
(
)
is
used
takes
value
from
WGPU_DISCARD_HAL_LABELS
environment
variable
.
const
DISCARD_HAL_LABELS
=
1
<
<
2
;
/
/
/
Whether
wgpu
should
expose
adapters
that
run
on
top
of
non
-
compliant
adapters
.
/
/
/
/
/
/
Turning
this
on
might
mean
that
some
of
the
functionality
provided
by
the
wgpu
/
/
/
adapter
/
device
is
not
working
or
is
broken
.
It
could
be
that
all
the
functionality
/
/
/
wgpu
currently
exposes
works
but
we
can
'
t
tell
for
sure
since
we
have
no
additional
/
/
/
transparency
into
what
is
working
and
what
is
not
on
the
underlying
adapter
.
/
/
/
/
/
/
This
mainly
applies
to
a
Vulkan
driver
'
s
compliance
version
.
If
the
major
compliance
version
/
/
/
is
0
then
the
driver
is
ignored
.
This
flag
allows
that
driver
to
be
enabled
for
testing
.
/
/
/
/
/
/
When
Self
:
:
from_env
(
)
is
used
takes
value
from
WGPU_ALLOW_UNDERLYING_NONCOMPLIANT_ADAPTER
environment
variable
.
const
ALLOW_UNDERLYING_NONCOMPLIANT_ADAPTER
=
1
<
<
3
;
/
/
/
Enable
GPU
-
based
validation
.
Implies
[
Self
:
:
VALIDATION
]
.
Currently
this
only
changes
/
/
/
behavior
on
the
DX12
and
Vulkan
backends
.
/
/
/
/
/
/
Supported
platforms
:
/
/
/
/
/
/
-
D3D12
;
called
[
"
GPU
-
based
validation
"
or
/
/
/
"
GBV
"
]
(
https
:
/
/
web
.
archive
.
org
/
web
/
20230206120404
/
https
:
/
/
learn
.
microsoft
.
com
/
en
-
us
/
windows
/
win32
/
direct3d12
/
using
-
d3d12
-
debug
-
layer
-
gpu
-
based
-
validation
)
/
/
/
-
Vulkan
via
the
VK_LAYER_KHRONOS_validation
layer
;
called
[
"
GPU
-
Assisted
/
/
/
Validation
"
]
(
https
:
/
/
github
.
com
/
KhronosGroup
/
Vulkan
-
ValidationLayers
/
blob
/
e45aeb85079e0835694cb8f03e6681fd18ae72c9
/
docs
/
gpu_validation
.
md
#
gpu
-
assisted
-
validation
)
/
/
/
/
/
/
When
Self
:
:
from_env
(
)
is
used
takes
value
from
WGPU_GPU_BASED_VALIDATION
environment
variable
.
const
GPU_BASED_VALIDATION
=
1
<
<
4
;
/
/
/
Validate
indirect
buffer
content
prior
to
issuing
indirect
draws
/
dispatches
.
/
/
/
/
/
/
This
validation
will
transform
indirect
calls
into
no
-
ops
if
they
are
not
valid
:
/
/
/
/
/
/
-
When
calling
dispatch_workgroups_indirect
all
3
indirect
arguments
encoded
in
the
buffer
/
/
/
must
be
less
than
the
max_compute_workgroups_per_dimension
device
limit
.
/
/
/
-
When
calling
draw_indirect
/
draw_indexed_indirect
/
multi_draw_indirect
/
multi_draw_indexed_indirect
:
/
/
/
-
If
Features
:
:
INDIRECT_FIRST_INSTANCE
is
not
enabled
on
the
device
the
first_instance
indirect
argument
must
be
0
.
/
/
/
-
The
first_instance
&
instance_count
indirect
arguments
must
form
a
range
that
fits
within
all
bound
vertex
buffers
with
step_mode
set
to
Instance
.
/
/
/
-
When
calling
draw_indirect
/
multi_draw_indirect
:
/
/
/
-
The
first_vertex
&
vertex_count
indirect
arguments
must
form
a
range
that
fits
within
all
bound
vertex
buffers
with
step_mode
set
to
Vertex
.
/
/
/
-
When
calling
draw_indexed_indirect
/
multi_draw_indexed_indirect
:
/
/
/
-
The
first_index
&
index_count
indirect
arguments
must
form
a
range
that
fits
within
the
bound
index
buffer
.
/
/
/
/
/
/
__Behavior
is
undefined
if
this
validation
is
disabled
and
the
rules
above
are
not
satisfied
.
__
/
/
/
/
/
/
Disabling
this
will
also
cause
the
following
built
-
ins
to
not
report
the
right
values
on
the
D3D12
backend
:
/
/
/
/
/
/
-
the
3
components
of
builtin
(
num_workgroups
)
will
be
0
/
/
/
-
the
value
of
builtin
(
vertex_index
)
will
not
take
into
account
the
value
of
the
first_vertex
/
base_vertex
argument
present
in
the
indirect
buffer
/
/
/
-
the
value
of
builtin
(
instance_index
)
will
not
take
into
account
the
value
of
the
first_instance
argument
present
in
the
indirect
buffer
/
/
/
/
/
/
When
Self
:
:
from_env
(
)
is
used
takes
value
from
WGPU_VALIDATION_INDIRECT_CALL
environment
variable
.
const
VALIDATION_INDIRECT_CALL
=
1
<
<
5
;
/
/
/
Enable
automatic
timestamp
normalization
.
This
means
that
in
[
CommandEncoder
:
:
resolve_query_set
]
[
rqs
]
/
/
/
the
timestamps
will
automatically
be
normalized
to
be
in
nanoseconds
instead
of
the
raw
timestamp
values
.
/
/
/
/
/
/
This
is
disabled
by
default
because
it
introduces
a
compute
shader
into
the
resolution
of
query
sets
.
/
/
/
/
/
/
This
can
be
useful
for
users
that
need
to
read
timestamps
on
the
gpu
as
the
normalization
/
/
/
can
be
a
hassle
to
do
manually
.
When
this
is
enabled
the
timestamp
period
returned
by
the
queue
/
/
/
will
always
be
1
.
0
.
/
/
/
/
/
/
[
rqs
]
:
.
.
/
wgpu
/
struct
.
CommandEncoder
.
html
#
method
.
resolve_query_set
const
AUTOMATIC_TIMESTAMP_NORMALIZATION
=
1
<
<
6
;
}
}
impl
Default
for
InstanceFlags
{
fn
default
(
)
-
>
Self
{
Self
:
:
from_build_config
(
)
}
}
impl
InstanceFlags
{
#
[
must_use
]
pub
fn
debugging
(
)
-
>
Self
{
InstanceFlags
:
:
DEBUG
|
InstanceFlags
:
:
VALIDATION
|
InstanceFlags
:
:
VALIDATION_INDIRECT_CALL
}
#
[
must_use
]
pub
fn
advanced_debugging
(
)
-
>
Self
{
Self
:
:
debugging
(
)
|
InstanceFlags
:
:
GPU_BASED_VALIDATION
}
#
[
must_use
]
pub
fn
from_build_config
(
)
-
>
Self
{
if
cfg
!
(
debug_assertions
)
{
return
InstanceFlags
:
:
debugging
(
)
;
}
InstanceFlags
:
:
VALIDATION_INDIRECT_CALL
}
#
[
must_use
]
pub
fn
from_env_or_default
(
)
-
>
Self
{
Self
:
:
default
(
)
.
with_env
(
)
}
#
[
must_use
]
pub
fn
with_env
(
mut
self
)
-
>
Self
{
fn
env
(
key
:
&
str
)
-
>
Option
<
bool
>
{
crate
:
:
env
:
:
var
(
key
)
.
map
(
|
s
|
match
s
.
as_str
(
)
{
"
0
"
=
>
false
_
=
>
true
}
)
}
if
let
Some
(
bit
)
=
env
(
"
WGPU_VALIDATION
"
)
{
self
.
set
(
Self
:
:
VALIDATION
bit
)
;
}
if
let
Some
(
bit
)
=
env
(
"
WGPU_DEBUG
"
)
{
self
.
set
(
Self
:
:
DEBUG
bit
)
;
}
if
let
Some
(
bit
)
=
env
(
"
WGPU_DISCARD_HAL_LABELS
"
)
{
self
.
set
(
Self
:
:
DISCARD_HAL_LABELS
bit
)
;
}
if
let
Some
(
bit
)
=
env
(
"
WGPU_ALLOW_UNDERLYING_NONCOMPLIANT_ADAPTER
"
)
{
self
.
set
(
Self
:
:
ALLOW_UNDERLYING_NONCOMPLIANT_ADAPTER
bit
)
;
}
if
let
Some
(
bit
)
=
env
(
"
WGPU_GPU_BASED_VALIDATION
"
)
{
self
.
set
(
Self
:
:
GPU_BASED_VALIDATION
bit
)
;
}
if
let
Some
(
bit
)
=
env
(
"
WGPU_VALIDATION_INDIRECT_CALL
"
)
{
self
.
set
(
Self
:
:
VALIDATION_INDIRECT_CALL
bit
)
;
}
self
}
}
#
[
derive
(
Default
Clone
Debug
Copy
)
]
pub
struct
MemoryBudgetThresholds
{
pub
for_resource_creation
:
Option
<
u8
>
pub
for_device_loss
:
Option
<
u8
>
}
#
[
derive
(
Clone
Debug
Default
)
]
pub
struct
BackendOptions
{
pub
gl
:
GlBackendOptions
pub
dx12
:
Dx12BackendOptions
pub
noop
:
NoopBackendOptions
}
impl
BackendOptions
{
#
[
must_use
]
pub
fn
from_env_or_default
(
)
-
>
Self
{
Self
{
gl
:
GlBackendOptions
:
:
from_env_or_default
(
)
dx12
:
Dx12BackendOptions
:
:
from_env_or_default
(
)
noop
:
NoopBackendOptions
:
:
from_env_or_default
(
)
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
Self
{
gl
:
self
.
gl
.
with_env
(
)
dx12
:
self
.
dx12
.
with_env
(
)
noop
:
self
.
noop
.
with_env
(
)
}
}
}
#
[
derive
(
Clone
Debug
Default
)
]
pub
struct
GlBackendOptions
{
pub
gles_minor_version
:
Gles3MinorVersion
pub
fence_behavior
:
GlFenceBehavior
}
impl
GlBackendOptions
{
#
[
must_use
]
pub
fn
from_env_or_default
(
)
-
>
Self
{
let
gles_minor_version
=
Gles3MinorVersion
:
:
from_env
(
)
.
unwrap_or_default
(
)
;
Self
{
gles_minor_version
fence_behavior
:
GlFenceBehavior
:
:
Normal
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
let
gles_minor_version
=
self
.
gles_minor_version
.
with_env
(
)
;
let
short_circuit_fences
=
self
.
fence_behavior
.
with_env
(
)
;
Self
{
gles_minor_version
fence_behavior
:
short_circuit_fences
}
}
}
#
[
derive
(
Clone
Debug
Default
)
]
pub
struct
Dx12BackendOptions
{
pub
shader_compiler
:
Dx12Compiler
pub
presentation_system
:
Dx12SwapchainKind
pub
latency_waitable_object
:
Dx12UseFrameLatencyWaitableObject
}
impl
Dx12BackendOptions
{
#
[
must_use
]
pub
fn
from_env_or_default
(
)
-
>
Self
{
let
compiler
=
Dx12Compiler
:
:
from_env
(
)
.
unwrap_or_default
(
)
;
let
presentation_system
=
Dx12SwapchainKind
:
:
from_env
(
)
.
unwrap_or_default
(
)
;
let
latency_waitable_object
=
Dx12UseFrameLatencyWaitableObject
:
:
from_env
(
)
.
unwrap_or_default
(
)
;
Self
{
shader_compiler
:
compiler
presentation_system
latency_waitable_object
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
let
shader_compiler
=
self
.
shader_compiler
.
with_env
(
)
;
let
presentation_system
=
self
.
presentation_system
.
with_env
(
)
;
let
latency_waitable_object
=
self
.
latency_waitable_object
.
with_env
(
)
;
Self
{
shader_compiler
presentation_system
latency_waitable_object
}
}
}
#
[
derive
(
Clone
Debug
Default
)
]
pub
struct
NoopBackendOptions
{
pub
enable
:
bool
}
impl
NoopBackendOptions
{
#
[
must_use
]
pub
fn
from_env_or_default
(
)
-
>
Self
{
Self
{
enable
:
Self
:
:
enable_from_env
(
)
.
unwrap_or
(
false
)
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
Self
{
enable
:
Self
:
:
enable_from_env
(
)
.
unwrap_or
(
self
.
enable
)
}
}
fn
enable_from_env
(
)
-
>
Option
<
bool
>
{
let
value
=
crate
:
:
env
:
:
var
(
"
WGPU_NOOP_BACKEND
"
)
?
;
match
value
.
as_str
(
)
{
"
1
"
=
>
Some
(
true
)
"
0
"
=
>
Some
(
false
)
_
=
>
None
}
}
}
#
[
derive
(
Clone
Debug
Default
Copy
PartialEq
Eq
)
]
pub
enum
Dx12SwapchainKind
{
#
[
default
]
DxgiFromHwnd
DxgiFromVisual
}
impl
Dx12SwapchainKind
{
#
[
must_use
]
pub
fn
from_env
(
)
-
>
Option
<
Self
>
{
let
value
=
crate
:
:
env
:
:
var
(
"
WGPU_DX12_PRESENTATION_SYSTEM
"
)
.
as_deref
(
)
?
.
to_lowercase
(
)
;
match
value
.
as_str
(
)
{
"
dxgifromvisual
"
|
"
visual
"
=
>
Some
(
Self
:
:
DxgiFromVisual
)
"
dxgifromhwnd
"
|
"
hwnd
"
=
>
Some
(
Self
:
:
DxgiFromHwnd
)
_
=
>
None
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
if
let
Some
(
presentation_system
)
=
Self
:
:
from_env
(
)
{
presentation_system
}
else
{
self
}
}
}
#
[
derive
(
Clone
Debug
)
]
#
[
allow
(
missing_docs
)
]
pub
enum
DxcShaderModel
{
V6_0
V6_1
V6_2
V6_3
V6_4
V6_5
V6_6
V6_7
}
#
[
derive
(
Clone
Debug
Default
)
]
pub
enum
Dx12Compiler
{
#
[
default
]
Fxc
DynamicDxc
{
dxc_path
:
String
max_shader_model
:
DxcShaderModel
}
StaticDxc
}
impl
Dx12Compiler
{
pub
fn
default_dynamic_dxc
(
)
-
>
Self
{
Self
:
:
DynamicDxc
{
dxc_path
:
String
:
:
from
(
"
dxcompiler
.
dll
"
)
max_shader_model
:
DxcShaderModel
:
:
V6_7
}
}
#
[
must_use
]
pub
fn
from_env
(
)
-
>
Option
<
Self
>
{
let
value
=
crate
:
:
env
:
:
var
(
"
WGPU_DX12_COMPILER
"
)
.
as_deref
(
)
?
.
to_lowercase
(
)
;
match
value
.
as_str
(
)
{
"
dxc
"
|
"
dynamicdxc
"
=
>
Some
(
Self
:
:
default_dynamic_dxc
(
)
)
"
staticdxc
"
=
>
Some
(
Self
:
:
StaticDxc
)
"
fxc
"
=
>
Some
(
Self
:
:
Fxc
)
_
=
>
None
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
if
let
Some
(
compiler
)
=
Self
:
:
from_env
(
)
{
compiler
}
else
{
self
}
}
}
#
[
derive
(
Clone
Debug
Default
)
]
pub
enum
Dx12UseFrameLatencyWaitableObject
{
None
#
[
default
]
Wait
DontWait
}
impl
Dx12UseFrameLatencyWaitableObject
{
#
[
must_use
]
pub
fn
from_env
(
)
-
>
Option
<
Self
>
{
let
value
=
crate
:
:
env
:
:
var
(
"
WGPU_DX12_USE_FRAME_LATENCY_WAITABLE_OBJECT
"
)
.
as_deref
(
)
?
.
to_lowercase
(
)
;
match
value
.
as_str
(
)
{
"
none
"
=
>
Some
(
Self
:
:
None
)
"
wait
"
=
>
Some
(
Self
:
:
Wait
)
"
dontwait
"
=
>
Some
(
Self
:
:
DontWait
)
_
=
>
None
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
if
let
Some
(
compiler
)
=
Self
:
:
from_env
(
)
{
compiler
}
else
{
self
}
}
}
#
[
derive
(
Clone
Copy
Debug
Default
Eq
PartialEq
Hash
)
]
pub
enum
Gles3MinorVersion
{
#
[
default
]
Automatic
Version0
Version1
Version2
}
impl
Gles3MinorVersion
{
#
[
must_use
]
pub
fn
from_env
(
)
-
>
Option
<
Self
>
{
let
value
=
crate
:
:
env
:
:
var
(
"
WGPU_GLES_MINOR_VERSION
"
)
.
as_deref
(
)
?
.
to_lowercase
(
)
;
match
value
.
as_str
(
)
{
"
automatic
"
=
>
Some
(
Self
:
:
Automatic
)
"
0
"
=
>
Some
(
Self
:
:
Version0
)
"
1
"
=
>
Some
(
Self
:
:
Version1
)
"
2
"
=
>
Some
(
Self
:
:
Version2
)
_
=
>
None
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
if
let
Some
(
compiler
)
=
Self
:
:
from_env
(
)
{
compiler
}
else
{
self
}
}
}
#
[
derive
(
Clone
Copy
Debug
PartialEq
Eq
Default
)
]
pub
enum
GlFenceBehavior
{
#
[
default
]
Normal
AutoFinish
}
impl
GlFenceBehavior
{
pub
fn
is_auto_finish
(
&
self
)
-
>
bool
{
matches
!
(
self
Self
:
:
AutoFinish
)
}
pub
fn
is_normal
(
&
self
)
-
>
bool
{
matches
!
(
self
Self
:
:
Normal
)
}
#
[
must_use
]
pub
fn
from_env
(
)
-
>
Option
<
Self
>
{
let
value
=
crate
:
:
env
:
:
var
(
"
WGPU_GL_FENCE_BEHAVIOR
"
)
.
as_deref
(
)
?
.
to_lowercase
(
)
;
match
value
.
as_str
(
)
{
"
normal
"
=
>
Some
(
Self
:
:
Normal
)
"
autofinish
"
=
>
Some
(
Self
:
:
AutoFinish
)
_
=
>
None
}
}
#
[
must_use
]
pub
fn
with_env
(
self
)
-
>
Self
{
if
let
Some
(
fence
)
=
Self
:
:
from_env
(
)
{
fence
}
else
{
self
}
}
}
