use
proc_macro2
:
:
TokenStream
;
use
quote
:
:
{
quote
ToTokens
}
;
use
crate
:
:
util
:
:
PathList
;
use
super
:
:
ForwardAttrs
;
pub
trait
ExtractAttribute
{
fn
local_declarations
(
&
self
)
-
>
TokenStream
;
fn
attr_names
(
&
self
)
-
>
&
PathList
;
fn
forward_attrs
(
&
self
)
-
>
&
ForwardAttrs
<
'
_
>
;
fn
param_name
(
&
self
)
-
>
TokenStream
;
fn
attrs_accessor
(
&
self
)
-
>
TokenStream
{
let
input
=
self
.
param_name
(
)
;
quote
!
(
&
#
input
.
attrs
)
}
fn
core_loop
(
&
self
)
-
>
TokenStream
;
fn
extractor
(
&
self
)
-
>
TokenStream
{
let
mut
declarations
=
self
.
local_declarations
(
)
;
self
.
forward_attrs
(
)
.
as_declaration
(
)
.
to_tokens
(
&
mut
declarations
)
;
let
will_parse_any
=
!
self
.
attr_names
(
)
.
is_empty
(
)
;
let
will_fwd_any
=
self
.
forward_attrs
(
)
.
will_forward_any
(
)
;
if
!
(
will_parse_any
|
|
will_fwd_any
)
{
return
quote
!
{
#
declarations
}
;
}
let
attrs_accessor
=
self
.
attrs_accessor
(
)
;
let
parse_handled
=
if
will_parse_any
{
let
attr_names
=
self
.
attr_names
(
)
.
to_strings
(
)
;
let
core_loop
=
self
.
core_loop
(
)
;
quote
!
(
#
(
#
attr_names
)
|
*
=
>
{
match
:
:
darling
:
:
util
:
:
parse_attribute_to_meta_list
(
__attr
)
{
:
:
darling
:
:
export
:
:
Ok
(
__data
)
=
>
{
match
:
:
darling
:
:
export
:
:
NestedMeta
:
:
parse_meta_list
(
__data
.
tokens
)
{
:
:
darling
:
:
export
:
:
Ok
(
ref
__items
)
=
>
{
if
__items
.
is_empty
(
)
{
continue
;
}
#
core_loop
}
:
:
darling
:
:
export
:
:
Err
(
__err
)
=
>
{
__errors
.
push
(
__err
.
into
(
)
)
;
}
}
}
/
/
darling
was
asked
to
handle
this
attribute
name
but
the
actual
attribute
/
/
isn
'
t
one
that
darling
can
work
with
.
This
either
indicates
a
typing
error
/
/
or
some
misunderstanding
of
the
meta
attribute
syntax
;
in
either
case
the
/
/
caller
should
get
a
useful
error
.
:
:
darling
:
:
export
:
:
Err
(
__err
)
=
>
{
__errors
.
push
(
__err
)
;
}
}
}
)
}
else
{
quote
!
(
)
}
;
let
fwd_population
=
self
.
forward_attrs
(
)
.
as_value_populator
(
)
;
let
forward_unhandled
=
self
.
forward_attrs
(
)
.
as_match_arms
(
)
;
quote
!
(
#
declarations
use
:
:
darling
:
:
ToTokens
;
for
__attr
in
#
attrs_accessor
{
/
/
Filter
attributes
based
on
name
match
:
:
darling
:
:
export
:
:
ToString
:
:
to_string
(
&
__attr
.
path
(
)
.
clone
(
)
.
into_token_stream
(
)
)
.
as_str
(
)
{
#
parse_handled
#
forward_unhandled
}
}
#
fwd_population
)
}
}
