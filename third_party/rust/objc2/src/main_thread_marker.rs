use
core
:
:
fmt
;
use
core
:
:
marker
:
:
PhantomData
;
use
crate
:
:
rc
:
:
Allocated
;
use
crate
:
:
{
ClassType
MainThreadOnly
}
;
#
[
inline
]
fn
is_main_thread
(
)
-
>
bool
{
#
[
cfg
(
target_vendor
=
"
apple
"
)
]
{
#
[
cfg_attr
(
not
(
feature
=
"
std
"
)
link
(
name
=
"
c
"
kind
=
"
dylib
"
)
)
]
extern
"
C
"
{
fn
pthread_main_np
(
)
-
>
core
:
:
ffi
:
:
c_int
;
}
unsafe
{
pthread_main_np
(
)
=
=
1
}
}
#
[
cfg
(
not
(
target_vendor
=
"
apple
"
)
)
]
{
unsafe
{
crate
:
:
msg_send
!
[
crate
:
:
class
!
(
NSThread
)
isMainThread
]
}
}
}
#
[
derive
(
Clone
Copy
PartialEq
Eq
Hash
PartialOrd
Ord
)
]
pub
struct
MainThreadMarker
{
_priv
:
PhantomData
<
*
mut
(
)
>
}
impl
MainThreadMarker
{
#
[
inline
]
#
[
doc
(
alias
=
"
is_main_thread
"
)
]
#
[
doc
(
alias
=
"
pthread_main_np
"
)
]
#
[
doc
(
alias
=
"
isMainThread
"
)
]
pub
fn
new
(
)
-
>
Option
<
Self
>
{
if
is_main_thread
(
)
{
Some
(
unsafe
{
Self
:
:
new_unchecked
(
)
}
)
}
else
{
None
}
}
#
[
inline
]
pub
const
unsafe
fn
new_unchecked
(
)
-
>
Self
{
Self
{
_priv
:
PhantomData
}
}
#
[
inline
]
pub
fn
alloc
<
T
:
ClassType
>
(
self
)
-
>
Allocated
<
T
>
{
unsafe
{
Allocated
:
:
alloc
(
T
:
:
class
(
)
)
}
}
}
impl
<
T
:
?
Sized
+
MainThreadOnly
>
From
<
&
T
>
for
MainThreadMarker
{
#
[
inline
]
fn
from
(
obj
:
&
T
)
-
>
Self
{
obj
.
mtm
(
)
}
}
impl
fmt
:
:
Debug
for
MainThreadMarker
{
fn
fmt
(
&
self
f
:
&
mut
fmt
:
:
Formatter
<
'
_
>
)
-
>
fmt
:
:
Result
{
f
.
debug_tuple
(
"
MainThreadMarker
"
)
.
finish
(
)
}
}
#
[
cfg
(
test
)
]
mod
tests
{
use
super
:
:
*
;
use
std
:
:
panic
:
:
{
RefUnwindSafe
UnwindSafe
}
;
static_assertions
:
:
assert_impl_all
!
(
MainThreadMarker
:
Unpin
UnwindSafe
RefUnwindSafe
Sized
)
;
static_assertions
:
:
assert_not_impl_any
!
(
MainThreadMarker
:
Send
Sync
)
;
#
[
test
]
fn
debug
(
)
{
let
marker
=
unsafe
{
MainThreadMarker
:
:
new_unchecked
(
)
}
;
assert_eq
!
(
std
:
:
format
!
(
"
{
marker
:
?
}
"
)
"
MainThreadMarker
"
)
;
}
#
[
test
]
fn
test_not_main_thread
(
)
{
let
res
=
std
:
:
thread
:
:
spawn
(
|
|
MainThreadMarker
:
:
new
(
)
.
is_none
(
)
)
.
join
(
)
.
unwrap
(
)
;
assert
!
(
res
)
;
}
}
