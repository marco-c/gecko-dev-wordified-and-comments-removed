#
[
macro_export
]
macro_rules
!
extern_methods
{
(
)
=
>
{
}
;
(
/
/
(
#
[
(
m
:
tt
)
*
]
)
*
v
:
vis
unsafe
fn
fn_name
:
ident
(
(
params
:
tt
)
*
)
(
-
>
ret
:
ty
)
?
(
where
(
where
:
ty
:
bound
:
path
)
+
(
)
?
)
?
;
(
rest
:
tt
)
*
)
=
>
{
crate
:
:
__rewrite_self_param
!
{
(
(
params
)
*
)
(
crate
:
:
__extract_method_attributes
)
(
(
#
[
(
m
)
*
]
)
*
)
(
crate
:
:
__extern_methods_method_out
)
(
v
unsafe
fn
fn_name
(
(
params
)
*
)
(
-
>
ret
)
?
)
(
(
(
where
:
bound
)
+
)
?
)
}
crate
:
:
extern_methods
!
(
(
rest
)
*
)
;
}
;
(
/
/
(
#
[
(
m
:
tt
)
*
]
)
*
v
:
vis
fn
fn_name
:
ident
(
(
params
:
tt
)
*
)
(
-
>
ret
:
ty
)
?
(
where
(
where
:
ty
:
bound
:
path
)
+
(
)
?
)
?
;
(
rest
:
tt
)
*
)
=
>
{
crate
:
:
__rewrite_self_param
!
{
(
(
params
)
*
)
(
crate
:
:
__extract_method_attributes
)
(
(
#
[
(
m
)
*
]
)
*
)
(
crate
:
:
__extern_methods_method_out
)
(
v
fn
fn_name
(
(
params
)
*
)
(
-
>
ret
)
?
)
(
(
(
where
:
bound
)
+
)
?
)
}
crate
:
:
extern_methods
!
(
(
rest
)
*
)
;
}
;
(
(
#
[
m
:
meta
]
)
*
unsafe
impl
type
:
ty
{
(
methods
:
tt
)
*
}
(
rest
:
tt
)
*
)
=
>
{
const
_
:
(
)
=
crate
:
:
__macro_helpers
:
:
extern_methods_unsafe_impl
(
)
;
(
#
[
m
]
)
*
impl
<
(
t
(
:
b
(
+
rest
)
*
)
?
)
*
>
type
{
crate
:
:
extern_methods
!
{
(
methods
)
*
}
}
crate
:
:
extern_methods
!
(
(
rest
)
*
)
;
}
;
}
#
[
doc
(
hidden
)
]
#
[
macro_export
]
macro_rules
!
__extern_methods_method_out
{
{
(
(
function_start
:
tt
)
*
)
(
(
where
:
ty
:
bound
:
path
)
*
)
(
__builder_method
:
ident
)
(
receiver
:
expr
)
(
__receiver_ty
:
ty
)
(
(
__params_prefix
:
tt
)
*
)
(
(
params_rest
:
tt
)
*
)
(
method_or_method_id
:
ident
(
(
sel
:
tt
)
*
)
)
(
(
method_family
:
tt
)
*
)
(
(
optional
:
tt
)
*
)
(
(
attr_method
:
tt
)
*
)
(
(
attr_use
:
tt
)
*
)
}
=
>
{
(
attr_method
)
*
(
function_start
)
*
where
(
where
:
bound
)
*
{
crate
:
:
__extern_methods_method_id_deprecated
!
(
method_or_method_id
(
(
sel
)
*
)
)
;
crate
:
:
__extern_methods_no_optional
!
(
(
optional
)
*
)
;
#
[
allow
(
unused_unsafe
)
]
unsafe
{
crate
:
:
__method_msg_send
!
{
(
receiver
)
(
(
sel
)
*
)
(
(
params_rest
)
*
)
(
)
(
)
(
(
method_family
)
*
)
}
}
}
}
;
}
#
[
doc
(
hidden
)
]
#
[
macro_export
]
macro_rules
!
__extern_methods_no_optional
{
(
)
=
>
{
}
;
(
#
[
optional
]
)
=
>
{
crate
:
:
__macro_helpers
:
:
compile_error
!
(
"
#
[
optional
]
is
only
supported
in
extern_protocol
!
"
)
}
;
}
#
[
doc
(
hidden
)
]
#
[
macro_export
]
macro_rules
!
__extern_methods_method_id_deprecated
{
(
method
(
(
sel
:
tt
)
*
)
)
=
>
{
}
;
(
method_id
(
(
sel
:
tt
)
*
)
)
=
>
{
{
#
[
deprecated
=
crate
:
:
__macro_helpers
:
:
concat
!
(
"
using
#
[
unsafe
(
method_id
(
"
crate
:
:
__macro_helpers
:
:
stringify
!
(
(
sel
)
*
)
"
)
)
]
inside
extern_methods
!
is
deprecated
.
\
nUse
#
[
unsafe
(
method
(
"
crate
:
:
__macro_helpers
:
:
stringify
!
(
(
sel
)
*
)
"
)
)
]
instead
"
)
]
#
[
inline
]
fn
method_id
(
)
{
}
method_id
(
)
;
}
}
;
}
#
[
cfg
(
test
)
]
mod
tests
{
use
crate
:
:
extern_methods
;
use
crate
:
:
runtime
:
:
{
NSObject
NSObjectProtocol
}
;
#
[
test
]
fn
outside_impl_using_this
(
)
{
extern_methods
!
(
#
[
unsafe
(
method
(
hash
)
)
]
fn
obj_hash
(
this
:
&
NSObject
)
-
>
usize
;
)
;
let
obj
=
NSObject
:
:
new
(
)
;
assert_eq
!
(
obj_hash
(
&
obj
)
obj
.
hash
(
)
)
}
}
