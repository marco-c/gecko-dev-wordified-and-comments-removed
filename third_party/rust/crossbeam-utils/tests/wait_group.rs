use
std
:
:
sync
:
:
mpsc
;
use
std
:
:
thread
;
use
std
:
:
time
:
:
Duration
;
use
crossbeam_utils
:
:
sync
:
:
WaitGroup
;
const
THREADS
:
usize
=
10
;
#
[
test
]
fn
wait
(
)
{
let
wg
=
WaitGroup
:
:
new
(
)
;
let
(
tx
rx
)
=
mpsc
:
:
channel
(
)
;
for
_
in
0
.
.
THREADS
{
let
wg
=
wg
.
clone
(
)
;
let
tx
=
tx
.
clone
(
)
;
thread
:
:
spawn
(
move
|
|
{
wg
.
wait
(
)
;
tx
.
send
(
(
)
)
.
unwrap
(
)
;
}
)
;
}
thread
:
:
sleep
(
Duration
:
:
from_millis
(
100
)
)
;
assert
!
(
rx
.
try_recv
(
)
.
is_err
(
)
)
;
wg
.
wait
(
)
;
for
_
in
0
.
.
THREADS
{
rx
.
recv
(
)
.
unwrap
(
)
;
}
}
#
[
test
]
#
[
cfg_attr
(
miri
ignore
)
]
fn
wait_and_drop
(
)
{
let
wg
=
WaitGroup
:
:
new
(
)
;
let
(
tx
rx
)
=
mpsc
:
:
channel
(
)
;
for
_
in
0
.
.
THREADS
{
let
wg
=
wg
.
clone
(
)
;
let
tx
=
tx
.
clone
(
)
;
thread
:
:
spawn
(
move
|
|
{
thread
:
:
sleep
(
Duration
:
:
from_millis
(
100
)
)
;
tx
.
send
(
(
)
)
.
unwrap
(
)
;
drop
(
wg
)
;
}
)
;
}
assert
!
(
rx
.
try_recv
(
)
.
is_err
(
)
)
;
wg
.
wait
(
)
;
for
_
in
0
.
.
THREADS
{
rx
.
try_recv
(
)
.
unwrap
(
)
;
}
}
