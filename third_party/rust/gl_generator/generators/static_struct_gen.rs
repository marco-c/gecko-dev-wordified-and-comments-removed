use
registry
:
:
Registry
;
use
std
:
:
io
;
#
[
allow
(
missing_copy_implementations
)
]
pub
struct
StaticStructGenerator
;
impl
super
:
:
Generator
for
StaticStructGenerator
{
fn
write
<
W
>
(
&
self
registry
:
&
Registry
dest
:
&
mut
W
)
-
>
io
:
:
Result
<
(
)
>
where
W
:
io
:
:
Write
{
try
!
(
write_header
(
dest
)
)
;
try
!
(
write_type_aliases
(
registry
dest
)
)
;
try
!
(
write_enums
(
registry
dest
)
)
;
try
!
(
write_struct
(
registry
dest
)
)
;
try
!
(
write_impl
(
registry
dest
)
)
;
try
!
(
write_fns
(
registry
dest
)
)
;
Ok
(
(
)
)
}
}
fn
write_header
<
W
>
(
dest
:
&
mut
W
)
-
>
io
:
:
Result
<
(
)
>
where
W
:
io
:
:
Write
{
writeln
!
(
dest
r
#
"
mod
__gl_imports
{
{
pub
use
std
:
:
mem
;
pub
use
std
:
:
os
:
:
raw
;
}
}
"
#
)
}
fn
write_type_aliases
<
W
>
(
registry
:
&
Registry
dest
:
&
mut
W
)
-
>
io
:
:
Result
<
(
)
>
where
W
:
io
:
:
Write
{
try
!
(
writeln
!
(
dest
r
#
"
pub
mod
types
{
{
#
!
[
allow
(
non_camel_case_types
non_snake_case
dead_code
missing_copy_implementations
)
]
"
#
)
)
;
try
!
(
super
:
:
gen_types
(
registry
.
api
dest
)
)
;
writeln
!
(
dest
"
}
}
"
)
}
fn
write_enums
<
W
>
(
registry
:
&
Registry
dest
:
&
mut
W
)
-
>
io
:
:
Result
<
(
)
>
where
W
:
io
:
:
Write
{
for
enm
in
&
registry
.
enums
{
try
!
(
super
:
:
gen_enum_item
(
enm
"
types
:
:
"
dest
)
)
;
}
Ok
(
(
)
)
}
fn
write_struct
<
W
>
(
registry
:
&
Registry
dest
:
&
mut
W
)
-
>
io
:
:
Result
<
(
)
>
where
W
:
io
:
:
Write
{
writeln
!
(
dest
"
#
[
allow
(
non_camel_case_types
non_snake_case
dead_code
)
]
#
[
derive
(
Copy
Clone
)
]
pub
struct
{
api
}
;
"
api
=
super
:
:
gen_struct_name
(
registry
.
api
)
)
}
fn
write_impl
<
W
>
(
registry
:
&
Registry
dest
:
&
mut
W
)
-
>
io
:
:
Result
<
(
)
>
where
W
:
io
:
:
Write
{
try
!
(
writeln
!
(
dest
"
impl
{
api
}
{
{
/
/
/
Stub
function
.
#
[
allow
(
dead_code
)
]
pub
fn
load_with
<
F
>
(
mut
_loadfn
:
F
)
-
>
{
api
}
where
F
:
FnMut
(
&
str
)
-
>
*
const
__gl_imports
:
:
raw
:
:
c_void
{
{
{
api
}
}
}
"
api
=
super
:
:
gen_struct_name
(
registry
.
api
)
)
)
;
for
cmd
in
&
registry
.
cmds
{
try
!
(
writeln
!
(
dest
"
#
[
allow
(
non_snake_case
)
]
/
/
#
[
allow
(
unused_variables
)
]
#
[
allow
(
dead_code
)
]
#
[
inline
]
pub
unsafe
fn
{
name
}
(
&
self
{
typed_params
}
)
-
>
{
return_suffix
}
{
{
{
name
}
(
{
idents
}
)
}
}
"
name
=
cmd
.
proto
.
ident
typed_params
=
super
:
:
gen_parameters
(
cmd
true
true
)
.
join
(
"
"
)
return_suffix
=
cmd
.
proto
.
ty
idents
=
super
:
:
gen_parameters
(
cmd
true
false
)
.
join
(
"
"
)
)
)
;
}
writeln
!
(
dest
"
}
}
"
)
}
fn
write_fns
<
W
>
(
registry
:
&
Registry
dest
:
&
mut
W
)
-
>
io
:
:
Result
<
(
)
>
where
W
:
io
:
:
Write
{
try
!
(
writeln
!
(
dest
"
#
[
allow
(
non_snake_case
)
]
#
[
allow
(
unused_variables
)
]
#
[
allow
(
dead_code
)
]
extern
\
"
system
\
"
{
{
"
)
)
;
for
cmd
in
&
registry
.
cmds
{
try
!
(
writeln
!
(
dest
"
#
[
link_name
=
\
"
{
symbol
}
\
"
]
fn
{
name
}
(
{
params
}
)
-
>
{
return_suffix
}
;
"
symbol
=
super
:
:
gen_symbol_name
(
registry
.
api
&
cmd
.
proto
.
ident
)
name
=
cmd
.
proto
.
ident
params
=
super
:
:
gen_parameters
(
cmd
true
true
)
.
join
(
"
"
)
return_suffix
=
cmd
.
proto
.
ty
)
)
;
}
writeln
!
(
dest
"
}
}
"
)
}
