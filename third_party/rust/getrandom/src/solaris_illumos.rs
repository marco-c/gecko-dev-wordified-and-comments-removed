use
crate
:
:
util_libc
:
:
{
sys_fill_exact
Weak
}
;
use
crate
:
:
{
use_file
Error
}
;
use
core
:
:
mem
;
#
[
cfg
(
target_os
=
"
illumos
"
)
]
type
GetRandomFn
=
unsafe
extern
"
C
"
fn
(
*
mut
u8
libc
:
:
size_t
libc
:
:
c_uint
)
-
>
libc
:
:
ssize_t
;
#
[
cfg
(
target_os
=
"
solaris
"
)
]
type
GetRandomFn
=
unsafe
extern
"
C
"
fn
(
*
mut
u8
libc
:
:
size_t
libc
:
:
c_uint
)
-
>
libc
:
:
c_int
;
pub
fn
getrandom_inner
(
dest
:
&
mut
[
u8
]
)
-
>
Result
<
(
)
Error
>
{
static
GETRANDOM
:
Weak
=
unsafe
{
Weak
:
:
new
(
"
getrandom
\
0
"
)
}
;
if
let
Some
(
fptr
)
=
GETRANDOM
.
ptr
(
)
{
let
func
:
GetRandomFn
=
unsafe
{
mem
:
:
transmute
(
fptr
)
}
;
for
chunk
in
dest
.
chunks_mut
(
256
)
{
sys_fill_exact
(
chunk
|
buf
|
unsafe
{
func
(
buf
.
as_mut_ptr
(
)
buf
.
len
(
)
0
)
as
libc
:
:
ssize_t
}
)
?
}
Ok
(
(
)
)
}
else
{
use_file
:
:
getrandom_inner
(
dest
)
}
}
