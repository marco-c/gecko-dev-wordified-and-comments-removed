#
include
"
mozilla
/
Types
.
h
"
#
include
"
prlink
.
h
"
#
include
<
xf86drm
.
h
>
#
define
GET_FUNC
(
func
lib
)
\
func
#
#
_fn
=
\
(
decltype
(
func
#
#
_fn
)
)
PR_FindFunctionSymbol
(
lib
#
func
)
\
#
define
IS_FUNC_LOADED
(
func
)
\
(
func
!
=
nullptr
)
\
static
int
(
*
drmGetDevices2_fn
)
(
uint32_t
flags
drmDevicePtr
devices
[
]
int
max_devices
)
;
static
void
(
*
drmFreeDevices_fn
)
(
drmDevicePtr
devices
[
]
int
count
)
;
bool
IsDRMLibraryLoaded
(
)
{
static
bool
isLoaded
=
(
IS_FUNC_LOADED
(
drmGetDevices2_fn
)
&
&
IS_FUNC_LOADED
(
drmFreeDevices_fn
)
)
;
return
isLoaded
;
}
bool
LoadDRMLibrary
(
)
{
static
PRLibrary
*
drmLib
=
nullptr
;
static
bool
drmInitialized
=
false
;
if
(
!
drmInitialized
)
{
drmInitialized
=
true
;
drmLib
=
PR_LoadLibrary
(
"
libdrm
.
so
.
2
"
)
;
if
(
!
drmLib
)
{
return
false
;
}
GET_FUNC
(
drmGetDevices2
drmLib
)
;
GET_FUNC
(
drmFreeDevices
drmLib
)
;
}
return
IsDRMLibraryLoaded
(
)
;
}
int
drmGetDevices2
(
uint32_t
flags
drmDevicePtr
devices
[
]
int
max_devices
)
{
if
(
!
LoadDRMLibrary
(
)
)
{
return
0
;
}
return
drmGetDevices2_fn
(
flags
devices
max_devices
)
;
}
void
drmFreeDevices
(
drmDevicePtr
devices
[
]
int
count
)
{
if
(
!
LoadDRMLibrary
(
)
)
{
return
;
}
return
drmFreeDevices_fn
(
devices
count
)
;
}
