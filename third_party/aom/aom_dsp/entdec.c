#
ifdef
HAVE_CONFIG_H
#
include
"
.
/
config
.
h
"
#
endif
#
include
"
aom_dsp
/
entdec
.
h
"
#
define
OD_EC_LOTS_OF_BITS
(
0x4000
)
static
void
od_ec_dec_refill
(
od_ec_dec
*
dec
)
{
int
s
;
od_ec_window
dif
;
int16_t
cnt
;
const
unsigned
char
*
bptr
;
const
unsigned
char
*
end
;
dif
=
dec
-
>
dif
;
cnt
=
dec
-
>
cnt
;
bptr
=
dec
-
>
bptr
;
end
=
dec
-
>
end
;
s
=
OD_EC_WINDOW_SIZE
-
9
-
(
cnt
+
15
)
;
for
(
;
s
>
=
0
&
&
bptr
<
end
;
s
-
=
8
bptr
+
+
)
{
OD_ASSERT
(
s
<
=
OD_EC_WINDOW_SIZE
-
8
)
;
dif
^
=
(
od_ec_window
)
bptr
[
0
]
<
<
s
;
cnt
+
=
8
;
}
if
(
bptr
>
=
end
)
{
dec
-
>
tell_offs
+
=
OD_EC_LOTS_OF_BITS
-
cnt
;
cnt
=
OD_EC_LOTS_OF_BITS
;
}
dec
-
>
dif
=
dif
;
dec
-
>
cnt
=
cnt
;
dec
-
>
bptr
=
bptr
;
}
static
int
od_ec_dec_normalize
(
od_ec_dec
*
dec
od_ec_window
dif
unsigned
rng
int
ret
)
{
int
d
;
OD_ASSERT
(
rng
<
=
65535U
)
;
d
=
16
-
OD_ILOG_NZ
(
rng
)
;
dec
-
>
cnt
-
=
d
;
dec
-
>
dif
=
(
(
dif
+
1
)
<
<
d
)
-
1
;
dec
-
>
rng
=
rng
<
<
d
;
if
(
dec
-
>
cnt
<
0
)
od_ec_dec_refill
(
dec
)
;
return
ret
;
}
void
od_ec_dec_init
(
od_ec_dec
*
dec
const
unsigned
char
*
buf
uint32_t
storage
)
{
dec
-
>
buf
=
buf
;
dec
-
>
eptr
=
buf
+
storage
;
dec
-
>
end_window
=
0
;
dec
-
>
nend_bits
=
0
;
dec
-
>
tell_offs
=
10
-
(
OD_EC_WINDOW_SIZE
-
8
)
;
dec
-
>
end
=
buf
+
storage
;
dec
-
>
bptr
=
buf
;
dec
-
>
dif
=
(
(
od_ec_window
)
1
<
<
(
OD_EC_WINDOW_SIZE
-
1
)
)
-
1
;
dec
-
>
rng
=
0x8000
;
dec
-
>
cnt
=
-
15
;
dec
-
>
error
=
0
;
od_ec_dec_refill
(
dec
)
;
}
int
od_ec_decode_bool_q15
(
od_ec_dec
*
dec
unsigned
f
)
{
od_ec_window
dif
;
od_ec_window
vw
;
unsigned
r
;
unsigned
r_new
;
unsigned
v
;
int
ret
;
OD_ASSERT
(
0
<
f
)
;
OD_ASSERT
(
f
<
32768U
)
;
dif
=
dec
-
>
dif
;
r
=
dec
-
>
rng
;
OD_ASSERT
(
dif
>
>
(
OD_EC_WINDOW_SIZE
-
16
)
<
r
)
;
OD_ASSERT
(
32768U
<
=
r
)
;
v
=
(
r
>
>
8
)
*
(
uint32_t
)
f
>
>
7
;
vw
=
(
od_ec_window
)
v
<
<
(
OD_EC_WINDOW_SIZE
-
16
)
;
ret
=
1
;
r_new
=
v
;
if
(
dif
>
=
vw
)
{
r_new
=
r
-
v
;
dif
-
=
vw
;
ret
=
0
;
}
return
od_ec_dec_normalize
(
dec
dif
r_new
ret
)
;
}
int
od_ec_decode_cdf_q15
(
od_ec_dec
*
dec
const
uint16_t
*
icdf
int
nsyms
)
{
od_ec_window
dif
;
unsigned
r
;
unsigned
c
;
unsigned
u
;
unsigned
v
;
int
ret
;
(
void
)
nsyms
;
dif
=
dec
-
>
dif
;
r
=
dec
-
>
rng
;
OD_ASSERT
(
dif
>
>
(
OD_EC_WINDOW_SIZE
-
16
)
<
r
)
;
OD_ASSERT
(
icdf
[
nsyms
-
1
]
=
=
OD_ICDF
(
32768U
)
)
;
OD_ASSERT
(
32768U
<
=
r
)
;
c
=
(
unsigned
)
(
dif
>
>
(
OD_EC_WINDOW_SIZE
-
16
)
)
;
v
=
r
;
ret
=
-
1
;
do
{
u
=
v
;
v
=
(
r
>
>
8
)
*
(
uint32_t
)
icdf
[
+
+
ret
]
>
>
7
;
}
while
(
c
<
v
)
;
OD_ASSERT
(
v
<
u
)
;
OD_ASSERT
(
u
<
=
r
)
;
r
=
u
-
v
;
dif
-
=
(
od_ec_window
)
v
<
<
(
OD_EC_WINDOW_SIZE
-
16
)
;
return
od_ec_dec_normalize
(
dec
dif
r
ret
)
;
}
#
if
CONFIG_RAWBITS
uint32_t
od_ec_dec_bits_
(
od_ec_dec
*
dec
unsigned
ftb
)
{
od_ec_window
window
;
int
available
;
uint32_t
ret
;
OD_ASSERT
(
ftb
<
=
25
)
;
window
=
dec
-
>
end_window
;
available
=
dec
-
>
nend_bits
;
if
(
(
unsigned
)
available
<
ftb
)
{
const
unsigned
char
*
buf
;
const
unsigned
char
*
eptr
;
buf
=
dec
-
>
buf
;
eptr
=
dec
-
>
eptr
;
OD_ASSERT
(
available
<
=
OD_EC_WINDOW_SIZE
-
8
)
;
do
{
if
(
eptr
<
=
buf
)
{
dec
-
>
tell_offs
+
=
OD_EC_LOTS_OF_BITS
-
available
;
available
=
OD_EC_LOTS_OF_BITS
;
break
;
}
window
|
=
(
od_ec_window
)
*
-
-
eptr
<
<
available
;
available
+
=
8
;
}
while
(
available
<
=
OD_EC_WINDOW_SIZE
-
8
)
;
dec
-
>
eptr
=
eptr
;
}
ret
=
(
uint32_t
)
window
&
(
(
(
uint32_t
)
1
<
<
ftb
)
-
1
)
;
window
>
>
=
ftb
;
available
-
=
ftb
;
dec
-
>
end_window
=
window
;
dec
-
>
nend_bits
=
available
;
return
ret
;
}
#
endif
int
od_ec_dec_tell
(
const
od_ec_dec
*
dec
)
{
return
(
int
)
(
(
(
dec
-
>
end
-
dec
-
>
eptr
)
+
(
dec
-
>
bptr
-
dec
-
>
buf
)
)
*
8
-
dec
-
>
cnt
-
dec
-
>
nend_bits
+
dec
-
>
tell_offs
)
;
}
uint32_t
od_ec_dec_tell_frac
(
const
od_ec_dec
*
dec
)
{
return
od_ec_tell_frac
(
od_ec_dec_tell
(
dec
)
dec
-
>
rng
)
;
}
