#
ifdef
HAVE_CONFIG_H
#
include
"
config
.
h
"
#
endif
#
include
<
stdio
.
h
>
#
include
"
aom_dsp
/
bitreader
.
h
"
#
include
"
av1
/
common
/
generic_code
.
h
"
#
include
"
av1
/
common
/
odintrin
.
h
"
#
include
"
pvq_decoder
.
h
"
int
aom_decode_cdf_adapt_q15_
(
aom_reader
*
r
uint16_t
*
cdf
int
n
int
*
count
int
rate
ACCT_STR_PARAM
)
{
int
val
;
int
i
;
if
(
*
count
=
=
0
)
{
int
ft
;
ft
=
cdf
[
n
-
1
]
;
for
(
i
=
0
;
i
<
n
;
i
+
+
)
{
cdf
[
i
]
=
AOM_ICDF
(
cdf
[
i
]
*
32768
/
ft
)
;
}
}
val
=
aom_read_cdf
(
r
cdf
n
ACCT_STR_NAME
)
;
aom_cdf_adapt_q15
(
val
cdf
n
count
rate
)
;
return
val
;
}
int
generic_decode_
(
aom_reader
*
r
generic_encoder
*
model
int
*
ex_q16
int
integration
ACCT_STR_PARAM
)
{
int
lg_q1
;
int
shift
;
int
id
;
uint16_t
*
cdf
;
int
xs
;
int
lsb
;
int
x
;
lsb
=
0
;
lg_q1
=
log_ex
(
*
ex_q16
)
;
shift
=
OD_MAXI
(
0
(
lg_q1
-
5
)
>
>
1
)
;
id
=
OD_MINI
(
GENERIC_TABLES
-
1
lg_q1
)
;
cdf
=
model
-
>
cdf
[
id
]
;
xs
=
aom_read_symbol_pvq
(
r
cdf
16
ACCT_STR_NAME
)
;
if
(
xs
=
=
15
)
{
int
e
;
unsigned
decay
;
OD_ASSERT
(
*
ex_q16
<
INT_MAX
>
>
1
)
;
e
=
(
(
2
*
*
ex_q16
>
>
8
)
+
(
1
<
<
shift
>
>
1
)
)
>
>
shift
;
decay
=
OD_MAXI
(
2
OD_MINI
(
254
256
*
e
/
(
e
+
256
)
)
)
;
xs
+
=
aom_laplace_decode_special
(
r
decay
ACCT_STR_NAME
)
;
}
if
(
shift
!
=
0
)
{
int
special
;
special
=
xs
=
=
0
;
if
(
shift
-
special
>
0
)
{
lsb
=
aom_read_literal
(
r
shift
-
special
ACCT_STR_NAME
)
;
}
lsb
-
=
!
special
<
<
(
shift
-
1
)
;
}
x
=
(
xs
<
<
shift
)
+
lsb
;
generic_model_update
(
ex_q16
x
integration
)
;
OD_LOG
(
(
OD_LOG_ENTROPY_CODER
OD_LOG_DEBUG
"
dec
:
%
d
%
d
%
d
%
d
%
d
%
x
"
*
ex_q16
x
shift
id
xs
dec
-
>
rng
)
)
;
return
x
;
}
