#
include
"
config
/
aom_dsp_rtcd
.
h
"
#
include
"
config
/
av1_rtcd
.
h
"
#
include
"
av1
/
common
/
filter
.
h
"
#
include
"
av1
/
common
/
scale
.
h
"
#
include
"
aom_dsp
/
aom_filter
.
h
"
static
INLINE
int
scaled_x
(
int
val
const
struct
scale_factors
*
sf
)
{
const
int
off
=
(
sf
-
>
x_scale_fp
-
(
1
<
<
REF_SCALE_SHIFT
)
)
*
(
1
<
<
(
SUBPEL_BITS
-
1
)
)
;
const
int64_t
tval
=
(
int64_t
)
val
*
sf
-
>
x_scale_fp
+
off
;
return
(
int
)
ROUND_POWER_OF_TWO_SIGNED_64
(
tval
REF_SCALE_SHIFT
-
SCALE_EXTRA_BITS
)
;
}
static
INLINE
int
scaled_y
(
int
val
const
struct
scale_factors
*
sf
)
{
const
int
off
=
(
sf
-
>
y_scale_fp
-
(
1
<
<
REF_SCALE_SHIFT
)
)
*
(
1
<
<
(
SUBPEL_BITS
-
1
)
)
;
const
int64_t
tval
=
(
int64_t
)
val
*
sf
-
>
y_scale_fp
+
off
;
return
(
int
)
ROUND_POWER_OF_TWO_SIGNED_64
(
tval
REF_SCALE_SHIFT
-
SCALE_EXTRA_BITS
)
;
}
static
int
unscaled_value
(
int
val
const
struct
scale_factors
*
sf
)
{
(
void
)
sf
;
return
val
<
<
SCALE_EXTRA_BITS
;
}
static
int
get_fixed_point_scale_factor
(
int
other_size
int
this_size
)
{
return
(
(
other_size
<
<
REF_SCALE_SHIFT
)
+
this_size
/
2
)
/
this_size
;
}
static
int
fixed_point_scale_to_coarse_point_scale
(
int
scale_fp
)
{
return
ROUND_POWER_OF_TWO
(
scale_fp
REF_SCALE_SHIFT
-
SCALE_SUBPEL_BITS
)
;
}
MV32
av1_scale_mv
(
const
MV
*
mvq4
int
x
int
y
const
struct
scale_factors
*
sf
)
{
const
int
x_off_q4
=
scaled_x
(
x
<
<
SUBPEL_BITS
sf
)
;
const
int
y_off_q4
=
scaled_y
(
y
<
<
SUBPEL_BITS
sf
)
;
const
MV32
res
=
{
scaled_y
(
(
y
<
<
SUBPEL_BITS
)
+
mvq4
-
>
row
sf
)
-
y_off_q4
scaled_x
(
(
x
<
<
SUBPEL_BITS
)
+
mvq4
-
>
col
sf
)
-
x_off_q4
}
;
return
res
;
}
void
av1_setup_scale_factors_for_frame
(
struct
scale_factors
*
sf
int
other_w
int
other_h
int
this_w
int
this_h
)
{
if
(
!
valid_ref_frame_size
(
other_w
other_h
this_w
this_h
)
)
{
sf
-
>
x_scale_fp
=
REF_INVALID_SCALE
;
sf
-
>
y_scale_fp
=
REF_INVALID_SCALE
;
return
;
}
sf
-
>
x_scale_fp
=
get_fixed_point_scale_factor
(
other_w
this_w
)
;
sf
-
>
y_scale_fp
=
get_fixed_point_scale_factor
(
other_h
this_h
)
;
sf
-
>
x_step_q4
=
fixed_point_scale_to_coarse_point_scale
(
sf
-
>
x_scale_fp
)
;
sf
-
>
y_step_q4
=
fixed_point_scale_to_coarse_point_scale
(
sf
-
>
y_scale_fp
)
;
if
(
av1_is_scaled
(
sf
)
)
{
sf
-
>
scale_value_x
=
scaled_x
;
sf
-
>
scale_value_y
=
scaled_y
;
}
else
{
sf
-
>
scale_value_x
=
unscaled_value
;
sf
-
>
scale_value_y
=
unscaled_value
;
}
sf
-
>
convolve
[
0
]
[
0
]
[
0
]
=
av1_convolve_2d_copy_sr
;
sf
-
>
convolve
[
0
]
[
1
]
[
0
]
=
av1_convolve_y_sr
;
sf
-
>
convolve
[
1
]
[
0
]
[
0
]
=
av1_convolve_x_sr
;
sf
-
>
convolve
[
1
]
[
1
]
[
0
]
=
av1_convolve_2d_sr
;
sf
-
>
convolve
[
0
]
[
0
]
[
1
]
=
av1_jnt_convolve_2d_copy
;
sf
-
>
convolve
[
0
]
[
1
]
[
1
]
=
av1_jnt_convolve_y
;
sf
-
>
convolve
[
1
]
[
0
]
[
1
]
=
av1_jnt_convolve_x
;
sf
-
>
convolve
[
1
]
[
1
]
[
1
]
=
av1_jnt_convolve_2d
;
sf
-
>
highbd_convolve
[
0
]
[
0
]
[
0
]
=
av1_highbd_convolve_2d_copy_sr
;
sf
-
>
highbd_convolve
[
0
]
[
1
]
[
0
]
=
av1_highbd_convolve_y_sr
;
sf
-
>
highbd_convolve
[
1
]
[
0
]
[
0
]
=
av1_highbd_convolve_x_sr
;
sf
-
>
highbd_convolve
[
1
]
[
1
]
[
0
]
=
av1_highbd_convolve_2d_sr
;
sf
-
>
highbd_convolve
[
0
]
[
0
]
[
1
]
=
av1_highbd_jnt_convolve_2d_copy
;
sf
-
>
highbd_convolve
[
0
]
[
1
]
[
1
]
=
av1_highbd_jnt_convolve_y
;
sf
-
>
highbd_convolve
[
1
]
[
0
]
[
1
]
=
av1_highbd_jnt_convolve_x
;
sf
-
>
highbd_convolve
[
1
]
[
1
]
[
1
]
=
av1_highbd_jnt_convolve_2d
;
}
