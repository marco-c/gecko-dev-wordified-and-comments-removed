#
include
"
av1
/
common
/
common
.
h
"
#
include
"
av1
/
common
/
pred_common
.
h
"
#
include
"
av1
/
common
/
reconinter
.
h
"
#
include
"
av1
/
common
/
reconintra
.
h
"
#
include
"
av1
/
common
/
seg_common
.
h
"
static
InterpFilter
get_ref_filter_type
(
const
MB_MODE_INFO
*
ref_mbmi
const
MACROBLOCKD
*
xd
int
dir
MV_REFERENCE_FRAME
ref_frame
)
{
(
void
)
xd
;
return
(
(
ref_mbmi
-
>
ref_frame
[
0
]
=
=
ref_frame
|
|
ref_mbmi
-
>
ref_frame
[
1
]
=
=
ref_frame
)
?
av1_extract_interp_filter
(
ref_mbmi
-
>
interp_filters
dir
&
0x01
)
:
SWITCHABLE_FILTERS
)
;
}
int
av1_get_pred_context_switchable_interp
(
const
MACROBLOCKD
*
xd
int
dir
)
{
const
MB_MODE_INFO
*
const
mbmi
=
xd
-
>
mi
[
0
]
;
const
int
ctx_offset
=
(
mbmi
-
>
ref_frame
[
1
]
>
INTRA_FRAME
)
*
INTER_FILTER_COMP_OFFSET
;
MV_REFERENCE_FRAME
ref_frame
=
(
dir
<
2
)
?
mbmi
-
>
ref_frame
[
0
]
:
mbmi
-
>
ref_frame
[
1
]
;
int
filter_type_ctx
=
ctx_offset
+
(
dir
&
0x01
)
*
INTER_FILTER_DIR_OFFSET
;
int
left_type
=
SWITCHABLE_FILTERS
;
int
above_type
=
SWITCHABLE_FILTERS
;
if
(
xd
-
>
left_available
)
left_type
=
get_ref_filter_type
(
xd
-
>
mi
[
-
1
]
xd
dir
ref_frame
)
;
if
(
xd
-
>
up_available
)
above_type
=
get_ref_filter_type
(
xd
-
>
mi
[
-
xd
-
>
mi_stride
]
xd
dir
ref_frame
)
;
if
(
left_type
=
=
above_type
)
{
filter_type_ctx
+
=
left_type
;
}
else
if
(
left_type
=
=
SWITCHABLE_FILTERS
)
{
assert
(
above_type
!
=
SWITCHABLE_FILTERS
)
;
filter_type_ctx
+
=
above_type
;
}
else
if
(
above_type
=
=
SWITCHABLE_FILTERS
)
{
assert
(
left_type
!
=
SWITCHABLE_FILTERS
)
;
filter_type_ctx
+
=
left_type
;
}
else
{
filter_type_ctx
+
=
SWITCHABLE_FILTERS
;
}
return
filter_type_ctx
;
}
static
void
palette_add_to_cache
(
uint16_t
*
cache
int
*
n
uint16_t
val
)
{
if
(
*
n
>
0
&
&
val
=
=
cache
[
*
n
-
1
]
)
return
;
cache
[
(
*
n
)
+
+
]
=
val
;
}
int
av1_get_palette_cache
(
const
MACROBLOCKD
*
const
xd
int
plane
uint16_t
*
cache
)
{
const
int
row
=
-
xd
-
>
mb_to_top_edge
>
>
3
;
const
MB_MODE_INFO
*
const
above_mi
=
(
row
%
(
1
<
<
MIN_SB_SIZE_LOG2
)
)
?
xd
-
>
above_mbmi
:
NULL
;
const
MB_MODE_INFO
*
const
left_mi
=
xd
-
>
left_mbmi
;
int
above_n
=
0
left_n
=
0
;
if
(
above_mi
)
above_n
=
above_mi
-
>
palette_mode_info
.
palette_size
[
plane
!
=
0
]
;
if
(
left_mi
)
left_n
=
left_mi
-
>
palette_mode_info
.
palette_size
[
plane
!
=
0
]
;
if
(
above_n
=
=
0
&
&
left_n
=
=
0
)
return
0
;
int
above_idx
=
plane
*
PALETTE_MAX_SIZE
;
int
left_idx
=
plane
*
PALETTE_MAX_SIZE
;
int
n
=
0
;
const
uint16_t
*
above_colors
=
above_mi
?
above_mi
-
>
palette_mode_info
.
palette_colors
:
NULL
;
const
uint16_t
*
left_colors
=
left_mi
?
left_mi
-
>
palette_mode_info
.
palette_colors
:
NULL
;
while
(
above_n
>
0
&
&
left_n
>
0
)
{
uint16_t
v_above
=
above_colors
[
above_idx
]
;
uint16_t
v_left
=
left_colors
[
left_idx
]
;
if
(
v_left
<
v_above
)
{
palette_add_to_cache
(
cache
&
n
v_left
)
;
+
+
left_idx
-
-
left_n
;
}
else
{
palette_add_to_cache
(
cache
&
n
v_above
)
;
+
+
above_idx
-
-
above_n
;
if
(
v_left
=
=
v_above
)
+
+
left_idx
-
-
left_n
;
}
}
while
(
above_n
-
-
>
0
)
{
uint16_t
val
=
above_colors
[
above_idx
+
+
]
;
palette_add_to_cache
(
cache
&
n
val
)
;
}
while
(
left_n
-
-
>
0
)
{
uint16_t
val
=
left_colors
[
left_idx
+
+
]
;
palette_add_to_cache
(
cache
&
n
val
)
;
}
assert
(
n
<
=
2
*
PALETTE_MAX_SIZE
)
;
return
n
;
}
int
av1_get_intra_inter_context
(
const
MACROBLOCKD
*
xd
)
{
const
MB_MODE_INFO
*
const
above_mbmi
=
xd
-
>
above_mbmi
;
const
MB_MODE_INFO
*
const
left_mbmi
=
xd
-
>
left_mbmi
;
const
int
has_above
=
xd
-
>
up_available
;
const
int
has_left
=
xd
-
>
left_available
;
if
(
has_above
&
&
has_left
)
{
const
int
above_intra
=
!
is_inter_block
(
above_mbmi
)
;
const
int
left_intra
=
!
is_inter_block
(
left_mbmi
)
;
return
left_intra
&
&
above_intra
?
3
:
left_intra
|
|
above_intra
;
}
else
if
(
has_above
|
|
has_left
)
{
return
2
*
!
is_inter_block
(
has_above
?
above_mbmi
:
left_mbmi
)
;
}
else
{
return
0
;
}
}
#
define
CHECK_BACKWARD_REFS
(
ref_frame
)
\
(
(
(
ref_frame
)
>
=
BWDREF_FRAME
)
&
&
(
(
ref_frame
)
<
=
ALTREF_FRAME
)
)
#
define
IS_BACKWARD_REF_FRAME
(
ref_frame
)
CHECK_BACKWARD_REFS
(
ref_frame
)
int
av1_get_reference_mode_context
(
const
MACROBLOCKD
*
xd
)
{
int
ctx
;
const
MB_MODE_INFO
*
const
above_mbmi
=
xd
-
>
above_mbmi
;
const
MB_MODE_INFO
*
const
left_mbmi
=
xd
-
>
left_mbmi
;
const
int
has_above
=
xd
-
>
up_available
;
const
int
has_left
=
xd
-
>
left_available
;
if
(
has_above
&
&
has_left
)
{
if
(
!
has_second_ref
(
above_mbmi
)
&
&
!
has_second_ref
(
left_mbmi
)
)
ctx
=
IS_BACKWARD_REF_FRAME
(
above_mbmi
-
>
ref_frame
[
0
]
)
^
IS_BACKWARD_REF_FRAME
(
left_mbmi
-
>
ref_frame
[
0
]
)
;
else
if
(
!
has_second_ref
(
above_mbmi
)
)
ctx
=
2
+
(
IS_BACKWARD_REF_FRAME
(
above_mbmi
-
>
ref_frame
[
0
]
)
|
|
!
is_inter_block
(
above_mbmi
)
)
;
else
if
(
!
has_second_ref
(
left_mbmi
)
)
ctx
=
2
+
(
IS_BACKWARD_REF_FRAME
(
left_mbmi
-
>
ref_frame
[
0
]
)
|
|
!
is_inter_block
(
left_mbmi
)
)
;
else
ctx
=
4
;
}
else
if
(
has_above
|
|
has_left
)
{
const
MB_MODE_INFO
*
edge_mbmi
=
has_above
?
above_mbmi
:
left_mbmi
;
if
(
!
has_second_ref
(
edge_mbmi
)
)
ctx
=
IS_BACKWARD_REF_FRAME
(
edge_mbmi
-
>
ref_frame
[
0
]
)
;
else
ctx
=
3
;
}
else
{
ctx
=
1
;
}
assert
(
ctx
>
=
0
&
&
ctx
<
COMP_INTER_CONTEXTS
)
;
return
ctx
;
}
int
av1_get_comp_reference_type_context
(
const
MACROBLOCKD
*
xd
)
{
int
pred_context
;
const
MB_MODE_INFO
*
const
above_mbmi
=
xd
-
>
above_mbmi
;
const
MB_MODE_INFO
*
const
left_mbmi
=
xd
-
>
left_mbmi
;
const
int
above_in_image
=
xd
-
>
up_available
;
const
int
left_in_image
=
xd
-
>
left_available
;
if
(
above_in_image
&
&
left_in_image
)
{
const
int
above_intra
=
!
is_inter_block
(
above_mbmi
)
;
const
int
left_intra
=
!
is_inter_block
(
left_mbmi
)
;
if
(
above_intra
&
&
left_intra
)
{
pred_context
=
2
;
}
else
if
(
above_intra
|
|
left_intra
)
{
const
MB_MODE_INFO
*
inter_mbmi
=
above_intra
?
left_mbmi
:
above_mbmi
;
if
(
!
has_second_ref
(
inter_mbmi
)
)
pred_context
=
2
;
else
pred_context
=
1
+
2
*
has_uni_comp_refs
(
inter_mbmi
)
;
}
else
{
const
int
a_sg
=
!
has_second_ref
(
above_mbmi
)
;
const
int
l_sg
=
!
has_second_ref
(
left_mbmi
)
;
const
MV_REFERENCE_FRAME
frfa
=
above_mbmi
-
>
ref_frame
[
0
]
;
const
MV_REFERENCE_FRAME
frfl
=
left_mbmi
-
>
ref_frame
[
0
]
;
if
(
a_sg
&
&
l_sg
)
{
pred_context
=
1
+
2
*
(
!
(
IS_BACKWARD_REF_FRAME
(
frfa
)
^
IS_BACKWARD_REF_FRAME
(
frfl
)
)
)
;
}
else
if
(
l_sg
|
|
a_sg
)
{
const
int
uni_rfc
=
a_sg
?
has_uni_comp_refs
(
left_mbmi
)
:
has_uni_comp_refs
(
above_mbmi
)
;
if
(
!
uni_rfc
)
pred_context
=
1
;
else
pred_context
=
3
+
(
!
(
IS_BACKWARD_REF_FRAME
(
frfa
)
^
IS_BACKWARD_REF_FRAME
(
frfl
)
)
)
;
}
else
{
const
int
a_uni_rfc
=
has_uni_comp_refs
(
above_mbmi
)
;
const
int
l_uni_rfc
=
has_uni_comp_refs
(
left_mbmi
)
;
if
(
!
a_uni_rfc
&
&
!
l_uni_rfc
)
pred_context
=
0
;
else
if
(
!
a_uni_rfc
|
|
!
l_uni_rfc
)
pred_context
=
2
;
else
pred_context
=
3
+
(
!
(
(
frfa
=
=
BWDREF_FRAME
)
^
(
frfl
=
=
BWDREF_FRAME
)
)
)
;
}
}
}
else
if
(
above_in_image
|
|
left_in_image
)
{
const
MB_MODE_INFO
*
edge_mbmi
=
above_in_image
?
above_mbmi
:
left_mbmi
;
if
(
!
is_inter_block
(
edge_mbmi
)
)
{
pred_context
=
2
;
}
else
{
if
(
!
has_second_ref
(
edge_mbmi
)
)
pred_context
=
2
;
else
pred_context
=
4
*
has_uni_comp_refs
(
edge_mbmi
)
;
}
}
else
{
pred_context
=
2
;
}
assert
(
pred_context
>
=
0
&
&
pred_context
<
COMP_REF_TYPE_CONTEXTS
)
;
return
pred_context
;
}
int
av1_get_pred_context_uni_comp_ref_p
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
frf_count
=
ref_counts
[
LAST_FRAME
]
+
ref_counts
[
LAST2_FRAME
]
+
ref_counts
[
LAST3_FRAME
]
+
ref_counts
[
GOLDEN_FRAME
]
;
const
int
brf_count
=
ref_counts
[
BWDREF_FRAME
]
+
ref_counts
[
ALTREF2_FRAME
]
+
ref_counts
[
ALTREF_FRAME
]
;
const
int
pred_context
=
(
frf_count
=
=
brf_count
)
?
1
:
(
(
frf_count
<
brf_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
UNI_COMP_REF_CONTEXTS
)
;
return
pred_context
;
}
int
av1_get_pred_context_uni_comp_ref_p1
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
last2_count
=
ref_counts
[
LAST2_FRAME
]
;
const
int
last3_or_gld_count
=
ref_counts
[
LAST3_FRAME
]
+
ref_counts
[
GOLDEN_FRAME
]
;
const
int
pred_context
=
(
last2_count
=
=
last3_or_gld_count
)
?
1
:
(
(
last2_count
<
last3_or_gld_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
UNI_COMP_REF_CONTEXTS
)
;
return
pred_context
;
}
int
av1_get_pred_context_uni_comp_ref_p2
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
last3_count
=
ref_counts
[
LAST3_FRAME
]
;
const
int
gld_count
=
ref_counts
[
GOLDEN_FRAME
]
;
const
int
pred_context
=
(
last3_count
=
=
gld_count
)
?
1
:
(
(
last3_count
<
gld_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
UNI_COMP_REF_CONTEXTS
)
;
return
pred_context
;
}
static
int
get_pred_context_ll2_or_l3gld
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
last_last2_count
=
ref_counts
[
LAST_FRAME
]
+
ref_counts
[
LAST2_FRAME
]
;
const
int
last3_gld_count
=
ref_counts
[
LAST3_FRAME
]
+
ref_counts
[
GOLDEN_FRAME
]
;
const
int
pred_context
=
(
last_last2_count
=
=
last3_gld_count
)
?
1
:
(
(
last_last2_count
<
last3_gld_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
REF_CONTEXTS
)
;
return
pred_context
;
}
static
int
get_pred_context_last_or_last2
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
last_count
=
ref_counts
[
LAST_FRAME
]
;
const
int
last2_count
=
ref_counts
[
LAST2_FRAME
]
;
const
int
pred_context
=
(
last_count
=
=
last2_count
)
?
1
:
(
(
last_count
<
last2_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
REF_CONTEXTS
)
;
return
pred_context
;
}
static
int
get_pred_context_last3_or_gld
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
last3_count
=
ref_counts
[
LAST3_FRAME
]
;
const
int
gld_count
=
ref_counts
[
GOLDEN_FRAME
]
;
const
int
pred_context
=
(
last3_count
=
=
gld_count
)
?
1
:
(
(
last3_count
<
gld_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
REF_CONTEXTS
)
;
return
pred_context
;
}
static
int
get_pred_context_brfarf2_or_arf
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
brfarf2_count
=
ref_counts
[
BWDREF_FRAME
]
+
ref_counts
[
ALTREF2_FRAME
]
;
const
int
arf_count
=
ref_counts
[
ALTREF_FRAME
]
;
const
int
pred_context
=
(
brfarf2_count
=
=
arf_count
)
?
1
:
(
(
brfarf2_count
<
arf_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
REF_CONTEXTS
)
;
return
pred_context
;
}
static
int
get_pred_context_brf_or_arf2
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
brf_count
=
ref_counts
[
BWDREF_FRAME
]
;
const
int
arf2_count
=
ref_counts
[
ALTREF2_FRAME
]
;
const
int
pred_context
=
(
brf_count
=
=
arf2_count
)
?
1
:
(
(
brf_count
<
arf2_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
REF_CONTEXTS
)
;
return
pred_context
;
}
int
av1_get_pred_context_comp_ref_p
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_ll2_or_l3gld
(
xd
)
;
}
int
av1_get_pred_context_comp_ref_p1
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_last_or_last2
(
xd
)
;
}
int
av1_get_pred_context_comp_ref_p2
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_last3_or_gld
(
xd
)
;
}
int
av1_get_pred_context_comp_bwdref_p
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_brfarf2_or_arf
(
xd
)
;
}
int
av1_get_pred_context_comp_bwdref_p1
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_brf_or_arf2
(
xd
)
;
}
int
av1_get_pred_context_single_ref_p1
(
const
MACROBLOCKD
*
xd
)
{
const
uint8_t
*
const
ref_counts
=
&
xd
-
>
neighbors_ref_counts
[
0
]
;
const
int
fwd_count
=
ref_counts
[
LAST_FRAME
]
+
ref_counts
[
LAST2_FRAME
]
+
ref_counts
[
LAST3_FRAME
]
+
ref_counts
[
GOLDEN_FRAME
]
;
const
int
bwd_count
=
ref_counts
[
BWDREF_FRAME
]
+
ref_counts
[
ALTREF2_FRAME
]
+
ref_counts
[
ALTREF_FRAME
]
;
const
int
pred_context
=
(
fwd_count
=
=
bwd_count
)
?
1
:
(
(
fwd_count
<
bwd_count
)
?
0
:
2
)
;
assert
(
pred_context
>
=
0
&
&
pred_context
<
REF_CONTEXTS
)
;
return
pred_context
;
}
int
av1_get_pred_context_single_ref_p2
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_brfarf2_or_arf
(
xd
)
;
}
int
av1_get_pred_context_single_ref_p3
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_ll2_or_l3gld
(
xd
)
;
}
int
av1_get_pred_context_single_ref_p4
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_last_or_last2
(
xd
)
;
}
int
av1_get_pred_context_single_ref_p5
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_last3_or_gld
(
xd
)
;
}
int
av1_get_pred_context_single_ref_p6
(
const
MACROBLOCKD
*
xd
)
{
return
get_pred_context_brf_or_arf2
(
xd
)
;
}
