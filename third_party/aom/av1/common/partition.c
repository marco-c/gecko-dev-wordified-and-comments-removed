#
ifdef
HAVE_CONFIG_H
#
include
"
config
.
h
"
#
endif
#
include
"
enums
.
h
"
#
include
"
odintrin
.
h
"
#
include
"
partition
.
h
"
#
include
"
zigzag
.
h
"
OD_EXTERN
const
index_pair
*
OD_ZIGZAG4
[
4
]
=
{
OD_ZIGZAG4_DCT_DCT
OD_ZIGZAG4_ADST_DCT
OD_ZIGZAG4_DCT_ADST
OD_ZIGZAG4_ADST_ADST
}
;
OD_EXTERN
const
index_pair
*
OD_ZIGZAG8
[
4
]
=
{
OD_ZIGZAG8_DCT_DCT
OD_ZIGZAG8_ADST_DCT
OD_ZIGZAG8_DCT_ADST
OD_ZIGZAG8_ADST_ADST
}
;
OD_EXTERN
const
index_pair
*
OD_ZIGZAG16
[
4
]
=
{
OD_ZIGZAG16_DCT_DCT
OD_ZIGZAG16_ADST_DCT
OD_ZIGZAG16_DCT_ADST
OD_ZIGZAG16_ADST_ADST
}
;
OD_EXTERN
const
index_pair
*
OD_ZIGZAG32
[
4
]
=
{
OD_ZIGZAG32_DCT_DCT
OD_ZIGZAG32_DCT_DCT
OD_ZIGZAG32_DCT_DCT
OD_ZIGZAG32_DCT_DCT
}
;
static
const
int
OD_LAYOUT32_OFFSETS
[
4
]
=
{
0
128
256
768
}
;
const
band_layout
OD_LAYOUT32
=
{
OD_ZIGZAG32
32
3
OD_LAYOUT32_OFFSETS
}
;
static
const
int
OD_LAYOUT16_OFFSETS
[
4
]
=
{
0
32
64
192
}
;
const
band_layout
OD_LAYOUT16
=
{
OD_ZIGZAG16
16
3
OD_LAYOUT16_OFFSETS
}
;
const
int
OD_LAYOUT8_OFFSETS
[
4
]
=
{
0
8
16
48
}
;
const
band_layout
OD_LAYOUT8
=
{
OD_ZIGZAG8
8
3
OD_LAYOUT8_OFFSETS
}
;
static
const
int
OD_LAYOUT4_OFFSETS
[
2
]
=
{
0
15
}
;
const
band_layout
OD_LAYOUT4
=
{
OD_ZIGZAG4
4
1
OD_LAYOUT4_OFFSETS
}
;
static
const
int
OD_BAND_OFFSETS4
[
]
=
{
1
1
16
}
;
static
const
int
OD_BAND_OFFSETS8
[
]
=
{
4
1
16
24
32
64
}
;
static
const
int
OD_BAND_OFFSETS16
[
]
=
{
7
1
16
24
32
64
96
128
256
}
;
static
const
int
OD_BAND_OFFSETS32
[
]
=
{
10
1
16
24
32
64
96
128
256
384
512
1024
}
;
static
const
int
OD_BAND_OFFSETS64
[
]
=
{
13
1
16
24
32
64
96
128
256
384
512
1024
1536
2048
4096
}
;
const
int
*
const
OD_BAND_OFFSETS
[
OD_TXSIZES
+
1
]
=
{
OD_BAND_OFFSETS4
OD_BAND_OFFSETS8
OD_BAND_OFFSETS16
OD_BAND_OFFSETS32
OD_BAND_OFFSETS64
}
;
static
void
od_band_from_raster
(
const
band_layout
*
layout
tran_low_t
*
dst
const
tran_low_t
*
src
int
stride
TX_TYPE
tx_type
)
{
int
i
;
int
len
;
len
=
layout
-
>
band_offsets
[
layout
-
>
nb_bands
]
;
for
(
i
=
0
;
i
<
len
;
i
+
+
)
{
dst
[
i
]
=
src
[
layout
-
>
dst_table
[
tx_type
]
[
i
]
[
1
]
*
stride
+
layout
-
>
dst_table
[
tx_type
]
[
i
]
[
0
]
]
;
}
}
static
void
od_raster_from_band
(
const
band_layout
*
layout
tran_low_t
*
dst
int
stride
TX_TYPE
tx_type
const
tran_low_t
*
src
)
{
int
i
;
int
len
;
len
=
layout
-
>
band_offsets
[
layout
-
>
nb_bands
]
;
for
(
i
=
0
;
i
<
len
;
i
+
+
)
{
dst
[
layout
-
>
dst_table
[
tx_type
]
[
i
]
[
1
]
*
stride
+
layout
-
>
dst_table
[
tx_type
]
[
i
]
[
0
]
]
=
src
[
i
]
;
}
}
static
const
band_layout
*
const
OD_LAYOUTS
[
]
=
{
&
OD_LAYOUT4
&
OD_LAYOUT8
&
OD_LAYOUT16
&
OD_LAYOUT32
}
;
void
od_raster_to_coding_order
(
tran_low_t
*
dst
int
n
TX_TYPE
ty_type
const
tran_low_t
*
src
int
stride
)
{
int
bs
;
od_band_from_raster
(
OD_LAYOUTS
[
0
]
dst
+
1
src
stride
ty_type
)
;
for
(
bs
=
1
;
bs
<
OD_TXSIZES
;
bs
+
+
)
{
int
size
;
int
offset
;
size
=
1
<
<
(
OD_LOG_BSIZE0
+
bs
)
;
offset
=
1
<
<
2
*
(
OD_LOG_BSIZE0
-
1
+
bs
)
;
if
(
n
>
=
size
)
{
od_band_from_raster
(
OD_LAYOUTS
[
bs
]
dst
+
offset
src
stride
ty_type
)
;
}
}
dst
[
0
]
=
src
[
0
]
;
}
void
od_coding_order_to_raster
(
tran_low_t
*
dst
int
stride
TX_TYPE
ty_type
const
tran_low_t
*
src
int
n
)
{
int
bs
;
od_raster_from_band
(
OD_LAYOUTS
[
0
]
dst
stride
ty_type
src
+
1
)
;
for
(
bs
=
1
;
bs
<
OD_TXSIZES
;
bs
+
+
)
{
int
size
;
int
offset
;
size
=
1
<
<
(
OD_LOG_BSIZE0
+
bs
)
;
offset
=
1
<
<
2
*
(
OD_LOG_BSIZE0
-
1
+
bs
)
;
if
(
n
>
=
size
)
{
od_raster_from_band
(
OD_LAYOUTS
[
bs
]
dst
stride
ty_type
src
+
offset
)
;
}
}
dst
[
0
]
=
src
[
0
]
;
}
static
void
od_band_from_raster_16
(
const
band_layout
*
layout
int16_t
*
dst
const
int16_t
*
src
int
stride
)
{
int
i
;
int
len
;
len
=
layout
-
>
band_offsets
[
layout
-
>
nb_bands
]
;
for
(
i
=
0
;
i
<
len
;
i
+
+
)
{
dst
[
i
]
=
src
[
layout
-
>
dst_table
[
DCT_DCT
]
[
i
]
[
1
]
*
stride
+
layout
-
>
dst_table
[
DCT_DCT
]
[
i
]
[
0
]
]
;
}
}
void
od_raster_to_coding_order_16
(
int16_t
*
dst
int
n
const
int16_t
*
src
int
stride
)
{
int
bs
;
od_band_from_raster_16
(
OD_LAYOUTS
[
0
]
dst
+
1
src
stride
)
;
for
(
bs
=
1
;
bs
<
OD_TXSIZES
;
bs
+
+
)
{
int
size
;
int
offset
;
size
=
1
<
<
(
OD_LOG_BSIZE0
+
bs
)
;
offset
=
1
<
<
2
*
(
OD_LOG_BSIZE0
-
1
+
bs
)
;
if
(
n
>
=
size
)
{
od_band_from_raster_16
(
OD_LAYOUTS
[
bs
]
dst
+
offset
src
stride
)
;
}
}
dst
[
0
]
=
src
[
0
]
;
}
