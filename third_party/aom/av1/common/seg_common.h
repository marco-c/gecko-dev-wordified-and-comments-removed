#
ifndef
AV1_COMMON_SEG_COMMON_H_
#
define
AV1_COMMON_SEG_COMMON_H_
#
include
"
aom_dsp
/
prob
.
h
"
#
ifdef
__cplusplus
extern
"
C
"
{
#
endif
#
define
MAX_SEGMENTS
8
#
define
SEG_TREE_PROBS
(
MAX_SEGMENTS
-
1
)
#
define
SEG_TEMPORAL_PRED_CTXS
3
#
define
SPATIAL_PREDICTION_PROBS
3
typedef
enum
{
SEG_LVL_ALT_Q
SEG_LVL_ALT_LF_Y_V
SEG_LVL_ALT_LF_Y_H
SEG_LVL_ALT_LF_U
SEG_LVL_ALT_LF_V
SEG_LVL_REF_FRAME
SEG_LVL_SKIP
SEG_LVL_GLOBALMV
SEG_LVL_MAX
}
SEG_LVL_FEATURES
;
struct
segmentation
{
uint8_t
enabled
;
uint8_t
update_map
;
uint8_t
update_data
;
uint8_t
temporal_update
;
int16_t
feature_data
[
MAX_SEGMENTS
]
[
SEG_LVL_MAX
]
;
unsigned
int
feature_mask
[
MAX_SEGMENTS
]
;
int
last_active_segid
;
uint8_t
segid_preskip
;
}
;
struct
segmentation_probs
{
aom_cdf_prob
tree_cdf
[
CDF_SIZE
(
MAX_SEGMENTS
)
]
;
aom_cdf_prob
pred_cdf
[
SEG_TEMPORAL_PRED_CTXS
]
[
CDF_SIZE
(
2
)
]
;
aom_cdf_prob
spatial_pred_seg_cdf
[
SPATIAL_PREDICTION_PROBS
]
[
CDF_SIZE
(
MAX_SEGMENTS
)
]
;
}
;
static
INLINE
int
segfeature_active
(
const
struct
segmentation
*
seg
int
segment_id
SEG_LVL_FEATURES
feature_id
)
{
return
seg
-
>
enabled
&
&
(
seg
-
>
feature_mask
[
segment_id
]
&
(
1
<
<
feature_id
)
)
;
}
static
INLINE
void
segfeatures_copy
(
struct
segmentation
*
dst
const
struct
segmentation
*
src
)
{
int
i
j
;
for
(
i
=
0
;
i
<
MAX_SEGMENTS
;
i
+
+
)
{
dst
-
>
feature_mask
[
i
]
=
src
-
>
feature_mask
[
i
]
;
for
(
j
=
0
;
j
<
SEG_LVL_MAX
;
j
+
+
)
{
dst
-
>
feature_data
[
i
]
[
j
]
=
src
-
>
feature_data
[
i
]
[
j
]
;
}
}
dst
-
>
segid_preskip
=
src
-
>
segid_preskip
;
dst
-
>
last_active_segid
=
src
-
>
last_active_segid
;
}
void
av1_clearall_segfeatures
(
struct
segmentation
*
seg
)
;
void
av1_enable_segfeature
(
struct
segmentation
*
seg
int
segment_id
SEG_LVL_FEATURES
feature_id
)
;
void
calculate_segdata
(
struct
segmentation
*
seg
)
;
int
av1_seg_feature_data_max
(
SEG_LVL_FEATURES
feature_id
)
;
int
av1_is_segfeature_signed
(
SEG_LVL_FEATURES
feature_id
)
;
void
av1_set_segdata
(
struct
segmentation
*
seg
int
segment_id
SEG_LVL_FEATURES
feature_id
int
seg_data
)
;
static
INLINE
int
get_segdata
(
const
struct
segmentation
*
seg
int
segment_id
SEG_LVL_FEATURES
feature_id
)
{
return
seg
-
>
feature_data
[
segment_id
]
[
feature_id
]
;
}
#
ifdef
__cplusplus
}
#
endif
#
endif
