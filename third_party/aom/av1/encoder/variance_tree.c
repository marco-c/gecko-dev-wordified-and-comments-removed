#
include
"
av1
/
encoder
/
variance_tree
.
h
"
#
include
"
av1
/
encoder
/
encoder
.
h
"
void
av1_setup_var_tree
(
struct
AV1Common
*
cm
ThreadData
*
td
)
{
int
i
j
;
#
if
CONFIG_EXT_PARTITION
const
int
leaf_nodes
=
1024
;
const
int
tree_nodes
=
1024
+
256
+
64
+
16
+
4
+
1
;
#
else
const
int
leaf_nodes
=
256
;
const
int
tree_nodes
=
256
+
64
+
16
+
4
+
1
;
#
endif
int
index
=
0
;
VAR_TREE
*
this_var
;
int
nodes
;
aom_free
(
td
-
>
var_tree
)
;
CHECK_MEM_ERROR
(
cm
td
-
>
var_tree
aom_calloc
(
tree_nodes
sizeof
(
*
td
-
>
var_tree
)
)
)
;
this_var
=
&
td
-
>
var_tree
[
0
]
;
for
(
index
=
0
;
index
<
leaf_nodes
;
+
+
index
)
{
VAR_TREE
*
const
leaf
=
&
td
-
>
var_tree
[
index
]
;
leaf
-
>
split
[
0
]
=
NULL
;
}
for
(
nodes
=
leaf_nodes
>
>
2
;
nodes
>
0
;
nodes
>
>
=
2
)
{
for
(
i
=
0
;
i
<
nodes
;
+
+
i
+
+
index
)
{
VAR_TREE
*
const
node
=
&
td
-
>
var_tree
[
index
]
;
for
(
j
=
0
;
j
<
4
;
j
+
+
)
node
-
>
split
[
j
]
=
this_var
+
+
;
}
}
i
=
MAX_MIB_SIZE_LOG2
-
MIN_MIB_SIZE_LOG2
;
td
-
>
var_root
[
i
]
=
&
td
-
>
var_tree
[
tree_nodes
-
1
]
;
while
(
-
-
i
>
=
0
)
{
td
-
>
var_root
[
i
]
=
td
-
>
var_root
[
i
+
1
]
-
>
split
[
0
]
;
}
}
void
av1_free_var_tree
(
ThreadData
*
td
)
{
aom_free
(
td
-
>
var_tree
)
;
td
-
>
var_tree
=
NULL
;
}
