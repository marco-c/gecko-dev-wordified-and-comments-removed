#
ifndef
AOM_AOM_INTERNAL_AOM_CODEC_INTERNAL_H_
#
define
AOM_AOM_INTERNAL_AOM_CODEC_INTERNAL_H_
#
include
"
.
.
/
aom_decoder
.
h
"
#
include
"
.
.
/
aom_encoder
.
h
"
#
include
"
common
/
args_helper
.
h
"
#
include
<
stdarg
.
h
>
#
ifdef
__cplusplus
extern
"
C
"
{
#
endif
#
define
AOM_CODEC_INTERNAL_ABI_VERSION
(
7
)
/
*
*
<
\
hideinitializer
*
/
typedef
struct
aom_codec_alg_priv
aom_codec_alg_priv_t
;
typedef
aom_codec_err_t
(
*
aom_codec_init_fn_t
)
(
aom_codec_ctx_t
*
ctx
)
;
typedef
aom_codec_err_t
(
*
aom_codec_destroy_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
)
;
typedef
aom_codec_err_t
(
*
aom_codec_peek_si_fn_t
)
(
const
uint8_t
*
data
size_t
data_sz
aom_codec_stream_info_t
*
si
)
;
typedef
aom_codec_err_t
(
*
aom_codec_get_si_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
aom_codec_stream_info_t
*
si
)
;
typedef
aom_codec_err_t
(
*
aom_codec_control_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
va_list
ap
)
;
typedef
aom_codec_err_t
(
*
aom_codec_set_option_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
const
char
*
name
const
char
*
value
)
;
typedef
const
struct
aom_codec_ctrl_fn_map
{
int
ctrl_id
;
aom_codec_control_fn_t
fn
;
}
aom_codec_ctrl_fn_map_t
;
#
define
CTRL_MAP_END
\
{
0
NULL
}
static
inline
int
at_ctrl_map_end
(
aom_codec_ctrl_fn_map_t
*
e
)
{
return
e
-
>
ctrl_id
=
=
0
&
&
e
-
>
fn
=
=
NULL
;
}
typedef
aom_codec_err_t
(
*
aom_codec_decode_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
const
uint8_t
*
data
size_t
data_sz
void
*
user_priv
)
;
typedef
aom_image_t
*
(
*
aom_codec_get_frame_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
aom_codec_iter_t
*
iter
)
;
typedef
aom_codec_err_t
(
*
aom_codec_set_fb_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
aom_get_frame_buffer_cb_fn_t
cb_get
aom_release_frame_buffer_cb_fn_t
cb_release
void
*
cb_priv
)
;
typedef
aom_codec_err_t
(
*
aom_codec_encode_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
const
aom_image_t
*
img
aom_codec_pts_t
pts
unsigned
long
duration
aom_enc_frame_flags_t
flags
)
;
typedef
const
aom_codec_cx_pkt_t
*
(
*
aom_codec_get_cx_data_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
aom_codec_iter_t
*
iter
)
;
typedef
aom_codec_err_t
(
*
aom_codec_enc_config_set_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
const
aom_codec_enc_cfg_t
*
cfg
)
;
typedef
aom_fixed_buf_t
*
(
*
aom_codec_get_global_headers_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
)
;
typedef
aom_image_t
*
(
*
aom_codec_get_preview_frame_fn_t
)
(
aom_codec_alg_priv_t
*
ctx
)
;
struct
aom_codec_iface
{
const
char
*
name
;
int
abi_version
;
aom_codec_caps_t
caps
;
aom_codec_init_fn_t
init
;
aom_codec_destroy_fn_t
destroy
;
aom_codec_ctrl_fn_map_t
*
ctrl_maps
;
struct
aom_codec_dec_iface
{
aom_codec_peek_si_fn_t
peek_si
;
aom_codec_get_si_fn_t
get_si
;
aom_codec_decode_fn_t
decode
;
aom_codec_get_frame_fn_t
get_frame
;
aom_codec_set_fb_fn_t
set_fb_fn
;
}
dec
;
struct
aom_codec_enc_iface
{
int
cfg_count
;
const
aom_codec_enc_cfg_t
*
cfgs
;
aom_codec_encode_fn_t
encode
;
aom_codec_get_cx_data_fn_t
get_cx_data
;
aom_codec_enc_config_set_fn_t
cfg_set
;
aom_codec_get_global_headers_fn_t
get_glob_hdrs
;
aom_codec_get_preview_frame_fn_t
get_preview
;
}
enc
;
aom_codec_set_option_fn_t
set_option
;
}
;
struct
aom_codec_priv
{
const
char
*
err_detail
;
aom_codec_flags_t
init_flags
;
struct
{
aom_fixed_buf_t
cx_data_dst_buf
;
unsigned
int
cx_data_pad_before
;
unsigned
int
cx_data_pad_after
;
aom_codec_cx_pkt_t
cx_data_pkt
;
}
enc
;
}
;
#
define
CAST
(
id
arg
)
va_arg
(
(
arg
)
aom_codec_control_type_
#
#
id
)
struct
aom_codec_pkt_list
{
unsigned
int
cnt
;
unsigned
int
max
;
struct
aom_codec_cx_pkt
pkts
[
1
]
;
}
;
#
define
aom_codec_pkt_list_decl
(
n
)
\
union
{
\
struct
aom_codec_pkt_list
head
;
\
struct
{
\
struct
aom_codec_pkt_list
head
;
\
struct
aom_codec_cx_pkt
pkts
[
n
]
;
\
}
alloc
;
\
}
#
define
aom_codec_pkt_list_init
(
m
)
\
(
m
)
-
>
alloc
.
head
.
cnt
=
0
\
(
m
)
-
>
alloc
.
head
.
max
=
sizeof
(
(
m
)
-
>
alloc
.
pkts
)
/
sizeof
(
(
m
)
-
>
alloc
.
pkts
[
0
]
)
int
aom_codec_pkt_list_add
(
struct
aom_codec_pkt_list
*
const
struct
aom_codec_cx_pkt
*
)
;
const
aom_codec_cx_pkt_t
*
aom_codec_pkt_list_get
(
struct
aom_codec_pkt_list
*
list
aom_codec_iter_t
*
iter
)
;
#
include
<
stdio
.
h
>
#
include
<
setjmp
.
h
>
struct
aom_internal_error_info
{
aom_codec_err_t
error_code
;
int
has_detail
;
char
detail
[
ARG_ERR_MSG_MAX_LEN
]
;
int
setjmp
;
jmp_buf
jmp
;
}
;
#
define
CLANG_ANALYZER_NORETURN
#
if
defined
(
__has_feature
)
#
if
__has_feature
(
attribute_analyzer_noreturn
)
#
undef
CLANG_ANALYZER_NORETURN
#
define
CLANG_ANALYZER_NORETURN
__attribute__
(
(
analyzer_noreturn
)
)
#
endif
#
endif
#
define
LIBAOM_FORMAT_PRINTF
(
string_index
first_to_check
)
#
if
defined
(
__has_attribute
)
#
if
__has_attribute
(
format
)
#
undef
LIBAOM_FORMAT_PRINTF
#
define
LIBAOM_FORMAT_PRINTF
(
string_index
first_to_check
)
\
__attribute__
(
(
__format__
(
__printf__
string_index
first_to_check
)
)
)
#
endif
#
endif
void
aom_set_error
(
struct
aom_internal_error_info
*
info
aom_codec_err_t
error
const
char
*
fmt
.
.
.
)
LIBAOM_FORMAT_PRINTF
(
3
4
)
;
void
aom_internal_error
(
struct
aom_internal_error_info
*
info
aom_codec_err_t
error
const
char
*
fmt
.
.
.
)
LIBAOM_FORMAT_PRINTF
(
3
4
)
CLANG_ANALYZER_NORETURN
;
void
aom_internal_error_copy
(
struct
aom_internal_error_info
*
info
const
struct
aom_internal_error_info
*
src
)
CLANG_ANALYZER_NORETURN
;
void
aom_merge_corrupted_flag
(
int
*
corrupted
int
value
)
;
#
ifdef
__cplusplus
}
#
endif
#
endif
