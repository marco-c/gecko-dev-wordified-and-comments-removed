#
include
<
stdio
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
string
.
h
>
#
include
"
aom
/
aomdx
.
h
"
#
include
"
aom
/
aom_decoder
.
h
"
#
include
"
.
.
/
md5_utils
.
h
"
#
include
"
.
.
/
tools_common
.
h
"
#
include
"
.
.
/
video_reader
.
h
"
#
include
"
.
/
aom_config
.
h
"
static
void
get_image_md5
(
const
aom_image_t
*
img
unsigned
char
digest
[
16
]
)
{
int
plane
y
;
MD5Context
md5
;
MD5Init
(
&
md5
)
;
for
(
plane
=
0
;
plane
<
3
;
+
+
plane
)
{
const
unsigned
char
*
buf
=
img
-
>
planes
[
plane
]
;
const
int
stride
=
img
-
>
stride
[
plane
]
;
const
int
w
=
plane
?
(
img
-
>
d_w
+
1
)
>
>
1
:
img
-
>
d_w
;
const
int
h
=
plane
?
(
img
-
>
d_h
+
1
)
>
>
1
:
img
-
>
d_h
;
for
(
y
=
0
;
y
<
h
;
+
+
y
)
{
MD5Update
(
&
md5
buf
w
)
;
buf
+
=
stride
;
}
}
MD5Final
(
digest
&
md5
)
;
}
static
void
print_md5
(
FILE
*
stream
unsigned
char
digest
[
16
]
)
{
int
i
;
for
(
i
=
0
;
i
<
16
;
+
+
i
)
fprintf
(
stream
"
%
02x
"
digest
[
i
]
)
;
}
static
const
char
*
exec_name
;
void
usage_exit
(
void
)
{
fprintf
(
stderr
"
Usage
:
%
s
<
infile
>
<
outfile
>
\
n
"
exec_name
)
;
exit
(
EXIT_FAILURE
)
;
}
int
main
(
int
argc
char
*
*
argv
)
{
int
frame_cnt
=
0
;
FILE
*
outfile
=
NULL
;
aom_codec_ctx_t
codec
;
AvxVideoReader
*
reader
=
NULL
;
const
AvxVideoInfo
*
info
=
NULL
;
const
AvxInterface
*
decoder
=
NULL
;
exec_name
=
argv
[
0
]
;
if
(
argc
!
=
3
)
die
(
"
Invalid
number
of
arguments
.
"
)
;
reader
=
aom_video_reader_open
(
argv
[
1
]
)
;
if
(
!
reader
)
die
(
"
Failed
to
open
%
s
for
reading
.
"
argv
[
1
]
)
;
if
(
!
(
outfile
=
fopen
(
argv
[
2
]
"
wb
"
)
)
)
die
(
"
Failed
to
open
%
s
for
writing
.
"
argv
[
2
]
)
;
info
=
aom_video_reader_get_info
(
reader
)
;
decoder
=
get_aom_decoder_by_fourcc
(
info
-
>
codec_fourcc
)
;
if
(
!
decoder
)
die
(
"
Unknown
input
codec
.
"
)
;
printf
(
"
Using
%
s
\
n
"
aom_codec_iface_name
(
decoder
-
>
codec_interface
(
)
)
)
;
if
(
aom_codec_dec_init
(
&
codec
decoder
-
>
codec_interface
(
)
NULL
0
)
)
die_codec
(
&
codec
"
Failed
to
initialize
decoder
"
)
;
while
(
aom_video_reader_read_frame
(
reader
)
)
{
aom_codec_iter_t
iter
=
NULL
;
aom_image_t
*
img
=
NULL
;
size_t
frame_size
=
0
;
const
unsigned
char
*
frame
=
aom_video_reader_get_frame
(
reader
&
frame_size
)
;
if
(
aom_codec_decode
(
&
codec
frame
(
unsigned
int
)
frame_size
NULL
0
)
)
die_codec
(
&
codec
"
Failed
to
decode
frame
"
)
;
while
(
(
img
=
aom_codec_get_frame
(
&
codec
&
iter
)
)
!
=
NULL
)
{
unsigned
char
digest
[
16
]
;
get_image_md5
(
img
digest
)
;
print_md5
(
outfile
digest
)
;
fprintf
(
outfile
"
img
-
%
dx
%
d
-
%
04d
.
i420
\
n
"
img
-
>
d_w
img
-
>
d_h
+
+
frame_cnt
)
;
}
}
printf
(
"
Processed
%
d
frames
.
\
n
"
frame_cnt
)
;
if
(
aom_codec_destroy
(
&
codec
)
)
die_codec
(
&
codec
"
Failed
to
destroy
codec
.
"
)
;
aom_video_reader_close
(
reader
)
;
fclose
(
outfile
)
;
return
EXIT_SUCCESS
;
}
