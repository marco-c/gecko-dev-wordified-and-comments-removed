#
include
<
stdio
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
string
.
h
>
#
include
"
aom
/
aom_encoder
.
h
"
#
include
"
aom
/
aomcx
.
h
"
#
include
"
av1
/
common
/
enums
.
h
"
#
include
"
common
/
tools_common
.
h
"
#
include
"
common
/
video_writer
.
h
"
static
const
char
*
exec_name
;
void
usage_exit
(
void
)
{
fprintf
(
stderr
"
Usage
:
%
s
<
codec
>
<
width
>
<
height
>
<
infile0
>
<
infile1
>
"
"
<
outfile
>
<
frames
to
encode
>
\
n
"
"
See
comments
in
scalable_encoder
.
c
for
more
information
.
\
n
"
exec_name
)
;
exit
(
EXIT_FAILURE
)
;
}
static
int
encode_frame
(
aom_codec_ctx_t
*
codec
aom_image_t
*
img
int
frame_index
int
flags
FILE
*
outfile
)
{
int
got_pkts
=
0
;
aom_codec_iter_t
iter
=
NULL
;
const
aom_codec_cx_pkt_t
*
pkt
=
NULL
;
const
aom_codec_err_t
res
=
aom_codec_encode
(
codec
img
frame_index
1
flags
)
;
if
(
res
!
=
AOM_CODEC_OK
)
die_codec
(
codec
"
Failed
to
encode
frame
"
)
;
while
(
(
pkt
=
aom_codec_get_cx_data
(
codec
&
iter
)
)
!
=
NULL
)
{
got_pkts
=
1
;
if
(
pkt
-
>
kind
=
=
AOM_CODEC_CX_FRAME_PKT
)
{
const
int
keyframe
=
(
pkt
-
>
data
.
frame
.
flags
&
AOM_FRAME_IS_KEY
)
!
=
0
;
if
(
fwrite
(
pkt
-
>
data
.
frame
.
buf
1
pkt
-
>
data
.
frame
.
sz
outfile
)
!
=
pkt
-
>
data
.
frame
.
sz
)
{
die_codec
(
codec
"
Failed
to
write
compressed
frame
"
)
;
}
printf
(
keyframe
?
"
K
"
:
"
.
"
)
;
printf
(
"
%
6d
\
n
"
(
int
)
pkt
-
>
data
.
frame
.
sz
)
;
fflush
(
stdout
)
;
}
}
return
got_pkts
;
}
int
main
(
int
argc
char
*
*
argv
)
{
FILE
*
infile0
=
NULL
;
FILE
*
infile1
=
NULL
;
aom_codec_ctx_t
codec
;
aom_codec_enc_cfg_t
cfg
;
int
frame_count
=
0
;
aom_image_t
raw0
raw1
;
aom_codec_err_t
res
;
AvxVideoInfo
info
;
const
AvxInterface
*
encoder
=
NULL
;
const
int
fps
=
30
;
const
int
bitrate
=
200
;
int
keyframe_interval
=
0
;
int
max_frames
=
0
;
int
frames_encoded
=
0
;
const
char
*
codec_arg
=
NULL
;
const
char
*
width_arg
=
NULL
;
const
char
*
height_arg
=
NULL
;
const
char
*
infile0_arg
=
NULL
;
const
char
*
infile1_arg
=
NULL
;
const
char
*
outfile_arg
=
NULL
;
FILE
*
outfile
=
NULL
;
exec_name
=
argv
[
0
]
;
memset
(
&
info
0
sizeof
(
info
)
)
;
if
(
argc
!
=
8
)
die
(
"
Invalid
number
of
arguments
"
)
;
codec_arg
=
argv
[
1
]
;
width_arg
=
argv
[
2
]
;
height_arg
=
argv
[
3
]
;
infile0_arg
=
argv
[
4
]
;
infile1_arg
=
argv
[
5
]
;
outfile_arg
=
argv
[
6
]
;
max_frames
=
(
int
)
strtol
(
argv
[
7
]
NULL
0
)
;
encoder
=
get_aom_encoder_by_name
(
codec_arg
)
;
if
(
!
encoder
)
die
(
"
Unsupported
codec
.
"
)
;
info
.
codec_fourcc
=
encoder
-
>
fourcc
;
info
.
frame_width
=
(
int
)
strtol
(
width_arg
NULL
0
)
;
info
.
frame_height
=
(
int
)
strtol
(
height_arg
NULL
0
)
;
info
.
time_base
.
numerator
=
1
;
info
.
time_base
.
denominator
=
fps
;
if
(
info
.
frame_width
<
=
0
|
|
info
.
frame_height
<
=
0
|
|
(
info
.
frame_width
%
2
)
!
=
0
|
|
(
info
.
frame_height
%
2
)
!
=
0
)
{
die
(
"
Invalid
frame
size
:
%
dx
%
d
"
info
.
frame_width
info
.
frame_height
)
;
}
if
(
!
aom_img_alloc
(
&
raw0
AOM_IMG_FMT_I420
info
.
frame_width
info
.
frame_height
1
)
)
{
die
(
"
Failed
to
allocate
image
for
layer
0
.
"
)
;
}
if
(
!
aom_img_alloc
(
&
raw1
AOM_IMG_FMT_I420
info
.
frame_width
info
.
frame_height
1
)
)
{
die
(
"
Failed
to
allocate
image
for
layer
1
.
"
)
;
}
keyframe_interval
=
100
;
if
(
keyframe_interval
<
0
)
die
(
"
Invalid
keyframe
interval
value
.
"
)
;
printf
(
"
Using
%
s
\
n
"
aom_codec_iface_name
(
encoder
-
>
codec_interface
(
)
)
)
;
res
=
aom_codec_enc_config_default
(
encoder
-
>
codec_interface
(
)
&
cfg
0
)
;
if
(
res
)
die_codec
(
&
codec
"
Failed
to
get
default
codec
config
.
"
)
;
cfg
.
g_w
=
info
.
frame_width
;
cfg
.
g_h
=
info
.
frame_height
;
cfg
.
g_timebase
.
num
=
info
.
time_base
.
numerator
;
cfg
.
g_timebase
.
den
=
info
.
time_base
.
denominator
;
cfg
.
rc_target_bitrate
=
bitrate
;
cfg
.
g_error_resilient
=
0
;
cfg
.
g_lag_in_frames
=
0
;
cfg
.
rc_end_usage
=
AOM_Q
;
cfg
.
save_as_annexb
=
0
;
outfile
=
fopen
(
outfile_arg
"
wb
"
)
;
if
(
!
outfile
)
die
(
"
Failed
to
open
%
s
for
writing
.
"
outfile_arg
)
;
if
(
!
(
infile0
=
fopen
(
infile0_arg
"
rb
"
)
)
)
die
(
"
Failed
to
open
%
s
for
reading
.
"
infile0_arg
)
;
if
(
!
(
infile1
=
fopen
(
infile1_arg
"
rb
"
)
)
)
die
(
"
Failed
to
open
%
s
for
reading
.
"
infile0_arg
)
;
if
(
aom_codec_enc_init
(
&
codec
encoder
-
>
codec_interface
(
)
&
cfg
0
)
)
die_codec
(
&
codec
"
Failed
to
initialize
encoder
"
)
;
if
(
aom_codec_control
(
&
codec
AOME_SET_CPUUSED
8
)
)
die_codec
(
&
codec
"
Failed
to
set
cpu
to
8
"
)
;
if
(
aom_codec_control
(
&
codec
AV1E_SET_TILE_COLUMNS
2
)
)
die_codec
(
&
codec
"
Failed
to
set
tile
columns
to
2
"
)
;
if
(
aom_codec_control
(
&
codec
AV1E_SET_NUM_TG
3
)
)
die_codec
(
&
codec
"
Failed
to
set
num
of
tile
groups
to
3
"
)
;
if
(
aom_codec_control
(
&
codec
AOME_SET_NUMBER_SPATIAL_LAYERS
2
)
)
die_codec
(
&
codec
"
Failed
to
set
number
of
spatial
layers
to
2
"
)
;
while
(
aom_img_read
(
&
raw0
infile0
)
)
{
int
flags
=
0
;
if
(
keyframe_interval
>
0
&
&
frames_encoded
%
keyframe_interval
=
=
0
)
flags
|
=
AOM_EFLAG_FORCE_KF
;
else
flags
|
=
AOM_EFLAG_NO_REF_LAST2
|
AOM_EFLAG_NO_REF_LAST3
|
AOM_EFLAG_NO_REF_GF
|
AOM_EFLAG_NO_REF_ARF
|
AOM_EFLAG_NO_REF_BWD
|
AOM_EFLAG_NO_REF_ARF2
|
AOM_EFLAG_NO_UPD_GF
|
AOM_EFLAG_NO_UPD_ARF
|
AOM_EFLAG_NO_UPD_ENTROPY
;
cfg
.
g_w
=
info
.
frame_width
;
cfg
.
g_h
=
info
.
frame_height
;
if
(
aom_codec_enc_config_set
(
&
codec
&
cfg
)
)
die_codec
(
&
codec
"
Failed
to
set
enc
cfg
for
layer
0
"
)
;
if
(
aom_codec_control
(
&
codec
AOME_SET_SPATIAL_LAYER_ID
0
)
)
die_codec
(
&
codec
"
Failed
to
set
layer
id
to
0
"
)
;
if
(
aom_codec_control
(
&
codec
AOME_SET_CQ_LEVEL
62
)
)
die_codec
(
&
codec
"
Failed
to
set
cq
level
"
)
;
encode_frame
(
&
codec
&
raw0
frame_count
+
+
flags
outfile
)
;
flags
=
AOM_EFLAG_NO_REF_LAST2
|
AOM_EFLAG_NO_REF_LAST3
|
AOM_EFLAG_NO_REF_GF
|
AOM_EFLAG_NO_REF_ARF
|
AOM_EFLAG_NO_REF_BWD
|
AOM_EFLAG_NO_REF_ARF2
|
AOM_EFLAG_NO_UPD_LAST
|
AOM_EFLAG_NO_UPD_GF
|
AOM_EFLAG_NO_UPD_ARF
|
AOM_EFLAG_NO_UPD_ENTROPY
;
cfg
.
g_w
=
info
.
frame_width
;
cfg
.
g_h
=
info
.
frame_height
;
aom_img_read
(
&
raw1
infile1
)
;
if
(
aom_codec_enc_config_set
(
&
codec
&
cfg
)
)
die_codec
(
&
codec
"
Failed
to
set
enc
cfg
for
layer
1
"
)
;
if
(
aom_codec_control
(
&
codec
AOME_SET_SPATIAL_LAYER_ID
1
)
)
die_codec
(
&
codec
"
Failed
to
set
layer
id
to
1
"
)
;
if
(
aom_codec_control
(
&
codec
AOME_SET_CQ_LEVEL
10
)
)
die_codec
(
&
codec
"
Failed
to
set
cq
level
"
)
;
encode_frame
(
&
codec
&
raw1
frame_count
+
+
flags
outfile
)
;
frames_encoded
+
+
;
if
(
max_frames
>
0
&
&
frames_encoded
>
=
max_frames
)
break
;
}
while
(
encode_frame
(
&
codec
NULL
-
1
0
outfile
)
)
continue
;
printf
(
"
\
n
"
)
;
fclose
(
infile0
)
;
fclose
(
infile1
)
;
printf
(
"
Processed
%
d
frames
.
\
n
"
frame_count
/
2
)
;
aom_img_free
(
&
raw0
)
;
aom_img_free
(
&
raw1
)
;
if
(
aom_codec_destroy
(
&
codec
)
)
die_codec
(
&
codec
"
Failed
to
destroy
codec
.
"
)
;
fclose
(
outfile
)
;
return
EXIT_SUCCESS
;
}
