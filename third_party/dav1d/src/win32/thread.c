#
include
"
config
.
h
"
#
if
defined
(
_WIN32
)
#
include
<
errno
.
h
>
#
include
<
process
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
windows
.
h
>
#
include
"
config
.
h
"
#
include
"
src
/
thread
.
h
"
typedef
struct
dav1d_win32_thread_t
{
HANDLE
h
;
void
*
param
;
void
*
(
*
proc
)
(
void
*
)
;
void
*
res
;
}
dav1d_win32_thread_t
;
static
unsigned
__stdcall
dav1d_thread_entrypoint
(
void
*
data
)
{
dav1d_win32_thread_t
*
t
=
data
;
t
-
>
res
=
t
-
>
proc
(
t
-
>
param
)
;
return
0
;
}
int
dav1d_pthread_create
(
pthread_t
*
thread
const
pthread_attr_t
*
attr
void
*
(
*
proc
)
(
void
*
)
void
*
param
)
{
dav1d_win32_thread_t
*
th
=
*
thread
=
malloc
(
sizeof
(
*
th
)
)
;
(
void
)
attr
;
if
(
th
=
=
NULL
)
return
ENOMEM
;
th
-
>
proc
=
proc
;
th
-
>
param
=
param
;
uintptr_t
h
=
_beginthreadex
(
NULL
0
dav1d_thread_entrypoint
th
0
NULL
)
;
if
(
h
=
=
0
)
{
int
err
=
errno
;
free
(
th
)
;
*
thread
=
NULL
;
return
err
;
}
th
-
>
h
=
(
HANDLE
)
h
;
return
0
;
}
void
dav1d_pthread_join
(
pthread_t
thread
void
*
*
res
)
{
dav1d_win32_thread_t
*
th
=
thread
;
WaitForSingleObject
(
th
-
>
h
INFINITE
)
;
if
(
res
!
=
NULL
)
*
res
=
th
-
>
res
;
CloseHandle
(
th
-
>
h
)
;
free
(
th
)
;
}
int
dav1d_pthread_once
(
pthread_once_t
*
once_control
void
(
*
init_routine
)
(
void
)
)
{
BOOL
fPending
=
FALSE
;
BOOL
fStatus
;
fStatus
=
InitOnceBeginInitialize
(
once_control
0
&
fPending
NULL
)
;
if
(
fStatus
!
=
TRUE
)
return
EINVAL
;
if
(
fPending
=
=
TRUE
)
init_routine
(
)
;
fStatus
=
InitOnceComplete
(
once_control
0
NULL
)
;
if
(
!
fStatus
)
return
EINVAL
;
return
0
;
}
#
endif
