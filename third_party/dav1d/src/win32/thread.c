#
include
"
config
.
h
"
#
if
defined
(
_WIN32
)
#
include
<
process
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
windows
.
h
>
#
include
"
common
/
attributes
.
h
"
#
include
"
src
/
thread
.
h
"
static
HRESULT
(
WINAPI
*
set_thread_description
)
(
HANDLE
PCWSTR
)
;
COLD
void
dav1d_init_thread
(
void
)
{
set_thread_description
=
(
void
*
)
GetProcAddress
(
GetModuleHandleW
(
L
"
kernel32
.
dll
"
)
"
SetThreadDescription
"
)
;
}
#
undef
dav1d_set_thread_name
COLD
void
dav1d_set_thread_name
(
const
wchar_t
*
const
name
)
{
if
(
set_thread_description
)
set_thread_description
(
GetCurrentThread
(
)
name
)
;
}
static
COLD
unsigned
__stdcall
thread_entrypoint
(
void
*
const
data
)
{
pthread_t
*
const
t
=
data
;
t
-
>
arg
=
t
-
>
func
(
t
-
>
arg
)
;
return
0
;
}
COLD
int
dav1d_pthread_create
(
pthread_t
*
const
thread
const
pthread_attr_t
*
const
attr
void
*
(
*
const
func
)
(
void
*
)
void
*
const
arg
)
{
const
unsigned
stack_size
=
attr
?
attr
-
>
stack_size
:
0
;
thread
-
>
func
=
func
;
thread
-
>
arg
=
arg
;
thread
-
>
h
=
(
HANDLE
)
_beginthreadex
(
NULL
stack_size
thread_entrypoint
thread
STACK_SIZE_PARAM_IS_A_RESERVATION
NULL
)
;
return
!
thread
-
>
h
;
}
COLD
int
dav1d_pthread_join
(
pthread_t
*
const
thread
void
*
*
const
res
)
{
if
(
WaitForSingleObject
(
thread
-
>
h
INFINITE
)
)
return
1
;
if
(
res
)
*
res
=
thread
-
>
arg
;
return
!
CloseHandle
(
thread
-
>
h
)
;
}
COLD
int
dav1d_pthread_once
(
pthread_once_t
*
const
once_control
void
(
*
const
init_routine
)
(
void
)
)
{
BOOL
pending
=
FALSE
;
if
(
InitOnceBeginInitialize
(
once_control
0
&
pending
NULL
)
!
=
TRUE
)
return
1
;
if
(
pending
=
=
TRUE
)
init_routine
(
)
;
return
!
InitOnceComplete
(
once_control
0
NULL
)
;
}
#
endif
