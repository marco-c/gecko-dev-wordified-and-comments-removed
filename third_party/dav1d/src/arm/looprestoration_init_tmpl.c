#
include
"
src
/
cpu
.
h
"
#
include
"
src
/
looprestoration
.
h
"
#
include
"
common
/
attributes
.
h
"
#
if
BITDEPTH
=
=
8
void
dav1d_wiener_filter_h_neon
(
int16_t
*
dst
const
pixel
(
*
left
)
[
4
]
const
pixel
*
src
ptrdiff_t
stride
const
int16_t
fh
[
7
]
const
intptr_t
w
int
h
enum
LrEdgeFlags
edges
)
;
void
dav1d_wiener_filter_v_neon
(
pixel
*
dst
ptrdiff_t
stride
const
int16_t
*
mid
int
w
int
h
const
int16_t
fv
[
7
]
enum
LrEdgeFlags
edges
ptrdiff_t
mid_stride
)
;
void
dav1d_copy_narrow_neon
(
pixel
*
dst
ptrdiff_t
stride
const
pixel
*
src
int
w
int
h
)
;
static
void
wiener_filter_neon
(
pixel
*
const
dst
const
ptrdiff_t
dst_stride
const
pixel
(
*
const
left
)
[
4
]
const
pixel
*
lpf
const
ptrdiff_t
lpf_stride
const
int
w
const
int
h
const
int16_t
fh
[
7
]
const
int16_t
fv
[
7
]
const
enum
LrEdgeFlags
edges
)
{
ALIGN_STK_16
(
int16_t
mid
68
*
384
)
;
int
mid_stride
=
(
w
+
7
)
&
~
7
;
dav1d_wiener_filter_h_neon
(
&
mid
[
2
*
mid_stride
]
left
dst
dst_stride
fh
w
h
edges
)
;
if
(
edges
&
LR_HAVE_TOP
)
dav1d_wiener_filter_h_neon
(
mid
NULL
lpf
lpf_stride
fh
w
2
edges
)
;
if
(
edges
&
LR_HAVE_BOTTOM
)
dav1d_wiener_filter_h_neon
(
&
mid
[
(
2
+
h
)
*
mid_stride
]
NULL
lpf
+
6
*
PXSTRIDE
(
lpf_stride
)
lpf_stride
fh
w
2
edges
)
;
if
(
w
>
=
8
)
dav1d_wiener_filter_v_neon
(
dst
dst_stride
&
mid
[
2
*
mid_stride
]
w
&
~
7
h
fv
edges
mid_stride
*
sizeof
(
*
mid
)
)
;
if
(
w
&
7
)
{
ALIGN_STK_16
(
pixel
tmp
64
*
8
)
;
dav1d_wiener_filter_v_neon
(
tmp
w
&
7
&
mid
[
2
*
mid_stride
+
(
w
&
~
7
)
]
w
&
7
h
fv
edges
mid_stride
*
sizeof
(
*
mid
)
)
;
dav1d_copy_narrow_neon
(
dst
+
(
w
&
~
7
)
dst_stride
tmp
w
&
7
h
)
;
}
}
#
endif
void
bitfn
(
dav1d_loop_restoration_dsp_init_arm
)
(
Dav1dLoopRestorationDSPContext
*
const
c
)
{
const
unsigned
flags
=
dav1d_get_cpu_flags
(
)
;
if
(
!
(
flags
&
DAV1D_ARM_CPU_FLAG_NEON
)
)
return
;
#
if
BITDEPTH
=
=
8
c
-
>
wiener
=
wiener_filter_neon
;
#
endif
}
