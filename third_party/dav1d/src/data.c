#
include
"
config
.
h
"
#
include
<
errno
.
h
>
#
include
<
stdint
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
string
.
h
>
#
include
"
dav1d
/
data
.
h
"
#
include
"
common
/
validate
.
h
"
#
include
"
src
/
data
.
h
"
#
include
"
src
/
ref
.
h
"
uint8_t
*
dav1d_data_create
(
Dav1dData
*
const
buf
const
size_t
sz
)
{
validate_input_or_ret
(
buf
!
=
NULL
NULL
)
;
buf
-
>
ref
=
dav1d_ref_create
(
sz
)
;
if
(
!
buf
-
>
ref
)
return
NULL
;
buf
-
>
data
=
buf
-
>
ref
-
>
const_data
;
buf
-
>
sz
=
buf
-
>
m
.
size
=
sz
;
buf
-
>
m
.
timestamp
=
INT64_MIN
;
buf
-
>
m
.
duration
=
0
;
buf
-
>
m
.
offset
=
-
1
;
return
buf
-
>
ref
-
>
data
;
}
int
dav1d_data_wrap
(
Dav1dData
*
const
buf
const
uint8_t
*
const
ptr
const
size_t
sz
void
(
*
free_callback
)
(
const
uint8_t
*
data
void
*
user_data
)
void
*
user_data
)
{
validate_input_or_ret
(
buf
!
=
NULL
-
EINVAL
)
;
validate_input_or_ret
(
ptr
!
=
NULL
-
EINVAL
)
;
validate_input_or_ret
(
free_callback
!
=
NULL
-
EINVAL
)
;
buf
-
>
ref
=
dav1d_ref_wrap
(
ptr
free_callback
user_data
)
;
if
(
!
buf
-
>
ref
)
return
-
ENOMEM
;
buf
-
>
data
=
ptr
;
buf
-
>
sz
=
buf
-
>
m
.
size
=
sz
;
buf
-
>
m
.
timestamp
=
INT64_MIN
;
buf
-
>
m
.
duration
=
0
;
buf
-
>
m
.
offset
=
-
1
;
return
0
;
}
void
dav1d_data_move_ref
(
Dav1dData
*
const
dst
Dav1dData
*
const
src
)
{
validate_input
(
dst
!
=
NULL
)
;
validate_input
(
dst
-
>
data
=
=
NULL
)
;
validate_input
(
src
!
=
NULL
)
;
if
(
src
-
>
ref
)
validate_input
(
src
-
>
data
!
=
NULL
)
;
*
dst
=
*
src
;
memset
(
src
0
sizeof
(
*
src
)
)
;
}
void
dav1d_data_unref
(
Dav1dData
*
const
buf
)
{
validate_input
(
buf
!
=
NULL
)
;
if
(
buf
-
>
ref
)
{
validate_input
(
buf
-
>
data
!
=
NULL
)
;
dav1d_ref_dec
(
&
buf
-
>
ref
)
;
}
memset
(
buf
0
sizeof
(
*
buf
)
)
;
}
