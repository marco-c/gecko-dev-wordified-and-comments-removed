#
include
"
config
.
h
"
#
include
<
stdint
.
h
>
#
include
"
src
/
mem
.
h
"
#
include
"
src
/
thread
.
h
"
void
dav1d_mem_pool_push
(
Dav1dMemPool
*
const
pool
Dav1dMemPoolBuffer
*
const
buf
)
{
pthread_mutex_lock
(
&
pool
-
>
lock
)
;
buf
-
>
next
=
pool
-
>
buf
;
pool
-
>
buf
=
buf
;
pthread_mutex_unlock
(
&
pool
-
>
lock
)
;
}
Dav1dMemPoolBuffer
*
dav1d_mem_pool_pop
(
Dav1dMemPool
*
const
pool
const
size_t
size
)
{
pthread_mutex_lock
(
&
pool
-
>
lock
)
;
Dav1dMemPoolBuffer
*
buf
=
pool
-
>
buf
;
uint8_t
*
data
;
if
(
buf
)
{
pool
-
>
buf
=
buf
-
>
next
;
pthread_mutex_unlock
(
&
pool
-
>
lock
)
;
data
=
buf
-
>
data
;
if
(
(
uintptr_t
)
buf
-
(
uintptr_t
)
data
!
=
size
)
{
dav1d_free_aligned
(
data
)
;
goto
alloc
;
}
}
else
{
pthread_mutex_unlock
(
&
pool
-
>
lock
)
;
alloc
:
data
=
dav1d_alloc_aligned
(
size
+
sizeof
(
Dav1dMemPoolBuffer
)
64
)
;
if
(
!
data
)
return
NULL
;
buf
=
(
Dav1dMemPoolBuffer
*
)
(
data
+
size
)
;
buf
-
>
data
=
data
;
}
return
buf
;
}
COLD
void
dav1d_mem_pool_destroy
(
Dav1dMemPool
*
const
pool
)
{
pthread_mutex_destroy
(
&
pool
-
>
lock
)
;
Dav1dMemPoolBuffer
*
buf
=
pool
-
>
buf
;
while
(
buf
)
{
void
*
const
data
=
buf
-
>
data
;
buf
=
buf
-
>
next
;
dav1d_free_aligned
(
data
)
;
}
}
