#
include
"
config
.
h
"
#
include
<
stdint
.
h
>
#
include
<
string
.
h
>
#
include
"
common
/
attributes
.
h
"
#
include
"
src
/
x86
/
cpu
.
h
"
typedef
struct
{
uint32_t
eax
ebx
edx
ecx
;
}
CpuidRegisters
;
void
dav1d_cpu_cpuid
(
CpuidRegisters
*
regs
unsigned
leaf
unsigned
subleaf
)
;
uint64_t
dav1d_cpu_xgetbv
(
unsigned
xcr
)
;
#
define
X
(
reg
mask
)
(
(
(
reg
)
&
(
mask
)
)
=
=
(
mask
)
)
COLD
unsigned
dav1d_get_cpu_flags_x86
(
void
)
{
union
{
CpuidRegisters
r
;
struct
{
uint32_t
max_leaf
;
char
vendor
[
12
]
;
}
;
}
cpu
;
dav1d_cpu_cpuid
(
&
cpu
.
r
0
0
)
;
unsigned
flags
=
0
;
if
(
cpu
.
max_leaf
>
=
1
)
{
CpuidRegisters
r
;
dav1d_cpu_cpuid
(
&
r
1
0
)
;
const
unsigned
family
=
(
(
r
.
eax
>
>
8
)
&
0x0f
)
+
(
(
r
.
eax
>
>
20
)
&
0xff
)
;
if
(
X
(
r
.
edx
0x06008000
)
)
{
flags
|
=
DAV1D_X86_CPU_FLAG_SSE2
;
if
(
X
(
r
.
ecx
0x00000201
)
)
{
flags
|
=
DAV1D_X86_CPU_FLAG_SSSE3
;
if
(
X
(
r
.
ecx
0x00080000
)
)
flags
|
=
DAV1D_X86_CPU_FLAG_SSE41
;
}
}
#
if
ARCH_X86_64
if
(
X
(
r
.
ecx
0x18000000
)
)
{
const
uint64_t
xcr0
=
dav1d_cpu_xgetbv
(
0
)
;
if
(
X
(
xcr0
0x00000006
)
)
{
if
(
cpu
.
max_leaf
>
=
7
)
{
dav1d_cpu_cpuid
(
&
r
7
0
)
;
if
(
X
(
r
.
ebx
0x00000128
)
)
{
flags
|
=
DAV1D_X86_CPU_FLAG_AVX2
;
if
(
X
(
xcr0
0x000000e0
)
)
{
if
(
X
(
r
.
ebx
0xd0230000
)
&
&
X
(
r
.
ecx
0x00005f42
)
)
flags
|
=
DAV1D_X86_CPU_FLAG_AVX512ICL
;
}
}
}
}
}
#
endif
if
(
!
memcmp
(
cpu
.
vendor
"
AuthenticAMD
"
sizeof
(
cpu
.
vendor
)
)
)
{
if
(
(
flags
&
DAV1D_X86_CPU_FLAG_AVX2
)
&
&
family
<
=
0x19
)
{
flags
|
=
DAV1D_X86_CPU_FLAG_SLOW_GATHER
;
}
}
}
return
flags
;
}
