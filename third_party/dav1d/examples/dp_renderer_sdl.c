#
include
"
dp_renderer
.
h
"
#
include
<
assert
.
h
>
typedef
struct
renderer_priv_ctx
{
SDL_Window
*
win
;
SDL_Renderer
*
renderer
;
SDL_mutex
*
lock
;
SDL_Texture
*
tex
;
}
Dav1dPlayRendererPrivateContext
;
static
void
*
sdl_renderer_create
(
)
{
SDL_Window
*
win
=
dp_create_sdl_window
(
0
)
;
if
(
win
=
=
NULL
)
return
NULL
;
Dav1dPlayRendererPrivateContext
*
rd_priv_ctx
=
malloc
(
sizeof
(
Dav1dPlayRendererPrivateContext
)
)
;
if
(
rd_priv_ctx
=
=
NULL
)
{
return
NULL
;
}
rd_priv_ctx
-
>
win
=
win
;
rd_priv_ctx
-
>
renderer
=
SDL_CreateRenderer
(
win
-
1
SDL_RENDERER_ACCELERATED
)
;
SDL_SetHint
(
SDL_HINT_RENDER_SCALE_QUALITY
"
linear
"
)
;
rd_priv_ctx
-
>
lock
=
SDL_CreateMutex
(
)
;
if
(
rd_priv_ctx
-
>
lock
=
=
NULL
)
{
fprintf
(
stderr
"
SDL_CreateMutex
failed
:
%
s
\
n
"
SDL_GetError
(
)
)
;
free
(
rd_priv_ctx
)
;
return
NULL
;
}
rd_priv_ctx
-
>
tex
=
NULL
;
return
rd_priv_ctx
;
}
static
void
sdl_renderer_destroy
(
void
*
cookie
)
{
Dav1dPlayRendererPrivateContext
*
rd_priv_ctx
=
cookie
;
assert
(
rd_priv_ctx
!
=
NULL
)
;
SDL_DestroyRenderer
(
rd_priv_ctx
-
>
renderer
)
;
SDL_DestroyMutex
(
rd_priv_ctx
-
>
lock
)
;
free
(
rd_priv_ctx
)
;
}
static
void
sdl_render
(
void
*
cookie
const
Dav1dPlaySettings
*
settings
)
{
Dav1dPlayRendererPrivateContext
*
rd_priv_ctx
=
cookie
;
assert
(
rd_priv_ctx
!
=
NULL
)
;
SDL_LockMutex
(
rd_priv_ctx
-
>
lock
)
;
if
(
rd_priv_ctx
-
>
tex
=
=
NULL
)
{
SDL_UnlockMutex
(
rd_priv_ctx
-
>
lock
)
;
return
;
}
SDL_RenderClear
(
rd_priv_ctx
-
>
renderer
)
;
SDL_RenderCopy
(
rd_priv_ctx
-
>
renderer
rd_priv_ctx
-
>
tex
NULL
NULL
)
;
SDL_RenderPresent
(
rd_priv_ctx
-
>
renderer
)
;
SDL_UnlockMutex
(
rd_priv_ctx
-
>
lock
)
;
}
static
int
sdl_update_texture
(
void
*
cookie
Dav1dPicture
*
dav1d_pic
const
Dav1dPlaySettings
*
settings
)
{
Dav1dPlayRendererPrivateContext
*
rd_priv_ctx
=
cookie
;
assert
(
rd_priv_ctx
!
=
NULL
)
;
SDL_LockMutex
(
rd_priv_ctx
-
>
lock
)
;
if
(
dav1d_pic
=
=
NULL
)
{
rd_priv_ctx
-
>
tex
=
NULL
;
SDL_UnlockMutex
(
rd_priv_ctx
-
>
lock
)
;
return
0
;
}
int
width
=
dav1d_pic
-
>
p
.
w
;
int
height
=
dav1d_pic
-
>
p
.
h
;
int
tex_w
=
width
;
int
tex_h
=
height
;
enum
Dav1dPixelLayout
dav1d_layout
=
dav1d_pic
-
>
p
.
layout
;
if
(
DAV1D_PIXEL_LAYOUT_I420
!
=
dav1d_layout
|
|
dav1d_pic
-
>
p
.
bpc
!
=
8
)
{
fprintf
(
stderr
"
Unsupported
pixel
format
only
8bit
420
supported
so
far
.
\
n
"
)
;
exit
(
50
)
;
}
SDL_Texture
*
texture
=
rd_priv_ctx
-
>
tex
;
if
(
texture
!
=
NULL
)
{
SDL_QueryTexture
(
texture
NULL
NULL
&
tex_w
&
tex_h
)
;
if
(
tex_w
!
=
width
|
|
tex_h
!
=
height
)
{
SDL_DestroyTexture
(
texture
)
;
texture
=
NULL
;
}
}
if
(
texture
=
=
NULL
)
{
texture
=
SDL_CreateTexture
(
rd_priv_ctx
-
>
renderer
SDL_PIXELFORMAT_IYUV
SDL_TEXTUREACCESS_STREAMING
width
height
)
;
}
SDL_UpdateYUVTexture
(
texture
NULL
dav1d_pic
-
>
data
[
0
]
(
int
)
dav1d_pic
-
>
stride
[
0
]
dav1d_pic
-
>
data
[
1
]
(
int
)
dav1d_pic
-
>
stride
[
1
]
dav1d_pic
-
>
data
[
2
]
(
int
)
dav1d_pic
-
>
stride
[
1
]
)
;
rd_priv_ctx
-
>
tex
=
texture
;
SDL_UnlockMutex
(
rd_priv_ctx
-
>
lock
)
;
return
0
;
}
const
Dav1dPlayRenderInfo
rdr_sdl
=
{
.
name
=
"
sdl
"
.
create_renderer
=
sdl_renderer_create
.
destroy_renderer
=
sdl_renderer_destroy
.
render
=
sdl_render
.
update_frame
=
sdl_update_texture
}
;
