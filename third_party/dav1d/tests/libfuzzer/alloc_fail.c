#
include
"
config
.
h
"
#
include
<
stddef
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
errno
.
h
>
#
include
"
alloc_fail
.
h
"
static
int
fail_probability
;
void
dav1d_setup_alloc_fail
(
unsigned
seed
unsigned
probability
)
{
srand
(
seed
)
;
while
(
probability
>
=
RAND_MAX
)
probability
>
>
=
1
;
fail_probability
=
probability
;
}
void
*
__wrap_malloc
(
size_t
)
;
void
*
__wrap_malloc
(
size_t
sz
)
{
if
(
rand
(
)
<
fail_probability
)
return
NULL
;
return
malloc
(
sz
)
;
}
#
if
defined
(
HAVE_POSIX_MEMALIGN
)
int
__wrap_posix_memalign
(
void
*
*
memptr
size_t
alignment
size_t
size
)
;
int
__wrap_posix_memalign
(
void
*
*
memptr
size_t
alignment
size_t
size
)
{
if
(
rand
(
)
<
fail_probability
)
return
ENOMEM
;
return
posix_memalign
(
memptr
alignment
size
)
;
}
#
else
#
error
"
HAVE_POSIX_MEMALIGN
required
"
#
endif
