"
"
"
Adjust
dependencies
to
not
exceed
MAX_DEPENDENCIES
"
"
"
from
copy
import
deepcopy
from
gecko_taskgraph
.
transforms
.
base
import
TransformSequence
import
gecko_taskgraph
.
transforms
.
release_deps
as
release_deps
from
gecko_taskgraph
.
util
.
treeherder
import
add_suffix
from
gecko_taskgraph
import
MAX_DEPENDENCIES
transforms
=
TransformSequence
(
)
def
yield_job
(
orig_job
deps
count
)
:
    
job
=
deepcopy
(
orig_job
)
    
job
[
"
dependencies
"
]
=
deps
    
job
[
"
name
"
]
=
"
{
}
-
{
}
"
.
format
(
orig_job
[
"
name
"
]
count
)
    
if
"
treeherder
"
in
job
:
        
job
[
"
treeherder
"
]
[
"
symbol
"
]
=
add_suffix
(
            
job
[
"
treeherder
"
]
[
"
symbol
"
]
f
"
-
{
count
}
"
        
)
    
return
job
transforms
.
add
def
add_dependencies
(
config
jobs
)
:
    
for
job
in
release_deps
.
add_dependencies
(
config
jobs
)
:
        
count
=
1
        
deps
=
{
}
        
for
dep_label
in
sorted
(
job
[
"
dependencies
"
]
.
keys
(
)
)
:
            
deps
[
dep_label
]
=
dep_label
            
if
len
(
deps
)
=
=
MAX_DEPENDENCIES
:
                
yield
yield_job
(
job
deps
count
)
                
deps
=
{
}
                
count
+
=
1
        
if
deps
:
            
yield
yield_job
(
job
deps
count
)
            
count
+
=
1
