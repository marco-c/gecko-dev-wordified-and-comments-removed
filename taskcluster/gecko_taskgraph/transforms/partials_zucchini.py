"
"
"
Transform
the
partials
task
into
an
actual
task
description
.
"
"
"
from
taskgraph
.
transforms
.
base
import
TransformSequence
from
taskgraph
.
util
.
dependencies
import
get_primary_dependency
from
taskgraph
.
util
.
treeherder
import
inherit_treeherder_from_dep
from
gecko_taskgraph
.
util
.
partials
import
get_builds
from
gecko_taskgraph
.
util
.
platforms
import
architecture
transforms
=
TransformSequence
(
)
transforms
.
add
def
make_task_description
(
config
tasks
)
:
    
if
not
config
.
params
.
get
(
"
release_history
"
)
:
        
return
    
for
task
in
tasks
:
        
dep_task
=
get_primary_dependency
(
config
task
)
        
assert
dep_task
        
locale
=
task
[
"
attributes
"
]
.
get
(
"
locale
"
)
        
build_locale
=
locale
or
"
en
-
US
"
        
build_platform
=
task
[
"
attributes
"
]
[
"
build_platform
"
]
        
builds
=
get_builds
(
            
config
.
params
[
"
release_history
"
]
build_platform
build_locale
        
)
        
if
not
builds
:
            
continue
        
locale_suffix
=
"
"
        
if
locale
:
            
locale_suffix
=
f
"
{
locale
}
/
"
        
artifact_path
=
f
"
{
locale_suffix
}
target
.
complete
.
mar
"
        
task
[
"
fetches
"
]
[
dep_task
.
kind
]
=
[
artifact_path
]
        
extra_params
=
[
f
"
-
-
target
=
/
builds
/
worker
/
artifacts
/
{
locale_suffix
}
"
]
        
for
build
in
sorted
(
builds
)
:
            
url
=
builds
[
build
]
[
"
mar_url
"
]
            
extra_params
.
append
(
f
"
-
-
from_url
=
{
url
}
"
)
        
to_mar_path
=
None
        
for
artifact
in
dep_task
.
attributes
[
"
release_artifacts
"
]
:
            
if
artifact
.
endswith
(
"
.
complete
.
mar
"
)
:
                
to_mar_path
=
artifact
                
break
        
task
[
"
worker
"
]
[
"
env
"
]
[
"
TO_MAR_TASK_ID
"
]
=
{
            
"
task
-
reference
"
:
f
"
<
{
dep_task
.
kind
}
>
"
        
}
        
extra_params
.
extend
(
            
[
                
f
"
-
-
arch
=
{
architecture
(
build_platform
)
}
"
                
f
"
-
-
locale
=
{
build_locale
}
"
                
f
"
-
-
to_mar_url
=
https
:
/
/
firefox
-
ci
-
tc
.
services
.
mozilla
.
com
/
api
/
queue
/
v1
/
task
/
TO_MAR_TASK_ID
/
artifacts
/
{
to_mar_path
}
"
            
]
        
)
        
task
[
"
run
"
]
[
"
command
"
]
+
=
"
"
+
"
"
.
join
(
extra_params
)
        
task
[
"
description
"
]
=
(
            
f
"
Partials
task
for
locale
'
{
build_locale
}
'
for
build
'
{
build_platform
}
'
"
        
)
        
task
[
"
treeherder
"
]
=
inherit_treeherder_from_dep
(
task
dep_task
)
        
task
[
"
treeherder
"
]
[
"
symbol
"
]
=
f
"
pz
(
{
locale
or
'
N
'
}
)
"
        
task
[
"
worker
"
]
[
"
env
"
]
[
"
MAR_CHANNEL_ID
"
]
=
task
[
"
attributes
"
]
[
"
mar
-
channel
-
id
"
]
        
yield
task
