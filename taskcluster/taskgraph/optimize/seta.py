from
__future__
import
absolute_import
print_function
unicode_literals
import
json
import
logging
import
attr
import
requests
from
redo
import
retry
from
requests
import
exceptions
from
taskgraph
.
optimize
import
OptimizationStrategy
register_strategy
logger
=
logging
.
getLogger
(
__name__
)
SETA_PROJECTS
=
[
'
autoland
'
'
try
'
]
SETA_HIGH_PRIORITY
=
1
SETA_LOW_PRIORITY
=
5
SETA_ENDPOINT
=
"
https
:
/
/
treeherder
.
mozilla
.
org
/
api
/
project
/
%
s
/
seta
/
"
\
                
"
job
-
priorities
/
?
build_system_type
=
%
s
&
priority
=
%
s
"
attr
.
s
(
frozen
=
True
)
class
SETA
(
object
)
:
    
"
"
"
    
Interface
to
the
SETA
service
which
defines
low
-
value
tasks
that
can
be
optimized
out
    
of
the
taskgraph
.
    
"
"
"
    
low_value_tasks
=
attr
.
ib
(
factory
=
dict
init
=
False
)
    
low_value_bb_tasks
=
attr
.
ib
(
factory
=
dict
init
=
False
)
    
def
_get_task_string
(
self
task_tuple
)
:
        
task_tuple
=
[
x
for
x
in
task_tuple
if
len
(
x
)
!
=
0
]
        
if
len
(
task_tuple
)
=
=
0
:
            
return
'
'
        
if
len
(
task_tuple
)
!
=
3
:
            
return
'
'
.
join
(
task_tuple
)
        
return
'
test
-
%
s
/
%
s
-
%
s
'
%
(
task_tuple
[
0
]
task_tuple
[
1
]
task_tuple
[
2
]
)
    
def
query_low_value_tasks
(
self
project
)
:
        
low_value_tasks
=
set
(
)
        
url_low
=
SETA_ENDPOINT
%
(
project
'
taskcluster
'
SETA_LOW_PRIORITY
)
        
url_high
=
SETA_ENDPOINT
%
(
project
'
taskcluster
'
SETA_HIGH_PRIORITY
)
        
try
:
            
logger
.
debug
(
"
Retrieving
low
-
value
jobs
list
from
SETA
"
)
            
response
=
retry
(
requests
.
get
attempts
=
2
sleeptime
=
10
                             
args
=
(
url_low
)
                             
kwargs
=
{
'
timeout
'
:
60
'
headers
'
:
'
'
}
)
            
task_list
=
json
.
loads
(
response
.
content
)
.
get
(
'
jobtypes
'
'
'
)
            
if
type
(
task_list
)
=
=
dict
and
len
(
task_list
)
>
0
:
                
if
type
(
task_list
.
values
(
)
[
0
]
)
=
=
list
and
len
(
task_list
.
values
(
)
[
0
]
)
>
0
:
                    
low_value_tasks
=
set
(
task_list
.
values
(
)
[
0
]
)
            
logger
.
debug
(
"
Retrieving
high
-
value
jobs
list
from
SETA
"
)
            
response
=
retry
(
requests
.
get
attempts
=
2
sleeptime
=
10
                             
args
=
(
url_high
)
                             
kwargs
=
{
'
timeout
'
:
60
'
headers
'
:
'
'
}
)
            
task_list
=
json
.
loads
(
response
.
content
)
.
get
(
'
jobtypes
'
'
'
)
            
high_value_tasks
=
set
(
)
            
if
type
(
task_list
)
=
=
dict
and
len
(
task_list
)
>
0
:
                
if
type
(
task_list
.
values
(
)
[
0
]
)
=
=
list
and
len
(
task_list
.
values
(
)
[
0
]
)
>
0
:
                    
high_value_tasks
=
set
(
task_list
.
values
(
)
[
0
]
)
            
def
only_android_raptor
(
task
)
:
                
return
task
.
startswith
(
'
test
-
android
'
)
and
'
raptor
'
in
task
            
high_value_android_tasks
=
set
(
filter
(
only_android_raptor
high_value_tasks
)
)
            
low_value_tasks
.
update
(
high_value_android_tasks
)
            
seta_conversions
=
{
                
'
test
-
linux64
/
opt
'
:
'
test
-
linux64
-
shippable
/
opt
'
                
'
test
-
linux64
-
qr
/
opt
'
:
'
test
-
linux64
-
shippable
-
qr
/
opt
'
                
'
test
-
windows7
-
32
/
opt
'
:
'
test
-
windows7
-
32
-
shippable
/
opt
'
                
'
test
-
windows10
-
64
/
opt
'
:
'
test
-
windows10
-
64
-
shippable
/
opt
'
                
'
test
-
windows10
-
64
-
qr
/
opt
'
:
'
test
-
windows10
-
64
-
shippable
-
qr
/
opt
'
                
}
            
for
old
new
in
seta_conversions
.
iteritems
(
)
:
                
if
any
(
t
.
startswith
(
old
)
for
t
in
low_value_tasks
)
:
                    
low_value_tasks
.
update
(
                        
[
t
.
replace
(
old
new
)
for
t
in
low_value_tasks
]
                    
)
            
for
old
new
in
seta_conversions
.
iteritems
(
)
:
                
if
any
(
t
.
startswith
(
old
)
for
t
in
high_value_tasks
)
:
                    
high_value_tasks
.
update
(
                        
[
t
.
replace
(
old
new
)
for
t
in
high_value_tasks
]
                    
)
            
def
new_as_old_is_high_value
(
label
)
:
                
for
old
new
in
seta_conversions
.
iteritems
(
)
:
                    
if
label
.
startswith
(
new
)
:
                        
old_label
=
label
.
replace
(
new
old
)
                        
if
old_label
in
high_value_tasks
:
                            
return
True
                
return
False
            
low_value_tasks
=
{
                
x
for
x
in
low_value_tasks
if
not
new_as_old_is_high_value
(
x
)
            
}
            
low_value_tasks
=
{
                
x
for
x
in
low_value_tasks
if
'
build
'
not
in
x
or
'
fuzzing
'
in
x
            
}
        
except
exceptions
.
Timeout
:
            
logger
.
warning
(
"
SETA
timeout
we
will
treat
all
test
tasks
as
high
value
.
"
)
        
except
exceptions
.
ConnectionError
:
            
logger
.
warning
(
"
SETA
connection
error
we
will
treat
all
test
tasks
as
high
value
.
"
)
        
except
exceptions
.
HTTPError
:
            
logger
.
warning
(
"
We
got
bad
Http
response
from
ouija
"
                           
"
we
will
treat
all
test
tasks
as
high
value
.
"
)
        
except
exceptions
.
RequestException
as
error
:
            
logger
.
warning
(
error
)
        
except
ValueError
as
error
:
            
logger
.
warning
(
"
Invalid
JSON
possible
server
error
:
{
}
"
.
format
(
error
)
)
        
return
low_value_tasks
    
def
is_low_value_task
(
self
label
project
)
:
        
if
project
not
in
SETA_PROJECTS
:
            
return
False
        
project
=
'
autoland
'
        
if
project
not
in
self
.
low_value_tasks
:
            
self
.
low_value_tasks
[
project
]
=
self
.
query_low_value_tasks
(
project
)
        
return
label
in
self
.
low_value_tasks
[
project
]
is_low_value_task
=
SETA
(
)
.
is_low_value_task
register_strategy
(
'
seta
'
)
class
SkipLowValue
(
OptimizationStrategy
)
:
    
def
should_remove_task
(
self
task
params
_
)
:
        
return
is_low_value_task
(
task
.
label
params
[
'
project
'
]
)
