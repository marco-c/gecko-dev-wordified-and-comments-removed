"
"
"
Add
dependencies
to
release
tasks
.
"
"
"
from
__future__
import
absolute_import
print_function
unicode_literals
from
taskgraph
.
transforms
.
base
import
TransformSequence
PHASES
=
[
'
build
'
'
promote
'
'
push
'
'
ship
'
]
transforms
=
TransformSequence
(
)
def
_get_product
(
job_or_task
)
:
    
product
=
job_or_task
.
get
(
'
shipping
-
product
'
job_or_task
.
get
(
'
product
'
)
)
    
if
'
payload
'
in
job_or_task
:
        
product
=
product
or
job_or_task
[
'
payload
'
]
.
get
(
            
'
product
'
            
job_or_task
[
'
payload
'
]
.
get
(
'
properties
'
{
}
)
.
get
(
'
product
'
)
        
)
    
if
'
run
'
in
job_or_task
:
        
product
=
product
or
job_or_task
[
'
run
'
]
.
get
(
'
product
'
)
    
if
'
extra
'
in
job_or_task
:
        
product
=
product
or
job_or_task
[
'
extra
'
]
.
get
(
'
product
'
)
    
return
product
transforms
.
add
def
add_dependencies
(
config
jobs
)
:
    
for
job
in
jobs
:
        
dependencies
=
{
}
        
product
=
_get_product
(
job
)
        
phase
=
job
.
get
(
'
shipping
-
phase
'
)
        
if
product
is
None
:
            
continue
        
for
dep_task
in
config
.
kind_dependencies_tasks
:
            
if
product
=
=
'
fennec
'
:
                
attr
=
dep_task
.
attributes
.
get
                
if
attr
(
"
locale
"
)
or
attr
(
"
chunk_locales
"
)
:
                    
continue
                
if
'
old
-
id
'
in
dep_task
.
label
:
                    
continue
            
dep_phase
=
dep_task
.
attributes
.
get
(
'
shipping_phase
'
)
            
if
dep_phase
and
PHASES
.
index
(
dep_phase
)
>
PHASES
.
index
(
phase
)
:
                
continue
            
if
dep_task
.
attributes
.
get
(
"
build_platform
"
)
and
\
               
job
.
get
(
"
attributes
"
{
}
)
.
get
(
"
build_platform
"
)
:
                
if
dep_task
.
attributes
[
"
build_platform
"
]
!
=
job
[
"
attributes
"
]
[
"
build_platform
"
]
:
                    
continue
            
if
_get_product
(
dep_task
.
task
)
=
=
product
or
\
                    
dep_task
.
attributes
.
get
(
'
shipping_product
'
)
=
=
product
:
                
dependencies
[
dep_task
.
label
]
=
dep_task
.
label
        
job
.
setdefault
(
'
dependencies
'
{
}
)
.
update
(
dependencies
)
        
yield
job
