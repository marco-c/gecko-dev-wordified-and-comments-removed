"
"
"
Add
notifications
via
taskcluster
-
notify
for
release
tasks
"
"
"
from
__future__
import
absolute_import
print_function
unicode_literals
from
taskgraph
.
transforms
.
base
import
TransformSequence
from
taskgraph
.
util
.
scriptworker
import
get_release_config
from
taskgraph
.
util
.
schema
import
resolve_keyed_by
transforms
=
TransformSequence
(
)
transforms
.
add
def
add_notifications
(
config
jobs
)
:
    
release_config
=
get_release_config
(
config
)
    
for
job
in
jobs
:
        
label
=
'
{
}
-
{
}
'
.
format
(
config
.
kind
job
[
'
name
'
]
)
        
notifications
=
job
.
get
(
'
notifications
'
)
        
if
notifications
:
            
resolve_keyed_by
(
notifications
'
emails
'
label
project
=
config
.
params
[
'
project
'
]
)
            
emails
=
notifications
[
'
emails
'
]
            
format_kwargs
=
dict
(
                
task
=
job
                
config
=
config
.
__dict__
                
release_config
=
release_config
            
)
            
subject
=
notifications
[
'
subject
'
]
.
format
(
*
*
format_kwargs
)
            
message
=
notifications
[
'
message
'
]
.
format
(
*
*
format_kwargs
)
            
del
job
[
'
notifications
'
]
            
job
.
setdefault
(
'
routes
'
[
]
)
.
extend
(
                
[
'
notify
.
email
.
{
}
.
on
-
success
'
.
format
(
email
)
for
email
in
emails
]
            
)
            
job
.
setdefault
(
'
extra
'
{
}
)
.
update
(
                
{
                   
'
notify
'
:
{
                       
'
email
'
:
{
                            
'
subject
'
:
subject
                        
}
                    
}
                
}
            
)
            
if
message
:
                
job
[
'
extra
'
]
[
'
notify
'
]
[
'
email
'
]
[
'
content
'
]
=
message
        
yield
job
