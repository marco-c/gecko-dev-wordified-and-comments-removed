"
"
"
Chunk
the
partner
repack
tasks
by
subpartner
and
locale
"
"
"
from
__future__
import
absolute_import
print_function
unicode_literals
import
copy
from
mozbuild
.
chunkify
import
chunkify
from
taskgraph
.
transforms
.
base
import
TransformSequence
from
taskgraph
.
util
.
partners
import
get_partner_config_by_kind
locales_per_build_platform
transforms
=
TransformSequence
(
)
used_repack_ids_by_platform
=
{
}
def
_check_repack_ids_by_platform
(
platform
repack_id
)
:
    
"
"
"
avoid
dup
chunks
since
mac
signing
and
repackages
both
chunk
"
"
"
    
if
used_repack_ids_by_platform
.
get
(
platform
{
}
)
.
get
(
repack_id
)
:
        
return
True
    
used_repack_ids_by_platform
.
setdefault
(
platform
{
}
)
[
'
repack_id
'
]
=
True
def
_get_repack_ids_by_platform
(
partner_configs
build_platform
)
:
    
combinations
=
[
]
    
for
partner
partner_config
in
partner_configs
.
items
(
)
:
        
for
sub_partner
cfg
in
partner_config
.
items
(
)
:
            
if
build_platform
not
in
cfg
.
get
(
"
platforms
"
[
]
)
:
                
continue
            
locales
=
locales_per_build_platform
(
build_platform
cfg
.
get
(
'
locales
'
[
]
)
)
            
for
locale
in
locales
:
                
combinations
.
append
(
"
{
}
/
{
}
/
{
}
"
.
format
(
partner
sub_partner
locale
)
)
    
return
sorted
(
combinations
)
transforms
.
add
def
chunk_partners
(
config
jobs
)
:
    
partner_configs
=
get_partner_config_by_kind
(
config
config
.
kind
)
    
for
job
in
jobs
:
        
dep_job
=
job
[
'
primary
-
dependency
'
]
        
build_platform
=
dep_job
.
attributes
[
"
build_platform
"
]
        
repack_id
=
dep_job
.
task
.
get
(
'
extra
'
{
}
)
.
get
(
'
repack_id
'
)
        
repack_ids
=
dep_job
.
task
.
get
(
'
extra
'
{
}
)
.
get
(
'
repack_ids
'
)
        
if
not
any
(
[
repack_id
repack_ids
]
)
:
            
platform_repack_ids
=
_get_repack_ids_by_platform
(
partner_configs
build_platform
)
            
if
config
.
kind
in
(
"
release
-
partner
-
repack
-
signing
"
                               
"
release
-
eme
-
free
-
repack
-
signing
"
)
:
                
repacks_per_chunk
=
job
.
get
(
'
repacks
-
per
-
chunk
'
)
                
chunks
remainder
=
divmod
(
len
(
platform_repack_ids
)
repacks_per_chunk
)
                
if
remainder
:
                    
chunks
=
int
(
chunks
+
1
)
                
for
this_chunk
in
range
(
1
chunks
+
1
)
:
                    
chunk
=
chunkify
(
platform_repack_ids
this_chunk
chunks
)
                    
partner_job
=
copy
.
deepcopy
(
job
)
                    
partner_job
.
setdefault
(
'
extra
'
{
}
)
.
setdefault
(
'
repack_ids
'
chunk
)
                    
partner_job
[
'
extra
'
]
[
'
repack_suffix
'
]
=
str
(
this_chunk
)
                    
yield
partner_job
            
else
:
                
for
repack_id
in
platform_repack_ids
:
                    
if
_check_repack_ids_by_platform
(
build_platform
repack_id
)
:
                        
continue
                    
partner_job
=
copy
.
deepcopy
(
job
)
                    
partner_job
.
setdefault
(
'
extra
'
{
}
)
                    
partner_job
[
'
extra
'
]
[
'
repack_id
'
]
=
repack_id
                    
yield
partner_job
        
elif
repack_ids
:
            
for
repack_id
in
repack_ids
:
                
if
_check_repack_ids_by_platform
(
build_platform
repack_id
)
:
                    
continue
                
partner_job
=
copy
.
deepcopy
(
job
)
                
partner_job
.
setdefault
(
'
extra
'
{
}
)
.
setdefault
(
'
repack_id
'
repack_id
)
                
yield
partner_job
        
else
:
            
if
_check_repack_ids_by_platform
(
build_platform
repack_id
)
:
                
continue
            
partner_job
=
copy
.
deepcopy
(
job
)
            
partner_job
.
setdefault
(
'
extra
'
{
}
)
.
setdefault
(
'
repack_id
'
repack_id
)
            
yield
partner_job
