"
"
"
Support
for
running
jobs
that
are
invoked
via
the
run
-
task
script
.
"
"
"
from
__future__
import
absolute_import
print_function
unicode_literals
from
taskgraph
.
transforms
.
job
import
run_job_using
from
taskgraph
.
util
.
schema
import
Schema
from
taskgraph
.
transforms
.
job
.
common
import
support_vcs_checkout
from
voluptuous
import
Required
Any
run_task_schema
=
Schema
(
{
    
Required
(
'
using
'
)
:
'
run
-
task
'
    
Required
(
'
cache
-
dotcache
'
)
:
bool
    
Required
(
'
checkout
'
)
:
bool
    
Required
(
'
sparse
-
profile
'
)
:
Any
(
basestring
None
)
    
Required
(
'
comm
-
checkout
'
)
:
bool
    
Required
(
'
command
'
)
:
Any
(
[
basestring
]
basestring
)
}
)
def
common_setup
(
config
job
taskdesc
)
:
    
run
=
job
[
'
run
'
]
    
if
run
[
'
checkout
'
]
:
        
support_vcs_checkout
(
config
job
taskdesc
                             
sparse
=
bool
(
run
[
'
sparse
-
profile
'
]
)
)
    
taskdesc
[
'
worker
'
]
.
setdefault
(
'
env
'
{
}
)
[
'
MOZ_SCM_LEVEL
'
]
=
config
.
params
[
'
level
'
]
def
add_checkout_to_command
(
run
command
)
:
    
if
not
run
[
'
checkout
'
]
:
        
return
    
command
.
append
(
'
-
-
vcs
-
checkout
=
/
builds
/
worker
/
checkouts
/
gecko
'
)
    
if
run
[
'
sparse
-
profile
'
]
:
        
command
.
append
(
'
-
-
sparse
-
profile
=
build
/
sparse
-
profiles
/
%
s
'
%
                       
run
[
'
sparse
-
profile
'
]
)
docker_defaults
=
{
    
'
cache
-
dotcache
'
:
False
    
'
checkout
'
:
True
    
'
comm
-
checkout
'
:
False
    
'
sparse
-
profile
'
:
None
}
run_job_using
(
"
docker
-
worker
"
"
run
-
task
"
schema
=
run_task_schema
defaults
=
docker_defaults
)
def
docker_worker_run_task
(
config
job
taskdesc
)
:
    
run
=
job
[
'
run
'
]
    
worker
=
taskdesc
[
'
worker
'
]
=
job
[
'
worker
'
]
    
common_setup
(
config
job
taskdesc
)
    
if
run
.
get
(
'
cache
-
dotcache
'
)
:
        
worker
[
'
caches
'
]
.
append
(
{
            
'
type
'
:
'
persistent
'
            
'
name
'
:
'
level
-
{
level
}
-
{
project
}
-
dotcache
'
.
format
(
*
*
config
.
params
)
            
'
mount
-
point
'
:
'
/
builds
/
worker
/
.
cache
'
            
'
skip
-
untrusted
'
:
True
        
}
)
    
worker
.
setdefault
(
'
retry
-
exit
-
status
'
[
]
)
.
append
(
72
)
    
worker
.
setdefault
(
'
purge
-
caches
-
exit
-
status
'
[
]
)
.
append
(
72
)
    
run_command
=
run
[
'
command
'
]
    
if
isinstance
(
run_command
basestring
)
:
        
run_command
=
[
'
bash
'
'
-
cx
'
run_command
]
    
command
=
[
'
/
builds
/
worker
/
bin
/
run
-
task
'
]
    
add_checkout_to_command
(
run
command
)
    
if
run
[
'
comm
-
checkout
'
]
:
        
command
.
append
(
'
-
-
comm
-
checkout
=
/
builds
/
worker
/
checkouts
/
gecko
/
comm
'
)
    
command
.
append
(
'
-
-
fetch
-
hgfingerprint
'
)
    
command
.
append
(
'
-
-
'
)
    
command
.
extend
(
run_command
)
    
worker
[
'
command
'
]
=
command
run_job_using
(
"
native
-
engine
"
"
run
-
task
"
schema
=
run_task_schema
)
def
native_engine_run_task
(
config
job
taskdesc
)
:
    
run
=
job
[
'
run
'
]
    
worker
=
taskdesc
[
'
worker
'
]
=
job
[
'
worker
'
]
    
common_setup
(
config
job
taskdesc
)
    
worker
[
'
context
'
]
=
'
{
}
/
raw
-
file
/
{
}
/
taskcluster
/
scripts
/
run
-
task
'
.
format
(
        
config
.
params
[
'
head_repository
'
]
config
.
params
[
'
head_rev
'
]
    
)
    
if
run
.
get
(
'
cache
-
dotcache
'
)
:
        
raise
Exception
(
"
No
cache
support
on
native
-
worker
;
can
'
t
use
cache
-
dotcache
"
)
    
run_command
=
run
[
'
command
'
]
    
if
isinstance
(
run_command
basestring
)
:
        
run_command
=
[
'
bash
'
'
-
cx
'
run_command
]
    
command
=
[
'
.
/
run
-
task
'
]
    
add_checkout_to_command
(
run
command
)
    
command
.
append
(
'
-
-
'
)
    
command
.
extend
(
run_command
)
    
worker
[
'
command
'
]
=
command
