"
"
"
Support
for
running
mach
tasks
(
via
run
-
task
)
"
"
"
from
__future__
import
absolute_import
print_function
unicode_literals
from
taskgraph
.
transforms
.
job
import
run_job_using
configure_taskdesc_for_run
from
taskgraph
.
util
.
schema
import
(
    
Schema
    
taskref_or_string
)
from
voluptuous
import
Required
Optional
Any
mach_schema
=
Schema
(
{
    
Required
(
'
using
'
)
:
'
mach
'
    
Required
(
'
mach
'
)
:
taskref_or_string
    
Optional
(
'
sparse
-
profile
'
)
:
Any
(
basestring
None
)
    
Required
(
'
comm
-
checkout
'
)
:
bool
    
Required
(
'
workdir
'
)
:
basestring
}
)
defaults
=
{
    
'
comm
-
checkout
'
:
False
}
run_job_using
(
"
docker
-
worker
"
"
mach
"
schema
=
mach_schema
defaults
=
defaults
)
run_job_using
(
"
generic
-
worker
"
"
mach
"
schema
=
mach_schema
defaults
=
defaults
)
def
configure_mach
(
config
job
taskdesc
)
:
    
run
=
job
[
'
run
'
]
    
command_prefix
=
'
cd
GECKO_PATH
&
&
.
/
mach
'
    
if
job
[
'
worker
-
type
'
]
.
endswith
(
'
1014
'
)
:
        
command_prefix
=
'
cd
GECKO_PATH
&
&
LC_ALL
=
en_US
.
UTF
-
8
LANG
=
en_US
.
UTF
-
8
.
/
mach
'
    
mach
=
run
[
'
mach
'
]
    
if
isinstance
(
mach
dict
)
:
        
ref
pattern
=
next
(
iter
(
mach
.
items
(
)
)
)
        
command
=
{
ref
:
command_prefix
+
pattern
}
    
else
:
        
command
=
command_prefix
+
mach
    
run
[
'
command
'
]
=
command
    
run
[
'
using
'
]
=
'
run
-
task
'
    
del
run
[
'
mach
'
]
    
configure_taskdesc_for_run
(
config
job
taskdesc
job
[
'
worker
'
]
[
'
implementation
'
]
)
