"
"
"
Support
for
running
toolchain
-
building
jobs
via
dedicated
scripts
"
"
"
from
__future__
import
absolute_import
print_function
unicode_literals
import
hashlib
from
mozbuild
.
shellutil
import
quote
as
shell_quote
from
taskgraph
.
util
.
schema
import
Schema
from
voluptuous
import
Optional
Required
Any
from
taskgraph
.
transforms
.
job
import
run_job_using
from
taskgraph
.
transforms
.
job
.
common
import
(
    
docker_worker_add_tc_vcs_cache
    
docker_worker_add_gecko_vcs_env_vars
    
docker_worker_add_public_artifacts
    
docker_worker_add_tooltool
    
support_vcs_checkout
)
from
taskgraph
.
util
.
hash
import
hash_paths
from
taskgraph
import
GECKO
TOOLCHAIN_INDEX
=
'
gecko
.
cache
.
level
-
{
level
}
.
toolchains
.
v1
.
{
name
}
.
{
digest
}
'
toolchain_run_schema
=
Schema
(
{
    
Required
(
'
using
'
)
:
'
toolchain
-
script
'
    
Required
(
'
script
'
)
:
basestring
    
Optional
(
'
arguments
'
)
:
[
basestring
]
    
Required
(
'
tooltool
-
downloads
'
default
=
False
)
:
Any
(
        
False
        
'
public
'
        
'
internal
'
    
)
    
Optional
(
'
resources
'
)
:
[
basestring
]
    
Required
(
'
toolchain
-
artifact
'
)
:
basestring
    
Optional
(
'
toolchain
-
alias
'
)
:
basestring
}
)
def
add_optimization
(
config
run
taskdesc
)
:
    
files
=
list
(
run
.
get
(
'
resources
'
[
]
)
)
    
files
.
append
(
'
taskcluster
/
taskgraph
/
transforms
/
job
/
toolchain
.
py
'
)
    
files
.
append
(
'
taskcluster
/
scripts
/
misc
/
{
}
'
.
format
(
run
[
'
script
'
]
)
)
    
tooltool_manifest
=
taskdesc
[
'
worker
'
]
[
'
env
'
]
.
get
(
'
TOOLTOOL_MANIFEST
'
)
    
if
tooltool_manifest
:
        
files
.
append
(
tooltool_manifest
)
    
data
=
[
hash_paths
(
GECKO
files
)
]
    
deps
=
taskdesc
[
'
dependencies
'
]
    
if
deps
:
        
data
.
extend
(
sorted
(
deps
.
values
(
)
)
)
    
args
=
run
.
get
(
'
arguments
'
)
    
if
args
:
        
data
.
extend
(
args
)
    
label
=
taskdesc
[
'
label
'
]
    
subs
=
{
        
'
name
'
:
label
.
replace
(
'
%
s
-
'
%
config
.
kind
'
'
)
        
'
digest
'
:
hashlib
.
sha256
(
'
\
n
'
.
join
(
data
)
)
.
hexdigest
(
)
    
}
    
index_routes
=
[
]
    
for
level
in
reversed
(
range
(
int
(
config
.
params
[
'
level
'
]
)
4
)
)
:
        
subs
[
'
level
'
]
=
level
        
index_routes
.
append
(
TOOLCHAIN_INDEX
.
format
(
*
*
subs
)
)
    
taskdesc
[
'
optimization
'
]
=
{
'
index
-
search
'
:
index_routes
}
    
taskdesc
.
setdefault
(
'
routes
'
[
]
)
.
append
(
        
'
index
.
{
}
'
.
format
(
TOOLCHAIN_INDEX
.
format
(
*
*
subs
)
)
)
run_job_using
(
"
docker
-
worker
"
"
toolchain
-
script
"
schema
=
toolchain_run_schema
)
def
docker_worker_toolchain
(
config
job
taskdesc
)
:
    
run
=
job
[
'
run
'
]
    
taskdesc
[
'
run
-
on
-
projects
'
]
=
[
'
trunk
'
'
try
'
]
    
worker
=
taskdesc
[
'
worker
'
]
    
worker
[
'
chain
-
of
-
trust
'
]
=
True
    
artifacts
=
worker
.
setdefault
(
'
artifacts
'
[
]
)
    
if
not
any
(
artifact
.
get
(
'
name
'
)
=
=
'
public
/
build
'
for
artifact
in
artifacts
)
:
        
docker_worker_add_public_artifacts
(
config
job
taskdesc
)
    
docker_worker_add_tc_vcs_cache
(
config
job
taskdesc
)
    
docker_worker_add_gecko_vcs_env_vars
(
config
job
taskdesc
)
    
support_vcs_checkout
(
config
job
taskdesc
sparse
=
True
)
    
env
=
worker
[
'
env
'
]
    
env
.
update
(
{
        
'
MOZ_BUILD_DATE
'
:
config
.
params
[
'
moz_build_date
'
]
        
'
MOZ_SCM_LEVEL
'
:
config
.
params
[
'
level
'
]
        
'
TOOLS_DISABLE
'
:
'
true
'
        
'
MOZ_AUTOMATION
'
:
'
1
'
    
}
)
    
if
run
[
'
tooltool
-
downloads
'
]
:
        
internal
=
run
[
'
tooltool
-
downloads
'
]
=
=
'
internal
'
        
docker_worker_add_tooltool
(
config
job
taskdesc
internal
=
internal
)
    
if
run
[
'
script
'
]
.
endswith
(
'
.
py
'
)
:
        
wrapper
=
'
workspace
/
build
/
src
/
mach
python
'
    
else
:
        
wrapper
=
'
'
    
args
=
run
.
get
(
'
arguments
'
'
'
)
    
if
args
:
        
args
=
'
'
+
shell_quote
(
*
args
)
    
worker
[
'
command
'
]
=
[
        
'
/
builds
/
worker
/
bin
/
run
-
task
'
        
'
-
-
vcs
-
checkout
=
/
builds
/
worker
/
workspace
/
build
/
src
'
        
'
-
-
sparse
-
profile
'
'
build
/
sparse
-
profiles
/
toolchain
-
build
'
        
'
-
-
'
        
'
bash
'
        
'
-
c
'
        
'
cd
/
builds
/
worker
&
&
'
        
'
{
}
workspace
/
build
/
src
/
taskcluster
/
scripts
/
misc
/
{
}
{
}
'
.
format
(
            
wrapper
run
[
'
script
'
]
args
)
    
]
    
attributes
=
taskdesc
.
setdefault
(
'
attributes
'
{
}
)
    
attributes
[
'
toolchain
-
artifact
'
]
=
run
[
'
toolchain
-
artifact
'
]
    
if
'
toolchain
-
alias
'
in
run
:
        
attributes
[
'
toolchain
-
alias
'
]
=
run
[
'
toolchain
-
alias
'
]
    
add_optimization
(
config
run
taskdesc
)
run_job_using
(
"
generic
-
worker
"
"
toolchain
-
script
"
schema
=
toolchain_run_schema
)
def
windows_toolchain
(
config
job
taskdesc
)
:
    
run
=
job
[
'
run
'
]
    
taskdesc
[
'
run
-
on
-
projects
'
]
=
[
'
trunk
'
'
try
'
]
    
worker
=
taskdesc
[
'
worker
'
]
    
worker
[
'
artifacts
'
]
=
[
{
        
'
path
'
:
r
'
public
\
build
'
        
'
type
'
:
'
directory
'
    
}
]
    
worker
[
'
chain
-
of
-
trust
'
]
=
True
    
docker_worker_add_gecko_vcs_env_vars
(
config
job
taskdesc
)
    
env
=
worker
[
'
env
'
]
    
env
.
update
(
{
        
'
MOZ_BUILD_DATE
'
:
config
.
params
[
'
moz_build_date
'
]
        
'
MOZ_SCM_LEVEL
'
:
config
.
params
[
'
level
'
]
        
'
MOZ_AUTOMATION
'
:
'
1
'
    
}
)
    
hg
=
r
'
c
:
\
Program
Files
\
Mercurial
\
hg
.
exe
'
    
hg_command
=
[
'
"
{
}
"
'
.
format
(
hg
)
]
    
hg_command
.
append
(
'
robustcheckout
'
)
    
hg_command
.
extend
(
[
'
-
-
sharebase
'
'
y
:
\
\
hg
-
shared
'
]
)
    
hg_command
.
append
(
'
-
-
purge
'
)
    
hg_command
.
extend
(
[
'
-
-
upstream
'
'
https
:
/
/
hg
.
mozilla
.
org
/
mozilla
-
unified
'
]
)
    
hg_command
.
extend
(
[
'
-
-
revision
'
'
%
GECKO_HEAD_REV
%
'
]
)
    
hg_command
.
append
(
'
%
GECKO_HEAD_REPOSITORY
%
'
)
    
hg_command
.
append
(
'
.
\
\
build
\
\
src
'
)
    
if
run
[
'
script
'
]
.
endswith
(
'
.
py
'
)
:
        
raise
NotImplementedError
(
"
Python
scripts
don
'
t
work
on
Windows
"
)
    
args
=
run
.
get
(
'
arguments
'
'
'
)
    
if
args
:
        
args
=
'
'
+
shell_quote
(
*
args
)
    
bash
=
r
'
c
:
\
mozilla
-
build
\
msys
\
bin
\
bash
'
    
worker
[
'
command
'
]
=
[
        
'
'
.
join
(
hg_command
)
        
r
'
{
}
build
/
src
/
taskcluster
/
scripts
/
misc
/
{
}
{
}
'
.
format
(
            
bash
run
[
'
script
'
]
args
)
    
]
    
attributes
=
taskdesc
.
setdefault
(
'
attributes
'
{
}
)
    
attributes
[
'
toolchain
-
artifact
'
]
=
run
[
'
toolchain
-
artifact
'
]
    
if
'
toolchain
-
alias
'
in
run
:
        
attributes
[
'
toolchain
-
alias
'
]
=
run
[
'
toolchain
-
alias
'
]
    
add_optimization
(
config
run
taskdesc
)
