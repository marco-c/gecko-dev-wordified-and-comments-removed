"
"
"
Support
for
running
jobs
via
mozharness
.
Ideally
most
stuff
gets
run
this
way
and
certainly
anything
using
mozharness
should
use
this
approach
.
"
"
"
from
__future__
import
absolute_import
print_function
unicode_literals
import
json
from
textwrap
import
dedent
from
taskgraph
.
util
.
schema
import
Schema
from
voluptuous
import
Required
Optional
Any
from
voluptuous
.
validators
import
Match
from
taskgraph
.
transforms
.
job
import
(
    
configure_taskdesc_for_run
    
run_job_using
)
from
taskgraph
.
transforms
.
job
.
common
import
(
    
docker_worker_add_workspace_cache
    
setup_secrets
    
docker_worker_add_artifacts
    
generic_worker_add_artifacts
)
from
taskgraph
.
transforms
.
task
import
(
    
get_branch_repo
    
get_branch_rev
)
mozharness_run_schema
=
Schema
(
{
    
Required
(
'
using
'
)
:
'
mozharness
'
    
Required
(
'
script
'
)
:
basestring
    
Optional
(
'
config
-
paths
'
)
:
[
basestring
]
    
Required
(
'
config
'
)
:
[
basestring
]
    
Optional
(
'
actions
'
)
:
[
Match
(
        
'
^
[
a
-
z0
-
9
-
]
+
'
        
"
actions
must
be
-
seperated
alphanumeric
strings
"
    
)
]
    
Optional
(
'
options
'
)
:
[
Match
(
        
'
^
[
a
-
z0
-
9
-
]
+
(
=
[
^
]
+
)
?
'
        
"
options
must
be
-
seperated
alphanumeric
strings
(
with
optional
argument
)
"
    
)
]
    
Optional
(
'
custom
-
build
-
variant
-
cfg
'
)
:
basestring
    
Optional
(
'
extra
-
config
'
)
:
dict
    
Optional
(
'
extra
-
workspace
-
cache
-
key
'
)
:
basestring
    
Required
(
'
tooltool
-
downloads
'
)
:
Any
(
        
False
        
'
public
'
        
'
internal
'
    
)
    
Required
(
'
secrets
'
)
:
Any
(
bool
[
basestring
]
)
    
Required
(
'
taskcluster
-
proxy
'
)
:
bool
    
Required
(
'
need
-
xvfb
'
)
:
bool
    
Required
(
'
keep
-
artifacts
'
)
:
bool
    
Optional
(
'
job
-
script
'
)
:
basestring
    
Required
(
'
requires
-
signed
-
builds
'
)
:
bool
    
Optional
(
'
use
-
caches
'
)
:
bool
    
Required
(
'
use
-
simple
-
package
'
)
:
bool
    
Required
(
'
use
-
magic
-
mh
-
args
'
)
:
bool
    
Required
(
'
comm
-
checkout
'
)
:
bool
    
Required
(
'
workdir
'
)
:
basestring
}
)
mozharness_defaults
=
{
    
'
tooltool
-
downloads
'
:
False
    
'
secrets
'
:
False
    
'
taskcluster
-
proxy
'
:
False
    
'
need
-
xvfb
'
:
False
    
'
keep
-
artifacts
'
:
True
    
'
requires
-
signed
-
builds
'
:
False
    
'
use
-
simple
-
package
'
:
True
    
'
use
-
magic
-
mh
-
args
'
:
True
    
'
comm
-
checkout
'
:
False
}
run_job_using
(
"
docker
-
worker
"
"
mozharness
"
schema
=
mozharness_run_schema
               
defaults
=
mozharness_defaults
)
def
mozharness_on_docker_worker_setup
(
config
job
taskdesc
)
:
    
run
=
job
[
'
run
'
]
    
worker
=
taskdesc
[
'
worker
'
]
=
job
[
'
worker
'
]
    
if
not
run
.
pop
(
'
use
-
simple
-
package
'
None
)
:
        
raise
NotImplementedError
(
"
Simple
packaging
cannot
be
disabled
via
"
                                  
"
'
use
-
simple
-
package
'
on
docker
-
workers
"
)
    
if
not
run
.
pop
(
'
use
-
magic
-
mh
-
args
'
None
)
:
        
raise
NotImplementedError
(
"
Cannot
disabled
mh
magic
arg
passing
via
"
                                  
"
'
use
-
magic
-
mh
-
args
'
on
docker
-
workers
"
)
    
worker
.
setdefault
(
'
docker
-
image
'
{
'
in
-
tree
'
:
'
debian7
-
amd64
-
build
'
}
)
    
worker
.
setdefault
(
'
artifacts
'
[
]
)
.
append
(
{
        
'
name
'
:
'
public
/
logs
'
        
'
path
'
:
'
{
workdir
}
/
logs
/
'
.
format
(
*
*
run
)
        
'
type
'
:
'
directory
'
    
}
)
    
worker
[
'
taskcluster
-
proxy
'
]
=
run
.
pop
(
'
taskcluster
-
proxy
'
None
)
    
docker_worker_add_artifacts
(
config
job
taskdesc
)
    
docker_worker_add_workspace_cache
(
config
job
taskdesc
                                      
extra
=
run
.
pop
(
'
extra
-
workspace
-
cache
-
key
'
None
)
)
    
env
=
worker
.
setdefault
(
'
env
'
{
}
)
    
env
.
update
(
{
        
'
GECKO_PATH
'
:
'
{
workdir
}
/
workspace
/
build
/
src
'
.
format
(
*
*
run
)
        
'
MOZHARNESS_CONFIG
'
:
'
'
.
join
(
run
.
pop
(
'
config
'
)
)
        
'
MOZHARNESS_SCRIPT
'
:
run
.
pop
(
'
script
'
)
        
'
MH_BRANCH
'
:
config
.
params
[
'
project
'
]
        
'
MOZ_SOURCE_CHANGESET
'
:
get_branch_rev
(
config
)
        
'
MOZ_SOURCE_REPO
'
:
get_branch_repo
(
config
)
        
'
MH_BUILD_POOL
'
:
'
taskcluster
'
        
'
MOZ_BUILD_DATE
'
:
config
.
params
[
'
moz_build_date
'
]
        
'
MOZ_SCM_LEVEL
'
:
config
.
params
[
'
level
'
]
        
'
PYTHONUNBUFFERED
'
:
'
1
'
    
}
)
    
if
'
actions
'
in
run
:
        
env
[
'
MOZHARNESS_ACTIONS
'
]
=
'
'
.
join
(
run
.
pop
(
'
actions
'
)
)
    
if
'
options
'
in
run
:
        
env
[
'
MOZHARNESS_OPTIONS
'
]
=
'
'
.
join
(
run
.
pop
(
'
options
'
)
)
    
if
'
config
-
paths
'
in
run
:
        
env
[
'
MOZHARNESS_CONFIG_PATHS
'
]
=
'
'
.
join
(
run
.
pop
(
'
config
-
paths
'
)
)
    
if
'
custom
-
build
-
variant
-
cfg
'
in
run
:
        
env
[
'
MH_CUSTOM_BUILD_VARIANT_CFG
'
]
=
run
.
pop
(
'
custom
-
build
-
variant
-
cfg
'
)
    
if
'
extra
-
config
'
in
run
:
        
env
[
'
EXTRA_MOZHARNESS_CONFIG
'
]
=
json
.
dumps
(
run
.
pop
(
'
extra
-
config
'
)
)
    
if
'
job
-
script
'
in
run
:
        
env
[
'
JOB_SCRIPT
'
]
=
run
[
'
job
-
script
'
]
    
if
config
.
params
.
is_try
(
)
:
        
env
[
'
TRY_COMMIT_MSG
'
]
=
config
.
params
[
'
message
'
]
    
if
not
run
.
pop
(
'
keep
-
artifacts
'
)
:
        
env
[
'
DIST_TARGET_UPLOADS
'
]
=
'
'
        
env
[
'
DIST_UPLOADS
'
]
=
'
'
    
if
run
.
pop
(
'
need
-
xvfb
'
)
:
        
env
[
'
NEED_XVFB
'
]
=
'
true
'
    
else
:
        
env
[
'
NEED_XVFB
'
]
=
'
false
'
    
worker
[
'
retry
-
exit
-
status
'
]
=
[
4
]
    
setup_secrets
(
config
job
taskdesc
)
    
run
[
'
using
'
]
=
'
run
-
task
'
    
run
[
'
command
'
]
=
[
        
'
{
workdir
}
/
workspace
/
build
/
src
/
{
script
}
'
.
format
(
            
workdir
=
run
[
'
workdir
'
]
            
script
=
run
.
pop
(
'
job
-
script
'
'
taskcluster
/
scripts
/
builder
/
build
-
linux
.
sh
'
)
        
)
    
]
    
run
.
pop
(
'
secrets
'
)
    
run
.
pop
(
'
requires
-
signed
-
builds
'
)
    
configure_taskdesc_for_run
(
config
job
taskdesc
worker
[
'
implementation
'
]
)
run_job_using
(
"
generic
-
worker
"
"
mozharness
"
schema
=
mozharness_run_schema
               
defaults
=
mozharness_defaults
)
def
mozharness_on_generic_worker
(
config
job
taskdesc
)
:
    
assert
(
        
job
[
"
worker
"
]
[
"
os
"
]
=
=
"
windows
"
    
)
"
only
supports
windows
right
now
:
{
}
"
.
format
(
job
[
"
label
"
]
)
    
run
=
job
[
'
run
'
]
    
invalid
=
[
]
    
for
prop
in
[
'
need
-
xvfb
'
]
:
        
if
prop
in
run
and
run
.
pop
(
prop
)
:
            
invalid
.
append
(
prop
)
    
if
not
run
.
pop
(
'
keep
-
artifacts
'
True
)
:
        
invalid
.
append
(
'
keep
-
artifacts
'
)
    
if
invalid
:
        
raise
Exception
(
"
Jobs
run
using
mozharness
on
Windows
do
not
support
properties
"
+
                        
'
'
.
join
(
invalid
)
)
    
worker
=
taskdesc
[
'
worker
'
]
=
job
[
'
worker
'
]
    
worker
[
'
taskcluster
-
proxy
'
]
=
run
.
pop
(
'
taskcluster
-
proxy
'
None
)
    
setup_secrets
(
config
job
taskdesc
)
    
taskdesc
[
'
worker
'
]
.
setdefault
(
'
artifacts
'
[
]
)
.
append
(
{
        
'
name
'
:
'
public
/
logs
'
        
'
path
'
:
'
logs
'
        
'
type
'
:
'
directory
'
    
}
)
    
if
not
worker
.
get
(
'
skip
-
artifacts
'
False
)
:
        
generic_worker_add_artifacts
(
config
job
taskdesc
)
    
env
=
worker
[
'
env
'
]
    
env
.
update
(
{
        
'
MOZ_BUILD_DATE
'
:
config
.
params
[
'
moz_build_date
'
]
        
'
MOZ_SCM_LEVEL
'
:
config
.
params
[
'
level
'
]
        
'
MH_BRANCH
'
:
config
.
params
[
'
project
'
]
        
'
MOZ_SOURCE_CHANGESET
'
:
get_branch_rev
(
config
)
        
'
MOZ_SOURCE_REPO
'
:
get_branch_repo
(
config
)
    
}
)
    
if
run
.
pop
(
'
use
-
simple
-
package
'
)
:
        
env
.
update
(
{
'
MOZ_SIMPLE_PACKAGE_NAME
'
:
'
target
'
}
)
    
if
'
extra
-
config
'
in
run
:
        
env
[
'
EXTRA_MOZHARNESS_CONFIG
'
]
=
json
.
dumps
(
run
.
pop
(
'
extra
-
config
'
)
)
    
if
config
.
params
.
is_try
(
)
:
        
env
[
'
TRY_COMMIT_MSG
'
]
=
config
.
params
[
'
message
'
]
or
'
no
commit
message
'
    
if
not
job
[
'
attributes
'
]
[
'
build_platform
'
]
.
startswith
(
'
win
'
)
:
        
raise
Exception
(
            
"
Task
generation
for
mozharness
build
jobs
currently
only
supported
on
Windows
"
        
)
    
mh_command
=
[
            
'
c
:
/
mozilla
-
build
/
python
/
python
.
exe
'
            
'
%
GECKO_PATH
%
/
testing
/
{
}
'
.
format
(
run
.
pop
(
'
script
'
)
)
    
]
    
for
path
in
run
.
pop
(
'
config
-
paths
'
[
]
)
:
        
mh_command
.
append
(
'
-
-
extra
-
config
-
path
%
GECKO_PATH
%
/
{
}
'
.
format
(
path
)
)
    
for
cfg
in
run
.
pop
(
'
config
'
)
:
        
mh_command
.
append
(
'
-
-
config
'
+
cfg
)
    
if
run
.
pop
(
'
use
-
magic
-
mh
-
args
'
)
:
        
mh_command
.
append
(
'
-
-
branch
'
+
config
.
params
[
'
project
'
]
)
    
mh_command
.
append
(
r
'
-
-
work
-
dir
%
cd
:
Z
:
=
z
:
%
\
build
'
)
    
for
action
in
run
.
pop
(
'
actions
'
[
]
)
:
        
mh_command
.
append
(
'
-
-
'
+
action
)
    
for
option
in
run
.
pop
(
'
options
'
[
]
)
:
        
mh_command
.
append
(
'
-
-
'
+
option
)
    
if
run
.
get
(
'
custom
-
build
-
variant
-
cfg
'
)
:
        
mh_command
.
append
(
'
-
-
custom
-
build
-
variant
'
)
        
mh_command
.
append
(
run
.
pop
(
'
custom
-
build
-
variant
-
cfg
'
)
)
    
run
[
'
using
'
]
=
'
run
-
task
'
    
run
[
'
command
'
]
=
mh_command
    
run
.
pop
(
'
secrets
'
)
    
run
.
pop
(
'
requires
-
signed
-
builds
'
)
    
run
.
pop
(
'
job
-
script
'
None
)
    
run
.
pop
(
'
extra
-
workspace
-
cache
-
key
'
None
)
    
configure_taskdesc_for_run
(
config
job
taskdesc
worker
[
'
implementation
'
]
)
    
mozbase_dir
=
"
{
}
/
testing
/
mozbase
"
.
format
(
env
[
'
GECKO_PATH
'
]
)
    
env
[
'
PYTHONPATH
'
]
=
'
;
'
.
join
(
[
        
"
{
}
/
manifestparser
"
.
format
(
mozbase_dir
)
        
"
{
}
/
mozinfo
"
.
format
(
mozbase_dir
)
        
"
{
}
/
mozfile
"
.
format
(
mozbase_dir
)
        
"
{
}
/
mozprocess
"
.
format
(
mozbase_dir
)
        
"
{
}
/
third_party
/
python
/
six
"
.
format
(
env
[
'
GECKO_PATH
'
]
)
    
]
)
    
if
taskdesc
.
get
(
'
needs
-
sccache
'
)
:
        
worker
[
'
command
'
]
=
[
            
dedent
(
'
'
'
\
            
:
:
sccache
currently
uses
the
full
compiler
commandline
as
input
to
the
            
:
:
cache
hash
key
so
create
a
symlink
to
the
task
dir
and
build
from
            
:
:
the
symlink
dir
to
get
consistent
paths
.
            
if
exist
z
:
\
\
build
rmdir
z
:
\
\
build
'
'
'
)
            
r
'
mklink
/
d
z
:
\
build
%
cd
%
'
            
r
'
icacls
z
:
\
build
/
grant
*
S
-
1
-
1
-
0
:
D
/
L
'
            
r
'
cd
/
d
z
:
\
build
'
        
]
+
worker
[
'
command
'
]
