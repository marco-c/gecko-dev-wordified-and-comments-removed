from
__future__
import
absolute_import
print_function
unicode_literals
from
datetime
import
datetime
from
time
import
mktime
import
pytest
from
mozunit
import
main
from
taskgraph
.
util
.
backstop
import
is_backstop
pytest
.
fixture
(
scope
=
'
module
'
)
def
params
(
)
:
    
return
{
        
'
branch
'
:
'
integration
/
autoland
'
        
'
head_repository
'
:
'
https
:
/
/
hg
.
mozilla
.
org
/
integration
/
autoland
'
        
'
head_rev
'
:
'
abcdef
'
        
'
project
'
:
'
autoland
'
        
'
pushlog_id
'
:
1
        
'
pushdate
'
:
mktime
(
datetime
.
now
(
)
.
timetuple
(
)
)
    
}
def
test_is_backstop
(
responses
params
)
:
    
responses
.
add
(
        
responses
.
GET
        
"
https
:
/
/
hg
.
mozilla
.
org
/
integration
/
autoland
/
json
-
pushes
/
?
version
=
2
&
startID
=
16
&
endID
=
17
"
        
json
=
{
"
pushes
"
:
{
"
17
"
:
{
}
}
}
        
status
=
200
    
)
    
params
[
'
pushlog_id
'
]
=
18
    
assert
is_backstop
(
params
)
    
responses
.
add
(
        
responses
.
GET
        
"
https
:
/
/
hg
.
mozilla
.
org
/
integration
/
autoland
/
json
-
pushes
/
?
version
=
2
&
startID
=
17
&
endID
=
18
"
        
json
=
{
"
pushes
"
:
{
"
18
"
:
{
"
date
"
:
params
[
'
pushdate
'
]
}
}
}
        
status
=
200
    
)
    
params
[
'
pushlog_id
'
]
=
19
    
params
[
'
pushdate
'
]
+
=
3599
    
assert
not
is_backstop
(
params
)
    
params
[
'
pushlog_id
'
]
=
20
    
params
[
'
pushdate
'
]
+
=
1
    
assert
is_backstop
(
params
)
    
responses
.
add
(
        
responses
.
GET
        
"
https
:
/
/
hg
.
mozilla
.
org
/
integration
/
autoland
/
json
-
pushes
/
?
version
=
2
&
startID
=
19
&
endID
=
20
"
        
json
=
{
"
pushes
"
:
{
"
20
"
:
{
"
date
"
:
params
[
'
pushdate
'
]
}
}
}
        
status
=
200
    
)
    
params
[
'
pushlog_id
'
]
=
21
    
params
[
'
pushdate
'
]
+
=
4
*
3600
    
assert
is_backstop
(
params
)
if
__name__
=
=
'
__main__
'
:
    
main
(
)
