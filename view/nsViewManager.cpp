#
include
"
nsViewManager
.
h
"
#
include
"
mozilla
/
MouseEvents
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
PresShellInlines
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
ProfilerLabels
.
h
"
#
include
"
mozilla
/
StartupTimeline
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsGfxCIID
.
h
"
#
include
"
nsView
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsRegion
.
h
"
#
include
"
nsCOMArray
.
h
"
#
include
"
nsXULPopupManager
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsRefreshDriver
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
WindowRenderer
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
layers
;
#
define
NSCOORD_NONE
INT32_MIN
#
undef
DEBUG_MOUSE_LOCATION
uint32_t
nsViewManager
:
:
gLastUserEventTime
=
0
;
nsViewManager
:
:
nsViewManager
(
)
:
mPresShell
(
nullptr
)
mDelayedResize
(
NSCOORD_NONE
NSCOORD_NONE
)
mRootView
(
nullptr
)
mPainting
(
false
)
mHasPendingWidgetGeometryChanges
(
false
)
{
}
nsViewManager
:
:
~
nsViewManager
(
)
{
if
(
mRootView
)
{
mRootView
-
>
Destroy
(
)
;
mRootView
=
nullptr
;
}
MOZ_RELEASE_ASSERT
(
!
mPresShell
"
Releasing
nsViewManager
without
having
called
Destroy
on
"
"
the
PresShell
!
"
)
;
}
nsView
*
nsViewManager
:
:
CreateView
(
const
nsSize
&
aSize
)
{
auto
*
v
=
new
nsView
(
this
)
;
nsRect
dim
(
nsPoint
(
)
aSize
)
;
v
-
>
SetDimensions
(
dim
)
;
return
v
;
}
void
nsViewManager
:
:
SetRootView
(
nsView
*
aView
)
{
MOZ_ASSERT
(
!
aView
|
|
aView
-
>
GetViewManager
(
)
=
=
this
"
Unexpected
viewmanager
on
root
view
"
)
;
mRootView
=
aView
;
}
nsSize
nsViewManager
:
:
GetWindowDimensions
(
)
const
{
if
(
!
mRootView
)
{
return
{
}
;
}
if
(
mDelayedResize
!
=
nsSize
(
NSCOORD_NONE
NSCOORD_NONE
)
)
{
return
mDelayedResize
;
}
return
mRootView
-
>
GetBounds
(
)
.
Size
(
)
;
}
void
nsViewManager
:
:
DoSetWindowDimensions
(
const
nsSize
&
aSize
)
{
if
(
mRootView
-
>
GetBounds
(
)
.
Size
(
)
=
=
aSize
)
{
return
;
}
mRootView
-
>
SetDimensions
(
nsRect
(
nsPoint
(
)
aSize
)
)
;
if
(
RefPtr
<
PresShell
>
presShell
=
mPresShell
)
{
presShell
-
>
ResizeReflow
(
aSize
)
;
}
}
bool
nsViewManager
:
:
ShouldDelayResize
(
)
const
{
MOZ_ASSERT
(
mRootView
)
;
if
(
!
mPresShell
|
|
!
mPresShell
-
>
IsVisible
(
)
)
{
return
true
;
}
if
(
nsRefreshDriver
*
rd
=
mPresShell
-
>
GetRefreshDriver
(
)
)
{
if
(
rd
-
>
IsResizeSuppressed
(
)
)
{
return
true
;
}
}
return
false
;
}
void
nsViewManager
:
:
SetWindowDimensions
(
const
nsSize
&
aSize
bool
aDelayResize
)
{
if
(
!
mRootView
)
{
return
;
}
if
(
!
ShouldDelayResize
(
)
&
&
!
aDelayResize
)
{
if
(
mDelayedResize
!
=
nsSize
(
NSCOORD_NONE
NSCOORD_NONE
)
&
&
mDelayedResize
!
=
aSize
)
{
mDelayedResize
=
aSize
;
FlushDelayedResize
(
)
;
}
mDelayedResize
.
SizeTo
(
NSCOORD_NONE
NSCOORD_NONE
)
;
DoSetWindowDimensions
(
aSize
)
;
}
else
{
mDelayedResize
=
aSize
;
if
(
mPresShell
)
{
mPresShell
-
>
SetNeedStyleFlush
(
)
;
mPresShell
-
>
SetNeedLayoutFlush
(
)
;
}
}
}
void
nsViewManager
:
:
FlushDelayedResize
(
)
{
if
(
mDelayedResize
!
=
nsSize
(
NSCOORD_NONE
NSCOORD_NONE
)
)
{
DoSetWindowDimensions
(
mDelayedResize
)
;
mDelayedResize
.
SizeTo
(
NSCOORD_NONE
NSCOORD_NONE
)
;
}
}
nsViewManager
*
nsViewManager
:
:
RootViewManager
(
)
const
{
const
auto
*
cur
=
this
;
while
(
auto
*
parent
=
cur
-
>
GetParentViewManager
(
)
)
{
cur
=
parent
;
}
return
const_cast
<
nsViewManager
*
>
(
cur
)
;
}
nsViewManager
*
nsViewManager
:
:
GetParentViewManager
(
)
const
{
if
(
!
mPresShell
)
{
return
nullptr
;
}
auto
*
pc
=
mPresShell
-
>
GetPresContext
(
)
;
if
(
auto
*
parent
=
pc
-
>
GetParentPresContext
(
)
)
{
return
parent
-
>
PresShell
(
)
-
>
GetViewManager
(
)
;
}
return
nullptr
;
}
void
nsViewManager
:
:
Refresh
(
nsView
*
aView
const
LayoutDeviceIntRegion
&
aRegion
)
{
NS_ASSERTION
(
aView
-
>
GetViewManager
(
)
=
=
this
"
wrong
view
manager
"
)
;
if
(
mPresShell
&
&
mPresShell
-
>
IsNeverPainting
(
)
)
{
return
;
}
if
(
aRegion
.
IsEmpty
(
)
)
{
return
;
}
nsIWidget
*
widget
=
aView
-
>
GetWidget
(
)
;
if
(
!
widget
)
{
return
;
}
MOZ_ASSERT
(
!
IsPainting
(
)
"
recursive
painting
not
permitted
"
)
;
if
(
NS_WARN_IF
(
IsPainting
(
)
)
)
{
return
;
}
{
nsAutoScriptBlocker
scriptBlocker
;
SetPainting
(
true
)
;
MOZ_ASSERT
(
!
aView
-
>
GetFrame
(
)
|
|
!
aView
-
>
GetFrame
(
)
-
>
GetParent
(
)
"
Frame
should
be
a
display
root
"
)
;
if
(
RefPtr
<
PresShell
>
presShell
=
mPresShell
)
{
#
ifdef
MOZ_DUMP_PAINTING
if
(
nsLayoutUtils
:
:
InvalidationDebuggingIsEnabled
(
)
)
{
printf_stderr
(
"
-
-
COMPOSITE
-
-
%
p
\
n
"
presShell
.
get
(
)
)
;
}
#
endif
RefPtr
<
WindowRenderer
>
renderer
=
widget
-
>
GetWindowRenderer
(
)
;
if
(
!
renderer
-
>
NeedsWidgetInvalidation
(
)
)
{
renderer
-
>
FlushRendering
(
wr
:
:
RenderReasons
:
:
WIDGET
)
;
}
else
{
presShell
-
>
SyncPaintFallback
(
aView
-
>
GetFrame
(
)
renderer
)
;
}
#
ifdef
MOZ_DUMP_PAINTING
if
(
nsLayoutUtils
:
:
InvalidationDebuggingIsEnabled
(
)
)
{
printf_stderr
(
"
-
-
ENDCOMPOSITE
-
-
\
n
"
)
;
}
#
endif
mozilla
:
:
StartupTimeline
:
:
RecordOnce
(
mozilla
:
:
StartupTimeline
:
:
FIRST_PAINT
)
;
}
SetPainting
(
false
)
;
}
}
void
nsViewManager
:
:
ProcessPendingUpdatesForView
(
nsView
*
aView
bool
aFlushDirtyRegion
)
{
NS_ASSERTION
(
IsRootVM
(
)
"
Updates
will
be
missed
"
)
;
if
(
!
aView
)
{
return
;
}
RefPtr
<
PresShell
>
rootPresShell
=
mPresShell
;
AutoTArray
<
nsCOMPtr
<
nsIWidget
>
1
>
widgets
;
aView
-
>
GetViewManager
(
)
-
>
ProcessPendingUpdatesRecurse
(
aView
widgets
)
;
for
(
uint32_t
i
=
0
;
i
<
widgets
.
Length
(
)
;
+
+
i
)
{
nsView
*
view
=
nsView
:
:
GetViewFor
(
widgets
[
i
]
)
;
if
(
!
view
)
{
continue
;
}
if
(
view
-
>
mNeedsWindowPropertiesSync
)
{
view
-
>
mNeedsWindowPropertiesSync
=
false
;
if
(
nsViewManager
*
vm
=
view
-
>
GetViewManager
(
)
)
{
if
(
PresShell
*
presShell
=
vm
-
>
GetPresShell
(
)
)
{
presShell
-
>
SyncWindowProperties
(
true
)
;
}
}
}
}
if
(
rootPresShell
-
>
GetViewManager
(
)
!
=
this
)
{
return
;
}
if
(
aFlushDirtyRegion
)
{
nsAutoScriptBlocker
scriptBlocker
;
SetPainting
(
true
)
;
for
(
nsIWidget
*
widget
:
widgets
)
{
if
(
nsView
*
view
=
nsView
:
:
GetViewFor
(
widget
)
)
{
RefPtr
<
nsViewManager
>
viewManager
=
view
-
>
GetViewManager
(
)
;
viewManager
-
>
ProcessPendingUpdatesPaint
(
MOZ_KnownLive
(
widget
)
)
;
}
}
SetPainting
(
false
)
;
}
}
void
nsViewManager
:
:
ProcessPendingUpdatesRecurse
(
nsView
*
aView
AutoTArray
<
nsCOMPtr
<
nsIWidget
>
1
>
&
aWidgets
)
{
if
(
mPresShell
&
&
mPresShell
-
>
IsNeverPainting
(
)
)
{
return
;
}
if
(
nsIWidget
*
widget
=
aView
-
>
GetWidget
(
)
)
{
aWidgets
.
AppendElement
(
widget
)
;
}
}
void
nsViewManager
:
:
ProcessPendingUpdatesPaint
(
nsIWidget
*
aWidget
)
{
if
(
aWidget
-
>
NeedsPaint
(
)
)
{
if
(
mDelayedResize
!
=
nsSize
(
NSCOORD_NONE
NSCOORD_NONE
)
&
&
mPresShell
&
&
mPresShell
-
>
IsVisible
(
)
)
{
FlushDelayedResize
(
)
;
}
nsView
*
view
=
nsView
:
:
GetViewFor
(
aWidget
)
;
if
(
!
view
)
{
NS_ERROR
(
"
FlushDelayedResize
destroyed
the
nsView
?
"
)
;
return
;
}
nsIWidgetListener
*
previousListener
=
aWidget
-
>
GetPreviouslyAttachedWidgetListener
(
)
;
if
(
previousListener
&
&
previousListener
!
=
view
&
&
view
-
>
IsPrimaryFramePaintSuppressed
(
)
)
{
return
;
}
if
(
RefPtr
<
PresShell
>
presShell
=
mPresShell
)
{
#
ifdef
MOZ_DUMP_PAINTING
if
(
nsLayoutUtils
:
:
InvalidationDebuggingIsEnabled
(
)
)
{
printf_stderr
(
"
-
-
-
-
PAINT
START
-
-
-
-
PresShell
(
%
p
)
nsView
(
%
p
)
nsIWidget
(
%
p
)
\
n
"
presShell
.
get
(
)
view
aWidget
)
;
}
#
endif
presShell
-
>
PaintAndRequestComposite
(
view
-
>
GetFrame
(
)
aWidget
-
>
GetWindowRenderer
(
)
PaintFlags
:
:
None
)
;
view
-
>
SetForcedRepaint
(
false
)
;
#
ifdef
MOZ_DUMP_PAINTING
if
(
nsLayoutUtils
:
:
InvalidationDebuggingIsEnabled
(
)
)
{
printf_stderr
(
"
-
-
-
-
PAINT
END
-
-
-
-
\
n
"
)
;
}
#
endif
}
}
}
void
nsViewManager
:
:
PostPendingUpdate
(
)
{
nsViewManager
*
rootVM
=
RootViewManager
(
)
;
rootVM
-
>
mHasPendingWidgetGeometryChanges
=
true
;
if
(
rootVM
-
>
mPresShell
)
{
rootVM
-
>
mPresShell
-
>
SetNeedLayoutFlush
(
)
;
rootVM
-
>
mPresShell
-
>
SchedulePaint
(
)
;
}
}
void
nsViewManager
:
:
WillPaintWindow
(
nsIWidget
*
aWidget
)
{
if
(
aWidget
)
{
nsView
*
view
=
nsView
:
:
GetViewFor
(
aWidget
)
;
WindowRenderer
*
renderer
=
aWidget
-
>
GetWindowRenderer
(
)
;
if
(
view
&
&
(
view
-
>
ForcedRepaint
(
)
|
|
!
renderer
-
>
NeedsWidgetInvalidation
(
)
)
)
{
ProcessPendingUpdates
(
)
;
view
=
nsView
:
:
GetViewFor
(
aWidget
)
;
if
(
view
)
{
view
-
>
SetForcedRepaint
(
false
)
;
}
}
}
}
bool
nsViewManager
:
:
PaintWindow
(
nsIWidget
*
aWidget
const
LayoutDeviceIntRegion
&
aRegion
)
{
if
(
!
aWidget
)
{
return
false
;
}
nsView
*
view
=
nsView
:
:
GetViewFor
(
aWidget
)
;
if
(
view
&
&
!
aRegion
.
IsEmpty
(
)
)
{
Refresh
(
view
aRegion
)
;
}
return
true
;
}
void
nsViewManager
:
:
DidPaintWindow
(
)
{
if
(
RefPtr
<
PresShell
>
presShell
=
mPresShell
)
{
presShell
-
>
DidPaintWindow
(
)
;
}
}
void
nsViewManager
:
:
DispatchEvent
(
WidgetGUIEvent
*
aEvent
nsView
*
aView
nsEventStatus
*
aStatus
)
{
AUTO_PROFILER_LABEL
(
"
nsViewManager
:
:
DispatchEvent
"
OTHER
)
;
WidgetMouseEvent
*
mouseEvent
=
aEvent
-
>
AsMouseEvent
(
)
;
if
(
(
mouseEvent
&
&
mouseEvent
-
>
mReason
=
=
WidgetMouseEvent
:
:
eReal
&
&
mouseEvent
-
>
mMessage
!
=
eMouseExitFromWidget
&
&
mouseEvent
-
>
mMessage
!
=
eMouseEnterIntoWidget
)
|
|
aEvent
-
>
HasKeyEventMessage
(
)
|
|
aEvent
-
>
HasIMEEventMessage
(
)
)
{
gLastUserEventTime
=
PR_IntervalToMicroseconds
(
PR_IntervalNow
(
)
)
;
}
if
(
nsIFrame
*
frame
=
aView
-
>
GetFrame
(
)
)
{
if
(
RefPtr
<
PresShell
>
presShell
=
aView
-
>
GetViewManager
(
)
-
>
GetPresShell
(
)
)
{
presShell
-
>
HandleEvent
(
frame
aEvent
false
aStatus
)
;
return
;
}
}
*
aStatus
=
nsEventStatus_eIgnore
;
}
void
nsViewManager
:
:
ResizeView
(
nsView
*
aView
const
nsRect
&
aRect
)
{
NS_ASSERTION
(
aView
-
>
GetViewManager
(
)
=
=
this
"
wrong
view
manager
"
)
;
nsRect
oldDimensions
=
aView
-
>
GetBounds
(
)
;
if
(
!
oldDimensions
.
IsEqualEdges
(
aRect
)
)
{
aView
-
>
SetDimensions
(
aRect
)
;
}
}
void
nsViewManager
:
:
IsPainting
(
bool
&
aIsPainting
)
{
aIsPainting
=
IsPainting
(
)
;
}
void
nsViewManager
:
:
ProcessPendingUpdates
(
)
{
if
(
!
IsRootVM
(
)
)
{
RefPtr
<
nsViewManager
>
rootViewManager
=
RootViewManager
(
)
;
rootViewManager
-
>
ProcessPendingUpdates
(
)
;
return
;
}
if
(
mPresShell
)
{
RefPtr
<
nsViewManager
>
strongThis
(
this
)
;
CallWillPaintOnObservers
(
)
;
ProcessPendingUpdatesForView
(
mRootView
true
)
;
}
}
void
nsViewManager
:
:
UpdateWidgetGeometry
(
)
{
if
(
!
IsRootVM
(
)
)
{
RefPtr
<
nsViewManager
>
rootViewManager
=
RootViewManager
(
)
;
rootViewManager
-
>
UpdateWidgetGeometry
(
)
;
return
;
}
if
(
mHasPendingWidgetGeometryChanges
)
{
mHasPendingWidgetGeometryChanges
=
false
;
ProcessPendingUpdatesForView
(
mRootView
false
)
;
}
}
void
nsViewManager
:
:
CollectVMsForWillPaint
(
nsView
*
aView
nsViewManager
*
aParentVM
nsTArray
<
RefPtr
<
nsViewManager
>
>
&
aVMs
)
{
nsViewManager
*
vm
=
aView
-
>
GetViewManager
(
)
;
if
(
vm
!
=
aParentVM
)
{
aVMs
.
AppendElement
(
vm
)
;
}
}
void
nsViewManager
:
:
CallWillPaintOnObservers
(
)
{
MOZ_ASSERT
(
IsRootVM
(
)
"
Must
be
root
VM
for
this
to
be
called
!
"
)
;
if
(
!
mRootView
)
{
return
;
}
AutoTArray
<
RefPtr
<
nsViewManager
>
2
>
VMs
;
CollectVMsForWillPaint
(
mRootView
nullptr
VMs
)
;
for
(
const
auto
&
vm
:
VMs
)
{
if
(
vm
-
>
GetRootView
(
)
)
{
if
(
RefPtr
<
PresShell
>
presShell
=
vm
-
>
GetPresShell
(
)
)
{
presShell
-
>
WillPaint
(
)
;
}
}
}
}
