#
include
"
nsViewManager
.
h
"
#
include
"
mozilla
/
MouseEvents
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
PresShellInlines
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
ProfilerLabels
.
h
"
#
include
"
mozilla
/
StartupTimeline
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsGfxCIID
.
h
"
#
include
"
nsView
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsRegion
.
h
"
#
include
"
nsCOMArray
.
h
"
#
include
"
nsXULPopupManager
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsRefreshDriver
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
WindowRenderer
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
layers
;
#
define
NSCOORD_NONE
INT32_MIN
#
undef
DEBUG_MOUSE_LOCATION
uint32_t
nsViewManager
:
:
gLastUserEventTime
=
0
;
nsViewManager
:
:
nsViewManager
(
)
:
mPresShell
(
nullptr
)
mDelayedResize
(
NSCOORD_NONE
NSCOORD_NONE
)
mRootView
(
nullptr
)
{
}
nsViewManager
:
:
~
nsViewManager
(
)
{
if
(
mRootView
)
{
mRootView
-
>
Destroy
(
)
;
mRootView
=
nullptr
;
}
MOZ_RELEASE_ASSERT
(
!
mPresShell
"
Releasing
nsViewManager
without
having
called
Destroy
on
"
"
the
PresShell
!
"
)
;
}
nsView
*
nsViewManager
:
:
CreateView
(
const
nsSize
&
aSize
)
{
auto
*
v
=
new
nsView
(
this
)
;
v
-
>
SetSize
(
aSize
)
;
return
v
;
}
void
nsViewManager
:
:
SetRootView
(
nsView
*
aView
)
{
MOZ_ASSERT
(
!
aView
|
|
aView
-
>
GetViewManager
(
)
=
=
this
"
Unexpected
viewmanager
on
root
view
"
)
;
mRootView
=
aView
;
}
nsSize
nsViewManager
:
:
GetWindowDimensions
(
)
const
{
if
(
!
mRootView
)
{
return
{
}
;
}
if
(
mDelayedResize
!
=
nsSize
(
NSCOORD_NONE
NSCOORD_NONE
)
)
{
return
mDelayedResize
;
}
return
mRootView
-
>
GetSize
(
)
;
}
void
nsViewManager
:
:
DoSetWindowDimensions
(
const
nsSize
&
aSize
)
{
if
(
mRootView
-
>
GetSize
(
)
=
=
aSize
)
{
return
;
}
mRootView
-
>
SetSize
(
aSize
)
;
if
(
RefPtr
<
PresShell
>
presShell
=
mPresShell
)
{
presShell
-
>
ResizeReflow
(
aSize
)
;
}
}
bool
nsViewManager
:
:
ShouldDelayResize
(
)
const
{
MOZ_ASSERT
(
mRootView
)
;
if
(
!
mPresShell
|
|
!
mPresShell
-
>
IsVisible
(
)
)
{
return
true
;
}
if
(
nsRefreshDriver
*
rd
=
mPresShell
-
>
GetRefreshDriver
(
)
)
{
if
(
rd
-
>
IsResizeSuppressed
(
)
)
{
return
true
;
}
}
return
false
;
}
void
nsViewManager
:
:
SetWindowDimensions
(
const
nsSize
&
aSize
bool
aDelayResize
)
{
if
(
!
mRootView
)
{
return
;
}
if
(
!
ShouldDelayResize
(
)
&
&
!
aDelayResize
)
{
if
(
mDelayedResize
!
=
nsSize
(
NSCOORD_NONE
NSCOORD_NONE
)
&
&
mDelayedResize
!
=
aSize
)
{
mDelayedResize
=
aSize
;
FlushDelayedResize
(
)
;
}
mDelayedResize
.
SizeTo
(
NSCOORD_NONE
NSCOORD_NONE
)
;
DoSetWindowDimensions
(
aSize
)
;
}
else
{
mDelayedResize
=
aSize
;
if
(
mPresShell
)
{
mPresShell
-
>
SetNeedStyleFlush
(
)
;
mPresShell
-
>
SetNeedLayoutFlush
(
)
;
}
}
}
void
nsViewManager
:
:
FlushDelayedResize
(
)
{
if
(
mDelayedResize
!
=
nsSize
(
NSCOORD_NONE
NSCOORD_NONE
)
)
{
DoSetWindowDimensions
(
mDelayedResize
)
;
mDelayedResize
.
SizeTo
(
NSCOORD_NONE
NSCOORD_NONE
)
;
}
}
void
nsViewManager
:
:
PaintWindow
(
nsIWidget
*
aWidget
)
{
RefPtr
ps
=
mPresShell
;
if
(
!
ps
)
{
return
;
}
RefPtr
renderer
=
aWidget
-
>
GetWindowRenderer
(
)
;
if
(
!
renderer
-
>
NeedsWidgetInvalidation
(
)
)
{
renderer
-
>
FlushRendering
(
wr
:
:
RenderReasons
:
:
WIDGET
)
;
}
else
{
ps
-
>
SyncPaintFallback
(
ps
-
>
GetRootFrame
(
)
renderer
)
;
}
mozilla
:
:
StartupTimeline
:
:
RecordOnce
(
mozilla
:
:
StartupTimeline
:
:
FIRST_PAINT
)
;
}
void
nsViewManager
:
:
WillPaintWindow
(
nsIWidget
*
aWidget
)
{
WindowRenderer
*
renderer
=
aWidget
-
>
GetWindowRenderer
(
)
;
if
(
renderer
-
>
NeedsWidgetInvalidation
(
)
)
{
return
;
}
if
(
RefPtr
ps
=
mPresShell
)
{
ps
-
>
PaintSynchronously
(
)
;
}
}
void
nsViewManager
:
:
DidPaintWindow
(
)
{
if
(
RefPtr
<
PresShell
>
presShell
=
mPresShell
)
{
presShell
-
>
DidPaintWindow
(
)
;
}
}
void
nsViewManager
:
:
MaybeUpdateLastUserEventTime
(
WidgetGUIEvent
*
aEvent
)
{
WidgetMouseEvent
*
mouseEvent
=
aEvent
-
>
AsMouseEvent
(
)
;
if
(
(
mouseEvent
&
&
mouseEvent
-
>
mReason
=
=
WidgetMouseEvent
:
:
eReal
&
&
mouseEvent
-
>
mMessage
!
=
eMouseExitFromWidget
&
&
mouseEvent
-
>
mMessage
!
=
eMouseEnterIntoWidget
)
|
|
aEvent
-
>
HasKeyEventMessage
(
)
|
|
aEvent
-
>
HasIMEEventMessage
(
)
)
{
gLastUserEventTime
=
PR_IntervalToMicroseconds
(
PR_IntervalNow
(
)
)
;
}
}
void
nsViewManager
:
:
ResizeView
(
nsView
*
aView
const
nsSize
&
aSize
)
{
NS_ASSERTION
(
aView
-
>
GetViewManager
(
)
=
=
this
"
wrong
view
manager
"
)
;
aView
-
>
SetSize
(
aSize
)
;
}
