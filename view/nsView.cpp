#
include
"
nsView
.
h
"
#
include
"
nsDeviceContext
.
h
"
#
include
"
mozilla
/
BasicEvents
.
h
"
#
include
"
mozilla
/
IntegerPrintfMacros
.
h
"
#
include
"
mozilla
/
Poison
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
StaticPrefs_layout
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
BrowserParent
.
h
"
#
include
"
mozilla
/
widget
/
Screen
.
h
"
#
include
"
nsIWidget
.
h
"
#
include
"
nsViewManager
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsXULPopupManager
.
h
"
#
include
"
nsIWidgetListener
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsDocShell
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
WindowRenderer
.
h
"
#
include
"
mozilla
/
StartupTimeline
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
widget
;
nsView
:
:
nsView
(
nsViewManager
*
aViewManager
)
:
mViewManager
(
aViewManager
)
{
MOZ_COUNT_CTOR
(
nsView
)
;
}
nsView
:
:
~
nsView
(
)
{
MOZ_COUNT_DTOR
(
nsView
)
;
if
(
mViewManager
)
{
nsView
*
rootView
=
mViewManager
-
>
GetRootView
(
)
;
if
(
rootView
=
=
this
)
{
mViewManager
-
>
SetRootView
(
nullptr
)
;
}
mViewManager
=
nullptr
;
}
if
(
mPreviousWindow
)
{
mPreviousWindow
-
>
SetPreviouslyAttachedWidgetListener
(
nullptr
)
;
}
DetachWidget
(
)
;
}
void
nsView
:
:
DetachWidget
(
)
{
if
(
mWindow
)
{
mWindow
-
>
SetAttachedWidgetListener
(
nullptr
)
;
mWindow
=
nullptr
;
}
}
void
nsView
:
:
Destroy
(
)
{
this
-
>
~
nsView
(
)
;
mozWritePoison
(
this
sizeof
(
*
this
)
)
;
nsView
:
:
operator
delete
(
this
)
;
}
void
nsView
:
:
AttachToTopLevelWidget
(
nsIWidget
*
aWidget
)
{
MOZ_ASSERT
(
aWidget
"
null
widget
ptr
"
)
;
#
ifdef
DEBUG
nsIWidgetListener
*
parentListener
=
aWidget
-
>
GetWidgetListener
(
)
;
MOZ_ASSERT
(
!
parentListener
|
|
parentListener
-
>
GetAppWindow
(
)
"
Expect
a
top
level
widget
"
)
;
MOZ_ASSERT
(
!
parentListener
|
|
!
parentListener
-
>
GetAsMenuPopupFrame
(
)
"
Expect
a
top
level
widget
"
)
;
#
endif
if
(
nsIWidgetListener
*
listener
=
aWidget
-
>
GetAttachedWidgetListener
(
)
)
{
if
(
nsView
*
oldView
=
listener
-
>
GetView
(
)
)
{
oldView
-
>
DetachFromTopLevelWidget
(
)
;
}
}
mWindow
=
aWidget
;
mWindow
-
>
SetAttachedWidgetListener
(
this
)
;
if
(
mWindow
-
>
GetWindowType
(
)
!
=
WindowType
:
:
Invisible
)
{
mWindow
-
>
AsyncEnableDragDrop
(
true
)
;
}
}
void
nsView
:
:
DetachFromTopLevelWidget
(
)
{
MOZ_ASSERT
(
mWindow
"
null
mWindow
for
DetachFromTopLevelWidget
!
"
)
;
mWindow
-
>
SetAttachedWidgetListener
(
nullptr
)
;
if
(
nsIWidgetListener
*
listener
=
mWindow
-
>
GetPreviouslyAttachedWidgetListener
(
)
)
{
if
(
nsView
*
view
=
listener
-
>
GetView
(
)
)
{
view
-
>
mPreviousWindow
=
nullptr
;
}
}
mWindow
-
>
SetPreviouslyAttachedWidgetListener
(
this
)
;
mPreviousWindow
=
mWindow
;
mWindow
=
nullptr
;
}
#
ifdef
DEBUG
void
nsView
:
:
List
(
FILE
*
out
int32_t
aIndent
)
const
{
int32_t
i
;
for
(
i
=
aIndent
;
-
-
i
>
=
0
;
)
fputs
(
"
"
out
)
;
fprintf
(
out
"
%
p
"
(
void
*
)
this
)
;
if
(
mWindow
)
{
nsrefcnt
widgetRefCnt
=
mWindow
.
get
(
)
-
>
AddRef
(
)
-
1
;
mWindow
.
get
(
)
-
>
Release
(
)
;
fprintf
(
out
"
(
widget
=
%
p
[
%
"
PRIuPTR
"
]
pos
=
%
s
)
"
(
void
*
)
mWindow
widgetRefCnt
ToString
(
mWindow
-
>
GetBounds
(
)
)
.
c_str
(
)
)
;
}
for
(
i
=
aIndent
;
-
-
i
>
=
0
;
)
fputs
(
"
"
out
)
;
fputs
(
"
>
\
n
"
out
)
;
}
#
endif
PresShell
*
nsView
:
:
GetPresShell
(
)
{
return
GetViewManager
(
)
-
>
GetPresShell
(
)
;
}
bool
nsView
:
:
WindowResized
(
nsIWidget
*
aWidget
int32_t
aWidth
int32_t
aHeight
)
{
RefPtr
<
PresShell
>
ps
=
GetPresShell
(
)
;
if
(
!
ps
)
{
return
false
;
}
nsPresContext
*
pc
=
ps
-
>
GetPresContext
(
)
;
if
(
!
pc
)
{
return
false
;
}
pc
-
>
DeviceContext
(
)
-
>
CheckDPIChange
(
)
;
int32_t
p2a
=
pc
-
>
AppUnitsPerDevPixel
(
)
;
if
(
auto
*
frame
=
ps
-
>
GetRootFrame
(
)
)
{
frame
-
>
InvalidateFrame
(
)
;
}
const
LayoutDeviceIntSize
size
(
aWidth
aHeight
)
;
ps
-
>
SetLayoutViewportSize
(
LayoutDeviceIntSize
:
:
ToAppUnits
(
size
p2a
)
false
)
;
if
(
nsXULPopupManager
*
pm
=
nsXULPopupManager
:
:
GetInstance
(
)
)
{
pm
-
>
AdjustPopupsOnWindowChange
(
ps
)
;
}
return
true
;
}
#
ifdef
MOZ_WIDGET_ANDROID
void
nsView
:
:
DynamicToolbarMaxHeightChanged
(
ScreenIntCoord
aHeight
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
"
Should
be
only
called
for
the
browser
parent
process
"
)
;
MOZ_ASSERT
(
this
=
=
mViewManager
-
>
GetRootView
(
)
"
Should
be
called
for
the
root
view
"
)
;
CallOnAllRemoteChildren
(
[
aHeight
]
(
dom
:
:
BrowserParent
*
aBrowserParent
)
-
>
CallState
{
aBrowserParent
-
>
DynamicToolbarMaxHeightChanged
(
aHeight
)
;
return
CallState
:
:
Continue
;
}
)
;
}
void
nsView
:
:
DynamicToolbarOffsetChanged
(
ScreenIntCoord
aOffset
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
"
Should
be
only
called
for
the
browser
parent
process
"
)
;
MOZ_ASSERT
(
this
=
=
mViewManager
-
>
GetRootView
(
)
"
Should
be
called
for
the
root
view
"
)
;
CallOnAllRemoteChildren
(
[
aOffset
]
(
dom
:
:
BrowserParent
*
aBrowserParent
)
-
>
CallState
{
if
(
!
aBrowserParent
-
>
GetDocShellIsActive
(
)
)
{
return
CallState
:
:
Continue
;
}
aBrowserParent
-
>
DynamicToolbarOffsetChanged
(
aOffset
)
;
return
CallState
:
:
Stop
;
}
)
;
}
void
nsView
:
:
KeyboardHeightChanged
(
ScreenIntCoord
aHeight
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
"
Should
be
only
called
for
the
browser
parent
process
"
)
;
MOZ_ASSERT
(
this
=
=
mViewManager
-
>
GetRootView
(
)
"
Should
be
called
for
the
root
view
"
)
;
CallOnAllRemoteChildren
(
[
aHeight
]
(
dom
:
:
BrowserParent
*
aBrowserParent
)
-
>
CallState
{
if
(
!
aBrowserParent
-
>
GetDocShellIsActive
(
)
)
{
return
CallState
:
:
Continue
;
}
aBrowserParent
-
>
KeyboardHeightChanged
(
aHeight
)
;
return
CallState
:
:
Stop
;
}
)
;
}
void
nsView
:
:
AndroidPipModeChanged
(
bool
aPipMode
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
"
Should
be
only
called
for
the
browser
parent
process
"
)
;
MOZ_ASSERT
(
this
=
=
mViewManager
-
>
GetRootView
(
)
"
Should
be
called
for
the
root
view
"
)
;
CallOnAllRemoteChildren
(
[
aPipMode
]
(
dom
:
:
BrowserParent
*
aBrowserParent
)
-
>
CallState
{
aBrowserParent
-
>
AndroidPipModeChanged
(
aPipMode
)
;
return
CallState
:
:
Continue
;
}
)
;
}
#
endif
void
nsView
:
:
PaintWindow
(
nsIWidget
*
aWidget
)
{
RefPtr
ps
=
GetPresShell
(
)
;
if
(
!
ps
)
{
return
;
}
RefPtr
renderer
=
aWidget
-
>
GetWindowRenderer
(
)
;
if
(
!
renderer
-
>
NeedsWidgetInvalidation
(
)
)
{
ps
-
>
PaintSynchronously
(
)
;
renderer
-
>
FlushRendering
(
wr
:
:
RenderReasons
:
:
WIDGET
)
;
}
else
{
ps
-
>
SyncPaintFallback
(
ps
-
>
GetRootFrame
(
)
renderer
)
;
}
mozilla
:
:
StartupTimeline
:
:
RecordOnce
(
mozilla
:
:
StartupTimeline
:
:
FIRST_PAINT
)
;
ps
-
>
DidPaintWindow
(
)
;
}
void
nsView
:
:
DidCompositeWindow
(
mozilla
:
:
layers
:
:
TransactionId
aTransactionId
const
TimeStamp
&
aCompositeStart
const
TimeStamp
&
aCompositeEnd
)
{
PresShell
*
presShell
=
GetPresShell
(
)
;
if
(
!
presShell
)
{
return
;
}
nsAutoScriptBlocker
scriptBlocker
;
nsPresContext
*
context
=
presShell
-
>
GetPresContext
(
)
;
nsRootPresContext
*
rootContext
=
context
-
>
GetRootPresContext
(
)
;
if
(
rootContext
)
{
rootContext
-
>
NotifyDidPaintForSubtree
(
aTransactionId
aCompositeEnd
)
;
}
mozilla
:
:
StartupTimeline
:
:
RecordOnce
(
mozilla
:
:
StartupTimeline
:
:
FIRST_PAINT2
aCompositeEnd
)
;
}
nsEventStatus
nsView
:
:
HandleEvent
(
WidgetGUIEvent
*
aEvent
)
{
MOZ_ASSERT
(
aEvent
-
>
mWidget
"
null
widget
ptr
"
)
;
nsEventStatus
result
=
nsEventStatus_eIgnore
;
nsViewManager
:
:
MaybeUpdateLastUserEventTime
(
aEvent
)
;
if
(
RefPtr
<
PresShell
>
ps
=
GetPresShell
(
)
)
{
if
(
nsIFrame
*
root
=
ps
-
>
GetRootFrame
(
)
)
{
ps
-
>
HandleEvent
(
root
aEvent
false
&
result
)
;
}
}
return
result
;
}
void
nsView
:
:
SafeAreaInsetsChanged
(
const
LayoutDeviceIntMargin
&
aSafeAreaInsets
)
{
PresShell
*
presShell
=
GetPresShell
(
)
;
if
(
!
presShell
)
{
return
;
}
LayoutDeviceIntMargin
windowSafeAreaInsets
;
const
LayoutDeviceIntRect
windowRect
=
mWindow
-
>
GetScreenBounds
(
)
;
if
(
nsCOMPtr
<
nsIScreen
>
screen
=
mWindow
-
>
GetWidgetScreen
(
)
)
{
windowSafeAreaInsets
=
nsContentUtils
:
:
GetWindowSafeAreaInsets
(
screen
aSafeAreaInsets
windowRect
)
;
}
presShell
-
>
GetPresContext
(
)
-
>
SetSafeAreaInsets
(
windowSafeAreaInsets
)
;
CallOnAllRemoteChildren
(
[
windowSafeAreaInsets
]
(
dom
:
:
BrowserParent
*
aBrowserParent
)
-
>
CallState
{
(
void
)
aBrowserParent
-
>
SendSafeAreaInsetsChanged
(
windowSafeAreaInsets
)
;
return
CallState
:
:
Continue
;
}
)
;
}
bool
nsView
:
:
IsPrimaryFramePaintSuppressed
(
)
const
{
return
StaticPrefs
:
:
layout_show_previous_page
(
)
&
&
mViewManager
-
>
GetPresShell
(
)
&
&
mViewManager
-
>
GetPresShell
(
)
-
>
IsPaintingSuppressed
(
)
;
}
void
nsView
:
:
CallOnAllRemoteChildren
(
const
std
:
:
function
<
CallState
(
dom
:
:
BrowserParent
*
)
>
&
aCallback
)
{
PresShell
*
presShell
=
GetPresShell
(
)
;
if
(
!
presShell
)
{
return
;
}
dom
:
:
Document
*
document
=
presShell
-
>
GetDocument
(
)
;
if
(
!
document
)
{
return
;
}
nsPIDOMWindowOuter
*
window
=
document
-
>
GetWindow
(
)
;
if
(
!
window
)
{
return
;
}
nsContentUtils
:
:
CallOnAllRemoteChildren
(
window
aCallback
)
;
}
