#
ifndef
mozilla_dom_bluetooth_bluedroid_BluetoothMapSmsManager_h
#
define
mozilla_dom_bluetooth_bluedroid_BluetoothMapSmsManager_h
#
include
"
BluetoothCommon
.
h
"
#
include
"
BluetoothMapBMessage
.
h
"
#
include
"
BluetoothMapFolder
.
h
"
#
include
"
BluetoothProfileManagerBase
.
h
"
#
include
"
BluetoothSocketObserver
.
h
"
#
include
"
mozilla
/
ipc
/
SocketBase
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
class
nsIInputStream
;
namespace
mozilla
{
namespace
dom
{
class
Blob
;
class
BlobParent
;
}
}
BEGIN_BLUETOOTH_NAMESPACE
struct
Map
{
enum
AppParametersTagId
{
MaxListCount
=
0x1
StartOffset
=
0x2
FilterMessageType
=
0x3
FilterPeriodBegin
=
0x4
FilterPeriodEnd
=
0x5
FilterReadStatus
=
0x6
FilterRecipient
=
0x7
FilterOriginator
=
0x8
FilterPriority
=
0x9
Attachment
=
0x0A
Transparent
=
0x0B
Retry
=
0x0C
NewMessage
=
0x0D
NotificationStatus
=
0x0E
MASInstanceId
=
0x0F
ParameterMask
=
0x10
FolderListingSize
=
0x11
MessagesListingSize
=
0x12
SubjectLength
=
0x13
Charset
=
0x14
FractionRequest
=
0x15
FractionDeliver
=
0x16
StatusIndicator
=
0x17
StatusValue
=
0x18
MSETime
=
0x19
}
;
}
;
class
BluetoothNamedValue
;
class
BluetoothSocket
;
class
ObexHeaderSet
;
class
BluetoothMapSmsManager
:
public
BluetoothSocketObserver
public
BluetoothProfileManagerBase
{
public
:
BT_DECL_PROFILE_MGR_BASE
BT_DECL_SOCKET_OBSERVER
virtual
void
GetName
(
nsACString
&
aName
)
{
aName
.
AssignLiteral
(
"
MapSms
"
)
;
}
static
const
int
MAX_PACKET_LENGTH
=
0xFFFE
;
static
const
int
MAX_INSTANCE_ID
=
255
;
static
const
int
SDP_MESSAGE_TYPE_EMAIL
=
0x01
;
static
const
int
SDP_MESSAGE_TYPE_SMS_GSM
=
0x02
;
static
const
int
SDP_MESSAGE_TYPE_SMS_CDMA
=
0x04
;
static
const
int
SDP_MESSAGE_TYPE_MMS
=
0x08
;
static
const
int
SDP_SMS_MMS_INSTANCE_ID
=
0
;
static
void
InitMapSmsInterface
(
BluetoothProfileResultHandler
*
aRes
)
;
static
void
DeinitMapSmsInterface
(
BluetoothProfileResultHandler
*
aRes
)
;
static
BluetoothMapSmsManager
*
Get
(
)
;
bool
Listen
(
)
;
bool
ReplyToFolderListing
(
long
aMasId
const
nsAString
&
aFolderlists
)
;
bool
ReplyToMessagesListing
(
BlobParent
*
aActor
long
aMasId
bool
aNewMessage
const
nsAString
&
aTimestamp
int
aSize
)
;
bool
ReplyToMessagesListing
(
Blob
*
aBlob
long
aMasId
bool
aNewMessage
const
nsAString
&
aTimestamp
int
aSize
)
;
bool
ReplyToGetMessage
(
BlobParent
*
aActor
long
aMasId
)
;
bool
ReplyToGetMessage
(
Blob
*
aBlob
long
aMasId
)
;
bool
ReplyToSetMessageStatus
(
long
aMasId
bool
aStatus
)
;
bool
ReplyToSendMessage
(
long
aMasId
const
nsAString
&
aHandleId
bool
aStatus
)
;
bool
ReplyToMessageUpdate
(
long
aMasId
bool
aStatus
)
;
protected
:
virtual
~
BluetoothMapSmsManager
(
)
;
private
:
BluetoothMapSmsManager
(
)
;
bool
Init
(
)
;
void
HandleShutdown
(
)
;
void
ReplyToConnect
(
)
;
void
ReplyToDisconnectOrAbort
(
)
;
bool
ReplyToGetWithHeaderBody
(
UniquePtr
<
uint8_t
[
]
>
aResponse
unsigned
int
aIndex
)
;
void
ReplyToSetPath
(
)
;
void
ReplyToPut
(
)
;
void
SendReply
(
uint8_t
aResponse
)
;
void
HandleNotificationRegistration
(
const
ObexHeaderSet
&
aHeader
)
;
void
HandleSetMessageStatus
(
const
ObexHeaderSet
&
aHeader
)
;
void
HandleSmsMmsFolderListing
(
const
ObexHeaderSet
&
aHeader
)
;
void
HandleSmsMmsMsgListing
(
const
ObexHeaderSet
&
aHeader
)
;
void
HandleSmsMmsGetMessage
(
const
ObexHeaderSet
&
aHeader
)
;
void
HandleSmsMmsPushMessage
(
const
ObexHeaderSet
&
aHeader
)
;
void
AppendBtNamedValueByTagId
(
const
ObexHeaderSet
&
aHeader
InfallibleTArray
<
BluetoothNamedValue
>
&
aValues
const
Map
:
:
AppParametersTagId
aTagId
)
;
void
SendMasObexData
(
uint8_t
*
aData
uint8_t
aOpcode
int
aSize
)
;
void
SendMasObexData
(
UniquePtr
<
uint8_t
[
]
>
aData
uint8_t
aOpcode
int
aSize
)
;
void
SendMnsObexData
(
uint8_t
*
aData
uint8_t
aOpcode
int
aSize
)
;
bool
StatusResponse
(
bool
aStatus
)
;
uint8_t
SetPath
(
uint8_t
flags
const
ObexHeaderSet
&
aHeader
)
;
bool
CompareHeaderTarget
(
const
ObexHeaderSet
&
aHeader
)
;
void
AfterMapSmsConnected
(
)
;
void
AfterMapSmsDisconnected
(
)
;
void
CreateMnsObexConnection
(
)
;
void
DestroyMnsObexConnection
(
)
;
void
SendMnsConnectRequest
(
)
;
void
SendMnsDisconnectRequest
(
)
;
void
MnsDataHandler
(
mozilla
:
:
ipc
:
:
UnixSocketBuffer
*
aMessage
)
;
void
MasDataHandler
(
mozilla
:
:
ipc
:
:
UnixSocketBuffer
*
aMessage
)
;
bool
GetInputStreamFromBlob
(
Blob
*
aBlob
)
;
InfallibleTArray
<
uint32_t
>
PackParameterMask
(
uint8_t
*
aData
int
aSize
)
;
void
BuildDefaultFolderStructure
(
)
;
BluetoothMapFolder
*
mCurrentFolder
;
RefPtr
<
BluetoothMapFolder
>
mRootFolder
;
int
mLastCommand
;
bool
mBodyRequired
;
bool
mFractionDeliverRequired
;
bool
mMasConnected
;
bool
mMnsConnected
;
bool
mNtfRequired
;
BluetoothAddress
mDeviceAddress
;
unsigned
int
mRemoteMaxPacketLength
;
RefPtr
<
BluetoothSocket
>
mMasSocket
;
RefPtr
<
BluetoothSocket
>
mMasServerSocket
;
RefPtr
<
BluetoothSocket
>
mMnsSocket
;
int
mBodySegmentLength
;
nsAutoArrayPtr
<
uint8_t
>
mBodySegment
;
nsCOMPtr
<
nsIInputStream
>
mDataStream
;
}
;
END_BLUETOOTH_NAMESPACE
#
endif
