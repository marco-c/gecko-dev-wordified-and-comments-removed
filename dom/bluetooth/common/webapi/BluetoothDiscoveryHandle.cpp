#
include
"
BluetoothService
.
h
"
#
include
"
mozilla
/
dom
/
BluetoothDeviceEvent
.
h
"
#
include
"
mozilla
/
dom
/
BluetoothDiscoveryHandleBinding
.
h
"
#
include
"
mozilla
/
dom
/
bluetooth
/
BluetoothCommon
.
h
"
#
include
"
mozilla
/
dom
/
bluetooth
/
BluetoothDiscoveryHandle
.
h
"
#
include
"
mozilla
/
dom
/
bluetooth
/
BluetoothLeDeviceEvent
.
h
"
#
include
"
mozilla
/
dom
/
bluetooth
/
BluetoothTypes
.
h
"
#
include
"
nsThreadUtils
.
h
"
USING_BLUETOOTH_NAMESPACE
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED
(
BluetoothDiscoveryHandle
)
NS_INTERFACE_MAP_END_INHERITING
(
DOMEventTargetHelper
)
NS_IMPL_ADDREF_INHERITED
(
BluetoothDiscoveryHandle
DOMEventTargetHelper
)
NS_IMPL_RELEASE_INHERITED
(
BluetoothDiscoveryHandle
DOMEventTargetHelper
)
BluetoothDiscoveryHandle
:
:
BluetoothDiscoveryHandle
(
nsPIDOMWindowInner
*
aWindow
)
:
DOMEventTargetHelper
(
aWindow
)
{
MOZ_ASSERT
(
aWindow
)
;
}
BluetoothDiscoveryHandle
:
:
BluetoothDiscoveryHandle
(
nsPIDOMWindowInner
*
aWindow
const
nsTArray
<
BluetoothUuid
>
&
aServiceUuids
const
BluetoothUuid
&
aLeScanUuid
)
:
DOMEventTargetHelper
(
aWindow
)
mLeScanUuid
(
aLeScanUuid
)
mServiceUuids
(
aServiceUuids
)
{
MOZ_ASSERT
(
aWindow
)
;
}
BluetoothDiscoveryHandle
:
:
~
BluetoothDiscoveryHandle
(
)
{
}
already_AddRefed
<
BluetoothDiscoveryHandle
>
BluetoothDiscoveryHandle
:
:
Create
(
nsPIDOMWindowInner
*
aWindow
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aWindow
)
;
RefPtr
<
BluetoothDiscoveryHandle
>
handle
=
new
BluetoothDiscoveryHandle
(
aWindow
)
;
return
handle
.
forget
(
)
;
}
already_AddRefed
<
BluetoothDiscoveryHandle
>
BluetoothDiscoveryHandle
:
:
Create
(
nsPIDOMWindowInner
*
aWindow
const
nsTArray
<
BluetoothUuid
>
&
aServiceUuids
const
BluetoothUuid
&
aLeScanUuid
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aWindow
)
;
RefPtr
<
BluetoothDiscoveryHandle
>
handle
=
new
BluetoothDiscoveryHandle
(
aWindow
aServiceUuids
aLeScanUuid
)
;
return
handle
.
forget
(
)
;
}
void
BluetoothDiscoveryHandle
:
:
DispatchDeviceEvent
(
BluetoothDevice
*
aDevice
)
{
MOZ_ASSERT
(
aDevice
)
;
BluetoothDeviceEventInit
init
;
init
.
mDevice
=
aDevice
;
RefPtr
<
BluetoothDeviceEvent
>
event
=
BluetoothDeviceEvent
:
:
Constructor
(
this
NS_LITERAL_STRING
(
"
devicefound
"
)
init
)
;
DispatchTrustedEvent
(
event
)
;
}
void
BluetoothDiscoveryHandle
:
:
DispatchLeDeviceEvent
(
BluetoothDevice
*
aLeDevice
int32_t
aRssi
nsTArray
<
uint8_t
>
&
aScanRecord
)
{
MOZ_ASSERT
(
aLeDevice
)
;
nsTArray
<
BluetoothUuid
>
remoteUuids
;
aLeDevice
-
>
GetUuids
(
remoteUuids
)
;
bool
hasUuidsFilter
=
!
mServiceUuids
.
IsEmpty
(
)
;
bool
noAdvertisingUuid
=
remoteUuids
.
IsEmpty
(
)
;
if
(
hasUuidsFilter
&
&
noAdvertisingUuid
)
{
return
;
}
bool
matched
=
false
;
for
(
size_t
index
=
0
;
index
<
remoteUuids
.
Length
(
)
;
+
+
index
)
{
if
(
mServiceUuids
.
Contains
(
remoteUuids
[
index
]
)
)
{
matched
=
true
;
break
;
}
}
if
(
matched
|
|
mServiceUuids
.
IsEmpty
(
)
)
{
RefPtr
<
BluetoothLeDeviceEvent
>
event
=
BluetoothLeDeviceEvent
:
:
Constructor
(
this
NS_LITERAL_STRING
(
"
devicefound
"
)
aLeDevice
aRssi
aScanRecord
)
;
DispatchTrustedEvent
(
event
)
;
}
}
JSObject
*
BluetoothDiscoveryHandle
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
BluetoothDiscoveryHandleBinding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
