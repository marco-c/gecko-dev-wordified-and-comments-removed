#
ifndef
mozilla_dom_WebAuthnTransactionParent_h
#
define
mozilla_dom_WebAuthnTransactionParent_h
#
include
"
mozilla
/
RandomNum
.
h
"
#
include
"
mozilla
/
dom
/
PWebAuthnTransactionParent
.
h
"
#
include
"
mozilla
/
dom
/
WebAuthnPromiseHolder
.
h
"
#
include
"
nsIWebAuthnService
.
h
"
namespace
mozilla
:
:
dom
{
class
WebAuthnRegisterPromiseHolder
;
class
WebAuthnSignPromiseHolder
;
class
WebAuthnTransactionParent
final
:
public
PWebAuthnTransactionParent
{
NS_INLINE_DECL_REFCOUNTING
(
WebAuthnTransactionParent
override
)
;
public
:
WebAuthnTransactionParent
(
)
=
default
;
mozilla
:
:
ipc
:
:
IPCResult
RecvRequestRegister
(
const
WebAuthnMakeCredentialInfo
&
aTransactionInfo
RequestRegisterResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvRequestSign
(
const
WebAuthnGetAssertionInfo
&
aTransactionInfo
RequestSignResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvRequestCancel
(
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvRequestIsUVPAA
(
RequestIsUVPAAResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvDestroyMe
(
)
;
virtual
void
ActorDestroy
(
ActorDestroyReason
aWhy
)
override
;
private
:
~
WebAuthnTransactionParent
(
)
=
default
;
void
CompleteTransaction
(
)
;
void
DisconnectTransaction
(
)
;
nsCOMPtr
<
nsIWebAuthnService
>
mWebAuthnService
;
Maybe
<
uint64_t
>
mTransactionId
;
MozPromiseRequestHolder
<
WebAuthnRegisterPromise
>
mRegisterPromiseRequest
;
MozPromiseRequestHolder
<
WebAuthnSignPromise
>
mSignPromiseRequest
;
static
uint64_t
NextId
(
)
{
static
uint64_t
counter
=
0
;
Maybe
<
uint64_t
>
rand
=
mozilla
:
:
RandomUint64
(
)
;
uint64_t
id
=
rand
.
valueOr
(
+
+
counter
)
&
UINT64_C
(
0x1fffffffffffff
)
;
return
id
?
id
:
1
;
}
}
;
}
#
endif
