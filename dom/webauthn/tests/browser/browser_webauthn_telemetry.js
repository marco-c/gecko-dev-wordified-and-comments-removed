"
use
strict
"
;
ChromeUtils
.
defineESModuleGetters
(
this
{
TelemetryTestUtils
:
"
resource
:
/
/
testing
-
common
/
TelemetryTestUtils
.
sys
.
mjs
"
}
)
;
const
TEST_URL
=
"
https
:
/
/
example
.
com
/
"
;
add_virtual_authenticator
(
)
;
function
getTelemetryForScalar
(
aName
)
{
let
scalars
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
)
;
return
scalars
[
aName
]
|
|
0
;
}
function
cleanupTelemetry
(
)
{
Services
.
telemetry
.
clearScalars
(
)
;
Services
.
telemetry
.
clearEvents
(
)
;
}
function
validateHistogramEntryCount
(
aHistogramName
aExpectedCount
)
{
let
hist
=
Services
.
telemetry
.
getHistogramById
(
aHistogramName
)
;
let
resultIndexes
=
hist
.
snapshot
(
)
;
let
entriesSeen
=
Object
.
values
(
resultIndexes
.
values
)
.
reduce
(
(
a
b
)
=
>
a
+
b
0
)
;
is
(
entriesSeen
aExpectedCount
"
Expecting
"
+
aExpectedCount
+
"
histogram
entries
in
"
+
aHistogramName
)
;
}
add_task
(
async
function
test_setup
(
)
{
cleanupTelemetry
(
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
security
.
webauth
.
webauthn
"
true
]
[
"
security
.
webauth
.
webauthn_enable_softtoken
"
true
]
[
"
security
.
webauth
.
webauthn_enable_usbtoken
"
false
]
[
"
security
.
webauth
.
webauthn_testing_allow_direct_attestation
"
true
]
]
}
)
;
}
)
;
add_task
(
async
function
test
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_URL
)
;
let
{
attObj
rawId
}
=
await
promiseWebAuthnMakeCredential
(
tab
)
;
let
{
authDataObj
}
=
await
webAuthnDecodeCBORAttestation
(
attObj
)
;
await
checkRpIdHash
(
authDataObj
.
rpIdHash
"
example
.
com
"
)
;
let
{
clientDataJSON
authenticatorData
signature
}
=
await
promiseWebAuthnGetAssertion
(
tab
rawId
)
;
JSON
.
parse
(
buffer2string
(
clientDataJSON
)
)
;
let
attestation
=
await
webAuthnDecodeAuthDataArray
(
new
Uint8Array
(
authenticatorData
)
)
;
is
(
"
"
+
(
attestation
.
flags
&
flag_TUP
)
"
"
+
flag_TUP
"
Assertion
'
s
user
presence
byte
set
correctly
"
)
;
let
params
=
await
deriveAppAndChallengeParam
(
"
example
.
com
"
clientDataJSON
attestation
)
;
let
signedData
=
await
assembleSignedData
(
params
.
appParam
params
.
attestation
.
flags
params
.
attestation
.
counter
params
.
challengeParam
)
;
let
valid
=
await
verifySignature
(
authDataObj
.
publicKeyHandle
signedData
signature
)
;
ok
(
valid
"
signature
is
valid
"
)
;
let
webauthn_used
=
getTelemetryForScalar
(
"
security
.
webauthn_used
"
)
;
ok
(
webauthn_used
"
Scalar
keys
are
set
:
"
+
Object
.
keys
(
webauthn_used
)
.
join
(
"
"
)
)
;
is
(
webauthn_used
.
CTAPRegisterFinish
1
"
webauthn_used
CTAPRegisterFinish
scalar
should
be
1
"
)
;
is
(
webauthn_used
.
CTAPSignFinish
1
"
webauthn_used
CTAPSignFinish
scalar
should
be
1
"
)
;
is
(
webauthn_used
.
CTAPSignAbort
undefined
"
webauthn_used
CTAPSignAbort
scalar
must
be
unset
"
)
;
is
(
webauthn_used
.
CTAPRegisterAbort
undefined
"
webauthn_used
CTAPRegisterAbort
scalar
must
be
unset
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
