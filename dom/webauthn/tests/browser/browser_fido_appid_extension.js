"
use
strict
"
;
const
TEST_URL
=
"
https
:
/
/
example
.
com
/
"
;
let
expectNotSupportedError
=
expectError
(
"
NotSupported
"
)
;
let
expectNotAllowedError
=
expectError
(
"
NotAllowed
"
)
;
let
expectSecurityError
=
expectError
(
"
Security
"
)
;
let
gAppId
=
"
https
:
/
/
example
.
com
/
appId
"
;
let
gCrossOriginAppId
=
"
https
:
/
/
example
.
org
/
appId
"
;
let
gAuthenticatorId
=
add_virtual_authenticator
(
)
;
add_task
(
async
function
test_appid
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_URL
)
;
await
promiseWebAuthnMakeCredential
(
tab
"
none
"
"
discouraged
"
{
appid
:
gAppId
}
)
.
then
(
arrivingHereIsBad
)
.
catch
(
expectNotSupportedError
)
;
let
credIdB64
=
await
addCredential
(
gAuthenticatorId
gAppId
)
;
let
credId
=
base64ToBytesUrlSafe
(
credIdB64
)
;
let
crossOriginCredIdB64
=
await
addCredential
(
gAuthenticatorId
gCrossOriginAppId
)
;
let
crossOriginCredId
=
base64ToBytesUrlSafe
(
crossOriginCredIdB64
)
;
await
promiseWebAuthnGetAssertion
(
tab
credId
)
.
then
(
arrivingHereIsBad
)
.
catch
(
expectNotAllowedError
)
;
await
promiseWebAuthnGetAssertion
(
tab
crossOriginCredId
{
appid
:
gCrossOriginAppId
}
)
.
then
(
arrivingHereIsBad
)
.
catch
(
expectSecurityError
)
;
await
promiseWebAuthnGetAssertion
(
tab
credId
{
appid
:
gAppId
+
"
2
"
}
)
.
then
(
arrivingHereIsBad
)
.
catch
(
expectNotAllowedError
)
;
let
rpIdHash
=
await
promiseWebAuthnGetAssertion
(
tab
credId
{
appid
:
gAppId
}
)
.
then
(
(
{
authenticatorData
extensions
}
)
=
>
{
is
(
extensions
.
appid
true
"
appid
extension
was
acted
upon
"
)
;
return
authenticatorData
.
slice
(
0
32
)
;
}
)
.
then
(
rpIdHash
=
>
{
checkRpIdHash
(
rpIdHash
gAppId
)
;
}
)
.
catch
(
arrivingHereIsBad
)
;
removeCredential
(
gAuthenticatorId
credIdB64
)
;
removeCredential
(
gAuthenticatorId
crossOriginCredIdB64
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
function
test_appid_unused
(
)
{
let
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_URL
)
;
let
appid
=
"
https
:
/
/
example
.
com
/
appId
"
;
let
{
attObj
rawId
}
=
await
promiseWebAuthnMakeCredential
(
tab
)
;
let
{
authDataObj
}
=
await
webAuthnDecodeCBORAttestation
(
attObj
)
;
await
checkRpIdHash
(
authDataObj
.
rpIdHash
"
example
.
com
"
)
;
let
{
clientDataJSON
authenticatorData
signature
extensions
}
=
await
promiseWebAuthnGetAssertion
(
tab
rawId
{
appid
}
)
;
ok
(
"
appid
"
in
extensions
appid
should
be
populated
in
the
extensions
data
but
saw
:
+
{
JSON
.
stringify
(
extensions
)
}
)
;
is
(
extensions
.
appid
false
"
appid
extension
should
indicate
it
was
unused
"
)
;
let
attestation
=
await
webAuthnDecodeAuthDataArray
(
new
Uint8Array
(
authenticatorData
)
)
;
is
(
"
"
+
(
attestation
.
flags
&
flag_TUP
)
"
"
+
flag_TUP
"
Assertion
'
s
user
presence
byte
set
correctly
"
)
;
let
params
=
await
deriveAppAndChallengeParam
(
"
example
.
com
"
clientDataJSON
attestation
)
;
let
signedData
=
await
assembleSignedData
(
params
.
appParam
params
.
attestation
.
flags
params
.
attestation
.
counter
params
.
challengeParam
)
;
let
valid
=
await
verifySignature
(
authDataObj
.
publicKeyHandle
signedData
signature
)
;
ok
(
valid
"
signature
is
valid
"
)
;
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
