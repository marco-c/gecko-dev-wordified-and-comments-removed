#
include
"
mozilla
/
dom
/
U2FTokenManager
.
h
"
#
include
"
mozilla
/
dom
/
U2FTokenTransport
.
h
"
#
include
"
mozilla
/
dom
/
U2FHIDTokenManager
.
h
"
#
include
"
mozilla
/
dom
/
U2FSoftTokenManager
.
h
"
#
include
"
mozilla
/
dom
/
PWebAuthnTransactionParent
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
dom
/
WebAuthnUtil
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
hasht
.
h
"
#
include
"
nsICryptoHash
.
h
"
#
include
"
pkix
/
Input
.
h
"
#
include
"
pkixutil
.
h
"
#
define
PREF_U2F_NSSTOKEN_COUNTER
"
security
.
webauth
.
softtoken_counter
"
#
define
PREF_WEBAUTHN_SOFTTOKEN_ENABLED
"
security
.
webauth
.
webauthn_enable_softtoken
"
#
define
PREF_WEBAUTHN_USBTOKEN_ENABLED
"
security
.
webauth
.
webauthn_enable_usbtoken
"
namespace
mozilla
{
namespace
dom
{
class
U2FPrefManager
;
namespace
{
static
mozilla
:
:
LazyLogModule
gU2FTokenManagerLog
(
"
u2fkeymanager
"
)
;
StaticRefPtr
<
U2FTokenManager
>
gU2FTokenManager
;
StaticRefPtr
<
U2FPrefManager
>
gPrefManager
;
}
class
U2FPrefManager
final
:
public
nsIObserver
{
private
:
U2FPrefManager
(
)
:
mPrefMutex
(
"
U2FPrefManager
Mutex
"
)
{
UpdateValues
(
)
;
}
~
U2FPrefManager
(
)
=
default
;
public
:
NS_DECL_ISUPPORTS
static
U2FPrefManager
*
GetOrCreate
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
gPrefManager
)
{
gPrefManager
=
new
U2FPrefManager
(
)
;
Preferences
:
:
AddStrongObserver
(
gPrefManager
PREF_WEBAUTHN_SOFTTOKEN_ENABLED
)
;
Preferences
:
:
AddStrongObserver
(
gPrefManager
PREF_U2F_NSSTOKEN_COUNTER
)
;
Preferences
:
:
AddStrongObserver
(
gPrefManager
PREF_WEBAUTHN_USBTOKEN_ENABLED
)
;
ClearOnShutdown
(
&
gPrefManager
ShutdownPhase
:
:
ShutdownThreads
)
;
}
return
gPrefManager
;
}
static
U2FPrefManager
*
Get
(
)
{
return
gPrefManager
;
}
bool
GetSoftTokenEnabled
(
)
{
MutexAutoLock
lock
(
mPrefMutex
)
;
return
mSoftTokenEnabled
;
}
int
GetSoftTokenCounter
(
)
{
MutexAutoLock
lock
(
mPrefMutex
)
;
return
mSoftTokenCounter
;
}
bool
GetUsbTokenEnabled
(
)
{
MutexAutoLock
lock
(
mPrefMutex
)
;
return
mUsbTokenEnabled
;
}
NS_IMETHODIMP
Observe
(
nsISupports
*
aSubject
const
char
*
aTopic
const
char16_t
*
aData
)
override
{
UpdateValues
(
)
;
return
NS_OK
;
}
private
:
void
UpdateValues
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MutexAutoLock
lock
(
mPrefMutex
)
;
mSoftTokenEnabled
=
Preferences
:
:
GetBool
(
PREF_WEBAUTHN_SOFTTOKEN_ENABLED
)
;
mSoftTokenCounter
=
Preferences
:
:
GetUint
(
PREF_U2F_NSSTOKEN_COUNTER
)
;
mUsbTokenEnabled
=
Preferences
:
:
GetBool
(
PREF_WEBAUTHN_USBTOKEN_ENABLED
)
;
}
Mutex
mPrefMutex
;
bool
mSoftTokenEnabled
;
int
mSoftTokenCounter
;
bool
mUsbTokenEnabled
;
}
;
NS_IMPL_ISUPPORTS
(
U2FPrefManager
nsIObserver
)
;
U2FTokenManager
:
:
U2FTokenManager
(
)
:
mTransactionParent
(
nullptr
)
mLastTransactionId
(
0
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
U2FPrefManager
:
:
GetOrCreate
(
)
;
}
U2FTokenManager
:
:
~
U2FTokenManager
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
void
U2FTokenManager
:
:
Initialize
(
)
{
if
(
!
XRE_IsParentProcess
(
)
)
{
return
;
}
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
!
gU2FTokenManager
)
;
gU2FTokenManager
=
new
U2FTokenManager
(
)
;
ClearOnShutdown
(
&
gU2FTokenManager
)
;
}
U2FTokenManager
*
U2FTokenManager
:
:
Get
(
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
!
NS_IsMainThread
(
)
)
;
return
gU2FTokenManager
;
}
void
U2FTokenManager
:
:
AbortTransaction
(
const
uint64_t
&
aTransactionId
const
nsresult
&
aError
)
{
Unused
<
<
mTransactionParent
-
>
SendAbort
(
aTransactionId
aError
)
;
ClearTransaction
(
)
;
}
void
U2FTokenManager
:
:
MaybeClearTransaction
(
PWebAuthnTransactionParent
*
aParent
)
{
if
(
mTransactionParent
=
=
aParent
)
{
ClearTransaction
(
)
;
}
}
void
U2FTokenManager
:
:
ClearTransaction
(
)
{
mTransactionParent
=
nullptr
;
if
(
mTokenManagerImpl
)
{
mTokenManagerImpl
-
>
Drop
(
)
;
mTokenManagerImpl
=
nullptr
;
}
mRegisterPromise
.
DisconnectIfExists
(
)
;
mSignPromise
.
DisconnectIfExists
(
)
;
mLastTransactionId
=
0
;
}
RefPtr
<
U2FTokenTransport
>
U2FTokenManager
:
:
GetTokenManagerImpl
(
)
{
MOZ_ASSERT
(
U2FPrefManager
:
:
Get
(
)
)
;
if
(
mTokenManagerImpl
)
{
return
mTokenManagerImpl
;
}
auto
pm
=
U2FPrefManager
:
:
Get
(
)
;
if
(
pm
-
>
GetUsbTokenEnabled
(
)
)
{
return
new
U2FHIDTokenManager
(
)
;
}
if
(
pm
-
>
GetSoftTokenEnabled
(
)
)
{
return
new
U2FSoftTokenManager
(
pm
-
>
GetSoftTokenCounter
(
)
)
;
}
return
nullptr
;
}
void
U2FTokenManager
:
:
Register
(
PWebAuthnTransactionParent
*
aTransactionParent
const
uint64_t
&
aTransactionId
const
WebAuthnMakeCredentialInfo
&
aTransactionInfo
)
{
MOZ_LOG
(
gU2FTokenManagerLog
LogLevel
:
:
Debug
(
"
U2FAuthRegister
"
)
)
;
ClearTransaction
(
)
;
mTransactionParent
=
aTransactionParent
;
mTokenManagerImpl
=
GetTokenManagerImpl
(
)
;
if
(
!
mTokenManagerImpl
)
{
AbortTransaction
(
aTransactionId
NS_ERROR_DOM_NOT_ALLOWED_ERR
)
;
return
;
}
if
(
(
aTransactionInfo
.
RpIdHash
(
)
.
Length
(
)
!
=
SHA256_LENGTH
)
|
|
(
aTransactionInfo
.
ClientDataHash
(
)
.
Length
(
)
!
=
SHA256_LENGTH
)
)
{
AbortTransaction
(
aTransactionId
NS_ERROR_DOM_UNKNOWN_ERR
)
;
return
;
}
uint64_t
tid
=
mLastTransactionId
=
aTransactionId
;
mozilla
:
:
TimeStamp
startTime
=
mozilla
:
:
TimeStamp
:
:
Now
(
)
;
mTokenManagerImpl
-
>
Register
(
aTransactionInfo
)
-
>
Then
(
GetCurrentThreadSerialEventTarget
(
)
__func__
[
tid
startTime
]
(
WebAuthnMakeCredentialResult
&
&
aResult
)
{
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
MaybeConfirmRegister
(
tid
aResult
)
;
Telemetry
:
:
ScalarAdd
(
Telemetry
:
:
ScalarID
:
:
SECURITY_WEBAUTHN_USED
NS_LITERAL_STRING
(
"
U2FRegisterFinish
"
)
1
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
WEBAUTHN_CREATE_CREDENTIAL_MS
startTime
)
;
}
[
tid
]
(
nsresult
rv
)
{
MOZ_ASSERT
(
NS_FAILED
(
rv
)
)
;
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
MaybeAbortRegister
(
tid
rv
)
;
Telemetry
:
:
ScalarAdd
(
Telemetry
:
:
ScalarID
:
:
SECURITY_WEBAUTHN_USED
NS_LITERAL_STRING
(
"
U2FRegisterAbort
"
)
1
)
;
}
)
-
>
Track
(
mRegisterPromise
)
;
}
void
U2FTokenManager
:
:
MaybeConfirmRegister
(
const
uint64_t
&
aTransactionId
const
WebAuthnMakeCredentialResult
&
aResult
)
{
MOZ_ASSERT
(
mLastTransactionId
=
=
aTransactionId
)
;
mRegisterPromise
.
Complete
(
)
;
Unused
<
<
mTransactionParent
-
>
SendConfirmRegister
(
aTransactionId
aResult
)
;
ClearTransaction
(
)
;
}
void
U2FTokenManager
:
:
MaybeAbortRegister
(
const
uint64_t
&
aTransactionId
const
nsresult
&
aError
)
{
MOZ_ASSERT
(
mLastTransactionId
=
=
aTransactionId
)
;
mRegisterPromise
.
Complete
(
)
;
AbortTransaction
(
aTransactionId
aError
)
;
}
void
U2FTokenManager
:
:
Sign
(
PWebAuthnTransactionParent
*
aTransactionParent
const
uint64_t
&
aTransactionId
const
WebAuthnGetAssertionInfo
&
aTransactionInfo
)
{
MOZ_LOG
(
gU2FTokenManagerLog
LogLevel
:
:
Debug
(
"
U2FAuthSign
"
)
)
;
ClearTransaction
(
)
;
mTransactionParent
=
aTransactionParent
;
mTokenManagerImpl
=
GetTokenManagerImpl
(
)
;
if
(
!
mTokenManagerImpl
)
{
AbortTransaction
(
aTransactionId
NS_ERROR_DOM_NOT_ALLOWED_ERR
)
;
return
;
}
if
(
(
aTransactionInfo
.
RpIdHash
(
)
.
Length
(
)
!
=
SHA256_LENGTH
)
|
|
(
aTransactionInfo
.
ClientDataHash
(
)
.
Length
(
)
!
=
SHA256_LENGTH
)
)
{
AbortTransaction
(
aTransactionId
NS_ERROR_DOM_UNKNOWN_ERR
)
;
return
;
}
uint64_t
tid
=
mLastTransactionId
=
aTransactionId
;
mozilla
:
:
TimeStamp
startTime
=
mozilla
:
:
TimeStamp
:
:
Now
(
)
;
mTokenManagerImpl
-
>
Sign
(
aTransactionInfo
)
-
>
Then
(
GetCurrentThreadSerialEventTarget
(
)
__func__
[
tid
startTime
]
(
WebAuthnGetAssertionResult
&
&
aResult
)
{
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
MaybeConfirmSign
(
tid
aResult
)
;
Telemetry
:
:
ScalarAdd
(
Telemetry
:
:
ScalarID
:
:
SECURITY_WEBAUTHN_USED
NS_LITERAL_STRING
(
"
U2FSignFinish
"
)
1
)
;
Telemetry
:
:
AccumulateTimeDelta
(
Telemetry
:
:
WEBAUTHN_GET_ASSERTION_MS
startTime
)
;
}
[
tid
]
(
nsresult
rv
)
{
MOZ_ASSERT
(
NS_FAILED
(
rv
)
)
;
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
MaybeAbortSign
(
tid
rv
)
;
Telemetry
:
:
ScalarAdd
(
Telemetry
:
:
ScalarID
:
:
SECURITY_WEBAUTHN_USED
NS_LITERAL_STRING
(
"
U2FSignAbort
"
)
1
)
;
}
)
-
>
Track
(
mSignPromise
)
;
}
void
U2FTokenManager
:
:
MaybeConfirmSign
(
const
uint64_t
&
aTransactionId
const
WebAuthnGetAssertionResult
&
aResult
)
{
MOZ_ASSERT
(
mLastTransactionId
=
=
aTransactionId
)
;
mSignPromise
.
Complete
(
)
;
Unused
<
<
mTransactionParent
-
>
SendConfirmSign
(
aTransactionId
aResult
)
;
ClearTransaction
(
)
;
}
void
U2FTokenManager
:
:
MaybeAbortSign
(
const
uint64_t
&
aTransactionId
const
nsresult
&
aError
)
{
MOZ_ASSERT
(
mLastTransactionId
=
=
aTransactionId
)
;
mSignPromise
.
Complete
(
)
;
AbortTransaction
(
aTransactionId
aError
)
;
}
void
U2FTokenManager
:
:
Cancel
(
PWebAuthnTransactionParent
*
aParent
const
uint64_t
&
aTransactionId
)
{
if
(
mTransactionParent
!
=
aParent
|
|
mLastTransactionId
!
=
aTransactionId
)
{
return
;
}
mTokenManagerImpl
-
>
Cancel
(
)
;
ClearTransaction
(
)
;
}
}
}
