#
ifndef
mozilla_dom_U2FTokenManager_h
#
define
mozilla_dom_U2FTokenManager_h
#
include
"
nsIU2FTokenManager
.
h
"
#
include
"
mozilla
/
dom
/
U2FTokenTransport
.
h
"
#
include
"
mozilla
/
dom
/
PWebAuthnTransaction
.
h
"
namespace
mozilla
{
namespace
dom
{
class
U2FSoftTokenManager
;
class
WebAuthnTransactionParent
;
class
U2FTokenManager
final
:
public
nsIU2FTokenManager
{
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIU2FTOKENMANAGER
static
U2FTokenManager
*
Get
(
)
;
void
Register
(
PWebAuthnTransactionParent
*
aTransactionParent
const
uint64_t
&
aTransactionId
const
WebAuthnMakeCredentialInfo
&
aTransactionInfo
)
;
void
Sign
(
PWebAuthnTransactionParent
*
aTransactionParent
const
uint64_t
&
aTransactionId
const
WebAuthnGetAssertionInfo
&
aTransactionInfo
)
;
void
Cancel
(
PWebAuthnTransactionParent
*
aTransactionParent
const
uint64_t
&
aTransactionId
)
;
void
MaybeClearTransaction
(
PWebAuthnTransactionParent
*
aParent
)
;
static
void
Initialize
(
)
;
private
:
U2FTokenManager
(
)
;
~
U2FTokenManager
(
)
{
}
RefPtr
<
U2FTokenTransport
>
GetTokenManagerImpl
(
)
;
void
AbortTransaction
(
const
uint64_t
&
aTransactionId
const
nsresult
&
aError
)
;
void
ClearTransaction
(
)
;
void
DoRegister
(
const
WebAuthnMakeCredentialInfo
&
aInfo
bool
aForceNoneAttestation
)
;
void
MaybeConfirmRegister
(
const
uint64_t
&
aTransactionId
const
WebAuthnMakeCredentialResult
&
aResult
)
;
void
MaybeAbortRegister
(
const
uint64_t
&
aTransactionId
const
nsresult
&
aError
)
;
void
MaybeConfirmSign
(
const
uint64_t
&
aTransactionId
const
WebAuthnGetAssertionResult
&
aResult
)
;
void
MaybeAbortSign
(
const
uint64_t
&
aTransactionId
const
nsresult
&
aError
)
;
void
RunResumeRegister
(
uint64_t
aTransactionId
bool
aForceNoneAttestation
)
;
void
RunCancel
(
uint64_t
aTransactionId
)
;
template
<
typename
.
.
.
T
>
void
SendPromptNotification
(
const
char16_t
*
aFormat
T
.
.
.
aArgs
)
;
void
RunSendPromptNotification
(
nsString
aJSON
)
;
PWebAuthnTransactionParent
*
mTransactionParent
;
RefPtr
<
U2FTokenTransport
>
mTokenManagerImpl
;
MozPromiseRequestHolder
<
U2FRegisterPromise
>
mRegisterPromise
;
MozPromiseRequestHolder
<
U2FSignPromise
>
mSignPromise
;
uint64_t
mLastTransactionId
;
Maybe
<
WebAuthnMakeCredentialInfo
>
mPendingRegisterInfo
;
}
;
}
}
#
endif
