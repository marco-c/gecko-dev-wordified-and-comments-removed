#
include
"
mozilla
/
dom
/
WebAuthnTransactionParent
.
h
"
#
include
"
mozilla
/
dom
/
U2FTokenManager
.
h
"
#
include
"
mozilla
/
ipc
/
PBackgroundParent
.
h
"
#
include
"
mozilla
/
ipc
/
BackgroundParent
.
h
"
#
ifdef
OS_WIN
#
include
"
WinWebAuthnManager
.
h
"
#
endif
namespace
mozilla
{
namespace
dom
{
mozilla
:
:
ipc
:
:
IPCResult
WebAuthnTransactionParent
:
:
RecvRequestRegister
(
const
uint64_t
&
aTransactionId
const
WebAuthnMakeCredentialInfo
&
aTransactionInfo
)
{
:
:
mozilla
:
:
ipc
:
:
AssertIsOnBackgroundThread
(
)
;
#
ifdef
OS_WIN
if
(
WinWebAuthnManager
:
:
AreWebAuthNApisAvailable
(
)
)
{
WinWebAuthnManager
*
mgr
=
WinWebAuthnManager
:
:
Get
(
)
;
mgr
-
>
Register
(
this
aTransactionId
aTransactionInfo
)
;
}
else
{
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
Register
(
this
aTransactionId
aTransactionInfo
)
;
}
#
else
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
Register
(
this
aTransactionId
aTransactionInfo
)
;
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
WebAuthnTransactionParent
:
:
RecvRequestSign
(
const
uint64_t
&
aTransactionId
const
WebAuthnGetAssertionInfo
&
aTransactionInfo
)
{
:
:
mozilla
:
:
ipc
:
:
AssertIsOnBackgroundThread
(
)
;
#
ifdef
OS_WIN
if
(
WinWebAuthnManager
:
:
AreWebAuthNApisAvailable
(
)
)
{
WinWebAuthnManager
*
mgr
=
WinWebAuthnManager
:
:
Get
(
)
;
mgr
-
>
Sign
(
this
aTransactionId
aTransactionInfo
)
;
}
else
{
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
Sign
(
this
aTransactionId
aTransactionInfo
)
;
}
#
else
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
Sign
(
this
aTransactionId
aTransactionInfo
)
;
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
WebAuthnTransactionParent
:
:
RecvRequestCancel
(
const
uint64_t
&
aTransactionId
)
{
:
:
mozilla
:
:
ipc
:
:
AssertIsOnBackgroundThread
(
)
;
#
ifdef
OS_WIN
if
(
WinWebAuthnManager
:
:
AreWebAuthNApisAvailable
(
)
)
{
WinWebAuthnManager
*
mgr
=
WinWebAuthnManager
:
:
Get
(
)
;
mgr
-
>
Cancel
(
this
aTransactionId
)
;
}
else
{
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
Cancel
(
this
aTransactionId
)
;
}
#
else
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
mgr
-
>
Cancel
(
this
aTransactionId
)
;
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
WebAuthnTransactionParent
:
:
RecvDestroyMe
(
)
{
:
:
mozilla
:
:
ipc
:
:
AssertIsOnBackgroundThread
(
)
;
IProtocol
*
mgr
=
Manager
(
)
;
if
(
!
Send__delete__
(
this
)
)
{
return
IPC_FAIL_NO_REASON
(
mgr
)
;
}
return
IPC_OK
(
)
;
}
void
WebAuthnTransactionParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
:
:
mozilla
:
:
ipc
:
:
AssertIsOnBackgroundThread
(
)
;
#
ifdef
OS_WIN
if
(
WinWebAuthnManager
:
:
AreWebAuthNApisAvailable
(
)
)
{
WinWebAuthnManager
*
mgr
=
WinWebAuthnManager
:
:
Get
(
)
;
if
(
mgr
)
{
mgr
-
>
MaybeClearTransaction
(
this
)
;
}
}
else
{
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
if
(
mgr
)
{
mgr
-
>
MaybeClearTransaction
(
this
)
;
}
}
#
else
U2FTokenManager
*
mgr
=
U2FTokenManager
:
:
Get
(
)
;
if
(
mgr
)
{
mgr
-
>
MaybeClearTransaction
(
this
)
;
}
#
endif
}
}
}
