#
include
"
GeckoProfiler
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
HoldDropJSObjects
.
h
"
#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
Utf8
.
h
"
#
include
"
js
/
OffThreadScriptCompilation
.
h
"
#
include
"
js
/
SourceText
.
h
"
#
include
"
js
/
loader
/
LoadContextBase
.
h
"
#
include
"
js
/
loader
/
ModuleLoadRequest
.
h
"
#
include
"
ScriptLoadContext
.
h
"
#
include
"
ModuleLoadRequest
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsICacheInfoChannel
.
h
"
#
include
"
nsIClassOfService
.
h
"
#
include
"
nsISupportsPriority
.
h
"
namespace
mozilla
{
namespace
dom
{
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
ScriptLoadContext
)
NS_INTERFACE_MAP_END_INHERITING
(
JS
:
:
loader
:
:
LoadContextBase
)
NS_IMPL_CYCLE_COLLECTION_CLASS
(
ScriptLoadContext
)
NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED
(
ScriptLoadContext
JS
:
:
loader
:
:
LoadContextBase
)
if
(
Runnable
*
runnable
=
tmp
-
>
mRunnable
.
exchange
(
nullptr
)
)
{
runnable
-
>
Release
(
)
;
}
tmp
-
>
MaybeUnblockOnload
(
)
;
NS_IMPL_CYCLE_COLLECTION_UNLINK_END
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED
(
ScriptLoadContext
JS
:
:
loader
:
:
LoadContextBase
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE
(
mLoadBlockedDocument
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
NS_IMPL_ADDREF_INHERITED
(
ScriptLoadContext
JS
:
:
loader
:
:
LoadContextBase
)
NS_IMPL_RELEASE_INHERITED
(
ScriptLoadContext
JS
:
:
loader
:
:
LoadContextBase
)
ScriptLoadContext
:
:
ScriptLoadContext
(
)
:
JS
:
:
loader
:
:
LoadContextBase
(
JS
:
:
loader
:
:
ContextKind
:
:
Window
)
mScriptMode
(
ScriptMode
:
:
eBlocking
)
mScriptFromHead
(
false
)
mIsInline
(
true
)
mInDeferList
(
false
)
mInAsyncList
(
false
)
mIsNonAsyncScriptInserted
(
false
)
mIsXSLT
(
false
)
mInCompilingList
(
false
)
mIsTracking
(
false
)
mWasCompiledOMT
(
false
)
mOffThreadToken
(
nullptr
)
mRunnable
(
nullptr
)
mLineNo
(
1
)
mIsPreload
(
false
)
mUnreportedPreloadError
(
NS_OK
)
{
}
ScriptLoadContext
:
:
~
ScriptLoadContext
(
)
{
mRequest
=
nullptr
;
MOZ_ASSERT_IF
(
!
StaticPrefs
:
:
dom_script_loader_external_scripts_speculative_omt_parse_enabled
(
)
!
mOffThreadToken
)
;
MaybeCancelOffThreadScript
(
)
;
MaybeUnblockOnload
(
)
;
}
void
ScriptLoadContext
:
:
BlockOnload
(
Document
*
aDocument
)
{
MOZ_ASSERT
(
!
mLoadBlockedDocument
)
;
aDocument
-
>
BlockOnload
(
)
;
mLoadBlockedDocument
=
aDocument
;
}
void
ScriptLoadContext
:
:
MaybeUnblockOnload
(
)
{
if
(
mLoadBlockedDocument
)
{
mLoadBlockedDocument
-
>
UnblockOnload
(
false
)
;
mLoadBlockedDocument
=
nullptr
;
}
}
void
ScriptLoadContext
:
:
MaybeCancelOffThreadScript
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
mOffThreadToken
)
{
return
;
}
JSContext
*
cx
=
danger
:
:
GetJSContext
(
)
;
if
(
mRequest
-
>
IsModuleRequest
(
)
)
{
JS
:
:
CancelCompileModuleToStencilOffThread
(
cx
mOffThreadToken
)
;
}
else
if
(
mRequest
-
>
IsSource
(
)
)
{
JS
:
:
CancelCompileToStencilOffThread
(
cx
mOffThreadToken
)
;
}
else
{
MOZ_ASSERT
(
mRequest
-
>
IsBytecode
(
)
)
;
JS
:
:
CancelDecodeStencilOffThread
(
cx
mOffThreadToken
)
;
}
if
(
Runnable
*
runnable
=
mRunnable
.
exchange
(
nullptr
)
)
{
runnable
-
>
Release
(
)
;
}
MaybeUnblockOnload
(
)
;
mOffThreadToken
=
nullptr
;
}
void
ScriptLoadContext
:
:
SetScriptMode
(
bool
aDeferAttr
bool
aAsyncAttr
bool
aLinkPreload
)
{
if
(
aLinkPreload
)
{
mScriptMode
=
ScriptMode
:
:
eLinkPreload
;
}
else
if
(
aAsyncAttr
)
{
mScriptMode
=
ScriptMode
:
:
eAsync
;
}
else
if
(
aDeferAttr
|
|
mRequest
-
>
IsModuleRequest
(
)
)
{
mScriptMode
=
ScriptMode
:
:
eDeferred
;
}
else
{
mScriptMode
=
ScriptMode
:
:
eBlocking
;
}
}
void
ScriptLoadContext
:
:
PrioritizeAsPreload
(
nsIChannel
*
aChannel
)
{
if
(
nsCOMPtr
<
nsIClassOfService
>
cos
=
do_QueryInterface
(
aChannel
)
)
{
cos
-
>
AddClassFlags
(
nsIClassOfService
:
:
Unblocked
)
;
}
if
(
nsCOMPtr
<
nsISupportsPriority
>
sp
=
do_QueryInterface
(
aChannel
)
)
{
sp
-
>
AdjustPriority
(
nsISupportsPriority
:
:
PRIORITY_HIGHEST
)
;
}
}
void
ScriptLoadContext
:
:
PrioritizeAsPreload
(
)
{
if
(
!
IsLinkPreloadScript
(
)
)
{
PrioritizeAsPreload
(
Channel
(
)
)
;
}
}
bool
ScriptLoadContext
:
:
IsPreload
(
)
const
{
if
(
mRequest
-
>
IsModuleRequest
(
)
&
&
!
mRequest
-
>
IsTopLevel
(
)
)
{
JS
:
:
loader
:
:
ModuleLoadRequest
*
root
=
mRequest
-
>
AsModuleRequest
(
)
-
>
GetRootModule
(
)
;
return
root
-
>
GetScriptLoadContext
(
)
-
>
IsPreload
(
)
;
}
MOZ_ASSERT_IF
(
mIsPreload
!
GetScriptElement
(
)
)
;
return
mIsPreload
;
}
bool
ScriptLoadContext
:
:
CompileStarted
(
)
const
{
return
mRequest
-
>
IsCompiling
(
)
|
|
(
mRequest
-
>
IsReadyToRun
(
)
&
&
mWasCompiledOMT
)
;
}
nsIScriptElement
*
ScriptLoadContext
:
:
GetScriptElement
(
)
const
{
nsCOMPtr
<
nsIScriptElement
>
scriptElement
=
do_QueryInterface
(
mRequest
-
>
mFetchOptions
-
>
mElement
)
;
return
scriptElement
;
}
void
ScriptLoadContext
:
:
SetIsLoadRequest
(
nsIScriptElement
*
aElement
)
{
MOZ_ASSERT
(
aElement
)
;
MOZ_ASSERT
(
!
GetScriptElement
(
)
)
;
MOZ_ASSERT
(
IsPreload
(
)
)
;
mRequest
-
>
mFetchOptions
-
>
mElement
=
do_QueryInterface
(
aElement
)
;
mIsPreload
=
false
;
}
void
ScriptLoadContext
:
:
GetProfilerLabel
(
nsACString
&
aOutString
)
{
if
(
!
profiler_is_active
(
)
)
{
aOutString
.
Append
(
"
<
script
>
element
"
)
;
return
;
}
aOutString
.
Append
(
"
<
script
"
)
;
if
(
IsAsyncScript
(
)
)
{
aOutString
.
Append
(
"
async
"
)
;
}
else
if
(
IsDeferredScript
(
)
)
{
aOutString
.
Append
(
"
defer
"
)
;
}
if
(
mRequest
-
>
IsModuleRequest
(
)
)
{
aOutString
.
Append
(
"
type
=
\
"
module
\
"
"
)
;
}
nsAutoCString
url
;
if
(
mRequest
-
>
mURI
)
{
mRequest
-
>
mURI
-
>
GetAsciiSpec
(
url
)
;
}
else
{
url
=
"
<
unknown
>
"
;
}
if
(
mIsInline
)
{
if
(
GetParserCreated
(
)
!
=
NOT_FROM_PARSER
)
{
aOutString
.
Append
(
"
>
inline
at
line
"
)
;
aOutString
.
AppendInt
(
mLineNo
)
;
aOutString
.
Append
(
"
of
"
)
;
}
else
{
aOutString
.
Append
(
"
>
inline
(
dynamically
created
)
in
"
)
;
}
aOutString
.
Append
(
url
)
;
}
else
{
aOutString
.
Append
(
"
src
=
\
"
"
)
;
aOutString
.
Append
(
url
)
;
aOutString
.
Append
(
"
\
"
>
"
)
;
}
}
}
}
