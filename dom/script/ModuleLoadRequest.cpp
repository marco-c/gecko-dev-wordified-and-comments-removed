#
include
"
ModuleLoadRequest
.
h
"
#
include
"
ModuleScript
.
h
"
#
include
"
ScriptLoader
.
h
"
namespace
mozilla
{
namespace
dom
{
#
undef
LOG
#
define
LOG
(
args
)
\
MOZ_LOG
(
ScriptLoader
:
:
gScriptLoaderLog
mozilla
:
:
LogLevel
:
:
Debug
args
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
ModuleLoadRequest
)
NS_INTERFACE_MAP_END_INHERITING
(
ScriptLoadRequest
)
NS_IMPL_CYCLE_COLLECTION_INHERITED
(
ModuleLoadRequest
ScriptLoadRequest
mBaseURL
mLoader
mModuleScript
mImports
)
NS_IMPL_ADDREF_INHERITED
(
ModuleLoadRequest
ScriptLoadRequest
)
NS_IMPL_RELEASE_INHERITED
(
ModuleLoadRequest
ScriptLoadRequest
)
ModuleLoadRequest
:
:
ModuleLoadRequest
(
nsIURI
*
aURI
nsIScriptElement
*
aElement
ValidJSVersion
aValidJSVersion
CORSMode
aCORSMode
const
SRIMetadata
&
aIntegrity
ScriptLoader
*
aLoader
)
:
ScriptLoadRequest
(
ScriptKind
:
:
Module
aURI
aElement
aValidJSVersion
aCORSMode
aIntegrity
)
mIsTopLevel
(
true
)
mLoader
(
aLoader
)
mVisitedSet
(
new
VisitedURLSet
(
)
)
{
mVisitedSet
-
>
PutEntry
(
aURI
)
;
}
ModuleLoadRequest
:
:
ModuleLoadRequest
(
nsIURI
*
aURI
ModuleLoadRequest
*
aParent
)
:
ScriptLoadRequest
(
ScriptKind
:
:
Module
aURI
aParent
-
>
mElement
aParent
-
>
mValidJSVersion
aParent
-
>
mCORSMode
aParent
-
>
mIntegrity
)
mIsTopLevel
(
false
)
mLoader
(
aParent
-
>
mLoader
)
mVisitedSet
(
aParent
-
>
mVisitedSet
)
{
MOZ_ASSERT
(
mVisitedSet
-
>
Contains
(
aURI
)
)
;
mTriggeringPrincipal
=
aParent
-
>
mTriggeringPrincipal
;
mIsInline
=
false
;
mReferrerPolicy
=
aParent
-
>
mReferrerPolicy
;
}
void
ModuleLoadRequest
:
:
Cancel
(
)
{
ScriptLoadRequest
:
:
Cancel
(
)
;
mModuleScript
=
nullptr
;
mProgress
=
ScriptLoadRequest
:
:
Progress
:
:
Ready
;
CancelImports
(
)
;
mReady
.
RejectIfExists
(
NS_ERROR_DOM_ABORT_ERR
__func__
)
;
}
void
ModuleLoadRequest
:
:
CancelImports
(
)
{
for
(
size_t
i
=
0
;
i
<
mImports
.
Length
(
)
;
i
+
+
)
{
mImports
[
i
]
-
>
Cancel
(
)
;
}
}
void
ModuleLoadRequest
:
:
SetReady
(
)
{
#
ifdef
DEBUG
for
(
size_t
i
=
0
;
i
<
mImports
.
Length
(
)
;
i
+
+
)
{
MOZ_ASSERT
(
mImports
[
i
]
-
>
IsReadyToRun
(
)
)
;
}
#
endif
ScriptLoadRequest
:
:
SetReady
(
)
;
mReady
.
ResolveIfExists
(
true
__func__
)
;
}
void
ModuleLoadRequest
:
:
ModuleLoaded
(
)
{
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Module
loaded
"
this
)
)
;
mModuleScript
=
mLoader
-
>
GetFetchedModule
(
mURI
)
;
if
(
!
mModuleScript
|
|
mModuleScript
-
>
HasParseError
(
)
)
{
ModuleErrored
(
)
;
return
;
}
mLoader
-
>
StartFetchingModuleDependencies
(
this
)
;
}
void
ModuleLoadRequest
:
:
ModuleErrored
(
)
{
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Module
errored
"
this
)
)
;
mLoader
-
>
CheckModuleDependenciesLoaded
(
this
)
;
MOZ_ASSERT
(
!
mModuleScript
|
|
mModuleScript
-
>
HasParseError
(
)
)
;
CancelImports
(
)
;
SetReady
(
)
;
LoadFinished
(
)
;
}
void
ModuleLoadRequest
:
:
DependenciesLoaded
(
)
{
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Module
dependencies
loaded
"
this
)
)
;
MOZ_ASSERT
(
mModuleScript
)
;
mLoader
-
>
CheckModuleDependenciesLoaded
(
this
)
;
SetReady
(
)
;
LoadFinished
(
)
;
}
void
ModuleLoadRequest
:
:
LoadFailed
(
)
{
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Module
load
failed
"
this
)
)
;
MOZ_ASSERT
(
!
mModuleScript
)
;
Cancel
(
)
;
LoadFinished
(
)
;
}
void
ModuleLoadRequest
:
:
LoadFinished
(
)
{
mLoader
-
>
ProcessLoadedModuleTree
(
this
)
;
mLoader
=
nullptr
;
}
}
}
