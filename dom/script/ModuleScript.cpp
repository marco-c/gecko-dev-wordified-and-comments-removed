#
include
"
ModuleScript
.
h
"
#
include
"
mozilla
/
HoldDropJSObjects
.
h
"
#
include
"
ScriptLoader
.
h
"
namespace
mozilla
{
namespace
dom
{
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
ModuleScript
)
NS_INTERFACE_MAP_END
NS_IMPL_CYCLE_COLLECTION_CLASS
(
ModuleScript
)
NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN
(
ModuleScript
)
NS_IMPL_CYCLE_COLLECTION_UNLINK
(
mLoader
)
NS_IMPL_CYCLE_COLLECTION_UNLINK
(
mBaseURL
)
tmp
-
>
UnlinkModuleRecord
(
)
;
NS_IMPL_CYCLE_COLLECTION_UNLINK_END
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN
(
ModuleScript
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE
(
mLoader
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
NS_IMPL_CYCLE_COLLECTION_TRACE_BEGIN
(
ModuleScript
)
NS_IMPL_CYCLE_COLLECTION_TRACE_JS_MEMBER_CALLBACK
(
mModuleRecord
)
NS_IMPL_CYCLE_COLLECTION_TRACE_JS_MEMBER_CALLBACK
(
mException
)
NS_IMPL_CYCLE_COLLECTION_TRACE_END
NS_IMPL_CYCLE_COLLECTING_ADDREF
(
ModuleScript
)
NS_IMPL_CYCLE_COLLECTING_RELEASE
(
ModuleScript
)
ModuleScript
:
:
ModuleScript
(
ScriptLoader
*
aLoader
nsIURI
*
aBaseURL
JS
:
:
Handle
<
JSObject
*
>
aModuleRecord
)
:
mLoader
(
aLoader
)
mBaseURL
(
aBaseURL
)
mModuleRecord
(
aModuleRecord
)
mInstantiationState
(
Uninstantiated
)
{
MOZ_ASSERT
(
mLoader
)
;
MOZ_ASSERT
(
mBaseURL
)
;
MOZ_ASSERT
(
mModuleRecord
)
;
MOZ_ASSERT
(
mException
.
isUndefined
(
)
)
;
JS
:
:
SetModuleHostDefinedField
(
mModuleRecord
JS
:
:
PrivateValue
(
this
)
)
;
HoldJSObjects
(
this
)
;
}
void
ModuleScript
:
:
UnlinkModuleRecord
(
)
{
if
(
mModuleRecord
)
{
MOZ_ASSERT
(
JS
:
:
GetModuleHostDefinedField
(
mModuleRecord
)
.
toPrivate
(
)
=
=
this
)
;
JS
:
:
SetModuleHostDefinedField
(
mModuleRecord
JS
:
:
UndefinedValue
(
)
)
;
}
mModuleRecord
=
nullptr
;
mException
.
setUndefined
(
)
;
}
ModuleScript
:
:
~
ModuleScript
(
)
{
if
(
mModuleRecord
)
{
UnlinkModuleRecord
(
)
;
}
DropJSObjects
(
this
)
;
}
void
ModuleScript
:
:
SetInstantiationResult
(
JS
:
:
Handle
<
JS
:
:
Value
>
aMaybeException
)
{
MOZ_ASSERT
(
mInstantiationState
=
=
Uninstantiated
)
;
MOZ_ASSERT
(
mModuleRecord
)
;
MOZ_ASSERT
(
mException
.
isUndefined
(
)
)
;
if
(
aMaybeException
.
isUndefined
(
)
)
{
mInstantiationState
=
Instantiated
;
}
else
{
mModuleRecord
=
nullptr
;
mException
=
aMaybeException
;
mInstantiationState
=
Errored
;
}
}
}
}
