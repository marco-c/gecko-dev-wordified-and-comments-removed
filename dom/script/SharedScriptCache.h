#
ifndef
mozilla_dom_SharedScriptCache_h
#
define
mozilla_dom_SharedScriptCache_h
#
include
"
PLDHashTable
.
h
"
#
include
"
js
/
loader
/
LoadedScript
.
h
"
#
include
"
js
/
loader
/
ScriptFetchOptions
.
h
"
#
include
"
js
/
loader
/
ScriptKind
.
h
"
#
include
"
js
/
loader
/
ScriptLoadRequest
.
h
"
#
include
"
mozilla
/
CORSMode
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
SharedSubResourceCache
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
#
include
"
mozilla
/
dom
/
CacheExpirationTime
.
h
"
#
include
"
mozilla
/
dom
/
SRIMetadata
.
h
"
#
include
"
nsIMemoryReporter
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsISupports
.
h
"
#
include
"
nsStringFwd
.
h
"
namespace
mozilla
{
namespace
dom
{
class
ScriptLoader
;
class
ScriptLoadData
;
class
ScriptHashKey
:
public
PLDHashEntryHdr
{
public
:
using
KeyType
=
const
ScriptHashKey
&
;
using
KeyTypePointer
=
const
ScriptHashKey
*
;
explicit
ScriptHashKey
(
const
ScriptHashKey
&
aKey
)
:
PLDHashEntryHdr
(
)
mKind
(
aKey
.
mKind
)
mCORSMode
(
aKey
.
mCORSMode
)
mIsLinkRelPreload
(
aKey
.
mIsLinkRelPreload
)
mURI
(
aKey
.
mURI
)
mLoaderPrincipal
(
aKey
.
mLoaderPrincipal
)
mPartitionPrincipal
(
aKey
.
mPartitionPrincipal
)
mSRIMetadata
(
aKey
.
mSRIMetadata
)
mNonce
(
aKey
.
mNonce
)
mHintCharset
(
aKey
.
mHintCharset
)
{
MOZ_COUNT_CTOR
(
ScriptHashKey
)
;
}
explicit
ScriptHashKey
(
const
ScriptHashKey
*
aKey
)
:
ScriptHashKey
(
*
aKey
)
{
}
ScriptHashKey
(
ScriptHashKey
&
&
aKey
)
:
PLDHashEntryHdr
(
)
mKind
(
std
:
:
move
(
aKey
.
mKind
)
)
mCORSMode
(
std
:
:
move
(
aKey
.
mCORSMode
)
)
mIsLinkRelPreload
(
std
:
:
move
(
aKey
.
mIsLinkRelPreload
)
)
mURI
(
std
:
:
move
(
aKey
.
mURI
)
)
mLoaderPrincipal
(
std
:
:
move
(
aKey
.
mLoaderPrincipal
)
)
mPartitionPrincipal
(
std
:
:
move
(
aKey
.
mPartitionPrincipal
)
)
mSRIMetadata
(
std
:
:
move
(
aKey
.
mSRIMetadata
)
)
mNonce
(
std
:
:
move
(
aKey
.
mNonce
)
)
mHintCharset
(
std
:
:
move
(
aKey
.
mHintCharset
)
)
{
MOZ_COUNT_CTOR
(
ScriptHashKey
)
;
}
ScriptHashKey
(
ScriptLoader
*
aLoader
const
JS
:
:
loader
:
:
ScriptLoadRequest
*
aRequest
const
JS
:
:
loader
:
:
LoadedScript
*
aLoadedScript
)
;
ScriptHashKey
(
ScriptLoader
*
aLoader
const
JS
:
:
loader
:
:
ScriptLoadRequest
*
aRequest
const
JS
:
:
loader
:
:
ScriptFetchOptions
*
aFetchOptions
const
nsCOMPtr
<
nsIURI
>
aURI
)
;
explicit
ScriptHashKey
(
const
ScriptLoadData
&
aLoadData
)
;
MOZ_COUNTED_DTOR
(
ScriptHashKey
)
const
ScriptHashKey
&
GetKey
(
)
const
{
return
*
this
;
}
const
ScriptHashKey
*
GetKeyPointer
(
)
const
{
return
this
;
}
bool
KeyEquals
(
const
ScriptHashKey
*
aKey
)
const
{
return
KeyEquals
(
*
aKey
)
;
}
bool
KeyEquals
(
const
ScriptHashKey
&
)
const
;
static
const
ScriptHashKey
*
KeyToPointer
(
const
ScriptHashKey
&
aKey
)
{
return
&
aKey
;
}
static
PLDHashNumber
HashKey
(
const
ScriptHashKey
*
aKey
)
{
return
nsURIHashKey
:
:
HashKey
(
aKey
-
>
mURI
)
;
}
nsIPrincipal
*
LoaderPrincipal
(
)
const
{
return
mLoaderPrincipal
;
}
nsIPrincipal
*
PartitionPrincipal
(
)
const
{
return
mPartitionPrincipal
;
}
nsIURI
*
URI
(
)
const
{
return
mURI
;
}
enum
{
ALLOW_MEMMOVE
=
true
}
;
protected
:
const
JS
:
:
loader
:
:
ScriptKind
mKind
;
const
CORSMode
mCORSMode
;
const
bool
mIsLinkRelPreload
;
const
nsCOMPtr
<
nsIURI
>
mURI
;
const
nsCOMPtr
<
nsIPrincipal
>
mLoaderPrincipal
;
const
nsCOMPtr
<
nsIPrincipal
>
mPartitionPrincipal
;
const
SRIMetadata
mSRIMetadata
;
const
nsString
mNonce
;
nsString
mHintCharset
;
}
;
class
ScriptLoadData
final
:
public
SupportsWeakPtr
public
nsISupports
public
SharedSubResourceCacheLoadingValueBase
<
ScriptLoadData
>
{
protected
:
~
ScriptLoadData
(
)
{
}
public
:
ScriptLoadData
(
ScriptLoader
*
aLoader
JS
:
:
loader
:
:
ScriptLoadRequest
*
aRequest
JS
:
:
loader
:
:
LoadedScript
*
aLoadedScript
)
;
NS_DECL_ISUPPORTS
bool
IsLoading
(
)
const
override
{
return
false
;
}
bool
IsCancelled
(
)
const
override
{
return
false
;
}
bool
IsSyncLoad
(
)
const
override
{
return
true
;
}
SubResourceNetworkMetadataHolder
*
GetNetworkMetadata
(
)
const
override
{
return
mNetworkMetadata
.
get
(
)
;
}
void
StartLoading
(
)
override
{
}
void
SetLoadCompleted
(
)
override
{
}
void
OnCoalescedTo
(
const
ScriptLoadData
&
aExistingLoad
)
override
{
}
void
Cancel
(
)
override
{
}
void
DidCancelLoad
(
)
{
}
bool
ShouldDefer
(
)
const
{
return
false
;
}
JS
:
:
loader
:
:
LoadedScript
*
ValueForCache
(
)
const
{
return
mLoadedScript
.
get
(
)
;
}
const
CacheExpirationTime
&
ExpirationTime
(
)
const
{
return
mExpirationTime
;
}
ScriptLoader
&
Loader
(
)
{
return
*
mLoader
;
}
const
ScriptHashKey
&
CacheKey
(
)
const
{
return
mKey
;
}
private
:
CacheExpirationTime
mExpirationTime
=
CacheExpirationTime
:
:
Never
(
)
;
ScriptLoader
*
mLoader
;
ScriptHashKey
mKey
;
RefPtr
<
JS
:
:
loader
:
:
LoadedScript
>
mLoadedScript
;
RefPtr
<
SubResourceNetworkMetadataHolder
>
mNetworkMetadata
;
}
;
struct
SharedScriptCacheTraits
{
using
Loader
=
ScriptLoader
;
using
Key
=
ScriptHashKey
;
using
Value
=
JS
:
:
loader
:
:
LoadedScript
;
using
LoadingValue
=
ScriptLoadData
;
static
ScriptHashKey
KeyFromLoadingValue
(
const
LoadingValue
&
aValue
)
{
return
ScriptHashKey
(
aValue
)
;
}
}
;
class
SharedScriptCache
final
:
public
SharedSubResourceCache
<
SharedScriptCacheTraits
SharedScriptCache
>
public
nsIMemoryReporter
{
public
:
using
Base
=
SharedSubResourceCache
<
SharedScriptCacheTraits
SharedScriptCache
>
;
NS_DECL_ISUPPORTS
NS_DECL_NSIMEMORYREPORTER
SharedScriptCache
(
)
;
void
Init
(
)
;
bool
MaybeScheduleUpdateDiskCache
(
)
;
void
UpdateDiskCache
(
)
;
static
void
LoadCompleted
(
SharedScriptCache
*
ScriptLoadData
&
)
;
using
Base
:
:
LoadCompleted
;
static
void
Clear
(
const
Maybe
<
bool
>
&
aChrome
=
Nothing
(
)
const
Maybe
<
nsCOMPtr
<
nsIPrincipal
>
>
&
aPrincipal
=
Nothing
(
)
const
Maybe
<
nsCString
>
&
aSchemelessSite
=
Nothing
(
)
const
Maybe
<
OriginAttributesPattern
>
&
aPattern
=
Nothing
(
)
const
Maybe
<
nsCString
>
&
aURL
=
Nothing
(
)
)
;
static
void
PrepareForLastCC
(
)
;
protected
:
~
SharedScriptCache
(
)
;
}
;
}
}
#
endif
