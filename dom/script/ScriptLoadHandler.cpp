#
include
"
ScriptLoadHandler
.
h
"
#
include
"
ScriptLoader
.
h
"
#
include
"
ScriptTrace
.
h
"
#
include
"
mozilla
/
dom
/
EncodingUtils
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
namespace
mozilla
{
namespace
dom
{
#
undef
LOG
#
define
LOG
(
args
)
\
MOZ_LOG
(
ScriptLoader
:
:
gScriptLoaderLog
mozilla
:
:
LogLevel
:
:
Debug
args
)
#
define
LOG_ENABLED
(
)
\
MOZ_LOG_TEST
(
ScriptLoader
:
:
gScriptLoaderLog
mozilla
:
:
LogLevel
:
:
Debug
)
ScriptLoadHandler
:
:
ScriptLoadHandler
(
ScriptLoader
*
aScriptLoader
ScriptLoadRequest
*
aRequest
SRICheckDataVerifier
*
aSRIDataVerifier
)
:
mScriptLoader
(
aScriptLoader
)
mRequest
(
aRequest
)
mSRIDataVerifier
(
aSRIDataVerifier
)
mSRIStatus
(
NS_OK
)
mDecoder
(
)
{
MOZ_ASSERT
(
mRequest
-
>
IsUnknownDataType
(
)
)
;
MOZ_ASSERT
(
mRequest
-
>
IsLoading
(
)
)
;
}
ScriptLoadHandler
:
:
~
ScriptLoadHandler
(
)
{
}
NS_IMPL_ISUPPORTS
(
ScriptLoadHandler
nsIIncrementalStreamLoaderObserver
)
NS_IMETHODIMP
ScriptLoadHandler
:
:
OnIncrementalData
(
nsIIncrementalStreamLoader
*
aLoader
nsISupports
*
aContext
uint32_t
aDataLength
const
uint8_t
*
aData
uint32_t
*
aConsumedLength
)
{
if
(
mRequest
-
>
IsCanceled
(
)
)
{
*
aConsumedLength
=
aDataLength
;
return
NS_OK
;
}
nsresult
rv
=
NS_OK
;
if
(
mRequest
-
>
IsUnknownDataType
(
)
)
{
rv
=
EnsureKnownDataType
(
aLoader
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
if
(
mRequest
-
>
IsSource
(
)
)
{
if
(
!
EnsureDecoder
(
aLoader
aData
aDataLength
false
)
)
{
return
NS_OK
;
}
*
aConsumedLength
=
aDataLength
;
rv
=
DecodeRawData
(
aData
aDataLength
false
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
mSRIDataVerifier
&
&
NS_SUCCEEDED
(
mSRIStatus
)
)
{
mSRIStatus
=
mSRIDataVerifier
-
>
Update
(
aDataLength
aData
)
;
}
}
else
{
MOZ_ASSERT
(
mRequest
-
>
IsBytecode
(
)
)
;
if
(
!
mRequest
-
>
mScriptBytecode
.
append
(
aData
aDataLength
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
*
aConsumedLength
=
aDataLength
;
rv
=
MaybeDecodeSRI
(
)
;
if
(
NS_FAILED
(
rv
)
)
{
nsCOMPtr
<
nsIRequest
>
channelRequest
;
aLoader
-
>
GetRequest
(
getter_AddRefs
(
channelRequest
)
)
;
return
channelRequest
-
>
Cancel
(
mScriptLoader
-
>
RestartLoad
(
mRequest
)
)
;
}
}
return
rv
;
}
nsresult
ScriptLoadHandler
:
:
DecodeRawData
(
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
)
{
int32_t
srcLen
=
aDataLength
;
const
char
*
src
=
reinterpret_cast
<
const
char
*
>
(
aData
)
;
int32_t
dstLen
;
nsresult
rv
=
mDecoder
-
>
GetMaxLength
(
src
srcLen
&
dstLen
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
uint32_t
haveRead
=
mRequest
-
>
mScriptText
.
length
(
)
;
CheckedInt
<
uint32_t
>
capacity
=
haveRead
;
capacity
+
=
dstLen
;
if
(
!
capacity
.
isValid
(
)
|
|
!
mRequest
-
>
mScriptText
.
reserve
(
capacity
.
value
(
)
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
rv
=
mDecoder
-
>
Convert
(
src
&
srcLen
mRequest
-
>
mScriptText
.
begin
(
)
+
haveRead
&
dstLen
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
haveRead
+
=
dstLen
;
MOZ_ASSERT
(
haveRead
<
=
capacity
.
value
(
)
"
mDecoder
produced
more
data
than
expected
"
)
;
MOZ_ALWAYS_TRUE
(
mRequest
-
>
mScriptText
.
resizeUninitialized
(
haveRead
)
)
;
return
NS_OK
;
}
bool
ScriptLoadHandler
:
:
EnsureDecoder
(
nsIIncrementalStreamLoader
*
aLoader
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
)
{
if
(
mDecoder
)
{
return
true
;
}
nsAutoCString
charset
;
if
(
!
EnsureDecoder
(
aLoader
aData
aDataLength
aEndOfStream
charset
)
)
{
return
false
;
}
if
(
charset
.
Length
(
)
=
=
0
)
{
charset
=
"
?
"
;
}
mozilla
:
:
Telemetry
:
:
Accumulate
(
mozilla
:
:
Telemetry
:
:
DOM_SCRIPT_SRC_ENCODING
charset
)
;
return
true
;
}
bool
ScriptLoadHandler
:
:
EnsureDecoder
(
nsIIncrementalStreamLoader
*
aLoader
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
nsCString
&
oCharset
)
{
if
(
mRequest
-
>
IsModuleRequest
(
)
)
{
oCharset
=
"
UTF
-
8
"
;
mDecoder
=
EncodingUtils
:
:
DecoderForEncoding
(
oCharset
)
;
return
true
;
}
if
(
!
aEndOfStream
&
&
(
aDataLength
<
3
)
)
{
return
false
;
}
if
(
nsContentUtils
:
:
CheckForBOM
(
aData
aDataLength
oCharset
)
)
{
mDecoder
=
EncodingUtils
:
:
DecoderForEncoding
(
oCharset
)
;
return
true
;
}
nsCOMPtr
<
nsIRequest
>
req
;
nsresult
rv
=
aLoader
-
>
GetRequest
(
getter_AddRefs
(
req
)
)
;
NS_ASSERTION
(
req
"
StreamLoader
'
s
request
went
away
prematurely
"
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
nsCOMPtr
<
nsIChannel
>
channel
=
do_QueryInterface
(
req
)
;
if
(
channel
&
&
NS_SUCCEEDED
(
channel
-
>
GetContentCharset
(
oCharset
)
)
&
&
EncodingUtils
:
:
FindEncodingForLabel
(
oCharset
oCharset
)
)
{
mDecoder
=
EncodingUtils
:
:
DecoderForEncoding
(
oCharset
)
;
return
true
;
}
nsAutoString
hintCharset
;
if
(
!
mRequest
-
>
IsPreload
(
)
)
{
mRequest
-
>
mElement
-
>
GetScriptCharset
(
hintCharset
)
;
}
else
{
nsTArray
<
ScriptLoader
:
:
PreloadInfo
>
:
:
index_type
i
=
mScriptLoader
-
>
mPreloads
.
IndexOf
(
mRequest
0
ScriptLoader
:
:
PreloadRequestComparator
(
)
)
;
NS_ASSERTION
(
i
!
=
mScriptLoader
-
>
mPreloads
.
NoIndex
"
Incorrect
preload
bookkeeping
"
)
;
hintCharset
=
mScriptLoader
-
>
mPreloads
[
i
]
.
mCharset
;
}
if
(
EncodingUtils
:
:
FindEncodingForLabel
(
hintCharset
oCharset
)
)
{
mDecoder
=
EncodingUtils
:
:
DecoderForEncoding
(
oCharset
)
;
return
true
;
}
if
(
mScriptLoader
-
>
mDocument
)
{
oCharset
=
mScriptLoader
-
>
mDocument
-
>
GetDocumentCharacterSet
(
)
;
mDecoder
=
EncodingUtils
:
:
DecoderForEncoding
(
oCharset
)
;
return
true
;
}
oCharset
=
"
windows
-
1252
"
;
mDecoder
=
EncodingUtils
:
:
DecoderForEncoding
(
oCharset
)
;
return
true
;
}
nsresult
ScriptLoadHandler
:
:
MaybeDecodeSRI
(
)
{
if
(
!
mSRIDataVerifier
|
|
mSRIDataVerifier
-
>
IsComplete
(
)
|
|
NS_FAILED
(
mSRIStatus
)
)
{
return
NS_OK
;
}
if
(
mRequest
-
>
mScriptBytecode
.
length
(
)
<
=
mSRIDataVerifier
-
>
DataSummaryLength
(
)
)
{
return
NS_OK
;
}
mSRIStatus
=
mSRIDataVerifier
-
>
ImportDataSummary
(
mRequest
-
>
mScriptBytecode
.
length
(
)
mRequest
-
>
mScriptBytecode
.
begin
(
)
)
;
if
(
NS_FAILED
(
mSRIStatus
)
)
{
LOG
(
(
"
ScriptLoadHandler
:
:
MaybeDecodeSRI
failed
to
decode
SRI
restart
request
"
)
)
;
return
mSRIStatus
;
}
mRequest
-
>
mBytecodeOffset
=
mSRIDataVerifier
-
>
DataSummaryLength
(
)
;
return
NS_OK
;
}
nsresult
ScriptLoadHandler
:
:
EnsureKnownDataType
(
nsIIncrementalStreamLoader
*
aLoader
)
{
MOZ_ASSERT
(
mRequest
-
>
IsUnknownDataType
(
)
)
;
MOZ_ASSERT
(
mRequest
-
>
IsLoading
(
)
)
;
if
(
mRequest
-
>
IsLoadingSource
(
)
)
{
mRequest
-
>
mDataType
=
ScriptLoadRequest
:
:
DataType
:
:
Source
;
TRACE_FOR_TEST
(
mRequest
-
>
mElement
"
scriptloader_load_source
"
)
;
return
NS_OK
;
}
nsCOMPtr
<
nsIRequest
>
req
;
nsresult
rv
=
aLoader
-
>
GetRequest
(
getter_AddRefs
(
req
)
)
;
MOZ_ASSERT
(
req
"
StreamLoader
'
s
request
went
away
prematurely
"
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsCOMPtr
<
nsICacheInfoChannel
>
cic
(
do_QueryInterface
(
req
)
)
;
if
(
cic
)
{
nsAutoCString
altDataType
;
cic
-
>
GetAlternativeDataType
(
altDataType
)
;
if
(
altDataType
.
EqualsLiteral
(
"
javascript
/
moz
-
bytecode
-
"
NS_STRINGIFY
(
MOZ_BUILDID
)
)
)
{
mRequest
-
>
mDataType
=
ScriptLoadRequest
:
:
DataType
:
:
Bytecode
;
TRACE_FOR_TEST
(
mRequest
-
>
mElement
"
scriptloader_load_bytecode
"
)
;
}
else
{
mRequest
-
>
mDataType
=
ScriptLoadRequest
:
:
DataType
:
:
Source
;
TRACE_FOR_TEST
(
mRequest
-
>
mElement
"
scriptloader_load_source
"
)
;
}
}
else
{
mRequest
-
>
mDataType
=
ScriptLoadRequest
:
:
DataType
:
:
Source
;
TRACE_FOR_TEST
(
mRequest
-
>
mElement
"
scriptloader_load_source
"
)
;
}
MOZ_ASSERT
(
!
mRequest
-
>
IsUnknownDataType
(
)
)
;
MOZ_ASSERT
(
mRequest
-
>
IsLoading
(
)
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ScriptLoadHandler
:
:
OnStreamComplete
(
nsIIncrementalStreamLoader
*
aLoader
nsISupports
*
aContext
nsresult
aStatus
uint32_t
aDataLength
const
uint8_t
*
aData
)
{
nsresult
rv
=
NS_OK
;
if
(
LOG_ENABLED
(
)
)
{
nsAutoCString
url
;
mRequest
-
>
mURI
-
>
GetAsciiSpec
(
url
)
;
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Stream
complete
(
url
=
%
s
)
"
mRequest
.
get
(
)
url
.
get
(
)
)
)
;
}
nsCOMPtr
<
nsIRequest
>
channelRequest
;
aLoader
-
>
GetRequest
(
getter_AddRefs
(
channelRequest
)
)
;
if
(
!
mRequest
-
>
IsCanceled
(
)
)
{
if
(
mRequest
-
>
IsUnknownDataType
(
)
)
{
rv
=
EnsureKnownDataType
(
aLoader
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
if
(
mRequest
-
>
IsSource
(
)
)
{
DebugOnly
<
bool
>
encoderSet
=
EnsureDecoder
(
aLoader
aData
aDataLength
true
)
;
MOZ_ASSERT
(
encoderSet
)
;
rv
=
DecodeRawData
(
aData
aDataLength
true
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Source
length
=
%
u
"
mRequest
.
get
(
)
unsigned
(
mRequest
-
>
mScriptText
.
length
(
)
)
)
)
;
if
(
mSRIDataVerifier
&
&
NS_SUCCEEDED
(
mSRIStatus
)
)
{
mSRIStatus
=
mSRIDataVerifier
-
>
Update
(
aDataLength
aData
)
;
}
}
else
{
MOZ_ASSERT
(
mRequest
-
>
IsBytecode
(
)
)
;
if
(
!
mRequest
-
>
mScriptBytecode
.
append
(
aData
aDataLength
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Bytecode
length
=
%
u
"
mRequest
.
get
(
)
unsigned
(
mRequest
-
>
mScriptBytecode
.
length
(
)
)
)
)
;
rv
=
MaybeDecodeSRI
(
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
channelRequest
-
>
Cancel
(
mScriptLoader
-
>
RestartLoad
(
mRequest
)
)
;
}
rv
=
SRICheckDataVerifier
:
:
DataSummaryLength
(
mRequest
-
>
mScriptBytecode
.
length
(
)
mRequest
-
>
mScriptBytecode
.
begin
(
)
&
mRequest
-
>
mBytecodeOffset
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
channelRequest
-
>
Cancel
(
mScriptLoader
-
>
RestartLoad
(
mRequest
)
)
;
}
}
}
if
(
NS_SUCCEEDED
(
rv
)
&
&
mRequest
-
>
IsSource
(
)
&
&
nsContentUtils
:
:
IsBytecodeCacheEnabled
(
)
)
{
mRequest
-
>
mCacheInfo
=
do_QueryInterface
(
channelRequest
)
;
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
nsICacheInfoChannel
=
%
p
"
mRequest
.
get
(
)
mRequest
-
>
mCacheInfo
.
get
(
)
)
)
;
}
rv
=
mScriptLoader
-
>
OnStreamComplete
(
aLoader
mRequest
aStatus
mSRIStatus
mSRIDataVerifier
)
;
if
(
NS_FAILED
(
rv
)
)
{
mRequest
-
>
mCacheInfo
=
nullptr
;
}
return
rv
;
}
#
undef
LOG_ENABLED
#
undef
LOG
}
}
