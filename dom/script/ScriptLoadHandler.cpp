#
include
"
ScriptLoadHandler
.
h
"
#
include
"
ScriptLoader
.
h
"
#
include
"
ScriptTrace
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIEncodedChannel
.
h
"
#
include
"
nsIStringEnumerator
.
h
"
#
include
"
nsMimeTypes
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
namespace
mozilla
{
namespace
dom
{
#
undef
LOG
#
define
LOG
(
args
)
\
MOZ_LOG
(
ScriptLoader
:
:
gScriptLoaderLog
mozilla
:
:
LogLevel
:
:
Debug
args
)
#
define
LOG_ENABLED
(
)
\
MOZ_LOG_TEST
(
ScriptLoader
:
:
gScriptLoaderLog
mozilla
:
:
LogLevel
:
:
Debug
)
ScriptLoadHandler
:
:
ScriptLoadHandler
(
ScriptLoader
*
aScriptLoader
ScriptLoadRequest
*
aRequest
SRICheckDataVerifier
*
aSRIDataVerifier
)
:
mScriptLoader
(
aScriptLoader
)
mRequest
(
aRequest
)
mSRIDataVerifier
(
aSRIDataVerifier
)
mSRIStatus
(
NS_OK
)
mDecoder
(
)
{
MOZ_ASSERT
(
mRequest
-
>
IsUnknownDataType
(
)
)
;
MOZ_ASSERT
(
mRequest
-
>
IsLoading
(
)
)
;
}
ScriptLoadHandler
:
:
~
ScriptLoadHandler
(
)
{
}
NS_IMPL_ISUPPORTS
(
ScriptLoadHandler
nsIIncrementalStreamLoaderObserver
)
NS_IMETHODIMP
ScriptLoadHandler
:
:
OnIncrementalData
(
nsIIncrementalStreamLoader
*
aLoader
nsISupports
*
aContext
uint32_t
aDataLength
const
uint8_t
*
aData
uint32_t
*
aConsumedLength
)
{
if
(
mRequest
-
>
IsCanceled
(
)
)
{
*
aConsumedLength
=
aDataLength
;
return
NS_OK
;
}
nsresult
rv
=
NS_OK
;
if
(
mRequest
-
>
IsUnknownDataType
(
)
)
{
rv
=
EnsureKnownDataType
(
aLoader
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
if
(
mRequest
-
>
IsTextSource
(
)
)
{
if
(
!
EnsureDecoder
(
aLoader
aData
aDataLength
false
)
)
{
return
NS_OK
;
}
*
aConsumedLength
=
aDataLength
;
rv
=
DecodeRawData
(
aData
aDataLength
false
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
mSRIDataVerifier
&
&
NS_SUCCEEDED
(
mSRIStatus
)
)
{
mSRIStatus
=
mSRIDataVerifier
-
>
Update
(
aDataLength
aData
)
;
}
}
else
if
(
mRequest
-
>
IsBinASTSource
(
)
)
{
if
(
!
mRequest
-
>
ScriptBinASTData
(
)
.
append
(
aData
aDataLength
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
*
aConsumedLength
=
aDataLength
;
if
(
mSRIDataVerifier
&
&
NS_SUCCEEDED
(
mSRIStatus
)
)
{
mSRIStatus
=
mSRIDataVerifier
-
>
Update
(
aDataLength
aData
)
;
}
}
else
{
MOZ_ASSERT
(
mRequest
-
>
IsBytecode
(
)
)
;
if
(
!
mRequest
-
>
mScriptBytecode
.
append
(
aData
aDataLength
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
*
aConsumedLength
=
aDataLength
;
rv
=
MaybeDecodeSRI
(
)
;
if
(
NS_FAILED
(
rv
)
)
{
nsCOMPtr
<
nsIRequest
>
channelRequest
;
aLoader
-
>
GetRequest
(
getter_AddRefs
(
channelRequest
)
)
;
return
channelRequest
-
>
Cancel
(
mScriptLoader
-
>
RestartLoad
(
mRequest
)
)
;
}
}
return
rv
;
}
nsresult
ScriptLoadHandler
:
:
DecodeRawData
(
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
)
{
CheckedInt
<
size_t
>
needed
=
mDecoder
-
>
MaxUTF16BufferLength
(
aDataLength
)
;
if
(
!
needed
.
isValid
(
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
ScriptLoadRequest
:
:
ScriptTextBuffer
&
scriptText
=
mRequest
-
>
ScriptText
(
)
;
uint32_t
haveRead
=
scriptText
.
length
(
)
;
CheckedInt
<
uint32_t
>
capacity
=
haveRead
;
capacity
+
=
needed
.
value
(
)
;
if
(
!
capacity
.
isValid
(
)
|
|
!
scriptText
.
resize
(
capacity
.
value
(
)
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
uint32_t
result
;
size_t
read
;
size_t
written
;
bool
hadErrors
;
Tie
(
result
read
written
hadErrors
)
=
mDecoder
-
>
DecodeToUTF16
(
MakeSpan
(
aData
aDataLength
)
MakeSpan
(
scriptText
.
begin
(
)
+
haveRead
needed
.
value
(
)
)
aEndOfStream
)
;
MOZ_ASSERT
(
result
=
=
kInputEmpty
)
;
MOZ_ASSERT
(
read
=
=
aDataLength
)
;
MOZ_ASSERT
(
written
<
=
needed
.
value
(
)
)
;
Unused
<
<
hadErrors
;
haveRead
+
=
written
;
MOZ_ASSERT
(
haveRead
<
=
capacity
.
value
(
)
"
mDecoder
produced
more
data
than
expected
"
)
;
MOZ_ALWAYS_TRUE
(
scriptText
.
resize
(
haveRead
)
)
;
mRequest
-
>
mScriptTextLength
=
scriptText
.
length
(
)
;
return
NS_OK
;
}
bool
ScriptLoadHandler
:
:
EnsureDecoder
(
nsIIncrementalStreamLoader
*
aLoader
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
)
{
if
(
mDecoder
)
{
return
true
;
}
nsAutoCString
charset
;
if
(
!
EnsureDecoder
(
aLoader
aData
aDataLength
aEndOfStream
charset
)
)
{
return
false
;
}
return
true
;
}
bool
ScriptLoadHandler
:
:
EnsureDecoder
(
nsIIncrementalStreamLoader
*
aLoader
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
nsCString
&
oCharset
)
{
if
(
mRequest
-
>
IsModuleRequest
(
)
)
{
oCharset
=
"
UTF
-
8
"
;
mDecoder
=
UTF_8_ENCODING
-
>
NewDecoderWithBOMRemoval
(
)
;
return
true
;
}
if
(
!
aEndOfStream
&
&
(
aDataLength
<
3
)
)
{
return
false
;
}
const
Encoding
*
encoding
;
size_t
bomLength
;
Tie
(
encoding
bomLength
)
=
Encoding
:
:
ForBOM
(
MakeSpan
(
aData
aDataLength
)
)
;
if
(
encoding
)
{
mDecoder
=
encoding
-
>
NewDecoderWithBOMRemoval
(
)
;
encoding
-
>
Name
(
oCharset
)
;
return
true
;
}
nsCOMPtr
<
nsIRequest
>
req
;
nsresult
rv
=
aLoader
-
>
GetRequest
(
getter_AddRefs
(
req
)
)
;
NS_ASSERTION
(
req
"
StreamLoader
'
s
request
went
away
prematurely
"
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
nsCOMPtr
<
nsIChannel
>
channel
=
do_QueryInterface
(
req
)
;
if
(
channel
)
{
nsAutoCString
label
;
if
(
NS_SUCCEEDED
(
channel
-
>
GetContentCharset
(
label
)
)
&
&
(
encoding
=
Encoding
:
:
ForLabel
(
label
)
)
)
{
mDecoder
=
encoding
-
>
NewDecoderWithoutBOMHandling
(
)
;
encoding
-
>
Name
(
oCharset
)
;
return
true
;
}
}
nsAutoString
hintCharset
;
if
(
!
mRequest
-
>
IsPreload
(
)
)
{
mRequest
-
>
Element
(
)
-
>
GetScriptCharset
(
hintCharset
)
;
}
else
{
nsTArray
<
ScriptLoader
:
:
PreloadInfo
>
:
:
index_type
i
=
mScriptLoader
-
>
mPreloads
.
IndexOf
(
mRequest
0
ScriptLoader
:
:
PreloadRequestComparator
(
)
)
;
NS_ASSERTION
(
i
!
=
mScriptLoader
-
>
mPreloads
.
NoIndex
"
Incorrect
preload
bookkeeping
"
)
;
hintCharset
=
mScriptLoader
-
>
mPreloads
[
i
]
.
mCharset
;
}
if
(
(
encoding
=
Encoding
:
:
ForLabel
(
hintCharset
)
)
)
{
mDecoder
=
encoding
-
>
NewDecoderWithoutBOMHandling
(
)
;
encoding
-
>
Name
(
oCharset
)
;
return
true
;
}
if
(
mScriptLoader
-
>
mDocument
)
{
encoding
=
mScriptLoader
-
>
mDocument
-
>
GetDocumentCharacterSet
(
)
;
mDecoder
=
encoding
-
>
NewDecoderWithoutBOMHandling
(
)
;
encoding
-
>
Name
(
oCharset
)
;
return
true
;
}
oCharset
=
"
windows
-
1252
"
;
mDecoder
=
WINDOWS_1252_ENCODING
-
>
NewDecoderWithoutBOMHandling
(
)
;
return
true
;
}
nsresult
ScriptLoadHandler
:
:
MaybeDecodeSRI
(
)
{
if
(
!
mSRIDataVerifier
|
|
mSRIDataVerifier
-
>
IsComplete
(
)
|
|
NS_FAILED
(
mSRIStatus
)
)
{
return
NS_OK
;
}
if
(
mRequest
-
>
mScriptBytecode
.
length
(
)
<
=
mSRIDataVerifier
-
>
DataSummaryLength
(
)
)
{
return
NS_OK
;
}
mSRIStatus
=
mSRIDataVerifier
-
>
ImportDataSummary
(
mRequest
-
>
mScriptBytecode
.
length
(
)
mRequest
-
>
mScriptBytecode
.
begin
(
)
)
;
if
(
NS_FAILED
(
mSRIStatus
)
)
{
LOG
(
(
"
ScriptLoadHandler
:
:
MaybeDecodeSRI
failed
to
decode
SRI
restart
"
"
request
"
)
)
;
return
mSRIStatus
;
}
mRequest
-
>
mBytecodeOffset
=
mSRIDataVerifier
-
>
DataSummaryLength
(
)
;
return
NS_OK
;
}
nsresult
ScriptLoadHandler
:
:
EnsureKnownDataType
(
nsIIncrementalStreamLoader
*
aLoader
)
{
MOZ_ASSERT
(
mRequest
-
>
IsUnknownDataType
(
)
)
;
MOZ_ASSERT
(
mRequest
-
>
IsLoading
(
)
)
;
nsCOMPtr
<
nsIRequest
>
req
;
nsresult
rv
=
aLoader
-
>
GetRequest
(
getter_AddRefs
(
req
)
)
;
MOZ_ASSERT
(
req
"
StreamLoader
'
s
request
went
away
prematurely
"
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
mRequest
-
>
IsLoadingSource
(
)
)
{
mRequest
-
>
SetTextSource
(
)
;
TRACE_FOR_TEST
(
mRequest
-
>
Element
(
)
"
scriptloader_load_source
"
)
;
return
NS_OK
;
}
nsCOMPtr
<
nsICacheInfoChannel
>
cic
(
do_QueryInterface
(
req
)
)
;
if
(
cic
)
{
nsAutoCString
altDataType
;
cic
-
>
GetAlternativeDataType
(
altDataType
)
;
if
(
altDataType
.
Equals
(
nsContentUtils
:
:
JSBytecodeMimeType
(
)
)
)
{
mRequest
-
>
SetBytecode
(
)
;
TRACE_FOR_TEST
(
mRequest
-
>
Element
(
)
"
scriptloader_load_bytecode
"
)
;
return
NS_OK
;
}
MOZ_ASSERT
(
altDataType
.
IsEmpty
(
)
)
;
}
if
(
nsJSUtils
:
:
BinASTEncodingEnabled
(
)
)
{
nsCOMPtr
<
nsIHttpChannel
>
httpChannel
=
do_QueryInterface
(
req
)
;
if
(
httpChannel
)
{
nsAutoCString
mimeType
;
httpChannel
-
>
GetContentType
(
mimeType
)
;
if
(
mimeType
.
LowerCaseEqualsASCII
(
APPLICATION_JAVASCRIPT_BINAST
)
)
{
if
(
mRequest
-
>
ShouldAcceptBinASTEncoding
(
)
)
{
mRequest
-
>
SetBinASTSource
(
)
;
TRACE_FOR_TEST
(
mRequest
-
>
Element
(
)
"
scriptloader_load_source
"
)
;
return
NS_OK
;
}
mRequest
-
>
SetTextSource
(
)
;
return
NS_OK
;
}
}
}
mRequest
-
>
SetTextSource
(
)
;
TRACE_FOR_TEST
(
mRequest
-
>
Element
(
)
"
scriptloader_load_source
"
)
;
MOZ_ASSERT
(
!
mRequest
-
>
IsUnknownDataType
(
)
)
;
MOZ_ASSERT
(
mRequest
-
>
IsLoading
(
)
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ScriptLoadHandler
:
:
OnStreamComplete
(
nsIIncrementalStreamLoader
*
aLoader
nsISupports
*
aContext
nsresult
aStatus
uint32_t
aDataLength
const
uint8_t
*
aData
)
{
nsresult
rv
=
NS_OK
;
if
(
LOG_ENABLED
(
)
)
{
nsAutoCString
url
;
mRequest
-
>
mURI
-
>
GetAsciiSpec
(
url
)
;
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Stream
complete
(
url
=
%
s
)
"
mRequest
.
get
(
)
url
.
get
(
)
)
)
;
}
nsCOMPtr
<
nsIRequest
>
channelRequest
;
aLoader
-
>
GetRequest
(
getter_AddRefs
(
channelRequest
)
)
;
if
(
!
mRequest
-
>
IsCanceled
(
)
)
{
if
(
mRequest
-
>
IsUnknownDataType
(
)
)
{
rv
=
EnsureKnownDataType
(
aLoader
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
if
(
mRequest
-
>
IsTextSource
(
)
)
{
DebugOnly
<
bool
>
encoderSet
=
EnsureDecoder
(
aLoader
aData
aDataLength
true
)
;
MOZ_ASSERT
(
encoderSet
)
;
rv
=
DecodeRawData
(
aData
aDataLength
true
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Source
length
=
%
u
"
mRequest
.
get
(
)
unsigned
(
mRequest
-
>
ScriptText
(
)
.
length
(
)
)
)
)
;
if
(
mSRIDataVerifier
&
&
NS_SUCCEEDED
(
mSRIStatus
)
)
{
mSRIStatus
=
mSRIDataVerifier
-
>
Update
(
aDataLength
aData
)
;
}
}
else
if
(
mRequest
-
>
IsBinASTSource
(
)
)
{
if
(
!
mRequest
-
>
ScriptBinASTData
(
)
.
append
(
aData
aDataLength
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
if
(
mSRIDataVerifier
&
&
NS_SUCCEEDED
(
mSRIStatus
)
)
{
mSRIStatus
=
mSRIDataVerifier
-
>
Update
(
aDataLength
aData
)
;
}
}
else
{
MOZ_ASSERT
(
mRequest
-
>
IsBytecode
(
)
)
;
if
(
!
mRequest
-
>
mScriptBytecode
.
append
(
aData
aDataLength
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Bytecode
length
=
%
u
"
mRequest
.
get
(
)
unsigned
(
mRequest
-
>
mScriptBytecode
.
length
(
)
)
)
)
;
rv
=
MaybeDecodeSRI
(
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
channelRequest
-
>
Cancel
(
mScriptLoader
-
>
RestartLoad
(
mRequest
)
)
;
}
rv
=
SRICheckDataVerifier
:
:
DataSummaryLength
(
mRequest
-
>
mScriptBytecode
.
length
(
)
mRequest
-
>
mScriptBytecode
.
begin
(
)
&
mRequest
-
>
mBytecodeOffset
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
channelRequest
-
>
Cancel
(
mScriptLoader
-
>
RestartLoad
(
mRequest
)
)
;
}
}
}
if
(
NS_SUCCEEDED
(
rv
)
&
&
mRequest
-
>
IsSource
(
)
&
&
nsContentUtils
:
:
IsBytecodeCacheEnabled
(
)
)
{
mRequest
-
>
mCacheInfo
=
do_QueryInterface
(
channelRequest
)
;
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
nsICacheInfoChannel
=
%
p
"
mRequest
.
get
(
)
mRequest
-
>
mCacheInfo
.
get
(
)
)
)
;
}
rv
=
mScriptLoader
-
>
OnStreamComplete
(
aLoader
mRequest
aStatus
mSRIStatus
mSRIDataVerifier
)
;
if
(
NS_FAILED
(
rv
)
)
{
mRequest
-
>
mCacheInfo
=
nullptr
;
}
return
rv
;
}
#
undef
LOG_ENABLED
#
undef
LOG
}
}
