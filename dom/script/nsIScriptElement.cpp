#
include
"
nsIScriptElement
.
h
"
#
include
"
js
/
loader
/
ScriptKind
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
ReferrerPolicyBinding
.
h
"
#
include
"
nsIParser
.
h
"
#
include
"
nsIWeakReference
.
h
"
using
JS
:
:
loader
:
:
ScriptKind
;
bool
nsIScriptElement
:
:
IsClassicNonAsyncDefer
(
)
{
return
mKind
=
=
ScriptKind
:
:
eClassic
&
&
!
mAsync
&
&
!
mDefer
;
}
void
nsIScriptElement
:
:
SetCreatorParser
(
nsIParser
*
aParser
)
{
mCreatorParser
=
do_GetWeakReference
(
aParser
)
;
}
void
nsIScriptElement
:
:
UnblockParser
(
)
{
if
(
!
IsClassicNonAsyncDefer
(
)
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Tried
to
unblock
parser
for
a
script
type
that
cannot
block
"
"
the
parser
.
"
)
;
return
;
}
nsCOMPtr
<
nsIParser
>
parser
=
do_QueryReferent
(
mCreatorParser
)
;
if
(
parser
)
{
parser
-
>
UnblockParser
(
)
;
}
}
void
nsIScriptElement
:
:
ContinueParserAsync
(
)
{
if
(
!
IsClassicNonAsyncDefer
(
)
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Tried
to
continue
after
a
script
type
that
cannot
block
the
parser
.
"
)
;
return
;
}
nsCOMPtr
<
nsIParser
>
parser
=
do_QueryReferent
(
mCreatorParser
)
;
if
(
parser
)
{
parser
-
>
ContinueInterruptedParsingAsync
(
)
;
}
}
void
nsIScriptElement
:
:
BeginEvaluating
(
)
{
if
(
!
IsClassicNonAsyncDefer
(
)
)
{
return
;
}
nsCOMPtr
<
nsIParser
>
parser
=
do_QueryReferent
(
mCreatorParser
)
;
if
(
parser
)
{
parser
-
>
IncrementScriptNestingLevel
(
)
;
}
}
void
nsIScriptElement
:
:
EndEvaluating
(
)
{
if
(
!
IsClassicNonAsyncDefer
(
)
)
{
return
;
}
nsCOMPtr
<
nsIParser
>
parser
=
do_QueryReferent
(
mCreatorParser
)
;
if
(
parser
)
{
parser
-
>
DecrementScriptNestingLevel
(
)
;
}
}
already_AddRefed
<
nsIParser
>
nsIScriptElement
:
:
GetCreatorParser
(
)
{
nsCOMPtr
<
nsIParser
>
parser
=
do_QueryReferent
(
mCreatorParser
)
;
return
parser
.
forget
(
)
;
}
bool
nsIScriptElement
:
:
AttemptToExecute
(
nsCOMPtr
<
nsIParser
>
aParser
)
{
mDoneAddingChildren
=
true
;
bool
block
=
MaybeProcessScript
(
aParser
)
;
if
(
!
mAlreadyStarted
)
{
LoseParserInsertedness
(
)
;
}
return
block
;
}
mozilla
:
:
dom
:
:
ReferrerPolicy
nsIScriptElement
:
:
GetReferrerPolicy
(
)
{
return
mozilla
:
:
dom
:
:
ReferrerPolicy
:
:
_empty
;
}
void
nsIScriptElement
:
:
DetermineKindFromType
(
const
mozilla
:
:
dom
:
:
Document
*
aOwnerDoc
)
{
MOZ_ASSERT
(
(
mKind
!
=
ScriptKind
:
:
eModule
)
&
&
(
mKind
!
=
ScriptKind
:
:
eImportMap
)
&
&
!
mAsync
&
&
!
mDefer
&
&
!
mExternal
)
;
nsAutoString
type
;
GetScriptType
(
type
)
;
if
(
!
type
.
IsEmpty
(
)
)
{
if
(
type
.
LowerCaseEqualsASCII
(
"
module
"
)
)
{
mKind
=
ScriptKind
:
:
eModule
;
}
if
(
type
.
LowerCaseEqualsASCII
(
"
importmap
"
)
)
{
mKind
=
ScriptKind
:
:
eImportMap
;
}
}
}
