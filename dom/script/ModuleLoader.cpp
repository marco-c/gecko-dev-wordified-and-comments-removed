#
include
"
ScriptLoader
.
h
"
#
include
"
ModuleLoader
.
h
"
#
include
"
jsapi
.
h
"
#
include
"
js
/
CompileOptions
.
h
"
#
include
"
js
/
ContextOptions
.
h
"
#
include
"
js
/
friend
/
ErrorMessages
.
h
"
#
include
"
js
/
experimental
/
JSStencil
.
h
"
#
include
"
js
/
MemoryFunctions
.
h
"
#
include
"
js
/
Modules
.
h
"
#
include
"
js
/
PropertyAndElement
.
h
"
#
include
"
js
/
Realm
.
h
"
#
include
"
js
/
SourceText
.
h
"
#
include
"
js
/
loader
/
LoadedScript
.
h
"
#
include
"
js
/
loader
/
ScriptLoadRequest
.
h
"
#
include
"
js
/
loader
/
ModuleLoaderBase
.
h
"
#
include
"
js
/
loader
/
ModuleLoadRequest
.
h
"
#
include
"
mozilla
/
dom
/
RequestBinding
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
nsError
.
h
"
#
include
"
xpcpublic
.
h
"
#
include
"
GeckoProfiler
.
h
"
#
include
"
nsContentSecurityManager
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
nsJSUtils
.
h
"
#
include
"
mozilla
/
CycleCollectedJSContext
.
h
"
#
include
"
mozilla
/
dom
/
AutoEntryScript
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
mozilla
/
LoadInfo
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
using
JS
:
:
SourceText
;
using
namespace
JS
:
:
loader
;
namespace
mozilla
:
:
dom
{
#
undef
LOG
#
define
LOG
(
args
)
\
MOZ_LOG
(
ScriptLoader
:
:
gScriptLoaderLog
mozilla
:
:
LogLevel
:
:
Debug
args
)
#
define
LOG_ENABLED
(
)
\
MOZ_LOG_TEST
(
ScriptLoader
:
:
gScriptLoaderLog
mozilla
:
:
LogLevel
:
:
Debug
)
ModuleLoader
:
:
ModuleLoader
(
ScriptLoader
*
aLoader
nsIGlobalObject
*
aGlobalObject
Kind
aKind
)
:
ModuleLoaderBase
(
aLoader
aGlobalObject
)
mKind
(
aKind
)
{
}
ScriptLoader
*
ModuleLoader
:
:
GetScriptLoader
(
)
{
return
static_cast
<
ScriptLoader
*
>
(
mLoader
.
get
(
)
)
;
}
bool
ModuleLoader
:
:
CanStartLoad
(
ModuleLoadRequest
*
aRequest
nsresult
*
aRvOut
)
{
if
(
!
GetScriptLoader
(
)
-
>
GetDocument
(
)
)
{
*
aRvOut
=
NS_ERROR_NULL_POINTER
;
return
false
;
}
if
(
GetScriptLoader
(
)
-
>
GetDocument
(
)
-
>
HasScriptsBlockedBySandbox
(
)
)
{
*
aRvOut
=
NS_OK
;
return
false
;
}
nsCOMPtr
<
nsIPrincipal
>
principal
=
aRequest
-
>
TriggeringPrincipal
(
)
;
if
(
BasePrincipal
:
:
Cast
(
principal
)
-
>
ContentScriptAddonPolicy
(
)
&
&
!
aRequest
-
>
mURI
-
>
SchemeIs
(
"
moz
-
extension
"
)
)
{
*
aRvOut
=
NS_ERROR_DOM_WEBEXT_CONTENT_SCRIPT_URI
;
return
false
;
}
if
(
LOG_ENABLED
(
)
)
{
nsAutoCString
url
;
aRequest
-
>
mURI
-
>
GetAsciiSpec
(
url
)
;
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Start
Module
Load
(
url
=
%
s
)
"
aRequest
url
.
get
(
)
)
)
;
}
return
true
;
}
nsresult
ModuleLoader
:
:
StartFetch
(
ModuleLoadRequest
*
aRequest
)
{
bool
isAboutPageLoadingChromeURI
=
ScriptLoader
:
:
IsAboutPageLoadingChromeURI
(
aRequest
GetScriptLoader
(
)
-
>
GetDocument
(
)
)
;
nsContentSecurityManager
:
:
CORSSecurityMapping
corsMapping
=
isAboutPageLoadingChromeURI
?
nsContentSecurityManager
:
:
CORSSecurityMapping
:
:
DISABLE_CORS_CHECKS
:
nsContentSecurityManager
:
:
CORSSecurityMapping
:
:
REQUIRE_CORS_CHECKS
;
nsSecurityFlags
securityFlags
=
nsContentSecurityManager
:
:
ComputeSecurityFlags
(
aRequest
-
>
CORSMode
(
)
corsMapping
)
;
securityFlags
|
=
nsILoadInfo
:
:
SEC_ALLOW_CHROME
;
nsresult
rv
=
GetScriptLoader
(
)
-
>
StartLoadInternal
(
aRequest
securityFlags
Nothing
(
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
!
aRequest
-
>
GetScriptLoadContext
(
)
-
>
IsPreload
(
)
)
{
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Disallow
further
import
maps
.
"
aRequest
)
)
;
DisallowImportMaps
(
)
;
}
LOG
(
(
"
ScriptLoadRequest
(
%
p
)
:
Start
fetching
module
"
aRequest
)
)
;
return
NS_OK
;
}
void
ModuleLoader
:
:
AsyncExecuteInlineModule
(
ModuleLoadRequest
*
aRequest
)
{
MOZ_ALWAYS_SUCCEEDS
(
NS_DispatchToMainThread
(
mozilla
:
:
NewRunnableMethod
<
RefPtr
<
ModuleLoadRequest
>
>
(
"
ModuleLoader
:
:
ExecuteInlineModule
"
this
&
ModuleLoader
:
:
ExecuteInlineModule
aRequest
)
)
)
;
}
void
ModuleLoader
:
:
ExecuteInlineModule
(
ModuleLoadRequest
*
aRequest
)
{
MOZ_ASSERT
(
aRequest
-
>
IsFinished
(
)
)
;
MOZ_ASSERT
(
aRequest
-
>
IsTopLevel
(
)
)
;
MOZ_ASSERT
(
aRequest
-
>
GetScriptLoadContext
(
)
-
>
mIsInline
)
;
if
(
aRequest
-
>
GetScriptLoadContext
(
)
-
>
GetParserCreated
(
)
=
=
NOT_FROM_PARSER
)
{
GetScriptLoader
(
)
-
>
RunScriptWhenSafe
(
aRequest
)
;
}
else
{
GetScriptLoader
(
)
-
>
MaybeMoveToLoadedList
(
aRequest
)
;
GetScriptLoader
(
)
-
>
ProcessPendingRequests
(
)
;
}
aRequest
-
>
GetScriptLoadContext
(
)
-
>
MaybeUnblockOnload
(
)
;
}
void
ModuleLoader
:
:
OnModuleLoadComplete
(
ModuleLoadRequest
*
aRequest
)
{
MOZ_ASSERT
(
aRequest
-
>
IsFinished
(
)
)
;
if
(
aRequest
-
>
IsTopLevel
(
)
)
{
if
(
aRequest
-
>
GetScriptLoadContext
(
)
-
>
mIsInline
&
&
aRequest
-
>
GetScriptLoadContext
(
)
-
>
GetParserCreated
(
)
=
=
NOT_FROM_PARSER
)
{
if
(
aRequest
-
>
mImports
.
Length
(
)
=
=
0
)
{
GetScriptLoader
(
)
-
>
RunScriptWhenSafe
(
aRequest
)
;
}
else
{
AsyncExecuteInlineModule
(
aRequest
)
;
return
;
}
}
else
if
(
aRequest
-
>
GetScriptLoadContext
(
)
-
>
mIsInline
&
&
aRequest
-
>
GetScriptLoadContext
(
)
-
>
GetParserCreated
(
)
!
=
NOT_FROM_PARSER
&
&
!
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
{
AsyncExecuteInlineModule
(
aRequest
)
;
return
;
}
else
{
GetScriptLoader
(
)
-
>
MaybeMoveToLoadedList
(
aRequest
)
;
GetScriptLoader
(
)
-
>
ProcessPendingRequestsAsync
(
)
;
}
}
aRequest
-
>
GetScriptLoadContext
(
)
-
>
MaybeUnblockOnload
(
)
;
}
nsresult
ModuleLoader
:
:
CompileFetchedModule
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGlobal
JS
:
:
CompileOptions
&
aOptions
ModuleLoadRequest
*
aRequest
JS
:
:
MutableHandle
<
JSObject
*
>
aModuleOut
)
{
if
(
aRequest
-
>
IsTextSource
(
)
)
{
ScriptLoader
:
:
CalculateBytecodeCacheFlag
(
aRequest
)
;
}
if
(
!
nsJSUtils
:
:
IsScriptable
(
aGlobal
)
)
{
return
NS_ERROR_FAILURE
;
}
switch
(
aRequest
-
>
mModuleType
)
{
case
JS
:
:
ModuleType
:
:
Unknown
:
MOZ_CRASH
(
"
Unexpected
module
type
"
)
;
case
JS
:
:
ModuleType
:
:
JavaScript
:
return
CompileJavaScriptModule
(
aCx
aOptions
aRequest
aModuleOut
)
;
case
JS
:
:
ModuleType
:
:
JSON
:
{
return
CompileJsonModule
(
aCx
aOptions
aRequest
aModuleOut
)
;
}
}
MOZ_CRASH
(
"
Unhandled
module
type
"
)
;
}
nsresult
ModuleLoader
:
:
CompileJavaScriptModule
(
JSContext
*
aCx
JS
:
:
CompileOptions
&
aOptions
ModuleLoadRequest
*
aRequest
JS
:
:
MutableHandle
<
JSObject
*
>
aModuleOut
)
{
if
(
aRequest
-
>
GetScriptLoadContext
(
)
-
>
mWasCompiledOMT
)
{
JS
:
:
InstantiationStorage
storage
;
RefPtr
<
JS
:
:
Stencil
>
stencil
=
aRequest
-
>
GetScriptLoadContext
(
)
-
>
StealOffThreadResult
(
aCx
&
storage
)
;
if
(
!
stencil
)
{
return
NS_ERROR_FAILURE
;
}
JS
:
:
InstantiateOptions
instantiateOptions
(
aOptions
)
;
aModuleOut
.
set
(
JS
:
:
InstantiateModuleStencil
(
aCx
instantiateOptions
stencil
&
storage
)
)
;
if
(
!
aModuleOut
)
{
return
NS_ERROR_FAILURE
;
}
if
(
aRequest
-
>
IsTextSource
(
)
&
&
aRequest
-
>
PassedConditionForBytecodeEncoding
(
)
)
{
bool
alreadyStarted
;
if
(
!
JS
:
:
StartIncrementalEncoding
(
aCx
std
:
:
move
(
stencil
)
alreadyStarted
)
)
{
return
NS_ERROR_FAILURE
;
}
MOZ_ASSERT
(
!
alreadyStarted
)
;
}
return
NS_OK
;
}
RefPtr
<
JS
:
:
Stencil
>
stencil
;
if
(
aRequest
-
>
IsTextSource
(
)
)
{
MaybeSourceText
maybeSource
;
nsresult
rv
=
aRequest
-
>
GetScriptSource
(
aCx
&
maybeSource
aRequest
-
>
mLoadContext
.
get
(
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
auto
compile
=
[
&
]
(
auto
&
source
)
{
return
JS
:
:
CompileModuleScriptToStencil
(
aCx
aOptions
source
)
;
}
;
stencil
=
maybeSource
.
mapNonEmpty
(
compile
)
;
}
else
{
MOZ_ASSERT
(
aRequest
-
>
IsBytecode
(
)
)
;
JS
:
:
DecodeOptions
decodeOptions
(
aOptions
)
;
decodeOptions
.
borrowBuffer
=
true
;
JS
:
:
TranscodeRange
range
=
aRequest
-
>
Bytecode
(
)
;
JS
:
:
TranscodeResult
tr
=
JS
:
:
DecodeStencil
(
aCx
decodeOptions
range
getter_AddRefs
(
stencil
)
)
;
if
(
tr
!
=
JS
:
:
TranscodeResult
:
:
Ok
)
{
return
NS_ERROR_DOM_JS_DECODING_ERROR
;
}
}
if
(
!
stencil
)
{
return
NS_ERROR_FAILURE
;
}
JS
:
:
InstantiateOptions
instantiateOptions
(
aOptions
)
;
aModuleOut
.
set
(
JS
:
:
InstantiateModuleStencil
(
aCx
instantiateOptions
stencil
)
)
;
if
(
!
aModuleOut
)
{
return
NS_ERROR_FAILURE
;
}
if
(
aRequest
-
>
IsTextSource
(
)
&
&
aRequest
-
>
PassedConditionForBytecodeEncoding
(
)
)
{
bool
alreadyStarted
;
if
(
!
JS
:
:
StartIncrementalEncoding
(
aCx
std
:
:
move
(
stencil
)
alreadyStarted
)
)
{
return
NS_ERROR_FAILURE
;
}
MOZ_ASSERT
(
!
alreadyStarted
)
;
}
return
NS_OK
;
}
nsresult
ModuleLoader
:
:
CompileJsonModule
(
JSContext
*
aCx
JS
:
:
CompileOptions
&
aOptions
ModuleLoadRequest
*
aRequest
JS
:
:
MutableHandle
<
JSObject
*
>
aModuleOut
)
{
MOZ_ASSERT
(
!
aRequest
-
>
GetScriptLoadContext
(
)
-
>
mWasCompiledOMT
)
;
MOZ_ASSERT
(
aRequest
-
>
IsTextSource
(
)
)
;
ModuleLoader
:
:
MaybeSourceText
maybeSource
;
nsresult
rv
=
aRequest
-
>
GetScriptSource
(
aCx
&
maybeSource
aRequest
-
>
mLoadContext
.
get
(
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
auto
compile
=
[
&
]
(
auto
&
source
)
{
return
JS
:
:
CompileJsonModule
(
aCx
aOptions
source
)
;
}
;
auto
*
jsonModule
=
maybeSource
.
mapNonEmpty
(
compile
)
;
if
(
!
jsonModule
)
{
return
NS_ERROR_FAILURE
;
}
aModuleOut
.
set
(
jsonModule
)
;
return
NS_OK
;
}
already_AddRefed
<
ModuleLoadRequest
>
ModuleLoader
:
:
CreateTopLevel
(
nsIURI
*
aURI
ReferrerPolicy
aReferrerPolicy
ScriptFetchOptions
*
aFetchOptions
const
SRIMetadata
&
aIntegrity
nsIURI
*
aReferrer
ScriptLoader
*
aLoader
ScriptLoadContext
*
aContext
)
{
RefPtr
<
VisitedURLSet
>
visitedSet
=
ModuleLoadRequest
:
:
NewVisitedSetForTopLevelImport
(
aURI
JS
:
:
ModuleType
:
:
JavaScript
)
;
RefPtr
<
ModuleLoadRequest
>
request
=
new
ModuleLoadRequest
(
aURI
JS
:
:
ModuleType
:
:
JavaScript
aReferrerPolicy
aFetchOptions
aIntegrity
aReferrer
aContext
true
false
aLoader
-
>
GetModuleLoader
(
)
visitedSet
nullptr
)
;
request
-
>
NoCacheEntryFound
(
)
;
return
request
.
forget
(
)
;
}
already_AddRefed
<
ModuleLoadRequest
>
ModuleLoader
:
:
CreateStaticImport
(
nsIURI
*
aURI
JS
:
:
ModuleType
aModuleType
ModuleLoadRequest
*
aParent
)
{
RefPtr
<
ScriptLoadContext
>
newContext
=
new
ScriptLoadContext
(
)
;
newContext
-
>
mIsInline
=
false
;
newContext
-
>
mScriptMode
=
aParent
-
>
GetScriptLoadContext
(
)
-
>
mScriptMode
;
RefPtr
<
ModuleLoadRequest
>
request
=
new
ModuleLoadRequest
(
aURI
aModuleType
aParent
-
>
ReferrerPolicy
(
)
aParent
-
>
mFetchOptions
SRIMetadata
(
)
aParent
-
>
mURI
newContext
false
false
aParent
-
>
mLoader
aParent
-
>
mVisitedSet
aParent
-
>
GetRootModule
(
)
)
;
request
-
>
NoCacheEntryFound
(
)
;
return
request
.
forget
(
)
;
}
already_AddRefed
<
ModuleLoadRequest
>
ModuleLoader
:
:
CreateDynamicImport
(
JSContext
*
aCx
nsIURI
*
aURI
JS
:
:
ModuleType
aModuleType
LoadedScript
*
aMaybeActiveScript
JS
:
:
Handle
<
JSString
*
>
aSpecifier
JS
:
:
Handle
<
JSObject
*
>
aPromise
)
{
MOZ_ASSERT
(
aSpecifier
)
;
MOZ_ASSERT
(
aPromise
)
;
RefPtr
<
ScriptFetchOptions
>
options
=
nullptr
;
nsIURI
*
baseURL
=
nullptr
;
RefPtr
<
ScriptLoadContext
>
context
=
new
ScriptLoadContext
(
)
;
ReferrerPolicy
referrerPolicy
;
if
(
aMaybeActiveScript
)
{
options
=
aMaybeActiveScript
-
>
GetFetchOptions
(
)
;
referrerPolicy
=
aMaybeActiveScript
-
>
ReferrerPolicy
(
)
;
baseURL
=
aMaybeActiveScript
-
>
BaseURL
(
)
;
}
else
{
Document
*
document
=
GetScriptLoader
(
)
-
>
GetDocument
(
)
;
nsCOMPtr
<
nsIPrincipal
>
principal
=
GetGlobalObject
(
)
-
>
PrincipalOrNull
(
)
;
MOZ_ASSERT_IF
(
GetKind
(
)
=
=
WebExtension
BasePrincipal
:
:
Cast
(
principal
)
-
>
ContentScriptAddonPolicy
(
)
)
;
MOZ_ASSERT_IF
(
GetKind
(
)
=
=
Normal
principal
=
=
document
-
>
NodePrincipal
(
)
)
;
options
=
new
ScriptFetchOptions
(
mozilla
:
:
CORS_NONE
u
"
"
_ns
RequestPriority
:
:
Auto
ParserMetadata
:
:
NotParserInserted
principal
)
;
referrerPolicy
=
document
-
>
GetReferrerPolicy
(
)
;
baseURL
=
document
-
>
GetDocBaseURI
(
)
;
}
context
-
>
mIsInline
=
false
;
context
-
>
mScriptMode
=
ScriptLoadContext
:
:
ScriptMode
:
:
eAsync
;
RefPtr
<
VisitedURLSet
>
visitedSet
=
ModuleLoadRequest
:
:
NewVisitedSetForTopLevelImport
(
aURI
aModuleType
)
;
RefPtr
<
ModuleLoadRequest
>
request
=
new
ModuleLoadRequest
(
aURI
aModuleType
referrerPolicy
options
SRIMetadata
(
)
baseURL
context
true
true
this
visitedSet
nullptr
)
;
request
-
>
SetDynamicImport
(
aMaybeActiveScript
aSpecifier
aPromise
)
;
request
-
>
NoCacheEntryFound
(
)
;
return
request
.
forget
(
)
;
}
ModuleLoader
:
:
~
ModuleLoader
(
)
{
LOG
(
(
"
ModuleLoader
:
:
~
ModuleLoader
%
p
"
this
)
)
;
mLoader
=
nullptr
;
}
#
undef
LOG
#
undef
LOG_ENABLED
}
