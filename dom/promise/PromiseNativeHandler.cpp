#
include
"
PromiseNativeHandler
.
h
"
#
include
"
mozilla
/
dom
/
Promise
.
h
"
#
include
"
nsISupportsImpl
.
h
"
namespace
mozilla
{
namespace
dom
{
NS_IMPL_ISUPPORTS0
(
DomPromiseListener
)
DomPromiseListener
:
:
DomPromiseListener
(
dom
:
:
Promise
*
aDOMPromise
)
{
aDOMPromise
-
>
AppendNativeHandler
(
this
)
;
}
DomPromiseListener
:
:
DomPromiseListener
(
dom
:
:
Promise
*
aDOMPromise
CallbackTypeResolved
&
&
aResolve
CallbackTypeRejected
&
&
aReject
)
:
mResolve
(
Some
(
std
:
:
move
(
aResolve
)
)
)
mReject
(
Some
(
std
:
:
move
(
aReject
)
)
)
{
aDOMPromise
-
>
AppendNativeHandler
(
this
)
;
}
DomPromiseListener
:
:
~
DomPromiseListener
(
)
{
if
(
mReject
)
{
(
*
mReject
)
(
NS_BINDING_ABORTED
)
;
}
}
void
DomPromiseListener
:
:
ResolvedCallback
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aValue
)
{
if
(
mResolve
)
{
(
*
mResolve
)
(
aCx
aValue
)
;
}
mResolve
.
reset
(
)
;
mReject
.
reset
(
)
;
}
void
DomPromiseListener
:
:
RejectedCallback
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aValue
)
{
if
(
mReject
)
{
nsresult
errorCode
;
if
(
!
aValue
.
isInt32
(
)
)
{
errorCode
=
NS_ERROR_DOM_NOT_NUMBER_ERR
;
}
else
{
errorCode
=
nsresult
(
aValue
.
toInt32
(
)
)
;
}
(
*
mReject
)
(
errorCode
)
;
}
mResolve
.
reset
(
)
;
mReject
.
reset
(
)
;
}
void
DomPromiseListener
:
:
SetResolvers
(
CallbackTypeResolved
&
&
aResolve
CallbackTypeRejected
&
&
aReject
)
{
mResolve
=
Some
(
std
:
:
move
(
aResolve
)
)
;
mReject
=
Some
(
std
:
:
move
(
aReject
)
)
;
}
}
}
