const
{
utils
:
Cu
}
=
Components
;
Cu
.
importGlobalProperties
(
[
'
fetch
'
]
)
;
Cu
.
import
(
"
resource
:
/
/
testing
-
common
/
httpd
.
js
"
)
;
const
BinaryInputStream
=
Components
.
Constructor
(
"
mozilla
.
org
/
binaryinputstream
;
1
"
"
nsIBinaryInputStream
"
"
setInputStream
"
)
;
var
server
;
function
getBaseUrl
(
)
{
return
"
http
:
/
/
localhost
:
"
+
server
.
identity
.
primaryPort
;
}
function
createTestData
(
testPath
)
{
return
{
testPath
:
testPath
request
:
{
headers
:
{
}
contentType
:
"
application
/
json
"
}
response
:
{
headers
:
{
}
contentType
:
"
application
/
json
"
body
:
"
{
\
"
Look
\
"
:
\
"
Success
!
\
"
}
"
status
:
200
statusText
:
"
OK
"
}
}
;
}
function
readDataFromRequest
(
aRequest
)
{
let
requestData
=
{
}
;
if
(
aRequest
.
method
=
=
"
POST
"
|
|
aRequest
.
method
=
=
"
PUT
"
)
{
if
(
aRequest
.
bodyInputStream
)
{
let
inputStream
=
new
BinaryInputStream
(
aRequest
.
bodyInputStream
)
;
let
bytes
=
[
]
;
let
available
;
while
(
(
available
=
inputStream
.
available
(
)
)
>
0
)
{
Array
.
prototype
.
push
.
apply
(
bytes
inputStream
.
readByteArray
(
available
)
)
;
}
requestData
.
body
=
String
.
fromCharCode
.
apply
(
null
bytes
)
;
requestData
.
contentType
=
aRequest
.
getHeader
(
"
Content
-
Type
"
)
;
}
}
return
requestData
;
}
function
writeDataToResponse
(
aData
aResponse
)
{
aResponse
.
setStatusLine
(
null
aData
.
status
aData
.
statusText
)
;
aResponse
.
setHeader
(
"
Content
-
Type
"
aData
.
contentType
)
;
for
(
let
header
in
aData
.
headers
)
{
aResponse
.
setHeader
(
header
aData
.
headers
[
header
]
)
;
}
aResponse
.
write
(
aData
.
body
)
;
}
add_test
(
function
test_GetData
(
)
{
do_test_pending
(
)
;
let
testData
=
createTestData
(
"
/
getData
"
)
;
let
headerNames
=
[
"
x
-
test
-
header
"
"
x
-
other
-
test
-
header
"
]
;
for
(
let
headerName
of
headerNames
)
{
testData
.
request
.
headers
[
headerName
]
=
"
test
-
value
-
for
-
"
+
headerName
;
}
server
.
registerPathHandler
(
testData
.
testPath
function
(
aRequest
aResponse
)
{
try
{
for
(
let
headerName
of
headerNames
)
{
do_check_eq
(
testData
.
request
.
headers
[
headerName
]
aRequest
.
getHeader
(
headerName
)
)
;
}
writeDataToResponse
(
testData
.
response
aResponse
)
;
}
catch
(
e
)
{
do_report_unexpected_exception
(
e
)
;
}
}
)
;
fetch
(
getBaseUrl
(
)
+
testData
.
testPath
{
headers
:
testData
.
request
.
headers
}
)
.
then
(
function
(
response
)
{
do_check_true
(
response
.
ok
)
;
do_check_eq
(
response
.
status
testData
.
response
.
status
)
;
do_check_eq
(
response
.
statusText
testData
.
response
.
statusText
)
;
do_check_eq
(
response
.
headers
.
get
(
"
Content
-
Type
"
)
testData
.
response
.
contentType
)
;
do_check_eq
(
response
.
headers
.
get
(
"
content
-
type
"
)
testData
.
response
.
contentType
)
;
response
.
text
(
)
.
then
(
function
(
text
)
{
do_check_eq
(
text
testData
.
response
.
body
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
.
catch
(
function
(
e
)
{
do_report_unexpected_exception
(
e
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
add_test
(
function
test_GetData
(
)
{
do_test_pending
(
)
;
let
testData
=
createTestData
(
"
/
getData
"
)
;
server
.
registerPathHandler
(
testData
.
testPath
function
(
aRequest
aResponse
)
{
try
{
writeDataToResponse
(
testData
.
response
aResponse
)
;
}
catch
(
e
)
{
do_report_unexpected_exception
(
e
)
;
}
}
)
;
fetch
(
getBaseUrl
(
)
+
testData
.
testPath
{
headers
:
testData
.
request
.
headers
}
)
.
then
(
function
(
response
)
{
do_check_true
(
response
.
ok
)
;
do_check_eq
(
response
.
status
testData
.
response
.
status
)
;
response
.
text
(
)
.
then
(
function
(
text
)
{
do_check_eq
(
text
testData
.
response
.
body
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
.
catch
(
function
(
e
)
{
do_report_unexpected_exception
(
e
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
add_test
(
function
test_get40x
(
)
{
do_test_pending
(
)
;
let
notFoundData
=
createTestData
(
"
/
getNotFound
"
)
;
notFoundData
.
response
.
status
=
404
;
notFoundData
.
response
.
statusText
=
"
Not
found
"
;
notFoundData
.
response
.
body
=
null
;
fetch
(
getBaseUrl
(
)
+
notFoundData
.
testPath
)
.
then
(
function
(
response
)
{
do_check_eq
(
response
.
status
404
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
add_test
(
function
test_get50x
(
)
{
do_test_pending
(
)
;
let
serverErrorData
=
createTestData
(
"
/
serverError
"
)
;
serverErrorData
.
response
.
status
=
500
;
serverErrorData
.
response
.
statusText
=
"
The
server
broke
"
;
serverErrorData
.
response
.
body
=
null
;
server
.
registerPathHandler
(
serverErrorData
.
testPath
function
(
aRequest
aResponse
)
{
try
{
writeDataToResponse
(
serverErrorData
.
response
aResponse
)
;
}
catch
(
e
)
{
do_report_unexpected_exception
(
e
)
;
}
}
)
;
fetch
(
getBaseUrl
(
)
+
serverErrorData
.
testPath
)
.
then
(
function
(
response
)
{
do_check_eq
(
response
.
status
500
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
add_test
(
function
test_getTestFailedConnect
(
)
{
do_test_pending
(
)
;
fetch
(
"
ftp
:
/
/
localhost
/
should
/
fail
"
)
.
then
(
response
=
>
{
do_throw
(
"
Request
should
not
succeed
"
)
;
}
)
.
catch
(
err
=
>
{
do_check_eq
(
true
err
instanceof
TypeError
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
add_test
(
function
test_PostJSONData
(
)
{
do_test_pending
(
)
;
let
testData
=
createTestData
(
"
/
postJSONData
"
)
;
testData
.
request
.
body
=
"
{
\
"
foo
\
"
:
\
"
bar
\
"
}
"
;
server
.
registerPathHandler
(
testData
.
testPath
function
(
aRequest
aResponse
)
{
try
{
let
requestData
=
readDataFromRequest
(
aRequest
)
;
do_check_eq
(
requestData
.
body
testData
.
request
.
body
)
;
do_check_eq
(
requestData
.
contentType
testData
.
request
.
contentType
)
;
writeDataToResponse
(
testData
.
response
aResponse
)
;
}
catch
(
e
)
{
do_check_true
(
false
)
;
}
}
)
;
fetch
(
getBaseUrl
(
)
+
testData
.
testPath
{
method
:
"
POST
"
body
:
testData
.
request
.
body
headers
:
{
'
Content
-
Type
'
:
'
application
/
json
'
}
}
)
.
then
(
function
(
aResponse
)
{
do_check_true
(
aResponse
.
ok
)
;
do_check_eq
(
aResponse
.
status
testData
.
response
.
status
)
;
do_check_eq
(
aResponse
.
statusText
testData
.
response
.
statusText
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
.
catch
(
function
(
e
)
{
do_report_unexpected_exception
(
e
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
add_test
(
function
test_PostJSONData
(
)
{
do_test_pending
(
)
;
let
testData
=
createTestData
(
"
/
postTextData
"
)
;
testData
.
request
.
body
=
"
A
plain
text
body
"
;
testData
.
request
.
contentType
=
"
text
/
plain
"
;
let
responseHeaderName
=
"
some
-
response
-
header
"
;
testData
.
response
.
headers
[
responseHeaderName
]
=
"
some
header
value
"
;
server
.
registerPathHandler
(
testData
.
testPath
function
(
aRequest
aResponse
)
{
try
{
let
requestData
=
readDataFromRequest
(
aRequest
)
;
do_check_eq
(
requestData
.
body
testData
.
request
.
body
)
;
do_check_eq
(
requestData
.
contentType
testData
.
request
.
contentType
)
;
writeDataToResponse
(
testData
.
response
aResponse
)
;
}
catch
(
e
)
{
do_check_true
(
false
)
;
}
}
)
;
fetch
(
getBaseUrl
(
)
+
testData
.
testPath
{
method
:
"
POST
"
body
:
testData
.
request
.
body
headers
:
{
'
Content
-
Type
'
:
testData
.
request
.
contentType
}
}
)
.
then
(
function
(
aResponse
)
{
do_check_true
(
aResponse
.
ok
)
;
do_check_eq
(
aResponse
.
status
testData
.
response
.
status
)
;
do_check_eq
(
aResponse
.
statusText
testData
.
response
.
statusText
)
;
do_check_eq
(
aResponse
.
headers
.
get
(
responseHeaderName
)
testData
.
response
.
headers
[
responseHeaderName
]
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
.
catch
(
function
(
e
)
{
do_report_unexpected_exception
(
e
)
;
do_test_finished
(
)
;
run_next_test
(
)
;
}
)
;
}
)
;
function
run_test
(
)
{
server
=
new
HttpServer
(
)
;
server
.
start
(
-
1
)
;
run_next_test
(
)
;
do_register_cleanup
(
function
(
)
{
server
.
stop
(
function
(
)
{
}
)
;
}
)
;
}
