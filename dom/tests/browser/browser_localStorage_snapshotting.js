const
HELPER_PAGE_URL
=
"
http
:
/
/
example
.
com
/
browser
/
dom
/
tests
/
browser
/
page_localstorage_snapshotting
.
html
"
;
const
HELPER_PAGE_ORIGIN
=
"
http
:
/
/
example
.
com
/
"
;
let
testDir
=
gTestPath
.
substr
(
0
gTestPath
.
lastIndexOf
(
"
/
"
)
)
;
Services
.
scriptloader
.
loadSubScript
(
testDir
+
"
/
helper_localStorage
.
js
"
this
)
;
function
clearOrigin
(
)
{
let
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
HELPER_PAGE_ORIGIN
)
;
let
request
=
Services
.
qms
.
clearStoragesForPrincipal
(
principal
"
default
"
"
ls
"
)
;
let
promise
=
new
Promise
(
resolve
=
>
{
request
.
callback
=
(
)
=
>
{
resolve
(
)
;
}
;
}
)
;
return
promise
;
}
async
function
applyMutations
(
knownTab
mutations
)
{
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
mutations
]
function
(
mutations
)
{
return
content
.
wrappedJSObject
.
applyMutations
(
Cu
.
cloneInto
(
mutations
content
)
)
;
}
)
;
}
async
function
verifyState
(
knownTab
expectedState
)
{
let
actualState
=
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
]
function
(
)
{
return
content
.
wrappedJSObject
.
getState
(
)
;
}
)
;
for
(
let
[
expectedKey
expectedValue
]
of
Object
.
entries
(
expectedState
)
)
{
ok
(
actualState
.
hasOwnProperty
(
expectedKey
)
"
key
present
:
"
+
expectedKey
)
;
is
(
actualState
[
expectedKey
]
expectedValue
"
value
correct
"
)
;
}
for
(
let
actualKey
of
Object
.
keys
(
actualState
)
)
{
if
(
!
expectedState
.
hasOwnProperty
(
actualKey
)
)
{
ok
(
false
"
actual
state
has
key
it
shouldn
'
t
have
:
"
+
actualKey
)
;
}
}
}
async
function
getKeys
(
knownTab
)
{
let
keys
=
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
]
function
(
)
{
return
content
.
wrappedJSObject
.
getKeys
(
)
;
}
)
;
return
keys
;
}
async
function
beginExplicitSnapshot
(
knownTab
)
{
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
]
function
(
)
{
return
content
.
wrappedJSObject
.
beginExplicitSnapshot
(
)
;
}
)
;
}
async
function
checkpointExplicitSnapshot
(
knownTab
)
{
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
]
function
(
)
{
return
content
.
wrappedJSObject
.
checkpointExplicitSnapshot
(
)
;
}
)
;
}
async
function
endExplicitSnapshot
(
knownTab
)
{
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
]
function
(
)
{
return
content
.
wrappedJSObject
.
endExplicitSnapshot
(
)
;
}
)
;
}
async
function
verifyHasSnapshot
(
knownTab
expectedHasSnapshot
)
{
let
hasSnapshot
=
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
]
function
(
)
{
return
content
.
wrappedJSObject
.
getHasSnapshot
(
)
;
}
)
;
is
(
hasSnapshot
expectedHasSnapshot
"
Correct
has
snapshot
"
)
;
}
async
function
verifySnapshotUsage
(
knownTab
expectedSnapshotUsage
)
{
let
snapshotUsage
=
await
SpecialPowers
.
spawn
(
knownTab
.
tab
.
linkedBrowser
[
]
function
(
)
{
return
content
.
wrappedJSObject
.
getSnapshotUsage
(
)
;
}
)
;
is
(
snapshotUsage
expectedSnapshotUsage
"
Correct
snapshot
usage
"
)
;
}
async
function
verifyParentState
(
expectedState
)
{
let
principal
=
Services
.
scriptSecurityManager
.
createContentPrincipalFromOrigin
(
HELPER_PAGE_ORIGIN
)
;
let
actualState
=
await
Services
.
domStorageManager
.
getState
(
principal
)
;
for
(
let
[
expectedKey
expectedValue
]
of
Object
.
entries
(
expectedState
)
)
{
ok
(
actualState
.
hasOwnProperty
(
expectedKey
)
"
key
present
:
"
+
expectedKey
)
;
is
(
actualState
[
expectedKey
]
expectedValue
"
value
correct
"
)
;
}
for
(
let
actualKey
of
Object
.
keys
(
actualState
)
)
{
if
(
!
expectedState
.
hasOwnProperty
(
actualKey
)
)
{
ok
(
false
"
actual
state
has
key
it
shouldn
'
t
have
:
"
+
actualKey
)
;
}
}
}
requestLongerTimeout
(
4
)
;
add_task
(
async
function
(
)
{
if
(
!
Services
.
domStorageManager
.
nextGenLocalStorageEnabled
)
{
ok
(
true
"
Test
ignored
when
the
next
gen
local
storage
is
not
enabled
.
"
)
;
return
;
}
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
storage
.
testing
"
true
]
[
"
dom
.
ipc
.
processCount
"
8
]
[
"
dom
.
ipc
.
processCount
.
webIsolated
"
4
]
]
}
)
;
await
clearOrigin
(
)
;
const
knownTabs
=
new
KnownTabs
(
)
;
const
writerTab1
=
await
openTestTab
(
HELPER_PAGE_URL
"
writer1
"
knownTabs
true
)
;
const
writerTab2
=
await
openTestTab
(
HELPER_PAGE_URL
"
writer2
"
knownTabs
true
)
;
const
readerTab1
=
await
openTestTab
(
HELPER_PAGE_URL
"
reader1
"
knownTabs
true
)
;
const
readerTab2
=
await
openTestTab
(
HELPER_PAGE_URL
"
reader2
"
knownTabs
true
)
;
const
initialMutations
=
[
[
null
null
]
[
"
key1
"
"
initial1
"
]
[
"
key2
"
"
initial2
"
]
[
"
key3
"
"
initial3
"
]
[
"
key5
"
"
initial5
"
]
[
"
key6
"
"
initial6
"
]
[
"
key7
"
"
initial7
"
]
[
"
key8
"
"
initial8
"
]
]
;
const
initialState
=
{
key1
:
"
initial1
"
key2
:
"
initial2
"
key3
:
"
initial3
"
key5
:
"
initial5
"
key6
:
"
initial6
"
key7
:
"
initial7
"
key8
:
"
initial8
"
}
;
let
sizeOfOneKey
;
let
sizeOfOneValue
;
let
sizeOfOneItem
;
let
sizeOfKeys
=
0
;
let
sizeOfItems
=
0
;
let
entries
=
Object
.
entries
(
initialState
)
;
for
(
let
i
=
0
;
i
<
entries
.
length
;
i
+
+
)
{
let
entry
=
entries
[
i
]
;
let
sizeOfKey
=
entry
[
0
]
.
length
;
let
sizeOfValue
=
entry
[
1
]
.
length
;
let
sizeOfItem
=
sizeOfKey
+
sizeOfValue
;
if
(
i
=
=
0
)
{
sizeOfOneKey
=
sizeOfKey
;
sizeOfOneValue
=
sizeOfValue
;
sizeOfOneItem
=
sizeOfItem
;
}
sizeOfKeys
+
=
sizeOfKey
;
sizeOfItems
+
=
sizeOfItem
;
}
info
(
"
Size
of
one
key
is
"
+
sizeOfOneKey
)
;
info
(
"
Size
of
one
value
is
"
+
sizeOfOneValue
)
;
info
(
"
Size
of
one
item
is
"
+
sizeOfOneItem
)
;
info
(
"
Size
of
keys
is
"
+
sizeOfKeys
)
;
info
(
"
Size
of
items
is
"
+
sizeOfItems
)
;
const
prefillValues
=
[
0
sizeOfOneKey
-
1
sizeOfOneKey
+
1
sizeOfOneItem
2
*
sizeOfOneItem
sizeOfKeys
sizeOfKeys
+
sizeOfOneValue
-
1
sizeOfKeys
+
sizeOfOneValue
sizeOfKeys
+
sizeOfOneValue
+
1
sizeOfKeys
+
2
*
sizeOfOneValue
sizeOfKeys
+
3
*
sizeOfOneValue
sizeOfKeys
+
4
*
sizeOfOneValue
sizeOfKeys
+
5
*
sizeOfOneValue
sizeOfKeys
+
6
*
sizeOfOneValue
sizeOfItems
-
1
]
;
for
(
let
prefillValue
of
prefillValues
)
{
info
(
"
Setting
prefill
value
to
"
+
prefillValue
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
storage
.
snapshot_prefill
"
prefillValue
]
]
}
)
;
const
gradualPrefillValues
=
[
0
sizeOfOneKey
-
1
sizeOfOneKey
+
1
sizeOfOneItem
2
*
sizeOfOneItem
3
*
sizeOfOneItem
4
*
sizeOfOneItem
5
*
sizeOfOneItem
6
*
sizeOfOneItem
sizeOfItems
-
1
]
;
for
(
let
gradualPrefillValue
of
gradualPrefillValues
)
{
info
(
"
Setting
gradual
prefill
value
to
"
+
gradualPrefillValue
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
storage
.
snapshot_gradual_prefill
"
gradualPrefillValue
]
]
}
)
;
info
(
"
Stage
1
"
)
;
const
setRemoveMutations1
=
[
[
"
key0
"
"
setRemove10
"
]
[
"
key1
"
"
setRemove11
"
]
[
"
key2
"
null
]
[
"
key3
"
"
setRemove13
"
]
[
"
key4
"
"
setRemove14
"
]
[
"
key5
"
"
setRemove15
"
]
[
"
key6
"
"
setRemove16
"
]
[
"
key7
"
"
setRemove17
"
]
[
"
key8
"
null
]
[
"
key9
"
"
setRemove19
"
]
]
;
const
setRemoveState1
=
{
key0
:
"
setRemove10
"
key1
:
"
setRemove11
"
key3
:
"
setRemove13
"
key4
:
"
setRemove14
"
key5
:
"
setRemove15
"
key6
:
"
setRemove16
"
key7
:
"
setRemove17
"
key9
:
"
setRemove19
"
}
;
const
setRemoveMutations2
=
[
[
"
key0
"
"
setRemove20
"
]
[
"
key1
"
null
]
[
"
key2
"
"
setRemove22
"
]
[
"
key3
"
"
setRemove23
"
]
[
"
key4
"
"
setRemove24
"
]
[
"
key5
"
"
setRemove25
"
]
[
"
key6
"
"
setRemove26
"
]
[
"
key7
"
null
]
[
"
key8
"
"
setRemove28
"
]
[
"
key9
"
"
setRemove29
"
]
]
;
const
setRemoveState2
=
{
key0
:
"
setRemove20
"
key2
:
"
setRemove22
"
key3
:
"
setRemove23
"
key4
:
"
setRemove24
"
key5
:
"
setRemove25
"
key6
:
"
setRemove26
"
key8
:
"
setRemove28
"
key9
:
"
setRemove29
"
}
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
applyMutations
(
writerTab1
initialMutations
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
writerTab2
)
;
await
beginExplicitSnapshot
(
readerTab1
)
;
await
applyMutations
(
writerTab1
setRemoveMutations1
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
readerTab2
)
;
await
applyMutations
(
writerTab2
setRemoveMutations2
)
;
await
endExplicitSnapshot
(
writerTab2
)
;
await
verifyState
(
readerTab1
initialState
)
;
await
endExplicitSnapshot
(
readerTab1
)
;
await
verifyState
(
readerTab2
setRemoveState1
)
;
await
endExplicitSnapshot
(
readerTab2
)
;
await
beginExplicitSnapshot
(
readerTab1
)
;
await
verifyState
(
readerTab1
setRemoveState2
)
;
await
endExplicitSnapshot
(
readerTab1
)
;
info
(
"
Stage
2
"
)
;
const
setRemoveClearMutations1
=
[
[
"
key0
"
"
setRemoveClear10
"
]
[
"
key1
"
null
]
[
null
null
]
]
;
const
setRemoveClearState1
=
{
}
;
const
setRemoveClearMutations2
=
[
[
"
key8
"
null
]
[
"
key9
"
"
setRemoveClear29
"
]
[
null
null
]
]
;
const
setRemoveClearState2
=
{
}
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
applyMutations
(
writerTab1
initialMutations
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
writerTab2
)
;
await
beginExplicitSnapshot
(
readerTab1
)
;
await
applyMutations
(
writerTab1
setRemoveClearMutations1
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
readerTab2
)
;
await
applyMutations
(
writerTab2
setRemoveClearMutations2
)
;
await
endExplicitSnapshot
(
writerTab2
)
;
await
verifyState
(
readerTab1
initialState
)
;
await
endExplicitSnapshot
(
readerTab1
)
;
await
verifyState
(
readerTab2
setRemoveClearState1
)
;
await
endExplicitSnapshot
(
readerTab2
)
;
await
beginExplicitSnapshot
(
readerTab1
)
;
await
verifyState
(
readerTab1
setRemoveClearState2
)
;
await
endExplicitSnapshot
(
readerTab1
)
;
info
(
"
Stage
3
"
)
;
const
changeOrderMutations
=
[
[
"
key1
"
null
]
[
"
key2
"
null
]
[
"
key3
"
null
]
[
"
key5
"
null
]
[
"
key6
"
null
]
[
"
key7
"
null
]
[
"
key8
"
null
]
[
"
key8
"
"
initial8
"
]
[
"
key7
"
"
initial7
"
]
[
"
key6
"
"
initial6
"
]
[
"
key5
"
"
initial5
"
]
[
"
key3
"
"
initial3
"
]
[
"
key2
"
"
initial2
"
]
[
"
key1
"
"
initial1
"
]
]
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
applyMutations
(
writerTab1
initialMutations
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
readerTab1
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
readerTab2
)
;
let
tab1Keys
=
await
getKeys
(
readerTab1
)
;
await
endExplicitSnapshot
(
readerTab1
)
;
await
applyMutations
(
writerTab1
changeOrderMutations
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
let
tab2Keys
=
await
getKeys
(
readerTab2
)
;
await
endExplicitSnapshot
(
readerTab2
)
;
is
(
tab2Keys
.
length
tab1Keys
.
length
"
Correct
keys
length
"
)
;
for
(
let
i
=
0
;
i
<
tab2Keys
.
length
;
i
+
+
)
{
is
(
tab2Keys
[
i
]
tab1Keys
[
i
]
"
Correct
key
"
)
;
}
await
beginExplicitSnapshot
(
readerTab1
)
;
await
verifyState
(
readerTab1
initialState
)
;
await
endExplicitSnapshot
(
readerTab1
)
;
}
}
await
cleanupTabs
(
knownTabs
)
;
clearOrigin
(
)
;
}
)
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
ipc
.
processCount
"
4
]
[
"
dom
.
ipc
.
processCount
.
webIsolated
"
2
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
initial_preincrement
"
0
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
reduced_initial_preincrement
"
0
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
gradual_preincrement
"
0
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
reuced_gradual_preincrement
"
0
]
[
"
dom
.
storage
.
testing
"
true
]
]
}
)
;
await
clearOriginStorageEnsuringNoPreload
(
HELPER_PAGE_ORIGIN
)
;
const
knownTabs
=
new
KnownTabs
(
)
;
const
writerTab1
=
await
openTestTab
(
HELPER_PAGE_URL
"
writer1
"
knownTabs
true
)
;
const
writerTab2
=
await
openTestTab
(
HELPER_PAGE_URL
"
writer2
"
knownTabs
true
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
applyMutations
(
writerTab1
[
[
"
key
"
"
something
"
]
]
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
beginExplicitSnapshot
(
writerTab2
)
;
await
applyMutations
(
writerTab1
[
[
"
key
"
"
somethingBigger
"
]
]
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
applyMutations
(
writerTab2
[
[
"
key
"
null
]
]
)
;
await
endExplicitSnapshot
(
writerTab2
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
verifyState
(
writerTab1
{
}
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
cleanupTabs
(
knownTabs
)
;
clearOriginStorageEnsuringNoPreload
(
HELPER_PAGE_ORIGIN
)
;
}
)
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
ipc
.
processCount
"
4
]
[
"
dom
.
ipc
.
processCount
.
webIsolated
"
2
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
initial_preincrement
"
0
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
reduced_initial_preincrement
"
0
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
gradual_preincrement
"
0
]
[
"
dom
.
storage
.
snapshot_peak_usage
.
reuced_gradual_preincrement
"
0
]
[
"
dom
.
storage
.
testing
"
true
]
]
}
)
;
await
clearOriginStorageEnsuringNoPreload
(
HELPER_PAGE_ORIGIN
)
;
const
knownTabs
=
new
KnownTabs
(
)
;
const
writerTab1
=
await
openTestTab
(
HELPER_PAGE_URL
"
writer1
"
knownTabs
true
)
;
const
writerTab2
=
await
openTestTab
(
HELPER_PAGE_URL
"
writer2
"
knownTabs
true
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
verifySnapshotUsage
(
writerTab1
0
)
;
await
applyMutations
(
writerTab1
[
[
"
key
"
"
something
"
]
]
)
;
await
verifySnapshotUsage
(
writerTab1
12
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
verifyHasSnapshot
(
writerTab1
false
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
verifySnapshotUsage
(
writerTab1
12
)
;
await
applyMutations
(
writerTab1
[
[
"
key
"
"
somethingBigger
"
]
]
)
;
await
verifySnapshotUsage
(
writerTab1
18
)
;
await
beginExplicitSnapshot
(
writerTab2
)
;
await
verifySnapshotUsage
(
writerTab2
18
)
;
await
applyMutations
(
writerTab2
[
[
null
null
]
]
)
;
await
verifySnapshotUsage
(
writerTab2
6
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
verifyHasSnapshot
(
writerTab1
false
)
;
await
endExplicitSnapshot
(
writerTab2
)
;
await
verifyHasSnapshot
(
writerTab2
false
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
verifySnapshotUsage
(
writerTab1
0
)
;
await
verifyState
(
writerTab1
{
}
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
verifyHasSnapshot
(
writerTab1
false
)
;
await
cleanupTabs
(
knownTabs
)
;
clearOriginStorageEnsuringNoPreload
(
HELPER_PAGE_ORIGIN
)
;
}
)
;
add_task
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
ipc
.
processCount
"
4
]
[
"
dom
.
ipc
.
processCount
.
webIsolated
"
2
]
[
"
dom
.
storage
.
testing
"
true
]
]
}
)
;
await
clearOriginStorageEnsuringNoPreload
(
HELPER_PAGE_ORIGIN
)
;
const
knownTabs
=
new
KnownTabs
(
)
;
const
writerTab1
=
await
openTestTab
(
HELPER_PAGE_URL
"
writer1
"
knownTabs
true
)
;
await
verifyParentState
(
{
}
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
}
)
;
await
applyMutations
(
writerTab1
[
[
"
key
"
"
something
"
]
]
)
;
await
verifyParentState
(
{
}
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
key
:
"
something
"
}
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
key
:
"
something
"
}
)
;
await
applyMutations
(
writerTab1
[
[
"
key
"
"
somethingBigger
"
]
]
)
;
await
verifyParentState
(
{
key
:
"
something
"
}
)
;
await
checkpointExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
key
:
"
somethingBigger
"
}
)
;
await
applyMutations
(
writerTab1
[
[
"
key
"
null
]
]
)
;
await
verifyParentState
(
{
key
:
"
somethingBigger
"
}
)
;
await
checkpointExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
}
)
;
await
applyMutations
(
writerTab1
[
[
"
otherKey
"
"
something
"
]
]
)
;
await
verifyParentState
(
{
}
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
otherKey
:
"
something
"
}
)
;
await
beginExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
otherKey
:
"
something
"
}
)
;
await
verifyState
(
writerTab1
{
otherKey
:
"
something
"
}
)
;
await
endExplicitSnapshot
(
writerTab1
)
;
await
verifyParentState
(
{
otherKey
:
"
something
"
}
)
;
await
cleanupTabs
(
knownTabs
)
;
clearOriginStorageEnsuringNoPreload
(
HELPER_PAGE_ORIGIN
)
;
}
)
;
