"
use
strict
"
;
const
PAGE_URL
=
"
http
:
/
/
example
.
com
/
browser
/
dom
/
tests
/
browser
/
beforeunload_test_page
.
html
"
;
function
addBeforeUnloadListeners
(
browser
howMany
=
1
frameDepth
=
0
)
{
return
controlFrameAt
(
browser
frameDepth
{
name
:
"
AddBeforeUnload
"
howMany
}
)
;
}
function
addOuterBeforeUnloadListeners
(
browser
howMany
=
1
frameDepth
=
1
)
{
if
(
frameDepth
=
=
0
)
{
throw
new
Error
(
"
When
adding
a
beforeunload
listener
on
an
outer
"
+
"
window
the
frame
you
'
re
targeting
needs
to
be
at
"
+
"
depth
>
0
.
"
)
}
return
controlFrameAt
(
browser
frameDepth
{
name
:
"
AddOuterBeforeUnload
"
howMany
}
)
;
}
function
removeBeforeUnloadListeners
(
browser
howMany
=
1
frameDepth
=
0
)
{
return
controlFrameAt
(
browser
frameDepth
{
name
:
"
RemoveBeforeUnload
"
howMany
}
)
;
}
function
removeOuterBeforeUnloadListeners
(
browser
howMany
=
1
frameDepth
=
1
)
{
if
(
frameDepth
=
=
0
)
{
throw
new
Error
(
"
When
removing
a
beforeunload
listener
from
an
outer
"
+
"
window
the
frame
you
'
re
targeting
needs
to
be
at
"
+
"
depth
>
0
.
"
)
}
return
controlFrameAt
(
browser
frameDepth
{
name
:
"
RemoveOuterBeforeUnload
"
howMany
}
)
;
}
function
navigateSubframe
(
browser
url
frameDepth
=
0
)
{
let
navigatePromise
=
controlFrameAt
(
browser
frameDepth
{
name
:
"
Navigate
"
url
}
)
;
let
subframeLoad
=
BrowserTestUtils
.
browserLoaded
(
browser
true
)
;
return
Promise
.
all
(
[
navigatePromise
subframeLoad
]
)
;
}
function
removeSubframeFrom
(
browser
frameDepth
=
0
)
{
return
controlFrameAt
(
browser
frameDepth
{
name
:
"
RemoveSubframe
"
}
)
;
}
function
controlFrameAt
(
browser
frameDepth
command
)
{
return
ContentTask
.
spawn
(
browser
{
frameDepth
command
}
function
*
(
args
)
{
Cu
.
import
(
"
resource
:
/
/
testing
-
common
/
TestUtils
.
jsm
"
this
)
;
let
{
command
:
contentCommand
frameDepth
:
contentFrameDepth
}
=
args
;
let
targetContent
=
content
;
let
targetSubframe
=
content
.
document
.
getElementById
(
"
subframe
"
)
;
let
currentContent
=
targetContent
;
let
currentSubframe
=
targetSubframe
;
let
depth
=
0
;
do
{
currentContent
=
currentSubframe
.
contentWindow
;
currentSubframe
=
currentContent
.
document
.
getElementById
(
"
subframe
"
)
;
depth
+
+
;
if
(
depth
=
=
contentFrameDepth
)
{
targetContent
=
currentContent
;
targetSubframe
=
currentSubframe
;
}
}
while
(
currentSubframe
)
;
switch
(
contentCommand
.
name
)
{
case
"
AddBeforeUnload
"
:
{
let
BeforeUnloader
=
targetContent
.
wrappedJSObject
.
BeforeUnloader
;
Assert
.
ok
(
BeforeUnloader
"
Found
BeforeUnloader
in
the
test
page
.
"
)
;
BeforeUnloader
.
pushInner
(
contentCommand
.
howMany
)
;
break
;
}
case
"
AddOuterBeforeUnload
"
:
{
let
BeforeUnloader
=
targetContent
.
wrappedJSObject
.
BeforeUnloader
;
Assert
.
ok
(
BeforeUnloader
"
Found
BeforeUnloader
in
the
test
page
.
"
)
;
BeforeUnloader
.
pushOuter
(
contentCommand
.
howMany
)
;
break
;
}
case
"
RemoveBeforeUnload
"
:
{
let
BeforeUnloader
=
targetContent
.
wrappedJSObject
.
BeforeUnloader
;
Assert
.
ok
(
BeforeUnloader
"
Found
BeforeUnloader
in
the
test
page
.
"
)
;
BeforeUnloader
.
popInner
(
contentCommand
.
howMany
)
;
break
;
}
case
"
RemoveOuterBeforeUnload
"
:
{
let
BeforeUnloader
=
targetContent
.
wrappedJSObject
.
BeforeUnloader
;
Assert
.
ok
(
BeforeUnloader
"
Found
BeforeUnloader
in
the
test
page
.
"
)
;
BeforeUnloader
.
popOuter
(
contentCommand
.
howMany
)
;
break
;
}
case
"
Navigate
"
:
{
targetContent
.
location
=
contentCommand
.
url
;
let
destroyedOuterWindows
=
depth
-
contentFrameDepth
;
if
(
destroyedOuterWindows
)
{
yield
TestUtils
.
topicObserved
(
"
outer
-
window
-
destroyed
"
(
)
=
>
{
destroyedOuterWindows
-
-
;
return
!
destroyedOuterWindows
;
}
)
;
}
break
;
}
case
"
RemoveSubframe
"
:
{
let
subframe
=
targetContent
.
document
.
getElementById
(
"
subframe
"
)
;
Assert
.
ok
(
subframe
"
Found
subframe
at
frame
depth
of
"
+
contentFrameDepth
)
;
subframe
.
remove
(
)
;
let
destroyedOuterWindows
=
depth
-
contentFrameDepth
;
if
(
destroyedOuterWindows
)
{
yield
TestUtils
.
topicObserved
(
"
outer
-
window
-
destroyed
"
(
)
=
>
{
destroyedOuterWindows
-
-
;
return
!
destroyedOuterWindows
;
}
)
;
}
break
;
}
}
}
)
;
}
function
*
prepareSubframes
(
browser
options
)
{
browser
.
reload
(
)
;
yield
BrowserTestUtils
.
browserLoaded
(
browser
)
;
yield
ContentTask
.
spawn
(
browser
{
options
PAGE_URL
}
function
*
(
args
)
{
let
{
options
:
allSubframeOptions
PAGE_URL
:
contentPageURL
}
=
args
;
function
loadBeforeUnloadHelper
(
doc
subframeOptions
)
{
let
subframe
=
doc
.
getElementById
(
"
subframe
"
)
;
subframe
.
remove
(
)
;
if
(
subframeOptions
.
sandboxAttributes
=
=
=
null
)
{
subframe
.
removeAttribute
(
"
sandbox
"
)
;
}
else
{
subframe
.
setAttribute
(
"
sandbox
"
subframeOptions
.
sandboxAttributes
)
;
}
doc
.
body
.
appendChild
(
subframe
)
;
subframe
.
contentWindow
.
location
=
contentPageURL
;
return
ContentTaskUtils
.
waitForEvent
(
subframe
"
load
"
)
.
then
(
(
)
=
>
{
return
subframe
.
contentDocument
;
}
)
;
}
let
currentDoc
=
content
.
document
;
for
(
let
subframeOptions
of
allSubframeOptions
)
{
currentDoc
=
yield
loadBeforeUnloadHelper
(
currentDoc
subframeOptions
)
;
}
}
)
;
}
function
assertHasBeforeUnload
(
browser
expected
)
{
Assert
.
equal
(
browser
.
frameLoader
.
tabParent
.
hasBeforeUnload
expected
)
;
}
add_task
(
function
*
test_inner_window_scenarios
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE_URL
}
function
*
(
browser
)
{
Assert
.
ok
(
browser
.
isRemoteBrowser
"
This
test
only
makes
sense
with
out
of
process
browsers
.
"
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addBeforeUnloadListeners
(
browser
3
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addBeforeUnloadListeners
(
browser
5
)
;
yield
navigateSubframe
(
browser
"
http
:
/
/
example
.
com
"
)
;
assertHasBeforeUnload
(
browser
false
)
;
browser
.
loadURI
(
PAGE_URL
)
;
yield
BrowserTestUtils
.
browserLoaded
(
browser
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
const
TOP
=
0
;
const
MIDDLE
=
1
;
const
BOTTOM
=
2
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addBeforeUnloadListeners
(
browser
2
MIDDLE
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
addBeforeUnloadListeners
(
browser
1
TOP
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
addBeforeUnloadListeners
(
browser
5
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
1
TOP
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
5
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
2
MIDDLE
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addBeforeUnloadListeners
(
browser
5
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
navigateSubframe
(
browser
"
http
:
/
/
example
.
com
"
BOTTOM
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
yield
addBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
navigateSubframe
(
browser
"
http
:
/
/
example
.
com
"
MIDDLE
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
yield
addBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeSubframeFrom
(
browser
MIDDLE
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeSubframeFrom
(
browser
TOP
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
yield
addBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeSubframeFrom
(
browser
TOP
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
"
allow
-
scripts
"
}
{
sandboxAttributes
:
"
allow
-
scripts
"
}
]
)
;
yield
addBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
removeBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
removeBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
"
allow
-
scripts
allow
-
modals
"
}
{
sandboxAttributes
:
"
allow
-
scripts
allow
-
modals
"
}
]
)
;
yield
addBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
assertHasBeforeUnload
(
browser
false
)
;
}
)
;
}
)
;
add_task
(
function
*
test_outer_window_scenarios
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE_URL
}
function
*
(
browser
)
{
Assert
.
ok
(
browser
.
isRemoteBrowser
"
This
test
only
makes
sense
with
out
of
process
browsers
.
"
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
const
TOP
=
0
;
const
MIDDLE
=
1
;
const
BOTTOM
=
2
;
yield
addOuterBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addOuterBeforeUnloadListeners
(
browser
5
)
;
yield
navigateSubframe
(
browser
"
http
:
/
/
example
.
com
"
TOP
)
;
assertHasBeforeUnload
(
browser
false
)
;
browser
.
loadURI
(
PAGE_URL
)
;
yield
BrowserTestUtils
.
browserLoaded
(
browser
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
addOuterBeforeUnloadListeners
(
browser
7
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
7
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
addOuterBeforeUnloadListeners
(
browser
5
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
navigateSubframe
(
browser
"
http
:
/
/
example
.
com
"
BOTTOM
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addOuterBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
navigateSubframe
(
browser
"
http
:
/
/
example
.
com
"
MIDDLE
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addOuterBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeSubframeFrom
(
browser
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeSubframeFrom
(
browser
MIDDLE
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addOuterBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeSubframeFrom
(
browser
TOP
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
"
allow
-
same
-
origin
allow
-
scripts
"
}
{
sandboxAttributes
:
"
allow
-
same
-
origin
allow
-
scripts
"
}
]
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addOuterBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
"
allow
-
same
-
origin
allow
-
scripts
allow
-
modals
"
}
{
sandboxAttributes
:
"
allow
-
same
-
origin
allow
-
scripts
allow
-
modals
"
}
]
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
yield
addOuterBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
1
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
assertHasBeforeUnload
(
browser
false
)
;
}
)
;
}
)
;
add_task
(
function
*
test_mixed_inner_and_outer_window_scenarios
(
)
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
PAGE_URL
}
function
*
(
browser
)
{
Assert
.
ok
(
browser
.
isRemoteBrowser
"
This
test
only
makes
sense
with
out
of
process
browsers
.
"
)
;
assertHasBeforeUnload
(
browser
false
)
;
yield
prepareSubframes
(
browser
[
{
sandboxAttributes
:
null
}
{
sandboxAttributes
:
null
}
]
)
;
const
TOP
=
0
;
const
MIDDLE
=
1
;
const
BOTTOM
=
2
;
yield
addBeforeUnloadListeners
(
browser
1
TOP
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
addBeforeUnloadListeners
(
browser
2
MIDDLE
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
addBeforeUnloadListeners
(
browser
5
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
addOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
addOuterBeforeUnloadListeners
(
browser
7
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
5
BOTTOM
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
2
MIDDLE
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
3
MIDDLE
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeBeforeUnloadListeners
(
browser
1
TOP
)
;
assertHasBeforeUnload
(
browser
true
)
;
yield
removeOuterBeforeUnloadListeners
(
browser
7
BOTTOM
)
;
assertHasBeforeUnload
(
browser
false
)
;
}
)
;
}
)
;
