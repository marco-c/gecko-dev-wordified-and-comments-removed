const
TEST_URI
=
"
http
:
/
/
example
.
com
/
browser
/
dom
/
tests
/
browser
/
test_largeAllocation
.
html
"
;
const
TEST_URI_2
=
"
http
:
/
/
example
.
com
/
browser
/
dom
/
tests
/
browser
/
test_largeAllocation2
.
html
"
;
function
expectProcessCreated
(
)
{
let
os
=
Cc
[
"
mozilla
.
org
/
observer
-
service
;
1
"
]
.
getService
(
Ci
.
nsIObserverService
)
;
let
kill
;
let
promise
=
new
Promise
(
(
resolve
reject
)
=
>
{
let
topic
=
"
ipc
:
content
-
created
"
;
function
observer
(
)
{
os
.
removeObserver
(
observer
topic
)
;
ok
(
true
"
Expect
process
created
"
)
;
resolve
(
)
;
}
os
.
addObserver
(
observer
topic
false
)
;
kill
=
(
)
=
>
{
os
.
removeObserver
(
observer
topic
)
;
ok
(
true
"
Expect
process
created
killed
"
)
;
reject
(
)
;
}
;
}
)
;
promise
.
kill
=
kill
;
return
promise
;
}
function
expectNoProcess
(
)
{
let
os
=
Cc
[
"
mozilla
.
org
/
observer
-
service
;
1
"
]
.
getService
(
Ci
.
nsIObserverService
)
;
let
topic
=
"
ipc
:
content
-
created
"
;
function
observer
(
)
{
ok
(
false
"
A
process
was
created
!
"
)
;
os
.
removeObserver
(
observer
topic
)
;
}
os
.
addObserver
(
observer
topic
false
)
;
return
(
)
=
>
os
.
removeObserver
(
observer
topic
)
;
}
function
getPID
(
aBrowser
)
{
return
ContentTask
.
spawn
(
aBrowser
null
(
)
=
>
{
const
appinfo
=
Components
.
classes
[
"
mozilla
.
org
/
xre
/
app
-
info
;
1
"
]
.
getService
(
Components
.
interfaces
.
nsIXULRuntime
)
;
return
appinfo
.
processID
;
}
)
;
}
function
getIsFreshProcess
(
aBrowser
)
{
return
ContentTask
.
spawn
(
aBrowser
null
(
)
=
>
{
try
{
return
docShell
.
QueryInterface
(
Ci
.
nsIInterfaceRequestor
)
.
getInterface
(
Ci
.
nsITabChild
)
.
isInFreshProcess
;
}
catch
(
e
)
{
return
false
;
}
}
)
;
}
add_task
(
function
*
(
)
{
requestLongerTimeout
(
2
)
;
yield
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
largeAllocationHeader
.
enabled
"
true
]
[
"
dom
.
ipc
.
processCount
.
webLargeAllocation
"
20
]
]
}
)
;
yield
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
function
*
(
aBrowser
)
{
info
(
"
Starting
test
0
"
)
;
let
pid1
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
epc
=
expectProcessCreated
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
location
=
TEST_URI
;
}
)
;
yield
epc
;
let
pid2
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid2
"
The
pids
should
be
different
between
the
initial
load
and
the
new
load
"
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
}
)
;
yield
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
function
*
(
aBrowser
)
{
info
(
"
Starting
test
1
"
)
;
let
pid1
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
stopExpectNoProcess
=
expectNoProcess
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
body
.
innerHTML
=
<
iframe
src
=
'
{
TEST_URI
}
'
>
<
/
iframe
>
;
return
new
Promise
(
resolve
=
>
{
content
.
document
.
body
.
querySelector
(
'
iframe
'
)
.
onload
=
(
)
=
>
{
ok
(
true
"
Iframe
finished
loading
"
)
;
resolve
(
)
;
}
;
}
)
;
}
)
;
let
pid2
=
yield
getPID
(
aBrowser
)
;
is
(
pid1
pid2
"
The
PID
should
not
have
changed
"
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
stopExpectNoProcess
(
)
;
}
)
;
yield
BrowserTestUtils
.
withNewTab
(
"
http
:
/
/
example
.
com
"
function
*
(
aBrowser
)
{
info
(
"
Starting
test
2
"
)
;
let
pid1
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
stopExpectNoProcess
=
expectNoProcess
(
)
;
let
loaded
=
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
body
.
innerHTML
=
'
<
button
>
CLICK
ME
<
/
button
>
'
;
return
new
Promise
(
resolve
=
>
{
content
.
document
.
querySelector
(
'
button
'
)
.
onclick
=
e
=
>
{
let
w
=
content
.
window
.
open
(
TEST_URI
'
_blank
'
)
;
w
.
onload
=
(
)
=
>
{
ok
(
true
"
Window
finished
loading
"
)
;
w
.
close
(
)
;
resolve
(
)
;
}
;
}
;
}
)
;
}
)
;
yield
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
button
"
{
}
aBrowser
)
;
yield
loaded
;
let
pid2
=
yield
getPID
(
aBrowser
)
;
is
(
pid1
pid2
"
The
PID
should
not
have
changed
"
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
stopExpectNoProcess
(
)
;
}
)
;
yield
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
function
*
(
aBrowser
)
{
info
(
"
Starting
test
3
"
)
;
let
pid1
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
epc
=
expectProcessCreated
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
location
=
TEST_URI
;
}
)
;
yield
epc
;
let
pid2
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid2
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
yield
BrowserTestUtils
.
browserLoaded
(
aBrowser
)
;
yield
ContentTask
.
spawn
(
aBrowser
null
(
)
=
>
content
.
document
.
location
=
"
about
:
blank
"
)
;
yield
BrowserTestUtils
.
browserLoaded
(
aBrowser
)
;
let
pid3
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
epc
=
expectProcessCreated
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
location
=
TEST_URI
;
}
)
;
yield
epc
;
let
pid4
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid4
)
;
isnot
(
pid2
pid4
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
}
)
;
yield
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
function
*
(
aBrowser
)
{
info
(
"
Starting
test
4
"
)
;
let
pid1
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
epc
=
expectProcessCreated
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
location
=
TEST_URI
;
}
)
;
yield
epc
;
let
pid2
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid2
"
PIDs
1
and
2
should
not
match
"
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
yield
BrowserTestUtils
.
browserLoaded
(
aBrowser
)
;
yield
ContentTask
.
spawn
(
aBrowser
null
(
)
=
>
{
content
.
document
.
location
=
"
about
:
blank
"
;
}
)
;
yield
BrowserTestUtils
.
browserLoaded
(
aBrowser
)
;
let
pid3
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
epc
=
expectProcessCreated
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
window
.
history
.
back
(
)
;
}
)
;
yield
epc
;
let
pid4
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid4
"
PID
4
shouldn
'
t
match
PID
1
"
)
;
isnot
(
pid2
pid4
"
PID
4
shouldn
'
t
match
PID
2
"
)
;
isnot
(
pid3
pid4
"
PID
4
shouldn
'
t
match
PID
3
"
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
}
)
;
yield
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
function
*
(
aBrowser
)
{
info
(
"
Starting
test
5
"
)
;
let
pid1
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
ready
=
Promise
.
all
(
[
expectProcessCreated
(
)
BrowserTestUtils
.
browserLoaded
(
aBrowser
)
]
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
location
=
TEST_URI
;
}
)
;
yield
ready
;
let
pid2
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid2
"
PIDs
1
and
2
should
not
match
"
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
epc
=
expectProcessCreated
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI_2
TEST_URI_2
=
>
{
content
.
document
.
location
=
TEST_URI_2
;
}
)
;
yield
epc
;
epc
=
expectProcessCreated
(
)
;
if
(
!
(
yield
getIsFreshProcess
(
aBrowser
)
)
)
{
yield
epc
;
}
else
{
epc
.
kill
(
)
;
}
let
pid3
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid3
"
PIDs
1
and
3
should
not
match
"
)
;
isnot
(
pid2
pid3
"
PIDs
2
and
3
should
not
match
"
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
}
)
;
yield
BrowserTestUtils
.
withNewTab
(
"
about
:
blank
"
function
*
(
aBrowser
)
{
info
(
"
Starting
test
6
"
)
;
let
pid1
=
yield
getPID
(
aBrowser
)
;
is
(
false
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
ready
=
Promise
.
all
(
[
expectProcessCreated
(
)
BrowserTestUtils
.
browserLoaded
(
aBrowser
)
]
)
;
yield
ContentTask
.
spawn
(
aBrowser
TEST_URI
TEST_URI
=
>
{
content
.
document
.
location
=
TEST_URI
;
}
)
;
yield
ready
;
let
pid2
=
yield
getPID
(
aBrowser
)
;
isnot
(
pid1
pid2
"
PIDs
1
and
2
should
not
match
"
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
let
stopExpectNoProcess
=
expectNoProcess
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
null
(
)
=
>
{
this
.
__newWindow
=
content
.
window
.
open
(
"
about
:
blank
"
)
;
content
.
document
.
location
=
"
about
:
blank
"
;
}
)
;
yield
BrowserTestUtils
.
browserLoaded
(
aBrowser
)
;
let
pid3
=
yield
getPID
(
aBrowser
)
;
is
(
pid3
pid2
"
PIDs
2
and
3
should
match
"
)
;
is
(
true
yield
getIsFreshProcess
(
aBrowser
)
)
;
stopExpectNoProcess
(
)
;
yield
ContentTask
.
spawn
(
aBrowser
null
(
)
=
>
{
ok
(
this
.
__newWindow
"
The
window
should
have
been
stored
"
)
;
this
.
__newWindow
.
close
(
)
;
}
)
;
}
)
;
}
)
;
