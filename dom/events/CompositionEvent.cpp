#
include
"
mozilla
/
dom
/
CompositionEvent
.
h
"
#
include
"
mozilla
/
TextEvents
.
h
"
#
include
"
prtime
.
h
"
namespace
mozilla
{
namespace
dom
{
CompositionEvent
:
:
CompositionEvent
(
EventTarget
*
aOwner
nsPresContext
*
aPresContext
WidgetCompositionEvent
*
aEvent
)
:
UIEvent
(
aOwner
aPresContext
aEvent
?
aEvent
:
new
WidgetCompositionEvent
(
false
eVoidEvent
nullptr
)
)
{
NS_ASSERTION
(
mEvent
-
>
mClass
=
=
eCompositionEventClass
"
event
type
mismatch
"
)
;
if
(
aEvent
)
{
mEventIsInternal
=
false
;
}
else
{
mEventIsInternal
=
true
;
mEvent
-
>
mTime
=
PR_Now
(
)
;
mEvent
-
>
mFlags
.
mCancelable
=
false
;
}
mData
=
mEvent
-
>
AsCompositionEvent
(
)
-
>
mData
;
}
NS_IMPL_ADDREF_INHERITED
(
CompositionEvent
UIEvent
)
NS_IMPL_RELEASE_INHERITED
(
CompositionEvent
UIEvent
)
NS_INTERFACE_MAP_BEGIN
(
CompositionEvent
)
NS_INTERFACE_MAP_END_INHERITING
(
UIEvent
)
void
CompositionEvent
:
:
GetData
(
nsAString
&
aData
)
const
{
aData
=
mData
;
}
void
CompositionEvent
:
:
GetLocale
(
nsAString
&
aLocale
)
const
{
aLocale
=
mLocale
;
}
void
CompositionEvent
:
:
InitCompositionEvent
(
const
nsAString
&
aType
bool
aCanBubble
bool
aCancelable
nsGlobalWindow
*
aView
const
nsAString
&
aData
const
nsAString
&
aLocale
)
{
UIEvent
:
:
InitUIEvent
(
aType
aCanBubble
aCancelable
aView
0
)
;
mData
=
aData
;
mLocale
=
aLocale
;
}
void
CompositionEvent
:
:
GetRanges
(
TextClauseArray
&
aRanges
)
{
if
(
!
mRanges
.
IsEmpty
(
)
)
{
aRanges
=
mRanges
;
return
;
}
RefPtr
<
TextRangeArray
>
textRangeArray
=
mEvent
-
>
AsCompositionEvent
(
)
-
>
mRanges
;
if
(
!
textRangeArray
)
{
return
;
}
nsCOMPtr
<
nsPIDOMWindowInner
>
window
=
do_QueryInterface
(
mOwner
)
;
const
TextRange
*
targetRange
=
textRangeArray
-
>
GetTargetClause
(
)
;
for
(
size_t
i
=
0
;
i
<
textRangeArray
-
>
Length
(
)
;
i
+
+
)
{
const
TextRange
&
range
=
textRangeArray
-
>
ElementAt
(
i
)
;
mRanges
.
AppendElement
(
new
TextClause
(
window
range
targetRange
)
)
;
}
aRanges
=
mRanges
;
}
}
}
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
already_AddRefed
<
CompositionEvent
>
NS_NewDOMCompositionEvent
(
EventTarget
*
aOwner
nsPresContext
*
aPresContext
WidgetCompositionEvent
*
aEvent
)
{
RefPtr
<
CompositionEvent
>
event
=
new
CompositionEvent
(
aOwner
aPresContext
aEvent
)
;
return
event
.
forget
(
)
;
}
