#
ifndef
mozilla_IMEStateManager_h_
#
define
mozilla_IMEStateManager_h_
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
dom
/
TabParent
.
h
"
#
include
"
nsIWidget
.
h
"
class
nsIContent
;
class
nsINode
;
class
nsPresContext
;
namespace
mozilla
{
class
EditorBase
;
class
EventDispatchingCallback
;
class
IMEContentObserver
;
class
TextCompositionArray
;
class
TextComposition
;
namespace
dom
{
class
Selection
;
}
class
IMEStateManager
{
typedef
dom
:
:
TabParent
TabParent
;
typedef
widget
:
:
IMEMessage
IMEMessage
;
typedef
widget
:
:
IMENotification
IMENotification
;
typedef
widget
:
:
IMEState
IMEState
;
typedef
widget
:
:
InputContext
InputContext
;
typedef
widget
:
:
InputContextAction
InputContextAction
;
public
:
static
void
Init
(
)
;
static
void
Shutdown
(
)
;
static
TabParent
*
GetActiveTabParent
(
)
{
if
(
sInstalledMenuKeyboardListener
)
{
return
nullptr
;
}
return
sActiveTabParent
.
get
(
)
;
}
static
bool
DoesTabParentHaveIMEFocus
(
const
TabParent
*
aTabParent
)
{
MOZ_ASSERT
(
aTabParent
)
;
return
sFocusedIMETabParent
=
=
aTabParent
;
}
static
void
OnTabParentDestroying
(
TabParent
*
aTabParent
)
;
static
void
WidgetDestroyed
(
nsIWidget
*
aWidget
)
;
static
nsIWidget
*
GetWidgetForActiveInputContext
(
)
{
return
sActiveInputContextWidget
;
}
static
void
SetInputContextForChildProcess
(
TabParent
*
aTabParent
const
InputContext
&
aInputContext
const
InputContextAction
&
aAction
)
;
static
void
StopIMEStateManagement
(
)
;
static
void
MaybeStartOffsetUpdatedInChild
(
nsIWidget
*
aWidget
uint32_t
aStartOffset
)
;
static
nsresult
OnDestroyPresContext
(
nsPresContext
*
aPresContext
)
;
static
nsresult
OnRemoveContent
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
)
;
static
nsresult
OnChangeFocus
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
InputContextAction
:
:
Cause
aCause
)
;
static
void
OnInstalledMenuKeyboardListener
(
bool
aInstalling
)
;
static
nsresult
GetFocusSelectionAndRoot
(
dom
:
:
Selection
*
*
aSel
nsIContent
*
*
aRoot
)
;
static
void
UpdateIMEState
(
const
IMEState
&
aNewIMEState
nsIContent
*
aContent
EditorBase
*
aEditorBase
)
;
static
bool
OnMouseButtonEventInEditor
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
WidgetMouseEvent
*
aMouseEvent
)
;
static
void
OnClickInEditor
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
const
WidgetMouseEvent
*
aMouseEvent
)
;
static
void
OnFocusInEditor
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
EditorBase
&
aEditorBase
)
;
static
void
OnEditorInitialized
(
EditorBase
&
aEditorBase
)
;
static
void
OnEditorDestroying
(
EditorBase
&
aEditorBase
)
;
static
void
DispatchCompositionEvent
(
nsINode
*
aEventTargetNode
nsPresContext
*
aPresContext
WidgetCompositionEvent
*
aCompositionEvent
nsEventStatus
*
aStatus
EventDispatchingCallback
*
aCallBack
bool
aIsSynthesized
=
false
)
;
static
void
HandleSelectionEvent
(
nsPresContext
*
aPresContext
nsIContent
*
aEventTargetContent
WidgetSelectionEvent
*
aSelectionEvent
)
;
static
void
OnCompositionEventDiscarded
(
WidgetCompositionEvent
*
aCompositionEvent
)
;
static
already_AddRefed
<
TextComposition
>
GetTextCompositionFor
(
nsIWidget
*
aWidget
)
;
static
already_AddRefed
<
TextComposition
>
GetTextCompositionFor
(
const
WidgetCompositionEvent
*
aCompositionEvent
)
;
static
already_AddRefed
<
TextComposition
>
GetTextCompositionFor
(
nsPresContext
*
aPresContext
)
;
static
nsresult
NotifyIME
(
const
IMENotification
&
aNotification
nsIWidget
*
aWidget
TabParent
*
aTabParent
=
nullptr
)
;
static
nsresult
NotifyIME
(
IMEMessage
aMessage
nsIWidget
*
aWidget
TabParent
*
aTabParent
=
nullptr
)
;
static
nsresult
NotifyIME
(
IMEMessage
aMessage
nsPresContext
*
aPresContext
TabParent
*
aTabParent
=
nullptr
)
;
static
nsINode
*
GetRootEditableNode
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
)
;
static
IMEContentObserver
*
GetActiveContentObserver
(
)
;
protected
:
static
nsresult
OnChangeFocusInternal
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
InputContextAction
aAction
)
;
static
void
SetIMEState
(
const
IMEState
&
aState
nsPresContext
*
aPresContext
nsIContent
*
aContent
nsIWidget
*
aWidget
InputContextAction
aAction
InputContext
:
:
Origin
aOrigin
)
;
static
void
SetInputContext
(
nsIWidget
*
aWidget
const
InputContext
&
aInputContext
const
InputContextAction
&
aAction
)
;
static
IMEState
GetNewIMEState
(
nsPresContext
*
aPresContext
nsIContent
*
aContent
)
;
static
void
EnsureTextCompositionArray
(
)
;
static
void
CreateIMEContentObserver
(
EditorBase
*
aEditorBase
)
;
static
void
DestroyIMEContentObserver
(
)
;
static
void
NotifyIMEOfBlurForChildProcess
(
)
;
static
bool
IsEditable
(
nsINode
*
node
)
;
static
bool
IsIMEObserverNeeded
(
const
IMEState
&
aState
)
;
static
nsIContent
*
GetRootContent
(
nsPresContext
*
aPresContext
)
;
static
bool
CanHandleWith
(
nsPresContext
*
aPresContext
)
;
static
void
ResetActiveChildInputContext
(
)
;
static
bool
HasActiveChildSetInputContext
(
)
;
static
StaticRefPtr
<
nsIContent
>
sContent
;
static
StaticRefPtr
<
nsPresContext
>
sPresContext
;
static
nsIWidget
*
sWidget
;
static
nsIWidget
*
sFocusedIMEWidget
;
static
StaticRefPtr
<
TabParent
>
sFocusedIMETabParent
;
static
nsIWidget
*
sActiveInputContextWidget
;
static
StaticRefPtr
<
TabParent
>
sActiveTabParent
;
static
StaticRefPtr
<
IMEContentObserver
>
sActiveIMEContentObserver
;
static
TextCompositionArray
*
sTextCompositions
;
static
InputContext
:
:
Origin
sOrigin
;
static
InputContext
sActiveChildInputContext
;
static
bool
sInstalledMenuKeyboardListener
;
static
bool
sIsGettingNewIMEState
;
static
bool
sCheckForIMEUnawareWebApps
;
static
bool
sInputModeSupported
;
class
MOZ_STACK_CLASS
GettingNewIMEStateBlocker
final
{
public
:
GettingNewIMEStateBlocker
(
)
:
mOldValue
(
IMEStateManager
:
:
sIsGettingNewIMEState
)
{
IMEStateManager
:
:
sIsGettingNewIMEState
=
true
;
}
~
GettingNewIMEStateBlocker
(
)
{
IMEStateManager
:
:
sIsGettingNewIMEState
=
mOldValue
;
}
private
:
bool
mOldValue
;
}
;
}
;
}
#
endif
