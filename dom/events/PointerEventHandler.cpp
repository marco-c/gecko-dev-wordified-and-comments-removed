#
include
"
PointerEventHandler
.
h
"
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
nsIContentInlines
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
PointerEvent
.
h
"
#
include
"
PointerLockManager
.
h
"
#
include
"
nsRFPService
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
mozilla
/
dom
/
BrowserChild
.
h
"
#
include
"
mozilla
/
dom
/
BrowserParent
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
DocumentInlines
.
h
"
#
include
"
mozilla
/
dom
/
MouseEventBinding
.
h
"
#
include
"
nsUserCharacteristics
.
h
"
namespace
mozilla
{
using
namespace
dom
;
Maybe
<
int32_t
>
PointerEventHandler
:
:
sSpoofedPointerId
;
static
nsClassHashtable
<
nsUint32HashKey
PointerCaptureInfo
>
*
sPointerCaptureList
;
static
nsClassHashtable
<
nsUint32HashKey
PointerInfo
>
*
sActivePointersIds
;
static
nsTHashMap
<
nsUint32HashKey
BrowserParent
*
>
*
sPointerCaptureRemoteTargetTable
=
nullptr
;
void
PointerEventHandler
:
:
InitializeStatics
(
)
{
MOZ_ASSERT
(
!
sPointerCaptureList
"
InitializeStatics
called
multiple
times
!
"
)
;
sPointerCaptureList
=
new
nsClassHashtable
<
nsUint32HashKey
PointerCaptureInfo
>
;
sActivePointersIds
=
new
nsClassHashtable
<
nsUint32HashKey
PointerInfo
>
;
if
(
XRE_IsParentProcess
(
)
)
{
sPointerCaptureRemoteTargetTable
=
new
nsTHashMap
<
nsUint32HashKey
BrowserParent
*
>
;
}
}
void
PointerEventHandler
:
:
ReleaseStatics
(
)
{
MOZ_ASSERT
(
sPointerCaptureList
"
ReleaseStatics
called
without
Initialize
!
"
)
;
delete
sPointerCaptureList
;
sPointerCaptureList
=
nullptr
;
delete
sActivePointersIds
;
sActivePointersIds
=
nullptr
;
if
(
sPointerCaptureRemoteTargetTable
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
delete
sPointerCaptureRemoteTargetTable
;
sPointerCaptureRemoteTargetTable
=
nullptr
;
}
}
bool
PointerEventHandler
:
:
IsPointerEventImplicitCaptureForTouchEnabled
(
)
{
return
StaticPrefs
:
:
dom_w3c_pointer_events_implicit_capture
(
)
;
}
void
PointerEventHandler
:
:
UpdateActivePointerState
(
WidgetMouseEvent
*
aEvent
nsIContent
*
aTargetContent
)
{
if
(
!
aEvent
)
{
return
;
}
switch
(
aEvent
-
>
mMessage
)
{
case
eMouseEnterIntoWidget
:
sActivePointersIds
-
>
InsertOrUpdate
(
aEvent
-
>
pointerId
MakeUnique
<
PointerInfo
>
(
false
aEvent
-
>
mInputSource
true
false
nullptr
)
)
;
MaybeCacheSpoofedPointerID
(
aEvent
-
>
mInputSource
aEvent
-
>
pointerId
)
;
break
;
case
ePointerDown
:
if
(
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
)
{
sActivePointersIds
-
>
InsertOrUpdate
(
pointerEvent
-
>
pointerId
MakeUnique
<
PointerInfo
>
(
true
pointerEvent
-
>
mInputSource
pointerEvent
-
>
mIsPrimary
pointerEvent
-
>
mFromTouchEvent
aTargetContent
?
aTargetContent
-
>
OwnerDoc
(
)
:
nullptr
)
)
;
MaybeCacheSpoofedPointerID
(
pointerEvent
-
>
mInputSource
pointerEvent
-
>
pointerId
)
;
}
break
;
case
ePointerCancel
:
case
ePointerUp
:
if
(
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
)
{
if
(
pointerEvent
-
>
mInputSource
!
=
MouseEvent_Binding
:
:
MOZ_SOURCE_TOUCH
)
{
sActivePointersIds
-
>
InsertOrUpdate
(
pointerEvent
-
>
pointerId
MakeUnique
<
PointerInfo
>
(
false
pointerEvent
-
>
mInputSource
pointerEvent
-
>
mIsPrimary
pointerEvent
-
>
mFromTouchEvent
nullptr
)
)
;
}
else
{
sActivePointersIds
-
>
Remove
(
pointerEvent
-
>
pointerId
)
;
}
}
break
;
case
eMouseExitFromWidget
:
sActivePointersIds
-
>
Remove
(
aEvent
-
>
pointerId
)
;
break
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
event
has
invalid
type
"
)
;
break
;
}
}
void
PointerEventHandler
:
:
RequestPointerCaptureById
(
uint32_t
aPointerId
Element
*
aElement
)
{
SetPointerCaptureById
(
aPointerId
aElement
)
;
if
(
BrowserChild
*
browserChild
=
BrowserChild
:
:
GetFrom
(
aElement
-
>
OwnerDoc
(
)
-
>
GetDocShell
(
)
)
)
{
browserChild
-
>
SendRequestPointerCapture
(
aPointerId
[
aPointerId
]
(
bool
aSuccess
)
{
if
(
!
aSuccess
)
{
PointerEventHandler
:
:
ReleasePointerCaptureById
(
aPointerId
)
;
}
}
[
]
(
mozilla
:
:
ipc
:
:
ResponseRejectReason
)
{
}
)
;
}
}
void
PointerEventHandler
:
:
SetPointerCaptureById
(
uint32_t
aPointerId
Element
*
aElement
)
{
MOZ_ASSERT
(
aElement
)
;
sPointerCaptureList
-
>
WithEntryHandle
(
aPointerId
[
&
]
(
auto
&
&
entry
)
{
if
(
entry
)
{
entry
.
Data
(
)
-
>
mPendingElement
=
aElement
;
}
else
{
entry
.
Insert
(
MakeUnique
<
PointerCaptureInfo
>
(
aElement
)
)
;
}
}
)
;
}
PointerCaptureInfo
*
PointerEventHandler
:
:
GetPointerCaptureInfo
(
uint32_t
aPointerId
)
{
PointerCaptureInfo
*
pointerCaptureInfo
=
nullptr
;
sPointerCaptureList
-
>
Get
(
aPointerId
&
pointerCaptureInfo
)
;
return
pointerCaptureInfo
;
}
void
PointerEventHandler
:
:
ReleasePointerCaptureById
(
uint32_t
aPointerId
)
{
PointerCaptureInfo
*
pointerCaptureInfo
=
GetPointerCaptureInfo
(
aPointerId
)
;
if
(
pointerCaptureInfo
)
{
if
(
Element
*
pendingElement
=
pointerCaptureInfo
-
>
mPendingElement
)
{
if
(
BrowserChild
*
browserChild
=
BrowserChild
:
:
GetFrom
(
pendingElement
-
>
OwnerDoc
(
)
-
>
GetDocShell
(
)
)
)
{
browserChild
-
>
SendReleasePointerCapture
(
aPointerId
)
;
}
}
pointerCaptureInfo
-
>
mPendingElement
=
nullptr
;
}
}
void
PointerEventHandler
:
:
ReleaseAllPointerCapture
(
)
{
for
(
const
auto
&
entry
:
*
sPointerCaptureList
)
{
PointerCaptureInfo
*
data
=
entry
.
GetWeak
(
)
;
if
(
data
&
&
data
-
>
mPendingElement
)
{
ReleasePointerCaptureById
(
entry
.
GetKey
(
)
)
;
}
}
}
bool
PointerEventHandler
:
:
SetPointerCaptureRemoteTarget
(
uint32_t
aPointerId
dom
:
:
BrowserParent
*
aBrowserParent
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
MOZ_ASSERT
(
aBrowserParent
)
;
if
(
PointerLockManager
:
:
GetLockedRemoteTarget
(
)
)
{
return
false
;
}
BrowserParent
*
currentRemoteTarget
=
PointerEventHandler
:
:
GetPointerCapturingRemoteTarget
(
aPointerId
)
;
if
(
currentRemoteTarget
&
&
currentRemoteTarget
!
=
aBrowserParent
)
{
return
false
;
}
sPointerCaptureRemoteTargetTable
-
>
InsertOrUpdate
(
aPointerId
aBrowserParent
)
;
return
true
;
}
void
PointerEventHandler
:
:
ReleasePointerCaptureRemoteTarget
(
BrowserParent
*
aBrowserParent
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
MOZ_ASSERT
(
aBrowserParent
)
;
sPointerCaptureRemoteTargetTable
-
>
RemoveIf
(
[
aBrowserParent
]
(
const
auto
&
iter
)
{
BrowserParent
*
browserParent
=
iter
.
Data
(
)
;
MOZ_ASSERT
(
browserParent
"
Null
BrowserParent
in
pointer
captured
table
?
"
)
;
return
aBrowserParent
=
=
browserParent
;
}
)
;
}
void
PointerEventHandler
:
:
ReleasePointerCaptureRemoteTarget
(
uint32_t
aPointerId
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
sPointerCaptureRemoteTargetTable
-
>
Remove
(
aPointerId
)
;
}
BrowserParent
*
PointerEventHandler
:
:
GetPointerCapturingRemoteTarget
(
uint32_t
aPointerId
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
return
sPointerCaptureRemoteTargetTable
-
>
Get
(
aPointerId
)
;
}
void
PointerEventHandler
:
:
ReleaseAllPointerCaptureRemoteTarget
(
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
for
(
auto
iter
=
sPointerCaptureRemoteTargetTable
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
BrowserParent
*
browserParent
=
iter
.
Data
(
)
;
MOZ_ASSERT
(
browserParent
"
Null
BrowserParent
in
pointer
captured
table
?
"
)
;
Unused
<
<
browserParent
-
>
SendReleaseAllPointerCapture
(
)
;
iter
.
Remove
(
)
;
}
}
const
PointerInfo
*
PointerEventHandler
:
:
GetPointerInfo
(
uint32_t
aPointerId
)
{
return
sActivePointersIds
-
>
Get
(
aPointerId
)
;
}
void
PointerEventHandler
:
:
MaybeProcessPointerCapture
(
WidgetGUIEvent
*
aEvent
)
{
switch
(
aEvent
-
>
mClass
)
{
case
eMouseEventClass
:
ProcessPointerCaptureForMouse
(
aEvent
-
>
AsMouseEvent
(
)
)
;
break
;
case
eTouchEventClass
:
ProcessPointerCaptureForTouch
(
aEvent
-
>
AsTouchEvent
(
)
)
;
break
;
default
:
break
;
}
}
void
PointerEventHandler
:
:
ProcessPointerCaptureForMouse
(
WidgetMouseEvent
*
aEvent
)
{
if
(
!
ShouldGeneratePointerEventFromMouse
(
aEvent
)
)
{
return
;
}
PointerCaptureInfo
*
info
=
GetPointerCaptureInfo
(
aEvent
-
>
pointerId
)
;
if
(
!
info
|
|
info
-
>
mPendingElement
=
=
info
-
>
mOverrideElement
)
{
return
;
}
WidgetPointerEvent
localEvent
(
*
aEvent
)
;
InitPointerEventFromMouse
(
&
localEvent
aEvent
eVoidEvent
)
;
CheckPointerCaptureState
(
&
localEvent
)
;
}
void
PointerEventHandler
:
:
ProcessPointerCaptureForTouch
(
WidgetTouchEvent
*
aEvent
)
{
if
(
!
ShouldGeneratePointerEventFromTouch
(
aEvent
)
)
{
return
;
}
for
(
uint32_t
i
=
0
;
i
<
aEvent
-
>
mTouches
.
Length
(
)
;
+
+
i
)
{
Touch
*
touch
=
aEvent
-
>
mTouches
[
i
]
;
if
(
!
TouchManager
:
:
ShouldConvertTouchToPointer
(
touch
aEvent
)
)
{
continue
;
}
PointerCaptureInfo
*
info
=
GetPointerCaptureInfo
(
touch
-
>
Identifier
(
)
)
;
if
(
!
info
|
|
info
-
>
mPendingElement
=
=
info
-
>
mOverrideElement
)
{
continue
;
}
WidgetPointerEvent
event
(
aEvent
-
>
IsTrusted
(
)
eVoidEvent
aEvent
-
>
mWidget
)
;
InitPointerEventFromTouch
(
event
*
aEvent
*
touch
)
;
CheckPointerCaptureState
(
&
event
)
;
}
}
void
PointerEventHandler
:
:
CheckPointerCaptureState
(
WidgetPointerEvent
*
aEvent
)
{
if
(
!
aEvent
)
{
return
;
}
MOZ_ASSERT
(
aEvent
-
>
mClass
=
=
ePointerEventClass
)
;
PointerCaptureInfo
*
captureInfo
=
GetPointerCaptureInfo
(
aEvent
-
>
pointerId
)
;
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
"
Efficiency
Check
"
RFPTarget
:
:
PointerEvents
)
&
&
aEvent
-
>
pointerId
!
=
(
uint32_t
)
GetSpoofedPointerIdForRFP
(
)
&
&
!
captureInfo
)
{
PointerCaptureInfo
*
spoofedCaptureInfo
=
GetPointerCaptureInfo
(
GetSpoofedPointerIdForRFP
(
)
)
;
if
(
!
spoofedCaptureInfo
|
|
!
spoofedCaptureInfo
-
>
mPendingElement
|
|
!
spoofedCaptureInfo
-
>
mPendingElement
-
>
OwnerDoc
(
)
-
>
ShouldResistFingerprinting
(
RFPTarget
:
:
PointerEvents
)
)
{
return
;
}
captureInfo
=
spoofedCaptureInfo
;
}
if
(
!
captureInfo
|
|
captureInfo
-
>
mPendingElement
=
=
captureInfo
-
>
mOverrideElement
)
{
return
;
}
RefPtr
<
Element
>
overrideElement
=
captureInfo
-
>
mOverrideElement
;
RefPtr
<
Element
>
pendingElement
=
captureInfo
-
>
mPendingElement
;
captureInfo
-
>
mOverrideElement
=
captureInfo
-
>
mPendingElement
;
if
(
captureInfo
-
>
Empty
(
)
)
{
sPointerCaptureList
-
>
Remove
(
aEvent
-
>
pointerId
)
;
}
if
(
overrideElement
)
{
DispatchGotOrLostPointerCaptureEvent
(
false
aEvent
overrideElement
)
;
}
if
(
pendingElement
)
{
DispatchGotOrLostPointerCaptureEvent
(
true
aEvent
pendingElement
)
;
}
if
(
overrideElement
&
&
!
pendingElement
&
&
aEvent
-
>
mWidget
&
&
aEvent
-
>
mMessage
!
=
ePointerCancel
&
&
(
aEvent
-
>
mMessage
!
=
ePointerUp
|
|
aEvent
-
>
InputSourceSupportsHover
(
)
)
)
{
aEvent
-
>
mSynthesizeMoveAfterDispatch
=
true
;
}
}
void
PointerEventHandler
:
:
SynthesizeMoveToDispatchBoundaryEvents
(
const
WidgetMouseEvent
*
aEvent
)
{
nsCOMPtr
<
nsIWidget
>
widget
=
aEvent
-
>
mWidget
;
if
(
NS_WARN_IF
(
!
widget
)
)
{
return
;
}
Maybe
<
WidgetMouseEvent
>
mouseMoveEvent
;
Maybe
<
WidgetPointerEvent
>
pointerMoveEvent
;
if
(
aEvent
-
>
mClass
=
=
eMouseEventClass
)
{
mouseMoveEvent
.
emplace
(
true
eMouseMove
aEvent
-
>
mWidget
WidgetMouseEvent
:
:
eSynthesized
)
;
}
else
if
(
aEvent
-
>
mClass
=
=
ePointerEventClass
)
{
pointerMoveEvent
.
emplace
(
true
ePointerMove
aEvent
-
>
mWidget
)
;
pointerMoveEvent
-
>
mReason
=
WidgetMouseEvent
:
:
eSynthesized
;
const
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
;
MOZ_ASSERT
(
pointerEvent
)
;
pointerMoveEvent
-
>
mIsPrimary
=
pointerEvent
-
>
mIsPrimary
;
pointerMoveEvent
-
>
mFromTouchEvent
=
pointerEvent
-
>
mFromTouchEvent
;
pointerMoveEvent
-
>
mWidth
=
pointerEvent
-
>
mWidth
;
pointerMoveEvent
-
>
mHeight
=
pointerEvent
-
>
mHeight
;
}
else
{
MOZ_ASSERT_UNREACHABLE
(
"
The
event
must
be
WidgetMouseEvent
or
WidgetPointerEvent
"
)
;
}
WidgetMouseEvent
&
event
=
mouseMoveEvent
?
mouseMoveEvent
.
ref
(
)
:
pointerMoveEvent
.
ref
(
)
;
event
.
mFlags
.
mIsSynthesizedForTests
=
aEvent
-
>
mFlags
.
mIsSynthesizedForTests
;
event
.
mIgnoreCapturingContent
=
true
;
event
.
mRefPoint
=
aEvent
-
>
mRefPoint
;
event
.
mInputSource
=
aEvent
-
>
mInputSource
;
event
.
mButtons
=
aEvent
-
>
mButtons
;
event
.
mModifiers
=
aEvent
-
>
mModifiers
;
event
.
convertToPointer
=
false
;
event
.
AssignPointerHelperData
(
*
aEvent
)
;
nsEventStatus
eventStatus
=
nsEventStatus_eIgnore
;
widget
-
>
DispatchEvent
(
&
event
eventStatus
)
;
}
void
PointerEventHandler
:
:
ImplicitlyCapturePointer
(
nsIFrame
*
aFrame
WidgetEvent
*
aEvent
)
{
MOZ_ASSERT
(
aEvent
-
>
mMessage
=
=
ePointerDown
)
;
if
(
!
aFrame
|
|
!
IsPointerEventImplicitCaptureForTouchEnabled
(
)
)
{
return
;
}
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
;
NS_WARNING_ASSERTION
(
pointerEvent
"
Call
ImplicitlyCapturePointer
with
non
-
pointer
event
"
)
;
if
(
!
pointerEvent
-
>
mFromTouchEvent
)
{
return
;
}
nsCOMPtr
<
nsIContent
>
target
;
aFrame
-
>
GetContentForEvent
(
aEvent
getter_AddRefs
(
target
)
)
;
while
(
target
&
&
!
target
-
>
IsElement
(
)
)
{
target
=
target
-
>
GetParent
(
)
;
}
if
(
NS_WARN_IF
(
!
target
)
)
{
return
;
}
RequestPointerCaptureById
(
pointerEvent
-
>
pointerId
target
-
>
AsElement
(
)
)
;
}
void
PointerEventHandler
:
:
ImplicitlyReleasePointerCapture
(
WidgetEvent
*
aEvent
)
{
MOZ_ASSERT
(
aEvent
)
;
if
(
aEvent
-
>
mMessage
!
=
ePointerUp
&
&
aEvent
-
>
mMessage
!
=
ePointerCancel
)
{
return
;
}
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
;
ReleasePointerCaptureById
(
pointerEvent
-
>
pointerId
)
;
CheckPointerCaptureState
(
pointerEvent
)
;
}
void
PointerEventHandler
:
:
MaybeImplicitlyReleasePointerCapture
(
WidgetGUIEvent
*
aEvent
)
{
MOZ_ASSERT
(
aEvent
)
;
const
EventMessage
pointerEventMessage
=
PointerEventHandler
:
:
ToPointerEventMessage
(
aEvent
)
;
if
(
pointerEventMessage
!
=
ePointerUp
&
&
pointerEventMessage
!
=
ePointerCancel
)
{
return
;
}
PointerEventHandler
:
:
MaybeProcessPointerCapture
(
aEvent
)
;
}
Element
*
PointerEventHandler
:
:
GetPointerCapturingElement
(
uint32_t
aPointerId
)
{
PointerCaptureInfo
*
pointerCaptureInfo
=
GetPointerCaptureInfo
(
aPointerId
)
;
if
(
pointerCaptureInfo
)
{
return
pointerCaptureInfo
-
>
mOverrideElement
;
}
return
nullptr
;
}
Element
*
PointerEventHandler
:
:
GetPointerCapturingElement
(
WidgetGUIEvent
*
aEvent
)
{
if
(
(
aEvent
-
>
mClass
!
=
ePointerEventClass
&
&
aEvent
-
>
mClass
!
=
eMouseEventClass
)
|
|
aEvent
-
>
mMessage
=
=
ePointerDown
|
|
aEvent
-
>
mMessage
=
=
eMouseDown
)
{
return
nullptr
;
}
if
(
aEvent
-
>
ShouldIgnoreCapturingContent
(
)
)
{
return
nullptr
;
}
WidgetMouseEvent
*
mouseEvent
=
aEvent
-
>
AsMouseEvent
(
)
;
if
(
!
mouseEvent
)
{
return
nullptr
;
}
return
GetPointerCapturingElement
(
mouseEvent
-
>
pointerId
)
;
}
void
PointerEventHandler
:
:
ReleaseIfCaptureByDescendant
(
nsIContent
*
aContent
)
{
if
(
!
sPointerCaptureList
-
>
IsEmpty
(
)
)
{
for
(
const
auto
&
entry
:
*
sPointerCaptureList
)
{
PointerCaptureInfo
*
data
=
entry
.
GetWeak
(
)
;
if
(
data
&
&
data
-
>
mPendingElement
&
&
data
-
>
mPendingElement
-
>
IsInclusiveDescendantOf
(
aContent
)
)
{
ReleasePointerCaptureById
(
entry
.
GetKey
(
)
)
;
}
}
}
}
void
PointerEventHandler
:
:
PreHandlePointerEventsPreventDefault
(
WidgetPointerEvent
*
aPointerEvent
WidgetGUIEvent
*
aMouseOrTouchEvent
)
{
if
(
!
aPointerEvent
-
>
mIsPrimary
|
|
aPointerEvent
-
>
mMessage
=
=
ePointerDown
)
{
return
;
}
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
!
sActivePointersIds
-
>
Get
(
aPointerEvent
-
>
pointerId
&
pointerInfo
)
|
|
!
pointerInfo
)
{
return
;
}
if
(
!
pointerInfo
-
>
mPreventMouseEventByContent
)
{
return
;
}
aMouseOrTouchEvent
-
>
PreventDefault
(
false
)
;
aMouseOrTouchEvent
-
>
mFlags
.
mOnlyChromeDispatch
=
true
;
if
(
aPointerEvent
-
>
mMessage
=
=
ePointerUp
)
{
pointerInfo
-
>
mPreventMouseEventByContent
=
false
;
}
}
void
PointerEventHandler
:
:
PostHandlePointerEventsPreventDefault
(
WidgetPointerEvent
*
aPointerEvent
WidgetGUIEvent
*
aMouseOrTouchEvent
)
{
if
(
!
aPointerEvent
-
>
mIsPrimary
|
|
aPointerEvent
-
>
mMessage
!
=
ePointerDown
|
|
!
aPointerEvent
-
>
DefaultPreventedByContent
(
)
)
{
return
;
}
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
!
sActivePointersIds
-
>
Get
(
aPointerEvent
-
>
pointerId
&
pointerInfo
)
|
|
!
pointerInfo
)
{
#
ifdef
DEBUG
MOZ_CRASH
(
"
Got
ePointerDown
w
/
o
active
pointer
info
!
!
"
)
;
#
endif
return
;
}
if
(
!
pointerInfo
-
>
mActiveState
)
{
return
;
}
aMouseOrTouchEvent
-
>
PreventDefault
(
false
)
;
aMouseOrTouchEvent
-
>
mFlags
.
mOnlyChromeDispatch
=
true
;
pointerInfo
-
>
mPreventMouseEventByContent
=
true
;
}
void
PointerEventHandler
:
:
InitPointerEventFromMouse
(
WidgetPointerEvent
*
aPointerEvent
WidgetMouseEvent
*
aMouseEvent
EventMessage
aMessage
)
{
MOZ_ASSERT
(
aPointerEvent
)
;
MOZ_ASSERT
(
aMouseEvent
)
;
aPointerEvent
-
>
pointerId
=
aMouseEvent
-
>
pointerId
;
aPointerEvent
-
>
mInputSource
=
aMouseEvent
-
>
mInputSource
;
aPointerEvent
-
>
mMessage
=
aMessage
;
aPointerEvent
-
>
mButton
=
aMouseEvent
-
>
mMessage
=
=
eMouseMove
?
MouseButton
:
:
eNotPressed
:
aMouseEvent
-
>
mButton
;
aPointerEvent
-
>
mButtons
=
aMouseEvent
-
>
mButtons
;
aPointerEvent
-
>
mPressure
=
aPointerEvent
-
>
mButtons
?
aMouseEvent
-
>
mPressure
?
aMouseEvent
-
>
mPressure
:
0
.
5f
:
0
.
0f
;
}
void
PointerEventHandler
:
:
InitPointerEventFromTouch
(
WidgetPointerEvent
&
aPointerEvent
const
WidgetTouchEvent
&
aTouchEvent
const
mozilla
:
:
dom
:
:
Touch
&
aTouch
)
{
int16_t
button
=
aTouchEvent
.
mMessage
=
=
eTouchMove
?
MouseButton
:
:
eNotPressed
:
aTouchEvent
.
mButton
!
=
MouseButton
:
:
eNotPressed
?
aTouchEvent
.
mButton
:
MouseButton
:
:
ePrimary
;
int16_t
buttons
=
aTouchEvent
.
mMessage
=
=
eTouchEnd
?
MouseButtonsFlag
:
:
eNoButtons
:
aTouchEvent
.
mButton
!
=
MouseButton
:
:
eNotPressed
?
aTouchEvent
.
mButtons
:
MouseButtonsFlag
:
:
ePrimaryFlag
;
if
(
aTouchEvent
.
mInputSource
=
=
MouseEvent_Binding
:
:
MOZ_SOURCE_TOUCH
)
{
aPointerEvent
.
mIsPrimary
=
aTouchEvent
.
mMessage
=
=
eTouchStart
?
!
HasActiveTouchPointer
(
)
:
GetPointerPrimaryState
(
aTouch
.
Identifier
(
)
)
;
}
aPointerEvent
.
pointerId
=
aTouch
.
Identifier
(
)
;
aPointerEvent
.
mRefPoint
=
aTouch
.
mRefPoint
;
aPointerEvent
.
mModifiers
=
aTouchEvent
.
mModifiers
;
aPointerEvent
.
mWidth
=
aTouch
.
RadiusX
(
CallerType
:
:
System
)
;
aPointerEvent
.
mHeight
=
aTouch
.
RadiusY
(
CallerType
:
:
System
)
;
aPointerEvent
.
tiltX
=
aTouch
.
tiltX
;
aPointerEvent
.
tiltY
=
aTouch
.
tiltY
;
aPointerEvent
.
twist
=
aTouch
.
twist
;
aPointerEvent
.
mTimeStamp
=
aTouchEvent
.
mTimeStamp
;
aPointerEvent
.
mFlags
=
aTouchEvent
.
mFlags
;
aPointerEvent
.
mButton
=
button
;
aPointerEvent
.
mButtons
=
buttons
;
aPointerEvent
.
mInputSource
=
aTouchEvent
.
mInputSource
;
aPointerEvent
.
mFromTouchEvent
=
true
;
aPointerEvent
.
mPressure
=
aTouch
.
mForce
;
}
void
PointerEventHandler
:
:
InitCoalescedEventFromPointerEvent
(
WidgetPointerEvent
&
aCoalescedEvent
const
WidgetPointerEvent
&
aSourceEvent
)
{
aCoalescedEvent
.
mFlags
.
mCancelable
=
false
;
aCoalescedEvent
.
mFlags
.
mBubbles
=
false
;
aCoalescedEvent
.
mTimeStamp
=
aSourceEvent
.
mTimeStamp
;
aCoalescedEvent
.
mRefPoint
=
aSourceEvent
.
mRefPoint
;
aCoalescedEvent
.
mModifiers
=
aSourceEvent
.
mModifiers
;
aCoalescedEvent
.
mButton
=
aSourceEvent
.
mButton
;
aCoalescedEvent
.
mButtons
=
aSourceEvent
.
mButtons
;
aCoalescedEvent
.
mPressure
=
aSourceEvent
.
mPressure
;
aCoalescedEvent
.
mInputSource
=
aSourceEvent
.
mInputSource
;
aCoalescedEvent
.
AssignPointerHelperData
(
aSourceEvent
)
;
aCoalescedEvent
.
mWidth
=
aSourceEvent
.
mWidth
;
aCoalescedEvent
.
mHeight
=
aSourceEvent
.
mHeight
;
aCoalescedEvent
.
mIsPrimary
=
aSourceEvent
.
mIsPrimary
;
aCoalescedEvent
.
mFromTouchEvent
=
aSourceEvent
.
mFromTouchEvent
;
}
EventMessage
PointerEventHandler
:
:
ToPointerEventMessage
(
const
WidgetGUIEvent
*
aMouseOrTouchEvent
)
{
MOZ_ASSERT
(
aMouseOrTouchEvent
)
;
switch
(
aMouseOrTouchEvent
-
>
mMessage
)
{
case
eMouseMove
:
return
ePointerMove
;
case
eMouseUp
:
return
aMouseOrTouchEvent
-
>
AsMouseEvent
(
)
-
>
mButtons
?
ePointerMove
:
ePointerUp
;
case
eMouseDown
:
{
const
WidgetMouseEvent
*
mouseEvent
=
aMouseOrTouchEvent
-
>
AsMouseEvent
(
)
;
return
mouseEvent
-
>
mButtons
&
~
nsContentUtils
:
:
GetButtonsFlagForButton
(
mouseEvent
-
>
mButton
)
?
ePointerMove
:
ePointerDown
;
}
case
eTouchMove
:
return
ePointerMove
;
case
eTouchEnd
:
return
ePointerUp
;
case
eTouchStart
:
return
ePointerDown
;
case
eTouchCancel
:
case
eTouchPointerCancel
:
return
ePointerCancel
;
default
:
return
eVoidEvent
;
}
}
void
PointerEventHandler
:
:
DispatchPointerFromMouseOrTouch
(
PresShell
*
aShell
nsIFrame
*
aEventTargetFrame
nsIContent
*
aEventTargetContent
WidgetGUIEvent
*
aMouseOrTouchEvent
bool
aDontRetargetEvents
nsEventStatus
*
aStatus
nsIContent
*
*
aMouseOrTouchEventTarget
)
{
MOZ_ASSERT
(
aEventTargetFrame
|
|
aEventTargetContent
)
;
MOZ_ASSERT
(
aMouseOrTouchEvent
)
;
EventMessage
pointerMessage
=
eVoidEvent
;
if
(
aMouseOrTouchEvent
-
>
mClass
=
=
eMouseEventClass
)
{
WidgetMouseEvent
*
mouseEvent
=
aMouseOrTouchEvent
-
>
AsMouseEvent
(
)
;
Document
*
doc
=
aShell
-
>
GetDocument
(
)
;
if
(
!
doc
)
{
return
;
}
BrowsingContext
*
bc
=
doc
-
>
GetBrowsingContext
(
)
;
if
(
bc
&
&
bc
-
>
TouchEventsOverride
(
)
=
=
TouchEventsOverride
:
:
Enabled
&
&
bc
-
>
InRDMPane
(
)
)
{
return
;
}
if
(
!
mouseEvent
-
>
convertToPointer
|
|
!
aMouseOrTouchEvent
-
>
IsAllowedToDispatchDOMEvent
(
)
)
{
return
;
}
pointerMessage
=
PointerEventHandler
:
:
ToPointerEventMessage
(
mouseEvent
)
;
if
(
pointerMessage
=
=
eVoidEvent
)
{
return
;
}
WidgetPointerEvent
event
(
*
mouseEvent
)
;
InitPointerEventFromMouse
(
&
event
mouseEvent
pointerMessage
)
;
event
.
convertToPointer
=
mouseEvent
-
>
convertToPointer
=
false
;
RefPtr
<
PresShell
>
shell
(
aShell
)
;
if
(
!
aEventTargetFrame
)
{
shell
=
PresShell
:
:
GetShellForEventTarget
(
nullptr
aEventTargetContent
)
;
if
(
!
shell
)
{
return
;
}
}
PreHandlePointerEventsPreventDefault
(
&
event
aMouseOrTouchEvent
)
;
shell
-
>
HandleEventWithTarget
(
&
event
aEventTargetFrame
aEventTargetContent
aStatus
true
aMouseOrTouchEventTarget
)
;
PostHandlePointerEventsPreventDefault
(
&
event
aMouseOrTouchEvent
)
;
mouseEvent
-
>
mSynthesizeMoveAfterDispatch
|
=
event
.
mSynthesizeMoveAfterDispatch
;
}
else
if
(
aMouseOrTouchEvent
-
>
mClass
=
=
eTouchEventClass
)
{
WidgetTouchEvent
*
touchEvent
=
aMouseOrTouchEvent
-
>
AsTouchEvent
(
)
;
pointerMessage
=
PointerEventHandler
:
:
ToPointerEventMessage
(
touchEvent
)
;
if
(
pointerMessage
=
=
eVoidEvent
)
{
return
;
}
RefPtr
<
PresShell
>
shell
(
aShell
)
;
for
(
uint32_t
i
=
0
;
i
<
touchEvent
-
>
mTouches
.
Length
(
)
;
+
+
i
)
{
Touch
*
touch
=
touchEvent
-
>
mTouches
[
i
]
;
if
(
!
TouchManager
:
:
ShouldConvertTouchToPointer
(
touch
touchEvent
)
)
{
continue
;
}
WidgetPointerEvent
event
(
touchEvent
-
>
IsTrusted
(
)
pointerMessage
touchEvent
-
>
mWidget
)
;
InitPointerEventFromTouch
(
event
*
touchEvent
*
touch
)
;
event
.
convertToPointer
=
touch
-
>
convertToPointer
=
false
;
event
.
mCoalescedWidgetEvents
=
touch
-
>
mCoalescedWidgetEvents
;
if
(
aMouseOrTouchEvent
-
>
mMessage
=
=
eTouchStart
)
{
nsCOMPtr
<
nsIContent
>
content
=
nsIContent
:
:
FromEventTargetOrNull
(
touch
-
>
mTarget
)
;
if
(
!
content
)
{
continue
;
}
nsIFrame
*
frame
=
content
-
>
GetPrimaryFrame
(
)
;
shell
=
PresShell
:
:
GetShellForEventTarget
(
frame
content
)
;
if
(
!
shell
)
{
continue
;
}
PreHandlePointerEventsPreventDefault
(
&
event
aMouseOrTouchEvent
)
;
shell
-
>
HandleEventWithTarget
(
&
event
frame
content
aStatus
true
aMouseOrTouchEventTarget
)
;
PostHandlePointerEventsPreventDefault
(
&
event
aMouseOrTouchEvent
)
;
}
else
{
PreHandlePointerEventsPreventDefault
(
&
event
aMouseOrTouchEvent
)
;
shell
-
>
HandleEvent
(
aEventTargetFrame
&
event
aDontRetargetEvents
aStatus
)
;
PostHandlePointerEventsPreventDefault
(
&
event
aMouseOrTouchEvent
)
;
}
}
}
nsUserCharacteristics
:
:
StealPointerEvent
(
aMouseOrTouchEvent
)
;
}
void
PointerEventHandler
:
:
NotifyDestroyPresContext
(
nsPresContext
*
aPresContext
)
{
for
(
auto
iter
=
sPointerCaptureList
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
PointerCaptureInfo
*
data
=
iter
.
UserData
(
)
;
MOZ_ASSERT
(
data
"
how
could
we
have
a
null
PointerCaptureInfo
here
?
"
)
;
if
(
data
-
>
mPendingElement
&
&
data
-
>
mPendingElement
-
>
GetPresContext
(
Element
:
:
eForComposedDoc
)
=
=
aPresContext
)
{
data
-
>
mPendingElement
=
nullptr
;
}
if
(
data
-
>
mOverrideElement
&
&
data
-
>
mOverrideElement
-
>
GetPresContext
(
Element
:
:
eForComposedDoc
)
=
=
aPresContext
)
{
data
-
>
mOverrideElement
=
nullptr
;
}
if
(
data
-
>
Empty
(
)
)
{
iter
.
Remove
(
)
;
}
}
for
(
auto
iter
=
sActivePointersIds
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
PointerInfo
*
data
=
iter
.
UserData
(
)
;
MOZ_ASSERT
(
data
"
how
could
we
have
a
null
PointerInfo
here
?
"
)
;
if
(
data
-
>
mActiveDocument
&
&
data
-
>
mActiveDocument
-
>
GetPresContext
(
)
=
=
aPresContext
)
{
iter
.
Remove
(
)
;
}
}
}
bool
PointerEventHandler
:
:
IsDragAndDropEnabled
(
WidgetMouseEvent
&
aEvent
)
{
#
ifdef
XP_WIN
if
(
StaticPrefs
:
:
dom_w3c_pointer_events_dispatch_by_pointer_messages
(
)
)
{
return
(
aEvent
.
mInputSource
!
=
dom
:
:
MouseEvent_Binding
:
:
MOZ_SOURCE_PEN
&
&
aEvent
.
mReason
!
=
WidgetMouseEvent
:
:
eSynthesized
)
;
}
#
endif
return
true
;
}
uint16_t
PointerEventHandler
:
:
GetPointerType
(
uint32_t
aPointerId
)
{
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
sActivePointersIds
-
>
Get
(
aPointerId
&
pointerInfo
)
&
&
pointerInfo
)
{
return
pointerInfo
-
>
mPointerType
;
}
return
MouseEvent_Binding
:
:
MOZ_SOURCE_UNKNOWN
;
}
bool
PointerEventHandler
:
:
GetPointerPrimaryState
(
uint32_t
aPointerId
)
{
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
sActivePointersIds
-
>
Get
(
aPointerId
&
pointerInfo
)
&
&
pointerInfo
)
{
return
pointerInfo
-
>
mPrimaryState
;
}
return
false
;
}
bool
PointerEventHandler
:
:
HasActiveTouchPointer
(
)
{
for
(
auto
iter
=
sActivePointersIds
-
>
ConstIter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
if
(
iter
.
Data
(
)
-
>
mFromTouchEvent
)
{
return
true
;
}
}
return
false
;
}
void
PointerEventHandler
:
:
DispatchGotOrLostPointerCaptureEvent
(
bool
aIsGotCapture
const
WidgetPointerEvent
*
aPointerEvent
Element
*
aCaptureTarget
)
{
Document
*
targetDoc
=
aCaptureTarget
-
>
OwnerDoc
(
)
;
RefPtr
<
PresShell
>
presShell
=
targetDoc
-
>
GetPresShell
(
)
;
if
(
NS_WARN_IF
(
!
presShell
|
|
presShell
-
>
IsDestroying
(
)
)
)
{
return
;
}
if
(
!
aIsGotCapture
&
&
!
aCaptureTarget
-
>
IsInComposedDoc
(
)
)
{
PointerEventInit
init
;
init
.
mPointerId
=
aPointerEvent
-
>
pointerId
;
init
.
mBubbles
=
true
;
init
.
mComposed
=
true
;
ConvertPointerTypeToString
(
aPointerEvent
-
>
mInputSource
init
.
mPointerType
)
;
init
.
mIsPrimary
=
aPointerEvent
-
>
mIsPrimary
;
RefPtr
<
PointerEvent
>
event
;
event
=
PointerEvent
:
:
Constructor
(
aCaptureTarget
u
"
lostpointercapture
"
_ns
init
)
;
targetDoc
-
>
DispatchEvent
(
*
event
)
;
return
;
}
nsEventStatus
status
=
nsEventStatus_eIgnore
;
WidgetPointerEvent
localEvent
(
aPointerEvent
-
>
IsTrusted
(
)
aIsGotCapture
?
ePointerGotCapture
:
ePointerLostCapture
aPointerEvent
-
>
mWidget
)
;
localEvent
.
AssignPointerEventData
(
*
aPointerEvent
true
)
;
DebugOnly
<
nsresult
>
rv
=
presShell
-
>
HandleEventWithTarget
(
&
localEvent
aCaptureTarget
-
>
GetPrimaryFrame
(
)
aCaptureTarget
&
status
)
;
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
DispatchGotOrLostPointerCaptureEvent
failed
"
)
;
}
void
PointerEventHandler
:
:
MaybeCacheSpoofedPointerID
(
uint16_t
aInputSource
uint32_t
aPointerId
)
{
if
(
sSpoofedPointerId
.
isSome
(
)
|
|
aInputSource
!
=
SPOOFED_POINTER_INTERFACE
)
{
return
;
}
sSpoofedPointerId
.
emplace
(
aPointerId
)
;
}
}
