#
include
"
PointerEventHandler
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
PointerEvent
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
mozilla
/
dom
/
BrowserChild
.
h
"
#
include
"
mozilla
/
dom
/
BrowserParent
.
h
"
#
include
"
mozilla
/
dom
/
MouseEventBinding
.
h
"
namespace
mozilla
{
using
namespace
dom
;
Maybe
<
int32_t
>
PointerEventHandler
:
:
sSpoofedPointerId
;
static
nsClassHashtable
<
nsUint32HashKey
PointerCaptureInfo
>
*
sPointerCaptureList
;
static
nsClassHashtable
<
nsUint32HashKey
PointerInfo
>
*
sActivePointersIds
;
static
nsDataHashtable
<
nsUint32HashKey
BrowserParent
*
>
*
sPointerCaptureRemoteTargetTable
=
nullptr
;
void
PointerEventHandler
:
:
InitializeStatics
(
)
{
MOZ_ASSERT
(
!
sPointerCaptureList
"
InitializeStatics
called
multiple
times
!
"
)
;
sPointerCaptureList
=
new
nsClassHashtable
<
nsUint32HashKey
PointerCaptureInfo
>
;
sActivePointersIds
=
new
nsClassHashtable
<
nsUint32HashKey
PointerInfo
>
;
if
(
XRE_IsParentProcess
(
)
)
{
sPointerCaptureRemoteTargetTable
=
new
nsDataHashtable
<
nsUint32HashKey
BrowserParent
*
>
;
}
}
void
PointerEventHandler
:
:
ReleaseStatics
(
)
{
MOZ_ASSERT
(
sPointerCaptureList
"
ReleaseStatics
called
without
Initialize
!
"
)
;
delete
sPointerCaptureList
;
sPointerCaptureList
=
nullptr
;
delete
sActivePointersIds
;
sActivePointersIds
=
nullptr
;
if
(
sPointerCaptureRemoteTargetTable
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
delete
sPointerCaptureRemoteTargetTable
;
sPointerCaptureRemoteTargetTable
=
nullptr
;
}
}
bool
PointerEventHandler
:
:
IsPointerEventImplicitCaptureForTouchEnabled
(
)
{
return
StaticPrefs
:
:
dom_w3c_pointer_events_enabled
(
)
&
&
StaticPrefs
:
:
dom_w3c_pointer_events_implicit_capture
(
)
;
}
void
PointerEventHandler
:
:
UpdateActivePointerState
(
WidgetMouseEvent
*
aEvent
nsIContent
*
aTargetContent
)
{
if
(
!
StaticPrefs
:
:
dom_w3c_pointer_events_enabled
(
)
|
|
!
aEvent
)
{
return
;
}
switch
(
aEvent
-
>
mMessage
)
{
case
eMouseEnterIntoWidget
:
sActivePointersIds
-
>
Put
(
aEvent
-
>
pointerId
new
PointerInfo
(
false
aEvent
-
>
mInputSource
true
nullptr
)
)
;
MaybeCacheSpoofedPointerID
(
aEvent
-
>
mInputSource
aEvent
-
>
pointerId
)
;
break
;
case
ePointerDown
:
if
(
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
)
{
sActivePointersIds
-
>
Put
(
pointerEvent
-
>
pointerId
new
PointerInfo
(
true
pointerEvent
-
>
mInputSource
pointerEvent
-
>
mIsPrimary
aTargetContent
?
aTargetContent
-
>
OwnerDoc
(
)
:
nullptr
)
)
;
MaybeCacheSpoofedPointerID
(
pointerEvent
-
>
mInputSource
pointerEvent
-
>
pointerId
)
;
}
break
;
case
ePointerCancel
:
case
ePointerUp
:
if
(
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
)
{
if
(
pointerEvent
-
>
mInputSource
!
=
MouseEvent_Binding
:
:
MOZ_SOURCE_TOUCH
)
{
sActivePointersIds
-
>
Put
(
pointerEvent
-
>
pointerId
new
PointerInfo
(
false
pointerEvent
-
>
mInputSource
pointerEvent
-
>
mIsPrimary
nullptr
)
)
;
}
else
{
sActivePointersIds
-
>
Remove
(
pointerEvent
-
>
pointerId
)
;
}
}
break
;
case
eMouseExitFromWidget
:
sActivePointersIds
-
>
Remove
(
aEvent
-
>
pointerId
)
;
break
;
default
:
break
;
}
}
void
PointerEventHandler
:
:
RequestPointerCaptureById
(
uint32_t
aPointerId
Element
*
aElement
)
{
SetPointerCaptureById
(
aPointerId
aElement
)
;
if
(
BrowserChild
*
browserChild
=
BrowserChild
:
:
GetFrom
(
aElement
-
>
OwnerDoc
(
)
-
>
GetDocShell
(
)
)
)
{
browserChild
-
>
SendRequestPointerCapture
(
aPointerId
[
aPointerId
]
(
bool
aSuccess
)
{
if
(
!
aSuccess
)
{
PointerEventHandler
:
:
ReleasePointerCaptureById
(
aPointerId
)
;
}
}
[
]
(
mozilla
:
:
ipc
:
:
ResponseRejectReason
)
{
}
)
;
}
}
void
PointerEventHandler
:
:
SetPointerCaptureById
(
uint32_t
aPointerId
Element
*
aElement
)
{
MOZ_ASSERT
(
aElement
)
;
PointerCaptureInfo
*
pointerCaptureInfo
=
GetPointerCaptureInfo
(
aPointerId
)
;
if
(
pointerCaptureInfo
)
{
pointerCaptureInfo
-
>
mPendingElement
=
aElement
;
}
else
{
sPointerCaptureList
-
>
Put
(
aPointerId
new
PointerCaptureInfo
(
aElement
)
)
;
}
}
PointerCaptureInfo
*
PointerEventHandler
:
:
GetPointerCaptureInfo
(
uint32_t
aPointerId
)
{
PointerCaptureInfo
*
pointerCaptureInfo
=
nullptr
;
sPointerCaptureList
-
>
Get
(
aPointerId
&
pointerCaptureInfo
)
;
return
pointerCaptureInfo
;
}
void
PointerEventHandler
:
:
ReleasePointerCaptureById
(
uint32_t
aPointerId
)
{
PointerCaptureInfo
*
pointerCaptureInfo
=
GetPointerCaptureInfo
(
aPointerId
)
;
if
(
pointerCaptureInfo
)
{
if
(
Element
*
pendingElement
=
pointerCaptureInfo
-
>
mPendingElement
)
{
if
(
BrowserChild
*
browserChild
=
BrowserChild
:
:
GetFrom
(
pendingElement
-
>
OwnerDoc
(
)
-
>
GetDocShell
(
)
)
)
{
browserChild
-
>
SendReleasePointerCapture
(
aPointerId
)
;
}
}
pointerCaptureInfo
-
>
mPendingElement
=
nullptr
;
}
}
void
PointerEventHandler
:
:
ReleaseAllPointerCapture
(
)
{
for
(
auto
iter
=
sPointerCaptureList
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
PointerCaptureInfo
*
data
=
iter
.
UserData
(
)
;
if
(
data
&
&
data
-
>
mPendingElement
)
{
ReleasePointerCaptureById
(
iter
.
Key
(
)
)
;
}
}
}
bool
PointerEventHandler
:
:
SetPointerCaptureRemoteTarget
(
uint32_t
aPointerId
dom
:
:
BrowserParent
*
aBrowserParent
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
MOZ_ASSERT
(
aBrowserParent
)
;
if
(
BrowserParent
:
:
GetPointerLockedRemoteTarget
(
)
)
{
return
false
;
}
BrowserParent
*
currentRemoteTarget
=
PointerEventHandler
:
:
GetPointerCapturingRemoteTarget
(
aPointerId
)
;
if
(
currentRemoteTarget
&
&
currentRemoteTarget
!
=
aBrowserParent
)
{
return
false
;
}
sPointerCaptureRemoteTargetTable
-
>
Put
(
aPointerId
aBrowserParent
)
;
return
true
;
}
void
PointerEventHandler
:
:
ReleasePointerCaptureRemoteTarget
(
BrowserParent
*
aBrowserParent
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
MOZ_ASSERT
(
aBrowserParent
)
;
sPointerCaptureRemoteTargetTable
-
>
RemoveIf
(
[
aBrowserParent
]
(
const
auto
&
iter
)
{
BrowserParent
*
browserParent
=
iter
.
Data
(
)
;
MOZ_ASSERT
(
browserParent
"
Null
BrowserParent
in
pointer
captured
table
?
"
)
;
return
aBrowserParent
=
=
browserParent
;
}
)
;
}
void
PointerEventHandler
:
:
ReleasePointerCaptureRemoteTarget
(
uint32_t
aPointerId
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
sPointerCaptureRemoteTargetTable
-
>
Remove
(
aPointerId
)
;
}
BrowserParent
*
PointerEventHandler
:
:
GetPointerCapturingRemoteTarget
(
uint32_t
aPointerId
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
return
sPointerCaptureRemoteTargetTable
-
>
Get
(
aPointerId
)
;
}
void
PointerEventHandler
:
:
ReleaseAllPointerCaptureRemoteTarget
(
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
sPointerCaptureRemoteTargetTable
)
;
for
(
auto
iter
=
sPointerCaptureRemoteTargetTable
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
BrowserParent
*
browserParent
=
iter
.
Data
(
)
;
MOZ_ASSERT
(
browserParent
"
Null
BrowserParent
in
pointer
captured
table
?
"
)
;
Unused
<
<
browserParent
-
>
SendReleaseAllPointerCapture
(
)
;
iter
.
Remove
(
)
;
}
}
const
PointerInfo
*
PointerEventHandler
:
:
GetPointerInfo
(
uint32_t
aPointerId
)
{
return
sActivePointersIds
-
>
Get
(
aPointerId
)
;
}
void
PointerEventHandler
:
:
MaybeProcessPointerCapture
(
WidgetGUIEvent
*
aEvent
)
{
switch
(
aEvent
-
>
mClass
)
{
case
eMouseEventClass
:
ProcessPointerCaptureForMouse
(
aEvent
-
>
AsMouseEvent
(
)
)
;
break
;
case
eTouchEventClass
:
ProcessPointerCaptureForTouch
(
aEvent
-
>
AsTouchEvent
(
)
)
;
break
;
default
:
break
;
}
}
void
PointerEventHandler
:
:
ProcessPointerCaptureForMouse
(
WidgetMouseEvent
*
aEvent
)
{
if
(
!
ShouldGeneratePointerEventFromMouse
(
aEvent
)
)
{
return
;
}
PointerCaptureInfo
*
info
=
GetPointerCaptureInfo
(
aEvent
-
>
pointerId
)
;
if
(
!
info
|
|
info
-
>
mPendingElement
=
=
info
-
>
mOverrideElement
)
{
return
;
}
WidgetPointerEvent
localEvent
(
*
aEvent
)
;
InitPointerEventFromMouse
(
&
localEvent
aEvent
eVoidEvent
)
;
CheckPointerCaptureState
(
&
localEvent
)
;
}
void
PointerEventHandler
:
:
ProcessPointerCaptureForTouch
(
WidgetTouchEvent
*
aEvent
)
{
if
(
!
ShouldGeneratePointerEventFromTouch
(
aEvent
)
)
{
return
;
}
for
(
uint32_t
i
=
0
;
i
<
aEvent
-
>
mTouches
.
Length
(
)
;
+
+
i
)
{
Touch
*
touch
=
aEvent
-
>
mTouches
[
i
]
;
if
(
!
TouchManager
:
:
ShouldConvertTouchToPointer
(
touch
aEvent
)
)
{
continue
;
}
PointerCaptureInfo
*
info
=
GetPointerCaptureInfo
(
touch
-
>
Identifier
(
)
)
;
if
(
!
info
|
|
info
-
>
mPendingElement
=
=
info
-
>
mOverrideElement
)
{
continue
;
}
WidgetPointerEvent
event
(
aEvent
-
>
IsTrusted
(
)
eVoidEvent
aEvent
-
>
mWidget
)
;
InitPointerEventFromTouch
(
&
event
aEvent
touch
i
=
=
0
)
;
CheckPointerCaptureState
(
&
event
)
;
}
}
void
PointerEventHandler
:
:
CheckPointerCaptureState
(
WidgetPointerEvent
*
aEvent
)
{
if
(
!
aEvent
)
{
return
;
}
MOZ_ASSERT
(
StaticPrefs
:
:
dom_w3c_pointer_events_enabled
(
)
)
;
MOZ_ASSERT
(
aEvent
-
>
mClass
=
=
ePointerEventClass
)
;
PointerCaptureInfo
*
captureInfo
=
GetPointerCaptureInfo
(
aEvent
-
>
pointerId
)
;
if
(
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
&
&
aEvent
-
>
pointerId
!
=
(
uint32_t
)
GetSpoofedPointerIdForRFP
(
)
&
&
!
captureInfo
)
{
PointerCaptureInfo
*
spoofedCaptureInfo
=
GetPointerCaptureInfo
(
GetSpoofedPointerIdForRFP
(
)
)
;
if
(
!
spoofedCaptureInfo
|
|
(
spoofedCaptureInfo
-
>
mPendingElement
&
&
spoofedCaptureInfo
-
>
mPendingElement
-
>
IsInChromeDocument
(
)
)
)
{
return
;
}
captureInfo
=
spoofedCaptureInfo
;
}
if
(
!
captureInfo
|
|
captureInfo
-
>
mPendingElement
=
=
captureInfo
-
>
mOverrideElement
)
{
return
;
}
RefPtr
<
Element
>
pendingElement
=
captureInfo
-
>
mPendingElement
.
get
(
)
;
if
(
captureInfo
-
>
mOverrideElement
)
{
RefPtr
<
Element
>
overrideElement
=
captureInfo
-
>
mOverrideElement
;
DispatchGotOrLostPointerCaptureEvent
(
false
aEvent
overrideElement
)
;
}
if
(
pendingElement
)
{
DispatchGotOrLostPointerCaptureEvent
(
true
aEvent
pendingElement
)
;
}
captureInfo
-
>
mOverrideElement
=
std
:
:
move
(
pendingElement
)
;
if
(
captureInfo
-
>
Empty
(
)
)
{
sPointerCaptureList
-
>
Remove
(
aEvent
-
>
pointerId
)
;
}
}
void
PointerEventHandler
:
:
ImplicitlyCapturePointer
(
nsIFrame
*
aFrame
WidgetEvent
*
aEvent
)
{
MOZ_ASSERT
(
aEvent
-
>
mMessage
=
=
ePointerDown
)
;
if
(
!
aFrame
|
|
!
StaticPrefs
:
:
dom_w3c_pointer_events_enabled
(
)
|
|
!
IsPointerEventImplicitCaptureForTouchEnabled
(
)
)
{
return
;
}
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
;
NS_WARNING_ASSERTION
(
pointerEvent
"
Call
ImplicitlyCapturePointer
with
non
-
pointer
event
"
)
;
if
(
pointerEvent
-
>
mInputSource
!
=
MouseEvent_Binding
:
:
MOZ_SOURCE_TOUCH
)
{
return
;
}
nsCOMPtr
<
nsIContent
>
target
;
aFrame
-
>
GetContentForEvent
(
aEvent
getter_AddRefs
(
target
)
)
;
while
(
target
&
&
!
target
-
>
IsElement
(
)
)
{
target
=
target
-
>
GetParent
(
)
;
}
if
(
NS_WARN_IF
(
!
target
)
)
{
return
;
}
RequestPointerCaptureById
(
pointerEvent
-
>
pointerId
target
-
>
AsElement
(
)
)
;
}
void
PointerEventHandler
:
:
ImplicitlyReleasePointerCapture
(
WidgetEvent
*
aEvent
)
{
MOZ_ASSERT
(
aEvent
)
;
if
(
aEvent
-
>
mMessage
!
=
ePointerUp
&
&
aEvent
-
>
mMessage
!
=
ePointerCancel
)
{
return
;
}
WidgetPointerEvent
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
;
ReleasePointerCaptureById
(
pointerEvent
-
>
pointerId
)
;
CheckPointerCaptureState
(
pointerEvent
)
;
}
Element
*
PointerEventHandler
:
:
GetPointerCapturingElement
(
uint32_t
aPointerId
)
{
PointerCaptureInfo
*
pointerCaptureInfo
=
GetPointerCaptureInfo
(
aPointerId
)
;
if
(
pointerCaptureInfo
)
{
return
pointerCaptureInfo
-
>
mOverrideElement
;
}
return
nullptr
;
}
Element
*
PointerEventHandler
:
:
GetPointerCapturingElement
(
WidgetGUIEvent
*
aEvent
)
{
if
(
!
StaticPrefs
:
:
dom_w3c_pointer_events_enabled
(
)
|
|
(
aEvent
-
>
mClass
!
=
ePointerEventClass
&
&
aEvent
-
>
mClass
!
=
eMouseEventClass
)
|
|
aEvent
-
>
mMessage
=
=
ePointerDown
|
|
aEvent
-
>
mMessage
=
=
eMouseDown
)
{
return
nullptr
;
}
WidgetMouseEvent
*
mouseEvent
=
aEvent
-
>
AsMouseEvent
(
)
;
if
(
!
mouseEvent
)
{
return
nullptr
;
}
return
GetPointerCapturingElement
(
mouseEvent
-
>
pointerId
)
;
}
void
PointerEventHandler
:
:
ReleaseIfCaptureByDescendant
(
nsIContent
*
aContent
)
{
for
(
auto
iter
=
sPointerCaptureList
-
>
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
PointerCaptureInfo
*
data
=
iter
.
UserData
(
)
;
if
(
data
&
&
data
-
>
mPendingElement
&
&
data
-
>
mPendingElement
-
>
IsInclusiveDescendantOf
(
aContent
)
)
{
ReleasePointerCaptureById
(
iter
.
Key
(
)
)
;
}
}
}
void
PointerEventHandler
:
:
PreHandlePointerEventsPreventDefault
(
WidgetPointerEvent
*
aPointerEvent
WidgetGUIEvent
*
aMouseOrTouchEvent
)
{
if
(
!
aPointerEvent
-
>
mIsPrimary
|
|
aPointerEvent
-
>
mMessage
=
=
ePointerDown
)
{
return
;
}
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
!
sActivePointersIds
-
>
Get
(
aPointerEvent
-
>
pointerId
&
pointerInfo
)
|
|
!
pointerInfo
)
{
return
;
}
if
(
!
pointerInfo
-
>
mPreventMouseEventByContent
)
{
return
;
}
aMouseOrTouchEvent
-
>
PreventDefault
(
false
)
;
aMouseOrTouchEvent
-
>
mFlags
.
mOnlyChromeDispatch
=
true
;
if
(
aPointerEvent
-
>
mMessage
=
=
ePointerUp
)
{
pointerInfo
-
>
mPreventMouseEventByContent
=
false
;
}
}
void
PointerEventHandler
:
:
PostHandlePointerEventsPreventDefault
(
WidgetPointerEvent
*
aPointerEvent
WidgetGUIEvent
*
aMouseOrTouchEvent
)
{
if
(
!
aPointerEvent
-
>
mIsPrimary
|
|
aPointerEvent
-
>
mMessage
!
=
ePointerDown
|
|
!
aPointerEvent
-
>
DefaultPreventedByContent
(
)
)
{
return
;
}
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
!
sActivePointersIds
-
>
Get
(
aPointerEvent
-
>
pointerId
&
pointerInfo
)
|
|
!
pointerInfo
)
{
#
ifdef
DEBUG
MOZ_CRASH
(
"
Got
ePointerDown
w
/
o
active
pointer
info
!
!
"
)
;
#
endif
return
;
}
if
(
!
pointerInfo
-
>
mActiveState
)
{
return
;
}
aMouseOrTouchEvent
-
>
PreventDefault
(
false
)
;
aMouseOrTouchEvent
-
>
mFlags
.
mOnlyChromeDispatch
=
true
;
pointerInfo
-
>
mPreventMouseEventByContent
=
true
;
}
void
PointerEventHandler
:
:
InitPointerEventFromMouse
(
WidgetPointerEvent
*
aPointerEvent
WidgetMouseEvent
*
aMouseEvent
EventMessage
aMessage
)
{
MOZ_ASSERT
(
aPointerEvent
)
;
MOZ_ASSERT
(
aMouseEvent
)
;
aPointerEvent
-
>
pointerId
=
aMouseEvent
-
>
pointerId
;
aPointerEvent
-
>
mInputSource
=
aMouseEvent
-
>
mInputSource
;
aPointerEvent
-
>
mMessage
=
aMessage
;
aPointerEvent
-
>
mButton
=
aMouseEvent
-
>
mMessage
=
=
eMouseMove
?
MouseButton
:
:
eNotPressed
:
aMouseEvent
-
>
mButton
;
aPointerEvent
-
>
mButtons
=
aMouseEvent
-
>
mButtons
;
aPointerEvent
-
>
mPressure
=
aPointerEvent
-
>
mButtons
?
aMouseEvent
-
>
mPressure
?
aMouseEvent
-
>
mPressure
:
0
.
5f
:
0
.
0f
;
}
void
PointerEventHandler
:
:
InitPointerEventFromTouch
(
WidgetPointerEvent
*
aPointerEvent
WidgetTouchEvent
*
aTouchEvent
mozilla
:
:
dom
:
:
Touch
*
aTouch
bool
aIsPrimary
)
{
MOZ_ASSERT
(
aPointerEvent
)
;
MOZ_ASSERT
(
aTouchEvent
)
;
int16_t
button
=
aTouchEvent
-
>
mMessage
=
=
eTouchMove
?
MouseButton
:
:
eNotPressed
:
MouseButton
:
:
ePrimary
;
int16_t
buttons
=
aTouchEvent
-
>
mMessage
=
=
eTouchEnd
?
MouseButtonsFlag
:
:
eNoButtons
:
MouseButtonsFlag
:
:
ePrimaryFlag
;
aPointerEvent
-
>
mIsPrimary
=
aIsPrimary
;
aPointerEvent
-
>
pointerId
=
aTouch
-
>
Identifier
(
)
;
aPointerEvent
-
>
mRefPoint
=
aTouch
-
>
mRefPoint
;
aPointerEvent
-
>
mModifiers
=
aTouchEvent
-
>
mModifiers
;
aPointerEvent
-
>
mWidth
=
aTouch
-
>
RadiusX
(
CallerType
:
:
System
)
;
aPointerEvent
-
>
mHeight
=
aTouch
-
>
RadiusY
(
CallerType
:
:
System
)
;
aPointerEvent
-
>
tiltX
=
aTouch
-
>
tiltX
;
aPointerEvent
-
>
tiltY
=
aTouch
-
>
tiltY
;
aPointerEvent
-
>
mTime
=
aTouchEvent
-
>
mTime
;
aPointerEvent
-
>
mTimeStamp
=
aTouchEvent
-
>
mTimeStamp
;
aPointerEvent
-
>
mFlags
=
aTouchEvent
-
>
mFlags
;
aPointerEvent
-
>
mButton
=
button
;
aPointerEvent
-
>
mButtons
=
buttons
;
aPointerEvent
-
>
mInputSource
=
MouseEvent_Binding
:
:
MOZ_SOURCE_TOUCH
;
}
void
PointerEventHandler
:
:
DispatchPointerFromMouseOrTouch
(
PresShell
*
aShell
nsIFrame
*
aFrame
nsIContent
*
aContent
WidgetGUIEvent
*
aEvent
bool
aDontRetargetEvents
nsEventStatus
*
aStatus
nsIContent
*
*
aTargetContent
)
{
MOZ_ASSERT
(
StaticPrefs
:
:
dom_w3c_pointer_events_enabled
(
)
)
;
MOZ_ASSERT
(
aFrame
|
|
aContent
)
;
MOZ_ASSERT
(
aEvent
)
;
EventMessage
pointerMessage
=
eVoidEvent
;
if
(
aEvent
-
>
mClass
=
=
eMouseEventClass
)
{
WidgetMouseEvent
*
mouseEvent
=
aEvent
-
>
AsMouseEvent
(
)
;
Document
*
doc
=
aShell
-
>
GetDocument
(
)
;
if
(
!
doc
)
{
return
;
}
BrowsingContext
*
bc
=
doc
-
>
GetBrowsingContext
(
)
;
if
(
bc
&
&
bc
-
>
TouchEventsOverride
(
)
=
=
TouchEventsOverride
:
:
Enabled
&
&
bc
-
>
InRDMPane
(
)
)
{
return
;
}
if
(
!
mouseEvent
-
>
convertToPointer
|
|
!
aEvent
-
>
IsAllowedToDispatchDOMEvent
(
)
)
{
return
;
}
switch
(
mouseEvent
-
>
mMessage
)
{
case
eMouseMove
:
pointerMessage
=
ePointerMove
;
break
;
case
eMouseUp
:
pointerMessage
=
mouseEvent
-
>
mButtons
?
ePointerMove
:
ePointerUp
;
break
;
case
eMouseDown
:
pointerMessage
=
mouseEvent
-
>
mButtons
&
~
nsContentUtils
:
:
GetButtonsFlagForButton
(
mouseEvent
-
>
mButton
)
?
ePointerMove
:
ePointerDown
;
break
;
default
:
return
;
}
WidgetPointerEvent
event
(
*
mouseEvent
)
;
InitPointerEventFromMouse
(
&
event
mouseEvent
pointerMessage
)
;
event
.
convertToPointer
=
mouseEvent
-
>
convertToPointer
=
false
;
RefPtr
<
PresShell
>
shell
(
aShell
)
;
if
(
!
aFrame
)
{
shell
=
PresShell
:
:
GetShellForEventTarget
(
nullptr
aContent
)
;
if
(
!
shell
)
{
return
;
}
}
PreHandlePointerEventsPreventDefault
(
&
event
aEvent
)
;
shell
-
>
HandleEventWithTarget
(
&
event
aFrame
aContent
aStatus
true
aTargetContent
)
;
PostHandlePointerEventsPreventDefault
(
&
event
aEvent
)
;
}
else
if
(
aEvent
-
>
mClass
=
=
eTouchEventClass
)
{
WidgetTouchEvent
*
touchEvent
=
aEvent
-
>
AsTouchEvent
(
)
;
switch
(
touchEvent
-
>
mMessage
)
{
case
eTouchMove
:
pointerMessage
=
ePointerMove
;
break
;
case
eTouchEnd
:
pointerMessage
=
ePointerUp
;
break
;
case
eTouchStart
:
pointerMessage
=
ePointerDown
;
break
;
case
eTouchCancel
:
case
eTouchPointerCancel
:
pointerMessage
=
ePointerCancel
;
break
;
default
:
return
;
}
RefPtr
<
PresShell
>
shell
(
aShell
)
;
for
(
uint32_t
i
=
0
;
i
<
touchEvent
-
>
mTouches
.
Length
(
)
;
+
+
i
)
{
Touch
*
touch
=
touchEvent
-
>
mTouches
[
i
]
;
if
(
!
TouchManager
:
:
ShouldConvertTouchToPointer
(
touch
touchEvent
)
)
{
continue
;
}
WidgetPointerEvent
event
(
touchEvent
-
>
IsTrusted
(
)
pointerMessage
touchEvent
-
>
mWidget
)
;
InitPointerEventFromTouch
(
&
event
touchEvent
touch
i
=
=
0
)
;
event
.
convertToPointer
=
touch
-
>
convertToPointer
=
false
;
if
(
aEvent
-
>
mMessage
=
=
eTouchStart
)
{
nsCOMPtr
<
nsIContent
>
content
=
do_QueryInterface
(
touch
-
>
mTarget
)
;
if
(
!
content
)
{
continue
;
}
nsIFrame
*
frame
=
content
-
>
GetPrimaryFrame
(
)
;
shell
=
PresShell
:
:
GetShellForEventTarget
(
frame
content
)
;
if
(
!
shell
)
{
continue
;
}
PreHandlePointerEventsPreventDefault
(
&
event
aEvent
)
;
shell
-
>
HandleEventWithTarget
(
&
event
frame
content
aStatus
true
nullptr
)
;
PostHandlePointerEventsPreventDefault
(
&
event
aEvent
)
;
}
else
{
PreHandlePointerEventsPreventDefault
(
&
event
aEvent
)
;
shell
-
>
HandleEvent
(
aFrame
&
event
aDontRetargetEvents
aStatus
)
;
PostHandlePointerEventsPreventDefault
(
&
event
aEvent
)
;
}
}
}
}
uint16_t
PointerEventHandler
:
:
GetPointerType
(
uint32_t
aPointerId
)
{
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
sActivePointersIds
-
>
Get
(
aPointerId
&
pointerInfo
)
&
&
pointerInfo
)
{
return
pointerInfo
-
>
mPointerType
;
}
return
MouseEvent_Binding
:
:
MOZ_SOURCE_UNKNOWN
;
}
bool
PointerEventHandler
:
:
GetPointerPrimaryState
(
uint32_t
aPointerId
)
{
PointerInfo
*
pointerInfo
=
nullptr
;
if
(
sActivePointersIds
-
>
Get
(
aPointerId
&
pointerInfo
)
&
&
pointerInfo
)
{
return
pointerInfo
-
>
mPrimaryState
;
}
return
false
;
}
void
PointerEventHandler
:
:
DispatchGotOrLostPointerCaptureEvent
(
bool
aIsGotCapture
const
WidgetPointerEvent
*
aPointerEvent
Element
*
aCaptureTarget
)
{
Document
*
targetDoc
=
aCaptureTarget
-
>
OwnerDoc
(
)
;
RefPtr
<
PresShell
>
presShell
=
targetDoc
-
>
GetPresShell
(
)
;
if
(
NS_WARN_IF
(
!
presShell
)
)
{
return
;
}
if
(
!
aIsGotCapture
&
&
!
aCaptureTarget
-
>
IsInComposedDoc
(
)
)
{
PointerEventInit
init
;
init
.
mPointerId
=
aPointerEvent
-
>
pointerId
;
init
.
mBubbles
=
true
;
init
.
mComposed
=
true
;
ConvertPointerTypeToString
(
aPointerEvent
-
>
mInputSource
init
.
mPointerType
)
;
init
.
mIsPrimary
=
aPointerEvent
-
>
mIsPrimary
;
RefPtr
<
PointerEvent
>
event
;
event
=
PointerEvent
:
:
Constructor
(
aCaptureTarget
u
"
lostpointercapture
"
_ns
init
)
;
targetDoc
-
>
DispatchEvent
(
*
event
)
;
return
;
}
nsEventStatus
status
=
nsEventStatus_eIgnore
;
WidgetPointerEvent
localEvent
(
aPointerEvent
-
>
IsTrusted
(
)
aIsGotCapture
?
ePointerGotCapture
:
ePointerLostCapture
aPointerEvent
-
>
mWidget
)
;
localEvent
.
AssignPointerEventData
(
*
aPointerEvent
true
)
;
DebugOnly
<
nsresult
>
rv
=
presShell
-
>
HandleEventWithTarget
(
&
localEvent
aCaptureTarget
-
>
GetPrimaryFrame
(
)
aCaptureTarget
&
status
)
;
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
DispatchGotOrLostPointerCaptureEvent
failed
"
)
;
}
void
PointerEventHandler
:
:
MaybeCacheSpoofedPointerID
(
uint16_t
aInputSource
uint32_t
aPointerId
)
{
if
(
sSpoofedPointerId
.
isSome
(
)
|
|
aInputSource
!
=
SPOOFED_POINTER_INTERFACE
)
{
return
;
}
sSpoofedPointerId
.
emplace
(
aPointerId
)
;
}
}
