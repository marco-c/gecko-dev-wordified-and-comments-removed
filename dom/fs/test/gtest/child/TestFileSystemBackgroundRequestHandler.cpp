#
include
"
FileSystemBackgroundRequestHandler
.
h
"
#
include
"
FileSystemMocks
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
SpinEventLoopUntil
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
dom
/
FileSystemManager
.
h
"
#
include
"
mozilla
/
dom
/
FileSystemManagerChild
.
h
"
#
include
"
mozilla
/
dom
/
PFileSystemManager
.
h
"
namespace
mozilla
:
:
dom
:
:
fs
:
:
test
{
class
TestFileSystemBackgroundRequestHandler
:
public
:
:
testing
:
:
Test
{
protected
:
void
SetUp
(
)
override
{
nsCOMPtr
<
nsIPrefBranch
>
prefs
=
do_GetService
(
NS_PREFSERVICE_CONTRACTID
)
;
prefs
-
>
SetBoolPref
(
"
dom
.
fs
.
enabled
"
false
)
;
mFileSystemManagerChild
=
MakeAndAddRef
<
TestFileSystemManagerChild
>
(
)
;
}
void
TearDown
(
)
override
{
nsCOMPtr
<
nsIPrefBranch
>
prefs
=
do_GetService
(
NS_PREFSERVICE_CONTRACTID
)
;
prefs
-
>
SetBoolPref
(
"
dom
.
fs
.
enabled
"
true
)
;
}
RefPtr
<
FileSystemBackgroundRequestHandler
>
GetFileSystemBackgroundRequestHandler
(
)
{
return
MakeRefPtr
<
FileSystemBackgroundRequestHandler
>
(
new
TestFileSystemChildFactory
(
mFileSystemManagerChild
)
)
;
}
mozilla
:
:
ipc
:
:
PrincipalInfo
mPrincipalInfo
=
GetPrincipalInfo
(
)
;
RefPtr
<
TestFileSystemManagerChild
>
mFileSystemManagerChild
;
}
;
TEST_F
(
TestFileSystemBackgroundRequestHandler
isCreateFileSystemManagerChildSuccessful
)
{
EXPECT_CALL
(
*
mFileSystemManagerChild
Shutdown
(
)
)
.
WillOnce
(
[
fileSystemManagerChild
=
static_cast
<
void
*
>
(
mFileSystemManagerChild
.
get
(
)
)
]
(
)
{
static_cast
<
TestFileSystemManagerChild
*
>
(
fileSystemManagerChild
)
-
>
FileSystemManagerChild
:
:
Shutdown
(
)
;
}
)
;
bool
done
=
false
;
auto
testable
=
GetFileSystemBackgroundRequestHandler
(
)
;
testable
-
>
CreateFileSystemManagerChild
(
mPrincipalInfo
)
-
>
Then
(
GetCurrentSerialEventTarget
(
)
__func__
[
&
done
]
(
const
FileSystemManagerChild
:
:
ActorPromise
:
:
ResolveOrRejectValue
&
)
{
done
=
true
;
}
)
;
SpinEventLoopUntil
(
"
Promise
is
fulfilled
or
timeout
"
_ns
[
&
done
]
(
)
{
return
done
;
}
)
;
}
}
