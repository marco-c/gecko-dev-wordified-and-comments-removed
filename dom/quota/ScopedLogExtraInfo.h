#
ifndef
DOM_QUOTA_SCOPEDLOGEXTRAINFO_H_
#
define
DOM_QUOTA_SCOPEDLOGEXTRAINFO_H_
#
include
<
map
>
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Tainting
.
h
"
#
include
"
mozilla
/
ThreadLocal
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
Config
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsXULAppAPI
.
h
"
namespace
mozilla
:
:
dom
:
:
quota
{
struct
MOZ_STACK_CLASS
ScopedLogExtraInfo
{
static
constexpr
const
char
kTagQueryTainted
[
]
=
"
query
"
;
static
constexpr
const
char
kTagContextTainted
[
]
=
"
context
"
;
static
constexpr
const
char
kTagStorageOriginTainted
[
]
=
"
storage
-
origin
"
;
#
ifdef
QM_SCOPED_LOG_EXTRA_INFO_ENABLED
private
:
static
auto
FindSlot
(
const
char
*
aTag
)
;
public
:
template
<
size_t
N
>
ScopedLogExtraInfo
(
const
char
(
&
aTag
)
[
N
]
const
nsACString
&
aExtraInfo
)
:
mTag
{
aTag
}
mPreviousValue
(
nullptr
)
mCurrentValue
{
aExtraInfo
}
{
AddInfo
(
)
;
}
~
ScopedLogExtraInfo
(
)
;
ScopedLogExtraInfo
(
ScopedLogExtraInfo
&
&
aOther
)
noexcept
;
ScopedLogExtraInfo
&
operator
=
(
ScopedLogExtraInfo
&
&
aOther
)
=
delete
;
ScopedLogExtraInfo
(
const
ScopedLogExtraInfo
&
)
=
delete
;
ScopedLogExtraInfo
&
operator
=
(
const
ScopedLogExtraInfo
&
)
=
delete
;
using
ScopedLogExtraInfoMap
=
std
:
:
map
<
const
char
*
const
Tainted
<
nsCString
>
*
>
;
static
ScopedLogExtraInfoMap
GetExtraInfoMap
(
)
;
static
void
Initialize
(
)
;
private
:
const
char
*
mTag
;
const
Tainted
<
nsCString
>
*
mPreviousValue
;
Tainted
<
nsCString
>
mCurrentValue
;
static
MOZ_THREAD_LOCAL
(
const
Tainted
<
nsCString
>
*
)
sQueryValueTainted
;
static
MOZ_THREAD_LOCAL
(
const
Tainted
<
nsCString
>
*
)
sContextValueTainted
;
static
MOZ_THREAD_LOCAL
(
const
Tainted
<
nsCString
>
*
)
sStorageOriginValueTainted
;
void
AddInfo
(
)
;
#
else
template
<
size_t
N
>
ScopedLogExtraInfo
(
const
char
(
&
aTag
)
[
N
]
const
nsACString
&
aExtraInfo
)
{
}
~
ScopedLogExtraInfo
(
)
{
}
#
endif
}
;
}
#
endif
