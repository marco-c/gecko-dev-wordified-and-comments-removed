#
ifndef
DOM_QUOTA_RESOLVABLEORIGINOP_H_
#
define
DOM_QUOTA_RESOLVABLEORIGINOP_H_
#
include
"
NormalOriginOperationBase
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
namespace
mozilla
:
:
dom
:
:
quota
{
template
<
typename
T
>
class
ResolvableOriginOp
:
public
NormalOriginOperationBase
{
public
:
using
PromiseType
=
MozPromise
<
T
nsresult
false
>
;
RefPtr
<
PromiseType
>
OnResults
(
)
{
AssertIsOnOwningThread
(
)
;
return
mPromiseHolder
.
Ensure
(
__func__
)
;
}
protected
:
ResolvableOriginOp
(
const
char
*
aRunnableName
const
Nullable
<
PersistenceType
>
&
aPersistenceType
const
OriginScope
&
aOriginScope
const
Nullable
<
Client
:
:
Type
>
aClientType
bool
aExclusive
)
:
NormalOriginOperationBase
(
aRunnableName
aPersistenceType
aOriginScope
aClientType
aExclusive
)
{
AssertIsOnOwningThread
(
)
;
}
virtual
~
ResolvableOriginOp
(
)
=
default
;
virtual
T
GetResolveValue
(
)
=
0
;
private
:
void
SendResults
(
)
override
{
#
ifdef
DEBUG
NoteActorDestroyed
(
)
;
#
endif
if
(
NS_SUCCEEDED
(
mResultCode
)
)
{
mPromiseHolder
.
ResolveIfExists
(
GetResolveValue
(
)
__func__
)
;
}
else
{
mPromiseHolder
.
RejectIfExists
(
mResultCode
__func__
)
;
}
}
MozPromiseHolder
<
PromiseType
>
mPromiseHolder
;
}
;
}
#
endif
