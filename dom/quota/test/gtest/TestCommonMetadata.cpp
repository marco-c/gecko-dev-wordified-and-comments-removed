#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
CommonMetadata
.
h
"
#
include
"
nsString
.
h
"
#
include
"
QuotaManagerTestHelpers
.
h
"
namespace
mozilla
:
:
dom
:
:
quota
:
:
test
{
TEST
(
DOM_Quota_CommonMetadata
PrincipalMetadata_Equals
)
{
PrincipalMetadata
principalMetadata1
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
EXPECT_TRUE
(
principalMetadata1
.
Equals
(
principalMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
^
userContextId
=
42
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
EXPECT_FALSE
(
principalMetadata1
.
Equals
(
principalMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
EXPECT_FALSE
(
principalMetadata1
.
Equals
(
principalMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
sub
.
example
.
org
"
_ns
)
;
EXPECT_FALSE
(
principalMetadata1
.
Equals
(
principalMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
true
)
;
EXPECT_FALSE
(
principalMetadata1
.
Equals
(
principalMetadata2
)
)
;
}
}
TEST
(
DOM_Quota_CommonMetadata
OriginMetadata_Equals
)
{
PrincipalMetadata
principalMetadata1
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata1
(
principalMetadata1
PERSISTENCE_TYPE_DEFAULT
)
;
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
EXPECT_TRUE
(
originMetadata1
.
Equals
(
originMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
true
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
EXPECT_FALSE
(
originMetadata1
.
Equals
(
originMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_TEMPORARY
)
;
EXPECT_FALSE
(
originMetadata1
.
Equals
(
originMetadata2
)
)
;
}
}
TEST
(
DOM_Quota_CommonMetadata
OriginStateMetadata_Equals
)
{
OriginStateMetadata
originStateMetadata1
=
OriginStateMetadata
(
0
false
false
)
;
{
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
false
)
;
EXPECT_TRUE
(
originStateMetadata1
.
Equals
(
originStateMetadata2
)
)
;
}
{
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
1
false
false
)
;
EXPECT_FALSE
(
originStateMetadata1
.
Equals
(
originStateMetadata2
)
)
;
}
{
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
true
false
)
;
EXPECT_FALSE
(
originStateMetadata1
.
Equals
(
originStateMetadata2
)
)
;
}
{
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
true
)
;
EXPECT_FALSE
(
originStateMetadata1
.
Equals
(
originStateMetadata2
)
)
;
}
}
TEST
(
DOM_Quota_CommonMetadata
OriginMetadata_GetCompositeKey
)
{
auto
originMetadata
=
GetOriginMetadata
(
"
"
_ns
"
mozilla
.
org
"
_ns
"
http
:
/
/
www
.
mozilla
.
org
"
_ns
)
;
auto
compositeKey
=
originMetadata
.
GetCompositeKey
(
)
;
EXPECT_STREQ
(
compositeKey
.
get
(
)
"
2
*
http
:
/
/
www
.
mozilla
.
org
"
)
;
}
TEST
(
DOM_Quota_CommonMetadata
FullOriginMetadata_Equals
)
{
PrincipalMetadata
principalMetadata1
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata1
(
principalMetadata1
PERSISTENCE_TYPE_DEFAULT
)
;
OriginStateMetadata
originStateMetadata1
=
OriginStateMetadata
(
0
false
false
)
;
FullOriginMetadata
fullOriginMetadata1
(
originMetadata1
originStateMetadata1
ClientUsageArray
(
)
0
kCurrentQuotaVersion
)
;
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
false
)
;
FullOriginMetadata
fullOriginMetadata2
(
originMetadata2
originStateMetadata2
ClientUsageArray
(
)
0
kCurrentQuotaVersion
)
;
EXPECT_TRUE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
true
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
false
)
;
FullOriginMetadata
fullOriginMetadata2
(
originMetadata2
originStateMetadata2
ClientUsageArray
(
)
0
kCurrentQuotaVersion
)
;
EXPECT_FALSE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_TEMPORARY
)
;
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
false
)
;
FullOriginMetadata
fullOriginMetadata2
(
originMetadata2
originStateMetadata2
ClientUsageArray
(
)
0
kCurrentQuotaVersion
)
;
EXPECT_FALSE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
1
false
false
)
;
FullOriginMetadata
fullOriginMetadata2
(
originMetadata2
originStateMetadata2
ClientUsageArray
(
)
0
kCurrentQuotaVersion
)
;
EXPECT_FALSE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
false
)
;
FullOriginMetadata
fullOriginMetadata2
(
originMetadata2
originStateMetadata2
ClientUsageArray
{
{
Some
(
1
)
Nothing
(
)
Nothing
(
)
Nothing
(
)
Nothing
(
)
}
}
0
kCurrentQuotaVersion
)
;
EXPECT_FALSE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
false
)
;
FullOriginMetadata
fullOriginMetadata2
(
originMetadata2
originStateMetadata2
ClientUsageArray
(
)
1
kCurrentQuotaVersion
)
;
EXPECT_FALSE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
{
PrincipalMetadata
principalMetadata2
=
GetPrincipalMetadata
(
"
"
_ns
"
example
.
org
"
_ns
"
http
:
/
/
www
.
example
.
org
"
_ns
)
;
OriginMetadata
originMetadata2
(
principalMetadata2
PERSISTENCE_TYPE_DEFAULT
)
;
OriginStateMetadata
originStateMetadata2
=
OriginStateMetadata
(
0
false
false
)
;
FullOriginMetadata
fullOriginMetadata2
(
originMetadata2
originStateMetadata2
ClientUsageArray
(
)
0
kCurrentQuotaVersion
+
1
)
;
EXPECT_FALSE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
}
TEST
(
DOM_Quota_CommonMetadata
FullOriginMetadata_Clone
)
{
auto
fullOriginMetadata1
=
GetFullOriginMetadata
(
"
"
_ns
"
mozilla
.
org
"
_ns
"
http
:
/
/
www
.
mozilla
.
org
"
_ns
)
;
auto
fullOriginMetadata2
=
fullOriginMetadata1
.
Clone
(
)
;
EXPECT_TRUE
(
fullOriginMetadata1
.
Equals
(
fullOriginMetadata2
)
)
;
}
}
