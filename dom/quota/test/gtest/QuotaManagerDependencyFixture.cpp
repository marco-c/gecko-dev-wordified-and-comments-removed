#
include
"
QuotaManagerDependencyFixture
.
h
"
#
include
"
mozIStorageService
.
h
"
#
include
"
mozStorageCID
.
h
"
#
include
"
mozilla
/
BasePrincipal
.
h
"
#
include
"
mozilla
/
dom
/
ScriptSettings
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
QuotaManagerService
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
ResultExtensions
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
UsageInfo
.
h
"
#
include
"
mozilla
/
gtest
/
MozAssertions
.
h
"
#
include
"
mozilla
/
ipc
/
BackgroundUtils
.
h
"
#
include
"
mozilla
/
ipc
/
PBackgroundSharedTypes
.
h
"
#
include
"
nsIPrefBranch
.
h
"
#
include
"
nsIPrefService
.
h
"
#
include
"
nsIQuotaCallbacks
.
h
"
#
include
"
nsIQuotaRequests
.
h
"
#
include
"
nsIVariant
.
h
"
#
include
"
nsScriptSecurityManager
.
h
"
namespace
mozilla
:
:
dom
:
:
quota
:
:
test
{
namespace
{
class
RequestResolver
final
:
public
nsIQuotaCallback
{
public
:
RequestResolver
(
)
:
mDone
(
false
)
{
}
bool
IsDone
(
)
const
{
return
mDone
;
}
NS_DECL_ISUPPORTS
NS_IMETHOD
OnComplete
(
nsIQuotaRequest
*
aRequest
)
override
{
mDone
=
true
;
return
NS_OK
;
}
private
:
~
RequestResolver
(
)
=
default
;
bool
mDone
;
}
;
void
CreateContentPrincipalInfo
(
const
nsACString
&
aOrigin
mozilla
:
:
ipc
:
:
PrincipalInfo
&
aPrincipalInfo
)
{
nsCOMPtr
<
nsIPrincipal
>
principal
=
BasePrincipal
:
:
CreateContentPrincipal
(
aOrigin
)
;
QM_TRY
(
MOZ_TO_RESULT
(
principal
)
QM_TEST_FAIL
)
;
mozilla
:
:
ipc
:
:
PrincipalInfo
principalInfo
;
QM_TRY
(
MOZ_TO_RESULT
(
PrincipalToPrincipalInfo
(
principal
&
aPrincipalInfo
)
)
QM_TEST_FAIL
)
;
}
}
NS_IMPL_ISUPPORTS
(
RequestResolver
nsIQuotaCallback
)
void
QuotaManagerDependencyFixture
:
:
InitializeFixture
(
)
{
nsCOMPtr
<
nsIPrefBranch
>
prefs
=
do_GetService
(
NS_PREFSERVICE_CONTRACTID
)
;
prefs
-
>
SetBoolPref
(
"
dom
.
quotaManager
.
testing
"
true
)
;
nsCOMPtr
<
mozIStorageService
>
storageService
=
do_GetService
(
MOZ_STORAGE_SERVICE_CONTRACTID
)
;
ASSERT_TRUE
(
storageService
)
;
nsIObserver
*
observer
=
QuotaManager
:
:
GetObserver
(
)
;
ASSERT_TRUE
(
observer
)
;
nsresult
rv
=
observer
-
>
Observe
(
nullptr
"
profile
-
do
-
change
"
nullptr
)
;
ASSERT_NS_SUCCEEDED
(
rv
)
;
ASSERT_NO_FATAL_FAILURE
(
EnsureQuotaManager
(
)
)
;
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
ASSERT_TRUE
(
quotaManager
-
>
OwningThread
(
)
)
;
sBackgroundTarget
=
quotaManager
-
>
OwningThread
(
)
;
}
void
QuotaManagerDependencyFixture
:
:
ShutdownFixture
(
)
{
nsCOMPtr
<
nsIPrefBranch
>
prefs
=
do_GetService
(
NS_PREFSERVICE_CONTRACTID
)
;
prefs
-
>
SetBoolPref
(
"
dom
.
quotaManager
.
testing
"
false
)
;
nsIObserver
*
observer
=
QuotaManager
:
:
GetObserver
(
)
;
ASSERT_TRUE
(
observer
)
;
nsresult
rv
=
observer
-
>
Observe
(
nullptr
"
profile
-
before
-
change
-
qm
"
nullptr
)
;
ASSERT_NS_SUCCEEDED
(
rv
)
;
PerformOnBackgroundThread
(
[
]
(
)
{
QuotaManager
:
:
Reset
(
)
;
}
)
;
sBackgroundTarget
=
nullptr
;
}
void
QuotaManagerDependencyFixture
:
:
InitializeStorage
(
)
{
PerformOnBackgroundThread
(
[
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
Await
(
quotaManager
-
>
InitializeStorage
(
)
)
;
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
StorageInitialized
(
bool
*
aResult
)
{
ASSERT_TRUE
(
aResult
)
;
PerformOnBackgroundThread
(
[
aResult
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
auto
value
=
Await
(
quotaManager
-
>
StorageInitialized
(
)
)
;
if
(
value
.
IsResolve
(
)
)
{
*
aResult
=
value
.
ResolveValue
(
)
;
}
else
{
*
aResult
=
false
;
}
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
AssertStorageInitialized
(
)
{
bool
result
;
ASSERT_NO_FATAL_FAILURE
(
StorageInitialized
(
&
result
)
)
;
ASSERT_TRUE
(
result
)
;
}
void
QuotaManagerDependencyFixture
:
:
AssertStorageNotInitialized
(
)
{
bool
result
;
ASSERT_NO_FATAL_FAILURE
(
StorageInitialized
(
&
result
)
)
;
ASSERT_FALSE
(
result
)
;
}
void
QuotaManagerDependencyFixture
:
:
ClearStorage
(
)
{
PerformOnBackgroundThread
(
[
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
Await
(
quotaManager
-
>
ClearStorage
(
)
)
;
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
ShutdownStorage
(
)
{
PerformOnBackgroundThread
(
[
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
Await
(
quotaManager
-
>
ShutdownStorage
(
)
)
;
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
InitializeTemporaryStorage
(
)
{
PerformOnBackgroundThread
(
[
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
Await
(
quotaManager
-
>
InitializeTemporaryStorage
(
)
)
;
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
TemporaryStorageInitialized
(
bool
*
aResult
)
{
ASSERT_TRUE
(
aResult
)
;
PerformOnBackgroundThread
(
[
aResult
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
auto
value
=
Await
(
quotaManager
-
>
TemporaryStorageInitialized
(
)
)
;
if
(
value
.
IsResolve
(
)
)
{
*
aResult
=
value
.
ResolveValue
(
)
;
}
else
{
*
aResult
=
false
;
}
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
AssertTemporaryStorageInitialized
(
)
{
bool
result
;
ASSERT_NO_FATAL_FAILURE
(
TemporaryStorageInitialized
(
&
result
)
)
;
ASSERT_TRUE
(
result
)
;
}
void
QuotaManagerDependencyFixture
:
:
AssertTemporaryStorageNotInitialized
(
)
{
bool
result
;
ASSERT_NO_FATAL_FAILURE
(
TemporaryStorageInitialized
(
&
result
)
)
;
ASSERT_FALSE
(
result
)
;
}
void
QuotaManagerDependencyFixture
:
:
ShutdownTemporaryStorage
(
)
{
ASSERT_NO_FATAL_FAILURE
(
ShutdownStorage
(
)
)
;
ASSERT_NO_FATAL_FAILURE
(
InitializeStorage
(
)
)
;
}
void
QuotaManagerDependencyFixture
:
:
InitializeTemporaryOrigin
(
const
OriginMetadata
&
aOriginMetadata
bool
aCreateIfNonExistent
)
{
mozilla
:
:
ipc
:
:
PrincipalInfo
principalInfo
;
ASSERT_NO_FATAL_FAILURE
(
CreateContentPrincipalInfo
(
aOriginMetadata
.
mOrigin
principalInfo
)
)
;
PerformOnBackgroundThread
(
[
persistenceType
=
aOriginMetadata
.
mPersistenceType
principalInfo
=
std
:
:
move
(
principalInfo
)
aCreateIfNonExistent
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
Await
(
quotaManager
-
>
InitializeTemporaryOrigin
(
persistenceType
principalInfo
aCreateIfNonExistent
)
)
;
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
TemporaryOriginInitialized
(
const
OriginMetadata
&
aOriginMetadata
bool
*
aResult
)
{
ASSERT_TRUE
(
aResult
)
;
mozilla
:
:
ipc
:
:
PrincipalInfo
principalInfo
;
ASSERT_NO_FATAL_FAILURE
(
CreateContentPrincipalInfo
(
aOriginMetadata
.
mOrigin
principalInfo
)
)
;
PerformOnBackgroundThread
(
[
persistenceType
=
aOriginMetadata
.
mPersistenceType
principalInfo
=
std
:
:
move
(
principalInfo
)
aResult
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
auto
value
=
Await
(
quotaManager
-
>
TemporaryOriginInitialized
(
persistenceType
principalInfo
)
)
;
if
(
value
.
IsResolve
(
)
)
{
*
aResult
=
value
.
ResolveValue
(
)
;
}
else
{
*
aResult
=
false
;
}
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
AssertTemporaryOriginInitialized
(
const
OriginMetadata
&
aOriginMetadata
)
{
bool
result
;
ASSERT_NO_FATAL_FAILURE
(
TemporaryOriginInitialized
(
aOriginMetadata
&
result
)
)
;
ASSERT_TRUE
(
result
)
;
}
void
QuotaManagerDependencyFixture
:
:
AssertTemporaryOriginNotInitialized
(
const
OriginMetadata
&
aOriginMetadata
)
{
bool
result
;
ASSERT_NO_FATAL_FAILURE
(
TemporaryOriginInitialized
(
aOriginMetadata
&
result
)
)
;
ASSERT_FALSE
(
result
)
;
}
void
QuotaManagerDependencyFixture
:
:
GetOriginUsage
(
const
OriginMetadata
&
aOriginMetadata
UsageInfo
*
aResult
)
{
ASSERT_TRUE
(
aResult
)
;
mozilla
:
:
ipc
:
:
PrincipalInfo
principalInfo
;
ASSERT_NO_FATAL_FAILURE
(
CreateContentPrincipalInfo
(
aOriginMetadata
.
mOrigin
principalInfo
)
)
;
PerformOnBackgroundThread
(
[
aResult
principalInfo
=
std
:
:
move
(
principalInfo
)
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
auto
value
=
Await
(
quotaManager
-
>
GetOriginUsage
(
principalInfo
)
)
;
if
(
value
.
IsResolve
(
)
)
{
*
aResult
=
value
.
ResolveValue
(
)
;
}
else
{
*
aResult
=
UsageInfo
(
)
;
}
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
GetCachedOriginUsage
(
const
OriginMetadata
&
aOriginMetadata
UsageInfo
*
aResult
)
{
ASSERT_TRUE
(
aResult
)
;
mozilla
:
:
ipc
:
:
PrincipalInfo
principalInfo
;
ASSERT_NO_FATAL_FAILURE
(
CreateContentPrincipalInfo
(
aOriginMetadata
.
mOrigin
principalInfo
)
)
;
PerformOnBackgroundThread
(
[
aResult
principalInfo
=
std
:
:
move
(
principalInfo
)
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
auto
value
=
Await
(
quotaManager
-
>
GetCachedOriginUsage
(
principalInfo
)
)
;
if
(
value
.
IsResolve
(
)
)
{
*
aResult
=
UsageInfo
(
DatabaseUsageType
(
Some
(
value
.
ResolveValue
(
)
)
)
)
;
}
else
{
*
aResult
=
UsageInfo
(
)
;
}
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
ClearStoragesForOrigin
(
const
OriginMetadata
&
aOriginMetadata
)
{
mozilla
:
:
ipc
:
:
PrincipalInfo
principalInfo
;
ASSERT_NO_FATAL_FAILURE
(
CreateContentPrincipalInfo
(
aOriginMetadata
.
mOrigin
principalInfo
)
)
;
PerformOnBackgroundThread
(
[
principalInfo
=
std
:
:
move
(
principalInfo
)
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
Await
(
quotaManager
-
>
ClearStoragesForOrigin
(
Nothing
(
)
principalInfo
)
)
;
}
)
;
}
void
QuotaManagerDependencyFixture
:
:
InitializeTemporaryClient
(
const
ClientMetadata
&
aClientMetadata
)
{
mozilla
:
:
ipc
:
:
PrincipalInfo
principalInfo
;
ASSERT_NO_FATAL_FAILURE
(
CreateContentPrincipalInfo
(
aClientMetadata
.
mOrigin
principalInfo
)
)
;
PerformOnBackgroundThread
(
[
persistenceType
=
aClientMetadata
.
mPersistenceType
principalInfo
=
std
:
:
move
(
principalInfo
)
clientType
=
aClientMetadata
.
mClientType
]
(
)
{
QuotaManager
*
quotaManager
=
QuotaManager
:
:
Get
(
)
;
ASSERT_TRUE
(
quotaManager
)
;
Await
(
quotaManager
-
>
InitializeTemporaryClient
(
persistenceType
principalInfo
clientType
)
)
;
}
)
;
}
PrincipalMetadata
QuotaManagerDependencyFixture
:
:
GetTestPrincipalMetadata
(
)
{
return
{
"
"
_ns
"
example
.
com
"
_ns
"
http
:
/
/
example
.
com
"
_ns
"
http
:
/
/
example
.
com
"
_ns
false
}
;
}
OriginMetadata
QuotaManagerDependencyFixture
:
:
GetTestOriginMetadata
(
)
{
return
{
GetTestPrincipalMetadata
(
)
PERSISTENCE_TYPE_DEFAULT
}
;
}
ClientMetadata
QuotaManagerDependencyFixture
:
:
GetTestClientMetadata
(
)
{
return
{
GetTestOriginMetadata
(
)
Client
:
:
SDB
}
;
}
PrincipalMetadata
QuotaManagerDependencyFixture
:
:
GetOtherTestPrincipalMetadata
(
)
{
return
{
"
"
_ns
"
other
-
example
.
com
"
_ns
"
http
:
/
/
other
-
example
.
com
"
_ns
"
http
:
/
/
other
-
example
.
com
"
_ns
false
}
;
}
OriginMetadata
QuotaManagerDependencyFixture
:
:
GetOtherTestOriginMetadata
(
)
{
return
{
GetOtherTestPrincipalMetadata
(
)
PERSISTENCE_TYPE_DEFAULT
}
;
}
ClientMetadata
QuotaManagerDependencyFixture
:
:
GetOtherTestClientMetadata
(
)
{
return
{
GetOtherTestOriginMetadata
(
)
Client
:
:
SDB
}
;
}
void
QuotaManagerDependencyFixture
:
:
EnsureQuotaManager
(
)
{
AutoJSAPI
jsapi
;
bool
ok
=
jsapi
.
Init
(
xpc
:
:
PrivilegedJunkScope
(
)
)
;
ASSERT_TRUE
(
ok
)
;
nsCOMPtr
<
nsIQuotaManagerService
>
qms
=
QuotaManagerService
:
:
GetOrCreate
(
)
;
ASSERT_TRUE
(
qms
)
;
nsCOMPtr
<
nsIQuotaRequest
>
request
;
nsresult
rv
=
qms
-
>
StorageName
(
getter_AddRefs
(
request
)
)
;
ASSERT_NS_SUCCEEDED
(
rv
)
;
RefPtr
<
RequestResolver
>
resolver
=
new
RequestResolver
(
)
;
rv
=
request
-
>
SetCallback
(
resolver
)
;
ASSERT_NS_SUCCEEDED
(
rv
)
;
SpinEventLoopUntil
(
"
Promise
is
fulfilled
"
_ns
[
&
resolver
]
(
)
{
return
resolver
-
>
IsDone
(
)
;
}
)
;
}
MOZ_RUNINIT
nsCOMPtr
<
nsISerialEventTarget
>
QuotaManagerDependencyFixture
:
:
sBackgroundTarget
;
}
