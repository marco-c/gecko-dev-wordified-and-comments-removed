#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
ScopedLogExtraInfo
.
h
"
using
namespace
mozilla
:
:
dom
:
:
quota
;
TEST
(
DOM_Quota_ScopedLogExtraInfo
AddAndRemove
)
{
static
constexpr
auto
text
=
"
foo
"
_ns
;
{
const
auto
extraInfo
=
ScopedLogExtraInfo
{
ScopedLogExtraInfo
:
:
kTagQueryTainted
text
}
;
#
ifdef
QM_SCOPED_LOG_EXTRA_INFO_ENABLED
const
auto
&
extraInfoMap
=
ScopedLogExtraInfo
:
:
GetExtraInfoMap
(
)
;
const
auto
&
queryValueTainted
=
*
extraInfoMap
.
at
(
ScopedLogExtraInfo
:
:
kTagQueryTainted
)
;
EXPECT_EQ
(
text
MOZ_NO_VALIDATE
(
queryValueTainted
"
It
'
s
ok
to
use
query
value
in
tests
.
"
)
)
;
#
endif
}
#
ifdef
QM_SCOPED_LOG_EXTRA_INFO_ENABLED
const
auto
&
extraInfoMap
=
ScopedLogExtraInfo
:
:
GetExtraInfoMap
(
)
;
EXPECT_EQ
(
0u
extraInfoMap
.
count
(
ScopedLogExtraInfo
:
:
kTagQueryTainted
)
)
;
#
endif
}
TEST
(
DOM_Quota_ScopedLogExtraInfo
Nested
)
{
static
constexpr
auto
text
=
"
foo
"
_ns
;
static
constexpr
auto
nestedText
=
"
bar
"
_ns
;
{
const
auto
extraInfo
=
ScopedLogExtraInfo
{
ScopedLogExtraInfo
:
:
kTagQueryTainted
text
}
;
{
const
auto
extraInfo
=
ScopedLogExtraInfo
{
ScopedLogExtraInfo
:
:
kTagQueryTainted
nestedText
}
;
#
ifdef
QM_SCOPED_LOG_EXTRA_INFO_ENABLED
const
auto
&
extraInfoMap
=
ScopedLogExtraInfo
:
:
GetExtraInfoMap
(
)
;
const
auto
&
queryValueTainted
=
*
extraInfoMap
.
at
(
ScopedLogExtraInfo
:
:
kTagQueryTainted
)
;
EXPECT_EQ
(
nestedText
MOZ_NO_VALIDATE
(
queryValueTainted
"
It
'
s
ok
to
use
query
value
in
tests
.
"
)
)
;
#
endif
}
#
ifdef
QM_SCOPED_LOG_EXTRA_INFO_ENABLED
const
auto
&
extraInfoMap
=
ScopedLogExtraInfo
:
:
GetExtraInfoMap
(
)
;
const
auto
&
queryValueTainted
=
*
extraInfoMap
.
at
(
ScopedLogExtraInfo
:
:
kTagQueryTainted
)
;
EXPECT_EQ
(
text
MOZ_NO_VALIDATE
(
queryValueTainted
"
It
'
s
ok
to
use
query
value
in
tests
.
"
)
)
;
#
endif
}
#
ifdef
QM_SCOPED_LOG_EXTRA_INFO_ENABLED
const
auto
&
extraInfoMap
=
ScopedLogExtraInfo
:
:
GetExtraInfoMap
(
)
;
EXPECT_EQ
(
0u
extraInfoMap
.
count
(
ScopedLogExtraInfo
:
:
kTagQueryTainted
)
)
;
#
endif
}
