var
testGenerator
=
testSteps
(
)
;
function
*
testSteps
(
)
{
const
origins
=
[
"
storage
/
default
/
chrome
/
"
"
storage
/
default
/
http
+
+
+
www
.
mozilla
.
org
/
"
]
;
const
paddingFilePath
=
"
cache
/
.
padding
"
;
const
packages
=
[
"
version2_0_profile
"
"
.
.
/
defaultStorageDirectory_shared
"
]
;
info
(
"
Clearing
"
)
;
clear
(
continueToNextStepSync
)
;
yield
undefined
;
info
(
"
Verifying
storage
"
)
;
verifyStorage
(
packages
"
beforeInstall
"
)
;
info
(
"
Installing
packages
"
)
;
installPackages
(
packages
)
;
info
(
"
Verifying
storage
"
)
;
verifyStorage
(
packages
"
afterInstall
"
)
;
info
(
"
Checking
padding
files
before
upgrade
(
storage
version
2
.
0
)
"
)
;
for
(
let
origin
of
origins
)
{
let
paddingFile
=
getRelativeFile
(
origin
+
paddingFilePath
)
;
let
exists
=
paddingFile
.
exists
(
)
;
ok
(
!
exists
"
Padding
file
doesn
'
t
exist
"
)
;
}
info
(
"
Initializing
"
)
;
let
request
=
init
(
continueToNextStepSync
)
;
yield
undefined
;
ok
(
request
.
resultCode
=
=
NS_OK
"
Initialization
succeeded
"
)
;
info
(
"
Verifying
storage
"
)
;
verifyStorage
(
packages
"
afterInit
"
)
;
info
(
"
Checking
padding
files
after
upgrade
"
)
;
for
(
let
origin
of
origins
)
{
let
paddingFile
=
getRelativeFile
(
origin
+
paddingFilePath
)
;
let
exists
=
paddingFile
.
exists
(
)
;
ok
(
exists
"
Padding
file
does
exist
"
)
;
info
(
"
Reading
out
contents
of
padding
file
"
)
;
File
.
createFromNsIFile
(
paddingFile
)
.
then
(
grabArgAndContinueHandler
)
;
let
domFile
=
yield
undefined
;
let
fileReader
=
new
FileReader
(
)
;
fileReader
.
onload
=
continueToNextStepSync
;
fileReader
.
readAsArrayBuffer
(
domFile
)
;
yield
undefined
;
let
paddingFileInfo
=
new
Float64Array
(
fileReader
.
result
)
;
ok
(
paddingFileInfo
.
length
=
=
1
"
Padding
file
does
take
64
bytes
.
"
)
;
ok
(
paddingFileInfo
[
0
]
=
=
0
"
Padding
size
does
default
to
zero
.
"
)
;
}
finishTest
(
)
;
}
