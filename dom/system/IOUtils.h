#
ifndef
mozilla_dom_IOUtils__
#
define
mozilla_dom_IOUtils__
#
include
"
mozilla
/
AlreadyAddRefed
.
h
"
#
include
"
mozilla
/
Buffer
.
h
"
#
include
"
mozilla
/
DataMutex
.
h
"
#
include
"
mozilla
/
dom
/
BindingDeclarations
.
h
"
#
include
"
mozilla
/
dom
/
IOUtilsBinding
.
h
"
#
include
"
mozilla
/
dom
/
TypedArray
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
Result
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nspr
/
prio
.
h
"
#
include
"
nsIAsyncShutdown
.
h
"
#
include
"
nsISerialEventTarget
.
h
"
#
include
"
nsLocalFile
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
nsString
.
h
"
namespace
mozilla
{
class
PR_CloseDelete
{
public
:
constexpr
PR_CloseDelete
(
)
=
default
;
PR_CloseDelete
(
const
PR_CloseDelete
&
aOther
)
=
default
;
PR_CloseDelete
(
PR_CloseDelete
&
&
aOther
)
=
default
;
PR_CloseDelete
&
operator
=
(
const
PR_CloseDelete
&
aOther
)
=
default
;
PR_CloseDelete
&
operator
=
(
PR_CloseDelete
&
&
aOther
)
=
default
;
void
operator
(
)
(
PRFileDesc
*
aPtr
)
const
{
PR_Close
(
aPtr
)
;
}
}
;
namespace
dom
{
class
IOUtils
final
{
public
:
class
IOError
;
static
already_AddRefed
<
Promise
>
Read
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
const
Optional
<
uint32_t
>
&
aMaxBytes
)
;
static
already_AddRefed
<
Promise
>
ReadUTF8
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
)
;
static
already_AddRefed
<
Promise
>
WriteAtomic
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
const
Uint8Array
&
aData
const
WriteAtomicOptions
&
aOptions
)
;
static
already_AddRefed
<
Promise
>
WriteAtomicUTF8
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
const
nsAString
&
aString
const
WriteAtomicOptions
&
aOptions
)
;
static
already_AddRefed
<
Promise
>
Move
(
GlobalObject
&
aGlobal
const
nsAString
&
aSourcePath
const
nsAString
&
aDestPath
const
MoveOptions
&
aOptions
)
;
static
already_AddRefed
<
Promise
>
Remove
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
const
RemoveOptions
&
aOptions
)
;
static
already_AddRefed
<
Promise
>
MakeDirectory
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
const
MakeDirectoryOptions
&
aOptions
)
;
static
already_AddRefed
<
Promise
>
Stat
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
)
;
static
already_AddRefed
<
Promise
>
Copy
(
GlobalObject
&
aGlobal
const
nsAString
&
aSourcePath
const
nsAString
&
aDestPath
const
CopyOptions
&
aOptions
)
;
static
already_AddRefed
<
Promise
>
Touch
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
const
Optional
<
int64_t
>
&
aModification
)
;
static
already_AddRefed
<
Promise
>
GetChildren
(
GlobalObject
&
aGlobal
const
nsAString
&
aPath
)
;
static
bool
IsAbsolutePath
(
const
nsAString
&
aPath
)
;
private
:
~
IOUtils
(
)
=
default
;
friend
class
IOUtilsShutdownBlocker
;
struct
InternalFileInfo
;
struct
InternalWriteAtomicOpts
;
static
StaticDataMutex
<
StaticRefPtr
<
nsISerialEventTarget
>
>
sBackgroundEventTarget
;
static
StaticRefPtr
<
nsIAsyncShutdownClient
>
sBarrier
;
static
Atomic
<
bool
>
sShutdownStarted
;
static
already_AddRefed
<
nsIAsyncShutdownClient
>
GetShutdownBarrier
(
)
;
static
already_AddRefed
<
nsISerialEventTarget
>
GetBackgroundEventTarget
(
)
;
static
void
SetShutdownHooks
(
)
;
template
<
typename
OkT
typename
Fn
typename
.
.
.
Args
>
static
already_AddRefed
<
Promise
>
RunOnBackgroundThread
(
RefPtr
<
Promise
>
&
aPromise
Fn
aFunc
Args
.
.
.
aArgs
)
;
static
already_AddRefed
<
Promise
>
CreateJSPromise
(
GlobalObject
&
aGlobal
)
;
friend
MOZ_MUST_USE
bool
ToJSValue
(
JSContext
*
aCx
const
InternalFileInfo
&
aInternalFileInfo
JS
:
:
MutableHandle
<
JS
:
:
Value
>
aValue
)
;
static
void
RejectJSPromise
(
const
RefPtr
<
Promise
>
&
aPromise
const
IOError
&
aError
)
;
static
UniquePtr
<
PRFileDesc
PR_CloseDelete
>
OpenExistingSync
(
const
nsAString
&
aPath
int32_t
aFlags
)
;
static
UniquePtr
<
PRFileDesc
PR_CloseDelete
>
CreateFileSync
(
const
nsAString
&
aPath
int32_t
aFlags
int32_t
aMode
=
0666
)
;
static
Result
<
nsTArray
<
uint8_t
>
IOError
>
ReadSync
(
const
nsAString
&
aPath
const
Maybe
<
uint32_t
>
&
aMaxBytes
)
;
static
Result
<
nsString
IOError
>
ReadUTF8Sync
(
const
nsAString
&
aPath
)
;
static
Result
<
uint32_t
IOError
>
WriteAtomicSync
(
const
nsAString
&
aDestPath
const
Span
<
const
uint8_t
>
&
aByteArray
const
InternalWriteAtomicOpts
&
aOptions
)
;
static
Result
<
uint32_t
IOError
>
WriteAtomicUTF8Sync
(
const
nsAString
&
aDestPath
const
nsCString
&
aUTF8String
const
InternalWriteAtomicOpts
&
aOptions
)
;
static
Result
<
uint32_t
IOError
>
WriteSync
(
PRFileDesc
*
aFd
const
nsACString
&
aPath
const
Span
<
const
uint8_t
>
&
aBytes
)
;
static
Result
<
Ok
IOError
>
MoveSync
(
const
nsAString
&
aSourcePath
const
nsAString
&
aDestPath
bool
aNoOverwrite
)
;
static
Result
<
Ok
IOError
>
CopySync
(
const
nsAString
&
aSourcePath
const
nsAString
&
aDestPath
bool
aNoOverWrite
bool
aRecursive
)
;
template
<
typename
CopyOrMoveFn
>
static
Result
<
Ok
IOError
>
CopyOrMoveSync
(
CopyOrMoveFn
aMethod
const
char
*
aMethodName
const
RefPtr
<
nsLocalFile
>
&
aSource
const
RefPtr
<
nsLocalFile
>
&
aDest
bool
aNoOverwrite
)
;
static
Result
<
Ok
IOError
>
RemoveSync
(
const
nsAString
&
aPath
bool
aIgnoreAbsent
bool
aRecursive
)
;
static
Result
<
Ok
IOError
>
CreateDirectorySync
(
const
nsAString
&
aPath
bool
aCreateAncestors
bool
aIgnoreExisting
int32_t
aMode
=
0777
)
;
static
Result
<
IOUtils
:
:
InternalFileInfo
IOError
>
StatSync
(
const
nsAString
&
aPath
)
;
static
Result
<
int64_t
IOError
>
TouchSync
(
const
nsAString
&
aPath
const
Maybe
<
int64_t
>
&
aNewModTime
)
;
static
Result
<
nsTArray
<
nsString
>
IOError
>
GetChildrenSync
(
const
nsAString
&
aPath
)
;
}
;
class
IOUtils
:
:
IOError
{
public
:
MOZ_IMPLICIT
IOError
(
nsresult
aCode
)
:
mCode
(
aCode
)
mMessage
(
Nothing
(
)
)
{
}
template
<
typename
.
.
.
Args
>
IOError
WithMessage
(
const
char
*
const
aMessage
Args
.
.
.
aArgs
)
{
mMessage
.
emplace
(
nsPrintfCString
(
aMessage
aArgs
.
.
.
)
)
;
return
*
this
;
}
IOError
WithMessage
(
const
char
*
const
aMessage
)
{
mMessage
.
emplace
(
nsCString
(
aMessage
)
)
;
return
*
this
;
}
IOError
WithMessage
(
nsCString
aMessage
)
{
mMessage
.
emplace
(
aMessage
)
;
return
*
this
;
}
nsresult
Code
(
)
const
{
return
mCode
;
}
const
Maybe
<
nsCString
>
&
Message
(
)
const
{
return
mMessage
;
}
private
:
nsresult
mCode
;
Maybe
<
nsCString
>
mMessage
;
}
;
struct
IOUtils
:
:
InternalFileInfo
{
nsString
mPath
;
FileType
mType
;
uint64_t
mSize
;
uint64_t
mLastModified
;
}
;
struct
IOUtils
:
:
InternalWriteAtomicOpts
{
Maybe
<
nsString
>
mBackupFile
;
bool
mFlush
;
bool
mNoOverwrite
;
Maybe
<
nsString
>
mTmpPath
;
static
inline
InternalWriteAtomicOpts
FromBinding
(
const
WriteAtomicOptions
&
aOptions
)
{
InternalWriteAtomicOpts
opts
;
opts
.
mFlush
=
aOptions
.
mFlush
;
opts
.
mNoOverwrite
=
aOptions
.
mNoOverwrite
;
if
(
aOptions
.
mBackupFile
.
WasPassed
(
)
)
{
opts
.
mBackupFile
.
emplace
(
aOptions
.
mBackupFile
.
Value
(
)
)
;
}
if
(
aOptions
.
mTmpPath
.
WasPassed
(
)
)
{
opts
.
mTmpPath
.
emplace
(
aOptions
.
mTmpPath
.
Value
(
)
)
;
}
return
opts
;
}
}
;
class
IOUtilsShutdownBlocker
:
public
nsIAsyncShutdownBlocker
{
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIASYNCSHUTDOWNBLOCKER
private
:
virtual
~
IOUtilsShutdownBlocker
(
)
=
default
;
}
;
}
}
#
endif
