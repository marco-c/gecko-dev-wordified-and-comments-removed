#
include
"
FramingChecker
.
h
"
#
include
"
nsCharSeparatedTokenizer
.
h
"
#
include
"
nsCSPUtils
.
h
"
#
include
"
nsDocShell
.
h
"
#
include
"
nsHttpChannel
.
h
"
#
include
"
nsIChannel
.
h
"
#
include
"
nsIConsoleService
.
h
"
#
include
"
nsIContentSecurityPolicy
.
h
"
#
include
"
nsIScriptError
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsQueryObject
.
h
"
#
include
"
mozilla
/
BasePrincipal
.
h
"
#
include
"
mozilla
/
dom
/
nsCSPUtils
.
h
"
#
include
"
mozilla
/
dom
/
LoadURIOptionsBinding
.
h
"
#
include
"
mozilla
/
dom
/
WindowGlobalParent
.
h
"
#
include
"
mozilla
/
NullPrincipal
.
h
"
#
include
"
nsIStringBundle
.
h
"
#
include
"
nsIObserverService
.
h
"
using
namespace
mozilla
;
void
FramingChecker
:
:
ReportError
(
const
char
*
aMessageTag
nsIURI
*
aParentURI
nsIURI
*
aChildURI
const
nsAString
&
aPolicy
uint64_t
aInnerWindowID
)
{
MOZ_ASSERT
(
aParentURI
"
Need
a
parent
URI
"
)
;
if
(
!
aChildURI
|
|
!
aParentURI
)
{
return
;
}
nsAutoCString
parentSpec
;
nsresult
rv
;
rv
=
aParentURI
-
>
GetAsciiSpec
(
parentSpec
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
nsAutoCString
childSpec
;
rv
=
aChildURI
-
>
GetAsciiSpec
(
childSpec
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
nsCOMPtr
<
nsIStringBundleService
>
bundleService
=
mozilla
:
:
services
:
:
GetStringBundleService
(
)
;
nsCOMPtr
<
nsIStringBundle
>
bundle
;
rv
=
bundleService
-
>
CreateBundle
(
"
chrome
:
/
/
global
/
locale
/
security
/
security
.
properties
"
getter_AddRefs
(
bundle
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
if
(
NS_WARN_IF
(
!
bundle
)
)
{
return
;
}
nsCOMPtr
<
nsIConsoleService
>
console
(
do_GetService
(
NS_CONSOLESERVICE_CONTRACTID
)
)
;
nsCOMPtr
<
nsIScriptError
>
error
(
do_CreateInstance
(
NS_SCRIPTERROR_CONTRACTID
)
)
;
if
(
!
console
|
|
!
error
)
{
return
;
}
nsAutoString
message
;
AutoTArray
<
nsString
3
>
formatStrings
;
formatStrings
.
AppendElement
(
aPolicy
)
;
CopyASCIItoUTF16
(
childSpec
*
formatStrings
.
AppendElement
(
)
)
;
CopyASCIItoUTF16
(
parentSpec
*
formatStrings
.
AppendElement
(
)
)
;
rv
=
bundle
-
>
FormatStringFromName
(
aMessageTag
formatStrings
message
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
rv
=
error
-
>
InitWithWindowID
(
message
EmptyString
(
)
EmptyString
(
)
0
0
nsIScriptError
:
:
errorFlag
"
X
-
Frame
-
Options
"
aInnerWindowID
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
console
-
>
LogMessage
(
error
)
;
}
void
FramingChecker
:
:
ReportError
(
const
char
*
aMessageTag
BrowsingContext
*
aParentContext
nsIURI
*
aChildURI
const
nsAString
&
aPolicy
uint64_t
aInnerWindowID
)
{
nsCOMPtr
<
nsIURI
>
parentURI
;
if
(
aParentContext
)
{
BrowsingContext
*
topContext
=
aParentContext
-
>
Top
(
)
;
WindowGlobalParent
*
window
=
topContext
-
>
Canonical
(
)
-
>
GetCurrentWindowGlobal
(
)
;
if
(
window
)
{
parentURI
=
window
-
>
GetDocumentURI
(
)
;
}
ReportError
(
aMessageTag
parentURI
aChildURI
aPolicy
aInnerWindowID
)
;
}
}
bool
FramingChecker
:
:
CheckOneFrameOptionsPolicy
(
nsIHttpChannel
*
aHttpChannel
const
nsAString
&
aPolicy
)
{
nsCOMPtr
<
nsIURI
>
uri
;
aHttpChannel
-
>
GetURI
(
getter_AddRefs
(
uri
)
)
;
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aHttpChannel
-
>
LoadInfo
(
)
;
uint64_t
innerWindowID
=
loadInfo
-
>
GetInnerWindowID
(
)
;
RefPtr
<
mozilla
:
:
dom
:
:
BrowsingContext
>
ctx
;
loadInfo
-
>
GetBrowsingContext
(
getter_AddRefs
(
ctx
)
)
;
if
(
!
aPolicy
.
LowerCaseEqualsLiteral
(
"
deny
"
)
&
&
!
aPolicy
.
LowerCaseEqualsLiteral
(
"
sameorigin
"
)
)
{
ReportError
(
"
XFOInvalid
"
ctx
uri
aPolicy
innerWindowID
)
;
return
true
;
}
bool
checkSameOrigin
=
aPolicy
.
LowerCaseEqualsLiteral
(
"
sameorigin
"
)
;
while
(
ctx
)
{
nsCOMPtr
<
nsIPrincipal
>
principal
;
WindowGlobalParent
*
window
=
ctx
-
>
Canonical
(
)
-
>
GetCurrentWindowGlobal
(
)
;
if
(
window
)
{
principal
=
window
-
>
DocumentPrincipal
(
)
;
}
if
(
principal
&
&
principal
-
>
IsSystemPrincipal
(
)
)
{
return
true
;
}
if
(
checkSameOrigin
)
{
bool
isPrivateWin
=
false
;
bool
isSameOrigin
=
false
;
if
(
principal
)
{
isPrivateWin
=
principal
-
>
OriginAttributesRef
(
)
.
mPrivateBrowsingId
>
0
;
principal
-
>
IsSameOrigin
(
uri
isPrivateWin
&
isSameOrigin
)
;
}
if
(
!
isSameOrigin
)
{
ReportError
(
"
XFOSameOrigin
"
ctx
uri
aPolicy
innerWindowID
)
;
return
false
;
}
}
ctx
=
ctx
-
>
GetParent
(
)
;
}
if
(
aPolicy
.
LowerCaseEqualsLiteral
(
"
deny
"
)
)
{
RefPtr
<
mozilla
:
:
dom
:
:
BrowsingContext
>
ctx
;
loadInfo
-
>
GetBrowsingContext
(
getter_AddRefs
(
ctx
)
)
;
ReportError
(
"
XFODeny
"
ctx
uri
aPolicy
innerWindowID
)
;
return
false
;
}
return
true
;
}
static
bool
ShouldIgnoreFrameOptions
(
nsIChannel
*
aChannel
nsIContentSecurityPolicy
*
aCSP
)
{
NS_ENSURE_TRUE
(
aChannel
false
)
;
if
(
!
aCSP
)
{
return
false
;
}
bool
enforcesFrameAncestors
=
false
;
aCSP
-
>
GetEnforcesFrameAncestors
(
&
enforcesFrameAncestors
)
;
if
(
!
enforcesFrameAncestors
)
{
return
false
;
}
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aChannel
-
>
LoadInfo
(
)
;
uint64_t
innerWindowID
=
loadInfo
-
>
GetInnerWindowID
(
)
;
bool
privateWindow
=
!
!
loadInfo
-
>
GetOriginAttributes
(
)
.
mPrivateBrowsingId
;
AutoTArray
<
nsString
2
>
params
=
{
NS_LITERAL_STRING
(
"
x
-
frame
-
options
"
)
NS_LITERAL_STRING
(
"
frame
-
ancestors
"
)
}
;
CSP_LogLocalizedStr
(
"
IgnoringSrcBecauseOfDirective
"
params
EmptyString
(
)
EmptyString
(
)
0
0
nsIScriptError
:
:
warningFlag
NS_LITERAL_CSTRING
(
"
IgnoringSrcBecauseOfDirective
"
)
innerWindowID
privateWindow
)
;
return
true
;
}
bool
FramingChecker
:
:
CheckFrameOptions
(
nsIChannel
*
aChannel
nsIContentSecurityPolicy
*
aCsp
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
"
check
frame
options
only
in
parent
"
)
;
if
(
!
aChannel
)
{
return
true
;
}
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aChannel
-
>
LoadInfo
(
)
;
nsContentPolicyType
contentType
=
loadInfo
-
>
GetExternalContentPolicyType
(
)
;
if
(
contentType
!
=
nsIContentPolicy
:
:
TYPE_SUBDOCUMENT
&
&
contentType
!
=
nsIContentPolicy
:
:
TYPE_OBJECT
)
{
return
true
;
}
if
(
ShouldIgnoreFrameOptions
(
aChannel
aCsp
)
)
{
return
true
;
}
if
(
loadInfo
-
>
TriggeringPrincipal
(
)
-
>
GetIsAddonOrExpandedAddonPrincipal
(
)
)
{
return
true
;
}
nsCOMPtr
<
nsIHttpChannel
>
httpChannel
;
nsresult
rv
=
nsContentSecurityUtils
:
:
GetHttpChannelFromPotentialMultiPart
(
aChannel
getter_AddRefs
(
httpChannel
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
true
;
}
if
(
!
httpChannel
)
{
return
true
;
}
uint32_t
responseStatus
;
rv
=
httpChannel
-
>
GetResponseStatus
(
&
responseStatus
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
true
;
}
if
(
mozilla
:
:
net
:
:
nsHttpChannel
:
:
IsRedirectStatus
(
responseStatus
)
)
{
return
true
;
}
nsAutoCString
xfoHeaderCValue
;
Unused
<
<
httpChannel
-
>
GetResponseHeader
(
NS_LITERAL_CSTRING
(
"
X
-
Frame
-
Options
"
)
xfoHeaderCValue
)
;
NS_ConvertUTF8toUTF16
xfoHeaderValue
(
xfoHeaderCValue
)
;
if
(
xfoHeaderValue
.
IsEmpty
(
)
)
{
return
true
;
}
nsCharSeparatedTokenizer
tokenizer
(
xfoHeaderValue
'
'
)
;
while
(
tokenizer
.
hasMoreTokens
(
)
)
{
const
nsAString
&
tok
=
tokenizer
.
nextToken
(
)
;
if
(
!
CheckOneFrameOptionsPolicy
(
httpChannel
tok
)
)
{
nsCOMPtr
<
nsIURI
>
uri
;
httpChannel
-
>
GetURI
(
getter_AddRefs
(
uri
)
)
;
nsCOMPtr
<
nsIObserverService
>
observerService
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
nsAutoString
policy
(
tok
)
;
observerService
-
>
NotifyObservers
(
uri
"
xfo
-
on
-
violate
-
policy
"
policy
.
get
(
)
)
;
return
false
;
}
}
return
true
;
}
