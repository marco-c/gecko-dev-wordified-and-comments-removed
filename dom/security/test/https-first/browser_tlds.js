"
use
strict
"
;
async
function
runTest
(
aURL
aExpectUpDowngrade
)
{
const
initialDowngradeCount
=
Glean
.
httpsfirst
.
downgraded
.
testGetValue
(
)
;
BrowserTestUtils
.
startLoadingURIString
(
gBrowser
aURL
)
;
await
BrowserTestUtils
.
browserLoaded
(
gBrowser
false
null
true
)
;
is
(
Glean
.
httpsfirst
.
downgraded
.
testGetValue
(
)
aExpectUpDowngrade
?
initialDowngradeCount
+
1
:
initialDowngradeCount
{
aExpectUpDowngrade
?
"
A
"
:
"
No
"
}
up
-
and
downgrade
should
have
happened
on
{
aURL
}
)
;
}
add_task
(
async
function
test_tlds
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
security
.
https_first
"
true
]
]
}
)
;
await
runTest
(
"
http
:
/
/
httpsfirst
.
com
"
true
)
;
await
runTest
(
"
http
:
/
/
httpsfirst
.
local
"
false
)
;
await
runTest
(
"
http
:
/
/
httpsfirst
"
false
)
;
}
)
;
