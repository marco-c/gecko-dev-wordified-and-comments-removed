"
use
strict
"
;
const
testPath
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
http
:
/
/
httpsfirst
.
com
"
)
;
let
tests
=
[
{
description
:
"
Top
-
Level
upgrade
should
get
logged
"
expectLogLevel
:
Ci
.
nsIConsoleMessage
.
warn
expectIncludes
:
[
"
Upgrading
insecure
request
"
"
to
use
"
"
httpsfirst
.
com
"
]
}
{
description
:
"
Top
-
Level
upgrade
failure
should
get
logged
"
expectLogLevel
:
Ci
.
nsIConsoleMessage
.
warn
expectIncludes
:
[
"
Upgrading
insecure
request
"
"
failed
"
"
httpsfirst
.
com
"
"
Downgrading
to
"
]
}
]
;
const
kTestURI
=
testPath
+
"
file_mixed_content_auto_upgrade
.
html
"
;
add_task
(
async
function
(
)
{
requestLongerTimeout
(
4
)
;
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
security
.
mixed_content
.
upgrade_display_content
"
true
]
[
"
dom
.
security
.
https_first
"
true
]
]
}
)
;
Services
.
console
.
registerListener
(
on_new_message
)
;
await
BrowserTestUtils
.
loadURI
(
gBrowser
.
selectedBrowser
kTestURI
)
;
await
BrowserTestUtils
.
waitForCondition
(
(
)
=
>
tests
.
length
=
=
=
0
)
;
Services
.
console
.
unregisterListener
(
on_new_message
)
;
}
)
;
function
on_new_message
(
msgObj
)
{
const
message
=
msgObj
.
message
;
const
logLevel
=
msgObj
.
logLevel
;
if
(
message
.
includes
(
"
Mixed
Content
:
"
)
)
{
ok
(
!
message
.
includes
(
"
Upgrading
insecure
display
request
"
)
"
msg
included
a
mixed
content
upgrade
"
)
;
}
if
(
message
.
includes
(
"
HTTPS
-
First
Mode
:
"
)
)
{
for
(
let
i
=
0
;
i
<
tests
.
length
;
i
+
+
)
{
const
testCase
=
tests
[
i
]
;
if
(
logLevel
!
=
=
testCase
.
expectLogLevel
)
{
continue
;
}
if
(
testCase
.
expectIncludes
.
some
(
str
=
>
!
message
.
includes
(
str
)
)
)
{
continue
;
}
ok
(
true
testCase
.
description
)
;
tests
.
splice
(
i
1
)
;
break
;
}
}
}
