'
use
strict
'
;
requestLongerTimeout
(
10
)
;
const
{
ManifestObtainer
}
=
Cu
.
import
(
'
resource
:
/
/
gre
/
modules
/
ManifestObtainer
.
jsm
'
{
}
)
;
const
path
=
'
/
tests
/
dom
/
security
/
test
/
csp
/
'
;
const
testFile
=
file
=
{
path
}
file_web_manifest
.
html
;
const
remoteFile
=
file
=
{
path
}
file_web_manifest_remote
.
html
;
const
httpsManifest
=
file
=
{
path
}
file_web_manifest_https
.
html
;
const
server
=
'
file_testserver
.
sjs
'
;
const
defaultURL
=
http
:
/
/
example
.
org
{
path
}
{
server
}
;
const
secureURL
=
https
:
/
/
example
.
com
:
443
{
path
}
{
server
}
;
const
tests
=
[
{
expected
:
default
-
src
'
none
'
blocks
fetching
manifest
.
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
default
-
src
'
none
'
testFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
topic
)
{
is
(
topic
'
csp
-
on
-
violate
-
policy
'
this
.
expected
)
;
}
}
{
expected
:
default
-
src
mochi
.
test
:
8888
blocks
manifest
fetching
.
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
default
-
src
mochi
.
test
:
8888
testFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
topic
)
{
is
(
topic
'
csp
-
on
-
violate
-
policy
'
this
.
expected
)
;
}
}
{
expected
:
CSP
default
-
src
'
self
'
allows
fetch
of
manifest
.
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
default
-
src
'
self
'
testFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
manifest
)
{
is
(
manifest
.
name
'
loaded
'
this
.
expected
)
;
}
}
{
expected
:
'
CSP
default
-
src
mochi
.
test
:
8888
allows
fetching
manifest
.
'
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
default
-
src
http
:
/
/
mochi
.
test
:
8888
remoteFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
manifest
)
{
is
(
manifest
.
name
'
loaded
'
this
.
expected
)
;
}
}
{
expected
:
default
-
src
'
none
'
blocks
mochi
.
test
:
8888
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
default
-
src
'
none
'
remoteFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
topic
)
{
is
(
topic
'
csp
-
on
-
violate
-
policy
'
this
.
expected
)
;
}
}
{
expected
:
CSP
manifest
-
src
allows
self
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
manifest
-
src
'
self
'
testFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
manifest
)
{
is
(
manifest
.
name
'
loaded
'
this
.
expected
)
;
}
}
{
expected
:
CSP
manifest
-
src
allows
http
:
/
/
example
.
org
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
manifest
-
src
http
:
/
/
example
.
org
testFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
manifest
)
{
is
(
manifest
.
name
'
loaded
'
this
.
expected
)
;
}
}
{
expected
:
CSP
manifest
-
src
allows
mochi
.
test
:
8888
get
tabURL
(
)
{
let
queryParts
=
[
cors
=
*
csp
=
default
-
src
*
;
manifest
-
src
http
:
/
/
mochi
.
test
:
8888
remoteFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
manifest
)
{
is
(
manifest
.
name
'
loaded
'
this
.
expected
)
;
}
}
{
expected
:
CSP
blocks
manifest
fetching
from
example
.
org
.
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
manifest
-
src
mochi
.
test
:
8888
testFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
topic
)
{
is
(
topic
'
csp
-
on
-
violate
-
policy
'
this
.
expected
)
;
}
}
{
expected
:
CSP
manifest
-
src
'
self
'
blocks
cross
-
origin
fetch
.
get
tabURL
(
)
{
let
queryParts
=
[
csp
=
manifest
-
src
'
self
'
remoteFile
]
;
return
{
defaultURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
topic
)
{
is
(
topic
'
csp
-
on
-
violate
-
policy
'
this
.
expected
)
;
}
}
{
expected
:
CSP
manifest
-
src
allows
example
.
com
over
TLS
get
tabURL
(
)
{
let
queryParts
=
[
'
cors
=
*
'
'
csp
=
manifest
-
src
https
:
/
/
example
.
com
:
443
'
httpsManifest
]
;
return
{
secureURL
}
?
{
queryParts
.
join
(
'
&
'
)
}
;
}
run
(
manifest
)
{
is
(
manifest
.
name
'
loaded
'
this
.
expected
)
;
}
}
]
;
add_task
(
function
*
(
)
{
var
testPromises
=
tests
.
map
(
(
test
)
=
>
(
[
test
{
gBrowser
url
:
test
.
tabURL
skipAnimation
:
true
}
]
)
)
.
map
(
(
[
test
tabOptions
]
)
=
>
BrowserTestUtils
.
withNewTab
(
tabOptions
(
browser
)
=
>
testObtainingManifest
(
browser
test
)
)
)
;
yield
Promise
.
all
(
testPromises
)
;
}
)
;
function
*
testObtainingManifest
(
aBrowser
aTest
)
{
const
expectsBlocked
=
aTest
.
expected
.
includes
(
'
block
'
)
;
const
observer
=
(
expectsBlocked
)
?
createNetObserver
(
aTest
)
:
null
;
try
{
const
manifest
=
yield
ManifestObtainer
.
browserObtainManifest
(
aBrowser
)
;
aTest
.
run
(
manifest
)
;
}
catch
(
e
)
{
const
wasBlocked
=
e
.
message
.
includes
(
'
blocked
the
loading
of
a
resource
'
)
;
ok
(
wasBlocked
Expected
promise
rejection
obtaining
{
aTest
.
tabURL
}
:
{
e
.
message
}
)
;
if
(
observer
)
{
yield
observer
.
untilFinished
;
return
;
}
throw
e
;
}
}
function
createNetObserver
(
test
)
{
let
finishedTest
;
let
success
=
false
;
const
finished
=
new
Promise
(
(
resolver
)
=
>
{
finishedTest
=
resolver
;
}
)
;
const
timeoutId
=
setTimeout
(
(
)
=
>
{
if
(
!
success
)
{
test
.
run
(
'
This
test
timed
out
.
'
)
;
finishedTest
(
)
;
}
}
1000
)
;
var
observer
=
{
get
untilFinished
(
)
{
return
finished
;
}
observe
(
subject
topic
)
{
SpecialPowers
.
removeObserver
(
observer
'
csp
-
on
-
violate
-
policy
'
)
;
test
.
run
(
topic
)
;
finishedTest
(
)
;
clearTimeout
(
timeoutId
)
;
success
=
true
;
}
}
;
SpecialPowers
.
addObserver
(
observer
'
csp
-
on
-
violate
-
policy
'
false
)
;
return
observer
;
}
