var
Cc
=
Components
.
classes
;
var
Ci
=
Components
.
interfaces
;
var
Cu
=
Components
.
utils
;
var
Cr
=
Components
.
results
;
Cu
.
import
(
'
resource
:
/
/
gre
/
modules
/
NetUtil
.
jsm
'
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
testing
-
common
/
httpd
.
js
"
)
;
var
httpServer
=
new
HttpServer
(
)
;
httpServer
.
start
(
-
1
)
;
var
testsToFinish
=
0
;
var
principal
;
const
REPORT_SERVER_PORT
=
httpServer
.
identity
.
primaryPort
;
const
REPORT_SERVER_URI
=
"
http
:
/
/
localhost
"
;
const
REPORT_SERVER_PATH
=
"
/
report
"
;
function
makeReportHandler
(
testpath
message
expectedJSON
)
{
return
function
(
request
response
)
{
if
(
request
.
method
!
=
=
"
POST
"
)
{
do_throw
(
"
violation
report
should
be
a
POST
request
"
)
;
return
;
}
var
reportObj
=
JSON
.
parse
(
NetUtil
.
readInputStreamToString
(
request
.
bodyInputStream
request
.
bodyInputStream
.
available
(
)
)
)
;
for
(
var
i
in
expectedJSON
)
do_check_eq
(
expectedJSON
[
i
]
reportObj
[
'
csp
-
report
'
]
[
i
]
)
;
testsToFinish
-
-
;
httpServer
.
registerPathHandler
(
testpath
null
)
;
if
(
testsToFinish
<
1
)
httpServer
.
stop
(
do_test_finished
)
;
else
do_test_finished
(
)
;
}
;
}
function
makeTest
(
id
expectedJSON
useReportOnlyPolicy
callback
)
{
testsToFinish
+
+
;
do_test_pending
(
)
;
var
csp
=
Cc
[
"
mozilla
.
org
/
cspcontext
;
1
"
]
.
createInstance
(
Ci
.
nsIContentSecurityPolicy
)
;
var
policy
=
"
default
-
src
'
none
'
;
"
+
"
report
-
uri
"
+
REPORT_SERVER_URI
+
"
:
"
+
REPORT_SERVER_PORT
+
"
/
test
"
+
id
;
var
selfuri
=
NetUtil
.
newURI
(
REPORT_SERVER_URI
+
"
:
"
+
REPORT_SERVER_PORT
+
"
/
foo
/
self
"
)
;
dump
(
"
Created
test
"
+
id
+
"
:
"
+
policy
+
"
\
n
\
n
"
)
;
let
ssm
=
Cc
[
"
mozilla
.
org
/
scriptsecuritymanager
;
1
"
]
.
getService
(
Ci
.
nsIScriptSecurityManager
)
;
principal
=
ssm
.
getSimpleCodebasePrincipal
(
selfuri
)
;
csp
.
setRequestContext
(
null
principal
)
;
csp
.
appendPolicy
(
policy
useReportOnlyPolicy
false
)
;
var
handler
=
makeReportHandler
(
"
/
test
"
+
id
"
Test
"
+
id
expectedJSON
)
;
httpServer
.
registerPathHandler
(
"
/
test
"
+
id
handler
)
;
callback
(
csp
)
;
}
function
run_test
(
)
{
var
selfuri
=
NetUtil
.
newURI
(
REPORT_SERVER_URI
+
"
:
"
+
REPORT_SERVER_PORT
+
"
/
foo
/
self
"
)
;
makeTest
(
0
{
"
blocked
-
uri
"
:
"
self
"
}
false
function
(
csp
)
{
let
inlineOK
=
true
;
inlineOK
=
csp
.
getAllowsInline
(
Ci
.
nsIContentPolicy
.
TYPE_SCRIPT
"
"
"
"
0
)
;
do_check_false
(
inlineOK
)
;
}
)
;
makeTest
(
1
{
"
blocked
-
uri
"
:
"
self
"
}
false
function
(
csp
)
{
let
evalOK
=
true
oReportViolation
=
{
'
value
'
:
false
}
;
evalOK
=
csp
.
getAllowsEval
(
oReportViolation
)
;
do_check_false
(
evalOK
)
;
do_check_true
(
oReportViolation
.
value
)
;
if
(
oReportViolation
.
value
)
{
csp
.
logViolationDetails
(
Ci
.
nsIContentSecurityPolicy
.
VIOLATION_TYPE_EVAL
selfuri
.
asciiSpec
"
script
sample
"
1
)
;
}
}
)
;
makeTest
(
2
{
"
blocked
-
uri
"
:
"
http
:
/
/
blocked
.
test
"
}
false
function
(
csp
)
{
csp
.
shouldLoad
(
Ci
.
nsIContentPolicy
.
TYPE_SCRIPT
NetUtil
.
newURI
(
"
http
:
/
/
blocked
.
test
/
foo
.
js
"
)
null
null
null
null
)
;
}
)
;
makeTest
(
3
{
"
blocked
-
uri
"
:
"
self
"
}
true
function
(
csp
)
{
let
inlineOK
=
true
;
inlineOK
=
csp
.
getAllowsInline
(
Ci
.
nsIContentPolicy
.
TYPE_SCRIPT
"
"
"
"
0
)
;
do_check_true
(
inlineOK
)
;
}
)
;
makeTest
(
4
{
"
blocked
-
uri
"
:
"
self
"
}
true
function
(
csp
)
{
let
evalOK
=
true
oReportViolation
=
{
'
value
'
:
false
}
;
evalOK
=
csp
.
getAllowsEval
(
oReportViolation
)
;
do_check_true
(
evalOK
)
;
do_check_true
(
oReportViolation
.
value
)
;
if
(
oReportViolation
.
value
)
{
csp
.
logViolationDetails
(
Ci
.
nsIContentSecurityPolicy
.
VIOLATION_TYPE_INLINE_SCRIPT
selfuri
.
asciiSpec
"
script
sample
"
4
)
;
}
}
)
;
makeTest
(
5
{
"
blocked
-
uri
"
:
"
data
"
}
false
function
(
csp
)
{
var
base64data
=
"
iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12
"
+
"
P4
/
/
8
/
w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg
=
=
"
;
csp
.
shouldLoad
(
Ci
.
nsIContentPolicy
.
TYPE_IMAGE
NetUtil
.
newURI
(
"
data
:
image
/
png
;
base64
"
+
base64data
)
null
null
null
null
)
;
}
)
;
makeTest
(
6
{
"
blocked
-
uri
"
:
"
intent
"
}
false
function
(
csp
)
{
csp
.
shouldLoad
(
Ci
.
nsIContentPolicy
.
TYPE_SUBDOCUMENT
NetUtil
.
newURI
(
"
intent
:
/
/
mymaps
.
com
/
maps
?
um
=
1
&
ie
=
UTF
-
8
&
fb
=
1
&
sll
"
)
null
null
null
null
)
;
}
)
;
var
selfSpec
=
REPORT_SERVER_URI
+
"
:
"
+
REPORT_SERVER_PORT
+
"
/
foo
/
self
/
foo
.
js
"
;
makeTest
(
7
{
"
blocked
-
uri
"
:
selfSpec
}
false
function
(
csp
)
{
var
uri
=
NetUtil
csp
.
shouldLoad
(
Ci
.
nsIContentPolicy
.
TYPE_SCRIPT
NetUtil
.
newURI
(
selfSpec
+
"
#
bar
"
)
null
null
null
null
)
;
}
)
;
}
