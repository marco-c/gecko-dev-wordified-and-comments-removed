'
use
strict
'
;
var
TOP_URI
=
"
https
:
/
/
example
.
com
/
browser
/
dom
/
security
/
test
/
hsts
/
file_priming
-
top
.
html
"
;
var
test_servers
=
{
'
no
-
ssl
'
:
{
host
:
'
example
.
co
.
jp
'
response
:
false
id
:
'
no
-
ssl
'
}
'
reject
-
upgrade
'
:
{
host
:
'
example
.
org
'
response
:
true
id
:
'
reject
-
upgrade
'
}
'
prime
-
hsts
'
:
{
host
:
'
test1
.
example
.
com
'
response
:
true
id
:
'
prime
-
hsts
'
}
}
;
var
test_settings
=
{
allow_active
:
{
block_active
:
false
block_display
:
false
use_hsts
:
true
send_hsts_priming
:
true
type
:
'
script
'
result
:
{
'
no
-
ssl
'
:
'
insecure
'
'
reject
-
upgrade
'
:
'
insecure
'
'
prime
-
hsts
'
:
'
secure
'
}
}
block_active
:
{
block_active
:
true
block_display
:
false
use_hsts
:
true
send_hsts_priming
:
true
type
:
'
script
'
result
:
{
'
no
-
ssl
'
:
'
blocked
'
'
reject
-
upgrade
'
:
'
blocked
'
'
prime
-
hsts
'
:
'
secure
'
}
}
hsts_after_mixed
:
{
block_active
:
true
block_display
:
false
use_hsts
:
false
send_hsts_priming
:
true
type
:
'
script
'
result
:
{
'
no
-
ssl
'
:
'
blocked
'
'
reject
-
upgrade
'
:
'
blocked
'
'
prime
-
hsts
'
:
'
blocked
'
}
}
allow_display
:
{
block_active
:
true
block_display
:
false
use_hsts
:
true
send_hsts_priming
:
true
type
:
'
img
'
result
:
{
'
no
-
ssl
'
:
'
insecure
'
'
reject
-
upgrade
'
:
'
insecure
'
'
prime
-
hsts
'
:
'
secure
'
}
}
block_display
:
{
block_active
:
true
block_display
:
true
use_hsts
:
true
send_hsts_priming
:
true
type
:
'
img
'
result
:
{
'
no
-
ssl
'
:
'
blocked
'
'
reject
-
upgrade
'
:
'
blocked
'
'
prime
-
hsts
'
:
'
secure
'
}
}
block_active_css
:
{
block_active
:
true
block_display
:
false
use_hsts
:
true
send_hsts_priming
:
true
type
:
'
css
'
result
:
{
'
no
-
ssl
'
:
'
blocked
'
'
reject
-
upgrade
'
:
'
blocked
'
'
prime
-
hsts
'
:
'
secure
'
}
}
block_active_with_redir_same
:
{
block_active
:
true
block_display
:
false
use_hsts
:
true
send_hsts_priming
:
true
type
:
'
script
'
redir
:
'
same
'
result
:
{
'
no
-
ssl
'
:
'
blocked
'
'
reject
-
upgrade
'
:
'
blocked
'
'
prime
-
hsts
'
:
'
secure
'
}
}
}
var
which_test
=
"
"
;
const
Observer
=
{
observe
:
function
(
subject
topic
data
)
{
switch
(
topic
)
{
case
'
console
-
api
-
log
-
event
'
:
return
Observer
.
console_api_log_event
(
subject
topic
data
)
;
case
'
http
-
on
-
examine
-
response
'
:
return
Observer
.
http_on_examine_response
(
subject
topic
data
)
;
}
throw
"
Can
'
t
handle
topic
"
+
topic
;
}
console_api_log_event
:
function
(
subject
topic
data
)
{
var
message
=
subject
.
wrappedJSObject
.
arguments
[
0
]
;
var
re
=
RegExp
(
/
^
HSTS_PRIMING
:
Blocked
(
[
-
\
w
]
+
)
.
*
/
)
;
if
(
!
re
.
test
(
message
)
)
{
return
;
}
let
id
=
message
.
replace
(
re
'
1
'
)
;
let
curTest
=
test_servers
[
id
]
;
if
(
!
curTest
)
{
ok
(
false
"
HSTS
priming
got
a
console
message
blocked
"
+
"
but
doesn
'
t
match
expectations
"
+
id
+
"
(
msg
=
"
+
message
)
;
return
;
}
is
(
"
blocked
"
test_settings
[
which_test
]
.
result
[
curTest
.
id
]
"
HSTS
priming
"
+
which_test
+
"
:
"
+
curTest
.
id
+
"
expected
"
+
test_settings
[
which_test
]
.
result
[
curTest
.
id
]
+
"
got
blocked
"
)
;
test_settings
[
which_test
]
.
finished
[
curTest
.
id
]
=
"
blocked
"
;
}
http_on_examine_response
:
function
(
subject
topic
data
)
{
let
curTest
=
null
;
let
channel
=
subject
.
QueryInterface
(
Ci
.
nsIHttpChannel
)
;
for
(
let
item
in
test_servers
)
{
let
re
=
RegExp
(
'
https
?
:
/
/
'
+
test_servers
[
item
]
.
host
)
;
if
(
re
.
test
(
channel
.
URI
.
asciiSpec
)
)
{
curTest
=
test_servers
[
item
]
;
break
;
}
}
if
(
!
curTest
)
{
return
;
}
let
result
=
(
channel
.
URI
.
asciiSpec
.
startsWith
(
'
https
:
'
)
)
?
"
secure
"
:
"
insecure
"
;
if
(
channel
.
requestMethod
=
=
'
HEAD
'
)
{
is
(
true
curTest
.
response
"
HSTS
priming
response
found
"
+
curTest
.
id
)
;
test_settings
[
which_test
]
.
priming
[
curTest
.
id
]
=
true
;
return
;
}
is
(
result
test_settings
[
which_test
]
.
result
[
curTest
.
id
]
"
HSTS
priming
result
"
+
which_test
+
"
:
"
+
curTest
.
id
)
;
test_settings
[
which_test
]
.
finished
[
curTest
.
id
]
=
result
;
}
}
;
function
openTab
(
uri
)
{
let
tab
=
gBrowser
.
addTab
(
uri
)
;
gBrowser
.
selectedTab
=
tab
;
tab
.
ownerDocument
.
defaultView
.
focus
(
)
;
return
tab
;
}
function
clear_sts_data
(
)
{
for
(
let
test
in
test_servers
)
{
SpecialPowers
.
cleanUpSTSData
(
'
http
:
/
/
'
+
test_servers
[
test
]
.
host
)
;
}
}
function
do_cleanup
(
)
{
clear_sts_data
(
)
;
Services
.
obs
.
removeObserver
(
Observer
"
console
-
api
-
log
-
event
"
)
;
Services
.
obs
.
removeObserver
(
Observer
"
http
-
on
-
examine
-
response
"
)
;
}
function
SetupPrefTestEnvironment
(
which
)
{
which_test
=
which
;
clear_sts_data
(
)
;
var
settings
=
test_settings
[
which
]
;
settings
.
priming
=
{
}
;
settings
.
finished
=
{
}
;
SpecialPowers
.
pushPrefEnv
(
{
'
set
'
:
[
[
"
security
.
mixed_content
.
block_active_content
"
settings
.
block_active
]
[
"
security
.
mixed_content
.
block_display_content
"
settings
.
block_display
]
[
"
security
.
mixed_content
.
use_hsts
"
settings
.
use_hsts
]
[
"
security
.
mixed_content
.
send_hsts_priming
"
settings
.
send_hsts_priming
]
]
}
)
;
}
function
build_test_uri
(
base_uri
host
test_id
type
)
{
return
base_uri
+
"
?
host
=
"
+
escape
(
host
)
+
"
&
id
=
"
+
escape
(
test_id
)
+
"
&
type
=
"
+
escape
(
type
)
;
}
function
execute_test
(
test
mimetype
)
{
var
src
=
build_test_uri
(
TOP_URI
test_servers
[
test
]
.
host
test
test_settings
[
which_test
]
.
type
)
;
let
tab
=
openTab
(
src
)
;
test_servers
[
test
]
[
'
tab
'
]
=
tab
;
let
browser
=
gBrowser
.
getBrowserForTab
(
tab
)
;
yield
BrowserTestUtils
.
browserLoaded
(
browser
)
;
yield
BrowserTestUtils
.
removeTab
(
tab
)
;
}
