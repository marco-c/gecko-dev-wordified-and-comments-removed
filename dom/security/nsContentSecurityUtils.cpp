#
include
"
nsContentSecurityUtils
.
h
"
#
include
"
nsIContentSecurityPolicy
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
if
defined
(
DEBUG
)
&
&
!
defined
(
ANDROID
)
void
nsContentSecurityUtils
:
:
AssertAboutPageHasCSP
(
Document
*
aDocument
)
{
if
(
Preferences
:
:
GetBool
(
"
csp
.
skip_about_page_has_csp_assert
"
)
)
{
return
;
}
nsCOMPtr
<
nsIURI
>
documentURI
=
aDocument
-
>
GetDocumentURI
(
)
;
if
(
!
documentURI
-
>
SchemeIs
(
"
about
"
)
)
{
return
;
}
nsCOMPtr
<
nsIContentSecurityPolicy
>
csp
=
aDocument
-
>
GetCsp
(
)
;
bool
foundDefaultSrc
=
false
;
if
(
csp
)
{
uint32_t
policyCount
=
0
;
csp
-
>
GetPolicyCount
(
&
policyCount
)
;
nsAutoString
parsedPolicyStr
;
for
(
uint32_t
i
=
0
;
i
<
policyCount
;
+
+
i
)
{
csp
-
>
GetPolicyString
(
i
parsedPolicyStr
)
;
if
(
parsedPolicyStr
.
Find
(
"
default
-
src
"
)
>
=
0
)
{
foundDefaultSrc
=
true
;
break
;
}
}
}
if
(
Preferences
:
:
GetBool
(
"
csp
.
skip_about_page_csp_allowlist_and_assert
"
)
)
{
NS_ASSERTION
(
foundDefaultSrc
"
about
:
page
must
have
a
CSP
"
)
;
return
;
}
nsAutoCString
aboutSpec
;
documentURI
-
>
GetSpec
(
aboutSpec
)
;
ToLowerCase
(
aboutSpec
)
;
static
nsLiteralCString
sAllowedAboutPagesWithNoCSP
[
]
=
{
NS_LITERAL_CSTRING
(
"
about
:
blank
"
)
NS_LITERAL_CSTRING
(
"
about
:
srcdoc
"
)
NS_LITERAL_CSTRING
(
"
about
:
sync
-
log
"
)
NS_LITERAL_CSTRING
(
"
about
:
printpreview
"
)
NS_LITERAL_CSTRING
(
"
about
:
downloads
"
)
}
;
for
(
const
nsLiteralCString
&
allowlistEntry
:
sAllowedAboutPagesWithNoCSP
)
{
if
(
StringBeginsWith
(
aboutSpec
allowlistEntry
)
)
{
return
;
}
}
MOZ_ASSERT
(
foundDefaultSrc
"
about
:
page
must
contain
a
CSP
including
default
-
src
"
)
;
}
#
endif
