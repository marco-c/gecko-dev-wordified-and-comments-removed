#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
BasePrincipal
.
h
"
#
include
"
mozilla
/
dom
/
Feature
.
h
"
#
include
"
mozilla
/
dom
/
FeaturePolicyParser
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsTArray
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
#
define
URL_SELF
NS_LITERAL_CSTRING
(
"
https
:
/
/
example
.
com
"
)
#
define
URL_EXAMPLE_COM
NS_LITERAL_CSTRING
(
"
http
:
/
/
example
.
com
"
)
#
define
URL_EXAMPLE_NET
NS_LITERAL_CSTRING
(
"
http
:
/
/
example
.
net
"
)
void
CheckParser
(
const
nsAString
&
aInput
bool
aExpectedResults
uint32_t
aExpectedFeatures
nsTArray
<
Feature
>
&
aParsedFeatures
)
{
nsCOMPtr
<
nsIPrincipal
>
principal
=
mozilla
:
:
BasePrincipal
:
:
CreateCodebasePrincipal
(
URL_SELF
)
;
nsTArray
<
Feature
>
parsedFeatures
;
ASSERT_TRUE
(
FeaturePolicyParser
:
:
ParseString
(
aInput
nullptr
principal
principal
parsedFeatures
)
=
=
aExpectedResults
)
;
ASSERT_TRUE
(
parsedFeatures
.
Length
(
)
=
=
aExpectedFeatures
)
;
parsedFeatures
.
SwapElements
(
aParsedFeatures
)
;
}
TEST
(
FeaturePolicyParser
Basic
)
{
nsCOMPtr
<
nsIPrincipal
>
selfPrincipal
=
mozilla
:
:
BasePrincipal
:
:
CreateCodebasePrincipal
(
URL_SELF
)
;
nsCOMPtr
<
nsIPrincipal
>
exampleComPrincipal
=
mozilla
:
:
BasePrincipal
:
:
CreateCodebasePrincipal
(
URL_EXAMPLE_COM
)
;
nsCOMPtr
<
nsIPrincipal
>
exampleNetPrincipal
=
mozilla
:
:
BasePrincipal
:
:
CreateCodebasePrincipal
(
URL_EXAMPLE_NET
)
;
nsTArray
<
Feature
>
parsedFeatures
;
CheckParser
(
EmptyString
(
)
true
0
parsedFeatures
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
"
)
true
0
parsedFeatures
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
non
-
existing
-
feature
"
)
true
0
parsedFeatures
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
non
-
existing
-
feature
;
another
-
feature
"
)
true
0
parsedFeatures
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
;
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
;
camera
;
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
;
microphone
"
)
true
2
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
1
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
microphone
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
1
]
.
HasAllowList
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
;
microphone
"
)
true
2
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
1
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
microphone
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
1
]
.
HasAllowList
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
;
microphone
;
foobar
"
)
true
2
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
1
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
microphone
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
1
]
.
HasAllowList
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
'
self
'
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
selfPrincipal
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
'
self
'
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
selfPrincipal
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
'
self
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
HasAllowList
(
)
)
;
ASSERT_TRUE
(
!
parsedFeatures
[
0
]
.
AllowListContains
(
selfPrincipal
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
'
selF
'
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
selfPrincipal
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
*
'
self
'
none
'
a
.
com
123
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowsAll
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
'
none
'
a
.
com
b
.
org
c
.
net
d
.
co
.
uk
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowsNone
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
*
a
.
com
b
.
org
c
.
net
d
.
co
.
uk
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowsAll
(
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
'
self
'
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
selfPrincipal
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
http
:
/
/
example
.
com
http
:
/
/
example
.
net
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
!
parsedFeatures
[
0
]
.
AllowListContains
(
selfPrincipal
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
exampleComPrincipal
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
exampleNetPrincipal
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
http
:
/
/
example
.
com
'
self
'
http
:
/
/
example
.
net
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
selfPrincipal
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
exampleComPrincipal
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowListContains
(
exampleNetPrincipal
)
)
;
CheckParser
(
NS_LITERAL_STRING
(
"
camera
http
:
/
/
example
.
com
'
self
'
http
:
/
/
example
.
net
*
"
)
true
1
parsedFeatures
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
Name
(
)
.
Equals
(
NS_LITERAL_STRING
(
"
camera
"
)
)
)
;
ASSERT_TRUE
(
parsedFeatures
[
0
]
.
AllowsAll
(
)
)
;
}
