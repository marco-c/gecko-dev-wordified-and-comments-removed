#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
mozilla
/
net
/
DNS
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsHTTPSOnlyUtils
.
h
"
#
include
"
nsIConsoleService
.
h
"
#
include
"
nsIHttpChannel
.
h
"
#
include
"
nsIHttpsOnlyModePermission
.
h
"
#
include
"
nsIPermissionManager
.
h
"
#
include
"
nsIScriptError
.
h
"
#
include
"
prnetdb
.
h
"
bool
nsHTTPSOnlyUtils
:
:
IsHttpsOnlyModeEnabled
(
bool
aFromPrivateWindow
)
{
if
(
mozilla
:
:
StaticPrefs
:
:
dom_security_https_only_mode
(
)
)
{
return
true
;
}
if
(
aFromPrivateWindow
&
&
mozilla
:
:
StaticPrefs
:
:
dom_security_https_only_mode_pbm
(
)
)
{
return
true
;
}
return
false
;
}
bool
nsHTTPSOnlyUtils
:
:
ShouldUpgradeRequest
(
nsIURI
*
aURI
nsILoadInfo
*
aLoadInfo
)
{
bool
isPrivateWin
=
aLoadInfo
-
>
GetOriginAttributes
(
)
.
mPrivateBrowsingId
>
0
;
if
(
!
IsHttpsOnlyModeEnabled
(
isPrivateWin
)
)
{
return
false
;
}
if
(
OnionException
(
aURI
)
|
|
LoopbackOrLocalException
(
aURI
)
)
{
return
false
;
}
uint32_t
httpsOnlyStatus
=
aLoadInfo
-
>
GetHttpsOnlyStatus
(
)
;
if
(
httpsOnlyStatus
&
nsILoadInfo
:
:
HTTPS_ONLY_EXEMPT
)
{
uint32_t
innerWindowId
=
aLoadInfo
-
>
GetInnerWindowID
(
)
;
AutoTArray
<
nsString
1
>
params
=
{
NS_ConvertUTF8toUTF16
(
aURI
-
>
GetSpecOrDefault
(
)
)
}
;
nsHTTPSOnlyUtils
:
:
LogLocalizedString
(
"
HTTPSOnlyNoUpgradeException
"
params
nsIScriptError
:
:
infoFlag
innerWindowId
isPrivateWin
aURI
)
;
return
false
;
}
nsAutoCString
scheme
;
aURI
-
>
GetScheme
(
scheme
)
;
scheme
.
AppendLiteral
(
"
s
"
)
;
NS_ConvertUTF8toUTF16
reportSpec
(
aURI
-
>
GetSpecOrDefault
(
)
)
;
NS_ConvertUTF8toUTF16
reportScheme
(
scheme
)
;
uint32_t
innerWindowId
=
aLoadInfo
-
>
GetInnerWindowID
(
)
;
AutoTArray
<
nsString
2
>
params
=
{
reportSpec
reportScheme
}
;
nsHTTPSOnlyUtils
:
:
LogLocalizedString
(
"
HTTPSOnlyUpgradeRequest
"
params
nsIScriptError
:
:
warningFlag
innerWindowId
!
!
aLoadInfo
-
>
GetOriginAttributes
(
)
.
mPrivateBrowsingId
aURI
)
;
if
(
httpsOnlyStatus
&
nsILoadInfo
:
:
HTTPS_ONLY_UNINITIALIZED
)
{
httpsOnlyStatus
^
=
nsILoadInfo
:
:
HTTPS_ONLY_UNINITIALIZED
;
httpsOnlyStatus
|
=
nsILoadInfo
:
:
HTTPS_ONLY_UPGRADED_LISTENER_NOT_REGISTERED
;
aLoadInfo
-
>
SetHttpsOnlyStatus
(
httpsOnlyStatus
)
;
}
return
true
;
}
bool
nsHTTPSOnlyUtils
:
:
ShouldUpgradeWebSocket
(
nsIURI
*
aURI
nsILoadInfo
*
aLoadInfo
)
{
bool
isPrivateWin
=
aLoadInfo
-
>
GetOriginAttributes
(
)
.
mPrivateBrowsingId
>
0
;
if
(
!
IsHttpsOnlyModeEnabled
(
isPrivateWin
)
)
{
return
false
;
}
if
(
OnionException
(
aURI
)
|
|
LoopbackOrLocalException
(
aURI
)
)
{
return
false
;
}
uint32_t
innerWindowId
=
aLoadInfo
-
>
GetInnerWindowID
(
)
;
uint32_t
httpsOnlyStatus
=
aLoadInfo
-
>
GetHttpsOnlyStatus
(
)
;
if
(
httpsOnlyStatus
&
nsILoadInfo
:
:
HTTPS_ONLY_EXEMPT
)
{
AutoTArray
<
nsString
1
>
params
=
{
NS_ConvertUTF8toUTF16
(
aURI
-
>
GetSpecOrDefault
(
)
)
}
;
nsHTTPSOnlyUtils
:
:
LogLocalizedString
(
"
HTTPSOnlyNoUpgradeException
"
params
nsIScriptError
:
:
infoFlag
innerWindowId
isPrivateWin
aURI
)
;
return
false
;
}
nsAutoCString
scheme
;
aURI
-
>
GetScheme
(
scheme
)
;
scheme
.
AppendLiteral
(
"
s
"
)
;
NS_ConvertUTF8toUTF16
reportSpec
(
aURI
-
>
GetSpecOrDefault
(
)
)
;
NS_ConvertUTF8toUTF16
reportScheme
(
scheme
)
;
AutoTArray
<
nsString
2
>
params
=
{
reportSpec
reportScheme
}
;
nsHTTPSOnlyUtils
:
:
LogLocalizedString
(
"
HTTPSOnlyUpgradeRequest
"
params
nsIScriptError
:
:
warningFlag
innerWindowId
isPrivateWin
aURI
)
;
return
true
;
}
bool
nsHTTPSOnlyUtils
:
:
CouldBeHttpsOnlyError
(
nsIChannel
*
aChannel
nsresult
aError
)
{
if
(
!
aChannel
)
{
return
false
;
}
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aChannel
-
>
LoadInfo
(
)
;
bool
isPrivateWin
=
loadInfo
-
>
GetOriginAttributes
(
)
.
mPrivateBrowsingId
>
0
;
if
(
!
IsHttpsOnlyModeEnabled
(
isPrivateWin
)
)
{
return
false
;
}
uint32_t
httpsOnlyStatus
=
loadInfo
-
>
GetHttpsOnlyStatus
(
)
;
if
(
!
(
httpsOnlyStatus
&
nsILoadInfo
:
:
HTTPS_ONLY_UPGRADED_LISTENER_REGISTERED
)
)
{
return
false
;
}
if
(
httpsOnlyStatus
&
nsILoadInfo
:
:
HTTPS_ONLY_EXEMPT
)
{
return
false
;
}
return
!
(
NS_ERROR_UNKNOWN_PROTOCOL
=
=
aError
|
|
NS_ERROR_FILE_NOT_FOUND
=
=
aError
|
|
NS_ERROR_FILE_ACCESS_DENIED
=
=
aError
|
|
NS_ERROR_UNKNOWN_HOST
=
=
aError
|
|
NS_ERROR_PHISHING_URI
=
=
aError
|
|
NS_ERROR_MALWARE_URI
=
=
aError
|
|
NS_ERROR_UNWANTED_URI
=
=
aError
|
|
NS_ERROR_HARMFUL_URI
=
=
aError
|
|
NS_ERROR_CONTENT_CRASHED
=
=
aError
|
|
NS_ERROR_FRAME_CRASHED
=
=
aError
)
;
}
void
nsHTTPSOnlyUtils
:
:
TestSitePermissionAndPotentiallyAddExemption
(
nsIChannel
*
aChannel
)
{
NS_ENSURE_TRUE_VOID
(
aChannel
)
;
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aChannel
-
>
LoadInfo
(
)
;
bool
isPrivateWin
=
loadInfo
-
>
GetOriginAttributes
(
)
.
mPrivateBrowsingId
>
0
;
if
(
!
IsHttpsOnlyModeEnabled
(
isPrivateWin
)
)
{
return
;
}
nsContentPolicyType
type
=
loadInfo
-
>
GetExternalContentPolicyType
(
)
;
if
(
type
!
=
nsIContentPolicy
:
:
TYPE_DOCUMENT
)
{
return
;
}
nsCOMPtr
<
nsIHttpChannel
>
httpChannel
=
do_QueryInterface
(
aChannel
)
;
if
(
!
httpChannel
)
{
return
;
}
nsCOMPtr
<
nsIPrincipal
>
principal
;
nsresult
rv
=
nsContentUtils
:
:
GetSecurityManager
(
)
-
>
GetChannelResultPrincipal
(
aChannel
getter_AddRefs
(
principal
)
)
;
NS_ENSURE_SUCCESS_VOID
(
rv
)
;
nsCOMPtr
<
nsIPermissionManager
>
permMgr
=
mozilla
:
:
services
:
:
GetPermissionManager
(
)
;
NS_ENSURE_TRUE_VOID
(
permMgr
)
;
uint32_t
perm
;
rv
=
permMgr
-
>
TestExactPermissionFromPrincipal
(
principal
"
https
-
only
-
load
-
insecure
"
_ns
&
perm
)
;
NS_ENSURE_SUCCESS_VOID
(
rv
)
;
bool
isHttpsOnlyExempt
=
perm
=
=
nsIHttpsOnlyModePermission
:
:
LOAD_INSECURE_ALLOW
|
|
perm
=
=
nsIHttpsOnlyModePermission
:
:
LOAD_INSECURE_ALLOW_SESSION
;
uint32_t
httpsOnlyStatus
=
loadInfo
-
>
GetHttpsOnlyStatus
(
)
;
if
(
isHttpsOnlyExempt
)
{
httpsOnlyStatus
|
=
nsILoadInfo
:
:
HTTPS_ONLY_EXEMPT
;
}
else
{
httpsOnlyStatus
&
=
~
nsILoadInfo
:
:
HTTPS_ONLY_EXEMPT
;
}
loadInfo
-
>
SetHttpsOnlyStatus
(
httpsOnlyStatus
)
;
}
void
nsHTTPSOnlyUtils
:
:
LogLocalizedString
(
const
char
*
aName
const
nsTArray
<
nsString
>
&
aParams
uint32_t
aFlags
uint64_t
aInnerWindowID
bool
aFromPrivateWindow
nsIURI
*
aURI
)
{
nsAutoString
logMsg
;
nsContentUtils
:
:
FormatLocalizedString
(
nsContentUtils
:
:
eSECURITY_PROPERTIES
aName
aParams
logMsg
)
;
LogMessage
(
logMsg
aFlags
aInnerWindowID
aFromPrivateWindow
aURI
)
;
}
void
nsHTTPSOnlyUtils
:
:
LogMessage
(
const
nsAString
&
aMessage
uint32_t
aFlags
uint64_t
aInnerWindowID
bool
aFromPrivateWindow
nsIURI
*
aURI
)
{
nsString
message
;
message
.
AppendLiteral
(
u
"
HTTPS
-
Only
Mode
:
"
)
;
message
.
Append
(
aMessage
)
;
nsCString
category
(
"
HTTPSOnly
"
)
;
if
(
aInnerWindowID
>
0
)
{
nsContentUtils
:
:
ReportToConsoleByWindowID
(
message
aFlags
category
aInnerWindowID
aURI
)
;
}
else
{
nsContentUtils
:
:
LogSimpleConsoleError
(
message
category
.
get
(
)
aFromPrivateWindow
true
aFlags
)
;
}
}
bool
nsHTTPSOnlyUtils
:
:
OnionException
(
nsIURI
*
aURI
)
{
if
(
mozilla
:
:
StaticPrefs
:
:
dom_security_https_only_mode_upgrade_onion
(
)
)
{
return
false
;
}
nsAutoCString
host
;
aURI
-
>
GetHost
(
host
)
;
return
StringEndsWith
(
host
"
.
onion
"
_ns
)
;
}
bool
nsHTTPSOnlyUtils
:
:
LoopbackOrLocalException
(
nsIURI
*
aURI
)
{
nsAutoCString
asciiHost
;
nsresult
rv
=
aURI
-
>
GetAsciiHost
(
asciiHost
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
if
(
asciiHost
.
EqualsLiteral
(
"
localhost
"
)
|
|
asciiHost
.
EqualsLiteral
(
"
:
:
1
"
)
)
{
return
true
;
}
PRNetAddr
tempAddr
;
memset
(
&
tempAddr
0
sizeof
(
PRNetAddr
)
)
;
if
(
PR_StringToNetAddr
(
asciiHost
.
get
(
)
&
tempAddr
)
!
=
PR_SUCCESS
)
{
return
false
;
}
mozilla
:
:
net
:
:
NetAddr
addr
;
PRNetAddrToNetAddr
(
&
tempAddr
&
addr
)
;
if
(
IsLoopBackAddress
(
&
addr
)
)
{
return
true
;
}
bool
upgradeLocal
=
mozilla
:
:
StaticPrefs
:
:
dom_security_https_only_mode_upgrade_local
(
)
;
return
(
!
upgradeLocal
&
&
IsIPAddrLocal
(
&
addr
)
)
;
}
