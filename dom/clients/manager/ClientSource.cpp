#
include
"
ClientSource
.
h
"
#
include
"
ClientManager
.
h
"
#
include
"
ClientManagerChild
.
h
"
#
include
"
ClientSourceChild
.
h
"
#
include
"
ClientState
.
h
"
#
include
"
ClientValidation
.
h
"
#
include
"
mozilla
/
dom
/
ClientIPCTypes
.
h
"
#
include
"
mozilla
/
dom
/
WorkerPrivate
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsPIDOMWindow
.
h
"
namespace
mozilla
{
namespace
dom
{
using
mozilla
:
:
dom
:
:
workers
:
:
WorkerPrivate
;
using
mozilla
:
:
ipc
:
:
PrincipalInfo
;
void
ClientSource
:
:
Shutdown
(
)
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
if
(
IsShutdown
(
)
)
{
return
;
}
ShutdownThing
(
)
;
mManager
=
nullptr
;
}
void
ClientSource
:
:
ExecutionReady
(
const
ClientSourceExecutionReadyArgs
&
aArgs
)
{
if
(
NS_WARN_IF
(
!
ClientIsValidCreationURL
(
mClientInfo
.
PrincipalInfo
(
)
aArgs
.
url
(
)
)
)
)
{
Shutdown
(
)
;
return
;
}
mClientInfo
.
SetURL
(
aArgs
.
url
(
)
)
;
mClientInfo
.
SetFrameType
(
aArgs
.
frameType
(
)
)
;
MaybeExecute
(
[
aArgs
]
(
PClientSourceChild
*
aActor
)
{
aActor
-
>
SendExecutionReady
(
aArgs
)
;
}
)
;
}
nsresult
ClientSource
:
:
SnapshotWindowState
(
ClientState
*
aStateOut
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
nsPIDOMWindowInner
*
window
=
GetInnerWindow
(
)
;
if
(
!
window
|
|
!
window
-
>
IsCurrentInnerWindow
(
)
|
|
!
window
-
>
HasActiveDocument
(
)
)
{
*
aStateOut
=
ClientState
(
ClientWindowState
(
VisibilityState
:
:
Hidden
TimeStamp
(
)
false
)
)
;
return
NS_OK
;
}
nsIDocument
*
doc
=
window
-
>
GetExtantDoc
(
)
;
if
(
NS_WARN_IF
(
!
doc
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
ErrorResult
rv
;
bool
focused
=
doc
-
>
HasFocus
(
rv
)
;
if
(
NS_WARN_IF
(
rv
.
Failed
(
)
)
)
{
rv
.
SuppressException
(
)
;
return
rv
.
StealNSResult
(
)
;
}
*
aStateOut
=
ClientState
(
ClientWindowState
(
doc
-
>
VisibilityState
(
)
doc
-
>
LastFocusTime
(
)
focused
)
)
;
return
NS_OK
;
}
WorkerPrivate
*
ClientSource
:
:
GetWorkerPrivate
(
)
const
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
if
(
!
mOwner
.
is
<
WorkerPrivate
*
>
(
)
)
{
return
nullptr
;
}
return
mOwner
.
as
<
WorkerPrivate
*
>
(
)
;
}
nsIDocShell
*
ClientSource
:
:
GetDocShell
(
)
const
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
if
(
!
mOwner
.
is
<
nsCOMPtr
<
nsIDocShell
>
>
(
)
)
{
return
nullptr
;
}
return
mOwner
.
as
<
nsCOMPtr
<
nsIDocShell
>
>
(
)
;
}
void
ClientSource
:
:
MaybeCreateInitialDocument
(
)
{
nsIDocShell
*
docshell
=
GetDocShell
(
)
;
if
(
docshell
)
{
Unused
<
<
docshell
-
>
GetDocument
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
GetInnerWindow
(
)
)
;
}
}
ClientSource
:
:
ClientSource
(
ClientManager
*
aManager
nsISerialEventTarget
*
aEventTarget
const
ClientSourceConstructorArgs
&
aArgs
)
:
mManager
(
aManager
)
mEventTarget
(
aEventTarget
)
mOwner
(
AsVariant
(
Nothing
(
)
)
)
mClientInfo
(
aArgs
.
id
(
)
aArgs
.
type
(
)
aArgs
.
principalInfo
(
)
aArgs
.
creationTime
(
)
)
{
MOZ_ASSERT
(
mManager
)
;
MOZ_ASSERT
(
mEventTarget
)
;
}
void
ClientSource
:
:
Activate
(
PClientManagerChild
*
aActor
)
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
MOZ_ASSERT
(
!
GetActor
(
)
)
;
if
(
IsShutdown
(
)
)
{
return
;
}
if
(
NS_WARN_IF
(
!
ClientIsValidPrincipalInfo
(
mClientInfo
.
PrincipalInfo
(
)
)
)
)
{
Shutdown
(
)
;
return
;
}
ClientSourceConstructorArgs
args
(
mClientInfo
.
Id
(
)
mClientInfo
.
Type
(
)
mClientInfo
.
PrincipalInfo
(
)
mClientInfo
.
CreationTime
(
)
)
;
PClientSourceChild
*
actor
=
aActor
-
>
SendPClientSourceConstructor
(
args
)
;
if
(
!
actor
)
{
Shutdown
(
)
;
return
;
}
ActivateThing
(
static_cast
<
ClientSourceChild
*
>
(
actor
)
)
;
}
ClientSource
:
:
~
ClientSource
(
)
{
Shutdown
(
)
;
}
nsPIDOMWindowInner
*
ClientSource
:
:
GetInnerWindow
(
)
const
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
if
(
!
mOwner
.
is
<
RefPtr
<
nsPIDOMWindowInner
>
>
(
)
)
{
return
nullptr
;
}
return
mOwner
.
as
<
RefPtr
<
nsPIDOMWindowInner
>
>
(
)
;
}
void
ClientSource
:
:
WorkerExecutionReady
(
WorkerPrivate
*
aWorkerPrivate
)
{
MOZ_DIAGNOSTIC_ASSERT
(
aWorkerPrivate
)
;
aWorkerPrivate
-
>
AssertIsOnWorkerThread
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
mOwner
.
is
<
Nothing
>
(
)
)
;
mOwner
=
AsVariant
(
aWorkerPrivate
)
;
ClientSourceExecutionReadyArgs
args
(
aWorkerPrivate
-
>
GetLocationInfo
(
)
.
mHref
FrameType
:
:
None
)
;
ExecutionReady
(
args
)
;
}
nsresult
ClientSource
:
:
WindowExecutionReady
(
nsPIDOMWindowInner
*
aInnerWindow
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aInnerWindow
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aInnerWindow
-
>
IsCurrentInnerWindow
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aInnerWindow
-
>
HasActiveDocument
(
)
)
;
nsIDocument
*
doc
=
aInnerWindow
-
>
GetExtantDoc
(
)
;
if
(
NS_WARN_IF
(
!
doc
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
nsCString
spec
;
nsIURI
*
uri
=
doc
-
>
GetOriginalURI
(
)
;
if
(
uri
)
{
nsresult
rv
=
uri
-
>
GetSpec
(
spec
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
}
nsPIDOMWindowOuter
*
outer
=
aInnerWindow
-
>
GetOuterWindow
(
)
;
if
(
NS_WARN_IF
(
!
outer
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
FrameType
frameType
=
FrameType
:
:
Top_level
;
if
(
!
outer
-
>
IsTopLevelWindow
(
)
)
{
frameType
=
FrameType
:
:
Nested
;
}
else
if
(
outer
-
>
HadOriginalOpener
(
)
)
{
frameType
=
FrameType
:
:
Auxiliary
;
}
MOZ_DIAGNOSTIC_ASSERT
(
mOwner
.
is
<
Nothing
>
(
)
|
|
mOwner
.
is
<
nsCOMPtr
<
nsIDocShell
>
>
(
)
|
|
GetInnerWindow
(
)
=
=
aInnerWindow
)
;
mOwner
=
AsVariant
(
RefPtr
<
nsPIDOMWindowInner
>
(
aInnerWindow
)
)
;
ClientSourceExecutionReadyArgs
args
(
spec
frameType
)
;
ExecutionReady
(
args
)
;
return
NS_OK
;
}
nsresult
ClientSource
:
:
DocShellExecutionReady
(
nsIDocShell
*
aDocShell
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aDocShell
)
;
nsPIDOMWindowOuter
*
outer
=
aDocShell
-
>
GetWindow
(
)
;
if
(
NS_WARN_IF
(
!
outer
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
FrameType
frameType
=
FrameType
:
:
Top_level
;
if
(
!
outer
-
>
IsTopLevelWindow
(
)
)
{
frameType
=
FrameType
:
:
Nested
;
}
else
if
(
outer
-
>
HadOriginalOpener
(
)
)
{
frameType
=
FrameType
:
:
Auxiliary
;
}
MOZ_DIAGNOSTIC_ASSERT
(
mOwner
.
is
<
Nothing
>
(
)
)
;
mOwner
=
AsVariant
(
nsCOMPtr
<
nsIDocShell
>
(
aDocShell
)
)
;
ClientSourceExecutionReadyArgs
args
(
NS_LITERAL_CSTRING
(
"
about
:
blank
"
)
frameType
)
;
ExecutionReady
(
args
)
;
return
NS_OK
;
}
void
ClientSource
:
:
Freeze
(
)
{
MaybeExecute
(
[
]
(
PClientSourceChild
*
aActor
)
{
aActor
-
>
SendFreeze
(
)
;
}
)
;
}
void
ClientSource
:
:
Thaw
(
)
{
MaybeExecute
(
[
]
(
PClientSourceChild
*
aActor
)
{
aActor
-
>
SendThaw
(
)
;
}
)
;
}
const
ClientInfo
&
ClientSource
:
:
Info
(
)
const
{
return
mClientInfo
;
}
void
ClientSource
:
:
WorkerSyncPing
(
WorkerPrivate
*
aWorkerPrivate
)
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aWorkerPrivate
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aWorkerPrivate
=
=
mManager
-
>
GetWorkerPrivate
(
)
)
;
aWorkerPrivate
-
>
AssertIsOnWorkerThread
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
GetActor
(
)
)
;
GetActor
(
)
-
>
SendWorkerSyncPing
(
)
;
}
void
ClientSource
:
:
SetController
(
const
ServiceWorkerDescriptor
&
aServiceWorker
)
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
if
(
mController
.
isSome
(
)
&
&
mController
.
ref
(
)
=
=
aServiceWorker
)
{
return
;
}
mController
.
reset
(
)
;
mController
.
emplace
(
aServiceWorker
)
;
}
RefPtr
<
ClientOpPromise
>
ClientSource
:
:
Control
(
const
ClientControlledArgs
&
aArgs
)
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
SetController
(
ServiceWorkerDescriptor
(
aArgs
.
serviceWorker
(
)
)
)
;
RefPtr
<
ClientOpPromise
>
ref
=
ClientOpPromise
:
:
CreateAndResolve
(
NS_OK
__func__
)
;
return
ref
.
forget
(
)
;
}
const
Maybe
<
ServiceWorkerDescriptor
>
&
ClientSource
:
:
GetController
(
)
const
{
return
mController
;
}
RefPtr
<
ClientOpPromise
>
ClientSource
:
:
GetInfoAndState
(
const
ClientGetInfoAndStateArgs
&
aArgs
)
{
RefPtr
<
ClientOpPromise
>
ref
;
ClientState
state
;
nsresult
rv
=
SnapshotState
(
&
state
)
;
if
(
NS_FAILED
(
rv
)
)
{
ref
=
ClientOpPromise
:
:
CreateAndReject
(
rv
__func__
)
;
return
ref
.
forget
(
)
;
}
ref
=
ClientOpPromise
:
:
CreateAndResolve
(
ClientInfoAndState
(
mClientInfo
.
ToIPC
(
)
state
.
ToIPC
(
)
)
__func__
)
;
return
ref
.
forget
(
)
;
}
nsresult
ClientSource
:
:
SnapshotState
(
ClientState
*
aStateOut
)
{
NS_ASSERT_OWNINGTHREAD
(
ClientSource
)
;
MOZ_DIAGNOSTIC_ASSERT
(
aStateOut
)
;
if
(
mClientInfo
.
Type
(
)
=
=
ClientType
:
:
Window
)
{
MaybeCreateInitialDocument
(
)
;
nsresult
rv
=
SnapshotWindowState
(
aStateOut
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
return
NS_OK
;
}
*
aStateOut
=
ClientState
(
ClientWorkerState
(
)
)
;
return
NS_OK
;
}
nsISerialEventTarget
*
ClientSource
:
:
EventTarget
(
)
const
{
return
mEventTarget
;
}
void
ClientSource
:
:
Traverse
(
nsCycleCollectionTraversalCallback
&
aCallback
const
char
*
aName
uint32_t
aFlags
)
{
if
(
mOwner
.
is
<
RefPtr
<
nsPIDOMWindowInner
>
>
(
)
)
{
ImplCycleCollectionTraverse
(
aCallback
mOwner
.
as
<
RefPtr
<
nsPIDOMWindowInner
>
>
(
)
aName
aFlags
)
;
}
else
if
(
mOwner
.
is
<
nsCOMPtr
<
nsIDocShell
>
>
(
)
)
{
ImplCycleCollectionTraverse
(
aCallback
mOwner
.
as
<
nsCOMPtr
<
nsIDocShell
>
>
(
)
aName
aFlags
)
;
}
}
}
}
