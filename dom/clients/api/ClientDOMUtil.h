#
ifndef
_mozilla_dom_ClientDOMUtil_h
#
define
_mozilla_dom_ClientDOMUtil_h
#
include
"
mozilla
/
dom
/
ClientIPCTypes
.
h
"
#
include
"
mozilla
/
dom
/
ClientOpPromise
.
h
"
#
include
"
mozilla
/
dom
/
DOMMozPromiseRequestHolder
.
h
"
#
include
"
mozilla
/
dom
/
WorkerPrivate
.
h
"
class
nsIGlobalObject
;
namespace
mozilla
{
namespace
dom
{
template
<
typename
Func
typename
Arg
typename
Resolve
typename
Reject
>
void
StartClientManagerOp
(
Func
aFunc
const
Arg
&
aArg
nsIGlobalObject
*
aGlobal
Resolve
aResolve
Reject
aReject
)
{
MOZ_DIAGNOSTIC_ASSERT
(
aGlobal
)
;
nsCOMPtr
<
nsISerialEventTarget
>
target
=
aGlobal
-
>
EventTargetFor
(
TaskCategory
:
:
Other
)
;
auto
holder
=
MakeRefPtr
<
DOMMozPromiseRequestHolder
<
ClientOpPromise
>
>
(
aGlobal
)
;
aFunc
(
aArg
target
)
-
>
Then
(
target
__func__
[
aResolve
holder
]
(
const
ClientOpResult
&
aResult
)
{
holder
-
>
Complete
(
)
;
aResolve
(
aResult
)
;
}
[
aReject
holder
]
(
nsresult
aResult
)
{
holder
-
>
Complete
(
)
;
aReject
(
aResult
)
;
}
)
-
>
Track
(
*
holder
)
;
}
}
}
#
endif
