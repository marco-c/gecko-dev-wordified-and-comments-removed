#
include
"
WebGLValidateStrings
.
h
"
#
include
"
WebGLContext
.
h
"
#
include
<
regex
>
namespace
mozilla
{
std
:
:
string
CommentsToSpaces
(
const
std
:
:
string
&
src
)
{
#
define
LINE_COMMENT
"
/
/
(
?
:
[
^
]
*
?
[
^
\
\
\
\
]
)
?
?
\
n
"
#
define
BLOCK_COMMENT
"
/
[
*
]
[
^
]
*
?
[
*
]
/
"
static
const
std
:
:
regex
COMMENT_RE
(
"
(
?
:
"
LINE_COMMENT
"
)
|
(
?
:
"
BLOCK_COMMENT
"
)
"
std
:
:
regex
:
:
ECMAScript
|
std
:
:
regex
:
:
nosubs
|
std
:
:
regex
:
:
optimize
)
;
#
undef
LINE_COMMENT
#
undef
BLOCK_COMMENT
static
const
std
:
:
regex
TRAILING_RE
(
"
/
[
*
/
]
"
std
:
:
regex
:
:
ECMAScript
|
std
:
:
regex
:
:
nosubs
|
std
:
:
regex
:
:
optimize
)
;
std
:
:
string
ret
;
ret
.
reserve
(
src
.
size
(
)
)
;
auto
itr
=
src
.
begin
(
)
;
auto
end
=
src
.
end
(
)
;
std
:
:
smatch
match
;
while
(
std
:
:
regex_search
(
itr
end
match
COMMENT_RE
)
)
{
const
auto
matchBegin
=
itr
+
match
.
position
(
)
;
const
auto
matchEnd
=
matchBegin
+
match
.
length
(
)
;
ret
.
append
(
itr
matchBegin
)
;
for
(
itr
=
matchBegin
;
itr
!
=
matchEnd
;
+
+
itr
)
{
auto
cur
=
*
itr
;
switch
(
cur
)
{
case
'
/
'
:
case
'
*
'
:
case
'
\
n
'
:
case
'
\
\
'
:
break
;
default
:
cur
=
'
'
;
break
;
}
ret
+
=
cur
;
}
}
if
(
std
:
:
regex_search
(
itr
end
match
TRAILING_RE
)
)
{
end
=
itr
+
match
.
position
(
)
;
}
ret
.
append
(
itr
end
)
;
return
ret
;
}
static
bool
IsValidGLSLChar
(
const
char
c
)
{
if
(
(
'
a
'
<
=
c
&
&
c
<
=
'
z
'
)
|
|
(
'
A
'
<
=
c
&
&
c
<
=
'
Z
'
)
|
|
(
'
0
'
<
=
c
&
&
c
<
=
'
9
'
)
)
{
return
true
;
}
switch
(
c
)
{
case
'
'
:
case
'
\
t
'
:
case
'
\
v
'
:
case
'
\
f
'
:
case
'
\
r
'
:
case
'
\
n
'
:
case
'
_
'
:
case
'
.
'
:
case
'
+
'
:
case
'
-
'
:
case
'
/
'
:
case
'
*
'
:
case
'
%
'
:
case
'
<
'
:
case
'
>
'
:
case
'
[
'
:
case
'
]
'
:
case
'
(
'
:
case
'
)
'
:
case
'
{
'
:
case
'
}
'
:
case
'
^
'
:
case
'
|
'
:
case
'
&
'
:
case
'
~
'
:
case
'
=
'
:
case
'
!
'
:
case
'
:
'
:
case
'
;
'
:
case
'
'
:
case
'
?
'
:
return
true
;
default
:
return
false
;
}
}
Maybe
<
char
>
CheckGLSLPreprocString
(
const
bool
webgl2
const
std
:
:
string
&
string
)
{
for
(
const
auto
c
:
string
)
{
if
(
IsValidGLSLChar
(
c
)
)
continue
;
if
(
c
=
=
'
#
'
)
continue
;
if
(
c
=
=
'
\
\
'
&
&
webgl2
)
continue
;
return
Some
(
c
)
;
}
return
{
}
;
}
Maybe
<
webgl
:
:
ErrorInfo
>
CheckGLSLVariableName
(
const
bool
webgl2
const
std
:
:
string
&
name
)
{
if
(
name
.
empty
(
)
)
return
{
}
;
const
uint32_t
maxSize
=
webgl2
?
1024
:
256
;
if
(
name
.
size
(
)
>
maxSize
)
{
const
auto
info
=
nsPrintfCString
(
"
Identifier
is
%
zu
characters
long
exceeds
the
"
"
maximum
allowed
length
of
%
u
characters
.
"
name
.
size
(
)
maxSize
)
;
return
Some
(
webgl
:
:
ErrorInfo
{
LOCAL_GL_INVALID_VALUE
info
.
BeginReading
(
)
}
)
;
}
for
(
const
auto
cur
:
name
)
{
if
(
!
IsValidGLSLChar
(
cur
)
)
{
const
auto
info
=
nsPrintfCString
(
"
String
contains
the
illegal
character
0x
%
x
'
.
"
cur
)
;
return
Some
(
webgl
:
:
ErrorInfo
{
LOCAL_GL_INVALID_VALUE
info
.
BeginReading
(
)
}
)
;
}
}
if
(
name
.
find
(
"
webgl_
"
)
=
=
0
|
|
name
.
find
(
"
_webgl_
"
)
=
=
0
)
{
return
Some
(
webgl
:
:
ErrorInfo
{
LOCAL_GL_INVALID_OPERATION
"
String
matches
reserved
GLSL
prefix
pattern
/
_
?
webgl_
/
.
"
}
)
;
}
return
{
}
;
}
}
