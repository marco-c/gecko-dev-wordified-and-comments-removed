#
include
"
DrawTargetWebglInternal
.
h
"
#
include
"
SourceSurfaceWebgl
.
h
"
namespace
mozilla
:
:
gfx
{
SourceSurfaceWebgl
:
:
SourceSurfaceWebgl
(
DrawTargetWebgl
*
aDT
)
:
mFormat
(
aDT
-
>
GetFormat
(
)
)
mSize
(
aDT
-
>
GetSize
(
)
)
mDT
(
aDT
)
mSharedContext
(
aDT
-
>
mSharedContext
)
{
}
SourceSurfaceWebgl
:
:
SourceSurfaceWebgl
(
const
RefPtr
<
TextureHandle
>
&
aHandle
const
RefPtr
<
DrawTargetWebgl
:
:
SharedContext
>
&
aSharedContext
)
:
mFormat
(
aHandle
-
>
GetFormat
(
)
)
mSize
(
aHandle
-
>
GetSize
(
)
)
mSharedContext
(
aSharedContext
)
mHandle
(
aHandle
)
{
mHandle
-
>
SetSurface
(
this
)
;
}
SourceSurfaceWebgl
:
:
~
SourceSurfaceWebgl
(
)
{
if
(
mHandle
)
{
mHandle
-
>
SetSurface
(
nullptr
)
;
}
}
inline
bool
SourceSurfaceWebgl
:
:
EnsureData
(
)
{
if
(
mData
)
{
return
true
;
}
if
(
!
mDT
)
{
if
(
!
mHandle
|
|
!
mSharedContext
)
{
return
false
;
}
mData
=
mSharedContext
-
>
ReadSnapshot
(
mHandle
)
;
}
else
{
mData
=
mDT
-
>
ReadSnapshot
(
)
;
}
return
!
!
mData
;
}
uint8_t
*
SourceSurfaceWebgl
:
:
GetData
(
)
{
if
(
!
EnsureData
(
)
)
{
return
nullptr
;
}
return
mData
-
>
GetData
(
)
;
}
int32_t
SourceSurfaceWebgl
:
:
Stride
(
)
{
if
(
!
EnsureData
(
)
)
{
return
0
;
}
return
mData
-
>
Stride
(
)
;
}
bool
SourceSurfaceWebgl
:
:
Map
(
MapType
aType
MappedSurface
*
aMappedSurface
)
{
if
(
!
EnsureData
(
)
)
{
return
false
;
}
return
mData
-
>
Map
(
aType
aMappedSurface
)
;
}
void
SourceSurfaceWebgl
:
:
Unmap
(
)
{
if
(
mData
)
{
mData
-
>
Unmap
(
)
;
}
}
void
SourceSurfaceWebgl
:
:
DrawTargetWillChange
(
bool
aNeedHandle
)
{
MOZ_ASSERT
(
mDT
)
;
if
(
(
!
mData
|
|
aNeedHandle
)
&
&
!
mHandle
)
{
mHandle
=
mDT
-
>
CopySnapshot
(
)
;
if
(
mHandle
)
{
mHandle
-
>
SetSurface
(
this
)
;
}
else
{
EnsureData
(
)
;
}
}
mDT
=
nullptr
;
}
void
SourceSurfaceWebgl
:
:
GiveTexture
(
RefPtr
<
TextureHandle
>
aHandle
)
{
MOZ_ASSERT
(
mDT
)
;
MOZ_ASSERT
(
!
mHandle
)
;
mHandle
=
aHandle
.
forget
(
)
;
mHandle
-
>
SetSurface
(
this
)
;
mDT
=
nullptr
;
}
void
SourceSurfaceWebgl
:
:
OnUnlinkTexture
(
DrawTargetWebgl
:
:
SharedContext
*
aContext
)
{
MOZ_ASSERT
(
!
mDT
)
;
MOZ_ASSERT
(
mHandle
|
|
mData
)
;
if
(
!
mData
)
{
mData
=
aContext
-
>
ReadSnapshot
(
mHandle
)
;
}
mHandle
=
nullptr
;
}
already_AddRefed
<
SourceSurface
>
SourceSurfaceWebgl
:
:
ExtractSubrect
(
const
IntRect
&
aRect
)
{
if
(
!
(
mDT
|
|
(
mHandle
&
&
mSharedContext
)
)
|
|
aRect
.
IsEmpty
(
)
|
|
!
GetRect
(
)
.
Contains
(
aRect
)
)
{
return
nullptr
;
}
RefPtr
<
TextureHandle
>
subHandle
;
RefPtr
<
DrawTargetWebgl
:
:
SharedContext
>
sharedContext
;
if
(
mDT
)
{
subHandle
=
mDT
-
>
CopySnapshot
(
aRect
)
;
if
(
!
subHandle
)
{
return
nullptr
;
}
sharedContext
=
mDT
-
>
mSharedContext
;
}
else
{
sharedContext
=
mSharedContext
;
if
(
!
sharedContext
)
{
return
nullptr
;
}
subHandle
=
sharedContext
-
>
CopySnapshot
(
aRect
mHandle
)
;
if
(
!
subHandle
)
{
return
nullptr
;
}
}
RefPtr
<
SourceSurface
>
surface
=
new
SourceSurfaceWebgl
(
subHandle
sharedContext
)
;
return
surface
.
forget
(
)
;
}
}
