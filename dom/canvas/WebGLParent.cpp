#
include
"
WebGLParent
.
h
"
#
include
"
mozilla
/
dom
/
WebGLCrossProcessCommandQueue
.
h
"
#
include
"
mozilla
/
layers
/
LayerTransactionParent
.
h
"
#
include
"
mozilla
/
layers
/
TextureClientSharedSurface
.
h
"
#
include
"
HostWebGLContext
.
h
"
namespace
mozilla
{
namespace
dom
{
RefPtr
<
WebGLParent
>
WebGLParent
:
:
Create
(
const
webgl
:
:
InitContextDesc
&
desc
webgl
:
:
InitContextResult
*
const
out
)
{
RefPtr
<
WebGLParent
>
parent
=
new
WebGLParent
;
auto
remotingData
=
Some
(
HostWebGLContext
:
:
RemotingData
{
*
parent
{
}
}
)
;
parent
-
>
mHost
=
HostWebGLContext
:
:
Create
(
{
{
}
std
:
:
move
(
remotingData
)
}
desc
out
)
;
if
(
!
parent
-
>
mHost
)
{
WEBGL_BRIDGE_LOGE
(
"
Failed
to
create
HostWebGLContext
"
)
;
return
nullptr
;
}
if
(
!
parent
-
>
BeginCommandQueueDrain
(
)
)
{
WEBGL_BRIDGE_LOGE
(
"
Failed
to
start
WebGL
command
queue
drain
"
)
;
return
nullptr
;
}
return
parent
;
}
WebGLParent
:
:
WebGLParent
(
)
=
default
;
WebGLParent
:
:
~
WebGLParent
(
)
=
default
;
bool
WebGLParent
:
:
BeginCommandQueueDrain
(
)
{
if
(
mRunCommandsRunnable
)
{
return
true
;
}
WeakPtr
<
WebGLParent
>
weakThis
=
this
;
mRunCommandsRunnable
=
NS_NewRunnableFunction
(
"
RunWebGLCommands
"
[
weakThis
]
(
)
{
MaybeRunCommandQueue
(
weakThis
)
;
}
)
;
if
(
!
mRunCommandsRunnable
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Failed
to
create
RunWebGLCommands
Runnable
"
)
;
return
false
;
}
return
RunCommandQueue
(
)
;
}
bool
WebGLParent
:
:
MaybeRunCommandQueue
(
const
WeakPtr
<
WebGLParent
>
&
weakWebGLParent
)
{
if
(
weakWebGLParent
)
{
return
weakWebGLParent
-
>
RunCommandQueue
(
)
;
}
return
true
;
}
bool
WebGLParent
:
:
RunCommandQueue
(
)
{
if
(
!
mRunCommandsRunnable
)
{
return
true
;
}
MOZ_CRASH
(
"
todo
"
)
;
return
true
;
}
mozilla
:
:
ipc
:
:
IPCResult
WebGLParent
:
:
Recv__delete__
(
)
{
mHost
=
nullptr
;
return
IPC_OK
(
)
;
}
void
WebGLParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
mHost
=
nullptr
;
}
mozilla
:
:
ipc
:
:
IPCResult
WebGLParent
:
:
RecvUpdateCompositableHandle
(
layers
:
:
PLayerTransactionParent
*
aLayerTransaction
const
CompositableHandle
&
aHandle
)
{
auto
layerTrans
=
static_cast
<
layers
:
:
LayerTransactionParent
*
>
(
aLayerTransaction
)
;
RefPtr
<
layers
:
:
CompositableHost
>
compositableHost
(
layerTrans
-
>
FindCompositable
(
aHandle
)
)
;
if
(
!
compositableHost
)
{
return
IPC_FAIL
(
this
"
Failed
to
find
CompositableHost
for
WebGL
instance
"
)
;
}
mHost
-
>
SetCompositableHost
(
compositableHost
)
;
return
IPC_OK
(
)
;
}
RefPtr
<
layers
:
:
SharedSurfaceTextureClient
>
WebGLParent
:
:
GetVRFrame
(
)
{
if
(
!
mHost
)
{
return
nullptr
;
}
return
mHost
-
>
GetVRFrame
(
)
;
}
}
}
