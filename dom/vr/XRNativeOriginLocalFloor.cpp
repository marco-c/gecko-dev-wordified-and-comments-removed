#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
XRNativeOriginLocalFloor
.
h
"
#
include
"
VRDisplayClient
.
h
"
namespace
mozilla
{
namespace
dom
{
XRNativeOriginLocalFloor
:
:
XRNativeOriginLocalFloor
(
gfx
:
:
VRDisplayClient
*
aDisplay
)
:
mDisplay
(
aDisplay
)
mInitialPositionValid
(
false
)
{
MOZ_ASSERT
(
aDisplay
)
;
const
double
kFloorFuzz
=
StaticPrefs
:
:
dom_vr_webxr_quantization
(
)
;
mFloorRandom
=
double
(
rand
(
)
)
/
double
(
RAND_MAX
)
*
kFloorFuzz
;
}
gfx
:
:
PointDouble3D
XRNativeOriginLocalFloor
:
:
GetPosition
(
)
{
const
auto
standing
=
mDisplay
-
>
GetDisplayInfo
(
)
.
GetSittingToStandingTransform
(
)
;
if
(
!
mInitialPositionValid
|
|
standing
!
=
mStandingTransform
)
{
const
gfx
:
:
VRHMDSensorState
&
sensorState
=
mDisplay
-
>
GetSensorState
(
)
;
mInitialPosition
.
x
=
sensorState
.
pose
.
position
[
0
]
;
mInitialPosition
.
y
=
-
mFloorRandom
-
standing
.
_42
;
mInitialPosition
.
z
=
sensorState
.
pose
.
position
[
2
]
;
mInitialPositionValid
=
true
;
mStandingTransform
=
standing
;
}
return
mInitialPosition
;
}
}
}
