#
include
"
VREventObserver
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsGlobalWindow
.
h
"
#
include
"
VRManagerChild
.
h
"
namespace
mozilla
{
namespace
dom
{
using
namespace
gfx
;
VREventObserver
:
:
VREventObserver
(
nsGlobalWindow
*
aGlobalWindow
)
:
mWindow
(
aGlobalWindow
)
{
MOZ_ASSERT
(
aGlobalWindow
&
&
aGlobalWindow
-
>
IsInnerWindow
(
)
)
;
VRManagerChild
*
vmc
=
VRManagerChild
:
:
Get
(
)
;
if
(
vmc
)
{
vmc
-
>
AddListener
(
this
)
;
}
}
VREventObserver
:
:
~
VREventObserver
(
)
{
DisconnectFromOwner
(
)
;
}
void
VREventObserver
:
:
DisconnectFromOwner
(
)
{
mWindow
=
nullptr
;
VRManagerChild
*
vmc
=
VRManagerChild
:
:
Get
(
)
;
if
(
vmc
)
{
vmc
-
>
RemoveListener
(
this
)
;
}
}
void
VREventObserver
:
:
NotifyVRDisplayMounted
(
uint32_t
aDisplayID
)
{
if
(
mWindow
&
&
mWindow
-
>
AsInner
(
)
-
>
IsCurrentInnerWindow
(
)
)
{
MOZ_ASSERT
(
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
mWindow
-
>
DispatchVRDisplayActivate
(
aDisplayID
VRDisplayEventReason
:
:
Mounted
)
;
}
}
void
VREventObserver
:
:
NotifyVRDisplayNavigation
(
uint32_t
aDisplayID
)
{
if
(
mWindow
&
&
mWindow
-
>
AsInner
(
)
-
>
IsCurrentInnerWindow
(
)
)
{
MOZ_ASSERT
(
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
mWindow
-
>
DispatchVRDisplayActivate
(
aDisplayID
VRDisplayEventReason
:
:
Navigation
)
;
}
}
void
VREventObserver
:
:
NotifyVRDisplayRequested
(
uint32_t
aDisplayID
)
{
if
(
mWindow
&
&
mWindow
-
>
AsInner
(
)
-
>
IsCurrentInnerWindow
(
)
)
{
MOZ_ASSERT
(
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
mWindow
-
>
DispatchVRDisplayActivate
(
aDisplayID
VRDisplayEventReason
:
:
Requested
)
;
}
}
void
VREventObserver
:
:
NotifyVRDisplayUnmounted
(
uint32_t
aDisplayID
)
{
if
(
mWindow
&
&
mWindow
-
>
AsInner
(
)
-
>
IsCurrentInnerWindow
(
)
)
{
MOZ_ASSERT
(
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
mWindow
-
>
DispatchVRDisplayDeactivate
(
aDisplayID
VRDisplayEventReason
:
:
Unmounted
)
;
}
}
void
VREventObserver
:
:
NotifyVRDisplayConnect
(
uint32_t
aDisplayID
)
{
if
(
mWindow
&
&
mWindow
-
>
AsInner
(
)
-
>
IsCurrentInnerWindow
(
)
)
{
MOZ_ASSERT
(
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
mWindow
-
>
DispatchVRDisplayConnect
(
aDisplayID
)
;
}
}
void
VREventObserver
:
:
NotifyVRDisplayDisconnect
(
uint32_t
aDisplayID
)
{
if
(
mWindow
&
&
mWindow
-
>
AsInner
(
)
-
>
IsCurrentInnerWindow
(
)
)
{
mWindow
-
>
NotifyActiveVRDisplaysChanged
(
)
;
MOZ_ASSERT
(
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
mWindow
-
>
DispatchVRDisplayDisconnect
(
aDisplayID
)
;
}
}
void
VREventObserver
:
:
NotifyVRDisplayPresentChange
(
uint32_t
aDisplayID
)
{
if
(
mWindow
&
&
mWindow
-
>
AsInner
(
)
-
>
IsCurrentInnerWindow
(
)
)
{
mWindow
-
>
NotifyActiveVRDisplaysChanged
(
)
;
MOZ_ASSERT
(
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
mWindow
-
>
DispatchVRDisplayPresentChange
(
aDisplayID
)
;
}
}
}
}
