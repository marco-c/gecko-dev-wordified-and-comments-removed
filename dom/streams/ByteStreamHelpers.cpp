#
include
"
mozilla
/
dom
/
ByteStreamHelpers
.
h
"
#
include
"
js
/
ArrayBuffer
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
namespace
mozilla
{
namespace
dom
{
JSObject
*
TransferArrayBuffer
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aObject
)
{
MOZ_ASSERT
(
!
JS
:
:
IsDetachedArrayBufferObject
(
aObject
)
)
;
uint8_t
*
bufferData
=
nullptr
;
size_t
bufferLength
=
0
;
bool
isSharedMemory
=
false
;
JS
:
:
GetArrayBufferLengthAndData
(
aObject
&
bufferLength
&
isSharedMemory
&
bufferData
)
;
if
(
!
JS
:
:
DetachArrayBuffer
(
aCx
aObject
)
)
{
return
nullptr
;
}
return
JS
:
:
NewArrayBufferWithContents
(
aCx
bufferLength
bufferData
)
;
}
bool
CanTransferArrayBuffer
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aObject
ErrorResult
&
aRv
)
{
MOZ_ASSERT
(
JS
:
:
IsArrayBufferObject
(
aObject
)
)
;
if
(
JS
:
:
IsDetachedArrayBufferObject
(
aObject
)
)
{
return
false
;
}
bool
hasDefinedArrayBufferDetachKey
;
if
(
!
JS
:
:
HasDefinedArrayBufferDetachKey
(
aCx
aObject
&
hasDefinedArrayBufferDetachKey
)
)
{
aRv
.
StealExceptionFromJSContext
(
aCx
)
;
return
false
;
}
if
(
hasDefinedArrayBufferDetachKey
)
{
return
false
;
}
return
true
;
}
}
}
