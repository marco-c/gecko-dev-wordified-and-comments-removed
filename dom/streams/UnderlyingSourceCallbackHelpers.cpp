#
include
"
mozilla
/
dom
/
BodyStream
.
h
"
#
include
"
mozilla
/
dom
/
ReadableStreamDefaultController
.
h
"
#
include
"
mozilla
/
dom
/
UnderlyingSourceCallbackHelpers
.
h
"
#
include
"
mozilla
/
dom
/
UnderlyingSourceBinding
.
h
"
namespace
mozilla
:
:
dom
{
NS_IMPL_CYCLE_COLLECTION_WITH_JS_MEMBERS
(
UnderlyingSourceStartCallbackHelper
(
mCallback
)
(
mThisObj
)
)
NS_IMPL_CYCLE_COLLECTING_ADDREF
(
UnderlyingSourceStartCallbackHelper
)
NS_IMPL_CYCLE_COLLECTING_RELEASE
(
UnderlyingSourceStartCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
UnderlyingSourceStartCallbackHelper
)
NS_INTERFACE_MAP_ENTRY
(
nsISupports
)
NS_INTERFACE_MAP_END
NS_IMPL_CYCLE_COLLECTION
(
UnderlyingSourcePullCallbackHelper
)
NS_IMPL_CYCLE_COLLECTING_ADDREF
(
UnderlyingSourcePullCallbackHelper
)
NS_IMPL_CYCLE_COLLECTING_RELEASE
(
UnderlyingSourcePullCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
UnderlyingSourcePullCallbackHelper
)
NS_INTERFACE_MAP_ENTRY
(
nsISupports
)
NS_INTERFACE_MAP_END
NS_IMPL_CYCLE_COLLECTION_TRACE_BEGIN
(
UnderlyingSourcePullCallbackHelper
)
NS_IMPL_CYCLE_COLLECTION_TRACE_END
NS_IMPL_CYCLE_COLLECTION_INHERITED_WITH_JS_MEMBERS
(
IDLUnderlyingSourcePullCallbackHelper
UnderlyingSourcePullCallbackHelper
(
mCallback
)
(
mThisObj
)
)
NS_IMPL_ADDREF_INHERITED
(
IDLUnderlyingSourcePullCallbackHelper
UnderlyingSourcePullCallbackHelper
)
NS_IMPL_RELEASE_INHERITED
(
IDLUnderlyingSourcePullCallbackHelper
UnderlyingSourcePullCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
IDLUnderlyingSourcePullCallbackHelper
)
NS_INTERFACE_MAP_END_INHERITING
(
UnderlyingSourcePullCallbackHelper
)
NS_IMPL_CYCLE_COLLECTION
(
BodyStreamUnderlyingSourcePullCallbackHelper
mUnderlyingSource
)
NS_IMPL_ADDREF_INHERITED
(
BodyStreamUnderlyingSourcePullCallbackHelper
UnderlyingSourcePullCallbackHelper
)
NS_IMPL_RELEASE_INHERITED
(
BodyStreamUnderlyingSourcePullCallbackHelper
UnderlyingSourcePullCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
BodyStreamUnderlyingSourcePullCallbackHelper
)
NS_INTERFACE_MAP_END_INHERITING
(
UnderlyingSourcePullCallbackHelper
)
NS_IMPL_CYCLE_COLLECTION
(
UnderlyingSourceCancelCallbackHelper
)
NS_IMPL_CYCLE_COLLECTING_ADDREF
(
UnderlyingSourceCancelCallbackHelper
)
NS_IMPL_CYCLE_COLLECTING_RELEASE
(
UnderlyingSourceCancelCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
UnderlyingSourceCancelCallbackHelper
)
NS_INTERFACE_MAP_ENTRY
(
nsISupports
)
NS_INTERFACE_MAP_END
NS_IMPL_CYCLE_COLLECTION_TRACE_BEGIN
(
UnderlyingSourceCancelCallbackHelper
)
NS_IMPL_CYCLE_COLLECTION_TRACE_END
NS_IMPL_CYCLE_COLLECTION_INHERITED_WITH_JS_MEMBERS
(
IDLUnderlyingSourceCancelCallbackHelper
UnderlyingSourceCancelCallbackHelper
(
mCallback
)
(
mThisObj
)
)
NS_IMPL_ADDREF_INHERITED
(
IDLUnderlyingSourceCancelCallbackHelper
UnderlyingSourceCancelCallbackHelper
)
NS_IMPL_RELEASE_INHERITED
(
IDLUnderlyingSourceCancelCallbackHelper
UnderlyingSourceCancelCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
IDLUnderlyingSourceCancelCallbackHelper
)
NS_INTERFACE_MAP_END_INHERITING
(
UnderlyingSourceCancelCallbackHelper
)
NS_IMPL_CYCLE_COLLECTION
(
UnderlyingSourceErrorCallbackHelper
)
NS_IMPL_CYCLE_COLLECTING_ADDREF
(
UnderlyingSourceErrorCallbackHelper
)
NS_IMPL_CYCLE_COLLECTING_RELEASE
(
UnderlyingSourceErrorCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
UnderlyingSourceErrorCallbackHelper
)
NS_INTERFACE_MAP_ENTRY
(
nsISupports
)
NS_INTERFACE_MAP_END
NS_IMPL_CYCLE_COLLECTION
(
BodyStreamUnderlyingSourceCancelCallbackHelper
mUnderlyingSource
)
NS_IMPL_ADDREF_INHERITED
(
BodyStreamUnderlyingSourceCancelCallbackHelper
UnderlyingSourceCancelCallbackHelper
)
NS_IMPL_RELEASE_INHERITED
(
BodyStreamUnderlyingSourceCancelCallbackHelper
UnderlyingSourceCancelCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
BodyStreamUnderlyingSourceCancelCallbackHelper
)
NS_INTERFACE_MAP_END_INHERITING
(
UnderlyingSourceCancelCallbackHelper
)
void
UnderlyingSourceStartCallbackHelper
:
:
StartCallback
(
JSContext
*
aCx
ReadableStreamController
&
aController
JS
:
:
MutableHandle
<
JS
:
:
Value
>
aRetVal
ErrorResult
&
aRv
)
{
JS
:
:
RootedObject
thisObj
(
aCx
mThisObj
)
;
RefPtr
<
UnderlyingSourceStartCallback
>
callback
(
mCallback
)
;
ReadableStreamDefaultControllerOrReadableByteStreamController
controller
;
if
(
aController
.
IsDefault
(
)
)
{
controller
.
SetAsReadableStreamDefaultController
(
)
=
aController
.
AsDefault
(
)
;
}
else
{
controller
.
SetAsReadableByteStreamController
(
)
=
aController
.
AsByte
(
)
;
}
return
callback
-
>
Call
(
thisObj
controller
aRetVal
aRv
"
UnderlyingSource
.
start
"
CallbackFunction
:
:
eRethrowExceptions
)
;
}
MOZ_CAN_RUN_SCRIPT
already_AddRefed
<
Promise
>
IDLUnderlyingSourcePullCallbackHelper
:
:
PullCallback
(
JSContext
*
aCx
ReadableStreamController
&
aController
ErrorResult
&
aRv
)
{
JS
:
:
RootedObject
thisObj
(
aCx
mThisObj
)
;
ReadableStreamDefaultControllerOrReadableByteStreamController
controller
;
if
(
aController
.
IsDefault
(
)
)
{
controller
.
SetAsReadableStreamDefaultController
(
)
=
aController
.
AsDefault
(
)
;
}
else
{
controller
.
SetAsReadableByteStreamController
(
)
=
aController
.
AsByte
(
)
;
}
RefPtr
<
UnderlyingSourcePullCallback
>
callback
(
mCallback
)
;
RefPtr
<
Promise
>
promise
=
callback
-
>
Call
(
thisObj
controller
aRv
"
UnderlyingSource
.
pull
"
CallbackFunction
:
:
eRethrowExceptions
)
;
return
promise
.
forget
(
)
;
}
BodyStreamUnderlyingSourcePullCallbackHelper
:
:
BodyStreamUnderlyingSourcePullCallbackHelper
(
BodyStreamHolder
*
underlyingSource
)
:
mUnderlyingSource
(
underlyingSource
)
{
}
already_AddRefed
<
Promise
>
BodyStreamUnderlyingSourcePullCallbackHelper
:
:
PullCallback
(
JSContext
*
aCx
ReadableStreamController
&
aController
ErrorResult
&
aRv
)
{
RefPtr
<
BodyStream
>
bodyStream
=
mUnderlyingSource
-
>
GetBodyStream
(
)
;
return
bodyStream
-
>
PullCallback
(
aCx
aController
aRv
)
;
}
already_AddRefed
<
Promise
>
IDLUnderlyingSourceCancelCallbackHelper
:
:
CancelCallback
(
JSContext
*
aCx
const
Optional
<
JS
:
:
Handle
<
JS
:
:
Value
>
>
&
aReason
ErrorResult
&
aRv
)
{
JS
:
:
RootedObject
thisObj
(
aCx
mThisObj
)
;
RefPtr
<
UnderlyingSourceCancelCallback
>
callback
(
mCallback
)
;
RefPtr
<
Promise
>
promise
=
callback
-
>
Call
(
thisObj
aReason
aRv
"
UnderlyingSource
.
cancel
"
CallbackFunction
:
:
eRethrowExceptions
)
;
return
promise
.
forget
(
)
;
}
BodyStreamUnderlyingSourceCancelCallbackHelper
:
:
BodyStreamUnderlyingSourceCancelCallbackHelper
(
BodyStreamHolder
*
aUnderlyingSource
)
:
mUnderlyingSource
(
aUnderlyingSource
)
{
}
already_AddRefed
<
Promise
>
BodyStreamUnderlyingSourceCancelCallbackHelper
:
:
CancelCallback
(
JSContext
*
aCx
const
Optional
<
JS
:
:
Handle
<
JS
:
:
Value
>
>
&
aReason
ErrorResult
&
aRv
)
{
RefPtr
<
BodyStream
>
bodyStream
=
mUnderlyingSource
-
>
GetBodyStream
(
)
;
return
bodyStream
-
>
CancelCallback
(
aCx
aReason
aRv
)
;
}
NS_IMPL_CYCLE_COLLECTION
(
BodyStreamUnderlyingSourceErrorCallbackHelper
mUnderlyingSource
)
NS_IMPL_ADDREF_INHERITED
(
BodyStreamUnderlyingSourceErrorCallbackHelper
UnderlyingSourceErrorCallbackHelper
)
NS_IMPL_RELEASE_INHERITED
(
BodyStreamUnderlyingSourceErrorCallbackHelper
UnderlyingSourceErrorCallbackHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
BodyStreamUnderlyingSourceErrorCallbackHelper
)
NS_INTERFACE_MAP_END_INHERITING
(
UnderlyingSourceErrorCallbackHelper
)
BodyStreamUnderlyingSourceErrorCallbackHelper
:
:
BodyStreamUnderlyingSourceErrorCallbackHelper
(
BodyStreamHolder
*
aUnderlyingSource
)
:
mUnderlyingSource
(
aUnderlyingSource
)
{
}
void
BodyStreamUnderlyingSourceErrorCallbackHelper
:
:
Call
(
)
{
RefPtr
<
BodyStream
>
bodyStream
=
mUnderlyingSource
-
>
GetBodyStream
(
)
;
bodyStream
-
>
ErrorCallback
(
)
;
}
}
