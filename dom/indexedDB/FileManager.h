#
ifndef
mozilla_dom_indexeddb_filemanager_h__
#
define
mozilla_dom_indexeddb_filemanager_h__
#
include
"
mozilla
/
dom
/
quota
/
CommonMetadata
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
PersistenceType
.
h
"
#
include
"
mozilla
/
dom
/
quota
/
UsageInfo
.
h
"
#
include
"
mozilla
/
InitializedOnce
.
h
"
#
include
"
FileManagerBase
.
h
"
class
nsIFile
;
class
mozIStorageConnection
;
namespace
mozilla
{
namespace
dom
{
namespace
indexedDB
{
class
FileManager
final
:
public
FileManagerBase
<
FileManager
>
public
AtomicSafeRefCounted
<
FileManager
>
{
using
PersistenceType
=
mozilla
:
:
dom
:
:
quota
:
:
PersistenceType
;
using
FileManagerBase
<
FileManager
>
:
:
MutexType
;
const
PersistenceType
mPersistenceType
;
const
quota
:
:
OriginMetadata
mOriginMetadata
;
const
nsString
mDatabaseName
;
LazyInitializedOnce
<
const
nsString
>
mDirectoryPath
;
LazyInitializedOnce
<
const
nsString
>
mJournalDirectoryPath
;
const
bool
mEnforcingQuota
;
static
MutexType
sMutex
;
public
:
[
[
nodiscard
]
]
static
nsCOMPtr
<
nsIFile
>
GetFileForId
(
nsIFile
*
aDirectory
int64_t
aId
)
;
[
[
nodiscard
]
]
static
nsCOMPtr
<
nsIFile
>
GetCheckedFileForId
(
nsIFile
*
aDirectory
int64_t
aId
)
;
static
nsresult
InitDirectory
(
nsIFile
&
aDirectory
nsIFile
&
aDatabaseFile
const
nsACString
&
aOrigin
uint32_t
aTelemetryId
)
;
static
Result
<
quota
:
:
FileUsageType
nsresult
>
GetUsage
(
nsIFile
*
aDirectory
)
;
FileManager
(
PersistenceType
aPersistenceType
const
quota
:
:
OriginMetadata
&
aOriginMetadata
const
nsAString
&
aDatabaseName
bool
aEnforcingQuota
)
;
PersistenceType
Type
(
)
const
{
return
mPersistenceType
;
}
const
quota
:
:
OriginMetadata
&
OriginMetadata
(
)
const
{
return
mOriginMetadata
;
}
const
nsACString
&
Origin
(
)
const
{
return
mOriginMetadata
.
mOrigin
;
}
const
nsAString
&
DatabaseName
(
)
const
{
return
mDatabaseName
;
}
bool
EnforcingQuota
(
)
const
{
return
mEnforcingQuota
;
}
nsresult
Init
(
nsIFile
*
aDirectory
mozIStorageConnection
&
aConnection
)
;
[
[
nodiscard
]
]
nsCOMPtr
<
nsIFile
>
GetDirectory
(
)
;
[
[
nodiscard
]
]
nsCOMPtr
<
nsIFile
>
GetCheckedDirectory
(
)
;
[
[
nodiscard
]
]
nsCOMPtr
<
nsIFile
>
GetJournalDirectory
(
)
;
[
[
nodiscard
]
]
nsCOMPtr
<
nsIFile
>
EnsureJournalDirectory
(
)
;
[
[
nodiscard
]
]
nsresult
SyncDeleteFile
(
int64_t
aId
)
;
[
[
nodiscard
]
]
nsresult
SyncDeleteFile
(
nsIFile
&
aFile
nsIFile
&
aJournalFile
)
;
[
[
nodiscard
]
]
nsresult
AsyncDeleteFile
(
int64_t
aFileId
)
;
MOZ_DECLARE_REFCOUNTED_TYPENAME
(
FileManager
)
static
StaticMutex
&
Mutex
(
)
{
return
sMutex
;
}
~
FileManager
(
)
=
default
;
}
;
}
}
}
#
endif
