#
include
"
SVGAnimatedPathSegList
.
h
"
#
include
<
utility
>
#
include
"
DOMSVGPathSegList
.
h
"
#
include
"
SVGPathSegListSMILType
.
h
"
#
include
"
mozilla
/
SMILValue
.
h
"
#
include
"
mozilla
/
dom
/
SVGElement
.
h
"
using
namespace
mozilla
:
:
dom
;
namespace
mozilla
{
nsresult
SVGAnimatedPathSegList
:
:
SetBaseValueString
(
const
nsAString
&
aValue
)
{
SVGPathData
newBaseValue
;
nsresult
rv
=
newBaseValue
.
SetValueFromString
(
aValue
)
;
DOMSVGPathSegList
*
baseValWrapper
=
nullptr
;
DOMSVGPathSegList
*
animValWrapper
=
nullptr
;
if
(
StaticPrefs
:
:
dom_svg_pathSeg_enabled
(
)
)
{
baseValWrapper
=
DOMSVGPathSegList
:
:
GetDOMWrapperIfExists
(
GetBaseValKey
(
)
)
;
if
(
baseValWrapper
)
{
baseValWrapper
-
>
InternalListWillChangeTo
(
newBaseValue
)
;
}
if
(
!
IsAnimating
(
)
)
{
animValWrapper
=
DOMSVGPathSegList
:
:
GetDOMWrapperIfExists
(
GetAnimValKey
(
)
)
;
if
(
animValWrapper
)
{
animValWrapper
-
>
InternalListWillChangeTo
(
newBaseValue
)
;
}
}
}
nsresult
rv2
=
mBaseVal
.
CopyFrom
(
newBaseValue
)
;
if
(
NS_FAILED
(
rv2
)
)
{
if
(
StaticPrefs
:
:
dom_svg_pathSeg_enabled
(
)
)
{
if
(
baseValWrapper
)
{
baseValWrapper
-
>
InternalListWillChangeTo
(
mBaseVal
)
;
}
if
(
animValWrapper
)
{
animValWrapper
-
>
InternalListWillChangeTo
(
mBaseVal
)
;
}
}
return
rv2
;
}
return
rv
;
}
void
SVGAnimatedPathSegList
:
:
ClearBaseValue
(
)
{
if
(
StaticPrefs
:
:
dom_svg_pathSeg_enabled
(
)
)
{
DOMSVGPathSegList
*
baseValWrapper
=
DOMSVGPathSegList
:
:
GetDOMWrapperIfExists
(
GetBaseValKey
(
)
)
;
if
(
baseValWrapper
)
{
baseValWrapper
-
>
InternalListWillChangeTo
(
SVGPathData
(
)
)
;
}
if
(
!
IsAnimating
(
)
)
{
DOMSVGPathSegList
*
animValWrapper
=
DOMSVGPathSegList
:
:
GetDOMWrapperIfExists
(
GetAnimValKey
(
)
)
;
if
(
animValWrapper
)
{
animValWrapper
-
>
InternalListWillChangeTo
(
SVGPathData
(
)
)
;
}
}
}
mBaseVal
.
Clear
(
)
;
}
nsresult
SVGAnimatedPathSegList
:
:
SetAnimValue
(
const
SVGPathData
&
aNewAnimValue
SVGElement
*
aElement
)
{
if
(
StaticPrefs
:
:
dom_svg_pathSeg_enabled
(
)
)
{
DOMSVGPathSegList
*
domWrapper
=
DOMSVGPathSegList
:
:
GetDOMWrapperIfExists
(
GetAnimValKey
(
)
)
;
if
(
domWrapper
)
{
domWrapper
-
>
InternalListWillChangeTo
(
aNewAnimValue
)
;
}
}
if
(
!
mAnimVal
)
{
mAnimVal
=
MakeUnique
<
SVGPathData
>
(
)
;
}
nsresult
rv
=
mAnimVal
-
>
CopyFrom
(
aNewAnimValue
)
;
if
(
NS_FAILED
(
rv
)
)
{
ClearAnimValue
(
aElement
)
;
}
aElement
-
>
DidAnimatePathSegList
(
)
;
return
rv
;
}
void
SVGAnimatedPathSegList
:
:
ClearAnimValue
(
SVGElement
*
aElement
)
{
if
(
StaticPrefs
:
:
dom_svg_pathSeg_enabled
(
)
)
{
DOMSVGPathSegList
*
domWrapper
=
DOMSVGPathSegList
:
:
GetDOMWrapperIfExists
(
GetAnimValKey
(
)
)
;
if
(
domWrapper
)
{
domWrapper
-
>
InternalListWillChangeTo
(
mBaseVal
)
;
}
}
mAnimVal
=
nullptr
;
aElement
-
>
DidAnimatePathSegList
(
)
;
}
bool
SVGAnimatedPathSegList
:
:
IsRendered
(
)
const
{
return
mAnimVal
?
!
mAnimVal
-
>
IsEmpty
(
)
:
!
mBaseVal
.
IsEmpty
(
)
;
}
UniquePtr
<
SMILAttr
>
SVGAnimatedPathSegList
:
:
ToSMILAttr
(
SVGElement
*
aElement
)
{
return
MakeUnique
<
SMILAnimatedPathSegList
>
(
this
aElement
)
;
}
nsresult
SVGAnimatedPathSegList
:
:
SMILAnimatedPathSegList
:
:
ValueFromString
(
const
nsAString
&
aStr
const
dom
:
:
SVGAnimationElement
*
SMILValue
&
aValue
bool
&
aPreventCachingOfSandwich
)
const
{
SMILValue
val
(
SVGPathSegListSMILType
:
:
Singleton
(
)
)
;
SVGPathDataAndInfo
*
list
=
static_cast
<
SVGPathDataAndInfo
*
>
(
val
.
mU
.
mPtr
)
;
nsresult
rv
=
list
-
>
SetValueFromString
(
aStr
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
list
-
>
SetElement
(
mElement
)
;
aValue
=
std
:
:
move
(
val
)
;
}
aPreventCachingOfSandwich
=
false
;
return
rv
;
}
SMILValue
SVGAnimatedPathSegList
:
:
SMILAnimatedPathSegList
:
:
GetBaseValue
(
)
const
{
SMILValue
val
;
SMILValue
tmp
(
SVGPathSegListSMILType
:
:
Singleton
(
)
)
;
SVGPathDataAndInfo
*
list
=
static_cast
<
SVGPathDataAndInfo
*
>
(
tmp
.
mU
.
mPtr
)
;
nsresult
rv
=
list
-
>
CopyFrom
(
mVal
-
>
mBaseVal
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
list
-
>
SetElement
(
mElement
)
;
val
=
std
:
:
move
(
tmp
)
;
}
return
val
;
}
nsresult
SVGAnimatedPathSegList
:
:
SMILAnimatedPathSegList
:
:
SetAnimValue
(
const
SMILValue
&
aValue
)
{
NS_ASSERTION
(
aValue
.
mType
=
=
SVGPathSegListSMILType
:
:
Singleton
(
)
"
Unexpected
type
to
assign
animated
value
"
)
;
if
(
aValue
.
mType
=
=
SVGPathSegListSMILType
:
:
Singleton
(
)
)
{
mVal
-
>
SetAnimValue
(
*
static_cast
<
SVGPathDataAndInfo
*
>
(
aValue
.
mU
.
mPtr
)
mElement
)
;
}
return
NS_OK
;
}
void
SVGAnimatedPathSegList
:
:
SMILAnimatedPathSegList
:
:
ClearAnimValue
(
)
{
if
(
mVal
-
>
mAnimVal
)
{
mVal
-
>
ClearAnimValue
(
mElement
)
;
}
}
size_t
SVGAnimatedPathSegList
:
:
SizeOfExcludingThis
(
MallocSizeOf
aMallocSizeOf
)
const
{
size_t
total
=
mBaseVal
.
SizeOfExcludingThis
(
aMallocSizeOf
)
;
if
(
mAnimVal
)
{
mAnimVal
-
>
SizeOfIncludingThis
(
aMallocSizeOf
)
;
}
return
total
;
}
}
