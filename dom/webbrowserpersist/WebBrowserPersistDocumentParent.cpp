#
include
"
WebBrowserPersistDocumentParent
.
h
"
#
include
"
WebBrowserPersistRemoteDocument
.
h
"
#
include
"
WebBrowserPersistResourcesParent
.
h
"
#
include
"
WebBrowserPersistSerializeParent
.
h
"
#
include
"
mozilla
/
dom
/
PContentParent
.
h
"
#
include
"
mozilla
/
ipc
/
IPCStreamUtils
.
h
"
#
include
"
nsIInputStream
.
h
"
#
include
"
nsThreadUtils
.
h
"
namespace
mozilla
{
WebBrowserPersistDocumentParent
:
:
WebBrowserPersistDocumentParent
(
)
:
mReflection
(
nullptr
)
{
}
void
WebBrowserPersistDocumentParent
:
:
SetOnReady
(
nsIWebBrowserPersistDocumentReceiver
*
aOnReady
)
{
MOZ_ASSERT
(
aOnReady
)
;
MOZ_ASSERT
(
!
mOnReady
)
;
MOZ_ASSERT
(
!
mReflection
)
;
mOnReady
=
aOnReady
;
}
void
WebBrowserPersistDocumentParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
if
(
mReflection
)
{
mReflection
-
>
ActorDestroy
(
)
;
mReflection
=
nullptr
;
}
if
(
mOnReady
)
{
nsCOMPtr
<
nsIRunnable
>
errorLater
=
NewRunnableMethod
<
nsresult
>
(
"
nsIWebBrowserPersistDocumentReceiver
:
:
OnError
"
mOnReady
&
nsIWebBrowserPersistDocumentReceiver
:
:
OnError
NS_ERROR_FAILURE
)
;
NS_DispatchToCurrentThread
(
errorLater
)
;
mOnReady
=
nullptr
;
}
}
WebBrowserPersistDocumentParent
:
:
~
WebBrowserPersistDocumentParent
(
)
{
MOZ_RELEASE_ASSERT
(
!
mReflection
)
;
MOZ_ASSERT
(
!
mOnReady
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
WebBrowserPersistDocumentParent
:
:
RecvAttributes
(
const
Attrs
&
aAttrs
const
Maybe
<
IPCStream
>
&
aPostStream
)
{
nsCOMPtr
<
nsIInputStream
>
postData
=
mozilla
:
:
ipc
:
:
DeserializeIPCStream
(
aPostStream
)
;
if
(
!
mOnReady
|
|
mReflection
)
{
return
IPC_FAIL_NO_REASON
(
this
)
;
}
mReflection
=
new
WebBrowserPersistRemoteDocument
(
this
aAttrs
postData
)
;
RefPtr
<
WebBrowserPersistRemoteDocument
>
reflection
=
mReflection
;
mOnReady
-
>
OnDocumentReady
(
reflection
)
;
mOnReady
=
nullptr
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
WebBrowserPersistDocumentParent
:
:
RecvInitFailure
(
const
nsresult
&
aFailure
)
{
if
(
!
mOnReady
|
|
mReflection
)
{
return
IPC_FAIL_NO_REASON
(
this
)
;
}
mOnReady
-
>
OnError
(
aFailure
)
;
mOnReady
=
nullptr
;
IProtocol
*
mgr
=
Manager
(
)
;
if
(
!
Send__delete__
(
this
)
)
{
return
IPC_FAIL_NO_REASON
(
mgr
)
;
}
return
IPC_OK
(
)
;
}
PWebBrowserPersistResourcesParent
*
WebBrowserPersistDocumentParent
:
:
AllocPWebBrowserPersistResourcesParent
(
)
{
MOZ_CRASH
(
"
Don
'
t
use
this
;
construct
the
actor
directly
and
AddRef
.
"
)
;
return
nullptr
;
}
bool
WebBrowserPersistDocumentParent
:
:
DeallocPWebBrowserPersistResourcesParent
(
PWebBrowserPersistResourcesParent
*
aActor
)
{
RefPtr
<
WebBrowserPersistResourcesParent
>
actor
=
already_AddRefed
<
WebBrowserPersistResourcesParent
>
(
static_cast
<
WebBrowserPersistResourcesParent
*
>
(
aActor
)
)
;
return
true
;
}
PWebBrowserPersistSerializeParent
*
WebBrowserPersistDocumentParent
:
:
AllocPWebBrowserPersistSerializeParent
(
const
WebBrowserPersistURIMap
&
aMap
const
nsACString
&
aRequestedContentType
const
uint32_t
&
aEncoderFlags
const
uint32_t
&
aWrapColumn
)
{
MOZ_CRASH
(
"
Don
'
t
use
this
;
construct
the
actor
directly
.
"
)
;
return
nullptr
;
}
bool
WebBrowserPersistDocumentParent
:
:
DeallocPWebBrowserPersistSerializeParent
(
PWebBrowserPersistSerializeParent
*
aActor
)
{
delete
aActor
;
return
true
;
}
}
