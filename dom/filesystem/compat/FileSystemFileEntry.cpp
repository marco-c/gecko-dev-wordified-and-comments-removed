#
include
"
FileSystemFileEntry
.
h
"
#
include
"
CallbackRunnables
.
h
"
#
include
"
mozilla
/
dom
/
File
.
h
"
#
include
"
mozilla
/
dom
/
FileSystemFileEntryBinding
.
h
"
#
include
"
mozilla
/
dom
/
FileSystemUtils
.
h
"
#
include
"
mozilla
/
dom
/
MultipartBlobImpl
.
h
"
namespace
mozilla
:
:
dom
{
namespace
{
class
FileCallbackRunnable
final
:
public
Runnable
{
public
:
FileCallbackRunnable
(
FileCallback
*
aCallback
File
*
aFile
)
:
Runnable
(
"
FileCallbackRunnable
"
)
mCallback
(
aCallback
)
mFile
(
aFile
)
{
MOZ_ASSERT
(
aCallback
)
;
MOZ_ASSERT
(
aFile
)
;
}
MOZ_CAN_RUN_SCRIPT_BOUNDARY
NS_IMETHOD
Run
(
)
override
{
RefPtr
<
File
>
file
=
File
:
:
Create
(
mFile
-
>
GetParentObject
(
)
mFile
-
>
Impl
(
)
)
;
mCallback
-
>
Call
(
*
file
)
;
return
NS_OK
;
}
private
:
const
RefPtr
<
FileCallback
>
mCallback
;
RefPtr
<
File
>
mFile
;
}
;
}
NS_IMPL_CYCLE_COLLECTION_INHERITED
(
FileSystemFileEntry
FileSystemEntry
mFile
)
NS_IMPL_ADDREF_INHERITED
(
FileSystemFileEntry
FileSystemEntry
)
NS_IMPL_RELEASE_INHERITED
(
FileSystemFileEntry
FileSystemEntry
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
FileSystemFileEntry
)
NS_INTERFACE_MAP_END_INHERITING
(
FileSystemEntry
)
FileSystemFileEntry
:
:
FileSystemFileEntry
(
nsIGlobalObject
*
aGlobal
File
*
aFile
FileSystemDirectoryEntry
*
aParentEntry
FileSystem
*
aFileSystem
)
:
FileSystemEntry
(
aGlobal
aParentEntry
aFileSystem
)
mFile
(
aFile
)
{
MOZ_ASSERT
(
aGlobal
)
;
MOZ_ASSERT
(
mFile
)
;
}
FileSystemFileEntry
:
:
~
FileSystemFileEntry
(
)
=
default
;
JSObject
*
FileSystemFileEntry
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
FileSystemFileEntry_Binding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
void
FileSystemFileEntry
:
:
GetName
(
nsAString
&
aName
ErrorResult
&
aRv
)
const
{
mFile
-
>
GetName
(
aName
)
;
}
void
FileSystemFileEntry
:
:
GetFullPath
(
nsAString
&
aPath
ErrorResult
&
aRv
)
const
{
mFile
-
>
Impl
(
)
-
>
GetDOMPath
(
aPath
)
;
if
(
aPath
.
IsEmpty
(
)
)
{
nsAutoString
name
;
mFile
-
>
GetName
(
name
)
;
aPath
.
AssignLiteral
(
FILESYSTEM_DOM_PATH_SEPARATOR_LITERAL
)
;
aPath
.
Append
(
name
)
;
}
}
void
FileSystemFileEntry
:
:
GetFile
(
FileCallback
&
aSuccessCallback
const
Optional
<
OwningNonNull
<
ErrorCallback
>
>
&
aErrorCallback
)
const
{
RefPtr
<
FileCallbackRunnable
>
runnable
=
new
FileCallbackRunnable
(
&
aSuccessCallback
mFile
)
;
FileSystemUtils
:
:
DispatchRunnable
(
GetParentObject
(
)
runnable
.
forget
(
)
)
;
}
}
