Cu
.
importGlobalProperties
(
[
"
File
"
]
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
function
createProfDFile
(
)
{
return
Services
.
dirsvc
.
QueryInterface
(
Ci
.
nsIProperties
)
.
get
(
"
ProfD
"
Ci
.
nsIFile
)
;
}
function
createTreeFile
(
depth
parent
)
{
if
(
!
parent
)
{
parent
=
Services
.
dirsvc
.
QueryInterface
(
Ci
.
nsIProperties
)
.
get
(
"
TmpD
"
Ci
.
nsIFile
)
;
parent
.
append
(
"
dir
-
tree
-
test
"
)
;
parent
.
createUnique
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
0o700
)
;
}
var
nextFile
=
parent
.
clone
(
)
;
if
(
depth
=
=
0
)
{
nextFile
.
append
(
"
file
.
txt
"
)
;
nextFile
.
create
(
Ci
.
nsIFile
.
NORMAL_FILE_TYPE
0o600
)
;
}
else
{
nextFile
.
append
(
"
subdir
"
+
depth
)
;
nextFile
.
createUnique
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
0o700
)
;
for
(
var
i
=
0
;
i
<
depth
;
i
+
+
)
{
createTreeFile
(
i
nextFile
)
;
}
}
return
parent
;
}
function
createRootFile
(
)
{
var
testFile
=
createProfDFile
(
)
;
while
(
true
)
{
var
parent
=
testFile
.
parent
;
if
(
!
parent
)
{
break
;
}
testFile
=
parent
;
}
return
testFile
;
}
function
createTestFile
(
)
{
var
tmpFile
=
Services
.
dirsvc
.
QueryInterface
(
Ci
.
nsIProperties
)
.
get
(
"
TmpD
"
Ci
.
nsIFile
)
;
tmpFile
.
append
(
"
dir
-
test
"
)
;
tmpFile
.
createUnique
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
0o700
)
;
var
file1
=
tmpFile
.
clone
(
)
;
file1
.
append
(
"
foo
.
txt
"
)
;
file1
.
create
(
Ci
.
nsIFile
.
NORMAL_FILE_TYPE
0o600
)
;
var
dir
=
tmpFile
.
clone
(
)
;
dir
.
append
(
"
subdir
"
)
;
dir
.
create
(
Ci
.
nsIFile
.
DIRECTORY_TYPE
0o700
)
;
var
file2
=
dir
.
clone
(
)
;
file2
.
append
(
"
bar
.
txt
"
)
;
file2
.
create
(
Ci
.
nsIFile
.
NORMAL_FILE_TYPE
0o600
)
;
return
tmpFile
;
}
addMessageListener
(
"
dir
.
open
"
function
(
e
)
{
var
testFile
;
switch
(
e
.
path
)
{
case
"
ProfD
"
:
testFile
=
createProfDFile
(
)
;
break
;
case
"
root
"
:
testFile
=
createRootFile
(
)
;
break
;
case
"
test
"
:
testFile
=
createTestFile
(
)
;
break
;
case
"
tree
"
:
testFile
=
createTreeFile
(
3
)
;
break
;
}
sendAsyncMessage
(
"
dir
.
opened
"
{
dir
:
testFile
.
path
name
:
testFile
.
leafName
}
)
;
}
)
;
addMessageListener
(
"
file
.
open
"
function
(
e
)
{
var
testFile
=
Services
.
dirsvc
.
QueryInterface
(
Ci
.
nsIProperties
)
.
get
(
"
ProfD
"
Ci
.
nsIFile
)
;
testFile
.
append
(
"
prefs
.
js
"
)
;
File
.
createFromNsIFile
(
testFile
)
.
then
(
function
(
file
)
{
sendAsyncMessage
(
"
file
.
opened
"
{
file
}
)
;
}
)
;
}
)
;
