#
include
"
mozilla
/
dom
/
DeviceStorageFileSystem
.
h
"
#
include
"
DeviceStorage
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
dom
/
Directory
.
h
"
#
include
"
mozilla
/
dom
/
File
.
h
"
#
include
"
mozilla
/
dom
/
FileSystemUtils
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsDeviceStorage
.
h
"
#
include
"
nsIFile
.
h
"
#
include
"
nsPIDOMWindow
.
h
"
#
include
"
nsGlobalWindow
.
h
"
namespace
mozilla
{
namespace
dom
{
DeviceStorageFileSystem
:
:
DeviceStorageFileSystem
(
const
nsAString
&
aStorageType
const
nsAString
&
aStorageName
)
:
mStorageType
(
aStorageType
)
mStorageName
(
aStorageName
)
mWindowId
(
0
)
{
mPermissionCheckType
=
ePermissionCheckByTestingPref
;
if
(
NS_IsMainThread
(
)
)
{
if
(
mozilla
:
:
Preferences
:
:
GetBool
(
"
device
.
storage
.
prompt
.
testing
"
false
)
)
{
mPermissionCheckType
=
ePermissionCheckNotRequired
;
}
else
{
mPermissionCheckType
=
ePermissionCheckRequired
;
}
}
else
{
AssertIsOnBackgroundThread
(
)
;
}
nsresult
rv
=
DeviceStorageTypeChecker
:
:
GetPermissionForType
(
mStorageType
mPermission
)
;
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
;
nsCOMPtr
<
nsIFile
>
rootFile
;
DeviceStorageFile
:
:
GetRootDirectoryForType
(
aStorageType
aStorageName
getter_AddRefs
(
rootFile
)
)
;
NS_WARN_IF
(
!
rootFile
|
|
NS_FAILED
(
rootFile
-
>
GetPath
(
mLocalOrDeviceStorageRootPath
)
)
)
;
if
(
!
XRE_IsParentProcess
(
)
)
{
return
;
}
if
(
NS_IsMainThread
(
)
)
{
DebugOnly
<
DeviceStorageTypeChecker
*
>
typeChecker
=
DeviceStorageTypeChecker
:
:
CreateOrGet
(
)
;
MOZ_ASSERT
(
typeChecker
)
;
}
}
DeviceStorageFileSystem
:
:
~
DeviceStorageFileSystem
(
)
{
AssertIsOnOwningThread
(
)
;
}
already_AddRefed
<
FileSystemBase
>
DeviceStorageFileSystem
:
:
Clone
(
)
{
AssertIsOnOwningThread
(
)
;
RefPtr
<
DeviceStorageFileSystem
>
fs
=
new
DeviceStorageFileSystem
(
mStorageType
mStorageName
)
;
fs
-
>
mWindowId
=
mWindowId
;
return
fs
.
forget
(
)
;
}
void
DeviceStorageFileSystem
:
:
Init
(
nsDOMDeviceStorage
*
aDeviceStorage
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
"
Only
call
on
main
thread
!
"
)
;
AssertIsOnOwningThread
(
)
;
MOZ_ASSERT
(
aDeviceStorage
)
;
nsCOMPtr
<
nsPIDOMWindowInner
>
window
=
aDeviceStorage
-
>
GetOwner
(
)
;
MOZ_ASSERT
(
window
-
>
IsInnerWindow
(
)
)
;
mWindowId
=
window
-
>
WindowID
(
)
;
}
void
DeviceStorageFileSystem
:
:
Shutdown
(
)
{
AssertIsOnOwningThread
(
)
;
mShutdown
=
true
;
}
nsISupports
*
DeviceStorageFileSystem
:
:
GetParentObject
(
)
const
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
"
Only
call
on
main
thread
!
"
)
;
AssertIsOnOwningThread
(
)
;
nsGlobalWindow
*
window
=
nsGlobalWindow
:
:
GetInnerWindowWithId
(
mWindowId
)
;
MOZ_ASSERT_IF
(
!
mShutdown
window
)
;
return
window
?
window
-
>
AsInner
(
)
:
nullptr
;
}
void
DeviceStorageFileSystem
:
:
GetDirectoryName
(
nsIFile
*
aFile
nsAString
&
aRetval
ErrorResult
&
aRv
)
const
{
AssertIsOnOwningThread
(
)
;
MOZ_ASSERT
(
aFile
)
;
nsCOMPtr
<
nsIFile
>
rootPath
;
aRv
=
NS_NewLocalFile
(
LocalOrDeviceStorageRootPath
(
)
false
getter_AddRefs
(
rootPath
)
)
;
if
(
NS_WARN_IF
(
aRv
.
Failed
(
)
)
)
{
return
;
}
bool
equal
=
false
;
aRv
=
aFile
-
>
Equals
(
rootPath
&
equal
)
;
if
(
NS_WARN_IF
(
aRv
.
Failed
(
)
)
)
{
return
;
}
if
(
equal
)
{
aRetval
=
mStorageName
;
return
;
}
FileSystemBase
:
:
GetDirectoryName
(
aFile
aRetval
aRv
)
;
NS_WARN_IF
(
aRv
.
Failed
(
)
)
;
}
bool
DeviceStorageFileSystem
:
:
IsSafeFile
(
nsIFile
*
aFile
)
const
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
"
Should
be
on
parent
process
!
"
)
;
MOZ_ASSERT
(
!
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aFile
)
;
nsCOMPtr
<
nsIFile
>
rootPath
;
nsresult
rv
=
NS_NewLocalFile
(
LocalOrDeviceStorageRootPath
(
)
false
getter_AddRefs
(
rootPath
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
false
;
}
if
(
NS_WARN_IF
(
!
FileSystemUtils
:
:
IsDescendantPath
(
rootPath
aFile
)
)
)
{
return
false
;
}
DeviceStorageTypeChecker
*
typeChecker
=
DeviceStorageTypeChecker
:
:
CreateOrGet
(
)
;
MOZ_ASSERT
(
typeChecker
)
;
return
typeChecker
-
>
Check
(
mStorageType
aFile
)
;
}
bool
DeviceStorageFileSystem
:
:
IsSafeDirectory
(
Directory
*
aDir
)
const
{
AssertIsOnOwningThread
(
)
;
MOZ_ASSERT
(
aDir
)
;
ErrorResult
rv
;
RefPtr
<
FileSystemBase
>
fs
=
aDir
-
>
GetFileSystem
(
rv
)
;
if
(
NS_WARN_IF
(
rv
.
Failed
(
)
)
)
{
rv
.
SuppressException
(
)
;
return
false
;
}
nsAutoString
fsSerialization
;
fs
-
>
SerializeDOMPath
(
fsSerialization
)
;
nsAutoString
thisSerialization
;
SerializeDOMPath
(
thisSerialization
)
;
return
fsSerialization
=
=
thisSerialization
;
}
void
DeviceStorageFileSystem
:
:
SerializeDOMPath
(
nsAString
&
aString
)
const
{
AssertIsOnOwningThread
(
)
;
aString
.
AssignLiteral
(
"
devicestorage
-
"
)
;
aString
.
Append
(
mStorageType
)
;
aString
.
Append
(
'
-
'
)
;
aString
.
Append
(
mStorageName
)
;
}
nsresult
DeviceStorageFileSystem
:
:
MainThreadWork
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
DebugOnly
<
DeviceStorageTypeChecker
*
>
typeChecker
=
DeviceStorageTypeChecker
:
:
CreateOrGet
(
)
;
MOZ_ASSERT
(
typeChecker
)
;
return
NS_OK
;
}
}
}
