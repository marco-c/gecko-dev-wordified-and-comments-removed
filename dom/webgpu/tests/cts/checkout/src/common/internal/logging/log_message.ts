import
{
ErrorWithExtra
}
from
'
.
.
/
.
.
/
util
/
util
.
js
'
;
import
{
extractImportantStackTrace
}
from
'
.
.
/
stack
.
js
'
;
import
{
LogMessageRawData
}
from
'
.
/
result
.
js
'
;
export
class
LogMessageWithStack
extends
Error
{
readonly
extra
:
unknown
;
private
stackHiddenMessage
:
string
|
undefined
=
undefined
;
static
wrapError
(
name
:
string
ex
:
Error
|
ErrorWithExtra
)
{
return
new
LogMessageWithStack
(
{
name
message
:
ex
.
message
stackHiddenMessage
:
undefined
stack
:
ex
.
stack
extra
:
'
extra
'
in
ex
?
ex
.
extra
:
undefined
}
)
;
}
constructor
(
o
:
LogMessageRawData
)
{
super
(
o
.
message
)
;
this
.
name
=
o
.
name
;
this
.
stackHiddenMessage
=
o
.
stackHiddenMessage
;
this
.
stack
=
o
.
stack
;
this
.
extra
=
o
.
extra
;
}
setStackHidden
(
stackHiddenMessage
:
string
)
{
this
.
stackHiddenMessage
?
?
=
stackHiddenMessage
;
}
toJSON
(
)
:
string
{
let
m
=
this
.
name
;
if
(
this
.
message
)
m
+
=
'
:
'
+
this
.
message
;
if
(
this
.
stack
)
{
if
(
this
.
stackHiddenMessage
=
=
=
undefined
)
{
m
+
=
'
\
n
'
+
extractImportantStackTrace
(
this
)
;
}
else
if
(
this
.
stackHiddenMessage
)
{
m
+
=
\
n
at
(
elided
:
{
this
.
stackHiddenMessage
}
)
;
}
}
return
m
;
}
toRawData
(
)
:
LogMessageRawData
{
let
extra
=
this
.
extra
;
if
(
extra
!
=
=
undefined
)
{
extra
=
JSON
.
parse
(
JSON
.
stringify
(
extra
)
)
;
}
return
{
name
:
this
.
name
message
:
this
.
message
stackHiddenMessage
:
this
.
stackHiddenMessage
stack
:
this
.
stack
extra
}
;
}
}
export
function
prettyPrintLog
(
log
:
LogMessageWithStack
)
:
string
{
return
'
-
'
+
log
.
toJSON
(
)
.
replace
(
/
\
n
/
g
'
\
n
'
)
;
}
