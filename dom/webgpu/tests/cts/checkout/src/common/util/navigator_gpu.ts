import
{
TestCaseRecorder
}
from
'
.
.
/
framework
/
fixture
.
js
'
;
import
{
ErrorWithExtra
assert
objectEquals
}
from
'
.
/
util
.
js
'
;
function
defaultGPUProvider
(
)
:
GPU
{
assert
(
typeof
navigator
!
=
=
'
undefined
'
&
&
navigator
.
gpu
!
=
=
undefined
'
No
WebGPU
implementation
found
'
)
;
return
navigator
.
gpu
;
}
export
type
GPUProvider
=
(
)
=
>
GPU
;
let
gpuProvider
:
GPUProvider
=
defaultGPUProvider
;
export
function
setGPUProvider
(
provider
:
GPUProvider
)
{
assert
(
impl
=
=
=
undefined
'
setGPUProvider
(
)
should
not
be
after
getGPU
(
)
'
)
;
gpuProvider
=
provider
;
}
let
impl
:
GPU
|
undefined
=
undefined
;
let
defaultRequestAdapterOptions
:
GPURequestAdapterOptions
|
undefined
;
export
function
setDefaultRequestAdapterOptions
(
options
:
GPURequestAdapterOptions
)
{
if
(
objectEquals
(
options
defaultRequestAdapterOptions
)
)
{
return
;
}
if
(
impl
)
{
throw
new
Error
(
'
must
call
setDefaultRequestAdapterOptions
before
getGPU
'
)
;
}
defaultRequestAdapterOptions
=
{
.
.
.
options
}
;
}
export
function
getDefaultRequestAdapterOptions
(
)
{
return
defaultRequestAdapterOptions
;
}
export
function
getGPU
(
recorder
:
TestCaseRecorder
|
null
)
:
GPU
{
if
(
impl
)
{
return
impl
;
}
impl
=
gpuProvider
(
)
;
if
(
defaultRequestAdapterOptions
)
{
const
oldFn
=
impl
.
requestAdapter
;
impl
.
requestAdapter
=
function
(
options
?
:
GPURequestAdapterOptions
)
:
Promise
<
GPUAdapter
|
null
>
{
const
promise
=
oldFn
.
call
(
this
{
.
.
.
defaultRequestAdapterOptions
.
.
.
options
}
)
;
if
(
recorder
)
{
void
promise
.
then
(
async
adapter
=
>
{
if
(
adapter
)
{
const
info
=
adapter
.
info
|
|
(
await
adapter
.
requestAdapterInfo
(
)
)
;
const
infoString
=
Adapter
:
{
info
.
vendor
}
/
{
info
.
architecture
}
/
{
info
.
device
}
;
recorder
.
debug
(
new
ErrorWithExtra
(
infoString
(
)
=
>
(
{
adapterInfo
:
info
}
)
)
)
;
}
}
)
;
}
return
promise
;
}
;
}
return
impl
;
}
