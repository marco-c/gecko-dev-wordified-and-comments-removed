interface
DataStore
{
load
(
path
:
string
)
:
Promise
<
string
>
;
}
export
type
Logger
=
(
s
:
string
)
=
>
void
;
export
class
DataCache
{
public
setStore
(
dataStore
:
DataStore
)
{
this
.
dataStore
=
dataStore
;
}
public
setDebugLogger
(
logger
:
Logger
)
{
this
.
debugLogger
=
logger
;
}
public
async
fetch
<
Data
>
(
cacheable
:
Cacheable
<
Data
>
)
:
Promise
<
Data
>
{
let
data
=
this
.
cache
.
get
(
cacheable
.
path
)
;
if
(
data
!
=
=
undefined
)
{
this
.
log
(
'
in
-
memory
cache
hit
'
)
;
return
Promise
.
resolve
(
data
as
Data
)
;
}
this
.
log
(
'
in
-
memory
cache
miss
'
)
;
if
(
this
.
dataStore
!
=
=
null
&
&
!
this
.
unavailableFiles
.
has
(
cacheable
.
path
)
)
{
let
serialized
:
string
|
undefined
;
try
{
serialized
=
await
this
.
dataStore
.
load
(
cacheable
.
path
)
;
this
.
log
(
'
loaded
serialized
'
)
;
}
catch
(
err
)
{
this
.
log
(
failed
to
load
(
{
cacheable
.
path
}
)
:
{
err
}
)
;
this
.
unavailableFiles
.
add
(
cacheable
.
path
)
;
}
if
(
serialized
!
=
=
undefined
)
{
this
.
log
(
deserializing
)
;
data
=
cacheable
.
deserialize
(
serialized
)
;
this
.
cache
.
set
(
cacheable
.
path
data
)
;
return
data
as
Data
;
}
}
this
.
log
(
cache
:
building
(
{
cacheable
.
path
}
)
)
;
data
=
await
cacheable
.
build
(
)
;
this
.
cache
.
set
(
cacheable
.
path
data
)
;
return
data
as
Data
;
}
private
log
(
msg
:
string
)
{
if
(
this
.
debugLogger
!
=
=
null
)
{
this
.
debugLogger
(
DataCache
:
{
msg
}
)
;
}
}
private
cache
=
new
Map
<
string
unknown
>
(
)
;
private
unavailableFiles
=
new
Set
<
string
>
(
)
;
private
dataStore
:
DataStore
|
null
=
null
;
private
debugLogger
:
Logger
|
null
=
null
;
}
export
const
dataCache
=
new
DataCache
(
)
;
let
isBuildingDataCache
=
false
;
export
function
getIsBuildingDataCache
(
)
{
return
isBuildingDataCache
;
}
export
function
setIsBuildingDataCache
(
value
=
true
)
{
isBuildingDataCache
=
value
;
}
export
interface
Cacheable
<
Data
>
{
readonly
path
:
string
;
build
(
)
:
Promise
<
Data
>
;
serialize
(
data
:
Data
)
:
string
;
deserialize
(
serialized
:
string
)
:
Data
;
}
