#
ifndef
WEBGPU_CHILD_H_
#
define
WEBGPU_CHILD_H_
#
include
"
mozilla
/
webgpu
/
PWebGPUChild
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
namespace
mozilla
{
namespace
dom
{
struct
GPURequestAdapterOptions
;
}
namespace
layers
{
class
CompositorBridgeChild
;
}
namespace
webgpu
{
namespace
ffi
{
struct
WGPUClient
;
struct
WGPULimits
;
struct
WGPUTextureViewDescriptor
;
}
using
AdapterPromise
=
MozPromise
<
ipc
:
:
ByteBuf
Maybe
<
ipc
:
:
ResponseRejectReason
>
true
>
;
using
PipelinePromise
=
MozPromise
<
RawId
ipc
:
:
ResponseRejectReason
true
>
;
struct
PipelineCreationContext
{
RawId
mParentId
=
0
;
RawId
mImplicitPipelineLayoutId
=
0
;
nsTArray
<
RawId
>
mImplicitBindGroupLayoutIds
;
}
;
ffi
:
:
WGPUByteBuf
*
ToFFI
(
ipc
:
:
ByteBuf
*
x
)
;
class
WebGPUChild
final
:
public
PWebGPUChild
public
SupportsWeakPtr
{
public
:
friend
class
layers
:
:
CompositorBridgeChild
;
NS_DECL_CYCLE_COLLECTION_NATIVE_CLASS
(
WebGPUChild
)
NS_INLINE_DECL_CYCLE_COLLECTING_NATIVE_REFCOUNTING
(
WebGPUChild
)
public
:
explicit
WebGPUChild
(
)
;
bool
IsOpen
(
)
const
{
return
mIPCOpen
;
}
RefPtr
<
AdapterPromise
>
InstanceRequestAdapter
(
const
dom
:
:
GPURequestAdapterOptions
&
aOptions
)
;
Maybe
<
RawId
>
AdapterRequestDevice
(
RawId
aSelfId
const
dom
:
:
GPUDeviceDescriptor
&
aDesc
ffi
:
:
WGPULimits
*
aLimtis
)
;
RawId
DeviceCreateBuffer
(
RawId
aSelfId
const
dom
:
:
GPUBufferDescriptor
&
aDesc
)
;
RawId
DeviceCreateTexture
(
RawId
aSelfId
const
dom
:
:
GPUTextureDescriptor
&
aDesc
)
;
RawId
TextureCreateView
(
RawId
aSelfId
RawId
aDeviceId
const
dom
:
:
GPUTextureViewDescriptor
&
aDesc
)
;
RawId
DeviceCreateSampler
(
RawId
aSelfId
const
dom
:
:
GPUSamplerDescriptor
&
aDesc
)
;
RawId
DeviceCreateCommandEncoder
(
RawId
aSelfId
const
dom
:
:
GPUCommandEncoderDescriptor
&
aDesc
)
;
RawId
CommandEncoderFinish
(
RawId
aSelfId
RawId
aDeviceId
const
dom
:
:
GPUCommandBufferDescriptor
&
aDesc
)
;
RawId
RenderBundleEncoderFinish
(
ffi
:
:
WGPURenderBundleEncoder
&
aEncoder
RawId
aDeviceId
const
dom
:
:
GPURenderBundleDescriptor
&
aDesc
)
;
RawId
DeviceCreateBindGroupLayout
(
RawId
aSelfId
const
dom
:
:
GPUBindGroupLayoutDescriptor
&
aDesc
)
;
RawId
DeviceCreatePipelineLayout
(
RawId
aSelfId
const
dom
:
:
GPUPipelineLayoutDescriptor
&
aDesc
)
;
RawId
DeviceCreateBindGroup
(
RawId
aSelfId
const
dom
:
:
GPUBindGroupDescriptor
&
aDesc
)
;
RawId
DeviceCreateShaderModule
(
RawId
aSelfId
const
dom
:
:
GPUShaderModuleDescriptor
&
aDesc
)
;
RawId
DeviceCreateComputePipeline
(
PipelineCreationContext
*
const
aContext
const
dom
:
:
GPUComputePipelineDescriptor
&
aDesc
)
;
RefPtr
<
PipelinePromise
>
DeviceCreateComputePipelineAsync
(
PipelineCreationContext
*
const
aContext
const
dom
:
:
GPUComputePipelineDescriptor
&
aDesc
)
;
RawId
DeviceCreateRenderPipeline
(
PipelineCreationContext
*
const
aContext
const
dom
:
:
GPURenderPipelineDescriptor
&
aDesc
)
;
RefPtr
<
PipelinePromise
>
DeviceCreateRenderPipelineAsync
(
PipelineCreationContext
*
const
aContext
const
dom
:
:
GPURenderPipelineDescriptor
&
aDesc
)
;
void
DeviceCreateSwapChain
(
RawId
aSelfId
const
RGBDescriptor
&
aRgbDesc
size_t
maxBufferCount
wr
:
:
ExternalImageId
aExternalImageId
)
;
void
SwapChainPresent
(
wr
:
:
ExternalImageId
aExternalImageId
RawId
aTextureId
)
;
void
RegisterDevice
(
RawId
aId
Device
*
aDevice
)
;
void
UnregisterDevice
(
RawId
aId
)
;
static
void
ConvertTextureFormatRef
(
const
dom
:
:
GPUTextureFormat
&
aInput
ffi
:
:
WGPUTextureFormat
&
aOutput
)
;
private
:
virtual
~
WebGPUChild
(
)
;
void
JsWarning
(
nsIGlobalObject
*
aGlobal
const
nsACString
&
aMessage
)
;
RawId
DeviceCreateComputePipelineImpl
(
PipelineCreationContext
*
const
aContext
const
dom
:
:
GPUComputePipelineDescriptor
&
aDesc
ipc
:
:
ByteBuf
*
const
aByteBuf
)
;
RawId
DeviceCreateRenderPipelineImpl
(
PipelineCreationContext
*
const
aContext
const
dom
:
:
GPURenderPipelineDescriptor
&
aDesc
ipc
:
:
ByteBuf
*
const
aByteBuf
)
;
void
AddIPDLReference
(
)
{
MOZ_ASSERT
(
!
mIPCOpen
)
;
mIPCOpen
=
true
;
AddRef
(
)
;
}
void
ReleaseIPDLReference
(
)
{
MOZ_ASSERT
(
mIPCOpen
)
;
mIPCOpen
=
false
;
Release
(
)
;
}
ffi
:
:
WGPUClient
*
const
mClient
;
bool
mIPCOpen
;
std
:
:
unordered_map
<
RawId
Device
*
>
mDeviceMap
;
public
:
ipc
:
:
IPCResult
RecvDeviceUncapturedError
(
RawId
aDeviceId
const
nsACString
&
aMessage
)
;
ipc
:
:
IPCResult
RecvDropAction
(
const
ipc
:
:
ByteBuf
&
aByteBuf
)
;
}
;
}
}
#
endif
