#
include
"
mozilla
/
dom
/
WebGPUBinding
.
h
"
#
include
"
Adapter
.
h
"
#
include
"
Device
.
h
"
#
include
"
Instance
.
h
"
#
include
"
ipc
/
WebGPUChild
.
h
"
#
include
"
mozilla
/
dom
/
Promise
.
h
"
namespace
mozilla
{
namespace
webgpu
{
GPU_IMPL_CYCLE_COLLECTION
(
Adapter
mParent
)
GPU_IMPL_JS_WRAP
(
Adapter
)
Adapter
:
:
Adapter
(
RefPtr
<
Instance
>
aParent
RawId
aId
)
:
ChildOf
(
aParent
)
mBridge
(
aParent
-
>
GetBridge
(
)
)
mId
(
aId
)
{
}
Adapter
:
:
~
Adapter
(
)
=
default
;
RefPtr
<
WebGPUChild
>
Adapter
:
:
GetBridge
(
)
const
{
return
mBridge
;
}
already_AddRefed
<
dom
:
:
Promise
>
Adapter
:
:
RequestDevice
(
const
dom
:
:
GPUDeviceDescriptor
&
aDesc
ErrorResult
&
aRv
)
{
RefPtr
<
dom
:
:
Promise
>
promise
=
dom
:
:
Promise
:
:
Create
(
GetParentObject
(
)
aRv
)
;
if
(
NS_WARN_IF
(
aRv
.
Failed
(
)
)
)
{
return
nullptr
;
}
Maybe
<
RawId
>
id
=
mBridge
-
>
AdapterRequestDevice
(
mId
aDesc
)
;
if
(
id
.
isSome
(
)
)
{
RefPtr
<
Device
>
device
=
new
Device
(
this
id
.
value
(
)
)
;
promise
-
>
MaybeResolve
(
device
)
;
}
else
{
promise
-
>
MaybeReject
(
nsresult
(
0
)
)
;
}
return
promise
.
forget
(
)
;
}
}
}
