#
ifndef
mozilla_dom_worklet_WorkletImpl_h
#
define
mozilla_dom_worklet_WorkletImpl_h
#
include
"
MainThreadUtils
.
h
"
#
include
"
mozilla
/
OriginAttributes
.
h
"
class
nsPIDOMWindowInner
;
class
nsIPrincipal
;
class
nsIRunnable
;
namespace
mozilla
{
namespace
dom
{
class
Worklet
;
class
WorkletGlobalScope
;
class
WorkletThread
;
}
class
WorkletLoadInfo
{
public
:
WorkletLoadInfo
(
nsPIDOMWindowInner
*
aWindow
nsIPrincipal
*
aPrincipal
)
;
~
WorkletLoadInfo
(
)
;
uint64_t
OuterWindowID
(
)
const
{
return
mOuterWindowID
;
}
uint64_t
InnerWindowID
(
)
const
{
return
mInnerWindowID
;
}
bool
DumpEnabled
(
)
const
{
return
mDumpEnabled
;
}
const
OriginAttributes
&
OriginAttributesRef
(
)
const
{
return
mOriginAttributes
;
}
nsIPrincipal
*
Principal
(
)
const
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
mPrincipal
;
}
private
:
uint64_t
mOuterWindowID
;
const
uint64_t
mInnerWindowID
;
const
bool
mDumpEnabled
;
const
OriginAttributes
mOriginAttributes
;
nsCOMPtr
<
nsIPrincipal
>
mPrincipal
;
friend
class
WorkletImpl
;
friend
class
WorkletThread
;
}
;
class
WorkletImpl
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
WorkletImpl
)
;
enum
WorkletType
{
eAudioWorklet
ePaintWorklet
}
;
static
already_AddRefed
<
dom
:
:
Worklet
>
CreateWorklet
(
nsPIDOMWindowInner
*
aWindow
nsIPrincipal
*
aPrincipal
WorkletType
aWorkletType
)
;
JSObject
*
WrapWorklet
(
JSContext
*
aCx
dom
:
:
Worklet
*
aWorklet
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
;
dom
:
:
WorkletThread
*
GetOrCreateThread
(
)
;
void
TerminateThread
(
)
;
already_AddRefed
<
dom
:
:
WorkletGlobalScope
>
CreateGlobalScope
(
JSContext
*
aCx
)
;
const
WorkletLoadInfo
&
LoadInfo
(
)
const
{
return
mWorkletLoadInfo
;
}
nsresult
DispatchRunnable
(
already_AddRefed
<
nsIRunnable
>
aRunnable
)
;
private
:
WorkletImpl
(
nsPIDOMWindowInner
*
aWindow
nsIPrincipal
*
aPrincipal
WorkletType
aWorkletType
)
;
~
WorkletImpl
(
)
;
WorkletLoadInfo
mWorkletLoadInfo
;
const
WorkletType
mWorkletType
;
RefPtr
<
dom
:
:
WorkletThread
>
mWorkletThread
;
}
;
}
#
endif
