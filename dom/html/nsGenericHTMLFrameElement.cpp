#
include
"
nsGenericHTMLFrameElement
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
HTMLIFrameElement
.
h
"
#
include
"
mozilla
/
dom
/
XULFrameElement
.
h
"
#
include
"
mozilla
/
dom
/
BrowserBridgeChild
.
h
"
#
include
"
mozilla
/
dom
/
WindowProxyHolder
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
ProfilerLabels
.
h
"
#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
nsAttrValueInlines
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsIPermissionManager
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsSubDocumentFrame
.
h
"
#
include
"
nsAttrValueOrString
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
NS_IMPL_CYCLE_COLLECTION_CLASS
(
nsGenericHTMLFrameElement
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED
(
nsGenericHTMLFrameElement
nsGenericHTMLElement
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE
(
mFrameLoader
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED
(
nsGenericHTMLFrameElement
nsGenericHTMLElement
)
if
(
tmp
-
>
mFrameLoader
)
{
tmp
-
>
mFrameLoader
-
>
Destroy
(
)
;
}
NS_IMPL_CYCLE_COLLECTION_UNLINK
(
mFrameLoader
)
NS_IMPL_CYCLE_COLLECTION_UNLINK_END
NS_IMPL_ISUPPORTS_CYCLE_COLLECTION_INHERITED
(
nsGenericHTMLFrameElement
nsGenericHTMLElement
nsFrameLoaderOwner
nsGenericHTMLFrameElement
)
int32_t
nsGenericHTMLFrameElement
:
:
TabIndexDefault
(
)
{
return
0
;
}
nsGenericHTMLFrameElement
:
:
~
nsGenericHTMLFrameElement
(
)
{
if
(
mFrameLoader
)
{
mFrameLoader
-
>
Destroy
(
)
;
}
}
Document
*
nsGenericHTMLFrameElement
:
:
GetContentDocument
(
nsIPrincipal
&
aSubjectPrincipal
)
{
RefPtr
<
BrowsingContext
>
bc
=
GetContentWindowInternal
(
)
;
if
(
!
bc
)
{
return
nullptr
;
}
nsPIDOMWindowOuter
*
window
=
bc
-
>
GetDOMWindow
(
)
;
if
(
!
window
)
{
return
nullptr
;
}
Document
*
doc
=
window
-
>
GetDoc
(
)
;
if
(
!
doc
)
{
return
nullptr
;
}
if
(
!
aSubjectPrincipal
.
SubsumesConsideringDomain
(
doc
-
>
NodePrincipal
(
)
)
)
{
return
nullptr
;
}
return
doc
;
}
BrowsingContext
*
nsGenericHTMLFrameElement
:
:
GetContentWindowInternal
(
)
{
EnsureFrameLoader
(
)
;
if
(
!
mFrameLoader
)
{
return
nullptr
;
}
if
(
mFrameLoader
-
>
DepthTooGreat
(
)
)
{
return
nullptr
;
}
RefPtr
<
BrowsingContext
>
bc
=
mFrameLoader
-
>
GetBrowsingContext
(
)
;
return
bc
;
}
Nullable
<
WindowProxyHolder
>
nsGenericHTMLFrameElement
:
:
GetContentWindow
(
)
{
RefPtr
<
BrowsingContext
>
bc
=
GetContentWindowInternal
(
)
;
if
(
!
bc
)
{
return
nullptr
;
}
return
WindowProxyHolder
(
bc
)
;
}
void
nsGenericHTMLFrameElement
:
:
EnsureFrameLoader
(
)
{
if
(
!
IsInComposedDoc
(
)
|
|
mFrameLoader
|
|
OwnerDoc
(
)
-
>
IsStaticDocument
(
)
)
{
return
;
}
mFrameLoader
=
nsFrameLoader
:
:
Create
(
this
mNetworkCreated
)
;
}
void
nsGenericHTMLFrameElement
:
:
SwapFrameLoaders
(
HTMLIFrameElement
&
aOtherLoaderOwner
ErrorResult
&
rv
)
{
if
(
&
aOtherLoaderOwner
=
=
this
)
{
return
;
}
aOtherLoaderOwner
.
SwapFrameLoaders
(
this
rv
)
;
}
void
nsGenericHTMLFrameElement
:
:
SwapFrameLoaders
(
XULFrameElement
&
aOtherLoaderOwner
ErrorResult
&
rv
)
{
aOtherLoaderOwner
.
SwapFrameLoaders
(
this
rv
)
;
}
void
nsGenericHTMLFrameElement
:
:
SwapFrameLoaders
(
nsFrameLoaderOwner
*
aOtherLoaderOwner
mozilla
:
:
ErrorResult
&
rv
)
{
if
(
RefPtr
<
Document
>
doc
=
GetComposedDoc
(
)
)
{
doc
-
>
FlushPendingNotifications
(
FlushType
:
:
Frames
)
;
}
RefPtr
<
nsFrameLoader
>
loader
=
GetFrameLoader
(
)
;
RefPtr
<
nsFrameLoader
>
otherLoader
=
aOtherLoaderOwner
-
>
GetFrameLoader
(
)
;
if
(
!
loader
|
|
!
otherLoader
)
{
rv
.
Throw
(
NS_ERROR_NOT_IMPLEMENTED
)
;
return
;
}
rv
=
loader
-
>
SwapWithOtherLoader
(
otherLoader
this
aOtherLoaderOwner
)
;
}
void
nsGenericHTMLFrameElement
:
:
LoadSrc
(
)
{
if
(
mLazyLoading
)
{
return
;
}
EnsureFrameLoader
(
)
;
if
(
!
mFrameLoader
)
{
return
;
}
bool
origSrc
=
!
mSrcLoadHappened
;
mSrcLoadHappened
=
true
;
mFrameLoader
-
>
LoadFrame
(
origSrc
)
;
}
nsresult
nsGenericHTMLFrameElement
:
:
BindToTree
(
BindContext
&
aContext
nsINode
&
aParent
)
{
nsresult
rv
=
nsGenericHTMLElement
:
:
BindToTree
(
aContext
aParent
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
IsInComposedDoc
(
)
)
{
NS_ASSERTION
(
!
nsContentUtils
:
:
IsSafeToRunScript
(
)
"
Missing
a
script
blocker
!
"
)
;
AUTO_PROFILER_LABEL
(
"
nsGenericHTMLFrameElement
:
:
BindToTree
"
OTHER
)
;
LoadSrc
(
)
;
}
mNetworkCreated
=
false
;
return
rv
;
}
void
nsGenericHTMLFrameElement
:
:
UnbindFromTree
(
UnbindContext
&
aContext
)
{
if
(
mFrameLoader
)
{
mFrameLoader
-
>
Destroy
(
)
;
mFrameLoader
=
nullptr
;
}
nsGenericHTMLElement
:
:
UnbindFromTree
(
aContext
)
;
}
ScrollbarPreference
nsGenericHTMLFrameElement
:
:
MapScrollingAttribute
(
const
nsAttrValue
*
aValue
)
{
if
(
aValue
&
&
aValue
-
>
Type
(
)
=
=
nsAttrValue
:
:
eEnum
)
{
auto
scrolling
=
static_cast
<
ScrollingAttribute
>
(
aValue
-
>
GetEnumValue
(
)
)
;
if
(
scrolling
=
=
ScrollingAttribute
:
:
Off
|
|
scrolling
=
=
ScrollingAttribute
:
:
Noscroll
|
|
scrolling
=
=
ScrollingAttribute
:
:
No
)
{
return
ScrollbarPreference
:
:
Never
;
}
}
return
ScrollbarPreference
:
:
Auto
;
}
void
nsGenericHTMLFrameElement
:
:
AfterSetAttr
(
int32_t
aNameSpaceID
nsAtom
*
aName
const
nsAttrValue
*
aValue
const
nsAttrValue
*
aOldValue
nsIPrincipal
*
aMaybeScriptedPrincipal
bool
aNotify
)
{
if
(
aValue
)
{
nsAttrValueOrString
value
(
aValue
)
;
AfterMaybeChangeAttr
(
aNameSpaceID
aName
&
value
aMaybeScriptedPrincipal
aNotify
)
;
}
else
{
AfterMaybeChangeAttr
(
aNameSpaceID
aName
nullptr
aMaybeScriptedPrincipal
aNotify
)
;
}
if
(
aNameSpaceID
=
=
kNameSpaceID_None
)
{
if
(
aName
=
=
nsGkAtoms
:
:
scrolling
)
{
if
(
mFrameLoader
)
{
ScrollbarPreference
pref
=
MapScrollingAttribute
(
aValue
)
;
if
(
nsDocShell
*
docshell
=
mFrameLoader
-
>
GetExistingDocShell
(
)
)
{
docshell
-
>
SetScrollbarPreference
(
pref
)
;
}
else
if
(
auto
*
child
=
mFrameLoader
-
>
GetBrowserBridgeChild
(
)
)
{
child
-
>
SendScrollbarPreferenceChanged
(
pref
)
;
}
}
}
}
return
nsGenericHTMLElement
:
:
AfterSetAttr
(
aNameSpaceID
aName
aValue
aOldValue
aMaybeScriptedPrincipal
aNotify
)
;
}
void
nsGenericHTMLFrameElement
:
:
OnAttrSetButNotChanged
(
int32_t
aNamespaceID
nsAtom
*
aName
const
nsAttrValueOrString
&
aValue
bool
aNotify
)
{
AfterMaybeChangeAttr
(
aNamespaceID
aName
&
aValue
nullptr
aNotify
)
;
return
nsGenericHTMLElement
:
:
OnAttrSetButNotChanged
(
aNamespaceID
aName
aValue
aNotify
)
;
}
void
nsGenericHTMLFrameElement
:
:
AfterMaybeChangeAttr
(
int32_t
aNamespaceID
nsAtom
*
aName
const
nsAttrValueOrString
*
aValue
nsIPrincipal
*
aMaybeScriptedPrincipal
bool
aNotify
)
{
if
(
aNamespaceID
=
=
kNameSpaceID_None
)
{
if
(
aName
=
=
nsGkAtoms
:
:
src
)
{
mSrcTriggeringPrincipal
=
nsContentUtils
:
:
GetAttrTriggeringPrincipal
(
this
aValue
?
aValue
-
>
String
(
)
:
u
"
"
_ns
aMaybeScriptedPrincipal
)
;
if
(
!
IsHTMLElement
(
nsGkAtoms
:
:
iframe
)
|
|
!
HasAttr
(
nsGkAtoms
:
:
srcdoc
)
)
{
LoadSrc
(
)
;
}
}
else
if
(
aName
=
=
nsGkAtoms
:
:
name
)
{
RefPtr
<
BrowsingContext
>
bc
=
mFrameLoader
?
mFrameLoader
-
>
GetExtantBrowsingContext
(
)
:
nullptr
;
if
(
bc
)
{
MOZ_ALWAYS_SUCCEEDS
(
bc
-
>
SetName
(
aValue
?
aValue
-
>
String
(
)
:
u
"
"
_ns
)
)
;
}
}
}
}
void
nsGenericHTMLFrameElement
:
:
DestroyContent
(
)
{
if
(
mFrameLoader
)
{
mFrameLoader
-
>
Destroy
(
)
;
mFrameLoader
=
nullptr
;
}
nsGenericHTMLElement
:
:
DestroyContent
(
)
;
}
nsresult
nsGenericHTMLFrameElement
:
:
CopyInnerTo
(
Element
*
aDest
)
{
nsresult
rv
=
nsGenericHTMLElement
:
:
CopyInnerTo
(
aDest
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
Document
*
doc
=
aDest
-
>
OwnerDoc
(
)
;
if
(
doc
-
>
IsStaticDocument
(
)
&
&
mFrameLoader
)
{
nsGenericHTMLFrameElement
*
dest
=
static_cast
<
nsGenericHTMLFrameElement
*
>
(
aDest
)
;
doc
-
>
AddPendingFrameStaticClone
(
dest
mFrameLoader
)
;
}
return
rv
;
}
bool
nsGenericHTMLFrameElement
:
:
IsHTMLFocusable
(
IsFocusableFlags
aFlags
bool
*
aIsFocusable
int32_t
*
aTabIndex
)
{
if
(
nsGenericHTMLElement
:
:
IsHTMLFocusable
(
aFlags
aIsFocusable
aTabIndex
)
)
{
return
true
;
}
*
aIsFocusable
=
true
;
return
false
;
}
