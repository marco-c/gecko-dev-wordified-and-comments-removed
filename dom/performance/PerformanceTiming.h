#
ifndef
mozilla_dom_PerformanceTiming_h
#
define
mozilla_dom_PerformanceTiming_h
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsDOMNavigationTiming
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
Performance
.
h
"
class
nsIHttpChannel
;
class
nsITimedChannel
;
namespace
mozilla
{
namespace
dom
{
class
PerformanceTiming
final
:
public
nsWrapperCache
{
public
:
PerformanceTiming
(
Performance
*
aPerformance
nsITimedChannel
*
aChannel
nsIHttpChannel
*
aHttpChannel
DOMHighResTimeStamp
aZeroTime
)
;
NS_INLINE_DECL_CYCLE_COLLECTING_NATIVE_REFCOUNTING
(
PerformanceTiming
)
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_NATIVE_CLASS
(
PerformanceTiming
)
nsDOMNavigationTiming
*
GetDOMTiming
(
)
const
{
return
mPerformance
-
>
GetDOMTiming
(
)
;
}
Performance
*
GetParentObject
(
)
const
{
return
mPerformance
;
}
inline
DOMHighResTimeStamp
TimeStampToDOMHighResOrFetchStart
(
TimeStamp
aStamp
)
{
return
(
!
aStamp
.
IsNull
(
)
)
?
TimeStampToDOMHighRes
(
aStamp
)
:
FetchStartHighRes
(
)
;
}
inline
DOMHighResTimeStamp
TimeStampToDOMHighRes
(
TimeStamp
aStamp
)
const
{
MOZ_ASSERT
(
!
aStamp
.
IsNull
(
)
)
;
TimeDuration
duration
=
aStamp
-
GetDOMTiming
(
)
-
>
GetNavigationStartTimeStamp
(
)
;
return
duration
.
ToMilliseconds
(
)
+
mZeroTime
;
}
virtual
JSObject
*
WrapObject
(
JSContext
*
cx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
DOMTimeMilliSec
NavigationStart
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetNavigationStart
(
)
;
}
DOMTimeMilliSec
UnloadEventStart
(
)
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetUnloadEventStart
(
)
;
}
DOMTimeMilliSec
UnloadEventEnd
(
)
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetUnloadEventEnd
(
)
;
}
uint8_t
GetRedirectCount
(
)
const
;
bool
CheckAllowedOrigin
(
nsIHttpChannel
*
aResourceChannel
nsITimedChannel
*
aChannel
)
;
bool
TimingAllowed
(
)
const
;
bool
ShouldReportCrossOriginRedirect
(
)
const
;
DOMHighResTimeStamp
FetchStartHighRes
(
)
;
DOMHighResTimeStamp
RedirectStartHighRes
(
)
;
DOMHighResTimeStamp
RedirectEndHighRes
(
)
;
DOMHighResTimeStamp
DomainLookupStartHighRes
(
)
;
DOMHighResTimeStamp
DomainLookupEndHighRes
(
)
;
DOMHighResTimeStamp
ConnectStartHighRes
(
)
;
DOMHighResTimeStamp
SecureConnectionStartHighRes
(
)
;
DOMHighResTimeStamp
ConnectEndHighRes
(
)
;
DOMHighResTimeStamp
RequestStartHighRes
(
)
;
DOMHighResTimeStamp
ResponseStartHighRes
(
)
;
DOMHighResTimeStamp
ResponseEndHighRes
(
)
;
DOMTimeMilliSec
FetchStart
(
)
;
DOMTimeMilliSec
RedirectStart
(
)
;
DOMTimeMilliSec
RedirectEnd
(
)
;
DOMTimeMilliSec
DomainLookupStart
(
)
;
DOMTimeMilliSec
DomainLookupEnd
(
)
;
DOMTimeMilliSec
ConnectStart
(
)
;
DOMTimeMilliSec
SecureConnectionStart
(
)
;
DOMTimeMilliSec
ConnectEnd
(
)
;
DOMTimeMilliSec
RequestStart
(
)
;
DOMTimeMilliSec
ResponseStart
(
)
;
DOMTimeMilliSec
ResponseEnd
(
)
;
DOMTimeMilliSec
DomLoading
(
)
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetDomLoading
(
)
;
}
DOMTimeMilliSec
DomInteractive
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetDomInteractive
(
)
;
}
DOMTimeMilliSec
DomContentLoadedEventStart
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetDomContentLoadedEventStart
(
)
;
}
DOMTimeMilliSec
DomContentLoadedEventEnd
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetDomContentLoadedEventEnd
(
)
;
}
DOMTimeMilliSec
DomComplete
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetDomComplete
(
)
;
}
DOMTimeMilliSec
LoadEventStart
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetLoadEventStart
(
)
;
}
DOMTimeMilliSec
LoadEventEnd
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetLoadEventEnd
(
)
;
}
DOMTimeMilliSec
TimeToNonBlankPaint
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
return
GetDOMTiming
(
)
-
>
GetTimeToNonBlankPaint
(
)
;
}
private
:
~
PerformanceTiming
(
)
;
bool
IsInitialized
(
)
const
;
void
InitializeTimingInfo
(
nsITimedChannel
*
aChannel
)
;
bool
IsTopLevelContentDocument
(
)
const
;
RefPtr
<
Performance
>
mPerformance
;
DOMHighResTimeStamp
mFetchStart
;
DOMHighResTimeStamp
mZeroTime
;
TimeStamp
mAsyncOpen
;
TimeStamp
mRedirectStart
;
TimeStamp
mRedirectEnd
;
TimeStamp
mDomainLookupStart
;
TimeStamp
mDomainLookupEnd
;
TimeStamp
mConnectStart
;
TimeStamp
mSecureConnectionStart
;
TimeStamp
mConnectEnd
;
TimeStamp
mRequestStart
;
TimeStamp
mResponseStart
;
TimeStamp
mCacheReadStart
;
TimeStamp
mResponseEnd
;
TimeStamp
mCacheReadEnd
;
uint8_t
mRedirectCount
;
bool
mTimingAllowed
;
bool
mAllRedirectsSameOrigin
;
bool
mInitialized
;
bool
mReportCrossOriginRedirect
;
}
;
}
}
#
endif
