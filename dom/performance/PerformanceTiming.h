#
ifndef
mozilla_dom_PerformanceTiming_h
#
define
mozilla_dom_PerformanceTiming_h
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsDOMNavigationTiming
.
h
"
#
include
"
nsRFPService
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
Performance
.
h
"
#
include
"
nsITimedChannel
.
h
"
class
nsIHttpChannel
;
class
nsITimedChannel
;
namespace
mozilla
{
namespace
dom
{
class
PerformanceTiming
;
class
PerformanceTimingData
final
{
friend
class
PerformanceTiming
;
public
:
static
PerformanceTimingData
*
Create
(
nsITimedChannel
*
aChannel
nsIHttpChannel
*
aHttpChannel
DOMHighResTimeStamp
aZeroTime
nsAString
&
aInitiatorType
nsAString
&
aEntryName
)
;
PerformanceTimingData
(
nsITimedChannel
*
aChannel
nsIHttpChannel
*
aHttpChannel
DOMHighResTimeStamp
aZeroTime
)
;
void
SetPropertiesFromHttpChannel
(
nsIHttpChannel
*
aHttpChannel
nsITimedChannel
*
aChannel
)
;
bool
IsInitialized
(
)
const
{
return
mInitialized
;
}
const
nsString
&
NextHopProtocol
(
)
const
{
return
mNextHopProtocol
;
}
uint64_t
TransferSize
(
)
const
{
return
mTransferSize
;
}
uint64_t
EncodedBodySize
(
)
const
{
return
mEncodedBodySize
;
}
uint64_t
DecodedBodySize
(
)
const
{
return
mDecodedBodySize
;
}
inline
DOMHighResTimeStamp
TimeStampToReducedDOMHighResOrFetchStart
(
Performance
*
aPerformance
TimeStamp
aStamp
)
{
MOZ_ASSERT
(
aPerformance
)
;
if
(
aStamp
.
IsNull
(
)
)
{
return
FetchStartHighRes
(
aPerformance
)
;
}
DOMHighResTimeStamp
rawTimestamp
=
TimeStampToDOMHighRes
(
aPerformance
aStamp
)
;
if
(
aPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
rawTimestamp
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
rawTimestamp
aPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
inline
DOMHighResTimeStamp
TimeStampToDOMHighRes
(
Performance
*
aPerformance
TimeStamp
aStamp
)
const
{
MOZ_ASSERT
(
aPerformance
)
;
MOZ_ASSERT
(
!
aStamp
.
IsNull
(
)
)
;
TimeDuration
duration
=
aStamp
-
aPerformance
-
>
CreationTimeStamp
(
)
;
return
duration
.
ToMilliseconds
(
)
+
mZeroTime
;
}
DOMHighResTimeStamp
AsyncOpenHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
WorkerStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
FetchStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
RedirectStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
RedirectEndHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
DomainLookupStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
DomainLookupEndHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
ConnectStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
SecureConnectionStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
ConnectEndHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
RequestStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
ResponseStartHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
ResponseEndHighRes
(
Performance
*
aPerformance
)
;
DOMHighResTimeStamp
ZeroTime
(
)
const
{
return
mZeroTime
;
}
uint8_t
RedirectCountReal
(
)
const
{
return
mRedirectCount
;
}
uint8_t
GetRedirectCount
(
)
const
;
bool
AllRedirectsSameOrigin
(
)
const
{
return
mAllRedirectsSameOrigin
;
}
bool
ShouldReportCrossOriginRedirect
(
)
const
;
bool
TimingAllowed
(
)
const
{
return
mTimingAllowed
;
}
nsTArray
<
nsCOMPtr
<
nsIServerTiming
>
>
GetServerTiming
(
)
;
private
:
bool
CheckAllowedOrigin
(
nsIHttpChannel
*
aResourceChannel
nsITimedChannel
*
aChannel
)
;
nsTArray
<
nsCOMPtr
<
nsIServerTiming
>
>
mServerTiming
;
nsString
mNextHopProtocol
;
TimeStamp
mAsyncOpen
;
TimeStamp
mRedirectStart
;
TimeStamp
mRedirectEnd
;
TimeStamp
mDomainLookupStart
;
TimeStamp
mDomainLookupEnd
;
TimeStamp
mConnectStart
;
TimeStamp
mSecureConnectionStart
;
TimeStamp
mConnectEnd
;
TimeStamp
mRequestStart
;
TimeStamp
mResponseStart
;
TimeStamp
mCacheReadStart
;
TimeStamp
mResponseEnd
;
TimeStamp
mCacheReadEnd
;
TimeStamp
mWorkerStart
;
TimeStamp
mWorkerRequestStart
;
TimeStamp
mWorkerResponseEnd
;
DOMHighResTimeStamp
mZeroTime
;
DOMHighResTimeStamp
mFetchStart
;
uint64_t
mEncodedBodySize
;
uint64_t
mTransferSize
;
uint64_t
mDecodedBodySize
;
uint8_t
mRedirectCount
;
bool
mAllRedirectsSameOrigin
;
bool
mReportCrossOriginRedirect
;
bool
mSecureConnection
;
bool
mTimingAllowed
;
bool
mInitialized
;
}
;
class
PerformanceTiming
final
:
public
nsWrapperCache
{
public
:
PerformanceTiming
(
Performance
*
aPerformance
nsITimedChannel
*
aChannel
nsIHttpChannel
*
aHttpChannel
DOMHighResTimeStamp
aZeroTime
)
;
NS_INLINE_DECL_CYCLE_COLLECTING_NATIVE_REFCOUNTING
(
PerformanceTiming
)
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_NATIVE_CLASS
(
PerformanceTiming
)
nsDOMNavigationTiming
*
GetDOMTiming
(
)
const
{
return
mPerformance
-
>
GetDOMTiming
(
)
;
}
Performance
*
GetParentObject
(
)
const
{
return
mPerformance
;
}
virtual
JSObject
*
WrapObject
(
JSContext
*
cx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
DOMTimeMilliSec
NavigationStart
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetNavigationStart
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetNavigationStart
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
UnloadEventStart
(
)
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetUnloadEventStart
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetUnloadEventStart
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
UnloadEventEnd
(
)
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetUnloadEventEnd
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetUnloadEventEnd
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
FetchStart
(
)
;
DOMTimeMilliSec
RedirectStart
(
)
;
DOMTimeMilliSec
RedirectEnd
(
)
;
DOMTimeMilliSec
DomainLookupStart
(
)
;
DOMTimeMilliSec
DomainLookupEnd
(
)
;
DOMTimeMilliSec
ConnectStart
(
)
;
DOMTimeMilliSec
SecureConnectionStart
(
)
;
DOMTimeMilliSec
ConnectEnd
(
)
;
DOMTimeMilliSec
RequestStart
(
)
;
DOMTimeMilliSec
ResponseStart
(
)
;
DOMTimeMilliSec
ResponseEnd
(
)
;
DOMTimeMilliSec
DomLoading
(
)
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetDomLoading
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetDomLoading
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
DomInteractive
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetDomInteractive
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetDomInteractive
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
DomContentLoadedEventStart
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetDomContentLoadedEventStart
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetDomContentLoadedEventStart
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
DomContentLoadedEventEnd
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetDomContentLoadedEventEnd
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetDomContentLoadedEventEnd
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
DomComplete
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetDomComplete
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetDomComplete
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
LoadEventStart
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetLoadEventStart
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetLoadEventStart
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
LoadEventEnd
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetLoadEventEnd
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetLoadEventEnd
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
TimeToNonBlankPaint
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetTimeToNonBlankPaint
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetTimeToNonBlankPaint
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
DOMTimeMilliSec
TimeToDOMContentFlushed
(
)
const
{
if
(
!
nsContentUtils
:
:
IsPerformanceTimingEnabled
(
)
|
|
nsContentUtils
:
:
ShouldResistFingerprinting
(
)
)
{
return
0
;
}
if
(
mPerformance
-
>
IsSystemPrincipal
(
)
)
{
return
GetDOMTiming
(
)
-
>
GetTimeToDOMContentFlushed
(
)
;
}
return
nsRFPService
:
:
ReduceTimePrecisionAsMSecs
(
GetDOMTiming
(
)
-
>
GetTimeToDOMContentFlushed
(
)
mPerformance
-
>
GetRandomTimelineSeed
(
)
)
;
}
PerformanceTimingData
*
Data
(
)
const
{
return
mTimingData
.
get
(
)
;
}
private
:
~
PerformanceTiming
(
)
;
bool
IsTopLevelContentDocument
(
)
const
;
RefPtr
<
Performance
>
mPerformance
;
UniquePtr
<
PerformanceTimingData
>
mTimingData
;
}
;
}
}
#
endif
