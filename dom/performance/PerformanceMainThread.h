#
ifndef
mozilla_dom_PerformanceMainThread_h
#
define
mozilla_dom_PerformanceMainThread_h
#
include
"
Performance
.
h
"
#
include
"
PerformanceStorage
.
h
"
namespace
mozilla
:
:
dom
{
class
PerformanceNavigationTiming
;
class
PerformanceEventTiming
;
class
PerformanceMainThread
final
:
public
Performance
public
PerformanceStorage
{
public
:
PerformanceMainThread
(
nsPIDOMWindowInner
*
aWindow
nsDOMNavigationTiming
*
aDOMTiming
nsITimedChannel
*
aChannel
bool
aPrincipal
)
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS_INHERITED
(
PerformanceMainThread
Performance
)
PerformanceStorage
*
AsPerformanceStorage
(
)
override
{
return
this
;
}
virtual
PerformanceTiming
*
Timing
(
)
override
;
virtual
PerformanceNavigation
*
Navigation
(
)
override
;
virtual
void
AddEntry
(
nsIHttpChannel
*
channel
nsITimedChannel
*
timedChannel
)
override
;
virtual
void
AddEntry
(
const
nsString
&
entryName
const
nsString
&
initiatorType
UniquePtr
<
PerformanceTimingData
>
&
&
aData
)
override
;
void
AddRawEntry
(
UniquePtr
<
PerformanceTimingData
>
aPerformanceTimingData
const
nsAString
&
aInitiatorType
const
nsAString
&
aEntryName
)
;
virtual
void
SetFCPTimingEntry
(
PerformancePaintTiming
*
aEntry
)
override
;
void
InsertEventTimingEntry
(
PerformanceEventTiming
*
)
override
;
void
BufferEventTimingEntryIfNeeded
(
PerformanceEventTiming
*
)
override
;
void
DispatchPendingEventTimingEntries
(
)
override
;
TimeStamp
CreationTimeStamp
(
)
const
override
;
DOMHighResTimeStamp
CreationTime
(
)
const
override
;
virtual
void
GetMozMemory
(
JSContext
*
aCx
JS
:
:
MutableHandle
<
JSObject
*
>
aObj
)
override
;
virtual
nsDOMNavigationTiming
*
GetDOMTiming
(
)
const
override
{
return
mDOMTiming
;
}
virtual
uint64_t
GetRandomTimelineSeed
(
)
override
{
return
GetDOMTiming
(
)
-
>
GetRandomTimelineSeed
(
)
;
}
virtual
nsITimedChannel
*
GetChannel
(
)
const
override
{
return
mChannel
;
}
virtual
void
GetEntries
(
nsTArray
<
RefPtr
<
PerformanceEntry
>
>
&
aRetval
)
override
;
virtual
void
GetEntriesByType
(
const
nsAString
&
aEntryType
nsTArray
<
RefPtr
<
PerformanceEntry
>
>
&
aRetval
)
override
;
void
GetEntriesByTypeForObserver
(
const
nsAString
&
aEntryType
nsTArray
<
RefPtr
<
PerformanceEntry
>
>
&
aRetval
)
override
;
virtual
void
GetEntriesByName
(
const
nsAString
&
aName
const
Optional
<
nsAString
>
&
aEntryType
nsTArray
<
RefPtr
<
PerformanceEntry
>
>
&
aRetval
)
override
;
void
UpdateNavigationTimingEntry
(
)
override
;
void
QueueNavigationTimingEntry
(
)
override
;
bool
CrossOriginIsolated
(
)
const
override
;
size_t
SizeOfEventEntries
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
override
;
static
constexpr
uint32_t
kDefaultEventTimingBufferSize
=
150
;
static
constexpr
uint32_t
kDefaultEventTimingDurationThreshold
=
104
;
static
constexpr
double
kDefaultEventTimingMinDuration
=
16
.
0
;
class
EventCounts
*
EventCounts
(
)
override
;
bool
IsGlobalObjectWindow
(
)
const
override
{
return
true
;
}
;
protected
:
~
PerformanceMainThread
(
)
;
void
CreateNavigationTimingEntry
(
)
;
void
InsertUserEntry
(
PerformanceEntry
*
aEntry
)
override
;
DOMHighResTimeStamp
GetPerformanceTimingFromString
(
const
nsAString
&
aTimingName
)
override
;
void
DispatchBufferFullEvent
(
)
override
;
RefPtr
<
PerformanceNavigationTiming
>
mDocEntry
;
RefPtr
<
nsDOMNavigationTiming
>
mDOMTiming
;
nsCOMPtr
<
nsITimedChannel
>
mChannel
;
RefPtr
<
PerformanceTiming
>
mTiming
;
RefPtr
<
PerformanceNavigation
>
mNavigation
;
RefPtr
<
PerformancePaintTiming
>
mFCPTiming
;
JS
:
:
Heap
<
JSObject
*
>
mMozMemory
;
const
bool
mCrossOriginIsolated
;
nsTArray
<
RefPtr
<
PerformanceEventTiming
>
>
mEventTimingEntries
;
AutoCleanLinkedList
<
RefPtr
<
PerformanceEventTiming
>
>
mPendingEventTimingEntries
;
bool
mHasDispatchedInputEvent
=
false
;
RefPtr
<
PerformanceEventTiming
>
mFirstInputEvent
;
RefPtr
<
PerformanceEventTiming
>
mPendingPointerDown
;
private
:
bool
mHasQueuedRefreshdriverObserver
=
false
;
RefPtr
<
class
EventCounts
>
mEventCounts
;
void
IncEventCount
(
const
nsAtom
*
aType
)
;
PresShell
*
GetPresShell
(
)
;
}
;
}
#
endif
