#
include
"
PerformanceInteractionMetrics
.
h
"
#
include
"
mozilla
/
MouseEvents
.
h
"
#
include
"
mozilla
/
RandomNum
.
h
"
#
include
"
mozilla
/
TextEvents
.
h
"
constexpr
uint32_t
kInteractionIdIncrement
=
7
;
constexpr
uint32_t
kMinFirstInteractionID
=
100
;
constexpr
uint32_t
kMaxFirstInteractionID
=
10000
;
namespace
mozilla
:
:
dom
{
PerformanceInteractionMetrics
:
:
PerformanceInteractionMetrics
(
)
{
uint64_t
randVal
=
RandomUint64
(
)
.
valueOr
(
kMinFirstInteractionID
)
;
mCurrentInteractionValue
=
kMinFirstInteractionID
+
(
randVal
%
(
kMaxFirstInteractionID
-
kMinFirstInteractionID
+
1
)
)
;
}
uint64_t
PerformanceInteractionMetrics
:
:
IncreaseInteractionValueAndCount
(
)
{
mCurrentInteractionValue
+
=
kInteractionIdIncrement
;
mInteractionCount
+
+
;
return
mCurrentInteractionValue
;
}
uint64_t
PerformanceInteractionMetrics
:
:
ComputeInteractionId
(
const
WidgetEvent
*
aEvent
)
{
if
(
!
aEvent
-
>
IsTrusted
(
)
)
{
return
0
;
}
const
EventMessage
eventType
=
aEvent
-
>
mMessage
;
switch
(
eventType
)
{
case
eKeyUp
:
case
eCompositionStart
:
case
eEditorInput
:
case
ePointerCancel
:
case
ePointerUp
:
case
ePointerClick
:
break
;
default
:
return
0
;
}
if
(
eventType
=
=
eKeyUp
)
{
const
WidgetKeyboardEvent
*
keyEvent
=
aEvent
-
>
AsKeyboardEvent
(
)
;
if
(
keyEvent
-
>
mIsComposing
)
{
return
0
;
}
const
uint32_t
code
=
keyEvent
-
>
mKeyCode
;
auto
entry
=
mPendingKeyDowns
.
MaybeGet
(
code
)
;
if
(
!
entry
)
{
return
0
;
}
uint64_t
interactionId
=
IncreaseInteractionValueAndCount
(
)
;
(
*
entry
)
-
>
SetInteractionId
(
interactionId
)
;
mPendingKeyDowns
.
Remove
(
code
)
;
return
interactionId
;
}
if
(
eventType
=
=
eCompositionStart
)
{
for
(
auto
iter
=
mPendingKeyDowns
.
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
PerformanceEventTiming
*
entry
=
iter
.
Data
(
)
;
entry
-
>
SetInteractionId
(
0
)
;
}
mPendingKeyDowns
.
Clear
(
)
;
return
0
;
}
if
(
eventType
=
=
eEditorInput
)
{
const
auto
*
inputEvent
=
aEvent
-
>
AsEditorInputEvent
(
)
;
if
(
!
inputEvent
)
{
return
0
;
}
if
(
!
inputEvent
-
>
mIsComposing
)
{
return
0
;
}
return
IncreaseInteractionValueAndCount
(
)
;
}
const
auto
*
pointerEvent
=
aEvent
-
>
AsPointerEvent
(
)
;
auto
pointerId
=
pointerEvent
-
>
pointerId
;
if
(
eventType
=
=
ePointerClick
)
{
auto
value
=
mPointerInteractionValueMap
.
MaybeGet
(
pointerId
)
;
if
(
!
value
)
{
return
0
;
}
mPointerInteractionValueMap
.
Remove
(
pointerId
)
;
return
*
value
;
}
MOZ_RELEASE_ASSERT
(
eventType
=
=
ePointerUp
|
|
eventType
=
=
ePointerCancel
)
;
auto
entry
=
mPendingPointerDowns
.
MaybeGet
(
pointerId
)
;
if
(
!
entry
)
{
return
0
;
}
if
(
eventType
=
=
ePointerUp
)
{
uint64_t
interactionId
=
IncreaseInteractionValueAndCount
(
)
;
mPointerInteractionValueMap
.
InsertOrUpdate
(
pointerId
interactionId
)
;
(
*
entry
)
-
>
SetInteractionId
(
interactionId
)
;
}
else
{
(
*
entry
)
-
>
SetInteractionId
(
0
)
;
}
mPendingPointerDowns
.
Remove
(
pointerId
)
;
if
(
eventType
=
=
ePointerCancel
)
{
return
0
;
}
return
mPointerInteractionValueMap
.
Get
(
pointerId
)
;
}
}
