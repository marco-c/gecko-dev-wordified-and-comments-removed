#
include
"
PerformanceWorker
.
h
"
#
include
"
mozilla
/
dom
/
WorkerScope
.
h
"
#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
namespace
mozilla
:
:
dom
{
PerformanceWorker
:
:
PerformanceWorker
(
WorkerPrivate
*
aWorkerPrivate
)
:
Performance
(
aWorkerPrivate
-
>
GlobalScope
(
)
)
mWorkerPrivate
(
aWorkerPrivate
)
{
mWorkerPrivate
-
>
AssertIsOnWorkerThread
(
)
;
mRTPCallerType
=
aWorkerPrivate
-
>
GlobalScope
(
)
-
>
GetRTPCallerType
(
)
;
}
PerformanceWorker
:
:
~
PerformanceWorker
(
)
{
if
(
mWorkerPrivate
)
{
mWorkerPrivate
-
>
AssertIsOnWorkerThread
(
)
;
}
}
void
PerformanceWorker
:
:
InsertUserEntry
(
PerformanceEntry
*
aEntry
)
{
if
(
StaticPrefs
:
:
dom_performance_enable_user_timing_logging
(
)
)
{
nsAutoCString
uri
;
nsCOMPtr
<
nsIURI
>
scriptURI
=
mWorkerPrivate
-
>
GetResolvedScriptURI
(
)
;
if
(
!
scriptURI
|
|
NS_FAILED
(
scriptURI
-
>
GetHost
(
uri
)
)
)
{
uri
.
AssignLiteral
(
"
none
"
)
;
}
Performance
:
:
LogEntry
(
aEntry
uri
)
;
}
Performance
:
:
InsertUserEntry
(
aEntry
)
;
}
TimeStamp
PerformanceWorker
:
:
CreationTimeStamp
(
)
const
{
MOZ_DIAGNOSTIC_ASSERT
(
mWorkerPrivate
)
;
if
(
mWorkerPrivate
)
{
return
mWorkerPrivate
-
>
CreationTimeStamp
(
)
;
}
return
TimeStamp
(
)
;
}
DOMHighResTimeStamp
PerformanceWorker
:
:
CreationTime
(
)
const
{
MOZ_DIAGNOSTIC_ASSERT
(
mWorkerPrivate
)
;
if
(
mWorkerPrivate
)
{
return
mWorkerPrivate
-
>
CreationTime
(
)
;
}
return
DOMHighResTimeStamp
(
)
;
}
uint64_t
PerformanceWorker
:
:
GetRandomTimelineSeed
(
)
{
MOZ_DIAGNOSTIC_ASSERT
(
mWorkerPrivate
)
;
if
(
mWorkerPrivate
)
{
return
mWorkerPrivate
-
>
GetRandomTimelineSeed
(
)
;
}
return
0
;
}
bool
PerformanceWorker
:
:
CrossOriginIsolated
(
)
const
{
MOZ_DIAGNOSTIC_ASSERT
(
mWorkerPrivate
)
;
if
(
mWorkerPrivate
)
{
return
mWorkerPrivate
-
>
CrossOriginIsolated
(
)
;
}
return
false
;
}
void
PerformanceWorker
:
:
NoteShuttingDown
(
)
{
mWorkerPrivate
=
nullptr
;
}
}
