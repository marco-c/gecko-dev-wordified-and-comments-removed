"
use
strict
"
;
const
{
PromiseMessage
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
PromiseMessage
.
jsm
"
)
;
const
testPath
=
"
/
browser
/
dom
/
manifest
/
test
/
file_reg_appinstalled_event
.
html
"
;
const
defaultURL
=
new
URL
(
"
http
:
/
/
example
.
org
/
browser
/
dom
/
manifest
/
test
/
file_testserver
.
sjs
"
)
;
const
testURL
=
new
URL
(
defaultURL
)
;
testURL
.
searchParams
.
append
(
"
file
"
testPath
)
;
function
enableOnAppInstalledPref
(
)
{
const
ops
=
{
"
set
"
:
[
[
"
dom
.
manifest
.
onappinstalled
"
true
]
]
}
;
return
SpecialPowers
.
pushPrefEnv
(
ops
)
;
}
async
function
theTest
(
aBrowser
)
{
aBrowser
.
allowEvents
=
true
;
let
waitForInstall
=
ContentTask
.
spawn
(
aBrowser
null
async
function
(
)
{
await
ContentTaskUtils
.
waitForEvent
(
content
.
window
"
appinstalled
"
)
;
}
)
;
const
{
data
:
{
success
}
}
=
await
PromiseMessage
.
send
(
aBrowser
.
messageManager
"
DOM
:
Manifest
:
FireAppInstalledEvent
"
)
;
ok
(
success
"
message
sent
and
received
successfully
.
"
)
;
try
{
await
waitForInstall
;
ok
(
true
"
AppInstalled
event
fired
"
)
;
}
catch
(
err
)
{
ok
(
false
"
AppInstalled
event
didn
'
t
fire
:
"
+
err
.
message
)
;
}
}
add_task
(
async
function
(
)
{
await
enableOnAppInstalledPref
(
)
;
let
tabOptions
=
{
gBrowser
url
:
testURL
.
href
}
;
await
BrowserTestUtils
.
withNewTab
(
tabOptions
theTest
)
;
}
)
;
