"
use
strict
"
;
const
{
PromiseMessage
}
=
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
PromiseMessage
.
jsm
"
{
}
)
;
const
testPath
=
"
/
browser
/
dom
/
manifest
/
test
/
file_reg_install_event
.
html
"
;
const
defaultURL
=
new
URL
(
"
http
:
/
/
example
.
org
/
browser
/
dom
/
manifest
/
test
/
file_testserver
.
sjs
"
)
;
const
testURL
=
new
URL
(
defaultURL
)
;
testURL
.
searchParams
.
append
(
"
file
"
testPath
)
;
function
enableOnInstallPref
(
)
{
const
ops
=
{
"
set
"
:
[
[
"
dom
.
manifest
.
oninstall
"
true
]
]
}
;
return
SpecialPowers
.
pushPrefEnv
(
ops
)
;
}
function
*
theTest
(
aBrowser
)
{
aBrowser
.
allowEvents
=
true
;
const
responsePromise
=
new
Promise
(
(
resolve
)
=
>
{
aBrowser
.
contentDocument
.
addEventListener
(
"
dom
.
manifest
.
oninstall
"
resolve
)
;
}
)
;
const
mm
=
aBrowser
.
messageManager
;
const
msgKey
=
"
DOM
:
Manifest
:
FireInstallEvent
"
;
const
{
data
:
{
success
}
}
=
yield
PromiseMessage
.
send
(
mm
msgKey
)
;
ok
(
success
"
message
sent
and
received
successfully
.
"
)
;
const
{
detail
:
{
result
}
}
=
yield
responsePromise
;
ok
(
result
"
the
page
sent
us
an
acknowledgment
as
a
custom
event
"
)
;
}
add_task
(
function
*
(
)
{
yield
enableOnInstallPref
(
)
;
let
tabOptions
=
{
gBrowser
:
gBrowser
url
:
testURL
.
href
}
;
yield
BrowserTestUtils
.
withNewTab
(
tabOptions
theTest
)
;
}
)
;
