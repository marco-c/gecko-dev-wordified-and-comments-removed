const
{
L10nRegistry
FileSource
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
L10nRegistry
.
jsm
"
)
;
let
uri
=
"
chrome
:
/
/
mochitests
/
content
/
browser
/
dom
/
l10n
/
tests
/
mochitest
/
/
document_l10n
/
non
-
system
-
principal
/
"
;
let
protocol
=
Services
.
io
.
getProtocolHandler
(
"
resource
"
)
.
QueryInterface
(
Ci
.
nsIResProtocolHandler
)
;
protocol
.
setSubstitution
(
"
l10n
-
test
"
Services
.
io
.
newURI
(
uri
)
)
;
let
locales
=
Services
.
locale
.
appLocalesAsBCP47
;
let
mockSource
=
new
FileSource
(
"
test
"
locales
{
uri
}
localization
/
)
;
L10nRegistry
.
registerSources
(
[
mockSource
]
)
;
registerCleanupFunction
(
(
)
=
>
{
protocol
.
setSubstitution
(
"
l10n
-
test
"
null
)
;
L10nRegistry
.
removeSources
(
[
"
test
"
]
)
;
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
ipc
.
processPrelaunch
.
enabled
"
true
]
]
}
)
;
}
)
;
const
kChildPage
=
getRootDirectory
(
gTestPath
)
+
"
test
.
html
"
;
const
kAboutPagesRegistered
=
Promise
.
all
(
[
BrowserTestUtils
.
registerAboutPage
(
registerCleanupFunction
"
test
-
about
-
l10n
-
child
"
kChildPage
Ci
.
nsIAboutModule
.
URI_MUST_LOAD_IN_CHILD
|
Ci
.
nsIAboutModule
.
URI_SAFE_FOR_UNTRUSTED_CONTENT
|
Ci
.
nsIAboutModule
.
ALLOW_SCRIPT
)
]
)
;
add_task
(
async
(
)
=
>
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
dom
.
ipc
.
processPrelaunch
.
enabled
"
false
]
[
"
dom
.
security
.
skip_about_page_has_csp_assert
"
true
]
]
}
)
;
await
kAboutPagesRegistered
;
await
BrowserTestUtils
.
withNewTab
(
"
about
:
test
-
about
-
l10n
-
child
"
async
browser
=
>
{
await
SpecialPowers
.
spawn
(
browser
[
]
async
function
(
)
{
let
document
=
content
.
document
;
let
window
=
document
.
defaultView
;
await
document
.
testsReadyPromise
;
let
principal
=
SpecialPowers
.
wrap
(
document
)
.
nodePrincipal
;
is
(
principal
.
spec
"
about
:
test
-
about
-
l10n
-
child
"
"
correct
content
principal
"
)
;
let
desc
=
document
.
getElementById
(
"
main
-
desc
"
)
;
is
(
desc
.
textContent
"
This
is
a
mock
page
title
"
)
;
let
label
=
document
.
getElementById
(
"
label1
"
)
;
let
l10nArgs
=
document
.
l10n
.
getAttributes
(
label
)
;
is
(
l10nArgs
.
id
"
subtitle
"
)
;
is
(
l10nArgs
.
args
.
name
"
Firefox
"
)
;
let
customMsg
=
document
.
getElementById
(
"
customMessage
"
)
.
textContent
;
is
(
customMsg
"
This
is
a
custom
message
formatted
from
JS
.
"
)
;
await
new
Promise
(
resolve
=
>
{
let
verifyL10n
=
(
)
=
>
{
if
(
!
label
.
textContent
.
includes
(
"
Firefox
"
)
)
{
window
.
requestAnimationFrame
(
verifyL10n
)
;
}
else
{
resolve
(
)
;
}
}
;
window
.
requestAnimationFrame
(
verifyL10n
)
;
}
)
;
}
)
;
}
)
;
}
)
;
