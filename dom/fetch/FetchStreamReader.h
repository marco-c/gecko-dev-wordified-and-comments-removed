#
ifndef
mozilla_dom_FetchStreamReader_h
#
define
mozilla_dom_FetchStreamReader_h
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
js
/
TypeDecls
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
dom
/
FetchBinding
.
h
"
#
include
"
mozilla
/
dom
/
PromiseNativeHandler
.
h
"
#
include
"
nsIAsyncOutputStream
.
h
"
#
include
"
nsIGlobalObject
.
h
"
namespace
mozilla
{
namespace
dom
{
class
ReadableStream
;
class
ReadableStreamDefaultReader
;
class
WeakWorkerRef
;
class
FetchStreamReader
final
:
public
nsIOutputStreamCallback
#
ifndef
MOZ_DOM_STREAMS
public
PromiseNativeHandler
#
endif
{
public
:
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS_AMBIGUOUS
(
FetchStreamReader
nsIOutputStreamCallback
)
NS_DECL_NSIOUTPUTSTREAMCALLBACK
static
nsresult
Create
(
JSContext
*
aCx
nsIGlobalObject
*
aGlobal
FetchStreamReader
*
*
aStreamReader
nsIInputStream
*
*
aInputStream
)
;
#
ifdef
MOZ_DOM_STREAMS
void
ChunkSteps
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aChunk
ErrorResult
&
aRv
)
;
void
ErrorSteps
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aError
ErrorResult
&
aRv
)
;
#
else
void
ResolvedCallback
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aValue
ErrorResult
&
aRv
)
override
;
void
RejectedCallback
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aValue
ErrorResult
&
aRv
)
override
;
#
endif
MOZ_CAN_RUN_SCRIPT_BOUNDARY
void
CloseAndRelease
(
JSContext
*
aCx
nsresult
aStatus
)
;
#
ifdef
MOZ_DOM_STREAMS
void
StartConsuming
(
JSContext
*
aCx
ReadableStream
*
aStream
ReadableStreamDefaultReader
*
*
aReader
ErrorResult
&
aRv
)
;
#
else
void
StartConsuming
(
JSContext
*
aCx
JS
:
:
HandleObject
aStream
JS
:
:
MutableHandle
<
JSObject
*
>
aReader
ErrorResult
&
aRv
)
;
#
endif
private
:
explicit
FetchStreamReader
(
nsIGlobalObject
*
aGlobal
)
;
~
FetchStreamReader
(
)
;
nsresult
WriteBuffer
(
)
;
void
ReportErrorToConsole
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aValue
)
;
nsCOMPtr
<
nsIGlobalObject
>
mGlobal
;
nsCOMPtr
<
nsIEventTarget
>
mOwningEventTarget
;
nsCOMPtr
<
nsIAsyncOutputStream
>
mPipeOut
;
RefPtr
<
WeakWorkerRef
>
mWorkerRef
;
#
ifdef
MOZ_DOM_STREAMS
RefPtr
<
ReadableStreamDefaultReader
>
mReader
;
#
else
JS
:
:
Heap
<
JSObject
*
>
mReader
;
#
endif
nsTArray
<
uint8_t
>
mBuffer
;
uint32_t
mBufferRemaining
;
uint32_t
mBufferOffset
;
bool
mStreamClosed
;
}
;
}
}
#
endif
