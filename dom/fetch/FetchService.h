#
ifndef
_mozilla_dom_FetchService_h
#
define
_mozilla_dom_FetchService_h
#
include
"
nsIChannel
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsTHashMap
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
dom
/
FetchDriver
.
h
"
#
include
"
mozilla
/
dom
/
PerformanceTimingTypes
.
h
"
#
include
"
mozilla
/
dom
/
SafeRefPtr
.
h
"
class
nsILoadGroup
;
class
nsIPrincipal
;
class
nsICookieJarSettings
;
class
PerformanceStorage
;
namespace
mozilla
:
:
dom
{
class
InternalRequest
;
class
InternalResponse
;
using
FetchServiceResponse
=
Tuple
<
SafeRefPtr
<
InternalResponse
>
IPCPerformanceTimingData
nsString
nsString
>
;
using
FetchServiceResponsePromise
=
MozPromise
<
FetchServiceResponse
CopyableErrorResult
true
>
;
class
FetchService
final
:
public
nsIObserver
{
public
:
NS_DECL_ISUPPORTS
;
NS_DECL_NSIOBSERVER
;
static
already_AddRefed
<
FetchService
>
GetInstance
(
)
;
static
RefPtr
<
FetchServiceResponsePromise
>
NetworkErrorResponse
(
nsresult
aRv
)
;
FetchService
(
)
;
RefPtr
<
FetchServiceResponsePromise
>
Fetch
(
SafeRefPtr
<
InternalRequest
>
aRequest
nsIChannel
*
aChannel
=
nullptr
)
;
void
CancelFetch
(
RefPtr
<
FetchServiceResponsePromise
>
&
&
aResponsePromise
)
;
private
:
class
FetchInstance
final
:
public
FetchDriverObserver
{
public
:
explicit
FetchInstance
(
SafeRefPtr
<
InternalRequest
>
aRequest
)
;
nsresult
Initialize
(
nsIChannel
*
aChannel
=
nullptr
)
;
RefPtr
<
FetchServiceResponsePromise
>
Fetch
(
)
;
void
Cancel
(
)
;
void
OnResponseEnd
(
FetchDriverObserver
:
:
EndReason
aReason
)
override
;
void
OnResponseAvailableInternal
(
SafeRefPtr
<
InternalResponse
>
aResponse
)
override
;
bool
NeedOnDataAvailable
(
)
override
;
void
OnDataAvailable
(
)
override
;
void
FlushConsoleReport
(
)
override
;
private
:
~
FetchInstance
(
)
;
SafeRefPtr
<
InternalRequest
>
mRequest
;
nsCOMPtr
<
nsIPrincipal
>
mPrincipal
;
nsCOMPtr
<
nsILoadGroup
>
mLoadGroup
;
nsCOMPtr
<
nsICookieJarSettings
>
mCookieJarSettings
;
RefPtr
<
PerformanceStorage
>
mPerformanceStorage
;
RefPtr
<
FetchDriver
>
mFetchDriver
;
SafeRefPtr
<
InternalResponse
>
mResponse
;
MozPromiseHolder
<
FetchServiceResponsePromise
>
mResponsePromiseHolder
;
}
;
~
FetchService
(
)
;
nsresult
RegisterNetworkObserver
(
)
;
nsresult
UnregisterNetworkObserver
(
)
;
nsTHashMap
<
nsRefPtrHashKey
<
FetchServiceResponsePromise
>
RefPtr
<
FetchInstance
>
>
mFetchInstanceTable
;
bool
mObservingNetwork
{
false
}
;
bool
mOffline
{
false
}
;
}
;
}
#
endif
