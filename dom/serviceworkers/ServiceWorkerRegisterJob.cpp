#
include
"
ServiceWorkerRegisterJob
.
h
"
#
include
"
ServiceWorkerManager
.
h
"
#
include
"
mozilla
/
ProfilerMarkers
.
h
"
#
include
"
mozilla
/
dom
/
WorkerCommon
.
h
"
namespace
mozilla
:
:
dom
{
ServiceWorkerRegisterJob
:
:
ServiceWorkerRegisterJob
(
nsIPrincipal
*
aPrincipal
const
nsACString
&
aScope
const
WorkerType
&
aType
const
nsACString
&
aScriptSpec
ServiceWorkerUpdateViaCache
aUpdateViaCache
const
ServiceWorkerLifetimeExtension
&
aLifetimeExtension
)
:
ServiceWorkerUpdateJob
(
Type
:
:
Register
aPrincipal
aScope
nsCString
(
aScriptSpec
)
aUpdateViaCache
aLifetimeExtension
)
mType
(
aType
)
{
}
void
ServiceWorkerRegisterJob
:
:
AsyncExecute
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
AUTO_PROFILER_MARKER_UNTYPED
(
"
SWRJ
AsyncExecute
"
DOM
{
}
)
;
RefPtr
<
ServiceWorkerManager
>
swm
=
ServiceWorkerManager
:
:
GetInstance
(
)
;
if
(
Canceled
(
)
|
|
!
swm
)
{
FailUpdateJob
(
NS_ERROR_DOM_ABORT_ERR
)
;
return
;
}
RefPtr
<
ServiceWorkerRegistrationInfo
>
registration
=
swm
-
>
GetRegistration
(
mPrincipal
mScope
)
;
if
(
registration
)
{
bool
sameOptions
=
GetUpdateViaCache
(
)
=
=
registration
-
>
GetUpdateViaCache
(
)
&
&
mType
=
=
registration
-
>
Type
(
)
;
registration
-
>
SetOptions
(
GetUpdateViaCache
(
)
mType
)
;
RefPtr
<
ServiceWorkerInfo
>
newest
=
registration
-
>
Newest
(
)
;
if
(
newest
&
&
mScriptSpec
.
Equals
(
newest
-
>
ScriptSpec
(
)
)
&
&
sameOptions
)
{
SetRegistration
(
registration
)
;
Finish
(
NS_OK
)
;
return
;
}
}
else
{
registration
=
swm
-
>
CreateNewRegistration
(
mScope
mType
mPrincipal
GetUpdateViaCache
(
)
)
;
if
(
!
registration
)
{
FailUpdateJob
(
NS_ERROR_DOM_ABORT_ERR
)
;
return
;
}
}
SetRegistration
(
registration
)
;
Update
(
)
;
}
ServiceWorkerRegisterJob
:
:
~
ServiceWorkerRegisterJob
(
)
=
default
;
}
