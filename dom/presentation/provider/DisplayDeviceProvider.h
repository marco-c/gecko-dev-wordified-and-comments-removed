#
ifndef
mozilla_dom_presentation_provider_DisplayDeviceProvider_h
#
define
mozilla_dom_presentation_provider_DisplayDeviceProvider_h
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIDOMWindow
.
h
"
#
include
"
nsIDisplayInfo
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsIPresentationDeviceProvider
.
h
"
#
include
"
nsIPresentationLocalDevice
.
h
"
#
include
"
nsIPresentationControlService
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsIWindowWatcher
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsWeakReference
.
h
"
namespace
mozilla
{
namespace
dom
{
namespace
presentation
{
enum
DisplayType
{
DISPLAY_PRIMARY
DISPLAY_EXTERNAL
DISPLAY_VIRTUAL
NUM_DISPLAY_TYPES
}
;
class
DisplayDeviceProviderWrappedListener
;
class
DisplayDeviceProvider
final
:
public
nsIObserver
public
nsIPresentationDeviceProvider
public
nsIPresentationControlServerListener
public
SupportsWeakPtr
<
DisplayDeviceProvider
>
{
private
:
class
HDMIDisplayDevice
final
:
public
nsIPresentationLocalDevice
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIPRESENTATIONDEVICE
NS_DECL_NSIPRESENTATIONLOCALDEVICE
explicit
HDMIDisplayDevice
(
DisplayDeviceProvider
*
aProvider
)
:
mScreenId
(
DisplayType
:
:
DISPLAY_EXTERNAL
)
mName
(
"
HDMI
"
)
mType
(
"
external
"
)
mWindowId
(
"
hdmi
"
)
mAddress
(
"
127
.
0
.
0
.
1
"
)
mProvider
(
aProvider
)
{
}
nsresult
OpenTopLevelWindow
(
)
;
nsresult
CloseTopLevelWindow
(
)
;
const
nsCString
&
Id
(
)
const
{
return
mWindowId
;
}
const
nsCString
&
Address
(
)
const
{
return
mAddress
;
}
private
:
virtual
~
HDMIDisplayDevice
(
)
=
default
;
uint32_t
mScreenId
;
nsCString
mName
;
nsCString
mType
;
nsCString
mWindowId
;
nsCString
mAddress
;
nsCOMPtr
<
mozIDOMWindowProxy
>
mWindow
;
WeakPtr
<
DisplayDeviceProvider
>
mProvider
;
}
;
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIOBSERVER
NS_DECL_NSIPRESENTATIONDEVICEPROVIDER
NS_DECL_NSIPRESENTATIONCONTROLSERVERLISTENER
MOZ_DECLARE_WEAKREFERENCE_TYPENAME
(
DisplayDeviceProvider
)
nsresult
Connect
(
HDMIDisplayDevice
*
aDevice
nsIPresentationControlChannel
*
*
aControlChannel
)
;
private
:
virtual
~
DisplayDeviceProvider
(
)
;
nsresult
Init
(
)
;
nsresult
Uninit
(
)
;
nsresult
AddExternalScreen
(
)
;
nsresult
RemoveExternalScreen
(
)
;
nsresult
StartTCPService
(
)
;
void
AbortServerRetry
(
)
;
nsCOMPtr
<
nsIPresentationLocalDevice
>
mDevice
=
nullptr
;
nsWeakPtr
mDeviceListener
=
nullptr
;
nsCOMPtr
<
nsIPresentationControlService
>
mPresentationService
;
RefPtr
<
DisplayDeviceProviderWrappedListener
>
mWrappedListener
;
bool
mInitialized
=
false
;
uint16_t
mPort
;
bool
mIsServerRetrying
=
false
;
uint32_t
mServerRetryMs
;
nsCOMPtr
<
nsITimer
>
mServerRetryTimer
;
}
;
}
}
}
#
endif
