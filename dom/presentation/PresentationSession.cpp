#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsStringStream
.
h
"
#
include
"
PresentationSession
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
NS_IMPL_CYCLE_COLLECTION_CLASS
(
PresentationSession
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED
(
PresentationSession
DOMEventTargetHelper
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED
(
PresentationSession
DOMEventTargetHelper
)
tmp
-
>
Shutdown
(
)
;
NS_IMPL_CYCLE_COLLECTION_UNLINK_END
NS_IMPL_ADDREF_INHERITED
(
PresentationSession
DOMEventTargetHelper
)
NS_IMPL_RELEASE_INHERITED
(
PresentationSession
DOMEventTargetHelper
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED
(
PresentationSession
)
NS_INTERFACE_MAP_END_INHERITING
(
DOMEventTargetHelper
)
PresentationSession
:
:
PresentationSession
(
nsPIDOMWindow
*
aWindow
const
nsAString
&
aId
PresentationSessionState
aState
)
:
DOMEventTargetHelper
(
aWindow
)
mId
(
aId
)
mState
(
aState
)
{
}
PresentationSession
:
:
~
PresentationSession
(
)
{
}
already_AddRefed
<
PresentationSession
>
PresentationSession
:
:
Create
(
nsPIDOMWindow
*
aWindow
const
nsAString
&
aId
PresentationSessionState
aState
)
{
nsRefPtr
<
PresentationSession
>
session
=
new
PresentationSession
(
aWindow
aId
aState
)
;
return
NS_WARN_IF
(
!
session
-
>
Init
(
)
)
?
nullptr
:
session
.
forget
(
)
;
}
bool
PresentationSession
:
:
Init
(
)
{
if
(
NS_WARN_IF
(
mId
.
IsEmpty
(
)
)
)
{
return
false
;
}
return
true
;
}
void
PresentationSession
:
:
Shutdown
(
)
{
}
JSObject
*
PresentationSession
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
PresentationSessionBinding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
void
PresentationSession
:
:
GetId
(
nsAString
&
aId
)
const
{
aId
=
mId
;
}
PresentationSessionState
PresentationSession
:
:
State
(
)
const
{
return
mState
;
}
void
PresentationSession
:
:
Send
(
const
nsAString
&
aData
ErrorResult
&
aRv
)
{
if
(
NS_WARN_IF
(
mState
!
=
PresentationSessionState
:
:
Connected
)
)
{
aRv
.
Throw
(
NS_ERROR_DOM_INVALID_STATE_ERR
)
;
return
;
}
nsresult
rv
;
nsCOMPtr
<
nsIStringInputStream
>
stream
=
do_CreateInstance
(
NS_STRINGINPUTSTREAM_CONTRACTID
&
rv
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
aRv
.
Throw
(
NS_ERROR_NOT_AVAILABLE
)
;
return
;
}
NS_ConvertUTF16toUTF8
msgString
(
aData
)
;
rv
=
stream
-
>
SetData
(
msgString
.
BeginReading
(
)
msgString
.
Length
(
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
aRv
.
Throw
(
NS_ERROR_DOM_OPERATION_ERR
)
;
return
;
}
}
void
PresentationSession
:
:
Close
(
)
{
if
(
NS_WARN_IF
(
mState
=
=
PresentationSessionState
:
:
Terminated
)
)
{
return
;
}
}
