add_task
(
async
function
(
)
{
Assert
.
ok
(
"
console
"
in
this
)
;
const
removeListener1
=
addConsoleListener
(
(
)
=
>
{
throw
new
Error
(
"
Fail
"
)
;
}
)
;
let
secondListenerCalled
=
false
;
const
removeListener2
=
addConsoleListener
(
(
)
=
>
(
secondListenerCalled
=
true
)
)
;
console
.
log
(
42
)
;
Assert
.
ok
(
secondListenerCalled
"
Second
listener
was
called
"
)
;
removeListener1
(
)
;
removeListener2
(
)
;
}
)
;
function
addConsoleListener
(
callback
)
{
const
principal
=
Cc
[
"
mozilla
.
org
/
systemprincipal
;
1
"
]
.
createInstance
(
Ci
.
nsIPrincipal
)
;
ConsoleAPIStorage
.
addLogEventListener
(
callback
principal
)
;
return
(
)
=
>
{
ConsoleAPIStorage
.
removeLogEventListener
(
callback
principal
)
;
}
;
}
