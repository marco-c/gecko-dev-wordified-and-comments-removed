"
use
strict
"
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
STORAGE_MAX_EVENTS
=
1000
;
var
_consoleStorage
=
new
Map
(
)
;
const
CONSOLEAPISTORAGE_CID
=
Components
.
ID
(
"
{
96cf7855
-
dfa9
-
4c6d
-
8276
-
f9705b4890f2
}
"
)
;
function
ConsoleAPIStorageService
(
)
{
this
.
init
(
)
;
}
ConsoleAPIStorageService
.
prototype
=
{
classID
:
CONSOLEAPISTORAGE_CID
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIConsoleAPIStorage
Ci
.
nsIObserver
]
)
observe
:
function
CS_observe
(
aSubject
aTopic
aData
)
{
if
(
aTopic
=
=
"
xpcom
-
shutdown
"
)
{
Services
.
obs
.
removeObserver
(
this
"
xpcom
-
shutdown
"
)
;
Services
.
obs
.
removeObserver
(
this
"
inner
-
window
-
destroyed
"
)
;
Services
.
obs
.
removeObserver
(
this
"
memory
-
pressure
"
)
;
}
else
if
(
aTopic
=
=
"
inner
-
window
-
destroyed
"
)
{
let
innerWindowID
=
aSubject
.
QueryInterface
(
Ci
.
nsISupportsPRUint64
)
.
data
;
this
.
clearEvents
(
innerWindowID
+
"
"
)
;
}
else
if
(
aTopic
=
=
"
memory
-
pressure
"
)
{
this
.
clearEvents
(
)
;
}
}
init
:
function
CS_init
(
)
{
Services
.
obs
.
addObserver
(
this
"
xpcom
-
shutdown
"
)
;
Services
.
obs
.
addObserver
(
this
"
inner
-
window
-
destroyed
"
)
;
Services
.
obs
.
addObserver
(
this
"
memory
-
pressure
"
)
;
}
getEvents
:
function
CS_getEvents
(
aId
)
{
if
(
aId
!
=
null
)
{
return
(
_consoleStorage
.
get
(
aId
)
|
|
[
]
)
.
slice
(
0
)
;
}
let
result
=
[
]
;
for
(
let
[
events
]
of
_consoleStorage
)
{
result
.
push
.
apply
(
result
events
)
;
}
return
result
.
sort
(
function
(
a
b
)
{
return
a
.
timeStamp
-
b
.
timeStamp
;
}
)
;
}
recordEvent
:
function
CS_recordEvent
(
aId
aOuterId
aEvent
)
{
if
(
!
_consoleStorage
.
has
(
aId
)
)
{
_consoleStorage
.
set
(
aId
[
]
)
;
}
let
storage
=
_consoleStorage
.
get
(
aId
)
;
storage
.
push
(
aEvent
)
;
if
(
storage
.
length
>
STORAGE_MAX_EVENTS
)
{
storage
.
shift
(
)
;
}
Services
.
obs
.
notifyObservers
(
aEvent
"
console
-
api
-
log
-
event
"
aOuterId
)
;
Services
.
obs
.
notifyObservers
(
aEvent
"
console
-
storage
-
cache
-
event
"
aId
)
;
}
clearEvents
:
function
CS_clearEvents
(
aId
)
{
if
(
aId
!
=
null
)
{
_consoleStorage
.
delete
(
aId
)
;
}
else
{
_consoleStorage
.
clear
(
)
;
Services
.
obs
.
notifyObservers
(
null
"
console
-
storage
-
reset
"
)
;
}
}
}
;
var
EXPORTED_SYMBOLS
=
[
"
ConsoleAPIStorageService
"
]
;
