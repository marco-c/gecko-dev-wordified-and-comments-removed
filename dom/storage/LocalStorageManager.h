#
ifndef
mozilla_dom_StorageManager_h
#
define
mozilla_dom_StorageManager_h
#
include
"
nsIDOMStorageManager
.
h
"
#
include
"
StorageObserver
.
h
"
#
include
"
LocalStorage
.
h
"
#
include
"
StorageCache
.
h
"
#
include
"
mozilla
/
dom
/
Storage
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsClassHashtable
.
h
"
#
include
"
nsHashKeys
.
h
"
namespace
mozilla
{
class
OriginAttributesPattern
;
namespace
dom
{
class
LocalStorageManager
final
:
public
nsIDOMStorageManager
public
StorageObserverSink
{
NS_DECL_ISUPPORTS
NS_DECL_NSIDOMSTORAGEMANAGER
public
:
static
uint32_t
GetQuota
(
)
;
StorageCache
*
GetCache
(
const
nsACString
&
aOriginSuffix
const
nsACString
&
aOriginNoSuffix
)
;
already_AddRefed
<
StorageUsage
>
GetOriginUsage
(
const
nsACString
&
aOriginNoSuffix
)
;
static
nsCString
CreateOrigin
(
const
nsACString
&
aOriginSuffix
const
nsACString
&
aOriginNoSuffix
)
;
private
:
LocalStorageManager
(
)
;
~
LocalStorageManager
(
)
;
nsresult
Observe
(
const
char
*
aTopic
const
nsAString
&
aOriginAttributesPattern
const
nsACString
&
aOriginScope
)
override
;
class
StorageCacheHashKey
:
public
nsCStringHashKey
{
public
:
explicit
StorageCacheHashKey
(
const
nsACString
*
aKey
)
:
nsCStringHashKey
(
aKey
)
mCache
(
new
StorageCache
(
aKey
)
)
{
}
StorageCacheHashKey
(
const
StorageCacheHashKey
&
aOther
)
:
nsCStringHashKey
(
aOther
)
{
NS_ERROR
(
"
Shouldn
'
t
be
called
"
)
;
}
StorageCache
*
cache
(
)
{
return
mCache
;
}
void
HardRef
(
)
{
mCacheRef
=
mCache
;
}
private
:
StorageCache
*
mCache
;
RefPtr
<
StorageCache
>
mCacheRef
;
}
;
already_AddRefed
<
StorageCache
>
PutCache
(
const
nsACString
&
aOriginSuffix
const
nsACString
&
aOriginNoSuffix
nsIPrincipal
*
aPrincipal
)
;
enum
class
CreateMode
{
UseIfExistsNeverCreate
CreateAlways
CreateIfShouldPreload
}
;
nsresult
GetStorageInternal
(
CreateMode
aCreate
mozIDOMWindow
*
aWindow
nsIPrincipal
*
aPrincipal
const
nsAString
&
aDocumentURI
bool
aPrivate
nsIDOMStorage
*
*
aRetval
)
;
typedef
nsTHashtable
<
StorageCacheHashKey
>
CacheOriginHashtable
;
nsClassHashtable
<
nsCStringHashKey
CacheOriginHashtable
>
mCaches
;
bool
mLowDiskSpace
;
bool
IsLowDiskSpace
(
)
const
{
return
mLowDiskSpace
;
}
;
void
ClearCaches
(
uint32_t
aUnloadFlags
const
OriginAttributesPattern
&
aPattern
const
nsACString
&
aKeyPrefix
)
;
static
LocalStorageManager
*
Self
(
)
{
return
sSelf
;
}
static
LocalStorageManager
*
Ensure
(
)
;
private
:
nsDataHashtable
<
nsCStringHashKey
RefPtr
<
StorageUsage
>
>
mUsages
;
friend
class
StorageCache
;
virtual
void
DropCache
(
StorageCache
*
aCache
)
;
static
LocalStorageManager
*
sSelf
;
}
;
}
}
#
endif
