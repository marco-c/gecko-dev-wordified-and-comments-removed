#
ifndef
mozilla_dom_StorageObserver_h
#
define
mozilla_dom_StorageObserver_h
#
include
"
mozilla
/
dom
/
quota
/
CheckedUnsafePtr
.
h
"
#
include
"
nsINamed
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTObserverArray
.
h
"
#
include
"
nsWeakReference
.
h
"
namespace
mozilla
:
:
dom
{
class
StorageObserver
;
class
StorageObserverSink
:
public
SupportsCheckedUnsafePtr
<
CheckIf
<
DiagnosticAssertEnabled
>
>
{
public
:
virtual
~
StorageObserverSink
(
)
=
default
;
private
:
friend
class
StorageObserver
;
virtual
nsresult
Observe
(
const
char
*
aTopic
const
nsAString
&
aOriginAttributesPattern
const
nsACString
&
aOriginScope
)
=
0
;
}
;
class
StorageObserver
:
public
nsIObserver
public
nsINamed
public
nsSupportsWeakReference
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIOBSERVER
NS_DECL_NSINAMED
static
nsresult
Init
(
)
;
static
nsresult
Shutdown
(
)
;
static
StorageObserver
*
Self
(
)
{
return
sSelf
;
}
void
AddSink
(
StorageObserverSink
*
aObs
)
;
void
RemoveSink
(
StorageObserverSink
*
aObs
)
;
void
Notify
(
const
char
*
aTopic
const
nsAString
&
aOriginAttributesPattern
=
u
"
"
_ns
const
nsACString
&
aOriginScope
=
"
"
_ns
)
;
void
NoteBackgroundThread
(
uint32_t
aPrivateBrowsingId
nsIEventTarget
*
aBackgroundThread
)
;
private
:
virtual
~
StorageObserver
(
)
=
default
;
nsresult
GetOriginScope
(
const
char16_t
*
aData
nsACString
&
aOriginScope
)
;
static
void
TestingPrefChanged
(
const
char
*
aPrefName
void
*
aClosure
)
;
static
StorageObserver
*
sSelf
;
nsCOMPtr
<
nsIEventTarget
>
mBackgroundThread
[
2
]
;
nsTObserverArray
<
CheckedUnsafePtr
<
StorageObserverSink
>
>
mSinks
;
nsCOMPtr
<
nsITimer
>
mDBThreadStartDelayTimer
;
}
;
}
#
endif
