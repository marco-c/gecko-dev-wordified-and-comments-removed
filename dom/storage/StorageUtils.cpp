#
include
"
nsIURL
.
h
"
#
include
"
StorageUtils
.
h
"
#
include
"
mozilla
/
OriginAttributes
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsPrintfCString
.
h
"
namespace
mozilla
{
namespace
dom
{
namespace
StorageUtils
{
bool
PrincipalsEqual
(
nsIPrincipal
*
aObjectPrincipal
nsIPrincipal
*
aSubjectPrincipal
)
{
if
(
!
aSubjectPrincipal
)
{
return
true
;
}
if
(
!
aObjectPrincipal
)
{
return
false
;
}
return
aSubjectPrincipal
-
>
Equals
(
aObjectPrincipal
)
;
}
void
ReverseString
(
const
nsACString
&
aSource
nsACString
&
aResult
)
{
nsACString
:
:
const_iterator
sourceBegin
sourceEnd
;
aSource
.
BeginReading
(
sourceBegin
)
;
aSource
.
EndReading
(
sourceEnd
)
;
aResult
.
SetLength
(
aSource
.
Length
(
)
)
;
auto
destEnd
=
aResult
.
EndWriting
(
)
;
while
(
sourceBegin
!
=
sourceEnd
)
{
*
(
-
-
destEnd
)
=
*
sourceBegin
;
+
+
sourceBegin
;
}
}
nsresult
CreateReversedDomain
(
const
nsACString
&
aAsciiDomain
nsACString
&
aKey
)
{
if
(
aAsciiDomain
.
IsEmpty
(
)
)
{
return
NS_ERROR_NOT_AVAILABLE
;
}
ReverseString
(
aAsciiDomain
aKey
)
;
aKey
.
Append
(
'
.
'
)
;
return
NS_OK
;
}
nsCString
Scheme0Scope
(
const
nsACString
&
aOriginSuffix
const
nsACString
&
aOriginNoSuffix
)
{
nsCString
result
;
OriginAttributes
oa
;
if
(
!
aOriginSuffix
.
IsEmpty
(
)
)
{
DebugOnly
<
bool
>
success
=
oa
.
PopulateFromSuffix
(
aOriginSuffix
)
;
MOZ_ASSERT
(
success
)
;
}
if
(
oa
.
mInIsolatedMozBrowser
)
{
result
.
AppendInt
(
0
)
;
result
.
Append
(
'
:
'
)
;
result
.
Append
(
oa
.
mInIsolatedMozBrowser
?
'
t
'
:
'
f
'
)
;
result
.
Append
(
'
:
'
)
;
}
nsAutoCString
remaining
;
oa
.
mInIsolatedMozBrowser
=
false
;
oa
.
CreateSuffix
(
remaining
)
;
if
(
!
remaining
.
IsEmpty
(
)
)
{
MOZ_ASSERT
(
!
aOriginSuffix
.
IsEmpty
(
)
)
;
if
(
result
.
IsEmpty
(
)
)
{
result
.
AppendLiteral
(
"
0
:
f
:
"
)
;
}
result
.
Append
(
aOriginSuffix
)
;
result
.
Append
(
'
:
'
)
;
}
result
.
Append
(
aOriginNoSuffix
)
;
return
result
;
}
}
}
}
