#
include
"
LSObserver
.
h
"
#
include
"
ActorsChild
.
h
"
#
include
<
utility
>
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsTHashMap
.
h
"
namespace
mozilla
:
:
dom
{
namespace
{
using
LSObserverHashtable
=
nsTHashMap
<
nsCStringHashKey
LSObserver
*
>
;
StaticAutoPtr
<
LSObserverHashtable
>
gLSObservers
;
}
LSObserver
:
:
LSObserver
(
const
nsACString
&
aOrigin
)
:
mActor
(
nullptr
)
mOrigin
(
aOrigin
)
{
AssertIsOnOwningThread
(
)
;
if
(
!
gLSObservers
)
{
gLSObservers
=
new
LSObserverHashtable
(
)
;
}
MOZ_ASSERT
(
!
gLSObservers
-
>
Contains
(
mOrigin
)
)
;
gLSObservers
-
>
InsertOrUpdate
(
mOrigin
this
)
;
}
LSObserver
:
:
~
LSObserver
(
)
{
AssertIsOnOwningThread
(
)
;
if
(
mActor
)
{
mActor
-
>
SendDeleteMeInternal
(
)
;
MOZ_ASSERT
(
!
mActor
"
SendDeleteMeInternal
should
have
cleared
!
"
)
;
}
MOZ_ASSERT
(
gLSObservers
)
;
MOZ_ASSERT
(
gLSObservers
-
>
Get
(
mOrigin
)
)
;
gLSObservers
-
>
Remove
(
mOrigin
)
;
if
(
!
gLSObservers
-
>
Count
(
)
)
{
gLSObservers
=
nullptr
;
}
}
LSObserver
*
LSObserver
:
:
Get
(
const
nsACString
&
aOrigin
)
{
return
gLSObservers
?
gLSObservers
-
>
Get
(
aOrigin
)
:
nullptr
;
}
void
LSObserver
:
:
SetActor
(
LSObserverChild
*
aActor
)
{
AssertIsOnOwningThread
(
)
;
MOZ_ASSERT
(
aActor
)
;
MOZ_ASSERT
(
!
mActor
)
;
mActor
=
aActor
;
}
}
