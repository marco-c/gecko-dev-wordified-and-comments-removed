#
ifndef
mozilla_dom_localstorage_LSWriteOptimizer_h
#
define
mozilla_dom_localstorage_LSWriteOptimizer_h
namespace
mozilla
{
namespace
dom
{
class
LSWriteOptimizerBase
{
protected
:
class
WriteInfo
;
class
DeleteItemInfo
;
class
TruncateInfo
;
nsAutoPtr
<
WriteInfo
>
mTruncateInfo
;
nsClassHashtable
<
nsStringHashKey
WriteInfo
>
mWriteInfos
;
int64_t
mTotalDelta
;
NS_DECL_OWNINGTHREAD
public
:
LSWriteOptimizerBase
(
)
:
mTotalDelta
(
0
)
{
}
LSWriteOptimizerBase
(
LSWriteOptimizerBase
&
&
aWriteOptimizer
)
:
mTruncateInfo
(
std
:
:
move
(
aWriteOptimizer
.
mTruncateInfo
)
)
{
AssertIsOnOwningThread
(
)
;
MOZ_ASSERT
(
&
aWriteOptimizer
!
=
this
)
;
mWriteInfos
.
SwapElements
(
aWriteOptimizer
.
mWriteInfos
)
;
mTotalDelta
=
aWriteOptimizer
.
mTotalDelta
;
aWriteOptimizer
.
mTotalDelta
=
0
;
}
void
AssertIsOnOwningThread
(
)
const
{
NS_ASSERT_OWNINGTHREAD
(
LSWriteOptimizerBase
)
;
}
void
DeleteItem
(
const
nsAString
&
aKey
int64_t
aDelta
=
0
)
;
void
Truncate
(
int64_t
aDelta
=
0
)
;
bool
HasWrites
(
)
const
{
AssertIsOnOwningThread
(
)
;
return
mTruncateInfo
|
|
!
mWriteInfos
.
IsEmpty
(
)
;
}
void
Reset
(
)
{
AssertIsOnOwningThread
(
)
;
mTruncateInfo
=
nullptr
;
mWriteInfos
.
Clear
(
)
;
}
}
;
class
LSWriteOptimizerBase
:
:
WriteInfo
{
public
:
virtual
~
WriteInfo
(
)
=
default
;
enum
Type
{
InsertItem
=
0
UpdateItem
DeleteItem
Truncate
}
;
virtual
Type
GetType
(
)
=
0
;
}
;
class
LSWriteOptimizerBase
:
:
DeleteItemInfo
final
:
public
WriteInfo
{
nsString
mKey
;
public
:
explicit
DeleteItemInfo
(
const
nsAString
&
aKey
)
:
mKey
(
aKey
)
{
}
const
nsAString
&
GetKey
(
)
const
{
return
mKey
;
}
private
:
Type
GetType
(
)
override
{
return
DeleteItem
;
}
}
;
class
LSWriteOptimizerBase
:
:
TruncateInfo
final
:
public
WriteInfo
{
public
:
TruncateInfo
(
)
{
}
private
:
Type
GetType
(
)
override
{
return
Truncate
;
}
}
;
template
<
typename
T
typename
U
=
T
>
class
LSWriteOptimizer
;
template
<
typename
T
typename
U
>
class
LSWriteOptimizer
:
public
LSWriteOptimizerBase
{
protected
:
class
InsertItemInfo
;
class
UpdateItemInfo
;
public
:
void
InsertItem
(
const
nsAString
&
aKey
const
T
&
aValue
int64_t
aDelta
=
0
)
;
void
UpdateItem
(
const
nsAString
&
aKey
const
T
&
aValue
int64_t
aDelta
=
0
)
;
}
;
template
<
typename
T
typename
U
>
class
LSWriteOptimizer
<
T
U
>
:
:
InsertItemInfo
:
public
WriteInfo
{
nsString
mKey
;
U
mValue
;
public
:
InsertItemInfo
(
const
nsAString
&
aKey
const
T
&
aValue
)
:
mKey
(
aKey
)
mValue
(
aValue
)
{
}
const
nsAString
&
GetKey
(
)
const
{
return
mKey
;
}
const
T
&
GetValue
(
)
const
{
return
mValue
;
}
private
:
WriteInfo
:
:
Type
GetType
(
)
override
{
return
InsertItem
;
}
}
;
template
<
typename
T
typename
U
>
class
LSWriteOptimizer
<
T
U
>
:
:
UpdateItemInfo
final
:
public
InsertItemInfo
{
public
:
UpdateItemInfo
(
const
nsAString
&
aKey
const
T
&
aValue
)
:
InsertItemInfo
(
aKey
aValue
)
{
}
private
:
WriteInfo
:
:
Type
GetType
(
)
override
{
return
WriteInfo
:
:
UpdateItem
;
}
}
;
}
}
#
endif
