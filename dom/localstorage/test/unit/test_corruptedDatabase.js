async
function
doTest
(
profile
)
{
info
(
"
Testing
profile
"
+
profile
)
;
info
(
"
Clearing
"
)
;
let
request
=
clear
(
)
;
await
requestFinished
(
request
)
;
info
(
"
Installing
package
"
)
;
installPackage
(
profile
)
;
const
principal
=
getPrincipal
(
"
http
:
/
/
example
.
org
"
)
;
let
storage
=
getLocalStorage
(
principal
)
;
let
length
=
storage
.
length
;
ok
(
length
=
=
=
0
"
Correct
length
"
)
;
info
(
"
Resetting
origin
"
)
;
request
=
resetOrigin
(
principal
)
;
await
requestFinished
(
request
)
;
info
(
"
Getting
usage
"
)
;
request
=
getOriginUsage
(
principal
)
;
await
requestFinished
(
request
)
;
is
(
request
.
result
.
usage
0
"
Correct
usage
"
)
;
}
async
function
testSteps
(
)
{
info
(
"
Setting
pref
"
)
;
Services
.
prefs
.
setBoolPref
(
"
dom
.
storage
.
next_gen
"
true
)
;
const
profiles
=
[
"
corruptedDatabase_profile
"
"
corruptedDatabase_missingUsageFile_profile
"
]
;
for
(
const
profile
of
profiles
)
{
await
doTest
(
profile
)
;
}
}
