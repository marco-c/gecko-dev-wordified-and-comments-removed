#
include
"
GamepadEventChannelParent
.
h
"
#
include
"
GamepadPlatformService
.
h
"
#
include
"
mozilla
/
dom
/
GamepadMonitoring
.
h
"
#
include
"
mozilla
/
ipc
/
BackgroundParent
.
h
"
#
include
"
nsThreadUtils
.
h
"
namespace
mozilla
:
:
dom
{
using
namespace
mozilla
:
:
ipc
;
namespace
{
class
SendGamepadUpdateRunnable
final
:
public
Runnable
{
private
:
~
SendGamepadUpdateRunnable
(
)
=
default
;
RefPtr
<
GamepadEventChannelParent
>
mParent
;
GamepadChangeEvent
mEvent
;
public
:
SendGamepadUpdateRunnable
(
GamepadEventChannelParent
*
aParent
GamepadChangeEvent
aEvent
)
:
Runnable
(
"
dom
:
:
SendGamepadUpdateRunnable
"
)
mParent
(
aParent
)
mEvent
(
aEvent
)
{
MOZ_ASSERT
(
mParent
)
;
}
NS_IMETHOD
Run
(
)
override
{
AssertIsOnBackgroundThread
(
)
;
Unused
<
<
mParent
-
>
SendGamepadUpdate
(
mEvent
)
;
return
NS_OK
;
}
}
;
}
already_AddRefed
<
GamepadEventChannelParent
>
GamepadEventChannelParent
:
:
Create
(
)
{
return
RefPtr
<
GamepadEventChannelParent
>
(
new
GamepadEventChannelParent
(
)
)
.
forget
(
)
;
}
GamepadEventChannelParent
:
:
GamepadEventChannelParent
(
)
{
AssertIsOnBackgroundThread
(
)
;
mBackgroundEventTarget
=
GetCurrentEventTarget
(
)
;
GamepadPlatformService
:
:
AddChannelParent
(
RefPtr
<
GamepadEventChannelParent
>
(
this
)
)
;
}
void
GamepadEventChannelParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
AssertIsOnBackgroundThread
(
)
;
GamepadPlatformService
:
:
RemoveChannelParent
(
this
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
GamepadEventChannelParent
:
:
RecvVibrateHaptic
(
const
Tainted
<
uint32_t
>
&
aControllerIdx
const
Tainted
<
uint32_t
>
&
aHapticIndex
const
Tainted
<
double
>
&
aIntensity
const
Tainted
<
double
>
&
aDuration
const
Tainted
<
uint32_t
>
&
aPromiseID
)
{
if
(
SendReplyGamepadPromise
(
MOZ_NO_VALIDATE
(
aPromiseID
"
This
value
is
unused
aside
from
being
passed
back
to
the
child
.
"
)
)
)
{
return
IPC_OK
(
)
;
}
return
IPC_FAIL
(
this
"
SendReplyGamepadPromise
fail
.
"
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
GamepadEventChannelParent
:
:
RecvStopVibrateHaptic
(
const
Tainted
<
uint32_t
>
&
aControllerIdx
)
{
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
GamepadEventChannelParent
:
:
RecvLightIndicatorColor
(
const
Tainted
<
uint32_t
>
&
aControllerIdx
const
Tainted
<
uint32_t
>
&
aLightColorIndex
const
Tainted
<
uint8_t
>
&
aRed
const
Tainted
<
uint8_t
>
&
aGreen
const
Tainted
<
uint8_t
>
&
aBlue
const
Tainted
<
uint32_t
>
&
aPromiseID
)
{
SetGamepadLightIndicatorColor
(
aControllerIdx
aLightColorIndex
aRed
aGreen
aBlue
)
;
if
(
SendReplyGamepadPromise
(
MOZ_NO_VALIDATE
(
aPromiseID
"
This
value
is
unused
aside
from
being
passed
back
to
the
child
.
"
)
)
)
{
return
IPC_OK
(
)
;
}
return
IPC_FAIL
(
this
"
SendReplyGamepadPromise
fail
.
"
)
;
}
void
GamepadEventChannelParent
:
:
DispatchUpdateEvent
(
const
GamepadChangeEvent
&
aEvent
)
{
mBackgroundEventTarget
-
>
Dispatch
(
new
SendGamepadUpdateRunnable
(
this
aEvent
)
NS_DISPATCH_NORMAL
)
;
}
}
