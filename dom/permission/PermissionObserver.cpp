#
include
"
PermissionObserver
.
h
"
#
include
"
mozilla
/
dom
/
PermissionStatus
.
h
"
#
include
"
mozilla
/
dom
/
WindowGlobalChild
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsIObserverService
.
h
"
#
include
"
nsIPermission
.
h
"
#
include
"
PermissionUtils
.
h
"
namespace
mozilla
:
:
dom
{
namespace
{
PermissionObserver
*
gInstance
=
nullptr
;
}
NS_IMPL_ISUPPORTS
(
PermissionObserver
nsIObserver
nsISupportsWeakReference
)
PermissionObserver
:
:
PermissionObserver
(
)
{
MOZ_ASSERT
(
!
gInstance
)
;
}
PermissionObserver
:
:
~
PermissionObserver
(
)
{
MOZ_ASSERT
(
mSinks
.
IsEmpty
(
)
)
;
MOZ_ASSERT
(
gInstance
=
=
this
)
;
gInstance
=
nullptr
;
}
already_AddRefed
<
PermissionObserver
>
PermissionObserver
:
:
GetInstance
(
)
{
RefPtr
<
PermissionObserver
>
instance
=
gInstance
;
if
(
!
instance
)
{
instance
=
new
PermissionObserver
(
)
;
nsCOMPtr
<
nsIObserverService
>
obs
=
services
:
:
GetObserverService
(
)
;
if
(
NS_WARN_IF
(
!
obs
)
)
{
return
nullptr
;
}
nsresult
rv
=
obs
-
>
AddObserver
(
instance
"
perm
-
changed
"
true
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
nullptr
;
}
rv
=
obs
-
>
AddObserver
(
instance
"
perm
-
changed
-
notify
-
only
"
true
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
nullptr
;
}
gInstance
=
instance
;
}
return
instance
.
forget
(
)
;
}
void
PermissionObserver
:
:
AddSink
(
PermissionStatus
*
aSink
)
{
MOZ_ASSERT
(
aSink
)
;
MOZ_ASSERT
(
!
mSinks
.
Contains
(
aSink
)
)
;
mSinks
.
AppendElement
(
aSink
)
;
}
void
PermissionObserver
:
:
RemoveSink
(
PermissionStatus
*
aSink
)
{
MOZ_ASSERT
(
aSink
)
;
MOZ_ASSERT
(
mSinks
.
Contains
(
aSink
)
)
;
mSinks
.
RemoveElement
(
aSink
)
;
}
NS_IMETHODIMP
PermissionObserver
:
:
Observe
(
nsISupports
*
aSubject
const
char
*
aTopic
const
char16_t
*
aData
)
{
MOZ_ASSERT
(
!
strcmp
(
aTopic
"
perm
-
changed
"
)
|
|
!
strcmp
(
aTopic
"
perm
-
changed
-
notify
-
only
"
)
)
;
if
(
mSinks
.
IsEmpty
(
)
)
{
return
NS_OK
;
}
nsCOMPtr
<
nsIPermission
>
perm
=
nullptr
;
nsCOMPtr
<
nsPIDOMWindowInner
>
innerWindow
=
nullptr
;
nsAutoCString
type
;
if
(
!
strcmp
(
aTopic
"
perm
-
changed
"
)
)
{
perm
=
do_QueryInterface
(
aSubject
)
;
if
(
!
perm
)
{
return
NS_OK
;
}
perm
-
>
GetType
(
type
)
;
}
else
if
(
!
strcmp
(
aTopic
"
perm
-
changed
-
notify
-
only
"
)
)
{
innerWindow
=
do_QueryInterface
(
aSubject
)
;
if
(
!
innerWindow
)
{
return
NS_OK
;
}
type
=
NS_ConvertUTF16toUTF8
(
aData
)
;
}
Maybe
<
PermissionName
>
permission
=
TypeToPermissionName
(
type
)
;
if
(
permission
)
{
for
(
auto
*
sink
:
mSinks
)
{
if
(
sink
-
>
mName
!
=
permission
.
value
(
)
)
{
continue
;
}
if
(
perm
&
&
sink
-
>
MaybeUpdatedBy
(
perm
)
)
{
sink
-
>
PermissionChanged
(
)
;
}
if
(
innerWindow
&
&
sink
-
>
MaybeUpdatedByNotifyOnly
(
innerWindow
)
)
{
sink
-
>
PermissionChanged
(
)
;
}
}
}
return
NS_OK
;
}
}
