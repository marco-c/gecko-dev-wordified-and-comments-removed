#
include
"
mozilla
/
dom
/
Fetch
.
h
"
#
include
"
mozilla
/
dom
/
Headers
.
h
"
#
include
"
mozilla
/
dom
/
Promise
.
h
"
#
include
"
mozilla
/
dom
/
Request
.
h
"
#
include
"
mozilla
/
dom
/
RequestBinding
.
h
"
#
include
"
mozilla
/
dom
/
Response
.
h
"
#
include
"
mozilla
/
dom
/
ResponseBinding
.
h
"
#
include
"
nsNetUtil
.
h
"
namespace
mozilla
:
:
dom
{
template
<
typename
T
typename
TPromise
>
RefPtr
<
TPromise
>
FetchJSONStructure
(
Request
*
aRequest
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
RefPtr
<
typename
TPromise
:
:
Private
>
resultPromise
=
new
typename
TPromise
:
:
Private
(
__func__
)
;
RequestOrUSVString
fetchInput
;
fetchInput
.
SetAsRequest
(
)
=
aRequest
;
RootedDictionary
<
RequestInit
>
requestInit
(
RootingCx
(
)
)
;
IgnoredErrorResult
error
;
RefPtr
<
Promise
>
fetchPromise
=
FetchRequest
(
aRequest
-
>
GetParentObject
(
)
fetchInput
requestInit
CallerType
:
:
System
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
resultPromise
-
>
Reject
(
NS_ERROR_FAILURE
__func__
)
;
return
resultPromise
;
}
RefPtr
<
DomPromiseListener
>
listener
=
new
DomPromiseListener
(
[
resultPromise
]
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aValue
)
{
if
(
NS_WARN_IF
(
!
aValue
.
isObject
(
)
)
)
{
resultPromise
-
>
Reject
(
NS_ERROR_FAILURE
__func__
)
;
return
;
}
JS
:
:
Rooted
<
JSObject
*
>
obj
(
aCx
&
aValue
.
toObject
(
)
)
;
MOZ_ASSERT
(
obj
)
;
Response
*
response
=
nullptr
;
if
(
NS_WARN_IF
(
NS_FAILED
(
UNWRAP_OBJECT
(
Response
&
obj
response
)
)
)
)
{
resultPromise
-
>
Reject
(
NS_ERROR_FAILURE
__func__
)
;
return
;
}
if
(
!
response
-
>
Ok
(
)
)
{
resultPromise
-
>
Reject
(
NS_ERROR_FAILURE
__func__
)
;
return
;
}
IgnoredErrorResult
error
;
RefPtr
<
Promise
>
jsonPromise
=
response
-
>
ConsumeBody
(
aCx
BodyConsumer
:
:
ConsumeType
:
:
CONSUME_JSON
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
resultPromise
-
>
Reject
(
NS_ERROR_FAILURE
__func__
)
;
return
;
}
RefPtr
<
DomPromiseListener
>
jsonListener
=
new
DomPromiseListener
(
[
resultPromise
]
(
JSContext
*
aCx
JS
:
:
Handle
<
JS
:
:
Value
>
aValue
)
{
T
result
;
bool
success
=
result
.
Init
(
aCx
aValue
)
;
if
(
!
success
)
{
resultPromise
-
>
Reject
(
NS_ERROR_FAILURE
__func__
)
;
return
;
}
resultPromise
-
>
Resolve
(
result
__func__
)
;
}
[
resultPromise
]
(
nsresult
aRv
)
{
resultPromise
-
>
Reject
(
aRv
__func__
)
;
}
)
;
jsonPromise
-
>
AppendNativeHandler
(
jsonListener
)
;
}
[
resultPromise
]
(
nsresult
aRv
)
{
resultPromise
-
>
Reject
(
aRv
__func__
)
;
}
)
;
fetchPromise
-
>
AppendNativeHandler
(
listener
)
;
return
resultPromise
;
}
}
