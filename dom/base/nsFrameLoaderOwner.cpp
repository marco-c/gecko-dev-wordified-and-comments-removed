#
include
"
nsFrameLoaderOwner
.
h
"
#
include
"
nsFrameLoader
.
h
"
#
include
"
nsFocusManager
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsSubDocumentFrame
.
h
"
#
include
"
nsQueryObject
.
h
"
#
include
"
mozilla
/
AsyncEventDispatcher
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
dom
/
CanonicalBrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
FrameLoaderBinding
.
h
"
#
include
"
mozilla
/
dom
/
HTMLIFrameElement
.
h
"
#
include
"
mozilla
/
dom
/
MozFrameLoaderOwnerBinding
.
h
"
#
include
"
mozilla
/
ScopeExit
.
h
"
#
include
"
mozilla
/
dom
/
BrowserBridgeChild
.
h
"
#
include
"
mozilla
/
dom
/
ContentParent
.
h
"
#
include
"
mozilla
/
dom
/
BrowserBridgeHost
.
h
"
#
include
"
mozilla
/
dom
/
BrowserHost
.
h
"
#
include
"
mozilla
/
StaticPrefs_fission
.
h
"
#
include
"
mozilla
/
EventStateManager
.
h
"
extern
mozilla
:
:
LazyLogModule
gSHIPBFCacheLog
;
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
already_AddRefed
<
nsFrameLoader
>
nsFrameLoaderOwner
:
:
GetFrameLoader
(
)
{
return
do_AddRef
(
mFrameLoader
)
;
}
void
nsFrameLoaderOwner
:
:
SetFrameLoader
(
nsFrameLoader
*
aNewFrameLoader
)
{
mFrameLoader
=
aNewFrameLoader
;
}
mozilla
:
:
dom
:
:
BrowsingContext
*
nsFrameLoaderOwner
:
:
GetBrowsingContext
(
)
{
if
(
mFrameLoader
)
{
return
mFrameLoader
-
>
GetBrowsingContext
(
)
;
}
return
nullptr
;
}
mozilla
:
:
dom
:
:
BrowsingContext
*
nsFrameLoaderOwner
:
:
GetExtantBrowsingContext
(
)
{
if
(
mFrameLoader
)
{
return
mFrameLoader
-
>
GetExtantBrowsingContext
(
)
;
}
return
nullptr
;
}
bool
nsFrameLoaderOwner
:
:
UseRemoteSubframes
(
)
{
RefPtr
<
Element
>
owner
=
do_QueryObject
(
this
)
;
nsILoadContext
*
loadContext
=
owner
-
>
OwnerDoc
(
)
-
>
GetLoadContext
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
loadContext
)
;
return
loadContext
-
>
UseRemoteSubframes
(
)
;
}
nsFrameLoaderOwner
:
:
ChangeRemotenessContextType
nsFrameLoaderOwner
:
:
ShouldPreserveBrowsingContext
(
bool
aIsRemote
bool
aReplaceBrowsingContext
)
{
if
(
aReplaceBrowsingContext
)
{
return
ChangeRemotenessContextType
:
:
DONT_PRESERVE
;
}
if
(
XRE_IsParentProcess
(
)
)
{
if
(
!
aIsRemote
)
{
return
ChangeRemotenessContextType
:
:
DONT_PRESERVE
;
}
if
(
mFrameLoader
&
&
!
mFrameLoader
-
>
IsRemoteFrame
(
)
)
{
return
ChangeRemotenessContextType
:
:
DONT_PRESERVE
;
}
}
if
(
UseRemoteSubframes
(
)
|
|
StaticPrefs
:
:
fission_preserve_browsing_contexts
(
)
)
{
return
ChangeRemotenessContextType
:
:
PRESERVE
;
}
return
ChangeRemotenessContextType
:
:
DONT_PRESERVE
;
}
void
nsFrameLoaderOwner
:
:
ChangeRemotenessCommon
(
const
ChangeRemotenessContextType
&
aContextType
const
RemotenessChangeOptions
&
aOptions
bool
aSwitchingInProgressLoad
bool
aIsRemote
BrowsingContextGroup
*
aGroup
std
:
:
function
<
void
(
)
>
&
aFrameLoaderInit
mozilla
:
:
ErrorResult
&
aRv
)
{
MOZ_ASSERT_IF
(
aGroup
aContextType
!
=
ChangeRemotenessContextType
:
:
PRESERVE
)
;
RefPtr
<
mozilla
:
:
dom
:
:
BrowsingContext
>
bc
;
bool
networkCreated
=
false
;
RefPtr
<
Element
>
owner
=
do_QueryObject
(
this
)
;
MOZ_ASSERT
(
owner
)
;
Document
*
doc
=
owner
-
>
OwnerDoc
(
)
;
doc
-
>
BlockOnload
(
)
;
auto
cleanup
=
MakeScopeExit
(
[
&
]
(
)
{
doc
-
>
UnblockOnload
(
false
)
;
}
)
;
{
nsAutoScriptBlocker
sb
;
if
(
mFrameLoader
)
{
bc
=
mFrameLoader
-
>
GetMaybePendingBrowsingContext
(
)
;
networkCreated
=
mFrameLoader
-
>
IsNetworkCreated
(
)
;
MOZ_ASSERT_IF
(
aOptions
.
mTryUseBFCache
aOptions
.
mReplaceBrowsingContext
)
;
if
(
aOptions
.
mTryUseBFCache
&
&
bc
)
{
SessionHistoryEntry
*
she
=
bc
-
>
Canonical
(
)
-
>
GetActiveSessionHistoryEntry
(
)
;
bool
useBFCache
=
she
&
&
she
=
=
aOptions
.
mActiveSessionHistoryEntry
&
&
!
she
-
>
GetFrameLoader
(
)
;
if
(
useBFCache
)
{
MOZ_LOG
(
gSHIPBFCacheLog
LogLevel
:
:
Debug
(
"
nsFrameLoaderOwner
:
:
ChangeRemotenessCommon
:
store
the
old
"
"
page
in
bfcache
"
)
)
;
Unused
<
<
bc
-
>
SetIsInBFCache
(
true
)
;
she
-
>
SetFrameLoader
(
mFrameLoader
)
;
mFrameLoader
=
nullptr
;
}
}
if
(
mFrameLoader
)
{
if
(
aContextType
=
=
ChangeRemotenessContextType
:
:
PRESERVE
)
{
mFrameLoader
-
>
SetWillChangeProcess
(
)
;
}
mFrameLoader
-
>
Destroy
(
aSwitchingInProgressLoad
)
;
mFrameLoader
=
nullptr
;
}
}
mFrameLoader
=
nsFrameLoader
:
:
Recreate
(
owner
bc
aGroup
aOptions
aIsRemote
networkCreated
aContextType
=
=
ChangeRemotenessContextType
:
:
PRESERVE
)
;
if
(
NS_WARN_IF
(
!
mFrameLoader
)
)
{
aRv
.
Throw
(
NS_ERROR_FAILURE
)
;
return
;
}
aFrameLoaderInit
(
)
;
if
(
NS_WARN_IF
(
aRv
.
Failed
(
)
)
)
{
return
;
}
}
ChangeFrameLoaderCommon
(
owner
)
;
}
void
nsFrameLoaderOwner
:
:
ChangeFrameLoaderCommon
(
Element
*
aOwner
)
{
if
(
nsSubDocumentFrame
*
ourFrame
=
do_QueryFrame
(
aOwner
-
>
GetPrimaryFrame
(
)
)
)
{
ourFrame
-
>
ResetFrameLoader
(
)
;
}
if
(
nsFocusManager
*
fm
=
nsFocusManager
:
:
GetFocusManager
(
)
)
{
if
(
fm
-
>
GetFocusedElement
(
)
=
=
aOwner
)
{
fm
-
>
ActivateRemoteFrameIfNeeded
(
*
aOwner
nsFocusManager
:
:
GenerateFocusActionId
(
)
)
;
}
}
if
(
aOwner
-
>
GetPrimaryFrame
(
)
)
{
EventStateManager
*
eventManager
=
aOwner
-
>
GetPrimaryFrame
(
)
-
>
PresContext
(
)
-
>
EventStateManager
(
)
;
eventManager
-
>
RecomputeMouseEnterStateForRemoteFrame
(
*
aOwner
)
;
}
if
(
aOwner
-
>
IsXULElement
(
)
)
{
(
new
mozilla
:
:
AsyncEventDispatcher
(
aOwner
u
"
XULFrameLoaderCreated
"
_ns
mozilla
:
:
CanBubble
:
:
eYes
mozilla
:
:
ChromeOnlyDispatch
:
:
eYes
)
)
-
>
RunDOMEventWhenSafe
(
)
;
}
}
void
nsFrameLoaderOwner
:
:
ChangeRemoteness
(
const
mozilla
:
:
dom
:
:
RemotenessOptions
&
aOptions
mozilla
:
:
ErrorResult
&
rv
)
{
bool
isRemote
=
!
aOptions
.
mRemoteType
.
IsEmpty
(
)
;
std
:
:
function
<
void
(
)
>
frameLoaderInit
=
[
&
]
{
if
(
isRemote
)
{
mFrameLoader
-
>
ConfigRemoteProcess
(
aOptions
.
mRemoteType
nullptr
)
;
}
if
(
aOptions
.
mPendingSwitchID
.
WasPassed
(
)
)
{
mFrameLoader
-
>
ResumeLoad
(
aOptions
.
mPendingSwitchID
.
Value
(
)
)
;
}
else
{
mFrameLoader
-
>
LoadFrame
(
false
)
;
}
}
;
auto
shouldPreserve
=
ShouldPreserveBrowsingContext
(
isRemote
false
)
;
RemotenessChangeOptions
options
;
ChangeRemotenessCommon
(
shouldPreserve
options
aOptions
.
mSwitchingInProgressLoad
isRemote
nullptr
frameLoaderInit
rv
)
;
}
void
nsFrameLoaderOwner
:
:
ChangeRemotenessWithBridge
(
BrowserBridgeChild
*
aBridge
mozilla
:
:
ErrorResult
&
rv
)
{
MOZ_ASSERT
(
XRE_IsContentProcess
(
)
)
;
if
(
NS_WARN_IF
(
!
mFrameLoader
)
)
{
rv
.
Throw
(
NS_ERROR_UNEXPECTED
)
;
return
;
}
std
:
:
function
<
void
(
)
>
frameLoaderInit
=
[
&
]
{
RefPtr
<
BrowserBridgeHost
>
host
=
aBridge
-
>
FinishInit
(
mFrameLoader
)
;
mFrameLoader
-
>
mPendingBrowsingContext
-
>
SetEmbedderElement
(
mFrameLoader
-
>
GetOwnerContent
(
)
)
;
mFrameLoader
-
>
mRemoteBrowser
=
host
;
}
;
RemotenessChangeOptions
options
;
ChangeRemotenessCommon
(
ChangeRemotenessContextType
:
:
PRESERVE
options
true
true
nullptr
frameLoaderInit
rv
)
;
}
void
nsFrameLoaderOwner
:
:
ChangeRemotenessToProcess
(
ContentParent
*
aContentParent
const
RemotenessChangeOptions
&
aOptions
BrowsingContextGroup
*
aGroup
mozilla
:
:
ErrorResult
&
rv
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT_IF
(
aGroup
aOptions
.
mReplaceBrowsingContext
)
;
bool
isRemote
=
aContentParent
!
=
nullptr
;
std
:
:
function
<
void
(
)
>
frameLoaderInit
=
[
&
]
{
if
(
isRemote
)
{
mFrameLoader
-
>
ConfigRemoteProcess
(
aContentParent
-
>
GetRemoteType
(
)
aContentParent
)
;
}
}
;
auto
shouldPreserve
=
ShouldPreserveBrowsingContext
(
isRemote
aOptions
.
mReplaceBrowsingContext
)
;
ChangeRemotenessCommon
(
shouldPreserve
aOptions
true
isRemote
aGroup
frameLoaderInit
rv
)
;
}
void
nsFrameLoaderOwner
:
:
SubframeCrashed
(
)
{
MOZ_ASSERT
(
XRE_IsContentProcess
(
)
)
;
std
:
:
function
<
void
(
)
>
frameLoaderInit
=
[
&
]
{
RefPtr
<
nsFrameLoader
>
frameLoader
=
mFrameLoader
;
nsContentUtils
:
:
AddScriptRunner
(
NS_NewRunnableFunction
(
"
nsFrameLoaderOwner
:
:
SubframeCrashed
"
[
frameLoader
]
(
)
{
nsCOMPtr
<
nsIURI
>
uri
;
nsresult
rv
=
NS_NewURI
(
getter_AddRefs
(
uri
)
"
about
:
blank
"
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
;
}
RefPtr
<
nsDocShell
>
docShell
=
frameLoader
-
>
GetDocShell
(
IgnoreErrors
(
)
)
;
if
(
NS_WARN_IF
(
!
docShell
)
)
{
return
;
}
bool
displayed
=
false
;
docShell
-
>
DisplayLoadError
(
NS_ERROR_FRAME_CRASHED
uri
u
"
about
:
blank
"
nullptr
&
displayed
)
;
}
)
)
;
}
;
RemotenessChangeOptions
options
;
ChangeRemotenessCommon
(
ChangeRemotenessContextType
:
:
PRESERVE
options
false
false
nullptr
frameLoaderInit
IgnoreErrors
(
)
)
;
}
void
nsFrameLoaderOwner
:
:
ReplaceFrameLoader
(
nsFrameLoader
*
aNewFrameLoader
)
{
MOZ_LOG
(
gSHIPBFCacheLog
LogLevel
:
:
Debug
(
"
nsFrameLoaderOwner
:
:
ReplaceFrameLoader
:
Replace
frameloader
"
)
)
;
mFrameLoader
=
aNewFrameLoader
;
if
(
auto
*
browserParent
=
mFrameLoader
-
>
GetBrowserParent
(
)
)
{
browserParent
-
>
AddWindowListeners
(
)
;
}
RefPtr
<
Element
>
owner
=
do_QueryObject
(
this
)
;
ChangeFrameLoaderCommon
(
owner
)
;
}
void
nsFrameLoaderOwner
:
:
AttachFrameLoader
(
nsFrameLoader
*
aFrameLoader
)
{
mFrameLoaderList
.
insertBack
(
aFrameLoader
)
;
}
void
nsFrameLoaderOwner
:
:
DetachFrameLoader
(
nsFrameLoader
*
aFrameLoader
)
{
if
(
aFrameLoader
-
>
isInList
(
)
)
{
MOZ_ASSERT
(
mFrameLoaderList
.
contains
(
aFrameLoader
)
)
;
aFrameLoader
-
>
remove
(
)
;
}
}
void
nsFrameLoaderOwner
:
:
FrameLoaderDestroying
(
nsFrameLoader
*
aFrameLoader
)
{
if
(
aFrameLoader
=
=
mFrameLoader
)
{
while
(
!
mFrameLoaderList
.
isEmpty
(
)
)
{
RefPtr
<
nsFrameLoader
>
loader
=
mFrameLoaderList
.
popFirst
(
)
;
if
(
loader
!
=
mFrameLoader
)
{
loader
-
>
Destroy
(
)
;
}
}
}
else
{
DetachFrameLoader
(
aFrameLoader
)
;
}
}
