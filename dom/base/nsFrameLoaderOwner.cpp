#
include
"
nsFrameLoaderOwner
.
h
"
#
include
"
nsFrameLoader
.
h
"
#
include
"
nsFocusManager
.
h
"
#
include
"
nsSubDocumentFrame
.
h
"
#
include
"
nsQueryObject
.
h
"
#
include
"
mozilla
/
AsyncEventDispatcher
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
FrameLoaderBinding
.
h
"
#
include
"
mozilla
/
dom
/
MozFrameLoaderOwnerBinding
.
h
"
#
include
"
mozilla
/
StaticPrefs_fission
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
already_AddRefed
<
nsFrameLoader
>
nsFrameLoaderOwner
:
:
GetFrameLoader
(
)
{
return
do_AddRef
(
mFrameLoader
)
;
}
void
nsFrameLoaderOwner
:
:
SetFrameLoader
(
nsFrameLoader
*
aNewFrameLoader
)
{
mFrameLoader
=
aNewFrameLoader
;
}
already_AddRefed
<
mozilla
:
:
dom
:
:
BrowsingContext
>
nsFrameLoaderOwner
:
:
GetBrowsingContext
(
)
{
if
(
mFrameLoader
)
{
return
mFrameLoader
-
>
GetBrowsingContext
(
)
;
}
return
nullptr
;
}
bool
nsFrameLoaderOwner
:
:
UseRemoteSubframes
(
)
{
RefPtr
<
Element
>
owner
=
do_QueryObject
(
this
)
;
MOZ_ASSERT
(
this
)
;
nsILoadContext
*
loadContext
=
owner
-
>
OwnerDoc
(
)
-
>
GetLoadContext
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
loadContext
)
;
return
loadContext
-
>
UseRemoteSubframes
(
)
;
}
bool
nsFrameLoaderOwner
:
:
ShouldPreserveBrowsingContext
(
const
mozilla
:
:
dom
:
:
RemotenessOptions
&
aOptions
)
{
if
(
aOptions
.
mReplaceBrowsingContext
)
{
return
false
;
}
if
(
XRE_IsParentProcess
(
)
&
&
(
!
aOptions
.
mRemoteType
.
WasPassed
(
)
|
|
aOptions
.
mRemoteType
.
Value
(
)
.
IsVoid
(
)
)
)
{
return
false
;
}
return
UseRemoteSubframes
(
)
|
|
StaticPrefs
:
:
fission_preserve_browsing_contexts
(
)
;
}
void
nsFrameLoaderOwner
:
:
ChangeRemoteness
(
const
mozilla
:
:
dom
:
:
RemotenessOptions
&
aOptions
mozilla
:
:
ErrorResult
&
rv
)
{
RefPtr
<
mozilla
:
:
dom
:
:
BrowsingContext
>
bc
;
if
(
mFrameLoader
)
{
if
(
ShouldPreserveBrowsingContext
(
aOptions
)
)
{
bc
=
mFrameLoader
-
>
GetBrowsingContext
(
)
;
mFrameLoader
-
>
SkipBrowsingContextDetach
(
)
;
}
mFrameLoader
-
>
Destroy
(
)
;
mFrameLoader
=
nullptr
;
}
RefPtr
<
Element
>
owner
=
do_QueryObject
(
this
)
;
MOZ_ASSERT
(
owner
)
;
mFrameLoader
=
nsFrameLoader
:
:
Create
(
owner
bc
aOptions
)
;
if
(
NS_WARN_IF
(
!
mFrameLoader
)
)
{
return
;
}
if
(
aOptions
.
mPendingSwitchID
.
WasPassed
(
)
)
{
mFrameLoader
-
>
ResumeLoad
(
aOptions
.
mPendingSwitchID
.
Value
(
)
)
;
}
else
{
mFrameLoader
-
>
LoadFrame
(
false
)
;
}
if
(
nsSubDocumentFrame
*
ourFrame
=
do_QueryFrame
(
owner
-
>
GetPrimaryFrame
(
)
)
)
{
ourFrame
-
>
ResetFrameLoader
(
)
;
}
if
(
nsFocusManager
*
fm
=
nsFocusManager
:
:
GetFocusManager
(
)
)
{
if
(
fm
-
>
GetFocusedElement
(
)
=
=
owner
)
{
fm
-
>
ActivateRemoteFrameIfNeeded
(
*
owner
)
;
}
}
(
new
mozilla
:
:
AsyncEventDispatcher
(
owner
NS_LITERAL_STRING
(
"
XULFrameLoaderCreated
"
)
mozilla
:
:
CanBubble
:
:
eYes
mozilla
:
:
ChromeOnlyDispatch
:
:
eYes
)
)
-
>
RunDOMEventWhenSafe
(
)
;
}
