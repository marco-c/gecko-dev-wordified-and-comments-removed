#
include
"
nsTreeSanitizer
.
h
"
#
include
"
mozilla
/
Algorithm
.
h
"
#
include
"
mozilla
/
ArrayUtils
.
h
"
#
include
"
mozilla
/
BindingStyleRule
.
h
"
#
include
"
mozilla
/
DeclarationBlock
.
h
"
#
include
"
mozilla
/
StyleSheetInlines
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
css
/
Rule
.
h
"
#
include
"
mozilla
/
dom
/
SanitizerBinding
.
h
"
#
include
"
mozilla
/
dom
/
CSSRuleList
.
h
"
#
include
"
mozilla
/
dom
/
DocumentFragment
.
h
"
#
include
"
mozilla
/
dom
/
ShadowIncludingTreeIterator
.
h
"
#
include
"
mozilla
/
dom
/
HTMLTemplateElement
.
h
"
#
include
"
mozilla
/
dom
/
HTMLUnknownElement
.
h
"
#
include
"
mozilla
/
dom
/
SRIMetadata
.
h
"
#
include
"
mozilla
/
NullPrincipal
.
h
"
#
include
"
nsAtom
.
h
"
#
include
"
nsCSSPropertyID
.
h
"
#
include
"
nsHashtablesFwd
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
nsUnicharInputStream
.
h
"
#
include
"
nsAttrName
.
h
"
#
include
"
nsIScriptError
.
h
"
#
include
"
nsIScriptSecurityManager
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIParserUtils
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsQueryObject
.
h
"
#
include
<
iterator
>
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
const
nsStaticAtom
*
const
kElementsHTML
[
]
=
{
nsGkAtoms
:
:
a
nsGkAtoms
:
:
abbr
nsGkAtoms
:
:
acronym
nsGkAtoms
:
:
address
nsGkAtoms
:
:
area
nsGkAtoms
:
:
article
nsGkAtoms
:
:
aside
nsGkAtoms
:
:
audio
nsGkAtoms
:
:
b
nsGkAtoms
:
:
bdi
nsGkAtoms
:
:
bdo
nsGkAtoms
:
:
big
nsGkAtoms
:
:
blockquote
nsGkAtoms
:
:
br
nsGkAtoms
:
:
button
nsGkAtoms
:
:
canvas
nsGkAtoms
:
:
caption
nsGkAtoms
:
:
center
nsGkAtoms
:
:
cite
nsGkAtoms
:
:
code
nsGkAtoms
:
:
col
nsGkAtoms
:
:
colgroup
nsGkAtoms
:
:
data
nsGkAtoms
:
:
datalist
nsGkAtoms
:
:
dd
nsGkAtoms
:
:
del
nsGkAtoms
:
:
details
nsGkAtoms
:
:
dfn
nsGkAtoms
:
:
dialog
nsGkAtoms
:
:
dir
nsGkAtoms
:
:
div
nsGkAtoms
:
:
dl
nsGkAtoms
:
:
dt
nsGkAtoms
:
:
em
nsGkAtoms
:
:
fieldset
nsGkAtoms
:
:
figcaption
nsGkAtoms
:
:
figure
nsGkAtoms
:
:
font
nsGkAtoms
:
:
footer
nsGkAtoms
:
:
form
nsGkAtoms
:
:
h1
nsGkAtoms
:
:
h2
nsGkAtoms
:
:
h3
nsGkAtoms
:
:
h4
nsGkAtoms
:
:
h5
nsGkAtoms
:
:
h6
nsGkAtoms
:
:
header
nsGkAtoms
:
:
hgroup
nsGkAtoms
:
:
hr
nsGkAtoms
:
:
i
nsGkAtoms
:
:
img
nsGkAtoms
:
:
input
nsGkAtoms
:
:
ins
nsGkAtoms
:
:
kbd
nsGkAtoms
:
:
keygen
nsGkAtoms
:
:
label
nsGkAtoms
:
:
legend
nsGkAtoms
:
:
li
nsGkAtoms
:
:
link
nsGkAtoms
:
:
listing
nsGkAtoms
:
:
main
nsGkAtoms
:
:
map
nsGkAtoms
:
:
mark
nsGkAtoms
:
:
menu
nsGkAtoms
:
:
meta
nsGkAtoms
:
:
meter
nsGkAtoms
:
:
nav
nsGkAtoms
:
:
nobr
nsGkAtoms
:
:
noscript
nsGkAtoms
:
:
ol
nsGkAtoms
:
:
optgroup
nsGkAtoms
:
:
option
nsGkAtoms
:
:
output
nsGkAtoms
:
:
p
nsGkAtoms
:
:
picture
nsGkAtoms
:
:
pre
nsGkAtoms
:
:
progress
nsGkAtoms
:
:
q
nsGkAtoms
:
:
rb
nsGkAtoms
:
:
rp
nsGkAtoms
:
:
rt
nsGkAtoms
:
:
rtc
nsGkAtoms
:
:
ruby
nsGkAtoms
:
:
s
nsGkAtoms
:
:
samp
nsGkAtoms
:
:
section
nsGkAtoms
:
:
select
nsGkAtoms
:
:
small
nsGkAtoms
:
:
source
nsGkAtoms
:
:
span
nsGkAtoms
:
:
strike
nsGkAtoms
:
:
strong
nsGkAtoms
:
:
sub
nsGkAtoms
:
:
summary
nsGkAtoms
:
:
sup
nsGkAtoms
:
:
table
nsGkAtoms
:
:
tbody
nsGkAtoms
:
:
td
nsGkAtoms
:
:
textarea
nsGkAtoms
:
:
tfoot
nsGkAtoms
:
:
th
nsGkAtoms
:
:
thead
nsGkAtoms
:
:
time
nsGkAtoms
:
:
tr
nsGkAtoms
:
:
track
nsGkAtoms
:
:
tt
nsGkAtoms
:
:
u
nsGkAtoms
:
:
ul
nsGkAtoms
:
:
var
nsGkAtoms
:
:
video
nsGkAtoms
:
:
wbr
nullptr
}
;
const
nsStaticAtom
*
const
kAttributesHTML
[
]
=
{
nsGkAtoms
:
:
abbr
nsGkAtoms
:
:
accept
nsGkAtoms
:
:
acceptcharset
nsGkAtoms
:
:
accesskey
nsGkAtoms
:
:
action
nsGkAtoms
:
:
alt
nsGkAtoms
:
:
as
nsGkAtoms
:
:
autocomplete
nsGkAtoms
:
:
autofocus
nsGkAtoms
:
:
autoplay
nsGkAtoms
:
:
axis
nsGkAtoms
:
:
_char
nsGkAtoms
:
:
charoff
nsGkAtoms
:
:
charset
nsGkAtoms
:
:
checked
nsGkAtoms
:
:
cite
nsGkAtoms
:
:
_class
nsGkAtoms
:
:
cols
nsGkAtoms
:
:
colspan
nsGkAtoms
:
:
content
nsGkAtoms
:
:
contenteditable
nsGkAtoms
:
:
contextmenu
nsGkAtoms
:
:
controls
nsGkAtoms
:
:
coords
nsGkAtoms
:
:
crossorigin
nsGkAtoms
:
:
datetime
nsGkAtoms
:
:
dir
nsGkAtoms
:
:
disabled
nsGkAtoms
:
:
draggable
nsGkAtoms
:
:
enctype
nsGkAtoms
:
:
face
nsGkAtoms
:
:
_for
nsGkAtoms
:
:
frame
nsGkAtoms
:
:
headers
nsGkAtoms
:
:
height
nsGkAtoms
:
:
hidden
nsGkAtoms
:
:
high
nsGkAtoms
:
:
href
nsGkAtoms
:
:
hreflang
nsGkAtoms
:
:
icon
nsGkAtoms
:
:
id
nsGkAtoms
:
:
integrity
nsGkAtoms
:
:
ismap
nsGkAtoms
:
:
itemid
nsGkAtoms
:
:
itemprop
nsGkAtoms
:
:
itemref
nsGkAtoms
:
:
itemscope
nsGkAtoms
:
:
itemtype
nsGkAtoms
:
:
kind
nsGkAtoms
:
:
label
nsGkAtoms
:
:
lang
nsGkAtoms
:
:
list_
nsGkAtoms
:
:
longdesc
nsGkAtoms
:
:
loop
nsGkAtoms
:
:
low
nsGkAtoms
:
:
max
nsGkAtoms
:
:
maxlength
nsGkAtoms
:
:
media
nsGkAtoms
:
:
method
nsGkAtoms
:
:
min
nsGkAtoms
:
:
minlength
nsGkAtoms
:
:
multiple
nsGkAtoms
:
:
muted
nsGkAtoms
:
:
name
nsGkAtoms
:
:
nohref
nsGkAtoms
:
:
novalidate
nsGkAtoms
:
:
nowrap
nsGkAtoms
:
:
open
nsGkAtoms
:
:
optimum
nsGkAtoms
:
:
pattern
nsGkAtoms
:
:
placeholder
nsGkAtoms
:
:
playbackrate
nsGkAtoms
:
:
poster
nsGkAtoms
:
:
preload
nsGkAtoms
:
:
prompt
nsGkAtoms
:
:
pubdate
nsGkAtoms
:
:
radiogroup
nsGkAtoms
:
:
readonly
nsGkAtoms
:
:
rel
nsGkAtoms
:
:
required
nsGkAtoms
:
:
rev
nsGkAtoms
:
:
reversed
nsGkAtoms
:
:
role
nsGkAtoms
:
:
rows
nsGkAtoms
:
:
rowspan
nsGkAtoms
:
:
rules
nsGkAtoms
:
:
scoped
nsGkAtoms
:
:
scope
nsGkAtoms
:
:
selected
nsGkAtoms
:
:
shape
nsGkAtoms
:
:
span
nsGkAtoms
:
:
spellcheck
nsGkAtoms
:
:
src
nsGkAtoms
:
:
srclang
nsGkAtoms
:
:
start
nsGkAtoms
:
:
summary
nsGkAtoms
:
:
tabindex
nsGkAtoms
:
:
target
nsGkAtoms
:
:
title
nsGkAtoms
:
:
type
nsGkAtoms
:
:
usemap
nsGkAtoms
:
:
value
nsGkAtoms
:
:
width
nsGkAtoms
:
:
wrap
nullptr
}
;
const
nsStaticAtom
*
const
kPresAttributesHTML
[
]
=
{
nsGkAtoms
:
:
align
nsGkAtoms
:
:
background
nsGkAtoms
:
:
bgcolor
nsGkAtoms
:
:
border
nsGkAtoms
:
:
cellpadding
nsGkAtoms
:
:
cellspacing
nsGkAtoms
:
:
color
nsGkAtoms
:
:
compact
nsGkAtoms
:
:
clear
nsGkAtoms
:
:
hspace
nsGkAtoms
:
:
noshade
nsGkAtoms
:
:
pointSize
nsGkAtoms
:
:
size
nsGkAtoms
:
:
valign
nsGkAtoms
:
:
vspace
nullptr
}
;
const
nsStaticAtom
*
const
kURLAttributesHTML
[
]
=
{
nsGkAtoms
:
:
action
nsGkAtoms
:
:
href
nsGkAtoms
:
:
src
nsGkAtoms
:
:
longdesc
nsGkAtoms
:
:
cite
nsGkAtoms
:
:
background
nsGkAtoms
:
:
formaction
nsGkAtoms
:
:
data
nsGkAtoms
:
:
ping
nsGkAtoms
:
:
poster
nullptr
}
;
const
nsStaticAtom
*
const
kElementsSVG
[
]
=
{
nsGkAtoms
:
:
a
nsGkAtoms
:
:
circle
nsGkAtoms
:
:
clipPath
nsGkAtoms
:
:
colorProfile
nsGkAtoms
:
:
cursor
nsGkAtoms
:
:
defs
nsGkAtoms
:
:
desc
nsGkAtoms
:
:
ellipse
nsGkAtoms
:
:
elevation
nsGkAtoms
:
:
erode
nsGkAtoms
:
:
ex
nsGkAtoms
:
:
exact
nsGkAtoms
:
:
exponent
nsGkAtoms
:
:
feBlend
nsGkAtoms
:
:
feColorMatrix
nsGkAtoms
:
:
feComponentTransfer
nsGkAtoms
:
:
feComposite
nsGkAtoms
:
:
feConvolveMatrix
nsGkAtoms
:
:
feDiffuseLighting
nsGkAtoms
:
:
feDisplacementMap
nsGkAtoms
:
:
feDistantLight
nsGkAtoms
:
:
feDropShadow
nsGkAtoms
:
:
feFlood
nsGkAtoms
:
:
feFuncA
nsGkAtoms
:
:
feFuncB
nsGkAtoms
:
:
feFuncG
nsGkAtoms
:
:
feFuncR
nsGkAtoms
:
:
feGaussianBlur
nsGkAtoms
:
:
feImage
nsGkAtoms
:
:
feMerge
nsGkAtoms
:
:
feMergeNode
nsGkAtoms
:
:
feMorphology
nsGkAtoms
:
:
feOffset
nsGkAtoms
:
:
fePointLight
nsGkAtoms
:
:
feSpecularLighting
nsGkAtoms
:
:
feSpotLight
nsGkAtoms
:
:
feTile
nsGkAtoms
:
:
feTurbulence
nsGkAtoms
:
:
filter
nsGkAtoms
:
:
font
nsGkAtoms
:
:
font_face
nsGkAtoms
:
:
font_face_format
nsGkAtoms
:
:
font_face_name
nsGkAtoms
:
:
font_face_src
nsGkAtoms
:
:
font_face_uri
nsGkAtoms
:
:
foreignObject
nsGkAtoms
:
:
g
nsGkAtoms
:
:
glyphRef
nsGkAtoms
:
:
image
nsGkAtoms
:
:
line
nsGkAtoms
:
:
linearGradient
nsGkAtoms
:
:
marker
nsGkAtoms
:
:
mask
nsGkAtoms
:
:
metadata
nsGkAtoms
:
:
missingGlyph
nsGkAtoms
:
:
mpath
nsGkAtoms
:
:
path
nsGkAtoms
:
:
pattern
nsGkAtoms
:
:
polygon
nsGkAtoms
:
:
polyline
nsGkAtoms
:
:
radialGradient
nsGkAtoms
:
:
rect
nsGkAtoms
:
:
stop
nsGkAtoms
:
:
svg
nsGkAtoms
:
:
svgSwitch
nsGkAtoms
:
:
symbol
nsGkAtoms
:
:
text
nsGkAtoms
:
:
textPath
nsGkAtoms
:
:
title
nsGkAtoms
:
:
tref
nsGkAtoms
:
:
tspan
nsGkAtoms
:
:
use
nsGkAtoms
:
:
view
nullptr
}
;
constexpr
const
nsStaticAtom
*
const
kAttributesSVG
[
]
=
{
nsGkAtoms
:
:
accumulate
nsGkAtoms
:
:
additive
nsGkAtoms
:
:
alignment_baseline
nsGkAtoms
:
:
amplitude
nsGkAtoms
:
:
attributeName
nsGkAtoms
:
:
attributeType
nsGkAtoms
:
:
azimuth
nsGkAtoms
:
:
baseFrequency
nsGkAtoms
:
:
baseline_shift
nsGkAtoms
:
:
begin
nsGkAtoms
:
:
bias
nsGkAtoms
:
:
by
nsGkAtoms
:
:
calcMode
nsGkAtoms
:
:
_class
nsGkAtoms
:
:
clip_path
nsGkAtoms
:
:
clip_rule
nsGkAtoms
:
:
clipPathUnits
nsGkAtoms
:
:
color
nsGkAtoms
:
:
colorInterpolation
nsGkAtoms
:
:
colorInterpolationFilters
nsGkAtoms
:
:
cursor
nsGkAtoms
:
:
cx
nsGkAtoms
:
:
cy
nsGkAtoms
:
:
d
nsGkAtoms
:
:
diffuseConstant
nsGkAtoms
:
:
direction
nsGkAtoms
:
:
display
nsGkAtoms
:
:
divisor
nsGkAtoms
:
:
dominant_baseline
nsGkAtoms
:
:
dur
nsGkAtoms
:
:
dx
nsGkAtoms
:
:
dy
nsGkAtoms
:
:
edgeMode
nsGkAtoms
:
:
elevation
nsGkAtoms
:
:
end
nsGkAtoms
:
:
fill
nsGkAtoms
:
:
fill_opacity
nsGkAtoms
:
:
fill_rule
nsGkAtoms
:
:
filter
nsGkAtoms
:
:
filterUnits
nsGkAtoms
:
:
flood_color
nsGkAtoms
:
:
flood_opacity
nsGkAtoms
:
:
font
nsGkAtoms
:
:
font_family
nsGkAtoms
:
:
font_size
nsGkAtoms
:
:
font_size_adjust
nsGkAtoms
:
:
font_stretch
nsGkAtoms
:
:
font_style
nsGkAtoms
:
:
font_variant
nsGkAtoms
:
:
fontWeight
nsGkAtoms
:
:
format
nsGkAtoms
:
:
from
nsGkAtoms
:
:
fx
nsGkAtoms
:
:
fy
nsGkAtoms
:
:
gradientTransform
nsGkAtoms
:
:
gradientUnits
nsGkAtoms
:
:
height
nsGkAtoms
:
:
href
nsGkAtoms
:
:
id
nsGkAtoms
:
:
image_rendering
nsGkAtoms
:
:
in
nsGkAtoms
:
:
in2
nsGkAtoms
:
:
intercept
nsGkAtoms
:
:
k1
nsGkAtoms
:
:
k2
nsGkAtoms
:
:
k3
nsGkAtoms
:
:
k4
nsGkAtoms
:
:
kernelMatrix
nsGkAtoms
:
:
kernelUnitLength
nsGkAtoms
:
:
keyPoints
nsGkAtoms
:
:
keySplines
nsGkAtoms
:
:
keyTimes
nsGkAtoms
:
:
lang
nsGkAtoms
:
:
letter_spacing
nsGkAtoms
:
:
lighting_color
nsGkAtoms
:
:
limitingConeAngle
nsGkAtoms
:
:
marker
nsGkAtoms
:
:
marker_end
nsGkAtoms
:
:
marker_mid
nsGkAtoms
:
:
marker_start
nsGkAtoms
:
:
markerHeight
nsGkAtoms
:
:
markerUnits
nsGkAtoms
:
:
markerWidth
nsGkAtoms
:
:
mask
nsGkAtoms
:
:
maskContentUnits
nsGkAtoms
:
:
maskUnits
nsGkAtoms
:
:
max
nsGkAtoms
:
:
media
nsGkAtoms
:
:
method
nsGkAtoms
:
:
min
nsGkAtoms
:
:
mode
nsGkAtoms
:
:
name
nsGkAtoms
:
:
numOctaves
nsGkAtoms
:
:
offset
nsGkAtoms
:
:
opacity
nsGkAtoms
:
:
_operator
nsGkAtoms
:
:
order
nsGkAtoms
:
:
orient
nsGkAtoms
:
:
orientation
nsGkAtoms
:
:
overflow
nsGkAtoms
:
:
path
nsGkAtoms
:
:
pathLength
nsGkAtoms
:
:
patternContentUnits
nsGkAtoms
:
:
patternTransform
nsGkAtoms
:
:
patternUnits
nsGkAtoms
:
:
pointer_events
nsGkAtoms
:
:
points
nsGkAtoms
:
:
pointsAtX
nsGkAtoms
:
:
pointsAtY
nsGkAtoms
:
:
pointsAtZ
nsGkAtoms
:
:
preserveAlpha
nsGkAtoms
:
:
preserveAspectRatio
nsGkAtoms
:
:
primitiveUnits
nsGkAtoms
:
:
r
nsGkAtoms
:
:
radius
nsGkAtoms
:
:
refX
nsGkAtoms
:
:
refY
nsGkAtoms
:
:
repeatCount
nsGkAtoms
:
:
repeatDur
nsGkAtoms
:
:
requiredExtensions
nsGkAtoms
:
:
requiredFeatures
nsGkAtoms
:
:
restart
nsGkAtoms
:
:
result
nsGkAtoms
:
:
rotate
nsGkAtoms
:
:
rx
nsGkAtoms
:
:
ry
nsGkAtoms
:
:
scale
nsGkAtoms
:
:
seed
nsGkAtoms
:
:
shape_rendering
nsGkAtoms
:
:
slope
nsGkAtoms
:
:
spacing
nsGkAtoms
:
:
specularConstant
nsGkAtoms
:
:
specularExponent
nsGkAtoms
:
:
spreadMethod
nsGkAtoms
:
:
startOffset
nsGkAtoms
:
:
stdDeviation
nsGkAtoms
:
:
stitchTiles
nsGkAtoms
:
:
stop_color
nsGkAtoms
:
:
stop_opacity
nsGkAtoms
:
:
string
nsGkAtoms
:
:
stroke
nsGkAtoms
:
:
stroke_dasharray
nsGkAtoms
:
:
stroke_dashoffset
nsGkAtoms
:
:
stroke_linecap
nsGkAtoms
:
:
stroke_linejoin
nsGkAtoms
:
:
stroke_miterlimit
nsGkAtoms
:
:
stroke_opacity
nsGkAtoms
:
:
stroke_width
nsGkAtoms
:
:
surfaceScale
nsGkAtoms
:
:
systemLanguage
nsGkAtoms
:
:
tableValues
nsGkAtoms
:
:
target
nsGkAtoms
:
:
targetX
nsGkAtoms
:
:
targetY
nsGkAtoms
:
:
text_anchor
nsGkAtoms
:
:
text_decoration
nsGkAtoms
:
:
text_rendering
nsGkAtoms
:
:
title
nsGkAtoms
:
:
to
nsGkAtoms
:
:
transform
nsGkAtoms
:
:
transform_origin
nsGkAtoms
:
:
type
nsGkAtoms
:
:
unicode_bidi
nsGkAtoms
:
:
values
nsGkAtoms
:
:
vector_effect
nsGkAtoms
:
:
viewBox
nsGkAtoms
:
:
viewTarget
nsGkAtoms
:
:
visibility
nsGkAtoms
:
:
width
nsGkAtoms
:
:
word_spacing
nsGkAtoms
:
:
writing_mode
nsGkAtoms
:
:
x
nsGkAtoms
:
:
x1
nsGkAtoms
:
:
x2
nsGkAtoms
:
:
xChannelSelector
nsGkAtoms
:
:
y
nsGkAtoms
:
:
y1
nsGkAtoms
:
:
y2
nsGkAtoms
:
:
yChannelSelector
nsGkAtoms
:
:
z
nsGkAtoms
:
:
zoomAndPan
nullptr
}
;
constexpr
const
nsStaticAtom
*
const
kURLAttributesSVG
[
]
=
{
nsGkAtoms
:
:
href
nullptr
}
;
static_assert
(
AllOf
(
std
:
:
begin
(
kURLAttributesSVG
)
std
:
:
end
(
kURLAttributesSVG
)
[
]
(
auto
aURLAttributeSVG
)
{
return
AnyOf
(
std
:
:
begin
(
kAttributesSVG
)
std
:
:
end
(
kAttributesSVG
)
[
&
]
(
auto
aAttributeSVG
)
{
return
aAttributeSVG
=
=
aURLAttributeSVG
;
}
)
;
}
)
)
;
const
nsStaticAtom
*
const
kElementsMathML
[
]
=
{
nsGkAtoms
:
:
abs_
nsGkAtoms
:
:
_and
nsGkAtoms
:
:
annotation_
nsGkAtoms
:
:
annotation_xml_
nsGkAtoms
:
:
apply_
nsGkAtoms
:
:
approx_
nsGkAtoms
:
:
arccos_
nsGkAtoms
:
:
arccosh_
nsGkAtoms
:
:
arccot_
nsGkAtoms
:
:
arccoth_
nsGkAtoms
:
:
arccsc_
nsGkAtoms
:
:
arccsch_
nsGkAtoms
:
:
arcsec_
nsGkAtoms
:
:
arcsech_
nsGkAtoms
:
:
arcsin_
nsGkAtoms
:
:
arcsinh_
nsGkAtoms
:
:
arctan_
nsGkAtoms
:
:
arctanh_
nsGkAtoms
:
:
arg_
nsGkAtoms
:
:
bind_
nsGkAtoms
:
:
bvar_
nsGkAtoms
:
:
card_
nsGkAtoms
:
:
cartesianproduct_
nsGkAtoms
:
:
cbytes_
nsGkAtoms
:
:
ceiling
nsGkAtoms
:
:
cerror_
nsGkAtoms
:
:
ci_
nsGkAtoms
:
:
cn_
nsGkAtoms
:
:
codomain_
nsGkAtoms
:
:
complexes_
nsGkAtoms
:
:
compose_
nsGkAtoms
:
:
condition_
nsGkAtoms
:
:
conjugate_
nsGkAtoms
:
:
cos_
nsGkAtoms
:
:
cosh_
nsGkAtoms
:
:
cot_
nsGkAtoms
:
:
coth_
nsGkAtoms
:
:
cs_
nsGkAtoms
:
:
csc_
nsGkAtoms
:
:
csch_
nsGkAtoms
:
:
csymbol_
nsGkAtoms
:
:
curl_
nsGkAtoms
:
:
declare
nsGkAtoms
:
:
degree_
nsGkAtoms
:
:
determinant_
nsGkAtoms
:
:
diff_
nsGkAtoms
:
:
divergence_
nsGkAtoms
:
:
divide_
nsGkAtoms
:
:
domain_
nsGkAtoms
:
:
domainofapplication_
nsGkAtoms
:
:
el
nsGkAtoms
:
:
emptyset_
nsGkAtoms
:
:
eq_
nsGkAtoms
:
:
equivalent_
nsGkAtoms
:
:
eulergamma_
nsGkAtoms
:
:
exists_
nsGkAtoms
:
:
exp_
nsGkAtoms
:
:
exponentiale_
nsGkAtoms
:
:
factorial_
nsGkAtoms
:
:
factorof_
nsGkAtoms
:
:
_false
nsGkAtoms
:
:
floor
nsGkAtoms
:
:
fn_
nsGkAtoms
:
:
forall_
nsGkAtoms
:
:
gcd_
nsGkAtoms
:
:
geq_
nsGkAtoms
:
:
grad
nsGkAtoms
:
:
gt_
nsGkAtoms
:
:
ident_
nsGkAtoms
:
:
image
nsGkAtoms
:
:
imaginary_
nsGkAtoms
:
:
imaginaryi_
nsGkAtoms
:
:
implies_
nsGkAtoms
:
:
in
nsGkAtoms
:
:
infinity
nsGkAtoms
:
:
int_
nsGkAtoms
:
:
integers_
nsGkAtoms
:
:
intersect_
nsGkAtoms
:
:
interval_
nsGkAtoms
:
:
inverse_
nsGkAtoms
:
:
lambda_
nsGkAtoms
:
:
laplacian_
nsGkAtoms
:
:
lcm_
nsGkAtoms
:
:
leq_
nsGkAtoms
:
:
limit_
nsGkAtoms
:
:
list_
nsGkAtoms
:
:
ln_
nsGkAtoms
:
:
log_
nsGkAtoms
:
:
logbase_
nsGkAtoms
:
:
lowlimit_
nsGkAtoms
:
:
lt_
nsGkAtoms
:
:
maction_
nsGkAtoms
:
:
maligngroup_
nsGkAtoms
:
:
malignmark_
nsGkAtoms
:
:
math
nsGkAtoms
:
:
matrix
nsGkAtoms
:
:
matrixrow_
nsGkAtoms
:
:
max
nsGkAtoms
:
:
mean_
nsGkAtoms
:
:
median_
nsGkAtoms
:
:
menclose_
nsGkAtoms
:
:
merror_
nsGkAtoms
:
:
mfenced_
nsGkAtoms
:
:
mfrac_
nsGkAtoms
:
:
mglyph_
nsGkAtoms
:
:
mi_
nsGkAtoms
:
:
min
nsGkAtoms
:
:
minus_
nsGkAtoms
:
:
mlabeledtr_
nsGkAtoms
:
:
mlongdiv_
nsGkAtoms
:
:
mmultiscripts_
nsGkAtoms
:
:
mn_
nsGkAtoms
:
:
mo_
nsGkAtoms
:
:
mode
nsGkAtoms
:
:
moment_
nsGkAtoms
:
:
momentabout_
nsGkAtoms
:
:
mover_
nsGkAtoms
:
:
mpadded_
nsGkAtoms
:
:
mphantom_
nsGkAtoms
:
:
mprescripts_
nsGkAtoms
:
:
mroot_
nsGkAtoms
:
:
mrow_
nsGkAtoms
:
:
ms_
nsGkAtoms
:
:
mscarries_
nsGkAtoms
:
:
mscarry_
nsGkAtoms
:
:
msgroup_
nsGkAtoms
:
:
msline_
nsGkAtoms
:
:
mspace_
nsGkAtoms
:
:
msqrt_
nsGkAtoms
:
:
msrow_
nsGkAtoms
:
:
mstack_
nsGkAtoms
:
:
mstyle_
nsGkAtoms
:
:
msub_
nsGkAtoms
:
:
msubsup_
nsGkAtoms
:
:
msup_
nsGkAtoms
:
:
mtable_
nsGkAtoms
:
:
mtd_
nsGkAtoms
:
:
mtext_
nsGkAtoms
:
:
mtr_
nsGkAtoms
:
:
munder_
nsGkAtoms
:
:
munderover_
nsGkAtoms
:
:
naturalnumbers_
nsGkAtoms
:
:
neq_
nsGkAtoms
:
:
none
nsGkAtoms
:
:
_not
nsGkAtoms
:
:
notanumber_
nsGkAtoms
:
:
note_
nsGkAtoms
:
:
notin_
nsGkAtoms
:
:
notprsubset_
nsGkAtoms
:
:
notsubset_
nsGkAtoms
:
:
_or
nsGkAtoms
:
:
otherwise
nsGkAtoms
:
:
outerproduct_
nsGkAtoms
:
:
partialdiff_
nsGkAtoms
:
:
pi_
nsGkAtoms
:
:
piece_
nsGkAtoms
:
:
piecewise_
nsGkAtoms
:
:
plus_
nsGkAtoms
:
:
power_
nsGkAtoms
:
:
primes_
nsGkAtoms
:
:
product_
nsGkAtoms
:
:
prsubset_
nsGkAtoms
:
:
quotient_
nsGkAtoms
:
:
rationals_
nsGkAtoms
:
:
real_
nsGkAtoms
:
:
reals_
nsGkAtoms
:
:
reln_
nsGkAtoms
:
:
rem
nsGkAtoms
:
:
root_
nsGkAtoms
:
:
scalarproduct_
nsGkAtoms
:
:
sdev_
nsGkAtoms
:
:
sec_
nsGkAtoms
:
:
sech_
nsGkAtoms
:
:
selector_
nsGkAtoms
:
:
semantics_
nsGkAtoms
:
:
sep_
nsGkAtoms
:
:
set
nsGkAtoms
:
:
setdiff_
nsGkAtoms
:
:
share_
nsGkAtoms
:
:
sin_
nsGkAtoms
:
:
sinh_
nsGkAtoms
:
:
subset_
nsGkAtoms
:
:
sum
nsGkAtoms
:
:
tan_
nsGkAtoms
:
:
tanh_
nsGkAtoms
:
:
tendsto_
nsGkAtoms
:
:
times_
nsGkAtoms
:
:
transpose_
nsGkAtoms
:
:
_true
nsGkAtoms
:
:
union_
nsGkAtoms
:
:
uplimit_
nsGkAtoms
:
:
variance_
nsGkAtoms
:
:
vector_
nsGkAtoms
:
:
vectorproduct_
nsGkAtoms
:
:
xor_
nullptr
}
;
const
nsStaticAtom
*
const
kAttributesMathML
[
]
=
{
nsGkAtoms
:
:
accent_
nsGkAtoms
:
:
accentunder_
nsGkAtoms
:
:
actiontype_
nsGkAtoms
:
:
align
nsGkAtoms
:
:
alignmentscope_
nsGkAtoms
:
:
alt
nsGkAtoms
:
:
altimg_
nsGkAtoms
:
:
altimg_height_
nsGkAtoms
:
:
altimg_valign_
nsGkAtoms
:
:
altimg_width_
nsGkAtoms
:
:
background
nsGkAtoms
:
:
base
nsGkAtoms
:
:
bevelled_
nsGkAtoms
:
:
cd_
nsGkAtoms
:
:
cdgroup_
nsGkAtoms
:
:
charalign_
nsGkAtoms
:
:
close
nsGkAtoms
:
:
closure_
nsGkAtoms
:
:
color
nsGkAtoms
:
:
columnalign_
nsGkAtoms
:
:
columnalignment_
nsGkAtoms
:
:
columnlines_
nsGkAtoms
:
:
columnspacing_
nsGkAtoms
:
:
columnspan_
nsGkAtoms
:
:
columnwidth_
nsGkAtoms
:
:
crossout_
nsGkAtoms
:
:
decimalpoint_
nsGkAtoms
:
:
definitionURL_
nsGkAtoms
:
:
denomalign_
nsGkAtoms
:
:
depth_
nsGkAtoms
:
:
dir
nsGkAtoms
:
:
display
nsGkAtoms
:
:
displaystyle_
nsGkAtoms
:
:
edge_
nsGkAtoms
:
:
encoding
nsGkAtoms
:
:
equalcolumns_
nsGkAtoms
:
:
equalrows_
nsGkAtoms
:
:
fence_
nsGkAtoms
:
:
fontfamily_
nsGkAtoms
:
:
fontsize_
nsGkAtoms
:
:
fontstyle_
nsGkAtoms
:
:
fontweight_
nsGkAtoms
:
:
form
nsGkAtoms
:
:
frame
nsGkAtoms
:
:
framespacing_
nsGkAtoms
:
:
groupalign_
nsGkAtoms
:
:
height
nsGkAtoms
:
:
href
nsGkAtoms
:
:
id
nsGkAtoms
:
:
indentalign_
nsGkAtoms
:
:
indentalignfirst_
nsGkAtoms
:
:
indentalignlast_
nsGkAtoms
:
:
indentshift_
nsGkAtoms
:
:
indentshiftfirst_
nsGkAtoms
:
:
indenttarget_
nsGkAtoms
:
:
index
nsGkAtoms
:
:
integer
nsGkAtoms
:
:
largeop_
nsGkAtoms
:
:
length
nsGkAtoms
:
:
linebreak_
nsGkAtoms
:
:
linebreakmultchar_
nsGkAtoms
:
:
linebreakstyle_
nsGkAtoms
:
:
linethickness_
nsGkAtoms
:
:
location_
nsGkAtoms
:
:
longdivstyle_
nsGkAtoms
:
:
lquote_
nsGkAtoms
:
:
lspace_
nsGkAtoms
:
:
ltr
nsGkAtoms
:
:
mathbackground_
nsGkAtoms
:
:
mathcolor_
nsGkAtoms
:
:
mathsize_
nsGkAtoms
:
:
mathvariant_
nsGkAtoms
:
:
maxsize_
nsGkAtoms
:
:
minlabelspacing_
nsGkAtoms
:
:
minsize_
nsGkAtoms
:
:
movablelimits_
nsGkAtoms
:
:
msgroup_
nsGkAtoms
:
:
name
nsGkAtoms
:
:
newline
nsGkAtoms
:
:
notation_
nsGkAtoms
:
:
numalign_
nsGkAtoms
:
:
number
nsGkAtoms
:
:
open
nsGkAtoms
:
:
order
nsGkAtoms
:
:
other
nsGkAtoms
:
:
overflow
nsGkAtoms
:
:
position
nsGkAtoms
:
:
role
nsGkAtoms
:
:
rowalign_
nsGkAtoms
:
:
rowlines_
nsGkAtoms
:
:
rowspacing_
nsGkAtoms
:
:
rowspan
nsGkAtoms
:
:
rquote_
nsGkAtoms
:
:
rspace_
nsGkAtoms
:
:
schemaLocation_
nsGkAtoms
:
:
scriptlevel_
nsGkAtoms
:
:
scriptminsize_
nsGkAtoms
:
:
scriptsize_
nsGkAtoms
:
:
scriptsizemultiplier_
nsGkAtoms
:
:
selection_
nsGkAtoms
:
:
separator_
nsGkAtoms
:
:
separators_
nsGkAtoms
:
:
shift_
nsGkAtoms
:
:
side_
nsGkAtoms
:
:
src
nsGkAtoms
:
:
stackalign_
nsGkAtoms
:
:
stretchy_
nsGkAtoms
:
:
subscriptshift_
nsGkAtoms
:
:
superscriptshift_
nsGkAtoms
:
:
symmetric_
nsGkAtoms
:
:
type
nsGkAtoms
:
:
voffset_
nsGkAtoms
:
:
width
nsGkAtoms
:
:
xref_
nullptr
}
;
const
nsStaticAtom
*
const
kURLAttributesMathML
[
]
=
{
nsGkAtoms
:
:
href
nsGkAtoms
:
:
src
nsGkAtoms
:
:
cdgroup_
nsGkAtoms
:
:
altimg_
nsGkAtoms
:
:
definitionURL_
nullptr
}
;
constexpr
const
nsStaticAtom
*
const
kBaselineElementAllowlist
[
]
=
{
nsGkAtoms
:
:
a
nsGkAtoms
:
:
abbr
nsGkAtoms
:
:
acronym
nsGkAtoms
:
:
address
nsGkAtoms
:
:
area
nsGkAtoms
:
:
article
nsGkAtoms
:
:
aside
nsGkAtoms
:
:
audio
nsGkAtoms
:
:
b
nsGkAtoms
:
:
basefont
nsGkAtoms
:
:
bdi
nsGkAtoms
:
:
bdo
nsGkAtoms
:
:
bgsound
nsGkAtoms
:
:
big
nsGkAtoms
:
:
blockquote
nsGkAtoms
:
:
body
nsGkAtoms
:
:
br
nsGkAtoms
:
:
button
nsGkAtoms
:
:
canvas
nsGkAtoms
:
:
caption
nsGkAtoms
:
:
center
nsGkAtoms
:
:
cite
nsGkAtoms
:
:
code
nsGkAtoms
:
:
col
nsGkAtoms
:
:
colgroup
nsGkAtoms
:
:
command
nsGkAtoms
:
:
data
nsGkAtoms
:
:
datalist
nsGkAtoms
:
:
dd
nsGkAtoms
:
:
del
nsGkAtoms
:
:
details
nsGkAtoms
:
:
dfn
nsGkAtoms
:
:
dialog
nsGkAtoms
:
:
dir
nsGkAtoms
:
:
div
nsGkAtoms
:
:
dl
nsGkAtoms
:
:
dt
nsGkAtoms
:
:
em
nsGkAtoms
:
:
fieldset
nsGkAtoms
:
:
figcaption
nsGkAtoms
:
:
figure
nsGkAtoms
:
:
font
nsGkAtoms
:
:
footer
nsGkAtoms
:
:
form
nsGkAtoms
:
:
h1
nsGkAtoms
:
:
h2
nsGkAtoms
:
:
h3
nsGkAtoms
:
:
h4
nsGkAtoms
:
:
h5
nsGkAtoms
:
:
h6
nsGkAtoms
:
:
head
nsGkAtoms
:
:
header
nsGkAtoms
:
:
hgroup
nsGkAtoms
:
:
hr
nsGkAtoms
:
:
html
nsGkAtoms
:
:
i
nsGkAtoms
:
:
image
nsGkAtoms
:
:
img
nsGkAtoms
:
:
input
nsGkAtoms
:
:
ins
nsGkAtoms
:
:
kbd
nsGkAtoms
:
:
keygen
nsGkAtoms
:
:
label
nsGkAtoms
:
:
layer
nsGkAtoms
:
:
legend
nsGkAtoms
:
:
li
nsGkAtoms
:
:
link
nsGkAtoms
:
:
listing
nsGkAtoms
:
:
main
nsGkAtoms
:
:
map
nsGkAtoms
:
:
mark
nsGkAtoms
:
:
marquee
nsGkAtoms
:
:
menu
nsGkAtoms
:
:
meta
nsGkAtoms
:
:
meter
nsGkAtoms
:
:
nav
nsGkAtoms
:
:
nobr
nsGkAtoms
:
:
ol
nsGkAtoms
:
:
optgroup
nsGkAtoms
:
:
option
nsGkAtoms
:
:
output
nsGkAtoms
:
:
p
nsGkAtoms
:
:
picture
nsGkAtoms
:
:
plaintext
nsGkAtoms
:
:
popup
nsGkAtoms
:
:
portal
nsGkAtoms
:
:
pre
nsGkAtoms
:
:
progress
nsGkAtoms
:
:
q
nsGkAtoms
:
:
rb
nsGkAtoms
:
:
rp
nsGkAtoms
:
:
rt
nsGkAtoms
:
:
rtc
nsGkAtoms
:
:
ruby
nsGkAtoms
:
:
s
nsGkAtoms
:
:
samp
nsGkAtoms
:
:
section
nsGkAtoms
:
:
select
nsGkAtoms
:
:
selectmenu
nsGkAtoms
:
:
slot
nsGkAtoms
:
:
small
nsGkAtoms
:
:
source
nsGkAtoms
:
:
span
nsGkAtoms
:
:
strike
nsGkAtoms
:
:
strong
nsGkAtoms
:
:
style
nsGkAtoms
:
:
sub
nsGkAtoms
:
:
summary
nsGkAtoms
:
:
sup
nsGkAtoms
:
:
table
nsGkAtoms
:
:
tbody
nsGkAtoms
:
:
td
nsGkAtoms
:
:
_template
nsGkAtoms
:
:
textarea
nsGkAtoms
:
:
tfoot
nsGkAtoms
:
:
th
nsGkAtoms
:
:
thead
nsGkAtoms
:
:
time
nsGkAtoms
:
:
title
nsGkAtoms
:
:
tr
nsGkAtoms
:
:
track
nsGkAtoms
:
:
tt
nsGkAtoms
:
:
u
nsGkAtoms
:
:
ul
nsGkAtoms
:
:
var
nsGkAtoms
:
:
video
nsGkAtoms
:
:
wbr
nsGkAtoms
:
:
xmp
}
;
constexpr
const
nsStaticAtom
*
const
kDefaultConfigurationElementAllowlist
[
]
=
{
nsGkAtoms
:
:
a
nsGkAtoms
:
:
abbr
nsGkAtoms
:
:
acronym
nsGkAtoms
:
:
address
nsGkAtoms
:
:
area
nsGkAtoms
:
:
article
nsGkAtoms
:
:
aside
nsGkAtoms
:
:
audio
nsGkAtoms
:
:
b
nsGkAtoms
:
:
bdi
nsGkAtoms
:
:
bdo
nsGkAtoms
:
:
bgsound
nsGkAtoms
:
:
big
nsGkAtoms
:
:
blockquote
nsGkAtoms
:
:
body
nsGkAtoms
:
:
br
nsGkAtoms
:
:
button
nsGkAtoms
:
:
canvas
nsGkAtoms
:
:
caption
nsGkAtoms
:
:
center
nsGkAtoms
:
:
cite
nsGkAtoms
:
:
code
nsGkAtoms
:
:
col
nsGkAtoms
:
:
colgroup
nsGkAtoms
:
:
datalist
nsGkAtoms
:
:
dd
nsGkAtoms
:
:
del
nsGkAtoms
:
:
details
nsGkAtoms
:
:
dfn
nsGkAtoms
:
:
dialog
nsGkAtoms
:
:
dir
nsGkAtoms
:
:
div
nsGkAtoms
:
:
dl
nsGkAtoms
:
:
dt
nsGkAtoms
:
:
em
nsGkAtoms
:
:
fieldset
nsGkAtoms
:
:
figcaption
nsGkAtoms
:
:
figure
nsGkAtoms
:
:
font
nsGkAtoms
:
:
footer
nsGkAtoms
:
:
form
nsGkAtoms
:
:
h1
nsGkAtoms
:
:
h2
nsGkAtoms
:
:
h3
nsGkAtoms
:
:
h4
nsGkAtoms
:
:
h5
nsGkAtoms
:
:
h6
nsGkAtoms
:
:
head
nsGkAtoms
:
:
header
nsGkAtoms
:
:
hgroup
nsGkAtoms
:
:
hr
nsGkAtoms
:
:
html
nsGkAtoms
:
:
i
nsGkAtoms
:
:
img
nsGkAtoms
:
:
input
nsGkAtoms
:
:
ins
nsGkAtoms
:
:
kbd
nsGkAtoms
:
:
keygen
nsGkAtoms
:
:
label
nsGkAtoms
:
:
layer
nsGkAtoms
:
:
legend
nsGkAtoms
:
:
li
nsGkAtoms
:
:
link
nsGkAtoms
:
:
listing
nsGkAtoms
:
:
main
nsGkAtoms
:
:
map
nsGkAtoms
:
:
mark
nsGkAtoms
:
:
marquee
nsGkAtoms
:
:
menu
nsGkAtoms
:
:
meta
nsGkAtoms
:
:
meter
nsGkAtoms
:
:
nav
nsGkAtoms
:
:
nobr
nsGkAtoms
:
:
ol
nsGkAtoms
:
:
optgroup
nsGkAtoms
:
:
option
nsGkAtoms
:
:
output
nsGkAtoms
:
:
p
nsGkAtoms
:
:
picture
nsGkAtoms
:
:
popup
nsGkAtoms
:
:
pre
nsGkAtoms
:
:
progress
nsGkAtoms
:
:
q
nsGkAtoms
:
:
rb
nsGkAtoms
:
:
rp
nsGkAtoms
:
:
rt
nsGkAtoms
:
:
rtc
nsGkAtoms
:
:
ruby
nsGkAtoms
:
:
s
nsGkAtoms
:
:
samp
nsGkAtoms
:
:
section
nsGkAtoms
:
:
select
nsGkAtoms
:
:
selectmenu
nsGkAtoms
:
:
small
nsGkAtoms
:
:
source
nsGkAtoms
:
:
span
nsGkAtoms
:
:
strike
nsGkAtoms
:
:
strong
nsGkAtoms
:
:
style
nsGkAtoms
:
:
sub
nsGkAtoms
:
:
summary
nsGkAtoms
:
:
sup
nsGkAtoms
:
:
table
nsGkAtoms
:
:
tbody
nsGkAtoms
:
:
td
nsGkAtoms
:
:
tfoot
nsGkAtoms
:
:
th
nsGkAtoms
:
:
thead
nsGkAtoms
:
:
time
nsGkAtoms
:
:
tr
nsGkAtoms
:
:
track
nsGkAtoms
:
:
tt
nsGkAtoms
:
:
u
nsGkAtoms
:
:
ul
nsGkAtoms
:
:
var
nsGkAtoms
:
:
video
nsGkAtoms
:
:
wbr
}
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sElementsHTML
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sAttributesHTML
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sPresAttributesHTML
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sElementsSVG
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sAttributesSVG
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sElementsMathML
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sAttributesMathML
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sBaselineElementAllowlist
=
nullptr
;
nsTreeSanitizer
:
:
AtomsTable
*
nsTreeSanitizer
:
:
sDefaultConfigurationElementAllowlist
=
nullptr
;
nsIPrincipal
*
nsTreeSanitizer
:
:
sNullPrincipal
=
nullptr
;
nsTreeSanitizer
:
:
nsTreeSanitizer
(
uint32_t
aFlags
)
:
mAllowStyles
(
aFlags
&
nsIParserUtils
:
:
SanitizerAllowStyle
)
mAllowComments
(
aFlags
&
nsIParserUtils
:
:
SanitizerAllowComments
)
mDropNonCSSPresentation
(
aFlags
&
nsIParserUtils
:
:
SanitizerDropNonCSSPresentation
)
mDropForms
(
aFlags
&
nsIParserUtils
:
:
SanitizerDropForms
)
mCidEmbedsOnly
(
aFlags
&
nsIParserUtils
:
:
SanitizerCidEmbedsOnly
)
mDropMedia
(
aFlags
&
nsIParserUtils
:
:
SanitizerDropMedia
)
mFullDocument
(
false
)
mLogRemovals
(
aFlags
&
nsIParserUtils
:
:
SanitizerLogRemovals
)
{
if
(
mCidEmbedsOnly
)
{
mAllowStyles
=
false
;
}
if
(
!
sElementsHTML
)
{
InitializeStatics
(
)
;
}
}
bool
nsTreeSanitizer
:
:
MustFlatten
(
int32_t
aNamespace
nsAtom
*
aLocal
)
{
if
(
mIsForSanitizerAPI
)
{
return
MustFlattenForSanitizerAPI
(
aNamespace
aLocal
)
;
}
if
(
aNamespace
=
=
kNameSpaceID_XHTML
)
{
if
(
mDropNonCSSPresentation
&
&
(
nsGkAtoms
:
:
font
=
=
aLocal
|
|
nsGkAtoms
:
:
center
=
=
aLocal
)
)
{
return
true
;
}
if
(
mDropForms
&
&
(
nsGkAtoms
:
:
form
=
=
aLocal
|
|
nsGkAtoms
:
:
input
=
=
aLocal
|
|
nsGkAtoms
:
:
option
=
=
aLocal
|
|
nsGkAtoms
:
:
optgroup
=
=
aLocal
)
)
{
return
true
;
}
if
(
mFullDocument
&
&
(
nsGkAtoms
:
:
title
=
=
aLocal
|
|
nsGkAtoms
:
:
html
=
=
aLocal
|
|
nsGkAtoms
:
:
head
=
=
aLocal
|
|
nsGkAtoms
:
:
body
=
=
aLocal
)
)
{
return
false
;
}
if
(
nsGkAtoms
:
:
_template
=
=
aLocal
)
{
return
false
;
}
return
!
sElementsHTML
-
>
Contains
(
aLocal
)
;
}
if
(
aNamespace
=
=
kNameSpaceID_SVG
)
{
if
(
mCidEmbedsOnly
|
|
mDropMedia
)
{
return
true
;
}
return
!
sElementsSVG
-
>
Contains
(
aLocal
)
;
}
if
(
aNamespace
=
=
kNameSpaceID_MathML
)
{
return
!
sElementsMathML
-
>
Contains
(
aLocal
)
;
}
return
true
;
}
bool
nsTreeSanitizer
:
:
MustFlattenForSanitizerAPI
(
int32_t
aNamespace
nsAtom
*
aLocal
)
{
if
(
mBlockElements
&
&
mBlockElements
-
>
Contains
(
aLocal
)
)
{
return
true
;
}
if
(
mAllowElements
)
{
if
(
!
mAllowElements
-
>
Contains
(
aLocal
)
)
{
return
true
;
}
}
else
{
if
(
!
sDefaultConfigurationElementAllowlist
-
>
Contains
(
aLocal
)
)
{
return
true
;
}
}
return
false
;
}
bool
nsTreeSanitizer
:
:
IsURL
(
const
nsStaticAtom
*
const
*
aURLs
nsAtom
*
aLocalName
)
{
const
nsStaticAtom
*
atom
;
while
(
(
atom
=
*
aURLs
)
)
{
if
(
atom
=
=
aLocalName
)
{
return
true
;
}
+
+
aURLs
;
}
return
false
;
}
bool
nsTreeSanitizer
:
:
MustPrune
(
int32_t
aNamespace
nsAtom
*
aLocal
mozilla
:
:
dom
:
:
Element
*
aElement
)
{
if
(
mIsForSanitizerAPI
)
{
return
MustPruneForSanitizerAPI
(
aNamespace
aLocal
aElement
)
;
}
if
(
nsGkAtoms
:
:
script
=
=
aLocal
)
{
return
true
;
}
if
(
aNamespace
=
=
kNameSpaceID_XHTML
)
{
if
(
nsGkAtoms
:
:
title
=
=
aLocal
&
&
!
mFullDocument
)
{
return
true
;
}
if
(
mDropForms
&
&
(
nsGkAtoms
:
:
select
=
=
aLocal
|
|
nsGkAtoms
:
:
button
=
=
aLocal
|
|
nsGkAtoms
:
:
datalist
=
=
aLocal
)
)
{
return
true
;
}
if
(
mDropMedia
&
&
(
nsGkAtoms
:
:
img
=
=
aLocal
|
|
nsGkAtoms
:
:
video
=
=
aLocal
|
|
nsGkAtoms
:
:
audio
=
=
aLocal
|
|
nsGkAtoms
:
:
source
=
=
aLocal
)
)
{
return
true
;
}
if
(
nsGkAtoms
:
:
meta
=
=
aLocal
&
&
(
aElement
-
>
HasAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
charset
)
|
|
aElement
-
>
HasAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
httpEquiv
)
)
)
{
return
true
;
}
if
(
(
(
!
mFullDocument
&
&
nsGkAtoms
:
:
meta
=
=
aLocal
)
|
|
nsGkAtoms
:
:
link
=
=
aLocal
)
&
&
!
(
aElement
-
>
HasAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
itemprop
)
|
|
aElement
-
>
HasAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
itemscope
)
)
)
{
return
true
;
}
}
if
(
mAllowStyles
)
{
return
nsGkAtoms
:
:
style
=
=
aLocal
&
&
!
(
aNamespace
=
=
kNameSpaceID_XHTML
|
|
aNamespace
=
=
kNameSpaceID_SVG
)
;
}
if
(
nsGkAtoms
:
:
style
=
=
aLocal
)
{
return
true
;
}
return
false
;
}
enum
class
ElementKind
{
Regular
Custom
Unknown
}
;
static
ElementKind
GetElementKind
(
int32_t
aNamespace
nsAtom
*
aLocal
Element
*
aElement
)
{
if
(
nsContentUtils
:
:
IsCustomElementName
(
aLocal
kNameSpaceID_XHTML
)
)
{
return
ElementKind
:
:
Custom
;
}
if
(
aNamespace
!
=
kNameSpaceID_XHTML
)
{
return
ElementKind
:
:
Unknown
;
}
if
(
nsCOMPtr
<
HTMLUnknownElement
>
el
=
do_QueryInterface
(
aElement
)
)
{
return
ElementKind
:
:
Unknown
;
}
return
ElementKind
:
:
Regular
;
}
bool
nsTreeSanitizer
:
:
MustPruneForSanitizerAPI
(
int32_t
aNamespace
nsAtom
*
aLocal
Element
*
aElement
)
{
ElementKind
kind
=
GetElementKind
(
aNamespace
aLocal
aElement
)
;
switch
(
kind
)
{
case
ElementKind
:
:
Regular
:
if
(
!
sBaselineElementAllowlist
-
>
Contains
(
aLocal
)
)
{
return
true
;
}
break
;
case
ElementKind
:
:
Custom
:
if
(
!
mAllowCustomElements
)
{
return
true
;
}
break
;
case
ElementKind
:
:
Unknown
:
if
(
!
mAllowUnknownMarkup
)
{
return
true
;
}
break
;
}
if
(
mDropElements
&
&
mDropElements
-
>
Contains
(
aLocal
)
)
{
return
true
;
}
return
false
;
}
static
void
SanitizeStyleSheet
(
const
nsAString
&
aOriginal
nsAString
&
aSanitized
Document
*
aDocument
nsIURI
*
aBaseURI
StyleSanitizationKind
aSanitizationKind
)
{
aSanitized
.
Truncate
(
)
;
NS_ConvertUTF16toUTF8
style
(
aOriginal
)
;
RefPtr
<
nsIReferrerInfo
>
referrer
=
ReferrerInfo
:
:
CreateForInternalCSSResources
(
aDocument
)
;
auto
extraData
=
MakeRefPtr
<
URLExtraData
>
(
aBaseURI
referrer
aDocument
-
>
NodePrincipal
(
)
)
;
RefPtr
<
RawServoStyleSheetContents
>
contents
=
Servo_StyleSheet_FromUTF8Bytes
(
nullptr
nullptr
nullptr
&
style
css
:
:
SheetParsingMode
:
:
eAuthorSheetFeatures
extraData
.
get
(
)
0
aDocument
-
>
GetCompatibilityMode
(
)
nullptr
nullptr
StyleAllowImportRules
:
:
Yes
aSanitizationKind
&
aSanitized
)
.
Consume
(
)
;
}
bool
nsTreeSanitizer
:
:
SanitizeInlineStyle
(
Element
*
aElement
StyleSanitizationKind
aSanitizationKind
)
{
MOZ_ASSERT
(
aElement
)
;
MOZ_ASSERT
(
aElement
-
>
IsHTMLElement
(
nsGkAtoms
:
:
style
)
|
|
aElement
-
>
IsSVGElement
(
nsGkAtoms
:
:
style
)
)
;
nsAutoString
styleText
;
nsContentUtils
:
:
GetNodeTextContent
(
aElement
false
styleText
)
;
nsAutoString
sanitizedStyle
;
SanitizeStyleSheet
(
styleText
sanitizedStyle
aElement
-
>
OwnerDoc
(
)
aElement
-
>
GetBaseURI
(
)
StyleSanitizationKind
:
:
Standard
)
;
RemoveAllAttributesFromDescendants
(
aElement
)
;
nsContentUtils
:
:
SetNodeTextContent
(
aElement
sanitizedStyle
true
)
;
return
sanitizedStyle
.
Length
(
)
!
=
styleText
.
Length
(
)
;
}
void
nsTreeSanitizer
:
:
RemoveConditionalCSSFromSubtree
(
nsINode
*
aRoot
)
{
for
(
nsINode
*
node
:
ShadowIncludingTreeIterator
(
*
aRoot
)
)
{
if
(
!
node
-
>
IsHTMLElement
(
nsGkAtoms
:
:
style
)
&
&
!
node
-
>
IsSVGElement
(
nsGkAtoms
:
:
style
)
)
{
continue
;
}
SanitizeInlineStyle
(
node
-
>
AsElement
(
)
StyleSanitizationKind
:
:
NoConditionalRules
)
;
}
}
template
<
size_t
Len
>
static
bool
UTF16StringStartsWith
(
const
char16_t
*
aStr
uint32_t
aLength
const
char16_t
(
&
aNeedle
)
[
Len
]
)
{
MOZ_ASSERT
(
aNeedle
[
Len
-
1
]
=
=
'
\
0
'
"
needle
should
be
a
UTF
-
16
encoded
string
literal
"
)
;
if
(
aLength
<
Len
-
1
)
{
return
false
;
}
for
(
size_t
i
=
0
;
i
<
Len
-
1
;
i
+
+
)
{
if
(
aStr
[
i
]
!
=
aNeedle
[
i
]
)
{
return
false
;
}
}
return
true
;
}
void
nsTreeSanitizer
:
:
SanitizeAttributes
(
mozilla
:
:
dom
:
:
Element
*
aElement
AllowedAttributes
aAllowed
)
{
int32_t
ac
=
(
int
)
aElement
-
>
GetAttrCount
(
)
;
for
(
int32_t
i
=
ac
-
1
;
i
>
=
0
;
-
-
i
)
{
const
nsAttrName
*
attrName
=
aElement
-
>
GetAttrNameAt
(
i
)
;
int32_t
attrNs
=
attrName
-
>
NamespaceID
(
)
;
RefPtr
<
nsAtom
>
attrLocal
=
attrName
-
>
LocalName
(
)
;
if
(
mIsForSanitizerAPI
)
{
bool
shouldRemove
=
true
;
RefPtr
<
nsAtom
>
elemName
=
aElement
-
>
NodeInfo
(
)
-
>
NameAtom
(
)
;
if
(
mAllowedAttributes
)
{
auto
allowedElements
=
mAllowedAttributes
-
>
Lookup
(
attrLocal
)
;
if
(
allowedElements
)
{
if
(
allowedElements
.
Data
(
)
-
>
Contains
(
elemName
)
|
|
allowedElements
.
Data
(
)
-
>
Contains
(
nsGkAtoms
:
:
_asterisk
)
)
{
shouldRemove
=
false
;
}
}
}
if
(
mDroppedAttributes
)
{
auto
dropElements
=
mDroppedAttributes
-
>
Lookup
(
attrLocal
)
;
if
(
dropElements
)
{
if
(
dropElements
.
Data
(
)
-
>
Contains
(
elemName
)
|
|
dropElements
.
Data
(
)
-
>
Contains
(
nsGkAtoms
:
:
_asterisk
)
)
{
shouldRemove
=
true
;
}
}
}
if
(
shouldRemove
)
{
aElement
-
>
UnsetAttr
(
kNameSpaceID_None
attrLocal
false
)
;
if
(
mLogRemovals
)
{
LogMessage
(
"
Removed
unsafe
attribute
.
"
aElement
-
>
OwnerDoc
(
)
aElement
attrLocal
)
;
}
-
-
ac
;
i
=
ac
;
}
continue
;
}
if
(
kNameSpaceID_None
=
=
attrNs
)
{
if
(
aAllowed
.
mStyle
&
&
nsGkAtoms
:
:
style
=
=
attrLocal
)
{
continue
;
}
if
(
aAllowed
.
mDangerousSrc
&
&
nsGkAtoms
:
:
src
=
=
attrLocal
)
{
continue
;
}
if
(
IsURL
(
aAllowed
.
mURLs
attrLocal
)
)
{
bool
fragmentOnly
=
aElement
-
>
IsSVGElement
(
nsGkAtoms
:
:
use
)
;
if
(
SanitizeURL
(
aElement
attrNs
attrLocal
fragmentOnly
)
)
{
-
-
ac
;
i
=
ac
;
continue
;
}
}
if
(
!
mDropNonCSSPresentation
&
&
(
aAllowed
.
mNames
=
=
sAttributesHTML
)
&
&
sPresAttributesHTML
-
>
Contains
(
attrLocal
)
)
{
continue
;
}
if
(
aAllowed
.
mNames
-
>
Contains
(
attrLocal
)
&
&
!
(
(
attrLocal
=
=
nsGkAtoms
:
:
rel
&
&
aElement
-
>
IsHTMLElement
(
nsGkAtoms
:
:
link
)
)
|
|
(
!
mFullDocument
&
&
attrLocal
=
=
nsGkAtoms
:
:
name
&
&
aElement
-
>
IsHTMLElement
(
nsGkAtoms
:
:
meta
)
)
)
)
{
continue
;
}
const
char16_t
*
localStr
=
attrLocal
-
>
GetUTF16String
(
)
;
uint32_t
localLen
=
attrLocal
-
>
GetLength
(
)
;
if
(
UTF16StringStartsWith
(
localStr
localLen
u
"
_
"
)
|
|
UTF16StringStartsWith
(
localStr
localLen
u
"
data
-
"
)
|
|
UTF16StringStartsWith
(
localStr
localLen
u
"
aria
-
"
)
)
{
continue
;
}
}
else
if
(
kNameSpaceID_XML
=
=
attrNs
)
{
if
(
nsGkAtoms
:
:
lang
=
=
attrLocal
|
|
nsGkAtoms
:
:
space
=
=
attrLocal
)
{
continue
;
}
}
else
if
(
aAllowed
.
mXLink
&
&
kNameSpaceID_XLink
=
=
attrNs
)
{
if
(
nsGkAtoms
:
:
href
=
=
attrLocal
)
{
bool
fragmentOnly
=
aElement
-
>
IsSVGElement
(
nsGkAtoms
:
:
use
)
;
if
(
SanitizeURL
(
aElement
attrNs
attrLocal
fragmentOnly
)
)
{
-
-
ac
;
i
=
ac
;
}
continue
;
}
if
(
nsGkAtoms
:
:
type
=
=
attrLocal
|
|
nsGkAtoms
:
:
title
=
=
attrLocal
|
|
nsGkAtoms
:
:
show
=
=
attrLocal
|
|
nsGkAtoms
:
:
actuate
=
=
attrLocal
)
{
continue
;
}
}
aElement
-
>
UnsetAttr
(
kNameSpaceID_None
attrLocal
false
)
;
if
(
mLogRemovals
)
{
LogMessage
(
"
Removed
unsafe
attribute
.
"
aElement
-
>
OwnerDoc
(
)
aElement
attrLocal
)
;
}
-
-
ac
;
i
=
ac
;
}
if
(
aElement
-
>
IsAnyOfHTMLElements
(
nsGkAtoms
:
:
video
nsGkAtoms
:
:
audio
)
)
{
aElement
-
>
SetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
controls
u
"
"
_ns
false
)
;
}
}
bool
nsTreeSanitizer
:
:
SanitizeURL
(
mozilla
:
:
dom
:
:
Element
*
aElement
int32_t
aNamespace
nsAtom
*
aLocalName
bool
aFragmentsOnly
)
{
nsAutoString
value
;
aElement
-
>
GetAttr
(
aNamespace
aLocalName
value
)
;
static
const
char
*
kWhitespace
=
"
\
n
\
r
\
t
\
b
"
;
const
nsAString
&
v
=
nsContentUtils
:
:
TrimCharsInSet
(
kWhitespace
value
)
;
if
(
!
v
.
IsEmpty
(
)
&
&
v
.
First
(
)
=
=
u
'
#
'
)
{
return
false
;
}
if
(
aFragmentsOnly
)
{
aElement
-
>
UnsetAttr
(
aNamespace
aLocalName
false
)
;
if
(
mLogRemovals
)
{
LogMessage
(
"
Removed
unsafe
URI
from
element
attribute
.
"
aElement
-
>
OwnerDoc
(
)
aElement
aLocalName
)
;
}
return
true
;
}
nsIScriptSecurityManager
*
secMan
=
nsContentUtils
:
:
GetSecurityManager
(
)
;
uint32_t
flags
=
nsIScriptSecurityManager
:
:
DISALLOW_INHERIT_PRINCIPAL
;
nsCOMPtr
<
nsIURI
>
attrURI
;
nsresult
rv
=
NS_NewURI
(
getter_AddRefs
(
attrURI
)
v
nullptr
aElement
-
>
GetBaseURI
(
)
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
if
(
mCidEmbedsOnly
&
&
kNameSpaceID_None
=
=
aNamespace
)
{
if
(
nsGkAtoms
:
:
src
=
=
aLocalName
|
|
nsGkAtoms
:
:
background
=
=
aLocalName
)
{
if
(
!
(
v
.
Length
(
)
>
4
&
&
(
v
[
0
]
=
=
'
c
'
|
|
v
[
0
]
=
=
'
C
'
)
&
&
(
v
[
1
]
=
=
'
i
'
|
|
v
[
1
]
=
=
'
I
'
)
&
&
(
v
[
2
]
=
=
'
d
'
|
|
v
[
2
]
=
=
'
D
'
)
&
&
v
[
3
]
=
=
'
:
'
)
)
{
rv
=
NS_ERROR_FAILURE
;
}
}
else
if
(
nsGkAtoms
:
:
cdgroup_
=
=
aLocalName
|
|
nsGkAtoms
:
:
altimg_
=
=
aLocalName
|
|
nsGkAtoms
:
:
definitionURL_
=
=
aLocalName
)
{
rv
=
NS_ERROR_FAILURE
;
}
else
{
rv
=
secMan
-
>
CheckLoadURIWithPrincipal
(
sNullPrincipal
attrURI
flags
0
)
;
}
}
else
{
rv
=
secMan
-
>
CheckLoadURIWithPrincipal
(
sNullPrincipal
attrURI
flags
0
)
;
}
}
if
(
NS_FAILED
(
rv
)
)
{
aElement
-
>
UnsetAttr
(
aNamespace
aLocalName
false
)
;
if
(
mLogRemovals
)
{
LogMessage
(
"
Removed
unsafe
URI
from
element
attribute
.
"
aElement
-
>
OwnerDoc
(
)
aElement
aLocalName
)
;
}
return
true
;
}
return
false
;
}
void
nsTreeSanitizer
:
:
Sanitize
(
DocumentFragment
*
aFragment
)
{
MOZ_ASSERT
(
!
aFragment
-
>
IsInUncomposedDoc
(
)
"
The
fragment
is
in
doc
?
"
)
;
mFullDocument
=
false
;
SanitizeChildren
(
aFragment
)
;
}
void
nsTreeSanitizer
:
:
Sanitize
(
Document
*
aDocument
)
{
#
ifdef
DEBUG
MOZ_ASSERT
(
!
aDocument
-
>
GetContainer
(
)
"
The
document
is
in
a
shell
.
"
)
;
RefPtr
<
mozilla
:
:
dom
:
:
Element
>
root
=
aDocument
-
>
GetRootElement
(
)
;
MOZ_ASSERT
(
root
-
>
IsHTMLElement
(
nsGkAtoms
:
:
html
)
"
Not
HTML
root
.
"
)
;
#
endif
mFullDocument
=
true
;
SanitizeChildren
(
aDocument
)
;
}
void
nsTreeSanitizer
:
:
SanitizeChildren
(
nsINode
*
aRoot
)
{
nsIContent
*
node
=
aRoot
-
>
GetFirstChild
(
)
;
while
(
node
)
{
if
(
node
-
>
IsElement
(
)
)
{
mozilla
:
:
dom
:
:
Element
*
elt
=
node
-
>
AsElement
(
)
;
mozilla
:
:
dom
:
:
NodeInfo
*
nodeInfo
=
node
-
>
NodeInfo
(
)
;
nsAtom
*
localName
=
nodeInfo
-
>
NameAtom
(
)
;
int32_t
ns
=
nodeInfo
-
>
NamespaceID
(
)
;
if
(
MustPrune
(
ns
localName
elt
)
)
{
if
(
mLogRemovals
)
{
LogMessage
(
"
Removing
unsafe
node
.
"
elt
-
>
OwnerDoc
(
)
elt
)
;
}
RemoveAllAttributes
(
elt
)
;
nsIContent
*
descendant
=
node
;
while
(
(
descendant
=
descendant
-
>
GetNextNode
(
node
)
)
)
{
if
(
descendant
-
>
IsElement
(
)
)
{
RemoveAllAttributes
(
descendant
-
>
AsElement
(
)
)
;
}
}
nsIContent
*
next
=
node
-
>
GetNextNonChildNode
(
aRoot
)
;
node
-
>
RemoveFromParent
(
)
;
node
=
next
;
continue
;
}
if
(
auto
*
templateEl
=
HTMLTemplateElement
:
:
FromNode
(
elt
)
)
{
bool
wasFullDocument
=
mFullDocument
;
mFullDocument
=
false
;
RefPtr
<
DocumentFragment
>
frag
=
templateEl
-
>
Content
(
)
;
SanitizeChildren
(
frag
)
;
mFullDocument
=
wasFullDocument
;
}
if
(
!
mIsForSanitizerAPI
&
&
nsGkAtoms
:
:
style
=
=
localName
)
{
NS_ASSERTION
(
ns
=
=
kNameSpaceID_XHTML
|
|
ns
=
=
kNameSpaceID_SVG
"
Should
have
only
HTML
or
SVG
here
!
"
)
;
if
(
SanitizeInlineStyle
(
elt
StyleSanitizationKind
:
:
Standard
)
&
&
mLogRemovals
)
{
LogMessage
(
"
Removed
some
rules
and
/
or
properties
from
stylesheet
.
"
aRoot
-
>
OwnerDoc
(
)
)
;
}
AllowedAttributes
allowed
;
allowed
.
mStyle
=
mAllowStyles
;
if
(
ns
=
=
kNameSpaceID_XHTML
)
{
allowed
.
mNames
=
sAttributesHTML
;
allowed
.
mURLs
=
kURLAttributesHTML
;
}
else
{
allowed
.
mNames
=
sAttributesSVG
;
allowed
.
mURLs
=
kURLAttributesSVG
;
allowed
.
mXLink
=
true
;
}
SanitizeAttributes
(
elt
allowed
)
;
node
=
node
-
>
GetNextNonChildNode
(
aRoot
)
;
continue
;
}
if
(
MustFlatten
(
ns
localName
)
)
{
if
(
mLogRemovals
)
{
LogMessage
(
"
Flattening
unsafe
node
(
descendants
are
preserved
)
.
"
elt
-
>
OwnerDoc
(
)
elt
)
;
}
RemoveAllAttributes
(
elt
)
;
nsCOMPtr
<
nsIContent
>
next
=
node
-
>
GetNextNode
(
aRoot
)
;
nsCOMPtr
<
nsIContent
>
parent
=
node
-
>
GetParent
(
)
;
nsCOMPtr
<
nsIContent
>
child
;
ErrorResult
rv
;
while
(
(
child
=
node
-
>
GetFirstChild
(
)
)
)
{
nsCOMPtr
<
nsINode
>
refNode
=
node
;
parent
-
>
InsertBefore
(
*
child
refNode
rv
)
;
if
(
rv
.
Failed
(
)
)
{
break
;
}
}
node
-
>
RemoveFromParent
(
)
;
node
=
next
;
continue
;
}
NS_ASSERTION
(
ns
=
=
kNameSpaceID_XHTML
|
|
ns
=
=
kNameSpaceID_SVG
|
|
ns
=
=
kNameSpaceID_MathML
"
Should
have
only
HTML
MathML
or
SVG
here
!
"
)
;
AllowedAttributes
allowed
;
if
(
ns
=
=
kNameSpaceID_XHTML
)
{
allowed
.
mNames
=
sAttributesHTML
;
allowed
.
mURLs
=
kURLAttributesHTML
;
allowed
.
mStyle
=
mAllowStyles
;
allowed
.
mDangerousSrc
=
nsGkAtoms
:
:
img
=
=
localName
&
&
!
mCidEmbedsOnly
;
SanitizeAttributes
(
elt
allowed
)
;
}
else
if
(
ns
=
=
kNameSpaceID_SVG
)
{
allowed
.
mNames
=
sAttributesSVG
;
allowed
.
mURLs
=
kURLAttributesSVG
;
allowed
.
mXLink
=
true
;
allowed
.
mStyle
=
mAllowStyles
;
SanitizeAttributes
(
elt
allowed
)
;
}
else
{
allowed
.
mNames
=
sAttributesMathML
;
allowed
.
mURLs
=
kURLAttributesMathML
;
allowed
.
mXLink
=
true
;
SanitizeAttributes
(
elt
allowed
)
;
}
node
=
node
-
>
GetNextNode
(
aRoot
)
;
continue
;
}
NS_ASSERTION
(
!
node
-
>
GetFirstChild
(
)
"
How
come
non
-
element
node
had
kids
?
"
)
;
nsIContent
*
next
=
node
-
>
GetNextNonChildNode
(
aRoot
)
;
if
(
!
mAllowComments
&
&
node
-
>
IsComment
(
)
)
{
node
-
>
RemoveFromParent
(
)
;
}
node
=
next
;
}
}
void
nsTreeSanitizer
:
:
RemoveAllAttributes
(
Element
*
aElement
)
{
const
nsAttrName
*
attrName
;
while
(
(
attrName
=
aElement
-
>
GetAttrNameAt
(
0
)
)
)
{
int32_t
attrNs
=
attrName
-
>
NamespaceID
(
)
;
RefPtr
<
nsAtom
>
attrLocal
=
attrName
-
>
LocalName
(
)
;
aElement
-
>
UnsetAttr
(
attrNs
attrLocal
false
)
;
}
}
void
nsTreeSanitizer
:
:
RemoveAllAttributesFromDescendants
(
mozilla
:
:
dom
:
:
Element
*
aElement
)
{
nsIContent
*
node
=
aElement
-
>
GetFirstChild
(
)
;
while
(
node
)
{
if
(
node
-
>
IsElement
(
)
)
{
mozilla
:
:
dom
:
:
Element
*
elt
=
node
-
>
AsElement
(
)
;
RemoveAllAttributes
(
elt
)
;
}
node
=
node
-
>
GetNextNode
(
aElement
)
;
}
}
void
nsTreeSanitizer
:
:
LogMessage
(
const
char
*
aMessage
Document
*
aDoc
Element
*
aElement
nsAtom
*
aAttr
)
{
if
(
mLogRemovals
)
{
nsAutoString
msg
;
msg
.
Assign
(
NS_ConvertASCIItoUTF16
(
aMessage
)
)
;
if
(
aElement
)
{
msg
.
Append
(
u
"
Element
:
"
_ns
+
aElement
-
>
LocalName
(
)
+
u
"
.
"
_ns
)
;
}
if
(
aAttr
)
{
msg
.
Append
(
u
"
Attribute
:
"
_ns
+
nsDependentAtomString
(
aAttr
)
+
u
"
.
"
_ns
)
;
}
nsContentUtils
:
:
ReportToConsoleNonLocalized
(
msg
nsIScriptError
:
:
warningFlag
"
DOM
"
_ns
aDoc
)
;
}
}
void
nsTreeSanitizer
:
:
InitializeStatics
(
)
{
MOZ_ASSERT
(
!
sElementsHTML
"
Initializing
a
second
time
.
"
)
;
sElementsHTML
=
new
AtomsTable
(
ArrayLength
(
kElementsHTML
)
)
;
for
(
uint32_t
i
=
0
;
kElementsHTML
[
i
]
;
i
+
+
)
{
sElementsHTML
-
>
Insert
(
kElementsHTML
[
i
]
)
;
}
sAttributesHTML
=
new
AtomsTable
(
ArrayLength
(
kAttributesHTML
)
)
;
for
(
uint32_t
i
=
0
;
kAttributesHTML
[
i
]
;
i
+
+
)
{
sAttributesHTML
-
>
Insert
(
kAttributesHTML
[
i
]
)
;
}
sPresAttributesHTML
=
new
AtomsTable
(
ArrayLength
(
kPresAttributesHTML
)
)
;
for
(
uint32_t
i
=
0
;
kPresAttributesHTML
[
i
]
;
i
+
+
)
{
sPresAttributesHTML
-
>
Insert
(
kPresAttributesHTML
[
i
]
)
;
}
sElementsSVG
=
new
AtomsTable
(
ArrayLength
(
kElementsSVG
)
)
;
for
(
uint32_t
i
=
0
;
kElementsSVG
[
i
]
;
i
+
+
)
{
sElementsSVG
-
>
Insert
(
kElementsSVG
[
i
]
)
;
}
sAttributesSVG
=
new
AtomsTable
(
ArrayLength
(
kAttributesSVG
)
)
;
for
(
uint32_t
i
=
0
;
kAttributesSVG
[
i
]
;
i
+
+
)
{
sAttributesSVG
-
>
Insert
(
kAttributesSVG
[
i
]
)
;
}
sElementsMathML
=
new
AtomsTable
(
ArrayLength
(
kElementsMathML
)
)
;
for
(
uint32_t
i
=
0
;
kElementsMathML
[
i
]
;
i
+
+
)
{
sElementsMathML
-
>
Insert
(
kElementsMathML
[
i
]
)
;
}
sAttributesMathML
=
new
AtomsTable
(
ArrayLength
(
kAttributesMathML
)
)
;
for
(
uint32_t
i
=
0
;
kAttributesMathML
[
i
]
;
i
+
+
)
{
sAttributesMathML
-
>
Insert
(
kAttributesMathML
[
i
]
)
;
}
sBaselineElementAllowlist
=
new
AtomsTable
(
ArrayLength
(
kBaselineElementAllowlist
)
)
;
for
(
const
auto
*
atom
:
kBaselineElementAllowlist
)
{
sBaselineElementAllowlist
-
>
Insert
(
atom
)
;
}
sDefaultConfigurationElementAllowlist
=
new
AtomsTable
(
ArrayLength
(
kDefaultConfigurationElementAllowlist
)
)
;
for
(
const
auto
*
atom
:
kDefaultConfigurationElementAllowlist
)
{
sDefaultConfigurationElementAllowlist
-
>
Insert
(
atom
)
;
}
nsCOMPtr
<
nsIPrincipal
>
principal
=
NullPrincipal
:
:
CreateWithoutOriginAttributes
(
)
;
principal
.
forget
(
&
sNullPrincipal
)
;
}
void
nsTreeSanitizer
:
:
ReleaseStatics
(
)
{
delete
sElementsHTML
;
sElementsHTML
=
nullptr
;
delete
sAttributesHTML
;
sAttributesHTML
=
nullptr
;
delete
sPresAttributesHTML
;
sPresAttributesHTML
=
nullptr
;
delete
sElementsSVG
;
sElementsSVG
=
nullptr
;
delete
sAttributesSVG
;
sAttributesSVG
=
nullptr
;
delete
sElementsMathML
;
sElementsMathML
=
nullptr
;
delete
sAttributesMathML
;
sAttributesMathML
=
nullptr
;
delete
sBaselineElementAllowlist
;
sBaselineElementAllowlist
=
nullptr
;
delete
sDefaultConfigurationElementAllowlist
;
sDefaultConfigurationElementAllowlist
=
nullptr
;
NS_IF_RELEASE
(
sNullPrincipal
)
;
}
void
nsTreeSanitizer
:
:
WithWebSanitizerOptions
(
const
mozilla
:
:
dom
:
:
SanitizerConfig
&
aOptions
)
{
if
(
!
StaticPrefs
:
:
dom_security_sanitizer_rewrite_no_bounty
(
)
)
{
return
;
}
mIsForSanitizerAPI
=
true
;
if
(
aOptions
.
mAllowComments
.
WasPassed
(
)
)
{
mAllowComments
=
aOptions
.
mAllowComments
.
Value
(
)
;
}
if
(
aOptions
.
mAllowCustomElements
.
WasPassed
(
)
)
{
mAllowCustomElements
=
aOptions
.
mAllowCustomElements
.
Value
(
)
;
}
if
(
aOptions
.
mAllowUnknownMarkup
.
WasPassed
(
)
)
{
mAllowUnknownMarkup
=
aOptions
.
mAllowUnknownMarkup
.
Value
(
)
;
}
if
(
aOptions
.
mAllowElements
.
WasPassed
(
)
)
{
const
Sequence
<
nsString
>
&
allowedElements
=
aOptions
.
mAllowElements
.
Value
(
)
;
mAllowElements
=
MakeUnique
<
DynamicAtomsTable
>
(
allowedElements
.
Length
(
)
)
;
for
(
const
nsString
&
elem
:
allowedElements
)
{
nsAutoString
lowercaseElem
;
nsContentUtils
:
:
ASCIIToLower
(
elem
lowercaseElem
)
;
RefPtr
<
nsAtom
>
elAsAtom
=
NS_AtomizeMainThread
(
lowercaseElem
)
;
mAllowElements
-
>
Insert
(
elAsAtom
)
;
}
}
if
(
aOptions
.
mBlockElements
.
WasPassed
(
)
)
{
const
Sequence
<
nsString
>
&
blockedElements
=
aOptions
.
mBlockElements
.
Value
(
)
;
mBlockElements
=
MakeUnique
<
DynamicAtomsTable
>
(
blockedElements
.
Length
(
)
)
;
for
(
const
nsString
&
elem
:
blockedElements
)
{
nsAutoString
lowercaseElem
;
nsContentUtils
:
:
ASCIIToLower
(
elem
lowercaseElem
)
;
RefPtr
<
nsAtom
>
elAsAtom
=
NS_AtomizeMainThread
(
lowercaseElem
)
;
mBlockElements
-
>
Insert
(
elAsAtom
)
;
}
}
if
(
aOptions
.
mDropElements
.
WasPassed
(
)
)
{
const
Sequence
<
nsString
>
&
dropElements
=
aOptions
.
mDropElements
.
Value
(
)
;
mDropElements
=
MakeUnique
<
DynamicAtomsTable
>
(
dropElements
.
Length
(
)
)
;
for
(
const
nsString
&
elem
:
dropElements
)
{
nsAutoString
lowercaseElem
;
nsContentUtils
:
:
ASCIIToLower
(
elem
lowercaseElem
)
;
RefPtr
<
nsAtom
>
elAsAtom
=
NS_AtomizeMainThread
(
lowercaseElem
)
;
mDropElements
-
>
Insert
(
elAsAtom
)
;
}
}
if
(
aOptions
.
mAllowAttributes
.
WasPassed
(
)
)
{
const
Record
<
nsString
Sequence
<
nsString
>
>
&
allowedAttributes
=
aOptions
.
mAllowAttributes
.
Value
(
)
;
mAllowedAttributes
=
MakeUnique
<
ElementToAttributeSetTable
>
(
)
;
nsAutoString
name
;
for
(
const
auto
&
entries
:
allowedAttributes
.
Entries
(
)
)
{
UniquePtr
<
DynamicAtomsTable
>
elems
=
MakeUnique
<
DynamicAtomsTable
>
(
allowedAttributes
.
Entries
(
)
.
Length
(
)
)
;
for
(
const
auto
&
elem
:
entries
.
mValue
)
{
nsAutoString
lowercaseElem
;
nsContentUtils
:
:
ASCIIToLower
(
elem
lowercaseElem
)
;
RefPtr
<
nsAtom
>
elAsAtom
=
NS_Atomize
(
lowercaseElem
)
;
elems
-
>
Insert
(
elAsAtom
)
;
}
nsAutoString
attrName
;
nsContentUtils
:
:
ASCIIToLower
(
entries
.
mKey
attrName
)
;
RefPtr
<
nsAtom
>
attrAtom
=
NS_Atomize
(
attrName
)
;
mAllowedAttributes
-
>
InsertOrUpdate
(
attrAtom
std
:
:
move
(
elems
)
)
;
}
}
if
(
aOptions
.
mDropAttributes
.
WasPassed
(
)
)
{
const
Record
<
nsString
Sequence
<
nsString
>
>
&
droppedAttributes
=
aOptions
.
mDropAttributes
.
Value
(
)
;
mDroppedAttributes
=
MakeUnique
<
ElementToAttributeSetTable
>
(
)
;
nsAutoString
name
;
for
(
const
auto
&
entries
:
droppedAttributes
.
Entries
(
)
)
{
UniquePtr
<
DynamicAtomsTable
>
elems
=
MakeUnique
<
DynamicAtomsTable
>
(
droppedAttributes
.
Entries
(
)
.
Length
(
)
)
;
for
(
const
auto
&
elem
:
entries
.
mValue
)
{
nsAutoString
lowercaseElem
;
nsContentUtils
:
:
ASCIIToLower
(
elem
lowercaseElem
)
;
RefPtr
<
nsAtom
>
elAsAtom
=
NS_Atomize
(
lowercaseElem
)
;
elems
-
>
Insert
(
elAsAtom
)
;
}
nsAutoString
attrName
;
nsContentUtils
:
:
ASCIIToLower
(
entries
.
mKey
attrName
)
;
RefPtr
<
nsAtom
>
attrAtom
=
NS_Atomize
(
attrName
)
;
mDroppedAttributes
-
>
InsertOrUpdate
(
attrAtom
std
:
:
move
(
elems
)
)
;
}
}
}
