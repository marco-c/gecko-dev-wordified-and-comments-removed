#
ifndef
NSOBJECTLOADINGCONTENT_H_
#
define
NSOBJECTLOADINGCONTENT_H_
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
dom
/
BindingDeclarations
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsImageLoadingContent
.
h
"
#
include
"
nsIStreamListener
.
h
"
#
include
"
nsIChannelEventSink
.
h
"
#
include
"
nsIObjectLoadingContent
.
h
"
#
include
"
nsIRunnable
.
h
"
#
include
"
nsFrameLoaderOwner
.
h
"
class
nsAsyncInstantiateEvent
;
class
nsStopPluginRunnable
;
class
AutoSetInstantiatingToFalse
;
class
nsIPrincipal
;
class
nsFrameLoader
;
namespace
mozilla
:
:
dom
{
struct
BindContext
;
template
<
typename
T
>
class
Sequence
;
struct
MozPluginParameter
;
class
HTMLIFrameElement
;
template
<
typename
T
>
struct
Nullable
;
class
WindowProxyHolder
;
class
XULFrameElement
;
}
class
nsObjectLoadingContent
:
public
nsImageLoadingContent
public
nsIStreamListener
public
nsFrameLoaderOwner
public
nsIObjectLoadingContent
public
nsIChannelEventSink
{
friend
class
AutoSetInstantiatingToFalse
;
friend
class
AutoSetLoadingToFalse
;
friend
class
CheckPluginStopEvent
;
friend
class
nsStopPluginRunnable
;
friend
class
nsAsyncInstantiateEvent
;
public
:
enum
ObjectType
{
eType_Loading
=
TYPE_LOADING
eType_Image
=
TYPE_IMAGE
eType_Fallback
=
TYPE_FALLBACK
eType_FakePlugin
=
TYPE_FAKE_PLUGIN
eType_Document
=
TYPE_DOCUMENT
eType_Null
=
TYPE_NULL
}
;
nsObjectLoadingContent
(
)
;
virtual
~
nsObjectLoadingContent
(
)
;
NS_DECL_NSIREQUESTOBSERVER
NS_DECL_NSISTREAMLISTENER
NS_DECL_NSIOBJECTLOADINGCONTENT
NS_DECL_NSICHANNELEVENTSINK
mozilla
:
:
dom
:
:
ElementState
ObjectState
(
)
const
;
ObjectType
Type
(
)
const
{
return
mType
;
}
void
SetIsNetworkCreated
(
bool
aNetworkCreated
)
{
mNetworkCreated
=
aNetworkCreated
;
}
void
GetPluginAttributes
(
nsTArray
<
mozilla
:
:
dom
:
:
MozPluginParameter
>
&
aAttributes
)
;
void
GetPluginParameters
(
nsTArray
<
mozilla
:
:
dom
:
:
MozPluginParameter
>
&
aParameters
)
;
nsresult
InstantiatePluginInstance
(
bool
aIsLoading
=
false
)
;
void
NotifyOwnerDocumentActivityChanged
(
)
;
bool
DoResolve
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aObject
JS
:
:
Handle
<
jsid
>
aId
JS
:
:
MutableHandle
<
mozilla
:
:
Maybe
<
JS
:
:
PropertyDescriptor
>
>
aDesc
)
;
static
bool
MayResolve
(
jsid
aId
)
;
static
bool
IsSuccessfulRequest
(
nsIRequest
*
nsresult
*
aStatus
)
;
void
GetOwnPropertyNames
(
JSContext
*
aCx
JS
:
:
MutableHandleVector
<
jsid
>
bool
mozilla
:
:
ErrorResult
&
aRv
)
;
mozilla
:
:
dom
:
:
Document
*
GetContentDocument
(
nsIPrincipal
&
aSubjectPrincipal
)
;
void
GetActualType
(
nsAString
&
aType
)
const
{
CopyUTF8toUTF16
(
mContentType
aType
)
;
}
uint32_t
DisplayedType
(
)
const
{
return
mType
;
}
uint32_t
GetContentTypeForMIMEType
(
const
nsAString
&
aMIMEType
)
{
return
GetTypeOfContent
(
NS_ConvertUTF16toUTF8
(
aMIMEType
)
false
)
;
}
void
Reload
(
bool
aClearActivation
mozilla
:
:
ErrorResult
&
aRv
)
{
aRv
=
Reload
(
aClearActivation
)
;
}
nsIURI
*
GetSrcURI
(
)
const
{
return
mURI
;
}
void
SkipFakePlugins
(
mozilla
:
:
ErrorResult
&
aRv
)
{
aRv
=
SkipFakePlugins
(
)
;
}
void
SwapFrameLoaders
(
mozilla
:
:
dom
:
:
HTMLIFrameElement
&
aOtherLoaderOwner
mozilla
:
:
ErrorResult
&
aRv
)
{
aRv
.
Throw
(
NS_ERROR_NOT_IMPLEMENTED
)
;
}
void
SwapFrameLoaders
(
mozilla
:
:
dom
:
:
XULFrameElement
&
aOtherLoaderOwner
mozilla
:
:
ErrorResult
&
aRv
)
{
aRv
.
Throw
(
NS_ERROR_NOT_IMPLEMENTED
)
;
}
uint32_t
GetRunID
(
mozilla
:
:
dom
:
:
SystemCallerGuarantee
mozilla
:
:
ErrorResult
&
aRv
)
;
bool
IsRewrittenYoutubeEmbed
(
)
const
{
return
mRewrittenYoutubeEmbed
;
}
void
PresetOpenerWindow
(
const
mozilla
:
:
dom
:
:
Nullable
<
mozilla
:
:
dom
:
:
WindowProxyHolder
>
&
aOpenerWindow
mozilla
:
:
ErrorResult
&
aRv
)
;
const
mozilla
:
:
Maybe
<
mozilla
:
:
IntrinsicSize
>
&
GetSubdocumentIntrinsicSize
(
)
const
{
return
mSubdocumentIntrinsicSize
;
}
const
mozilla
:
:
Maybe
<
mozilla
:
:
AspectRatio
>
&
GetSubdocumentIntrinsicRatio
(
)
const
{
return
mSubdocumentIntrinsicRatio
;
}
void
SubdocumentIntrinsicSizeOrRatioChanged
(
const
mozilla
:
:
Maybe
<
mozilla
:
:
IntrinsicSize
>
&
aIntrinsicSize
const
mozilla
:
:
Maybe
<
mozilla
:
:
AspectRatio
>
&
aIntrinsicRatio
)
;
protected
:
nsresult
LoadObject
(
bool
aNotify
bool
aForceLoad
=
false
)
;
enum
Capabilities
{
eSupportImages
=
1u
<
<
0
eSupportPlugins
=
1u
<
<
1
eSupportDocuments
=
1u
<
<
2
eFallbackIfClassIDPresent
=
1u
<
<
3
eAllowPluginSkipChannel
=
1u
<
<
4
}
;
virtual
uint32_t
GetCapabilities
(
)
const
;
void
Destroy
(
)
;
static
void
Traverse
(
nsObjectLoadingContent
*
tmp
nsCycleCollectionTraversalCallback
&
cb
)
;
static
void
Unlink
(
nsObjectLoadingContent
*
tmp
)
;
void
CreateStaticClone
(
nsObjectLoadingContent
*
aDest
)
const
;
nsresult
BindToTree
(
mozilla
:
:
dom
:
:
BindContext
&
aCxt
nsINode
&
aParent
)
{
nsImageLoadingContent
:
:
BindToTree
(
aCxt
aParent
)
;
return
NS_OK
;
}
void
UnbindFromTree
(
bool
aNullParent
=
true
)
;
virtual
nsContentPolicyType
GetContentPolicyType
(
)
const
=
0
;
bool
BlockEmbedOrObjectContentLoading
(
)
;
private
:
enum
ParameterUpdateFlags
{
eParamNoChange
=
0
eParamChannelChanged
=
1u
<
<
0
eParamStateChanged
=
1u
<
<
1
eParamContentTypeChanged
=
1u
<
<
2
}
;
void
GetNestedParams
(
nsTArray
<
mozilla
:
:
dom
:
:
MozPluginParameter
>
&
aParameters
)
;
[
[
nodiscard
]
]
nsresult
BuildParametersArray
(
)
;
void
ConfigureFallback
(
)
;
nsresult
LoadObject
(
bool
aNotify
bool
aForceLoad
nsIRequest
*
aLoadingChannel
)
;
ParameterUpdateFlags
UpdateObjectParameters
(
)
;
void
QueueCheckPluginStopEvent
(
)
;
public
:
bool
IsAboutBlankLoadOntoInitialAboutBlank
(
nsIURI
*
aURI
bool
aInheritPrincipal
nsIPrincipal
*
aPrincipalToInherit
)
;
private
:
nsresult
OpenChannel
(
)
;
nsresult
CloseChannel
(
)
;
bool
ShouldBlockContent
(
)
;
bool
PreferFallback
(
bool
aIsPluginClickToPlay
)
;
bool
CheckLoadPolicy
(
int16_t
*
aContentPolicy
)
;
bool
CheckProcessPolicy
(
int16_t
*
aContentPolicy
)
;
void
SetupFrameLoader
(
int32_t
aJSPluginId
)
;
already_AddRefed
<
nsIDocShell
>
SetupDocShell
(
nsIURI
*
aRecursionCheckURI
)
;
void
UnloadObject
(
bool
aResetState
=
true
)
;
void
NotifyStateChanged
(
ObjectType
aOldType
mozilla
:
:
dom
:
:
ElementState
aOldState
bool
aNotify
)
;
ObjectType
GetTypeOfContent
(
const
nsCString
&
aMIMEType
bool
aNoFakePlugin
)
;
void
MaybeRewriteYoutubeEmbed
(
nsIURI
*
aURI
nsIURI
*
aBaseURI
nsIURI
*
*
aRewrittenURI
)
;
void
MaybeFireErrorEvent
(
)
;
void
MaybeStoreCrossOriginFeaturePolicy
(
)
;
nsCOMPtr
<
nsIStreamListener
>
mFinalListener
;
nsCOMPtr
<
nsIRunnable
>
mPendingInstantiateEvent
;
nsCOMPtr
<
nsIRunnable
>
mPendingCheckPluginStopEvent
;
nsCString
mContentType
;
nsCString
mOriginalContentType
;
nsCOMPtr
<
nsIChannel
>
mChannel
;
nsCOMPtr
<
nsIURI
>
mURI
;
nsCOMPtr
<
nsIURI
>
mOriginalURI
;
nsCOMPtr
<
nsIURI
>
mBaseURI
;
ObjectType
mType
:
8
;
uint32_t
mRunID
;
bool
mHasRunID
:
1
;
bool
mChannelLoaded
:
1
;
bool
mInstantiating
:
1
;
bool
mNetworkCreated
:
1
;
bool
mContentBlockingEnabled
:
1
;
bool
mSkipFakePlugins
:
1
;
bool
mIsStopping
:
1
;
bool
mIsLoading
:
1
;
bool
mScriptRequested
:
1
;
bool
mRewrittenYoutubeEmbed
:
1
;
nsTArray
<
mozilla
:
:
dom
:
:
MozPluginParameter
>
mCachedAttributes
;
nsTArray
<
mozilla
:
:
dom
:
:
MozPluginParameter
>
mCachedParameters
;
mozilla
:
:
Maybe
<
mozilla
:
:
IntrinsicSize
>
mSubdocumentIntrinsicSize
;
mozilla
:
:
Maybe
<
mozilla
:
:
AspectRatio
>
mSubdocumentIntrinsicRatio
;
}
;
#
endif
