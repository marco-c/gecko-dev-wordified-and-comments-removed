#
include
"
nsIGlobalObject
.
h
"
#
include
"
mozilla
/
dom
/
ServiceWorker
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
nsHostObjectProtocolHandler
.
h
"
using
mozilla
:
:
Maybe
;
using
mozilla
:
:
dom
:
:
ClientInfo
;
using
mozilla
:
:
dom
:
:
ServiceWorker
;
using
mozilla
:
:
dom
:
:
ServiceWorkerDescriptor
;
nsIGlobalObject
:
:
~
nsIGlobalObject
(
)
{
UnlinkHostObjectURIs
(
)
;
}
nsIPrincipal
*
nsIGlobalObject
:
:
PrincipalOrNull
(
)
{
JSObject
*
global
=
GetGlobalJSObject
(
)
;
if
(
NS_WARN_IF
(
!
global
)
)
return
nullptr
;
return
nsContentUtils
:
:
ObjectPrincipal
(
global
)
;
}
void
nsIGlobalObject
:
:
RegisterHostObjectURI
(
const
nsACString
&
aURI
)
{
MOZ_ASSERT
(
!
mHostObjectURIs
.
Contains
(
aURI
)
)
;
mHostObjectURIs
.
AppendElement
(
aURI
)
;
}
void
nsIGlobalObject
:
:
UnregisterHostObjectURI
(
const
nsACString
&
aURI
)
{
mHostObjectURIs
.
RemoveElement
(
aURI
)
;
}
namespace
{
class
UnlinkHostObjectURIsRunnable
final
:
public
mozilla
:
:
Runnable
{
public
:
explicit
UnlinkHostObjectURIsRunnable
(
nsTArray
<
nsCString
>
&
aURIs
)
:
mozilla
:
:
Runnable
(
"
UnlinkHostObjectURIsRunnable
"
)
{
mURIs
.
SwapElements
(
aURIs
)
;
}
NS_IMETHOD
Run
(
)
override
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
for
(
uint32_t
index
=
0
;
index
<
mURIs
.
Length
(
)
;
+
+
index
)
{
nsHostObjectProtocolHandler
:
:
RemoveDataEntry
(
mURIs
[
index
]
)
;
}
return
NS_OK
;
}
private
:
~
UnlinkHostObjectURIsRunnable
(
)
{
}
nsTArray
<
nsCString
>
mURIs
;
}
;
}
void
nsIGlobalObject
:
:
UnlinkHostObjectURIs
(
)
{
if
(
mHostObjectURIs
.
IsEmpty
(
)
)
{
return
;
}
if
(
NS_IsMainThread
(
)
)
{
for
(
uint32_t
index
=
0
;
index
<
mHostObjectURIs
.
Length
(
)
;
+
+
index
)
{
nsHostObjectProtocolHandler
:
:
RemoveDataEntry
(
mHostObjectURIs
[
index
]
)
;
}
mHostObjectURIs
.
Clear
(
)
;
return
;
}
RefPtr
<
UnlinkHostObjectURIsRunnable
>
runnable
=
new
UnlinkHostObjectURIsRunnable
(
mHostObjectURIs
)
;
MOZ_ASSERT
(
mHostObjectURIs
.
IsEmpty
(
)
)
;
nsresult
rv
=
NS_DispatchToMainThread
(
runnable
)
;
if
(
NS_FAILED
(
rv
)
)
{
NS_WARNING
(
"
Failed
to
dispatch
a
runnable
to
the
main
-
thread
.
"
)
;
}
}
void
nsIGlobalObject
:
:
TraverseHostObjectURIs
(
nsCycleCollectionTraversalCallback
&
aCb
)
{
if
(
mHostObjectURIs
.
IsEmpty
(
)
)
{
return
;
}
if
(
!
NS_IsMainThread
(
)
)
{
return
;
}
for
(
uint32_t
index
=
0
;
index
<
mHostObjectURIs
.
Length
(
)
;
+
+
index
)
{
nsHostObjectProtocolHandler
:
:
Traverse
(
mHostObjectURIs
[
index
]
aCb
)
;
}
}
Maybe
<
ClientInfo
>
nsIGlobalObject
:
:
GetClientInfo
(
)
const
{
return
Maybe
<
ClientInfo
>
(
)
;
}
Maybe
<
ServiceWorkerDescriptor
>
nsIGlobalObject
:
:
GetController
(
)
const
{
return
Maybe
<
ServiceWorkerDescriptor
>
(
)
;
}
RefPtr
<
ServiceWorker
>
nsIGlobalObject
:
:
GetOrCreateServiceWorker
(
const
ServiceWorkerDescriptor
&
aDescriptor
)
{
MOZ_DIAGNOSTIC_ASSERT
(
false
"
this
global
should
not
have
any
service
workers
"
)
;
return
nullptr
;
}
void
nsIGlobalObject
:
:
AddServiceWorker
(
ServiceWorker
*
aServiceWorker
)
{
MOZ_DIAGNOSTIC_ASSERT
(
false
"
this
global
should
not
have
any
service
workers
"
)
;
}
void
nsIGlobalObject
:
:
RemoveServiceWorker
(
ServiceWorker
*
aServiceWorker
)
{
MOZ_DIAGNOSTIC_ASSERT
(
false
"
this
global
should
not
have
any
service
workers
"
)
;
}
