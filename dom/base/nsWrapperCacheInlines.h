#
ifndef
nsWrapperCacheInline_h___
#
define
nsWrapperCacheInline_h___
#
include
"
nsWrapperCache
.
h
"
#
include
"
js
/
TracingAPI
.
h
"
inline
JSObject
*
nsWrapperCache
:
:
GetWrapperPreserveColor
(
)
const
{
JSObject
*
obj
=
GetWrapperMaybeDead
(
)
;
if
(
obj
&
&
js
:
:
gc
:
:
EdgeNeedsSweepUnbarriered
(
&
obj
)
)
{
const_cast
<
nsWrapperCache
*
>
(
this
)
-
>
ClearWrapper
(
)
;
return
nullptr
;
}
MOZ_ASSERT
(
obj
=
=
mWrapper
)
;
return
obj
;
}
inline
JSObject
*
nsWrapperCache
:
:
GetWrapper
(
)
const
{
JSObject
*
obj
=
GetWrapperPreserveColor
(
)
;
if
(
obj
)
{
JS
:
:
ExposeObjectToActiveJS
(
obj
)
;
}
return
obj
;
}
inline
bool
nsWrapperCache
:
:
HasKnownLiveWrapper
(
)
const
{
JSObject
*
o
=
GetWrapperPreserveColor
(
)
;
return
o
&
&
!
JS
:
:
ObjectIsMarkedGray
(
o
)
;
}
static
void
SearchGray
(
JS
:
:
GCCellPtr
aGCThing
const
char
*
aName
void
*
aClosure
)
{
bool
*
hasGrayObjects
=
static_cast
<
bool
*
>
(
aClosure
)
;
if
(
!
*
hasGrayObjects
&
&
aGCThing
&
&
JS
:
:
GCThingIsMarkedGray
(
aGCThing
)
)
{
*
hasGrayObjects
=
true
;
}
}
inline
bool
nsWrapperCache
:
:
HasNothingToTrace
(
nsISupports
*
aThis
)
{
nsXPCOMCycleCollectionParticipant
*
participant
=
nullptr
;
CallQueryInterface
(
aThis
&
participant
)
;
bool
hasGrayObjects
=
false
;
participant
-
>
Trace
(
aThis
TraceCallbackFunc
(
SearchGray
)
&
hasGrayObjects
)
;
return
!
hasGrayObjects
;
}
inline
bool
nsWrapperCache
:
:
HasKnownLiveWrapperAndDoesNotNeedTracing
(
nsISupports
*
aThis
)
{
return
HasKnownLiveWrapper
(
)
&
&
HasNothingToTrace
(
aThis
)
;
}
inline
void
nsWrapperCache
:
:
MarkWrapperLive
(
)
{
GetWrapper
(
)
;
}
#
endif
