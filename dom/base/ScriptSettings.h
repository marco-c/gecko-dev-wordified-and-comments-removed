#
ifndef
mozilla_dom_ScriptSettings_h
#
define
mozilla_dom_ScriptSettings_h
#
include
"
MainThreadUtils
.
h
"
#
include
"
nsIGlobalObject
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
jsapi
.
h
"
#
include
"
js
/
Debug
.
h
"
class
nsPIDOMWindowInner
;
class
nsGlobalWindow
;
class
nsIScriptContext
;
class
nsIDocument
;
class
nsIDocShell
;
namespace
mozilla
{
namespace
dom
{
namespace
danger
{
class
MOZ_STACK_CLASS
AutoCxPusher
{
public
:
explicit
AutoCxPusher
(
JSContext
*
aCx
bool
aAllowNull
=
false
)
;
~
AutoCxPusher
(
)
;
bool
IsStackTop
(
)
const
;
private
:
mozilla
:
:
Maybe
<
JSAutoRequest
>
mAutoRequest
;
#
ifdef
DEBUG
uint32_t
mStackDepthAfterPush
;
JSContext
*
mPushedContext
;
unsigned
mCompartmentDepthOnEntry
;
#
endif
}
;
}
void
InitScriptSettings
(
)
;
void
DestroyScriptSettings
(
)
;
bool
ScriptSettingsInitialized
(
)
;
void
UseEntryScriptProfiling
(
)
;
void
UnuseEntryScriptProfiling
(
)
;
nsIGlobalObject
*
GetEntryGlobal
(
)
;
nsIDocument
*
GetEntryDocument
(
)
;
nsIGlobalObject
*
GetIncumbentGlobal
(
)
;
nsIGlobalObject
*
GetCurrentGlobal
(
)
;
nsIPrincipal
*
GetWebIDLCallerPrincipal
(
)
;
inline
JSObject
&
IncumbentJSGlobal
(
)
{
return
*
GetIncumbentGlobal
(
)
-
>
GetGlobalJSObject
(
)
;
}
class
ScriptSettingsStack
;
class
ScriptSettingsStackEntry
{
friend
class
ScriptSettingsStack
;
public
:
~
ScriptSettingsStackEntry
(
)
;
bool
NoJSAPI
(
)
{
return
!
mGlobalObject
;
}
protected
:
ScriptSettingsStackEntry
(
nsIGlobalObject
*
aGlobal
bool
aCandidate
)
;
nsCOMPtr
<
nsIGlobalObject
>
mGlobalObject
;
bool
mIsCandidateEntryPoint
;
private
:
friend
class
AutoNoJSAPI
;
ScriptSettingsStackEntry
(
)
;
ScriptSettingsStackEntry
*
mOlder
;
}
;
class
MOZ_STACK_CLASS
AutoJSAPI
{
public
:
AutoJSAPI
(
)
;
~
AutoJSAPI
(
)
;
void
Init
(
)
;
bool
Init
(
nsIGlobalObject
*
aGlobalObject
)
;
bool
Init
(
JSObject
*
aObject
)
;
bool
Init
(
nsIGlobalObject
*
aGlobalObject
JSContext
*
aCx
)
;
bool
Init
(
nsPIDOMWindowInner
*
aWindow
)
;
bool
Init
(
nsPIDOMWindowInner
*
aWindow
JSContext
*
aCx
)
;
bool
Init
(
nsGlobalWindow
*
aWindow
)
;
bool
Init
(
nsGlobalWindow
*
aWindow
JSContext
*
aCx
)
;
JSContext
*
cx
(
)
const
{
MOZ_ASSERT
(
mCx
"
Must
call
Init
before
using
an
AutoJSAPI
"
)
;
MOZ_ASSERT_IF
(
mIsMainThread
CxPusherIsStackTop
(
)
)
;
return
mCx
;
}
#
ifdef
DEBUG
bool
CxPusherIsStackTop
(
)
const
{
return
mCxPusher
-
>
IsStackTop
(
)
;
}
#
endif
void
ReportException
(
)
;
bool
HasException
(
)
const
{
MOZ_ASSERT_IF
(
NS_IsMainThread
(
)
CxPusherIsStackTop
(
)
)
;
return
JS_IsExceptionPending
(
cx
(
)
)
;
}
;
bool
StealException
(
JS
:
:
MutableHandle
<
JS
:
:
Value
>
aVal
)
;
bool
PeekException
(
JS
:
:
MutableHandle
<
JS
:
:
Value
>
aVal
)
;
void
ClearException
(
)
{
MOZ_ASSERT_IF
(
NS_IsMainThread
(
)
CxPusherIsStackTop
(
)
)
;
JS_ClearPendingException
(
cx
(
)
)
;
}
protected
:
AutoJSAPI
(
nsIGlobalObject
*
aGlobalObject
bool
aIsMainThread
JSContext
*
aCx
)
;
private
:
RefPtr
<
nsIGlobalObject
>
mGlobalObject
;
mozilla
:
:
Maybe
<
danger
:
:
AutoCxPusher
>
mCxPusher
;
mozilla
:
:
Maybe
<
JSAutoNullableCompartment
>
mAutoNullableCompartment
;
JSContext
*
mCx
;
bool
mIsMainThread
;
Maybe
<
JS
:
:
WarningReporter
>
mOldWarningReporter
;
void
InitInternal
(
nsIGlobalObject
*
aGlobalObject
JSObject
*
aGlobal
JSContext
*
aCx
bool
aIsMainThread
)
;
AutoJSAPI
(
const
AutoJSAPI
&
)
=
delete
;
AutoJSAPI
&
operator
=
(
const
AutoJSAPI
&
)
=
delete
;
}
;
class
MOZ_STACK_CLASS
AutoEntryScript
:
public
AutoJSAPI
protected
ScriptSettingsStackEntry
{
public
:
AutoEntryScript
(
nsIGlobalObject
*
aGlobalObject
const
char
*
aReason
bool
aIsMainThread
=
NS_IsMainThread
(
)
JSContext
*
aCx
=
nullptr
)
;
AutoEntryScript
(
JSObject
*
aObject
const
char
*
aReason
bool
aIsMainThread
=
NS_IsMainThread
(
)
JSContext
*
aCx
=
nullptr
)
;
~
AutoEntryScript
(
)
;
void
SetWebIDLCallerPrincipal
(
nsIPrincipal
*
aPrincipal
)
{
mWebIDLCallerPrincipal
=
aPrincipal
;
}
private
:
class
DocshellEntryMonitor
:
public
JS
:
:
dbg
:
:
AutoEntryMonitor
{
public
:
DocshellEntryMonitor
(
JSContext
*
aCx
const
char
*
aReason
)
;
void
Entry
(
JSContext
*
aCx
JSFunction
*
aFunction
JS
:
:
Handle
<
JS
:
:
Value
>
aAsyncStack
const
char
*
aAsyncCause
)
override
{
Entry
(
aCx
aFunction
nullptr
aAsyncStack
aAsyncCause
)
;
}
void
Entry
(
JSContext
*
aCx
JSScript
*
aScript
JS
:
:
Handle
<
JS
:
:
Value
>
aAsyncStack
const
char
*
aAsyncCause
)
override
{
Entry
(
aCx
nullptr
aScript
aAsyncStack
aAsyncCause
)
;
}
void
Exit
(
JSContext
*
aCx
)
override
;
private
:
void
Entry
(
JSContext
*
aCx
JSFunction
*
aFunction
JSScript
*
aScript
JS
:
:
Handle
<
JS
:
:
Value
>
aAsyncStack
const
char
*
aAsyncCause
)
;
const
char
*
mReason
;
}
;
nsIPrincipal
*
MOZ_NON_OWNING_REF
mWebIDLCallerPrincipal
;
friend
nsIPrincipal
*
GetWebIDLCallerPrincipal
(
)
;
Maybe
<
DocshellEntryMonitor
>
mDocShellEntryMonitor
;
}
;
class
AutoIncumbentScript
:
protected
ScriptSettingsStackEntry
{
public
:
explicit
AutoIncumbentScript
(
nsIGlobalObject
*
aGlobalObject
)
;
private
:
JS
:
:
AutoHideScriptedCaller
mCallerOverride
;
}
;
class
AutoNoJSAPI
:
protected
ScriptSettingsStackEntry
{
public
:
explicit
AutoNoJSAPI
(
bool
aIsMainThread
=
NS_IsMainThread
(
)
)
;
private
:
mozilla
:
:
Maybe
<
danger
:
:
AutoCxPusher
>
mCxPusher
;
}
;
}
class
MOZ_RAII
AutoJSContext
{
public
:
explicit
AutoJSContext
(
MOZ_GUARD_OBJECT_NOTIFIER_ONLY_PARAM
)
;
operator
JSContext
*
(
)
const
;
protected
:
JSContext
*
mCx
;
dom
:
:
AutoJSAPI
mJSAPI
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
class
MOZ_RAII
AutoSafeJSContext
:
public
dom
:
:
AutoJSAPI
{
public
:
explicit
AutoSafeJSContext
(
MOZ_GUARD_OBJECT_NOTIFIER_ONLY_PARAM
)
;
operator
JSContext
*
(
)
const
{
return
cx
(
)
;
}
private
:
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
}
#
endif
