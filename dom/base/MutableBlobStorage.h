#
ifndef
mozilla_dom_MutableBlobStorage_h
#
define
mozilla_dom_MutableBlobStorage_h
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
prio
.
h
"
namespace
mozilla
{
namespace
dom
{
class
Blob
;
class
BlobImpl
;
class
MutableBlobStorage
;
class
MutableBlobStorageCallback
{
public
:
NS_IMETHOD_
(
MozExternalRefCountType
)
AddRef
(
void
)
=
0
;
NS_IMETHOD_
(
MozExternalRefCountType
)
Release
(
void
)
=
0
;
virtual
void
BlobStoreCompleted
(
MutableBlobStorage
*
aBlobStorage
Blob
*
aBlob
nsresult
aRv
)
=
0
;
}
;
class
MutableBlobStorage
final
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
MutableBlobStorage
)
;
enum
MutableBlobStorageType
{
eOnlyInMemory
eCouldBeInTemporaryFile
}
;
explicit
MutableBlobStorage
(
MutableBlobStorageType
aType
)
;
nsresult
Append
(
const
void
*
aData
uint32_t
aLength
)
;
uint64_t
GetBlobWhenReady
(
nsISupports
*
aParent
const
nsACString
&
aContentType
MutableBlobStorageCallback
*
aCallback
)
;
void
TemporaryFileCreated
(
PRFileDesc
*
aFD
)
;
void
CreateBlobAndRespond
(
already_AddRefed
<
nsISupports
>
aParent
const
nsACString
&
aContentType
already_AddRefed
<
MutableBlobStorageCallback
>
aCallback
)
;
void
ErrorPropagated
(
nsresult
aRv
)
;
private
:
~
MutableBlobStorage
(
)
;
bool
ExpandBufferSize
(
uint64_t
aSize
)
;
bool
ShouldBeTemporaryStorage
(
uint64_t
aSize
)
const
;
nsresult
MaybeCreateTemporaryFile
(
)
;
static
nsresult
DispatchToIOThread
(
Runnable
*
aRunnable
)
;
void
*
mData
;
uint64_t
mDataLen
;
uint64_t
mDataBufferLen
;
enum
StorageState
{
eKeepInMemory
eInMemory
eWaitingForTemporaryFile
eInTemporaryFile
eClosed
}
;
StorageState
mStorageState
;
PRFileDesc
*
mFD
;
nsresult
mErrorResult
;
}
;
}
}
#
endif
