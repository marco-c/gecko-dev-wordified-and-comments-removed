#
include
"
Link
.
h
"
#
include
"
mozilla
/
EventStates
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
ifdef
ANDROID
#
include
"
mozilla
/
IHistory
.
h
"
#
else
#
include
"
mozilla
/
places
/
History
.
h
"
#
endif
#
include
"
nsIURL
.
h
"
#
include
"
nsIURIMutator
.
h
"
#
include
"
nsISizeOf
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsIPrefetchService
.
h
"
#
include
"
nsCPrefetchService
.
h
"
#
include
"
nsStyleLinkElement
.
h
"
#
include
"
nsEscape
.
h
"
#
include
"
nsGkAtoms
.
h
"
#
include
"
nsHTMLDNSPrefetch
.
h
"
#
include
"
nsString
.
h
"
#
include
"
mozAutoDocUpdate
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
nsAttrValueInlines
.
h
"
namespace
mozilla
{
namespace
dom
{
#
ifndef
ANDROID
using
places
:
:
History
;
#
endif
Link
:
:
Link
(
Element
*
aElement
)
:
mElement
(
aElement
)
mLinkState
(
eLinkState_NotLink
)
mNeedsRegistration
(
false
)
mRegistered
(
false
)
mHasPendingLinkUpdate
(
false
)
mInDNSPrefetch
(
false
)
mHistory
(
true
)
{
MOZ_ASSERT
(
mElement
"
Must
have
an
element
"
)
;
}
Link
:
:
Link
(
)
:
mElement
(
nullptr
)
mLinkState
(
eLinkState_NotLink
)
mNeedsRegistration
(
false
)
mRegistered
(
false
)
mHasPendingLinkUpdate
(
false
)
mInDNSPrefetch
(
false
)
mHistory
(
false
)
{
}
Link
:
:
~
Link
(
)
{
MOZ_ASSERT
(
!
mElement
|
|
!
mElement
-
>
IsInComposedDoc
(
)
)
;
if
(
IsInDNSPrefetch
(
)
)
{
nsHTMLDNSPrefetch
:
:
LinkDestroyed
(
this
)
;
}
UnregisterFromHistory
(
)
;
}
bool
Link
:
:
ElementHasHref
(
)
const
{
return
mElement
-
>
HasAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
href
)
|
|
(
!
mElement
-
>
IsHTMLElement
(
)
&
&
mElement
-
>
HasAttr
(
kNameSpaceID_XLink
nsGkAtoms
:
:
href
)
)
;
}
void
Link
:
:
TryDNSPrefetch
(
)
{
MOZ_ASSERT
(
mElement
-
>
IsInComposedDoc
(
)
)
;
if
(
ElementHasHref
(
)
&
&
nsHTMLDNSPrefetch
:
:
IsAllowed
(
mElement
-
>
OwnerDoc
(
)
)
)
{
nsHTMLDNSPrefetch
:
:
PrefetchLow
(
this
)
;
}
}
void
Link
:
:
CancelDNSPrefetch
(
nsWrapperCache
:
:
FlagsType
aDeferredFlag
nsWrapperCache
:
:
FlagsType
aRequestedFlag
)
{
if
(
mElement
-
>
HasFlag
(
aDeferredFlag
)
)
{
mElement
-
>
UnsetFlags
(
aDeferredFlag
)
;
}
else
if
(
mElement
-
>
HasFlag
(
aRequestedFlag
)
)
{
mElement
-
>
UnsetFlags
(
aRequestedFlag
)
;
nsHTMLDNSPrefetch
:
:
CancelPrefetchLow
(
this
NS_ERROR_ABORT
)
;
}
}
void
Link
:
:
GetContentPolicyMimeTypeMedia
(
nsAttrValue
&
aAsAttr
nsContentPolicyType
&
aPolicyType
nsString
&
aMimeType
nsAString
&
aMedia
)
{
nsAutoString
as
;
mElement
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
as
as
)
;
Link
:
:
ParseAsValue
(
as
aAsAttr
)
;
aPolicyType
=
AsValueToContentPolicy
(
aAsAttr
)
;
nsAutoString
type
;
mElement
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
type
type
)
;
nsAutoString
notUsed
;
nsContentUtils
:
:
SplitMimeType
(
type
aMimeType
notUsed
)
;
mElement
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
media
aMedia
)
;
}
void
Link
:
:
TryDNSPrefetchOrPreconnectOrPrefetchOrPreloadOrPrerender
(
)
{
MOZ_ASSERT
(
mElement
-
>
IsInComposedDoc
(
)
)
;
if
(
!
ElementHasHref
(
)
)
{
return
;
}
nsAutoString
rel
;
if
(
!
mElement
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
rel
rel
)
)
{
return
;
}
if
(
!
nsContentUtils
:
:
PrefetchPreloadEnabled
(
mElement
-
>
OwnerDoc
(
)
-
>
GetDocShell
(
)
)
)
{
return
;
}
uint32_t
linkTypes
=
nsStyleLinkElement
:
:
ParseLinkTypes
(
rel
)
;
if
(
(
linkTypes
&
nsStyleLinkElement
:
:
ePREFETCH
)
|
|
(
linkTypes
&
nsStyleLinkElement
:
:
eNEXT
)
|
|
(
linkTypes
&
nsStyleLinkElement
:
:
ePRELOAD
)
)
{
nsCOMPtr
<
nsIPrefetchService
>
prefetchService
(
do_GetService
(
NS_PREFETCHSERVICE_CONTRACTID
)
)
;
if
(
prefetchService
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
uri
)
{
nsCOMPtr
<
nsIDOMNode
>
domNode
=
GetAsDOMNode
(
mElement
)
;
if
(
linkTypes
&
nsStyleLinkElement
:
:
ePRELOAD
)
{
nsAttrValue
asAttr
;
nsContentPolicyType
policyType
;
nsAutoString
mimeType
;
nsAutoString
media
;
GetContentPolicyMimeTypeMedia
(
asAttr
policyType
mimeType
media
)
;
if
(
policyType
=
=
nsIContentPolicy
:
:
TYPE_INVALID
)
{
return
;
}
if
(
!
nsStyleLinkElement
:
:
CheckPreloadAttrs
(
asAttr
mimeType
media
mElement
-
>
OwnerDoc
(
)
)
)
{
policyType
=
nsIContentPolicy
:
:
TYPE_INVALID
;
}
prefetchService
-
>
PreloadURI
(
uri
mElement
-
>
OwnerDoc
(
)
-
>
GetDocumentURI
(
)
domNode
policyType
)
;
}
else
{
prefetchService
-
>
PrefetchURI
(
uri
mElement
-
>
OwnerDoc
(
)
-
>
GetDocumentURI
(
)
domNode
linkTypes
&
nsStyleLinkElement
:
:
ePREFETCH
)
;
}
return
;
}
}
}
if
(
linkTypes
&
nsStyleLinkElement
:
:
ePRECONNECT
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
uri
&
&
mElement
-
>
OwnerDoc
(
)
)
{
mElement
-
>
OwnerDoc
(
)
-
>
MaybePreconnect
(
uri
mElement
-
>
AttrValueToCORSMode
(
mElement
-
>
GetParsedAttr
(
nsGkAtoms
:
:
crossorigin
)
)
)
;
return
;
}
}
if
(
linkTypes
&
nsStyleLinkElement
:
:
eDNS_PREFETCH
)
{
if
(
nsHTMLDNSPrefetch
:
:
IsAllowed
(
mElement
-
>
OwnerDoc
(
)
)
)
{
nsHTMLDNSPrefetch
:
:
PrefetchLow
(
this
)
;
}
}
}
void
Link
:
:
UpdatePreload
(
nsAtom
*
aName
const
nsAttrValue
*
aValue
const
nsAttrValue
*
aOldValue
)
{
MOZ_ASSERT
(
mElement
-
>
IsInComposedDoc
(
)
)
;
if
(
!
ElementHasHref
(
)
)
{
return
;
}
nsAutoString
rel
;
if
(
!
mElement
-
>
GetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
rel
rel
)
)
{
return
;
}
if
(
!
nsContentUtils
:
:
PrefetchPreloadEnabled
(
mElement
-
>
OwnerDoc
(
)
-
>
GetDocShell
(
)
)
)
{
return
;
}
uint32_t
linkTypes
=
nsStyleLinkElement
:
:
ParseLinkTypes
(
rel
)
;
if
(
!
(
linkTypes
&
nsStyleLinkElement
:
:
ePRELOAD
)
)
{
return
;
}
nsCOMPtr
<
nsIPrefetchService
>
prefetchService
(
do_GetService
(
NS_PREFETCHSERVICE_CONTRACTID
)
)
;
if
(
!
prefetchService
)
{
return
;
}
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsCOMPtr
<
nsIDOMNode
>
domNode
=
GetAsDOMNode
(
mElement
)
;
nsAttrValue
asAttr
;
nsContentPolicyType
asPolicyType
;
nsAutoString
mimeType
;
nsAutoString
media
;
GetContentPolicyMimeTypeMedia
(
asAttr
asPolicyType
mimeType
media
)
;
if
(
asPolicyType
=
=
nsIContentPolicy
:
:
TYPE_INVALID
)
{
prefetchService
-
>
CancelPrefetchPreloadURI
(
uri
domNode
)
;
return
;
}
nsContentPolicyType
policyType
=
asPolicyType
;
if
(
!
nsStyleLinkElement
:
:
CheckPreloadAttrs
(
asAttr
mimeType
media
mElement
-
>
OwnerDoc
(
)
)
)
{
policyType
=
nsIContentPolicy
:
:
TYPE_INVALID
;
}
if
(
aName
=
=
nsGkAtoms
:
:
crossorigin
)
{
CORSMode
corsMode
=
Element
:
:
AttrValueToCORSMode
(
aValue
)
;
CORSMode
oldCorsMode
=
Element
:
:
AttrValueToCORSMode
(
aOldValue
)
;
if
(
corsMode
!
=
oldCorsMode
)
{
prefetchService
-
>
CancelPrefetchPreloadURI
(
uri
domNode
)
;
prefetchService
-
>
PreloadURI
(
uri
mElement
-
>
OwnerDoc
(
)
-
>
GetDocumentURI
(
)
domNode
policyType
)
;
}
return
;
}
nsContentPolicyType
oldPolicyType
;
if
(
aName
=
=
nsGkAtoms
:
:
as
)
{
if
(
aOldValue
)
{
oldPolicyType
=
AsValueToContentPolicy
(
*
aOldValue
)
;
if
(
!
nsStyleLinkElement
:
:
CheckPreloadAttrs
(
*
aOldValue
mimeType
media
mElement
-
>
OwnerDoc
(
)
)
)
{
oldPolicyType
=
nsIContentPolicy
:
:
TYPE_INVALID
;
}
}
else
{
oldPolicyType
=
nsIContentPolicy
:
:
TYPE_INVALID
;
}
}
else
if
(
aName
=
=
nsGkAtoms
:
:
type
)
{
nsAutoString
oldType
;
nsAutoString
notUsed
;
if
(
aOldValue
)
{
aOldValue
-
>
ToString
(
oldType
)
;
}
else
{
oldType
=
EmptyString
(
)
;
}
nsAutoString
oldMimeType
;
nsContentUtils
:
:
SplitMimeType
(
oldType
oldMimeType
notUsed
)
;
if
(
nsStyleLinkElement
:
:
CheckPreloadAttrs
(
asAttr
oldMimeType
media
mElement
-
>
OwnerDoc
(
)
)
)
{
oldPolicyType
=
asPolicyType
;
}
else
{
oldPolicyType
=
nsIContentPolicy
:
:
TYPE_INVALID
;
}
}
else
{
MOZ_ASSERT
(
aName
=
=
nsGkAtoms
:
:
media
)
;
nsAutoString
oldMedia
;
if
(
aOldValue
)
{
aOldValue
-
>
ToString
(
oldMedia
)
;
}
else
{
oldMedia
=
EmptyString
(
)
;
}
if
(
nsStyleLinkElement
:
:
CheckPreloadAttrs
(
asAttr
mimeType
oldMedia
mElement
-
>
OwnerDoc
(
)
)
)
{
oldPolicyType
=
asPolicyType
;
}
else
{
oldPolicyType
=
nsIContentPolicy
:
:
TYPE_INVALID
;
}
}
if
(
(
policyType
!
=
oldPolicyType
)
&
&
(
oldPolicyType
!
=
nsIContentPolicy
:
:
TYPE_INVALID
)
)
{
prefetchService
-
>
CancelPrefetchPreloadURI
(
uri
domNode
)
;
}
if
(
(
policyType
!
=
oldPolicyType
)
|
|
(
policyType
=
=
nsIContentPolicy
:
:
TYPE_INVALID
)
)
{
prefetchService
-
>
PreloadURI
(
uri
mElement
-
>
OwnerDoc
(
)
-
>
GetDocumentURI
(
)
domNode
policyType
)
;
}
}
void
Link
:
:
CancelPrefetchOrPreload
(
)
{
nsCOMPtr
<
nsIPrefetchService
>
prefetchService
(
do_GetService
(
NS_PREFETCHSERVICE_CONTRACTID
)
)
;
if
(
prefetchService
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
uri
)
{
nsCOMPtr
<
nsIDOMNode
>
domNode
=
GetAsDOMNode
(
mElement
)
;
prefetchService
-
>
CancelPrefetchPreloadURI
(
uri
domNode
)
;
}
}
}
void
Link
:
:
SetLinkState
(
nsLinkState
aState
)
{
NS_ASSERTION
(
mRegistered
"
Setting
the
link
state
of
an
unregistered
Link
!
"
)
;
NS_ASSERTION
(
mLinkState
!
=
aState
"
Setting
state
to
the
currently
set
state
!
"
)
;
mLinkState
=
aState
;
mRegistered
=
false
;
MOZ_ASSERT
(
LinkState
(
)
=
=
NS_EVENT_STATE_VISITED
|
|
LinkState
(
)
=
=
NS_EVENT_STATE_UNVISITED
"
Unexpected
state
obtained
from
LinkState
(
)
!
"
)
;
mElement
-
>
UpdateState
(
true
)
;
}
EventStates
Link
:
:
LinkState
(
)
const
{
Link
*
self
=
const_cast
<
Link
*
>
(
this
)
;
Element
*
element
=
self
-
>
mElement
;
if
(
!
mRegistered
&
&
mNeedsRegistration
&
&
element
-
>
IsInComposedDoc
(
)
&
&
!
HasPendingLinkUpdate
(
)
)
{
self
-
>
mNeedsRegistration
=
false
;
nsCOMPtr
<
nsIURI
>
hrefURI
(
GetURI
(
)
)
;
self
-
>
mLinkState
=
eLinkState_Unvisited
;
if
(
mHistory
&
&
hrefURI
)
{
#
ifdef
ANDROID
nsCOMPtr
<
IHistory
>
history
=
services
:
:
GetHistoryService
(
)
;
#
else
History
*
history
=
History
:
:
GetService
(
)
;
#
endif
if
(
history
)
{
nsresult
rv
=
history
-
>
RegisterVisitedCallback
(
hrefURI
self
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
self
-
>
mRegistered
=
true
;
element
-
>
GetComposedDoc
(
)
-
>
AddStyleRelevantLink
(
self
)
;
}
}
}
}
if
(
mLinkState
=
=
eLinkState_Visited
)
{
return
NS_EVENT_STATE_VISITED
;
}
if
(
mLinkState
=
=
eLinkState_Unvisited
)
{
return
NS_EVENT_STATE_UNVISITED
;
}
return
EventStates
(
)
;
}
nsIURI
*
Link
:
:
GetURI
(
)
const
{
if
(
mCachedURI
)
{
return
mCachedURI
;
}
Link
*
self
=
const_cast
<
Link
*
>
(
this
)
;
Element
*
element
=
self
-
>
mElement
;
mCachedURI
=
element
-
>
GetHrefURI
(
)
;
return
mCachedURI
;
}
void
Link
:
:
SetProtocol
(
const
nsAString
&
aProtocol
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURIToMutate
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsAString
:
:
const_iterator
start
end
;
aProtocol
.
BeginReading
(
start
)
;
aProtocol
.
EndReading
(
end
)
;
nsAString
:
:
const_iterator
iter
(
start
)
;
(
void
)
FindCharInReadable
(
'
:
'
iter
end
)
;
(
void
)
uri
-
>
SetScheme
(
NS_ConvertUTF16toUTF8
(
Substring
(
start
iter
)
)
)
;
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
SetPassword
(
const
nsAString
&
aPassword
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURIToMutate
(
)
)
;
if
(
!
uri
)
{
return
;
}
uri
-
>
SetPassword
(
NS_ConvertUTF16toUTF8
(
aPassword
)
)
;
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
SetUsername
(
const
nsAString
&
aUsername
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsresult
rv
=
NS_MutateURI
(
uri
)
.
SetUsername
(
NS_ConvertUTF16toUTF8
(
aUsername
)
)
.
Finalize
(
uri
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
SetHrefAttribute
(
uri
)
;
}
}
void
Link
:
:
SetHost
(
const
nsAString
&
aHost
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsresult
rv
=
NS_MutateURI
(
uri
)
.
SetHostPort
(
NS_ConvertUTF16toUTF8
(
aHost
)
)
.
Finalize
(
uri
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
SetHostname
(
const
nsAString
&
aHostname
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURIToMutate
(
)
)
;
if
(
!
uri
)
{
return
;
}
(
void
)
uri
-
>
SetHost
(
NS_ConvertUTF16toUTF8
(
aHostname
)
)
;
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
SetPathname
(
const
nsAString
&
aPathname
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
nsCOMPtr
<
nsIURL
>
url
(
do_QueryInterface
(
uri
)
)
;
if
(
!
url
)
{
return
;
}
nsresult
rv
=
NS_MutateURI
(
uri
)
.
SetFilePath
(
NS_ConvertUTF16toUTF8
(
aPathname
)
)
.
Finalize
(
uri
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
SetSearch
(
const
nsAString
&
aSearch
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
nsCOMPtr
<
nsIURL
>
url
(
do_QueryInterface
(
uri
)
)
;
if
(
!
url
)
{
return
;
}
auto
encoding
=
mElement
-
>
OwnerDoc
(
)
-
>
GetDocumentCharacterSet
(
)
;
nsresult
rv
=
NS_MutateURI
(
uri
)
.
SetQueryWithEncoding
(
NS_ConvertUTF16toUTF8
(
aSearch
)
encoding
)
.
Finalize
(
uri
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
SetPort
(
const
nsAString
&
aPort
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURIToMutate
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsresult
rv
;
nsAutoString
portStr
(
aPort
)
;
int32_t
port
=
-
1
;
if
(
!
aPort
.
IsEmpty
(
)
)
{
port
=
portStr
.
ToInteger
(
&
rv
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
;
}
}
(
void
)
uri
-
>
SetPort
(
port
)
;
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
SetHash
(
const
nsAString
&
aHash
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURIToMutate
(
)
)
;
if
(
!
uri
)
{
return
;
}
(
void
)
uri
-
>
SetRef
(
NS_ConvertUTF16toUTF8
(
aHash
)
)
;
SetHrefAttribute
(
uri
)
;
}
void
Link
:
:
GetOrigin
(
nsAString
&
aOrigin
)
{
aOrigin
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsString
origin
;
nsContentUtils
:
:
GetUTFOrigin
(
uri
origin
)
;
aOrigin
.
Assign
(
origin
)
;
}
void
Link
:
:
GetProtocol
(
nsAString
&
_protocol
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
_protocol
.
AssignLiteral
(
"
http
"
)
;
}
else
{
nsAutoCString
scheme
;
(
void
)
uri
-
>
GetScheme
(
scheme
)
;
CopyASCIItoUTF16
(
scheme
_protocol
)
;
}
_protocol
.
Append
(
char16_t
(
'
:
'
)
)
;
}
void
Link
:
:
GetUsername
(
nsAString
&
aUsername
)
{
aUsername
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsAutoCString
username
;
uri
-
>
GetUsername
(
username
)
;
CopyASCIItoUTF16
(
username
aUsername
)
;
}
void
Link
:
:
GetPassword
(
nsAString
&
aPassword
)
{
aPassword
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsAutoCString
password
;
uri
-
>
GetPassword
(
password
)
;
CopyASCIItoUTF16
(
password
aPassword
)
;
}
void
Link
:
:
GetHost
(
nsAString
&
_host
)
{
_host
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsAutoCString
hostport
;
nsresult
rv
=
uri
-
>
GetHostPort
(
hostport
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
CopyUTF8toUTF16
(
hostport
_host
)
;
}
}
void
Link
:
:
GetHostname
(
nsAString
&
_hostname
)
{
_hostname
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsContentUtils
:
:
GetHostOrIPv6WithBrackets
(
uri
_hostname
)
;
}
void
Link
:
:
GetPathname
(
nsAString
&
_pathname
)
{
_pathname
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
nsCOMPtr
<
nsIURL
>
url
(
do_QueryInterface
(
uri
)
)
;
if
(
!
url
)
{
return
;
}
nsAutoCString
file
;
nsresult
rv
=
url
-
>
GetFilePath
(
file
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
CopyUTF8toUTF16
(
file
_pathname
)
;
}
}
void
Link
:
:
GetSearch
(
nsAString
&
_search
)
{
_search
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
nsCOMPtr
<
nsIURL
>
url
(
do_QueryInterface
(
uri
)
)
;
if
(
!
url
)
{
return
;
}
nsAutoCString
search
;
nsresult
rv
=
url
-
>
GetQuery
(
search
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
!
search
.
IsEmpty
(
)
)
{
CopyUTF8toUTF16
(
NS_LITERAL_CSTRING
(
"
?
"
)
+
search
_search
)
;
}
}
void
Link
:
:
GetPort
(
nsAString
&
_port
)
{
_port
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
int32_t
port
;
nsresult
rv
=
uri
-
>
GetPort
(
&
port
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
port
!
=
-
1
)
{
nsAutoString
portStr
;
portStr
.
AppendInt
(
port
10
)
;
_port
.
Assign
(
portStr
)
;
}
}
void
Link
:
:
GetHash
(
nsAString
&
_hash
)
{
_hash
.
Truncate
(
)
;
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
;
}
nsAutoCString
ref
;
nsresult
rv
=
uri
-
>
GetRef
(
ref
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
!
ref
.
IsEmpty
(
)
)
{
_hash
.
Assign
(
char16_t
(
'
#
'
)
)
;
AppendUTF8toUTF16
(
ref
_hash
)
;
}
}
void
Link
:
:
ResetLinkState
(
bool
aNotify
bool
aHasHref
)
{
nsLinkState
defaultState
;
if
(
aHasHref
)
{
defaultState
=
eLinkState_Unvisited
;
}
else
{
defaultState
=
eLinkState_NotLink
;
}
if
(
!
mNeedsRegistration
&
&
mLinkState
!
=
eLinkState_NotLink
)
{
nsIDocument
*
doc
=
mElement
-
>
GetComposedDoc
(
)
;
if
(
doc
&
&
(
mRegistered
|
|
mLinkState
=
=
eLinkState_Visited
)
)
{
doc
-
>
ForgetLink
(
this
)
;
}
}
mNeedsRegistration
=
aHasHref
;
UnregisterFromHistory
(
)
;
mCachedURI
=
nullptr
;
mLinkState
=
defaultState
;
if
(
aNotify
)
{
mElement
-
>
UpdateState
(
aNotify
)
;
}
else
{
if
(
mLinkState
=
=
eLinkState_Unvisited
)
{
mElement
-
>
UpdateLinkState
(
NS_EVENT_STATE_UNVISITED
)
;
}
else
{
mElement
-
>
UpdateLinkState
(
EventStates
(
)
)
;
}
}
}
void
Link
:
:
UnregisterFromHistory
(
)
{
if
(
!
mRegistered
)
{
return
;
}
if
(
mHistory
&
&
mCachedURI
)
{
#
ifdef
ANDROID
nsCOMPtr
<
IHistory
>
history
=
services
:
:
GetHistoryService
(
)
;
#
else
History
*
history
=
History
:
:
GetService
(
)
;
#
endif
if
(
history
)
{
nsresult
rv
=
history
-
>
UnregisterVisitedCallback
(
mCachedURI
this
)
;
NS_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
This
should
only
fail
if
we
misuse
the
API
!
"
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
mRegistered
=
false
;
}
}
}
}
already_AddRefed
<
nsIURI
>
Link
:
:
GetURIToMutate
(
)
{
nsCOMPtr
<
nsIURI
>
uri
(
GetURI
(
)
)
;
if
(
!
uri
)
{
return
nullptr
;
}
nsCOMPtr
<
nsIURI
>
clone
;
(
void
)
uri
-
>
Clone
(
getter_AddRefs
(
clone
)
)
;
return
clone
.
forget
(
)
;
}
void
Link
:
:
SetHrefAttribute
(
nsIURI
*
aURI
)
{
NS_ASSERTION
(
aURI
"
Null
URI
is
illegal
!
"
)
;
nsAutoCString
href
;
(
void
)
aURI
-
>
GetSpec
(
href
)
;
(
void
)
mElement
-
>
SetAttr
(
kNameSpaceID_None
nsGkAtoms
:
:
href
NS_ConvertUTF8toUTF16
(
href
)
true
)
;
}
size_t
Link
:
:
SizeOfExcludingThis
(
mozilla
:
:
SizeOfState
&
aState
)
const
{
size_t
n
=
0
;
if
(
mCachedURI
)
{
nsCOMPtr
<
nsISizeOf
>
iface
=
do_QueryInterface
(
mCachedURI
)
;
if
(
iface
)
{
n
+
=
iface
-
>
SizeOfIncludingThis
(
aState
.
mMallocSizeOf
)
;
}
}
return
n
;
}
static
const
nsAttrValue
:
:
EnumTable
kAsAttributeTable
[
]
=
{
{
"
"
DESTINATION_INVALID
}
{
"
audio
"
DESTINATION_AUDIO
}
{
"
font
"
DESTINATION_FONT
}
{
"
image
"
DESTINATION_IMAGE
}
{
"
script
"
DESTINATION_SCRIPT
}
{
"
style
"
DESTINATION_STYLE
}
{
"
track
"
DESTINATION_TRACK
}
{
"
video
"
DESTINATION_VIDEO
}
{
"
fetch
"
DESTINATION_FETCH
}
{
nullptr
0
}
}
;
void
Link
:
:
ParseAsValue
(
const
nsAString
&
aValue
nsAttrValue
&
aResult
)
{
DebugOnly
<
bool
>
success
=
aResult
.
ParseEnumValue
(
aValue
kAsAttributeTable
false
&
kAsAttributeTable
[
0
]
)
;
MOZ_ASSERT
(
success
)
;
}
nsContentPolicyType
Link
:
:
AsValueToContentPolicy
(
const
nsAttrValue
&
aValue
)
{
switch
(
aValue
.
GetEnumValue
(
)
)
{
case
DESTINATION_INVALID
:
return
nsIContentPolicy
:
:
TYPE_INVALID
;
case
DESTINATION_AUDIO
:
case
DESTINATION_TRACK
:
case
DESTINATION_VIDEO
:
return
nsIContentPolicy
:
:
TYPE_MEDIA
;
case
DESTINATION_FONT
:
return
nsIContentPolicy
:
:
TYPE_FONT
;
case
DESTINATION_IMAGE
:
return
nsIContentPolicy
:
:
TYPE_IMAGE
;
case
DESTINATION_SCRIPT
:
return
nsIContentPolicy
:
:
TYPE_SCRIPT
;
case
DESTINATION_STYLE
:
return
nsIContentPolicy
:
:
TYPE_STYLESHEET
;
case
DESTINATION_FETCH
:
return
nsIContentPolicy
:
:
TYPE_OTHER
;
}
return
nsIContentPolicy
:
:
TYPE_INVALID
;
}
}
}
