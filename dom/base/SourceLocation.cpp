#
include
"
mozilla
/
SourceLocation
.
h
"
#
include
"
jsapi
.
h
"
#
include
"
mozilla
/
ThreadLocal
.
h
"
#
include
"
nsContentUtils
.
h
"
namespace
mozilla
{
SourceLocation
:
:
SourceLocation
(
)
=
default
;
SourceLocation
:
:
~
SourceLocation
(
)
=
default
;
SourceLocation
:
:
SourceLocation
(
nsCString
&
&
aResource
uint32_t
aLine
uint32_t
aCol
)
:
mResource
(
std
:
:
move
(
aResource
)
)
mLine
(
aLine
)
mColumn
(
aCol
)
{
}
SourceLocation
:
:
SourceLocation
(
nsCOMPtr
<
nsIURI
>
&
&
aResource
uint32_t
aLine
uint32_t
aCol
)
:
mResource
(
std
:
:
move
(
aResource
)
)
mLine
(
aLine
)
mColumn
(
aCol
)
{
}
static
MOZ_THREAD_LOCAL
(
const
JSCallingLocation
*
)
tlsFallback
;
const
JSCallingLocation
*
JSCallingLocation
:
:
GetFallback
(
)
{
if
(
!
tlsFallback
.
initialized
(
)
)
{
return
nullptr
;
}
return
tlsFallback
.
get
(
)
;
}
void
JSCallingLocation
:
:
SetFallback
(
const
JSCallingLocation
*
aFallback
)
{
if
(
!
tlsFallback
.
init
(
)
)
{
return
;
}
tlsFallback
.
set
(
aFallback
)
;
}
JSCallingLocation
JSCallingLocation
:
:
Get
(
)
{
return
Get
(
nsContentUtils
:
:
GetCurrentJSContext
(
)
)
;
}
JSCallingLocation
JSCallingLocation
:
:
Get
(
JSContext
*
aCx
)
{
JSCallingLocation
result
;
if
(
const
JSCallingLocation
*
loc
=
GetFallback
(
)
)
{
result
=
*
loc
;
}
if
(
!
aCx
)
{
return
result
;
}
JS
:
:
AutoFilename
filename
;
uint32_t
line
;
JS
:
:
ColumnNumberOneOrigin
column
;
if
(
!
JS
:
:
DescribeScriptedCaller
(
&
filename
aCx
&
line
&
column
)
)
{
return
result
;
}
nsCString
file
;
if
(
!
file
.
Assign
(
filename
.
get
(
)
fallible
)
)
{
return
result
;
}
result
.
mResource
=
AsVariant
(
std
:
:
move
(
file
)
)
;
result
.
mLine
=
line
;
result
.
mColumn
=
column
.
oneOriginValue
(
)
;
return
result
;
}
}
