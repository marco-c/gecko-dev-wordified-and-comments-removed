add_task
(
async
function
test
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
security
.
csp
.
enable
"
false
]
[
"
csp
.
skip_about_page_has_csp_assert
"
true
]
]
}
)
;
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
plugins
"
}
async
function
(
newBrowser
)
{
await
ContentTask
.
spawn
(
newBrowser
null
testXFOFrameInChrome
)
;
await
BrowserTestUtils
.
loadURI
(
newBrowser
"
http
:
/
/
example
.
com
/
"
)
;
await
BrowserTestUtils
.
browserLoaded
(
newBrowser
)
;
await
ContentTask
.
spawn
(
newBrowser
null
testXFOFrameInContent
)
;
}
)
;
}
)
;
function
testXFOFrameInChrome
(
)
{
var
deferred
=
{
}
;
deferred
.
promise
=
new
Promise
(
resolve
=
>
{
deferred
.
resolve
=
resolve
;
}
)
;
var
frame
=
content
.
document
.
createElement
(
"
iframe
"
)
;
frame
.
src
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
dom
/
base
/
test
/
file_x
-
frame
-
options_page
.
sjs
?
testid
=
deny
&
xfo
=
deny
"
;
frame
.
addEventListener
(
"
load
"
function
(
)
{
var
test
=
this
.
contentDocument
.
getElementById
(
"
test
"
)
;
is
(
test
.
tagName
"
H1
"
"
wrong
element
type
"
)
;
is
(
test
.
textContent
"
deny
"
"
wrong
textContent
"
)
;
deferred
.
resolve
(
)
;
}
{
capture
:
true
once
:
true
}
)
;
content
.
document
.
body
.
appendChild
(
frame
)
;
return
deferred
.
promise
;
}
function
testXFOFrameInContent
(
)
{
var
deferred
=
{
}
;
deferred
.
promise
=
new
Promise
(
resolve
=
>
{
deferred
.
resolve
=
resolve
;
}
)
;
var
frame
=
content
.
document
.
createElement
(
"
iframe
"
)
;
frame
.
src
=
"
http
:
/
/
mochi
.
test
:
8888
/
browser
/
dom
/
base
/
test
/
file_x
-
frame
-
options_page
.
sjs
?
testid
=
deny
&
xfo
=
deny
"
;
frame
.
addEventListener
(
"
load
"
function
(
)
{
var
test
=
this
.
contentDocument
.
getElementById
(
"
test
"
)
;
Assert
.
equal
(
test
null
"
should
be
about
:
blank
"
)
;
deferred
.
resolve
(
)
;
}
{
capture
:
true
once
:
true
}
)
;
content
.
document
.
body
.
appendChild
(
frame
)
;
return
deferred
.
promise
;
}
