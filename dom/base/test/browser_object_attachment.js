ChromeUtils
.
defineESModuleGetters
(
this
{
Downloads
:
"
resource
:
/
/
gre
/
modules
/
Downloads
.
sys
.
mjs
"
}
)
;
async
function
waitForDownload
(
)
{
let
downloadList
=
await
Downloads
.
getList
(
Downloads
.
ALL
)
;
let
downloadView
;
let
finishedAllDownloads
=
new
Promise
(
resolve
=
>
{
downloadView
=
{
onDownloadAdded
(
aDownload
)
{
info
(
"
download
added
"
)
;
resolve
(
aDownload
)
;
}
}
;
}
)
;
await
downloadList
.
addView
(
downloadView
)
;
let
download
=
await
finishedAllDownloads
;
await
downloadList
.
removeView
(
downloadView
)
;
await
downloadList
.
remove
(
download
)
;
await
download
.
finalize
(
true
)
;
return
download
;
}
const
httpsTestRoot
=
getRootDirectory
(
gTestPath
)
.
replace
(
"
chrome
:
/
/
mochitests
/
content
"
"
https
:
/
/
example
.
com
"
)
;
add_task
(
async
function
test_pdf_object_attachment
(
)
{
var
gMimeSvc
=
Cc
[
"
mozilla
.
org
/
mime
;
1
"
]
.
getService
(
Ci
.
nsIMIMEService
)
;
var
gHandlerSvc
=
Cc
[
"
mozilla
.
org
/
uriloader
/
handler
-
service
;
1
"
]
.
getService
(
Ci
.
nsIHandlerService
)
;
const
mimeInfo
=
gMimeSvc
.
getFromTypeAndExtension
(
"
application
/
pdf
"
"
pdf
"
)
;
let
previousAction
=
mimeInfo
.
preferredAction
;
mimeInfo
.
preferredAction
=
Ci
.
nsIHandlerInfo
.
saveToDisk
;
gHandlerSvc
.
store
(
mimeInfo
)
;
registerCleanupFunction
(
(
)
=
>
{
mimeInfo
.
preferredAction
=
previousAction
;
gHandlerSvc
.
store
(
mimeInfo
)
;
}
)
;
let
downloadPromise
=
waitForDownload
(
)
;
await
BrowserTestUtils
.
withNewTab
(
{
httpsTestRoot
}
/
file_pdf_object_attachment
.
html
async
browser
=
>
{
let
download
=
await
downloadPromise
;
is
(
download
.
source
.
url
{
httpsTestRoot
}
/
file_pdf_attachment
.
pdf
"
download
should
be
the
pdf
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
obj
=
content
.
document
.
querySelector
(
"
object
"
)
;
is
(
obj
.
displayedType
Ci
.
nsIObjectLoadingContent
.
TYPE_NULL
"
should
be
displaying
TYPE_NULL
(
fallback
)
"
)
;
}
)
;
}
)
;
}
)
;
add_task
(
async
function
test_img_object_attachment
(
)
{
let
downloadPromise
=
waitForDownload
(
)
;
await
BrowserTestUtils
.
withNewTab
(
{
httpsTestRoot
}
/
file_img_object_attachment
.
html
async
browser
=
>
{
let
download
=
await
downloadPromise
;
is
(
download
.
source
.
url
{
httpsTestRoot
}
/
file_img_attachment
.
jpg
"
download
should
be
the
jpg
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
]
async
(
)
=
>
{
let
obj
=
content
.
document
.
querySelector
(
"
object
"
)
;
is
(
obj
.
displayedType
Ci
.
nsIObjectLoadingContent
.
TYPE_NULL
"
should
be
displaying
TYPE_NULL
(
fallback
)
"
)
;
}
)
;
}
)
;
}
)
;
