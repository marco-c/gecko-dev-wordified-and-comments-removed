"
use
strict
"
;
async
function
spawnNewAndTest
(
recur
pids
)
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
forceNewProcess
:
true
}
function
*
(
browser
)
{
let
newPid
=
browser
.
frameLoader
.
tabParent
.
osPid
;
ok
(
!
pids
.
has
(
newPid
)
"
new
tab
is
in
its
own
process
"
)
;
pids
.
add
(
newPid
)
;
if
(
recur
)
{
yield
spawnNewAndTest
(
recur
-
1
pids
)
;
}
else
{
yield
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
blank
"
}
function
*
(
browser
)
{
todo
(
pids
.
has
(
browser
.
frameLoader
.
tabParent
.
osPid
)
"
we
should
be
reusing
processes
if
not
asked
to
force
the
"
+
"
tab
into
its
own
process
"
)
;
}
)
;
}
}
)
;
}
add_task
(
async
function
test
(
)
{
let
curPid
=
gBrowser
.
selectedBrowser
.
frameLoader
.
tabParent
.
osPid
;
let
maxCount
=
Services
.
prefs
.
getIntPref
(
"
dom
.
ipc
.
processCount
"
)
;
await
spawnNewAndTest
(
Math
.
max
(
maxCount
+
1
5
)
new
Set
(
[
curPid
]
)
)
;
}
)
;
