"
use
strict
"
;
const
PAGE
=
"
data
:
text
/
html
<
html
>
<
body
>
A
%
20regular
%
20everyday
%
20normal
%
20page
.
"
;
function
prepareForVisibilityEvents
(
browser
expectedOrder
)
{
return
new
Promise
(
(
resolve
)
=
>
{
let
order
=
[
]
;
let
checkSatisfied
=
(
)
=
>
{
if
(
order
.
length
<
expectedOrder
.
length
)
{
return
;
}
else
{
browser
.
removeEventListener
(
"
pagehide
"
eventListener
)
;
browser
.
removeEventListener
(
"
pageshow
"
eventListener
)
;
for
(
let
i
=
0
;
i
<
expectedOrder
.
length
;
+
+
i
)
{
is
(
order
[
i
]
expectedOrder
[
i
]
"
Got
expected
event
"
)
;
}
resolve
(
)
;
}
}
;
let
eventListener
=
(
e
)
=
>
{
if
(
e
.
persisted
)
{
order
.
push
(
e
.
type
)
;
checkSatisfied
(
)
;
}
}
;
browser
.
addEventListener
(
"
pagehide
"
eventListener
)
;
browser
.
addEventListener
(
"
pageshow
"
eventListener
)
;
}
)
;
}
add_task
(
function
*
test_swap_frameloader_pagevisibility_events
(
)
{
let
tab
=
gBrowser
.
addTab
(
PAGE
)
;
gBrowser
.
selectedTab
=
tab
;
let
firstBrowser
=
tab
.
linkedBrowser
;
yield
BrowserTestUtils
.
browserLoaded
(
firstBrowser
)
;
let
newWindow
=
gBrowser
.
replaceTabWithWindow
(
tab
)
;
yield
BrowserTestUtils
.
waitForEvent
(
newWindow
"
load
"
)
;
let
newWindowBrowser
=
newWindow
.
gBrowser
.
selectedBrowser
;
yield
prepareForVisibilityEvents
(
newWindowBrowser
[
"
pagehide
"
"
pageshow
"
]
)
;
let
newTab
=
gBrowser
.
addTab
(
)
;
gBrowser
.
selectedTab
=
newTab
;
let
emptyBrowser
=
newTab
.
linkedBrowser
;
yield
new
Promise
(
(
resolve
)
=
>
{
emptyBrowser
.
addEventListener
(
"
pageshow
"
function
onPageShow
(
)
{
emptyBrowser
.
removeEventListener
(
"
pageshow
"
onPageShow
)
;
resolve
(
)
;
}
)
;
}
)
;
let
emptyBrowserPromise
=
prepareForVisibilityEvents
(
emptyBrowser
[
"
pagehide
"
"
pageshow
"
]
)
;
gBrowser
.
swapBrowsersAndCloseOther
(
newTab
newWindow
.
gBrowser
.
selectedTab
)
;
yield
emptyBrowserPromise
;
gBrowser
.
removeTab
(
gBrowser
.
selectedTab
)
;
}
)
;
