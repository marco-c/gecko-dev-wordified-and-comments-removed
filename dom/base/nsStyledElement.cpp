#
include
"
nsStyledElement
.
h
"
#
include
"
mozAutoDocUpdate
.
h
"
#
include
"
mozilla
/
DeclarationBlock
.
h
"
#
include
"
mozilla
/
InternalMutationEvent
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
css
/
Loader
.
h
"
#
include
"
mozilla
/
dom
/
BindContext
.
h
"
#
include
"
mozilla
/
dom
/
CustomElementRegistry
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
ElementInlines
.
h
"
#
include
"
mozilla
/
dom
/
MutationObservers
.
h
"
#
include
"
mozilla
/
dom
/
StylePropertyMap
.
h
"
#
include
"
nsAttrValue
.
h
"
#
include
"
nsAttrValueInlines
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsDOMCSSAttrDeclaration
.
h
"
#
include
"
nsDOMCSSDeclaration
.
h
"
#
include
"
nsGkAtoms
.
h
"
#
include
"
nsIMutationObserver
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsStyleUtil
.
h
"
#
include
"
nsXULElement
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
NS_IMPL_QUERY_INTERFACE_CYCLE_COLLECTION_INHERITED
(
nsStyledElement
nsStyledElementBase
nsStyledElement
)
bool
nsStyledElement
:
:
ParseAttribute
(
int32_t
aNamespaceID
nsAtom
*
aAttribute
const
nsAString
&
aValue
nsIPrincipal
*
aMaybeScriptedPrincipal
nsAttrValue
&
aResult
)
{
if
(
aAttribute
=
=
nsGkAtoms
:
:
style
&
&
aNamespaceID
=
=
kNameSpaceID_None
)
{
ParseStyleAttribute
(
aValue
aMaybeScriptedPrincipal
aResult
false
)
;
return
true
;
}
return
nsStyledElementBase
:
:
ParseAttribute
(
aNamespaceID
aAttribute
aValue
aMaybeScriptedPrincipal
aResult
)
;
}
void
nsStyledElement
:
:
BeforeSetAttr
(
int32_t
aNamespaceID
nsAtom
*
aName
const
nsAttrValue
*
aValue
bool
aNotify
)
{
if
(
aNamespaceID
=
=
kNameSpaceID_None
&
&
aName
=
=
nsGkAtoms
:
:
style
&
&
aValue
)
{
SetMayHaveStyle
(
)
;
}
return
nsStyledElementBase
:
:
BeforeSetAttr
(
aNamespaceID
aName
aValue
aNotify
)
;
}
void
nsStyledElement
:
:
InlineStyleDeclarationWillChange
(
MutationClosureData
&
aData
)
{
MOZ_ASSERT
(
!
nsContentUtils
:
:
IsSafeToRunScript
(
)
)
;
MOZ_ASSERT
(
OwnerDoc
(
)
-
>
UpdateNestingLevel
(
)
>
0
"
Should
be
inside
document
update
!
"
)
;
bool
modification
=
false
;
if
(
MayHaveStyle
(
)
)
{
CustomElementDefinition
*
definition
=
GetCustomElementDefinition
(
)
;
if
(
definition
&
&
definition
-
>
IsInObservedAttributeList
(
nsGkAtoms
:
:
style
)
)
{
nsAutoString
oldValueStr
;
modification
=
GetAttr
(
nsGkAtoms
:
:
style
oldValueStr
)
;
if
(
modification
)
{
aData
.
mOldValue
.
emplace
(
)
;
aData
.
mOldValue
-
>
SetTo
(
oldValueStr
)
;
}
}
else
{
modification
=
HasAttr
(
nsGkAtoms
:
:
style
)
;
}
}
aData
.
mModType
=
modification
?
AttrModType
:
:
Modification
:
AttrModType
:
:
Addition
;
MutationObservers
:
:
NotifyAttributeWillChange
(
this
kNameSpaceID_None
nsGkAtoms
:
:
style
aData
.
mModType
)
;
}
nsresult
nsStyledElement
:
:
SetInlineStyleDeclaration
(
DeclarationBlock
&
aDeclaration
MutationClosureData
&
aData
)
{
MOZ_ASSERT
(
OwnerDoc
(
)
-
>
UpdateNestingLevel
(
)
"
Should
be
inside
document
update
!
"
)
;
const
bool
hasMutationEventListeners
=
false
;
nsAttrValue
attrValue
(
do_AddRef
(
&
aDeclaration
)
nullptr
)
;
SetMayHaveStyle
(
)
;
Document
*
document
=
GetComposedDoc
(
)
;
mozAutoDocUpdate
updateBatch
(
document
true
)
;
return
SetAttrAndNotify
(
kNameSpaceID_None
nsGkAtoms
:
:
style
nullptr
aData
.
mOldValue
.
ptrOr
(
nullptr
)
attrValue
nullptr
aData
.
mModType
hasMutationEventListeners
true
kDontCallAfterSetAttr
document
updateBatch
)
;
}
nsICSSDeclaration
*
nsStyledElement
:
:
Style
(
)
{
Element
:
:
nsDOMSlots
*
slots
=
DOMSlots
(
)
;
if
(
!
slots
-
>
mStyle
)
{
ReparseStyleAttribute
(
true
)
;
slots
-
>
mStyle
=
new
nsDOMCSSAttributeDeclaration
(
this
false
)
;
SetMayHaveStyle
(
)
;
}
return
slots
-
>
mStyle
;
}
StylePropertyMap
*
nsStyledElement
:
:
AttributeStyleMap
(
)
{
nsDOMSlots
*
slots
=
DOMSlots
(
)
;
if
(
!
slots
-
>
mAttributeStyleMap
)
{
slots
-
>
mAttributeStyleMap
=
MakeRefPtr
<
StylePropertyMap
>
(
this
)
;
}
return
slots
-
>
mAttributeStyleMap
;
}
nsresult
nsStyledElement
:
:
ReparseStyleAttribute
(
bool
aForceInDataDoc
)
{
if
(
!
MayHaveStyle
(
)
)
{
return
NS_OK
;
}
const
nsAttrValue
*
oldVal
=
mAttrs
.
GetAttr
(
nsGkAtoms
:
:
style
)
;
if
(
oldVal
&
&
oldVal
-
>
Type
(
)
!
=
nsAttrValue
:
:
eCSSDeclaration
)
{
nsAttrValue
attrValue
;
nsAutoString
stringValue
;
oldVal
-
>
ToString
(
stringValue
)
;
if
(
!
stringValue
.
IsEmpty
(
)
)
{
ParseStyleAttribute
(
stringValue
nullptr
attrValue
aForceInDataDoc
)
;
}
bool
oldValueSet
;
nsresult
rv
=
mAttrs
.
SetAndSwapAttr
(
nsGkAtoms
:
:
style
attrValue
&
oldValueSet
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
return
NS_OK
;
}
nsICSSDeclaration
*
nsStyledElement
:
:
GetExistingStyle
(
)
{
Element
:
:
nsDOMSlots
*
slots
=
GetExistingDOMSlots
(
)
;
if
(
!
slots
)
{
return
nullptr
;
}
return
slots
-
>
mStyle
;
}
void
nsStyledElement
:
:
ParseStyleAttribute
(
const
nsAString
&
aValue
nsIPrincipal
*
aMaybeScriptedPrincipal
nsAttrValue
&
aResult
bool
aForceInDataDoc
)
{
Document
*
doc
=
OwnerDoc
(
)
;
bool
isNativeAnon
=
IsInNativeAnonymousSubtree
(
)
;
if
(
!
isNativeAnon
&
&
!
nsStyleUtil
:
:
CSPAllowsInlineStyle
(
this
doc
aMaybeScriptedPrincipal
0
1
aValue
nullptr
)
)
{
return
;
}
if
(
aForceInDataDoc
|
|
!
doc
-
>
IsLoadedAsData
(
)
|
|
GetExistingStyle
(
)
|
|
doc
-
>
IsStaticDocument
(
)
)
{
bool
isCSS
=
true
;
if
(
!
isNativeAnon
)
{
nsAutoString
styleType
;
doc
-
>
GetHeaderData
(
nsGkAtoms
:
:
headerContentStyleType
styleType
)
;
if
(
!
styleType
.
IsEmpty
(
)
)
{
isCSS
=
StringBeginsWith
(
styleType
u
"
text
/
css
"
_ns
nsASCIICaseInsensitiveStringComparator
)
;
}
}
if
(
isCSS
&
&
aResult
.
ParseStyleAttribute
(
aValue
aMaybeScriptedPrincipal
this
)
)
{
return
;
}
}
aResult
.
SetTo
(
aValue
)
;
}
nsresult
nsStyledElement
:
:
BindToTree
(
BindContext
&
aContext
nsINode
&
aParent
)
{
nsresult
rv
=
nsStyledElementBase
:
:
BindToTree
(
aContext
aParent
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
HasAttr
(
nsGkAtoms
:
:
autofocus
)
&
&
aContext
.
AllowsAutoFocus
(
)
&
&
(
!
IsSVGElement
(
)
|
|
IsFocusableWithoutStyle
(
)
)
)
{
aContext
.
OwnerDoc
(
)
.
ElementWithAutoFocusInserted
(
this
)
;
}
return
NS_OK
;
}
