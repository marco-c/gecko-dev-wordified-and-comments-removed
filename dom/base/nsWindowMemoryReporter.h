#
ifndef
nsWindowMemoryReporter_h__
#
define
nsWindowMemoryReporter_h__
#
include
"
nsGlobalWindow
.
h
"
#
include
"
nsIMemoryReporter
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
PodOperations
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsArenaMemoryStats
.
h
"
class
nsWindowSizes
{
#
define
FOR_EACH_SIZE
(
macro
)
\
macro
(
DOM
mDOMElementNodesSize
)
\
macro
(
DOM
mDOMTextNodesSize
)
\
macro
(
DOM
mDOMCDATANodesSize
)
\
macro
(
DOM
mDOMCommentNodesSize
)
\
macro
(
DOM
mDOMEventTargetsSize
)
\
macro
(
DOM
mDOMPerformanceUserEntries
)
\
macro
(
DOM
mDOMPerformanceResourceEntries
)
\
macro
(
DOM
mDOMOtherSize
)
\
macro
(
Style
mStyleSheetsSize
)
\
macro
(
Other
mLayoutPresShellSize
)
\
macro
(
Style
mLayoutStyleSetsSize
)
\
macro
(
Other
mLayoutTextRunsSize
)
\
macro
(
Other
mLayoutPresContextSize
)
\
macro
(
Other
mLayoutFramePropertiesSize
)
\
macro
(
Other
mPropertyTablesSize
)
\
public
:
explicit
nsWindowSizes
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
:
#
define
ZERO_SIZE
(
kind
mSize
)
mSize
(
0
)
FOR_EACH_SIZE
(
ZERO_SIZE
)
#
undef
ZERO_SIZE
mDOMEventTargetsCount
(
0
)
mDOMEventListenersCount
(
0
)
mArenaStats
(
)
mMallocSizeOf
(
aMallocSizeOf
)
{
}
void
addToTabSizes
(
nsTabSizes
*
sizes
)
const
{
#
define
ADD_TO_TAB_SIZES
(
kind
mSize
)
sizes
-
>
add
(
nsTabSizes
:
:
kind
mSize
)
;
FOR_EACH_SIZE
(
ADD_TO_TAB_SIZES
)
#
undef
ADD_TO_TAB_SIZES
mArenaStats
.
addToTabSizes
(
sizes
)
;
}
size_t
getTotalSize
(
)
const
{
size_t
total
=
0
;
#
define
ADD_TO_TOTAL_SIZE
(
kind
mSize
)
total
+
=
mSize
;
FOR_EACH_SIZE
(
ADD_TO_TOTAL_SIZE
)
#
undef
ADD_TO_TOTAL_SIZE
total
+
=
mArenaStats
.
getTotalSize
(
)
;
return
total
;
}
#
define
DECL_SIZE
(
kind
mSize
)
size_t
mSize
;
FOR_EACH_SIZE
(
DECL_SIZE
)
;
#
undef
DECL_SIZE
uint32_t
mDOMEventTargetsCount
;
uint32_t
mDOMEventListenersCount
;
nsArenaMemoryStats
mArenaStats
;
mozilla
:
:
MallocSizeOf
mMallocSizeOf
;
#
undef
FOR_EACH_SIZE
}
;
class
nsWindowMemoryReporter
final
:
public
nsIMemoryReporter
public
nsIObserver
public
nsSupportsWeakReference
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIMEMORYREPORTER
NS_DECL_NSIOBSERVER
static
void
Init
(
)
;
#
ifdef
DEBUG
static
void
UnlinkGhostWindows
(
)
;
#
endif
static
nsWindowMemoryReporter
*
Get
(
)
;
void
ObserveDOMWindowDetached
(
nsGlobalWindow
*
aWindow
)
;
static
int64_t
GhostWindowsDistinguishedAmount
(
)
;
private
:
~
nsWindowMemoryReporter
(
)
;
nsWindowMemoryReporter
(
)
;
uint32_t
GetGhostTimeout
(
)
;
void
ObserveAfterMinimizeMemoryUsage
(
)
;
void
CheckForGhostWindows
(
nsTHashtable
<
nsUint64HashKey
>
*
aOutGhostIDs
=
nullptr
)
;
void
AsyncCheckForGhostWindows
(
)
;
void
KillCheckTimer
(
)
;
static
void
CheckTimerFired
(
nsITimer
*
aTimer
void
*
aClosure
)
;
nsDataHashtable
<
nsISupportsHashKey
mozilla
:
:
TimeStamp
>
mDetachedWindows
;
mozilla
:
:
TimeStamp
mLastCheckForGhostWindows
;
nsCOMPtr
<
nsITimer
>
mCheckTimer
;
bool
mCycleCollectorIsRunning
;
bool
mCheckTimerWaitingForCCEnd
;
int64_t
mGhostWindowCount
;
}
;
#
endif
