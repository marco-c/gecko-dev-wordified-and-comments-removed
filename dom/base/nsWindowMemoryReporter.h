#
ifndef
nsWindowMemoryReporter_h__
#
define
nsWindowMemoryReporter_h__
#
include
"
nsGlobalWindow
.
h
"
#
include
"
nsIMemoryReporter
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
PodOperations
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
class
nsWindowMemoryReporter
final
:
public
nsIMemoryReporter
public
nsIObserver
public
nsSupportsWeakReference
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIMEMORYREPORTER
NS_DECL_NSIOBSERVER
static
void
Init
(
)
;
#
ifdef
DEBUG
static
void
UnlinkGhostWindows
(
)
;
#
endif
static
nsWindowMemoryReporter
*
Get
(
)
;
void
ObserveDOMWindowDetached
(
nsGlobalWindow
*
aWindow
)
;
static
int64_t
GhostWindowsDistinguishedAmount
(
)
;
private
:
~
nsWindowMemoryReporter
(
)
;
nsWindowMemoryReporter
(
)
;
uint32_t
GetGhostTimeout
(
)
;
void
ObserveAfterMinimizeMemoryUsage
(
)
;
void
CheckForGhostWindows
(
nsTHashtable
<
nsUint64HashKey
>
*
aOutGhostIDs
=
nullptr
)
;
void
AsyncCheckForGhostWindows
(
)
;
void
KillCheckTimer
(
)
;
static
void
CheckTimerFired
(
nsITimer
*
aTimer
void
*
aClosure
)
;
nsDataHashtable
<
nsISupportsHashKey
mozilla
:
:
TimeStamp
>
mDetachedWindows
;
mozilla
:
:
TimeStamp
mLastCheckForGhostWindows
;
nsCOMPtr
<
nsITimer
>
mCheckTimer
;
bool
mCycleCollectorIsRunning
;
bool
mCheckTimerWaitingForCCEnd
;
int64_t
mGhostWindowCount
;
}
;
#
endif
