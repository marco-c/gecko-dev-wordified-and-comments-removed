#
include
"
PostMessageEvent
.
h
"
#
include
"
MessageEvent
.
h
"
#
include
"
mozilla
/
dom
/
BlobBinding
.
h
"
#
include
"
mozilla
/
dom
/
FileList
.
h
"
#
include
"
mozilla
/
dom
/
FileListBinding
.
h
"
#
include
"
mozilla
/
dom
/
MessagePort
.
h
"
#
include
"
mozilla
/
dom
/
MessagePortBinding
.
h
"
#
include
"
mozilla
/
dom
/
PMessagePort
.
h
"
#
include
"
mozilla
/
dom
/
StructuredCloneTags
.
h
"
#
include
"
mozilla
/
EventDispatcher
.
h
"
#
include
"
nsGlobalWindow
.
h
"
#
include
"
nsIPresShell
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsPresContext
.
h
"
namespace
mozilla
{
namespace
dom
{
PostMessageEvent
:
:
PostMessageEvent
(
nsGlobalWindow
*
aSource
const
nsAString
&
aCallerOrigin
nsGlobalWindow
*
aTargetWindow
nsIPrincipal
*
aProvidedPrincipal
bool
aTrustedCaller
)
:
StructuredCloneHelper
(
CloningSupported
TransferringSupported
SameProcessSameThread
)
mSource
(
aSource
)
mCallerOrigin
(
aCallerOrigin
)
mTargetWindow
(
aTargetWindow
)
mProvidedPrincipal
(
aProvidedPrincipal
)
mTrustedCaller
(
aTrustedCaller
)
{
MOZ_COUNT_CTOR
(
PostMessageEvent
)
;
}
PostMessageEvent
:
:
~
PostMessageEvent
(
)
{
MOZ_COUNT_DTOR
(
PostMessageEvent
)
;
}
NS_IMETHODIMP
PostMessageEvent
:
:
Run
(
)
{
MOZ_ASSERT
(
mTargetWindow
-
>
IsOuterWindow
(
)
"
should
have
been
passed
an
outer
window
!
"
)
;
MOZ_ASSERT
(
!
mSource
|
|
mSource
-
>
IsOuterWindow
(
)
"
should
have
been
passed
an
outer
window
!
"
)
;
AutoJSAPI
jsapi
;
jsapi
.
Init
(
)
;
JSContext
*
cx
=
jsapi
.
cx
(
)
;
nsRefPtr
<
nsGlobalWindow
>
targetWindow
;
if
(
mTargetWindow
-
>
IsClosedOrClosing
(
)
|
|
!
(
targetWindow
=
mTargetWindow
-
>
GetCurrentInnerWindowInternal
(
)
)
|
|
targetWindow
-
>
IsClosedOrClosing
(
)
)
return
NS_OK
;
MOZ_ASSERT
(
targetWindow
-
>
IsInnerWindow
(
)
"
we
ordered
an
inner
window
!
"
)
;
JSAutoCompartment
ac
(
cx
targetWindow
-
>
GetWrapperPreserveColor
(
)
)
;
if
(
mProvidedPrincipal
)
{
nsIPrincipal
*
targetPrin
=
targetWindow
-
>
GetPrincipal
(
)
;
if
(
NS_WARN_IF
(
!
targetPrin
)
)
return
NS_OK
;
if
(
!
targetPrin
-
>
Equals
(
mProvidedPrincipal
)
)
{
return
NS_OK
;
}
}
ErrorResult
rv
;
JS
:
:
Rooted
<
JS
:
:
Value
>
messageData
(
cx
)
;
nsCOMPtr
<
nsPIDOMWindow
>
window
=
targetWindow
.
get
(
)
;
Read
(
window
cx
&
messageData
rv
)
;
if
(
NS_WARN_IF
(
rv
.
Failed
(
)
)
)
{
return
rv
.
StealNSResult
(
)
;
}
nsCOMPtr
<
mozilla
:
:
dom
:
:
EventTarget
>
eventTarget
=
do_QueryInterface
(
static_cast
<
nsPIDOMWindow
*
>
(
targetWindow
.
get
(
)
)
)
;
nsRefPtr
<
MessageEvent
>
event
=
new
MessageEvent
(
eventTarget
nullptr
nullptr
)
;
event
-
>
InitMessageEvent
(
NS_LITERAL_STRING
(
"
message
"
)
false
false
messageData
mCallerOrigin
EmptyString
(
)
mSource
)
;
nsTArray
<
nsRefPtr
<
MessagePortBase
>
>
ports
;
TakeTransferredPorts
(
ports
)
;
event
-
>
SetPorts
(
new
MessagePortList
(
static_cast
<
dom
:
:
Event
*
>
(
event
.
get
(
)
)
ports
)
)
;
nsIPresShell
*
shell
=
targetWindow
-
>
GetExtantDoc
(
)
-
>
GetShell
(
)
;
nsRefPtr
<
nsPresContext
>
presContext
;
if
(
shell
)
presContext
=
shell
-
>
GetPresContext
(
)
;
event
-
>
SetTrusted
(
mTrustedCaller
)
;
WidgetEvent
*
internalEvent
=
event
-
>
GetInternalNSEvent
(
)
;
nsEventStatus
status
=
nsEventStatus_eIgnore
;
EventDispatcher
:
:
Dispatch
(
static_cast
<
nsPIDOMWindow
*
>
(
mTargetWindow
)
presContext
internalEvent
static_cast
<
dom
:
:
Event
*
>
(
event
.
get
(
)
)
&
status
)
;
return
NS_OK
;
}
}
}
