#
include
"
PostMessageEvent
.
h
"
#
include
"
MessageEvent
.
h
"
#
include
"
mozilla
/
dom
/
BlobBinding
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
BrowsingContextGroup
.
h
"
#
include
"
mozilla
/
dom
/
DocGroup
.
h
"
#
include
"
mozilla
/
dom
/
DocumentInlines
.
h
"
#
include
"
mozilla
/
dom
/
File
.
h
"
#
include
"
mozilla
/
dom
/
FileList
.
h
"
#
include
"
mozilla
/
dom
/
FileListBinding
.
h
"
#
include
"
mozilla
/
dom
/
MessageEventBinding
.
h
"
#
include
"
mozilla
/
dom
/
MessagePort
.
h
"
#
include
"
mozilla
/
dom
/
MessagePortBinding
.
h
"
#
include
"
mozilla
/
dom
/
PMessagePort
.
h
"
#
include
"
mozilla
/
dom
/
StructuredCloneTags
.
h
"
#
include
"
mozilla
/
dom
/
UnionConversions
.
h
"
#
include
"
mozilla
/
EventDispatcher
.
h
"
#
include
"
mozilla
/
StaticPrefs_dom
.
h
"
#
include
"
nsDocShell
.
h
"
#
include
"
nsGlobalWindow
.
h
"
#
include
"
nsIConsoleService
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsIScriptError
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsQueryObject
.
h
"
namespace
mozilla
{
namespace
dom
{
PostMessageEvent
:
:
PostMessageEvent
(
BrowsingContext
*
aSource
const
nsAString
&
aCallerOrigin
nsGlobalWindowOuter
*
aTargetWindow
nsIPrincipal
*
aProvidedPrincipal
const
Maybe
<
uint64_t
>
&
aCallerWindowID
nsIURI
*
aCallerDocumentURI
bool
aIsFromPrivateWindow
const
Maybe
<
nsID
>
&
aCallerAgentClusterId
)
:
Runnable
(
"
dom
:
:
PostMessageEvent
"
)
mSource
(
aSource
)
mCallerOrigin
(
aCallerOrigin
)
mTargetWindow
(
aTargetWindow
)
mProvidedPrincipal
(
aProvidedPrincipal
)
mCallerWindowID
(
aCallerWindowID
)
mCallerAgentClusterId
(
aCallerAgentClusterId
)
mCallerDocumentURI
(
aCallerDocumentURI
)
mIsFromPrivateWindow
(
aIsFromPrivateWindow
)
{
}
PostMessageEvent
:
:
~
PostMessageEvent
(
)
{
}
NS_IMETHODIMP
PostMessageEvent
:
:
Run
(
)
{
AutoJSAPI
jsapi
;
jsapi
.
Init
(
)
;
JSContext
*
cx
=
jsapi
.
cx
(
)
;
nsCOMPtr
<
nsIURI
>
callerDocumentURI
=
mCallerDocumentURI
.
forget
(
)
;
RefPtr
<
nsGlobalWindowInner
>
targetWindow
;
if
(
mTargetWindow
-
>
IsClosedOrClosing
(
)
|
|
!
(
targetWindow
=
mTargetWindow
-
>
GetCurrentInnerWindowInternal
(
)
)
|
|
targetWindow
-
>
IsDying
(
)
)
return
NS_OK
;
if
(
nsCOMPtr
<
nsPIDOMWindowOuter
>
topWindow
=
targetWindow
-
>
GetOuterWindow
(
)
-
>
GetInProcessTop
(
)
)
{
if
(
nsCOMPtr
<
nsPIDOMWindowInner
>
topInner
=
topWindow
-
>
GetCurrentInnerWindow
(
)
)
{
if
(
topInner
-
>
GetExtantDoc
(
)
&
&
topInner
-
>
GetExtantDoc
(
)
-
>
SuspendPostMessageEvent
(
this
)
)
{
return
NS_OK
;
}
}
}
JSAutoRealm
ar
(
cx
targetWindow
-
>
GetWrapper
(
)
)
;
if
(
mProvidedPrincipal
)
{
nsIPrincipal
*
targetPrin
=
targetWindow
-
>
GetPrincipal
(
)
;
if
(
NS_WARN_IF
(
!
targetPrin
)
)
return
NS_OK
;
if
(
!
targetPrin
-
>
Equals
(
mProvidedPrincipal
)
)
{
OriginAttributes
sourceAttrs
=
mProvidedPrincipal
-
>
OriginAttributesRef
(
)
;
OriginAttributes
targetAttrs
=
targetPrin
-
>
OriginAttributesRef
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sourceAttrs
.
mUserContextId
=
=
targetAttrs
.
mUserContextId
"
Target
and
source
should
have
the
same
userContextId
attribute
.
"
)
;
nsAutoString
providedOrigin
targetOrigin
;
nsresult
rv
=
nsContentUtils
:
:
GetUTFOrigin
(
targetPrin
targetOrigin
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
rv
=
nsContentUtils
:
:
GetUTFOrigin
(
mProvidedPrincipal
providedOrigin
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsAutoString
errorText
;
nsContentUtils
:
:
FormatLocalizedString
(
errorText
nsContentUtils
:
:
eDOM_PROPERTIES
"
TargetPrincipalDoesNotMatch
"
providedOrigin
targetOrigin
)
;
nsCOMPtr
<
nsIScriptError
>
errorObject
=
do_CreateInstance
(
NS_SCRIPTERROR_CONTRACTID
&
rv
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
mCallerWindowID
.
isSome
(
)
)
{
rv
=
errorObject
-
>
InitWithSourceURI
(
errorText
callerDocumentURI
EmptyString
(
)
0
0
nsIScriptError
:
:
errorFlag
"
DOM
Window
"
mCallerWindowID
.
value
(
)
)
;
}
else
{
nsString
uriSpec
;
rv
=
NS_GetSanitizedURIStringFromURI
(
callerDocumentURI
uriSpec
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
rv
=
errorObject
-
>
Init
(
errorText
uriSpec
EmptyString
(
)
0
0
nsIScriptError
:
:
errorFlag
"
DOM
Window
"
mIsFromPrivateWindow
nsContentUtils
:
:
IsSystemPrincipal
(
mProvidedPrincipal
)
)
;
}
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsCOMPtr
<
nsIConsoleService
>
consoleService
=
do_GetService
(
NS_CONSOLESERVICE_CONTRACTID
&
rv
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
return
consoleService
-
>
LogMessage
(
errorObject
)
;
}
}
IgnoredErrorResult
rv
;
JS
:
:
Rooted
<
JS
:
:
Value
>
messageData
(
cx
)
;
nsCOMPtr
<
mozilla
:
:
dom
:
:
EventTarget
>
eventTarget
=
do_QueryObject
(
targetWindow
)
;
JS
:
:
CloneDataPolicy
cloneDataPolicy
;
MOZ_DIAGNOSTIC_ASSERT
(
targetWindow
)
;
if
(
mCallerAgentClusterId
.
isSome
(
)
&
&
targetWindow
-
>
GetDocGroup
(
)
&
&
targetWindow
-
>
GetDocGroup
(
)
-
>
AgentClusterId
(
)
.
Equals
(
mCallerAgentClusterId
.
ref
(
)
)
)
{
cloneDataPolicy
.
allowSharedMemory
(
)
;
}
StructuredCloneHolder
*
holder
;
if
(
mHolder
.
constructed
<
StructuredCloneHolder
>
(
)
)
{
mHolder
.
ref
<
StructuredCloneHolder
>
(
)
.
Read
(
targetWindow
-
>
AsGlobal
(
)
cx
&
messageData
cloneDataPolicy
rv
)
;
holder
=
&
mHolder
.
ref
<
StructuredCloneHolder
>
(
)
;
}
else
{
MOZ_ASSERT
(
mHolder
.
constructed
<
ipc
:
:
StructuredCloneData
>
(
)
)
;
mHolder
.
ref
<
ipc
:
:
StructuredCloneData
>
(
)
.
Read
(
cx
&
messageData
rv
)
;
holder
=
&
mHolder
.
ref
<
ipc
:
:
StructuredCloneData
>
(
)
;
}
if
(
NS_WARN_IF
(
rv
.
Failed
(
)
)
)
{
DispatchError
(
cx
targetWindow
eventTarget
)
;
return
NS_OK
;
}
RefPtr
<
MessageEvent
>
event
=
new
MessageEvent
(
eventTarget
nullptr
nullptr
)
;
Nullable
<
WindowProxyOrMessagePortOrServiceWorker
>
source
;
if
(
mSource
)
{
source
.
SetValue
(
)
.
SetAsWindowProxy
(
)
=
mSource
;
}
Sequence
<
OwningNonNull
<
MessagePort
>
>
ports
;
if
(
!
holder
-
>
TakeTransferredPortsAsSequence
(
ports
)
)
{
DispatchError
(
cx
targetWindow
eventTarget
)
;
return
NS_OK
;
}
event
-
>
InitMessageEvent
(
nullptr
NS_LITERAL_STRING
(
"
message
"
)
CanBubble
:
:
eNo
Cancelable
:
:
eNo
messageData
mCallerOrigin
EmptyString
(
)
source
ports
)
;
Dispatch
(
targetWindow
event
)
;
return
NS_OK
;
}
void
PostMessageEvent
:
:
DispatchError
(
JSContext
*
aCx
nsGlobalWindowInner
*
aTargetWindow
mozilla
:
:
dom
:
:
EventTarget
*
aEventTarget
)
{
RootedDictionary
<
MessageEventInit
>
init
(
aCx
)
;
init
.
mBubbles
=
false
;
init
.
mCancelable
=
false
;
init
.
mOrigin
=
mCallerOrigin
;
if
(
mSource
)
{
init
.
mSource
.
SetValue
(
)
.
SetAsWindowProxy
(
)
=
mSource
;
}
RefPtr
<
Event
>
event
=
MessageEvent
:
:
Constructor
(
aEventTarget
NS_LITERAL_STRING
(
"
messageerror
"
)
init
)
;
Dispatch
(
aTargetWindow
event
)
;
}
void
PostMessageEvent
:
:
Dispatch
(
nsGlobalWindowInner
*
aTargetWindow
Event
*
aEvent
)
{
RefPtr
<
nsPresContext
>
presContext
=
aTargetWindow
-
>
GetExtantDoc
(
)
-
>
GetPresContext
(
)
;
aEvent
-
>
SetTrusted
(
true
)
;
WidgetEvent
*
internalEvent
=
aEvent
-
>
WidgetEventPtr
(
)
;
nsEventStatus
status
=
nsEventStatus_eIgnore
;
EventDispatcher
:
:
Dispatch
(
ToSupports
(
aTargetWindow
)
presContext
internalEvent
aEvent
&
status
)
;
}
void
PostMessageEvent
:
:
DispatchToTargetThread
(
ErrorResult
&
aError
)
{
nsCOMPtr
<
nsIRunnable
>
event
=
this
;
if
(
StaticPrefs
:
:
dom_separate_event_queue_for_post_message_enabled
(
)
&
&
!
DocGroup
:
:
TryToLoadIframesInBackground
(
)
)
{
BrowsingContext
*
bc
=
mTargetWindow
-
>
GetBrowsingContext
(
)
;
bc
=
bc
?
bc
-
>
Top
(
)
:
nullptr
;
if
(
bc
&
&
bc
-
>
IsLoading
(
)
)
{
aError
=
bc
-
>
Group
(
)
-
>
QueuePostMessageEvent
(
event
.
forget
(
)
)
;
return
;
}
}
if
(
DocGroup
:
:
TryToLoadIframesInBackground
(
)
)
{
RefPtr
<
nsIDocShell
>
docShell
=
mTargetWindow
-
>
GetDocShell
(
)
;
RefPtr
<
nsDocShell
>
dShell
=
nsDocShell
:
:
Cast
(
docShell
)
;
if
(
dShell
)
{
if
(
!
dShell
-
>
TreatAsBackgroundLoad
(
)
)
{
BrowsingContext
*
bc
=
mTargetWindow
-
>
GetBrowsingContext
(
)
;
bc
=
bc
?
bc
-
>
Top
(
)
:
nullptr
;
if
(
bc
&
&
bc
-
>
IsLoading
(
)
)
{
aError
=
bc
-
>
Group
(
)
-
>
QueuePostMessageEvent
(
event
.
forget
(
)
)
;
return
;
}
}
else
if
(
mTargetWindow
-
>
GetExtantDoc
(
)
&
&
mTargetWindow
-
>
GetExtantDoc
(
)
-
>
GetReadyStateEnum
(
)
<
Document
:
:
READYSTATE_COMPLETE
)
{
mozilla
:
:
dom
:
:
DocGroup
*
docGroup
=
mTargetWindow
-
>
GetDocGroup
(
)
;
aError
=
docGroup
-
>
QueueIframePostMessages
(
event
.
forget
(
)
dShell
-
>
GetOuterWindowID
(
)
)
;
return
;
}
}
}
aError
=
mTargetWindow
-
>
Dispatch
(
TaskCategory
:
:
Other
event
.
forget
(
)
)
;
}
}
}
