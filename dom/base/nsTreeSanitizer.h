#
ifndef
nsTreeSanitizer_h_
#
define
nsTreeSanitizer_h_
#
include
"
nsAtom
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsHashtablesFwd
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsTHashSet
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
dom
/
SanitizerBinding
.
h
"
class
nsIContent
;
class
nsINode
;
namespace
mozilla
{
class
DeclarationBlock
;
enum
class
StyleSanitizationKind
:
uint8_t
;
}
namespace
mozilla
:
:
dom
{
class
DocumentFragment
;
class
Element
;
}
class
nsTreeSanitizer
{
public
:
explicit
nsTreeSanitizer
(
uint32_t
aFlags
=
0
)
;
static
void
InitializeStatics
(
)
;
static
void
ReleaseStatics
(
)
;
void
Sanitize
(
mozilla
:
:
dom
:
:
DocumentFragment
*
aFragment
)
;
void
Sanitize
(
mozilla
:
:
dom
:
:
Document
*
aDocument
)
;
void
WithWebSanitizerOptions
(
const
mozilla
:
:
dom
:
:
SanitizerConfig
&
aOptions
)
;
static
void
RemoveConditionalCSSFromSubtree
(
nsINode
*
aRoot
)
;
private
:
bool
mAllowStyles
;
bool
mAllowComments
;
bool
mDropNonCSSPresentation
;
bool
mDropForms
;
bool
mCidEmbedsOnly
;
bool
mDropMedia
;
bool
mFullDocument
;
bool
mLogRemovals
;
class
AtomsTable
:
public
nsTHashSet
<
const
nsStaticAtom
*
>
{
public
:
explicit
AtomsTable
(
uint32_t
aLength
)
:
nsTHashSet
<
const
nsStaticAtom
*
>
(
aLength
)
{
}
bool
Contains
(
nsAtom
*
aAtom
)
{
return
aAtom
-
>
IsStatic
(
)
&
&
GetEntry
(
aAtom
-
>
AsStatic
(
)
)
;
}
}
;
class
DynamicAtomsTable
:
public
nsTHashSet
<
RefPtr
<
nsAtom
>
>
{
public
:
explicit
DynamicAtomsTable
(
uint32_t
aLength
)
:
nsTHashSet
<
RefPtr
<
nsAtom
>
>
(
aLength
)
{
}
bool
Contains
(
nsAtom
*
aAtom
)
{
return
GetEntry
(
aAtom
)
;
}
}
;
void
SanitizeChildren
(
nsINode
*
aRoot
)
;
bool
MustFlatten
(
int32_t
aNamespace
nsAtom
*
aLocal
)
;
bool
MustFlattenForSanitizerAPI
(
int32_t
aNamespace
nsAtom
*
aLocal
)
;
bool
MustPrune
(
int32_t
aNamespace
nsAtom
*
aLocal
mozilla
:
:
dom
:
:
Element
*
aElement
)
;
bool
MustPruneForSanitizerAPI
(
int32_t
aNamespace
nsAtom
*
aLocal
mozilla
:
:
dom
:
:
Element
*
aElement
)
;
bool
IsURL
(
const
nsStaticAtom
*
const
*
aURLs
nsAtom
*
aLocalName
)
;
struct
AllowedAttributes
{
AtomsTable
*
mNames
=
nullptr
;
const
nsStaticAtom
*
const
*
mURLs
=
nullptr
;
bool
mXLink
=
false
;
bool
mStyle
=
false
;
bool
mDangerousSrc
=
false
;
}
;
void
SanitizeAttributes
(
mozilla
:
:
dom
:
:
Element
*
aElement
AllowedAttributes
aAllowed
)
;
bool
SanitizeURL
(
mozilla
:
:
dom
:
:
Element
*
aElement
int32_t
aNamespace
nsAtom
*
aLocalName
bool
aFragmentsOnly
=
false
)
;
bool
SanitizeStyleDeclaration
(
mozilla
:
:
DeclarationBlock
*
aDeclaration
)
;
static
bool
SanitizeInlineStyle
(
mozilla
:
:
dom
:
:
Element
*
mozilla
:
:
StyleSanitizationKind
)
;
static
void
RemoveAllAttributes
(
mozilla
:
:
dom
:
:
Element
*
aElement
)
;
static
void
RemoveAllAttributesFromDescendants
(
mozilla
:
:
dom
:
:
Element
*
)
;
void
LogMessage
(
const
char
*
aMessage
mozilla
:
:
dom
:
:
Document
*
aDoc
mozilla
:
:
dom
:
:
Element
*
aElement
=
nullptr
nsAtom
*
aAttr
=
nullptr
)
;
static
AtomsTable
*
sElementsHTML
;
static
AtomsTable
*
sAttributesHTML
;
static
AtomsTable
*
sPresAttributesHTML
;
static
AtomsTable
*
sElementsSVG
;
static
AtomsTable
*
sAttributesSVG
;
static
AtomsTable
*
sElementsMathML
;
static
AtomsTable
*
sAttributesMathML
;
static
AtomsTable
*
sBaselineElementAllowlist
;
static
AtomsTable
*
sDefaultConfigurationElementAllowlist
;
static
nsIPrincipal
*
sNullPrincipal
;
bool
mIsForSanitizerAPI
=
false
;
mozilla
:
:
UniquePtr
<
DynamicAtomsTable
>
mAllowElements
;
mozilla
:
:
UniquePtr
<
DynamicAtomsTable
>
mBlockElements
;
mozilla
:
:
UniquePtr
<
DynamicAtomsTable
>
mDropElements
;
using
ElementToAttributeSetTable
=
nsTHashMap
<
RefPtr
<
nsAtom
>
mozilla
:
:
UniquePtr
<
DynamicAtomsTable
>
>
;
mozilla
:
:
UniquePtr
<
ElementToAttributeSetTable
>
mAllowedAttributes
;
mozilla
:
:
UniquePtr
<
ElementToAttributeSetTable
>
mDroppedAttributes
;
}
;
#
endif
