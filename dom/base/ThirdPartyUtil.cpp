#
include
"
ThirdPartyUtil
.
h
"
#
include
"
nsGlobalWindowOuter
.
h
"
#
include
"
nsNetCID
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsIChannel
.
h
"
#
include
"
nsIServiceManager
.
h
"
#
include
"
nsIHttpChannelInternal
.
h
"
#
include
"
nsIDOMWindow
.
h
"
#
include
"
nsILoadContext
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsIScriptObjectPrincipal
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsReadableUtils
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsGlobalWindowOuter
.
h
"
NS_IMPL_ISUPPORTS
(
ThirdPartyUtil
mozIThirdPartyUtil
)
static
mozilla
:
:
LazyLogModule
gThirdPartyLog
(
"
thirdPartyUtil
"
)
;
#
undef
LOG
#
define
LOG
(
args
)
MOZ_LOG
(
gThirdPartyLog
mozilla
:
:
LogLevel
:
:
Debug
args
)
static
mozilla
:
:
StaticRefPtr
<
ThirdPartyUtil
>
gService
;
void
ThirdPartyUtil
:
:
Startup
(
)
{
nsCOMPtr
<
mozIThirdPartyUtil
>
tpu
;
if
(
NS_WARN_IF
(
!
(
tpu
=
do_GetService
(
THIRDPARTYUTIL_CONTRACTID
)
)
)
)
{
NS_WARNING
(
"
Failed
to
get
third
party
util
!
"
)
;
}
}
nsresult
ThirdPartyUtil
:
:
Init
(
)
{
NS_ENSURE_TRUE
(
NS_IsMainThread
(
)
NS_ERROR_NOT_AVAILABLE
)
;
MOZ_ASSERT
(
!
gService
)
;
gService
=
this
;
mozilla
:
:
ClearOnShutdown
(
&
gService
)
;
mTLDService
=
nsEffectiveTLDService
:
:
GetInstance
(
)
;
return
mTLDService
?
NS_OK
:
NS_ERROR_FAILURE
;
}
ThirdPartyUtil
:
:
~
ThirdPartyUtil
(
)
{
gService
=
nullptr
;
}
ThirdPartyUtil
*
ThirdPartyUtil
:
:
GetInstance
(
)
{
if
(
gService
)
{
return
gService
;
}
nsCOMPtr
<
mozIThirdPartyUtil
>
tpuService
=
mozilla
:
:
services
:
:
GetThirdPartyUtil
(
)
;
if
(
!
tpuService
)
{
return
nullptr
;
}
MOZ_ASSERT
(
gService
"
gService
must
have
been
initialized
in
nsEffectiveTLDService
:
:
Init
"
)
;
return
gService
;
}
nsresult
ThirdPartyUtil
:
:
IsThirdPartyInternal
(
const
nsCString
&
aFirstDomain
nsIURI
*
aSecondURI
bool
*
aResult
)
{
if
(
!
aSecondURI
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsAutoCString
secondDomain
;
nsresult
rv
=
GetBaseDomain
(
aSecondURI
secondDomain
)
;
LOG
(
(
"
ThirdPartyUtil
:
:
IsThirdPartyInternal
%
s
=
?
%
s
"
aFirstDomain
.
get
(
)
secondDomain
.
get
(
)
)
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
*
aResult
=
IsThirdPartyInternal
(
aFirstDomain
secondDomain
)
;
return
NS_OK
;
}
nsCString
ThirdPartyUtil
:
:
GetBaseDomainFromWindow
(
nsPIDOMWindowOuter
*
aWindow
)
{
mozilla
:
:
dom
:
:
Document
*
doc
=
aWindow
?
aWindow
-
>
GetExtantDoc
(
)
:
nullptr
;
if
(
!
doc
)
{
return
EmptyCString
(
)
;
}
return
doc
-
>
GetBaseDomain
(
)
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
GetPrincipalFromWindow
(
mozIDOMWindowProxy
*
aWin
nsIPrincipal
*
*
result
)
{
nsCOMPtr
<
nsIScriptObjectPrincipal
>
scriptObjPrin
=
do_QueryInterface
(
aWin
)
;
if
(
!
scriptObjPrin
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
nsIPrincipal
>
prin
=
scriptObjPrin
-
>
GetPrincipal
(
)
;
if
(
!
prin
)
{
return
NS_ERROR_INVALID_ARG
;
}
prin
.
forget
(
result
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
GetURIFromWindow
(
mozIDOMWindowProxy
*
aWin
nsIURI
*
*
result
)
{
nsCOMPtr
<
nsIPrincipal
>
prin
;
nsresult
rv
=
GetPrincipalFromWindow
(
aWin
getter_AddRefs
(
prin
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
if
(
prin
-
>
GetIsNullPrincipal
(
)
)
{
LOG
(
(
"
ThirdPartyUtil
:
:
GetURIFromWindow
can
'
t
use
null
principal
\
n
"
)
)
;
return
NS_ERROR_INVALID_ARG
;
}
rv
=
prin
-
>
GetURI
(
result
)
;
return
rv
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
IsThirdPartyURI
(
nsIURI
*
aFirstURI
nsIURI
*
aSecondURI
bool
*
aResult
)
{
NS_ENSURE_ARG
(
aFirstURI
)
;
NS_ENSURE_ARG
(
aSecondURI
)
;
NS_ASSERTION
(
aResult
"
null
outparam
pointer
"
)
;
nsAutoCString
firstHost
;
nsresult
rv
=
GetBaseDomain
(
aFirstURI
firstHost
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
return
IsThirdPartyInternal
(
firstHost
aSecondURI
aResult
)
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
IsThirdPartyWindow
(
mozIDOMWindowProxy
*
aWindow
nsIURI
*
aURI
bool
*
aResult
)
{
NS_ENSURE_ARG
(
aWindow
)
;
NS_ASSERTION
(
aResult
"
null
outparam
pointer
"
)
;
bool
result
;
nsCString
bottomDomain
=
GetBaseDomainFromWindow
(
nsPIDOMWindowOuter
:
:
From
(
aWindow
)
)
;
if
(
bottomDomain
.
IsEmpty
(
)
)
{
nsCOMPtr
<
nsIURI
>
currentURI
;
nsresult
rv
=
GetURIFromWindow
(
aWindow
getter_AddRefs
(
currentURI
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
GetBaseDomain
(
currentURI
bottomDomain
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
}
if
(
aURI
&
&
!
NS_IsAboutBlank
(
aURI
)
)
{
nsresult
rv
=
IsThirdPartyInternal
(
bottomDomain
aURI
&
result
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
if
(
result
)
{
*
aResult
=
true
;
return
NS_OK
;
}
}
nsPIDOMWindowOuter
*
current
=
nsPIDOMWindowOuter
:
:
From
(
aWindow
)
;
do
{
nsPIDOMWindowOuter
*
parent
=
current
-
>
GetScriptableParent
(
)
;
if
(
parent
=
=
current
)
{
*
aResult
=
false
;
return
NS_OK
;
}
nsCString
parentDomain
=
GetBaseDomainFromWindow
(
parent
)
;
if
(
parentDomain
.
IsEmpty
(
)
)
{
nsCOMPtr
<
nsIURI
>
parentURI
;
nsresult
rv
=
GetURIFromWindow
(
parent
getter_AddRefs
(
parentURI
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
rv
=
IsThirdPartyInternal
(
bottomDomain
parentURI
&
result
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
}
else
{
result
=
IsThirdPartyInternal
(
bottomDomain
parentDomain
)
;
}
if
(
result
)
{
*
aResult
=
true
;
return
NS_OK
;
}
current
=
parent
;
}
while
(
1
)
;
MOZ_ASSERT_UNREACHABLE
(
"
should
'
ve
returned
"
)
;
return
NS_ERROR_UNEXPECTED
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
IsThirdPartyChannel
(
nsIChannel
*
aChannel
nsIURI
*
aURI
bool
*
aResult
)
{
LOG
(
(
"
ThirdPartyUtil
:
:
IsThirdPartyChannel
[
channel
=
%
p
]
"
aChannel
)
)
;
NS_ENSURE_ARG
(
aChannel
)
;
NS_ASSERTION
(
aResult
"
null
outparam
pointer
"
)
;
nsresult
rv
;
bool
doForce
=
false
;
nsCOMPtr
<
nsIHttpChannelInternal
>
httpChannelInternal
=
do_QueryInterface
(
aChannel
)
;
if
(
httpChannelInternal
)
{
uint32_t
flags
=
0
;
mozilla
:
:
Unused
<
<
httpChannelInternal
-
>
GetThirdPartyFlags
(
&
flags
)
;
doForce
=
(
flags
&
nsIHttpChannelInternal
:
:
THIRD_PARTY_FORCE_ALLOW
)
;
if
(
doForce
&
&
!
aURI
)
{
*
aResult
=
false
;
return
NS_OK
;
}
}
bool
parentIsThird
=
false
;
nsCOMPtr
<
nsIURI
>
channelURI
;
rv
=
NS_GetFinalChannelURI
(
aChannel
getter_AddRefs
(
channelURI
)
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
nsAutoCString
channelDomain
;
rv
=
GetBaseDomain
(
channelURI
channelDomain
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
if
(
!
doForce
)
{
if
(
nsCOMPtr
<
nsILoadInfo
>
loadInfo
=
aChannel
-
>
LoadInfo
(
)
)
{
parentIsThird
=
loadInfo
-
>
GetIsInThirdPartyContext
(
)
;
if
(
!
parentIsThird
&
&
loadInfo
-
>
GetExternalContentPolicyType
(
)
!
=
nsIContentPolicy
:
:
TYPE_DOCUMENT
)
{
nsCOMPtr
<
nsIURI
>
parentURI
;
rv
=
loadInfo
-
>
LoadingPrincipal
(
)
-
>
GetURI
(
getter_AddRefs
(
parentURI
)
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
parentURI
)
{
rv
=
IsThirdPartyInternal
(
channelDomain
parentURI
&
parentIsThird
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
}
else
{
parentIsThird
=
true
;
}
}
}
else
{
NS_WARNING
(
"
Found
channel
with
no
loadinfo
assuming
third
-
party
request
"
)
;
parentIsThird
=
true
;
}
}
if
(
!
aURI
|
|
parentIsThird
)
{
*
aResult
=
parentIsThird
;
return
NS_OK
;
}
return
IsThirdPartyInternal
(
channelDomain
aURI
aResult
)
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
GetTopWindowForChannel
(
nsIChannel
*
aChannel
nsIURI
*
aURIBeingLoaded
mozIDOMWindowProxy
*
*
aWin
)
{
NS_ENSURE_ARG
(
aWin
)
;
nsCOMPtr
<
nsILoadContext
>
ctx
;
NS_QueryNotificationCallbacks
(
aChannel
ctx
)
;
if
(
!
ctx
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
mozIDOMWindowProxy
>
window
;
ctx
-
>
GetAssociatedWindow
(
getter_AddRefs
(
window
)
)
;
if
(
!
window
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
nsPIDOMWindowOuter
>
top
=
nsGlobalWindowOuter
:
:
Cast
(
window
)
-
>
GetTopExcludingExtensionAccessibleContentFrames
(
aURIBeingLoaded
)
;
top
.
forget
(
aWin
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
GetBaseDomain
(
nsIURI
*
aHostURI
nsACString
&
aBaseDomain
)
{
if
(
!
aHostURI
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsresult
rv
=
mTLDService
-
>
GetBaseDomain
(
aHostURI
0
aBaseDomain
)
;
if
(
rv
=
=
NS_ERROR_HOST_IS_IP_ADDRESS
|
|
rv
=
=
NS_ERROR_INSUFFICIENT_DOMAIN_LEVELS
)
{
rv
=
aHostURI
-
>
GetAsciiHost
(
aBaseDomain
)
;
}
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
aBaseDomain
.
Length
(
)
=
=
1
&
&
aBaseDomain
.
Last
(
)
=
=
'
.
'
)
return
NS_ERROR_INVALID_ARG
;
if
(
aBaseDomain
.
IsEmpty
(
)
)
{
bool
isFileURI
=
false
;
aHostURI
-
>
SchemeIs
(
"
file
"
&
isFileURI
)
;
if
(
!
isFileURI
)
{
return
NS_ERROR_INVALID_ARG
;
}
}
return
NS_OK
;
}
NS_IMETHODIMP
ThirdPartyUtil
:
:
GetBaseDomainFromSchemeHost
(
const
nsACString
&
aScheme
const
nsACString
&
aAsciiHost
nsACString
&
aBaseDomain
)
{
MOZ_DIAGNOSTIC_ASSERT
(
IsASCII
(
aAsciiHost
)
)
;
nsresult
rv
=
mTLDService
-
>
GetBaseDomainFromHost
(
aAsciiHost
0
aBaseDomain
)
;
if
(
rv
=
=
NS_ERROR_HOST_IS_IP_ADDRESS
|
|
rv
=
=
NS_ERROR_INSUFFICIENT_DOMAIN_LEVELS
)
{
aBaseDomain
=
aAsciiHost
;
rv
=
NS_OK
;
}
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
aBaseDomain
.
Length
(
)
=
=
1
&
&
aBaseDomain
.
Last
(
)
=
=
'
.
'
)
return
NS_ERROR_INVALID_ARG
;
if
(
aBaseDomain
.
IsEmpty
(
)
&
&
!
aScheme
.
EqualsLiteral
(
"
file
"
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
return
NS_OK
;
}
