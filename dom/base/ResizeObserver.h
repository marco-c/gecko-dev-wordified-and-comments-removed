#
ifndef
mozilla_dom_ResizeObserver_h
#
define
mozilla_dom_ResizeObserver_h
#
include
"
js
/
TypeDecls
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
dom
/
BindingDeclarations
.
h
"
#
include
"
mozilla
/
dom
/
ResizeObserverBinding
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsWrapperCache
.
h
"
namespace
mozilla
{
namespace
dom
{
class
Element
;
}
}
namespace
mozilla
{
namespace
dom
{
class
ResizeObservation
final
:
public
LinkedListElement
<
ResizeObservation
>
{
public
:
NS_INLINE_DECL_CYCLE_COLLECTING_NATIVE_REFCOUNTING
(
ResizeObservation
)
NS_DECL_CYCLE_COLLECTION_NATIVE_CLASS
(
ResizeObservation
)
explicit
ResizeObservation
(
Element
&
aTarget
)
:
mTarget
(
&
aTarget
)
mBroadcastWidth
(
0
)
mBroadcastHeight
(
0
)
{
MOZ_ASSERT
(
mTarget
"
Need
a
non
-
null
target
element
"
)
;
}
Element
*
Target
(
)
const
{
return
mTarget
;
}
nscoord
BroadcastWidth
(
)
const
{
return
mBroadcastWidth
;
}
nscoord
BroadcastHeight
(
)
const
{
return
mBroadcastHeight
;
}
bool
IsActive
(
)
const
;
void
UpdateBroadcastSize
(
const
nsSize
&
aSize
)
;
nsRect
GetTargetRect
(
)
const
;
protected
:
~
ResizeObservation
(
)
=
default
;
nsCOMPtr
<
Element
>
mTarget
;
nscoord
mBroadcastWidth
;
nscoord
mBroadcastHeight
;
}
;
class
ResizeObserver
final
:
public
nsISupports
public
nsWrapperCache
{
public
:
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS
(
ResizeObserver
)
ResizeObserver
(
already_AddRefed
<
nsPIDOMWindowInner
>
&
&
aOwner
ResizeObserverCallback
&
aCb
)
:
mOwner
(
aOwner
)
mCallback
(
&
aCb
)
{
MOZ_ASSERT
(
mOwner
"
Need
a
non
-
null
owner
window
"
)
;
}
nsISupports
*
GetParentObject
(
)
const
{
return
mOwner
;
}
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
{
return
ResizeObserver_Binding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
static
already_AddRefed
<
ResizeObserver
>
Constructor
(
const
GlobalObject
&
aGlobal
ResizeObserverCallback
&
aCb
ErrorResult
&
aRv
)
;
void
Observe
(
Element
&
target
ErrorResult
&
aRv
)
;
void
Unobserve
(
Element
&
target
ErrorResult
&
aRv
)
;
void
Disconnect
(
)
;
void
GatherActiveObservations
(
uint32_t
aDepth
)
;
bool
HasActiveObservations
(
)
const
{
return
!
mActiveTargets
.
IsEmpty
(
)
;
}
bool
HasSkippedObservations
(
)
const
{
return
mHasSkippedTargets
;
}
MOZ_CAN_RUN_SCRIPT
uint32_t
BroadcastActiveObservations
(
)
;
protected
:
~
ResizeObserver
(
)
{
mObservationList
.
clear
(
)
;
}
nsCOMPtr
<
nsPIDOMWindowInner
>
mOwner
;
RefPtr
<
ResizeObserverCallback
>
mCallback
;
nsTArray
<
RefPtr
<
ResizeObservation
>
>
mActiveTargets
;
bool
mHasSkippedTargets
;
nsRefPtrHashtable
<
nsPtrHashKey
<
Element
>
ResizeObservation
>
mObservationMap
;
LinkedList
<
ResizeObservation
>
mObservationList
;
}
;
class
ResizeObserverEntry
final
:
public
nsISupports
public
nsWrapperCache
{
public
:
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS
(
ResizeObserverEntry
)
ResizeObserverEntry
(
nsISupports
*
aOwner
Element
&
aTarget
)
:
mOwner
(
aOwner
)
mTarget
(
&
aTarget
)
{
MOZ_ASSERT
(
mOwner
"
Need
a
non
-
null
owner
"
)
;
MOZ_ASSERT
(
mTarget
"
Need
a
non
-
null
target
element
"
)
;
}
nsISupports
*
GetParentObject
(
)
const
{
return
mOwner
;
}
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
{
return
ResizeObserverEntry_Binding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
static
already_AddRefed
<
ResizeObserverEntry
>
Constructor
(
const
GlobalObject
&
global
Element
&
target
ErrorResult
&
aRv
)
;
Element
*
Target
(
)
const
{
return
mTarget
;
}
DOMRectReadOnly
*
ContentRect
(
)
const
{
return
mContentRect
;
}
void
SetContentRect
(
const
nsRect
&
aRect
)
;
protected
:
~
ResizeObserverEntry
(
)
=
default
;
nsCOMPtr
<
nsISupports
>
mOwner
;
nsCOMPtr
<
Element
>
mTarget
;
RefPtr
<
DOMRectReadOnly
>
mContentRect
;
}
;
}
}
#
endif
