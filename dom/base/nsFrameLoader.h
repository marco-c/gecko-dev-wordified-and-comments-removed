#
ifndef
nsFrameLoader_h_
#
define
nsFrameLoader_h_
#
include
"
nsIDocShell
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsIFrameLoader
.
h
"
#
include
"
nsPoint
.
h
"
#
include
"
nsSize
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsFrameMessageManager
.
h
"
#
include
"
mozilla
/
dom
/
BindingUtils
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsStubMutationObserver
.
h
"
#
include
"
Units
.
h
"
#
include
"
nsIWebBrowserPersistable
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsPluginTags
.
h
"
class
nsIURI
;
class
nsSubDocumentFrame
;
class
nsView
;
class
nsIInProcessContentFrameMessageManager
;
class
AutoResetInShow
;
class
AutoResetInFrameSwap
;
class
nsITabParent
;
class
nsIDocShellTreeItem
;
class
nsIDocShellTreeOwner
;
namespace
mozilla
{
class
OriginAttributes
;
namespace
dom
{
class
ContentParent
;
class
PBrowserParent
;
class
Promise
;
class
TabParent
;
class
MutableTabContext
;
namespace
ipc
{
class
StructuredCloneData
;
}
}
namespace
layout
{
class
RenderFrameParent
;
}
}
#
if
defined
(
MOZ_WIDGET_GTK
)
typedef
struct
_GtkWidget
GtkWidget
;
#
endif
class
nsFrameLoader
final
:
public
nsIFrameLoader
public
nsIWebBrowserPersistable
public
nsStubMutationObserver
public
mozilla
:
:
dom
:
:
ipc
:
:
MessageManagerCallback
public
nsWrapperCache
{
friend
class
AutoResetInShow
;
friend
class
AutoResetInFrameSwap
;
typedef
mozilla
:
:
dom
:
:
PBrowserParent
PBrowserParent
;
typedef
mozilla
:
:
dom
:
:
TabParent
TabParent
;
typedef
mozilla
:
:
layout
:
:
RenderFrameParent
RenderFrameParent
;
public
:
static
nsFrameLoader
*
Create
(
mozilla
:
:
dom
:
:
Element
*
aOwner
nsPIDOMWindowOuter
*
aOpener
bool
aNetworkCreated
int32_t
aJSPluginID
=
nsFakePluginTag
:
:
NOT_JSPLUGIN
)
;
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS_AMBIGUOUS
(
nsFrameLoader
nsIFrameLoader
)
NS_DECL_NSIFRAMELOADER
NS_DECL_NSIMUTATIONOBSERVER_ATTRIBUTECHANGED
NS_DECL_NSIWEBBROWSERPERSISTABLE
nsresult
CheckForRecursiveLoad
(
nsIURI
*
aURI
)
;
nsresult
ReallyStartLoading
(
)
;
void
StartDestroy
(
)
;
void
DestroyDocShell
(
)
;
void
DestroyComplete
(
)
;
nsIDocShell
*
GetExistingDocShell
(
)
{
return
mDocShell
;
}
mozilla
:
:
dom
:
:
EventTarget
*
GetTabChildGlobalAsEventTarget
(
)
;
nsresult
CreateStaticClone
(
nsIFrameLoader
*
aDest
)
;
already_AddRefed
<
nsIDocShell
>
GetDocShell
(
mozilla
:
:
ErrorResult
&
aRv
)
;
already_AddRefed
<
nsITabParent
>
GetTabParent
(
)
;
already_AddRefed
<
nsILoadContext
>
LoadContext
(
)
;
void
LoadFrame
(
bool
aOriginalSrc
mozilla
:
:
ErrorResult
&
aRv
)
;
void
LoadURI
(
nsIURI
*
aURI
bool
aOriginalSrc
mozilla
:
:
ErrorResult
&
aRv
)
;
nsresult
LoadURI
(
nsIURI
*
aURI
nsIPrincipal
*
aTriggeringPrincipal
bool
aOriginalSrc
)
;
void
AddProcessChangeBlockingPromise
(
mozilla
:
:
dom
:
:
Promise
&
aPromise
mozilla
:
:
ErrorResult
&
aRv
)
;
void
Destroy
(
mozilla
:
:
ErrorResult
&
aRv
)
;
void
ActivateRemoteFrame
(
mozilla
:
:
ErrorResult
&
aRv
)
;
void
DeactivateRemoteFrame
(
mozilla
:
:
ErrorResult
&
aRv
)
;
void
SendCrossProcessMouseEvent
(
const
nsAString
&
aType
float
aX
float
aY
int32_t
aButton
int32_t
aClickCount
int32_t
aModifiers
bool
aIgnoreRootScrollFrame
mozilla
:
:
ErrorResult
&
aRv
)
;
void
ActivateFrameEvent
(
const
nsAString
&
aType
bool
aCapture
mozilla
:
:
ErrorResult
&
aRv
)
;
void
RequestNotifyAfterRemotePaint
(
mozilla
:
:
ErrorResult
&
aRv
)
;
void
RequestFrameLoaderClose
(
mozilla
:
:
ErrorResult
&
aRv
)
;
void
RequestUpdatePosition
(
mozilla
:
:
ErrorResult
&
aRv
)
;
void
Print
(
uint64_t
aOuterWindowID
nsIPrintSettings
*
aPrintSettings
nsIWebProgressListener
*
aProgressListener
mozilla
:
:
ErrorResult
&
aRv
)
;
void
StartPersistence
(
uint64_t
aOuterWindowID
nsIWebBrowserPersistDocumentReceiver
*
aRecv
mozilla
:
:
ErrorResult
&
aRv
)
;
already_AddRefed
<
nsIMessageSender
>
GetMessageManager
(
)
;
uint32_t
EventMode
(
)
const
{
return
mEventMode
;
}
already_AddRefed
<
Element
>
GetOwnerElement
(
)
;
uint32_t
LazyWidth
(
)
const
;
uint32_t
LazyHeight
(
)
const
;
uint64_t
ChildID
(
)
const
{
return
mChildID
;
}
bool
ClampScrollPosition
(
)
const
{
return
mClampScrollPosition
;
}
bool
ClipSubdocument
(
)
const
{
return
mClipSubdocument
;
}
bool
DepthTooGreat
(
)
const
{
return
mDepthTooGreat
;
}
bool
IsDead
(
)
const
{
return
mDestroyCalled
;
}
bool
OwnerIsMozBrowserFrame
(
)
;
nsIContent
*
GetParentObject
(
)
const
{
return
mOwnerContent
;
}
virtual
bool
DoLoadMessageManagerScript
(
const
nsAString
&
aURL
bool
aRunInGlobalScope
)
override
;
virtual
nsresult
DoSendAsyncMessage
(
JSContext
*
aCx
const
nsAString
&
aMessage
mozilla
:
:
dom
:
:
ipc
:
:
StructuredCloneData
&
aData
JS
:
:
Handle
<
JSObject
*
>
aCpows
nsIPrincipal
*
aPrincipal
)
override
;
bool
Show
(
int32_t
marginWidth
int32_t
marginHeight
int32_t
scrollbarPrefX
int32_t
scrollbarPrefY
nsSubDocumentFrame
*
frame
)
;
void
MaybeShowFrame
(
)
;
void
MarginsChanged
(
uint32_t
aMarginWidth
uint32_t
aMarginHeight
)
;
void
Hide
(
)
;
nsresult
CloneForStatic
(
nsIFrameLoader
*
aOriginal
)
;
nsresult
SwapWithOtherLoader
(
nsFrameLoader
*
aOther
nsIFrameLoaderOwner
*
aThisOwner
nsIFrameLoaderOwner
*
aOtherOwner
)
;
nsresult
SwapWithOtherRemoteLoader
(
nsFrameLoader
*
aOther
nsIFrameLoaderOwner
*
aThisOwner
nsIFrameLoaderOwner
*
aOtherOwner
)
;
nsIFrame
*
GetPrimaryFrameOfOwningContent
(
)
const
{
return
mOwnerContent
?
mOwnerContent
-
>
GetPrimaryFrame
(
)
:
nullptr
;
}
nsIDocument
*
GetOwnerDoc
(
)
const
{
return
mOwnerContent
?
mOwnerContent
-
>
OwnerDoc
(
)
:
nullptr
;
}
PBrowserParent
*
GetRemoteBrowser
(
)
const
;
RenderFrameParent
*
GetCurrentRenderFrame
(
)
const
;
nsFrameMessageManager
*
GetFrameMessageManager
(
)
{
return
mMessageManager
;
}
mozilla
:
:
dom
:
:
Element
*
GetOwnerContent
(
)
{
return
mOwnerContent
;
}
bool
ShouldClipSubdocument
(
)
{
return
mClipSubdocument
;
}
bool
ShouldClampScrollPosition
(
)
{
return
mClampScrollPosition
;
}
void
SetRemoteBrowser
(
nsITabParent
*
aTabParent
)
;
void
SetDetachedSubdocFrame
(
nsIFrame
*
aDetachedFrame
nsIDocument
*
aContainerDoc
)
;
nsIFrame
*
GetDetachedSubdocFrame
(
nsIDocument
*
*
aContainerDoc
)
const
;
void
ApplySandboxFlags
(
uint32_t
sandboxFlags
)
;
void
GetURL
(
nsString
&
aURL
nsIPrincipal
*
*
aTriggeringPrincipal
)
;
nsresult
GetWindowDimensions
(
nsIntRect
&
aRect
)
;
virtual
nsIMessageSender
*
GetProcessMessageManager
(
)
const
override
;
RefPtr
<
nsFrameMessageManager
>
mMessageManager
;
nsCOMPtr
<
nsIInProcessContentFrameMessageManager
>
mChildMessageManager
;
virtual
JSObject
*
WrapObject
(
JSContext
*
cx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
private
:
nsFrameLoader
(
mozilla
:
:
dom
:
:
Element
*
aOwner
nsPIDOMWindowOuter
*
aOpener
bool
aNetworkCreated
int32_t
aJSPluginID
)
;
~
nsFrameLoader
(
)
;
void
SetOwnerContent
(
mozilla
:
:
dom
:
:
Element
*
aContent
)
;
bool
ShouldUseRemoteProcess
(
)
;
bool
IsRemoteFrame
(
)
;
bool
IsForJSPlugin
(
)
{
return
mJSPluginID
!
=
nsFakePluginTag
:
:
NOT_JSPLUGIN
;
}
bool
OwnerIsIsolatedMozBrowserFrame
(
)
;
void
GetOwnerAppManifestURL
(
nsAString
&
aOut
)
;
nsresult
MaybeCreateDocShell
(
)
;
nsresult
EnsureMessageManager
(
)
;
nsresult
ReallyLoadFrameScripts
(
)
;
void
UpdateBaseWindowPositionAndSize
(
nsSubDocumentFrame
*
aIFrame
)
;
nsresult
CheckURILoad
(
nsIURI
*
aURI
nsIPrincipal
*
aTriggeringPrincipal
)
;
void
FireErrorEvent
(
)
;
nsresult
ReallyStartLoadingInternal
(
)
;
bool
TryRemoteBrowser
(
)
;
bool
ShowRemoteFrame
(
const
mozilla
:
:
ScreenIntSize
&
size
nsSubDocumentFrame
*
aFrame
=
nullptr
)
;
bool
AddTreeItemToTreeOwner
(
nsIDocShellTreeItem
*
aItem
nsIDocShellTreeOwner
*
aOwner
int32_t
aParentType
nsIDocShell
*
aParentNode
)
;
nsAtom
*
TypeAttrName
(
)
const
{
return
mOwnerContent
-
>
IsXULElement
(
)
?
nsGkAtoms
:
:
type
:
nsGkAtoms
:
:
mozframetype
;
}
void
InitializeBrowserAPI
(
)
;
void
DestroyBrowserFrameScripts
(
)
;
nsresult
GetNewTabContext
(
mozilla
:
:
dom
:
:
MutableTabContext
*
aTabContext
nsIURI
*
aURI
=
nullptr
)
;
enum
TabParentChange
{
eTabParentRemoved
eTabParentChanged
}
;
void
MaybeUpdatePrimaryTabParent
(
TabParentChange
aChange
)
;
nsresult
PopulateUserContextIdFromAttribute
(
mozilla
:
:
OriginAttributes
&
aAttr
)
;
bool
SwapBrowsersAndNotify
(
nsFrameLoader
*
aOther
)
;
already_AddRefed
<
mozilla
:
:
dom
:
:
Promise
>
FireWillChangeProcessEvent
(
)
;
nsCOMPtr
<
nsIDocShell
>
mDocShell
;
nsCOMPtr
<
nsIURI
>
mURIToLoad
;
nsCOMPtr
<
nsIPrincipal
>
mTriggeringPrincipal
;
mozilla
:
:
dom
:
:
Element
*
mOwnerContent
;
RefPtr
<
mozilla
:
:
dom
:
:
Element
>
mOwnerContentStrong
;
WeakFrame
mDetachedSubdocFrame
;
nsCOMPtr
<
nsIDocument
>
mContainerDocWhileDetached
;
nsCOMPtr
<
nsPIDOMWindowOuter
>
mOpener
;
TabParent
*
mRemoteBrowser
;
uint64_t
mChildID
;
int32_t
mJSPluginID
;
uint32_t
mEventMode
;
mozilla
:
:
ScreenIntSize
mLazySize
;
nsTArray
<
RefPtr
<
mozilla
:
:
dom
:
:
Promise
>
>
*
mBrowserChangingProcessBlockers
;
bool
mDepthTooGreat
:
1
;
bool
mIsTopLevelContent
:
1
;
bool
mDestroyCalled
:
1
;
bool
mNeedsAsyncDestroy
:
1
;
bool
mInSwap
:
1
;
bool
mInShow
:
1
;
bool
mHideCalled
:
1
;
bool
mNetworkCreated
:
1
;
bool
mLoadingOriginalSrc
:
1
;
bool
mRemoteBrowserShown
:
1
;
bool
mRemoteFrame
:
1
;
bool
mClipSubdocument
:
1
;
bool
mClampScrollPosition
:
1
;
bool
mObservingOwnerContent
:
1
;
bool
mFreshProcess
:
1
;
}
;
#
endif
