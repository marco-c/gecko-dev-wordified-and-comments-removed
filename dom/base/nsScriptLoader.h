#
ifndef
__nsScriptLoader_h__
#
define
__nsScriptLoader_h__
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
#
include
"
nsIUnicodeDecoder
.
h
"
#
include
"
nsIScriptElement
.
h
"
#
include
"
nsCOMArray
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
include
"
nsICacheInfoChannel
.
h
"
#
include
"
nsIDocument
.
h
"
#
include
"
nsIIncrementalStreamLoader
.
h
"
#
include
"
nsURIHashKey
.
h
"
#
include
"
mozilla
/
CORSMode
.
h
"
#
include
"
mozilla
/
dom
/
SRIMetadata
.
h
"
#
include
"
mozilla
/
dom
/
SRICheck
.
h
"
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
net
/
ReferrerPolicy
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
class
nsModuleLoadRequest
;
class
nsModuleScript
;
class
nsScriptLoadRequestList
;
class
nsIURI
;
namespace
JS
{
class
SourceBufferHolder
;
}
namespace
mozilla
{
namespace
dom
{
class
AutoJSAPI
;
}
}
enum
class
nsScriptKind
{
Classic
Module
}
;
class
nsScriptLoadRequest
:
public
nsISupports
private
mozilla
:
:
LinkedListElement
<
nsScriptLoadRequest
>
{
typedef
LinkedListElement
<
nsScriptLoadRequest
>
super
;
friend
class
mozilla
:
:
LinkedListElement
<
nsScriptLoadRequest
>
;
friend
class
nsScriptLoadRequestList
;
protected
:
virtual
~
nsScriptLoadRequest
(
)
;
public
:
nsScriptLoadRequest
(
nsScriptKind
aKind
nsIScriptElement
*
aElement
uint32_t
aVersion
mozilla
:
:
CORSMode
aCORSMode
const
mozilla
:
:
dom
:
:
SRIMetadata
&
aIntegrity
)
:
mKind
(
aKind
)
mElement
(
aElement
)
mScriptFromHead
(
false
)
mProgress
(
Progress
:
:
Loading
)
mDataType
(
DataType
:
:
Unknown
)
mIsInline
(
true
)
mHasSourceMapURL
(
false
)
mIsDefer
(
false
)
mIsAsync
(
false
)
mIsNonAsyncScriptInserted
(
false
)
mIsXSLT
(
false
)
mIsCanceled
(
false
)
mWasCompiledOMT
(
false
)
mIsTracking
(
false
)
mOffThreadToken
(
nullptr
)
mScriptText
(
)
mScriptBytecode
(
)
mBytecodeOffset
(
0
)
mJSVersion
(
aVersion
)
mLineNo
(
1
)
mCORSMode
(
aCORSMode
)
mIntegrity
(
aIntegrity
)
mReferrerPolicy
(
mozilla
:
:
net
:
:
RP_Unset
)
{
}
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_SCRIPT_HOLDER_CLASS
(
nsScriptLoadRequest
)
bool
IsModuleRequest
(
)
const
{
return
mKind
=
=
nsScriptKind
:
:
Module
;
}
nsModuleLoadRequest
*
AsModuleRequest
(
)
;
void
FireScriptAvailable
(
nsresult
aResult
)
{
mElement
-
>
ScriptAvailable
(
aResult
mElement
mIsInline
mURI
mLineNo
)
;
}
void
FireScriptEvaluated
(
nsresult
aResult
)
{
mElement
-
>
ScriptEvaluated
(
aResult
mElement
mIsInline
)
;
}
bool
IsPreload
(
)
{
return
mElement
=
=
nullptr
;
}
virtual
void
Cancel
(
)
;
bool
IsCanceled
(
)
const
{
return
mIsCanceled
;
}
virtual
void
SetReady
(
)
;
void
*
*
OffThreadTokenPtr
(
)
{
return
mOffThreadToken
?
&
mOffThreadToken
:
nullptr
;
}
bool
IsTracking
(
)
const
{
return
mIsTracking
;
}
void
SetIsTracking
(
)
{
MOZ_ASSERT
(
!
mIsTracking
)
;
mIsTracking
=
true
;
}
enum
class
Progress
:
uint8_t
{
Loading
Loading_Source
Compiling
FetchingImports
Ready
}
;
bool
IsReadyToRun
(
)
const
{
return
mProgress
=
=
Progress
:
:
Ready
;
}
bool
IsLoading
(
)
const
{
return
mProgress
=
=
Progress
:
:
Loading
|
|
mProgress
=
=
Progress
:
:
Loading_Source
;
}
bool
IsLoadingSource
(
)
const
{
return
mProgress
=
=
Progress
:
:
Loading_Source
;
}
bool
InCompilingStage
(
)
const
{
return
mProgress
=
=
Progress
:
:
Compiling
|
|
(
IsReadyToRun
(
)
&
&
mWasCompiledOMT
)
;
}
enum
class
DataType
:
uint8_t
{
Unknown
Source
Bytecode
}
;
bool
IsUnknownDataType
(
)
const
{
return
mDataType
=
=
DataType
:
:
Unknown
;
}
bool
IsSource
(
)
const
{
return
mDataType
=
=
DataType
:
:
Source
;
}
bool
IsBytecode
(
)
const
{
return
mDataType
=
=
DataType
:
:
Bytecode
;
}
void
MaybeCancelOffThreadScript
(
)
;
void
DropBytecodeCacheReferences
(
)
;
using
super
:
:
getNext
;
using
super
:
:
isInList
;
const
nsScriptKind
mKind
;
nsCOMPtr
<
nsIScriptElement
>
mElement
;
bool
mScriptFromHead
;
Progress
mProgress
;
DataType
mDataType
;
bool
mIsInline
;
bool
mHasSourceMapURL
;
bool
mIsDefer
;
bool
mIsAsync
;
bool
mIsNonAsyncScriptInserted
;
bool
mIsXSLT
;
bool
mIsCanceled
;
bool
mWasCompiledOMT
;
bool
mIsTracking
;
void
*
mOffThreadToken
;
nsString
mSourceMapURL
;
JS
:
:
Heap
<
JSScript
*
>
mScript
;
mozilla
:
:
Vector
<
char16_t
>
mScriptText
;
mozilla
:
:
Vector
<
uint8_t
>
mScriptBytecode
;
uint32_t
mBytecodeOffset
;
uint32_t
mJSVersion
;
nsCOMPtr
<
nsIURI
>
mURI
;
nsCOMPtr
<
nsIPrincipal
>
mOriginPrincipal
;
nsAutoCString
mURL
;
int32_t
mLineNo
;
const
mozilla
:
:
CORSMode
mCORSMode
;
const
mozilla
:
:
dom
:
:
SRIMetadata
mIntegrity
;
mozilla
:
:
net
:
:
ReferrerPolicy
mReferrerPolicy
;
nsCOMPtr
<
nsICacheInfoChannel
>
mCacheInfo
;
}
;
class
nsScriptLoadRequestList
:
private
mozilla
:
:
LinkedList
<
nsScriptLoadRequest
>
{
typedef
mozilla
:
:
LinkedList
<
nsScriptLoadRequest
>
super
;
public
:
~
nsScriptLoadRequestList
(
)
;
void
Clear
(
)
;
#
ifdef
DEBUG
bool
Contains
(
nsScriptLoadRequest
*
aElem
)
const
;
#
endif
using
super
:
:
getFirst
;
using
super
:
:
isEmpty
;
void
AppendElement
(
nsScriptLoadRequest
*
aElem
)
{
MOZ_ASSERT
(
!
aElem
-
>
isInList
(
)
)
;
NS_ADDREF
(
aElem
)
;
insertBack
(
aElem
)
;
}
MOZ_MUST_USE
already_AddRefed
<
nsScriptLoadRequest
>
Steal
(
nsScriptLoadRequest
*
aElem
)
{
aElem
-
>
removeFrom
(
*
this
)
;
return
dont_AddRef
(
aElem
)
;
}
MOZ_MUST_USE
already_AddRefed
<
nsScriptLoadRequest
>
StealFirst
(
)
{
MOZ_ASSERT
(
!
isEmpty
(
)
)
;
return
Steal
(
getFirst
(
)
)
;
}
void
Remove
(
nsScriptLoadRequest
*
aElem
)
{
aElem
-
>
removeFrom
(
*
this
)
;
NS_RELEASE
(
aElem
)
;
}
}
;
class
nsScriptLoader
final
:
public
nsISupports
{
class
MOZ_STACK_CLASS
AutoCurrentScriptUpdater
{
public
:
AutoCurrentScriptUpdater
(
nsScriptLoader
*
aScriptLoader
nsIScriptElement
*
aCurrentScript
)
:
mOldScript
(
aScriptLoader
-
>
mCurrentScript
)
mScriptLoader
(
aScriptLoader
)
{
mScriptLoader
-
>
mCurrentScript
=
aCurrentScript
;
}
~
AutoCurrentScriptUpdater
(
)
{
mScriptLoader
-
>
mCurrentScript
.
swap
(
mOldScript
)
;
}
private
:
nsCOMPtr
<
nsIScriptElement
>
mOldScript
;
nsScriptLoader
*
mScriptLoader
;
}
;
friend
class
nsModuleLoadRequest
;
friend
class
nsScriptRequestProcessor
;
friend
class
nsScriptLoadHandler
;
friend
class
AutoCurrentScriptUpdater
;
public
:
explicit
nsScriptLoader
(
nsIDocument
*
aDocument
)
;
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_CLASS
(
nsScriptLoader
)
void
DropDocumentReference
(
)
{
mDocument
=
nullptr
;
}
nsresult
AddObserver
(
nsIScriptLoaderObserver
*
aObserver
)
{
return
mObservers
.
AppendObject
(
aObserver
)
?
NS_OK
:
NS_ERROR_OUT_OF_MEMORY
;
}
void
RemoveObserver
(
nsIScriptLoaderObserver
*
aObserver
)
{
mObservers
.
RemoveObject
(
aObserver
)
;
}
bool
ProcessScriptElement
(
nsIScriptElement
*
aElement
)
;
nsIScriptElement
*
GetCurrentScript
(
)
{
return
mCurrentScript
;
}
nsIScriptElement
*
GetCurrentParserInsertedScript
(
)
{
return
mCurrentParserInsertedScript
;
}
bool
GetEnabled
(
)
{
return
mEnabled
;
}
void
SetEnabled
(
bool
aEnabled
)
{
if
(
!
mEnabled
&
&
aEnabled
)
{
ProcessPendingRequestsAsync
(
)
;
}
mEnabled
=
aEnabled
;
}
void
AddParserBlockingScriptExecutionBlocker
(
)
{
+
+
mParserBlockingBlockerCount
;
}
void
RemoveParserBlockingScriptExecutionBlocker
(
)
{
if
(
!
-
-
mParserBlockingBlockerCount
&
&
ReadyToExecuteScripts
(
)
)
{
ProcessPendingRequestsAsync
(
)
;
}
}
void
AddExecuteBlocker
(
)
{
+
+
mBlockerCount
;
}
void
RemoveExecuteBlocker
(
)
{
MOZ_ASSERT
(
mBlockerCount
)
;
if
(
!
-
-
mBlockerCount
)
{
ProcessPendingRequestsAsync
(
)
;
}
}
static
nsresult
ConvertToUTF16
(
nsIChannel
*
aChannel
const
uint8_t
*
aData
uint32_t
aLength
const
nsAString
&
aHintCharset
nsIDocument
*
aDocument
char16_t
*
&
aBufOut
size_t
&
aLengthOut
)
;
static
inline
nsresult
ConvertToUTF16
(
nsIChannel
*
aChannel
const
uint8_t
*
aData
uint32_t
aLength
const
nsAString
&
aHintCharset
nsIDocument
*
aDocument
JS
:
:
UniqueTwoByteChars
&
aBufOut
size_t
&
aLengthOut
)
{
char16_t
*
bufOut
;
nsresult
rv
=
ConvertToUTF16
(
aChannel
aData
aLength
aHintCharset
aDocument
bufOut
aLengthOut
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
aBufOut
.
reset
(
bufOut
)
;
}
return
rv
;
}
;
nsresult
OnStreamComplete
(
nsIIncrementalStreamLoader
*
aLoader
nsScriptLoadRequest
*
aRequest
nsresult
aChannelStatus
nsresult
aSRIStatus
mozilla
:
:
dom
:
:
SRICheckDataVerifier
*
aSRIDataVerifier
)
;
bool
HasPendingRequests
(
)
;
void
ProcessPendingRequests
(
)
;
void
BeginDeferringScripts
(
)
{
mDeferEnabled
=
true
;
if
(
mDocument
)
{
mDocument
-
>
BlockOnload
(
)
;
}
}
void
ParsingComplete
(
bool
aTerminated
)
;
uint32_t
HasPendingOrCurrentScripts
(
)
{
return
mCurrentScript
|
|
mParserBlockingRequest
;
}
virtual
void
PreloadURI
(
nsIURI
*
aURI
const
nsAString
&
aCharset
const
nsAString
&
aType
const
nsAString
&
aCrossOrigin
const
nsAString
&
aIntegrity
bool
aScriptFromHead
const
mozilla
:
:
net
:
:
ReferrerPolicy
aReferrerPolicy
)
;
nsresult
ProcessOffThreadRequest
(
nsScriptLoadRequest
*
aRequest
)
;
bool
AddPendingChildLoader
(
nsScriptLoader
*
aChild
)
{
return
mPendingChildLoaders
.
AppendElement
(
aChild
)
!
=
nullptr
;
}
mozilla
:
:
dom
:
:
DocGroup
*
GetDocGroup
(
)
const
{
return
mDocument
-
>
GetDocGroup
(
)
;
}
void
LoadEventFired
(
)
;
private
:
virtual
~
nsScriptLoader
(
)
;
nsScriptLoadRequest
*
CreateLoadRequest
(
nsScriptKind
aKind
nsIScriptElement
*
aElement
uint32_t
aVersion
mozilla
:
:
CORSMode
aCORSMode
const
mozilla
:
:
dom
:
:
SRIMetadata
&
aIntegrity
)
;
void
UnblockParser
(
nsScriptLoadRequest
*
aParserBlockingRequest
)
;
void
ContinueParserAsync
(
nsScriptLoadRequest
*
aParserBlockingRequest
)
;
static
nsresult
CheckContentPolicy
(
nsIDocument
*
aDocument
nsISupports
*
aContext
nsIURI
*
aURI
const
nsAString
&
aType
bool
aIsPreLoad
)
;
nsresult
StartLoad
(
nsScriptLoadRequest
*
aRequest
)
;
nsresult
RestartLoad
(
nsScriptLoadRequest
*
aRequest
)
;
virtual
void
ProcessPendingRequestsAsync
(
)
;
bool
ReadyToExecuteParserBlockingScripts
(
)
;
bool
SelfReadyToExecuteParserBlockingScripts
(
)
{
return
ReadyToExecuteScripts
(
)
&
&
!
mParserBlockingBlockerCount
;
}
bool
ReadyToExecuteScripts
(
)
{
return
mEnabled
&
&
!
mBlockerCount
;
}
nsresult
AttemptAsyncScriptCompile
(
nsScriptLoadRequest
*
aRequest
)
;
nsresult
ProcessRequest
(
nsScriptLoadRequest
*
aRequest
)
;
nsresult
CompileOffThreadOrProcessRequest
(
nsScriptLoadRequest
*
aRequest
)
;
void
FireScriptAvailable
(
nsresult
aResult
nsScriptLoadRequest
*
aRequest
)
;
void
FireScriptEvaluated
(
nsresult
aResult
nsScriptLoadRequest
*
aRequest
)
;
nsresult
EvaluateScript
(
nsScriptLoadRequest
*
aRequest
)
;
void
RegisterForBytecodeEncoding
(
nsScriptLoadRequest
*
aRequest
)
;
void
MaybeTriggerBytecodeEncoding
(
)
;
void
EncodeBytecode
(
)
;
void
EncodeRequestBytecode
(
JSContext
*
aCx
nsScriptLoadRequest
*
aRequest
)
;
void
GiveUpBytecodeEncoding
(
)
;
already_AddRefed
<
nsIScriptGlobalObject
>
GetScriptGlobalObject
(
)
;
nsresult
FillCompileOptionsForRequest
(
const
mozilla
:
:
dom
:
:
AutoJSAPI
&
jsapi
nsScriptLoadRequest
*
aRequest
JS
:
:
Handle
<
JSObject
*
>
aScopeChain
JS
:
:
CompileOptions
*
aOptions
)
;
uint32_t
NumberOfProcessors
(
)
;
nsresult
PrepareLoadedRequest
(
nsScriptLoadRequest
*
aRequest
nsIIncrementalStreamLoader
*
aLoader
nsresult
aStatus
)
;
void
AddDeferRequest
(
nsScriptLoadRequest
*
aRequest
)
;
bool
MaybeRemovedDeferRequests
(
)
;
void
MaybeMoveToLoadedList
(
nsScriptLoadRequest
*
aRequest
)
;
JS
:
:
SourceBufferHolder
GetScriptSource
(
nsScriptLoadRequest
*
aRequest
nsAutoString
&
inlineData
)
;
bool
ModuleScriptsEnabled
(
)
;
void
SetModuleFetchStarted
(
nsModuleLoadRequest
*
aRequest
)
;
void
SetModuleFetchFinishedAndResumeWaitingRequests
(
nsModuleLoadRequest
*
aRequest
nsresult
aResult
)
;
bool
IsFetchingModule
(
nsModuleLoadRequest
*
aRequest
)
const
;
bool
ModuleMapContainsModule
(
nsModuleLoadRequest
*
aRequest
)
const
;
RefPtr
<
mozilla
:
:
GenericPromise
>
WaitForModuleFetch
(
nsModuleLoadRequest
*
aRequest
)
;
nsModuleScript
*
GetFetchedModule
(
nsIURI
*
aURL
)
const
;
friend
bool
HostResolveImportedModule
(
JSContext
*
aCx
unsigned
argc
JS
:
:
Value
*
vp
)
;
nsresult
CreateModuleScript
(
nsModuleLoadRequest
*
aRequest
)
;
nsresult
ProcessFetchedModuleSource
(
nsModuleLoadRequest
*
aRequest
)
;
void
ProcessLoadedModuleTree
(
nsModuleLoadRequest
*
aRequest
)
;
bool
InstantiateModuleTree
(
nsModuleLoadRequest
*
aRequest
)
;
void
StartFetchingModuleDependencies
(
nsModuleLoadRequest
*
aRequest
)
;
RefPtr
<
mozilla
:
:
GenericPromise
>
StartFetchingModuleAndDependencies
(
nsModuleLoadRequest
*
aRequest
nsIURI
*
aURI
)
;
nsIDocument
*
mDocument
;
nsCOMArray
<
nsIScriptLoaderObserver
>
mObservers
;
nsScriptLoadRequestList
mNonAsyncExternalScriptInsertedRequests
;
nsScriptLoadRequestList
mLoadingAsyncRequests
;
nsScriptLoadRequestList
mLoadedAsyncRequests
;
nsScriptLoadRequestList
mDeferRequests
;
nsScriptLoadRequestList
mXSLTRequests
;
RefPtr
<
nsScriptLoadRequest
>
mParserBlockingRequest
;
nsScriptLoadRequestList
mBytecodeEncodingQueue
;
struct
PreloadInfo
{
RefPtr
<
nsScriptLoadRequest
>
mRequest
;
nsString
mCharset
;
}
;
friend
void
ImplCycleCollectionUnlink
(
nsScriptLoader
:
:
PreloadInfo
&
aField
)
;
friend
void
ImplCycleCollectionTraverse
(
nsCycleCollectionTraversalCallback
&
aCallback
nsScriptLoader
:
:
PreloadInfo
&
aField
const
char
*
aName
uint32_t
aFlags
)
;
struct
PreloadRequestComparator
{
bool
Equals
(
const
PreloadInfo
&
aPi
nsScriptLoadRequest
*
const
&
aRequest
)
const
{
return
aRequest
=
=
aPi
.
mRequest
;
}
}
;
struct
PreloadURIComparator
{
bool
Equals
(
const
PreloadInfo
&
aPi
nsIURI
*
const
&
aURI
)
const
;
}
;
nsTArray
<
PreloadInfo
>
mPreloads
;
nsCOMPtr
<
nsIScriptElement
>
mCurrentScript
;
nsCOMPtr
<
nsIScriptElement
>
mCurrentParserInsertedScript
;
nsTArray
<
RefPtr
<
nsScriptLoader
>
>
mPendingChildLoaders
;
uint32_t
mParserBlockingBlockerCount
;
uint32_t
mBlockerCount
;
uint32_t
mNumberOfProcessors
;
bool
mEnabled
;
bool
mDeferEnabled
;
bool
mDocumentParsingDone
;
bool
mBlockingDOMContentLoaded
;
bool
mLoadEventFired
;
nsRefPtrHashtable
<
nsURIHashKey
mozilla
:
:
GenericPromise
:
:
Private
>
mFetchingModules
;
nsRefPtrHashtable
<
nsURIHashKey
nsModuleScript
>
mFetchedModules
;
nsCOMPtr
<
nsIConsoleReportCollector
>
mReporter
;
}
;
class
nsScriptLoadHandler
final
:
public
nsIIncrementalStreamLoaderObserver
{
public
:
explicit
nsScriptLoadHandler
(
nsScriptLoader
*
aScriptLoader
nsScriptLoadRequest
*
aRequest
mozilla
:
:
dom
:
:
SRICheckDataVerifier
*
aSRIDataVerifier
)
;
NS_DECL_ISUPPORTS
NS_DECL_NSIINCREMENTALSTREAMLOADEROBSERVER
private
:
virtual
~
nsScriptLoadHandler
(
)
;
nsresult
DecodeRawData
(
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
)
;
bool
EnsureDecoder
(
nsIIncrementalStreamLoader
*
aLoader
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
)
;
bool
EnsureDecoder
(
nsIIncrementalStreamLoader
*
aLoader
const
uint8_t
*
aData
uint32_t
aDataLength
bool
aEndOfStream
nsCString
&
oCharset
)
;
nsresult
MaybeDecodeSRI
(
)
;
nsresult
EnsureKnownDataType
(
nsIIncrementalStreamLoader
*
aLoader
)
;
RefPtr
<
nsScriptLoader
>
mScriptLoader
;
RefPtr
<
nsScriptLoadRequest
>
mRequest
;
nsAutoPtr
<
mozilla
:
:
dom
:
:
SRICheckDataVerifier
>
mSRIDataVerifier
;
nsresult
mSRIStatus
;
nsCOMPtr
<
nsIUnicodeDecoder
>
mDecoder
;
}
;
class
nsAutoScriptLoaderDisabler
{
public
:
explicit
nsAutoScriptLoaderDisabler
(
nsIDocument
*
aDoc
)
{
mLoader
=
aDoc
-
>
ScriptLoader
(
)
;
mWasEnabled
=
mLoader
-
>
GetEnabled
(
)
;
if
(
mWasEnabled
)
{
mLoader
-
>
SetEnabled
(
false
)
;
}
}
~
nsAutoScriptLoaderDisabler
(
)
{
if
(
mWasEnabled
)
{
mLoader
-
>
SetEnabled
(
true
)
;
}
}
bool
mWasEnabled
;
RefPtr
<
nsScriptLoader
>
mLoader
;
}
;
#
endif
