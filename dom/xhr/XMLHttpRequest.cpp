#
include
"
XMLHttpRequest
.
h
"
#
include
"
XMLHttpRequestMainThread
.
h
"
#
include
"
XMLHttpRequestWorker
.
h
"
namespace
mozilla
{
namespace
dom
{
already_AddRefed
<
XMLHttpRequest
>
XMLHttpRequest
:
:
Constructor
(
const
GlobalObject
&
aGlobal
const
MozXMLHttpRequestParameters
&
aParams
ErrorResult
&
aRv
)
{
if
(
NS_IsMainThread
(
)
)
{
nsCOMPtr
<
nsIGlobalObject
>
global
=
do_QueryInterface
(
aGlobal
.
GetAsSupports
(
)
)
;
nsCOMPtr
<
nsIScriptObjectPrincipal
>
principal
=
do_QueryInterface
(
aGlobal
.
GetAsSupports
(
)
)
;
if
(
!
global
|
|
!
principal
)
{
aRv
.
Throw
(
NS_ERROR_FAILURE
)
;
return
nullptr
;
}
RefPtr
<
XMLHttpRequestMainThread
>
req
=
new
XMLHttpRequestMainThread
(
)
;
req
-
>
Construct
(
principal
-
>
GetPrincipal
(
)
global
)
;
req
-
>
InitParameters
(
aParams
.
mMozAnon
aParams
.
mMozSystem
)
;
return
req
.
forget
(
)
;
}
return
XMLHttpRequestWorker
:
:
Construct
(
aGlobal
aParams
aRv
)
;
}
}
}
