#
include
"
MemMapSnapshot
.
h
"
#
include
"
mozilla
/
AutoMemMap
.
h
"
#
include
"
mozilla
/
ResultExtensions
.
h
"
#
include
"
mozilla
/
Try
.
h
"
#
include
"
mozilla
/
ipc
/
FileDescriptor
.
h
"
namespace
mozilla
:
:
ipc
{
Result
<
Ok
nsresult
>
MemMapSnapshot
:
:
Init
(
size_t
aSize
)
{
MOZ_ASSERT
(
!
mInitialized
)
;
if
(
NS_WARN_IF
(
!
mMem
.
CreateFreezeable
(
aSize
)
)
)
{
return
Err
(
NS_ERROR_FAILURE
)
;
}
if
(
NS_WARN_IF
(
!
mMem
.
Map
(
aSize
)
)
)
{
return
Err
(
NS_ERROR_FAILURE
)
;
}
mInitialized
=
true
;
return
Ok
(
)
;
}
Result
<
Ok
nsresult
>
MemMapSnapshot
:
:
Finalize
(
loader
:
:
AutoMemMap
&
aMem
)
{
MOZ_ASSERT
(
mInitialized
)
;
if
(
NS_WARN_IF
(
!
mMem
.
Freeze
(
)
)
)
{
return
Err
(
NS_ERROR_FAILURE
)
;
}
size_t
size
=
mMem
.
max_size
(
)
;
FileDescriptor
memHandle
(
mMem
.
TakeHandle
(
)
)
;
MOZ_TRY
(
aMem
.
initWithHandle
(
memHandle
size
)
)
;
mInitialized
=
false
;
return
Ok
(
)
;
}
}
