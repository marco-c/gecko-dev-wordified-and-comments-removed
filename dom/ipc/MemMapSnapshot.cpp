#
include
"
MemMapSnapshot
.
h
"
#
include
"
mozilla
/
ResultExtensions
.
h
"
namespace
mozilla
:
:
ipc
{
Result
<
Ok
nsresult
>
MemMapSnapshot
:
:
Init
(
size_t
aSize
)
{
MOZ_ASSERT
(
!
mMem
)
;
auto
aMem
=
MakeRefPtr
<
SharedMemory
>
(
)
;
if
(
NS_WARN_IF
(
!
aMem
-
>
CreateFreezable
(
aSize
)
)
)
{
return
Err
(
NS_ERROR_FAILURE
)
;
}
if
(
NS_WARN_IF
(
!
aMem
-
>
Map
(
aSize
)
)
)
{
return
Err
(
NS_ERROR_FAILURE
)
;
}
mMem
=
std
:
:
move
(
aMem
)
;
return
Ok
(
)
;
}
Result
<
Ok
nsresult
>
MemMapSnapshot
:
:
Finalize
(
RefPtr
<
SharedMemory
>
&
aMem
)
{
MOZ_ASSERT
(
mMem
)
;
auto
size
=
mMem
-
>
Size
(
)
;
if
(
NS_WARN_IF
(
!
mMem
-
>
Freeze
(
)
)
)
{
return
Err
(
NS_ERROR_FAILURE
)
;
}
aMem
=
std
:
:
move
(
mMem
)
;
if
(
NS_WARN_IF
(
!
aMem
-
>
Map
(
size
)
)
)
{
return
Err
(
NS_ERROR_FAILURE
)
;
}
return
Ok
(
)
;
}
}
