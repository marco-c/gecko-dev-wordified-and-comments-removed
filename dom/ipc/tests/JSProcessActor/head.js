const
URL
=
"
about
:
blank
"
;
const
TEST_URL
=
"
http
:
/
/
test2
.
example
.
org
/
"
;
let
processActorOptions
=
{
parent
:
{
moduleURI
:
"
resource
:
/
/
testing
-
common
/
TestProcessActorParent
.
jsm
"
}
child
:
{
moduleURI
:
"
resource
:
/
/
testing
-
common
/
TestProcessActorChild
.
jsm
"
observers
:
[
"
test
-
js
-
content
-
actor
-
child
-
observer
"
]
}
}
;
function
promiseNotification
(
aNotification
)
{
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
let
notificationResolve
;
let
notificationObserver
=
function
observer
(
)
{
notificationResolve
(
)
;
Services
.
obs
.
removeObserver
(
notificationObserver
aNotification
)
;
}
;
return
new
Promise
(
resolve
=
>
{
notificationResolve
=
resolve
;
Services
.
obs
.
addObserver
(
notificationObserver
aNotification
)
;
}
)
;
}
function
declTest
(
name
cfg
)
{
let
{
url
=
"
about
:
blank
"
includeParent
=
false
remoteTypes
fission
test
}
=
cfg
;
let
actorOptions
=
{
parent
:
Object
.
assign
(
{
}
processActorOptions
.
parent
)
child
:
Object
.
assign
(
{
}
processActorOptions
.
child
)
}
;
actorOptions
.
includeParent
=
includeParent
;
if
(
remoteTypes
!
=
=
undefined
)
{
actorOptions
.
remoteTypes
=
remoteTypes
;
}
add_task
(
async
function
(
)
{
info
(
"
Entering
test
:
"
+
name
)
;
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
remote
:
true
fission
}
)
;
ChromeUtils
.
registerProcessActor
(
"
TestProcessActor
"
actorOptions
)
;
let
browser
=
win
.
gBrowser
.
selectedBrowser
;
BrowserTestUtils
.
loadURI
(
browser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
false
url
)
;
info
(
"
browser
ready
"
)
;
try
{
await
Promise
.
resolve
(
test
(
browser
win
)
)
;
}
finally
{
ChromeUtils
.
unregisterProcessActor
(
"
TestProcessActor
"
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
info
(
"
Exiting
test
:
"
+
name
)
;
}
}
)
;
}
