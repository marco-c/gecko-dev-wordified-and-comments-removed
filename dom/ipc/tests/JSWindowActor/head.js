const
URL
=
"
about
:
blank
"
;
const
TEST_URL
=
"
http
:
/
/
test2
.
example
.
org
/
"
;
let
windowActorOptions
=
{
parent
:
{
moduleURI
:
"
resource
:
/
/
testing
-
common
/
TestParent
.
jsm
"
}
child
:
{
moduleURI
:
"
resource
:
/
/
testing
-
common
/
TestChild
.
jsm
"
events
:
{
mozshowdropdown
:
{
}
}
observers
:
[
"
test
-
js
-
window
-
actor
-
child
-
observer
"
"
audio
-
playback
"
]
}
}
;
function
declTest
(
name
cfg
)
{
let
{
url
=
"
about
:
blank
"
allFrames
=
false
includeChrome
=
false
matches
remoteTypes
messageManagerGroups
fission
test
}
=
cfg
;
let
actorOptions
=
{
parent
:
Object
.
assign
(
{
}
windowActorOptions
.
parent
)
child
:
Object
.
assign
(
{
}
windowActorOptions
.
child
)
}
;
actorOptions
.
allFrames
=
allFrames
;
actorOptions
.
includeChrome
=
includeChrome
;
if
(
matches
!
=
=
undefined
)
{
actorOptions
.
matches
=
matches
;
}
if
(
remoteTypes
!
=
=
undefined
)
{
actorOptions
.
remoteTypes
=
remoteTypes
;
}
if
(
messageManagerGroups
!
=
=
undefined
)
{
actorOptions
.
messageManagerGroups
=
messageManagerGroups
;
}
add_task
(
async
function
(
)
{
info
(
"
Entering
test
:
"
+
name
)
;
let
win
=
await
BrowserTestUtils
.
openNewBrowserWindow
(
{
remote
:
true
fission
}
)
;
ChromeUtils
.
registerWindowActor
(
"
Test
"
actorOptions
)
;
let
browser
=
win
.
gBrowser
.
selectedBrowser
;
BrowserTestUtils
.
loadURI
(
browser
url
)
;
await
BrowserTestUtils
.
browserLoaded
(
browser
false
url
)
;
info
(
"
browser
ready
"
)
;
try
{
await
Promise
.
resolve
(
test
(
browser
win
)
)
;
}
finally
{
ChromeUtils
.
unregisterWindowActor
(
"
Test
"
)
;
await
BrowserTestUtils
.
closeWindow
(
win
)
;
info
(
"
Exiting
test
:
"
+
name
)
;
}
}
)
;
}
