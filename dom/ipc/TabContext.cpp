#
include
"
mozilla
/
dom
/
TabContext
.
h
"
#
include
"
mozilla
/
dom
/
PTabContext
.
h
"
#
include
"
mozilla
/
dom
/
TabParent
.
h
"
#
include
"
mozilla
/
dom
/
TabChild
.
h
"
#
include
"
nsIScriptSecurityManager
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
define
NO_APP_ID
(
nsIScriptSecurityManager
:
:
NO_APP_ID
)
using
namespace
mozilla
:
:
dom
:
:
ipc
;
using
namespace
mozilla
:
:
layout
;
namespace
mozilla
{
namespace
dom
{
TabContext
:
:
TabContext
(
)
:
mIsPrerendered
(
false
)
mInitialized
(
false
)
mIsMozBrowserElement
(
false
)
mOriginAttributes
(
)
mShowAccelerators
(
UIStateChangeType_NoChange
)
mShowFocusRings
(
UIStateChangeType_NoChange
)
{
}
bool
TabContext
:
:
IsMozBrowserElement
(
)
const
{
return
mIsMozBrowserElement
;
}
bool
TabContext
:
:
IsIsolatedMozBrowserElement
(
)
const
{
return
mOriginAttributes
.
mInIsolatedMozBrowser
;
}
bool
TabContext
:
:
IsMozBrowser
(
)
const
{
return
IsMozBrowserElement
(
)
;
}
bool
TabContext
:
:
SetTabContext
(
const
TabContext
&
aContext
)
{
NS_ENSURE_FALSE
(
mInitialized
false
)
;
*
this
=
aContext
;
mInitialized
=
true
;
return
true
;
}
void
TabContext
:
:
SetPrivateBrowsingAttributes
(
bool
aIsPrivateBrowsing
)
{
mOriginAttributes
.
SyncAttributesWithPrivateBrowsing
(
aIsPrivateBrowsing
)
;
}
bool
TabContext
:
:
UpdateTabContextAfterSwap
(
const
TabContext
&
aContext
)
{
MOZ_ASSERT
(
mInitialized
)
;
if
(
aContext
.
mOriginAttributes
!
=
mOriginAttributes
)
{
return
false
;
}
mIsMozBrowserElement
=
aContext
.
mIsMozBrowserElement
;
return
true
;
}
const
OriginAttributes
&
TabContext
:
:
OriginAttributesRef
(
)
const
{
return
mOriginAttributes
;
}
const
nsAString
&
TabContext
:
:
PresentationURL
(
)
const
{
return
mPresentationURL
;
}
UIStateChangeType
TabContext
:
:
ShowAccelerators
(
)
const
{
return
mShowAccelerators
;
}
UIStateChangeType
TabContext
:
:
ShowFocusRings
(
)
const
{
return
mShowFocusRings
;
}
bool
TabContext
:
:
SetTabContext
(
bool
aIsMozBrowserElement
bool
aIsPrerendered
UIStateChangeType
aShowAccelerators
UIStateChangeType
aShowFocusRings
const
OriginAttributes
&
aOriginAttributes
const
nsAString
&
aPresentationURL
)
{
NS_ENSURE_FALSE
(
mInitialized
false
)
;
MOZ_RELEASE_ASSERT
(
aOriginAttributes
.
mAppId
=
=
NO_APP_ID
)
;
mInitialized
=
true
;
mIsMozBrowserElement
=
aIsMozBrowserElement
;
mIsPrerendered
=
aIsPrerendered
;
mOriginAttributes
=
aOriginAttributes
;
mPresentationURL
=
aPresentationURL
;
mShowAccelerators
=
aShowAccelerators
;
mShowFocusRings
=
aShowFocusRings
;
return
true
;
}
IPCTabContext
TabContext
:
:
AsIPCTabContext
(
)
const
{
return
IPCTabContext
(
FrameIPCTabContext
(
mOriginAttributes
mIsMozBrowserElement
mIsPrerendered
mPresentationURL
mShowAccelerators
mShowFocusRings
)
)
;
}
MaybeInvalidTabContext
:
:
MaybeInvalidTabContext
(
const
IPCTabContext
&
aParams
)
:
mInvalidReason
(
nullptr
)
{
bool
isMozBrowserElement
=
false
;
bool
isPrerendered
=
false
;
OriginAttributes
originAttributes
;
nsAutoString
presentationURL
;
UIStateChangeType
showAccelerators
=
UIStateChangeType_NoChange
;
UIStateChangeType
showFocusRings
=
UIStateChangeType_NoChange
;
switch
(
aParams
.
type
(
)
)
{
case
IPCTabContext
:
:
TPopupIPCTabContext
:
{
const
PopupIPCTabContext
&
ipcContext
=
aParams
.
get_PopupIPCTabContext
(
)
;
TabContext
*
context
;
if
(
ipcContext
.
opener
(
)
.
type
(
)
=
=
PBrowserOrId
:
:
TPBrowserParent
)
{
context
=
TabParent
:
:
GetFrom
(
ipcContext
.
opener
(
)
.
get_PBrowserParent
(
)
)
;
if
(
!
context
)
{
mInvalidReason
=
"
Child
is
-
browser
process
tried
to
"
"
open
a
null
tab
.
"
;
return
;
}
if
(
context
-
>
IsMozBrowserElement
(
)
&
&
!
ipcContext
.
isMozBrowserElement
(
)
)
{
mInvalidReason
=
"
Child
is
-
browser
process
tried
to
"
"
open
a
non
-
browser
tab
.
"
;
return
;
}
}
else
if
(
ipcContext
.
opener
(
)
.
type
(
)
=
=
PBrowserOrId
:
:
TPBrowserChild
)
{
context
=
static_cast
<
TabChild
*
>
(
ipcContext
.
opener
(
)
.
get_PBrowserChild
(
)
)
;
}
else
if
(
ipcContext
.
opener
(
)
.
type
(
)
=
=
PBrowserOrId
:
:
TTabId
)
{
mInvalidReason
=
"
Child
process
tried
to
open
an
tab
without
the
opener
information
.
"
;
return
;
}
else
{
mInvalidReason
=
"
PopupIPCTabContext
:
:
opener
was
null
(
?
!
)
.
"
;
return
;
}
isMozBrowserElement
=
ipcContext
.
isMozBrowserElement
(
)
;
originAttributes
=
context
-
>
mOriginAttributes
;
break
;
}
case
IPCTabContext
:
:
TFrameIPCTabContext
:
{
const
FrameIPCTabContext
&
ipcContext
=
aParams
.
get_FrameIPCTabContext
(
)
;
isMozBrowserElement
=
ipcContext
.
isMozBrowserElement
(
)
;
isPrerendered
=
ipcContext
.
isPrerendered
(
)
;
presentationURL
=
ipcContext
.
presentationURL
(
)
;
showAccelerators
=
ipcContext
.
showAccelerators
(
)
;
showFocusRings
=
ipcContext
.
showFocusRings
(
)
;
originAttributes
=
ipcContext
.
originAttributes
(
)
;
break
;
}
case
IPCTabContext
:
:
TUnsafeIPCTabContext
:
{
#
ifdef
MOZ_B2G
mInvalidReason
=
"
ServiceWorkerClients
:
:
OpenWindow
is
not
supported
.
"
;
return
;
#
endif
if
(
!
Preferences
:
:
GetBool
(
"
dom
.
serviceWorkers
.
enabled
"
false
)
)
{
mInvalidReason
=
"
ServiceWorkers
should
be
enabled
.
"
;
return
;
}
break
;
}
default
:
{
MOZ_CRASH
(
)
;
}
}
bool
rv
;
rv
=
mTabContext
.
SetTabContext
(
isMozBrowserElement
isPrerendered
showAccelerators
showFocusRings
originAttributes
presentationURL
)
;
if
(
!
rv
)
{
mInvalidReason
=
"
Couldn
'
t
initialize
TabContext
.
"
;
}
}
bool
MaybeInvalidTabContext
:
:
IsValid
(
)
{
return
mInvalidReason
=
=
nullptr
;
}
const
char
*
MaybeInvalidTabContext
:
:
GetInvalidReason
(
)
{
return
mInvalidReason
;
}
const
TabContext
&
MaybeInvalidTabContext
:
:
GetTabContext
(
)
{
if
(
!
IsValid
(
)
)
{
MOZ_CRASH
(
"
Can
'
t
GetTabContext
(
)
if
!
IsValid
(
)
.
"
)
;
}
return
mTabContext
;
}
}
}
