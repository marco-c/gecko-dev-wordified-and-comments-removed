#
ifndef
dom_ipc_SharedStringMap_h
#
define
dom_ipc_SharedStringMap_h
#
include
"
mozilla
/
AutoMemMap
.
h
"
#
include
"
mozilla
/
Result
.
h
"
#
include
"
mozilla
/
dom
/
ipc
/
StringTable
.
h
"
#
include
"
nsDataHashtable
.
h
"
namespace
mozilla
{
namespace
dom
{
namespace
ipc
{
class
SharedStringMapBuilder
;
class
SharedStringMap
{
using
FileDescriptor
=
mozilla
:
:
ipc
:
:
FileDescriptor
;
public
:
struct
Header
{
uint32_t
mEntryCount
;
size_t
mKeyStringsOffset
;
size_t
mKeyStringsSize
;
size_t
mValueStringsOffset
;
size_t
mValueStringsSize
;
}
;
struct
Entry
{
StringTableEntry
mKey
;
StringTableEntry
mValue
;
}
;
NS_INLINE_DECL_REFCOUNTING
(
SharedStringMap
)
explicit
SharedStringMap
(
const
FileDescriptor
&
size_t
)
;
explicit
SharedStringMap
(
SharedStringMapBuilder
&
&
)
;
bool
Has
(
const
nsCString
&
aKey
)
;
bool
Get
(
const
nsCString
&
aKey
nsAString
&
aValue
)
;
private
:
bool
Find
(
const
nsCString
&
aKey
size_t
*
aIndex
)
;
public
:
uint32_t
Count
(
)
const
{
return
EntryCount
(
)
;
}
nsCString
GetKeyAt
(
uint32_t
aIndex
)
const
{
MOZ_ASSERT
(
aIndex
<
Count
(
)
)
;
return
KeyTable
(
)
.
Get
(
Entries
(
)
[
aIndex
]
.
mKey
)
;
}
nsString
GetValueAt
(
uint32_t
aIndex
)
const
{
MOZ_ASSERT
(
aIndex
<
Count
(
)
)
;
return
ValueTable
(
)
.
Get
(
Entries
(
)
[
aIndex
]
.
mValue
)
;
}
FileDescriptor
CloneFileDescriptor
(
)
const
;
size_t
MapSize
(
)
const
{
return
mMap
.
size
(
)
;
}
protected
:
~
SharedStringMap
(
)
=
default
;
private
:
const
Header
&
GetHeader
(
)
const
{
return
mMap
.
get
<
Header
>
(
)
[
0
]
;
}
RangedPtr
<
const
Entry
>
Entries
(
)
const
{
return
{
reinterpret_cast
<
const
Entry
*
>
(
&
GetHeader
(
)
+
1
)
EntryCount
(
)
}
;
}
uint32_t
EntryCount
(
)
const
{
return
GetHeader
(
)
.
mEntryCount
;
}
StringTable
<
nsCString
>
KeyTable
(
)
const
{
auto
&
header
=
GetHeader
(
)
;
return
{
{
&
mMap
.
get
<
uint8_t
>
(
)
[
header
.
mKeyStringsOffset
]
header
.
mKeyStringsSize
}
}
;
}
StringTable
<
nsString
>
ValueTable
(
)
const
{
auto
&
header
=
GetHeader
(
)
;
return
{
{
&
mMap
.
get
<
uint8_t
>
(
)
[
header
.
mValueStringsOffset
]
header
.
mValueStringsSize
}
}
;
}
loader
:
:
AutoMemMap
mMap
;
}
;
class
MOZ_RAII
SharedStringMapBuilder
{
public
:
SharedStringMapBuilder
(
)
=
default
;
void
Add
(
const
nsCString
&
aKey
const
nsString
&
aValue
)
;
Result
<
Ok
nsresult
>
Finalize
(
loader
:
:
AutoMemMap
&
aMap
)
;
private
:
using
Entry
=
SharedStringMap
:
:
Entry
;
StringTableBuilder
<
nsCStringHashKey
nsCString
>
mKeyTable
;
StringTableBuilder
<
nsStringHashKey
nsString
>
mValueTable
;
nsDataHashtable
<
nsCStringHashKey
Entry
>
mEntries
;
}
;
}
}
}
#
endif
