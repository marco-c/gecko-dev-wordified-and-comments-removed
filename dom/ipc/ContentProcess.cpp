#
include
"
mozilla
/
ipc
/
IOThreadChild
.
h
"
#
include
"
ContentProcess
.
h
"
#
include
"
base
/
shared_memory
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
<
stdlib
.
h
>
#
include
"
mozilla
/
Sandbox
.
h
"
#
endif
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
"
mozilla
/
WindowsProcessMitigations
.
h
"
#
endif
#
if
(
defined
(
XP_WIN
)
|
|
defined
(
XP_MACOSX
)
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
"
mozilla
/
SandboxSettings
.
h
"
#
include
"
nsAppDirectoryServiceDefs
.
h
"
#
include
"
nsDirectoryService
.
h
"
#
include
"
nsDirectoryServiceDefs
.
h
"
#
endif
#
include
"
nsAppRunner
.
h
"
#
include
"
mozilla
/
ipc
/
BackgroundChild
.
h
"
#
include
"
mozilla
/
ipc
/
ProcessUtils
.
h
"
using
mozilla
:
:
ipc
:
:
IOThreadChild
;
namespace
mozilla
:
:
dom
{
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
static
void
SetTmpEnvironmentVariable
(
nsIFile
*
aValue
)
{
nsAutoString
fullTmpPath
;
nsresult
rv
=
aValue
-
>
GetPath
(
fullTmpPath
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
;
}
Unused
<
<
NS_WARN_IF
(
!
SetEnvironmentVariableW
(
L
"
TMP
"
fullTmpPath
.
get
(
)
)
)
;
Unused
<
<
NS_WARN_IF
(
!
SetEnvironmentVariableW
(
L
"
TEMP
"
fullTmpPath
.
get
(
)
)
)
;
}
#
endif
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
static
void
SetUpSandboxEnvironment
(
)
{
MOZ_ASSERT
(
nsDirectoryService
:
:
gService
"
SetUpSandboxEnvironment
relies
on
nsDirectoryService
being
initialized
"
)
;
if
(
!
IsContentSandboxEnabled
(
)
|
|
IsWin32kLockedDown
(
)
)
{
return
;
}
nsCOMPtr
<
nsIFile
>
sandboxedContentTemp
;
nsresult
rv
=
nsDirectoryService
:
:
gService
-
>
Get
(
NS_APP_CONTENT_PROCESS_TEMP_DIR
NS_GET_IID
(
nsIFile
)
getter_AddRefs
(
sandboxedContentTemp
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
;
}
Unused
<
<
nsDirectoryService
:
:
gService
-
>
Undefine
(
NS_OS_TEMP_DIR
)
;
rv
=
nsDirectoryService
:
:
gService
-
>
Set
(
NS_OS_TEMP_DIR
sandboxedContentTemp
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
;
}
SetTmpEnvironmentVariable
(
sandboxedContentTemp
)
;
}
#
endif
bool
ContentProcess
:
:
Init
(
int
aArgc
char
*
aArgv
[
]
)
{
Maybe
<
uint64_t
>
childID
;
Maybe
<
bool
>
isForBrowser
;
Maybe
<
const
char
*
>
parentBuildID
;
char
*
prefsHandle
=
nullptr
;
char
*
prefMapHandle
=
nullptr
;
char
*
prefsLen
=
nullptr
;
char
*
prefMapSize
=
nullptr
;
char
*
jsInitHandle
=
nullptr
;
char
*
jsInitLen
=
nullptr
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
nsCOMPtr
<
nsIFile
>
profileDir
;
#
endif
for
(
int
i
=
1
;
i
<
aArgc
;
i
+
+
)
{
if
(
!
aArgv
[
i
]
)
{
continue
;
}
if
(
strcmp
(
aArgv
[
i
]
"
-
appdir
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
nsDependentCString
appDir
(
aArgv
[
i
]
)
;
mXREEmbed
.
SetAppDir
(
appDir
)
;
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
childID
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
char
*
str
=
aArgv
[
i
]
;
childID
=
Some
(
strtoull
(
str
&
str
10
)
)
;
if
(
str
[
0
]
!
=
'
\
0
'
)
{
return
false
;
}
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
isForBrowser
"
)
=
=
0
)
{
isForBrowser
=
Some
(
true
)
;
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
notForBrowser
"
)
=
=
0
)
{
isForBrowser
=
Some
(
false
)
;
#
ifdef
XP_WIN
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
prefsHandle
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
prefsHandle
=
aArgv
[
i
]
;
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
prefMapHandle
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
prefMapHandle
=
aArgv
[
i
]
;
#
endif
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
prefsLen
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
prefsLen
=
aArgv
[
i
]
;
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
prefMapSize
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
prefMapSize
=
aArgv
[
i
]
;
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
jsInit
"
)
=
=
0
)
{
#
ifdef
XP_WIN
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
jsInitHandle
=
aArgv
[
i
]
;
#
endif
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
jsInitLen
=
aArgv
[
i
]
;
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
safeMode
"
)
=
=
0
)
{
gSafeMode
=
true
;
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
parentBuildID
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
parentBuildID
=
Some
(
aArgv
[
i
]
)
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
}
else
if
(
strcmp
(
aArgv
[
i
]
"
-
profile
"
)
=
=
0
)
{
if
(
+
+
i
=
=
aArgc
)
{
return
false
;
}
bool
flag
;
nsresult
rv
=
XRE_GetFileFromPath
(
aArgv
[
i
]
getter_AddRefs
(
profileDir
)
)
;
if
(
NS_FAILED
(
rv
)
|
|
NS_FAILED
(
profileDir
-
>
Exists
(
&
flag
)
)
|
|
!
flag
)
{
NS_WARNING
(
"
Invalid
profile
directory
passed
to
content
process
.
"
)
;
profileDir
=
nullptr
;
}
#
endif
}
}
if
(
childID
.
isNothing
(
)
|
|
isForBrowser
.
isNothing
(
)
|
|
parentBuildID
.
isNothing
(
)
)
{
return
false
;
}
:
:
mozilla
:
:
ipc
:
:
SharedPreferenceDeserializer
deserializer
;
if
(
!
deserializer
.
DeserializeFromSharedMemory
(
prefsHandle
prefMapHandle
prefsLen
prefMapSize
)
)
{
return
false
;
}
if
(
!
:
:
mozilla
:
:
ipc
:
:
ImportSharedJSInit
(
jsInitHandle
jsInitLen
)
)
{
return
false
;
}
mContent
.
Init
(
ParentPid
(
)
*
parentBuildID
IOThreadChild
:
:
TakeInitialPort
(
)
*
childID
*
isForBrowser
)
;
mXREEmbed
.
Start
(
)
;
#
if
(
defined
(
XP_MACOSX
)
)
&
&
defined
(
MOZ_SANDBOX
)
mContent
.
SetProfileDir
(
profileDir
)
;
#
if
defined
(
DEBUG
)
if
(
IsContentSandboxEnabled
(
)
)
{
AssertMacSandboxEnabled
(
)
;
}
#
endif
#
endif
#
if
defined
(
XP_WIN
)
&
&
defined
(
MOZ_SANDBOX
)
SetUpSandboxEnvironment
(
)
;
#
endif
ipc
:
:
BackgroundChild
:
:
Startup
(
)
;
return
true
;
}
void
ContentProcess
:
:
CleanUp
(
)
{
mXREEmbed
.
Stop
(
)
;
}
}
