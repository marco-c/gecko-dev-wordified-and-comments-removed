#
include
"
VsyncMainChild
.
h
"
#
include
"
mozilla
/
SchedulerGroup
.
h
"
#
include
"
mozilla
/
VsyncDispatcher
.
h
"
#
include
"
nsThreadUtils
.
h
"
namespace
mozilla
:
:
dom
{
VsyncMainChild
:
:
VsyncMainChild
(
)
:
mIsShutdown
(
false
)
mVsyncRate
(
TimeDuration
:
:
Forever
(
)
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
VsyncMainChild
:
:
~
VsyncMainChild
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
void
VsyncMainChild
:
:
AddChildRefreshTimer
(
VsyncObserver
*
aVsyncObserver
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
!
mObservers
.
Contains
(
aVsyncObserver
)
)
;
if
(
mIsShutdown
)
{
return
;
}
if
(
mObservers
.
IsEmpty
(
)
)
{
Unused
<
<
PVsyncChild
:
:
SendObserve
(
)
;
}
mObservers
.
AppendElement
(
std
:
:
move
(
aVsyncObserver
)
)
;
}
void
VsyncMainChild
:
:
RemoveChildRefreshTimer
(
VsyncObserver
*
aVsyncObserver
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
mIsShutdown
)
{
return
;
}
if
(
mObservers
.
RemoveElement
(
aVsyncObserver
)
&
&
mObservers
.
IsEmpty
(
)
)
{
Unused
<
<
PVsyncChild
:
:
SendUnobserve
(
)
;
}
}
void
VsyncMainChild
:
:
ActorDestroy
(
ActorDestroyReason
aActorDestroyReason
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
!
mIsShutdown
)
;
mIsShutdown
=
true
;
if
(
!
mObservers
.
IsEmpty
(
)
)
{
Unused
<
<
PVsyncChild
:
:
SendUnobserve
(
)
;
}
mObservers
.
Clear
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
VsyncMainChild
:
:
RecvNotify
(
const
VsyncEvent
&
aVsync
const
float
&
aVsyncRate
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
!
mIsShutdown
)
;
SchedulerGroup
:
:
MarkVsyncRan
(
)
;
mVsyncRate
=
TimeDuration
:
:
FromMilliseconds
(
aVsyncRate
)
;
for
(
VsyncObserver
*
observer
:
mObservers
.
ForwardRange
(
)
)
{
observer
-
>
NotifyVsync
(
aVsync
)
;
}
return
IPC_OK
(
)
;
}
TimeDuration
VsyncMainChild
:
:
GetVsyncRate
(
)
{
return
mVsyncRate
;
}
}
