#
include
<
string
.
h
>
#
include
<
stddef
.
h
>
#
include
<
assert
.
h
>
#
include
"
r_common
.
h
"
#
include
"
r_memory
.
h
"
typedef
struct
r_malloc_chunk_
{
#
ifdef
SANITY_CHECKS
UINT4
hdr
;
#
endif
UCHAR
type
;
UINT4
size
;
UCHAR
memory
[
1
]
;
}
r_malloc_chunk
;
#
define
CHUNK_MEMORY_OFFSET
offsetof
(
struct
r_malloc_chunk_
memory
)
#
define
GET_CHUNK_ADDR_FROM_MEM_ADDR
(
memp
)
\
(
(
struct
r_malloc_chunk
*
)
(
(
(
unsigned
char
*
)
(
memp
)
)
-
CHUNK_MEMORY_OFFSET
)
)
#
define
CHUNK_SIZE
(
size
)
(
size
+
sizeof
(
r_malloc_chunk
)
)
#
define
HDR_FLAG
0x464c4147
static
UINT4
mem_usage
;
static
UINT4
mem_stats
[
256
]
;
void
*
r_malloc
(
int
type
size_t
size
)
{
size_t
total
;
r_malloc_chunk
*
chunk
=
0
;
total
=
size
+
sizeof
(
r_malloc_chunk
)
;
if
(
!
(
chunk
=
malloc
(
total
)
)
)
return
(
0
)
;
#
ifdef
SANITY_CHECKS
chunk
-
>
hdr
=
HDR_FLAG
;
#
endif
chunk
-
>
type
=
type
;
chunk
-
>
size
=
size
;
mem_usage
+
=
CHUNK_SIZE
(
size
)
;
mem_stats
[
type
]
+
=
size
;
return
(
chunk
-
>
memory
)
;
}
void
*
r_calloc
(
int
type
size_t
number
size_t
size
)
{
void
*
ret
=
0
;
size_t
total
;
total
=
number
*
size
;
if
(
!
(
ret
=
r_malloc
(
type
total
)
)
)
return
(
0
)
;
memset
(
ret
0
size
)
;
return
(
ret
)
;
}
void
r_free
(
void
*
ptr
)
{
r_malloc_chunk
*
chunk
=
0
;
if
(
!
ptr
)
return
;
chunk
=
(
r_malloc_chunk
*
)
GET_CHUNK_ADDR_FROM_MEM_ADDR
(
ptr
)
;
#
ifdef
SANITY_CHECKS
assert
(
chunk
-
>
hdr
=
=
HDR_FLAG
)
;
#
endif
mem_usage
-
=
CHUNK_SIZE
(
chunk
-
>
size
)
;
mem_stats
[
chunk
-
>
type
]
-
=
chunk
-
>
size
;
free
(
chunk
)
;
}
char
*
r_strdup
(
const
char
*
str
)
{
int
len
;
char
*
nstr
=
0
;
if
(
!
str
)
return
(
0
)
;
len
=
strlen
(
str
)
+
1
;
if
(
!
(
nstr
=
r_malloc
(
0
len
)
)
)
return
(
0
)
;
memcpy
(
nstr
str
len
)
;
return
(
nstr
)
;
}
