#
include
<
csi_platform
.
h
>
#
include
<
assert
.
h
>
#
include
<
string
.
h
>
#
ifdef
WIN32
#
include
"
addrs
-
win32
.
h
"
#
elif
defined
(
BSD
)
|
|
defined
(
DARWIN
)
#
include
"
addrs
-
bsd
.
h
"
#
else
#
include
"
addrs
-
netlink
.
h
"
#
endif
#
include
"
stun
.
h
"
#
include
"
addrs
.
h
"
#
include
"
util
.
h
"
static
int
nr_stun_is_duplicate_addr
(
nr_local_addr
addrs
[
]
int
count
nr_local_addr
*
addr
)
{
int
i
;
int
different
;
for
(
i
=
0
;
i
<
count
;
+
+
i
)
{
different
=
nr_transport_addr_cmp
(
&
addrs
[
i
]
.
addr
&
(
addr
-
>
addr
)
NR_TRANSPORT_ADDR_CMP_MODE_ALL
)
;
if
(
!
different
)
return
1
;
}
return
0
;
}
static
int
nr_stun_filter_find_first_addr_with_ifname
(
nr_local_addr
addrs
[
]
int
count
const
char
*
ifname
)
{
for
(
int
i
=
0
;
i
<
count
;
+
+
i
)
{
if
(
!
strncmp
(
addrs
[
i
]
.
addr
.
ifname
ifname
sizeof
(
addrs
[
i
]
.
addr
.
ifname
)
)
)
{
return
i
;
}
}
return
count
;
}
static
int
nr_stun_filter_addrs_for_ifname
(
nr_local_addr
src
[
]
const
int
src_begin
const
int
src_end
nr_local_addr
dest
[
]
int
*
dest_index
int
remove_loopback
int
remove_link_local
)
{
int
r
_status
;
int
filter_mac_ipv6
=
0
;
int
filter_teredo_ipv6
=
0
;
int
filter_non_temp_ipv6
=
0
;
const
char
*
ifname
=
src
[
src_begin
]
.
addr
.
ifname
;
for
(
int
i
=
src_begin
;
i
<
src_end
;
+
+
i
)
{
if
(
strncmp
(
ifname
src
[
i
]
.
addr
.
ifname
sizeof
(
src
[
i
]
.
addr
.
ifname
)
)
)
{
continue
;
}
if
(
src
[
i
]
.
addr
.
ip_version
=
=
NR_IPV6
)
{
if
(
nr_transport_addr_is_teredo
(
&
src
[
i
]
.
addr
)
)
{
src
[
i
]
.
interface
.
type
|
=
NR_INTERFACE_TYPE_TEREDO
;
filter_mac_ipv6
=
1
;
}
else
{
filter_teredo_ipv6
=
1
;
}
if
(
!
nr_transport_addr_is_mac_based
(
&
src
[
i
]
.
addr
)
)
{
filter_mac_ipv6
=
1
;
}
if
(
src
[
i
]
.
flags
&
NR_ADDR_FLAG_TEMPORARY
)
{
filter_non_temp_ipv6
=
1
;
}
}
}
for
(
int
i
=
src_begin
;
i
<
src_end
;
+
+
i
)
{
if
(
strncmp
(
ifname
src
[
i
]
.
addr
.
ifname
sizeof
(
src
[
i
]
.
addr
.
ifname
)
)
)
{
r_log
(
NR_LOG_STUN
LOG_WARNING
"
Ignoring
addr
from
interface
other
than
%
s
"
ifname
)
;
continue
;
}
if
(
nr_stun_is_duplicate_addr
(
dest
*
dest_index
&
src
[
i
]
)
)
{
r_log
(
NR_LOG_STUN
LOG_WARNING
"
Ignoring
duplicate
addr
"
)
;
}
else
if
(
remove_loopback
&
&
nr_transport_addr_is_loopback
(
&
src
[
i
]
.
addr
)
)
{
r_log
(
NR_LOG_STUN
LOG_WARNING
"
Ignoring
loopback
addr
"
)
;
}
else
if
(
remove_link_local
&
&
nr_transport_addr_is_link_local
(
&
src
[
i
]
.
addr
)
)
{
r_log
(
NR_LOG_STUN
LOG_WARNING
"
Ignoring
link
local
addr
"
)
;
}
else
if
(
filter_mac_ipv6
&
&
nr_transport_addr_is_mac_based
(
&
src
[
i
]
.
addr
)
)
{
r_log
(
NR_LOG_STUN
LOG_WARNING
"
Ignoring
MAC
-
based
addr
"
)
;
}
else
if
(
filter_teredo_ipv6
&
&
nr_transport_addr_is_teredo
(
&
src
[
i
]
.
addr
)
)
{
r_log
(
NR_LOG_STUN
LOG_WARNING
"
Ignoring
teredo
addr
"
)
;
}
else
if
(
filter_non_temp_ipv6
&
&
(
src
[
i
]
.
addr
.
ip_version
=
=
NR_IPV6
)
&
&
!
(
src
[
i
]
.
flags
&
NR_ADDR_FLAG_TEMPORARY
)
)
{
r_log
(
NR_LOG_STUN
LOG_WARNING
"
Ignoring
non
-
temp
addr
(
we
have
at
least
one
temp
addr
)
"
)
;
}
else
{
if
(
(
r
=
nr_local_addr_copy
(
&
dest
[
*
dest_index
]
&
src
[
i
]
)
)
)
ABORT
(
r
)
;
+
+
(
*
dest_index
)
;
}
}
_status
=
0
;
abort
:
return
_status
;
}
int
nr_stun_filter_addrs
(
nr_local_addr
addrs
[
]
int
remove_loopback
int
remove_link_local
int
*
count
)
{
int
r
_status
;
nr_local_addr
*
tmp
=
0
;
int
dest_index
=
0
;
tmp
=
RMALLOC
(
*
count
*
sizeof
(
*
tmp
)
)
;
if
(
!
tmp
)
ABORT
(
R_NO_MEMORY
)
;
for
(
int
i
=
0
;
i
<
*
count
;
+
+
i
)
{
if
(
i
=
=
nr_stun_filter_find_first_addr_with_ifname
(
addrs
*
count
addrs
[
i
]
.
addr
.
ifname
)
)
{
if
(
r
=
nr_stun_filter_addrs_for_ifname
(
addrs
i
*
count
tmp
&
dest_index
remove_loopback
remove_link_local
)
)
{
ABORT
(
r
)
;
}
}
}
memset
(
addrs
0
*
count
*
sizeof
(
*
addrs
)
)
;
*
count
=
dest_index
;
for
(
int
i
=
0
;
i
<
*
count
;
+
+
i
)
{
if
(
(
r
=
nr_local_addr_copy
(
&
addrs
[
i
]
&
tmp
[
i
]
)
)
)
ABORT
(
r
)
;
}
_status
=
0
;
abort
:
RFREE
(
tmp
)
;
return
_status
;
}
#
ifndef
USE_PLATFORM_NR_STUN_GET_ADDRS
int
nr_stun_get_addrs
(
nr_local_addr
addrs
[
]
int
maxaddrs
int
*
count
)
{
int
_status
=
0
;
int
i
;
char
typestr
[
100
]
;
if
(
maxaddrs
>
0
)
{
memset
(
addrs
0
maxaddrs
*
sizeof
(
nr_local_addr
)
)
;
}
_status
=
stun_getaddrs_filtered
(
addrs
maxaddrs
count
)
;
for
(
i
=
0
;
i
<
*
count
;
+
+
i
)
{
nr_local_addr_fmt_info_string
(
addrs
+
i
typestr
sizeof
(
typestr
)
)
;
r_log
(
NR_LOG_STUN
LOG_DEBUG
"
Address
%
d
:
%
s
on
%
s
type
:
%
s
\
n
"
i
addrs
[
i
]
.
addr
.
as_string
addrs
[
i
]
.
addr
.
ifname
typestr
)
;
}
return
_status
;
}
#
endif
