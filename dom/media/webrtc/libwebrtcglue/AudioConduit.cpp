#
include
"
AudioConduit
.
h
"
#
include
"
common
/
browser_logging
/
CSFLog
.
h
"
#
include
"
MediaConduitControl
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
include
"
transport
/
runnable_utils
.
h
"
#
include
"
WebrtcCallWrapper
.
h
"
#
include
"
api
/
audio_codecs
/
builtin_audio_encoder_factory
.
h
"
#
include
"
audio
/
audio_receive_stream
.
h
"
#
include
"
media
/
base
/
media_constants
.
h
"
#
ifdef
HAVE_NETINET_IN_H
#
include
<
netinet
/
in
.
h
>
#
elif
defined
XP_WIN
#
include
<
winsock2
.
h
>
#
endif
#
ifdef
MOZ_WIDGET_ANDROID
#
include
"
AndroidBridge
.
h
"
#
endif
namespace
mozilla
{
namespace
{
static
const
char
*
acLogTag
=
"
WebrtcAudioSessionConduit
"
;
#
ifdef
LOGTAG
#
undef
LOGTAG
#
endif
#
define
LOGTAG
acLogTag
using
namespace
cricket
;
using
LocalDirection
=
MediaSessionConduitLocalDirection
;
const
char
kCodecParamCbr
[
]
=
"
cbr
"
;
}
RefPtr
<
AudioSessionConduit
>
AudioSessionConduit
:
:
Create
(
RefPtr
<
WebrtcCallWrapper
>
aCall
nsCOMPtr
<
nsISerialEventTarget
>
aStsThread
)
{
CSFLogDebug
(
LOGTAG
"
%
s
"
__FUNCTION__
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
MakeRefPtr
<
WebrtcAudioConduit
>
(
std
:
:
move
(
aCall
)
std
:
:
move
(
aStsThread
)
)
;
}
#
define
INIT_MIRROR
(
name
val
)
\
name
(
aCallThread
val
"
WebrtcAudioConduit
:
:
Control
:
:
"
#
name
"
(
Mirror
)
"
)
WebrtcAudioConduit
:
:
Control
:
:
Control
(
const
RefPtr
<
AbstractThread
>
&
aCallThread
)
:
INIT_MIRROR
(
mReceiving
false
)
INIT_MIRROR
(
mTransmitting
false
)
INIT_MIRROR
(
mLocalSsrcs
Ssrcs
(
)
)
INIT_MIRROR
(
mLocalCname
std
:
:
string
(
)
)
INIT_MIRROR
(
mLocalMid
std
:
:
string
(
)
)
INIT_MIRROR
(
mRemoteSsrc
0
)
INIT_MIRROR
(
mSyncGroup
std
:
:
string
(
)
)
INIT_MIRROR
(
mLocalRecvRtpExtensions
RtpExtList
(
)
)
INIT_MIRROR
(
mLocalSendRtpExtensions
RtpExtList
(
)
)
INIT_MIRROR
(
mSendCodec
Nothing
(
)
)
INIT_MIRROR
(
mRecvCodecs
std
:
:
vector
<
AudioCodecConfig
>
(
)
)
{
}
#
undef
INIT_MIRROR
void
WebrtcAudioConduit
:
:
Shutdown
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mControl
.
mReceiving
.
DisconnectIfConnected
(
)
;
mControl
.
mTransmitting
.
DisconnectIfConnected
(
)
;
mControl
.
mLocalSsrcs
.
DisconnectIfConnected
(
)
;
mControl
.
mLocalCname
.
DisconnectIfConnected
(
)
;
mControl
.
mLocalMid
.
DisconnectIfConnected
(
)
;
mControl
.
mRemoteSsrc
.
DisconnectIfConnected
(
)
;
mControl
.
mSyncGroup
.
DisconnectIfConnected
(
)
;
mControl
.
mLocalRecvRtpExtensions
.
DisconnectIfConnected
(
)
;
mControl
.
mLocalSendRtpExtensions
.
DisconnectIfConnected
(
)
;
mControl
.
mSendCodec
.
DisconnectIfConnected
(
)
;
mControl
.
mRecvCodecs
.
DisconnectIfConnected
(
)
;
mControl
.
mOnDtmfEventListener
.
DisconnectIfExists
(
)
;
mWatchManager
.
Shutdown
(
)
;
MutexAutoLock
lock
(
mMutex
)
;
DeleteSendStream
(
)
;
DeleteRecvStream
(
)
;
}
WebrtcAudioConduit
:
:
WebrtcAudioConduit
(
RefPtr
<
WebrtcCallWrapper
>
aCall
nsCOMPtr
<
nsISerialEventTarget
>
aStsThread
)
:
mTransportMonitor
(
"
WebrtcAudioConduit
"
)
mTransmitterTransport
(
nullptr
)
mReceiverTransport
(
nullptr
)
mCall
(
std
:
:
move
(
aCall
)
)
mRecvStreamConfig
(
)
mRecvStream
(
nullptr
)
mSendStreamConfig
(
this
)
mSendStream
(
nullptr
)
mRecvSSRC
(
0
)
mSendStreamRunning
(
false
)
mRecvStreamRunning
(
false
)
mDtmfEnabled
(
false
)
mMutex
(
"
WebrtcAudioConduit
:
:
mMutex
"
)
mCallThread
(
std
:
:
move
(
mCall
-
>
mCallThread
)
)
mStsThread
(
std
:
:
move
(
aStsThread
)
)
mControl
(
mCall
-
>
mCallThread
)
mWatchManager
(
this
mCall
-
>
mCallThread
)
{
}
WebrtcAudioConduit
:
:
~
WebrtcAudioConduit
(
)
{
CSFLogDebug
(
LOGTAG
"
%
s
"
__FUNCTION__
)
;
MOZ_ASSERT
(
!
mSendStream
&
&
!
mRecvStream
"
Call
DeleteStreams
prior
to
~
WebrtcAudioConduit
.
"
)
;
}
#
define
CONNECT
(
aCanonical
aMirror
)
\
do
{
\
(
aMirror
)
.
Connect
(
aCanonical
)
;
\
mWatchManager
.
Watch
(
aMirror
&
WebrtcAudioConduit
:
:
OnControlConfigChange
)
;
\
}
while
(
0
)
void
WebrtcAudioConduit
:
:
InitControl
(
AudioConduitControlInterface
*
aControl
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
CONNECT
(
aControl
-
>
CanonicalReceiving
(
)
mControl
.
mReceiving
)
;
CONNECT
(
aControl
-
>
CanonicalTransmitting
(
)
mControl
.
mTransmitting
)
;
CONNECT
(
aControl
-
>
CanonicalLocalSsrcs
(
)
mControl
.
mLocalSsrcs
)
;
CONNECT
(
aControl
-
>
CanonicalLocalCname
(
)
mControl
.
mLocalCname
)
;
CONNECT
(
aControl
-
>
CanonicalLocalMid
(
)
mControl
.
mLocalMid
)
;
CONNECT
(
aControl
-
>
CanonicalRemoteSsrc
(
)
mControl
.
mRemoteSsrc
)
;
CONNECT
(
aControl
-
>
CanonicalSyncGroup
(
)
mControl
.
mSyncGroup
)
;
CONNECT
(
aControl
-
>
CanonicalLocalRecvRtpExtensions
(
)
mControl
.
mLocalRecvRtpExtensions
)
;
CONNECT
(
aControl
-
>
CanonicalLocalSendRtpExtensions
(
)
mControl
.
mLocalSendRtpExtensions
)
;
CONNECT
(
aControl
-
>
CanonicalAudioSendCodec
(
)
mControl
.
mSendCodec
)
;
CONNECT
(
aControl
-
>
CanonicalAudioRecvCodecs
(
)
mControl
.
mRecvCodecs
)
;
mControl
.
mOnDtmfEventListener
=
aControl
-
>
OnDtmfEvent
(
)
.
Connect
(
mCall
-
>
mCallThread
this
&
WebrtcAudioConduit
:
:
OnDtmfEvent
)
;
}
#
undef
CONNECT
void
WebrtcAudioConduit
:
:
OnDtmfEvent
(
const
DtmfEvent
&
aEvent
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
MOZ_ASSERT
(
mSendStream
)
;
MOZ_ASSERT
(
mDtmfEnabled
)
;
mSendStream
-
>
SendTelephoneEvent
(
aEvent
.
mPayloadType
aEvent
.
mPayloadFrequency
aEvent
.
mEventCode
aEvent
.
mLengthMs
)
;
}
void
WebrtcAudioConduit
:
:
OnControlConfigChange
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
bool
recvStreamReconfigureNeeded
=
false
;
bool
sendStreamReconfigureNeeded
=
false
;
bool
recvStreamRecreationNeeded
=
false
;
bool
sendStreamRecreationNeeded
=
false
;
if
(
!
mControl
.
mLocalSsrcs
.
Ref
(
)
.
empty
(
)
)
{
if
(
mControl
.
mLocalSsrcs
.
Ref
(
)
[
0
]
!
=
mSendStreamConfig
.
rtp
.
ssrc
)
{
sendStreamRecreationNeeded
=
true
;
recvStreamRecreationNeeded
=
true
;
}
mRecvStreamConfig
.
rtp
.
local_ssrc
=
mControl
.
mLocalSsrcs
.
Ref
(
)
[
0
]
;
mSendStreamConfig
.
rtp
.
ssrc
=
mControl
.
mLocalSsrcs
.
Ref
(
)
[
0
]
;
}
if
(
mControl
.
mLocalCname
.
Ref
(
)
!
=
mSendStreamConfig
.
rtp
.
c_name
)
{
mSendStreamConfig
.
rtp
.
c_name
=
mControl
.
mLocalCname
.
Ref
(
)
;
sendStreamReconfigureNeeded
=
true
;
}
if
(
mControl
.
mLocalMid
.
Ref
(
)
!
=
mSendStreamConfig
.
rtp
.
mid
)
{
mSendStreamConfig
.
rtp
.
mid
=
mControl
.
mLocalMid
.
Ref
(
)
;
sendStreamReconfigureNeeded
=
true
;
}
if
(
mControl
.
mRemoteSsrc
.
Ref
(
)
!
=
mControl
.
mConfiguredRemoteSsrc
)
{
mRecvSSRC
=
mRecvStreamConfig
.
rtp
.
remote_ssrc
=
mControl
.
mConfiguredRemoteSsrc
=
mControl
.
mRemoteSsrc
.
Ref
(
)
;
recvStreamRecreationNeeded
=
true
;
}
if
(
mControl
.
mSyncGroup
.
Ref
(
)
!
=
mRecvStreamConfig
.
sync_group
)
{
mRecvStreamConfig
.
sync_group
=
mControl
.
mSyncGroup
.
Ref
(
)
;
recvStreamRecreationNeeded
=
true
;
}
if
(
auto
filteredExtensions
=
FilterExtensions
(
LocalDirection
:
:
kRecv
mControl
.
mLocalRecvRtpExtensions
)
;
filteredExtensions
!
=
mRecvStreamConfig
.
rtp
.
extensions
)
{
mRecvStreamConfig
.
rtp
.
extensions
=
std
:
:
move
(
filteredExtensions
)
;
recvStreamRecreationNeeded
=
true
;
}
if
(
auto
filteredExtensions
=
FilterExtensions
(
LocalDirection
:
:
kSend
mControl
.
mLocalSendRtpExtensions
)
;
filteredExtensions
!
=
mSendStreamConfig
.
rtp
.
extensions
)
{
mSendStreamConfig
.
rtp
.
extensions
=
std
:
:
move
(
filteredExtensions
)
;
sendStreamReconfigureNeeded
=
true
;
}
mControl
.
mSendCodec
.
Ref
(
)
.
apply
(
[
&
]
(
const
auto
&
aConfig
)
{
if
(
mControl
.
mConfiguredSendCodec
!
=
mControl
.
mSendCodec
.
Ref
(
)
)
{
mControl
.
mConfiguredSendCodec
=
mControl
.
mSendCodec
;
if
(
ValidateCodecConfig
(
aConfig
true
)
=
=
kMediaConduitNoError
)
{
mSendStreamConfig
.
encoder_factory
=
webrtc
:
:
CreateBuiltinAudioEncoderFactory
(
)
;
webrtc
:
:
AudioSendStream
:
:
Config
:
:
SendCodecSpec
spec
(
aConfig
.
mType
CodecConfigToLibwebrtcFormat
(
aConfig
)
)
;
mSendStreamConfig
.
send_codec_spec
=
spec
;
mDtmfEnabled
=
aConfig
.
mDtmfEnabled
;
sendStreamReconfigureNeeded
=
true
;
}
}
}
)
;
if
(
mControl
.
mConfiguredRecvCodecs
!
=
mControl
.
mRecvCodecs
.
Ref
(
)
)
{
mControl
.
mConfiguredRecvCodecs
=
mControl
.
mRecvCodecs
;
mRecvStreamConfig
.
decoder_factory
=
mCall
-
>
mAudioDecoderFactory
;
mRecvStreamConfig
.
decoder_map
.
clear
(
)
;
for
(
const
auto
&
codec
:
mControl
.
mRecvCodecs
.
Ref
(
)
)
{
if
(
ValidateCodecConfig
(
codec
false
)
!
=
kMediaConduitNoError
)
{
continue
;
}
mRecvStreamConfig
.
decoder_map
.
emplace
(
codec
.
mType
CodecConfigToLibwebrtcFormat
(
codec
)
)
;
}
recvStreamReconfigureNeeded
=
true
;
}
if
(
!
recvStreamReconfigureNeeded
&
&
!
sendStreamReconfigureNeeded
&
&
!
recvStreamRecreationNeeded
&
&
!
sendStreamRecreationNeeded
&
&
mControl
.
mReceiving
=
=
mRecvStreamRunning
&
&
mControl
.
mTransmitting
=
=
mSendStreamRunning
)
{
return
;
}
MutexAutoLock
lock
(
mMutex
)
;
if
(
mRecvStream
)
{
if
(
recvStreamRecreationNeeded
)
{
DeleteRecvStream
(
)
;
CreateRecvStream
(
)
;
}
else
if
(
recvStreamReconfigureNeeded
)
{
mRecvStream
-
>
Reconfigure
(
mRecvStreamConfig
)
;
}
}
if
(
mSendStream
)
{
if
(
sendStreamRecreationNeeded
)
{
DeleteSendStream
(
)
;
CreateSendStream
(
)
;
}
else
if
(
sendStreamReconfigureNeeded
)
{
mSendStream
-
>
Reconfigure
(
mSendStreamConfig
)
;
}
}
if
(
!
mControl
.
mReceiving
)
{
StopReceivingLocked
(
)
;
}
if
(
!
mControl
.
mTransmitting
)
{
StopTransmittingLocked
(
)
;
}
if
(
mControl
.
mReceiving
)
{
StartReceivingLocked
(
)
;
}
if
(
mControl
.
mTransmitting
)
{
StartTransmittingLocked
(
)
;
}
}
std
:
:
vector
<
uint32_t
>
WebrtcAudioConduit
:
:
GetLocalSSRCs
(
)
const
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
return
std
:
:
vector
<
uint32_t
>
(
1
mRecvStreamConfig
.
rtp
.
local_ssrc
)
;
}
bool
WebrtcAudioConduit
:
:
OverrideRemoteSSRC
(
uint32_t
ssrc
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
if
(
mRecvStreamConfig
.
rtp
.
remote_ssrc
=
=
ssrc
)
{
return
true
;
}
mRecvSSRC
=
mRecvStreamConfig
.
rtp
.
remote_ssrc
=
ssrc
;
MutexAutoLock
lock
(
mMutex
)
;
bool
wasReceiving
=
mRecvStreamRunning
;
bool
hadRecvStream
=
mRecvStream
;
DeleteRecvStream
(
)
;
if
(
wasReceiving
)
{
if
(
StartReceivingLocked
(
)
!
=
kMediaConduitNoError
)
{
return
false
;
}
}
else
if
(
hadRecvStream
)
{
if
(
CreateRecvStream
(
)
!
=
kMediaConduitNoError
)
{
return
false
;
}
}
return
true
;
}
bool
WebrtcAudioConduit
:
:
GetRemoteSSRC
(
uint32_t
*
ssrc
)
const
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
if
(
!
mRecvStream
)
{
return
false
;
}
*
ssrc
=
mRecvStreamConfig
.
rtp
.
remote_ssrc
;
return
true
;
}
Maybe
<
webrtc
:
:
AudioReceiveStream
:
:
Stats
>
WebrtcAudioConduit
:
:
GetReceiverStats
(
)
const
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
if
(
!
mRecvStream
)
{
return
Nothing
(
)
;
}
return
Some
(
mRecvStream
-
>
GetStats
(
)
)
;
}
Maybe
<
webrtc
:
:
AudioSendStream
:
:
Stats
>
WebrtcAudioConduit
:
:
GetSenderStats
(
)
const
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
if
(
!
mSendStream
)
{
return
Nothing
(
)
;
}
return
Some
(
mSendStream
-
>
GetStats
(
)
)
;
}
webrtc
:
:
Call
:
:
Stats
WebrtcAudioConduit
:
:
GetCallStats
(
)
const
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
return
mCall
-
>
Call
(
)
-
>
GetStats
(
)
;
}
void
WebrtcAudioConduit
:
:
OnRtcpBye
(
)
{
mRtcpByeEvent
.
Notify
(
)
;
}
void
WebrtcAudioConduit
:
:
OnRtcpTimeout
(
)
{
mRtcpTimeoutEvent
.
Notify
(
)
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
SetTransmitterTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
{
CSFLogDebug
(
LOGTAG
"
%
s
"
__FUNCTION__
)
;
ReentrantMonitorAutoEnter
enter
(
mTransportMonitor
)
;
mTransmitterTransport
=
aTransport
;
return
kMediaConduitNoError
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
SetReceiverTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
{
CSFLogDebug
(
LOGTAG
"
%
s
"
__FUNCTION__
)
;
ReentrantMonitorAutoEnter
enter
(
mTransportMonitor
)
;
mReceiverTransport
=
aTransport
;
return
kMediaConduitNoError
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
SendAudioFrame
(
std
:
:
unique_ptr
<
webrtc
:
:
AudioFrame
>
frame
)
{
CSFLogDebug
(
LOGTAG
"
%
s
"
__FUNCTION__
)
;
if
(
!
frame
-
>
data
(
)
|
|
(
IsSamplingFreqSupported
(
frame
-
>
sample_rate_hz
(
)
)
=
=
false
)
|
|
(
(
frame
-
>
samples_per_channel
(
)
%
(
frame
-
>
sample_rate_hz
(
)
/
100
)
!
=
0
)
)
)
{
CSFLogError
(
LOGTAG
"
%
s
Invalid
Parameters
"
__FUNCTION__
)
;
MOZ_ASSERT
(
PR_FALSE
)
;
return
kMediaConduitMalformedArgument
;
}
MutexAutoLock
lock
(
mMutex
)
;
if
(
!
mSendStreamRunning
)
{
CSFLogError
(
LOGTAG
"
%
s
Engine
not
transmitting
"
__FUNCTION__
)
;
return
kMediaConduitSessionNotInited
;
}
mSendStream
-
>
SendAudioData
(
std
:
:
move
(
frame
)
)
;
return
kMediaConduitNoError
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
GetAudioFrame
(
int32_t
samplingFreqHz
webrtc
:
:
AudioFrame
*
frame
)
{
CSFLogDebug
(
LOGTAG
"
%
s
"
__FUNCTION__
)
;
if
(
!
frame
)
{
CSFLogError
(
LOGTAG
"
%
s
Null
Audio
Buffer
Pointer
"
__FUNCTION__
)
;
MOZ_ASSERT
(
PR_FALSE
)
;
return
kMediaConduitMalformedArgument
;
}
if
(
GetNum10msSamplesForFrequency
(
samplingFreqHz
)
=
=
0
)
{
CSFLogError
(
LOGTAG
"
%
s
Invalid
Sampling
Frequency
"
__FUNCTION__
)
;
MOZ_ASSERT
(
PR_FALSE
)
;
return
kMediaConduitMalformedArgument
;
}
MutexAutoTryLock
tryLock
(
mMutex
)
;
if
(
!
tryLock
)
{
CSFLogError
(
LOGTAG
"
%
s
Conduit
going
through
negotiation
"
__FUNCTION__
)
;
return
kMediaConduitPlayoutError
;
}
if
(
!
mRecvStreamRunning
)
{
CSFLogError
(
LOGTAG
"
%
s
Engine
not
Receiving
"
__FUNCTION__
)
;
return
kMediaConduitSessionNotInited
;
}
auto
info
=
static_cast
<
webrtc
:
:
internal
:
:
AudioReceiveStream
*
>
(
mRecvStream
)
-
>
GetAudioFrameWithInfo
(
samplingFreqHz
frame
)
;
if
(
info
=
=
webrtc
:
:
AudioMixer
:
:
Source
:
:
AudioFrameInfo
:
:
kError
)
{
CSFLogError
(
LOGTAG
"
%
s
Getting
audio
frame
failed
"
__FUNCTION__
)
;
return
kMediaConduitPlayoutError
;
}
CSFLogDebug
(
LOGTAG
"
%
s
Got
%
zu
channels
of
%
zu
samples
"
__FUNCTION__
frame
-
>
num_channels
(
)
frame
-
>
samples_per_channel
(
)
)
;
return
kMediaConduitNoError
;
}
void
WebrtcAudioConduit
:
:
ReceivedRTPPacket
(
const
uint8_t
*
data
int
len
webrtc
:
:
RTPHeader
&
header
)
{
ASSERT_ON_THREAD
(
mStsThread
)
;
if
(
mRtpPacketQueue
.
IsQueueActive
(
)
)
{
mRtpPacketQueue
.
Enqueue
(
rtc
:
:
CopyOnWriteBuffer
(
data
len
)
)
;
return
;
}
if
(
mRecvSSRC
!
=
header
.
ssrc
)
{
mRtpPacketQueue
.
Clear
(
)
;
mRtpPacketQueue
.
Enqueue
(
rtc
:
:
CopyOnWriteBuffer
(
data
len
)
)
;
CSFLogDebug
(
LOGTAG
"
%
s
:
switching
from
SSRC
%
u
to
%
u
"
__FUNCTION__
static_cast
<
uint32_t
>
(
mRecvSSRC
)
header
.
ssrc
)
;
mRecvSSRC
=
header
.
ssrc
;
InvokeAsync
(
mCallThread
__func__
[
this
self
=
RefPtr
<
WebrtcAudioConduit
>
(
this
)
ssrc
=
header
.
ssrc
]
(
)
mutable
{
OverrideRemoteSSRC
(
ssrc
)
;
return
GenericPromise
:
:
CreateAndResolve
(
true
__func__
)
;
}
)
-
>
Then
(
mStsThread
__func__
[
this
self
=
RefPtr
<
WebrtcAudioConduit
>
(
this
)
ssrc
=
header
.
ssrc
]
(
)
mutable
{
if
(
ssrc
!
=
mRecvSSRC
)
{
return
;
}
mRtpPacketQueue
.
DequeueAll
(
this
)
;
}
)
;
return
;
}
CSFLogVerbose
(
LOGTAG
"
%
s
:
seq
#
%
u
Len
%
d
SSRC
%
u
(
0x
%
x
)
"
__FUNCTION__
(
uint16_t
)
ntohs
(
(
(
uint16_t
*
)
data
)
[
1
]
)
len
(
uint32_t
)
ntohl
(
(
(
uint32_t
*
)
data
)
[
2
]
)
(
uint32_t
)
ntohl
(
(
(
uint32_t
*
)
data
)
[
2
]
)
)
;
DeliverPacket
(
rtc
:
:
CopyOnWriteBuffer
(
data
len
)
PacketType
:
:
RTP
)
;
}
void
WebrtcAudioConduit
:
:
ReceivedRTCPPacket
(
const
uint8_t
*
data
int
len
)
{
CSFLogDebug
(
LOGTAG
"
%
s
"
__FUNCTION__
)
;
ASSERT_ON_THREAD
(
mStsThread
)
;
DeliverPacket
(
rtc
:
:
CopyOnWriteBuffer
(
data
len
)
PacketType
:
:
RTCP
)
;
mLastRtcpReceived
=
Some
(
GetNow
(
)
)
;
}
Maybe
<
DOMHighResTimeStamp
>
WebrtcAudioConduit
:
:
LastRtcpReceived
(
)
const
{
ASSERT_ON_THREAD
(
mStsThread
)
;
return
mLastRtcpReceived
;
}
DOMHighResTimeStamp
WebrtcAudioConduit
:
:
GetNow
(
)
const
{
return
mCall
-
>
GetNow
(
)
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
StopTransmittingLocked
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
if
(
mSendStreamRunning
)
{
MOZ_ASSERT
(
mSendStream
)
;
CSFLogDebug
(
LOGTAG
"
%
s
Engine
Already
Sending
.
Attemping
to
Stop
"
__FUNCTION__
)
;
mSendStream
-
>
Stop
(
)
;
mSendStreamRunning
=
false
;
}
return
kMediaConduitNoError
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
StartTransmittingLocked
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
if
(
mSendStreamRunning
)
{
return
kMediaConduitNoError
;
}
if
(
!
mSendStream
)
{
CreateSendStream
(
)
;
}
mCall
-
>
Call
(
)
-
>
SignalChannelNetworkState
(
webrtc
:
:
MediaType
:
:
AUDIO
webrtc
:
:
kNetworkUp
)
;
mSendStream
-
>
Start
(
)
;
mSendStreamRunning
=
true
;
return
kMediaConduitNoError
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
StopReceivingLocked
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
if
(
mRecvStreamRunning
)
{
MOZ_ASSERT
(
mRecvStream
)
;
mRecvStream
-
>
Stop
(
)
;
mRecvStreamRunning
=
false
;
}
return
kMediaConduitNoError
;
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
StartReceivingLocked
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
if
(
mRecvStreamRunning
)
{
return
kMediaConduitNoError
;
}
if
(
!
mRecvStream
)
{
CreateRecvStream
(
)
;
}
mCall
-
>
Call
(
)
-
>
SignalChannelNetworkState
(
webrtc
:
:
MediaType
:
:
AUDIO
webrtc
:
:
kNetworkUp
)
;
mRecvStream
-
>
Start
(
)
;
mRecvStreamRunning
=
true
;
return
kMediaConduitNoError
;
}
bool
WebrtcAudioConduit
:
:
SendRtp
(
const
uint8_t
*
data
size_t
len
const
webrtc
:
:
PacketOptions
&
options
)
{
CSFLogDebug
(
LOGTAG
"
%
s
:
len
%
lu
"
__FUNCTION__
(
unsigned
long
)
len
)
;
ReentrantMonitorAutoEnter
enter
(
mTransportMonitor
)
;
if
(
mTransmitterTransport
&
&
(
mTransmitterTransport
-
>
SendRtpPacket
(
data
len
)
=
=
NS_OK
)
)
{
CSFLogDebug
(
LOGTAG
"
%
s
Sent
RTP
Packet
"
__FUNCTION__
)
;
if
(
options
.
packet_id
>
=
0
)
{
int64_t
now_ms
=
PR_Now
(
)
/
1000
;
MOZ_ALWAYS_SUCCEEDS
(
mCallThread
-
>
Dispatch
(
NS_NewRunnableFunction
(
__func__
[
call
=
mCall
packet_id
=
options
.
packet_id
now_ms
]
{
if
(
call
-
>
Call
(
)
)
{
call
-
>
Call
(
)
-
>
OnSentPacket
(
{
packet_id
now_ms
}
)
;
}
}
)
)
)
;
}
return
true
;
}
CSFLogError
(
LOGTAG
"
%
s
RTP
Packet
Send
Failed
"
__FUNCTION__
)
;
return
false
;
}
bool
WebrtcAudioConduit
:
:
SendRtcp
(
const
uint8_t
*
data
size_t
len
)
{
CSFLogDebug
(
LOGTAG
"
%
s
:
len
%
lu
first
rtcp
=
%
u
"
__FUNCTION__
(
unsigned
long
)
len
static_cast
<
unsigned
>
(
data
[
1
]
)
)
;
ReentrantMonitorAutoEnter
enter
(
mTransportMonitor
)
;
if
(
mReceiverTransport
&
&
mReceiverTransport
-
>
SendRtcpPacket
(
data
len
)
=
=
NS_OK
)
{
CSFLogDebug
(
LOGTAG
"
%
s
Sent
RTCP
Packet
"
__FUNCTION__
)
;
return
true
;
}
if
(
mTransmitterTransport
&
&
(
mTransmitterTransport
-
>
SendRtcpPacket
(
data
len
)
=
=
NS_OK
)
)
{
CSFLogDebug
(
LOGTAG
"
%
s
Sent
RTCP
Packet
(
sender
report
)
"
__FUNCTION__
)
;
return
true
;
}
CSFLogError
(
LOGTAG
"
%
s
RTCP
Packet
Send
Failed
"
__FUNCTION__
)
;
return
false
;
}
bool
WebrtcAudioConduit
:
:
CodecConfigToWebRTCCodec
(
const
AudioCodecConfig
&
codecInfo
webrtc
:
:
AudioSendStream
:
:
Config
&
config
)
{
config
.
encoder_factory
=
webrtc
:
:
CreateBuiltinAudioEncoderFactory
(
)
;
webrtc
:
:
AudioSendStream
:
:
Config
:
:
SendCodecSpec
spec
(
codecInfo
.
mType
CodecConfigToLibwebrtcFormat
(
codecInfo
)
)
;
config
.
send_codec_spec
=
spec
;
return
true
;
}
bool
WebrtcAudioConduit
:
:
IsSamplingFreqSupported
(
int
freq
)
const
{
return
GetNum10msSamplesForFrequency
(
freq
)
!
=
0
;
}
std
:
:
vector
<
webrtc
:
:
RtpSource
>
WebrtcAudioConduit
:
:
GetUpstreamRtpSources
(
)
const
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
std
:
:
vector
<
webrtc
:
:
RtpSource
>
sources
;
{
MutexAutoLock
lock
(
mMutex
)
;
if
(
mRecvStream
)
{
sources
=
mRecvStream
-
>
GetSources
(
)
;
}
}
return
sources
;
}
unsigned
int
WebrtcAudioConduit
:
:
GetNum10msSamplesForFrequency
(
int
samplingFreqHz
)
const
{
switch
(
samplingFreqHz
)
{
case
16000
:
return
160
;
case
32000
:
return
320
;
case
44100
:
return
441
;
case
48000
:
return
480
;
default
:
return
0
;
}
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
ValidateCodecConfig
(
const
AudioCodecConfig
&
codecInfo
bool
send
)
{
if
(
codecInfo
.
mName
.
empty
(
)
)
{
CSFLogError
(
LOGTAG
"
%
s
Empty
Payload
Name
"
__FUNCTION__
)
;
return
kMediaConduitMalformedArgument
;
}
if
(
(
codecInfo
.
mChannels
!
=
1
)
&
&
(
codecInfo
.
mChannels
!
=
2
)
)
{
CSFLogError
(
LOGTAG
"
%
s
Channel
Unsupported
"
__FUNCTION__
)
;
return
kMediaConduitMalformedArgument
;
}
return
kMediaConduitNoError
;
}
RtpExtList
WebrtcAudioConduit
:
:
FilterExtensions
(
LocalDirection
aDirection
const
RtpExtList
&
aExtensions
)
{
const
bool
isSend
=
aDirection
=
=
LocalDirection
:
:
kSend
;
RtpExtList
filteredExtensions
;
for
(
const
auto
&
extension
:
aExtensions
)
{
if
(
extension
.
uri
=
=
webrtc
:
:
RtpExtension
:
:
kAudioLevelUri
)
{
filteredExtensions
.
push_back
(
webrtc
:
:
RtpExtension
(
extension
.
uri
extension
.
id
)
)
;
}
if
(
extension
.
uri
=
=
webrtc
:
:
RtpExtension
:
:
kCsrcAudioLevelUri
)
{
if
(
isSend
)
{
continue
;
}
filteredExtensions
.
push_back
(
webrtc
:
:
RtpExtension
(
extension
.
uri
extension
.
id
)
)
;
}
if
(
extension
.
uri
=
=
webrtc
:
:
RtpExtension
:
:
kMidUri
)
{
if
(
!
isSend
)
{
continue
;
}
filteredExtensions
.
push_back
(
webrtc
:
:
RtpExtension
(
extension
.
uri
extension
.
id
)
)
;
}
}
return
filteredExtensions
;
}
webrtc
:
:
SdpAudioFormat
WebrtcAudioConduit
:
:
CodecConfigToLibwebrtcFormat
(
const
AudioCodecConfig
&
aConfig
)
{
webrtc
:
:
SdpAudioFormat
:
:
Parameters
parameters
;
if
(
aConfig
.
mName
=
=
kOpusCodecName
)
{
if
(
aConfig
.
mChannels
=
=
2
)
{
parameters
[
kCodecParamStereo
]
=
kParamValueTrue
;
}
if
(
aConfig
.
mFECEnabled
)
{
parameters
[
kCodecParamUseInbandFec
]
=
kParamValueTrue
;
}
if
(
aConfig
.
mDTXEnabled
)
{
parameters
[
kCodecParamUseDtx
]
=
kParamValueTrue
;
}
if
(
aConfig
.
mMaxPlaybackRate
)
{
parameters
[
kCodecParamMaxPlaybackRate
]
=
std
:
:
to_string
(
aConfig
.
mMaxPlaybackRate
)
;
}
if
(
aConfig
.
mMaxAverageBitrate
)
{
parameters
[
kCodecParamMaxAverageBitrate
]
=
std
:
:
to_string
(
aConfig
.
mMaxAverageBitrate
)
;
}
if
(
aConfig
.
mFrameSizeMs
)
{
parameters
[
kCodecParamPTime
]
=
std
:
:
to_string
(
aConfig
.
mFrameSizeMs
)
;
}
if
(
aConfig
.
mMinFrameSizeMs
)
{
parameters
[
kCodecParamMinPTime
]
=
std
:
:
to_string
(
aConfig
.
mMinFrameSizeMs
)
;
}
if
(
aConfig
.
mMaxFrameSizeMs
)
{
parameters
[
kCodecParamMaxPTime
]
=
std
:
:
to_string
(
aConfig
.
mMaxFrameSizeMs
)
;
}
if
(
aConfig
.
mCbrEnabled
)
{
parameters
[
"
cbr
"
]
=
kParamValueTrue
;
}
}
return
webrtc
:
:
SdpAudioFormat
(
aConfig
.
mName
aConfig
.
mFreq
aConfig
.
mChannels
parameters
)
;
}
void
WebrtcAudioConduit
:
:
DeleteSendStream
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
if
(
mSendStream
)
{
mCall
-
>
Call
(
)
-
>
DestroyAudioSendStream
(
mSendStream
)
;
mSendStreamRunning
=
false
;
mSendStream
=
nullptr
;
}
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
CreateSendStream
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
mSendStream
=
mCall
-
>
Call
(
)
-
>
CreateAudioSendStream
(
mSendStreamConfig
)
;
if
(
!
mSendStream
)
{
return
kMediaConduitUnknownError
;
}
return
kMediaConduitNoError
;
}
void
WebrtcAudioConduit
:
:
DeleteRecvStream
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
if
(
mRecvStream
)
{
mCall
-
>
Call
(
)
-
>
DestroyAudioReceiveStream
(
mRecvStream
)
;
mRecvStreamRunning
=
false
;
mRecvStream
=
nullptr
;
}
}
MediaConduitErrorCode
WebrtcAudioConduit
:
:
CreateRecvStream
(
)
{
MOZ_ASSERT
(
mCallThread
-
>
IsOnCurrentThread
(
)
)
;
mMutex
.
AssertCurrentThreadOwns
(
)
;
mRecvStreamConfig
.
rtcp_send_transport
=
this
;
mRecvStreamConfig
.
rtp
.
rtcp_event_observer
=
this
;
mRecvStream
=
mCall
-
>
Call
(
)
-
>
CreateAudioReceiveStream
(
mRecvStreamConfig
)
;
if
(
!
mRecvStream
)
{
return
kMediaConduitUnknownError
;
}
return
kMediaConduitNoError
;
}
void
WebrtcAudioConduit
:
:
DeliverPacket
(
rtc
:
:
CopyOnWriteBuffer
packet
PacketType
type
)
{
ASSERT_ON_THREAD
(
mStsThread
)
;
MOZ_ALWAYS_SUCCEEDS
(
mCallThread
-
>
Dispatch
(
NS_NewRunnableFunction
(
__func__
[
this
self
=
RefPtr
<
WebrtcAudioConduit
>
(
this
)
packet
=
std
:
:
move
(
packet
)
type
]
{
if
(
!
mCall
-
>
Call
(
)
)
{
return
;
}
webrtc
:
:
PacketReceiver
:
:
DeliveryStatus
status
=
mCall
-
>
Call
(
)
-
>
Receiver
(
)
-
>
DeliverPacket
(
webrtc
:
:
MediaType
:
:
AUDIO
std
:
:
move
(
packet
)
-
1
)
;
if
(
status
!
=
webrtc
:
:
PacketReceiver
:
:
DELIVERY_OK
)
{
CSFLogError
(
LOGTAG
"
%
s
DeliverPacket
Failed
for
%
s
packet
%
d
"
__FUNCTION__
type
=
=
PacketType
:
:
RTP
?
"
RTP
"
:
"
RTCP
"
status
)
;
}
}
)
)
)
;
}
}
