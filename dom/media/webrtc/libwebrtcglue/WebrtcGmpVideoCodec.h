#
ifndef
WEBRTCGMPVIDEOCODEC_H_
#
define
WEBRTCGMPVIDEOCODEC_H_
#
include
<
queue
>
#
include
<
string
>
#
include
"
nsThreadUtils
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
include
"
mozIGeckoMediaPluginService
.
h
"
#
include
"
MediaConduitInterface
.
h
"
#
include
"
AudioConduit
.
h
"
#
include
"
PerformanceRecorder
.
h
"
#
include
"
VideoConduit
.
h
"
#
include
"
api
/
video
/
video_frame_type
.
h
"
#
include
"
modules
/
video_coding
/
include
/
video_codec_interface
.
h
"
#
include
"
common_video
/
h264
/
h264_bitstream_parser
.
h
"
#
include
"
gmp
-
video
-
host
.
h
"
#
include
"
GMPVideoDecoderProxy
.
h
"
#
include
"
GMPVideoEncoderProxy
.
h
"
#
include
"
jsapi
/
PeerConnectionImpl
.
h
"
namespace
mozilla
{
class
GmpInitDoneRunnable
:
public
Runnable
{
public
:
explicit
GmpInitDoneRunnable
(
std
:
:
string
aPCHandle
)
:
Runnable
(
"
GmpInitDoneRunnable
"
)
mResult
(
WEBRTC_VIDEO_CODEC_OK
)
mPCHandle
(
std
:
:
move
(
aPCHandle
)
)
{
}
NS_IMETHOD
Run
(
)
override
{
Telemetry
:
:
Accumulate
(
Telemetry
:
:
WEBRTC_GMP_INIT_SUCCESS
mResult
=
=
WEBRTC_VIDEO_CODEC_OK
)
;
if
(
mResult
=
=
WEBRTC_VIDEO_CODEC_OK
)
{
return
NS_OK
;
}
PeerConnectionWrapper
wrapper
(
mPCHandle
)
;
if
(
wrapper
.
impl
(
)
)
{
wrapper
.
impl
(
)
-
>
OnMediaError
(
mError
)
;
}
return
NS_OK
;
}
void
Dispatch
(
int32_t
aResult
const
std
:
:
string
&
aError
=
"
"
)
{
mResult
=
aResult
;
mError
=
aError
;
nsCOMPtr
<
nsIThread
>
mainThread
(
do_GetMainThread
(
)
)
;
if
(
mainThread
)
{
mainThread
-
>
Dispatch
(
do_AddRef
(
static_cast
<
nsIRunnable
*
>
(
this
)
)
NS_DISPATCH_NORMAL
)
;
}
}
int32_t
Result
(
)
{
return
mResult
;
}
private
:
int32_t
mResult
;
const
std
:
:
string
mPCHandle
;
std
:
:
string
mError
;
}
;
class
GMPDecodeData
{
public
:
GMPDecodeData
(
const
webrtc
:
:
EncodedImage
&
aInputImage
bool
aMissingFrames
int64_t
aRenderTimeMs
)
:
mImage
(
aInputImage
)
mMissingFrames
(
aMissingFrames
)
mRenderTimeMs
(
aRenderTimeMs
)
{
MOZ_RELEASE_ASSERT
(
aInputImage
.
size
(
)
<
(
std
:
:
numeric_limits
<
size_t
>
:
:
max
(
)
>
>
1
)
)
;
}
~
GMPDecodeData
(
)
=
default
;
const
webrtc
:
:
EncodedImage
mImage
;
const
bool
mMissingFrames
;
const
int64_t
mRenderTimeMs
;
}
;
class
RefCountedWebrtcVideoEncoder
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
RefCountedWebrtcVideoEncoder
)
;
virtual
int32_t
InitEncode
(
const
webrtc
:
:
VideoCodec
*
aCodecSettings
const
webrtc
:
:
VideoEncoder
:
:
Settings
&
aSettings
)
=
0
;
virtual
int32_t
Encode
(
const
webrtc
:
:
VideoFrame
&
aInputImage
const
std
:
:
vector
<
webrtc
:
:
VideoFrameType
>
*
aFrameTypes
)
=
0
;
virtual
int32_t
RegisterEncodeCompleteCallback
(
webrtc
:
:
EncodedImageCallback
*
aCallback
)
=
0
;
virtual
int32_t
Shutdown
(
)
=
0
;
virtual
int32_t
SetRates
(
const
webrtc
:
:
VideoEncoder
:
:
RateControlParameters
&
aParameters
)
=
0
;
virtual
MediaEventSource
<
uint64_t
>
*
InitPluginEvent
(
)
=
0
;
virtual
MediaEventSource
<
uint64_t
>
*
ReleasePluginEvent
(
)
=
0
;
virtual
WebrtcVideoEncoder
:
:
EncoderInfo
GetEncoderInfo
(
)
const
=
0
;
protected
:
virtual
~
RefCountedWebrtcVideoEncoder
(
)
=
default
;
}
;
class
WebrtcGmpVideoEncoder
:
public
GMPVideoEncoderCallbackProxy
public
RefCountedWebrtcVideoEncoder
{
public
:
WebrtcGmpVideoEncoder
(
const
webrtc
:
:
SdpVideoFormat
&
aFormat
std
:
:
string
aPCHandle
)
;
int32_t
InitEncode
(
const
webrtc
:
:
VideoCodec
*
aCodecSettings
const
webrtc
:
:
VideoEncoder
:
:
Settings
&
aSettings
)
override
;
int32_t
Encode
(
const
webrtc
:
:
VideoFrame
&
aInputImage
const
std
:
:
vector
<
webrtc
:
:
VideoFrameType
>
*
aFrameTypes
)
override
;
int32_t
RegisterEncodeCompleteCallback
(
webrtc
:
:
EncodedImageCallback
*
aCallback
)
override
;
int32_t
Shutdown
(
)
override
;
int32_t
SetRates
(
const
webrtc
:
:
VideoEncoder
:
:
RateControlParameters
&
aParameters
)
override
;
WebrtcVideoEncoder
:
:
EncoderInfo
GetEncoderInfo
(
)
const
override
;
MediaEventSource
<
uint64_t
>
*
InitPluginEvent
(
)
override
{
return
&
mInitPluginEvent
;
}
MediaEventSource
<
uint64_t
>
*
ReleasePluginEvent
(
)
override
{
return
&
mReleasePluginEvent
;
}
virtual
void
Terminated
(
)
override
;
virtual
void
Encoded
(
GMPVideoEncodedFrame
*
aEncodedFrame
const
nsTArray
<
uint8_t
>
&
aCodecSpecificInfo
)
override
;
virtual
void
Error
(
GMPErr
aError
)
override
{
}
private
:
virtual
~
WebrtcGmpVideoEncoder
(
)
;
static
void
InitEncode_g
(
const
RefPtr
<
WebrtcGmpVideoEncoder
>
&
aThis
const
GMPVideoCodec
&
aCodecParams
int32_t
aNumberOfCores
uint32_t
aMaxPayloadSize
const
RefPtr
<
GmpInitDoneRunnable
>
&
aInitDone
)
;
int32_t
GmpInitDone
(
GMPVideoEncoderProxy
*
aGMP
GMPVideoHost
*
aHost
const
GMPVideoCodec
&
aCodecParams
std
:
:
string
*
aErrorOut
)
;
int32_t
GmpInitDone
(
GMPVideoEncoderProxy
*
aGMP
GMPVideoHost
*
aHost
std
:
:
string
*
aErrorOut
)
;
int32_t
InitEncoderForSize
(
unsigned
short
aWidth
unsigned
short
aHeight
std
:
:
string
*
aErrorOut
)
;
static
void
ReleaseGmp_g
(
const
RefPtr
<
WebrtcGmpVideoEncoder
>
&
aEncoder
)
;
void
Close_g
(
)
;
class
InitDoneCallback
:
public
GetGMPVideoEncoderCallback
{
public
:
InitDoneCallback
(
const
RefPtr
<
WebrtcGmpVideoEncoder
>
&
aEncoder
const
RefPtr
<
GmpInitDoneRunnable
>
&
aInitDone
const
GMPVideoCodec
&
aCodecParams
)
:
mEncoder
(
aEncoder
)
mInitDone
(
aInitDone
)
mCodecParams
(
aCodecParams
)
{
}
virtual
void
Done
(
GMPVideoEncoderProxy
*
aGMP
GMPVideoHost
*
aHost
)
override
{
std
:
:
string
errorOut
;
int32_t
result
=
mEncoder
-
>
GmpInitDone
(
aGMP
aHost
mCodecParams
&
errorOut
)
;
mInitDone
-
>
Dispatch
(
result
errorOut
)
;
}
private
:
const
RefPtr
<
WebrtcGmpVideoEncoder
>
mEncoder
;
const
RefPtr
<
GmpInitDoneRunnable
>
mInitDone
;
const
GMPVideoCodec
mCodecParams
;
}
;
static
void
Encode_g
(
const
RefPtr
<
WebrtcGmpVideoEncoder
>
&
aEncoder
webrtc
:
:
VideoFrame
aInputImage
std
:
:
vector
<
webrtc
:
:
VideoFrameType
>
aFrameTypes
)
;
void
RegetEncoderForResolutionChange
(
uint32_t
aWidth
uint32_t
aHeight
const
RefPtr
<
GmpInitDoneRunnable
>
&
aInitDone
)
;
class
InitDoneForResolutionChangeCallback
:
public
GetGMPVideoEncoderCallback
{
public
:
InitDoneForResolutionChangeCallback
(
const
RefPtr
<
WebrtcGmpVideoEncoder
>
&
aEncoder
const
RefPtr
<
GmpInitDoneRunnable
>
&
aInitDone
uint32_t
aWidth
uint32_t
aHeight
)
:
mEncoder
(
aEncoder
)
mInitDone
(
aInitDone
)
mWidth
(
aWidth
)
mHeight
(
aHeight
)
{
}
virtual
void
Done
(
GMPVideoEncoderProxy
*
aGMP
GMPVideoHost
*
aHost
)
override
{
std
:
:
string
errorOut
;
int32_t
result
=
mEncoder
-
>
GmpInitDone
(
aGMP
aHost
&
errorOut
)
;
if
(
result
!
=
WEBRTC_VIDEO_CODEC_OK
)
{
mInitDone
-
>
Dispatch
(
result
errorOut
)
;
return
;
}
result
=
mEncoder
-
>
InitEncoderForSize
(
mWidth
mHeight
&
errorOut
)
;
mInitDone
-
>
Dispatch
(
result
errorOut
)
;
}
private
:
const
RefPtr
<
WebrtcGmpVideoEncoder
>
mEncoder
;
const
RefPtr
<
GmpInitDoneRunnable
>
mInitDone
;
const
uint32_t
mWidth
;
const
uint32_t
mHeight
;
}
;
static
int32_t
SetRates_g
(
RefPtr
<
WebrtcGmpVideoEncoder
>
aThis
uint32_t
aNewBitRateKbps
Maybe
<
double
>
aFrameRate
)
;
nsCOMPtr
<
mozIGeckoMediaPluginService
>
mMPS
;
nsCOMPtr
<
nsIThread
>
mGMPThread
;
GMPVideoEncoderProxy
*
mGMP
;
bool
mInitting
;
GMPVideoHost
*
mHost
;
GMPVideoCodec
mCodecParams
;
uint32_t
mMaxPayloadSize
;
const
webrtc
:
:
SdpVideoFormat
:
:
Parameters
mFormatParams
;
webrtc
:
:
CodecSpecificInfo
mCodecSpecificInfo
;
webrtc
:
:
H264BitstreamParser
mH264BitstreamParser
;
Mutex
mCallbackMutex
MOZ_UNANNOTATED
;
webrtc
:
:
EncodedImageCallback
*
mCallback
;
Maybe
<
uint64_t
>
mCachedPluginId
;
const
std
:
:
string
mPCHandle
;
struct
InputImageData
{
int64_t
timestamp_us
;
}
;
DataMutex
<
std
:
:
map
<
uint32_t
InputImageData
>
>
mInputImageMap
;
MediaEventProducer
<
uint64_t
>
mInitPluginEvent
;
MediaEventProducer
<
uint64_t
>
mReleasePluginEvent
;
}
;
class
WebrtcVideoEncoderProxy
:
public
WebrtcVideoEncoder
{
public
:
explicit
WebrtcVideoEncoderProxy
(
RefPtr
<
RefCountedWebrtcVideoEncoder
>
aEncoder
)
:
mEncoderImpl
(
std
:
:
move
(
aEncoder
)
)
{
}
virtual
~
WebrtcVideoEncoderProxy
(
)
{
RegisterEncodeCompleteCallback
(
nullptr
)
;
}
MediaEventSource
<
uint64_t
>
*
InitPluginEvent
(
)
override
{
return
mEncoderImpl
-
>
InitPluginEvent
(
)
;
}
MediaEventSource
<
uint64_t
>
*
ReleasePluginEvent
(
)
override
{
return
mEncoderImpl
-
>
ReleasePluginEvent
(
)
;
}
int32_t
InitEncode
(
const
webrtc
:
:
VideoCodec
*
aCodecSettings
const
WebrtcVideoEncoder
:
:
Settings
&
aSettings
)
override
{
return
mEncoderImpl
-
>
InitEncode
(
aCodecSettings
aSettings
)
;
}
int32_t
Encode
(
const
webrtc
:
:
VideoFrame
&
aInputImage
const
std
:
:
vector
<
webrtc
:
:
VideoFrameType
>
*
aFrameTypes
)
override
{
return
mEncoderImpl
-
>
Encode
(
aInputImage
aFrameTypes
)
;
}
int32_t
RegisterEncodeCompleteCallback
(
webrtc
:
:
EncodedImageCallback
*
aCallback
)
override
{
return
mEncoderImpl
-
>
RegisterEncodeCompleteCallback
(
aCallback
)
;
}
int32_t
Release
(
)
override
{
return
mEncoderImpl
-
>
Shutdown
(
)
;
}
void
SetRates
(
const
RateControlParameters
&
aParameters
)
override
{
mEncoderImpl
-
>
SetRates
(
aParameters
)
;
}
EncoderInfo
GetEncoderInfo
(
)
const
override
{
return
mEncoderImpl
-
>
GetEncoderInfo
(
)
;
}
private
:
const
RefPtr
<
RefCountedWebrtcVideoEncoder
>
mEncoderImpl
;
}
;
class
WebrtcGmpVideoDecoder
:
public
GMPVideoDecoderCallbackProxy
{
public
:
WebrtcGmpVideoDecoder
(
std
:
:
string
aPCHandle
TrackingId
aTrackingId
)
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
WebrtcGmpVideoDecoder
)
;
virtual
bool
Configure
(
const
webrtc
:
:
VideoDecoder
:
:
Settings
&
settings
)
;
virtual
int32_t
Decode
(
const
webrtc
:
:
EncodedImage
&
aInputImage
bool
aMissingFrames
int64_t
aRenderTimeMs
)
;
virtual
int32_t
RegisterDecodeCompleteCallback
(
webrtc
:
:
DecodedImageCallback
*
aCallback
)
;
virtual
int32_t
ReleaseGmp
(
)
;
MediaEventSource
<
uint64_t
>
*
InitPluginEvent
(
)
{
return
&
mInitPluginEvent
;
}
MediaEventSource
<
uint64_t
>
*
ReleasePluginEvent
(
)
{
return
&
mReleasePluginEvent
;
}
virtual
void
Terminated
(
)
override
;
virtual
void
Decoded
(
GMPVideoi420Frame
*
aDecodedFrame
)
override
;
virtual
void
ReceivedDecodedReferenceFrame
(
const
uint64_t
aPictureId
)
override
{
MOZ_CRASH
(
)
;
}
virtual
void
ReceivedDecodedFrame
(
const
uint64_t
aPictureId
)
override
{
MOZ_CRASH
(
)
;
}
virtual
void
InputDataExhausted
(
)
override
{
}
virtual
void
DrainComplete
(
)
override
{
}
virtual
void
ResetComplete
(
)
override
{
}
virtual
void
Error
(
GMPErr
aError
)
override
{
mDecoderStatus
=
aError
;
}
private
:
virtual
~
WebrtcGmpVideoDecoder
(
)
;
static
void
Configure_g
(
const
RefPtr
<
WebrtcGmpVideoDecoder
>
&
aThis
const
webrtc
:
:
VideoDecoder
:
:
Settings
&
settings
const
RefPtr
<
GmpInitDoneRunnable
>
&
aInitDone
)
;
int32_t
GmpInitDone
(
GMPVideoDecoderProxy
*
aGMP
GMPVideoHost
*
aHost
std
:
:
string
*
aErrorOut
)
;
static
void
ReleaseGmp_g
(
const
RefPtr
<
WebrtcGmpVideoDecoder
>
&
aDecoder
)
;
void
Close_g
(
)
;
class
InitDoneCallback
:
public
GetGMPVideoDecoderCallback
{
public
:
explicit
InitDoneCallback
(
const
RefPtr
<
WebrtcGmpVideoDecoder
>
&
aDecoder
const
RefPtr
<
GmpInitDoneRunnable
>
&
aInitDone
)
:
mDecoder
(
aDecoder
)
mInitDone
(
aInitDone
)
{
}
virtual
void
Done
(
GMPVideoDecoderProxy
*
aGMP
GMPVideoHost
*
aHost
)
override
{
std
:
:
string
errorOut
;
int32_t
result
=
mDecoder
-
>
GmpInitDone
(
aGMP
aHost
&
errorOut
)
;
mInitDone
-
>
Dispatch
(
result
errorOut
)
;
}
private
:
const
RefPtr
<
WebrtcGmpVideoDecoder
>
mDecoder
;
const
RefPtr
<
GmpInitDoneRunnable
>
mInitDone
;
}
;
static
void
Decode_g
(
const
RefPtr
<
WebrtcGmpVideoDecoder
>
&
aThis
UniquePtr
<
GMPDecodeData
>
&
&
aDecodeData
)
;
nsCOMPtr
<
mozIGeckoMediaPluginService
>
mMPS
;
nsCOMPtr
<
nsIThread
>
mGMPThread
;
GMPVideoDecoderProxy
*
mGMP
;
bool
mInitting
;
nsTArray
<
UniquePtr
<
GMPDecodeData
>
>
mQueuedFrames
;
GMPVideoHost
*
mHost
;
Mutex
mCallbackMutex
MOZ_UNANNOTATED
;
webrtc
:
:
DecodedImageCallback
*
mCallback
;
Maybe
<
uint64_t
>
mCachedPluginId
;
Atomic
<
GMPErr
ReleaseAcquire
>
mDecoderStatus
;
const
std
:
:
string
mPCHandle
;
const
TrackingId
mTrackingId
;
PerformanceRecorderMulti
<
DecodeStage
>
mPerformanceRecorder
;
MediaEventProducer
<
uint64_t
>
mInitPluginEvent
;
MediaEventProducer
<
uint64_t
>
mReleasePluginEvent
;
}
;
class
WebrtcVideoDecoderProxy
:
public
WebrtcVideoDecoder
{
public
:
explicit
WebrtcVideoDecoderProxy
(
std
:
:
string
aPCHandle
TrackingId
aTrackingId
)
:
mDecoderImpl
(
new
WebrtcGmpVideoDecoder
(
std
:
:
move
(
aPCHandle
)
std
:
:
move
(
aTrackingId
)
)
)
{
}
virtual
~
WebrtcVideoDecoderProxy
(
)
{
RegisterDecodeCompleteCallback
(
nullptr
)
;
}
MediaEventSource
<
uint64_t
>
*
InitPluginEvent
(
)
override
{
return
mDecoderImpl
-
>
InitPluginEvent
(
)
;
}
MediaEventSource
<
uint64_t
>
*
ReleasePluginEvent
(
)
override
{
return
mDecoderImpl
-
>
ReleasePluginEvent
(
)
;
}
bool
Configure
(
const
Settings
&
settings
)
override
{
return
mDecoderImpl
-
>
Configure
(
settings
)
;
}
int32_t
Decode
(
const
webrtc
:
:
EncodedImage
&
aInputImage
bool
aMissingFrames
int64_t
aRenderTimeMs
)
override
{
return
mDecoderImpl
-
>
Decode
(
aInputImage
aMissingFrames
aRenderTimeMs
)
;
}
int32_t
RegisterDecodeCompleteCallback
(
webrtc
:
:
DecodedImageCallback
*
aCallback
)
override
{
return
mDecoderImpl
-
>
RegisterDecodeCompleteCallback
(
aCallback
)
;
}
int32_t
Release
(
)
override
{
return
mDecoderImpl
-
>
ReleaseGmp
(
)
;
}
private
:
const
RefPtr
<
WebrtcGmpVideoDecoder
>
mDecoderImpl
;
}
;
}
#
endif
