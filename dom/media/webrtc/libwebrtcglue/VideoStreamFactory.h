#
ifndef
VideoStreamFactory_h
#
define
VideoStreamFactory_h
#
include
"
CodecConfig
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
DataMutex
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
api
/
video
/
video_source_interface
.
h
"
#
include
"
api
/
video_codecs
/
video_encoder_config
.
h
"
#
include
"
common_video
/
framerate_controller
.
h
"
#
include
"
rtc_base
/
time_utils
.
h
"
namespace
webrtc
{
class
VideoFrame
;
}
namespace
mozilla
{
class
VideoStreamFactory
:
public
webrtc
:
:
VideoEncoderConfig
:
:
VideoStreamFactoryInterface
{
public
:
struct
ResolutionAndBitrateLimits
{
int
resolution_in_mb
;
int
min_bitrate_bps
;
int
start_bitrate_bps
;
int
max_bitrate_bps
;
}
;
static
ResolutionAndBitrateLimits
GetLimitsFor
(
unsigned
int
aWidth
unsigned
int
aHeight
int
aCapBps
=
0
)
;
VideoStreamFactory
(
VideoCodecConfig
aConfig
webrtc
:
:
VideoCodecMode
aCodecMode
int
aMinBitrate
int
aStartBitrate
int
aPrefMaxBitrate
int
aNegotiatedMaxBitrate
const
rtc
:
:
VideoSinkWants
&
aWants
bool
aLockScaling
)
:
mCodecMode
(
aCodecMode
)
mMaxFramerateForAllStreams
(
std
:
:
numeric_limits
<
unsigned
int
>
:
:
max
(
)
)
mCodecConfig
(
std
:
:
forward
<
VideoCodecConfig
>
(
aConfig
)
)
mMinBitrate
(
aMinBitrate
)
mStartBitrate
(
aStartBitrate
)
mPrefMaxBitrate
(
aPrefMaxBitrate
)
mNegotiatedMaxBitrate
(
aNegotiatedMaxBitrate
)
mFramerateController
(
"
VideoStreamFactory
:
:
mFramerateController
"
)
mWants
(
aWants
)
mLockScaling
(
aLockScaling
)
{
}
std
:
:
vector
<
webrtc
:
:
VideoStream
>
CreateEncoderStreams
(
int
aWidth
int
aHeight
const
webrtc
:
:
VideoEncoderConfig
&
aConfig
)
override
;
void
SelectMaxFramerateForAllStreams
(
unsigned
short
aWidth
unsigned
short
aHeight
)
;
bool
ShouldDropFrame
(
const
webrtc
:
:
VideoFrame
&
aFrame
)
;
private
:
gfx
:
:
IntSize
CalculateScaledResolution
(
int
aWidth
int
aHeight
double
aScaleDownByResolution
unsigned
int
aMaxPixelCount
)
;
unsigned
int
SelectFrameRate
(
unsigned
int
aOldFramerate
unsigned
short
aSendingWidth
unsigned
short
aSendingHeight
)
;
Atomic
<
webrtc
:
:
VideoCodecMode
>
mCodecMode
;
Atomic
<
unsigned
int
>
mMaxFramerateForAllStreams
;
const
VideoCodecConfig
mCodecConfig
;
const
int
mMinBitrate
=
0
;
const
int
mStartBitrate
=
0
;
const
int
mPrefMaxBitrate
=
0
;
const
int
mNegotiatedMaxBitrate
=
0
;
DataMutex
<
webrtc
:
:
FramerateController
>
mFramerateController
;
const
rtc
:
:
VideoSinkWants
mWants
;
const
bool
mLockScaling
;
}
;
}
#
endif
