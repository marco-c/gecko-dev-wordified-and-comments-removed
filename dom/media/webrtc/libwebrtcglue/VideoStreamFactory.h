#
ifndef
VideoStreamFactory_h
#
define
VideoStreamFactory_h
#
include
"
CodecConfig
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
rtc_base
/
time_utils
.
h
"
#
include
"
video
/
config
/
video_encoder_config
.
h
"
namespace
webrtc
{
class
VideoFrame
;
}
namespace
mozilla
{
class
VideoStreamFactory
:
public
webrtc
:
:
VideoEncoderConfig
:
:
VideoStreamFactoryInterface
{
public
:
struct
ResolutionAndBitrateLimits
{
int
resolution_in_mb
;
int
min_bitrate_bps
;
int
start_bitrate_bps
;
int
max_bitrate_bps
;
}
;
static
ResolutionAndBitrateLimits
GetLimitsFor
(
gfx
:
:
IntSize
aSize
int
aCapBps
=
0
)
;
VideoStreamFactory
(
VideoCodecConfig
aConfig
int
aMinBitrate
int
aStartBitrate
int
aPrefMaxBitrate
int
aNegotiatedMaxBitrate
)
:
mMaxFramerateForAllStreams
(
std
:
:
numeric_limits
<
unsigned
int
>
:
:
max
(
)
)
mCodecConfig
(
std
:
:
forward
<
VideoCodecConfig
>
(
aConfig
)
)
mMinBitrate
(
aMinBitrate
)
mStartBitrate
(
aStartBitrate
)
mPrefMaxBitrate
(
aPrefMaxBitrate
)
mNegotiatedMaxBitrate
(
aNegotiatedMaxBitrate
)
{
}
std
:
:
vector
<
webrtc
:
:
VideoStream
>
CreateEncoderStreams
(
const
webrtc
:
:
FieldTrialsView
&
field_trials
int
aWidth
int
aHeight
const
webrtc
:
:
VideoEncoderConfig
&
aConfig
)
override
;
void
SelectResolutionAndMaxFramerate
(
gfx
:
:
IntSize
aSize
const
VideoCodecConfig
:
:
Encoding
&
aEncoding
webrtc
:
:
VideoStream
&
aVideoStream
)
;
void
SelectMaxFramerateForAllStreams
(
gfx
:
:
IntSize
aSize
)
;
private
:
gfx
:
:
IntSize
CalculateScaledResolution
(
gfx
:
:
IntSize
aSize
double
aScaleDownByResolution
)
;
unsigned
int
SelectFrameRate
(
unsigned
int
aOldFramerate
gfx
:
:
IntSize
aSize
)
;
Atomic
<
unsigned
int
>
mMaxFramerateForAllStreams
;
const
VideoCodecConfig
mCodecConfig
;
const
int
mMinBitrate
=
0
;
const
int
mStartBitrate
=
0
;
const
int
mPrefMaxBitrate
=
0
;
const
int
mNegotiatedMaxBitrate
=
0
;
}
;
}
#
endif
