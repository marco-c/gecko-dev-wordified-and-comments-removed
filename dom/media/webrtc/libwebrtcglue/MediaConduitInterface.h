#
ifndef
MEDIA_CONDUIT_ABSTRACTION_
#
define
MEDIA_CONDUIT_ABSTRACTION_
#
include
<
vector
>
#
include
<
functional
>
#
include
<
map
>
#
include
"
CodecConfig
.
h
"
#
include
"
ImageContainer
.
h
"
#
include
"
jsapi
/
RTCStatsReport
.
h
"
#
include
"
MediaConduitErrors
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
include
"
VideoTypes
.
h
"
#
include
"
WebrtcVideoCodecFactory
.
h
"
#
include
"
RtcpEventObserver
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
mozilla
/
dom
/
RTCRtpSourcesBinding
.
h
"
#
include
"
api
/
video
/
video_frame_buffer
.
h
"
#
include
"
call
/
call
.
h
"
namespace
webrtc
{
class
VideoFrame
;
}
namespace
mozilla
{
namespace
dom
{
struct
RTCRtpSourceEntry
;
}
namespace
dom
{
struct
RTCRtpSourceEntry
;
}
enum
class
MediaSessionConduitLocalDirection
:
int
{
kSend
kRecv
}
;
class
VideoSessionConduit
;
class
AudioSessionConduit
;
class
RtpRtcpConfig
;
class
WebrtcCallWrapper
;
using
RtpExtList
=
std
:
:
vector
<
webrtc
:
:
RtpExtension
>
;
using
Ssrc
=
uint32_t
;
using
Ssrcs
=
std
:
:
vector
<
uint32_t
>
;
class
TransportInterface
{
protected
:
virtual
~
TransportInterface
(
)
{
}
public
:
virtual
nsresult
SendRtpPacket
(
const
uint8_t
*
data
size_t
len
)
=
0
;
virtual
nsresult
SendRtcpPacket
(
const
uint8_t
*
data
size_t
len
)
=
0
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
TransportInterface
)
}
;
class
VideoRenderer
{
protected
:
virtual
~
VideoRenderer
(
)
{
}
public
:
virtual
void
FrameSizeChange
(
unsigned
int
width
unsigned
int
height
)
=
0
;
virtual
void
RenderVideoFrame
(
const
webrtc
:
:
VideoFrameBuffer
&
buffer
uint32_t
time_stamp
int64_t
render_time
)
=
0
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
VideoRenderer
)
}
;
class
MediaSessionConduit
{
protected
:
virtual
~
MediaSessionConduit
(
)
{
}
public
:
enum
Type
{
AUDIO
VIDEO
}
;
enum
class
PacketType
{
RTP
RTCP
}
;
static
std
:
:
string
LocalDirectionToString
(
const
MediaSessionConduitLocalDirection
aDirection
)
{
return
aDirection
=
=
MediaSessionConduitLocalDirection
:
:
kSend
?
"
send
"
:
"
receive
"
;
}
virtual
Type
type
(
)
const
=
0
;
virtual
void
ReceivedRTPPacket
(
const
uint8_t
*
data
int
len
webrtc
:
:
RTPHeader
&
header
)
=
0
;
virtual
void
ReceivedRTCPPacket
(
const
uint8_t
*
data
int
len
)
=
0
;
virtual
Maybe
<
DOMHighResTimeStamp
>
LastRtcpReceived
(
)
const
=
0
;
virtual
DOMHighResTimeStamp
GetNow
(
)
const
=
0
;
virtual
MediaConduitErrorCode
StopTransmitting
(
)
=
0
;
virtual
MediaConduitErrorCode
StartTransmitting
(
)
=
0
;
virtual
MediaConduitErrorCode
StopReceiving
(
)
=
0
;
virtual
MediaConduitErrorCode
StartReceiving
(
)
=
0
;
virtual
MediaConduitErrorCode
SetTransmitterTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
=
0
;
virtual
MediaConduitErrorCode
SetReceiverTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
=
0
;
virtual
bool
SetLocalSSRCs
(
const
Ssrcs
&
aSSRCs
const
Ssrcs
&
aRtxSSRCs
)
=
0
;
virtual
Ssrcs
GetLocalSSRCs
(
)
const
=
0
;
virtual
MediaConduitErrorCode
SetLocalRTPExtensions
(
MediaSessionConduitLocalDirection
aDirection
const
RtpExtList
&
aExtensions
)
=
0
;
virtual
bool
GetRemoteSSRC
(
Ssrc
*
ssrc
)
const
=
0
;
virtual
bool
SetRemoteSSRC
(
Ssrc
ssrc
Ssrc
rtxSsrc
)
=
0
;
virtual
bool
UnsetRemoteSSRC
(
Ssrc
ssrc
)
=
0
;
virtual
bool
SetLocalCNAME
(
const
char
*
cname
)
=
0
;
virtual
bool
SetLocalMID
(
const
std
:
:
string
&
mid
)
=
0
;
virtual
void
SetSyncGroup
(
const
std
:
:
string
&
group
)
=
0
;
virtual
bool
HasCodecPluginID
(
uint64_t
aPluginID
)
const
=
0
;
virtual
void
DeliverPacket
(
rtc
:
:
CopyOnWriteBuffer
packet
PacketType
type
)
=
0
;
virtual
void
Shutdown
(
)
=
0
;
virtual
Maybe
<
RefPtr
<
AudioSessionConduit
>
>
AsAudioSessionConduit
(
)
=
0
;
virtual
Maybe
<
RefPtr
<
VideoSessionConduit
>
>
AsVideoSessionConduit
(
)
=
0
;
virtual
void
SetRtcpEventObserver
(
RtcpEventObserver
*
observer
)
=
0
;
virtual
webrtc
:
:
Call
:
:
Stats
GetCallStats
(
)
const
=
0
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
MediaSessionConduit
)
void
UpdateRtpSources
(
const
std
:
:
vector
<
webrtc
:
:
RtpSource
>
&
aSources
)
;
void
GetRtpSources
(
nsTArray
<
dom
:
:
RTCRtpSourceEntry
>
&
outSources
)
const
;
void
InsertAudioLevelForContributingSource
(
const
uint32_t
aCsrcSource
const
int64_t
aTimestamp
const
uint32_t
aRtpTimestamp
const
bool
aHasAudioLevel
const
uint8_t
aAudioLevel
)
;
private
:
class
SourceKey
{
public
:
explicit
SourceKey
(
const
webrtc
:
:
RtpSource
&
aSource
)
:
SourceKey
(
aSource
.
timestamp_ms
(
)
aSource
.
source_id
(
)
)
{
}
SourceKey
(
uint32_t
aTimestamp
uint32_t
aSrc
)
:
mLibwebrtcTimestamp
(
aTimestamp
)
mSrc
(
aSrc
)
{
}
auto
operator
>
(
const
SourceKey
&
aRhs
)
const
{
if
(
mLibwebrtcTimestamp
=
=
aRhs
.
mLibwebrtcTimestamp
)
{
return
mSrc
>
aRhs
.
mSrc
;
}
return
mLibwebrtcTimestamp
>
aRhs
.
mLibwebrtcTimestamp
;
}
private
:
uint32_t
mLibwebrtcTimestamp
;
uint32_t
mSrc
;
}
;
std
:
:
map
<
SourceKey
dom
:
:
RTCRtpSourceEntry
std
:
:
greater
<
SourceKey
>
>
mSourcesCache
;
}
;
class
CodecPluginID
{
public
:
virtual
MediaEventSource
<
uint64_t
>
*
InitPluginEvent
(
)
{
return
nullptr
;
}
virtual
MediaEventSource
<
uint64_t
>
*
ReleasePluginEvent
(
)
{
return
nullptr
;
}
virtual
~
CodecPluginID
(
)
{
}
}
;
class
VideoEncoder
:
public
CodecPluginID
{
public
:
virtual
~
VideoEncoder
(
)
{
}
}
;
class
VideoDecoder
:
public
CodecPluginID
{
public
:
virtual
~
VideoDecoder
(
)
{
}
}
;
class
VideoSessionConduit
:
public
MediaSessionConduit
{
public
:
struct
Options
{
bool
mVideoLatencyTestEnable
=
false
;
int
mMinBitrate
=
0
;
int
mStartBitrate
=
0
;
int
mPrefMaxBitrate
=
0
;
int
mMinBitrateEstimate
=
0
;
bool
mDenoising
=
false
;
bool
mLockScaling
=
false
;
uint8_t
mSpatialLayers
=
1
;
uint8_t
mTemporalLayers
=
1
;
}
;
static
RefPtr
<
VideoSessionConduit
>
Create
(
RefPtr
<
WebrtcCallWrapper
>
aCall
nsCOMPtr
<
nsISerialEventTarget
>
aStsThread
Options
aOptions
std
:
:
string
aPCHandle
)
;
enum
FrameRequestType
{
FrameRequestNone
FrameRequestFir
FrameRequestPli
FrameRequestUnknown
}
;
VideoSessionConduit
(
)
:
mFrameRequestMethod
(
FrameRequestNone
)
mUsingNackBasic
(
false
)
mUsingTmmbr
(
false
)
mUsingFEC
(
false
)
{
}
virtual
~
VideoSessionConduit
(
)
{
}
Type
type
(
)
const
override
{
return
VIDEO
;
}
Maybe
<
RefPtr
<
AudioSessionConduit
>
>
AsAudioSessionConduit
(
)
override
{
return
Nothing
(
)
;
}
Maybe
<
RefPtr
<
VideoSessionConduit
>
>
AsVideoSessionConduit
(
)
override
{
return
Some
(
RefPtr
<
VideoSessionConduit
>
(
this
)
)
;
}
virtual
MediaConduitErrorCode
AttachRenderer
(
RefPtr
<
mozilla
:
:
VideoRenderer
>
aRenderer
)
=
0
;
virtual
void
DetachRenderer
(
)
=
0
;
virtual
void
DisableSsrcChanges
(
)
=
0
;
bool
SetRemoteSSRC
(
Ssrc
ssrc
Ssrc
rtxSsrc
)
override
=
0
;
bool
UnsetRemoteSSRC
(
Ssrc
ssrc
)
override
=
0
;
virtual
MediaConduitErrorCode
SendVideoFrame
(
const
webrtc
:
:
VideoFrame
&
frame
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureCodecMode
(
webrtc
:
:
VideoCodecMode
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureSendMediaCodec
(
const
VideoCodecConfig
&
sendSessionConfig
const
RtpRtcpConfig
&
aRtpRtcpConfig
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureRecvMediaCodecs
(
const
std
:
:
vector
<
VideoCodecConfig
>
&
recvCodecConfigList
const
RtpRtcpConfig
&
aRtpRtcpConfig
)
=
0
;
FrameRequestType
FrameRequestMethod
(
)
const
{
return
mFrameRequestMethod
;
}
bool
UsingNackBasic
(
)
const
{
return
mUsingNackBasic
;
}
bool
UsingTmmbr
(
)
const
{
return
mUsingTmmbr
;
}
bool
UsingFEC
(
)
const
{
return
mUsingFEC
;
}
virtual
Maybe
<
webrtc
:
:
VideoReceiveStream
:
:
Stats
>
GetReceiverStats
(
)
const
=
0
;
virtual
Maybe
<
webrtc
:
:
VideoSendStream
:
:
Stats
>
GetSenderStats
(
)
const
=
0
;
virtual
void
CollectTelemetryData
(
)
=
0
;
virtual
bool
AddFrameHistory
(
dom
:
:
Sequence
<
dom
:
:
RTCVideoFrameHistoryInternal
>
*
outHistories
)
const
=
0
;
virtual
void
OnFrameDelivered
(
)
=
0
;
protected
:
FrameRequestType
mFrameRequestMethod
;
bool
mUsingNackBasic
;
bool
mUsingTmmbr
;
bool
mUsingFEC
;
}
;
class
AudioSessionConduit
:
public
MediaSessionConduit
{
public
:
static
RefPtr
<
AudioSessionConduit
>
Create
(
RefPtr
<
WebrtcCallWrapper
>
aCall
nsCOMPtr
<
nsISerialEventTarget
>
aStsThread
)
;
virtual
~
AudioSessionConduit
(
)
{
}
Type
type
(
)
const
override
{
return
AUDIO
;
}
Maybe
<
RefPtr
<
AudioSessionConduit
>
>
AsAudioSessionConduit
(
)
override
{
return
Some
(
this
)
;
}
Maybe
<
RefPtr
<
VideoSessionConduit
>
>
AsVideoSessionConduit
(
)
override
{
return
Nothing
(
)
;
}
virtual
MediaConduitErrorCode
SendAudioFrame
(
std
:
:
unique_ptr
<
webrtc
:
:
AudioFrame
>
frame
)
=
0
;
virtual
MediaConduitErrorCode
GetAudioFrame
(
int32_t
samplingFreqHz
webrtc
:
:
AudioFrame
*
frame
)
=
0
;
virtual
bool
IsSamplingFreqSupported
(
int
freq
)
const
=
0
;
virtual
MediaConduitErrorCode
ConfigureSendMediaCodec
(
const
AudioCodecConfig
&
sendCodecConfig
)
=
0
;
virtual
MediaConduitErrorCode
ConfigureRecvMediaCodecs
(
const
std
:
:
vector
<
AudioCodecConfig
>
&
recvCodecConfigList
)
=
0
;
virtual
bool
InsertDTMFTone
(
unsigned
char
payloadType
int
payloadFrequency
int
eventCode
int
lengthMs
)
=
0
;
virtual
Maybe
<
webrtc
:
:
AudioReceiveStream
:
:
Stats
>
GetReceiverStats
(
)
const
=
0
;
virtual
Maybe
<
webrtc
:
:
AudioSendStream
:
:
Stats
>
GetSenderStats
(
)
const
=
0
;
}
;
}
#
endif
