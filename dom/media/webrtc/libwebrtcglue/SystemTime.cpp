#
include
"
SystemTime
.
h
"
#
include
"
TimeUnits
.
h
"
namespace
mozilla
{
using
media
:
:
TimeUnit
;
RTCStatsTimestampMakerRealtimeClock
:
:
RTCStatsTimestampMakerRealtimeClock
(
const
dom
:
:
RTCStatsTimestampMaker
&
aTimestampMaker
)
:
mTimestampMaker
(
aTimestampMaker
)
{
}
webrtc
:
:
Timestamp
RTCStatsTimestampMakerRealtimeClock
:
:
CurrentTime
(
)
{
return
mTimestampMaker
.
GetNowRealtime
(
)
;
}
webrtc
:
:
NtpTime
RTCStatsTimestampMakerRealtimeClock
:
:
ConvertTimestampToNtpTime
(
webrtc
:
:
Timestamp
aRealtime
)
{
return
CreateNtp
(
mTimestampMaker
.
ConvertRealtimeTo1Jan1970
(
aRealtime
)
+
webrtc
:
:
TimeDelta
:
:
Seconds
(
webrtc
:
:
kNtpJan1970
)
)
;
}
static
TimeStamp
CalculateBaseOffset
(
TimeStamp
aNow
)
{
uint32_t
offset
=
24
*
60
*
60
;
TimeStamp
base
;
do
{
base
=
aNow
-
TimeDuration
:
:
FromSeconds
(
offset
)
;
offset
/
=
2
;
}
while
(
!
base
)
;
return
base
;
}
TimeStamp
WebrtcSystemTimeBase
(
)
{
static
TimeStamp
now
=
TimeStamp
:
:
Now
(
)
;
static
TimeStamp
base
=
CalculateBaseOffset
(
now
)
;
return
base
;
}
webrtc
:
:
Timestamp
WebrtcSystemTime
(
)
{
const
TimeStamp
base
=
WebrtcSystemTimeBase
(
)
;
const
TimeStamp
now
=
TimeStamp
:
:
Now
(
)
;
return
webrtc
:
:
Timestamp
:
:
Micros
(
(
now
-
base
)
.
ToMicroseconds
(
)
)
;
}
webrtc
:
:
NtpTime
CreateNtp
(
webrtc
:
:
Timestamp
aTime
)
{
const
int64_t
timeNtpUs
=
aTime
.
us
(
)
;
const
uint32_t
seconds
=
static_cast
<
uint32_t
>
(
timeNtpUs
/
USECS_PER_S
)
;
constexpr
int64_t
fractionsPerSec
=
1LL
<
<
32
;
const
int64_t
fractionsUs
=
timeNtpUs
%
USECS_PER_S
;
const
uint32_t
fractions
=
(
fractionsUs
*
fractionsPerSec
)
/
USECS_PER_S
;
return
webrtc
:
:
NtpTime
(
seconds
fractions
)
;
}
}
namespace
rtc
{
int64_t
SystemTimeNanos
(
)
{
return
mozilla
:
:
WebrtcSystemTime
(
)
.
us
(
)
*
1000
;
}
}
