#
ifndef
AUDIO_SESSION_H_
#
define
AUDIO_SESSION_H_
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
ReentrantMonitor
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
MediaConduitInterface
.
h
"
#
include
"
common
/
MediaEngineWrapper
.
h
"
#
include
"
RtpPacketQueue
.
h
"
#
include
"
modules
/
audio_device
/
include
/
fake_audio_device
.
h
"
namespace
mozilla
{
DOMHighResTimeStamp
NTPtoDOMHighResTimeStamp
(
uint32_t
ntpHigh
uint32_t
ntpLow
)
;
class
WebrtcAudioConduit
:
public
AudioSessionConduit
public
webrtc
:
:
Transport
{
public
:
MediaConduitErrorCode
ReceivedRTPPacket
(
const
void
*
data
int
len
webrtc
:
:
RTPHeader
&
header
)
override
;
MediaConduitErrorCode
ReceivedRTCPPacket
(
const
void
*
data
int
len
)
override
;
Maybe
<
DOMHighResTimeStamp
>
LastRtcpReceived
(
)
const
override
;
DOMHighResTimeStamp
GetNow
(
)
const
override
{
return
mCall
-
>
GetNow
(
)
;
}
MediaConduitErrorCode
StopTransmitting
(
)
override
;
MediaConduitErrorCode
StartTransmitting
(
)
override
;
MediaConduitErrorCode
StopReceiving
(
)
override
;
MediaConduitErrorCode
StartReceiving
(
)
override
;
MediaConduitErrorCode
StopTransmittingLocked
(
)
;
MediaConduitErrorCode
StartTransmittingLocked
(
)
;
MediaConduitErrorCode
StopReceivingLocked
(
)
;
MediaConduitErrorCode
StartReceivingLocked
(
)
;
MediaConduitErrorCode
ConfigureSendMediaCodec
(
const
AudioCodecConfig
*
codecConfig
)
override
;
MediaConduitErrorCode
ConfigureRecvMediaCodecs
(
const
std
:
:
vector
<
UniquePtr
<
AudioCodecConfig
>
>
&
codecConfigList
)
override
;
MediaConduitErrorCode
SetLocalRTPExtensions
(
MediaSessionConduitLocalDirection
aDirection
const
RtpExtList
&
extensions
)
override
;
MediaConduitErrorCode
SetTransmitterTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
override
;
MediaConduitErrorCode
SetReceiverTransport
(
RefPtr
<
TransportInterface
>
aTransport
)
override
;
MediaConduitErrorCode
SendAudioFrame
(
std
:
:
unique_ptr
<
webrtc
:
:
AudioFrame
>
frame
)
override
;
MediaConduitErrorCode
GetAudioFrame
(
int16_t
speechData
[
]
int32_t
samplingFreqHz
int32_t
capture_delay
size_t
&
numChannels
size_t
&
lengthSamples
)
override
;
bool
SendRtp
(
const
uint8_t
*
data
size_t
len
const
webrtc
:
:
PacketOptions
&
options
)
override
;
bool
SendRtcp
(
const
uint8_t
*
data
size_t
len
)
override
;
uint64_t
CodecPluginID
(
)
override
{
return
0
;
}
void
SetPCHandle
(
const
std
:
:
string
&
aPCHandle
)
override
{
}
MediaConduitErrorCode
DeliverPacket
(
const
void
*
data
int
len
)
override
;
void
DeleteStreams
(
)
override
{
}
WebrtcAudioConduit
(
RefPtr
<
WebRtcCallWrapper
>
aCall
nsCOMPtr
<
nsISerialEventTarget
>
aStsThread
)
:
mTransportMonitor
(
"
WebrtcAudioConduit
"
)
mTransmitterTransport
(
nullptr
)
mReceiverTransport
(
nullptr
)
mCall
(
aCall
)
mRecvStreamConfig
(
)
mRecvStream
(
nullptr
)
mSendStreamConfig
(
this
)
mSendStream
(
nullptr
)
mRecvSSRC
(
0
)
mEngineTransmitting
(
false
)
mEngineReceiving
(
false
)
mDtmfEnabled
(
false
)
mMutex
(
"
WebrtcAudioConduit
:
:
mMutex
"
)
mStsThread
(
aStsThread
)
{
}
virtual
~
WebrtcAudioConduit
(
)
;
bool
SetLocalSSRCs
(
const
std
:
:
vector
<
uint32_t
>
&
aSSRCs
const
std
:
:
vector
<
uint32_t
>
&
aRtxSSRCs
)
override
;
std
:
:
vector
<
uint32_t
>
GetLocalSSRCs
(
)
override
;
bool
SetRemoteSSRC
(
uint32_t
ssrc
uint32_t
rtxSsrc
)
override
;
bool
UnsetRemoteSSRC
(
uint32_t
ssrc
)
override
{
return
true
;
}
bool
GetRemoteSSRC
(
uint32_t
*
ssrc
)
override
;
bool
SetLocalCNAME
(
const
char
*
cname
)
override
;
bool
SetLocalMID
(
const
std
:
:
string
&
mid
)
override
;
void
SetSyncGroup
(
const
std
:
:
string
&
group
)
override
;
bool
GetSendPacketTypeStats
(
webrtc
:
:
RtcpPacketTypeCounter
*
aPacketCounts
)
override
;
bool
GetRecvPacketTypeStats
(
webrtc
:
:
RtcpPacketTypeCounter
*
aPacketCounts
)
override
;
bool
GetRTPReceiverStats
(
unsigned
int
*
jitterMs
unsigned
int
*
cumulativeLost
)
override
;
bool
GetRTCPReceiverReport
(
uint32_t
*
jitterMs
uint32_t
*
packetsReceived
uint64_t
*
bytesReceived
uint32_t
*
cumulativeLost
Maybe
<
double
>
*
aOutRttSec
)
override
;
bool
GetRTCPSenderReport
(
unsigned
int
*
packetsSent
uint64_t
*
bytesSent
DOMHighResTimeStamp
*
aRemoteTimestamp
)
override
;
Maybe
<
mozilla
:
:
dom
:
:
RTCBandwidthEstimationInternal
>
GetBandwidthEstimation
(
)
override
;
bool
SetDtmfPayloadType
(
unsigned
char
type
int
freq
)
override
;
bool
InsertDTMFTone
(
int
channel
int
eventCode
bool
outOfBand
int
lengthMs
int
attenuationDb
)
override
;
void
GetRtpSources
(
nsTArray
<
dom
:
:
RTCRtpSourceEntry
>
&
outSources
)
override
;
void
SetRtcpEventObserver
(
mozilla
:
:
RtcpEventObserver
*
observer
)
override
;
void
InsertAudioLevelForContributingSource
(
const
uint32_t
aCsrcSource
const
int64_t
aTimestamp
const
uint32_t
aRtpTimestamp
const
bool
aHasAudioLevel
const
uint8_t
aAudioLevel
)
;
bool
IsSamplingFreqSupported
(
int
freq
)
const
override
;
private
:
WebrtcAudioConduit
(
const
WebrtcAudioConduit
&
other
)
=
delete
;
void
operator
=
(
const
WebrtcAudioConduit
&
other
)
=
delete
;
bool
CodecConfigToWebRTCCodec
(
const
AudioCodecConfig
*
codecInfo
webrtc
:
:
AudioSendStream
:
:
Config
&
config
)
;
unsigned
int
GetNum10msSamplesForFrequency
(
int
samplingFreqHz
)
const
;
MediaConduitErrorCode
ValidateCodecConfig
(
const
AudioCodecConfig
*
codecInfo
bool
send
)
;
MediaConduitErrorCode
CreateSendStream
(
)
;
void
DeleteSendStream
(
)
;
MediaConduitErrorCode
CreateRecvStream
(
)
;
void
DeleteRecvStream
(
)
;
bool
RecreateSendStreamIfExists
(
)
;
bool
RecreateRecvStreamIfExists
(
)
;
mozilla
:
:
ReentrantMonitor
mTransportMonitor
;
RefPtr
<
TransportInterface
>
mTransmitterTransport
;
RefPtr
<
TransportInterface
>
mReceiverTransport
;
const
RefPtr
<
WebRtcCallWrapper
>
mCall
;
webrtc
:
:
AudioReceiveStream
:
:
Config
mRecvStreamConfig
;
webrtc
:
:
AudioReceiveStream
*
mRecvStream
;
webrtc
:
:
AudioSendStream
:
:
Config
mSendStreamConfig
;
webrtc
:
:
AudioSendStream
*
mSendStream
;
Atomic
<
uint32_t
>
mRecvSSRC
;
RtpPacketQueue
mRtpPacketQueue
;
mozilla
:
:
Atomic
<
bool
>
mEngineTransmitting
;
mozilla
:
:
Atomic
<
bool
>
mEngineReceiving
;
bool
mDtmfEnabled
;
int
mDtmfPayloadType
=
-
1
;
int
mDtmfPayloadFrequency
=
-
1
;
Mutex
mMutex
;
webrtc
:
:
AudioFrame
mAudioFrame
;
const
nsCOMPtr
<
nsISerialEventTarget
>
mStsThread
;
Maybe
<
DOMHighResTimeStamp
>
mRttSec
;
Maybe
<
DOMHighResTimeStamp
>
mLastRtcpReceived
;
mozilla
:
:
RtcpEventObserver
*
mRtcpEventObserver
=
nullptr
;
}
;
}
#
endif
