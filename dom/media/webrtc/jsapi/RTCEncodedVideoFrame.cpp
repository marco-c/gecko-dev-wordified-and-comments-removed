#
include
"
jsapi
/
RTCEncodedVideoFrame
.
h
"
#
include
<
stdint
.
h
>
#
include
<
memory
>
#
include
<
string
>
#
include
<
utility
>
#
include
"
api
/
frame_transformer_factory
.
h
"
#
include
"
api
/
frame_transformer_interface
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
jsapi
/
RTCEncodedFrameBase
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
dom
/
RTCEncodedVideoFrameBinding
.
h
"
#
include
"
mozilla
/
dom
/
RTCRtpScriptTransformer
.
h
"
#
include
"
mozilla
/
dom
/
StructuredCloneHolder
.
h
"
#
include
"
mozilla
/
dom
/
StructuredCloneTags
.
h
"
#
include
"
mozilla
/
fallible
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsIGlobalObject
.
h
"
#
include
"
nsISupports
.
h
"
#
include
"
nsWrapperCache
.
h
"
namespace
mozilla
:
:
dom
{
NS_IMPL_CYCLE_COLLECTION_CLASS
(
RTCEncodedVideoFrame
)
NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_INHERITED
(
RTCEncodedVideoFrame
RTCEncodedFrameBase
)
NS_IMPL_CYCLE_COLLECTION_UNLINK
(
mOwner
)
NS_IMPL_CYCLE_COLLECTION_UNLINK_PRESERVED_WRAPPER
NS_IMPL_CYCLE_COLLECTION_UNLINK_END
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_INHERITED
(
RTCEncodedVideoFrame
RTCEncodedFrameBase
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE
(
mOwner
)
NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END
NS_IMPL_CYCLE_COLLECTION_TRACE_BEGIN_INHERITED
(
RTCEncodedVideoFrame
RTCEncodedFrameBase
)
NS_IMPL_CYCLE_COLLECTION_TRACE_PRESERVED_WRAPPER
NS_IMPL_CYCLE_COLLECTION_TRACE_END
NS_IMPL_ADDREF_INHERITED
(
RTCEncodedVideoFrame
RTCEncodedFrameBase
)
NS_IMPL_RELEASE_INHERITED
(
RTCEncodedVideoFrame
RTCEncodedFrameBase
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
RTCEncodedVideoFrame
)
NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
NS_INTERFACE_MAP_END_INHERITING
(
RTCEncodedFrameBase
)
RTCEncodedVideoFrame
:
:
RTCEncodedVideoFrame
(
nsIGlobalObject
*
aGlobal
std
:
:
unique_ptr
<
webrtc
:
:
TransformableFrameInterface
>
aFrame
uint64_t
aCounter
RTCRtpScriptTransformer
*
aOwner
)
:
RTCEncodedVideoFrameData
{
{
std
:
:
move
(
aFrame
)
aCounter
0
}
}
RTCEncodedFrameBase
(
aGlobal
static_cast
<
RTCEncodedFrameState
&
>
(
*
this
)
)
mOwner
(
aOwner
)
{
InitMetadata
(
)
;
mozilla
:
:
HoldJSObjects
(
this
)
;
}
RTCEncodedVideoFrame
:
:
RTCEncodedVideoFrame
(
nsIGlobalObject
*
aGlobal
RTCEncodedVideoFrameData
&
&
aData
)
:
RTCEncodedVideoFrameData
{
{
std
:
:
move
(
aData
.
mFrame
)
aData
.
mCounter
aData
.
mTimestamp
}
aData
.
mType
std
:
:
move
(
aData
.
mMetadata
)
aData
.
mRid
}
RTCEncodedFrameBase
(
aGlobal
static_cast
<
RTCEncodedFrameState
&
>
(
*
this
)
)
mOwner
(
nullptr
)
{
mozilla
:
:
HoldJSObjects
(
this
)
;
}
void
RTCEncodedVideoFrame
:
:
InitMetadata
(
)
{
const
auto
&
videoFrame
(
static_cast
<
webrtc
:
:
TransformableVideoFrameInterface
&
>
(
*
mFrame
)
)
;
mType
=
videoFrame
.
IsKeyFrame
(
)
?
RTCEncodedVideoFrameType
:
:
Key
:
RTCEncodedVideoFrameType
:
:
Delta
;
auto
metadata
=
videoFrame
.
Metadata
(
)
;
if
(
metadata
.
GetFrameId
(
)
.
has_value
(
)
)
{
mMetadata
.
mFrameId
.
Construct
(
*
metadata
.
GetFrameId
(
)
)
;
}
mMetadata
.
mDependencies
.
Construct
(
)
;
for
(
const
auto
dep
:
metadata
.
GetFrameDependencies
(
)
)
{
Unused
<
<
mMetadata
.
mDependencies
.
Value
(
)
.
AppendElement
(
static_cast
<
unsigned
long
long
>
(
dep
)
fallible
)
;
}
mMetadata
.
mWidth
.
Construct
(
metadata
.
GetWidth
(
)
)
;
mMetadata
.
mHeight
.
Construct
(
metadata
.
GetHeight
(
)
)
;
if
(
metadata
.
GetSpatialIndex
(
)
>
=
0
)
{
mMetadata
.
mSpatialIndex
.
Construct
(
metadata
.
GetSpatialIndex
(
)
)
;
}
if
(
metadata
.
GetTemporalIndex
(
)
>
=
0
)
{
mMetadata
.
mTemporalIndex
.
Construct
(
metadata
.
GetTemporalIndex
(
)
)
;
}
mMetadata
.
mSynchronizationSource
.
Construct
(
videoFrame
.
GetSsrc
(
)
)
;
mMetadata
.
mPayloadType
.
Construct
(
videoFrame
.
GetPayloadType
(
)
)
;
mMetadata
.
mContributingSources
.
Construct
(
)
;
for
(
const
auto
csrc
:
metadata
.
GetCsrcs
(
)
)
{
Unused
<
<
mMetadata
.
mContributingSources
.
Value
(
)
.
AppendElement
(
csrc
fallible
)
;
}
if
(
!
videoFrame
.
GetRid
(
)
.
empty
(
)
)
{
mRid
=
Some
(
videoFrame
.
GetRid
(
)
.
c_str
(
)
)
;
}
}
RTCEncodedVideoFrame
:
:
~
RTCEncodedVideoFrame
(
)
{
mData
=
nullptr
;
mozilla
:
:
DropJSObjects
(
this
)
;
}
JSObject
*
RTCEncodedVideoFrame
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
RTCEncodedVideoFrame_Binding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
RTCEncodedVideoFrameData
RTCEncodedVideoFrameData
:
:
Clone
(
)
const
{
return
RTCEncodedVideoFrameData
{
{
webrtc
:
:
CloneVideoFrame
(
static_cast
<
webrtc
:
:
TransformableVideoFrameInterface
*
>
(
mFrame
.
get
(
)
)
)
mCounter
mTimestamp
}
mType
RTCEncodedVideoFrameMetadata
(
mMetadata
)
mRid
}
;
}
nsIGlobalObject
*
RTCEncodedVideoFrame
:
:
GetParentObject
(
)
const
{
return
mGlobal
;
}
RTCEncodedVideoFrameType
RTCEncodedVideoFrame
:
:
Type
(
)
const
{
return
mType
;
}
void
RTCEncodedVideoFrame
:
:
GetMetadata
(
RTCEncodedVideoFrameMetadata
&
aMetadata
)
{
aMetadata
=
mMetadata
;
}
bool
RTCEncodedVideoFrame
:
:
CheckOwner
(
RTCRtpScriptTransformer
*
aOwner
)
const
{
return
aOwner
=
=
mOwner
;
}
Maybe
<
nsCString
>
RTCEncodedVideoFrame
:
:
Rid
(
)
const
{
return
mRid
;
}
JSObject
*
RTCEncodedVideoFrame
:
:
ReadStructuredClone
(
JSContext
*
aCx
nsIGlobalObject
*
aGlobal
JSStructuredCloneReader
*
aReader
RTCEncodedVideoFrameData
&
aData
)
{
JS
:
:
Rooted
<
JS
:
:
Value
>
value
(
aCx
JS
:
:
NullValue
(
)
)
;
{
auto
frame
=
MakeRefPtr
<
RTCEncodedVideoFrame
>
(
aGlobal
std
:
:
move
(
aData
)
)
;
if
(
!
GetOrCreateDOMReflector
(
aCx
frame
&
value
)
|
|
!
value
.
isObject
(
)
)
{
return
nullptr
;
}
}
return
value
.
toObjectOrNull
(
)
;
}
bool
RTCEncodedVideoFrame
:
:
WriteStructuredClone
(
JSStructuredCloneWriter
*
aWriter
StructuredCloneHolder
*
aHolder
)
const
{
AssertIsOnOwningThread
(
)
;
const
uint32_t
index
=
static_cast
<
uint32_t
>
(
aHolder
-
>
RtcEncodedVideoFrames
(
)
.
Length
(
)
)
;
aHolder
-
>
RtcEncodedVideoFrames
(
)
.
AppendElement
(
Clone
(
)
)
;
return
!
NS_WARN_IF
(
!
JS_WriteUint32Pair
(
aWriter
SCTAG_DOM_RTCENCODEDVIDEOFRAME
index
)
)
;
}
}
