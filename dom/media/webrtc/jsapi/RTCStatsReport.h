#
ifndef
RTCStatsReport_h_
#
define
RTCStatsReport_h_
#
include
"
api
/
units
/
timestamp
.
h
"
#
include
"
js
/
RootingAPI
.
h
"
#
include
"
js
/
Value
.
h
"
#
include
"
mozilla
/
dom
/
AutoEntryScript
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
dom
/
PerformanceService
.
h
"
#
include
"
mozilla
/
dom
/
RTCStatsReportBinding
.
h
"
#
include
"
mozilla
/
dom
/
ToJSValue
.
h
"
#
include
"
mozilla
/
ErrorResult
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIGlobalObject
.
h
"
#
include
"
nsPIDOMWindow
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
prtime
.
h
"
namespace
mozilla
{
extern
TimeStamp
WebrtcSystemTimeBase
(
)
;
namespace
dom
{
struct
RTCStatsTimestampState
{
RTCStatsTimestampState
(
)
;
explicit
RTCStatsTimestampState
(
Performance
&
aPerformance
)
;
RTCStatsTimestampState
(
const
RTCStatsTimestampState
&
)
=
default
;
const
uint64_t
mRandomTimelineSeed
;
const
TimeStamp
mStartDomRealtime
;
const
RTPCallerType
mRTPCallerType
;
const
DOMHighResTimeStamp
mStartWallClockRaw
;
}
;
class
RTCStatsTimestampMaker
;
class
RTCStatsTimestamp
{
public
:
TimeStamp
ToMozTime
(
)
const
;
webrtc
:
:
Timestamp
ToRealtime
(
)
const
;
webrtc
:
:
Timestamp
To1Jan1970
(
)
const
;
webrtc
:
:
Timestamp
ToNtp
(
)
const
;
webrtc
:
:
Timestamp
ToDomRealtime
(
)
const
;
DOMHighResTimeStamp
ToDom
(
)
const
;
static
RTCStatsTimestamp
FromMozTime
(
const
RTCStatsTimestampMaker
&
aMaker
TimeStamp
aMozTime
)
;
static
RTCStatsTimestamp
FromRealtime
(
const
RTCStatsTimestampMaker
&
aMaker
webrtc
:
:
Timestamp
aRealtime
)
;
static
RTCStatsTimestamp
From1Jan1970
(
const
RTCStatsTimestampMaker
&
aMaker
webrtc
:
:
Timestamp
aRealtime
)
;
static
RTCStatsTimestamp
FromNtp
(
const
RTCStatsTimestampMaker
&
aMaker
webrtc
:
:
Timestamp
aRealtime
)
;
static
RTCStatsTimestamp
FromDomRealtime
(
const
RTCStatsTimestampMaker
&
aMaker
webrtc
:
:
Timestamp
aDomRealtime
)
;
private
:
RTCStatsTimestamp
(
RTCStatsTimestampState
aState
TimeStamp
aMozTime
)
;
const
RTCStatsTimestampState
mState
;
const
TimeStamp
mMozTime
;
}
;
class
RTCStatsTimestampMaker
{
public
:
static
RTCStatsTimestampMaker
Create
(
nsPIDOMWindowInner
*
aWindow
=
nullptr
)
;
RTCStatsTimestamp
GetNow
(
)
const
;
const
RTCStatsTimestampState
mState
;
private
:
explicit
RTCStatsTimestampMaker
(
RTCStatsTimestampState
aState
)
;
}
;
typedef
MozPromise
<
UniquePtr
<
RTCStatsCollection
>
nsresult
true
>
RTCStatsPromise
;
typedef
MozPromise
<
UniquePtr
<
RTCStatsReportInternal
>
nsresult
true
>
RTCStatsReportPromise
;
class
RTCStatsReport
final
:
public
nsWrapperCache
{
public
:
NS_INLINE_DECL_CYCLE_COLLECTING_NATIVE_REFCOUNTING
(
RTCStatsReport
)
NS_DECL_CYCLE_COLLECTION_NATIVE_WRAPPERCACHE_CLASS
(
RTCStatsReport
)
explicit
RTCStatsReport
(
nsPIDOMWindowInner
*
aParent
)
;
static
already_AddRefed
<
RTCStatsReport
>
Constructor
(
const
GlobalObject
&
aGlobal
)
;
void
Incorporate
(
RTCStatsCollection
&
aStats
)
;
nsPIDOMWindowInner
*
GetParentObject
(
)
const
{
return
mParent
;
}
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
private
:
~
RTCStatsReport
(
)
=
default
;
void
Set
(
const
nsAString
&
aKey
JS
:
:
Handle
<
JSObject
*
>
aValue
ErrorResult
&
aRv
)
;
template
<
typename
T
>
nsresult
SetRTCStats
(
Sequence
<
T
>
&
aValues
)
{
for
(
T
&
value
:
aValues
)
{
nsresult
rv
=
SetRTCStats
(
value
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
}
return
NS_OK
;
}
template
<
typename
T
>
nsresult
SetRTCStats
(
T
&
aValue
)
{
static_assert
(
std
:
:
is_base_of
<
RTCStats
T
>
:
:
value
"
SetRTCStats
is
for
setting
RTCStats
only
"
)
;
if
(
!
aValue
.
mId
.
WasPassed
(
)
)
{
return
NS_OK
;
}
const
nsString
key
(
aValue
.
mId
.
Value
(
)
)
;
AutoEntryScript
aes
(
mParent
-
>
AsGlobal
(
)
-
>
GetGlobalJSObject
(
)
"
RTCStatsReport
:
:
SetRTCStats
"
)
;
JSContext
*
cx
=
aes
.
cx
(
)
;
JS
:
:
Rooted
<
JS
:
:
Value
>
val
(
cx
)
;
if
(
!
ToJSValue
(
cx
std
:
:
forward
<
T
>
(
aValue
)
&
val
)
)
{
return
NS_ERROR_FAILURE
;
}
JS
:
:
Rooted
<
JSObject
*
>
jsObject
(
cx
&
val
.
toObject
(
)
)
;
ErrorResult
rv
;
Set
(
key
jsObject
rv
)
;
return
rv
.
StealNSResult
(
)
;
}
nsCOMPtr
<
nsPIDOMWindowInner
>
mParent
;
}
;
void
MergeStats
(
UniquePtr
<
dom
:
:
RTCStatsCollection
>
aFromStats
dom
:
:
RTCStatsCollection
*
aIntoStats
)
;
void
FlattenStats
(
nsTArray
<
UniquePtr
<
dom
:
:
RTCStatsCollection
>
>
aFromStats
dom
:
:
RTCStatsCollection
*
aIntoStats
)
;
}
}
#
endif
