#
ifndef
MediaEngineCameraVideoSource_h
#
define
MediaEngineCameraVideoSource_h
#
include
"
MediaEngine
.
h
"
#
include
"
nsDirectoryServiceDefs
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
undef
FF
#
include
"
ipc
/
IPCMessageUtils
.
h
"
#
include
"
webrtc
/
modules
/
video_capture
/
video_capture_defines
.
h
"
namespace
webrtc
{
using
CaptureCapability
=
VideoCaptureCapability
;
}
namespace
mozilla
{
enum
DistanceCalculation
{
kFitness
kFeasibility
}
;
class
MediaEngineCameraVideoSource
:
public
MediaEngineVideoSource
{
public
:
explicit
MediaEngineCameraVideoSource
(
int
aIndex
const
char
*
aMonitorName
=
"
Camera
.
Monitor
"
)
:
MediaEngineVideoSource
(
kReleased
)
mMonitor
(
aMonitorName
)
mWidth
(
0
)
mHeight
(
0
)
mInitDone
(
false
)
mCaptureIndex
(
aIndex
)
mTrackID
(
0
)
{
}
explicit
MediaEngineCameraVideoSource
(
const
char
*
aMonitorName
=
"
Camera
.
Monitor
"
)
:
MediaEngineCameraVideoSource
(
0
aMonitorName
)
{
}
void
GetName
(
nsAString
&
aName
)
const
override
;
void
GetUUID
(
nsACString
&
aUUID
)
const
override
;
bool
IsFake
(
)
override
{
return
false
;
}
nsresult
TakePhoto
(
MediaEnginePhotoCallback
*
aCallback
)
override
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
uint32_t
GetBestFitnessDistance
(
const
nsTArray
<
const
NormalizedConstraintSet
*
>
&
aConstraintSets
const
nsString
&
aDeviceId
)
const
override
;
void
Shutdown
(
)
override
{
MonitorAutoLock
lock
(
mMonitor
)
;
Unused
<
<
NS_WARN_IF
(
mImage
)
;
mImage
=
nullptr
;
mImageContainer
=
nullptr
;
}
protected
:
struct
CapabilityCandidate
{
explicit
CapabilityCandidate
(
uint8_t
index
uint32_t
distance
=
0
)
:
mIndex
(
index
)
mDistance
(
distance
)
{
}
size_t
mIndex
;
uint32_t
mDistance
;
}
;
typedef
nsTArray
<
CapabilityCandidate
>
CapabilitySet
;
~
MediaEngineCameraVideoSource
(
)
{
}
virtual
bool
AppendToTrack
(
SourceMediaStream
*
aSource
layers
:
:
Image
*
aImage
TrackID
aID
StreamTime
delta
const
PrincipalHandle
&
aPrincipalHandle
)
;
uint32_t
GetDistance
(
const
webrtc
:
:
CaptureCapability
&
aCandidate
const
NormalizedConstraintSet
&
aConstraints
const
nsString
&
aDeviceId
const
DistanceCalculation
aCalculate
)
const
;
uint32_t
GetFitnessDistance
(
const
webrtc
:
:
CaptureCapability
&
aCandidate
const
NormalizedConstraintSet
&
aConstraints
const
nsString
&
aDeviceId
)
const
;
uint32_t
GetFeasibilityDistance
(
const
webrtc
:
:
CaptureCapability
&
aCandidate
const
NormalizedConstraintSet
&
aConstraints
const
nsString
&
aDeviceId
)
const
;
static
void
TrimLessFitCandidates
(
CapabilitySet
&
set
)
;
static
void
LogConstraints
(
const
NormalizedConstraintSet
&
aConstraints
)
;
static
void
LogCapability
(
const
char
*
aHeader
const
webrtc
:
:
CaptureCapability
&
aCapability
uint32_t
aDistance
)
;
virtual
size_t
NumCapabilities
(
)
const
;
virtual
void
GetCapability
(
size_t
aIndex
webrtc
:
:
CaptureCapability
&
aOut
)
const
;
virtual
bool
ChooseCapability
(
const
NormalizedConstraints
&
aConstraints
const
MediaEnginePrefs
&
aPrefs
const
nsString
&
aDeviceId
webrtc
:
:
CaptureCapability
&
aCapability
const
DistanceCalculation
aCalculate
)
;
void
SetName
(
nsString
aName
)
;
void
SetUUID
(
const
char
*
aUUID
)
;
const
nsCString
&
GetUUID
(
)
const
;
Monitor
mMonitor
;
nsTArray
<
RefPtr
<
SourceMediaStream
>
>
mSources
;
nsTArray
<
PrincipalHandle
>
mPrincipalHandles
;
RefPtr
<
layers
:
:
Image
>
mImage
;
nsTArray
<
RefPtr
<
layers
:
:
Image
>
>
mImages
;
nsTArray
<
webrtc
:
:
CaptureCapability
>
mTargetCapabilities
;
nsTArray
<
uint64_t
>
mHandleIds
;
RefPtr
<
layers
:
:
ImageContainer
>
mImageContainer
;
int
mWidth
mHeight
;
bool
mInitDone
;
int
mCaptureIndex
;
TrackID
mTrackID
;
webrtc
:
:
CaptureCapability
mCapability
;
webrtc
:
:
CaptureCapability
mTargetCapability
;
uint64_t
mHandleId
;
mutable
nsTArray
<
webrtc
:
:
CaptureCapability
>
mHardcodedCapabilities
;
private
:
nsString
mDeviceName
;
nsCString
mUniqueId
;
nsString
mFacingMode
;
}
;
}
#
endif
