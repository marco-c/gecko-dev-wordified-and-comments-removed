#
ifndef
MediaEngineSource_h
#
define
MediaEngineSource_h
#
include
"
MediaSegment
.
h
"
#
include
"
MediaTrackConstraints
.
h
"
#
include
"
mozilla
/
dom
/
MediaStreamTrackBinding
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
ThreadSafeWeakPtr
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
TrackID
.
h
"
namespace
mozilla
{
namespace
dom
{
class
Blob
;
struct
MediaTrackSettings
;
}
namespace
ipc
{
class
PrincipalInfo
;
}
class
AllocationHandle
;
class
MediaEnginePhotoCallback
;
class
MediaEnginePrefs
;
class
SourceMediaStream
;
class
MediaEnginePhotoCallback
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
MediaEnginePhotoCallback
)
virtual
nsresult
PhotoComplete
(
already_AddRefed
<
dom
:
:
Blob
>
aBlob
)
=
0
;
virtual
nsresult
PhotoError
(
nsresult
aRv
)
=
0
;
protected
:
virtual
~
MediaEnginePhotoCallback
(
)
{
}
}
;
enum
MediaEngineSourceState
{
kAllocated
kStarted
kStopped
kReleased
}
;
class
MediaEngineSourceInterface
{
public
:
virtual
bool
RequiresSharing
(
)
const
=
0
;
virtual
bool
IsFake
(
)
const
=
0
;
virtual
nsString
GetName
(
)
const
=
0
;
virtual
nsCString
GetUUID
(
)
const
=
0
;
virtual
dom
:
:
MediaSourceEnum
GetMediaSource
(
)
const
=
0
;
virtual
bool
GetScary
(
)
const
=
0
;
virtual
RefPtr
<
GenericNonExclusivePromise
>
GetFirstFramePromise
(
)
const
{
return
nullptr
;
}
virtual
nsresult
Allocate
(
const
dom
:
:
MediaTrackConstraints
&
aConstraints
const
MediaEnginePrefs
&
aPrefs
const
nsString
&
aDeviceId
const
mozilla
:
:
ipc
:
:
PrincipalInfo
&
aPrincipalInfo
AllocationHandle
*
*
aOutHandle
const
char
*
*
aOutBadConstraint
)
=
0
;
virtual
nsresult
SetTrack
(
const
RefPtr
<
const
AllocationHandle
>
&
aHandle
const
RefPtr
<
SourceMediaStream
>
&
aStream
TrackID
aTrackID
const
PrincipalHandle
&
aPrincipal
)
=
0
;
virtual
nsresult
Start
(
const
RefPtr
<
const
AllocationHandle
>
&
aHandle
)
=
0
;
virtual
nsresult
FocusOnSelectedSource
(
const
RefPtr
<
const
AllocationHandle
>
&
aHandle
)
=
0
;
virtual
nsresult
Reconfigure
(
const
RefPtr
<
AllocationHandle
>
&
aHandle
const
dom
:
:
MediaTrackConstraints
&
aConstraints
const
MediaEnginePrefs
&
aPrefs
const
nsString
&
aDeviceId
const
char
*
*
aOutBadConstraint
)
=
0
;
virtual
nsresult
Stop
(
const
RefPtr
<
const
AllocationHandle
>
&
aHandle
)
=
0
;
virtual
nsresult
Deallocate
(
const
RefPtr
<
const
AllocationHandle
>
&
aHandle
)
=
0
;
virtual
void
Shutdown
(
)
=
0
;
virtual
nsresult
TakePhoto
(
MediaEnginePhotoCallback
*
aCallback
)
=
0
;
virtual
uint32_t
GetBestFitnessDistance
(
const
nsTArray
<
const
NormalizedConstraintSet
*
>
&
aConstraintSets
const
nsString
&
aDeviceId
)
const
=
0
;
virtual
void
GetSettings
(
dom
:
:
MediaTrackSettings
&
aOutSettings
)
const
=
0
;
virtual
void
Pull
(
const
RefPtr
<
const
AllocationHandle
>
&
aHandle
const
RefPtr
<
SourceMediaStream
>
&
aStream
TrackID
aTrackID
StreamTime
aEndOfAppendedData
StreamTime
aDesiredTime
const
PrincipalHandle
&
aPrincipalHandle
)
=
0
;
}
;
class
MediaEngineSource
:
public
MediaEngineSourceInterface
{
public
:
static
const
unsigned
int
kMaxDeviceNameLength
=
128
;
static
const
unsigned
int
kMaxUniqueIdLength
=
256
;
static
bool
IsVideo
(
dom
:
:
MediaSourceEnum
aSource
)
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
MediaEngineSource
)
NS_DECL_OWNINGTHREAD
void
AssertIsOnOwningThread
(
)
const
{
NS_ASSERT_OWNINGTHREAD
(
MediaEngineSource
)
;
}
bool
RequiresSharing
(
)
const
override
;
bool
IsFake
(
)
const
override
;
bool
GetScary
(
)
const
override
;
nsresult
FocusOnSelectedSource
(
const
RefPtr
<
const
AllocationHandle
>
&
aHandle
)
override
;
void
Shutdown
(
)
override
;
nsresult
TakePhoto
(
MediaEnginePhotoCallback
*
aCallback
)
override
;
void
GetSettings
(
dom
:
:
MediaTrackSettings
&
aOutSettings
)
const
override
;
protected
:
virtual
~
MediaEngineSource
(
)
;
}
;
}
#
endif
