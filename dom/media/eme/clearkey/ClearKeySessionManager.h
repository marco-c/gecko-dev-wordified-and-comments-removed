#
ifndef
__ClearKeyDecryptor_h__
#
define
__ClearKeyDecryptor_h__
#
include
<
stddef
.
h
>
#
include
<
functional
>
#
include
<
map
>
#
include
<
optional
>
#
include
<
queue
>
#
include
<
set
>
#
include
<
string
>
#
include
"
ClearKeyDecryptionManager
.
h
"
#
include
"
ClearKeyPersistence
.
h
"
#
include
"
ClearKeySession
.
h
"
#
include
"
ClearKeyUtils
.
h
"
#
include
"
RefCounted
.
h
"
#
include
"
content_decryption_module
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
class
ClearKeySessionManager
final
:
public
RefCounted
{
public
:
explicit
ClearKeySessionManager
(
cdm
:
:
Host_11
*
aHost
)
;
void
Init
(
bool
aDistinctiveIdentifierAllowed
bool
aPersistentStateAllowed
)
;
void
CreateSession
(
uint32_t
aPromiseId
cdm
:
:
InitDataType
aInitDataType
const
uint8_t
*
aInitData
uint32_t
aInitDataSize
cdm
:
:
SessionType
aSessionType
)
;
void
LoadSession
(
uint32_t
aPromiseId
const
char
*
aSessionId
uint32_t
aSessionIdLength
)
;
void
UpdateSession
(
uint32_t
aPromiseId
const
char
*
aSessionId
uint32_t
aSessionIdLength
const
uint8_t
*
aResponse
uint32_t
aResponseSize
)
;
void
CloseSession
(
uint32_t
aPromiseId
const
char
*
aSessionId
uint32_t
aSessionIdLength
)
;
void
RemoveSession
(
uint32_t
aPromiseId
const
char
*
aSessionId
uint32_t
aSessionIdLength
)
;
void
SetServerCertificate
(
uint32_t
aPromiseId
const
uint8_t
*
aServerCert
uint32_t
aServerCertSize
)
;
cdm
:
:
Status
Decrypt
(
const
cdm
:
:
InputBuffer_2
&
aBuffer
cdm
:
:
DecryptedBlock
*
aDecryptedBlock
)
;
void
DecryptingComplete
(
)
;
void
PersistentSessionDataLoaded
(
uint32_t
aPromiseId
const
std
:
:
string
&
aSessionId
const
uint8_t
*
aKeyData
uint32_t
aKeyDataSize
)
;
void
OnQueryOutputProtectionStatus
(
cdm
:
:
QueryResult
aResult
uint32_t
aLinkMask
uint32_t
aOutputProtectionMask
)
;
void
QueryOutputProtectionStatusIfNeeded
(
)
;
private
:
~
ClearKeySessionManager
(
)
;
void
ClearInMemorySessionData
(
ClearKeySession
*
aSession
)
;
bool
MaybeDeferTillInitialized
(
std
:
:
function
<
void
(
)
>
&
&
aMaybeDefer
)
;
void
Serialize
(
const
ClearKeySession
*
aSession
std
:
:
vector
<
uint8_t
>
&
aOutKeyData
)
;
void
QueryOutputProtectionStatusFromHost
(
)
;
void
NotifyOutputProtectionStatus
(
cdm
:
:
KeyStatus
aStatus
)
;
RefPtr
<
ClearKeyDecryptionManager
>
mDecryptionManager
;
RefPtr
<
ClearKeyPersistence
>
mPersistence
;
cdm
:
:
Host_11
*
mHost
=
nullptr
;
std
:
:
set
<
KeyId
>
mKeyIds
;
std
:
:
map
<
std
:
:
string
ClearKeySession
*
>
mSessions
;
std
:
:
optional
<
std
:
:
string
>
mLastSessionId
;
std
:
:
queue
<
std
:
:
function
<
void
(
)
>
>
mDeferredInitialize
;
bool
mHasOutstandingOutputProtectionQuery
=
false
;
mozilla
:
:
TimeStamp
mLastOutputProtectionQueryTime
;
}
;
#
endif
