#
ifndef
__DetailedPromise_h__
#
define
__DetailedPromise_h__
#
include
"
mozilla
/
dom
/
Promise
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
include
"
EMEUtils
.
h
"
namespace
mozilla
{
namespace
dom
{
class
DetailedPromise
:
public
Promise
{
public
:
static
already_AddRefed
<
DetailedPromise
>
Create
(
nsIGlobalObject
*
aGlobal
ErrorResult
&
aRv
const
nsACString
&
aName
)
;
static
already_AddRefed
<
DetailedPromise
>
Create
(
nsIGlobalObject
*
aGlobal
ErrorResult
&
aRv
const
nsACString
&
aName
Telemetry
:
:
HistogramID
aSuccessLatencyProbe
Telemetry
:
:
HistogramID
aFailureLatencyProbe
)
;
template
<
typename
T
>
void
MaybeResolve
(
T
&
&
aArg
)
{
EME_LOG
(
"
%
s
promise
resolved
"
mName
.
get
(
)
)
;
MaybeReportTelemetry
(
eStatus
:
:
kSucceeded
)
;
Promise
:
:
MaybeResolve
(
std
:
:
forward
<
T
>
(
aArg
)
)
;
}
void
MaybeReject
(
nsresult
aArg
)
=
delete
;
void
MaybeReject
(
nsresult
aArg
const
nsACString
&
aReason
)
;
void
MaybeReject
(
ErrorResult
&
aArg
)
=
delete
;
void
MaybeReject
(
ErrorResult
&
aArg
const
nsACString
&
aReason
)
;
private
:
explicit
DetailedPromise
(
nsIGlobalObject
*
aGlobal
const
nsACString
&
aName
)
;
explicit
DetailedPromise
(
nsIGlobalObject
*
aGlobal
const
nsACString
&
aName
Telemetry
:
:
HistogramID
aSuccessLatencyProbe
Telemetry
:
:
HistogramID
aFailureLatencyProbe
)
;
virtual
~
DetailedPromise
(
)
;
enum
eStatus
{
kSucceeded
kFailed
}
;
void
MaybeReportTelemetry
(
eStatus
aStatus
)
;
void
LogRejectionReason
(
uint32_t
aErrorCode
const
nsACString
&
aReason
)
;
nsCString
mName
;
bool
mResponded
;
TimeStamp
mStartTime
;
Optional
<
Telemetry
:
:
HistogramID
>
mSuccessLatencyProbe
;
Optional
<
Telemetry
:
:
HistogramID
>
mFailureLatencyProbe
;
}
;
}
}
#
endif
