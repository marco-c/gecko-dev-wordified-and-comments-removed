#
ifndef
MOZILLA_MEDIASOURCEDECODER_H_
#
define
MOZILLA_MEDIASOURCEDECODER_H_
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsError
.
h
"
#
include
"
MediaDecoder
.
h
"
#
include
"
MediaFormatReader
.
h
"
class
nsIStreamListener
;
namespace
mozilla
{
class
MediaResource
;
class
MediaDecoderStateMachine
;
class
SourceBufferDecoder
;
class
TrackBuffer
;
enum
MSRangeRemovalAction
:
uint8_t
;
class
MediaSourceDemuxer
;
namespace
dom
{
class
HTMLMediaElement
;
class
MediaSource
;
}
class
MediaSourceDecoder
:
public
MediaDecoder
{
public
:
explicit
MediaSourceDecoder
(
dom
:
:
HTMLMediaElement
*
aElement
)
;
MediaDecoder
*
Clone
(
MediaDecoderOwner
*
aOwner
)
override
;
MediaDecoderStateMachine
*
CreateStateMachine
(
)
override
;
nsresult
Load
(
nsIStreamListener
*
*
)
override
;
media
:
:
TimeIntervals
GetSeekable
(
)
override
;
media
:
:
TimeIntervals
GetBuffered
(
)
override
;
void
NotifyDormantSupported
(
bool
aSupported
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
mDormantSupported
=
aSupported
;
}
void
Shutdown
(
)
override
;
static
already_AddRefed
<
MediaResource
>
CreateResource
(
nsIPrincipal
*
aPrincipal
=
nullptr
)
;
void
AttachMediaSource
(
dom
:
:
MediaSource
*
aMediaSource
)
;
void
DetachMediaSource
(
)
;
void
Ended
(
bool
aEnded
)
;
double
GetDuration
(
)
override
;
void
SetInitialDuration
(
int64_t
aDuration
)
;
void
SetMediaSourceDuration
(
double
aDuration
MSRangeRemovalAction
aAction
)
;
double
GetMediaSourceDuration
(
)
;
MediaSourceDemuxer
*
GetDemuxer
(
)
{
return
mDemuxer
;
}
void
GetMozDebugReaderData
(
nsAString
&
aString
)
override
;
void
AddSizeOfResources
(
ResourceSizes
*
aSizes
)
override
;
MediaDecoderOwner
:
:
NextFrameStatus
NextFrameBufferedStatus
(
)
override
;
bool
CanPlayThrough
(
)
override
;
private
:
void
DoSetMediaSourceDuration
(
double
aDuration
)
;
media
:
:
TimeInterval
ClampIntervalToEnd
(
const
media
:
:
TimeInterval
&
aInterval
)
;
dom
:
:
MediaSource
*
mMediaSource
;
RefPtr
<
MediaSourceDemuxer
>
mDemuxer
;
RefPtr
<
MediaFormatReader
>
mReader
;
Atomic
<
bool
>
mEnded
;
}
;
}
#
endif
