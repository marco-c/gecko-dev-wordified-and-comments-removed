#
include
"
MediaSessionController
.
h
"
#
include
"
mozilla
/
dom
/
CanonicalBrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
WindowGlobalParent
.
h
"
#
include
"
nsIChromeRegistry
.
h
"
#
include
"
nsIXULAppInfo
.
h
"
#
ifdef
MOZ_PLACES
#
include
"
nsIFaviconService
.
h
"
#
endif
mozilla
:
:
LazyLogModule
gMediaSession
(
"
MediaSession
"
)
;
#
undef
LOG
#
define
LOG
(
msg
.
.
.
)
\
MOZ_LOG
(
gMediaSession
LogLevel
:
:
Debug
\
(
"
MediaSessionController
=
%
p
"
msg
this
#
#
__VA_ARGS__
)
)
namespace
mozilla
{
namespace
dom
{
static
bool
IsMetadataEmpty
(
const
Maybe
<
MediaMetadataBase
>
&
aMetadata
)
{
if
(
!
aMetadata
)
{
return
true
;
}
const
MediaMetadataBase
&
metadata
=
*
aMetadata
;
return
metadata
.
mTitle
.
IsEmpty
(
)
&
&
metadata
.
mArtist
.
IsEmpty
(
)
&
&
metadata
.
mAlbum
.
IsEmpty
(
)
&
&
metadata
.
mArtwork
.
IsEmpty
(
)
;
}
MediaSessionController
:
:
MediaSessionController
(
uint64_t
aContextId
)
:
mTopLevelBCId
(
aContextId
)
{
MOZ_DIAGNOSTIC_ASSERT
(
XRE_IsParentProcess
(
)
"
MediaSessionController
only
runs
on
Chrome
process
!
"
)
;
}
void
MediaSessionController
:
:
NotifySessionCreated
(
uint64_t
aSessionContextId
)
{
if
(
mMetadataMap
.
Contains
(
aSessionContextId
)
)
{
return
;
}
Maybe
<
MediaMetadataBase
>
empty
;
LOG
(
"
Session
%
"
PRId64
"
has
been
created
"
aSessionContextId
)
;
mMetadataMap
.
Put
(
aSessionContextId
empty
)
;
UpdateActiveMediaSessionContextId
(
)
;
}
void
MediaSessionController
:
:
NotifySessionDestroyed
(
uint64_t
aSessionContextId
)
{
if
(
!
mMetadataMap
.
Contains
(
aSessionContextId
)
)
{
return
;
}
LOG
(
"
Session
%
"
PRId64
"
has
been
destroyed
"
aSessionContextId
)
;
mMetadataMap
.
Remove
(
aSessionContextId
)
;
UpdateActiveMediaSessionContextId
(
)
;
}
void
MediaSessionController
:
:
UpdateMetadata
(
uint64_t
aSessionContextId
const
Maybe
<
MediaMetadataBase
>
&
aMetadata
)
{
if
(
!
mMetadataMap
.
Contains
(
aSessionContextId
)
)
{
return
;
}
if
(
IsMetadataEmpty
(
aMetadata
)
)
{
LOG
(
"
Reset
metadata
for
session
%
"
PRId64
aSessionContextId
)
;
mMetadataMap
.
GetValue
(
aSessionContextId
)
-
>
reset
(
)
;
}
else
{
LOG
(
"
Update
metadata
for
session
%
"
PRId64
"
title
=
%
s
artist
=
%
s
album
=
%
s
"
aSessionContextId
NS_ConvertUTF16toUTF8
(
(
*
aMetadata
)
.
mTitle
)
.
get
(
)
NS_ConvertUTF16toUTF8
(
aMetadata
-
>
mArtist
)
.
get
(
)
NS_ConvertUTF16toUTF8
(
aMetadata
-
>
mAlbum
)
.
get
(
)
)
;
mMetadataMap
.
Put
(
aSessionContextId
aMetadata
)
;
}
mMetadataChangedEvent
.
Notify
(
GetCurrentMediaMetadata
(
)
)
;
}
void
MediaSessionController
:
:
UpdateActiveMediaSessionContextId
(
)
{
uint64_t
candidateId
=
0
;
if
(
mActiveMediaSessionContextId
&
&
mMetadataMap
.
Contains
(
*
mActiveMediaSessionContextId
)
)
{
candidateId
=
*
mActiveMediaSessionContextId
;
}
for
(
auto
iter
=
mMetadataMap
.
ConstIter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
if
(
RefPtr
<
BrowsingContext
>
bc
=
BrowsingContext
:
:
Get
(
iter
.
Key
(
)
)
;
bc
-
>
IsTopContent
(
)
)
{
candidateId
=
iter
.
Key
(
)
;
break
;
}
if
(
!
candidateId
)
{
candidateId
=
iter
.
Key
(
)
;
}
}
if
(
mActiveMediaSessionContextId
&
&
*
mActiveMediaSessionContextId
=
=
candidateId
)
{
LOG
(
"
Active
session
%
"
PRId64
"
keeps
unchanged
"
*
mActiveMediaSessionContextId
)
;
return
;
}
mActiveMediaSessionContextId
=
Some
(
candidateId
)
;
LOG
(
"
Session
%
"
PRId64
"
becomes
active
session
"
*
mActiveMediaSessionContextId
)
;
}
MediaMetadataBase
MediaSessionController
:
:
CreateDefaultMetadata
(
)
const
{
MediaMetadataBase
metadata
;
RefPtr
<
CanonicalBrowsingContext
>
bc
=
CanonicalBrowsingContext
:
:
Get
(
mTopLevelBCId
)
;
if
(
!
bc
)
{
return
metadata
;
}
RefPtr
<
WindowGlobalParent
>
globalParent
=
bc
-
>
GetCurrentWindowGlobal
(
)
;
if
(
!
globalParent
)
{
return
metadata
;
}
bool
inPrivateBrowsing
=
false
;
if
(
RefPtr
<
Element
>
element
=
bc
-
>
GetEmbedderElement
(
)
)
{
inPrivateBrowsing
=
nsContentUtils
:
:
IsInPrivateBrowsing
(
element
-
>
OwnerDoc
(
)
)
;
}
if
(
inPrivateBrowsing
)
{
if
(
nsCOMPtr
<
nsIXULAppInfo
>
appInfo
=
do_GetService
(
"
mozilla
.
org
/
xre
/
app
-
info
;
1
"
)
)
{
nsCString
appName
;
appInfo
-
>
GetName
(
appName
)
;
CopyUTF8toUTF16
(
appName
metadata
.
mTitle
)
;
}
else
{
metadata
.
mTitle
.
AssignLiteral
(
"
Firefox
"
)
;
}
metadata
.
mTitle
.
AppendLiteral
(
"
is
playing
media
"
)
;
}
else
{
metadata
.
mTitle
=
globalParent
-
>
GetDocumentTitle
(
)
;
}
metadata
.
mArtwork
.
AppendElement
(
)
-
>
mSrc
=
GetDefaultFaviconURL
(
)
;
LOG
(
"
Default
media
metadata
title
=
%
s
album
src
=
%
s
"
NS_ConvertUTF16toUTF8
(
metadata
.
mTitle
)
.
get
(
)
NS_ConvertUTF16toUTF8
(
metadata
.
mArtwork
[
0
]
.
mSrc
)
.
get
(
)
)
;
return
metadata
;
}
nsString
MediaSessionController
:
:
GetDefaultFaviconURL
(
)
const
{
#
ifdef
MOZ_PLACES
nsCOMPtr
<
nsIURI
>
faviconURI
;
nsresult
rv
=
NS_NewURI
(
getter_AddRefs
(
faviconURI
)
NS_LITERAL_CSTRING
(
FAVICON_DEFAULT_URL
)
)
;
NS_ENSURE_SUCCESS
(
rv
NS_LITERAL_STRING
(
"
"
)
)
;
nsCOMPtr
<
nsIChromeRegistry
>
regService
=
services
:
:
GetChromeRegistryService
(
)
;
if
(
!
regService
)
{
return
EmptyString
(
)
;
}
nsCOMPtr
<
nsIURI
>
processedURI
;
regService
-
>
ConvertChromeURL
(
faviconURI
getter_AddRefs
(
processedURI
)
)
;
nsAutoCString
spec
;
if
(
NS_FAILED
(
processedURI
-
>
GetSpec
(
spec
)
)
)
{
return
EmptyString
(
)
;
}
return
NS_ConvertUTF8toUTF16
(
spec
)
;
#
endif
return
EmptyString
(
)
;
}
MediaMetadataBase
MediaSessionController
:
:
GetCurrentMediaMetadata
(
)
const
{
if
(
mActiveMediaSessionContextId
)
{
Maybe
<
MediaMetadataBase
>
metadata
=
mMetadataMap
.
Get
(
*
mActiveMediaSessionContextId
)
;
return
metadata
?
*
metadata
:
CreateDefaultMetadata
(
)
;
}
return
CreateDefaultMetadata
(
)
;
}
}
}
