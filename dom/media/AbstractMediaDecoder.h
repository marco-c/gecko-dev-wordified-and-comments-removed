#
ifndef
AbstractMediaDecoder_h_
#
define
AbstractMediaDecoder_h_
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
StateMirroring
.
h
"
#
include
"
FrameStatistics
.
h
"
#
include
"
MediaEventSource
.
h
"
#
include
"
MediaInfo
.
h
"
#
include
"
nsISupports
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsThreadUtils
.
h
"
class
GMPCrashHelper
;
namespace
mozilla
{
namespace
layers
{
class
ImageContainer
;
}
class
MediaResource
;
class
ReentrantMonitor
;
class
VideoFrameContainer
;
class
MediaDecoderOwner
;
class
CDMProxy
;
typedef
nsDataHashtable
<
nsCStringHashKey
nsCString
>
MetadataTags
;
static
inline
bool
IsCurrentThread
(
nsIThread
*
aThread
)
{
return
NS_GetCurrentThread
(
)
=
=
aThread
;
}
class
AbstractMediaDecoder
:
public
nsIObserver
{
public
:
virtual
bool
IsOggDecoderShutdown
(
)
{
return
false
;
}
virtual
MediaResource
*
GetResource
(
)
const
=
0
;
virtual
void
NotifyDecodedFrames
(
const
FrameStatisticsData
&
aStats
)
=
0
;
virtual
AbstractCanonical
<
media
:
:
NullableTimeUnit
>
*
CanonicalDurationOrNull
(
)
{
return
nullptr
;
}
;
virtual
MediaEventSource
<
void
>
*
DataArrivedEvent
(
)
{
return
nullptr
;
}
virtual
void
NotifyWaitingForKey
(
)
{
}
virtual
MediaEventSource
<
void
>
*
WaitingForKeyEvent
(
)
{
return
nullptr
;
}
protected
:
virtual
void
UpdateEstimatedMediaDuration
(
int64_t
aDuration
)
{
}
;
public
:
void
DispatchUpdateEstimatedMediaDuration
(
int64_t
aDuration
)
{
NS_DispatchToMainThread
(
NewRunnableMethod
<
int64_t
>
(
this
&
AbstractMediaDecoder
:
:
UpdateEstimatedMediaDuration
aDuration
)
)
;
}
virtual
VideoFrameContainer
*
GetVideoFrameContainer
(
)
=
0
;
virtual
mozilla
:
:
layers
:
:
ImageContainer
*
GetImageContainer
(
)
=
0
;
virtual
MediaDecoderOwner
*
GetOwner
(
)
const
=
0
;
virtual
void
SetPlatformCanOffloadAudio
(
bool
aCanOffloadAudio
)
{
}
virtual
already_AddRefed
<
GMPCrashHelper
>
GetCrashHelper
(
)
{
return
nullptr
;
}
class
AutoNotifyDecoded
{
public
:
explicit
AutoNotifyDecoded
(
AbstractMediaDecoder
*
aDecoder
)
:
mDecoder
(
aDecoder
)
{
}
~
AutoNotifyDecoded
(
)
{
if
(
mDecoder
)
{
mDecoder
-
>
NotifyDecodedFrames
(
mStats
)
;
}
}
FrameStatisticsData
mStats
;
private
:
AbstractMediaDecoder
*
mDecoder
;
}
;
NS_IMETHOD
Observe
(
nsISupports
*
aSubject
const
char
*
aTopic
const
char16_t
*
aData
)
override
{
MOZ_CRASH
(
"
Forbidden
method
"
)
;
return
NS_OK
;
}
}
;
}
#
endif
