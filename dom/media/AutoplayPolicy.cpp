#
include
"
AutoplayPolicy
.
h
"
#
include
"
mozilla
/
EventStateManager
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
dom
/
AudioContext
.
h
"
#
include
"
mozilla
/
dom
/
HTMLMediaElement
.
h
"
#
include
"
mozilla
/
dom
/
HTMLMediaElementBinding
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIDocument
.
h
"
#
include
"
MediaManager
.
h
"
namespace
mozilla
{
namespace
dom
{
bool
AutoplayPolicy
:
:
IsMediaElementAllowedToPlay
(
NotNull
<
HTMLMediaElement
*
>
aElement
)
{
if
(
Preferences
:
:
GetBool
(
"
media
.
autoplay
.
enabled
"
)
)
{
return
true
;
}
if
(
!
Preferences
:
:
GetBool
(
"
media
.
autoplay
.
enabled
.
user
-
gestures
-
needed
"
false
)
)
{
return
aElement
-
>
IsBlessed
(
)
|
|
EventStateManager
:
:
IsHandlingUserInput
(
)
;
}
MediaManager
*
manager
=
MediaManager
:
:
GetIfExists
(
)
;
if
(
manager
)
{
nsCOMPtr
<
nsPIDOMWindowInner
>
window
=
aElement
-
>
OwnerDoc
(
)
-
>
GetInnerWindow
(
)
;
if
(
window
&
&
manager
-
>
IsActivelyCapturingOrHasAPermission
(
window
-
>
WindowID
(
)
)
)
{
return
true
;
}
}
if
(
aElement
-
>
Volume
(
)
=
=
0
.
0
|
|
aElement
-
>
Muted
(
)
)
{
return
true
;
}
if
(
aElement
-
>
IsVideo
(
)
&
&
aElement
-
>
ReadyState
(
)
>
=
HTMLMediaElementBinding
:
:
HAVE_METADATA
&
&
!
aElement
-
>
HasAudio
(
)
)
{
return
true
;
}
if
(
nsContentUtils
:
:
IsExactSitePermAllow
(
aElement
-
>
NodePrincipal
(
)
"
autoplay
-
media
"
)
)
{
return
true
;
}
if
(
aElement
-
>
OwnerDoc
(
)
-
>
HasBeenUserActivated
(
)
)
{
return
true
;
}
return
false
;
}
bool
AutoplayPolicy
:
:
IsAudioContextAllowedToPlay
(
NotNull
<
AudioContext
*
>
aContext
)
{
if
(
Preferences
:
:
GetBool
(
"
media
.
autoplay
.
enabled
"
)
)
{
return
true
;
}
if
(
!
Preferences
:
:
GetBool
(
"
media
.
autoplay
.
enabled
.
user
-
gestures
-
needed
"
false
)
)
{
return
true
;
}
if
(
aContext
-
>
IsOffline
(
)
)
{
return
true
;
}
nsPIDOMWindowInner
*
window
=
aContext
-
>
GetOwner
(
)
;
if
(
!
window
)
{
return
false
;
}
MediaManager
*
manager
=
MediaManager
:
:
GetIfExists
(
)
;
if
(
manager
)
{
if
(
manager
-
>
IsActivelyCapturingOrHasAPermission
(
window
-
>
WindowID
(
)
)
)
{
return
true
;
}
}
nsCOMPtr
<
nsIPrincipal
>
principal
=
aContext
-
>
GetParentObject
(
)
-
>
AsGlobal
(
)
-
>
PrincipalOrNull
(
)
;
if
(
principal
&
&
nsContentUtils
:
:
IsExactSitePermAllow
(
principal
"
autoplay
-
media
"
)
)
{
return
true
;
}
if
(
window
-
>
GetExtantDoc
(
)
-
>
HasBeenUserActivated
(
)
)
{
return
true
;
}
return
false
;
}
}
}
