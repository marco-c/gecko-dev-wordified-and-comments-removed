#
ifndef
ChannelMediaDecoder_h_
#
define
ChannelMediaDecoder_h_
#
include
"
MediaDecoder
.
h
"
#
include
"
MediaResourceCallback
.
h
"
class
nsIChannel
;
class
nsIStreamListener
;
namespace
mozilla
{
class
BaseMediaResource
;
class
ChannelMediaDecoder
:
public
MediaDecoder
{
class
ResourceCallback
:
public
MediaResourceCallback
{
static
const
uint32_t
sDelay
=
500
;
public
:
explicit
ResourceCallback
(
AbstractThread
*
aMainThread
)
;
void
Connect
(
ChannelMediaDecoder
*
aDecoder
)
;
void
Disconnect
(
)
;
private
:
MediaDecoderOwner
*
GetMediaOwner
(
)
const
override
;
void
NotifyNetworkError
(
)
override
;
void
NotifyDataArrived
(
)
override
;
void
NotifyDataEnded
(
nsresult
aStatus
)
override
;
void
NotifyPrincipalChanged
(
)
override
;
void
NotifySuspendedStatusChanged
(
)
override
;
void
NotifyBytesConsumed
(
int64_t
aBytes
int64_t
aOffset
)
override
;
static
void
TimerCallback
(
nsITimer
*
aTimer
void
*
aClosure
)
;
ChannelMediaDecoder
*
mDecoder
=
nullptr
;
nsCOMPtr
<
nsITimer
>
mTimer
;
bool
mTimerArmed
=
false
;
const
RefPtr
<
AbstractThread
>
mAbstractMainThread
;
}
;
protected
:
void
OnPlaybackEvent
(
MediaEventType
aEvent
)
override
;
void
DurationChanged
(
)
override
;
void
DownloadProgressed
(
)
override
;
RefPtr
<
ResourceCallback
>
mResourceCallback
;
RefPtr
<
BaseMediaResource
>
mResource
;
public
:
explicit
ChannelMediaDecoder
(
MediaDecoderInit
&
aInit
)
;
MediaDecoderStateMachine
*
CreateStateMachine
(
)
override
;
MediaResource
*
GetResource
(
)
const
override
final
;
void
Shutdown
(
)
override
;
bool
CanClone
(
)
;
already_AddRefed
<
ChannelMediaDecoder
>
Clone
(
MediaDecoderInit
&
aInit
)
;
nsresult
Load
(
nsIChannel
*
aChannel
bool
aIsPrivateBrowsing
nsIStreamListener
*
*
aStreamListener
)
;
private
:
virtual
ChannelMediaDecoder
*
CloneImpl
(
MediaDecoderInit
&
aInit
)
=
0
;
nsresult
OpenResource
(
nsIStreamListener
*
*
aStreamListener
)
;
nsresult
Load
(
BaseMediaResource
*
aOriginal
)
;
void
NotifyDownloadEnded
(
nsresult
aStatus
)
;
void
NotifyBytesConsumed
(
int64_t
aBytes
int64_t
aOffset
)
;
void
SeekingChanged
(
)
;
bool
CanPlayThroughImpl
(
)
override
final
;
void
ComputePlaybackRate
(
)
;
void
UpdatePlaybackRate
(
)
;
MediaStatistics
GetStatistics
(
)
;
bool
ShouldThrottleDownload
(
)
;
WatchManager
<
ChannelMediaDecoder
>
mWatchManager
;
bool
mIgnoreProgressData
=
false
;
MediaChannelStatistics
mPlaybackStatistics
;
double
mPlaybackBytesPerSecond
=
0
;
bool
mPlaybackRateReliable
=
true
;
}
;
}
#
endif
