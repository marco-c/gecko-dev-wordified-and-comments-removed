#
include
"
AudioNotificationReceiver
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
nsAppRunner
.
h
"
#
include
"
nsTArray
.
h
"
static
mozilla
:
:
LazyLogModule
sLogger
(
"
AudioNotificationReceiver
"
)
;
#
undef
ANR_LOG
#
define
ANR_LOG
(
.
.
.
)
MOZ_LOG
(
sLogger
mozilla
:
:
LogLevel
:
:
Debug
(
__VA_ARGS__
)
)
#
undef
ANR_LOGW
#
define
ANR_LOGW
(
.
.
.
)
\
MOZ_LOG
(
sLogger
mozilla
:
:
LogLevel
:
:
Warning
(
__VA_ARGS__
)
)
namespace
mozilla
{
namespace
audio
{
static
StaticAutoPtr
<
nsTArray
<
DeviceChangeListener
*
>
>
sSubscribers
;
static
StaticMutex
sMutex
;
void
AudioNotificationReceiver
:
:
Register
(
DeviceChangeListener
*
aDeviceChangeListener
)
{
MOZ_ASSERT
(
XRE_IsContentProcess
(
)
)
;
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sSubscribers
)
{
sSubscribers
=
new
nsTArray
<
DeviceChangeListener
*
>
(
)
;
}
sSubscribers
-
>
AppendElement
(
aDeviceChangeListener
)
;
ANR_LOG
(
"
The
DeviceChangeListener
:
%
p
is
registered
successfully
.
"
aDeviceChangeListener
)
;
}
void
AudioNotificationReceiver
:
:
Unregister
(
DeviceChangeListener
*
aDeviceChangeListener
)
{
MOZ_ASSERT
(
XRE_IsContentProcess
(
)
)
;
StaticMutexAutoLock
lock
(
sMutex
)
;
MOZ_ASSERT
(
!
sSubscribers
-
>
IsEmpty
(
)
"
No
subscriber
.
"
)
;
sSubscribers
-
>
RemoveElement
(
aDeviceChangeListener
)
;
if
(
sSubscribers
-
>
IsEmpty
(
)
)
{
sSubscribers
=
nullptr
;
}
ANR_LOG
(
"
The
DeviceChangeListener
:
%
p
is
unregistered
successfully
.
"
aDeviceChangeListener
)
;
}
void
AudioNotificationReceiver
:
:
NotifyDefaultDeviceChanged
(
)
{
MOZ_ASSERT
(
XRE_IsContentProcess
(
)
)
;
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sSubscribers
)
{
return
;
}
for
(
DeviceChangeListener
*
stream
:
*
sSubscribers
)
{
ANR_LOG
(
"
Notify
the
DeviceChangeListener
:
%
p
"
"
that
the
default
device
has
been
changed
.
"
stream
)
;
stream
-
>
ResetDefaultDevice
(
)
;
}
}
}
}
