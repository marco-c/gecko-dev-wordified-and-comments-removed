#
ifndef
ACCURATE_SEEK_TASK_H
#
define
ACCURATE_SEEK_TASK_H
#
include
"
SeekTask
.
h
"
#
include
"
MediaCallbackID
.
h
"
#
include
"
MediaDecoderReader
.
h
"
#
include
"
SeekJob
.
h
"
namespace
mozilla
{
class
AccurateSeekTask
final
:
public
SeekTask
{
public
:
AccurateSeekTask
(
const
void
*
aDecoderID
AbstractThread
*
aThread
MediaDecoderReaderWrapper
*
aReader
SeekJob
&
&
aSeekJob
const
MediaInfo
&
aInfo
const
media
:
:
TimeUnit
&
aEnd
int64_t
aCurrentMediaTime
)
;
void
Discard
(
)
override
;
RefPtr
<
SeekTaskPromise
>
Seek
(
const
media
:
:
TimeUnit
&
aDuration
)
override
;
bool
NeedToResetMDSM
(
)
const
override
;
private
:
~
AccurateSeekTask
(
)
;
void
RequestVideoData
(
)
;
void
RequestAudioData
(
)
;
nsresult
DropAudioUpToSeekTarget
(
MediaData
*
aSample
)
;
nsresult
DropVideoUpToSeekTarget
(
MediaData
*
aSample
)
;
void
MaybeFinishSeek
(
)
;
void
OnSeekResolved
(
media
:
:
TimeUnit
)
;
void
OnSeekRejected
(
nsresult
aResult
)
;
void
OnAudioDecoded
(
MediaData
*
aAudioSample
)
;
void
OnVideoDecoded
(
MediaData
*
aVideoSample
)
;
void
OnNotDecoded
(
MediaData
:
:
Type
MediaDecoderReader
:
:
NotDecodedReason
)
;
void
SetCallbacks
(
)
;
void
CancelCallbacks
(
)
;
void
AdjustFastSeekIfNeeded
(
MediaData
*
aSample
)
;
const
media
:
:
TimeUnit
mCurrentTimeBeforeSeek
;
const
uint32_t
mAudioRate
;
bool
mDoneAudioSeeking
;
bool
mDoneVideoSeeking
;
bool
mFirstAudioSample
=
true
;
bool
mFirstVideoSample
=
true
;
RefPtr
<
MediaData
>
mFirstVideoFrameAfterSeek
;
MozPromiseRequestHolder
<
MediaDecoderReader
:
:
SeekPromise
>
mSeekRequest
;
MediaEventListener
mAudioCallback
;
MediaEventListener
mVideoCallback
;
MediaEventListener
mAudioWaitCallback
;
MediaEventListener
mVideoWaitCallback
;
}
;
}
#
endif
