#
ifndef
DOM_MEDIA_IPC_MFCDMPARENT_H_
#
define
DOM_MEDIA_IPC_MFCDMPARENT_H_
#
include
<
wrl
.
h
>
#
include
"
MFCDMExtra
.
h
"
#
include
"
MFCDMSession
.
h
"
#
include
"
MFPMPHostWrapper
.
h
"
#
include
"
RemoteMediaManagerParent
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
EventTargetAndLockCapability
.
h
"
#
include
"
mozilla
/
PMFCDMParent
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
namespace
mozilla
{
class
MFCDMProxy
;
class
MFCDMParent
final
:
public
PMFCDMParent
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
MFCDMParent
)
;
MFCDMParent
(
const
nsAString
&
aKeySystem
RemoteMediaManagerParent
*
aManager
nsISerialEventTarget
*
aManagerThread
)
;
static
void
SetWidevineL1Path
(
const
char
*
aPath
)
;
static
void
Shutdown
(
)
;
using
CapabilitiesPromise
=
MozPromise
<
CopyableTArray
<
MFCDMCapabilitiesIPDL
>
nsresult
true
>
;
static
RefPtr
<
CapabilitiesPromise
>
GetAllKeySystemsCapabilities
(
)
;
static
MFCDMParent
*
GetCDMById
(
uint64_t
aId
)
{
MOZ_ASSERT
(
sRegisteredCDMs
.
Contains
(
aId
)
)
;
return
sRegisteredCDMs
.
Get
(
aId
)
;
}
uint64_t
Id
(
)
const
{
return
mId
;
}
mozilla
:
:
ipc
:
:
IPCResult
RecvGetCapabilities
(
const
MFCDMCapabilitiesRequest
&
aRequest
GetCapabilitiesResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvInit
(
const
MFCDMInitParamsIPDL
&
aParams
InitResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvCreateSessionAndGenerateRequest
(
const
MFCDMCreateSessionParamsIPDL
&
aParams
CreateSessionAndGenerateRequestResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvLoadSession
(
const
KeySystemConfig
:
:
SessionType
&
aSessionType
const
nsString
&
aSessionId
LoadSessionResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvUpdateSession
(
const
nsString
&
aSessionId
const
CopyableTArray
<
uint8_t
>
&
aResponse
UpdateSessionResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvCloseSession
(
const
nsString
&
aSessionId
UpdateSessionResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvRemoveSession
(
const
nsString
&
aSessionId
UpdateSessionResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvSetServerCertificate
(
const
CopyableTArray
<
uint8_t
>
&
aCertificate
UpdateSessionResolver
&
&
aResolver
)
;
mozilla
:
:
ipc
:
:
IPCResult
RecvGetStatusForPolicy
(
const
dom
:
:
HDCPVersion
&
aMinHdcpVersion
GetStatusForPolicyResolver
&
&
aResolver
)
;
MFCDMProxy
*
GetMFCDMProxy
(
)
;
void
ShutdownCDM
(
)
;
void
Destroy
(
)
;
private
:
~
MFCDMParent
(
)
;
enum
class
CapabilitesFlag
{
HarewareDecryption
NeedHDCPCheck
NeedClearLeadCheck
IsPrivateBrowsing
}
;
using
CapabilitesFlagSet
=
EnumSet
<
CapabilitesFlag
uint8_t
>
;
static
LPCWSTR
GetCDMLibraryName
(
const
nsString
&
aKeySystem
)
;
static
HRESULT
GetOrCreateFactory
(
const
nsString
&
aKeySystem
Microsoft
:
:
WRL
:
:
ComPtr
<
IMFContentDecryptionModuleFactory
>
&
aFactoryOut
)
;
static
HRESULT
LoadFactory
(
const
nsString
&
aKeySystem
Microsoft
:
:
WRL
:
:
ComPtr
<
IMFContentDecryptionModuleFactory
>
&
aFactoryOut
)
;
static
void
GetCapabilities
(
const
nsString
&
aKeySystem
const
CapabilitesFlagSet
&
aFlags
IMFContentDecryptionModuleFactory
*
aFactory
MFCDMCapabilitiesIPDL
&
aCapabilitiesOut
)
;
void
Register
(
)
;
void
Unregister
(
)
;
void
ConnectSessionEvents
(
MFCDMSession
*
aSession
)
;
MFCDMSession
*
GetSession
(
const
nsString
&
aSessionId
)
;
mozilla
:
:
Mutex
&
Mutex
(
)
MOZ_RETURN_CAPABILITY
(
mCDMAccessLock
.
Lock
(
)
)
{
return
mCDMAccessLock
.
Lock
(
)
;
}
nsString
mKeySystem
;
const
RefPtr
<
RemoteMediaManagerParent
>
mManager
;
const
RefPtr
<
nsISerialEventTarget
>
mManagerThread
;
MOZ_RUNINIT
static
inline
nsTHashMap
<
nsUint64HashKey
MFCDMParent
*
>
sRegisteredCDMs
;
static
inline
uint64_t
sNextId
=
1
;
const
uint64_t
mId
;
bool
mIsInited
=
false
;
static
inline
BSTR
sWidevineL1Path
;
RefPtr
<
MFCDMParent
>
mIPDLSelfRef
;
Microsoft
:
:
WRL
:
:
ComPtr
<
IMFContentDecryptionModuleFactory
>
mFactory
;
Microsoft
:
:
WRL
:
:
ComPtr
<
MFPMPHostWrapper
>
mPMPHostWrapper
;
std
:
:
map
<
nsString
UniquePtr
<
MFCDMSession
>
>
mSessions
;
MediaEventForwarder
<
MFCDMKeyMessage
>
mKeyMessageEvents
;
MediaEventForwarder
<
MFCDMKeyStatusChange
>
mKeyChangeEvents
;
MediaEventForwarder
<
MFCDMKeyExpiration
>
mExpirationEvents
;
MediaEventForwarder
<
MFCDMSessionClosedResult
>
mClosedEvents
;
MediaEventListener
mKeyMessageListener
;
MediaEventListener
mKeyChangeListener
;
MediaEventListener
mExpirationListener
;
MediaEventListener
mClosedListener
;
mozilla
:
:
EventTargetAndLockCapability
<
nsISerialEventTarget
mozilla
:
:
Mutex
>
mCDMAccessLock
;
Microsoft
:
:
WRL
:
:
ComPtr
<
IMFContentDecryptionModule
>
mCDM
MOZ_GUARDED_BY
(
mCDMAccessLock
)
;
RefPtr
<
MFCDMProxy
>
mCDMProxy
MOZ_GUARDED_BY
(
mCDMAccessLock
)
;
}
;
class
MFCDMService
{
public
:
static
void
GetAllKeySystemsCapabilities
(
dom
:
:
Promise
*
aPromise
)
;
static
void
UpdateWidevineL1Path
(
nsIFile
*
aFile
)
;
private
:
static
RefPtr
<
GenericNonExclusivePromise
>
LaunchMFCDMProcessIfNeeded
(
ipc
:
:
SandboxingKind
aSandbox
)
;
}
;
}
#
endif
