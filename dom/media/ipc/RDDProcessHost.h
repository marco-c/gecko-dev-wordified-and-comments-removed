#
ifndef
_include_dom_media_ipc_RDDProcessHost_h_
#
define
_include_dom_media_ipc_RDDProcessHost_h_
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
ipc
/
GeckoChildProcessHost
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
namespace
mozilla
:
:
ipc
{
class
SharedPreferenceSerializer
;
}
class
nsITimer
;
namespace
mozilla
{
class
RDDChild
;
class
RDDProcessHost
final
:
public
mozilla
:
:
ipc
:
:
GeckoChildProcessHost
{
friend
class
RDDChild
;
public
:
class
Listener
{
public
:
virtual
void
OnProcessUnexpectedShutdown
(
RDDProcessHost
*
aHost
)
{
}
}
;
explicit
RDDProcessHost
(
Listener
*
listener
)
;
bool
Launch
(
geckoargs
:
:
ChildProcessArgs
aExtraOpts
)
;
RefPtr
<
GenericNonExclusivePromise
>
LaunchPromise
(
)
;
void
Shutdown
(
)
;
RDDChild
*
GetActor
(
)
const
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
mRDDChild
.
get
(
)
;
}
uint64_t
GetProcessToken
(
)
const
;
bool
IsConnected
(
)
const
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
!
!
mRDDChild
;
}
TimeStamp
GetLaunchTime
(
)
const
{
return
mLaunchTime
;
}
void
OnChannelConnected
(
base
:
:
ProcessId
peer_pid
)
override
;
void
SetListener
(
Listener
*
aListener
)
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
static
MacSandboxType
GetMacSandboxType
(
)
;
#
endif
private
:
~
RDDProcessHost
(
)
;
void
InitAfterConnect
(
bool
aSucceeded
)
;
void
OnChannelClosed
(
)
;
void
KillHard
(
const
char
*
aReason
)
;
void
DestroyProcess
(
)
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
static
bool
sLaunchWithMacSandbox
;
bool
IsMacSandboxLaunchEnabled
(
)
override
{
return
sLaunchWithMacSandbox
;
}
bool
FillMacSandboxInfo
(
MacSandboxInfo
&
aInfo
)
override
;
#
endif
DISALLOW_COPY_AND_ASSIGN
(
RDDProcessHost
)
;
Listener
*
const
mListener
;
enum
class
LaunchPhase
{
Unlaunched
Waiting
Complete
}
;
LaunchPhase
mLaunchPhase
=
LaunchPhase
:
:
Unlaunched
;
RefPtr
<
RDDChild
>
mRDDChild
;
uint64_t
mProcessToken
=
0
;
UniquePtr
<
ipc
:
:
SharedPreferenceSerializer
>
mPrefSerializer
;
bool
mShutdownRequested
=
false
;
bool
mChannelClosed
=
false
;
TimeStamp
mLaunchTime
;
void
RejectPromise
(
)
;
void
ResolvePromise
(
)
;
const
RefPtr
<
media
:
:
Refcountable
<
bool
>
>
mLiveToken
;
RefPtr
<
GenericNonExclusivePromise
:
:
Private
>
mLaunchPromise
;
bool
mLaunchPromiseSettled
=
false
;
bool
mTimerChecked
=
false
;
}
;
}
#
endif
