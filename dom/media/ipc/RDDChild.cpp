#
include
"
RDDChild
.
h
"
#
include
"
mozilla
/
dom
/
MemoryReportRequest
.
h
"
#
include
"
mozilla
/
ipc
/
CrashReporterHost
.
h
"
#
if
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_SANDBOX
)
#
include
"
mozilla
/
SandboxBroker
.
h
"
#
include
"
mozilla
/
SandboxBrokerPolicyFactory
.
h
"
#
endif
#
ifdef
MOZ_GECKO_PROFILER
#
include
"
ProfilerParent
.
h
"
#
endif
#
include
"
RDDProcessHost
.
h
"
namespace
mozilla
{
using
namespace
layers
;
RDDChild
:
:
RDDChild
(
RDDProcessHost
*
aHost
)
:
mHost
(
aHost
)
mRDDReady
(
false
)
{
MOZ_COUNT_CTOR
(
RDDChild
)
;
}
RDDChild
:
:
~
RDDChild
(
)
{
MOZ_COUNT_DTOR
(
RDDChild
)
;
}
bool
RDDChild
:
:
Init
(
bool
aStartMacSandbox
)
{
Maybe
<
FileDescriptor
>
brokerFd
;
#
if
defined
(
XP_LINUX
)
&
&
defined
(
MOZ_SANDBOX
)
auto
policy
=
SandboxBrokerPolicyFactory
:
:
GetUtilityPolicy
(
OtherPid
(
)
)
;
if
(
policy
!
=
nullptr
)
{
brokerFd
=
Some
(
FileDescriptor
(
)
)
;
mSandboxBroker
=
SandboxBroker
:
:
Create
(
std
:
:
move
(
policy
)
OtherPid
(
)
brokerFd
.
ref
(
)
)
;
if
(
NS_WARN_IF
(
mSandboxBroker
=
=
nullptr
)
)
{
return
false
;
}
MOZ_ASSERT
(
brokerFd
.
ref
(
)
.
IsValid
(
)
)
;
}
#
endif
SendInit
(
brokerFd
aStartMacSandbox
)
;
#
ifdef
MOZ_GECKO_PROFILER
Unused
<
<
SendInitProfiler
(
ProfilerParent
:
:
CreateForProcess
(
OtherPid
(
)
)
)
;
#
endif
return
true
;
}
bool
RDDChild
:
:
EnsureRDDReady
(
)
{
if
(
mRDDReady
)
{
return
true
;
}
mRDDReady
=
true
;
return
true
;
}
mozilla
:
:
ipc
:
:
IPCResult
RDDChild
:
:
RecvInitComplete
(
)
{
if
(
mRDDReady
)
{
return
IPC_OK
(
)
;
}
mRDDReady
=
true
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RDDChild
:
:
RecvInitCrashReporter
(
Shmem
&
&
aShmem
const
NativeThreadId
&
aThreadId
)
{
mCrashReporter
=
MakeUnique
<
ipc
:
:
CrashReporterHost
>
(
GeckoProcessType_RDD
aShmem
aThreadId
)
;
return
IPC_OK
(
)
;
}
bool
RDDChild
:
:
SendRequestMemoryReport
(
const
uint32_t
&
aGeneration
const
bool
&
aAnonymize
const
bool
&
aMinimizeMemoryUsage
const
Maybe
<
FileDescriptor
>
&
aDMDFile
)
{
mMemoryReportRequest
=
MakeUnique
<
MemoryReportRequestHost
>
(
aGeneration
)
;
Unused
<
<
PRDDChild
:
:
SendRequestMemoryReport
(
aGeneration
aAnonymize
aMinimizeMemoryUsage
aDMDFile
)
;
return
true
;
}
mozilla
:
:
ipc
:
:
IPCResult
RDDChild
:
:
RecvAddMemoryReport
(
const
MemoryReport
&
aReport
)
{
if
(
mMemoryReportRequest
)
{
mMemoryReportRequest
-
>
RecvReport
(
aReport
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
RDDChild
:
:
RecvFinishMemoryReport
(
const
uint32_t
&
aGeneration
)
{
if
(
mMemoryReportRequest
)
{
mMemoryReportRequest
-
>
Finish
(
aGeneration
)
;
mMemoryReportRequest
=
nullptr
;
}
return
IPC_OK
(
)
;
}
void
RDDChild
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
if
(
aWhy
=
=
AbnormalShutdown
)
{
if
(
mCrashReporter
)
{
mCrashReporter
-
>
GenerateCrashReport
(
OtherPid
(
)
)
;
mCrashReporter
=
nullptr
;
}
}
mHost
-
>
OnChannelClosed
(
)
;
}
class
DeferredDeleteRDDChild
:
public
Runnable
{
public
:
explicit
DeferredDeleteRDDChild
(
UniquePtr
<
RDDChild
>
&
&
aChild
)
:
Runnable
(
"
gfx
:
:
DeferredDeleteRDDChild
"
)
mChild
(
std
:
:
move
(
aChild
)
)
{
}
NS_IMETHODIMP
Run
(
)
override
{
return
NS_OK
;
}
private
:
UniquePtr
<
RDDChild
>
mChild
;
}
;
void
RDDChild
:
:
Destroy
(
UniquePtr
<
RDDChild
>
&
&
aChild
)
{
NS_DispatchToMainThread
(
new
DeferredDeleteRDDChild
(
std
:
:
move
(
aChild
)
)
)
;
}
}
