#
include
"
RemoteMediaDataDecoder
.
h
"
#
include
"
base
/
thread
.
h
"
#
include
"
IRemoteDecoderChild
.
h
"
#
include
"
RemoteDecoderManagerChild
.
h
"
namespace
mozilla
{
using
base
:
:
Thread
;
RemoteMediaDataDecoder
:
:
RemoteMediaDataDecoder
(
IRemoteDecoderChild
*
aChild
)
:
mChild
(
aChild
)
{
}
RemoteMediaDataDecoder
:
:
~
RemoteMediaDataDecoder
(
)
{
MOZ_ASSERT
(
!
mChild
)
;
}
RefPtr
<
MediaDataDecoder
:
:
InitPromise
>
RemoteMediaDataDecoder
:
:
Init
(
)
{
RefPtr
<
RemoteMediaDataDecoder
>
self
=
this
;
return
InvokeAsync
(
RemoteDecoderManagerChild
:
:
GetManagerAbstractThread
(
)
__func__
[
self
]
(
)
{
return
self
-
>
mChild
-
>
Init
(
)
;
}
)
-
>
Then
(
RemoteDecoderManagerChild
:
:
GetManagerAbstractThread
(
)
__func__
[
self
this
]
(
TrackType
aTrack
)
{
if
(
!
mChild
)
{
return
InitPromise
:
:
CreateAndReject
(
NS_ERROR_DOM_MEDIA_CANCELED
__func__
)
;
}
mDescription
=
mChild
-
>
GetDescriptionName
(
)
+
NS_LITERAL_CSTRING
(
"
(
remote
)
"
)
;
mIsHardwareAccelerated
=
mChild
-
>
IsHardwareAccelerated
(
mHardwareAcceleratedReason
)
;
mConversion
=
mChild
-
>
NeedsConversion
(
)
;
return
InitPromise
:
:
CreateAndResolve
(
aTrack
__func__
)
;
}
[
self
]
(
const
MediaResult
&
aError
)
{
return
InitPromise
:
:
CreateAndReject
(
aError
__func__
)
;
}
)
;
}
RefPtr
<
MediaDataDecoder
:
:
DecodePromise
>
RemoteMediaDataDecoder
:
:
Decode
(
MediaRawData
*
aSample
)
{
RefPtr
<
RemoteMediaDataDecoder
>
self
=
this
;
RefPtr
<
MediaRawData
>
sample
=
aSample
;
return
InvokeAsync
(
RemoteDecoderManagerChild
:
:
GetManagerAbstractThread
(
)
__func__
[
self
sample
]
(
)
{
return
self
-
>
mChild
-
>
Decode
(
nsTArray
<
RefPtr
<
MediaRawData
>
>
{
sample
}
)
;
}
)
;
}
RefPtr
<
MediaDataDecoder
:
:
FlushPromise
>
RemoteMediaDataDecoder
:
:
Flush
(
)
{
RefPtr
<
RemoteMediaDataDecoder
>
self
=
this
;
return
InvokeAsync
(
RemoteDecoderManagerChild
:
:
GetManagerAbstractThread
(
)
__func__
[
self
]
(
)
{
return
self
-
>
mChild
-
>
Flush
(
)
;
}
)
;
}
RefPtr
<
MediaDataDecoder
:
:
DecodePromise
>
RemoteMediaDataDecoder
:
:
Drain
(
)
{
RefPtr
<
RemoteMediaDataDecoder
>
self
=
this
;
return
InvokeAsync
(
RemoteDecoderManagerChild
:
:
GetManagerAbstractThread
(
)
__func__
[
self
]
(
)
{
return
self
-
>
mChild
-
>
Drain
(
)
;
}
)
;
}
RefPtr
<
ShutdownPromise
>
RemoteMediaDataDecoder
:
:
Shutdown
(
)
{
RefPtr
<
RemoteMediaDataDecoder
>
self
=
this
;
return
InvokeAsync
(
RemoteDecoderManagerChild
:
:
GetManagerAbstractThread
(
)
__func__
[
self
]
(
)
{
RefPtr
<
ShutdownPromise
>
p
=
self
-
>
mChild
-
>
Shutdown
(
)
;
p
-
>
Then
(
RemoteDecoderManagerChild
:
:
GetManagerThread
(
)
__func__
[
child
=
RefPtr
<
IRemoteDecoderChild
>
(
self
-
>
mChild
.
forget
(
)
)
]
(
const
ShutdownPromise
:
:
ResolveOrRejectValue
&
aValue
)
{
MOZ_ASSERT
(
aValue
.
IsResolve
(
)
)
;
child
-
>
DestroyIPDL
(
)
;
return
ShutdownPromise
:
:
CreateAndResolveOrReject
(
aValue
__func__
)
;
}
)
;
return
p
;
}
)
;
}
bool
RemoteMediaDataDecoder
:
:
IsHardwareAccelerated
(
nsACString
&
aFailureReason
)
const
{
aFailureReason
=
mHardwareAcceleratedReason
;
return
mIsHardwareAccelerated
;
}
void
RemoteMediaDataDecoder
:
:
SetSeekThreshold
(
const
media
:
:
TimeUnit
&
aTime
)
{
RefPtr
<
RemoteMediaDataDecoder
>
self
=
this
;
media
:
:
TimeUnit
time
=
aTime
;
RemoteDecoderManagerChild
:
:
GetManagerThread
(
)
-
>
Dispatch
(
NS_NewRunnableFunction
(
"
dom
:
:
RemoteMediaDataDecoder
:
:
SetSeekThreshold
"
[
=
]
(
)
{
MOZ_ASSERT
(
self
-
>
mChild
)
;
self
-
>
mChild
-
>
SetSeekThreshold
(
time
)
;
}
)
NS_DISPATCH_NORMAL
)
;
}
MediaDataDecoder
:
:
ConversionRequired
RemoteMediaDataDecoder
:
:
NeedsConversion
(
)
const
{
return
mConversion
;
}
nsCString
RemoteMediaDataDecoder
:
:
GetDescriptionName
(
)
const
{
return
mDescription
;
}
}
