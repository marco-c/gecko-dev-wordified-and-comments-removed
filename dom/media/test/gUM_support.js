async
function
pushGetUserMediaTestPrefs
(
{
fakeAudio
=
false
fakeVideo
=
false
loopbackAudio
=
false
loopbackVideo
=
false
}
)
{
if
(
!
fakeAudio
&
&
!
loopbackAudio
)
{
throw
new
Error
(
"
pushGetUserMediaTestPrefs
:
Should
have
fake
or
loopback
audio
!
"
)
;
}
else
if
(
fakeAudio
&
&
loopbackAudio
)
{
throw
new
Error
(
"
pushGetUserMediaTestPrefs
:
Should
not
have
both
fake
and
loopback
audio
!
"
)
;
}
if
(
!
fakeVideo
&
&
!
loopbackVideo
)
{
throw
new
Error
(
"
pushGetUserMediaTestPrefs
:
Should
have
fake
or
loopback
video
!
"
)
;
}
else
if
(
fakeVideo
&
&
loopbackVideo
)
{
throw
new
Error
(
"
pushGetUserMediaTestPrefs
:
Should
not
have
both
fake
and
loopback
video
!
"
)
;
}
let
testPrefs
=
[
]
;
if
(
fakeAudio
)
{
testPrefs
.
push
(
[
"
media
.
audio_loopback_dev
"
"
"
]
)
;
testPrefs
.
push
(
[
"
media
.
navigator
.
streams
.
fake
"
true
]
)
;
}
if
(
loopbackAudio
)
{
let
audioLoopDev
=
SpecialPowers
.
getCharPref
(
"
media
.
audio_loopback_dev
"
"
"
)
;
if
(
!
audioLoopDev
)
{
throw
new
Error
(
"
pushGetUserMediaTestPrefs
:
Loopback
audio
requested
but
"
+
"
media
.
audio_loopback_dev
does
not
appear
to
be
set
!
"
)
;
}
}
if
(
fakeVideo
)
{
testPrefs
.
push
(
[
"
media
.
video_loopback_dev
"
"
"
]
)
;
testPrefs
.
push
(
[
"
media
.
navigator
.
streams
.
fake
"
true
]
)
;
}
if
(
loopbackVideo
)
{
let
videoLoopDev
=
SpecialPowers
.
getCharPref
(
"
media
.
video_loopback_dev
"
"
"
)
;
if
(
!
videoLoopDev
)
{
throw
new
Error
(
"
pushGetUserMediaTestPrefs
:
Loopback
video
requested
but
"
+
"
media
.
video_loopback_dev
does
not
appear
to
be
set
!
"
)
;
}
}
if
(
loopbackAudio
|
|
loopbackVideo
)
{
testPrefs
.
push
(
[
"
media
.
navigator
.
permission
.
disabled
"
true
]
)
;
}
return
SpecialPowers
.
pushPrefEnv
(
{
set
:
testPrefs
}
)
;
}
async
function
setupGetUserMediaTestPrefs
(
)
{
let
prefRequests
=
{
}
;
let
audioLoopDev
=
SpecialPowers
.
getCharPref
(
"
media
.
audio_loopback_dev
"
"
"
)
;
if
(
audioLoopDev
)
{
prefRequests
.
fakeAudio
=
false
;
prefRequests
.
loopbackAudio
=
true
;
}
else
{
prefRequests
.
fakeAudio
=
true
;
prefRequests
.
loopbackAudio
=
false
;
}
let
videoLoopDev
=
SpecialPowers
.
getCharPref
(
"
media
.
video_loopback_dev
"
"
"
)
;
if
(
videoLoopDev
)
{
prefRequests
.
fakeVideo
=
false
;
prefRequests
.
loopbackVideo
=
true
;
}
else
{
prefRequests
.
fakeVideo
=
true
;
prefRequests
.
loopbackVideo
=
false
;
}
return
pushGetUserMediaTestPrefs
(
prefRequests
)
;
}
