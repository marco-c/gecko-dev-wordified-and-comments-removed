#
ifndef
AudioDestinationNode_h_
#
define
AudioDestinationNode_h_
#
include
"
AudioChannelService
.
h
"
#
include
"
AudioNode
.
h
"
#
include
"
AudioChannelAgent
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
namespace
mozilla
{
namespace
dom
{
class
AudioContext
;
class
AudioDestinationNode
final
:
public
AudioNode
public
nsIAudioChannelAgentCallback
public
MainThreadMediaStreamListener
{
public
:
AudioDestinationNode
(
AudioContext
*
aContext
bool
aIsOffline
bool
aAllowedToStart
uint32_t
aNumberOfChannels
uint32_t
aLength
)
;
void
DestroyMediaStream
(
)
override
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED
(
AudioDestinationNode
AudioNode
)
NS_DECL_NSIAUDIOCHANNELAGENTCALLBACK
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
uint16_t
NumberOfOutputs
(
)
const
final
{
return
0
;
}
uint32_t
MaxChannelCount
(
)
const
;
void
SetChannelCount
(
uint32_t
aChannelCount
ErrorResult
&
aRv
)
override
;
AudioNodeStream
*
Stream
(
)
;
void
Mute
(
)
;
void
Unmute
(
)
;
void
Suspend
(
)
;
void
Resume
(
)
;
void
StartRendering
(
Promise
*
aPromise
)
;
void
OfflineShutdown
(
)
;
void
NotifyMainThreadTrackEnded
(
)
override
;
void
FireOfflineCompletionEvent
(
)
;
nsresult
CreateAudioChannelAgent
(
)
;
void
DestroyAudioChannelAgent
(
)
;
const
char
*
NodeType
(
)
const
override
{
return
"
AudioDestinationNode
"
;
}
size_t
SizeOfExcludingThis
(
MallocSizeOf
aMallocSizeOf
)
const
override
;
size_t
SizeOfIncludingThis
(
MallocSizeOf
aMallocSizeOf
)
const
override
;
void
NotifyAudibleStateChanged
(
bool
aAudible
)
;
void
ResolvePromise
(
AudioBuffer
*
aRenderedBuffer
)
;
unsigned
long
Length
(
)
{
MOZ_ASSERT
(
mIsOffline
)
;
return
mFramesToProduce
;
}
protected
:
virtual
~
AudioDestinationNode
(
)
;
private
:
bool
IsCapturingAudio
(
)
const
;
void
StartAudioCapturingStream
(
)
;
void
StopAudioCapturingStream
(
)
;
SelfReference
<
AudioDestinationNode
>
mOfflineRenderingRef
;
uint32_t
mFramesToProduce
;
RefPtr
<
AudioChannelAgent
>
mAudioChannelAgent
;
RefPtr
<
MediaInputPort
>
mCaptureStreamPort
;
RefPtr
<
Promise
>
mOfflineRenderingPromise
;
bool
mIsOffline
;
bool
mAudioChannelSuspended
;
AudioChannelService
:
:
AudibleState
mAudible
;
TimeStamp
mCreatedTime
;
TimeDuration
mDurationBeforeFirstTimeAudible
;
}
;
}
}
#
endif
