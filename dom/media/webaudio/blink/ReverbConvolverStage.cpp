#
include
"
ReverbConvolverStage
.
h
"
#
include
"
ReverbAccumulationBuffer
.
h
"
#
include
"
ReverbConvolver
.
h
"
#
include
"
ReverbInputBuffer
.
h
"
#
include
"
mozilla
/
PodOperations
.
h
"
using
namespace
mozilla
;
namespace
WebCore
{
ReverbConvolverStage
:
:
ReverbConvolverStage
(
const
float
*
impulseResponse
size_t
size_t
reverbTotalLatency
size_t
stageOffset
size_t
stageLength
size_t
fftSize
size_t
renderPhase
ReverbAccumulationBuffer
*
accumulationBuffer
)
:
m_accumulationBuffer
(
accumulationBuffer
)
m_accumulationReadIndex
(
0
)
m_inputReadIndex
(
0
)
{
MOZ_ASSERT
(
impulseResponse
)
;
MOZ_ASSERT
(
accumulationBuffer
)
;
m_fftKernel
=
new
FFTBlock
(
fftSize
)
;
m_fftKernel
-
>
PadAndMakeScaledDFT
(
impulseResponse
+
stageOffset
stageLength
)
;
m_fftConvolver
=
new
FFTConvolver
(
fftSize
renderPhase
)
;
size_t
totalDelay
=
stageOffset
+
reverbTotalLatency
;
size_t
fftLatency
=
m_fftConvolver
-
>
latencyFrames
(
)
;
MOZ_ASSERT
(
totalDelay
>
=
fftLatency
)
;
totalDelay
-
=
fftLatency
;
m_postDelayLength
=
totalDelay
;
}
size_t
ReverbConvolverStage
:
:
sizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
{
size_t
amount
=
aMallocSizeOf
(
this
)
;
if
(
m_fftKernel
)
{
amount
+
=
m_fftKernel
-
>
SizeOfIncludingThis
(
aMallocSizeOf
)
;
}
if
(
m_fftConvolver
)
{
amount
+
=
m_fftConvolver
-
>
sizeOfIncludingThis
(
aMallocSizeOf
)
;
}
return
amount
;
}
void
ReverbConvolverStage
:
:
processInBackground
(
ReverbConvolver
*
convolver
)
{
ReverbInputBuffer
*
inputBuffer
=
convolver
-
>
inputBuffer
(
)
;
float
*
source
=
inputBuffer
-
>
directReadFrom
(
&
m_inputReadIndex
WEBAUDIO_BLOCK_SIZE
)
;
process
(
source
)
;
}
void
ReverbConvolverStage
:
:
process
(
const
float
*
source
)
{
MOZ_ASSERT
(
source
)
;
if
(
!
source
)
return
;
const
float
*
output
=
m_fftConvolver
-
>
process
(
m_fftKernel
source
)
;
m_accumulationBuffer
-
>
accumulate
(
output
WEBAUDIO_BLOCK_SIZE
&
m_accumulationReadIndex
m_postDelayLength
)
;
}
}
