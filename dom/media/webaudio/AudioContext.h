#
ifndef
AudioContext_h_
#
define
AudioContext_h_
#
include
"
mozilla
/
dom
/
OfflineAudioContextBinding
.
h
"
#
include
"
MediaBufferDecoder
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
DOMEventTargetHelper
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
dom
/
TypedArray
.
h
"
#
include
"
mozilla
/
RelativeTimeline
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
js
/
TypeDecls
.
h
"
#
include
"
nsIMemoryReporter
.
h
"
#
ifdef
CurrentTime
#
undef
CurrentTime
#
endif
namespace
WebCore
{
class
PeriodicWave
;
}
class
nsPIDOMWindowInner
;
namespace
mozilla
{
class
DOMMediaStream
;
class
ErrorResult
;
class
MediaStream
;
class
MediaStreamGraph
;
class
AudioNodeStream
;
namespace
dom
{
enum
class
AudioContextState
:
uint8_t
;
class
AnalyserNode
;
class
AudioBuffer
;
class
AudioBufferSourceNode
;
class
AudioDestinationNode
;
class
AudioListener
;
class
AudioNode
;
class
BiquadFilterNode
;
class
ChannelMergerNode
;
class
ChannelSplitterNode
;
class
ConstantSourceNode
;
class
ConvolverNode
;
class
DelayNode
;
class
DynamicsCompressorNode
;
class
GainNode
;
class
GlobalObject
;
class
HTMLMediaElement
;
class
IIRFilterNode
;
class
MediaElementAudioSourceNode
;
class
MediaStreamAudioDestinationNode
;
class
MediaStreamAudioSourceNode
;
class
OscillatorNode
;
class
PannerNode
;
class
ScriptProcessorNode
;
class
StereoPannerNode
;
class
WaveShaperNode
;
class
Worklet
;
class
PeriodicWave
;
struct
PeriodicWaveConstraints
;
class
Promise
;
enum
class
OscillatorType
:
uint8_t
;
class
BasicWaveFormCache
{
public
:
explicit
BasicWaveFormCache
(
uint32_t
aSampleRate
)
;
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
BasicWaveFormCache
)
WebCore
:
:
PeriodicWave
*
GetBasicWaveForm
(
OscillatorType
aType
)
;
private
:
~
BasicWaveFormCache
(
)
;
RefPtr
<
WebCore
:
:
PeriodicWave
>
mSawtooth
;
RefPtr
<
WebCore
:
:
PeriodicWave
>
mSquare
;
RefPtr
<
WebCore
:
:
PeriodicWave
>
mTriangle
;
uint32_t
mSampleRate
;
}
;
class
StateChangeTask
final
:
public
Runnable
{
public
:
StateChangeTask
(
AudioContext
*
aAudioContext
void
*
aPromise
AudioContextState
aNewState
)
;
StateChangeTask
(
AudioNodeStream
*
aStream
void
*
aPromise
AudioContextState
aNewState
)
;
NS_IMETHOD
Run
(
)
override
;
private
:
RefPtr
<
AudioContext
>
mAudioContext
;
void
*
mPromise
;
RefPtr
<
AudioNodeStream
>
mAudioNodeStream
;
AudioContextState
mNewState
;
}
;
enum
class
AudioContextOperation
{
Suspend
Resume
Close
}
;
struct
AudioContextOptions
;
class
AudioContext
final
:
public
DOMEventTargetHelper
public
nsIMemoryReporter
public
RelativeTimeline
{
AudioContext
(
nsPIDOMWindowInner
*
aParentWindow
bool
aIsOffline
uint32_t
aNumberOfChannels
=
0
uint32_t
aLength
=
0
float
aSampleRate
=
0
.
0f
)
;
~
AudioContext
(
)
;
nsresult
Init
(
)
;
public
:
typedef
uint64_t
AudioContextId
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED
(
AudioContext
DOMEventTargetHelper
)
MOZ_DEFINE_MALLOC_SIZE_OF
(
MallocSizeOf
)
nsPIDOMWindowInner
*
GetParentObject
(
)
const
{
return
GetOwner
(
)
;
}
virtual
void
DisconnectFromOwner
(
)
override
;
virtual
void
BindToOwner
(
nsIGlobalObject
*
aNew
)
override
;
void
Shutdown
(
)
;
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
using
DOMEventTargetHelper
:
:
DispatchTrustedEvent
;
static
already_AddRefed
<
AudioContext
>
Constructor
(
const
GlobalObject
&
aGlobal
const
AudioContextOptions
&
aOptions
ErrorResult
&
aRv
)
;
static
already_AddRefed
<
AudioContext
>
Constructor
(
const
GlobalObject
&
aGlobal
const
OfflineAudioContextOptions
&
aOptions
ErrorResult
&
aRv
)
;
static
already_AddRefed
<
AudioContext
>
Constructor
(
const
GlobalObject
&
aGlobal
uint32_t
aNumberOfChannels
uint32_t
aLength
float
aSampleRate
ErrorResult
&
aRv
)
;
AudioDestinationNode
*
Destination
(
)
const
{
return
mDestination
;
}
float
SampleRate
(
)
const
{
return
mSampleRate
;
}
bool
ShouldSuspendNewStream
(
)
const
{
return
mSuspendCalled
;
}
double
CurrentTime
(
)
;
AudioListener
*
Listener
(
)
;
AudioContextState
State
(
)
const
{
return
mAudioContextState
;
}
Worklet
*
GetAudioWorklet
(
ErrorResult
&
aRv
)
;
bool
IsRunning
(
)
const
;
void
NotifyScheduledSourceNodeStarted
(
)
;
already_AddRefed
<
Promise
>
Suspend
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
Promise
>
Resume
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
Promise
>
Close
(
ErrorResult
&
aRv
)
;
IMPL_EVENT_HANDLER
(
statechange
)
already_AddRefed
<
AudioBufferSourceNode
>
CreateBufferSource
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
ConstantSourceNode
>
CreateConstantSource
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
AudioBuffer
>
CreateBuffer
(
uint32_t
aNumberOfChannels
uint32_t
aLength
float
aSampleRate
ErrorResult
&
aRv
)
;
already_AddRefed
<
MediaStreamAudioDestinationNode
>
CreateMediaStreamDestination
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
ScriptProcessorNode
>
CreateScriptProcessor
(
uint32_t
aBufferSize
uint32_t
aNumberOfInputChannels
uint32_t
aNumberOfOutputChannels
ErrorResult
&
aRv
)
;
already_AddRefed
<
StereoPannerNode
>
CreateStereoPanner
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
AnalyserNode
>
CreateAnalyser
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
GainNode
>
CreateGain
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
WaveShaperNode
>
CreateWaveShaper
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
MediaElementAudioSourceNode
>
CreateMediaElementSource
(
HTMLMediaElement
&
aMediaElement
ErrorResult
&
aRv
)
;
already_AddRefed
<
MediaStreamAudioSourceNode
>
CreateMediaStreamSource
(
DOMMediaStream
&
aMediaStream
ErrorResult
&
aRv
)
;
already_AddRefed
<
DelayNode
>
CreateDelay
(
double
aMaxDelayTime
ErrorResult
&
aRv
)
;
already_AddRefed
<
PannerNode
>
CreatePanner
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
ConvolverNode
>
CreateConvolver
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
ChannelSplitterNode
>
CreateChannelSplitter
(
uint32_t
aNumberOfOutputs
ErrorResult
&
aRv
)
;
already_AddRefed
<
ChannelMergerNode
>
CreateChannelMerger
(
uint32_t
aNumberOfInputs
ErrorResult
&
aRv
)
;
already_AddRefed
<
DynamicsCompressorNode
>
CreateDynamicsCompressor
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
BiquadFilterNode
>
CreateBiquadFilter
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
IIRFilterNode
>
CreateIIRFilter
(
const
Sequence
<
double
>
&
aFeedforward
const
Sequence
<
double
>
&
aFeedback
mozilla
:
:
ErrorResult
&
aRv
)
;
already_AddRefed
<
OscillatorNode
>
CreateOscillator
(
ErrorResult
&
aRv
)
;
already_AddRefed
<
PeriodicWave
>
CreatePeriodicWave
(
const
Float32Array
&
aRealData
const
Float32Array
&
aImagData
const
PeriodicWaveConstraints
&
aConstraints
ErrorResult
&
aRv
)
;
already_AddRefed
<
Promise
>
DecodeAudioData
(
const
ArrayBuffer
&
aBuffer
const
Optional
<
OwningNonNull
<
DecodeSuccessCallback
>
>
&
aSuccessCallback
const
Optional
<
OwningNonNull
<
DecodeErrorCallback
>
>
&
aFailureCallback
ErrorResult
&
aRv
)
;
already_AddRefed
<
Promise
>
StartRendering
(
ErrorResult
&
aRv
)
;
IMPL_EVENT_HANDLER
(
complete
)
unsigned
long
Length
(
)
;
bool
IsOffline
(
)
const
{
return
mIsOffline
;
}
MediaStreamGraph
*
Graph
(
)
const
;
AudioNodeStream
*
DestinationStream
(
)
const
;
void
RegisterActiveNode
(
AudioNode
*
aNode
)
;
void
UnregisterActiveNode
(
AudioNode
*
aNode
)
;
uint32_t
MaxChannelCount
(
)
const
;
uint32_t
ActiveNodeCount
(
)
const
;
void
Mute
(
)
const
;
void
Unmute
(
)
const
;
JSObject
*
GetGlobalJSObject
(
)
const
;
void
RegisterNode
(
AudioNode
*
aNode
)
;
void
UnregisterNode
(
AudioNode
*
aNode
)
;
void
OnStateChanged
(
void
*
aPromise
AudioContextState
aNewState
)
;
BasicWaveFormCache
*
GetBasicWaveFormCache
(
)
;
bool
CheckClosed
(
ErrorResult
&
aRv
)
;
void
Dispatch
(
already_AddRefed
<
nsIRunnable
>
&
&
aRunnable
)
;
private
:
void
DisconnectFromWindow
(
)
;
void
RemoveFromDecodeQueue
(
WebAudioDecodeJob
*
aDecodeJob
)
;
void
ShutdownDecoder
(
)
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
NS_DECL_NSIMEMORYREPORTER
friend
struct
:
:
mozilla
:
:
WebAudioDecodeJob
;
nsTArray
<
MediaStream
*
>
GetAllStreams
(
)
const
;
void
ResumeInternal
(
)
;
void
SuspendInternal
(
void
*
aPromise
)
;
void
ReportBlocked
(
)
;
void
ReportToConsole
(
uint32_t
aErrorFlags
const
char
*
aMsg
)
const
;
private
:
const
AudioContextId
mId
;
const
float
mSampleRate
;
AudioContextState
mAudioContextState
;
RefPtr
<
AudioDestinationNode
>
mDestination
;
RefPtr
<
AudioListener
>
mListener
;
RefPtr
<
Worklet
>
mWorklet
;
nsTArray
<
UniquePtr
<
WebAudioDecodeJob
>
>
mDecodeJobs
;
nsTArray
<
RefPtr
<
Promise
>
>
mPromiseGripArray
;
nsTArray
<
RefPtr
<
Promise
>
>
mPendingResumePromises
;
nsTHashtable
<
nsRefPtrHashKey
<
AudioNode
>
>
mActiveNodes
;
nsTHashtable
<
nsPtrHashKey
<
AudioNode
>
>
mAllNodes
;
RefPtr
<
BasicWaveFormCache
>
mBasicWaveFormCache
;
uint32_t
mNumberOfChannels
;
bool
mIsOffline
;
bool
mIsStarted
;
bool
mIsShutDown
;
bool
mCloseCalled
;
bool
mSuspendCalled
;
bool
mIsDisconnecting
;
bool
mWasAllowedToStart
;
}
;
static
const
dom
:
:
AudioContext
:
:
AudioContextId
NO_AUDIO_CONTEXT
=
0
;
}
}
#
endif
