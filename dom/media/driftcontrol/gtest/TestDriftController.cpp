#
include
"
gtest
/
gtest
.
h
"
#
include
"
DriftController
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
using
namespace
mozilla
;
TEST
(
TestDriftController
Basic
)
{
constexpr
uint32_t
buffered
=
5
*
480
;
constexpr
uint32_t
bufferedLow
=
3
*
480
;
constexpr
uint32_t
bufferedHigh
=
7
*
480
;
DriftController
c
(
48000
48000
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000U
)
;
const
uint32_t
oneSec
=
48000
;
c
.
UpdateClock
(
oneSec
oneSec
buffered
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedLow
bufferedHigh
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48048u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47952u
)
;
}
TEST
(
TestDriftController
BasicResampler
)
{
constexpr
uint32_t
buffered
=
5
*
240
;
constexpr
uint32_t
bufferedLow
=
3
*
240
;
constexpr
uint32_t
bufferedHigh
=
7
*
240
;
DriftController
c
(
24000
48000
buffered
)
;
const
uint32_t
oneSec
=
48000
;
c
.
UpdateClock
(
oneSec
oneSec
buffered
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedLow
bufferedHigh
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48048u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47964u
)
;
}
TEST
(
TestDriftController
BufferedInput
)
{
constexpr
uint32_t
buffered
=
5
*
480
;
constexpr
uint32_t
bufferedLow
=
3
*
480
;
constexpr
uint32_t
bufferedHigh
=
7
*
480
;
DriftController
c
(
48000
48000
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
const
uint32_t
oneSec
=
48000
;
c
.
UpdateClock
(
oneSec
oneSec
buffered
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
0
2
*
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48048u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedLow
bufferedHigh
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
buffered
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47952u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47904u
)
;
}
TEST
(
TestDriftController
BufferedInputWithResampling
)
{
constexpr
uint32_t
buffered
=
5
*
240
;
constexpr
uint32_t
bufferedLow
=
3
*
240
;
constexpr
uint32_t
bufferedHigh
=
7
*
240
;
DriftController
c
(
24000
48000
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
const
uint32_t
oneSec
=
48000
;
c
.
UpdateClock
(
oneSec
oneSec
buffered
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
0
2
*
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48048u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedLow
bufferedHigh
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
buffered
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47952u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47916u
)
;
}
TEST
(
TestDriftController
SmallError
)
{
constexpr
uint32_t
buffered
=
5
*
480
;
constexpr
uint32_t
bufferedLow
=
buffered
-
48
;
constexpr
uint32_t
bufferedHigh
=
buffered
+
48
;
DriftController
c
(
48000
48000
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
const
uint32_t
oneSec
=
48000
;
c
.
UpdateClock
(
oneSec
oneSec
buffered
buffered
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedLow
bufferedHigh
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48009u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47985u
)
;
c
.
UpdateClock
(
oneSec
oneSec
bufferedHigh
bufferedLow
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
47996u
)
;
}
TEST
(
TestDriftController
SmallBufferedFrames
)
{
constexpr
uint32_t
bufferedLow
=
3
*
480
;
constexpr
uint32_t
bufferedHigh
=
7
*
480
;
DriftController
c
(
48000
48000
5
*
480
)
;
uint32_t
oneSec
=
48000
;
uint32_t
hundredMillis
=
oneSec
/
10
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000U
)
;
for
(
uint32_t
i
=
0
;
i
<
9
;
+
+
i
)
{
c
.
UpdateClock
(
hundredMillis
hundredMillis
bufferedLow
bufferedHigh
)
;
}
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48000U
)
;
c
.
UpdateClock
(
hundredMillis
hundredMillis
bufferedLow
bufferedHigh
)
;
EXPECT_EQ
(
c
.
GetCorrectedTargetRate
(
)
48048U
)
;
}
