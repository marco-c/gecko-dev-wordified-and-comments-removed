#
ifndef
DOM_MEDIA_DRIFTCONTROL_DRIFTCONTROLLER_H_
#
define
DOM_MEDIA_DRIFTCONTROL_DRIFTCONTROLLER_H_
#
include
"
TimeUnits
.
h
"
#
include
"
mozilla
/
RollingMean
.
h
"
#
include
<
algorithm
>
#
include
<
cstdint
>
#
include
"
MediaSegment
.
h
"
namespace
mozilla
{
class
DriftController
final
{
public
:
DriftController
(
uint32_t
aSourceRate
uint32_t
aTargetRate
media
:
:
TimeUnit
aDesiredBuffering
)
;
void
SetDesiredBuffering
(
media
:
:
TimeUnit
aDesiredBuffering
)
;
void
ResetAfterUnderrun
(
)
;
uint32_t
GetCorrectedSourceRate
(
)
const
;
uint32_t
NumCorrectionChanges
(
)
const
{
return
mNumCorrectionChanges
;
}
media
:
:
TimeUnit
DurationWithinHysteresis
(
)
const
{
return
mDurationWithinHysteresis
;
}
media
:
:
TimeUnit
DurationSinceDesiredBufferingChange
(
)
const
{
return
mTotalTargetClock
-
mLastDesiredBufferingChangeTime
;
}
media
:
:
TimeUnit
MeasuredSourceLatency
(
)
const
{
return
mMeasuredSourceLatency
.
mean
(
)
;
}
void
UpdateClock
(
media
:
:
TimeUnit
aSourceDuration
media
:
:
TimeUnit
aTargetDuration
uint32_t
aBufferedFrames
uint32_t
aBufferSize
)
;
private
:
void
CalculateCorrection
(
uint32_t
aBufferedFrames
uint32_t
aBufferSize
)
;
public
:
const
uint8_t
mPlotId
;
const
uint32_t
mSourceRate
;
const
uint32_t
mTargetRate
;
const
media
:
:
TimeUnit
mAdjustmentInterval
=
media
:
:
TimeUnit
:
:
FromSeconds
(
1
)
;
const
media
:
:
TimeUnit
mIntegralCapTimeLimit
=
media
:
:
TimeUnit
(
10
1
)
.
ToBase
(
mTargetRate
)
;
private
:
media
:
:
TimeUnit
mDesiredBuffering
;
int32_t
mPreviousError
=
0
;
float
mIntegral
=
0
.
0
;
Maybe
<
float
>
mIntegralCenterForCap
;
float
mCorrectedSourceRate
;
Maybe
<
int32_t
>
mLastHysteresisBoundaryCorrection
;
media
:
:
TimeUnit
mDurationWithinHysteresis
;
uint32_t
mNumCorrectionChanges
=
0
;
RollingMean
<
media
:
:
TimeUnit
media
:
:
TimeUnit
>
mMeasuredSourceLatency
;
RollingMean
<
media
:
:
TimeUnit
media
:
:
TimeUnit
>
mMeasuredTargetLatency
;
media
:
:
TimeUnit
mTargetClock
;
media
:
:
TimeUnit
mTotalTargetClock
;
media
:
:
TimeUnit
mLastDesiredBufferingChangeTime
;
}
;
}
#
endif
