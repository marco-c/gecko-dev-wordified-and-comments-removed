#
ifndef
DecoderDoctorLogger_h_
#
define
DecoderDoctorLogger_h_
#
include
"
DDLoggedTypeTraits
.
h
"
#
include
"
DDLogClass
.
h
"
#
include
"
DDLogValue
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
DefineEnum
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
nsString
.
h
"
namespace
mozilla
{
class
DecoderDoctorLogger
{
public
:
static
inline
bool
IsDDLoggingEnabled
(
)
{
return
MOZ_UNLIKELY
(
static_cast
<
LogState
>
(
sLogState
)
=
=
scEnabled
)
;
}
static
void
ShutdownLogging
(
)
{
sLogState
=
scShutdown
;
}
static
void
Panic
(
const
char
*
aReason
)
{
PanicInternal
(
aReason
false
)
;
}
template
<
typename
Value
>
static
void
EagerLogValue
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
DDLogClass
aClass
const
char
*
aLabel
Value
&
&
aValue
)
{
Log
(
aSubjectTypeName
aSubjectPointer
aClass
aLabel
DDLogValue
{
Forward
<
Value
>
(
aValue
)
}
)
;
}
template
<
typename
Subject
typename
Value
>
static
void
EagerLogValue
(
const
Subject
*
aSubject
DDLogClass
aClass
const
char
*
aLabel
Value
&
&
aValue
)
{
EagerLogValue
(
DDLoggedTypeTraits
<
Subject
>
:
:
Name
(
)
aSubject
aClass
aLabel
Forward
<
Value
>
(
aValue
)
)
;
}
template
<
size_t
N
>
static
void
LogValue
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
DDLogClass
aClass
const
char
*
aLabel
const
char
(
&
aLiteral
)
[
N
]
)
{
EagerLogValue
(
aSubjectTypeName
aSubjectPointer
aClass
aLabel
static_cast
<
const
char
*
>
(
aLiteral
)
)
;
}
template
<
typename
Subject
size_t
N
>
static
void
LogValue
(
const
Subject
*
aSubject
DDLogClass
aClass
const
char
*
aLabel
const
char
(
&
aLiteral
)
[
N
]
)
{
EagerLogValue
(
aSubject
aClass
aLabel
static_cast
<
const
char
*
>
(
aLiteral
)
)
;
}
template
<
size_t
N
>
static
void
EagerLogValue
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
DDLogClass
aClass
const
char
*
aLabel
const
char
(
&
aLiteral
)
[
N
]
)
{
EagerLogValue
(
aSubjectTypeName
aSubjectPointer
aClass
aLabel
static_cast
<
const
char
*
>
(
aLiteral
)
)
;
}
template
<
typename
Subject
size_t
N
>
static
void
EagerLogValue
(
const
Subject
*
aSubject
DDLogClass
aClass
const
char
*
aLabel
const
char
(
&
aLiteral
)
[
N
]
)
{
EagerLogValue
(
aSubject
aClass
aLabel
static_cast
<
const
char
*
>
(
aLiteral
)
)
;
}
template
<
typename
.
.
.
Args
>
static
void
EagerLogPrintf
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
DDLogClass
aClass
const
char
*
aLabel
const
char
*
aFormat
Args
&
&
.
.
.
aArgs
)
{
Log
(
aSubjectTypeName
aSubjectPointer
aClass
aLabel
DDLogValue
{
nsCString
{
nsPrintfCString
(
aFormat
Forward
<
Args
>
(
aArgs
)
.
.
.
)
}
}
)
;
}
template
<
typename
Subject
typename
.
.
.
Args
>
static
void
EagerLogPrintf
(
const
Subject
*
aSubject
DDLogClass
aClass
const
char
*
aLabel
const
char
*
aFormat
Args
&
&
.
.
.
aArgs
)
{
EagerLogPrintf
(
DDLoggedTypeTraits
<
Subject
>
:
:
Name
(
)
aSubject
aClass
aLabel
aFormat
Forward
<
Args
>
(
aArgs
)
.
.
.
)
;
}
static
void
LogConstruction
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
)
{
Log
(
aSubjectTypeName
aSubjectPointer
DDLogClass
:
:
_Construction
"
"
DDLogValue
{
DDNoValue
{
}
}
)
;
}
static
void
LogConstructionAndBase
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
const
char
*
aBaseTypeName
const
void
*
aBasePointer
)
{
Log
(
aSubjectTypeName
aSubjectPointer
DDLogClass
:
:
_DerivedConstruction
"
"
DDLogValue
{
DDLogObject
{
aBaseTypeName
aBasePointer
}
}
)
;
}
template
<
typename
B
>
static
void
LogConstructionAndBase
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
const
B
*
aBase
)
{
Log
(
aSubjectTypeName
aSubjectPointer
DDLogClass
:
:
_DerivedConstruction
"
"
DDLogValue
{
DDLogObject
{
DDLoggedTypeTraits
<
B
>
:
:
Name
(
)
aBase
}
}
)
;
}
template
<
typename
Subject
>
static
void
LogConstruction
(
const
Subject
*
aSubject
)
{
using
Traits
=
DDLoggedTypeTraits
<
Subject
>
;
if
(
!
Traits
:
:
HasBase
:
:
value
)
{
Log
(
DDLoggedTypeTraits
<
Subject
>
:
:
Name
(
)
aSubject
DDLogClass
:
:
_Construction
"
"
DDLogValue
{
DDNoValue
{
}
}
)
;
}
else
{
Log
(
DDLoggedTypeTraits
<
Subject
>
:
:
Name
(
)
aSubject
DDLogClass
:
:
_DerivedConstruction
"
"
DDLogValue
{
DDLogObject
{
DDLoggedTypeTraits
<
typename
Traits
:
:
BaseType
>
:
:
Name
(
)
static_cast
<
const
typename
Traits
:
:
BaseType
*
>
(
aSubject
)
}
}
)
;
}
}
static
void
LogDestruction
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
)
{
Log
(
aSubjectTypeName
aSubjectPointer
DDLogClass
:
:
_Destruction
"
"
DDLogValue
{
DDNoValue
{
}
}
)
;
}
template
<
typename
Subject
>
static
void
LogDestruction
(
const
Subject
*
aSubject
)
{
Log
(
DDLoggedTypeTraits
<
Subject
>
:
:
Name
(
)
aSubject
DDLogClass
:
:
_Destruction
"
"
DDLogValue
{
DDNoValue
{
}
}
)
;
}
template
<
typename
P
typename
C
>
static
void
LinkParentAndChild
(
const
P
*
aParent
const
char
*
aLinkName
const
C
*
aChild
)
{
if
(
aChild
)
{
Log
(
DDLoggedTypeTraits
<
P
>
:
:
Name
(
)
aParent
DDLogClass
:
:
_Link
aLinkName
DDLogValue
{
DDLogObject
{
DDLoggedTypeTraits
<
C
>
:
:
Name
(
)
aChild
}
}
)
;
}
}
template
<
typename
C
>
static
void
LinkParentAndChild
(
const
char
*
aParentTypeName
const
void
*
aParentPointer
const
char
*
aLinkName
const
C
*
aChild
)
{
if
(
aChild
)
{
Log
(
aParentTypeName
aParentPointer
DDLogClass
:
:
_Link
aLinkName
DDLogValue
{
DDLogObject
{
DDLoggedTypeTraits
<
C
>
:
:
Name
(
)
aChild
}
}
)
;
}
}
template
<
typename
P
>
static
void
LinkParentAndChild
(
const
P
*
aParent
const
char
*
aLinkName
const
char
*
aChildTypeName
const
void
*
aChildPointer
)
{
if
(
aChildPointer
)
{
Log
(
DDLoggedTypeTraits
<
P
>
:
:
Name
(
)
aParent
DDLogClass
:
:
_Link
aLinkName
DDLogValue
{
DDLogObject
{
aChildTypeName
aChildPointer
}
}
)
;
}
}
template
<
typename
C
>
static
void
UnlinkParentAndChild
(
const
char
*
aParentTypeName
const
void
*
aParentPointer
const
C
*
aChild
)
{
if
(
aChild
)
{
Log
(
aParentTypeName
aParentPointer
DDLogClass
:
:
_Unlink
"
"
DDLogValue
{
DDLogObject
{
DDLoggedTypeTraits
<
C
>
:
:
Name
(
)
aChild
}
}
)
;
}
}
template
<
typename
P
typename
C
>
static
void
UnlinkParentAndChild
(
const
P
*
aParent
const
C
*
aChild
)
{
if
(
aChild
)
{
Log
(
DDLoggedTypeTraits
<
P
>
:
:
Name
(
)
aParent
DDLogClass
:
:
_Unlink
"
"
DDLogValue
{
DDLogObject
{
DDLoggedTypeTraits
<
C
>
:
:
Name
(
)
aChild
}
}
)
;
}
}
static
void
EnableLogging
(
)
;
using
LogMessagesPromise
=
MozPromise
<
nsCString
nsresult
true
>
;
static
RefPtr
<
LogMessagesPromise
>
RetrieveMessages
(
const
dom
:
:
HTMLMediaElement
*
aMediaElement
)
;
private
:
static
bool
EnsureLogIsEnabled
(
)
;
static
void
PanicInternal
(
const
char
*
aReason
bool
aDontBlock
)
;
static
void
Log
(
const
char
*
aSubjectTypeName
const
void
*
aSubjectPointer
DDLogClass
aClass
const
char
*
aLabel
DDLogValue
&
&
aValue
)
;
using
LogState
=
int
;
static
constexpr
LogState
scDisabled
=
0
;
static
constexpr
LogState
scEnabled
=
1
;
static
constexpr
LogState
scEnabling
=
2
;
static
constexpr
LogState
scShutdown
=
3
;
static
Atomic
<
LogState
>
sLogState
;
static
const
char
*
sShutdownReason
;
}
;
template
<
typename
T
>
class
DecoderDoctorLifeLogger
{
public
:
DecoderDoctorLifeLogger
(
)
{
DecoderDoctorLogger
:
:
LogConstruction
(
static_cast
<
const
T
*
>
(
this
)
)
;
}
~
DecoderDoctorLifeLogger
(
)
{
DecoderDoctorLogger
:
:
LogDestruction
(
static_cast
<
const
T
*
>
(
this
)
)
;
}
}
;
#
define
DDLOG
(
_class
_label
_arg
)
\
do
{
\
if
(
DecoderDoctorLogger
:
:
IsDDLoggingEnabled
(
)
)
{
\
DecoderDoctorLogger
:
:
EagerLogValue
(
this
_class
_label
_arg
)
;
\
}
\
}
while
(
0
)
#
define
DDLOGEX
(
_this
_class
_label
_arg
)
\
do
{
\
if
(
DecoderDoctorLogger
:
:
IsDDLoggingEnabled
(
)
)
{
\
DecoderDoctorLogger
:
:
EagerLogValue
(
_this
_class
_label
_arg
)
;
\
}
\
}
while
(
0
)
#
define
DDLOGEX2
(
_typename
_this
_class
_label
_arg
)
\
do
{
\
if
(
DecoderDoctorLogger
:
:
IsDDLoggingEnabled
(
)
)
{
\
DecoderDoctorLogger
:
:
EagerLogValue
(
\
_typename
_this
_class
_label
_arg
)
;
\
}
\
}
while
(
0
)
#
ifdef
DEBUG
static
void
inline
MOZ_FORMAT_PRINTF
(
1
2
)
DDLOGPRCheck
(
const
char
*
.
.
.
)
{
}
#
define
DDLOGPR_CHECK
(
_fmt
.
.
.
)
DDLOGPRCheck
(
_fmt
__VA_ARGS__
)
#
else
#
define
DDLOGPR_CHECK
(
_fmt
.
.
.
)
#
endif
#
define
DDLOGPR
(
_class
_label
_format
.
.
.
)
\
do
{
\
if
(
DecoderDoctorLogger
:
:
IsDDLoggingEnabled
(
)
)
{
\
DDLOGPR_CHECK
(
_format
__VA_ARGS__
)
;
\
DecoderDoctorLogger
:
:
EagerLogPrintf
(
\
this
_class
_label
_format
__VA_ARGS__
)
;
\
}
\
}
while
(
0
)
#
define
DDLINKCHILD
(
.
.
.
)
\
do
{
\
if
(
DecoderDoctorLogger
:
:
IsDDLoggingEnabled
(
)
)
{
\
DecoderDoctorLogger
:
:
LinkParentAndChild
(
this
__VA_ARGS__
)
;
\
}
\
}
while
(
0
)
#
define
DDUNLINKCHILD
(
.
.
.
)
\
do
{
\
if
(
DecoderDoctorLogger
:
:
IsDDLoggingEnabled
(
)
)
{
\
DecoderDoctorLogger
:
:
UnlinkParentAndChild
(
this
__VA_ARGS__
)
;
\
}
\
}
while
(
0
)
}
#
endif
