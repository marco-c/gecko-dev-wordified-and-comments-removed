#
ifndef
DOM_MEDIA_MEDIACONTROL_FETCHIMAGEHELPER_H_
#
define
DOM_MEDIA_MEDIACONTROL_FETCHIMAGEHELPER_H_
#
include
"
imgIContainer
.
h
"
#
include
"
imgITools
.
h
"
#
include
"
imgINotificationObserver
.
h
"
#
include
"
mozilla
/
dom
/
MediaSessionBinding
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
namespace
mozilla
{
namespace
dom
{
using
ImagePromise
=
MozPromise
<
RefPtr
<
mozilla
:
:
gfx
:
:
DataSourceSurface
>
bool
true
>
;
class
FetchImageHelper
final
{
public
:
NS_INLINE_DECL_REFCOUNTING
(
FetchImageHelper
)
explicit
FetchImageHelper
(
const
MediaImage
&
aImage
)
;
RefPtr
<
ImagePromise
>
FetchImage
(
)
;
void
AbortFetchingImage
(
)
;
bool
IsFetchingImage
(
)
const
;
private
:
class
ImageFetchListener
final
:
public
imgIContainerCallback
public
imgINotificationObserver
{
public
:
NS_DECL_ISUPPORTS
ImageFetchListener
(
)
=
default
;
nsresult
FetchDecodedImageFromURI
(
nsIURI
*
aURI
FetchImageHelper
*
aHelper
)
;
void
Clear
(
)
;
bool
IsFetchingImage
(
)
const
;
NS_IMETHOD
OnImageReady
(
imgIContainer
*
aImage
nsresult
aStatus
)
override
;
void
Notify
(
imgIRequest
*
aRequest
int32_t
aType
const
nsIntRect
*
aData
)
override
;
private
:
~
ImageFetchListener
(
)
;
FetchImageHelper
*
MOZ_NON_OWNING_REF
mHelper
=
nullptr
;
nsCOMPtr
<
nsIChannel
>
mChannel
;
nsCOMPtr
<
imgIContainer
>
mImage
;
}
;
~
FetchImageHelper
(
)
;
void
ClearListenerIfNeeded
(
)
;
void
HandleFetchSuccess
(
imgIContainer
*
aImage
)
;
void
HandleFetchFail
(
)
;
nsString
mSrc
;
MozPromiseHolder
<
ImagePromise
>
mPromise
;
RefPtr
<
ImageFetchListener
>
mListener
;
}
;
}
}
#
endif
