#
include
"
PlaybackController
.
h
"
#
include
"
MediaControlUtils
.
h
"
#
include
"
mozilla
/
dom
/
MediaSession
.
h
"
#
include
"
mozilla
/
dom
/
Navigator
.
h
"
#
include
"
nsFocusManager
.
h
"
#
undef
LOG
#
define
LOG
(
msg
.
.
.
)
\
MOZ_LOG
(
gMediaControlLog
LogLevel
:
:
Debug
\
(
"
PlaybackController
=
%
p
"
msg
this
#
#
__VA_ARGS__
)
)
namespace
mozilla
{
namespace
dom
{
PlaybackController
:
:
PlaybackController
(
BrowsingContext
*
aContext
)
{
MOZ_ASSERT
(
aContext
)
;
mBC
=
aContext
;
}
MediaSession
*
PlaybackController
:
:
GetMediaSession
(
)
{
RefPtr
<
nsPIDOMWindowOuter
>
window
=
mBC
-
>
GetDOMWindow
(
)
;
if
(
!
window
)
{
return
nullptr
;
}
RefPtr
<
Navigator
>
navigator
=
window
-
>
GetNavigator
(
)
;
return
navigator
-
>
HasCreatedMediaSession
(
)
?
navigator
-
>
MediaSession
(
)
:
nullptr
;
}
void
PlaybackController
:
:
Focus
(
)
{
if
(
RefPtr
<
nsPIDOMWindowOuter
>
win
=
mBC
-
>
GetDOMWindow
(
)
)
{
nsFocusManager
:
:
FocusWindow
(
win
CallerType
:
:
System
)
;
}
}
void
PlaybackController
:
:
Play
(
)
{
const
MediaSessionAction
action
=
MediaSessionAction
:
:
Play
;
RefPtr
<
MediaSession
>
session
=
GetMediaSession
(
)
;
if
(
!
session
|
|
!
session
-
>
IsSupportedAction
(
action
)
)
{
LOG
(
"
Handle
'
play
'
in
default
behavior
"
)
;
if
(
RefPtr
<
ContentControlKeyEventReceiver
>
receiver
=
ContentControlKeyEventReceiver
:
:
Get
(
mBC
)
)
{
receiver
-
>
OnKeyPressed
(
MediaControlKeysEvent
:
:
ePlay
)
;
}
}
else
{
session
-
>
NotifyHandler
(
action
)
;
}
}
;
void
PlaybackController
:
:
Pause
(
)
{
const
MediaSessionAction
action
=
MediaSessionAction
:
:
Pause
;
RefPtr
<
MediaSession
>
session
=
GetMediaSession
(
)
;
if
(
!
session
|
|
!
session
-
>
IsSupportedAction
(
action
)
)
{
LOG
(
"
Handle
'
pause
'
in
default
behavior
"
)
;
if
(
RefPtr
<
ContentControlKeyEventReceiver
>
receiver
=
ContentControlKeyEventReceiver
:
:
Get
(
mBC
)
)
{
receiver
-
>
OnKeyPressed
(
MediaControlKeysEvent
:
:
ePause
)
;
}
}
else
{
session
-
>
NotifyHandler
(
action
)
;
}
}
void
PlaybackController
:
:
SeekBackward
(
)
{
const
MediaSessionAction
action
=
MediaSessionAction
:
:
Seekbackward
;
if
(
RefPtr
<
MediaSession
>
session
=
GetMediaSession
(
)
;
session
&
&
session
-
>
IsSupportedAction
(
action
)
)
{
session
-
>
NotifyHandler
(
action
)
;
}
}
void
PlaybackController
:
:
SeekForward
(
)
{
const
MediaSessionAction
action
=
MediaSessionAction
:
:
Seekforward
;
if
(
RefPtr
<
MediaSession
>
session
=
GetMediaSession
(
)
;
session
&
&
session
-
>
IsSupportedAction
(
action
)
)
{
session
-
>
NotifyHandler
(
action
)
;
}
}
void
PlaybackController
:
:
PreviousTrack
(
)
{
if
(
RefPtr
<
MediaSession
>
session
=
GetMediaSession
(
)
)
{
session
-
>
NotifyHandler
(
MediaSessionAction
:
:
Previoustrack
)
;
}
}
void
PlaybackController
:
:
NextTrack
(
)
{
if
(
RefPtr
<
MediaSession
>
session
=
GetMediaSession
(
)
)
{
session
-
>
NotifyHandler
(
MediaSessionAction
:
:
Nexttrack
)
;
}
}
void
PlaybackController
:
:
SkipAd
(
)
{
return
;
}
void
PlaybackController
:
:
Stop
(
)
{
const
MediaSessionAction
action
=
MediaSessionAction
:
:
Stop
;
RefPtr
<
MediaSession
>
session
=
GetMediaSession
(
)
;
if
(
!
session
|
|
!
session
-
>
IsSupportedAction
(
action
)
)
{
LOG
(
"
Handle
'
stop
'
in
default
behavior
"
)
;
RefPtr
<
ContentControlKeyEventReceiver
>
receiver
=
ContentControlKeyEventReceiver
:
:
Get
(
mBC
)
;
if
(
receiver
)
{
receiver
-
>
OnKeyPressed
(
MediaControlKeysEvent
:
:
eStop
)
;
}
}
else
{
session
-
>
NotifyHandler
(
action
)
;
}
}
void
PlaybackController
:
:
SeekTo
(
)
{
return
;
}
void
MediaActionHandler
:
:
HandleMediaControlKeysEvent
(
BrowsingContext
*
aContext
MediaControlKeysEvent
aEvent
)
{
PlaybackController
controller
(
aContext
)
;
switch
(
aEvent
)
{
case
MediaControlKeysEvent
:
:
eFocus
:
controller
.
Focus
(
)
;
return
;
case
MediaControlKeysEvent
:
:
ePlay
:
controller
.
Play
(
)
;
return
;
case
MediaControlKeysEvent
:
:
ePause
:
controller
.
Pause
(
)
;
return
;
case
MediaControlKeysEvent
:
:
eStop
:
controller
.
Stop
(
)
;
return
;
case
MediaControlKeysEvent
:
:
ePrevTrack
:
controller
.
PreviousTrack
(
)
;
return
;
case
MediaControlKeysEvent
:
:
eNextTrack
:
controller
.
NextTrack
(
)
;
return
;
case
MediaControlKeysEvent
:
:
eSeekBackward
:
controller
.
SeekBackward
(
)
;
return
;
case
MediaControlKeysEvent
:
:
eSeekForward
:
controller
.
SeekForward
(
)
;
return
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Invalid
event
.
"
)
;
}
;
}
}
}
