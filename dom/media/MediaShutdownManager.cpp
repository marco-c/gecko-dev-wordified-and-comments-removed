#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
MediaDecoder
.
h
"
#
include
"
MediaShutdownManager
.
h
"
namespace
mozilla
{
#
undef
LOGW
extern
LazyLogModule
gMediaDecoderLog
;
#
define
DECODER_LOG
(
type
msg
)
MOZ_LOG
(
gMediaDecoderLog
type
msg
)
#
define
LOGW
(
.
.
.
)
NS_WARNING
(
nsPrintfCString
(
__VA_ARGS__
)
.
get
(
)
)
#
ifdef
NIGHTLY_BUILD
#
define
DEBUG_SHUTDOWN
(
fmt
.
.
.
)
printf_stderr
(
"
[
DEBUG
SHUTDOWN
]
%
s
:
"
fmt
"
\
n
"
__func__
#
#
__VA_ARGS__
)
#
else
#
define
DEBUG_SHUTDOWN
(
.
.
.
)
do
{
}
while
(
0
)
#
endif
NS_IMPL_ISUPPORTS
(
MediaShutdownManager
nsIAsyncShutdownBlocker
)
MediaShutdownManager
:
:
MediaShutdownManager
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInitPhase
=
=
NotInited
)
;
}
MediaShutdownManager
:
:
~
MediaShutdownManager
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
StaticRefPtr
<
MediaShutdownManager
>
MediaShutdownManager
:
:
sInstance
;
MediaShutdownManager
:
:
InitPhase
MediaShutdownManager
:
:
sInitPhase
=
MediaShutdownManager
:
:
NotInited
;
MediaShutdownManager
&
MediaShutdownManager
:
:
Instance
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
#
ifdef
MOZ_DIAGNOSTIC_ASSERT_ENABLED
if
(
!
sInstance
)
{
MOZ_CRASH_UNSAFE_PRINTF
(
"
sInstance
is
null
.
sInitPhase
=
%
d
"
int
(
sInitPhase
)
)
;
}
#
endif
return
*
sInstance
;
}
static
nsCOMPtr
<
nsIAsyncShutdownClient
>
GetShutdownBarrier
(
)
{
nsCOMPtr
<
nsIAsyncShutdownService
>
svc
=
services
:
:
GetAsyncShutdown
(
)
;
MOZ_RELEASE_ASSERT
(
svc
)
;
nsCOMPtr
<
nsIAsyncShutdownClient
>
barrier
;
nsresult
rv
=
svc
-
>
GetProfileBeforeChange
(
getter_AddRefs
(
barrier
)
)
;
if
(
!
barrier
)
{
rv
=
svc
-
>
GetXpcomWillShutdown
(
getter_AddRefs
(
barrier
)
)
;
}
MOZ_RELEASE_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
MOZ_RELEASE_ASSERT
(
barrier
)
;
return
barrier
.
forget
(
)
;
}
void
MediaShutdownManager
:
:
InitStatics
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
sInitPhase
!
=
NotInited
)
{
return
;
}
sInstance
=
new
MediaShutdownManager
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInstance
)
;
nsresult
rv
=
GetShutdownBarrier
(
)
-
>
AddBlocker
(
sInstance
NS_LITERAL_STRING
(
__FILE__
)
__LINE__
NS_LITERAL_STRING
(
"
MediaShutdownManager
shutdown
"
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
LOGW
(
"
Failed
to
add
shutdown
blocker
!
rv
=
%
x
"
uint32_t
(
rv
)
)
;
sInitPhase
=
InitFailed
;
return
;
}
sInitPhase
=
InitSucceeded
;
}
void
MediaShutdownManager
:
:
RemoveBlocker
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInitPhase
=
=
XPCOMShutdownStarted
)
;
MOZ_ASSERT
(
mDecoders
.
Count
(
)
=
=
0
)
;
GetShutdownBarrier
(
)
-
>
RemoveBlocker
(
this
)
;
sInitPhase
=
XPCOMShutdownEnded
;
sInstance
=
nullptr
;
DECODER_LOG
(
LogLevel
:
:
Debug
(
"
MediaShutdownManager
:
:
BlockShutdown
(
)
end
.
"
)
)
;
}
nsresult
MediaShutdownManager
:
:
Register
(
MediaDecoder
*
aDecoder
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
sInitPhase
=
=
InitFailed
)
{
return
NS_ERROR_NOT_INITIALIZED
;
}
if
(
sInitPhase
=
=
XPCOMShutdownStarted
)
{
return
NS_ERROR_ABORT
;
}
MOZ_ASSERT
(
!
mDecoders
.
Contains
(
aDecoder
)
)
;
mDecoders
.
PutEntry
(
aDecoder
)
;
DEBUG_SHUTDOWN
(
"
decoder
=
%
p
count
=
%
d
"
aDecoder
mDecoders
.
Count
(
)
)
;
MOZ_ASSERT
(
mDecoders
.
Contains
(
aDecoder
)
)
;
MOZ_ASSERT
(
mDecoders
.
Count
(
)
>
0
)
;
return
NS_OK
;
}
void
MediaShutdownManager
:
:
Unregister
(
MediaDecoder
*
aDecoder
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
mDecoders
.
Contains
(
aDecoder
)
)
{
return
;
}
mDecoders
.
RemoveEntry
(
aDecoder
)
;
DEBUG_SHUTDOWN
(
"
decoder
=
%
p
count
=
%
d
"
aDecoder
mDecoders
.
Count
(
)
)
;
if
(
sInitPhase
=
=
XPCOMShutdownStarted
&
&
mDecoders
.
Count
(
)
=
=
0
)
{
RemoveBlocker
(
)
;
}
}
NS_IMETHODIMP
MediaShutdownManager
:
:
GetName
(
nsAString
&
aName
)
{
aName
=
NS_LITERAL_STRING
(
"
MediaShutdownManager
:
shutdown
"
)
;
return
NS_OK
;
}
NS_IMETHODIMP
MediaShutdownManager
:
:
GetState
(
nsIPropertyBag
*
*
)
{
return
NS_OK
;
}
NS_IMETHODIMP
MediaShutdownManager
:
:
BlockShutdown
(
nsIAsyncShutdownClient
*
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInitPhase
=
=
InitSucceeded
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInstance
)
;
DECODER_LOG
(
LogLevel
:
:
Debug
(
"
MediaShutdownManager
:
:
BlockShutdown
(
)
start
.
.
.
"
)
)
;
sInitPhase
=
XPCOMShutdownStarted
;
auto
oldCount
=
mDecoders
.
Count
(
)
;
if
(
oldCount
=
=
0
)
{
RemoveBlocker
(
)
;
return
NS_OK
;
}
for
(
auto
iter
=
mDecoders
.
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
iter
.
Get
(
)
-
>
GetKey
(
)
-
>
NotifyXPCOMShutdown
(
)
;
MOZ_ASSERT
(
mDecoders
.
Count
(
)
=
=
oldCount
)
;
}
return
NS_OK
;
}
}
#
undef
LOGW
