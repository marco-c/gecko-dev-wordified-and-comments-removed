#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
MediaDecoder
.
h
"
#
include
"
MediaShutdownManager
.
h
"
namespace
mozilla
{
extern
LazyLogModule
gMediaDecoderLog
;
#
define
DECODER_LOG
(
type
msg
)
MOZ_LOG
(
gMediaDecoderLog
type
msg
)
NS_IMPL_ISUPPORTS
(
MediaShutdownManager
nsIAsyncShutdownBlocker
)
MediaShutdownManager
:
:
MediaShutdownManager
(
)
:
mIsObservingShutdown
(
false
)
mIsDoingXPCOMShutDown
(
false
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_COUNT_CTOR
(
MediaShutdownManager
)
;
}
MediaShutdownManager
:
:
~
MediaShutdownManager
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_COUNT_DTOR
(
MediaShutdownManager
)
;
}
StaticRefPtr
<
MediaShutdownManager
>
MediaShutdownManager
:
:
sInstance
;
MediaShutdownManager
&
MediaShutdownManager
:
:
Instance
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
sInstance
)
{
sInstance
=
new
MediaShutdownManager
(
)
;
}
return
*
sInstance
;
}
static
nsCOMPtr
<
nsIAsyncShutdownClient
>
GetShutdownBarrier
(
)
{
nsCOMPtr
<
nsIAsyncShutdownService
>
svc
=
services
:
:
GetAsyncShutdown
(
)
;
MOZ_RELEASE_ASSERT
(
svc
)
;
nsCOMPtr
<
nsIAsyncShutdownClient
>
barrier
;
nsresult
rv
=
svc
-
>
GetProfileBeforeChange
(
getter_AddRefs
(
barrier
)
)
;
if
(
!
barrier
)
{
rv
=
svc
-
>
GetXpcomWillShutdown
(
getter_AddRefs
(
barrier
)
)
;
}
MOZ_RELEASE_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
MOZ_RELEASE_ASSERT
(
barrier
)
;
return
barrier
.
forget
(
)
;
}
void
MediaShutdownManager
:
:
EnsureCorrectShutdownObserverState
(
)
{
bool
needShutdownObserver
=
mDecoders
.
Count
(
)
>
0
;
if
(
needShutdownObserver
!
=
mIsObservingShutdown
)
{
mIsObservingShutdown
=
needShutdownObserver
;
if
(
mIsObservingShutdown
)
{
nsresult
rv
=
GetShutdownBarrier
(
)
-
>
AddBlocker
(
this
NS_LITERAL_STRING
(
__FILE__
)
__LINE__
NS_LITERAL_STRING
(
"
MediaShutdownManager
shutdown
"
)
)
;
MOZ_RELEASE_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
}
else
{
GetShutdownBarrier
(
)
-
>
RemoveBlocker
(
this
)
;
sInstance
=
nullptr
;
DECODER_LOG
(
LogLevel
:
:
Debug
(
"
MediaShutdownManager
:
:
BlockShutdown
(
)
end
.
"
)
)
;
}
}
}
void
MediaShutdownManager
:
:
Register
(
MediaDecoder
*
aDecoder
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
!
mIsDoingXPCOMShutDown
)
;
MOZ_ASSERT
(
!
mDecoders
.
Contains
(
aDecoder
)
)
;
mDecoders
.
PutEntry
(
aDecoder
)
;
MOZ_ASSERT
(
mDecoders
.
Contains
(
aDecoder
)
)
;
MOZ_ASSERT
(
mDecoders
.
Count
(
)
>
0
)
;
EnsureCorrectShutdownObserverState
(
)
;
}
void
MediaShutdownManager
:
:
Unregister
(
MediaDecoder
*
aDecoder
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
mDecoders
.
Contains
(
aDecoder
)
)
;
mDecoders
.
RemoveEntry
(
aDecoder
)
;
EnsureCorrectShutdownObserverState
(
)
;
}
NS_IMETHODIMP
MediaShutdownManager
:
:
GetName
(
nsAString
&
aName
)
{
aName
=
NS_LITERAL_STRING
(
"
MediaShutdownManager
:
shutdown
"
)
;
return
NS_OK
;
}
NS_IMETHODIMP
MediaShutdownManager
:
:
GetState
(
nsIPropertyBag
*
*
)
{
return
NS_OK
;
}
NS_IMETHODIMP
MediaShutdownManager
:
:
BlockShutdown
(
nsIAsyncShutdownClient
*
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
sInstance
)
;
DECODER_LOG
(
LogLevel
:
:
Debug
(
"
MediaShutdownManager
:
:
BlockShutdown
(
)
start
.
.
.
"
)
)
;
mIsDoingXPCOMShutDown
=
true
;
DebugOnly
<
uint32_t
>
oldCount
=
mDecoders
.
Count
(
)
;
MOZ_ASSERT
(
oldCount
>
0
)
;
for
(
auto
iter
=
mDecoders
.
Iter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
MediaDecoderOwner
*
owner
=
iter
.
Get
(
)
-
>
GetKey
(
)
-
>
GetOwner
(
)
;
if
(
owner
)
{
owner
-
>
NotifyXPCOMShutdown
(
)
;
}
MOZ_ASSERT
(
mDecoders
.
Count
(
)
=
=
oldCount
)
;
}
return
NS_OK
;
}
}
