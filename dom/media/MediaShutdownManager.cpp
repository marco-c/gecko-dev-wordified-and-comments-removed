#
include
"
MediaShutdownManager
.
h
"
#
include
"
MediaDecoder
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsIWritablePropertyBag2
.
h
"
namespace
mozilla
{
#
undef
LOGW
extern
LazyLogModule
gMediaDecoderLog
;
#
define
DECODER_LOG
(
type
msg
)
MOZ_LOG
(
gMediaDecoderLog
type
msg
)
#
define
LOGW
(
.
.
.
)
NS_WARNING
(
nsPrintfCString
(
__VA_ARGS__
)
.
get
(
)
)
NS_IMPL_ISUPPORTS
(
MediaShutdownManager
nsIAsyncShutdownBlocker
)
MediaShutdownManager
:
:
MediaShutdownManager
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInitPhase
=
=
NotInited
)
;
}
MediaShutdownManager
:
:
~
MediaShutdownManager
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
StaticRefPtr
<
MediaShutdownManager
>
MediaShutdownManager
:
:
sInstance
;
MediaShutdownManager
:
:
InitPhase
MediaShutdownManager
:
:
sInitPhase
=
MediaShutdownManager
:
:
NotInited
;
MediaShutdownManager
&
MediaShutdownManager
:
:
Instance
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
#
ifdef
MOZ_DIAGNOSTIC_ASSERT_ENABLED
if
(
!
sInstance
)
{
MOZ_CRASH_UNSAFE_PRINTF
(
"
sInstance
is
null
.
sInitPhase
=
%
d
"
int
(
sInitPhase
)
)
;
}
#
endif
return
*
sInstance
;
}
void
MediaShutdownManager
:
:
InitStatics
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
sInitPhase
!
=
NotInited
)
{
return
;
}
sInstance
=
new
MediaShutdownManager
(
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInstance
)
;
nsCOMPtr
<
nsIAsyncShutdownClient
>
barrier
=
media
:
:
GetShutdownBarrier
(
)
;
if
(
!
barrier
)
{
LOGW
(
"
Failed
to
get
barrier
cannot
add
shutdown
blocker
!
"
)
;
sInitPhase
=
InitFailed
;
return
;
}
nsresult
rv
=
barrier
-
>
AddBlocker
(
sInstance
NS_LITERAL_STRING_FROM_CSTRING
(
__FILE__
)
__LINE__
u
"
MediaShutdownManager
shutdown
"
_ns
)
;
if
(
NS_FAILED
(
rv
)
)
{
LOGW
(
"
Failed
to
add
shutdown
blocker
!
rv
=
%
x
"
uint32_t
(
rv
)
)
;
sInitPhase
=
InitFailed
;
return
;
}
sInitPhase
=
InitSucceeded
;
}
void
MediaShutdownManager
:
:
RemoveBlocker
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInitPhase
=
=
XPCOMShutdownStarted
)
;
MOZ_ASSERT
(
mDecoders
.
Count
(
)
=
=
0
)
;
nsCOMPtr
<
nsIAsyncShutdownClient
>
barrier
=
media
:
:
GetShutdownBarrier
(
)
;
MOZ_RELEASE_ASSERT
(
barrier
"
Failed
to
get
shutdown
barrier
cannot
remove
shutdown
blocker
!
"
)
;
barrier
-
>
RemoveBlocker
(
this
)
;
sInitPhase
=
XPCOMShutdownEnded
;
sInstance
=
nullptr
;
DECODER_LOG
(
LogLevel
:
:
Debug
(
"
MediaShutdownManager
:
:
BlockShutdown
(
)
end
.
"
)
)
;
}
nsresult
MediaShutdownManager
:
:
Register
(
MediaDecoder
*
aDecoder
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
sInitPhase
=
=
InitFailed
)
{
return
NS_ERROR_NOT_INITIALIZED
;
}
if
(
sInitPhase
=
=
XPCOMShutdownStarted
)
{
return
NS_ERROR_ABORT
;
}
MOZ_ASSERT
(
!
mDecoders
.
Contains
(
aDecoder
)
)
;
mDecoders
.
Insert
(
aDecoder
)
;
MOZ_ASSERT
(
mDecoders
.
Contains
(
aDecoder
)
)
;
MOZ_ASSERT
(
mDecoders
.
Count
(
)
>
0
)
;
return
NS_OK
;
}
void
MediaShutdownManager
:
:
Unregister
(
MediaDecoder
*
aDecoder
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
!
mDecoders
.
EnsureRemoved
(
aDecoder
)
)
{
return
;
}
if
(
sInitPhase
=
=
XPCOMShutdownStarted
&
&
mDecoders
.
Count
(
)
=
=
0
)
{
RemoveBlocker
(
)
;
}
}
NS_IMETHODIMP
MediaShutdownManager
:
:
GetName
(
nsAString
&
aName
)
{
aName
=
u
"
MediaShutdownManager
:
shutdown
"
_ns
;
return
NS_OK
;
}
NS_IMETHODIMP
MediaShutdownManager
:
:
GetState
(
nsIPropertyBag
*
*
aBagOut
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aBagOut
)
;
nsCOMPtr
<
nsIWritablePropertyBag2
>
propertyBag
=
do_CreateInstance
(
"
mozilla
.
org
/
hash
-
property
-
bag
;
1
"
)
;
if
(
NS_WARN_IF
(
!
propertyBag
)
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
nsresult
rv
=
propertyBag
-
>
SetPropertyAsInt32
(
u
"
sInitPhase
"
_ns
static_cast
<
int32_t
>
(
sInitPhase
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
nsAutoCString
decoderInfo
;
for
(
const
auto
&
key
:
mDecoders
)
{
decoderInfo
.
Append
(
key
-
>
ContainerType
(
)
.
ExtendedType
(
)
.
OriginalString
(
)
)
;
decoderInfo
.
Append
(
"
"
)
;
}
rv
=
propertyBag
-
>
SetPropertyAsACString
(
u
"
decoderInfo
"
_ns
decoderInfo
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
propertyBag
.
forget
(
aBagOut
)
;
return
NS_OK
;
}
NS_IMETHODIMP
MediaShutdownManager
:
:
BlockShutdown
(
nsIAsyncShutdownClient
*
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInitPhase
=
=
InitSucceeded
)
;
MOZ_DIAGNOSTIC_ASSERT
(
sInstance
)
;
DECODER_LOG
(
LogLevel
:
:
Debug
(
"
MediaShutdownManager
:
:
BlockShutdown
(
)
start
.
.
.
"
)
)
;
sInitPhase
=
XPCOMShutdownStarted
;
auto
oldCount
=
mDecoders
.
Count
(
)
;
if
(
oldCount
=
=
0
)
{
RemoveBlocker
(
)
;
return
NS_OK
;
}
for
(
const
auto
&
key
:
mDecoders
)
{
key
-
>
NotifyXPCOMShutdown
(
)
;
MOZ_ASSERT
(
mDecoders
.
Count
(
)
=
=
oldCount
)
;
}
return
NS_OK
;
}
}
#
undef
LOGW
