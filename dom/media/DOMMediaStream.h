#
ifndef
NSDOMMEDIASTREAM_H_
#
define
NSDOMMEDIASTREAM_H_
#
include
"
ImageContainer
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
StreamTracks
.
h
"
#
include
"
nsIDOMWindow
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
MediaTrackConstraints
.
h
"
#
include
"
mozilla
/
DOMEventTargetHelper
.
h
"
#
include
"
mozilla
/
RelativeTimeline
.
h
"
#
include
"
PrincipalChangeObserver
.
h
"
namespace
mozilla
{
class
AbstractThread
;
class
DOMMediaStream
;
class
MediaStream
;
class
MediaInputPort
;
class
MediaStreamGraph
;
class
ProcessedMediaStream
;
enum
class
BlockingMode
;
namespace
dom
{
class
AudioNode
;
class
HTMLCanvasElement
;
class
MediaStreamTrack
;
class
MediaStreamTrackSource
;
class
AudioStreamTrack
;
class
VideoStreamTrack
;
class
AudioTrack
;
class
VideoTrack
;
class
AudioTrackList
;
class
VideoTrackList
;
class
MediaTrackListListener
;
}
namespace
layers
{
class
ImageContainer
;
class
OverlayImage
;
}
#
define
NS_DOMMEDIASTREAM_IID
\
{
\
0x8cb65468
0x66c0
0x444e
{
\
0x89
0x9f
0x89
0x1d
0x9e
0xd2
0xbe
0x7c
\
}
\
}
class
DOMMediaStream
:
public
DOMEventTargetHelper
public
dom
:
:
PrincipalChangeObserver
<
dom
:
:
MediaStreamTrack
>
public
RelativeTimeline
public
SupportsWeakPtr
<
DOMMediaStream
>
{
friend
class
dom
:
:
MediaStreamTrack
;
typedef
dom
:
:
MediaStreamTrack
MediaStreamTrack
;
typedef
dom
:
:
AudioStreamTrack
AudioStreamTrack
;
typedef
dom
:
:
VideoStreamTrack
VideoStreamTrack
;
typedef
dom
:
:
MediaStreamTrackSource
MediaStreamTrackSource
;
typedef
dom
:
:
AudioTrack
AudioTrack
;
typedef
dom
:
:
VideoTrack
VideoTrack
;
typedef
dom
:
:
AudioTrackList
AudioTrackList
;
typedef
dom
:
:
VideoTrackList
VideoTrackList
;
public
:
typedef
dom
:
:
MediaTrackConstraints
MediaTrackConstraints
;
MOZ_DECLARE_WEAKREFERENCE_TYPENAME
(
DOMMediaStream
)
class
TrackListener
{
public
:
virtual
~
TrackListener
(
)
{
}
virtual
void
NotifyTrackAdded
(
const
RefPtr
<
MediaStreamTrack
>
&
aTrack
)
{
}
;
virtual
void
NotifyTrackRemoved
(
const
RefPtr
<
MediaStreamTrack
>
&
aTrack
)
{
}
;
virtual
void
NotifyActive
(
)
{
}
;
virtual
void
NotifyInactive
(
)
{
}
;
}
;
class
TrackPort
{
public
:
NS_INLINE_DECL_CYCLE_COLLECTING_NATIVE_REFCOUNTING
(
TrackPort
)
NS_DECL_CYCLE_COLLECTION_NATIVE_CLASS
(
TrackPort
)
enum
class
InputPortOwnership
{
OWNED
=
1
EXTERNAL
}
;
TrackPort
(
MediaInputPort
*
aInputPort
MediaStreamTrack
*
aTrack
const
InputPortOwnership
aOwnership
)
;
protected
:
virtual
~
TrackPort
(
)
;
public
:
void
DestroyInputPort
(
)
;
MediaStream
*
GetSource
(
)
const
;
TrackID
GetSourceTrackId
(
)
const
;
MediaInputPort
*
GetInputPort
(
)
const
{
return
mInputPort
;
}
MediaStreamTrack
*
GetTrack
(
)
const
{
return
mTrack
;
}
RefPtr
<
GenericPromise
>
BlockSourceTrackId
(
TrackID
aTrackId
BlockingMode
aBlockingMode
)
;
private
:
RefPtr
<
MediaInputPort
>
mInputPort
;
RefPtr
<
MediaStreamTrack
>
mTrack
;
const
InputPortOwnership
mOwnership
;
}
;
explicit
DOMMediaStream
(
nsPIDOMWindowInner
*
aWindow
)
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED
(
DOMMediaStream
DOMEventTargetHelper
)
NS_DECLARE_STATIC_IID_ACCESSOR
(
NS_DOMMEDIASTREAM_IID
)
nsPIDOMWindowInner
*
GetParentObject
(
)
const
{
return
mWindow
;
}
virtual
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
static
already_AddRefed
<
DOMMediaStream
>
Constructor
(
const
dom
:
:
GlobalObject
&
aGlobal
ErrorResult
&
aRv
)
;
static
already_AddRefed
<
DOMMediaStream
>
Constructor
(
const
dom
:
:
GlobalObject
&
aGlobal
const
DOMMediaStream
&
aStream
ErrorResult
&
aRv
)
;
static
already_AddRefed
<
DOMMediaStream
>
Constructor
(
const
dom
:
:
GlobalObject
&
aGlobal
const
dom
:
:
Sequence
<
OwningNonNull
<
MediaStreamTrack
>
>
&
aTracks
ErrorResult
&
aRv
)
;
static
already_AddRefed
<
dom
:
:
Promise
>
CountUnderlyingStreams
(
const
dom
:
:
GlobalObject
&
aGlobal
ErrorResult
&
aRv
)
;
void
GetId
(
nsAString
&
aID
)
const
;
void
GetAudioTracks
(
nsTArray
<
RefPtr
<
AudioStreamTrack
>
>
&
aTracks
)
const
;
void
GetAudioTracks
(
nsTArray
<
RefPtr
<
MediaStreamTrack
>
>
&
aTracks
)
const
;
void
GetVideoTracks
(
nsTArray
<
RefPtr
<
VideoStreamTrack
>
>
&
aTracks
)
const
;
void
GetVideoTracks
(
nsTArray
<
RefPtr
<
MediaStreamTrack
>
>
&
aTracks
)
const
;
void
GetTracks
(
nsTArray
<
RefPtr
<
MediaStreamTrack
>
>
&
aTracks
)
const
;
MediaStreamTrack
*
GetTrackById
(
const
nsAString
&
aId
)
const
;
void
AddTrack
(
MediaStreamTrack
&
aTrack
)
;
void
RemoveTrack
(
MediaStreamTrack
&
aTrack
)
;
already_AddRefed
<
DOMMediaStream
>
Clone
(
)
;
bool
Active
(
)
const
;
IMPL_EVENT_HANDLER
(
addtrack
)
IMPL_EVENT_HANDLER
(
removetrack
)
MediaStreamTrack
*
GetOwnedTrackById
(
const
nsAString
&
aId
)
;
bool
HasTrack
(
const
MediaStreamTrack
&
aTrack
)
const
;
bool
OwnsTrack
(
const
MediaStreamTrack
&
aTrack
)
const
;
MediaStreamTrack
*
FindOwnedDOMTrack
(
MediaStream
*
aInputStream
TrackID
aInputTrackID
TrackID
aTrackID
=
TRACK_ANY
)
const
;
TrackPort
*
FindOwnedTrackPort
(
const
MediaStreamTrack
&
aTrack
)
const
;
MediaStreamTrack
*
FindPlaybackDOMTrack
(
MediaStream
*
aInputStream
TrackID
aInputTrackID
)
const
;
TrackPort
*
FindPlaybackTrackPort
(
const
MediaStreamTrack
&
aTrack
)
const
;
MediaStream
*
GetInputStream
(
)
const
{
return
mInputStream
;
}
ProcessedMediaStream
*
GetOwnedStream
(
)
const
{
return
mOwnedStream
;
}
ProcessedMediaStream
*
GetPlaybackStream
(
)
const
{
return
mPlaybackStream
;
}
virtual
MediaStream
*
GetCameraStream
(
)
const
{
return
nullptr
;
}
bool
IsFinished
(
)
const
;
TrackRate
GraphRate
(
)
;
nsIPrincipal
*
GetPrincipal
(
)
{
return
mPrincipal
;
}
nsIPrincipal
*
GetVideoPrincipal
(
)
{
return
mVideoPrincipal
;
}
void
PrincipalChanged
(
MediaStreamTrack
*
aTrack
)
override
;
bool
AddPrincipalChangeObserver
(
dom
:
:
PrincipalChangeObserver
<
DOMMediaStream
>
*
aObserver
)
;
bool
RemovePrincipalChangeObserver
(
dom
:
:
PrincipalChangeObserver
<
DOMMediaStream
>
*
aObserver
)
;
void
AssignId
(
const
nsAString
&
aID
)
{
mID
=
aID
;
}
static
already_AddRefed
<
DOMMediaStream
>
CreateSourceStreamAsInput
(
nsPIDOMWindowInner
*
aWindow
MediaStreamGraph
*
aGraph
)
;
static
already_AddRefed
<
DOMMediaStream
>
CreateTrackUnionStreamAsInput
(
nsPIDOMWindowInner
*
aWindow
MediaStreamGraph
*
aGraph
)
;
static
already_AddRefed
<
DOMMediaStream
>
CreateAudioCaptureStreamAsInput
(
nsPIDOMWindowInner
*
aWindow
nsIPrincipal
*
aPrincipal
MediaStreamGraph
*
aGraph
)
;
void
AddTrackInternal
(
MediaStreamTrack
*
aTrack
)
;
already_AddRefed
<
MediaStreamTrack
>
CreateDOMTrack
(
TrackID
aTrackID
MediaSegment
:
:
Type
aType
MediaStreamTrackSource
*
aSource
const
MediaTrackConstraints
&
aConstraints
=
MediaTrackConstraints
(
)
)
;
already_AddRefed
<
MediaStreamTrack
>
CloneDOMTrack
(
MediaStreamTrack
&
aTrack
TrackID
aCloneTrackID
)
;
void
AddConsumerToKeepAlive
(
nsISupports
*
aConsumer
)
{
mConsumersToKeepAlive
.
AppendElement
(
aConsumer
)
;
}
void
RegisterTrackListener
(
TrackListener
*
aListener
)
;
void
UnregisterTrackListener
(
TrackListener
*
aListener
)
;
void
SetFinishedOnInactive
(
bool
aFinishedOnInactive
)
;
protected
:
virtual
~
DOMMediaStream
(
)
;
void
Destroy
(
)
;
void
InitSourceStream
(
MediaStreamGraph
*
aGraph
)
;
void
InitTrackUnionStream
(
MediaStreamGraph
*
aGraph
)
;
void
InitAudioCaptureStream
(
nsIPrincipal
*
aPrincipal
MediaStreamGraph
*
aGraph
)
;
void
InitInputStreamCommon
(
MediaStream
*
aStream
MediaStreamGraph
*
aGraph
)
;
void
InitOwnedStreamCommon
(
MediaStreamGraph
*
aGraph
)
;
void
InitPlaybackStreamCommon
(
MediaStreamGraph
*
aGraph
)
;
void
NotifyActive
(
)
;
void
NotifyInactive
(
)
;
void
NotifyTrackAdded
(
const
RefPtr
<
MediaStreamTrack
>
&
aTrack
)
;
void
NotifyTrackRemoved
(
const
RefPtr
<
MediaStreamTrack
>
&
aTrack
)
;
nsresult
DispatchTrackEvent
(
const
nsAString
&
aName
const
RefPtr
<
MediaStreamTrack
>
&
aTrack
)
;
class
PlaybackTrackListener
;
friend
class
PlaybackTrackListener
;
void
BlockPlaybackTrack
(
TrackPort
*
aTrack
)
;
void
NotifyPlaybackTrackBlocked
(
)
;
void
RecomputePrincipal
(
)
;
nsCOMPtr
<
nsPIDOMWindowInner
>
mWindow
;
MediaStream
*
mInputStream
;
ProcessedMediaStream
*
mOwnedStream
;
ProcessedMediaStream
*
mPlaybackStream
;
RefPtr
<
MediaInputPort
>
mOwnedPort
;
RefPtr
<
MediaInputPort
>
mPlaybackPort
;
AutoTArray
<
RefPtr
<
TrackPort
>
2
>
mOwnedTracks
;
AutoTArray
<
RefPtr
<
TrackPort
>
2
>
mTracks
;
size_t
mTracksPendingRemoval
;
RefPtr
<
PlaybackTrackListener
>
mPlaybackTrackListener
;
bool
mTracksCreated
;
nsString
mID
;
nsTArray
<
nsCOMPtr
<
nsISupports
>
>
mConsumersToKeepAlive
;
bool
mNotifiedOfMediaStreamGraphShutdown
;
nsTArray
<
TrackListener
*
>
mTrackListeners
;
bool
mActive
;
bool
mFinishedOnInactive
;
private
:
void
NotifyPrincipalChanged
(
)
;
nsCOMPtr
<
nsIPrincipal
>
mPrincipal
;
nsCOMPtr
<
nsIPrincipal
>
mVideoPrincipal
;
nsTArray
<
dom
:
:
PrincipalChangeObserver
<
DOMMediaStream
>
*
>
mPrincipalChangeObservers
;
CORSMode
mCORSMode
;
}
;
NS_DEFINE_STATIC_IID_ACCESSOR
(
DOMMediaStream
NS_DOMMEDIASTREAM_IID
)
class
DOMAudioNodeMediaStream
:
public
DOMMediaStream
{
typedef
dom
:
:
AudioNode
AudioNode
;
public
:
DOMAudioNodeMediaStream
(
nsPIDOMWindowInner
*
aWindow
AudioNode
*
aNode
)
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED
(
DOMAudioNodeMediaStream
DOMMediaStream
)
static
already_AddRefed
<
DOMAudioNodeMediaStream
>
CreateTrackUnionStreamAsInput
(
nsPIDOMWindowInner
*
aWindow
AudioNode
*
aNode
MediaStreamGraph
*
aGraph
)
;
protected
:
~
DOMAudioNodeMediaStream
(
)
;
private
:
RefPtr
<
AudioNode
>
mStreamNode
;
}
;
}
#
endif
