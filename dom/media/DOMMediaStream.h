#
ifndef
NSDOMMEDIASTREAM_H_
#
define
NSDOMMEDIASTREAM_H_
#
include
"
ImageContainer
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsWrapperCache
.
h
"
#
include
"
StreamBuffer
.
h
"
#
include
"
nsIDOMWindow
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
mozilla
/
PeerIdentity
.
h
"
#
include
"
mozilla
/
DOMEventTargetHelper
.
h
"
#
include
"
mozilla
/
CORSMode
.
h
"
#
ifdef
GetCurrentTime
#
undef
GetCurrentTime
#
endif
#
ifdef
CurrentTime
#
undef
CurrentTime
#
endif
namespace
mozilla
{
class
DOMHwMediaStream
;
class
DOMLocalMediaStream
;
class
MediaStream
;
class
MediaEngineSource
;
class
MediaInputPort
;
class
MediaStreamGraph
;
class
ProcessedMediaStream
;
namespace
dom
{
class
AudioNode
;
class
HTMLCanvasElement
;
class
MediaStreamTrack
;
class
AudioStreamTrack
;
class
VideoStreamTrack
;
class
AudioTrack
;
class
VideoTrack
;
class
AudioTrackList
;
class
VideoTrackList
;
class
MediaTrackListListener
;
struct
MediaTrackConstraints
;
}
namespace
layers
{
class
ImageContainer
;
class
OverlayImage
;
}
class
MediaStreamDirectListener
;
#
define
NS_DOMMEDIASTREAM_IID
\
{
0x8cb65468
0x66c0
0x444e
\
{
0x89
0x9f
0x89
0x1d
0x9e
0xd2
0xbe
0x7c
}
}
class
DOMMediaStream
:
public
DOMEventTargetHelper
{
class
TrackPort
;
friend
class
DOMLocalMediaStream
;
typedef
dom
:
:
MediaStreamTrack
MediaStreamTrack
;
typedef
dom
:
:
AudioStreamTrack
AudioStreamTrack
;
typedef
dom
:
:
VideoStreamTrack
VideoStreamTrack
;
typedef
dom
:
:
AudioTrack
AudioTrack
;
typedef
dom
:
:
VideoTrack
VideoTrack
;
typedef
dom
:
:
AudioTrackList
AudioTrackList
;
typedef
dom
:
:
VideoTrackList
VideoTrackList
;
typedef
dom
:
:
MediaTrackListListener
MediaTrackListListener
;
public
:
typedef
dom
:
:
MediaTrackConstraints
MediaTrackConstraints
;
typedef
uint8_t
TrackTypeHints
;
DOMMediaStream
(
)
;
NS_DECL_ISUPPORTS_INHERITED
NS_REALLY_FORWARD_NSIDOMEVENTTARGET
(
DOMEventTargetHelper
)
NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED
(
DOMMediaStream
DOMEventTargetHelper
)
NS_DECLARE_STATIC_IID_ACCESSOR
(
NS_DOMMEDIASTREAM_IID
)
nsIDOMWindow
*
GetParentObject
(
)
const
{
return
mWindow
;
}
virtual
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
double
CurrentTime
(
)
;
void
GetId
(
nsAString
&
aID
)
const
;
void
GetAudioTracks
(
nsTArray
<
nsRefPtr
<
AudioStreamTrack
>
>
&
aTracks
)
;
void
GetVideoTracks
(
nsTArray
<
nsRefPtr
<
VideoStreamTrack
>
>
&
aTracks
)
;
void
GetTracks
(
nsTArray
<
nsRefPtr
<
MediaStreamTrack
>
>
&
aTracks
)
;
bool
HasTrack
(
const
MediaStreamTrack
&
aTrack
)
const
;
bool
OwnsTrack
(
const
MediaStreamTrack
&
aTrack
)
const
;
MediaStreamTrack
*
FindOwnedDOMTrack
(
MediaStream
*
aOwningStream
TrackID
aTrackID
)
const
;
MediaStreamTrack
*
FindPlaybackDOMTrack
(
MediaStream
*
aOwningStream
TrackID
aTrackID
)
const
;
MediaStream
*
GetInputStream
(
)
const
{
return
mInputStream
;
}
ProcessedMediaStream
*
GetOwnedStream
(
)
const
{
return
mOwnedStream
;
}
ProcessedMediaStream
*
GetPlaybackStream
(
)
const
{
return
mPlaybackStream
;
}
virtual
MediaStream
*
GetCameraStream
(
)
const
{
return
nullptr
;
}
virtual
bool
AddDirectListener
(
MediaStreamDirectListener
*
aListener
)
{
return
false
;
}
virtual
void
RemoveDirectListener
(
MediaStreamDirectListener
*
aListener
)
{
}
virtual
void
SetTrackEnabled
(
TrackID
aTrackID
bool
aEnabled
)
;
virtual
void
StopTrack
(
TrackID
aTrackID
)
;
virtual
already_AddRefed
<
dom
:
:
Promise
>
ApplyConstraintsToTrack
(
TrackID
aTrackID
const
MediaTrackConstraints
&
aConstraints
ErrorResult
&
aRv
)
;
virtual
DOMLocalMediaStream
*
AsDOMLocalMediaStream
(
)
{
return
nullptr
;
}
virtual
DOMHwMediaStream
*
AsDOMHwMediaStream
(
)
{
return
nullptr
;
}
bool
IsFinished
(
)
;
nsIPrincipal
*
GetPrincipal
(
)
{
return
mPrincipal
;
}
mozilla
:
:
CORSMode
GetCORSMode
(
)
;
void
SetCORSMode
(
mozilla
:
:
CORSMode
aCORSMode
)
;
PeerIdentity
*
GetPeerIdentity
(
)
const
{
return
mPeerIdentity
;
}
void
SetPeerIdentity
(
PeerIdentity
*
aPeerIdentity
)
{
mPeerIdentity
=
aPeerIdentity
;
}
bool
CombineWithPrincipal
(
nsIPrincipal
*
aPrincipal
)
;
void
SetPrincipal
(
nsIPrincipal
*
aPrincipal
)
;
class
PrincipalChangeObserver
{
public
:
virtual
void
PrincipalChanged
(
DOMMediaStream
*
aMediaStream
)
=
0
;
}
;
bool
AddPrincipalChangeObserver
(
PrincipalChangeObserver
*
aObserver
)
;
bool
RemovePrincipalChangeObserver
(
PrincipalChangeObserver
*
aObserver
)
;
void
NotifyMediaStreamGraphShutdown
(
)
;
void
NotifyStreamFinished
(
)
;
void
AssignId
(
const
nsAString
&
aID
)
{
mID
=
aID
;
}
static
already_AddRefed
<
DOMMediaStream
>
CreateSourceStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
static
already_AddRefed
<
DOMMediaStream
>
CreateTrackUnionStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
static
already_AddRefed
<
DOMMediaStream
>
CreateAudioCaptureStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
void
SetLogicalStreamStartTime
(
StreamTime
aTime
)
{
mLogicalStreamStartTime
=
aTime
;
}
MediaStreamTrack
*
CreateOwnDOMTrack
(
TrackID
aTrackID
MediaSegment
:
:
Type
aType
)
;
class
OnTracksAvailableCallback
{
public
:
virtual
~
OnTracksAvailableCallback
(
)
{
}
virtual
void
NotifyTracksAvailable
(
DOMMediaStream
*
aStream
)
=
0
;
}
;
void
OnTracksAvailable
(
OnTracksAvailableCallback
*
aCallback
)
;
void
AddConsumerToKeepAlive
(
nsISupports
*
aConsumer
)
{
if
(
!
IsFinished
(
)
&
&
!
mNotifiedOfMediaStreamGraphShutdown
)
{
mConsumersToKeepAlive
.
AppendElement
(
aConsumer
)
;
}
}
void
ConstructMediaTracks
(
AudioTrackList
*
aAudioTrackList
VideoTrackList
*
aVideoTrackList
)
;
void
DisconnectTrackListListeners
(
const
AudioTrackList
*
aAudioTrackList
const
VideoTrackList
*
aVideoTrackList
)
;
virtual
void
NotifyMediaStreamTrackCreated
(
MediaStreamTrack
*
aTrack
)
;
virtual
void
NotifyMediaStreamTrackEnded
(
MediaStreamTrack
*
aTrack
)
;
protected
:
virtual
~
DOMMediaStream
(
)
;
void
Destroy
(
)
;
void
InitSourceStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
void
InitTrackUnionStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
void
InitAudioCaptureStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
void
InitStreamCommon
(
MediaStream
*
aStream
MediaStreamGraph
*
aGraph
)
;
already_AddRefed
<
AudioTrack
>
CreateAudioTrack
(
AudioStreamTrack
*
aStreamTrack
)
;
already_AddRefed
<
VideoTrack
>
CreateVideoTrack
(
VideoStreamTrack
*
aStreamTrack
)
;
void
TracksCreated
(
)
;
void
CheckTracksAvailable
(
)
;
class
PlaybackStreamListener
;
friend
class
PlaybackStreamListener
;
void
CreateAndAddPlaybackStreamListener
(
MediaStream
*
)
;
StreamTime
mLogicalStreamStartTime
;
nsCOMPtr
<
nsIDOMWindow
>
mWindow
;
MediaStream
*
mInputStream
;
ProcessedMediaStream
*
mOwnedStream
;
ProcessedMediaStream
*
mPlaybackStream
;
nsRefPtr
<
MediaInputPort
>
mOwnedPort
;
nsRefPtr
<
MediaInputPort
>
mPlaybackPort
;
nsAutoTArray
<
nsRefPtr
<
TrackPort
>
2
>
mOwnedTracks
;
nsAutoTArray
<
nsRefPtr
<
TrackPort
>
2
>
mTracks
;
nsRefPtr
<
PlaybackStreamListener
>
mListener
;
nsTArray
<
nsAutoPtr
<
OnTracksAvailableCallback
>
>
mRunOnTracksAvailable
;
bool
mTracksCreated
;
nsString
mID
;
nsTArray
<
nsCOMPtr
<
nsISupports
>
>
mConsumersToKeepAlive
;
bool
mNotifiedOfMediaStreamGraphShutdown
;
nsTArray
<
MediaTrackListListener
>
mMediaTrackListListeners
;
private
:
void
NotifyPrincipalChanged
(
)
;
nsCOMPtr
<
nsIPrincipal
>
mPrincipal
;
nsTArray
<
PrincipalChangeObserver
*
>
mPrincipalChangeObservers
;
nsAutoPtr
<
PeerIdentity
>
mPeerIdentity
;
CORSMode
mCORSMode
;
}
;
NS_DEFINE_STATIC_IID_ACCESSOR
(
DOMMediaStream
NS_DOMMEDIASTREAM_IID
)
#
define
NS_DOMLOCALMEDIASTREAM_IID
\
{
0xb1437260
0xec61
0x4dfa
\
{
0x92
0x54
0x04
0x44
0xe2
0xb5
0x94
0x9c
}
}
class
DOMLocalMediaStream
:
public
DOMMediaStream
{
public
:
DOMLocalMediaStream
(
)
{
}
NS_DECL_ISUPPORTS_INHERITED
NS_DECLARE_STATIC_IID_ACCESSOR
(
NS_DOMLOCALMEDIASTREAM_IID
)
virtual
JSObject
*
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
override
;
virtual
void
Stop
(
)
;
virtual
MediaEngineSource
*
GetMediaEngine
(
TrackID
aTrackID
)
{
return
nullptr
;
}
static
already_AddRefed
<
DOMLocalMediaStream
>
CreateSourceStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
static
already_AddRefed
<
DOMLocalMediaStream
>
CreateTrackUnionStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
static
already_AddRefed
<
DOMLocalMediaStream
>
CreateAudioCaptureStream
(
nsIDOMWindow
*
aWindow
MediaStreamGraph
*
aGraph
)
;
protected
:
virtual
~
DOMLocalMediaStream
(
)
;
}
;
NS_DEFINE_STATIC_IID_ACCESSOR
(
DOMLocalMediaStream
NS_DOMLOCALMEDIASTREAM_IID
)
class
DOMAudioNodeMediaStream
:
public
DOMMediaStream
{
typedef
dom
:
:
AudioNode
AudioNode
;
public
:
explicit
DOMAudioNodeMediaStream
(
AudioNode
*
aNode
)
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED
(
DOMAudioNodeMediaStream
DOMMediaStream
)
static
already_AddRefed
<
DOMAudioNodeMediaStream
>
CreateTrackUnionStream
(
nsIDOMWindow
*
aWindow
AudioNode
*
aNode
MediaStreamGraph
*
aGraph
)
;
protected
:
~
DOMAudioNodeMediaStream
(
)
;
private
:
nsRefPtr
<
AudioNode
>
mStreamNode
;
}
;
class
DOMHwMediaStream
:
public
DOMLocalMediaStream
{
typedef
mozilla
:
:
gfx
:
:
IntSize
IntSize
;
typedef
layers
:
:
ImageContainer
ImageContainer
;
#
ifdef
MOZ_WIDGET_GONK
typedef
layers
:
:
OverlayImage
OverlayImage
;
typedef
layers
:
:
OverlayImage
:
:
Data
Data
;
#
endif
public
:
DOMHwMediaStream
(
)
;
static
already_AddRefed
<
DOMHwMediaStream
>
CreateHwStream
(
nsIDOMWindow
*
aWindow
)
;
virtual
DOMHwMediaStream
*
AsDOMHwMediaStream
(
)
override
{
return
this
;
}
int32_t
RequestOverlayId
(
)
;
void
SetOverlayId
(
int32_t
aOverlayId
)
;
void
SetImageSize
(
uint32_t
width
uint32_t
height
)
;
protected
:
~
DOMHwMediaStream
(
)
;
private
:
void
Init
(
MediaStream
*
aStream
)
;
#
ifdef
MOZ_WIDGET_GONK
nsRefPtr
<
ImageContainer
>
mImageContainer
;
const
int
DEFAULT_IMAGE_ID
=
0x01
;
const
int
DEFAULT_IMAGE_WIDTH
=
400
;
const
int
DEFAULT_IMAGE_HEIGHT
=
300
;
nsRefPtr
<
OverlayImage
>
mOverlayImage
;
Data
mImageData
;
#
endif
}
;
}
#
endif
