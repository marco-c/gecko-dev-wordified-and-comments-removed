#
ifndef
FrameStatistics_h_
#
define
FrameStatistics_h_
#
include
"
mozilla
/
ReentrantMonitor
.
h
"
namespace
mozilla
{
struct
FrameStatisticsData
{
uint64_t
mParsedFrames
=
0
;
uint64_t
mDecodedFrames
=
0
;
uint64_t
mPresentedFrames
=
0
;
uint64_t
mDroppedFrames
=
0
;
uint64_t
mInterKeyframeSum_us
=
0
;
size_t
mInterKeyframeCount
=
0
;
uint64_t
mInterKeyFrameMax_us
=
0
;
FrameStatisticsData
(
)
=
default
;
FrameStatisticsData
(
uint64_t
aParsed
uint64_t
aDecoded
uint64_t
aDropped
)
:
mParsedFrames
(
aParsed
)
mDecodedFrames
(
aDecoded
)
mDroppedFrames
(
aDropped
)
{
}
void
Accumulate
(
const
FrameStatisticsData
&
aStats
)
{
mParsedFrames
+
=
aStats
.
mParsedFrames
;
mDecodedFrames
+
=
aStats
.
mDecodedFrames
;
mPresentedFrames
+
=
aStats
.
mPresentedFrames
;
mDroppedFrames
+
=
aStats
.
mDroppedFrames
;
mInterKeyframeSum_us
+
=
aStats
.
mInterKeyframeSum_us
;
mInterKeyframeCount
+
=
aStats
.
mInterKeyframeCount
;
if
(
mInterKeyFrameMax_us
<
aStats
.
mInterKeyFrameMax_us
)
{
mInterKeyFrameMax_us
=
aStats
.
mInterKeyFrameMax_us
;
}
}
}
;
class
FrameStatistics
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
FrameStatistics
)
;
FrameStatistics
(
)
:
mReentrantMonitor
(
"
FrameStats
"
)
{
}
FrameStatisticsData
GetFrameStatisticsData
(
)
const
{
ReentrantMonitorAutoEnter
mon
(
mReentrantMonitor
)
;
return
mFrameStatisticsData
;
}
uint64_t
GetParsedFrames
(
)
const
{
ReentrantMonitorAutoEnter
mon
(
mReentrantMonitor
)
;
return
mFrameStatisticsData
.
mParsedFrames
;
}
uint64_t
GetDecodedFrames
(
)
const
{
ReentrantMonitorAutoEnter
mon
(
mReentrantMonitor
)
;
return
mFrameStatisticsData
.
mDecodedFrames
;
}
uint64_t
GetPresentedFrames
(
)
const
{
ReentrantMonitorAutoEnter
mon
(
mReentrantMonitor
)
;
return
mFrameStatisticsData
.
mPresentedFrames
;
}
uint64_t
GetDroppedFrames
(
)
const
{
ReentrantMonitorAutoEnter
mon
(
mReentrantMonitor
)
;
return
mFrameStatisticsData
.
mDroppedFrames
;
}
void
NotifyDecodedFrames
(
const
FrameStatisticsData
&
aStats
)
{
ReentrantMonitorAutoEnter
mon
(
mReentrantMonitor
)
;
mFrameStatisticsData
.
Accumulate
(
aStats
)
;
}
void
NotifyPresentedFrame
(
)
{
ReentrantMonitorAutoEnter
mon
(
mReentrantMonitor
)
;
+
+
mFrameStatisticsData
.
mPresentedFrames
;
}
private
:
~
FrameStatistics
(
)
{
}
mutable
ReentrantMonitor
mReentrantMonitor
;
FrameStatisticsData
mFrameStatisticsData
;
}
;
}
#
endif
