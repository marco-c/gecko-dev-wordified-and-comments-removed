#
include
"
DecoderTraits
.
h
"
#
include
"
MediaContainerType
.
h
"
#
include
"
MediaDecoder
.
h
"
#
include
"
nsMimeTypes
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
include
"
OggDecoder
.
h
"
#
include
"
OggDemuxer
.
h
"
#
include
"
WebMDecoder
.
h
"
#
include
"
WebMDemuxer
.
h
"
#
ifdef
MOZ_ANDROID_OMX
#
include
"
AndroidMediaDecoder
.
h
"
#
include
"
AndroidMediaReader
.
h
"
#
include
"
AndroidMediaPluginHost
.
h
"
#
endif
#
ifdef
MOZ_DIRECTSHOW
#
include
"
DirectShowDecoder
.
h
"
#
include
"
DirectShowReader
.
h
"
#
endif
#
ifdef
MOZ_FMP4
#
include
"
MP4Decoder
.
h
"
#
include
"
MP4Demuxer
.
h
"
#
endif
#
include
"
MediaFormatReader
.
h
"
#
include
"
MP3Decoder
.
h
"
#
include
"
MP3Demuxer
.
h
"
#
include
"
WaveDecoder
.
h
"
#
include
"
WaveDemuxer
.
h
"
#
include
"
ADTSDecoder
.
h
"
#
include
"
ADTSDemuxer
.
h
"
#
include
"
FlacDecoder
.
h
"
#
include
"
FlacDemuxer
.
h
"
#
include
"
nsPluginHost
.
h
"
#
include
"
MediaPrefs
.
h
"
namespace
mozilla
{
static
bool
IsHttpLiveStreamingType
(
const
MediaContainerType
&
aType
)
{
return
aType
.
Type
(
)
=
=
MEDIAMIMETYPE
(
"
application
/
vnd
.
apple
.
mpegurl
"
)
|
|
aType
.
Type
(
)
=
=
MEDIAMIMETYPE
(
"
application
/
x
-
mpegurl
"
)
|
|
aType
.
Type
(
)
=
=
MEDIAMIMETYPE
(
"
audio
/
x
-
mpegurl
"
)
;
}
#
ifdef
MOZ_ANDROID_OMX
static
bool
IsAndroidMediaType
(
const
MediaContainerType
&
aType
)
{
if
(
!
MediaDecoder
:
:
IsAndroidMediaPluginEnabled
(
)
)
{
return
false
;
}
return
aType
.
Type
(
)
=
=
MEDIAMIMETYPE
(
"
audio
/
mpeg
"
)
|
|
aType
.
Type
(
)
=
=
MEDIAMIMETYPE
(
"
audio
/
mp4
"
)
|
|
aType
.
Type
(
)
=
=
MEDIAMIMETYPE
(
"
video
/
mp4
"
)
|
|
aType
.
Type
(
)
=
=
MEDIAMIMETYPE
(
"
video
/
x
-
m4v
"
)
;
}
#
endif
bool
DecoderTraits
:
:
IsMP4SupportedType
(
const
MediaContainerType
&
aType
DecoderDoctorDiagnostics
*
aDiagnostics
)
{
#
ifdef
MOZ_FMP4
return
MP4Decoder
:
:
IsSupportedType
(
aType
aDiagnostics
)
;
#
else
return
false
;
#
endif
}
static
CanPlayStatus
CanHandleCodecsType
(
const
MediaContainerType
&
aType
DecoderDoctorDiagnostics
*
aDiagnostics
)
{
MOZ_ASSERT
(
aType
.
ExtendedType
(
)
.
HaveCodecs
(
)
)
;
const
MediaContainerType
mimeType
(
aType
.
Type
(
)
)
;
if
(
OggDecoder
:
:
IsSupportedType
(
mimeType
)
)
{
if
(
OggDecoder
:
:
IsSupportedType
(
aType
)
)
{
return
CANPLAY_YES
;
}
return
CANPLAY_NO
;
}
if
(
WaveDecoder
:
:
IsSupportedType
(
MediaContainerType
(
mimeType
)
)
)
{
if
(
WaveDecoder
:
:
IsSupportedType
(
aType
)
)
{
return
CANPLAY_YES
;
}
return
CANPLAY_NO
;
}
#
if
!
defined
(
MOZ_OMX_WEBM_DECODER
)
if
(
WebMDecoder
:
:
IsSupportedType
(
mimeType
)
)
{
if
(
WebMDecoder
:
:
IsSupportedType
(
aType
)
)
{
return
CANPLAY_YES
;
}
return
CANPLAY_NO
;
}
#
endif
#
ifdef
MOZ_FMP4
if
(
MP4Decoder
:
:
IsSupportedType
(
mimeType
nullptr
)
)
{
if
(
MP4Decoder
:
:
IsSupportedType
(
aType
aDiagnostics
)
)
{
return
CANPLAY_YES
;
}
return
CANPLAY_NO
;
}
#
endif
if
(
MP3Decoder
:
:
IsSupportedType
(
aType
)
)
{
return
CANPLAY_YES
;
}
if
(
ADTSDecoder
:
:
IsSupportedType
(
aType
)
)
{
return
CANPLAY_YES
;
}
if
(
FlacDecoder
:
:
IsSupportedType
(
aType
)
)
{
return
CANPLAY_YES
;
}
MediaCodecs
supportedCodecs
;
#
ifdef
MOZ_DIRECTSHOW
DirectShowDecoder
:
:
GetSupportedCodecs
(
aType
&
supportedCodecs
)
;
#
endif
#
ifdef
MOZ_ANDROID_OMX
if
(
MediaDecoder
:
:
IsAndroidMediaPluginEnabled
(
)
)
{
EnsureAndroidMediaPluginHost
(
)
-
>
FindDecoder
(
aType
&
supportedCodecs
)
;
}
#
endif
if
(
supportedCodecs
.
IsEmpty
(
)
)
{
return
CANPLAY_MAYBE
;
}
if
(
!
supportedCodecs
.
ContainsAll
(
aType
.
ExtendedType
(
)
.
Codecs
(
)
)
)
{
return
CANPLAY_NO
;
}
return
CANPLAY_YES
;
}
static
CanPlayStatus
CanHandleMediaType
(
const
MediaContainerType
&
aType
DecoderDoctorDiagnostics
*
aDiagnostics
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
IsHttpLiveStreamingType
(
aType
)
)
{
Telemetry
:
:
Accumulate
(
Telemetry
:
:
MEDIA_HLS_CANPLAY_REQUESTED
true
)
;
}
if
(
aType
.
ExtendedType
(
)
.
HaveCodecs
(
)
)
{
CanPlayStatus
result
=
CanHandleCodecsType
(
aType
aDiagnostics
)
;
if
(
result
=
=
CANPLAY_NO
|
|
result
=
=
CANPLAY_YES
)
{
return
result
;
}
}
const
MediaContainerType
mimeType
(
aType
.
Type
(
)
)
;
if
(
OggDecoder
:
:
IsSupportedType
(
mimeType
)
)
{
return
CANPLAY_MAYBE
;
}
if
(
WaveDecoder
:
:
IsSupportedType
(
mimeType
)
)
{
return
CANPLAY_MAYBE
;
}
#
ifdef
MOZ_FMP4
if
(
MP4Decoder
:
:
IsSupportedType
(
mimeType
aDiagnostics
)
)
{
return
CANPLAY_MAYBE
;
}
#
endif
#
if
!
defined
(
MOZ_OMX_WEBM_DECODER
)
if
(
WebMDecoder
:
:
IsSupportedType
(
mimeType
)
)
{
return
CANPLAY_MAYBE
;
}
#
endif
if
(
MP3Decoder
:
:
IsSupportedType
(
mimeType
)
)
{
return
CANPLAY_MAYBE
;
}
if
(
ADTSDecoder
:
:
IsSupportedType
(
mimeType
)
)
{
return
CANPLAY_MAYBE
;
}
if
(
FlacDecoder
:
:
IsSupportedType
(
mimeType
)
)
{
return
CANPLAY_MAYBE
;
}
#
ifdef
MOZ_DIRECTSHOW
if
(
DirectShowDecoder
:
:
GetSupportedCodecs
(
mimeType
nullptr
)
)
{
return
CANPLAY_MAYBE
;
}
#
endif
#
ifdef
MOZ_ANDROID_OMX
if
(
MediaDecoder
:
:
IsAndroidMediaPluginEnabled
(
)
&
&
EnsureAndroidMediaPluginHost
(
)
-
>
FindDecoder
(
mimeType
nullptr
)
)
{
return
CANPLAY_MAYBE
;
}
#
endif
return
CANPLAY_NO
;
}
CanPlayStatus
DecoderTraits
:
:
CanHandleContainerType
(
const
MediaContainerType
&
aContainerType
DecoderDoctorDiagnostics
*
aDiagnostics
)
{
return
CanHandleMediaType
(
aContainerType
aDiagnostics
)
;
}
bool
DecoderTraits
:
:
ShouldHandleMediaType
(
const
char
*
aMIMEType
DecoderDoctorDiagnostics
*
aDiagnostics
)
{
Maybe
<
MediaContainerType
>
containerType
=
MakeMediaContainerType
(
aMIMEType
)
;
if
(
!
containerType
)
{
return
false
;
}
if
(
WaveDecoder
:
:
IsSupportedType
(
*
containerType
)
)
{
return
false
;
}
if
(
containerType
-
>
Type
(
)
=
=
MEDIAMIMETYPE
(
"
video
/
quicktime
"
)
)
{
RefPtr
<
nsPluginHost
>
pluginHost
=
nsPluginHost
:
:
GetInst
(
)
;
if
(
pluginHost
&
&
pluginHost
-
>
HavePluginForType
(
containerType
-
>
Type
(
)
.
AsString
(
)
)
)
{
return
false
;
}
}
return
CanHandleMediaType
(
*
containerType
aDiagnostics
)
!
=
CANPLAY_NO
;
}
static
already_AddRefed
<
MediaDecoder
>
InstantiateDecoder
(
const
MediaContainerType
&
aType
MediaDecoderOwner
*
aOwner
DecoderDoctorDiagnostics
*
aDiagnostics
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
RefPtr
<
MediaDecoder
>
decoder
;
#
ifdef
MOZ_FMP4
if
(
MP4Decoder
:
:
IsSupportedType
(
aType
aDiagnostics
)
)
{
decoder
=
new
MP4Decoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
#
endif
if
(
MP3Decoder
:
:
IsSupportedType
(
aType
)
)
{
decoder
=
new
MP3Decoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
if
(
ADTSDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoder
=
new
ADTSDecoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
if
(
OggDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoder
=
new
OggDecoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
if
(
WaveDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoder
=
new
WaveDecoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
if
(
FlacDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoder
=
new
FlacDecoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
#
ifdef
MOZ_ANDROID_OMX
if
(
MediaDecoder
:
:
IsAndroidMediaPluginEnabled
(
)
&
&
EnsureAndroidMediaPluginHost
(
)
-
>
FindDecoder
(
aType
nullptr
)
)
{
decoder
=
new
AndroidMediaDecoder
(
aOwner
aType
)
;
return
decoder
.
forget
(
)
;
}
#
endif
if
(
WebMDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoder
=
new
WebMDecoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
#
ifdef
MOZ_DIRECTSHOW
if
(
DirectShowDecoder
:
:
GetSupportedCodecs
(
aType
nullptr
)
)
{
decoder
=
new
DirectShowDecoder
(
aOwner
)
;
return
decoder
.
forget
(
)
;
}
#
endif
if
(
IsHttpLiveStreamingType
(
aType
)
)
{
Telemetry
:
:
Accumulate
(
Telemetry
:
:
MEDIA_HLS_DECODER_SUCCESS
false
)
;
}
return
nullptr
;
}
already_AddRefed
<
MediaDecoder
>
DecoderTraits
:
:
CreateDecoder
(
const
nsACString
&
aType
MediaDecoderOwner
*
aOwner
DecoderDoctorDiagnostics
*
aDiagnostics
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
Maybe
<
MediaContainerType
>
type
=
MakeMediaContainerType
(
aType
)
;
if
(
!
type
)
{
return
nullptr
;
}
return
InstantiateDecoder
(
*
type
aOwner
aDiagnostics
)
;
}
MediaDecoderReader
*
DecoderTraits
:
:
CreateReader
(
const
MediaContainerType
&
aType
AbstractMediaDecoder
*
aDecoder
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MediaDecoderReader
*
decoderReader
=
nullptr
;
if
(
!
aDecoder
)
{
return
decoderReader
;
}
#
ifdef
MOZ_FMP4
if
(
MP4Decoder
:
:
IsSupportedType
(
aType
nullptr
)
)
{
decoderReader
=
new
MediaFormatReader
(
aDecoder
new
MP4Demuxer
(
aDecoder
-
>
GetResource
(
)
)
)
;
}
else
#
endif
if
(
MP3Decoder
:
:
IsSupportedType
(
aType
)
)
{
decoderReader
=
new
MediaFormatReader
(
aDecoder
new
mp3
:
:
MP3Demuxer
(
aDecoder
-
>
GetResource
(
)
)
)
;
}
else
if
(
ADTSDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoderReader
=
new
MediaFormatReader
(
aDecoder
new
ADTSDemuxer
(
aDecoder
-
>
GetResource
(
)
)
)
;
}
else
if
(
WaveDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoderReader
=
new
MediaFormatReader
(
aDecoder
new
WAVDemuxer
(
aDecoder
-
>
GetResource
(
)
)
)
;
}
else
if
(
FlacDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoderReader
=
new
MediaFormatReader
(
aDecoder
new
FlacDemuxer
(
aDecoder
-
>
GetResource
(
)
)
)
;
}
else
if
(
OggDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoderReader
=
new
MediaFormatReader
(
aDecoder
new
OggDemuxer
(
aDecoder
-
>
GetResource
(
)
)
)
;
}
else
#
ifdef
MOZ_ANDROID_OMX
if
(
MediaDecoder
:
:
IsAndroidMediaPluginEnabled
(
)
&
&
EnsureAndroidMediaPluginHost
(
)
-
>
FindDecoder
(
aType
nullptr
)
)
{
decoderReader
=
new
AndroidMediaReader
(
aDecoder
aType
)
;
}
else
#
endif
if
(
WebMDecoder
:
:
IsSupportedType
(
aType
)
)
{
decoderReader
=
new
MediaFormatReader
(
aDecoder
new
WebMDemuxer
(
aDecoder
-
>
GetResource
(
)
)
)
;
}
else
#
ifdef
MOZ_DIRECTSHOW
if
(
DirectShowDecoder
:
:
GetSupportedCodecs
(
aType
nullptr
)
)
{
decoderReader
=
new
DirectShowReader
(
aDecoder
)
;
}
else
#
endif
if
(
false
)
{
}
return
decoderReader
;
}
bool
DecoderTraits
:
:
IsSupportedInVideoDocument
(
const
nsACString
&
aType
)
{
if
(
!
Preferences
:
:
GetBool
(
"
media
.
windows
-
media
-
foundation
.
play
-
stand
-
alone
"
true
)
|
|
!
Preferences
:
:
GetBool
(
"
media
.
play
-
stand
-
alone
"
true
)
)
{
return
false
;
}
Maybe
<
MediaContainerType
>
type
=
MakeMediaContainerType
(
aType
)
;
if
(
!
type
)
{
return
false
;
}
return
OggDecoder
:
:
IsSupportedType
(
*
type
)
|
|
WebMDecoder
:
:
IsSupportedType
(
*
type
)
|
|
#
ifdef
MOZ_ANDROID_OMX
(
MediaDecoder
:
:
IsAndroidMediaPluginEnabled
(
)
&
&
IsAndroidMediaType
(
*
type
)
)
|
|
#
endif
#
ifdef
MOZ_FMP4
MP4Decoder
:
:
IsSupportedType
(
*
type
nullptr
)
|
|
#
endif
MP3Decoder
:
:
IsSupportedType
(
*
type
)
|
|
ADTSDecoder
:
:
IsSupportedType
(
*
type
)
|
|
FlacDecoder
:
:
IsSupportedType
(
*
type
)
|
|
#
ifdef
MOZ_DIRECTSHOW
DirectShowDecoder
:
:
GetSupportedCodecs
(
*
type
nullptr
)
|
|
#
endif
false
;
}
}
