#
if
!
defined
(
OpusDecoder_h_
)
#
define
OpusDecoder_h_
#
include
"
PlatformDecoderModule
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
nsAutoPtr
.
h
"
struct
OpusMSDecoder
;
namespace
mozilla
{
class
OpusParser
;
DDLoggedTypeDeclNameAndBase
(
OpusDataDecoder
MediaDataDecoder
)
;
class
OpusDataDecoder
:
public
MediaDataDecoder
public
DecoderDoctorLifeLogger
<
OpusDataDecoder
>
{
public
:
explicit
OpusDataDecoder
(
const
CreateDecoderParams
&
aParams
)
;
~
OpusDataDecoder
(
)
;
RefPtr
<
InitPromise
>
Init
(
)
override
;
RefPtr
<
DecodePromise
>
Decode
(
MediaRawData
*
aSample
)
override
;
RefPtr
<
DecodePromise
>
Drain
(
)
override
;
RefPtr
<
FlushPromise
>
Flush
(
)
override
;
RefPtr
<
ShutdownPromise
>
Shutdown
(
)
override
;
nsCString
GetDescriptionName
(
)
const
override
{
return
NS_LITERAL_CSTRING
(
"
opus
audio
decoder
"
)
;
}
static
bool
IsOpus
(
const
nsACString
&
aMimeType
)
;
static
void
AppendCodecDelay
(
MediaByteBuffer
*
config
uint64_t
codecDelayUS
)
;
private
:
nsresult
DecodeHeader
(
const
unsigned
char
*
aData
size_t
aLength
)
;
RefPtr
<
DecodePromise
>
ProcessDecode
(
MediaRawData
*
aSample
)
;
const
AudioInfo
&
mInfo
;
const
RefPtr
<
TaskQueue
>
mTaskQueue
;
nsAutoPtr
<
OpusParser
>
mOpusParser
;
OpusMSDecoder
*
mOpusDecoder
;
uint16_t
mSkip
;
bool
mDecodedHeader
;
bool
mPaddingDiscarded
;
int64_t
mFrames
;
Maybe
<
int64_t
>
mLastFrameTime
;
uint8_t
mMappingTable
[
MAX_AUDIO_CHANNELS
]
;
AudioConfig
:
:
ChannelLayout
:
:
ChannelMap
mChannelMap
;
}
;
}
#
endif
