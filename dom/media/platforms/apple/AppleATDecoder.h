#
ifndef
mozilla_AppleATDecoder_h
#
define
mozilla_AppleATDecoder_h
#
include
<
AudioToolbox
/
AudioToolbox
.
h
>
#
include
"
PlatformDecoderModule
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
#
include
"
nsIThread
.
h
"
#
include
"
AudioConverter
.
h
"
namespace
mozilla
{
class
TaskQueue
;
class
AppleATDecoder
:
public
MediaDataDecoder
{
public
:
AppleATDecoder
(
const
AudioInfo
&
aConfig
TaskQueue
*
aTaskQueue
)
;
~
AppleATDecoder
(
)
;
RefPtr
<
InitPromise
>
Init
(
)
override
;
RefPtr
<
DecodePromise
>
Decode
(
MediaRawData
*
aSample
)
override
;
RefPtr
<
DecodePromise
>
Drain
(
)
override
;
RefPtr
<
FlushPromise
>
Flush
(
)
override
;
RefPtr
<
ShutdownPromise
>
Shutdown
(
)
override
;
const
char
*
GetDescriptionName
(
)
const
override
{
return
"
apple
CoreMedia
decoder
"
;
}
const
AudioInfo
&
mConfig
;
nsTArray
<
uint8_t
>
mMagicCookie
;
bool
mFileStreamError
;
const
RefPtr
<
TaskQueue
>
mTaskQueue
;
private
:
AudioConverterRef
mConverter
;
AudioStreamBasicDescription
mOutputFormat
;
UInt32
mFormatID
;
AudioFileStreamID
mStream
;
nsTArray
<
RefPtr
<
MediaRawData
>
>
mQueuedSamples
;
UniquePtr
<
AudioConfig
:
:
ChannelLayout
>
mChannelLayout
;
UniquePtr
<
AudioConverter
>
mAudioConverter
;
DecodedData
mDecodedSamples
;
RefPtr
<
DecodePromise
>
ProcessDecode
(
MediaRawData
*
aSample
)
;
RefPtr
<
FlushPromise
>
ProcessFlush
(
)
;
void
ProcessShutdown
(
)
;
MediaResult
DecodeSample
(
MediaRawData
*
aSample
)
;
MediaResult
GetInputAudioDescription
(
AudioStreamBasicDescription
&
aDesc
const
nsTArray
<
uint8_t
>
&
aExtraData
)
;
MediaResult
SetupDecoder
(
MediaRawData
*
aSample
)
;
nsresult
GetImplicitAACMagicCookie
(
const
MediaRawData
*
aSample
)
;
nsresult
SetupChannelLayout
(
)
;
uint32_t
mParsedFramesForAACMagicCookie
;
bool
mErrored
;
}
;
}
#
endif
