#
include
"
AppleDecoderModule
.
h
"
#
include
<
dlfcn
.
h
>
#
include
"
AppleATDecoder
.
h
"
#
include
"
AppleVTDecoder
.
h
"
#
include
"
MP4Decoder
.
h
"
#
include
"
VPXDecoder
.
h
"
#
include
"
mozilla
/
DebugOnly
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
StaticPrefs_media
.
h
"
extern
"
C
"
{
extern
void
VTRegisterSupplementalVideoDecoderIfAvailable
(
CMVideoCodecType
codecType
)
__attribute__
(
(
weak_import
)
)
;
extern
Boolean
VTIsHardwareDecodeSupported
(
CMVideoCodecType
codecType
)
__attribute__
(
(
weak_import
)
)
;
}
namespace
mozilla
{
bool
AppleDecoderModule
:
:
sInitialized
=
false
;
bool
AppleDecoderModule
:
:
sCanUseVP9Decoder
=
false
;
void
AppleDecoderModule
:
:
Init
(
)
{
if
(
sInitialized
)
{
return
;
}
sInitialized
=
true
;
if
(
RegisterSupplementalVP9Decoder
(
)
)
{
sCanUseVP9Decoder
=
CanCreateVP9Decoder
(
)
;
}
}
nsresult
AppleDecoderModule
:
:
Startup
(
)
{
if
(
!
sInitialized
)
{
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
already_AddRefed
<
MediaDataDecoder
>
AppleDecoderModule
:
:
CreateVideoDecoder
(
const
CreateDecoderParams
&
aParams
)
{
if
(
Supports
(
SupportDecoderParams
(
aParams
)
nullptr
)
=
=
media
:
:
DecodeSupport
:
:
Unsupported
)
{
return
nullptr
;
}
RefPtr
<
MediaDataDecoder
>
decoder
;
if
(
IsVideoSupported
(
aParams
.
VideoConfig
(
)
aParams
.
mOptions
)
)
{
decoder
=
new
AppleVTDecoder
(
aParams
.
VideoConfig
(
)
aParams
.
mImageContainer
aParams
.
mOptions
aParams
.
mKnowsCompositor
)
;
}
return
decoder
.
forget
(
)
;
}
already_AddRefed
<
MediaDataDecoder
>
AppleDecoderModule
:
:
CreateAudioDecoder
(
const
CreateDecoderParams
&
aParams
)
{
if
(
Supports
(
SupportDecoderParams
(
aParams
)
nullptr
)
=
=
media
:
:
DecodeSupport
:
:
Unsupported
)
{
return
nullptr
;
}
RefPtr
<
MediaDataDecoder
>
decoder
=
new
AppleATDecoder
(
aParams
.
AudioConfig
(
)
)
;
return
decoder
.
forget
(
)
;
}
media
:
:
DecodeSupportSet
AppleDecoderModule
:
:
SupportsMimeType
(
const
nsACString
&
aMimeType
DecoderDoctorDiagnostics
*
aDiagnostics
)
const
{
bool
supports
=
(
aMimeType
.
EqualsLiteral
(
"
audio
/
mpeg
"
)
&
&
!
StaticPrefs
:
:
media_ffvpx_mp3_enabled
(
)
)
|
|
aMimeType
.
EqualsLiteral
(
"
audio
/
mp4a
-
latm
"
)
|
|
MP4Decoder
:
:
IsH264
(
aMimeType
)
|
|
VPXDecoder
:
:
IsVP9
(
aMimeType
)
;
MOZ_LOG
(
sPDMLog
LogLevel
:
:
Debug
(
"
Apple
decoder
%
s
requested
type
'
%
s
'
"
supports
?
"
supports
"
:
"
rejects
"
aMimeType
.
BeginReading
(
)
)
)
;
if
(
supports
)
{
return
media
:
:
DecodeSupport
:
:
SoftwareDecode
;
}
return
media
:
:
DecodeSupport
:
:
Unsupported
;
}
media
:
:
DecodeSupportSet
AppleDecoderModule
:
:
Supports
(
const
SupportDecoderParams
&
aParams
DecoderDoctorDiagnostics
*
aDiagnostics
)
const
{
const
auto
&
trackInfo
=
aParams
.
mConfig
;
if
(
trackInfo
.
IsAudio
(
)
)
{
return
SupportsMimeType
(
trackInfo
.
mMimeType
aDiagnostics
)
;
}
bool
supports
=
trackInfo
.
GetAsVideoInfo
(
)
&
&
IsVideoSupported
(
*
trackInfo
.
GetAsVideoInfo
(
)
)
;
if
(
supports
)
{
return
media
:
:
DecodeSupport
:
:
SoftwareDecode
;
}
return
media
:
:
DecodeSupport
:
:
Unsupported
;
}
bool
AppleDecoderModule
:
:
IsVideoSupported
(
const
VideoInfo
&
aConfig
const
CreateDecoderParams
:
:
OptionSet
&
aOptions
)
const
{
if
(
MP4Decoder
:
:
IsH264
(
aConfig
.
mMimeType
)
)
{
return
true
;
}
if
(
!
VPXDecoder
:
:
IsVP9
(
aConfig
.
mMimeType
)
|
|
!
sCanUseVP9Decoder
|
|
aOptions
.
contains
(
CreateDecoderParams
:
:
Option
:
:
HardwareDecoderNotAllowed
)
)
{
return
false
;
}
if
(
aConfig
.
HasAlpha
(
)
)
{
return
false
;
}
if
(
aConfig
.
mColorDepth
!
=
gfx
:
:
ColorDepth
:
:
COLOR_8
&
&
aConfig
.
mColorDepth
!
=
gfx
:
:
ColorDepth
:
:
COLOR_10
)
{
return
false
;
}
if
(
aConfig
.
mExtraData
&
&
aConfig
.
mExtraData
-
>
Length
(
)
<
5
)
{
return
true
;
}
int
profile
=
aConfig
.
mExtraData
-
>
ElementAt
(
4
)
;
if
(
profile
!
=
0
&
&
profile
!
=
2
)
{
return
false
;
}
return
true
;
}
bool
AppleDecoderModule
:
:
CanCreateVP9Decoder
(
)
{
if
(
__builtin_available
(
macOS
10
.
13
*
)
)
{
if
(
!
VTIsHardwareDecodeSupported
|
|
!
VTIsHardwareDecodeSupported
(
kCMVideoCodecType_VP9
)
)
{
return
false
;
}
VideoInfo
info
(
1920
1080
)
;
info
.
mMimeType
=
"
video
/
vp9
"
;
VPXDecoder
:
:
GetVPCCBox
(
info
.
mExtraData
VPXDecoder
:
:
VPXStreamInfo
(
)
)
;
RefPtr
<
AppleVTDecoder
>
decoder
=
new
AppleVTDecoder
(
info
nullptr
{
}
nullptr
)
;
MediaResult
rv
=
decoder
-
>
InitializeSession
(
)
;
decoder
-
>
Shutdown
(
)
;
return
NS_SUCCEEDED
(
rv
)
;
}
return
false
;
}
bool
AppleDecoderModule
:
:
RegisterSupplementalVP9Decoder
(
)
{
static
bool
sRegisterIfAvailable
=
[
]
(
)
{
#
if
!
defined
(
MAC_OS_VERSION_11_0
)
|
|
\
MAC_OS_X_VERSION_MAX_ALLOWED
<
MAC_OS_VERSION_11_0
if
(
nsCocoaFeatures
:
:
OnBigSurOrLater
(
)
)
{
#
else
if
(
__builtin_available
(
macos
11
.
0
*
)
)
{
#
endif
VTRegisterSupplementalVideoDecoderIfAvailable
(
kCMVideoCodecType_VP9
)
;
return
true
;
}
return
false
;
}
(
)
;
return
sRegisterIfAvailable
;
}
already_AddRefed
<
PlatformDecoderModule
>
AppleDecoderModule
:
:
Create
(
)
{
return
MakeAndAddRef
<
AppleDecoderModule
>
(
)
;
}
}
