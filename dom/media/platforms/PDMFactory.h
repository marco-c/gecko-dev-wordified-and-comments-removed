#
if
!
defined
(
PDMFactory_h_
)
#
define
PDMFactory_h_
#
include
<
utility
>
#
include
"
DecoderDoctorDiagnostics
.
h
"
#
include
"
mozilla
/
AlreadyAddRefed
.
h
"
#
include
"
mozilla
/
EnumSet
.
h
"
#
include
"
mozilla
/
MozPromise
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsISupports
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsTArray
.
h
"
namespace
mozilla
{
class
CDMProxy
;
class
MediaDataDecoder
;
class
MediaResult
;
class
PDMFactoryImpl
;
class
PlatformDecoderModule
;
class
StaticMutex
;
template
<
typename
T
>
struct
MaxEnumValue
;
template
<
class
T
>
class
StaticAutoPtr
;
struct
CreateDecoderParams
;
struct
CreateDecoderParamsForAsync
;
struct
SupportDecoderParams
;
enum
class
RemoteDecodeIn
;
using
PDMCreateDecoderPromise
=
MozPromise
<
RefPtr
<
MediaDataDecoder
>
MediaResult
true
>
;
class
PDMFactory
final
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
PDMFactory
)
PDMFactory
(
)
;
static
already_AddRefed
<
PDMFactory
>
PDMFactoryForRdd
(
)
;
static
already_AddRefed
<
PDMFactory
>
PDMFactoryForGpu
(
)
;
RefPtr
<
PDMCreateDecoderPromise
>
CreateDecoder
(
const
CreateDecoderParams
&
aParams
)
;
bool
SupportsMimeType
(
const
nsACString
&
aMimeType
DecoderDoctorDiagnostics
*
aDiagnostics
)
const
;
bool
Supports
(
const
SupportDecoderParams
&
aParams
DecoderDoctorDiagnostics
*
aDiagnostics
)
const
;
void
SetCDMProxy
(
CDMProxy
*
aProxy
)
;
static
constexpr
int
kYUV400
=
0
;
static
constexpr
int
kYUV420
=
1
;
static
constexpr
int
kYUV422
=
2
;
static
constexpr
int
kYUV444
=
3
;
enum
class
MediaCodecs
{
H264
VP9
VP8
AV1
Theora
AAC
MP3
Opus
Vorbis
Flac
Wave
SENTINEL
}
;
using
MediaCodecsSupported
=
EnumSet
<
MediaCodecs
>
;
static
MediaCodecsSupported
Supported
(
)
;
static
void
SetSupported
(
const
MediaCodecsSupported
&
aSupported
)
;
private
:
virtual
~
PDMFactory
(
)
;
explicit
PDMFactory
(
const
RemoteDecodeIn
&
aProcess
)
;
void
CreatePDMs
(
)
;
void
CreateNullPDM
(
)
;
void
CreateGpuPDMs
(
)
;
void
CreateRddPDMs
(
)
;
void
CreateContentPDMs
(
)
;
void
CreateDefaultPDMs
(
)
;
template
<
typename
DECODER_MODULE
typename
.
.
.
ARGS
>
bool
CreateAndStartupPDM
(
ARGS
&
&
.
.
.
aArgs
)
{
return
StartupPDM
(
DECODER_MODULE
:
:
Create
(
std
:
:
forward
<
ARGS
>
(
aArgs
)
.
.
.
)
)
;
}
bool
StartupPDM
(
already_AddRefed
<
PlatformDecoderModule
>
aPDM
bool
aInsertAtBeginning
=
false
)
;
already_AddRefed
<
PlatformDecoderModule
>
GetDecoderModule
(
const
SupportDecoderParams
&
aParams
DecoderDoctorDiagnostics
*
aDiagnostics
)
const
;
RefPtr
<
PDMCreateDecoderPromise
>
CreateDecoderWithPDM
(
PlatformDecoderModule
*
aPDM
const
CreateDecoderParams
&
aParams
)
;
RefPtr
<
PDMCreateDecoderPromise
>
CheckAndMaybeCreateDecoder
(
CreateDecoderParamsForAsync
&
&
aParams
uint32_t
aIndex
)
;
nsTArray
<
RefPtr
<
PlatformDecoderModule
>
>
mCurrentPDMs
;
RefPtr
<
PlatformDecoderModule
>
mEMEPDM
;
RefPtr
<
PlatformDecoderModule
>
mNullPDM
;
DecoderDoctorDiagnostics
:
:
FlagsSet
mFailureFlags
;
friend
class
RemoteVideoDecoderParent
;
static
void
EnsureInit
(
)
;
template
<
class
T
>
friend
class
StaticAutoPtr
;
static
StaticAutoPtr
<
PDMFactoryImpl
>
sInstance
;
static
StaticMutex
sMonitor
;
}
;
template
<
>
struct
MaxEnumValue
<
PDMFactory
:
:
MediaCodecs
>
{
static
constexpr
unsigned
int
value
=
static_cast
<
unsigned
int
>
(
PDMFactory
:
:
MediaCodecs
:
:
SENTINEL
)
;
}
;
}
#
endif
