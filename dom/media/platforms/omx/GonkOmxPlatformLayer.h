#
if
!
defined
(
GonkOmxPlatformLayer_h_
)
#
define
GonkOmxPlatformLayer_h_
#
pragma
GCC
visibility
push
(
default
)
#
include
<
bitset
>
#
include
<
utils
/
RefBase
.
h
>
#
include
<
media
/
stagefright
/
OMXClient
.
h
>
#
include
"
OMX_Component
.
h
"
#
include
"
OmxPlatformLayer
.
h
"
class
nsACString
;
namespace
android
{
class
IMemory
;
class
MemoryDealer
;
}
namespace
mozilla
{
class
GonkOmxObserver
;
class
GonkOmxPlatformLayer
;
class
GonkTextureClientRecycleHandler
;
class
GonkBufferData
:
public
OmxPromiseLayer
:
:
BufferData
{
protected
:
virtual
~
GonkBufferData
(
)
{
}
public
:
GonkBufferData
(
bool
aLiveInLocal
GonkOmxPlatformLayer
*
aLayer
)
;
BufferID
ID
(
)
override
{
return
mId
;
}
already_AddRefed
<
MediaData
>
GetPlatformMediaData
(
)
override
;
bool
IsLocalBuffer
(
)
{
return
!
!
mMirrorBuffer
.
get
(
)
;
}
void
ReleaseBuffer
(
)
;
nsresult
SetBufferId
(
android
:
:
IOMX
:
:
buffer_id
aId
)
{
mId
=
aId
;
return
NS_OK
;
}
nsresult
InitLocalBuffer
(
android
:
:
IOMX
:
:
buffer_id
aId
)
;
nsresult
InitSharedMemory
(
android
:
:
IMemory
*
aMemory
)
;
nsresult
InitGraphicBuffer
(
OMX_VIDEO_PORTDEFINITIONTYPE
&
aDef
)
;
android
:
:
IOMX
:
:
buffer_id
mId
;
nsAutoPtr
<
OMX_BUFFERHEADERTYPE
>
mMirrorBuffer
;
RefPtr
<
GonkTextureClientRecycleHandler
>
mTextureClientRecycleHandler
;
GonkOmxPlatformLayer
*
mGonkPlatformLayer
;
}
;
class
GonkOmxPlatformLayer
:
public
OmxPlatformLayer
{
public
:
enum
{
kRequiresAllocateBufferOnInputPorts
=
0
kRequiresAllocateBufferOnOutputPorts
QUIRKS
}
;
typedef
std
:
:
bitset
<
QUIRKS
>
Quirks
;
struct
ComponentInfo
{
const
char
*
mName
;
Quirks
mQuirks
;
}
;
GonkOmxPlatformLayer
(
OmxDataDecoder
*
aDataDecoder
OmxPromiseLayer
*
aPromiseLayer
TaskQueue
*
aTaskQueue
layers
:
:
ImageContainer
*
aImageContainer
)
;
nsresult
AllocateOmxBuffer
(
OMX_DIRTYPE
aType
BUFFERLIST
*
aBufferList
)
override
;
nsresult
ReleaseOmxBuffer
(
OMX_DIRTYPE
aType
BUFFERLIST
*
aBufferList
)
override
;
OMX_ERRORTYPE
GetState
(
OMX_STATETYPE
*
aType
)
override
;
OMX_ERRORTYPE
GetParameter
(
OMX_INDEXTYPE
aParamIndex
OMX_PTR
aComponentParameterStructure
OMX_U32
aComponentParameterSize
)
override
;
OMX_ERRORTYPE
SetParameter
(
OMX_INDEXTYPE
nIndex
OMX_PTR
aComponentParameterStructure
OMX_U32
aComponentParameterSize
)
override
;
OMX_ERRORTYPE
InitOmxToStateLoaded
(
const
TrackInfo
*
aInfo
)
override
;
OMX_ERRORTYPE
EmptyThisBuffer
(
BufferData
*
aData
)
override
;
OMX_ERRORTYPE
FillThisBuffer
(
BufferData
*
aData
)
override
;
OMX_ERRORTYPE
SendCommand
(
OMX_COMMANDTYPE
aCmd
OMX_U32
aParam1
OMX_PTR
aCmdData
)
override
;
nsresult
Shutdown
(
)
override
;
template
<
class
T
>
void
InitOmxParameter
(
T
*
aParam
)
;
static
bool
FindComponents
(
const
nsACString
&
aMimeType
nsTArray
<
ComponentInfo
>
*
aComponents
=
nullptr
)
;
protected
:
friend
GonkBufferData
;
layers
:
:
ImageContainer
*
GetImageContainer
(
)
;
const
TrackInfo
*
GetTrackInfo
(
)
;
TaskQueue
*
GetTaskQueue
(
)
{
return
mTaskQueue
;
}
nsresult
EnableOmxGraphicBufferPort
(
OMX_PARAM_PORTDEFINITIONTYPE
&
aDef
)
;
bool
LoadComponent
(
const
ComponentInfo
&
aComponent
)
;
friend
class
GonkOmxObserver
;
RefPtr
<
TaskQueue
>
mTaskQueue
;
RefPtr
<
layers
:
:
ImageContainer
>
mImageContainer
;
android
:
:
sp
<
android
:
:
MemoryDealer
>
mMemoryDealer
[
2
]
;
android
:
:
sp
<
GonkOmxObserver
>
mOmxObserver
;
android
:
:
sp
<
android
:
:
IOMX
>
mOmx
;
android
:
:
IOMX
:
:
node_id
mNode
;
android
:
:
OMXClient
mOmxClient
;
const
TrackInfo
*
mInfo
;
Quirks
mQuirks
;
}
;
}
#
pragma
GCC
visibility
pop
#
endif
