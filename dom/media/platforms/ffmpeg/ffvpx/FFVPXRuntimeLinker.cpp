#
include
"
FFVPXRuntimeLinker
.
h
"
#
include
"
FFmpegLibWrapper
.
h
"
#
include
"
FFmpegLog
.
h
"
#
include
"
nsIFile
.
h
"
#
include
"
prmem
.
h
"
#
include
"
prlink
.
h
"
#
include
"
soundtouch
/
SoundTouch
.
h
"
namespace
mozilla
{
template
<
int
V
>
class
FFmpegDecoderModule
{
public
:
static
already_AddRefed
<
PlatformDecoderModule
>
Create
(
FFmpegLibWrapper
*
)
;
}
;
static
FFmpegLibWrapper
sFFVPXLib
;
FFVPXRuntimeLinker
:
:
LinkStatus
FFVPXRuntimeLinker
:
:
sLinkStatus
=
LinkStatus_INIT
;
static
PRLibrary
*
MozAVLink
(
const
char
*
aName
)
{
PRLibSpec
lspec
;
lspec
.
type
=
PR_LibSpec_Pathname
;
lspec
.
value
.
pathname
=
aName
;
PRLibrary
*
lib
=
PR_LoadLibraryWithFlags
(
lspec
PR_LD_NOW
|
PR_LD_LOCAL
)
;
if
(
!
lib
)
{
FFMPEG_LOG
(
"
unable
to
load
library
%
s
"
aName
)
;
}
return
lib
;
}
bool
FFVPXRuntimeLinker
:
:
Init
(
)
{
if
(
sLinkStatus
)
{
return
sLinkStatus
=
=
LinkStatus_SUCCEEDED
;
}
sLinkStatus
=
LinkStatus_FAILED
;
char
*
lgpllibsname
=
PR_GetLibraryName
(
nullptr
"
lgpllibs
"
)
;
if
(
!
lgpllibsname
)
{
return
false
;
}
char
*
path
=
PR_GetLibraryFilePathname
(
lgpllibsname
(
PRFuncPtr
)
&
soundtouch
:
:
SoundTouch
:
:
getVersionId
)
;
PR_FreeLibraryName
(
lgpllibsname
)
;
if
(
!
path
)
{
return
false
;
}
nsCOMPtr
<
nsIFile
>
xulFile
=
do_CreateInstance
(
NS_LOCAL_FILE_CONTRACTID
)
;
if
(
!
xulFile
|
|
NS_FAILED
(
xulFile
-
>
InitWithNativePath
(
nsDependentCString
(
path
)
)
)
)
{
PR_Free
(
path
)
;
return
false
;
}
PR_Free
(
path
)
;
nsCOMPtr
<
nsIFile
>
rootDir
;
if
(
NS_FAILED
(
xulFile
-
>
GetParent
(
getter_AddRefs
(
rootDir
)
)
)
|
|
!
rootDir
)
{
return
false
;
}
nsAutoCString
rootPath
;
if
(
NS_FAILED
(
rootDir
-
>
GetNativePath
(
rootPath
)
)
)
{
return
false
;
}
char
*
libname
=
NULL
;
libname
=
PR_GetLibraryName
(
rootPath
.
get
(
)
"
mozavutil
"
)
;
if
(
!
libname
)
{
return
false
;
}
sFFVPXLib
.
mAVUtilLib
=
MozAVLink
(
libname
)
;
PR_FreeLibraryName
(
libname
)
;
libname
=
PR_GetLibraryName
(
rootPath
.
get
(
)
"
mozavcodec
"
)
;
if
(
libname
)
{
sFFVPXLib
.
mAVCodecLib
=
MozAVLink
(
libname
)
;
PR_FreeLibraryName
(
libname
)
;
}
if
(
sFFVPXLib
.
Link
(
)
=
=
FFmpegLibWrapper
:
:
LinkResult
:
:
Success
)
{
sLinkStatus
=
LinkStatus_SUCCEEDED
;
return
true
;
}
return
false
;
}
already_AddRefed
<
PlatformDecoderModule
>
FFVPXRuntimeLinker
:
:
CreateDecoderModule
(
)
{
if
(
!
Init
(
)
)
{
return
nullptr
;
}
return
FFmpegDecoderModule
<
FFVPX_VERSION
>
:
:
Create
(
&
sFFVPXLib
)
;
}
}
