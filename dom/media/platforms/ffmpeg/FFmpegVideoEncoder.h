#
ifndef
DOM_MEDIA_PLATFORMS_FFMPEG_FFMPEGVIDEOENCODER_H_
#
define
DOM_MEDIA_PLATFORMS_FFMPEG_FFMPEGVIDEOENCODER_H_
#
include
"
FFmpegLibWrapper
.
h
"
#
include
"
PlatformEncoderModule
.
h
"
#
include
"
mozilla
/
ThreadSafety
.
h
"
#
include
"
FFmpegLibs
.
h
"
namespace
mozilla
{
template
<
int
V
>
AVCodecID
GetFFmpegEncoderCodecId
(
CodecType
aCodec
)
;
template
<
>
AVCodecID
GetFFmpegEncoderCodecId
<
LIBAV_VER
>
(
CodecType
aCodec
)
;
template
<
int
V
>
class
FFmpegVideoEncoder
:
public
MediaDataEncoder
{
}
;
template
<
>
class
FFmpegVideoEncoder
<
LIBAV_VER
>
final
:
public
MediaDataEncoder
{
public
:
FFmpegVideoEncoder
(
const
FFmpegLibWrapper
*
aLib
AVCodecID
aCodecID
const
RefPtr
<
TaskQueue
>
&
aTaskQueue
const
EncoderConfig
&
aConfig
)
;
RefPtr
<
InitPromise
>
Init
(
)
override
;
RefPtr
<
EncodePromise
>
Encode
(
const
MediaData
*
aSample
)
override
;
RefPtr
<
ReconfigurationPromise
>
Reconfigure
(
const
RefPtr
<
const
EncoderConfigurationChangeList
>
&
aConfigurationChanges
)
override
;
RefPtr
<
EncodePromise
>
Drain
(
)
override
;
RefPtr
<
ShutdownPromise
>
Shutdown
(
)
override
;
RefPtr
<
GenericPromise
>
SetBitrate
(
uint32_t
aBitRate
)
override
;
nsCString
GetDescriptionName
(
)
const
override
;
private
:
~
FFmpegVideoEncoder
(
)
=
default
;
RefPtr
<
InitPromise
>
ProcessInit
(
)
;
RefPtr
<
EncodePromise
>
ProcessEncode
(
RefPtr
<
const
MediaData
>
aSample
)
;
RefPtr
<
ReconfigurationPromise
>
ProcessReconfigure
(
const
RefPtr
<
const
EncoderConfigurationChangeList
>
aConfigurationChanges
)
;
RefPtr
<
EncodePromise
>
ProcessDrain
(
)
;
RefPtr
<
ShutdownPromise
>
ProcessShutdown
(
)
;
MediaResult
InitInternal
(
)
;
void
ShutdownInternal
(
)
;
int
OpenCodecContext
(
const
AVCodec
*
aCodec
AVDictionary
*
*
aOptions
)
MOZ_EXCLUDES
(
sMutex
)
;
void
CloseCodecContext
(
)
MOZ_EXCLUDES
(
sMutex
)
;
bool
PrepareFrame
(
)
;
void
DestroyFrame
(
)
;
bool
ScaleInputFrame
(
)
;
#
if
LIBAVCODEC_VERSION_MAJOR
>
=
58
RefPtr
<
EncodePromise
>
EncodeWithModernAPIs
(
RefPtr
<
const
VideoData
>
aSample
)
;
RefPtr
<
EncodePromise
>
DrainWithModernAPIs
(
)
;
#
endif
RefPtr
<
MediaRawData
>
ToMediaRawData
(
AVPacket
*
aPacket
)
;
Result
<
already_AddRefed
<
MediaByteBuffer
>
nsresult
>
GetExtraData
(
AVPacket
*
aPacket
)
;
void
ForceEnablingFFmpegDebugLogs
(
)
;
const
FFmpegLibWrapper
*
mLib
;
const
AVCodecID
mCodecID
;
const
RefPtr
<
TaskQueue
>
mTaskQueue
;
EncoderConfig
mConfig
;
nsCString
mCodecName
;
AVCodecContext
*
mCodecContext
;
AVFrame
*
mFrame
;
static
StaticMutex
sMutex
;
}
;
}
#
endif
