#
ifndef
__FFmpegDataDecoder_h__
#
define
__FFmpegDataDecoder_h__
#
include
"
PlatformDecoderModule
.
h
"
#
include
"
FFmpegLibs
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
namespace
mozilla
{
template
<
int
V
>
class
FFmpegDataDecoder
:
public
MediaDataDecoder
{
}
;
template
<
>
class
FFmpegDataDecoder
<
LIBAV_VER
>
:
public
MediaDataDecoder
{
public
:
FFmpegDataDecoder
(
FlushableTaskQueue
*
aTaskQueue
MediaDataDecoderCallback
*
aCallback
AVCodecID
aCodecID
)
;
virtual
~
FFmpegDataDecoder
(
)
;
static
bool
Link
(
)
;
RefPtr
<
InitPromise
>
Init
(
)
override
=
0
;
nsresult
Input
(
MediaRawData
*
aSample
)
override
=
0
;
nsresult
Flush
(
)
override
;
nsresult
Drain
(
)
override
;
nsresult
Shutdown
(
)
override
;
static
AVCodec
*
FindAVCodec
(
AVCodecID
aCodec
)
;
protected
:
virtual
void
ProcessFlush
(
)
;
virtual
void
ProcessDrain
(
)
=
0
;
virtual
void
ProcessShutdown
(
)
;
AVFrame
*
PrepareFrame
(
)
;
nsresult
InitDecoder
(
)
;
RefPtr
<
FlushableTaskQueue
>
mTaskQueue
;
MediaDataDecoderCallback
*
mCallback
;
AVCodecContext
*
mCodecContext
;
AVFrame
*
mFrame
;
RefPtr
<
MediaByteBuffer
>
mExtraData
;
AVCodecID
mCodecID
;
Monitor
mMonitor
;
Atomic
<
bool
>
mIsFlushing
;
AVCodecParserContext
*
mCodecParser
;
class
PtsCorrectionContext
{
public
:
PtsCorrectionContext
(
)
;
int64_t
GuessCorrectPts
(
int64_t
aPts
int64_t
aDts
)
;
void
Reset
(
)
;
private
:
int64_t
mNumFaultyPts
;
int64_t
mNumFaultyDts
;
int64_t
mLastPts
;
int64_t
mLastDts
;
}
;
PtsCorrectionContext
mPtsContext
;
private
:
static
bool
sFFmpegInitDone
;
static
StaticMutex
sMonitor
;
}
;
}
#
endif
