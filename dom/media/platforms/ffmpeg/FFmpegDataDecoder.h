#
ifndef
__FFmpegDataDecoder_h__
#
define
__FFmpegDataDecoder_h__
#
include
"
PlatformDecoderModule
.
h
"
#
include
"
FFmpegLibWrapper
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
#
include
"
FFmpegLibs
.
h
"
namespace
mozilla
{
template
<
int
V
>
class
FFmpegDataDecoder
:
public
MediaDataDecoder
{
}
;
template
<
>
class
FFmpegDataDecoder
<
LIBAV_VER
>
:
public
MediaDataDecoder
{
public
:
FFmpegDataDecoder
(
FFmpegLibWrapper
*
aLib
TaskQueue
*
aTaskQueue
AVCodecID
aCodecID
)
;
virtual
~
FFmpegDataDecoder
(
)
;
static
bool
Link
(
)
;
RefPtr
<
InitPromise
>
Init
(
)
override
=
0
;
RefPtr
<
DecodePromise
>
Decode
(
MediaRawData
*
aSample
)
override
;
RefPtr
<
DecodePromise
>
Drain
(
)
override
;
RefPtr
<
FlushPromise
>
Flush
(
)
override
;
RefPtr
<
ShutdownPromise
>
Shutdown
(
)
override
;
static
AVCodec
*
FindAVCodec
(
FFmpegLibWrapper
*
aLib
AVCodecID
aCodec
)
;
protected
:
virtual
RefPtr
<
FlushPromise
>
ProcessFlush
(
)
;
virtual
void
ProcessShutdown
(
)
;
virtual
void
InitCodecContext
(
)
{
}
AVFrame
*
PrepareFrame
(
)
;
nsresult
InitDecoder
(
)
;
FFmpegLibWrapper
*
mLib
;
AVCodecContext
*
mCodecContext
;
AVFrame
*
mFrame
;
RefPtr
<
MediaByteBuffer
>
mExtraData
;
AVCodecID
mCodecID
;
private
:
virtual
RefPtr
<
DecodePromise
>
ProcessDecode
(
MediaRawData
*
aSample
)
=
0
;
virtual
RefPtr
<
DecodePromise
>
ProcessDrain
(
)
=
0
;
static
StaticMutex
sMonitor
;
const
RefPtr
<
TaskQueue
>
mTaskQueue
;
MozPromiseHolder
<
DecodePromise
>
mPromise
;
}
;
}
#
endif
