#
ifndef
__FFmpegVideoDecoder_h__
#
define
__FFmpegVideoDecoder_h__
#
include
"
FFmpegLibWrapper
.
h
"
#
include
"
FFmpegDataDecoder
.
h
"
#
include
"
DurationMap
.
h
"
namespace
mozilla
{
template
<
int
V
>
class
FFmpegVideoDecoder
:
public
FFmpegDataDecoder
<
V
>
{
}
;
template
<
>
class
FFmpegVideoDecoder
<
LIBAV_VER
>
:
public
FFmpegDataDecoder
<
LIBAV_VER
>
{
typedef
mozilla
:
:
layers
:
:
Image
Image
;
typedef
mozilla
:
:
layers
:
:
ImageContainer
ImageContainer
;
public
:
FFmpegVideoDecoder
(
FFmpegLibWrapper
*
aLib
TaskQueue
*
aTaskQueue
const
VideoInfo
&
aConfig
ImageContainer
*
aImageContainer
bool
aLowLatency
)
;
virtual
~
FFmpegVideoDecoder
(
)
;
RefPtr
<
InitPromise
>
Init
(
)
override
;
void
InitCodecContext
(
)
override
;
const
char
*
GetDescriptionName
(
)
const
override
{
#
ifdef
USING_MOZFFVPX
return
"
ffvpx
video
decoder
"
;
#
else
return
"
ffmpeg
video
decoder
"
;
#
endif
}
ConversionRequired
NeedsConversion
(
)
const
override
{
return
ConversionRequired
:
:
kNeedAVCC
;
}
static
AVCodecID
GetCodecId
(
const
nsACString
&
aMimeType
)
;
private
:
RefPtr
<
DecodePromise
>
ProcessDecode
(
MediaRawData
*
aSample
)
override
;
RefPtr
<
DecodePromise
>
ProcessDrain
(
)
override
;
RefPtr
<
FlushPromise
>
ProcessFlush
(
)
override
;
MediaResult
DoDecode
(
MediaRawData
*
aSample
bool
*
aGotFrame
DecodedData
&
aResults
)
;
MediaResult
DoDecode
(
MediaRawData
*
aSample
uint8_t
*
aData
int
aSize
bool
*
aGotFrame
DecodedData
&
aResults
)
;
void
OutputDelayedFrames
(
)
;
int
AllocateYUV420PVideoBuffer
(
AVCodecContext
*
aCodecContext
AVFrame
*
aFrame
)
;
RefPtr
<
ImageContainer
>
mImageContainer
;
VideoInfo
mInfo
;
AVCodecParserContext
*
mCodecParser
;
class
PtsCorrectionContext
{
public
:
PtsCorrectionContext
(
)
;
int64_t
GuessCorrectPts
(
int64_t
aPts
int64_t
aDts
)
;
void
Reset
(
)
;
int64_t
LastDts
(
)
const
{
return
mLastDts
;
}
private
:
int64_t
mNumFaultyPts
;
int64_t
mNumFaultyDts
;
int64_t
mLastPts
;
int64_t
mLastDts
;
}
;
PtsCorrectionContext
mPtsContext
;
int64_t
mLastInputDts
;
DurationMap
mDurationMap
;
const
bool
mLowLatency
;
}
;
}
#
endif
