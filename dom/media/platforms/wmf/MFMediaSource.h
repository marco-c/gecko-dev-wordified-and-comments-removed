#
ifndef
DOM_MEDIA_PLATFORM_WMF_MFMEDIASOURCE_H
#
define
DOM_MEDIA_PLATFORM_WMF_MFMEDIASOURCE_H
#
include
<
mfidl
.
h
>
#
include
<
wrl
.
h
>
#
include
"
MediaInfo
.
h
"
#
include
"
MediaEventSource
.
h
"
#
include
"
MFMediaEngineExtra
.
h
"
#
include
"
MFMediaEngineStream
.
h
"
#
include
"
mozilla
/
EnumSet
.
h
"
#
include
"
mozilla
/
TaskQueue
.
h
"
namespace
mozilla
{
class
MFCDMProxy
;
struct
SampleRequest
{
SampleRequest
(
TrackInfo
:
:
TrackType
aType
bool
aIsEnough
)
:
mType
(
aType
)
mIsEnough
(
aIsEnough
)
{
}
TrackInfo
:
:
TrackType
mType
;
bool
mIsEnough
;
}
;
class
MFMediaSource
:
public
Microsoft
:
:
WRL
:
:
RuntimeClass
<
Microsoft
:
:
WRL
:
:
RuntimeClassFlags
<
Microsoft
:
:
WRL
:
:
RuntimeClassType
:
:
ClassicCom
>
IMFMediaSource
IMFRateControl
IMFRateSupport
IMFGetService
IMFTrustedInput
>
{
public
:
MFMediaSource
(
)
;
~
MFMediaSource
(
)
;
HRESULT
RuntimeClassInitialize
(
const
Maybe
<
AudioInfo
>
&
aAudio
const
Maybe
<
VideoInfo
>
&
aVideo
nsISerialEventTarget
*
aManagerThread
)
;
IFACEMETHODIMP
GetCharacteristics
(
DWORD
*
aCharacteristics
)
override
;
IFACEMETHODIMP
CreatePresentationDescriptor
(
IMFPresentationDescriptor
*
*
aPresentationDescriptor
)
override
;
IFACEMETHODIMP
Start
(
IMFPresentationDescriptor
*
aPresentationDescriptor
const
GUID
*
aGuidTimeFormat
const
PROPVARIANT
*
aStartPosition
)
override
;
IFACEMETHODIMP
Stop
(
)
override
;
IFACEMETHODIMP
Pause
(
)
override
;
IFACEMETHODIMP
Shutdown
(
)
override
;
IFACEMETHODIMP
GetEvent
(
DWORD
aFlags
IMFMediaEvent
*
*
aEvent
)
override
;
IFACEMETHODIMP
BeginGetEvent
(
IMFAsyncCallback
*
aCallback
IUnknown
*
aState
)
override
;
IFACEMETHODIMP
EndGetEvent
(
IMFAsyncResult
*
aResult
IMFMediaEvent
*
*
aEvent
)
override
;
IFACEMETHODIMP
QueueEvent
(
MediaEventType
aType
REFGUID
aExtendedType
HRESULT
aStatus
const
PROPVARIANT
*
aValue
)
override
;
IFACEMETHODIMP
GetService
(
REFGUID
aGuidService
REFIID
aRiid
LPVOID
*
aResult
)
override
;
IFACEMETHODIMP
GetSlowestRate
(
MFRATE_DIRECTION
aDirection
BOOL
aSupportsThinning
float
*
aRate
)
override
;
IFACEMETHODIMP
GetFastestRate
(
MFRATE_DIRECTION
aDirection
BOOL
aSupportsThinning
float
*
aRate
)
override
;
IFACEMETHODIMP
IsRateSupported
(
BOOL
aSupportsThinning
float
aNewRate
float
*
aSupportedRate
)
override
;
IFACEMETHODIMP
SetRate
(
BOOL
aSupportsThinning
float
aRate
)
override
;
IFACEMETHODIMP
GetRate
(
BOOL
*
aSupportsThinning
float
*
aRate
)
override
;
IFACEMETHODIMP
GetInputTrustAuthority
(
DWORD
aStreamId
REFIID
aRiid
IUnknown
*
*
aITAOut
)
override
;
MFMediaEngineStream
*
GetAudioStream
(
)
;
MFMediaEngineStream
*
GetVideoStream
(
)
;
MFMediaEngineStream
*
GetStreamByIndentifier
(
DWORD
aStreamId
)
const
;
#
ifdef
MOZ_WMF_CDM
void
SetCDMProxy
(
MFCDMProxy
*
aCDMProxy
)
;
#
endif
TaskQueue
*
GetTaskQueue
(
)
const
{
return
mTaskQueue
;
}
MediaEventSource
<
SampleRequest
>
&
RequestSampleEvent
(
)
{
return
mRequestSampleEvent
;
}
void
NotifyEndOfStream
(
TrackInfo
:
:
TrackType
aType
)
;
void
HandleStreamEnded
(
TrackInfo
:
:
TrackType
aType
)
;
enum
class
State
{
Initialized
Started
Stopped
Paused
Shutdowned
}
;
State
GetState
(
)
const
;
void
SetDCompSurfaceHandle
(
HANDLE
aDCompSurfaceHandle
gfx
:
:
IntSize
aDisplay
)
;
void
ShutdownTaskQueue
(
)
;
bool
IsEncrypted
(
)
const
;
private
:
void
AssertOnManagerThread
(
)
const
;
void
AssertOnMFThreadPool
(
)
const
;
void
NotifyEndOfStreamInternal
(
TrackInfo
:
:
TrackType
aType
)
;
bool
IsSeekable
(
)
const
;
Microsoft
:
:
WRL
:
:
ComPtr
<
IMFMediaEventQueue
>
mMediaEventQueue
;
RefPtr
<
TaskQueue
>
mTaskQueue
;
RefPtr
<
nsISerialEventTarget
>
mManagerThread
;
friend
class
MFMediaEngineStream
;
MediaEventProducer
<
SampleRequest
>
mRequestSampleEvent
;
MediaEventListener
mAudioStreamEndedListener
;
MediaEventListener
mVideoStreamEndedListener
;
mutable
Mutex
mMutex
{
"
MFMediaEngineSource
"
}
;
bool
mPresentationEnded
MOZ_GUARDED_BY
(
mMutex
)
;
bool
mIsAudioEnded
MOZ_GUARDED_BY
(
mMutex
)
;
bool
mIsVideoEnded
MOZ_GUARDED_BY
(
mMutex
)
;
State
mState
MOZ_GUARDED_BY
(
mMutex
)
;
Microsoft
:
:
WRL
:
:
ComPtr
<
MFMediaEngineStream
>
mAudioStream
MOZ_GUARDED_BY
(
mMutex
)
;
Microsoft
:
:
WRL
:
:
ComPtr
<
MFMediaEngineStream
>
mVideoStream
MOZ_GUARDED_BY
(
mMutex
)
;
float
mPlaybackRate
=
0
.
0f
;
#
ifdef
MOZ_WMF_CDM
RefPtr
<
MFCDMProxy
>
mCDMProxy
;
#
endif
}
;
}
#
endif
