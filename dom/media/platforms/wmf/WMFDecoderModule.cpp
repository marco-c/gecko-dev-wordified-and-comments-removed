#
include
"
WMFDecoderModule
.
h
"
#
include
"
GfxDriverInfo
.
h
"
#
include
"
MFTDecoder
.
h
"
#
include
"
MP4Decoder
.
h
"
#
include
"
MediaInfo
.
h
"
#
include
"
MediaPrefs
.
h
"
#
include
"
VPXDecoder
.
h
"
#
include
"
WMF
.
h
"
#
include
"
WMFAudioMFTManager
.
h
"
#
include
"
WMFMediaDataDecoder
.
h
"
#
include
"
WMFVideoMFTManager
.
h
"
#
include
"
mozilla
/
DebugOnly
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
#
include
"
mozilla
/
WindowsVersion
.
h
"
#
include
"
mozilla
/
gfx
/
gfxVars
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsIGfxInfo
.
h
"
#
include
"
nsIWindowsRegKey
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsWindowsHelpers
.
h
"
#
include
"
prsystem
.
h
"
#
include
"
nsIXULRuntime
.
h
"
#
include
"
mozilla
/
mscom
/
EnsureMTA
.
h
"
extern
const
GUID
CLSID_WebmMfVpxDec
;
extern
const
GUID
CLSID_AMDWebmMfVp9Dec
;
namespace
mozilla
{
static
Atomic
<
bool
>
sDXVAEnabled
(
false
)
;
WMFDecoderModule
:
:
~
WMFDecoderModule
(
)
{
if
(
mWMFInitialized
)
{
DebugOnly
<
HRESULT
>
hr
=
wmf
:
:
MFShutdown
(
)
;
NS_ASSERTION
(
SUCCEEDED
(
hr
)
"
MFShutdown
failed
"
)
;
}
}
void
WMFDecoderModule
:
:
Init
(
)
{
if
(
XRE_IsContentProcess
(
)
)
{
sDXVAEnabled
=
!
MediaPrefs
:
:
PDMUseGPUDecoder
(
)
;
}
else
if
(
XRE_IsGPUProcess
(
)
)
{
sDXVAEnabled
=
true
;
}
else
{
sDXVAEnabled
=
!
mozilla
:
:
BrowserTabsRemoteAutostart
(
)
;
}
sDXVAEnabled
=
sDXVAEnabled
&
&
gfx
:
:
gfxVars
:
:
CanUseHardwareVideoDecoding
(
)
;
}
int
WMFDecoderModule
:
:
GetNumDecoderThreads
(
)
{
int32_t
numCores
=
PR_GetNumberOfProcessors
(
)
;
const
int
WMF_DECODER_DEFAULT
=
-
1
;
int32_t
prefThreadCount
=
WMF_DECODER_DEFAULT
;
if
(
XRE_GetProcessType
(
)
!
=
GeckoProcessType_GPU
)
{
prefThreadCount
=
MediaPrefs
:
:
PDMWMFThreadCount
(
)
;
}
if
(
prefThreadCount
!
=
WMF_DECODER_DEFAULT
)
{
return
std
:
:
max
(
prefThreadCount
1
)
;
}
else
if
(
numCores
>
4
)
{
return
WMF_DECODER_DEFAULT
;
}
return
std
:
:
max
(
numCores
-
1
1
)
;
}
nsresult
WMFDecoderModule
:
:
Startup
(
)
{
mWMFInitialized
=
SUCCEEDED
(
wmf
:
:
MFStartup
(
)
)
;
return
mWMFInitialized
?
NS_OK
:
NS_ERROR_FAILURE
;
}
already_AddRefed
<
MediaDataDecoder
>
WMFDecoderModule
:
:
CreateVideoDecoder
(
const
CreateDecoderParams
&
aParams
)
{
if
(
aParams
.
mOptions
.
contains
(
CreateDecoderParams
:
:
Option
:
:
LowLatency
)
)
{
return
nullptr
;
}
nsAutoPtr
<
WMFVideoMFTManager
>
manager
(
new
WMFVideoMFTManager
(
aParams
.
VideoConfig
(
)
aParams
.
mKnowsCompositor
aParams
.
mImageContainer
sDXVAEnabled
)
)
;
if
(
!
manager
-
>
Init
(
)
)
{
return
nullptr
;
}
RefPtr
<
MediaDataDecoder
>
decoder
=
new
WMFMediaDataDecoder
(
manager
.
forget
(
)
aParams
.
mTaskQueue
)
;
return
decoder
.
forget
(
)
;
}
already_AddRefed
<
MediaDataDecoder
>
WMFDecoderModule
:
:
CreateAudioDecoder
(
const
CreateDecoderParams
&
aParams
)
{
nsAutoPtr
<
WMFAudioMFTManager
>
manager
(
new
WMFAudioMFTManager
(
aParams
.
AudioConfig
(
)
)
)
;
if
(
!
manager
-
>
Init
(
)
)
{
return
nullptr
;
}
RefPtr
<
MediaDataDecoder
>
decoder
=
new
WMFMediaDataDecoder
(
manager
.
forget
(
)
aParams
.
mTaskQueue
)
;
return
decoder
.
forget
(
)
;
}
static
bool
CanCreateMFTDecoder
(
const
GUID
&
aGuid
)
{
bool
canCreateDecoder
=
false
;
mozilla
:
:
mscom
:
:
EnsureMTA
(
[
&
]
(
)
-
>
void
{
if
(
FAILED
(
wmf
:
:
MFStartup
(
)
)
)
{
return
;
}
RefPtr
<
MFTDecoder
>
decoder
(
new
MFTDecoder
(
)
)
;
canCreateDecoder
=
SUCCEEDED
(
decoder
-
>
Create
(
aGuid
)
)
;
wmf
:
:
MFShutdown
(
)
;
}
)
;
return
canCreateDecoder
;
}
template
<
const
GUID
&
aGuid
>
static
bool
CanCreateWMFDecoder
(
)
{
static
StaticMutex
sMutex
;
StaticMutexAutoLock
lock
(
sMutex
)
;
static
Maybe
<
bool
>
result
;
if
(
result
.
isNothing
(
)
)
{
result
.
emplace
(
CanCreateMFTDecoder
(
aGuid
)
)
;
}
return
result
.
value
(
)
;
}
static
bool
IsWin7H264Decoder4KCapable
(
)
{
WCHAR
systemPath
[
MAX_PATH
+
1
]
;
if
(
!
ConstructSystem32Path
(
L
"
msmpeg2vdec
.
dll
"
systemPath
MAX_PATH
+
1
)
)
{
return
false
;
}
DWORD
zero
;
DWORD
infoSize
=
GetFileVersionInfoSizeW
(
systemPath
&
zero
)
;
if
(
infoSize
=
=
0
)
{
return
false
;
}
auto
infoData
=
MakeUnique
<
unsigned
char
[
]
>
(
infoSize
)
;
VS_FIXEDFILEINFO
*
vInfo
;
UINT
vInfoLen
;
if
(
GetFileVersionInfoW
(
systemPath
0
infoSize
infoData
.
get
(
)
)
&
&
VerQueryValueW
(
infoData
.
get
(
)
L
"
\
\
"
(
LPVOID
*
)
&
vInfo
&
vInfoLen
)
)
{
uint64_t
version
=
uint64_t
(
vInfo
-
>
dwFileVersionMS
)
<
<
32
|
uint64_t
(
vInfo
-
>
dwFileVersionLS
)
;
const
uint64_t
minimum
=
(
uint64_t
(
12
)
<
<
48
)
|
(
uint64_t
(
9200
)
<
<
16
)
|
uint64_t
(
16426
)
;
return
version
>
=
minimum
;
}
return
false
;
}
bool
WMFDecoderModule
:
:
HasH264
(
)
{
return
CanCreateWMFDecoder
<
CLSID_CMSH264DecoderMFT
>
(
)
;
}
bool
WMFDecoderModule
:
:
HasAAC
(
)
{
return
CanCreateWMFDecoder
<
CLSID_CMSAACDecMFT
>
(
)
;
}
bool
WMFDecoderModule
:
:
SupportsMimeType
(
const
nsACString
&
aMimeType
DecoderDoctorDiagnostics
*
aDiagnostics
)
const
{
UniquePtr
<
TrackInfo
>
trackInfo
=
CreateTrackInfoWithMIMEType
(
aMimeType
)
;
if
(
!
trackInfo
)
{
return
false
;
}
return
Supports
(
*
trackInfo
aDiagnostics
)
;
}
bool
WMFDecoderModule
:
:
Supports
(
const
TrackInfo
&
aTrackInfo
DecoderDoctorDiagnostics
*
aDiagnostics
)
const
{
if
(
(
aTrackInfo
.
mMimeType
.
EqualsLiteral
(
"
audio
/
mp4a
-
latm
"
)
|
|
aTrackInfo
.
mMimeType
.
EqualsLiteral
(
"
audio
/
mp4
"
)
)
&
&
WMFDecoderModule
:
:
HasAAC
(
)
)
{
return
true
;
}
if
(
MP4Decoder
:
:
IsH264
(
aTrackInfo
.
mMimeType
)
&
&
WMFDecoderModule
:
:
HasH264
(
)
)
{
if
(
!
MediaPrefs
:
:
PDMWMFAllowUnsupportedResolutions
(
)
)
{
const
VideoInfo
*
videoInfo
=
aTrackInfo
.
GetAsVideoInfo
(
)
;
MOZ_ASSERT
(
videoInfo
)
;
if
(
IsWin8OrLater
(
)
|
|
IsWin7H264Decoder4KCapable
(
)
)
{
if
(
videoInfo
-
>
mImage
.
width
>
4096
|
|
videoInfo
-
>
mImage
.
height
>
2304
)
{
return
false
;
}
}
else
{
if
(
videoInfo
-
>
mImage
.
width
>
1920
|
|
videoInfo
-
>
mImage
.
height
>
1088
)
{
return
false
;
}
}
}
return
true
;
}
if
(
aTrackInfo
.
mMimeType
.
EqualsLiteral
(
"
audio
/
mpeg
"
)
&
&
CanCreateWMFDecoder
<
CLSID_CMP3DecMediaObject
>
(
)
)
{
return
true
;
}
if
(
MediaPrefs
:
:
PDMWMFVP9DecoderEnabled
(
)
)
{
if
(
(
VPXDecoder
:
:
IsVP8
(
aTrackInfo
.
mMimeType
)
|
|
VPXDecoder
:
:
IsVP9
(
aTrackInfo
.
mMimeType
)
)
&
&
(
(
MediaPrefs
:
:
PDMWMFAMDVP9DecoderEnabled
(
)
&
&
CanCreateWMFDecoder
<
CLSID_AMDWebmMfVp9Dec
>
(
)
)
|
|
CanCreateWMFDecoder
<
CLSID_WebmMfVpxDec
>
(
)
)
)
{
return
true
;
}
}
return
false
;
}
}
