#
if
!
defined
(
DXVA2Manager_h_
)
#
define
DXVA2Manager_h_
#
include
"
D3D11TextureWrapper
.
h
"
#
include
"
MediaInfo
.
h
"
#
include
"
WMF
.
h
"
#
include
"
d3d11
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
gfx
/
Rect
.
h
"
namespace
mozilla
{
namespace
layers
{
class
Image
;
class
ImageContainer
;
class
KnowsCompositor
;
}
enum
class
DXVA2Usage
{
Playback
ColorConversionOnly
}
;
class
DXVA2Manager
{
public
:
static
DXVA2Manager
*
CreateD3D11DXVA
(
layers
:
:
KnowsCompositor
*
aKnowsCompositor
nsACString
&
aFailureReason
ID3D11Device
*
aDevice
=
nullptr
DXVA2Usage
aUsage
=
DXVA2Usage
:
:
Playback
)
;
virtual
IUnknown
*
GetDXVADeviceManager
(
)
=
0
;
virtual
HRESULT
CopyToImage
(
IMFSample
*
aVideoSample
const
gfx
:
:
IntRect
&
aRegion
layers
:
:
Image
*
*
aOutImage
)
=
0
;
virtual
HRESULT
CopyToImage
(
ID3D11Texture2D
*
aInputTexture
UINT
aSurfaceIndex
const
gfx
:
:
IntRect
&
aRegion
layers
:
:
Image
*
*
aOutImage
)
=
0
;
virtual
HRESULT
WrapTextureWithImage
(
IMFSample
*
aVideoSample
const
gfx
:
:
IntRect
&
aRegion
layers
:
:
Image
*
*
aOutImage
)
{
MOZ_CRASH
(
"
WrapTextureWithImage
not
implemented
on
this
manager
.
"
)
;
return
E_FAIL
;
}
virtual
HRESULT
WrapTextureWithImage
(
D3D11TextureWrapper
*
aTextureWrapper
const
gfx
:
:
IntRect
&
aRegion
layers
:
:
Image
*
*
aOutImage
)
{
MOZ_CRASH
(
"
WrapTextureWithImage
not
implemented
on
this
manager
.
"
)
;
return
E_FAIL
;
}
virtual
HRESULT
ConfigureForSize
(
IMFMediaType
*
aInputType
gfx
:
:
YUVColorSpace
aColorSpace
gfx
:
:
ColorRange
aColorRange
gfx
:
:
ColorDepth
aColorDepth
uint32_t
aWidth
uint32_t
aHeight
)
{
return
S_OK
;
}
virtual
HRESULT
ConfigureForSize
(
gfx
:
:
SurfaceFormat
aSurfaceFormat
gfx
:
:
YUVColorSpace
aColorSpace
gfx
:
:
ColorRange
aColorRange
gfx
:
:
ColorDepth
aColorDepth
uint32_t
aWidth
uint32_t
aHeight
)
{
MOZ_CRASH
(
"
ConfigureForSize
not
implemented
on
this
manager
.
"
)
;
return
E_FAIL
;
}
virtual
bool
IsD3D11
(
)
{
return
false
;
}
virtual
~
DXVA2Manager
(
)
;
virtual
bool
SupportsConfig
(
const
VideoInfo
&
aInfo
IMFMediaType
*
aInputType
IMFMediaType
*
aOutputType
)
=
0
;
virtual
void
BeforeShutdownVideoMFTDecoder
(
)
{
}
virtual
bool
SupportsZeroCopyNV12Texture
(
)
{
return
false
;
}
static
bool
IsNV12Supported
(
uint32_t
aVendorID
uint32_t
aDeviceID
const
nsAString
&
aDriverVersionString
)
;
virtual
ID3D11Device
*
GetD3D11Device
(
)
{
return
nullptr
;
}
protected
:
Mutex
mLock
MOZ_UNANNOTATED
;
DXVA2Manager
(
)
;
bool
IsUnsupportedResolution
(
const
uint32_t
&
aWidth
const
uint32_t
&
aHeight
const
float
&
aFramerate
)
const
;
bool
mIsAMDPreUVD4
=
false
;
}
;
}
#
endif
