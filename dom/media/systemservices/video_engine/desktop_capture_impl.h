#
ifndef
WEBRTC_MODULES_DESKTOP_CAPTURE_MAIN_SOURCE_DESKTOP_CAPTURE_IMPL_H_
#
define
WEBRTC_MODULES_DESKTOP_CAPTURE_MAIN_SOURCE_DESKTOP_CAPTURE_IMPL_H_
#
include
<
memory
>
#
include
<
set
>
#
include
<
string
>
#
include
"
api
/
video
/
video_frame
.
h
"
#
include
"
common_video
/
libyuv
/
include
/
webrtc_libyuv
.
h
"
#
include
"
modules
/
video_capture
/
video_capture
.
h
"
#
include
"
modules
/
video_capture
/
video_capture_config
.
h
"
#
include
"
modules
/
video_coding
/
event_wrapper
.
h
"
#
include
"
modules
/
desktop_capture
/
shared_memory
.
h
"
#
include
"
modules
/
desktop_capture
/
desktop_and_cursor_composer
.
h
"
#
include
"
rtc_base
/
deprecated
/
recursive_critical_section
.
h
"
#
include
"
desktop_device_info
.
h
"
#
include
"
VideoEngine
.
h
"
#
if
!
defined
(
_WIN32
)
#
include
"
rtc_base
/
platform_thread
.
h
"
#
endif
using
namespace
webrtc
:
:
videocapturemodule
;
using
namespace
mozilla
:
:
camera
;
namespace
rtc
{
#
if
defined
(
_WIN32
)
class
PlatformUIThread
;
#
endif
}
namespace
webrtc
{
class
VideoCaptureEncodeInterface
;
class
ScreenDeviceInfoImpl
:
public
VideoCaptureModule
:
:
DeviceInfo
{
public
:
ScreenDeviceInfoImpl
(
int32_t
aId
)
:
mId
(
aId
)
{
}
virtual
~
ScreenDeviceInfoImpl
(
)
=
default
;
int32_t
Init
(
)
;
int32_t
Refresh
(
)
;
virtual
uint32_t
NumberOfDevices
(
)
;
virtual
int32_t
GetDeviceName
(
uint32_t
aDeviceNumber
char
*
aDeviceNameUTF8
uint32_t
aDeviceNameUTF8Size
char
*
aDeviceUniqueIdUTF8
uint32_t
aDeviceUniqueIdUTF8Size
char
*
aProductUniqueIdUTF8
uint32_t
aProductUniqueIdUTF8Size
pid_t
*
aPid
)
;
virtual
int32_t
DisplayCaptureSettingsDialogBox
(
const
char
*
aDeviceUniqueIdUTF8
const
char
*
aDialogTitleUTF8
void
*
aParentWindow
uint32_t
aPositionX
uint32_t
aPositionY
)
;
virtual
int32_t
NumberOfCapabilities
(
const
char
*
aDeviceUniqueIdUTF8
)
;
virtual
int32_t
GetCapability
(
const
char
*
aDeviceUniqueIdUTF8
uint32_t
aDeviceCapabilityNumber
VideoCaptureCapability
&
aCapability
)
;
virtual
int32_t
GetBestMatchedCapability
(
const
char
*
aDeviceUniqueIdUTF8
const
VideoCaptureCapability
&
aRequested
VideoCaptureCapability
&
aResulting
)
;
virtual
int32_t
GetOrientation
(
const
char
*
aDeviceUniqueIdUTF8
VideoRotation
&
aOrientation
)
;
protected
:
int32_t
mId
;
std
:
:
unique_ptr
<
DesktopDeviceInfo
>
mDesktopDeviceInfo
;
}
;
class
WindowDeviceInfoImpl
:
public
VideoCaptureModule
:
:
DeviceInfo
{
public
:
WindowDeviceInfoImpl
(
int32_t
aId
)
:
mId
(
aId
)
{
}
;
virtual
~
WindowDeviceInfoImpl
(
)
=
default
;
int32_t
Init
(
)
;
int32_t
Refresh
(
)
;
virtual
uint32_t
NumberOfDevices
(
)
;
virtual
int32_t
GetDeviceName
(
uint32_t
aDeviceNumber
char
*
aDeviceNameUTF8
uint32_t
aDeviceNameUTF8Size
char
*
aDeviceUniqueIdUTF8
uint32_t
aDeviceUniqueIdUTF8Size
char
*
aProductUniqueIdUTF8
uint32_t
aProductUniqueIdUTF8Size
pid_t
*
aPid
)
;
virtual
int32_t
DisplayCaptureSettingsDialogBox
(
const
char
*
aDeviceUniqueIdUTF8
const
char
*
aDialogTitleUTF8
void
*
aParentWindow
uint32_t
aPositionX
uint32_t
aPositionY
)
;
virtual
int32_t
NumberOfCapabilities
(
const
char
*
aDeviceUniqueIdUTF8
)
;
virtual
int32_t
GetCapability
(
const
char
*
aDeviceUniqueIdUTF8
uint32_t
aDeviceCapabilityNumber
VideoCaptureCapability
&
aCapability
)
;
virtual
int32_t
GetBestMatchedCapability
(
const
char
*
aDeviceUniqueIdUTF8
const
VideoCaptureCapability
&
aRequested
VideoCaptureCapability
&
aResulting
)
;
virtual
int32_t
GetOrientation
(
const
char
*
aDeviceUniqueIdUTF8
VideoRotation
&
aOrientation
)
;
protected
:
int32_t
mId
;
std
:
:
unique_ptr
<
DesktopDeviceInfo
>
mDesktopDeviceInfo
;
}
;
class
BrowserDeviceInfoImpl
:
public
VideoCaptureModule
:
:
DeviceInfo
{
public
:
BrowserDeviceInfoImpl
(
int32_t
aId
)
:
mId
(
aId
)
{
}
;
virtual
~
BrowserDeviceInfoImpl
(
)
=
default
;
int32_t
Init
(
)
;
int32_t
Refresh
(
)
;
virtual
uint32_t
NumberOfDevices
(
)
;
virtual
int32_t
GetDeviceName
(
uint32_t
aDeviceNumber
char
*
aDeviceNameUTF8
uint32_t
aDeviceNameUTF8Size
char
*
aDeviceUniqueIdUTF8
uint32_t
aDeviceUniqueIdUTF8Size
char
*
aProductUniqueIdUTF8
uint32_t
aProductUniqueIdUTF8Size
pid_t
*
aPid
)
;
virtual
int32_t
DisplayCaptureSettingsDialogBox
(
const
char
*
aDeviceUniqueIdUTF8
const
char
*
aDialogTitleUTF8
void
*
aParentWindow
uint32_t
aPositionX
uint32_t
aPositionY
)
;
virtual
int32_t
NumberOfCapabilities
(
const
char
*
aDeviceUniqueIdUTF8
)
;
virtual
int32_t
GetCapability
(
const
char
*
aDeviceUniqueIdUTF8
uint32_t
aDeviceCapabilityNumber
VideoCaptureCapability
&
aCapability
)
;
virtual
int32_t
GetBestMatchedCapability
(
const
char
*
aDeviceUniqueIdUTF8
const
VideoCaptureCapability
&
aRequested
VideoCaptureCapability
&
aResulting
)
;
virtual
int32_t
GetOrientation
(
const
char
*
aDeviceUniqueIdUTF8
VideoRotation
&
aOrientation
)
;
protected
:
int32_t
mId
;
std
:
:
unique_ptr
<
DesktopDeviceInfo
>
mDesktopDeviceInfo
;
}
;
class
DesktopCaptureImpl
:
public
DesktopCapturer
:
:
Callback
public
VideoCaptureModule
{
public
:
static
VideoCaptureModule
*
Create
(
const
int32_t
aModuleId
const
char
*
aUniqueId
const
mozilla
:
:
camera
:
:
CaptureDeviceType
aType
)
;
[
[
nodiscard
]
]
static
std
:
:
shared_ptr
<
VideoCaptureModule
:
:
DeviceInfo
>
CreateDeviceInfo
(
const
int32_t
aId
const
mozilla
:
:
camera
:
:
CaptureDeviceType
aType
)
;
void
RegisterCaptureDataCallback
(
rtc
:
:
VideoSinkInterface
<
VideoFrame
>
*
aCallback
)
override
;
void
DeRegisterCaptureDataCallback
(
rtc
:
:
VideoSinkInterface
<
VideoFrame
>
*
aCallback
)
override
;
int32_t
StopCaptureIfAllClientsClose
(
)
override
;
int32_t
SetCaptureRotation
(
VideoRotation
aRotation
)
override
;
bool
SetApplyRotation
(
bool
aEnable
)
override
;
bool
GetApplyRotation
(
)
override
{
return
true
;
}
const
char
*
CurrentDeviceName
(
)
const
override
;
int32_t
IncomingFrame
(
uint8_t
*
videoFrame
size_t
videoFrameLength
size_t
widthWithPadding
const
VideoCaptureCapability
&
frameInfo
)
;
int32_t
StartCapture
(
const
VideoCaptureCapability
&
aCapability
)
override
;
virtual
bool
FocusOnSelectedSource
(
)
override
;
int32_t
StopCapture
(
)
override
;
bool
CaptureStarted
(
)
override
;
int32_t
CaptureSettings
(
VideoCaptureCapability
&
aSettings
)
override
;
protected
:
DesktopCaptureImpl
(
const
int32_t
aId
const
char
*
aUniqueId
const
mozilla
:
:
camera
:
:
CaptureDeviceType
aType
)
;
virtual
~
DesktopCaptureImpl
(
)
;
int32_t
DeliverCapturedFrame
(
webrtc
:
:
VideoFrame
&
aCaptureFrame
)
;
static
const
uint32_t
kMaxDesktopCaptureCpuUsage
=
50
;
int32_t
mModuleId
;
const
mozilla
:
:
TrackingId
mTrackingId
;
std
:
:
string
mDeviceUniqueId
;
CaptureDeviceType
mDeviceType
;
private
:
void
LazyInitCaptureThread
(
)
;
int32_t
LazyInitDesktopCapturer
(
)
;
void
OnCaptureResult
(
DesktopCapturer
:
:
Result
result
std
:
:
unique_ptr
<
DesktopFrame
>
frame
)
override
;
public
:
static
void
Run
(
void
*
aObj
)
{
static_cast
<
DesktopCaptureImpl
*
>
(
aObj
)
-
>
process
(
)
;
}
;
void
process
(
)
;
void
ProcessIter
(
)
;
private
:
rtc
:
:
RecursiveCriticalSection
mApiCs
;
std
:
:
atomic
<
uint32_t
>
mMaxFPSNeeded
=
{
0
}
;
VideoCaptureCapability
mRequestedCapability
;
std
:
:
unique_ptr
<
DesktopCapturer
>
mCapturer
;
bool
mCapturerStarted
=
false
;
std
:
:
unique_ptr
<
EventWrapper
>
mTimeEvent
;
#
if
defined
(
_WIN32
)
std
:
:
unique_ptr
<
rtc
:
:
PlatformUIThread
>
mCaptureThread
;
#
else
std
:
:
unique_ptr
<
rtc
:
:
PlatformThread
>
mCaptureThread
;
#
endif
int64_t
mLastFrameTimeMs
;
std
:
:
atomic
<
bool
>
mRunning
;
mozilla
:
:
DataMutex
<
std
:
:
set
<
rtc
:
:
VideoSinkInterface
<
VideoFrame
>
*
>
>
mCallbacks
;
}
;
}
#
endif
