#
ifndef
mozilla_VideoEngine_h
#
define
mozilla_VideoEngine_h
#
include
"
MediaEngine
.
h
"
#
include
"
VideoFrameUtils
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
include
"
modules
/
video_capture
/
video_capture_impl
.
h
"
#
include
"
modules
/
video_capture
/
video_capture_defines
.
h
"
#
include
"
modules
/
video_capture
/
video_capture_factory
.
h
"
#
include
<
memory
>
#
include
<
functional
>
namespace
mozilla
:
:
camera
{
enum
class
CaptureDeviceType
{
Camera
Screen
Window
Browser
}
;
struct
CaptureDeviceInfo
{
CaptureDeviceType
type
;
CaptureDeviceInfo
(
)
:
type
(
CaptureDeviceType
:
:
Camera
)
{
}
explicit
CaptureDeviceInfo
(
CaptureDeviceType
t
)
:
type
(
t
)
{
}
static
const
webrtc
:
:
ConfigOptionID
identifier
=
webrtc
:
:
ConfigOptionID
:
:
kCaptureDeviceInfo
;
const
char
*
TypeName
(
)
const
{
switch
(
type
)
{
case
CaptureDeviceType
:
:
Camera
:
{
return
"
Camera
"
;
}
case
CaptureDeviceType
:
:
Screen
:
{
return
"
Screen
"
;
}
case
CaptureDeviceType
:
:
Window
:
{
return
"
Window
"
;
}
case
CaptureDeviceType
:
:
Browser
:
{
return
"
Browser
"
;
}
}
assert
(
false
)
;
return
"
UNKOWN
-
CaptureDeviceType
!
"
;
}
}
;
class
VideoEngine
{
private
:
virtual
~
VideoEngine
(
)
=
default
;
static
const
int64_t
kCacheExpiryPeriodMs
=
2000
;
public
:
VideoEngine
(
)
:
mId
(
0
)
{
}
;
NS_INLINE_DECL_REFCOUNTING
(
VideoEngine
)
static
already_AddRefed
<
VideoEngine
>
Create
(
UniquePtr
<
const
webrtc
:
:
Config
>
&
&
aConfig
)
;
#
if
defined
(
ANDROID
)
static
int
SetAndroidObjects
(
)
;
#
endif
int32_t
CreateVideoCapture
(
const
char
*
deviceUniqueIdUTF8
)
;
int
ReleaseVideoCapture
(
const
int32_t
id
)
;
static
void
Delete
(
VideoEngine
*
engine
)
{
}
std
:
:
shared_ptr
<
webrtc
:
:
VideoCaptureModule
:
:
DeviceInfo
>
GetOrCreateVideoCaptureDeviceInfo
(
)
;
class
CaptureEntry
{
public
:
CaptureEntry
(
int32_t
aCapnum
rtc
:
:
scoped_refptr
<
webrtc
:
:
VideoCaptureModule
>
aCapture
)
;
int32_t
Capnum
(
)
const
;
rtc
:
:
scoped_refptr
<
webrtc
:
:
VideoCaptureModule
>
VideoCapture
(
)
;
private
:
int32_t
mCapnum
;
rtc
:
:
scoped_refptr
<
webrtc
:
:
VideoCaptureModule
>
mVideoCaptureModule
;
friend
class
VideoEngine
;
}
;
bool
WithEntry
(
const
int32_t
entryCapnum
const
std
:
:
function
<
void
(
CaptureEntry
&
entry
)
>
&
&
fn
)
;
private
:
explicit
VideoEngine
(
UniquePtr
<
const
webrtc
:
:
Config
>
&
&
aConfig
)
;
int32_t
mId
;
CaptureDeviceInfo
mCaptureDevInfo
;
std
:
:
shared_ptr
<
webrtc
:
:
VideoCaptureModule
:
:
DeviceInfo
>
mDeviceInfo
;
std
:
:
map
<
int32_t
CaptureEntry
>
mCaps
;
std
:
:
map
<
int32_t
int32_t
>
mIdMap
;
webrtc
:
:
Timestamp
mExpiryTime
=
webrtc
:
:
Timestamp
:
:
Micros
(
0
)
;
int32_t
GenerateId
(
)
;
}
;
}
#
endif
