#
if
!
defined
(
MediaMetadataManager_h__
)
#
define
MediaMetadataManager_h__
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
include
"
AbstractMediaDecoder
.
h
"
#
include
"
TimeUnits
.
h
"
#
include
"
VideoUtils
.
h
"
namespace
mozilla
{
class
TimedMetadata
:
public
LinkedListElement
<
TimedMetadata
>
{
public
:
media
:
:
TimeUnit
mPublishTime
;
nsAutoPtr
<
MetadataTags
>
mTags
;
nsAutoPtr
<
MediaInfo
>
mInfo
;
}
;
class
MediaMetadataManager
{
public
:
~
MediaMetadataManager
(
)
{
TimedMetadata
*
element
;
while
(
(
element
=
mMetadataQueue
.
popFirst
(
)
)
!
=
nullptr
)
{
delete
element
;
}
}
void
QueueMetadata
(
TimedMetadata
*
aMetadata
)
{
mMetadataQueue
.
insertBack
(
aMetadata
)
;
}
void
DispatchMetadataIfNeeded
(
AbstractMediaDecoder
*
aDecoder
const
media
:
:
TimeUnit
&
aCurrentTime
)
{
TimedMetadata
*
metadata
=
mMetadataQueue
.
getFirst
(
)
;
while
(
metadata
&
&
aCurrentTime
>
=
metadata
-
>
mPublishTime
)
{
nsCOMPtr
<
nsIRunnable
>
removeTracksEvent
=
new
RemoveMediaTracksEventRunner
(
aDecoder
)
;
NS_DispatchToMainThread
(
removeTracksEvent
)
;
nsCOMPtr
<
nsIRunnable
>
metadataUpdatedEvent
=
new
MetadataUpdatedEventRunner
(
aDecoder
metadata
-
>
mInfo
metadata
-
>
mTags
)
;
NS_DispatchToMainThread
(
metadataUpdatedEvent
)
;
delete
mMetadataQueue
.
popFirst
(
)
;
metadata
=
mMetadataQueue
.
getFirst
(
)
;
}
}
protected
:
LinkedList
<
TimedMetadata
>
mMetadataQueue
;
}
;
}
#
endif
