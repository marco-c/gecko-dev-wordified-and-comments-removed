#
include
"
AudioDeviceInfo
.
h
"
#
include
"
MediaManager
.
h
"
#
include
"
gmock
/
gmock
.
h
"
#
include
"
gtest
/
gtest
-
printers
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
webrtc
/
MediaEngineSource
.
h
"
using
:
:
testing
:
:
Return
;
using
namespace
mozilla
;
void
PrintTo
(
const
nsString
&
aValue
:
:
std
:
:
ostream
*
aStream
)
{
NS_ConvertUTF16toUTF8
str
(
aValue
)
;
(
*
aStream
)
<
<
str
.
get
(
)
;
}
void
PrintTo
(
const
nsCString
&
aValue
:
:
std
:
:
ostream
*
aStream
)
{
(
*
aStream
)
<
<
aValue
.
get
(
)
;
}
class
MockMediaEngineSource
:
public
MediaEngineSource
{
public
:
MOCK_CONST_METHOD0
(
GetMediaSource
dom
:
:
MediaSourceEnum
(
)
)
;
MOCK_CONST_METHOD0
(
GetName
nsString
(
)
)
;
MOCK_CONST_METHOD0
(
GetUUID
nsCString
(
)
)
;
MOCK_CONST_METHOD0
(
GetGroupId
nsString
(
)
)
;
MOCK_CONST_METHOD1
(
GetSettings
void
(
dom
:
:
MediaTrackSettings
&
)
)
;
MOCK_METHOD5
(
Allocate
nsresult
(
const
dom
:
:
MediaTrackConstraints
&
const
MediaEnginePrefs
&
const
nsString
&
const
ipc
:
:
PrincipalInfo
&
const
char
*
*
)
)
;
MOCK_METHOD3
(
SetTrack
void
(
const
RefPtr
<
SourceMediaStream
>
&
TrackID
const
PrincipalHandle
&
)
)
;
MOCK_METHOD0
(
Start
nsresult
(
)
)
;
MOCK_METHOD4
(
Reconfigure
nsresult
(
const
dom
:
:
MediaTrackConstraints
&
const
MediaEnginePrefs
&
const
nsString
&
const
char
*
*
)
)
;
MOCK_METHOD0
(
Stop
nsresult
(
)
)
;
MOCK_METHOD0
(
Deallocate
nsresult
(
)
)
;
MOCK_CONST_METHOD2
(
GetBestFitnessDistance
uint32_t
(
const
nsTArray
<
const
NormalizedConstraintSet
*
>
&
const
nsString
&
)
)
;
MOCK_METHOD5
(
Pull
void
(
const
RefPtr
<
SourceMediaStream
>
&
aStream
TrackID
aTrackID
StreamTime
aEndOfAppendedData
StreamTime
aDesiredTime
const
PrincipalHandle
&
aPrincipalHandle
)
)
;
}
;
RefPtr
<
AudioDeviceInfo
>
MakeAudioDeviceInfo
(
const
nsString
aName
)
{
return
MakeRefPtr
<
AudioDeviceInfo
>
(
nullptr
aName
NS_LITERAL_STRING
(
"
GroupId
"
)
NS_LITERAL_STRING
(
"
Vendor
"
)
AudioDeviceInfo
:
:
TYPE_OUTPUT
AudioDeviceInfo
:
:
STATE_ENABLED
AudioDeviceInfo
:
:
PREF_NONE
AudioDeviceInfo
:
:
FMT_F32LE
AudioDeviceInfo
:
:
FMT_F32LE
2u
44100u
44100u
44100u
0
0
)
;
}
RefPtr
<
MediaDevice
>
MakeCameraDevice
(
const
nsString
&
aName
const
nsString
&
aGroupId
)
{
auto
v
=
MakeRefPtr
<
MockMediaEngineSource
>
(
)
;
EXPECT_CALL
(
*
v
GetMediaSource
(
)
)
.
WillRepeatedly
(
Return
(
dom
:
:
MediaSourceEnum
:
:
Camera
)
)
;
return
MakeRefPtr
<
MediaDevice
>
(
v
aName
NS_LITERAL_STRING
(
"
"
)
aGroupId
NS_LITERAL_STRING
(
"
"
)
)
;
}
RefPtr
<
MediaDevice
>
MakeMicDevice
(
const
nsString
&
aName
const
nsString
&
aGroupId
)
{
auto
a
=
MakeRefPtr
<
MockMediaEngineSource
>
(
)
;
EXPECT_CALL
(
*
a
GetMediaSource
(
)
)
.
WillRepeatedly
(
Return
(
dom
:
:
MediaSourceEnum
:
:
Microphone
)
)
;
return
MakeRefPtr
<
MediaDevice
>
(
a
aName
NS_LITERAL_STRING
(
"
"
)
aGroupId
NS_LITERAL_STRING
(
"
"
)
)
;
}
RefPtr
<
MediaDevice
>
MakeSpeakerDevice
(
const
nsString
&
aName
const
nsString
&
aGroupId
)
{
return
MakeRefPtr
<
MediaDevice
>
(
MakeAudioDeviceInfo
(
aName
)
NS_LITERAL_STRING
(
"
ID
"
)
aGroupId
NS_LITERAL_STRING
(
"
RawID
"
)
)
;
}
TEST
(
TestGroupId
MatchInput_PartOfName
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
the
same
as
audio
input
group
id
.
"
;
}
TEST
(
TestGroupId
MatchInput_FullName
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
the
same
as
audio
input
group
id
.
"
;
}
TEST
(
TestGroupId
NoMatchInput
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
nsString
Cam_Model_GroupId
=
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
Cam_Model_GroupId
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
Cam_Model_GroupId
)
<
<
"
Video
group
id
has
not
been
updated
.
"
;
EXPECT_NE
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
different
than
audio
input
group
id
.
"
;
}
TEST
(
TestGroupId
NoMatch_TwoIdenticalDevices
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
nsString
Cam_Model_GroupId
=
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
Cam_Model_GroupId
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
Cam_Model_GroupId
)
<
<
"
Video
group
id
has
not
been
updated
.
"
;
EXPECT_NE
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
different
than
audio
input
group
id
.
"
;
EXPECT_NE
(
devices
[
0
]
-
>
mGroupID
devices
[
3
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
different
than
audio
output
group
id
.
"
;
}
TEST
(
TestGroupId
Match_TwoIdenticalInputsMatchOutput
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
nsString
Cam_Model_GroupId
=
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
Cam_Model_GroupId
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
devices
[
3
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
the
same
as
audio
output
group
id
.
"
;
}
TEST
(
TestGroupId
NoMatch_ThreeIdenticalDevices
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
nsString
Cam_Model_GroupId
=
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
Cam_Model_GroupId
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
Cam_Model_GroupId
)
<
<
"
Video
group
id
has
not
been
updated
.
"
;
EXPECT_NE
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
different
than
audio
input
group
id
.
"
;
EXPECT_NE
(
devices
[
0
]
-
>
mGroupID
devices
[
4
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
different
than
audio
output
group
id
.
"
;
}
TEST
(
TestGroupId
MatchOutput
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Mic
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
Analog
Stereo
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
devices
[
2
]
-
>
mGroupID
)
<
<
"
Video
group
id
is
the
same
as
audio
output
group
id
.
"
;
}
TEST
(
TestGroupId
InputOutputSameName
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Mic
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Speaker
-
Model
-
GroupId
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
input
group
id
is
the
same
as
audio
input
group
id
.
"
;
}
TEST
(
TestGroupId
InputEmptyGroupId
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeMicDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
input
group
id
is
the
same
as
audio
input
group
id
.
"
;
}
TEST
(
TestGroupId
OutputEmptyGroupId
)
{
MediaManager
:
:
MediaDeviceSet
devices
;
devices
.
AppendElement
(
MakeCameraDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
Cam
-
Model
-
GroupId
"
)
)
)
;
devices
.
AppendElement
(
MakeSpeakerDevice
(
NS_LITERAL_STRING
(
"
Vendor
Model
"
)
NS_LITERAL_STRING
(
"
"
)
)
)
;
MediaManager
:
:
GuessVideoDeviceGroupIDs
(
devices
)
;
EXPECT_EQ
(
devices
[
0
]
-
>
mGroupID
devices
[
1
]
-
>
mGroupID
)
<
<
"
Video
input
group
id
is
the
same
as
audio
output
group
id
.
"
;
}
