#
include
<
gtest
/
gtest
.
h
>
#
include
"
MediaData
.
h
"
#
include
"
MediaQueue
.
h
"
using
namespace
mozilla
;
using
mozilla
:
:
media
:
:
TimeUnit
;
MediaData
*
CreateDataRawPtr
(
int64_t
aStartTime
int64_t
aEndTime
)
{
const
TimeUnit
startTime
=
TimeUnit
:
:
FromMicroseconds
(
aStartTime
)
;
const
TimeUnit
endTime
=
TimeUnit
:
:
FromMicroseconds
(
aEndTime
)
;
return
new
NullData
(
0
startTime
endTime
-
startTime
)
;
}
already_AddRefed
<
MediaData
>
CreateData
(
int64_t
aStartTime
int64_t
aEndTime
)
{
RefPtr
<
MediaData
>
data
=
CreateDataRawPtr
(
aStartTime
aEndTime
)
;
return
data
.
forget
(
)
;
}
#
define
EXPECT_EQUAL_SIZE_T
(
lhs
rhs
)
EXPECT_EQ
(
size_t
(
lhs
)
size_t
(
rhs
)
)
TEST
(
MediaQueue
BasicPopOperations
)
{
MediaQueue
<
MediaData
>
queue
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
0
)
;
const
RefPtr
<
MediaData
>
data
=
CreateDataRawPtr
(
0
10
)
;
queue
.
Push
(
data
.
get
(
)
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
RefPtr
<
MediaData
>
rv
=
queue
.
PopFront
(
)
;
EXPECT_EQ
(
rv
data
)
;
queue
.
Push
(
data
.
get
(
)
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
rv
=
queue
.
PopBack
(
)
;
EXPECT_EQ
(
rv
data
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
0
)
;
const
RefPtr
<
MediaData
>
data1
=
CreateDataRawPtr
(
0
10
)
;
const
RefPtr
<
MediaData
>
data2
=
CreateDataRawPtr
(
11
20
)
;
const
RefPtr
<
MediaData
>
data3
=
CreateDataRawPtr
(
21
30
)
;
queue
.
Push
(
data1
.
get
(
)
)
;
queue
.
Push
(
data2
.
get
(
)
)
;
queue
.
Push
(
data3
.
get
(
)
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
3
)
;
rv
=
queue
.
PopFront
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
2
)
;
EXPECT_EQ
(
rv
data1
)
;
rv
=
queue
.
PopBack
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
EXPECT_EQ
(
rv
data3
)
;
rv
=
queue
.
PopBack
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
0
)
;
EXPECT_EQ
(
rv
data2
)
;
}
TEST
(
MediaQueue
BasicPeekOperations
)
{
MediaQueue
<
MediaData
>
queue
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
0
)
;
const
RefPtr
<
MediaData
>
data1
=
CreateDataRawPtr
(
0
10
)
;
queue
.
Push
(
data1
.
get
(
)
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
RefPtr
<
MediaData
>
rv
=
queue
.
PeekFront
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
EXPECT_EQ
(
rv
data1
)
;
rv
=
queue
.
PeekBack
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
EXPECT_EQ
(
rv
data1
)
;
const
RefPtr
<
MediaData
>
data2
=
CreateDataRawPtr
(
11
20
)
;
const
RefPtr
<
MediaData
>
data3
=
CreateDataRawPtr
(
21
30
)
;
queue
.
Push
(
data2
.
get
(
)
)
;
queue
.
Push
(
data3
.
get
(
)
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
3
)
;
rv
=
queue
.
PeekFront
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
3
)
;
EXPECT_EQ
(
rv
data1
)
;
rv
=
queue
.
PeekBack
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
3
)
;
EXPECT_EQ
(
rv
data3
)
;
}
TEST
(
MediaQueue
FinishQueue
)
{
MediaQueue
<
MediaData
>
queue
;
EXPECT_FALSE
(
queue
.
IsFinished
(
)
)
;
queue
.
Finish
(
)
;
EXPECT_TRUE
(
queue
.
IsFinished
(
)
)
;
}
TEST
(
MediaQueue
EndOfStream
)
{
MediaQueue
<
MediaData
>
queue
;
EXPECT_FALSE
(
queue
.
IsFinished
(
)
)
;
queue
.
Push
(
CreateData
(
0
10
)
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
queue
.
Finish
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
1
)
;
EXPECT_TRUE
(
queue
.
IsFinished
(
)
)
;
EXPECT_FALSE
(
queue
.
AtEndOfStream
(
)
)
;
RefPtr
<
MediaData
>
rv
=
queue
.
PopFront
(
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
0
)
;
EXPECT_TRUE
(
queue
.
IsFinished
(
)
)
;
EXPECT_TRUE
(
queue
.
AtEndOfStream
(
)
)
;
}
TEST
(
MediaQueue
QueueDuration
)
{
MediaQueue
<
MediaData
>
queue
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
0
)
;
queue
.
Push
(
CreateData
(
0
10
)
)
;
queue
.
Push
(
CreateData
(
11
20
)
)
;
queue
.
Push
(
CreateData
(
21
30
)
)
;
EXPECT_EQUAL_SIZE_T
(
queue
.
GetSize
(
)
3
)
;
const
int64_t
rv
=
queue
.
Duration
(
)
;
EXPECT_EQ
(
rv
30
)
;
}
TEST
(
MediaQueue
CallGetElementAfterOnSingleElement
)
{
MediaQueue
<
MediaData
>
queue
;
queue
.
Push
(
CreateData
(
0
10
)
)
;
TimeUnit
targetTime
=
TimeUnit
:
:
FromMicroseconds
(
5
)
;
nsTArray
<
RefPtr
<
MediaData
>
>
foundResult
;
queue
.
GetElementsAfter
(
targetTime
&
foundResult
)
;
EXPECT_EQUAL_SIZE_T
(
foundResult
.
Length
(
)
1
)
;
EXPECT_TRUE
(
foundResult
[
0
]
-
>
GetEndTime
(
)
>
targetTime
)
;
targetTime
=
TimeUnit
:
:
FromMicroseconds
(
15
)
;
nsTArray
<
RefPtr
<
MediaData
>
>
emptyResult
;
queue
.
GetElementsAfter
(
targetTime
&
emptyResult
)
;
EXPECT_TRUE
(
emptyResult
.
IsEmpty
(
)
)
;
}
TEST
(
MediaQueue
CallGetElementAfterOnMultipleElements
)
{
MediaQueue
<
MediaData
>
queue
;
queue
.
Push
(
CreateData
(
0
10
)
)
;
queue
.
Push
(
CreateData
(
11
20
)
)
;
queue
.
Push
(
CreateData
(
21
30
)
)
;
queue
.
Push
(
CreateData
(
31
40
)
)
;
queue
.
Push
(
CreateData
(
41
50
)
)
;
TimeUnit
targetTime
=
TimeUnit
:
:
FromMicroseconds
(
25
)
;
nsTArray
<
RefPtr
<
MediaData
>
>
foundResult
;
queue
.
GetElementsAfter
(
targetTime
&
foundResult
)
;
EXPECT_EQUAL_SIZE_T
(
foundResult
.
Length
(
)
3
)
;
for
(
const
auto
&
data
:
foundResult
)
{
EXPECT_TRUE
(
data
-
>
GetEndTime
(
)
>
targetTime
)
;
}
targetTime
=
TimeUnit
:
:
FromMicroseconds
(
30
)
;
foundResult
.
Clear
(
)
;
queue
.
GetElementsAfter
(
targetTime
&
foundResult
)
;
EXPECT_EQUAL_SIZE_T
(
foundResult
.
Length
(
)
2
)
;
for
(
const
auto
&
data
:
foundResult
)
{
EXPECT_TRUE
(
data
-
>
GetEndTime
(
)
>
targetTime
)
;
}
targetTime
=
TimeUnit
:
:
FromMicroseconds
(
60
)
;
nsTArray
<
RefPtr
<
MediaData
>
>
emptyResult
;
queue
.
GetElementsAfter
(
targetTime
&
emptyResult
)
;
EXPECT_TRUE
(
emptyResult
.
IsEmpty
(
)
)
;
}
#
undef
EXPECT_EQUAL_SIZE_T
