#
include
"
MockGraphInterface
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
gtest
/
WaitFor
.
h
"
using
namespace
mozilla
;
using
testing
:
:
InSequence
;
using
testing
:
:
Return
;
TEST
(
TestOfflineClockDriver
TimeAdvance
)
MOZ_CAN_RUN_SCRIPT_BOUNDARY
{
TrackRate
rate
=
CubebUtils
:
:
PreferredSampleRate
(
false
)
;
RefPtr
graph
=
new
MockGraphInterface
(
rate
)
;
RefPtr
driver
=
new
OfflineClockDriver
(
graph
rate
)
;
MozPromiseHolder
<
GenericPromise
>
doneHolder
;
RefPtr
<
GenericPromise
>
done
=
doneHolder
.
Ensure
(
__func__
)
;
{
GraphTime
length
=
WEBAUDIO_BLOCK_SIZE
/
4
;
auto
EnsureNextIteration
=
[
&
]
(
GraphTime
aTime
)
{
driver
-
>
EnsureNextIteration
(
)
;
}
;
InSequence
s
;
EXPECT_CALL
(
*
graph
MockIteration
(
0
)
)
.
WillOnce
(
EnsureNextIteration
)
.
WillOnce
(
[
&
]
(
GraphTime
aTime
)
{
driver
-
>
SetTickCountToRender
(
length
)
;
driver
-
>
EnsureNextIteration
(
)
;
}
)
;
EXPECT_CALL
(
*
graph
MockIteration
(
WEBAUDIO_BLOCK_SIZE
)
)
.
WillOnce
(
EnsureNextIteration
)
.
WillOnce
(
[
&
]
(
GraphTime
aTime
)
{
graph
-
>
StopIterating
(
)
;
doneHolder
.
Resolve
(
true
__func__
)
;
}
)
;
}
graph
-
>
SetCurrentDriver
(
driver
)
;
driver
-
>
EnsureNextIteration
(
)
;
driver
-
>
Start
(
)
;
WaitForResolve
(
done
)
;
driver
-
>
Shutdown
(
)
;
}
