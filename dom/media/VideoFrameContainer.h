#
ifndef
VIDEOFRAMECONTAINER_H_
#
define
VIDEOFRAMECONTAINER_H_
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
gfxPoint
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
ImageContainer
.
h
"
#
include
"
MediaSegment
.
h
"
#
include
"
MediaStreamVideoSink
.
h
"
#
include
"
VideoSegment
.
h
"
namespace
mozilla
{
namespace
dom
{
class
HTMLMediaElement
;
}
class
VideoFrameContainer
:
public
MediaStreamVideoSink
{
virtual
~
VideoFrameContainer
(
)
;
public
:
typedef
layers
:
:
ImageContainer
ImageContainer
;
typedef
layers
:
:
Image
Image
;
VideoFrameContainer
(
dom
:
:
HTMLMediaElement
*
aElement
already_AddRefed
<
ImageContainer
>
aContainer
)
;
virtual
void
SetCurrentFrames
(
const
VideoSegment
&
aSegment
)
override
;
virtual
void
ClearFrames
(
)
override
;
void
SetCurrentFrame
(
const
gfx
:
:
IntSize
&
aIntrinsicSize
Image
*
aImage
const
TimeStamp
&
aTargetTime
)
;
PrincipalHandle
GetLastPrincipalHandle
(
)
;
void
UpdatePrincipalHandleForFrameID
(
const
PrincipalHandle
&
aPrincipalHandle
const
ImageContainer
:
:
FrameID
&
aFrameID
)
;
void
SetCurrentFrames
(
const
gfx
:
:
IntSize
&
aIntrinsicSize
const
nsTArray
<
ImageContainer
:
:
NonOwningImage
>
&
aImages
)
;
void
ClearCurrentFrame
(
const
gfx
:
:
IntSize
&
aIntrinsicSize
)
{
SetCurrentFrames
(
aIntrinsicSize
nsTArray
<
ImageContainer
:
:
NonOwningImage
>
(
)
)
;
}
VideoFrameContainer
*
AsVideoFrameContainer
(
)
override
{
return
this
;
}
void
ClearCurrentFrame
(
)
;
void
ClearFutureFrames
(
)
;
double
GetFrameDelay
(
)
;
ImageContainer
:
:
FrameID
NewFrameID
(
)
{
return
+
+
mFrameID
;
}
enum
{
INVALIDATE_DEFAULT
INVALIDATE_FORCE
}
;
void
Invalidate
(
)
override
{
InvalidateWithFlags
(
INVALIDATE_DEFAULT
)
;
}
void
InvalidateWithFlags
(
uint32_t
aFlags
)
;
ImageContainer
*
GetImageContainer
(
)
;
void
ForgetElement
(
)
{
mElement
=
nullptr
;
}
uint32_t
GetDroppedImageCount
(
)
{
return
mImageContainer
-
>
GetDroppedImageCount
(
)
;
}
protected
:
void
SetCurrentFramesLocked
(
const
gfx
:
:
IntSize
&
aIntrinsicSize
const
nsTArray
<
ImageContainer
:
:
NonOwningImage
>
&
aImages
)
;
dom
:
:
HTMLMediaElement
*
mElement
;
RefPtr
<
ImageContainer
>
mImageContainer
;
Mutex
mMutex
;
RefPtr
<
Image
>
mBlackImage
;
gfx
:
:
IntSize
mIntrinsicSize
;
ImageContainer
:
:
FrameID
mFrameID
;
VideoFrame
mLastPlayedVideoFrame
;
bool
mIntrinsicSizeChanged
;
bool
mImageSizeChanged
;
PrincipalHandle
mLastPrincipalHandle
;
PrincipalHandle
mPendingPrincipalHandle
;
ImageContainer
:
:
FrameID
mFrameIDForPendingPrincipalHandle
;
}
;
}
#
endif
