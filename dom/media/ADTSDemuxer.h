#
ifndef
ADTS_DEMUXER_H_
#
define
ADTS_DEMUXER_H_
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
MediaDataDemuxer
.
h
"
#
include
"
MediaResource
.
h
"
#
include
"
mp4_demuxer
/
ByteReader
.
h
"
namespace
mozilla
{
namespace
adts
{
class
Frame
;
class
FrameParser
;
}
class
ADTSTrackDemuxer
;
class
ADTSDemuxer
:
public
MediaDataDemuxer
{
public
:
explicit
ADTSDemuxer
(
MediaResource
*
aSource
)
;
RefPtr
<
InitPromise
>
Init
(
)
override
;
bool
HasTrackType
(
TrackInfo
:
:
TrackType
aType
)
const
override
;
uint32_t
GetNumberTracks
(
TrackInfo
:
:
TrackType
aType
)
const
override
;
already_AddRefed
<
MediaTrackDemuxer
>
GetTrackDemuxer
(
TrackInfo
:
:
TrackType
aType
uint32_t
aTrackNumber
)
override
;
bool
IsSeekable
(
)
const
override
;
private
:
bool
InitInternal
(
)
;
RefPtr
<
MediaResource
>
mSource
;
RefPtr
<
ADTSTrackDemuxer
>
mTrackDemuxer
;
}
;
class
ADTSTrackDemuxer
:
public
MediaTrackDemuxer
{
public
:
explicit
ADTSTrackDemuxer
(
MediaResource
*
aSource
)
;
bool
Init
(
)
;
int64_t
StreamLength
(
)
const
;
media
:
:
TimeUnit
Duration
(
)
const
;
media
:
:
TimeUnit
Duration
(
int64_t
aNumFrames
)
const
;
UniquePtr
<
TrackInfo
>
GetInfo
(
)
const
override
;
RefPtr
<
SeekPromise
>
Seek
(
media
:
:
TimeUnit
aTime
)
override
;
RefPtr
<
SamplesPromise
>
GetSamples
(
int32_t
aNumSamples
=
1
)
override
;
void
Reset
(
)
override
;
RefPtr
<
SkipAccessPointPromise
>
SkipToNextRandomAccessPoint
(
media
:
:
TimeUnit
aTimeThreshold
)
override
;
int64_t
GetResourceOffset
(
)
const
override
;
media
:
:
TimeIntervals
GetBuffered
(
)
override
;
private
:
~
ADTSTrackDemuxer
(
)
;
media
:
:
TimeUnit
FastSeek
(
const
media
:
:
TimeUnit
&
aTime
)
;
media
:
:
TimeUnit
ScanUntil
(
const
media
:
:
TimeUnit
&
aTime
)
;
const
adts
:
:
Frame
&
FindNextFrame
(
bool
findFirstFrame
=
false
)
;
bool
SkipNextFrame
(
const
adts
:
:
Frame
&
aFrame
)
;
already_AddRefed
<
MediaRawData
>
GetNextFrame
(
const
adts
:
:
Frame
&
aFrame
)
;
void
UpdateState
(
const
adts
:
:
Frame
&
aFrame
)
;
int64_t
FrameIndexFromOffset
(
int64_t
aOffset
)
const
;
int64_t
FrameIndexFromTime
(
const
media
:
:
TimeUnit
&
aTime
)
const
;
int32_t
Read
(
uint8_t
*
aBuffer
int64_t
aOffset
int32_t
aSize
)
;
double
AverageFrameLength
(
)
const
;
MediaResourceIndex
mSource
;
adts
:
:
FrameParser
*
mParser
;
int64_t
mOffset
;
uint64_t
mNumParsedFrames
;
int64_t
mFrameIndex
;
uint64_t
mTotalFrameLen
;
uint32_t
mSamplesPerFrame
;
uint32_t
mSamplesPerSecond
;
uint32_t
mChannels
;
UniquePtr
<
AudioInfo
>
mInfo
;
}
;
}
#
endif
