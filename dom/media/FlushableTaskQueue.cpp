#
include
"
FlushableTaskQueue
.
h
"
namespace
mozilla
{
void
FlushableTaskQueue
:
:
Flush
(
)
{
MonitorAutoLock
mon
(
mQueueMonitor
)
;
AutoSetFlushing
autoFlush
(
this
)
;
FlushLocked
(
)
;
AwaitIdleLocked
(
)
;
}
nsresult
FlushableTaskQueue
:
:
FlushAndDispatch
(
already_AddRefed
<
nsIRunnable
>
aRunnable
)
{
nsCOMPtr
<
nsIRunnable
>
r
=
aRunnable
;
{
MonitorAutoLock
mon
(
mQueueMonitor
)
;
AutoSetFlushing
autoFlush
(
this
)
;
FlushLocked
(
)
;
nsresult
rv
=
DispatchLocked
(
r
IgnoreFlushing
AssertDispatchSuccess
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
AwaitIdleLocked
(
)
;
}
return
NS_OK
;
}
void
FlushableTaskQueue
:
:
FlushLocked
(
)
{
MOZ_ASSERT_IF
(
AbstractThread
:
:
GetCurrent
(
)
!
AbstractThread
:
:
GetCurrent
(
)
-
>
TailDispatcher
(
)
.
HasTasksFor
(
this
)
)
;
mQueueMonitor
.
AssertCurrentThreadOwns
(
)
;
MOZ_ASSERT
(
mIsFlushing
)
;
while
(
!
mTasks
.
empty
(
)
)
{
mTasks
.
pop
(
)
;
}
}
}
