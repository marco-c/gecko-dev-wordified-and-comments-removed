#
include
"
mozilla
/
dom
/
CrashReport
.
h
"
#
include
"
mozilla
/
dom
/
Navigator
.
h
"
#
include
"
mozilla
/
dom
/
ReportingHeader
.
h
"
#
include
"
mozilla
/
dom
/
ReportDeliver
.
h
"
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsIURIMutator
.
h
"
#
include
"
nsString
.
h
"
namespace
mozilla
{
namespace
dom
{
struct
StringWriteFunc
:
public
JSONWriteFunc
{
nsCString
&
mCString
;
explicit
StringWriteFunc
(
nsCString
&
aCString
)
:
mCString
(
aCString
)
{
}
void
Write
(
const
char
*
aStr
)
override
{
mCString
.
Append
(
aStr
)
;
}
}
;
bool
CrashReport
:
:
Deliver
(
nsIPrincipal
*
aPrincipal
bool
aIsOOM
)
{
MOZ_ASSERT
(
aPrincipal
)
;
nsAutoCString
endpoint_url
;
ReportingHeader
:
:
GetEndpointForReport
(
NS_LITERAL_STRING
(
"
default
"
)
aPrincipal
endpoint_url
)
;
if
(
endpoint_url
.
IsEmpty
(
)
)
{
return
false
;
}
nsCOMPtr
<
nsIURI
>
origin_uri
;
nsresult
rv
=
aPrincipal
-
>
GetURI
(
getter_AddRefs
(
origin_uri
)
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
NS_ENSURE_TRUE
(
origin_uri
false
)
;
nsCOMPtr
<
nsIURI
>
safe_origin_uri
;
rv
=
NS_MutateURI
(
origin_uri
)
.
SetUserPass
(
EmptyCString
(
)
)
.
Finalize
(
safe_origin_uri
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
NS_ENSURE_TRUE
(
safe_origin_uri
false
)
;
nsAutoCString
safe_origin_spec
;
rv
=
safe_origin_uri
-
>
GetSpec
(
safe_origin_spec
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
ReportDeliver
:
:
ReportData
data
;
data
.
mType
=
NS_LITERAL_STRING
(
"
crash
"
)
;
data
.
mGroupName
=
NS_LITERAL_STRING
(
"
default
"
)
;
data
.
mURL
=
NS_ConvertUTF8toUTF16
(
safe_origin_spec
)
;
data
.
mCreationTime
=
TimeStamp
:
:
Now
(
)
;
Navigator
:
:
GetUserAgent
(
nullptr
aPrincipal
false
data
.
mUserAgent
)
;
data
.
mPrincipal
=
aPrincipal
;
data
.
mFailures
=
0
;
data
.
mEndpointURL
=
endpoint_url
;
nsCString
body
;
JSONWriter
writer
{
MakeUnique
<
StringWriteFunc
>
(
body
)
}
;
writer
.
Start
(
)
;
if
(
aIsOOM
)
{
writer
.
StringProperty
(
"
reason
"
"
oom
"
)
;
}
writer
.
End
(
)
;
data
.
mReportBodyJSON
=
body
;
ReportDeliver
:
:
Fetch
(
data
)
;
return
true
;
}
}
}
