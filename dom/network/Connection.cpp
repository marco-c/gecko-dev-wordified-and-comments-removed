#
include
"
Connection
.
h
"
#
include
"
ConnectionMainThread
.
h
"
#
include
"
ConnectionWorker
.
h
"
#
include
"
nsIDOMClassInfo
.
h
"
#
include
"
Constants
.
h
"
#
include
"
WorkerPrivate
.
h
"
#
define
CHANGE_EVENT_NAME
NS_LITERAL_STRING
(
"
typechange
"
)
namespace
mozilla
{
namespace
dom
{
using
namespace
workers
;
namespace
network
{
NS_IMPL_QUERY_INTERFACE_INHERITED
(
Connection
DOMEventTargetHelper
nsINetworkProperties
)
NS_IMPL_ADDREF_INHERITED
(
dom
:
:
network
:
:
Connection
DOMEventTargetHelper
)
NS_IMPL_RELEASE_INHERITED
(
dom
:
:
network
:
:
Connection
DOMEventTargetHelper
)
Connection
:
:
Connection
(
nsPIDOMWindowInner
*
aWindow
)
:
DOMEventTargetHelper
(
aWindow
)
mType
(
static_cast
<
ConnectionType
>
(
kDefaultType
)
)
mIsWifi
(
kDefaultIsWifi
)
mDHCPGateway
(
kDefaultDHCPGateway
)
mBeenShutDown
(
false
)
{
}
Connection
:
:
~
Connection
(
)
{
NS_ASSERT_OWNINGTHREAD
(
Connection
)
;
MOZ_ASSERT
(
mBeenShutDown
)
;
}
void
Connection
:
:
Shutdown
(
)
{
NS_ASSERT_OWNINGTHREAD
(
Connection
)
;
if
(
mBeenShutDown
)
{
return
;
}
mBeenShutDown
=
true
;
ShutdownInternal
(
)
;
}
NS_IMETHODIMP
Connection
:
:
GetIsWifi
(
bool
*
aIsWifi
)
{
NS_ENSURE_ARG_POINTER
(
aIsWifi
)
;
NS_ASSERT_OWNINGTHREAD
(
Connection
)
;
*
aIsWifi
=
mIsWifi
;
return
NS_OK
;
}
NS_IMETHODIMP
Connection
:
:
GetDhcpGateway
(
uint32_t
*
aGW
)
{
NS_ENSURE_ARG_POINTER
(
aGW
)
;
NS_ASSERT_OWNINGTHREAD
(
Connection
)
;
*
aGW
=
mDHCPGateway
;
return
NS_OK
;
}
JSObject
*
Connection
:
:
WrapObject
(
JSContext
*
aCx
JS
:
:
Handle
<
JSObject
*
>
aGivenProto
)
{
return
NetworkInformationBinding
:
:
Wrap
(
aCx
this
aGivenProto
)
;
}
void
Connection
:
:
Update
(
ConnectionType
aType
bool
aIsWifi
bool
aDHCPGateway
bool
aNotify
)
{
NS_ASSERT_OWNINGTHREAD
(
Connection
)
;
ConnectionType
previousType
=
mType
;
mType
=
aType
;
mIsWifi
=
aIsWifi
;
mDHCPGateway
=
aDHCPGateway
;
if
(
aNotify
&
&
previousType
!
=
aType
)
{
DispatchTrustedEvent
(
CHANGE_EVENT_NAME
)
;
}
}
bool
Connection
:
:
IsEnabled
(
JSContext
*
aCx
JSObject
*
aObj
)
{
if
(
NS_IsMainThread
(
)
)
{
return
Preferences
:
:
GetBool
(
"
dom
.
netinfo
.
enabled
"
)
;
}
WorkerPrivate
*
workerPrivate
=
GetWorkerPrivateFromContext
(
aCx
)
;
MOZ_ASSERT
(
workerPrivate
)
;
return
workerPrivate
-
>
NetworkInformationEnabled
(
)
;
}
Connection
*
Connection
:
:
CreateForWindow
(
nsPIDOMWindowInner
*
aWindow
)
{
MOZ_ASSERT
(
aWindow
)
;
return
new
ConnectionMainThread
(
aWindow
)
;
}
already_AddRefed
<
Connection
>
Connection
:
:
CreateForWorker
(
workers
:
:
WorkerPrivate
*
aWorkerPrivate
ErrorResult
&
aRv
)
{
MOZ_ASSERT
(
aWorkerPrivate
)
;
aWorkerPrivate
-
>
AssertIsOnWorkerThread
(
)
;
return
ConnectionWorker
:
:
Create
(
aWorkerPrivate
aRv
)
;
}
}
}
}
