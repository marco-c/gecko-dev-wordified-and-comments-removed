#
include
"
FunctionBrokerParent
.
h
"
#
include
"
FunctionBroker
.
h
"
#
include
"
FunctionBrokerThread
.
h
"
namespace
mozilla
{
namespace
plugins
{
FunctionBrokerParent
*
FunctionBrokerParent
:
:
Create
(
Endpoint
<
PFunctionBrokerParent
>
&
&
aParentEnd
)
{
FunctionBrokerThread
*
thread
=
FunctionBrokerThread
:
:
Create
(
)
;
if
(
!
thread
)
{
return
nullptr
;
}
return
new
FunctionBrokerParent
(
thread
Move
(
aParentEnd
)
)
;
}
FunctionBrokerParent
:
:
FunctionBrokerParent
(
FunctionBrokerThread
*
aThread
Endpoint
<
PFunctionBrokerParent
>
&
&
aParentEnd
)
:
mThread
(
aThread
)
mMonitor
(
"
FunctionBrokerParent
Lock
"
)
mShutdownDone
(
false
)
{
MOZ_ASSERT
(
mThread
)
;
mThread
-
>
Dispatch
(
NewNonOwningRunnableMethod
<
Endpoint
<
PFunctionBrokerParent
>
&
&
>
(
"
FunctionBrokerParent
:
:
Bind
"
this
&
FunctionBrokerParent
:
:
Bind
Move
(
aParentEnd
)
)
)
;
}
void
FunctionBrokerParent
:
:
Bind
(
Endpoint
<
PFunctionBrokerParent
>
&
&
aEnd
)
{
MOZ_RELEASE_ASSERT
(
mThread
-
>
IsOnThread
(
)
)
;
DebugOnly
<
bool
>
ok
=
aEnd
.
Bind
(
this
)
;
MOZ_ASSERT
(
ok
)
;
}
void
FunctionBrokerParent
:
:
ShutdownOnBrokerThread
(
)
{
MOZ_ASSERT
(
mThread
-
>
IsOnThread
(
)
)
;
Close
(
)
;
MonitorAutoLock
lock
(
mMonitor
)
;
mShutdownDone
=
true
;
mMonitor
.
Notify
(
)
;
}
void
FunctionBrokerParent
:
:
Destroy
(
FunctionBrokerParent
*
aInst
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aInst
)
;
{
MonitorAutoLock
lock
(
aInst
-
>
mMonitor
)
;
aInst
-
>
mThread
-
>
Dispatch
(
NewNonOwningRunnableMethod
(
"
FunctionBrokerParent
:
:
ShutdownOnBrokerThread
"
aInst
&
FunctionBrokerParent
:
:
ShutdownOnBrokerThread
)
)
;
while
(
!
aInst
-
>
mShutdownDone
)
{
aInst
-
>
mMonitor
.
Wait
(
)
;
}
}
delete
aInst
;
}
void
FunctionBrokerParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
MOZ_RELEASE_ASSERT
(
mThread
-
>
IsOnThread
(
)
)
;
}
}
}
