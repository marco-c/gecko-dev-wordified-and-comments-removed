ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
function
run_test
(
)
{
const
pluginHost
=
Cc
[
"
mozilla
.
org
/
plugin
/
host
;
1
"
]
.
getService
(
Ci
.
nsIPluginHost
)
;
const
pluginDefaultState
=
Services
.
prefs
.
getIntPref
(
"
plugin
.
default
.
state
"
)
;
Services
.
prefs
.
setBoolPref
(
"
plugin
.
load_flash_only
"
false
)
;
function
reload_plugins_with_allowed_types
(
allowed_types
)
{
if
(
typeof
allowed_types
=
=
=
"
undefined
"
)
{
Services
.
prefs
.
clearUserPref
(
"
plugin
.
allowed_types
"
)
;
}
else
{
Services
.
prefs
.
setCharPref
(
"
plugin
.
allowed_types
"
allowed_types
)
;
}
pluginHost
.
reloadPlugins
(
)
;
}
function
get_status_for_type
(
type
)
{
try
{
return
pluginHost
.
getStateForType
(
type
)
;
}
catch
(
ex
)
{
if
(
ex
.
result
=
=
=
Cr
.
NS_ERROR_NOT_AVAILABLE
)
{
return
undefined
;
}
throw
ex
;
}
}
reload_plugins_with_allowed_types
(
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
Second
-
Test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
nonexistent
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
test
application
/
x
-
Second
-
Test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
Second
-
Test
application
/
x
-
test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
test
application
/
x
-
nonexistent
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
nonexistent
application
/
x
-
test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
undefined
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
test
application
/
x
-
Second
-
Test
application
/
x
-
nonexistent
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
test
application
/
x
-
nonexistent
application
/
x
-
Second
-
Test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
Second
-
Test
application
/
x
-
test
application
/
x
-
nonexistent
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
Second
-
Test
application
/
x
-
nonexistent
application
/
x
-
test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
nonexistent
application
/
x
-
test
application
/
x
-
Second
-
Test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
nonexistent
application
/
x
-
Second
-
Test
application
/
x
-
test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
Second
-
Test
"
)
pluginDefaultState
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
nonexistent
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
APPLICATION
/
X
-
TEST
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
pluginDefaultState
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
APPLICATION
/
X
-
TEST
"
)
pluginDefaultState
)
;
reload_plugins_with_allowed_types
(
"
application
/
x
-
test
-
superset
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
undefined
)
;
reload_plugins_with_allowed_types
(
"
superset
-
application
/
x
-
test
"
)
;
Assert
.
equal
(
get_status_for_type
(
"
application
/
x
-
test
"
)
undefined
)
;
Services
.
prefs
.
clearUserPref
(
"
plugin
.
allowed_types
"
)
;
Services
.
prefs
.
clearUserPref
(
"
plugin
.
importedState
"
)
;
}
