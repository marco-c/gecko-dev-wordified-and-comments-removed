#
ifndef
mozilla_dom_workers_WorkerLoadInfo_h
#
define
mozilla_dom_workers_WorkerLoadInfo_h
#
include
"
mozilla
/
StorageAccess
.
h
"
#
include
"
mozilla
/
dom
/
ChannelInfo
.
h
"
#
include
"
mozilla
/
dom
/
ServiceWorkerRegistrationDescriptor
.
h
"
#
include
"
mozilla
/
dom
/
WorkerCommon
.
h
"
#
include
"
mozilla
/
net
/
ReferrerPolicy
.
h
"
#
include
"
nsIInterfaceRequestor
.
h
"
#
include
"
nsILoadContext
.
h
"
#
include
"
nsIRequest
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsIWeakReferenceUtils
.
h
"
class
nsIChannel
;
class
nsIContentSecurityPolicy
;
class
nsICookieSettings
;
class
nsILoadGroup
;
class
nsIPrincipal
;
class
nsIRunnable
;
class
nsIScriptContext
;
class
nsIBrowserChild
;
class
nsIURI
;
class
nsPIDOMWindowInner
;
namespace
mozilla
{
namespace
ipc
{
class
PrincipalInfo
;
class
CSPInfo
;
}
namespace
dom
{
class
WorkerPrivate
;
struct
WorkerLoadInfoData
{
nsCOMPtr
<
nsIURI
>
mBaseURI
;
nsCOMPtr
<
nsIURI
>
mResolvedScriptURI
;
nsCOMPtr
<
nsIPrincipal
>
mLoadingPrincipal
;
nsCOMPtr
<
nsIPrincipal
>
mPrincipal
;
nsCOMPtr
<
nsIPrincipal
>
mStoragePrincipal
;
nsCOMPtr
<
nsICookieSettings
>
mCookieSettings
;
nsCOMPtr
<
nsIScriptContext
>
mScriptContext
;
nsCOMPtr
<
nsPIDOMWindowInner
>
mWindow
;
nsCOMPtr
<
nsIContentSecurityPolicy
>
mCSP
;
nsAutoPtr
<
mozilla
:
:
ipc
:
:
CSPInfo
>
mCSPInfo
;
nsCOMPtr
<
nsIChannel
>
mChannel
;
nsCOMPtr
<
nsILoadGroup
>
mLoadGroup
;
class
InterfaceRequestor
final
:
public
nsIInterfaceRequestor
{
NS_DECL_ISUPPORTS
public
:
InterfaceRequestor
(
nsIPrincipal
*
aPrincipal
nsILoadGroup
*
aLoadGroup
)
;
void
MaybeAddBrowserChild
(
nsILoadGroup
*
aLoadGroup
)
;
NS_IMETHOD
GetInterface
(
const
nsIID
&
aIID
void
*
*
aSink
)
override
;
void
SetOuterRequestor
(
nsIInterfaceRequestor
*
aOuterRequestor
)
{
MOZ_ASSERT
(
!
mOuterRequestor
)
;
MOZ_ASSERT
(
aOuterRequestor
)
;
mOuterRequestor
=
aOuterRequestor
;
}
private
:
~
InterfaceRequestor
(
)
{
}
already_AddRefed
<
nsIBrowserChild
>
GetAnyLiveBrowserChild
(
)
;
nsCOMPtr
<
nsILoadContext
>
mLoadContext
;
nsCOMPtr
<
nsIInterfaceRequestor
>
mOuterRequestor
;
nsTArray
<
nsWeakPtr
>
mBrowserChildList
;
}
;
RefPtr
<
InterfaceRequestor
>
mInterfaceRequestor
;
nsAutoPtr
<
mozilla
:
:
ipc
:
:
PrincipalInfo
>
mPrincipalInfo
;
nsAutoPtr
<
mozilla
:
:
ipc
:
:
PrincipalInfo
>
mStoragePrincipalInfo
;
nsCString
mDomain
;
nsString
mOrigin
;
nsString
mServiceWorkerCacheName
;
Maybe
<
ServiceWorkerDescriptor
>
mServiceWorkerDescriptor
;
Maybe
<
ServiceWorkerRegistrationDescriptor
>
mServiceWorkerRegistrationDescriptor
;
Maybe
<
ServiceWorkerDescriptor
>
mParentController
;
ChannelInfo
mChannelInfo
;
nsLoadFlags
mLoadFlags
;
uint64_t
mWindowID
;
nsCOMPtr
<
nsIReferrerInfo
>
mReferrerInfo
;
bool
mFromWindow
;
bool
mEvalAllowed
;
bool
mReportCSPViolations
;
bool
mXHRParamsAllowed
;
bool
mPrincipalIsSystem
;
bool
mWatchedByDevtools
;
StorageAccess
mStorageAccess
;
bool
mFirstPartyStorageAccessGranted
;
bool
mServiceWorkersTestingInWindow
;
OriginAttributes
mOriginAttributes
;
enum
{
eNotSet
eInsecureContext
eSecureContext
}
mSecureContext
;
WorkerLoadInfoData
(
)
;
WorkerLoadInfoData
(
WorkerLoadInfoData
&
&
aOther
)
=
default
;
WorkerLoadInfoData
&
operator
=
(
WorkerLoadInfoData
&
&
aOther
)
=
default
;
}
;
struct
WorkerLoadInfo
:
WorkerLoadInfoData
{
WorkerLoadInfo
(
)
;
WorkerLoadInfo
(
WorkerLoadInfo
&
&
aOther
)
noexcept
;
~
WorkerLoadInfo
(
)
;
WorkerLoadInfo
&
operator
=
(
WorkerLoadInfo
&
&
aOther
)
=
default
;
nsresult
SetPrincipalsAndCSPOnMainThread
(
nsIPrincipal
*
aPrincipal
nsIPrincipal
*
aStoragePrincipal
nsILoadGroup
*
aLoadGroup
nsIContentSecurityPolicy
*
aCSP
)
;
nsresult
GetPrincipalsAndLoadGroupFromChannel
(
nsIChannel
*
aChannel
nsIPrincipal
*
*
aPrincipalOut
nsIPrincipal
*
*
aStoragePrincipalOut
nsILoadGroup
*
*
aLoadGroupOut
)
;
nsresult
SetPrincipalsAndCSPFromChannel
(
nsIChannel
*
aChannel
)
;
bool
FinalChannelPrincipalIsValid
(
nsIChannel
*
aChannel
)
;
#
ifdef
MOZ_DIAGNOSTIC_ASSERT_ENABLED
bool
PrincipalIsValid
(
)
const
;
bool
PrincipalURIMatchesScriptURL
(
)
;
#
endif
bool
ProxyReleaseMainThreadObjects
(
WorkerPrivate
*
aWorkerPrivate
)
;
bool
ProxyReleaseMainThreadObjects
(
WorkerPrivate
*
aWorkerPrivate
nsCOMPtr
<
nsILoadGroup
>
&
aLoadGroupToCancel
)
;
}
;
}
}
#
endif
