#
ifndef
mozilla_dom_RemoteWorkerController_h
#
define
mozilla_dom_RemoteWorkerController_h
#
include
"
nsISupportsImpl
.
h
"
namespace
mozilla
{
namespace
dom
{
class
ErrorValue
;
class
MessagePortIdentifier
;
class
RemoteWorkerManager
;
class
RemoteWorkerParent
;
class
RemoteWorkerObserver
{
public
:
NS_INLINE_DECL_PURE_VIRTUAL_REFCOUNTING
virtual
void
CreationFailed
(
)
=
0
;
virtual
void
CreationSucceeded
(
)
=
0
;
virtual
void
ErrorReceived
(
const
ErrorValue
&
aValue
)
=
0
;
virtual
void
Terminated
(
)
=
0
;
}
;
class
RemoteWorkerController
final
{
friend
class
RemoteWorkerManager
;
friend
class
RemoteWorkerParent
;
public
:
NS_INLINE_DECL_REFCOUNTING
(
RemoteWorkerController
)
static
already_AddRefed
<
RemoteWorkerController
>
Create
(
const
RemoteWorkerData
&
aData
RemoteWorkerObserver
*
aObserver
base
:
:
ProcessId
=
0
)
;
void
AddWindowID
(
uint64_t
aWindowID
)
;
void
RemoveWindowID
(
uint64_t
aWindowID
)
;
void
AddPortIdentifier
(
const
MessagePortIdentifier
&
aPortIdentifier
)
;
void
Terminate
(
)
;
void
Suspend
(
)
;
void
Resume
(
)
;
void
Freeze
(
)
;
void
Thaw
(
)
;
private
:
explicit
RemoteWorkerController
(
RemoteWorkerObserver
*
aObserver
)
;
~
RemoteWorkerController
(
)
;
void
SetWorkerActor
(
RemoteWorkerParent
*
aActor
)
;
void
ErrorPropagation
(
const
ErrorValue
&
aValue
)
;
void
WorkerTerminated
(
)
;
void
Shutdown
(
)
;
void
CreationFailed
(
)
;
void
CreationSucceeded
(
)
;
RefPtr
<
RemoteWorkerObserver
>
mObserver
;
RefPtr
<
RemoteWorkerParent
>
mActor
;
enum
{
ePending
eReady
eTerminated
}
mState
;
struct
Op
{
enum
Type
{
eTerminate
eSuspend
eResume
eFreeze
eThaw
ePortIdentifier
eAddWindowID
eRemoveWindowID
}
;
explicit
Op
(
Type
aType
uint64_t
aWindowID
=
0
)
:
mType
(
aType
)
mWindowID
(
aWindowID
)
mCompleted
(
false
)
{
MOZ_COUNT_CTOR
(
Op
)
;
}
explicit
Op
(
const
MessagePortIdentifier
&
aPortIdentifier
)
:
mType
(
ePortIdentifier
)
mPortIdentifier
(
aPortIdentifier
)
mCompleted
(
false
)
{
MOZ_COUNT_CTOR
(
Op
)
;
}
Op
(
Op
const
&
)
=
delete
;
Op
&
operator
=
(
Op
const
&
)
=
delete
;
~
Op
(
)
;
void
Completed
(
)
{
mCompleted
=
true
;
}
Type
mType
;
MessagePortIdentifier
mPortIdentifier
;
uint64_t
mWindowID
;
bool
mCompleted
;
}
;
nsTArray
<
UniquePtr
<
Op
>
>
mPendingOps
;
}
;
}
}
#
endif
