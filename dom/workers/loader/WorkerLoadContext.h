#
ifndef
mozilla_dom_workers_WorkerLoadContext_h__
#
define
mozilla_dom_workers_WorkerLoadContext_h__
#
include
"
nsIChannel
.
h
"
#
include
"
nsIInputStream
.
h
"
#
include
"
nsIRequest
.
h
"
#
include
"
mozilla
/
CORSMode
.
h
"
#
include
"
mozilla
/
dom
/
Promise
.
h
"
#
include
"
js
/
loader
/
ScriptKind
.
h
"
#
include
"
js
/
loader
/
ScriptLoadRequest
.
h
"
#
include
"
js
/
loader
/
LoadContextBase
.
h
"
class
nsIReferrerInfo
;
class
nsIURI
;
namespace
mozilla
:
:
dom
{
class
ClientInfo
;
class
WorkerPrivate
;
namespace
workerinternals
:
:
loader
{
class
CacheCreator
;
class
ScriptLoaderRunnable
;
}
class
WorkerLoadContext
:
public
JS
:
:
loader
:
:
LoadContextBase
{
public
:
enum
Kind
{
MainScript
ImportScript
StaticImport
DebuggerScript
}
;
explicit
WorkerLoadContext
(
Kind
aKind
const
Maybe
<
ClientInfo
>
&
aClientInfo
)
;
bool
IsTopLevel
(
)
{
return
mRequest
-
>
IsTopLevel
(
)
&
&
(
mKind
=
=
Kind
:
:
MainScript
)
;
}
;
static
Kind
GetKind
(
bool
isMainScript
bool
isDebuggerScript
)
{
if
(
isDebuggerScript
)
{
return
Kind
:
:
DebuggerScript
;
}
if
(
isMainScript
)
{
return
Kind
:
:
MainScript
;
}
return
Kind
:
:
ImportScript
;
}
;
Maybe
<
bool
>
mMutedErrorFlag
;
nsresult
mLoadResult
=
NS_ERROR_NOT_INITIALIZED
;
bool
mLoadingFinished
=
false
;
bool
mIsTopLevel
=
true
;
Kind
mKind
;
Maybe
<
ClientInfo
>
mClientInfo
;
nsCOMPtr
<
nsIChannel
>
mChannel
;
nsString
mFullURL
;
RefPtr
<
Promise
>
mCachePromise
;
nsCOMPtr
<
nsIInputStream
>
mCacheReadStream
;
enum
CacheStatus
{
Uncached
WritingToCache
ReadingFromCache
Cached
ToBeCached
Cancel
}
;
CacheStatus
mCacheStatus
=
Uncached
;
bool
IsAwaitingPromise
(
)
const
{
return
bool
(
mCachePromise
)
;
}
}
;
class
ThreadSafeRequestHandle
final
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
ThreadSafeRequestHandle
)
ThreadSafeRequestHandle
(
JS
:
:
loader
:
:
ScriptLoadRequest
*
aRequest
nsISerialEventTarget
*
aSyncTarget
)
;
JS
:
:
loader
:
:
ScriptLoadRequest
*
GetRequest
(
)
const
{
return
mRequest
;
}
WorkerLoadContext
*
GetContext
(
)
{
return
mRequest
-
>
GetWorkerLoadContext
(
)
;
}
bool
IsEmpty
(
)
{
return
!
mRequest
;
}
nsresult
OnStreamComplete
(
nsresult
aStatus
)
;
void
LoadingFinished
(
nsresult
aRv
)
;
void
MaybeExecuteFinishedScripts
(
)
;
bool
IsCancelled
(
)
;
bool
Finished
(
)
{
return
GetContext
(
)
-
>
mLoadingFinished
&
&
!
GetContext
(
)
-
>
IsAwaitingPromise
(
)
;
}
nsresult
GetCancelResult
(
)
;
already_AddRefed
<
JS
:
:
loader
:
:
ScriptLoadRequest
>
ReleaseRequest
(
)
;
workerinternals
:
:
loader
:
:
CacheCreator
*
GetCacheCreator
(
)
;
RefPtr
<
workerinternals
:
:
loader
:
:
ScriptLoaderRunnable
>
mRunnable
;
bool
mExecutionScheduled
=
false
;
private
:
~
ThreadSafeRequestHandle
(
)
;
RefPtr
<
JS
:
:
loader
:
:
ScriptLoadRequest
>
mRequest
;
nsCOMPtr
<
nsISerialEventTarget
>
mOwningEventTarget
;
}
;
}
#
endif
