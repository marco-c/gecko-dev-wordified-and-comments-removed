#
ifndef
nsHtml5SpeculativeLoad_h
#
define
nsHtml5SpeculativeLoad_h
#
include
"
nsString
.
h
"
#
include
"
nsContentUtils
.
h
"
class
nsHtml5TreeOpExecutor
;
enum
eHtml5SpeculativeLoad
{
#
ifdef
DEBUG
eSpeculativeLoadUninitialized
#
endif
eSpeculativeLoadBase
eSpeculativeLoadCSP
eSpeculativeLoadMetaReferrer
eSpeculativeLoadImage
eSpeculativeLoadOpenPicture
eSpeculativeLoadEndPicture
eSpeculativeLoadPictureSource
eSpeculativeLoadScript
eSpeculativeLoadScriptFromHead
eSpeculativeLoadStyle
eSpeculativeLoadManifest
eSpeculativeLoadSetDocumentCharset
eSpeculativeLoadSetDocumentMode
eSpeculativeLoadPreconnect
}
;
class
nsHtml5SpeculativeLoad
{
public
:
nsHtml5SpeculativeLoad
(
)
;
~
nsHtml5SpeculativeLoad
(
)
;
inline
void
InitBase
(
nsHtml5String
aUrl
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadBase
;
aUrl
.
ToString
(
mUrl
)
;
}
inline
void
InitMetaCSP
(
nsHtml5String
aCSP
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadCSP
;
nsString
csp
;
aCSP
.
ToString
(
csp
)
;
mMetaCSP
.
Assign
(
nsContentUtils
:
:
TrimWhitespace
<
nsContentUtils
:
:
IsHTMLWhitespace
>
(
csp
)
)
;
}
inline
void
InitMetaReferrerPolicy
(
nsHtml5String
aReferrerPolicy
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadMetaReferrer
;
nsString
referrerPolicy
;
aReferrerPolicy
.
ToString
(
referrerPolicy
)
;
mReferrerPolicy
.
Assign
(
nsContentUtils
:
:
TrimWhitespace
<
nsContentUtils
:
:
IsHTMLWhitespace
>
(
referrerPolicy
)
)
;
}
inline
void
InitImage
(
nsHtml5String
aUrl
nsHtml5String
aCrossOrigin
nsHtml5String
aReferrerPolicy
nsHtml5String
aSrcset
nsHtml5String
aSizes
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadImage
;
aUrl
.
ToString
(
mUrl
)
;
aCrossOrigin
.
ToString
(
mCrossOrigin
)
;
nsString
referrerPolicy
;
aReferrerPolicy
.
ToString
(
referrerPolicy
)
;
mReferrerPolicy
.
Assign
(
nsContentUtils
:
:
TrimWhitespace
<
nsContentUtils
:
:
IsHTMLWhitespace
>
(
referrerPolicy
)
)
;
aSrcset
.
ToString
(
mSrcset
)
;
aSizes
.
ToString
(
mSizes
)
;
}
inline
void
InitOpenPicture
(
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadOpenPicture
;
}
inline
void
InitEndPicture
(
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadEndPicture
;
}
inline
void
InitPictureSource
(
nsHtml5String
aSrcset
nsHtml5String
aSizes
nsHtml5String
aType
nsHtml5String
aMedia
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadPictureSource
;
aSrcset
.
ToString
(
mSrcset
)
;
aSizes
.
ToString
(
mSizes
)
;
aType
.
ToString
(
mTypeOrCharsetSourceOrDocumentMode
)
;
aMedia
.
ToString
(
mMedia
)
;
}
inline
void
InitScript
(
nsHtml5String
aUrl
nsHtml5String
aCharset
nsHtml5String
aType
nsHtml5String
aCrossOrigin
nsHtml5String
aIntegrity
bool
aParserInHead
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
aParserInHead
?
eSpeculativeLoadScriptFromHead
:
eSpeculativeLoadScript
;
aUrl
.
ToString
(
mUrl
)
;
aCharset
.
ToString
(
mCharset
)
;
aType
.
ToString
(
mTypeOrCharsetSourceOrDocumentMode
)
;
aCrossOrigin
.
ToString
(
mCrossOrigin
)
;
aIntegrity
.
ToString
(
mIntegrity
)
;
}
inline
void
InitStyle
(
nsHtml5String
aUrl
nsHtml5String
aCharset
nsHtml5String
aCrossOrigin
nsHtml5String
aIntegrity
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadStyle
;
aUrl
.
ToString
(
mUrl
)
;
aCharset
.
ToString
(
mCharset
)
;
aCrossOrigin
.
ToString
(
mCrossOrigin
)
;
aIntegrity
.
ToString
(
mIntegrity
)
;
}
inline
void
InitManifest
(
nsHtml5String
aUrl
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadManifest
;
aUrl
.
ToString
(
mUrl
)
;
}
inline
void
InitSetDocumentCharset
(
nsACString
&
aCharset
int32_t
aCharsetSource
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadSetDocumentCharset
;
CopyUTF8toUTF16
(
aCharset
mCharset
)
;
mTypeOrCharsetSourceOrDocumentMode
.
Assign
(
(
char16_t
)
aCharsetSource
)
;
}
inline
void
InitSetDocumentMode
(
nsHtml5DocumentMode
aMode
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadSetDocumentMode
;
mTypeOrCharsetSourceOrDocumentMode
.
Assign
(
(
char16_t
)
aMode
)
;
}
inline
void
InitPreconnect
(
nsHtml5String
aUrl
nsHtml5String
aCrossOrigin
)
{
NS_PRECONDITION
(
mOpCode
=
=
eSpeculativeLoadUninitialized
"
Trying
to
reinitialize
a
speculative
load
!
"
)
;
mOpCode
=
eSpeculativeLoadPreconnect
;
aUrl
.
ToString
(
mUrl
)
;
aCrossOrigin
.
ToString
(
mCrossOrigin
)
;
}
void
Perform
(
nsHtml5TreeOpExecutor
*
aExecutor
)
;
private
:
eHtml5SpeculativeLoad
mOpCode
;
nsString
mUrl
;
nsString
mReferrerPolicy
;
nsString
mMetaCSP
;
nsString
mCharset
;
nsString
mTypeOrCharsetSourceOrDocumentMode
;
nsString
mCrossOrigin
;
nsString
mSrcset
;
nsString
mSizes
;
nsString
mMedia
;
nsString
mIntegrity
;
}
;
#
endif
