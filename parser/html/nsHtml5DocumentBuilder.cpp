#
include
"
nsHtml5DocumentBuilder
.
h
"
#
include
"
nsIStyleSheetLinkingElement
.
h
"
#
include
"
nsStyleLinkElement
.
h
"
#
include
"
nsScriptLoader
.
h
"
#
include
"
nsIHTMLDocument
.
h
"
#
include
"
nsNameSpaceManager
.
h
"
NS_IMPL_CYCLE_COLLECTION_INHERITED
(
nsHtml5DocumentBuilder
nsContentSink
mOwnedElements
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION_INHERITED
(
nsHtml5DocumentBuilder
)
NS_INTERFACE_MAP_END_INHERITING
(
nsContentSink
)
NS_IMPL_ADDREF_INHERITED
(
nsHtml5DocumentBuilder
nsContentSink
)
NS_IMPL_RELEASE_INHERITED
(
nsHtml5DocumentBuilder
nsContentSink
)
nsHtml5DocumentBuilder
:
:
nsHtml5DocumentBuilder
(
bool
aRunsToCompletion
)
:
mBroken
(
NS_OK
)
mFlushState
(
eHtml5FlushState
:
:
eNotFlushing
)
{
mRunsToCompletion
=
aRunsToCompletion
;
}
nsresult
nsHtml5DocumentBuilder
:
:
Init
(
nsIDocument
*
aDoc
nsIURI
*
aURI
nsISupports
*
aContainer
nsIChannel
*
aChannel
)
{
return
nsContentSink
:
:
Init
(
aDoc
aURI
aContainer
aChannel
)
;
}
nsHtml5DocumentBuilder
:
:
~
nsHtml5DocumentBuilder
(
)
{
}
nsresult
nsHtml5DocumentBuilder
:
:
MarkAsBroken
(
nsresult
aReason
)
{
mBroken
=
aReason
;
return
aReason
;
}
void
nsHtml5DocumentBuilder
:
:
SetDocumentCharsetAndSource
(
nsACString
&
aCharset
int32_t
aCharsetSource
)
{
if
(
mDocument
)
{
mDocument
-
>
SetDocumentCharacterSetSource
(
aCharsetSource
)
;
mDocument
-
>
SetDocumentCharacterSet
(
aCharset
)
;
}
}
void
nsHtml5DocumentBuilder
:
:
UpdateStyleSheet
(
nsIContent
*
aElement
)
{
nsCOMPtr
<
nsIStyleSheetLinkingElement
>
ssle
(
do_QueryInterface
(
aElement
)
)
;
if
(
!
ssle
)
{
MOZ_ASSERT
(
nsNameSpaceManager
:
:
GetInstance
(
)
-
>
mSVGDisabled
"
Node
didn
'
t
QI
to
style
but
SVG
wasn
'
t
disabled
.
"
)
;
return
;
}
EndDocUpdate
(
)
;
if
(
MOZ_UNLIKELY
(
!
mParser
)
)
{
return
;
}
ssle
-
>
SetEnableUpdates
(
true
)
;
bool
willNotify
;
bool
isAlternate
;
nsresult
rv
=
ssle
-
>
UpdateStyleSheet
(
mRunsToCompletion
?
nullptr
:
this
&
willNotify
&
isAlternate
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
willNotify
&
&
!
isAlternate
&
&
!
mRunsToCompletion
)
{
+
+
mPendingSheetCount
;
mScriptLoader
-
>
AddParserBlockingScriptExecutionBlocker
(
)
;
}
BeginDocUpdate
(
)
;
}
void
nsHtml5DocumentBuilder
:
:
SetDocumentMode
(
nsHtml5DocumentMode
m
)
{
nsCompatibility
mode
=
eCompatibility_NavQuirks
;
switch
(
m
)
{
case
STANDARDS_MODE
:
mode
=
eCompatibility_FullStandards
;
break
;
case
ALMOST_STANDARDS_MODE
:
mode
=
eCompatibility_AlmostStandards
;
break
;
case
QUIRKS_MODE
:
mode
=
eCompatibility_NavQuirks
;
break
;
}
nsCOMPtr
<
nsIHTMLDocument
>
htmlDocument
=
do_QueryInterface
(
mDocument
)
;
NS_ASSERTION
(
htmlDocument
"
Document
didn
'
t
QI
into
HTML
document
.
"
)
;
htmlDocument
-
>
SetCompatibilityMode
(
mode
)
;
}
void
nsHtml5DocumentBuilder
:
:
UpdateChildCounts
(
)
{
}
nsresult
nsHtml5DocumentBuilder
:
:
FlushTags
(
)
{
return
NS_OK
;
}
