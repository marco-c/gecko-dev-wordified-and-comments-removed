#
ifndef
mozilla_TextServicesDocument_h
#
define
mozilla_TextServicesDocument_h
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsCycleCollectionParticipant
.
h
"
#
include
"
nsIEditActionListener
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsStringFwd
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nscore
.
h
"
class
nsComposeTxtSrvFilter
;
class
nsIContent
;
class
nsIContentIterator
;
class
nsIEditor
;
class
nsINode
;
class
nsISelectionController
;
class
nsRange
;
namespace
mozilla
{
class
OffsetEntry
;
class
TextEditor
;
namespace
dom
{
class
Elemenent
;
}
;
class
TextServicesDocument
final
:
public
nsIEditActionListener
{
private
:
enum
class
IteratorStatus
:
uint8_t
{
eDone
=
0
eValid
ePrev
eNext
}
;
nsCOMPtr
<
nsIDocument
>
mDocument
;
nsCOMPtr
<
nsISelectionController
>
mSelCon
;
RefPtr
<
TextEditor
>
mTextEditor
;
nsCOMPtr
<
nsIContentIterator
>
mIterator
;
nsCOMPtr
<
nsIContent
>
mPrevTextBlock
;
nsCOMPtr
<
nsIContent
>
mNextTextBlock
;
nsTArray
<
OffsetEntry
*
>
mOffsetTable
;
RefPtr
<
nsRange
>
mExtent
;
RefPtr
<
nsComposeTxtSrvFilter
>
mTxtSvcFilter
;
int32_t
mSelStartIndex
;
int32_t
mSelStartOffset
;
int32_t
mSelEndIndex
;
int32_t
mSelEndOffset
;
IteratorStatus
mIteratorStatus
;
protected
:
virtual
~
TextServicesDocument
(
)
;
public
:
TextServicesDocument
(
)
;
NS_DECL_CYCLE_COLLECTING_ISUPPORTS
NS_DECL_CYCLE_COLLECTION_CLASS
(
TextServicesDocument
)
nsresult
InitWithEditor
(
nsIEditor
*
aEditor
)
;
nsresult
SetExtent
(
nsRange
*
aRange
)
;
nsresult
ExpandRangeToWordBoundaries
(
nsRange
*
aRange
)
;
nsresult
SetFilter
(
nsComposeTxtSrvFilter
*
aFilter
)
;
nsresult
GetCurrentTextBlock
(
nsString
*
aStr
)
;
nsresult
FirstBlock
(
)
;
enum
class
BlockSelectionStatus
{
eBlockNotFound
=
0
eBlockOutside
eBlockInside
eBlockContains
eBlockPartial
}
;
nsresult
LastSelectedBlock
(
BlockSelectionStatus
*
aSelStatus
int32_t
*
aSelOffset
int32_t
*
aSelLength
)
;
nsresult
PrevBlock
(
)
;
nsresult
NextBlock
(
)
;
nsresult
IsDone
(
bool
*
aIsDone
)
;
nsresult
SetSelection
(
int32_t
aOffset
int32_t
aLength
)
;
nsresult
ScrollSelectionIntoView
(
)
;
nsresult
DeleteSelection
(
)
;
nsresult
InsertText
(
const
nsString
*
aText
)
;
NS_DECL_NSIEDITACTIONLISTENER
void
DidDeleteNode
(
nsINode
*
aChild
)
;
void
DidJoinNodes
(
nsINode
&
aLeftNode
nsINode
&
aRightNode
)
;
static
nsresult
GetRangeEndPoints
(
nsRange
*
aRange
nsINode
*
*
aStartContainer
int32_t
*
aStartOffset
nsINode
*
*
aEndContainer
int32_t
*
aEndOffset
)
;
private
:
nsresult
CreateContentIterator
(
nsRange
*
aRange
nsIContentIterator
*
*
aIterator
)
;
dom
:
:
Element
*
GetDocumentContentRootNode
(
)
const
;
already_AddRefed
<
nsRange
>
CreateDocumentContentRange
(
)
;
already_AddRefed
<
nsRange
>
CreateDocumentContentRootToNodeOffsetRange
(
nsINode
*
aParent
uint32_t
aOffset
bool
aToStart
)
;
nsresult
CreateDocumentContentIterator
(
nsIContentIterator
*
*
aIterator
)
;
nsresult
AdjustContentIterator
(
)
;
static
nsresult
FirstTextNode
(
nsIContentIterator
*
aIterator
IteratorStatus
*
aIteratorStatus
)
;
static
nsresult
LastTextNode
(
nsIContentIterator
*
aIterator
IteratorStatus
*
aIteratorStatus
)
;
static
nsresult
FirstTextNodeInCurrentBlock
(
nsIContentIterator
*
aIterator
)
;
static
nsresult
FirstTextNodeInPrevBlock
(
nsIContentIterator
*
aIterator
)
;
static
nsresult
FirstTextNodeInNextBlock
(
nsIContentIterator
*
aIterator
)
;
nsresult
GetFirstTextNodeInPrevBlock
(
nsIContent
*
*
aContent
)
;
nsresult
GetFirstTextNodeInNextBlock
(
nsIContent
*
*
aContent
)
;
static
bool
IsBlockNode
(
nsIContent
*
aContent
)
;
static
bool
IsTextNode
(
nsIContent
*
aContent
)
;
static
bool
DidSkip
(
nsIContentIterator
*
aFilteredIter
)
;
static
void
ClearDidSkip
(
nsIContentIterator
*
aFilteredIter
)
;
static
bool
HasSameBlockNodeParent
(
nsIContent
*
aContent1
nsIContent
*
aContent2
)
;
nsresult
SetSelectionInternal
(
int32_t
aOffset
int32_t
aLength
bool
aDoUpdate
)
;
nsresult
GetSelection
(
BlockSelectionStatus
*
aSelStatus
int32_t
*
aSelOffset
int32_t
*
aSelLength
)
;
nsresult
GetCollapsedSelection
(
BlockSelectionStatus
*
aSelStatus
int32_t
*
aSelOffset
int32_t
*
aSelLength
)
;
nsresult
GetUncollapsedSelection
(
BlockSelectionStatus
*
aSelStatus
int32_t
*
aSelOffset
int32_t
*
aSelLength
)
;
bool
SelectionIsCollapsed
(
)
;
bool
SelectionIsValid
(
)
;
static
nsresult
CreateOffsetTable
(
nsTArray
<
OffsetEntry
*
>
*
aOffsetTable
nsIContentIterator
*
aIterator
IteratorStatus
*
aIteratorStatus
nsRange
*
aIterRange
nsString
*
aStr
)
;
static
nsresult
ClearOffsetTable
(
nsTArray
<
OffsetEntry
*
>
*
aOffsetTable
)
;
static
nsresult
NodeHasOffsetEntry
(
nsTArray
<
OffsetEntry
*
>
*
aOffsetTable
nsINode
*
aNode
bool
*
aHasEntry
int32_t
*
aEntryIndex
)
;
nsresult
RemoveInvalidOffsetEntries
(
)
;
nsresult
SplitOffsetEntry
(
int32_t
aTableIndex
int32_t
aOffsetIntoEntry
)
;
static
nsresult
FindWordBounds
(
nsTArray
<
OffsetEntry
*
>
*
aOffsetTable
nsString
*
aBlockStr
nsINode
*
aNode
int32_t
aNodeOffset
nsINode
*
*
aWordStartNode
int32_t
*
aWordStartOffset
nsINode
*
*
aWordEndNode
int32_t
*
aWordEndOffset
)
;
}
;
}
#
endif
