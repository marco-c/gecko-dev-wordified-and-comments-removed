#
include
"
mozilla
/
HTMLEditor
.
h
"
#
include
"
mozilla
/
HTMLEditorCommands
.
h
"
#
include
"
mozilla
/
TextEditor
.
h
"
#
include
"
nsCommandParams
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsCRT
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsIDocShell
.
h
"
#
include
"
nsIDocument
.
h
"
#
include
"
nsIEditingSession
.
h
"
#
include
"
nsIEditor
.
h
"
#
include
"
nsIPlaintextEditor
.
h
"
#
include
"
nsIPresShell
.
h
"
#
include
"
nsISelectionController
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsISupportsUtils
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nscore
.
h
"
class
nsISupports
;
#
define
STATE_ENABLED
"
state_enabled
"
#
define
STATE_ALL
"
state_all
"
#
define
STATE_ATTRIBUTE
"
state_attribute
"
#
define
STATE_DATA
"
state_data
"
namespace
mozilla
{
NS_IMETHODIMP
SetDocumentOptionsCommand
:
:
IsCommandEnabled
(
const
char
*
aCommandName
nsISupports
*
refCon
bool
*
outCmdEnabled
)
{
if
(
NS_WARN_IF
(
!
outCmdEnabled
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
refCon
)
;
if
(
!
editor
)
{
*
outCmdEnabled
=
false
;
return
NS_OK
;
}
TextEditor
*
textEditor
=
editor
-
>
AsTextEditor
(
)
;
MOZ_ASSERT
(
textEditor
)
;
*
outCmdEnabled
=
textEditor
-
>
IsSelectionEditable
(
)
;
return
NS_OK
;
}
NS_IMETHODIMP
SetDocumentOptionsCommand
:
:
DoCommand
(
const
char
*
aCommandName
nsISupports
*
refCon
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
NS_IMETHODIMP
SetDocumentOptionsCommand
:
:
DoCommandParams
(
const
char
*
aCommandName
nsICommandParams
*
aParams
nsISupports
*
refCon
)
{
if
(
NS_WARN_IF
(
!
aParams
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
refCon
)
;
if
(
NS_WARN_IF
(
!
editor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
TextEditor
*
textEditor
=
editor
-
>
AsTextEditor
(
)
;
MOZ_ASSERT
(
textEditor
)
;
RefPtr
<
nsPresContext
>
presContext
=
textEditor
-
>
GetPresContext
(
)
;
if
(
NS_WARN_IF
(
!
presContext
)
)
{
return
NS_ERROR_FAILURE
;
}
nsCommandParams
*
params
=
aParams
-
>
AsCommandParams
(
)
;
IgnoredErrorResult
error
;
int32_t
animationMode
=
params
-
>
GetInt
(
"
imageAnimation
"
error
)
;
if
(
!
error
.
Failed
(
)
)
{
presContext
-
>
SetImageAnimationMode
(
animationMode
)
;
}
else
{
error
.
SuppressException
(
)
;
}
bool
allowPlugins
=
params
-
>
GetBool
(
"
plugins
"
error
)
;
if
(
error
.
Failed
(
)
)
{
return
NS_OK
;
}
nsCOMPtr
<
nsIDocShell
>
docShell
(
presContext
-
>
GetDocShell
(
)
)
;
if
(
NS_WARN_IF
(
!
docShell
)
)
{
return
NS_ERROR_FAILURE
;
}
nsresult
rv
=
docShell
-
>
SetAllowPlugins
(
allowPlugins
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
NS_IMETHODIMP
SetDocumentOptionsCommand
:
:
GetCommandStateParams
(
const
char
*
aCommandName
nsICommandParams
*
aParams
nsISupports
*
refCon
)
{
if
(
NS_WARN_IF
(
!
aParams
)
|
|
NS_WARN_IF
(
!
refCon
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
refCon
)
;
if
(
NS_WARN_IF
(
!
editor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
TextEditor
*
textEditor
=
editor
-
>
AsTextEditor
(
)
;
MOZ_ASSERT
(
textEditor
)
;
nsCommandParams
*
params
=
aParams
-
>
AsCommandParams
(
)
;
bool
outCmdEnabled
=
false
;
IsCommandEnabled
(
aCommandName
refCon
&
outCmdEnabled
)
;
nsresult
rv
=
params
-
>
SetBool
(
STATE_ENABLED
outCmdEnabled
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
RefPtr
<
nsPresContext
>
presContext
=
textEditor
-
>
GetPresContext
(
)
;
if
(
NS_WARN_IF
(
!
presContext
)
)
{
return
NS_ERROR_FAILURE
;
}
IgnoredErrorResult
error
;
Unused
<
<
params
-
>
GetInt
(
"
imageAnimation
"
error
)
;
if
(
!
error
.
Failed
(
)
)
{
rv
=
params
-
>
SetInt
(
"
imageAnimation
"
presContext
-
>
ImageAnimationMode
(
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
}
else
{
error
.
SuppressException
(
)
;
}
bool
allowPlugins
=
params
-
>
GetBool
(
"
plugins
"
error
)
;
if
(
error
.
Failed
(
)
)
{
return
NS_OK
;
}
nsCOMPtr
<
nsIDocShell
>
docShell
(
presContext
-
>
GetDocShell
(
)
)
;
if
(
NS_WARN_IF
(
!
docShell
)
)
{
return
NS_ERROR_FAILURE
;
}
allowPlugins
=
docShell
-
>
PluginsAllowedInCurrentDoc
(
)
;
rv
=
params
-
>
SetBool
(
"
plugins
"
allowPlugins
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
NS_IMETHODIMP
SetDocumentStateCommand
:
:
IsCommandEnabled
(
const
char
*
aCommandName
nsISupports
*
refCon
bool
*
outCmdEnabled
)
{
if
(
NS_WARN_IF
(
!
outCmdEnabled
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
*
outCmdEnabled
=
true
;
return
NS_OK
;
}
NS_IMETHODIMP
SetDocumentStateCommand
:
:
DoCommand
(
const
char
*
aCommandName
nsISupports
*
refCon
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
NS_IMETHODIMP
SetDocumentStateCommand
:
:
DoCommandParams
(
const
char
*
aCommandName
nsICommandParams
*
aParams
nsISupports
*
refCon
)
{
if
(
NS_WARN_IF
(
!
aParams
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
refCon
)
;
if
(
NS_WARN_IF
(
!
editor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
TextEditor
*
textEditor
=
editor
-
>
AsTextEditor
(
)
;
MOZ_ASSERT
(
textEditor
)
;
nsCommandParams
*
params
=
aParams
-
>
AsCommandParams
(
)
;
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_setDocumentModified
"
)
)
{
ErrorResult
error
;
bool
modified
=
params
-
>
GetBool
(
STATE_ATTRIBUTE
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
return
error
.
StealNSResult
(
)
;
}
if
(
modified
)
{
nsresult
rv
=
textEditor
-
>
IncrementModificationCount
(
1
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
nsresult
rv
=
textEditor
-
>
ResetModificationCount
(
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_setDocumentReadOnly
"
)
)
{
ErrorResult
error
;
bool
isReadOnly
=
params
-
>
GetBool
(
STATE_ATTRIBUTE
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
return
error
.
StealNSResult
(
)
;
}
if
(
isReadOnly
)
{
nsresult
rv
=
textEditor
-
>
AddFlags
(
nsIPlaintextEditor
:
:
eEditorReadonlyMask
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
nsresult
rv
=
textEditor
-
>
RemoveFlags
(
nsIPlaintextEditor
:
:
eEditorReadonlyMask
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_setDocumentUseCSS
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
ErrorResult
error
;
bool
desireCSS
=
params
-
>
GetBool
(
STATE_ATTRIBUTE
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
return
error
.
StealNSResult
(
)
;
}
nsresult
rv
=
htmlEditor
-
>
SetIsCSSEnabled
(
desireCSS
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_insertBrOnReturn
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
ErrorResult
error
;
bool
insertBrOnReturn
=
params
-
>
GetBool
(
STATE_ATTRIBUTE
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
return
error
.
StealNSResult
(
)
;
}
nsresult
rv
=
htmlEditor
-
>
SetReturnInParagraphCreatesNewParagraph
(
!
insertBrOnReturn
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_defaultParagraphSeparator
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsAutoCString
newValue
;
nsresult
rv
=
params
-
>
GetCString
(
STATE_ATTRIBUTE
newValue
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
if
(
newValue
.
LowerCaseEqualsLiteral
(
"
div
"
)
)
{
htmlEditor
-
>
SetDefaultParagraphSeparator
(
ParagraphSeparator
:
:
div
)
;
return
NS_OK
;
}
if
(
newValue
.
LowerCaseEqualsLiteral
(
"
p
"
)
)
{
htmlEditor
-
>
SetDefaultParagraphSeparator
(
ParagraphSeparator
:
:
p
)
;
return
NS_OK
;
}
if
(
newValue
.
LowerCaseEqualsLiteral
(
"
br
"
)
)
{
htmlEditor
-
>
SetDefaultParagraphSeparator
(
ParagraphSeparator
:
:
br
)
;
return
NS_OK
;
}
NS_WARNING
(
"
Invalid
default
paragraph
separator
"
)
;
return
NS_ERROR_UNEXPECTED
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_enableObjectResizing
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
ErrorResult
error
;
bool
enabled
=
params
-
>
GetBool
(
STATE_ATTRIBUTE
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
return
error
.
StealNSResult
(
)
;
}
htmlEditor
-
>
EnableObjectResizer
(
enabled
)
;
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_enableInlineTableEditing
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
ErrorResult
error
;
bool
enabled
=
params
-
>
GetBool
(
STATE_ATTRIBUTE
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
return
error
.
StealNSResult
(
)
;
}
htmlEditor
-
>
EnableInlineTableEditor
(
enabled
)
;
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_enableAbsolutePositionEditing
"
)
)
{
NS_ENSURE_ARG_POINTER
(
aParams
)
;
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
ErrorResult
error
;
bool
enabled
=
params
-
>
GetBool
(
STATE_ATTRIBUTE
error
)
;
if
(
NS_WARN_IF
(
error
.
Failed
(
)
)
)
{
return
error
.
StealNSResult
(
)
;
}
htmlEditor
-
>
EnableAbsolutePositionEditor
(
enabled
)
;
return
NS_OK
;
}
return
NS_ERROR_NOT_IMPLEMENTED
;
}
NS_IMETHODIMP
SetDocumentStateCommand
:
:
GetCommandStateParams
(
const
char
*
aCommandName
nsICommandParams
*
aParams
nsISupports
*
refCon
)
{
if
(
NS_WARN_IF
(
!
aParams
)
|
|
NS_WARN_IF
(
!
refCon
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
refCon
)
;
if
(
NS_WARN_IF
(
!
editor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
TextEditor
*
textEditor
=
editor
-
>
AsTextEditor
(
)
;
MOZ_ASSERT
(
textEditor
)
;
nsCommandParams
*
params
=
aParams
-
>
AsCommandParams
(
)
;
bool
outCmdEnabled
=
false
;
IsCommandEnabled
(
aCommandName
refCon
&
outCmdEnabled
)
;
nsresult
rv
=
params
-
>
SetBool
(
STATE_ENABLED
outCmdEnabled
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_setDocumentModified
"
)
)
{
bool
modified
;
rv
=
textEditor
-
>
GetDocumentModified
(
&
modified
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
rv
=
params
-
>
SetBool
(
STATE_ATTRIBUTE
modified
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_setDocumentReadOnly
"
)
)
{
rv
=
params
-
>
SetBool
(
STATE_ATTRIBUTE
textEditor
-
>
IsReadonly
(
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_setDocumentUseCSS
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
rv
=
params
-
>
SetBool
(
STATE_ALL
htmlEditor
-
>
IsCSSEnabled
(
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_insertBrOnReturn
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
bool
createPOnReturn
;
htmlEditor
-
>
GetReturnInParagraphCreatesNewParagraph
(
&
createPOnReturn
)
;
rv
=
params
-
>
SetBool
(
STATE_ATTRIBUTE
!
createPOnReturn
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_defaultParagraphSeparator
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
switch
(
htmlEditor
-
>
GetDefaultParagraphSeparator
(
)
)
{
case
ParagraphSeparator
:
:
div
:
{
DebugOnly
<
nsresult
>
rv
=
params
-
>
SetCString
(
STATE_ATTRIBUTE
NS_LITERAL_CSTRING
(
"
div
"
)
)
;
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
Failed
to
set
command
params
to
return
\
"
div
\
"
"
)
;
return
NS_OK
;
}
case
ParagraphSeparator
:
:
p
:
{
DebugOnly
<
nsresult
>
rv
=
params
-
>
SetCString
(
STATE_ATTRIBUTE
NS_LITERAL_CSTRING
(
"
p
"
)
)
;
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
Failed
to
set
command
params
to
return
\
"
p
\
"
"
)
;
return
NS_OK
;
}
case
ParagraphSeparator
:
:
br
:
{
DebugOnly
<
nsresult
>
rv
=
params
-
>
SetCString
(
STATE_ATTRIBUTE
NS_LITERAL_CSTRING
(
"
br
"
)
)
;
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
Failed
to
set
command
params
to
return
\
"
br
\
"
"
)
;
return
NS_OK
;
}
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Invalid
paragraph
separator
value
"
)
;
return
NS_ERROR_UNEXPECTED
;
}
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_enableObjectResizing
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
rv
=
params
-
>
SetBool
(
STATE_ALL
htmlEditor
-
>
IsObjectResizerEnabled
(
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_enableInlineTableEditing
"
)
)
{
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
rv
=
params
-
>
SetBool
(
STATE_ALL
htmlEditor
-
>
IsInlineTableEditorEnabled
(
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
cmd_enableAbsolutePositionEditing
"
)
)
{
NS_ENSURE_ARG_POINTER
(
aParams
)
;
HTMLEditor
*
htmlEditor
=
textEditor
-
>
AsHTMLEditor
(
)
;
if
(
NS_WARN_IF
(
!
htmlEditor
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
return
params
-
>
SetBool
(
STATE_ALL
htmlEditor
-
>
IsAbsolutePositionEditorEnabled
(
)
)
;
}
return
NS_ERROR_NOT_IMPLEMENTED
;
}
NS_IMETHODIMP
DocumentStateCommand
:
:
IsCommandEnabled
(
const
char
*
aCommandName
nsISupports
*
refCon
bool
*
outCmdEnabled
)
{
if
(
NS_WARN_IF
(
!
outCmdEnabled
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
*
outCmdEnabled
=
false
;
return
NS_OK
;
}
NS_IMETHODIMP
DocumentStateCommand
:
:
DoCommand
(
const
char
*
aCommandName
nsISupports
*
refCon
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
NS_IMETHODIMP
DocumentStateCommand
:
:
DoCommandParams
(
const
char
*
aCommandName
nsICommandParams
*
aParams
nsISupports
*
refCon
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
NS_IMETHODIMP
DocumentStateCommand
:
:
GetCommandStateParams
(
const
char
*
aCommandName
nsICommandParams
*
aParams
nsISupports
*
refCon
)
{
if
(
NS_WARN_IF
(
!
aParams
)
|
|
NS_WARN_IF
(
!
aCommandName
)
)
{
return
NS_ERROR_INVALID_ARG
;
}
nsCommandParams
*
params
=
aParams
-
>
AsCommandParams
(
)
;
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
obs_documentCreated
"
)
)
{
uint32_t
editorStatus
=
nsIEditingSession
:
:
eEditorErrorUnknown
;
nsCOMPtr
<
nsIEditingSession
>
editingSession
=
do_QueryInterface
(
refCon
)
;
if
(
editingSession
)
{
nsresult
rv
=
editingSession
-
>
GetEditorStatus
(
&
editorStatus
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
}
else
{
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
refCon
)
;
if
(
editor
)
{
editorStatus
=
nsIEditingSession
:
:
eEditorOK
;
}
}
DebugOnly
<
nsresult
>
rv
=
params
-
>
SetInt
(
STATE_DATA
editorStatus
)
;
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
"
Failed
to
set
editor
status
"
)
;
return
NS_OK
;
}
if
(
!
nsCRT
:
:
strcmp
(
aCommandName
"
obs_documentLocationChanged
"
)
)
{
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
refCon
)
;
if
(
!
editor
)
{
return
NS_OK
;
}
TextEditor
*
textEditor
=
editor
-
>
AsTextEditor
(
)
;
MOZ_ASSERT
(
textEditor
)
;
nsCOMPtr
<
nsIDocument
>
doc
=
textEditor
-
>
GetDocument
(
)
;
if
(
NS_WARN_IF
(
!
doc
)
)
{
return
NS_ERROR_FAILURE
;
}
nsIURI
*
uri
=
doc
-
>
GetDocumentURI
(
)
;
if
(
NS_WARN_IF
(
!
uri
)
)
{
return
NS_ERROR_FAILURE
;
}
nsresult
rv
=
params
-
>
SetISupports
(
STATE_DATA
uri
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
return
NS_OK
;
}
return
NS_ERROR_NOT_IMPLEMENTED
;
}
}
