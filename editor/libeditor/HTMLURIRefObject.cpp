#
include
"
HTMLURIRefObject
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
mozilla
/
dom
/
Attr
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
nsAString
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsDOMAttributeMap
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsID
.
h
"
#
include
"
nsIDOMElement
.
h
"
#
include
"
nsIDOMNode
.
h
"
#
include
"
nsISupportsUtils
.
h
"
#
include
"
nsString
.
h
"
namespace
mozilla
{
#
define
MATCHES
(
tagName
str
)
tagName
.
EqualsIgnoreCase
(
str
)
HTMLURIRefObject
:
:
HTMLURIRefObject
(
)
:
mCurAttrIndex
(
0
)
mAttributeCnt
(
0
)
{
}
HTMLURIRefObject
:
:
~
HTMLURIRefObject
(
)
{
}
NS_IMPL_ISUPPORTS
(
HTMLURIRefObject
nsIURIRefObject
)
NS_IMETHODIMP
HTMLURIRefObject
:
:
Reset
(
)
{
mCurAttrIndex
=
0
;
return
NS_OK
;
}
NS_IMETHODIMP
HTMLURIRefObject
:
:
GetNextURI
(
nsAString
&
aURI
)
{
NS_ENSURE_TRUE
(
mNode
NS_ERROR_NOT_INITIALIZED
)
;
nsAutoString
tagName
;
nsresult
rv
=
mNode
-
>
GetNodeName
(
tagName
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
!
mAttributes
)
{
nsCOMPtr
<
dom
:
:
Element
>
element
(
do_QueryInterface
(
mNode
)
)
;
NS_ENSURE_TRUE
(
element
NS_ERROR_INVALID_ARG
)
;
mAttributes
=
element
-
>
Attributes
(
)
;
mAttributeCnt
=
mAttributes
-
>
Length
(
)
;
NS_ENSURE_TRUE
(
mAttributeCnt
NS_ERROR_FAILURE
)
;
mCurAttrIndex
=
0
;
}
while
(
mCurAttrIndex
<
mAttributeCnt
)
{
RefPtr
<
dom
:
:
Attr
>
attrNode
=
mAttributes
-
>
Item
(
mCurAttrIndex
+
+
)
;
NS_ENSURE_ARG_POINTER
(
attrNode
)
;
nsString
curAttr
;
rv
=
attrNode
-
>
GetName
(
curAttr
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
MATCHES
(
curAttr
"
href
"
)
)
{
if
(
!
MATCHES
(
tagName
"
a
"
)
&
&
!
MATCHES
(
tagName
"
area
"
)
&
&
!
MATCHES
(
tagName
"
base
"
)
&
&
!
MATCHES
(
tagName
"
link
"
)
)
{
continue
;
}
rv
=
attrNode
-
>
GetValue
(
aURI
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsString
uri
(
aURI
)
;
if
(
aURI
.
First
(
)
!
=
char16_t
(
'
#
'
)
)
{
return
NS_OK
;
}
aURI
.
Truncate
(
)
;
return
NS_ERROR_INVALID_ARG
;
}
else
if
(
MATCHES
(
curAttr
"
src
"
)
)
{
if
(
!
MATCHES
(
tagName
"
img
"
)
&
&
!
MATCHES
(
tagName
"
frame
"
)
&
&
!
MATCHES
(
tagName
"
iframe
"
)
&
&
!
MATCHES
(
tagName
"
input
"
)
&
&
!
MATCHES
(
tagName
"
script
"
)
)
{
continue
;
}
return
attrNode
-
>
GetValue
(
aURI
)
;
}
else
if
(
MATCHES
(
curAttr
"
content
"
)
)
{
if
(
!
MATCHES
(
tagName
"
meta
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
longdesc
"
)
)
{
if
(
!
MATCHES
(
tagName
"
img
"
)
&
&
!
MATCHES
(
tagName
"
frame
"
)
&
&
!
MATCHES
(
tagName
"
iframe
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
usemap
"
)
)
{
if
(
!
MATCHES
(
tagName
"
img
"
)
&
&
!
MATCHES
(
tagName
"
input
"
)
&
&
!
MATCHES
(
tagName
"
object
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
action
"
)
)
{
if
(
!
MATCHES
(
tagName
"
form
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
background
"
)
)
{
if
(
!
MATCHES
(
tagName
"
body
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
codebase
"
)
)
{
if
(
!
MATCHES
(
tagName
"
meta
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
classid
"
)
)
{
if
(
!
MATCHES
(
tagName
"
object
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
data
"
)
)
{
if
(
!
MATCHES
(
tagName
"
object
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
cite
"
)
)
{
if
(
!
MATCHES
(
tagName
"
blockquote
"
)
&
&
!
MATCHES
(
tagName
"
q
"
)
&
&
!
MATCHES
(
tagName
"
del
"
)
&
&
!
MATCHES
(
tagName
"
ins
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
profile
"
)
)
{
if
(
!
MATCHES
(
tagName
"
head
"
)
)
{
continue
;
}
}
else
if
(
MATCHES
(
curAttr
"
archive
"
)
)
{
if
(
!
MATCHES
(
tagName
"
applet
"
)
)
{
continue
;
}
}
}
return
NS_ERROR_NOT_AVAILABLE
;
}
NS_IMETHODIMP
HTMLURIRefObject
:
:
RewriteAllURIs
(
const
nsAString
&
aOldPat
const
nsAString
&
aNewPat
bool
aMakeRel
)
{
return
NS_ERROR_NOT_IMPLEMENTED
;
}
NS_IMETHODIMP
HTMLURIRefObject
:
:
GetNode
(
nsIDOMNode
*
*
aNode
)
{
NS_ENSURE_TRUE
(
mNode
NS_ERROR_NOT_INITIALIZED
)
;
NS_ENSURE_TRUE
(
aNode
NS_ERROR_NULL_POINTER
)
;
*
aNode
=
mNode
.
get
(
)
;
NS_ADDREF
(
*
aNode
)
;
return
NS_OK
;
}
NS_IMETHODIMP
HTMLURIRefObject
:
:
SetNode
(
nsIDOMNode
*
aNode
)
{
mNode
=
aNode
;
nsAutoString
dummyURI
;
if
(
NS_SUCCEEDED
(
GetNextURI
(
dummyURI
)
)
)
{
mCurAttrIndex
=
0
;
return
NS_OK
;
}
mNode
=
nullptr
;
return
NS_ERROR_INVALID_ARG
;
}
}
nsresult
NS_NewHTMLURIRefObject
(
nsIURIRefObject
*
*
aResult
nsIDOMNode
*
aNode
)
{
RefPtr
<
mozilla
:
:
HTMLURIRefObject
>
refObject
=
new
mozilla
:
:
HTMLURIRefObject
(
)
;
nsresult
rv
=
refObject
-
>
SetNode
(
aNode
)
;
if
(
NS_FAILED
(
rv
)
)
{
*
aResult
=
0
;
return
rv
;
}
refObject
.
forget
(
aResult
)
;
return
NS_OK
;
}
