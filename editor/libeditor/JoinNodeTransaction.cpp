#
include
"
JoinNodeTransaction
.
h
"
#
include
"
mozilla
/
EditorBase
.
h
"
#
include
"
nsAString
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
nsIDOMCharacterData
.
h
"
#
include
"
nsIEditor
.
h
"
#
include
"
nsISupportsImpl
.
h
"
namespace
mozilla
{
using
namespace
dom
;
JoinNodeTransaction
:
:
JoinNodeTransaction
(
EditorBase
&
aEditorBase
nsINode
&
aLeftNode
nsINode
&
aRightNode
)
:
mEditorBase
(
aEditorBase
)
mLeftNode
(
&
aLeftNode
)
mRightNode
(
&
aRightNode
)
mOffset
(
0
)
{
}
NS_IMPL_CYCLE_COLLECTION_INHERITED
(
JoinNodeTransaction
EditTransactionBase
mLeftNode
mRightNode
mParent
)
NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION
(
JoinNodeTransaction
)
NS_INTERFACE_MAP_END_INHERITING
(
EditTransactionBase
)
nsresult
JoinNodeTransaction
:
:
CheckValidity
(
)
{
if
(
!
mEditorBase
.
IsModifiableNode
(
mLeftNode
-
>
GetParentNode
(
)
)
)
{
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
NS_IMETHODIMP
JoinNodeTransaction
:
:
DoTransaction
(
)
{
nsCOMPtr
<
nsINode
>
leftParent
=
mLeftNode
-
>
GetParentNode
(
)
;
NS_ENSURE_TRUE
(
leftParent
NS_ERROR_NULL_POINTER
)
;
if
(
leftParent
!
=
mRightNode
-
>
GetParentNode
(
)
)
{
NS_ASSERTION
(
false
"
Nodes
do
not
have
same
parent
"
)
;
return
NS_ERROR_INVALID_ARG
;
}
mParent
=
leftParent
;
mOffset
=
mLeftNode
-
>
Length
(
)
;
return
mEditorBase
.
JoinNodesImpl
(
mRightNode
mLeftNode
mParent
)
;
}
NS_IMETHODIMP
JoinNodeTransaction
:
:
UndoTransaction
(
)
{
MOZ_ASSERT
(
mParent
)
;
ErrorResult
rv
;
if
(
mRightNode
-
>
GetAsText
(
)
)
{
rv
=
mRightNode
-
>
GetAsText
(
)
-
>
DeleteData
(
0
mOffset
)
;
}
else
{
nsCOMPtr
<
nsIContent
>
child
=
mRightNode
-
>
GetFirstChild
(
)
;
for
(
uint32_t
i
=
0
;
i
<
mOffset
;
i
+
+
)
{
if
(
rv
.
Failed
(
)
)
{
return
rv
.
StealNSResult
(
)
;
}
if
(
!
child
)
{
return
NS_ERROR_NULL_POINTER
;
}
nsCOMPtr
<
nsIContent
>
nextSibling
=
child
-
>
GetNextSibling
(
)
;
mLeftNode
-
>
AppendChild
(
*
child
rv
)
;
child
=
nextSibling
;
}
}
nsCOMPtr
<
nsINode
>
refNode
=
mRightNode
;
mParent
-
>
InsertBefore
(
*
mLeftNode
refNode
rv
)
;
return
rv
.
StealNSResult
(
)
;
}
NS_IMETHODIMP
JoinNodeTransaction
:
:
GetTxnDescription
(
nsAString
&
aString
)
{
aString
.
AssignLiteral
(
"
JoinNodeTransaction
"
)
;
return
NS_OK
;
}
}
