#
ifndef
EditorUtils_h
#
define
EditorUtils_h
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsEditor
.
h
"
#
include
"
nsIDOMNode
.
h
"
#
include
"
nsIEditor
.
h
"
#
include
"
nscore
.
h
"
#
include
"
mozilla
/
GuardObjects
.
h
"
class
nsIAtom
;
class
nsIContentIterator
;
class
nsIDOMDocument
;
class
nsIDOMEvent
;
class
nsISimpleEnumerator
;
class
nsITransferable
;
class
nsRange
;
namespace
mozilla
{
template
<
class
T
>
class
OwningNonNull
;
namespace
dom
{
class
Selection
;
}
}
class
MOZ_RAII
nsAutoPlaceHolderBatch
{
private
:
nsCOMPtr
<
nsIEditor
>
mEd
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
public
:
nsAutoPlaceHolderBatch
(
nsIEditor
*
aEd
nsIAtom
*
atom
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
:
mEd
(
do_QueryInterface
(
aEd
)
)
{
MOZ_GUARD_OBJECT_NOTIFIER_INIT
;
if
(
mEd
)
{
mEd
-
>
BeginPlaceHolderTransaction
(
atom
)
;
}
}
~
nsAutoPlaceHolderBatch
(
)
{
if
(
mEd
)
{
mEd
-
>
EndPlaceHolderTransaction
(
)
;
}
}
}
;
class
MOZ_RAII
nsAutoEditBatch
:
public
nsAutoPlaceHolderBatch
{
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
public
:
explicit
nsAutoEditBatch
(
nsIEditor
*
aEd
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
:
nsAutoPlaceHolderBatch
(
aEd
nullptr
)
{
MOZ_GUARD_OBJECT_NOTIFIER_INIT
;
}
~
nsAutoEditBatch
(
)
{
}
}
;
class
MOZ_RAII
nsAutoSelectionReset
{
private
:
RefPtr
<
mozilla
:
:
dom
:
:
Selection
>
mSel
;
nsEditor
*
mEd
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
public
:
nsAutoSelectionReset
(
mozilla
:
:
dom
:
:
Selection
*
aSel
nsEditor
*
aEd
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
;
~
nsAutoSelectionReset
(
)
;
void
Abort
(
)
;
}
;
namespace
mozilla
{
class
MOZ_RAII
AutoRules
final
{
public
:
AutoRules
(
nsEditor
*
aEditor
EditAction
aAction
nsIEditor
:
:
EDirection
aDirection
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
:
mEditor
(
aEditor
)
mDoNothing
(
false
)
{
MOZ_GUARD_OBJECT_NOTIFIER_INIT
;
if
(
mEditor
&
&
!
mEditor
-
>
mAction
)
{
mEditor
-
>
StartOperation
(
aAction
aDirection
)
;
}
else
{
mDoNothing
=
true
;
}
}
~
AutoRules
(
)
{
if
(
mEditor
&
&
!
mDoNothing
)
{
mEditor
-
>
EndOperation
(
)
;
}
}
protected
:
nsEditor
*
mEditor
;
bool
mDoNothing
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
class
MOZ_RAII
AutoTransactionsConserveSelection
final
{
public
:
explicit
AutoTransactionsConserveSelection
(
nsEditor
*
aEditor
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
:
mEditor
(
aEditor
)
mOldState
(
true
)
{
MOZ_GUARD_OBJECT_NOTIFIER_INIT
;
if
(
mEditor
)
{
mOldState
=
mEditor
-
>
GetShouldTxnSetSelection
(
)
;
mEditor
-
>
SetShouldTxnSetSelection
(
false
)
;
}
}
~
AutoTransactionsConserveSelection
(
)
{
if
(
mEditor
)
{
mEditor
-
>
SetShouldTxnSetSelection
(
mOldState
)
;
}
}
protected
:
nsEditor
*
mEditor
;
bool
mOldState
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
class
MOZ_RAII
AutoUpdateViewBatch
final
{
public
:
explicit
AutoUpdateViewBatch
(
nsEditor
*
aEditor
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
:
mEditor
(
aEditor
)
{
MOZ_GUARD_OBJECT_NOTIFIER_INIT
;
NS_ASSERTION
(
mEditor
"
null
mEditor
pointer
!
"
)
;
if
(
mEditor
)
{
mEditor
-
>
BeginUpdateViewBatch
(
)
;
}
}
~
AutoUpdateViewBatch
(
)
{
if
(
mEditor
)
{
mEditor
-
>
EndUpdateViewBatch
(
)
;
}
}
protected
:
nsEditor
*
mEditor
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
class
BoolDomIterFunctor
{
public
:
virtual
bool
operator
(
)
(
nsINode
*
aNode
)
const
=
0
;
}
;
class
MOZ_RAII
DOMIterator
{
public
:
explicit
DOMIterator
(
MOZ_GUARD_OBJECT_NOTIFIER_ONLY_PARAM
)
;
explicit
DOMIterator
(
nsINode
&
aNode
MOZ_GUARD_OBJECT_NOTIFIER_PARAM
)
;
virtual
~
DOMIterator
(
)
;
nsresult
Init
(
nsRange
&
aRange
)
;
void
AppendList
(
const
BoolDomIterFunctor
&
functor
nsTArray
<
mozilla
:
:
OwningNonNull
<
nsINode
>
>
&
arrayOfNodes
)
const
;
protected
:
nsCOMPtr
<
nsIContentIterator
>
mIter
;
MOZ_DECL_USE_GUARD_OBJECT_NOTIFIER
}
;
class
MOZ_RAII
DOMSubtreeIterator
final
:
public
DOMIterator
{
public
:
explicit
DOMSubtreeIterator
(
MOZ_GUARD_OBJECT_NOTIFIER_ONLY_PARAM
)
;
virtual
~
DOMSubtreeIterator
(
)
;
nsresult
Init
(
nsRange
&
aRange
)
;
}
;
class
TrivialFunctor
final
:
public
BoolDomIterFunctor
{
public
:
virtual
bool
operator
(
)
(
nsINode
*
aNode
)
const
{
return
true
;
}
}
;
struct
MOZ_STACK_CLASS
EditorDOMPoint
final
{
nsCOMPtr
<
nsINode
>
node
;
int32_t
offset
;
EditorDOMPoint
(
)
:
node
(
nullptr
)
offset
(
-
1
)
{
}
EditorDOMPoint
(
nsINode
*
aNode
int32_t
aOffset
)
:
node
(
aNode
)
offset
(
aOffset
)
{
}
EditorDOMPoint
(
nsIDOMNode
*
aNode
int32_t
aOffset
)
:
node
(
do_QueryInterface
(
aNode
)
)
offset
(
aOffset
)
{
}
void
SetPoint
(
nsINode
*
aNode
int32_t
aOffset
)
{
node
=
aNode
;
offset
=
aOffset
;
}
void
SetPoint
(
nsIDOMNode
*
aNode
int32_t
aOffset
)
{
node
=
do_QueryInterface
(
aNode
)
;
offset
=
aOffset
;
}
}
;
class
EditorUtils
final
{
public
:
static
bool
IsDescendantOf
(
nsINode
*
aNode
nsINode
*
aParent
int32_t
*
aOffset
=
0
)
;
static
bool
IsDescendantOf
(
nsIDOMNode
*
aNode
nsIDOMNode
*
aParent
int32_t
*
aOffset
=
0
)
;
static
bool
IsLeafNode
(
nsIDOMNode
*
aNode
)
;
}
;
class
EditorHookUtils
final
{
public
:
static
bool
DoInsertionHook
(
nsIDOMDocument
*
aDoc
nsIDOMEvent
*
aEvent
nsITransferable
*
aTrans
)
;
private
:
static
nsresult
GetHookEnumeratorFromDocument
(
nsIDOMDocument
*
aDoc
nsISimpleEnumerator
*
*
aEnumerator
)
;
}
;
}
#
endif
