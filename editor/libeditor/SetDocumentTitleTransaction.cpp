#
include
"
SetDocumentTitleTransaction
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
nsAString
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsIDOMCharacterData
.
h
"
#
include
"
nsIDOMDocument
.
h
"
#
include
"
nsIDOMElement
.
h
"
#
include
"
nsIDOMNode
.
h
"
#
include
"
nsIDOMNodeList
.
h
"
#
include
"
nsIDOMText
.
h
"
#
include
"
nsIDocument
.
h
"
#
include
"
nsIEditor
.
h
"
#
include
"
nsIHTMLEditor
.
h
"
#
include
"
nsLiteralString
.
h
"
namespace
mozilla
{
SetDocumentTitleTransaction
:
:
SetDocumentTitleTransaction
(
)
:
mEditor
(
nullptr
)
mIsTransient
(
false
)
{
}
NS_IMETHODIMP
SetDocumentTitleTransaction
:
:
Init
(
nsIHTMLEditor
*
aEditor
const
nsAString
*
aValue
)
{
NS_ASSERTION
(
aEditor
&
&
aValue
"
null
args
"
)
;
if
(
!
aEditor
|
|
!
aValue
)
{
return
NS_ERROR_NULL_POINTER
;
}
mEditor
=
aEditor
;
mValue
=
*
aValue
;
return
NS_OK
;
}
NS_IMETHODIMP
SetDocumentTitleTransaction
:
:
DoTransaction
(
)
{
return
SetDomTitle
(
mValue
)
;
}
NS_IMETHODIMP
SetDocumentTitleTransaction
:
:
UndoTransaction
(
)
{
return
NS_OK
;
}
NS_IMETHODIMP
SetDocumentTitleTransaction
:
:
RedoTransaction
(
)
{
return
NS_OK
;
}
nsresult
SetDocumentTitleTransaction
:
:
SetDomTitle
(
const
nsAString
&
aTitle
)
{
nsCOMPtr
<
nsIEditor
>
editor
=
do_QueryInterface
(
mEditor
)
;
NS_ENSURE_TRUE
(
editor
NS_ERROR_FAILURE
)
;
nsCOMPtr
<
nsIDOMDocument
>
domDoc
;
nsresult
res
=
editor
-
>
GetDocument
(
getter_AddRefs
(
domDoc
)
)
;
NS_ENSURE_TRUE
(
domDoc
NS_ERROR_FAILURE
)
;
nsCOMPtr
<
nsIDOMNodeList
>
titleList
;
res
=
domDoc
-
>
GetElementsByTagName
(
NS_LITERAL_STRING
(
"
title
"
)
getter_AddRefs
(
titleList
)
)
;
NS_ENSURE_SUCCESS
(
res
res
)
;
mIsTransient
=
true
;
nsCOMPtr
<
nsIDOMNode
>
titleNode
;
if
(
titleList
)
{
res
=
titleList
-
>
Item
(
0
getter_AddRefs
(
titleNode
)
)
;
NS_ENSURE_SUCCESS
(
res
res
)
;
if
(
titleNode
)
{
nsCOMPtr
<
nsIDOMNode
>
child
;
res
=
titleNode
-
>
GetFirstChild
(
getter_AddRefs
(
child
)
)
;
if
(
NS_FAILED
(
res
)
)
return
res
;
if
(
child
)
{
nsCOMPtr
<
nsIDOMCharacterData
>
textNode
=
do_QueryInterface
(
child
)
;
if
(
textNode
)
{
textNode
-
>
GetData
(
mUndoValue
)
;
if
(
mUndoValue
=
=
aTitle
)
return
NS_OK
;
}
res
=
editor
-
>
DeleteNode
(
child
)
;
if
(
NS_FAILED
(
res
)
)
return
res
;
}
}
}
mIsTransient
=
false
;
nsCOMPtr
<
nsIDocument
>
document
=
do_QueryInterface
(
domDoc
)
;
NS_ENSURE_STATE
(
document
)
;
RefPtr
<
dom
:
:
Element
>
headElement
=
document
-
>
GetHeadElement
(
)
;
if
(
NS_WARN_IF
(
!
headElement
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
bool
newTitleNode
=
false
;
uint32_t
newTitleIndex
=
0
;
if
(
!
titleNode
)
{
nsCOMPtr
<
nsIDOMElement
>
titleElement
;
res
=
domDoc
-
>
CreateElement
(
NS_LITERAL_STRING
(
"
title
"
)
getter_AddRefs
(
titleElement
)
)
;
NS_ENSURE_SUCCESS
(
res
res
)
;
NS_ENSURE_TRUE
(
titleElement
NS_ERROR_FAILURE
)
;
titleNode
=
do_QueryInterface
(
titleElement
)
;
newTitleNode
=
true
;
newTitleIndex
=
headElement
-
>
GetChildCount
(
)
;
}
if
(
titleNode
&
&
!
aTitle
.
IsEmpty
(
)
)
{
nsCOMPtr
<
nsIDOMText
>
textNode
;
res
=
domDoc
-
>
CreateTextNode
(
aTitle
getter_AddRefs
(
textNode
)
)
;
NS_ENSURE_SUCCESS
(
res
res
)
;
nsCOMPtr
<
nsIDOMNode
>
newNode
=
do_QueryInterface
(
textNode
)
;
NS_ENSURE_TRUE
(
newNode
NS_ERROR_FAILURE
)
;
if
(
newTitleNode
)
{
nsCOMPtr
<
nsIDOMNode
>
resultNode
;
res
=
titleNode
-
>
AppendChild
(
newNode
getter_AddRefs
(
resultNode
)
)
;
}
else
{
res
=
editor
-
>
InsertNode
(
newNode
titleNode
0
)
;
}
NS_ENSURE_SUCCESS
(
res
res
)
;
headElement
=
nullptr
;
}
if
(
newTitleNode
)
{
if
(
!
headElement
)
{
headElement
=
document
-
>
GetHeadElement
(
)
;
if
(
NS_WARN_IF
(
!
headElement
)
)
{
return
NS_ERROR_UNEXPECTED
;
}
}
res
=
editor
-
>
InsertNode
(
titleNode
headElement
-
>
AsDOMNode
(
)
newTitleIndex
)
;
}
return
res
;
}
NS_IMETHODIMP
SetDocumentTitleTransaction
:
:
GetTxnDescription
(
nsAString
&
aString
)
{
aString
.
AssignLiteral
(
"
SetDocumentTitleTransaction
:
"
)
;
aString
+
=
mValue
;
return
NS_OK
;
}
NS_IMETHODIMP
SetDocumentTitleTransaction
:
:
GetIsTransient
(
bool
*
aIsTransient
)
{
NS_ENSURE_TRUE
(
aIsTransient
NS_ERROR_NULL_POINTER
)
;
*
aIsTransient
=
mIsTransient
;
return
NS_OK
;
}
}
