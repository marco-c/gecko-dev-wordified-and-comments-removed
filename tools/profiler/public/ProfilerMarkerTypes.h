#
ifndef
ProfilerMarkerTypes_h
#
define
ProfilerMarkerTypes_h
#
include
"
mozilla
/
BaseProfilerMarkerTypes
.
h
"
#
include
"
mozilla
/
ProfilerMarkers
.
h
"
#
ifdef
MOZ_GECKO_PROFILER
#
include
"
gfxASurface
.
h
"
#
include
"
js
/
AllocationRecording
.
h
"
#
include
"
js
/
ProfilingFrameIterator
.
h
"
#
include
"
js
/
Utility
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
net
/
HttpBaseChannel
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
ServoTraversalStatistics
.
h
"
namespace
geckoprofiler
:
:
markers
{
using
Tracing
=
mozilla
:
:
baseprofiler
:
:
markers
:
:
Tracing
;
using
UserTimingMark
=
mozilla
:
:
baseprofiler
:
:
markers
:
:
UserTimingMark
;
using
UserTimingMeasure
=
mozilla
:
:
baseprofiler
:
:
markers
:
:
UserTimingMeasure
;
using
MediaSample
=
mozilla
:
:
baseprofiler
:
:
markers
:
:
MediaSample
;
struct
Network
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
Network
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
int64_t
aID
const
mozilla
:
:
ProfilerString8View
&
aURI
NetworkLoadType
aType
const
mozilla
:
:
TimeStamp
&
aStartTime
const
mozilla
:
:
TimeStamp
&
aEndTime
int32_t
aPri
int64_t
aCount
mozilla
:
:
net
:
:
CacheDisposition
aCacheDisposition
uint64_t
aInnerWindowID
const
mozilla
:
:
net
:
:
TimingStruct
&
aTimings
const
mozilla
:
:
ProfilerString8View
&
aRedirectURI
UniqueProfilerBacktrace
aSource
const
mozilla
:
:
ProfilerString8View
&
aContentType
)
{
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
startTime
"
aStartTime
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
endTime
"
aEndTime
)
;
aWriter
.
IntProperty
(
"
id
"
aID
)
;
mozilla
:
:
Span
<
const
char
>
typeString
=
GetNetworkState
(
aType
)
;
mozilla
:
:
Span
<
const
char
>
cacheString
=
GetCacheState
(
aCacheDisposition
)
;
aWriter
.
StringProperty
(
"
status
"
typeString
)
;
if
(
!
cacheString
.
IsEmpty
(
)
)
{
aWriter
.
StringProperty
(
"
cache
"
cacheString
)
;
}
aWriter
.
IntProperty
(
"
pri
"
aPri
)
;
if
(
aCount
>
0
)
{
aWriter
.
IntProperty
(
"
count
"
aCount
)
;
}
if
(
aURI
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
URI
"
aURI
)
;
}
if
(
aRedirectURI
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
RedirectURI
"
aRedirectURI
)
;
}
if
(
aContentType
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
contentType
"
aContentType
)
;
}
else
{
aWriter
.
NullProperty
(
"
contentType
"
)
;
}
if
(
aType
!
=
NetworkLoadType
:
:
LOAD_START
)
{
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
domainLookupStart
"
aTimings
.
domainLookupStart
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
domainLookupEnd
"
aTimings
.
domainLookupEnd
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
connectStart
"
aTimings
.
connectStart
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
tcpConnectEnd
"
aTimings
.
tcpConnectEnd
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
secureConnectionStart
"
aTimings
.
secureConnectionStart
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
connectEnd
"
aTimings
.
connectEnd
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
requestStart
"
aTimings
.
requestStart
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
responseStart
"
aTimings
.
responseStart
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
responseEnd
"
aTimings
.
responseEnd
)
;
}
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
return
mozilla
:
:
MarkerSchema
:
:
SpecialFrontendLocation
{
}
;
}
private
:
static
mozilla
:
:
Span
<
const
char
>
GetNetworkState
(
NetworkLoadType
aType
)
{
switch
(
aType
)
{
case
NetworkLoadType
:
:
LOAD_START
:
return
mozilla
:
:
MakeStringSpan
(
"
STATUS_START
"
)
;
case
NetworkLoadType
:
:
LOAD_STOP
:
return
mozilla
:
:
MakeStringSpan
(
"
STATUS_STOP
"
)
;
case
NetworkLoadType
:
:
LOAD_REDIRECT
:
return
mozilla
:
:
MakeStringSpan
(
"
STATUS_REDIRECT
"
)
;
}
return
mozilla
:
:
MakeStringSpan
(
"
"
)
;
}
static
mozilla
:
:
Span
<
const
char
>
GetCacheState
(
mozilla
:
:
net
:
:
CacheDisposition
aCacheDisposition
)
{
switch
(
aCacheDisposition
)
{
case
mozilla
:
:
net
:
:
kCacheUnresolved
:
return
mozilla
:
:
MakeStringSpan
(
"
Unresolved
"
)
;
case
mozilla
:
:
net
:
:
kCacheHit
:
return
mozilla
:
:
MakeStringSpan
(
"
Hit
"
)
;
case
mozilla
:
:
net
:
:
kCacheHitViaReval
:
return
mozilla
:
:
MakeStringSpan
(
"
HitViaReval
"
)
;
case
mozilla
:
:
net
:
:
kCacheMissedViaReval
:
return
mozilla
:
:
MakeStringSpan
(
"
MissedViaReval
"
)
;
case
mozilla
:
:
net
:
:
kCacheMissed
:
return
mozilla
:
:
MakeStringSpan
(
"
Missed
"
)
;
case
mozilla
:
:
net
:
:
kCacheUnknown
:
default
:
return
mozilla
:
:
MakeStringSpan
(
"
"
)
;
}
}
}
;
struct
ScreenshotPayload
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
CompositorScreenshot
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
ProfilerString8View
&
aScreenshotDataURL
const
mozilla
:
:
gfx
:
:
IntSize
&
aWindowSize
uintptr_t
aWindowIdentifier
)
{
aWriter
.
StringProperty
(
"
url
"
aScreenshotDataURL
)
;
char
hexWindowID
[
32
]
;
SprintfLiteral
(
hexWindowID
"
0x
%
"
PRIXPTR
aWindowIdentifier
)
;
aWriter
.
StringProperty
(
"
windowID
"
hexWindowID
)
;
aWriter
.
DoubleProperty
(
"
windowWidth
"
aWindowSize
.
width
)
;
aWriter
.
DoubleProperty
(
"
windowHeight
"
aWindowSize
.
height
)
;
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
return
mozilla
:
:
MarkerSchema
:
:
SpecialFrontendLocation
{
}
;
}
}
;
struct
GCSlice
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
GCSlice
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
ProfilerString8View
&
aTimingJSON
)
{
if
(
aTimingJSON
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
timings
"
aTimingJSON
)
;
}
else
{
aWriter
.
NullProperty
(
"
timings
"
)
;
}
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
using
MS
=
mozilla
:
:
MarkerSchema
;
MS
schema
{
MS
:
:
Location
:
:
markerChart
MS
:
:
Location
:
:
markerTable
MS
:
:
Location
:
:
timelineMemory
}
;
return
schema
;
}
}
;
struct
GCMajor
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
GCMajor
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
ProfilerString8View
&
aTimingJSON
)
{
if
(
aTimingJSON
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
timings
"
aTimingJSON
)
;
}
else
{
aWriter
.
NullProperty
(
"
timings
"
)
;
}
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
using
MS
=
mozilla
:
:
MarkerSchema
;
MS
schema
{
MS
:
:
Location
:
:
markerChart
MS
:
:
Location
:
:
markerTable
MS
:
:
Location
:
:
timelineMemory
}
;
return
schema
;
}
}
;
struct
GCMinor
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
GCMinor
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
ProfilerString8View
&
aTimingJSON
)
{
if
(
aTimingJSON
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
nursery
"
aTimingJSON
)
;
}
else
{
aWriter
.
NullProperty
(
"
nursery
"
)
;
}
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
using
MS
=
mozilla
:
:
MarkerSchema
;
MS
schema
{
MS
:
:
Location
:
:
markerChart
MS
:
:
Location
:
:
markerTable
MS
:
:
Location
:
:
timelineMemory
}
;
return
schema
;
}
}
;
class
JsAllocationMarkerPayload
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
JS
allocation
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
ProfilerString16View
&
aTypeName
const
mozilla
:
:
ProfilerString8View
&
aClassName
const
mozilla
:
:
ProfilerString16View
&
aDescriptiveTypeName
const
mozilla
:
:
ProfilerString8View
&
aCoarseType
uint64_t
aSize
bool
aInNursery
)
{
if
(
aClassName
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
className
"
aClassName
)
;
}
if
(
aTypeName
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
typeName
"
NS_ConvertUTF16toUTF8
(
aTypeName
.
Data
(
)
aTypeName
.
Length
(
)
)
)
;
}
if
(
aDescriptiveTypeName
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
descriptiveTypeName
"
NS_ConvertUTF16toUTF8
(
aDescriptiveTypeName
.
Data
(
)
aDescriptiveTypeName
.
Length
(
)
)
)
;
}
aWriter
.
StringProperty
(
"
coarseType
"
aCoarseType
)
;
aWriter
.
IntProperty
(
"
size
"
aSize
)
;
aWriter
.
BoolProperty
(
"
inNursery
"
aInNursery
)
;
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
return
mozilla
:
:
MarkerSchema
:
:
SpecialFrontendLocation
{
}
;
}
}
;
struct
NativeAllocationMarkerPayload
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
Native
allocation
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
int64_t
aSize
uintptr_t
aMemoryAddress
int
aThreadId
)
{
aWriter
.
IntProperty
(
"
size
"
aSize
)
;
aWriter
.
IntProperty
(
"
memoryAddress
"
static_cast
<
int64_t
>
(
aMemoryAddress
)
)
;
aWriter
.
IntProperty
(
"
threadId
"
aThreadId
)
;
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
return
mozilla
:
:
MarkerSchema
:
:
SpecialFrontendLocation
{
}
;
}
}
;
struct
IPCMarkerPayload
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
IPC
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
int32_t
aOtherPid
int32_t
aMessageSeqno
IPC
:
:
Message
:
:
msgid_t
aMessageType
mozilla
:
:
ipc
:
:
Side
aSide
mozilla
:
:
ipc
:
:
MessageDirection
aDirection
mozilla
:
:
ipc
:
:
MessagePhase
aPhase
bool
aSync
const
mozilla
:
:
TimeStamp
&
aTime
)
{
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
startTime
"
aTime
)
;
mozilla
:
:
baseprofiler
:
:
WritePropertyTime
(
aWriter
"
endTime
"
aTime
)
;
using
namespace
mozilla
:
:
ipc
;
aWriter
.
IntProperty
(
"
otherPid
"
aOtherPid
)
;
aWriter
.
IntProperty
(
"
messageSeqno
"
aMessageSeqno
)
;
aWriter
.
StringProperty
(
"
messageType
"
mozilla
:
:
MakeStringSpan
(
IPC
:
:
StringFromIPCMessageType
(
aMessageType
)
)
)
;
aWriter
.
StringProperty
(
"
side
"
IPCSideToString
(
aSide
)
)
;
aWriter
.
StringProperty
(
"
direction
"
aDirection
=
=
MessageDirection
:
:
eSending
?
mozilla
:
:
MakeStringSpan
(
"
sending
"
)
:
mozilla
:
:
MakeStringSpan
(
"
receiving
"
)
)
;
aWriter
.
StringProperty
(
"
phase
"
IPCPhaseToString
(
aPhase
)
)
;
aWriter
.
BoolProperty
(
"
sync
"
aSync
)
;
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
return
mozilla
:
:
MarkerSchema
:
:
SpecialFrontendLocation
{
}
;
}
private
:
static
mozilla
:
:
Span
<
const
char
>
IPCSideToString
(
mozilla
:
:
ipc
:
:
Side
aSide
)
{
switch
(
aSide
)
{
case
mozilla
:
:
ipc
:
:
ParentSide
:
return
mozilla
:
:
MakeStringSpan
(
"
parent
"
)
;
case
mozilla
:
:
ipc
:
:
ChildSide
:
return
mozilla
:
:
MakeStringSpan
(
"
child
"
)
;
case
mozilla
:
:
ipc
:
:
UnknownSide
:
return
mozilla
:
:
MakeStringSpan
(
"
unknown
"
)
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Invalid
IPC
side
"
)
;
return
mozilla
:
:
MakeStringSpan
(
"
<
invalid
IPC
side
>
"
)
;
}
}
static
mozilla
:
:
Span
<
const
char
>
IPCPhaseToString
(
mozilla
:
:
ipc
:
:
MessagePhase
aPhase
)
{
switch
(
aPhase
)
{
case
mozilla
:
:
ipc
:
:
MessagePhase
:
:
Endpoint
:
return
mozilla
:
:
MakeStringSpan
(
"
endpoint
"
)
;
case
mozilla
:
:
ipc
:
:
MessagePhase
:
:
TransferStart
:
return
mozilla
:
:
MakeStringSpan
(
"
transferStart
"
)
;
case
mozilla
:
:
ipc
:
:
MessagePhase
:
:
TransferEnd
:
return
mozilla
:
:
MakeStringSpan
(
"
transferEnd
"
)
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Invalid
IPC
phase
"
)
;
return
mozilla
:
:
MakeStringSpan
(
"
<
invalid
IPC
phase
>
"
)
;
}
}
}
;
}
#
endif
#
endif
