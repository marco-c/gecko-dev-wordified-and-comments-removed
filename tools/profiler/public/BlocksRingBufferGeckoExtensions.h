#
ifndef
BlocksRingBufferGeckoExtensions_h
#
define
BlocksRingBufferGeckoExtensions_h
#
include
"
mozilla
/
BlocksRingBuffer
.
h
"
#
include
"
js
/
AllocPolicy
.
h
"
#
include
"
js
/
Utility
.
h
"
#
include
"
nsString
.
h
"
namespace
mozilla
{
template
<
typename
T
>
struct
BlocksRingBuffer
:
:
Serializer
<
nsTString
<
T
>
>
{
static
Length
Bytes
(
const
nsTString
<
T
>
&
aS
)
{
const
auto
bytes
=
aS
.
Length
(
)
*
sizeof
(
T
)
;
return
EntryWriter
:
:
ULEB128Size
(
bytes
)
+
static_cast
<
Length
>
(
bytes
)
;
}
static
void
Write
(
EntryWriter
&
aEW
const
nsTString
<
T
>
&
aS
)
{
const
auto
bytes
=
aS
.
Length
(
)
*
sizeof
(
T
)
;
aEW
.
WriteULEB128
(
bytes
)
;
aEW
.
Write
(
reinterpret_cast
<
const
char
*
>
(
aS
.
BeginReading
(
)
)
bytes
)
;
}
}
;
template
<
typename
T
>
struct
BlocksRingBuffer
:
:
Deserializer
<
nsTString
<
T
>
>
{
static
void
ReadInto
(
EntryReader
&
aER
nsTString
<
T
>
&
aS
)
{
aS
=
Read
(
aER
)
;
}
static
nsTString
<
T
>
Read
(
EntryReader
&
aER
)
{
const
auto
bytes
=
aER
.
ReadULEB128
<
Length
>
(
)
;
nsTString
<
T
>
s
;
nsresult
rv
;
auto
writer
=
s
.
BulkWrite
(
bytes
/
sizeof
(
T
)
0
true
rv
)
;
MOZ_RELEASE_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
aER
.
Read
(
reinterpret_cast
<
char
*
>
(
writer
.
Elements
(
)
)
bytes
)
;
writer
.
Finish
(
bytes
/
sizeof
(
T
)
true
)
;
return
s
;
}
}
;
template
<
typename
T
size_t
N
>
struct
BlocksRingBuffer
:
:
Serializer
<
nsTAutoStringN
<
T
N
>
>
{
static
Length
Bytes
(
const
nsTAutoStringN
<
T
N
>
&
aS
)
{
const
auto
bytes
=
aS
.
Length
(
)
*
sizeof
(
T
)
;
return
EntryWriter
:
:
ULEB128Size
(
bytes
)
+
static_cast
<
Length
>
(
bytes
)
;
}
static
void
Write
(
EntryWriter
&
aEW
const
nsTAutoStringN
<
T
N
>
&
aS
)
{
const
auto
bytes
=
aS
.
Length
(
)
*
sizeof
(
T
)
;
aEW
.
WriteULEB128
(
bytes
)
;
aEW
.
Write
(
reinterpret_cast
<
const
char
*
>
(
aS
.
BeginReading
(
)
)
bytes
)
;
}
}
;
template
<
typename
T
size_t
N
>
struct
BlocksRingBuffer
:
:
Deserializer
<
nsTAutoStringN
<
T
N
>
>
{
static
void
ReadInto
(
EntryReader
&
aER
nsTAutoStringN
<
T
N
>
&
aS
)
{
aS
=
Read
(
aER
)
;
}
static
nsTAutoStringN
<
T
N
>
Read
(
EntryReader
&
aER
)
{
const
auto
bytes
=
aER
.
ReadULEB128
<
Length
>
(
)
;
nsTAutoStringN
<
T
N
>
s
;
nsresult
rv
;
auto
writer
=
s
.
BulkWrite
(
bytes
/
sizeof
(
T
)
0
true
rv
)
;
MOZ_RELEASE_ASSERT
(
NS_SUCCEEDED
(
rv
)
)
;
aER
.
Read
(
reinterpret_cast
<
char
*
>
(
writer
.
Elements
(
)
)
bytes
)
;
writer
.
Finish
(
bytes
/
sizeof
(
T
)
true
)
;
return
s
;
}
}
;
template
<
>
struct
BlocksRingBuffer
:
:
Serializer
<
JS
:
:
UniqueChars
>
{
static
Length
Bytes
(
const
JS
:
:
UniqueChars
&
aS
)
{
if
(
!
aS
)
{
return
EntryWriter
:
:
ULEB128Size
<
Length
>
(
0
)
;
}
const
auto
len
=
static_cast
<
Length
>
(
strlen
(
aS
.
get
(
)
)
)
;
return
EntryWriter
:
:
ULEB128Size
(
len
)
+
len
;
}
static
void
Write
(
EntryWriter
&
aEW
const
JS
:
:
UniqueChars
&
aS
)
{
if
(
!
aS
)
{
aEW
.
WriteULEB128
<
Length
>
(
0
)
;
return
;
}
const
auto
len
=
static_cast
<
Length
>
(
strlen
(
aS
.
get
(
)
)
)
;
aEW
.
WriteULEB128
(
len
)
;
aEW
.
Write
(
aS
.
get
(
)
len
)
;
}
}
;
template
<
>
struct
BlocksRingBuffer
:
:
Deserializer
<
JS
:
:
UniqueChars
>
{
static
void
ReadInto
(
EntryReader
&
aER
JS
:
:
UniqueChars
&
aS
)
{
aS
=
Read
(
aER
)
;
}
static
JS
:
:
UniqueChars
Read
(
EntryReader
&
aER
)
{
const
auto
len
=
aER
.
ReadULEB128
<
Length
>
(
)
;
char
*
buffer
=
static_cast
<
char
*
>
(
js
:
:
SystemAllocPolicy
{
}
.
pod_malloc
<
char
>
(
len
+
1
)
)
;
aER
.
Read
(
buffer
len
)
;
buffer
[
len
]
=
'
\
0
'
;
return
JS
:
:
UniqueChars
(
buffer
)
;
}
}
;
}
#
endif
