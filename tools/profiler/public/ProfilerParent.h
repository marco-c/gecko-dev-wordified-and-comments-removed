#
ifndef
ProfilerParent_h
#
define
ProfilerParent_h
#
include
"
mozilla
/
PProfilerParent
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
class
nsIProfilerStartParams
;
namespace
mozilla
{
class
ProfileBufferGlobalController
;
class
ProfilerParentTracker
;
class
ProfilerParent
final
:
public
PProfilerParent
{
public
:
NS_INLINE_DECL_REFCOUNTING
(
ProfilerParent
final
)
static
mozilla
:
:
ipc
:
:
Endpoint
<
PProfilerChild
>
CreateForProcess
(
base
:
:
ProcessId
aOtherPid
)
;
#
ifdef
MOZ_GECKO_PROFILER
using
SingleProcessProfilePromise
=
MozPromise
<
IPCProfileAndAdditionalInformation
ResponseRejectReason
true
>
;
struct
SingleProcessProfilePromiseAndChildPid
{
RefPtr
<
SingleProcessProfilePromise
>
profilePromise
;
base
:
:
ProcessId
childPid
;
}
;
using
SingleProcessProgressPromise
=
MozPromise
<
GatherProfileProgress
ResponseRejectReason
true
>
;
static
nsTArray
<
SingleProcessProfilePromiseAndChildPid
>
GatherProfiles
(
)
;
static
RefPtr
<
SingleProcessProgressPromise
>
RequestGatherProfileProgress
(
base
:
:
ProcessId
aChildPid
)
;
[
[
nodiscard
]
]
static
RefPtr
<
GenericPromise
>
ProfilerStarted
(
nsIProfilerStartParams
*
aParams
)
;
static
void
ProfilerWillStopIfStarted
(
)
;
[
[
nodiscard
]
]
static
RefPtr
<
GenericPromise
>
ProfilerStopped
(
)
;
[
[
nodiscard
]
]
static
RefPtr
<
GenericPromise
>
ProfilerPaused
(
)
;
[
[
nodiscard
]
]
static
RefPtr
<
GenericPromise
>
ProfilerResumed
(
)
;
[
[
nodiscard
]
]
static
RefPtr
<
GenericPromise
>
ProfilerPausedSampling
(
)
;
[
[
nodiscard
]
]
static
RefPtr
<
GenericPromise
>
ProfilerResumedSampling
(
)
;
static
void
ClearAllPages
(
)
;
[
[
nodiscard
]
]
static
RefPtr
<
GenericPromise
>
WaitOnePeriodicSampling
(
)
;
static
ProfileBufferChunkManagerUpdate
MakeFinalUpdate
(
)
;
static
bool
IsLockedOnCurrentThread
(
)
;
private
:
friend
class
ProfileBufferGlobalController
;
friend
class
ProfilerParentTracker
;
explicit
ProfilerParent
(
base
:
:
ProcessId
aChildPid
)
;
void
Init
(
)
;
void
ActorDestroy
(
ActorDestroyReason
aActorDestroyReason
)
override
;
void
RequestChunkManagerUpdate
(
)
;
base
:
:
ProcessId
mChildPid
;
nsTArray
<
MozPromiseHolder
<
SingleProcessProfilePromise
>
>
mPendingRequestedProfiles
;
bool
mDestroyed
;
#
endif
private
:
virtual
~
ProfilerParent
(
)
;
}
;
}
#
endif
