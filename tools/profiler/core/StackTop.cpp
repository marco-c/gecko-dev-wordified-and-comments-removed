#
include
"
PlatformMacros
.
h
"
#
if
defined
(
GP_OS_darwin
)
#
include
<
mach
/
task
.
h
>
#
include
<
mach
/
thread_act
.
h
>
#
include
<
pthread
.
h
>
#
elif
defined
(
GP_OS_windows
)
#
include
<
windows
.
h
>
#
endif
#
include
"
StackTop
.
h
"
void
*
GetStackTop
(
void
*
guess
)
{
#
if
defined
(
GP_OS_darwin
)
pthread_t
thread
=
pthread_self
(
)
;
return
pthread_get_stackaddr_np
(
thread
)
;
#
elif
defined
(
GP_OS_windows
)
#
if
defined
(
_MSC_VER
)
&
&
defined
(
GP_ARCH_x86
)
NT_TIB
*
pTib
;
__asm
{
MOV
EAX
FS
:
[
18h
]
MOV
pTib
EAX
}
return
static_cast
<
void
*
>
(
pTib
-
>
StackBase
)
;
#
elif
defined
(
__GNUC__
)
&
&
defined
(
GP_ARCH_x86
)
NT_TIB
*
pTib
;
asm
(
"
movl
%
%
fs
:
0x18
%
0
\
n
"
:
"
=
r
"
(
pTib
)
)
;
return
static_cast
<
void
*
>
(
pTib
-
>
StackBase
)
;
#
elif
defined
(
GP_ARCH_amd64
)
PNT_TIB64
pTib
=
reinterpret_cast
<
PNT_TIB64
>
(
NtCurrentTeb
(
)
)
;
return
reinterpret_cast
<
void
*
>
(
pTib
-
>
StackBase
)
;
#
else
#
error
Need
a
way
to
get
the
stack
bounds
on
this
platform
(
Windows
)
#
endif
#
else
return
guess
;
#
endif
}
