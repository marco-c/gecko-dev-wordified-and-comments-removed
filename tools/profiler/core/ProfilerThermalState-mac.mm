#
include
"
mozilla
/
ProfilerMarkers
.
h
"
#
include
"
mozilla
/
ProfilerState
.
h
"
#
include
<
Foundation
/
Foundation
.
h
>
static
nsLiteralCString
ThermalStateToString
(
NSProcessInfoThermalState
state
)
{
switch
(
state
)
{
case
NSProcessInfoThermalStateNominal
:
return
"
Nominal
"
_ns
;
case
NSProcessInfoThermalStateFair
:
return
"
Fair
"
_ns
;
case
NSProcessInfoThermalStateSerious
:
return
"
Serious
"
_ns
;
case
NSProcessInfoThermalStateCritical
:
return
"
Critical
"
_ns
;
default
:
return
"
Unknown
"
_ns
;
}
}
static
void
AddThermalStateMarker
(
)
{
NSProcessInfoThermalState
state
=
[
[
NSProcessInfo
processInfo
]
thermalState
]
;
PROFILER_MARKER_TEXT
(
"
Thermal
State
"
OTHER
mozilla
:
:
MarkerOptions
(
mozilla
:
:
MarkerThreadId
:
:
MainThread
(
)
)
ThermalStateToString
(
state
)
)
;
}
static
id
<
NSObject
>
gThermalObserver
=
nil
;
static
void
ThermalStateCallback
(
ProfilingState
aProfilingState
)
{
if
(
aProfilingState
=
=
ProfilingState
:
:
Started
)
{
if
(
gThermalObserver
)
{
return
;
}
AddThermalStateMarker
(
)
;
gThermalObserver
=
[
[
NSNotificationCenter
defaultCenter
]
addObserverForName
:
NSProcessInfoThermalStateDidChangeNotification
object
:
nil
queue
:
nil
usingBlock
:
^
(
NSNotification
*
note
)
{
AddThermalStateMarker
(
)
;
}
]
;
}
else
if
(
aProfilingState
=
=
ProfilingState
:
:
Pausing
)
{
AddThermalStateMarker
(
)
;
}
else
if
(
aProfilingState
=
=
ProfilingState
:
:
Stopping
)
{
if
(
!
gThermalObserver
)
{
return
;
}
AddThermalStateMarker
(
)
;
[
[
NSNotificationCenter
defaultCenter
]
removeObserver
:
gThermalObserver
]
;
gThermalObserver
=
nil
;
}
}
void
profiler_register_thermal_state_observer
(
)
{
profiler_add_state_change_callback
(
AllProfilingStates
(
)
[
]
(
ProfilingState
aProfilingState
)
{
ThermalStateCallback
(
aProfilingState
)
;
}
0
)
;
}
