#
ifndef
TOOLS_PLATFORM_H_
#
define
TOOLS_PLATFORM_H_
#
include
<
stdint
.
h
>
#
include
<
math
.
h
>
#
include
"
MainThreadUtils
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
#
include
"
ThreadResponsiveness
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
PlatformMacros
.
h
"
#
include
<
vector
>
#
include
"
StackTop
.
h
"
#
if
defined
(
__GLIBC__
)
#
include
<
unistd
.
h
>
#
include
<
sys
/
syscall
.
h
>
static
inline
pid_t
gettid
(
)
{
return
(
pid_t
)
syscall
(
SYS_gettid
)
;
}
#
elif
defined
(
SPS_OS_darwin
)
#
include
<
unistd
.
h
>
#
include
<
sys
/
syscall
.
h
>
static
inline
pid_t
gettid
(
)
{
return
(
pid_t
)
syscall
(
SYS_thread_selfid
)
;
}
#
endif
#
if
defined
(
SPS_OS_windows
)
#
include
<
windows
.
h
>
#
endif
bool
profiler_verbose
(
)
;
#
if
defined
(
SPS_OS_android
)
#
include
<
android
/
log
.
h
>
#
define
LOG
(
text
)
\
do
{
if
(
profiler_verbose
(
)
)
\
__android_log_write
(
ANDROID_LOG_ERROR
"
Profiler
"
text
)
;
\
}
while
(
0
)
#
define
LOGF
(
format
.
.
.
)
\
do
{
if
(
profiler_verbose
(
)
)
\
__android_log_print
(
ANDROID_LOG_ERROR
"
Profiler
"
format
\
__VA_ARGS__
)
;
\
}
while
(
0
)
#
else
#
define
LOG
(
text
)
\
do
{
if
(
profiler_verbose
(
)
)
fprintf
(
stderr
"
Profiler
:
%
s
\
n
"
text
)
;
\
}
while
(
0
)
#
define
LOGF
(
format
.
.
.
)
\
do
{
if
(
profiler_verbose
(
)
)
fprintf
(
stderr
"
Profiler
:
"
format
"
\
n
"
\
__VA_ARGS__
)
;
\
}
while
(
0
)
#
endif
#
if
defined
(
SPS_OS_android
)
&
&
!
defined
(
MOZ_WIDGET_GONK
)
#
define
PROFILE_JAVA
#
endif
extern
mozilla
:
:
TimeStamp
gStartTime
;
typedef
uint8_t
*
Address
;
class
OS
{
public
:
static
void
Sleep
(
const
int
milliseconds
)
;
static
void
SleepMicro
(
const
int
microseconds
)
;
static
void
Startup
(
)
;
}
;
class
Thread
{
public
:
#
if
defined
(
SPS_OS_windows
)
typedef
DWORD
tid_t
;
#
else
typedef
:
:
pid_t
tid_t
;
#
endif
static
tid_t
GetCurrentId
(
)
;
}
;
#
undef
HAVE_NATIVE_UNWIND
#
if
defined
(
MOZ_PROFILING
)
&
&
\
(
defined
(
SPS_OS_windows
)
|
|
\
defined
(
SPS_OS_darwin
)
|
|
\
defined
(
SPS_OS_linux
)
|
|
\
defined
(
SPS_PLAT_arm_android
)
)
#
define
HAVE_NATIVE_UNWIND
#
endif
extern
const
char
*
PROFILER_INTERVAL
;
extern
const
char
*
PROFILER_ENTRIES
;
extern
const
char
*
PROFILER_STACK
;
extern
const
char
*
PROFILER_FEATURES
;
void
read_profiler_env_vars
(
)
;
void
profiler_usage
(
)
;
bool
set_profiler_interval
(
const
char
*
)
;
bool
set_profiler_entries
(
const
char
*
)
;
bool
set_profiler_scan
(
const
char
*
)
;
bool
is_native_unwinding_avail
(
)
;
class
PlatformData
;
struct
PlatformDataDestructor
{
void
operator
(
)
(
PlatformData
*
)
;
}
;
typedef
mozilla
:
:
UniquePtr
<
PlatformData
PlatformDataDestructor
>
UniquePlatformData
;
UniquePlatformData
AllocPlatformData
(
int
aThreadId
)
;
mozilla
:
:
UniquePtr
<
char
[
]
>
ToJSON
(
double
aSinceTime
)
;
#
endif
