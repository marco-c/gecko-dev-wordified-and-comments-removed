#
ifndef
TOOLS_PLATFORM_H_
#
define
TOOLS_PLATFORM_H_
#
include
"
PlatformMacros
.
h
"
#
include
"
GeckoProfiler
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
#
include
"
nsString
.
h
"
#
include
<
functional
>
#
include
<
stdint
.
h
>
namespace
mozilla
{
struct
SymbolTable
;
}
extern
mozilla
:
:
LazyLogModule
gProfilerLog
;
#
define
LOG_TEST
MOZ_LOG_TEST
(
gProfilerLog
mozilla
:
:
LogLevel
:
:
Info
)
#
define
LOG
(
arg
.
.
.
)
\
do
{
\
gPSMutex
.
AssertCurrentThreadDoesNotOwn
(
)
;
/
*
See
LOG_LOCKED
(
)
*
/
\
MOZ_LOG
(
gProfilerLog
mozilla
:
:
LogLevel
:
:
Info
\
(
"
[
%
d
]
"
arg
profiler_current_process_id
(
)
#
#
__VA_ARGS__
)
)
;
\
}
while
(
false
)
#
define
LOG_LOCKED
(
lock
arg
.
.
.
)
\
do
{
\
if
(
!
(
ActivePS
:
:
Exists
(
lock
)
&
&
ActivePS
:
:
InterposeObserver
(
lock
)
)
)
{
\
MOZ_LOG
(
gProfilerLog
mozilla
:
:
LogLevel
:
:
Info
\
(
"
[
%
d
]
"
arg
profiler_current_process_id
(
)
#
#
__VA_ARGS__
)
)
;
\
}
\
}
while
(
false
)
#
define
DEBUG_LOG_TEST
MOZ_LOG_TEST
(
gProfilerLog
mozilla
:
:
LogLevel
:
:
Debug
)
#
define
DEBUG_LOG
(
arg
.
.
.
)
\
do
{
\
gPSMutex
.
AssertCurrentThreadDoesNotOwn
(
)
;
/
*
See
DEBUG_LOG_LOCKED
(
)
*
/
\
MOZ_LOG
(
gProfilerLog
mozilla
:
:
LogLevel
:
:
Debug
\
(
"
[
%
d
]
"
arg
profiler_current_process_id
(
)
#
#
__VA_ARGS__
)
)
;
\
}
while
(
false
)
#
define
DEBUG_LOG_LOCKED
(
lock
arg
.
.
.
)
\
do
{
\
if
(
!
(
ActivePS
:
:
Exists
(
lock
)
&
&
ActivePS
:
:
InterposeObserver
(
lock
)
)
)
{
\
MOZ_LOG
(
gProfilerLog
mozilla
:
:
LogLevel
:
:
Debug
\
(
"
[
%
d
]
"
arg
profiler_current_process_id
(
)
#
#
__VA_ARGS__
)
)
;
\
}
\
}
while
(
false
)
typedef
uint8_t
*
Address
;
class
PlatformData
;
struct
PlatformDataDestructor
{
void
operator
(
)
(
PlatformData
*
)
;
}
;
typedef
mozilla
:
:
UniquePtr
<
PlatformData
PlatformDataDestructor
>
UniquePlatformData
;
UniquePlatformData
AllocPlatformData
(
int
aThreadId
)
;
namespace
mozilla
{
class
JSONWriter
;
}
void
AppendSharedLibraries
(
mozilla
:
:
JSONWriter
&
aWriter
)
;
uint32_t
ParseFeaturesFromStringArray
(
const
char
*
*
aFeatures
uint32_t
aFeatureCount
bool
aIsStartup
=
false
)
;
void
profiler_get_profile_json_into_lazily_allocated_buffer
(
const
std
:
:
function
<
char
*
(
size_t
)
>
&
aAllocator
double
aSinceTime
bool
aIsShuttingDown
)
;
enum
class
JSInstrumentationFlags
{
StackSampling
=
0x1
TrackOptimizations
=
0x2
TraceLogging
=
0x4
Allocations
=
0x8
}
;
void
profiler_received_exit_profile
(
const
nsCString
&
aExitProfile
)
;
void
profiler_write_active_configuration
(
mozilla
:
:
JSONWriter
&
aWriter
)
;
mozilla
:
:
Vector
<
nsCString
>
profiler_move_exit_profiles
(
)
;
mozilla
:
:
UniquePtr
<
ProfilerCodeAddressService
>
profiler_code_address_service_for_presymbolication
(
)
;
extern
"
C
"
{
bool
profiler_get_symbol_table
(
const
char
*
debug_path
const
char
*
breakpad_id
mozilla
:
:
SymbolTable
*
symbol_table
)
;
bool
profiler_demangle_rust
(
const
char
*
mangled
char
*
buffer
size_t
len
)
;
}
#
endif
