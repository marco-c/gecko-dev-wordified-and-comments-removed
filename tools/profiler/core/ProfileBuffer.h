#
ifndef
MOZ_PROFILE_BUFFER_H
#
define
MOZ_PROFILE_BUFFER_H
#
include
"
platform
.
h
"
#
include
"
ProfileBufferEntry
.
h
"
#
include
"
ProfilerMarker
.
h
"
#
include
"
ProfileJSONWriter
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
RefCounted
.
h
"
class
ProfileBuffer
final
:
public
ProfilerStackCollector
{
public
:
explicit
ProfileBuffer
(
int
aEntrySize
)
;
~
ProfileBuffer
(
)
;
struct
LastSample
{
LastSample
(
)
:
mGeneration
(
0
)
mPos
(
-
1
)
{
}
uint32_t
mGeneration
;
int
mPos
;
}
;
void
AddEntry
(
const
ProfileBufferEntry
&
aEntry
)
;
void
AddThreadIdEntry
(
int
aThreadId
LastSample
*
aLS
=
nullptr
)
;
virtual
mozilla
:
:
Maybe
<
uint32_t
>
Generation
(
)
override
{
return
mozilla
:
:
Some
(
mGeneration
)
;
}
virtual
void
CollectNativeLeafAddr
(
void
*
aAddr
)
override
;
virtual
void
CollectJitReturnAddr
(
void
*
aAddr
)
override
;
virtual
void
CollectCodeLocation
(
const
char
*
aLabel
const
char
*
aStr
int
aLineNumber
const
mozilla
:
:
Maybe
<
js
:
:
ProfileEntry
:
:
Category
>
&
aCategory
)
override
;
static
const
size_t
kMaxFrameKeyLength
=
512
;
void
StreamSamplesToJSON
(
SpliceableJSONWriter
&
aWriter
int
aThreadId
double
aSinceTime
double
*
aOutFirstSampleTime
JSContext
*
cx
UniqueStacks
&
aUniqueStacks
)
const
;
void
StreamMarkersToJSON
(
SpliceableJSONWriter
&
aWriter
int
aThreadId
const
mozilla
:
:
TimeStamp
&
aProcessStartTime
double
aSinceTime
UniqueStacks
&
aUniqueStacks
)
const
;
bool
DuplicateLastSample
(
int
aThreadId
const
mozilla
:
:
TimeStamp
&
aProcessStartTime
LastSample
&
aLS
)
;
void
AddStoredMarker
(
ProfilerMarker
*
aStoredMarker
)
;
void
DeleteExpiredStoredMarkers
(
)
;
void
Reset
(
)
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
private
:
int
FindLastSampleOfThread
(
int
aThreadId
const
LastSample
&
aLS
)
const
;
public
:
mozilla
:
:
UniquePtr
<
ProfileBufferEntry
[
]
>
mEntries
;
int
mWritePos
;
int
mReadPos
;
int
mEntrySize
;
uint32_t
mGeneration
;
ProfilerMarkerLinkedList
mStoredMarkers
;
}
;
#
endif
