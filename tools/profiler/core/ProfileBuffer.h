#
ifndef
MOZ_PROFILE_BUFFER_H
#
define
MOZ_PROFILE_BUFFER_H
#
include
"
ProfileBufferEntry
.
h
"
#
include
"
platform
.
h
"
#
include
"
ProfileJSONWriter
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
RefCounted
.
h
"
class
ProfileBuffer
:
public
mozilla
:
:
RefCounted
<
ProfileBuffer
>
{
public
:
MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME
(
ProfileBuffer
)
explicit
ProfileBuffer
(
int
aEntrySize
)
;
virtual
~
ProfileBuffer
(
)
;
void
addTag
(
const
ProfileBufferEntry
&
aTag
)
;
void
StreamSamplesToJSON
(
SpliceableJSONWriter
&
aWriter
int
aThreadId
double
aSinceTime
JSContext
*
cx
UniqueStacks
&
aUniqueStacks
)
;
void
StreamMarkersToJSON
(
SpliceableJSONWriter
&
aWriter
int
aThreadId
double
aSinceTime
UniqueStacks
&
aUniqueStacks
)
;
void
DuplicateLastSample
(
int
aThreadId
const
mozilla
:
:
TimeStamp
&
aStartTime
)
;
void
addStoredMarker
(
ProfilerMarker
*
aStoredMarker
)
;
void
deleteExpiredStoredMarkers
(
)
;
void
reset
(
)
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
protected
:
char
*
processDynamicTag
(
int
readPos
int
*
tagsConsumed
char
*
tagBuff
)
;
int
FindLastSampleOfThread
(
int
aThreadId
)
;
public
:
mozilla
:
:
UniquePtr
<
ProfileBufferEntry
[
]
>
mEntries
;
int
mWritePos
;
int
mReadPos
;
int
mEntrySize
;
uint32_t
mGeneration
;
ProfilerMarkerLinkedList
mStoredMarkers
;
}
;
#
endif
