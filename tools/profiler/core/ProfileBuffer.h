#
ifndef
MOZ_PROFILE_BUFFER_H
#
define
MOZ_PROFILE_BUFFER_H
#
include
"
GeckoProfiler
.
h
"
#
include
"
ProfileBufferEntry
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
PowerOfTwo
.
h
"
#
include
"
mozilla
/
ProfileBufferChunkManagerSingle
.
h
"
#
include
"
mozilla
/
ProfileChunkedBuffer
.
h
"
#
include
"
nsTHashMap
.
h
"
class
ProcessStreamingContext
;
class
RunningTimes
;
struct
ProfilerJSSourceData
;
class
ProfileBuffer
final
{
public
:
explicit
ProfileBuffer
(
mozilla
:
:
ProfileChunkedBuffer
&
aBuffer
)
;
mozilla
:
:
ProfileChunkedBuffer
&
UnderlyingChunkedBuffer
(
)
const
{
return
mEntries
;
}
bool
IsThreadSafe
(
)
const
{
return
mEntries
.
IsThreadSafe
(
)
;
}
uint64_t
AddEntry
(
const
ProfileBufferEntry
&
aEntry
)
;
uint64_t
AddThreadIdEntry
(
ProfilerThreadId
aThreadId
)
;
void
CollectCodeLocation
(
const
char
*
aLabel
const
char
*
aStr
uint32_t
aFrameFlags
uint64_t
aInnerWindowID
uint32_t
aSourceId
const
mozilla
:
:
Maybe
<
uint32_t
>
&
aLineNumber
const
mozilla
:
:
Maybe
<
uint32_t
>
&
aColumnNumber
const
mozilla
:
:
Maybe
<
JS
:
:
ProfilingCategoryPair
>
&
aCategoryPair
)
;
static
constexpr
size_t
kMaxFrameKeyLength
=
512
;
void
AddJITInfoForRange
(
uint64_t
aRangeStart
ProfilerThreadId
aThreadId
JSContext
*
aContext
JITFrameInfo
&
aJITFrameInfo
mozilla
:
:
ProgressLogger
aProgressLogger
const
nsTHashMap
<
SourceId
IndexIntoSourceTable
>
*
aSourceIdToIndexMap
=
nullptr
)
const
;
ProfilerThreadId
StreamSamplesToJSON
(
SpliceableJSONWriter
&
aWriter
ProfilerThreadId
aThreadId
double
aSinceTime
UniqueStacks
&
aUniqueStacks
mozilla
:
:
ProgressLogger
aProgressLogger
)
const
;
void
StreamMarkersToJSON
(
SpliceableJSONWriter
&
aWriter
ProfilerThreadId
aThreadId
const
mozilla
:
:
TimeStamp
&
aProcessStartTime
double
aSinceTime
UniqueStacks
&
aUniqueStacks
mozilla
:
:
ProgressLogger
aProgressLogger
)
const
;
void
StreamSamplesAndMarkersToJSON
(
ProcessStreamingContext
&
aProcessStreamingContext
mozilla
:
:
ProgressLogger
aProgressLogger
)
const
;
void
StreamPausedRangesToJSON
(
SpliceableJSONWriter
&
aWriter
double
aSinceTime
mozilla
:
:
ProgressLogger
aProgressLogger
)
const
;
void
StreamProfilerOverheadToJSON
(
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
TimeStamp
&
aProcessStartTime
double
aSinceTime
mozilla
:
:
ProgressLogger
aProgressLogger
)
const
;
void
StreamCountersToJSON
(
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
TimeStamp
&
aProcessStartTime
double
aSinceTime
mozilla
:
:
ProgressLogger
aProgressLogger
)
const
;
nsTHashMap
<
SourceId
IndexIntoSourceTable
>
StreamSourceTableToJSON
(
SpliceableJSONWriter
&
aWriter
const
nsTArray
<
mozilla
:
:
JSSourceEntry
>
&
aJSSourceEntries
)
const
;
bool
DuplicateLastSample
(
ProfilerThreadId
aThreadId
double
aSampleTimeMs
mozilla
:
:
Maybe
<
uint64_t
>
&
aLastSample
const
RunningTimes
&
aRunningTimes
)
;
void
DiscardSamplesBeforeTime
(
double
aTime
)
;
ProfileBufferEntry
GetEntry
(
uint64_t
aPosition
)
const
{
return
mEntries
.
ReadAt
(
mozilla
:
:
ProfileBufferBlockIndex
:
:
CreateFromProfileBufferIndex
(
aPosition
)
[
&
]
(
mozilla
:
:
Maybe
<
mozilla
:
:
ProfileBufferEntryReader
>
&
&
aMER
)
{
ProfileBufferEntry
entry
;
if
(
aMER
.
isSome
(
)
)
{
if
(
aMER
-
>
CurrentBlockIndex
(
)
.
ConvertToProfileBufferIndex
(
)
=
=
aPosition
)
{
MOZ_RELEASE_ASSERT
(
aMER
-
>
RemainingBytes
(
)
<
=
sizeof
(
entry
)
)
;
aMER
-
>
ReadBytes
(
&
entry
aMER
-
>
RemainingBytes
(
)
)
;
}
else
{
aMER
-
>
SetRemainingBytes
(
0
)
;
}
}
return
entry
;
}
)
;
}
size_t
SizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
void
CollectOverheadStats
(
double
aSamplingTimeMs
mozilla
:
:
TimeDuration
aLocking
mozilla
:
:
TimeDuration
aCleaning
mozilla
:
:
TimeDuration
aCounters
mozilla
:
:
TimeDuration
aThreads
)
;
ProfilerBufferInfo
GetProfilerBufferInfo
(
)
const
;
private
:
static
mozilla
:
:
ProfileBufferBlockIndex
AddEntry
(
mozilla
:
:
ProfileChunkedBuffer
&
aProfileChunkedBuffer
const
ProfileBufferEntry
&
aEntry
)
;
static
mozilla
:
:
ProfileBufferBlockIndex
AddThreadIdEntry
(
mozilla
:
:
ProfileChunkedBuffer
&
aProfileChunkedBuffer
ProfilerThreadId
aThreadId
)
;
mozilla
:
:
ProfileChunkedBuffer
&
mEntries
;
public
:
uint64_t
BufferRangeStart
(
)
const
{
return
mEntries
.
GetState
(
)
.
mRangeStart
;
}
uint64_t
BufferRangeEnd
(
)
const
{
return
mEntries
.
GetState
(
)
.
mRangeEnd
;
}
private
:
mutable
mozilla
:
:
Maybe
<
mozilla
:
:
ProfileBufferChunkManagerSingle
>
mMaybeWorkerChunkManager
;
mozilla
:
:
ProfileBufferChunkManagerSingle
&
WorkerChunkManager
(
)
const
{
if
(
mMaybeWorkerChunkManager
.
isNothing
(
)
)
{
mMaybeWorkerChunkManager
.
emplace
(
mozilla
:
:
ProfileBufferChunk
:
:
SizeofChunkMetadata
(
)
+
mozilla
:
:
ProfileBufferChunkManager
:
:
scExpectedMaximumStackSize
)
;
}
return
*
mMaybeWorkerChunkManager
;
}
#
ifdef
MOZ_EXECUTION_TRACING
template
<
typename
GetStreamingParametersForThreadCallback
>
void
MaybeStreamExecutionTraceToJSON
(
GetStreamingParametersForThreadCallback
&
&
aGetStreamingParametersForThreadCallback
double
aSinceTime
)
const
;
#
endif
template
<
typename
GetStreamingParametersForThreadCallback
>
ProfilerThreadId
DoStreamSamplesAndMarkersToJSON
(
mozilla
:
:
FailureLatch
&
aFailureLatch
GetStreamingParametersForThreadCallback
&
&
aGetStreamingParametersForThreadCallback
double
aSinceTime
ProcessStreamingContext
*
aStreamingContextForMarkers
mozilla
:
:
ProgressLogger
aProgressLogger
)
const
;
double
mFirstSamplingTimeUs
=
0
.
0
;
double
mLastSamplingTimeUs
=
0
.
0
;
ProfilerStats
mIntervalsUs
;
ProfilerStats
mOverheadsUs
;
ProfilerStats
mLockingsUs
;
ProfilerStats
mCleaningsUs
;
ProfilerStats
mCountersUs
;
ProfilerStats
mThreadsUs
;
}
;
class
ProfileBufferCollector
final
:
public
ProfilerStackCollector
{
public
:
ProfileBufferCollector
(
ProfileBuffer
&
aBuf
uint64_t
aSamplePos
uint64_t
aBufferRangeStart
)
:
mBuf
(
aBuf
)
mSamplePositionInBuffer
(
aSamplePos
)
mBufferRangeStart
(
aBufferRangeStart
)
{
MOZ_ASSERT
(
mSamplePositionInBuffer
>
=
mBufferRangeStart
"
The
sample
position
should
always
be
after
the
buffer
range
start
"
)
;
}
mozilla
:
:
Maybe
<
uint64_t
>
SamplePositionInBuffer
(
)
override
{
return
mozilla
:
:
Some
(
mSamplePositionInBuffer
)
;
}
mozilla
:
:
Maybe
<
uint64_t
>
BufferRangeStart
(
)
override
{
return
mozilla
:
:
Some
(
mBufferRangeStart
)
;
}
virtual
void
CollectNativeLeafAddr
(
void
*
aAddr
)
override
;
virtual
void
CollectJitReturnAddr
(
void
*
aAddr
)
override
;
virtual
void
CollectWasmOrSyncJITFrame
(
JS
:
:
ProfilingCategoryPair
aCategory
const
char
*
aLabel
)
override
;
virtual
void
CollectProfilingStackFrame
(
const
js
:
:
ProfilingStackFrame
&
aFrame
)
override
;
private
:
ProfileBuffer
&
mBuf
;
uint64_t
mSamplePositionInBuffer
;
uint64_t
mBufferRangeStart
;
}
;
#
endif
