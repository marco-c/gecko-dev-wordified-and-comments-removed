#
ifndef
RegisteredThread_h
#
define
RegisteredThread_h
#
include
"
platform
.
h
"
#
include
"
ThreadInfo
.
h
"
#
include
"
mozilla
/
NotNull
.
h
"
#
include
"
mozilla
/
ProfilerThreadRegistration
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsIEventTarget
.
h
"
#
include
"
nsIThread
.
h
"
class
ProfilingStack
;
class
RacyRegisteredThread
final
{
public
:
explicit
RacyRegisteredThread
(
mozilla
:
:
profiler
:
:
ThreadRegistration
&
aThreadRegistration
ProfilerThreadId
aThreadId
)
;
MOZ_COUNTED_DTOR
(
RacyRegisteredThread
)
void
SetIsBeingProfiled
(
bool
aIsBeingProfiled
)
{
mThreadRegistration
.
mData
.
mIsBeingProfiled
=
aIsBeingProfiled
;
}
void
ReinitializeOnResume
(
)
{
mThreadRegistration
.
mData
.
ReinitializeOnResume
(
)
;
}
bool
CanDuplicateLastSampleDueToSleep
(
)
{
return
mThreadRegistration
.
mData
.
CanDuplicateLastSampleDueToSleep
(
)
;
}
void
SetSleeping
(
)
{
mThreadRegistration
.
mData
.
SetSleeping
(
)
;
}
void
SetAwake
(
)
{
mThreadRegistration
.
mData
.
SetAwake
(
)
;
}
bool
IsSleeping
(
)
{
return
mThreadRegistration
.
mData
.
IsSleeping
(
)
;
}
class
ProfilingStack
&
ProfilingStack
(
)
{
return
mThreadRegistration
.
mData
.
ProfilingStackRef
(
)
;
}
const
class
ProfilingStack
&
ProfilingStack
(
)
const
{
return
mThreadRegistration
.
mData
.
ProfilingStackCRef
(
)
;
}
mozilla
:
:
profiler
:
:
ThreadRegistration
&
mThreadRegistration
;
}
;
class
RegisteredThread
final
{
public
:
RegisteredThread
(
mozilla
:
:
profiler
:
:
ThreadRegistration
&
aThreadRegistration
ThreadInfo
*
aInfo
nsIThread
*
aThread
void
*
aStackTop
)
;
~
RegisteredThread
(
)
;
class
RacyRegisteredThread
&
RacyRegisteredThread
(
)
{
return
mRacyRegisteredThread
;
}
const
class
RacyRegisteredThread
&
RacyRegisteredThread
(
)
const
{
return
mRacyRegisteredThread
;
}
PlatformData
*
GetPlatformData
(
)
const
{
return
mPlatformData
.
get
(
)
;
}
const
void
*
StackTop
(
)
const
{
return
mRacyRegisteredThread
.
mThreadRegistration
.
mData
.
mStackTop
;
}
void
GetRunningEventDelay
(
const
mozilla
:
:
TimeStamp
&
aNow
mozilla
:
:
TimeDuration
&
aDelay
mozilla
:
:
TimeDuration
&
aRunning
)
;
size_t
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
;
void
SetJSContext
(
JSContext
*
aContext
)
;
void
ClearJSContext
(
)
{
mRacyRegisteredThread
.
mThreadRegistration
.
mData
.
mJSContext
=
nullptr
;
}
JSContext
*
GetJSContext
(
)
const
{
return
mRacyRegisteredThread
.
mThreadRegistration
.
mData
.
mJSContext
;
}
const
RefPtr
<
ThreadInfo
>
Info
(
)
const
{
return
mThreadInfo
;
}
nsCOMPtr
<
nsIEventTarget
>
GetEventTarget
(
)
const
{
return
mRacyRegisteredThread
.
mThreadRegistration
.
mData
.
mThread
;
}
void
ResetMainThread
(
nsIThread
*
aThread
)
{
mRacyRegisteredThread
.
mThreadRegistration
.
mData
.
mThread
=
aThread
;
}
void
StartJSSampling
(
uint32_t
aJSFlags
)
{
mRacyRegisteredThread
.
mThreadRegistration
.
mData
.
StartJSSampling
(
aJSFlags
)
;
}
void
StopJSSampling
(
)
{
mRacyRegisteredThread
.
mThreadRegistration
.
mData
.
StopJSSampling
(
)
;
}
void
PollJSSampling
(
)
;
private
:
class
RacyRegisteredThread
mRacyRegisteredThread
;
const
UniquePlatformData
mPlatformData
;
const
RefPtr
<
ThreadInfo
>
mThreadInfo
;
}
;
#
endif
