#
include
"
mozilla
/
ProfilerThreadRegistration
.
h
"
#
include
"
mozilla
/
ProfilerMarkers
.
h
"
#
include
"
mozilla
/
ProfilerThreadRegistry
.
h
"
namespace
mozilla
:
:
profiler
{
ThreadRegistration
:
:
TLSInitialization
ThreadRegistration
:
:
sIsTLSInitialized
;
MOZ_THREAD_LOCAL
(
ThreadRegistration
*
)
ThreadRegistration
:
:
tlsThreadRegistration
;
ThreadRegistration
:
:
ThreadRegistration
(
const
char
*
aName
const
void
*
aStackTop
)
:
mData
(
aName
aStackTop
)
{
if
(
mData
.
Info
(
)
.
IsMainThread
(
)
&
&
sIsTLSInitialized
=
=
TLSInitialization
:
:
NOT_YET
)
{
sIsTLSInitialized
=
tlsThreadRegistration
.
init
(
)
?
TLSInitialization
:
:
DONE
:
TLSInitialization
:
:
FAILED
;
}
if
(
auto
*
tls
=
GetTLS
(
)
;
tls
)
{
if
(
ThreadRegistration
*
rootRegistration
=
tls
-
>
get
(
)
;
rootRegistration
)
{
MOZ_ASSERT
(
mData
.
Info
(
)
.
ThreadId
(
)
=
=
rootRegistration
-
>
mData
.
Info
(
)
.
ThreadId
(
)
"
Thread
being
re
-
registered
has
changed
its
TID
"
)
;
PROFILER_MARKER_TEXT
(
"
Nested
ThreadRegistration
(
)
"
OTHER_Profiling
MarkerThreadId
:
:
MainThread
(
)
ProfilerString8View
:
:
WrapNullTerminatedString
(
aName
)
)
;
return
;
}
tls
-
>
set
(
this
)
;
ThreadRegistry
:
:
Register
(
OnThreadRef
{
*
this
}
)
;
}
}
ThreadRegistration
:
:
~
ThreadRegistration
(
)
{
#
ifdef
DEBUG
MOZ_ASSERT
(
profiler_current_thread_id
(
)
=
=
mData
.
mInfo
.
ThreadId
(
)
"
ThreadRegistration
must
be
destroyed
on
its
thread
"
)
;
MOZ_ASSERT
(
!
mDataMutex
.
IsLockedOnCurrentThread
(
)
"
Mutex
shouldn
'
t
be
locked
here
as
it
'
s
about
to
be
destroyed
"
"
in
~
ThreadRegistration
(
)
"
)
;
MOZ_ASSERT
(
mDataMutex
.
TryLock
(
)
"
Mutex
shouldn
'
t
be
locked
in
any
thread
as
it
'
s
about
to
be
"
"
destroyed
in
~
ThreadRegistration
(
)
"
)
;
mDataMutex
.
Unlock
(
)
;
#
endif
if
(
auto
*
tls
=
GetTLS
(
)
;
tls
)
{
ThreadRegistration
*
threadRegistrationInTLS
=
tls
-
>
get
(
)
;
if
(
!
threadRegistrationInTLS
)
{
if
(
!
profiler_is_main_thread
(
)
)
{
PROFILER_MARKER_TEXT
(
"
~
ThreadRegistration
(
)
but
TLS
is
empty
"
OTHER_Profiling
MarkerThreadId
:
:
MainThread
(
)
ProfilerString8View
:
:
WrapNullTerminatedString
(
mData
.
Info
(
)
.
Name
(
)
)
)
;
}
return
;
}
if
(
threadRegistrationInTLS
!
=
this
)
{
PROFILER_MARKER_TEXT
(
"
Nested
~
ThreadRegistration
(
)
"
OTHER_Profiling
MarkerThreadId
:
:
MainThread
(
)
ProfilerString8View
:
:
WrapNullTerminatedString
(
mData
.
Info
(
)
.
Name
(
)
)
)
;
return
;
}
ThreadRegistry
:
:
Unregister
(
OnThreadRef
{
*
this
}
)
;
tls
-
>
set
(
nullptr
)
;
}
}
ProfilingStack
&
ThreadRegistration
:
:
RegisterThread
(
const
char
*
aName
const
void
*
aStackTop
)
{
if
(
ThreadRegistration
*
rootRegistration
=
GetFromTLS
(
)
;
rootRegistration
)
{
+
+
rootRegistration
-
>
mOtherRegistrations
;
PROFILER_MARKER_TEXT
(
"
Nested
ThreadRegistration
:
:
RegisterThread
(
)
"
OTHER_Profiling
MarkerThreadId
:
:
MainThread
(
)
ProfilerString8View
:
:
WrapNullTerminatedString
(
aName
)
)
;
return
rootRegistration
-
>
mData
.
mProfilingStack
;
}
ThreadRegistration
*
tr
=
new
ThreadRegistration
(
aName
aStackTop
)
;
return
tr
-
>
mData
.
mProfilingStack
;
}
void
ThreadRegistration
:
:
UnregisterThread
(
)
{
if
(
ThreadRegistration
*
rootRegistration
=
GetFromTLS
(
)
;
rootRegistration
)
{
if
(
rootRegistration
-
>
mOtherRegistrations
!
=
0
)
{
-
-
rootRegistration
-
>
mOtherRegistrations
;
PROFILER_MARKER_UNTYPED
(
"
Nested
ThreadRegistration
:
:
UnregisterThread
(
)
"
OTHER_Profiling
MarkerThreadId
:
:
MainThread
(
)
)
;
return
;
}
delete
rootRegistration
;
}
}
}
