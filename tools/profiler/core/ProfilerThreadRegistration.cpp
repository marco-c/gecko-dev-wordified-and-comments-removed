#
include
"
mozilla
/
ProfilerThreadRegistration
.
h
"
#
include
"
mozilla
/
ProfilerMarkers
.
h
"
#
include
"
mozilla
/
ProfilerThreadRegistry
.
h
"
#
include
"
nsString
.
h
"
#
ifdef
MOZ_GECKO_PROFILER
#
include
"
platform
.
h
"
#
else
#
define
profiler_mark_thread_awake
(
)
#
define
profiler_mark_thread_asleep
(
)
#
endif
namespace
mozilla
:
:
profiler
{
MOZ_THREAD_LOCAL
(
ThreadRegistration
*
)
ThreadRegistration
:
:
tlsThreadRegistration
;
ThreadRegistration
:
:
ThreadRegistration
(
const
char
*
aName
const
void
*
aStackTop
)
:
mData
(
aName
aStackTop
)
{
auto
*
tls
=
GetTLS
(
)
;
if
(
MOZ_UNLIKELY
(
!
tls
)
)
{
return
;
}
if
(
ThreadRegistration
*
rootRegistration
=
tls
-
>
get
(
)
;
rootRegistration
)
{
MOZ_ASSERT
(
mData
.
Info
(
)
.
ThreadId
(
)
=
=
rootRegistration
-
>
mData
.
Info
(
)
.
ThreadId
(
)
"
Thread
being
re
-
registered
has
changed
its
TID
"
)
;
PROFILER_MARKER_TEXT
(
"
Nested
ThreadRegistration
(
)
"
OTHER_Profiling
MarkerOptions
{
}
ProfilerString8View
:
:
WrapNullTerminatedString
(
aName
)
)
;
return
;
}
tls
-
>
set
(
this
)
;
ThreadRegistry
:
:
Register
(
OnThreadRef
{
*
this
}
)
;
profiler_mark_thread_awake
(
)
;
}
ThreadRegistration
:
:
~
ThreadRegistration
(
)
{
MOZ_ASSERT
(
profiler_current_thread_id
(
)
=
=
mData
.
mInfo
.
ThreadId
(
)
"
ThreadRegistration
must
be
destroyed
on
its
thread
"
)
;
MOZ_ASSERT
(
!
mDataMutex
.
IsLockedOnCurrentThread
(
)
"
Mutex
shouldn
'
t
be
locked
here
as
it
'
s
about
to
be
destroyed
"
"
in
~
ThreadRegistration
(
)
"
)
;
auto
*
tls
=
GetTLS
(
)
;
if
(
MOZ_UNLIKELY
(
!
tls
)
)
{
return
;
}
if
(
ThreadRegistration
*
rootRegistration
=
tls
-
>
get
(
)
;
rootRegistration
)
{
if
(
rootRegistration
!
=
this
)
{
PROFILER_MARKER_TEXT
(
"
Nested
~
ThreadRegistration
(
)
"
OTHER_Profiling
MarkerOptions
{
}
ProfilerString8View
:
:
WrapNullTerminatedString
(
mData
.
Info
(
)
.
Name
(
)
)
)
;
return
;
}
profiler_mark_thread_asleep
(
)
;
ThreadRegistry
:
:
Unregister
(
OnThreadRef
{
*
this
}
)
;
#
ifdef
DEBUG
MOZ_ASSERT
(
mDataMutex
.
TryLock
(
)
"
Mutex
shouldn
'
t
be
locked
in
any
thread
as
it
'
s
about
to
be
"
"
destroyed
in
~
ThreadRegistration
(
)
"
)
;
mDataMutex
.
Unlock
(
)
;
#
endif
tls
-
>
set
(
nullptr
)
;
return
;
}
if
(
!
profiler_is_main_thread
(
)
)
{
nsAutoCString
threadId
(
"
thread
id
:
"
)
;
threadId
.
AppendInt
(
profiler_current_thread_id
(
)
.
ToNumber
(
)
)
;
threadId
.
AppendLiteral
(
"
name
:
\
"
"
)
;
threadId
.
AppendASCII
(
mData
.
Info
(
)
.
Name
(
)
)
;
threadId
.
AppendLiteral
(
"
\
"
"
)
;
PROFILER_MARKER_TEXT
(
"
~
ThreadRegistration
(
)
but
TLS
is
empty
"
OTHER_Profiling
MarkerOptions
(
MarkerThreadId
:
:
MainThread
(
)
MarkerStack
:
:
Capture
(
)
)
threadId
)
;
}
}
ProfilingStack
*
ThreadRegistration
:
:
RegisterThread
(
const
char
*
aName
const
void
*
aStackTop
)
{
auto
*
tls
=
GetTLS
(
)
;
if
(
MOZ_UNLIKELY
(
!
tls
)
)
{
return
nullptr
;
}
if
(
ThreadRegistration
*
rootRegistration
=
tls
-
>
get
(
)
;
rootRegistration
)
{
+
+
rootRegistration
-
>
mOtherRegistrations
;
PROFILER_MARKER_TEXT
(
"
Nested
ThreadRegistration
:
:
RegisterThread
(
)
"
OTHER_Profiling
MarkerOptions
{
}
ProfilerString8View
:
:
WrapNullTerminatedString
(
aName
)
)
;
return
&
rootRegistration
-
>
mData
.
mProfilingStack
;
}
ThreadRegistration
*
tr
=
new
ThreadRegistration
(
aName
aStackTop
)
;
tr
-
>
mIsOnHeap
=
true
;
return
&
tr
-
>
mData
.
mProfilingStack
;
}
void
ThreadRegistration
:
:
UnregisterThread
(
)
{
auto
*
tls
=
GetTLS
(
)
;
if
(
MOZ_UNLIKELY
(
!
tls
)
)
{
return
;
}
if
(
ThreadRegistration
*
rootRegistration
=
tls
-
>
get
(
)
;
rootRegistration
)
{
if
(
rootRegistration
-
>
mOtherRegistrations
!
=
0
)
{
-
-
rootRegistration
-
>
mOtherRegistrations
;
PROFILER_MARKER_UNTYPED
(
"
Nested
ThreadRegistration
:
:
UnregisterThread
(
)
"
OTHER_Profiling
)
;
return
;
}
if
(
!
rootRegistration
-
>
mIsOnHeap
)
{
PROFILER_MARKER_UNTYPED
(
"
Excess
ThreadRegistration
:
:
UnregisterThread
(
)
"
OTHER_Profiling
MarkerStack
:
:
Capture
(
)
)
;
return
;
}
delete
rootRegistration
;
return
;
}
if
(
!
profiler_is_main_thread
(
)
)
{
nsAutoCString
threadId
(
"
thread
id
:
"
)
;
threadId
.
AppendInt
(
profiler_current_thread_id
(
)
.
ToNumber
(
)
)
;
PROFILER_MARKER_TEXT
(
"
ThreadRegistration
:
:
UnregisterThread
(
)
but
TLS
is
empty
"
OTHER_Profiling
MarkerOptions
(
MarkerThreadId
:
:
MainThread
(
)
MarkerStack
:
:
Capture
(
)
)
threadId
)
;
}
}
}
