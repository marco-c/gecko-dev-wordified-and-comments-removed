#
include
"
RegisteredThread
.
h
"
#
include
"
mozilla
/
ProfilerMarkers
.
h
"
#
include
"
js
/
AllocationRecording
.
h
"
#
include
"
js
/
ProfilingStack
.
h
"
#
include
"
js
/
TraceLoggerAPI
.
h
"
static
void
profiler_add_js_marker
(
const
char
*
aMarkerName
const
char
*
aMarkerText
)
{
PROFILER_MARKER_TEXT
(
mozilla
:
:
ProfilerString8View
:
:
WrapNullTerminatedString
(
aMarkerName
)
JS
{
}
mozilla
:
:
ProfilerString8View
:
:
WrapNullTerminatedString
(
aMarkerText
)
)
;
}
static
void
profiler_add_js_allocation_marker
(
JS
:
:
RecordAllocationInfo
&
&
info
)
{
if
(
!
profiler_can_accept_markers
(
)
)
{
return
;
}
struct
JsAllocationMarker
{
static
constexpr
mozilla
:
:
Span
<
const
char
>
MarkerTypeName
(
)
{
return
mozilla
:
:
MakeStringSpan
(
"
JS
allocation
"
)
;
}
static
void
StreamJSONMarkerData
(
mozilla
:
:
baseprofiler
:
:
SpliceableJSONWriter
&
aWriter
const
mozilla
:
:
ProfilerString16View
&
aTypeName
const
mozilla
:
:
ProfilerString8View
&
aClassName
const
mozilla
:
:
ProfilerString16View
&
aDescriptiveTypeName
const
mozilla
:
:
ProfilerString8View
&
aCoarseType
uint64_t
aSize
bool
aInNursery
)
{
if
(
aClassName
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
className
"
aClassName
)
;
}
if
(
aTypeName
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
typeName
"
NS_ConvertUTF16toUTF8
(
aTypeName
.
Data
(
)
aTypeName
.
Length
(
)
)
)
;
}
if
(
aDescriptiveTypeName
.
Length
(
)
!
=
0
)
{
aWriter
.
StringProperty
(
"
descriptiveTypeName
"
NS_ConvertUTF16toUTF8
(
aDescriptiveTypeName
.
Data
(
)
aDescriptiveTypeName
.
Length
(
)
)
)
;
}
aWriter
.
StringProperty
(
"
coarseType
"
aCoarseType
)
;
aWriter
.
IntProperty
(
"
size
"
aSize
)
;
aWriter
.
BoolProperty
(
"
inNursery
"
aInNursery
)
;
}
static
mozilla
:
:
MarkerSchema
MarkerTypeDisplay
(
)
{
return
mozilla
:
:
MarkerSchema
:
:
SpecialFrontendLocation
{
}
;
}
}
;
profiler_add_marker
(
"
JS
allocation
"
geckoprofiler
:
:
category
:
:
JS
mozilla
:
:
MarkerStack
:
:
Capture
(
)
JsAllocationMarker
{
}
mozilla
:
:
ProfilerString16View
:
:
WrapNullTerminatedString
(
info
.
typeName
)
mozilla
:
:
ProfilerString8View
:
:
WrapNullTerminatedString
(
info
.
className
)
mozilla
:
:
ProfilerString16View
:
:
WrapNullTerminatedString
(
info
.
descriptiveTypeName
)
mozilla
:
:
ProfilerString8View
:
:
WrapNullTerminatedString
(
info
.
coarseType
)
info
.
size
info
.
inNursery
)
;
}
RacyRegisteredThread
:
:
RacyRegisteredThread
(
int
aThreadId
)
:
mProfilingStackOwner
(
mozilla
:
:
MakeNotNull
<
RefPtr
<
mozilla
:
:
ProfilingStackOwner
>
>
(
)
)
mThreadId
(
aThreadId
)
mSleep
(
AWAKE
)
mIsBeingProfiled
(
false
)
{
MOZ_COUNT_CTOR
(
RacyRegisteredThread
)
;
}
RegisteredThread
:
:
RegisteredThread
(
ThreadInfo
*
aInfo
nsIThread
*
aThread
void
*
aStackTop
)
:
mRacyRegisteredThread
(
aInfo
-
>
ThreadId
(
)
)
mPlatformData
(
AllocPlatformData
(
aInfo
-
>
ThreadId
(
)
)
)
mStackTop
(
aStackTop
)
mThreadInfo
(
aInfo
)
mThread
(
aThread
)
mContext
(
nullptr
)
mJSSampling
(
INACTIVE
)
mJSFlags
(
0
)
{
MOZ_COUNT_CTOR
(
RegisteredThread
)
;
#
if
defined
(
GP_OS_darwin
)
pthread_t
self
=
pthread_self
(
)
;
mStackTop
=
pthread_get_stackaddr_np
(
self
)
;
#
endif
}
RegisteredThread
:
:
~
RegisteredThread
(
)
{
MOZ_COUNT_DTOR
(
RegisteredThread
)
;
}
size_t
RegisteredThread
:
:
SizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
const
{
size_t
n
=
aMallocSizeOf
(
this
)
;
return
n
;
}
void
RegisteredThread
:
:
GetRunningEventDelay
(
const
mozilla
:
:
TimeStamp
&
aNow
mozilla
:
:
TimeDuration
&
aDelay
mozilla
:
:
TimeDuration
&
aRunning
)
{
if
(
mThread
)
{
mozilla
:
:
TimeStamp
start
;
mThread
-
>
GetRunningEventDelay
(
&
aDelay
&
start
)
;
if
(
!
start
.
IsNull
(
)
)
{
aRunning
=
aNow
-
start
;
return
;
}
}
aDelay
=
mozilla
:
:
TimeDuration
(
)
;
aRunning
=
mozilla
:
:
TimeDuration
(
)
;
}
void
RegisteredThread
:
:
SetJSContext
(
JSContext
*
aContext
)
{
MOZ_ASSERT
(
aContext
&
&
!
mContext
)
;
mContext
=
aContext
;
js
:
:
SetContextProfilingStack
(
aContext
&
RacyRegisteredThread
(
)
.
ProfilingStack
(
)
)
;
}
void
RegisteredThread
:
:
PollJSSampling
(
)
{
if
(
mContext
)
{
if
(
mJSSampling
=
=
ACTIVE_REQUESTED
)
{
mJSSampling
=
ACTIVE
;
js
:
:
EnableContextProfilingStack
(
mContext
true
)
;
if
(
JSTracerEnabled
(
)
)
{
JS
:
:
StartTraceLogger
(
mContext
)
;
}
if
(
JSAllocationsEnabled
(
)
)
{
JS
:
:
EnableRecordingAllocations
(
mContext
profiler_add_js_allocation_marker
0
.
01
)
;
}
js
:
:
RegisterContextProfilingEventMarker
(
mContext
profiler_add_js_marker
)
;
}
else
if
(
mJSSampling
=
=
INACTIVE_REQUESTED
)
{
mJSSampling
=
INACTIVE
;
js
:
:
EnableContextProfilingStack
(
mContext
false
)
;
if
(
JSTracerEnabled
(
)
)
{
JS
:
:
StopTraceLogger
(
mContext
)
;
}
if
(
JSAllocationsEnabled
(
)
)
{
JS
:
:
DisableRecordingAllocations
(
mContext
)
;
}
}
}
}
