add_task
(
async
function
test_profile_replacestate_page_info
(
)
{
if
(
!
AppConstants
.
MOZ_GECKO_PROFILER
)
{
return
;
}
Assert
.
ok
(
!
Services
.
profiler
.
IsActive
(
)
)
;
await
Services
.
profiler
.
ClearAllPages
(
)
;
startProfiler
(
)
;
const
url
=
BASE_URL
+
"
single_frame_replacestate
.
html
"
;
let
contentPid
;
await
BrowserTestUtils
.
withNewTab
(
url
async
function
(
contentBrowser
)
{
contentPid
=
await
ContentTask
.
spawn
(
contentBrowser
null
(
)
=
>
{
return
Services
.
appinfo
.
processID
;
}
)
;
}
)
;
const
profile
=
await
Services
.
profiler
.
getProfileDataAsync
(
)
;
Services
.
profiler
.
StopProfiler
(
)
;
let
foundPage
=
0
;
let
contentProcess
=
profile
.
processes
.
find
(
p
=
>
p
.
threads
[
0
]
.
pid
=
=
contentPid
)
;
for
(
const
page
of
contentProcess
.
pages
)
{
if
(
page
.
url
=
=
url
)
{
Assert
.
equal
(
page
.
url
url
)
;
Assert
.
equal
(
typeof
page
.
docshellId
"
string
"
)
;
Assert
.
equal
(
typeof
page
.
historyId
"
number
"
)
;
Assert
.
equal
(
page
.
isSubFrame
false
)
;
foundPage
+
+
;
}
Assert
.
notEqual
(
page
.
url
BASE_URL
+
"
single_frame
.
html
"
)
;
}
Assert
.
equal
(
foundPage
1
)
;
}
)
;
