#
include
"
gtest
/
gtest
.
h
"
#
include
"
ProfileBufferEntry
.
h
"
#
include
"
ThreadInfo
.
h
"
TEST
(
ThreadProfile
Initialization
)
{
int
tid
=
1000
;
nsCOMPtr
<
nsIThread
>
mainThread
;
NS_GetMainThread
(
getter_AddRefs
(
mainThread
)
)
;
ThreadInfo
info
(
"
testThread
"
tid
true
mainThread
nullptr
)
;
info
.
StartProfiling
(
)
;
}
TEST
(
ThreadProfile
InsertOneEntry
)
{
int
tid
=
1000
;
nsCOMPtr
<
nsIThread
>
mainThread
;
NS_GetMainThread
(
getter_AddRefs
(
mainThread
)
)
;
ThreadInfo
info
(
"
testThread
"
tid
true
mainThread
nullptr
)
;
auto
pb
=
MakeUnique
<
ProfileBuffer
>
(
10
)
;
pb
-
>
AddEntry
(
ProfileBufferEntry
:
:
Time
(
123
.
1
)
)
;
ASSERT_TRUE
(
pb
-
>
mEntries
!
=
nullptr
)
;
ASSERT_TRUE
(
pb
-
>
mEntries
[
pb
-
>
mReadPos
]
.
IsTime
(
)
)
;
ASSERT_TRUE
(
pb
-
>
mEntries
[
pb
-
>
mReadPos
]
.
u
.
mDouble
=
=
123
.
1
)
;
}
TEST
(
ThreadProfile
InsertEntriesNoWrap
)
{
int
tid
=
1000
;
nsCOMPtr
<
nsIThread
>
mainThread
;
NS_GetMainThread
(
getter_AddRefs
(
mainThread
)
)
;
ThreadInfo
info
(
"
testThread
"
tid
true
mainThread
nullptr
)
;
auto
pb
=
MakeUnique
<
ProfileBuffer
>
(
100
)
;
int
test_size
=
50
;
for
(
int
i
=
0
;
i
<
test_size
;
i
+
+
)
{
pb
-
>
AddEntry
(
ProfileBufferEntry
:
:
Time
(
i
)
)
;
}
ASSERT_TRUE
(
pb
-
>
mEntries
!
=
nullptr
)
;
uint32_t
readPos
=
pb
-
>
mReadPos
;
while
(
readPos
!
=
pb
-
>
mWritePos
)
{
ASSERT_TRUE
(
pb
-
>
mEntries
[
readPos
]
.
IsTime
(
)
)
;
ASSERT_TRUE
(
pb
-
>
mEntries
[
readPos
]
.
u
.
mDouble
=
=
readPos
)
;
readPos
=
(
readPos
+
1
)
%
pb
-
>
mEntrySize
;
}
}
TEST
(
ThreadProfile
InsertEntriesWrap
)
{
int
tid
=
1000
;
int
entries
=
24
;
int
buffer_size
=
entries
+
1
;
nsCOMPtr
<
nsIThread
>
mainThread
;
NS_GetMainThread
(
getter_AddRefs
(
mainThread
)
)
;
ThreadInfo
info
(
"
testThread
"
tid
true
mainThread
nullptr
)
;
auto
pb
=
MakeUnique
<
ProfileBuffer
>
(
buffer_size
)
;
int
test_size
=
43
;
for
(
int
i
=
0
;
i
<
test_size
;
i
+
+
)
{
pb
-
>
AddEntry
(
ProfileBufferEntry
:
:
Time
(
i
)
)
;
}
ASSERT_TRUE
(
pb
-
>
mEntries
!
=
nullptr
)
;
uint32_t
readPos
=
pb
-
>
mReadPos
;
int
ctr
=
0
;
while
(
readPos
!
=
pb
-
>
mWritePos
)
{
ASSERT_TRUE
(
pb
-
>
mEntries
[
readPos
]
.
IsTime
(
)
)
;
ASSERT_TRUE
(
pb
-
>
mEntries
[
readPos
]
.
u
.
mDouble
=
=
ctr
+
(
test_size
-
entries
)
)
;
ctr
+
+
;
readPos
=
(
readPos
+
1
)
%
pb
-
>
mEntrySize
;
}
}
