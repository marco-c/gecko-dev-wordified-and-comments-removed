#
include
"
ProfileBufferEntry
.
h
"
#
include
"
ThreadInfo
.
h
"
#
include
"
mozilla
/
PowerOfTwo
.
h
"
#
include
"
gtest
/
gtest
.
h
"
TEST
(
ThreadProfile
InsertOneEntry
)
{
auto
pb
=
MakeUnique
<
ProfileBuffer
>
(
mozilla
:
:
PowerOfTwo32
(
10
)
)
;
pb
-
>
AddEntry
(
ProfileBufferEntry
:
:
Time
(
123
.
1
)
)
;
ASSERT_TRUE
(
pb
-
>
GetEntry
(
pb
-
>
mRangeStart
)
.
IsTime
(
)
)
;
ASSERT_TRUE
(
pb
-
>
GetEntry
(
pb
-
>
mRangeStart
)
.
GetDouble
(
)
=
=
123
.
1
)
;
}
TEST
(
ThreadProfile
InsertEntriesNoWrap
)
{
auto
pb
=
MakeUnique
<
ProfileBuffer
>
(
mozilla
:
:
PowerOfTwo32
(
100
)
)
;
int
test_size
=
50
;
for
(
int
i
=
0
;
i
<
test_size
;
i
+
+
)
{
pb
-
>
AddEntry
(
ProfileBufferEntry
:
:
Time
(
i
)
)
;
}
uint64_t
readPos
=
pb
-
>
mRangeStart
;
while
(
readPos
!
=
pb
-
>
mRangeEnd
)
{
ASSERT_TRUE
(
pb
-
>
GetEntry
(
readPos
)
.
IsTime
(
)
)
;
ASSERT_TRUE
(
pb
-
>
GetEntry
(
readPos
)
.
GetDouble
(
)
=
=
readPos
)
;
readPos
+
+
;
}
}
TEST
(
ThreadProfile
InsertEntriesWrap
)
{
int
entries
=
32
;
auto
pb
=
MakeUnique
<
ProfileBuffer
>
(
mozilla
:
:
PowerOfTwo32
(
entries
)
)
;
ASSERT_TRUE
(
pb
-
>
mRangeStart
=
=
0
)
;
ASSERT_TRUE
(
pb
-
>
mRangeEnd
=
=
0
)
;
int
test_size
=
43
;
for
(
int
i
=
0
;
i
<
test_size
;
i
+
+
)
{
pb
-
>
AddEntry
(
ProfileBufferEntry
:
:
Time
(
i
)
)
;
}
ASSERT_TRUE
(
pb
-
>
mRangeStart
=
=
11
)
;
uint64_t
readPos
=
pb
-
>
mRangeStart
;
while
(
readPos
!
=
pb
-
>
mRangeEnd
)
{
ASSERT_TRUE
(
pb
-
>
GetEntry
(
readPos
)
.
IsTime
(
)
)
;
ASSERT_TRUE
(
pb
-
>
GetEntry
(
readPos
)
.
GetDouble
(
)
=
=
readPos
)
;
readPos
+
+
;
}
}
