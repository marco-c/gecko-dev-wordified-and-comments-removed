function
run_test
(
)
{
if
(
!
AppConstants
.
MOZ_GECKO_PROFILER
)
{
return
;
}
Assert
.
ok
(
!
Services
.
profiler
.
IsActive
(
)
)
;
const
ms
=
5
;
Services
.
profiler
.
StartProfiler
(
10000
ms
[
"
js
"
]
)
;
function
has_arbitrary_name_in_stack
(
)
{
var
delayMS
=
5
;
while
(
1
)
{
info
(
"
loop
:
ms
=
"
+
delayMS
)
;
const
then
=
Date
.
now
(
)
;
do
{
let
n
=
10000
;
while
(
-
-
n
)
{
}
}
while
(
Date
.
now
(
)
-
then
<
delayMS
)
;
let
profile
=
Services
.
profiler
.
getProfileData
(
)
.
threads
[
0
]
;
for
(
const
sample
of
profile
.
samples
.
data
)
{
const
stack
=
getInflatedStackLocations
(
profile
sample
)
;
info
(
The
following
stack
was
found
:
{
stack
}
)
;
for
(
var
i
=
0
;
i
<
stack
.
length
;
i
+
+
)
{
if
(
stack
[
i
]
.
match
(
/
arbitrary_name
/
)
)
{
return
true
;
}
}
}
delayMS
*
=
2
;
if
(
delayMS
>
30000
)
{
return
false
;
}
}
}
Assert
.
ok
(
has_arbitrary_name_in_stack
(
)
"
A
JS
frame
was
found
before
the
test
timeout
.
"
)
;
Services
.
profiler
.
StopProfiler
(
)
;
}
