add_task
(
async
(
)
=
>
{
if
(
!
AppConstants
.
MOZ_GECKO_PROFILER
)
{
return
;
}
const
entries
=
10000
;
const
interval
=
1
;
const
threads
=
[
]
;
const
features
=
[
"
js
"
"
stackwalk
"
]
;
Services
.
profiler
.
StartProfiler
(
entries
interval
features
threads
)
;
const
sampleIndex
=
await
functionA
(
)
;
const
profile
=
await
Services
.
profiler
.
getProfileDataAsync
(
)
;
const
[
thread
]
=
profile
.
threads
;
const
{
samples
}
=
thread
;
const
inflatedStackFrames
=
getInflatedStackLocations
(
thread
samples
.
data
[
sampleIndex
]
)
;
const
nativeStack
=
/
^
0x
[
0
-
9a
-
f
]
+
/
;
expectStackToContain
(
inflatedStackFrames
[
"
(
root
)
"
nativeStack
nativeStack
"
js
:
:
RunScript
"
nativeStack
nativeStack
/
^
functionA
\
(
.
+
test_merged_stacks
\
.
js
:
\
d
+
:
\
d
+
\
)
/
/
^
functionB
\
(
.
+
test_merged_stacks
\
.
js
:
\
d
+
:
\
d
+
\
)
/
/
^
functionC
\
(
.
+
test_merged_stacks
\
.
js
:
\
d
+
:
\
d
+
\
)
/
nativeStack
nativeStack
]
"
The
stack
contains
a
few
frame
labels
as
well
as
the
JS
functions
that
we
called
.
"
)
;
}
)
;
function
functionA
(
)
{
return
functionB
(
)
;
}
function
functionB
(
)
{
return
functionC
(
)
;
}
async
function
functionC
(
)
{
return
captureAtLeastOneJsSample
(
)
;
}
