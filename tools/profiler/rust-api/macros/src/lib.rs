#
!
[
deny
(
warnings
)
]
extern
crate
proc_macro
;
use
proc_macro
:
:
TokenStream
;
use
quote
:
:
quote
;
use
syn
:
:
{
parse_macro_input
AttributeArgs
ItemFn
}
;
#
[
proc_macro_attribute
]
pub
fn
gecko_profiler_fn_label
(
attrs
:
TokenStream
input
:
TokenStream
)
-
>
TokenStream
{
let
attr_args
=
parse_macro_input
!
(
attrs
as
AttributeArgs
)
;
let
input
=
parse_macro_input
!
(
input
as
ItemFn
)
;
if
attr_args
.
is_empty
(
)
|
|
attr_args
.
len
(
)
>
2
{
panic
!
(
"
Expected
one
or
two
arguments
as
ProfilingCategory
or
ProfilingCategoryPair
but
{
}
arguments
provided
!
"
attr_args
.
len
(
)
)
;
}
let
category_name
=
&
attr_args
[
0
]
;
let
subcategory_if_provided
=
match
attr_args
.
get
(
1
)
{
Some
(
subcategory
)
=
>
quote
!
(
#
subcategory
)
None
=
>
quote
!
(
)
}
;
let
ItemFn
{
attrs
vis
sig
block
}
=
input
;
let
stmts
=
&
block
.
stmts
;
let
new_fn
=
quote
!
{
#
(
#
attrs
)
*
#
vis
#
sig
{
gecko_profiler_label
!
(
#
category_name
#
subcategory_if_provided
)
;
#
(
#
stmts
)
*
}
}
;
new_fn
.
into
(
)
}
