#
include
"
ChildProfilerController
.
h
"
#
include
"
ProfilerChild
.
h
"
#
include
"
nsThreadUtils
.
h
"
using
namespace
mozilla
:
:
ipc
;
namespace
mozilla
{
already_AddRefed
<
ChildProfilerController
>
ChildProfilerController
:
:
Create
(
mozilla
:
:
ipc
:
:
Endpoint
<
PProfilerChild
>
&
&
aEndpoint
)
{
MOZ_RELEASE_ASSERT
(
NS_IsMainThread
(
)
)
;
RefPtr
<
ChildProfilerController
>
cpc
=
new
ChildProfilerController
(
)
;
cpc
-
>
Init
(
std
:
:
move
(
aEndpoint
)
)
;
return
cpc
.
forget
(
)
;
}
ChildProfilerController
:
:
ChildProfilerController
(
)
{
MOZ_COUNT_CTOR
(
ChildProfilerController
)
;
}
void
ChildProfilerController
:
:
Init
(
Endpoint
<
PProfilerChild
>
&
&
aEndpoint
)
{
if
(
NS_SUCCEEDED
(
NS_NewNamedThread
(
"
ProfilerChild
"
getter_AddRefs
(
mThread
)
)
)
)
{
mThread
-
>
Dispatch
(
NewRunnableMethod
<
Endpoint
<
PProfilerChild
>
&
&
>
(
"
ChildProfilerController
:
:
SetupProfilerChild
"
this
&
ChildProfilerController
:
:
SetupProfilerChild
std
:
:
move
(
aEndpoint
)
)
NS_DISPATCH_NORMAL
)
;
}
}
nsCString
ChildProfilerController
:
:
GrabShutdownProfileAndShutdown
(
)
{
nsCString
shutdownProfile
;
ShutdownAndMaybeGrabShutdownProfileFirst
(
&
shutdownProfile
)
;
return
shutdownProfile
;
}
void
ChildProfilerController
:
:
Shutdown
(
)
{
ShutdownAndMaybeGrabShutdownProfileFirst
(
nullptr
)
;
}
void
ChildProfilerController
:
:
ShutdownAndMaybeGrabShutdownProfileFirst
(
nsCString
*
aOutShutdownProfile
)
{
if
(
mThread
)
{
mThread
-
>
Dispatch
(
NewRunnableMethod
<
nsCString
*
>
(
"
ChildProfilerController
:
:
ShutdownProfilerChild
"
this
&
ChildProfilerController
:
:
ShutdownProfilerChild
aOutShutdownProfile
)
NS_DISPATCH_NORMAL
)
;
mThread
-
>
Shutdown
(
)
;
mThread
=
nullptr
;
}
}
ChildProfilerController
:
:
~
ChildProfilerController
(
)
{
MOZ_COUNT_DTOR
(
ChildProfilerController
)
;
MOZ_ASSERT
(
!
mThread
"
Please
call
Shutdown
before
destroying
ChildProfilerController
"
)
;
MOZ_ASSERT
(
!
mProfilerChild
)
;
}
void
ChildProfilerController
:
:
SetupProfilerChild
(
Endpoint
<
PProfilerChild
>
&
&
aEndpoint
)
{
MOZ_RELEASE_ASSERT
(
mThread
=
=
NS_GetCurrentThread
(
)
)
;
MOZ_ASSERT
(
aEndpoint
.
IsValid
(
)
)
;
mProfilerChild
=
new
ProfilerChild
(
)
;
Endpoint
<
PProfilerChild
>
endpoint
=
std
:
:
move
(
aEndpoint
)
;
if
(
!
endpoint
.
Bind
(
mProfilerChild
)
)
{
MOZ_CRASH
(
"
Failed
to
bind
ProfilerChild
!
"
)
;
}
}
void
ChildProfilerController
:
:
ShutdownProfilerChild
(
nsCString
*
aOutShutdownProfile
)
{
MOZ_RELEASE_ASSERT
(
mThread
=
=
NS_GetCurrentThread
(
)
)
;
if
(
aOutShutdownProfile
)
{
*
aOutShutdownProfile
=
mProfilerChild
-
>
GrabShutdownProfile
(
)
;
}
mProfilerChild
-
>
Destroy
(
)
;
mProfilerChild
=
nullptr
;
}
}
