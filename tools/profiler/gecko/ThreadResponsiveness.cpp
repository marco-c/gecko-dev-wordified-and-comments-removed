#
include
"
ThreadResponsiveness
.
h
"
#
include
"
platform
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
using
mozilla
:
:
Monitor
;
using
mozilla
:
:
MonitorAutoLock
;
using
mozilla
:
:
TimeStamp
;
class
CheckResponsivenessTask
:
public
mozilla
:
:
Runnable
public
nsITimerCallback
{
public
:
CheckResponsivenessTask
(
)
:
mLastTracerTime
(
TimeStamp
:
:
Now
(
)
)
mMonitor
(
"
CheckResponsivenessTask
"
)
mTimer
(
nullptr
)
mHasEverBeenSuccessfullyDispatched
(
false
)
mStop
(
false
)
{
}
protected
:
~
CheckResponsivenessTask
(
)
{
}
public
:
void
DoFirstDispatchIfNeeded
(
)
{
if
(
mHasEverBeenSuccessfullyDispatched
)
{
return
;
}
nsresult
rv
=
NS_DispatchToMainThread
(
this
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
mHasEverBeenSuccessfullyDispatched
=
true
;
}
}
NS_IMETHOD
Run
(
)
override
{
MonitorAutoLock
mon
(
mMonitor
)
;
if
(
mStop
)
return
NS_OK
;
mLastTracerTime
=
TimeStamp
:
:
Now
(
)
;
if
(
!
mTimer
)
{
mTimer
=
do_CreateInstance
(
"
mozilla
.
org
/
timer
;
1
"
)
;
}
mTimer
-
>
InitWithCallback
(
this
16
nsITimer
:
:
TYPE_ONE_SHOT
)
;
return
NS_OK
;
}
NS_IMETHOD
Notify
(
nsITimer
*
aTimer
)
final
{
NS_DispatchToMainThread
(
this
)
;
return
NS_OK
;
}
void
Terminate
(
)
{
MonitorAutoLock
mon
(
mMonitor
)
;
mStop
=
true
;
}
const
TimeStamp
&
GetLastTracerTime
(
)
const
{
return
mLastTracerTime
;
}
NS_DECL_ISUPPORTS_INHERITED
private
:
TimeStamp
mLastTracerTime
;
Monitor
mMonitor
;
nsCOMPtr
<
nsITimer
>
mTimer
;
bool
mHasEverBeenSuccessfullyDispatched
;
bool
mStop
;
}
;
NS_IMPL_ISUPPORTS_INHERITED
(
CheckResponsivenessTask
mozilla
:
:
Runnable
nsITimerCallback
)
ThreadResponsiveness
:
:
ThreadResponsiveness
(
)
:
mActiveTracerEvent
(
new
CheckResponsivenessTask
(
)
)
{
MOZ_COUNT_CTOR
(
ThreadResponsiveness
)
;
}
ThreadResponsiveness
:
:
~
ThreadResponsiveness
(
)
{
MOZ_COUNT_DTOR
(
ThreadResponsiveness
)
;
mActiveTracerEvent
-
>
Terminate
(
)
;
}
void
ThreadResponsiveness
:
:
Update
(
)
{
mActiveTracerEvent
-
>
DoFirstDispatchIfNeeded
(
)
;
mLastTracerTime
=
mActiveTracerEvent
-
>
GetLastTracerTime
(
)
;
}
