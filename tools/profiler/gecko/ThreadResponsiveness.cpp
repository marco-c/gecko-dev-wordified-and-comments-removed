#
include
"
ThreadResponsiveness
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
SystemGroup
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
platform
.
h
"
using
namespace
mozilla
;
class
CheckResponsivenessTask
:
public
Runnable
public
nsITimerCallback
{
public
:
CheckResponsivenessTask
(
)
:
Runnable
(
"
CheckResponsivenessTask
"
)
mStartToPrevTracer_us
(
uint64_t
(
profiler_time
(
)
*
1000
.
0
)
)
mStop
(
false
)
mHasEverBeenSuccessfullyDispatched
(
false
)
{
}
protected
:
~
CheckResponsivenessTask
(
)
{
}
public
:
void
DoFirstDispatchIfNeeded
(
)
{
if
(
mHasEverBeenSuccessfullyDispatched
)
{
return
;
}
nsCOMPtr
<
nsIThread
>
mainThread
;
nsresult
rv
=
NS_GetMainThread
(
getter_AddRefs
(
mainThread
)
)
;
if
(
NS_SUCCEEDED
(
rv
)
&
&
mainThread
)
{
rv
=
SystemGroup
:
:
Dispatch
(
TaskCategory
:
:
Other
do_AddRef
(
this
)
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
mHasEverBeenSuccessfullyDispatched
=
true
;
}
}
}
NS_IMETHOD
Run
(
)
override
{
mStartToPrevTracer_us
=
uint64_t
(
profiler_time
(
)
*
1000
.
0
)
;
if
(
!
mStop
)
{
if
(
!
mTimer
)
{
mTimer
=
NS_NewTimer
(
SystemGroup
:
:
EventTargetFor
(
TaskCategory
:
:
Other
)
)
;
}
mTimer
-
>
InitWithCallback
(
this
16
nsITimer
:
:
TYPE_ONE_SHOT
)
;
}
return
NS_OK
;
}
NS_IMETHOD
Notify
(
nsITimer
*
aTimer
)
final
override
{
SystemGroup
:
:
Dispatch
(
TaskCategory
:
:
Other
do_AddRef
(
this
)
)
;
return
NS_OK
;
}
void
Terminate
(
)
{
mStop
=
true
;
}
double
GetStartToPrevTracer_ms
(
)
const
{
return
mStartToPrevTracer_us
/
1000
.
0
;
}
NS_DECL_ISUPPORTS_INHERITED
private
:
nsCOMPtr
<
nsITimer
>
mTimer
;
Atomic
<
uint64_t
>
mStartToPrevTracer_us
;
Atomic
<
bool
>
mStop
;
bool
mHasEverBeenSuccessfullyDispatched
;
}
;
NS_IMPL_ISUPPORTS_INHERITED
(
CheckResponsivenessTask
mozilla
:
:
Runnable
nsITimerCallback
)
ThreadResponsiveness
:
:
ThreadResponsiveness
(
)
:
mActiveTracerEvent
(
new
CheckResponsivenessTask
(
)
)
{
MOZ_COUNT_CTOR
(
ThreadResponsiveness
)
;
}
ThreadResponsiveness
:
:
~
ThreadResponsiveness
(
)
{
MOZ_COUNT_DTOR
(
ThreadResponsiveness
)
;
mActiveTracerEvent
-
>
Terminate
(
)
;
}
void
ThreadResponsiveness
:
:
Update
(
)
{
mActiveTracerEvent
-
>
DoFirstDispatchIfNeeded
(
)
;
mStartToPrevTracer_ms
=
Some
(
mActiveTracerEvent
-
>
GetStartToPrevTracer_ms
(
)
)
;
}
