#
include
"
GeckoProfiler
.
h
"
#
include
"
ProfilerChild
.
h
"
#
include
"
nsThreadUtils
.
h
"
namespace
mozilla
{
ProfilerChild
:
:
ProfilerChild
(
)
:
mThread
(
NS_GetCurrentThread
(
)
)
mDestroyed
(
false
)
{
MOZ_COUNT_CTOR
(
ProfilerChild
)
;
}
ProfilerChild
:
:
~
ProfilerChild
(
)
{
MOZ_COUNT_DTOR
(
ProfilerChild
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
ProfilerChild
:
:
RecvStart
(
const
ProfilerInitParams
&
params
)
{
nsTArray
<
const
char
*
>
filterArray
;
for
(
size_t
i
=
0
;
i
<
params
.
filters
(
)
.
Length
(
)
;
+
+
i
)
{
filterArray
.
AppendElement
(
params
.
filters
(
)
[
i
]
.
get
(
)
)
;
}
profiler_start
(
params
.
entries
(
)
params
.
interval
(
)
params
.
features
(
)
filterArray
.
Elements
(
)
filterArray
.
Length
(
)
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
ProfilerChild
:
:
RecvEnsureStarted
(
const
ProfilerInitParams
&
params
)
{
nsTArray
<
const
char
*
>
filterArray
;
for
(
size_t
i
=
0
;
i
<
params
.
filters
(
)
.
Length
(
)
;
+
+
i
)
{
filterArray
.
AppendElement
(
params
.
filters
(
)
[
i
]
.
get
(
)
)
;
}
profiler_ensure_started
(
params
.
entries
(
)
params
.
interval
(
)
params
.
features
(
)
filterArray
.
Elements
(
)
filterArray
.
Length
(
)
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
ProfilerChild
:
:
RecvStop
(
)
{
profiler_stop
(
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
ProfilerChild
:
:
RecvPause
(
)
{
profiler_pause
(
)
;
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
ProfilerChild
:
:
RecvResume
(
)
{
profiler_resume
(
)
;
return
IPC_OK
(
)
;
}
static
nsCString
CollectProfileOrEmptyString
(
bool
aIsShuttingDown
)
{
nsCString
profileCString
;
UniquePtr
<
char
[
]
>
profile
=
profiler_get_profile
(
0
aIsShuttingDown
)
;
if
(
profile
)
{
profileCString
=
nsCString
(
profile
.
get
(
)
strlen
(
profile
.
get
(
)
)
)
;
}
else
{
profileCString
=
EmptyCString
(
)
;
}
return
profileCString
;
}
Shmem
ProfilerChild
:
:
ConvertProfileStringToShmem
(
const
nsCString
&
aProfileCString
)
{
Shmem
shmem
;
if
(
!
AllocShmem
(
aProfileCString
.
Length
(
)
SharedMemory
:
:
TYPE_BASIC
&
shmem
)
)
{
return
shmem
;
}
PodCopy
(
shmem
.
get
<
char
>
(
)
aProfileCString
.
BeginReading
(
)
aProfileCString
.
Length
(
)
)
;
return
shmem
;
}
mozilla
:
:
ipc
:
:
IPCResult
ProfilerChild
:
:
RecvGatherProfile
(
GatherProfileResolver
&
&
aResolve
)
{
nsCString
profile
=
CollectProfileOrEmptyString
(
false
)
;
aResolve
(
ConvertProfileStringToShmem
(
profile
)
)
;
return
IPC_OK
(
)
;
}
void
ProfilerChild
:
:
ActorDestroy
(
ActorDestroyReason
aActorDestroyReason
)
{
mDestroyed
=
true
;
}
void
ProfilerChild
:
:
Destroy
(
)
{
if
(
!
mDestroyed
)
{
Close
(
)
;
}
}
nsCString
ProfilerChild
:
:
GrabShutdownProfile
(
)
{
return
CollectProfileOrEmptyString
(
true
)
;
}
}
