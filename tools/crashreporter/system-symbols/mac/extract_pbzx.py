import
lzma
import
struct
import
sys
def
extract_pbzx
(
pbzx_path
)
:
    
with
open
(
pbzx_path
"
rb
"
)
as
f
:
        
magic
=
f
.
read
(
4
)
        
if
magic
!
=
b
"
pbzx
"
:
            
raise
Exception
(
"
Not
a
PBZX
payload
?
"
)
        
chunk_size
=
f
.
read
(
8
)
        
chunk_size
=
struct
.
unpack
(
"
>
Q
"
chunk_size
)
[
0
]
        
with
open
(
pbzx_path
+
"
.
cpio
"
"
wb
"
)
as
out
:
            
while
True
:
                
header
=
f
.
read
(
16
)
                
if
header
=
=
b
"
"
:
                    
break
                
if
len
(
header
)
!
=
16
:
                    
raise
Exception
(
"
Corrupted
PBZX
payload
?
"
)
                
decompressed_size
compressed_size
=
struct
.
unpack
(
"
>
QQ
"
header
)
                
if
compressed_size
=
=
decompressed_size
:
                    
out
.
write
(
f
.
read
(
decompressed_size
)
)
                
else
:
                    
data
=
lzma
.
decompress
(
f
.
read
(
compressed_size
)
)
                    
if
len
(
data
)
!
=
decompressed_size
:
                        
raise
Exception
(
"
Corrupted
PBZX
payload
?
"
)
                    
out
.
write
(
data
)
if
__name__
=
=
"
__main__
"
:
    
extract_pbzx
(
sys
.
argv
[
1
]
)
