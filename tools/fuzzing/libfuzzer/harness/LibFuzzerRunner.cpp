#
include
<
cstdlib
>
#
include
"
LibFuzzerRunner
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
prenv
.
h
"
#
include
"
LibFuzzerTestHarness
.
h
"
namespace
mozilla
{
class
_InitLibFuzzer
{
public
:
_InitLibFuzzer
(
)
{
libFuzzerRunner
=
new
LibFuzzerRunner
(
)
;
}
}
InitLibFuzzer
;
int
LibFuzzerRunner
:
:
Run
(
int
*
argc
char
*
*
*
argv
)
{
ScopedXPCOM
xpcom
(
"
LibFuzzer
"
)
;
std
:
:
string
moduleNameStr
(
getenv
(
"
LIBFUZZER
"
)
)
;
LibFuzzerFunctions
funcs
=
LibFuzzerRegistry
:
:
getInstance
(
)
.
getModuleFunctions
(
moduleNameStr
)
;
LibFuzzerInitFunc
initFunc
=
funcs
.
first
;
LibFuzzerTestingFunc
testingFunc
=
funcs
.
second
;
if
(
initFunc
)
{
int
ret
=
initFunc
(
argc
argv
)
;
if
(
ret
)
{
fprintf
(
stderr
"
LibFuzzer
:
Error
:
Initialize
callback
failed
\
n
"
)
;
return
ret
;
}
}
if
(
!
testingFunc
)
{
fprintf
(
stderr
"
LibFuzzer
:
Error
:
No
testing
callback
found
\
n
"
)
;
return
1
;
}
return
mFuzzerDriver
(
argc
argv
testingFunc
)
;
}
void
LibFuzzerRunner
:
:
setParams
(
LibFuzzerDriver
aDriver
)
{
mFuzzerDriver
=
aDriver
;
}
}
