#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
PageloadEvent
.
h
"
#
include
"
mozilla
/
RandomNum
.
h
"
#
include
"
mozilla
/
glean
/
DomMetrics
.
h
"
namespace
mozilla
:
:
performance
:
:
pageload_event
{
#
ifdef
NIGHTLY_BUILD
static
constexpr
uint64_t
kNormalSamplingInterval
=
1
;
#
else
static
constexpr
uint64_t
kNormalSamplingInterval
=
10
;
#
endif
PageloadEventType
GetPageloadEventType
(
)
{
Maybe
<
uint64_t
>
rand
=
mozilla
:
:
RandomUint64
(
)
;
if
(
rand
.
isSome
(
)
)
{
uint64_t
result
=
static_cast
<
uint64_t
>
(
rand
.
value
(
)
%
kNormalSamplingInterval
)
;
if
(
result
=
=
0
)
{
return
PageloadEventType
:
:
kNormal
;
}
}
return
PageloadEventType
:
:
kNone
;
}
void
PageloadEventData
:
:
SetDocumentFeature
(
DocumentFeature
aFeature
)
{
uint32_t
value
=
0
;
if
(
documentFeatures
.
isSome
(
)
)
{
value
=
documentFeatures
.
value
(
)
;
}
value
|
=
aFeature
;
documentFeatures
=
mozilla
:
:
Some
(
value
)
;
}
void
PageloadEventData
:
:
SetUserFeature
(
UserFeature
aFeature
)
{
uint32_t
value
=
0
;
if
(
userFeatures
.
isSome
(
)
)
{
value
=
userFeatures
.
value
(
)
;
}
value
|
=
aFeature
;
userFeatures
=
mozilla
:
:
Some
(
value
)
;
}
mozilla
:
:
glean
:
:
perf
:
:
PageLoadExtra
PageloadEventData
:
:
ToPageLoadExtra
(
)
const
{
mozilla
:
:
glean
:
:
perf
:
:
PageLoadExtra
out
;
#
define
COPY_METRIC
(
name
type
)
out
.
name
=
this
-
>
name
;
FOR_EACH_PAGELOAD_METRIC
(
COPY_METRIC
)
#
undef
COPY_METRIC
return
out
;
}
}
