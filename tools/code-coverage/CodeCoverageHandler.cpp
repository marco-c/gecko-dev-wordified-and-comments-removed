#
include
<
signal
.
h
>
#
include
<
stdio
.
h
>
#
include
<
unistd
.
h
>
#
include
"
mozilla
/
CodeCoverageHandler
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
nsAppRunner
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
ipc
;
extern
"
C
"
void
__gcov_dump
(
)
;
extern
"
C
"
void
__gcov_reset
(
)
;
StaticAutoPtr
<
CodeCoverageHandler
>
CodeCoverageHandler
:
:
instance
;
void
CodeCoverageHandler
:
:
DumpCounters
(
int
)
{
CrossProcessMutexAutoLock
lock
(
*
CodeCoverageHandler
:
:
Get
(
)
-
>
GetMutex
(
)
)
;
printf_stderr
(
"
[
CodeCoverage
]
Requested
dump
.
\
n
"
)
;
__gcov_dump
(
)
;
printf_stderr
(
"
[
CodeCoverage
]
Dump
completed
.
\
n
"
)
;
}
void
CodeCoverageHandler
:
:
ResetCounters
(
int
)
{
CrossProcessMutexAutoLock
lock
(
*
CodeCoverageHandler
:
:
Get
(
)
-
>
GetMutex
(
)
)
;
printf_stderr
(
"
[
CodeCoverage
]
Requested
reset
.
\
n
"
)
;
__gcov_reset
(
)
;
printf_stderr
(
"
[
CodeCoverage
]
Reset
completed
.
\
n
"
)
;
}
void
CodeCoverageHandler
:
:
SetSignalHandlers
(
)
{
printf_stderr
(
"
[
CodeCoverage
]
Setting
handlers
for
process
%
d
.
\
n
"
getpid
(
)
)
;
struct
sigaction
dump_sa
;
dump_sa
.
sa_handler
=
CodeCoverageHandler
:
:
DumpCounters
;
dump_sa
.
sa_flags
=
SA_RESTART
;
sigemptyset
(
&
dump_sa
.
sa_mask
)
;
MOZ_ASSERT
(
sigaction
(
SIGUSR1
&
dump_sa
nullptr
)
=
=
0
)
;
struct
sigaction
reset_sa
;
reset_sa
.
sa_handler
=
CodeCoverageHandler
:
:
ResetCounters
;
reset_sa
.
sa_flags
=
SA_RESTART
;
sigemptyset
(
&
reset_sa
.
sa_mask
)
;
MOZ_ASSERT
(
sigaction
(
SIGUSR2
&
reset_sa
nullptr
)
=
=
0
)
;
}
CodeCoverageHandler
:
:
CodeCoverageHandler
(
)
:
mGcovLock
(
"
GcovLock
"
)
{
SetSignalHandlers
(
)
;
}
CodeCoverageHandler
:
:
CodeCoverageHandler
(
const
CrossProcessMutexHandle
&
aHandle
)
:
mGcovLock
(
aHandle
)
{
SetSignalHandlers
(
)
;
}
void
CodeCoverageHandler
:
:
Init
(
)
{
MOZ_ASSERT
(
!
instance
)
;
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
instance
=
new
CodeCoverageHandler
(
)
;
ClearOnShutdown
(
&
instance
)
;
}
void
CodeCoverageHandler
:
:
Init
(
const
CrossProcessMutexHandle
&
aHandle
)
{
MOZ_ASSERT
(
!
instance
)
;
MOZ_ASSERT
(
!
XRE_IsParentProcess
(
)
)
;
instance
=
new
CodeCoverageHandler
(
aHandle
)
;
ClearOnShutdown
(
&
instance
)
;
}
CodeCoverageHandler
*
CodeCoverageHandler
:
:
Get
(
)
{
MOZ_ASSERT
(
instance
)
;
return
instance
;
}
CrossProcessMutex
*
CodeCoverageHandler
:
:
GetMutex
(
)
{
return
&
mGcovLock
;
}
CrossProcessMutexHandle
CodeCoverageHandler
:
:
GetMutexHandle
(
int
aProcId
)
{
return
mGcovLock
.
ShareToProcess
(
aProcId
)
;
}
