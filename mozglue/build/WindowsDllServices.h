#
ifndef
mozilla_glue_WindowsDllServices_h
#
define
mozilla_glue_WindowsDllServices_h
#
include
"
mozilla
/
WindowsDllBlocklist
.
h
"
#
if
defined
(
MOZILLA_INTERNAL_API
)
#
include
"
mozilla
/
SystemGroup
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
endif
#
include
<
winternl
.
h
>
namespace
mozilla
{
namespace
glue
{
namespace
detail
{
class
DllServicesBase
{
public
:
virtual
void
DispatchDllLoadNotification
(
PCUNICODE_STRING
aDllName
)
=
0
;
void
Disable
(
)
{
DllBlocklist_SetDllServices
(
nullptr
)
;
}
DllServicesBase
(
const
DllServicesBase
&
)
=
delete
;
DllServicesBase
(
DllServicesBase
&
&
)
=
delete
;
DllServicesBase
&
operator
=
(
const
DllServicesBase
&
)
=
delete
;
DllServicesBase
&
operator
=
(
DllServicesBase
&
&
)
=
delete
;
protected
:
DllServicesBase
(
)
=
default
;
virtual
~
DllServicesBase
(
)
=
default
;
void
Enable
(
)
{
DllBlocklist_SetDllServices
(
this
)
;
}
}
;
}
#
if
defined
(
MOZILLA_INTERNAL_API
)
class
DllServices
:
public
detail
:
:
DllServicesBase
{
public
:
virtual
void
DispatchDllLoadNotification
(
PCUNICODE_STRING
aDllName
)
override
final
{
nsDependentSubstring
strDllName
(
aDllName
-
>
Buffer
aDllName
-
>
Length
/
sizeof
(
wchar_t
)
)
;
nsCOMPtr
<
nsIRunnable
>
runnable
(
NewRunnableMethod
<
bool
nsString
>
(
"
DllServices
:
:
NotifyDllLoad
"
this
&
DllServices
:
:
NotifyDllLoad
NS_IsMainThread
(
)
strDllName
)
)
;
SystemGroup
:
:
Dispatch
(
TaskCategory
:
:
Other
runnable
.
forget
(
)
)
;
}
NS_INLINE_DECL_THREADSAFE_VIRTUAL_REFCOUNTING
(
DllServices
)
protected
:
DllServices
(
)
=
default
;
~
DllServices
(
)
=
default
;
virtual
void
NotifyDllLoad
(
const
bool
aIsMainThread
const
nsString
&
aDllName
)
=
0
;
}
;
#
endif
}
}
#
endif
