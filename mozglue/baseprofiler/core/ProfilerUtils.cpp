#
include
"
mozilla
/
BaseProfilerUtils
.
h
"
#
if
defined
(
__wasi__
)
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerProcessId
profiler_current_process_id
(
)
{
return
BaseProfilerProcessId
:
:
FromNativeId
(
1u
)
;
}
BaseProfilerThreadId
profiler_current_thread_id
(
)
{
return
BaseProfilerThreadId
:
:
FromNativeId
(
1u
)
;
}
}
#
elif
defined
(
XP_WIN
)
#
include
<
process
.
h
>
#
include
<
processthreadsapi
.
h
>
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerProcessId
profiler_current_process_id
(
)
{
return
BaseProfilerProcessId
:
:
FromNativeId
(
_getpid
(
)
)
;
}
BaseProfilerThreadId
profiler_current_thread_id
(
)
{
static_assert
(
std
:
:
is_same_v
<
BaseProfilerThreadId
:
:
NativeType
decltype
(
GetCurrentThreadId
(
)
)
>
"
BaseProfilerThreadId
:
:
NativeType
must
be
exactly
the
type
"
"
returned
by
GetCurrentThreadId
(
)
"
)
;
return
BaseProfilerThreadId
:
:
FromNativeId
(
GetCurrentThreadId
(
)
)
;
}
}
#
else
#
include
<
unistd
.
h
>
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerProcessId
profiler_current_process_id
(
)
{
return
BaseProfilerProcessId
:
:
FromNativeId
(
getpid
(
)
)
;
}
}
#
if
defined
(
XP_MACOSX
)
#
include
<
pthread
.
h
>
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerThreadId
profiler_current_thread_id
(
)
{
uint64_t
tid
;
if
(
pthread_threadid_np
(
nullptr
&
tid
)
!
=
0
)
{
return
BaseProfilerThreadId
{
}
;
}
return
BaseProfilerThreadId
:
:
FromNativeId
(
tid
)
;
}
}
#
elif
defined
(
__ANDROID__
)
|
|
defined
(
ANDROID
)
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerThreadId
profiler_current_thread_id
(
)
{
return
BaseProfilerThreadId
:
:
FromNativeId
(
gettid
(
)
)
;
}
}
#
elif
defined
(
XP_LINUX
)
#
include
<
sys
/
syscall
.
h
>
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerThreadId
profiler_current_thread_id
(
)
{
static
thread_local
pid_t
tid
;
if
(
!
tid
)
{
tid
=
static_cast
<
pid_t
>
(
syscall
(
SYS_gettid
)
)
;
}
return
BaseProfilerThreadId
:
:
FromNativeId
(
tid
)
;
}
}
#
elif
defined
(
XP_FREEBSD
)
#
include
<
sys
/
thr
.
h
>
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerThreadId
profiler_current_thread_id
(
)
{
long
id
;
if
(
thr_self
(
&
id
)
!
=
0
)
{
return
BaseProfilerThreadId
{
}
;
}
return
BaseProfilerThreadId
:
:
FromNativeId
(
id
)
;
}
}
#
else
namespace
mozilla
:
:
baseprofiler
{
BaseProfilerThreadId
profiler_current_thread_id
(
)
{
return
BaseProfilerThreadId
:
:
FromNativeId
(
std
:
:
this_thread
:
:
get_id
(
)
)
;
}
}
#
endif
#
endif
namespace
mozilla
:
:
baseprofiler
{
static
BaseProfilerThreadId
scBaseProfilerMainThreadId
{
}
;
void
profiler_init_main_thread_id
(
)
{
if
(
!
scBaseProfilerMainThreadId
.
IsSpecified
(
)
)
{
scBaseProfilerMainThreadId
=
profiler_current_thread_id
(
)
;
}
}
BaseProfilerThreadId
profiler_main_thread_id
(
)
{
return
scBaseProfilerMainThreadId
;
}
bool
profiler_is_main_thread
(
)
{
return
profiler_current_thread_id
(
)
=
=
scBaseProfilerMainThreadId
;
}
}
