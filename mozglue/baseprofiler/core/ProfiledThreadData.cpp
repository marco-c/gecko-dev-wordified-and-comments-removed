#
include
"
BaseProfiler
.
h
"
#
ifdef
MOZ_BASE_PROFILER
#
include
"
ProfiledThreadData
.
h
"
#
include
"
ProfileBuffer
.
h
"
#
include
"
BaseProfileJSONWriter
.
h
"
#
if
defined
(
GP_OS_darwin
)
#
include
<
pthread
.
h
>
#
endif
namespace
mozilla
{
namespace
baseprofiler
{
ProfiledThreadData
:
:
ProfiledThreadData
(
ThreadInfo
*
aThreadInfo
)
:
mThreadInfo
(
aThreadInfo
)
{
}
ProfiledThreadData
:
:
~
ProfiledThreadData
(
)
{
}
void
ProfiledThreadData
:
:
StreamJSON
(
const
ProfileBuffer
&
aBuffer
SpliceableJSONWriter
&
aWriter
const
std
:
:
string
&
aProcessName
const
TimeStamp
&
aProcessStartTime
double
aSinceTime
)
{
UniqueStacks
uniqueStacks
;
aWriter
.
Start
(
)
;
{
StreamSamplesAndMarkers
(
mThreadInfo
-
>
Name
(
)
mThreadInfo
-
>
ThreadId
(
)
aBuffer
aWriter
aProcessName
aProcessStartTime
mThreadInfo
-
>
RegisterTime
(
)
mUnregisterTime
aSinceTime
uniqueStacks
)
;
aWriter
.
StartObjectProperty
(
"
stackTable
"
)
;
{
{
JSONSchemaWriter
schema
(
aWriter
)
;
schema
.
WriteField
(
"
prefix
"
)
;
schema
.
WriteField
(
"
frame
"
)
;
}
aWriter
.
StartArrayProperty
(
"
data
"
)
;
{
uniqueStacks
.
SpliceStackTableElements
(
aWriter
)
;
}
aWriter
.
EndArray
(
)
;
}
aWriter
.
EndObject
(
)
;
aWriter
.
StartObjectProperty
(
"
frameTable
"
)
;
{
{
JSONSchemaWriter
schema
(
aWriter
)
;
schema
.
WriteField
(
"
location
"
)
;
schema
.
WriteField
(
"
relevantForJS
"
)
;
schema
.
WriteField
(
"
innerWindowID
"
)
;
schema
.
WriteField
(
"
implementation
"
)
;
schema
.
WriteField
(
"
optimizations
"
)
;
schema
.
WriteField
(
"
line
"
)
;
schema
.
WriteField
(
"
column
"
)
;
schema
.
WriteField
(
"
category
"
)
;
schema
.
WriteField
(
"
subcategory
"
)
;
}
aWriter
.
StartArrayProperty
(
"
data
"
)
;
{
uniqueStacks
.
SpliceFrameTableElements
(
aWriter
)
;
}
aWriter
.
EndArray
(
)
;
}
aWriter
.
EndObject
(
)
;
aWriter
.
StartArrayProperty
(
"
stringTable
"
)
;
{
uniqueStacks
.
mUniqueStrings
-
>
SpliceStringTableElements
(
aWriter
)
;
}
aWriter
.
EndArray
(
)
;
}
aWriter
.
End
(
)
;
}
void
StreamSamplesAndMarkers
(
const
char
*
aName
int
aThreadId
const
ProfileBuffer
&
aBuffer
SpliceableJSONWriter
&
aWriter
const
std
:
:
string
&
aProcessName
const
TimeStamp
&
aProcessStartTime
const
TimeStamp
&
aRegisterTime
const
TimeStamp
&
aUnregisterTime
double
aSinceTime
UniqueStacks
&
aUniqueStacks
)
{
aWriter
.
StringProperty
(
"
processType
"
"
(
unknown
)
"
)
;
aWriter
.
StringProperty
(
"
name
"
aName
)
;
if
(
!
aProcessName
.
empty
(
)
)
{
aWriter
.
StringProperty
(
"
processName
"
aProcessName
.
c_str
(
)
)
;
}
aWriter
.
IntProperty
(
"
tid
"
static_cast
<
int64_t
>
(
aThreadId
)
)
;
aWriter
.
IntProperty
(
"
pid
"
static_cast
<
int64_t
>
(
profiler_current_process_id
(
)
)
)
;
if
(
aRegisterTime
)
{
aWriter
.
DoubleProperty
(
"
registerTime
"
(
aRegisterTime
-
aProcessStartTime
)
.
ToMilliseconds
(
)
)
;
}
else
{
aWriter
.
NullProperty
(
"
registerTime
"
)
;
}
if
(
aUnregisterTime
)
{
aWriter
.
DoubleProperty
(
"
unregisterTime
"
(
aUnregisterTime
-
aProcessStartTime
)
.
ToMilliseconds
(
)
)
;
}
else
{
aWriter
.
NullProperty
(
"
unregisterTime
"
)
;
}
aWriter
.
StartObjectProperty
(
"
samples
"
)
;
{
{
JSONSchemaWriter
schema
(
aWriter
)
;
schema
.
WriteField
(
"
stack
"
)
;
schema
.
WriteField
(
"
time
"
)
;
schema
.
WriteField
(
"
responsiveness
"
)
;
}
aWriter
.
StartArrayProperty
(
"
data
"
)
;
{
aBuffer
.
StreamSamplesToJSON
(
aWriter
aThreadId
aSinceTime
aUniqueStacks
)
;
}
aWriter
.
EndArray
(
)
;
}
aWriter
.
EndObject
(
)
;
aWriter
.
StartObjectProperty
(
"
markers
"
)
;
{
{
JSONSchemaWriter
schema
(
aWriter
)
;
schema
.
WriteField
(
"
name
"
)
;
schema
.
WriteField
(
"
time
"
)
;
schema
.
WriteField
(
"
category
"
)
;
schema
.
WriteField
(
"
data
"
)
;
}
aWriter
.
StartArrayProperty
(
"
data
"
)
;
{
aBuffer
.
StreamMarkersToJSON
(
aWriter
aThreadId
aProcessStartTime
aSinceTime
aUniqueStacks
)
;
}
aWriter
.
EndArray
(
)
;
}
aWriter
.
EndObject
(
)
;
}
}
}
#
endif
