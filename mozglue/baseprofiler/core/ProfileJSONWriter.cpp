#
include
"
mozilla
/
BaseProfileJSONWriter
.
h
"
namespace
mozilla
:
:
baseprofiler
{
UniqueJSONStrings
:
:
UniqueJSONStrings
(
)
{
mStringTableWriter
.
StartBareList
(
)
;
}
UniqueJSONStrings
:
:
UniqueJSONStrings
(
const
UniqueJSONStrings
&
aOther
)
{
mStringTableWriter
.
StartBareList
(
)
;
uint32_t
count
=
mStringHashToIndexMap
.
count
(
)
;
if
(
count
!
=
0
)
{
MOZ_RELEASE_ASSERT
(
mStringHashToIndexMap
.
reserve
(
count
)
)
;
for
(
auto
iter
=
aOther
.
mStringHashToIndexMap
.
iter
(
)
;
!
iter
.
done
(
)
;
iter
.
next
(
)
)
{
mStringHashToIndexMap
.
putNewInfallible
(
iter
.
get
(
)
.
key
(
)
iter
.
get
(
)
.
value
(
)
)
;
}
mStringTableWriter
.
CopyAndSplice
(
aOther
.
mStringTableWriter
.
ChunkedWriteFunc
(
)
)
;
}
}
UniqueJSONStrings
:
:
~
UniqueJSONStrings
(
)
=
default
;
void
UniqueJSONStrings
:
:
SpliceStringTableElements
(
SpliceableJSONWriter
&
aWriter
)
{
aWriter
.
TakeAndSplice
(
mStringTableWriter
.
TakeChunkedWriteFunc
(
)
)
;
}
uint32_t
UniqueJSONStrings
:
:
GetOrAddIndex
(
const
Span
<
const
char
>
&
aStr
)
{
uint32_t
count
=
mStringHashToIndexMap
.
count
(
)
;
HashNumber
hash
=
HashString
(
aStr
.
data
(
)
aStr
.
size
(
)
)
;
auto
entry
=
mStringHashToIndexMap
.
lookupForAdd
(
hash
)
;
if
(
entry
)
{
MOZ_ASSERT
(
entry
-
>
value
(
)
<
count
)
;
return
entry
-
>
value
(
)
;
}
MOZ_RELEASE_ASSERT
(
mStringHashToIndexMap
.
add
(
entry
hash
count
)
)
;
mStringTableWriter
.
StringElement
(
aStr
)
;
return
count
;
}
}
