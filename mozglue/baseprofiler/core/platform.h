#
ifndef
TOOLS_PLATFORM_H_
#
define
TOOLS_PLATFORM_H_
#
include
"
PlatformMacros
.
h
"
#
include
"
BaseProfiler
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
Vector
.
h
"
#
include
<
functional
>
#
include
<
stdint
.
h
>
#
include
<
string
>
namespace
mozilla
{
namespace
baseprofiler
{
bool
LogTest
(
int
aLevelToTest
)
;
void
PrintToConsole
(
const
char
*
aFmt
.
.
.
)
MOZ_FORMAT_PRINTF
(
1
2
)
;
}
}
#
define
LOG_TEST
:
:
mozilla
:
:
baseprofiler
:
:
LogTest
(
3
)
#
define
LOG
(
arg
.
.
.
)
\
do
{
\
if
(
LOG_TEST
)
{
\
:
:
mozilla
:
:
baseprofiler
:
:
PrintToConsole
(
\
"
[
I
%
d
/
%
d
]
"
arg
"
\
n
"
\
int
(
:
:
mozilla
:
:
baseprofiler
:
:
profiler_current_process_id
(
)
\
.
ToNumber
(
)
)
\
int
(
:
:
mozilla
:
:
baseprofiler
:
:
profiler_current_thread_id
(
)
\
.
ToNumber
(
)
)
\
#
#
__VA_ARGS__
)
;
\
}
\
}
while
(
0
)
#
define
DEBUG_LOG_TEST
:
:
mozilla
:
:
baseprofiler
:
:
LogTest
(
4
)
#
define
DEBUG_LOG
(
arg
.
.
.
)
\
do
{
\
if
(
DEBUG_LOG_TEST
)
{
\
:
:
mozilla
:
:
baseprofiler
:
:
PrintToConsole
(
\
"
[
D
%
d
/
%
d
]
"
arg
"
\
n
"
\
int
(
:
:
mozilla
:
:
baseprofiler
:
:
profiler_current_process_id
(
)
\
.
ToNumber
(
)
)
\
int
(
:
:
mozilla
:
:
baseprofiler
:
:
profiler_current_thread_id
(
)
\
.
ToNumber
(
)
)
\
#
#
__VA_ARGS__
)
;
\
}
\
}
while
(
0
)
#
define
VERBOSE_LOG_TEST
:
:
mozilla
:
:
baseprofiler
:
:
LogTest
(
5
)
#
define
VERBOSE_LOG
(
arg
.
.
.
)
\
do
{
\
if
(
VERBOSE_LOG_TEST
)
{
\
:
:
mozilla
:
:
baseprofiler
:
:
PrintToConsole
(
\
"
[
V
%
d
/
%
d
]
"
arg
"
\
n
"
\
int
(
:
:
mozilla
:
:
baseprofiler
:
:
profiler_current_process_id
(
)
\
.
ToNumber
(
)
)
\
int
(
:
:
mozilla
:
:
baseprofiler
:
:
profiler_current_thread_id
(
)
\
.
ToNumber
(
)
)
\
#
#
__VA_ARGS__
)
;
\
}
\
}
while
(
0
)
namespace
mozilla
{
class
JSONWriter
;
namespace
baseprofiler
{
extern
mozilla
:
:
Atomic
<
int
mozilla
:
:
MemoryOrdering
:
:
Relaxed
>
gSkipSampling
;
typedef
uint8_t
*
Address
;
class
PlatformData
;
struct
PlatformDataDestructor
{
void
operator
(
)
(
PlatformData
*
)
;
}
;
typedef
UniquePtr
<
PlatformData
PlatformDataDestructor
>
UniquePlatformData
;
UniquePlatformData
AllocPlatformData
(
BaseProfilerThreadId
aThreadId
)
;
uint32_t
ParseFeaturesFromStringArray
(
const
char
*
*
aFeatures
uint32_t
aFeatureCount
bool
aIsStartup
=
false
)
;
void
profiler_get_profile_json_into_lazily_allocated_buffer
(
const
std
:
:
function
<
char
*
(
size_t
)
>
&
aAllocator
double
aSinceTime
bool
aIsShuttingDown
)
;
enum
class
JSInstrumentationFlags
{
StackSampling
=
0x1
Allocations
=
0x2
}
;
void
profiler_received_exit_profile
(
const
std
:
:
string
&
aExitProfile
)
;
Vector
<
std
:
:
string
>
profiler_move_exit_profiles
(
)
;
}
}
#
endif
