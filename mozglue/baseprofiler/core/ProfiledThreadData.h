#
ifndef
ProfiledThreadData_h
#
define
ProfiledThreadData_h
#
include
"
BaseProfilingStack
.
h
"
#
include
"
platform
.
h
"
#
include
"
ProfileBufferEntry
.
h
"
#
include
"
ThreadInfo
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
<
string
>
class
ProfileBuffer
;
class
ProfiledThreadData
final
{
public
:
explicit
ProfiledThreadData
(
ThreadInfo
*
aThreadInfo
)
;
~
ProfiledThreadData
(
)
;
void
NotifyUnregistered
(
uint64_t
aBufferPosition
)
{
mLastSample
=
mozilla
:
:
Nothing
(
)
;
MOZ_ASSERT
(
!
mBufferPositionWhenReceivedJSContext
"
JSContext
should
have
been
cleared
before
the
thread
was
"
"
unregistered
"
)
;
mUnregisterTime
=
mozilla
:
:
TimeStamp
:
:
Now
(
)
;
mBufferPositionWhenUnregistered
=
mozilla
:
:
Some
(
aBufferPosition
)
;
}
mozilla
:
:
Maybe
<
uint64_t
>
BufferPositionWhenUnregistered
(
)
{
return
mBufferPositionWhenUnregistered
;
}
mozilla
:
:
Maybe
<
uint64_t
>
&
LastSample
(
)
{
return
mLastSample
;
}
void
StreamJSON
(
const
ProfileBuffer
&
aBuffer
SpliceableJSONWriter
&
aWriter
const
std
:
:
string
&
aProcessName
const
mozilla
:
:
TimeStamp
&
aProcessStartTime
double
aSinceTime
)
;
const
RefPtr
<
ThreadInfo
>
Info
(
)
const
{
return
mThreadInfo
;
}
void
NotifyReceivedJSContext
(
uint64_t
aCurrentBufferPosition
)
{
mBufferPositionWhenReceivedJSContext
=
mozilla
:
:
Some
(
aCurrentBufferPosition
)
;
}
private
:
const
RefPtr
<
ThreadInfo
>
mThreadInfo
;
mozilla
:
:
Maybe
<
uint64_t
>
mLastSample
;
mozilla
:
:
Maybe
<
uint64_t
>
mBufferPositionWhenReceivedJSContext
;
mozilla
:
:
Maybe
<
uint64_t
>
mBufferPositionWhenUnregistered
;
mozilla
:
:
TimeStamp
mUnregisterTime
;
}
;
void
StreamSamplesAndMarkers
(
const
char
*
aName
int
aThreadId
const
ProfileBuffer
&
aBuffer
SpliceableJSONWriter
&
aWriter
const
std
:
:
string
&
aProcessName
const
mozilla
:
:
TimeStamp
&
aProcessStartTime
const
mozilla
:
:
TimeStamp
&
aRegisterTime
const
mozilla
:
:
TimeStamp
&
aUnregisterTime
double
aSinceTime
UniqueStacks
&
aUniqueStacks
)
;
#
endif
