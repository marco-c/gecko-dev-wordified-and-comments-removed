#
ifndef
__PROFILER_BACKTRACE_H
#
define
__PROFILER_BACKTRACE_H
#
include
"
mozilla
/
ProfileChunkedBuffer
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
<
string
>
namespace
mozilla
{
class
TimeStamp
;
namespace
baseprofiler
{
class
ProfileBuffer
;
class
SpliceableJSONWriter
;
class
ThreadInfo
;
class
UniqueStacks
;
class
ProfilerBacktrace
{
public
:
explicit
ProfilerBacktrace
(
const
char
*
aName
UniquePtr
<
ProfileChunkedBuffer
>
aProfileChunkedBufferStorage
UniquePtr
<
ProfileBuffer
>
aProfileBufferStorageOrNull
=
nullptr
)
;
explicit
ProfilerBacktrace
(
const
char
*
aName
ProfileChunkedBuffer
*
aExternalProfileChunkedBufferOrNull
=
nullptr
ProfileBuffer
*
aExternalProfileBufferOrNull
=
nullptr
)
;
~
ProfilerBacktrace
(
)
;
[
[
nodiscard
]
]
bool
IsEmpty
(
)
const
{
return
!
mProfileChunkedBuffer
|
|
ProfileBufferEntryWriter
:
:
Serializer
<
ProfileChunkedBuffer
>
:
:
Bytes
(
*
mProfileChunkedBuffer
)
<
=
ULEB128Size
(
0u
)
;
}
BaseProfilerThreadId
StreamJSON
(
SpliceableJSONWriter
&
aWriter
const
TimeStamp
&
aProcessStartTime
UniqueStacks
&
aUniqueStacks
)
;
private
:
friend
ProfileBufferEntryWriter
:
:
Serializer
<
ProfilerBacktrace
>
;
friend
ProfileBufferEntryReader
:
:
Deserializer
<
ProfilerBacktrace
>
;
std
:
:
string
mName
;
UniquePtr
<
ProfileChunkedBuffer
>
mOptionalProfileChunkedBufferStorage
;
ProfileChunkedBuffer
*
mProfileChunkedBuffer
;
UniquePtr
<
ProfileBuffer
>
mOptionalProfileBufferStorage
;
ProfileBuffer
*
mProfileBuffer
;
}
;
}
template
<
>
struct
ProfileBufferEntryWriter
:
:
Serializer
<
baseprofiler
:
:
ProfilerBacktrace
>
{
static
Length
Bytes
(
const
baseprofiler
:
:
ProfilerBacktrace
&
aBacktrace
)
{
if
(
!
aBacktrace
.
mProfileChunkedBuffer
)
{
return
ULEB128Size
(
0u
)
;
}
auto
bufferBytes
=
SumBytes
(
*
aBacktrace
.
mProfileChunkedBuffer
)
;
if
(
bufferBytes
<
=
ULEB128Size
(
0u
)
)
{
return
ULEB128Size
(
0u
)
;
}
return
bufferBytes
+
SumBytes
(
aBacktrace
.
mName
)
;
}
static
void
Write
(
ProfileBufferEntryWriter
&
aEW
const
baseprofiler
:
:
ProfilerBacktrace
&
aBacktrace
)
{
if
(
!
aBacktrace
.
mProfileChunkedBuffer
|
|
SumBytes
(
*
aBacktrace
.
mProfileChunkedBuffer
)
<
=
ULEB128Size
(
0u
)
)
{
aEW
.
WriteULEB128
(
0u
)
;
return
;
}
aEW
.
WriteObject
(
*
aBacktrace
.
mProfileChunkedBuffer
)
;
aEW
.
WriteObject
(
aBacktrace
.
mName
)
;
}
}
;
template
<
typename
Destructor
>
struct
ProfileBufferEntryWriter
:
:
Serializer
<
UniquePtr
<
baseprofiler
:
:
ProfilerBacktrace
Destructor
>
>
{
static
Length
Bytes
(
const
UniquePtr
<
baseprofiler
:
:
ProfilerBacktrace
Destructor
>
&
aBacktrace
)
{
if
(
!
aBacktrace
)
{
return
ULEB128Size
(
0u
)
;
}
return
SumBytes
(
*
aBacktrace
)
;
}
static
void
Write
(
ProfileBufferEntryWriter
&
aEW
const
UniquePtr
<
baseprofiler
:
:
ProfilerBacktrace
Destructor
>
&
aBacktrace
)
{
if
(
!
aBacktrace
)
{
aEW
.
WriteULEB128
(
0u
)
;
return
;
}
aEW
.
WriteObject
(
*
aBacktrace
)
;
}
}
;
template
<
typename
Destructor
>
struct
ProfileBufferEntryReader
:
:
Deserializer
<
UniquePtr
<
baseprofiler
:
:
ProfilerBacktrace
Destructor
>
>
{
static
void
ReadInto
(
ProfileBufferEntryReader
&
aER
UniquePtr
<
baseprofiler
:
:
ProfilerBacktrace
Destructor
>
&
aBacktrace
)
{
aBacktrace
=
Read
(
aER
)
;
}
static
UniquePtr
<
baseprofiler
:
:
ProfilerBacktrace
Destructor
>
Read
(
ProfileBufferEntryReader
&
aER
)
;
}
;
}
#
endif
