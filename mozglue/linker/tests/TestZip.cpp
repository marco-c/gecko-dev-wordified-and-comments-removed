#
include
<
cstdio
>
#
include
<
unistd
.
h
>
#
include
"
Zip
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
gtest
/
gtest
.
h
"
Logging
Logging
:
:
Singleton
;
#
define
ZIP_DATA
(
name
file
)
\
__asm__
(
"
.
global
"
#
name
"
\
n
"
\
"
.
data
\
n
"
\
"
.
balign
16
\
n
"
\
#
name
"
:
\
n
"
\
"
.
incbin
\
"
"
SRCDIR
"
/
"
file
"
\
"
\
n
"
\
"
.
L
"
#
name
"
_END
:
\
n
"
\
"
.
size
"
#
name
"
.
L
"
#
name
"
_END
-
"
#
name
\
"
\
n
"
\
"
.
global
"
#
name
"
_SIZE
\
n
"
\
"
.
data
\
n
"
\
"
.
balign
4
\
n
"
\
#
name
"
_SIZE
:
\
n
"
\
"
.
int
.
L
"
#
name
"
_END
-
"
#
name
"
\
n
"
)
;
\
extern
const
unsigned
char
name
[
]
;
\
extern
const
unsigned
int
name
#
#
_SIZE
ZIP_DATA
(
TEST_ZIP
"
test
.
zip
"
)
;
const
char
*
test_entries
[
]
=
{
"
baz
"
"
foo
"
"
bar
"
"
qux
"
}
;
ZIP_DATA
(
NO_CENTRAL_DIR_ZIP
"
no_central_dir
.
zip
"
)
;
const
char
*
no_central_dir_entries
[
]
=
{
"
a
"
"
b
"
"
c
"
"
d
"
}
;
TEST
(
Zip
TestZip
)
{
Zip
:
:
Stream
s
;
RefPtr
<
Zip
>
z
=
Zip
:
:
Create
(
(
void
*
)
TEST_ZIP
TEST_ZIP_SIZE
)
;
for
(
auto
&
entry
:
test_entries
)
{
ASSERT_TRUE
(
z
-
>
GetStream
(
entry
&
s
)
)
<
<
"
Could
not
get
entry
\
"
"
<
<
entry
<
<
"
\
"
"
;
}
}
TEST
(
Zip
NoCentralDir
)
{
Zip
:
:
Stream
s
;
RefPtr
<
Zip
>
z
=
Zip
:
:
Create
(
(
void
*
)
NO_CENTRAL_DIR_ZIP
NO_CENTRAL_DIR_ZIP_SIZE
)
;
for
(
auto
&
entry
:
no_central_dir_entries
)
{
ASSERT_TRUE
(
z
-
>
GetStream
(
entry
&
s
)
)
<
<
"
Could
not
get
entry
\
"
"
<
<
entry
<
<
"
\
"
"
;
}
}
