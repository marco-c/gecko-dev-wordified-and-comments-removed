#
include
"
mozilla
/
Assertions
.
h
"
#
include
<
float
.
h
>
#
include
<
intrin
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
windows
.
h
>
#
include
"
mozilla
/
PlatformConditionVariable
.
h
"
#
include
"
mozilla
/
PlatformMutex
.
h
"
#
include
"
MutexPlatformData_windows
.
h
"
#
if
defined
(
_MSC_VER
)
&
&
!
defined
(
InterlockedExchangeAdd
)
#
define
InterlockedExchangeAdd
(
addend
value
)
\
_InterlockedExchangeAdd
(
(
volatile
long
*
)
(
addend
)
(
long
)
(
value
)
)
#
endif
#
if
defined
(
_MSC_VER
)
&
&
!
defined
(
InterlockedIncrement
)
#
define
InterlockedIncrement
(
addend
)
\
_InterlockedIncrement
(
(
volatile
long
*
)
(
addend
)
)
#
endif
struct
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
PlatformData
{
CONDITION_VARIABLE
cv_
;
}
;
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
ConditionVariableImpl
(
)
{
InitializeConditionVariable
(
&
platformData
(
)
-
>
cv_
)
;
}
void
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
notify_one
(
)
{
WakeConditionVariable
(
&
platformData
(
)
-
>
cv_
)
;
}
void
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
notify_all
(
)
{
WakeAllConditionVariable
(
&
platformData
(
)
-
>
cv_
)
;
}
void
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
wait
(
MutexImpl
&
lock
)
{
CRITICAL_SECTION
*
cs
=
&
lock
.
platformData
(
)
-
>
criticalSection
;
bool
r
=
SleepConditionVariableCS
(
&
platformData
(
)
-
>
cv_
cs
INFINITE
)
;
MOZ_RELEASE_ASSERT
(
r
)
;
}
mozilla
:
:
CVStatus
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
wait_for
(
MutexImpl
&
lock
const
mozilla
:
:
TimeDuration
&
rel_time
)
{
if
(
rel_time
=
=
mozilla
:
:
TimeDuration
:
:
Forever
(
)
)
{
wait
(
lock
)
;
return
CVStatus
:
:
NoTimeout
;
}
CRITICAL_SECTION
*
cs
=
&
lock
.
platformData
(
)
-
>
criticalSection
;
double
msecd
=
rel_time
.
ToMilliseconds
(
)
;
DWORD
msec
;
if
(
msecd
<
0
.
0
)
{
msec
=
0
;
}
else
if
(
msecd
>
UINT32_MAX
)
{
msec
=
INFINITE
;
}
else
{
msec
=
static_cast
<
DWORD
>
(
msecd
)
;
if
(
msec
=
=
0
&
&
!
rel_time
.
IsZero
(
)
)
{
msec
=
1
;
}
}
BOOL
r
=
SleepConditionVariableCS
(
&
platformData
(
)
-
>
cv_
cs
msec
)
;
if
(
r
)
return
CVStatus
:
:
NoTimeout
;
MOZ_RELEASE_ASSERT
(
GetLastError
(
)
=
=
ERROR_TIMEOUT
)
;
return
CVStatus
:
:
Timeout
;
}
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
~
ConditionVariableImpl
(
)
{
}
inline
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
PlatformData
*
mozilla
:
:
detail
:
:
ConditionVariableImpl
:
:
platformData
(
)
{
static_assert
(
sizeof
platformData_
>
=
sizeof
(
PlatformData
)
"
platformData_
is
too
small
"
)
;
return
reinterpret_cast
<
PlatformData
*
>
(
platformData_
)
;
}
