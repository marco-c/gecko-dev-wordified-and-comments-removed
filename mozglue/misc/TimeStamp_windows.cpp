#
include
"
mozilla
/
DynamicallyLinkedFunctionPtr
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
<
intrin
.
h
>
#
include
<
windows
.
h
>
static
double
sTicksPerSecd
;
static
double
sTicksPerMsd
;
static
constexpr
double
kMsPerSecd
=
1000
.
0
;
namespace
mozilla
{
static
inline
ULONGLONG
PerformanceCounter
(
)
{
LARGE_INTEGER
pc
;
MOZ_ALWAYS_TRUE
(
:
:
QueryPerformanceCounter
(
&
pc
)
)
;
return
pc
.
QuadPart
;
}
static
void
InitConstants
(
)
{
LARGE_INTEGER
freq
;
bool
hasQPC
=
:
:
QueryPerformanceFrequency
(
&
freq
)
;
MOZ_RELEASE_ASSERT
(
hasQPC
)
;
sTicksPerSecd
=
double
(
freq
.
QuadPart
)
;
sTicksPerMsd
=
sTicksPerSecd
/
kMsPerSecd
;
}
MFBT_API
double
BaseTimeDurationPlatformUtils
:
:
ToSeconds
(
int64_t
aTicks
)
{
return
double
(
aTicks
)
/
sTicksPerSecd
;
}
MFBT_API
double
BaseTimeDurationPlatformUtils
:
:
ToSecondsSigDigits
(
int64_t
aTicks
)
{
return
ToSeconds
(
aTicks
)
;
}
MFBT_API
int64_t
BaseTimeDurationPlatformUtils
:
:
TicksFromMilliseconds
(
double
aMilliseconds
)
{
double
result
=
sTicksPerMsd
*
aMilliseconds
;
if
(
result
>
=
double
(
INT64_MAX
)
)
{
return
INT64_MAX
;
}
if
(
result
<
=
double
(
INT64_MIN
)
)
{
return
INT64_MIN
;
}
return
(
int64_t
)
result
;
}
static
bool
gInitialized
=
false
;
MFBT_API
void
TimeStamp
:
:
Startup
(
)
{
if
(
gInitialized
)
{
return
;
}
InitConstants
(
)
;
gInitialized
=
true
;
}
MFBT_API
void
TimeStamp
:
:
Shutdown
(
)
{
}
MFBT_API
TimeStamp
TimeStamp
:
:
Now
(
bool
aHighResolution
)
{
MOZ_ASSERT
(
gInitialized
)
;
return
TimeStamp
(
(
TimeStampValue
)
PerformanceCounter
(
)
)
;
}
MFBT_API
uint64_t
TimeStamp
:
:
ComputeProcessUptime
(
)
{
FILETIME
start
foo
bar
baz
;
bool
success
=
GetProcessTimes
(
GetCurrentProcess
(
)
&
start
&
foo
&
bar
&
baz
)
;
if
(
!
success
)
{
return
0
;
}
static
const
StaticDynamicallyLinkedFunctionPtr
<
void
(
WINAPI
*
)
(
LPFILETIME
)
>
pGetSystemTimePreciseAsFileTime
(
L
"
kernel32
.
dll
"
"
GetSystemTimePreciseAsFileTime
"
)
;
FILETIME
now
;
if
(
pGetSystemTimePreciseAsFileTime
)
{
pGetSystemTimePreciseAsFileTime
(
&
now
)
;
}
else
{
GetSystemTimeAsFileTime
(
&
now
)
;
}
ULARGE_INTEGER
startUsec
=
{
{
start
.
dwLowDateTime
start
.
dwHighDateTime
}
}
;
ULARGE_INTEGER
nowUsec
=
{
{
now
.
dwLowDateTime
now
.
dwHighDateTime
}
}
;
return
(
nowUsec
.
QuadPart
-
startUsec
.
QuadPart
)
/
10ULL
;
}
}
