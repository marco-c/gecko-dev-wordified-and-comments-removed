#
include
"
mozilla
/
WindowsDpiInitialization
.
h
"
#
include
"
mozilla
/
DynamicallyLinkedFunctionPtr
.
h
"
#
include
"
mozilla
/
WindowsProcessMitigations
.
h
"
#
include
"
mozilla
/
WindowsVersion
.
h
"
#
include
<
shellscalingapi
.
h
>
#
include
<
windows
.
h
>
namespace
mozilla
{
typedef
HRESULT
(
WINAPI
*
SetProcessDpiAwarenessType
)
(
PROCESS_DPI_AWARENESS
)
;
typedef
BOOL
(
WINAPI
*
SetProcessDpiAwarenessContextType
)
(
DPI_AWARENESS_CONTEXT
)
;
WindowsDpiInitializationResult
WindowsDpiInitialization
(
)
{
if
(
IsWin32kLockedDown
(
)
)
{
return
WindowsDpiInitializationResult
:
:
Success
;
}
if
(
IsWin10AnniversaryUpdateOrLater
(
)
)
{
DynamicallyLinkedFunctionPtr
<
SetProcessDpiAwarenessContextType
>
setProcessDpiAwarenessContext
(
L
"
user32
.
dll
"
"
SetProcessDpiAwarenessContext
"
)
;
if
(
!
setProcessDpiAwarenessContext
)
{
return
WindowsDpiInitializationResult
:
:
FindSetProcessDpiAwarenessContextFailed
;
}
if
(
!
setProcessDpiAwarenessContext
(
DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE_V2
)
&
&
!
setProcessDpiAwarenessContext
(
DPI_AWARENESS_CONTEXT_PER_MONITOR_AWARE
)
)
{
return
WindowsDpiInitializationResult
:
:
SetProcessDpiAwarenessContextFailed
;
}
return
WindowsDpiInitializationResult
:
:
Success
;
}
else
{
DynamicallyLinkedFunctionPtr
<
SetProcessDpiAwarenessType
>
setProcessDpiAwareness
(
L
"
Shcore
.
dll
"
"
SetProcessDpiAwareness
"
)
;
if
(
!
setProcessDpiAwareness
)
{
return
WindowsDpiInitializationResult
:
:
FindSetProcessDpiAwarenessFailed
;
}
if
(
FAILED
(
setProcessDpiAwareness
(
PROCESS_PER_MONITOR_DPI_AWARE
)
)
)
{
return
WindowsDpiInitializationResult
:
:
SetProcessDpiAwarenessFailed
;
}
return
WindowsDpiInitializationResult
:
:
Success
;
}
}
}
