#
include
"
mozilla
/
AutoProfilerLabel
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
PlatformMutex
.
h
"
namespace
mozilla
{
class
MOZ_RAII
AutoProfilerLabelData
{
public
:
AutoProfilerLabelData
(
)
{
sAPLMutex
.
Lock
(
)
;
}
~
AutoProfilerLabelData
(
)
{
sAPLMutex
.
Unlock
(
)
;
}
AutoProfilerLabelData
(
const
AutoProfilerLabelData
&
)
=
delete
;
void
operator
=
(
const
AutoProfilerLabelData
&
)
=
delete
;
const
ProfilerLabelEnter
&
EnterCRef
(
)
const
{
return
sEnter
;
}
ProfilerLabelEnter
&
EnterRef
(
)
{
return
sEnter
;
}
const
ProfilerLabelExit
&
ExitCRef
(
)
const
{
return
sExit
;
}
ProfilerLabelExit
&
ExitRef
(
)
{
return
sExit
;
}
const
uint32_t
&
GenerationCRef
(
)
const
{
return
sGeneration
;
}
uint32_t
&
GenerationRef
(
)
{
return
sGeneration
;
}
static
bool
RacyIsProfilerPresent
(
)
{
return
!
!
sGeneration
;
}
private
:
class
Mutex
:
private
mozilla
:
:
detail
:
:
MutexImpl
{
public
:
Mutex
(
)
=
default
;
void
Lock
(
)
{
mozilla
:
:
detail
:
:
MutexImpl
:
:
lock
(
)
;
}
void
Unlock
(
)
{
mozilla
:
:
detail
:
:
MutexImpl
:
:
unlock
(
)
;
}
}
;
static
Mutex
sAPLMutex
MOZ_UNANNOTATED
;
static
ProfilerLabelEnter
sEnter
;
static
ProfilerLabelExit
sExit
;
static
uint32_t
sGeneration
;
}
;
MOZ_RUNINIT
AutoProfilerLabelData
:
:
Mutex
AutoProfilerLabelData
:
:
sAPLMutex
;
ProfilerLabelEnter
AutoProfilerLabelData
:
:
sEnter
=
nullptr
;
ProfilerLabelExit
AutoProfilerLabelData
:
:
sExit
=
nullptr
;
uint32_t
AutoProfilerLabelData
:
:
sGeneration
=
0
;
void
RegisterProfilerLabelEnterExit
(
ProfilerLabelEnter
aEnter
ProfilerLabelExit
aExit
)
{
MOZ_ASSERT
(
!
aEnter
=
=
!
aExit
"
Must
provide
both
null
or
both
non
-
null
"
)
;
AutoProfilerLabelData
data
;
MOZ_ASSERT
(
!
aEnter
!
=
!
data
.
EnterRef
(
)
"
Must
go
from
null
to
non
-
null
or
from
non
-
null
to
null
"
)
;
data
.
EnterRef
(
)
=
aEnter
;
data
.
ExitRef
(
)
=
aExit
;
+
+
data
.
GenerationRef
(
)
;
}
bool
IsProfilerPresent
(
)
{
return
AutoProfilerLabelData
:
:
RacyIsProfilerPresent
(
)
;
}
ProfilerLabel
ProfilerLabelBegin
(
const
char
*
aLabelName
const
char
*
aDynamicString
void
*
aSp
)
{
const
AutoProfilerLabelData
data
;
void
*
entryContext
=
(
data
.
EnterCRef
(
)
)
?
data
.
EnterCRef
(
)
(
aLabelName
aDynamicString
aSp
)
:
nullptr
;
uint32_t
generation
=
data
.
GenerationCRef
(
)
;
return
std
:
:
make_tuple
(
entryContext
generation
)
;
}
void
ProfilerLabelEnd
(
const
ProfilerLabel
&
aLabel
)
{
if
(
!
IsValidProfilerLabel
(
aLabel
)
)
{
return
;
}
const
AutoProfilerLabelData
data
;
if
(
data
.
ExitCRef
(
)
&
&
(
std
:
:
get
<
1
>
(
aLabel
)
=
=
data
.
GenerationCRef
(
)
)
)
{
data
.
ExitCRef
(
)
(
std
:
:
get
<
0
>
(
aLabel
)
)
;
}
}
AutoProfilerLabel
:
:
AutoProfilerLabel
(
const
char
*
aLabel
const
char
*
aDynamicString
)
{
std
:
:
tie
(
mEntryContext
mGeneration
)
=
ProfilerLabelBegin
(
aLabel
aDynamicString
this
)
;
}
AutoProfilerLabel
:
:
~
AutoProfilerLabel
(
)
{
ProfilerLabelEnd
(
std
:
:
make_tuple
(
mEntryContext
mGeneration
)
)
;
}
}
