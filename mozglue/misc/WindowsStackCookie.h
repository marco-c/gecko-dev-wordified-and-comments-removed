#
ifndef
mozilla_WindowsStackCookie_h
#
define
mozilla_WindowsStackCookie_h
#
if
defined
(
DEBUG
)
&
&
defined
(
_M_X64
)
&
&
!
defined
(
__MINGW64__
)
#
include
<
windows
.
h
>
#
include
<
winnt
.
h
>
#
include
<
cstdint
>
#
include
"
mozilla
/
Types
.
h
"
namespace
mozilla
{
inline
bool
HasStackCookieCheck
(
uintptr_t
aFunctionAddress
)
{
DWORD64
imageBase
{
}
;
auto
entry
=
:
:
RtlLookupFunctionEntry
(
reinterpret_cast
<
DWORD64
>
(
aFunctionAddress
)
&
imageBase
nullptr
)
;
if
(
entry
&
&
entry
-
>
EndAddress
>
entry
-
>
BeginAddress
+
14
)
{
auto
begin
=
reinterpret_cast
<
uint8_t
*
>
(
imageBase
+
entry
-
>
BeginAddress
)
;
auto
end
=
reinterpret_cast
<
uint8_t
*
>
(
imageBase
+
entry
-
>
EndAddress
-
14
)
;
for
(
auto
pc
=
begin
;
pc
!
=
end
;
+
+
pc
)
{
if
(
(
pc
[
0
]
=
=
0x48
&
&
pc
[
1
]
=
=
0x8b
&
&
pc
[
2
]
=
=
0x05
)
&
&
(
pc
[
7
]
=
=
0x48
&
&
pc
[
8
]
=
=
0x31
&
&
pc
[
9
]
=
=
0xe0
)
&
&
(
pc
[
10
]
=
=
0x48
&
&
pc
[
11
]
=
=
0x89
&
&
(
pc
[
12
]
=
=
0x44
|
|
pc
[
12
]
=
=
0x84
)
&
&
pc
[
13
]
=
=
0x24
)
)
{
return
true
;
}
}
}
return
false
;
}
}
#
endif
#
endif
