ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
FileSource
:
"
resource
:
/
/
gre
/
modules
/
L10nRegistry
.
jsm
"
GeckoViewTelemetryController
:
"
resource
:
/
/
gre
/
modules
/
GeckoViewTelemetryController
.
jsm
"
GeckoViewUtils
:
"
resource
:
/
/
gre
/
modules
/
GeckoViewUtils
.
jsm
"
L10nRegistry
:
"
resource
:
/
/
gre
/
modules
/
L10nRegistry
.
jsm
"
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
}
)
;
const
{
debug
warn
}
=
GeckoViewUtils
.
initLogging
(
"
GeckoViewStartup
"
this
)
;
function
GeckoViewStartup
(
)
{
}
GeckoViewStartup
.
prototype
=
{
classID
:
Components
.
ID
(
"
{
8e993c34
-
fdd6
-
432c
-
967e
-
f995d888777f
}
"
)
QueryInterface
:
ChromeUtils
.
generateQI
(
[
Ci
.
nsIObserver
]
)
setResourceSubstitutions
:
function
(
)
{
let
registry
=
Cc
[
"
mozilla
.
org
/
chrome
/
chrome
-
registry
;
1
"
]
.
getService
(
Ci
.
nsIChromeRegistry
)
;
let
url
=
registry
.
convertChromeURL
(
Services
.
io
.
newURI
(
"
chrome
:
/
/
geckoview
/
content
/
geckoview
.
js
"
)
)
.
spec
;
url
=
url
.
substring
(
4
url
.
indexOf
(
"
!
/
"
)
+
2
)
;
let
protocolHandler
=
Services
.
io
.
getProtocolHandler
(
"
resource
"
)
.
QueryInterface
(
Ci
.
nsIResProtocolHandler
)
;
protocolHandler
.
setSubstitution
(
"
android
"
Services
.
io
.
newURI
(
url
)
)
;
}
observe
:
function
(
aSubject
aTopic
aData
)
{
debug
observe
:
{
aTopic
}
;
switch
(
aTopic
)
{
case
"
app
-
startup
"
:
{
GeckoViewUtils
.
addLazyGetter
(
this
"
GeckoViewPermission
"
{
service
:
"
mozilla
.
org
/
content
-
permission
/
prompt
;
1
"
observers
:
[
"
getUserMedia
:
ask
-
device
-
permission
"
"
getUserMedia
:
request
"
"
PeerConnection
:
request
"
]
ppmm
:
[
"
GeckoView
:
AddCameraPermission
"
]
}
)
;
GeckoViewUtils
.
addLazyGetter
(
this
"
GeckoViewConsole
"
{
module
:
"
resource
:
/
/
gre
/
modules
/
GeckoViewConsole
.
jsm
"
}
)
;
GeckoViewUtils
.
addLazyPrefObserver
(
{
name
:
"
geckoview
.
console
.
enabled
"
default
:
false
}
{
handler
:
_
=
>
this
.
GeckoViewConsole
}
)
;
if
(
Services
.
appinfo
.
processType
=
=
Services
.
appinfo
.
PROCESS_TYPE_DEFAULT
)
{
this
.
setResourceSubstitutions
(
)
;
Services
.
mm
.
loadFrameScript
(
"
chrome
:
/
/
geckoview
/
content
/
GeckoViewPromptContent
.
js
"
true
)
;
GeckoViewUtils
.
addLazyGetter
(
this
"
ContentCrashHandler
"
{
module
:
"
resource
:
/
/
gre
/
modules
/
ContentCrashHandler
.
jsm
"
observers
:
[
"
ipc
:
content
-
shutdown
"
]
}
)
;
}
break
;
}
case
"
profile
-
after
-
change
"
:
{
GeckoViewUtils
.
addLazyGetter
(
this
"
ContentPrefServiceParent
"
{
module
:
"
resource
:
/
/
gre
/
modules
/
ContentPrefServiceParent
.
jsm
"
init
:
cpsp
=
>
cpsp
.
alwaysInit
(
)
ppmm
:
[
"
ContentPrefs
:
FunctionCall
"
"
ContentPrefs
:
AddObserverForName
"
"
ContentPrefs
:
RemoveObserverForName
"
]
}
)
;
GeckoViewUtils
.
addLazyGetter
(
this
"
GeckoViewRemoteDebugger
"
{
module
:
"
resource
:
/
/
gre
/
modules
/
GeckoViewRemoteDebugger
.
jsm
"
init
:
gvrd
=
>
gvrd
.
onInit
(
)
}
)
;
GeckoViewUtils
.
addLazyPrefObserver
(
{
name
:
"
devtools
.
debugger
.
remote
-
enabled
"
default
:
false
}
{
handler
:
_
=
>
this
.
GeckoViewRemoteDebugger
}
)
;
GeckoViewTelemetryController
.
setup
(
)
;
let
locales
=
Services
.
locale
.
getPackagedLocales
(
)
;
const
greSource
=
new
FileSource
(
"
toolkit
"
locales
"
resource
:
/
/
gre
/
localization
/
{
locale
}
/
"
)
;
L10nRegistry
.
registerSource
(
greSource
)
;
break
;
}
}
}
}
;
this
.
NSGetFactory
=
XPCOMUtils
.
generateNSGetFactory
(
[
GeckoViewStartup
]
)
;
