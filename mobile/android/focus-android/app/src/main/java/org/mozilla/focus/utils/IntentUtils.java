package
org
.
mozilla
.
focus
.
utils
;
import
android
.
content
.
Context
;
import
android
.
content
.
DialogInterface
;
import
android
.
content
.
Intent
;
import
android
.
content
.
pm
.
PackageManager
;
import
android
.
content
.
pm
.
ResolveInfo
;
import
android
.
net
.
Uri
;
import
android
.
support
.
annotation
.
StringRes
;
import
android
.
support
.
v7
.
app
.
AlertDialog
;
import
org
.
mozilla
.
focus
.
R
;
import
org
.
mozilla
.
focus
.
web
.
IWebView
;
import
java
.
net
.
URISyntaxException
;
import
java
.
util
.
List
;
public
class
IntentUtils
{
private
static
String
MARKET_INTENT_URI_PACKAGE_PREFIX
=
"
market
:
/
/
details
?
id
=
"
;
private
static
String
EXTRA_BROWSER_FALLBACK_URL
=
"
browser_fallback_url
"
;
public
static
boolean
handleExternalUri
(
final
Context
context
final
IWebView
webView
final
String
uri
)
{
final
Intent
intent
;
try
{
intent
=
Intent
.
parseUri
(
uri
0
)
;
}
catch
(
URISyntaxException
e
)
{
return
false
;
}
intent
.
addCategory
(
Intent
.
CATEGORY_BROWSABLE
)
;
final
PackageManager
packageManager
=
context
.
getPackageManager
(
)
;
final
List
<
ResolveInfo
>
matchingActivities
=
packageManager
.
queryIntentActivities
(
intent
0
)
;
if
(
matchingActivities
.
size
(
)
=
=
0
)
{
return
handleUnsupportedLink
(
context
webView
intent
)
;
}
else
if
(
matchingActivities
.
size
(
)
=
=
1
)
{
final
ResolveInfo
info
;
if
(
matchingActivities
.
size
(
)
=
=
1
)
{
info
=
matchingActivities
.
get
(
0
)
;
}
else
{
info
=
packageManager
.
resolveActivity
(
intent
0
)
;
}
final
CharSequence
externalAppTitle
=
info
.
loadLabel
(
packageManager
)
;
showConfirmationDialog
(
context
intent
context
.
getString
(
R
.
string
.
external_app_prompt_title
)
R
.
string
.
external_app_prompt
externalAppTitle
)
;
return
true
;
}
else
{
final
String
chooserTitle
=
context
.
getString
(
R
.
string
.
external_multiple_apps_matched_exit
)
;
final
Intent
chooserIntent
=
Intent
.
createChooser
(
intent
chooserTitle
)
;
context
.
startActivity
(
chooserIntent
)
;
return
true
;
}
}
private
static
boolean
handleUnsupportedLink
(
final
Context
context
final
IWebView
webView
final
Intent
intent
)
{
final
String
fallbackUrl
=
intent
.
getStringExtra
(
EXTRA_BROWSER_FALLBACK_URL
)
;
if
(
fallbackUrl
!
=
null
)
{
webView
.
loadUrl
(
fallbackUrl
)
;
return
true
;
}
if
(
intent
.
getPackage
(
)
!
=
null
)
{
final
String
marketUri
=
MARKET_INTENT_URI_PACKAGE_PREFIX
+
intent
.
getPackage
(
)
;
final
Intent
marketIntent
=
new
Intent
(
Intent
.
ACTION_VIEW
Uri
.
parse
(
marketUri
)
)
;
marketIntent
.
addCategory
(
Intent
.
CATEGORY_BROWSABLE
)
;
final
PackageManager
packageManager
=
context
.
getPackageManager
(
)
;
final
ResolveInfo
info
=
packageManager
.
resolveActivity
(
marketIntent
0
)
;
final
CharSequence
marketTitle
=
info
.
loadLabel
(
packageManager
)
;
showConfirmationDialog
(
context
marketIntent
context
.
getString
(
R
.
string
.
external_app_prompt_no_app_title
)
R
.
string
.
external_app_prompt_no_app
marketTitle
)
;
return
true
;
}
return
false
;
}
private
static
void
showConfirmationDialog
(
final
Context
context
final
Intent
targetIntent
final
String
title
final
StringRes
int
messageResource
final
CharSequence
param
)
{
final
AlertDialog
.
Builder
builder
=
new
AlertDialog
.
Builder
(
context
R
.
style
.
DialogStyle
)
;
final
CharSequence
ourAppName
=
context
.
getString
(
R
.
string
.
app_name
)
;
builder
.
setTitle
(
title
)
;
builder
.
setMessage
(
context
.
getResources
(
)
.
getString
(
messageResource
ourAppName
param
)
)
;
builder
.
setPositiveButton
(
R
.
string
.
action_ok
new
DialogInterface
.
OnClickListener
(
)
{
Override
public
void
onClick
(
final
DialogInterface
dialog
final
int
which
)
{
context
.
startActivity
(
targetIntent
)
;
}
}
)
;
builder
.
setNegativeButton
(
R
.
string
.
action_cancel
new
DialogInterface
.
OnClickListener
(
)
{
Override
public
void
onClick
(
final
DialogInterface
dialog
final
int
which
)
{
dialog
.
dismiss
(
)
;
}
}
)
;
builder
.
show
(
)
;
}
}
