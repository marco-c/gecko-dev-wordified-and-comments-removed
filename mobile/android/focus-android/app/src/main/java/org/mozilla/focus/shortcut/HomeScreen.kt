package
org
.
mozilla
.
focus
.
shortcut
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
graphics
.
Bitmap
;
import
android
.
net
.
Uri
;
import
android
.
os
.
Build
;
import
androidx
.
annotation
.
VisibleForTesting
;
import
androidx
.
core
.
content
.
pm
.
ShortcutInfoCompat
;
import
androidx
.
core
.
content
.
pm
.
ShortcutManagerCompat
;
import
androidx
.
core
.
graphics
.
drawable
.
IconCompat
;
import
android
.
text
.
TextUtils
;
import
org
.
mozilla
.
focus
.
activity
.
MainActivity
;
import
java
.
util
.
UUID
;
import
mozilla
.
components
.
support
.
ktx
.
kotlin
.
StringKt
;
import
mozilla
.
components
.
support
.
ktx
.
util
.
URLStringUtils
;
public
class
HomeScreen
{
public
static
final
String
ADD_TO_HOMESCREEN_TAG
=
"
add_to_homescreen
"
;
public
static
final
String
BLOCKING_ENABLED
=
"
blocking_enabled
"
;
public
static
final
String
REQUEST_DESKTOP
=
"
request_desktop
"
;
public
static
void
installShortCut
(
Context
context
Bitmap
icon
String
url
String
title
boolean
blockingEnabled
boolean
requestDesktop
)
{
if
(
TextUtils
.
isEmpty
(
title
.
trim
(
)
)
)
{
title
=
generateTitleFromUrl
(
url
)
;
}
installShortCutViaManager
(
context
icon
url
title
blockingEnabled
requestDesktop
)
;
if
(
Build
.
VERSION
.
SDK_INT
<
=
Build
.
VERSION_CODES
.
N_MR1
)
{
goToHomeScreen
(
context
)
;
}
}
private
static
void
installShortCutViaManager
(
Context
context
Bitmap
bitmap
String
url
String
title
boolean
blockingEnabled
boolean
requestDesktop
)
{
if
(
ShortcutManagerCompat
.
isRequestPinShortcutSupported
(
context
)
)
{
final
IconCompat
icon
=
(
Build
.
VERSION
.
SDK_INT
>
=
Build
.
VERSION_CODES
.
O
)
?
IconCompat
.
createWithAdaptiveBitmap
(
bitmap
)
:
IconCompat
.
createWithBitmap
(
bitmap
)
;
final
ShortcutInfoCompat
shortcut
=
new
ShortcutInfoCompat
.
Builder
(
context
UUID
.
randomUUID
(
)
.
toString
(
)
)
.
setShortLabel
(
title
)
.
setLongLabel
(
title
)
.
setIcon
(
icon
)
.
setIntent
(
createShortcutIntent
(
context
url
blockingEnabled
requestDesktop
)
)
.
build
(
)
;
ShortcutManagerCompat
.
requestPinShortcut
(
context
shortcut
null
)
;
}
}
private
static
Intent
createShortcutIntent
(
Context
context
String
url
boolean
blockingEnabled
boolean
requestDesktop
)
{
final
Intent
shortcutIntent
=
new
Intent
(
context
MainActivity
.
class
)
;
shortcutIntent
.
setAction
(
Intent
.
ACTION_VIEW
)
;
shortcutIntent
.
setData
(
Uri
.
parse
(
url
)
)
;
shortcutIntent
.
putExtra
(
BLOCKING_ENABLED
blockingEnabled
)
;
shortcutIntent
.
putExtra
(
REQUEST_DESKTOP
requestDesktop
)
;
shortcutIntent
.
putExtra
(
ADD_TO_HOMESCREEN_TAG
ADD_TO_HOMESCREEN_TAG
)
;
return
shortcutIntent
;
}
VisibleForTesting
static
String
generateTitleFromUrl
(
String
url
)
{
return
StringKt
.
stripCommonSubdomains
(
Uri
.
parse
(
url
)
.
getHost
(
)
)
;
}
private
static
void
goToHomeScreen
(
Context
context
)
{
Intent
intent
=
new
Intent
(
Intent
.
ACTION_MAIN
)
;
intent
.
addCategory
(
Intent
.
CATEGORY_HOME
)
;
intent
.
setFlags
(
Intent
.
FLAG_ACTIVITY_NEW_TASK
)
;
context
.
startActivity
(
intent
)
;
}
}
