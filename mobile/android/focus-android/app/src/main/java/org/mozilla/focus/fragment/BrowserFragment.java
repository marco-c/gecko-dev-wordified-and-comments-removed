package
org
.
mozilla
.
focus
.
fragment
;
import
android
.
Manifest
;
import
android
.
app
.
Activity
;
import
android
.
app
.
DownloadManager
;
import
android
.
app
.
PendingIntent
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
content
.
IntentFilter
;
import
android
.
content
.
pm
.
ActivityInfo
;
import
android
.
content
.
pm
.
PackageManager
;
import
android
.
graphics
.
Bitmap
;
import
android
.
graphics
.
Color
;
import
android
.
graphics
.
drawable
.
Drawable
;
import
android
.
graphics
.
drawable
.
TransitionDrawable
;
import
android
.
net
.
Uri
;
import
android
.
os
.
Bundle
;
import
android
.
os
.
Environment
;
import
android
.
support
.
annotation
.
NonNull
;
import
android
.
support
.
annotation
.
Nullable
;
import
android
.
support
.
design
.
widget
.
AppBarLayout
;
import
android
.
support
.
v4
.
app
.
DialogFragment
;
import
android
.
support
.
v4
.
app
.
Fragment
;
import
android
.
support
.
v4
.
app
.
FragmentManager
;
import
android
.
support
.
v4
.
app
.
FragmentTransaction
;
import
android
.
support
.
v4
.
content
.
ContextCompat
;
import
android
.
view
.
LayoutInflater
;
import
android
.
view
.
View
;
import
android
.
view
.
ViewGroup
;
import
android
.
view
.
Window
;
import
android
.
view
.
WindowManager
;
import
android
.
webkit
.
CookieManager
;
import
android
.
webkit
.
URLUtil
;
import
android
.
widget
.
FrameLayout
;
import
android
.
widget
.
ImageButton
;
import
android
.
widget
.
ImageView
;
import
android
.
widget
.
TextView
;
import
android
.
widget
.
Toast
;
import
org
.
mozilla
.
focus
.
R
;
import
org
.
mozilla
.
focus
.
activity
.
InfoActivity
;
import
org
.
mozilla
.
focus
.
activity
.
InstallFirefoxActivity
;
import
org
.
mozilla
.
focus
.
broadcastreceiver
.
DownloadBroadcastReceiver
;
import
org
.
mozilla
.
focus
.
locale
.
LocaleAwareAppCompatActivity
;
import
org
.
mozilla
.
focus
.
menu
.
BrowserMenu
;
import
org
.
mozilla
.
focus
.
menu
.
WebContextMenu
;
import
org
.
mozilla
.
focus
.
notification
.
BrowsingNotificationService
;
import
org
.
mozilla
.
focus
.
open
.
OpenWithFragment
;
import
org
.
mozilla
.
focus
.
shortcut
.
HomeScreen
;
import
org
.
mozilla
.
focus
.
telemetry
.
TelemetryWrapper
;
import
org
.
mozilla
.
focus
.
utils
.
Browsers
;
import
org
.
mozilla
.
focus
.
utils
.
ColorUtils
;
import
org
.
mozilla
.
focus
.
utils
.
DrawableUtils
;
import
org
.
mozilla
.
focus
.
utils
.
IntentUtils
;
import
org
.
mozilla
.
focus
.
utils
.
UrlUtils
;
import
org
.
mozilla
.
focus
.
utils
.
ViewUtils
;
import
org
.
mozilla
.
focus
.
web
.
BrowsingSession
;
import
org
.
mozilla
.
focus
.
web
.
CustomTabConfig
;
import
org
.
mozilla
.
focus
.
web
.
Download
;
import
org
.
mozilla
.
focus
.
web
.
IWebView
;
import
org
.
mozilla
.
focus
.
widget
.
AnimatedProgressBar
;
import
java
.
lang
.
ref
.
WeakReference
;
public
class
BrowserFragment
extends
WebFragment
implements
View
.
OnClickListener
DownloadDialogFragment
.
DownloadDialogListener
{
public
static
final
String
FRAGMENT_TAG
=
"
browser
"
;
private
static
int
REQUEST_CODE_STORAGE_PERMISSION
=
101
;
private
static
final
int
ANIMATION_DURATION
=
300
;
private
static
final
String
ARGUMENT_URL
=
"
url
"
;
private
static
final
String
RESTORE_KEY_DOWNLOAD
=
"
download
"
;
public
static
BrowserFragment
create
(
String
url
)
{
Bundle
arguments
=
new
Bundle
(
)
;
arguments
.
putString
(
ARGUMENT_URL
url
)
;
BrowserFragment
fragment
=
new
BrowserFragment
(
)
;
fragment
.
setArguments
(
arguments
)
;
return
fragment
;
}
private
Download
pendingDownload
;
private
View
backgroundView
;
private
TransitionDrawable
backgroundTransition
;
private
TextView
urlView
;
private
AnimatedProgressBar
progressView
;
private
FrameLayout
blockView
;
private
ImageView
lockView
;
private
ImageButton
menuView
;
private
WeakReference
<
BrowserMenu
>
menuWeakReference
=
new
WeakReference
<
>
(
null
)
;
private
ViewGroup
videoContainer
;
private
View
browserContainer
;
private
View
forwardButton
;
private
View
backButton
;
private
View
refreshButton
;
private
View
stopButton
;
private
IWebView
.
FullscreenCallback
fullscreenCallback
;
private
boolean
isLoading
=
false
;
private
DownloadManager
manager
;
private
DownloadBroadcastReceiver
downloadBroadcastReceiver
;
private
WeakReference
<
LoadStateListener
>
loadStateListenerWeakReference
=
new
WeakReference
<
>
(
null
)
;
Override
public
void
onAttach
(
Context
context
)
{
super
.
onAttach
(
context
)
;
BrowsingNotificationService
.
start
(
context
)
;
}
Override
public
void
onPause
(
)
{
super
.
onPause
(
)
;
getContext
(
)
.
unregisterReceiver
(
downloadBroadcastReceiver
)
;
final
BrowserMenu
menu
=
menuWeakReference
.
get
(
)
;
if
(
menu
!
=
null
)
{
menu
.
dismiss
(
)
;
menuWeakReference
.
clear
(
)
;
}
}
Override
public
String
getInitialUrl
(
)
{
return
getArguments
(
)
.
getString
(
ARGUMENT_URL
)
;
}
private
void
updateURL
(
final
String
url
)
{
urlView
.
setText
(
UrlUtils
.
stripUserInfo
(
url
)
)
;
}
Override
public
View
inflateLayout
(
LayoutInflater
inflater
Nullable
ViewGroup
container
Nullable
Bundle
savedInstanceState
)
{
if
(
savedInstanceState
!
=
null
&
&
savedInstanceState
.
containsKey
(
RESTORE_KEY_DOWNLOAD
)
)
{
pendingDownload
=
savedInstanceState
.
getParcelable
(
RESTORE_KEY_DOWNLOAD
)
;
}
final
View
view
=
inflater
.
inflate
(
R
.
layout
.
fragment_browser
container
false
)
;
videoContainer
=
(
ViewGroup
)
view
.
findViewById
(
R
.
id
.
video_container
)
;
browserContainer
=
view
.
findViewById
(
R
.
id
.
browser_container
)
;
urlView
=
(
TextView
)
view
.
findViewById
(
R
.
id
.
display_url
)
;
updateURL
(
getInitialUrl
(
)
)
;
backgroundView
=
view
.
findViewById
(
R
.
id
.
background
)
;
backgroundTransition
=
(
TransitionDrawable
)
backgroundView
.
getBackground
(
)
;
if
(
(
refreshButton
=
view
.
findViewById
(
R
.
id
.
refresh
)
)
!
=
null
)
{
refreshButton
.
setOnClickListener
(
this
)
;
}
if
(
(
stopButton
=
view
.
findViewById
(
R
.
id
.
stop
)
)
!
=
null
)
{
stopButton
.
setOnClickListener
(
this
)
;
}
if
(
(
forwardButton
=
view
.
findViewById
(
R
.
id
.
forward
)
)
!
=
null
)
{
forwardButton
.
setOnClickListener
(
this
)
;
}
if
(
(
backButton
=
view
.
findViewById
(
R
.
id
.
back
)
)
!
=
null
)
{
backButton
.
setOnClickListener
(
this
)
;
}
blockView
=
(
FrameLayout
)
view
.
findViewById
(
R
.
id
.
block
)
;
lockView
=
(
ImageView
)
view
.
findViewById
(
R
.
id
.
lock
)
;
progressView
=
(
AnimatedProgressBar
)
view
.
findViewById
(
R
.
id
.
progress
)
;
menuView
=
(
ImageButton
)
view
.
findViewById
(
R
.
id
.
menu
)
;
menuView
.
setOnClickListener
(
this
)
;
if
(
BrowsingSession
.
getInstance
(
)
.
isCustomTab
(
)
)
{
initialiseCustomTabUi
(
view
)
;
}
else
{
initialiseNormalBrowserUi
(
view
)
;
}
return
view
;
}
private
void
initialiseNormalBrowserUi
(
final
NonNull
View
view
)
{
final
View
erase
=
view
.
findViewById
(
R
.
id
.
erase
)
;
erase
.
setOnClickListener
(
this
)
;
urlView
.
setOnClickListener
(
this
)
;
}
private
void
initialiseCustomTabUi
(
final
NonNull
View
view
)
{
final
CustomTabConfig
customTabConfig
=
BrowsingSession
.
getInstance
(
)
.
getCustomTabConfig
(
)
;
final
View
erase
=
view
.
findViewById
(
R
.
id
.
erase
)
;
final
ViewGroup
eraseContainer
=
(
ViewGroup
)
erase
.
getParent
(
)
;
eraseContainer
.
removeView
(
erase
)
;
final
int
textColor
;
final
View
toolbar
=
view
.
findViewById
(
R
.
id
.
urlbar
)
;
if
(
customTabConfig
.
toolbarColor
!
=
null
)
{
toolbar
.
setBackgroundColor
(
customTabConfig
.
toolbarColor
)
;
textColor
=
ColorUtils
.
getReadableTextColor
(
customTabConfig
.
toolbarColor
)
;
urlView
.
setTextColor
(
textColor
)
;
}
else
{
textColor
=
Color
.
WHITE
;
}
final
ImageView
closeButton
=
(
ImageView
)
view
.
findViewById
(
R
.
id
.
customtab_close
)
;
closeButton
.
setVisibility
(
View
.
VISIBLE
)
;
closeButton
.
setOnClickListener
(
this
)
;
if
(
customTabConfig
.
closeButtonIcon
!
=
null
)
{
closeButton
.
setImageBitmap
(
customTabConfig
.
closeButtonIcon
)
;
}
else
{
final
Drawable
closeIcon
=
DrawableUtils
.
loadAndTintDrawable
(
getContext
(
)
R
.
drawable
.
ic_close
textColor
)
;
closeButton
.
setImageDrawable
(
closeIcon
)
;
}
if
(
customTabConfig
.
disableUrlbarHiding
)
{
AppBarLayout
.
LayoutParams
params
=
(
AppBarLayout
.
LayoutParams
)
toolbar
.
getLayoutParams
(
)
;
params
.
setScrollFlags
(
0
)
;
}
if
(
customTabConfig
.
actionButtonConfig
!
=
null
)
{
final
ImageButton
actionButton
=
(
ImageButton
)
view
.
findViewById
(
R
.
id
.
customtab_actionbutton
)
;
actionButton
.
setVisibility
(
View
.
VISIBLE
)
;
actionButton
.
setImageBitmap
(
customTabConfig
.
actionButtonConfig
.
icon
)
;
actionButton
.
setContentDescription
(
customTabConfig
.
actionButtonConfig
.
description
)
;
final
PendingIntent
pendingIntent
=
customTabConfig
.
actionButtonConfig
.
pendingIntent
;
actionButton
.
setOnClickListener
(
new
View
.
OnClickListener
(
)
{
Override
public
void
onClick
(
View
v
)
{
try
{
final
Intent
intent
=
new
Intent
(
)
;
intent
.
setData
(
Uri
.
parse
(
getUrl
(
)
)
)
;
pendingIntent
.
send
(
getContext
(
)
0
intent
)
;
}
catch
(
PendingIntent
.
CanceledException
e
)
{
}
TelemetryWrapper
.
customTabActionButtonEvent
(
)
;
}
}
)
;
}
final
Drawable
lockIcon
=
DrawableUtils
.
loadAndTintDrawable
(
getContext
(
)
R
.
drawable
.
ic_lock
textColor
)
;
lockView
.
setImageDrawable
(
lockIcon
)
;
final
Drawable
menuIcon
=
DrawableUtils
.
loadAndTintDrawable
(
getContext
(
)
R
.
drawable
.
ic_menu
textColor
)
;
menuView
.
setImageDrawable
(
menuIcon
)
;
}
Override
public
void
onSaveInstanceState
(
Bundle
outState
)
{
super
.
onSaveInstanceState
(
outState
)
;
if
(
pendingDownload
!
=
null
)
{
outState
.
putParcelable
(
RESTORE_KEY_DOWNLOAD
pendingDownload
)
;
}
}
public
interface
LoadStateListener
{
void
isLoadingChanged
(
boolean
isLoading
)
;
}
public
void
setIsLoadingListener
(
final
LoadStateListener
listener
)
{
loadStateListenerWeakReference
=
new
WeakReference
<
>
(
listener
)
;
}
private
void
updateIsLoading
(
final
boolean
isLoading
)
{
this
.
isLoading
=
isLoading
;
final
LoadStateListener
currentListener
=
loadStateListenerWeakReference
.
get
(
)
;
if
(
currentListener
!
=
null
)
{
currentListener
.
isLoadingChanged
(
isLoading
)
;
}
}
Override
public
IWebView
.
Callback
createCallback
(
)
{
return
new
IWebView
.
Callback
(
)
{
Override
public
void
onPageStarted
(
final
String
url
)
{
updateIsLoading
(
true
)
;
lockView
.
setVisibility
(
View
.
GONE
)
;
updateBlockingBadging
(
true
)
;
progressView
.
announceForAccessibility
(
getString
(
R
.
string
.
accessibility_announcement_loading
)
)
;
backgroundTransition
.
resetTransition
(
)
;
progressView
.
setProgress
(
5
)
;
progressView
.
setVisibility
(
View
.
VISIBLE
)
;
updateToolbarButtonStates
(
)
;
}
Override
public
void
onPageFinished
(
boolean
isSecure
)
{
updateIsLoading
(
false
)
;
backgroundTransition
.
startTransition
(
ANIMATION_DURATION
)
;
progressView
.
announceForAccessibility
(
getString
(
R
.
string
.
accessibility_announcement_loading_finished
)
)
;
progressView
.
setVisibility
(
View
.
GONE
)
;
if
(
isSecure
)
{
lockView
.
setVisibility
(
View
.
VISIBLE
)
;
}
updateBlockingBadging
(
isBlockingEnabled
(
)
)
;
updateToolbarButtonStates
(
)
;
}
Override
public
void
onURLChanged
(
final
String
url
)
{
updateURL
(
url
)
;
}
Override
public
void
onProgress
(
int
progress
)
{
progressView
.
setProgress
(
progress
)
;
}
Override
public
boolean
handleExternalUrl
(
final
String
url
)
{
final
IWebView
webView
=
getWebView
(
)
;
return
webView
!
=
null
&
&
IntentUtils
.
handleExternalUri
(
getContext
(
)
webView
url
)
;
}
Override
public
void
onLongPress
(
final
IWebView
.
HitTarget
hitTarget
)
{
WebContextMenu
.
show
(
getActivity
(
)
this
hitTarget
)
;
}
Override
public
void
onEnterFullScreen
(
NonNull
final
IWebView
.
FullscreenCallback
callback
Nullable
View
view
)
{
fullscreenCallback
=
callback
;
if
(
view
!
=
null
)
{
browserContainer
.
setVisibility
(
View
.
INVISIBLE
)
;
final
FrameLayout
.
LayoutParams
params
=
new
FrameLayout
.
LayoutParams
(
ViewGroup
.
LayoutParams
.
MATCH_PARENT
ViewGroup
.
LayoutParams
.
MATCH_PARENT
)
;
videoContainer
.
addView
(
view
params
)
;
videoContainer
.
setVisibility
(
View
.
VISIBLE
)
;
switchToImmersiveMode
(
)
;
}
}
Override
public
void
onExitFullScreen
(
)
{
videoContainer
.
removeAllViews
(
)
;
videoContainer
.
setVisibility
(
View
.
GONE
)
;
browserContainer
.
setVisibility
(
View
.
VISIBLE
)
;
exitImmersiveMode
(
)
;
if
(
fullscreenCallback
!
=
null
)
{
fullscreenCallback
.
fullScreenExited
(
)
;
fullscreenCallback
=
null
;
}
}
Override
public
void
onDownloadStart
(
Download
download
)
{
if
(
PackageManager
.
PERMISSION_GRANTED
=
=
ContextCompat
.
checkSelfPermission
(
getContext
(
)
Manifest
.
permission
.
WRITE_EXTERNAL_STORAGE
)
)
{
if
(
!
isDownloadFromLongPressImage
(
download
)
)
{
showDownloadPromptDialog
(
download
)
;
}
else
{
queueDownload
(
download
)
;
}
}
else
{
final
Activity
activity
=
getActivity
(
)
;
if
(
activity
=
=
null
)
{
return
;
}
pendingDownload
=
download
;
requestPermissions
(
new
String
[
]
{
Manifest
.
permission
.
WRITE_EXTERNAL_STORAGE
}
REQUEST_CODE_STORAGE_PERMISSION
)
;
}
}
}
;
}
private
boolean
isDownloadFromLongPressImage
(
Download
download
)
{
return
download
.
getDestinationDirectory
(
)
.
equals
(
Environment
.
DIRECTORY_PICTURES
)
;
}
private
void
switchToImmersiveMode
(
)
{
final
Activity
activity
=
getActivity
(
)
;
if
(
activity
=
=
null
)
{
return
;
}
final
Window
window
=
activity
.
getWindow
(
)
;
window
.
addFlags
(
WindowManager
.
LayoutParams
.
FLAG_KEEP_SCREEN_ON
)
;
window
.
getDecorView
(
)
.
setSystemUiVisibility
(
View
.
SYSTEM_UI_FLAG_LAYOUT_STABLE
|
View
.
SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
|
View
.
SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
|
View
.
SYSTEM_UI_FLAG_HIDE_NAVIGATION
|
View
.
SYSTEM_UI_FLAG_FULLSCREEN
|
View
.
SYSTEM_UI_FLAG_IMMERSIVE_STICKY
)
;
}
private
void
exitImmersiveMode
(
)
{
final
Activity
activity
=
getActivity
(
)
;
if
(
activity
=
=
null
)
{
return
;
}
final
Window
window
=
activity
.
getWindow
(
)
;
window
.
clearFlags
(
WindowManager
.
LayoutParams
.
FLAG_KEEP_SCREEN_ON
)
;
window
.
getDecorView
(
)
.
setSystemUiVisibility
(
View
.
SYSTEM_UI_FLAG_LAYOUT_STABLE
|
View
.
SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
)
;
}
Override
public
void
onRequestPermissionsResult
(
int
requestCode
NonNull
String
[
]
permissions
NonNull
int
[
]
grantResults
)
{
if
(
requestCode
!
=
REQUEST_CODE_STORAGE_PERMISSION
)
{
return
;
}
if
(
grantResults
.
length
<
=
0
|
|
grantResults
[
0
]
!
=
PackageManager
.
PERMISSION_GRANTED
)
{
pendingDownload
=
null
;
}
}
void
showDownloadPromptDialog
(
Download
download
)
{
final
FragmentManager
fragmentManager
=
getFragmentManager
(
)
;
if
(
fragmentManager
.
findFragmentByTag
(
DownloadDialogFragment
.
FRAGMENT_TAG
)
!
=
null
)
{
return
;
}
final
DialogFragment
downloadDialogFragment
=
DownloadDialogFragment
.
newInstance
(
download
)
;
downloadDialogFragment
.
setTargetFragment
(
BrowserFragment
.
this
300
)
;
try
{
downloadDialogFragment
.
show
(
fragmentManager
DownloadDialogFragment
.
FRAGMENT_TAG
)
;
}
catch
(
IllegalStateException
e
)
{
}
}
Override
public
void
onFinishDownloadDialog
(
Download
download
boolean
shouldDownload
)
{
if
(
shouldDownload
)
{
queueDownload
(
download
)
;
}
}
Override
public
void
onCreateViewCalled
(
)
{
manager
=
(
DownloadManager
)
getContext
(
)
.
getSystemService
(
Context
.
DOWNLOAD_SERVICE
)
;
downloadBroadcastReceiver
=
new
DownloadBroadcastReceiver
(
browserContainer
manager
)
;
}
Override
public
void
onResume
(
)
{
super
.
onResume
(
)
;
final
IntentFilter
filter
=
new
IntentFilter
(
DownloadManager
.
ACTION_DOWNLOAD_COMPLETE
)
;
getContext
(
)
.
registerReceiver
(
downloadBroadcastReceiver
filter
)
;
if
(
pendingDownload
!
=
null
&
&
PackageManager
.
PERMISSION_GRANTED
=
=
ContextCompat
.
checkSelfPermission
(
getContext
(
)
Manifest
.
permission
.
WRITE_EXTERNAL_STORAGE
)
)
{
showDownloadPromptDialog
(
pendingDownload
)
;
pendingDownload
=
null
;
}
}
private
void
queueDownload
(
Download
download
)
{
if
(
download
=
=
null
)
{
return
;
}
final
Context
context
=
getContext
(
)
;
if
(
context
=
=
null
)
{
return
;
}
final
String
cookie
=
CookieManager
.
getInstance
(
)
.
getCookie
(
download
.
getUrl
(
)
)
;
final
String
fileName
=
URLUtil
.
guessFileName
(
download
.
getUrl
(
)
download
.
getContentDisposition
(
)
download
.
getMimeType
(
)
)
;
final
DownloadManager
.
Request
request
=
new
DownloadManager
.
Request
(
Uri
.
parse
(
download
.
getUrl
(
)
)
)
.
addRequestHeader
(
"
User
-
Agent
"
download
.
getUserAgent
(
)
)
.
addRequestHeader
(
"
Cookie
"
cookie
)
.
addRequestHeader
(
"
Referer
"
getUrl
(
)
)
.
setDestinationInExternalPublicDir
(
download
.
getDestinationDirectory
(
)
fileName
)
.
setNotificationVisibility
(
DownloadManager
.
Request
.
VISIBILITY_VISIBLE_NOTIFY_COMPLETED
)
.
setMimeType
(
download
.
getMimeType
(
)
)
;
request
.
allowScanningByMediaScanner
(
)
;
long
downloadReference
=
manager
.
enqueue
(
request
)
;
downloadBroadcastReceiver
.
addQueuedDownload
(
downloadReference
)
;
}
private
boolean
isStartedFromExternalApp
(
)
{
final
Activity
activity
=
getActivity
(
)
;
if
(
activity
=
=
null
)
{
return
false
;
}
final
Intent
intent
=
activity
.
getIntent
(
)
;
return
intent
!
=
null
&
&
Intent
.
ACTION_VIEW
.
equals
(
intent
.
getAction
(
)
)
;
}
public
boolean
onBackPressed
(
)
{
if
(
canGoBack
(
)
)
{
goBack
(
)
;
}
else
{
if
(
isStartedFromExternalApp
(
)
)
{
erase
(
)
;
getActivity
(
)
.
finishAndRemoveTask
(
)
;
Toast
.
makeText
(
getContext
(
)
R
.
string
.
feedback_erase
Toast
.
LENGTH_SHORT
)
.
show
(
)
;
TelemetryWrapper
.
eraseBackToAppEvent
(
)
;
}
else
{
eraseAndShowHomeScreen
(
true
)
;
TelemetryWrapper
.
eraseBackToHomeEvent
(
)
;
}
}
return
true
;
}
public
void
erase
(
)
{
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
!
=
null
)
{
webView
.
cleanup
(
)
;
}
BrowsingNotificationService
.
stop
(
getContext
(
)
)
;
}
public
void
eraseAndShowHomeScreen
(
final
boolean
animateErase
)
{
erase
(
)
;
final
FragmentTransaction
transaction
=
getActivity
(
)
.
getSupportFragmentManager
(
)
.
beginTransaction
(
)
;
if
(
animateErase
)
{
transaction
.
setCustomAnimations
(
0
R
.
anim
.
erase_animation
)
;
}
transaction
.
replace
(
R
.
id
.
container
UrlInputFragment
.
createWithBackground
(
)
UrlInputFragment
.
FRAGMENT_TAG
)
.
commit
(
)
;
ViewUtils
.
showBrandedSnackbar
(
getActivity
(
)
.
findViewById
(
android
.
R
.
id
.
content
)
R
.
string
.
feedback_erase
getResources
(
)
.
getInteger
(
R
.
integer
.
erase_snackbar_delay
)
)
;
}
Override
public
void
onClick
(
View
view
)
{
switch
(
view
.
getId
(
)
)
{
case
R
.
id
.
menu
:
final
CustomTabConfig
customTabConfig
;
if
(
BrowsingSession
.
getInstance
(
)
.
isCustomTab
(
)
)
{
customTabConfig
=
BrowsingSession
.
getInstance
(
)
.
getCustomTabConfig
(
)
;
}
else
{
customTabConfig
=
null
;
}
BrowserMenu
menu
=
new
BrowserMenu
(
getActivity
(
)
this
customTabConfig
)
;
menu
.
show
(
menuView
)
;
menuWeakReference
=
new
WeakReference
<
>
(
menu
)
;
break
;
case
R
.
id
.
display_url
:
final
Fragment
urlFragment
=
UrlInputFragment
.
createAsOverlay
(
UrlUtils
.
getSearchTermsOrUrl
(
getContext
(
)
getUrl
(
)
)
urlView
)
;
getActivity
(
)
.
getSupportFragmentManager
(
)
.
beginTransaction
(
)
.
add
(
R
.
id
.
container
urlFragment
UrlInputFragment
.
FRAGMENT_TAG
)
.
commit
(
)
;
break
;
case
R
.
id
.
erase
:
{
eraseAndShowHomeScreen
(
true
)
;
TelemetryWrapper
.
eraseEvent
(
)
;
break
;
}
case
R
.
id
.
back
:
{
goBack
(
)
;
break
;
}
case
R
.
id
.
forward
:
{
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
!
=
null
)
{
webView
.
goForward
(
)
;
}
break
;
}
case
R
.
id
.
refresh
:
{
reload
(
)
;
break
;
}
case
R
.
id
.
stop
:
{
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
!
=
null
)
{
webView
.
stopLoading
(
)
;
}
break
;
}
case
R
.
id
.
share
:
{
final
Intent
shareIntent
=
new
Intent
(
Intent
.
ACTION_SEND
)
;
shareIntent
.
setType
(
"
text
/
plain
"
)
;
shareIntent
.
putExtra
(
Intent
.
EXTRA_TEXT
getUrl
(
)
)
;
startActivity
(
Intent
.
createChooser
(
shareIntent
getString
(
R
.
string
.
share_dialog_title
)
)
)
;
TelemetryWrapper
.
shareEvent
(
)
;
break
;
}
case
R
.
id
.
settings
:
(
(
LocaleAwareAppCompatActivity
)
getActivity
(
)
)
.
openPreferences
(
)
;
break
;
case
R
.
id
.
open_default
:
{
final
Browsers
browsers
=
new
Browsers
(
getContext
(
)
getUrl
(
)
)
;
final
ActivityInfo
defaultBrowser
=
browsers
.
getDefaultBrowser
(
)
;
if
(
defaultBrowser
=
=
null
)
{
throw
new
IllegalStateException
(
"
<
Open
with
Default
>
was
shown
when
no
default
browser
is
set
"
)
;
}
final
Intent
intent
=
new
Intent
(
Intent
.
ACTION_VIEW
Uri
.
parse
(
getUrl
(
)
)
)
;
intent
.
setPackage
(
defaultBrowser
.
packageName
)
;
startActivity
(
intent
)
;
TelemetryWrapper
.
openDefaultAppEvent
(
)
;
break
;
}
case
R
.
id
.
open_firefox
:
{
final
Browsers
browsers
=
new
Browsers
(
getContext
(
)
getUrl
(
)
)
;
if
(
browsers
.
hasFirefoxBrandedBrowserInstalled
(
)
)
{
final
Intent
intent
=
new
Intent
(
Intent
.
ACTION_VIEW
Uri
.
parse
(
getUrl
(
)
)
)
;
intent
.
setPackage
(
browsers
.
getFirefoxBrandedBrowser
(
)
.
packageName
)
;
startActivity
(
intent
)
;
}
else
{
InstallFirefoxActivity
.
open
(
getContext
(
)
)
;
}
TelemetryWrapper
.
openFirefoxEvent
(
)
;
break
;
}
case
R
.
id
.
open_select_browser
:
{
final
Browsers
browsers
=
new
Browsers
(
getContext
(
)
getUrl
(
)
)
;
final
OpenWithFragment
fragment
=
OpenWithFragment
.
newInstance
(
browsers
.
getInstalledBrowsers
(
)
getUrl
(
)
)
;
fragment
.
show
(
getFragmentManager
(
)
OpenWithFragment
.
FRAGMENT_TAG
)
;
TelemetryWrapper
.
openSelectionEvent
(
)
;
break
;
}
case
R
.
id
.
customtab_close
:
{
erase
(
)
;
getActivity
(
)
.
finish
(
)
;
TelemetryWrapper
.
closeCustomTabEvent
(
)
;
break
;
}
case
R
.
id
.
help
:
Intent
helpIntent
=
InfoActivity
.
getHelpIntent
(
getActivity
(
)
)
;
startActivity
(
helpIntent
)
;
break
;
case
R
.
id
.
help_trackers
:
Intent
trackerHelpIntent
=
InfoActivity
.
getTrackerHelpIntent
(
getActivity
(
)
)
;
startActivity
(
trackerHelpIntent
)
;
break
;
case
R
.
id
.
add_to_homescreen
:
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
=
=
null
)
{
return
;
}
final
Bitmap
icon
=
webView
.
getIcon
(
)
;
final
String
url
=
webView
.
getUrl
(
)
;
final
String
title
=
webView
.
getTitle
(
)
;
HomeScreen
.
installShortCut
(
getContext
(
)
icon
url
title
)
;
break
;
default
:
throw
new
IllegalArgumentException
(
"
Unhandled
menu
item
in
BrowserFragment
"
)
;
}
}
private
void
updateToolbarButtonStates
(
)
{
if
(
forwardButton
=
=
null
|
|
backButton
=
=
null
|
|
refreshButton
=
=
null
|
|
stopButton
=
=
null
)
{
return
;
}
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
=
=
null
)
{
return
;
}
final
boolean
canGoForward
=
webView
.
canGoForward
(
)
;
final
boolean
canGoBack
=
webView
.
canGoBack
(
)
;
forwardButton
.
setEnabled
(
canGoForward
)
;
forwardButton
.
setAlpha
(
canGoForward
?
1
.
0f
:
0
.
5f
)
;
backButton
.
setEnabled
(
canGoBack
)
;
backButton
.
setAlpha
(
canGoBack
?
1
.
0f
:
0
.
5f
)
;
refreshButton
.
setVisibility
(
isLoading
?
View
.
GONE
:
View
.
VISIBLE
)
;
stopButton
.
setVisibility
(
isLoading
?
View
.
VISIBLE
:
View
.
GONE
)
;
}
NonNull
public
String
getUrl
(
)
{
return
urlView
.
getText
(
)
.
toString
(
)
;
}
public
boolean
canGoForward
(
)
{
final
IWebView
webView
=
getWebView
(
)
;
return
webView
!
=
null
&
&
webView
.
canGoForward
(
)
;
}
public
boolean
isLoading
(
)
{
return
isLoading
;
}
public
boolean
canGoBack
(
)
{
final
IWebView
webView
=
getWebView
(
)
;
return
webView
!
=
null
&
&
webView
.
canGoBack
(
)
;
}
public
void
goBack
(
)
{
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
!
=
null
)
{
webView
.
goBack
(
)
;
}
}
public
void
loadUrl
(
final
String
url
)
{
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
!
=
null
)
{
webView
.
loadUrl
(
url
)
;
}
}
public
void
reload
(
)
{
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
!
=
null
)
{
webView
.
reload
(
)
;
}
}
public
void
setBlockingEnabled
(
boolean
enabled
)
{
final
IWebView
webView
=
getWebView
(
)
;
if
(
webView
!
=
null
)
{
webView
.
setBlockingEnabled
(
enabled
)
;
}
backgroundView
.
setBackgroundResource
(
enabled
?
R
.
drawable
.
animated_background
:
R
.
drawable
.
animated_background_disabled
)
;
backgroundTransition
=
(
TransitionDrawable
)
backgroundView
.
getBackground
(
)
;
}
public
boolean
isBlockingEnabled
(
)
{
final
IWebView
webView
=
getWebView
(
)
;
return
webView
=
=
null
|
|
webView
.
isBlockingEnabled
(
)
;
}
public
void
updateBlockingBadging
(
boolean
enabled
)
{
blockView
.
setVisibility
(
enabled
?
View
.
GONE
:
View
.
VISIBLE
)
;
}
}
