package
org
.
mozilla
.
focus
.
web
;
import
android
.
app
.
PendingIntent
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
graphics
.
Bitmap
;
import
android
.
os
.
Bundle
;
import
android
.
os
.
Parcelable
;
import
android
.
support
.
annotation
.
ColorInt
;
import
android
.
support
.
annotation
.
NonNull
;
import
android
.
support
.
annotation
.
Nullable
;
import
android
.
support
.
customtabs
.
CustomTabsIntent
;
import
android
.
util
.
Log
;
import
org
.
mozilla
.
focus
.
R
;
import
org
.
mozilla
.
focus
.
utils
.
SafeBundle
;
import
org
.
mozilla
.
focus
.
utils
.
SafeIntent
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
LinkedList
;
import
java
.
util
.
List
;
public
class
CustomTabConfig
{
private
static
final
String
LOGTAG
=
"
CustomTabConfig
"
;
public
static
final
class
ActionButtonConfig
{
public
final
NonNull
String
description
;
public
final
NonNull
Bitmap
icon
;
public
final
NonNull
PendingIntent
pendingIntent
;
public
ActionButtonConfig
(
final
NonNull
String
description
final
NonNull
Bitmap
icon
final
NonNull
PendingIntent
pendingIntent
)
{
this
.
description
=
description
;
this
.
icon
=
icon
;
this
.
pendingIntent
=
pendingIntent
;
}
}
public
static
final
class
CustomTabMenuItem
{
public
final
String
name
;
public
final
PendingIntent
pendingIntent
;
public
CustomTabMenuItem
(
final
NonNull
String
name
final
NonNull
PendingIntent
pendingIntent
)
{
this
.
name
=
name
;
this
.
pendingIntent
=
pendingIntent
;
}
}
public
final
Nullable
ColorInt
Integer
toolbarColor
;
public
final
Nullable
Bitmap
closeButtonIcon
;
public
final
boolean
disableUrlbarHiding
;
public
final
Nullable
ActionButtonConfig
actionButtonConfig
;
public
final
boolean
showShareMenuItem
;
public
final
NonNull
List
<
CustomTabMenuItem
>
menuItems
;
CustomTabConfig
(
final
Nullable
ColorInt
Integer
toolbarColor
final
Nullable
Bitmap
closeButtonIcon
final
boolean
disableUrlbarHiding
final
Nullable
ActionButtonConfig
actionButtonConfig
final
boolean
showShareMenuItem
final
NonNull
List
<
CustomTabMenuItem
>
menuItems
)
{
this
.
toolbarColor
=
toolbarColor
;
this
.
closeButtonIcon
=
closeButtonIcon
;
this
.
disableUrlbarHiding
=
disableUrlbarHiding
;
this
.
actionButtonConfig
=
actionButtonConfig
;
this
.
showShareMenuItem
=
showShareMenuItem
;
this
.
menuItems
=
menuItems
;
}
static
boolean
isCustomTabIntent
(
final
NonNull
SafeIntent
intent
)
{
return
intent
.
hasExtra
(
CustomTabsIntent
.
EXTRA_SESSION
)
;
}
private
static
Nullable
Bitmap
getCloseButtonIcon
(
final
Context
context
final
NonNull
SafeIntent
intent
)
{
if
(
!
intent
.
hasExtra
(
CustomTabsIntent
.
EXTRA_CLOSE_BUTTON_ICON
)
)
{
return
null
;
}
final
Parcelable
closeButtonParcelable
=
intent
.
getParcelableExtra
(
CustomTabsIntent
.
EXTRA_CLOSE_BUTTON_ICON
)
;
if
(
!
(
closeButtonParcelable
instanceof
Bitmap
)
)
{
return
null
;
}
final
Bitmap
candidateIcon
=
(
Bitmap
)
closeButtonParcelable
;
final
int
maxSize
=
context
.
getResources
(
)
.
getDimensionPixelSize
(
R
.
dimen
.
customtabs_close_button_max_size
)
;
if
(
candidateIcon
.
getWidth
(
)
<
=
maxSize
&
&
candidateIcon
.
getHeight
(
)
<
=
maxSize
)
{
return
candidateIcon
;
}
else
{
candidateIcon
.
recycle
(
)
;
return
null
;
}
}
static
CustomTabConfig
parseCustomTabIntent
(
final
NonNull
Context
context
final
NonNull
SafeIntent
intent
)
{
ColorInt
Integer
toolbarColor
=
null
;
if
(
intent
.
hasExtra
(
CustomTabsIntent
.
EXTRA_TOOLBAR_COLOR
)
)
{
toolbarColor
=
intent
.
getIntExtra
(
CustomTabsIntent
.
EXTRA_TOOLBAR_COLOR
-
1
)
;
}
final
Bitmap
closeButtonIcon
=
getCloseButtonIcon
(
context
intent
)
;
boolean
disableUrlbarHiding
=
!
intent
.
getBooleanExtra
(
CustomTabsIntent
.
EXTRA_ENABLE_URLBAR_HIDING
true
)
;
ActionButtonConfig
actionButtonConfig
=
null
;
if
(
intent
.
hasExtra
(
CustomTabsIntent
.
EXTRA_ACTION_BUTTON_BUNDLE
)
)
{
final
SafeBundle
actionButtonBundle
=
intent
.
getBundleExtra
(
CustomTabsIntent
.
EXTRA_ACTION_BUTTON_BUNDLE
)
;
final
String
description
=
actionButtonBundle
.
getString
(
CustomTabsIntent
.
KEY_DESCRIPTION
)
;
final
Bitmap
icon
=
actionButtonBundle
.
getParcelable
(
CustomTabsIntent
.
KEY_ICON
)
;
final
PendingIntent
pendingIntent
=
actionButtonBundle
.
getParcelable
(
CustomTabsIntent
.
KEY_PENDING_INTENT
)
;
if
(
description
!
=
null
&
&
icon
!
=
null
&
&
pendingIntent
!
=
null
)
{
actionButtonConfig
=
new
ActionButtonConfig
(
description
icon
pendingIntent
)
;
}
else
{
Log
.
w
(
LOGTAG
"
Ignoring
EXTRA_ACTION_BUTTON_BUNDLE
due
to
missing
keys
"
)
;
}
}
final
boolean
showShareMenuItem
=
intent
.
getBooleanExtra
(
CustomTabsIntent
.
EXTRA_DEFAULT_SHARE_MENU_ITEM
false
)
;
final
List
<
CustomTabMenuItem
>
menuItems
=
new
LinkedList
<
>
(
)
;
if
(
intent
.
hasExtra
(
CustomTabsIntent
.
EXTRA_MENU_ITEMS
)
)
{
final
ArrayList
<
?
>
menuItemBundles
=
intent
.
getParcelableArrayListExtra
(
CustomTabsIntent
.
EXTRA_MENU_ITEMS
)
;
for
(
final
Object
bundleObject
:
menuItemBundles
)
{
if
(
!
(
bundleObject
instanceof
Bundle
)
)
{
continue
;
}
final
SafeBundle
bundle
=
new
SafeBundle
(
(
Bundle
)
bundleObject
)
;
final
String
name
=
bundle
.
getString
(
CustomTabsIntent
.
KEY_MENU_ITEM_TITLE
)
;
final
Parcelable
parcelableIntent
=
bundle
.
getParcelable
(
CustomTabsIntent
.
KEY_PENDING_INTENT
)
;
if
(
!
(
parcelableIntent
instanceof
PendingIntent
)
)
{
continue
;
}
final
PendingIntent
pendingIntent
=
(
PendingIntent
)
parcelableIntent
;
menuItems
.
add
(
new
CustomTabMenuItem
(
name
pendingIntent
)
)
;
}
}
return
new
CustomTabConfig
(
toolbarColor
closeButtonIcon
disableUrlbarHiding
actionButtonConfig
showShareMenuItem
menuItems
)
;
}
}
