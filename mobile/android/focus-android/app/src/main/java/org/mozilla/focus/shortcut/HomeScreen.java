package
org
.
mozilla
.
focus
.
shortcut
;
import
android
.
annotation
.
TargetApi
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
content
.
pm
.
ShortcutInfo
;
import
android
.
content
.
pm
.
ShortcutManager
;
import
android
.
graphics
.
Bitmap
;
import
android
.
graphics
.
drawable
.
Icon
;
import
android
.
net
.
Uri
;
import
android
.
os
.
Build
;
import
android
.
support
.
annotation
.
VisibleForTesting
;
import
android
.
text
.
TextUtils
;
import
org
.
mozilla
.
focus
.
activity
.
MainActivity
;
import
org
.
mozilla
.
focus
.
utils
.
UrlUtils
;
public
class
HomeScreen
{
private
static
final
String
BROADCAST_INSTALL_SHORTCUT
=
"
com
.
android
.
launcher
.
action
.
INSTALL_SHORTCUT
"
;
public
static
final
String
ADD_TO_HOMESCREEN_TAG
=
"
add_to_homescreen
"
;
public
static
void
installShortCut
(
Context
context
Bitmap
icon
String
url
String
title
)
{
if
(
TextUtils
.
isEmpty
(
title
.
trim
(
)
)
)
{
title
=
generateTitleFromUrl
(
url
)
;
}
if
(
Build
.
VERSION
.
SDK_INT
<
=
Build
.
VERSION_CODES
.
N_MR1
)
{
installShortCutViaBroadcast
(
context
icon
url
title
)
;
}
else
{
installShortCutViaManager
(
context
icon
url
title
)
;
}
}
private
static
void
installShortCutViaBroadcast
(
Context
context
Bitmap
bitmap
String
url
String
title
)
{
final
Intent
shortcutIntent
=
createShortcutIntent
(
context
url
)
;
final
Intent
addIntent
=
new
Intent
(
)
;
addIntent
.
putExtra
(
Intent
.
EXTRA_SHORTCUT_INTENT
shortcutIntent
)
;
addIntent
.
putExtra
(
Intent
.
EXTRA_SHORTCUT_NAME
title
)
;
addIntent
.
putExtra
(
Intent
.
EXTRA_SHORTCUT_ICON
bitmap
)
;
addIntent
.
setAction
(
BROADCAST_INSTALL_SHORTCUT
)
;
context
.
sendBroadcast
(
addIntent
)
;
goToHomeScreen
(
context
)
;
}
TargetApi
(
26
)
private
static
void
installShortCutViaManager
(
Context
context
Bitmap
bitmap
String
url
String
title
)
{
final
Intent
shortcutIntent
=
createShortcutIntent
(
context
url
)
;
ShortcutManager
shortcutManager
=
context
.
getSystemService
(
ShortcutManager
.
class
)
;
if
(
shortcutManager
.
isRequestPinShortcutSupported
(
)
)
{
ShortcutInfo
shortcut
=
new
ShortcutInfo
.
Builder
(
context
url
)
.
setShortLabel
(
title
)
.
setLongLabel
(
url
)
.
setIcon
(
Icon
.
createWithBitmap
(
bitmap
)
)
.
setIntent
(
new
Intent
(
shortcutIntent
)
)
.
build
(
)
;
shortcutManager
.
requestPinShortcut
(
shortcut
null
)
;
}
}
private
static
Intent
createShortcutIntent
(
Context
context
String
url
)
{
final
Intent
shortcutIntent
=
new
Intent
(
context
MainActivity
.
class
)
;
shortcutIntent
.
setAction
(
Intent
.
ACTION_VIEW
)
;
shortcutIntent
.
setData
(
Uri
.
parse
(
url
)
)
;
shortcutIntent
.
putExtra
(
ADD_TO_HOMESCREEN_TAG
ADD_TO_HOMESCREEN_TAG
)
;
return
shortcutIntent
;
}
VisibleForTesting
static
String
generateTitleFromUrl
(
String
url
)
{
return
UrlUtils
.
stripCommonSubdomains
(
Uri
.
parse
(
url
)
.
getHost
(
)
)
;
}
private
static
void
goToHomeScreen
(
Context
context
)
{
Intent
intent
=
new
Intent
(
Intent
.
ACTION_MAIN
)
;
intent
.
addCategory
(
Intent
.
CATEGORY_HOME
)
;
intent
.
setFlags
(
Intent
.
FLAG_ACTIVITY_NEW_TASK
)
;
context
.
startActivity
(
intent
)
;
}
}
