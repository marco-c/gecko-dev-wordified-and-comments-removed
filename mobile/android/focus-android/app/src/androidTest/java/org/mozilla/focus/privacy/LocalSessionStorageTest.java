package
org
.
mozilla
.
focus
.
privacy
;
import
android
.
content
.
Context
;
import
androidx
.
preference
.
PreferenceManager
;
import
androidx
.
test
.
InstrumentationRegistry
;
import
androidx
.
test
.
rule
.
ActivityTestRule
;
import
androidx
.
test
.
runner
.
AndroidJUnit4
;
import
androidx
.
test
.
uiautomator
.
UiObject
;
import
androidx
.
test
.
uiautomator
.
UiSelector
;
import
junit
.
framework
.
Assert
;
import
org
.
junit
.
After
;
import
org
.
junit
.
Ignore
;
import
org
.
junit
.
Rule
;
import
org
.
junit
.
Test
;
import
org
.
junit
.
runner
.
RunWith
;
import
org
.
mozilla
.
focus
.
activity
.
MainActivity
;
import
org
.
mozilla
.
focus
.
helpers
.
TestHelper
;
import
org
.
mozilla
.
focus
.
utils
.
AppConstants
;
import
java
.
io
.
IOException
;
import
okhttp3
.
mockwebserver
.
MockResponse
;
import
okhttp3
.
mockwebserver
.
MockWebServer
;
import
static
androidx
.
test
.
espresso
.
action
.
ViewActions
.
click
;
import
static
org
.
junit
.
Assert
.
assertTrue
;
import
static
org
.
mozilla
.
focus
.
fragment
.
FirstrunFragment
.
FIRSTRUN_PREF
;
import
static
org
.
mozilla
.
focus
.
helpers
.
TestHelper
.
waitingTime
;
RunWith
(
AndroidJUnit4
.
class
)
Ignore
(
"
This
test
was
written
specifically
for
WebView
and
needs
to
be
adapted
for
GeckoView
"
)
public
class
LocalSessionStorageTest
{
public
static
final
String
SESSION_STORAGE_HIT
=
"
Session
storage
has
value
"
;
public
static
final
String
LOCAL_STORAGE_MISS
=
"
Local
storage
empty
"
;
private
MockWebServer
webServer
;
Rule
public
ActivityTestRule
<
MainActivity
>
mActivityTestRule
=
new
ActivityTestRule
<
MainActivity
>
(
MainActivity
.
class
)
{
Override
protected
void
beforeActivityLaunched
(
)
{
super
.
beforeActivityLaunched
(
)
;
final
Context
appContext
=
InstrumentationRegistry
.
getInstrumentation
(
)
.
getTargetContext
(
)
.
getApplicationContext
(
)
;
PreferenceManager
.
getDefaultSharedPreferences
(
appContext
)
.
edit
(
)
.
putBoolean
(
FIRSTRUN_PREF
true
)
.
apply
(
)
;
webServer
=
new
MockWebServer
(
)
;
try
{
webServer
.
enqueue
(
new
MockResponse
(
)
.
setBody
(
TestHelper
.
readTestAsset
(
"
storage_start
.
html
"
)
)
)
;
webServer
.
enqueue
(
new
MockResponse
(
)
.
setBody
(
TestHelper
.
readTestAsset
(
"
storage_check
.
html
"
)
)
)
;
webServer
.
enqueue
(
new
MockResponse
(
)
.
setBody
(
TestHelper
.
readTestAsset
(
"
storage_check
.
html
"
)
)
)
;
webServer
.
start
(
)
;
}
catch
(
IOException
e
)
{
throw
new
AssertionError
(
"
Could
not
start
web
server
"
e
)
;
}
}
Override
protected
void
afterActivityFinished
(
)
{
super
.
afterActivityFinished
(
)
;
try
{
webServer
.
shutdown
(
)
;
}
catch
(
IOException
e
)
{
throw
new
AssertionError
(
"
Could
not
stop
web
server
"
e
)
;
}
}
}
;
After
public
void
tearDown
(
)
{
mActivityTestRule
.
getActivity
(
)
.
finishAndRemoveTask
(
)
;
}
Test
public
void
testLocalAndSessionStorageIsWrittenAndRemoved
(
)
throws
Exception
{
goToUrlFromHomeScreen
(
"
/
sessionStorage_start
"
)
;
final
UiObject
savedMsg
=
TestHelper
.
mDevice
.
findObject
(
new
UiSelector
(
)
.
description
(
"
Values
written
to
storage
"
)
.
enabled
(
true
)
)
;
savedMsg
.
waitForExists
(
waitingTime
)
;
assertTrue
(
"
Website
loaded
and
values
written
to
local
/
session
storage
"
savedMsg
.
exists
(
)
)
;
goToUrlFromBrowserScreen
(
"
/
sessionStorage_check
"
)
;
{
final
UiObject
sessionStorageMsg
=
TestHelper
.
mDevice
.
findObject
(
new
UiSelector
(
)
.
description
(
SESSION_STORAGE_HIT
)
.
enabled
(
true
)
)
;
sessionStorageMsg
.
waitForExists
(
waitingTime
)
;
assertTrue
(
sessionStorageMsg
.
exists
(
)
)
;
}
{
final
UiObject
localStorageMsg
=
TestHelper
.
mDevice
.
findObject
(
new
UiSelector
(
)
.
description
(
LOCAL_STORAGE_MISS
)
.
enabled
(
true
)
)
;
localStorageMsg
.
waitForExists
(
waitingTime
)
;
assertTrue
(
localStorageMsg
.
exists
(
)
)
;
}
TestHelper
.
floatingEraseButton
.
perform
(
click
(
)
)
;
TestHelper
.
erasedMsg
.
waitForExists
(
waitingTime
)
;
Assert
.
assertTrue
(
TestHelper
.
erasedMsg
.
exists
(
)
)
;
Assert
.
assertTrue
(
TestHelper
.
inlineAutocompleteEditText
.
exists
(
)
)
;
goToUrlFromHomeScreen
(
"
/
sessionStorage_check
"
)
;
{
final
UiObject
sessionStorageMsg
=
TestHelper
.
mDevice
.
findObject
(
new
UiSelector
(
)
.
description
(
"
Session
storage
empty
"
)
.
enabled
(
true
)
)
;
sessionStorageMsg
.
waitForExists
(
waitingTime
)
;
assertTrue
(
sessionStorageMsg
.
exists
(
)
)
;
}
{
final
UiObject
localStorageMsg
=
TestHelper
.
mDevice
.
findObject
(
new
UiSelector
(
)
.
description
(
"
Local
storage
empty
"
)
.
enabled
(
true
)
)
;
localStorageMsg
.
waitForExists
(
waitingTime
)
;
assertTrue
(
localStorageMsg
.
exists
(
)
)
;
}
}
private
void
goToUrlFromHomeScreen
(
String
url
)
throws
Exception
{
TestHelper
.
inlineAutocompleteEditText
.
waitForExists
(
waitingTime
)
;
TestHelper
.
inlineAutocompleteEditText
.
clearTextField
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
setText
(
webServer
.
url
(
url
)
.
toString
(
)
)
;
TestHelper
.
hint
.
waitForExists
(
waitingTime
)
;
TestHelper
.
pressEnterKey
(
)
;
TestHelper
.
waitForWebContent
(
)
;
}
private
void
goToUrlFromBrowserScreen
(
String
url
)
throws
Exception
{
TestHelper
.
browserURLbar
.
waitForExists
(
waitingTime
)
;
TestHelper
.
browserURLbar
.
click
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
waitForExists
(
waitingTime
)
;
TestHelper
.
inlineAutocompleteEditText
.
clearTextField
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
setText
(
webServer
.
url
(
url
)
.
toString
(
)
)
;
TestHelper
.
hint
.
waitForExists
(
waitingTime
)
;
TestHelper
.
pressEnterKey
(
)
;
assertTrue
(
TestHelper
.
webView
.
waitForExists
(
waitingTime
)
)
;
}
}
