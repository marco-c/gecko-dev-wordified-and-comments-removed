package
org
.
mozilla
.
focus
.
activity
;
import
android
.
content
.
Context
;
import
android
.
preference
.
PreferenceManager
;
import
android
.
support
.
test
.
InstrumentationRegistry
;
import
android
.
support
.
test
.
rule
.
ActivityTestRule
;
import
android
.
support
.
test
.
uiautomator
.
UiObject
;
import
android
.
support
.
test
.
uiautomator
.
UiObjectNotFoundException
;
import
android
.
support
.
test
.
uiautomator
.
UiScrollable
;
import
android
.
support
.
test
.
uiautomator
.
UiSelector
;
import
android
.
widget
.
RadioButton
;
import
org
.
junit
.
After
;
import
org
.
junit
.
Rule
;
import
org
.
junit
.
Test
;
import
org
.
junit
.
runner
.
RunWith
;
import
org
.
junit
.
runners
.
Parameterized
;
import
org
.
mozilla
.
focus
.
R
;
import
org
.
mozilla
.
focus
.
helpers
.
TestHelper
;
import
org
.
mozilla
.
focus
.
utils
.
AppConstants
;
import
java
.
util
.
Arrays
;
import
static
android
.
support
.
test
.
espresso
.
Espresso
.
onView
;
import
static
android
.
support
.
test
.
espresso
.
assertion
.
ViewAssertions
.
matches
;
import
static
android
.
support
.
test
.
espresso
.
matcher
.
ViewMatchers
.
isDescendantOfA
;
import
static
android
.
support
.
test
.
espresso
.
matcher
.
ViewMatchers
.
isDisplayed
;
import
static
android
.
support
.
test
.
espresso
.
matcher
.
ViewMatchers
.
withId
;
import
static
android
.
support
.
test
.
espresso
.
matcher
.
ViewMatchers
.
withText
;
import
static
android
.
view
.
KeyEvent
.
KEYCODE_SPACE
;
import
static
junit
.
framework
.
Assert
.
assertTrue
;
import
static
org
.
hamcrest
.
Matchers
.
allOf
;
import
static
org
.
hamcrest
.
Matchers
.
containsString
;
import
static
org
.
mozilla
.
focus
.
fragment
.
FirstrunFragment
.
FIRSTRUN_PREF
;
import
static
org
.
mozilla
.
focus
.
helpers
.
EspressoHelper
.
childAtPosition
;
import
static
org
.
mozilla
.
focus
.
helpers
.
EspressoHelper
.
openSettings
;
import
static
org
.
mozilla
.
focus
.
helpers
.
TestHelper
.
waitingTime
;
import
static
org
.
mozilla
.
focus
.
helpers
.
TestHelper
.
webPageLoadwaitingTime
;
RunWith
(
Parameterized
.
class
)
public
class
ChangeSearchEngineTest
{
Parameterized
.
Parameter
public
String
mSearchEngine
;
Parameterized
.
Parameters
public
static
Iterable
<
?
>
data
(
)
{
return
Arrays
.
asList
(
"
Google
"
"
DuckDuckGo
"
)
;
}
Rule
public
ActivityTestRule
<
MainActivity
>
mActivityTestRule
=
new
ActivityTestRule
<
MainActivity
>
(
MainActivity
.
class
)
{
Override
protected
void
beforeActivityLaunched
(
)
{
super
.
beforeActivityLaunched
(
)
;
Context
appContext
=
InstrumentationRegistry
.
getInstrumentation
(
)
.
getTargetContext
(
)
.
getApplicationContext
(
)
;
org
.
junit
.
Assume
.
assumeTrue
(
!
AppConstants
.
INSTANCE
.
isGeckoBuild
(
)
&
&
!
AppConstants
.
INSTANCE
.
isKlarBuild
(
)
)
;
PreferenceManager
.
getDefaultSharedPreferences
(
appContext
)
.
edit
(
)
.
putBoolean
(
FIRSTRUN_PREF
true
)
.
apply
(
)
;
}
}
;
After
public
void
tearDown
(
)
{
mActivityTestRule
.
getActivity
(
)
.
finishAndRemoveTask
(
)
;
}
Test
public
void
SearchTest
(
)
throws
UiObjectNotFoundException
{
UiObject
searchMenu
=
TestHelper
.
settingsMenu
.
getChild
(
new
UiSelector
(
)
.
className
(
"
android
.
widget
.
LinearLayout
"
)
.
instance
(
2
)
)
;
UiObject
searchEngineSelectorLabel
=
searchMenu
.
getChild
(
new
UiSelector
(
)
.
resourceId
(
"
android
:
id
/
title
"
)
.
text
(
"
Search
"
)
.
enabled
(
true
)
)
;
String
searchString
=
String
.
format
(
"
mozilla
focus
-
%
s
Search
"
mSearchEngine
)
;
UiObject
googleWebView
=
TestHelper
.
mDevice
.
findObject
(
new
UiSelector
(
)
.
description
(
searchString
)
.
className
(
"
android
.
webkit
.
WebView
"
)
)
;
assertTrue
(
TestHelper
.
inlineAutocompleteEditText
.
waitForExists
(
waitingTime
)
)
;
openSettings
(
)
;
TestHelper
.
settingsHeading
.
waitForExists
(
waitingTime
)
;
searchEngineSelectorLabel
.
waitForExists
(
waitingTime
)
;
searchEngineSelectorLabel
.
click
(
)
;
UiObject
defaultSearchEngineLabel
=
TestHelper
.
settingsMenu
.
getChild
(
new
UiSelector
(
)
.
className
(
"
android
.
widget
.
LinearLayout
"
)
.
instance
(
0
)
)
;
defaultSearchEngineLabel
.
waitForExists
(
waitingTime
)
;
defaultSearchEngineLabel
.
click
(
)
;
UiScrollable
searchEngineList
=
new
UiScrollable
(
new
UiSelector
(
)
.
resourceId
(
TestHelper
.
getAppName
(
)
+
"
:
id
/
search_engine_group
"
)
.
enabled
(
true
)
)
;
UiObject
defaultEngineSelection
=
searchEngineList
.
getChildByText
(
new
UiSelector
(
)
.
className
(
RadioButton
.
class
)
mSearchEngine
)
;
defaultEngineSelection
.
waitForExists
(
waitingTime
)
;
assertTrue
(
defaultEngineSelection
.
getText
(
)
.
equals
(
mSearchEngine
)
)
;
defaultEngineSelection
.
click
(
)
;
TestHelper
.
pressBackKey
(
)
;
TestHelper
.
settingsHeading
.
waitForExists
(
waitingTime
)
;
UiObject
defaultSearchEngine
=
TestHelper
.
mDevice
.
findObject
(
new
UiSelector
(
)
.
text
(
mSearchEngine
)
.
resourceId
(
"
android
:
id
/
summary
"
)
)
;
assertTrue
(
defaultSearchEngine
.
getText
(
)
.
equals
(
mSearchEngine
)
)
;
TestHelper
.
pressBackKey
(
)
;
TestHelper
.
pressBackKey
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
waitForExists
(
waitingTime
)
;
TestHelper
.
inlineAutocompleteEditText
.
clearTextField
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
setText
(
"
"
)
;
TestHelper
.
pressEnterKey
(
)
;
assertTrue
(
TestHelper
.
inlineAutocompleteEditText
.
exists
(
)
)
;
TestHelper
.
inlineAutocompleteEditText
.
clearTextField
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
setText
(
"
mozilla
"
)
;
if
(
TestHelper
.
searchSuggestionsTitle
.
exists
(
)
)
{
TestHelper
.
searchSuggestionsButtonYes
.
waitForExists
(
waitingTime
)
;
TestHelper
.
searchSuggestionsButtonYes
.
click
(
)
;
}
TestHelper
.
mDevice
.
pressKeyCode
(
KEYCODE_SPACE
)
;
TestHelper
.
suggestionList
.
waitForExists
(
waitingTime
)
;
assertTrue
(
TestHelper
.
suggestionList
.
getChildCount
(
)
>
=
1
)
;
onView
(
allOf
(
withText
(
containsString
(
"
mozilla
"
)
)
withId
(
R
.
id
.
searchView
)
)
)
.
check
(
matches
(
isDisplayed
(
)
)
)
;
int
count
=
0
;
int
maxCount
=
3
;
while
(
count
<
maxCount
)
{
onView
(
allOf
(
withText
(
containsString
(
"
mozilla
"
)
)
withId
(
R
.
id
.
suggestion
)
isDescendantOfA
(
childAtPosition
(
withId
(
R
.
id
.
suggestionList
)
count
)
)
)
)
.
check
(
matches
(
isDisplayed
(
)
)
)
;
count
+
+
;
}
TestHelper
.
inlineAutocompleteEditText
.
waitForExists
(
waitingTime
)
;
TestHelper
.
inlineAutocompleteEditText
.
click
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
clearTextField
(
)
;
TestHelper
.
inlineAutocompleteEditText
.
setText
(
"
mozilla
focus
"
)
;
TestHelper
.
pressEnterKey
(
)
;
googleWebView
.
waitForExists
(
waitingTime
)
;
TestHelper
.
progressBar
.
waitUntilGone
(
webPageLoadwaitingTime
)
;
assertTrue
(
TestHelper
.
browserURLbar
.
getText
(
)
.
contains
(
mSearchEngine
.
toLowerCase
(
)
)
)
;
assertTrue
(
TestHelper
.
browserURLbar
.
getText
(
)
.
contains
(
"
mozilla
"
)
)
;
assertTrue
(
TestHelper
.
browserURLbar
.
getText
(
)
.
contains
(
"
focus
"
)
)
;
}
}
