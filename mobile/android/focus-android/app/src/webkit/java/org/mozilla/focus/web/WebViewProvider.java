package
org
.
mozilla
.
focus
.
web
;
import
android
.
annotation
.
SuppressLint
;
import
android
.
content
.
Context
;
import
android
.
content
.
pm
.
PackageManager
;
import
android
.
graphics
.
Bitmap
;
import
android
.
os
.
Build
;
import
android
.
support
.
annotation
.
VisibleForTesting
;
import
android
.
text
.
TextUtils
;
import
android
.
util
.
AttributeSet
;
import
android
.
view
.
View
;
import
android
.
webkit
.
CookieManager
;
import
android
.
webkit
.
WebChromeClient
;
import
android
.
webkit
.
WebSettings
;
import
android
.
webkit
.
WebStorage
;
import
android
.
webkit
.
WebView
;
import
android
.
webkit
.
WebViewDatabase
;
import
org
.
mozilla
.
focus
.
BuildConfig
;
import
org
.
mozilla
.
focus
.
R
;
import
org
.
mozilla
.
focus
.
utils
.
Settings
;
import
org
.
mozilla
.
focus
.
webkit
.
NestedWebView
;
import
org
.
mozilla
.
focus
.
webkit
.
TrackingProtectionWebViewClient
;
public
class
WebViewProvider
{
public
static
void
preload
(
final
Context
context
)
{
TrackingProtectionWebViewClient
.
triggerPreload
(
context
)
;
}
public
static
View
create
(
Context
context
AttributeSet
attrs
)
{
final
WebkitView
webkitView
=
new
WebkitView
(
context
attrs
)
;
setupView
(
webkitView
)
;
configureSettings
(
context
webkitView
.
getSettings
(
)
)
;
return
webkitView
;
}
private
static
void
setupView
(
WebView
webView
)
{
webView
.
setVerticalScrollBarEnabled
(
true
)
;
webView
.
setHorizontalScrollBarEnabled
(
true
)
;
}
SuppressLint
(
"
SetJavaScriptEnabled
"
)
private
static
void
configureSettings
(
Context
context
WebSettings
settings
)
{
final
Settings
appSettings
=
new
Settings
(
context
)
;
settings
.
setJavaScriptEnabled
(
true
)
;
settings
.
setBuiltInZoomControls
(
true
)
;
settings
.
setDisplayZoomControls
(
false
)
;
settings
.
setAllowFileAccess
(
false
)
;
settings
.
setBlockNetworkImage
(
appSettings
.
shouldBlockImages
(
)
)
;
settings
.
setUserAgentString
(
buildUserAgentString
(
context
settings
)
)
;
}
VisibleForTesting
static
String
getUABrowserString
(
final
String
existingUAString
final
String
focusToken
)
{
int
start
=
existingUAString
.
indexOf
(
"
AppleWebKit
"
)
;
if
(
start
=
=
-
1
)
{
start
=
existingUAString
.
indexOf
(
"
)
"
)
+
2
;
if
(
start
>
=
existingUAString
.
length
(
)
)
{
return
focusToken
;
}
}
final
String
[
]
tokens
=
existingUAString
.
substring
(
start
)
.
split
(
"
"
)
;
for
(
int
i
=
0
;
i
<
tokens
.
length
;
i
+
+
)
{
if
(
tokens
[
i
]
.
startsWith
(
"
Chrome
"
)
)
{
tokens
[
i
]
=
focusToken
+
"
"
+
tokens
[
i
]
;
return
TextUtils
.
join
(
"
"
tokens
)
;
}
}
return
TextUtils
.
join
(
"
"
tokens
)
+
focusToken
;
}
private
static
String
buildUserAgentString
(
final
Context
context
final
WebSettings
settings
)
{
final
StringBuilder
uaBuilder
=
new
StringBuilder
(
)
;
uaBuilder
.
append
(
"
Mozilla
/
5
.
0
"
)
;
uaBuilder
.
append
(
"
(
Linux
;
Android
"
)
.
append
(
Build
.
VERSION
.
RELEASE
)
.
append
(
"
)
"
)
;
final
String
existingWebViewUA
=
settings
.
getUserAgentString
(
)
;
final
String
appVersion
;
try
{
appVersion
=
context
.
getPackageManager
(
)
.
getPackageInfo
(
context
.
getPackageName
(
)
0
)
.
versionName
;
}
catch
(
PackageManager
.
NameNotFoundException
e
)
{
throw
new
IllegalStateException
(
"
Unable
find
package
details
for
Focus
"
e
)
;
}
final
String
focusToken
=
context
.
getResources
(
)
.
getString
(
R
.
string
.
useragent_appname
)
+
"
/
"
+
appVersion
;
uaBuilder
.
append
(
getUABrowserString
(
existingWebViewUA
focusToken
)
)
;
return
uaBuilder
.
toString
(
)
;
}
private
static
class
WebkitView
extends
NestedWebView
implements
IWebView
{
private
Callback
callback
;
private
TrackingProtectionWebViewClient
client
;
public
WebkitView
(
Context
context
AttributeSet
attrs
)
{
super
(
context
attrs
)
;
client
=
createWebViewClient
(
)
;
setWebViewClient
(
client
)
;
setWebChromeClient
(
createWebChromeClient
(
)
)
;
if
(
BuildConfig
.
DEBUG
)
{
setWebContentsDebuggingEnabled
(
true
)
;
}
}
Override
public
void
setCallback
(
Callback
callback
)
{
this
.
callback
=
callback
;
}
public
void
loadUrl
(
String
url
)
{
if
(
!
client
.
shouldOverrideUrlLoading
(
this
url
)
)
{
super
.
loadUrl
(
url
)
;
}
client
.
notifyCurrentURL
(
url
)
;
}
Override
public
void
cleanup
(
)
{
clearFormData
(
)
;
clearHistory
(
)
;
clearMatches
(
)
;
clearSslPreferences
(
)
;
clearCache
(
true
)
;
CookieManager
.
getInstance
(
)
.
removeAllCookies
(
null
)
;
WebStorage
.
getInstance
(
)
.
deleteAllData
(
)
;
final
WebViewDatabase
webViewDatabase
=
WebViewDatabase
.
getInstance
(
getContext
(
)
)
;
webViewDatabase
.
clearFormData
(
)
;
webViewDatabase
.
clearHttpAuthUsernamePassword
(
)
;
}
private
TrackingProtectionWebViewClient
createWebViewClient
(
)
{
return
new
TrackingProtectionWebViewClient
(
getContext
(
)
.
getApplicationContext
(
)
)
{
Override
public
void
onPageStarted
(
WebView
view
String
url
Bitmap
favicon
)
{
if
(
callback
!
=
null
)
{
callback
.
onPageStarted
(
url
)
;
}
super
.
onPageStarted
(
view
url
favicon
)
;
}
Override
public
void
onPageFinished
(
WebView
view
String
url
)
{
if
(
callback
!
=
null
)
{
callback
.
onPageFinished
(
view
.
getCertificate
(
)
!
=
null
)
;
}
super
.
onPageFinished
(
view
url
)
;
}
Override
public
boolean
shouldOverrideUrlLoading
(
WebView
view
String
url
)
{
if
(
(
!
url
.
startsWith
(
"
http
:
/
/
"
)
)
&
&
(
!
url
.
startsWith
(
"
https
:
/
/
"
)
)
&
&
(
!
url
.
startsWith
(
"
file
:
/
/
"
)
)
&
&
(
!
url
.
startsWith
(
"
data
:
"
)
)
&
&
(
!
url
.
startsWith
(
"
error
:
"
)
)
)
{
callback
.
handleExternalUrl
(
url
)
;
return
true
;
}
return
super
.
shouldOverrideUrlLoading
(
view
url
)
;
}
}
;
}
private
WebChromeClient
createWebChromeClient
(
)
{
return
new
WebChromeClient
(
)
{
Override
public
void
onProgressChanged
(
WebView
view
int
newProgress
)
{
if
(
callback
!
=
null
)
{
callback
.
onProgress
(
newProgress
)
;
}
}
}
;
}
}
}
