package
org
.
mozilla
.
focus
.
web
;
import
android
.
annotation
.
SuppressLint
;
import
android
.
content
.
Context
;
import
android
.
content
.
pm
.
PackageManager
;
import
android
.
os
.
Build
;
import
android
.
support
.
annotation
.
VisibleForTesting
;
import
android
.
text
.
TextUtils
;
import
android
.
util
.
AttributeSet
;
import
android
.
view
.
View
;
import
android
.
webkit
.
WebSettings
;
import
android
.
webkit
.
WebView
;
import
org
.
mozilla
.
focus
.
R
;
import
org
.
mozilla
.
focus
.
utils
.
Settings
;
import
org
.
mozilla
.
focus
.
webkit
.
TrackingProtectionWebViewClient
;
import
org
.
mozilla
.
focus
.
webkit
.
WebkitView
;
public
class
WebViewProvider
{
public
static
void
preload
(
final
Context
context
)
{
TrackingProtectionWebViewClient
.
triggerPreload
(
context
)
;
}
public
static
void
performCleanup
(
final
Context
context
)
{
final
WebkitView
webView
=
new
WebkitView
(
context
null
)
;
webView
.
cleanup
(
)
;
webView
.
destroy
(
)
;
}
public
static
View
create
(
Context
context
AttributeSet
attrs
)
{
final
WebkitView
webkitView
=
new
WebkitView
(
context
attrs
)
;
final
WebSettings
settings
=
webkitView
.
getSettings
(
)
;
setupView
(
webkitView
)
;
configureDefaultSettings
(
context
settings
)
;
applyAppSettings
(
context
settings
)
;
return
webkitView
;
}
private
static
void
setupView
(
WebView
webView
)
{
webView
.
setVerticalScrollBarEnabled
(
true
)
;
webView
.
setHorizontalScrollBarEnabled
(
true
)
;
}
SuppressLint
(
"
SetJavaScriptEnabled
"
)
private
static
void
configureDefaultSettings
(
Context
context
WebSettings
settings
)
{
settings
.
setJavaScriptEnabled
(
true
)
;
settings
.
setBuiltInZoomControls
(
true
)
;
settings
.
setDisplayZoomControls
(
false
)
;
settings
.
setLoadWithOverviewMode
(
true
)
;
settings
.
setLayoutAlgorithm
(
WebSettings
.
LayoutAlgorithm
.
TEXT_AUTOSIZING
)
;
settings
.
setAllowFileAccess
(
false
)
;
settings
.
setAllowFileAccessFromFileURLs
(
false
)
;
settings
.
setAllowUniversalAccessFromFileURLs
(
false
)
;
settings
.
setUserAgentString
(
buildUserAgentString
(
context
settings
)
)
;
settings
.
setAllowContentAccess
(
false
)
;
settings
.
setAppCacheEnabled
(
false
)
;
settings
.
setDatabaseEnabled
(
false
)
;
settings
.
setDomStorageEnabled
(
false
)
;
settings
.
setJavaScriptCanOpenWindowsAutomatically
(
false
)
;
settings
.
setGeolocationEnabled
(
false
)
;
settings
.
setSaveFormData
(
false
)
;
settings
.
setSavePassword
(
false
)
;
}
public
static
void
applyAppSettings
(
Context
context
WebSettings
settings
)
{
final
Settings
appSettings
=
new
Settings
(
context
)
;
settings
.
setBlockNetworkImage
(
appSettings
.
shouldBlockImages
(
)
)
;
}
VisibleForTesting
static
String
getUABrowserString
(
final
String
existingUAString
final
String
focusToken
)
{
int
start
=
existingUAString
.
indexOf
(
"
AppleWebKit
"
)
;
if
(
start
=
=
-
1
)
{
start
=
existingUAString
.
indexOf
(
"
)
"
)
+
2
;
if
(
start
>
=
existingUAString
.
length
(
)
)
{
return
focusToken
;
}
}
final
String
[
]
tokens
=
existingUAString
.
substring
(
start
)
.
split
(
"
"
)
;
for
(
int
i
=
0
;
i
<
tokens
.
length
;
i
+
+
)
{
if
(
tokens
[
i
]
.
startsWith
(
"
Chrome
"
)
)
{
tokens
[
i
]
=
focusToken
+
"
"
+
tokens
[
i
]
;
return
TextUtils
.
join
(
"
"
tokens
)
;
}
}
return
TextUtils
.
join
(
"
"
tokens
)
+
focusToken
;
}
private
static
String
buildUserAgentString
(
final
Context
context
final
WebSettings
settings
)
{
final
StringBuilder
uaBuilder
=
new
StringBuilder
(
)
;
uaBuilder
.
append
(
"
Mozilla
/
5
.
0
"
)
;
uaBuilder
.
append
(
"
(
Linux
;
Android
"
)
.
append
(
Build
.
VERSION
.
RELEASE
)
.
append
(
"
)
"
)
;
final
String
existingWebViewUA
=
settings
.
getUserAgentString
(
)
;
final
String
appVersion
;
try
{
appVersion
=
context
.
getPackageManager
(
)
.
getPackageInfo
(
context
.
getPackageName
(
)
0
)
.
versionName
;
}
catch
(
PackageManager
.
NameNotFoundException
e
)
{
throw
new
IllegalStateException
(
"
Unable
find
package
details
for
Focus
"
e
)
;
}
final
String
focusToken
=
context
.
getResources
(
)
.
getString
(
R
.
string
.
useragent_appname
)
+
"
/
"
+
appVersion
;
uaBuilder
.
append
(
getUABrowserString
(
existingWebViewUA
focusToken
)
)
;
return
uaBuilder
.
toString
(
)
;
}
}
