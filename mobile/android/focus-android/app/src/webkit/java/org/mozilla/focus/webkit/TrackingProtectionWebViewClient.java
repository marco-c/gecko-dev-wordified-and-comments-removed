package
org
.
mozilla
.
focus
.
webkit
;
import
android
.
content
.
Context
;
import
android
.
graphics
.
Bitmap
;
import
android
.
os
.
AsyncTask
;
import
android
.
support
.
annotation
.
WorkerThread
;
import
android
.
webkit
.
WebResourceRequest
;
import
android
.
webkit
.
WebResourceResponse
;
import
android
.
webkit
.
WebView
;
import
android
.
webkit
.
WebViewClient
;
import
org
.
mozilla
.
focus
.
R
;
import
org
.
mozilla
.
focus
.
webkit
.
matcher
.
UrlMatcher
;
public
class
TrackingProtectionWebViewClient
extends
WebViewClient
{
private
String
currentPageURL
;
private
static
volatile
UrlMatcher
MATCHER
;
public
static
void
triggerPreload
(
final
Context
context
)
{
if
(
MATCHER
=
=
null
)
{
new
AsyncTask
<
Void
Void
Void
>
(
)
{
Override
protected
Void
doInBackground
(
Void
.
.
.
voids
)
{
getMatcher
(
context
)
;
return
null
;
}
}
.
execute
(
)
;
}
}
WorkerThread
private
static
synchronized
UrlMatcher
getMatcher
(
final
Context
context
)
{
if
(
MATCHER
=
=
null
)
{
MATCHER
=
UrlMatcher
.
loadMatcher
(
context
R
.
raw
.
blocklist
R
.
raw
.
entitylist
)
;
}
return
MATCHER
;
}
public
TrackingProtectionWebViewClient
(
final
Context
context
)
{
triggerPreload
(
context
)
;
}
Override
public
WebResourceResponse
shouldInterceptRequest
(
WebView
view
WebResourceRequest
request
)
{
final
String
scheme
=
request
.
getUrl
(
)
.
getScheme
(
)
;
if
(
!
request
.
isForMainFrame
(
)
&
&
!
scheme
.
equals
(
"
http
"
)
&
&
!
scheme
.
equals
(
"
https
"
)
)
{
return
new
WebResourceResponse
(
null
null
null
)
;
}
final
UrlMatcher
matcher
=
getMatcher
(
view
.
getContext
(
)
)
;
if
(
(
!
request
.
isForMainFrame
(
)
)
&
&
matcher
.
matches
(
request
.
getUrl
(
)
.
toString
(
)
currentPageURL
)
)
{
return
new
WebResourceResponse
(
null
null
null
)
;
}
return
super
.
shouldInterceptRequest
(
view
request
)
;
}
public
void
notifyCurrentURL
(
final
String
url
)
{
currentPageURL
=
url
;
}
Override
public
void
onPageStarted
(
WebView
view
String
url
Bitmap
favicon
)
{
currentPageURL
=
url
;
super
.
onPageStarted
(
view
url
favicon
)
;
}
Override
public
boolean
shouldOverrideUrlLoading
(
WebView
view
String
url
)
{
currentPageURL
=
url
;
return
super
.
shouldOverrideUrlLoading
(
view
url
)
;
}
}
