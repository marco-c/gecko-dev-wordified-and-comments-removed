package
com
.
leanplum
;
import
android
.
app
.
Activity
;
import
android
.
app
.
Notification
;
import
android
.
app
.
NotificationManager
;
import
android
.
app
.
PendingIntent
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
content
.
pm
.
PackageManager
;
import
android
.
content
.
pm
.
ResolveInfo
;
import
android
.
graphics
.
Bitmap
;
import
android
.
net
.
Uri
;
import
android
.
os
.
Build
;
import
android
.
os
.
Bundle
;
import
android
.
support
.
v4
.
app
.
NotificationCompat
;
import
android
.
text
.
TextUtils
;
import
com
.
leanplum
.
callbacks
.
VariablesChangedCallback
;
import
com
.
leanplum
.
internal
.
ActionManager
;
import
com
.
leanplum
.
internal
.
Constants
;
import
com
.
leanplum
.
internal
.
Constants
.
Keys
;
import
com
.
leanplum
.
internal
.
Constants
.
Methods
;
import
com
.
leanplum
.
internal
.
Constants
.
Params
;
import
com
.
leanplum
.
internal
.
JsonConverter
;
import
com
.
leanplum
.
internal
.
LeanplumInternal
;
import
com
.
leanplum
.
internal
.
LeanplumManifestHelper
;
import
com
.
leanplum
.
internal
.
Log
;
import
com
.
leanplum
.
internal
.
Request
;
import
com
.
leanplum
.
internal
.
Util
;
import
com
.
leanplum
.
internal
.
VarCache
;
import
com
.
leanplum
.
utils
.
BitmapUtil
;
import
com
.
leanplum
.
utils
.
BuildUtil
;
import
com
.
leanplum
.
utils
.
SharedPreferencesUtil
;
import
org
.
json
.
JSONException
;
import
org
.
json
.
JSONObject
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
List
;
import
java
.
util
.
Map
;
import
java
.
util
.
Random
;
public
class
LeanplumPushService
{
public
static
final
String
LEANPLUM_SENDER_ID
=
"
44059457771
"
;
public
static
final
String
LEANPLUM_NOTIFICATION
=
"
LP_NOTIFICATION
"
;
public
static
final
String
LEANPLUM_ACTION_PARAM
=
"
lp_action_param
"
;
public
static
final
String
LEANPLUM_MESSAGE_PARAM
=
"
lp_message_param
"
;
public
static
final
String
LEANPLUM_MESSAGE_ID
=
"
lp_message_id
"
;
private
static
final
String
LEANPLUM_PUSH_FCM_LISTENER_SERVICE_CLASS
=
"
com
.
leanplum
.
LeanplumPushFcmListenerService
"
;
private
static
final
String
PUSH_FIREBASE_MESSAGING_SERVICE_CLASS
=
"
com
.
leanplum
.
LeanplumPushFirebaseMessagingService
"
;
private
static
final
String
LEANPLUM_PUSH_INSTANCE_ID_SERVICE_CLASS
=
"
com
.
leanplum
.
LeanplumPushInstanceIDService
"
;
private
static
final
String
LEANPLUM_PUSH_LISTENER_SERVICE_CLASS
=
"
com
.
leanplum
.
LeanplumPushListenerService
"
;
private
static
final
String
GCM_RECEIVER_CLASS
=
"
com
.
google
.
android
.
gms
.
gcm
.
GcmReceiver
"
;
private
static
final
int
NOTIFICATION_ID
=
1
;
private
static
final
String
OPEN_URL
=
"
Open
URL
"
;
private
static
final
String
URL
=
"
URL
"
;
private
static
final
String
OPEN_ACTION
=
"
Open
"
;
private
static
final
int
MAX_ONE_LINE_TEXT_LENGTH
=
37
;
private
static
Class
<
?
extends
Activity
>
callbackClass
;
private
static
LeanplumCloudMessagingProvider
provider
;
private
static
LeanplumPushNotificationCustomizer
customizer
;
static
LeanplumCloudMessagingProvider
getCloudMessagingProvider
(
)
{
return
provider
;
}
public
static
void
setDefaultCallbackClass
(
Class
<
?
extends
Activity
>
callbackClass
)
{
LeanplumPushService
.
callbackClass
=
callbackClass
;
}
public
static
void
setCustomizer
(
LeanplumPushNotificationCustomizer
customizer
)
{
LeanplumPushService
.
customizer
=
customizer
;
}
public
static
void
setGcmSenderId
(
String
senderId
)
{
LeanplumGcmProvider
.
setSenderId
(
senderId
)
;
}
public
static
void
setGcmSenderIds
(
String
.
.
.
senderIds
)
{
StringBuilder
joinedSenderIds
=
new
StringBuilder
(
)
;
for
(
String
senderId
:
senderIds
)
{
if
(
joinedSenderIds
.
length
(
)
>
0
)
{
joinedSenderIds
.
append
(
'
'
)
;
}
joinedSenderIds
.
append
(
senderId
)
;
}
LeanplumGcmProvider
.
setSenderId
(
joinedSenderIds
.
toString
(
)
)
;
}
private
static
Class
<
?
extends
Activity
>
getCallbackClass
(
)
{
return
callbackClass
;
}
private
static
boolean
areActionsEmbedded
(
final
Bundle
message
)
{
return
message
.
containsKey
(
Keys
.
PUSH_MESSAGE_ACTION
)
;
}
private
static
void
requireMessageContent
(
final
String
messageId
final
VariablesChangedCallback
onComplete
)
{
Leanplum
.
addOnceVariablesChangedAndNoDownloadsPendingHandler
(
new
VariablesChangedCallback
(
)
{
Override
public
void
variablesChanged
(
)
{
try
{
Map
<
String
Object
>
messages
=
VarCache
.
messages
(
)
;
if
(
messageId
=
=
null
|
|
(
messages
!
=
null
&
&
messages
.
containsKey
(
messageId
)
)
)
{
onComplete
.
variablesChanged
(
)
;
}
else
{
Map
<
String
Object
>
params
=
new
HashMap
<
>
(
)
;
params
.
put
(
Params
.
INCLUDE_DEFAULTS
Boolean
.
toString
(
false
)
)
;
params
.
put
(
Params
.
INCLUDE_MESSAGE_ID
messageId
)
;
Request
req
=
Request
.
post
(
Methods
.
GET_VARS
params
)
;
req
.
onResponse
(
new
Request
.
ResponseCallback
(
)
{
Override
public
void
response
(
JSONObject
response
)
{
try
{
if
(
response
=
=
null
)
{
Log
.
e
(
"
No
response
received
from
the
server
.
Please
contact
us
to
"
+
"
investigate
.
"
)
;
}
else
{
Map
<
String
Object
>
values
=
JsonConverter
.
mapFromJson
(
response
.
optJSONObject
(
Constants
.
Keys
.
VARS
)
)
;
Map
<
String
Object
>
messages
=
JsonConverter
.
mapFromJson
(
response
.
optJSONObject
(
Constants
.
Keys
.
MESSAGES
)
)
;
Map
<
String
Object
>
regions
=
JsonConverter
.
mapFromJson
(
response
.
optJSONObject
(
Constants
.
Keys
.
REGIONS
)
)
;
List
<
Map
<
String
Object
>
>
variants
=
JsonConverter
.
listFromJson
(
response
.
optJSONArray
(
Constants
.
Keys
.
VARIANTS
)
)
;
if
(
!
Constants
.
canDownloadContentMidSessionInProduction
|
|
VarCache
.
getDiffs
(
)
.
equals
(
values
)
)
{
values
=
null
;
}
if
(
VarCache
.
getMessageDiffs
(
)
.
equals
(
messages
)
)
{
messages
=
null
;
}
if
(
values
!
=
null
|
|
messages
!
=
null
)
{
VarCache
.
applyVariableDiffs
(
values
messages
null
null
regions
variants
)
;
}
}
onComplete
.
variablesChanged
(
)
;
}
catch
(
Throwable
t
)
{
Util
.
handleException
(
t
)
;
}
}
}
)
;
req
.
onError
(
new
Request
.
ErrorCallback
(
)
{
Override
public
void
error
(
Exception
e
)
{
onComplete
.
variablesChanged
(
)
;
}
}
)
;
req
.
sendIfConnected
(
)
;
}
}
catch
(
Throwable
t
)
{
Util
.
handleException
(
t
)
;
}
}
}
)
;
}
private
static
String
getMessageId
(
Bundle
message
)
{
String
messageId
=
message
.
getString
(
Keys
.
PUSH_MESSAGE_ID_NO_MUTE_WITH_ACTION
)
;
if
(
messageId
=
=
null
)
{
messageId
=
message
.
getString
(
Keys
.
PUSH_MESSAGE_ID_MUTE_WITH_ACTION
)
;
if
(
messageId
=
=
null
)
{
messageId
=
message
.
getString
(
Keys
.
PUSH_MESSAGE_ID_NO_MUTE
)
;
if
(
messageId
=
=
null
)
{
messageId
=
message
.
getString
(
Keys
.
PUSH_MESSAGE_ID_MUTE
)
;
}
}
}
if
(
messageId
!
=
null
)
{
message
.
putString
(
Keys
.
PUSH_MESSAGE_ID
messageId
)
;
}
return
messageId
;
}
public
static
void
handleNotification
(
final
Context
context
final
Bundle
message
)
{
if
(
LeanplumActivityHelper
.
currentActivity
!
=
null
&
&
!
LeanplumActivityHelper
.
isActivityPaused
&
&
(
message
.
containsKey
(
Keys
.
PUSH_MESSAGE_ID_MUTE_WITH_ACTION
)
|
|
message
.
containsKey
(
Keys
.
PUSH_MESSAGE_ID_MUTE
)
)
)
{
return
;
}
final
String
messageId
=
LeanplumPushService
.
getMessageId
(
message
)
;
if
(
messageId
=
=
null
|
|
!
LeanplumInternal
.
hasCalledStart
(
)
)
{
showNotification
(
context
message
)
;
return
;
}
showNotification
(
context
message
)
;
}
private
static
void
showNotification
(
Context
context
final
Bundle
message
)
{
if
(
context
=
=
null
|
|
message
=
=
null
)
{
return
;
}
int
defaultIconId
=
0
;
if
(
!
LeanplumNotificationHelper
.
isApplicationIconValid
(
context
)
)
{
defaultIconId
=
LeanplumNotificationHelper
.
getDefaultPushNotificationIconResourceId
(
context
)
;
if
(
defaultIconId
=
=
0
)
{
Log
.
e
(
"
You
are
using
adaptive
icons
without
having
a
fallback
icon
for
push
"
+
"
notifications
on
Android
Oreo
.
\
n
"
+
"
This
can
cause
a
factory
reset
of
the
device
"
+
"
on
Android
Version
26
.
Please
add
regular
icon
with
name
"
+
"
\
"
leanplum_default_push_icon
.
png
\
"
to
your
\
"
drawable
\
"
folder
.
\
n
"
+
"
Google
issue
:
"
+
"
https
:
/
/
issuetracker
.
google
.
com
/
issues
/
68716460
"
)
;
return
;
}
}
final
NotificationManager
notificationManager
=
(
NotificationManager
)
context
.
getSystemService
(
Context
.
NOTIFICATION_SERVICE
)
;
Intent
intent
=
new
Intent
(
context
LeanplumPushReceiver
.
class
)
;
intent
.
addCategory
(
"
lpAction
"
)
;
intent
.
putExtras
(
message
)
;
PendingIntent
contentIntent
=
PendingIntent
.
getBroadcast
(
context
.
getApplicationContext
(
)
new
Random
(
)
.
nextInt
(
)
intent
0
)
;
String
title
=
Util
.
getApplicationName
(
context
.
getApplicationContext
(
)
)
;
if
(
message
.
getString
(
"
title
"
)
!
=
null
)
{
title
=
message
.
getString
(
"
title
"
)
;
}
final
NotificationCompat
.
Builder
notificationCompatBuilder
=
LeanplumNotificationHelper
.
getNotificationCompatBuilder
(
context
message
)
;
if
(
notificationCompatBuilder
=
=
null
)
{
return
;
}
final
String
messageText
=
message
.
getString
(
Keys
.
PUSH_MESSAGE_TEXT
)
;
if
(
defaultIconId
=
=
0
)
{
notificationCompatBuilder
.
setSmallIcon
(
context
.
getApplicationInfo
(
)
.
icon
)
;
}
else
{
notificationCompatBuilder
.
setSmallIcon
(
defaultIconId
)
;
}
notificationCompatBuilder
.
setContentTitle
(
title
)
.
setStyle
(
new
NotificationCompat
.
BigTextStyle
(
)
.
bigText
(
messageText
)
)
.
setContentText
(
messageText
)
;
String
imageUrl
=
message
.
getString
(
Keys
.
PUSH_MESSAGE_IMAGE_URL
)
;
Notification
.
Builder
notificationBuilder
=
null
;
if
(
!
TextUtils
.
isEmpty
(
imageUrl
)
&
&
Build
.
VERSION
.
SDK_INT
>
=
16
)
{
Bitmap
bigPicture
=
BitmapUtil
.
getScaledBitmap
(
context
imageUrl
)
;
if
(
bigPicture
!
=
null
)
{
if
(
(
messageText
!
=
null
&
&
messageText
.
length
(
)
<
MAX_ONE_LINE_TEXT_LENGTH
)
|
|
customizer
!
=
null
)
{
notificationCompatBuilder
.
setStyle
(
new
NotificationCompat
.
BigPictureStyle
(
)
.
bigPicture
(
bigPicture
)
.
setBigContentTitle
(
title
)
.
setSummaryText
(
messageText
)
)
;
}
else
{
notificationBuilder
=
LeanplumNotificationHelper
.
getNotificationBuilder
(
context
message
contentIntent
title
messageText
bigPicture
defaultIconId
)
;
}
}
else
{
Log
.
w
(
String
.
format
(
"
Image
download
failed
for
push
notification
with
big
picture
.
"
+
"
No
image
will
be
included
with
the
push
notification
.
Image
URL
:
%
s
.
"
imageUrl
)
)
;
}
}
if
(
Build
.
VERSION
.
SDK_INT
>
=
16
&
&
!
BuildUtil
.
isNotificationChannelSupported
(
context
)
)
{
notificationCompatBuilder
.
setPriority
(
Notification
.
PRIORITY_MAX
)
;
}
notificationCompatBuilder
.
setAutoCancel
(
true
)
;
notificationCompatBuilder
.
setContentIntent
(
contentIntent
)
;
if
(
LeanplumPushService
.
customizer
!
=
null
)
{
try
{
LeanplumPushService
.
customizer
.
customize
(
notificationCompatBuilder
message
)
;
}
catch
(
Throwable
t
)
{
Log
.
e
(
"
Unable
to
customize
push
notification
:
"
Log
.
getStackTraceString
(
t
)
)
;
return
;
}
}
int
notificationId
=
LeanplumPushService
.
NOTIFICATION_ID
;
Object
notificationIdObject
=
message
.
get
(
"
lp_notificationId
"
)
;
if
(
notificationIdObject
instanceof
Number
)
{
notificationId
=
(
(
Number
)
notificationIdObject
)
.
intValue
(
)
;
}
else
if
(
notificationIdObject
instanceof
String
)
{
try
{
notificationId
=
Integer
.
parseInt
(
(
String
)
notificationIdObject
)
;
}
catch
(
NumberFormatException
e
)
{
notificationId
=
LeanplumPushService
.
NOTIFICATION_ID
;
}
}
else
if
(
message
.
containsKey
(
Keys
.
PUSH_MESSAGE_ID
)
)
{
String
value
=
message
.
getString
(
Keys
.
PUSH_MESSAGE_ID
)
;
if
(
value
!
=
null
)
{
notificationId
=
value
.
hashCode
(
)
;
}
}
try
{
if
(
ActionContext
.
shouldForceContentUpdateForChainedMessage
(
JsonConverter
.
fromJson
(
message
.
getString
(
Keys
.
PUSH_MESSAGE_ACTION
)
)
)
)
{
final
int
currentNotificationId
=
notificationId
;
final
Notification
.
Builder
currentNotificationBuilder
=
notificationBuilder
;
Leanplum
.
forceContentUpdate
(
new
VariablesChangedCallback
(
)
{
Override
public
void
variablesChanged
(
)
{
if
(
currentNotificationBuilder
!
=
null
)
{
notificationManager
.
notify
(
currentNotificationId
currentNotificationBuilder
.
build
(
)
)
;
}
else
{
notificationManager
.
notify
(
currentNotificationId
notificationCompatBuilder
.
build
(
)
)
;
}
}
}
)
;
}
else
{
if
(
notificationBuilder
!
=
null
)
{
notificationManager
.
notify
(
notificationId
notificationBuilder
.
build
(
)
)
;
}
else
{
notificationManager
.
notify
(
notificationId
notificationCompatBuilder
.
build
(
)
)
;
}
}
}
catch
(
NullPointerException
e
)
{
Log
.
e
(
"
Unable
to
show
push
notification
.
"
e
)
;
}
catch
(
Throwable
t
)
{
Log
.
e
(
"
Unable
to
show
push
notification
.
"
t
)
;
Util
.
handleException
(
t
)
;
}
}
static
void
openNotification
(
Context
context
Intent
intent
)
{
Log
.
d
(
"
Opening
push
notification
action
.
"
)
;
Bundle
notification
=
preHandlePushNotification
(
context
intent
)
;
if
(
notification
=
=
null
)
{
return
;
}
if
(
isActivityWithIntentStarted
(
context
notification
)
)
{
return
;
}
Class
<
?
extends
Activity
>
callbackClass
=
LeanplumPushService
.
getCallbackClass
(
)
;
boolean
shouldStartActivity
=
true
;
Activity
currentActivity
=
LeanplumActivityHelper
.
currentActivity
;
if
(
currentActivity
!
=
null
&
&
!
LeanplumActivityHelper
.
isActivityPaused
)
{
if
(
callbackClass
=
=
null
)
{
shouldStartActivity
=
false
;
}
else
if
(
callbackClass
.
isInstance
(
currentActivity
)
)
{
shouldStartActivity
=
false
;
}
}
if
(
shouldStartActivity
)
{
Intent
actionIntent
=
getActionIntent
(
context
)
;
if
(
actionIntent
=
=
null
)
{
return
;
}
actionIntent
.
putExtras
(
notification
)
;
actionIntent
.
addFlags
(
Intent
.
FLAG_ACTIVITY_CLEAR_TOP
|
Intent
.
FLAG_ACTIVITY_NEW_TASK
)
;
context
.
startActivity
(
actionIntent
)
;
}
postHandlePushNotification
(
context
intent
)
;
}
public
static
Map
<
String
Object
>
parseNotificationBundle
(
Bundle
notificationBundle
)
{
try
{
String
notificationActions
=
notificationBundle
.
getString
(
Keys
.
PUSH_MESSAGE_ACTION
)
;
String
notificationMessage
=
notificationBundle
.
getString
(
Keys
.
PUSH_MESSAGE_TEXT
)
;
String
notificationMessageId
=
LeanplumPushService
.
getMessageId
(
notificationBundle
)
;
Map
<
String
Object
>
arguments
=
new
HashMap
<
>
(
)
;
arguments
.
put
(
LEANPLUM_ACTION_PARAM
JsonConverter
.
fromJson
(
notificationActions
)
)
;
arguments
.
put
(
LEANPLUM_MESSAGE_PARAM
notificationMessage
)
;
arguments
.
put
(
LEANPLUM_MESSAGE_ID
notificationMessageId
)
;
return
arguments
;
}
catch
(
Throwable
ignored
)
{
Log
.
i
(
"
Failed
to
parse
notification
bundle
.
"
)
;
}
return
null
;
}
public
static
Bundle
preHandlePushNotification
(
Context
context
Intent
intent
)
{
if
(
intent
=
=
null
)
{
Log
.
i
(
"
Unable
to
pre
handle
push
notification
Intent
is
null
.
"
)
;
return
null
;
}
Bundle
notification
=
intent
.
getExtras
(
)
;
if
(
notification
=
=
null
)
{
Log
.
i
(
"
Unable
to
pre
handle
push
notification
extras
are
null
.
"
)
;
return
null
;
}
return
notification
;
}
public
static
void
postHandlePushNotification
(
Context
context
Intent
intent
)
{
final
Bundle
notification
=
intent
.
getExtras
(
)
;
if
(
notification
=
=
null
)
{
Log
.
i
(
"
Could
not
post
handle
push
notification
extras
are
null
.
"
)
;
return
;
}
LeanplumActivityHelper
.
queueActionUponActive
(
new
VariablesChangedCallback
(
)
{
Override
public
void
variablesChanged
(
)
{
try
{
final
String
messageId
=
LeanplumPushService
.
getMessageId
(
notification
)
;
final
String
actionName
=
Constants
.
Values
.
DEFAULT_PUSH_ACTION
;
if
(
messageId
!
=
null
)
{
if
(
LeanplumPushService
.
areActionsEmbedded
(
notification
)
)
{
Map
<
String
Object
>
args
=
new
HashMap
<
>
(
)
;
args
.
put
(
actionName
JsonConverter
.
fromJson
(
notification
.
getString
(
Keys
.
PUSH_MESSAGE_ACTION
)
)
)
;
ActionContext
context
=
new
ActionContext
(
ActionManager
.
PUSH_NOTIFICATION_ACTION_NAME
args
messageId
)
;
context
.
preventRealtimeUpdating
(
)
;
context
.
update
(
)
;
context
.
runTrackedActionNamed
(
actionName
)
;
}
else
{
Leanplum
.
addOnceVariablesChangedAndNoDownloadsPendingHandler
(
new
VariablesChangedCallback
(
)
{
Override
public
void
variablesChanged
(
)
{
try
{
LeanplumPushService
.
requireMessageContent
(
messageId
new
VariablesChangedCallback
(
)
{
Override
public
void
variablesChanged
(
)
{
try
{
LeanplumInternal
.
performTrackedAction
(
actionName
messageId
)
;
}
catch
(
Throwable
t
)
{
Util
.
handleException
(
t
)
;
}
}
}
)
;
}
catch
(
Throwable
t
)
{
Util
.
handleException
(
t
)
;
}
}
}
)
;
}
}
}
catch
(
Throwable
t
)
{
Util
.
handleException
(
t
)
;
}
}
}
)
;
}
private
static
boolean
isActivityWithIntentStarted
(
Context
context
Bundle
notification
)
{
String
action
=
notification
.
getString
(
Keys
.
PUSH_MESSAGE_ACTION
)
;
if
(
action
!
=
null
&
&
action
.
contains
(
OPEN_URL
)
)
{
Intent
deepLinkIntent
=
getDeepLinkIntent
(
notification
)
;
if
(
deepLinkIntent
!
=
null
&
&
activityHasIntent
(
context
deepLinkIntent
)
)
{
String
messageId
=
LeanplumPushService
.
getMessageId
(
notification
)
;
if
(
messageId
!
=
null
)
{
ActionContext
actionContext
=
new
ActionContext
(
ActionManager
.
PUSH_NOTIFICATION_ACTION_NAME
null
messageId
)
;
actionContext
.
track
(
OPEN_ACTION
0
.
0
null
)
;
context
.
startActivity
(
deepLinkIntent
)
;
return
true
;
}
}
}
return
false
;
}
private
static
Intent
getDeepLinkIntent
(
Bundle
notification
)
{
try
{
String
actionString
=
notification
.
getString
(
Keys
.
PUSH_MESSAGE_ACTION
)
;
if
(
actionString
!
=
null
)
{
JSONObject
openAction
=
new
JSONObject
(
actionString
)
;
Intent
deepLinkIntent
=
new
Intent
(
Intent
.
ACTION_VIEW
Uri
.
parse
(
openAction
.
getString
(
URL
)
)
)
;
deepLinkIntent
.
setFlags
(
Intent
.
FLAG_ACTIVITY_NEW_TASK
)
;
return
deepLinkIntent
;
}
}
catch
(
JSONException
ignored
)
{
}
return
null
;
}
private
static
Boolean
activityHasIntent
(
Context
context
Intent
deepLinkIntent
)
{
List
<
ResolveInfo
>
resolveInfoList
=
context
.
getPackageManager
(
)
.
queryIntentActivities
(
deepLinkIntent
0
)
;
if
(
resolveInfoList
!
=
null
&
&
!
resolveInfoList
.
isEmpty
(
)
)
{
for
(
ResolveInfo
resolveInfo
:
resolveInfoList
)
{
if
(
resolveInfo
!
=
null
&
&
resolveInfo
.
activityInfo
!
=
null
&
&
resolveInfo
.
activityInfo
.
name
!
=
null
)
{
if
(
resolveInfo
.
activityInfo
.
name
.
contains
(
context
.
getPackageName
(
)
)
)
{
deepLinkIntent
.
setPackage
(
resolveInfo
.
activityInfo
.
packageName
)
;
return
true
;
}
}
}
}
return
false
;
}
private
static
Intent
getActionIntent
(
Context
context
)
{
Class
<
?
extends
Activity
>
callbackClass
=
LeanplumPushService
.
getCallbackClass
(
)
;
if
(
callbackClass
!
=
null
)
{
return
new
Intent
(
context
callbackClass
)
;
}
else
{
PackageManager
pm
=
context
.
getPackageManager
(
)
;
return
pm
.
getLaunchIntentForPackage
(
context
.
getPackageName
(
)
)
;
}
}
public
static
void
unregister
(
)
{
try
{
Intent
unregisterIntent
=
new
Intent
(
"
com
.
google
.
android
.
c2dm
.
intent
.
UNREGISTER
"
)
;
Context
context
=
Leanplum
.
getContext
(
)
;
unregisterIntent
.
putExtra
(
"
app
"
PendingIntent
.
getBroadcast
(
context
0
new
Intent
(
)
0
)
)
;
unregisterIntent
.
setPackage
(
"
com
.
google
.
android
.
gms
"
)
;
context
.
startService
(
unregisterIntent
)
;
}
catch
(
Throwable
t
)
{
Util
.
handleException
(
t
)
;
}
}
private
static
void
registerInBackground
(
)
{
Context
context
=
Leanplum
.
getContext
(
)
;
if
(
context
=
=
null
)
{
Log
.
e
(
"
Failed
to
register
application
with
GCM
/
FCM
.
Your
application
context
is
not
set
.
"
)
;
return
;
}
Intent
registerIntent
=
new
Intent
(
context
LeanplumPushRegistrationService
.
class
)
;
context
.
startService
(
registerIntent
)
;
}
public
static
void
setGcmRegistrationId
(
String
token
)
{
new
LeanplumManualProvider
(
Leanplum
.
getContext
(
)
.
getApplicationContext
(
)
token
)
;
}
static
void
onStart
(
)
{
try
{
if
(
Util
.
hasPlayServices
(
)
)
{
initPushService
(
)
;
}
else
{
Log
.
i
(
"
No
valid
Google
Play
Services
APK
found
.
"
)
;
}
}
catch
(
LeanplumException
e
)
{
Log
.
e
(
"
There
was
an
error
registering
for
push
notifications
.
\
n
"
+
Log
.
getStackTraceString
(
e
)
)
;
}
catch
(
Throwable
ignored
)
{
}
}
private
static
void
initPushService
(
)
{
if
(
!
enableGcmServices
(
)
)
{
Log
.
w
(
"
Failed
to
initialize
GCM
services
.
"
)
;
return
;
}
provider
=
new
LeanplumGcmProvider
(
)
;
if
(
!
provider
.
isInitialized
(
)
|
|
!
provider
.
isManifestSetup
(
)
)
{
return
;
}
if
(
hasAppIDChanged
(
Request
.
appId
(
)
)
)
{
provider
.
unregister
(
)
;
}
registerInBackground
(
)
;
}
private
static
boolean
enableGcmServices
(
)
{
Context
context
=
Leanplum
.
getContext
(
)
;
if
(
context
=
=
null
)
{
Log
.
i
(
"
Failed
to
enable
FCM
services
context
is
null
.
"
)
;
return
false
;
}
PackageManager
packageManager
=
context
.
getPackageManager
(
)
;
if
(
packageManager
=
=
null
)
{
Log
.
i
(
"
Failed
to
enable
FCM
services
PackageManager
is
null
.
"
)
;
return
false
;
}
Class
gcm
=
LeanplumManifestHelper
.
getClassForName
(
LEANPLUM_PUSH_INSTANCE_ID_SERVICE_CLASS
)
;
if
(
gcm
=
=
null
)
{
Log
.
e
(
"
Failed
to
setup
GCM
please
compile
GCM
library
.
"
)
;
return
false
;
}
if
(
!
LeanplumManifestHelper
.
wasComponentEnabled
(
context
packageManager
gcm
)
)
{
disableFcmServices
(
)
;
LeanplumManifestHelper
.
enableComponent
(
context
packageManager
gcm
)
;
Class
gcmReceiver
=
LeanplumManifestHelper
.
getClassForName
(
GCM_RECEIVER_CLASS
)
;
if
(
gcmReceiver
!
=
null
)
{
LeanplumManifestHelper
.
enableComponent
(
context
packageManager
gcmReceiver
)
;
}
Class
pushListener
=
LeanplumManifestHelper
.
getClassForName
(
LEANPLUM_PUSH_LISTENER_SERVICE_CLASS
)
;
if
(
pushListener
!
=
null
)
{
LeanplumManifestHelper
.
enableComponent
(
context
packageManager
pushListener
)
;
}
}
return
true
;
}
private
static
void
disableFcmServices
(
)
{
Context
context
=
Leanplum
.
getContext
(
)
;
if
(
context
=
=
null
)
{
return
;
}
PackageManager
packageManager
=
context
.
getPackageManager
(
)
;
if
(
packageManager
=
=
null
)
{
return
;
}
LeanplumManifestHelper
.
disableComponent
(
context
packageManager
LEANPLUM_PUSH_FCM_LISTENER_SERVICE_CLASS
)
;
LeanplumManifestHelper
.
disableComponent
(
context
packageManager
PUSH_FIREBASE_MESSAGING_SERVICE_CLASS
)
;
}
private
static
void
disableGcmServices
(
)
{
Context
context
=
Leanplum
.
getContext
(
)
;
if
(
context
=
=
null
)
{
return
;
}
PackageManager
packageManager
=
context
.
getPackageManager
(
)
;
if
(
packageManager
=
=
null
)
{
return
;
}
LeanplumManifestHelper
.
disableComponent
(
context
packageManager
LEANPLUM_PUSH_INSTANCE_ID_SERVICE_CLASS
)
;
LeanplumManifestHelper
.
disableComponent
(
context
packageManager
GCM_RECEIVER_CLASS
)
;
LeanplumManifestHelper
.
disableComponent
(
context
packageManager
LEANPLUM_PUSH_LISTENER_SERVICE_CLASS
)
;
}
private
static
boolean
hasAppIDChanged
(
String
currentAppId
)
{
if
(
currentAppId
=
=
null
)
{
return
false
;
}
Context
context
=
Leanplum
.
getContext
(
)
;
if
(
context
=
=
null
)
{
return
false
;
}
String
storedAppId
=
SharedPreferencesUtil
.
getString
(
context
Constants
.
Defaults
.
LEANPLUM_PUSH
Constants
.
Defaults
.
APP_ID
)
;
if
(
!
currentAppId
.
equals
(
storedAppId
)
)
{
Log
.
v
(
"
Saving
the
application
id
in
the
shared
preferences
.
"
)
;
SharedPreferencesUtil
.
setString
(
context
Constants
.
Defaults
.
LEANPLUM_PUSH
Constants
.
Defaults
.
APP_ID
currentAppId
)
;
if
(
!
SharedPreferencesUtil
.
DEFAULT_STRING_VALUE
.
equals
(
storedAppId
)
)
{
return
true
;
}
}
return
false
;
}
}
