package
org
.
mozilla
.
geckoview
.
test
import
androidx
.
test
.
ext
.
junit
.
runners
.
AndroidJUnit4
import
androidx
.
test
.
filters
.
MediumTest
import
junit
.
framework
.
TestCase
.
assertTrue
import
org
.
junit
.
Before
import
org
.
junit
.
Test
import
org
.
junit
.
runner
.
RunWith
import
org
.
mozilla
.
geckoview
.
GeckoSession
import
org
.
mozilla
.
geckoview
.
TranslationsController
import
org
.
mozilla
.
geckoview
.
TranslationsController
.
Language
import
org
.
mozilla
.
geckoview
.
TranslationsController
.
RuntimeTranslation
.
DOWNLOAD
import
org
.
mozilla
.
geckoview
.
TranslationsController
.
RuntimeTranslation
.
ModelManagementOptions
import
org
.
mozilla
.
geckoview
.
TranslationsController
.
SessionTranslation
.
Delegate
import
org
.
mozilla
.
geckoview
.
TranslationsController
.
SessionTranslation
.
TranslationOptions
import
org
.
mozilla
.
geckoview
.
TranslationsController
.
SessionTranslation
.
TranslationState
import
org
.
mozilla
.
geckoview
.
test
.
rule
.
GeckoSessionTestRule
.
AssertCalled
RunWith
(
AndroidJUnit4
:
:
class
)
MediumTest
class
TranslationsTest
:
BaseSessionTest
(
)
{
Before
fun
setup
(
)
{
sessionRule
.
setPrefsUntilTestEnd
(
mapOf
(
"
browser
.
translations
.
enable
"
to
true
"
browser
.
translations
.
automaticallyPopup
"
to
true
"
intl
.
accept_languages
"
to
"
fr
-
CA
it
de
"
)
)
}
private
var
expectedLanguages
:
List
<
TranslationsController
.
Language
>
=
listOf
(
Language
(
"
bg
"
"
Bulgarian
"
)
Language
(
"
nl
"
"
Dutch
"
)
Language
(
"
en
"
"
English
"
)
Language
(
"
fr
"
"
French
"
)
Language
(
"
de
"
"
German
"
)
Language
(
"
it
"
"
Italian
"
)
Language
(
"
pl
"
"
Polish
"
)
Language
(
"
pt
"
"
Portuguese
"
)
Language
(
"
es
"
"
Spanish
"
)
)
Test
fun
onExpectedTranslateDelegateTest
(
)
{
sessionRule
.
delegateDuringNextWait
(
object
:
Delegate
{
AssertCalled
(
count
=
0
)
override
fun
onExpectedTranslate
(
session
:
GeckoSession
)
{
}
}
)
mainSession
.
loadTestPath
(
TRANSLATIONS_ES
)
mainSession
.
waitForPageStop
(
)
}
Test
fun
onOfferTranslateDelegateTest
(
)
{
sessionRule
.
delegateDuringNextWait
(
object
:
Delegate
{
AssertCalled
(
count
=
0
)
override
fun
onOfferTranslate
(
session
:
GeckoSession
)
{
}
}
)
mainSession
.
loadTestPath
(
TRANSLATIONS_ES
)
mainSession
.
waitForPageStop
(
)
}
Test
fun
onTranslationStateChangeDelegateTest
(
)
{
sessionRule
.
delegateDuringNextWait
(
object
:
Delegate
{
AssertCalled
(
count
=
1
)
override
fun
onTranslationStateChange
(
session
:
GeckoSession
translationState
:
TranslationState
?
)
{
assertTrue
(
"
Translations
correctly
does
not
have
an
engine
ready
.
"
translationState
?
.
isEngineReady
=
=
false
)
assertTrue
(
"
Translations
correctly
does
not
have
a
requested
pair
.
"
translationState
?
.
requestedTranslationPair
=
=
null
)
}
}
)
mainSession
.
loadTestPath
(
TRANSLATIONS_ES
)
mainSession
.
waitForPageStop
(
)
}
Test
fun
translateTest
(
)
{
sessionRule
.
delegateUntilTestEnd
(
object
:
Delegate
{
AssertCalled
(
count
=
1
)
override
fun
onTranslationStateChange
(
session
:
GeckoSession
translationState
:
TranslationState
?
)
{
assertTrue
(
"
Translations
correctly
does
not
have
an
engine
ready
.
"
translationState
?
.
isEngineReady
=
=
false
)
assertTrue
(
"
Translations
correctly
does
not
have
a
requested
pair
.
"
translationState
?
.
requestedTranslationPair
=
=
null
)
}
}
)
mainSession
.
loadTestPath
(
TRANSLATIONS_ES
)
mainSession
.
waitForPageStop
(
)
val
translate
=
mainSession
.
sessionTranslation
!
!
.
translate
(
"
es
"
"
en
"
null
)
try
{
sessionRule
.
waitForResult
(
translate
)
assertTrue
(
"
Should
not
be
able
to
translate
.
"
false
)
}
catch
(
e
:
Exception
)
{
assertTrue
(
"
Should
have
an
exception
.
"
true
)
}
}
Test
fun
restoreOriginalPageLanguageTest
(
)
{
sessionRule
.
delegateUntilTestEnd
(
object
:
Delegate
{
AssertCalled
(
count
=
2
)
override
fun
onTranslationStateChange
(
session
:
GeckoSession
translationState
:
TranslationState
?
)
{
assertTrue
(
"
Translations
correctly
does
not
have
an
engine
ready
.
"
translationState
?
.
isEngineReady
=
=
false
)
assertTrue
(
"
Translations
correctly
does
not
have
a
requested
pair
.
"
translationState
?
.
requestedTranslationPair
=
=
null
)
}
}
)
mainSession
.
loadTestPath
(
TRANSLATIONS_ES
)
mainSession
.
waitForPageStop
(
)
val
restore
=
mainSession
.
sessionTranslation
!
!
.
restoreOriginalPage
(
)
try
{
sessionRule
.
waitForResult
(
restore
)
assertTrue
(
"
Should
be
able
to
restore
.
"
true
)
}
catch
(
e
:
Exception
)
{
assertTrue
(
"
Should
not
have
an
exception
.
"
false
)
}
}
Test
fun
testTranslationOptions
(
)
{
var
options
=
TranslationOptions
.
Builder
(
)
.
downloadModel
(
true
)
.
build
(
)
assertTrue
(
"
TranslationOptions
builder
options
work
as
expected
.
"
options
.
downloadModel
)
}
Test
fun
testIsTranslationsEngineSupported
(
)
{
sessionRule
.
setPrefsUntilTestEnd
(
mapOf
(
"
browser
.
translations
.
simulateUnsupportedEngine
"
to
false
)
)
val
isSupportedResult
=
TranslationsController
.
RuntimeTranslation
.
isTranslationsEngineSupported
(
)
assertTrue
(
"
The
translations
engine
is
correctly
reporting
as
supported
.
"
sessionRule
.
waitForResult
(
isSupportedResult
)
)
}
Test
fun
testGetPreferredLanguage
(
)
{
val
preferredLanguages
=
TranslationsController
.
RuntimeTranslation
.
preferredLanguages
(
)
sessionRule
.
waitForResult
(
preferredLanguages
)
.
let
{
languages
-
>
assertTrue
(
"
French
is
the
first
language
preference
.
"
languages
[
0
]
=
=
"
fr
"
)
assertTrue
(
"
Italian
is
the
second
language
preference
.
"
languages
[
1
]
=
=
"
it
"
)
assertTrue
(
"
German
is
the
third
language
preference
.
"
languages
[
2
]
=
=
"
de
"
)
}
}
Test
fun
testManageLanguageModel
(
)
{
val
options
=
ModelManagementOptions
.
Builder
(
)
.
languageToManage
(
"
en
"
)
.
operation
(
TranslationsController
.
RuntimeTranslation
.
DOWNLOAD
)
.
build
(
)
assertTrue
(
"
ModelManagementOptions
builder
options
work
as
expected
.
"
options
.
language
=
=
"
en
"
&
&
options
.
operation
=
=
DOWNLOAD
)
}
Test
fun
testListSupportedLanguages
(
)
{
val
translationDropdowns
=
TranslationsController
.
RuntimeTranslation
.
listSupportedLanguages
(
)
try
{
sessionRule
.
waitForResult
(
translationDropdowns
)
assertTrue
(
"
Should
not
be
able
to
list
supported
languages
.
"
false
)
}
catch
(
e
:
Exception
)
{
assertTrue
(
"
Should
have
an
exception
.
"
true
)
}
}
Test
fun
testListModelDownloadStates
(
)
{
var
modelStatesResult
=
TranslationsController
.
RuntimeTranslation
.
listModelDownloadStates
(
)
try
{
sessionRule
.
waitForResult
(
modelStatesResult
)
assertTrue
(
"
Should
not
be
able
to
list
models
.
"
false
)
}
catch
(
e
:
Exception
)
{
assertTrue
(
"
Should
have
an
exception
.
"
true
)
}
}
}
