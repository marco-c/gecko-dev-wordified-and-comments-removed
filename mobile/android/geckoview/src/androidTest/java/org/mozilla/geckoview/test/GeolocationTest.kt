package
org
.
mozilla
.
geckoview
.
test
import
android
.
content
.
Context
import
android
.
content
.
Intent
import
android
.
location
.
LocationManager
import
android
.
os
.
Handler
import
android
.
os
.
Looper
import
androidx
.
lifecycle
.
*
import
androidx
.
test
.
ext
.
junit
.
rules
.
ActivityScenarioRule
import
androidx
.
test
.
ext
.
junit
.
runners
.
AndroidJUnit4
import
androidx
.
test
.
filters
.
LargeTest
import
androidx
.
test
.
platform
.
app
.
InstrumentationRegistry
import
org
.
hamcrest
.
CoreMatchers
.
equalTo
import
org
.
json
.
JSONObject
import
org
.
junit
.
After
import
org
.
junit
.
Before
import
org
.
junit
.
Rule
import
org
.
junit
.
Test
import
org
.
junit
.
rules
.
RuleChain
import
org
.
junit
.
runner
.
RunWith
import
org
.
mozilla
.
geckoview
.
Autofill
import
org
.
mozilla
.
geckoview
.
GeckoResult
import
org
.
mozilla
.
geckoview
.
GeckoSession
import
org
.
mozilla
.
geckoview
.
test
.
rule
.
GeckoSessionTestRule
RunWith
(
AndroidJUnit4
:
:
class
)
LargeTest
class
GeolocationTest
:
BaseSessionTest
(
)
{
private
val
activityRule
=
ActivityScenarioRule
(
GeckoViewTestActivity
:
:
class
.
java
)
private
val
locProvider
=
"
mockTestLocationProvider
"
;
private
val
context
=
InstrumentationRegistry
.
getInstrumentation
(
)
.
targetContext
private
lateinit
var
locManager
:
LocationManager
get
:
Rule
override
val
rules
:
RuleChain
=
RuleChain
.
outerRule
(
activityRule
)
.
around
(
sessionRule
)
Before
fun
setup
(
)
{
activityRule
.
scenario
.
onActivity
{
activity
-
>
activity
.
view
.
setSession
(
mainSession
)
sessionRule
.
setPrefsUntilTestEnd
(
mapOf
(
"
geo
.
provider
.
testing
"
to
false
)
)
locManager
=
activity
.
getSystemService
(
Context
.
LOCATION_SERVICE
)
as
LocationManager
sessionRule
.
addMockLocationProvider
(
locManager
locProvider
)
}
}
After
fun
cleanup
(
)
{
try
{
activityRule
.
scenario
.
onActivity
{
activity
-
>
activity
.
view
.
releaseSession
(
)
}
}
catch
(
e
:
Exception
)
{
}
}
private
fun
setEnableLocationPermissions
(
)
{
sessionRule
.
delegateDuringNextWait
(
object
:
GeckoSession
.
PermissionDelegate
{
override
fun
onContentPermissionRequest
(
session
:
GeckoSession
perm
:
GeckoSession
.
PermissionDelegate
.
ContentPermission
)
:
GeckoResult
<
Int
>
{
return
GeckoResult
.
fromValue
(
GeckoSession
.
PermissionDelegate
.
ContentPermission
.
VALUE_ALLOW
)
}
override
fun
onAndroidPermissionsRequest
(
session
:
GeckoSession
permissions
:
Array
<
out
String
>
?
callback
:
GeckoSession
.
PermissionDelegate
.
Callback
)
{
callback
.
grant
(
)
}
}
)
}
private
fun
getCurrentPositionJS
(
)
:
JSONObject
{
return
mainSession
.
evaluatePromiseJS
(
"
"
"
new
Promise
(
(
resolve
reject
)
=
>
window
.
navigator
.
geolocation
.
getCurrentPosition
(
position
=
>
resolve
(
{
latitude
:
position
.
coords
.
latitude
longitude
:
position
.
coords
.
longitude
}
)
)
error
=
>
reject
(
error
.
code
)
)
"
"
"
)
.
value
as
JSONObject
}
private
fun
getCurrentPositionJSWithWait
(
)
:
JSONObject
{
return
mainSession
.
evaluatePromiseJS
(
"
"
"
new
Promise
(
(
resolve
reject
)
=
>
setTimeout
(
(
)
=
>
{
window
.
navigator
.
geolocation
.
getCurrentPosition
(
position
=
>
resolve
(
{
latitude
:
position
.
coords
.
latitude
longitude
:
position
.
coords
.
longitude
}
)
)
error
=
>
reject
(
error
.
code
)
}
"
750
"
)
)
"
"
"
)
.
value
as
JSONObject
}
GeckoSessionTestRule
.
NullDelegate
(
Autofill
.
Delegate
:
:
class
)
Test
fun
jsContentRequestForLocation
(
)
{
val
mockLat
=
1
.
1111
val
mockLon
=
2
.
2222
sessionRule
.
setMockLocation
(
locManager
locProvider
mockLat
mockLon
)
mainSession
.
loadTestPath
(
HELLO_HTML_PATH
)
mainSession
.
waitForPageStop
(
)
setEnableLocationPermissions
(
)
val
position
=
getCurrentPositionJS
(
)
assertThat
(
"
Mocked
latitude
matches
.
"
position
[
"
latitude
"
]
as
Number
equalTo
(
mockLat
)
)
assertThat
(
"
Mocked
longitude
matches
.
"
position
[
"
longitude
"
]
as
Number
equalTo
(
mockLon
)
)
}
GeckoSessionTestRule
.
NullDelegate
(
Autofill
.
Delegate
:
:
class
)
Test
fun
locationOnBackground
(
)
{
val
beforePauseLat
=
1
.
1111
val
beforePauseLon
=
2
.
2222
val
afterPauseLat
=
3
.
3333
val
afterPauseLon
=
4
.
4444
sessionRule
.
setMockLocation
(
locManager
locProvider
beforePauseLat
beforePauseLon
)
mainSession
.
loadTestPath
(
HELLO_HTML_PATH
)
mainSession
.
waitForPageStop
(
)
setEnableLocationPermissions
(
)
var
actualResumeCount
=
0
var
actualPauseCount
=
0
ProcessLifecycleOwner
.
get
(
)
.
lifecycle
.
addObserver
(
object
:
DefaultLifecycleObserver
{
override
fun
onResume
(
owner
:
LifecycleOwner
)
{
actualResumeCount
+
+
;
super
.
onResume
(
owner
)
try
{
mainSession
.
setActive
(
true
)
if
(
actualResumeCount
>
1
)
{
val
onResumeFromPausePosition
=
getCurrentPositionJS
(
)
assertThat
(
"
Latitude
after
onPause
matches
.
"
onResumeFromPausePosition
[
"
latitude
"
]
as
Number
equalTo
(
afterPauseLat
)
)
assertThat
(
"
Longitude
after
onPause
matches
.
"
onResumeFromPausePosition
[
"
longitude
"
]
as
Number
equalTo
(
afterPauseLon
)
)
}
}
catch
(
e
:
Exception
)
{
assertThat
(
"
onResume
count
matches
.
"
actualResumeCount
equalTo
(
2
)
)
assertThat
(
"
onPause
count
matches
.
"
actualPauseCount
equalTo
(
1
)
)
try
{
sessionRule
.
removeMockLocationProvider
(
locManager
locProvider
)
}
catch
(
e
:
Exception
)
{
}
}
}
override
fun
onPause
(
owner
:
LifecycleOwner
)
{
actualPauseCount
+
+
;
super
.
onPause
(
owner
)
try
{
sessionRule
.
setMockLocation
(
locManager
locProvider
afterPauseLat
afterPauseLon
)
}
catch
(
e
:
Exception
)
{
}
}
}
)
val
beforeOnPausePosition
=
getCurrentPositionJS
(
)
assertThat
(
"
Latitude
before
onPause
matches
.
"
beforeOnPausePosition
[
"
latitude
"
]
as
Number
equalTo
(
beforePauseLat
)
)
assertThat
(
"
Longitude
before
onPause
matches
.
"
beforeOnPausePosition
[
"
longitude
"
]
as
Number
equalTo
(
beforePauseLon
)
)
Handler
(
Looper
.
getMainLooper
(
)
)
.
postDelayed
(
{
sessionRule
.
requestActivityToForeground
(
context
)
}
1500
)
sessionRule
.
simulatePressHome
(
context
)
val
whilePausingPosition
=
getCurrentPositionJSWithWait
(
)
assertThat
(
"
Longitude
after
/
during
onPause
matches
.
"
whilePausingPosition
[
"
latitude
"
]
as
Number
equalTo
(
afterPauseLat
)
)
assertThat
(
"
Longitude
after
/
during
onPause
matches
.
"
whilePausingPosition
[
"
longitude
"
]
as
Number
equalTo
(
afterPauseLon
)
)
assertThat
(
"
onResume
count
matches
.
"
actualResumeCount
equalTo
(
2
)
)
assertThat
(
"
onPause
count
matches
.
"
actualPauseCount
equalTo
(
1
)
)
}
}
