package
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
source
.
chunk
;
import
androidx
.
annotation
.
Nullable
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
C
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
Format
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
extractor
.
DefaultExtractorInput
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
extractor
.
Extractor
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
extractor
.
ExtractorInput
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
extractor
.
PositionHolder
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
source
.
chunk
.
ChunkExtractorWrapper
.
TrackOutputProvider
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
upstream
.
DataSource
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
upstream
.
DataSpec
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
util
.
Assertions
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
util
.
Util
;
import
java
.
io
.
IOException
;
import
org
.
checkerframework
.
checker
.
nullness
.
qual
.
MonotonicNonNull
;
public
final
class
InitializationChunk
extends
Chunk
{
private
static
final
PositionHolder
DUMMY_POSITION_HOLDER
=
new
PositionHolder
(
)
;
private
final
ChunkExtractorWrapper
extractorWrapper
;
MonotonicNonNull
private
TrackOutputProvider
trackOutputProvider
;
private
long
nextLoadPosition
;
private
volatile
boolean
loadCanceled
;
public
InitializationChunk
(
DataSource
dataSource
DataSpec
dataSpec
Format
trackFormat
int
trackSelectionReason
Nullable
Object
trackSelectionData
ChunkExtractorWrapper
extractorWrapper
)
{
super
(
dataSource
dataSpec
C
.
DATA_TYPE_MEDIA_INITIALIZATION
trackFormat
trackSelectionReason
trackSelectionData
C
.
TIME_UNSET
C
.
TIME_UNSET
)
;
this
.
extractorWrapper
=
extractorWrapper
;
}
public
void
init
(
TrackOutputProvider
trackOutputProvider
)
{
this
.
trackOutputProvider
=
trackOutputProvider
;
}
Override
public
void
cancelLoad
(
)
{
loadCanceled
=
true
;
}
SuppressWarnings
(
"
NonAtomicVolatileUpdate
"
)
Override
public
void
load
(
)
throws
IOException
InterruptedException
{
if
(
nextLoadPosition
=
=
0
)
{
extractorWrapper
.
init
(
trackOutputProvider
C
.
TIME_UNSET
C
.
TIME_UNSET
)
;
}
try
{
DataSpec
loadDataSpec
=
dataSpec
.
subrange
(
nextLoadPosition
)
;
ExtractorInput
input
=
new
DefaultExtractorInput
(
dataSource
loadDataSpec
.
absoluteStreamPosition
dataSource
.
open
(
loadDataSpec
)
)
;
try
{
Extractor
extractor
=
extractorWrapper
.
extractor
;
int
result
=
Extractor
.
RESULT_CONTINUE
;
while
(
result
=
=
Extractor
.
RESULT_CONTINUE
&
&
!
loadCanceled
)
{
result
=
extractor
.
read
(
input
DUMMY_POSITION_HOLDER
)
;
}
Assertions
.
checkState
(
result
!
=
Extractor
.
RESULT_SEEK
)
;
}
finally
{
nextLoadPosition
=
input
.
getPosition
(
)
-
dataSpec
.
absoluteStreamPosition
;
}
}
finally
{
Util
.
closeQuietly
(
dataSource
)
;
}
}
}
