package
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
metadata
;
import
android
.
os
.
Handler
;
import
android
.
os
.
Handler
.
Callback
;
import
android
.
os
.
Looper
;
import
android
.
os
.
Message
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
BaseRenderer
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
C
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
ExoPlaybackException
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
Format
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
FormatHolder
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
util
.
Assertions
;
import
java
.
util
.
Arrays
;
public
final
class
MetadataRenderer
extends
BaseRenderer
implements
Callback
{
public
interface
Output
{
void
onMetadata
(
Metadata
metadata
)
;
}
private
static
final
int
MSG_INVOKE_RENDERER
=
0
;
private
static
final
int
MAX_PENDING_METADATA_COUNT
=
5
;
private
final
MetadataDecoderFactory
decoderFactory
;
private
final
Output
output
;
private
final
Handler
outputHandler
;
private
final
FormatHolder
formatHolder
;
private
final
MetadataInputBuffer
buffer
;
private
final
Metadata
[
]
pendingMetadata
;
private
final
long
[
]
pendingMetadataTimestamps
;
private
int
pendingMetadataIndex
;
private
int
pendingMetadataCount
;
private
MetadataDecoder
decoder
;
private
boolean
inputStreamEnded
;
public
MetadataRenderer
(
Output
output
Looper
outputLooper
)
{
this
(
output
outputLooper
MetadataDecoderFactory
.
DEFAULT
)
;
}
public
MetadataRenderer
(
Output
output
Looper
outputLooper
MetadataDecoderFactory
decoderFactory
)
{
super
(
C
.
TRACK_TYPE_METADATA
)
;
this
.
output
=
Assertions
.
checkNotNull
(
output
)
;
this
.
outputHandler
=
outputLooper
=
=
null
?
null
:
new
Handler
(
outputLooper
this
)
;
this
.
decoderFactory
=
Assertions
.
checkNotNull
(
decoderFactory
)
;
formatHolder
=
new
FormatHolder
(
)
;
buffer
=
new
MetadataInputBuffer
(
)
;
pendingMetadata
=
new
Metadata
[
MAX_PENDING_METADATA_COUNT
]
;
pendingMetadataTimestamps
=
new
long
[
MAX_PENDING_METADATA_COUNT
]
;
}
Override
public
int
supportsFormat
(
Format
format
)
{
return
decoderFactory
.
supportsFormat
(
format
)
?
FORMAT_HANDLED
:
FORMAT_UNSUPPORTED_TYPE
;
}
Override
protected
void
onStreamChanged
(
Format
[
]
formats
)
throws
ExoPlaybackException
{
decoder
=
decoderFactory
.
createDecoder
(
formats
[
0
]
)
;
}
Override
protected
void
onPositionReset
(
long
positionUs
boolean
joining
)
{
flushPendingMetadata
(
)
;
inputStreamEnded
=
false
;
}
Override
public
void
render
(
long
positionUs
long
elapsedRealtimeUs
)
throws
ExoPlaybackException
{
if
(
!
inputStreamEnded
&
&
pendingMetadataCount
<
MAX_PENDING_METADATA_COUNT
)
{
buffer
.
clear
(
)
;
int
result
=
readSource
(
formatHolder
buffer
false
)
;
if
(
result
=
=
C
.
RESULT_BUFFER_READ
)
{
if
(
buffer
.
isEndOfStream
(
)
)
{
inputStreamEnded
=
true
;
}
else
if
(
buffer
.
isDecodeOnly
(
)
)
{
}
else
{
buffer
.
subsampleOffsetUs
=
formatHolder
.
format
.
subsampleOffsetUs
;
buffer
.
flip
(
)
;
try
{
int
index
=
(
pendingMetadataIndex
+
pendingMetadataCount
)
%
MAX_PENDING_METADATA_COUNT
;
pendingMetadata
[
index
]
=
decoder
.
decode
(
buffer
)
;
pendingMetadataTimestamps
[
index
]
=
buffer
.
timeUs
;
pendingMetadataCount
+
+
;
}
catch
(
MetadataDecoderException
e
)
{
throw
ExoPlaybackException
.
createForRenderer
(
e
getIndex
(
)
)
;
}
}
}
}
if
(
pendingMetadataCount
>
0
&
&
pendingMetadataTimestamps
[
pendingMetadataIndex
]
<
=
positionUs
)
{
invokeRenderer
(
pendingMetadata
[
pendingMetadataIndex
]
)
;
pendingMetadata
[
pendingMetadataIndex
]
=
null
;
pendingMetadataIndex
=
(
pendingMetadataIndex
+
1
)
%
MAX_PENDING_METADATA_COUNT
;
pendingMetadataCount
-
-
;
}
}
Override
protected
void
onDisabled
(
)
{
flushPendingMetadata
(
)
;
decoder
=
null
;
super
.
onDisabled
(
)
;
}
Override
public
boolean
isEnded
(
)
{
return
inputStreamEnded
;
}
Override
public
boolean
isReady
(
)
{
return
true
;
}
private
void
invokeRenderer
(
Metadata
metadata
)
{
if
(
outputHandler
!
=
null
)
{
outputHandler
.
obtainMessage
(
MSG_INVOKE_RENDERER
metadata
)
.
sendToTarget
(
)
;
}
else
{
invokeRendererInternal
(
metadata
)
;
}
}
private
void
flushPendingMetadata
(
)
{
Arrays
.
fill
(
pendingMetadata
null
)
;
pendingMetadataIndex
=
0
;
pendingMetadataCount
=
0
;
}
SuppressWarnings
(
"
unchecked
"
)
Override
public
boolean
handleMessage
(
Message
msg
)
{
switch
(
msg
.
what
)
{
case
MSG_INVOKE_RENDERER
:
invokeRendererInternal
(
(
Metadata
)
msg
.
obj
)
;
return
true
;
default
:
throw
new
IllegalStateException
(
)
;
}
}
private
void
invokeRendererInternal
(
Metadata
metadata
)
{
output
.
onMetadata
(
metadata
)
;
}
}
