package
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
source
.
hls
;
import
android
.
net
.
Uri
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
C
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
upstream
.
DataSource
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
upstream
.
DataSourceInputStream
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
upstream
.
DataSpec
;
import
org
.
mozilla
.
thirdparty
.
com
.
google
.
android
.
exoplayer2
.
util
.
Assertions
;
import
java
.
io
.
IOException
;
import
java
.
security
.
InvalidAlgorithmParameterException
;
import
java
.
security
.
InvalidKeyException
;
import
java
.
security
.
Key
;
import
java
.
security
.
NoSuchAlgorithmException
;
import
java
.
security
.
spec
.
AlgorithmParameterSpec
;
import
javax
.
crypto
.
Cipher
;
import
javax
.
crypto
.
CipherInputStream
;
import
javax
.
crypto
.
NoSuchPaddingException
;
import
javax
.
crypto
.
spec
.
IvParameterSpec
;
import
javax
.
crypto
.
spec
.
SecretKeySpec
;
final
class
Aes128DataSource
implements
DataSource
{
private
final
DataSource
upstream
;
private
final
byte
[
]
encryptionKey
;
private
final
byte
[
]
encryptionIv
;
private
CipherInputStream
cipherInputStream
;
public
Aes128DataSource
(
DataSource
upstream
byte
[
]
encryptionKey
byte
[
]
encryptionIv
)
{
this
.
upstream
=
upstream
;
this
.
encryptionKey
=
encryptionKey
;
this
.
encryptionIv
=
encryptionIv
;
}
Override
public
long
open
(
DataSpec
dataSpec
)
throws
IOException
{
Cipher
cipher
;
try
{
cipher
=
Cipher
.
getInstance
(
"
AES
/
CBC
/
PKCS7Padding
"
)
;
}
catch
(
NoSuchAlgorithmException
|
NoSuchPaddingException
e
)
{
throw
new
RuntimeException
(
e
)
;
}
Key
cipherKey
=
new
SecretKeySpec
(
encryptionKey
"
AES
"
)
;
AlgorithmParameterSpec
cipherIV
=
new
IvParameterSpec
(
encryptionIv
)
;
try
{
cipher
.
init
(
Cipher
.
DECRYPT_MODE
cipherKey
cipherIV
)
;
}
catch
(
InvalidKeyException
|
InvalidAlgorithmParameterException
e
)
{
throw
new
RuntimeException
(
e
)
;
}
cipherInputStream
=
new
CipherInputStream
(
new
DataSourceInputStream
(
upstream
dataSpec
)
cipher
)
;
return
C
.
LENGTH_UNSET
;
}
Override
public
void
close
(
)
throws
IOException
{
cipherInputStream
=
null
;
upstream
.
close
(
)
;
}
Override
public
int
read
(
byte
[
]
buffer
int
offset
int
readLength
)
throws
IOException
{
Assertions
.
checkState
(
cipherInputStream
!
=
null
)
;
int
bytesRead
=
cipherInputStream
.
read
(
buffer
offset
readLength
)
;
if
(
bytesRead
<
0
)
{
return
C
.
RESULT_END_OF_INPUT
;
}
return
bytesRead
;
}
Override
public
Uri
getUri
(
)
{
return
upstream
.
getUri
(
)
;
}
}
