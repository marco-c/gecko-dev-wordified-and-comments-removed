package
com
.
google
.
android
.
exoplayer2
.
upstream
;
import
android
.
net
.
Uri
;
import
com
.
google
.
android
.
exoplayer2
.
C
;
import
com
.
google
.
android
.
exoplayer2
.
ParserException
;
import
com
.
google
.
android
.
exoplayer2
.
upstream
.
Loader
.
Loadable
;
import
com
.
google
.
android
.
exoplayer2
.
util
.
Util
;
import
java
.
io
.
IOException
;
import
java
.
io
.
InputStream
;
public
final
class
ParsingLoadable
<
T
>
implements
Loadable
{
public
interface
Parser
<
T
>
{
T
parse
(
Uri
uri
InputStream
inputStream
)
throws
IOException
;
}
public
final
DataSpec
dataSpec
;
public
final
int
type
;
private
final
DataSource
dataSource
;
private
final
Parser
<
?
extends
T
>
parser
;
private
volatile
T
result
;
private
volatile
boolean
isCanceled
;
private
volatile
long
bytesLoaded
;
public
ParsingLoadable
(
DataSource
dataSource
Uri
uri
int
type
Parser
<
?
extends
T
>
parser
)
{
this
.
dataSource
=
dataSource
;
this
.
dataSpec
=
new
DataSpec
(
uri
DataSpec
.
FLAG_ALLOW_GZIP
)
;
this
.
type
=
type
;
this
.
parser
=
parser
;
}
public
final
T
getResult
(
)
{
return
result
;
}
public
long
bytesLoaded
(
)
{
return
bytesLoaded
;
}
Override
public
final
void
cancelLoad
(
)
{
isCanceled
=
true
;
}
Override
public
final
boolean
isLoadCanceled
(
)
{
return
isCanceled
;
}
Override
public
final
void
load
(
)
throws
IOException
InterruptedException
{
DataSourceInputStream
inputStream
=
new
DataSourceInputStream
(
dataSource
dataSpec
)
;
try
{
inputStream
.
open
(
)
;
result
=
parser
.
parse
(
dataSource
.
getUri
(
)
inputStream
)
;
}
finally
{
bytesLoaded
=
inputStream
.
bytesRead
(
)
;
Util
.
closeQuietly
(
inputStream
)
;
}
}
}
