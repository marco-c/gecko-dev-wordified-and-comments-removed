package
com
.
google
.
android
.
exoplayer2
.
drm
;
import
android
.
media
.
MediaDrm
;
import
android
.
os
.
ConditionVariable
;
import
android
.
os
.
Handler
;
import
android
.
os
.
HandlerThread
;
import
android
.
util
.
Pair
;
import
com
.
google
.
android
.
exoplayer2
.
C
;
import
com
.
google
.
android
.
exoplayer2
.
drm
.
DefaultDrmSessionManager
.
EventListener
;
import
com
.
google
.
android
.
exoplayer2
.
drm
.
DefaultDrmSessionManager
.
Mode
;
import
com
.
google
.
android
.
exoplayer2
.
drm
.
DrmSession
.
DrmSessionException
;
import
com
.
google
.
android
.
exoplayer2
.
upstream
.
HttpDataSource
;
import
com
.
google
.
android
.
exoplayer2
.
upstream
.
HttpDataSource
.
Factory
;
import
com
.
google
.
android
.
exoplayer2
.
util
.
Assertions
;
import
java
.
io
.
IOException
;
import
java
.
util
.
HashMap
;
public
final
class
OfflineLicenseHelper
<
T
extends
ExoMediaCrypto
>
{
private
final
ConditionVariable
conditionVariable
;
private
final
DefaultDrmSessionManager
<
T
>
drmSessionManager
;
private
final
HandlerThread
handlerThread
;
public
static
OfflineLicenseHelper
<
FrameworkMediaCrypto
>
newWidevineInstance
(
String
licenseUrl
Factory
httpDataSourceFactory
)
throws
UnsupportedDrmException
{
return
newWidevineInstance
(
new
HttpMediaDrmCallback
(
licenseUrl
httpDataSourceFactory
)
null
)
;
}
public
static
OfflineLicenseHelper
<
FrameworkMediaCrypto
>
newWidevineInstance
(
MediaDrmCallback
callback
HashMap
<
String
String
>
optionalKeyRequestParameters
)
throws
UnsupportedDrmException
{
return
new
OfflineLicenseHelper
<
>
(
FrameworkMediaDrm
.
newInstance
(
C
.
WIDEVINE_UUID
)
callback
optionalKeyRequestParameters
)
;
}
public
OfflineLicenseHelper
(
ExoMediaDrm
<
T
>
mediaDrm
MediaDrmCallback
callback
HashMap
<
String
String
>
optionalKeyRequestParameters
)
{
handlerThread
=
new
HandlerThread
(
"
OfflineLicenseHelper
"
)
;
handlerThread
.
start
(
)
;
conditionVariable
=
new
ConditionVariable
(
)
;
EventListener
eventListener
=
new
EventListener
(
)
{
Override
public
void
onDrmKeysLoaded
(
)
{
conditionVariable
.
open
(
)
;
}
Override
public
void
onDrmSessionManagerError
(
Exception
e
)
{
conditionVariable
.
open
(
)
;
}
Override
public
void
onDrmKeysRestored
(
)
{
conditionVariable
.
open
(
)
;
}
Override
public
void
onDrmKeysRemoved
(
)
{
conditionVariable
.
open
(
)
;
}
}
;
drmSessionManager
=
new
DefaultDrmSessionManager
<
>
(
C
.
WIDEVINE_UUID
mediaDrm
callback
optionalKeyRequestParameters
new
Handler
(
handlerThread
.
getLooper
(
)
)
eventListener
)
;
}
public
void
release
(
)
{
handlerThread
.
quit
(
)
;
}
public
synchronized
byte
[
]
downloadLicense
(
DrmInitData
drmInitData
)
throws
IOException
InterruptedException
DrmSessionException
{
Assertions
.
checkArgument
(
drmInitData
!
=
null
)
;
return
blockingKeyRequest
(
DefaultDrmSessionManager
.
MODE_DOWNLOAD
null
drmInitData
)
;
}
public
synchronized
byte
[
]
renewLicense
(
byte
[
]
offlineLicenseKeySetId
)
throws
DrmSessionException
{
Assertions
.
checkNotNull
(
offlineLicenseKeySetId
)
;
return
blockingKeyRequest
(
DefaultDrmSessionManager
.
MODE_DOWNLOAD
offlineLicenseKeySetId
null
)
;
}
public
synchronized
void
releaseLicense
(
byte
[
]
offlineLicenseKeySetId
)
throws
DrmSessionException
{
Assertions
.
checkNotNull
(
offlineLicenseKeySetId
)
;
blockingKeyRequest
(
DefaultDrmSessionManager
.
MODE_RELEASE
offlineLicenseKeySetId
null
)
;
}
public
synchronized
Pair
<
Long
Long
>
getLicenseDurationRemainingSec
(
byte
[
]
offlineLicenseKeySetId
)
throws
DrmSessionException
{
Assertions
.
checkNotNull
(
offlineLicenseKeySetId
)
;
DrmSession
<
T
>
drmSession
=
openBlockingKeyRequest
(
DefaultDrmSessionManager
.
MODE_QUERY
offlineLicenseKeySetId
null
)
;
DrmSessionException
error
=
drmSession
.
getError
(
)
;
Pair
<
Long
Long
>
licenseDurationRemainingSec
=
WidevineUtil
.
getLicenseDurationRemainingSec
(
drmSession
)
;
drmSessionManager
.
releaseSession
(
drmSession
)
;
if
(
error
!
=
null
)
{
if
(
error
.
getCause
(
)
instanceof
KeysExpiredException
)
{
return
Pair
.
create
(
0L
0L
)
;
}
throw
error
;
}
return
licenseDurationRemainingSec
;
}
private
byte
[
]
blockingKeyRequest
(
Mode
int
licenseMode
byte
[
]
offlineLicenseKeySetId
DrmInitData
drmInitData
)
throws
DrmSessionException
{
DrmSession
<
T
>
drmSession
=
openBlockingKeyRequest
(
licenseMode
offlineLicenseKeySetId
drmInitData
)
;
DrmSessionException
error
=
drmSession
.
getError
(
)
;
byte
[
]
keySetId
=
drmSession
.
getOfflineLicenseKeySetId
(
)
;
drmSessionManager
.
releaseSession
(
drmSession
)
;
if
(
error
!
=
null
)
{
throw
error
;
}
return
keySetId
;
}
private
DrmSession
<
T
>
openBlockingKeyRequest
(
Mode
int
licenseMode
byte
[
]
offlineLicenseKeySetId
DrmInitData
drmInitData
)
{
drmSessionManager
.
setMode
(
licenseMode
offlineLicenseKeySetId
)
;
conditionVariable
.
close
(
)
;
DrmSession
<
T
>
drmSession
=
drmSessionManager
.
acquireSession
(
handlerThread
.
getLooper
(
)
drmInitData
)
;
conditionVariable
.
block
(
)
;
return
drmSession
;
}
}
