package
org
.
mozilla
.
gecko
;
import
android
.
content
.
Context
;
import
android
.
content
.
pm
.
ActivityInfo
;
import
android
.
content
.
res
.
Configuration
;
import
android
.
util
.
Log
;
import
android
.
view
.
Surface
;
import
android
.
view
.
WindowManager
;
import
org
.
mozilla
.
gecko
.
annotation
.
WrapForJNI
;
import
org
.
mozilla
.
gecko
.
util
.
ThreadUtils
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
Arrays
;
import
java
.
util
.
List
;
public
class
GeckoScreenOrientation
{
private
static
final
String
LOGTAG
=
"
GeckoScreenOrientation
"
;
public
enum
ScreenOrientation
{
NONE
(
0
)
PORTRAIT_PRIMARY
(
1
<
<
0
)
PORTRAIT_SECONDARY
(
1
<
<
1
)
PORTRAIT
(
PORTRAIT_PRIMARY
.
value
|
PORTRAIT_SECONDARY
.
value
)
LANDSCAPE_PRIMARY
(
1
<
<
2
)
LANDSCAPE_SECONDARY
(
1
<
<
3
)
LANDSCAPE
(
LANDSCAPE_PRIMARY
.
value
|
LANDSCAPE_SECONDARY
.
value
)
DEFAULT
(
1
<
<
4
)
;
public
final
short
value
;
private
ScreenOrientation
(
final
int
value
)
{
this
.
value
=
(
short
)
value
;
}
private
final
static
ScreenOrientation
[
]
sValues
=
ScreenOrientation
.
values
(
)
;
public
static
ScreenOrientation
get
(
final
int
value
)
{
for
(
ScreenOrientation
orient
:
sValues
)
{
if
(
orient
.
value
=
=
value
)
{
return
orient
;
}
}
return
NONE
;
}
}
private
static
GeckoScreenOrientation
sInstance
;
private
static
final
int
DEFAULT_ROTATION
=
Surface
.
ROTATION_0
;
private
ScreenOrientation
mScreenOrientation
=
ScreenOrientation
.
PORTRAIT_PRIMARY
;
private
boolean
mShouldNotify
=
true
;
public
interface
OrientationChangeListener
{
void
onScreenOrientationChanged
(
ScreenOrientation
newOrientation
)
;
}
private
final
List
<
OrientationChangeListener
>
mListeners
;
public
static
GeckoScreenOrientation
getInstance
(
)
{
if
(
sInstance
=
=
null
)
{
sInstance
=
new
GeckoScreenOrientation
(
)
;
}
return
sInstance
;
}
private
GeckoScreenOrientation
(
)
{
mListeners
=
new
ArrayList
<
>
(
)
;
update
(
)
;
}
public
void
addListener
(
final
OrientationChangeListener
aListener
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
mListeners
.
add
(
aListener
)
;
}
public
void
removeListener
(
final
OrientationChangeListener
aListener
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
mListeners
.
remove
(
aListener
)
;
}
public
void
enableNotifications
(
)
{
update
(
)
;
mShouldNotify
=
true
;
}
public
void
disableNotifications
(
)
{
mShouldNotify
=
false
;
}
public
boolean
update
(
)
{
final
Context
appContext
=
GeckoAppShell
.
getApplicationContext
(
)
;
if
(
appContext
=
=
null
)
{
return
false
;
}
Configuration
config
=
appContext
.
getResources
(
)
.
getConfiguration
(
)
;
return
update
(
config
.
orientation
)
;
}
public
boolean
update
(
final
int
aAndroidOrientation
)
{
return
update
(
getScreenOrientation
(
aAndroidOrientation
getRotation
(
)
)
)
;
}
WrapForJNI
(
dispatchTo
=
"
gecko
"
)
private
static
native
void
onOrientationChange
(
short
screenOrientation
short
angle
)
;
public
synchronized
boolean
update
(
final
ScreenOrientation
aScreenOrientation
)
{
ScreenOrientation
screenOrientation
;
if
(
(
aScreenOrientation
.
value
&
ScreenOrientation
.
PORTRAIT_PRIMARY
.
value
)
!
=
0
)
{
screenOrientation
=
ScreenOrientation
.
PORTRAIT_PRIMARY
;
}
else
if
(
(
aScreenOrientation
.
value
&
ScreenOrientation
.
PORTRAIT_SECONDARY
.
value
)
!
=
0
)
{
screenOrientation
=
ScreenOrientation
.
PORTRAIT_SECONDARY
;
}
else
if
(
(
aScreenOrientation
.
value
&
ScreenOrientation
.
LANDSCAPE_PRIMARY
.
value
)
!
=
0
)
{
screenOrientation
=
ScreenOrientation
.
LANDSCAPE_PRIMARY
;
}
else
if
(
(
aScreenOrientation
.
value
&
ScreenOrientation
.
LANDSCAPE_SECONDARY
.
value
)
!
=
0
)
{
screenOrientation
=
ScreenOrientation
.
LANDSCAPE_SECONDARY
;
}
else
{
screenOrientation
=
ScreenOrientation
.
PORTRAIT_PRIMARY
;
}
if
(
mScreenOrientation
=
=
screenOrientation
)
{
return
false
;
}
mScreenOrientation
=
screenOrientation
;
Log
.
d
(
LOGTAG
"
updating
to
new
orientation
"
+
mScreenOrientation
)
;
notifyListeners
(
mScreenOrientation
)
;
if
(
mShouldNotify
)
{
if
(
aScreenOrientation
=
=
ScreenOrientation
.
NONE
)
{
return
false
;
}
if
(
GeckoThread
.
isRunning
(
)
)
{
onOrientationChange
(
screenOrientation
.
value
getAngle
(
)
)
;
}
else
{
GeckoThread
.
queueNativeCall
(
GeckoScreenOrientation
.
class
"
onOrientationChange
"
screenOrientation
.
value
getAngle
(
)
)
;
}
}
ScreenManagerHelper
.
refreshScreenInfo
(
)
;
return
true
;
}
private
void
notifyListeners
(
final
ScreenOrientation
newOrientation
)
{
final
Runnable
notifier
=
new
Runnable
(
)
{
Override
public
void
run
(
)
{
for
(
OrientationChangeListener
listener
:
mListeners
)
{
listener
.
onScreenOrientationChanged
(
newOrientation
)
;
}
}
}
;
if
(
ThreadUtils
.
isOnUiThread
(
)
)
{
notifier
.
run
(
)
;
}
else
{
ThreadUtils
.
postToUiThread
(
notifier
)
;
}
}
public
int
getAndroidOrientation
(
)
{
return
screenOrientationToAndroidOrientation
(
getScreenOrientation
(
)
)
;
}
public
ScreenOrientation
getScreenOrientation
(
)
{
return
mScreenOrientation
;
}
public
void
lock
(
final
int
aGeckoOrientation
)
{
lock
(
ScreenOrientation
.
get
(
aGeckoOrientation
)
)
;
}
public
boolean
lock
(
final
ScreenOrientation
aScreenOrientation
)
{
Log
.
d
(
LOGTAG
"
locking
to
"
+
aScreenOrientation
)
;
final
ScreenOrientationDelegate
delegate
=
GeckoAppShell
.
getScreenOrientationDelegate
(
)
;
final
int
activityInfoOrientation
=
screenOrientationToActivityInfoOrientation
(
aScreenOrientation
)
;
synchronized
(
this
)
{
if
(
delegate
.
setRequestedOrientationForCurrentActivity
(
activityInfoOrientation
)
)
{
update
(
aScreenOrientation
)
;
return
true
;
}
else
{
return
false
;
}
}
}
public
boolean
unlock
(
)
{
Log
.
d
(
LOGTAG
"
unlocking
"
)
;
final
ScreenOrientationDelegate
delegate
=
GeckoAppShell
.
getScreenOrientationDelegate
(
)
;
final
int
activityInfoOrientation
=
screenOrientationToActivityInfoOrientation
(
ScreenOrientation
.
DEFAULT
)
;
synchronized
(
this
)
{
if
(
delegate
.
setRequestedOrientationForCurrentActivity
(
activityInfoOrientation
)
)
{
update
(
)
;
return
true
;
}
else
{
return
false
;
}
}
}
private
ScreenOrientation
getScreenOrientation
(
final
int
aAndroidOrientation
final
int
aRotation
)
{
boolean
isPrimary
=
aRotation
=
=
Surface
.
ROTATION_0
|
|
aRotation
=
=
Surface
.
ROTATION_90
;
if
(
aAndroidOrientation
=
=
Configuration
.
ORIENTATION_PORTRAIT
)
{
if
(
isPrimary
)
{
return
ScreenOrientation
.
PORTRAIT_PRIMARY
;
}
return
ScreenOrientation
.
PORTRAIT_SECONDARY
;
}
if
(
aAndroidOrientation
=
=
Configuration
.
ORIENTATION_LANDSCAPE
)
{
if
(
isPrimary
)
{
return
ScreenOrientation
.
LANDSCAPE_PRIMARY
;
}
return
ScreenOrientation
.
LANDSCAPE_SECONDARY
;
}
return
ScreenOrientation
.
NONE
;
}
public
short
getAngle
(
)
{
switch
(
getRotation
(
)
)
{
case
Surface
.
ROTATION_0
:
return
0
;
case
Surface
.
ROTATION_90
:
return
90
;
case
Surface
.
ROTATION_180
:
return
180
;
case
Surface
.
ROTATION_270
:
return
270
;
default
:
Log
.
w
(
LOGTAG
"
getAngle
:
unexpected
rotation
value
"
)
;
return
0
;
}
}
private
int
getRotation
(
)
{
final
Context
appContext
=
GeckoAppShell
.
getApplicationContext
(
)
;
if
(
appContext
=
=
null
)
{
return
DEFAULT_ROTATION
;
}
final
WindowManager
windowManager
=
(
WindowManager
)
appContext
.
getSystemService
(
Context
.
WINDOW_SERVICE
)
;
return
windowManager
.
getDefaultDisplay
(
)
.
getRotation
(
)
;
}
public
static
ScreenOrientation
screenOrientationFromArrayString
(
final
String
aArray
)
{
List
<
String
>
orientations
=
Arrays
.
asList
(
aArray
.
split
(
"
"
)
)
;
if
(
"
"
.
equals
(
aArray
)
|
|
orientations
.
size
(
)
=
=
0
)
{
Log
.
w
(
LOGTAG
"
screenOrientationFromArrayString
:
no
orientation
in
string
"
)
;
return
ScreenOrientation
.
DEFAULT
;
}
return
screenOrientationFromString
(
orientations
.
get
(
0
)
)
;
}
public
static
ScreenOrientation
screenOrientationFromString
(
final
String
aStr
)
{
switch
(
aStr
)
{
case
"
portrait
"
:
return
ScreenOrientation
.
PORTRAIT
;
case
"
landscape
"
:
return
ScreenOrientation
.
LANDSCAPE
;
case
"
portrait
-
primary
"
:
return
ScreenOrientation
.
PORTRAIT_PRIMARY
;
case
"
portrait
-
secondary
"
:
return
ScreenOrientation
.
PORTRAIT_SECONDARY
;
case
"
landscape
-
primary
"
:
return
ScreenOrientation
.
LANDSCAPE_PRIMARY
;
case
"
landscape
-
secondary
"
:
return
ScreenOrientation
.
LANDSCAPE_SECONDARY
;
}
Log
.
w
(
LOGTAG
"
screenOrientationFromString
:
unknown
orientation
string
:
"
+
aStr
)
;
return
ScreenOrientation
.
DEFAULT
;
}
public
static
int
screenOrientationToAndroidOrientation
(
final
ScreenOrientation
aScreenOrientation
)
{
switch
(
aScreenOrientation
)
{
case
PORTRAIT
:
case
PORTRAIT_PRIMARY
:
case
PORTRAIT_SECONDARY
:
return
Configuration
.
ORIENTATION_PORTRAIT
;
case
LANDSCAPE
:
case
LANDSCAPE_PRIMARY
:
case
LANDSCAPE_SECONDARY
:
return
Configuration
.
ORIENTATION_LANDSCAPE
;
case
NONE
:
case
DEFAULT
:
default
:
return
Configuration
.
ORIENTATION_UNDEFINED
;
}
}
public
static
int
screenOrientationToActivityInfoOrientation
(
final
ScreenOrientation
aScreenOrientation
)
{
switch
(
aScreenOrientation
)
{
case
PORTRAIT
:
return
ActivityInfo
.
SCREEN_ORIENTATION_SENSOR_PORTRAIT
;
case
PORTRAIT_PRIMARY
:
return
ActivityInfo
.
SCREEN_ORIENTATION_PORTRAIT
;
case
PORTRAIT_SECONDARY
:
return
ActivityInfo
.
SCREEN_ORIENTATION_REVERSE_PORTRAIT
;
case
LANDSCAPE
:
return
ActivityInfo
.
SCREEN_ORIENTATION_SENSOR_LANDSCAPE
;
case
LANDSCAPE_PRIMARY
:
return
ActivityInfo
.
SCREEN_ORIENTATION_LANDSCAPE
;
case
LANDSCAPE_SECONDARY
:
return
ActivityInfo
.
SCREEN_ORIENTATION_REVERSE_LANDSCAPE
;
case
DEFAULT
:
case
NONE
:
return
ActivityInfo
.
SCREEN_ORIENTATION_UNSPECIFIED
;
default
:
return
ActivityInfo
.
SCREEN_ORIENTATION_NOSENSOR
;
}
}
}
