package
org
.
mozilla
.
geckoview
;
import
org
.
mozilla
.
gecko
.
annotation
.
WrapForJNI
;
import
org
.
mozilla
.
gecko
.
EventDispatcher
;
import
org
.
mozilla
.
gecko
.
GeckoAppShell
;
import
org
.
mozilla
.
gecko
.
PrefsHelper
;
import
org
.
mozilla
.
gecko
.
util
.
BundleEventListener
;
import
org
.
mozilla
.
gecko
.
util
.
EventCallback
;
import
org
.
mozilla
.
gecko
.
util
.
GeckoBundle
;
import
org
.
mozilla
.
gecko
.
mozglue
.
JNIObject
;
import
android
.
content
.
Context
;
import
android
.
graphics
.
Matrix
;
import
android
.
graphics
.
Rect
;
import
android
.
os
.
Build
;
import
android
.
os
.
Bundle
;
import
android
.
text
.
InputType
;
import
android
.
util
.
Log
;
import
android
.
view
.
InputDevice
;
import
android
.
view
.
MotionEvent
;
import
android
.
view
.
View
;
import
android
.
view
.
ViewParent
;
import
android
.
view
.
accessibility
.
AccessibilityEvent
;
import
android
.
view
.
accessibility
.
AccessibilityManager
;
import
android
.
view
.
accessibility
.
AccessibilityNodeInfo
;
import
android
.
view
.
accessibility
.
AccessibilityNodeProvider
;
public
class
SessionAccessibility
{
private
static
final
String
LOGTAG
=
"
GeckoAccessibility
"
;
private
static
final
boolean
DEBUG
=
false
;
private
static
final
int
BRAILLE_CLICK_BASE_INDEX
=
-
275000000
;
private
static
final
int
ACTION_SET_TEXT
=
0x200000
;
private
static
final
String
ACTION_ARGUMENT_SET_TEXT_CHARSEQUENCE
=
"
ACTION_ARGUMENT_SET_TEXT_CHARSEQUENCE
"
;
final
class
NodeProvider
extends
AccessibilityNodeProvider
{
Override
public
AccessibilityNodeInfo
createAccessibilityNodeInfo
(
int
virtualDescendantId
)
{
AccessibilityNodeInfo
node
=
AccessibilityNodeInfo
.
obtain
(
mView
virtualDescendantId
)
;
if
(
Build
.
VERSION
.
SDK_INT
<
17
|
|
mView
.
getDisplay
(
)
!
=
null
)
{
mView
.
onInitializeAccessibilityNodeInfo
(
node
)
;
}
node
.
setClassName
(
"
android
.
webkit
.
WebView
"
)
;
return
node
;
}
Override
public
boolean
performAction
(
final
int
virtualViewId
int
action
Bundle
arguments
)
{
final
GeckoBundle
data
;
switch
(
action
)
{
case
AccessibilityNodeInfo
.
ACTION_ACCESSIBILITY_FOCUS
:
final
AccessibilityEvent
event
=
AccessibilityEvent
.
obtain
(
AccessibilityEvent
.
TYPE_VIEW_ACCESSIBILITY_FOCUSED
)
;
event
.
setPackageName
(
GeckoAppShell
.
getApplicationContext
(
)
.
getPackageName
(
)
)
;
event
.
setSource
(
mView
virtualViewId
)
;
(
(
ViewParent
)
mView
)
.
requestSendAccessibilityEvent
(
mView
event
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_CLICK
:
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityActivate
"
null
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_LONG_CLICK
:
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityLongPress
"
null
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_SCROLL_FORWARD
:
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityScrollForward
"
null
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_SCROLL_BACKWARD
:
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityScrollBackward
"
null
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_SELECT
:
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilitySelect
"
null
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_NEXT_HTML_ELEMENT
:
case
AccessibilityNodeInfo
.
ACTION_PREVIOUS_HTML_ELEMENT
:
if
(
arguments
!
=
null
)
{
data
=
new
GeckoBundle
(
1
)
;
data
.
putString
(
"
rule
"
arguments
.
getString
(
AccessibilityNodeInfo
.
ACTION_ARGUMENT_HTML_ELEMENT_STRING
)
)
;
}
else
{
data
=
null
;
}
mSession
.
getEventDispatcher
(
)
.
dispatch
(
action
=
=
AccessibilityNodeInfo
.
ACTION_NEXT_HTML_ELEMENT
?
"
GeckoView
:
AccessibilityNext
"
:
"
GeckoView
:
AccessibilityPrevious
"
data
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_NEXT_AT_MOVEMENT_GRANULARITY
:
case
AccessibilityNodeInfo
.
ACTION_PREVIOUS_AT_MOVEMENT_GRANULARITY
:
int
granularity
=
arguments
.
getInt
(
AccessibilityNodeInfo
.
ACTION_ARGUMENT_MOVEMENT_GRANULARITY_INT
)
;
if
(
granularity
<
=
BRAILLE_CLICK_BASE_INDEX
)
{
int
keyIndex
=
BRAILLE_CLICK_BASE_INDEX
-
granularity
;
data
=
new
GeckoBundle
(
1
)
;
data
.
putInt
(
"
keyIndex
"
keyIndex
)
;
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityActivate
"
data
)
;
}
else
if
(
granularity
>
0
)
{
boolean
extendSelection
=
arguments
.
getBoolean
(
AccessibilityNodeInfo
.
ACTION_ARGUMENT_EXTEND_SELECTION_BOOLEAN
)
;
data
=
new
GeckoBundle
(
3
)
;
data
.
putString
(
"
direction
"
action
=
=
AccessibilityNodeInfo
.
ACTION_NEXT_AT_MOVEMENT_GRANULARITY
?
"
Next
"
:
"
Previous
"
)
;
data
.
putInt
(
"
granularity
"
granularity
)
;
data
.
putBoolean
(
"
select
"
extendSelection
)
;
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityByGranularity
"
data
)
;
}
return
true
;
case
AccessibilityNodeInfo
.
ACTION_SET_SELECTION
:
if
(
arguments
=
=
null
)
{
return
false
;
}
int
selectionStart
=
arguments
.
getInt
(
AccessibilityNodeInfo
.
ACTION_ARGUMENT_SELECTION_START_INT
)
;
int
selectionEnd
=
arguments
.
getInt
(
AccessibilityNodeInfo
.
ACTION_ARGUMENT_SELECTION_END_INT
)
;
data
=
new
GeckoBundle
(
2
)
;
data
.
putInt
(
"
start
"
selectionStart
)
;
data
.
putInt
(
"
end
"
selectionEnd
)
;
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilitySetSelection
"
data
)
;
return
true
;
case
AccessibilityNodeInfo
.
ACTION_CUT
:
case
AccessibilityNodeInfo
.
ACTION_COPY
:
case
AccessibilityNodeInfo
.
ACTION_PASTE
:
data
=
new
GeckoBundle
(
1
)
;
data
.
putInt
(
"
action
"
action
)
;
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityClipboard
"
data
)
;
return
true
;
}
return
mView
.
performAccessibilityAction
(
action
arguments
)
;
}
}
;
final
GeckoSession
mSession
;
private
View
mView
;
final
NativeProvider
nativeProvider
=
new
NativeProvider
(
)
;
private
boolean
mAttached
=
false
;
SessionAccessibility
(
final
GeckoSession
session
)
{
mSession
=
session
;
Settings
.
updateAccessibilitySettings
(
)
;
}
public
View
getView
(
)
{
return
mView
;
}
public
void
setView
(
final
View
view
)
{
if
(
mView
!
=
null
)
{
mView
.
setAccessibilityDelegate
(
null
)
;
}
mView
=
view
;
if
(
mView
=
=
null
)
{
return
;
}
mView
.
setAccessibilityDelegate
(
new
View
.
AccessibilityDelegate
(
)
{
private
NodeProvider
mProvider
;
Override
public
AccessibilityNodeProvider
getAccessibilityNodeProvider
(
final
View
hostView
)
{
if
(
hostView
!
=
mView
)
{
return
null
;
}
if
(
mProvider
=
=
null
)
{
mProvider
=
new
NodeProvider
(
)
;
}
return
mProvider
;
}
}
)
;
}
private
static
class
Settings
{
private
static
final
String
FORCE_ACCESSIBILITY_PREF
=
"
accessibility
.
force_disabled
"
;
private
static
volatile
boolean
sEnabled
;
private
static
volatile
boolean
sTouchExplorationEnabled
;
static
volatile
boolean
sForceEnabled
;
static
{
final
Context
context
=
GeckoAppShell
.
getApplicationContext
(
)
;
AccessibilityManager
accessibilityManager
=
(
AccessibilityManager
)
context
.
getSystemService
(
Context
.
ACCESSIBILITY_SERVICE
)
;
accessibilityManager
.
addAccessibilityStateChangeListener
(
new
AccessibilityManager
.
AccessibilityStateChangeListener
(
)
{
Override
public
void
onAccessibilityStateChanged
(
boolean
enabled
)
{
updateAccessibilitySettings
(
)
;
}
}
)
;
if
(
Build
.
VERSION
.
SDK_INT
>
=
19
)
{
accessibilityManager
.
addTouchExplorationStateChangeListener
(
new
AccessibilityManager
.
TouchExplorationStateChangeListener
(
)
{
Override
public
void
onTouchExplorationStateChanged
(
boolean
enabled
)
{
updateAccessibilitySettings
(
)
;
}
}
)
;
}
PrefsHelper
.
PrefHandler
prefHandler
=
new
PrefsHelper
.
PrefHandlerBase
(
)
{
Override
public
void
prefValue
(
String
pref
int
value
)
{
if
(
pref
.
equals
(
FORCE_ACCESSIBILITY_PREF
)
)
{
sForceEnabled
=
value
<
0
;
dispatch
(
)
;
}
}
}
;
PrefsHelper
.
addObserver
(
new
String
[
]
{
FORCE_ACCESSIBILITY_PREF
}
prefHandler
)
;
}
public
static
boolean
isEnabled
(
)
{
return
sEnabled
|
|
sForceEnabled
;
}
public
static
boolean
isTouchExplorationEnabled
(
)
{
return
sTouchExplorationEnabled
|
|
sForceEnabled
;
}
public
static
void
updateAccessibilitySettings
(
)
{
final
AccessibilityManager
accessibilityManager
=
(
AccessibilityManager
)
GeckoAppShell
.
getApplicationContext
(
)
.
getSystemService
(
Context
.
ACCESSIBILITY_SERVICE
)
;
sEnabled
=
accessibilityManager
.
isEnabled
(
)
;
sTouchExplorationEnabled
=
sEnabled
&
&
accessibilityManager
.
isTouchExplorationEnabled
(
)
;
dispatch
(
)
;
}
static
void
dispatch
(
)
{
final
GeckoBundle
ret
=
new
GeckoBundle
(
1
)
;
ret
.
putBoolean
(
"
enabled
"
isTouchExplorationEnabled
(
)
)
;
EventDispatcher
.
getInstance
(
)
.
dispatch
(
"
GeckoView
:
AccessibilitySettings
"
ret
)
;
EventDispatcher
.
getInstance
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityEnabled
"
ret
)
;
}
}
public
boolean
onMotionEvent
(
final
MotionEvent
event
)
{
if
(
!
Settings
.
isTouchExplorationEnabled
(
)
)
{
return
false
;
}
if
(
event
.
getSource
(
)
!
=
InputDevice
.
SOURCE_TOUCHSCREEN
)
{
return
false
;
}
final
int
action
=
event
.
getActionMasked
(
)
;
if
(
(
action
!
=
MotionEvent
.
ACTION_HOVER_MOVE
)
&
&
(
action
!
=
MotionEvent
.
ACTION_HOVER_ENTER
)
&
&
(
action
!
=
MotionEvent
.
ACTION_HOVER_EXIT
)
)
{
return
false
;
}
final
GeckoBundle
data
=
new
GeckoBundle
(
2
)
;
data
.
putDoubleArray
(
"
coordinates
"
new
double
[
]
{
event
.
getRawX
(
)
event
.
getRawY
(
)
}
)
;
mSession
.
getEventDispatcher
(
)
.
dispatch
(
"
GeckoView
:
AccessibilityExploreByTouch
"
data
)
;
return
true
;
}
final
class
NativeProvider
extends
JNIObject
{
WrapForJNI
(
calledFrom
=
"
ui
"
)
private
void
setAttached
(
final
boolean
attached
)
{
mAttached
=
attached
;
}
Override
protected
void
disposeNative
(
)
{
throw
new
UnsupportedOperationException
(
)
;
}
}
}
