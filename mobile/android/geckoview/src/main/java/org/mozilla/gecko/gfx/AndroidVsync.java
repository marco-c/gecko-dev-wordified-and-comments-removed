package
org
.
mozilla
.
gecko
.
gfx
;
import
android
.
os
.
Handler
;
import
android
.
os
.
Looper
;
import
android
.
view
.
Choreographer
;
import
org
.
mozilla
.
gecko
.
annotation
.
WrapForJNI
;
import
org
.
mozilla
.
gecko
.
mozglue
.
JNIObject
;
WrapForJNI
final
class
AndroidVsync
extends
JNIObject
implements
Choreographer
.
FrameCallback
{
WrapForJNI
Override
protected
native
void
disposeNative
(
)
;
private
static
final
String
LOGTAG
=
"
AndroidVsync
"
;
Choreographer
mChoreographer
;
private
volatile
boolean
mObservingVsync
;
public
AndroidVsync
(
)
{
final
Handler
mainHandler
=
new
Handler
(
Looper
.
getMainLooper
(
)
)
;
mainHandler
.
post
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
mChoreographer
=
Choreographer
.
getInstance
(
)
;
if
(
mObservingVsync
)
{
mChoreographer
.
postFrameCallback
(
AndroidVsync
.
this
)
;
}
}
}
)
;
}
WrapForJNI
(
stubName
=
"
NotifyVsync
"
)
private
native
void
nativeNotifyVsync
(
final
long
frameTimeNanos
)
;
public
void
doFrame
(
final
long
frameTimeNanos
)
{
if
(
mObservingVsync
)
{
mChoreographer
.
postFrameCallback
(
this
)
;
nativeNotifyVsync
(
frameTimeNanos
)
;
}
}
WrapForJNI
public
synchronized
boolean
observeVsync
(
final
boolean
enable
)
{
if
(
mObservingVsync
!
=
enable
)
{
mObservingVsync
=
enable
;
if
(
mChoreographer
!
=
null
)
{
if
(
enable
)
{
mChoreographer
.
postFrameCallback
(
this
)
;
}
else
{
mChoreographer
.
removeFrameCallback
(
this
)
;
}
}
}
return
mObservingVsync
;
}
}
