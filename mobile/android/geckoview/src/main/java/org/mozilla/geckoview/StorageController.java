package
org
.
mozilla
.
geckoview
;
import
java
.
lang
.
annotation
.
Retention
;
import
java
.
lang
.
annotation
.
RetentionPolicy
;
import
java
.
math
.
BigInteger
;
import
java
.
util
.
List
;
import
java
.
util
.
Locale
;
import
androidx
.
annotation
.
AnyThread
;
import
androidx
.
annotation
.
LongDef
;
import
androidx
.
annotation
.
NonNull
;
import
androidx
.
annotation
.
Nullable
;
import
org
.
mozilla
.
gecko
.
EventDispatcher
;
import
org
.
mozilla
.
gecko
.
util
.
GeckoBundle
;
import
org
.
mozilla
.
geckoview
.
GeckoSession
.
PermissionDelegate
.
ContentPermission
;
public
final
class
StorageController
{
public
static
class
ClearFlags
{
public
static
final
long
COOKIES
=
1
<
<
0
;
public
static
final
long
NETWORK_CACHE
=
1
<
<
1
;
public
static
final
long
IMAGE_CACHE
=
1
<
<
2
;
public
static
final
long
DOM_STORAGES
=
1
<
<
4
;
public
static
final
long
AUTH_SESSIONS
=
1
<
<
5
;
public
static
final
long
PERMISSIONS
=
1
<
<
6
;
public
static
final
long
ALL_CACHES
=
NETWORK_CACHE
|
IMAGE_CACHE
;
public
static
final
long
SITE_SETTINGS
=
1
<
<
7
|
PERMISSIONS
;
public
static
final
long
SITE_DATA
=
1
<
<
8
|
COOKIES
|
DOM_STORAGES
|
ALL_CACHES
|
PERMISSIONS
|
SITE_SETTINGS
;
public
static
final
long
ALL
=
1
<
<
9
;
}
Retention
(
RetentionPolicy
.
SOURCE
)
LongDef
(
flag
=
true
value
=
{
ClearFlags
.
COOKIES
ClearFlags
.
NETWORK_CACHE
ClearFlags
.
IMAGE_CACHE
ClearFlags
.
DOM_STORAGES
ClearFlags
.
AUTH_SESSIONS
ClearFlags
.
PERMISSIONS
ClearFlags
.
ALL_CACHES
ClearFlags
.
SITE_SETTINGS
ClearFlags
.
SITE_DATA
ClearFlags
.
ALL
}
)
interface
StorageControllerClearFlags
{
}
AnyThread
public
NonNull
GeckoResult
<
Void
>
clearData
(
final
StorageControllerClearFlags
long
flags
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putLong
(
"
flags
"
flags
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
"
GeckoView
:
ClearData
"
bundle
)
;
}
AnyThread
public
NonNull
GeckoResult
<
Void
>
clearDataFromHost
(
final
NonNull
String
host
final
StorageControllerClearFlags
long
flags
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
2
)
;
bundle
.
putString
(
"
host
"
host
)
;
bundle
.
putLong
(
"
flags
"
flags
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
"
GeckoView
:
ClearHostData
"
bundle
)
;
}
AnyThread
public
void
clearDataForSessionContext
(
final
NonNull
String
contextId
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
contextId
"
createSafeSessionContextId
(
contextId
)
)
;
EventDispatcher
.
getInstance
(
)
.
dispatch
(
"
GeckoView
:
ClearSessionContextData
"
bundle
)
;
}
static
NonNull
String
createSafeSessionContextId
(
final
Nullable
String
contextId
)
{
if
(
contextId
=
=
null
)
{
return
null
;
}
if
(
contextId
.
isEmpty
(
)
)
{
return
"
gvctxempty
"
;
}
return
String
.
format
(
"
gvctx
%
x
"
new
BigInteger
(
contextId
.
getBytes
(
)
)
)
.
toLowerCase
(
Locale
.
ROOT
)
;
}
AnyThread
public
NonNull
GeckoResult
<
List
<
ContentPermission
>
>
getAllPermissions
(
)
{
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
"
GeckoView
:
GetAllPermissions
"
)
.
map
(
bundle
-
>
{
final
GeckoBundle
[
]
permsArray
=
bundle
.
getBundleArray
(
"
permissions
"
)
;
return
ContentPermission
.
fromBundleArray
(
permsArray
)
;
}
)
;
}
AnyThread
public
NonNull
GeckoResult
<
List
<
ContentPermission
>
>
getPermissions
(
final
NonNull
String
uri
)
{
final
GeckoBundle
msg
=
new
GeckoBundle
(
1
)
;
msg
.
putString
(
"
uri
"
uri
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
"
GeckoView
:
GetPermissionsByURI
"
msg
)
.
map
(
bundle
-
>
{
final
GeckoBundle
[
]
permsArray
=
bundle
.
getBundleArray
(
"
permissions
"
)
;
return
ContentPermission
.
fromBundleArray
(
permsArray
)
;
}
)
;
}
}
