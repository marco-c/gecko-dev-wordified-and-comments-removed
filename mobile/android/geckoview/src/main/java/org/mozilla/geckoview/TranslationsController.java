package
org
.
mozilla
.
geckoview
;
import
android
.
util
.
Log
;
import
androidx
.
annotation
.
AnyThread
;
import
androidx
.
annotation
.
IntDef
;
import
androidx
.
annotation
.
NonNull
;
import
androidx
.
annotation
.
Nullable
;
import
androidx
.
annotation
.
StringDef
;
import
java
.
lang
.
annotation
.
Retention
;
import
java
.
lang
.
annotation
.
RetentionPolicy
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
Arrays
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
List
;
import
java
.
util
.
Locale
;
import
java
.
util
.
Map
;
import
java
.
util
.
Objects
;
import
org
.
mozilla
.
gecko
.
EventDispatcher
;
import
org
.
mozilla
.
gecko
.
util
.
EventCallback
;
import
org
.
mozilla
.
gecko
.
util
.
GeckoBundle
;
public
class
TranslationsController
{
private
static
final
boolean
DEBUG
=
false
;
private
static
final
String
LOGTAG
=
"
TranslationsController
"
;
public
static
class
RuntimeTranslation
{
private
static
final
String
ENGINE_SUPPORTED_EVENT
=
"
GeckoView
:
Translations
:
IsTranslationEngineSupported
"
;
private
static
final
String
PREFERRED_LANGUAGES_EVENT
=
"
GeckoView
:
Translations
:
PreferredLanguages
"
;
private
static
final
String
MANAGE_MODEL_EVENT
=
"
GeckoView
:
Translations
:
ManageModel
"
;
private
static
final
String
TRANSLATION_INFORMATION_EVENT
=
"
GeckoView
:
Translations
:
TranslationInformation
"
;
private
static
final
String
MODEL_INFORMATION_EVENT
=
"
GeckoView
:
Translations
:
ModelInformation
"
;
private
static
final
String
GET_LANGUAGE_SETTING_EVENT
=
"
GeckoView
:
Translations
:
GetLanguageSetting
"
;
private
static
final
String
GET_LANGUAGE_SETTINGS_EVENT
=
"
GeckoView
:
Translations
:
GetLanguageSettings
"
;
private
static
final
String
SET_LANGUAGE_SETTINGS_EVENT
=
"
GeckoView
:
Translations
:
SetLanguageSettings
"
;
private
static
final
String
GET_SPECIFIED_SITES_SETTINGS_EVENT
=
"
GeckoView
:
Translations
:
GetNeverTranslateSpecifiedSites
"
;
private
static
final
String
SET_SPECIFIED_SITE_SETTINGS_EVENT
=
"
GeckoView
:
Translations
:
SetNeverTranslateSpecifiedSite
"
;
private
static
final
String
GET_TRANSLATE_PAIR_DOWNLOAD_SIZE
=
"
GeckoView
:
Translations
:
GetTranslateDownloadSize
"
;
AnyThread
public
static
NonNull
GeckoResult
<
Boolean
>
isTranslationsEngineSupported
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
if
the
translations
engine
supports
the
device
.
"
)
;
}
return
EventDispatcher
.
getInstance
(
)
.
queryBoolean
(
ENGINE_SUPPORTED_EVENT
)
.
map
(
result
-
>
result
exception
-
>
new
TranslationsException
(
TranslationsException
.
ERROR_ENGINE_NOT_SUPPORTED
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
List
<
String
>
>
preferredLanguages
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
the
user
'
s
preferred
languages
.
"
)
;
}
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
PREFERRED_LANGUAGES_EVENT
)
.
map
(
bundle
-
>
{
try
{
final
String
[
]
languages
=
bundle
.
getStringArray
(
"
preferredLanguages
"
)
;
if
(
languages
!
=
null
)
{
return
Arrays
.
asList
(
languages
)
;
}
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
Could
not
deserialize
preferredLanguages
:
"
+
e
)
;
return
null
;
}
return
null
;
}
exception
-
>
new
TranslationsException
(
TranslationsException
.
ERROR_COULD_NOT_LOAD_LANGUAGES
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
manageLanguageModel
(
final
NonNull
ModelManagementOptions
options
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
management
of
the
language
model
.
"
)
;
}
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
MANAGE_MODEL_EVENT
options
.
toBundle
(
)
)
.
map
(
result
-
>
result
exception
-
>
{
final
String
exceptionData
=
(
(
EventDispatcher
.
QueryException
)
exception
)
.
data
.
toString
(
)
;
if
(
exceptionData
.
contains
(
"
COULD_NOT_DELETE
"
)
)
{
return
new
TranslationsException
(
TranslationsException
.
ERROR_MODEL_COULD_NOT_DELETE
)
;
}
else
if
(
exceptionData
.
contains
(
"
LANGUAGE_REQUIRED
"
)
)
{
return
new
TranslationsException
(
TranslationsException
.
ERROR_MODEL_LANGUAGE_REQUIRED
)
;
}
else
if
(
exceptionData
.
contains
(
"
COULD_NOT_DOWNLOAD
"
)
)
{
return
new
TranslationsException
(
TranslationsException
.
ERROR_MODEL_COULD_NOT_DOWNLOAD
)
;
}
return
new
TranslationsException
(
TranslationsException
.
ERROR_UNKNOWN
)
;
}
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
TranslationSupport
>
listSupportedLanguages
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
information
on
the
language
options
.
"
)
;
}
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
TRANSLATION_INFORMATION_EVENT
)
.
map
(
bundle
-
>
TranslationSupport
.
fromBundle
(
bundle
)
exception
-
>
new
TranslationsException
(
TranslationsException
.
ERROR_COULD_NOT_LOAD_LANGUAGES
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Long
>
checkPairDownloadSize
(
NonNull
final
String
fromLanguage
NonNull
final
String
toLanguage
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
information
on
the
language
pair
download
size
.
"
)
;
}
final
GeckoBundle
bundle
=
new
GeckoBundle
(
2
)
;
bundle
.
putString
(
"
fromLanguage
"
fromLanguage
)
;
bundle
.
putString
(
"
toLanguage
"
toLanguage
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
GET_TRANSLATE_PAIR_DOWNLOAD_SIZE
bundle
)
.
map
(
resultBundle
-
>
{
return
resultBundle
.
getLong
(
"
bytes
"
0L
)
;
}
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Long
>
checkPairDownloadSize
(
NonNull
final
SessionTranslation
.
TranslationPair
pair
)
{
return
checkPairDownloadSize
(
pair
.
fromLanguage
pair
.
toLanguage
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
List
<
LanguageModel
>
>
listModelDownloadStates
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
information
on
the
language
model
.
"
)
;
}
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
MODEL_INFORMATION_EVENT
)
.
map
(
bundle
-
>
{
try
{
final
GeckoBundle
[
]
models
=
bundle
.
getBundleArray
(
"
models
"
)
;
if
(
models
!
=
null
)
{
final
List
<
LanguageModel
>
list
=
new
ArrayList
<
>
(
)
;
for
(
final
var
item
:
models
)
{
list
.
add
(
LanguageModel
.
fromBundle
(
item
)
)
;
}
return
list
;
}
}
catch
(
final
Exception
e
)
{
Log
.
d
(
LOGTAG
"
Could
not
deserialize
the
model
states
.
"
)
;
return
null
;
}
return
null
;
}
exception
-
>
new
TranslationsException
(
TranslationsException
.
ERROR_MODEL_COULD_NOT_RETRIEVE
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
String
>
getLanguageSetting
(
NonNull
final
String
languageCode
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
language
setting
for
"
+
languageCode
+
"
.
"
)
;
}
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
language
"
languageCode
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryString
(
GET_LANGUAGE_SETTING_EVENT
bundle
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Map
<
String
String
>
>
getLanguageSettings
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
language
settings
.
"
)
;
}
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
GET_LANGUAGE_SETTINGS_EVENT
)
.
map
(
bundle
-
>
{
final
Map
<
String
String
>
languageSettings
=
new
HashMap
<
>
(
)
;
try
{
final
GeckoBundle
[
]
fromBundle
=
bundle
.
getBundleArray
(
"
settings
"
)
;
for
(
final
var
item
:
fromBundle
)
{
final
var
languageCode
=
item
.
getString
(
"
langTag
"
)
;
final
LanguageSetting
String
setting
=
item
.
getString
(
"
setting
"
"
offer
"
)
;
if
(
languageCode
!
=
null
)
{
languageSettings
.
put
(
languageCode
setting
)
;
}
}
return
languageSettings
;
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
An
issue
occurred
while
deserializing
translation
language
settings
:
"
+
e
)
;
}
return
null
;
}
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setLanguageSettings
(
final
NonNull
String
languageCode
final
NonNull
LanguageSetting
String
languageSetting
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Requesting
setting
language
setting
.
"
)
;
}
final
GeckoBundle
bundle
=
new
GeckoBundle
(
2
)
;
bundle
.
putString
(
"
language
"
languageCode
)
;
bundle
.
putString
(
"
languageSetting
"
String
.
valueOf
(
languageSetting
)
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
SET_LANGUAGE_SETTINGS_EVENT
bundle
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
List
<
String
>
>
getNeverTranslateSiteList
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Retrieving
specified
never
translate
site
settings
"
)
;
}
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
GET_SPECIFIED_SITES_SETTINGS_EVENT
)
.
map
(
bundle
-
>
{
try
{
final
String
[
]
neverTranslateSites
=
bundle
.
getStringArray
(
"
sites
"
)
;
if
(
neverTranslateSites
!
=
null
)
{
return
Arrays
.
asList
(
neverTranslateSites
)
;
}
}
catch
(
final
Exception
e
)
{
Log
.
d
(
LOGTAG
"
Could
not
deserialize
the
sites
.
"
)
;
return
null
;
}
return
null
;
}
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setNeverTranslateSpecifiedSite
(
final
NonNull
Boolean
neverTranslate
final
NonNull
String
origin
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Setting
never
translate
for
specified
site
uri
origin
:
"
+
origin
)
;
}
final
GeckoBundle
bundle
=
new
GeckoBundle
(
2
)
;
bundle
.
putBoolean
(
"
neverTranslate
"
neverTranslate
)
;
bundle
.
putString
(
"
origin
"
origin
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
SET_SPECIFIED_SITE_SETTINGS_EVENT
bundle
)
;
}
AnyThread
public
static
class
ModelManagementOptions
{
public
final
Nullable
String
language
;
public
final
NonNull
ModelOperation
String
operation
;
public
final
NonNull
OperationLevel
String
operationLevel
;
protected
ModelManagementOptions
(
final
NonNull
RuntimeTranslation
.
ModelManagementOptions
.
Builder
builder
)
{
if
(
builder
.
mLanguage
!
=
null
)
{
this
.
language
=
builder
.
mLanguage
.
toLowerCase
(
Locale
.
ROOT
)
;
}
else
{
this
.
language
=
builder
.
mLanguage
;
}
this
.
operation
=
builder
.
mOperation
.
toLowerCase
(
Locale
.
ROOT
)
;
this
.
operationLevel
=
builder
.
mOperationLevel
.
toLowerCase
(
Locale
.
ROOT
)
;
}
NonNull
GeckoBundle
toBundle
(
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
2
)
;
if
(
language
!
=
null
)
{
bundle
.
putString
(
"
language
"
language
)
;
}
bundle
.
putString
(
"
operation
"
operation
.
toString
(
)
)
;
bundle
.
putString
(
"
operationLevel
"
operationLevel
.
toString
(
)
)
;
return
bundle
;
}
AnyThread
public
static
class
Builder
{
String
mLanguage
=
null
;
ModelOperation
String
mOperation
;
OperationLevel
String
mOperationLevel
=
ALL
;
public
NonNull
RuntimeTranslation
.
ModelManagementOptions
.
Builder
languageToManage
(
final
NonNull
String
language
)
{
mLanguage
=
language
;
return
this
;
}
public
NonNull
RuntimeTranslation
.
ModelManagementOptions
.
Builder
operation
(
final
NonNull
ModelOperation
String
operation
)
{
mOperation
=
operation
;
return
this
;
}
public
NonNull
RuntimeTranslation
.
ModelManagementOptions
.
Builder
operationLevel
(
final
NonNull
OperationLevel
String
operationLevel
)
{
mOperationLevel
=
operationLevel
;
return
this
;
}
AnyThread
public
NonNull
ModelManagementOptions
build
(
)
{
return
new
ModelManagementOptions
(
this
)
;
}
}
}
Retention
(
RetentionPolicy
.
SOURCE
)
StringDef
(
value
=
{
DOWNLOAD
DELETE
}
)
public
interface
ModelOperation
{
}
public
static
final
String
DOWNLOAD
=
"
download
"
;
public
static
final
String
DELETE
=
"
delete
"
;
Retention
(
RetentionPolicy
.
SOURCE
)
StringDef
(
value
=
{
LANGUAGE
CACHE
ALL
}
)
public
interface
OperationLevel
{
}
public
static
final
String
LANGUAGE
=
"
language
"
;
public
static
final
String
CACHE
=
"
cache
"
;
public
static
final
String
ALL
=
"
all
"
;
public
static
class
TranslationSupport
{
public
final
Nullable
List
<
Language
>
fromLanguages
;
public
final
Nullable
List
<
Language
>
toLanguages
;
public
TranslationSupport
(
Nullable
final
List
<
Language
>
fromLanguages
Nullable
final
List
<
Language
>
toLanguages
)
{
this
.
fromLanguages
=
fromLanguages
;
this
.
toLanguages
=
toLanguages
;
}
Override
public
String
toString
(
)
{
return
"
TranslationSupport
{
"
+
"
fromLanguages
=
"
+
fromLanguages
+
"
toLanguages
=
"
+
toLanguages
+
'
}
'
;
}
static
Nullable
TranslationSupport
fromBundle
(
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
return
null
;
}
final
List
<
Language
>
fromLanguages
=
new
ArrayList
<
>
(
)
;
final
List
<
Language
>
toLanguages
=
new
ArrayList
<
>
(
)
;
try
{
final
GeckoBundle
[
]
fromBundle
=
bundle
.
getBundleArray
(
"
sourceLanguages
"
)
;
for
(
final
var
item
:
fromBundle
)
{
final
var
result
=
Language
.
fromBundle
(
item
)
;
if
(
result
!
=
null
)
{
fromLanguages
.
add
(
result
)
;
}
}
final
GeckoBundle
[
]
toBundle
=
bundle
.
getBundleArray
(
"
targetLanguages
"
)
;
for
(
final
var
item
:
toBundle
)
{
final
var
result
=
Language
.
fromBundle
(
item
)
;
if
(
result
!
=
null
)
{
toLanguages
.
add
(
result
)
;
}
}
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
An
issue
occurred
while
deserializing
translation
support
information
:
"
+
e
)
;
}
return
new
TranslationSupport
(
fromLanguages
toLanguages
)
;
}
}
public
static
class
LanguageModel
{
public
final
Nullable
Language
language
;
public
final
NonNull
Boolean
isDownloaded
;
public
final
long
size
;
public
LanguageModel
(
Nullable
final
Language
language
final
Boolean
isDownloaded
final
long
size
)
{
this
.
language
=
language
;
this
.
isDownloaded
=
isDownloaded
;
this
.
size
=
size
;
}
Override
public
String
toString
(
)
{
return
"
LanguageModel
{
"
+
"
language
=
"
+
language
+
"
isDownloaded
=
"
+
isDownloaded
+
"
size
=
"
+
size
+
'
}
'
;
}
static
Nullable
LanguageModel
fromBundle
(
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
return
null
;
}
try
{
final
var
language
=
Language
.
fromBundle
(
bundle
)
;
final
var
isDownloaded
=
bundle
.
getBoolean
(
"
isDownloaded
"
)
;
final
var
size
=
bundle
.
getLong
(
"
size
"
)
;
return
new
LanguageModel
(
language
isDownloaded
size
)
;
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
Could
not
deserialize
LanguageModel
object
:
"
+
e
)
;
return
null
;
}
}
}
Retention
(
RetentionPolicy
.
SOURCE
)
StringDef
(
value
=
{
ALWAYS
OFFER
NEVER
}
)
public
interface
LanguageSetting
{
}
public
static
final
String
ALWAYS
=
"
always
"
;
public
static
final
String
OFFER
=
"
offer
"
;
public
static
final
String
NEVER
=
"
never
"
;
}
public
static
class
SessionTranslation
{
private
static
final
String
TRANSLATE_EVENT
=
"
GeckoView
:
Translations
:
Translate
"
;
private
static
final
String
RESTORE_PAGE_EVENT
=
"
GeckoView
:
Translations
:
RestorePage
"
;
private
static
final
String
GET_NEVER_TRANSLATE_SITE
=
"
GeckoView
:
Translations
:
GetNeverTranslateSite
"
;
private
static
final
String
SET_NEVER_TRANSLATE_SITE
=
"
GeckoView
:
Translations
:
SetNeverTranslateSite
"
;
private
static
final
String
ON_OFFER_EVENT
=
"
GeckoView
:
Translations
:
Offer
"
;
private
static
final
String
ON_STATE_CHANGE_EVENT
=
"
GeckoView
:
Translations
:
StateChange
"
;
private
final
GeckoSession
mSession
;
private
final
SessionTranslation
.
Handler
mHandler
;
public
SessionTranslation
(
final
GeckoSession
session
)
{
mSession
=
session
;
mHandler
=
new
SessionTranslation
.
Handler
(
mSession
)
;
}
AnyThread
public
NonNull
Handler
getHandler
(
)
{
return
mHandler
;
}
AnyThread
public
NonNull
GeckoResult
<
Void
>
translate
(
NonNull
final
String
fromLanguage
NonNull
final
String
toLanguage
Nullable
final
TranslationOptions
options
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Translate
page
requested
-
fromLanguage
:
"
+
fromLanguage
+
"
toLanguage
:
"
+
toLanguage
+
"
options
:
"
+
options
)
;
}
if
(
options
!
=
null
&
&
options
.
downloadModel
=
=
false
)
{
final
var
translateResult
=
new
GeckoResult
<
Void
>
(
)
;
TranslationsController
.
RuntimeTranslation
.
checkPairDownloadSize
(
fromLanguage
toLanguage
)
.
then
(
(
GeckoResult
.
OnValueListener
<
Long
Void
>
)
downloadBytes
-
>
{
if
(
downloadBytes
>
0
)
{
translateResult
.
completeExceptionally
(
new
TranslationsException
(
TranslationsException
.
ERROR_MODEL_DOWNLOAD_REQUIRED
)
)
;
}
else
{
translateResult
.
completeFrom
(
this
.
baseTranslate
(
fromLanguage
toLanguage
)
)
;
}
return
null
;
}
)
;
return
translateResult
;
}
return
this
.
baseTranslate
(
fromLanguage
toLanguage
)
;
}
AnyThread
public
NonNull
GeckoResult
<
Void
>
translate
(
NonNull
final
TranslationPair
translationPair
Nullable
final
TranslationOptions
options
)
{
return
translate
(
translationPair
.
fromLanguage
translationPair
.
toLanguage
options
)
;
}
AnyThread
private
NonNull
GeckoResult
<
Void
>
baseTranslate
(
NonNull
final
String
sourceLanguage
NonNull
final
String
targetLanguage
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
2
)
;
bundle
.
putString
(
"
sourceLanguage
"
sourceLanguage
)
;
bundle
.
putString
(
"
targetLanguage
"
targetLanguage
)
;
return
mSession
.
getEventDispatcher
(
)
.
queryVoid
(
TRANSLATE_EVENT
bundle
)
.
map
(
result
-
>
result
exception
-
>
new
TranslationsException
(
TranslationsException
.
ERROR_COULD_NOT_TRANSLATE
)
)
;
}
AnyThread
public
NonNull
GeckoResult
<
Void
>
restoreOriginalPage
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Restore
translated
page
requested
"
)
;
}
return
mSession
.
getEventDispatcher
(
)
.
queryVoid
(
RESTORE_PAGE_EVENT
)
.
map
(
result
-
>
result
exception
-
>
new
TranslationsException
(
TranslationsException
.
ERROR_COULD_NOT_RESTORE
)
)
;
}
AnyThread
public
NonNull
GeckoResult
<
Boolean
>
getNeverTranslateSiteSetting
(
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Retrieving
never
translate
site
setting
.
"
)
;
}
return
mSession
.
getEventDispatcher
(
)
.
queryBoolean
(
GET_NEVER_TRANSLATE_SITE
)
;
}
AnyThread
public
NonNull
GeckoResult
<
Void
>
setNeverTranslateSiteSetting
(
final
NonNull
Boolean
neverTranslate
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Setting
never
translate
site
.
"
)
;
}
final
GeckoBundle
bundle
=
new
GeckoBundle
(
2
)
;
bundle
.
putBoolean
(
"
neverTranslate
"
neverTranslate
)
;
return
mSession
.
getEventDispatcher
(
)
.
queryVoid
(
SET_NEVER_TRANSLATE_SITE
bundle
)
;
}
AnyThread
public
static
class
TranslationOptions
{
public
final
NonNull
boolean
downloadModel
;
protected
TranslationOptions
(
final
NonNull
Builder
builder
)
{
this
.
downloadModel
=
builder
.
mDownloadModel
;
}
AnyThread
public
static
class
Builder
{
boolean
mDownloadModel
=
true
;
public
NonNull
Builder
downloadModel
(
final
NonNull
boolean
downloadModel
)
{
mDownloadModel
=
downloadModel
;
return
this
;
}
AnyThread
public
NonNull
TranslationOptions
build
(
)
{
return
new
TranslationOptions
(
this
)
;
}
}
}
AnyThread
public
interface
Delegate
{
default
void
onOfferTranslate
(
NonNull
final
GeckoSession
session
)
{
}
default
void
onExpectedTranslate
(
NonNull
final
GeckoSession
session
)
{
}
default
void
onTranslationStateChange
(
NonNull
final
GeckoSession
session
Nullable
TranslationState
translationState
)
{
}
}
public
static
class
TranslationPair
{
public
final
Nullable
String
fromLanguage
;
public
final
Nullable
String
toLanguage
;
public
TranslationPair
(
Nullable
final
String
fromLanguage
Nullable
final
String
toLanguage
)
{
this
.
fromLanguage
=
fromLanguage
;
this
.
toLanguage
=
toLanguage
;
}
Override
public
String
toString
(
)
{
return
"
TranslationPair
{
"
+
"
fromLanguage
=
'
"
+
fromLanguage
+
'
\
'
'
+
"
toLanguage
=
'
"
+
toLanguage
+
'
\
'
'
+
'
}
'
;
}
static
Nullable
TranslationPair
fromBundle
(
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
return
null
;
}
return
new
TranslationPair
(
bundle
.
getString
(
"
sourceLanguage
"
)
bundle
.
getString
(
"
targetLanguage
"
)
)
;
}
}
public
static
class
DetectedLanguages
{
public
final
Nullable
String
userLangTag
;
public
final
NonNull
Boolean
isDocLangTagSupported
;
public
final
Nullable
String
docLangTag
;
public
DetectedLanguages
(
Nullable
final
String
userLangTag
NonNull
final
Boolean
isDocLangTagSupported
Nullable
final
String
docLangTag
)
{
this
.
userLangTag
=
userLangTag
;
this
.
isDocLangTagSupported
=
isDocLangTagSupported
;
this
.
docLangTag
=
docLangTag
;
}
Override
public
String
toString
(
)
{
return
"
DetectedLanguages
{
"
+
"
userLangTag
=
'
"
+
userLangTag
+
'
\
'
'
+
"
isDocLangTagSupported
=
"
+
isDocLangTagSupported
+
"
docLangTag
=
'
"
+
docLangTag
+
'
\
'
'
+
'
}
'
;
}
static
Nullable
DetectedLanguages
fromBundle
(
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
return
null
;
}
return
new
DetectedLanguages
(
bundle
.
getString
(
"
userLangTag
"
)
bundle
.
getBoolean
(
"
isDocLangTagSupported
"
false
)
bundle
.
getString
(
"
docLangTag
"
)
)
;
}
}
public
static
class
TranslationState
{
public
final
Nullable
TranslationPair
requestedTranslationPair
;
public
final
Nullable
String
error
;
public
final
Nullable
DetectedLanguages
detectedLanguages
;
public
final
NonNull
Boolean
isEngineReady
;
public
final
NonNull
Boolean
hasVisibleChange
;
public
TranslationState
(
final
Nullable
TranslationPair
requestedTranslationPair
final
Nullable
String
error
final
Nullable
DetectedLanguages
detectedLanguages
final
NonNull
Boolean
isEngineReady
final
NonNull
Boolean
hasVisibleChange
)
{
this
.
requestedTranslationPair
=
requestedTranslationPair
;
this
.
error
=
error
;
this
.
detectedLanguages
=
detectedLanguages
;
this
.
isEngineReady
=
isEngineReady
;
this
.
hasVisibleChange
=
hasVisibleChange
;
}
Override
public
String
toString
(
)
{
return
"
TranslationState
{
"
+
"
requestedTranslationPair
=
"
+
requestedTranslationPair
+
"
error
=
'
"
+
error
+
'
\
'
'
+
"
detectedLanguages
=
"
+
detectedLanguages
+
"
isEngineReady
=
"
+
isEngineReady
+
"
hasVisibleChange
=
"
+
hasVisibleChange
+
'
}
'
;
}
static
Nullable
TranslationState
fromBundle
(
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
return
null
;
}
return
new
TranslationState
(
TranslationPair
.
fromBundle
(
bundle
.
getBundle
(
"
requestedLanguagePair
"
)
)
bundle
.
getString
(
"
error
"
)
DetectedLanguages
.
fromBundle
(
bundle
.
getBundle
(
"
detectedLanguages
"
)
)
bundle
.
getBoolean
(
"
isEngineReady
"
false
)
bundle
.
getBoolean
(
"
hasVisibleChange
"
false
)
)
;
}
}
static
class
Handler
extends
GeckoSessionHandler
<
SessionTranslation
.
Delegate
>
{
private
final
GeckoSession
mSession
;
private
Handler
(
final
GeckoSession
session
)
{
super
(
"
GeckoViewTranslations
"
session
new
String
[
]
{
ON_OFFER_EVENT
ON_STATE_CHANGE_EVENT
}
)
;
mSession
=
session
;
}
Override
public
void
handleMessage
(
final
Delegate
delegate
final
String
event
final
GeckoBundle
message
final
EventCallback
callback
)
{
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
handleMessage
"
+
event
)
;
}
if
(
delegate
=
=
null
)
{
Log
.
w
(
LOGTAG
"
The
translations
session
delegate
is
not
set
.
"
)
;
return
;
}
if
(
ON_OFFER_EVENT
.
equals
(
event
)
)
{
delegate
.
onOfferTranslate
(
mSession
)
;
return
;
}
else
if
(
ON_STATE_CHANGE_EVENT
.
equals
(
event
)
)
{
final
GeckoBundle
data
=
message
.
getBundle
(
"
data
"
)
;
final
TranslationState
translationState
=
TranslationState
.
fromBundle
(
data
)
;
if
(
DEBUG
)
{
Log
.
d
(
LOGTAG
"
Received
translation
state
:
"
+
translationState
)
;
}
delegate
.
onTranslationStateChange
(
mSession
translationState
)
;
if
(
translationState
!
=
null
&
&
translationState
.
detectedLanguages
!
=
null
&
&
translationState
.
detectedLanguages
.
docLangTag
!
=
null
&
&
translationState
.
detectedLanguages
.
userLangTag
!
=
null
&
&
translationState
.
detectedLanguages
.
isDocLangTagSupported
)
{
TranslationsController
.
RuntimeTranslation
.
isTranslationsEngineSupported
(
)
.
then
(
(
GeckoResult
.
OnValueListener
<
Boolean
Void
>
)
value
-
>
{
if
(
value
)
{
delegate
.
onExpectedTranslate
(
mSession
)
;
}
return
null
;
}
)
;
return
;
}
}
}
}
}
public
static
class
Language
implements
Comparable
<
Language
>
{
public
final
NonNull
String
code
;
public
final
Nullable
String
localizedDisplayName
;
public
Language
(
NonNull
final
String
code
Nullable
final
String
localizedDisplayName
)
{
this
.
code
=
code
;
this
.
localizedDisplayName
=
localizedDisplayName
;
}
Override
public
String
toString
(
)
{
if
(
localizedDisplayName
!
=
null
)
{
return
localizedDisplayName
;
}
return
code
;
}
Override
AnyThread
public
int
compareTo
(
Nullable
final
Language
otherLanguage
)
{
return
this
.
localizedDisplayName
.
compareTo
(
otherLanguage
.
localizedDisplayName
)
;
}
Override
public
boolean
equals
(
Nullable
final
Object
otherLanguage
)
{
if
(
otherLanguage
instanceof
Language
)
{
return
this
.
code
.
equals
(
(
(
Language
)
otherLanguage
)
.
code
)
;
}
return
false
;
}
Override
public
int
hashCode
(
)
{
return
Objects
.
hash
(
code
)
;
}
static
Nullable
Language
fromBundle
(
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
return
null
;
}
try
{
final
String
variant
=
bundle
.
getString
(
"
variant
"
"
"
)
;
if
(
!
variant
.
isEmpty
(
)
)
{
return
null
;
}
final
String
code
=
bundle
.
getString
(
"
langTag
"
"
"
)
;
if
(
code
.
equals
(
"
"
)
)
{
Log
.
w
(
LOGTAG
"
Deserialized
an
empty
language
code
.
"
)
;
}
return
new
Language
(
code
bundle
.
getString
(
"
displayName
"
)
)
;
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
Could
not
deserialize
language
object
:
"
+
e
)
;
return
null
;
}
}
}
public
static
class
TranslationsException
extends
Exception
{
public
TranslationsException
(
final
Code
int
code
)
{
this
.
code
=
code
;
}
public
static
final
int
ERROR_UNKNOWN
=
-
1
;
public
static
final
int
ERROR_ENGINE_NOT_SUPPORTED
=
-
2
;
public
static
final
int
ERROR_COULD_NOT_TRANSLATE
=
-
3
;
public
static
final
int
ERROR_COULD_NOT_RESTORE
=
-
4
;
public
static
final
int
ERROR_COULD_NOT_LOAD_LANGUAGES
=
-
5
;
public
static
final
int
ERROR_LANGUAGE_NOT_SUPPORTED
=
-
6
;
public
static
final
int
ERROR_MODEL_COULD_NOT_RETRIEVE
=
-
7
;
public
static
final
int
ERROR_MODEL_COULD_NOT_DELETE
=
-
8
;
public
static
final
int
ERROR_MODEL_COULD_NOT_DOWNLOAD
=
-
9
;
public
static
final
int
ERROR_MODEL_LANGUAGE_REQUIRED
=
-
10
;
public
static
final
int
ERROR_MODEL_DOWNLOAD_REQUIRED
=
-
11
;
Retention
(
RetentionPolicy
.
SOURCE
)
IntDef
(
value
=
{
ERROR_UNKNOWN
ERROR_ENGINE_NOT_SUPPORTED
ERROR_COULD_NOT_TRANSLATE
ERROR_COULD_NOT_RESTORE
ERROR_COULD_NOT_LOAD_LANGUAGES
ERROR_LANGUAGE_NOT_SUPPORTED
ERROR_MODEL_COULD_NOT_RETRIEVE
ERROR_MODEL_COULD_NOT_DELETE
ERROR_MODEL_COULD_NOT_DOWNLOAD
ERROR_MODEL_LANGUAGE_REQUIRED
ERROR_MODEL_DOWNLOAD_REQUIRED
}
)
public
interface
Code
{
}
public
final
Code
int
code
;
Override
public
String
toString
(
)
{
return
"
TranslationsException
:
"
+
code
;
}
}
}
