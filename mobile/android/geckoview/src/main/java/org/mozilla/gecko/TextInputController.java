package
org
.
mozilla
.
gecko
;
import
org
.
mozilla
.
gecko
.
util
.
ThreadUtils
;
import
android
.
os
.
Handler
;
import
android
.
support
.
annotation
.
NonNull
;
import
android
.
support
.
annotation
.
Nullable
;
import
android
.
view
.
KeyEvent
;
import
android
.
view
.
View
;
import
android
.
view
.
inputmethod
.
EditorInfo
;
import
android
.
view
.
inputmethod
.
InputConnection
;
public
final
class
TextInputController
{
interface
Delegate
{
View
getView
(
)
;
Handler
getHandler
(
Handler
defHandler
)
;
InputConnection
onCreateInputConnection
(
EditorInfo
attrs
)
;
boolean
onKeyPreIme
(
int
keyCode
KeyEvent
event
)
;
boolean
onKeyDown
(
int
keyCode
KeyEvent
event
)
;
boolean
onKeyUp
(
int
keyCode
KeyEvent
event
)
;
boolean
onKeyLongPress
(
int
keyCode
KeyEvent
event
)
;
boolean
onKeyMultiple
(
int
keyCode
int
repeatCount
KeyEvent
event
)
;
boolean
isInputActive
(
)
;
}
private
final
GeckoSession
mSession
;
private
final
GeckoEditable
mEditable
=
new
GeckoEditable
(
)
;
private
final
GeckoEditableChild
mEditableChild
=
new
GeckoEditableChild
(
mEditable
)
;
private
Delegate
mInputConnection
;
TextInputController
(
final
NonNull
GeckoSession
session
)
{
mSession
=
session
;
mEditable
.
setDefaultEditableChild
(
mEditableChild
)
;
}
void
onWindowReady
(
final
NativeQueue
queue
final
GeckoSession
.
Window
window
)
{
if
(
queue
.
isReady
(
)
)
{
window
.
attachEditable
(
mEditable
mEditableChild
)
;
}
else
{
queue
.
queueUntilReady
(
window
"
attachEditable
"
IGeckoEditableParent
.
class
mEditable
GeckoEditableChild
.
class
mEditableChild
)
;
}
}
public
NonNull
Handler
getHandler
(
final
NonNull
Handler
defHandler
)
{
if
(
mInputConnection
!
=
null
)
{
return
mInputConnection
.
getHandler
(
defHandler
)
;
}
return
defHandler
;
}
private
synchronized
void
ensureInputConnection
(
)
{
if
(
mInputConnection
=
=
null
)
{
mInputConnection
=
GeckoInputConnection
.
create
(
mSession
null
mEditable
)
;
mEditable
.
setListener
(
(
GeckoEditableListener
)
mInputConnection
)
;
}
}
public
Nullable
View
getView
(
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
return
mInputConnection
!
=
null
?
mInputConnection
.
getView
(
)
:
null
;
}
public
synchronized
void
setView
(
final
Nullable
View
view
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
if
(
view
=
=
null
)
{
mInputConnection
=
null
;
}
else
if
(
mInputConnection
=
=
null
|
|
mInputConnection
.
getView
(
)
!
=
view
)
{
mInputConnection
=
GeckoInputConnection
.
create
(
mSession
view
mEditable
)
;
}
mEditable
.
setListener
(
(
GeckoEditableListener
)
mInputConnection
)
;
}
public
synchronized
Nullable
InputConnection
onCreateInputConnection
(
final
NonNull
EditorInfo
attrs
)
{
ensureInputConnection
(
)
;
return
mInputConnection
.
onCreateInputConnection
(
attrs
)
;
}
public
boolean
onKeyPreIme
(
final
int
keyCode
final
NonNull
KeyEvent
event
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
ensureInputConnection
(
)
;
return
mInputConnection
.
onKeyPreIme
(
keyCode
event
)
;
}
public
boolean
onKeyDown
(
final
int
keyCode
final
NonNull
KeyEvent
event
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
ensureInputConnection
(
)
;
return
mInputConnection
.
onKeyDown
(
keyCode
event
)
;
}
public
boolean
onKeyUp
(
final
int
keyCode
final
NonNull
KeyEvent
event
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
ensureInputConnection
(
)
;
return
mInputConnection
.
onKeyUp
(
keyCode
event
)
;
}
public
boolean
onKeyLongPress
(
final
int
keyCode
final
NonNull
KeyEvent
event
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
ensureInputConnection
(
)
;
return
mInputConnection
.
onKeyLongPress
(
keyCode
event
)
;
}
public
boolean
onKeyMultiple
(
final
int
keyCode
final
int
repeatCount
final
NonNull
KeyEvent
event
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
ensureInputConnection
(
)
;
return
mInputConnection
.
onKeyMultiple
(
keyCode
repeatCount
event
)
;
}
public
boolean
isInputActive
(
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
return
mInputConnection
!
=
null
&
&
mInputConnection
.
isInputActive
(
)
;
}
}
