package
org
.
mozilla
.
geckoview
;
import
android
.
util
.
Log
;
import
androidx
.
annotation
.
AnyThread
;
import
androidx
.
annotation
.
IntDef
;
import
androidx
.
annotation
.
NonNull
;
import
androidx
.
annotation
.
Nullable
;
import
androidx
.
annotation
.
UiThread
;
import
java
.
lang
.
annotation
.
Retention
;
import
java
.
lang
.
annotation
.
RetentionPolicy
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
List
;
import
java
.
util
.
Map
;
import
java
.
util
.
Objects
;
import
org
.
mozilla
.
gecko
.
EventDispatcher
;
import
org
.
mozilla
.
gecko
.
util
.
GeckoBundle
;
ExperimentalGeckoViewApi
public
class
GeckoPreferenceController
{
private
static
final
String
LOGTAG
=
"
GeckoPreference
"
;
private
static
final
boolean
DEBUG
=
false
;
private
static
final
String
GET_PREF
=
"
GeckoView
:
Preferences
:
GetPref
"
;
private
static
final
String
SET_PREF
=
"
GeckoView
:
Preferences
:
SetPref
"
;
private
static
final
String
CLEAR_PREF
=
"
GeckoView
:
Preferences
:
ClearPref
"
;
AnyThread
public
static
NonNull
GeckoResult
<
GeckoPreference
<
?
>
>
getGeckoPref
(
NonNull
final
String
prefName
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putStringArray
(
"
prefs
"
List
.
of
(
prefName
)
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
GET_PREF
bundle
)
.
map
(
result
-
>
{
if
(
result
=
=
null
)
{
throw
new
Exception
(
"
Received
a
null
preference
message
.
"
)
;
}
final
GeckoBundle
[
]
prefsBundle
=
result
.
getBundleArray
(
"
prefs
"
)
;
if
(
prefsBundle
!
=
null
&
&
prefsBundle
.
length
=
=
1
)
{
final
var
deserialized
=
GeckoPreference
.
fromBundle
(
prefsBundle
[
0
]
)
;
if
(
deserialized
=
=
null
)
{
throw
new
Exception
(
"
Could
not
deserialize
the
preference
.
"
)
;
}
return
deserialized
;
}
throw
new
Exception
(
"
Could
not
deserialize
the
preference
.
"
)
;
}
exception
-
>
new
Exception
(
"
Could
not
retrieve
the
preference
.
"
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
List
<
GeckoPreference
<
?
>
>
>
getGeckoPrefs
(
NonNull
final
List
<
String
>
prefNames
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putStringArray
(
"
prefs
"
prefNames
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
GET_PREF
bundle
)
.
map
(
result
-
>
{
if
(
result
=
=
null
)
{
throw
new
Exception
(
"
Received
a
null
preference
message
.
"
)
;
}
final
var
deserialized
=
GeckoPreference
.
fromBundleArray
(
result
)
;
if
(
deserialized
=
=
null
)
{
throw
new
Exception
(
"
Could
not
deserialize
the
preference
.
"
)
;
}
return
deserialized
;
}
exception
-
>
new
Exception
(
"
Could
not
retrieve
the
preferences
.
"
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setGeckoPref
(
NonNull
final
String
prefName
NonNull
final
String
value
PrefBranch
final
int
branch
)
{
final
var
pref
=
SetGeckoPreference
.
setStringPref
(
prefName
value
branch
)
;
final
GeckoBundle
requestBundle
=
new
GeckoBundle
(
1
)
;
requestBundle
.
putBundleArray
(
"
prefs
"
List
.
of
(
pref
.
toBundle
(
)
)
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
SET_PREF
requestBundle
)
.
map
(
result
-
>
{
if
(
GeckoPreferenceController
.
parseResponseFromSetting
(
result
)
)
{
return
null
;
}
throw
new
Exception
(
"
Unable
to
set
preference
.
"
)
;
}
exception
-
>
new
Exception
(
"
Could
not
retrieve
the
results
.
"
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setGeckoPref
(
NonNull
final
String
prefName
NonNull
final
Integer
value
PrefBranch
final
int
branch
)
{
final
var
pref
=
SetGeckoPreference
.
setIntPref
(
prefName
value
branch
)
;
final
GeckoBundle
requestBundle
=
new
GeckoBundle
(
1
)
;
requestBundle
.
putBundleArray
(
"
prefs
"
List
.
of
(
pref
.
toBundle
(
)
)
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
SET_PREF
requestBundle
)
.
map
(
result
-
>
{
if
(
GeckoPreferenceController
.
parseResponseFromSetting
(
result
)
)
{
return
null
;
}
throw
new
Exception
(
"
Unable
to
set
preference
.
"
)
;
}
exception
-
>
new
Exception
(
"
Could
not
retrieve
the
results
.
"
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setGeckoPref
(
NonNull
final
String
prefName
NonNull
final
Boolean
value
PrefBranch
final
int
branch
)
{
final
var
pref
=
SetGeckoPreference
.
setBoolPref
(
prefName
value
branch
)
;
final
GeckoBundle
requestBundle
=
new
GeckoBundle
(
1
)
;
requestBundle
.
putBundleArray
(
"
prefs
"
List
.
of
(
pref
.
toBundle
(
)
)
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
SET_PREF
requestBundle
)
.
map
(
result
-
>
{
if
(
GeckoPreferenceController
.
parseResponseFromSetting
(
result
)
)
{
return
null
;
}
throw
new
Exception
(
"
Unable
to
set
preference
.
"
)
;
}
exception
-
>
new
Exception
(
"
Could
not
retrieve
the
results
.
"
)
)
;
}
private
static
boolean
parseResponseFromSetting
(
final
GeckoBundle
result
)
throws
Exception
{
if
(
result
=
=
null
)
{
throw
new
Exception
(
"
Received
a
null
result
message
.
"
)
;
}
final
GeckoBundle
[
]
resultsBundle
=
result
.
getBundleArray
(
"
prefs
"
)
;
if
(
resultsBundle
=
=
null
)
{
throw
new
Exception
(
"
Received
a
null
result
bundle
.
"
)
;
}
boolean
isSet
=
false
;
if
(
resultsBundle
.
length
=
=
1
)
{
isSet
=
resultsBundle
[
0
]
.
getBoolean
(
"
isSet
"
)
;
}
return
isSet
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Map
<
String
Boolean
>
>
setGeckoPrefs
(
NonNull
final
List
<
SetGeckoPreference
<
?
>
>
prefs
)
{
final
List
<
GeckoBundle
>
itemBundles
=
new
ArrayList
<
>
(
prefs
.
size
(
)
)
;
for
(
final
SetGeckoPreference
<
?
>
pref
:
prefs
)
{
itemBundles
.
add
(
pref
.
toBundle
(
)
)
;
}
final
GeckoBundle
requestBundle
=
new
GeckoBundle
(
1
)
;
requestBundle
.
putBundleArray
(
"
prefs
"
itemBundles
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
SET_PREF
requestBundle
)
.
map
(
result
-
>
{
if
(
result
=
=
null
)
{
throw
new
Exception
(
"
Received
a
null
result
message
.
"
)
;
}
final
GeckoBundle
[
]
resultsBundle
=
result
.
getBundleArray
(
"
prefs
"
)
;
if
(
resultsBundle
=
=
null
)
{
throw
new
Exception
(
"
Received
a
null
result
bundle
.
"
)
;
}
final
Map
<
String
Boolean
>
resultMap
=
new
HashMap
<
>
(
resultsBundle
.
length
)
;
for
(
final
var
resultBundle
:
resultsBundle
)
{
final
String
pref
=
resultBundle
.
getString
(
"
pref
"
)
;
final
boolean
isSet
=
resultBundle
.
getBoolean
(
"
isSet
"
)
;
if
(
pref
=
=
null
)
{
throw
new
Exception
(
"
Received
a
null
preference
name
.
"
)
;
}
else
{
resultMap
.
put
(
pref
isSet
)
;
}
}
return
resultMap
;
}
exception
-
>
new
Exception
(
"
Could
not
retrieve
the
results
.
"
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
clearGeckoUserPref
(
NonNull
final
String
prefName
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
pref
"
prefName
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
CLEAR_PREF
bundle
)
;
}
public
static
final
class
Observer
{
private
static
final
String
REGISTER_PREF
=
"
GeckoView
:
Preferences
:
RegisterObserver
"
;
private
static
final
String
UNREGISTER_PREF
=
"
GeckoView
:
Preferences
:
UnregisterObserver
"
;
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
registerPreference
(
NonNull
final
String
preferenceName
)
{
return
registerPreferences
(
List
.
of
(
preferenceName
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
registerPreferences
(
NonNull
final
List
<
String
>
preferenceNames
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
)
;
bundle
.
putStringArray
(
"
prefs
"
preferenceNames
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
REGISTER_PREF
bundle
)
;
}
UiThread
public
static
NonNull
GeckoResult
<
Void
>
unregisterPreference
(
NonNull
final
String
preferenceName
)
{
return
unregisterPreferences
(
List
.
of
(
preferenceName
)
)
;
}
UiThread
public
static
NonNull
GeckoResult
<
Void
>
unregisterPreferences
(
NonNull
final
List
<
String
>
preferenceNames
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
)
;
bundle
.
putStringArray
(
"
prefs
"
preferenceNames
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
UNREGISTER_PREF
bundle
)
;
}
public
interface
Delegate
{
AnyThread
default
void
onGeckoPreferenceChange
(
NonNull
final
GeckoPreference
<
?
>
observedGeckoPreference
)
{
}
}
}
Retention
(
RetentionPolicy
.
SOURCE
)
IntDef
(
{
PREF_TYPE_INVALID
PREF_TYPE_STRING
PREF_TYPE_INT
PREF_TYPE_BOOL
}
)
public
interface
PrefType
{
}
public
static
final
int
PREF_TYPE_INVALID
=
0
;
public
static
final
int
PREF_TYPE_STRING
=
32
;
public
static
final
int
PREF_TYPE_INT
=
64
;
public
static
final
int
PREF_TYPE_BOOL
=
128
;
AnyThread
static
NonNull
String
toTypeString
(
PrefType
final
int
prefType
)
{
switch
(
prefType
)
{
case
PREF_TYPE_INVALID
:
return
"
PREF_INVALID
"
;
case
PREF_TYPE_STRING
:
return
"
PREF_STRING
"
;
case
PREF_TYPE_INT
:
return
"
PREF_INT
"
;
case
PREF_TYPE_BOOL
:
return
"
PREF_BOOL
"
;
default
:
return
"
UNKNOWN
"
;
}
}
Retention
(
RetentionPolicy
.
SOURCE
)
IntDef
(
{
PREF_BRANCH_USER
PREF_BRANCH_DEFAULT
}
)
public
interface
PrefBranch
{
}
public
static
final
int
PREF_BRANCH_USER
=
0
;
public
static
final
int
PREF_BRANCH_DEFAULT
=
1
;
AnyThread
static
NonNull
String
toBranchString
(
PrefBranch
final
int
prefBranch
)
{
switch
(
prefBranch
)
{
case
PREF_BRANCH_USER
:
return
"
user
"
;
case
PREF_BRANCH_DEFAULT
:
return
"
default
"
;
default
:
Log
.
w
(
LOGTAG
"
Tried
to
convert
an
unknown
pref
branch
of
"
+
prefBranch
+
"
!
"
)
;
return
"
default
"
;
}
}
public
static
class
SetGeckoPreference
<
T
>
{
public
final
NonNull
String
pref
;
public
final
NonNull
T
value
;
public
final
PrefBranch
int
branch
;
public
final
PrefType
int
type
;
private
SetGeckoPreference
(
NonNull
final
String
pref
NonNull
final
T
value
PrefBranch
final
int
branch
PrefType
final
int
type
)
{
this
.
pref
=
pref
;
this
.
value
=
value
;
this
.
branch
=
branch
;
this
.
type
=
type
;
}
AnyThread
public
static
NonNull
SetGeckoPreference
<
String
>
setStringPref
(
NonNull
final
String
pref
NonNull
final
String
value
PrefBranch
final
int
branch
)
{
return
new
SetGeckoPreference
<
>
(
pref
value
branch
PREF_TYPE_STRING
)
;
}
AnyThread
public
static
NonNull
SetGeckoPreference
<
Integer
>
setIntPref
(
NonNull
final
String
pref
NonNull
final
Integer
value
PrefBranch
final
int
branch
)
{
return
new
SetGeckoPreference
<
>
(
pref
value
branch
PREF_TYPE_INT
)
;
}
AnyThread
public
static
NonNull
SetGeckoPreference
<
Boolean
>
setBoolPref
(
NonNull
final
String
pref
NonNull
final
Boolean
value
PrefBranch
final
int
branch
)
{
return
new
SetGeckoPreference
<
>
(
pref
value
branch
PREF_TYPE_BOOL
)
;
}
AnyThread
NonNull
GeckoBundle
toBundle
(
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
4
)
;
bundle
.
putString
(
"
pref
"
this
.
pref
)
;
bundle
.
putString
(
"
branch
"
toBranchString
(
this
.
branch
)
)
;
bundle
.
putInt
(
"
type
"
this
.
type
)
;
switch
(
this
.
type
)
{
case
PREF_TYPE_INVALID
:
{
bundle
.
putString
(
"
value
"
null
)
;
return
bundle
;
}
case
PREF_TYPE_STRING
:
{
bundle
.
putString
(
"
value
"
(
String
)
this
.
value
)
;
return
bundle
;
}
case
PREF_TYPE_BOOL
:
{
bundle
.
putBoolean
(
"
value
"
(
boolean
)
this
.
value
)
;
return
bundle
;
}
case
PREF_TYPE_INT
:
{
bundle
.
putInt
(
"
value
"
(
int
)
this
.
value
)
;
return
bundle
;
}
default
:
{
bundle
.
putString
(
"
value
"
null
)
;
return
bundle
;
}
}
}
}
public
static
class
GeckoPreference
<
T
>
{
public
final
NonNull
String
pref
;
public
final
PrefType
int
type
;
public
final
Nullable
T
defaultValue
;
public
final
Nullable
T
userValue
;
AnyThread
public
Nullable
T
getValue
(
)
{
if
(
userValue
!
=
null
)
{
return
userValue
;
}
return
defaultValue
;
}
AnyThread
public
boolean
getHasUserChangedValue
(
)
{
return
userValue
!
=
null
;
}
GeckoPreference
(
NonNull
final
String
pref
PrefType
final
int
type
Nullable
final
T
defaultValue
Nullable
final
T
userValue
)
{
this
.
pref
=
pref
;
this
.
type
=
type
;
this
.
defaultValue
=
defaultValue
;
this
.
userValue
=
userValue
;
}
NonNull
Override
public
String
toString
(
)
{
final
StringBuilder
builder
=
new
StringBuilder
(
"
GeckoPreference
{
"
)
;
builder
.
append
(
"
pref
=
"
)
.
append
(
pref
)
.
append
(
"
type
=
"
)
.
append
(
toTypeString
(
type
)
)
.
append
(
"
defaultValue
=
"
)
.
append
(
Objects
.
toString
(
defaultValue
"
null
"
)
)
.
append
(
"
userValue
=
"
)
.
append
(
Objects
.
toString
(
userValue
"
null
"
)
)
.
append
(
"
}
"
)
;
return
builder
.
toString
(
)
;
}
static
Nullable
List
<
GeckoPreference
<
?
>
>
fromBundleArray
(
Nullable
final
GeckoBundle
bundle
)
{
if
(
bundle
!
=
null
)
{
try
{
final
GeckoBundle
[
]
prefsBundle
=
bundle
.
getBundleArray
(
"
prefs
"
)
;
if
(
prefsBundle
!
=
null
)
{
final
List
<
GeckoPreference
<
?
>
>
list
=
new
ArrayList
<
>
(
prefsBundle
.
length
)
;
for
(
final
var
prefBundle
:
prefsBundle
)
{
final
GeckoPreference
<
?
>
pref
=
GeckoPreference
.
fromBundle
(
prefBundle
)
;
if
(
pref
=
=
null
)
{
Log
.
w
(
LOGTAG
"
An
issue
occurred
when
deserializing
one
of
the
GeckoPreferences
.
"
)
;
return
null
;
}
list
.
add
(
pref
)
;
}
return
list
;
}
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
An
issue
occurred
when
deserializing
a
map
of
GeckoPreferences
:
"
+
e
)
;
return
null
;
}
}
Log
.
w
(
LOGTAG
"
The
bundle
was
null
when
deserializing
a
map
of
GeckoPreferences
.
"
)
;
return
null
;
}
static
Nullable
GeckoPreference
<
?
>
fromBundle
(
Nullable
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
Log
.
w
(
LOGTAG
"
Bundle
is
null
when
attempting
to
deserialize
a
GeckoPreference
.
"
)
;
return
null
;
}
try
{
final
String
pref
=
bundle
.
getString
(
"
pref
"
"
"
)
;
if
(
pref
.
isEmpty
(
)
)
{
Log
.
w
(
LOGTAG
"
Deserialized
an
empty
preference
name
.
"
)
;
return
null
;
}
final
int
type
=
bundle
.
getInt
(
"
type
"
0
)
;
switch
(
type
)
{
case
PREF_TYPE_INVALID
:
{
return
new
GeckoPreference
<
Object
>
(
pref
type
null
null
)
;
}
case
PREF_TYPE_STRING
:
{
final
String
defaultValue
=
bundle
.
getString
(
"
defaultValue
"
)
;
final
String
userValue
=
bundle
.
getString
(
"
userValue
"
)
;
return
new
GeckoPreference
<
String
>
(
pref
type
defaultValue
userValue
)
;
}
case
PREF_TYPE_BOOL
:
{
final
Boolean
defaultValue
=
bundle
.
getBooleanObject
(
"
defaultValue
"
)
;
final
Boolean
userValue
=
bundle
.
getBooleanObject
(
"
userValue
"
)
;
return
new
GeckoPreference
<
Boolean
>
(
pref
type
defaultValue
userValue
)
;
}
case
PREF_TYPE_INT
:
{
final
Integer
defaultValue
=
bundle
.
getInteger
(
"
defaultValue
"
)
;
final
Integer
userValue
=
bundle
.
getInteger
(
"
userValue
"
)
;
return
new
GeckoPreference
<
Integer
>
(
pref
type
defaultValue
userValue
)
;
}
default
:
{
Log
.
w
(
LOGTAG
"
Deserialized
an
unexpected
preference
type
of
"
+
type
+
"
.
"
)
;
return
null
;
}
}
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
Could
not
deserialize
GeckoPreference
object
:
"
+
e
)
;
return
null
;
}
}
}
}
