package
org
.
mozilla
.
geckoview
;
import
android
.
util
.
Log
;
import
androidx
.
annotation
.
AnyThread
;
import
androidx
.
annotation
.
IntDef
;
import
androidx
.
annotation
.
NonNull
;
import
androidx
.
annotation
.
Nullable
;
import
androidx
.
annotation
.
UiThread
;
import
java
.
lang
.
annotation
.
Retention
;
import
java
.
lang
.
annotation
.
RetentionPolicy
;
import
java
.
util
.
List
;
import
java
.
util
.
Objects
;
import
org
.
mozilla
.
gecko
.
EventDispatcher
;
import
org
.
mozilla
.
gecko
.
util
.
GeckoBundle
;
public
class
GeckoPreferenceController
{
private
static
final
String
LOGTAG
=
"
GeckoPreference
"
;
private
static
final
boolean
DEBUG
=
false
;
private
static
final
String
GET_PREF
=
"
GeckoView
:
Preferences
:
GetPref
"
;
private
static
final
String
SET_PREF
=
"
GeckoView
:
Preferences
:
SetPref
"
;
private
static
final
String
CLEAR_PREF
=
"
GeckoView
:
Preferences
:
ClearPref
"
;
AnyThread
public
static
NonNull
GeckoResult
<
GeckoPreference
<
?
>
>
getGeckoPref
(
NonNull
final
String
prefName
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
pref
"
prefName
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryBundle
(
GET_PREF
bundle
)
.
map
(
GeckoPreference
:
:
fromBundle
exception
-
>
new
Exception
(
"
Could
not
retrieve
the
preference
.
"
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setGeckoPref
(
NonNull
final
String
prefName
NonNull
final
String
value
PrefBranch
final
int
branch
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
pref
"
prefName
)
;
bundle
.
putString
(
"
value
"
value
)
;
bundle
.
putString
(
"
branch
"
toBranchString
(
branch
)
)
;
bundle
.
putInt
(
"
type
"
PREF_TYPE_STRING
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
SET_PREF
bundle
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setGeckoPref
(
NonNull
final
String
prefName
NonNull
final
Integer
value
PrefBranch
final
int
branch
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
pref
"
prefName
)
;
bundle
.
putInt
(
"
value
"
value
)
;
bundle
.
putString
(
"
branch
"
toBranchString
(
branch
)
)
;
bundle
.
putInt
(
"
type
"
PREF_TYPE_INT
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
SET_PREF
bundle
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
setGeckoPref
(
NonNull
final
String
prefName
NonNull
final
Boolean
value
PrefBranch
final
int
branch
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
pref
"
prefName
)
;
bundle
.
putBoolean
(
"
value
"
value
)
;
bundle
.
putString
(
"
branch
"
toBranchString
(
branch
)
)
;
bundle
.
putInt
(
"
type
"
PREF_TYPE_BOOL
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
SET_PREF
bundle
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
clearGeckoUserPref
(
NonNull
final
String
prefName
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
1
)
;
bundle
.
putString
(
"
pref
"
prefName
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
CLEAR_PREF
bundle
)
;
}
public
static
final
class
Observer
{
private
static
final
String
REGISTER_PREF
=
"
GeckoView
:
Preferences
:
RegisterObserver
"
;
private
static
final
String
UNREGISTER_PREF
=
"
GeckoView
:
Preferences
:
UnregisterObserver
"
;
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
registerPreference
(
NonNull
final
String
preferenceName
)
{
return
registerPreferences
(
List
.
of
(
preferenceName
)
)
;
}
AnyThread
public
static
NonNull
GeckoResult
<
Void
>
registerPreferences
(
NonNull
final
List
<
String
>
preferenceNames
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
)
;
bundle
.
putStringArray
(
"
prefs
"
preferenceNames
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
REGISTER_PREF
bundle
)
;
}
UiThread
public
static
NonNull
GeckoResult
<
Void
>
unregisterPreference
(
NonNull
final
String
preferenceName
)
{
return
unregisterPreferences
(
List
.
of
(
preferenceName
)
)
;
}
UiThread
public
static
NonNull
GeckoResult
<
Void
>
unregisterPreferences
(
NonNull
final
List
<
String
>
preferenceNames
)
{
final
GeckoBundle
bundle
=
new
GeckoBundle
(
)
;
bundle
.
putStringArray
(
"
prefs
"
preferenceNames
)
;
return
EventDispatcher
.
getInstance
(
)
.
queryVoid
(
UNREGISTER_PREF
bundle
)
;
}
public
interface
Delegate
{
AnyThread
default
void
onGeckoPreferenceChange
(
NonNull
final
GeckoPreference
<
?
>
observedGeckoPreference
)
{
}
}
}
Retention
(
RetentionPolicy
.
SOURCE
)
IntDef
(
{
PREF_TYPE_INVALID
PREF_TYPE_STRING
PREF_TYPE_INT
PREF_TYPE_BOOL
}
)
public
interface
PrefType
{
}
public
static
final
int
PREF_TYPE_INVALID
=
0
;
public
static
final
int
PREF_TYPE_STRING
=
32
;
public
static
final
int
PREF_TYPE_INT
=
64
;
public
static
final
int
PREF_TYPE_BOOL
=
128
;
AnyThread
static
NonNull
String
toTypeString
(
PrefType
final
int
prefType
)
{
switch
(
prefType
)
{
case
PREF_TYPE_INVALID
:
return
"
PREF_INVALID
"
;
case
PREF_TYPE_STRING
:
return
"
PREF_STRING
"
;
case
PREF_TYPE_INT
:
return
"
PREF_INT
"
;
case
PREF_TYPE_BOOL
:
return
"
PREF_BOOL
"
;
default
:
return
"
UNKNOWN
"
;
}
}
Retention
(
RetentionPolicy
.
SOURCE
)
IntDef
(
{
PREF_BRANCH_USER
PREF_BRANCH_DEFAULT
}
)
public
interface
PrefBranch
{
}
public
static
final
int
PREF_BRANCH_USER
=
0
;
public
static
final
int
PREF_BRANCH_DEFAULT
=
1
;
AnyThread
static
NonNull
String
toBranchString
(
PrefBranch
final
int
prefBranch
)
{
switch
(
prefBranch
)
{
case
PREF_BRANCH_USER
:
return
"
user
"
;
case
PREF_BRANCH_DEFAULT
:
return
"
default
"
;
default
:
Log
.
w
(
LOGTAG
"
Tried
to
convert
an
unknown
pref
branch
of
"
+
prefBranch
+
"
!
"
)
;
return
"
default
"
;
}
}
public
static
class
GeckoPreference
<
T
>
{
public
final
NonNull
String
pref
;
public
final
PrefType
int
type
;
public
final
Nullable
T
defaultValue
;
public
final
Nullable
T
userValue
;
AnyThread
public
Nullable
T
getValue
(
)
{
if
(
userValue
!
=
null
)
{
return
userValue
;
}
return
defaultValue
;
}
AnyThread
public
boolean
getHasUserChangedValue
(
)
{
return
userValue
!
=
null
;
}
GeckoPreference
(
NonNull
final
String
pref
PrefType
final
int
type
Nullable
final
T
defaultValue
Nullable
final
T
userValue
)
{
this
.
pref
=
pref
;
this
.
type
=
type
;
this
.
defaultValue
=
defaultValue
;
this
.
userValue
=
userValue
;
}
NonNull
Override
public
String
toString
(
)
{
final
StringBuilder
builder
=
new
StringBuilder
(
"
GeckoPreference
{
"
)
;
builder
.
append
(
"
pref
=
"
)
.
append
(
pref
)
.
append
(
"
type
=
"
)
.
append
(
toTypeString
(
type
)
)
.
append
(
"
defaultValue
=
"
)
.
append
(
Objects
.
toString
(
defaultValue
"
null
"
)
)
.
append
(
"
userValue
=
"
)
.
append
(
Objects
.
toString
(
userValue
"
null
"
)
)
.
append
(
"
}
"
)
;
return
builder
.
toString
(
)
;
}
static
Nullable
GeckoPreference
<
?
>
fromBundle
(
Nullable
final
GeckoBundle
bundle
)
{
if
(
bundle
=
=
null
)
{
Log
.
w
(
LOGTAG
"
Bundle
is
null
when
attempting
to
deserialize
a
GeckoPreference
.
"
)
;
return
null
;
}
try
{
final
String
pref
=
bundle
.
getString
(
"
pref
"
"
"
)
;
if
(
pref
.
isEmpty
(
)
)
{
Log
.
w
(
LOGTAG
"
Deserialized
an
empty
preference
name
.
"
)
;
return
null
;
}
final
int
type
=
bundle
.
getInt
(
"
type
"
0
)
;
switch
(
type
)
{
case
PREF_TYPE_INVALID
:
{
return
new
GeckoPreference
<
Object
>
(
pref
type
null
null
)
;
}
case
PREF_TYPE_STRING
:
{
final
String
defaultValue
=
bundle
.
getString
(
"
defaultValue
"
)
;
final
String
userValue
=
bundle
.
getString
(
"
userValue
"
)
;
return
new
GeckoPreference
<
String
>
(
pref
type
defaultValue
userValue
)
;
}
case
PREF_TYPE_BOOL
:
{
final
Boolean
defaultValue
=
bundle
.
getBooleanObject
(
"
defaultValue
"
)
;
final
Boolean
userValue
=
bundle
.
getBooleanObject
(
"
userValue
"
)
;
return
new
GeckoPreference
<
Boolean
>
(
pref
type
defaultValue
userValue
)
;
}
case
PREF_TYPE_INT
:
{
final
Integer
defaultValue
=
bundle
.
getInteger
(
"
defaultValue
"
)
;
final
Integer
userValue
=
bundle
.
getInteger
(
"
userValue
"
)
;
return
new
GeckoPreference
<
Integer
>
(
pref
type
defaultValue
userValue
)
;
}
default
:
{
Log
.
w
(
LOGTAG
"
Deserialized
an
unexpected
preference
type
of
"
+
type
+
"
.
"
)
;
return
null
;
}
}
}
catch
(
final
Exception
e
)
{
Log
.
w
(
LOGTAG
"
Could
not
deserialize
GeckoPreference
object
:
"
+
e
)
;
return
null
;
}
}
}
}
