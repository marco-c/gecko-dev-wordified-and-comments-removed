"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
GeckoViewContentParent
"
]
;
const
{
GeckoViewUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
GeckoViewUtils
.
sys
.
mjs
"
)
;
const
{
GeckoViewActorParent
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
GeckoViewActorParent
.
sys
.
mjs
"
)
;
const
lazy
=
{
}
;
ChromeUtils
.
defineESModuleGetters
(
lazy
{
SessionHistory
:
"
resource
:
/
/
gre
/
modules
/
sessionstore
/
SessionHistory
.
sys
.
mjs
"
}
)
;
const
{
debug
warn
}
=
GeckoViewUtils
.
initLogging
(
"
GeckoViewContentParent
"
)
;
class
GeckoViewContentParent
extends
GeckoViewActorParent
{
async
collectState
(
)
{
return
this
.
sendQuery
(
"
CollectSessionState
"
)
;
}
async
containsFormData
(
)
{
return
this
.
sendQuery
(
"
ContainsFormData
"
)
;
}
restoreState
(
{
history
switchId
formdata
scrolldata
}
)
{
if
(
Services
.
appinfo
.
sessionHistoryInParent
)
{
const
{
browsingContext
}
=
this
.
browser
;
lazy
.
SessionHistory
.
restoreFromParent
(
browsingContext
.
sessionHistory
history
)
;
return
SessionStoreUtils
.
initializeRestore
(
browsingContext
SessionStoreUtils
.
constructSessionStoreRestoreData
(
)
)
;
}
this
.
sendAsyncMessage
(
"
RestoreHistoryAndNavigate
"
{
history
switchId
}
)
;
if
(
!
formdata
&
&
!
scrolldata
)
{
return
null
;
}
const
progressFilter
=
Cc
[
"
mozilla
.
org
/
appshell
/
component
/
browser
-
status
-
filter
;
1
"
]
.
createInstance
(
Ci
.
nsIWebProgress
)
;
const
{
browser
}
=
this
;
const
progressListener
=
{
QueryInterface
:
ChromeUtils
.
generateQI
(
[
"
nsIWebProgressListener
"
]
)
onLocationChange
(
aWebProgress
aRequest
aLocationURI
aFlags
)
{
if
(
!
aWebProgress
.
isTopLevel
)
{
return
;
}
browser
.
browsingContext
.
currentWindowGlobal
.
getActor
(
"
GeckoViewContent
"
)
.
sendAsyncMessage
(
"
RestoreSessionState
"
{
formdata
scrolldata
}
)
;
progressFilter
.
removeProgressListener
(
this
)
;
browser
.
removeProgressListener
(
progressFilter
)
;
}
}
;
const
flags
=
Ci
.
nsIWebProgress
.
NOTIFY_LOCATION
;
progressFilter
.
addProgressListener
(
progressListener
flags
)
;
browser
.
addProgressListener
(
progressFilter
flags
)
;
return
null
;
}
}
