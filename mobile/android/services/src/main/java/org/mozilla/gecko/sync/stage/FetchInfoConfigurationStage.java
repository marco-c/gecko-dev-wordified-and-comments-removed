package
org
.
mozilla
.
gecko
.
sync
.
stage
;
import
android
.
os
.
SystemClock
;
import
org
.
mozilla
.
gecko
.
sync
.
ExtendedJSONObject
;
import
org
.
mozilla
.
gecko
.
sync
.
HTTPFailureException
;
import
org
.
mozilla
.
gecko
.
sync
.
InfoConfiguration
;
import
org
.
mozilla
.
gecko
.
sync
.
JSONRecordFetcher
;
import
org
.
mozilla
.
gecko
.
sync
.
delegates
.
JSONRecordFetchDelegate
;
import
org
.
mozilla
.
gecko
.
sync
.
net
.
AuthHeaderProvider
;
import
org
.
mozilla
.
gecko
.
sync
.
net
.
SyncStorageResponse
;
import
org
.
mozilla
.
gecko
.
sync
.
telemetry
.
TelemetryCollector
;
public
class
FetchInfoConfigurationStage
extends
AbstractNonRepositorySyncStage
{
private
final
String
configurationURL
;
private
final
AuthHeaderProvider
authHeaderProvider
;
private
static
final
String
TELEMETRY_ERROR_NAME
=
"
infoconfig
"
;
private
static
final
String
TELEMETRY_ERROR_MISSING
=
"
missing
"
;
public
FetchInfoConfigurationStage
(
final
String
configurationURL
final
AuthHeaderProvider
authHeaderProvider
)
{
super
(
)
;
this
.
configurationURL
=
configurationURL
;
this
.
authHeaderProvider
=
authHeaderProvider
;
}
public
class
StageInfoConfigurationDelegate
implements
JSONRecordFetchDelegate
{
Override
public
void
handleSuccess
(
final
ExtendedJSONObject
result
)
{
session
.
config
.
infoConfiguration
=
new
InfoConfiguration
(
result
)
;
telemetryStageCollector
.
finished
=
SystemClock
.
elapsedRealtime
(
)
;
session
.
advance
(
)
;
}
Override
public
void
handleFailure
(
final
SyncStorageResponse
response
)
{
telemetryStageCollector
.
finished
=
SystemClock
.
elapsedRealtime
(
)
;
if
(
response
.
getStatusCode
(
)
!
=
404
)
{
telemetryStageCollector
.
error
=
new
TelemetryCollector
.
StageErrorBuilder
(
)
.
setLastException
(
new
HTTPFailureException
(
response
)
)
.
build
(
)
;
session
.
handleHTTPError
(
response
"
Failure
fetching
info
/
configuration
"
)
;
return
;
}
telemetryStageCollector
.
error
=
new
TelemetryCollector
.
StageErrorBuilder
(
TELEMETRY_ERROR_NAME
TELEMETRY_ERROR_MISSING
)
.
build
(
)
;
session
.
config
.
infoConfiguration
=
new
InfoConfiguration
(
)
;
session
.
advance
(
)
;
}
Override
public
void
handleError
(
final
Exception
e
)
{
telemetryStageCollector
.
finished
=
SystemClock
.
elapsedRealtime
(
)
;
telemetryStageCollector
.
error
=
new
TelemetryCollector
.
StageErrorBuilder
(
)
.
setLastException
(
e
)
.
build
(
)
;
session
.
abort
(
e
"
Failure
fetching
info
/
configuration
"
)
;
}
}
Override
public
void
execute
(
)
{
final
StageInfoConfigurationDelegate
delegate
=
new
StageInfoConfigurationDelegate
(
)
;
final
JSONRecordFetcher
fetcher
=
new
JSONRecordFetcher
(
configurationURL
authHeaderProvider
)
;
fetcher
.
fetch
(
delegate
)
;
}
}
