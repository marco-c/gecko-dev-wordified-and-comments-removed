package
org
.
mozilla
.
gecko
.
sync
.
repositories
;
import
android
.
content
.
Context
;
import
android
.
net
.
Uri
;
import
android
.
os
.
Bundle
;
import
org
.
mozilla
.
gecko
.
db
.
BrowserContract
;
import
org
.
mozilla
.
gecko
.
sync
.
repositories
.
delegates
.
RepositorySessionFetchRecordsDelegate
;
import
org
.
mozilla
.
gecko
.
sync
.
repositories
.
delegates
.
RepositorySessionStoreDelegate
;
import
org
.
mozilla
.
gecko
.
sync
.
repositories
.
domain
.
Record
;
import
java
.
util
.
concurrent
.
ConcurrentHashMap
;
import
java
.
util
.
concurrent
.
ExecutorService
;
public
class
VersioningDelegateHelper
{
private
final
Context
context
;
private
final
ConcurrentHashMap
<
String
Integer
>
localVersionsOfGuids
=
new
ConcurrentHashMap
<
>
(
)
;
private
final
Uri
repositoryContentUri
;
public
VersioningDelegateHelper
(
Context
context
Uri
repositoryContentUri
)
{
this
.
context
=
context
;
this
.
repositoryContentUri
=
repositoryContentUri
;
}
public
RepositorySessionFetchRecordsDelegate
getFetchDelegate
(
RepositorySessionFetchRecordsDelegate
delegate
)
{
return
new
VersionedFetchDelegate
(
delegate
)
;
}
public
RepositorySessionStoreDelegate
getStoreDelegate
(
RepositorySessionStoreDelegate
delegate
)
{
return
new
VersionedStoreDelegate
(
delegate
)
;
}
public
void
persistSyncVersions
(
)
{
final
Bundle
data
=
new
Bundle
(
)
;
final
int
versionMapSizeBeforeUpdate
;
synchronized
(
this
.
localVersionsOfGuids
)
{
data
.
putSerializable
(
BrowserContract
.
METHOD_PARAM_DATA
this
.
localVersionsOfGuids
)
;
versionMapSizeBeforeUpdate
=
this
.
localVersionsOfGuids
.
size
(
)
;
}
final
Bundle
result
=
context
.
getContentResolver
(
)
.
call
(
repositoryContentUri
BrowserContract
.
METHOD_UPDATE_SYNC_VERSIONS
repositoryContentUri
.
toString
(
)
data
)
;
if
(
result
=
=
null
)
{
throw
new
IllegalStateException
(
"
Expected
to
receive
a
result
after
decrementing
change
counters
"
)
;
}
final
int
changed
=
(
int
)
result
.
getSerializable
(
BrowserContract
.
METHOD_RESULT
)
;
final
int
versionMapSizeAfterUpdate
=
this
.
localVersionsOfGuids
.
size
(
)
;
if
(
versionMapSizeBeforeUpdate
!
=
versionMapSizeAfterUpdate
)
{
throw
new
IllegalStateException
(
"
Version
/
guid
map
changed
during
syncVersion
update
"
)
;
}
if
(
changed
<
versionMapSizeBeforeUpdate
)
{
throw
new
IllegalStateException
(
"
Updated
fewer
sync
versions
than
expected
"
)
;
}
if
(
changed
>
versionMapSizeBeforeUpdate
)
{
throw
new
IllegalStateException
(
"
Updated
more
sync
versions
than
expected
"
)
;
}
}
private
class
VersionedFetchDelegate
implements
RepositorySessionFetchRecordsDelegate
{
private
final
RepositorySessionFetchRecordsDelegate
inner
;
VersionedFetchDelegate
(
RepositorySessionFetchRecordsDelegate
delegate
)
{
this
.
inner
=
delegate
;
}
public
void
onFetchFailed
(
Exception
ex
)
{
this
.
inner
.
onFetchFailed
(
ex
)
;
}
Override
public
void
onFetchedRecord
(
Record
record
)
{
if
(
record
.
localVersion
=
=
null
)
{
throw
new
IllegalStateException
(
"
Encountered
an
unversioned
record
during
versioned
sync
.
"
)
;
}
localVersionsOfGuids
.
put
(
record
.
guid
record
.
localVersion
)
;
this
.
inner
.
onFetchedRecord
(
record
)
;
}
Override
public
void
onFetchCompleted
(
)
{
this
.
inner
.
onFetchCompleted
(
)
;
}
Override
public
void
onBatchCompleted
(
)
{
this
.
inner
.
onBatchCompleted
(
)
;
}
Override
public
RepositorySessionFetchRecordsDelegate
deferredFetchDelegate
(
ExecutorService
executor
)
{
return
this
.
inner
.
deferredFetchDelegate
(
executor
)
;
}
}
private
class
VersionedStoreDelegate
implements
RepositorySessionStoreDelegate
{
private
final
RepositorySessionStoreDelegate
inner
;
VersionedStoreDelegate
(
RepositorySessionStoreDelegate
delegate
)
{
this
.
inner
=
delegate
;
}
Override
public
void
onRecordStoreFailed
(
Exception
ex
String
recordGuid
)
{
inner
.
onRecordStoreFailed
(
ex
recordGuid
)
;
}
Override
public
void
onRecordStoreReconciled
(
String
guid
String
oldGuid
Integer
newVersion
)
{
if
(
newVersion
=
=
null
)
{
throw
new
IllegalArgumentException
(
"
Received
null
localVersion
after
reconciling
a
versioned
record
.
"
)
;
}
localVersionsOfGuids
.
remove
(
oldGuid
)
;
localVersionsOfGuids
.
put
(
guid
newVersion
)
;
inner
.
onRecordStoreReconciled
(
guid
oldGuid
newVersion
)
;
}
Override
public
void
onRecordStoreSucceeded
(
String
guid
)
{
inner
.
onRecordStoreSucceeded
(
guid
)
;
}
Override
public
void
onStoreCompleted
(
)
{
inner
.
onStoreCompleted
(
)
;
}
Override
public
void
onStoreFailed
(
Exception
e
)
{
inner
.
onStoreFailed
(
e
)
;
}
Override
public
void
onBatchCommitted
(
)
{
inner
.
onBatchCommitted
(
)
;
}
Override
public
RepositorySessionStoreDelegate
deferredStoreDelegate
(
ExecutorService
executor
)
{
return
inner
.
deferredStoreDelegate
(
executor
)
;
}
}
}
