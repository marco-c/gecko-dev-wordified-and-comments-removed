from
copy
import
deepcopy
from
taskgraph
.
transforms
.
base
import
TransformSequence
from
taskgraph
.
util
.
treeherder
import
add_suffix
from
taskgraph
import
MAX_DEPENDENCIES
MAX_REGULAR_DEPS
=
MAX_DEPENDENCIES
-
1
transforms
=
TransformSequence
(
)
def
build_task_definition
(
orig_task
deps
count
)
:
    
task
=
deepcopy
(
orig_task
)
    
task
[
'
dependencies
'
]
=
deps
    
task
[
'
name
'
]
=
"
{
}
-
{
}
"
.
format
(
orig_task
[
'
name
'
]
count
)
    
if
'
treeherder
'
in
task
:
        
task
[
'
treeherder
'
]
[
'
symbol
'
]
=
add_suffix
(
            
task
[
'
treeherder
'
]
[
'
symbol
'
]
f
"
-
{
count
}
"
)
    
task
[
"
attributes
"
]
[
"
is_final_chunked_task
"
]
=
False
    
return
task
def
get_chunked_label
(
config
chunked_task
)
:
    
return
'
{
}
-
{
}
'
.
format
(
config
.
kind
chunked_task
[
'
name
'
]
)
transforms
.
add
def
add_dependencies
(
config
tasks
)
:
    
for
task
in
tasks
:
        
count
=
1
        
deps
=
{
}
        
chunked_labels
=
{
}
        
dep_labels
=
task
.
pop
(
'
soft
-
dependencies
'
[
]
)
        
dep_labels
.
extend
(
task
.
get
(
'
dependencies
'
{
}
)
.
keys
(
)
)
        
dep_labels
=
sorted
(
dep_labels
)
        
for
dep_label
in
dep_labels
:
            
deps
[
dep_label
]
=
dep_label
            
if
len
(
deps
)
=
=
MAX_REGULAR_DEPS
:
                
chunked_task
=
build_task_definition
(
task
deps
count
)
                
chunked_label
=
get_chunked_label
(
config
chunked_task
)
                
chunked_labels
[
chunked_label
]
=
chunked_label
                
yield
chunked_task
                
deps
=
{
}
                
count
+
=
1
        
if
deps
:
            
chunked_task
=
build_task_definition
(
task
deps
count
)
            
chunked_label
=
get_chunked_label
(
config
chunked_task
)
            
chunked_labels
[
chunked_label
]
=
chunked_label
            
yield
chunked_task
            
count
+
=
1
        
task
[
'
dependencies
'
]
=
chunked_labels
        
task
[
"
attributes
"
]
[
"
is_final_chunked_task
"
]
=
True
        
yield
task
