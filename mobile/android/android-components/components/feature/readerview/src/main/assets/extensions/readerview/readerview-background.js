let
serializedDocs
=
new
Map
(
)
;
browser
.
runtime
.
onMessage
.
addListener
(
(
message
sender
sendResponse
)
=
>
{
switch
(
message
.
action
)
{
case
'
show
'
:
let
id
=
sender
.
contextId
;
let
url
=
encodeURIComponent
(
message
.
url
)
;
let
colorScheme
=
message
.
options
.
colorScheme
;
browser
.
tabs
.
update
(
{
url
:
/
readerview
.
html
?
url
=
{
url
}
&
colorScheme
=
{
colorScheme
}
&
id
=
{
id
}
}
)
.
catch
(
(
e
)
=
>
{
console
.
error
(
"
Failed
to
open
reader
view
"
e
e
.
stack
)
;
}
)
;
break
;
case
'
addSerializedDoc
'
:
serializedDocs
.
set
(
sender
.
contextId
.
toString
(
)
message
.
doc
)
;
break
;
case
'
getSerializedDoc
'
:
let
doc
=
serializedDocs
.
get
(
message
.
id
)
;
if
(
doc
)
{
serializedDocs
.
delete
(
message
.
id
)
;
}
sendResponse
(
doc
)
;
break
;
default
:
console
.
error
(
Received
unsupported
action
{
message
.
action
}
)
;
}
}
)
;
