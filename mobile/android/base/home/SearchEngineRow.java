package
org
.
mozilla
.
gecko
.
home
;
import
org
.
mozilla
.
gecko
.
AppConstants
;
import
org
.
mozilla
.
gecko
.
db
.
BrowserContract
.
SearchHistory
;
import
org
.
mozilla
.
gecko
.
GeckoSharedPrefs
;
import
org
.
mozilla
.
gecko
.
R
;
import
org
.
mozilla
.
gecko
.
Telemetry
;
import
org
.
mozilla
.
gecko
.
TelemetryContract
;
import
org
.
mozilla
.
gecko
.
home
.
BrowserSearch
.
OnEditSuggestionListener
;
import
org
.
mozilla
.
gecko
.
home
.
BrowserSearch
.
OnSearchListener
;
import
org
.
mozilla
.
gecko
.
home
.
HomePager
.
OnUrlOpenListener
;
import
org
.
mozilla
.
gecko
.
preferences
.
GeckoPreferences
;
import
org
.
mozilla
.
gecko
.
util
.
StringUtils
;
import
org
.
mozilla
.
gecko
.
util
.
HardwareUtils
;
import
org
.
mozilla
.
gecko
.
widget
.
AnimatedHeightLayout
;
import
org
.
mozilla
.
gecko
.
widget
.
FaviconView
;
import
org
.
mozilla
.
gecko
.
widget
.
FlowLayout
;
import
android
.
database
.
Cursor
;
import
android
.
content
.
ContentResolver
;
import
android
.
content
.
Context
;
import
android
.
content
.
SharedPreferences
;
import
android
.
util
.
AttributeSet
;
import
android
.
view
.
KeyEvent
;
import
android
.
view
.
LayoutInflater
;
import
android
.
view
.
View
;
import
android
.
view
.
animation
.
AlphaAnimation
;
import
android
.
widget
.
ImageView
;
import
android
.
widget
.
LinearLayout
;
import
android
.
widget
.
TextView
;
import
java
.
util
.
EnumSet
;
class
SearchEngineRow
extends
AnimatedHeightLayout
{
private
static
final
int
ANIMATION_DURATION
=
250
;
private
final
FlowLayout
mSuggestionView
;
private
final
FaviconView
mIconView
;
private
final
LinearLayout
mUserEnteredView
;
private
final
TextView
mUserEnteredTextView
;
private
final
LayoutInflater
mInflater
;
private
SearchEngine
mSearchEngine
;
private
final
OnClickListener
mClickListener
;
private
final
OnLongClickListener
mLongClickListener
;
private
OnUrlOpenListener
mUrlOpenListener
;
private
OnSearchListener
mSearchListener
;
private
OnEditSuggestionListener
mEditSuggestionListener
;
private
int
mSelectedView
;
private
int
mMaxSavedSuggestions
;
private
int
mMaxSearchSuggestions
;
private
static
final
int
SUGGESTIONS_MAX
=
4
;
public
SearchEngineRow
(
Context
context
)
{
this
(
context
null
)
;
}
public
SearchEngineRow
(
Context
context
AttributeSet
attrs
)
{
this
(
context
attrs
0
)
;
}
public
SearchEngineRow
(
Context
context
AttributeSet
attrs
int
defStyle
)
{
super
(
context
attrs
defStyle
)
;
mClickListener
=
new
OnClickListener
(
)
{
Override
public
void
onClick
(
View
v
)
{
final
String
suggestion
=
getSuggestionTextFromView
(
v
)
;
if
(
v
!
=
mUserEnteredView
&
&
!
StringUtils
.
isSearchQuery
(
suggestion
true
)
)
{
if
(
mUrlOpenListener
!
=
null
)
{
Telemetry
.
sendUIEvent
(
TelemetryContract
.
Event
.
LOAD_URL
TelemetryContract
.
Method
.
SUGGESTION
"
url
"
)
;
mUrlOpenListener
.
onUrlOpen
(
suggestion
EnumSet
.
noneOf
(
OnUrlOpenListener
.
Flags
.
class
)
)
;
}
}
else
if
(
mSearchListener
!
=
null
)
{
if
(
v
=
=
mUserEnteredView
)
{
Telemetry
.
sendUIEvent
(
TelemetryContract
.
Event
.
LOAD_URL
TelemetryContract
.
Method
.
SUGGESTION
"
user
"
)
;
}
else
{
Telemetry
.
sendUIEvent
(
TelemetryContract
.
Event
.
LOAD_URL
TelemetryContract
.
Method
.
SUGGESTION
(
String
)
v
.
getTag
(
)
)
;
}
mSearchListener
.
onSearch
(
mSearchEngine
suggestion
)
;
}
}
}
;
mLongClickListener
=
new
OnLongClickListener
(
)
{
Override
public
boolean
onLongClick
(
View
v
)
{
if
(
mEditSuggestionListener
!
=
null
)
{
final
String
suggestion
=
getSuggestionTextFromView
(
v
)
;
mEditSuggestionListener
.
onEditSuggestion
(
suggestion
)
;
return
true
;
}
return
false
;
}
}
;
mInflater
=
LayoutInflater
.
from
(
context
)
;
mInflater
.
inflate
(
R
.
layout
.
search_engine_row
this
)
;
mSuggestionView
=
(
FlowLayout
)
findViewById
(
R
.
id
.
suggestion_layout
)
;
mIconView
=
(
FaviconView
)
findViewById
(
R
.
id
.
suggestion_icon
)
;
mUserEnteredView
=
(
LinearLayout
)
findViewById
(
R
.
id
.
suggestion_user_entered
)
;
mUserEnteredView
.
setOnClickListener
(
mClickListener
)
;
mUserEnteredTextView
=
(
TextView
)
findViewById
(
R
.
id
.
suggestion_text
)
;
mMaxSavedSuggestions
=
getResources
(
)
.
getInteger
(
R
.
integer
.
max_saved_suggestions
)
;
mMaxSearchSuggestions
=
getResources
(
)
.
getInteger
(
R
.
integer
.
max_search_suggestions
)
;
}
private
void
setDescriptionOnSuggestion
(
View
v
String
suggestion
)
{
v
.
setContentDescription
(
getResources
(
)
.
getString
(
R
.
string
.
suggestion_for_engine
mSearchEngine
.
name
suggestion
)
)
;
}
private
String
getSuggestionTextFromView
(
View
v
)
{
final
TextView
suggestionText
=
(
TextView
)
v
.
findViewById
(
R
.
id
.
suggestion_text
)
;
return
suggestionText
.
getText
(
)
.
toString
(
)
;
}
private
void
setSuggestionOnView
(
View
v
String
suggestion
boolean
isUserSavedSearch
)
{
final
ImageView
historyIcon
=
(
ImageView
)
v
.
findViewById
(
R
.
id
.
suggestion_item_icon
)
;
historyIcon
.
setVisibility
(
isUserSavedSearch
?
View
.
VISIBLE
:
View
.
GONE
)
;
final
TextView
suggestionText
=
(
TextView
)
v
.
findViewById
(
R
.
id
.
suggestion_text
)
;
suggestionText
.
setText
(
suggestion
)
;
setDescriptionOnSuggestion
(
suggestionText
suggestion
)
;
}
public
void
performUserEnteredSearch
(
)
{
String
searchTerm
=
getSuggestionTextFromView
(
mUserEnteredView
)
;
if
(
mSearchListener
!
=
null
)
{
Telemetry
.
sendUIEvent
(
TelemetryContract
.
Event
.
LOAD_URL
TelemetryContract
.
Method
.
SUGGESTION
"
user
"
)
;
mSearchListener
.
onSearch
(
mSearchEngine
searchTerm
)
;
}
}
public
void
setSearchTerm
(
String
searchTerm
)
{
mUserEnteredTextView
.
setText
(
searchTerm
)
;
if
(
mSearchEngine
!
=
null
)
{
setDescriptionOnSuggestion
(
mUserEnteredTextView
searchTerm
)
;
}
}
public
void
setOnUrlOpenListener
(
OnUrlOpenListener
listener
)
{
mUrlOpenListener
=
listener
;
}
public
void
setOnSearchListener
(
OnSearchListener
listener
)
{
mSearchListener
=
listener
;
}
public
void
setOnEditSuggestionListener
(
OnEditSuggestionListener
listener
)
{
mEditSuggestionListener
=
listener
;
}
private
void
bindSuggestionView
(
String
suggestion
boolean
animate
int
recycledSuggestionCount
Integer
previousSuggestionChildIndex
boolean
isUserSavedSearch
String
telemetryTag
)
{
final
View
suggestionItem
;
if
(
previousSuggestionChildIndex
+
1
<
recycledSuggestionCount
)
{
suggestionItem
=
mSuggestionView
.
getChildAt
(
previousSuggestionChildIndex
+
1
)
;
suggestionItem
.
setVisibility
(
View
.
VISIBLE
)
;
}
else
{
suggestionItem
=
mInflater
.
inflate
(
R
.
layout
.
suggestion_item
null
)
;
suggestionItem
.
setOnClickListener
(
mClickListener
)
;
suggestionItem
.
setOnLongClickListener
(
mLongClickListener
)
;
suggestionItem
.
setTag
(
telemetryTag
)
;
mSuggestionView
.
addView
(
suggestionItem
)
;
}
setSuggestionOnView
(
suggestionItem
suggestion
isUserSavedSearch
)
;
if
(
animate
)
{
AlphaAnimation
anim
=
new
AlphaAnimation
(
0
1
)
;
anim
.
setDuration
(
ANIMATION_DURATION
)
;
anim
.
setStartOffset
(
previousSuggestionChildIndex
*
ANIMATION_DURATION
)
;
suggestionItem
.
startAnimation
(
anim
)
;
}
}
private
void
hideRecycledSuggestions
(
int
lastVisibleChildIndex
int
recycledSuggestionCount
)
{
for
(
int
i
=
lastVisibleChildIndex
+
1
;
i
<
recycledSuggestionCount
;
+
+
i
)
{
mSuggestionView
.
getChildAt
(
i
)
.
setVisibility
(
View
.
GONE
)
;
}
}
private
void
updateFromSavedSearches
(
Cursor
c
boolean
animate
int
suggestionCounter
int
recycledSuggestionCount
)
{
if
(
c
=
=
null
)
{
return
;
}
try
{
if
(
c
.
moveToFirst
(
)
)
{
final
int
searchColumn
=
c
.
getColumnIndexOrThrow
(
SearchHistory
.
QUERY
)
;
final
int
historyStartIndex
=
suggestionCounter
;
do
{
final
String
savedSearch
=
c
.
getString
(
searchColumn
)
;
String
telemetryTag
=
"
history
.
"
+
(
suggestionCounter
-
historyStartIndex
)
;
bindSuggestionView
(
savedSearch
animate
recycledSuggestionCount
suggestionCounter
true
telemetryTag
)
;
+
+
suggestionCounter
;
}
while
(
c
.
moveToNext
(
)
)
;
}
}
finally
{
c
.
close
(
)
;
}
hideRecycledSuggestions
(
suggestionCounter
recycledSuggestionCount
)
;
}
private
Cursor
getSavedSearches
(
String
searchTerm
)
{
if
(
!
AppConstants
.
NIGHTLY_BUILD
)
{
return
null
;
}
final
ContentResolver
cr
=
getContext
(
)
.
getContentResolver
(
)
;
String
[
]
columns
=
new
String
[
]
{
SearchHistory
.
QUERY
}
;
String
actualQuery
=
SearchHistory
.
QUERY
+
"
LIKE
?
"
;
String
[
]
queryArgs
=
new
String
[
]
{
'
%
'
+
searchTerm
+
'
%
'
}
;
String
sortOrderAndLimit
=
SearchHistory
.
DATE
+
"
DESC
LIMIT
"
+
mMaxSavedSuggestions
;
return
cr
.
query
(
SearchHistory
.
CONTENT_URI
columns
actualQuery
queryArgs
sortOrderAndLimit
)
;
}
private
int
updateFromSearchEngine
(
boolean
animate
int
recycledSuggestionCount
int
savedSuggestionCount
)
{
int
maxSuggestions
=
SUGGESTIONS_MAX
;
if
(
AppConstants
.
NIGHTLY_BUILD
)
{
maxSuggestions
=
mMaxSearchSuggestions
;
if
(
!
HardwareUtils
.
isTablet
(
)
&
&
savedSuggestionCount
<
mMaxSavedSuggestions
)
{
maxSuggestions
+
=
mMaxSavedSuggestions
-
savedSuggestionCount
;
}
}
int
suggestionCounter
=
0
;
for
(
String
suggestion
:
mSearchEngine
.
getSuggestions
(
)
)
{
if
(
suggestionCounter
=
=
maxSuggestions
)
{
break
;
}
String
telemetryTag
=
"
engine
.
"
+
suggestionCounter
;
bindSuggestionView
(
suggestion
animate
recycledSuggestionCount
suggestionCounter
false
telemetryTag
)
;
+
+
suggestionCounter
;
}
hideRecycledSuggestions
(
suggestionCounter
recycledSuggestionCount
)
;
if
(
mSelectedView
>
=
mSuggestionView
.
getChildCount
(
)
)
{
mSelectedView
=
mSuggestionView
.
getChildCount
(
)
-
1
;
}
return
suggestionCounter
;
}
public
void
updateSuggestions
(
boolean
searchSuggestionsEnabled
SearchEngine
searchEngine
String
searchTerm
boolean
animate
)
{
mSearchEngine
=
searchEngine
;
mIconView
.
updateAndScaleImage
(
mSearchEngine
.
getIcon
(
)
mSearchEngine
.
getEngineIdentifier
(
)
)
;
setDescriptionOnSuggestion
(
mUserEnteredTextView
mUserEnteredTextView
.
getText
(
)
.
toString
(
)
)
;
if
(
!
AppConstants
.
NIGHTLY_BUILD
)
{
if
(
searchSuggestionsEnabled
)
{
updateFromSearchEngine
(
animate
mSuggestionView
.
getChildCount
(
)
0
)
;
}
return
;
}
final
int
recycledSuggestionCount
=
mSuggestionView
.
getChildCount
(
)
;
final
SharedPreferences
prefs
=
GeckoSharedPrefs
.
forApp
(
getContext
(
)
)
;
final
boolean
savedSearchesEnabled
=
prefs
.
getBoolean
(
GeckoPreferences
.
PREFS_HISTORY_SAVED_SEARCH
true
)
;
if
(
searchSuggestionsEnabled
&
&
savedSearchesEnabled
)
{
final
Cursor
c
=
getSavedSearches
(
searchTerm
)
;
try
{
final
int
savedSearchCount
=
(
c
!
=
null
)
?
c
.
getCount
(
)
:
0
;
final
int
suggestionViewCount
=
updateFromSearchEngine
(
animate
recycledSuggestionCount
savedSearchCount
)
;
updateFromSavedSearches
(
c
animate
suggestionViewCount
recycledSuggestionCount
)
;
}
finally
{
if
(
c
!
=
null
)
{
c
.
close
(
)
;
}
}
}
else
if
(
savedSearchesEnabled
)
{
final
Cursor
c
=
getSavedSearches
(
searchTerm
)
;
try
{
updateFromSavedSearches
(
c
animate
0
recycledSuggestionCount
)
;
}
finally
{
if
(
c
!
=
null
)
{
c
.
close
(
)
;
}
}
}
else
if
(
searchSuggestionsEnabled
)
{
updateFromSearchEngine
(
animate
recycledSuggestionCount
0
)
;
}
}
Override
public
boolean
onKeyDown
(
int
keyCode
android
.
view
.
KeyEvent
event
)
{
final
View
suggestion
=
mSuggestionView
.
getChildAt
(
mSelectedView
)
;
if
(
event
.
getAction
(
)
!
=
android
.
view
.
KeyEvent
.
ACTION_DOWN
)
{
return
false
;
}
switch
(
event
.
getKeyCode
(
)
)
{
case
KeyEvent
.
KEYCODE_DPAD_RIGHT
:
final
View
nextSuggestion
=
mSuggestionView
.
getChildAt
(
mSelectedView
+
1
)
;
if
(
nextSuggestion
!
=
null
)
{
changeSelectedSuggestion
(
suggestion
nextSuggestion
)
;
mSelectedView
+
+
;
return
true
;
}
break
;
case
KeyEvent
.
KEYCODE_DPAD_LEFT
:
final
View
prevSuggestion
=
mSuggestionView
.
getChildAt
(
mSelectedView
-
1
)
;
if
(
prevSuggestion
!
=
null
)
{
changeSelectedSuggestion
(
suggestion
prevSuggestion
)
;
mSelectedView
-
-
;
return
true
;
}
break
;
case
KeyEvent
.
KEYCODE_BUTTON_A
:
return
suggestion
.
performClick
(
)
;
}
return
false
;
}
private
void
changeSelectedSuggestion
(
View
oldSuggestion
View
newSuggestion
)
{
oldSuggestion
.
setDuplicateParentStateEnabled
(
false
)
;
newSuggestion
.
setDuplicateParentStateEnabled
(
true
)
;
oldSuggestion
.
refreshDrawableState
(
)
;
newSuggestion
.
refreshDrawableState
(
)
;
}
public
void
onSelected
(
)
{
mSelectedView
=
0
;
mUserEnteredView
.
setDuplicateParentStateEnabled
(
true
)
;
mUserEnteredView
.
refreshDrawableState
(
)
;
}
public
void
onDeselected
(
)
{
final
View
suggestion
=
mSuggestionView
.
getChildAt
(
mSelectedView
)
;
suggestion
.
setDuplicateParentStateEnabled
(
false
)
;
suggestion
.
refreshDrawableState
(
)
;
}
}
