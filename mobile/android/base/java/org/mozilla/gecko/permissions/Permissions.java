package
org
.
mozilla
.
gecko
.
permissions
;
import
android
.
app
.
Activity
;
import
android
.
content
.
pm
.
PackageManager
;
import
android
.
support
.
annotation
.
NonNull
;
import
org
.
mozilla
.
gecko
.
util
.
ThreadUtils
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
Collections
;
import
java
.
util
.
HashSet
;
import
java
.
util
.
LinkedList
;
import
java
.
util
.
List
;
import
java
.
util
.
Queue
;
import
java
.
util
.
concurrent
.
Callable
;
import
java
.
util
.
concurrent
.
CancellationException
;
import
java
.
util
.
concurrent
.
ExecutionException
;
import
java
.
util
.
concurrent
.
FutureTask
;
public
class
Permissions
{
private
static
final
Queue
<
PermissionBlock
>
waiting
=
new
LinkedList
<
>
(
)
;
private
static
final
Queue
<
PermissionBlock
>
prompt
=
new
LinkedList
<
>
(
)
;
private
static
PermissionsHelper
permissionHelper
=
new
PermissionsHelper
(
)
;
public
static
PermissionBlock
from
(
NonNull
Activity
activity
)
{
return
new
PermissionBlock
(
activity
permissionHelper
)
;
}
public
static
boolean
waitFor
(
NonNull
Activity
activity
String
.
.
.
permissions
)
{
ThreadUtils
.
assertNotOnUiThread
(
)
;
final
FutureTask
<
Boolean
>
blockingTask
=
new
FutureTask
<
>
(
new
Callable
<
Boolean
>
(
)
{
Override
public
Boolean
call
(
)
throws
Exception
{
return
true
;
}
}
)
;
Runnable
cancelBlockingTask
=
new
Runnable
(
)
{
Override
public
void
run
(
)
{
blockingTask
.
cancel
(
true
)
;
}
}
;
Permissions
.
from
(
activity
)
.
withPermissions
(
permissions
)
.
andFallback
(
cancelBlockingTask
)
.
run
(
blockingTask
)
;
try
{
return
blockingTask
.
get
(
)
;
}
catch
(
InterruptedException
|
ExecutionException
|
CancellationException
e
)
{
return
false
;
}
}
static
void
setPermissionHelper
(
PermissionsHelper
permissionHelper
)
{
Permissions
.
permissionHelper
=
permissionHelper
;
}
public
static
synchronized
void
onRequestPermissionsResult
(
NonNull
Activity
activity
NonNull
String
[
]
permissions
NonNull
int
[
]
grantResults
)
{
processGrantResults
(
permissions
grantResults
)
;
processQueue
(
activity
permissions
grantResults
)
;
}
static
synchronized
void
prompt
(
Activity
activity
PermissionBlock
block
)
{
if
(
prompt
.
isEmpty
(
)
)
{
prompt
.
add
(
block
)
;
showPrompt
(
activity
)
;
}
else
{
waiting
.
add
(
block
)
;
}
}
private
static
synchronized
void
processGrantResults
(
NonNull
String
[
]
permissions
NonNull
int
[
]
grantResults
)
{
final
HashSet
<
String
>
grantedPermissions
=
collectGrantedPermissions
(
permissions
grantResults
)
;
while
(
!
prompt
.
isEmpty
(
)
)
{
final
PermissionBlock
block
=
prompt
.
poll
(
)
;
if
(
allPermissionsGranted
(
block
grantedPermissions
)
)
{
block
.
onPermissionsGranted
(
)
;
}
else
{
block
.
onPermissionsDenied
(
)
;
}
}
}
private
static
synchronized
void
processQueue
(
Activity
activity
String
[
]
permissions
int
[
]
grantResults
)
{
final
HashSet
<
String
>
deniedPermissions
=
collectDeniedPermissions
(
permissions
grantResults
)
;
while
(
!
waiting
.
isEmpty
(
)
)
{
final
PermissionBlock
block
=
waiting
.
poll
(
)
;
if
(
block
.
hasPermissions
(
activity
)
)
{
block
.
onPermissionsGranted
(
)
;
}
else
{
if
(
atLeastOnePermissionDenied
(
block
deniedPermissions
)
)
{
block
.
onPermissionsDenied
(
)
;
}
else
{
prompt
.
add
(
block
)
;
}
}
}
if
(
!
prompt
.
isEmpty
(
)
)
{
showPrompt
(
activity
)
;
}
}
private
static
synchronized
void
showPrompt
(
Activity
activity
)
{
HashSet
<
String
>
permissions
=
new
HashSet
<
>
(
)
;
for
(
PermissionBlock
block
:
prompt
)
{
Collections
.
addAll
(
permissions
block
.
getPermissions
(
)
)
;
}
permissionHelper
.
prompt
(
activity
permissions
.
toArray
(
new
String
[
permissions
.
size
(
)
]
)
)
;
}
private
static
HashSet
<
String
>
collectGrantedPermissions
(
NonNull
String
[
]
permissions
NonNull
int
[
]
grantResults
)
{
return
filterPermissionsByResult
(
permissions
grantResults
PackageManager
.
PERMISSION_GRANTED
)
;
}
private
static
HashSet
<
String
>
collectDeniedPermissions
(
NonNull
String
[
]
permissions
NonNull
int
[
]
grantResults
)
{
return
filterPermissionsByResult
(
permissions
grantResults
PackageManager
.
PERMISSION_DENIED
)
;
}
private
static
HashSet
<
String
>
filterPermissionsByResult
(
NonNull
String
[
]
permissions
NonNull
int
[
]
grantResults
int
result
)
{
HashSet
<
String
>
grantedPermissions
=
new
HashSet
<
>
(
permissions
.
length
)
;
for
(
int
i
=
0
;
i
<
permissions
.
length
;
i
+
+
)
{
if
(
grantResults
[
i
]
=
=
result
)
{
grantedPermissions
.
add
(
permissions
[
i
]
)
;
}
}
return
grantedPermissions
;
}
private
static
boolean
allPermissionsGranted
(
PermissionBlock
block
HashSet
<
String
>
grantedPermissions
)
{
for
(
String
permission
:
block
.
getPermissions
(
)
)
{
if
(
!
grantedPermissions
.
contains
(
permission
)
)
{
return
false
;
}
}
return
true
;
}
private
static
boolean
atLeastOnePermissionDenied
(
PermissionBlock
block
HashSet
<
String
>
deniedPermissions
)
{
for
(
String
permission
:
block
.
getPermissions
(
)
)
{
if
(
deniedPermissions
.
contains
(
permission
)
)
{
return
true
;
}
}
return
false
;
}
}
