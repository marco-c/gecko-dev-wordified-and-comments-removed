package
org
.
mozilla
.
gecko
.
favicons
;
import
android
.
content
.
Context
;
import
android
.
content
.
res
.
Resources
;
import
android
.
graphics
.
Bitmap
;
import
android
.
graphics
.
Canvas
;
import
android
.
graphics
.
Color
;
import
android
.
graphics
.
Paint
;
import
android
.
graphics
.
RectF
;
import
android
.
net
.
Uri
;
import
android
.
support
.
annotation
.
NonNull
;
import
android
.
text
.
TextUtils
;
import
android
.
util
.
Log
;
import
android
.
util
.
TypedValue
;
import
org
.
mozilla
.
gecko
.
R
;
import
org
.
mozilla
.
gecko
.
util
.
ThreadUtils
;
import
java
.
util
.
Arrays
;
import
java
.
util
.
Locale
;
public
class
FaviconGenerator
{
private
static
final
int
[
]
COLORS
=
{
0xFFc33c32
0xFFf25820
0xFFff9216
0xFFffcb00
0xFF57bd35
0xFF01bdad
0xFF0996f8
0xFF02538b
0xFF1f386e
0xFF7a2f7a
0xFFea385e
}
;
private
static
final
String
[
]
COMMON_PREFIXES
=
{
"
www
.
"
"
m
.
"
"
mobile
.
"
}
;
private
static
final
int
TEXT_SIZE_DP
=
12
;
public
static
class
IconWithColor
{
public
final
Bitmap
bitmap
;
public
final
int
color
;
private
IconWithColor
(
Bitmap
bitmap
int
color
)
{
this
.
bitmap
=
bitmap
;
this
.
color
=
color
;
}
}
public
static
void
generate
(
final
Context
context
final
String
pageURL
final
OnFaviconLoadedListener
listener
)
{
ThreadUtils
.
postToBackgroundThread
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
final
Bitmap
bitmap
=
generate
(
context
pageURL
)
.
bitmap
;
ThreadUtils
.
postToUiThread
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
listener
.
onFaviconLoaded
(
pageURL
null
bitmap
)
;
}
}
)
;
}
}
)
;
}
public
static
IconWithColor
generate
(
Context
context
String
pageURL
)
{
final
Resources
resources
=
context
.
getResources
(
)
;
final
int
widthAndHeight
=
resources
.
getDimensionPixelSize
(
R
.
dimen
.
favicon_bg
)
;
final
int
roundedCorners
=
resources
.
getDimensionPixelOffset
(
R
.
dimen
.
favicon_corner_radius
)
;
final
Bitmap
favicon
=
Bitmap
.
createBitmap
(
widthAndHeight
widthAndHeight
Bitmap
.
Config
.
ARGB_8888
)
;
final
Canvas
canvas
=
new
Canvas
(
favicon
)
;
final
int
color
=
pickColor
(
pageURL
)
;
final
Paint
paint
=
new
Paint
(
)
;
paint
.
setColor
(
color
)
;
canvas
.
drawRoundRect
(
new
RectF
(
0
0
widthAndHeight
widthAndHeight
)
roundedCorners
roundedCorners
paint
)
;
paint
.
setColor
(
Color
.
WHITE
)
;
final
String
character
=
getRepresentativeCharacter
(
pageURL
)
;
final
float
textSize
=
TypedValue
.
applyDimension
(
TypedValue
.
COMPLEX_UNIT_DIP
TEXT_SIZE_DP
context
.
getResources
(
)
.
getDisplayMetrics
(
)
)
;
paint
.
setTextAlign
(
Paint
.
Align
.
CENTER
)
;
paint
.
setTextSize
(
textSize
)
;
paint
.
setAntiAlias
(
true
)
;
canvas
.
drawText
(
character
canvas
.
getWidth
(
)
/
2
(
int
)
(
(
canvas
.
getHeight
(
)
/
2
)
-
(
(
paint
.
descent
(
)
+
paint
.
ascent
(
)
)
/
2
)
)
paint
)
;
return
new
IconWithColor
(
favicon
color
)
;
}
protected
static
String
getRepresentativeCharacter
(
String
url
)
{
if
(
TextUtils
.
isEmpty
(
url
)
)
{
return
"
?
"
;
}
final
String
snippet
=
getRepresentativeSnippet
(
url
)
;
for
(
int
i
=
0
;
i
<
snippet
.
length
(
)
;
i
+
+
)
{
char
c
=
snippet
.
charAt
(
i
)
;
if
(
Character
.
isLetterOrDigit
(
c
)
)
{
return
String
.
valueOf
(
Character
.
toUpperCase
(
c
)
)
;
}
}
return
"
?
"
;
}
protected
static
int
pickColor
(
String
url
)
{
if
(
TextUtils
.
isEmpty
(
url
)
)
{
return
COLORS
[
0
]
;
}
final
String
snippet
=
getRepresentativeSnippet
(
url
)
;
final
int
color
=
Math
.
abs
(
snippet
.
hashCode
(
)
%
COLORS
.
length
)
;
return
COLORS
[
color
]
;
}
private
static
String
getRepresentativeSnippet
(
NonNull
String
url
)
{
Uri
uri
=
Uri
.
parse
(
url
)
;
String
snippet
=
uri
.
getHost
(
)
;
if
(
TextUtils
.
isEmpty
(
snippet
)
)
{
snippet
=
uri
.
getPath
(
)
;
}
if
(
TextUtils
.
isEmpty
(
snippet
)
)
{
return
"
?
"
;
}
for
(
String
prefix
:
COMMON_PREFIXES
)
{
if
(
snippet
.
startsWith
(
prefix
)
)
{
snippet
=
snippet
.
substring
(
prefix
.
length
(
)
)
;
}
}
return
snippet
;
}
}
