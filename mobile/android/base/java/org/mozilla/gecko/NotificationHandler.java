package
org
.
mozilla
.
gecko
;
import
android
.
graphics
.
Bitmap
;
import
android
.
app
.
Notification
;
import
android
.
app
.
PendingIntent
;
import
android
.
content
.
Context
;
import
android
.
support
.
v4
.
app
.
NotificationCompat
;
import
android
.
support
.
v4
.
app
.
NotificationManagerCompat
;
import
org
.
mozilla
.
gecko
.
gfx
.
BitmapUtils
;
import
java
.
util
.
concurrent
.
ConcurrentHashMap
;
public
class
NotificationHandler
{
private
static
String
LOGTAG
=
"
GeckoNotifHandler
"
;
private
final
ConcurrentHashMap
<
Integer
Notification
>
mNotifications
=
new
ConcurrentHashMap
<
Integer
Notification
>
(
)
;
private
final
Context
mContext
;
private
final
NotificationManagerCompat
mNotificationManager
;
private
Notification
mForegroundNotification
;
private
int
mForegroundNotificationId
;
public
NotificationHandler
(
Context
context
)
{
mContext
=
context
;
mNotificationManager
=
NotificationManagerCompat
.
from
(
context
)
;
}
public
void
add
(
final
int
notificationID
String
aImageUrl
String
aHost
String
aAlertTitle
String
aAlertText
PendingIntent
contentIntent
)
{
remove
(
notificationID
)
;
final
NotificationCompat
.
Builder
builder
=
new
NotificationCompat
.
Builder
(
mContext
)
.
setContentTitle
(
aAlertTitle
)
.
setContentText
(
aAlertText
)
.
setSmallIcon
(
R
.
drawable
.
ic_status_logo
)
.
setContentIntent
(
contentIntent
)
.
setAutoCancel
(
true
)
.
setStyle
(
new
NotificationCompat
.
InboxStyle
(
)
.
addLine
(
aAlertText
)
.
setSummaryText
(
aHost
)
)
;
if
(
!
aImageUrl
.
isEmpty
(
)
)
{
final
Bitmap
image
=
BitmapUtils
.
decodeUrl
(
aImageUrl
)
;
builder
.
setLargeIcon
(
image
)
;
}
builder
.
setWhen
(
System
.
currentTimeMillis
(
)
)
;
final
Notification
notification
=
builder
.
build
(
)
;
mNotificationManager
.
notify
(
notificationID
notification
)
;
mNotifications
.
put
(
notificationID
notification
)
;
}
public
void
add
(
int
id
Notification
notification
)
{
mNotificationManager
.
notify
(
id
notification
)
;
mNotifications
.
put
(
id
notification
)
;
if
(
mForegroundNotification
=
=
null
&
&
isOngoing
(
notification
)
)
{
setForegroundNotification
(
id
notification
)
;
}
}
public
void
update
(
int
notificationID
long
aProgress
long
aProgressMax
String
aAlertText
)
{
Notification
notification
=
mNotifications
.
get
(
notificationID
)
;
if
(
notification
=
=
null
)
{
return
;
}
notification
=
new
NotificationCompat
.
Builder
(
mContext
)
.
setContentText
(
aAlertText
)
.
setSmallIcon
(
notification
.
icon
)
.
setWhen
(
notification
.
when
)
.
setContentIntent
(
notification
.
contentIntent
)
.
setProgress
(
(
int
)
aProgressMax
(
int
)
aProgress
false
)
.
build
(
)
;
add
(
notificationID
notification
)
;
}
public
void
remove
(
int
notificationID
)
{
final
Notification
notification
=
mNotifications
.
remove
(
notificationID
)
;
if
(
notification
!
=
null
)
{
updateForegroundNotification
(
notificationID
notification
)
;
}
mNotificationManager
.
cancel
(
notificationID
)
;
}
public
boolean
isDone
(
)
{
return
mNotifications
.
isEmpty
(
)
;
}
public
boolean
isOngoing
(
int
notificationID
)
{
final
Notification
notification
=
mNotifications
.
get
(
notificationID
)
;
return
isOngoing
(
notification
)
;
}
public
boolean
isOngoing
(
Notification
notification
)
{
if
(
notification
!
=
null
&
&
(
notification
.
flags
&
Notification
.
FLAG_ONGOING_EVENT
)
>
0
)
{
return
true
;
}
return
false
;
}
protected
void
setForegroundNotification
(
int
id
Notification
notification
)
{
mForegroundNotificationId
=
id
;
mForegroundNotification
=
notification
;
}
private
void
updateForegroundNotification
(
int
oldId
Notification
oldNotification
)
{
if
(
mForegroundNotificationId
=
=
oldId
)
{
Notification
foregroundNotification
=
null
;
int
foregroundId
=
0
;
for
(
final
Integer
id
:
mNotifications
.
keySet
(
)
)
{
final
Notification
notification
=
mNotifications
.
get
(
id
)
;
if
(
isOngoing
(
notification
)
)
{
foregroundNotification
=
notification
;
foregroundId
=
id
;
break
;
}
}
setForegroundNotification
(
foregroundId
foregroundNotification
)
;
}
}
}
