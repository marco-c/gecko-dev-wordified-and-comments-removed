package
org
.
mozilla
.
gecko
.
icons
.
processing
;
import
android
.
support
.
v7
.
graphics
.
Palette
;
import
android
.
util
.
Log
;
import
org
.
mozilla
.
gecko
.
gfx
.
BitmapUtils
;
import
org
.
mozilla
.
gecko
.
icons
.
IconRequest
;
import
org
.
mozilla
.
gecko
.
icons
.
IconResponse
;
import
org
.
mozilla
.
gecko
.
util
.
HardwareUtils
;
public
class
ColorProcessor
implements
Processor
{
private
static
final
String
LOGTAG
=
"
GeckoColorProcessor
"
;
private
static
final
int
DEFAULT_COLOR
=
0
;
Override
public
void
process
(
IconRequest
request
IconResponse
response
)
{
if
(
response
.
hasColor
(
)
)
{
return
;
}
if
(
HardwareUtils
.
isX86System
(
)
)
{
extractColorUsingCustomImplementation
(
response
)
;
}
else
{
extractColorUsingPaletteSupportLibrary
(
response
)
;
}
}
private
void
extractColorUsingPaletteSupportLibrary
(
final
IconResponse
response
)
{
try
{
final
Palette
palette
=
Palette
.
from
(
response
.
getBitmap
(
)
)
.
generate
(
)
;
response
.
updateColor
(
palette
.
getVibrantColor
(
DEFAULT_COLOR
)
&
0x7FFFFFFF
)
;
}
catch
(
ArrayIndexOutOfBoundsException
e
)
{
Log
.
e
(
LOGTAG
"
Palette
generation
failed
with
ArrayIndexOutOfBoundsException
"
e
)
;
response
.
updateColor
(
DEFAULT_COLOR
)
;
}
}
private
void
extractColorUsingCustomImplementation
(
final
IconResponse
response
)
{
final
int
dominantColor
=
BitmapUtils
.
getDominantColor
(
response
.
getBitmap
(
)
)
;
response
.
updateColor
(
dominantColor
)
;
}
}
