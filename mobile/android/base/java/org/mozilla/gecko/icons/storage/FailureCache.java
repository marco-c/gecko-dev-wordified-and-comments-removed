package
org
.
mozilla
.
gecko
.
icons
.
storage
;
import
android
.
os
.
SystemClock
;
import
android
.
support
.
annotation
.
NonNull
;
import
android
.
support
.
annotation
.
VisibleForTesting
;
import
android
.
util
.
LruCache
;
public
class
FailureCache
{
private
static
final
long
FAILURE_RETRY_MILLISECONDS
=
1000
*
60
*
60
*
4
;
private
static
final
int
MAX_ENTRIES
=
25
;
private
static
FailureCache
instance
;
public
static
synchronized
FailureCache
get
(
)
{
if
(
instance
=
=
null
)
{
instance
=
new
FailureCache
(
)
;
}
return
instance
;
}
private
final
LruCache
<
String
Long
>
cache
;
private
FailureCache
(
)
{
cache
=
new
LruCache
<
>
(
MAX_ENTRIES
)
;
}
public
void
rememberFailure
(
NonNull
String
iconUrl
)
{
cache
.
put
(
iconUrl
SystemClock
.
elapsedRealtime
(
)
)
;
}
public
boolean
isKnownFailure
(
NonNull
String
iconUrl
)
{
synchronized
(
cache
)
{
final
Long
failedAt
=
cache
.
get
(
iconUrl
)
;
if
(
failedAt
=
=
null
)
{
return
false
;
}
if
(
failedAt
+
FAILURE_RETRY_MILLISECONDS
<
SystemClock
.
elapsedRealtime
(
)
)
{
cache
.
remove
(
iconUrl
)
;
return
false
;
}
}
return
true
;
}
VisibleForTesting
public
void
evictAll
(
)
{
cache
.
evictAll
(
)
;
}
}
