package
org
.
mozilla
.
gecko
.
activitystream
.
homepanel
.
topsites
;
import
android
.
content
.
Context
;
import
android
.
support
.
annotation
.
UiThread
;
import
android
.
support
.
v7
.
widget
.
RecyclerView
;
import
android
.
text
.
TextUtils
;
import
android
.
view
.
View
;
import
android
.
widget
.
FrameLayout
;
import
android
.
widget
.
ImageView
;
import
android
.
widget
.
TextView
;
import
org
.
mozilla
.
gecko
.
R
;
import
org
.
mozilla
.
gecko
.
activitystream
.
homepanel
.
model
.
TopSite
;
import
org
.
mozilla
.
gecko
.
activitystream
.
homepanel
.
stream
.
TopPanelRow
;
import
org
.
mozilla
.
gecko
.
db
.
BrowserDB
;
import
org
.
mozilla
.
gecko
.
icons
.
IconCallback
;
import
org
.
mozilla
.
gecko
.
icons
.
IconResponse
;
import
org
.
mozilla
.
gecko
.
icons
.
Icons
;
import
org
.
mozilla
.
gecko
.
util
.
StringUtils
;
import
org
.
mozilla
.
gecko
.
util
.
URIUtils
;
import
org
.
mozilla
.
gecko
.
util
.
ViewUtil
;
import
org
.
mozilla
.
gecko
.
widget
.
FaviconView
;
import
java
.
lang
.
ref
.
WeakReference
;
import
java
.
net
.
URI
;
import
java
.
net
.
URISyntaxException
;
import
java
.
util
.
UUID
;
import
java
.
util
.
concurrent
.
Future
;
class
TopSitesCard
extends
RecyclerView
.
ViewHolder
implements
IconCallback
{
private
final
FaviconView
faviconView
;
private
final
TextView
title
;
private
final
ImageView
pinIconView
;
private
Future
<
IconResponse
>
ongoingIconLoad
;
private
TopSite
topSite
;
private
int
absolutePosition
;
TopSitesCard
(
final
FrameLayout
card
final
TopPanelRow
.
OnCardLongClickListener
onCardLongClickListener
)
{
super
(
card
)
;
faviconView
=
(
FaviconView
)
card
.
findViewById
(
R
.
id
.
favicon
)
;
title
=
(
TextView
)
card
.
findViewById
(
R
.
id
.
title
)
;
pinIconView
=
(
ImageView
)
card
.
findViewById
(
R
.
id
.
pin_icon
)
;
card
.
setOnLongClickListener
(
new
View
.
OnLongClickListener
(
)
{
Override
public
boolean
onLongClick
(
View
v
)
{
if
(
onCardLongClickListener
!
=
null
)
{
return
onCardLongClickListener
.
onClick
(
topSite
absolutePosition
faviconView
.
getWidth
(
)
faviconView
.
getHeight
(
)
)
;
}
return
false
;
}
}
)
;
ViewUtil
.
enableTouchRipple
(
card
)
;
}
void
bind
(
final
TopSite
topSite
final
int
absolutePosition
)
{
this
.
topSite
=
topSite
;
this
.
absolutePosition
=
absolutePosition
;
if
(
ongoingIconLoad
!
=
null
)
{
ongoingIconLoad
.
cancel
(
true
)
;
}
if
(
TextUtils
.
isEmpty
(
topSite
.
getUrl
(
)
)
)
{
faviconView
.
clearImage
(
)
;
}
else
{
ongoingIconLoad
=
Icons
.
with
(
itemView
.
getContext
(
)
)
.
pageUrl
(
topSite
.
getUrl
(
)
)
.
skipNetwork
(
)
.
forActivityStream
(
)
.
build
(
)
.
execute
(
this
)
;
}
pinIconView
.
setVisibility
(
topSite
.
isPinned
(
)
?
View
.
VISIBLE
:
View
.
GONE
)
;
setTopSiteTitle
(
topSite
)
;
}
private
void
setTopSiteTitle
(
final
TopSite
topSite
)
{
URI
topSiteURI
=
null
;
boolean
isInvalidURI
=
false
;
try
{
topSiteURI
=
new
URI
(
topSite
.
getUrl
(
)
)
;
}
catch
(
final
URISyntaxException
e
)
{
isInvalidURI
=
true
;
}
final
boolean
isSiteSuggestedFromDistribution
=
BrowserDB
.
from
(
itemView
.
getContext
(
)
)
.
getSuggestedSites
(
)
.
containsSiteAndSiteIsFromDistribution
(
topSite
.
getUrl
(
)
)
;
title
.
setMaxLines
(
isSiteSuggestedFromDistribution
?
2
:
1
)
;
final
String
pageTitle
=
topSite
.
getTitle
(
)
;
if
(
isInvalidURI
|
|
isSiteSuggestedFromDistribution
)
{
final
String
updateText
=
!
TextUtils
.
isEmpty
(
pageTitle
)
?
pageTitle
:
topSite
.
getUrl
(
)
;
setTopSiteTitleHelper
(
title
updateText
)
;
}
else
if
(
URIUtils
.
isPathEmpty
(
topSiteURI
)
|
|
(
!
URIUtils
.
isPathEmpty
(
topSiteURI
)
&
&
TextUtils
.
isEmpty
(
pageTitle
)
)
)
{
final
UpdateCardTitleAsyncTask
titleAsyncTask
=
new
UpdateCardTitleAsyncTask
(
itemView
.
getContext
(
)
topSiteURI
title
)
;
titleAsyncTask
.
execute
(
)
;
}
else
{
setTopSiteTitleHelper
(
title
pageTitle
)
;
}
}
private
static
void
setTopSiteTitleHelper
(
final
TextView
textView
final
String
title
)
{
ViewUtil
.
setCenteredText
(
textView
title
textView
.
getPaddingTop
(
)
)
;
}
Override
public
void
onIconResponse
(
IconResponse
response
)
{
faviconView
.
updateImage
(
response
)
;
}
private
static
class
UpdateCardTitleAsyncTask
extends
URIUtils
.
GetFormattedDomainAsyncTask
{
private
static
final
int
VIEW_TAG_ID
=
R
.
id
.
title
;
private
final
WeakReference
<
TextView
>
titleViewWeakReference
;
private
final
UUID
viewTagAtStart
;
UpdateCardTitleAsyncTask
(
final
Context
contextReference
final
URI
uri
final
TextView
titleView
)
{
super
(
contextReference
uri
false
1
)
;
this
.
titleViewWeakReference
=
new
WeakReference
<
>
(
titleView
)
;
viewTagAtStart
=
UUID
.
randomUUID
(
)
;
titleView
.
setTag
(
VIEW_TAG_ID
viewTagAtStart
)
;
}
Override
protected
void
onPostExecute
(
final
String
hostText
)
{
super
.
onPostExecute
(
hostText
)
;
final
TextView
titleView
=
titleViewWeakReference
.
get
(
)
;
if
(
titleView
=
=
null
|
|
!
isTagSameAsStartTag
(
titleView
)
)
{
return
;
}
final
String
updateText
;
if
(
TextUtils
.
isEmpty
(
hostText
)
)
{
updateText
=
"
"
;
}
else
{
updateText
=
StringUtils
.
stripCommonSubdomains
(
hostText
)
;
}
setTopSiteTitleHelper
(
titleView
updateText
)
;
}
UiThread
private
boolean
isTagSameAsStartTag
(
final
View
viewToCheck
)
{
return
viewTagAtStart
.
equals
(
viewToCheck
.
getTag
(
VIEW_TAG_ID
)
)
;
}
}
}
