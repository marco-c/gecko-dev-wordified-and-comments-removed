package
org
.
mozilla
.
gecko
.
activitystream
.
homepanel
.
topsites
;
import
android
.
content
.
Context
;
import
android
.
graphics
.
Color
;
import
android
.
graphics
.
drawable
.
Drawable
;
import
android
.
support
.
annotation
.
UiThread
;
import
android
.
support
.
v4
.
widget
.
TextViewCompat
;
import
android
.
support
.
v7
.
widget
.
RecyclerView
;
import
android
.
text
.
TextUtils
;
import
android
.
view
.
View
;
import
android
.
widget
.
FrameLayout
;
import
android
.
widget
.
TextView
;
import
org
.
mozilla
.
gecko
.
R
;
import
org
.
mozilla
.
gecko
.
Telemetry
;
import
org
.
mozilla
.
gecko
.
TelemetryContract
;
import
org
.
mozilla
.
gecko
.
activitystream
.
ActivityStreamTelemetry
;
import
org
.
mozilla
.
gecko
.
activitystream
.
homepanel
.
menu
.
ActivityStreamContextMenu
;
import
org
.
mozilla
.
gecko
.
activitystream
.
homepanel
.
model
.
TopSite
;
import
org
.
mozilla
.
gecko
.
home
.
HomePager
;
import
org
.
mozilla
.
gecko
.
icons
.
IconCallback
;
import
org
.
mozilla
.
gecko
.
icons
.
IconResponse
;
import
org
.
mozilla
.
gecko
.
icons
.
Icons
;
import
org
.
mozilla
.
gecko
.
util
.
DrawableUtil
;
import
org
.
mozilla
.
gecko
.
util
.
StringUtils
;
import
org
.
mozilla
.
gecko
.
util
.
URIUtils
;
import
org
.
mozilla
.
gecko
.
util
.
ViewUtil
;
import
org
.
mozilla
.
gecko
.
widget
.
FaviconView
;
import
java
.
lang
.
ref
.
WeakReference
;
import
java
.
net
.
URI
;
import
java
.
net
.
URISyntaxException
;
import
java
.
util
.
UUID
;
import
java
.
util
.
concurrent
.
Future
;
class
TopSitesCard
extends
RecyclerView
.
ViewHolder
implements
IconCallback
{
private
final
FaviconView
faviconView
;
private
final
TextView
title
;
private
Future
<
IconResponse
>
ongoingIconLoad
;
private
TopSite
topSite
;
private
int
absolutePosition
;
private
final
HomePager
.
OnUrlOpenListener
onUrlOpenListener
;
private
final
HomePager
.
OnUrlOpenInBackgroundListener
onUrlOpenInBackgroundListener
;
TopSitesCard
(
final
FrameLayout
card
final
HomePager
.
OnUrlOpenListener
onUrlOpenListener
final
HomePager
.
OnUrlOpenInBackgroundListener
onUrlOpenInBackgroundListener
)
{
super
(
card
)
;
faviconView
=
(
FaviconView
)
card
.
findViewById
(
R
.
id
.
favicon
)
;
title
=
(
TextView
)
card
.
findViewById
(
R
.
id
.
title
)
;
this
.
onUrlOpenListener
=
onUrlOpenListener
;
this
.
onUrlOpenInBackgroundListener
=
onUrlOpenInBackgroundListener
;
card
.
setOnLongClickListener
(
new
View
.
OnLongClickListener
(
)
{
Override
public
boolean
onLongClick
(
View
v
)
{
ActivityStreamTelemetry
.
Extras
.
Builder
extras
=
ActivityStreamTelemetry
.
Extras
.
builder
(
)
.
forTopSite
(
topSite
)
.
set
(
ActivityStreamTelemetry
.
Contract
.
ACTION_POSITION
absolutePosition
)
;
ActivityStreamContextMenu
.
show
(
itemView
.
getContext
(
)
card
extras
ActivityStreamContextMenu
.
MenuMode
.
TOPSITE
topSite
onUrlOpenListener
onUrlOpenInBackgroundListener
faviconView
.
getWidth
(
)
faviconView
.
getHeight
(
)
)
;
Telemetry
.
sendUIEvent
(
TelemetryContract
.
Event
.
SHOW
TelemetryContract
.
Method
.
CONTEXT_MENU
extras
.
build
(
)
)
;
return
true
;
}
}
)
;
ViewUtil
.
enableTouchRipple
(
card
)
;
}
void
bind
(
final
TopSite
topSite
final
int
absolutePosition
)
{
this
.
topSite
=
topSite
;
this
.
absolutePosition
=
absolutePosition
;
if
(
ongoingIconLoad
!
=
null
)
{
ongoingIconLoad
.
cancel
(
true
)
;
}
ongoingIconLoad
=
Icons
.
with
(
itemView
.
getContext
(
)
)
.
pageUrl
(
topSite
.
getUrl
(
)
)
.
skipNetwork
(
)
.
build
(
)
.
execute
(
this
)
;
final
Drawable
pinDrawable
;
if
(
topSite
.
isPinned
(
)
)
{
pinDrawable
=
DrawableUtil
.
tintDrawable
(
itemView
.
getContext
(
)
R
.
drawable
.
as_pin
Color
.
WHITE
)
;
}
else
{
pinDrawable
=
null
;
}
TextViewCompat
.
setCompoundDrawablesRelativeWithIntrinsicBounds
(
title
pinDrawable
null
null
null
)
;
setTopSiteTitle
(
topSite
)
;
}
private
void
setTopSiteTitle
(
final
TopSite
topSite
)
{
URI
topSiteURI
=
null
;
boolean
wasException
=
false
;
try
{
topSiteURI
=
new
URI
(
topSite
.
getUrl
(
)
)
;
}
catch
(
final
URISyntaxException
e
)
{
wasException
=
true
;
}
if
(
wasException
|
|
!
URIUtils
.
isPathEmpty
(
topSiteURI
)
)
{
final
String
pageTitle
=
topSite
.
getTitle
(
)
;
final
String
updateText
=
!
TextUtils
.
isEmpty
(
pageTitle
)
?
pageTitle
:
topSite
.
getUrl
(
)
;
setTopSiteTitleHelper
(
title
updateText
)
;
}
else
{
final
UpdateCardTitleAsyncTask
titleAsyncTask
=
new
UpdateCardTitleAsyncTask
(
itemView
.
getContext
(
)
topSiteURI
title
)
;
titleAsyncTask
.
execute
(
)
;
}
}
private
static
void
setTopSiteTitleHelper
(
final
TextView
textView
final
String
title
)
{
ViewUtil
.
setCenteredText
(
textView
title
textView
.
getPaddingTop
(
)
)
;
}
Override
public
void
onIconResponse
(
IconResponse
response
)
{
faviconView
.
updateImage
(
response
)
;
}
private
static
class
UpdateCardTitleAsyncTask
extends
URIUtils
.
GetFormattedDomainAsyncTask
{
private
static
final
int
VIEW_TAG_ID
=
R
.
id
.
title
;
private
final
WeakReference
<
TextView
>
titleViewWeakReference
;
private
final
UUID
viewTagAtStart
;
UpdateCardTitleAsyncTask
(
final
Context
contextReference
final
URI
uri
final
TextView
titleView
)
{
super
(
contextReference
uri
false
1
)
;
this
.
titleViewWeakReference
=
new
WeakReference
<
>
(
titleView
)
;
viewTagAtStart
=
UUID
.
randomUUID
(
)
;
titleView
.
setTag
(
VIEW_TAG_ID
viewTagAtStart
)
;
}
Override
protected
void
onPostExecute
(
final
String
hostText
)
{
super
.
onPostExecute
(
hostText
)
;
final
TextView
titleView
=
titleViewWeakReference
.
get
(
)
;
if
(
titleView
=
=
null
|
|
!
isTagSameAsStartTag
(
titleView
)
)
{
return
;
}
final
String
updateText
;
if
(
TextUtils
.
isEmpty
(
hostText
)
)
{
updateText
=
"
"
;
}
else
{
updateText
=
StringUtils
.
stripCommonSubdomains
(
hostText
)
;
}
setTopSiteTitleHelper
(
titleView
updateText
)
;
}
UiThread
private
boolean
isTagSameAsStartTag
(
final
View
viewToCheck
)
{
return
viewTagAtStart
.
equals
(
viewToCheck
.
getTag
(
VIEW_TAG_ID
)
)
;
}
}
}
