package
org
.
mozilla
.
gecko
;
import
android
.
app
.
Activity
;
import
android
.
app
.
Application
;
import
android
.
content
.
ContentResolver
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
content
.
res
.
Configuration
;
import
android
.
graphics
.
Bitmap
;
import
android
.
graphics
.
Canvas
;
import
android
.
net
.
Uri
;
import
android
.
os
.
Process
;
import
android
.
os
.
SystemClock
;
import
android
.
text
.
TextUtils
;
import
android
.
util
.
Log
;
import
com
.
squareup
.
leakcanary
.
LeakCanary
;
import
com
.
squareup
.
leakcanary
.
RefWatcher
;
import
org
.
mozilla
.
gecko
.
annotation
.
WrapForJNI
;
import
org
.
mozilla
.
gecko
.
db
.
BrowserContract
;
import
org
.
mozilla
.
gecko
.
db
.
BrowserDB
;
import
org
.
mozilla
.
gecko
.
db
.
LocalBrowserDB
;
import
org
.
mozilla
.
gecko
.
distribution
.
Distribution
;
import
org
.
mozilla
.
gecko
.
home
.
HomePanelsManager
;
import
org
.
mozilla
.
gecko
.
icons
.
IconCallback
;
import
org
.
mozilla
.
gecko
.
icons
.
IconResponse
;
import
org
.
mozilla
.
gecko
.
icons
.
Icons
;
import
org
.
mozilla
.
gecko
.
lwt
.
LightweightTheme
;
import
org
.
mozilla
.
gecko
.
mdns
.
MulticastDNSManager
;
import
org
.
mozilla
.
gecko
.
media
.
AudioFocusAgent
;
import
org
.
mozilla
.
gecko
.
media
.
RemoteManager
;
import
org
.
mozilla
.
gecko
.
notifications
.
NotificationClient
;
import
org
.
mozilla
.
gecko
.
notifications
.
NotificationHelper
;
import
org
.
mozilla
.
gecko
.
permissions
.
Permissions
;
import
org
.
mozilla
.
gecko
.
preferences
.
DistroSharedPrefsImport
;
import
org
.
mozilla
.
gecko
.
util
.
ActivityUtils
;
import
org
.
mozilla
.
gecko
.
telemetry
.
TelemetryBackgroundReceiver
;
import
org
.
mozilla
.
gecko
.
util
.
BundleEventListener
;
import
org
.
mozilla
.
gecko
.
util
.
EventCallback
;
import
org
.
mozilla
.
gecko
.
util
.
GeckoBundle
;
import
org
.
mozilla
.
gecko
.
util
.
HardwareUtils
;
import
org
.
mozilla
.
gecko
.
util
.
PRNGFixes
;
import
org
.
mozilla
.
gecko
.
util
.
ShortcutUtils
;
import
org
.
mozilla
.
gecko
.
util
.
ThreadUtils
;
import
java
.
io
.
File
;
import
java
.
lang
.
reflect
.
Method
;
import
java
.
util
.
UUID
;
public
class
GeckoApplication
extends
Application
implements
HapticFeedbackDelegate
{
private
static
final
String
LOG_TAG
=
"
GeckoApplication
"
;
private
static
final
String
MEDIA_DECODING_PROCESS_CRASH
=
"
MEDIA_DECODING_PROCESS_CRASH
"
;
private
boolean
mInBackground
;
private
boolean
mPausedGecko
;
private
boolean
mIsInitialResume
;
private
LightweightTheme
mLightweightTheme
;
private
RefWatcher
mRefWatcher
;
private
static
String
sSessionUUID
=
null
;
public
GeckoApplication
(
)
{
super
(
)
;
}
public
static
RefWatcher
getRefWatcher
(
Context
context
)
{
GeckoApplication
app
=
(
GeckoApplication
)
context
.
getApplicationContext
(
)
;
return
app
.
mRefWatcher
;
}
public
static
void
watchReference
(
Context
context
Object
object
)
{
if
(
context
=
=
null
)
{
return
;
}
getRefWatcher
(
context
)
.
watch
(
object
)
;
}
public
static
String
getSessionUUID
(
)
{
return
sSessionUUID
;
}
public
static
String
addDefaultGeckoArgs
(
String
args
)
{
if
(
!
AppConstants
.
MOZILLA_OFFICIAL
)
{
Log
.
w
(
LOG_TAG
"
STARTUP
PERFORMANCE
WARNING
:
un
-
official
build
:
purging
the
"
+
"
startup
(
JavaScript
)
caches
.
"
)
;
args
=
(
args
!
=
null
)
?
(
args
+
"
-
purgecaches
"
)
:
"
-
purgecaches
"
;
}
return
args
;
}
public
static
String
getDefaultUAString
(
)
{
return
HardwareUtils
.
isTablet
(
)
?
AppConstants
.
USER_AGENT_FENNEC_TABLET
:
AppConstants
.
USER_AGENT_FENNEC_MOBILE
;
}
public
static
void
shutdown
(
final
Intent
restartIntent
)
{
ThreadUtils
.
assertOnUiThread
(
)
;
if
(
GeckoThread
.
isStateAtLeast
(
GeckoThread
.
State
.
PROFILE_READY
)
)
{
GeckoThread
.
waitOnGecko
(
)
;
}
if
(
restartIntent
=
=
null
)
{
Process
.
killProcess
(
Process
.
myPid
(
)
)
;
return
;
}
final
Context
context
=
GeckoAppShell
.
getApplicationContext
(
)
;
final
Intent
intent
=
new
Intent
(
)
;
intent
.
setClass
(
context
Restarter
.
class
)
.
putExtra
(
"
pid
"
Process
.
myPid
(
)
)
.
putExtra
(
Intent
.
EXTRA_INTENT
restartIntent
)
;
context
.
startService
(
intent
)
;
}
Override
public
void
onConfigurationChanged
(
Configuration
config
)
{
Log
.
d
(
LOG_TAG
"
onConfigurationChanged
:
"
+
config
.
locale
+
"
background
:
"
+
mInBackground
)
;
if
(
mInBackground
)
{
super
.
onConfigurationChanged
(
config
)
;
return
;
}
try
{
BrowserLocaleManager
.
getInstance
(
)
.
correctLocale
(
this
getResources
(
)
config
)
;
}
catch
(
IllegalStateException
ex
)
{
Log
.
w
(
LOG_TAG
"
Couldn
'
t
correct
locale
.
"
ex
)
;
}
super
.
onConfigurationChanged
(
config
)
;
}
public
void
onApplicationBackground
(
)
{
mInBackground
=
true
;
GeckoThread
.
onPause
(
)
;
mPausedGecko
=
true
;
final
BrowserDB
db
=
BrowserDB
.
from
(
this
)
;
ThreadUtils
.
postToBackgroundThread
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
db
.
expireHistory
(
getContentResolver
(
)
BrowserContract
.
ExpirePriority
.
NORMAL
)
;
}
}
)
;
GeckoNetworkManager
.
getInstance
(
)
.
stop
(
)
;
}
public
void
onApplicationForeground
(
)
{
if
(
mIsInitialResume
)
{
GeckoBatteryManager
.
getInstance
(
)
.
start
(
this
)
;
GeckoFontScaleListener
.
getInstance
(
)
.
initialize
(
this
)
;
GeckoNetworkManager
.
getInstance
(
)
.
start
(
this
)
;
mIsInitialResume
=
false
;
}
else
if
(
mPausedGecko
)
{
GeckoThread
.
onResume
(
)
;
mPausedGecko
=
false
;
GeckoNetworkManager
.
getInstance
(
)
.
start
(
this
)
;
}
mInBackground
=
false
;
}
Override
public
void
onCreate
(
)
{
Log
.
i
(
LOG_TAG
"
zerdatime
"
+
SystemClock
.
elapsedRealtime
(
)
+
"
-
application
start
"
)
;
try
{
PRNGFixes
.
apply
(
)
;
}
catch
(
Exception
e
)
{
Log
.
e
(
LOG_TAG
"
Got
exception
applying
PRNGFixes
!
Cryptographic
data
produced
on
this
device
may
be
weak
.
Ignoring
.
"
e
)
;
}
mIsInitialResume
=
true
;
mRefWatcher
=
LeakCanary
.
install
(
this
)
;
sSessionUUID
=
UUID
.
randomUUID
(
)
.
toString
(
)
;
GeckoActivityMonitor
.
getInstance
(
)
.
initialize
(
this
)
;
MemoryMonitor
.
getInstance
(
)
.
init
(
this
)
;
final
Context
context
=
getApplicationContext
(
)
;
GeckoAppShell
.
setApplicationContext
(
context
)
;
GeckoAppShell
.
setHapticFeedbackDelegate
(
this
)
;
GeckoAppShell
.
setGeckoInterface
(
new
GeckoAppShell
.
GeckoInterface
(
)
{
Override
public
boolean
openUriExternal
(
final
String
targetURI
final
String
mimeType
final
String
packageName
final
String
className
final
String
action
final
String
title
)
{
return
IntentHelper
.
openUriExternal
(
targetURI
mimeType
packageName
className
action
title
true
)
;
}
Override
public
String
[
]
getHandlersForMimeType
(
final
String
mimeType
final
String
action
)
{
final
Intent
intent
=
IntentHelper
.
getIntentForActionString
(
action
)
;
if
(
mimeType
!
=
null
&
&
mimeType
.
length
(
)
>
0
)
{
intent
.
setType
(
mimeType
)
;
}
return
IntentHelper
.
getHandlersForIntent
(
intent
)
;
}
Override
public
String
[
]
getHandlersForURL
(
final
String
url
final
String
action
)
{
final
Uri
uri
=
url
.
indexOf
(
'
:
'
)
>
=
0
?
Uri
.
parse
(
url
)
:
new
Uri
.
Builder
(
)
.
scheme
(
url
)
.
build
(
)
;
final
Intent
intent
=
IntentHelper
.
getOpenURIIntent
(
getApplicationContext
(
)
uri
.
toString
(
)
"
"
TextUtils
.
isEmpty
(
action
)
?
Intent
.
ACTION_VIEW
:
action
"
"
)
;
return
IntentHelper
.
getHandlersForIntent
(
intent
)
;
}
}
)
;
HardwareUtils
.
init
(
context
)
;
FilePicker
.
init
(
context
)
;
DownloadsIntegration
.
init
(
)
;
HomePanelsManager
.
getInstance
(
)
.
init
(
context
)
;
GlobalPageMetadata
.
getInstance
(
)
.
init
(
)
;
TelemetryBackgroundReceiver
.
getInstance
(
)
.
init
(
context
)
;
GeckoAppShell
.
setNotificationListener
(
new
NotificationClient
(
context
)
)
;
NotificationHelper
.
getInstance
(
context
)
.
init
(
)
;
MulticastDNSManager
.
getInstance
(
context
)
.
init
(
)
;
GeckoService
.
register
(
)
;
IntentHelper
.
init
(
)
;
final
EventListener
listener
=
new
EventListener
(
)
;
EventDispatcher
.
getInstance
(
)
.
registerUiThreadListener
(
listener
"
Gecko
:
Exited
"
"
RuntimePermissions
:
Check
"
"
Snackbar
:
Show
"
"
Share
:
Text
"
null
)
;
EventDispatcher
.
getInstance
(
)
.
registerBackgroundThreadListener
(
listener
"
Profile
:
Create
"
null
)
;
super
.
onCreate
(
)
;
}
public
void
onDelayedStartup
(
)
{
if
(
AppConstants
.
MOZ_ANDROID_GCM
)
{
ThreadUtils
.
postToBackgroundThread
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
try
{
final
Class
<
?
>
clazz
=
Class
.
forName
(
"
org
.
mozilla
.
gecko
.
push
.
PushService
"
)
;
final
Method
onCreate
=
clazz
.
getMethod
(
"
onCreate
"
Context
.
class
)
;
onCreate
.
invoke
(
null
getApplicationContext
(
)
)
;
}
catch
(
Exception
e
)
{
Log
.
e
(
LOG_TAG
"
Got
exception
during
startup
;
ignoring
.
"
e
)
;
return
;
}
}
}
)
;
}
GeckoAccessibility
.
setAccessibilityManagerListeners
(
this
)
;
AudioFocusAgent
.
getInstance
(
)
.
attachToContext
(
this
)
;
RemoteManager
.
setCrashReporter
(
new
RemoteManager
.
ICrashReporter
(
)
{
public
void
reportDecodingProcessCrash
(
)
{
Telemetry
.
addToHistogram
(
MEDIA_DECODING_PROCESS_CRASH
1
)
;
}
}
)
;
}
private
class
EventListener
implements
BundleEventListener
{
private
void
onProfileCreate
(
final
String
name
final
String
path
)
{
final
Context
context
=
GeckoApplication
.
this
;
final
GeckoProfile
profile
=
GeckoProfile
.
get
(
context
name
)
;
final
Distribution
distribution
=
Distribution
.
getInstance
(
context
)
;
distribution
.
addOnDistributionReadyCallback
(
new
Distribution
.
ReadyCallback
(
)
{
Override
public
void
distributionNotFound
(
)
{
this
.
distributionFound
(
null
)
;
}
Override
public
void
distributionFound
(
final
Distribution
distribution
)
{
Log
.
d
(
LOG_TAG
"
Running
post
-
distribution
task
:
bookmarks
.
"
)
;
synchronized
(
profile
.
getLock
(
)
)
{
distributionFoundLocked
(
distribution
)
;
}
}
Override
public
void
distributionArrivedLate
(
final
Distribution
distribution
)
{
Log
.
d
(
LOG_TAG
"
Running
late
distribution
task
:
bookmarks
.
"
)
;
synchronized
(
profile
.
getLock
(
)
)
{
distributionArrivedLateLocked
(
distribution
)
;
}
}
private
void
distributionFoundLocked
(
final
Distribution
distribution
)
{
if
(
!
(
new
File
(
path
)
)
.
exists
(
)
)
{
return
;
}
final
ContentResolver
cr
=
context
.
getContentResolver
(
)
;
final
LocalBrowserDB
db
=
new
LocalBrowserDB
(
profile
.
getName
(
)
)
;
final
int
offset
=
distribution
=
=
null
?
0
:
db
.
addDistributionBookmarks
(
cr
distribution
0
)
;
db
.
addDefaultBookmarks
(
context
cr
offset
)
;
Log
.
d
(
LOG_TAG
"
Running
post
-
distribution
task
:
android
preferences
.
"
)
;
DistroSharedPrefsImport
.
importPreferences
(
context
distribution
)
;
}
private
void
distributionArrivedLateLocked
(
final
Distribution
distribution
)
{
if
(
!
(
new
File
(
path
)
)
.
exists
(
)
)
{
return
;
}
final
ContentResolver
cr
=
context
.
getContentResolver
(
)
;
final
LocalBrowserDB
db
=
new
LocalBrowserDB
(
profile
.
getName
(
)
)
;
final
int
offset
=
db
.
getCount
(
cr
"
bookmarks
"
)
;
db
.
addDistributionBookmarks
(
cr
distribution
offset
)
;
Log
.
d
(
LOG_TAG
"
Running
late
distribution
task
:
android
preferences
.
"
)
;
DistroSharedPrefsImport
.
importPreferences
(
context
distribution
)
;
}
}
)
;
}
Override
public
void
handleMessage
(
final
String
event
final
GeckoBundle
message
final
EventCallback
callback
)
{
if
(
"
Profile
:
Create
"
.
equals
(
event
)
)
{
onProfileCreate
(
message
.
getString
(
"
name
"
)
message
.
getString
(
"
path
"
)
)
;
}
else
if
(
"
Gecko
:
Exited
"
.
equals
(
event
)
)
{
final
Intent
restartIntent
;
if
(
message
.
getBoolean
(
"
restart
"
)
)
{
restartIntent
=
new
Intent
(
Intent
.
ACTION_MAIN
)
;
restartIntent
.
setClassName
(
GeckoAppShell
.
getApplicationContext
(
)
AppConstants
.
MOZ_ANDROID_BROWSER_INTENT_CLASS
)
;
}
else
{
restartIntent
=
null
;
}
shutdown
(
restartIntent
)
;
}
else
if
(
"
RuntimePermissions
:
Check
"
.
equals
(
event
)
)
{
final
String
[
]
permissions
=
message
.
getStringArray
(
"
permissions
"
)
;
final
boolean
shouldPrompt
=
message
.
getBoolean
(
"
shouldPrompt
"
false
)
;
final
Activity
currentActivity
=
GeckoActivityMonitor
.
getInstance
(
)
.
getCurrentActivity
(
)
;
final
Context
context
=
(
currentActivity
!
=
null
)
?
currentActivity
:
GeckoAppShell
.
getApplicationContext
(
)
;
Permissions
.
from
(
context
)
.
withPermissions
(
permissions
)
.
doNotPromptIf
(
!
shouldPrompt
|
|
currentActivity
=
=
null
)
.
andFallback
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
callback
.
sendSuccess
(
false
)
;
}
}
)
.
run
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
callback
.
sendSuccess
(
true
)
;
}
}
)
;
}
else
if
(
"
Share
:
Text
"
.
equals
(
event
)
)
{
final
String
text
=
message
.
getString
(
"
text
"
)
;
final
String
title
=
message
.
getString
(
"
title
"
"
"
)
;
IntentHelper
.
openUriExternal
(
text
"
text
/
plain
"
"
"
"
"
Intent
.
ACTION_SEND
title
false
)
;
Telemetry
.
sendUIEvent
(
TelemetryContract
.
Event
.
SHARE
TelemetryContract
.
Method
.
LIST
"
text
"
)
;
}
else
if
(
"
Snackbar
:
Show
"
.
equals
(
event
)
)
{
final
Activity
currentActivity
=
GeckoActivityMonitor
.
getInstance
(
)
.
getCurrentActivity
(
)
;
if
(
currentActivity
=
=
null
)
{
if
(
callback
!
=
null
)
{
callback
.
sendError
(
"
No
activity
"
)
;
}
return
;
}
SnackbarBuilder
.
builder
(
currentActivity
)
.
fromEvent
(
message
)
.
callback
(
callback
)
.
buildAndShow
(
)
;
}
}
}
public
boolean
isApplicationInBackground
(
)
{
return
mInBackground
;
}
public
LightweightTheme
getLightweightTheme
(
)
{
return
mLightweightTheme
;
}
public
void
prepareLightweightTheme
(
)
{
mLightweightTheme
=
new
LightweightTheme
(
this
)
;
}
WrapForJNI
(
calledFrom
=
"
gecko
"
)
public
static
void
createShortcut
(
final
String
title
final
String
url
)
{
final
Tab
selectedTab
=
Tabs
.
getInstance
(
)
.
getSelectedTab
(
)
;
final
String
manifestUrl
=
selectedTab
.
getManifestUrl
(
)
;
if
(
manifestUrl
!
=
null
)
{
final
GeckoBundle
message
=
new
GeckoBundle
(
)
;
message
.
putInt
(
"
iconSize
"
GeckoAppShell
.
getPreferredIconSize
(
)
)
;
message
.
putString
(
"
manifestUrl
"
manifestUrl
)
;
message
.
putString
(
"
originalUrl
"
url
)
;
message
.
putString
(
"
originalTitle
"
title
)
;
EventDispatcher
.
getInstance
(
)
.
dispatch
(
"
Browser
:
LoadManifest
"
message
)
;
return
;
}
createBrowserShortcut
(
title
url
)
;
}
public
static
void
createBrowserShortcut
(
final
String
title
final
String
url
)
{
Icons
.
with
(
GeckoAppShell
.
getApplicationContext
(
)
)
.
pageUrl
(
url
)
.
skipNetwork
(
)
.
skipMemory
(
)
.
forLauncherIcon
(
)
.
build
(
)
.
execute
(
new
IconCallback
(
)
{
Override
public
void
onIconResponse
(
final
IconResponse
response
)
{
createShortcutWithIcon
(
title
url
response
.
getBitmap
(
)
)
;
}
}
)
;
}
static
void
createShortcutWithIcon
(
final
String
aTitle
final
String
aURI
final
Bitmap
aIcon
)
{
final
Intent
shortcutIntent
=
new
Intent
(
)
;
shortcutIntent
.
setAction
(
GeckoApp
.
ACTION_HOMESCREEN_SHORTCUT
)
;
shortcutIntent
.
setData
(
Uri
.
parse
(
aURI
)
)
;
shortcutIntent
.
setClassName
(
AppConstants
.
ANDROID_PACKAGE_NAME
AppConstants
.
MOZ_ANDROID_BROWSER_INTENT_CLASS
)
;
ShortcutUtils
.
createHomescreenIcon
(
shortcutIntent
aTitle
aURI
aIcon
)
;
}
public
static
void
createAppShortcut
(
final
String
aTitle
final
String
aURI
final
String
manifestPath
final
String
manifestUrl
final
Bitmap
aIcon
)
{
final
Intent
shortcutIntent
=
new
Intent
(
)
;
shortcutIntent
.
setAction
(
GeckoApp
.
ACTION_WEBAPP
)
;
shortcutIntent
.
setData
(
Uri
.
parse
(
aURI
)
)
;
shortcutIntent
.
putExtra
(
"
MANIFEST_PATH
"
manifestPath
)
;
shortcutIntent
.
putExtra
(
"
MANIFEST_URL
"
manifestUrl
)
;
shortcutIntent
.
setClassName
(
AppConstants
.
ANDROID_PACKAGE_NAME
LauncherActivity
.
class
.
getName
(
)
)
;
Telemetry
.
sendUIEvent
(
TelemetryContract
.
Event
.
ACTION
TelemetryContract
.
Method
.
CONTEXT_MENU
"
pwa_add_to_launcher
"
)
;
ShortcutUtils
.
createHomescreenIcon
(
shortcutIntent
aTitle
aURI
aIcon
)
;
}
Override
public
void
performHapticFeedback
(
final
int
effect
)
{
final
Activity
currentActivity
=
GeckoActivityMonitor
.
getInstance
(
)
.
getCurrentActivity
(
)
;
if
(
currentActivity
!
=
null
)
{
currentActivity
.
getWindow
(
)
.
getDecorView
(
)
.
performHapticFeedback
(
effect
)
;
}
}
}
