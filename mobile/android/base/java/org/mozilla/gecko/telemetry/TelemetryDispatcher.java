package
org
.
mozilla
.
gecko
.
telemetry
;
import
android
.
content
.
Context
;
import
android
.
util
.
Log
;
import
org
.
mozilla
.
gecko
.
telemetry
.
pingbuilders
.
TelemetryCorePingBuilder
;
import
org
.
mozilla
.
gecko
.
telemetry
.
schedulers
.
TelemetryUploadScheduler
;
import
org
.
mozilla
.
gecko
.
telemetry
.
schedulers
.
TelemetryUploadAllPingsImmediatelyScheduler
;
import
org
.
mozilla
.
gecko
.
telemetry
.
stores
.
TelemetryJSONFilePingStore
;
import
org
.
mozilla
.
gecko
.
telemetry
.
stores
.
TelemetryPingStore
;
import
org
.
mozilla
.
gecko
.
util
.
ThreadUtils
;
import
java
.
io
.
File
;
import
java
.
io
.
IOException
;
import
java
.
lang
.
ref
.
WeakReference
;
public
class
TelemetryDispatcher
{
private
static
final
String
LOGTAG
=
"
Gecko
"
+
TelemetryDispatcher
.
class
.
getSimpleName
(
)
;
private
static
final
String
STORE_CONTAINER_DIR_NAME
=
"
telemetry_java
"
;
private
static
final
String
CORE_STORE_DIR_NAME
=
"
core
"
;
private
final
TelemetryJSONFilePingStore
coreStore
;
private
final
TelemetryUploadAllPingsImmediatelyScheduler
uploadAllPingsImmediatelyScheduler
;
public
TelemetryDispatcher
(
final
String
profilePath
)
{
final
String
storePath
=
profilePath
+
File
.
separator
+
STORE_CONTAINER_DIR_NAME
;
coreStore
=
new
TelemetryJSONFilePingStore
(
new
File
(
storePath
CORE_STORE_DIR_NAME
)
)
;
uploadAllPingsImmediatelyScheduler
=
new
TelemetryUploadAllPingsImmediatelyScheduler
(
)
;
}
private
void
queuePingForUpload
(
final
Context
context
final
int
uniqueID
final
TelemetryPing
ping
final
TelemetryPingStore
store
final
TelemetryUploadScheduler
scheduler
)
{
final
QueuePingRunnable
runnable
=
new
QueuePingRunnable
(
context
uniqueID
ping
store
scheduler
)
;
ThreadUtils
.
postToBackgroundThread
(
runnable
)
;
}
public
void
queuePingForUpload
(
final
Context
context
final
TelemetryCorePingBuilder
pingBuilder
)
{
final
TelemetryPing
ping
=
pingBuilder
.
build
(
)
;
final
int
id
=
ping
.
getPayload
(
)
.
getIntegerSafely
(
TelemetryCorePingBuilder
.
SEQ
)
;
queuePingForUpload
(
context
id
ping
coreStore
uploadAllPingsImmediatelyScheduler
)
;
}
private
static
class
QueuePingRunnable
implements
Runnable
{
private
final
WeakReference
<
Context
>
contextWeakReference
;
private
final
int
uniqueID
;
private
final
TelemetryPing
ping
;
private
final
TelemetryPingStore
store
;
private
final
TelemetryUploadScheduler
scheduler
;
public
QueuePingRunnable
(
final
Context
context
final
int
uniqueID
final
TelemetryPing
ping
final
TelemetryPingStore
store
final
TelemetryUploadScheduler
scheduler
)
{
this
.
contextWeakReference
=
new
WeakReference
<
>
(
context
)
;
this
.
uniqueID
=
uniqueID
;
this
.
ping
=
ping
;
this
.
store
=
store
;
this
.
scheduler
=
scheduler
;
}
Override
public
void
run
(
)
{
final
Context
context
=
contextWeakReference
.
get
(
)
;
if
(
context
=
=
null
)
{
return
;
}
try
{
store
.
storePing
(
uniqueID
ping
)
;
}
catch
(
final
IOException
e
)
{
Log
.
e
(
LOGTAG
"
Unable
to
write
ping
to
disk
.
Continuing
with
upload
attempt
"
)
;
}
if
(
scheduler
.
isReadyToUpload
(
store
)
)
{
scheduler
.
scheduleUpload
(
context
store
)
;
}
}
}
}
