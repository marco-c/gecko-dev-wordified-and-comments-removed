package
org
.
mozilla
.
gecko
.
widget
;
import
org
.
mozilla
.
gecko
.
R
;
import
org
.
mozilla
.
gecko
.
favicons
.
FaviconGenerator
;
import
org
.
mozilla
.
gecko
.
favicons
.
Favicons
;
import
org
.
mozilla
.
gecko
.
util
.
ThreadUtils
;
import
android
.
content
.
Context
;
import
android
.
content
.
res
.
TypedArray
;
import
android
.
graphics
.
Bitmap
;
import
android
.
graphics
.
BitmapFactory
;
import
android
.
graphics
.
Canvas
;
import
android
.
graphics
.
Paint
;
import
android
.
graphics
.
RectF
;
import
android
.
util
.
AttributeSet
;
import
android
.
util
.
DisplayMetrics
;
import
android
.
util
.
Log
;
import
android
.
util
.
TypedValue
;
import
android
.
widget
.
ImageView
;
public
class
FaviconView
extends
ImageView
{
private
static
final
String
LOGTAG
=
"
GeckoFaviconView
"
;
private
static
String
DEFAULT_FAVICON_KEY
=
FaviconView
.
class
.
getSimpleName
(
)
+
"
DefaultFavicon
"
;
private
static
final
int
DEFAULT_CORNER_RADIUS_DP
=
4
;
private
Bitmap
mIconBitmap
;
private
Bitmap
mUnscaledBitmap
;
private
String
mIconKey
;
private
int
mActualWidth
;
private
int
mActualHeight
;
private
boolean
mScalingExpected
;
private
int
mDominantColor
;
private
static
final
Paint
sBackgroundPaint
;
private
final
RectF
mBackgroundRect
;
private
final
float
mBackgroundCornerRadius
;
private
final
boolean
isDominantBorderEnabled
;
private
final
boolean
isOverrideScaleTypeEnabled
;
static
{
sBackgroundPaint
=
new
Paint
(
Paint
.
ANTI_ALIAS_FLAG
)
;
sBackgroundPaint
.
setStyle
(
Paint
.
Style
.
FILL
)
;
}
public
FaviconView
(
Context
context
AttributeSet
attrs
)
{
super
(
context
attrs
)
;
TypedArray
a
=
context
.
getTheme
(
)
.
obtainStyledAttributes
(
attrs
R
.
styleable
.
FaviconView
0
0
)
;
try
{
isDominantBorderEnabled
=
a
.
getBoolean
(
R
.
styleable
.
FaviconView_dominantBorderEnabled
true
)
;
isOverrideScaleTypeEnabled
=
a
.
getBoolean
(
R
.
styleable
.
FaviconView_overrideScaleType
true
)
;
}
finally
{
a
.
recycle
(
)
;
}
if
(
isOverrideScaleTypeEnabled
)
{
setScaleType
(
ImageView
.
ScaleType
.
CENTER
)
;
}
final
DisplayMetrics
metrics
=
getResources
(
)
.
getDisplayMetrics
(
)
;
mBackgroundRect
=
new
RectF
(
0
0
0
0
)
;
mBackgroundCornerRadius
=
TypedValue
.
applyDimension
(
TypedValue
.
COMPLEX_UNIT_DIP
DEFAULT_CORNER_RADIUS_DP
metrics
)
;
}
Override
protected
void
onSizeChanged
(
int
w
int
h
int
oldw
int
oldh
)
{
super
.
onSizeChanged
(
w
h
oldw
oldh
)
;
if
(
w
=
=
mActualWidth
&
&
h
=
=
mActualHeight
)
{
return
;
}
mActualWidth
=
w
;
mActualHeight
=
h
;
mBackgroundRect
.
right
=
w
;
mBackgroundRect
.
bottom
=
h
;
formatImage
(
)
;
}
Override
public
void
onDraw
(
Canvas
canvas
)
{
if
(
isDominantBorderEnabled
)
{
sBackgroundPaint
.
setColor
(
mDominantColor
&
0x7FFFFFFF
)
;
canvas
.
drawRoundRect
(
mBackgroundRect
mBackgroundCornerRadius
mBackgroundCornerRadius
sBackgroundPaint
)
;
}
super
.
onDraw
(
canvas
)
;
}
private
void
formatImage
(
)
{
if
(
mIconBitmap
=
=
null
|
|
mActualWidth
=
=
0
|
|
mActualHeight
=
=
0
)
{
showNoImage
(
)
;
return
;
}
if
(
mScalingExpected
&
&
mActualWidth
!
=
mIconBitmap
.
getWidth
(
)
)
{
scaleBitmap
(
)
;
mScalingExpected
=
false
;
}
setImageBitmap
(
mIconBitmap
)
;
if
(
Math
.
abs
(
mIconBitmap
.
getWidth
(
)
-
mActualWidth
)
>
3
)
{
mDominantColor
=
Favicons
.
getFaviconColor
(
mIconKey
)
;
if
(
mDominantColor
=
=
-
1
)
{
mDominantColor
=
0
;
}
}
else
{
mDominantColor
=
0
;
}
}
private
void
scaleBitmap
(
)
{
int
doubledSize
=
mIconBitmap
.
getWidth
(
)
*
2
;
if
(
mActualWidth
>
doubledSize
)
{
mIconBitmap
=
Bitmap
.
createScaledBitmap
(
mIconBitmap
doubledSize
doubledSize
true
)
;
}
else
{
mIconBitmap
=
Bitmap
.
createScaledBitmap
(
mIconBitmap
mActualWidth
mActualWidth
true
)
;
}
}
private
void
updateImageInternal
(
Bitmap
bitmap
String
key
boolean
allowScaling
)
{
if
(
bitmap
=
=
null
)
{
Log
.
w
(
LOGTAG
"
updateImageInternal
(
)
called
without
bitmap
"
)
;
showDefaultFavicon
(
null
)
;
return
;
}
if
(
mUnscaledBitmap
=
=
bitmap
)
{
return
;
}
mUnscaledBitmap
=
bitmap
;
mIconBitmap
=
bitmap
;
mIconKey
=
key
;
mScalingExpected
=
allowScaling
;
formatImage
(
)
;
}
public
void
showDefaultFavicon
(
final
String
pageURL
)
{
ThreadUtils
.
postToBackgroundThread
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
final
Bitmap
favicon
=
FaviconGenerator
.
generate
(
getContext
(
)
pageURL
)
.
bitmap
;
ThreadUtils
.
postToUiThread
(
new
Runnable
(
)
{
Override
public
void
run
(
)
{
updateAndScaleImage
(
favicon
DEFAULT_FAVICON_KEY
)
;
}
}
)
;
}
}
)
;
}
private
void
showNoImage
(
)
{
setImageDrawable
(
null
)
;
mDominantColor
=
0
;
}
public
void
clearImage
(
)
{
showNoImage
(
)
;
mUnscaledBitmap
=
null
;
mIconBitmap
=
null
;
mIconKey
=
null
;
mScalingExpected
=
false
;
}
public
void
updateAndScaleImage
(
Bitmap
bitmap
String
key
)
{
updateImageInternal
(
bitmap
key
true
)
;
}
public
void
updateImage
(
Bitmap
bitmap
String
key
)
{
updateImageInternal
(
bitmap
key
false
)
;
}
public
Bitmap
getBitmap
(
)
{
return
mIconBitmap
;
}
}
