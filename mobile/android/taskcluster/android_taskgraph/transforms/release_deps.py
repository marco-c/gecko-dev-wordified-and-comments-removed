"
"
"
Add
dependencies
to
release
tasks
.
"
"
"
from
taskgraph
.
transforms
.
base
import
TransformSequence
from
android_taskgraph
.
release_type
import
does_task_match_release_type
PHASES
=
[
"
build
"
"
promote
"
"
push
"
"
ship
"
]
transforms
=
TransformSequence
(
)
transforms
.
add
def
add_dependencies
(
config
tasks
)
:
    
for
task
in
tasks
:
        
dependencies
=
{
}
        
release_type
=
task
[
"
attributes
"
]
.
get
(
"
release
-
type
"
)
        
phase
=
task
.
get
(
"
shipping
-
phase
"
)
        
if
release_type
is
None
:
            
continue
        
for
dep_task
in
config
.
kind_dependencies_tasks
.
values
(
)
:
            
dep_phase
=
dep_task
.
attributes
.
get
(
"
shipping_phase
"
)
            
if
dep_phase
and
PHASES
.
index
(
dep_phase
)
>
PHASES
.
index
(
phase
)
:
                
continue
            
if
does_task_match_release_type
(
dep_task
release_type
)
:
                
dependencies
[
dep_task
.
label
]
=
dep_task
.
label
        
task
.
setdefault
(
"
dependencies
"
{
}
)
.
update
(
dependencies
)
        
yield
task
