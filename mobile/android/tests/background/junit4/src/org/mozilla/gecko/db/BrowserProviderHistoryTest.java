package
org
.
mozilla
.
gecko
.
db
;
import
android
.
content
.
ContentProviderClient
;
import
android
.
content
.
ContentValues
;
import
android
.
database
.
Cursor
;
import
android
.
net
.
Uri
;
import
android
.
os
.
RemoteException
;
import
org
.
junit
.
Before
;
import
org
.
junit
.
Test
;
import
org
.
junit
.
runner
.
RunWith
;
import
org
.
mozilla
.
gecko
.
background
.
testhelpers
.
TestRunner
;
import
org
.
robolectric
.
shadows
.
ShadowContentResolver
;
import
static
org
.
junit
.
Assert
.
*
;
RunWith
(
TestRunner
.
class
)
public
class
BrowserProviderHistoryTest
extends
BrowserProviderHistoryVisitsTestBase
{
private
ContentProviderClient
thumbnailClient
;
private
Uri
thumbnailTestUri
;
private
Uri
expireHistoryNormalUri
;
private
Uri
expireHistoryAggressiveUri
;
private
static
final
long
THREE_MONTHS
=
1000L
*
60L
*
60L
*
24L
*
30L
*
3L
;
Before
Override
public
void
setUp
(
)
throws
Exception
{
super
.
setUp
(
)
;
final
ShadowContentResolver
cr
=
new
ShadowContentResolver
(
)
;
thumbnailClient
=
cr
.
acquireContentProviderClient
(
BrowserContract
.
Thumbnails
.
CONTENT_URI
)
;
thumbnailTestUri
=
testUri
(
BrowserContract
.
Thumbnails
.
CONTENT_URI
)
;
expireHistoryNormalUri
=
testUri
(
BrowserContract
.
History
.
CONTENT_OLD_URI
)
.
buildUpon
(
)
.
appendQueryParameter
(
BrowserContract
.
PARAM_EXPIRE_PRIORITY
BrowserContract
.
ExpirePriority
.
NORMAL
.
toString
(
)
)
.
build
(
)
;
expireHistoryAggressiveUri
=
testUri
(
BrowserContract
.
History
.
CONTENT_OLD_URI
)
.
buildUpon
(
)
.
appendQueryParameter
(
BrowserContract
.
PARAM_EXPIRE_PRIORITY
BrowserContract
.
ExpirePriority
.
AGGRESSIVE
.
toString
(
)
)
.
build
(
)
;
}
Test
public
void
testHistoryExpirationAggressiveNew
(
)
throws
Exception
{
final
int
historyItemsCount
=
3000
;
insertHistory
(
historyItemsCount
System
.
currentTimeMillis
(
)
)
;
historyClient
.
delete
(
expireHistoryAggressiveUri
null
null
)
;
assertRowCount
(
historyClient
historyTestUri
500
)
;
assertRowCount
(
thumbnailClient
thumbnailTestUri
15
)
;
}
Test
public
void
testHistoryExpirationNormalNew
(
)
throws
Exception
{
final
int
historyItemsCount
=
3000
;
insertHistory
(
historyItemsCount
System
.
currentTimeMillis
(
)
)
;
historyClient
.
delete
(
expireHistoryNormalUri
null
null
)
;
assertRowCount
(
historyClient
historyTestUri
3000
)
;
assertRowCount
(
thumbnailClient
thumbnailTestUri
15
)
;
}
Test
public
void
testHistoryExpirationAggressiveOld
(
)
throws
Exception
{
final
int
historyItemsCount
=
3000
;
insertHistory
(
historyItemsCount
System
.
currentTimeMillis
(
)
-
THREE_MONTHS
)
;
historyClient
.
delete
(
expireHistoryAggressiveUri
null
null
)
;
assertRowCount
(
historyClient
historyTestUri
500
)
;
assertRowCount
(
thumbnailClient
thumbnailTestUri
15
)
;
}
Test
public
void
testHistoryExpirationNormalOld
(
)
throws
Exception
{
final
int
historyItemsCount
=
3000
;
insertHistory
(
historyItemsCount
System
.
currentTimeMillis
(
)
-
THREE_MONTHS
)
;
historyClient
.
delete
(
expireHistoryNormalUri
null
null
)
;
assertRowCount
(
historyClient
historyTestUri
2000
)
;
assertRowCount
(
thumbnailClient
thumbnailTestUri
15
)
;
}
Test
public
void
testHistoryVisitAggregates
(
)
throws
Exception
{
final
long
baseDate
=
System
.
currentTimeMillis
(
)
;
final
String
url
=
"
https
:
/
/
www
.
mozilla
.
org
"
;
final
Uri
historyIncrementVisitsUri
=
historyTestUri
.
buildUpon
(
)
.
appendQueryParameter
(
BrowserContract
.
PARAM_INCREMENT_VISITS
"
true
"
)
.
appendQueryParameter
(
BrowserContract
.
PARAM_INSERT_IF_NEEDED
"
true
"
)
.
build
(
)
;
insertHistoryItem
(
url
null
baseDate
null
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
0
0
0
0
0
)
;
final
String
url2
=
"
https
:
/
/
www
.
eff
.
org
"
;
insertHistoryItem
(
url2
null
baseDate
17
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url2
}
17
0
0
0
0
)
;
final
String
url3
=
"
https
:
/
/
www
.
torproject
.
org
"
;
final
ContentValues
cv
=
new
ContentValues
(
)
;
cv
.
put
(
BrowserContract
.
History
.
URL
url3
)
;
cv
.
put
(
BrowserContract
.
History
.
VISITS
13
)
;
cv
.
put
(
BrowserContract
.
History
.
DATE_LAST_VISITED
baseDate
)
;
historyClient
.
update
(
historyIncrementVisitsUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url3
}
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url3
}
13
13
baseDate
0
0
)
;
cv
.
clear
(
)
;
cv
.
put
(
BrowserContract
.
History
.
TITLE
"
New
title
"
)
;
historyClient
.
update
(
historyTestUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
0
0
0
0
0
)
;
final
long
lastVisited
=
System
.
currentTimeMillis
(
)
;
cv
.
clear
(
)
;
cv
.
put
(
BrowserContract
.
History
.
DATE_LAST_VISITED
lastVisited
)
;
historyClient
.
update
(
historyIncrementVisitsUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
1
1
lastVisited
0
0
)
;
final
long
lastVisited2
=
System
.
currentTimeMillis
(
)
;
cv
.
clear
(
)
;
cv
.
put
(
BrowserContract
.
History
.
DATE_LAST_VISITED
lastVisited2
)
;
cv
.
put
(
BrowserContract
.
History
.
VISITS
10
)
;
historyClient
.
update
(
historyTestUri
.
buildUpon
(
)
.
appendQueryParameter
(
BrowserContract
.
PARAM_INCREMENT_VISITS
"
true
"
)
.
build
(
)
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
2
2
lastVisited2
0
0
)
;
final
long
lastVisited3
=
System
.
currentTimeMillis
(
)
;
cv
.
clear
(
)
;
cv
.
put
(
BrowserContract
.
History
.
LOCAL_DATE_LAST_VISITED
lastVisited3
)
;
cv
.
put
(
BrowserContract
.
History
.
LOCAL_VISITS
19
)
;
cv
.
put
(
BrowserContract
.
History
.
REMOTE_DATE_LAST_VISITED
lastVisited3
-
100
)
;
cv
.
put
(
BrowserContract
.
History
.
REMOTE_VISITS
3
)
;
historyClient
.
update
(
historyTestUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
2
19
lastVisited3
3
lastVisited3
-
100
)
;
cv
.
clear
(
)
;
cv
.
put
(
BrowserContract
.
History
.
REMOTE_VISITS
5
)
;
historyClient
.
update
(
historyTestUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
2
19
lastVisited3
5
lastVisited3
-
100
)
;
final
Uri
historyIncrementRemoteAggregateUri
=
historyTestUri
.
buildUpon
(
)
.
appendQueryParameter
(
BrowserContract
.
PARAM_INCREMENT_REMOTE_AGGREGATES
"
true
"
)
.
build
(
)
;
cv
.
clear
(
)
;
cv
.
put
(
BrowserContract
.
History
.
REMOTE_DATE_LAST_VISITED
lastVisited3
)
;
cv
.
put
(
BrowserContract
.
History
.
REMOTE_VISITS
3
)
;
historyClient
.
update
(
historyIncrementRemoteAggregateUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
2
19
lastVisited3
8
lastVisited3
)
;
cv
.
clear
(
)
;
try
{
historyClient
.
update
(
historyIncrementRemoteAggregateUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
;
assertTrue
(
"
Expected
to
throw
IllegalArgumentException
"
false
)
;
}
catch
(
IllegalArgumentException
e
)
{
assertTrue
(
true
)
;
assertHistoryAggregates
(
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
2
19
lastVisited3
8
lastVisited3
)
;
}
}
private
void
assertHistoryAggregates
(
String
selection
String
[
]
selectionArg
int
visits
int
localVisits
long
localLastVisited
int
remoteVisits
long
remoteLastVisited
)
throws
Exception
{
final
Cursor
c
=
historyClient
.
query
(
historyTestUri
new
String
[
]
{
BrowserContract
.
History
.
VISITS
BrowserContract
.
History
.
LOCAL_VISITS
BrowserContract
.
History
.
REMOTE_VISITS
BrowserContract
.
History
.
LOCAL_DATE_LAST_VISITED
BrowserContract
.
History
.
REMOTE_DATE_LAST_VISITED
}
selection
selectionArg
null
)
;
assertNotNull
(
c
)
;
try
{
assertTrue
(
c
.
moveToFirst
(
)
)
;
final
int
visitsCol
=
c
.
getColumnIndexOrThrow
(
BrowserContract
.
History
.
VISITS
)
;
final
int
localVisitsCol
=
c
.
getColumnIndexOrThrow
(
BrowserContract
.
History
.
LOCAL_VISITS
)
;
final
int
remoteVisitsCol
=
c
.
getColumnIndexOrThrow
(
BrowserContract
.
History
.
REMOTE_VISITS
)
;
final
int
localDateLastVisitedCol
=
c
.
getColumnIndexOrThrow
(
BrowserContract
.
History
.
LOCAL_DATE_LAST_VISITED
)
;
final
int
remoteDateLastVisitedCol
=
c
.
getColumnIndexOrThrow
(
BrowserContract
.
History
.
REMOTE_DATE_LAST_VISITED
)
;
assertEquals
(
visits
c
.
getInt
(
visitsCol
)
)
;
assertEquals
(
localVisits
c
.
getInt
(
localVisitsCol
)
)
;
assertEquals
(
localLastVisited
c
.
getLong
(
localDateLastVisitedCol
)
)
;
assertEquals
(
remoteVisits
c
.
getInt
(
remoteVisitsCol
)
)
;
assertEquals
(
remoteLastVisited
c
.
getLong
(
remoteDateLastVisitedCol
)
)
;
}
finally
{
c
.
close
(
)
;
}
}
private
void
insertHistory
(
int
count
long
baseTime
)
throws
RemoteException
{
Uri
incrementUri
=
historyTestUri
.
buildUpon
(
)
.
appendQueryParameter
(
BrowserContract
.
PARAM_INCREMENT_VISITS
"
true
"
)
.
build
(
)
;
for
(
int
i
=
0
;
i
<
count
;
i
+
+
)
{
final
String
url
=
"
https
:
/
/
www
.
mozilla
"
+
i
+
"
.
org
"
;
insertHistoryItem
(
url
"
testGUID
"
+
i
baseTime
-
i
null
)
;
if
(
i
%
3
=
=
0
)
{
assertEquals
(
1
historyClient
.
update
(
incrementUri
new
ContentValues
(
)
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
url
}
)
)
;
}
ContentValues
cv
=
new
ContentValues
(
)
;
cv
.
put
(
BrowserContract
.
History
.
DATE_CREATED
baseTime
-
i
)
;
cv
.
put
(
BrowserContract
.
History
.
DATE_MODIFIED
baseTime
-
i
)
;
assertEquals
(
1
historyClient
.
update
(
historyTestUri
cv
BrowserContract
.
History
.
URL
+
"
=
?
"
new
String
[
]
{
"
https
:
/
/
www
.
mozilla
"
+
i
+
"
.
org
"
}
)
)
;
}
ContentValues
[
]
thumbs
=
new
ContentValues
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
+
+
)
{
thumbs
[
i
]
=
new
ContentValues
(
)
;
thumbs
[
i
]
.
put
(
BrowserContract
.
Thumbnails
.
DATA
i
)
;
thumbs
[
i
]
.
put
(
BrowserContract
.
Thumbnails
.
URL
"
https
:
/
/
www
.
mozilla
"
+
i
+
"
.
org
"
)
;
}
assertEquals
(
count
thumbnailClient
.
bulkInsert
(
thumbnailTestUri
thumbs
)
)
;
}
private
void
assertRowCount
(
final
ContentProviderClient
client
final
Uri
uri
final
int
count
)
throws
RemoteException
{
final
Cursor
c
=
client
.
query
(
uri
null
null
null
null
)
;
assertNotNull
(
c
)
;
try
{
assertEquals
(
count
c
.
getCount
(
)
)
;
}
finally
{
c
.
close
(
)
;
}
}
}
