package
org
.
mozilla
.
gecko
.
cleanup
;
import
android
.
content
.
Context
;
import
android
.
content
.
Intent
;
import
android
.
content
.
SharedPreferences
;
import
org
.
junit
.
Test
;
import
org
.
junit
.
runner
.
RunWith
;
import
org
.
mozilla
.
gecko
.
background
.
testhelpers
.
TestRunner
;
import
org
.
robolectric
.
RuntimeEnvironment
;
import
java
.
util
.
ArrayList
;
import
static
org
.
junit
.
Assert
.
assertNotNull
;
import
static
org
.
junit
.
Assert
.
assertTrue
;
import
static
org
.
mockito
.
Mockito
.
any
;
import
static
org
.
mockito
.
Mockito
.
atMost
;
import
static
org
.
mockito
.
Mockito
.
mock
;
import
static
org
.
mockito
.
Mockito
.
never
;
import
static
org
.
mockito
.
Mockito
.
verify
;
RunWith
(
TestRunner
.
class
)
public
class
TestFileCleanupController
{
Test
public
void
testStartIfReadyEmptySharedPrefsRunsCleanup
(
)
{
final
Context
context
=
mock
(
Context
.
class
)
;
FileCleanupController
.
startIfReady
(
context
getSharedPreferences
(
)
"
"
)
;
verify
(
context
)
.
startService
(
any
(
Intent
.
class
)
)
;
}
Test
public
void
testStartIfReadyLastRunNowDoesNotRun
(
)
{
final
SharedPreferences
sharedPrefs
=
getSharedPreferences
(
)
;
sharedPrefs
.
edit
(
)
.
putLong
(
FileCleanupController
.
PREF_LAST_CLEANUP_MILLIS
System
.
currentTimeMillis
(
)
)
.
commit
(
)
;
final
Context
context
=
mock
(
Context
.
class
)
;
FileCleanupController
.
startIfReady
(
context
sharedPrefs
"
"
)
;
verify
(
context
never
(
)
)
.
startService
(
(
any
(
Intent
.
class
)
)
)
;
}
Test
public
void
testStartIfReadyDoesNotRunTwiceInSuccession
(
)
{
final
Context
context
=
mock
(
Context
.
class
)
;
final
SharedPreferences
sharedPrefs
=
getSharedPreferences
(
)
;
FileCleanupController
.
startIfReady
(
context
sharedPrefs
"
"
)
;
verify
(
context
)
.
startService
(
any
(
Intent
.
class
)
)
;
FileCleanupController
.
startIfReady
(
context
sharedPrefs
"
"
)
;
verify
(
context
atMost
(
1
)
)
.
startService
(
any
(
Intent
.
class
)
)
;
}
Test
public
void
testGetFilesToCleanupContainsProfilePath
(
)
{
final
String
profilePath
=
"
/
a
/
profile
/
path
"
;
final
ArrayList
<
String
>
fileList
=
FileCleanupController
.
getFilesToCleanup
(
profilePath
)
;
assertNotNull
(
"
Returned
file
list
is
non
-
null
"
fileList
)
;
boolean
atLeastOneStartsWithProfilePath
=
false
;
final
String
pathToCheck
=
profilePath
+
"
/
"
;
for
(
final
String
path
:
fileList
)
{
if
(
path
.
startsWith
(
pathToCheck
)
)
{
atLeastOneStartsWithProfilePath
=
true
;
}
}
assertTrue
(
"
At
least
one
returned
String
starts
with
a
profile
path
"
atLeastOneStartsWithProfilePath
)
;
}
private
SharedPreferences
getSharedPreferences
(
)
{
return
RuntimeEnvironment
.
application
.
getSharedPreferences
(
"
TestFileCleanupController
"
0
)
;
}
}
