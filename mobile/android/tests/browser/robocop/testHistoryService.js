"
use
strict
"
;
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
var
gTimer
=
Cc
[
"
mozilla
.
org
/
timer
;
1
"
]
.
createInstance
(
Ci
.
nsITimer
)
;
function
sleep
(
wait
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
do_print
(
"
sleep
start
"
)
;
gTimer
.
initWithCallback
(
{
notify
:
function
(
)
{
do_print
(
"
sleep
end
"
)
;
resolve
(
)
;
}
}
wait
gTimer
.
TYPE_ONE_SHOT
)
;
}
)
;
}
function
promiseLoadEvent
(
browser
url
eventType
=
"
load
"
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
do_print
(
"
Wait
browser
event
:
"
+
eventType
)
;
function
handle
(
event
)
{
if
(
event
.
target
!
=
browser
.
contentDocument
|
|
event
.
target
.
location
.
href
=
=
"
about
:
blank
"
)
{
do_print
(
"
Skipping
spurious
'
"
+
eventType
+
"
'
event
"
+
"
for
"
+
event
.
target
.
location
.
href
)
;
return
;
}
browser
.
removeEventListener
(
eventType
handle
true
)
;
do_print
(
"
Browser
event
received
:
"
+
eventType
)
;
resolve
(
event
)
;
}
browser
.
addEventListener
(
eventType
handle
true
)
;
if
(
url
)
{
browser
.
loadURI
(
url
)
;
}
}
)
;
}
const
PENDING_VISIT_WAIT
=
6000
;
const
PENDING_VISIT_WAIT_LONG
=
20000
;
var
gVisitURLs
=
[
]
;
function
visitObserver
(
subject
topic
data
)
{
let
uri
=
subject
.
QueryInterface
(
Ci
.
nsIURI
)
;
do_print
(
"
Observer
:
"
+
uri
.
spec
)
;
gVisitURLs
.
push
(
uri
.
spec
)
;
}
var
gBrowser
;
add_test
(
function
setup_browser
(
)
{
let
chromeWin
=
Services
.
wm
.
getMostRecentWindow
(
"
navigator
:
browser
"
)
;
let
BrowserApp
=
chromeWin
.
BrowserApp
;
do_register_cleanup
(
function
cleanup
(
)
{
Services
.
obs
.
removeObserver
(
visitObserver
"
link
-
visited
"
)
;
BrowserApp
.
closeTab
(
BrowserApp
.
getTabForBrowser
(
gBrowser
)
)
;
}
)
;
Services
.
obs
.
addObserver
(
visitObserver
"
link
-
visited
"
)
;
let
url
=
"
about
:
blank
"
;
gBrowser
=
BrowserApp
.
addTab
(
url
{
selected
:
true
parentId
:
BrowserApp
.
selectedTab
.
id
}
)
.
browser
;
gBrowser
.
addEventListener
(
"
load
"
function
(
event
)
{
Services
.
tm
.
dispatchToMainThread
(
run_next_test
)
;
}
{
capture
:
true
once
:
true
}
)
;
}
)
;
add_task
(
async
function
(
)
{
await
sleep
(
PENDING_VISIT_WAIT
)
;
gVisitURLs
=
[
]
;
await
promiseLoadEvent
(
gBrowser
"
http
:
/
/
example
.
org
/
tests
/
robocop
/
robocop_blank_01
.
html
"
)
;
await
sleep
(
PENDING_VISIT_WAIT_LONG
)
;
do_print
(
"
visit
counts
:
"
+
gVisitURLs
.
length
)
;
ok
(
gVisitURLs
.
length
=
=
1
"
Simple
visit
makes
1
history
item
"
)
;
do_print
(
"
visit
URL
:
"
+
gVisitURLs
[
0
]
)
;
ok
(
gVisitURLs
[
0
]
=
=
"
http
:
/
/
example
.
org
/
tests
/
robocop
/
robocop_blank_01
.
html
"
"
Simple
visit
makes
final
history
item
"
)
;
gVisitURLs
=
[
]
;
await
promiseLoadEvent
(
gBrowser
"
http
:
/
/
example
.
org
/
tests
/
robocop
/
simple_redirect
.
sjs
?
http
:
/
/
example
.
org
/
tests
/
robocop
/
robocop_blank_02
.
html
"
)
;
await
sleep
(
PENDING_VISIT_WAIT
)
;
do_print
(
"
visit
counts
:
"
+
gVisitURLs
.
length
)
;
ok
(
gVisitURLs
.
length
=
=
1
"
Simple
301
redirect
makes
1
history
item
"
)
;
do_print
(
"
visit
URL
:
"
+
gVisitURLs
[
0
]
)
;
ok
(
gVisitURLs
[
0
]
=
=
"
http
:
/
/
example
.
org
/
tests
/
robocop
/
robocop_blank_02
.
html
"
"
Simple
301
redirect
makes
final
history
item
"
)
;
gVisitURLs
=
[
]
;
await
promiseLoadEvent
(
gBrowser
"
http
:
/
/
example
.
org
/
tests
/
robocop
/
javascript_redirect
.
sjs
?
http
:
/
/
example
.
org
/
tests
/
robocop
/
robocop_blank_03
.
html
"
)
;
await
sleep
(
PENDING_VISIT_WAIT
)
;
do_print
(
"
visit
counts
:
"
+
gVisitURLs
.
length
)
;
ok
(
gVisitURLs
.
length
=
=
2
"
JavaScript
redirect
makes
2
history
items
"
)
;
do_print
(
"
visit
URL
1
:
"
+
gVisitURLs
[
0
]
)
;
ok
(
gVisitURLs
[
0
]
=
=
"
http
:
/
/
example
.
org
/
tests
/
robocop
/
javascript_redirect
.
sjs
?
http
:
/
/
example
.
org
/
tests
/
robocop
/
robocop_blank_03
.
html
"
"
JavaScript
redirect
makes
intermediate
history
item
"
)
;
do_print
(
"
visit
URL
2
:
"
+
gVisitURLs
[
1
]
)
;
ok
(
gVisitURLs
[
1
]
=
=
"
http
:
/
/
example
.
org
/
tests
/
robocop
/
robocop_blank_03
.
html
"
"
JavaScript
redirect
makes
final
history
item
"
)
;
}
)
;
run_next_test
(
)
;
