#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
gfx
/
2D
.
h
"
#
include
"
Common
.
h
"
#
include
"
Decoder
.
h
"
#
include
"
DecoderFactory
.
h
"
#
include
"
SourceBuffer
.
h
"
#
include
"
SurfacePipe
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
gfx
;
using
namespace
mozilla
:
:
image
;
namespace
mozilla
{
namespace
image
{
class
TestSurfacePipeFactory
{
public
:
static
SurfacePipe
SimpleSurfacePipe
(
)
{
SurfacePipe
pipe
;
return
Move
(
pipe
)
;
}
template
<
typename
T
>
static
SurfacePipe
SurfacePipeFromPipeline
(
T
&
&
aPipeline
)
{
return
SurfacePipe
{
Move
(
aPipeline
)
}
;
}
private
:
TestSurfacePipeFactory
(
)
{
}
}
;
}
}
TEST
(
ImageSurfacePipeIntegration
SurfacePipe
)
{
SurfacePipe
pipe
=
TestSurfacePipeFactory
:
:
SimpleSurfacePipe
(
)
;
pipe
=
TestSurfacePipeFactory
:
:
SimpleSurfacePipe
(
)
;
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
auto
sink
=
MakeUnique
<
SurfaceSink
>
(
)
;
nsresult
rv
=
sink
-
>
Configure
(
SurfaceConfig
{
decoder
.
get
(
)
0
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
false
}
)
;
ASSERT_TRUE
(
NS_SUCCEEDED
(
rv
)
)
;
pipe
=
TestSurfacePipeFactory
:
:
SurfacePipeFromPipeline
(
sink
)
;
int32_t
count
=
0
;
auto
result
=
pipe
.
WritePixels
<
uint32_t
>
(
[
&
]
(
)
{
+
+
count
;
return
AsVariant
(
BGRAColor
:
:
Green
(
)
.
AsPixel
(
)
)
;
}
)
;
EXPECT_EQ
(
WriteState
:
:
FINISHED
result
)
;
EXPECT_EQ
(
100
*
100
count
)
;
EXPECT_TRUE
(
pipe
.
IsSurfaceFinished
(
)
)
;
Maybe
<
SurfaceInvalidRect
>
invalidRect
=
pipe
.
TakeInvalidRect
(
)
;
EXPECT_TRUE
(
invalidRect
.
isSome
(
)
)
;
EXPECT_EQ
(
IntRect
(
0
0
100
100
)
invalidRect
-
>
mInputSpaceRect
)
;
EXPECT_EQ
(
IntRect
(
0
0
100
100
)
invalidRect
-
>
mOutputSpaceRect
)
;
CheckGeneratedImage
(
decoder
IntRect
(
0
0
100
100
)
)
;
pipe
.
ResetToFirstRow
(
)
;
EXPECT_FALSE
(
pipe
.
IsSurfaceFinished
(
)
)
;
RawAccessFrameRef
currentFrame
=
decoder
-
>
GetCurrentFrameRef
(
)
;
currentFrame
-
>
Finish
(
)
;
}
TEST
(
ImageSurfacePipeIntegration
DeinterlaceDownscaleWritePixels
)
{
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
auto
test
=
[
]
(
Decoder
*
aDecoder
SurfaceFilter
*
aFilter
)
{
CheckWritePixels
(
aDecoder
aFilter
Some
(
IntRect
(
0
0
25
25
)
)
)
;
}
;
WithFilterPipeline
(
decoder
test
DeinterlacingConfig
<
uint32_t
>
{
true
}
DownscalingConfig
{
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
}
SurfaceConfig
{
decoder
0
IntSize
(
25
25
)
SurfaceFormat
:
:
B8G8R8A8
false
}
)
;
}
TEST
(
ImageSurfacePipeIntegration
RemoveFrameRectBottomRightDownscaleWritePixels
)
{
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
auto
test
=
[
]
(
Decoder
*
aDecoder
SurfaceFilter
*
aFilter
)
{
CheckWritePixels
(
aDecoder
aFilter
Some
(
IntRect
(
0
0
20
20
)
)
Some
(
IntRect
(
0
0
100
100
)
)
Some
(
IntRect
(
50
50
100
50
)
)
Some
(
IntRect
(
10
10
10
10
)
)
0x33
)
;
}
;
WithFilterPipeline
(
decoder
test
RemoveFrameRectConfig
{
IntRect
(
50
50
100
100
)
}
DownscalingConfig
{
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
}
SurfaceConfig
{
decoder
0
IntSize
(
20
20
)
SurfaceFormat
:
:
B8G8R8A8
false
}
)
;
}
TEST
(
ImageSurfacePipeIntegration
RemoveFrameRectTopLeftDownscaleWritePixels
)
{
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
auto
test
=
[
]
(
Decoder
*
aDecoder
SurfaceFilter
*
aFilter
)
{
CheckWritePixels
(
aDecoder
aFilter
Some
(
IntRect
(
0
0
20
20
)
)
Some
(
IntRect
(
0
0
100
100
)
)
Some
(
IntRect
(
0
0
100
100
)
)
Some
(
IntRect
(
0
0
10
10
)
)
0x21
)
;
}
;
WithFilterPipeline
(
decoder
test
RemoveFrameRectConfig
{
IntRect
(
-
50
-
50
100
100
)
}
DownscalingConfig
{
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
}
SurfaceConfig
{
decoder
0
IntSize
(
20
20
)
SurfaceFormat
:
:
B8G8R8A8
false
}
)
;
}
TEST
(
ImageSurfacePipeIntegration
DeinterlaceRemoveFrameRectWritePixels
)
{
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
auto
test
=
[
]
(
Decoder
*
aDecoder
SurfaceFilter
*
aFilter
)
{
CheckWritePixels
(
aDecoder
aFilter
Some
(
IntRect
(
0
0
100
100
)
)
Some
(
IntRect
(
0
0
100
100
)
)
Some
(
IntRect
(
50
50
100
100
)
)
Some
(
IntRect
(
50
50
50
50
)
)
)
;
}
;
WithFilterPipeline
(
decoder
test
DeinterlacingConfig
<
uint32_t
>
{
true
}
RemoveFrameRectConfig
{
IntRect
(
50
50
100
100
)
}
SurfaceConfig
{
decoder
0
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
false
}
)
;
}
TEST
(
ImageSurfacePipeIntegration
DeinterlaceRemoveFrameRectDownscaleWritePixels
)
{
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
auto
test
=
[
]
(
Decoder
*
aDecoder
SurfaceFilter
*
aFilter
)
{
CheckWritePixels
(
aDecoder
aFilter
Some
(
IntRect
(
0
0
20
20
)
)
Some
(
IntRect
(
0
0
100
100
)
)
Some
(
IntRect
(
50
50
100
100
)
)
Some
(
IntRect
(
10
10
10
10
)
)
33
)
;
}
;
WithFilterPipeline
(
decoder
test
DeinterlacingConfig
<
uint32_t
>
{
true
}
RemoveFrameRectConfig
{
IntRect
(
50
50
100
100
)
}
DownscalingConfig
{
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
}
SurfaceConfig
{
decoder
0
IntSize
(
20
20
)
SurfaceFormat
:
:
B8G8R8A8
false
}
)
;
}
TEST
(
ImageSurfacePipeIntegration
ConfiguringPalettedRemoveFrameRectDownscaleFails
)
{
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
AssertConfiguringPipelineFails
(
decoder
RemoveFrameRectConfig
{
IntRect
(
0
0
50
50
)
}
DownscalingConfig
{
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
}
PalettedSurfaceConfig
{
decoder
0
IntSize
(
100
100
)
IntRect
(
0
0
50
50
)
SurfaceFormat
:
:
B8G8R8A8
8
false
}
)
;
}
TEST
(
ImageSurfacePipeIntegration
ConfiguringPalettedDeinterlaceDownscaleFails
)
{
RefPtr
<
Decoder
>
decoder
=
CreateTrivialDecoder
(
)
;
ASSERT_TRUE
(
decoder
!
=
nullptr
)
;
AssertConfiguringPipelineFails
(
decoder
DeinterlacingConfig
<
uint8_t
>
{
true
}
DownscalingConfig
{
IntSize
(
100
100
)
SurfaceFormat
:
:
B8G8R8A8
}
PalettedSurfaceConfig
{
decoder
0
IntSize
(
100
100
)
IntRect
(
0
0
20
20
)
SurfaceFormat
:
:
B8G8R8A8
8
false
}
)
;
}
