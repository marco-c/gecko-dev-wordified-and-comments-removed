#
include
"
ImageCacheKey
.
h
"
#
include
"
mozilla
/
HashFunctions
.
h
"
#
include
"
mozilla
/
Move
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsICookieService
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
nsString
.
h
"
#
include
"
mozilla
/
AntiTrackingCommon
.
h
"
#
include
"
mozilla
/
HashFunctions
.
h
"
#
include
"
mozilla
/
StorageAccess
.
h
"
#
include
"
mozilla
/
dom
/
BlobURLProtocolHandler
.
h
"
#
include
"
mozilla
/
dom
/
File
.
h
"
#
include
"
mozilla
/
dom
/
ServiceWorkerManager
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsPrintfCString
.
h
"
namespace
mozilla
{
using
namespace
dom
;
namespace
image
{
static
Maybe
<
uint64_t
>
BlobSerial
(
nsIURI
*
aURI
)
{
nsAutoCString
spec
;
aURI
-
>
GetSpec
(
spec
)
;
RefPtr
<
BlobImpl
>
blob
;
if
(
NS_SUCCEEDED
(
NS_GetBlobForBlobURISpec
(
spec
getter_AddRefs
(
blob
)
)
)
&
&
blob
)
{
return
Some
(
blob
-
>
GetSerialNumber
(
)
)
;
}
return
Nothing
(
)
;
}
ImageCacheKey
:
:
ImageCacheKey
(
nsIURI
*
aURI
const
OriginAttributes
&
aAttrs
Document
*
aDocument
)
:
mURI
(
aURI
)
mOriginAttributes
(
aAttrs
)
mControlledDocument
(
GetSpecialCaseDocumentToken
(
aDocument
aURI
)
)
mTopLevelBaseDomain
(
GetTopLevelBaseDomain
(
aDocument
aURI
)
)
mIsChrome
(
false
)
{
if
(
SchemeIs
(
"
blob
"
)
)
{
mBlobSerial
=
BlobSerial
(
mURI
)
;
}
else
if
(
SchemeIs
(
"
chrome
"
)
)
{
mIsChrome
=
true
;
}
}
ImageCacheKey
:
:
ImageCacheKey
(
const
ImageCacheKey
&
aOther
)
:
mURI
(
aOther
.
mURI
)
mBlobSerial
(
aOther
.
mBlobSerial
)
mBlobRef
(
aOther
.
mBlobRef
)
mOriginAttributes
(
aOther
.
mOriginAttributes
)
mControlledDocument
(
aOther
.
mControlledDocument
)
mTopLevelBaseDomain
(
aOther
.
mTopLevelBaseDomain
)
mHash
(
aOther
.
mHash
)
mIsChrome
(
aOther
.
mIsChrome
)
{
}
ImageCacheKey
:
:
ImageCacheKey
(
ImageCacheKey
&
&
aOther
)
:
mURI
(
std
:
:
move
(
aOther
.
mURI
)
)
mBlobSerial
(
std
:
:
move
(
aOther
.
mBlobSerial
)
)
mBlobRef
(
std
:
:
move
(
aOther
.
mBlobRef
)
)
mOriginAttributes
(
aOther
.
mOriginAttributes
)
mControlledDocument
(
aOther
.
mControlledDocument
)
mTopLevelBaseDomain
(
aOther
.
mTopLevelBaseDomain
)
mHash
(
aOther
.
mHash
)
mIsChrome
(
aOther
.
mIsChrome
)
{
}
bool
ImageCacheKey
:
:
operator
=
=
(
const
ImageCacheKey
&
aOther
)
const
{
if
(
mControlledDocument
!
=
aOther
.
mControlledDocument
)
{
return
false
;
}
if
(
!
mTopLevelBaseDomain
.
Equals
(
aOther
.
mTopLevelBaseDomain
nsCaseInsensitiveCStringComparator
(
)
)
)
{
return
false
;
}
if
(
mOriginAttributes
!
=
aOther
.
mOriginAttributes
)
{
return
false
;
}
if
(
mBlobSerial
|
|
aOther
.
mBlobSerial
)
{
if
(
mBlobSerial
&
&
mBlobRef
.
IsEmpty
(
)
)
{
EnsureBlobRef
(
)
;
}
if
(
aOther
.
mBlobSerial
&
&
aOther
.
mBlobRef
.
IsEmpty
(
)
)
{
aOther
.
EnsureBlobRef
(
)
;
}
return
mBlobSerial
=
=
aOther
.
mBlobSerial
&
&
mBlobRef
=
=
aOther
.
mBlobRef
;
}
bool
equals
=
false
;
nsresult
rv
=
mURI
-
>
Equals
(
aOther
.
mURI
&
equals
)
;
return
NS_SUCCEEDED
(
rv
)
&
&
equals
;
}
void
ImageCacheKey
:
:
EnsureBlobRef
(
)
const
{
MOZ_ASSERT
(
mBlobSerial
)
;
MOZ_ASSERT
(
mBlobRef
.
IsEmpty
(
)
)
;
nsresult
rv
=
mURI
-
>
GetRef
(
mBlobRef
)
;
NS_ENSURE_SUCCESS_VOID
(
rv
)
;
}
void
ImageCacheKey
:
:
EnsureHash
(
)
const
{
MOZ_ASSERT
(
mHash
.
isNothing
(
)
)
;
PLDHashNumber
hash
=
0
;
nsPrintfCString
ptr
(
"
%
p
"
mControlledDocument
)
;
nsAutoCString
suffix
;
mOriginAttributes
.
CreateSuffix
(
suffix
)
;
if
(
mBlobSerial
)
{
if
(
mBlobRef
.
IsEmpty
(
)
)
{
EnsureBlobRef
(
)
;
}
hash
=
HashGeneric
(
*
mBlobSerial
HashString
(
mBlobRef
)
)
;
}
else
{
nsAutoCString
spec
;
Unused
<
<
mURI
-
>
GetSpec
(
spec
)
;
hash
=
HashString
(
spec
)
;
}
hash
=
AddToHash
(
hash
HashString
(
suffix
)
HashString
(
mTopLevelBaseDomain
)
HashString
(
ptr
)
)
;
mHash
.
emplace
(
hash
)
;
}
bool
ImageCacheKey
:
:
SchemeIs
(
const
char
*
aScheme
)
{
bool
matches
=
false
;
return
NS_SUCCEEDED
(
mURI
-
>
SchemeIs
(
aScheme
&
matches
)
)
&
&
matches
;
}
void
*
ImageCacheKey
:
:
GetSpecialCaseDocumentToken
(
Document
*
aDocument
nsIURI
*
aURI
)
{
if
(
!
aDocument
|
|
aDocument
-
>
IsCookieAverse
(
)
)
{
return
nullptr
;
}
RefPtr
<
ServiceWorkerManager
>
swm
=
ServiceWorkerManager
:
:
GetInstance
(
)
;
if
(
swm
&
&
aDocument
-
>
GetController
(
)
.
isSome
(
)
)
{
return
aDocument
;
}
return
nullptr
;
}
nsCString
ImageCacheKey
:
:
GetTopLevelBaseDomain
(
Document
*
aDocument
nsIURI
*
aURI
)
{
if
(
!
aDocument
|
|
!
aDocument
-
>
GetInnerWindow
(
)
)
{
return
EmptyCString
(
)
;
}
if
(
nsContentUtils
:
:
IsThirdPartyTrackingResourceWindow
(
aDocument
-
>
GetInnerWindow
(
)
)
)
{
return
StorageDisabledByAntiTracking
(
aDocument
aURI
)
?
aDocument
-
>
GetBaseDomain
(
)
:
EmptyCString
(
)
;
}
if
(
!
AntiTrackingCommon
:
:
MaybeIsFirstPartyStorageAccessGrantedFor
(
aDocument
-
>
GetInnerWindow
(
)
aURI
)
)
{
nsPIDOMWindowOuter
*
top
=
aDocument
-
>
GetInnerWindow
(
)
-
>
GetInProcessScriptableTop
(
)
;
nsPIDOMWindowInner
*
topInner
=
top
?
top
-
>
GetCurrentInnerWindow
(
)
:
nullptr
;
if
(
!
topInner
)
{
return
aDocument
-
>
GetBaseDomain
(
)
;
}
return
topInner
-
>
GetExtantDoc
(
)
?
topInner
-
>
GetExtantDoc
(
)
-
>
GetBaseDomain
(
)
:
EmptyCString
(
)
;
}
return
EmptyCString
(
)
;
}
}
}
