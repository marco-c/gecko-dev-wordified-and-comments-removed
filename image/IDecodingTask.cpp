#
include
"
IDecodingTask
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
Decoder
.
h
"
#
include
"
DecodePool
.
h
"
#
include
"
RasterImage
.
h
"
#
include
"
SurfaceCache
.
h
"
namespace
mozilla
{
using
gfx
:
:
IntRect
;
namespace
image
{
void
IDecodingTask
:
:
EnsureHasEventTarget
(
NotNull
<
RasterImage
*
>
aImage
)
{
if
(
!
mEventTarget
)
{
RefPtr
<
ProgressTracker
>
tracker
=
aImage
-
>
GetProgressTracker
(
)
;
if
(
tracker
)
{
mEventTarget
=
tracker
-
>
GetEventTarget
(
)
;
}
else
{
mEventTarget
=
GetMainThreadSerialEventTarget
(
)
;
}
}
}
bool
IDecodingTask
:
:
IsOnEventTarget
(
)
const
{
bool
current
=
false
;
mEventTarget
-
>
IsOnCurrentThread
(
&
current
)
;
return
current
;
}
void
IDecodingTask
:
:
NotifyProgress
(
NotNull
<
RasterImage
*
>
aImage
NotNull
<
Decoder
*
>
aDecoder
)
{
MOZ_ASSERT
(
aDecoder
-
>
HasProgress
(
)
&
&
!
aDecoder
-
>
IsMetadataDecode
(
)
)
;
EnsureHasEventTarget
(
aImage
)
;
Progress
progress
=
aDecoder
-
>
TakeProgress
(
)
;
OrientedIntRect
invalidRect
=
aDecoder
-
>
TakeInvalidRect
(
)
;
Maybe
<
uint32_t
>
frameCount
=
aDecoder
-
>
TakeCompleteFrameCount
(
)
;
DecoderFlags
decoderFlags
=
aDecoder
-
>
GetDecoderFlags
(
)
;
SurfaceFlags
surfaceFlags
=
aDecoder
-
>
GetSurfaceFlags
(
)
;
if
(
IsOnEventTarget
(
)
&
&
!
(
decoderFlags
&
DecoderFlags
:
:
ASYNC_NOTIFY
)
)
{
aImage
-
>
NotifyProgress
(
progress
invalidRect
frameCount
decoderFlags
surfaceFlags
)
;
return
;
}
if
(
gXPCOMThreadsShutDown
)
{
return
;
}
NotNull
<
RefPtr
<
RasterImage
>
>
image
=
aImage
;
mEventTarget
-
>
Dispatch
(
CreateMediumHighRunnable
(
NS_NewRunnableFunction
(
"
IDecodingTask
:
:
NotifyProgress
"
[
=
]
(
)
-
>
void
{
image
-
>
NotifyProgress
(
progress
invalidRect
frameCount
decoderFlags
surfaceFlags
)
;
}
)
)
NS_DISPATCH_NORMAL
)
;
}
void
IDecodingTask
:
:
NotifyDecodeComplete
(
NotNull
<
RasterImage
*
>
aImage
NotNull
<
Decoder
*
>
aDecoder
)
{
MOZ_ASSERT
(
aDecoder
-
>
HasError
(
)
|
|
!
aDecoder
-
>
InFrame
(
)
"
Decode
complete
in
the
middle
of
a
frame
?
"
)
;
EnsureHasEventTarget
(
aImage
)
;
DecoderFinalStatus
finalStatus
=
aDecoder
-
>
FinalStatus
(
)
;
ImageMetadata
metadata
=
aDecoder
-
>
GetImageMetadata
(
)
;
DecoderTelemetry
telemetry
=
aDecoder
-
>
Telemetry
(
)
;
Progress
progress
=
aDecoder
-
>
TakeProgress
(
)
;
OrientedIntRect
invalidRect
=
aDecoder
-
>
TakeInvalidRect
(
)
;
Maybe
<
uint32_t
>
frameCount
=
aDecoder
-
>
TakeCompleteFrameCount
(
)
;
DecoderFlags
decoderFlags
=
aDecoder
-
>
GetDecoderFlags
(
)
;
SurfaceFlags
surfaceFlags
=
aDecoder
-
>
GetSurfaceFlags
(
)
;
if
(
IsOnEventTarget
(
)
&
&
!
(
decoderFlags
&
DecoderFlags
:
:
ASYNC_NOTIFY
)
)
{
aImage
-
>
NotifyDecodeComplete
(
finalStatus
metadata
telemetry
progress
invalidRect
frameCount
decoderFlags
surfaceFlags
)
;
return
;
}
if
(
gXPCOMThreadsShutDown
)
{
return
;
}
NotNull
<
RefPtr
<
RasterImage
>
>
image
=
aImage
;
mEventTarget
-
>
Dispatch
(
CreateMediumHighRunnable
(
NS_NewRunnableFunction
(
"
IDecodingTask
:
:
NotifyDecodeComplete
"
[
=
]
(
)
-
>
void
{
image
-
>
NotifyDecodeComplete
(
finalStatus
metadata
telemetry
progress
invalidRect
frameCount
decoderFlags
surfaceFlags
)
;
}
)
)
NS_DISPATCH_NORMAL
)
;
}
void
IDecodingTask
:
:
Resume
(
)
{
DecodePool
:
:
Singleton
(
)
-
>
AsyncRun
(
this
)
;
}
MetadataDecodingTask
:
:
MetadataDecodingTask
(
NotNull
<
Decoder
*
>
aDecoder
)
:
mMutex
(
"
mozilla
:
:
image
:
:
MetadataDecodingTask
"
)
mDecoder
(
aDecoder
)
{
MOZ_ASSERT
(
mDecoder
-
>
IsMetadataDecode
(
)
"
Use
DecodingTask
for
non
-
metadata
decodes
"
)
;
}
void
MetadataDecodingTask
:
:
Run
(
)
{
MutexAutoLock
lock
(
mMutex
)
;
LexerResult
result
=
mDecoder
-
>
Decode
(
WrapNotNull
(
this
)
)
;
if
(
result
.
is
<
TerminalState
>
(
)
)
{
NotifyDecodeComplete
(
mDecoder
-
>
GetImage
(
)
mDecoder
)
;
return
;
}
if
(
result
=
=
LexerResult
(
Yield
:
:
NEED_MORE_DATA
)
)
{
return
;
}
MOZ_ASSERT_UNREACHABLE
(
"
Metadata
decode
yielded
for
an
unexpected
reason
"
)
;
}
AnonymousDecodingTask
:
:
AnonymousDecodingTask
(
NotNull
<
Decoder
*
>
aDecoder
bool
aResumable
)
:
mDecoder
(
aDecoder
)
mResumable
(
aResumable
)
{
}
void
AnonymousDecodingTask
:
:
Run
(
)
{
while
(
true
)
{
LexerResult
result
=
mDecoder
-
>
Decode
(
WrapNotNull
(
this
)
)
;
if
(
result
.
is
<
TerminalState
>
(
)
)
{
return
;
}
if
(
result
=
=
LexerResult
(
Yield
:
:
NEED_MORE_DATA
)
)
{
return
;
}
MOZ_ASSERT
(
result
.
is
<
Yield
>
(
)
)
;
}
}
void
AnonymousDecodingTask
:
:
Resume
(
)
{
if
(
mResumable
)
{
RefPtr
<
AnonymousDecodingTask
>
self
(
this
)
;
NS_DispatchToMainThread
(
NS_NewRunnableFunction
(
"
image
:
:
AnonymousDecodingTask
:
:
Resume
"
[
self
]
(
)
-
>
void
{
self
-
>
Run
(
)
;
}
)
)
;
}
}
}
}
