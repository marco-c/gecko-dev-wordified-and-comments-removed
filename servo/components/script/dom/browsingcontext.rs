use
dom
:
:
bindings
:
:
conversions
:
:
{
ToJSValConvertible
root_from_handleobject
}
;
use
dom
:
:
bindings
:
:
js
:
:
{
JS
Root
RootedReference
}
;
use
dom
:
:
bindings
:
:
proxyhandler
:
:
{
fill_property_descriptor
get_property_descriptor
}
;
use
dom
:
:
bindings
:
:
reflector
:
:
{
DomObject
Reflector
}
;
use
dom
:
:
bindings
:
:
trace
:
:
JSTraceable
;
use
dom
:
:
bindings
:
:
utils
:
:
WindowProxyHandler
;
use
dom
:
:
bindings
:
:
utils
:
:
get_array_index_from_id
;
use
dom
:
:
element
:
:
Element
;
use
dom
:
:
window
:
:
Window
;
use
js
:
:
JSCLASS_IS_GLOBAL
;
use
js
:
:
glue
:
:
{
CreateWrapperProxyHandler
ProxyTraps
NewWindowProxy
}
;
use
js
:
:
glue
:
:
{
GetProxyPrivate
SetProxyExtra
GetProxyExtra
}
;
use
js
:
:
jsapi
:
:
{
Handle
HandleId
HandleObject
HandleValue
}
;
use
js
:
:
jsapi
:
:
{
JSAutoCompartment
JSContext
JSErrNum
JSFreeOp
JSObject
}
;
use
js
:
:
jsapi
:
:
{
JSPROP_READONLY
JSTracer
JS_DefinePropertyById
}
;
use
js
:
:
jsapi
:
:
{
JS_ForwardGetPropertyTo
JS_ForwardSetPropertyTo
}
;
use
js
:
:
jsapi
:
:
{
JS_GetOwnPropertyDescriptorById
JS_HasPropertyById
}
;
use
js
:
:
jsapi
:
:
{
JS_TransplantObject
SetWindowProxy
}
;
use
js
:
:
jsapi
:
:
{
MutableHandle
MutableHandleObject
MutableHandleValue
}
;
use
js
:
:
jsapi
:
:
{
ObjectOpResult
PropertyDescriptor
}
;
use
js
:
:
jsval
:
:
{
UndefinedValue
PrivateValue
}
;
use
js
:
:
rust
:
:
get_object_class
;
use
std
:
:
cell
:
:
Cell
;
use
std
:
:
ptr
;
#
[
dom_struct
]
pub
struct
BrowsingContext
{
reflector
:
Reflector
discarded
:
Cell
<
bool
>
frame_element
:
Option
<
JS
<
Element
>
>
}
impl
BrowsingContext
{
pub
fn
new_inherited
(
frame_element
:
Option
<
&
Element
>
)
-
>
BrowsingContext
{
BrowsingContext
{
reflector
:
Reflector
:
:
new
(
)
discarded
:
Cell
:
:
new
(
false
)
frame_element
:
frame_element
.
map
(
JS
:
:
from_ref
)
}
}
#
[
allow
(
unsafe_code
)
]
pub
fn
new
(
window
:
&
Window
frame_element
:
Option
<
&
Element
>
)
-
>
Root
<
BrowsingContext
>
{
unsafe
{
let
WindowProxyHandler
(
handler
)
=
window
.
windowproxy_handler
(
)
;
assert
!
(
!
handler
.
is_null
(
)
)
;
let
cx
=
window
.
get_cx
(
)
;
let
window_jsobject
=
window
.
reflector
(
)
.
get_jsobject
(
)
;
assert
!
(
!
window_jsobject
.
get
(
)
.
is_null
(
)
)
;
assert
!
(
(
(
*
get_object_class
(
window_jsobject
.
get
(
)
)
)
.
flags
&
JSCLASS_IS_GLOBAL
)
!
=
0
)
;
let
_ac
=
JSAutoCompartment
:
:
new
(
cx
window_jsobject
.
get
(
)
)
;
rooted
!
(
in
(
cx
)
let
window_proxy
=
NewWindowProxy
(
cx
window_jsobject
handler
)
)
;
assert
!
(
!
window_proxy
.
is_null
(
)
)
;
let
mut
browsing_context
=
box
BrowsingContext
:
:
new_inherited
(
frame_element
)
;
SetProxyExtra
(
window_proxy
.
get
(
)
0
&
PrivateValue
(
&
*
browsing_context
as
*
const
_
as
*
const
_
)
)
;
SetWindowProxy
(
cx
window_jsobject
window_proxy
.
handle
(
)
)
;
debug
!
(
"
Initializing
reflector
of
{
:
p
}
to
{
:
p
}
.
"
browsing_context
window_proxy
.
get
(
)
)
;
browsing_context
.
reflector
.
set_jsobject
(
window_proxy
.
get
(
)
)
;
Root
:
:
from_ref
(
&
*
Box
:
:
into_raw
(
browsing_context
)
)
}
}
pub
fn
discard
(
&
self
)
{
self
.
discarded
.
set
(
true
)
;
}
pub
fn
is_discarded
(
&
self
)
-
>
bool
{
self
.
discarded
.
get
(
)
}
pub
fn
frame_element
(
&
self
)
-
>
Option
<
&
Element
>
{
self
.
frame_element
.
r
(
)
}
#
[
allow
(
unsafe_code
)
]
pub
fn
set_window_proxy
(
&
self
window
:
&
Window
)
{
unsafe
{
debug
!
(
"
Setting
window
proxy
of
{
:
p
}
.
"
self
)
;
let
WindowProxyHandler
(
handler
)
=
window
.
windowproxy_handler
(
)
;
assert
!
(
!
handler
.
is_null
(
)
)
;
let
cx
=
window
.
get_cx
(
)
;
let
window_jsobject
=
window
.
reflector
(
)
.
get_jsobject
(
)
;
let
old_window_proxy
=
self
.
reflector
.
get_jsobject
(
)
;
assert
!
(
!
window_jsobject
.
get
(
)
.
is_null
(
)
)
;
assert
!
(
(
(
*
get_object_class
(
window_jsobject
.
get
(
)
)
)
.
flags
&
JSCLASS_IS_GLOBAL
)
!
=
0
)
;
let
_ac
=
JSAutoCompartment
:
:
new
(
cx
window_jsobject
.
get
(
)
)
;
SetProxyExtra
(
old_window_proxy
.
get
(
)
0
&
PrivateValue
(
ptr
:
:
null_mut
(
)
)
)
;
rooted
!
(
in
(
cx
)
let
new_window_proxy
=
NewWindowProxy
(
cx
window_jsobject
handler
)
)
;
debug
!
(
"
Transplanting
window
proxy
from
{
:
p
}
to
{
:
p
}
.
"
old_window_proxy
.
get
(
)
new_window_proxy
.
get
(
)
)
;
rooted
!
(
in
(
cx
)
let
new_window_proxy
=
JS_TransplantObject
(
cx
old_window_proxy
new_window_proxy
.
handle
(
)
)
)
;
debug
!
(
"
Transplanted
window
proxy
is
{
:
p
}
.
"
new_window_proxy
.
get
(
)
)
;
SetProxyExtra
(
new_window_proxy
.
get
(
)
0
&
PrivateValue
(
self
as
*
const
_
as
*
const
_
)
)
;
SetWindowProxy
(
cx
window_jsobject
new_window_proxy
.
handle
(
)
)
;
debug
!
(
"
Setting
reflector
of
{
:
p
}
to
{
:
p
}
.
"
self
new_window_proxy
.
get
(
)
)
;
self
.
reflector
.
rootable
(
)
.
set
(
new_window_proxy
.
get
(
)
)
;
}
}
pub
fn
window_proxy
(
&
self
)
-
>
*
mut
JSObject
{
let
window_proxy
=
self
.
reflector
.
get_jsobject
(
)
;
assert
!
(
!
window_proxy
.
get
(
)
.
is_null
(
)
)
;
window_proxy
.
get
(
)
}
}
#
[
allow
(
unsafe_code
)
]
unsafe
fn
GetSubframeWindow
(
cx
:
*
mut
JSContext
proxy
:
HandleObject
id
:
HandleId
)
-
>
Option
<
Root
<
Window
>
>
{
let
index
=
get_array_index_from_id
(
cx
id
)
;
if
let
Some
(
index
)
=
index
{
rooted
!
(
in
(
cx
)
let
target
=
GetProxyPrivate
(
*
proxy
.
ptr
)
.
to_object
(
)
)
;
let
win
=
root_from_handleobject
:
:
<
Window
>
(
target
.
handle
(
)
)
.
unwrap
(
)
;
let
mut
found
=
false
;
return
win
.
IndexedGetter
(
index
&
mut
found
)
;
}
None
}
#
[
allow
(
unsafe_code
)
]
unsafe
extern
"
C
"
fn
getOwnPropertyDescriptor
(
cx
:
*
mut
JSContext
proxy
:
HandleObject
id
:
HandleId
mut
desc
:
MutableHandle
<
PropertyDescriptor
>
)
-
>
bool
{
let
window
=
GetSubframeWindow
(
cx
proxy
id
)
;
if
let
Some
(
window
)
=
window
{
rooted
!
(
in
(
cx
)
let
mut
val
=
UndefinedValue
(
)
)
;
window
.
to_jsval
(
cx
val
.
handle_mut
(
)
)
;
desc
.
value
=
val
.
get
(
)
;
fill_property_descriptor
(
desc
proxy
.
get
(
)
JSPROP_READONLY
)
;
return
true
;
}
rooted
!
(
in
(
cx
)
let
target
=
GetProxyPrivate
(
proxy
.
get
(
)
)
.
to_object
(
)
)
;
if
!
JS_GetOwnPropertyDescriptorById
(
cx
target
.
handle
(
)
id
desc
)
{
return
false
;
}
assert
!
(
desc
.
obj
.
is_null
(
)
|
|
desc
.
obj
=
=
target
.
get
(
)
)
;
if
desc
.
obj
=
=
target
.
get
(
)
{
desc
.
get
(
)
.
obj
=
proxy
.
get
(
)
;
}
true
}
#
[
allow
(
unsafe_code
)
]
unsafe
extern
"
C
"
fn
defineProperty
(
cx
:
*
mut
JSContext
proxy
:
HandleObject
id
:
HandleId
desc
:
Handle
<
PropertyDescriptor
>
res
:
*
mut
ObjectOpResult
)
-
>
bool
{
if
get_array_index_from_id
(
cx
id
)
.
is_some
(
)
{
(
*
res
)
.
code_
=
JSErrNum
:
:
JSMSG_CANT_DEFINE_WINDOW_ELEMENT
as
:
:
libc
:
:
uintptr_t
;
return
true
;
}
rooted
!
(
in
(
cx
)
let
target
=
GetProxyPrivate
(
*
proxy
.
ptr
)
.
to_object
(
)
)
;
JS_DefinePropertyById
(
cx
target
.
handle
(
)
id
desc
res
)
}
#
[
allow
(
unsafe_code
)
]
unsafe
extern
"
C
"
fn
has
(
cx
:
*
mut
JSContext
proxy
:
HandleObject
id
:
HandleId
bp
:
*
mut
bool
)
-
>
bool
{
let
window
=
GetSubframeWindow
(
cx
proxy
id
)
;
if
window
.
is_some
(
)
{
*
bp
=
true
;
return
true
;
}
rooted
!
(
in
(
cx
)
let
target
=
GetProxyPrivate
(
*
proxy
.
ptr
)
.
to_object
(
)
)
;
let
mut
found
=
false
;
if
!
JS_HasPropertyById
(
cx
target
.
handle
(
)
id
&
mut
found
)
{
return
false
;
}
*
bp
=
found
;
true
}
#
[
allow
(
unsafe_code
)
]
unsafe
extern
"
C
"
fn
get
(
cx
:
*
mut
JSContext
proxy
:
HandleObject
receiver
:
HandleValue
id
:
HandleId
vp
:
MutableHandleValue
)
-
>
bool
{
let
window
=
GetSubframeWindow
(
cx
proxy
id
)
;
if
let
Some
(
window
)
=
window
{
window
.
to_jsval
(
cx
vp
)
;
return
true
;
}
rooted
!
(
in
(
cx
)
let
target
=
GetProxyPrivate
(
*
proxy
.
ptr
)
.
to_object
(
)
)
;
JS_ForwardGetPropertyTo
(
cx
target
.
handle
(
)
id
receiver
vp
)
}
#
[
allow
(
unsafe_code
)
]
unsafe
extern
"
C
"
fn
set
(
cx
:
*
mut
JSContext
proxy
:
HandleObject
id
:
HandleId
v
:
HandleValue
receiver
:
HandleValue
res
:
*
mut
ObjectOpResult
)
-
>
bool
{
if
get_array_index_from_id
(
cx
id
)
.
is_some
(
)
{
(
*
res
)
.
code_
=
JSErrNum
:
:
JSMSG_READ_ONLY
as
:
:
libc
:
:
uintptr_t
;
return
true
;
}
rooted
!
(
in
(
cx
)
let
target
=
GetProxyPrivate
(
*
proxy
.
ptr
)
.
to_object
(
)
)
;
JS_ForwardSetPropertyTo
(
cx
target
.
handle
(
)
id
v
receiver
res
)
}
#
[
allow
(
unsafe_code
)
]
unsafe
extern
"
C
"
fn
get_prototype_if_ordinary
(
_
:
*
mut
JSContext
_
:
HandleObject
is_ordinary
:
*
mut
bool
_
:
MutableHandleObject
)
-
>
bool
{
*
is_ordinary
=
false
;
return
true
;
}
static
PROXY_HANDLER
:
ProxyTraps
=
ProxyTraps
{
enter
:
None
getOwnPropertyDescriptor
:
Some
(
getOwnPropertyDescriptor
)
defineProperty
:
Some
(
defineProperty
)
ownPropertyKeys
:
None
delete_
:
None
enumerate
:
None
getPrototypeIfOrdinary
:
Some
(
get_prototype_if_ordinary
)
preventExtensions
:
None
isExtensible
:
None
has
:
Some
(
has
)
get
:
Some
(
get
)
set
:
Some
(
set
)
call
:
None
construct
:
None
getPropertyDescriptor
:
Some
(
get_property_descriptor
)
hasOwn
:
None
getOwnEnumerablePropertyKeys
:
None
nativeCall
:
None
hasInstance
:
None
objectClassIs
:
None
className
:
None
fun_toString
:
None
boxedValue_unbox
:
None
defaultValue
:
None
trace
:
Some
(
trace
)
finalize
:
Some
(
finalize
)
objectMoved
:
None
isCallable
:
None
isConstructor
:
None
}
;
#
[
allow
(
unsafe_code
)
]
unsafe
extern
fn
finalize
(
_fop
:
*
mut
JSFreeOp
obj
:
*
mut
JSObject
)
{
let
this
=
GetProxyExtra
(
obj
0
)
.
to_private
(
)
as
*
mut
BrowsingContext
;
if
this
.
is_null
(
)
{
return
;
}
let
jsobject
=
(
*
this
)
.
reflector
.
get_jsobject
(
)
.
get
(
)
;
debug
!
(
"
BrowsingContext
finalize
:
{
:
p
}
with
reflector
{
:
p
}
from
{
:
p
}
.
"
this
jsobject
obj
)
;
let
_
=
Box
:
:
from_raw
(
this
)
;
}
#
[
allow
(
unsafe_code
)
]
unsafe
extern
fn
trace
(
trc
:
*
mut
JSTracer
obj
:
*
mut
JSObject
)
{
let
this
=
GetProxyExtra
(
obj
0
)
.
to_private
(
)
as
*
const
BrowsingContext
;
if
this
.
is_null
(
)
{
return
;
}
(
*
this
)
.
trace
(
trc
)
;
}
#
[
allow
(
unsafe_code
)
]
pub
fn
new_window_proxy_handler
(
)
-
>
WindowProxyHandler
{
unsafe
{
WindowProxyHandler
(
CreateWrapperProxyHandler
(
&
PROXY_HANDLER
)
)
}
}
