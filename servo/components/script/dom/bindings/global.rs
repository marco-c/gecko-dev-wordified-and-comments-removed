use
dom
:
:
bindings
:
:
conversions
:
:
FromJSValConvertible
;
use
dom
:
:
bindings
:
:
js
:
:
{
JS
JSRef
Root
}
;
use
dom
:
:
bindings
:
:
utils
:
:
{
Reflectable
Reflector
}
;
use
dom
:
:
workerglobalscope
:
:
{
WorkerGlobalScope
WorkerGlobalScopeHelpers
}
;
use
dom
:
:
window
;
use
script_task
:
:
ScriptChan
;
use
servo_net
:
:
resource_task
:
:
ResourceTask
;
use
js
:
:
{
JSCLASS_IS_GLOBAL
JSCLASS_IS_DOMJSCLASS
}
;
use
js
:
:
glue
:
:
{
GetGlobalForObjectCrossCompartment
}
;
use
js
:
:
jsapi
:
:
{
JSContext
JSObject
}
;
use
js
:
:
jsapi
:
:
{
JS_GetClass
}
;
use
js
:
:
jsval
:
:
ObjectOrNullValue
;
use
url
:
:
Url
;
use
std
:
:
ptr
;
#
[
deriving
(
Copy
)
]
pub
enum
GlobalRef
<
'
a
>
{
Window
(
JSRef
<
'
a
window
:
:
Window
>
)
Worker
(
JSRef
<
'
a
WorkerGlobalScope
>
)
}
pub
enum
GlobalRoot
{
Window
(
Root
<
window
:
:
Window
>
)
Worker
(
Root
<
WorkerGlobalScope
>
)
}
#
[
jstraceable
]
#
[
must_root
]
pub
enum
GlobalField
{
Window
(
JS
<
window
:
:
Window
>
)
Worker
(
JS
<
WorkerGlobalScope
>
)
}
impl
<
'
a
>
GlobalRef
<
'
a
>
{
pub
fn
get_cx
(
&
self
)
-
>
*
mut
JSContext
{
match
*
self
{
GlobalRef
:
:
Window
(
ref
window
)
=
>
window
.
get_cx
(
)
GlobalRef
:
:
Worker
(
ref
worker
)
=
>
worker
.
get_cx
(
)
}
}
pub
fn
as_window
<
'
b
>
(
&
'
b
self
)
-
>
JSRef
<
'
b
window
:
:
Window
>
{
match
*
self
{
GlobalRef
:
:
Window
(
window
)
=
>
window
GlobalRef
:
:
Worker
(
_
)
=
>
panic
!
(
"
expected
a
Window
scope
"
)
}
}
pub
fn
resource_task
(
&
self
)
-
>
ResourceTask
{
match
*
self
{
GlobalRef
:
:
Window
(
ref
window
)
=
>
window
.
page
(
)
.
resource_task
.
clone
(
)
GlobalRef
:
:
Worker
(
ref
worker
)
=
>
worker
.
resource_task
(
)
.
clone
(
)
}
}
pub
fn
get_url
(
&
self
)
-
>
Url
{
match
*
self
{
GlobalRef
:
:
Window
(
ref
window
)
=
>
window
.
get_url
(
)
GlobalRef
:
:
Worker
(
ref
worker
)
=
>
worker
.
get_url
(
)
.
clone
(
)
}
}
pub
fn
script_chan
(
&
self
)
-
>
Box
<
ScriptChan
+
Send
>
{
match
*
self
{
GlobalRef
:
:
Window
(
ref
window
)
=
>
window
.
script_chan
(
)
GlobalRef
:
:
Worker
(
ref
worker
)
=
>
worker
.
script_chan
(
)
}
}
}
impl
<
'
a
>
Reflectable
for
GlobalRef
<
'
a
>
{
fn
reflector
<
'
b
>
(
&
'
b
self
)
-
>
&
'
b
Reflector
{
match
*
self
{
GlobalRef
:
:
Window
(
ref
window
)
=
>
window
.
reflector
(
)
GlobalRef
:
:
Worker
(
ref
worker
)
=
>
worker
.
reflector
(
)
}
}
}
impl
GlobalRoot
{
pub
fn
r
<
'
c
>
(
&
'
c
self
)
-
>
GlobalRef
<
'
c
>
{
match
*
self
{
GlobalRoot
:
:
Window
(
ref
window
)
=
>
GlobalRef
:
:
Window
(
window
.
r
(
)
)
GlobalRoot
:
:
Worker
(
ref
worker
)
=
>
GlobalRef
:
:
Worker
(
worker
.
r
(
)
)
}
}
}
impl
GlobalField
{
pub
fn
from_rooted
(
global
:
&
GlobalRef
)
-
>
GlobalField
{
match
*
global
{
GlobalRef
:
:
Window
(
window
)
=
>
GlobalField
:
:
Window
(
JS
:
:
from_rooted
(
window
)
)
GlobalRef
:
:
Worker
(
worker
)
=
>
GlobalField
:
:
Worker
(
JS
:
:
from_rooted
(
worker
)
)
}
}
pub
fn
root
(
&
self
)
-
>
GlobalRoot
{
match
*
self
{
GlobalField
:
:
Window
(
ref
window
)
=
>
GlobalRoot
:
:
Window
(
window
.
root
(
)
)
GlobalField
:
:
Worker
(
ref
worker
)
=
>
GlobalRoot
:
:
Worker
(
worker
.
root
(
)
)
}
}
}
#
[
allow
(
unrooted_must_root
)
]
pub
fn
global_object_for_js_object
(
obj
:
*
mut
JSObject
)
-
>
GlobalField
{
unsafe
{
let
global
=
GetGlobalForObjectCrossCompartment
(
obj
)
;
let
clasp
=
JS_GetClass
(
global
)
;
assert
!
(
(
(
*
clasp
)
.
flags
&
(
JSCLASS_IS_DOMJSCLASS
|
JSCLASS_IS_GLOBAL
)
)
!
=
0
)
;
match
FromJSValConvertible
:
:
from_jsval
(
ptr
:
:
null_mut
(
)
ObjectOrNullValue
(
global
)
(
)
)
{
Ok
(
window
)
=
>
return
GlobalField
:
:
Window
(
window
)
Err
(
_
)
=
>
(
)
}
match
FromJSValConvertible
:
:
from_jsval
(
ptr
:
:
null_mut
(
)
ObjectOrNullValue
(
global
)
(
)
)
{
Ok
(
worker
)
=
>
return
GlobalField
:
:
Worker
(
worker
)
Err
(
_
)
=
>
(
)
}
panic
!
(
"
found
DOM
global
that
doesn
'
t
unwrap
to
Window
or
WorkerGlobalScope
"
)
}
}
