use
devtools_traits
:
:
ScriptToDevtoolsControlMsg
;
use
dom
:
:
bindings
:
:
inheritance
:
:
Castable
;
use
dom
:
:
bindings
:
:
root
:
:
DomRoot
;
use
dom
:
:
globalscope
:
:
GlobalScope
;
use
dom
:
:
paintworkletglobalscope
:
:
PaintWorkletGlobalScope
;
use
dom
:
:
paintworkletglobalscope
:
:
PaintWorkletTask
;
use
dom
:
:
testworkletglobalscope
:
:
TestWorkletGlobalScope
;
use
dom
:
:
testworkletglobalscope
:
:
TestWorkletTask
;
use
dom
:
:
worklet
:
:
WorkletExecutor
;
use
dom_struct
:
:
dom_struct
;
use
ipc_channel
:
:
ipc
;
use
ipc_channel
:
:
ipc
:
:
IpcSender
;
use
js
:
:
jsapi
:
:
JSContext
;
use
js
:
:
jsval
:
:
UndefinedValue
;
use
js
:
:
rust
:
:
Runtime
;
use
msg
:
:
constellation_msg
:
:
PipelineId
;
use
net_traits
:
:
ResourceThreads
;
use
net_traits
:
:
image_cache
:
:
ImageCache
;
use
profile_traits
:
:
mem
;
use
profile_traits
:
:
time
;
use
script_thread
:
:
MainThreadScriptMsg
;
use
script_traits
:
:
{
Painter
ScriptMsg
}
;
use
script_traits
:
:
{
ScriptToConstellationChan
TimerSchedulerMsg
}
;
use
servo_atoms
:
:
Atom
;
use
servo_url
:
:
ImmutableOrigin
;
use
servo_url
:
:
MutableOrigin
;
use
servo_url
:
:
ServoUrl
;
use
std
:
:
sync
:
:
Arc
;
use
std
:
:
sync
:
:
mpsc
:
:
Sender
;
#
[
dom_struct
]
pub
struct
WorkletGlobalScope
{
globalscope
:
GlobalScope
base_url
:
ServoUrl
#
[
ignore_heap_size_of
=
"
channels
are
hard
"
]
to_script_thread_sender
:
Sender
<
MainThreadScriptMsg
>
executor
:
WorkletExecutor
}
impl
WorkletGlobalScope
{
pub
fn
new_inherited
(
pipeline_id
:
PipelineId
base_url
:
ServoUrl
executor
:
WorkletExecutor
init
:
&
WorkletGlobalScopeInit
)
-
>
Self
{
let
(
timer_event_chan
_
)
=
ipc
:
:
channel
(
)
.
unwrap
(
)
;
let
script_to_constellation_chan
=
ScriptToConstellationChan
{
sender
:
init
.
to_constellation_sender
.
clone
(
)
pipeline_id
}
;
Self
{
globalscope
:
GlobalScope
:
:
new_inherited
(
pipeline_id
init
.
devtools_chan
.
clone
(
)
init
.
mem_profiler_chan
.
clone
(
)
init
.
time_profiler_chan
.
clone
(
)
script_to_constellation_chan
init
.
scheduler_chan
.
clone
(
)
init
.
resource_threads
.
clone
(
)
timer_event_chan
MutableOrigin
:
:
new
(
ImmutableOrigin
:
:
new_opaque
(
)
)
Default
:
:
default
(
)
)
base_url
to_script_thread_sender
:
init
.
to_script_thread_sender
.
clone
(
)
executor
}
}
pub
fn
get_cx
(
&
self
)
-
>
*
mut
JSContext
{
self
.
globalscope
.
get_cx
(
)
}
pub
fn
evaluate_js
(
&
self
script
:
&
str
)
-
>
bool
{
debug
!
(
"
Evaluating
Dom
.
"
)
;
rooted
!
(
in
(
self
.
globalscope
.
get_cx
(
)
)
let
mut
rval
=
UndefinedValue
(
)
)
;
self
.
globalscope
.
evaluate_js_on_global_with_result
(
&
*
script
rval
.
handle_mut
(
)
)
}
pub
fn
register_paint_worklet
(
&
self
name
:
Atom
properties
:
Vec
<
Atom
>
painter
:
Box
<
Painter
>
)
{
self
.
to_script_thread_sender
.
send
(
MainThreadScriptMsg
:
:
RegisterPaintWorklet
{
pipeline_id
:
self
.
globalscope
.
pipeline_id
(
)
name
properties
painter
}
)
.
expect
(
"
Worklet
thread
outlived
script
thread
.
"
)
;
}
pub
fn
base_url
(
&
self
)
-
>
ServoUrl
{
self
.
base_url
.
clone
(
)
}
pub
fn
executor
(
&
self
)
-
>
WorkletExecutor
{
self
.
executor
.
clone
(
)
}
pub
fn
perform_a_worklet_task
(
&
self
task
:
WorkletTask
)
{
match
task
{
WorkletTask
:
:
Test
(
task
)
=
>
match
self
.
downcast
:
:
<
TestWorkletGlobalScope
>
(
)
{
Some
(
global
)
=
>
global
.
perform_a_worklet_task
(
task
)
None
=
>
warn
!
(
"
This
is
not
a
test
worklet
.
"
)
}
WorkletTask
:
:
Paint
(
task
)
=
>
match
self
.
downcast
:
:
<
PaintWorkletGlobalScope
>
(
)
{
Some
(
global
)
=
>
global
.
perform_a_worklet_task
(
task
)
None
=
>
warn
!
(
"
This
is
not
a
paint
worklet
.
"
)
}
}
}
}
#
[
derive
(
Clone
)
]
pub
struct
WorkletGlobalScopeInit
{
pub
to_script_thread_sender
:
Sender
<
MainThreadScriptMsg
>
pub
resource_threads
:
ResourceThreads
pub
mem_profiler_chan
:
mem
:
:
ProfilerChan
pub
time_profiler_chan
:
time
:
:
ProfilerChan
pub
devtools_chan
:
Option
<
IpcSender
<
ScriptToDevtoolsControlMsg
>
>
pub
to_constellation_sender
:
IpcSender
<
(
PipelineId
ScriptMsg
)
>
pub
scheduler_chan
:
IpcSender
<
TimerSchedulerMsg
>
pub
image_cache
:
Arc
<
ImageCache
>
}
#
[
derive
(
Clone
Copy
Debug
HeapSizeOf
JSTraceable
)
]
pub
enum
WorkletGlobalScopeType
{
Test
Paint
}
impl
WorkletGlobalScopeType
{
pub
fn
new
(
&
self
runtime
:
&
Runtime
pipeline_id
:
PipelineId
base_url
:
ServoUrl
executor
:
WorkletExecutor
init
:
&
WorkletGlobalScopeInit
)
-
>
DomRoot
<
WorkletGlobalScope
>
{
match
*
self
{
WorkletGlobalScopeType
:
:
Test
=
>
DomRoot
:
:
upcast
(
TestWorkletGlobalScope
:
:
new
(
runtime
pipeline_id
base_url
executor
init
)
)
WorkletGlobalScopeType
:
:
Paint
=
>
DomRoot
:
:
upcast
(
PaintWorkletGlobalScope
:
:
new
(
runtime
pipeline_id
base_url
executor
init
)
)
}
}
}
pub
enum
WorkletTask
{
Test
(
TestWorkletTask
)
Paint
(
PaintWorkletTask
)
}
