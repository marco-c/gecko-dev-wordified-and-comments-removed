use
net_traits
:
:
{
AsyncResponseListener
ResponseAction
}
;
use
script_task
:
:
ScriptTaskEventCategory
:
:
NetworkEvent
;
use
script_task
:
:
{
ScriptChan
Runnable
CommonScriptMsg
}
;
use
std
:
:
sync
:
:
{
Arc
Mutex
}
;
pub
struct
NetworkListener
<
T
:
AsyncResponseListener
+
PreInvoke
+
Send
+
'
static
>
{
pub
context
:
Arc
<
Mutex
<
T
>
>
pub
script_chan
:
Box
<
ScriptChan
+
Send
>
}
impl
<
T
:
AsyncResponseListener
+
PreInvoke
+
Send
+
'
static
>
NetworkListener
<
T
>
{
pub
fn
notify
(
&
self
action
:
ResponseAction
)
{
if
let
Err
(
err
)
=
self
.
script_chan
.
send
(
CommonScriptMsg
:
:
RunnableMsg
(
NetworkEvent
box
ListenerRunnable
{
context
:
self
.
context
.
clone
(
)
action
:
action
}
)
)
{
warn
!
(
"
failed
to
deliver
network
data
:
{
:
?
}
"
err
)
;
}
}
}
pub
trait
PreInvoke
{
fn
should_invoke
(
&
self
)
-
>
bool
{
true
}
}
struct
ListenerRunnable
<
T
:
AsyncResponseListener
+
PreInvoke
+
Send
>
{
context
:
Arc
<
Mutex
<
T
>
>
action
:
ResponseAction
}
impl
<
T
:
AsyncResponseListener
+
PreInvoke
+
Send
>
Runnable
for
ListenerRunnable
<
T
>
{
fn
handler
(
self
:
Box
<
ListenerRunnable
<
T
>
>
)
{
let
this
=
*
self
;
let
context
=
this
.
context
.
lock
(
)
.
unwrap
(
)
;
if
context
.
should_invoke
(
)
{
this
.
action
.
process
(
&
*
context
)
;
}
}
}
