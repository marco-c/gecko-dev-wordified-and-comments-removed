#
!
[
feature
(
plugin
proc_macro
)
]
#
!
[
plugin
(
plugins
)
]
#
!
[
deny
(
missing_docs
)
]
#
!
[
deny
(
unsafe_code
)
]
extern
crate
bluetooth_traits
;
extern
crate
canvas_traits
;
extern
crate
cookie
as
cookie_rs
;
extern
crate
devtools_traits
;
extern
crate
euclid
;
extern
crate
gfx_traits
;
extern
crate
heapsize
;
#
[
macro_use
]
extern
crate
heapsize_derive
;
extern
crate
hyper
;
extern
crate
hyper_serde
;
extern
crate
ipc_channel
;
extern
crate
libc
;
extern
crate
msg
;
extern
crate
net_traits
;
extern
crate
offscreen_gl_context
;
extern
crate
profile_traits
;
extern
crate
rustc_serialize
;
extern
crate
serde
;
#
[
macro_use
]
extern
crate
serde_derive
;
extern
crate
style_traits
;
extern
crate
time
;
extern
crate
url
;
mod
script_msg
;
pub
mod
webdriver_msg
;
use
bluetooth_traits
:
:
BluetoothRequest
;
use
devtools_traits
:
:
{
DevtoolScriptControlMsg
ScriptToDevtoolsControlMsg
WorkerId
}
;
use
euclid
:
:
Size2D
;
use
euclid
:
:
length
:
:
Length
;
use
euclid
:
:
point
:
:
Point2D
;
use
euclid
:
:
rect
:
:
Rect
;
use
euclid
:
:
scale_factor
:
:
ScaleFactor
;
use
euclid
:
:
size
:
:
TypedSize2D
;
use
gfx_traits
:
:
DevicePixel
;
use
gfx_traits
:
:
Epoch
;
use
gfx_traits
:
:
ScrollRootId
;
use
heapsize
:
:
HeapSizeOf
;
use
hyper
:
:
header
:
:
Headers
;
use
hyper
:
:
method
:
:
Method
;
use
ipc_channel
:
:
ipc
:
:
{
IpcReceiver
IpcSender
}
;
use
libc
:
:
c_void
;
use
msg
:
:
constellation_msg
:
:
{
FrameId
FrameType
Key
KeyModifiers
KeyState
}
;
use
msg
:
:
constellation_msg
:
:
{
PipelineId
PipelineNamespaceId
TraversalDirection
}
;
use
net_traits
:
:
{
ReferrerPolicy
ResourceThreads
}
;
use
net_traits
:
:
image
:
:
base
:
:
Image
;
use
net_traits
:
:
image_cache_thread
:
:
ImageCacheThread
;
use
net_traits
:
:
response
:
:
HttpsState
;
use
profile_traits
:
:
mem
;
use
profile_traits
:
:
time
as
profile_time
;
use
serde
:
:
{
Deserialize
Deserializer
Serialize
Serializer
}
;
use
std
:
:
collections
:
:
HashMap
;
use
std
:
:
fmt
;
use
std
:
:
sync
:
:
mpsc
:
:
{
Receiver
Sender
}
;
use
style_traits
:
:
{
PagePx
UnsafeNode
ViewportPx
}
;
use
url
:
:
Url
;
use
webdriver_msg
:
:
{
LoadStatus
WebDriverScriptCommand
}
;
pub
use
script_msg
:
:
{
LayoutMsg
ScriptMsg
EventResult
LogEntry
}
;
pub
use
script_msg
:
:
{
ServiceWorkerMsg
ScopeThings
SWManagerMsg
SWManagerSenders
DOMMessage
}
;
#
[
derive
(
Copy
Clone
Debug
PartialEq
Eq
Hash
)
]
pub
struct
UntrustedNodeAddress
(
pub
*
const
c_void
)
;
impl
HeapSizeOf
for
UntrustedNodeAddress
{
fn
heap_size_of_children
(
&
self
)
-
>
usize
{
0
}
}
#
[
allow
(
unsafe_code
)
]
unsafe
impl
Send
for
UntrustedNodeAddress
{
}
impl
Serialize
for
UntrustedNodeAddress
{
fn
serialize
<
S
:
Serializer
>
(
&
self
s
:
&
mut
S
)
-
>
Result
<
(
)
S
:
:
Error
>
{
(
self
.
0
as
usize
)
.
serialize
(
s
)
}
}
impl
Deserialize
for
UntrustedNodeAddress
{
fn
deserialize
<
D
:
Deserializer
>
(
d
:
&
mut
D
)
-
>
Result
<
UntrustedNodeAddress
D
:
:
Error
>
{
let
value
:
usize
=
try
!
(
Deserialize
:
:
deserialize
(
d
)
)
;
Ok
(
UntrustedNodeAddress
:
:
from_id
(
value
)
)
}
}
impl
UntrustedNodeAddress
{
#
[
inline
]
pub
fn
from_id
(
id
:
usize
)
-
>
UntrustedNodeAddress
{
UntrustedNodeAddress
(
id
as
*
const
c_void
)
}
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
LayoutControlMsg
{
ExitNow
GetCurrentEpoch
(
IpcSender
<
Epoch
>
)
TickAnimations
SetStackingContextScrollStates
(
Vec
<
StackingContextScrollState
>
)
GetWebFontLoadState
(
IpcSender
<
bool
>
)
}
#
[
derive
(
Clone
Deserialize
Serialize
)
]
pub
struct
LoadData
{
pub
url
:
Url
#
[
serde
(
deserialize_with
=
"
:
:
hyper_serde
:
:
deserialize
"
serialize_with
=
"
:
:
hyper_serde
:
:
serialize
"
)
]
pub
method
:
Method
#
[
serde
(
deserialize_with
=
"
:
:
hyper_serde
:
:
deserialize
"
serialize_with
=
"
:
:
hyper_serde
:
:
serialize
"
)
]
pub
headers
:
Headers
pub
data
:
Option
<
Vec
<
u8
>
>
pub
referrer_policy
:
Option
<
ReferrerPolicy
>
pub
referrer_url
:
Option
<
Url
>
}
impl
LoadData
{
pub
fn
new
(
url
:
Url
referrer_policy
:
Option
<
ReferrerPolicy
>
referrer_url
:
Option
<
Url
>
)
-
>
LoadData
{
LoadData
{
url
:
url
method
:
Method
:
:
Get
headers
:
Headers
:
:
new
(
)
data
:
None
referrer_policy
:
referrer_policy
referrer_url
:
referrer_url
}
}
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
struct
NewLayoutInfo
{
pub
parent_pipeline_id
:
PipelineId
pub
new_pipeline_id
:
PipelineId
pub
frame_id
:
FrameId
pub
frame_type
:
FrameType
pub
load_data
:
LoadData
pub
pipeline_port
:
IpcReceiver
<
LayoutControlMsg
>
pub
layout_to_constellation_chan
:
IpcSender
<
LayoutMsg
>
pub
content_process_shutdown_chan
:
IpcSender
<
(
)
>
pub
layout_threads
:
usize
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
ConstellationControlMsg
{
AttachLayout
(
NewLayoutInfo
)
Resize
(
PipelineId
WindowSizeData
WindowSizeType
)
ResizeInactive
(
PipelineId
WindowSizeData
)
ExitPipeline
(
PipelineId
)
ExitScriptThread
SendEvent
(
PipelineId
CompositorEvent
)
Viewport
(
PipelineId
Rect
<
f32
>
)
SetScrollState
(
PipelineId
Vec
<
(
UntrustedNodeAddress
Point2D
<
f32
>
)
>
)
GetTitle
(
PipelineId
)
Freeze
(
PipelineId
)
Thaw
(
PipelineId
)
ChangeFrameVisibilityStatus
(
PipelineId
bool
)
NotifyVisibilityChange
(
PipelineId
FrameId
bool
)
Navigate
(
PipelineId
FrameId
LoadData
bool
)
MozBrowserEvent
(
PipelineId
Option
<
FrameId
>
MozBrowserEvent
)
UpdatePipelineId
(
PipelineId
FrameId
PipelineId
)
FocusIFrame
(
PipelineId
FrameId
)
WebDriverScriptCommand
(
PipelineId
WebDriverScriptCommand
)
TickAllAnimations
(
PipelineId
)
TransitionEnd
(
UnsafeNode
String
f64
)
WebFontLoaded
(
PipelineId
)
DispatchFrameLoadEvent
{
target
:
FrameId
parent
:
PipelineId
child
:
PipelineId
}
FramedContentChanged
(
PipelineId
FrameId
)
ReportCSSError
(
PipelineId
String
usize
usize
String
)
Reload
(
PipelineId
)
}
impl
fmt
:
:
Debug
for
ConstellationControlMsg
{
fn
fmt
(
&
self
formatter
:
&
mut
fmt
:
:
Formatter
)
-
>
fmt
:
:
Result
{
use
self
:
:
ConstellationControlMsg
:
:
*
;
write
!
(
formatter
"
ConstellationMsg
:
:
{
}
"
match
*
self
{
AttachLayout
(
.
.
)
=
>
"
AttachLayout
"
Resize
(
.
.
)
=
>
"
Resize
"
ResizeInactive
(
.
.
)
=
>
"
ResizeInactive
"
ExitPipeline
(
.
.
)
=
>
"
ExitPipeline
"
ExitScriptThread
=
>
"
ExitScriptThread
"
SendEvent
(
.
.
)
=
>
"
SendEvent
"
Viewport
(
.
.
)
=
>
"
Viewport
"
SetScrollState
(
.
.
)
=
>
"
SetScrollState
"
GetTitle
(
.
.
)
=
>
"
GetTitle
"
Freeze
(
.
.
)
=
>
"
Freeze
"
Thaw
(
.
.
)
=
>
"
Thaw
"
ChangeFrameVisibilityStatus
(
.
.
)
=
>
"
ChangeFrameVisibilityStatus
"
NotifyVisibilityChange
(
.
.
)
=
>
"
NotifyVisibilityChange
"
Navigate
(
.
.
)
=
>
"
Navigate
"
MozBrowserEvent
(
.
.
)
=
>
"
MozBrowserEvent
"
UpdatePipelineId
(
.
.
)
=
>
"
UpdatePipelineId
"
FocusIFrame
(
.
.
)
=
>
"
FocusIFrame
"
WebDriverScriptCommand
(
.
.
)
=
>
"
WebDriverScriptCommand
"
TickAllAnimations
(
.
.
)
=
>
"
TickAllAnimations
"
TransitionEnd
(
.
.
)
=
>
"
TransitionEnd
"
WebFontLoaded
(
.
.
)
=
>
"
WebFontLoaded
"
DispatchFrameLoadEvent
{
.
.
}
=
>
"
DispatchFrameLoadEvent
"
FramedContentChanged
(
.
.
)
=
>
"
FramedContentChanged
"
ReportCSSError
(
.
.
)
=
>
"
ReportCSSError
"
Reload
(
.
.
)
=
>
"
Reload
"
}
)
}
}
#
[
derive
(
Copy
Clone
Debug
PartialEq
Deserialize
Serialize
)
]
pub
enum
DocumentState
{
Idle
Pending
}
#
[
derive
(
Clone
Eq
PartialEq
Deserialize
Serialize
Debug
)
]
pub
enum
AnimationState
{
AnimationsPresent
AnimationCallbacksPresent
NoAnimationsPresent
NoAnimationCallbacksPresent
}
#
[
derive
(
Clone
Copy
Debug
Deserialize
Serialize
)
]
pub
enum
TouchEventType
{
Down
Move
Up
Cancel
}
#
[
derive
(
Clone
Copy
Debug
Eq
PartialEq
Deserialize
Serialize
)
]
pub
struct
TouchId
(
pub
i32
)
;
#
[
derive
(
Clone
Copy
Debug
Deserialize
Serialize
)
]
pub
enum
MouseButton
{
Left
Middle
Right
}
#
[
derive
(
Deserialize
HeapSizeOf
Serialize
)
]
pub
enum
MouseEventType
{
Click
MouseDown
MouseUp
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
CompositorEvent
{
ResizeEvent
(
WindowSizeData
WindowSizeType
)
MouseButtonEvent
(
MouseEventType
MouseButton
Point2D
<
f32
>
)
MouseMoveEvent
(
Option
<
Point2D
<
f32
>
>
)
TouchEvent
(
TouchEventType
TouchId
Point2D
<
f32
>
)
TouchpadPressureEvent
(
Point2D
<
f32
>
f32
TouchpadPressurePhase
)
KeyEvent
(
Option
<
char
>
Key
KeyState
KeyModifiers
)
}
#
[
derive
(
Copy
Clone
HeapSizeOf
PartialEq
Deserialize
Serialize
)
]
pub
enum
TouchpadPressurePhase
{
BeforeClick
AfterFirstClick
AfterSecondClick
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
struct
TimerEventRequest
(
pub
IpcSender
<
TimerEvent
>
pub
TimerSource
pub
TimerEventId
pub
MsDuration
)
;
#
[
derive
(
Deserialize
Serialize
)
]
pub
struct
TimerEvent
(
pub
TimerSource
pub
TimerEventId
)
;
#
[
derive
(
Copy
Clone
HeapSizeOf
Deserialize
Serialize
)
]
pub
enum
TimerSource
{
FromWindow
(
PipelineId
)
FromWorker
}
#
[
derive
(
PartialEq
Eq
Copy
Clone
Debug
HeapSizeOf
Deserialize
Serialize
)
]
pub
struct
TimerEventId
(
pub
u32
)
;
#
[
derive
(
Clone
Copy
HeapSizeOf
)
]
pub
enum
Milliseconds
{
}
#
[
derive
(
Clone
Copy
HeapSizeOf
)
]
pub
enum
Nanoseconds
{
}
pub
type
MsDuration
=
Length
<
u64
Milliseconds
>
;
pub
type
NsDuration
=
Length
<
u64
Nanoseconds
>
;
pub
fn
precise_time_ms
(
)
-
>
MsDuration
{
Length
:
:
new
(
time
:
:
precise_time_ns
(
)
/
(
1000
*
1000
)
)
}
pub
fn
precise_time_ns
(
)
-
>
NsDuration
{
Length
:
:
new
(
time
:
:
precise_time_ns
(
)
)
}
pub
struct
InitialScriptState
{
pub
id
:
PipelineId
pub
parent_info
:
Option
<
(
PipelineId
FrameType
)
>
pub
frame_id
:
FrameId
pub
control_chan
:
IpcSender
<
ConstellationControlMsg
>
pub
control_port
:
IpcReceiver
<
ConstellationControlMsg
>
pub
constellation_chan
:
IpcSender
<
ScriptMsg
>
pub
scheduler_chan
:
IpcSender
<
TimerEventRequest
>
pub
resource_threads
:
ResourceThreads
pub
bluetooth_thread
:
IpcSender
<
BluetoothRequest
>
pub
image_cache_thread
:
ImageCacheThread
pub
time_profiler_chan
:
profile_traits
:
:
time
:
:
ProfilerChan
pub
mem_profiler_chan
:
mem
:
:
ProfilerChan
pub
devtools_chan
:
Option
<
IpcSender
<
ScriptToDevtoolsControlMsg
>
>
pub
window_size
:
Option
<
WindowSizeData
>
pub
pipeline_namespace_id
:
PipelineNamespaceId
pub
content_process_shutdown_chan
:
IpcSender
<
(
)
>
}
pub
trait
ScriptThreadFactory
{
type
Message
;
fn
create
(
state
:
InitialScriptState
load_data
:
LoadData
)
-
>
(
Sender
<
Self
:
:
Message
>
Receiver
<
Self
:
:
Message
>
)
;
}
#
[
derive
(
PartialEq
Eq
Copy
Clone
Debug
Deserialize
Serialize
)
]
pub
enum
IFrameSandboxState
{
IFrameSandboxed
IFrameUnsandboxed
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
struct
IFrameLoadInfo
{
pub
load_data
:
Option
<
LoadData
>
pub
parent_pipeline_id
:
PipelineId
pub
frame_id
:
FrameId
pub
old_pipeline_id
:
Option
<
PipelineId
>
pub
new_pipeline_id
:
PipelineId
pub
sandbox
:
IFrameSandboxState
pub
is_private
:
bool
pub
frame_type
:
FrameType
pub
replace
:
bool
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
MozBrowserEvent
{
AsyncScroll
Close
ContextMenu
Error
(
MozBrowserErrorType
String
String
)
IconChange
(
String
String
String
)
Connected
LoadEnd
LoadStart
LocationChange
(
String
bool
bool
)
OpenTab
(
String
)
OpenWindow
(
String
Option
<
String
>
Option
<
String
>
)
SecurityChange
(
HttpsState
)
ShowModalPrompt
(
String
String
String
String
)
TitleChange
(
String
)
UsernameAndPasswordRequired
OpenSearch
VisibilityChange
(
bool
)
}
impl
MozBrowserEvent
{
pub
fn
name
(
&
self
)
-
>
&
'
static
str
{
match
*
self
{
MozBrowserEvent
:
:
AsyncScroll
=
>
"
mozbrowserasyncscroll
"
MozBrowserEvent
:
:
Close
=
>
"
mozbrowserclose
"
MozBrowserEvent
:
:
Connected
=
>
"
mozbrowserconnected
"
MozBrowserEvent
:
:
ContextMenu
=
>
"
mozbrowsercontextmenu
"
MozBrowserEvent
:
:
Error
(
_
_
_
)
=
>
"
mozbrowsererror
"
MozBrowserEvent
:
:
IconChange
(
_
_
_
)
=
>
"
mozbrowsericonchange
"
MozBrowserEvent
:
:
LoadEnd
=
>
"
mozbrowserloadend
"
MozBrowserEvent
:
:
LoadStart
=
>
"
mozbrowserloadstart
"
MozBrowserEvent
:
:
LocationChange
(
_
_
_
)
=
>
"
mozbrowserlocationchange
"
MozBrowserEvent
:
:
OpenTab
(
_
)
=
>
"
mozbrowseropentab
"
MozBrowserEvent
:
:
OpenWindow
(
_
_
_
)
=
>
"
mozbrowseropenwindow
"
MozBrowserEvent
:
:
SecurityChange
(
_
)
=
>
"
mozbrowsersecuritychange
"
MozBrowserEvent
:
:
ShowModalPrompt
(
_
_
_
_
)
=
>
"
mozbrowsershowmodalprompt
"
MozBrowserEvent
:
:
TitleChange
(
_
)
=
>
"
mozbrowsertitlechange
"
MozBrowserEvent
:
:
UsernameAndPasswordRequired
=
>
"
mozbrowserusernameandpasswordrequired
"
MozBrowserEvent
:
:
OpenSearch
=
>
"
mozbrowseropensearch
"
MozBrowserEvent
:
:
VisibilityChange
(
_
)
=
>
"
mozbrowservisibilitychange
"
}
}
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
MozBrowserErrorType
{
Fatal
}
impl
MozBrowserErrorType
{
pub
fn
name
(
&
self
)
-
>
&
'
static
str
{
match
*
self
{
MozBrowserErrorType
:
:
Fatal
=
>
"
fatal
"
}
}
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
AnimationTickType
{
Script
Layout
}
#
[
derive
(
Copy
Clone
Debug
Deserialize
Serialize
)
]
pub
struct
StackingContextScrollState
{
pub
scroll_root_id
:
ScrollRootId
pub
scroll_offset
:
Point2D
<
f32
>
}
#
[
derive
(
Copy
Clone
Deserialize
Serialize
HeapSizeOf
)
]
pub
struct
WindowSizeData
{
pub
initial_viewport
:
TypedSize2D
<
f32
ViewportPx
>
pub
visible_viewport
:
TypedSize2D
<
f32
PagePx
>
pub
device_pixel_ratio
:
ScaleFactor
<
f32
ViewportPx
DevicePixel
>
}
#
[
derive
(
Deserialize
Eq
PartialEq
Serialize
Copy
Clone
HeapSizeOf
)
]
pub
enum
WindowSizeType
{
Initial
Resize
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
WebDriverCommandMsg
{
GetWindowSize
(
PipelineId
IpcSender
<
WindowSizeData
>
)
LoadUrl
(
PipelineId
LoadData
IpcSender
<
LoadStatus
>
)
Refresh
(
PipelineId
IpcSender
<
LoadStatus
>
)
ScriptCommand
(
PipelineId
WebDriverScriptCommand
)
SendKeys
(
PipelineId
Vec
<
(
Key
KeyModifiers
KeyState
)
>
)
SetWindowSize
(
PipelineId
Size2D
<
u32
>
IpcSender
<
WindowSizeData
>
)
TakeScreenshot
(
PipelineId
IpcSender
<
Option
<
Image
>
>
)
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
ConstellationMsg
{
Exit
FrameSize
(
PipelineId
Size2D
<
f32
>
)
GetFrame
(
PipelineId
IpcSender
<
Option
<
FrameId
>
>
)
GetPipeline
(
Option
<
FrameId
>
IpcSender
<
Option
<
(
PipelineId
bool
)
>
>
)
GetPipelineTitle
(
PipelineId
)
InitLoadUrl
(
Url
)
IsReadyToSaveImage
(
HashMap
<
PipelineId
Epoch
>
)
KeyEvent
(
Option
<
char
>
Key
KeyState
KeyModifiers
)
LoadUrl
(
PipelineId
LoadData
)
TraverseHistory
(
Option
<
PipelineId
>
TraversalDirection
)
WindowSize
(
WindowSizeData
WindowSizeType
)
TickAnimation
(
PipelineId
AnimationTickType
)
WebDriverCommand
(
WebDriverCommandMsg
)
Reload
LogEntry
(
Option
<
PipelineId
>
Option
<
String
>
LogEntry
)
}
#
[
derive
(
Serialize
Deserialize
Clone
)
]
pub
struct
WorkerGlobalScopeInit
{
pub
resource_threads
:
ResourceThreads
pub
mem_profiler_chan
:
mem
:
:
ProfilerChan
pub
time_profiler_chan
:
profile_time
:
:
ProfilerChan
pub
to_devtools_sender
:
Option
<
IpcSender
<
ScriptToDevtoolsControlMsg
>
>
pub
from_devtools_sender
:
Option
<
IpcSender
<
DevtoolScriptControlMsg
>
>
pub
constellation_chan
:
IpcSender
<
ScriptMsg
>
pub
scheduler_chan
:
IpcSender
<
TimerEventRequest
>
pub
worker_id
:
WorkerId
pub
pipeline_id
:
PipelineId
}
#
[
derive
(
Deserialize
Serialize
Clone
)
]
pub
struct
WorkerScriptLoadOrigin
{
pub
referrer_url
:
Option
<
Url
>
pub
referrer_policy
:
Option
<
ReferrerPolicy
>
pub
pipeline_id
:
Option
<
PipelineId
>
}
