#
!
[
deny
(
missing_docs
)
]
use
ipc_channel
:
:
ipc
:
:
{
self
IpcSender
}
;
use
ipc_channel
:
:
router
:
:
ROUTER
;
use
std
:
:
marker
:
:
Send
;
use
std
:
:
sync
:
:
mpsc
:
:
Sender
;
pub
trait
OpaqueSender
<
T
>
{
fn
send
(
&
self
message
:
T
)
;
}
impl
<
T
>
OpaqueSender
<
T
>
for
Sender
<
T
>
{
fn
send
(
&
self
message
:
T
)
{
if
let
Err
(
e
)
=
Sender
:
:
send
(
self
message
)
{
warn
!
(
"
Error
communicating
with
the
target
thread
from
the
profiler
:
{
}
"
e
)
;
}
}
}
#
[
derive
(
Clone
Deserialize
Serialize
)
]
pub
struct
ProfilerChan
(
pub
IpcSender
<
ProfilerMsg
>
)
;
impl
ProfilerChan
{
pub
fn
send
(
&
self
msg
:
ProfilerMsg
)
{
if
let
Err
(
e
)
=
self
.
0
.
send
(
msg
)
{
warn
!
(
"
Error
communicating
with
the
memory
profiler
thread
:
{
}
"
e
)
;
}
}
pub
fn
run_with_memory_reporting
<
F
M
T
C
>
(
&
self
f
:
F
reporter_name
:
String
channel_for_reporter
:
C
msg
:
M
)
where
F
:
FnOnce
(
)
M
:
Fn
(
ReportsChan
)
-
>
T
+
Send
+
'
static
T
:
Send
+
'
static
C
:
OpaqueSender
<
T
>
+
Send
+
'
static
{
let
(
reporter_sender
reporter_receiver
)
=
ipc
:
:
channel
(
)
.
unwrap
(
)
;
ROUTER
.
add_route
(
reporter_receiver
.
to_opaque
(
)
Box
:
:
new
(
move
|
message
|
{
let
request
:
ReporterRequest
=
message
.
to
(
)
.
unwrap
(
)
;
channel_for_reporter
.
send
(
msg
(
request
.
reports_channel
)
)
;
}
)
)
;
self
.
send
(
ProfilerMsg
:
:
RegisterReporter
(
reporter_name
.
clone
(
)
Reporter
(
reporter_sender
)
)
)
;
f
(
)
;
self
.
send
(
ProfilerMsg
:
:
UnregisterReporter
(
reporter_name
)
)
;
}
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
ReportKind
{
ExplicitJemallocHeapSize
ExplicitSystemHeapSize
ExplicitNonHeapSize
ExplicitUnknownLocationSize
NonExplicitSize
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
struct
Report
{
pub
path
:
Vec
<
String
>
pub
kind
:
ReportKind
pub
size
:
usize
}
#
[
derive
(
Clone
Deserialize
Serialize
)
]
pub
struct
ReportsChan
(
pub
IpcSender
<
Vec
<
Report
>
>
)
;
impl
ReportsChan
{
pub
fn
send
(
&
self
report
:
Vec
<
Report
>
)
{
self
.
0
.
send
(
report
)
.
unwrap
(
)
;
}
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
struct
ReporterRequest
{
pub
reports_channel
:
ReportsChan
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
struct
Reporter
(
pub
IpcSender
<
ReporterRequest
>
)
;
impl
Reporter
{
pub
fn
collect_reports
(
&
self
reports_chan
:
ReportsChan
)
{
self
.
0
.
send
(
ReporterRequest
{
reports_channel
:
reports_chan
}
)
.
unwrap
(
)
}
}
#
[
macro_export
]
macro_rules
!
path
{
(
(
x
:
expr
)
*
)
=
>
{
{
use
std
:
:
borrow
:
:
ToOwned
;
vec
!
[
(
x
.
to_owned
(
)
)
*
]
}
}
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
ProfilerMsg
{
RegisterReporter
(
String
Reporter
)
UnregisterReporter
(
String
)
Print
Exit
}
