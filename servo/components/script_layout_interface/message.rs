use
{
OpaqueStyleAndLayoutData
PendingImage
TrustedNodeAddress
}
;
use
app_units
:
:
Au
;
use
euclid
:
:
{
Point2D
Rect
}
;
use
gfx_traits
:
:
Epoch
;
use
ipc_channel
:
:
ipc
:
:
{
IpcReceiver
IpcSender
}
;
use
metrics
:
:
PaintTimeMetrics
;
use
msg
:
:
constellation_msg
:
:
PipelineId
;
use
net_traits
:
:
image_cache
:
:
ImageCache
;
use
profile_traits
:
:
mem
:
:
ReportsChan
;
use
rpc
:
:
LayoutRPC
;
use
script_traits
:
:
{
ConstellationControlMsg
LayoutControlMsg
LayoutMsg
as
ConstellationMsg
}
;
use
script_traits
:
:
{
ScrollState
UntrustedNodeAddress
WindowSizeData
}
;
use
script_traits
:
:
Painter
;
use
servo_arc
:
:
Arc
as
ServoArc
;
use
servo_atoms
:
:
Atom
;
use
servo_url
:
:
ServoUrl
;
use
std
:
:
sync
:
:
Arc
;
use
std
:
:
sync
:
:
mpsc
:
:
{
Receiver
Sender
}
;
use
style
:
:
context
:
:
QuirksMode
;
use
style
:
:
properties
:
:
PropertyId
;
use
style
:
:
selector_parser
:
:
PseudoElement
;
use
style
:
:
stylesheets
:
:
Stylesheet
;
pub
enum
Msg
{
AddStylesheet
(
ServoArc
<
Stylesheet
>
Option
<
ServoArc
<
Stylesheet
>
>
)
RemoveStylesheet
(
ServoArc
<
Stylesheet
>
)
SetQuirksMode
(
QuirksMode
)
Reflow
(
ScriptReflow
)
GetRPC
(
Sender
<
Box
<
LayoutRPC
+
Send
>
>
)
TickAnimations
AdvanceClockMs
(
i32
bool
)
ReapStyleAndLayoutData
(
OpaqueStyleAndLayoutData
)
CollectReports
(
ReportsChan
)
PrepareToExit
(
Sender
<
(
)
>
)
ExitNow
GetCurrentEpoch
(
IpcSender
<
Epoch
>
)
GetWebFontLoadState
(
IpcSender
<
bool
>
)
CreateLayoutThread
(
NewLayoutThreadInfo
)
SetFinalUrl
(
ServoUrl
)
SetScrollStates
(
Vec
<
ScrollState
>
)
UpdateScrollStateFromScript
(
ScrollState
)
RegisterPaint
(
Atom
Vec
<
Atom
>
Box
<
Painter
>
)
SetNavigationStart
(
u64
)
}
#
[
derive
(
Debug
PartialEq
)
]
pub
enum
NodesFromPointQueryType
{
All
Topmost
}
#
[
derive
(
Debug
PartialEq
)
]
pub
enum
QueryMsg
{
ContentBoxQuery
(
TrustedNodeAddress
)
ContentBoxesQuery
(
TrustedNodeAddress
)
NodeScrollIdQuery
(
TrustedNodeAddress
)
NodeGeometryQuery
(
TrustedNodeAddress
)
NodeScrollGeometryQuery
(
TrustedNodeAddress
)
ResolvedStyleQuery
(
TrustedNodeAddress
Option
<
PseudoElement
>
PropertyId
)
OffsetParentQuery
(
TrustedNodeAddress
)
StyleQuery
(
TrustedNodeAddress
)
TextIndexQuery
(
TrustedNodeAddress
Point2D
<
f32
>
)
NodesFromPointQuery
(
Point2D
<
f32
>
NodesFromPointQueryType
)
ElementInnerTextQuery
(
TrustedNodeAddress
)
}
#
[
derive
(
Debug
PartialEq
)
]
pub
enum
ReflowGoal
{
Full
TickAnimations
LayoutQuery
(
QueryMsg
u64
)
}
impl
ReflowGoal
{
pub
fn
needs_display_list
(
&
self
)
-
>
bool
{
match
*
self
{
ReflowGoal
:
:
Full
|
ReflowGoal
:
:
TickAnimations
=
>
true
ReflowGoal
:
:
LayoutQuery
(
ref
querymsg
_
)
=
>
match
querymsg
{
&
QueryMsg
:
:
NodesFromPointQuery
(
.
.
)
|
&
QueryMsg
:
:
TextIndexQuery
(
.
.
)
|
&
QueryMsg
:
:
ElementInnerTextQuery
(
_
)
=
>
true
&
QueryMsg
:
:
ContentBoxQuery
(
_
)
|
&
QueryMsg
:
:
ContentBoxesQuery
(
_
)
|
&
QueryMsg
:
:
NodeGeometryQuery
(
_
)
|
&
QueryMsg
:
:
NodeScrollGeometryQuery
(
_
)
|
&
QueryMsg
:
:
NodeScrollIdQuery
(
_
)
|
&
QueryMsg
:
:
ResolvedStyleQuery
(
.
.
)
|
&
QueryMsg
:
:
OffsetParentQuery
(
_
)
|
&
QueryMsg
:
:
StyleQuery
(
_
)
=
>
false
}
}
}
pub
fn
needs_display
(
&
self
)
-
>
bool
{
match
*
self
{
ReflowGoal
:
:
Full
|
ReflowGoal
:
:
TickAnimations
=
>
true
ReflowGoal
:
:
LayoutQuery
(
ref
querymsg
_
)
=
>
match
querymsg
{
&
QueryMsg
:
:
NodesFromPointQuery
(
.
.
)
|
&
QueryMsg
:
:
TextIndexQuery
(
.
.
)
|
&
QueryMsg
:
:
ElementInnerTextQuery
(
_
)
=
>
true
&
QueryMsg
:
:
ContentBoxQuery
(
_
)
|
&
QueryMsg
:
:
ContentBoxesQuery
(
_
)
|
&
QueryMsg
:
:
NodeGeometryQuery
(
_
)
|
&
QueryMsg
:
:
NodeScrollGeometryQuery
(
_
)
|
&
QueryMsg
:
:
NodeScrollIdQuery
(
_
)
|
&
QueryMsg
:
:
ResolvedStyleQuery
(
.
.
)
|
&
QueryMsg
:
:
OffsetParentQuery
(
_
)
|
&
QueryMsg
:
:
StyleQuery
(
_
)
=
>
false
}
}
}
}
pub
struct
Reflow
{
pub
page_clip_rect
:
Rect
<
Au
>
}
#
[
derive
(
Default
)
]
pub
struct
ReflowComplete
{
pub
pending_images
:
Vec
<
PendingImage
>
pub
newly_transitioning_nodes
:
Vec
<
UntrustedNodeAddress
>
}
pub
struct
ScriptReflow
{
pub
reflow_info
:
Reflow
pub
document
:
TrustedNodeAddress
pub
stylesheets_changed
:
bool
pub
window_size
:
WindowSizeData
pub
script_join_chan
:
Sender
<
ReflowComplete
>
pub
reflow_goal
:
ReflowGoal
pub
dom_count
:
u32
}
pub
struct
NewLayoutThreadInfo
{
pub
id
:
PipelineId
pub
url
:
ServoUrl
pub
is_parent
:
bool
pub
layout_pair
:
(
Sender
<
Msg
>
Receiver
<
Msg
>
)
pub
pipeline_port
:
IpcReceiver
<
LayoutControlMsg
>
pub
constellation_chan
:
IpcSender
<
ConstellationMsg
>
pub
script_chan
:
IpcSender
<
ConstellationControlMsg
>
pub
image_cache
:
Arc
<
ImageCache
>
pub
content_process_shutdown_chan
:
Option
<
IpcSender
<
(
)
>
>
pub
layout_threads
:
usize
pub
paint_time_metrics
:
PaintTimeMetrics
}
