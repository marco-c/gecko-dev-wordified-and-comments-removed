use
SendableFrameTree
;
use
compositor
:
:
CompositingReason
;
use
euclid
:
:
{
Point2D
Size2D
}
;
use
ipc_channel
:
:
ipc
:
:
IpcSender
;
use
msg
:
:
constellation_msg
:
:
{
Key
KeyModifiers
KeyState
PipelineId
}
;
use
net_traits
:
:
image
:
:
base
:
:
Image
;
use
profile_traits
:
:
mem
;
use
profile_traits
:
:
time
;
use
script_traits
:
:
{
AnimationState
ConstellationMsg
EventResult
LoadData
}
;
use
servo_url
:
:
ServoUrl
;
use
std
:
:
fmt
:
:
{
Debug
Error
Formatter
}
;
use
std
:
:
sync
:
:
mpsc
:
:
{
Receiver
Sender
}
;
use
style_traits
:
:
cursor
:
:
Cursor
;
use
style_traits
:
:
viewport
:
:
ViewportConstraints
;
use
webrender
;
use
webrender_api
;
pub
trait
EventLoopWaker
:
'
static
+
Send
{
fn
clone
(
&
self
)
-
>
Box
<
EventLoopWaker
+
Send
>
;
fn
wake
(
&
self
)
;
}
pub
struct
CompositorProxy
{
pub
sender
:
Sender
<
Msg
>
pub
event_loop_waker
:
Box
<
EventLoopWaker
>
}
impl
CompositorProxy
{
pub
fn
send
(
&
self
msg
:
Msg
)
{
if
let
Err
(
err
)
=
self
.
sender
.
send
(
msg
)
{
warn
!
(
"
Failed
to
send
response
(
{
}
)
.
"
err
)
;
}
self
.
event_loop_waker
.
wake
(
)
;
}
pub
fn
clone_compositor_proxy
(
&
self
)
-
>
CompositorProxy
{
CompositorProxy
{
sender
:
self
.
sender
.
clone
(
)
event_loop_waker
:
self
.
event_loop_waker
.
clone
(
)
}
}
}
pub
struct
CompositorReceiver
{
pub
receiver
:
Receiver
<
Msg
>
}
impl
CompositorReceiver
{
pub
fn
try_recv_compositor_msg
(
&
mut
self
)
-
>
Option
<
Msg
>
{
self
.
receiver
.
try_recv
(
)
.
ok
(
)
}
pub
fn
recv_compositor_msg
(
&
mut
self
)
-
>
Msg
{
self
.
receiver
.
recv
(
)
.
unwrap
(
)
}
}
pub
trait
RenderListener
{
fn
recomposite
(
&
mut
self
reason
:
CompositingReason
)
;
}
impl
RenderListener
for
CompositorProxy
{
fn
recomposite
(
&
mut
self
reason
:
CompositingReason
)
{
self
.
send
(
Msg
:
:
Recomposite
(
reason
)
)
;
}
}
pub
enum
Msg
{
Exit
ShutdownComplete
ScrollFragmentPoint
(
webrender_api
:
:
ClipId
Point2D
<
f32
>
bool
)
ChangePageTitle
(
PipelineId
Option
<
String
>
)
ChangeRunningAnimationsState
(
PipelineId
AnimationState
)
SetFrameTree
(
SendableFrameTree
)
LoadStart
LoadComplete
HistoryChanged
(
Vec
<
LoadData
>
usize
)
AllowNavigation
(
ServoUrl
IpcSender
<
bool
>
)
Recomposite
(
CompositingReason
)
KeyEvent
(
Option
<
char
>
Key
KeyState
KeyModifiers
)
TouchEventProcessed
(
EventResult
)
SetCursor
(
Cursor
)
CreatePng
(
IpcSender
<
Option
<
Image
>
>
)
ViewportConstrained
(
PipelineId
ViewportConstraints
)
IsReadyToSaveImageReply
(
bool
)
NewFavicon
(
ServoUrl
)
HeadParsed
Status
(
Option
<
String
>
)
GetClientWindow
(
IpcSender
<
(
Size2D
<
u32
>
Point2D
<
i32
>
)
>
)
MoveTo
(
Point2D
<
i32
>
)
ResizeTo
(
Size2D
<
u32
>
)
PipelineVisibilityChanged
(
PipelineId
bool
)
NewScrollFrameReady
(
bool
)
PipelineExited
(
PipelineId
IpcSender
<
(
)
>
)
Dispatch
(
Box
<
Fn
(
)
+
Send
>
)
SetFullscreenState
(
bool
)
}
impl
Debug
for
Msg
{
fn
fmt
(
&
self
f
:
&
mut
Formatter
)
-
>
Result
<
(
)
Error
>
{
match
*
self
{
Msg
:
:
Exit
=
>
write
!
(
f
"
Exit
"
)
Msg
:
:
ShutdownComplete
=
>
write
!
(
f
"
ShutdownComplete
"
)
Msg
:
:
ScrollFragmentPoint
(
.
.
)
=
>
write
!
(
f
"
ScrollFragmentPoint
"
)
Msg
:
:
ChangeRunningAnimationsState
(
.
.
)
=
>
write
!
(
f
"
ChangeRunningAnimationsState
"
)
Msg
:
:
ChangePageTitle
(
.
.
)
=
>
write
!
(
f
"
ChangePageTitle
"
)
Msg
:
:
SetFrameTree
(
.
.
)
=
>
write
!
(
f
"
SetFrameTree
"
)
Msg
:
:
LoadComplete
=
>
write
!
(
f
"
LoadComplete
"
)
Msg
:
:
AllowNavigation
(
.
.
)
=
>
write
!
(
f
"
AllowNavigation
"
)
Msg
:
:
LoadStart
=
>
write
!
(
f
"
LoadStart
"
)
Msg
:
:
HistoryChanged
(
.
.
)
=
>
write
!
(
f
"
HistoryChanged
"
)
Msg
:
:
Recomposite
(
.
.
)
=
>
write
!
(
f
"
Recomposite
"
)
Msg
:
:
KeyEvent
(
.
.
)
=
>
write
!
(
f
"
KeyEvent
"
)
Msg
:
:
TouchEventProcessed
(
.
.
)
=
>
write
!
(
f
"
TouchEventProcessed
"
)
Msg
:
:
SetCursor
(
.
.
)
=
>
write
!
(
f
"
SetCursor
"
)
Msg
:
:
CreatePng
(
.
.
)
=
>
write
!
(
f
"
CreatePng
"
)
Msg
:
:
ViewportConstrained
(
.
.
)
=
>
write
!
(
f
"
ViewportConstrained
"
)
Msg
:
:
IsReadyToSaveImageReply
(
.
.
)
=
>
write
!
(
f
"
IsReadyToSaveImageReply
"
)
Msg
:
:
NewFavicon
(
.
.
)
=
>
write
!
(
f
"
NewFavicon
"
)
Msg
:
:
HeadParsed
=
>
write
!
(
f
"
HeadParsed
"
)
Msg
:
:
Status
(
.
.
)
=
>
write
!
(
f
"
Status
"
)
Msg
:
:
GetClientWindow
(
.
.
)
=
>
write
!
(
f
"
GetClientWindow
"
)
Msg
:
:
MoveTo
(
.
.
)
=
>
write
!
(
f
"
MoveTo
"
)
Msg
:
:
ResizeTo
(
.
.
)
=
>
write
!
(
f
"
ResizeTo
"
)
Msg
:
:
PipelineVisibilityChanged
(
.
.
)
=
>
write
!
(
f
"
PipelineVisibilityChanged
"
)
Msg
:
:
PipelineExited
(
.
.
)
=
>
write
!
(
f
"
PipelineExited
"
)
Msg
:
:
NewScrollFrameReady
(
.
.
)
=
>
write
!
(
f
"
NewScrollFrameReady
"
)
Msg
:
:
Dispatch
(
.
.
)
=
>
write
!
(
f
"
Dispatch
"
)
Msg
:
:
SetFullscreenState
(
.
.
)
=
>
write
!
(
f
"
SetFullscreenState
"
)
}
}
}
pub
struct
InitialCompositorState
{
pub
sender
:
CompositorProxy
pub
receiver
:
CompositorReceiver
pub
constellation_chan
:
Sender
<
ConstellationMsg
>
pub
time_profiler_chan
:
time
:
:
ProfilerChan
pub
mem_profiler_chan
:
mem
:
:
ProfilerChan
pub
webrender
:
webrender
:
:
Renderer
pub
webrender_api_sender
:
webrender_api
:
:
RenderApiSender
}
