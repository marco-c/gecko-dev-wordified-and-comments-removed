use
azure
:
:
azure_hl
:
:
Color
;
use
constellation_msg
:
:
{
Key
KeyState
KeyModifiers
}
;
use
euclid
:
:
point
:
:
Point2D
;
use
euclid
:
:
rect
:
:
Rect
;
use
euclid
:
:
Matrix4
;
use
ipc_channel
:
:
ipc
:
:
IpcSender
;
use
layers
:
:
platform
:
:
surface
:
:
NativeDisplay
;
use
layers
:
:
layers
:
:
{
BufferRequest
LayerBufferSet
}
;
use
std
:
:
fmt
:
:
{
Formatter
Debug
}
;
use
std
:
:
fmt
;
use
constellation_msg
:
:
PipelineId
;
#
[
derive
(
PartialEq
Eq
Debug
Copy
Clone
PartialOrd
Ord
Deserialize
Serialize
)
]
pub
struct
Epoch
(
pub
u32
)
;
impl
Epoch
{
pub
fn
next
(
&
mut
self
)
{
let
Epoch
(
ref
mut
u
)
=
*
self
;
*
u
+
=
1
;
}
}
#
[
derive
(
PartialEq
Eq
Debug
Copy
Clone
)
]
pub
struct
FrameTreeId
(
pub
u32
)
;
impl
FrameTreeId
{
pub
fn
next
(
&
mut
self
)
{
let
FrameTreeId
(
ref
mut
u
)
=
*
self
;
*
u
+
=
1
;
}
}
#
[
derive
(
Clone
PartialEq
Eq
Copy
Hash
Deserialize
Serialize
)
]
pub
struct
LayerId
(
pub
usize
pub
u32
)
;
impl
Debug
for
LayerId
{
fn
fmt
(
&
self
f
:
&
mut
Formatter
)
-
>
fmt
:
:
Result
{
let
LayerId
(
a
b
)
=
*
self
;
write
!
(
f
"
Layer
(
{
}
{
}
)
"
a
b
)
}
}
impl
LayerId
{
pub
fn
null
(
)
-
>
LayerId
{
LayerId
(
0
0
)
}
}
#
[
derive
(
Clone
Copy
Debug
PartialEq
)
]
pub
enum
LayerKind
{
Layer2D
Layer3D
}
#
[
derive
(
Clone
PartialEq
Eq
Copy
Deserialize
Serialize
)
]
pub
enum
ScrollPolicy
{
Scrollable
FixedPosition
}
#
[
derive
(
Copy
Clone
)
]
pub
struct
LayerProperties
{
pub
id
:
LayerId
pub
parent_id
:
Option
<
LayerId
>
pub
rect
:
Rect
<
f32
>
pub
background_color
:
Color
pub
scroll_policy
:
ScrollPolicy
pub
transform
:
Matrix4
pub
perspective
:
Matrix4
pub
establishes_3d_context
:
bool
}
pub
trait
PaintListener
{
fn
native_display
(
&
mut
self
)
-
>
Option
<
NativeDisplay
>
;
fn
initialize_layers_for_pipeline
(
&
mut
self
pipeline_id
:
PipelineId
properties
:
Vec
<
LayerProperties
>
epoch
:
Epoch
)
;
fn
assign_painted_buffers
(
&
mut
self
pipeline_id
:
PipelineId
epoch
:
Epoch
replies
:
Vec
<
(
LayerId
Box
<
LayerBufferSet
>
)
>
frame_tree_id
:
FrameTreeId
)
;
fn
ignore_buffer_requests
(
&
mut
self
buffer_requests
:
Vec
<
BufferRequest
>
)
;
fn
notify_paint_task_exiting
(
&
mut
self
pipeline_id
:
PipelineId
)
;
}
#
[
derive
(
Deserialize
Serialize
)
]
pub
enum
ScriptToCompositorMsg
{
ScrollFragmentPoint
(
PipelineId
LayerId
Point2D
<
f32
>
)
SetTitle
(
PipelineId
Option
<
String
>
)
SendKeyEvent
(
Key
KeyState
KeyModifiers
)
Exit
}
#
[
derive
(
Clone
)
]
pub
struct
ScriptListener
(
IpcSender
<
ScriptToCompositorMsg
>
)
;
impl
ScriptListener
{
pub
fn
new
(
sender
:
IpcSender
<
ScriptToCompositorMsg
>
)
-
>
ScriptListener
{
ScriptListener
(
sender
)
}
pub
fn
scroll_fragment_point
(
&
mut
self
pipeline_id
:
PipelineId
layer_id
:
LayerId
point
:
Point2D
<
f32
>
)
{
self
.
0
.
send
(
ScriptToCompositorMsg
:
:
ScrollFragmentPoint
(
pipeline_id
layer_id
point
)
)
.
unwrap
(
)
}
pub
fn
close
(
&
mut
self
)
{
self
.
0
.
send
(
ScriptToCompositorMsg
:
:
Exit
)
.
unwrap
(
)
}
pub
fn
dup
(
&
mut
self
)
-
>
ScriptListener
{
self
.
clone
(
)
}
pub
fn
set_title
(
&
mut
self
pipeline_id
:
PipelineId
title
:
Option
<
String
>
)
{
self
.
0
.
send
(
ScriptToCompositorMsg
:
:
SetTitle
(
pipeline_id
title
)
)
.
unwrap
(
)
}
pub
fn
send_key_event
(
&
mut
self
key
:
Key
state
:
KeyState
modifiers
:
KeyModifiers
)
{
self
.
0
.
send
(
ScriptToCompositorMsg
:
:
SendKeyEvent
(
key
state
modifiers
)
)
.
unwrap
(
)
}
}
