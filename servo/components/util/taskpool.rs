use
task
:
:
spawn_named
;
use
std
:
:
sync
:
:
{
Arc
Mutex
}
;
pub
struct
TaskPool
{
tx
:
Sender
<
proc
(
)
:
Send
>
}
impl
TaskPool
{
pub
fn
new
(
tasks
:
uint
)
-
>
TaskPool
{
assert
!
(
tasks
>
0
)
;
let
(
tx
rx
)
=
channel
(
)
;
let
state
=
Arc
:
:
new
(
Mutex
:
:
new
(
rx
)
)
;
for
i
in
range
(
0
tasks
)
{
let
state
=
state
.
clone
(
)
;
spawn_named
(
format
!
(
"
TaskPoolWorker
{
}
/
{
}
"
i
+
1
tasks
)
proc
(
)
worker
(
&
*
state
)
)
;
}
return
TaskPool
{
tx
:
tx
}
;
fn
worker
(
rx
:
&
Mutex
<
Receiver
<
proc
(
)
:
Send
>
>
)
{
loop
{
let
job
=
rx
.
lock
(
)
.
recv_opt
(
)
;
match
job
{
Ok
(
job
)
=
>
job
(
)
Err
(
.
.
)
=
>
break
}
}
}
}
pub
fn
execute
(
&
self
job
:
proc
(
)
:
Send
)
{
self
.
tx
.
send
(
job
)
;
}
}
