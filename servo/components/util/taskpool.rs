use
std
:
:
boxed
:
:
FnBox
;
use
std
:
:
sync
:
:
mpsc
:
:
{
Receiver
Sender
channel
}
;
use
std
:
:
sync
:
:
{
Arc
Mutex
}
;
use
task
:
:
spawn_named
;
pub
struct
TaskPool
{
tx
:
Sender
<
Box
<
FnBox
(
)
+
Send
+
'
static
>
>
}
impl
TaskPool
{
pub
fn
new
(
tasks
:
u32
)
-
>
TaskPool
{
assert
!
(
tasks
>
0
)
;
let
(
tx
rx
)
=
channel
(
)
;
let
state
=
Arc
:
:
new
(
Mutex
:
:
new
(
rx
)
)
;
for
i
in
0
.
.
tasks
{
let
state
=
state
.
clone
(
)
;
spawn_named
(
format
!
(
"
TaskPoolWorker
{
}
/
{
}
"
i
+
1
tasks
)
move
|
|
worker
(
&
*
state
)
)
;
}
return
TaskPool
{
tx
:
tx
}
;
fn
worker
(
rx
:
&
Mutex
<
Receiver
<
Box
<
FnBox
(
)
+
Send
+
'
static
>
>
>
)
{
loop
{
let
job
=
rx
.
lock
(
)
.
unwrap
(
)
.
recv
(
)
;
match
job
{
Ok
(
job
)
=
>
job
.
call_box
(
(
)
)
Err
(
.
.
)
=
>
break
}
}
}
}
pub
fn
execute
<
F
>
(
&
self
job
:
F
)
where
F
:
FnOnce
(
)
+
Send
+
'
static
{
self
.
tx
.
send
(
Box
:
:
new
(
job
)
)
.
unwrap
(
)
;
}
}
