use
actor
:
:
{
Actor
ActorRegistry
}
;
use
actors
:
:
console
:
:
ConsoleActor
;
use
devtools_traits
:
:
DevtoolScriptControlMsg
:
:
WantsLiveNotifications
;
use
protocol
:
:
JsonPacketStream
;
use
serialize
:
:
json
;
use
std
:
:
old_io
:
:
TcpStream
;
#
[
derive
(
RustcEncodable
)
]
struct
TabTraits
;
#
[
derive
(
RustcEncodable
)
]
struct
TabAttachedReply
{
from
:
String
__type__
:
String
threadActor
:
String
cacheDisabled
:
bool
javascriptEnabled
:
bool
traits
:
TabTraits
}
#
[
derive
(
RustcEncodable
)
]
struct
TabDetachedReply
{
from
:
String
__type__
:
String
}
#
[
derive
(
RustcEncodable
)
]
struct
ReconfigureReply
{
from
:
String
}
#
[
derive
(
RustcEncodable
)
]
struct
ListFramesReply
{
from
:
String
frames
:
Vec
<
FrameMsg
>
}
#
[
derive
(
RustcEncodable
)
]
struct
FrameMsg
{
id
:
uint
url
:
String
title
:
String
parentID
:
uint
}
#
[
derive
(
RustcEncodable
)
]
pub
struct
TabActorMsg
{
actor
:
String
title
:
String
url
:
String
outerWindowID
:
uint
consoleActor
:
String
inspectorActor
:
String
}
pub
struct
TabActor
{
pub
name
:
String
pub
title
:
String
pub
url
:
String
pub
console
:
String
pub
inspector
:
String
}
impl
Actor
for
TabActor
{
fn
name
(
&
self
)
-
>
String
{
self
.
name
.
clone
(
)
}
fn
handle_message
(
&
self
registry
:
&
ActorRegistry
msg_type
:
&
String
_msg
:
&
json
:
:
Object
stream
:
&
mut
TcpStream
)
-
>
Result
<
bool
(
)
>
{
Ok
(
match
msg_type
.
as_slice
(
)
{
"
reconfigure
"
=
>
{
stream
.
write_json_packet
(
&
ReconfigureReply
{
from
:
self
.
name
(
)
}
)
;
true
}
"
attach
"
=
>
{
let
msg
=
TabAttachedReply
{
from
:
self
.
name
(
)
__type__
:
"
tabAttached
"
.
to_string
(
)
threadActor
:
self
.
name
(
)
cacheDisabled
:
false
javascriptEnabled
:
true
traits
:
TabTraits
}
;
let
console_actor
=
registry
.
find
:
:
<
ConsoleActor
>
(
self
.
console
.
as_slice
(
)
)
;
console_actor
.
streams
.
borrow_mut
(
)
.
push
(
stream
.
clone
(
)
)
;
stream
.
write_json_packet
(
&
msg
)
;
console_actor
.
script_chan
.
send
(
WantsLiveNotifications
(
console_actor
.
pipeline
true
)
)
.
unwrap
(
)
;
true
}
"
detach
"
=
>
{
let
msg
=
TabDetachedReply
{
from
:
self
.
name
(
)
__type__
:
"
detached
"
.
to_string
(
)
}
;
let
console_actor
=
registry
.
find
:
:
<
ConsoleActor
>
(
self
.
console
.
as_slice
(
)
)
;
console_actor
.
streams
.
borrow_mut
(
)
.
pop
(
)
;
stream
.
write_json_packet
(
&
msg
)
;
console_actor
.
script_chan
.
send
(
WantsLiveNotifications
(
console_actor
.
pipeline
false
)
)
.
unwrap
(
)
;
true
}
"
listFrames
"
=
>
{
let
msg
=
ListFramesReply
{
from
:
self
.
name
(
)
frames
:
vec
!
(
)
}
;
stream
.
write_json_packet
(
&
msg
)
;
true
}
_
=
>
false
}
)
}
}
impl
TabActor
{
pub
fn
encodable
(
&
self
)
-
>
TabActorMsg
{
TabActorMsg
{
actor
:
self
.
name
(
)
title
:
self
.
title
.
clone
(
)
url
:
self
.
url
.
clone
(
)
outerWindowID
:
0
consoleActor
:
self
.
console
.
clone
(
)
inspectorActor
:
self
.
inspector
.
clone
(
)
}
}
}
