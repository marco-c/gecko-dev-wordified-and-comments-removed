use
animation
:
:
Animation
;
use
atomic_refcell
:
:
{
AtomicRef
AtomicRefCell
AtomicRefMut
}
;
use
dom
:
:
OpaqueNode
;
use
gecko_bindings
:
:
bindings
:
:
RawServoStyleSet
;
use
gecko_bindings
:
:
structs
:
:
RawGeckoPresContextOwned
;
use
gecko_bindings
:
:
sugar
:
:
ownership
:
:
{
HasBoxFFI
HasFFI
HasSimpleFFI
}
;
use
media_queries
:
:
Device
;
use
parking_lot
:
:
RwLock
;
use
properties
:
:
ComputedValues
;
use
std
:
:
collections
:
:
HashMap
;
use
std
:
:
sync
:
:
Arc
;
use
std
:
:
sync
:
:
mpsc
:
:
{
Receiver
Sender
channel
}
;
use
stylesheets
:
:
Stylesheet
;
use
stylist
:
:
Stylist
;
pub
struct
PerDocumentStyleDataImpl
{
pub
stylist
:
Arc
<
Stylist
>
pub
stylesheets
:
Vec
<
Arc
<
Stylesheet
>
>
pub
stylesheets_changed
:
bool
pub
new_animations_sender
:
Sender
<
Animation
>
pub
new_animations_receiver
:
Receiver
<
Animation
>
pub
running_animations
:
Arc
<
RwLock
<
HashMap
<
OpaqueNode
Vec
<
Animation
>
>
>
>
pub
expired_animations
:
Arc
<
RwLock
<
HashMap
<
OpaqueNode
Vec
<
Animation
>
>
>
>
}
pub
struct
PerDocumentStyleData
(
AtomicRefCell
<
PerDocumentStyleDataImpl
>
)
;
impl
PerDocumentStyleData
{
pub
fn
new
(
pres_context
:
RawGeckoPresContextOwned
)
-
>
Self
{
let
device
=
Device
:
:
new
(
pres_context
)
;
let
(
new_anims_sender
new_anims_receiver
)
=
channel
(
)
;
PerDocumentStyleData
(
AtomicRefCell
:
:
new
(
PerDocumentStyleDataImpl
{
stylist
:
Arc
:
:
new
(
Stylist
:
:
new
(
device
)
)
stylesheets
:
vec
!
[
]
stylesheets_changed
:
true
new_animations_sender
:
new_anims_sender
new_animations_receiver
:
new_anims_receiver
running_animations
:
Arc
:
:
new
(
RwLock
:
:
new
(
HashMap
:
:
new
(
)
)
)
expired_animations
:
Arc
:
:
new
(
RwLock
:
:
new
(
HashMap
:
:
new
(
)
)
)
}
)
)
}
pub
fn
borrow
(
&
self
)
-
>
AtomicRef
<
PerDocumentStyleDataImpl
>
{
self
.
0
.
borrow
(
)
}
pub
fn
borrow_mut
(
&
self
)
-
>
AtomicRefMut
<
PerDocumentStyleDataImpl
>
{
self
.
0
.
borrow_mut
(
)
}
}
impl
PerDocumentStyleDataImpl
{
pub
fn
reset_device
(
&
mut
self
)
{
{
let
mut
stylist
=
Arc
:
:
get_mut
(
&
mut
self
.
stylist
)
.
unwrap
(
)
;
Arc
:
:
get_mut
(
&
mut
stylist
.
device
)
.
unwrap
(
)
.
reset
(
)
;
}
self
.
stylesheets_changed
=
true
;
self
.
flush_stylesheets
(
)
;
}
pub
fn
flush_stylesheets
(
&
mut
self
)
{
if
self
.
stylesheets_changed
{
let
mut
stylist
=
Arc
:
:
get_mut
(
&
mut
self
.
stylist
)
.
unwrap
(
)
;
stylist
.
update
(
&
self
.
stylesheets
None
true
)
;
self
.
stylesheets_changed
=
false
;
}
}
pub
fn
default_computed_values
(
&
self
)
-
>
&
Arc
<
ComputedValues
>
{
self
.
stylist
.
device
.
default_values_arc
(
)
}
}
unsafe
impl
HasFFI
for
PerDocumentStyleData
{
type
FFIType
=
RawServoStyleSet
;
}
unsafe
impl
HasSimpleFFI
for
PerDocumentStyleData
{
}
unsafe
impl
HasBoxFFI
for
PerDocumentStyleData
{
}
