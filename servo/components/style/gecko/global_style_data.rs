use
context
:
:
StyleSystemOptions
;
use
num_cpus
;
use
rayon
;
use
shared_lock
:
:
SharedRwLock
;
use
std
:
:
cmp
;
use
std
:
:
env
;
pub
struct
GlobalStyleData
{
pub
num_threads
:
usize
pub
style_thread_pool
:
Option
<
rayon
:
:
ThreadPool
>
pub
shared_lock
:
SharedRwLock
pub
options
:
StyleSystemOptions
}
lazy_static
!
{
/
/
/
Global
style
data
pub
static
ref
GLOBAL_STYLE_DATA
:
GlobalStyleData
=
{
let
stylo_threads
=
env
:
:
var
(
"
STYLO_THREADS
"
)
.
map
(
|
s
|
s
.
parse
:
:
<
usize
>
(
)
.
expect
(
"
invalid
STYLO_THREADS
value
"
)
)
;
let
num_threads
=
match
stylo_threads
{
Ok
(
num
)
=
>
num
_
=
>
cmp
:
:
max
(
num_cpus
:
:
get
(
)
*
3
/
4
1
)
}
;
let
pool
=
if
num_threads
<
=
1
{
None
}
else
{
let
configuration
=
rayon
:
:
Configuration
:
:
new
(
)
.
set_num_threads
(
num_threads
)
;
let
pool
=
rayon
:
:
ThreadPool
:
:
new
(
configuration
)
.
ok
(
)
;
pool
}
;
GlobalStyleData
{
num_threads
:
num_threads
style_thread_pool
:
pool
shared_lock
:
SharedRwLock
:
:
new
(
)
options
:
StyleSystemOptions
:
:
default
(
)
}
}
;
}
