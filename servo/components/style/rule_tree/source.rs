#
!
[
deny
(
unsafe_code
)
]
use
crate
:
:
properties
:
:
PropertyDeclarationBlock
;
use
crate
:
:
shared_lock
:
:
{
Locked
SharedRwLockReadGuard
}
;
use
crate
:
:
stylesheets
:
:
StyleRule
;
use
servo_arc
:
:
{
Arc
ArcBorrow
ArcUnion
ArcUnionBorrow
}
;
use
std
:
:
io
:
:
Write
;
use
std
:
:
ptr
;
#
[
derive
(
Clone
Debug
)
]
pub
struct
StyleSource
(
ArcUnion
<
Locked
<
StyleRule
>
Locked
<
PropertyDeclarationBlock
>
>
)
;
impl
PartialEq
for
StyleSource
{
fn
eq
(
&
self
other
:
&
Self
)
-
>
bool
{
ArcUnion
:
:
ptr_eq
(
&
self
.
0
&
other
.
0
)
}
}
impl
StyleSource
{
pub
fn
from_rule
(
rule
:
Arc
<
Locked
<
StyleRule
>
>
)
-
>
Self
{
StyleSource
(
ArcUnion
:
:
from_first
(
rule
)
)
}
#
[
inline
]
pub
(
super
)
fn
key
(
&
self
)
-
>
ptr
:
:
NonNull
<
(
)
>
{
self
.
0
.
ptr
(
)
}
pub
fn
from_declarations
(
decls
:
Arc
<
Locked
<
PropertyDeclarationBlock
>
>
)
-
>
Self
{
StyleSource
(
ArcUnion
:
:
from_second
(
decls
)
)
}
pub
(
super
)
fn
dump
<
W
:
Write
>
(
&
self
guard
:
&
SharedRwLockReadGuard
writer
:
&
mut
W
)
{
if
let
Some
(
ref
rule
)
=
self
.
0
.
as_first
(
)
{
let
rule
=
rule
.
read_with
(
guard
)
;
let
_
=
write
!
(
writer
"
{
:
?
}
"
rule
.
selectors
)
;
}
let
_
=
write
!
(
writer
"
-
>
{
:
?
}
"
self
.
read
(
guard
)
.
declarations
(
)
)
;
}
#
[
allow
(
unsafe_code
)
]
#
[
cfg
(
feature
=
"
gecko
"
)
]
pub
(
super
)
unsafe
fn
dump_unchecked
<
W
:
Write
>
(
&
self
writer
:
&
mut
W
)
{
if
let
Some
(
ref
rule
)
=
self
.
0
.
as_first
(
)
{
let
rule
=
rule
.
read_unchecked
(
)
;
let
_
=
write
!
(
writer
"
{
:
?
}
"
rule
.
selectors
)
;
}
let
_
=
write
!
(
writer
"
-
>
{
:
?
}
"
self
.
read_unchecked
(
)
.
declarations
(
)
)
;
}
#
[
inline
]
#
[
allow
(
unsafe_code
)
]
#
[
cfg
(
feature
=
"
gecko
"
)
]
pub
(
super
)
unsafe
fn
read_unchecked
(
&
self
)
-
>
&
PropertyDeclarationBlock
{
let
block
:
&
Locked
<
PropertyDeclarationBlock
>
=
match
self
.
0
.
borrow
(
)
{
ArcUnionBorrow
:
:
First
(
ref
rule
)
=
>
&
rule
.
get
(
)
.
read_unchecked
(
)
.
block
ArcUnionBorrow
:
:
Second
(
ref
block
)
=
>
block
.
get
(
)
}
;
block
.
read_unchecked
(
)
}
#
[
inline
]
pub
fn
read
<
'
a
>
(
&
'
a
self
guard
:
&
'
a
SharedRwLockReadGuard
)
-
>
&
'
a
PropertyDeclarationBlock
{
let
block
:
&
Locked
<
PropertyDeclarationBlock
>
=
match
self
.
0
.
borrow
(
)
{
ArcUnionBorrow
:
:
First
(
ref
rule
)
=
>
&
rule
.
get
(
)
.
read_with
(
guard
)
.
block
ArcUnionBorrow
:
:
Second
(
ref
block
)
=
>
block
.
get
(
)
}
;
block
.
read_with
(
guard
)
}
pub
fn
as_rule
(
&
self
)
-
>
Option
<
ArcBorrow
<
Locked
<
StyleRule
>
>
>
{
self
.
0
.
as_first
(
)
}
pub
fn
as_declarations
(
&
self
)
-
>
Option
<
ArcBorrow
<
Locked
<
PropertyDeclarationBlock
>
>
>
{
self
.
0
.
as_second
(
)
}
}
