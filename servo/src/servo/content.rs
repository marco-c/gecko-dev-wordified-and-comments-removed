export
msg
ping
;
export
content
;
import
dom
:
:
rcu
:
:
writer_methods
;
import
dom
=
dom
:
:
base
;
import
layout
:
:
layout
;
enum
msg
{
parse
(
str
)
exit
}
enum
ping
{
pong
}
/
/
sends
a
ping
to
layout
and
awaits
the
response
.
fn
join_layout
(
scope
:
dom
:
:
node_scope
to_layout
:
chan
<
layout
:
:
msg
>
)
{
if
scope
.
is_reader_forked
(
)
{
comm
:
:
listen
{
|
ch
|
to_layout
.
send
(
layout
:
:
ping
(
ch
)
)
;
ch
.
recv
(
)
;
}
scope
.
reader_joined
(
)
;
}
}
fn
content
(
to_layout
:
chan
<
layout
:
:
msg
>
)
-
>
chan
<
msg
>
{
task
:
:
spawn_listener
:
:
<
msg
>
{
|
from_master
|
let
scope
=
dom
:
:
node_scope
(
)
;
loop
{
alt
from_master
.
recv
(
)
{
parse
(
filename
)
{
#
debug
[
"
content
:
Received
filename
%
s
"
filename
]
;
let
stream
=
html
:
:
spawn_parser_task
(
filename
)
;
let
root
=
parser
:
:
html_builder
:
:
build_dom
(
scope
stream
)
;
join_layout
(
scope
to_layout
)
;
to_layout
.
send
(
layout
:
:
build
(
root
)
)
;
scope
.
reader_forked
(
)
;
}
exit
{
to_layout
.
send
(
layout
:
:
exit
)
;
break
;
}
}
}
}
}
