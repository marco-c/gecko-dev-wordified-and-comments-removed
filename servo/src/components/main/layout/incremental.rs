use
style
:
:
ComputedValues
;
pub
enum
RestyleEffect
{
Repaint
=
0x01
BubbleWidths
=
0x02
Reflow
=
0x04
}
pub
struct
RestyleDamage
{
bits
:
int
}
macro_rules
!
restyle_damage
(
(
(
damage
:
ident
)
*
)
=
>
(
RestyleDamage
:
:
none
(
)
(
.
add
(
damage
)
)
*
)
)
impl
RestyleDamage
{
pub
fn
none
(
)
-
>
RestyleDamage
{
RestyleDamage
{
bits
:
0
}
}
pub
fn
all
(
)
-
>
RestyleDamage
{
restyle_damage
!
(
Repaint
BubbleWidths
Reflow
)
}
pub
fn
from_int
(
n
:
int
)
-
>
RestyleDamage
{
RestyleDamage
{
bits
:
n
}
}
pub
fn
to_int
(
self
)
-
>
int
{
self
.
bits
}
pub
fn
is_empty
(
self
)
-
>
bool
{
self
.
bits
=
=
0
}
pub
fn
is_nonempty
(
self
)
-
>
bool
{
self
.
bits
!
=
0
}
pub
fn
add
(
self
effect
:
RestyleEffect
)
-
>
RestyleDamage
{
RestyleDamage
{
bits
:
self
.
bits
|
(
effect
as
int
)
}
}
pub
fn
has
(
self
effect
:
RestyleEffect
)
-
>
bool
{
(
self
.
bits
&
(
effect
as
int
)
)
!
=
0
}
pub
fn
lacks
(
self
effect
:
RestyleEffect
)
-
>
bool
{
(
self
.
bits
&
(
effect
as
int
)
)
=
=
0
}
pub
fn
union
(
self
other
:
RestyleDamage
)
-
>
RestyleDamage
{
RestyleDamage
{
bits
:
self
.
bits
|
other
.
bits
}
}
pub
fn
union_in_place
(
&
mut
self
other
:
RestyleDamage
)
{
self
.
bits
=
self
.
bits
|
other
.
bits
;
}
pub
fn
intersect
(
self
other
:
RestyleDamage
)
-
>
RestyleDamage
{
RestyleDamage
{
bits
:
self
.
bits
&
other
.
bits
}
}
pub
fn
propagate_up
(
self
)
-
>
RestyleDamage
{
self
.
intersect
(
restyle_damage
!
(
Reflow
)
)
}
pub
fn
propagate_down
(
self
)
-
>
RestyleDamage
{
self
.
intersect
(
restyle_damage
!
(
BubbleWidths
)
)
}
}
macro_rules
!
add_if_not_equal
(
(
old
:
ident
new
:
ident
damage
:
ident
[
(
effect
:
ident
)
*
]
[
(
style_struct_getter
:
ident
.
name
:
ident
)
*
]
)
=
>
(
{
if
(
(
old
.
style_struct_getter
(
)
.
name
!
=
new
.
style_struct_getter
(
)
.
name
)
)
|
|
*
{
damage
.
union_in_place
(
restyle_damage
!
(
(
effect
)
*
)
)
;
}
}
)
)
pub
fn
compute_damage
(
old
:
&
ComputedValues
new
:
&
ComputedValues
)
-
>
RestyleDamage
{
let
mut
damage
=
RestyleDamage
:
:
none
(
)
;
add_if_not_equal
!
(
old
new
damage
[
Repaint
]
[
get_color
.
color
get_background
.
background_color
get_border
.
border_top_color
get_border
.
border_right_color
get_border
.
border_bottom_color
get_border
.
border_left_color
]
)
;
add_if_not_equal
!
(
old
new
damage
[
Repaint
BubbleWidths
Reflow
]
[
get_border
.
border_top_width
get_border
.
border_right_width
get_border
.
border_bottom_width
get_border
.
border_left_width
get_margin
.
margin_top
get_margin
.
margin_right
get_margin
.
margin_bottom
get_margin
.
margin_left
get_padding
.
padding_top
get_padding
.
padding_right
get_padding
.
padding_bottom
get_padding
.
padding_left
get_box
.
position
get_box
.
width
get_box
.
height
get_box
.
float
get_box
.
display
get_font
.
font_family
get_font
.
font_size
get_font
.
font_style
get_font
.
font_weight
get_inheritedtext
.
text_align
get_text
.
text_decoration
get_inheritedbox
.
line_height
]
)
;
damage
}
#
[
cfg
(
test
)
]
mod
restyle_damage_tests
{
use
super
:
:
*
;
#
[
test
]
fn
none_is_empty
(
)
{
let
d
=
RestyleDamage
:
:
none
(
)
;
assert
!
(
!
d
.
has
(
Repaint
)
)
;
assert
!
(
!
d
.
has
(
BubbleWidths
)
)
;
assert
!
(
d
.
lacks
(
Repaint
)
)
;
assert
!
(
d
.
lacks
(
BubbleWidths
)
)
;
}
#
[
test
]
fn
all_is_full
(
)
{
let
d
=
RestyleDamage
:
:
all
(
)
;
assert
!
(
d
.
has
(
Repaint
)
)
;
assert
!
(
d
.
has
(
BubbleWidths
)
)
;
assert
!
(
!
d
.
lacks
(
Repaint
)
)
;
assert
!
(
!
d
.
lacks
(
BubbleWidths
)
)
;
}
#
[
test
]
fn
can_add
(
)
{
assert
!
(
RestyleDamage
:
:
none
(
)
.
add
(
BubbleWidths
)
.
has
(
BubbleWidths
)
)
;
}
#
[
test
]
fn
can_union
(
)
{
let
d
=
restyle_damage
!
(
Repaint
)
.
union
(
restyle_damage
!
(
BubbleWidths
)
)
;
assert
!
(
d
.
has
(
Repaint
)
)
;
assert
!
(
d
.
has
(
BubbleWidths
)
)
;
}
#
[
test
]
fn
can_union_in_place
(
)
{
let
mut
d
=
restyle_damage
!
(
Repaint
)
;
d
.
union_in_place
(
restyle_damage
!
(
BubbleWidths
)
)
;
assert
!
(
d
.
has
(
Repaint
)
)
;
assert
!
(
d
.
has
(
BubbleWidths
)
)
;
}
#
[
test
]
fn
can_intersect
(
)
{
let
x
=
restyle_damage
!
(
Repaint
BubbleWidths
)
;
let
y
=
restyle_damage
!
(
Repaint
Reflow
)
;
let
d
=
x
.
intersect
(
y
)
;
assert
!
(
d
.
has
(
Repaint
)
)
;
assert
!
(
d
.
lacks
(
BubbleWidths
)
)
;
assert
!
(
d
.
lacks
(
Reflow
)
)
;
}
}
