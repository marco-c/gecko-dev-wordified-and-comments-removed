import
sys
sys
.
path
.
append
(
"
.
/
parser
/
"
)
sys
.
path
.
append
(
"
.
/
ply
/
"
)
import
os
import
cStringIO
import
WebIDL
import
cPickle
from
Configuration
import
*
from
CodegenRust
import
GlobalGenRoots
replaceFileIfChanged
import
Codegen
def
generate_file
(
config
name
action
)
:
    
root
=
getattr
(
GlobalGenRoots
name
)
(
config
)
    
if
action
is
'
declare
'
:
        
filename
=
name
+
'
.
rs
'
        
code
=
root
.
declare
(
)
    
elif
action
=
=
'
declare
+
define
'
:
        
filename
=
name
+
'
.
rs
'
        
code
=
root
.
declare
(
)
        
root2
=
getattr
(
GlobalGenRoots
name
)
(
config
)
        
code
+
=
root2
.
define
(
)
    
else
:
        
assert
action
is
'
define
'
        
filename
=
name
+
'
.
rs
'
        
code
=
root
.
define
(
)
    
if
replaceFileIfChanged
(
filename
code
)
:
        
print
"
Generating
%
s
"
%
(
filename
)
    
else
:
        
print
"
%
s
hasn
'
t
changed
-
not
touching
it
"
%
(
filename
)
def
main
(
)
:
    
from
optparse
import
OptionParser
    
usageString
=
"
usage
:
%
prog
[
options
]
webidldir
[
files
]
"
    
o
=
OptionParser
(
usage
=
usageString
)
    
o
.
add_option
(
"
-
-
cachedir
"
dest
=
'
cachedir
'
default
=
None
                 
help
=
"
Directory
in
which
to
cache
lex
/
parse
tables
.
"
)
    
o
.
add_option
(
"
-
-
verbose
-
errors
"
action
=
'
store_true
'
default
=
False
                 
help
=
"
When
an
error
happens
display
the
Python
traceback
.
"
)
    
(
options
args
)
=
o
.
parse_args
(
)
    
if
len
(
args
)
<
2
:
        
o
.
error
(
usageString
)
    
configFile
=
args
[
0
]
    
baseDir
=
args
[
1
]
    
fileList
=
args
[
2
:
]
    
parser
=
WebIDL
.
Parser
(
options
.
cachedir
)
    
for
filename
in
fileList
:
        
fullPath
=
os
.
path
.
normpath
(
os
.
path
.
join
(
baseDir
filename
)
)
        
f
=
open
(
fullPath
'
rb
'
)
        
lines
=
f
.
readlines
(
)
        
f
.
close
(
)
        
parser
.
parse
(
'
'
.
join
(
lines
)
fullPath
)
    
parserResults
=
parser
.
finish
(
)
    
resultsFile
=
open
(
'
ParserResults
.
pkl
'
'
wb
'
)
    
cPickle
.
dump
(
parserResults
resultsFile
-
1
)
    
resultsFile
.
close
(
)
    
config
=
Configuration
(
configFile
parserResults
)
    
generate_file
(
config
'
PrototypeList
'
'
declare
+
define
'
)
    
generate_file
(
config
'
RegisterBindings
'
'
declare
+
define
'
)
    
generate_file
(
config
'
InterfaceTypes
'
'
declare
+
define
'
)
    
generate_file
(
config
'
BindingDeclarations
'
'
declare
+
define
'
)
if
__name__
=
=
'
__main__
'
:
    
main
(
)
