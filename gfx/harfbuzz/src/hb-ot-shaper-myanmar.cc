#
include
"
hb
.
hh
"
#
ifndef
HB_NO_OT_SHAPE
#
include
"
hb
-
ot
-
shaper
-
myanmar
-
machine
.
hh
"
#
include
"
hb
-
ot
-
shaper
-
indic
.
hh
"
#
include
"
hb
-
ot
-
layout
.
hh
"
static
const
hb_tag_t
myanmar_basic_features
[
]
=
{
HB_TAG
(
'
r
'
'
p
'
'
h
'
'
f
'
)
HB_TAG
(
'
p
'
'
r
'
'
e
'
'
f
'
)
HB_TAG
(
'
b
'
'
l
'
'
w
'
'
f
'
)
HB_TAG
(
'
p
'
'
s
'
'
t
'
'
f
'
)
}
;
static
const
hb_tag_t
myanmar_other_features
[
]
=
{
HB_TAG
(
'
p
'
'
r
'
'
e
'
'
s
'
)
HB_TAG
(
'
a
'
'
b
'
'
v
'
'
s
'
)
HB_TAG
(
'
b
'
'
l
'
'
w
'
'
s
'
)
HB_TAG
(
'
p
'
'
s
'
'
t
'
'
s
'
)
}
;
static
inline
void
set_myanmar_properties
(
hb_glyph_info_t
&
info
)
{
hb_codepoint_t
u
=
info
.
codepoint
;
unsigned
int
type
=
hb_indic_get_categories
(
u
)
;
info
.
myanmar_category
(
)
=
(
myanmar_category_t
)
(
type
&
0xFFu
)
;
}
static
inline
bool
is_one_of_myanmar
(
const
hb_glyph_info_t
&
info
unsigned
int
flags
)
{
if
(
_hb_glyph_info_ligated
(
&
info
)
)
return
false
;
return
!
!
(
FLAG_UNSAFE
(
info
.
myanmar_category
(
)
)
&
flags
)
;
}
#
define
CONSONANT_FLAGS_MYANMAR
(
FLAG
(
M_Cat
(
C
)
)
|
FLAG
(
M_Cat
(
CS
)
)
|
FLAG
(
M_Cat
(
Ra
)
)
|
/
*
FLAG
(
M_Cat
(
CM
)
)
|
*
/
FLAG
(
M_Cat
(
IV
)
)
|
FLAG
(
M_Cat
(
GB
)
)
|
FLAG
(
M_Cat
(
DOTTEDCIRCLE
)
)
)
static
inline
bool
is_consonant_myanmar
(
const
hb_glyph_info_t
&
info
)
{
return
is_one_of_myanmar
(
info
CONSONANT_FLAGS_MYANMAR
)
;
}
static
void
setup_syllables_myanmar
(
const
hb_ot_shape_plan_t
*
plan
hb_font_t
*
font
hb_buffer_t
*
buffer
)
;
static
void
reorder_myanmar
(
const
hb_ot_shape_plan_t
*
plan
hb_font_t
*
font
hb_buffer_t
*
buffer
)
;
static
void
collect_features_myanmar
(
hb_ot_shape_planner_t
*
plan
)
{
hb_ot_map_builder_t
*
map
=
&
plan
-
>
map
;
map
-
>
add_gsub_pause
(
setup_syllables_myanmar
)
;
map
-
>
enable_feature
(
HB_TAG
(
'
l
'
'
o
'
'
c
'
'
l
'
)
F_PER_SYLLABLE
)
;
map
-
>
enable_feature
(
HB_TAG
(
'
c
'
'
c
'
'
m
'
'
p
'
)
F_PER_SYLLABLE
)
;
map
-
>
add_gsub_pause
(
reorder_myanmar
)
;
for
(
unsigned
int
i
=
0
;
i
<
ARRAY_LENGTH
(
myanmar_basic_features
)
;
i
+
+
)
{
map
-
>
enable_feature
(
myanmar_basic_features
[
i
]
F_MANUAL_ZWJ
|
F_PER_SYLLABLE
)
;
map
-
>
add_gsub_pause
(
nullptr
)
;
}
map
-
>
add_gsub_pause
(
hb_syllabic_clear_var
)
;
for
(
unsigned
int
i
=
0
;
i
<
ARRAY_LENGTH
(
myanmar_other_features
)
;
i
+
+
)
map
-
>
enable_feature
(
myanmar_other_features
[
i
]
F_MANUAL_ZWJ
)
;
}
static
void
setup_masks_myanmar
(
const
hb_ot_shape_plan_t
*
plan
HB_UNUSED
hb_buffer_t
*
buffer
hb_font_t
*
font
HB_UNUSED
)
{
HB_BUFFER_ALLOCATE_VAR
(
buffer
myanmar_category
)
;
HB_BUFFER_ALLOCATE_VAR
(
buffer
myanmar_position
)
;
unsigned
int
count
=
buffer
-
>
len
;
hb_glyph_info_t
*
info
=
buffer
-
>
info
;
for
(
unsigned
int
i
=
0
;
i
<
count
;
i
+
+
)
set_myanmar_properties
(
info
[
i
]
)
;
}
static
void
setup_syllables_myanmar
(
const
hb_ot_shape_plan_t
*
plan
HB_UNUSED
hb_font_t
*
font
HB_UNUSED
hb_buffer_t
*
buffer
)
{
HB_BUFFER_ALLOCATE_VAR
(
buffer
syllable
)
;
find_syllables_myanmar
(
buffer
)
;
foreach_syllable
(
buffer
start
end
)
buffer
-
>
unsafe_to_break
(
start
end
)
;
}
static
int
compare_myanmar_order
(
const
hb_glyph_info_t
*
pa
const
hb_glyph_info_t
*
pb
)
{
int
a
=
pa
-
>
myanmar_position
(
)
;
int
b
=
pb
-
>
myanmar_position
(
)
;
return
(
int
)
a
-
(
int
)
b
;
}
static
void
initial_reordering_consonant_syllable
(
hb_buffer_t
*
buffer
unsigned
int
start
unsigned
int
end
)
{
hb_glyph_info_t
*
info
=
buffer
-
>
info
;
unsigned
int
base
=
end
;
bool
has_reph
=
false
;
{
unsigned
int
limit
=
start
;
if
(
start
+
3
<
=
end
&
&
info
[
start
]
.
myanmar_category
(
)
=
=
M_Cat
(
Ra
)
&
&
info
[
start
+
1
]
.
myanmar_category
(
)
=
=
M_Cat
(
As
)
&
&
info
[
start
+
2
]
.
myanmar_category
(
)
=
=
M_Cat
(
H
)
)
{
limit
+
=
3
;
base
=
start
;
has_reph
=
true
;
}
{
if
(
!
has_reph
)
base
=
limit
;
for
(
unsigned
int
i
=
limit
;
i
<
end
;
i
+
+
)
if
(
is_consonant_myanmar
(
info
[
i
]
)
)
{
base
=
i
;
break
;
}
}
}
{
unsigned
int
i
=
start
;
for
(
;
i
<
start
+
(
has_reph
?
3
:
0
)
;
i
+
+
)
info
[
i
]
.
myanmar_position
(
)
=
POS_AFTER_MAIN
;
for
(
;
i
<
base
;
i
+
+
)
info
[
i
]
.
myanmar_position
(
)
=
POS_PRE_C
;
if
(
i
<
end
)
{
info
[
i
]
.
myanmar_position
(
)
=
POS_BASE_C
;
i
+
+
;
}
myanmar_position_t
pos
=
POS_AFTER_MAIN
;
for
(
;
i
<
end
;
i
+
+
)
{
if
(
info
[
i
]
.
myanmar_category
(
)
=
=
M_Cat
(
MR
)
)
{
info
[
i
]
.
myanmar_position
(
)
=
POS_PRE_C
;
continue
;
}
if
(
info
[
i
]
.
myanmar_category
(
)
=
=
M_Cat
(
VPre
)
)
{
info
[
i
]
.
myanmar_position
(
)
=
POS_PRE_M
;
continue
;
}
if
(
info
[
i
]
.
myanmar_category
(
)
=
=
M_Cat
(
VS
)
)
{
info
[
i
]
.
myanmar_position
(
)
=
info
[
i
-
1
]
.
myanmar_position
(
)
;
continue
;
}
if
(
pos
=
=
POS_AFTER_MAIN
&
&
info
[
i
]
.
myanmar_category
(
)
=
=
M_Cat
(
VBlw
)
)
{
pos
=
POS_BELOW_C
;
info
[
i
]
.
myanmar_position
(
)
=
pos
;
continue
;
}
if
(
pos
=
=
POS_BELOW_C
&
&
info
[
i
]
.
myanmar_category
(
)
=
=
M_Cat
(
A
)
)
{
info
[
i
]
.
myanmar_position
(
)
=
POS_BEFORE_SUB
;
continue
;
}
if
(
pos
=
=
POS_BELOW_C
&
&
info
[
i
]
.
myanmar_category
(
)
=
=
M_Cat
(
VBlw
)
)
{
info
[
i
]
.
myanmar_position
(
)
=
pos
;
continue
;
}
if
(
pos
=
=
POS_BELOW_C
&
&
info
[
i
]
.
myanmar_category
(
)
!
=
M_Cat
(
A
)
)
{
pos
=
POS_AFTER_SUB
;
info
[
i
]
.
myanmar_position
(
)
=
pos
;
continue
;
}
info
[
i
]
.
myanmar_position
(
)
=
pos
;
}
}
buffer
-
>
sort
(
start
end
compare_myanmar_order
)
;
}
static
void
reorder_syllable_myanmar
(
const
hb_ot_shape_plan_t
*
plan
HB_UNUSED
hb_face_t
*
face
HB_UNUSED
hb_buffer_t
*
buffer
unsigned
int
start
unsigned
int
end
)
{
myanmar_syllable_type_t
syllable_type
=
(
myanmar_syllable_type_t
)
(
buffer
-
>
info
[
start
]
.
syllable
(
)
&
0x0F
)
;
switch
(
syllable_type
)
{
case
myanmar_broken_cluster
:
case
myanmar_consonant_syllable
:
initial_reordering_consonant_syllable
(
buffer
start
end
)
;
break
;
case
myanmar_non_myanmar_cluster
:
break
;
}
}
static
void
reorder_myanmar
(
const
hb_ot_shape_plan_t
*
plan
hb_font_t
*
font
hb_buffer_t
*
buffer
)
{
if
(
buffer
-
>
message
(
font
"
start
reordering
myanmar
"
)
)
{
hb_syllabic_insert_dotted_circles
(
font
buffer
myanmar_broken_cluster
M_Cat
(
DOTTEDCIRCLE
)
)
;
foreach_syllable
(
buffer
start
end
)
reorder_syllable_myanmar
(
plan
font
-
>
face
buffer
start
end
)
;
(
void
)
buffer
-
>
message
(
font
"
end
reordering
myanmar
"
)
;
}
HB_BUFFER_DEALLOCATE_VAR
(
buffer
myanmar_category
)
;
HB_BUFFER_DEALLOCATE_VAR
(
buffer
myanmar_position
)
;
}
const
hb_ot_shaper_t
_hb_ot_shaper_myanmar
=
{
collect_features_myanmar
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
setup_masks_myanmar
nullptr
HB_TAG_NONE
HB_OT_SHAPE_NORMALIZATION_MODE_COMPOSED_DIACRITICS_NO_SHORT_CIRCUIT
HB_OT_SHAPE_ZERO_WIDTH_MARKS_BY_GDEF_EARLY
false
}
;
const
hb_ot_shaper_t
_hb_ot_shaper_myanmar_zawgyi
=
{
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
nullptr
HB_TAG_NONE
HB_OT_SHAPE_NORMALIZATION_MODE_NONE
HB_OT_SHAPE_ZERO_WIDTH_MARKS_NONE
false
}
;
#
endif
