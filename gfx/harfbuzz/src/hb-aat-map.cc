#
include
"
hb
.
hh
"
#
ifndef
HB_NO_AAT_SHAPE
#
include
"
hb
-
aat
-
map
.
hh
"
#
include
"
hb
-
aat
-
layout
.
hh
"
#
include
"
hb
-
aat
-
layout
-
feat
-
table
.
hh
"
void
hb_aat_map_builder_t
:
:
add_feature
(
hb_tag_t
tag
unsigned
value
)
{
if
(
!
face
-
>
table
.
feat
-
>
has_data
(
)
)
return
;
if
(
tag
=
=
HB_TAG
(
'
a
'
'
a
'
'
l
'
'
t
'
)
)
{
if
(
!
face
-
>
table
.
feat
-
>
exposes_feature
(
HB_AAT_LAYOUT_FEATURE_TYPE_CHARACTER_ALTERNATIVES
)
)
return
;
feature_info_t
*
info
=
features
.
push
(
)
;
info
-
>
type
=
HB_AAT_LAYOUT_FEATURE_TYPE_CHARACTER_ALTERNATIVES
;
info
-
>
setting
=
(
hb_aat_layout_feature_selector_t
)
value
;
info
-
>
seq
=
features
.
length
;
info
-
>
is_exclusive
=
true
;
return
;
}
const
hb_aat_feature_mapping_t
*
mapping
=
hb_aat_layout_find_feature_mapping
(
tag
)
;
if
(
!
mapping
)
return
;
const
AAT
:
:
FeatureName
*
feature
=
&
face
-
>
table
.
feat
-
>
get_feature
(
mapping
-
>
aatFeatureType
)
;
if
(
!
feature
-
>
has_data
(
)
)
{
if
(
mapping
-
>
aatFeatureType
=
=
HB_AAT_LAYOUT_FEATURE_TYPE_LOWER_CASE
&
&
mapping
-
>
selectorToEnable
=
=
HB_AAT_LAYOUT_FEATURE_SELECTOR_LOWER_CASE_SMALL_CAPS
)
{
feature
=
&
face
-
>
table
.
feat
-
>
get_feature
(
HB_AAT_LAYOUT_FEATURE_TYPE_LETTER_CASE
)
;
if
(
!
feature
-
>
has_data
(
)
)
return
;
}
else
return
;
}
feature_info_t
*
info
=
features
.
push
(
)
;
info
-
>
type
=
mapping
-
>
aatFeatureType
;
info
-
>
setting
=
value
?
mapping
-
>
selectorToEnable
:
mapping
-
>
selectorToDisable
;
info
-
>
seq
=
features
.
length
;
info
-
>
is_exclusive
=
feature
-
>
is_exclusive
(
)
;
}
void
hb_aat_map_builder_t
:
:
compile
(
hb_aat_map_t
&
m
)
{
if
(
features
.
length
)
{
features
.
qsort
(
)
;
unsigned
int
j
=
0
;
for
(
unsigned
int
i
=
1
;
i
<
features
.
length
;
i
+
+
)
if
(
features
[
i
]
.
type
!
=
features
[
j
]
.
type
|
|
(
!
features
[
i
]
.
is_exclusive
&
&
(
(
features
[
i
]
.
setting
&
~
1
)
!
=
(
features
[
j
]
.
setting
&
~
1
)
)
)
)
features
[
+
+
j
]
=
features
[
i
]
;
features
.
shrink
(
j
+
1
)
;
}
hb_aat_layout_compile_map
(
this
&
m
)
;
}
#
endif
