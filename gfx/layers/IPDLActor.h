#
ifndef
MOZILLA_LAYERS_IPDLACTOR_H
#
define
MOZILLA_LAYERS_IPDLACTOR_H
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
layers
/
CompositableForwarder
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
namespace
mozilla
{
namespace
layers
{
template
<
typename
Protocol
>
class
ChildActor
:
public
Protocol
{
public
:
ChildActor
(
)
:
mDestroyed
(
false
)
{
}
~
ChildActor
(
)
{
MOZ_ASSERT
(
mDestroyed
)
;
}
bool
CanSend
(
)
const
{
return
!
mDestroyed
;
}
void
Destroy
(
CompositableForwarder
*
aFwd
=
nullptr
)
{
MOZ_ASSERT
(
!
mDestroyed
)
;
if
(
!
mDestroyed
)
{
mDestroyed
=
true
;
DestroyManagees
(
)
;
if
(
!
aFwd
|
|
!
aFwd
-
>
DestroyInTransaction
(
this
false
)
)
{
this
-
>
SendDestroy
(
)
;
}
}
}
void
DestroySynchronously
(
CompositableForwarder
*
aFwd
=
nullptr
)
{
MOZ_PERFORMANCE_WARNING
(
"
gfx
"
"
IPDL
actor
requires
synchronous
deallocation
"
)
;
MOZ_ASSERT
(
!
mDestroyed
)
;
if
(
!
mDestroyed
)
{
DestroyManagees
(
)
;
mDestroyed
=
true
;
if
(
!
aFwd
|
|
!
aFwd
-
>
DestroyInTransaction
(
this
true
)
)
{
this
-
>
SendDestroySync
(
)
;
this
-
>
SendDestroy
(
)
;
}
}
}
static
bool
DestroyFallback
(
Protocol
*
aActor
)
{
return
aActor
-
>
SendDestroySync
(
)
;
}
virtual
void
DestroyManagees
(
)
{
}
private
:
bool
mDestroyed
;
}
;
template
<
typename
Protocol
>
class
ParentActor
:
public
Protocol
{
public
:
ParentActor
(
)
:
mDestroyed
(
false
)
{
}
~
ParentActor
(
)
{
MOZ_ASSERT
(
mDestroyed
)
;
}
bool
CanSend
(
)
const
{
return
!
mDestroyed
;
}
virtual
void
Destroy
(
)
{
}
virtual
bool
RecvDestroy
(
)
override
{
if
(
!
mDestroyed
)
{
Destroy
(
)
;
mDestroyed
=
true
;
}
Unused
<
<
Protocol
:
:
Send__delete__
(
this
)
;
return
true
;
}
virtual
bool
RecvDestroySync
(
)
override
{
if
(
!
mDestroyed
)
{
Destroy
(
)
;
mDestroyed
=
true
;
}
return
true
;
}
typedef
ipc
:
:
IProtocolManager
<
ipc
:
:
IProtocol
>
:
:
ActorDestroyReason
Why
;
virtual
void
ActorDestroy
(
Why
)
override
{
if
(
!
mDestroyed
)
{
Destroy
(
)
;
mDestroyed
=
true
;
}
}
private
:
bool
mDestroyed
;
}
;
}
}
#
endif
