#
include
"
ContainerLayerMLGPU
.
h
"
#
include
"
gfxPrefs
.
h
"
#
include
"
LayersLogging
.
h
"
#
include
"
LayerManagerMLGPU
.
h
"
#
include
"
MLGDevice
.
h
"
#
include
"
mozilla
/
gfx
/
Types
.
h
"
namespace
mozilla
{
namespace
layers
{
ContainerLayerMLGPU
:
:
ContainerLayerMLGPU
(
LayerManagerMLGPU
*
aManager
)
:
ContainerLayer
(
aManager
nullptr
)
LayerMLGPU
(
aManager
)
{
}
ContainerLayerMLGPU
:
:
~
ContainerLayerMLGPU
(
)
{
while
(
mFirstChild
)
{
RemoveChild
(
mFirstChild
)
;
}
}
bool
ContainerLayerMLGPU
:
:
OnPrepareToRender
(
FrameBuilder
*
aBuilder
)
{
if
(
!
UseIntermediateSurface
(
)
)
{
return
true
;
}
mTargetOffset
=
GetIntermediateSurfaceRect
(
)
.
TopLeft
(
)
.
ToUnknownPoint
(
)
;
mTargetSize
=
GetIntermediateSurfaceRect
(
)
.
Size
(
)
.
ToUnknownSize
(
)
;
if
(
mRenderTarget
&
&
mRenderTarget
-
>
GetSize
(
)
!
=
mTargetSize
)
{
mRenderTarget
=
nullptr
;
}
gfx
:
:
IntRect
viewport
(
gfx
:
:
IntPoint
(
0
0
)
mTargetSize
)
;
if
(
!
mRenderTarget
|
|
!
gfxPrefs
:
:
AdvancedLayersUseInvalidation
(
)
)
{
mInvalidRect
=
viewport
;
}
else
{
mInvalidRect
=
mInvalidRect
.
Intersect
(
viewport
)
;
}
return
true
;
}
void
ContainerLayerMLGPU
:
:
OnLayerManagerChange
(
LayerManagerMLGPU
*
aManager
)
{
ClearCachedResources
(
)
;
}
RefPtr
<
MLGRenderTarget
>
ContainerLayerMLGPU
:
:
UpdateRenderTarget
(
MLGDevice
*
aDevice
MLGRenderTargetFlags
aFlags
)
{
if
(
mRenderTarget
)
{
return
mRenderTarget
;
}
mRenderTarget
=
aDevice
-
>
CreateRenderTarget
(
mTargetSize
aFlags
)
;
if
(
!
mRenderTarget
)
{
gfxWarning
(
)
<
<
"
Failed
to
create
an
intermediate
render
target
for
ContainerLayer
"
;
return
nullptr
;
}
return
mRenderTarget
;
}
void
ContainerLayerMLGPU
:
:
SetInvalidCompositeRect
(
const
gfx
:
:
IntRect
&
aRect
)
{
gfx
:
:
IntRect
bounds
=
aRect
;
bounds
.
MoveBy
(
-
GetTargetOffset
(
)
)
;
if
(
Maybe
<
gfx
:
:
IntRect
>
result
=
mInvalidRect
.
SafeUnion
(
bounds
)
)
{
mInvalidRect
=
result
.
value
(
)
;
}
else
{
mInvalidRect
=
gfx
:
:
IntRect
(
gfx
:
:
IntPoint
(
0
0
)
GetTargetSize
(
)
)
;
}
}
void
ContainerLayerMLGPU
:
:
ClearCachedResources
(
)
{
mRenderTarget
=
nullptr
;
}
bool
ContainerLayerMLGPU
:
:
IsContentOpaque
(
)
{
if
(
GetMixBlendMode
(
)
!
=
gfx
:
:
CompositionOp
:
:
OP_OVER
)
{
return
false
;
}
return
LayerMLGPU
:
:
IsContentOpaque
(
)
;
}
}
}
