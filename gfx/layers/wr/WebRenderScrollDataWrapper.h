#
ifndef
GFX_WEBRENDERSCROLLDATAWRAPPER_H
#
define
GFX_WEBRENDERSCROLLDATAWRAPPER_H
#
include
"
FrameMetrics
.
h
"
#
include
"
mozilla
/
layers
/
CompositorBridgeParent
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderBridgeParent
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderScrollData
.
h
"
namespace
mozilla
{
namespace
layers
{
class
MOZ_STACK_CLASS
WebRenderScrollDataWrapper
{
public
:
explicit
WebRenderScrollDataWrapper
(
const
WebRenderScrollData
*
aData
=
nullptr
)
:
mData
(
aData
)
mLayerIndex
(
0
)
mContainingSubtreeLastIndex
(
0
)
mLayer
(
nullptr
)
mMetadataIndex
(
0
)
{
if
(
!
mData
)
{
return
;
}
mLayer
=
mData
-
>
GetLayerData
(
mLayerIndex
)
;
if
(
!
mLayer
)
{
return
;
}
MOZ_ASSERT
(
mData
-
>
GetLayerCount
(
)
=
=
(
size_t
)
(
1
+
mLayer
-
>
GetDescendantCount
(
)
)
)
;
mContainingSubtreeLastIndex
=
mData
-
>
GetLayerCount
(
)
;
mMetadataIndex
=
mLayer
-
>
GetScrollMetadataCount
(
)
;
if
(
mMetadataIndex
>
0
)
{
mMetadataIndex
-
-
;
}
}
private
:
WebRenderScrollDataWrapper
(
const
WebRenderScrollData
*
aData
size_t
aLayerIndex
size_t
aContainingSubtreeLastIndex
)
:
mData
(
aData
)
mLayerIndex
(
aLayerIndex
)
mContainingSubtreeLastIndex
(
aContainingSubtreeLastIndex
)
mLayer
(
nullptr
)
mMetadataIndex
(
0
)
{
MOZ_ASSERT
(
mData
)
;
mLayer
=
mData
-
>
GetLayerData
(
mLayerIndex
)
;
MOZ_ASSERT
(
mLayer
)
;
mMetadataIndex
=
mLayer
-
>
GetScrollMetadataCount
(
)
;
if
(
mMetadataIndex
>
0
)
{
mMetadataIndex
-
-
;
}
}
WebRenderScrollDataWrapper
(
const
WebRenderScrollData
*
aData
size_t
aLayerIndex
size_t
aContainingSubtreeLastIndex
const
WebRenderLayerScrollData
*
aLayer
uint32_t
aMetadataIndex
)
:
mData
(
aData
)
mLayerIndex
(
aLayerIndex
)
mContainingSubtreeLastIndex
(
aContainingSubtreeLastIndex
)
mLayer
(
aLayer
)
mMetadataIndex
(
aMetadataIndex
)
{
MOZ_ASSERT
(
mData
)
;
MOZ_ASSERT
(
mLayer
)
;
MOZ_ASSERT
(
mLayer
=
=
mData
-
>
GetLayerData
(
mLayerIndex
)
)
;
MOZ_ASSERT
(
mMetadataIndex
=
=
0
|
|
mMetadataIndex
<
mLayer
-
>
GetScrollMetadataCount
(
)
)
;
}
public
:
bool
IsValid
(
)
const
{
return
mLayer
!
=
nullptr
;
}
explicit
operator
bool
(
)
const
{
return
IsValid
(
)
;
}
WebRenderScrollDataWrapper
GetLastChild
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
!
AtBottomLayer
(
)
)
{
return
WebRenderScrollDataWrapper
(
mData
mLayerIndex
mContainingSubtreeLastIndex
mLayer
mMetadataIndex
-
1
)
;
}
if
(
mLayer
-
>
GetDescendantCount
(
)
>
0
)
{
size_t
prevSiblingIndex
=
mLayerIndex
+
1
+
mLayer
-
>
GetDescendantCount
(
)
;
size_t
subtreeLastIndex
=
std
:
:
min
(
mContainingSubtreeLastIndex
prevSiblingIndex
)
;
return
WebRenderScrollDataWrapper
(
mData
mLayerIndex
+
1
subtreeLastIndex
)
;
}
if
(
mLayer
-
>
GetReferentId
(
)
)
{
CompositorBridgeParent
:
:
LayerTreeState
*
lts
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
mLayer
-
>
GetReferentId
(
)
.
value
(
)
)
;
if
(
lts
&
&
lts
-
>
mWrBridge
)
{
return
WebRenderScrollDataWrapper
(
&
(
lts
-
>
mWrBridge
-
>
GetScrollData
(
)
)
)
;
}
}
return
WebRenderScrollDataWrapper
(
)
;
}
WebRenderScrollDataWrapper
GetPrevSibling
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
!
AtTopLayer
(
)
)
{
return
WebRenderScrollDataWrapper
(
)
;
}
size_t
prevSiblingIndex
=
mLayerIndex
+
1
+
mLayer
-
>
GetDescendantCount
(
)
;
if
(
prevSiblingIndex
<
mContainingSubtreeLastIndex
)
{
return
WebRenderScrollDataWrapper
(
mData
prevSiblingIndex
mContainingSubtreeLastIndex
)
;
}
return
WebRenderScrollDataWrapper
(
)
;
}
const
ScrollMetadata
&
Metadata
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
mMetadataIndex
>
=
mLayer
-
>
GetScrollMetadataCount
(
)
)
{
return
*
ScrollMetadata
:
:
sNullMetadata
;
}
return
mLayer
-
>
GetScrollMetadata
(
*
mData
mMetadataIndex
)
;
}
const
FrameMetrics
&
Metrics
(
)
const
{
return
Metadata
(
)
.
GetMetrics
(
)
;
}
AsyncPanZoomController
*
GetApzc
(
)
const
{
return
nullptr
;
}
void
SetApzc
(
AsyncPanZoomController
*
aApzc
)
const
{
}
const
char
*
Name
(
)
const
{
return
"
WebRenderScrollDataWrapper
"
;
}
gfx
:
:
Matrix4x4
GetTransform
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetTransform
(
)
;
}
return
gfx
:
:
Matrix4x4
(
)
;
}
CSSTransformMatrix
GetTransformTyped
(
)
const
{
return
ViewAs
<
CSSTransformMatrix
>
(
GetTransform
(
)
)
;
}
bool
TransformIsPerspective
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetTransformIsPerspective
(
)
;
}
return
false
;
}
EventRegions
GetEventRegions
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetEventRegions
(
)
;
}
return
EventRegions
(
)
;
}
LayerIntRegion
GetVisibleRegion
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetVisibleRegion
(
)
;
}
return
ViewAs
<
LayerPixel
>
(
TransformBy
(
mLayer
-
>
GetTransformTyped
(
)
mLayer
-
>
GetVisibleRegion
(
)
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
}
Maybe
<
uint64_t
>
GetReferentId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetReferentId
(
)
;
}
return
Nothing
(
)
;
}
Maybe
<
ParentLayerIntRect
>
GetClipRect
(
)
const
{
return
Nothing
(
)
;
}
EventRegionsOverride
GetEventRegionsOverride
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
GetEventRegionsOverride
(
)
;
}
const
ScrollThumbData
&
GetScrollThumbData
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
GetScrollThumbData
(
)
;
}
uint64_t
GetScrollbarAnimationId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
GetScrollbarAnimationId
(
)
;
}
FrameMetrics
:
:
ViewID
GetScrollbarTargetContainerId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
GetScrollbarTargetContainerId
(
)
;
}
bool
IsScrollbarContainer
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
IsScrollbarContainer
(
)
;
}
FrameMetrics
:
:
ViewID
GetFixedPositionScrollContainerId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
GetFixedPositionScrollContainerId
(
)
;
}
const
void
*
GetLayer
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
;
}
private
:
bool
AtBottomLayer
(
)
const
{
return
mMetadataIndex
=
=
0
;
}
bool
AtTopLayer
(
)
const
{
return
mLayer
-
>
GetScrollMetadataCount
(
)
=
=
0
|
|
mMetadataIndex
=
=
mLayer
-
>
GetScrollMetadataCount
(
)
-
1
;
}
private
:
const
WebRenderScrollData
*
mData
;
size_t
mLayerIndex
;
size_t
mContainingSubtreeLastIndex
;
const
WebRenderLayerScrollData
*
mLayer
;
uint32_t
mMetadataIndex
;
}
;
}
}
#
endif
