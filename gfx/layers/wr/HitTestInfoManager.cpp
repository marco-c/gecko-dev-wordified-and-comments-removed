#
include
"
HitTestInfoManager
.
h
"
#
include
"
HitTestInfo
.
h
"
#
include
"
nsDisplayList
.
h
"
namespace
mozilla
:
:
layers
{
using
ViewID
=
ScrollableLayerGuid
:
:
ViewID
;
static
int32_t
GetAppUnitsFromDisplayItem
(
nsDisplayItem
*
aItem
)
{
nsIFrame
*
frame
=
aItem
-
>
Frame
(
)
;
MOZ_ASSERT
(
frame
)
;
return
frame
-
>
PresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
;
}
static
void
CreateWebRenderCommands
(
wr
:
:
DisplayListBuilder
&
aBuilder
nsPaintedDisplayItem
*
aItem
const
nsRect
&
aArea
const
gfx
:
:
CompositorHitTestInfo
&
aFlags
const
ViewID
&
aViewId
)
{
const
Maybe
<
SideBits
>
sideBits
=
aBuilder
.
GetContainingFixedPosSideBits
(
aItem
-
>
GetActiveScrolledRoot
(
)
)
;
const
LayoutDeviceRect
devRect
=
LayoutDeviceRect
:
:
FromAppUnits
(
aArea
GetAppUnitsFromDisplayItem
(
aItem
)
)
;
const
wr
:
:
LayoutRect
rect
=
wr
:
:
ToLayoutRect
(
devRect
)
;
aBuilder
.
PushHitTest
(
rect
rect
!
aItem
-
>
BackfaceIsHidden
(
)
aViewId
aFlags
sideBits
.
valueOr
(
SideBits
:
:
eNone
)
)
;
}
void
HitTestInfoManager
:
:
Reset
(
)
{
mArea
=
nsRect
(
)
;
mFlags
=
gfx
:
:
CompositorHitTestInvisibleToHit
;
}
void
HitTestInfoManager
:
:
SwitchItem
(
nsPaintedDisplayItem
*
aItem
wr
:
:
DisplayListBuilder
&
aBuilder
nsDisplayListBuilder
*
aDisplayListBuilder
)
{
if
(
!
aItem
|
|
aItem
-
>
HasChildren
(
)
)
{
return
;
}
const
HitTestInfo
&
hitTestInfo
=
aItem
-
>
GetHitTestInfo
(
)
;
const
nsRect
&
area
=
hitTestInfo
.
Area
(
)
;
const
gfx
:
:
CompositorHitTestInfo
&
flags
=
hitTestInfo
.
Info
(
)
;
if
(
area
.
IsEmpty
(
)
|
|
flags
=
=
gfx
:
:
CompositorHitTestInvisibleToHit
)
{
return
;
}
const
auto
viewId
=
hitTestInfo
.
GetViewId
(
aBuilder
aItem
-
>
GetActiveScrolledRoot
(
)
)
;
const
auto
spaceAndClipChain
=
aBuilder
.
CurrentSpaceAndClipChain
(
)
;
if
(
!
Update
(
area
flags
viewId
spaceAndClipChain
)
)
{
return
;
}
CreateWebRenderCommands
(
aBuilder
aItem
area
flags
viewId
)
;
}
bool
HitTestInfoManager
:
:
Update
(
const
nsRect
&
aArea
const
gfx
:
:
CompositorHitTestInfo
&
aFlags
const
ViewID
&
aViewId
const
wr
:
:
WrSpaceAndClipChain
&
aSpaceAndClip
)
{
if
(
mViewId
=
=
aViewId
&
&
mFlags
=
=
aFlags
&
&
mArea
.
Contains
(
aArea
)
&
&
mSpaceAndClipChain
=
=
aSpaceAndClip
)
{
return
false
;
}
mArea
=
aArea
;
mFlags
=
aFlags
;
mViewId
=
aViewId
;
mSpaceAndClipChain
=
aSpaceAndClip
;
return
true
;
}
}
