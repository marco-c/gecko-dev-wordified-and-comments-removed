#
include
"
mozilla
/
layers
/
ScrollingLayersHelper
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
mozilla
/
layers
/
StackingContextHelper
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayer
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayerManager
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderAPI
.
h
"
#
include
"
UnitTransforms
.
h
"
namespace
mozilla
{
namespace
layers
{
ScrollingLayersHelper
:
:
ScrollingLayersHelper
(
WebRenderLayer
*
aLayer
wr
:
:
DisplayListBuilder
&
aBuilder
const
StackingContextHelper
&
aStackingContext
)
:
mLayer
(
aLayer
)
mBuilder
(
&
aBuilder
)
mPushedLayerLocalClip
(
false
)
{
if
(
!
mLayer
-
>
WrManager
(
)
-
>
AsyncPanZoomEnabled
(
)
)
{
PushLayerLocalClip
(
aStackingContext
)
;
return
;
}
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
for
(
uint32_t
i
=
layer
-
>
GetScrollMetadataCount
(
)
;
i
>
0
;
i
-
-
)
{
const
ScrollMetadata
&
metadata
=
layer
-
>
GetScrollMetadata
(
i
-
1
)
;
if
(
const
Maybe
<
LayerClip
>
&
clip
=
metadata
.
GetScrollClip
(
)
)
{
PushLayerClip
(
clip
.
ref
(
)
aStackingContext
)
;
}
const
FrameMetrics
&
fm
=
layer
-
>
GetFrameMetrics
(
i
-
1
)
;
if
(
layer
-
>
GetIsFixedPosition
(
)
&
&
layer
-
>
GetFixedPositionScrollContainerId
(
)
=
=
fm
.
GetScrollId
(
)
)
{
PushLayerLocalClip
(
aStackingContext
)
;
}
if
(
!
fm
.
IsScrollable
(
)
)
{
continue
;
}
LayerRect
contentRect
=
ViewAs
<
LayerPixel
>
(
fm
.
GetExpandedScrollableRect
(
)
*
fm
.
GetDevPixelsPerCSSPixel
(
)
PixelCastJustification
:
:
WebRenderHasUnitResolution
)
;
LayerRect
clipBounds
=
ViewAs
<
LayerPixel
>
(
fm
.
GetCompositionBounds
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
contentRect
.
MoveBy
(
clipBounds
.
TopLeft
(
)
)
;
mBuilder
-
>
PushScrollLayer
(
fm
.
GetScrollId
(
)
aStackingContext
.
ToRelativeWrRect
(
contentRect
)
aStackingContext
.
ToRelativeWrRect
(
clipBounds
)
)
;
}
if
(
const
Maybe
<
LayerClip
>
&
scrolledClip
=
layer
-
>
GetScrolledClip
(
)
)
{
PushLayerClip
(
scrolledClip
.
ref
(
)
aStackingContext
)
;
}
if
(
layer
-
>
GetIsFixedPosition
(
)
)
{
FrameMetrics
:
:
ViewID
fixedFor
=
layer
-
>
GetFixedPositionScrollContainerId
(
)
;
Maybe
<
FrameMetrics
:
:
ViewID
>
scrollsWith
=
mBuilder
-
>
ParentScrollIdFor
(
fixedFor
)
;
Maybe
<
wr
:
:
WrClipId
>
clipId
=
mBuilder
-
>
TopmostClipId
(
)
;
mBuilder
-
>
PushClipAndScrollInfo
(
scrollsWith
.
valueOr
(
0
)
clipId
.
ptrOr
(
nullptr
)
)
;
}
else
{
PushLayerLocalClip
(
aStackingContext
)
;
}
}
void
ScrollingLayersHelper
:
:
PushLayerLocalClip
(
const
StackingContextHelper
&
aStackingContext
)
{
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
Maybe
<
ParentLayerRect
>
clip
;
if
(
const
Maybe
<
ParentLayerIntRect
>
&
rect
=
layer
-
>
GetClipRect
(
)
)
{
clip
=
Some
(
IntRectToRect
(
rect
.
ref
(
)
)
)
;
}
else
if
(
layer
-
>
GetMaskLayer
(
)
)
{
clip
=
Some
(
layer
-
>
GetLocalTransformTyped
(
)
.
TransformBounds
(
mLayer
-
>
Bounds
(
)
)
)
;
}
if
(
clip
)
{
Maybe
<
WrImageMask
>
mask
=
mLayer
-
>
BuildWrMaskLayer
(
aStackingContext
)
;
LayerRect
clipRect
=
ViewAs
<
LayerPixel
>
(
clip
.
ref
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
mBuilder
-
>
PushClip
(
aStackingContext
.
ToRelativeWrRect
(
clipRect
)
mask
.
ptrOr
(
nullptr
)
)
;
mPushedLayerLocalClip
=
true
;
}
}
void
ScrollingLayersHelper
:
:
PushLayerClip
(
const
LayerClip
&
aClip
const
StackingContextHelper
&
aSc
)
{
LayerRect
clipRect
=
IntRectToRect
(
ViewAs
<
LayerPixel
>
(
aClip
.
GetClipRect
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
)
;
Maybe
<
WrImageMask
>
mask
;
if
(
Maybe
<
size_t
>
maskLayerIndex
=
aClip
.
GetMaskLayerIndex
(
)
)
{
Layer
*
maskLayer
=
mLayer
-
>
GetLayer
(
)
-
>
GetAncestorMaskLayerAt
(
maskLayerIndex
.
value
(
)
)
;
WebRenderLayer
*
maskWrLayer
=
WebRenderLayer
:
:
ToWebRenderLayer
(
maskLayer
)
;
mask
=
maskWrLayer
-
>
RenderMaskLayer
(
aSc
maskLayer
-
>
GetTransform
(
)
)
;
}
mBuilder
-
>
PushClip
(
aSc
.
ToRelativeWrRect
(
clipRect
)
mask
.
ptrOr
(
nullptr
)
)
;
}
ScrollingLayersHelper
:
:
~
ScrollingLayersHelper
(
)
{
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
if
(
!
mLayer
-
>
WrManager
(
)
-
>
AsyncPanZoomEnabled
(
)
)
{
if
(
mPushedLayerLocalClip
)
{
mBuilder
-
>
PopClip
(
)
;
}
return
;
}
if
(
layer
-
>
GetIsFixedPosition
(
)
)
{
mBuilder
-
>
PopClipAndScrollInfo
(
)
;
}
else
if
(
mPushedLayerLocalClip
)
{
mBuilder
-
>
PopClip
(
)
;
}
if
(
layer
-
>
GetScrolledClip
(
)
)
{
mBuilder
-
>
PopClip
(
)
;
}
for
(
uint32_t
i
=
0
;
i
<
layer
-
>
GetScrollMetadataCount
(
)
;
i
+
+
)
{
const
FrameMetrics
&
fm
=
layer
-
>
GetFrameMetrics
(
i
)
;
if
(
fm
.
IsScrollable
(
)
)
{
mBuilder
-
>
PopScrollLayer
(
)
;
}
if
(
layer
-
>
GetIsFixedPosition
(
)
&
&
layer
-
>
GetFixedPositionScrollContainerId
(
)
=
=
fm
.
GetScrollId
(
)
&
&
mPushedLayerLocalClip
)
{
mBuilder
-
>
PopClip
(
)
;
}
const
ScrollMetadata
&
metadata
=
layer
-
>
GetScrollMetadata
(
i
)
;
if
(
metadata
.
GetScrollClip
(
)
)
{
mBuilder
-
>
PopClip
(
)
;
}
}
}
}
}
