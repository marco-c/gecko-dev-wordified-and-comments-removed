#
include
"
mozilla
/
layers
/
ScrollingLayersHelper
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
mozilla
/
layers
/
StackingContextHelper
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayer
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayerManager
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderAPI
.
h
"
#
include
"
UnitTransforms
.
h
"
namespace
mozilla
{
namespace
layers
{
ScrollingLayersHelper
:
:
ScrollingLayersHelper
(
WebRenderLayer
*
aLayer
wr
:
:
DisplayListBuilder
&
aBuilder
const
StackingContextHelper
&
aStackingContext
)
:
mLayer
(
aLayer
)
mBuilder
(
&
aBuilder
)
{
if
(
!
mLayer
-
>
WrManager
(
)
-
>
AsyncPanZoomEnabled
(
)
)
{
return
;
}
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
for
(
uint32_t
i
=
layer
-
>
GetScrollMetadataCount
(
)
;
i
>
0
;
i
-
-
)
{
const
FrameMetrics
&
fm
=
layer
-
>
GetFrameMetrics
(
i
-
1
)
;
if
(
!
fm
.
IsScrollable
(
)
)
{
return
;
}
LayerRect
contentRect
=
ViewAs
<
LayerPixel
>
(
fm
.
GetExpandedScrollableRect
(
)
*
fm
.
GetDevPixelsPerCSSPixel
(
)
PixelCastJustification
:
:
WebRenderHasUnitResolution
)
;
LayerRect
clipBounds
=
ViewAs
<
LayerPixel
>
(
fm
.
GetCompositionBounds
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
contentRect
.
MoveBy
(
clipBounds
.
TopLeft
(
)
)
;
mBuilder
-
>
PushScrollLayer
(
fm
.
GetScrollId
(
)
aStackingContext
.
ToRelativeWrRect
(
contentRect
)
aStackingContext
.
ToRelativeWrRect
(
clipBounds
)
)
;
}
}
ScrollingLayersHelper
:
:
~
ScrollingLayersHelper
(
)
{
if
(
!
mLayer
-
>
WrManager
(
)
-
>
AsyncPanZoomEnabled
(
)
)
{
return
;
}
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
for
(
int32_t
i
=
layer
-
>
GetScrollMetadataCount
(
)
;
i
>
0
;
i
-
-
)
{
const
FrameMetrics
&
fm
=
layer
-
>
GetFrameMetrics
(
i
-
1
)
;
if
(
!
fm
.
IsScrollable
(
)
)
{
return
;
}
mBuilder
-
>
PopScrollLayer
(
)
;
}
}
}
}
