#
include
"
mozilla
/
layers
/
ScrollingLayersHelper
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
mozilla
/
layers
/
StackingContextHelper
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderAPI
.
h
"
#
include
"
UnitTransforms
.
h
"
namespace
mozilla
{
namespace
layers
{
ScrollingLayersHelper
:
:
ScrollingLayersHelper
(
nsDisplayItem
*
aItem
wr
:
:
DisplayListBuilder
&
aBuilder
const
StackingContextHelper
&
aStackingContext
WebRenderCommandBuilder
:
:
ClipIdMap
&
aCache
bool
aApzEnabled
)
:
mBuilder
(
&
aBuilder
)
mPushedClipAndScroll
(
false
)
mCache
(
aCache
)
{
int32_t
auPerDevPixel
=
aItem
-
>
Frame
(
)
-
>
PresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
;
const
ActiveScrolledRoot
*
leafmostASR
=
aItem
-
>
GetActiveScrolledRoot
(
)
;
if
(
aItem
-
>
GetClipChain
(
)
)
{
leafmostASR
=
ActiveScrolledRoot
:
:
PickDescendant
(
leafmostASR
aItem
-
>
GetClipChain
(
)
-
>
mASR
)
;
}
auto
ids
=
DefineClipChain
(
aItem
leafmostASR
aItem
-
>
GetClipChain
(
)
auPerDevPixel
aStackingContext
)
;
FrameMetrics
:
:
ViewID
leafmostId
=
ids
.
first
.
valueOr
(
FrameMetrics
:
:
NULL_SCROLL_ID
)
;
FrameMetrics
:
:
ViewID
scrollId
=
aItem
-
>
GetActiveScrolledRoot
(
)
?
nsLayoutUtils
:
:
ViewIDForASR
(
aItem
-
>
GetActiveScrolledRoot
(
)
)
:
FrameMetrics
:
:
NULL_SCROLL_ID
;
bool
needClipAndScroll
=
(
leafmostId
!
=
scrollId
)
;
if
(
!
needClipAndScroll
&
&
mBuilder
-
>
TopmostScrollId
(
)
!
=
scrollId
)
{
MOZ_ASSERT
(
leafmostId
=
=
scrollId
)
;
mBuilder
-
>
PushScrollLayer
(
scrollId
)
;
mPushedClips
.
push_back
(
wr
:
:
ScrollOrClipId
(
scrollId
)
)
;
}
if
(
ids
.
second
&
&
aItem
-
>
GetClipChain
(
)
-
>
mASR
=
=
leafmostASR
)
{
mBuilder
-
>
PushClip
(
ids
.
second
.
ref
(
)
)
;
mPushedClips
.
push_back
(
wr
:
:
ScrollOrClipId
(
ids
.
second
.
ref
(
)
)
)
;
}
if
(
needClipAndScroll
)
{
Maybe
<
wr
:
:
WrClipId
>
clipId
=
mBuilder
-
>
TopmostClipId
(
)
;
mBuilder
-
>
PushClipAndScrollInfo
(
scrollId
clipId
.
ptrOr
(
nullptr
)
)
;
mPushedClipAndScroll
=
true
;
}
}
std
:
:
pair
<
Maybe
<
FrameMetrics
:
:
ViewID
>
Maybe
<
wr
:
:
WrClipId
>
>
ScrollingLayersHelper
:
:
DefineClipChain
(
nsDisplayItem
*
aItem
const
ActiveScrolledRoot
*
aAsr
const
DisplayItemClipChain
*
aChain
int32_t
aAppUnitsPerDevPixel
const
StackingContextHelper
&
aStackingContext
)
{
MOZ_ASSERT
(
!
aChain
|
|
ActiveScrolledRoot
:
:
PickDescendant
(
aChain
-
>
mASR
aAsr
)
=
=
aAsr
)
;
if
(
aChain
&
&
aChain
-
>
mASR
=
=
aAsr
)
{
return
RecurseAndDefineClip
(
aItem
aAsr
aChain
aAppUnitsPerDevPixel
aStackingContext
)
;
}
if
(
aAsr
)
{
return
RecurseAndDefineAsr
(
aItem
aAsr
aChain
aAppUnitsPerDevPixel
aStackingContext
)
;
}
MOZ_ASSERT
(
!
aChain
&
&
!
aAsr
)
;
return
std
:
:
make_pair
(
Nothing
(
)
Nothing
(
)
)
;
}
std
:
:
pair
<
Maybe
<
FrameMetrics
:
:
ViewID
>
Maybe
<
wr
:
:
WrClipId
>
>
ScrollingLayersHelper
:
:
RecurseAndDefineClip
(
nsDisplayItem
*
aItem
const
ActiveScrolledRoot
*
aAsr
const
DisplayItemClipChain
*
aChain
int32_t
aAppUnitsPerDevPixel
const
StackingContextHelper
&
aSc
)
{
MOZ_ASSERT
(
aChain
)
;
std
:
:
pair
<
Maybe
<
FrameMetrics
:
:
ViewID
>
Maybe
<
wr
:
:
WrClipId
>
>
ids
;
if
(
mBuilder
-
>
HasExtraClip
(
)
)
{
ids
.
second
=
mBuilder
-
>
GetCacheOverride
(
aChain
)
;
}
else
{
auto
it
=
mCache
.
find
(
aChain
)
;
if
(
it
!
=
mCache
.
end
(
)
)
{
ids
.
second
=
Some
(
it
-
>
second
)
;
}
}
if
(
ids
.
second
)
{
if
(
aAsr
)
{
FrameMetrics
:
:
ViewID
scrollId
=
nsLayoutUtils
:
:
ViewIDForASR
(
aAsr
)
;
MOZ_ASSERT
(
mBuilder
-
>
IsScrollLayerDefined
(
scrollId
)
)
;
ids
.
first
=
Some
(
scrollId
)
;
}
return
ids
;
}
auto
ancestorIds
=
DefineClipChain
(
aItem
aAsr
aChain
-
>
mParent
aAppUnitsPerDevPixel
aSc
)
;
ids
=
ancestorIds
;
if
(
!
aChain
-
>
mClip
.
HasClip
(
)
)
{
return
ids
;
}
if
(
aChain
-
>
mParent
)
{
if
(
mBuilder
-
>
GetCacheOverride
(
aChain
-
>
mParent
)
)
{
ancestorIds
.
first
=
Nothing
(
)
;
}
else
if
(
aChain
-
>
mParent
-
>
mASR
=
=
aAsr
)
{
ancestorIds
.
first
=
Nothing
(
)
;
}
else
{
ancestorIds
.
second
=
Nothing
(
)
;
}
}
else
{
MOZ_ASSERT
(
!
ancestorIds
.
second
)
;
FrameMetrics
:
:
ViewID
scrollId
=
aChain
-
>
mASR
?
nsLayoutUtils
:
:
ViewIDForASR
(
aChain
-
>
mASR
)
:
FrameMetrics
:
:
NULL_SCROLL_ID
;
if
(
mBuilder
-
>
TopmostScrollId
(
)
=
=
scrollId
&
&
mBuilder
-
>
TopmostIsClip
(
)
)
{
ancestorIds
.
first
=
Nothing
(
)
;
ancestorIds
.
second
=
mBuilder
-
>
TopmostClipId
(
)
;
}
}
MOZ_ASSERT
(
!
(
ancestorIds
.
first
&
&
ancestorIds
.
second
)
)
;
LayoutDeviceRect
clip
=
LayoutDeviceRect
:
:
FromAppUnits
(
aChain
-
>
mClip
.
GetClipRect
(
)
aAppUnitsPerDevPixel
)
;
nsTArray
<
wr
:
:
ComplexClipRegion
>
wrRoundedRects
;
aChain
-
>
mClip
.
ToComplexClipRegions
(
aAppUnitsPerDevPixel
aSc
wrRoundedRects
)
;
wr
:
:
WrClipId
clipId
=
mBuilder
-
>
DefineClip
(
ancestorIds
.
first
ancestorIds
.
second
aSc
.
ToRelativeLayoutRect
(
clip
)
&
wrRoundedRects
)
;
if
(
!
mBuilder
-
>
HasExtraClip
(
)
)
{
mCache
[
aChain
]
=
clipId
;
}
ids
.
second
=
Some
(
clipId
)
;
return
ids
;
}
std
:
:
pair
<
Maybe
<
FrameMetrics
:
:
ViewID
>
Maybe
<
wr
:
:
WrClipId
>
>
ScrollingLayersHelper
:
:
RecurseAndDefineAsr
(
nsDisplayItem
*
aItem
const
ActiveScrolledRoot
*
aAsr
const
DisplayItemClipChain
*
aChain
int32_t
aAppUnitsPerDevPixel
const
StackingContextHelper
&
aSc
)
{
MOZ_ASSERT
(
aAsr
)
;
std
:
:
pair
<
Maybe
<
FrameMetrics
:
:
ViewID
>
Maybe
<
wr
:
:
WrClipId
>
>
ids
;
FrameMetrics
:
:
ViewID
scrollId
=
nsLayoutUtils
:
:
ViewIDForASR
(
aAsr
)
;
if
(
mBuilder
-
>
IsScrollLayerDefined
(
scrollId
)
)
{
ids
.
first
=
Some
(
scrollId
)
;
if
(
aChain
)
{
if
(
mBuilder
-
>
HasExtraClip
(
)
)
{
ids
.
second
=
mBuilder
-
>
GetCacheOverride
(
aChain
)
;
}
else
{
auto
it
=
mCache
.
find
(
aChain
)
;
if
(
it
=
=
mCache
.
end
(
)
)
{
for
(
it
=
mCache
.
begin
(
)
;
it
!
=
mCache
.
end
(
)
;
it
+
+
)
{
if
(
DisplayItemClipChain
:
:
Equal
(
aChain
it
-
>
first
)
)
{
break
;
}
}
}
if
(
it
!
=
mCache
.
end
(
)
)
{
ids
.
second
=
Some
(
it
-
>
second
)
;
}
}
}
return
ids
;
}
auto
ancestorIds
=
DefineClipChain
(
aItem
aAsr
-
>
mParent
aChain
aAppUnitsPerDevPixel
aSc
)
;
ids
=
ancestorIds
;
Maybe
<
ScrollMetadata
>
metadata
=
aAsr
-
>
mScrollableFrame
-
>
ComputeScrollMetadata
(
nullptr
aItem
-
>
ReferenceFrame
(
)
ContainerLayerParameters
(
)
nullptr
)
;
MOZ_ASSERT
(
metadata
)
;
FrameMetrics
&
metrics
=
metadata
-
>
GetMetrics
(
)
;
if
(
!
metrics
.
IsScrollable
(
)
)
{
return
ids
;
}
if
(
ancestorIds
.
first
&
&
ancestorIds
.
second
)
{
MOZ_ASSERT
(
aAsr
-
>
mParent
)
;
MOZ_ASSERT
(
aChain
)
;
if
(
aChain
-
>
mASR
&
&
aChain
-
>
mASR
=
=
aAsr
-
>
mParent
)
{
ancestorIds
.
first
=
Nothing
(
)
;
}
else
{
ancestorIds
.
second
=
Nothing
(
)
;
}
}
MOZ_ASSERT
(
!
(
ancestorIds
.
first
&
&
ancestorIds
.
second
)
)
;
LayoutDeviceRect
contentRect
=
metrics
.
GetExpandedScrollableRect
(
)
*
metrics
.
GetDevPixelsPerCSSPixel
(
)
;
LayoutDeviceRect
clipBounds
=
LayoutDeviceRect
:
:
FromUnknownRect
(
metrics
.
GetCompositionBounds
(
)
.
ToUnknownRect
(
)
)
;
contentRect
.
MoveTo
(
clipBounds
.
TopLeft
(
)
)
;
mBuilder
-
>
DefineScrollLayer
(
scrollId
ancestorIds
.
first
ancestorIds
.
second
aSc
.
ToRelativeLayoutRect
(
contentRect
)
aSc
.
ToRelativeLayoutRect
(
clipBounds
)
)
;
ids
.
first
=
Some
(
scrollId
)
;
return
ids
;
}
ScrollingLayersHelper
:
:
~
ScrollingLayersHelper
(
)
{
if
(
mPushedClipAndScroll
)
{
mBuilder
-
>
PopClipAndScrollInfo
(
)
;
}
while
(
!
mPushedClips
.
empty
(
)
)
{
wr
:
:
ScrollOrClipId
id
=
mPushedClips
.
back
(
)
;
if
(
id
.
is
<
wr
:
:
WrClipId
>
(
)
)
{
mBuilder
-
>
PopClip
(
)
;
}
else
{
MOZ_ASSERT
(
id
.
is
<
FrameMetrics
:
:
ViewID
>
(
)
)
;
mBuilder
-
>
PopScrollLayer
(
)
;
}
mPushedClips
.
pop_back
(
)
;
}
}
}
}
