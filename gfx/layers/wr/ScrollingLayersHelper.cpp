#
include
"
mozilla
/
layers
/
ScrollingLayersHelper
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
mozilla
/
layers
/
StackingContextHelper
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayer
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayerManager
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderAPI
.
h
"
#
include
"
UnitTransforms
.
h
"
namespace
mozilla
{
namespace
layers
{
ScrollingLayersHelper
:
:
ScrollingLayersHelper
(
WebRenderLayer
*
aLayer
wr
:
:
DisplayListBuilder
&
aBuilder
wr
:
:
IpcResourceUpdateQueue
&
aResources
const
StackingContextHelper
&
aStackingContext
)
:
mLayer
(
aLayer
)
mBuilder
(
&
aBuilder
)
mPushedLayerLocalClip
(
false
)
mPushedClipAndScroll
(
false
)
{
if
(
!
mLayer
-
>
WrManager
(
)
-
>
AsyncPanZoomEnabled
(
)
)
{
PushLayerLocalClip
(
aStackingContext
aResources
)
;
return
;
}
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
for
(
uint32_t
i
=
layer
-
>
GetScrollMetadataCount
(
)
;
i
>
0
;
i
-
-
)
{
const
ScrollMetadata
&
metadata
=
layer
-
>
GetScrollMetadata
(
i
-
1
)
;
if
(
const
Maybe
<
LayerClip
>
&
clip
=
metadata
.
GetScrollClip
(
)
)
{
PushLayerClip
(
clip
.
ref
(
)
aStackingContext
aResources
)
;
}
const
FrameMetrics
&
fm
=
layer
-
>
GetFrameMetrics
(
i
-
1
)
;
if
(
layer
-
>
GetIsFixedPosition
(
)
&
&
layer
-
>
GetFixedPositionScrollContainerId
(
)
=
=
fm
.
GetScrollId
(
)
)
{
PushLayerLocalClip
(
aStackingContext
aResources
)
;
}
DefineAndPushScrollLayer
(
fm
aStackingContext
)
;
}
if
(
const
Maybe
<
LayerClip
>
&
scrolledClip
=
layer
-
>
GetScrolledClip
(
)
)
{
PushLayerClip
(
scrolledClip
.
ref
(
)
aStackingContext
aResources
)
;
}
if
(
layer
-
>
GetIsFixedPosition
(
)
)
{
FrameMetrics
:
:
ViewID
fixedFor
=
layer
-
>
GetFixedPositionScrollContainerId
(
)
;
Maybe
<
FrameMetrics
:
:
ViewID
>
scrollsWith
=
mBuilder
-
>
ParentScrollIdFor
(
fixedFor
)
;
Maybe
<
wr
:
:
WrClipId
>
clipId
=
mBuilder
-
>
TopmostClipId
(
)
;
mBuilder
-
>
PushClipAndScrollInfo
(
scrollsWith
.
valueOr
(
0
)
clipId
.
ptrOr
(
nullptr
)
)
;
}
else
{
PushLayerLocalClip
(
aStackingContext
aResources
)
;
}
}
ScrollingLayersHelper
:
:
ScrollingLayersHelper
(
nsDisplayItem
*
aItem
wr
:
:
DisplayListBuilder
&
aBuilder
const
StackingContextHelper
&
aStackingContext
WebRenderLayerManager
:
:
ClipIdMap
&
aCache
bool
aApzEnabled
)
:
mLayer
(
nullptr
)
mBuilder
(
&
aBuilder
)
mPushedLayerLocalClip
(
false
)
mPushedClipAndScroll
(
false
)
{
int32_t
auPerDevPixel
=
aItem
-
>
Frame
(
)
-
>
PresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
;
if
(
!
aApzEnabled
)
{
DefineAndPushChain
(
aItem
-
>
GetClipChain
(
)
aBuilder
aStackingContext
auPerDevPixel
aCache
)
;
return
;
}
const
ActiveScrolledRoot
*
leafmostASR
=
aItem
-
>
GetActiveScrolledRoot
(
)
;
if
(
aItem
-
>
GetClipChain
(
)
)
{
leafmostASR
=
ActiveScrolledRoot
:
:
PickDescendant
(
leafmostASR
aItem
-
>
GetClipChain
(
)
-
>
mASR
)
;
}
DefineAndPushScrollLayers
(
aItem
leafmostASR
aItem
-
>
GetClipChain
(
)
aBuilder
auPerDevPixel
aStackingContext
aCache
)
;
DefineAndPushChain
(
aItem
-
>
GetClipChain
(
)
aBuilder
aStackingContext
auPerDevPixel
aCache
)
;
FrameMetrics
:
:
ViewID
scrollId
=
aItem
-
>
GetActiveScrolledRoot
(
)
?
nsLayoutUtils
:
:
ViewIDForASR
(
aItem
-
>
GetActiveScrolledRoot
(
)
)
:
FrameMetrics
:
:
NULL_SCROLL_ID
;
if
(
aBuilder
.
TopmostScrollId
(
)
!
=
scrollId
)
{
Maybe
<
wr
:
:
WrClipId
>
clipId
=
mBuilder
-
>
TopmostClipId
(
)
;
mBuilder
-
>
PushClipAndScrollInfo
(
scrollId
clipId
.
ptrOr
(
nullptr
)
)
;
mPushedClipAndScroll
=
true
;
}
}
void
ScrollingLayersHelper
:
:
DefineAndPushScrollLayers
(
nsDisplayItem
*
aItem
const
ActiveScrolledRoot
*
aAsr
const
DisplayItemClipChain
*
aChain
wr
:
:
DisplayListBuilder
&
aBuilder
int32_t
aAppUnitsPerDevPixel
const
StackingContextHelper
&
aStackingContext
WebRenderLayerManager
:
:
ClipIdMap
&
aCache
)
{
if
(
!
aAsr
)
{
return
;
}
FrameMetrics
:
:
ViewID
scrollId
=
nsLayoutUtils
:
:
ViewIDForASR
(
aAsr
)
;
if
(
aBuilder
.
TopmostScrollId
(
)
=
=
scrollId
)
{
return
;
}
const
DisplayItemClipChain
*
asrClippedBy
=
aChain
;
while
(
asrClippedBy
&
&
ActiveScrolledRoot
:
:
PickAncestor
(
asrClippedBy
-
>
mASR
aAsr
)
=
=
aAsr
)
{
asrClippedBy
=
asrClippedBy
-
>
mParent
;
}
DefineAndPushScrollLayers
(
aItem
aAsr
-
>
mParent
asrClippedBy
aBuilder
aAppUnitsPerDevPixel
aStackingContext
aCache
)
;
DefineAndPushChain
(
asrClippedBy
aBuilder
aStackingContext
aAppUnitsPerDevPixel
aCache
)
;
bool
pushed
=
false
;
if
(
mBuilder
-
>
IsScrollLayerDefined
(
scrollId
)
)
{
mBuilder
-
>
PushScrollLayer
(
scrollId
)
;
pushed
=
true
;
}
else
{
Maybe
<
ScrollMetadata
>
metadata
=
aAsr
-
>
mScrollableFrame
-
>
ComputeScrollMetadata
(
nullptr
aItem
-
>
ReferenceFrame
(
)
ContainerLayerParameters
(
)
nullptr
)
;
MOZ_ASSERT
(
metadata
)
;
pushed
=
DefineAndPushScrollLayer
(
metadata
-
>
GetMetrics
(
)
aStackingContext
)
;
}
if
(
pushed
)
{
mPushedClips
.
push_back
(
wr
:
:
ScrollOrClipId
(
scrollId
)
)
;
}
}
void
ScrollingLayersHelper
:
:
DefineAndPushChain
(
const
DisplayItemClipChain
*
aChain
wr
:
:
DisplayListBuilder
&
aBuilder
const
StackingContextHelper
&
aStackingContext
int32_t
aAppUnitsPerDevPixel
WebRenderLayerManager
:
:
ClipIdMap
&
aCache
)
{
if
(
!
aChain
)
{
return
;
}
auto
it
=
aCache
.
find
(
aChain
)
;
Maybe
<
wr
:
:
WrClipId
>
clipId
=
(
it
!
=
aCache
.
end
(
)
?
Some
(
it
-
>
second
)
:
Nothing
(
)
)
;
if
(
clipId
&
&
clipId
=
=
aBuilder
.
TopmostClipId
(
)
)
{
return
;
}
DefineAndPushChain
(
aChain
-
>
mParent
aBuilder
aStackingContext
aAppUnitsPerDevPixel
aCache
)
;
if
(
!
aChain
-
>
mClip
.
HasClip
(
)
)
{
return
;
}
if
(
!
clipId
|
|
aBuilder
.
HasMaskClip
(
)
)
{
LayoutDeviceRect
clip
=
LayoutDeviceRect
:
:
FromAppUnits
(
aChain
-
>
mClip
.
GetClipRect
(
)
aAppUnitsPerDevPixel
)
;
nsTArray
<
wr
:
:
WrComplexClipRegion
>
wrRoundedRects
;
aChain
-
>
mClip
.
ToWrComplexClipRegions
(
aAppUnitsPerDevPixel
aStackingContext
wrRoundedRects
)
;
clipId
=
Some
(
aBuilder
.
DefineClip
(
aStackingContext
.
ToRelativeLayoutRect
(
clip
)
&
wrRoundedRects
)
)
;
if
(
!
aBuilder
.
HasMaskClip
(
)
)
{
aCache
[
aChain
]
=
clipId
.
value
(
)
;
}
}
MOZ_ASSERT
(
clipId
)
;
aBuilder
.
PushClip
(
clipId
.
value
(
)
)
;
mPushedClips
.
push_back
(
wr
:
:
ScrollOrClipId
(
clipId
.
value
(
)
)
)
;
}
bool
ScrollingLayersHelper
:
:
DefineAndPushScrollLayer
(
const
FrameMetrics
&
aMetrics
const
StackingContextHelper
&
aStackingContext
)
{
if
(
!
aMetrics
.
IsScrollable
(
)
)
{
return
false
;
}
LayerRect
contentRect
=
ViewAs
<
LayerPixel
>
(
aMetrics
.
GetExpandedScrollableRect
(
)
*
aMetrics
.
GetDevPixelsPerCSSPixel
(
)
PixelCastJustification
:
:
WebRenderHasUnitResolution
)
;
LayerRect
clipBounds
=
ViewAs
<
LayerPixel
>
(
aMetrics
.
GetCompositionBounds
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
contentRect
.
MoveTo
(
clipBounds
.
TopLeft
(
)
)
;
mBuilder
-
>
DefineScrollLayer
(
aMetrics
.
GetScrollId
(
)
aStackingContext
.
ToRelativeLayoutRect
(
contentRect
)
aStackingContext
.
ToRelativeLayoutRect
(
clipBounds
)
)
;
mBuilder
-
>
PushScrollLayer
(
aMetrics
.
GetScrollId
(
)
)
;
return
true
;
}
void
ScrollingLayersHelper
:
:
PushLayerLocalClip
(
const
StackingContextHelper
&
aStackingContext
wr
:
:
IpcResourceUpdateQueue
&
aResources
)
{
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
Maybe
<
ParentLayerRect
>
clip
;
if
(
const
Maybe
<
ParentLayerIntRect
>
&
rect
=
layer
-
>
GetClipRect
(
)
)
{
clip
=
Some
(
IntRectToRect
(
rect
.
ref
(
)
)
)
;
}
else
if
(
layer
-
>
GetMaskLayer
(
)
)
{
clip
=
Some
(
layer
-
>
GetLocalTransformTyped
(
)
.
TransformBounds
(
mLayer
-
>
Bounds
(
)
)
)
;
}
if
(
clip
)
{
Maybe
<
wr
:
:
WrImageMask
>
mask
=
mLayer
-
>
BuildWrMaskLayer
(
aStackingContext
aResources
)
;
LayerRect
clipRect
=
ViewAs
<
LayerPixel
>
(
clip
.
ref
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
mBuilder
-
>
PushClip
(
mBuilder
-
>
DefineClip
(
aStackingContext
.
ToRelativeLayoutRect
(
clipRect
)
nullptr
mask
.
ptrOr
(
nullptr
)
)
)
;
mPushedLayerLocalClip
=
true
;
}
}
void
ScrollingLayersHelper
:
:
PushLayerClip
(
const
LayerClip
&
aClip
const
StackingContextHelper
&
aSc
wr
:
:
IpcResourceUpdateQueue
&
aResources
)
{
LayerRect
clipRect
=
IntRectToRect
(
ViewAs
<
LayerPixel
>
(
aClip
.
GetClipRect
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
)
;
Maybe
<
wr
:
:
WrImageMask
>
mask
;
if
(
Maybe
<
size_t
>
maskLayerIndex
=
aClip
.
GetMaskLayerIndex
(
)
)
{
Layer
*
maskLayer
=
mLayer
-
>
GetLayer
(
)
-
>
GetAncestorMaskLayerAt
(
maskLayerIndex
.
value
(
)
)
;
WebRenderLayer
*
maskWrLayer
=
WebRenderLayer
:
:
ToWebRenderLayer
(
maskLayer
)
;
mask
=
maskWrLayer
-
>
RenderMaskLayer
(
aSc
maskLayer
-
>
GetTransform
(
)
aResources
)
;
}
mBuilder
-
>
PushClip
(
mBuilder
-
>
DefineClip
(
aSc
.
ToRelativeLayoutRect
(
clipRect
)
nullptr
mask
.
ptrOr
(
nullptr
)
)
)
;
}
ScrollingLayersHelper
:
:
~
ScrollingLayersHelper
(
)
{
if
(
!
mLayer
)
{
if
(
mPushedClipAndScroll
)
{
mBuilder
-
>
PopClipAndScrollInfo
(
)
;
}
while
(
!
mPushedClips
.
empty
(
)
)
{
wr
:
:
ScrollOrClipId
id
=
mPushedClips
.
back
(
)
;
if
(
id
.
is
<
wr
:
:
WrClipId
>
(
)
)
{
mBuilder
-
>
PopClip
(
)
;
}
else
{
MOZ_ASSERT
(
id
.
is
<
FrameMetrics
:
:
ViewID
>
(
)
)
;
mBuilder
-
>
PopScrollLayer
(
)
;
}
mPushedClips
.
pop_back
(
)
;
}
return
;
}
Layer
*
layer
=
mLayer
-
>
GetLayer
(
)
;
if
(
!
mLayer
-
>
WrManager
(
)
-
>
AsyncPanZoomEnabled
(
)
)
{
if
(
mPushedLayerLocalClip
)
{
mBuilder
-
>
PopClip
(
)
;
}
return
;
}
if
(
layer
-
>
GetIsFixedPosition
(
)
)
{
mBuilder
-
>
PopClipAndScrollInfo
(
)
;
}
else
if
(
mPushedLayerLocalClip
)
{
mBuilder
-
>
PopClip
(
)
;
}
if
(
layer
-
>
GetScrolledClip
(
)
)
{
mBuilder
-
>
PopClip
(
)
;
}
for
(
uint32_t
i
=
0
;
i
<
layer
-
>
GetScrollMetadataCount
(
)
;
i
+
+
)
{
const
FrameMetrics
&
fm
=
layer
-
>
GetFrameMetrics
(
i
)
;
if
(
fm
.
IsScrollable
(
)
)
{
mBuilder
-
>
PopScrollLayer
(
)
;
}
if
(
layer
-
>
GetIsFixedPosition
(
)
&
&
layer
-
>
GetFixedPositionScrollContainerId
(
)
=
=
fm
.
GetScrollId
(
)
&
&
mPushedLayerLocalClip
)
{
mBuilder
-
>
PopClip
(
)
;
}
const
ScrollMetadata
&
metadata
=
layer
-
>
GetScrollMetadata
(
i
)
;
if
(
metadata
.
GetScrollClip
(
)
)
{
mBuilder
-
>
PopClip
(
)
;
}
}
}
}
}
