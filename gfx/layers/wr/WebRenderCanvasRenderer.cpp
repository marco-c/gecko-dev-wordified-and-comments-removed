#
include
"
WebRenderCanvasRenderer
.
h
"
#
include
"
GLContext
.
h
"
#
include
"
GLScreenBuffer
.
h
"
#
include
"
mozilla
/
layers
/
CompositorBridgeChild
.
h
"
#
include
"
SharedSurfaceGL
.
h
"
#
include
"
WebRenderBridgeChild
.
h
"
#
include
"
WebRenderLayerManager
.
h
"
namespace
mozilla
{
namespace
layers
{
CompositableForwarder
*
WebRenderCanvasRenderer
:
:
GetForwarder
(
)
{
return
mManager
-
>
WrBridge
(
)
;
}
void
WebRenderCanvasRenderer
:
:
Initialize
(
const
CanvasInitializeData
&
aData
)
{
ShareableCanvasRenderer
:
:
Initialize
(
aData
)
;
}
WebRenderCanvasRendererAsync
:
:
~
WebRenderCanvasRendererAsync
(
)
{
Destroy
(
)
;
}
void
WebRenderCanvasRendererAsync
:
:
Initialize
(
const
CanvasInitializeData
&
aData
)
{
WebRenderCanvasRenderer
:
:
Initialize
(
aData
)
;
if
(
mPipelineId
.
isSome
(
)
)
{
mManager
-
>
WrBridge
(
)
-
>
RemovePipelineIdForCompositable
(
mPipelineId
.
ref
(
)
)
;
mPipelineId
.
reset
(
)
;
}
}
bool
WebRenderCanvasRendererAsync
:
:
CreateCompositable
(
)
{
if
(
!
mCanvasClient
)
{
TextureFlags
flags
=
TextureFlags
:
:
DEFAULT
;
if
(
mOriginPos
=
=
gl
:
:
OriginPos
:
:
BottomLeft
)
{
flags
|
=
TextureFlags
:
:
ORIGIN_BOTTOM_LEFT
;
}
if
(
!
mIsAlphaPremultiplied
)
{
flags
|
=
TextureFlags
:
:
NON_PREMULTIPLIED
;
}
mCanvasClient
=
CanvasClient
:
:
CreateCanvasClient
(
GetCanvasClientType
(
)
GetForwarder
(
)
flags
)
;
if
(
!
mCanvasClient
)
{
return
false
;
}
mCanvasClient
-
>
Connect
(
)
;
}
if
(
!
mPipelineId
)
{
mPipelineId
=
Some
(
mManager
-
>
WrBridge
(
)
-
>
GetCompositorBridgeChild
(
)
-
>
GetNextPipelineId
(
)
)
;
mManager
-
>
WrBridge
(
)
-
>
AddPipelineIdForCompositable
(
mPipelineId
.
ref
(
)
mCanvasClient
-
>
GetIPCHandle
(
)
)
;
}
return
true
;
}
void
WebRenderCanvasRendererAsync
:
:
ClearCachedResources
(
)
{
if
(
mPipelineId
.
isSome
(
)
)
{
mManager
-
>
WrBridge
(
)
-
>
RemovePipelineIdForCompositable
(
mPipelineId
.
ref
(
)
)
;
mPipelineId
.
reset
(
)
;
}
}
void
WebRenderCanvasRendererAsync
:
:
Destroy
(
)
{
if
(
mPipelineId
.
isSome
(
)
)
{
mManager
-
>
WrBridge
(
)
-
>
RemovePipelineIdForCompositable
(
mPipelineId
.
ref
(
)
)
;
mPipelineId
.
reset
(
)
;
}
}
void
WebRenderCanvasRendererAsync
:
:
UpdateCompositableClientForEmptyTransaction
(
)
{
UpdateCompositableClient
(
)
;
if
(
mPipelineId
.
isSome
(
)
)
{
mManager
-
>
WrBridge
(
)
-
>
AddWebRenderParentCommand
(
OpUpdatedAsyncImagePipeline
(
mPipelineId
.
ref
(
)
)
)
;
}
}
}
}
