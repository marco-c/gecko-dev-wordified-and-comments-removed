#
ifndef
MOZILLA_GFX_WEBRENDERIMAGEHOST_H
#
define
MOZILLA_GFX_WEBRENDERIMAGEHOST_H
#
include
<
unordered_map
>
#
include
"
CompositableHost
.
h
"
#
include
"
mozilla
/
layers
/
ImageComposite
.
h
"
#
include
"
mozilla
/
WeakPtr
.
h
"
namespace
mozilla
{
namespace
layers
{
class
AsyncImagePipelineManager
;
class
WebRenderBridgeParent
;
class
WebRenderBridgeParentRef
;
class
RemoteTextureConsumerClient
;
class
WebRenderImageHost
:
public
CompositableHost
public
ImageComposite
{
public
:
explicit
WebRenderImageHost
(
const
TextureInfo
&
aTextureInfo
)
;
virtual
~
WebRenderImageHost
(
)
;
void
UseTextureHost
(
const
nsTArray
<
TimedTexture
>
&
aTextures
)
override
;
void
UseRemoteTexture
(
const
RemoteTextureId
aTextureId
const
RemoteTextureOwnerId
aOwnerId
const
CompositableHandle
&
aHandle
const
base
:
:
ProcessId
aForPid
const
gfx
:
:
IntSize
aSize
const
TextureFlags
aFlags
)
override
;
void
RemoveTextureHost
(
TextureHost
*
aTexture
)
override
;
void
Dump
(
std
:
:
stringstream
&
aStream
const
char
*
aPrefix
=
"
"
bool
aDumpHtml
=
false
)
override
;
void
CleanupResources
(
)
override
;
void
OnReleased
(
)
override
;
uint32_t
GetDroppedFrames
(
)
override
{
return
GetDroppedFramesAndReset
(
)
;
}
WebRenderImageHost
*
AsWebRenderImageHost
(
)
override
{
return
this
;
}
TextureHost
*
GetAsTextureHostForComposite
(
AsyncImagePipelineManager
*
aAsyncImageManager
)
;
void
SetWrBridge
(
const
wr
:
:
PipelineId
&
aPipelineId
WebRenderBridgeParent
*
aWrBridge
)
;
void
ClearWrBridge
(
const
wr
:
:
PipelineId
&
aPipelineId
WebRenderBridgeParent
*
aWrBridge
)
;
TextureHost
*
GetCurrentTextureHost
(
)
{
return
mCurrentTextureHost
;
}
protected
:
TimeStamp
GetCompositionTime
(
)
const
override
;
CompositionOpportunityId
GetCompositionOpportunityId
(
)
const
override
;
void
AppendImageCompositeNotification
(
const
ImageCompositeNotificationInfo
&
aInfo
)
const
override
;
void
SetCurrentTextureHost
(
TextureHost
*
aTexture
)
;
std
:
:
unordered_map
<
uint64_t
RefPtr
<
WebRenderBridgeParentRef
>
>
mWrBridges
;
AsyncImagePipelineManager
*
mCurrentAsyncImageManager
;
CompositableTextureHostRef
mCurrentTextureHost
;
UniquePtr
<
RemoteTextureConsumerClient
>
mRemoteTextureConsumer
;
}
;
}
}
#
endif
