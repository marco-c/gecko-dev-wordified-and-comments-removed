#
include
"
WebRenderTextureHost
.
h
"
#
include
"
mozilla
/
layers
/
ImageDataSerializer
.
h
"
#
include
"
mozilla
/
layers
/
LayersSurfaces
.
h
"
#
include
"
mozilla
/
webrender
/
RenderThread
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderAPI
.
h
"
#
ifdef
MOZ_WIDGET_ANDROID
#
include
"
mozilla
/
layers
/
TextureHostOGL
.
h
"
#
endif
namespace
mozilla
:
:
layers
{
class
ScheduleHandleRenderTextureOps
:
public
wr
:
:
NotificationHandler
{
public
:
explicit
ScheduleHandleRenderTextureOps
(
)
{
}
virtual
void
Notify
(
wr
:
:
Checkpoint
aCheckpoint
)
override
{
if
(
aCheckpoint
=
=
wr
:
:
Checkpoint
:
:
FrameTexturesUpdated
)
{
MOZ_ASSERT
(
wr
:
:
RenderThread
:
:
IsInRenderThread
(
)
)
;
wr
:
:
RenderThread
:
:
Get
(
)
-
>
HandleRenderTextureOps
(
)
;
}
else
{
MOZ_ASSERT
(
aCheckpoint
=
=
wr
:
:
Checkpoint
:
:
TransactionDropped
)
;
}
}
protected
:
}
;
WebRenderTextureHost
:
:
WebRenderTextureHost
(
const
SurfaceDescriptor
&
aDesc
TextureFlags
aFlags
TextureHost
*
aTexture
wr
:
:
ExternalImageId
&
aExternalImageId
)
:
TextureHost
(
aFlags
)
mWrappedTextureHost
(
aTexture
)
{
MOZ_ASSERT
(
!
(
aFlags
&
TextureFlags
:
:
DEALLOCATE_CLIENT
)
)
;
MOZ_ASSERT
(
mWrappedTextureHost
)
;
MOZ_COUNT_CTOR
(
WebRenderTextureHost
)
;
mWrappedTextureHost
-
>
EnsureRenderTexture
(
Some
(
aExternalImageId
)
)
;
}
WebRenderTextureHost
:
:
~
WebRenderTextureHost
(
)
{
MOZ_COUNT_DTOR
(
WebRenderTextureHost
)
;
}
wr
:
:
ExternalImageId
WebRenderTextureHost
:
:
GetExternalImageKey
(
)
{
MOZ_ASSERT
(
mWrappedTextureHost
-
>
mExternalImageId
.
isSome
(
)
)
;
return
mWrappedTextureHost
-
>
mExternalImageId
.
ref
(
)
;
}
bool
WebRenderTextureHost
:
:
Lock
(
)
{
MOZ_ASSERT
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
;
if
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
{
return
mWrappedTextureHost
-
>
Lock
(
)
;
}
return
false
;
}
void
WebRenderTextureHost
:
:
Unlock
(
)
{
MOZ_ASSERT
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
;
if
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
{
mWrappedTextureHost
-
>
Unlock
(
)
;
}
}
void
WebRenderTextureHost
:
:
PrepareTextureSource
(
CompositableTextureSourceRef
&
aTexture
)
{
MOZ_ASSERT
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
;
if
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
{
mWrappedTextureHost
-
>
PrepareTextureSource
(
aTexture
)
;
}
}
bool
WebRenderTextureHost
:
:
BindTextureSource
(
CompositableTextureSourceRef
&
aTexture
)
{
MOZ_ASSERT
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
;
if
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
{
return
mWrappedTextureHost
-
>
BindTextureSource
(
aTexture
)
;
}
return
false
;
}
void
WebRenderTextureHost
:
:
UnbindTextureSource
(
)
{
if
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
{
mWrappedTextureHost
-
>
UnbindTextureSource
(
)
;
}
TextureHost
:
:
UnbindTextureSource
(
)
;
}
void
WebRenderTextureHost
:
:
SetTextureSourceProvider
(
TextureSourceProvider
*
aProvider
)
{
MOZ_ASSERT
(
!
aProvider
|
|
aProvider
-
>
AsBasicCompositor
(
)
)
;
MOZ_ASSERT
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
;
if
(
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
{
mWrappedTextureHost
-
>
SetTextureSourceProvider
(
aProvider
)
;
}
}
already_AddRefed
<
gfx
:
:
DataSourceSurface
>
WebRenderTextureHost
:
:
GetAsSurface
(
)
{
return
mWrappedTextureHost
-
>
GetAsSurface
(
)
;
}
gfx
:
:
YUVColorSpace
WebRenderTextureHost
:
:
GetYUVColorSpace
(
)
const
{
return
mWrappedTextureHost
-
>
GetYUVColorSpace
(
)
;
}
gfx
:
:
ColorRange
WebRenderTextureHost
:
:
GetColorRange
(
)
const
{
return
mWrappedTextureHost
-
>
GetColorRange
(
)
;
}
gfx
:
:
IntSize
WebRenderTextureHost
:
:
GetSize
(
)
const
{
return
mWrappedTextureHost
-
>
GetSize
(
)
;
}
gfx
:
:
SurfaceFormat
WebRenderTextureHost
:
:
GetFormat
(
)
const
{
return
mWrappedTextureHost
-
>
GetFormat
(
)
;
}
void
WebRenderTextureHost
:
:
NotifyNotUsed
(
)
{
#
ifdef
MOZ_WIDGET_ANDROID
if
(
mWrappedTextureHost
-
>
AsSurfaceTextureHost
(
)
)
{
wr
:
:
RenderThread
:
:
Get
(
)
-
>
NotifyNotUsed
(
wr
:
:
AsUint64
(
GetExternalImageKey
(
)
)
)
;
}
#
endif
TextureHost
:
:
NotifyNotUsed
(
)
;
}
void
WebRenderTextureHost
:
:
MaybeNotifyForUse
(
wr
:
:
TransactionBuilder
&
aTxn
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mWrappedTextureHost
-
>
AsSurfaceTextureHost
(
)
)
{
wr
:
:
RenderThread
:
:
Get
(
)
-
>
NotifyForUse
(
wr
:
:
AsUint64
(
GetExternalImageKey
(
)
)
)
;
aTxn
.
Notify
(
wr
:
:
Checkpoint
:
:
FrameTexturesUpdated
MakeUnique
<
ScheduleHandleRenderTextureOps
>
(
)
)
;
}
#
endif
}
void
WebRenderTextureHost
:
:
PrepareForUse
(
)
{
if
(
mWrappedTextureHost
-
>
AsSurfaceTextureHost
(
)
|
|
mWrappedTextureHost
-
>
AsBufferTextureHost
(
)
)
{
wr
:
:
RenderThread
:
:
Get
(
)
-
>
PrepareForUse
(
wr
:
:
AsUint64
(
GetExternalImageKey
(
)
)
)
;
}
}
gfx
:
:
SurfaceFormat
WebRenderTextureHost
:
:
GetReadFormat
(
)
const
{
return
mWrappedTextureHost
-
>
GetReadFormat
(
)
;
}
int32_t
WebRenderTextureHost
:
:
GetRGBStride
(
)
{
gfx
:
:
SurfaceFormat
format
=
GetFormat
(
)
;
if
(
GetFormat
(
)
=
=
gfx
:
:
SurfaceFormat
:
:
YUV
)
{
return
gfx
:
:
GetAlignedStride
<
16
>
(
GetSize
(
)
.
width
BytesPerPixel
(
gfx
:
:
SurfaceFormat
:
:
B8G8R8A8
)
)
;
}
return
ImageDataSerializer
:
:
ComputeRGBStride
(
format
GetSize
(
)
.
width
)
;
}
bool
WebRenderTextureHost
:
:
HasIntermediateBuffer
(
)
const
{
return
mWrappedTextureHost
-
>
HasIntermediateBuffer
(
)
;
}
bool
WebRenderTextureHost
:
:
NeedsDeferredDeletion
(
)
const
{
return
mWrappedTextureHost
-
>
NeedsDeferredDeletion
(
)
;
}
uint32_t
WebRenderTextureHost
:
:
NumSubTextures
(
)
{
return
mWrappedTextureHost
-
>
NumSubTextures
(
)
;
}
void
WebRenderTextureHost
:
:
PushResourceUpdates
(
wr
:
:
TransactionBuilder
&
aResources
ResourceUpdateOp
aOp
const
Range
<
wr
:
:
ImageKey
>
&
aImageKeys
const
wr
:
:
ExternalImageId
&
aExtID
)
{
MOZ_ASSERT
(
GetExternalImageKey
(
)
=
=
aExtID
)
;
mWrappedTextureHost
-
>
PushResourceUpdates
(
aResources
aOp
aImageKeys
aExtID
)
;
}
void
WebRenderTextureHost
:
:
PushDisplayItems
(
wr
:
:
DisplayListBuilder
&
aBuilder
const
wr
:
:
LayoutRect
&
aBounds
const
wr
:
:
LayoutRect
&
aClip
wr
:
:
ImageRendering
aFilter
const
Range
<
wr
:
:
ImageKey
>
&
aImageKeys
const
bool
aPreferCompositorSurface
)
{
MOZ_ASSERT
(
aImageKeys
.
length
(
)
>
0
)
;
mWrappedTextureHost
-
>
PushDisplayItems
(
aBuilder
aBounds
aClip
aFilter
aImageKeys
aPreferCompositorSurface
)
;
}
bool
WebRenderTextureHost
:
:
NeedsYFlip
(
)
const
{
bool
yFlip
=
TextureHost
:
:
NeedsYFlip
(
)
;
if
(
mWrappedTextureHost
-
>
AsSurfaceTextureHost
(
)
)
{
MOZ_ASSERT
(
yFlip
)
;
yFlip
=
false
;
}
return
yFlip
;
}
}
