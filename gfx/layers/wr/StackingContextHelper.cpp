#
include
"
mozilla
/
layers
/
StackingContextHelper
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
gfx
/
Matrix
.
h
"
#
include
"
UnitTransforms
.
h
"
#
include
"
nsDisplayList
.
h
"
#
include
"
mozilla
/
dom
/
BrowserChild
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
ActiveLayerTracker
.
h
"
namespace
mozilla
{
namespace
layers
{
using
namespace
gfx
;
StackingContextHelper
:
:
StackingContextHelper
(
)
:
mBuilder
(
nullptr
)
mScale
(
1
.
0f
1
.
0f
)
mAffectsClipPositioning
(
false
)
mDeferredTransformItem
(
nullptr
)
mRasterizeLocally
(
false
)
{
}
static
nsSize
ComputeDesiredDisplaySizeForAnimation
(
nsIFrame
*
aContainerFrame
)
{
nsPresContext
*
presContext
=
aContainerFrame
-
>
PresContext
(
)
;
nsIWidget
*
widget
=
aContainerFrame
-
>
GetNearestWidget
(
)
;
if
(
widget
)
{
return
LayoutDevicePixel
:
:
ToAppUnits
(
widget
-
>
GetClientSize
(
)
presContext
-
>
AppUnitsPerDevPixel
(
)
)
;
}
return
presContext
-
>
GetVisibleArea
(
)
.
Size
(
)
;
}
Size
ChooseScale
(
nsIFrame
*
aContainerFrame
nsDisplayItem
*
aContainerItem
const
nsRect
&
aVisibleRect
float
aXScale
float
aYScale
const
Matrix
&
aTransform2d
bool
aCanDraw2D
)
{
Size
scale
;
if
(
aCanDraw2D
&
&
!
aContainerFrame
-
>
Combines3DTransformWithAncestors
(
)
&
&
!
aContainerFrame
-
>
HasPerspective
(
)
)
{
if
(
aContainerItem
&
&
aContainerItem
-
>
GetType
(
)
=
=
DisplayItemType
:
:
TYPE_TRANSFORM
&
&
EffectCompositor
:
:
HasAnimationsForCompositor
(
aContainerFrame
DisplayItemType
:
:
TYPE_TRANSFORM
)
)
{
nsSize
displaySize
=
ComputeDesiredDisplaySizeForAnimation
(
aContainerFrame
)
;
nsSize
scaledVisibleSize
=
nsSize
(
aVisibleRect
.
Width
(
)
*
aXScale
aVisibleRect
.
Height
(
)
*
aYScale
)
;
scale
=
nsLayoutUtils
:
:
ComputeSuitableScaleForAnimation
(
aContainerFrame
scaledVisibleSize
displaySize
)
;
float
incomingScale
=
std
:
:
max
(
aXScale
aYScale
)
;
scale
.
width
*
=
incomingScale
;
scale
.
height
*
=
incomingScale
;
}
else
{
scale
=
aTransform2d
.
ScaleFactors
(
)
;
Matrix
frameTransform
;
if
(
ActiveLayerTracker
:
:
IsScaleSubjectToAnimation
(
aContainerFrame
)
)
{
scale
.
width
=
gfxUtils
:
:
ClampToScaleFactor
(
scale
.
width
)
;
scale
.
height
=
gfxUtils
:
:
ClampToScaleFactor
(
scale
.
height
)
;
nsSize
maxScale
(
4
4
)
;
if
(
!
aVisibleRect
.
IsEmpty
(
)
)
{
nsSize
displaySize
=
ComputeDesiredDisplaySizeForAnimation
(
aContainerFrame
)
;
maxScale
=
Max
(
maxScale
displaySize
/
aVisibleRect
.
Size
(
)
)
;
}
if
(
scale
.
width
>
maxScale
.
width
)
{
scale
.
width
=
gfxUtils
:
:
ClampToScaleFactor
(
maxScale
.
width
true
)
;
}
if
(
scale
.
height
>
maxScale
.
height
)
{
scale
.
height
=
gfxUtils
:
:
ClampToScaleFactor
(
maxScale
.
height
true
)
;
}
}
else
{
}
}
if
(
fabs
(
scale
.
width
)
<
1e
-
8
|
|
fabs
(
scale
.
height
)
<
1e
-
8
)
{
scale
=
Size
(
1
.
0
1
.
0
)
;
}
}
else
{
scale
=
Size
(
1
.
0
1
.
0
)
;
}
scale
=
Size
(
std
:
:
min
(
scale
.
width
32768
.
0f
)
std
:
:
min
(
scale
.
height
32768
.
0f
)
)
;
return
scale
;
}
StackingContextHelper
:
:
StackingContextHelper
(
const
StackingContextHelper
&
aParentSC
const
ActiveScrolledRoot
*
aAsr
nsIFrame
*
aContainerFrame
nsDisplayItem
*
aContainerItem
wr
:
:
DisplayListBuilder
&
aBuilder
const
wr
:
:
StackingContextParams
&
aParams
const
LayoutDeviceRect
&
aBounds
)
:
mBuilder
(
&
aBuilder
)
mScale
(
1
.
0f
1
.
0f
)
mDeferredTransformItem
(
aParams
.
mDeferredTransformItem
)
mRasterizeLocally
(
aParams
.
mRasterizeLocally
)
{
MOZ_ASSERT
(
!
aContainerItem
|
|
aContainerItem
-
>
CreatesStackingContextHelper
(
)
)
;
mOrigin
=
aParentSC
.
mOrigin
+
aBounds
.
TopLeft
(
)
;
if
(
aParams
.
mBoundTransform
)
{
gfx
:
:
Matrix
transform2d
;
bool
canDraw2D
=
aParams
.
mBoundTransform
-
>
CanDraw2D
(
&
transform2d
)
;
if
(
canDraw2D
&
&
aParams
.
reference_frame_kind
!
=
wr
:
:
WrReferenceFrameKind
:
:
Perspective
&
&
!
aContainerFrame
-
>
Combines3DTransformWithAncestors
(
)
)
{
mInheritedTransform
=
transform2d
*
aParentSC
.
mInheritedTransform
;
int32_t
apd
=
aContainerFrame
-
>
PresContext
(
)
-
>
AppUnitsPerDevPixel
(
)
;
nsRect
r
=
LayoutDevicePixel
:
:
ToAppUnits
(
aBounds
apd
)
;
mScale
=
ChooseScale
(
aContainerFrame
aContainerItem
r
aParentSC
.
mScale
.
width
aParentSC
.
mScale
.
height
mInheritedTransform
true
)
;
}
else
{
mScale
=
gfx
:
:
Size
(
1
.
0f
1
.
0f
)
;
mInheritedTransform
=
gfx
:
:
Matrix
:
:
Scaling
(
1
.
f
1
.
f
)
;
}
if
(
aParams
.
mAnimated
)
{
mSnappingSurfaceTransform
=
gfx
:
:
Matrix
:
:
Scaling
(
mScale
.
width
mScale
.
height
)
;
}
else
{
mSnappingSurfaceTransform
=
transform2d
*
aParentSC
.
mSnappingSurfaceTransform
;
}
}
else
if
(
aParams
.
reference_frame_kind
=
=
wr
:
:
WrReferenceFrameKind
:
:
Transform
&
&
aContainerItem
&
&
aContainerItem
-
>
GetType
(
)
=
=
DisplayItemType
:
:
TYPE_ASYNC_ZOOM
&
&
aContainerItem
-
>
Frame
(
)
)
{
double
resolution
=
aContainerItem
-
>
Frame
(
)
-
>
PresShell
(
)
-
>
GetResolution
(
)
;
gfx
:
:
Matrix
transform
=
gfx
:
:
Matrix
:
:
Scaling
(
resolution
resolution
)
;
mInheritedTransform
=
transform
*
aParentSC
.
mInheritedTransform
;
mScale
=
resolution
*
aParentSC
.
mScale
;
MOZ_ASSERT
(
!
aParams
.
mAnimated
)
;
mSnappingSurfaceTransform
=
transform
*
aParentSC
.
mSnappingSurfaceTransform
;
}
else
if
(
!
aAsr
&
&
!
aContainerFrame
&
&
!
aContainerItem
&
&
aParams
.
mRootReferenceFrame
)
{
float
resolutionX
=
1
.
f
;
float
resolutionY
=
1
.
f
;
if
(
mozilla
:
:
dom
:
:
BrowserChild
*
browserChild
=
mozilla
:
:
dom
:
:
BrowserChild
:
:
GetFrom
(
aParams
.
mRootReferenceFrame
-
>
PresShell
(
)
)
)
{
resolutionX
*
=
browserChild
-
>
GetEffectsInfo
(
)
.
mScaleX
;
resolutionY
*
=
browserChild
-
>
GetEffectsInfo
(
)
.
mScaleY
;
}
gfx
:
:
Matrix
transform
=
gfx
:
:
Matrix
:
:
Scaling
(
resolutionX
resolutionY
)
;
mInheritedTransform
=
transform
*
aParentSC
.
mInheritedTransform
;
mScale
=
gfx
:
:
Size
(
aParentSC
.
mScale
.
width
*
resolutionX
aParentSC
.
mScale
.
height
*
resolutionY
)
;
MOZ_ASSERT
(
!
aParams
.
mAnimated
)
;
mSnappingSurfaceTransform
=
transform
*
aParentSC
.
mSnappingSurfaceTransform
;
}
else
{
mInheritedTransform
=
aParentSC
.
mInheritedTransform
;
mScale
=
aParentSC
.
mScale
;
}
auto
rasterSpace
=
mRasterizeLocally
?
wr
:
:
RasterSpace
:
:
Local
(
std
:
:
max
(
mScale
.
width
mScale
.
height
)
)
:
wr
:
:
RasterSpace
:
:
Screen
(
)
;
MOZ_ASSERT
(
!
aParams
.
clip
.
IsNone
(
)
)
;
mReferenceFrameId
=
mBuilder
-
>
PushStackingContext
(
aParams
wr
:
:
ToLayoutRect
(
aBounds
)
rasterSpace
)
;
if
(
mReferenceFrameId
)
{
mSpaceAndClipChainHelper
.
emplace
(
aBuilder
mReferenceFrameId
.
ref
(
)
)
;
}
mAffectsClipPositioning
=
mReferenceFrameId
.
isSome
(
)
|
|
(
aBounds
.
TopLeft
(
)
!
=
LayoutDevicePoint
(
)
)
;
if
(
aParentSC
.
mDeferredTransformItem
&
&
aAsr
=
=
aParentSC
.
mDeferredTransformItem
-
>
GetActiveScrolledRoot
(
)
)
{
if
(
mDeferredTransformItem
)
{
mDeferredAncestorTransform
=
aParentSC
.
GetDeferredTransformMatrix
(
)
;
}
else
{
mDeferredTransformItem
=
aParentSC
.
mDeferredTransformItem
;
mDeferredAncestorTransform
=
aParentSC
.
mDeferredAncestorTransform
;
}
}
}
StackingContextHelper
:
:
~
StackingContextHelper
(
)
{
if
(
mBuilder
)
{
mSpaceAndClipChainHelper
.
reset
(
)
;
mBuilder
-
>
PopStackingContext
(
mReferenceFrameId
.
isSome
(
)
)
;
}
}
nsDisplayTransform
*
StackingContextHelper
:
:
GetDeferredTransformItem
(
)
const
{
return
mDeferredTransformItem
;
}
Maybe
<
gfx
:
:
Matrix4x4
>
StackingContextHelper
:
:
GetDeferredTransformMatrix
(
)
const
{
if
(
mDeferredTransformItem
)
{
gfx
:
:
Matrix4x4
result
=
mDeferredTransformItem
-
>
GetTransform
(
)
.
GetMatrix
(
)
;
if
(
mDeferredAncestorTransform
)
{
result
=
result
*
*
mDeferredAncestorTransform
;
}
return
Some
(
result
)
;
}
else
{
return
Nothing
(
)
;
}
}
}
}
