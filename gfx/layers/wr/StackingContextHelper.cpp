#
include
"
mozilla
/
layers
/
StackingContextHelper
.
h
"
#
include
"
UnitTransforms
.
h
"
#
include
"
nsDisplayList
.
h
"
namespace
mozilla
{
namespace
layers
{
StackingContextHelper
:
:
StackingContextHelper
(
)
:
mBuilder
(
nullptr
)
mScale
(
1
.
0f
1
.
0f
)
mIsPreserve3D
(
false
)
mRasterizeLocally
(
false
)
{
}
StackingContextHelper
:
:
StackingContextHelper
(
const
StackingContextHelper
&
aParentSC
const
ActiveScrolledRoot
*
aAsr
wr
:
:
DisplayListBuilder
&
aBuilder
const
nsTArray
<
wr
:
:
WrFilterOp
>
&
aFilters
const
gfx
:
:
Matrix4x4
*
aBoundTransform
const
wr
:
:
WrAnimationProperty
*
aAnimation
const
float
*
aOpacityPtr
const
LayoutDevicePoint
&
aOrigin
const
gfx
:
:
Matrix4x4
*
aTransformPtr
const
gfx
:
:
Matrix4x4
*
aPerspectivePtr
const
gfx
:
:
CompositionOp
&
aMixBlendMode
bool
aBackfaceVisible
bool
aIsPreserve3D
const
Maybe
<
nsDisplayTransform
*
>
&
aDeferredTransformItem
const
wr
:
:
WrClipId
*
aClipNodeId
bool
aAnimated
)
:
mBuilder
(
&
aBuilder
)
mScale
(
1
.
0f
1
.
0f
)
mInheritedStickyOrigin
(
aOrigin
)
mDeferredTransformItem
(
aDeferredTransformItem
)
mIsPreserve3D
(
aIsPreserve3D
)
mRasterizeLocally
(
aAnimated
|
|
aParentSC
.
mRasterizeLocally
)
{
if
(
aOrigin
!
=
LayoutDevicePoint
(
)
)
{
mOriginFrameId
=
Some
(
mBuilder
-
>
PushOrigin
(
wr
:
:
ToLayoutPoint
(
aOrigin
)
)
)
;
}
gfx
:
:
Matrix
transform2d
;
if
(
aBoundTransform
&
&
aBoundTransform
-
>
CanDraw2D
(
&
transform2d
)
&
&
!
aPerspectivePtr
&
&
!
aParentSC
.
mIsPreserve3D
)
{
mInheritedTransform
=
transform2d
*
aParentSC
.
mInheritedTransform
;
mScale
=
mInheritedTransform
.
ScaleFactors
(
true
)
;
if
(
aAnimated
)
{
mSnappingSurfaceTransform
=
gfx
:
:
Matrix
:
:
Scaling
(
mScale
.
width
mScale
.
height
)
;
}
else
{
mSnappingSurfaceTransform
=
transform2d
*
aParentSC
.
mSnappingSurfaceTransform
;
}
}
else
{
mInheritedTransform
=
aParentSC
.
mInheritedTransform
;
mScale
=
aParentSC
.
mScale
;
}
auto
rasterSpace
=
mRasterizeLocally
?
wr
:
:
RasterSpace
:
:
Local
(
std
:
:
max
(
mScale
.
width
mScale
.
height
)
)
:
wr
:
:
RasterSpace
:
:
Screen
(
)
;
mReferenceFrameId
=
mBuilder
-
>
PushStackingContext
(
aClipNodeId
aAnimation
aOpacityPtr
aTransformPtr
aIsPreserve3D
?
wr
:
:
TransformStyle
:
:
Preserve3D
:
wr
:
:
TransformStyle
:
:
Flat
aPerspectivePtr
wr
:
:
ToMixBlendMode
(
aMixBlendMode
)
aFilters
aBackfaceVisible
rasterSpace
)
;
if
(
aParentSC
.
mDeferredTransformItem
&
&
aAsr
=
=
(
*
aParentSC
.
mDeferredTransformItem
)
-
>
GetActiveScrolledRoot
(
)
)
{
if
(
mDeferredTransformItem
)
{
mDeferredAncestorTransform
=
aParentSC
.
GetDeferredTransformMatrix
(
)
;
}
else
{
mDeferredTransformItem
=
aParentSC
.
mDeferredTransformItem
;
mDeferredAncestorTransform
=
aParentSC
.
mDeferredAncestorTransform
;
}
}
if
(
!
mReferenceFrameId
)
{
mInheritedStickyOrigin
+
=
aParentSC
.
mInheritedStickyOrigin
;
}
}
StackingContextHelper
:
:
~
StackingContextHelper
(
)
{
if
(
mBuilder
)
{
mBuilder
-
>
PopStackingContext
(
mReferenceFrameId
.
isSome
(
)
)
;
if
(
mOriginFrameId
)
{
mBuilder
-
>
PopOrigin
(
)
;
}
}
}
Maybe
<
wr
:
:
WrClipId
>
StackingContextHelper
:
:
ReferenceFrameId
(
)
const
{
return
mReferenceFrameId
?
mReferenceFrameId
:
mOriginFrameId
;
}
const
Maybe
<
nsDisplayTransform
*
>
&
StackingContextHelper
:
:
GetDeferredTransformItem
(
)
const
{
return
mDeferredTransformItem
;
}
Maybe
<
gfx
:
:
Matrix4x4
>
StackingContextHelper
:
:
GetDeferredTransformMatrix
(
)
const
{
if
(
mDeferredTransformItem
)
{
gfx
:
:
Matrix4x4
result
=
(
*
mDeferredTransformItem
)
-
>
GetTransform
(
)
.
GetMatrix
(
)
;
if
(
mDeferredAncestorTransform
)
{
result
=
*
mDeferredAncestorTransform
*
result
;
}
return
Some
(
result
)
;
}
else
{
return
Nothing
(
)
;
}
}
}
}
