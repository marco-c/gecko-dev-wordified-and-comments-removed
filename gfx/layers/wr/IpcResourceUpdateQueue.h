#
ifndef
GFX_WR_IPCRESOURCEUPDATEQUEUE_H
#
define
GFX_WR_IPCRESOURCEUPDATEQUEUE_H
#
include
"
mozilla
/
layers
/
WebRenderMessages
.
h
"
#
include
"
mozilla
/
layers
/
RefCountedShmem
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderTypes
.
h
"
namespace
mozilla
{
namespace
ipc
{
class
IShmemAllocator
;
}
namespace
wr
{
class
ShmSegmentsWriter
{
public
:
ShmSegmentsWriter
(
layers
:
:
WebRenderBridgeChild
*
aAllocator
size_t
aChunkSize
)
;
~
ShmSegmentsWriter
(
)
;
layers
:
:
OffsetRange
Write
(
Range
<
uint8_t
>
aBytes
)
;
template
<
typename
T
>
layers
:
:
OffsetRange
WriteAsBytes
(
Range
<
T
>
aValues
)
{
return
Write
(
Range
<
uint8_t
>
(
(
uint8_t
*
)
aValues
.
begin
(
)
.
get
(
)
aValues
.
length
(
)
*
sizeof
(
T
)
)
)
;
}
void
Flush
(
nsTArray
<
layers
:
:
RefCountedShmem
>
&
aSmallAllocs
nsTArray
<
ipc
:
:
Shmem
>
&
aLargeAllocs
)
;
void
Clear
(
)
;
bool
IsEmpty
(
)
const
;
layers
:
:
WebRenderBridgeChild
*
WrBridge
(
)
const
{
return
mShmAllocator
;
}
protected
:
bool
AllocChunk
(
)
;
layers
:
:
OffsetRange
AllocLargeChunk
(
size_t
aSize
)
;
nsTArray
<
layers
:
:
RefCountedShmem
>
mSmallAllocs
;
nsTArray
<
ipc
:
:
Shmem
>
mLargeAllocs
;
layers
:
:
WebRenderBridgeChild
*
mShmAllocator
;
size_t
mCursor
;
size_t
mChunkSize
;
}
;
class
ShmSegmentsReader
{
public
:
ShmSegmentsReader
(
const
nsTArray
<
layers
:
:
RefCountedShmem
>
&
aSmallShmems
const
nsTArray
<
ipc
:
:
Shmem
>
&
aLargeShmems
)
;
bool
Read
(
const
layers
:
:
OffsetRange
&
aRange
wr
:
:
Vec
<
uint8_t
>
&
aInto
)
;
protected
:
bool
ReadLarge
(
const
layers
:
:
OffsetRange
&
aRange
wr
:
:
Vec
<
uint8_t
>
&
aInto
)
;
const
nsTArray
<
layers
:
:
RefCountedShmem
>
&
mSmallAllocs
;
const
nsTArray
<
ipc
:
:
Shmem
>
&
mLargeAllocs
;
size_t
mChunkSize
;
}
;
class
IpcResourceUpdateQueue
{
public
:
explicit
IpcResourceUpdateQueue
(
layers
:
:
WebRenderBridgeChild
*
aAllocator
size_t
aChunkSize
=
57328
)
;
bool
AddImage
(
wr
:
:
ImageKey
aKey
const
ImageDescriptor
&
aDescriptor
Range
<
uint8_t
>
aBytes
)
;
bool
AddBlobImage
(
wr
:
:
ImageKey
aKey
const
ImageDescriptor
&
aDescriptor
Range
<
uint8_t
>
aBytes
)
;
void
AddExternalImage
(
wr
:
:
ExternalImageId
aExtId
wr
:
:
ImageKey
aKey
)
;
void
PushExternalImageForTexture
(
wr
:
:
ExternalImageId
aExtId
wr
:
:
ImageKey
aKey
layers
:
:
TextureClient
*
aTexture
bool
aIsUpdate
)
;
bool
UpdateImageBuffer
(
wr
:
:
ImageKey
aKey
const
ImageDescriptor
&
aDescriptor
Range
<
uint8_t
>
aBytes
)
;
bool
UpdateBlobImage
(
wr
:
:
ImageKey
aKey
const
ImageDescriptor
&
aDescriptor
Range
<
uint8_t
>
aBytes
ImageIntRect
aDirtyRect
)
;
void
UpdateExternalImage
(
ExternalImageId
aExtID
ImageKey
aKey
ImageIntRect
aDirtyRect
)
;
void
SetImageVisibleArea
(
ImageKey
aKey
const
gfx
:
:
Rect
&
aArea
)
;
void
DeleteImage
(
wr
:
:
ImageKey
aKey
)
;
bool
AddRawFont
(
wr
:
:
FontKey
aKey
Range
<
uint8_t
>
aBytes
uint32_t
aIndex
)
;
bool
AddFontDescriptor
(
wr
:
:
FontKey
aKey
Range
<
uint8_t
>
aBytes
uint32_t
aIndex
)
;
void
DeleteFont
(
wr
:
:
FontKey
aKey
)
;
void
AddFontInstance
(
wr
:
:
FontInstanceKey
aKey
wr
:
:
FontKey
aFontKey
float
aGlyphSize
const
wr
:
:
FontInstanceOptions
*
aOptions
const
wr
:
:
FontInstancePlatformOptions
*
aPlatformOptions
Range
<
const
gfx
:
:
FontVariation
>
aVariations
)
;
void
DeleteFontInstance
(
wr
:
:
FontInstanceKey
aKey
)
;
void
Clear
(
)
;
void
Flush
(
nsTArray
<
layers
:
:
OpUpdateResource
>
&
aUpdates
nsTArray
<
layers
:
:
RefCountedShmem
>
&
aSmallAllocs
nsTArray
<
ipc
:
:
Shmem
>
&
aLargeAllocs
)
;
bool
IsEmpty
(
)
const
;
static
void
ReleaseShmems
(
ipc
:
:
IProtocol
*
nsTArray
<
layers
:
:
RefCountedShmem
>
&
aShmems
)
;
static
void
ReleaseShmems
(
ipc
:
:
IProtocol
*
nsTArray
<
ipc
:
:
Shmem
>
&
aShmems
)
;
protected
:
ShmSegmentsWriter
mWriter
;
nsTArray
<
layers
:
:
OpUpdateResource
>
mUpdates
;
}
;
}
}
#
endif
