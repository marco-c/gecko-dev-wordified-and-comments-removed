#
include
"
WebRenderUserData
.
h
"
namespace
mozilla
{
namespace
layers
{
WebRenderBridgeChild
*
WebRenderUserData
:
:
WrBridge
(
)
const
{
return
mWRManager
-
>
WrBridge
(
)
;
}
WebRenderImageData
:
:
WebRenderImageData
(
WebRenderLayerManager
*
aWRManager
)
:
WebRenderUserData
(
aWRManager
)
{
}
WebRenderImageData
:
:
~
WebRenderImageData
(
)
{
if
(
mKey
)
{
mWRManager
-
>
AddImageKeyForDiscard
(
mKey
.
value
(
)
)
;
}
if
(
mExternalImageId
)
{
WrBridge
(
)
-
>
DeallocExternalImageId
(
mExternalImageId
.
ref
(
)
)
;
}
if
(
mPipelineId
)
{
WrBridge
(
)
-
>
RemovePipelineIdForAsyncCompositable
(
mPipelineId
.
ref
(
)
)
;
}
}
Maybe
<
wr
:
:
ImageKey
>
WebRenderImageData
:
:
UpdateImageKey
(
ImageContainer
*
aContainer
)
{
CreateImageClientIfNeeded
(
)
;
CreateExternalImageIfNeeded
(
)
;
if
(
!
mImageClient
|
|
!
mExternalImageId
)
{
return
Nothing
(
)
;
}
MOZ_ASSERT
(
mImageClient
-
>
AsImageClientSingle
(
)
)
;
MOZ_ASSERT
(
aContainer
)
;
ImageClientSingle
*
imageClient
=
mImageClient
-
>
AsImageClientSingle
(
)
;
uint32_t
oldCounter
=
imageClient
-
>
GetLastUpdateGenerationCounter
(
)
;
bool
ret
=
imageClient
-
>
UpdateImage
(
aContainer
0
)
;
if
(
!
ret
|
|
imageClient
-
>
IsEmpty
(
)
)
{
if
(
mKey
)
{
mWRManager
-
>
AddImageKeyForDiscard
(
mKey
.
value
(
)
)
;
mKey
=
Nothing
(
)
;
}
return
Nothing
(
)
;
}
if
(
oldCounter
=
=
imageClient
-
>
GetLastUpdateGenerationCounter
(
)
&
&
mKey
)
{
return
mKey
;
}
if
(
mKey
)
{
mWRManager
-
>
AddImageKeyForDiscard
(
mKey
.
value
(
)
)
;
}
WrImageKey
key
=
WrBridge
(
)
-
>
GetNextImageKey
(
)
;
mWRManager
-
>
WrBridge
(
)
-
>
AddWebRenderParentCommand
(
OpAddExternalImage
(
mExternalImageId
.
value
(
)
key
)
)
;
mKey
=
Some
(
key
)
;
return
mKey
;
}
void
WebRenderImageData
:
:
CreateAsyncImageWebRenderCommands
(
mozilla
:
:
wr
:
:
DisplayListBuilder
&
aBuilder
ImageContainer
*
aContainer
const
StackingContextHelper
&
aSc
const
LayerRect
&
aBounds
const
LayerRect
&
aSCBounds
const
Matrix4x4
&
aSCTransform
const
MaybeIntSize
&
aScaleToSize
const
WrImageRendering
&
aFilter
const
WrMixBlendMode
&
aMixBlendMode
)
{
MOZ_ASSERT
(
aContainer
-
>
IsAsync
(
)
)
;
if
(
!
mPipelineId
)
{
mPipelineId
=
Some
(
WrBridge
(
)
-
>
GetCompositorBridgeChild
(
)
-
>
GetNextPipelineId
(
)
)
;
WrBridge
(
)
-
>
AddPipelineIdForAsyncCompositable
(
mPipelineId
.
ref
(
)
aContainer
-
>
GetAsyncContainerHandle
(
)
)
;
}
MOZ_ASSERT
(
!
mImageClient
)
;
MOZ_ASSERT
(
!
mExternalImageId
)
;
WrRect
r
=
aSc
.
ToRelativeWrRect
(
aBounds
)
;
aBuilder
.
PushIFrame
(
r
r
mPipelineId
.
ref
(
)
)
;
WrBridge
(
)
-
>
AddWebRenderParentCommand
(
OpUpdateAsyncImagePipeline
(
mPipelineId
.
value
(
)
aSCBounds
aSCTransform
aScaleToSize
aFilter
aMixBlendMode
)
)
;
}
void
WebRenderImageData
:
:
CreateImageClientIfNeeded
(
)
{
if
(
!
mImageClient
)
{
mImageClient
=
ImageClient
:
:
CreateImageClient
(
CompositableType
:
:
IMAGE
WrBridge
(
)
TextureFlags
:
:
DEFAULT
)
;
if
(
!
mImageClient
)
{
return
;
}
mImageClient
-
>
Connect
(
)
;
}
}
void
WebRenderImageData
:
:
CreateExternalImageIfNeeded
(
)
{
if
(
!
mExternalImageId
)
{
mExternalImageId
=
Some
(
WrBridge
(
)
-
>
AllocExternalImageIdForCompositable
(
mImageClient
)
)
;
}
}
}
}
