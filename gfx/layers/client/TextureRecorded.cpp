#
include
"
TextureRecorded
.
h
"
#
include
"
mozilla
/
gfx
/
DrawTargetRecording
.
h
"
#
include
"
mozilla
/
layers
/
CompositableForwarder
.
h
"
#
include
"
RecordedCanvasEventImpl
.
h
"
namespace
mozilla
{
namespace
layers
{
static
int64_t
sNextRecordedTextureId
=
0
;
RecordedTextureData
:
:
RecordedTextureData
(
already_AddRefed
<
CanvasChild
>
aCanvasChild
gfx
:
:
IntSize
aSize
gfx
:
:
SurfaceFormat
aFormat
TextureType
aTextureType
TextureType
aWebglTextureType
)
:
mCanvasChild
(
aCanvasChild
)
mSize
(
aSize
)
mFormat
(
aFormat
)
{
}
RecordedTextureData
:
:
~
RecordedTextureData
(
)
{
mSnapshot
=
nullptr
;
DetachSnapshotWrapper
(
)
;
mDT
=
nullptr
;
mCanvasChild
-
>
CleanupTexture
(
mTextureId
)
;
mCanvasChild
-
>
RecordEvent
(
RecordedTextureDestruction
(
mTextureId
ToRemoteTextureTxnType
(
mFwdTransactionTracker
)
ToRemoteTextureTxnId
(
mFwdTransactionTracker
)
)
)
;
}
void
RecordedTextureData
:
:
FillInfo
(
TextureData
:
:
Info
&
aInfo
)
const
{
aInfo
.
size
=
mSize
;
aInfo
.
format
=
mFormat
;
aInfo
.
supportsMoz2D
=
true
;
aInfo
.
hasSynchronization
=
true
;
}
void
RecordedTextureData
:
:
SetRemoteTextureOwnerId
(
RemoteTextureOwnerId
aRemoteTextureOwnerId
)
{
mRemoteTextureOwnerId
=
aRemoteTextureOwnerId
;
}
void
RecordedTextureData
:
:
InvalidateContents
(
)
{
mInvalidContents
=
true
;
}
bool
RecordedTextureData
:
:
Lock
(
OpenMode
aMode
)
{
if
(
!
mCanvasChild
-
>
EnsureBeginTransaction
(
)
)
{
return
false
;
}
if
(
!
mRemoteTextureOwnerId
.
IsValid
(
)
)
{
MOZ_ASSERT
(
false
)
;
return
false
;
}
if
(
aMode
&
OpenMode
:
:
OPEN_WRITE
)
{
mUsedRemoteTexture
=
false
;
}
bool
wasInvalidContents
=
mInvalidContents
;
mInvalidContents
=
false
;
if
(
!
mDT
)
{
mTextureId
=
sNextRecordedTextureId
+
+
;
mDT
=
mCanvasChild
-
>
CreateDrawTarget
(
mTextureId
mRemoteTextureOwnerId
mSize
mFormat
)
;
if
(
!
mDT
)
{
return
false
;
}
mLockedMode
=
aMode
;
return
true
;
}
mCanvasChild
-
>
RecordEvent
(
RecordedTextureLock
(
mTextureId
aMode
wasInvalidContents
)
)
;
mLockedMode
=
aMode
;
return
true
;
}
void
RecordedTextureData
:
:
DetachSnapshotWrapper
(
bool
aInvalidate
bool
aRelease
)
{
if
(
mSnapshotWrapper
)
{
mCanvasChild
-
>
DetachSurface
(
mSnapshotWrapper
aInvalidate
&
&
!
mSnapshotWrapper
-
>
hasOneRef
(
)
)
;
if
(
aRelease
)
{
mSnapshotWrapper
=
nullptr
;
}
}
}
void
RecordedTextureData
:
:
Unlock
(
)
{
if
(
(
mLockedMode
=
=
OpenMode
:
:
OPEN_READ_WRITE
)
&
&
mCanvasChild
-
>
ShouldCacheDataSurface
(
)
)
{
DetachSnapshotWrapper
(
)
;
mSnapshot
=
mDT
-
>
Snapshot
(
)
;
mDT
-
>
DetachAllSnapshots
(
)
;
mCanvasChild
-
>
RecordEvent
(
RecordedCacheDataSurface
(
mSnapshot
.
get
(
)
)
)
;
}
mCanvasChild
-
>
RecordEvent
(
RecordedTextureUnlock
(
mTextureId
)
)
;
mLockedMode
=
OpenMode
:
:
OPEN_NONE
;
}
already_AddRefed
<
gfx
:
:
DrawTarget
>
RecordedTextureData
:
:
BorrowDrawTarget
(
)
{
if
(
mLockedMode
&
OpenMode
:
:
OPEN_WRITE
)
{
mSnapshot
=
nullptr
;
DetachSnapshotWrapper
(
true
)
;
}
return
do_AddRef
(
mDT
)
;
}
void
RecordedTextureData
:
:
EndDraw
(
)
{
MOZ_ASSERT
(
mDT
-
>
hasOneRef
(
)
)
;
MOZ_ASSERT
(
mLockedMode
=
=
OpenMode
:
:
OPEN_READ_WRITE
)
;
if
(
mCanvasChild
-
>
ShouldCacheDataSurface
(
)
)
{
DetachSnapshotWrapper
(
)
;
mSnapshot
=
mDT
-
>
Snapshot
(
)
;
mCanvasChild
-
>
RecordEvent
(
RecordedCacheDataSurface
(
mSnapshot
.
get
(
)
)
)
;
}
}
already_AddRefed
<
gfx
:
:
SourceSurface
>
RecordedTextureData
:
:
BorrowSnapshot
(
)
{
if
(
mSnapshotWrapper
)
{
if
(
!
mDT
|
|
!
mDT
-
>
IsDirty
(
)
)
{
mCanvasChild
-
>
AttachSurface
(
mSnapshotWrapper
)
;
return
do_AddRef
(
mSnapshotWrapper
)
;
}
DetachSnapshotWrapper
(
)
;
}
if
(
!
mDT
)
{
return
nullptr
;
}
mDT
-
>
MarkClean
(
)
;
RefPtr
<
gfx
:
:
SourceSurface
>
wrapper
=
mCanvasChild
-
>
WrapSurface
(
mSnapshot
?
mSnapshot
:
mDT
-
>
Snapshot
(
)
mTextureId
)
;
mSnapshotWrapper
=
wrapper
;
return
wrapper
.
forget
(
)
;
}
void
RecordedTextureData
:
:
ReturnSnapshot
(
already_AddRefed
<
gfx
:
:
SourceSurface
>
aSnapshot
)
{
RefPtr
<
gfx
:
:
SourceSurface
>
snapshot
=
aSnapshot
;
DetachSnapshotWrapper
(
false
false
)
;
}
void
RecordedTextureData
:
:
Deallocate
(
LayersIPCChannel
*
aAllocator
)
{
}
bool
RecordedTextureData
:
:
Serialize
(
SurfaceDescriptor
&
aDescriptor
)
{
if
(
!
mRemoteTextureOwnerId
.
IsValid
(
)
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Missing
remote
texture
owner
id
!
"
)
;
return
false
;
}
if
(
!
mUsedRemoteTexture
)
{
mLastRemoteTextureId
=
RemoteTextureId
:
:
GetNext
(
)
;
mCanvasChild
-
>
RecordEvent
(
RecordedPresentTexture
(
mTextureId
mLastRemoteTextureId
)
)
;
mUsedRemoteTexture
=
true
;
}
else
if
(
!
mLastRemoteTextureId
.
IsValid
(
)
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Missing
remote
texture
id
!
"
)
;
return
false
;
}
aDescriptor
=
SurfaceDescriptorRemoteTexture
(
mLastRemoteTextureId
mRemoteTextureOwnerId
)
;
return
true
;
}
already_AddRefed
<
FwdTransactionTracker
>
RecordedTextureData
:
:
UseCompositableForwarder
(
CompositableForwarder
*
aForwarder
)
{
return
FwdTransactionTracker
:
:
GetOrCreate
(
mFwdTransactionTracker
)
;
}
void
RecordedTextureData
:
:
OnForwardedToHost
(
)
{
MOZ_CRASH
(
"
OnForwardedToHost
not
supported
!
"
)
;
}
TextureFlags
RecordedTextureData
:
:
GetTextureFlags
(
)
const
{
return
TextureFlags
:
:
WAIT_HOST_USAGE_END
;
}
bool
RecordedTextureData
:
:
RequiresRefresh
(
)
const
{
return
mCanvasChild
-
>
RequiresRefresh
(
mTextureId
)
;
}
}
}
