#
ifndef
MOZILLA_GFX_TILEDCONTENTCLIENT_H
#
define
MOZILLA_GFX_TILEDCONTENTCLIENT_H
#
include
<
cstdint
>
#
include
<
iosfwd
>
#
include
<
utility
>
#
include
"
ClientLayerManager
.
h
"
#
include
"
Units
.
h
"
#
include
"
gfxTypes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
TypedEnumBits
.
h
"
#
include
"
mozilla
/
gfx
/
2D
.
h
"
#
include
"
mozilla
/
gfx
/
Rect
.
h
"
#
include
"
mozilla
/
layers
/
CompositableClient
.
h
"
#
include
"
mozilla
/
layers
/
CompositorTypes
.
h
"
#
include
"
mozilla
/
layers
/
LayerManager
.
h
"
#
include
"
mozilla
/
layers
/
LayersMessages
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
#
include
"
mozilla
/
layers
/
ShadowLayers
.
h
"
#
include
"
mozilla
/
layers
/
TextureClient
.
h
"
#
include
"
mozilla
/
layers
/
TextureClientPool
.
h
"
#
include
"
nsExpirationTracker
.
h
"
#
include
"
nsRegion
.
h
"
#
include
"
nsTArray
.
h
"
namespace
mozilla
{
namespace
layers
{
class
ClientTiledPaintedLayer
;
class
LayerMetricsWrapper
;
struct
AsyncTransform
;
struct
FrameMetrics
;
enum
class
TilePaintFlags
:
uint8_t
{
None
=
0x0
Async
=
0x1
Progressive
=
0x2
}
;
MOZ_MAKE_ENUM_CLASS_BITWISE_OPERATORS
(
TilePaintFlags
)
void
ShutdownTileCache
(
)
;
struct
AcquiredBackBuffer
{
AcquiredBackBuffer
(
gfx
:
:
DrawTarget
*
aTarget
gfx
:
:
DrawTargetCapture
*
aCapture
gfx
:
:
DrawTarget
*
aBackBuffer
const
gfx
:
:
IntRect
&
aUpdatedRect
AutoTArray
<
RefPtr
<
TextureClient
>
4
>
&
&
aTextureClients
)
:
mTarget
(
aTarget
)
mCapture
(
aCapture
)
mBackBuffer
(
aBackBuffer
)
mUpdatedRect
(
aUpdatedRect
)
mTextureClients
(
std
:
:
move
(
aTextureClients
)
)
{
}
AcquiredBackBuffer
(
const
AcquiredBackBuffer
&
)
=
delete
;
AcquiredBackBuffer
&
operator
=
(
const
AcquiredBackBuffer
&
)
=
delete
;
AcquiredBackBuffer
(
AcquiredBackBuffer
&
&
)
=
default
;
AcquiredBackBuffer
&
operator
=
(
AcquiredBackBuffer
&
&
)
=
default
;
RefPtr
<
gfx
:
:
DrawTarget
>
mTarget
;
RefPtr
<
gfx
:
:
DrawTargetCapture
>
mCapture
;
RefPtr
<
gfx
:
:
DrawTarget
>
mBackBuffer
;
gfx
:
:
IntRect
mUpdatedRect
;
AutoTArray
<
RefPtr
<
TextureClient
>
4
>
mTextureClients
;
}
;
struct
TileClient
{
TileClient
(
)
;
~
TileClient
(
)
;
TileClient
(
const
TileClient
&
o
)
;
TileClient
&
operator
=
(
const
TileClient
&
o
)
;
bool
operator
=
=
(
const
TileClient
&
o
)
const
{
return
mFrontBuffer
=
=
o
.
mFrontBuffer
;
}
bool
operator
!
=
(
const
TileClient
&
o
)
const
{
return
mFrontBuffer
!
=
o
.
mFrontBuffer
;
}
void
SetTextureAllocator
(
TextureClientAllocator
*
aAllocator
)
{
mAllocator
=
aAllocator
;
}
bool
IsPlaceholderTile
(
)
const
{
return
mBackBuffer
=
=
nullptr
&
&
mFrontBuffer
=
=
nullptr
;
}
void
DiscardBuffers
(
)
{
DiscardFrontBuffer
(
)
;
DiscardBackBuffer
(
)
;
}
nsExpirationState
*
GetExpirationState
(
)
{
return
&
mExpirationState
;
}
TileDescriptor
GetTileDescriptor
(
)
;
void
Dump
(
std
:
:
stringstream
&
aStream
)
;
void
Flip
(
)
;
void
DumpTexture
(
std
:
:
stringstream
&
aStream
TextureDumpMode
aCompress
)
{
CompositableClient
:
:
DumpTextureClient
(
aStream
mFrontBuffer
aCompress
)
;
}
void
GetSyncTextureSerials
(
SurfaceMode
aMode
nsTArray
<
uint64_t
>
&
aSerials
)
;
Maybe
<
AcquiredBackBuffer
>
AcquireBackBuffer
(
CompositableClient
&
const
nsIntRegion
&
aDirtyRegion
const
nsIntRegion
&
aVisibleRegion
gfxContentType
aContent
SurfaceMode
aMode
TilePaintFlags
aFlags
)
;
void
DiscardFrontBuffer
(
)
;
void
DiscardBackBuffer
(
)
;
class
PrivateProtector
{
public
:
void
Set
(
TileClient
*
container
RefPtr
<
TextureClient
>
)
;
void
Set
(
TileClient
*
container
TextureClient
*
)
;
operator
TextureClient
*
(
)
const
{
return
mBuffer
;
}
RefPtr
<
TextureClient
>
operator
-
>
(
)
{
return
mBuffer
;
}
private
:
PrivateProtector
&
operator
=
(
const
PrivateProtector
&
)
;
RefPtr
<
TextureClient
>
mBuffer
;
}
mBackBuffer
;
RefPtr
<
TextureClient
>
mBackBufferOnWhite
;
RefPtr
<
TextureClient
>
mFrontBuffer
;
RefPtr
<
TextureClient
>
mFrontBufferOnWhite
;
RefPtr
<
TextureClientAllocator
>
mAllocator
;
gfx
:
:
IntRect
mUpdateRect
;
bool
mWasPlaceholder
;
#
ifdef
GFX_TILEDLAYER_DEBUG_OVERLAY
TimeStamp
mLastUpdate
;
#
endif
nsIntRegion
mInvalidFront
;
nsIntRegion
mInvalidBack
;
nsExpirationState
mExpirationState
;
private
:
void
ValidateFromFront
(
const
nsIntRegion
&
aDirtyRegion
const
nsIntRegion
&
aVisibleRegion
gfx
:
:
DrawTarget
*
aBackBuffer
TilePaintFlags
aFlags
gfx
:
:
IntRect
*
aCopiedRegion
AutoTArray
<
RefPtr
<
TextureClient
>
4
>
*
aClients
)
;
}
;
struct
BasicTiledLayerPaintData
{
ParentLayerPoint
mScrollOffset
;
ParentLayerPoint
mLastScrollOffset
;
LayerToParentLayerMatrix4x4
mTransformToCompBounds
;
Maybe
<
LayerIntRect
>
mCriticalDisplayPort
;
CSSToParentLayerScale2D
mResolution
;
LayerRect
mCompositionBounds
;
uint16_t
mLowPrecisionPaintCount
;
bool
mFirstPaint
:
1
;
bool
mPaintFinished
:
1
;
bool
mHasTransformAnimation
:
1
;
void
ResetPaintData
(
)
;
}
;
class
SharedFrameMetricsHelper
{
public
:
SharedFrameMetricsHelper
(
)
;
~
SharedFrameMetricsHelper
(
)
;
bool
UpdateFromCompositorFrameMetrics
(
const
LayerMetricsWrapper
&
aLayer
bool
aHasPendingNewThebesContent
bool
aLowPrecision
AsyncTransform
&
aViewTransform
)
;
bool
AboutToCheckerboard
(
const
FrameMetrics
&
aContentMetrics
const
FrameMetrics
&
aCompositorMetrics
)
;
private
:
bool
mLastProgressiveUpdateWasLowPrecision
;
bool
mProgressiveUpdateWasInDanger
;
}
;
class
ClientTiledLayerBuffer
{
public
:
ClientTiledLayerBuffer
(
ClientTiledPaintedLayer
&
aPaintedLayer
CompositableClient
&
aCompositableClient
)
:
mPaintedLayer
(
aPaintedLayer
)
mCompositableClient
(
aCompositableClient
)
mLastPaintContentType
(
gfxContentType
:
:
COLOR
)
mLastPaintSurfaceMode
(
SurfaceMode
:
:
SURFACE_OPAQUE
)
mWasLastPaintProgressive
(
false
)
{
}
virtual
void
PaintThebes
(
const
nsIntRegion
&
aNewValidRegion
const
nsIntRegion
&
aPaintRegion
const
nsIntRegion
&
aDirtyRegion
LayerManager
:
:
DrawPaintedLayerCallback
aCallback
void
*
aCallbackData
TilePaintFlags
aFlags
)
=
0
;
virtual
void
GetSyncTextureSerials
(
const
nsIntRegion
&
aPaintRegion
const
nsIntRegion
&
aDirtyRegion
nsTArray
<
uint64_t
>
&
aSerials
)
{
return
;
}
virtual
bool
SupportsProgressiveUpdate
(
)
=
0
;
virtual
bool
ProgressiveUpdate
(
const
nsIntRegion
&
aValidRegion
const
nsIntRegion
&
aInvalidRegion
const
nsIntRegion
&
aOldValidRegion
nsIntRegion
&
aOutDrawnRegion
BasicTiledLayerPaintData
*
aPaintData
LayerManager
:
:
DrawPaintedLayerCallback
aCallback
void
*
aCallbackData
)
=
0
;
virtual
void
ResetPaintedAndValidState
(
)
=
0
;
virtual
const
nsIntRegion
&
GetValidRegion
(
)
=
0
;
virtual
bool
IsLowPrecision
(
)
const
=
0
;
virtual
void
Dump
(
std
:
:
stringstream
&
aStream
const
char
*
aPrefix
bool
aDumpHtml
TextureDumpMode
aCompress
)
{
}
const
CSSToParentLayerScale2D
&
GetFrameResolution
(
)
{
return
mFrameResolution
;
}
void
SetFrameResolution
(
const
CSSToParentLayerScale2D
&
aResolution
)
{
mFrameResolution
=
aResolution
;
}
bool
HasFormatChanged
(
)
const
;
protected
:
void
UnlockTile
(
TileClient
&
aTile
)
;
gfxContentType
GetContentType
(
SurfaceMode
*
aMode
=
nullptr
)
const
;
ClientTiledPaintedLayer
&
mPaintedLayer
;
CompositableClient
&
mCompositableClient
;
gfxContentType
mLastPaintContentType
;
SurfaceMode
mLastPaintSurfaceMode
;
CSSToParentLayerScale2D
mFrameResolution
;
bool
mWasLastPaintProgressive
;
}
;
class
TiledContentClient
:
public
CompositableClient
{
public
:
TiledContentClient
(
ClientLayerManager
*
aManager
const
char
*
aName
=
"
"
)
:
CompositableClient
(
aManager
-
>
AsShadowForwarder
(
)
)
mName
(
aName
)
{
}
protected
:
~
TiledContentClient
(
)
{
}
public
:
virtual
void
PrintInfo
(
std
:
:
stringstream
&
aStream
const
char
*
aPrefix
)
;
void
Dump
(
std
:
:
stringstream
&
aStream
const
char
*
aPrefix
=
"
"
bool
aDumpHtml
=
false
TextureDumpMode
aCompress
=
TextureDumpMode
:
:
Compress
)
override
;
TextureInfo
GetTextureInfo
(
)
const
override
{
return
TextureInfo
(
CompositableType
:
:
CONTENT_TILED
)
;
}
virtual
ClientTiledLayerBuffer
*
GetTiledBuffer
(
)
=
0
;
virtual
ClientTiledLayerBuffer
*
GetLowPrecisionTiledBuffer
(
)
=
0
;
enum
TiledBufferType
{
TILED_BUFFER
LOW_PRECISION_TILED_BUFFER
}
;
virtual
void
UpdatedBuffer
(
TiledBufferType
aType
)
=
0
;
private
:
const
char
*
mName
;
}
;
}
}
#
endif
