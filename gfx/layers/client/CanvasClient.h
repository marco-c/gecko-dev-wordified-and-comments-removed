#
ifndef
MOZILLA_GFX_CANVASCLIENT_H
#
define
MOZILLA_GFX_CANVASCLIENT_H
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
layers
/
CompositableClient
.
h
"
#
include
"
mozilla
/
layers
/
CompositorTypes
.
h
"
#
include
"
mozilla
/
layers
/
LayersSurfaces
.
h
"
#
include
"
mozilla
/
layers
/
TextureClient
.
h
"
#
undef
None
#
include
"
mozilla
/
MaybeOneOf
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
gfx
/
Types
.
h
"
namespace
mozilla
{
namespace
layers
{
class
AsyncCanvasRenderer
;
class
ClientCanvasLayer
;
class
CompositableForwarder
;
class
ShadowableLayer
;
class
SharedSurfaceTextureClient
;
class
CanvasClient
:
public
CompositableClient
{
public
:
typedef
MaybeOneOf
<
ClientCanvasLayer
*
AsyncCanvasRenderer
*
>
Renderer
;
enum
CanvasClientType
{
CanvasClientSurface
CanvasClientGLContext
CanvasClientTypeShSurf
CanvasClientAsync
}
;
static
already_AddRefed
<
CanvasClient
>
CreateCanvasClient
(
CanvasClientType
aType
CompositableForwarder
*
aFwd
TextureFlags
aFlags
)
;
CanvasClient
(
CompositableForwarder
*
aFwd
TextureFlags
aFlags
)
:
CompositableClient
(
aFwd
aFlags
)
mFrameID
(
0
)
{
mTextureFlags
=
aFlags
;
}
virtual
~
CanvasClient
(
)
{
}
virtual
void
Clear
(
)
{
}
;
virtual
void
Update
(
gfx
:
:
IntSize
aSize
ClientCanvasLayer
*
aLayer
)
=
0
;
virtual
bool
AddTextureClient
(
TextureClient
*
aTexture
)
override
{
+
+
mFrameID
;
return
CompositableClient
:
:
AddTextureClient
(
aTexture
)
;
}
virtual
void
UpdateAsync
(
AsyncCanvasRenderer
*
aRenderer
)
{
}
virtual
void
Updated
(
)
{
}
protected
:
int32_t
mFrameID
;
}
;
class
CanvasClient2D
:
public
CanvasClient
{
public
:
CanvasClient2D
(
CompositableForwarder
*
aLayerForwarder
TextureFlags
aFlags
)
:
CanvasClient
(
aLayerForwarder
aFlags
)
{
}
TextureInfo
GetTextureInfo
(
)
const
override
{
return
TextureInfo
(
CompositableType
:
:
IMAGE
mTextureFlags
)
;
}
virtual
void
Clear
(
)
override
{
mBuffer
=
nullptr
;
}
virtual
void
Update
(
gfx
:
:
IntSize
aSize
ClientCanvasLayer
*
aLayer
)
override
;
virtual
bool
AddTextureClient
(
TextureClient
*
aTexture
)
override
{
MOZ_ASSERT
(
(
mTextureFlags
&
aTexture
-
>
GetFlags
(
)
)
=
=
mTextureFlags
)
;
return
CanvasClient
:
:
AddTextureClient
(
aTexture
)
;
}
virtual
void
OnDetach
(
)
override
{
mBuffer
=
nullptr
;
}
private
:
already_AddRefed
<
TextureClient
>
CreateTextureClientForCanvas
(
gfx
:
:
SurfaceFormat
aFormat
gfx
:
:
IntSize
aSize
TextureFlags
aFlags
ClientCanvasLayer
*
aLayer
)
;
RefPtr
<
TextureClient
>
mBuffer
;
}
;
class
CanvasClientSharedSurface
:
public
CanvasClient
{
private
:
RefPtr
<
SharedSurfaceTextureClient
>
mShSurfClient
;
RefPtr
<
TextureClient
>
mReadbackClient
;
RefPtr
<
TextureClient
>
mFront
;
RefPtr
<
TextureClient
>
mNewFront
;
void
ClearSurfaces
(
)
;
public
:
CanvasClientSharedSurface
(
CompositableForwarder
*
aLayerForwarder
TextureFlags
aFlags
)
;
~
CanvasClientSharedSurface
(
)
;
virtual
TextureInfo
GetTextureInfo
(
)
const
override
{
return
TextureInfo
(
CompositableType
:
:
IMAGE
)
;
}
virtual
void
Clear
(
)
override
{
ClearSurfaces
(
)
;
}
virtual
void
Update
(
gfx
:
:
IntSize
aSize
ClientCanvasLayer
*
aLayer
)
override
;
void
UpdateRenderer
(
gfx
:
:
IntSize
aSize
Renderer
&
aRenderer
)
;
virtual
void
UpdateAsync
(
AsyncCanvasRenderer
*
aRenderer
)
override
;
virtual
void
Updated
(
)
override
;
virtual
void
OnDetach
(
)
override
{
ClearSurfaces
(
)
;
}
}
;
class
CanvasClientBridge
final
:
public
CanvasClient
{
public
:
CanvasClientBridge
(
CompositableForwarder
*
aLayerForwarder
TextureFlags
aFlags
)
:
CanvasClient
(
aLayerForwarder
aFlags
)
mAsyncID
(
0
)
mLayer
(
nullptr
)
{
}
TextureInfo
GetTextureInfo
(
)
const
override
{
return
TextureInfo
(
CompositableType
:
:
IMAGE
)
;
}
virtual
void
Update
(
gfx
:
:
IntSize
aSize
ClientCanvasLayer
*
aLayer
)
override
{
}
virtual
void
UpdateAsync
(
AsyncCanvasRenderer
*
aRenderer
)
override
;
void
SetLayer
(
ShadowableLayer
*
aLayer
)
{
mLayer
=
aLayer
;
}
protected
:
uint64_t
mAsyncID
;
ShadowableLayer
*
mLayer
;
}
;
}
}
#
endif
