#
ifndef
MOZILLA_GFX_TEXTURECLIENTPOOL_H
#
define
MOZILLA_GFX_TEXTURECLIENTPOOL_H
#
include
"
mozilla
/
gfx
/
Types
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
TextureClient
.
h
"
#
include
"
nsITimer
.
h
"
#
include
<
stack
>
#
include
<
list
>
namespace
mozilla
{
namespace
layers
{
class
ISurfaceAllocator
;
class
CompositableForwarder
;
class
gfxSharedReadLock
;
class
TextureClientAllocator
{
protected
:
virtual
~
TextureClientAllocator
(
)
{
}
public
:
NS_INLINE_DECL_REFCOUNTING
(
TextureClientAllocator
)
virtual
already_AddRefed
<
TextureClient
>
GetTextureClient
(
)
=
0
;
virtual
void
ReturnTextureClientDeferred
(
TextureClient
*
aClient
gfxSharedReadLock
*
aLock
)
=
0
;
virtual
void
ReportClientLost
(
)
=
0
;
}
;
class
TextureClientPool
final
:
public
TextureClientAllocator
{
~
TextureClientPool
(
)
;
public
:
TextureClientPool
(
gfx
:
:
SurfaceFormat
aFormat
TextureFlags
aFlags
gfx
:
:
IntSize
aSize
uint32_t
aMaxTextureClients
uint32_t
aShrinkTimeoutMsec
CompositableForwarder
*
aAllocator
)
;
already_AddRefed
<
TextureClient
>
GetTextureClient
(
)
override
;
void
ReturnTextureClient
(
TextureClient
*
aClient
)
;
void
ReturnTextureClientDeferred
(
TextureClient
*
aClient
gfxSharedReadLock
*
aLock
)
override
;
void
ShrinkToMaximumSize
(
)
;
void
ShrinkToMinimumSize
(
)
;
void
ReturnDeferredClients
(
)
;
virtual
void
ReportClientLost
(
)
override
;
void
Clear
(
)
;
gfx
:
:
SurfaceFormat
GetFormat
(
)
{
return
mFormat
;
}
TextureFlags
GetFlags
(
)
const
{
return
mFlags
;
}
void
Destroy
(
)
;
private
:
void
ReturnUnlockedClients
(
)
;
static
const
uint32_t
sMinCacheSize
=
0
;
gfx
:
:
SurfaceFormat
mFormat
;
const
TextureFlags
mFlags
;
gfx
:
:
IntSize
mSize
;
uint32_t
mMaxTextureClients
;
uint32_t
mShrinkTimeoutMsec
;
uint32_t
mOutstandingClients
;
struct
TextureClientHolder
{
RefPtr
<
TextureClient
>
mTextureClient
;
RefPtr
<
gfxSharedReadLock
>
mLock
;
TextureClientHolder
(
TextureClient
*
aTextureClient
gfxSharedReadLock
*
aLock
)
:
mTextureClient
(
aTextureClient
)
mLock
(
aLock
)
{
}
}
;
std
:
:
stack
<
RefPtr
<
TextureClient
>
>
mTextureClients
;
std
:
:
list
<
TextureClientHolder
>
mTextureClientsDeferred
;
RefPtr
<
nsITimer
>
mTimer
;
RefPtr
<
CompositableForwarder
>
mSurfaceAllocator
;
}
;
}
}
#
endif
