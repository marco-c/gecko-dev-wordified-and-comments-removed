#
ifndef
MOZILLA_GFX_TEXTURECLIENTPOOL_H
#
define
MOZILLA_GFX_TEXTURECLIENTPOOL_H
#
include
"
mozilla
/
gfx
/
Types
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
layers
/
KnowsCompositor
.
h
"
#
include
"
TextureClient
.
h
"
#
include
"
nsITimer
.
h
"
#
include
<
stack
>
#
include
<
list
>
namespace
mozilla
{
namespace
layers
{
class
ISurfaceAllocator
;
class
TextureForwarder
;
class
TextureReadLock
;
class
TextureClientAllocator
{
protected
:
virtual
~
TextureClientAllocator
(
)
=
default
;
public
:
NS_INLINE_DECL_REFCOUNTING
(
TextureClientAllocator
)
virtual
already_AddRefed
<
TextureClient
>
GetTextureClient
(
)
=
0
;
virtual
void
ReturnTextureClientDeferred
(
TextureClient
*
aClient
)
=
0
;
virtual
void
ReportClientLost
(
)
=
0
;
}
;
class
TextureClientPool
final
:
public
TextureClientAllocator
{
virtual
~
TextureClientPool
(
)
;
public
:
TextureClientPool
(
KnowsCompositor
*
aKnowsCompositor
gfx
:
:
SurfaceFormat
aFormat
gfx
:
:
IntSize
aSize
TextureFlags
aFlags
uint32_t
aShrinkTimeoutMsec
uint32_t
aClearTimeoutMsec
uint32_t
aInitialPoolSize
uint32_t
aPoolUnusedSize
TextureForwarder
*
aAllocator
)
;
already_AddRefed
<
TextureClient
>
GetTextureClient
(
)
override
;
void
ReturnTextureClient
(
TextureClient
*
aClient
)
;
void
ReturnTextureClientDeferred
(
TextureClient
*
aClient
)
override
;
void
ReturnDeferredClients
(
)
;
void
ShrinkToMaximumSize
(
)
;
void
ReportClientLost
(
)
override
;
void
Clear
(
)
;
LayersBackend
GetBackend
(
)
const
{
return
mKnowsCompositor
-
>
GetCompositorBackendType
(
)
;
}
int32_t
GetMaxTextureSize
(
)
const
{
return
mKnowsCompositor
-
>
GetMaxTextureSize
(
)
;
}
gfx
:
:
SurfaceFormat
GetFormat
(
)
{
return
mFormat
;
}
TextureFlags
GetFlags
(
)
const
{
return
mFlags
;
}
void
Destroy
(
)
;
private
:
void
ReturnUnlockedClients
(
)
;
void
AllocateTextureClient
(
)
;
void
ResetTimers
(
)
;
RefPtr
<
KnowsCompositor
>
mKnowsCompositor
;
gfx
:
:
SurfaceFormat
mFormat
;
gfx
:
:
IntSize
mSize
;
const
TextureFlags
mFlags
;
uint32_t
mShrinkTimeoutMsec
;
uint32_t
mClearTimeoutMsec
;
uint32_t
mInitialPoolSize
;
uint32_t
mPoolUnusedSize
;
uint32_t
mOutstandingClients
;
std
:
:
stack
<
RefPtr
<
TextureClient
>
>
mTextureClients
;
std
:
:
list
<
RefPtr
<
TextureClient
>
>
mTextureClientsDeferred
;
RefPtr
<
nsITimer
>
mShrinkTimer
;
RefPtr
<
nsITimer
>
mClearTimer
;
TextureForwarder
*
mSurfaceAllocator
;
bool
mDestroyed
;
}
;
}
}
#
endif
