#
ifndef
mozilla_layers_CanvasTranslator_h
#
define
mozilla_layers_CanvasTranslator_h
#
include
<
unordered_map
>
#
include
<
vector
>
#
include
"
mozilla
/
gfx
/
InlineTranslator
.
h
"
#
include
"
mozilla
/
layers
/
CanvasDrawEventRecorder
.
h
"
#
include
"
mozilla
/
layers
/
LayersSurfaces
.
h
"
#
include
"
mozilla
/
ipc
/
CrossProcessSemaphore
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
namespace
mozilla
{
namespace
layers
{
class
TextureData
;
class
CanvasTranslator
final
:
public
gfx
:
:
InlineTranslator
{
public
:
static
UniquePtr
<
CanvasTranslator
>
Create
(
const
TextureType
&
aTextureType
const
ipc
:
:
SharedMemoryBasic
:
:
Handle
&
aReadHandle
const
CrossProcessSemaphoreHandle
&
aReaderSem
const
CrossProcessSemaphoreHandle
&
aWriterSem
UniquePtr
<
CanvasEventRingBuffer
:
:
ReaderServices
>
aReaderServices
)
;
~
CanvasTranslator
(
)
;
bool
IsValid
(
)
{
return
mIsValid
;
}
bool
TranslateRecording
(
)
;
void
BeginTransaction
(
)
;
void
EndTransaction
(
)
;
void
Flush
(
)
;
void
ReturnWrite
(
const
char
*
aData
size_t
aSize
)
{
mStream
.
ReturnWrite
(
aData
aSize
)
;
}
already_AddRefed
<
gfx
:
:
DrawTarget
>
CreateDrawTarget
(
gfx
:
:
ReferencePtr
aRefPtr
const
gfx
:
:
IntSize
&
aSize
gfx
:
:
SurfaceFormat
aFormat
)
final
;
TextureData
*
LookupTextureData
(
gfx
:
:
ReferencePtr
aDrawTarget
)
;
UniquePtr
<
SurfaceDescriptor
>
WaitForSurfaceDescriptor
(
gfx
:
:
ReferencePtr
aDrawTarget
)
;
void
RemoveDrawTarget
(
gfx
:
:
ReferencePtr
aDrawTarget
)
final
;
void
RemoveSourceSurface
(
gfx
:
:
ReferencePtr
aRefPtr
)
final
{
RemoveDataSurface
(
aRefPtr
)
;
InlineTranslator
:
:
RemoveSourceSurface
(
aRefPtr
)
;
}
gfx
:
:
DataSourceSurface
*
LookupDataSurface
(
gfx
:
:
ReferencePtr
aRefPtr
)
;
void
AddDataSurface
(
gfx
:
:
ReferencePtr
aRefPtr
RefPtr
<
gfx
:
:
DataSourceSurface
>
&
&
aSurface
)
;
void
RemoveDataSurface
(
gfx
:
:
ReferencePtr
aRefPtr
)
;
void
SetPreparedMap
(
gfx
:
:
ReferencePtr
aSurface
UniquePtr
<
gfx
:
:
DataSourceSurface
:
:
ScopedMap
>
aMap
)
;
UniquePtr
<
gfx
:
:
DataSourceSurface
:
:
ScopedMap
>
GetPreparedMap
(
gfx
:
:
ReferencePtr
aSurface
)
;
private
:
CanvasTranslator
(
const
TextureType
&
aTextureType
TextureData
*
aTextureData
gfx
:
:
DrawTarget
*
aDrawTarget
const
ipc
:
:
SharedMemoryBasic
:
:
Handle
&
aReadHandle
const
CrossProcessSemaphoreHandle
&
aReaderSem
const
CrossProcessSemaphoreHandle
&
aWriterSem
UniquePtr
<
CanvasEventRingBuffer
:
:
ReaderServices
>
aReaderServices
)
;
void
AddSurfaceDescriptor
(
gfx
:
:
ReferencePtr
aRefPtr
TextureData
*
atextureData
)
;
bool
HandleExtensionEvent
(
int32_t
aType
)
;
CanvasEventRingBuffer
mStream
;
TextureType
mTextureType
=
TextureType
:
:
Unknown
;
UniquePtr
<
TextureData
>
mReferenceTextureData
;
typedef
std
:
:
unordered_map
<
void
*
UniquePtr
<
TextureData
>
>
TextureMap
;
TextureMap
mTextureDatas
;
nsRefPtrHashtable
<
nsPtrHashKey
<
void
>
gfx
:
:
DataSourceSurface
>
mDataSurfaces
;
gfx
:
:
ReferencePtr
mMappedSurface
;
UniquePtr
<
gfx
:
:
DataSourceSurface
:
:
ScopedMap
>
mPreparedMap
;
typedef
std
:
:
unordered_map
<
void
*
UniquePtr
<
SurfaceDescriptor
>
>
DescriptorMap
;
DescriptorMap
mSurfaceDescriptors
;
Monitor
mSurfaceDescriptorsMonitor
{
"
CanvasTranslator
:
:
mSurfaceDescriptorsMonitor
"
}
;
bool
mIsValid
=
true
;
bool
mIsInTransaction
=
false
;
}
;
}
}
#
endif
