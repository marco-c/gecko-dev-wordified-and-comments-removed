#
include
"
mozilla
/
layers
/
CrossProcessCompositorBridgeParent
.
h
"
#
include
<
stdio
.
h
>
#
include
<
stdint
.
h
>
#
include
<
map
>
#
include
<
utility
>
#
include
"
LayerTransactionParent
.
h
"
#
include
"
RenderTrace
.
h
"
#
include
"
base
/
message_loop
.
h
"
#
include
"
base
/
process
.
h
"
#
include
"
base
/
task
.
h
"
#
include
"
base
/
thread
.
h
"
#
include
"
gfxContext
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
TreeTraversal
.
h
"
#
ifdef
MOZ_WIDGET_GTK
#
include
"
gfxPlatformGtk
.
h
"
#
endif
#
include
"
gfxPrefs
.
h
"
#
include
"
mozilla
/
AutoRestore
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
DebugOnly
.
h
"
#
include
"
mozilla
/
dom
/
ContentParent
.
h
"
#
include
"
mozilla
/
dom
/
TabParent
.
h
"
#
include
"
mozilla
/
gfx
/
2D
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
gfx
/
Rect
.
h
"
#
include
"
VRManager
.
h
"
#
include
"
mozilla
/
ipc
/
Transport
.
h
"
#
include
"
mozilla
/
layers
/
APZCTreeManager
.
h
"
#
include
"
mozilla
/
layers
/
APZCTreeManagerParent
.
h
"
#
include
"
mozilla
/
layers
/
APZThreadUtils
.
h
"
#
include
"
mozilla
/
layers
/
AsyncCompositionManager
.
h
"
#
include
"
mozilla
/
layers
/
BasicCompositor
.
h
"
#
include
"
mozilla
/
layers
/
Compositor
.
h
"
#
include
"
mozilla
/
layers
/
CompositorOGL
.
h
"
#
include
"
mozilla
/
layers
/
CompositorThread
.
h
"
#
include
"
mozilla
/
layers
/
CompositorTypes
.
h
"
#
include
"
mozilla
/
layers
/
FrameUniformityData
.
h
"
#
include
"
mozilla
/
layers
/
ImageBridgeParent
.
h
"
#
include
"
mozilla
/
layers
/
LayerManagerComposite
.
h
"
#
include
"
mozilla
/
layers
/
LayerTreeOwnerTracker
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
#
include
"
mozilla
/
layers
/
PLayerTransactionParent
.
h
"
#
include
"
mozilla
/
layers
/
RemoteContentController
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderBridgeParent
.
h
"
#
include
"
mozilla
/
layout
/
RenderFrameParent
.
h
"
#
include
"
mozilla
/
media
/
MediaSystemResourceService
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
ifdef
MOZ_WIDGET_GTK
#
include
"
basic
/
X11BasicCompositor
.
h
"
#
endif
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsIWidget
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
ifdef
XP_WIN
#
include
"
mozilla
/
layers
/
CompositorD3D11
.
h
"
#
include
"
mozilla
/
layers
/
CompositorD3D9
.
h
"
#
endif
#
include
"
GeckoProfiler
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolTypes
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
mozilla
/
Hal
.
h
"
#
include
"
mozilla
/
HalTypes
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
Telemetry
.
h
"
#
ifdef
MOZ_ENABLE_PROFILER_SPS
#
include
"
ProfilerMarkers
.
h
"
#
endif
#
include
"
mozilla
/
VsyncDispatcher
.
h
"
#
if
defined
(
XP_WIN
)
|
|
defined
(
MOZ_WIDGET_GTK
)
#
include
"
VsyncSource
.
h
"
#
endif
#
include
"
mozilla
/
widget
/
CompositorWidget
.
h
"
#
ifdef
MOZ_WIDGET_SUPPORTS_OOP_COMPOSITING
#
include
"
mozilla
/
widget
/
CompositorWidgetParent
.
h
"
#
endif
#
include
"
LayerScope
.
h
"
namespace
mozilla
{
namespace
layers
{
typedef
map
<
uint64_t
CompositorBridgeParent
:
:
LayerTreeState
>
LayerTreeMap
;
extern
LayerTreeMap
sIndirectLayerTrees
;
extern
StaticAutoPtr
<
mozilla
:
:
Monitor
>
sIndirectLayerTreesLock
;
mozilla
:
:
ipc
:
:
IPCResult
CrossProcessCompositorBridgeParent
:
:
RecvRequestNotifyAfterRemotePaint
(
)
{
mNotifyAfterRemotePaint
=
true
;
return
IPC_OK
(
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
MessageLoop
:
:
current
(
)
-
>
PostTask
(
NewRunnableMethod
(
this
&
CrossProcessCompositorBridgeParent
:
:
DeferredDestroy
)
)
;
}
PLayerTransactionParent
*
CrossProcessCompositorBridgeParent
:
:
AllocPLayerTransactionParent
(
const
nsTArray
<
LayersBackend
>
&
const
uint64_t
&
aId
TextureFactoryIdentifier
*
aTextureFactoryIdentifier
bool
*
aSuccess
)
{
MOZ_ASSERT
(
aId
!
=
0
)
;
if
(
!
LayerTreeOwnerTracker
:
:
Get
(
)
-
>
IsMapped
(
aId
OtherPid
(
)
)
)
{
NS_ERROR
(
"
Unexpected
layers
id
in
AllocPLayerTransactionParent
;
dropping
message
.
.
.
"
)
;
return
nullptr
;
}
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
nullptr
;
LayerTreeMap
:
:
iterator
itr
=
sIndirectLayerTrees
.
find
(
aId
)
;
if
(
sIndirectLayerTrees
.
end
(
)
!
=
itr
)
{
state
=
&
itr
-
>
second
;
}
if
(
state
&
&
state
-
>
mLayerManager
)
{
state
-
>
mCrossProcessParent
=
this
;
LayerManagerComposite
*
lm
=
state
-
>
mLayerManager
;
*
aTextureFactoryIdentifier
=
lm
-
>
GetCompositor
(
)
-
>
GetTextureFactoryIdentifier
(
)
;
*
aSuccess
=
true
;
LayerTransactionParent
*
p
=
new
LayerTransactionParent
(
lm
this
aId
)
;
p
-
>
AddIPDLReference
(
)
;
sIndirectLayerTrees
[
aId
]
.
mLayerTree
=
p
;
p
-
>
SetPendingCompositorUpdates
(
state
-
>
mPendingCompositorUpdates
)
;
return
p
;
}
NS_WARNING
(
"
Created
child
without
a
matching
parent
?
"
)
;
*
aSuccess
=
true
;
LayerTransactionParent
*
p
=
new
LayerTransactionParent
(
nullptr
this
aId
)
;
p
-
>
AddIPDLReference
(
)
;
return
p
;
}
bool
CrossProcessCompositorBridgeParent
:
:
DeallocPLayerTransactionParent
(
PLayerTransactionParent
*
aLayers
)
{
LayerTransactionParent
*
slp
=
static_cast
<
LayerTransactionParent
*
>
(
aLayers
)
;
EraseLayerState
(
slp
-
>
GetId
(
)
)
;
static_cast
<
LayerTransactionParent
*
>
(
aLayers
)
-
>
ReleaseIPDLReference
(
)
;
return
true
;
}
mozilla
:
:
ipc
:
:
IPCResult
CrossProcessCompositorBridgeParent
:
:
RecvAsyncPanZoomEnabled
(
const
uint64_t
&
aLayersId
bool
*
aHasAPZ
)
{
if
(
!
LayerTreeOwnerTracker
:
:
Get
(
)
-
>
IsMapped
(
aLayersId
OtherPid
(
)
)
)
{
NS_ERROR
(
"
Unexpected
layers
id
in
RecvAsyncPanZoomEnabled
;
dropping
message
.
.
.
"
)
;
return
IPC_FAIL_NO_REASON
(
this
)
;
}
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
CompositorBridgeParent
:
:
LayerTreeState
&
state
=
sIndirectLayerTrees
[
aLayersId
]
;
*
aHasAPZ
=
state
.
mParent
?
state
.
mParent
-
>
AsyncPanZoomEnabled
(
)
:
false
;
return
IPC_OK
(
)
;
}
PAPZCTreeManagerParent
*
CrossProcessCompositorBridgeParent
:
:
AllocPAPZCTreeManagerParent
(
const
uint64_t
&
aLayersId
)
{
if
(
!
LayerTreeOwnerTracker
:
:
Get
(
)
-
>
IsMapped
(
aLayersId
OtherPid
(
)
)
)
{
NS_ERROR
(
"
Unexpected
layers
id
in
AllocPAPZCTreeManagerParent
;
dropping
message
.
.
.
"
)
;
return
nullptr
;
}
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
CompositorBridgeParent
:
:
LayerTreeState
&
state
=
sIndirectLayerTrees
[
aLayersId
]
;
MOZ_ASSERT
(
state
.
mParent
)
;
MOZ_ASSERT
(
!
state
.
mApzcTreeManagerParent
)
;
state
.
mApzcTreeManagerParent
=
new
APZCTreeManagerParent
(
aLayersId
state
.
mParent
-
>
GetAPZCTreeManager
(
)
)
;
return
state
.
mApzcTreeManagerParent
;
}
bool
CrossProcessCompositorBridgeParent
:
:
DeallocPAPZCTreeManagerParent
(
PAPZCTreeManagerParent
*
aActor
)
{
APZCTreeManagerParent
*
parent
=
static_cast
<
APZCTreeManagerParent
*
>
(
aActor
)
;
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
auto
iter
=
sIndirectLayerTrees
.
find
(
parent
-
>
LayersId
(
)
)
;
if
(
iter
!
=
sIndirectLayerTrees
.
end
(
)
)
{
CompositorBridgeParent
:
:
LayerTreeState
&
state
=
iter
-
>
second
;
MOZ_ASSERT
(
state
.
mApzcTreeManagerParent
=
=
parent
)
;
state
.
mApzcTreeManagerParent
=
nullptr
;
}
delete
parent
;
return
true
;
}
PAPZParent
*
CrossProcessCompositorBridgeParent
:
:
AllocPAPZParent
(
const
uint64_t
&
aLayersId
)
{
if
(
!
LayerTreeOwnerTracker
:
:
Get
(
)
-
>
IsMapped
(
aLayersId
OtherPid
(
)
)
)
{
NS_ERROR
(
"
Unexpected
layers
id
in
AllocPAPZParent
;
dropping
message
.
.
.
"
)
;
return
nullptr
;
}
RemoteContentController
*
controller
=
new
RemoteContentController
(
)
;
controller
-
>
AddRef
(
)
;
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
CompositorBridgeParent
:
:
LayerTreeState
&
state
=
sIndirectLayerTrees
[
aLayersId
]
;
MOZ_ASSERT
(
!
state
.
mController
)
;
state
.
mController
=
controller
;
return
controller
;
}
bool
CrossProcessCompositorBridgeParent
:
:
DeallocPAPZParent
(
PAPZParent
*
aActor
)
{
RemoteContentController
*
controller
=
static_cast
<
RemoteContentController
*
>
(
aActor
)
;
controller
-
>
Release
(
)
;
return
true
;
}
PWebRenderBridgeParent
*
CrossProcessCompositorBridgeParent
:
:
AllocPWebRenderBridgeParent
(
const
uint64_t
&
aPipelineId
const
nsString
&
aResourcePath
)
{
#
ifndef
MOZ_ENABLE_WEBRENDER
MOZ_RELEASE_ASSERT
(
false
)
;
#
endif
if
(
!
LayerTreeOwnerTracker
:
:
Get
(
)
-
>
IsMapped
(
aPipelineId
OtherPid
(
)
)
)
{
NS_ERROR
(
"
Unexpected
layers
id
in
AllocPAPZCTreeManagerParent
;
dropping
message
.
.
.
"
)
;
return
nullptr
;
}
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
MOZ_ASSERT
(
sIndirectLayerTrees
.
find
(
aPipelineId
)
!
=
sIndirectLayerTrees
.
end
(
)
)
;
MOZ_ASSERT
(
sIndirectLayerTrees
[
aPipelineId
]
.
mWRBridge
=
=
nullptr
)
;
CompositorBridgeParent
*
cbp
=
sIndirectLayerTrees
[
aPipelineId
]
.
mParent
;
WebRenderBridgeParent
*
root
=
sIndirectLayerTrees
[
cbp
-
>
RootLayerTreeId
(
)
]
.
mWRBridge
.
get
(
)
;
WebRenderBridgeParent
*
parent
=
new
WebRenderBridgeParent
(
aPipelineId
nullptr
nullptr
root
-
>
GLContext
(
)
root
-
>
WindowState
(
)
)
;
parent
-
>
AddRef
(
)
;
sIndirectLayerTrees
[
aPipelineId
]
.
mWRBridge
=
parent
;
return
parent
;
}
bool
CrossProcessCompositorBridgeParent
:
:
DeallocPWebRenderBridgeParent
(
PWebRenderBridgeParent
*
aActor
)
{
#
ifndef
MOZ_ENABLE_WEBRENDER
MOZ_RELEASE_ASSERT
(
false
)
;
#
endif
WebRenderBridgeParent
*
parent
=
static_cast
<
WebRenderBridgeParent
*
>
(
aActor
)
;
{
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
auto
it
=
sIndirectLayerTrees
.
find
(
parent
-
>
PipelineId
(
)
)
;
if
(
it
!
=
sIndirectLayerTrees
.
end
(
)
)
{
it
-
>
second
.
mWRBridge
=
nullptr
;
}
}
parent
-
>
Release
(
)
;
return
true
;
}
mozilla
:
:
ipc
:
:
IPCResult
CrossProcessCompositorBridgeParent
:
:
RecvNotifyChildCreated
(
const
uint64_t
&
child
)
{
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
for
(
LayerTreeMap
:
:
iterator
it
=
sIndirectLayerTrees
.
begin
(
)
;
it
!
=
sIndirectLayerTrees
.
end
(
)
;
it
+
+
)
{
CompositorBridgeParent
:
:
LayerTreeState
*
lts
=
&
it
-
>
second
;
if
(
lts
-
>
mParent
&
&
lts
-
>
mCrossProcessParent
=
=
this
)
{
lts
-
>
mParent
-
>
NotifyChildCreated
(
child
)
;
return
IPC_OK
(
)
;
}
}
return
IPC_FAIL_NO_REASON
(
this
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
ShadowLayersUpdated
(
LayerTransactionParent
*
aLayerTree
const
uint64_t
&
aTransactionId
const
TargetConfig
&
aTargetConfig
const
InfallibleTArray
<
PluginWindowData
>
&
aPlugins
bool
aIsFirstPaint
bool
aScheduleComposite
uint32_t
aPaintSequenceNumber
bool
aIsRepeatTransaction
int32_t
bool
aHitTestUpdate
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
)
{
return
;
}
MOZ_ASSERT
(
state
-
>
mParent
)
;
state
-
>
mParent
-
>
ScheduleRotationOnCompositorThread
(
aTargetConfig
aIsFirstPaint
)
;
Layer
*
shadowRoot
=
aLayerTree
-
>
GetRoot
(
)
;
if
(
shadowRoot
)
{
CompositorBridgeParent
:
:
SetShadowProperties
(
shadowRoot
)
;
}
UpdateIndirectTree
(
id
shadowRoot
aTargetConfig
)
;
state
-
>
mPluginData
=
aPlugins
;
state
-
>
mUpdatedPluginDataAvailable
=
true
;
state
-
>
mParent
-
>
NotifyShadowTreeTransaction
(
id
aIsFirstPaint
aScheduleComposite
aPaintSequenceNumber
aIsRepeatTransaction
aHitTestUpdate
)
;
if
(
mNotifyAfterRemotePaint
)
{
Unused
<
<
SendRemotePaintIsReady
(
)
;
mNotifyAfterRemotePaint
=
false
;
}
if
(
aLayerTree
-
>
ShouldParentObserveEpoch
(
)
)
{
Unused
<
<
state
-
>
mParent
-
>
SendObserveLayerUpdate
(
id
aLayerTree
-
>
GetChildEpoch
(
)
true
)
;
}
aLayerTree
-
>
SetPendingTransactionId
(
aTransactionId
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
DidComposite
(
uint64_t
aId
TimeStamp
&
aCompositeStart
TimeStamp
&
aCompositeEnd
)
{
sIndirectLayerTreesLock
-
>
AssertCurrentThreadOwns
(
)
;
if
(
LayerTransactionParent
*
layerTree
=
sIndirectLayerTrees
[
aId
]
.
mLayerTree
)
{
Unused
<
<
SendDidComposite
(
aId
layerTree
-
>
GetPendingTransactionId
(
)
aCompositeStart
aCompositeEnd
)
;
layerTree
-
>
SetPendingTransactionId
(
0
)
;
}
}
void
CrossProcessCompositorBridgeParent
:
:
ForceComposite
(
LayerTransactionParent
*
aLayerTree
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
CompositorBridgeParent
*
parent
;
{
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
parent
=
sIndirectLayerTrees
[
id
]
.
mParent
;
}
if
(
parent
)
{
parent
-
>
ForceComposite
(
aLayerTree
)
;
}
}
void
CrossProcessCompositorBridgeParent
:
:
NotifyClearCachedResources
(
LayerTransactionParent
*
aLayerTree
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
const
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
state
&
&
state
-
>
mParent
)
{
Unused
<
<
state
-
>
mParent
-
>
SendObserveLayerUpdate
(
id
aLayerTree
-
>
GetChildEpoch
(
)
false
)
;
}
}
bool
CrossProcessCompositorBridgeParent
:
:
SetTestSampleTime
(
LayerTransactionParent
*
aLayerTree
const
TimeStamp
&
aTime
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
const
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
)
{
return
false
;
}
MOZ_ASSERT
(
state
-
>
mParent
)
;
return
state
-
>
mParent
-
>
SetTestSampleTime
(
aLayerTree
aTime
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
LeaveTestMode
(
LayerTransactionParent
*
aLayerTree
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
const
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
)
{
return
;
}
MOZ_ASSERT
(
state
-
>
mParent
)
;
state
-
>
mParent
-
>
LeaveTestMode
(
aLayerTree
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
ApplyAsyncProperties
(
LayerTransactionParent
*
aLayerTree
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
const
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
)
{
return
;
}
MOZ_ASSERT
(
state
-
>
mParent
)
;
state
-
>
mParent
-
>
ApplyAsyncProperties
(
aLayerTree
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
FlushApzRepaints
(
const
LayerTransactionParent
*
aLayerTree
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
const
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
)
{
return
;
}
MOZ_ASSERT
(
state
-
>
mParent
)
;
state
-
>
mParent
-
>
FlushApzRepaints
(
aLayerTree
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
GetAPZTestData
(
const
LayerTransactionParent
*
aLayerTree
APZTestData
*
aOutData
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
*
aOutData
=
sIndirectLayerTrees
[
id
]
.
mApzTestData
;
}
void
CrossProcessCompositorBridgeParent
:
:
SetConfirmedTargetAPZC
(
const
LayerTransactionParent
*
aLayerTree
const
uint64_t
&
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
const
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
|
|
!
state
-
>
mParent
)
{
return
;
}
state
-
>
mParent
-
>
SetConfirmedTargetAPZC
(
aLayerTree
aInputBlockId
aTargets
)
;
}
AsyncCompositionManager
*
CrossProcessCompositorBridgeParent
:
:
GetCompositionManager
(
LayerTransactionParent
*
aLayerTree
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
const
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
)
{
return
nullptr
;
}
MOZ_ASSERT
(
state
-
>
mParent
)
;
return
state
-
>
mParent
-
>
GetCompositionManager
(
aLayerTree
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
CrossProcessCompositorBridgeParent
:
:
RecvAcknowledgeCompositorUpdate
(
const
uint64_t
&
aLayersId
)
{
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
CompositorBridgeParent
:
:
LayerTreeState
&
state
=
sIndirectLayerTrees
[
aLayersId
]
;
if
(
LayerTransactionParent
*
ltp
=
state
.
mLayerTree
)
{
ltp
-
>
AcknowledgeCompositorUpdate
(
)
;
}
MOZ_ASSERT
(
state
.
mPendingCompositorUpdates
>
0
)
;
state
.
mPendingCompositorUpdates
-
-
;
return
IPC_OK
(
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
DeferredDestroy
(
)
{
mCompositorThreadHolder
=
nullptr
;
mSelfRef
=
nullptr
;
}
CrossProcessCompositorBridgeParent
:
:
~
CrossProcessCompositorBridgeParent
(
)
{
MOZ_ASSERT
(
XRE_GetIOMessageLoop
(
)
)
;
MOZ_ASSERT
(
IToplevelProtocol
:
:
GetTransport
(
)
)
;
}
PTextureParent
*
CrossProcessCompositorBridgeParent
:
:
AllocPTextureParent
(
const
SurfaceDescriptor
&
aSharedData
const
LayersBackend
&
aLayersBackend
const
TextureFlags
&
aFlags
const
uint64_t
&
aId
const
uint64_t
&
aSerial
)
{
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
nullptr
;
LayerTreeMap
:
:
iterator
itr
=
sIndirectLayerTrees
.
find
(
aId
)
;
if
(
sIndirectLayerTrees
.
end
(
)
!
=
itr
)
{
state
=
&
itr
-
>
second
;
}
TextureFlags
flags
=
aFlags
;
if
(
!
state
|
|
state
-
>
mPendingCompositorUpdates
)
{
flags
|
=
TextureFlags
:
:
INVALID_COMPOSITOR
;
}
else
if
(
state
-
>
mLayerManager
&
&
state
-
>
mLayerManager
-
>
GetCompositor
(
)
&
&
aLayersBackend
!
=
state
-
>
mLayerManager
-
>
GetCompositor
(
)
-
>
GetBackendType
(
)
)
{
gfxDevCrash
(
gfx
:
:
LogReason
:
:
PAllocTextureBackendMismatch
)
<
<
"
Texture
backend
is
wrong
"
;
}
return
TextureHost
:
:
CreateIPDLActor
(
this
aSharedData
aLayersBackend
aFlags
aSerial
)
;
}
bool
CrossProcessCompositorBridgeParent
:
:
DeallocPTextureParent
(
PTextureParent
*
actor
)
{
return
TextureHost
:
:
DestroyIPDLActor
(
actor
)
;
}
bool
CrossProcessCompositorBridgeParent
:
:
IsSameProcess
(
)
const
{
return
OtherPid
(
)
=
=
base
:
:
GetCurrentProcId
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
CrossProcessCompositorBridgeParent
:
:
RecvClearApproximatelyVisibleRegions
(
const
uint64_t
&
aLayersId
const
uint32_t
&
aPresShellId
)
{
CompositorBridgeParent
*
parent
;
{
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
parent
=
sIndirectLayerTrees
[
aLayersId
]
.
mParent
;
}
if
(
parent
)
{
parent
-
>
ClearApproximatelyVisibleRegions
(
aLayersId
Some
(
aPresShellId
)
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
CrossProcessCompositorBridgeParent
:
:
RecvNotifyApproximatelyVisibleRegion
(
const
ScrollableLayerGuid
&
aGuid
const
CSSIntRegion
&
aRegion
)
{
CompositorBridgeParent
*
parent
;
{
MonitorAutoLock
lock
(
*
sIndirectLayerTreesLock
)
;
parent
=
sIndirectLayerTrees
[
aGuid
.
mLayersId
]
.
mParent
;
}
if
(
parent
)
{
if
(
!
parent
-
>
RecvNotifyApproximatelyVisibleRegion
(
aGuid
aRegion
)
)
{
return
IPC_FAIL_NO_REASON
(
this
)
;
}
return
IPC_OK
(
)
;
;
}
return
IPC_OK
(
)
;
}
void
CrossProcessCompositorBridgeParent
:
:
UpdatePaintTime
(
LayerTransactionParent
*
aLayerTree
const
TimeDuration
&
aPaintTime
)
{
uint64_t
id
=
aLayerTree
-
>
GetId
(
)
;
MOZ_ASSERT
(
id
!
=
0
)
;
CompositorBridgeParent
:
:
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
id
)
;
if
(
!
state
|
|
!
state
-
>
mParent
)
{
return
;
}
state
-
>
mParent
-
>
UpdatePaintTime
(
aLayerTree
aPaintTime
)
;
}
}
}
