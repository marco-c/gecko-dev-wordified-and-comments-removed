#
ifndef
mozilla_layers_CompositorBridgeChild_h
#
define
mozilla_layers_CompositorBridgeChild_h
#
include
"
base
/
basictypes
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
layers
/
PCompositorBridgeChild
.
h
"
#
include
"
mozilla
/
layers
/
TextureForwarder
.
h
"
#
include
"
mozilla
/
layers
/
PaintThread
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderTypes
.
h
"
#
include
"
nsClassHashtable
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsHashKeys
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
ThreadSafeRefcountingWithMainThreadDestruction
.
h
"
#
include
"
nsWeakReference
.
h
"
#
include
<
unordered_map
>
namespace
mozilla
{
namespace
dom
{
class
TabChild
;
}
namespace
widget
{
class
CompositorWidget
;
}
namespace
layers
{
using
mozilla
:
:
dom
:
:
TabChild
;
class
IAPZCTreeManager
;
class
APZCTreeManagerChild
;
class
ClientLayerManager
;
class
CompositorBridgeParent
;
class
CompositorManagerChild
;
class
CompositorOptions
;
class
TextureClient
;
class
TextureClientPool
;
struct
FrameMetrics
;
class
CompositorBridgeChild
final
:
public
PCompositorBridgeChild
public
TextureForwarder
{
typedef
InfallibleTArray
<
AsyncParentMessageData
>
AsyncParentMessageArray
;
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
CompositorBridgeChild
override
)
;
explicit
CompositorBridgeChild
(
CompositorManagerChild
*
aManager
)
;
void
InitForContent
(
uint32_t
aNamespace
)
;
void
InitForWidget
(
uint64_t
aProcessToken
LayerManager
*
aLayerManager
uint32_t
aNamespace
)
;
void
Destroy
(
)
;
bool
LookupCompositorFrameMetrics
(
const
FrameMetrics
:
:
ViewID
aId
FrameMetrics
&
)
;
static
CompositorBridgeChild
*
Get
(
)
;
static
bool
ChildProcessHasCompositorBridge
(
)
;
static
bool
CompositorIsInGPUProcess
(
)
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvDidComposite
(
const
LayersId
&
aId
const
TransactionId
&
aTransactionId
const
TimeStamp
&
aCompositeStart
const
TimeStamp
&
aCompositeEnd
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvInvalidateLayers
(
const
LayersId
&
aLayersId
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvUpdatePluginConfigurations
(
const
LayoutDeviceIntPoint
&
aContentOffset
const
LayoutDeviceIntRegion
&
aVisibleRegion
nsTArray
<
PluginWindowData
>
&
&
aPlugins
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvCaptureAllPlugins
(
const
uintptr_t
&
aParentWidget
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvHideAllPlugins
(
const
uintptr_t
&
aParentWidget
)
override
;
virtual
PTextureChild
*
AllocPTextureChild
(
const
SurfaceDescriptor
&
aSharedData
const
ReadLockDescriptor
&
aReadLock
const
LayersBackend
&
aLayersBackend
const
TextureFlags
&
aFlags
const
LayersId
&
aId
const
uint64_t
&
aSerial
const
wr
:
:
MaybeExternalImageId
&
aExternalImageId
)
override
;
virtual
bool
DeallocPTextureChild
(
PTextureChild
*
actor
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvParentAsyncMessages
(
InfallibleTArray
<
AsyncParentMessageData
>
&
&
aMessages
)
override
;
virtual
PTextureChild
*
CreateTexture
(
const
SurfaceDescriptor
&
aSharedData
const
ReadLockDescriptor
&
aReadLock
LayersBackend
aLayersBackend
TextureFlags
aFlags
uint64_t
aSerial
wr
:
:
MaybeExternalImageId
&
aExternalImageId
nsIEventTarget
*
aTarget
)
override
;
void
RequestNotifyAfterRemotePaint
(
TabChild
*
aTabChild
)
;
void
CancelNotifyAfterRemotePaint
(
TabChild
*
aTabChild
)
;
bool
SendWillClose
(
)
;
bool
SendPause
(
)
;
bool
SendResume
(
)
;
bool
SendNotifyChildCreated
(
const
LayersId
&
id
CompositorOptions
*
aOptions
)
;
bool
SendAdoptChild
(
const
LayersId
&
id
)
;
bool
SendMakeSnapshot
(
const
SurfaceDescriptor
&
inSnapshot
const
gfx
:
:
IntRect
&
dirtyRect
)
;
bool
SendFlushRendering
(
)
;
bool
SendGetTileSize
(
int32_t
*
tileWidth
int32_t
*
tileHeight
)
;
bool
SendStartFrameTimeRecording
(
const
int32_t
&
bufferSize
uint32_t
*
startIndex
)
;
bool
SendStopFrameTimeRecording
(
const
uint32_t
&
startIndex
nsTArray
<
float
>
*
intervals
)
;
bool
SendNotifyRegionInvalidated
(
const
nsIntRegion
&
region
)
;
bool
SendRequestNotifyAfterRemotePaint
(
)
;
bool
SendAllPluginsCaptured
(
)
;
bool
IsSameProcess
(
)
const
override
;
virtual
bool
IPCOpen
(
)
const
override
{
return
mCanSend
;
}
static
void
ShutDown
(
)
;
void
UpdateFwdTransactionId
(
)
{
+
+
mFwdTransactionId
;
}
uint64_t
GetFwdTransactionId
(
)
{
return
mFwdTransactionId
;
}
void
HoldUntilCompositableRefReleasedIfNecessary
(
TextureClient
*
aClient
)
;
void
NotifyNotUsed
(
uint64_t
aTextureId
uint64_t
aFwdTransactionId
)
;
virtual
void
CancelWaitForRecycle
(
uint64_t
aTextureId
)
override
;
TextureClientPool
*
GetTexturePool
(
KnowsCompositor
*
aAllocator
gfx
:
:
SurfaceFormat
aFormat
TextureFlags
aFlags
)
;
void
ClearTexturePool
(
)
;
virtual
FixedSizeSmallShmemSectionAllocator
*
GetTileLockAllocator
(
)
override
;
void
HandleMemoryPressure
(
)
;
virtual
MessageLoop
*
GetMessageLoop
(
)
const
override
{
return
mMessageLoop
;
}
virtual
base
:
:
ProcessId
GetParentPid
(
)
const
override
{
return
OtherPid
(
)
;
}
virtual
bool
AllocUnsafeShmem
(
size_t
aSize
mozilla
:
:
ipc
:
:
SharedMemory
:
:
SharedMemoryType
aShmType
mozilla
:
:
ipc
:
:
Shmem
*
aShmem
)
override
;
virtual
bool
AllocShmem
(
size_t
aSize
mozilla
:
:
ipc
:
:
SharedMemory
:
:
SharedMemoryType
aShmType
mozilla
:
:
ipc
:
:
Shmem
*
aShmem
)
override
;
virtual
bool
DeallocShmem
(
mozilla
:
:
ipc
:
:
Shmem
&
aShmem
)
override
;
PCompositorWidgetChild
*
AllocPCompositorWidgetChild
(
const
CompositorWidgetInitData
&
aInitData
)
override
;
bool
DeallocPCompositorWidgetChild
(
PCompositorWidgetChild
*
aActor
)
override
;
PAPZCTreeManagerChild
*
AllocPAPZCTreeManagerChild
(
const
LayersId
&
aLayersId
)
override
;
bool
DeallocPAPZCTreeManagerChild
(
PAPZCTreeManagerChild
*
aActor
)
override
;
PAPZChild
*
AllocPAPZChild
(
const
LayersId
&
aLayersId
)
override
;
bool
DeallocPAPZChild
(
PAPZChild
*
aActor
)
override
;
void
WillEndTransaction
(
)
;
PWebRenderBridgeChild
*
AllocPWebRenderBridgeChild
(
const
wr
:
:
PipelineId
&
aPipelineId
const
LayoutDeviceIntSize
&
TextureFactoryIdentifier
*
wr
:
:
IdNamespace
*
)
override
;
bool
DeallocPWebRenderBridgeChild
(
PWebRenderBridgeChild
*
aActor
)
override
;
wr
:
:
MaybeExternalImageId
GetNextExternalImageId
(
)
override
;
wr
:
:
PipelineId
GetNextPipelineId
(
)
;
void
FlushAsyncPaints
(
)
;
template
<
typename
CapturedState
>
void
NotifyBeginAsyncPaint
(
CapturedState
&
aState
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MonitorAutoLock
lock
(
mPaintLock
)
;
MOZ_ASSERT
(
!
mIsDelayingForAsyncPaints
)
;
mOutstandingAsyncPaints
+
+
;
aState
-
>
ForEachTextureClient
(
[
this
]
(
auto
aClient
)
{
aClient
-
>
AddPaintThreadRef
(
)
;
mTextureClientsForAsyncPaint
.
AppendElement
(
aClient
)
;
}
)
;
}
template
<
typename
CapturedState
>
bool
NotifyFinishedAsyncWorkerPaint
(
CapturedState
&
aState
)
{
MOZ_ASSERT
(
PaintThread
:
:
IsOnPaintThread
(
)
)
;
MonitorAutoLock
lock
(
mPaintLock
)
;
mOutstandingAsyncPaints
-
-
;
aState
-
>
ForEachTextureClient
(
[
]
(
auto
aClient
)
{
aClient
-
>
DropPaintThreadRef
(
)
;
}
)
;
aState
-
>
DropTextureClients
(
)
;
return
mOutstandingAsyncEndTransaction
&
&
mOutstandingAsyncPaints
=
=
0
;
}
bool
NotifyBeginAsyncEndLayerTransaction
(
SyncObjectClient
*
aSyncObject
)
;
void
NotifyFinishedAsyncEndLayerTransaction
(
)
;
void
PostponeMessagesIfAsyncPainting
(
)
;
private
:
virtual
~
CompositorBridgeChild
(
)
;
void
ResumeIPCAfterAsyncPaint
(
)
;
void
AfterDestroy
(
)
;
virtual
PLayerTransactionChild
*
AllocPLayerTransactionChild
(
const
nsTArray
<
LayersBackend
>
&
aBackendHints
const
LayersId
&
aId
)
override
;
virtual
bool
DeallocPLayerTransactionChild
(
PLayerTransactionChild
*
aChild
)
override
;
virtual
void
ActorDestroy
(
ActorDestroyReason
aWhy
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvSharedCompositorFrameMetrics
(
const
mozilla
:
:
ipc
:
:
SharedMemoryBasic
:
:
Handle
&
metrics
const
CrossProcessMutexHandle
&
handle
const
LayersId
&
aLayersId
const
uint32_t
&
aAPZCId
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvReleaseSharedCompositorFrameMetrics
(
const
ViewID
&
aId
const
uint32_t
&
aAPZCId
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvRemotePaintIsReady
(
)
override
;
mozilla
:
:
ipc
:
:
IPCResult
RecvObserveLayersUpdate
(
const
LayersId
&
aLayersId
const
LayersObserverEpoch
&
aEpoch
const
bool
&
aActive
)
override
;
virtual
mozilla
:
:
ipc
:
:
IPCResult
RecvNotifyWebRenderError
(
const
WebRenderError
&
aError
)
override
;
uint64_t
GetNextResourceId
(
)
;
void
ClearSharedFrameMetricsData
(
LayersId
aLayersId
)
;
class
SharedFrameMetricsData
{
public
:
SharedFrameMetricsData
(
const
mozilla
:
:
ipc
:
:
SharedMemoryBasic
:
:
Handle
&
metrics
const
CrossProcessMutexHandle
&
handle
const
LayersId
&
aLayersId
const
uint32_t
&
aAPZCId
)
;
~
SharedFrameMetricsData
(
)
;
void
CopyFrameMetrics
(
FrameMetrics
*
aFrame
)
;
FrameMetrics
:
:
ViewID
GetViewID
(
)
;
LayersId
GetLayersId
(
)
const
;
uint32_t
GetAPZCId
(
)
;
private
:
RefPtr
<
mozilla
:
:
ipc
:
:
SharedMemoryBasic
>
mBuffer
;
CrossProcessMutex
*
mMutex
;
LayersId
mLayersId
;
uint32_t
mAPZCId
;
}
;
RefPtr
<
CompositorManagerChild
>
mCompositorManager
;
RefPtr
<
LayerManager
>
mLayerManager
;
uint32_t
mIdNamespace
;
uint32_t
mResourceId
;
RefPtr
<
CompositorBridgeParent
>
mCompositorBridgeParent
;
nsClassHashtable
<
nsUint64HashKey
SharedFrameMetricsData
>
mFrameMetricsTable
;
nsWeakPtr
mWeakTabChild
;
DISALLOW_EVIL_CONSTRUCTORS
(
CompositorBridgeChild
)
;
bool
mCanSend
;
bool
mActorDestroyed
;
uint64_t
mFwdTransactionId
;
std
:
:
unordered_map
<
uint64_t
RefPtr
<
TextureClient
>
>
mTexturesWaitingRecycled
;
MessageLoop
*
mMessageLoop
;
AutoTArray
<
RefPtr
<
TextureClientPool
>
2
>
mTexturePools
;
uint64_t
mProcessToken
;
FixedSizeSmallShmemSectionAllocator
*
mSectionAllocator
;
nsTArray
<
RefPtr
<
TextureClient
>
>
mTextureClientsForAsyncPaint
;
Monitor
mPaintLock
;
size_t
mOutstandingAsyncPaints
;
bool
mOutstandingAsyncEndTransaction
;
RefPtr
<
SyncObjectClient
>
mOutstandingAsyncSyncObject
;
bool
mIsDelayingForAsyncPaints
;
uintptr_t
mSlowFlushCount
;
uintptr_t
mTotalFlushCount
;
}
;
}
}
#
endif
