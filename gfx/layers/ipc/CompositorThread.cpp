#
include
"
CompositorThread
.
h
"
#
include
"
CompositorBridgeParent
.
h
"
#
include
"
gfxGradientCache
.
h
"
#
include
"
MainThreadUtils
.
h
"
#
include
"
VRManagerParent
.
h
"
#
include
"
mozilla
/
BackgroundHangMonitor
.
h
"
#
include
"
mozilla
/
SpinEventLoopUntil
.
h
"
#
include
"
mozilla
/
gfx
/
gfxVars
.
h
"
#
include
"
mozilla
/
layers
/
CompositorManagerParent
.
h
"
#
include
"
mozilla
/
layers
/
ImageBridgeParent
.
h
"
#
include
"
mozilla
/
layers
/
VideoBridgeParent
.
h
"
#
include
"
mozilla
/
media
/
MediaSystemResourceService
.
h
"
#
include
"
nsThread
.
h
"
#
include
"
nsThreadUtils
.
h
"
namespace
mozilla
{
namespace
layers
{
static
StaticRefPtr
<
CompositorThreadHolder
>
sCompositorThreadHolder
;
static
Atomic
<
bool
>
sFinishedCompositorShutDown
(
false
)
;
static
mozilla
:
:
BackgroundHangMonitor
*
sBackgroundHangMonitor
;
static
ProfilerThreadId
sProfilerThreadId
;
nsIThread
*
CompositorThread
(
)
{
return
sCompositorThreadHolder
?
sCompositorThreadHolder
-
>
GetCompositorThread
(
)
:
nullptr
;
}
CompositorThreadHolder
*
CompositorThreadHolder
:
:
GetSingleton
(
)
{
return
sCompositorThreadHolder
;
}
CompositorThreadHolder
:
:
CompositorThreadHolder
(
)
:
mCompositorThread
(
CreateCompositorThread
(
)
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
CompositorThreadHolder
:
:
~
CompositorThreadHolder
(
)
{
sFinishedCompositorShutDown
=
true
;
}
already_AddRefed
<
nsIThread
>
CompositorThreadHolder
:
:
CreateCompositorThread
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
!
sCompositorThreadHolder
"
The
compositor
thread
has
already
been
started
!
"
)
;
uint32_t
stackSize
=
nsIThreadManager
:
:
DEFAULT_STACK_SIZE
;
if
(
stackSize
)
{
stackSize
=
std
:
:
max
(
stackSize
gfx
:
:
gfxVars
:
:
SupportsThreadsafeGL
(
)
&
&
!
gfx
:
:
gfxVars
:
:
UseCanvasRenderThread
(
)
?
4096U
<
<
10
:
512U
<
<
10
)
;
}
nsCOMPtr
<
nsIThread
>
compositorThread
;
nsresult
rv
=
NS_NewNamedThread
(
"
Compositor
"
getter_AddRefs
(
compositorThread
)
NS_NewRunnableFunction
(
"
CompositorThreadHolder
:
:
CompositorThreadHolderSetup
"
[
]
(
)
{
sProfilerThreadId
=
profiler_current_thread_id
(
)
;
sBackgroundHangMonitor
=
new
mozilla
:
:
BackgroundHangMonitor
(
"
Compositor
"
128
2048
)
;
nsCOMPtr
<
nsIThread
>
thread
=
NS_GetCurrentThread
(
)
;
static_cast
<
nsThread
*
>
(
thread
.
get
(
)
)
-
>
SetUseHangMonitor
(
true
)
;
}
)
{
.
stackSize
=
stackSize
}
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
nullptr
;
}
ImageBridgeParent
:
:
Setup
(
)
;
return
compositorThread
.
forget
(
)
;
}
void
CompositorThreadHolder
:
:
Start
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
"
Should
be
on
the
main
Thread
!
"
)
;
MOZ_ASSERT
(
!
sCompositorThreadHolder
"
The
compositor
thread
has
already
been
started
!
"
)
;
sProfilerThreadId
=
ProfilerThreadId
(
)
;
sCompositorThreadHolder
=
new
CompositorThreadHolder
(
)
;
if
(
!
sCompositorThreadHolder
-
>
GetCompositorThread
(
)
)
{
gfxCriticalNote
<
<
"
Compositor
thread
not
started
(
"
<
<
XRE_IsParentProcess
(
)
<
<
"
)
"
;
sCompositorThreadHolder
=
nullptr
;
}
}
void
CompositorThreadHolder
:
:
Shutdown
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
"
Should
be
on
the
main
Thread
!
"
)
;
if
(
!
sCompositorThreadHolder
)
{
return
;
}
ImageBridgeParent
:
:
Shutdown
(
)
;
gfx
:
:
VRManagerParent
:
:
Shutdown
(
)
;
MediaSystemResourceService
:
:
Shutdown
(
)
;
CompositorManagerParent
:
:
Shutdown
(
)
;
gfx
:
:
gfxGradientCache
:
:
Shutdown
(
)
;
CompositorThread
(
)
-
>
Dispatch
(
NS_NewRunnableFunction
(
"
CompositorThreadHolder
:
:
Shutdown
"
[
compositorThreadHolder
=
RefPtr
<
CompositorThreadHolder
>
(
sCompositorThreadHolder
)
backgroundHangMonitor
=
UniquePtr
<
mozilla
:
:
BackgroundHangMonitor
>
(
sBackgroundHangMonitor
)
]
(
)
{
VideoBridgeParent
:
:
UnregisterExternalImages
(
)
;
nsCOMPtr
<
nsIThread
>
thread
=
NS_GetCurrentThread
(
)
;
static_cast
<
nsThread
*
>
(
thread
.
get
(
)
)
-
>
SetUseHangMonitor
(
false
)
;
}
)
)
;
sCompositorThreadHolder
=
nullptr
;
sBackgroundHangMonitor
=
nullptr
;
SpinEventLoopUntil
(
"
CompositorThreadHolder
:
:
Shutdown
"
_ns
[
&
]
(
)
{
bool
finished
=
sFinishedCompositorShutDown
;
return
finished
;
}
)
;
CompositorBridgeParent
:
:
FinishShutdown
(
)
;
}
bool
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
{
if
(
!
CompositorThread
(
)
)
{
return
false
;
}
bool
in
=
false
;
MOZ_ALWAYS_SUCCEEDS
(
CompositorThread
(
)
-
>
IsOnCurrentThread
(
&
in
)
)
;
return
in
;
}
ProfilerThreadId
CompositorThreadHolder
:
:
GetThreadId
(
)
{
return
sCompositorThreadHolder
?
sProfilerThreadId
:
ProfilerThreadId
(
)
;
}
}
}
bool
NS_IsInCompositorThread
(
)
{
return
mozilla
:
:
layers
:
:
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
;
}
