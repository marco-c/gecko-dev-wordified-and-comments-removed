#
ifndef
gfx_layers_ipc_ImageBridgeParent_h_
#
define
gfx_layers_ipc_ImageBridgeParent_h_
#
include
<
stddef
.
h
>
#
include
<
stdint
.
h
>
#
include
"
CompositableTransactionParent
.
h
"
#
include
"
ImageContainerParent
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
ipc
/
SharedMemory
.
h
"
#
include
"
mozilla
/
layers
/
CompositorThread
.
h
"
#
include
"
mozilla
/
layers
/
PImageBridgeParent
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsTArrayForwardDeclare
.
h
"
class
MessageLoop
;
namespace
base
{
class
Thread
;
}
namespace
mozilla
{
namespace
ipc
{
class
Shmem
;
class
GeckoChildProcessHost
;
}
namespace
layers
{
class
ImageBridgeParent
final
:
public
PImageBridgeParent
public
CompositableParentManager
public
ShmemAllocator
{
public
:
typedef
InfallibleTArray
<
CompositableOperation
>
EditArray
;
typedef
InfallibleTArray
<
OpDestroy
>
OpDestroyArray
;
typedef
InfallibleTArray
<
EditReply
>
EditReplyArray
;
typedef
InfallibleTArray
<
AsyncChildMessageData
>
AsyncChildMessageArray
;
ImageBridgeParent
(
MessageLoop
*
aLoop
Transport
*
aTransport
ProcessId
aChildProcessId
)
;
~
ImageBridgeParent
(
)
;
virtual
ShmemAllocator
*
AsShmemAllocator
(
)
override
{
return
this
;
}
virtual
void
ActorDestroy
(
ActorDestroyReason
aWhy
)
override
;
static
PImageBridgeParent
*
Create
(
Transport
*
aTransport
ProcessId
aChildProcessId
ipc
:
:
GeckoChildProcessHost
*
aProcessHost
)
;
virtual
void
SendFenceHandleIfPresent
(
PTextureParent
*
aTexture
)
override
;
virtual
void
SendAsyncMessage
(
const
InfallibleTArray
<
AsyncParentMessageData
>
&
aMessage
)
override
;
virtual
base
:
:
ProcessId
GetChildProcessId
(
)
override
{
return
OtherPid
(
)
;
}
virtual
bool
RecvImageBridgeThreadId
(
const
PlatformThreadId
&
aThreadId
)
override
;
virtual
bool
RecvUpdate
(
EditArray
&
&
aEdits
OpDestroyArray
&
&
aToDestroy
EditReplyArray
*
aReply
)
override
;
virtual
bool
RecvUpdateNoSwap
(
EditArray
&
&
aEdits
OpDestroyArray
&
&
aToDestroy
)
override
;
PCompositableParent
*
AllocPCompositableParent
(
const
TextureInfo
&
aInfo
PImageContainerParent
*
aImageContainer
uint64_t
*
)
override
;
bool
DeallocPCompositableParent
(
PCompositableParent
*
aActor
)
override
;
virtual
PTextureParent
*
AllocPTextureParent
(
const
SurfaceDescriptor
&
aSharedData
const
LayersBackend
&
aLayersBackend
const
TextureFlags
&
aFlags
)
override
;
virtual
bool
DeallocPTextureParent
(
PTextureParent
*
actor
)
override
;
PMediaSystemResourceManagerParent
*
AllocPMediaSystemResourceManagerParent
(
)
override
;
bool
DeallocPMediaSystemResourceManagerParent
(
PMediaSystemResourceManagerParent
*
aActor
)
override
;
virtual
PImageContainerParent
*
AllocPImageContainerParent
(
)
override
;
virtual
bool
DeallocPImageContainerParent
(
PImageContainerParent
*
actor
)
override
;
virtual
bool
RecvChildAsyncMessages
(
InfallibleTArray
<
AsyncChildMessageData
>
&
&
aMessages
)
override
;
virtual
bool
RecvWillClose
(
)
override
;
MessageLoop
*
GetMessageLoop
(
)
const
{
return
mMessageLoop
;
}
virtual
bool
AllocShmem
(
size_t
aSize
ipc
:
:
SharedMemory
:
:
SharedMemoryType
aType
ipc
:
:
Shmem
*
aShmem
)
override
;
virtual
bool
AllocUnsafeShmem
(
size_t
aSize
ipc
:
:
SharedMemory
:
:
SharedMemoryType
aType
ipc
:
:
Shmem
*
aShmem
)
override
;
virtual
void
DeallocShmem
(
ipc
:
:
Shmem
&
aShmem
)
override
;
virtual
bool
IsSameProcess
(
)
const
override
;
virtual
void
ReplyRemoveTexture
(
const
OpReplyRemoveTexture
&
aReply
)
override
;
static
void
ReplyRemoveTexture
(
base
:
:
ProcessId
aChildProcessId
const
OpReplyRemoveTexture
&
aReply
)
;
void
AppendDeliverFenceMessage
(
uint64_t
aDestHolderId
uint64_t
aTransactionId
PTextureParent
*
aTexture
)
;
static
void
AppendDeliverFenceMessage
(
base
:
:
ProcessId
aChildProcessId
uint64_t
aDestHolderId
uint64_t
aTransactionId
PTextureParent
*
aTexture
)
;
using
CompositableParentManager
:
:
SendPendingAsyncMessages
;
static
void
SendPendingAsyncMessages
(
base
:
:
ProcessId
aChildProcessId
)
;
static
ImageBridgeParent
*
GetInstance
(
ProcessId
aId
)
;
static
bool
NotifyImageComposites
(
nsTArray
<
ImageCompositeNotification
>
&
aNotifications
)
;
IToplevelProtocol
*
CloneToplevel
(
const
InfallibleTArray
<
ProtocolFdMapping
>
&
aFds
base
:
:
ProcessHandle
aPeerProcess
mozilla
:
:
ipc
:
:
ProtocolCloneContext
*
aCtx
)
override
;
virtual
bool
UsesImageBridge
(
)
const
override
{
return
true
;
}
virtual
bool
IPCOpen
(
)
const
override
{
return
!
mClosed
;
}
protected
:
void
OnChannelConnected
(
int32_t
pid
)
override
;
private
:
void
DeferredDestroy
(
)
;
MessageLoop
*
mMessageLoop
;
Transport
*
mTransport
;
RefPtr
<
ImageBridgeParent
>
mSelfRef
;
bool
mSetChildThreadPriority
;
bool
mClosed
;
ipc
:
:
GeckoChildProcessHost
*
mSubprocess
;
static
std
:
:
map
<
base
:
:
ProcessId
ImageBridgeParent
*
>
sImageBridges
;
static
MessageLoop
*
sMainLoop
;
RefPtr
<
CompositorThreadHolder
>
mCompositorThreadHolder
;
}
;
}
}
#
endif
