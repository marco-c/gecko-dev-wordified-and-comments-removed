#
include
"
SharedSurfacesParent
.
h
"
#
include
"
mozilla
/
DebugOnly
.
h
"
#
include
"
mozilla
/
layers
/
SourceSurfaceSharedData
.
h
"
#
include
"
mozilla
/
layers
/
CompositorThread
.
h
"
#
include
"
mozilla
/
webrender
/
RenderSharedSurfaceTextureHost
.
h
"
#
include
"
mozilla
/
webrender
/
RenderThread
.
h
"
namespace
mozilla
{
namespace
layers
{
using
namespace
mozilla
:
:
gfx
;
StaticMutex
SharedSurfacesParent
:
:
sMutex
;
StaticAutoPtr
<
SharedSurfacesParent
>
SharedSurfacesParent
:
:
sInstance
;
SharedSurfacesParent
:
:
SharedSurfacesParent
(
)
{
}
SharedSurfacesParent
:
:
~
SharedSurfacesParent
(
)
{
for
(
auto
i
=
mSurfaces
.
Iter
(
)
;
!
i
.
Done
(
)
;
i
.
Next
(
)
)
{
wr
:
:
RenderThread
:
:
Get
(
)
-
>
UnregisterExternalImageDuringShutdown
(
i
.
Key
(
)
)
;
}
}
void
SharedSurfacesParent
:
:
Initialize
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sInstance
)
{
sInstance
=
new
SharedSurfacesParent
(
)
;
}
}
void
SharedSurfacesParent
:
:
Shutdown
(
)
{
MOZ_ASSERT
(
wr
:
:
RenderThread
:
:
IsInRenderThread
(
)
)
;
StaticMutexAutoLock
lock
(
sMutex
)
;
sInstance
=
nullptr
;
}
already_AddRefed
<
DataSourceSurface
>
SharedSurfacesParent
:
:
Get
(
const
wr
:
:
ExternalImageId
&
aId
)
{
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sInstance
)
{
return
nullptr
;
}
RefPtr
<
SourceSurfaceSharedDataWrapper
>
surface
;
sInstance
-
>
mSurfaces
.
Get
(
wr
:
:
AsUint64
(
aId
)
getter_AddRefs
(
surface
)
)
;
return
surface
.
forget
(
)
;
}
already_AddRefed
<
DataSourceSurface
>
SharedSurfacesParent
:
:
Acquire
(
const
wr
:
:
ExternalImageId
&
aId
)
{
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sInstance
)
{
return
nullptr
;
}
RefPtr
<
SourceSurfaceSharedDataWrapper
>
surface
;
sInstance
-
>
mSurfaces
.
Get
(
wr
:
:
AsUint64
(
aId
)
getter_AddRefs
(
surface
)
)
;
if
(
surface
)
{
DebugOnly
<
bool
>
rv
=
surface
-
>
AddConsumer
(
)
;
MOZ_ASSERT
(
!
rv
)
;
}
return
surface
.
forget
(
)
;
}
bool
SharedSurfacesParent
:
:
Release
(
const
wr
:
:
ExternalImageId
&
aId
)
{
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sInstance
)
{
return
false
;
}
uint64_t
id
=
wr
:
:
AsUint64
(
aId
)
;
RefPtr
<
SourceSurfaceSharedDataWrapper
>
surface
;
sInstance
-
>
mSurfaces
.
Get
(
wr
:
:
AsUint64
(
aId
)
getter_AddRefs
(
surface
)
)
;
if
(
!
surface
)
{
return
false
;
}
if
(
surface
-
>
RemoveConsumer
(
)
)
{
wr
:
:
RenderThread
:
:
Get
(
)
-
>
UnregisterExternalImage
(
id
)
;
sInstance
-
>
mSurfaces
.
Remove
(
id
)
;
}
return
true
;
}
void
SharedSurfacesParent
:
:
AddSameProcess
(
const
wr
:
:
ExternalImageId
&
aId
SourceSurfaceSharedData
*
aSurface
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sInstance
)
{
return
;
}
RefPtr
<
SourceSurfaceSharedDataWrapper
>
surface
=
new
SourceSurfaceSharedDataWrapper
(
)
;
surface
-
>
Init
(
aSurface
)
;
uint64_t
id
=
wr
:
:
AsUint64
(
aId
)
;
MOZ_ASSERT
(
!
sInstance
-
>
mSurfaces
.
Contains
(
id
)
)
;
RefPtr
<
wr
:
:
RenderSharedSurfaceTextureHost
>
texture
=
new
wr
:
:
RenderSharedSurfaceTextureHost
(
surface
)
;
wr
:
:
RenderThread
:
:
Get
(
)
-
>
RegisterExternalImage
(
id
texture
.
forget
(
)
)
;
surface
-
>
AddConsumer
(
)
;
sInstance
-
>
mSurfaces
.
Put
(
id
surface
)
;
}
void
SharedSurfacesParent
:
:
RemoveSameProcess
(
const
wr
:
:
ExternalImageId
&
aId
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
Release
(
aId
)
;
}
void
SharedSurfacesParent
:
:
DestroyProcess
(
base
:
:
ProcessId
aPid
)
{
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sInstance
)
{
return
;
}
for
(
auto
i
=
sInstance
-
>
mSurfaces
.
Iter
(
)
;
!
i
.
Done
(
)
;
i
.
Next
(
)
)
{
SourceSurfaceSharedDataWrapper
*
surface
=
i
.
Data
(
)
;
if
(
surface
-
>
GetCreatorPid
(
)
=
=
aPid
&
&
surface
-
>
RemoveConsumer
(
)
)
{
wr
:
:
RenderThread
:
:
Get
(
)
-
>
UnregisterExternalImage
(
i
.
Key
(
)
)
;
i
.
Remove
(
)
;
}
}
}
void
SharedSurfacesParent
:
:
Add
(
const
wr
:
:
ExternalImageId
&
aId
const
SurfaceDescriptorShared
&
aDesc
base
:
:
ProcessId
aPid
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
MOZ_ASSERT
(
aPid
!
=
base
:
:
GetCurrentProcId
(
)
)
;
StaticMutexAutoLock
lock
(
sMutex
)
;
if
(
!
sInstance
)
{
return
;
}
RefPtr
<
SourceSurfaceSharedDataWrapper
>
surface
=
new
SourceSurfaceSharedDataWrapper
(
)
;
if
(
NS_WARN_IF
(
!
surface
-
>
Init
(
aDesc
.
size
(
)
aDesc
.
stride
(
)
aDesc
.
format
(
)
aDesc
.
handle
(
)
aPid
)
)
)
{
return
;
}
uint64_t
id
=
wr
:
:
AsUint64
(
aId
)
;
MOZ_ASSERT
(
!
sInstance
-
>
mSurfaces
.
Contains
(
id
)
)
;
RefPtr
<
wr
:
:
RenderSharedSurfaceTextureHost
>
texture
=
new
wr
:
:
RenderSharedSurfaceTextureHost
(
surface
)
;
wr
:
:
RenderThread
:
:
Get
(
)
-
>
RegisterExternalImage
(
id
texture
.
forget
(
)
)
;
surface
-
>
AddConsumer
(
)
;
sInstance
-
>
mSurfaces
.
Put
(
id
surface
.
forget
(
)
)
;
}
void
SharedSurfacesParent
:
:
Remove
(
const
wr
:
:
ExternalImageId
&
aId
)
{
DebugOnly
<
bool
>
rv
=
Release
(
aId
)
;
MOZ_ASSERT
(
rv
)
;
}
}
}
