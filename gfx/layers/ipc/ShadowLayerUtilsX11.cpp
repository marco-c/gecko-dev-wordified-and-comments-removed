#
include
"
ShadowLayerUtilsX11
.
h
"
#
include
<
X11
/
X
.
h
>
#
include
<
X11
/
Xlib
.
h
>
#
include
<
X11
/
extensions
/
Xrender
.
h
>
#
include
<
X11
/
extensions
/
render
.
h
>
#
include
"
cairo
-
xlib
.
h
"
#
include
"
X11UndefineNone
.
h
"
#
include
<
stdint
.
h
>
#
include
"
GLDefs
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
gfxXlibSurface
.
h
"
#
include
"
gfx2DGlue
.
h
"
#
include
"
mozilla
/
X11Util
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
layers
/
CompositableForwarder
.
h
"
#
include
"
mozilla
/
layers
/
CompositorTypes
.
h
"
#
include
"
mozilla
/
layers
/
ISurfaceAllocator
.
h
"
#
include
"
mozilla
/
layers
/
LayersMessageUtils
.
h
"
#
include
"
mozilla
/
layers
/
LayersSurfaces
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
gfxEnv
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsDebug
.
h
"
using
namespace
mozilla
:
:
gl
;
namespace
mozilla
{
namespace
gl
{
class
GLContext
;
class
TextureImage
;
}
namespace
layers
{
static
XRenderPictFormat
*
GetXRenderPictFormatFromId
(
Display
*
aDisplay
PictFormat
aFormatId
)
{
XRenderPictFormat
tmplate
;
tmplate
.
id
=
aFormatId
;
return
XRenderFindFormat
(
aDisplay
PictFormatID
&
tmplate
0
)
;
}
SurfaceDescriptorX11
:
:
SurfaceDescriptorX11
(
gfxXlibSurface
*
aSurf
bool
aForwardGLX
)
:
mId
(
aSurf
-
>
XDrawable
(
)
)
mSize
(
aSurf
-
>
GetSize
(
)
)
mGLXPixmap
(
X11None
)
{
const
XRenderPictFormat
*
pictFormat
=
aSurf
-
>
XRenderFormat
(
)
;
if
(
pictFormat
)
{
mFormat
=
pictFormat
-
>
id
;
}
else
{
mFormat
=
cairo_xlib_surface_get_visual
(
aSurf
-
>
CairoSurface
(
)
)
-
>
visualid
;
}
if
(
aForwardGLX
)
{
mGLXPixmap
=
aSurf
-
>
GetGLXPixmap
(
)
;
}
}
SurfaceDescriptorX11
:
:
SurfaceDescriptorX11
(
Drawable
aDrawable
XID
aFormatID
const
gfx
:
:
IntSize
&
aSize
)
:
mId
(
aDrawable
)
mFormat
(
aFormatID
)
mSize
(
aSize
)
mGLXPixmap
(
X11None
)
{
}
already_AddRefed
<
gfxXlibSurface
>
SurfaceDescriptorX11
:
:
OpenForeign
(
)
const
{
Display
*
display
=
DefaultXDisplay
(
)
;
if
(
!
display
)
{
return
nullptr
;
}
Screen
*
screen
=
DefaultScreenOfDisplay
(
display
)
;
RefPtr
<
gfxXlibSurface
>
surf
;
XRenderPictFormat
*
pictFormat
=
GetXRenderPictFormatFromId
(
display
mFormat
)
;
if
(
pictFormat
)
{
surf
=
new
gfxXlibSurface
(
screen
mId
pictFormat
mSize
)
;
}
else
{
Visual
*
visual
;
int
depth
;
FindVisualAndDepth
(
display
mFormat
&
visual
&
depth
)
;
if
(
!
visual
)
return
nullptr
;
surf
=
new
gfxXlibSurface
(
display
mId
visual
mSize
)
;
}
if
(
mGLXPixmap
)
surf
-
>
BindGLXPixmap
(
mGLXPixmap
)
;
return
surf
-
>
CairoStatus
(
)
?
nullptr
:
surf
.
forget
(
)
;
}
}
}
namespace
IPC
{
void
ParamTraits
<
mozilla
:
:
layers
:
:
SurfaceDescriptorX11
>
:
:
Write
(
Message
*
aMsg
const
paramType
&
aParam
)
{
WriteParam
(
aMsg
aParam
.
mId
)
;
WriteParam
(
aMsg
aParam
.
mSize
)
;
WriteParam
(
aMsg
aParam
.
mFormat
)
;
WriteParam
(
aMsg
aParam
.
mGLXPixmap
)
;
}
bool
ParamTraits
<
mozilla
:
:
layers
:
:
SurfaceDescriptorX11
>
:
:
Read
(
const
Message
*
aMsg
PickleIterator
*
aIter
paramType
*
aResult
)
{
return
(
ReadParam
(
aMsg
aIter
&
aResult
-
>
mId
)
&
&
ReadParam
(
aMsg
aIter
&
aResult
-
>
mSize
)
&
&
ReadParam
(
aMsg
aIter
&
aResult
-
>
mFormat
)
&
&
ReadParam
(
aMsg
aIter
&
aResult
-
>
mGLXPixmap
)
)
;
}
}
