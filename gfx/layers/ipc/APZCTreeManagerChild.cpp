#
include
"
mozilla
/
layers
/
APZCTreeManagerChild
.
h
"
#
include
"
InputData
.
h
"
#
include
"
mozilla
/
dom
/
BrowserParent
.
h
"
#
include
"
mozilla
/
layers
/
APZCCallbackHelper
.
h
"
#
include
"
mozilla
/
layers
/
APZInputBridgeChild
.
h
"
#
include
"
mozilla
/
layers
/
GeckoContentController
.
h
"
#
include
"
mozilla
/
layers
/
RemoteCompositorSession
.
h
"
#
ifdef
MOZ_WIDGET_ANDROID
#
include
"
mozilla
/
jni
/
Utils
.
h
"
#
endif
namespace
mozilla
{
namespace
layers
{
APZCTreeManagerChild
:
:
APZCTreeManagerChild
(
)
:
mCompositorSession
(
nullptr
)
mIPCOpen
(
false
)
{
}
APZCTreeManagerChild
:
:
~
APZCTreeManagerChild
(
)
=
default
;
void
APZCTreeManagerChild
:
:
SetCompositorSession
(
RemoteCompositorSession
*
aSession
)
{
MOZ_ASSERT
(
!
mCompositorSession
^
!
aSession
)
;
mCompositorSession
=
aSession
;
}
void
APZCTreeManagerChild
:
:
SetInputBridge
(
APZInputBridgeChild
*
aInputBridge
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
!
mInputBridge
)
;
mInputBridge
=
aInputBridge
;
}
void
APZCTreeManagerChild
:
:
Destroy
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
mInputBridge
)
{
mInputBridge
-
>
Destroy
(
)
;
mInputBridge
=
nullptr
;
}
}
void
APZCTreeManagerChild
:
:
SetKeyboardMap
(
const
KeyboardMap
&
aKeyboardMap
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendSetKeyboardMap
(
aKeyboardMap
)
;
}
void
APZCTreeManagerChild
:
:
ZoomToRect
(
const
ScrollableLayerGuid
&
aGuid
const
ZoomTarget
&
aZoomTarget
const
uint32_t
aFlags
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendZoomToRect
(
aGuid
aZoomTarget
aFlags
)
;
}
void
APZCTreeManagerChild
:
:
ContentReceivedInputBlock
(
uint64_t
aInputBlockId
bool
aPreventDefault
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendContentReceivedInputBlock
(
aInputBlockId
aPreventDefault
)
;
}
void
APZCTreeManagerChild
:
:
SetTargetAPZC
(
uint64_t
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendSetTargetAPZC
(
aInputBlockId
aTargets
)
;
}
void
APZCTreeManagerChild
:
:
UpdateZoomConstraints
(
const
ScrollableLayerGuid
&
aGuid
const
Maybe
<
ZoomConstraints
>
&
aConstraints
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
mIPCOpen
)
{
SendUpdateZoomConstraints
(
aGuid
aConstraints
)
;
}
}
void
APZCTreeManagerChild
:
:
SetDPI
(
float
aDpiValue
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendSetDPI
(
aDpiValue
)
;
}
void
APZCTreeManagerChild
:
:
SetAllowedTouchBehavior
(
uint64_t
aInputBlockId
const
nsTArray
<
TouchBehaviorFlags
>
&
aValues
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendSetAllowedTouchBehavior
(
aInputBlockId
aValues
)
;
}
void
APZCTreeManagerChild
:
:
StartScrollbarDrag
(
const
ScrollableLayerGuid
&
aGuid
const
AsyncDragMetrics
&
aDragMetrics
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendStartScrollbarDrag
(
aGuid
aDragMetrics
)
;
}
bool
APZCTreeManagerChild
:
:
StartAutoscroll
(
const
ScrollableLayerGuid
&
aGuid
const
ScreenPoint
&
aAnchorLocation
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
SendStartAutoscroll
(
aGuid
aAnchorLocation
)
;
}
void
APZCTreeManagerChild
:
:
StopAutoscroll
(
const
ScrollableLayerGuid
&
aGuid
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendStopAutoscroll
(
aGuid
)
;
}
void
APZCTreeManagerChild
:
:
SetLongTapEnabled
(
bool
aTapGestureEnabled
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
SendSetLongTapEnabled
(
aTapGestureEnabled
)
;
}
APZInputBridge
*
APZCTreeManagerChild
:
:
InputBridge
(
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
mInputBridge
)
;
return
mInputBridge
.
get
(
)
;
}
void
APZCTreeManagerChild
:
:
AddIPDLReference
(
)
{
MOZ_ASSERT
(
mIPCOpen
=
=
false
)
;
mIPCOpen
=
true
;
AddRef
(
)
;
}
void
APZCTreeManagerChild
:
:
ReleaseIPDLReference
(
)
{
mIPCOpen
=
false
;
Release
(
)
;
}
void
APZCTreeManagerChild
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
mIPCOpen
=
false
;
}
mozilla
:
:
ipc
:
:
IPCResult
APZCTreeManagerChild
:
:
RecvHandleTap
(
const
TapType
&
aType
const
LayoutDevicePoint
&
aPoint
const
Modifiers
&
aModifiers
const
ScrollableLayerGuid
&
aGuid
const
uint64_t
&
aInputBlockId
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
if
(
mCompositorSession
&
&
mCompositorSession
-
>
RootLayerTreeId
(
)
=
=
aGuid
.
mLayersId
&
&
mCompositorSession
-
>
GetContentController
(
)
)
{
RefPtr
<
GeckoContentController
>
controller
=
mCompositorSession
-
>
GetContentController
(
)
;
controller
-
>
HandleTap
(
aType
aPoint
aModifiers
aGuid
aInputBlockId
)
;
return
IPC_OK
(
)
;
}
dom
:
:
BrowserParent
*
tab
=
dom
:
:
BrowserParent
:
:
GetBrowserParentFromLayersId
(
aGuid
.
mLayersId
)
;
if
(
tab
)
{
#
ifdef
MOZ_WIDGET_ANDROID
mozilla
:
:
jni
:
:
DispatchToGeckoPriorityQueue
(
NewRunnableMethod
<
TapType
LayoutDevicePoint
Modifiers
ScrollableLayerGuid
uint64_t
>
(
"
dom
:
:
BrowserParent
:
:
SendHandleTap
"
tab
&
dom
:
:
BrowserParent
:
:
SendHandleTap
aType
aPoint
aModifiers
aGuid
aInputBlockId
)
)
;
#
else
tab
-
>
SendHandleTap
(
aType
aPoint
aModifiers
aGuid
aInputBlockId
)
;
#
endif
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
APZCTreeManagerChild
:
:
RecvNotifyPinchGesture
(
const
PinchGestureType
&
aType
const
ScrollableLayerGuid
&
aGuid
const
LayoutDevicePoint
&
aFocusPoint
const
LayoutDeviceCoord
&
aSpanChange
const
Modifiers
&
aModifiers
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
mCompositorSession
&
&
mCompositorSession
-
>
GetWidget
(
)
)
{
APZCCallbackHelper
:
:
NotifyPinchGesture
(
aType
aFocusPoint
aSpanChange
aModifiers
mCompositorSession
-
>
GetWidget
(
)
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
APZCTreeManagerChild
:
:
RecvCancelAutoscroll
(
const
ScrollableLayerGuid
:
:
ViewID
&
aScrollId
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
APZCCallbackHelper
:
:
CancelAutoscroll
(
aScrollId
)
;
return
IPC_OK
(
)
;
}
}
}
