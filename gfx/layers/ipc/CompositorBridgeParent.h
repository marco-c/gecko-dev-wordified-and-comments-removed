#
ifndef
mozilla_layers_CompositorBridgeParent_h
#
define
mozilla_layers_CompositorBridgeParent_h
#
include
<
stdint
.
h
>
#
include
"
Layers
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
dom
/
ipc
/
IdType
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
ipc
/
SharedMemory
.
h
"
#
include
"
mozilla
/
layers
/
GeckoContentController
.
h
"
#
include
"
mozilla
/
layers
/
ISurfaceAllocator
.
h
"
#
include
"
mozilla
/
layers
/
LayersMessages
.
h
"
#
include
"
mozilla
/
layers
/
PCompositorBridgeParent
.
h
"
#
include
"
mozilla
/
layers
/
ShadowLayersManager
.
h
"
#
include
"
mozilla
/
layers
/
APZTestData
.
h
"
#
include
"
mozilla
/
widget
/
CompositorWidget
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
ThreadSafeRefcountingWithMainThreadDestruction
.
h
"
#
include
"
mozilla
/
VsyncDispatcher
.
h
"
class
MessageLoop
;
class
nsIWidget
;
namespace
mozilla
{
class
CancelableRunnable
;
namespace
gfx
{
class
DrawTarget
;
class
GPUProcessManager
;
}
namespace
ipc
{
class
Shmem
;
}
namespace
layers
{
class
APZCTreeManager
;
class
AsyncCompositionManager
;
class
Compositor
;
class
CompositorBridgeParent
;
class
LayerManagerComposite
;
class
LayerTransactionParent
;
class
PAPZParent
;
class
CrossProcessCompositorBridgeParent
;
class
CompositorThreadHolder
;
class
InProcessCompositorSession
;
struct
ScopedLayerTreeRegistration
{
ScopedLayerTreeRegistration
(
APZCTreeManager
*
aApzctm
uint64_t
aLayersId
Layer
*
aRoot
GeckoContentController
*
aController
)
;
~
ScopedLayerTreeRegistration
(
)
;
private
:
uint64_t
mLayersId
;
}
;
class
CompositorVsyncScheduler
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
CompositorVsyncScheduler
)
public
:
explicit
CompositorVsyncScheduler
(
CompositorBridgeParent
*
aCompositorBridgeParent
widget
:
:
CompositorWidget
*
aWidget
)
;
#
ifdef
MOZ_WIDGET_GONK
#
if
ANDROID_VERSION
>
=
19
void
SetDisplay
(
bool
aDisplayEnable
)
;
#
endif
#
endif
bool
NotifyVsync
(
TimeStamp
aVsyncTimestamp
)
;
void
SetNeedsComposite
(
)
;
void
OnForceComposeToTarget
(
)
;
void
ScheduleTask
(
already_AddRefed
<
CancelableRunnable
>
int
)
;
void
ResumeComposition
(
)
;
void
ComposeToTarget
(
gfx
:
:
DrawTarget
*
aTarget
const
gfx
:
:
IntRect
*
aRect
=
nullptr
)
;
void
PostCompositeTask
(
TimeStamp
aCompositeTimestamp
)
;
void
Destroy
(
)
;
void
ScheduleComposition
(
)
;
void
CancelCurrentCompositeTask
(
)
;
bool
NeedsComposite
(
)
;
void
Composite
(
TimeStamp
aVsyncTimestamp
)
;
void
ForceComposeToTarget
(
gfx
:
:
DrawTarget
*
aTarget
const
gfx
:
:
IntRect
*
aRect
)
;
const
TimeStamp
&
GetLastComposeTime
(
)
{
return
mLastCompose
;
}
#
ifdef
COMPOSITOR_PERFORMANCE_WARNING
const
TimeStamp
&
GetExpectedComposeStartTime
(
)
{
return
mExpectedComposeStartTime
;
}
#
endif
private
:
virtual
~
CompositorVsyncScheduler
(
)
;
void
NotifyCompositeTaskExecuted
(
)
;
void
ObserveVsync
(
)
;
void
UnobserveVsync
(
)
;
void
DispatchTouchEvents
(
TimeStamp
aVsyncTimestamp
)
;
void
DispatchVREvents
(
TimeStamp
aVsyncTimestamp
)
;
void
CancelCurrentSetNeedsCompositeTask
(
)
;
#
ifdef
MOZ_WIDGET_GONK
#
if
ANDROID_VERSION
>
=
19
void
CancelSetDisplayTask
(
)
;
#
endif
#
endif
class
Observer
final
:
public
VsyncObserver
{
public
:
explicit
Observer
(
CompositorVsyncScheduler
*
aOwner
)
;
virtual
bool
NotifyVsync
(
TimeStamp
aVsyncTimestamp
)
override
;
void
Destroy
(
)
;
private
:
virtual
~
Observer
(
)
;
Mutex
mMutex
;
CompositorVsyncScheduler
*
mOwner
;
}
;
CompositorBridgeParent
*
mCompositorBridgeParent
;
TimeStamp
mLastCompose
;
#
ifdef
COMPOSITOR_PERFORMANCE_WARNING
TimeStamp
mExpectedComposeStartTime
;
#
endif
bool
mAsapScheduling
;
bool
mIsObservingVsync
;
uint32_t
mNeedsComposite
;
int32_t
mVsyncNotificationsSkipped
;
widget
:
:
CompositorWidget
*
mWidget
;
RefPtr
<
CompositorVsyncScheduler
:
:
Observer
>
mVsyncObserver
;
mozilla
:
:
Monitor
mCurrentCompositeTaskMonitor
;
RefPtr
<
CancelableRunnable
>
mCurrentCompositeTask
;
mozilla
:
:
Monitor
mSetNeedsCompositeMonitor
;
RefPtr
<
CancelableRunnable
>
mSetNeedsCompositeTask
;
#
ifdef
MOZ_WIDGET_GONK
#
if
ANDROID_VERSION
>
=
19
bool
mDisplayEnabled
;
mozilla
:
:
Monitor
mSetDisplayMonitor
;
RefPtr
<
CancelableRunnable
>
mSetDisplayTask
;
#
endif
#
endif
}
;
class
CompositorUpdateObserver
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
CompositorUpdateObserver
)
;
virtual
void
ObserveUpdate
(
uint64_t
aLayersId
bool
aActive
)
=
0
;
protected
:
virtual
~
CompositorUpdateObserver
(
)
{
}
}
;
class
CompositorBridgeParent
final
:
public
PCompositorBridgeParent
public
ShadowLayersManager
public
CompositorBridgeParentIPCAllocator
public
ShmemAllocator
{
friend
class
CompositorVsyncScheduler
;
friend
class
CompositorThreadHolder
;
friend
class
InProcessCompositorSession
;
friend
class
gfx
:
:
GPUProcessManager
;
public
:
explicit
CompositorBridgeParent
(
CSSToLayoutDeviceScale
aScale
const
TimeDuration
&
aVsyncRate
bool
aUseExternalSurfaceSize
const
gfx
:
:
IntSize
&
aSurfaceSize
)
;
void
InitSameProcess
(
widget
:
:
CompositorWidget
*
aWidget
const
uint64_t
&
aLayerTreeId
bool
aUseAPZ
)
;
bool
Bind
(
Endpoint
<
PCompositorBridgeParent
>
&
&
aEndpoint
)
;
virtual
bool
RecvInitialize
(
const
uint64_t
&
aRootLayerTreeId
)
override
;
virtual
bool
RecvGetFrameUniformity
(
FrameUniformityData
*
aOutData
)
override
;
virtual
bool
RecvRequestOverfill
(
)
override
;
virtual
bool
RecvWillClose
(
)
override
;
virtual
bool
RecvPause
(
)
override
;
virtual
bool
RecvResume
(
)
override
;
virtual
bool
RecvNotifyChildCreated
(
const
uint64_t
&
child
)
override
;
virtual
bool
RecvAdoptChild
(
const
uint64_t
&
child
)
override
;
virtual
bool
RecvMakeSnapshot
(
const
SurfaceDescriptor
&
aInSnapshot
const
gfx
:
:
IntRect
&
aRect
)
override
;
virtual
bool
RecvFlushRendering
(
)
override
;
virtual
bool
RecvForcePresent
(
)
override
;
virtual
bool
RecvAcknowledgeCompositorUpdate
(
const
uint64_t
&
aLayersId
)
override
{
MOZ_ASSERT_UNREACHABLE
(
"
This
message
is
only
sent
cross
-
process
"
)
;
return
true
;
}
virtual
bool
RecvNotifyRegionInvalidated
(
const
nsIntRegion
&
aRegion
)
override
;
virtual
bool
RecvStartFrameTimeRecording
(
const
int32_t
&
aBufferSize
uint32_t
*
aOutStartIndex
)
override
;
virtual
bool
RecvStopFrameTimeRecording
(
const
uint32_t
&
aStartIndex
InfallibleTArray
<
float
>
*
intervals
)
override
;
virtual
bool
RecvRequestNotifyAfterRemotePaint
(
)
override
{
return
true
;
}
;
virtual
bool
RecvClearVisibleRegions
(
const
uint64_t
&
aLayersId
const
uint32_t
&
aPresShellId
)
override
;
void
ClearVisibleRegions
(
const
uint64_t
&
aLayersId
const
Maybe
<
uint32_t
>
&
aPresShellId
)
;
virtual
bool
RecvUpdateVisibleRegion
(
const
VisibilityCounter
&
aCounter
const
ScrollableLayerGuid
&
aGuid
const
CSSIntRegion
&
aRegion
)
override
;
void
UpdateVisibleRegion
(
const
VisibilityCounter
&
aCounter
const
ScrollableLayerGuid
&
aGuid
const
CSSIntRegion
&
aRegion
)
;
virtual
bool
RecvAllPluginsCaptured
(
)
override
;
virtual
void
ActorDestroy
(
ActorDestroyReason
why
)
override
;
virtual
void
ShadowLayersUpdated
(
LayerTransactionParent
*
aLayerTree
const
uint64_t
&
aTransactionId
const
TargetConfig
&
aTargetConfig
const
InfallibleTArray
<
PluginWindowData
>
&
aPlugins
bool
aIsFirstPaint
bool
aScheduleComposite
uint32_t
aPaintSequenceNumber
bool
aIsRepeatTransaction
int32_t
aPaintSyncId
bool
aHitTestUpdate
)
override
;
virtual
void
ForceComposite
(
LayerTransactionParent
*
aLayerTree
)
override
;
virtual
bool
SetTestSampleTime
(
LayerTransactionParent
*
aLayerTree
const
TimeStamp
&
aTime
)
override
;
virtual
void
LeaveTestMode
(
LayerTransactionParent
*
aLayerTree
)
override
;
virtual
void
ApplyAsyncProperties
(
LayerTransactionParent
*
aLayerTree
)
override
;
virtual
void
FlushApzRepaints
(
const
LayerTransactionParent
*
aLayerTree
)
override
;
virtual
void
GetAPZTestData
(
const
LayerTransactionParent
*
aLayerTree
APZTestData
*
aOutData
)
override
;
virtual
void
SetConfirmedTargetAPZC
(
const
LayerTransactionParent
*
aLayerTree
const
uint64_t
&
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
)
override
;
virtual
AsyncCompositionManager
*
GetCompositionManager
(
LayerTransactionParent
*
aLayerTree
)
override
{
return
mCompositionManager
;
}
virtual
PTextureParent
*
AllocPTextureParent
(
const
SurfaceDescriptor
&
aSharedData
const
LayersBackend
&
aLayersBackend
const
TextureFlags
&
aFlags
const
uint64_t
&
aId
const
uint64_t
&
aSerial
)
override
;
virtual
bool
DeallocPTextureParent
(
PTextureParent
*
actor
)
override
;
virtual
bool
IsSameProcess
(
)
const
override
;
virtual
ShmemAllocator
*
AsShmemAllocator
(
)
override
{
return
this
;
}
virtual
bool
AllocShmem
(
size_t
aSize
mozilla
:
:
ipc
:
:
SharedMemory
:
:
SharedMemoryType
aType
mozilla
:
:
ipc
:
:
Shmem
*
aShmem
)
override
;
virtual
bool
AllocUnsafeShmem
(
size_t
aSize
mozilla
:
:
ipc
:
:
SharedMemory
:
:
SharedMemoryType
aType
mozilla
:
:
ipc
:
:
Shmem
*
aShmem
)
override
;
virtual
void
DeallocShmem
(
mozilla
:
:
ipc
:
:
Shmem
&
aShmem
)
override
;
PCompositorWidgetParent
*
AllocPCompositorWidgetParent
(
const
CompositorWidgetInitData
&
aInitData
)
override
;
bool
DeallocPCompositorWidgetParent
(
PCompositorWidgetParent
*
aActor
)
override
;
virtual
base
:
:
ProcessId
GetChildProcessId
(
)
override
{
return
OtherPid
(
)
;
}
virtual
void
SendAsyncMessage
(
const
InfallibleTArray
<
AsyncParentMessageData
>
&
aMessage
)
override
;
virtual
CompositorBridgeParentIPCAllocator
*
AsCompositorBridgeParentIPCAllocator
(
)
override
{
return
this
;
}
bool
ResetCompositor
(
const
nsTArray
<
LayersBackend
>
&
aBackendHints
TextureFactoryIdentifier
*
aOutIdentifier
)
;
void
ForceIsFirstPaint
(
)
;
static
void
SetShadowProperties
(
Layer
*
aLayer
)
;
void
NotifyChildCreated
(
uint64_t
aChild
)
;
void
AsyncRender
(
)
;
void
ScheduleRenderOnCompositorThread
(
)
;
void
SchedulePauseOnCompositorThread
(
)
;
void
InvalidateOnCompositorThread
(
)
;
bool
ScheduleResumeOnCompositorThread
(
)
;
bool
ScheduleResumeOnCompositorThread
(
int
width
int
height
)
;
virtual
void
ScheduleComposition
(
)
;
void
NotifyShadowTreeTransaction
(
uint64_t
aId
bool
aIsFirstPaint
bool
aScheduleComposite
uint32_t
aPaintSequenceNumber
bool
aIsRepeatTransaction
bool
aHitTestUpdate
)
;
void
ScheduleRotationOnCompositorThread
(
const
TargetConfig
&
aTargetConfig
bool
aIsFirstPaint
)
;
uint64_t
RootLayerTreeId
(
)
;
void
InvalidateRemoteLayers
(
)
;
static
CompositorBridgeParent
*
GetCompositorBridgeParent
(
uint64_t
id
)
;
static
void
NotifyVsync
(
const
TimeStamp
&
aTimeStamp
const
uint64_t
&
aLayersId
)
;
static
void
SetControllerForLayerTree
(
uint64_t
aLayersId
GeckoContentController
*
aController
)
;
static
bool
CreateForContent
(
Endpoint
<
PCompositorBridgeParent
>
&
&
aEndpoint
)
;
struct
LayerTreeState
{
LayerTreeState
(
)
;
~
LayerTreeState
(
)
;
RefPtr
<
Layer
>
mRoot
;
RefPtr
<
GeckoContentController
>
mController
;
CompositorBridgeParent
*
mParent
;
LayerManagerComposite
*
mLayerManager
;
CrossProcessCompositorBridgeParent
*
mCrossProcessParent
;
TargetConfig
mTargetConfig
;
APZTestData
mApzTestData
;
LayerTransactionParent
*
mLayerTree
;
nsTArray
<
PluginWindowData
>
mPluginData
;
bool
mUpdatedPluginDataAvailable
;
RefPtr
<
CompositorUpdateObserver
>
mLayerTreeReadyObserver
;
RefPtr
<
CompositorUpdateObserver
>
mLayerTreeClearedObserver
;
uint32_t
mPendingCompositorUpdates
;
PCompositorBridgeParent
*
CrossProcessPCompositorBridge
(
)
const
;
}
;
static
LayerTreeState
*
GetIndirectShadowTree
(
uint64_t
aId
)
;
#
if
defined
(
XP_WIN
)
|
|
defined
(
MOZ_WIDGET_GTK
)
bool
UpdatePluginWindowState
(
uint64_t
aId
)
;
void
ScheduleShowAllPluginWindows
(
)
;
void
ScheduleHideAllPluginWindows
(
)
;
void
ShowAllPluginWindows
(
)
;
void
HideAllPluginWindows
(
)
;
#
endif
virtual
bool
RecvRemotePluginsReady
(
)
override
;
static
void
PostInsertVsyncProfilerMarker
(
mozilla
:
:
TimeStamp
aVsyncTimestamp
)
;
widget
:
:
CompositorWidget
*
GetWidget
(
)
{
return
mWidget
;
}
void
ForceComposeToTarget
(
gfx
:
:
DrawTarget
*
aTarget
const
gfx
:
:
IntRect
*
aRect
=
nullptr
)
;
bool
AsyncPanZoomEnabled
(
)
const
{
return
!
!
mApzcTreeManager
;
}
private
:
void
Initialize
(
)
;
void
StopAndClearResources
(
)
;
static
already_AddRefed
<
APZCTreeManager
>
GetAPZCTreeManager
(
uint64_t
aLayersId
)
;
static
void
DeallocateLayerTreeId
(
uint64_t
aId
)
;
static
void
RequestNotifyLayerTreeReady
(
uint64_t
aLayersId
CompositorUpdateObserver
*
aObserver
)
;
static
void
RequestNotifyLayerTreeCleared
(
uint64_t
aLayersId
CompositorUpdateObserver
*
aObserver
)
;
static
void
SwapLayerTreeObservers
(
uint64_t
aLayer
uint64_t
aOtherLayer
)
;
static
bool
UpdateRemoteContentController
(
uint64_t
aLayersId
dom
:
:
ContentParent
*
aContentParent
const
dom
:
:
TabId
&
aTabId
dom
:
:
TabParent
*
aBrowserParent
)
;
protected
:
virtual
~
CompositorBridgeParent
(
)
;
void
DeferredDestroy
(
)
;
virtual
PLayerTransactionParent
*
AllocPLayerTransactionParent
(
const
nsTArray
<
LayersBackend
>
&
aBackendHints
const
uint64_t
&
aId
TextureFactoryIdentifier
*
aTextureFactoryIdentifier
bool
*
aSuccess
)
override
;
virtual
bool
DeallocPLayerTransactionParent
(
PLayerTransactionParent
*
aLayers
)
override
;
virtual
void
ScheduleTask
(
already_AddRefed
<
CancelableRunnable
>
int
)
;
void
CompositeToTarget
(
gfx
:
:
DrawTarget
*
aTarget
const
gfx
:
:
IntRect
*
aRect
=
nullptr
)
;
void
SetEGLSurfaceSize
(
int
width
int
height
)
;
void
InitializeLayerManager
(
const
nsTArray
<
LayersBackend
>
&
aBackendHints
)
;
void
PauseComposition
(
)
;
void
ResumeComposition
(
)
;
void
ResumeCompositionAndResize
(
int
width
int
height
)
;
void
ForceComposition
(
)
;
void
CancelCurrentCompositeTask
(
)
;
void
Invalidate
(
)
;
RefPtr
<
Compositor
>
NewCompositor
(
const
nsTArray
<
LayersBackend
>
&
aBackendHints
)
;
void
ResetCompositorTask
(
const
nsTArray
<
LayersBackend
>
&
aBackendHints
Maybe
<
TextureFactoryIdentifier
>
*
aOutNewIdentifier
)
;
Maybe
<
TextureFactoryIdentifier
>
ResetCompositorImpl
(
const
nsTArray
<
LayersBackend
>
&
aBackendHints
)
;
static
void
AddCompositor
(
CompositorBridgeParent
*
compositor
uint64_t
*
id
)
;
static
CompositorBridgeParent
*
RemoveCompositor
(
uint64_t
id
)
;
static
void
Setup
(
)
;
static
void
Shutdown
(
)
;
static
void
FinishShutdown
(
)
;
bool
CanComposite
(
)
;
void
DidComposite
(
TimeStamp
&
aCompositeStart
TimeStamp
&
aCompositeEnd
)
;
template
<
typename
Lambda
>
inline
void
ForEachIndirectLayerTree
(
const
Lambda
&
aCallback
)
;
RefPtr
<
LayerManagerComposite
>
mLayerManager
;
RefPtr
<
Compositor
>
mCompositor
;
RefPtr
<
AsyncCompositionManager
>
mCompositionManager
;
widget
:
:
CompositorWidget
*
mWidget
;
TimeStamp
mTestTime
;
CSSToLayoutDeviceScale
mScale
;
TimeDuration
mVsyncRate
;
bool
mIsTesting
;
uint64_t
mPendingTransaction
;
bool
mPaused
;
bool
mUseExternalSurfaceSize
;
gfx
:
:
IntSize
mEGLSurfaceSize
;
mozilla
:
:
Monitor
mPauseCompositionMonitor
;
mozilla
:
:
Monitor
mResumeCompositionMonitor
;
mozilla
:
:
Monitor
mResetCompositorMonitor
;
uint64_t
mCompositorID
;
uint64_t
mRootLayerTreeID
;
bool
mOverrideComposeReadiness
;
RefPtr
<
CancelableRunnable
>
mForceCompositionTask
;
RefPtr
<
APZCTreeManager
>
mApzcTreeManager
;
RefPtr
<
CompositorThreadHolder
>
mCompositorThreadHolder
;
RefPtr
<
CompositorVsyncScheduler
>
mCompositorScheduler
;
RefPtr
<
CompositorBridgeParent
>
mSelfRef
;
#
if
defined
(
XP_WIN
)
|
|
defined
(
MOZ_WIDGET_GTK
)
uint64_t
mLastPluginUpdateLayerTreeId
;
nsIntPoint
mPluginsLayerOffset
;
nsIntRegion
mPluginsLayerVisibleRegion
;
nsTArray
<
PluginWindowData
>
mCachedPluginData
;
TimeStamp
mWaitForPluginsUntil
;
bool
mHaveBlockedForPlugins
=
false
;
bool
mDeferPluginWindows
;
bool
mPluginWindowsHidden
;
#
endif
DISALLOW_EVIL_CONSTRUCTORS
(
CompositorBridgeParent
)
;
}
;
}
}
#
endif
