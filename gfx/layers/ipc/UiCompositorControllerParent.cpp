#
include
"
UiCompositorControllerParent
.
h
"
#
if
defined
(
MOZ_WIDGET_ANDROID
)
#
include
"
apz
/
src
/
APZCTreeManager
.
h
"
#
include
"
mozilla
/
layers
/
AsyncCompositionManager
.
h
"
#
endif
#
include
"
mozilla
/
layers
/
Compositor
.
h
"
#
include
"
mozilla
/
layers
/
CompositorBridgeParent
.
h
"
#
include
"
mozilla
/
layers
/
CompositorThread
.
h
"
#
include
"
mozilla
/
layers
/
LayerManagerComposite
.
h
"
#
include
"
mozilla
/
layers
/
UiCompositorControllerMessageTypes
.
h
"
#
include
"
mozilla
/
gfx
/
Types
.
h
"
#
include
"
mozilla
/
Move
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
SynchronousTask
.
h
"
namespace
mozilla
{
namespace
layers
{
typedef
CompositorBridgeParent
:
:
LayerTreeState
LayerTreeState
;
RefPtr
<
UiCompositorControllerParent
>
UiCompositorControllerParent
:
:
GetFromRootLayerTreeId
(
const
LayersId
&
aRootLayerTreeId
)
{
RefPtr
<
UiCompositorControllerParent
>
controller
;
CompositorBridgeParent
:
:
CallWithIndirectShadowTree
(
aRootLayerTreeId
[
&
]
(
LayerTreeState
&
aState
)
-
>
void
{
controller
=
aState
.
mUiControllerParent
;
}
)
;
return
controller
;
}
RefPtr
<
UiCompositorControllerParent
>
UiCompositorControllerParent
:
:
Start
(
const
LayersId
&
aRootLayerTreeId
Endpoint
<
PUiCompositorControllerParent
>
&
&
aEndpoint
)
{
RefPtr
<
UiCompositorControllerParent
>
parent
=
new
UiCompositorControllerParent
(
aRootLayerTreeId
)
;
RefPtr
<
Runnable
>
task
=
NewRunnableMethod
<
Endpoint
<
PUiCompositorControllerParent
>
&
&
>
(
"
layers
:
:
UiCompositorControllerParent
:
:
Open
"
parent
&
UiCompositorControllerParent
:
:
Open
std
:
:
move
(
aEndpoint
)
)
;
CompositorThreadHolder
:
:
Loop
(
)
-
>
PostTask
(
task
.
forget
(
)
)
;
return
parent
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvPause
(
)
{
CompositorBridgeParent
*
parent
=
CompositorBridgeParent
:
:
GetCompositorBridgeParentFromLayersId
(
mRootLayerTreeId
)
;
if
(
parent
)
{
parent
-
>
PauseComposition
(
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvResume
(
)
{
CompositorBridgeParent
*
parent
=
CompositorBridgeParent
:
:
GetCompositorBridgeParentFromLayersId
(
mRootLayerTreeId
)
;
if
(
parent
)
{
parent
-
>
ResumeComposition
(
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvResumeAndResize
(
const
int32_t
&
aX
const
int32_t
&
aY
const
int32_t
&
aWidth
const
int32_t
&
aHeight
)
{
CompositorBridgeParent
*
parent
=
CompositorBridgeParent
:
:
GetCompositorBridgeParentFromLayersId
(
mRootLayerTreeId
)
;
if
(
parent
)
{
parent
-
>
ForceIsFirstPaint
(
)
;
parent
-
>
ResumeCompositionAndResize
(
aX
aY
aWidth
aHeight
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvInvalidateAndRender
(
)
{
CompositorBridgeParent
*
parent
=
CompositorBridgeParent
:
:
GetCompositorBridgeParentFromLayersId
(
mRootLayerTreeId
)
;
if
(
parent
)
{
parent
-
>
Invalidate
(
)
;
parent
-
>
ScheduleComposition
(
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvMaxToolbarHeight
(
const
int32_t
&
aHeight
)
{
mMaxToolbarHeight
=
aHeight
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mAnimator
)
{
mAnimator
-
>
SetMaxToolbarHeight
(
mMaxToolbarHeight
)
;
}
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvFixedBottomOffset
(
const
int32_t
&
aOffset
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
CompositorBridgeParent
*
parent
=
CompositorBridgeParent
:
:
GetCompositorBridgeParentFromLayersId
(
mRootLayerTreeId
)
;
if
(
parent
)
{
AsyncCompositionManager
*
manager
=
parent
-
>
GetCompositionManager
(
nullptr
)
;
if
(
manager
)
{
manager
-
>
SetFixedLayerMargins
(
0
aOffset
)
;
}
parent
-
>
Invalidate
(
)
;
parent
-
>
ScheduleComposition
(
)
;
}
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvPinned
(
const
bool
&
aPinned
const
int32_t
&
aReason
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mAnimator
)
{
mAnimator
-
>
SetPinned
(
aPinned
aReason
)
;
}
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvToolbarAnimatorMessageFromUI
(
const
int32_t
&
aMessage
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mAnimator
)
{
mAnimator
-
>
ToolbarAnimatorMessageFromUI
(
aMessage
)
;
}
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvDefaultClearColor
(
const
uint32_t
&
aColor
)
{
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
mRootLayerTreeId
)
;
if
(
state
&
&
state
-
>
mLayerManager
)
{
Compositor
*
compositor
=
state
-
>
mLayerManager
-
>
GetCompositor
(
)
;
if
(
compositor
)
{
compositor
-
>
SetDefaultClearColor
(
gfx
:
:
Color
:
:
UnusualFromARGB
(
aColor
)
)
;
}
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvRequestScreenPixels
(
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
mRootLayerTreeId
)
;
if
(
state
&
&
state
-
>
mLayerManager
&
&
state
-
>
mParent
)
{
state
-
>
mLayerManager
-
>
RequestScreenPixels
(
this
)
;
state
-
>
mParent
-
>
Invalidate
(
)
;
state
-
>
mParent
-
>
ScheduleComposition
(
)
;
}
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvEnableLayerUpdateNotifications
(
const
bool
&
aEnable
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
mCompositorLayersUpdateEnabled
=
aEnable
;
#
endif
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
UiCompositorControllerParent
:
:
RecvToolbarPixelsToCompositor
(
Shmem
&
&
aMem
const
ScreenIntSize
&
aSize
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mAnimator
)
{
mAnimator
-
>
AdoptToolbarPixels
(
std
:
:
move
(
aMem
)
aSize
)
;
}
else
{
DeallocShmem
(
aMem
)
;
}
#
endif
return
IPC_OK
(
)
;
}
void
UiCompositorControllerParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
}
void
UiCompositorControllerParent
:
:
ActorDealloc
(
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
Shutdown
(
)
;
Release
(
)
;
}
#
if
defined
(
MOZ_WIDGET_ANDROID
)
void
UiCompositorControllerParent
:
:
RegisterAndroidDynamicToolbarAnimator
(
AndroidDynamicToolbarAnimator
*
aAnimator
)
{
MOZ_ASSERT
(
!
mAnimator
)
;
mAnimator
=
aAnimator
;
if
(
mAnimator
)
{
mAnimator
-
>
SetMaxToolbarHeight
(
mMaxToolbarHeight
)
;
}
}
#
endif
void
UiCompositorControllerParent
:
:
ToolbarAnimatorMessageFromCompositor
(
int32_t
aMessage
)
{
if
(
!
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
{
CompositorThreadHolder
:
:
Loop
(
)
-
>
PostTask
(
NewRunnableMethod
<
int32_t
>
(
"
layers
:
:
UiCompositorControllerParent
:
:
"
"
ToolbarAnimatorMessageFromCompositor
"
this
&
UiCompositorControllerParent
:
:
ToolbarAnimatorMessageFromCompositor
aMessage
)
)
;
return
;
}
Unused
<
<
SendToolbarAnimatorMessageFromCompositor
(
aMessage
)
;
}
bool
UiCompositorControllerParent
:
:
AllocPixelBuffer
(
const
int32_t
aSize
ipc
:
:
Shmem
*
aMem
)
{
MOZ_ASSERT
(
aSize
>
0
)
;
return
AllocShmem
(
aSize
ipc
:
:
SharedMemory
:
:
TYPE_BASIC
aMem
)
;
}
void
UiCompositorControllerParent
:
:
NotifyLayersUpdated
(
)
{
#
ifdef
MOZ_WIDGET_ANDROID
if
(
mCompositorLayersUpdateEnabled
)
{
ToolbarAnimatorMessageFromCompositor
(
LAYERS_UPDATED
)
;
}
#
endif
}
void
UiCompositorControllerParent
:
:
NotifyFirstPaint
(
)
{
ToolbarAnimatorMessageFromCompositor
(
FIRST_PAINT
)
;
}
void
UiCompositorControllerParent
:
:
NotifyUpdateScreenMetrics
(
const
FrameMetrics
&
aMetrics
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
CSSToScreenScale
scale
=
ViewTargetAs
<
ScreenPixel
>
(
aMetrics
.
GetZoom
(
)
.
ToScaleFactor
(
)
PixelCastJustification
:
:
ScreenIsParentLayerForRoot
)
;
ScreenPoint
scrollOffset
=
aMetrics
.
GetScrollOffset
(
)
*
scale
;
CompositorThreadHolder
:
:
Loop
(
)
-
>
PostTask
(
NewRunnableMethod
<
ScreenPoint
CSSToScreenScale
>
(
"
UiCompositorControllerParent
:
:
SendRootFrameMetrics
"
this
&
UiCompositorControllerParent
:
:
SendRootFrameMetrics
scrollOffset
scale
)
)
;
#
endif
}
UiCompositorControllerParent
:
:
UiCompositorControllerParent
(
const
LayersId
&
aRootLayerTreeId
)
:
mRootLayerTreeId
(
aRootLayerTreeId
)
#
ifdef
MOZ_WIDGET_ANDROID
mCompositorLayersUpdateEnabled
(
false
)
#
endif
mMaxToolbarHeight
(
0
)
{
MOZ_COUNT_CTOR
(
UiCompositorControllerParent
)
;
}
UiCompositorControllerParent
:
:
~
UiCompositorControllerParent
(
)
{
MOZ_COUNT_DTOR
(
UiCompositorControllerParent
)
;
}
void
UiCompositorControllerParent
:
:
InitializeForSameProcess
(
)
{
if
(
!
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
{
SynchronousTask
task
(
"
UiCompositorControllerParent
:
:
InitializeForSameProcess
"
)
;
CompositorThreadHolder
:
:
Loop
(
)
-
>
PostTask
(
NS_NewRunnableFunction
(
"
UiCompositorControllerParent
:
:
InitializeForSameProcess
"
[
&
]
(
)
{
AutoCompleteTask
complete
(
&
task
)
;
InitializeForSameProcess
(
)
;
}
)
)
;
task
.
Wait
(
)
;
return
;
}
Initialize
(
)
;
}
void
UiCompositorControllerParent
:
:
InitializeForOutOfProcess
(
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
Initialize
(
)
;
}
void
UiCompositorControllerParent
:
:
Initialize
(
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AddRef
(
)
;
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
mRootLayerTreeId
)
;
MOZ_ASSERT
(
state
)
;
MOZ_ASSERT
(
state
-
>
mParent
)
;
if
(
!
state
-
>
mParent
)
{
return
;
}
state
-
>
mUiControllerParent
=
this
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
AndroidDynamicToolbarAnimator
*
animator
=
state
-
>
mParent
-
>
GetAndroidDynamicToolbarAnimator
(
)
;
if
(
animator
)
{
animator
-
>
Initialize
(
mRootLayerTreeId
)
;
}
#
endif
}
void
UiCompositorControllerParent
:
:
Open
(
Endpoint
<
PUiCompositorControllerParent
>
&
&
aEndpoint
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
if
(
!
aEndpoint
.
Bind
(
this
)
)
{
MOZ_CRASH
(
"
Failed
to
bind
UiCompositorControllerParent
to
endpoint
"
)
;
}
InitializeForOutOfProcess
(
)
;
}
void
UiCompositorControllerParent
:
:
Shutdown
(
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mAnimator
)
{
mAnimator
-
>
Shutdown
(
)
;
}
#
endif
LayerTreeState
*
state
=
CompositorBridgeParent
:
:
GetIndirectShadowTree
(
mRootLayerTreeId
)
;
if
(
state
)
{
state
-
>
mUiControllerParent
=
nullptr
;
}
}
}
}
