#
ifndef
GFX_FRAMEMETRICS_H
#
define
GFX_FRAMEMETRICS_H
#
include
<
stdint
.
h
>
#
include
<
iosfwd
>
#
include
"
Units
.
h
"
#
include
"
UnitTransforms
.
h
"
#
include
"
mozilla
/
DefineEnum
.
h
"
#
include
"
mozilla
/
HashFunctions
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
gfx
/
BasePoint
.
h
"
#
include
"
mozilla
/
gfx
/
Rect
.
h
"
#
include
"
mozilla
/
gfx
/
ScaleFactor
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
#
include
"
mozilla
/
layers
/
ScrollableLayerGuid
.
h
"
#
include
"
mozilla
/
ScrollPositionUpdate
.
h
"
#
include
"
mozilla
/
ScrollSnapTargetId
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsTHashMap
.
h
"
#
include
"
nsString
.
h
"
#
include
"
PLDHashTable
.
h
"
struct
nsStyleDisplay
;
namespace
mozilla
{
enum
class
StyleScrollSnapStop
:
uint8_t
;
enum
class
StyleScrollSnapStrictness
:
uint8_t
;
enum
class
StyleOverscrollBehavior
:
uint8_t
;
class
WritingMode
;
}
namespace
IPC
{
template
<
typename
T
>
struct
ParamTraits
;
}
namespace
mozilla
{
namespace
layers
{
struct
FrameMetrics
{
friend
struct
IPC
:
:
ParamTraits
<
mozilla
:
:
layers
:
:
FrameMetrics
>
;
friend
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
FrameMetrics
&
aMetrics
)
;
typedef
ScrollableLayerGuid
:
:
ViewID
ViewID
;
public
:
MOZ_DEFINE_ENUM_WITH_BASE_AT_CLASS_SCOPE
(
ScrollOffsetUpdateType
uint8_t
(
eNone
eMainThread
eRestore
)
)
;
FrameMetrics
(
)
:
mScrollId
(
ScrollableLayerGuid
:
:
NULL_SCROLL_ID
)
mPresShellResolution
(
1
)
mCompositionBounds
(
0
0
0
0
)
mCompositionBoundsWidthIgnoringScrollbars
(
0
)
mDisplayPort
(
0
0
0
0
)
mScrollableRect
(
0
0
0
0
)
mCumulativeResolution
(
)
mDevPixelsPerCSSPixel
(
1
)
mScrollOffset
(
0
0
)
mZoom
(
)
mBoundingCompositionSize
(
0
0
)
mPresShellId
(
-
1
)
mLayoutViewport
(
0
0
0
0
)
mTransformToAncestorScale
(
)
mPaintRequestTime
(
)
mVisualDestination
(
0
0
)
mVisualScrollUpdateType
(
eNone
)
mCompositionSizeWithoutDynamicToolbar
(
)
mIsRootContent
(
false
)
mIsScrollInfoLayer
(
false
)
mHasNonZeroDisplayPortMargins
(
false
)
mMinimalDisplayPort
(
false
)
{
}
bool
operator
=
=
(
const
FrameMetrics
&
aOther
)
const
{
return
mScrollId
=
=
aOther
.
mScrollId
&
&
mPresShellResolution
=
=
aOther
.
mPresShellResolution
&
&
mCompositionBounds
.
IsEqualEdges
(
aOther
.
mCompositionBounds
)
&
&
mCompositionBoundsWidthIgnoringScrollbars
=
=
aOther
.
mCompositionBoundsWidthIgnoringScrollbars
&
&
mDisplayPort
.
IsEqualEdges
(
aOther
.
mDisplayPort
)
&
&
mScrollableRect
.
IsEqualEdges
(
aOther
.
mScrollableRect
)
&
&
mCumulativeResolution
=
=
aOther
.
mCumulativeResolution
&
&
mDevPixelsPerCSSPixel
=
=
aOther
.
mDevPixelsPerCSSPixel
&
&
mScrollOffset
=
=
aOther
.
mScrollOffset
&
&
mScrollGeneration
=
=
aOther
.
mScrollGeneration
&
&
mBoundingCompositionSize
=
=
aOther
.
mBoundingCompositionSize
&
&
mPresShellId
=
=
aOther
.
mPresShellId
&
&
mLayoutViewport
.
IsEqualEdges
(
aOther
.
mLayoutViewport
)
&
&
mTransformToAncestorScale
=
=
aOther
.
mTransformToAncestorScale
&
&
mPaintRequestTime
=
=
aOther
.
mPaintRequestTime
&
&
mVisualDestination
=
=
aOther
.
mVisualDestination
&
&
mVisualScrollUpdateType
=
=
aOther
.
mVisualScrollUpdateType
&
&
mIsRootContent
=
=
aOther
.
mIsRootContent
&
&
mIsScrollInfoLayer
=
=
aOther
.
mIsScrollInfoLayer
&
&
mHasNonZeroDisplayPortMargins
=
=
aOther
.
mHasNonZeroDisplayPortMargins
&
&
mMinimalDisplayPort
=
=
aOther
.
mMinimalDisplayPort
&
&
mFixedLayerMargins
=
=
aOther
.
mFixedLayerMargins
&
&
mCompositionSizeWithoutDynamicToolbar
=
=
aOther
.
mCompositionSizeWithoutDynamicToolbar
;
}
bool
operator
!
=
(
const
FrameMetrics
&
aOther
)
const
{
return
!
operator
=
=
(
aOther
)
;
}
bool
IsScrollable
(
)
const
{
return
mScrollId
!
=
ScrollableLayerGuid
:
:
NULL_SCROLL_ID
;
}
CSSToScreenScale2D
DisplayportPixelsPerCSSPixel
(
)
const
{
return
mZoom
*
mTransformToAncestorScale
;
}
CSSToLayerScale
LayersPixelsPerCSSPixel
(
)
const
{
return
mDevPixelsPerCSSPixel
*
mCumulativeResolution
;
}
LayerToParentLayerScale
GetAsyncZoom
(
)
const
{
return
mZoom
/
LayersPixelsPerCSSPixel
(
)
;
}
CSSRect
GetExpandedScrollableRect
(
)
const
{
CSSRect
scrollableRect
=
mScrollableRect
;
CSSSize
compSize
=
CalculateCompositedSizeInCssPixels
(
)
;
if
(
scrollableRect
.
Width
(
)
<
compSize
.
width
)
{
scrollableRect
.
SetRectX
(
std
:
:
max
(
0
.
f
scrollableRect
.
X
(
)
-
(
compSize
.
width
-
scrollableRect
.
Width
(
)
)
)
compSize
.
width
)
;
}
if
(
scrollableRect
.
Height
(
)
<
compSize
.
height
)
{
scrollableRect
.
SetRectY
(
std
:
:
max
(
0
.
f
scrollableRect
.
Y
(
)
-
(
compSize
.
height
-
scrollableRect
.
Height
(
)
)
)
compSize
.
height
)
;
}
return
scrollableRect
;
}
CSSSize
CalculateCompositedSizeInCssPixels
(
)
const
{
return
CalculateCompositedSizeInCssPixels
(
mCompositionBounds
mZoom
)
;
}
OuterCSSRect
CalculateCompositionBoundsInOuterCssPixels
(
)
const
{
if
(
GetZoom
(
)
=
=
CSSToParentLayerScale
(
0
)
)
{
return
OuterCSSRect
(
)
;
}
return
mCompositionBounds
/
GetZoom
(
)
*
GetCSSToOuterCSSScale
(
)
;
}
CSSSize
CalculateBoundedCompositedSizeInCssPixels
(
)
const
{
CSSSize
size
=
CalculateCompositedSizeInCssPixels
(
)
;
size
.
width
=
std
:
:
min
(
size
.
width
mBoundingCompositionSize
.
width
)
;
size
.
height
=
std
:
:
min
(
size
.
height
mBoundingCompositionSize
.
height
)
;
return
size
;
}
CSSRect
CalculateScrollRange
(
)
const
{
return
CalculateScrollRange
(
mScrollableRect
mCompositionBounds
mZoom
)
;
}
void
ScrollBy
(
const
CSSPoint
&
aPoint
)
{
SetVisualScrollOffset
(
GetVisualScrollOffset
(
)
+
aPoint
)
;
}
void
ZoomBy
(
float
aScale
)
{
mZoom
.
scale
*
=
aScale
;
}
bool
HasPendingScroll
(
const
FrameMetrics
&
aContentFrameMetrics
)
const
{
return
GetVisualScrollOffset
(
)
!
=
aContentFrameMetrics
.
GetVisualScrollOffset
(
)
;
}
bool
ApplyScrollUpdateFrom
(
const
ScrollPositionUpdate
&
aUpdate
)
;
CSSPoint
ApplyRelativeScrollUpdateFrom
(
const
ScrollPositionUpdate
&
aUpdate
)
;
CSSPoint
ApplyPureRelativeScrollUpdateFrom
(
const
ScrollPositionUpdate
&
aUpdate
)
;
void
UpdatePendingScrollInfo
(
const
ScrollPositionUpdate
&
aInfo
)
;
public
:
void
SetPresShellResolution
(
float
aPresShellResolution
)
{
mPresShellResolution
=
aPresShellResolution
;
}
float
GetPresShellResolution
(
)
const
{
return
mPresShellResolution
;
}
void
SetCompositionBounds
(
const
ParentLayerRect
&
aCompositionBounds
)
{
mCompositionBounds
=
aCompositionBounds
;
}
const
ParentLayerRect
&
GetCompositionBounds
(
)
const
{
return
mCompositionBounds
;
}
void
SetCompositionBoundsWidthIgnoringScrollbars
(
const
ParentLayerCoord
aCompositionBoundsWidthIgnoringScrollbars
)
{
mCompositionBoundsWidthIgnoringScrollbars
=
aCompositionBoundsWidthIgnoringScrollbars
;
}
const
ParentLayerCoord
GetCompositionBoundsWidthIgnoringScrollbars
(
)
const
{
return
mCompositionBoundsWidthIgnoringScrollbars
;
}
void
SetDisplayPort
(
const
CSSRect
&
aDisplayPort
)
{
mDisplayPort
=
aDisplayPort
;
}
const
CSSRect
&
GetDisplayPort
(
)
const
{
return
mDisplayPort
;
}
void
SetCumulativeResolution
(
const
LayoutDeviceToLayerScale
&
aCumulativeResolution
)
{
mCumulativeResolution
=
aCumulativeResolution
;
}
const
LayoutDeviceToLayerScale
&
GetCumulativeResolution
(
)
const
{
return
mCumulativeResolution
;
}
void
SetDevPixelsPerCSSPixel
(
const
CSSToLayoutDeviceScale
&
aDevPixelsPerCSSPixel
)
{
mDevPixelsPerCSSPixel
=
aDevPixelsPerCSSPixel
;
}
const
CSSToLayoutDeviceScale
&
GetDevPixelsPerCSSPixel
(
)
const
{
return
mDevPixelsPerCSSPixel
;
}
CSSToOuterCSSScale
GetCSSToOuterCSSScale
(
)
const
{
return
CSSToOuterCSSScale
(
mPresShellResolution
)
;
}
void
SetIsRootContent
(
bool
aIsRootContent
)
{
mIsRootContent
=
aIsRootContent
;
}
bool
IsRootContent
(
)
const
{
return
mIsRootContent
;
}
bool
ClampAndSetVisualScrollOffset
(
const
CSSPoint
&
aScrollOffset
)
{
CSSPoint
offsetBefore
=
GetVisualScrollOffset
(
)
;
SetVisualScrollOffset
(
CalculateScrollRange
(
)
.
ClampPoint
(
aScrollOffset
)
)
;
return
(
offsetBefore
!
=
GetVisualScrollOffset
(
)
)
;
}
CSSPoint
GetLayoutScrollOffset
(
)
const
{
return
mLayoutViewport
.
TopLeft
(
)
;
}
bool
SetLayoutScrollOffset
(
const
CSSPoint
&
aLayoutScrollOffset
)
{
CSSPoint
offsetBefore
=
GetLayoutScrollOffset
(
)
;
mLayoutViewport
.
MoveTo
(
aLayoutScrollOffset
)
;
return
(
offsetBefore
!
=
GetLayoutScrollOffset
(
)
)
;
}
const
CSSPoint
&
GetVisualScrollOffset
(
)
const
{
return
mScrollOffset
;
}
void
SetVisualScrollOffset
(
const
CSSPoint
&
aVisualScrollOffset
)
{
mScrollOffset
=
aVisualScrollOffset
;
}
void
SetZoom
(
const
CSSToParentLayerScale
&
aZoom
)
{
mZoom
=
aZoom
;
}
const
CSSToParentLayerScale
&
GetZoom
(
)
const
{
return
mZoom
;
}
void
SetScrollGeneration
(
const
MainThreadScrollGeneration
&
aScrollGeneration
)
{
mScrollGeneration
=
aScrollGeneration
;
}
MainThreadScrollGeneration
GetScrollGeneration
(
)
const
{
return
mScrollGeneration
;
}
ViewID
GetScrollId
(
)
const
{
return
mScrollId
;
}
void
SetScrollId
(
ViewID
scrollId
)
{
mScrollId
=
scrollId
;
}
void
SetBoundingCompositionSize
(
const
CSSSize
&
aBoundingCompositionSize
)
{
mBoundingCompositionSize
=
aBoundingCompositionSize
;
}
const
CSSSize
&
GetBoundingCompositionSize
(
)
const
{
return
mBoundingCompositionSize
;
}
uint32_t
GetPresShellId
(
)
const
{
return
mPresShellId
;
}
void
SetPresShellId
(
uint32_t
aPresShellId
)
{
mPresShellId
=
aPresShellId
;
}
void
SetLayoutViewport
(
const
CSSRect
&
aLayoutViewport
)
{
mLayoutViewport
=
aLayoutViewport
;
}
const
CSSRect
&
GetLayoutViewport
(
)
const
{
return
mLayoutViewport
;
}
CSSRect
GetVisualViewport
(
)
const
{
return
CSSRect
(
GetVisualScrollOffset
(
)
CalculateCompositedSizeInCssPixels
(
)
)
;
}
void
SetTransformToAncestorScale
(
const
ParentLayerToScreenScale2D
&
aTransformToAncestorScale
)
{
mTransformToAncestorScale
=
aTransformToAncestorScale
;
}
const
ParentLayerToScreenScale2D
&
GetTransformToAncestorScale
(
)
const
{
return
mTransformToAncestorScale
;
}
const
CSSRect
&
GetScrollableRect
(
)
const
{
return
mScrollableRect
;
}
void
SetScrollableRect
(
const
CSSRect
&
aScrollableRect
)
{
mScrollableRect
=
aScrollableRect
;
}
bool
IsHorizontalContentRightToLeft
(
)
const
{
return
mScrollableRect
.
x
<
0
;
}
void
SetPaintRequestTime
(
const
TimeStamp
&
aTime
)
{
mPaintRequestTime
=
aTime
;
}
const
TimeStamp
&
GetPaintRequestTime
(
)
const
{
return
mPaintRequestTime
;
}
void
SetIsScrollInfoLayer
(
bool
aIsScrollInfoLayer
)
{
mIsScrollInfoLayer
=
aIsScrollInfoLayer
;
}
bool
IsScrollInfoLayer
(
)
const
{
return
mIsScrollInfoLayer
;
}
void
SetHasNonZeroDisplayPortMargins
(
bool
aHasNonZeroDisplayPortMargins
)
{
mHasNonZeroDisplayPortMargins
=
aHasNonZeroDisplayPortMargins
;
}
bool
HasNonZeroDisplayPortMargins
(
)
const
{
return
mHasNonZeroDisplayPortMargins
;
}
void
SetMinimalDisplayPort
(
bool
aMinimalDisplayPort
)
{
mMinimalDisplayPort
=
aMinimalDisplayPort
;
}
bool
IsMinimalDisplayPort
(
)
const
{
return
mMinimalDisplayPort
;
}
void
SetVisualDestination
(
const
CSSPoint
&
aVisualDestination
)
{
mVisualDestination
=
aVisualDestination
;
}
const
CSSPoint
&
GetVisualDestination
(
)
const
{
return
mVisualDestination
;
}
void
SetVisualScrollUpdateType
(
ScrollOffsetUpdateType
aUpdateType
)
{
mVisualScrollUpdateType
=
aUpdateType
;
}
ScrollOffsetUpdateType
GetVisualScrollUpdateType
(
)
const
{
return
mVisualScrollUpdateType
;
}
void
RecalculateLayoutViewportOffset
(
)
;
void
SetFixedLayerMargins
(
const
ScreenMargin
&
aFixedLayerMargins
)
{
mFixedLayerMargins
=
aFixedLayerMargins
;
}
const
ScreenMargin
&
GetFixedLayerMargins
(
)
const
{
return
mFixedLayerMargins
;
}
void
SetCompositionSizeWithoutDynamicToolbar
(
const
ParentLayerSize
&
aSize
)
{
MOZ_ASSERT
(
mIsRootContent
)
;
mCompositionSizeWithoutDynamicToolbar
=
aSize
;
}
const
ParentLayerSize
&
GetCompositionSizeWithoutDynamicToolbar
(
)
const
{
MOZ_ASSERT
(
mIsRootContent
)
;
return
mCompositionSizeWithoutDynamicToolbar
;
}
static
void
KeepLayoutViewportEnclosingVisualViewport
(
const
CSSRect
&
aVisualViewport
const
CSSRect
&
aScrollableRect
CSSRect
&
aLayoutViewport
)
;
static
CSSRect
CalculateScrollRange
(
const
CSSRect
&
aScrollableRect
const
ParentLayerRect
&
aCompositionBounds
const
CSSToParentLayerScale
&
aZoom
)
;
static
CSSSize
CalculateCompositedSizeInCssPixels
(
const
ParentLayerRect
&
aCompositionBounds
const
CSSToParentLayerScale
&
aZoom
)
;
private
:
ViewID
mScrollId
;
float
mPresShellResolution
;
ParentLayerRect
mCompositionBounds
;
ParentLayerCoord
mCompositionBoundsWidthIgnoringScrollbars
;
CSSRect
mDisplayPort
;
CSSRect
mScrollableRect
;
LayoutDeviceToLayerScale
mCumulativeResolution
;
CSSToLayoutDeviceScale
mDevPixelsPerCSSPixel
;
CSSPoint
mScrollOffset
;
CSSToParentLayerScale
mZoom
;
MainThreadScrollGeneration
mScrollGeneration
;
CSSSize
mBoundingCompositionSize
;
uint32_t
mPresShellId
;
CSSRect
mLayoutViewport
;
ParentLayerToScreenScale2D
mTransformToAncestorScale
;
TimeStamp
mPaintRequestTime
;
CSSPoint
mVisualDestination
;
ScrollOffsetUpdateType
mVisualScrollUpdateType
;
ScreenMargin
mFixedLayerMargins
;
ParentLayerSize
mCompositionSizeWithoutDynamicToolbar
;
bool
mIsRootContent
:
1
;
bool
mIsScrollInfoLayer
:
1
;
bool
mHasNonZeroDisplayPortMargins
:
1
;
bool
mMinimalDisplayPort
:
1
;
}
;
struct
ScrollSnapInfo
{
ScrollSnapInfo
(
)
;
bool
operator
=
=
(
const
ScrollSnapInfo
&
aOther
)
const
{
return
mScrollSnapStrictnessX
=
=
aOther
.
mScrollSnapStrictnessX
&
&
mScrollSnapStrictnessY
=
=
aOther
.
mScrollSnapStrictnessY
&
&
mSnapTargets
=
=
aOther
.
mSnapTargets
&
&
mXRangeWiderThanSnapport
=
=
aOther
.
mXRangeWiderThanSnapport
&
&
mYRangeWiderThanSnapport
=
=
aOther
.
mYRangeWiderThanSnapport
&
&
mSnapportSize
=
=
aOther
.
mSnapportSize
;
}
bool
HasScrollSnapping
(
)
const
;
bool
HasSnapPositions
(
)
const
;
void
InitializeScrollSnapStrictness
(
WritingMode
aWritingMode
const
nsStyleDisplay
*
aDisplay
)
;
StyleScrollSnapStrictness
mScrollSnapStrictnessX
;
StyleScrollSnapStrictness
mScrollSnapStrictnessY
;
struct
SnapTarget
{
Maybe
<
nscoord
>
mSnapPositionX
;
Maybe
<
nscoord
>
mSnapPositionY
;
nsRect
mSnapArea
;
StyleScrollSnapStop
mScrollSnapStop
;
ScrollSnapTargetId
mTargetId
;
SnapTarget
(
)
=
default
;
SnapTarget
(
Maybe
<
nscoord
>
&
&
aSnapPositionX
Maybe
<
nscoord
>
&
&
aSnapPositionY
nsRect
&
&
aSnapArea
StyleScrollSnapStop
aScrollSnapStop
ScrollSnapTargetId
aTargetId
)
:
mSnapPositionX
(
std
:
:
move
(
aSnapPositionX
)
)
mSnapPositionY
(
std
:
:
move
(
aSnapPositionY
)
)
mSnapArea
(
std
:
:
move
(
aSnapArea
)
)
mScrollSnapStop
(
aScrollSnapStop
)
mTargetId
(
aTargetId
)
{
}
bool
operator
=
=
(
const
SnapTarget
&
aOther
)
const
{
return
mSnapPositionX
=
=
aOther
.
mSnapPositionX
&
&
mSnapPositionY
=
=
aOther
.
mSnapPositionY
&
&
mSnapArea
=
=
aOther
.
mSnapArea
&
&
mScrollSnapStop
=
=
aOther
.
mScrollSnapStop
&
&
mTargetId
=
=
aOther
.
mTargetId
;
}
bool
IsValidFor
(
const
nsPoint
&
aDestination
const
nsSize
aSnapportSize
)
const
{
nsPoint
snapPoint
(
mSnapPositionX
?
*
mSnapPositionX
:
aDestination
.
x
mSnapPositionY
?
*
mSnapPositionY
:
aDestination
.
y
)
;
nsRect
snappedPort
=
nsRect
(
snapPoint
aSnapportSize
)
;
return
snappedPort
.
Intersects
(
mSnapArea
)
;
}
}
;
CopyableTArray
<
SnapTarget
>
mSnapTargets
;
struct
ScrollSnapRange
{
ScrollSnapRange
(
)
=
default
;
ScrollSnapRange
(
nscoord
aStart
nscoord
aEnd
ScrollSnapTargetId
aTargetId
)
:
mStart
(
aStart
)
mEnd
(
aEnd
)
mTargetId
(
aTargetId
)
{
}
nscoord
mStart
;
nscoord
mEnd
;
ScrollSnapTargetId
mTargetId
;
bool
operator
=
=
(
const
ScrollSnapRange
&
aOther
)
const
{
return
mStart
=
=
aOther
.
mStart
&
&
mEnd
=
=
aOther
.
mEnd
&
&
mTargetId
=
=
aOther
.
mTargetId
;
}
bool
IsValid
(
nscoord
aPoint
nscoord
aSnapportSize
)
const
{
MOZ_ASSERT
(
mEnd
-
mStart
>
aSnapportSize
)
;
return
mStart
<
=
aPoint
&
&
aPoint
<
=
mEnd
-
aSnapportSize
;
}
}
;
CopyableTArray
<
ScrollSnapRange
>
mXRangeWiderThanSnapport
;
CopyableTArray
<
ScrollSnapRange
>
mYRangeWiderThanSnapport
;
nsSize
mSnapportSize
;
}
;
MOZ_DEFINE_ENUM_CLASS_WITH_BASE
(
OverscrollBehavior
uint8_t
(
Auto
Contain
None
)
)
;
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
OverscrollBehavior
&
aBehavior
)
;
struct
OverscrollBehaviorInfo
{
OverscrollBehaviorInfo
(
)
;
static
OverscrollBehaviorInfo
FromStyleConstants
(
StyleOverscrollBehavior
aBehaviorX
StyleOverscrollBehavior
aBehaviorY
)
;
bool
operator
=
=
(
const
OverscrollBehaviorInfo
&
aOther
)
const
;
friend
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
OverscrollBehaviorInfo
&
aInfo
)
;
OverscrollBehavior
mBehaviorX
;
OverscrollBehavior
mBehaviorY
;
}
;
struct
ScrollMetadata
{
friend
struct
IPC
:
:
ParamTraits
<
mozilla
:
:
layers
:
:
ScrollMetadata
>
;
friend
std
:
:
ostream
&
operator
<
<
(
std
:
:
ostream
&
aStream
const
ScrollMetadata
&
aMetadata
)
;
typedef
ScrollableLayerGuid
:
:
ViewID
ViewID
;
public
:
static
StaticAutoPtr
<
const
ScrollMetadata
>
sNullMetadata
;
ScrollMetadata
(
)
:
mMetrics
(
)
mSnapInfo
(
)
mScrollParentId
(
ScrollableLayerGuid
:
:
NULL_SCROLL_ID
)
mContentDescription
(
)
mLineScrollAmount
(
0
0
)
mPageScrollAmount
(
0
0
)
mHasScrollgrab
(
false
)
mIsLayersIdRoot
(
false
)
mIsAutoDirRootContentRTL
(
false
)
mForceDisableApz
(
false
)
mResolutionUpdated
(
false
)
mIsRDMTouchSimulationActive
(
false
)
mDidContentGetPainted
(
true
)
mForceMousewheelAutodir
(
false
)
mForceMousewheelAutodirHonourRoot
(
false
)
mIsPaginatedPresentation
(
false
)
mOverscrollBehavior
(
)
{
}
bool
operator
=
=
(
const
ScrollMetadata
&
aOther
)
const
{
return
mMetrics
=
=
aOther
.
mMetrics
&
&
mSnapInfo
=
=
aOther
.
mSnapInfo
&
&
mScrollParentId
=
=
aOther
.
mScrollParentId
&
&
mLineScrollAmount
=
=
aOther
.
mLineScrollAmount
&
&
mPageScrollAmount
=
=
aOther
.
mPageScrollAmount
&
&
mHasScrollgrab
=
=
aOther
.
mHasScrollgrab
&
&
mIsLayersIdRoot
=
=
aOther
.
mIsLayersIdRoot
&
&
mIsAutoDirRootContentRTL
=
=
aOther
.
mIsAutoDirRootContentRTL
&
&
mForceDisableApz
=
=
aOther
.
mForceDisableApz
&
&
mResolutionUpdated
=
=
aOther
.
mResolutionUpdated
&
&
mIsRDMTouchSimulationActive
=
=
aOther
.
mIsRDMTouchSimulationActive
&
&
mDidContentGetPainted
=
=
aOther
.
mDidContentGetPainted
&
&
mForceMousewheelAutodir
=
=
aOther
.
mForceMousewheelAutodir
&
&
mForceMousewheelAutodirHonourRoot
=
=
aOther
.
mForceMousewheelAutodirHonourRoot
&
&
mIsPaginatedPresentation
=
=
aOther
.
mIsPaginatedPresentation
&
&
mDisregardedDirection
=
=
aOther
.
mDisregardedDirection
&
&
mOverscrollBehavior
=
=
aOther
.
mOverscrollBehavior
&
&
mScrollUpdates
=
=
aOther
.
mScrollUpdates
;
}
bool
operator
!
=
(
const
ScrollMetadata
&
aOther
)
const
{
return
!
operator
=
=
(
aOther
)
;
}
bool
IsDefault
(
)
const
{
ScrollMetadata
def
;
def
.
mMetrics
.
SetPresShellId
(
mMetrics
.
GetPresShellId
(
)
)
;
return
(
def
=
=
*
this
)
;
}
FrameMetrics
&
GetMetrics
(
)
{
return
mMetrics
;
}
const
FrameMetrics
&
GetMetrics
(
)
const
{
return
mMetrics
;
}
void
SetSnapInfo
(
ScrollSnapInfo
&
&
aSnapInfo
)
{
mSnapInfo
=
std
:
:
move
(
aSnapInfo
)
;
}
const
ScrollSnapInfo
&
GetSnapInfo
(
)
const
{
return
mSnapInfo
;
}
ViewID
GetScrollParentId
(
)
const
{
return
mScrollParentId
;
}
void
SetScrollParentId
(
ViewID
aParentId
)
{
mScrollParentId
=
aParentId
;
}
const
nsCString
&
GetContentDescription
(
)
const
{
return
mContentDescription
;
}
void
SetContentDescription
(
const
nsCString
&
aContentDescription
)
{
mContentDescription
=
aContentDescription
;
}
const
LayoutDeviceIntSize
&
GetLineScrollAmount
(
)
const
{
return
mLineScrollAmount
;
}
void
SetLineScrollAmount
(
const
LayoutDeviceIntSize
&
size
)
{
mLineScrollAmount
=
size
;
}
const
LayoutDeviceIntSize
&
GetPageScrollAmount
(
)
const
{
return
mPageScrollAmount
;
}
void
SetPageScrollAmount
(
const
LayoutDeviceIntSize
&
size
)
{
mPageScrollAmount
=
size
;
}
void
SetHasScrollgrab
(
bool
aHasScrollgrab
)
{
mHasScrollgrab
=
aHasScrollgrab
;
}
bool
GetHasScrollgrab
(
)
const
{
return
mHasScrollgrab
;
}
void
SetIsLayersIdRoot
(
bool
aValue
)
{
mIsLayersIdRoot
=
aValue
;
}
bool
IsLayersIdRoot
(
)
const
{
return
mIsLayersIdRoot
;
}
void
SetIsAutoDirRootContentRTL
(
bool
aValue
)
{
mIsAutoDirRootContentRTL
=
aValue
;
}
bool
IsAutoDirRootContentRTL
(
)
const
{
return
mIsAutoDirRootContentRTL
;
}
void
SetForceDisableApz
(
bool
aForceDisable
)
{
mForceDisableApz
=
aForceDisable
;
}
bool
IsApzForceDisabled
(
)
const
{
return
mForceDisableApz
;
}
void
SetResolutionUpdated
(
bool
aUpdated
)
{
mResolutionUpdated
=
aUpdated
;
}
bool
IsResolutionUpdated
(
)
const
{
return
mResolutionUpdated
;
}
void
SetIsRDMTouchSimulationActive
(
bool
aValue
)
{
mIsRDMTouchSimulationActive
=
aValue
;
}
bool
GetIsRDMTouchSimulationActive
(
)
const
{
return
mIsRDMTouchSimulationActive
;
}
void
SetForceMousewheelAutodir
(
bool
aValue
)
{
mForceMousewheelAutodir
=
aValue
;
}
bool
ForceMousewheelAutodir
(
)
const
{
return
mForceMousewheelAutodir
;
}
void
SetForceMousewheelAutodirHonourRoot
(
bool
aValue
)
{
mForceMousewheelAutodirHonourRoot
=
aValue
;
}
bool
ForceMousewheelAutodirHonourRoot
(
)
const
{
return
mForceMousewheelAutodirHonourRoot
;
}
void
SetIsPaginatedPresentation
(
bool
aValue
)
{
mIsPaginatedPresentation
=
aValue
;
}
bool
IsPaginatedPresentation
(
)
const
{
return
mIsPaginatedPresentation
;
}
bool
DidContentGetPainted
(
)
const
{
return
mDidContentGetPainted
;
}
private
:
void
SetDidContentGetPainted
(
bool
aValue
)
{
mDidContentGetPainted
=
aValue
;
}
public
:
Maybe
<
ScrollDirection
>
GetDisregardedDirection
(
)
const
{
return
mDisregardedDirection
;
}
void
SetDisregardedDirection
(
const
Maybe
<
ScrollDirection
>
&
aValue
)
{
mDisregardedDirection
=
aValue
;
}
void
SetOverscrollBehavior
(
const
OverscrollBehaviorInfo
&
aOverscrollBehavior
)
{
mOverscrollBehavior
=
aOverscrollBehavior
;
}
const
OverscrollBehaviorInfo
&
GetOverscrollBehavior
(
)
const
{
return
mOverscrollBehavior
;
}
void
SetScrollUpdates
(
const
nsTArray
<
ScrollPositionUpdate
>
&
aUpdates
)
{
mScrollUpdates
=
aUpdates
;
}
const
nsTArray
<
ScrollPositionUpdate
>
&
GetScrollUpdates
(
)
const
{
return
mScrollUpdates
;
}
void
UpdatePendingScrollInfo
(
nsTArray
<
ScrollPositionUpdate
>
&
&
aUpdates
)
{
MOZ_ASSERT
(
!
aUpdates
.
IsEmpty
(
)
)
;
mMetrics
.
UpdatePendingScrollInfo
(
aUpdates
.
LastElement
(
)
)
;
mDidContentGetPainted
=
false
;
mScrollUpdates
.
Clear
(
)
;
mScrollUpdates
.
AppendElements
(
std
:
:
move
(
aUpdates
)
)
;
}
private
:
FrameMetrics
mMetrics
;
ScrollSnapInfo
mSnapInfo
;
ViewID
mScrollParentId
;
nsCString
mContentDescription
;
LayoutDeviceIntSize
mLineScrollAmount
;
LayoutDeviceIntSize
mPageScrollAmount
;
bool
mHasScrollgrab
:
1
;
bool
mIsLayersIdRoot
:
1
;
bool
mIsAutoDirRootContentRTL
:
1
;
bool
mForceDisableApz
:
1
;
bool
mResolutionUpdated
:
1
;
bool
mIsRDMTouchSimulationActive
:
1
;
bool
mDidContentGetPainted
:
1
;
bool
mForceMousewheelAutodir
:
1
;
bool
mForceMousewheelAutodirHonourRoot
:
1
;
bool
mIsPaginatedPresentation
:
1
;
Maybe
<
ScrollDirection
>
mDisregardedDirection
;
OverscrollBehaviorInfo
mOverscrollBehavior
;
CopyableTArray
<
ScrollPositionUpdate
>
mScrollUpdates
;
}
;
typedef
nsTHashMap
<
ScrollableLayerGuid
:
:
ViewIDHashKey
nsTArray
<
ScrollPositionUpdate
>
>
ScrollUpdatesMap
;
}
}
#
endif
