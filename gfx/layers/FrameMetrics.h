#
ifndef
GFX_FRAMEMETRICS_H
#
define
GFX_FRAMEMETRICS_H
#
include
<
stdint
.
h
>
#
include
<
map
>
#
include
"
Units
.
h
"
#
include
"
mozilla
/
DefineEnum
.
h
"
#
include
"
mozilla
/
HashFunctions
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
gfx
/
BasePoint
.
h
"
#
include
"
mozilla
/
gfx
/
Rect
.
h
"
#
include
"
mozilla
/
gfx
/
ScaleFactor
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsStyleCoord
.
h
"
#
include
"
PLDHashTable
.
h
"
namespace
IPC
{
template
<
typename
T
>
struct
ParamTraits
;
}
namespace
mozilla
{
namespace
layers
{
struct
ScrollUpdateInfo
{
uint32_t
mScrollGeneration
;
CSSPoint
mScrollOffset
;
}
;
struct
FrameMetrics
{
friend
struct
IPC
:
:
ParamTraits
<
mozilla
:
:
layers
:
:
FrameMetrics
>
;
public
:
typedef
uint64_t
ViewID
;
static
const
ViewID
NULL_SCROLL_ID
;
static
const
ViewID
START_SCROLL_ID
=
2
;
MOZ_DEFINE_ENUM_WITH_BASE_AT_CLASS_SCOPE
(
ScrollOffsetUpdateType
uint8_t
(
eNone
eMainThread
ePending
eUserAction
eRestore
)
)
;
FrameMetrics
(
)
:
mScrollId
(
NULL_SCROLL_ID
)
mPresShellResolution
(
1
)
mCompositionBounds
(
0
0
0
0
)
mDisplayPort
(
0
0
0
0
)
mCriticalDisplayPort
(
0
0
0
0
)
mScrollableRect
(
0
0
0
0
)
mCumulativeResolution
(
)
mDevPixelsPerCSSPixel
(
1
)
mScrollOffset
(
0
0
)
mZoom
(
)
mScrollGeneration
(
0
)
mSmoothScrollOffset
(
0
0
)
mRootCompositionSize
(
0
0
)
mDisplayPortMargins
(
0
0
0
0
)
mPresShellId
(
-
1
)
mViewport
(
0
0
0
0
)
mExtraResolution
(
)
mPaintRequestTime
(
)
mScrollUpdateType
(
eNone
)
mIsRootContent
(
false
)
mDoSmoothScroll
(
false
)
mUseDisplayPortMargins
(
false
)
mIsScrollInfoLayer
(
false
)
{
}
bool
operator
=
=
(
const
FrameMetrics
&
aOther
)
const
{
return
mScrollId
=
=
aOther
.
mScrollId
&
&
mPresShellResolution
=
=
aOther
.
mPresShellResolution
&
&
mCompositionBounds
.
IsEqualEdges
(
aOther
.
mCompositionBounds
)
&
&
mDisplayPort
.
IsEqualEdges
(
aOther
.
mDisplayPort
)
&
&
mCriticalDisplayPort
.
IsEqualEdges
(
aOther
.
mCriticalDisplayPort
)
&
&
mScrollableRect
.
IsEqualEdges
(
aOther
.
mScrollableRect
)
&
&
mCumulativeResolution
=
=
aOther
.
mCumulativeResolution
&
&
mDevPixelsPerCSSPixel
=
=
aOther
.
mDevPixelsPerCSSPixel
&
&
mScrollOffset
=
=
aOther
.
mScrollOffset
&
&
mScrollGeneration
=
=
aOther
.
mScrollGeneration
&
&
mSmoothScrollOffset
=
=
aOther
.
mSmoothScrollOffset
&
&
mRootCompositionSize
=
=
aOther
.
mRootCompositionSize
&
&
mDisplayPortMargins
=
=
aOther
.
mDisplayPortMargins
&
&
mPresShellId
=
=
aOther
.
mPresShellId
&
&
mViewport
.
IsEqualEdges
(
aOther
.
mViewport
)
&
&
mExtraResolution
=
=
aOther
.
mExtraResolution
&
&
mPaintRequestTime
=
=
aOther
.
mPaintRequestTime
&
&
mScrollUpdateType
=
=
aOther
.
mScrollUpdateType
&
&
mIsRootContent
=
=
aOther
.
mIsRootContent
&
&
mDoSmoothScroll
=
=
aOther
.
mDoSmoothScroll
&
&
mUseDisplayPortMargins
=
=
aOther
.
mUseDisplayPortMargins
&
&
mIsScrollInfoLayer
=
=
aOther
.
mIsScrollInfoLayer
;
}
bool
operator
!
=
(
const
FrameMetrics
&
aOther
)
const
{
return
!
operator
=
=
(
aOther
)
;
}
bool
IsScrollable
(
)
const
{
return
mScrollId
!
=
NULL_SCROLL_ID
;
}
CSSToScreenScale2D
DisplayportPixelsPerCSSPixel
(
)
const
{
return
mZoom
*
ParentLayerToLayerScale
(
1
.
0f
)
/
mExtraResolution
;
}
CSSToLayerScale2D
LayersPixelsPerCSSPixel
(
)
const
{
return
mDevPixelsPerCSSPixel
*
mCumulativeResolution
;
}
LayerToParentLayerScale
GetAsyncZoom
(
)
const
{
return
(
mZoom
/
LayersPixelsPerCSSPixel
(
)
)
.
ToScaleFactor
(
)
;
}
CSSRect
GetExpandedScrollableRect
(
)
const
{
CSSRect
scrollableRect
=
mScrollableRect
;
CSSSize
compSize
=
CalculateCompositedSizeInCssPixels
(
)
;
if
(
scrollableRect
.
Width
(
)
<
compSize
.
width
)
{
scrollableRect
.
SetRectX
(
std
:
:
max
(
0
.
f
scrollableRect
.
X
(
)
-
(
compSize
.
width
-
scrollableRect
.
Width
(
)
)
)
compSize
.
width
)
;
}
if
(
scrollableRect
.
Height
(
)
<
compSize
.
height
)
{
scrollableRect
.
SetRectY
(
std
:
:
max
(
0
.
f
scrollableRect
.
Y
(
)
-
(
compSize
.
height
-
scrollableRect
.
Height
(
)
)
)
compSize
.
height
)
;
}
return
scrollableRect
;
}
CSSSize
CalculateCompositedSizeInCssPixels
(
)
const
{
if
(
GetZoom
(
)
=
=
CSSToParentLayerScale2D
(
0
0
)
)
{
return
CSSSize
(
)
;
}
return
mCompositionBounds
.
Size
(
)
/
GetZoom
(
)
;
}
CSSRect
CalculateCompositionBoundsInCssPixelsOfSurroundingContent
(
)
const
{
if
(
GetZoom
(
)
=
=
CSSToParentLayerScale2D
(
0
0
)
)
{
return
CSSRect
(
)
;
}
return
mCompositionBounds
/
GetZoom
(
)
*
CSSToCSSScale
{
mPresShellResolution
}
;
}
CSSSize
CalculateBoundedCompositedSizeInCssPixels
(
)
const
{
CSSSize
size
=
CalculateCompositedSizeInCssPixels
(
)
;
size
.
width
=
std
:
:
min
(
size
.
width
mRootCompositionSize
.
width
)
;
size
.
height
=
std
:
:
min
(
size
.
height
mRootCompositionSize
.
height
)
;
return
size
;
}
CSSRect
CalculateScrollRange
(
)
const
{
CSSSize
scrollPortSize
=
CalculateCompositedSizeInCssPixels
(
)
;
CSSRect
scrollRange
=
mScrollableRect
;
scrollRange
.
SetWidth
(
std
:
:
max
(
scrollRange
.
Width
(
)
-
scrollPortSize
.
width
0
.
0f
)
)
;
scrollRange
.
SetHeight
(
std
:
:
max
(
scrollRange
.
Height
(
)
-
scrollPortSize
.
height
0
.
0f
)
)
;
return
scrollRange
;
}
void
ScrollBy
(
const
CSSPoint
&
aPoint
)
{
mScrollOffset
+
=
aPoint
;
}
void
ZoomBy
(
float
aScale
)
{
ZoomBy
(
gfxSize
(
aScale
aScale
)
)
;
}
void
ZoomBy
(
const
gfxSize
&
aScale
)
{
mZoom
.
xScale
*
=
aScale
.
width
;
mZoom
.
yScale
*
=
aScale
.
height
;
}
void
CopyScrollInfoFrom
(
const
FrameMetrics
&
aOther
)
{
mScrollOffset
=
aOther
.
mScrollOffset
;
mScrollGeneration
=
aOther
.
mScrollGeneration
;
}
void
CopySmoothScrollInfoFrom
(
const
FrameMetrics
&
aOther
)
{
mSmoothScrollOffset
=
aOther
.
mSmoothScrollOffset
;
mScrollGeneration
=
aOther
.
mScrollGeneration
;
mDoSmoothScroll
=
aOther
.
mDoSmoothScroll
;
}
void
UpdatePendingScrollInfo
(
const
ScrollUpdateInfo
&
aInfo
)
{
mScrollOffset
=
aInfo
.
mScrollOffset
;
mScrollGeneration
=
aInfo
.
mScrollGeneration
;
mScrollUpdateType
=
ePending
;
}
void
SetRepaintDrivenByUserAction
(
bool
aUserAction
)
{
mScrollUpdateType
=
aUserAction
?
eUserAction
:
eNone
;
}
public
:
void
SetPresShellResolution
(
float
aPresShellResolution
)
{
mPresShellResolution
=
aPresShellResolution
;
}
float
GetPresShellResolution
(
)
const
{
return
mPresShellResolution
;
}
void
SetCompositionBounds
(
const
ParentLayerRect
&
aCompositionBounds
)
{
mCompositionBounds
=
aCompositionBounds
;
}
const
ParentLayerRect
&
GetCompositionBounds
(
)
const
{
return
mCompositionBounds
;
}
void
SetDisplayPort
(
const
CSSRect
&
aDisplayPort
)
{
mDisplayPort
=
aDisplayPort
;
}
const
CSSRect
&
GetDisplayPort
(
)
const
{
return
mDisplayPort
;
}
void
SetCriticalDisplayPort
(
const
CSSRect
&
aCriticalDisplayPort
)
{
mCriticalDisplayPort
=
aCriticalDisplayPort
;
}
const
CSSRect
&
GetCriticalDisplayPort
(
)
const
{
return
mCriticalDisplayPort
;
}
void
SetCumulativeResolution
(
const
LayoutDeviceToLayerScale2D
&
aCumulativeResolution
)
{
mCumulativeResolution
=
aCumulativeResolution
;
}
const
LayoutDeviceToLayerScale2D
&
GetCumulativeResolution
(
)
const
{
return
mCumulativeResolution
;
}
void
SetDevPixelsPerCSSPixel
(
const
CSSToLayoutDeviceScale
&
aDevPixelsPerCSSPixel
)
{
mDevPixelsPerCSSPixel
=
aDevPixelsPerCSSPixel
;
}
const
CSSToLayoutDeviceScale
&
GetDevPixelsPerCSSPixel
(
)
const
{
return
mDevPixelsPerCSSPixel
;
}
void
SetIsRootContent
(
bool
aIsRootContent
)
{
mIsRootContent
=
aIsRootContent
;
}
bool
IsRootContent
(
)
const
{
return
mIsRootContent
;
}
void
SetScrollOffset
(
const
CSSPoint
&
aScrollOffset
)
{
mScrollOffset
=
aScrollOffset
;
}
void
ClampAndSetScrollOffset
(
const
CSSPoint
&
aScrollOffset
)
{
SetScrollOffset
(
CalculateScrollRange
(
)
.
ClampPoint
(
aScrollOffset
)
)
;
}
const
CSSPoint
&
GetScrollOffset
(
)
const
{
return
mScrollOffset
;
}
void
SetSmoothScrollOffset
(
const
CSSPoint
&
aSmoothScrollDestination
)
{
mSmoothScrollOffset
=
aSmoothScrollDestination
;
}
const
CSSPoint
&
GetSmoothScrollOffset
(
)
const
{
return
mSmoothScrollOffset
;
}
void
SetZoom
(
const
CSSToParentLayerScale2D
&
aZoom
)
{
mZoom
=
aZoom
;
}
const
CSSToParentLayerScale2D
&
GetZoom
(
)
const
{
return
mZoom
;
}
void
SetScrollOffsetUpdated
(
uint32_t
aScrollGeneration
)
{
mScrollUpdateType
=
eMainThread
;
mScrollGeneration
=
aScrollGeneration
;
}
void
SetScrollOffsetRestored
(
uint32_t
aScrollGeneration
)
{
mScrollUpdateType
=
eRestore
;
mScrollGeneration
=
aScrollGeneration
;
}
void
SetSmoothScrollOffsetUpdated
(
int32_t
aScrollGeneration
)
{
mDoSmoothScroll
=
true
;
mScrollGeneration
=
aScrollGeneration
;
}
ScrollOffsetUpdateType
GetScrollUpdateType
(
)
const
{
return
mScrollUpdateType
;
}
bool
GetScrollOffsetUpdated
(
)
const
{
return
mScrollUpdateType
!
=
eNone
;
}
bool
GetDoSmoothScroll
(
)
const
{
return
mDoSmoothScroll
;
}
uint32_t
GetScrollGeneration
(
)
const
{
return
mScrollGeneration
;
}
ViewID
GetScrollId
(
)
const
{
return
mScrollId
;
}
void
SetScrollId
(
ViewID
scrollId
)
{
mScrollId
=
scrollId
;
}
void
SetRootCompositionSize
(
const
CSSSize
&
aRootCompositionSize
)
{
mRootCompositionSize
=
aRootCompositionSize
;
}
const
CSSSize
&
GetRootCompositionSize
(
)
const
{
return
mRootCompositionSize
;
}
void
SetDisplayPortMargins
(
const
ScreenMargin
&
aDisplayPortMargins
)
{
mDisplayPortMargins
=
aDisplayPortMargins
;
}
const
ScreenMargin
&
GetDisplayPortMargins
(
)
const
{
return
mDisplayPortMargins
;
}
void
SetUseDisplayPortMargins
(
bool
aValue
)
{
mUseDisplayPortMargins
=
aValue
;
}
bool
GetUseDisplayPortMargins
(
)
const
{
return
mUseDisplayPortMargins
;
}
uint32_t
GetPresShellId
(
)
const
{
return
mPresShellId
;
}
void
SetPresShellId
(
uint32_t
aPresShellId
)
{
mPresShellId
=
aPresShellId
;
}
void
SetViewport
(
const
CSSRect
&
aViewport
)
{
mViewport
=
aViewport
;
}
const
CSSRect
&
GetViewport
(
)
const
{
return
mViewport
;
}
CSSRect
GetVisualViewport
(
)
const
{
return
CSSRect
(
mScrollOffset
CalculateCompositedSizeInCssPixels
(
)
)
;
}
void
SetExtraResolution
(
const
ScreenToLayerScale2D
&
aExtraResolution
)
{
mExtraResolution
=
aExtraResolution
;
}
const
ScreenToLayerScale2D
&
GetExtraResolution
(
)
const
{
return
mExtraResolution
;
}
const
CSSRect
&
GetScrollableRect
(
)
const
{
return
mScrollableRect
;
}
void
SetScrollableRect
(
const
CSSRect
&
aScrollableRect
)
{
mScrollableRect
=
aScrollableRect
;
}
bool
IsHorizontalContentRightToLeft
(
)
{
return
mScrollableRect
.
x
<
0
;
}
void
SetPaintRequestTime
(
const
TimeStamp
&
aTime
)
{
mPaintRequestTime
=
aTime
;
}
const
TimeStamp
&
GetPaintRequestTime
(
)
const
{
return
mPaintRequestTime
;
}
void
SetIsScrollInfoLayer
(
bool
aIsScrollInfoLayer
)
{
mIsScrollInfoLayer
=
aIsScrollInfoLayer
;
}
bool
IsScrollInfoLayer
(
)
const
{
return
mIsScrollInfoLayer
;
}
void
RecalculateViewportOffset
(
)
;
private
:
ViewID
mScrollId
;
float
mPresShellResolution
;
ParentLayerRect
mCompositionBounds
;
CSSRect
mDisplayPort
;
CSSRect
mCriticalDisplayPort
;
CSSRect
mScrollableRect
;
LayoutDeviceToLayerScale2D
mCumulativeResolution
;
CSSToLayoutDeviceScale
mDevPixelsPerCSSPixel
;
CSSPoint
mScrollOffset
;
CSSToParentLayerScale2D
mZoom
;
uint32_t
mScrollGeneration
;
CSSPoint
mSmoothScrollOffset
;
CSSSize
mRootCompositionSize
;
ScreenMargin
mDisplayPortMargins
;
uint32_t
mPresShellId
;
CSSRect
mViewport
;
ScreenToLayerScale2D
mExtraResolution
;
TimeStamp
mPaintRequestTime
;
ScrollOffsetUpdateType
mScrollUpdateType
;
bool
mIsRootContent
:
1
;
bool
mDoSmoothScroll
:
1
;
bool
mUseDisplayPortMargins
:
1
;
bool
mIsScrollInfoLayer
:
1
;
void
SetDoSmoothScroll
(
bool
aValue
)
{
mDoSmoothScroll
=
aValue
;
}
}
;
struct
ScrollSnapInfo
{
ScrollSnapInfo
(
)
:
mScrollSnapTypeX
(
NS_STYLE_SCROLL_SNAP_TYPE_NONE
)
mScrollSnapTypeY
(
NS_STYLE_SCROLL_SNAP_TYPE_NONE
)
{
}
bool
operator
=
=
(
const
ScrollSnapInfo
&
aOther
)
const
{
return
mScrollSnapTypeX
=
=
aOther
.
mScrollSnapTypeX
&
&
mScrollSnapTypeY
=
=
aOther
.
mScrollSnapTypeY
&
&
mScrollSnapIntervalX
=
=
aOther
.
mScrollSnapIntervalX
&
&
mScrollSnapIntervalY
=
=
aOther
.
mScrollSnapIntervalY
&
&
mScrollSnapDestination
=
=
aOther
.
mScrollSnapDestination
&
&
mScrollSnapCoordinates
=
=
aOther
.
mScrollSnapCoordinates
;
}
bool
HasScrollSnapping
(
)
const
{
return
mScrollSnapTypeY
!
=
NS_STYLE_SCROLL_SNAP_TYPE_NONE
|
|
mScrollSnapTypeX
!
=
NS_STYLE_SCROLL_SNAP_TYPE_NONE
;
}
uint8_t
mScrollSnapTypeX
;
uint8_t
mScrollSnapTypeY
;
Maybe
<
nscoord
>
mScrollSnapIntervalX
;
Maybe
<
nscoord
>
mScrollSnapIntervalY
;
nsPoint
mScrollSnapDestination
;
nsTArray
<
nsPoint
>
mScrollSnapCoordinates
;
}
;
MOZ_DEFINE_ENUM_CLASS_WITH_BASE
(
OverscrollBehavior
uint8_t
(
Auto
Contain
None
)
)
;
struct
OverscrollBehaviorInfo
{
OverscrollBehaviorInfo
(
)
:
mBehaviorX
(
OverscrollBehavior
:
:
Auto
)
mBehaviorY
(
OverscrollBehavior
:
:
Auto
)
{
}
static
OverscrollBehaviorInfo
FromStyleConstants
(
StyleOverscrollBehavior
aBehaviorX
StyleOverscrollBehavior
aBehaviorY
)
;
bool
operator
=
=
(
const
OverscrollBehaviorInfo
&
aOther
)
const
{
return
mBehaviorX
=
=
aOther
.
mBehaviorX
&
&
mBehaviorY
=
=
aOther
.
mBehaviorY
;
}
OverscrollBehavior
mBehaviorX
;
OverscrollBehavior
mBehaviorY
;
}
;
struct
LayerClip
{
friend
struct
IPC
:
:
ParamTraits
<
mozilla
:
:
layers
:
:
LayerClip
>
;
public
:
LayerClip
(
)
:
mClipRect
(
)
mMaskLayerIndex
(
)
{
}
explicit
LayerClip
(
const
ParentLayerIntRect
&
aClipRect
)
:
mClipRect
(
aClipRect
)
mMaskLayerIndex
(
)
{
}
bool
operator
=
=
(
const
LayerClip
&
aOther
)
const
{
return
mClipRect
=
=
aOther
.
mClipRect
&
&
mMaskLayerIndex
=
=
aOther
.
mMaskLayerIndex
;
}
void
SetClipRect
(
const
ParentLayerIntRect
&
aClipRect
)
{
mClipRect
=
aClipRect
;
}
const
ParentLayerIntRect
&
GetClipRect
(
)
const
{
return
mClipRect
;
}
void
SetMaskLayerIndex
(
const
Maybe
<
size_t
>
&
aIndex
)
{
mMaskLayerIndex
=
aIndex
;
}
const
Maybe
<
size_t
>
&
GetMaskLayerIndex
(
)
const
{
return
mMaskLayerIndex
;
}
private
:
ParentLayerIntRect
mClipRect
;
Maybe
<
size_t
>
mMaskLayerIndex
;
}
;
typedef
Maybe
<
LayerClip
>
MaybeLayerClip
;
struct
ScrollMetadata
{
friend
struct
IPC
:
:
ParamTraits
<
mozilla
:
:
layers
:
:
ScrollMetadata
>
;
typedef
FrameMetrics
:
:
ViewID
ViewID
;
public
:
static
StaticAutoPtr
<
const
ScrollMetadata
>
sNullMetadata
;
ScrollMetadata
(
)
:
mMetrics
(
)
mSnapInfo
(
)
mScrollParentId
(
FrameMetrics
:
:
NULL_SCROLL_ID
)
mBackgroundColor
(
)
mContentDescription
(
)
mLineScrollAmount
(
0
0
)
mPageScrollAmount
(
0
0
)
mScrollClip
(
)
mHasScrollgrab
(
false
)
mIsLayersIdRoot
(
false
)
mIsAutoDirRootContentRTL
(
false
)
mUsesContainerScrolling
(
false
)
mForceDisableApz
(
false
)
mOverscrollBehavior
(
)
{
}
bool
operator
=
=
(
const
ScrollMetadata
&
aOther
)
const
{
return
mMetrics
=
=
aOther
.
mMetrics
&
&
mSnapInfo
=
=
aOther
.
mSnapInfo
&
&
mScrollParentId
=
=
aOther
.
mScrollParentId
&
&
mBackgroundColor
=
=
aOther
.
mBackgroundColor
&
&
mLineScrollAmount
=
=
aOther
.
mLineScrollAmount
&
&
mPageScrollAmount
=
=
aOther
.
mPageScrollAmount
&
&
mScrollClip
=
=
aOther
.
mScrollClip
&
&
mHasScrollgrab
=
=
aOther
.
mHasScrollgrab
&
&
mIsLayersIdRoot
=
=
aOther
.
mIsLayersIdRoot
&
&
mIsAutoDirRootContentRTL
=
=
aOther
.
mIsAutoDirRootContentRTL
&
&
mUsesContainerScrolling
=
=
aOther
.
mUsesContainerScrolling
&
&
mForceDisableApz
=
=
aOther
.
mForceDisableApz
&
&
mDisregardedDirection
=
=
aOther
.
mDisregardedDirection
&
&
mOverscrollBehavior
=
=
aOther
.
mOverscrollBehavior
;
}
bool
operator
!
=
(
const
ScrollMetadata
&
aOther
)
const
{
return
!
operator
=
=
(
aOther
)
;
}
bool
IsDefault
(
)
const
{
ScrollMetadata
def
;
def
.
mMetrics
.
SetPresShellId
(
mMetrics
.
GetPresShellId
(
)
)
;
return
(
def
=
=
*
this
)
;
}
FrameMetrics
&
GetMetrics
(
)
{
return
mMetrics
;
}
const
FrameMetrics
&
GetMetrics
(
)
const
{
return
mMetrics
;
}
void
SetSnapInfo
(
ScrollSnapInfo
&
&
aSnapInfo
)
{
mSnapInfo
=
std
:
:
move
(
aSnapInfo
)
;
}
const
ScrollSnapInfo
&
GetSnapInfo
(
)
const
{
return
mSnapInfo
;
}
ViewID
GetScrollParentId
(
)
const
{
return
mScrollParentId
;
}
void
SetScrollParentId
(
ViewID
aParentId
)
{
mScrollParentId
=
aParentId
;
}
const
gfx
:
:
Color
&
GetBackgroundColor
(
)
const
{
return
mBackgroundColor
;
}
void
SetBackgroundColor
(
const
gfx
:
:
Color
&
aBackgroundColor
)
{
mBackgroundColor
=
aBackgroundColor
;
}
const
nsCString
&
GetContentDescription
(
)
const
{
return
mContentDescription
;
}
void
SetContentDescription
(
const
nsCString
&
aContentDescription
)
{
mContentDescription
=
aContentDescription
;
}
const
LayoutDeviceIntSize
&
GetLineScrollAmount
(
)
const
{
return
mLineScrollAmount
;
}
void
SetLineScrollAmount
(
const
LayoutDeviceIntSize
&
size
)
{
mLineScrollAmount
=
size
;
}
const
LayoutDeviceIntSize
&
GetPageScrollAmount
(
)
const
{
return
mPageScrollAmount
;
}
void
SetPageScrollAmount
(
const
LayoutDeviceIntSize
&
size
)
{
mPageScrollAmount
=
size
;
}
void
SetScrollClip
(
const
Maybe
<
LayerClip
>
&
aScrollClip
)
{
mScrollClip
=
aScrollClip
;
}
const
Maybe
<
LayerClip
>
&
GetScrollClip
(
)
const
{
return
mScrollClip
;
}
bool
HasScrollClip
(
)
const
{
return
mScrollClip
.
isSome
(
)
;
}
const
LayerClip
&
ScrollClip
(
)
const
{
return
mScrollClip
.
ref
(
)
;
}
LayerClip
&
ScrollClip
(
)
{
return
mScrollClip
.
ref
(
)
;
}
bool
HasMaskLayer
(
)
const
{
return
HasScrollClip
(
)
&
&
ScrollClip
(
)
.
GetMaskLayerIndex
(
)
;
}
Maybe
<
ParentLayerIntRect
>
GetClipRect
(
)
const
{
return
mScrollClip
.
isSome
(
)
?
Some
(
mScrollClip
-
>
GetClipRect
(
)
)
:
Nothing
(
)
;
}
void
SetHasScrollgrab
(
bool
aHasScrollgrab
)
{
mHasScrollgrab
=
aHasScrollgrab
;
}
bool
GetHasScrollgrab
(
)
const
{
return
mHasScrollgrab
;
}
void
SetIsLayersIdRoot
(
bool
aValue
)
{
mIsLayersIdRoot
=
aValue
;
}
bool
IsLayersIdRoot
(
)
const
{
return
mIsLayersIdRoot
;
}
void
SetIsAutoDirRootContentRTL
(
bool
aValue
)
{
mIsAutoDirRootContentRTL
=
aValue
;
}
bool
IsAutoDirRootContentRTL
(
)
const
{
return
mIsAutoDirRootContentRTL
;
}
void
SetUsesContainerScrolling
(
bool
aValue
)
;
bool
UsesContainerScrolling
(
)
const
{
return
mUsesContainerScrolling
;
}
void
SetForceDisableApz
(
bool
aForceDisable
)
{
mForceDisableApz
=
aForceDisable
;
}
bool
IsApzForceDisabled
(
)
const
{
return
mForceDisableApz
;
}
Maybe
<
ScrollDirection
>
GetDisregardedDirection
(
)
const
{
return
mDisregardedDirection
;
}
void
SetDisregardedDirection
(
const
Maybe
<
ScrollDirection
>
&
aValue
)
{
mDisregardedDirection
=
aValue
;
}
void
SetOverscrollBehavior
(
const
OverscrollBehaviorInfo
&
aOverscrollBehavior
)
{
mOverscrollBehavior
=
aOverscrollBehavior
;
}
const
OverscrollBehaviorInfo
&
GetOverscrollBehavior
(
)
const
{
return
mOverscrollBehavior
;
}
private
:
FrameMetrics
mMetrics
;
ScrollSnapInfo
mSnapInfo
;
ViewID
mScrollParentId
;
gfx
:
:
Color
mBackgroundColor
;
nsCString
mContentDescription
;
LayoutDeviceIntSize
mLineScrollAmount
;
LayoutDeviceIntSize
mPageScrollAmount
;
Maybe
<
LayerClip
>
mScrollClip
;
bool
mHasScrollgrab
:
1
;
bool
mIsLayersIdRoot
:
1
;
bool
mIsAutoDirRootContentRTL
:
1
;
bool
mUsesContainerScrolling
:
1
;
bool
mForceDisableApz
:
1
;
Maybe
<
ScrollDirection
>
mDisregardedDirection
;
OverscrollBehaviorInfo
mOverscrollBehavior
;
}
;
struct
ScrollableLayerGuid
{
LayersId
mLayersId
;
uint32_t
mPresShellId
;
FrameMetrics
:
:
ViewID
mScrollId
;
ScrollableLayerGuid
(
)
:
mLayersId
{
0
}
mPresShellId
(
0
)
mScrollId
(
0
)
{
}
ScrollableLayerGuid
(
LayersId
aLayersId
uint32_t
aPresShellId
FrameMetrics
:
:
ViewID
aScrollId
)
:
mLayersId
(
aLayersId
)
mPresShellId
(
aPresShellId
)
mScrollId
(
aScrollId
)
{
}
ScrollableLayerGuid
(
LayersId
aLayersId
const
FrameMetrics
&
aMetrics
)
:
mLayersId
(
aLayersId
)
mPresShellId
(
aMetrics
.
GetPresShellId
(
)
)
mScrollId
(
aMetrics
.
GetScrollId
(
)
)
{
}
ScrollableLayerGuid
(
const
ScrollableLayerGuid
&
other
)
:
mLayersId
(
other
.
mLayersId
)
mPresShellId
(
other
.
mPresShellId
)
mScrollId
(
other
.
mScrollId
)
{
}
~
ScrollableLayerGuid
(
)
{
}
bool
operator
=
=
(
const
ScrollableLayerGuid
&
other
)
const
{
return
mLayersId
=
=
other
.
mLayersId
&
&
mPresShellId
=
=
other
.
mPresShellId
&
&
mScrollId
=
=
other
.
mScrollId
;
}
bool
operator
!
=
(
const
ScrollableLayerGuid
&
other
)
const
{
return
!
(
*
this
=
=
other
)
;
}
bool
operator
<
(
const
ScrollableLayerGuid
&
other
)
const
{
if
(
mLayersId
<
other
.
mLayersId
)
{
return
true
;
}
if
(
mLayersId
=
=
other
.
mLayersId
)
{
if
(
mPresShellId
<
other
.
mPresShellId
)
{
return
true
;
}
if
(
mPresShellId
=
=
other
.
mPresShellId
)
{
return
mScrollId
<
other
.
mScrollId
;
}
}
return
false
;
}
struct
HashFn
{
std
:
:
size_t
operator
(
)
(
const
ScrollableLayerGuid
&
aGuid
)
const
{
return
HashGeneric
(
uint64_t
(
aGuid
.
mLayersId
)
aGuid
.
mPresShellId
aGuid
.
mScrollId
)
;
}
}
;
struct
HashIgnoringPresShellFn
{
std
:
:
size_t
operator
(
)
(
const
ScrollableLayerGuid
&
aGuid
)
const
{
return
HashGeneric
(
uint64_t
(
aGuid
.
mLayersId
)
aGuid
.
mScrollId
)
;
}
}
;
struct
EqualIgnoringPresShellFn
{
bool
operator
(
)
(
const
ScrollableLayerGuid
&
lhs
const
ScrollableLayerGuid
&
rhs
)
const
{
return
lhs
.
mLayersId
=
=
rhs
.
mLayersId
&
&
lhs
.
mScrollId
=
=
rhs
.
mScrollId
;
}
}
;
}
;
template
<
int
LogLevel
>
gfx
:
:
Log
<
LogLevel
>
&
operator
<
<
(
gfx
:
:
Log
<
LogLevel
>
&
log
const
ScrollableLayerGuid
&
aGuid
)
{
return
log
<
<
'
(
'
<
<
uint64_t
(
aGuid
.
mLayersId
)
<
<
'
'
<
<
aGuid
.
mPresShellId
<
<
'
'
<
<
aGuid
.
mScrollId
<
<
'
)
'
;
}
struct
ZoomConstraints
{
bool
mAllowZoom
;
bool
mAllowDoubleTapZoom
;
CSSToParentLayerScale
mMinZoom
;
CSSToParentLayerScale
mMaxZoom
;
ZoomConstraints
(
)
:
mAllowZoom
(
true
)
mAllowDoubleTapZoom
(
true
)
{
MOZ_COUNT_CTOR
(
ZoomConstraints
)
;
}
ZoomConstraints
(
bool
aAllowZoom
bool
aAllowDoubleTapZoom
const
CSSToParentLayerScale
&
aMinZoom
const
CSSToParentLayerScale
&
aMaxZoom
)
:
mAllowZoom
(
aAllowZoom
)
mAllowDoubleTapZoom
(
aAllowDoubleTapZoom
)
mMinZoom
(
aMinZoom
)
mMaxZoom
(
aMaxZoom
)
{
MOZ_COUNT_CTOR
(
ZoomConstraints
)
;
}
ZoomConstraints
(
const
ZoomConstraints
&
other
)
:
mAllowZoom
(
other
.
mAllowZoom
)
mAllowDoubleTapZoom
(
other
.
mAllowDoubleTapZoom
)
mMinZoom
(
other
.
mMinZoom
)
mMaxZoom
(
other
.
mMaxZoom
)
{
MOZ_COUNT_CTOR
(
ZoomConstraints
)
;
}
~
ZoomConstraints
(
)
{
MOZ_COUNT_DTOR
(
ZoomConstraints
)
;
}
bool
operator
=
=
(
const
ZoomConstraints
&
other
)
const
{
return
mAllowZoom
=
=
other
.
mAllowZoom
&
&
mAllowDoubleTapZoom
=
=
other
.
mAllowDoubleTapZoom
&
&
mMinZoom
=
=
other
.
mMinZoom
&
&
mMaxZoom
=
=
other
.
mMaxZoom
;
}
bool
operator
!
=
(
const
ZoomConstraints
&
other
)
const
{
return
!
(
*
this
=
=
other
)
;
}
}
;
typedef
Maybe
<
ZoomConstraints
>
MaybeZoomConstraints
;
typedef
std
:
:
map
<
FrameMetrics
:
:
ViewID
ScrollUpdateInfo
>
ScrollUpdatesMap
;
}
}
#
endif
