#
ifndef
MOZILLA_LAYERS_BSPTREE_H
#
define
MOZILLA_LAYERS_BSPTREE_H
#
include
<
list
>
#
include
<
utility
>
#
include
"
mozilla
/
ArenaAllocator
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
gfx
/
Polygon
.
h
"
#
include
"
nsTArray
.
h
"
namespace
mozilla
{
namespace
layers
{
class
Layer
;
struct
LayerPolygon
{
explicit
LayerPolygon
(
Layer
*
aLayer
)
:
layer
(
aLayer
)
{
}
LayerPolygon
(
Layer
*
aLayer
gfx
:
:
Polygon
&
&
aGeometry
)
:
layer
(
aLayer
)
geometry
(
Some
(
std
:
:
move
(
aGeometry
)
)
)
{
}
LayerPolygon
(
Layer
*
aLayer
nsTArray
<
gfx
:
:
Point4D
>
&
&
aPoints
const
gfx
:
:
Point4D
&
aNormal
)
:
layer
(
aLayer
)
{
geometry
.
emplace
(
std
:
:
move
(
aPoints
)
aNormal
)
;
}
Layer
*
layer
;
Maybe
<
gfx
:
:
Polygon
>
geometry
;
}
;
typedef
mozilla
:
:
ArenaAllocator
<
4096
8
>
BSPTreeArena
;
typedef
std
:
:
list
<
LayerPolygon
>
LayerList
;
struct
BSPTreeNode
{
explicit
BSPTreeNode
(
nsTArray
<
LayerList
*
>
&
aListPointers
)
:
front
(
nullptr
)
back
(
nullptr
)
{
aListPointers
.
AppendElement
(
&
layers
)
;
}
const
gfx
:
:
Polygon
&
First
(
)
const
{
MOZ_ASSERT
(
!
layers
.
empty
(
)
)
;
MOZ_ASSERT
(
layers
.
front
(
)
.
geometry
)
;
return
*
layers
.
front
(
)
.
geometry
;
}
static
void
*
operator
new
(
size_t
aSize
BSPTreeArena
&
mPool
)
{
return
mPool
.
Allocate
(
aSize
)
;
}
BSPTreeNode
*
front
;
BSPTreeNode
*
back
;
LayerList
layers
;
}
;
class
BSPTree
final
{
public
:
explicit
BSPTree
(
std
:
:
list
<
LayerPolygon
>
&
aLayers
)
{
MOZ_ASSERT
(
!
aLayers
.
empty
(
)
)
;
mRoot
=
new
(
mPool
)
BSPTreeNode
(
mListPointers
)
;
BuildTree
(
mRoot
aLayers
)
;
}
~
BSPTree
(
)
{
for
(
LayerList
*
listPtr
:
mListPointers
)
{
listPtr
-
>
~
LayerList
(
)
;
}
}
nsTArray
<
LayerPolygon
>
GetDrawOrder
(
)
const
{
nsTArray
<
LayerPolygon
>
layers
;
BuildDrawOrder
(
mRoot
layers
)
;
return
layers
;
}
private
:
BSPTreeArena
mPool
;
BSPTreeNode
*
mRoot
;
nsTArray
<
LayerList
*
>
mListPointers
;
void
BuildDrawOrder
(
BSPTreeNode
*
aNode
nsTArray
<
LayerPolygon
>
&
aLayers
)
const
;
void
BuildTree
(
BSPTreeNode
*
aRoot
std
:
:
list
<
LayerPolygon
>
&
aLayers
)
;
}
;
}
}
#
endif
