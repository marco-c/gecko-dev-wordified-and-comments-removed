#
ifndef
mozilla_layers_NativeLayerCA_h
#
define
mozilla_layers_NativeLayerCA_h
#
include
<
IOSurface
/
IOSurfaceRef
.
h
>
#
include
<
deque
>
#
include
<
unordered_map
>
#
include
<
ostream
>
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
gfx
/
MacIOSurface
.
h
"
#
include
"
mozilla
/
layers
/
NativeLayer
.
h
"
#
include
"
mozilla
/
layers
/
NativeLayerMacSurfaceHandler
.
h
"
#
include
"
mozilla
/
webrender
/
RenderMacIOSurfaceTextureHost
.
h
"
#
include
"
CFTypeRefPtr
.
h
"
#
include
"
nsRegion
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
ifdef
__OBJC__
class
CALayer
;
class
CARenderer
;
#
else
typedef
void
CALayer
;
typedef
void
CARenderer
;
#
endif
namespace
mozilla
{
namespace
gl
{
class
GLContextCGL
;
class
MozFramebuffer
;
}
namespace
wr
{
class
RenderMacIOSurfaceTextureHost
;
}
namespace
layers
{
class
NativeLayerRootSnapshotterCA
;
enum
class
VideoLowPowerType
{
NotVideo
LowPower
FailMultipleVideo
FailWindowed
FailOverlaid
FailBacking
FailMacOSVersion
FailPref
FailSurface
FailEnqueue
}
;
enum
class
NativeLayerCAUpdateType
{
None
OnlyVideo
All
}
;
class
SnapshotterCADelegate
{
public
:
virtual
~
SnapshotterCADelegate
(
)
;
virtual
float
BackingScale
(
)
const
{
return
1
.
0f
;
}
virtual
void
UpdateSnapshotterLayers
(
CALayer
*
aRootCALayer
)
=
0
;
virtual
void
OnSnapshotterDestroyed
(
NativeLayerRootSnapshotterCA
*
aSnapshotter
)
{
}
}
;
class
NativeLayerRootCA
final
:
public
NativeLayerRoot
{
public
:
static
already_AddRefed
<
NativeLayerRootCA
>
CreateForCALayer
(
CALayer
*
aLayer
)
;
virtual
NativeLayerRootCA
*
AsNativeLayerRootCA
(
)
override
{
return
this
;
}
bool
CommitToScreen
(
)
override
;
void
CommitOffscreen
(
CALayer
*
aRootCALayer
)
;
void
OnNativeLayerRootSnapshotterDestroyed
(
NativeLayerRootSnapshotterCA
*
aNativeLayerRootSnapshotter
)
;
void
SuspendOffMainThreadCommits
(
)
;
bool
UnsuspendOffMainThreadCommits
(
)
;
bool
AreOffMainThreadCommitsSuspended
(
)
;
void
DumpLayerTreeToFile
(
const
char
*
aPath
const
MutexAutoLock
&
aProofOfLock
)
;
enum
class
WhichRepresentation
:
uint8_t
{
ONSCREEN
OFFSCREEN
}
;
already_AddRefed
<
NativeLayer
>
CreateLayer
(
const
gfx
:
:
IntSize
&
aSize
bool
aIsOpaque
SurfacePoolHandle
*
aSurfacePoolHandle
)
override
;
void
AppendLayer
(
NativeLayer
*
aLayer
)
override
;
void
RemoveLayer
(
NativeLayer
*
aLayer
)
override
;
void
SetLayers
(
const
nsTArray
<
RefPtr
<
NativeLayer
>
>
&
aLayers
)
override
;
UniquePtr
<
NativeLayerRootSnapshotter
>
CreateSnapshotter
(
)
override
;
void
SetBackingScale
(
float
aBackingScale
)
;
float
BackingScale
(
)
;
already_AddRefed
<
NativeLayer
>
CreateLayerForExternalTexture
(
bool
aIsOpaque
)
override
;
already_AddRefed
<
NativeLayer
>
CreateLayerForColor
(
gfx
:
:
DeviceColor
aColor
)
override
;
already_AddRefed
<
NativeLayerCA
>
CreateLayerForSurfacePresentation
(
const
gfx
:
:
IntSize
&
aSize
bool
aIsOpaque
)
;
void
SetWindowIsFullscreen
(
bool
aFullscreen
)
;
VideoLowPowerType
CheckVideoLowPower
(
const
MutexAutoLock
&
aProofOfLock
)
;
protected
:
explicit
NativeLayerRootCA
(
CALayer
*
aLayer
)
;
~
NativeLayerRootCA
(
)
override
;
void
CommitRepresentation
(
WhichRepresentation
aRepresentation
CALayer
*
aRootCALayer
const
nsTArray
<
RefPtr
<
NativeLayerCA
>
>
&
aSublayers
bool
aMutatedLayerStructure
bool
aWindowIsFullscreen
)
;
void
SetMutatedLayerStructure
(
)
;
using
UpdateType
=
NativeLayerCAUpdateType
;
UpdateType
GetMaxUpdateRequired
(
WhichRepresentation
aRepresentation
const
nsTArray
<
RefPtr
<
NativeLayerCA
>
>
&
aSublayers
bool
aMutatedLayerStructure
)
const
;
struct
SnapshotterDelegate
final
:
public
SnapshotterCADelegate
{
explicit
SnapshotterDelegate
(
NativeLayerRootCA
*
aLayerRoot
)
;
virtual
~
SnapshotterDelegate
(
)
override
;
virtual
float
BackingScale
(
)
const
override
{
return
mLayerRoot
-
>
BackingScale
(
)
;
}
virtual
void
UpdateSnapshotterLayers
(
CALayer
*
aRootCALayer
)
override
{
mLayerRoot
-
>
CommitOffscreen
(
aRootCALayer
)
;
}
virtual
void
OnSnapshotterDestroyed
(
NativeLayerRootSnapshotterCA
*
aSnapshotter
)
override
{
mLayerRoot
-
>
OnNativeLayerRootSnapshotterDestroyed
(
aSnapshotter
)
;
}
RefPtr
<
NativeLayerRootCA
>
mLayerRoot
;
}
;
Mutex
mMutex
MOZ_UNANNOTATED
;
CALayer
*
mOnscreenRootCALayer
=
nullptr
;
NativeLayerRootSnapshotterCA
*
mWeakSnapshotter
=
nullptr
;
nsTArray
<
RefPtr
<
NativeLayerCA
>
>
mSublayers
;
float
mBackingScale
=
1
.
0f
;
bool
mMutated
=
false
;
bool
mOffMainThreadCommitsSuspended
=
false
;
bool
mCommitPending
=
false
;
bool
mWindowIsFullscreen
=
false
;
bool
mMutatedOnscreenLayerStructure
=
false
;
bool
mMutatedOffscreenLayerStructure
=
false
;
unsigned
int
mTelemetryCommitCount
=
0
;
}
;
class
RenderSourceNLRS
;
#
ifdef
XP_MACOSX
class
NativeLayerRootSnapshotterCA
final
:
public
NativeLayerRootSnapshotter
{
public
:
static
UniquePtr
<
NativeLayerRootSnapshotterCA
>
Create
(
UniquePtr
<
SnapshotterCADelegate
>
&
&
aDelegate
)
;
virtual
~
NativeLayerRootSnapshotterCA
(
)
;
bool
ReadbackPixels
(
const
gfx
:
:
IntSize
&
aReadbackSize
gfx
:
:
SurfaceFormat
aReadbackFormat
const
Range
<
uint8_t
>
&
aReadbackBuffer
)
override
;
already_AddRefed
<
profiler_screenshots
:
:
RenderSource
>
GetWindowContents
(
const
gfx
:
:
IntSize
&
aWindowSize
)
override
;
already_AddRefed
<
profiler_screenshots
:
:
DownscaleTarget
>
CreateDownscaleTarget
(
const
gfx
:
:
IntSize
&
aSize
)
override
;
already_AddRefed
<
profiler_screenshots
:
:
AsyncReadbackBuffer
>
CreateAsyncReadbackBuffer
(
const
gfx
:
:
IntSize
&
aSize
)
override
;
protected
:
NativeLayerRootSnapshotterCA
(
UniquePtr
<
SnapshotterCADelegate
>
&
&
aDelegate
RefPtr
<
gl
:
:
GLContext
>
&
&
aGL
)
;
void
UpdateSnapshot
(
const
gfx
:
:
IntSize
&
aSize
)
;
UniquePtr
<
SnapshotterCADelegate
>
mDelegate
;
RefPtr
<
gl
:
:
GLContext
>
mGL
;
RefPtr
<
RenderSourceNLRS
>
mSnapshot
;
CARenderer
*
mRenderer
=
nullptr
;
}
;
#
endif
struct
NativeLayerCARepresentation
{
using
UpdateType
=
NativeLayerCAUpdateType
;
NativeLayerCARepresentation
(
)
;
~
NativeLayerCARepresentation
(
)
;
CALayer
*
UnderlyingCALayer
(
)
{
return
mWrappingCALayerHasExtent
?
mWrappingCALayer
:
nullptr
;
}
bool
EnqueueSurface
(
IOSurfaceRef
aSurfaceRef
)
;
bool
ApplyChanges
(
NativeLayerCAUpdateType
aUpdate
const
gfx
:
:
IntSize
&
aSize
bool
aIsOpaque
const
gfx
:
:
IntPoint
&
aPosition
const
gfx
:
:
Matrix4x4
&
aTransform
const
gfx
:
:
IntRect
&
aDisplayRect
const
Maybe
<
gfx
:
:
IntRect
>
&
aClipRect
const
Maybe
<
gfx
:
:
RoundedRect
>
&
aRoundedClip
float
aBackingScale
bool
aSurfaceIsFlipped
gfx
:
:
SamplingFilter
aSamplingFilter
bool
aSpecializeVideo
const
CFTypeRefPtr
<
IOSurfaceRef
>
&
aFrontSurface
const
Maybe
<
gfx
:
:
DeviceColor
>
&
aColor
bool
aIsDRM
bool
aIsVideo
)
;
NativeLayerCAUpdateType
HasUpdate
(
bool
aIsVideo
)
;
CALayer
*
mWrappingCALayer
=
nullptr
;
CALayer
*
mRoundedClipCALayer
=
nullptr
;
CALayer
*
mContentCALayer
=
nullptr
;
CALayer
*
mOpaquenessTintLayer
=
nullptr
;
#
ifdef
NIGHTLY_BUILD
bool
mLogNextVideoSurface
=
false
;
#
endif
bool
mWrappingCALayerHasExtent
:
1
;
bool
mMutatedPosition
:
1
;
bool
mMutatedTransform
:
1
;
bool
mMutatedDisplayRect
:
1
;
bool
mMutatedClipRect
:
1
;
bool
mMutatedRoundedClipRect
:
1
;
bool
mMutatedBackingScale
:
1
;
bool
mMutatedSize
:
1
;
bool
mMutatedSurfaceIsFlipped
:
1
;
bool
mMutatedFrontSurface
:
1
;
bool
mMutatedSamplingFilter
:
1
;
bool
mMutatedSpecializeVideo
:
1
;
bool
mMutatedIsDRM
:
1
;
}
;
class
NativeLayerCA
:
public
NativeLayer
{
public
:
virtual
NativeLayerCA
*
AsNativeLayerCA
(
)
override
{
return
this
;
}
gfx
:
:
IntSize
GetSize
(
)
override
;
void
SetPosition
(
const
gfx
:
:
IntPoint
&
aPosition
)
override
;
gfx
:
:
IntPoint
GetPosition
(
)
override
;
void
SetTransform
(
const
gfx
:
:
Matrix4x4
&
aTransform
)
override
;
gfx
:
:
Matrix4x4
GetTransform
(
)
override
;
gfx
:
:
IntRect
GetRect
(
)
override
;
void
SetSamplingFilter
(
gfx
:
:
SamplingFilter
aSamplingFilter
)
override
;
RefPtr
<
gfx
:
:
DrawTarget
>
NextSurfaceAsDrawTarget
(
const
gfx
:
:
IntRect
&
aDisplayRect
const
gfx
:
:
IntRegion
&
aUpdateRegion
gfx
:
:
BackendType
aBackendType
)
override
;
Maybe
<
GLuint
>
NextSurfaceAsFramebuffer
(
const
gfx
:
:
IntRect
&
aDisplayRect
const
gfx
:
:
IntRegion
&
aUpdateRegion
bool
aNeedsDepth
)
override
;
void
NotifySurfaceReady
(
)
override
;
void
DiscardBackbuffers
(
)
override
;
bool
IsOpaque
(
)
override
;
void
SetClipRect
(
const
Maybe
<
gfx
:
:
IntRect
>
&
aClipRect
)
override
;
Maybe
<
gfx
:
:
IntRect
>
ClipRect
(
)
override
;
void
SetRoundedClipRect
(
const
Maybe
<
gfx
:
:
RoundedRect
>
&
aClip
)
override
;
Maybe
<
gfx
:
:
RoundedRect
>
RoundedClipRect
(
)
override
;
gfx
:
:
IntRect
CurrentSurfaceDisplayRect
(
)
override
;
void
SetDisplayRect
(
const
gfx
:
:
IntRect
&
aDisplayRect
)
;
void
SetSurfaceIsFlipped
(
bool
aIsFlipped
)
override
;
bool
SurfaceIsFlipped
(
)
override
;
void
SetSurfaceToPresent
(
CFTypeRefPtr
<
IOSurfaceRef
>
aSurfaceRef
gfx
:
:
IntSize
&
aSize
bool
aIsDRM
bool
aIsHDR
)
;
void
DumpLayer
(
std
:
:
ostream
&
aOutputStream
)
;
void
AttachExternalImage
(
wr
:
:
RenderTextureHost
*
aExternalImage
)
override
;
GpuFence
*
GetGpuFence
(
)
override
;
void
SetRootWindowIsFullscreen
(
bool
aFullscreen
)
;
protected
:
friend
class
NativeLayerRootCA
;
friend
struct
NativeLayerCARepresentation
;
using
UpdateType
=
NativeLayerCAUpdateType
;
using
WhichRepresentation
=
NativeLayerRootCA
:
:
WhichRepresentation
;
using
Representation
=
NativeLayerCARepresentation
;
NativeLayerCA
(
const
gfx
:
:
IntSize
&
aSize
bool
aIsOpaque
SurfacePoolHandleCA
*
aSurfacePoolHandle
)
;
explicit
NativeLayerCA
(
bool
aIsOpaque
)
;
explicit
NativeLayerCA
(
gfx
:
:
DeviceColor
aColor
)
;
explicit
NativeLayerCA
(
const
gfx
:
:
IntSize
&
aSize
bool
aIsOpaque
)
;
~
NativeLayerCA
(
)
override
;
CALayer
*
UnderlyingCALayer
(
WhichRepresentation
aRepresentation
)
;
NativeLayerCAUpdateType
HasUpdate
(
WhichRepresentation
aRepresentation
)
;
bool
ApplyChanges
(
WhichRepresentation
aRepresentation
UpdateType
aUpdate
bool
*
aMustRebuild
)
;
void
SetBackingScale
(
float
aBackingScale
)
;
template
<
typename
F
>
void
HandlePartialUpdate
(
const
MutexAutoLock
&
aProofOfLock
const
gfx
:
:
IntRect
&
aDisplayRect
const
gfx
:
:
IntRegion
&
aUpdateRegion
F
&
&
aCopyFn
)
;
bool
IsVideo
(
const
MutexAutoLock
&
aProofOfLock
)
;
bool
ShouldSpecializeVideo
(
const
MutexAutoLock
&
aProofOfLock
)
;
static
Maybe
<
CGRect
>
CalculateClipGeometry
(
const
gfx
:
:
IntSize
&
aSize
const
gfx
:
:
IntPoint
&
aPosition
const
gfx
:
:
Matrix4x4
&
aTransform
const
gfx
:
:
IntRect
&
aDisplayRect
const
Maybe
<
gfx
:
:
IntRect
>
&
aClipRect
float
aBackingScale
)
;
Representation
&
GetRepresentation
(
WhichRepresentation
aRepresentation
)
;
template
<
typename
F
>
void
ForAllRepresentations
(
F
aFn
)
;
Mutex
mMutex
MOZ_UNANNOTATED
;
CFTypeRefPtr
<
IOSurfaceRef
>
mSurfaceToPresent
;
Maybe
<
NativeLayerMacSurfaceHandler
>
mSurfaceHandler
;
RefPtr
<
wr
:
:
RenderMacIOSurfaceTextureHost
>
mTextureHost
;
bool
mTextureHostIsVideo
=
false
;
Representation
mOnscreenRepresentation
;
Representation
mOffscreenRepresentation
;
gfx
:
:
IntPoint
mPosition
;
gfx
:
:
Matrix4x4
mTransform
;
gfx
:
:
IntRect
mDisplayRect
;
gfx
:
:
IntSize
mSize
;
Maybe
<
gfx
:
:
IntRect
>
mClipRect
;
Maybe
<
gfx
:
:
RoundedRect
>
mRoundedClipRect
;
Maybe
<
gfx
:
:
DeviceColor
>
mColor
;
gfx
:
:
SamplingFilter
mSamplingFilter
=
gfx
:
:
SamplingFilter
:
:
POINT
;
float
mBackingScale
=
1
.
0f
;
bool
mSurfaceIsFlipped
=
false
;
const
bool
mIsOpaque
=
false
;
bool
mRootWindowIsFullscreen
=
false
;
bool
mSpecializeVideo
=
false
;
bool
mIsDRM
=
false
;
bool
mIsHDR
=
false
;
#
ifdef
NIGHTLY_BUILD
bool
mHasEverAttachExternalImage
=
false
;
bool
mHasEverNotifySurfaceReady
=
false
;
#
endif
}
;
}
}
#
endif
