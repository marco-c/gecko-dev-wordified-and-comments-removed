#
include
"
mozilla
/
layers
/
TextureSourceProvider
.
h
"
#
include
"
mozilla
/
layers
/
TextureHost
.
h
"
namespace
mozilla
{
namespace
layers
{
TextureSourceProvider
:
:
~
TextureSourceProvider
(
)
{
ReadUnlockTextures
(
)
;
}
void
TextureSourceProvider
:
:
ReadUnlockTextures
(
)
{
for
(
auto
&
texture
:
mUnlockAfterComposition
)
{
texture
-
>
ReadUnlock
(
)
;
}
mUnlockAfterComposition
.
Clear
(
)
;
}
void
TextureSourceProvider
:
:
UnlockAfterComposition
(
TextureHost
*
aTexture
)
{
mUnlockAfterComposition
.
AppendElement
(
aTexture
)
;
}
bool
TextureSourceProvider
:
:
NotifyNotUsedAfterComposition
(
TextureHost
*
aTextureHost
)
{
mNotifyNotUsedAfterComposition
.
AppendElement
(
aTextureHost
)
;
const
int
thresholdCount
=
5
;
const
double
thresholdSec
=
2
.
0f
;
if
(
mNotifyNotUsedAfterComposition
.
Length
(
)
>
thresholdCount
)
{
TimeStamp
lastCompositionEndTime
=
GetLastCompositionEndTime
(
)
;
TimeDuration
duration
=
lastCompositionEndTime
?
TimeStamp
:
:
Now
(
)
-
lastCompositionEndTime
:
TimeDuration
(
)
;
if
(
duration
.
ToSeconds
(
)
>
thresholdSec
)
{
FlushPendingNotifyNotUsed
(
)
;
}
}
return
true
;
}
void
TextureSourceProvider
:
:
FlushPendingNotifyNotUsed
(
)
{
for
(
auto
&
textureHost
:
mNotifyNotUsedAfterComposition
)
{
textureHost
-
>
CallNotifyNotUsed
(
)
;
}
mNotifyNotUsedAfterComposition
.
Clear
(
)
;
}
void
TextureSourceProvider
:
:
Destroy
(
)
{
ReadUnlockTextures
(
)
;
FlushPendingNotifyNotUsed
(
)
;
}
}
}
