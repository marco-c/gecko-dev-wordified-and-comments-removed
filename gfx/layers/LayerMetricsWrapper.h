#
ifndef
GFX_LAYERMETRICSWRAPPER_H
#
define
GFX_LAYERMETRICSWRAPPER_H
#
include
"
Layers
.
h
"
#
include
"
UnitTransforms
.
h
"
namespace
mozilla
{
namespace
layers
{
class
MOZ_STACK_CLASS
LayerMetricsWrapper
{
public
:
enum
StartAt
{
TOP
BOTTOM
}
;
LayerMetricsWrapper
(
)
:
mLayer
(
nullptr
)
mIndex
(
0
)
{
}
explicit
LayerMetricsWrapper
(
Layer
*
aRoot
StartAt
aStart
=
StartAt
:
:
TOP
)
:
mLayer
(
aRoot
)
mIndex
(
0
)
{
if
(
!
mLayer
)
{
return
;
}
switch
(
aStart
)
{
case
StartAt
:
:
TOP
:
mIndex
=
mLayer
-
>
GetScrollMetadataCount
(
)
;
if
(
mIndex
>
0
)
{
mIndex
-
-
;
}
break
;
case
StartAt
:
:
BOTTOM
:
mIndex
=
0
;
break
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Unknown
startAt
value
"
)
;
break
;
}
}
explicit
LayerMetricsWrapper
(
Layer
*
aLayer
uint32_t
aMetricsIndex
)
:
mLayer
(
aLayer
)
mIndex
(
aMetricsIndex
)
{
MOZ_ASSERT
(
mLayer
)
;
MOZ_ASSERT
(
mIndex
=
=
0
|
|
mIndex
<
mLayer
-
>
GetScrollMetadataCount
(
)
)
;
}
bool
IsValid
(
)
const
{
return
mLayer
!
=
nullptr
;
}
explicit
operator
bool
(
)
const
{
return
IsValid
(
)
;
}
LayerMetricsWrapper
GetParent
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
!
AtTopLayer
(
)
)
{
return
LayerMetricsWrapper
(
mLayer
mIndex
+
1
)
;
}
if
(
mLayer
-
>
GetParent
(
)
)
{
return
LayerMetricsWrapper
(
mLayer
-
>
GetParent
(
)
StartAt
:
:
BOTTOM
)
;
}
return
LayerMetricsWrapper
(
nullptr
)
;
}
LayerMetricsWrapper
GetFirstChild
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
!
AtBottomLayer
(
)
)
{
return
LayerMetricsWrapper
(
mLayer
mIndex
-
1
)
;
}
return
LayerMetricsWrapper
(
mLayer
-
>
GetFirstChild
(
)
)
;
}
LayerMetricsWrapper
GetLastChild
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
!
AtBottomLayer
(
)
)
{
return
LayerMetricsWrapper
(
mLayer
mIndex
-
1
)
;
}
return
LayerMetricsWrapper
(
mLayer
-
>
GetLastChild
(
)
)
;
}
LayerMetricsWrapper
GetPrevSibling
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtTopLayer
(
)
)
{
return
LayerMetricsWrapper
(
mLayer
-
>
GetPrevSibling
(
)
)
;
}
return
LayerMetricsWrapper
(
nullptr
)
;
}
LayerMetricsWrapper
GetNextSibling
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtTopLayer
(
)
)
{
return
LayerMetricsWrapper
(
mLayer
-
>
GetNextSibling
(
)
)
;
}
return
LayerMetricsWrapper
(
nullptr
)
;
}
const
ScrollMetadata
&
Metadata
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
mIndex
>
=
mLayer
-
>
GetScrollMetadataCount
(
)
)
{
return
*
ScrollMetadata
:
:
sNullMetadata
;
}
return
mLayer
-
>
GetScrollMetadata
(
mIndex
)
;
}
const
FrameMetrics
&
Metrics
(
)
const
{
return
Metadata
(
)
.
GetMetrics
(
)
;
}
AsyncPanZoomController
*
GetApzc
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
mIndex
>
=
mLayer
-
>
GetScrollMetadataCount
(
)
)
{
return
nullptr
;
}
return
mLayer
-
>
GetAsyncPanZoomController
(
mIndex
)
;
}
void
SetApzc
(
AsyncPanZoomController
*
aApzc
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
mLayer
-
>
GetScrollMetadataCount
(
)
=
=
0
)
{
MOZ_ASSERT
(
mIndex
=
=
0
)
;
MOZ_ASSERT
(
aApzc
=
=
nullptr
)
;
return
;
}
MOZ_ASSERT
(
mIndex
<
mLayer
-
>
GetScrollMetadataCount
(
)
)
;
mLayer
-
>
SetAsyncPanZoomController
(
mIndex
aApzc
)
;
}
const
char
*
Name
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
Name
(
)
;
}
return
"
DummyContainerLayer
"
;
}
LayerManager
*
Manager
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
Manager
(
)
;
}
gfx
:
:
Matrix4x4
GetTransform
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetTransform
(
)
;
}
return
gfx
:
:
Matrix4x4
(
)
;
}
CSSTransformMatrix
GetTransformTyped
(
)
const
{
return
ViewAs
<
CSSTransformMatrix
>
(
GetTransform
(
)
)
;
}
bool
TransformIsPerspective
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetTransformIsPerspective
(
)
;
}
return
false
;
}
EventRegions
GetEventRegions
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetEventRegions
(
)
;
}
return
EventRegions
(
)
;
}
LayerIntRegion
GetVisibleRegion
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
GetVisibleRegion
(
)
;
}
return
ViewAs
<
LayerPixel
>
(
TransformBy
(
mLayer
-
>
GetTransformTyped
(
)
mLayer
-
>
GetVisibleRegion
(
)
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
}
bool
HasTransformAnimation
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
HasTransformAnimation
(
)
;
}
return
false
;
}
RefLayer
*
AsRefLayer
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
AsRefLayer
(
)
;
}
return
nullptr
;
}
Maybe
<
LayersId
>
GetReferentId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtBottomLayer
(
)
)
{
return
mLayer
-
>
AsRefLayer
(
)
?
Some
(
mLayer
-
>
AsRefLayer
(
)
-
>
GetReferentId
(
)
)
:
Nothing
(
)
;
}
return
Nothing
(
)
;
}
Maybe
<
ParentLayerIntRect
>
GetClipRect
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
Maybe
<
ParentLayerIntRect
>
result
;
if
(
AtBottomLayer
(
)
)
{
result
=
mLayer
-
>
GetClipRect
(
)
;
result
=
IntersectMaybeRects
(
result
mLayer
-
>
GetScrolledClipRect
(
)
)
;
}
result
=
IntersectMaybeRects
(
result
Metadata
(
)
.
GetClipRect
(
)
)
;
return
result
;
}
float
GetPresShellResolution
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
AtTopLayer
(
)
&
&
mLayer
-
>
AsContainerLayer
(
)
)
{
return
mLayer
-
>
AsContainerLayer
(
)
-
>
GetPresShellResolution
(
)
;
}
return
1
.
0f
;
}
EventRegionsOverride
GetEventRegionsOverride
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
if
(
mLayer
-
>
AsRefLayer
(
)
)
{
return
mLayer
-
>
AsRefLayer
(
)
-
>
GetEventRegionsOverride
(
)
;
}
return
EventRegionsOverride
:
:
NoOverride
;
}
const
ScrollbarData
&
GetScrollbarData
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
GetScrollbarData
(
)
;
}
Maybe
<
uint64_t
>
GetScrollbarAnimationId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
Nothing
(
)
;
}
ScrollableLayerGuid
:
:
ViewID
GetFixedPositionScrollContainerId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
GetFixedPositionScrollContainerId
(
)
;
}
Maybe
<
uint64_t
>
GetZoomAnimationId
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
Nothing
(
)
;
}
bool
IsBackfaceHidden
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
mLayer
-
>
IsBackfaceHidden
(
)
;
}
Maybe
<
ScrollableLayerGuid
:
:
ViewID
>
IsAsyncZoomContainer
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
Maybe
<
ScrollableLayerGuid
:
:
ViewID
>
result
=
mLayer
-
>
IsAsyncZoomContainer
(
)
;
MOZ_ASSERT
(
result
.
isNothing
(
)
|
|
mLayer
-
>
GetScrollMetadataCount
(
)
=
=
0
)
;
return
result
;
}
const
void
*
GetLayer
(
)
const
{
MOZ_ASSERT
(
IsValid
(
)
)
;
return
(
void
*
)
mLayer
;
}
bool
operator
=
=
(
const
LayerMetricsWrapper
&
aOther
)
const
{
return
mLayer
=
=
aOther
.
mLayer
&
&
mIndex
=
=
aOther
.
mIndex
;
}
bool
operator
!
=
(
const
LayerMetricsWrapper
&
aOther
)
const
{
return
!
(
*
this
=
=
aOther
)
;
}
private
:
bool
AtBottomLayer
(
)
const
{
return
mIndex
=
=
0
;
}
bool
AtTopLayer
(
)
const
{
return
mLayer
-
>
GetScrollMetadataCount
(
)
=
=
0
|
|
mIndex
=
=
mLayer
-
>
GetScrollMetadataCount
(
)
-
1
;
}
private
:
Layer
*
mLayer
;
uint32_t
mIndex
;
}
;
}
}
#
endif
