#
include
"
mozilla
/
layers
/
APZSampler
.
h
"
#
include
"
APZCTreeManager
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
layers
/
APZThreadUtils
.
h
"
#
include
"
mozilla
/
layers
/
APZUtils
.
h
"
#
include
"
mozilla
/
layers
/
CompositorThread
.
h
"
#
include
"
mozilla
/
layers
/
LayerMetricsWrapper
.
h
"
#
include
"
mozilla
/
layers
/
SynchronousTask
.
h
"
#
include
"
TreeTraversal
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderAPI
.
h
"
namespace
mozilla
{
namespace
layers
{
StaticMutex
APZSampler
:
:
sWindowIdLock
;
StaticAutoPtr
<
std
:
:
unordered_map
<
uint64_t
RefPtr
<
APZSampler
>
>
>
APZSampler
:
:
sWindowIdMap
;
APZSampler
:
:
APZSampler
(
const
RefPtr
<
APZCTreeManager
>
&
aApz
bool
aIsUsingWebRender
)
:
mApz
(
aApz
)
mIsUsingWebRender
(
aIsUsingWebRender
)
mThreadIdLock
(
"
APZSampler
:
:
mThreadIdLock
"
)
mSampleTimeLock
(
"
APZSampler
:
:
mSampleTimeLock
"
)
{
MOZ_ASSERT
(
aApz
)
;
mApz
-
>
SetSampler
(
this
)
;
}
APZSampler
:
:
~
APZSampler
(
)
{
mApz
-
>
SetSampler
(
nullptr
)
;
}
void
APZSampler
:
:
Destroy
(
)
{
StaticMutexAutoLock
lock
(
sWindowIdLock
)
;
if
(
mWindowId
)
{
MOZ_ASSERT
(
sWindowIdMap
)
;
sWindowIdMap
-
>
erase
(
wr
:
:
AsUint64
(
*
mWindowId
)
)
;
}
}
void
APZSampler
:
:
SetWebRenderWindowId
(
const
wr
:
:
WindowId
&
aWindowId
)
{
StaticMutexAutoLock
lock
(
sWindowIdLock
)
;
MOZ_ASSERT
(
!
mWindowId
)
;
mWindowId
=
Some
(
aWindowId
)
;
if
(
!
sWindowIdMap
)
{
sWindowIdMap
=
new
std
:
:
unordered_map
<
uint64_t
RefPtr
<
APZSampler
>
>
(
)
;
NS_DispatchToMainThread
(
NS_NewRunnableFunction
(
"
APZUpdater
:
:
ClearOnShutdown
"
[
]
{
ClearOnShutdown
(
&
sWindowIdMap
)
;
}
)
)
;
}
(
*
sWindowIdMap
)
[
wr
:
:
AsUint64
(
aWindowId
)
]
=
this
;
}
void
APZSampler
:
:
SetSamplerThread
(
const
wr
:
:
WrWindowId
&
aWindowId
)
{
if
(
RefPtr
<
APZSampler
>
sampler
=
GetSampler
(
aWindowId
)
)
{
MutexAutoLock
lock
(
sampler
-
>
mThreadIdLock
)
;
sampler
-
>
mSamplerThreadId
=
Some
(
PlatformThread
:
:
CurrentId
(
)
)
;
}
}
void
APZSampler
:
:
SampleForWebRender
(
const
wr
:
:
WrWindowId
&
aWindowId
wr
:
:
Transaction
*
aTransaction
const
wr
:
:
DocumentId
&
aRenderRootId
)
{
if
(
RefPtr
<
APZSampler
>
sampler
=
GetSampler
(
aWindowId
)
)
{
wr
:
:
TransactionWrapper
txn
(
aTransaction
)
;
sampler
-
>
SampleForWebRender
(
txn
wr
:
:
RenderRootFromId
(
aRenderRootId
)
)
;
}
}
void
APZSampler
:
:
SetSampleTime
(
const
TimeStamp
&
aSampleTime
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
MutexAutoLock
lock
(
mSampleTimeLock
)
;
mSampleTime
=
aSampleTime
;
}
void
APZSampler
:
:
SampleForWebRender
(
wr
:
:
TransactionWrapper
&
aTxn
wr
:
:
RenderRoot
aRenderRoot
)
{
AssertOnSamplerThread
(
)
;
TimeStamp
sampleTime
;
{
MutexAutoLock
lock
(
mSampleTimeLock
)
;
sampleTime
=
mSampleTime
.
IsNull
(
)
?
TimeStamp
:
:
Now
(
)
:
mSampleTime
;
}
mApz
-
>
SampleForWebRender
(
aTxn
sampleTime
aRenderRoot
)
;
}
bool
APZSampler
:
:
SampleAnimations
(
const
LayerMetricsWrapper
&
aLayer
const
TimeStamp
&
aSampleTime
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
bool
activeAnimations
=
false
;
ForEachNodePostOrder
<
ForwardIterator
>
(
aLayer
[
&
activeAnimations
&
aSampleTime
]
(
LayerMetricsWrapper
aLayerMetrics
)
{
if
(
AsyncPanZoomController
*
apzc
=
aLayerMetrics
.
GetApzc
(
)
)
{
apzc
-
>
ReportCheckerboard
(
aSampleTime
)
;
activeAnimations
|
=
apzc
-
>
AdvanceAnimations
(
aSampleTime
)
;
}
}
)
;
return
activeAnimations
;
}
LayerToParentLayerMatrix4x4
APZSampler
:
:
ComputeTransformForScrollThumb
(
const
LayerToParentLayerMatrix4x4
&
aCurrentTransform
const
LayerMetricsWrapper
&
aContent
const
ScrollbarData
&
aThumbData
bool
aScrollbarIsDescendant
AsyncTransformComponentMatrix
*
aOutClipTransform
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
return
mApz
-
>
ComputeTransformForScrollThumb
(
aCurrentTransform
aContent
.
GetTransform
(
)
aContent
.
GetApzc
(
)
aContent
.
Metrics
(
)
aThumbData
aScrollbarIsDescendant
aOutClipTransform
)
;
}
CSSRect
APZSampler
:
:
GetCurrentAsyncLayoutViewport
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
return
aLayer
.
GetApzc
(
)
-
>
GetCurrentAsyncLayoutViewport
(
AsyncPanZoomController
:
:
eForCompositing
)
;
}
ParentLayerPoint
APZSampler
:
:
GetCurrentAsyncScrollOffset
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
return
aLayer
.
GetApzc
(
)
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForCompositing
)
;
}
AsyncTransform
APZSampler
:
:
GetCurrentAsyncTransform
(
const
LayerMetricsWrapper
&
aLayer
AsyncTransformComponents
aComponents
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
return
aLayer
.
GetApzc
(
)
-
>
GetCurrentAsyncTransform
(
AsyncPanZoomController
:
:
eForCompositing
aComponents
)
;
}
Maybe
<
CompositionPayload
>
APZSampler
:
:
NotifyScrollSampling
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
return
aLayer
.
GetApzc
(
)
-
>
NotifyScrollSampling
(
)
;
}
AsyncTransformComponentMatrix
APZSampler
:
:
GetOverscrollTransform
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
return
aLayer
.
GetApzc
(
)
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForCompositing
)
;
}
AsyncTransformComponentMatrix
APZSampler
:
:
GetCurrentAsyncTransformWithOverscroll
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
return
aLayer
.
GetApzc
(
)
-
>
GetCurrentAsyncTransformWithOverscroll
(
AsyncPanZoomController
:
:
eForCompositing
)
;
}
void
APZSampler
:
:
MarkAsyncTransformAppliedToContent
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
aLayer
.
GetApzc
(
)
-
>
MarkAsyncTransformAppliedToContent
(
)
;
}
bool
APZSampler
:
:
HasUnusedAsyncTransform
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
AsyncPanZoomController
*
apzc
=
aLayer
.
GetApzc
(
)
;
return
apzc
&
&
!
apzc
-
>
GetAsyncTransformAppliedToContent
(
)
&
&
!
AsyncTransformComponentMatrix
(
apzc
-
>
GetCurrentAsyncTransform
(
AsyncPanZoomController
:
:
eForCompositing
)
)
.
IsIdentity
(
)
;
}
ScrollableLayerGuid
APZSampler
:
:
GetGuid
(
const
LayerMetricsWrapper
&
aLayer
)
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
MOZ_ASSERT
(
aLayer
.
GetApzc
(
)
)
;
return
aLayer
.
GetApzc
(
)
-
>
GetGuid
(
)
;
}
ScreenMargin
APZSampler
:
:
GetGeckoFixedLayerMargins
(
)
const
{
MOZ_ASSERT
(
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
)
;
AssertOnSamplerThread
(
)
;
return
mApz
-
>
GetGeckoFixedLayerMargins
(
)
;
}
void
APZSampler
:
:
AssertOnSamplerThread
(
)
const
{
if
(
APZThreadUtils
:
:
GetThreadAssertionsEnabled
(
)
)
{
MOZ_ASSERT
(
IsSamplerThread
(
)
)
;
}
}
bool
APZSampler
:
:
IsSamplerThread
(
)
const
{
if
(
mIsUsingWebRender
)
{
MutexAutoLock
lock
(
mThreadIdLock
)
;
return
mSamplerThreadId
&
&
PlatformThread
:
:
CurrentId
(
)
=
=
*
mSamplerThreadId
;
}
return
CompositorThreadHolder
:
:
IsInCompositorThread
(
)
;
}
already_AddRefed
<
APZSampler
>
APZSampler
:
:
GetSampler
(
const
wr
:
:
WrWindowId
&
aWindowId
)
{
RefPtr
<
APZSampler
>
sampler
;
StaticMutexAutoLock
lock
(
sWindowIdLock
)
;
if
(
sWindowIdMap
)
{
auto
it
=
sWindowIdMap
-
>
find
(
wr
:
:
AsUint64
(
aWindowId
)
)
;
if
(
it
!
=
sWindowIdMap
-
>
end
(
)
)
{
sampler
=
it
-
>
second
;
}
}
return
sampler
.
forget
(
)
;
}
}
}
void
apz_register_sampler
(
mozilla
:
:
wr
:
:
WrWindowId
aWindowId
)
{
mozilla
:
:
layers
:
:
APZSampler
:
:
SetSamplerThread
(
aWindowId
)
;
}
void
apz_sample_transforms
(
mozilla
:
:
wr
:
:
WrWindowId
aWindowId
mozilla
:
:
wr
:
:
Transaction
*
aTransaction
mozilla
:
:
wr
:
:
DocumentId
aDocumentId
)
{
mozilla
:
:
layers
:
:
APZSampler
:
:
SampleForWebRender
(
aWindowId
aTransaction
aDocumentId
)
;
}
void
apz_deregister_sampler
(
mozilla
:
:
wr
:
:
WrWindowId
aWindowId
)
{
}
