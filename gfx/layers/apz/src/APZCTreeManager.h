#
ifndef
mozilla_layers_APZCTreeManager_h
#
define
mozilla_layers_APZCTreeManager_h
#
include
<
unordered_map
>
#
include
"
gfxPoint
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
gfx
/
Matrix
.
h
"
#
include
"
mozilla
/
layers
/
TouchCounter
.
h
"
#
include
"
mozilla
/
layers
/
IAPZCTreeManager
.
h
"
#
include
"
mozilla
/
layers
/
KeyboardMap
.
h
"
#
include
"
mozilla
/
layers
/
FocusState
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
if
defined
(
MOZ_WIDGET_ANDROID
)
#
include
"
mozilla
/
layers
/
AndroidDynamicToolbarAnimator
.
h
"
#
endif
namespace
mozilla
{
class
MultiTouchInput
;
namespace
wr
{
class
WebRenderAPI
;
struct
WrTransformProperty
;
}
namespace
layers
{
class
Layer
;
class
AsyncPanZoomController
;
class
APZCTreeManagerParent
;
class
CompositorBridgeParent
;
class
OverscrollHandoffChain
;
struct
OverscrollHandoffState
;
class
FocusTarget
;
struct
FlingHandoffState
;
struct
ScrollableLayerGuidHash
;
class
LayerMetricsWrapper
;
class
InputQueue
;
class
GeckoContentController
;
class
HitTestingTreeNode
;
class
WebRenderScrollData
;
class
APZCTreeManager
:
public
IAPZCTreeManager
{
typedef
mozilla
:
:
layers
:
:
AllowedTouchBehavior
AllowedTouchBehavior
;
typedef
mozilla
:
:
layers
:
:
AsyncDragMetrics
AsyncDragMetrics
;
struct
TreeBuildingState
;
public
:
APZCTreeManager
(
)
;
static
void
InitializeGlobalState
(
)
;
void
UpdateFocusState
(
uint64_t
aRootLayerTreeId
uint64_t
aOriginatingLayersId
const
FocusTarget
&
aFocusTarget
)
;
void
UpdateHitTestingTree
(
uint64_t
aRootLayerTreeId
Layer
*
aRoot
bool
aIsFirstPaint
uint64_t
aOriginatingLayersId
uint32_t
aPaintSequenceNumber
)
;
void
UpdateHitTestingTree
(
uint64_t
aRootLayerTreeId
const
WebRenderScrollData
&
aScrollData
bool
aIsFirstPaint
uint64_t
aOriginatingLayersId
uint32_t
aPaintSequenceNumber
)
;
bool
PushStateToWR
(
wr
:
:
WebRenderAPI
*
aWrApi
const
TimeStamp
&
aSampleTime
nsTArray
<
wr
:
:
WrTransformProperty
>
&
aTransformArray
)
;
void
FlushApzRepaints
(
uint64_t
aLayersId
)
;
nsEventStatus
ReceiveInputEvent
(
InputData
&
aEvent
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
override
;
void
SetKeyboardMap
(
const
KeyboardMap
&
aKeyboardMap
)
override
;
void
ZoomToRect
(
const
ScrollableLayerGuid
&
aGuid
const
CSSRect
&
aRect
const
uint32_t
aFlags
=
DEFAULT_BEHAVIOR
)
override
;
void
ContentReceivedInputBlock
(
uint64_t
aInputBlockId
bool
aPreventDefault
)
override
;
void
SetTargetAPZC
(
uint64_t
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
)
override
;
void
SetTargetAPZC
(
uint64_t
aInputBlockId
const
ScrollableLayerGuid
&
aTarget
)
;
void
UpdateZoomConstraints
(
const
ScrollableLayerGuid
&
aGuid
const
Maybe
<
ZoomConstraints
>
&
aConstraints
)
override
;
void
CancelAnimation
(
const
ScrollableLayerGuid
&
aGuid
)
;
void
AdjustScrollForSurfaceShift
(
const
ScreenPoint
&
aShift
)
;
void
ClearTree
(
)
;
bool
HitTestAPZC
(
const
ScreenIntPoint
&
aPoint
)
;
static
const
ScreenMargin
CalculatePendingDisplayPort
(
const
FrameMetrics
&
aFrameMetrics
const
ParentLayerPoint
&
aVelocity
)
;
void
SetDPI
(
float
aDpiValue
)
override
{
sDPI
=
aDpiValue
;
}
static
float
GetDPI
(
)
{
return
sDPI
;
}
RefPtr
<
HitTestingTreeNode
>
FindScrollThumbNode
(
const
AsyncDragMetrics
&
aDragMetrics
)
;
void
SetAllowedTouchBehavior
(
uint64_t
aInputBlockId
const
nsTArray
<
TouchBehaviorFlags
>
&
aValues
)
override
;
void
DispatchScroll
(
AsyncPanZoomController
*
aApzc
ParentLayerPoint
&
aStartPoint
ParentLayerPoint
&
aEndPoint
OverscrollHandoffState
&
aOverscrollHandoffState
)
;
void
DispatchFling
(
AsyncPanZoomController
*
aApzc
FlingHandoffState
&
aHandoffState
)
;
void
StartScrollbarDrag
(
const
ScrollableLayerGuid
&
aGuid
const
AsyncDragMetrics
&
aDragMetrics
)
override
;
bool
StartAutoscroll
(
const
ScrollableLayerGuid
&
aGuid
const
ScreenPoint
&
aAnchorLocation
)
override
;
void
StopAutoscroll
(
const
ScrollableLayerGuid
&
aGuid
)
override
;
RefPtr
<
const
OverscrollHandoffChain
>
BuildOverscrollHandoffChain
(
const
RefPtr
<
AsyncPanZoomController
>
&
aInitialTarget
)
;
void
SetLongTapEnabled
(
bool
aTapGestureEnabled
)
override
;
void
ProcessUnhandledEvent
(
LayoutDeviceIntPoint
*
aRefPoint
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutFocusSequenceNumber
)
override
;
void
UpdateWheelTransaction
(
LayoutDeviceIntPoint
aRefPoint
EventMessage
aEventMessage
)
override
;
protected
:
virtual
~
APZCTreeManager
(
)
;
virtual
AsyncPanZoomController
*
NewAPZCInstance
(
uint64_t
aLayersId
GeckoContentController
*
aController
)
;
public
:
virtual
TimeStamp
GetFrameTime
(
)
;
public
:
RefPtr
<
HitTestingTreeNode
>
GetRootNode
(
)
const
;
already_AddRefed
<
AsyncPanZoomController
>
GetTargetAPZC
(
const
ScreenPoint
&
aPoint
HitTestResult
*
aOutHitResult
RefPtr
<
HitTestingTreeNode
>
*
aOutScrollbarNode
=
nullptr
)
;
already_AddRefed
<
AsyncPanZoomController
>
GetTargetAPZC
(
const
uint64_t
&
aLayersId
const
FrameMetrics
:
:
ViewID
&
aScrollId
)
;
ScreenToParentLayerMatrix4x4
GetScreenToApzcTransform
(
const
AsyncPanZoomController
*
aApzc
)
const
;
ParentLayerToScreenMatrix4x4
GetApzcToGeckoTransform
(
const
AsyncPanZoomController
*
aApzc
)
const
;
ScreenPoint
GetCurrentMousePosition
(
)
const
;
void
ProcessTouchVelocity
(
uint32_t
aTimestampMs
float
aSpeedY
)
override
;
private
:
typedef
bool
(
*
GuidComparator
)
(
const
ScrollableLayerGuid
&
const
ScrollableLayerGuid
&
)
;
template
<
class
ScrollNode
>
void
UpdateHitTestingTreeImpl
(
uint64_t
aRootLayerTreeId
const
ScrollNode
&
aRoot
bool
aIsFirstPaint
uint64_t
aOriginatingLayersId
uint32_t
aPaintSequenceNumber
)
;
void
AttachNodeToTree
(
HitTestingTreeNode
*
aNode
HitTestingTreeNode
*
aParent
HitTestingTreeNode
*
aNextSibling
)
;
already_AddRefed
<
AsyncPanZoomController
>
GetTargetAPZC
(
const
ScrollableLayerGuid
&
aGuid
)
;
already_AddRefed
<
HitTestingTreeNode
>
GetTargetNode
(
const
ScrollableLayerGuid
&
aGuid
GuidComparator
aComparator
)
const
;
HitTestingTreeNode
*
FindTargetNode
(
HitTestingTreeNode
*
aNode
const
ScrollableLayerGuid
&
aGuid
GuidComparator
aComparator
)
;
AsyncPanZoomController
*
GetTargetApzcForNode
(
HitTestingTreeNode
*
aNode
)
;
AsyncPanZoomController
*
GetAPZCAtPoint
(
HitTestingTreeNode
*
aNode
const
ParentLayerPoint
&
aHitTestPoint
HitTestResult
*
aOutHitResult
HitTestingTreeNode
*
*
aOutScrollbarNode
)
;
AsyncPanZoomController
*
FindRootApzcForLayersId
(
uint64_t
aLayersId
)
const
;
AsyncPanZoomController
*
FindRootContentApzcForLayersId
(
uint64_t
aLayersId
)
const
;
AsyncPanZoomController
*
FindRootContentOrRootApzc
(
)
const
;
already_AddRefed
<
AsyncPanZoomController
>
GetMultitouchTarget
(
AsyncPanZoomController
*
aApzc1
AsyncPanZoomController
*
aApzc2
)
const
;
already_AddRefed
<
AsyncPanZoomController
>
CommonAncestor
(
AsyncPanZoomController
*
aApzc1
AsyncPanZoomController
*
aApzc2
)
const
;
already_AddRefed
<
AsyncPanZoomController
>
GetTouchInputBlockAPZC
(
const
MultiTouchInput
&
aEvent
nsTArray
<
TouchBehaviorFlags
>
*
aOutTouchBehaviors
HitTestResult
*
aOutHitResult
RefPtr
<
HitTestingTreeNode
>
*
aOutHitScrollbarNode
)
;
nsEventStatus
ProcessTouchInput
(
MultiTouchInput
&
aInput
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
;
void
SetupScrollbarDrag
(
MouseInput
&
aMouseInput
const
HitTestingTreeNode
*
aScrollThumbNode
AsyncPanZoomController
*
aApzc
)
;
nsEventStatus
ProcessTouchInputForScrollbarDrag
(
MultiTouchInput
&
aInput
const
HitTestingTreeNode
*
aScrollThumbNode
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
;
void
FlushRepaintsToClearScreenToGeckoTransform
(
)
;
already_AddRefed
<
HitTestingTreeNode
>
RecycleOrCreateNode
(
TreeBuildingState
&
aState
AsyncPanZoomController
*
aApzc
uint64_t
aLayersId
)
;
template
<
class
ScrollNode
>
HitTestingTreeNode
*
PrepareNodeForLayer
(
const
ScrollNode
&
aLayer
const
FrameMetrics
&
aMetrics
uint64_t
aLayersId
const
gfx
:
:
Matrix4x4
&
aAncestorTransform
HitTestingTreeNode
*
aParent
HitTestingTreeNode
*
aNextSibling
TreeBuildingState
&
aState
)
;
template
<
class
ScrollNode
>
void
PrintAPZCInfo
(
const
ScrollNode
&
aLayer
const
AsyncPanZoomController
*
apzc
)
;
void
NotifyScrollbarDragRejected
(
const
ScrollableLayerGuid
&
aGuid
)
const
;
void
NotifyAutoscrollRejected
(
const
ScrollableLayerGuid
&
aGuid
)
const
;
LayerToParentLayerMatrix4x4
ComputeTransformForNode
(
const
HitTestingTreeNode
*
aNode
)
const
;
protected
:
RefPtr
<
InputQueue
>
mInputQueue
;
private
:
mutable
mozilla
:
:
Mutex
mTreeLock
;
RefPtr
<
HitTestingTreeNode
>
mRootNode
;
std
:
:
unordered_map
<
ScrollableLayerGuid
ZoomConstraints
ScrollableLayerGuidHash
>
mZoomConstraints
;
KeyboardMap
mKeyboardMap
;
FocusState
mFocusState
;
RefPtr
<
AsyncPanZoomController
>
mApzcForInputBlock
;
HitTestResult
mHitResultForInputBlock
;
int32_t
mRetainedTouchIdentifier
;
bool
mInScrollbarTouchDrag
;
TouchCounter
mTouchCounter
;
ScreenPoint
mCurrentMousePosition
;
gfx
:
:
TreeLog
mApzcTreeLog
;
class
CheckerboardFlushObserver
;
friend
class
CheckerboardFlushObserver
;
RefPtr
<
CheckerboardFlushObserver
>
mFlushObserver
;
static
float
sDPI
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
public
:
void
InitializeDynamicToolbarAnimator
(
const
int64_t
&
aRootLayerTreeId
)
;
AndroidDynamicToolbarAnimator
*
GetAndroidDynamicToolbarAnimator
(
)
;
private
:
RefPtr
<
AndroidDynamicToolbarAnimator
>
mToolbarAnimator
;
#
endif
}
;
}
}
#
endif
