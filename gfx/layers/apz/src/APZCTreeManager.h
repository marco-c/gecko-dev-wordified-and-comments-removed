#
ifndef
mozilla_layers_APZCTreeManager_h
#
define
mozilla_layers_APZCTreeManager_h
#
include
<
unordered_map
>
#
include
"
FocusState
.
h
"
#
include
"
HitTestingTreeNode
.
h
"
#
include
"
gfxPoint
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
gfx
/
CompositorHitTestInfo
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
gfx
/
Matrix
.
h
"
#
include
"
mozilla
/
layers
/
APZInputBridge
.
h
"
#
include
"
mozilla
/
layers
/
APZTestData
.
h
"
#
include
"
mozilla
/
layers
/
IAPZCTreeManager
.
h
"
#
include
"
mozilla
/
layers
/
LayerAttributes
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
#
include
"
mozilla
/
layers
/
KeyboardMap
.
h
"
#
include
"
mozilla
/
layers
/
TouchCounter
.
h
"
#
include
"
mozilla
/
layers
/
ZoomConstraints
.
h
"
#
include
"
mozilla
/
RecursiveMutex
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
if
defined
(
MOZ_WIDGET_ANDROID
)
#
include
"
mozilla
/
layers
/
AndroidDynamicToolbarAnimator
.
h
"
#
endif
namespace
mozilla
{
class
MultiTouchInput
;
namespace
wr
{
class
TransactionWrapper
;
class
WebRenderAPI
;
struct
WrTransformProperty
;
}
namespace
layers
{
class
Layer
;
class
AsyncPanZoomController
;
class
APZCTreeManagerParent
;
class
APZSampler
;
class
APZUpdater
;
class
CompositorBridgeParent
;
class
OverscrollHandoffChain
;
struct
OverscrollHandoffState
;
class
FocusTarget
;
struct
FlingHandoffState
;
class
LayerMetricsWrapper
;
class
InputQueue
;
class
GeckoContentController
;
class
HitTestingTreeNode
;
class
HitTestingTreeNodeAutoLock
;
class
WebRenderScrollDataWrapper
;
struct
AncestorTransform
;
struct
ScrollThumbData
;
class
APZCTreeManager
:
public
IAPZCTreeManager
public
APZInputBridge
{
typedef
mozilla
:
:
layers
:
:
AllowedTouchBehavior
AllowedTouchBehavior
;
typedef
mozilla
:
:
layers
:
:
AsyncDragMetrics
AsyncDragMetrics
;
struct
TreeBuildingState
;
public
:
explicit
APZCTreeManager
(
LayersId
aRootLayersId
)
;
void
SetSampler
(
APZSampler
*
aSampler
)
;
void
SetUpdater
(
APZUpdater
*
aUpdater
)
;
void
NotifyLayerTreeAdopted
(
LayersId
aLayersId
const
RefPtr
<
APZCTreeManager
>
&
aOldTreeManager
)
;
void
NotifyLayerTreeRemoved
(
LayersId
aLayersId
)
;
void
UpdateFocusState
(
LayersId
aRootLayerTreeId
LayersId
aOriginatingLayersId
const
FocusTarget
&
aFocusTarget
)
;
void
UpdateHitTestingTree
(
Layer
*
aRoot
bool
aIsFirstPaint
LayersId
aOriginatingLayersId
uint32_t
aPaintSequenceNumber
)
;
void
UpdateHitTestingTree
(
const
WebRenderScrollDataWrapper
&
aScrollWrapper
bool
aIsFirstPaint
WRRootId
aOriginatingWrRootId
uint32_t
aPaintSequenceNumber
)
;
void
SampleForWebRender
(
wr
:
:
TransactionWrapper
&
aTxn
const
TimeStamp
&
aSampleTime
wr
:
:
RenderRoot
aRenderRoot
)
;
APZEventResult
ReceiveInputEvent
(
InputData
&
aEvent
)
override
;
void
SetKeyboardMap
(
const
KeyboardMap
&
aKeyboardMap
)
override
;
void
ZoomToRect
(
const
SLGuidAndRenderRoot
&
aGuid
const
CSSRect
&
aRect
const
uint32_t
aFlags
=
DEFAULT_BEHAVIOR
)
override
;
void
ContentReceivedInputBlock
(
uint64_t
aInputBlockId
bool
aPreventDefault
)
override
;
void
SetTargetAPZC
(
uint64_t
aInputBlockId
const
nsTArray
<
SLGuidAndRenderRoot
>
&
aTargets
)
override
;
void
UpdateZoomConstraints
(
const
SLGuidAndRenderRoot
&
aGuid
const
Maybe
<
ZoomConstraints
>
&
aConstraints
)
override
;
void
AdjustScrollForSurfaceShift
(
const
ScreenPoint
&
aShift
)
;
void
ClearTree
(
)
;
void
SetDPI
(
float
aDpiValue
)
override
;
float
GetDPI
(
)
const
;
void
FindScrollThumbNode
(
const
AsyncDragMetrics
&
aDragMetrics
HitTestingTreeNodeAutoLock
&
aOutThumbNode
)
;
void
SetAllowedTouchBehavior
(
uint64_t
aInputBlockId
const
nsTArray
<
TouchBehaviorFlags
>
&
aValues
)
override
;
void
DispatchScroll
(
AsyncPanZoomController
*
aApzc
ParentLayerPoint
&
aStartPoint
ParentLayerPoint
&
aEndPoint
OverscrollHandoffState
&
aOverscrollHandoffState
)
;
ParentLayerPoint
DispatchFling
(
AsyncPanZoomController
*
aApzc
const
FlingHandoffState
&
aHandoffState
)
;
void
StartScrollbarDrag
(
const
SLGuidAndRenderRoot
&
aGuid
const
AsyncDragMetrics
&
aDragMetrics
)
override
;
bool
StartAutoscroll
(
const
SLGuidAndRenderRoot
&
aGuid
const
ScreenPoint
&
aAnchorLocation
)
override
;
void
StopAutoscroll
(
const
SLGuidAndRenderRoot
&
aGuid
)
override
;
RefPtr
<
const
OverscrollHandoffChain
>
BuildOverscrollHandoffChain
(
const
RefPtr
<
AsyncPanZoomController
>
&
aInitialTarget
)
;
void
SetLongTapEnabled
(
bool
aTapGestureEnabled
)
override
;
APZInputBridge
*
InputBridge
(
)
override
{
return
this
;
}
void
ProcessUnhandledEvent
(
LayoutDeviceIntPoint
*
aRefPoint
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutFocusSequenceNumber
LayersId
*
aOutLayersId
)
override
;
void
UpdateWheelTransaction
(
LayoutDeviceIntPoint
aRefPoint
EventMessage
aEventMessage
)
override
;
bool
GetAPZTestData
(
LayersId
aLayersId
APZTestData
*
aOutData
)
;
void
SendSubtreeTransformsToChromeMainThread
(
const
AsyncPanZoomController
*
aAncestor
)
;
void
SetFixedLayerMargins
(
ScreenIntCoord
aTop
ScreenIntCoord
aBottom
)
;
static
LayerToParentLayerMatrix4x4
ComputeTransformForScrollThumb
(
const
LayerToParentLayerMatrix4x4
&
aCurrentTransform
const
gfx
:
:
Matrix4x4
&
aScrollableContentTransform
AsyncPanZoomController
*
aApzc
const
FrameMetrics
&
aMetrics
const
ScrollbarData
&
aScrollbarData
bool
aScrollbarIsDescendant
AsyncTransformComponentMatrix
*
aOutClipTransform
)
;
static
void
FlushApzRepaints
(
LayersId
aLayersId
)
;
void
MarkAsDetached
(
LayersId
aLayersId
)
;
void
AssertOnSamplerThread
(
)
;
void
AssertOnUpdaterThread
(
)
;
already_AddRefed
<
wr
:
:
WebRenderAPI
>
GetWebRenderAPI
(
wr
:
:
RenderRoot
aRenderRoot
)
const
;
already_AddRefed
<
wr
:
:
WebRenderAPI
>
GetWebRenderAPIAtPoint
(
const
ScreenPoint
&
aPoint
)
const
;
protected
:
virtual
~
APZCTreeManager
(
)
;
APZSampler
*
GetSampler
(
)
const
;
APZUpdater
*
GetUpdater
(
)
const
;
private
:
friend
class
APZUpdater
;
void
LockTree
(
)
;
void
UnlockTree
(
)
;
virtual
AsyncPanZoomController
*
NewAPZCInstance
(
LayersId
aLayersId
GeckoContentController
*
aController
wr
:
:
RenderRoot
aRenderRoot
)
;
public
:
virtual
TimeStamp
GetFrameTime
(
)
;
void
SetTestSampleTime
(
const
Maybe
<
TimeStamp
>
&
aTime
)
;
private
:
Maybe
<
TimeStamp
>
mTestSampleTime
;
public
:
struct
HitTestResult
{
RefPtr
<
AsyncPanZoomController
>
mTargetApzc
;
gfx
:
:
CompositorHitTestInfo
mHitResult
;
LayersId
mLayersId
;
HitTestingTreeNodeAutoLock
mScrollbarNode
;
SideBits
mFixedPosSides
=
SideBits
:
:
eNone
;
HitTestResult
(
)
=
default
;
HitTestResult
(
HitTestResult
&
&
)
=
default
;
HitTestResult
&
operator
=
(
HitTestResult
&
&
)
=
default
;
}
;
RefPtr
<
HitTestingTreeNode
>
GetRootNode
(
)
const
;
HitTestResult
GetTargetAPZC
(
const
ScreenPoint
&
aPoint
)
;
already_AddRefed
<
AsyncPanZoomController
>
GetTargetAPZC
(
const
LayersId
&
aLayersId
const
ScrollableLayerGuid
:
:
ViewID
&
aScrollId
)
const
;
ScreenToParentLayerMatrix4x4
GetScreenToApzcTransform
(
const
AsyncPanZoomController
*
aApzc
)
const
;
ParentLayerToScreenMatrix4x4
GetApzcToGeckoTransform
(
const
AsyncPanZoomController
*
aApzc
)
const
;
ScreenPoint
GetCurrentMousePosition
(
)
const
;
Maybe
<
ScreenIntPoint
>
ConvertToGecko
(
const
ScreenIntPoint
&
aPoint
AsyncPanZoomController
*
aApzc
)
;
void
ProcessDynamicToolbarMovement
(
uint32_t
aStartTimestampMs
uint32_t
aEndTimestampMs
ScreenCoord
aDeltaY
)
;
already_AddRefed
<
AsyncPanZoomController
>
FindZoomableApzc
(
AsyncPanZoomController
*
aStart
)
const
;
ScreenMargin
GetGeckoFixedLayerMargins
(
)
const
;
private
:
typedef
bool
(
*
GuidComparator
)
(
const
ScrollableLayerGuid
&
const
ScrollableLayerGuid
&
)
;
template
<
class
ScrollNode
>
void
UpdateHitTestingTreeImpl
(
const
ScrollNode
&
aRoot
bool
aIsFirstPaint
WRRootId
aOriginatingWrRootId
uint32_t
aPaintSequenceNumber
)
;
void
AttachNodeToTree
(
HitTestingTreeNode
*
aNode
HitTestingTreeNode
*
aParent
HitTestingTreeNode
*
aNextSibling
)
;
already_AddRefed
<
AsyncPanZoomController
>
GetTargetAPZC
(
const
ScrollableLayerGuid
&
aGuid
)
;
already_AddRefed
<
HitTestingTreeNode
>
GetTargetNode
(
const
ScrollableLayerGuid
&
aGuid
GuidComparator
aComparator
)
const
;
HitTestingTreeNode
*
FindTargetNode
(
HitTestingTreeNode
*
aNode
const
ScrollableLayerGuid
&
aGuid
GuidComparator
aComparator
)
;
AsyncPanZoomController
*
GetTargetApzcForNode
(
HitTestingTreeNode
*
aNode
)
;
HitTestResult
GetAPZCAtPoint
(
const
ScreenPoint
&
aHitTestPoint
const
RecursiveMutexAutoLock
&
aProofOfTreeLock
)
;
HitTestResult
GetAPZCAtPointWR
(
const
ScreenPoint
&
aHitTestPoint
const
RecursiveMutexAutoLock
&
aProofOfTreeLock
)
;
AsyncPanZoomController
*
FindRootApzcForLayersId
(
LayersId
aLayersId
)
const
;
AsyncPanZoomController
*
FindRootContentApzcForLayersId
(
LayersId
aLayersId
)
const
;
AsyncPanZoomController
*
FindRootContentOrRootApzc
(
)
const
;
already_AddRefed
<
AsyncPanZoomController
>
GetZoomableTarget
(
AsyncPanZoomController
*
aApzc1
AsyncPanZoomController
*
aApzc2
)
const
;
already_AddRefed
<
AsyncPanZoomController
>
CommonAncestor
(
AsyncPanZoomController
*
aApzc1
AsyncPanZoomController
*
aApzc2
)
const
;
bool
IsFixedToRootContent
(
const
HitTestingTreeNode
*
aNode
)
const
;
HitTestResult
GetTouchInputBlockAPZC
(
const
MultiTouchInput
&
aEvent
nsTArray
<
TouchBehaviorFlags
>
*
aOutTouchBehaviors
)
;
APZEventResult
ProcessTouchInput
(
MultiTouchInput
&
aInput
)
;
void
SetupScrollbarDrag
(
MouseInput
&
aMouseInput
const
HitTestingTreeNodeAutoLock
&
aScrollThumbNode
AsyncPanZoomController
*
aApzc
)
;
APZEventResult
ProcessTouchInputForScrollbarDrag
(
MultiTouchInput
&
aInput
const
HitTestingTreeNodeAutoLock
&
aScrollThumbNode
)
;
void
FlushRepaintsToClearScreenToGeckoTransform
(
)
;
void
SynthesizePinchGestureFromMouseWheel
(
const
ScrollWheelInput
&
aWheelInput
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
)
;
already_AddRefed
<
HitTestingTreeNode
>
RecycleOrCreateNode
(
const
RecursiveMutexAutoLock
&
aProofOfTreeLock
TreeBuildingState
&
aState
AsyncPanZoomController
*
aApzc
LayersId
aLayersId
)
;
template
<
class
ScrollNode
>
HitTestingTreeNode
*
PrepareNodeForLayer
(
const
RecursiveMutexAutoLock
&
aProofOfTreeLock
const
ScrollNode
&
aLayer
const
FrameMetrics
&
aMetrics
LayersId
aLayersId
const
AncestorTransform
&
aAncestorTransform
HitTestingTreeNode
*
aParent
HitTestingTreeNode
*
aNextSibling
TreeBuildingState
&
aState
wr
:
:
RenderRoot
aRenderRoot
)
;
template
<
class
ScrollNode
>
Maybe
<
ParentLayerIntRegion
>
ComputeClipRegion
(
const
ScrollNode
&
aLayer
)
;
template
<
class
ScrollNode
>
void
PrintAPZCInfo
(
const
ScrollNode
&
aLayer
const
AsyncPanZoomController
*
apzc
)
;
void
NotifyScrollbarDragInitiated
(
uint64_t
aDragBlockId
const
ScrollableLayerGuid
&
aGuid
ScrollDirection
aDirection
)
const
;
void
NotifyScrollbarDragRejected
(
const
ScrollableLayerGuid
&
aGuid
)
const
;
void
NotifyAutoscrollRejected
(
const
ScrollableLayerGuid
&
aGuid
)
const
;
LayerToParentLayerMatrix4x4
ComputeTransformForNode
(
const
HitTestingTreeNode
*
aNode
)
const
;
static
already_AddRefed
<
GeckoContentController
>
GetContentController
(
LayersId
aLayersId
)
;
protected
:
RefPtr
<
InputQueue
>
mInputQueue
;
private
:
LayersId
mRootLayersId
;
APZSampler
*
MOZ_NON_OWNING_REF
mSampler
;
APZUpdater
*
MOZ_NON_OWNING_REF
mUpdater
;
mutable
mozilla
:
:
RecursiveMutex
mTreeLock
;
RefPtr
<
HitTestingTreeNode
>
mRootNode
;
std
:
:
unordered_set
<
LayersId
LayersId
:
:
HashFn
>
mDetachedLayersIds
;
bool
mUsingAsyncZoomContainer
;
mutable
mozilla
:
:
Mutex
mMapLock
;
std
:
:
unordered_map
<
ScrollableLayerGuid
RefPtr
<
AsyncPanZoomController
>
ScrollableLayerGuid
:
:
HashIgnoringPresShellFn
ScrollableLayerGuid
:
:
EqualIgnoringPresShellFn
>
mApzcMap
;
struct
ScrollThumbInfo
{
uint64_t
mThumbAnimationId
;
CSSTransformMatrix
mThumbTransform
;
ScrollbarData
mThumbData
;
ScrollableLayerGuid
mTargetGuid
;
CSSTransformMatrix
mTargetTransform
;
bool
mTargetIsAncestor
;
ScrollThumbInfo
(
const
uint64_t
&
aThumbAnimationId
const
CSSTransformMatrix
&
aThumbTransform
const
ScrollbarData
&
aThumbData
const
ScrollableLayerGuid
&
aTargetGuid
const
CSSTransformMatrix
&
aTargetTransform
bool
aTargetIsAncestor
)
:
mThumbAnimationId
(
aThumbAnimationId
)
mThumbTransform
(
aThumbTransform
)
mThumbData
(
aThumbData
)
mTargetGuid
(
aTargetGuid
)
mTargetTransform
(
aTargetTransform
)
mTargetIsAncestor
(
aTargetIsAncestor
)
{
MOZ_ASSERT
(
mTargetGuid
.
mScrollId
=
=
mThumbData
.
mTargetViewId
)
;
}
}
;
std
:
:
vector
<
ScrollThumbInfo
>
mScrollThumbInfo
;
struct
FixedPositionInfo
{
uint64_t
mFixedPositionAnimationId
;
SideBits
mFixedPosSides
;
FixedPositionInfo
(
const
uint64_t
&
aFixedPositionAnimationId
const
SideBits
aFixedPosSides
)
:
mFixedPositionAnimationId
(
aFixedPositionAnimationId
)
mFixedPosSides
(
aFixedPosSides
)
{
}
}
;
std
:
:
vector
<
FixedPositionInfo
>
mFixedPositionInfo
;
std
:
:
unordered_map
<
ScrollableLayerGuid
ZoomConstraints
ScrollableLayerGuid
:
:
HashFn
>
mZoomConstraints
;
KeyboardMap
mKeyboardMap
;
FocusState
mFocusState
;
RefPtr
<
AsyncPanZoomController
>
mApzcForInputBlock
;
gfx
:
:
CompositorHitTestInfo
mHitResultForInputBlock
;
SideBits
mFixedPosSidesForInputBlock
=
SideBits
:
:
eNone
;
int32_t
mRetainedTouchIdentifier
;
bool
mInScrollbarTouchDrag
;
TouchCounter
mTouchCounter
;
ScreenPoint
mCurrentMousePosition
;
ScreenMargin
mCompositorFixedLayerMargins
;
ScreenMargin
mGeckoFixedLayerMargins
;
gfx
:
:
TreeLog
<
gfx
:
:
LOG_DEFAULT
>
mApzcTreeLog
;
class
CheckerboardFlushObserver
;
friend
class
CheckerboardFlushObserver
;
RefPtr
<
CheckerboardFlushObserver
>
mFlushObserver
;
std
:
:
unordered_map
<
LayersId
UniquePtr
<
APZTestData
>
LayersId
:
:
HashFn
>
mTestData
;
mutable
mozilla
:
:
Mutex
mTestDataLock
;
float
mDPI
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
public
:
AndroidDynamicToolbarAnimator
*
GetAndroidDynamicToolbarAnimator
(
)
;
private
:
RefPtr
<
AndroidDynamicToolbarAnimator
>
mToolbarAnimator
;
#
endif
}
;
}
}
#
endif
