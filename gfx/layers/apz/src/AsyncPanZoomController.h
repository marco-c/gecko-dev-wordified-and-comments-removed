#
ifndef
mozilla_layers_AsyncPanZoomController_h
#
define
mozilla_layers_AsyncPanZoomController_h
#
include
"
CrossProcessMutex
.
h
"
#
include
"
mozilla
/
layers
/
GeckoContentController
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
RecursiveMutex
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
InputData
.
h
"
#
include
"
Axis
.
h
"
#
include
"
InputQueue
.
h
"
#
include
"
APZUtils
.
h
"
#
include
"
Layers
.
h
"
#
include
"
LayersTypes
.
h
"
#
include
"
mozilla
/
gfx
/
Matrix
.
h
"
#
include
"
nsIScrollableFrame
.
h
"
#
include
"
nsRegion
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
PotentialCheckerboardDurationTracker
.
h
"
#
include
"
base
/
message_loop
.
h
"
namespace
mozilla
{
namespace
ipc
{
class
SharedMemoryBasic
;
}
namespace
layers
{
class
AsyncDragMetrics
;
class
APZCTreeManager
;
struct
ScrollableLayerGuid
;
class
CompositorController
;
class
MetricsSharingController
;
class
GestureEventListener
;
struct
AsyncTransform
;
class
AsyncPanZoomAnimation
;
class
StackScrollerFlingAnimation
;
template
<
typename
FlingPhysics
>
class
GenericFlingAnimation
;
class
AndroidFlingPhysics
;
class
DesktopFlingPhysics
;
class
InputBlockState
;
struct
FlingHandoffState
;
class
TouchBlockState
;
class
PanGestureBlockState
;
class
OverscrollHandoffChain
;
struct
OverscrollHandoffState
;
class
StateChangeNotificationBlocker
;
class
CheckerboardEvent
;
class
OverscrollEffectBase
;
class
WidgetOverscrollEffect
;
class
GenericOverscrollEffect
;
class
AndroidSpecificState
;
struct
KeyboardScrollAction
;
class
PlatformSpecificStateBase
{
public
:
virtual
~
PlatformSpecificStateBase
(
)
=
default
;
virtual
AndroidSpecificState
*
AsAndroidSpecificState
(
)
{
return
nullptr
;
}
virtual
AsyncPanZoomAnimation
*
CreateFlingAnimation
(
AsyncPanZoomController
&
aApzc
const
FlingHandoffState
&
aHandoffState
float
aPLPPI
)
;
static
void
InitializeGlobalState
(
)
{
}
}
;
struct
AncestorTransform
{
gfx
:
:
Matrix4x4
mTransform
;
gfx
:
:
Matrix4x4
mPerspectiveTransform
;
AncestorTransform
(
)
=
default
;
AncestorTransform
(
const
gfx
:
:
Matrix4x4
&
aTransform
bool
aTransformIsPerspective
)
{
(
aTransformIsPerspective
?
mPerspectiveTransform
:
mTransform
)
=
aTransform
;
}
AncestorTransform
(
const
gfx
:
:
Matrix4x4
&
aTransform
const
gfx
:
:
Matrix4x4
&
aPerspectiveTransform
)
:
mTransform
(
aTransform
)
mPerspectiveTransform
(
aPerspectiveTransform
)
{
}
gfx
:
:
Matrix4x4
CombinedTransform
(
)
const
{
return
mTransform
*
mPerspectiveTransform
;
}
bool
ContainsPerspectiveTransform
(
)
const
{
return
!
mPerspectiveTransform
.
IsIdentity
(
)
;
}
gfx
:
:
Matrix4x4
GetPerspectiveTransform
(
)
const
{
return
mPerspectiveTransform
;
}
friend
AncestorTransform
operator
*
(
const
AncestorTransform
&
aA
const
AncestorTransform
&
aB
)
{
return
AncestorTransform
{
aA
.
mTransform
*
aB
.
mTransform
aA
.
mPerspectiveTransform
*
aB
.
mPerspectiveTransform
}
;
}
}
;
class
AsyncPanZoomController
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
AsyncPanZoomController
)
typedef
mozilla
:
:
MonitorAutoLock
MonitorAutoLock
;
typedef
mozilla
:
:
gfx
:
:
Matrix4x4
Matrix4x4
;
public
:
enum
GestureBehavior
{
DEFAULT_GESTURES
USE_GESTURE_DETECTOR
}
;
float
GetDPI
(
)
const
;
ScreenCoord
GetTouchStartTolerance
(
)
const
;
ScreenCoord
GetTouchMoveTolerance
(
)
const
;
ScreenCoord
GetSecondTapTolerance
(
)
const
;
AsyncPanZoomController
(
LayersId
aLayersId
APZCTreeManager
*
aTreeManager
const
RefPtr
<
InputQueue
>
&
aInputQueue
GeckoContentController
*
aController
GestureBehavior
aGestures
=
DEFAULT_GESTURES
)
;
static
void
InitializeGlobalState
(
)
;
void
ZoomToRect
(
CSSRect
aRect
const
uint32_t
aFlags
)
;
void
UpdateZoomConstraints
(
const
ZoomConstraints
&
aConstraints
)
;
ZoomConstraints
GetZoomConstraints
(
)
const
;
void
PostDelayedTask
(
already_AddRefed
<
Runnable
>
aTask
int
aDelayMs
)
;
bool
AdvanceAnimations
(
const
TimeStamp
&
aSampleTime
)
;
bool
UpdateAnimation
(
const
TimeStamp
&
aSampleTime
nsTArray
<
RefPtr
<
Runnable
>
>
*
aOutDeferredTasks
)
;
void
NotifyLayersUpdated
(
const
ScrollMetadata
&
aScrollMetadata
bool
aIsFirstPaint
bool
aThisLayerTreeUpdated
)
;
void
SetCompositorController
(
CompositorController
*
aCompositorController
)
;
void
SetMetricsSharingController
(
MetricsSharingController
*
aMetricsSharingController
)
;
void
Destroy
(
)
;
bool
IsDestroyed
(
)
const
;
Matrix4x4
GetTransformToLastDispatchedPaint
(
)
const
;
uint32_t
GetCheckerboardMagnitude
(
)
const
;
void
ReportCheckerboard
(
const
TimeStamp
&
aSampleTime
)
;
void
FlushActiveCheckerboardReport
(
)
;
bool
IsCurrentlyCheckerboarding
(
)
const
;
static
const
ScreenMargin
CalculatePendingDisplayPort
(
const
FrameMetrics
&
aFrameMetrics
const
ParentLayerPoint
&
aVelocity
)
;
nsEventStatus
HandleDragEvent
(
const
MouseInput
&
aEvent
const
AsyncDragMetrics
&
aDragMetrics
CSSCoord
aInitialThumbPos
)
;
nsEventStatus
HandleInputEvent
(
const
InputData
&
aEvent
const
ScreenToParentLayerMatrix4x4
&
aTransformToApzc
)
;
nsEventStatus
HandleGestureEvent
(
const
InputData
&
aEvent
)
;
void
HandleTouchVelocity
(
uint32_t
aTimesampMs
float
aSpeedY
)
;
void
StartAutoscroll
(
const
ScreenPoint
&
aAnchorLocation
)
;
void
StopAutoscroll
(
)
;
void
GetGuid
(
ScrollableLayerGuid
*
aGuidOut
)
const
;
ScrollableLayerGuid
GetGuid
(
)
const
;
bool
Matches
(
const
ScrollableLayerGuid
&
aGuid
)
;
bool
HasTreeManager
(
const
APZCTreeManager
*
aTreeManager
)
const
;
void
StartAnimation
(
AsyncPanZoomAnimation
*
aAnimation
)
;
void
CancelAnimation
(
CancelAnimationFlags
aFlags
=
Default
)
;
void
AdjustScrollForSurfaceShift
(
const
ScreenPoint
&
aShift
)
;
void
ClearOverscroll
(
)
;
bool
HasScrollgrab
(
)
const
{
return
mScrollMetadata
.
GetHasScrollgrab
(
)
;
}
bool
HasScrollSnapping
(
)
const
{
return
mScrollMetadata
.
GetSnapInfo
(
)
.
HasScrollSnapping
(
)
;
}
bool
IsPannable
(
)
const
;
bool
IsScrollInfoLayer
(
)
const
;
bool
IsFlingingFast
(
)
const
;
int32_t
GetLastTouchIdentifier
(
)
const
;
ScreenToParentLayerMatrix4x4
GetTransformToThis
(
)
const
;
ScreenPoint
ToScreenCoordinates
(
const
ParentLayerPoint
&
aVector
const
ParentLayerPoint
&
aAnchor
)
const
;
ParentLayerPoint
ToParentLayerCoordinates
(
const
ScreenPoint
&
aVector
const
ScreenPoint
&
aAnchor
)
const
;
bool
CanScroll
(
const
InputData
&
aEvent
)
const
;
ScrollDirections
GetAllowedHandoffDirections
(
)
const
;
bool
CanScroll
(
const
ParentLayerPoint
&
aDelta
)
const
;
bool
CanScrollWithWheel
(
const
ParentLayerPoint
&
aDelta
)
const
;
bool
CanScroll
(
ScrollDirection
aDirection
)
const
;
CSSCoord
ConvertScrollbarPoint
(
const
ParentLayerPoint
&
aScrollbarPoint
const
ScrollbarData
&
aThumbData
)
const
;
void
NotifyMozMouseScrollEvent
(
const
nsString
&
aString
)
const
;
bool
OverscrollBehaviorAllowsSwipe
(
)
const
;
private
:
bool
IsContentOfHonouredTargetRightToLeft
(
bool
aHonoursRoot
)
const
;
protected
:
virtual
~
AsyncPanZoomController
(
)
;
TimeStamp
GetFrameTime
(
)
const
;
nsEventStatus
OnTouchStart
(
const
MultiTouchInput
&
aEvent
)
;
nsEventStatus
OnTouchMove
(
const
MultiTouchInput
&
aEvent
)
;
nsEventStatus
OnTouchEnd
(
const
MultiTouchInput
&
aEvent
)
;
nsEventStatus
OnTouchCancel
(
const
MultiTouchInput
&
aEvent
)
;
nsEventStatus
OnScaleBegin
(
const
PinchGestureInput
&
aEvent
)
;
nsEventStatus
OnScale
(
const
PinchGestureInput
&
aEvent
)
;
nsEventStatus
OnScaleEnd
(
const
PinchGestureInput
&
aEvent
)
;
nsEventStatus
OnPanMayBegin
(
const
PanGestureInput
&
aEvent
)
;
nsEventStatus
OnPanCancelled
(
const
PanGestureInput
&
aEvent
)
;
nsEventStatus
OnPanBegin
(
const
PanGestureInput
&
aEvent
)
;
nsEventStatus
OnPan
(
const
PanGestureInput
&
aEvent
bool
aFingersOnTouchpad
)
;
nsEventStatus
OnPanEnd
(
const
PanGestureInput
&
aEvent
)
;
nsEventStatus
OnPanMomentumStart
(
const
PanGestureInput
&
aEvent
)
;
nsEventStatus
OnPanMomentumEnd
(
const
PanGestureInput
&
aEvent
)
;
nsEventStatus
HandleEndOfPan
(
)
;
nsEventStatus
OnScrollWheel
(
const
ScrollWheelInput
&
aEvent
)
;
ParentLayerPoint
GetScrollWheelDelta
(
const
ScrollWheelInput
&
aEvent
)
const
;
ParentLayerPoint
GetScrollWheelDelta
(
const
ScrollWheelInput
&
aEvent
double
aDeltaX
double
aDeltaY
double
aMultiplierX
double
aMultiplierY
)
const
;
template
<
typename
T
>
ParentLayerPoint
GetScrollWheelDelta
(
ScrollWheelInput
&
T
T
T
T
)
=
delete
;
nsEventStatus
OnKeyboard
(
const
KeyboardInput
&
aEvent
)
;
CSSPoint
GetKeyboardDestination
(
const
KeyboardScrollAction
&
aAction
)
const
;
nsEventStatus
OnLongPress
(
const
TapGestureInput
&
aEvent
)
;
nsEventStatus
OnLongPressUp
(
const
TapGestureInput
&
aEvent
)
;
nsEventStatus
OnSingleTapUp
(
const
TapGestureInput
&
aEvent
)
;
nsEventStatus
OnSingleTapConfirmed
(
const
TapGestureInput
&
aEvent
)
;
nsEventStatus
OnDoubleTap
(
const
TapGestureInput
&
aEvent
)
;
nsEventStatus
OnSecondTap
(
const
TapGestureInput
&
aEvent
)
;
nsEventStatus
OnCancelTap
(
const
TapGestureInput
&
aEvent
)
;
void
SetScrollOffset
(
const
CSSPoint
&
aOffset
)
;
void
ClampAndSetScrollOffset
(
const
CSSPoint
&
aOffset
)
;
void
ScrollBy
(
const
CSSPoint
&
aOffset
)
;
void
ScrollByAndClamp
(
const
CSSPoint
&
aOffset
)
;
void
CopyScrollInfoFrom
(
const
FrameMetrics
&
aFrameMetrics
)
;
void
ScaleWithFocus
(
float
aScale
const
CSSPoint
&
aFocus
)
;
void
ScheduleComposite
(
)
;
void
ScheduleCompositeAndMaybeRepaint
(
)
;
ScreenCoord
PanDistance
(
)
const
;
ParentLayerPoint
PanStart
(
)
const
;
const
ParentLayerPoint
GetVelocityVector
(
)
const
;
void
SetVelocityVector
(
const
ParentLayerPoint
&
aVelocityVector
)
;
ParentLayerPoint
GetFirstTouchPoint
(
const
MultiTouchInput
&
aEvent
)
;
void
HandlePanningWithTouchAction
(
double
angle
)
;
void
HandlePanning
(
double
angle
)
;
void
HandlePanningUpdate
(
const
ScreenPoint
&
aDelta
)
;
void
HandlePinchLocking
(
ScreenCoord
spanDistance
ScreenPoint
focusChange
)
;
nsEventStatus
StartPanning
(
const
ParentLayerPoint
&
aStartPoint
)
;
void
UpdateWithTouchAtDevicePoint
(
const
MultiTouchInput
&
aEvent
)
;
void
TrackTouch
(
const
MultiTouchInput
&
aEvent
)
;
void
RequestContentRepaint
(
bool
aUserAction
=
true
)
;
void
RequestContentRepaint
(
const
FrameMetrics
&
aFrameMetrics
const
ParentLayerPoint
&
aVelocity
)
;
const
FrameMetrics
&
GetFrameMetrics
(
)
const
;
const
ScrollMetadata
&
GetScrollMetadata
(
)
const
;
APZCTreeManager
*
GetApzcTreeManager
(
)
const
;
void
AssertOnSamplerThread
(
)
const
;
void
AssertOnUpdaterThread
(
)
const
;
bool
ConvertToGecko
(
const
ScreenIntPoint
&
aPoint
LayoutDevicePoint
*
aOut
)
;
enum
AxisLockMode
{
FREE
STANDARD
STICKY
}
;
static
AxisLockMode
GetAxisLockMode
(
)
;
enum
PinchLockMode
{
PINCH_FREE
PINCH_STANDARD
PINCH_STICKY
}
;
static
PinchLockMode
GetPinchLockMode
(
)
;
nsEventStatus
GenerateSingleTap
(
GeckoContentController
:
:
TapType
aType
const
ScreenIntPoint
&
aPoint
mozilla
:
:
Modifiers
aModifiers
)
;
void
OnTouchEndOrCancel
(
)
;
LayersId
mLayersId
;
RefPtr
<
CompositorController
>
mCompositorController
;
RefPtr
<
MetricsSharingController
>
mMetricsSharingController
;
RefPtr
<
GeckoContentController
>
mGeckoContentController
;
RefPtr
<
GestureEventListener
>
mGestureEventListener
;
mutable
Monitor
mRefPtrMonitor
;
Atomic
<
APZCTreeManager
*
>
mTreeManager
;
already_AddRefed
<
GeckoContentController
>
GetGeckoContentController
(
)
const
;
already_AddRefed
<
GestureEventListener
>
GetGestureEventListener
(
)
const
;
PlatformSpecificStateBase
*
GetPlatformSpecificState
(
)
;
protected
:
ScrollMetadata
mScrollMetadata
;
FrameMetrics
&
mFrameMetrics
;
mutable
RecursiveMutex
mRecursiveMutex
;
private
:
ScrollMetadata
mLastContentPaintMetadata
;
FrameMetrics
&
mLastContentPaintMetrics
;
FrameMetrics
mLastPaintRequestMetrics
;
FrameMetrics
mExpectedGeckoMetrics
;
CSSRect
mCompositedLayoutViewport
;
CSSPoint
mCompositedScrollOffset
;
CSSToParentLayerScale2D
mCompositedZoom
;
AxisX
mX
;
AxisY
mY
;
bool
mPanDirRestricted
;
bool
mPinchLocked
;
ZoomConstraints
mZoomConstraints
;
TimeStamp
mLastSampleTime
;
TimeStamp
mLastCheckerboardReport
;
ParentLayerPoint
mLastZoomFocus
;
RefPtr
<
AsyncPanZoomAnimation
>
mAnimation
;
UniquePtr
<
OverscrollEffectBase
>
mOverscrollEffect
;
UniquePtr
<
PlatformSpecificStateBase
>
mPlatformSpecificState
;
friend
class
Axis
;
public
:
template
<
typename
Callable
>
auto
CallWithLastContentPaintMetrics
(
const
Callable
&
callable
)
const
-
>
decltype
(
callable
(
mLastContentPaintMetrics
)
)
{
RecursiveMutexAutoLock
lock
(
mRecursiveMutex
)
;
return
callable
(
mLastContentPaintMetrics
)
;
}
public
:
enum
AsyncTransformConsumer
{
eForHitTesting
eForCompositing
}
;
CSSRect
GetCurrentAsyncLayoutViewport
(
AsyncTransformConsumer
aMode
)
const
;
ParentLayerPoint
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
aMode
)
const
;
CSSPoint
GetCurrentAsyncScrollOffsetInCssPixels
(
AsyncTransformConsumer
aMode
)
const
;
AsyncTransformComponentMatrix
GetOverscrollTransform
(
AsyncTransformConsumer
aMode
)
const
;
AsyncTransform
GetCurrentAsyncTransform
(
AsyncTransformConsumer
aMode
)
const
;
AsyncTransformComponentMatrix
GetCurrentAsyncTransformWithOverscroll
(
AsyncTransformConsumer
aMode
)
const
;
private
:
bool
SampleCompositedAsyncTransform
(
)
;
CSSRect
GetEffectiveLayoutViewport
(
AsyncTransformConsumer
aMode
)
const
;
CSSPoint
GetEffectiveScrollOffset
(
AsyncTransformConsumer
aMode
)
const
;
CSSToParentLayerScale2D
GetEffectiveZoom
(
AsyncTransformConsumer
aMode
)
const
;
protected
:
enum
PanZoomState
{
NOTHING
FLING
TOUCHING
PANNING
PANNING_LOCKED_X
PANNING_LOCKED_Y
PAN_MOMENTUM
PINCHING
ANIMATING_ZOOM
OVERSCROLL_ANIMATION
SMOOTH_SCROLL
WHEEL_SCROLL
KEYBOARD_SCROLL
AUTOSCROLL
SCROLLBAR_DRAG
}
;
PanZoomState
mState
;
private
:
friend
class
StateChangeNotificationBlocker
;
int
mNotificationBlockers
;
void
SetState
(
PanZoomState
aState
)
;
void
DispatchStateChangeNotification
(
PanZoomState
aOldState
PanZoomState
aNewState
)
;
static
bool
IsTransformingState
(
PanZoomState
aState
)
;
public
:
void
FlushRepaintForNewInputBlock
(
)
;
bool
ArePointerEventsConsumable
(
TouchBlockState
*
aBlock
uint32_t
aTouchPoints
)
;
void
ResetTouchInputState
(
)
;
const
RefPtr
<
InputQueue
>
&
GetInputQueue
(
)
const
;
private
:
void
CancelAnimationAndGestureState
(
)
;
RefPtr
<
InputQueue
>
mInputQueue
;
InputBlockState
*
GetCurrentInputBlock
(
)
const
;
TouchBlockState
*
GetCurrentTouchBlock
(
)
const
;
bool
HasReadyTouchBlock
(
)
const
;
PanGestureBlockState
*
GetCurrentPanGestureBlock
(
)
const
;
private
:
public
:
ParentLayerPoint
AttemptFling
(
const
FlingHandoffState
&
aHandoffState
)
;
ParentLayerPoint
AdjustHandoffVelocityForOverscrollBehavior
(
ParentLayerPoint
&
aHandoffVelocity
)
const
;
private
:
friend
class
StackScrollerFlingAnimation
;
friend
class
AutoscrollAnimation
;
template
<
typename
FlingPhysics
>
friend
class
GenericFlingAnimation
;
friend
class
AndroidFlingPhysics
;
friend
class
DesktopFlingPhysics
;
friend
class
OverscrollAnimation
;
friend
class
SmoothScrollAnimation
;
friend
class
GenericScrollAnimation
;
friend
class
WheelScrollAnimation
;
friend
class
KeyboardScrollAnimation
;
friend
class
ZoomAnimation
;
friend
class
GenericOverscrollEffect
;
friend
class
WidgetOverscrollEffect
;
ParentLayerPoint
mLastFlingVelocity
;
TimeStamp
mLastFlingTime
;
bool
mPinchPaintTimerSet
;
void
HandleFlingOverscroll
(
const
ParentLayerPoint
&
aVelocity
const
RefPtr
<
const
OverscrollHandoffChain
>
&
aOverscrollHandoffChain
const
RefPtr
<
const
AsyncPanZoomController
>
&
aScrolledApzc
)
;
void
HandleSmoothScrollOverscroll
(
const
ParentLayerPoint
&
aVelocity
)
;
void
StartOverscrollAnimation
(
const
ParentLayerPoint
&
aVelocity
)
;
void
SmoothScrollTo
(
const
CSSPoint
&
aDestination
)
;
bool
AllowScrollHandoffInCurrentBlock
(
)
const
;
void
DoDelayedRequestContentRepaint
(
)
;
float
ComputePLPPI
(
ParentLayerPoint
aPoint
ParentLayerPoint
aDirection
)
const
;
public
:
void
SetParent
(
AsyncPanZoomController
*
aParent
)
{
mParent
=
aParent
;
}
AsyncPanZoomController
*
GetParent
(
)
const
{
return
mParent
;
}
bool
HasNoParentWithSameLayersId
(
)
const
{
return
!
mParent
|
|
(
mParent
-
>
mLayersId
!
=
mLayersId
)
;
}
bool
IsRootForLayersId
(
)
const
{
RecursiveMutexAutoLock
lock
(
mRecursiveMutex
)
;
return
mScrollMetadata
.
IsLayersIdRoot
(
)
;
}
bool
IsRootContent
(
)
const
{
RecursiveMutexAutoLock
lock
(
mRecursiveMutex
)
;
return
mFrameMetrics
.
IsRootContent
(
)
;
}
private
:
RefPtr
<
AsyncPanZoomController
>
mParent
;
public
:
FrameMetrics
:
:
ViewID
GetScrollHandoffParentId
(
)
const
{
return
mScrollMetadata
.
GetScrollParentId
(
)
;
}
bool
AttemptScroll
(
ParentLayerPoint
&
aStartPoint
ParentLayerPoint
&
aEndPoint
OverscrollHandoffState
&
aOverscrollHandoffState
)
;
void
FlushRepaintForOverscrollHandoff
(
)
;
bool
SnapBackIfOverscrolled
(
)
;
RefPtr
<
const
OverscrollHandoffChain
>
BuildOverscrollHandoffChain
(
)
;
private
:
void
CallDispatchScroll
(
ParentLayerPoint
&
aStartPoint
ParentLayerPoint
&
aEndPoint
OverscrollHandoffState
&
aOverscrollHandoffState
)
;
void
OverscrollForPanning
(
ParentLayerPoint
&
aOverscroll
const
ScreenPoint
&
aPanDistance
)
;
void
OverscrollBy
(
ParentLayerPoint
&
aOverscroll
)
;
ParentLayerPoint
GetDeltaForEvent
(
const
InputData
&
aEvent
)
const
;
public
:
void
SetAncestorTransform
(
const
AncestorTransform
&
aAncestorTransform
)
{
mAncestorTransform
=
aAncestorTransform
;
}
Matrix4x4
GetAncestorTransform
(
)
const
{
return
mAncestorTransform
.
CombinedTransform
(
)
;
}
bool
AncestorTransformContainsPerspective
(
)
const
{
return
mAncestorTransform
.
ContainsPerspectiveTransform
(
)
;
}
Matrix4x4
GetAncestorTransformPerspective
(
)
const
{
return
mAncestorTransform
.
GetPerspectiveTransform
(
)
;
}
bool
Contains
(
const
ScreenIntPoint
&
aPoint
)
const
;
bool
IsOverscrolled
(
)
const
{
return
mX
.
IsOverscrolled
(
)
|
|
mY
.
IsOverscrolled
(
)
;
}
bool
IsInPanningState
(
)
const
;
private
:
AncestorTransform
mAncestorTransform
;
private
:
const
uint32_t
mAPZCId
;
RefPtr
<
ipc
:
:
SharedMemoryBasic
>
mSharedFrameMetricsBuffer
;
CrossProcessMutex
*
mSharedLock
;
void
UpdateSharedCompositorFrameMetrics
(
)
;
void
ShareCompositorFrameMetrics
(
)
;
public
:
bool
TestHasAsyncKeyScrolled
(
)
const
{
return
mTestHasAsyncKeyScrolled
;
}
void
SetTestAsyncScrollOffset
(
const
CSSPoint
&
aPoint
)
;
void
SetTestAsyncZoom
(
const
LayerToParentLayerScale
&
aZoom
)
;
void
MarkAsyncTransformAppliedToContent
(
)
{
mAsyncTransformAppliedToContent
=
true
;
}
bool
GetAsyncTransformAppliedToContent
(
)
const
{
return
mAsyncTransformAppliedToContent
;
}
LayersId
GetLayersId
(
)
const
{
return
mLayersId
;
}
private
:
CSSPoint
mTestAsyncScrollOffset
;
LayerToParentLayerScale
mTestAsyncZoom
;
bool
mAsyncTransformAppliedToContent
:
1
;
bool
mTestHasAsyncKeyScrolled
:
1
;
private
:
void
UpdateCheckerboardEvent
(
const
MutexAutoLock
&
aProofOfLock
uint32_t
aMagnitude
)
;
Mutex
mCheckerboardEventLock
;
UniquePtr
<
CheckerboardEvent
>
mCheckerboardEvent
;
PotentialCheckerboardDurationTracker
mPotentialCheckerboardTracker
;
bool
MaybeAdjustDeltaForScrollSnapping
(
const
ScrollWheelInput
&
aEvent
ParentLayerPoint
&
aDelta
CSSPoint
&
aStartPosition
)
;
bool
MaybeAdjustDestinationForScrollSnapping
(
const
KeyboardInput
&
aEvent
CSSPoint
&
aDestination
)
;
void
ScrollSnap
(
)
;
void
ScrollSnapToDestination
(
)
;
void
ScrollSnapNear
(
const
CSSPoint
&
aDestination
)
;
Maybe
<
CSSPoint
>
FindSnapPointNear
(
const
CSSPoint
&
aDestination
nsIScrollableFrame
:
:
ScrollUnit
aUnit
)
;
}
;
}
}
#
endif
