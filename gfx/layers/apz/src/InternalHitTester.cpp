#
include
"
InternalHitTester
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
APZCTreeManager
.
h
"
#
include
"
TreeTraversal
.
h
"
#
include
"
mozilla
/
gfx
/
CompositorHitTestInfo
.
h
"
#
define
APZCTM_LOG
(
.
.
.
)
\
MOZ_LOG
(
APZCTreeManager
:
:
sLog
LogLevel
:
:
Debug
(
__VA_ARGS__
)
)
namespace
mozilla
{
namespace
layers
{
using
mozilla
:
:
gfx
:
:
CompositorHitTestFlags
;
using
mozilla
:
:
gfx
:
:
CompositorHitTestInfo
;
using
mozilla
:
:
gfx
:
:
CompositorHitTestInvisibleToHit
;
IAPZHitTester
:
:
HitTestResult
InternalHitTester
:
:
GetAPZCAtPoint
(
const
ScreenPoint
&
aHitTestPoint
const
RecursiveMutexAutoLock
&
aProofOfTreeLock
)
{
HitTestResult
hit
;
HitTestingTreeNode
*
resultNode
=
nullptr
;
HitTestingTreeNode
*
root
=
GetRootNode
(
)
;
HitTestingTreeNode
*
scrollbarNode
=
nullptr
;
std
:
:
stack
<
LayerPoint
>
hitTestPoints
;
ParentLayerPoint
point
=
ViewAs
<
ParentLayerPixel
>
(
aHitTestPoint
PixelCastJustification
:
:
ScreenIsParentLayerForRoot
)
;
hitTestPoints
.
push
(
ViewAs
<
LayerPixel
>
(
point
PixelCastJustification
:
:
MovingDownToChildren
)
)
;
ForEachNode
<
ReverseIterator
>
(
root
[
&
resultNode
&
hitTestPoints
&
hit
this
]
(
HitTestingTreeNode
*
aNode
)
{
ParentLayerPoint
hitTestPointForParent
=
ViewAs
<
ParentLayerPixel
>
(
hitTestPoints
.
top
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
if
(
aNode
-
>
IsOutsideClip
(
hitTestPointForParent
)
)
{
APZCTM_LOG
(
"
Point
%
s
outside
clip
for
node
%
p
\
n
"
ToString
(
hitTestPointForParent
)
.
c_str
(
)
aNode
)
;
return
TraversalFlag
:
:
Skip
;
}
const
AsyncPanZoomController
*
sourceOfOverscrollTransform
=
nullptr
;
auto
transform
=
this
-
>
ComputeTransformForNode
(
aNode
&
sourceOfOverscrollTransform
)
;
if
(
sourceOfOverscrollTransform
&
&
sourceOfOverscrollTransform
-
>
IsInOverscrollGutter
(
hitTestPointForParent
)
)
{
APZCTM_LOG
(
"
ParentLayer
point
%
s
in
overscroll
gutter
of
APZC
%
p
(
node
"
"
%
p
)
\
n
"
ToString
(
hitTestPointForParent
)
.
c_str
(
)
aNode
-
>
GetApzc
(
)
aNode
)
;
resultNode
=
aNode
;
hit
.
mHitResult
=
{
CompositorHitTestFlags
:
:
eVisibleToHitTest
}
;
hit
.
mHitOverscrollGutter
=
true
;
return
TraversalFlag
:
:
Abort
;
}
Maybe
<
LayerPoint
>
hitTestPoint
=
aNode
-
>
Untransform
(
hitTestPointForParent
transform
)
;
APZCTM_LOG
(
"
Transformed
ParentLayer
point
%
s
to
layer
%
s
\
n
"
ToString
(
hitTestPointForParent
)
.
c_str
(
)
hitTestPoint
?
ToString
(
hitTestPoint
.
ref
(
)
)
.
c_str
(
)
:
"
nil
"
)
;
if
(
!
hitTestPoint
)
{
return
TraversalFlag
:
:
Skip
;
}
hitTestPoints
.
push
(
hitTestPoint
.
ref
(
)
)
;
return
TraversalFlag
:
:
Continue
;
}
[
&
resultNode
&
hitTestPoints
&
hit
]
(
HitTestingTreeNode
*
aNode
)
{
CompositorHitTestInfo
hitResult
=
aNode
-
>
HitTest
(
hitTestPoints
.
top
(
)
)
;
hitTestPoints
.
pop
(
)
;
APZCTM_LOG
(
"
Testing
Layer
point
%
s
against
node
%
p
\
n
"
ToString
(
hitTestPoints
.
top
(
)
)
.
c_str
(
)
aNode
)
;
if
(
hitResult
!
=
CompositorHitTestInvisibleToHit
)
{
resultNode
=
aNode
;
hit
.
mHitResult
=
hitResult
;
return
TraversalFlag
:
:
Abort
;
}
return
TraversalFlag
:
:
Continue
;
}
)
;
if
(
hit
.
mHitResult
!
=
CompositorHitTestInvisibleToHit
)
{
MOZ_ASSERT
(
resultNode
)
;
for
(
HitTestingTreeNode
*
n
=
resultNode
;
n
;
n
=
n
-
>
GetParent
(
)
)
{
if
(
n
-
>
IsScrollbarNode
(
)
)
{
scrollbarNode
=
n
;
hit
.
mHitResult
+
=
CompositorHitTestFlags
:
:
eScrollbar
;
if
(
n
-
>
IsScrollThumbNode
(
)
)
{
hit
.
mHitResult
+
=
CompositorHitTestFlags
:
:
eScrollbarThumb
;
}
if
(
n
-
>
GetScrollbarDirection
(
)
=
=
ScrollDirection
:
:
eVertical
)
{
hit
.
mHitResult
+
=
CompositorHitTestFlags
:
:
eScrollbarVertical
;
}
RefPtr
<
AsyncPanZoomController
>
scrollTarget
=
mTreeManager
-
>
GetTargetAPZC
(
n
-
>
GetLayersId
(
)
n
-
>
GetScrollTargetId
(
)
)
;
if
(
scrollTarget
)
{
hit
.
mLayersId
=
n
-
>
GetLayersId
(
)
;
hit
.
mTargetApzc
=
std
:
:
move
(
scrollTarget
)
;
RefPtr
<
HitTestingTreeNode
>
scrollbarRef
=
scrollbarNode
;
InitializeHitTestingTreeNodeAutoLock
(
hit
.
mScrollbarNode
aProofOfTreeLock
scrollbarRef
)
;
return
hit
;
}
}
else
if
(
IsFixedToRootContent
(
n
)
)
{
hit
.
mFixedPosSides
=
n
-
>
GetFixedPosSides
(
)
;
}
}
hit
.
mTargetApzc
=
GetTargetApzcForNode
(
resultNode
)
;
if
(
!
hit
.
mTargetApzc
)
{
hit
.
mTargetApzc
=
FindRootApzcForLayersId
(
resultNode
-
>
GetLayersId
(
)
)
;
MOZ_ASSERT
(
hit
.
mTargetApzc
)
;
APZCTM_LOG
(
"
Found
target
%
p
using
root
lookup
\
n
"
hit
.
mTargetApzc
.
get
(
)
)
;
}
APZCTM_LOG
(
"
Successfully
matched
APZC
%
p
via
node
%
p
(
hit
result
0x
%
x
)
\
n
"
hit
.
mTargetApzc
.
get
(
)
resultNode
hit
.
mHitResult
.
serialize
(
)
)
;
hit
.
mLayersId
=
resultNode
-
>
GetLayersId
(
)
;
}
if
(
hit
.
mTargetApzc
&
&
resultNode
&
&
(
hit
.
mTargetApzc
!
=
resultNode
-
>
GetApzc
(
)
)
)
{
hit
.
mHitOverscrollGutter
=
hit
.
mTargetApzc
-
>
IsInOverscrollGutter
(
aHitTestPoint
)
;
}
return
hit
;
}
}
}
