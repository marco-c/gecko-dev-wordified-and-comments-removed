#
include
"
HitTestingTreeNode
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
LayersLogging
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
layers
/
APZThreadUtils
.
h
"
#
include
"
mozilla
/
layers
/
APZUtils
.
h
"
#
include
"
mozilla
/
layers
/
AsyncCompositionManager
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
UnitTransforms
.
h
"
namespace
mozilla
{
namespace
layers
{
HitTestingTreeNode
:
:
HitTestingTreeNode
(
AsyncPanZoomController
*
aApzc
bool
aIsPrimaryHolder
uint64_t
aLayersId
)
:
mApzc
(
aApzc
)
mIsPrimaryApzcHolder
(
aIsPrimaryHolder
)
mLayersId
(
aLayersId
)
mScrollViewId
(
FrameMetrics
:
:
NULL_SCROLL_ID
)
mScrollDir
(
Layer
:
:
NONE
)
mScrollSize
(
0
)
mOverride
(
EventRegionsOverride
:
:
NoOverride
)
{
if
(
mIsPrimaryApzcHolder
)
{
MOZ_ASSERT
(
mApzc
)
;
}
MOZ_ASSERT
(
!
mApzc
|
|
mApzc
-
>
GetLayersId
(
)
=
=
mLayersId
)
;
}
void
HitTestingTreeNode
:
:
RecycleWith
(
AsyncPanZoomController
*
aApzc
uint64_t
aLayersId
)
{
MOZ_ASSERT
(
!
mIsPrimaryApzcHolder
)
;
Destroy
(
)
;
mApzc
=
aApzc
;
mLayersId
=
aLayersId
;
MOZ_ASSERT
(
!
mApzc
|
|
mApzc
-
>
GetLayersId
(
)
=
=
mLayersId
)
;
}
HitTestingTreeNode
:
:
~
HitTestingTreeNode
(
)
{
}
void
HitTestingTreeNode
:
:
Destroy
(
)
{
APZThreadUtils
:
:
AssertOnCompositorThread
(
)
;
mPrevSibling
=
nullptr
;
mLastChild
=
nullptr
;
mParent
=
nullptr
;
if
(
mApzc
)
{
if
(
mIsPrimaryApzcHolder
)
{
mApzc
-
>
Destroy
(
)
;
}
mApzc
=
nullptr
;
}
mLayersId
=
0
;
}
void
HitTestingTreeNode
:
:
SetLastChild
(
HitTestingTreeNode
*
aChild
)
{
mLastChild
=
aChild
;
if
(
aChild
)
{
aChild
-
>
mParent
=
this
;
if
(
aChild
-
>
GetApzc
(
)
)
{
AsyncPanZoomController
*
parent
=
GetNearestContainingApzc
(
)
;
MOZ_ASSERT
(
aChild
-
>
GetApzc
(
)
!
=
parent
)
;
aChild
-
>
SetApzcParent
(
parent
)
;
}
}
}
void
HitTestingTreeNode
:
:
SetScrollbarData
(
FrameMetrics
:
:
ViewID
aScrollViewId
Layer
:
:
ScrollDirection
aDir
int32_t
aScrollSize
)
{
mScrollViewId
=
aScrollViewId
;
mScrollDir
=
aDir
;
mScrollSize
=
aScrollSize
;
;
}
bool
HitTestingTreeNode
:
:
MatchesScrollDragMetrics
(
const
AsyncDragMetrics
&
aDragMetrics
)
const
{
return
(
(
mScrollDir
=
=
Layer
:
:
HORIZONTAL
&
&
aDragMetrics
.
mDirection
=
=
AsyncDragMetrics
:
:
HORIZONTAL
)
|
|
(
mScrollDir
=
=
Layer
:
:
VERTICAL
&
&
aDragMetrics
.
mDirection
=
=
AsyncDragMetrics
:
:
VERTICAL
)
)
&
&
mScrollViewId
=
=
aDragMetrics
.
mViewId
;
}
int32_t
HitTestingTreeNode
:
:
GetScrollSize
(
)
const
{
return
mScrollSize
;
}
void
HitTestingTreeNode
:
:
SetPrevSibling
(
HitTestingTreeNode
*
aSibling
)
{
mPrevSibling
=
aSibling
;
if
(
aSibling
)
{
aSibling
-
>
mParent
=
mParent
;
if
(
aSibling
-
>
GetApzc
(
)
)
{
AsyncPanZoomController
*
parent
=
mParent
?
mParent
-
>
GetNearestContainingApzc
(
)
:
nullptr
;
aSibling
-
>
SetApzcParent
(
parent
)
;
}
}
}
void
HitTestingTreeNode
:
:
MakeRoot
(
)
{
mParent
=
nullptr
;
if
(
GetApzc
(
)
)
{
SetApzcParent
(
nullptr
)
;
}
}
HitTestingTreeNode
*
HitTestingTreeNode
:
:
GetFirstChild
(
)
const
{
HitTestingTreeNode
*
child
=
GetLastChild
(
)
;
while
(
child
&
&
child
-
>
GetPrevSibling
(
)
)
{
child
=
child
-
>
GetPrevSibling
(
)
;
}
return
child
;
}
HitTestingTreeNode
*
HitTestingTreeNode
:
:
GetLastChild
(
)
const
{
return
mLastChild
;
}
HitTestingTreeNode
*
HitTestingTreeNode
:
:
GetPrevSibling
(
)
const
{
return
mPrevSibling
;
}
HitTestingTreeNode
*
HitTestingTreeNode
:
:
GetParent
(
)
const
{
return
mParent
;
}
AsyncPanZoomController
*
HitTestingTreeNode
:
:
GetApzc
(
)
const
{
return
mApzc
;
}
AsyncPanZoomController
*
HitTestingTreeNode
:
:
GetNearestContainingApzc
(
)
const
{
for
(
const
HitTestingTreeNode
*
n
=
this
;
n
;
n
=
n
-
>
GetParent
(
)
)
{
if
(
n
-
>
GetApzc
(
)
)
{
return
n
-
>
GetApzc
(
)
;
}
}
return
nullptr
;
}
AsyncPanZoomController
*
HitTestingTreeNode
:
:
GetNearestContainingApzcWithSameLayersId
(
)
const
{
for
(
const
HitTestingTreeNode
*
n
=
this
;
n
&
&
n
-
>
mLayersId
=
=
mLayersId
;
n
=
n
-
>
GetParent
(
)
)
{
if
(
n
-
>
GetApzc
(
)
)
{
return
n
-
>
GetApzc
(
)
;
}
}
return
nullptr
;
}
bool
HitTestingTreeNode
:
:
IsPrimaryHolder
(
)
const
{
return
mIsPrimaryApzcHolder
;
}
uint64_t
HitTestingTreeNode
:
:
GetLayersId
(
)
const
{
return
mLayersId
;
}
void
HitTestingTreeNode
:
:
SetHitTestData
(
const
EventRegions
&
aRegions
const
CSSTransformMatrix
&
aTransform
const
Maybe
<
ParentLayerIntRegion
>
&
aClipRegion
const
EventRegionsOverride
&
aOverride
)
{
mEventRegions
=
aRegions
;
mTransform
=
aTransform
;
mClipRegion
=
aClipRegion
;
mOverride
=
aOverride
;
}
bool
HitTestingTreeNode
:
:
IsOutsideClip
(
const
ParentLayerPoint
&
aPoint
)
const
{
return
(
mClipRegion
.
isSome
(
)
&
&
!
mClipRegion
-
>
Contains
(
aPoint
.
x
aPoint
.
y
)
)
;
}
Maybe
<
LayerPoint
>
HitTestingTreeNode
:
:
Untransform
(
const
ParentLayerPoint
&
aPoint
)
const
{
LayerToParentLayerMatrix4x4
transform
=
mTransform
*
CompleteAsyncTransform
(
mApzc
?
mApzc
-
>
GetCurrentAsyncTransformWithOverscroll
(
)
:
AsyncTransformComponentMatrix
(
)
)
;
return
UntransformBy
(
transform
.
Inverse
(
)
aPoint
)
;
}
HitTestResult
HitTestingTreeNode
:
:
HitTest
(
const
ParentLayerPoint
&
aPoint
)
const
{
MOZ_ASSERT
(
!
IsOutsideClip
(
aPoint
)
)
;
if
(
mOverride
&
EventRegionsOverride
:
:
ForceEmptyHitRegion
)
{
return
HitTestResult
:
:
HitNothing
;
}
Maybe
<
LayerPoint
>
pointInLayerPixels
=
Untransform
(
aPoint
)
;
if
(
!
pointInLayerPixels
)
{
return
HitTestResult
:
:
HitNothing
;
}
LayerIntPoint
point
=
RoundedToInt
(
pointInLayerPixels
.
ref
(
)
)
;
if
(
!
mEventRegions
.
mHitRegion
.
Contains
(
point
.
x
point
.
y
)
)
{
return
HitTestResult
:
:
HitNothing
;
}
if
(
(
mOverride
&
EventRegionsOverride
:
:
ForceDispatchToContent
)
|
|
mEventRegions
.
mDispatchToContentHitRegion
.
Contains
(
point
.
x
point
.
y
)
)
{
return
HitTestResult
:
:
HitDispatchToContentRegion
;
}
return
HitTestResult
:
:
HitLayer
;
}
EventRegionsOverride
HitTestingTreeNode
:
:
GetEventRegionsOverride
(
)
const
{
return
mOverride
;
}
void
HitTestingTreeNode
:
:
Dump
(
const
char
*
aPrefix
)
const
{
if
(
mPrevSibling
)
{
mPrevSibling
-
>
Dump
(
aPrefix
)
;
}
printf_stderr
(
"
%
sHitTestingTreeNode
(
%
p
)
APZC
(
%
p
)
g
=
(
%
s
)
%
s
%
sr
=
(
%
s
)
t
=
(
%
s
)
c
=
(
%
s
)
\
n
"
aPrefix
this
mApzc
.
get
(
)
mApzc
?
Stringify
(
mApzc
-
>
GetGuid
(
)
)
.
c_str
(
)
:
nsPrintfCString
(
"
l
=
%
"
PRIu64
mLayersId
)
.
get
(
)
(
mOverride
&
EventRegionsOverride
:
:
ForceDispatchToContent
)
?
"
fdtc
"
:
"
"
(
mOverride
&
EventRegionsOverride
:
:
ForceEmptyHitRegion
)
?
"
fehr
"
:
"
"
Stringify
(
mEventRegions
)
.
c_str
(
)
Stringify
(
mTransform
)
.
c_str
(
)
mClipRegion
?
Stringify
(
mClipRegion
.
ref
(
)
)
.
c_str
(
)
:
"
none
"
)
;
if
(
mLastChild
)
{
mLastChild
-
>
Dump
(
nsPrintfCString
(
"
%
s
"
aPrefix
)
.
get
(
)
)
;
}
}
void
HitTestingTreeNode
:
:
SetApzcParent
(
AsyncPanZoomController
*
aParent
)
{
MOZ_ASSERT
(
GetApzc
(
)
!
=
nullptr
)
;
if
(
IsPrimaryHolder
(
)
)
{
GetApzc
(
)
-
>
SetParent
(
aParent
)
;
}
else
{
MOZ_ASSERT
(
GetApzc
(
)
-
>
GetParent
(
)
=
=
aParent
)
;
}
}
}
}
