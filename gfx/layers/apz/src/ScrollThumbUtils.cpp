#
include
"
ScrollThumbUtils
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
mozilla
/
gfx
/
Matrix
.
h
"
namespace
mozilla
{
namespace
layers
{
namespace
apz
{
struct
AsyncScrollThumbTransformer
{
const
LayerToParentLayerMatrix4x4
&
mCurrentTransform
;
const
gfx
:
:
Matrix4x4
&
mScrollableContentTransform
;
AsyncPanZoomController
*
mApzc
;
const
FrameMetrics
&
mMetrics
;
const
ScrollbarData
&
mScrollbarData
;
bool
mScrollbarIsDescendant
;
AsyncTransformComponentMatrix
mAsyncTransform
;
AsyncTransformComponentMatrix
mScrollbarTransform
;
CSSToParentLayerScale
mEffectiveZoom
;
float
mUnitlessThumbRatio
;
LayerToParentLayerMatrix4x4
ComputeTransform
(
)
;
private
:
void
ApplyTransformForAxis
(
const
Axis
&
aAxis
)
;
enum
class
ScrollThumbExtent
{
Start
End
}
;
void
ScaleThumbBy
(
const
Axis
&
aAxis
float
aScale
ScrollThumbExtent
aExtent
)
;
}
;
void
AsyncScrollThumbTransformer
:
:
ScaleThumbBy
(
const
Axis
&
aAxis
float
aScale
ScrollThumbExtent
aExtent
)
{
CSSCoord
thumbExtentRelativeToCompBounds
=
(
aAxis
.
GetPointOffset
(
mMetrics
.
GetVisualScrollOffset
(
)
)
*
mUnitlessThumbRatio
)
;
CSSCoord
compBoundsOrigin
=
aAxis
.
GetPointOffset
(
mMetrics
.
CalculateCompositionBoundsInCssPixelsOfSurroundingContent
(
)
.
TopLeft
(
)
)
;
CSSCoord
thumbExtent
=
compBoundsOrigin
+
thumbExtentRelativeToCompBounds
;
if
(
aExtent
=
=
ScrollThumbExtent
:
:
End
)
{
thumbExtent
+
=
mScrollbarData
.
mThumbLength
;
}
const
CSSCoord
thumbExtentScaled
=
thumbExtent
*
aScale
;
const
CSSCoord
thumbExtentDelta
=
thumbExtentScaled
-
thumbExtent
;
const
ParentLayerCoord
thumbExtentDeltaPL
=
thumbExtentDelta
*
mEffectiveZoom
;
aAxis
.
PostScale
(
mScrollbarTransform
aScale
)
;
aAxis
.
PostTranslate
(
mScrollbarTransform
-
thumbExtentDeltaPL
)
;
}
void
AsyncScrollThumbTransformer
:
:
ApplyTransformForAxis
(
const
Axis
&
aAxis
)
{
ParentLayerCoord
asyncScroll
=
aAxis
.
GetTransformTranslation
(
mAsyncTransform
)
;
const
float
asyncZoom
=
aAxis
.
GetTransformScale
(
mAsyncTransform
)
;
const
float
scale
=
1
.
f
/
asyncZoom
;
mEffectiveZoom
=
CSSToParentLayerScale
(
mMetrics
.
GetZoom
(
)
.
scale
*
asyncZoom
)
;
if
(
gfxPlatform
:
:
UseDesktopZoomingScrollbars
(
)
)
{
asyncScroll
-
=
aAxis
.
GetPointOffset
(
(
mMetrics
.
GetLayoutScrollOffset
(
)
-
mMetrics
.
GetVisualScrollOffset
(
)
)
*
mEffectiveZoom
)
;
}
mUnitlessThumbRatio
=
mScrollbarData
.
mThumbRatio
/
(
mMetrics
.
GetPresShellResolution
(
)
*
asyncZoom
)
;
ParentLayerCoord
translation
=
-
asyncScroll
*
mUnitlessThumbRatio
;
translation
/
=
(
mMetrics
.
GetCumulativeResolution
(
)
.
scale
/
mMetrics
.
GetPresShellResolution
(
)
)
;
ScaleThumbBy
(
aAxis
scale
ScrollThumbExtent
:
:
Start
)
;
ParentLayerCoord
overscroll
=
aAxis
.
GetPointOffset
(
mApzc
-
>
GetOverscrollAmount
(
)
)
;
if
(
overscroll
!
=
0
)
{
float
overscrollScale
=
1
.
0f
-
(
std
:
:
abs
(
overscroll
.
value
)
/
aAxis
.
GetRectLength
(
mMetrics
.
GetCompositionBounds
(
)
)
)
;
MOZ_ASSERT
(
overscrollScale
>
0
.
0f
&
&
overscrollScale
<
=
1
.
0f
)
;
ScaleThumbBy
(
aAxis
overscrollScale
overscroll
<
0
?
ScrollThumbExtent
:
:
Start
:
ScrollThumbExtent
:
:
End
)
;
}
aAxis
.
PostTranslate
(
mScrollbarTransform
translation
)
;
}
LayerToParentLayerMatrix4x4
AsyncScrollThumbTransformer
:
:
ComputeTransform
(
)
{
if
(
mMetrics
.
IsScrollInfoLayer
(
)
)
{
return
LayerToParentLayerMatrix4x4
{
}
;
}
MOZ_RELEASE_ASSERT
(
mApzc
)
;
mAsyncTransform
=
mApzc
-
>
GetCurrentAsyncTransform
(
AsyncPanZoomController
:
:
eForCompositing
)
;
if
(
*
mScrollbarData
.
mDirection
=
=
ScrollDirection
:
:
eVertical
)
{
ApplyTransformForAxis
(
mApzc
-
>
mY
)
;
}
if
(
*
mScrollbarData
.
mDirection
=
=
ScrollDirection
:
:
eHorizontal
)
{
ApplyTransformForAxis
(
mApzc
-
>
mX
)
;
}
LayerToParentLayerMatrix4x4
transform
=
mCurrentTransform
*
mScrollbarTransform
;
AsyncTransformComponentMatrix
compensation
;
if
(
mScrollbarIsDescendant
)
{
AsyncTransformComponentMatrix
overscroll
=
mApzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForCompositing
)
;
gfx
:
:
Matrix4x4
asyncUntransform
=
(
mAsyncTransform
*
overscroll
)
.
Inverse
(
)
.
ToUnknownMatrix
(
)
;
const
gfx
:
:
Matrix4x4
&
contentTransform
=
mScrollableContentTransform
;
gfx
:
:
Matrix4x4
contentUntransform
=
contentTransform
.
Inverse
(
)
;
compensation
*
=
ViewAs
<
AsyncTransformComponentMatrix
>
(
contentTransform
*
asyncUntransform
*
contentUntransform
)
;
}
transform
=
transform
*
compensation
;
return
transform
;
}
LayerToParentLayerMatrix4x4
ComputeTransformForScrollThumb
(
const
LayerToParentLayerMatrix4x4
&
aCurrentTransform
const
gfx
:
:
Matrix4x4
&
aScrollableContentTransform
AsyncPanZoomController
*
aApzc
const
FrameMetrics
&
aMetrics
const
ScrollbarData
&
aScrollbarData
bool
aScrollbarIsDescendant
)
{
return
AsyncScrollThumbTransformer
{
aCurrentTransform
aScrollableContentTransform
aApzc
aMetrics
aScrollbarData
aScrollbarIsDescendant
}
.
ComputeTransform
(
)
;
}
}
}
}
