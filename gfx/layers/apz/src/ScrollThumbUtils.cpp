#
include
"
ScrollThumbUtils
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
mozilla
/
gfx
/
Matrix
.
h
"
namespace
mozilla
{
namespace
layers
{
namespace
apz
{
struct
AsyncScrollThumbTransformer
{
const
LayerToParentLayerMatrix4x4
&
mCurrentTransform
;
const
gfx
:
:
Matrix4x4
&
mScrollableContentTransform
;
AsyncPanZoomController
*
mApzc
;
const
FrameMetrics
&
mMetrics
;
const
ScrollbarData
&
mScrollbarData
;
bool
mScrollbarIsDescendant
;
AsyncTransformComponentMatrix
*
mOutClipTransform
;
AsyncTransformComponentMatrix
mAsyncTransform
;
AsyncTransformComponentMatrix
mScrollbarTransform
;
CSSToParentLayerScale
mEffectiveZoom
;
float
mUnitlessThumbRatio
;
LayerToParentLayerMatrix4x4
ComputeTransform
(
)
;
private
:
void
ApplyTransformForAxis
(
const
Axis
&
aAxis
)
;
void
ScaleThumbBy
(
const
Axis
&
aAxis
float
aScale
)
;
}
;
void
AsyncScrollThumbTransformer
:
:
ScaleThumbBy
(
const
Axis
&
aAxis
float
aScale
)
{
CSSCoord
thumbOriginRelativeToCompBounds
=
(
aAxis
.
GetPointOffset
(
mMetrics
.
GetVisualScrollOffset
(
)
)
*
mUnitlessThumbRatio
)
;
CSSCoord
compBoundsOrigin
=
aAxis
.
GetPointOffset
(
mMetrics
.
CalculateCompositionBoundsInCssPixelsOfSurroundingContent
(
)
.
TopLeft
(
)
)
;
CSSCoord
thumbOrigin
=
compBoundsOrigin
+
thumbOriginRelativeToCompBounds
;
const
CSSCoord
thumbOriginScaled
=
thumbOrigin
*
aScale
;
const
CSSCoord
thumbOriginDelta
=
thumbOriginScaled
-
thumbOrigin
;
const
ParentLayerCoord
thumbOriginDeltaPL
=
thumbOriginDelta
*
mEffectiveZoom
;
aAxis
.
PostScale
(
mScrollbarTransform
aScale
)
;
aAxis
.
PostTranslate
(
mScrollbarTransform
-
thumbOriginDeltaPL
)
;
}
void
AsyncScrollThumbTransformer
:
:
ApplyTransformForAxis
(
const
Axis
&
aAxis
)
{
ParentLayerCoord
asyncScroll
=
aAxis
.
GetTransformTranslation
(
mAsyncTransform
)
;
const
float
asyncZoom
=
aAxis
.
GetTransformScale
(
mAsyncTransform
)
;
const
float
scale
=
1
.
f
/
asyncZoom
;
mEffectiveZoom
=
CSSToParentLayerScale
(
aAxis
.
GetAxisScale
(
mMetrics
.
GetZoom
(
)
)
.
scale
*
asyncZoom
)
;
if
(
gfxPlatform
:
:
UseDesktopZoomingScrollbars
(
)
)
{
asyncScroll
-
=
aAxis
.
GetPointOffset
(
(
mMetrics
.
GetLayoutScrollOffset
(
)
-
mMetrics
.
GetVisualScrollOffset
(
)
)
*
mEffectiveZoom
)
;
}
mUnitlessThumbRatio
=
mScrollbarData
.
mThumbRatio
/
(
mMetrics
.
GetPresShellResolution
(
)
*
asyncZoom
)
;
ParentLayerCoord
translation
=
-
asyncScroll
*
mUnitlessThumbRatio
;
ScaleThumbBy
(
aAxis
scale
)
;
aAxis
.
PostTranslate
(
mScrollbarTransform
translation
)
;
}
LayerToParentLayerMatrix4x4
AsyncScrollThumbTransformer
:
:
ComputeTransform
(
)
{
if
(
mMetrics
.
IsScrollInfoLayer
(
)
)
{
return
LayerToParentLayerMatrix4x4
{
}
;
}
MOZ_RELEASE_ASSERT
(
mApzc
)
;
mAsyncTransform
=
mApzc
-
>
GetCurrentAsyncTransform
(
AsyncPanZoomController
:
:
eForCompositing
)
;
if
(
*
mScrollbarData
.
mDirection
=
=
ScrollDirection
:
:
eVertical
)
{
ApplyTransformForAxis
(
mApzc
-
>
mY
)
;
}
if
(
*
mScrollbarData
.
mDirection
=
=
ScrollDirection
:
:
eHorizontal
)
{
ApplyTransformForAxis
(
mApzc
-
>
mX
)
;
}
LayerToParentLayerMatrix4x4
transform
=
mCurrentTransform
*
mScrollbarTransform
;
AsyncTransformComponentMatrix
compensation
;
if
(
mScrollbarIsDescendant
)
{
AsyncTransformComponentMatrix
overscroll
=
mApzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForCompositing
)
;
gfx
:
:
Matrix4x4
asyncUntransform
=
(
mAsyncTransform
*
overscroll
)
.
Inverse
(
)
.
ToUnknownMatrix
(
)
;
const
gfx
:
:
Matrix4x4
&
contentTransform
=
mScrollableContentTransform
;
gfx
:
:
Matrix4x4
contentUntransform
=
contentTransform
.
Inverse
(
)
;
compensation
*
=
ViewAs
<
AsyncTransformComponentMatrix
>
(
contentTransform
*
asyncUntransform
*
contentUntransform
)
;
if
(
mOutClipTransform
)
{
*
mOutClipTransform
=
compensation
;
}
}
transform
=
transform
*
compensation
;
return
transform
;
}
LayerToParentLayerMatrix4x4
ComputeTransformForScrollThumb
(
const
LayerToParentLayerMatrix4x4
&
aCurrentTransform
const
gfx
:
:
Matrix4x4
&
aScrollableContentTransform
AsyncPanZoomController
*
aApzc
const
FrameMetrics
&
aMetrics
const
ScrollbarData
&
aScrollbarData
bool
aScrollbarIsDescendant
AsyncTransformComponentMatrix
*
aOutClipTransform
)
{
return
AsyncScrollThumbTransformer
{
aCurrentTransform
aScrollableContentTransform
aApzc
aMetrics
aScrollbarData
aScrollbarIsDescendant
aOutClipTransform
}
.
ComputeTransform
(
)
;
}
}
}
}
