#
include
"
mozilla
/
layers
/
APZPublicUtils
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
mozilla
/
HelperMacros
.
h
"
#
include
"
mozilla
/
StaticPrefs_general
.
h
"
namespace
mozilla
{
namespace
layers
{
namespace
apz
{
void
InitializeGlobalState
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
AsyncPanZoomController
:
:
InitializeGlobalState
(
)
;
}
const
ScreenMargin
CalculatePendingDisplayPort
(
const
FrameMetrics
&
aFrameMetrics
const
ParentLayerPoint
&
aVelocity
)
{
return
AsyncPanZoomController
:
:
CalculatePendingDisplayPort
(
aFrameMetrics
aVelocity
AsyncPanZoomController
:
:
ZoomInProgress
:
:
No
)
;
}
gfx
:
:
IntSize
GetDisplayportAlignmentMultiplier
(
const
ScreenSize
&
aBaseSize
)
{
return
AsyncPanZoomController
:
:
GetDisplayportAlignmentMultiplier
(
aBaseSize
)
;
}
ScrollAnimationBezierPhysicsSettings
ComputeBezierAnimationSettingsForOrigin
(
ScrollOrigin
aOrigin
)
{
int32_t
minMS
=
0
;
int32_t
maxMS
=
0
;
bool
isOriginSmoothnessEnabled
=
false
;
bool
isGeneralSmoothnessEnabled
=
nsLayoutUtils
:
:
IsSmoothScrollingEnabled
(
)
;
#
define
READ_DURATIONS
(
prefbase
)
\
isOriginSmoothnessEnabled
=
isGeneralSmoothnessEnabled
&
&
\
StaticPrefs
:
:
general_smoothScroll_
#
#
prefbase
(
)
;
\
if
(
isOriginSmoothnessEnabled
)
{
\
minMS
=
StaticPrefs
:
:
general_smoothScroll_
#
#
prefbase
#
#
_durationMinMS
(
)
;
\
maxMS
=
StaticPrefs
:
:
general_smoothScroll_
#
#
prefbase
#
#
_durationMaxMS
(
)
;
\
}
switch
(
aOrigin
)
{
case
ScrollOrigin
:
:
Pixels
:
READ_DURATIONS
(
pixels
)
break
;
case
ScrollOrigin
:
:
Lines
:
READ_DURATIONS
(
lines
)
break
;
case
ScrollOrigin
:
:
Pages
:
READ_DURATIONS
(
pages
)
break
;
case
ScrollOrigin
:
:
MouseWheel
:
READ_DURATIONS
(
mouseWheel
)
break
;
case
ScrollOrigin
:
:
Scrollbars
:
READ_DURATIONS
(
scrollbars
)
break
;
default
:
READ_DURATIONS
(
other
)
break
;
}
#
undef
READ_DURATIONS
if
(
isOriginSmoothnessEnabled
)
{
static
const
int32_t
kSmoothScrollMaxAllowedAnimationDurationMS
=
10000
;
maxMS
=
clamped
(
maxMS
0
kSmoothScrollMaxAllowedAnimationDurationMS
)
;
minMS
=
clamped
(
minMS
0
maxMS
)
;
}
double
intervalRatio
=
(
(
double
)
StaticPrefs
:
:
general_smoothScroll_durationToIntervalRatio
(
)
)
/
100
.
0
;
intervalRatio
=
std
:
:
max
(
1
.
0
intervalRatio
)
;
return
ScrollAnimationBezierPhysicsSettings
{
minMS
maxMS
intervalRatio
}
;
}
ScrollMode
GetScrollModeForOrigin
(
ScrollOrigin
origin
)
{
bool
isSmoothScrollingEnabled
=
nsLayoutUtils
:
:
IsSmoothScrollingEnabled
(
)
;
if
(
!
isSmoothScrollingEnabled
)
return
ScrollMode
:
:
Instant
;
switch
(
origin
)
{
case
ScrollOrigin
:
:
Lines
:
return
StaticPrefs
:
:
general_smoothScroll_lines
(
)
?
ScrollMode
:
:
Smooth
:
ScrollMode
:
:
Instant
;
case
ScrollOrigin
:
:
Pages
:
return
StaticPrefs
:
:
general_smoothScroll_pages
(
)
?
ScrollMode
:
:
Smooth
:
ScrollMode
:
:
Instant
;
case
ScrollOrigin
:
:
Other
:
return
StaticPrefs
:
:
general_smoothScroll_other
(
)
?
ScrollMode
:
:
Smooth
:
ScrollMode
:
:
Instant
;
default
:
MOZ_ASSERT
(
false
"
Unknown
keyboard
scroll
origin
"
)
;
return
isSmoothScrollingEnabled
?
ScrollMode
:
:
Smooth
:
ScrollMode
:
:
Instant
;
}
}
}
}
}
