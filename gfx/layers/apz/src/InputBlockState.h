#
ifndef
mozilla_layers_InputBlockState_h
#
define
mozilla_layers_InputBlockState_h
#
include
"
InputData
.
h
"
#
include
"
mozilla
/
RefCounted
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
StaticPrefs_apz
.
h
"
#
include
"
mozilla
/
gfx
/
Matrix
.
h
"
#
include
"
mozilla
/
layers
/
APZUtils
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
#
include
"
mozilla
/
layers
/
AsyncDragMetrics
.
h
"
#
include
"
mozilla
/
layers
/
TouchCounter
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsTArray
.
h
"
namespace
mozilla
{
namespace
layers
{
class
AsyncPanZoomController
;
class
OverscrollHandoffChain
;
class
CancelableBlockState
;
class
TouchBlockState
;
class
WheelBlockState
;
class
DragBlockState
;
class
PanGestureBlockState
;
class
KeyboardBlockState
;
class
InputBlockState
:
public
RefCounted
<
InputBlockState
>
{
public
:
MOZ_DECLARE_REFCOUNTED_TYPENAME
(
InputBlockState
)
static
const
uint64_t
NO_BLOCK_ID
=
0
;
enum
class
TargetConfirmationState
:
uint8_t
{
eUnconfirmed
eTimedOut
eTimedOutAndMainThreadResponded
eConfirmed
}
;
InputBlockState
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationFlags
aFlags
)
;
virtual
~
InputBlockState
(
)
=
default
;
virtual
CancelableBlockState
*
AsCancelableBlock
(
)
{
return
nullptr
;
}
virtual
TouchBlockState
*
AsTouchBlock
(
)
{
return
nullptr
;
}
virtual
WheelBlockState
*
AsWheelBlock
(
)
{
return
nullptr
;
}
virtual
DragBlockState
*
AsDragBlock
(
)
{
return
nullptr
;
}
virtual
PanGestureBlockState
*
AsPanGestureBlock
(
)
{
return
nullptr
;
}
virtual
KeyboardBlockState
*
AsKeyboardBlock
(
)
{
return
nullptr
;
}
virtual
bool
SetConfirmedTargetApzc
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationState
aState
InputData
*
aFirstInput
bool
aForScrollbarDrag
)
;
const
RefPtr
<
AsyncPanZoomController
>
&
GetTargetApzc
(
)
const
;
const
RefPtr
<
const
OverscrollHandoffChain
>
&
GetOverscrollHandoffChain
(
)
const
;
uint64_t
GetBlockId
(
)
const
;
bool
IsTargetConfirmed
(
)
const
;
bool
HasReceivedRealConfirmedTarget
(
)
const
;
virtual
bool
ShouldDropEvents
(
)
const
;
void
SetScrolledApzc
(
AsyncPanZoomController
*
aApzc
)
;
AsyncPanZoomController
*
GetScrolledApzc
(
)
const
;
bool
IsDownchainOfScrolledApzc
(
AsyncPanZoomController
*
aApzc
)
const
;
virtual
void
DispatchEvent
(
const
InputData
&
aEvent
)
const
;
virtual
bool
MustStayActive
(
)
=
0
;
protected
:
virtual
void
UpdateTargetApzc
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
)
;
private
:
bool
IsDownchainOf
(
AsyncPanZoomController
*
aA
AsyncPanZoomController
*
aB
)
const
;
private
:
RefPtr
<
AsyncPanZoomController
>
mTargetApzc
;
TargetConfirmationState
mTargetConfirmed
;
bool
mRequiresTargetConfirmation
;
const
uint64_t
mBlockId
;
RefPtr
<
AsyncPanZoomController
>
mScrolledApzc
;
protected
:
RefPtr
<
const
OverscrollHandoffChain
>
mOverscrollHandoffChain
;
ScreenToParentLayerMatrix4x4
mTransformToApzc
;
}
;
class
CancelableBlockState
:
public
InputBlockState
{
public
:
CancelableBlockState
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationFlags
aFlags
)
;
CancelableBlockState
*
AsCancelableBlock
(
)
override
{
return
this
;
}
virtual
bool
SetContentResponse
(
bool
aPreventDefault
)
;
void
StartContentResponseTimer
(
)
;
void
RecordContentResponseTime
(
)
;
bool
TimeoutContentResponse
(
)
;
bool
IsContentResponseTimerExpired
(
)
const
;
bool
IsDefaultPrevented
(
)
const
;
virtual
bool
HasReceivedAllContentNotifications
(
)
const
;
virtual
bool
IsReadyForHandling
(
)
const
;
virtual
const
char
*
Type
(
)
=
0
;
bool
ShouldDropEvents
(
)
const
override
;
private
:
TimeStamp
mContentResponseTimer
;
bool
mPreventDefault
;
bool
mContentResponded
;
bool
mContentResponseTimerExpired
;
}
;
class
WheelBlockState
:
public
CancelableBlockState
{
public
:
WheelBlockState
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationFlags
aFlags
const
ScrollWheelInput
&
aEvent
)
;
bool
SetContentResponse
(
bool
aPreventDefault
)
override
;
bool
MustStayActive
(
)
override
;
const
char
*
Type
(
)
override
;
bool
SetConfirmedTargetApzc
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationState
aState
InputData
*
aFirstInput
bool
aForScrollbarDrag
)
override
;
WheelBlockState
*
AsWheelBlock
(
)
override
{
return
this
;
}
bool
ShouldAcceptNewEvent
(
)
const
;
bool
MaybeTimeout
(
const
ScrollWheelInput
&
aEvent
)
;
void
OnMouseMove
(
const
ScreenIntPoint
&
aPoint
)
;
bool
InTransaction
(
)
const
;
void
EndTransaction
(
)
;
bool
AllowScrollHandoff
(
)
const
;
bool
MaybeTimeout
(
const
TimeStamp
&
aTimeStamp
)
;
void
Update
(
ScrollWheelInput
&
aEvent
)
;
ScrollDirections
GetAllowedScrollDirections
(
)
const
{
return
mAllowedScrollDirections
;
}
protected
:
void
UpdateTargetApzc
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
)
override
;
private
:
TimeStamp
mLastEventTime
;
TimeStamp
mLastMouseMove
;
uint32_t
mScrollSeriesCounter
;
bool
mTransactionEnded
;
ScrollDirections
mAllowedScrollDirections
;
}
;
class
DragBlockState
:
public
CancelableBlockState
{
public
:
DragBlockState
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationFlags
aFlags
const
MouseInput
&
aEvent
)
;
bool
MustStayActive
(
)
override
;
const
char
*
Type
(
)
override
;
bool
HasReceivedMouseUp
(
)
;
void
MarkMouseUpReceived
(
)
;
DragBlockState
*
AsDragBlock
(
)
override
{
return
this
;
}
void
SetInitialThumbPos
(
CSSCoord
aThumbPos
)
;
void
SetDragMetrics
(
const
AsyncDragMetrics
&
aDragMetrics
)
;
void
DispatchEvent
(
const
InputData
&
aEvent
)
const
override
;
private
:
AsyncDragMetrics
mDragMetrics
;
CSSCoord
mInitialThumbPos
;
bool
mReceivedMouseUp
;
}
;
class
PanGestureBlockState
:
public
CancelableBlockState
{
public
:
PanGestureBlockState
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationFlags
aFlags
const
PanGestureInput
&
aEvent
)
;
bool
SetContentResponse
(
bool
aPreventDefault
)
override
;
bool
HasReceivedAllContentNotifications
(
)
const
override
;
bool
IsReadyForHandling
(
)
const
override
;
bool
MustStayActive
(
)
override
;
const
char
*
Type
(
)
override
;
bool
SetConfirmedTargetApzc
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationState
aState
InputData
*
aFirstInput
bool
aForScrollbarDrag
)
override
;
PanGestureBlockState
*
AsPanGestureBlock
(
)
override
{
return
this
;
}
bool
AllowScrollHandoff
(
)
const
;
bool
WasInterrupted
(
)
const
{
return
mInterrupted
;
}
void
SetNeedsToWaitForContentResponse
(
bool
aWaitForContentResponse
)
;
ScrollDirections
GetAllowedScrollDirections
(
)
const
{
return
mAllowedScrollDirections
;
}
private
:
bool
mInterrupted
;
bool
mWaitingForContentResponse
;
ScrollDirections
mAllowedScrollDirections
;
}
;
class
TouchBlockState
:
public
CancelableBlockState
{
public
:
explicit
TouchBlockState
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
TargetConfirmationFlags
aFlags
TouchCounter
&
aTouchCounter
)
;
TouchBlockState
*
AsTouchBlock
(
)
override
{
return
this
;
}
bool
SetAllowedTouchBehaviors
(
const
nsTArray
<
TouchBehaviorFlags
>
&
aBehaviors
)
;
bool
GetAllowedTouchBehaviors
(
nsTArray
<
TouchBehaviorFlags
>
&
aOutBehaviors
)
const
;
bool
HasAllowedTouchBehaviors
(
)
const
;
void
CopyPropertiesFrom
(
const
TouchBlockState
&
aOther
)
;
bool
HasReceivedAllContentNotifications
(
)
const
override
;
bool
IsReadyForHandling
(
)
const
override
;
void
SetDuringFastFling
(
)
;
bool
IsDuringFastFling
(
)
const
;
void
SetSingleTapOccurred
(
)
;
bool
SingleTapOccurred
(
)
const
;
bool
TouchActionAllowsPinchZoom
(
)
const
;
bool
TouchActionAllowsDoubleTapZoom
(
)
const
;
bool
TouchActionAllowsPanningX
(
)
const
;
bool
TouchActionAllowsPanningY
(
)
const
;
bool
TouchActionAllowsPanningXY
(
)
const
;
bool
UpdateSlopState
(
const
MultiTouchInput
&
aInput
bool
aApzcCanConsumeEvents
)
;
Maybe
<
ScrollDirection
>
GetBestGuessPanDirection
(
const
MultiTouchInput
&
aInput
)
;
uint32_t
GetActiveTouchCount
(
)
const
;
void
DispatchEvent
(
const
InputData
&
aEvent
)
const
override
;
bool
MustStayActive
(
)
override
;
const
char
*
Type
(
)
override
;
private
:
nsTArray
<
TouchBehaviorFlags
>
mAllowedTouchBehaviors
;
bool
mAllowedTouchBehaviorSet
;
bool
mDuringFastFling
;
bool
mSingleTapOccurred
;
bool
mInSlop
;
ScreenIntPoint
mSlopOrigin
;
TouchCounter
&
mTouchCounter
;
}
;
class
KeyboardBlockState
:
public
InputBlockState
{
public
:
explicit
KeyboardBlockState
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
)
;
KeyboardBlockState
*
AsKeyboardBlock
(
)
override
{
return
this
;
}
bool
MustStayActive
(
)
override
{
return
false
;
}
bool
AllowScrollHandoff
(
)
const
{
return
false
;
}
}
;
}
}
#
endif
