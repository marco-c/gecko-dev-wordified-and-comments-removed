#
ifndef
mozilla_layers_APZUtils_h
#
define
mozilla_layers_APZUtils_h
#
include
<
stdint
.
h
>
#
include
<
type_traits
>
#
include
"
gfxTypes
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
LayersTypes
.
h
"
#
include
"
UnitTransforms
.
h
"
#
include
"
mozilla
/
gfx
/
CompositorHitTestInfo
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
DefineEnum
.
h
"
#
include
"
mozilla
/
EnumSet
.
h
"
#
include
"
mozilla
/
FloatingPoint
.
h
"
namespace
mozilla
{
namespace
layers
{
enum
CancelAnimationFlags
:
uint32_t
{
Default
=
0x0
ExcludeOverscroll
=
0x1
ScrollSnap
=
0x2
ExcludeWheel
=
0x4
TriggeredExternally
=
0x8
}
;
inline
CancelAnimationFlags
operator
|
(
CancelAnimationFlags
a
CancelAnimationFlags
b
)
{
return
static_cast
<
CancelAnimationFlags
>
(
static_cast
<
int
>
(
a
)
|
static_cast
<
int
>
(
b
)
)
;
}
enum
class
ScrollSource
{
Touchscreen
Touchpad
Wheel
Keyboard
}
;
inline
bool
ScrollSourceRespectsDisregardedDirections
(
ScrollSource
aSource
)
{
return
aSource
=
=
ScrollSource
:
:
Wheel
|
|
aSource
=
=
ScrollSource
:
:
Touchpad
;
}
inline
bool
ScrollSourceAllowsOverscroll
(
ScrollSource
aSource
)
{
return
aSource
=
=
ScrollSource
:
:
Touchpad
|
|
aSource
=
=
ScrollSource
:
:
Touchscreen
;
}
const
CSSCoord
COORDINATE_EPSILON
=
0
.
02f
;
inline
bool
IsZero
(
const
CSSPoint
&
aPoint
)
{
return
FuzzyEqualsAdditive
(
aPoint
.
x
0
.
0f
COORDINATE_EPSILON
.
value
)
&
&
FuzzyEqualsAdditive
(
aPoint
.
y
0
.
0f
COORDINATE_EPSILON
.
value
)
;
}
struct
AsyncTransform
{
explicit
AsyncTransform
(
LayerToParentLayerScale
aScale
=
LayerToParentLayerScale
(
)
ParentLayerPoint
aTranslation
=
ParentLayerPoint
(
)
)
:
mScale
(
aScale
)
mTranslation
(
aTranslation
)
{
}
operator
AsyncTransformComponentMatrix
(
)
const
{
return
AsyncTransformComponentMatrix
:
:
Scaling
(
mScale
.
scale
mScale
.
scale
1
)
.
PostTranslate
(
mTranslation
.
x
mTranslation
.
y
0
)
;
}
bool
operator
=
=
(
const
AsyncTransform
&
rhs
)
const
{
return
mTranslation
=
=
rhs
.
mTranslation
&
&
mScale
=
=
rhs
.
mScale
;
}
bool
operator
!
=
(
const
AsyncTransform
&
rhs
)
const
{
return
!
(
*
this
=
=
rhs
)
;
}
LayerToParentLayerScale
mScale
;
ParentLayerPoint
mTranslation
;
}
;
inline
AsyncTransformMatrix
CompleteAsyncTransform
(
const
AsyncTransformComponentMatrix
&
aMatrix
)
{
return
ViewAs
<
AsyncTransformMatrix
>
(
aMatrix
PixelCastJustification
:
:
MultipleAsyncTransforms
)
;
}
struct
TargetConfirmationFlags
final
{
explicit
TargetConfirmationFlags
(
bool
aTargetConfirmed
)
:
mTargetConfirmed
(
aTargetConfirmed
)
mRequiresTargetConfirmation
(
false
)
mHitScrollbar
(
false
)
mHitScrollThumb
(
false
)
mDispatchToContent
(
false
)
{
}
explicit
TargetConfirmationFlags
(
const
gfx
:
:
CompositorHitTestInfo
&
aHitTestInfo
)
:
mTargetConfirmed
(
(
aHitTestInfo
!
=
gfx
:
:
CompositorHitTestInvisibleToHit
)
&
&
(
aHitTestInfo
&
gfx
:
:
CompositorHitTestDispatchToContent
)
.
isEmpty
(
)
)
mRequiresTargetConfirmation
(
aHitTestInfo
.
contains
(
gfx
:
:
CompositorHitTestFlags
:
:
eRequiresTargetConfirmation
)
)
mHitScrollbar
(
aHitTestInfo
.
contains
(
gfx
:
:
CompositorHitTestFlags
:
:
eScrollbar
)
)
mHitScrollThumb
(
aHitTestInfo
.
contains
(
gfx
:
:
CompositorHitTestFlags
:
:
eScrollbarThumb
)
)
mDispatchToContent
(
!
(
aHitTestInfo
&
gfx
:
:
CompositorHitTestDispatchToContent
)
.
isEmpty
(
)
)
{
}
bool
mTargetConfirmed
:
1
;
bool
mRequiresTargetConfirmation
:
1
;
bool
mHitScrollbar
:
1
;
bool
mHitScrollThumb
:
1
;
bool
mDispatchToContent
:
1
;
}
;
enum
class
AsyncTransformComponent
{
eLayout
eVisual
}
;
using
AsyncTransformComponents
=
EnumSet
<
AsyncTransformComponent
>
;
constexpr
AsyncTransformComponents
LayoutAndVisual
(
AsyncTransformComponent
:
:
eLayout
AsyncTransformComponent
:
:
eVisual
)
;
struct
GeckoViewMetrics
{
CSSPoint
mVisualScrollOffset
;
CSSToParentLayerScale
mZoom
;
}
;
namespace
apz
{
bool
IsCloseToHorizontal
(
float
aAngle
float
aThreshold
)
;
bool
IsCloseToVertical
(
float
aAngle
float
aThreshold
)
;
bool
IsStuckAtBottom
(
gfxFloat
aTranslation
const
LayerRectAbsolute
&
aInnerRange
const
LayerRectAbsolute
&
aOuterRange
)
;
bool
IsStuckAtTop
(
gfxFloat
aTranslation
const
LayerRectAbsolute
&
aInnerRange
const
LayerRectAbsolute
&
aOuterRange
)
;
ScreenPoint
ComputeFixedMarginsOffset
(
const
ScreenMargin
&
aCompositorFixedLayerMargins
SideBits
aFixedSides
const
ScreenMargin
&
aGeckoFixedLayerMargins
)
;
bool
AboutToCheckerboard
(
const
FrameMetrics
&
aPaintedMetrics
const
FrameMetrics
&
aCompositorMetrics
)
;
SideBits
GetOverscrollSideBits
(
const
ParentLayerPoint
&
aOverscrollAmount
)
;
}
}
}
#
endif
