#
include
"
APZCTreeManager
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
Compositor
.
h
"
#
include
"
gfxPrefs
.
h
"
#
include
"
HitTestingTreeNode
.
h
"
#
include
"
InputBlockState
.
h
"
#
include
"
InputData
.
h
"
#
include
"
Layers
.
h
"
#
include
"
mozilla
/
dom
/
Touch
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
layers
/
APZThreadUtils
.
h
"
#
include
"
mozilla
/
layers
/
AsyncCompositionManager
.
h
"
#
include
"
mozilla
/
layers
/
AsyncDragMetrics
.
h
"
#
include
"
mozilla
/
layers
/
CompositorParent
.
h
"
#
include
"
mozilla
/
layers
/
LayerMetricsWrapper
.
h
"
#
include
"
mozilla
/
MouseEvents
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
mozilla
/
TouchEvents
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
EventStateManager
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsPoint
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
OverscrollHandoffState
.
h
"
#
include
"
TaskThrottler
.
h
"
#
include
"
TreeTraversal
.
h
"
#
include
"
LayersLogging
.
h
"
#
include
"
Units
.
h
"
#
include
"
GestureEventListener
.
h
"
#
include
"
UnitTransforms
.
h
"
#
define
ENABLE_APZCTM_LOGGING
0
#
if
ENABLE_APZCTM_LOGGING
#
define
APZCTM_LOG
(
.
.
.
)
printf_stderr
(
"
APZCTM
:
"
__VA_ARGS__
)
#
else
#
define
APZCTM_LOG
(
.
.
.
)
#
endif
namespace
mozilla
{
namespace
layers
{
typedef
mozilla
:
:
gfx
:
:
Point
Point
;
typedef
mozilla
:
:
gfx
:
:
Point4D
Point4D
;
typedef
mozilla
:
:
gfx
:
:
Matrix4x4
Matrix4x4
;
float
APZCTreeManager
:
:
sDPI
=
160
.
0
;
struct
APZCTreeManager
:
:
TreeBuildingState
{
TreeBuildingState
(
CompositorParent
*
aCompositor
bool
aIsFirstPaint
uint64_t
aOriginatingLayersId
APZTestData
*
aTestData
uint32_t
aPaintSequence
)
:
mCompositor
(
aCompositor
)
mIsFirstPaint
(
aIsFirstPaint
)
mOriginatingLayersId
(
aOriginatingLayersId
)
mPaintLogger
(
aTestData
aPaintSequence
)
{
}
CompositorParent
*
const
mCompositor
;
const
bool
mIsFirstPaint
;
const
uint64_t
mOriginatingLayersId
;
const
APZPaintLogHelper
mPaintLogger
;
nsTArray
<
RefPtr
<
HitTestingTreeNode
>
>
mNodesToDestroy
;
std
:
:
map
<
ScrollableLayerGuid
AsyncPanZoomController
*
>
mApzcMap
;
}
;
const
ScreenMargin
APZCTreeManager
:
:
CalculatePendingDisplayPort
(
const
FrameMetrics
&
aFrameMetrics
const
ParentLayerPoint
&
aVelocity
double
aEstimatedPaintDuration
)
{
return
AsyncPanZoomController
:
:
CalculatePendingDisplayPort
(
aFrameMetrics
aVelocity
aEstimatedPaintDuration
)
;
}
APZCTreeManager
:
:
APZCTreeManager
(
)
:
mInputQueue
(
new
InputQueue
(
)
)
mTreeLock
(
"
APZCTreeLock
"
)
mHitResultForInputBlock
(
HitNothing
)
mRetainedTouchIdentifier
(
-
1
)
mApzcTreeLog
(
"
apzctree
"
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
AsyncPanZoomController
:
:
InitializeGlobalState
(
)
;
mApzcTreeLog
.
ConditionOnPrefFunction
(
gfxPrefs
:
:
APZPrintTree
)
;
}
APZCTreeManager
:
:
~
APZCTreeManager
(
)
{
}
AsyncPanZoomController
*
APZCTreeManager
:
:
NewAPZCInstance
(
uint64_t
aLayersId
GeckoContentController
*
aController
TaskThrottler
*
aPaintThrottler
)
{
return
new
AsyncPanZoomController
(
aLayersId
this
mInputQueue
aController
aPaintThrottler
AsyncPanZoomController
:
:
USE_GESTURE_DETECTOR
)
;
}
TimeStamp
APZCTreeManager
:
:
GetFrameTime
(
)
{
return
TimeStamp
:
:
Now
(
)
;
}
void
APZCTreeManager
:
:
SetAllowedTouchBehavior
(
uint64_t
aInputBlockId
const
nsTArray
<
TouchBehaviorFlags
>
&
aValues
)
{
mInputQueue
-
>
SetAllowedTouchBehavior
(
aInputBlockId
aValues
)
;
}
void
APZCTreeManager
:
:
UpdateHitTestingTree
(
CompositorParent
*
aCompositor
Layer
*
aRoot
bool
aIsFirstPaint
uint64_t
aOriginatingLayersId
uint32_t
aPaintSequenceNumber
)
{
APZThreadUtils
:
:
AssertOnCompositorThread
(
)
;
MonitorAutoLock
lock
(
mTreeLock
)
;
APZTestData
*
testData
=
nullptr
;
if
(
gfxPrefs
:
:
APZTestLoggingEnabled
(
)
)
{
if
(
CompositorParent
:
:
LayerTreeState
*
state
=
CompositorParent
:
:
GetIndirectShadowTree
(
aOriginatingLayersId
)
)
{
testData
=
&
state
-
>
mApzTestData
;
testData
-
>
StartNewPaint
(
aPaintSequenceNumber
)
;
}
}
TreeBuildingState
state
(
aCompositor
aIsFirstPaint
aOriginatingLayersId
testData
aPaintSequenceNumber
)
;
ForEachNode
(
mRootNode
.
get
(
)
[
&
state
]
(
HitTestingTreeNode
*
aNode
)
{
state
.
mNodesToDestroy
.
AppendElement
(
aNode
)
;
}
)
;
mRootNode
=
nullptr
;
if
(
aRoot
)
{
mApzcTreeLog
<
<
"
[
start
]
\
n
"
;
LayerMetricsWrapper
root
(
aRoot
)
;
UpdateHitTestingTree
(
state
root
aCompositor
?
aCompositor
-
>
RootLayerTreeId
(
)
:
0
Matrix4x4
(
)
nullptr
nullptr
)
;
mApzcTreeLog
<
<
"
[
end
]
\
n
"
;
}
MOZ_ASSERT
(
!
(
mRootNode
&
&
mRootNode
-
>
GetPrevSibling
(
)
)
)
;
for
(
size_t
i
=
0
;
i
<
state
.
mNodesToDestroy
.
Length
(
)
;
i
+
+
)
{
APZCTM_LOG
(
"
Destroying
node
at
%
p
with
APZC
%
p
\
n
"
state
.
mNodesToDestroy
[
i
]
.
get
(
)
state
.
mNodesToDestroy
[
i
]
-
>
GetApzc
(
)
)
;
state
.
mNodesToDestroy
[
i
]
-
>
Destroy
(
)
;
}
#
if
ENABLE_APZCTM_LOGGING
printf_stderr
(
"
APZCTreeManager
(
%
p
)
\
n
"
this
)
;
mRootNode
-
>
Dump
(
"
"
)
;
#
endif
}
void
APZCTreeManager
:
:
InitializeForLayersId
(
uint64_t
aLayersId
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
auto
throttlerInsertResult
=
mPaintThrottlerMap
.
insert
(
std
:
:
make_pair
(
aLayersId
RefPtr
<
TaskThrottler
>
(
)
)
)
;
if
(
throttlerInsertResult
.
second
)
{
throttlerInsertResult
.
first
-
>
second
=
new
TaskThrottler
(
GetFrameTime
(
)
TimeDuration
:
:
FromMilliseconds
(
500
)
)
;
}
}
void
APZCTreeManager
:
:
AdoptLayersId
(
uint64_t
aLayersId
APZCTreeManager
*
aOldManager
)
{
MOZ_ASSERT
(
aOldManager
)
;
if
(
aOldManager
=
=
this
)
{
return
;
}
auto
iter
=
aOldManager
-
>
mPaintThrottlerMap
.
find
(
aLayersId
)
;
if
(
iter
!
=
aOldManager
-
>
mPaintThrottlerMap
.
end
(
)
)
{
mPaintThrottlerMap
[
aLayersId
]
=
iter
-
>
second
;
aOldManager
-
>
mPaintThrottlerMap
.
erase
(
iter
)
;
}
}
static
ParentLayerIntRegion
ComputeClipRegion
(
GeckoContentController
*
aController
const
LayerMetricsWrapper
&
aLayer
)
{
ParentLayerIntRegion
clipRegion
;
if
(
aLayer
.
GetClipRect
(
)
)
{
clipRegion
=
*
aLayer
.
GetClipRect
(
)
;
}
else
{
clipRegion
=
RoundedToInt
(
aLayer
.
Metrics
(
)
.
GetCompositionBounds
(
)
)
;
}
CSSRect
touchSensitiveRegion
;
if
(
aController
-
>
GetTouchSensitiveRegion
(
&
touchSensitiveRegion
)
)
{
LayoutDeviceToParentLayerScale2D
parentCumulativeResolution
=
aLayer
.
Metrics
(
)
.
GetCumulativeResolution
(
)
/
ParentLayerToLayerScale
(
aLayer
.
Metrics
(
)
.
GetPresShellResolution
(
)
)
;
ParentLayerIntRegion
extraClip
=
RoundedIn
(
touchSensitiveRegion
*
aLayer
.
Metrics
(
)
.
GetDevPixelsPerCSSPixel
(
)
*
parentCumulativeResolution
)
;
clipRegion
.
AndWith
(
extraClip
)
;
}
return
clipRegion
;
}
void
APZCTreeManager
:
:
PrintAPZCInfo
(
const
LayerMetricsWrapper
&
aLayer
const
AsyncPanZoomController
*
apzc
)
{
const
FrameMetrics
&
metrics
=
aLayer
.
Metrics
(
)
;
mApzcTreeLog
<
<
"
APZC
"
<
<
apzc
-
>
GetGuid
(
)
<
<
"
\
tcb
=
"
<
<
metrics
.
GetCompositionBounds
(
)
<
<
"
\
tsr
=
"
<
<
metrics
.
GetScrollableRect
(
)
<
<
(
aLayer
.
IsScrollInfoLayer
(
)
?
"
\
tscrollinfo
"
:
"
"
)
<
<
(
apzc
-
>
HasScrollgrab
(
)
?
"
\
tscrollgrab
"
:
"
"
)
<
<
"
\
t
"
<
<
metrics
.
GetContentDescription
(
)
.
get
(
)
;
}
void
APZCTreeManager
:
:
AttachNodeToTree
(
HitTestingTreeNode
*
aNode
HitTestingTreeNode
*
aParent
HitTestingTreeNode
*
aNextSibling
)
{
if
(
aNextSibling
)
{
aNextSibling
-
>
SetPrevSibling
(
aNode
)
;
}
else
if
(
aParent
)
{
aParent
-
>
SetLastChild
(
aNode
)
;
}
else
{
MOZ_ASSERT
(
!
mRootNode
)
;
mRootNode
=
aNode
;
aNode
-
>
MakeRoot
(
)
;
}
}
static
EventRegions
GetEventRegions
(
const
LayerMetricsWrapper
&
aLayer
)
{
if
(
aLayer
.
IsScrollInfoLayer
(
)
)
{
ParentLayerIntRect
compositionBounds
(
RoundedToInt
(
aLayer
.
Metrics
(
)
.
GetCompositionBounds
(
)
)
)
;
nsIntRegion
hitRegion
(
compositionBounds
.
ToUnknownRect
(
)
)
;
EventRegions
eventRegions
(
hitRegion
)
;
eventRegions
.
mDispatchToContentHitRegion
=
eventRegions
.
mHitRegion
;
return
eventRegions
;
}
return
aLayer
.
GetEventRegions
(
)
;
}
already_AddRefed
<
HitTestingTreeNode
>
APZCTreeManager
:
:
RecycleOrCreateNode
(
TreeBuildingState
&
aState
AsyncPanZoomController
*
aApzc
uint64_t
aLayersId
)
{
for
(
size_t
i
=
0
;
i
<
aState
.
mNodesToDestroy
.
Length
(
)
;
i
+
+
)
{
RefPtr
<
HitTestingTreeNode
>
node
=
aState
.
mNodesToDestroy
[
i
]
;
if
(
!
node
-
>
IsPrimaryHolder
(
)
)
{
aState
.
mNodesToDestroy
.
RemoveElement
(
node
)
;
node
-
>
RecycleWith
(
aApzc
aLayersId
)
;
return
node
.
forget
(
)
;
}
}
RefPtr
<
HitTestingTreeNode
>
node
=
new
HitTestingTreeNode
(
aApzc
false
aLayersId
)
;
return
node
.
forget
(
)
;
}
static
EventRegionsOverride
GetEventRegionsOverride
(
HitTestingTreeNode
*
aParent
const
LayerMetricsWrapper
&
aLayer
)
{
EventRegionsOverride
result
=
aLayer
.
GetEventRegionsOverride
(
)
;
if
(
aParent
)
{
result
|
=
aParent
-
>
GetEventRegionsOverride
(
)
;
}
return
result
;
}
void
APZCTreeManager
:
:
StartScrollbarDrag
(
const
ScrollableLayerGuid
&
aGuid
const
AsyncDragMetrics
&
aDragMetrics
)
{
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
aGuid
)
;
if
(
!
apzc
)
{
return
;
}
uint64_t
inputBlockId
=
aDragMetrics
.
mDragStartSequenceNumber
;
mInputQueue
-
>
ConfirmDragBlock
(
inputBlockId
apzc
aDragMetrics
)
;
}
HitTestingTreeNode
*
APZCTreeManager
:
:
PrepareNodeForLayer
(
const
LayerMetricsWrapper
&
aLayer
const
FrameMetrics
&
aMetrics
uint64_t
aLayersId
const
gfx
:
:
Matrix4x4
&
aAncestorTransform
HitTestingTreeNode
*
aParent
HitTestingTreeNode
*
aNextSibling
TreeBuildingState
&
aState
)
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
bool
needsApzc
=
true
;
if
(
!
aMetrics
.
IsScrollable
(
)
)
{
needsApzc
=
false
;
}
const
CompositorParent
:
:
LayerTreeState
*
state
=
CompositorParent
:
:
GetIndirectShadowTree
(
aLayersId
)
;
if
(
!
(
state
&
&
state
-
>
mController
.
get
(
)
)
)
{
needsApzc
=
false
;
}
RefPtr
<
HitTestingTreeNode
>
node
=
nullptr
;
if
(
!
needsApzc
)
{
node
=
RecycleOrCreateNode
(
aState
nullptr
aLayersId
)
;
AttachNodeToTree
(
node
aParent
aNextSibling
)
;
node
-
>
SetHitTestData
(
GetEventRegions
(
aLayer
)
aLayer
.
GetTransform
(
)
aLayer
.
GetClipRect
(
)
?
Some
(
ParentLayerIntRegion
(
*
aLayer
.
GetClipRect
(
)
)
)
:
Nothing
(
)
GetEventRegionsOverride
(
aParent
aLayer
)
)
;
node
-
>
SetScrollbarData
(
aLayer
.
GetScrollbarTargetContainerId
(
)
aLayer
.
GetScrollbarDirection
(
)
aLayer
.
GetScrollbarSize
(
)
)
;
return
node
;
}
AsyncPanZoomController
*
apzc
=
nullptr
;
ScrollableLayerGuid
guid
(
aLayersId
aMetrics
)
;
auto
insertResult
=
aState
.
mApzcMap
.
insert
(
std
:
:
make_pair
(
guid
static_cast
<
AsyncPanZoomController
*
>
(
nullptr
)
)
)
;
if
(
!
insertResult
.
second
)
{
apzc
=
insertResult
.
first
-
>
second
;
PrintAPZCInfo
(
aLayer
apzc
)
;
}
APZCTM_LOG
(
"
Found
APZC
%
p
for
layer
%
p
with
identifiers
%
"
PRId64
"
%
"
PRId64
"
\
n
"
apzc
aLayer
.
GetLayer
(
)
guid
.
mLayersId
guid
.
mScrollId
)
;
if
(
apzc
=
=
nullptr
)
{
apzc
=
aLayer
.
GetApzc
(
)
;
if
(
apzc
&
&
(
!
apzc
-
>
Matches
(
guid
)
|
|
!
apzc
-
>
HasTreeManager
(
this
)
)
)
{
apzc
=
nullptr
;
}
for
(
size_t
i
=
0
;
i
<
aState
.
mNodesToDestroy
.
Length
(
)
;
i
+
+
)
{
RefPtr
<
HitTestingTreeNode
>
n
=
aState
.
mNodesToDestroy
[
i
]
;
if
(
n
-
>
IsPrimaryHolder
(
)
&
&
n
-
>
GetApzc
(
)
&
&
n
-
>
GetApzc
(
)
-
>
Matches
(
guid
)
)
{
node
=
n
;
if
(
apzc
!
=
nullptr
)
{
MOZ_ASSERT
(
apzc
=
=
node
-
>
GetApzc
(
)
)
;
}
apzc
=
node
-
>
GetApzc
(
)
;
break
;
}
}
bool
newApzc
=
(
apzc
=
=
nullptr
|
|
apzc
-
>
IsDestroyed
(
)
)
;
if
(
newApzc
)
{
RefPtr
<
TaskThrottler
>
throttler
=
mPaintThrottlerMap
[
aLayersId
]
;
MOZ_ASSERT
(
throttler
)
;
apzc
=
NewAPZCInstance
(
aLayersId
state
-
>
mController
throttler
)
;
apzc
-
>
SetCompositorParent
(
aState
.
mCompositor
)
;
if
(
state
-
>
mCrossProcessParent
!
=
nullptr
)
{
apzc
-
>
ShareFrameMetricsAcrossProcesses
(
)
;
}
MOZ_ASSERT
(
node
=
=
nullptr
)
;
node
=
new
HitTestingTreeNode
(
apzc
true
aLayersId
)
;
}
else
{
aState
.
mNodesToDestroy
.
RemoveElement
(
node
)
;
node
-
>
SetPrevSibling
(
nullptr
)
;
node
-
>
SetLastChild
(
nullptr
)
;
}
APZCTM_LOG
(
"
Using
APZC
%
p
for
layer
%
p
with
identifiers
%
"
PRId64
"
%
"
PRId64
"
\
n
"
apzc
aLayer
.
GetLayer
(
)
aLayersId
aMetrics
.
GetScrollId
(
)
)
;
apzc
-
>
NotifyLayersUpdated
(
aMetrics
aState
.
mIsFirstPaint
&
&
(
aLayersId
=
=
aState
.
mOriginatingLayersId
)
)
;
MOZ_ASSERT
(
node
-
>
IsPrimaryHolder
(
)
&
&
node
-
>
GetApzc
(
)
&
&
node
-
>
GetApzc
(
)
-
>
Matches
(
guid
)
)
;
ParentLayerIntRegion
clipRegion
=
ComputeClipRegion
(
state
-
>
mController
aLayer
)
;
node
-
>
SetHitTestData
(
GetEventRegions
(
aLayer
)
aLayer
.
GetTransform
(
)
Some
(
clipRegion
)
GetEventRegionsOverride
(
aParent
aLayer
)
)
;
apzc
-
>
SetAncestorTransform
(
aAncestorTransform
)
;
PrintAPZCInfo
(
aLayer
apzc
)
;
AttachNodeToTree
(
node
aParent
aNextSibling
)
;
if
(
aLayersId
=
=
aState
.
mOriginatingLayersId
)
{
if
(
apzc
-
>
HasNoParentWithSameLayersId
(
)
)
{
aState
.
mPaintLogger
.
LogTestData
(
aMetrics
.
GetScrollId
(
)
"
hasNoParentWithSameLayersId
"
true
)
;
}
else
{
MOZ_ASSERT
(
apzc
-
>
GetParent
(
)
)
;
aState
.
mPaintLogger
.
LogTestData
(
aMetrics
.
GetScrollId
(
)
"
parentScrollId
"
apzc
-
>
GetParent
(
)
-
>
GetGuid
(
)
.
mScrollId
)
;
}
}
if
(
newApzc
)
{
auto
it
=
mZoomConstraints
.
find
(
guid
)
;
if
(
it
!
=
mZoomConstraints
.
end
(
)
)
{
apzc
-
>
UpdateZoomConstraints
(
it
-
>
second
)
;
}
else
if
(
!
apzc
-
>
HasNoParentWithSameLayersId
(
)
)
{
apzc
-
>
UpdateZoomConstraints
(
apzc
-
>
GetParent
(
)
-
>
GetZoomConstraints
(
)
)
;
}
}
insertResult
.
first
-
>
second
=
apzc
;
}
else
{
node
=
RecycleOrCreateNode
(
aState
apzc
aLayersId
)
;
AttachNodeToTree
(
node
aParent
aNextSibling
)
;
MOZ_ASSERT
(
aAncestorTransform
=
=
apzc
-
>
GetAncestorTransform
(
)
)
;
ParentLayerIntRegion
clipRegion
=
ComputeClipRegion
(
state
-
>
mController
aLayer
)
;
node
-
>
SetHitTestData
(
GetEventRegions
(
aLayer
)
aLayer
.
GetTransform
(
)
Some
(
clipRegion
)
GetEventRegionsOverride
(
aParent
aLayer
)
)
;
}
node
-
>
SetScrollbarData
(
aLayer
.
GetScrollbarTargetContainerId
(
)
aLayer
.
GetScrollbarDirection
(
)
aLayer
.
GetScrollbarSize
(
)
)
;
return
node
;
}
HitTestingTreeNode
*
APZCTreeManager
:
:
UpdateHitTestingTree
(
TreeBuildingState
&
aState
const
LayerMetricsWrapper
&
aLayer
uint64_t
aLayersId
const
gfx
:
:
Matrix4x4
&
aAncestorTransform
HitTestingTreeNode
*
aParent
HitTestingTreeNode
*
aNextSibling
)
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
mApzcTreeLog
<
<
aLayer
.
Name
(
)
<
<
'
\
t
'
;
HitTestingTreeNode
*
node
=
PrepareNodeForLayer
(
aLayer
aLayer
.
Metrics
(
)
aLayersId
aAncestorTransform
aParent
aNextSibling
aState
)
;
MOZ_ASSERT
(
node
)
;
AsyncPanZoomController
*
apzc
=
node
-
>
GetApzc
(
)
;
aLayer
.
SetApzc
(
apzc
)
;
mApzcTreeLog
<
<
'
\
n
'
;
Matrix4x4
ancestorTransform
=
aLayer
.
TransformIsPerspective
(
)
?
Matrix4x4
(
)
:
aLayer
.
GetTransform
(
)
;
if
(
!
apzc
)
{
ancestorTransform
=
ancestorTransform
*
aAncestorTransform
;
}
MOZ_ASSERT
(
!
node
-
>
GetFirstChild
(
)
)
;
aParent
=
node
;
HitTestingTreeNode
*
next
=
nullptr
;
uint64_t
childLayersId
=
(
aLayer
.
AsRefLayer
(
)
?
aLayer
.
AsRefLayer
(
)
-
>
GetReferentId
(
)
:
aLayersId
)
;
for
(
LayerMetricsWrapper
child
=
aLayer
.
GetLastChild
(
)
;
child
;
child
=
child
.
GetPrevSibling
(
)
)
{
gfx
:
:
TreeAutoIndent
indent
(
mApzcTreeLog
)
;
next
=
UpdateHitTestingTree
(
aState
child
childLayersId
ancestorTransform
aParent
next
)
;
}
return
node
;
}
static
bool
WillHandleWheelEvent
(
WidgetWheelEvent
*
aEvent
)
{
return
EventStateManager
:
:
WheelEventIsScrollAction
(
aEvent
)
&
&
(
aEvent
-
>
deltaMode
=
=
nsIDOMWheelEvent
:
:
DOM_DELTA_LINE
|
|
aEvent
-
>
deltaMode
=
=
nsIDOMWheelEvent
:
:
DOM_DELTA_PIXEL
|
|
aEvent
-
>
deltaMode
=
=
nsIDOMWheelEvent
:
:
DOM_DELTA_PAGE
)
;
}
static
bool
WillHandleMouseEvent
(
const
WidgetMouseEventBase
&
aEvent
)
{
if
(
!
gfxPrefs
:
:
APZDragEnabled
(
)
)
{
return
false
;
}
return
aEvent
.
mMessage
=
=
eMouseMove
|
|
aEvent
.
mMessage
=
=
eMouseDown
|
|
aEvent
.
mMessage
=
=
eMouseUp
;
}
template
<
typename
PanGestureOrScrollWheelInput
>
static
bool
WillHandleInput
(
const
PanGestureOrScrollWheelInput
&
aPanInput
)
{
if
(
!
NS_IsMainThread
(
)
)
{
return
true
;
}
WidgetWheelEvent
wheelEvent
=
aPanInput
.
ToWidgetWheelEvent
(
nullptr
)
;
return
WillHandleWheelEvent
(
&
wheelEvent
)
;
}
void
APZCTreeManager
:
:
FlushApzRepaints
(
uint64_t
aLayersId
)
{
APZCTM_LOG
(
"
Flushing
repaints
for
layers
id
%
"
PRIu64
aLayersId
)
;
{
MonitorAutoLock
lock
(
mTreeLock
)
;
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
ForEachNode
(
mRootNode
.
get
(
)
[
aLayersId
]
(
HitTestingTreeNode
*
aNode
)
{
if
(
aNode
-
>
IsPrimaryHolder
(
)
)
{
AsyncPanZoomController
*
apzc
=
aNode
-
>
GetApzc
(
)
;
MOZ_ASSERT
(
apzc
)
;
if
(
apzc
-
>
GetGuid
(
)
.
mLayersId
=
=
aLayersId
)
{
apzc
-
>
FlushRepaintIfPending
(
)
;
}
}
}
)
;
}
const
CompositorParent
:
:
LayerTreeState
*
state
=
CompositorParent
:
:
GetIndirectShadowTree
(
aLayersId
)
;
MOZ_ASSERT
(
state
&
&
state
-
>
mController
)
;
NS_DispatchToMainThread
(
NS_NewRunnableMethod
(
state
-
>
mController
.
get
(
)
&
GeckoContentController
:
:
NotifyFlushComplete
)
)
;
}
nsEventStatus
APZCTreeManager
:
:
ReceiveInputEvent
(
InputData
&
aEvent
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
{
APZThreadUtils
:
:
AssertOnControllerThread
(
)
;
if
(
aOutInputBlockId
)
{
*
aOutInputBlockId
=
InputBlockState
:
:
NO_BLOCK_ID
;
}
nsEventStatus
result
=
nsEventStatus_eIgnore
;
HitTestResult
hitResult
=
HitNothing
;
switch
(
aEvent
.
mInputType
)
{
case
MULTITOUCH_INPUT
:
{
MultiTouchInput
&
touchInput
=
aEvent
.
AsMultiTouchInput
(
)
;
touchInput
.
mHandledByAPZ
=
true
;
result
=
ProcessTouchInput
(
touchInput
aOutTargetGuid
aOutInputBlockId
)
;
break
;
}
case
MOUSE_INPUT
:
{
MouseInput
&
mouseInput
=
aEvent
.
AsMouseInput
(
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
mouseInput
.
mOrigin
&
hitResult
)
;
if
(
!
apzc
&
&
mRootNode
)
{
apzc
=
mRootNode
-
>
GetApzc
(
)
;
}
if
(
apzc
)
{
result
=
mInputQueue
-
>
ReceiveInputEvent
(
apzc
false
mouseInput
aOutInputBlockId
)
;
apzc
-
>
GetGuid
(
aOutTargetGuid
)
;
}
break
;
}
case
SCROLLWHEEL_INPUT
:
{
FlushRepaintsToClearScreenToGeckoTransform
(
)
;
ScrollWheelInput
&
wheelInput
=
aEvent
.
AsScrollWheelInput
(
)
;
wheelInput
.
mHandledByAPZ
=
WillHandleInput
(
wheelInput
)
;
if
(
!
wheelInput
.
mHandledByAPZ
)
{
return
result
;
}
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
wheelInput
.
mOrigin
&
hitResult
)
;
if
(
apzc
)
{
MOZ_ASSERT
(
hitResult
=
=
HitLayer
|
|
hitResult
=
=
HitDispatchToContentRegion
)
;
Matrix4x4
transformToGecko
=
GetScreenToApzcTransform
(
apzc
)
*
GetApzcToGeckoTransform
(
apzc
)
;
Maybe
<
ScreenPoint
>
untransformedOrigin
=
UntransformTo
<
ScreenPixel
>
(
transformToGecko
wheelInput
.
mOrigin
)
;
if
(
!
untransformedOrigin
)
{
return
result
;
}
result
=
mInputQueue
-
>
ReceiveInputEvent
(
apzc
hitResult
=
=
HitLayer
wheelInput
aOutInputBlockId
)
;
apzc
-
>
GetGuid
(
aOutTargetGuid
)
;
wheelInput
.
mOrigin
=
*
untransformedOrigin
;
}
break
;
}
case
PANGESTURE_INPUT
:
{
FlushRepaintsToClearScreenToGeckoTransform
(
)
;
PanGestureInput
&
panInput
=
aEvent
.
AsPanGestureInput
(
)
;
panInput
.
mHandledByAPZ
=
WillHandleInput
(
panInput
)
;
if
(
!
panInput
.
mHandledByAPZ
)
{
return
result
;
}
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
panInput
.
mPanStartPoint
&
hitResult
)
;
if
(
apzc
)
{
MOZ_ASSERT
(
hitResult
=
=
HitLayer
|
|
hitResult
=
=
HitDispatchToContentRegion
)
;
Matrix4x4
transformToGecko
=
GetScreenToApzcTransform
(
apzc
)
*
GetApzcToGeckoTransform
(
apzc
)
;
Maybe
<
ScreenPoint
>
untransformedStartPoint
=
UntransformTo
<
ScreenPixel
>
(
transformToGecko
panInput
.
mPanStartPoint
)
;
Maybe
<
ScreenPoint
>
untransformedDisplacement
=
UntransformVector
<
ScreenPixel
>
(
transformToGecko
panInput
.
mPanDisplacement
panInput
.
mPanStartPoint
)
;
if
(
!
untransformedStartPoint
|
|
!
untransformedDisplacement
)
{
return
result
;
}
result
=
mInputQueue
-
>
ReceiveInputEvent
(
apzc
hitResult
=
=
HitLayer
panInput
aOutInputBlockId
)
;
apzc
-
>
GetGuid
(
aOutTargetGuid
)
;
panInput
.
mPanStartPoint
=
*
untransformedStartPoint
;
panInput
.
mPanDisplacement
=
*
untransformedDisplacement
;
}
break
;
}
case
PINCHGESTURE_INPUT
:
{
PinchGestureInput
&
pinchInput
=
aEvent
.
AsPinchGestureInput
(
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
pinchInput
.
mFocusPoint
&
hitResult
)
;
if
(
apzc
)
{
MOZ_ASSERT
(
hitResult
=
=
HitLayer
|
|
hitResult
=
=
HitDispatchToContentRegion
)
;
Matrix4x4
outTransform
=
GetScreenToApzcTransform
(
apzc
)
*
GetApzcToGeckoTransform
(
apzc
)
;
Maybe
<
ScreenPoint
>
untransformedFocusPoint
=
UntransformTo
<
ScreenPixel
>
(
outTransform
pinchInput
.
mFocusPoint
)
;
if
(
!
untransformedFocusPoint
)
{
return
result
;
}
result
=
mInputQueue
-
>
ReceiveInputEvent
(
apzc
hitResult
=
=
HitLayer
pinchInput
aOutInputBlockId
)
;
apzc
-
>
GetGuid
(
aOutTargetGuid
)
;
pinchInput
.
mFocusPoint
=
*
untransformedFocusPoint
;
}
break
;
}
case
TAPGESTURE_INPUT
:
{
TapGestureInput
&
tapInput
=
aEvent
.
AsTapGestureInput
(
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
tapInput
.
mPoint
&
hitResult
)
;
if
(
apzc
)
{
MOZ_ASSERT
(
hitResult
=
=
HitLayer
|
|
hitResult
=
=
HitDispatchToContentRegion
)
;
Matrix4x4
outTransform
=
GetScreenToApzcTransform
(
apzc
)
*
GetApzcToGeckoTransform
(
apzc
)
;
Maybe
<
ScreenIntPoint
>
untransformedPoint
=
UntransformTo
<
ScreenPixel
>
(
outTransform
tapInput
.
mPoint
)
;
if
(
!
untransformedPoint
)
{
return
result
;
}
result
=
mInputQueue
-
>
ReceiveInputEvent
(
apzc
hitResult
=
=
HitLayer
tapInput
aOutInputBlockId
)
;
apzc
-
>
GetGuid
(
aOutTargetGuid
)
;
tapInput
.
mPoint
=
*
untransformedPoint
;
}
break
;
}
}
return
result
;
}
already_AddRefed
<
AsyncPanZoomController
>
APZCTreeManager
:
:
GetTouchInputBlockAPZC
(
const
MultiTouchInput
&
aEvent
HitTestResult
*
aOutHitResult
)
{
RefPtr
<
AsyncPanZoomController
>
apzc
;
if
(
aEvent
.
mTouches
.
Length
(
)
=
=
0
)
{
return
apzc
.
forget
(
)
;
}
FlushRepaintsToClearScreenToGeckoTransform
(
)
;
apzc
=
GetTargetAPZC
(
aEvent
.
mTouches
[
0
]
.
mScreenPoint
aOutHitResult
)
;
for
(
size_t
i
=
1
;
i
<
aEvent
.
mTouches
.
Length
(
)
;
i
+
+
)
{
RefPtr
<
AsyncPanZoomController
>
apzc2
=
GetTargetAPZC
(
aEvent
.
mTouches
[
i
]
.
mScreenPoint
aOutHitResult
)
;
apzc
=
GetMultitouchTarget
(
apzc
apzc2
)
;
APZCTM_LOG
(
"
Using
APZC
%
p
as
the
root
APZC
for
multi
-
touch
\
n
"
apzc
.
get
(
)
)
;
}
return
apzc
.
forget
(
)
;
}
nsEventStatus
APZCTreeManager
:
:
ProcessTouchInput
(
MultiTouchInput
&
aInput
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
{
if
(
aInput
.
mType
=
=
MultiTouchInput
:
:
MULTITOUCH_START
)
{
if
(
mApzcForInputBlock
&
&
BuildOverscrollHandoffChain
(
mApzcForInputBlock
)
-
>
HasApzcPannedIntoOverscroll
(
)
)
{
if
(
mRetainedTouchIdentifier
=
=
-
1
)
{
mRetainedTouchIdentifier
=
mApzcForInputBlock
-
>
GetLastTouchIdentifier
(
)
;
}
return
nsEventStatus_eConsumeNoDefault
;
}
mHitResultForInputBlock
=
HitNothing
;
mApzcForInputBlock
=
GetTouchInputBlockAPZC
(
aInput
&
mHitResultForInputBlock
)
;
}
else
if
(
mApzcForInputBlock
)
{
APZCTM_LOG
(
"
Re
-
using
APZC
%
p
as
continuation
of
event
block
\
n
"
mApzcForInputBlock
.
get
(
)
)
;
}
if
(
aInput
.
mType
=
=
MultiTouchInput
:
:
MULTITOUCH_CANCEL
)
{
mRetainedTouchIdentifier
=
-
1
;
}
if
(
mRetainedTouchIdentifier
!
=
-
1
)
{
for
(
size_t
j
=
0
;
j
<
aInput
.
mTouches
.
Length
(
)
;
+
+
j
)
{
if
(
aInput
.
mTouches
[
j
]
.
mIdentifier
!
=
mRetainedTouchIdentifier
)
{
aInput
.
mTouches
.
RemoveElementAt
(
j
)
;
-
-
j
;
}
}
if
(
aInput
.
mTouches
.
IsEmpty
(
)
)
{
return
nsEventStatus_eConsumeNoDefault
;
}
}
nsEventStatus
result
=
nsEventStatus_eIgnore
;
if
(
mApzcForInputBlock
)
{
MOZ_ASSERT
(
mHitResultForInputBlock
=
=
HitLayer
|
|
mHitResultForInputBlock
=
=
HitDispatchToContentRegion
)
;
mApzcForInputBlock
-
>
GetGuid
(
aOutTargetGuid
)
;
result
=
mInputQueue
-
>
ReceiveInputEvent
(
mApzcForInputBlock
mHitResultForInputBlock
=
=
HitLayer
aInput
aOutInputBlockId
)
;
Matrix4x4
transformToApzc
=
GetScreenToApzcTransform
(
mApzcForInputBlock
)
;
Matrix4x4
transformToGecko
=
GetApzcToGeckoTransform
(
mApzcForInputBlock
)
;
Matrix4x4
outTransform
=
transformToApzc
*
transformToGecko
;
for
(
size_t
i
=
0
;
i
<
aInput
.
mTouches
.
Length
(
)
;
i
+
+
)
{
SingleTouchData
&
touchData
=
aInput
.
mTouches
[
i
]
;
Maybe
<
ScreenIntPoint
>
untransformedScreenPoint
=
UntransformTo
<
ScreenPixel
>
(
outTransform
touchData
.
mScreenPoint
)
;
if
(
!
untransformedScreenPoint
)
{
return
nsEventStatus_eIgnore
;
}
touchData
.
mScreenPoint
=
*
untransformedScreenPoint
;
}
}
mTouchCounter
.
Update
(
aInput
)
;
if
(
mTouchCounter
.
GetActiveTouchCount
(
)
=
=
0
)
{
mApzcForInputBlock
=
nullptr
;
mHitResultForInputBlock
=
HitNothing
;
mRetainedTouchIdentifier
=
-
1
;
}
return
result
;
}
void
APZCTreeManager
:
:
UpdateWheelTransaction
(
WidgetInputEvent
&
aEvent
)
{
WheelBlockState
*
txn
=
mInputQueue
-
>
GetCurrentWheelTransaction
(
)
;
if
(
!
txn
)
{
return
;
}
if
(
txn
-
>
MaybeTimeout
(
TimeStamp
:
:
Now
(
)
)
)
{
return
;
}
switch
(
aEvent
.
mMessage
)
{
case
eMouseMove
:
case
eDragOver
:
{
WidgetMouseEvent
*
mouseEvent
=
aEvent
.
AsMouseEvent
(
)
;
if
(
!
mouseEvent
-
>
IsReal
(
)
)
{
return
;
}
ScreenIntPoint
point
=
ViewAs
<
ScreenPixel
>
(
aEvent
.
refPoint
PixelCastJustification
:
:
LayoutDeviceIsScreenForUntransformedEvent
)
;
txn
-
>
OnMouseMove
(
point
)
;
return
;
}
case
eKeyPress
:
case
eKeyUp
:
case
eKeyDown
:
case
eMouseUp
:
case
eMouseDown
:
case
eMouseDoubleClick
:
case
eMouseClick
:
case
eContextMenu
:
case
eDrop
:
txn
-
>
EndTransaction
(
)
;
return
;
default
:
break
;
}
}
nsEventStatus
APZCTreeManager
:
:
ProcessEvent
(
WidgetInputEvent
&
aEvent
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
nsEventStatus
result
=
nsEventStatus_eIgnore
;
UpdateWheelTransaction
(
aEvent
)
;
HitTestResult
hitResult
=
HitNothing
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
ScreenPoint
(
aEvent
.
refPoint
.
x
aEvent
.
refPoint
.
y
)
&
hitResult
)
;
if
(
apzc
)
{
MOZ_ASSERT
(
hitResult
=
=
HitLayer
|
|
hitResult
=
=
HitDispatchToContentRegion
)
;
apzc
-
>
GetGuid
(
aOutTargetGuid
)
;
Matrix4x4
transformToApzc
=
GetScreenToApzcTransform
(
apzc
)
;
Matrix4x4
transformToGecko
=
GetApzcToGeckoTransform
(
apzc
)
;
Matrix4x4
outTransform
=
transformToApzc
*
transformToGecko
;
Maybe
<
LayoutDeviceIntPoint
>
untransformedRefPoint
=
UntransformTo
<
LayoutDevicePixel
>
(
outTransform
aEvent
.
refPoint
)
;
if
(
untransformedRefPoint
)
{
aEvent
.
refPoint
=
*
untransformedRefPoint
;
}
}
return
result
;
}
nsEventStatus
APZCTreeManager
:
:
ProcessMouseEvent
(
WidgetMouseEventBase
&
aEvent
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
UpdateWheelTransaction
(
aEvent
)
;
MouseInput
input
(
aEvent
)
;
input
.
mOrigin
=
ScreenPoint
(
aEvent
.
refPoint
.
x
aEvent
.
refPoint
.
y
)
;
nsEventStatus
status
=
ReceiveInputEvent
(
input
aOutTargetGuid
aOutInputBlockId
)
;
aEvent
.
refPoint
.
x
=
input
.
mOrigin
.
x
;
aEvent
.
refPoint
.
y
=
input
.
mOrigin
.
y
;
aEvent
.
mFlags
.
mHandledByAPZ
=
true
;
return
status
;
}
nsEventStatus
APZCTreeManager
:
:
ProcessWheelEvent
(
WidgetWheelEvent
&
aEvent
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
{
ScrollWheelInput
:
:
ScrollMode
scrollMode
=
ScrollWheelInput
:
:
SCROLLMODE_INSTANT
;
if
(
(
aEvent
.
deltaMode
=
=
nsIDOMWheelEvent
:
:
DOM_DELTA_LINE
|
|
aEvent
.
deltaMode
=
=
nsIDOMWheelEvent
:
:
DOM_DELTA_PAGE
)
&
&
gfxPrefs
:
:
SmoothScrollEnabled
(
)
&
&
gfxPrefs
:
:
WheelSmoothScrollEnabled
(
)
)
{
scrollMode
=
ScrollWheelInput
:
:
SCROLLMODE_SMOOTH
;
}
ScreenPoint
origin
(
aEvent
.
refPoint
.
x
aEvent
.
refPoint
.
y
)
;
ScrollWheelInput
input
(
aEvent
.
time
aEvent
.
timeStamp
0
scrollMode
ScrollWheelInput
:
:
DeltaTypeForDeltaMode
(
aEvent
.
deltaMode
)
origin
aEvent
.
deltaX
aEvent
.
deltaY
)
;
EventStateManager
:
:
GetUserPrefsForWheelEvent
(
&
aEvent
&
input
.
mUserDeltaMultiplierX
&
input
.
mUserDeltaMultiplierY
)
;
nsEventStatus
status
=
ReceiveInputEvent
(
input
aOutTargetGuid
aOutInputBlockId
)
;
aEvent
.
refPoint
.
x
=
input
.
mOrigin
.
x
;
aEvent
.
refPoint
.
y
=
input
.
mOrigin
.
y
;
aEvent
.
mFlags
.
mHandledByAPZ
=
input
.
mHandledByAPZ
;
return
status
;
}
nsEventStatus
APZCTreeManager
:
:
ReceiveInputEvent
(
WidgetInputEvent
&
aEvent
ScrollableLayerGuid
*
aOutTargetGuid
uint64_t
*
aOutInputBlockId
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
APZThreadUtils
:
:
AssertOnControllerThread
(
)
;
if
(
aOutInputBlockId
)
{
*
aOutInputBlockId
=
InputBlockState
:
:
NO_BLOCK_ID
;
}
switch
(
aEvent
.
mClass
)
{
case
eMouseEventClass
:
{
WidgetMouseEventBase
&
mouseEvent
=
*
aEvent
.
AsMouseEventBase
(
)
;
if
(
WillHandleMouseEvent
(
mouseEvent
)
)
{
return
ProcessMouseEvent
(
mouseEvent
aOutTargetGuid
aOutInputBlockId
)
;
}
return
ProcessEvent
(
aEvent
aOutTargetGuid
aOutInputBlockId
)
;
}
case
eTouchEventClass
:
{
WidgetTouchEvent
&
touchEvent
=
*
aEvent
.
AsTouchEvent
(
)
;
MultiTouchInput
touchInput
(
touchEvent
)
;
nsEventStatus
result
=
ProcessTouchInput
(
touchInput
aOutTargetGuid
aOutInputBlockId
)
;
touchEvent
.
touches
.
Clear
(
)
;
touchEvent
.
touches
.
SetCapacity
(
touchInput
.
mTouches
.
Length
(
)
)
;
for
(
size_t
i
=
0
;
i
<
touchInput
.
mTouches
.
Length
(
)
;
i
+
+
)
{
*
touchEvent
.
touches
.
AppendElement
(
)
=
touchInput
.
mTouches
[
i
]
.
ToNewDOMTouch
(
)
;
}
return
result
;
}
case
eWheelEventClass
:
{
WidgetWheelEvent
&
wheelEvent
=
*
aEvent
.
AsWheelEvent
(
)
;
if
(
WillHandleWheelEvent
(
&
wheelEvent
)
)
{
return
ProcessWheelEvent
(
wheelEvent
aOutTargetGuid
aOutInputBlockId
)
;
}
return
ProcessEvent
(
aEvent
aOutTargetGuid
aOutInputBlockId
)
;
}
default
:
{
return
ProcessEvent
(
aEvent
aOutTargetGuid
aOutInputBlockId
)
;
}
}
}
void
APZCTreeManager
:
:
ZoomToRect
(
const
ScrollableLayerGuid
&
aGuid
const
CSSRect
&
aRect
)
{
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
aGuid
)
;
if
(
apzc
)
{
apzc
-
>
ZoomToRect
(
aRect
)
;
}
}
void
APZCTreeManager
:
:
ContentReceivedInputBlock
(
uint64_t
aInputBlockId
bool
aPreventDefault
)
{
APZThreadUtils
:
:
AssertOnControllerThread
(
)
;
mInputQueue
-
>
ContentReceivedInputBlock
(
aInputBlockId
aPreventDefault
)
;
}
void
APZCTreeManager
:
:
SetTargetAPZC
(
uint64_t
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
)
{
APZThreadUtils
:
:
AssertOnControllerThread
(
)
;
RefPtr
<
AsyncPanZoomController
>
target
=
nullptr
;
if
(
aTargets
.
Length
(
)
>
0
)
{
target
=
GetTargetAPZC
(
aTargets
[
0
]
)
;
}
for
(
size_t
i
=
1
;
i
<
aTargets
.
Length
(
)
;
i
+
+
)
{
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
aTargets
[
i
]
)
;
target
=
GetMultitouchTarget
(
target
apzc
)
;
}
mInputQueue
-
>
SetConfirmedTargetApzc
(
aInputBlockId
target
)
;
}
void
APZCTreeManager
:
:
SetTargetAPZC
(
uint64_t
aInputBlockId
const
ScrollableLayerGuid
&
aTarget
)
{
APZThreadUtils
:
:
AssertOnControllerThread
(
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
aTarget
)
;
mInputQueue
-
>
SetConfirmedTargetApzc
(
aInputBlockId
apzc
)
;
}
void
APZCTreeManager
:
:
UpdateZoomConstraints
(
const
ScrollableLayerGuid
&
aGuid
const
Maybe
<
ZoomConstraints
>
&
aConstraints
)
{
MonitorAutoLock
lock
(
mTreeLock
)
;
RefPtr
<
HitTestingTreeNode
>
node
=
GetTargetNode
(
aGuid
nullptr
)
;
MOZ_ASSERT
(
!
node
|
|
node
-
>
GetApzc
(
)
)
;
if
(
aConstraints
)
{
APZCTM_LOG
(
"
Recording
constraints
%
s
for
guid
%
s
\
n
"
Stringify
(
aConstraints
.
value
(
)
)
.
c_str
(
)
Stringify
(
aGuid
)
.
c_str
(
)
)
;
mZoomConstraints
[
aGuid
]
=
aConstraints
.
ref
(
)
;
}
else
{
APZCTM_LOG
(
"
Removing
constraints
for
guid
%
s
\
n
"
Stringify
(
aGuid
)
.
c_str
(
)
)
;
mZoomConstraints
.
erase
(
aGuid
)
;
}
if
(
node
&
&
aConstraints
)
{
ForEachNode
(
node
.
get
(
)
[
&
aConstraints
&
node
this
]
(
HitTestingTreeNode
*
aNode
)
{
if
(
aNode
!
=
node
)
{
if
(
AsyncPanZoomController
*
childApzc
=
aNode
-
>
GetApzc
(
)
)
{
if
(
childApzc
-
>
HasNoParentWithSameLayersId
(
)
|
|
this
-
>
mZoomConstraints
.
find
(
childApzc
-
>
GetGuid
(
)
)
!
=
this
-
>
mZoomConstraints
.
end
(
)
)
{
return
TraversalFlag
:
:
Skip
;
}
}
}
if
(
aNode
-
>
IsPrimaryHolder
(
)
)
{
MOZ_ASSERT
(
aNode
-
>
GetApzc
(
)
)
;
aNode
-
>
GetApzc
(
)
-
>
UpdateZoomConstraints
(
aConstraints
.
ref
(
)
)
;
}
return
TraversalFlag
:
:
Continue
;
}
)
;
}
}
void
APZCTreeManager
:
:
FlushRepaintsToClearScreenToGeckoTransform
(
)
{
MonitorAutoLock
lock
(
mTreeLock
)
;
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
ForEachNode
(
mRootNode
.
get
(
)
[
]
(
HitTestingTreeNode
*
aNode
)
{
if
(
aNode
-
>
IsPrimaryHolder
(
)
)
{
MOZ_ASSERT
(
aNode
-
>
GetApzc
(
)
)
;
aNode
-
>
GetApzc
(
)
-
>
FlushRepaintForNewInputBlock
(
)
;
}
}
)
;
}
void
APZCTreeManager
:
:
CancelAnimation
(
const
ScrollableLayerGuid
&
aGuid
)
{
RefPtr
<
AsyncPanZoomController
>
apzc
=
GetTargetAPZC
(
aGuid
)
;
if
(
apzc
)
{
apzc
-
>
CancelAnimation
(
)
;
}
}
void
APZCTreeManager
:
:
ClearTree
(
)
{
APZThreadUtils
:
:
RunOnControllerThread
(
NewRunnableMethod
(
mInputQueue
.
get
(
)
&
InputQueue
:
:
Clear
)
)
;
MonitorAutoLock
lock
(
mTreeLock
)
;
nsTArray
<
RefPtr
<
HitTestingTreeNode
>
>
nodesToDestroy
;
ForEachNode
(
mRootNode
.
get
(
)
[
&
nodesToDestroy
]
(
HitTestingTreeNode
*
aNode
)
{
nodesToDestroy
.
AppendElement
(
aNode
)
;
}
)
;
for
(
size_t
i
=
0
;
i
<
nodesToDestroy
.
Length
(
)
;
i
+
+
)
{
nodesToDestroy
[
i
]
-
>
Destroy
(
)
;
}
mRootNode
=
nullptr
;
}
RefPtr
<
HitTestingTreeNode
>
APZCTreeManager
:
:
GetRootNode
(
)
const
{
MonitorAutoLock
lock
(
mTreeLock
)
;
return
mRootNode
;
}
static
bool
TransformDisplacement
(
APZCTreeManager
*
aTreeManager
AsyncPanZoomController
*
aSource
AsyncPanZoomController
*
aTarget
ParentLayerPoint
&
aStartPoint
ParentLayerPoint
&
aEndPoint
)
{
if
(
aSource
=
=
aTarget
)
{
return
true
;
}
Matrix4x4
untransformToApzc
=
aTreeManager
-
>
GetScreenToApzcTransform
(
aSource
)
.
Inverse
(
)
;
ScreenPoint
screenStart
=
TransformTo
<
ScreenPixel
>
(
untransformToApzc
aStartPoint
)
;
ScreenPoint
screenEnd
=
TransformTo
<
ScreenPixel
>
(
untransformToApzc
aEndPoint
)
;
Matrix4x4
transformToApzc
=
aTreeManager
-
>
GetScreenToApzcTransform
(
aTarget
)
;
Maybe
<
ParentLayerPoint
>
startPoint
=
UntransformTo
<
ParentLayerPixel
>
(
transformToApzc
screenStart
)
;
Maybe
<
ParentLayerPoint
>
endPoint
=
UntransformTo
<
ParentLayerPixel
>
(
transformToApzc
screenEnd
)
;
if
(
!
startPoint
|
|
!
endPoint
)
{
return
false
;
}
aEndPoint
=
*
endPoint
;
aStartPoint
=
*
startPoint
;
return
true
;
}
void
APZCTreeManager
:
:
DispatchScroll
(
AsyncPanZoomController
*
aPrev
ParentLayerPoint
&
aStartPoint
ParentLayerPoint
&
aEndPoint
OverscrollHandoffState
&
aOverscrollHandoffState
)
{
const
OverscrollHandoffChain
&
overscrollHandoffChain
=
aOverscrollHandoffState
.
mChain
;
uint32_t
overscrollHandoffChainIndex
=
aOverscrollHandoffState
.
mChainIndex
;
RefPtr
<
AsyncPanZoomController
>
next
;
if
(
overscrollHandoffChainIndex
>
=
overscrollHandoffChain
.
Length
(
)
)
{
return
;
}
next
=
overscrollHandoffChain
.
GetApzcAtIndex
(
overscrollHandoffChainIndex
)
;
if
(
next
=
=
nullptr
|
|
next
-
>
IsDestroyed
(
)
)
{
return
;
}
if
(
!
TransformDisplacement
(
this
aPrev
next
aStartPoint
aEndPoint
)
)
{
return
;
}
if
(
!
next
-
>
AttemptScroll
(
aStartPoint
aEndPoint
aOverscrollHandoffState
)
)
{
if
(
!
TransformDisplacement
(
this
next
aPrev
aStartPoint
aEndPoint
)
)
{
NS_WARNING
(
"
Failed
to
untransform
scroll
points
during
dispatch
"
)
;
}
}
}
void
APZCTreeManager
:
:
DispatchFling
(
AsyncPanZoomController
*
aPrev
ParentLayerPoint
&
aVelocity
RefPtr
<
const
OverscrollHandoffChain
>
aOverscrollHandoffChain
bool
aHandoff
)
{
RefPtr
<
AsyncPanZoomController
>
current
;
uint32_t
aOverscrollHandoffChainLength
=
aOverscrollHandoffChain
-
>
Length
(
)
;
uint32_t
startIndex
;
ParentLayerPoint
startPoint
;
ParentLayerPoint
endPoint
;
ParentLayerPoint
usedTransformedVelocity
=
aVelocity
;
if
(
aHandoff
)
{
startIndex
=
aOverscrollHandoffChain
-
>
IndexOf
(
aPrev
)
+
1
;
if
(
startIndex
>
=
aOverscrollHandoffChainLength
)
{
return
;
}
}
else
{
startIndex
=
0
;
}
for
(
;
startIndex
<
aOverscrollHandoffChainLength
;
startIndex
+
+
)
{
current
=
aOverscrollHandoffChain
-
>
GetApzcAtIndex
(
startIndex
)
;
if
(
current
=
=
nullptr
|
|
current
-
>
IsDestroyed
(
)
)
{
return
;
}
endPoint
=
startPoint
+
usedTransformedVelocity
;
if
(
startIndex
>
0
)
{
if
(
!
TransformDisplacement
(
this
aOverscrollHandoffChain
-
>
GetApzcAtIndex
(
startIndex
-
1
)
current
startPoint
endPoint
)
)
{
return
;
}
}
ParentLayerPoint
transformedVelocity
=
endPoint
-
startPoint
;
usedTransformedVelocity
=
transformedVelocity
;
if
(
current
-
>
AttemptFling
(
usedTransformedVelocity
aOverscrollHandoffChain
aHandoff
)
)
{
if
(
IsZero
(
usedTransformedVelocity
)
)
{
aVelocity
=
ParentLayerPoint
(
)
;
return
;
}
if
(
!
FuzzyEqualsAdditive
(
transformedVelocity
.
x
usedTransformedVelocity
.
x
COORDINATE_EPSILON
)
)
{
aVelocity
.
x
=
aVelocity
.
x
*
(
usedTransformedVelocity
.
x
/
transformedVelocity
.
x
)
;
}
if
(
!
FuzzyEqualsAdditive
(
transformedVelocity
.
y
usedTransformedVelocity
.
y
COORDINATE_EPSILON
)
)
{
aVelocity
.
y
=
aVelocity
.
y
*
(
usedTransformedVelocity
.
y
/
transformedVelocity
.
y
)
;
}
}
}
}
bool
APZCTreeManager
:
:
HitTestAPZC
(
const
ScreenIntPoint
&
aPoint
)
{
RefPtr
<
AsyncPanZoomController
>
target
=
GetTargetAPZC
(
aPoint
nullptr
)
;
return
target
!
=
nullptr
;
}
already_AddRefed
<
AsyncPanZoomController
>
APZCTreeManager
:
:
GetTargetAPZC
(
const
ScrollableLayerGuid
&
aGuid
)
{
MonitorAutoLock
lock
(
mTreeLock
)
;
RefPtr
<
HitTestingTreeNode
>
node
=
GetTargetNode
(
aGuid
nullptr
)
;
MOZ_ASSERT
(
!
node
|
|
node
-
>
GetApzc
(
)
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
node
?
node
-
>
GetApzc
(
)
:
nullptr
;
return
apzc
.
forget
(
)
;
}
already_AddRefed
<
HitTestingTreeNode
>
APZCTreeManager
:
:
GetTargetNode
(
const
ScrollableLayerGuid
&
aGuid
GuidComparator
aComparator
)
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
RefPtr
<
HitTestingTreeNode
>
target
=
FindTargetNode
(
mRootNode
aGuid
aComparator
)
;
return
target
.
forget
(
)
;
}
already_AddRefed
<
AsyncPanZoomController
>
APZCTreeManager
:
:
GetTargetAPZC
(
const
ScreenPoint
&
aPoint
HitTestResult
*
aOutHitResult
)
{
MonitorAutoLock
lock
(
mTreeLock
)
;
HitTestResult
hitResult
=
HitNothing
;
ParentLayerPoint
point
=
ViewAs
<
ParentLayerPixel
>
(
aPoint
PixelCastJustification
:
:
ScreenIsParentLayerForRoot
)
;
RefPtr
<
AsyncPanZoomController
>
target
=
GetAPZCAtPoint
(
mRootNode
point
&
hitResult
)
;
if
(
aOutHitResult
)
{
*
aOutHitResult
=
hitResult
;
}
return
target
.
forget
(
)
;
}
static
bool
GuidComparatorIgnoringPresShell
(
const
ScrollableLayerGuid
&
aOne
const
ScrollableLayerGuid
&
aTwo
)
{
return
aOne
.
mLayersId
=
=
aTwo
.
mLayersId
&
&
aOne
.
mScrollId
=
=
aTwo
.
mScrollId
;
}
RefPtr
<
const
OverscrollHandoffChain
>
APZCTreeManager
:
:
BuildOverscrollHandoffChain
(
const
RefPtr
<
AsyncPanZoomController
>
&
aInitialTarget
)
{
MonitorAutoLock
lock
(
mTreeLock
)
;
OverscrollHandoffChain
*
result
=
new
OverscrollHandoffChain
;
AsyncPanZoomController
*
apzc
=
aInitialTarget
;
while
(
apzc
!
=
nullptr
)
{
result
-
>
Add
(
apzc
)
;
if
(
apzc
-
>
GetScrollHandoffParentId
(
)
=
=
FrameMetrics
:
:
NULL_SCROLL_ID
)
{
if
(
!
apzc
-
>
IsRootForLayersId
(
)
)
{
NS_WARNING
(
"
Found
a
non
-
root
APZ
with
no
handoff
parent
"
)
;
}
apzc
=
apzc
-
>
GetParent
(
)
;
continue
;
}
MOZ_ASSERT
(
apzc
-
>
GetScrollHandoffParentId
(
)
!
=
apzc
-
>
GetGuid
(
)
.
mScrollId
)
;
AsyncPanZoomController
*
scrollParent
=
nullptr
;
AsyncPanZoomController
*
parent
=
apzc
;
while
(
!
parent
-
>
HasNoParentWithSameLayersId
(
)
)
{
parent
=
parent
-
>
GetParent
(
)
;
if
(
parent
-
>
GetGuid
(
)
.
mScrollId
=
=
apzc
-
>
GetScrollHandoffParentId
(
)
)
{
scrollParent
=
parent
;
break
;
}
}
if
(
!
scrollParent
)
{
ScrollableLayerGuid
guid
(
parent
-
>
GetGuid
(
)
.
mLayersId
0
apzc
-
>
GetScrollHandoffParentId
(
)
)
;
RefPtr
<
HitTestingTreeNode
>
node
=
GetTargetNode
(
guid
&
GuidComparatorIgnoringPresShell
)
;
MOZ_ASSERT
(
!
node
|
|
node
-
>
GetApzc
(
)
)
;
scrollParent
=
node
?
node
-
>
GetApzc
(
)
:
nullptr
;
}
apzc
=
scrollParent
;
}
result
-
>
SortByScrollPriority
(
)
;
for
(
uint32_t
i
=
0
;
i
<
result
-
>
Length
(
)
;
+
+
i
)
{
APZCTM_LOG
(
"
OverscrollHandoffChain
[
%
d
]
=
%
p
\
n
"
i
result
-
>
GetApzcAtIndex
(
i
)
.
get
(
)
)
;
}
return
result
;
}
void
APZCTreeManager
:
:
SetLongTapEnabled
(
bool
aLongTapEnabled
)
{
APZThreadUtils
:
:
RunOnControllerThread
(
NewRunnableFunction
(
GestureEventListener
:
:
SetLongTapEnabled
aLongTapEnabled
)
)
;
}
HitTestingTreeNode
*
APZCTreeManager
:
:
FindTargetNode
(
HitTestingTreeNode
*
aNode
const
ScrollableLayerGuid
&
aGuid
GuidComparator
aComparator
)
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
for
(
HitTestingTreeNode
*
node
=
aNode
;
node
;
node
=
node
-
>
GetPrevSibling
(
)
)
{
HitTestingTreeNode
*
match
=
FindTargetNode
(
node
-
>
GetLastChild
(
)
aGuid
aComparator
)
;
if
(
match
)
{
return
match
;
}
bool
matches
=
false
;
if
(
node
-
>
GetApzc
(
)
)
{
if
(
aComparator
)
{
matches
=
aComparator
(
aGuid
node
-
>
GetApzc
(
)
-
>
GetGuid
(
)
)
;
}
else
{
matches
=
node
-
>
GetApzc
(
)
-
>
Matches
(
aGuid
)
;
}
}
if
(
matches
)
{
return
node
;
}
}
return
nullptr
;
}
RefPtr
<
HitTestingTreeNode
>
APZCTreeManager
:
:
FindScrollNode
(
const
AsyncDragMetrics
&
aDragMetrics
)
{
MonitorAutoLock
lock
(
mTreeLock
)
;
return
DepthFirstSearch
(
mRootNode
.
get
(
)
[
&
aDragMetrics
]
(
HitTestingTreeNode
*
aNode
)
{
return
aNode
-
>
MatchesScrollDragMetrics
(
aDragMetrics
)
;
}
)
;
}
AsyncPanZoomController
*
APZCTreeManager
:
:
GetAPZCAtPoint
(
HitTestingTreeNode
*
aNode
const
ParentLayerPoint
&
aHitTestPoint
HitTestResult
*
aOutHitResult
)
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
for
(
HitTestingTreeNode
*
node
=
aNode
;
node
;
node
=
node
-
>
GetPrevSibling
(
)
)
{
if
(
node
-
>
IsOutsideClip
(
aHitTestPoint
)
)
{
APZCTM_LOG
(
"
Point
%
f
%
f
outside
clip
for
node
%
p
\
n
"
aHitTestPoint
.
x
aHitTestPoint
.
y
node
)
;
continue
;
}
AsyncPanZoomController
*
result
=
nullptr
;
Maybe
<
LayerPoint
>
hitTestPointForChildLayers
=
node
-
>
Untransform
(
aHitTestPoint
)
;
if
(
hitTestPointForChildLayers
)
{
ParentLayerPoint
childPoint
=
ViewAs
<
ParentLayerPixel
>
(
hitTestPointForChildLayers
.
ref
(
)
PixelCastJustification
:
:
MovingDownToChildren
)
;
result
=
GetAPZCAtPoint
(
node
-
>
GetLastChild
(
)
childPoint
aOutHitResult
)
;
}
if
(
*
aOutHitResult
=
=
HitNothing
)
{
APZCTM_LOG
(
"
Testing
ParentLayer
point
%
s
(
Layer
%
s
)
against
node
%
p
\
n
"
Stringify
(
aHitTestPoint
)
.
c_str
(
)
hitTestPointForChildLayers
?
Stringify
(
hitTestPointForChildLayers
.
ref
(
)
)
.
c_str
(
)
:
"
nil
"
node
)
;
HitTestResult
hitResult
=
node
-
>
HitTest
(
aHitTestPoint
)
;
if
(
hitResult
!
=
HitTestResult
:
:
HitNothing
)
{
result
=
node
-
>
GetNearestContainingApzcWithSameLayersId
(
)
;
if
(
!
result
)
{
result
=
FindRootApzcForLayersId
(
node
-
>
GetLayersId
(
)
)
;
MOZ_ASSERT
(
result
)
;
}
APZCTM_LOG
(
"
Successfully
matched
APZC
%
p
via
node
%
p
(
hit
result
%
d
)
\
n
"
result
node
hitResult
)
;
MOZ_ASSERT
(
hitResult
=
=
HitLayer
|
|
hitResult
=
=
HitDispatchToContentRegion
)
;
*
aOutHitResult
=
hitResult
;
}
}
if
(
*
aOutHitResult
!
=
HitNothing
)
{
return
result
;
}
}
return
nullptr
;
}
AsyncPanZoomController
*
APZCTreeManager
:
:
FindRootApzcForLayersId
(
uint64_t
aLayersId
)
const
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
HitTestingTreeNode
*
resultNode
=
BreadthFirstSearch
(
mRootNode
.
get
(
)
[
aLayersId
]
(
HitTestingTreeNode
*
aNode
)
{
AsyncPanZoomController
*
apzc
=
aNode
-
>
GetApzc
(
)
;
return
apzc
&
&
apzc
-
>
GetLayersId
(
)
=
=
aLayersId
&
&
apzc
-
>
IsRootForLayersId
(
)
;
}
)
;
return
resultNode
?
resultNode
-
>
GetApzc
(
)
:
nullptr
;
}
AsyncPanZoomController
*
APZCTreeManager
:
:
FindRootContentApzcForLayersId
(
uint64_t
aLayersId
)
const
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
HitTestingTreeNode
*
resultNode
=
BreadthFirstSearch
(
mRootNode
.
get
(
)
[
aLayersId
]
(
HitTestingTreeNode
*
aNode
)
{
AsyncPanZoomController
*
apzc
=
aNode
-
>
GetApzc
(
)
;
return
apzc
&
&
apzc
-
>
GetLayersId
(
)
=
=
aLayersId
&
&
apzc
-
>
IsRootContent
(
)
;
}
)
;
return
resultNode
?
resultNode
-
>
GetApzc
(
)
:
nullptr
;
}
Matrix4x4
APZCTreeManager
:
:
GetScreenToApzcTransform
(
const
AsyncPanZoomController
*
aApzc
)
const
{
Matrix4x4
result
;
MonitorAutoLock
lock
(
mTreeLock
)
;
Matrix4x4
ancestorUntransform
=
aApzc
-
>
GetAncestorTransform
(
)
.
Inverse
(
)
;
result
=
ancestorUntransform
;
for
(
AsyncPanZoomController
*
parent
=
aApzc
-
>
GetParent
(
)
;
parent
;
parent
=
parent
-
>
GetParent
(
)
)
{
ancestorUntransform
=
parent
-
>
GetAncestorTransform
(
)
.
Inverse
(
)
;
Matrix4x4
asyncUntransform
=
parent
-
>
GetCurrentAsyncTransformWithOverscroll
(
)
.
Inverse
(
)
;
Matrix4x4
untransformSinceLastApzc
=
ancestorUntransform
*
asyncUntransform
;
result
=
untransformSinceLastApzc
*
result
;
}
return
result
;
}
Matrix4x4
APZCTreeManager
:
:
GetApzcToGeckoTransform
(
const
AsyncPanZoomController
*
aApzc
)
const
{
Matrix4x4
result
;
MonitorAutoLock
lock
(
mTreeLock
)
;
Matrix4x4
asyncUntransform
=
aApzc
-
>
GetCurrentAsyncTransformWithOverscroll
(
)
.
Inverse
(
)
;
result
=
asyncUntransform
*
aApzc
-
>
GetTransformToLastDispatchedPaint
(
)
*
aApzc
-
>
GetAncestorTransform
(
)
;
for
(
AsyncPanZoomController
*
parent
=
aApzc
-
>
GetParent
(
)
;
parent
;
parent
=
parent
-
>
GetParent
(
)
)
{
result
=
result
*
parent
-
>
GetTransformToLastDispatchedPaint
(
)
*
parent
-
>
GetAncestorTransform
(
)
;
}
return
result
;
}
already_AddRefed
<
AsyncPanZoomController
>
APZCTreeManager
:
:
GetMultitouchTarget
(
AsyncPanZoomController
*
aApzc1
AsyncPanZoomController
*
aApzc2
)
const
{
MonitorAutoLock
lock
(
mTreeLock
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
;
if
(
aApzc1
&
&
aApzc2
&
&
aApzc1
-
>
GetLayersId
(
)
=
=
aApzc2
-
>
GetLayersId
(
)
)
{
apzc
=
FindRootContentApzcForLayersId
(
aApzc1
-
>
GetLayersId
(
)
)
;
}
else
{
apzc
=
CommonAncestor
(
aApzc1
aApzc2
)
;
if
(
apzc
)
{
apzc
=
FindRootContentApzcForLayersId
(
apzc
-
>
GetLayersId
(
)
)
;
}
}
return
apzc
.
forget
(
)
;
}
already_AddRefed
<
AsyncPanZoomController
>
APZCTreeManager
:
:
CommonAncestor
(
AsyncPanZoomController
*
aApzc1
AsyncPanZoomController
*
aApzc2
)
const
{
mTreeLock
.
AssertCurrentThreadOwns
(
)
;
RefPtr
<
AsyncPanZoomController
>
ancestor
;
int
depth1
=
0
depth2
=
0
;
for
(
AsyncPanZoomController
*
parent
=
aApzc1
;
parent
;
parent
=
parent
-
>
GetParent
(
)
)
{
depth1
+
+
;
}
for
(
AsyncPanZoomController
*
parent
=
aApzc2
;
parent
;
parent
=
parent
-
>
GetParent
(
)
)
{
depth2
+
+
;
}
int
minDepth
=
depth1
<
depth2
?
depth1
:
depth2
;
while
(
depth1
>
minDepth
)
{
depth1
-
-
;
aApzc1
=
aApzc1
-
>
GetParent
(
)
;
}
while
(
depth2
>
minDepth
)
{
depth2
-
-
;
aApzc2
=
aApzc2
-
>
GetParent
(
)
;
}
while
(
true
)
{
if
(
aApzc1
=
=
aApzc2
)
{
ancestor
=
aApzc1
;
break
;
}
if
(
depth1
<
=
0
)
{
break
;
}
aApzc1
=
aApzc1
-
>
GetParent
(
)
;
aApzc2
=
aApzc2
-
>
GetParent
(
)
;
}
return
ancestor
.
forget
(
)
;
}
}
}
