#
ifndef
mozilla_layers_CheckerboardEvent_h
#
define
mozilla_layers_CheckerboardEvent_h
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
<
sstream
>
#
include
"
Units
.
h
"
namespace
mozilla
{
namespace
layers
{
class
CheckerboardEvent
{
public
:
enum
RendertraceProperty
{
Page
PaintedCriticalDisplayPort
PaintedDisplayPort
RequestedDisplayPort
UserVisible
MAX_RendertraceProperty
}
;
static
const
char
*
sDescriptions
[
MAX_RendertraceProperty
]
;
static
const
char
*
sColors
[
MAX_RendertraceProperty
]
;
public
:
CheckerboardEvent
(
)
;
uint64_t
GetSeverity
(
)
;
std
:
:
string
GetLog
(
)
;
void
UpdateRendertraceProperty
(
RendertraceProperty
aProperty
const
CSSRect
&
aRect
const
std
:
:
string
&
aExtraInfo
=
std
:
:
string
(
)
)
;
bool
RecordFrameInfo
(
uint32_t
aCssPixelsCheckerboarded
)
;
private
:
void
StartEvent
(
)
;
void
StopEvent
(
)
;
void
LogInfo
(
RendertraceProperty
aProperty
const
TimeStamp
&
aTimestamp
const
CSSRect
&
aRect
const
std
:
:
string
&
aExtraInfo
const
MonitorAutoLock
&
aProofOfLock
)
;
struct
PropertyValue
{
RendertraceProperty
mProperty
;
TimeStamp
mTimeStamp
;
CSSRect
mRect
;
std
:
:
string
mExtraInfo
;
bool
operator
<
(
const
PropertyValue
&
aOther
)
const
;
}
;
class
PropertyBuffer
{
public
:
PropertyBuffer
(
)
;
void
Update
(
RendertraceProperty
aProperty
const
CSSRect
&
aRect
const
std
:
:
string
&
aExtraInfo
const
MonitorAutoLock
&
aProofOfLock
)
;
void
Flush
(
std
:
:
vector
<
PropertyValue
>
&
aOut
const
MonitorAutoLock
&
aProofOfLock
)
;
private
:
static
const
uint32_t
BUFFER_SIZE
=
5
;
uint32_t
mIndex
;
PropertyValue
mValues
[
BUFFER_SIZE
]
;
}
;
private
:
const
TimeStamp
mOriginTime
;
bool
mCheckerboardingActive
;
TimeStamp
mStartTime
;
TimeStamp
mEndTime
;
TimeStamp
mLastSampleTime
;
uint32_t
mFrameCount
;
uint64_t
mTotalPixelMs
;
uint32_t
mPeakPixels
;
mutable
Monitor
mRendertraceLock
;
PropertyBuffer
mBufferedProperties
[
MAX_RendertraceProperty
]
;
std
:
:
ostringstream
mRendertraceInfo
;
}
;
}
}
#
endif
