#
include
"
TaskThrottler
.
h
"
#
include
"
mozilla
/
layers
/
APZThreadUtils
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsITimer
.
h
"
namespace
mozilla
{
namespace
layers
{
TaskThrottler
:
:
TaskThrottler
(
const
TimeStamp
&
aTimeStamp
const
TimeDuration
&
aMaxWait
)
:
mOutstanding
(
false
)
mQueuedTask
(
nullptr
)
mStartTime
(
aTimeStamp
)
mMaxWait
(
aMaxWait
)
mMean
(
1
)
mTimer
(
do_CreateInstance
(
NS_TIMER_CONTRACTID
)
)
{
}
TaskThrottler
:
:
~
TaskThrottler
(
)
{
mTimer
-
>
Cancel
(
)
;
}
void
TaskThrottler
:
:
PostTask
(
const
tracked_objects
:
:
Location
&
aLocation
UniquePtr
<
CancelableTask
>
aTask
const
TimeStamp
&
aTimeStamp
)
{
aTask
-
>
SetBirthPlace
(
aLocation
)
;
if
(
mOutstanding
)
{
if
(
mQueuedTask
)
{
mQueuedTask
-
>
Cancel
(
)
;
mQueuedTask
=
nullptr
;
mTimer
-
>
Cancel
(
)
;
}
if
(
TimeSinceLastRequest
(
aTimeStamp
)
<
mMaxWait
)
{
mQueuedTask
=
Move
(
aTask
)
;
TimeDuration
timeout
=
mMaxWait
-
TimeSinceLastRequest
(
aTimeStamp
)
;
TimeStamp
timeoutTime
=
mStartTime
+
mMaxWait
;
nsRefPtr
<
TaskThrottler
>
refPtrThis
=
this
;
mTimer
-
>
InitWithCallback
(
NewTimerCallback
(
[
refPtrThis
timeoutTime
]
(
)
{
if
(
refPtrThis
-
>
mQueuedTask
)
{
refPtrThis
-
>
RunQueuedTask
(
timeoutTime
)
;
}
}
)
timeout
.
ToMilliseconds
(
)
nsITimer
:
:
TYPE_ONE_SHOT
)
;
return
;
}
}
mStartTime
=
aTimeStamp
;
aTask
-
>
Run
(
)
;
mOutstanding
=
true
;
}
void
TaskThrottler
:
:
TaskComplete
(
const
TimeStamp
&
aTimeStamp
)
{
if
(
!
mOutstanding
)
{
return
;
}
mMean
.
insert
(
aTimeStamp
-
mStartTime
)
;
if
(
mQueuedTask
)
{
RunQueuedTask
(
aTimeStamp
)
;
mTimer
-
>
Cancel
(
)
;
}
else
{
mOutstanding
=
false
;
}
}
void
TaskThrottler
:
:
RunQueuedTask
(
const
TimeStamp
&
aTimeStamp
)
{
mStartTime
=
aTimeStamp
;
mQueuedTask
-
>
Run
(
)
;
mQueuedTask
=
nullptr
;
}
void
TaskThrottler
:
:
CancelPendingTask
(
)
{
if
(
mQueuedTask
)
{
mQueuedTask
-
>
Cancel
(
)
;
mQueuedTask
=
nullptr
;
mTimer
-
>
Cancel
(
)
;
}
}
TimeDuration
TaskThrottler
:
:
TimeSinceLastRequest
(
const
TimeStamp
&
aTimeStamp
)
{
return
aTimeStamp
-
mStartTime
;
}
}
}
