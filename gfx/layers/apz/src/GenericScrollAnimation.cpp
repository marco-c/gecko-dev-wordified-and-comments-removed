#
include
"
GenericScrollAnimation
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
gfxPrefs
.
h
"
#
include
"
nsPoint
.
h
"
namespace
mozilla
{
namespace
layers
{
GenericScrollAnimation
:
:
GenericScrollAnimation
(
AsyncPanZoomController
&
aApzc
const
nsPoint
&
aInitialPosition
)
:
mApzc
(
aApzc
)
mAnimationPhysics
(
aInitialPosition
)
mFinalDestination
(
aInitialPosition
)
mForceVerticalOverscroll
(
false
)
{
}
void
GenericScrollAnimation
:
:
UpdateDelta
(
TimeStamp
aTime
nsPoint
aDelta
const
nsSize
&
aCurrentVelocity
)
{
mFinalDestination
+
=
aDelta
;
Update
(
aTime
aCurrentVelocity
)
;
}
void
GenericScrollAnimation
:
:
UpdateDestination
(
TimeStamp
aTime
nsPoint
aDestination
const
nsSize
&
aCurrentVelocity
)
{
mFinalDestination
=
aDestination
;
Update
(
aTime
aCurrentVelocity
)
;
}
void
GenericScrollAnimation
:
:
Update
(
TimeStamp
aTime
const
nsSize
&
aCurrentVelocity
)
{
if
(
mAnimationPhysics
.
mIsFirstIteration
)
{
mAnimationPhysics
.
InitializeHistory
(
aTime
)
;
}
CSSPoint
clamped
=
CSSPoint
:
:
FromAppUnits
(
mFinalDestination
)
;
clamped
.
x
=
mApzc
.
mX
.
ClampOriginToScrollableRect
(
clamped
.
x
)
;
clamped
.
y
=
mApzc
.
mY
.
ClampOriginToScrollableRect
(
clamped
.
y
)
;
mFinalDestination
=
CSSPoint
:
:
ToAppUnits
(
clamped
)
;
mAnimationPhysics
.
Update
(
aTime
mFinalDestination
aCurrentVelocity
)
;
}
bool
GenericScrollAnimation
:
:
DoSample
(
FrameMetrics
&
aFrameMetrics
const
TimeDuration
&
aDelta
)
{
TimeStamp
now
=
mApzc
.
GetFrameTime
(
)
;
CSSToParentLayerScale2D
zoom
=
aFrameMetrics
.
GetZoom
(
)
;
bool
finished
=
mAnimationPhysics
.
IsFinished
(
now
)
;
nsPoint
sampledDest
=
finished
?
mAnimationPhysics
.
mDestination
:
mAnimationPhysics
.
PositionAt
(
now
)
;
ParentLayerPoint
displacement
=
(
CSSPoint
:
:
FromAppUnits
(
sampledDest
)
-
aFrameMetrics
.
GetScrollOffset
(
)
)
*
zoom
;
if
(
finished
)
{
mApzc
.
mX
.
SetVelocity
(
0
)
;
mApzc
.
mY
.
SetVelocity
(
0
)
;
}
else
if
(
!
IsZero
(
displacement
)
)
{
nsSize
velocity
=
mAnimationPhysics
.
VelocityAt
(
now
)
;
ParentLayerPoint
velocityPL
=
CSSPoint
:
:
FromAppUnits
(
nsPoint
(
velocity
.
width
velocity
.
height
)
)
*
zoom
;
mApzc
.
mX
.
SetVelocity
(
velocityPL
.
x
/
1000
.
0
)
;
mApzc
.
mY
.
SetVelocity
(
velocityPL
.
y
/
1000
.
0
)
;
}
ParentLayerPoint
adjustedOffset
overscroll
;
mApzc
.
mX
.
AdjustDisplacement
(
displacement
.
x
adjustedOffset
.
x
overscroll
.
x
)
;
mApzc
.
mY
.
AdjustDisplacement
(
displacement
.
y
adjustedOffset
.
y
overscroll
.
y
mForceVerticalOverscroll
)
;
if
(
!
IsZero
(
displacement
)
&
&
IsZero
(
adjustedOffset
)
)
{
return
false
;
}
aFrameMetrics
.
ScrollBy
(
adjustedOffset
/
zoom
)
;
return
!
finished
;
}
}
}
