#
include
"
GenericScrollAnimation
.
h
"
#
include
"
AsyncPanZoomController
.
h
"
#
include
"
FrameMetrics
.
h
"
#
include
"
mozilla
/
layers
/
APZPublicUtils
.
h
"
#
include
"
nsPoint
.
h
"
#
include
"
ScrollAnimationPhysics
.
h
"
#
include
"
ScrollAnimationBezierPhysics
.
h
"
#
include
"
ScrollAnimationMSDPhysics
.
h
"
#
include
"
mozilla
/
StaticPrefs_general
.
h
"
static
mozilla
:
:
LazyLogModule
sApzScrollAnimLog
(
"
apz
.
scrollanimation
"
)
;
#
define
GSA_LOG
(
.
.
.
)
MOZ_LOG
(
sApzScrollAnimLog
LogLevel
:
:
Debug
(
__VA_ARGS__
)
)
namespace
mozilla
{
namespace
layers
{
GenericScrollAnimation
:
:
GenericScrollAnimation
(
AsyncPanZoomController
&
aApzc
const
nsPoint
&
aInitialPosition
ScrollOrigin
aOrigin
)
:
mApzc
(
aApzc
)
mFinalDestination
(
aInitialPosition
)
{
if
(
StaticPrefs
:
:
general_smoothScroll
(
)
&
&
StaticPrefs
:
:
general_smoothScroll_msdPhysics_enabled
(
)
)
{
mAnimationPhysics
=
MakeUnique
<
ScrollAnimationMSDPhysics
>
(
aInitialPosition
)
;
}
else
{
mAnimationPhysics
=
MakeUnique
<
ScrollAnimationBezierPhysics
>
(
aInitialPosition
apz
:
:
ComputeBezierAnimationSettingsForOrigin
(
aOrigin
)
)
;
}
}
void
GenericScrollAnimation
:
:
UpdateDelta
(
TimeStamp
aTime
const
nsPoint
&
aDelta
const
nsSize
&
aCurrentVelocity
)
{
mFinalDestination
+
=
aDelta
;
Update
(
aTime
aCurrentVelocity
)
;
}
void
GenericScrollAnimation
:
:
UpdateDestination
(
TimeStamp
aTime
const
nsPoint
&
aDestination
const
nsSize
&
aCurrentVelocity
)
{
mFinalDestination
=
aDestination
;
Update
(
aTime
aCurrentVelocity
)
;
}
void
GenericScrollAnimation
:
:
Update
(
TimeStamp
aTime
const
nsSize
&
aCurrentVelocity
)
{
CSSPoint
clamped
=
CSSPoint
:
:
FromAppUnits
(
mFinalDestination
)
;
clamped
.
x
=
mApzc
.
mX
.
ClampOriginToScrollableRect
(
clamped
.
x
)
;
clamped
.
y
=
mApzc
.
mY
.
ClampOriginToScrollableRect
(
clamped
.
y
)
;
mFinalDestination
=
CSSPoint
:
:
ToAppUnits
(
clamped
)
;
mAnimationPhysics
-
>
Update
(
aTime
mFinalDestination
aCurrentVelocity
)
;
}
bool
GenericScrollAnimation
:
:
DoSample
(
FrameMetrics
&
aFrameMetrics
const
TimeDuration
&
aDelta
)
{
TimeStamp
now
=
mApzc
.
GetFrameTime
(
)
.
Time
(
)
;
CSSToParentLayerScale
zoom
(
aFrameMetrics
.
GetZoom
(
)
)
;
if
(
zoom
=
=
CSSToParentLayerScale
(
0
)
)
{
return
false
;
}
bool
finished
=
mAnimationPhysics
-
>
IsFinished
(
now
)
;
nsPoint
sampledDest
=
mAnimationPhysics
-
>
PositionAt
(
now
)
;
ParentLayerPoint
displacement
=
(
CSSPoint
:
:
FromAppUnits
(
sampledDest
)
-
aFrameMetrics
.
GetVisualScrollOffset
(
)
)
*
zoom
;
if
(
finished
)
{
mApzc
.
mX
.
SetVelocity
(
0
)
;
mApzc
.
mY
.
SetVelocity
(
0
)
;
}
else
if
(
!
IsZero
(
displacement
/
zoom
)
)
{
nsSize
velocity
=
mAnimationPhysics
-
>
VelocityAt
(
now
)
;
ParentLayerPoint
velocityPL
=
CSSPoint
:
:
FromAppUnits
(
nsPoint
(
velocity
.
width
velocity
.
height
)
)
*
zoom
;
mApzc
.
mX
.
SetVelocity
(
velocityPL
.
x
/
1000
.
0
)
;
mApzc
.
mY
.
SetVelocity
(
velocityPL
.
y
/
1000
.
0
)
;
}
ParentLayerPoint
adjustedOffset
overscroll
;
mApzc
.
mX
.
AdjustDisplacement
(
displacement
.
x
adjustedOffset
.
x
overscroll
.
x
mDirectionForcedToOverscroll
=
=
Some
(
ScrollDirection
:
:
eHorizontal
)
)
;
mApzc
.
mY
.
AdjustDisplacement
(
displacement
.
y
adjustedOffset
.
y
overscroll
.
y
mDirectionForcedToOverscroll
=
=
Some
(
ScrollDirection
:
:
eVertical
)
)
;
GSA_LOG
(
"
Sampling
GenericScrollAnimation
:
time
%
f
finished
%
d
sampledDest
%
s
"
"
adjustedOffset
%
s
overscroll
%
s
\
n
"
(
now
-
TimeStamp
:
:
ProcessCreation
(
)
)
.
ToMilliseconds
(
)
finished
ToString
(
CSSPoint
:
:
FromAppUnits
(
sampledDest
)
)
.
c_str
(
)
ToString
(
adjustedOffset
)
.
c_str
(
)
ToString
(
overscroll
)
.
c_str
(
)
)
;
if
(
!
IsZero
(
displacement
/
zoom
)
&
&
IsZero
(
adjustedOffset
/
zoom
)
)
{
return
false
;
}
mApzc
.
ScrollBy
(
adjustedOffset
/
zoom
)
;
return
!
finished
;
}
bool
GenericScrollAnimation
:
:
HandleScrollOffsetUpdate
(
const
Maybe
<
CSSPoint
>
&
aRelativeDelta
)
{
if
(
aRelativeDelta
)
{
mAnimationPhysics
-
>
ApplyContentShift
(
*
aRelativeDelta
)
;
mFinalDestination
+
=
CSSPoint
:
:
ToAppUnits
(
*
aRelativeDelta
)
;
return
true
;
}
return
false
;
}
}
}
