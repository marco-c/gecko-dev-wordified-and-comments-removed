#
ifndef
mozilla_layers_InputQueue_h
#
define
mozilla_layers_InputQueue_h
#
include
"
APZUtils
.
h
"
#
include
"
InputData
.
h
"
#
include
"
mozilla
/
EventForwards
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
nsAutoPtr
.
h
"
#
include
"
nsTArray
.
h
"
namespace
mozilla
{
class
InputData
;
class
MultiTouchInput
;
class
ScrollWheelInput
;
namespace
layers
{
class
AsyncPanZoomController
;
class
CancelableBlockState
;
class
TouchBlockState
;
class
WheelBlockState
;
class
DragBlockState
;
class
PanGestureBlockState
;
class
AsyncDragMetrics
;
class
InputQueue
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
InputQueue
)
public
:
InputQueue
(
)
;
nsEventStatus
ReceiveInputEvent
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
bool
aTargetConfirmed
const
InputData
&
aEvent
uint64_t
*
aOutInputBlockId
)
;
void
ContentReceivedInputBlock
(
uint64_t
aInputBlockId
bool
aPreventDefault
)
;
void
SetConfirmedTargetApzc
(
uint64_t
aInputBlockId
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
)
;
void
ConfirmDragBlock
(
uint64_t
aInputBlockId
const
RefPtr
<
AsyncPanZoomController
>
&
aTargetApzc
const
AsyncDragMetrics
&
aDragMetrics
)
;
void
SetAllowedTouchBehavior
(
uint64_t
aInputBlockId
const
nsTArray
<
TouchBehaviorFlags
>
&
aBehaviors
)
;
uint64_t
InjectNewTouchBlock
(
AsyncPanZoomController
*
aTarget
)
;
CancelableBlockState
*
CurrentBlock
(
)
const
;
TouchBlockState
*
CurrentTouchBlock
(
)
const
;
WheelBlockState
*
CurrentWheelBlock
(
)
const
;
DragBlockState
*
CurrentDragBlock
(
)
const
;
PanGestureBlockState
*
CurrentPanGestureBlock
(
)
const
;
bool
HasReadyTouchBlock
(
)
const
;
WheelBlockState
*
GetCurrentWheelTransaction
(
)
const
;
void
Clear
(
)
;
bool
AllowScrollHandoff
(
)
const
;
private
:
~
InputQueue
(
)
;
TouchBlockState
*
StartNewTouchBlock
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
bool
aTargetConfirmed
bool
aCopyPropertiesFromCurrent
)
;
void
CancelAnimationsForNewBlock
(
CancelableBlockState
*
aBlock
)
;
void
MaybeRequestContentResponse
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
CancelableBlockState
*
aBlock
)
;
nsEventStatus
ReceiveTouchInput
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
bool
aTargetConfirmed
const
MultiTouchInput
&
aEvent
uint64_t
*
aOutInputBlockId
)
;
nsEventStatus
ReceiveMouseInput
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
bool
aTargetConfirmed
const
MouseInput
&
aEvent
uint64_t
*
aOutInputBlockId
)
;
nsEventStatus
ReceiveScrollWheelInput
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
bool
aTargetConfirmed
const
ScrollWheelInput
&
aEvent
uint64_t
*
aOutInputBlockId
)
;
nsEventStatus
ReceivePanGestureInput
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
bool
aTargetConfirmed
const
PanGestureInput
&
aEvent
uint64_t
*
aOutInputBlockId
)
;
void
SweepDepletedBlocks
(
)
;
bool
MaybeHandleCurrentBlock
(
CancelableBlockState
*
block
const
InputData
&
aEvent
)
;
void
ScheduleMainThreadTimeout
(
const
RefPtr
<
AsyncPanZoomController
>
&
aTarget
uint64_t
aInputBlockId
)
;
void
MainThreadTimeout
(
const
uint64_t
&
aInputBlockId
)
;
void
ProcessInputBlocks
(
)
;
void
UpdateActiveApzc
(
const
RefPtr
<
AsyncPanZoomController
>
&
aNewActive
)
;
private
:
nsTArray
<
UniquePtr
<
CancelableBlockState
>
>
mInputBlockQueue
;
RefPtr
<
AsyncPanZoomController
>
mLastActiveApzc
;
TouchCounter
mTouchCounter
;
}
;
}
}
#
endif
