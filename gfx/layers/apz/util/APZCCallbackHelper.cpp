#
include
"
APZCCallbackHelper
.
h
"
#
include
"
TouchActionHelper
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
gfxPrefs
.
h
"
#
include
"
LayersLogging
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
mozilla
/
dom
/
TabParent
.
h
"
#
include
"
mozilla
/
IntegerPrintfMacros
.
h
"
#
include
"
mozilla
/
layers
/
LayerTransactionChild
.
h
"
#
include
"
mozilla
/
layers
/
ShadowLayers
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderLayerManager
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderBridgeChild
.
h
"
#
include
"
mozilla
/
TouchEvents
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsContainerFrame
.
h
"
#
include
"
nsIScrollableFrame
.
h
"
#
include
"
nsLayoutUtils
.
h
"
#
include
"
nsIInterfaceRequestorUtils
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
nsIDocument
.
h
"
#
include
"
nsIDOMWindow
.
h
"
#
include
"
nsIDOMWindowUtils
.
h
"
#
include
"
nsRefreshDriver
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsView
.
h
"
#
include
"
Layers
.
h
"
#
ifdef
APZCCH_LOGGING
#
define
APZCCH_LOG
(
.
.
.
)
printf_stderr
(
"
APZCCH
:
"
__VA_ARGS__
)
#
else
#
define
APZCCH_LOG
(
.
.
.
)
#
endif
namespace
mozilla
{
namespace
layers
{
using
dom
:
:
TabParent
;
uint64_t
APZCCallbackHelper
:
:
sLastTargetAPZCNotificationInputBlock
=
uint64_t
(
-
1
)
;
void
APZCCallbackHelper
:
:
AdjustDisplayPortForScrollDelta
(
mozilla
:
:
layers
:
:
FrameMetrics
&
aFrameMetrics
const
CSSPoint
&
aActualScrollOffset
)
{
ScreenPoint
shift
=
(
aFrameMetrics
.
GetScrollOffset
(
)
-
aActualScrollOffset
)
*
aFrameMetrics
.
DisplayportPixelsPerCSSPixel
(
)
;
ScreenMargin
margins
=
aFrameMetrics
.
GetDisplayPortMargins
(
)
;
margins
.
left
-
=
shift
.
x
;
margins
.
right
+
=
shift
.
x
;
margins
.
top
-
=
shift
.
y
;
margins
.
bottom
+
=
shift
.
y
;
aFrameMetrics
.
SetDisplayPortMargins
(
margins
)
;
}
static
void
RecenterDisplayPort
(
mozilla
:
:
layers
:
:
FrameMetrics
&
aFrameMetrics
)
{
ScreenMargin
margins
=
aFrameMetrics
.
GetDisplayPortMargins
(
)
;
margins
.
right
=
margins
.
left
=
margins
.
LeftRight
(
)
/
2
;
margins
.
top
=
margins
.
bottom
=
margins
.
TopBottom
(
)
/
2
;
aFrameMetrics
.
SetDisplayPortMargins
(
margins
)
;
}
static
CSSPoint
ScrollFrameTo
(
nsIScrollableFrame
*
aFrame
const
FrameMetrics
&
aMetrics
bool
&
aSuccessOut
)
{
aSuccessOut
=
false
;
CSSPoint
targetScrollPosition
=
aMetrics
.
GetScrollOffset
(
)
;
if
(
!
aFrame
)
{
return
targetScrollPosition
;
}
CSSPoint
geckoScrollPosition
=
CSSPoint
:
:
FromAppUnits
(
aFrame
-
>
GetScrollPosition
(
)
)
;
if
(
!
aMetrics
.
GetScrollOffsetUpdated
(
)
)
{
return
geckoScrollPosition
;
}
if
(
aFrame
-
>
GetScrollbarStyles
(
)
.
mVertical
=
=
NS_STYLE_OVERFLOW_HIDDEN
)
{
targetScrollPosition
.
y
=
geckoScrollPosition
.
y
;
}
if
(
aFrame
-
>
GetScrollbarStyles
(
)
.
mHorizontal
=
=
NS_STYLE_OVERFLOW_HIDDEN
)
{
targetScrollPosition
.
x
=
geckoScrollPosition
.
x
;
}
bool
scrollInProgress
=
APZCCallbackHelper
:
:
IsScrollInProgress
(
aFrame
)
;
if
(
!
scrollInProgress
)
{
aFrame
-
>
ScrollToCSSPixelsApproximate
(
targetScrollPosition
nsGkAtoms
:
:
apz
)
;
geckoScrollPosition
=
CSSPoint
:
:
FromAppUnits
(
aFrame
-
>
GetScrollPosition
(
)
)
;
aSuccessOut
=
true
;
}
return
geckoScrollPosition
;
}
static
void
ScrollFrame
(
nsIContent
*
aContent
FrameMetrics
&
aMetrics
)
{
nsIScrollableFrame
*
sf
=
nsLayoutUtils
:
:
FindScrollableFrameFor
(
aMetrics
.
GetScrollId
(
)
)
;
if
(
sf
)
{
sf
-
>
ResetScrollInfoIfGeneration
(
aMetrics
.
GetScrollGeneration
(
)
)
;
sf
-
>
SetScrollableByAPZ
(
!
aMetrics
.
IsScrollInfoLayer
(
)
)
;
}
bool
scrollUpdated
=
false
;
CSSPoint
apzScrollOffset
=
aMetrics
.
GetScrollOffset
(
)
;
CSSPoint
actualScrollOffset
=
ScrollFrameTo
(
sf
aMetrics
scrollUpdated
)
;
if
(
scrollUpdated
)
{
if
(
aMetrics
.
IsScrollInfoLayer
(
)
)
{
if
(
nsIFrame
*
frame
=
aContent
-
>
GetPrimaryFrame
(
)
)
{
frame
-
>
SchedulePaint
(
)
;
}
}
else
{
APZCCallbackHelper
:
:
AdjustDisplayPortForScrollDelta
(
aMetrics
actualScrollOffset
)
;
}
}
else
{
RecenterDisplayPort
(
aMetrics
)
;
}
aMetrics
.
SetScrollOffset
(
actualScrollOffset
)
;
bool
mainThreadScrollChanged
=
sf
&
&
sf
-
>
CurrentScrollGeneration
(
)
!
=
aMetrics
.
GetScrollGeneration
(
)
&
&
nsLayoutUtils
:
:
CanScrollOriginClobberApz
(
sf
-
>
LastScrollOrigin
(
)
)
;
if
(
aContent
&
&
!
mainThreadScrollChanged
)
{
CSSPoint
scrollDelta
=
apzScrollOffset
-
actualScrollOffset
;
aContent
-
>
SetProperty
(
nsGkAtoms
:
:
apzCallbackTransform
new
CSSPoint
(
scrollDelta
)
nsINode
:
:
DeleteProperty
<
CSSPoint
>
)
;
}
}
static
void
SetDisplayPortMargins
(
nsIPresShell
*
aPresShell
nsIContent
*
aContent
const
FrameMetrics
&
aMetrics
)
{
if
(
!
aContent
)
{
return
;
}
bool
hadDisplayPort
=
nsLayoutUtils
:
:
HasDisplayPort
(
aContent
)
;
ScreenMargin
margins
=
aMetrics
.
GetDisplayPortMargins
(
)
;
nsLayoutUtils
:
:
SetDisplayPortMargins
(
aContent
aPresShell
margins
0
)
;
if
(
!
hadDisplayPort
)
{
nsLayoutUtils
:
:
SetZeroMarginDisplayPortOnAsyncScrollableAncestors
(
aContent
-
>
GetPrimaryFrame
(
)
nsLayoutUtils
:
:
RepaintMode
:
:
Repaint
)
;
}
CSSRect
baseCSS
=
aMetrics
.
CalculateCompositedRectInCssPixels
(
)
;
nsRect
base
(
0
0
baseCSS
.
Width
(
)
*
nsPresContext
:
:
AppUnitsPerCSSPixel
(
)
baseCSS
.
Height
(
)
*
nsPresContext
:
:
AppUnitsPerCSSPixel
(
)
)
;
nsLayoutUtils
:
:
SetDisplayPortBaseIfNotSet
(
aContent
base
)
;
}
static
already_AddRefed
<
nsIPresShell
>
GetPresShell
(
const
nsIContent
*
aContent
)
{
nsCOMPtr
<
nsIPresShell
>
result
;
if
(
nsIDocument
*
doc
=
aContent
-
>
GetComposedDoc
(
)
)
{
result
=
doc
-
>
GetShell
(
)
;
}
return
result
.
forget
(
)
;
}
static
void
SetPaintRequestTime
(
nsIContent
*
aContent
const
TimeStamp
&
aPaintRequestTime
)
{
aContent
-
>
SetProperty
(
nsGkAtoms
:
:
paintRequestTime
new
TimeStamp
(
aPaintRequestTime
)
nsINode
:
:
DeleteProperty
<
TimeStamp
>
)
;
}
void
APZCCallbackHelper
:
:
UpdateRootFrame
(
FrameMetrics
&
aMetrics
)
{
if
(
aMetrics
.
GetScrollId
(
)
=
=
FrameMetrics
:
:
NULL_SCROLL_ID
)
{
return
;
}
nsIContent
*
content
=
nsLayoutUtils
:
:
FindContentFor
(
aMetrics
.
GetScrollId
(
)
)
;
if
(
!
content
)
{
return
;
}
nsCOMPtr
<
nsIPresShell
>
shell
=
GetPresShell
(
content
)
;
if
(
!
shell
|
|
aMetrics
.
GetPresShellId
(
)
!
=
shell
-
>
GetPresShellId
(
)
)
{
return
;
}
MOZ_ASSERT
(
aMetrics
.
GetUseDisplayPortMargins
(
)
)
;
if
(
gfxPrefs
:
:
APZAllowZooming
(
)
)
{
float
presShellResolution
=
shell
-
>
GetResolution
(
)
;
if
(
!
FuzzyEqualsMultiplicative
(
presShellResolution
aMetrics
.
GetPresShellResolution
(
)
)
)
{
return
;
}
presShellResolution
=
aMetrics
.
GetPresShellResolution
(
)
*
aMetrics
.
GetAsyncZoom
(
)
.
scale
;
shell
-
>
SetResolutionAndScaleTo
(
presShellResolution
)
;
}
ScrollFrame
(
content
aMetrics
)
;
SetDisplayPortMargins
(
shell
content
aMetrics
)
;
SetPaintRequestTime
(
content
aMetrics
.
GetPaintRequestTime
(
)
)
;
}
void
APZCCallbackHelper
:
:
UpdateSubFrame
(
FrameMetrics
&
aMetrics
)
{
if
(
aMetrics
.
GetScrollId
(
)
=
=
FrameMetrics
:
:
NULL_SCROLL_ID
)
{
return
;
}
nsIContent
*
content
=
nsLayoutUtils
:
:
FindContentFor
(
aMetrics
.
GetScrollId
(
)
)
;
if
(
!
content
)
{
return
;
}
MOZ_ASSERT
(
aMetrics
.
GetUseDisplayPortMargins
(
)
)
;
ScrollFrame
(
content
aMetrics
)
;
if
(
nsCOMPtr
<
nsIPresShell
>
shell
=
GetPresShell
(
content
)
)
{
SetDisplayPortMargins
(
shell
content
aMetrics
)
;
}
SetPaintRequestTime
(
content
aMetrics
.
GetPaintRequestTime
(
)
)
;
}
bool
APZCCallbackHelper
:
:
GetOrCreateScrollIdentifiers
(
nsIContent
*
aContent
uint32_t
*
aPresShellIdOut
FrameMetrics
:
:
ViewID
*
aViewIdOut
)
{
if
(
!
aContent
)
{
return
false
;
}
*
aViewIdOut
=
nsLayoutUtils
:
:
FindOrCreateIDFor
(
aContent
)
;
if
(
nsCOMPtr
<
nsIPresShell
>
shell
=
GetPresShell
(
aContent
)
)
{
*
aPresShellIdOut
=
shell
-
>
GetPresShellId
(
)
;
return
true
;
}
return
false
;
}
void
APZCCallbackHelper
:
:
InitializeRootDisplayport
(
nsIPresShell
*
aPresShell
)
{
if
(
!
aPresShell
)
{
return
;
}
MOZ_ASSERT
(
aPresShell
-
>
GetDocument
(
)
)
;
nsIContent
*
content
=
aPresShell
-
>
GetDocument
(
)
-
>
GetDocumentElement
(
)
;
if
(
!
content
)
{
return
;
}
uint32_t
presShellId
;
FrameMetrics
:
:
ViewID
viewId
;
if
(
APZCCallbackHelper
:
:
GetOrCreateScrollIdentifiers
(
content
&
presShellId
&
viewId
)
)
{
nsPresContext
*
pc
=
aPresShell
-
>
GetPresContext
(
)
;
MOZ_ASSERT
(
!
pc
|
|
pc
-
>
IsRootContentDocument
(
)
|
|
!
pc
-
>
GetParentPresContext
(
)
)
;
nsIFrame
*
frame
=
aPresShell
-
>
GetRootScrollFrame
(
)
;
if
(
!
frame
)
{
frame
=
aPresShell
-
>
GetRootFrame
(
)
;
}
nsRect
baseRect
;
if
(
frame
)
{
baseRect
=
nsRect
(
nsPoint
(
0
0
)
nsLayoutUtils
:
:
CalculateCompositionSizeForFrame
(
frame
)
)
;
}
else
if
(
pc
)
{
baseRect
=
nsRect
(
nsPoint
(
0
0
)
pc
-
>
GetVisibleArea
(
)
.
Size
(
)
)
;
}
nsLayoutUtils
:
:
SetDisplayPortBaseIfNotSet
(
content
baseRect
)
;
nsLayoutUtils
:
:
SetDisplayPortMargins
(
content
aPresShell
ScreenMargin
(
)
0
nsLayoutUtils
:
:
RepaintMode
:
:
DoNotRepaint
)
;
nsLayoutUtils
:
:
SetZeroMarginDisplayPortOnAsyncScrollableAncestors
(
content
-
>
GetPrimaryFrame
(
)
nsLayoutUtils
:
:
RepaintMode
:
:
DoNotRepaint
)
;
}
}
nsPresContext
*
APZCCallbackHelper
:
:
GetPresContextForContent
(
nsIContent
*
aContent
)
{
nsIDocument
*
doc
=
aContent
-
>
GetComposedDoc
(
)
;
if
(
!
doc
)
{
return
nullptr
;
}
nsIPresShell
*
shell
=
doc
-
>
GetShell
(
)
;
if
(
!
shell
)
{
return
nullptr
;
}
return
shell
-
>
GetPresContext
(
)
;
}
nsIPresShell
*
APZCCallbackHelper
:
:
GetRootContentDocumentPresShellForContent
(
nsIContent
*
aContent
)
{
nsPresContext
*
context
=
GetPresContextForContent
(
aContent
)
;
if
(
!
context
)
{
return
nullptr
;
}
context
=
context
-
>
GetToplevelContentDocumentPresContext
(
)
;
if
(
!
context
)
{
return
nullptr
;
}
return
context
-
>
PresShell
(
)
;
}
static
nsIPresShell
*
GetRootDocumentPresShell
(
nsIContent
*
aContent
)
{
nsIDocument
*
doc
=
aContent
-
>
GetComposedDoc
(
)
;
if
(
!
doc
)
{
return
nullptr
;
}
nsIPresShell
*
shell
=
doc
-
>
GetShell
(
)
;
if
(
!
shell
)
{
return
nullptr
;
}
nsPresContext
*
context
=
shell
-
>
GetPresContext
(
)
;
if
(
!
context
)
{
return
nullptr
;
}
context
=
context
-
>
GetRootPresContext
(
)
;
if
(
!
context
)
{
return
nullptr
;
}
return
context
-
>
PresShell
(
)
;
}
CSSPoint
APZCCallbackHelper
:
:
ApplyCallbackTransform
(
const
CSSPoint
&
aInput
const
ScrollableLayerGuid
&
aGuid
)
{
CSSPoint
input
=
aInput
;
if
(
aGuid
.
mScrollId
=
=
FrameMetrics
:
:
NULL_SCROLL_ID
)
{
return
input
;
}
nsCOMPtr
<
nsIContent
>
content
=
nsLayoutUtils
:
:
FindContentFor
(
aGuid
.
mScrollId
)
;
if
(
!
content
)
{
return
input
;
}
if
(
nsIPresShell
*
shell
=
GetRootDocumentPresShell
(
content
)
)
{
input
=
input
/
shell
-
>
GetResolution
(
)
;
}
float
nonRootResolution
=
1
.
0f
;
if
(
nsIPresShell
*
shell
=
GetRootContentDocumentPresShellForContent
(
content
)
)
{
nonRootResolution
=
shell
-
>
GetCumulativeNonRootScaleResolution
(
)
;
}
CSSPoint
transform
=
nsLayoutUtils
:
:
GetCumulativeApzCallbackTransform
(
content
-
>
GetPrimaryFrame
(
)
)
;
return
input
+
transform
*
nonRootResolution
;
}
LayoutDeviceIntPoint
APZCCallbackHelper
:
:
ApplyCallbackTransform
(
const
LayoutDeviceIntPoint
&
aPoint
const
ScrollableLayerGuid
&
aGuid
const
CSSToLayoutDeviceScale
&
aScale
)
{
LayoutDevicePoint
point
=
LayoutDevicePoint
(
aPoint
.
x
aPoint
.
y
)
;
point
=
ApplyCallbackTransform
(
point
/
aScale
aGuid
)
*
aScale
;
return
LayoutDeviceIntPoint
:
:
Round
(
point
)
;
}
void
APZCCallbackHelper
:
:
ApplyCallbackTransform
(
WidgetEvent
&
aEvent
const
ScrollableLayerGuid
&
aGuid
const
CSSToLayoutDeviceScale
&
aScale
)
{
if
(
aEvent
.
AsTouchEvent
(
)
)
{
WidgetTouchEvent
&
event
=
*
(
aEvent
.
AsTouchEvent
(
)
)
;
for
(
size_t
i
=
0
;
i
<
event
.
mTouches
.
Length
(
)
;
i
+
+
)
{
event
.
mTouches
[
i
]
-
>
mRefPoint
=
ApplyCallbackTransform
(
event
.
mTouches
[
i
]
-
>
mRefPoint
aGuid
aScale
)
;
}
}
else
{
aEvent
.
mRefPoint
=
ApplyCallbackTransform
(
aEvent
.
mRefPoint
aGuid
aScale
)
;
}
}
nsEventStatus
APZCCallbackHelper
:
:
DispatchWidgetEvent
(
WidgetGUIEvent
&
aEvent
)
{
nsEventStatus
status
=
nsEventStatus_eConsumeNoDefault
;
if
(
aEvent
.
mWidget
)
{
aEvent
.
mWidget
-
>
DispatchEvent
(
&
aEvent
status
)
;
}
return
status
;
}
nsEventStatus
APZCCallbackHelper
:
:
DispatchSynthesizedMouseEvent
(
EventMessage
aMsg
uint64_t
aTime
const
LayoutDevicePoint
&
aRefPoint
Modifiers
aModifiers
int32_t
aClickCount
nsIWidget
*
aWidget
)
{
MOZ_ASSERT
(
aMsg
=
=
eMouseMove
|
|
aMsg
=
=
eMouseDown
|
|
aMsg
=
=
eMouseUp
|
|
aMsg
=
=
eMouseLongTap
)
;
WidgetMouseEvent
event
(
true
aMsg
aWidget
WidgetMouseEvent
:
:
eReal
WidgetMouseEvent
:
:
eNormal
)
;
event
.
mRefPoint
=
LayoutDeviceIntPoint
:
:
Truncate
(
aRefPoint
.
x
aRefPoint
.
y
)
;
event
.
mTime
=
aTime
;
event
.
button
=
WidgetMouseEvent
:
:
eLeftButton
;
event
.
inputSource
=
nsIDOMMouseEvent
:
:
MOZ_SOURCE_TOUCH
;
if
(
aMsg
=
=
eMouseLongTap
)
{
event
.
mFlags
.
mOnlyChromeDispatch
=
true
;
}
event
.
mIgnoreRootScrollFrame
=
true
;
if
(
aMsg
!
=
eMouseMove
)
{
event
.
mClickCount
=
aClickCount
;
}
event
.
mModifiers
=
aModifiers
;
event
.
convertToPointer
=
false
;
return
DispatchWidgetEvent
(
event
)
;
}
bool
APZCCallbackHelper
:
:
DispatchMouseEvent
(
const
nsCOMPtr
<
nsIPresShell
>
&
aPresShell
const
nsString
&
aType
const
CSSPoint
&
aPoint
int32_t
aButton
int32_t
aClickCount
int32_t
aModifiers
bool
aIgnoreRootScrollFrame
unsigned
short
aInputSourceArg
uint32_t
aPointerId
)
{
NS_ENSURE_TRUE
(
aPresShell
true
)
;
bool
defaultPrevented
=
false
;
nsContentUtils
:
:
SendMouseEvent
(
aPresShell
aType
aPoint
.
x
aPoint
.
y
aButton
nsIDOMWindowUtils
:
:
MOUSE_BUTTONS_NOT_SPECIFIED
aClickCount
aModifiers
aIgnoreRootScrollFrame
0
aInputSourceArg
aPointerId
false
&
defaultPrevented
false
false
)
;
return
defaultPrevented
;
}
void
APZCCallbackHelper
:
:
FireSingleTapEvent
(
const
LayoutDevicePoint
&
aPoint
Modifiers
aModifiers
int32_t
aClickCount
nsIWidget
*
aWidget
)
{
if
(
aWidget
-
>
Destroyed
(
)
)
{
return
;
}
APZCCH_LOG
(
"
Dispatching
single
-
tap
component
events
to
%
s
\
n
"
Stringify
(
aPoint
)
.
c_str
(
)
)
;
int
time
=
0
;
DispatchSynthesizedMouseEvent
(
eMouseMove
time
aPoint
aModifiers
aClickCount
aWidget
)
;
DispatchSynthesizedMouseEvent
(
eMouseDown
time
aPoint
aModifiers
aClickCount
aWidget
)
;
DispatchSynthesizedMouseEvent
(
eMouseUp
time
aPoint
aModifiers
aClickCount
aWidget
)
;
}
static
dom
:
:
Element
*
GetDisplayportElementFor
(
nsIScrollableFrame
*
aScrollableFrame
)
{
if
(
!
aScrollableFrame
)
{
return
nullptr
;
}
nsIFrame
*
scrolledFrame
=
aScrollableFrame
-
>
GetScrolledFrame
(
)
;
if
(
!
scrolledFrame
)
{
return
nullptr
;
}
nsIContent
*
content
=
scrolledFrame
-
>
GetContent
(
)
;
MOZ_ASSERT
(
content
-
>
IsElement
(
)
)
;
return
content
-
>
AsElement
(
)
;
}
static
dom
:
:
Element
*
GetRootDocumentElementFor
(
nsIWidget
*
aWidget
)
{
if
(
nsView
*
view
=
nsView
:
:
GetViewFor
(
aWidget
)
)
{
if
(
nsIPresShell
*
shell
=
view
-
>
GetPresShell
(
)
)
{
MOZ_ASSERT
(
shell
-
>
GetDocument
(
)
)
;
return
shell
-
>
GetDocument
(
)
-
>
GetDocumentElement
(
)
;
}
}
return
nullptr
;
}
static
nsIFrame
*
UpdateRootFrameForTouchTargetDocument
(
nsIFrame
*
aRootFrame
)
{
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
nsIDocument
*
doc
=
aRootFrame
-
>
PresContext
(
)
-
>
PresShell
(
)
-
>
GetPrimaryContentDocument
(
)
)
{
if
(
nsIPresShell
*
shell
=
doc
-
>
GetShell
(
)
)
{
if
(
nsIFrame
*
frame
=
shell
-
>
GetRootFrame
(
)
)
{
return
frame
;
}
}
}
#
endif
return
aRootFrame
;
}
static
bool
PrepareForSetTargetAPZCNotification
(
nsIWidget
*
aWidget
const
ScrollableLayerGuid
&
aGuid
nsIFrame
*
aRootFrame
const
LayoutDeviceIntPoint
&
aRefPoint
nsTArray
<
ScrollableLayerGuid
>
*
aTargets
)
{
ScrollableLayerGuid
guid
(
aGuid
.
mLayersId
0
FrameMetrics
:
:
NULL_SCROLL_ID
)
;
nsPoint
point
=
nsLayoutUtils
:
:
GetEventCoordinatesRelativeTo
(
aWidget
aRefPoint
aRootFrame
)
;
uint32_t
flags
=
0
;
#
ifdef
MOZ_WIDGET_ANDROID
flags
=
nsLayoutUtils
:
:
IGNORE_ROOT_SCROLL_FRAME
;
#
endif
nsIFrame
*
target
=
nsLayoutUtils
:
:
GetFrameForPoint
(
aRootFrame
point
flags
)
;
nsIScrollableFrame
*
scrollAncestor
=
target
?
nsLayoutUtils
:
:
GetAsyncScrollableAncestorFrame
(
target
)
:
aRootFrame
-
>
PresContext
(
)
-
>
PresShell
(
)
-
>
GetRootScrollFrameAsScrollable
(
)
;
nsCOMPtr
<
dom
:
:
Element
>
dpElement
=
scrollAncestor
?
GetDisplayportElementFor
(
scrollAncestor
)
:
GetRootDocumentElementFor
(
aWidget
)
;
#
ifdef
APZCCH_LOGGING
nsAutoString
dpElementDesc
;
if
(
dpElement
)
{
dpElement
-
>
Describe
(
dpElementDesc
)
;
}
APZCCH_LOG
(
"
For
event
at
%
s
found
scrollable
element
%
p
(
%
s
)
\
n
"
Stringify
(
aRefPoint
)
.
c_str
(
)
dpElement
.
get
(
)
NS_LossyConvertUTF16toASCII
(
dpElementDesc
)
.
get
(
)
)
;
#
endif
bool
guidIsValid
=
APZCCallbackHelper
:
:
GetOrCreateScrollIdentifiers
(
dpElement
&
(
guid
.
mPresShellId
)
&
(
guid
.
mScrollId
)
)
;
aTargets
-
>
AppendElement
(
guid
)
;
if
(
!
guidIsValid
|
|
nsLayoutUtils
:
:
HasDisplayPort
(
dpElement
)
)
{
return
false
;
}
if
(
!
scrollAncestor
)
{
MOZ_ASSERT
(
false
)
;
APZCCH_LOG
(
"
Widget
%
p
'
s
document
element
%
p
didn
'
t
have
a
displayport
\
n
"
aWidget
dpElement
.
get
(
)
)
;
APZCCallbackHelper
:
:
InitializeRootDisplayport
(
aRootFrame
-
>
PresContext
(
)
-
>
PresShell
(
)
)
;
return
false
;
}
APZCCH_LOG
(
"
%
p
didn
'
t
have
a
displayport
so
setting
one
.
.
.
\
n
"
dpElement
.
get
(
)
)
;
bool
activated
=
nsLayoutUtils
:
:
CalculateAndSetDisplayPortMargins
(
scrollAncestor
nsLayoutUtils
:
:
RepaintMode
:
:
Repaint
)
;
if
(
!
activated
)
{
return
false
;
}
nsIFrame
*
frame
=
do_QueryFrame
(
scrollAncestor
)
;
nsLayoutUtils
:
:
SetZeroMarginDisplayPortOnAsyncScrollableAncestors
(
frame
nsLayoutUtils
:
:
RepaintMode
:
:
Repaint
)
;
return
true
;
}
static
void
SendLayersDependentApzcTargetConfirmation
(
nsIPresShell
*
aShell
uint64_t
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
)
{
LayerManager
*
lm
=
aShell
-
>
GetLayerManager
(
)
;
if
(
!
lm
)
{
return
;
}
if
(
WebRenderLayerManager
*
wrlm
=
lm
-
>
AsWebRenderLayerManager
(
)
)
{
if
(
WebRenderBridgeChild
*
wrbc
=
wrlm
-
>
WrBridge
(
)
)
{
wrbc
-
>
SendSetConfirmedTargetAPZC
(
aInputBlockId
aTargets
)
;
}
return
;
}
LayerTransactionChild
*
shadow
=
lm
-
>
AsShadowForwarder
(
)
-
>
GetShadowManager
(
)
;
if
(
!
shadow
)
{
return
;
}
shadow
-
>
SendSetConfirmedTargetAPZC
(
aInputBlockId
aTargets
)
;
}
class
DisplayportSetListener
:
public
nsAPostRefreshObserver
{
public
:
DisplayportSetListener
(
nsIPresShell
*
aPresShell
const
uint64_t
&
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
)
:
mPresShell
(
aPresShell
)
mInputBlockId
(
aInputBlockId
)
mTargets
(
aTargets
)
{
}
virtual
~
DisplayportSetListener
(
)
{
}
void
DidRefresh
(
)
override
{
if
(
!
mPresShell
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Post
-
refresh
observer
fired
again
after
failed
attempt
at
unregistering
it
"
)
;
return
;
}
APZCCH_LOG
(
"
Got
refresh
sending
target
APZCs
for
input
block
%
"
PRIu64
"
\
n
"
mInputBlockId
)
;
SendLayersDependentApzcTargetConfirmation
(
mPresShell
mInputBlockId
Move
(
mTargets
)
)
;
if
(
!
mPresShell
-
>
RemovePostRefreshObserver
(
this
)
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Unable
to
unregister
post
-
refresh
observer
!
Leaking
it
instead
of
leaving
garbage
registered
"
)
;
mPresShell
=
nullptr
;
return
;
}
delete
this
;
}
private
:
RefPtr
<
nsIPresShell
>
mPresShell
;
uint64_t
mInputBlockId
;
nsTArray
<
ScrollableLayerGuid
>
mTargets
;
}
;
static
void
SendSetTargetAPZCNotificationHelper
(
nsIWidget
*
aWidget
nsIPresShell
*
aShell
const
uint64_t
&
aInputBlockId
const
nsTArray
<
ScrollableLayerGuid
>
&
aTargets
bool
aWaitForRefresh
)
{
bool
waitForRefresh
=
aWaitForRefresh
;
if
(
waitForRefresh
)
{
APZCCH_LOG
(
"
At
least
one
target
got
a
new
displayport
need
to
wait
for
refresh
\
n
"
)
;
waitForRefresh
=
aShell
-
>
AddPostRefreshObserver
(
new
DisplayportSetListener
(
aShell
aInputBlockId
Move
(
aTargets
)
)
)
;
}
if
(
!
waitForRefresh
)
{
APZCCH_LOG
(
"
Sending
target
APZCs
for
input
block
%
"
PRIu64
"
\
n
"
aInputBlockId
)
;
aWidget
-
>
SetConfirmedTargetAPZC
(
aInputBlockId
aTargets
)
;
}
else
{
APZCCH_LOG
(
"
Successfully
registered
post
-
refresh
observer
\
n
"
)
;
}
}
bool
APZCCallbackHelper
:
:
SendSetTargetAPZCNotification
(
nsIWidget
*
aWidget
nsIDocument
*
aDocument
const
WidgetGUIEvent
&
aEvent
const
ScrollableLayerGuid
&
aGuid
uint64_t
aInputBlockId
)
{
if
(
!
aWidget
|
|
!
aDocument
)
{
return
false
;
}
if
(
aInputBlockId
=
=
sLastTargetAPZCNotificationInputBlock
)
{
APZCCH_LOG
(
"
Not
resending
target
APZC
confirmation
for
input
block
%
"
PRIu64
"
\
n
"
aInputBlockId
)
;
return
false
;
}
sLastTargetAPZCNotificationInputBlock
=
aInputBlockId
;
if
(
nsIPresShell
*
shell
=
aDocument
-
>
GetShell
(
)
)
{
if
(
nsIFrame
*
rootFrame
=
shell
-
>
GetRootFrame
(
)
)
{
rootFrame
=
UpdateRootFrameForTouchTargetDocument
(
rootFrame
)
;
bool
waitForRefresh
=
false
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
if
(
const
WidgetTouchEvent
*
touchEvent
=
aEvent
.
AsTouchEvent
(
)
)
{
for
(
size_t
i
=
0
;
i
<
touchEvent
-
>
mTouches
.
Length
(
)
;
i
+
+
)
{
waitForRefresh
|
=
PrepareForSetTargetAPZCNotification
(
aWidget
aGuid
rootFrame
touchEvent
-
>
mTouches
[
i
]
-
>
mRefPoint
&
targets
)
;
}
}
else
if
(
const
WidgetWheelEvent
*
wheelEvent
=
aEvent
.
AsWheelEvent
(
)
)
{
waitForRefresh
=
PrepareForSetTargetAPZCNotification
(
aWidget
aGuid
rootFrame
wheelEvent
-
>
mRefPoint
&
targets
)
;
}
else
if
(
const
WidgetMouseEvent
*
mouseEvent
=
aEvent
.
AsMouseEvent
(
)
)
{
waitForRefresh
=
PrepareForSetTargetAPZCNotification
(
aWidget
aGuid
rootFrame
mouseEvent
-
>
mRefPoint
&
targets
)
;
}
if
(
!
targets
.
IsEmpty
(
)
)
{
SendSetTargetAPZCNotificationHelper
(
aWidget
shell
aInputBlockId
Move
(
targets
)
waitForRefresh
)
;
}
return
waitForRefresh
;
}
}
return
false
;
}
void
APZCCallbackHelper
:
:
SendSetAllowedTouchBehaviorNotification
(
nsIWidget
*
aWidget
nsIDocument
*
aDocument
const
WidgetTouchEvent
&
aEvent
uint64_t
aInputBlockId
const
SetAllowedTouchBehaviorCallback
&
aCallback
)
{
if
(
nsIPresShell
*
shell
=
aDocument
-
>
GetShell
(
)
)
{
if
(
nsIFrame
*
rootFrame
=
shell
-
>
GetRootFrame
(
)
)
{
rootFrame
=
UpdateRootFrameForTouchTargetDocument
(
rootFrame
)
;
nsTArray
<
TouchBehaviorFlags
>
flags
;
for
(
uint32_t
i
=
0
;
i
<
aEvent
.
mTouches
.
Length
(
)
;
i
+
+
)
{
flags
.
AppendElement
(
TouchActionHelper
:
:
GetAllowedTouchBehavior
(
aWidget
rootFrame
aEvent
.
mTouches
[
i
]
-
>
mRefPoint
)
)
;
}
aCallback
(
aInputBlockId
Move
(
flags
)
)
;
}
}
}
void
APZCCallbackHelper
:
:
NotifyMozMouseScrollEvent
(
const
FrameMetrics
:
:
ViewID
&
aScrollId
const
nsString
&
aEvent
)
{
nsCOMPtr
<
nsIContent
>
targetContent
=
nsLayoutUtils
:
:
FindContentFor
(
aScrollId
)
;
if
(
!
targetContent
)
{
return
;
}
nsCOMPtr
<
nsIDocument
>
ownerDoc
=
targetContent
-
>
OwnerDoc
(
)
;
if
(
!
ownerDoc
)
{
return
;
}
nsContentUtils
:
:
DispatchTrustedEvent
(
ownerDoc
targetContent
aEvent
true
true
)
;
}
void
APZCCallbackHelper
:
:
NotifyFlushComplete
(
nsIPresShell
*
aShell
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
aShell
&
&
aShell
-
>
GetRootFrame
(
)
)
{
aShell
-
>
GetRootFrame
(
)
-
>
SchedulePaint
(
)
;
}
nsCOMPtr
<
nsIObserverService
>
observerService
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
MOZ_ASSERT
(
observerService
)
;
observerService
-
>
NotifyObservers
(
nullptr
"
apz
-
repaints
-
flushed
"
nullptr
)
;
}
static
int32_t
sActiveSuppressDisplayport
=
0
;
static
bool
sDisplayPortSuppressionRespected
=
true
;
void
APZCCallbackHelper
:
:
SuppressDisplayport
(
const
bool
&
aEnabled
const
nsCOMPtr
<
nsIPresShell
>
&
aShell
)
{
if
(
aEnabled
)
{
sActiveSuppressDisplayport
+
+
;
}
else
{
bool
isSuppressed
=
IsDisplayportSuppressed
(
)
;
sActiveSuppressDisplayport
-
-
;
if
(
isSuppressed
&
&
!
IsDisplayportSuppressed
(
)
&
&
aShell
&
&
aShell
-
>
GetRootFrame
(
)
)
{
aShell
-
>
GetRootFrame
(
)
-
>
SchedulePaint
(
)
;
}
}
MOZ_ASSERT
(
sActiveSuppressDisplayport
>
=
0
)
;
}
void
APZCCallbackHelper
:
:
RespectDisplayPortSuppression
(
bool
aEnabled
const
nsCOMPtr
<
nsIPresShell
>
&
aShell
)
{
bool
isSuppressed
=
IsDisplayportSuppressed
(
)
;
sDisplayPortSuppressionRespected
=
aEnabled
;
if
(
isSuppressed
&
&
!
IsDisplayportSuppressed
(
)
&
&
aShell
&
&
aShell
-
>
GetRootFrame
(
)
)
{
aShell
-
>
GetRootFrame
(
)
-
>
SchedulePaint
(
)
;
}
}
bool
APZCCallbackHelper
:
:
IsDisplayportSuppressed
(
)
{
return
sDisplayPortSuppressionRespected
&
&
sActiveSuppressDisplayport
>
0
;
}
bool
APZCCallbackHelper
:
:
IsScrollInProgress
(
nsIScrollableFrame
*
aFrame
)
{
return
aFrame
-
>
IsProcessingAsyncScroll
(
)
|
|
nsLayoutUtils
:
:
CanScrollOriginClobberApz
(
aFrame
-
>
LastScrollOrigin
(
)
)
|
|
aFrame
-
>
LastSmoothScrollOrigin
(
)
;
}
void
APZCCallbackHelper
:
:
NotifyAsyncScrollbarDragRejected
(
const
FrameMetrics
:
:
ViewID
&
aScrollId
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
nsIScrollableFrame
*
scrollFrame
=
nsLayoutUtils
:
:
FindScrollableFrameFor
(
aScrollId
)
)
{
scrollFrame
-
>
AsyncScrollbarDragRejected
(
)
;
}
}
void
APZCCallbackHelper
:
:
NotifyAutoscrollHandledByAPZ
(
const
FrameMetrics
:
:
ViewID
&
aScrollId
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
nsCOMPtr
<
nsIObserverService
>
observerService
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
MOZ_ASSERT
(
observerService
)
;
nsAutoString
data
;
data
.
AppendInt
(
aScrollId
)
;
observerService
-
>
NotifyObservers
(
nullptr
"
autoscroll
-
handled
-
by
-
apz
"
data
.
get
(
)
)
;
}
void
APZCCallbackHelper
:
:
CancelAutoscroll
(
const
FrameMetrics
:
:
ViewID
&
aScrollId
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
nsCOMPtr
<
nsIObserverService
>
observerService
=
mozilla
:
:
services
:
:
GetObserverService
(
)
;
MOZ_ASSERT
(
observerService
)
;
nsAutoString
data
;
data
.
AppendInt
(
aScrollId
)
;
observerService
-
>
NotifyObservers
(
nullptr
"
apz
:
cancel
-
autoscroll
"
data
.
get
(
)
)
;
}
void
APZCCallbackHelper
:
:
NotifyPinchGesture
(
PinchGestureInput
:
:
PinchGestureType
aType
LayoutDeviceCoord
aSpanChange
Modifiers
aModifiers
nsIWidget
*
aWidget
)
{
EventMessage
msg
;
switch
(
aType
)
{
case
PinchGestureInput
:
:
PINCHGESTURE_START
:
msg
=
eMagnifyGestureStart
;
break
;
case
PinchGestureInput
:
:
PINCHGESTURE_SCALE
:
msg
=
eMagnifyGestureUpdate
;
break
;
case
PinchGestureInput
:
:
PINCHGESTURE_END
:
msg
=
eMagnifyGesture
;
break
;
}
WidgetSimpleGestureEvent
event
(
true
msg
aWidget
)
;
event
.
mDelta
=
aSpanChange
;
event
.
mModifiers
=
aModifiers
;
DispatchWidgetEvent
(
event
)
;
}
}
}
