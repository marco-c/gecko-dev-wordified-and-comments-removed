#
include
"
TouchActionHelper
.
h
"
#
include
"
mozilla
/
layers
/
IAPZCTreeManager
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
TouchEvents
.
h
"
#
include
"
nsContainerFrame
.
h
"
#
include
"
nsIFrameInlines
.
h
"
#
include
"
nsIScrollableFrame
.
h
"
#
include
"
nsLayoutUtils
.
h
"
namespace
mozilla
:
:
layers
{
static
void
UpdateAllowedBehavior
(
StyleTouchAction
aTouchActionValue
bool
aConsiderPanning
TouchBehaviorFlags
&
aOutBehavior
)
{
if
(
aTouchActionValue
!
=
StyleTouchAction
:
:
AUTO
)
{
aOutBehavior
&
=
~
AllowedTouchBehavior
:
:
ANIMATING_ZOOM
;
if
(
aTouchActionValue
!
=
StyleTouchAction
:
:
MANIPULATION
&
&
!
(
aTouchActionValue
&
StyleTouchAction
:
:
PINCH_ZOOM
)
)
{
aOutBehavior
&
=
~
AllowedTouchBehavior
:
:
PINCH_ZOOM
;
}
}
if
(
aConsiderPanning
)
{
if
(
aTouchActionValue
=
=
StyleTouchAction
:
:
NONE
)
{
aOutBehavior
&
=
~
AllowedTouchBehavior
:
:
VERTICAL_PAN
;
aOutBehavior
&
=
~
AllowedTouchBehavior
:
:
HORIZONTAL_PAN
;
}
if
(
(
aTouchActionValue
&
StyleTouchAction
:
:
PAN_X
)
&
&
!
(
aTouchActionValue
&
StyleTouchAction
:
:
PAN_Y
)
)
{
aOutBehavior
&
=
~
AllowedTouchBehavior
:
:
VERTICAL_PAN
;
}
else
if
(
(
aTouchActionValue
&
StyleTouchAction
:
:
PAN_Y
)
&
&
!
(
aTouchActionValue
&
StyleTouchAction
:
:
PAN_X
)
)
{
aOutBehavior
&
=
~
AllowedTouchBehavior
:
:
HORIZONTAL_PAN
;
}
}
}
static
TouchBehaviorFlags
GetAllowedTouchBehaviorForPoint
(
nsIWidget
*
aWidget
RelativeTo
aRootFrame
const
LayoutDeviceIntPoint
&
aPoint
)
{
nsPoint
relativePoint
=
nsLayoutUtils
:
:
GetEventCoordinatesRelativeTo
(
aWidget
aPoint
aRootFrame
)
;
nsIFrame
*
target
=
nsLayoutUtils
:
:
GetFrameForPoint
(
aRootFrame
relativePoint
)
;
return
TouchActionHelper
:
:
GetAllowedTouchBehaviorForFrame
(
target
)
;
}
nsTArray
<
TouchBehaviorFlags
>
TouchActionHelper
:
:
GetAllowedTouchBehavior
(
nsIWidget
*
aWidget
dom
:
:
Document
*
aDocument
const
WidgetTouchEvent
&
aEvent
)
{
nsTArray
<
TouchBehaviorFlags
>
flags
;
if
(
!
aWidget
|
|
!
aDocument
)
{
return
flags
;
}
if
(
PresShell
*
presShell
=
aDocument
-
>
GetPresShell
(
)
)
{
if
(
nsIFrame
*
rootFrame
=
presShell
-
>
GetRootFrame
(
)
)
{
for
(
const
auto
&
touch
:
aEvent
.
mTouches
)
{
flags
.
AppendElement
(
GetAllowedTouchBehaviorForPoint
(
aWidget
RelativeTo
{
rootFrame
ViewportType
:
:
Visual
}
touch
-
>
mRefPoint
)
)
;
}
}
}
return
flags
;
}
TouchBehaviorFlags
TouchActionHelper
:
:
GetAllowedTouchBehaviorForFrame
(
nsIFrame
*
aFrame
)
{
TouchBehaviorFlags
behavior
=
AllowedTouchBehavior
:
:
VERTICAL_PAN
|
AllowedTouchBehavior
:
:
HORIZONTAL_PAN
|
AllowedTouchBehavior
:
:
PINCH_ZOOM
|
AllowedTouchBehavior
:
:
ANIMATING_ZOOM
;
if
(
!
aFrame
)
{
return
behavior
;
}
nsIScrollableFrame
*
nearestScrollableParent
=
nsLayoutUtils
:
:
GetNearestScrollableFrame
(
aFrame
0
)
;
nsIFrame
*
nearestScrollableFrame
=
do_QueryFrame
(
nearestScrollableParent
)
;
bool
considerPanning
=
true
;
for
(
nsIFrame
*
frame
=
aFrame
;
frame
&
&
frame
-
>
GetContent
(
)
&
&
behavior
;
frame
=
frame
-
>
GetInFlowParent
(
)
)
{
UpdateAllowedBehavior
(
frame
-
>
UsedTouchAction
(
)
considerPanning
behavior
)
;
if
(
frame
=
=
nearestScrollableFrame
)
{
considerPanning
=
false
;
}
}
return
behavior
;
}
}
