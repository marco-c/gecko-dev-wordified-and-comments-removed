#
ifndef
mozilla_layers_APZSampler_h
#
define
mozilla_layers_APZSampler_h
#
include
"
LayersTypes
.
h
"
#
include
"
mozilla
/
layers
/
APZTestData
.
h
"
#
include
"
mozilla
/
layers
/
AsyncCompositionManager
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
Units
.
h
"
namespace
mozilla
{
class
TimeStamp
;
namespace
wr
{
class
TransactionBuilder
;
struct
WrTransformProperty
;
}
namespace
layers
{
class
APZCTreeManager
;
class
FocusTarget
;
class
Layer
;
class
LayerMetricsWrapper
;
struct
ScrollThumbData
;
class
WebRenderScrollData
;
class
APZSampler
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
APZSampler
)
public
:
explicit
APZSampler
(
const
RefPtr
<
APZCTreeManager
>
&
aApz
)
;
void
ClearTree
(
)
;
void
UpdateFocusState
(
LayersId
aRootLayerTreeId
LayersId
aOriginatingLayersId
const
FocusTarget
&
aFocusTarget
)
;
void
UpdateHitTestingTree
(
LayersId
aRootLayerTreeId
Layer
*
aRoot
bool
aIsFirstPaint
LayersId
aOriginatingLayersId
uint32_t
aPaintSequenceNumber
)
;
void
UpdateHitTestingTree
(
LayersId
aRootLayerTreeId
const
WebRenderScrollData
&
aScrollData
bool
aIsFirstPaint
LayersId
aOriginatingLayersId
uint32_t
aPaintSequenceNumber
)
;
void
NotifyLayerTreeAdopted
(
LayersId
aLayersId
const
RefPtr
<
APZSampler
>
&
aOldSampler
)
;
void
NotifyLayerTreeRemoved
(
LayersId
aLayersId
)
;
bool
PushStateToWR
(
wr
:
:
TransactionBuilder
&
aTxn
const
TimeStamp
&
aSampleTime
nsTArray
<
wr
:
:
WrTransformProperty
>
&
aTransformArray
)
;
bool
GetAPZTestData
(
LayersId
aLayersId
APZTestData
*
aOutData
)
;
void
SetTestAsyncScrollOffset
(
LayersId
aLayersId
const
FrameMetrics
:
:
ViewID
&
aScrollId
const
CSSPoint
&
aOffset
)
;
void
SetTestAsyncZoom
(
LayersId
aLayersId
const
FrameMetrics
:
:
ViewID
&
aScrollId
const
LayerToParentLayerScale
&
aZoom
)
;
bool
SampleAnimations
(
const
LayerMetricsWrapper
&
aLayer
const
TimeStamp
&
aSampleTime
)
;
LayerToParentLayerMatrix4x4
ComputeTransformForScrollThumb
(
const
LayerToParentLayerMatrix4x4
&
aCurrentTransform
const
LayerMetricsWrapper
&
aContent
const
ScrollThumbData
&
aThumbData
bool
aScrollbarIsDescendant
AsyncTransformComponentMatrix
*
aOutClipTransform
)
;
ParentLayerPoint
GetCurrentAsyncScrollOffset
(
const
LayerMetricsWrapper
&
aLayer
)
;
AsyncTransform
GetCurrentAsyncTransform
(
const
LayerMetricsWrapper
&
aLayer
)
;
AsyncTransformComponentMatrix
GetOverscrollTransform
(
const
LayerMetricsWrapper
&
aLayer
)
;
AsyncTransformComponentMatrix
GetCurrentAsyncTransformWithOverscroll
(
const
LayerMetricsWrapper
&
aLayer
)
;
void
MarkAsyncTransformAppliedToContent
(
const
LayerMetricsWrapper
&
aLayer
)
;
bool
HasUnusedAsyncTransform
(
const
LayerMetricsWrapper
&
aLayer
)
;
void
AssertOnSamplerThread
(
)
;
void
RunOnSamplerThread
(
already_AddRefed
<
Runnable
>
aTask
)
;
bool
IsSamplerThread
(
)
;
protected
:
virtual
~
APZSampler
(
)
;
private
:
RefPtr
<
APZCTreeManager
>
mApz
;
}
;
}
}
#
endif
