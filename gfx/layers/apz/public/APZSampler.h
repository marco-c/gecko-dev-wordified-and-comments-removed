#
ifndef
mozilla_layers_APZSampler_h
#
define
mozilla_layers_APZSampler_h
#
include
<
unordered_map
>
#
include
"
base
/
platform_thread
.
h
"
#
include
"
mozilla
/
layers
/
AsyncCompositionManager
.
h
"
#
include
"
mozilla
/
StaticMutex
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
Units
.
h
"
namespace
mozilla
{
class
TimeStamp
;
namespace
wr
{
struct
Transaction
;
class
TransactionWrapper
;
struct
WrTransformProperty
;
struct
WrWindowId
;
}
namespace
layers
{
class
APZCTreeManager
;
class
LayerMetricsWrapper
;
struct
ScrollbarData
;
class
APZSampler
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
APZSampler
)
public
:
APZSampler
(
const
RefPtr
<
APZCTreeManager
>
&
aApz
bool
aIsUsingWebRender
)
;
void
SetWebRenderWindowId
(
const
wr
:
:
WindowId
&
aWindowId
)
;
static
void
SetSamplerThread
(
const
wr
:
:
WrWindowId
&
aWindowId
)
;
static
void
SampleForWebRender
(
const
wr
:
:
WrWindowId
&
aWindowId
wr
:
:
Transaction
*
aTxn
)
;
void
SetSampleTime
(
const
TimeStamp
&
aSampleTime
)
;
void
SampleForWebRender
(
wr
:
:
TransactionWrapper
&
aTxn
)
;
bool
SampleAnimations
(
const
LayerMetricsWrapper
&
aLayer
const
TimeStamp
&
aSampleTime
)
;
LayerToParentLayerMatrix4x4
ComputeTransformForScrollThumb
(
const
LayerToParentLayerMatrix4x4
&
aCurrentTransform
const
LayerMetricsWrapper
&
aContent
const
ScrollbarData
&
aThumbData
bool
aScrollbarIsDescendant
AsyncTransformComponentMatrix
*
aOutClipTransform
)
;
ParentLayerPoint
GetCurrentAsyncScrollOffset
(
const
LayerMetricsWrapper
&
aLayer
)
;
AsyncTransform
GetCurrentAsyncTransform
(
const
LayerMetricsWrapper
&
aLayer
)
;
AsyncTransformComponentMatrix
GetOverscrollTransform
(
const
LayerMetricsWrapper
&
aLayer
)
;
AsyncTransformComponentMatrix
GetCurrentAsyncTransformWithOverscroll
(
const
LayerMetricsWrapper
&
aLayer
)
;
void
MarkAsyncTransformAppliedToContent
(
const
LayerMetricsWrapper
&
aLayer
)
;
bool
HasUnusedAsyncTransform
(
const
LayerMetricsWrapper
&
aLayer
)
;
void
AssertOnSamplerThread
(
)
const
;
bool
IsSamplerThread
(
)
const
;
protected
:
virtual
~
APZSampler
(
)
;
static
already_AddRefed
<
APZSampler
>
GetSampler
(
const
wr
:
:
WrWindowId
&
aWindowId
)
;
private
:
RefPtr
<
APZCTreeManager
>
mApz
;
bool
mIsUsingWebRender
;
static
StaticMutex
sWindowIdLock
;
static
StaticAutoPtr
<
std
:
:
unordered_map
<
uint64_t
APZSampler
*
>
>
sWindowIdMap
;
Maybe
<
wr
:
:
WrWindowId
>
mWindowId
;
mutable
Mutex
mThreadIdLock
;
Maybe
<
PlatformThreadId
>
mSamplerThreadId
;
Mutex
mSampleTimeLock
;
TimeStamp
mSampleTime
;
}
;
}
}
#
endif
