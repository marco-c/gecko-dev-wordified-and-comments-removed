async
function
hitTestOOPIF
(
point
iframeElement
)
{
let
getIframeCompositorTestData
=
async
iframe
=
>
{
let
data
=
await
SpecialPowers
.
spawn
(
iframe
[
]
(
)
=
>
{
let
utils
=
SpecialPowers
.
getDOMWindowUtils
(
content
.
window
)
;
return
JSON
.
stringify
(
utils
.
getCompositorAPZTestData
(
)
)
;
}
)
;
return
JSON
.
parse
(
data
)
;
}
;
let
utils
=
SpecialPowers
.
getDOMWindowUtils
(
window
)
;
let
oldParentTestData
=
utils
.
getCompositorAPZTestData
(
)
;
let
oldIframeTestData
=
await
getIframeCompositorTestData
(
iframeElement
)
;
let
hittestPromise
=
SpecialPowers
.
spawnChrome
(
[
]
(
)
=
>
{
return
new
Promise
(
resolve
=
>
{
browsingContext
.
topChromeWindow
.
addEventListener
(
"
MozMouseHittest
"
(
)
=
>
{
resolve
(
)
;
}
{
once
:
true
}
)
;
}
)
;
}
)
;
await
SpecialPowers
.
executeAfterFlushingMessageQueue
(
)
;
dump
(
Hit
-
testing
point
(
{
point
.
x
}
{
point
.
y
}
)
in
fission
context
\
n
)
;
SpecialPowers
.
wrap
(
window
)
.
synthesizeMouseEvent
(
"
MozMouseHittest
"
point
.
x
point
.
y
{
}
{
ignoreRootScrollFrame
:
true
}
)
;
await
hittestPromise
;
let
newParentTestData
=
utils
.
getCompositorAPZTestData
(
)
;
let
newIframeTestData
=
await
getIframeCompositorTestData
(
iframeElement
)
;
let
hitResultCount
=
testData
=
>
{
return
Object
.
keys
(
testData
.
hitResults
)
.
length
;
}
;
let
hitIframe
=
hitResultCount
(
newIframeTestData
)
>
hitResultCount
(
oldIframeTestData
)
;
let
hitParent
=
hitResultCount
(
newParentTestData
)
>
hitResultCount
(
oldParentTestData
)
;
let
lastHitResult
=
testData
=
>
{
let
lastHit
=
testData
.
hitResults
[
Object
.
keys
(
testData
.
hitResults
)
.
length
-
1
]
;
return
{
hitInfo
:
lastHit
.
hitResult
scrollId
:
lastHit
.
scrollId
layersId
:
lastHit
.
layersId
}
;
}
;
if
(
hitIframe
&
&
hitParent
)
{
throw
new
Error
(
"
Both
iframe
and
parent
got
hit
-
results
that
is
unexpected
!
"
)
;
}
else
if
(
hitIframe
)
{
return
lastHitResult
(
newIframeTestData
)
;
}
else
if
(
hitParent
)
{
return
lastHitResult
(
newParentTestData
)
;
}
else
{
throw
new
Error
(
"
Neither
iframe
nor
parent
got
the
hit
-
result
that
is
unexpected
!
"
)
;
}
}
