#
include
"
APZCBasicTester
.
h
"
#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderScrollDataWrapper
.
h
"
#
include
"
InputUtils
.
h
"
class
APZCOverscrollTester
:
public
APZCBasicTester
{
public
:
explicit
APZCOverscrollTester
(
AsyncPanZoomController
:
:
GestureBehavior
aGestureBehavior
=
AsyncPanZoomController
:
:
DEFAULT_GESTURES
)
:
APZCBasicTester
(
aGestureBehavior
)
{
}
protected
:
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
void
TestOverscroll
(
)
{
PanIntoOverscroll
(
)
;
ParentLayerPoint
expectedScrollOffset
(
0
GetScrollRange
(
)
.
YMost
(
)
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
void
PanIntoOverscroll
(
)
{
int
touchStart
=
500
;
int
touchEnd
=
10
;
Pan
(
apzc
touchStart
touchEnd
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
}
void
SampleAnimationUntilRecoveredFromOverscroll
(
const
ParentLayerPoint
&
aExpectedScrollOffset
)
{
const
TimeDuration
increment
=
TimeDuration
:
:
FromMilliseconds
(
1
)
;
bool
recoveredFromOverscroll
=
false
;
ParentLayerPoint
pointOut
;
AsyncTransform
viewTransformOut
;
while
(
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
)
{
EXPECT_EQ
(
aExpectedScrollOffset
pointOut
)
;
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
if
(
!
apzc
-
>
IsOverscrolled
(
)
)
{
recoveredFromOverscroll
=
true
;
}
mcc
-
>
AdvanceBy
(
increment
)
;
}
EXPECT_TRUE
(
recoveredFromOverscroll
)
;
apzc
-
>
AssertStateIsReset
(
)
;
}
ScrollableLayerGuid
CreateSimpleRootScrollableForWebRender
(
)
{
ScrollableLayerGuid
guid
;
if
(
!
gfx
:
:
gfxVars
:
:
UseWebRender
(
)
)
{
return
guid
;
}
guid
.
mScrollId
=
ScrollableLayerGuid
:
:
START_SCROLL_ID
;
guid
.
mLayersId
=
LayersId
{
0
}
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetScrollId
(
guid
.
mScrollId
)
;
metadata
.
SetIsLayersIdRoot
(
true
)
;
WebRenderLayerScrollData
rootLayerScrollData
;
rootLayerScrollData
.
InitializeRoot
(
0
)
;
WebRenderScrollData
scrollData
;
rootLayerScrollData
.
AppendScrollMetadata
(
scrollData
metadata
)
;
scrollData
.
AddLayerData
(
std
:
:
move
(
rootLayerScrollData
)
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
guid
.
mLayersId
mcc
)
;
tm
-
>
UpdateHitTestingTree
(
WebRenderScrollDataWrapper
(
*
updater
&
scrollData
)
false
guid
.
mLayersId
0
)
;
return
guid
;
}
}
;
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
FlingIntoOverscroll
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
Pan
(
apzc
50
25
PanOptions
:
:
NoFling
)
;
Pan
(
apzc
25
45
)
;
const
TimeDuration
increment
=
TimeDuration
:
:
FromMilliseconds
(
1
)
;
bool
reachedOverscroll
=
false
;
bool
recoveredFromOverscroll
=
false
;
while
(
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
)
{
if
(
!
reachedOverscroll
&
&
apzc
-
>
IsOverscrolled
(
)
)
{
reachedOverscroll
=
true
;
}
if
(
reachedOverscroll
&
&
!
apzc
-
>
IsOverscrolled
(
)
)
{
recoveredFromOverscroll
=
true
;
}
mcc
-
>
AdvanceBy
(
increment
)
;
}
EXPECT_TRUE
(
reachedOverscroll
)
;
EXPECT_TRUE
(
recoveredFromOverscroll
)
;
}
#
endif
TEST_F
(
APZCOverscrollTester
PanningTransformNotifications
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
MockFunction
<
void
(
std
:
:
string
checkPointName
)
>
check
;
{
InSequence
s
;
EXPECT_CALL
(
check
Call
(
"
Simple
pan
"
)
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eStartTouch
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eTransformBegin
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eStartPanning
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eEndTouch
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eTransformEnd
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Complex
pan
"
)
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eStartTouch
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eTransformBegin
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eStartPanning
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eEndTouch
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
*
mcc
NotifyAPZStateChange
(
_
GeckoContentController
:
:
APZStateChange
:
:
eTransformEnd
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Done
"
)
)
;
}
check
.
Call
(
"
Simple
pan
"
)
;
Pan
(
apzc
50
25
PanOptions
:
:
NoFling
)
;
check
.
Call
(
"
Complex
pan
"
)
;
Pan
(
apzc
25
45
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
check
.
Call
(
"
Done
"
)
;
}
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverScrollPanning
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
TestOverscroll
(
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverScroll_Bug1152051a
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_friction
"
0
)
;
TestOverscroll
(
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverScroll_Bug1152051b
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
overscroll
.
stop_distance_threshold
"
0
.
1f
)
;
PanIntoOverscroll
(
)
;
SampleAnimationOnce
(
)
;
SampleAnimationOnce
(
)
;
APZEventResult
result
=
TouchDown
(
apzc
ScreenIntPoint
(
10
10
)
mcc
-
>
Time
(
)
)
;
if
(
result
.
GetStatus
(
)
!
=
nsEventStatus_eConsumeNoDefault
)
{
SetDefaultAllowedTouchBehavior
(
apzc
result
.
mInputBlockId
)
;
}
TouchUp
(
apzc
ScreenIntPoint
(
10
10
)
mcc
-
>
Time
(
)
)
;
ParentLayerPoint
expectedScrollOffset
(
0
GetScrollRange
(
)
.
YMost
(
)
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverScrollAfterLowVelocityPan_Bug1343775
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
Pan
(
apzc
10
30
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_FALSE
(
apzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverScrollAbort
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
int
touchStart
=
500
;
int
touchEnd
=
10
;
Pan
(
apzc
touchStart
touchEnd
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
ParentLayerPoint
pointOut
;
AsyncTransform
viewTransformOut
;
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
TimeDuration
:
:
FromMilliseconds
(
10000
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
apzc
-
>
CancelAnimation
(
)
;
EXPECT_FALSE
(
apzc
-
>
IsOverscrolled
(
)
)
;
apzc
-
>
AssertStateIsReset
(
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverScrollPanningAbort
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
int
touchStart
=
500
;
int
touchEnd
=
10
;
Pan
(
apzc
touchStart
touchEnd
PanOptions
:
:
KeepFingerDown
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
apzc
-
>
CancelAnimation
(
)
;
EXPECT_FALSE
(
apzc
-
>
IsOverscrolled
(
)
)
;
apzc
-
>
AssertStateIsReset
(
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverscrollByVerticalPanGestures
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
ParentLayerPoint
expectedScrollOffset
(
0
0
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverscrollByVerticalAndHorizontalPanGestures
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
10
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
ParentLayerPoint
expectedScrollOffset
(
0
0
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverscrollByPanMomentumGestures
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
!
apzc
-
>
IsOverscrolled
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
200
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
100
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
ParentLayerPoint
expectedScrollOffset
(
0
GetScrollRange
(
)
.
YMost
(
)
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
IgnoreMomemtumDuringOverscroll
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
float
yMost
=
GetScrollRange
(
)
.
YMost
(
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
yMost
/
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
yMost
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
yMost
/
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
AsyncTransformComponentMatrix
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_EQ
(
overscrolledTransform
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
200
)
mcc
-
>
Time
(
)
)
;
EXPECT_EQ
(
overscrolledTransform
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_EQ
(
overscrolledTransform
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
EXPECT_EQ
(
overscrolledTransform
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_EQ
(
overscrolledTransform
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
)
;
ParentLayerPoint
expectedScrollOffset
(
0
GetScrollRange
(
)
.
YMost
(
)
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
VerticalOnlyOverscroll
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
10
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
AsyncTransformComponentMatrix
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
10
-
100
)
mcc
-
>
Time
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
5
-
50
)
mcc
-
>
Time
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
ParentLayerPoint
expectedScrollOffset
(
0
0
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
VerticalOnlyOverscrollByPanMomentum
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
50
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
!
apzc
-
>
IsOverscrolled
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
10
-
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
AsyncTransformComponentMatrix
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
5
-
50
)
mcc
-
>
Time
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
overscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_41
=
=
0
)
;
EXPECT_TRUE
(
overscrolledTransform
.
_42
!
=
0
)
;
ParentLayerPoint
expectedScrollOffset
(
0
0
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
DisallowOverscrollInSingleLineTextControl
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
10
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
1000
10
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
metadata
.
SetDisregardedDirection
(
Some
(
ScrollDirection
:
:
eVertical
)
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata
false
true
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
-
2
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
-
10
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
-
2
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
!
apzc
-
>
IsOverscrolled
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
-
100
-
100
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
-
50
-
50
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
-
2
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
5
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
!
apzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
HorizontalOverscrollAnimationWithVerticalPanMomentumScrolling
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
1000
5000
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
10
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
AsyncTransformComponentMatrix
initialOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
AsyncTransformComponentMatrix
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_NE
(
initialOverscrolledTransform
.
_41
currentOverscrolledTransform
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
0
)
;
ParentLayerPoint
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_EQ
(
scrollOffset
.
y
0
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
ParentLayerPoint
offsetAfterPan
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_EQ
(
scrollOffset
.
y
offsetAfterPan
.
y
)
;
EXPECT_EQ
(
scrollOffset
.
x
0
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
200
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_GT
(
scrollOffset
.
y
0
)
;
EXPECT_EQ
(
scrollOffset
.
x
0
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
scrollOffset
.
y
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_GT
(
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
scrollOffset
.
y
)
;
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
10
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_GT
(
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
scrollOffset
.
y
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
scrollOffset
.
y
)
;
ParentLayerPoint
expectedScrollOffset
(
0
scrollOffset
.
y
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
BothAxesOverscrollAnimationWithPanMomentumScrolling
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
1000
5000
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
10
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
AsyncTransformComponentMatrix
initialOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
AsyncTransformComponentMatrix
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_NE
(
initialOverscrolledTransform
.
_41
currentOverscrolledTransform
.
_41
)
;
EXPECT_NE
(
initialOverscrolledTransform
.
_42
currentOverscrolledTransform
.
_42
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
200
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
EXPECT_EQ
(
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
0
)
;
ParentLayerPoint
currentScrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_GT
(
currentScrollOffset
.
y
0
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
EXPECT_EQ
(
currentScrollOffset
.
y
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
currentScrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
0
)
;
EXPECT_GT
(
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
currentScrollOffset
.
y
)
;
currentScrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
10
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
0
)
;
EXPECT_GT
(
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
currentScrollOffset
.
y
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
currentScrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
0
)
;
EXPECT_EQ
(
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
y
currentScrollOffset
.
y
)
;
ParentLayerPoint
expectedScrollOffset
(
0
currentScrollOffset
.
y
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
VerticalOverscrollAnimationInAdditionToExistingHorizontalOverscrollAnimation
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
1000
5000
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
50
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
10
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
-
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
AsyncTransformComponentMatrix
initialOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
AsyncTransformComponentMatrix
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_NE
(
initialOverscrolledTransform
.
_41
currentOverscrolledTransform
.
_41
)
;
EXPECT_EQ
(
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
0
)
;
ParentLayerPoint
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_EQ
(
scrollOffset
.
y
50
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
ParentLayerPoint
offsetAfterPan
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_EQ
(
scrollOffset
.
y
offsetAfterPan
.
y
)
;
EXPECT_EQ
(
scrollOffset
.
x
0
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
200
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_EQ
(
scrollOffset
.
y
0
)
;
EXPECT_EQ
(
scrollOffset
.
x
0
)
;
EXPECT_GT
(
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
0
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_NE
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_41
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_41
)
;
EXPECT_EQ
(
currentOverscrolledTransform
.
_42
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
.
_42
)
;
currentOverscrolledTransform
=
apzc
-
>
GetOverscrollTransform
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
apzc
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
ParentLayerPoint
expectedScrollOffset
(
0
0
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
OverscrollByPanGesturesInterruptedByReflowZoom
)
{
if
(
!
gfx
:
:
gfxVars
:
:
UseWebRender
(
)
)
{
return
;
}
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
SCOPED_GFX_PREF_INT
(
"
mousewheel
.
with_control
.
action
"
3
)
;
PanGestureInput
panInput
(
PanGestureInput
:
:
PANGESTURE_START
MillisecondsSinceStartup
(
mcc
-
>
Time
(
)
)
mcc
-
>
Time
(
)
ScreenIntPoint
(
5
5
)
ScreenPoint
(
0
-
2
)
MODIFIER_CONTROL
)
;
WidgetWheelEvent
wheelEvent
=
panInput
.
ToWidgetEvent
(
nullptr
)
;
EXPECT_FALSE
(
APZInputBridge
:
:
ActionForWheelEvent
(
&
wheelEvent
)
.
isSome
(
)
)
;
ScrollableLayerGuid
rootGuid
=
CreateSimpleRootScrollableForWebRender
(
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
tm
-
>
GetTargetAPZC
(
rootGuid
.
mLayersId
rootGuid
.
mScrollId
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
tm
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
tm
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
PanGestureWithModifiers
(
PanGestureInput
:
:
PANGESTURE_PAN
MODIFIER_CONTROL
tm
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
PanGestureWithModifiers
(
PanGestureInput
:
:
PANGESTURE_END
MODIFIER_CONTROL
tm
ScreenIntPoint
(
50
80
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
!
apzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
SmoothTransitionFromPanToAnimation
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
500
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
int
frameLength
=
10
;
float
panVelocity
=
10
;
int
panPixelsPerFrame
=
frameLength
*
panVelocity
;
ScreenIntPoint
panPoint
(
50
50
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
panPoint
ScreenPoint
(
0
-
1
)
mcc
-
>
Time
(
)
)
;
for
(
int
i
=
0
;
i
<
6
;
+
+
i
)
{
mcc
-
>
AdvanceByMillis
(
frameLength
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
0
-
panPixelsPerFrame
)
mcc
-
>
Time
(
)
)
;
}
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
int
frames
=
StaticPrefs
:
:
apz_velocity_relevance_time_ms
(
)
/
frameLength
;
for
(
int
i
=
0
;
i
<
frames
;
+
+
i
)
{
mcc
-
>
AdvanceByMillis
(
frameLength
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
0
-
panPixelsPerFrame
)
mcc
-
>
Time
(
)
)
;
}
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
mcc
-
>
AdvanceByMillis
(
frameLength
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_LT
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
y
-
0
.
8
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
NoOverscrollForMousewheel
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
3
)
)
;
metadata
.
SetPageScrollAmount
(
LayoutDeviceIntSize
(
50
100
)
)
;
metadata
.
SetLineScrollAmount
(
LayoutDeviceIntSize
(
5
10
)
)
;
apzc
-
>
SetScrollMetadata
(
metadata
)
;
Wheel
(
apzc
ScreenIntPoint
(
10
10
)
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
EXPECT_FALSE
(
apzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
ClickWhileOverscrolled
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
0
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
ScreenIntPoint
panPoint
(
50
50
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
panPoint
ScreenPoint
(
0
-
1
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
0
-
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
GetOverscrollAmount
(
)
.
y
<
0
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
GetOverscrollAmount
(
)
.
y
<
0
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
ParentLayerPoint
overscrollBefore
=
apzc
-
>
GetOverscrollAmount
(
)
;
MouseDown
(
apzc
panPoint
mcc
-
>
Time
(
)
)
;
EXPECT_FALSE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_EQ
(
overscrollBefore
apzc
-
>
GetOverscrollAmount
(
)
)
;
MouseUp
(
apzc
panPoint
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
ParentLayerPoint
(
0
0
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
DynamicallyLoadingContent
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
0
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
ScreenIntPoint
panPoint
(
50
50
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
panPoint
ScreenPoint
(
0
1
)
mcc
-
>
Time
(
)
)
;
for
(
int
i
=
0
;
i
<
12
;
+
+
i
)
{
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
0
100
)
mcc
-
>
Time
(
)
)
;
}
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
GetOverscrollAmount
(
)
.
y
>
0
)
;
CSSRect
scrollableRect
=
metrics
.
GetScrollableRect
(
)
;
scrollableRect
.
height
+
=
500
;
metrics
.
SetScrollableRect
(
scrollableRect
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata
false
true
)
;
EXPECT_FALSE
(
apzc
-
>
IsOverscrolled
(
)
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
panPoint
ScreenPoint
(
0
-
1
)
mcc
-
>
Time
(
)
)
;
for
(
int
i
=
0
;
i
<
12
;
+
+
i
)
{
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
0
-
100
)
mcc
-
>
Time
(
)
)
;
}
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
ParentLayerPoint
overscrollAmount
=
apzc
-
>
GetOverscrollAmount
(
)
;
EXPECT_TRUE
(
overscrollAmount
.
y
<
0
)
;
scrollableRect
=
metrics
.
GetScrollableRect
(
)
;
scrollableRect
.
height
+
=
500
;
metrics
.
SetScrollableRect
(
scrollableRect
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata
false
true
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_EQ
(
overscrollAmount
apzc
-
>
GetOverscrollAmount
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTester
SmallAmountOfOverscroll
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
ScreenIntPoint
panPoint
(
50
50
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
panPoint
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
panPoint
ScreenPoint
(
-
0
.
1
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
-
0
.
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
EXPECT_TRUE
(
apzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
apzc
-
>
GetOverscrollAmount
(
)
.
y
<
0
)
;
EXPECT_TRUE
(
apzc
-
>
GetOverscrollAmount
(
)
.
x
<
0
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
apzc
panPoint
ScreenPoint
(
0
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
panPoint
ScreenPoint
(
0
100
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
apzc
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
ParentLayerPoint
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForHitTesting
)
;
EXPECT_GT
(
scrollOffset
.
y
0
)
;
ParentLayerPoint
expectedScrollOffset
(
0
scrollOffset
.
y
)
;
SampleAnimationUntilRecoveredFromOverscroll
(
expectedScrollOffset
)
;
}
#
endif
class
APZCOverscrollTesterMock
:
public
APZCTreeManagerTester
{
public
:
APZCOverscrollTesterMock
(
)
{
CreateMockHitTester
(
)
;
}
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
TestAsyncPanZoomController
*
rootApzc
;
}
;
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTesterMock
OverscrollHandoff
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRegion
layerVisibleRegion
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
100
50
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
50
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetIsRootContent
(
true
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
20
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTesterMock
VerticalOverscrollHandoffToScrollableRoot
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRegion
layerVisibleRegion
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
100
50
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
200
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetIsRootContent
(
true
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
20
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
ApzcOf
(
layers
[
1
]
)
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTesterMock
NoOverscrollHandoffToNonScrollableRoot
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRegion
layerVisibleRegion
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
100
50
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
200
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetIsRootContent
(
true
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
20
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
ApzcOf
(
layers
[
1
]
)
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTesterMock
NoOverscrollHandoffOrthogonalPanGesture
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRegion
layerVisibleRegion
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
100
50
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
200
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetIsRootContent
(
true
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
20
)
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
ApzcOf
(
layers
[
1
]
)
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTesterMock
RetriggerCancelledOverscrollAnimationByNewPanGesture
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRegion
layerVisibleRegion
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
100
50
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
200
50
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetIsRootContent
(
true
)
;
ScreenIntPoint
panPoint
(
50
20
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
panPoint
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
manager
panPoint
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
ApzcOf
(
layers
[
1
]
)
-
>
IsOverscrolled
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
panPoint
ScreenPoint
(
-
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
manager
panPoint
ScreenPoint
(
-
10
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
ApzcOf
(
layers
[
1
]
)
-
>
IsOverscrolled
(
)
)
;
while
(
SampleAnimationsOnce
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
ApzcOf
(
layers
[
1
]
)
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTesterMock
RetriggeredOverscrollAnimationVelocity
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRegion
layerVisibleRegion
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
100
50
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
200
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetIsRootContent
(
true
)
;
ScreenIntPoint
panPoint
(
50
20
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
panPoint
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
manager
panPoint
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
panPoint
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
ApzcOf
(
layers
[
1
]
)
-
>
IsOverscrolled
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_LT
(
rootApzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
panPoint
ScreenPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
EXPECT_TRUE
(
!
rootApzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
manager
panPoint
ScreenPoint
(
0
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
EXPECT_TRUE
(
!
rootApzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
panPoint
ScreenPoint
(
0
10
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrollAnimationRunning
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
while
(
SampleAnimationsOnce
(
)
)
{
EXPECT_LE
(
rootApzc
-
>
GetOverscrollAmount
(
)
.
y
0
)
;
}
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCOverscrollTesterMock
OverscrollIntoPreventDefault
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
const
char
*
treeShape
=
"
x
"
;
LayerIntRegion
layerVisibleRegions
[
]
=
{
LayerIntRect
(
0
0
100
100
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegions
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
200
)
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
ScreenIntPoint
cursorLocation
(
10
25
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
APZEventResult
result
=
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
cursorLocation
ScreenPoint
(
0
-
2
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
manager
cursorLocation
ScreenPoint
(
0
-
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
float
overscrollY
=
rootApzc
-
>
GetOverscrollAmount
(
)
.
y
;
manager
-
>
SetAllowedTouchBehavior
(
result
.
mInputBlockId
{
AllowedTouchBehavior
:
:
VERTICAL_PAN
}
)
;
manager
-
>
SetTargetAPZC
(
result
.
mInputBlockId
{
result
.
mTargetGuid
}
)
;
manager
-
>
ContentReceivedInputBlock
(
result
.
mInputBlockId
true
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_EQ
(
overscrollY
rootApzc
-
>
GetOverscrollAmount
(
)
.
y
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
{
CompositorHitTestFlags
:
:
eVisibleToHitTest
CompositorHitTestFlags
:
:
eIrregularArea
}
)
;
result
=
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
manager
cursorLocation
ScreenPoint
(
0
-
10
)
mcc
-
>
Time
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_EQ
(
overscrollY
rootApzc
-
>
GetOverscrollAmount
(
)
.
y
)
;
manager
-
>
SetAllowedTouchBehavior
(
result
.
mInputBlockId
{
AllowedTouchBehavior
:
:
VERTICAL_PAN
}
)
;
manager
-
>
SetTargetAPZC
(
result
.
mInputBlockId
{
result
.
mTargetGuid
}
)
;
manager
-
>
ContentReceivedInputBlock
(
result
.
mInputBlockId
true
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
rootApzc
-
>
AssertStateIsReset
(
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
result
=
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
manager
cursorLocation
ScreenPoint
(
0
-
100
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
result
=
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
manager
cursorLocation
ScreenPoint
(
0
-
100
)
mcc
-
>
Time
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_EQ
(
rootApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
CSSPoint
(
0
0
)
)
;
}
#
endif
