#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
#
include
"
mozilla
/
layers
/
ScrollableLayerGuid
.
h
"
TEST_F
(
APZCTreeManagerTester
WheelInterruptedByMouseDrag
)
{
SCOPED_GFX_PREF_BOOL
(
"
general
.
smoothScroll
"
true
)
;
CreateSimpleScrollingLayer
(
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
apzc
=
ApzcOf
(
root
)
;
uint64_t
dragBlockId
=
MouseDown
(
apzc
ScreenIntPoint
(
5
5
)
mcc
-
>
Time
(
)
)
.
mInputBlockId
;
uint64_t
tmpBlockId
=
MouseMove
(
apzc
ScreenIntPoint
(
6
6
)
mcc
-
>
Time
(
)
)
.
mInputBlockId
;
EXPECT_EQ
(
dragBlockId
tmpBlockId
)
;
uint64_t
wheelBlockId
=
SmoothWheel
(
apzc
ScreenIntPoint
(
6
6
)
ScreenPoint
(
0
1
)
mcc
-
>
Time
(
)
)
.
mInputBlockId
;
EXPECT_NE
(
dragBlockId
wheelBlockId
)
;
tmpBlockId
=
MouseMove
(
apzc
ScreenIntPoint
(
7
5
)
mcc
-
>
Time
(
)
)
.
mInputBlockId
;
EXPECT_EQ
(
dragBlockId
tmpBlockId
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
ParentLayerPoint
scroll
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForEventHandling
)
;
EXPECT_EQ
(
scroll
.
x
0
)
;
EXPECT_EQ
(
scroll
.
y
10
)
;
}
TEST_F
(
APZCTreeManagerTester
HorizontalDeltaInterferesWithVerticalScrolling
)
{
using
ViewID
=
ScrollableLayerGuid
:
:
ViewID
;
ViewID
rootScrollId
=
ScrollableLayerGuid
:
:
START_SCROLL_ID
;
const
char
*
treeShape
=
"
x
"
;
LayerIntRect
layerVisibleRect
[
]
=
{
LayerIntRect
(
0
0
100
100
)
}
;
CreateScrollData
(
treeShape
layerVisibleRect
)
;
SetScrollableFrameMetrics
(
layers
[
0
]
rootScrollId
CSSRect
(
0
0
100
1000
)
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
apzc
=
ApzcOf
(
root
)
;
apzc
-
>
SetWaitForMainThread
(
)
;
ScreenIntPoint
cursorLocation
(
50
50
)
;
uint64_t
wheelBlockId1
=
Wheel
(
apzc
cursorLocation
ScreenIntPoint
(
-
10
0
)
mcc
-
>
Time
(
)
)
.
mInputBlockId
;
uint64_t
wheelBlockId2
=
Wheel
(
apzc
cursorLocation
ScreenIntPoint
(
0
10
)
mcc
-
>
Time
(
)
)
.
mInputBlockId
;
EXPECT_EQ
(
wheelBlockId1
wheelBlockId2
)
;
manager
-
>
ContentReceivedInputBlock
(
wheelBlockId1
false
)
;
manager
-
>
SetTargetAPZC
(
wheelBlockId1
{
apzc
-
>
GetGuid
(
)
}
)
;
EXPECT_EQ
(
ParentLayerPoint
(
0
10
)
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForEventHandling
)
)
;
}
