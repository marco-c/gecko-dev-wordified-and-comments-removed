#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
class
APZEventRegionsTester
:
public
APZCTreeManagerTester
{
protected
:
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
TestAsyncPanZoomController
*
rootApzc
;
void
CreateEventRegionsLayerTree1
(
)
{
const
char
*
treeShape
=
"
x
(
xx
)
"
;
LayerIntRegion
layerVisibleRegions
[
]
=
{
LayerIntRect
(
0
0
200
200
)
LayerIntRect
(
0
0
100
200
)
LayerIntRect
(
0
100
200
100
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegions
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
2
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
SetScrollHandoff
(
layers
[
2
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateEventRegionsLayerTree2
(
)
{
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRegion
layerVisibleRegions
[
]
=
{
LayerIntRect
(
0
0
100
500
)
LayerIntRect
(
0
150
100
100
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegions
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateBug1117712LayerTree
(
)
{
const
char
*
treeShape
=
"
x
(
x
(
x
)
x
)
"
;
LayerIntRegion
layerVisibleRegions
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
0
0
)
LayerIntRect
(
0
0
10
10
)
LayerIntRect
(
0
0
100
100
)
}
;
Matrix4x4
layerTransforms
[
]
=
{
Matrix4x4
(
)
Matrix4x4
:
:
Translation
(
50
0
0
)
Matrix4x4
(
)
Matrix4x4
(
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegions
layerTransforms
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
10
10
)
)
;
SetScrollableFrameMetrics
(
layers
[
3
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
100
)
)
;
SetScrollHandoff
(
layers
[
3
]
layers
[
2
]
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
}
}
;
class
APZEventRegionsTesterMock
:
public
APZEventRegionsTester
{
public
:
APZEventRegionsTesterMock
(
)
{
CreateMockHitTester
(
)
;
}
}
;
TEST_F
(
APZEventRegionsTesterMock
HitRegionImmediateResponse
)
{
CreateEventRegionsLayerTree1
(
)
;
TestAsyncPanZoomController
*
root
=
ApzcOf
(
layers
[
0
]
)
;
TestAsyncPanZoomController
*
left
=
ApzcOf
(
layers
[
1
]
)
;
TestAsyncPanZoomController
*
bottom
=
ApzcOf
(
layers
[
2
]
)
;
MockFunction
<
void
(
std
:
:
string
checkPointName
)
>
check
;
{
InSequence
s
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eSingleTap
_
_
left
-
>
GetGuid
(
)
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
left
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eSingleTap
_
_
bottom
-
>
GetGuid
(
)
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
bottom
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eSingleTap
_
_
root
-
>
GetGuid
(
)
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
root
"
)
)
;
EXPECT_CALL
(
check
Call
(
"
Tap
pending
on
d
-
t
-
c
region
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eSingleTap
_
_
bottom
-
>
GetGuid
(
)
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
bottom
again
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eSingleTap
_
_
left
-
>
GetGuid
(
)
_
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
left
this
time
"
)
)
;
}
TimeDuration
tapDuration
=
TimeDuration
:
:
FromMilliseconds
(
100
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
Tap
(
manager
ScreenIntPoint
(
10
10
)
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
left
"
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
2
)
;
Tap
(
manager
ScreenIntPoint
(
110
110
)
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
bottom
"
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
Tap
(
manager
ScreenIntPoint
(
110
10
)
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
root
"
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
2
{
CompositorHitTestFlags
:
:
eVisibleToHitTest
CompositorHitTestFlags
:
:
eIrregularArea
}
)
;
Tap
(
manager
ScreenIntPoint
(
10
110
)
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tap
pending
on
d
-
t
-
c
region
"
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
bottom
again
"
)
;
uint64_t
inputBlockId
=
0
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
2
{
CompositorHitTestFlags
:
:
eVisibleToHitTest
CompositorHitTestFlags
:
:
eIrregularArea
}
)
;
Tap
(
manager
ScreenIntPoint
(
10
110
)
tapDuration
nullptr
&
inputBlockId
)
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
targets
.
AppendElement
(
left
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
inputBlockId
targets
)
;
while
(
mcc
-
>
RunThroughDelayedTasks
(
)
)
;
check
.
Call
(
"
Tapped
on
left
this
time
"
)
;
}
TEST_F
(
APZEventRegionsTesterMock
HitRegionAccumulatesChildren
)
{
CreateEventRegionsLayerTree2
(
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eSingleTap
_
_
rootApzc
-
>
GetGuid
(
)
_
)
)
.
Times
(
1
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
Tap
(
manager
ScreenIntPoint
(
10
160
)
TimeDuration
:
:
FromMilliseconds
(
100
)
)
;
}
TEST_F
(
APZEventRegionsTesterMock
Bug1117712
)
{
CreateBug1117712LayerTree
(
)
;
TestAsyncPanZoomController
*
apzc2
=
ApzcOf
(
layers
[
2
]
)
;
uint64_t
inputBlockId
=
0
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
{
CompositorHitTestFlags
:
:
eVisibleToHitTest
CompositorHitTestFlags
:
:
eIrregularArea
}
)
;
Tap
(
manager
ScreenIntPoint
(
55
5
)
TimeDuration
:
:
FromMilliseconds
(
100
)
nullptr
&
inputBlockId
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eSingleTap
LayoutDevicePoint
(
55
5
)
0
apzc2
-
>
GetGuid
(
)
_
)
)
.
Times
(
1
)
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
targets
.
AppendElement
(
apzc2
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
inputBlockId
targets
)
;
}
