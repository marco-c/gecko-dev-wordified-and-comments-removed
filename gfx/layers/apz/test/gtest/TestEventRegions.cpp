#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
class
APZEventRegionsTester
:
public
APZCTreeManagerTester
{
protected
:
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
TestAsyncPanZoomController
*
rootApzc
;
void
CreateEventRegionsLayerTree1
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
tt
)
"
;
nsIntRegion
layerVisibleRegions
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
nsIntRegion
(
IntRect
(
0
0
100
200
)
)
nsIntRegion
(
IntRect
(
0
100
200
100
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegions
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
FrameMetrics
:
:
START_SCROLL_ID
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
FrameMetrics
:
:
START_SCROLL_ID
+
2
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
SetScrollHandoff
(
layers
[
2
]
root
)
;
EventRegions
regions
(
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
)
;
root
-
>
SetEventRegions
(
regions
)
;
regions
.
mDispatchToContentHitRegion
=
nsIntRegion
(
IntRect
(
0
100
100
100
)
)
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
0
100
200
)
)
;
layers
[
1
]
-
>
SetEventRegions
(
regions
)
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
100
200
100
)
)
;
layers
[
2
]
-
>
SetEventRegions
(
regions
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateEventRegionsLayerTree2
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
t
)
"
;
nsIntRegion
layerVisibleRegions
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
500
)
)
nsIntRegion
(
IntRect
(
0
150
100
100
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegions
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
FrameMetrics
:
:
START_SCROLL_ID
)
;
EventRegions
regions
(
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
)
;
root
-
>
SetEventRegions
(
regions
)
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
150
100
100
)
)
;
layers
[
1
]
-
>
SetEventRegions
(
regions
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateObscuringLayerTree
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
c
(
t
)
t
)
"
;
nsIntRegion
layerVisibleRegions
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
nsIntRegion
(
IntRect
(
0
100
200
50
)
)
nsIntRegion
(
IntRect
(
0
100
200
100
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegions
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
FrameMetrics
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
200
300
)
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
FrameMetrics
:
:
START_SCROLL_ID
+
2
CSSRect
(
0
0
200
100
)
)
;
SetScrollHandoff
(
layers
[
2
]
layers
[
1
]
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
EventRegions
regions
(
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
)
;
root
-
>
SetEventRegions
(
regions
)
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
0
200
300
)
)
;
layers
[
1
]
-
>
SetEventRegions
(
regions
)
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
100
200
100
)
)
;
layers
[
2
]
-
>
SetEventRegions
(
regions
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateBug1119497LayerTree
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
tt
)
"
;
nsIntRegion
layerVisibleRegions
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegions
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
FrameMetrics
:
:
START_SCROLL_ID
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
}
void
CreateBug1117712LayerTree
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
c
(
t
)
t
)
"
;
nsIntRegion
layerVisibleRegions
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
0
0
)
)
nsIntRegion
(
IntRect
(
0
0
10
10
)
)
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
}
;
Matrix4x4
layerTransforms
[
]
=
{
Matrix4x4
(
)
Matrix4x4
:
:
Translation
(
50
0
0
)
Matrix4x4
(
)
Matrix4x4
(
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegions
layerTransforms
lm
layers
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
10
10
)
)
;
SetScrollableFrameMetrics
(
layers
[
3
]
FrameMetrics
:
:
START_SCROLL_ID
+
2
CSSRect
(
0
0
100
100
)
)
;
EventRegions
regions
(
nsIntRegion
(
IntRect
(
0
0
10
10
)
)
)
;
layers
[
2
]
-
>
SetEventRegions
(
regions
)
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
;
regions
.
mDispatchToContentHitRegion
=
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
;
layers
[
3
]
-
>
SetEventRegions
(
regions
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
}
}
;
TEST_F
(
APZEventRegionsTester
HitRegionImmediateResponse
)
{
CreateEventRegionsLayerTree1
(
)
;
TestAsyncPanZoomController
*
root
=
ApzcOf
(
layers
[
0
]
)
;
TestAsyncPanZoomController
*
left
=
ApzcOf
(
layers
[
1
]
)
;
TestAsyncPanZoomController
*
bottom
=
ApzcOf
(
layers
[
2
]
)
;
MockFunction
<
void
(
std
:
:
string
checkPointName
)
>
check
;
{
InSequence
s
;
EXPECT_CALL
(
*
mcc
HandleSingleTap
(
_
_
left
-
>
GetGuid
(
)
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
left
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleSingleTap
(
_
_
bottom
-
>
GetGuid
(
)
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
bottom
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleSingleTap
(
_
_
root
-
>
GetGuid
(
)
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
root
"
)
)
;
EXPECT_CALL
(
check
Call
(
"
Tap
pending
on
d
-
t
-
c
region
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleSingleTap
(
_
_
bottom
-
>
GetGuid
(
)
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
bottom
again
"
)
)
;
EXPECT_CALL
(
*
mcc
HandleSingleTap
(
_
_
left
-
>
GetGuid
(
)
)
)
.
Times
(
1
)
;
EXPECT_CALL
(
check
Call
(
"
Tapped
on
left
this
time
"
)
)
;
}
TimeDuration
tapDuration
=
TimeDuration
:
:
FromMilliseconds
(
100
)
;
Tap
(
manager
ScreenIntPoint
(
10
10
)
mcc
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
left
"
)
;
Tap
(
manager
ScreenIntPoint
(
110
110
)
mcc
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
bottom
"
)
;
Tap
(
manager
ScreenIntPoint
(
110
10
)
mcc
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
root
"
)
;
Tap
(
manager
ScreenIntPoint
(
10
110
)
mcc
tapDuration
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tap
pending
on
d
-
t
-
c
region
"
)
;
mcc
-
>
RunThroughDelayedTasks
(
)
;
check
.
Call
(
"
Tapped
on
bottom
again
"
)
;
uint64_t
inputBlockId
=
0
;
Tap
(
manager
ScreenIntPoint
(
10
110
)
mcc
tapDuration
nullptr
&
inputBlockId
)
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
targets
.
AppendElement
(
left
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
inputBlockId
targets
)
;
while
(
mcc
-
>
RunThroughDelayedTasks
(
)
)
;
check
.
Call
(
"
Tapped
on
left
this
time
"
)
;
}
TEST_F
(
APZEventRegionsTester
HitRegionAccumulatesChildren
)
{
CreateEventRegionsLayerTree2
(
)
;
EXPECT_CALL
(
*
mcc
HandleSingleTap
(
_
_
rootApzc
-
>
GetGuid
(
)
)
)
.
Times
(
1
)
;
Tap
(
manager
ScreenIntPoint
(
10
160
)
mcc
TimeDuration
:
:
FromMilliseconds
(
100
)
)
;
}
TEST_F
(
APZEventRegionsTester
Obscuration
)
{
CreateObscuringLayerTree
(
)
;
ScopedLayerTreeRegistration
registration
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
TestAsyncPanZoomController
*
parent
=
ApzcOf
(
layers
[
1
]
)
;
TestAsyncPanZoomController
*
child
=
ApzcOf
(
layers
[
2
]
)
;
ApzcPanNoFling
(
parent
mcc
75
25
)
;
HitTestResult
result
;
RefPtr
<
AsyncPanZoomController
>
hit
=
manager
-
>
GetTargetAPZC
(
ScreenPoint
(
50
75
)
&
result
)
;
EXPECT_EQ
(
child
hit
.
get
(
)
)
;
EXPECT_EQ
(
HitTestResult
:
:
HitLayer
result
)
;
}
TEST_F
(
APZEventRegionsTester
Bug1119497
)
{
CreateBug1119497LayerTree
(
)
;
HitTestResult
result
;
RefPtr
<
AsyncPanZoomController
>
hit
=
manager
-
>
GetTargetAPZC
(
ScreenPoint
(
50
50
)
&
result
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
0
]
)
hit
.
get
(
)
)
;
EXPECT_EQ
(
HitTestResult
:
:
HitLayer
result
)
;
}
TEST_F
(
APZEventRegionsTester
Bug1117712
)
{
CreateBug1117712LayerTree
(
)
;
TestAsyncPanZoomController
*
apzc2
=
ApzcOf
(
layers
[
2
]
)
;
uint64_t
inputBlockId
=
0
;
Tap
(
manager
ScreenIntPoint
(
55
5
)
mcc
TimeDuration
:
:
FromMilliseconds
(
100
)
nullptr
&
inputBlockId
)
;
EXPECT_CALL
(
*
mcc
HandleSingleTap
(
CSSPoint
(
55
5
)
0
apzc2
-
>
GetGuid
(
)
)
)
.
Times
(
1
)
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
targets
.
AppendElement
(
apzc2
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
inputBlockId
targets
)
;
}
