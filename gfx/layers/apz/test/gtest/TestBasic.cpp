#
include
"
APZCBasicTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
TEST_F
(
APZCBasicTester
Overzoom
)
{
FrameMetrics
fm
;
fm
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
fm
.
SetScrollableRect
(
CSSRect
(
0
0
125
150
)
)
;
fm
.
SetVisualScrollOffset
(
CSSPoint
(
10
0
)
)
;
fm
.
SetZoom
(
CSSToParentLayerScale2D
(
1
.
0
1
.
0
)
)
;
fm
.
SetIsRootContent
(
true
)
;
apzc
-
>
SetFrameMetrics
(
fm
)
;
MakeApzcZoomable
(
)
;
EXPECT_CALL
(
*
mcc
RequestContentRepaint
(
_
)
)
.
Times
(
1
)
;
PinchWithPinchInputAndCheckStatus
(
apzc
ScreenIntPoint
(
50
50
)
0
.
5
true
)
;
fm
=
apzc
-
>
GetFrameMetrics
(
)
;
EXPECT_EQ
(
0
.
8f
fm
.
GetZoom
(
)
.
ToScaleFactor
(
)
.
scale
)
;
EXPECT_LT
(
std
:
:
abs
(
fm
.
GetVisualScrollOffset
(
)
.
x
)
1e
-
5
)
;
EXPECT_LT
(
std
:
:
abs
(
fm
.
GetVisualScrollOffset
(
)
.
y
)
1e
-
5
)
;
}
TEST_F
(
APZCBasicTester
SimpleTransform
)
{
ParentLayerPoint
pointOut
;
AsyncTransform
viewTransformOut
;
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
EXPECT_EQ
(
ParentLayerPoint
(
)
pointOut
)
;
EXPECT_EQ
(
AsyncTransform
(
)
viewTransformOut
)
;
}
TEST_F
(
APZCBasicTester
ComplexTransform
)
{
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
new
TestAsyncPanZoomController
(
LayersId
{
0
}
mcc
tm
)
;
const
char
*
layerTreeSyntax
=
"
c
(
c
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
300
300
)
)
nsIntRegion
(
IntRect
(
0
0
150
300
)
)
}
;
Matrix4x4
transforms
[
]
=
{
Matrix4x4
(
)
Matrix4x4
(
)
}
;
transforms
[
0
]
.
PostScale
(
0
.
5f
0
.
5f
1
.
0f
)
;
transforms
[
1
]
.
PostScale
(
2
.
0f
1
.
0f
1
.
0f
)
;
nsTArray
<
RefPtr
<
Layer
>
>
layers
;
RefPtr
<
LayerManager
>
lm
;
RefPtr
<
Layer
>
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
transforms
lm
layers
)
;
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
24
24
)
)
;
metrics
.
SetDisplayPort
(
CSSRect
(
-
1
-
1
6
6
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
10
10
)
)
;
metrics
.
SetLayoutViewport
(
CSSRect
(
10
10
8
8
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
50
50
)
)
;
metrics
.
SetCumulativeResolution
(
LayoutDeviceToLayerScale2D
(
2
2
)
)
;
metrics
.
SetPresShellResolution
(
2
.
0f
)
;
metrics
.
SetZoom
(
CSSToParentLayerScale2D
(
6
6
)
)
;
metrics
.
SetDevPixelsPerCSSPixel
(
CSSToLayoutDeviceScale
(
3
)
)
;
metrics
.
SetScrollId
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
ScrollMetadata
childMetadata
=
metadata
;
FrameMetrics
&
childMetrics
=
childMetadata
.
GetMetrics
(
)
;
childMetrics
.
SetScrollId
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
layers
[
0
]
-
>
SetScrollMetadata
(
metadata
)
;
layers
[
1
]
-
>
SetScrollMetadata
(
childMetadata
)
;
ParentLayerPoint
pointOut
;
AsyncTransform
viewTransformOut
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata
true
true
)
;
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
EXPECT_EQ
(
AsyncTransform
(
LayerToParentLayerScale
(
1
)
ParentLayerPoint
(
)
)
viewTransformOut
)
;
EXPECT_EQ
(
ParentLayerPoint
(
60
60
)
pointOut
)
;
childApzc
-
>
SetFrameMetrics
(
childMetrics
)
;
childApzc
-
>
NotifyLayersUpdated
(
childMetadata
true
true
)
;
childApzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
EXPECT_EQ
(
AsyncTransform
(
LayerToParentLayerScale
(
1
)
ParentLayerPoint
(
)
)
viewTransformOut
)
;
EXPECT_EQ
(
ParentLayerPoint
(
60
60
)
pointOut
)
;
metrics
.
ScrollBy
(
CSSPoint
(
5
0
)
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
EXPECT_EQ
(
AsyncTransform
(
LayerToParentLayerScale
(
1
)
ParentLayerPoint
(
-
30
0
)
)
viewTransformOut
)
;
EXPECT_EQ
(
ParentLayerPoint
(
90
60
)
pointOut
)
;
childMetrics
.
ScrollBy
(
CSSPoint
(
5
0
)
)
;
childApzc
-
>
SetFrameMetrics
(
childMetrics
)
;
childApzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
EXPECT_EQ
(
AsyncTransform
(
LayerToParentLayerScale
(
1
)
ParentLayerPoint
(
-
30
0
)
)
viewTransformOut
)
;
EXPECT_EQ
(
ParentLayerPoint
(
90
60
)
pointOut
)
;
metrics
.
ZoomBy
(
1
.
5f
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
EXPECT_EQ
(
AsyncTransform
(
LayerToParentLayerScale
(
1
.
5
)
ParentLayerPoint
(
-
45
0
)
)
viewTransformOut
)
;
EXPECT_EQ
(
ParentLayerPoint
(
135
90
)
pointOut
)
;
childMetrics
.
ZoomBy
(
1
.
5f
)
;
childApzc
-
>
SetFrameMetrics
(
childMetrics
)
;
childApzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
EXPECT_EQ
(
AsyncTransform
(
LayerToParentLayerScale
(
1
.
5
)
ParentLayerPoint
(
-
45
0
)
)
viewTransformOut
)
;
EXPECT_EQ
(
ParentLayerPoint
(
135
90
)
pointOut
)
;
childApzc
-
>
Destroy
(
)
;
}
TEST_F
(
APZCBasicTester
Fling
)
{
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
int
touchStart
=
50
;
int
touchEnd
=
10
;
ParentLayerPoint
pointOut
;
AsyncTransform
viewTransformOut
;
Pan
(
apzc
touchStart
touchEnd
)
;
ParentLayerPoint
lastPoint
;
for
(
int
i
=
1
;
i
<
50
;
i
+
=
1
)
{
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
TimeDuration
:
:
FromMilliseconds
(
1
)
)
;
EXPECT_GT
(
pointOut
.
y
lastPoint
.
y
)
;
lastPoint
=
pointOut
;
}
}
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZCBasicTester
ResumeInterruptedTouchDrag_Bug1592435
)
{
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
touch_start_tolerance
"
1
.
0f
/
1000
.
0f
)
;
ScreenIntPoint
touchPos
(
10
50
)
;
uint64_t
touchBlock
=
TouchDown
(
apzc
touchPos
mcc
-
>
Time
(
)
)
.
mInputBlockId
;
SetDefaultAllowedTouchBehavior
(
apzc
touchBlock
)
;
for
(
int
i
=
0
;
i
<
20
;
+
+
i
)
{
touchPos
.
y
-
=
1
;
mcc
-
>
AdvanceByMillis
(
1
)
;
TouchMove
(
apzc
touchPos
mcc
-
>
Time
(
)
)
;
}
CSSPoint
scrollOffsetBeforeInterruption
=
apzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
;
CSSPoint
mainThreadOffset
=
scrollOffsetBeforeInterruption
;
mainThreadOffset
.
y
-
=
5
;
ScrollMetadata
metadata
=
apzc
-
>
GetScrollMetadata
(
)
;
metadata
.
GetMetrics
(
)
.
SetLayoutScrollOffset
(
mainThreadOffset
)
;
nsTArray
<
ScrollPositionUpdate
>
scrollUpdates
;
scrollUpdates
.
AppendElement
(
ScrollPositionUpdate
:
:
NewScroll
(
ScrollOrigin
:
:
Other
CSSPoint
:
:
ToAppUnits
(
mainThreadOffset
)
)
)
;
metadata
.
SetScrollUpdates
(
scrollUpdates
)
;
metadata
.
GetMetrics
(
)
.
SetScrollGeneration
(
scrollUpdates
.
LastElement
(
)
.
GetGeneration
(
)
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata
false
true
)
;
for
(
int
i
=
0
;
i
<
20
;
+
+
i
)
{
touchPos
.
y
-
=
1
;
mcc
-
>
AdvanceByMillis
(
1
)
;
TouchMove
(
apzc
touchPos
mcc
-
>
Time
(
)
)
;
}
CSSPoint
finalScrollOffset
=
apzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
;
EXPECT_GT
(
finalScrollOffset
.
y
scrollOffsetBeforeInterruption
.
y
)
;
scrollOffsetBeforeInterruption
=
apzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
;
mainThreadOffset
=
scrollOffsetBeforeInterruption
;
mainThreadOffset
.
y
-
=
5
;
metadata
=
apzc
-
>
GetScrollMetadata
(
)
;
metadata
.
GetMetrics
(
)
.
SetVisualDestination
(
mainThreadOffset
)
;
metadata
.
GetMetrics
(
)
.
SetScrollGeneration
(
ScrollGeneration
:
:
New
(
)
)
;
metadata
.
GetMetrics
(
)
.
SetVisualScrollUpdateType
(
FrameMetrics
:
:
eMainThread
)
;
scrollUpdates
.
Clear
(
)
;
metadata
.
SetScrollUpdates
(
scrollUpdates
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata
false
true
)
;
for
(
int
i
=
0
;
i
<
20
;
+
+
i
)
{
touchPos
.
y
-
=
1
;
mcc
-
>
AdvanceByMillis
(
1
)
;
TouchMove
(
apzc
touchPos
mcc
-
>
Time
(
)
)
;
}
finalScrollOffset
=
apzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
;
EXPECT_GT
(
finalScrollOffset
.
y
scrollOffsetBeforeInterruption
.
y
)
;
mcc
-
>
AdvanceByMillis
(
1
)
;
TouchUp
(
apzc
touchPos
mcc
-
>
Time
(
)
)
;
}
#
endif
TEST_F
(
APZCBasicTester
RelativeScrollOffset
)
{
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
1000
1000
)
)
;
metrics
.
SetLayoutViewport
(
CSSRect
(
100
100
100
100
)
)
;
metrics
.
SetZoom
(
CSSToParentLayerScale2D
(
2
.
0
2
.
0
)
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
120
120
)
)
;
metrics
.
SetIsRootContent
(
true
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
ScrollMetadata
mainThreadMetadata
=
metadata
;
FrameMetrics
&
mainThreadMetrics
=
mainThreadMetadata
.
GetMetrics
(
)
;
mainThreadMetrics
.
SetLayoutScrollOffset
(
CSSPoint
(
200
200
)
)
;
nsTArray
<
ScrollPositionUpdate
>
scrollUpdates
;
scrollUpdates
.
AppendElement
(
ScrollPositionUpdate
:
:
NewScroll
(
ScrollOrigin
:
:
Other
CSSPoint
:
:
ToAppUnits
(
CSSPoint
(
200
200
)
)
)
)
;
mainThreadMetadata
.
SetScrollUpdates
(
scrollUpdates
)
;
mainThreadMetrics
.
SetScrollGeneration
(
scrollUpdates
.
LastElement
(
)
.
GetGeneration
(
)
)
;
apzc
-
>
NotifyLayersUpdated
(
mainThreadMetadata
false
true
)
;
metrics
=
apzc
-
>
GetFrameMetrics
(
)
;
EXPECT_EQ
(
metrics
.
GetLayoutScrollOffset
(
)
CSSPoint
(
200
200
)
)
;
EXPECT_EQ
(
metrics
.
GetVisualScrollOffset
(
)
CSSPoint
(
220
220
)
)
;
}
TEST_F
(
APZCBasicTester
MultipleSmoothScrollsSmooth
)
{
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
10000
)
)
;
metrics
.
SetLayoutViewport
(
CSSRect
(
0
0
100
100
)
)
;
metrics
.
SetZoom
(
CSSToParentLayerScale2D
(
1
.
0
1
.
0
)
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
0
)
)
;
metrics
.
SetIsRootContent
(
true
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
ScrollMetadata
metadata2
=
metadata
;
nsTArray
<
ScrollPositionUpdate
>
scrollUpdates2
;
scrollUpdates2
.
AppendElement
(
ScrollPositionUpdate
:
:
NewPureRelativeScroll
(
ScrollOrigin
:
:
Other
ScrollMode
:
:
Smooth
CSSPoint
:
:
ToAppUnits
(
CSSPoint
(
0
200
)
)
)
)
;
metadata2
.
SetScrollUpdates
(
scrollUpdates2
)
;
metadata2
.
GetMetrics
(
)
.
SetScrollGeneration
(
scrollUpdates2
.
LastElement
(
)
.
GetGeneration
(
)
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata2
false
true
)
;
for
(
uint32_t
i
=
0
;
i
<
3
;
i
+
+
)
{
SampleAnimationOneFrame
(
)
;
}
float
offset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForCompositing
)
.
y
;
ASSERT_GT
(
offset
0
)
;
float
lastOffset
=
offset
;
for
(
uint32_t
i
=
0
;
i
<
2
;
i
+
+
)
{
for
(
uint32_t
j
=
0
;
j
<
3
;
j
+
+
)
{
SampleAnimationOneFrame
(
)
;
offset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForCompositing
)
.
y
;
ASSERT_GT
(
offset
lastOffset
)
;
lastOffset
=
offset
;
}
ScrollMetadata
metadata3
=
metadata
;
nsTArray
<
ScrollPositionUpdate
>
scrollUpdates3
;
scrollUpdates3
.
AppendElement
(
ScrollPositionUpdate
:
:
NewPureRelativeScroll
(
ScrollOrigin
:
:
Other
ScrollMode
:
:
Smooth
CSSPoint
:
:
ToAppUnits
(
CSSPoint
(
0
200
)
)
)
)
;
metadata3
.
SetScrollUpdates
(
scrollUpdates3
)
;
metadata3
.
GetMetrics
(
)
.
SetScrollGeneration
(
scrollUpdates3
.
LastElement
(
)
.
GetGeneration
(
)
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata3
false
true
)
;
}
for
(
uint32_t
j
=
0
;
j
<
7
;
j
+
+
)
{
SampleAnimationOneFrame
(
)
;
offset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForCompositing
)
.
y
;
ASSERT_GT
(
offset
lastOffset
)
;
lastOffset
=
offset
;
}
}
TEST_F
(
APZCBasicTester
ZoomAndScrollableRectChangeAfterZoomChange
)
{
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetLayoutViewport
(
CSSRect
(
0
0
100
100
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
0
)
)
;
metrics
.
SetZoom
(
CSSToParentLayerScale2D
(
1
.
0
1
.
0
)
)
;
metrics
.
SetIsRootContent
(
true
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
MakeApzcZoomable
(
)
;
ZoomTarget
zoomTarget
{
CSSRect
(
75
25
25
25
)
Nothing
(
)
}
;
apzc
-
>
ZoomToRect
(
zoomTarget
0
)
;
for
(
uint32_t
i
=
0
;
i
<
30
;
i
+
+
)
{
SampleAnimationOneFrame
(
)
;
}
EXPECT_FALSE
(
apzc
-
>
IsAsyncZooming
(
)
)
;
ZoomTarget
zoomTarget2
{
CSSRect
(
0
0
100
100
)
Nothing
(
)
}
;
apzc
-
>
ZoomToRect
(
zoomTarget2
0
)
;
for
(
uint32_t
i
=
0
;
i
<
2
;
i
+
+
)
{
SampleAnimationOneFrame
(
)
;
}
float
prevScale
=
apzc
-
>
GetCurrentPinchZoomScale
(
AsyncPanZoomController
:
:
eForCompositing
)
.
scale
;
for
(
uint32_t
i
=
0
;
i
<
2
;
i
+
+
)
{
SampleAnimationOneFrame
(
)
;
float
scale
=
apzc
-
>
GetCurrentPinchZoomScale
(
AsyncPanZoomController
:
:
eForCompositing
)
.
scale
;
ASSERT_GT
(
prevScale
scale
)
;
prevScale
=
scale
;
}
float
offset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForCompositing
)
.
x
;
ScrollMetadata
metadata2
=
metadata
;
metadata2
.
GetMetrics
(
)
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
.
2
)
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata2
false
true
)
;
float
newOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForCompositing
)
.
x
;
ASSERT_EQ
(
newOffset
offset
)
;
}
TEST_F
(
APZCBasicTester
ZoomToRectAndCompositionBoundsChange
)
{
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
100
100
)
)
;
metrics
.
SetCompositionBoundsWidthIgnoringScrollbars
(
ParentLayerCoord
{
100
}
)
;
metrics
.
SetScrollableRect
(
CSSRect
(
0
0
100
1000
)
)
;
metrics
.
SetLayoutViewport
(
CSSRect
(
0
0
100
100
)
)
;
metrics
.
SetVisualScrollOffset
(
CSSPoint
(
0
0
)
)
;
metrics
.
SetZoom
(
CSSToParentLayerScale2D
(
1
.
0
1
.
0
)
)
;
metrics
.
SetIsRootContent
(
true
)
;
apzc
-
>
SetFrameMetrics
(
metrics
)
;
MakeApzcZoomable
(
)
;
ZoomTarget
zoomTarget
{
CSSRect
(
25
25
25
25
)
Nothing
(
)
}
;
apzc
-
>
ZoomToRect
(
zoomTarget
0
)
;
float
prevScale
=
apzc
-
>
GetCurrentPinchZoomScale
(
AsyncPanZoomController
:
:
eForCompositing
)
.
scale
;
for
(
uint32_t
i
=
0
;
i
<
3
;
i
+
+
)
{
SampleAnimationOneFrame
(
)
;
float
scale
=
apzc
-
>
GetCurrentPinchZoomScale
(
AsyncPanZoomController
:
:
eForCompositing
)
.
scale
;
ASSERT_GE
(
scale
prevScale
)
;
prevScale
=
scale
;
}
EXPECT_TRUE
(
apzc
-
>
IsAsyncZooming
(
)
)
;
ScrollMetadata
metadata2
=
metadata
;
metadata2
.
GetMetrics
(
)
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
90
100
)
)
;
apzc
-
>
NotifyLayersUpdated
(
metadata2
false
true
)
;
float
scale
=
apzc
-
>
GetCurrentPinchZoomScale
(
AsyncPanZoomController
:
:
eForCompositing
)
.
scale
;
ASSERT_EQ
(
scale
prevScale
)
;
for
(
uint32_t
i
=
0
;
i
<
30
;
i
+
+
)
{
SampleAnimationOneFrame
(
)
;
scale
=
apzc
-
>
GetCurrentPinchZoomScale
(
AsyncPanZoomController
:
:
eForCompositing
)
.
scale
;
ASSERT_GE
(
scale
prevScale
)
;
prevScale
=
scale
;
}
EXPECT_FALSE
(
apzc
-
>
IsAsyncZooming
(
)
)
;
}
