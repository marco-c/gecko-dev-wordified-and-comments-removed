#
ifndef
mozilla_layers_APZCTreeManagerTester_h
#
define
mozilla_layers_APZCTreeManagerTester_h
#
include
"
APZTestAccess
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
InternalHitTester
.
h
"
#
include
"
apz
/
src
/
WRHitTester
.
h
"
#
include
"
mozilla
/
layers
/
APZSampler
.
h
"
#
include
"
mozilla
/
layers
/
APZUpdater
.
h
"
#
include
"
mozilla
/
layers
/
WebRenderScrollDataWrapper
.
h
"
class
APZCTreeManagerTester
:
public
APZCTesterBase
{
protected
:
APZCTreeManagerTester
(
)
:
mHitTester
(
MakeUnique
<
WRHitTester
>
(
)
)
{
}
virtual
void
SetUp
(
)
{
APZCTesterBase
:
:
SetUp
(
)
;
APZThreadUtils
:
:
SetThreadAssertionsEnabled
(
false
)
;
APZThreadUtils
:
:
SetControllerThread
(
NS_GetCurrentThread
(
)
)
;
manager
=
new
TestAPZCTreeManager
(
mcc
std
:
:
move
(
mHitTester
)
)
;
updater
=
new
APZUpdater
(
manager
false
)
;
sampler
=
new
APZSampler
(
manager
false
)
;
}
virtual
void
TearDown
(
)
{
while
(
mcc
-
>
RunThroughDelayedTasks
(
)
)
;
manager
-
>
ClearTree
(
)
;
manager
-
>
ClearContentController
(
)
;
}
bool
SampleAnimationsOnce
(
)
{
const
TimeDuration
increment
=
TimeDuration
:
:
FromMilliseconds
(
1
)
;
ParentLayerPoint
pointOut
;
AsyncTransform
viewTransformOut
;
mcc
-
>
AdvanceBy
(
increment
)
;
bool
activeAnimations
=
false
;
for
(
size_t
i
=
0
;
i
<
layers
.
GetLayerCount
(
)
;
+
+
i
)
{
if
(
TestAsyncPanZoomController
*
apzc
=
ApzcOf
(
layers
[
i
]
)
)
{
activeAnimations
|
=
apzc
-
>
SampleContentTransformForFrame
(
&
viewTransformOut
pointOut
)
;
}
}
return
activeAnimations
;
}
template
<
typename
Callback
>
void
ModifyFrameMetrics
(
WebRenderLayerScrollData
*
aLayer
Callback
aCallback
)
{
MOZ_ASSERT
(
aLayer
-
>
GetScrollMetadataCount
(
)
=
=
1
)
;
ScrollMetadata
&
metadataRef
=
APZTestAccess
:
:
GetScrollMetadataMut
(
*
aLayer
layers
0
)
;
aCallback
(
metadataRef
metadataRef
.
GetMetrics
(
)
)
;
}
void
UpdateHitTestingTree
(
uint32_t
aPaintSequenceNumber
=
0
)
{
manager
-
>
UpdateHitTestingTree
(
WebRenderScrollDataWrapper
{
*
updater
&
layers
}
false
LayersId
{
0
}
aPaintSequenceNumber
)
;
}
void
CreateScrollData
(
const
char
*
aTreeShape
const
nsIntRegion
*
aVisibleRegions
=
nullptr
const
gfx
:
:
Matrix4x4
*
aTransforms
=
nullptr
)
{
layers
=
TestWRScrollData
:
:
Create
(
aTreeShape
*
updater
aVisibleRegions
aTransforms
)
;
root
=
layers
[
0
]
;
}
RefPtr
<
TestAPZCTreeManager
>
manager
;
RefPtr
<
APZSampler
>
sampler
;
RefPtr
<
APZUpdater
>
updater
;
TestWRScrollData
layers
;
WebRenderLayerScrollData
*
root
=
nullptr
;
UniquePtr
<
IAPZHitTester
>
mHitTester
;
protected
:
static
ScrollMetadata
BuildScrollMetadata
(
ScrollableLayerGuid
:
:
ViewID
aScrollId
const
CSSRect
&
aScrollableRect
const
ParentLayerRect
&
aCompositionBounds
)
{
ScrollMetadata
metadata
;
FrameMetrics
&
metrics
=
metadata
.
GetMetrics
(
)
;
metrics
.
SetScrollId
(
aScrollId
)
;
if
(
aScrollId
=
=
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
{
metadata
.
SetIsLayersIdRoot
(
true
)
;
}
metrics
.
SetCompositionBounds
(
aCompositionBounds
)
;
metrics
.
SetScrollableRect
(
aScrollableRect
)
;
metrics
.
SetLayoutScrollOffset
(
CSSPoint
(
0
0
)
)
;
metadata
.
SetPageScrollAmount
(
LayoutDeviceIntSize
(
50
100
)
)
;
metadata
.
SetLineScrollAmount
(
LayoutDeviceIntSize
(
5
10
)
)
;
return
metadata
;
}
void
SetEventRegionsBasedOnBottommostMetrics
(
WebRenderLayerScrollData
*
aLayer
)
{
const
FrameMetrics
&
metrics
=
aLayer
-
>
GetScrollMetadata
(
layers
0
)
.
GetMetrics
(
)
;
CSSRect
scrollableRect
=
metrics
.
GetScrollableRect
(
)
;
if
(
!
scrollableRect
.
IsEqualEdges
(
CSSRect
(
-
1
-
1
-
1
-
1
)
)
)
{
EventRegions
er
=
aLayer
-
>
GetEventRegions
(
)
;
IntRect
scrollRect
=
RoundedToInt
(
scrollableRect
*
metrics
.
LayersPixelsPerCSSPixel
(
)
)
.
ToUnknownRect
(
)
;
er
.
mHitRegion
=
nsIntRegion
(
IntRect
(
RoundedToInt
(
metrics
.
GetCompositionBounds
(
)
.
TopLeft
(
)
.
ToUnknownPoint
(
)
)
scrollRect
.
Size
(
)
)
)
;
APZTestAccess
:
:
SetEventRegions
(
*
aLayer
er
)
;
}
}
void
SetScrollMetadata
(
WebRenderLayerScrollData
*
aLayer
const
ScrollMetadata
&
aMetadata
)
{
MOZ_ASSERT
(
aLayer
-
>
GetScrollMetadataCount
(
)
<
=
1
"
This
function
does
not
support
multiple
ScrollMetadata
on
a
"
"
single
layer
"
)
;
if
(
aLayer
-
>
GetScrollMetadataCount
(
)
=
=
0
)
{
aLayer
-
>
AppendScrollMetadata
(
layers
aMetadata
)
;
}
else
{
ModifyFrameMetrics
(
aLayer
[
&
]
(
ScrollMetadata
&
aSm
FrameMetrics
&
)
{
aSm
=
aMetadata
;
}
)
;
}
}
void
SetScrollMetadata
(
WebRenderLayerScrollData
*
aLayer
const
nsTArray
<
ScrollMetadata
>
&
aMetadata
)
{
MOZ_ASSERT
(
aLayer
-
>
GetScrollMetadataCount
(
)
=
=
0
"
This
function
can
only
be
used
on
layers
which
do
not
yet
have
"
"
scroll
metadata
"
)
;
for
(
const
ScrollMetadata
&
metadata
:
aMetadata
)
{
aLayer
-
>
AppendScrollMetadata
(
layers
metadata
)
;
}
}
void
SetScrollableFrameMetrics
(
WebRenderLayerScrollData
*
aLayer
ScrollableLayerGuid
:
:
ViewID
aScrollId
CSSRect
aScrollableRect
=
CSSRect
(
-
1
-
1
-
1
-
1
)
)
{
auto
localTransform
=
aLayer
-
>
GetTransformTyped
(
)
*
AsyncTransformMatrix
(
)
;
ParentLayerIntRect
compositionBounds
=
RoundedToInt
(
localTransform
.
TransformBounds
(
LayerRect
(
aLayer
-
>
GetVisibleRegion
(
)
.
GetBounds
(
)
)
)
)
;
ScrollMetadata
metadata
=
BuildScrollMetadata
(
aScrollId
aScrollableRect
ParentLayerRect
(
compositionBounds
)
)
;
SetScrollMetadata
(
aLayer
metadata
)
;
SetEventRegionsBasedOnBottommostMetrics
(
aLayer
)
;
}
bool
HasScrollableFrameMetrics
(
const
WebRenderLayerScrollData
*
aLayer
)
const
{
for
(
uint32_t
i
=
0
;
i
<
aLayer
-
>
GetScrollMetadataCount
(
)
;
i
+
+
)
{
if
(
aLayer
-
>
GetScrollMetadata
(
layers
i
)
.
GetMetrics
(
)
.
IsScrollable
(
)
)
{
return
true
;
}
}
return
false
;
}
void
SetScrollHandoff
(
WebRenderLayerScrollData
*
aChild
WebRenderLayerScrollData
*
aParent
)
{
ModifyFrameMetrics
(
aChild
[
&
]
(
ScrollMetadata
&
aSm
FrameMetrics
&
)
{
aSm
.
SetScrollParentId
(
aParent
-
>
GetScrollMetadata
(
layers
0
)
.
GetMetrics
(
)
.
GetScrollId
(
)
)
;
}
)
;
}
TestAsyncPanZoomController
*
ApzcOf
(
WebRenderLayerScrollData
*
aLayer
)
{
EXPECT_EQ
(
1u
aLayer
-
>
GetScrollMetadataCount
(
)
)
;
return
ApzcOf
(
aLayer
0
)
;
}
TestAsyncPanZoomController
*
ApzcOf
(
WebRenderLayerScrollData
*
aLayer
uint32_t
aIndex
)
{
EXPECT_LT
(
aIndex
aLayer
-
>
GetScrollMetadataCount
(
)
)
;
RefPtr
<
AsyncPanZoomController
>
apzc
=
manager
-
>
GetTargetAPZC
(
LayersId
{
0
}
aLayer
-
>
GetScrollMetadata
(
layers
aIndex
)
.
GetMetrics
(
)
.
GetScrollId
(
)
)
;
return
(
TestAsyncPanZoomController
*
)
apzc
.
get
(
)
;
}
void
CreateSimpleScrollingLayer
(
)
{
const
char
*
treeShape
=
"
x
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
SetScrollableFrameMetrics
(
layers
[
0
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
500
500
)
)
;
}
}
;
#
endif
