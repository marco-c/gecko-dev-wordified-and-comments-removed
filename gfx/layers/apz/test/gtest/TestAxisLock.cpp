#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
<
cmath
>
class
APZCAxisLockCompatTester
:
public
APZCTreeManagerTester
public
testing
:
:
WithParamInterface
<
int
>
{
public
:
APZCAxisLockCompatTester
(
)
:
oldAxisLockMode
(
0
)
{
CreateMockHitTester
(
)
;
}
int
oldAxisLockMode
;
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
RefPtr
<
TestAsyncPanZoomController
>
apzc
;
void
SetUp
(
)
{
APZCTreeManagerTester
:
:
SetUp
(
)
;
oldAxisLockMode
=
Preferences
:
:
GetInt
(
"
apz
.
axis_lock
.
mode
"
)
;
Preferences
:
:
SetInt
(
"
apz
.
axis_lock
.
mode
"
GetParam
(
)
)
;
}
void
TearDown
(
)
{
APZCTreeManagerTester
:
:
TearDown
(
)
;
Preferences
:
:
SetInt
(
"
apz
.
axis_lock
.
mode
"
oldAxisLockMode
)
;
}
static
std
:
:
string
PrintFromParam
(
const
testing
:
:
TestParamInfo
<
int
>
&
info
)
{
switch
(
info
.
param
)
{
case
0
:
return
"
FREE
"
;
case
1
:
return
"
STANDARD
"
;
case
2
:
return
"
STICKY
"
;
case
3
:
return
"
DOMINANT_AXIS
"
;
default
:
return
"
UNKNOWN
"
;
}
}
}
;
class
APZCAxisLockTester
:
public
APZCTreeManagerTester
{
public
:
APZCAxisLockTester
(
)
{
CreateMockHitTester
(
)
;
}
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
RefPtr
<
TestAsyncPanZoomController
>
apzc
;
void
SetupBasicTest
(
)
{
const
char
*
treeShape
=
"
x
"
;
LayerIntRect
layerVisibleRect
[
]
=
{
LayerIntRect
(
0
0
100
100
)
}
;
CreateScrollData
(
treeShape
layerVisibleRect
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
500
500
)
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
}
void
BreakStickyAxisLockTestGesture
(
const
ScrollDirections
&
aDirections
)
{
float
panX
=
0
;
float
panY
=
0
;
if
(
aDirections
.
contains
(
ScrollDirection
:
:
eVertical
)
)
{
panY
=
30
;
}
if
(
aDirections
.
contains
(
ScrollDirection
:
:
eHorizontal
)
)
{
panX
=
30
;
}
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
panX
panY
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
panX
panY
)
mcc
-
>
Time
(
)
)
;
}
void
BreakStickyAxisLockTest
(
const
ScrollDirections
&
aDirections
)
{
BreakStickyAxisLockTestGesture
(
aDirections
)
;
if
(
aDirections
=
=
ScrollDirection
:
:
eVertical
)
{
apzc
-
>
AssertStateIsPanningLockedY
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
EXPECT_EQ
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
}
else
if
(
aDirections
=
=
ScrollDirection
:
:
eHorizontal
)
{
apzc
-
>
AssertStateIsPanningLockedX
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eHorizontal
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
EXPECT_EQ
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
}
else
{
apzc
-
>
AssertStateIsPanning
(
)
;
apzc
-
>
AssertNotAxisLocked
(
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
}
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
}
}
;
TEST_F
(
APZCAxisLockTester
BasicDominantAxisUse
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
1
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
axis_lock
.
lock_angle
"
M_PI
/
4
.
0f
)
;
SetupBasicTest
(
)
;
apzc
=
ApzcOf
(
root
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
1
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
15
30
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
15
30
)
mcc
-
>
Time
(
)
)
;
apzc
-
>
AssertStateIsPanningLockedY
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
EXPECT_EQ
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
ParentLayerPoint
panEndOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_EQ
(
panEndOffset
.
x
0
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
30
90
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
10
30
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
10
30
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
apzc
-
>
AssertStateIsPanMomentum
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
EXPECT_EQ
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMEND
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
apzc
-
>
AssertNotAxisLocked
(
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
ParentLayerPoint
finalOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_GT
(
finalOffset
.
y
panEndOffset
.
y
)
;
EXPECT_EQ
(
finalOffset
.
x
0
.
0f
)
;
}
TEST_F
(
APZCAxisLockTester
NewGestureBreaksMomentumAxisLock
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
1
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
axis_lock
.
lock_angle
"
M_PI
/
4
.
0f
)
;
SetupBasicTest
(
)
;
apzc
=
ApzcOf
(
root
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
2
1
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
30
15
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
30
15
)
mcc
-
>
Time
(
)
)
;
apzc
-
>
AssertStateIsPanningLockedX
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eHorizontal
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
EXPECT_EQ
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
ParentLayerPoint
panEndOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_EQ
(
panEndOffset
.
y
0
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eHorizontal
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMSTART
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
80
40
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
20
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_MOMENTUMPAN
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
20
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
apzc
-
>
AssertStateIsPanMomentum
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eHorizontal
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
EXPECT_EQ
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
ParentLayerPoint
beforeBreakOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_EQ
(
beforeBreakOffset
.
y
0
)
;
EXPECT_GT
(
beforeBreakOffset
.
x
panEndOffset
.
x
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
1
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
ParentLayerPoint
afterBreakOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
15
30
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
15
30
)
mcc
-
>
Time
(
)
)
;
apzc
-
>
AssertStateIsPanningLockedY
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
EXPECT_GT
(
apzc
-
>
GetVelocityVector
(
)
.
y
0
)
;
EXPECT_EQ
(
apzc
-
>
GetVelocityVector
(
)
.
x
0
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
ParentLayerPoint
finalOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_GT
(
finalOffset
.
y
0
)
;
EXPECT_EQ
(
finalOffset
.
x
afterBreakOffset
.
x
)
;
}
TEST_F
(
APZCAxisLockTester
BreakStickyAxisLock
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
2
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
axis_lock
.
lock_angle
"
M_PI
/
6
.
0f
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
axis_lock
.
breakout_angle
"
M_PI
/
6
.
0f
)
;
SetupBasicTest
(
)
;
apzc
=
ApzcOf
(
root
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
apzc
-
>
AssertStateIsPanningLockedY
(
)
;
BreakStickyAxisLockTest
(
ScrollDirection
:
:
eHorizontal
)
;
BreakStickyAxisLockTest
(
ScrollDirection
:
:
eVertical
)
;
BreakStickyAxisLockTest
(
ScrollDirections
(
ScrollDirection
:
:
eHorizontal
ScrollDirection
:
:
eVertical
)
)
;
apzc
-
>
AssertStateIsPanning
(
)
;
apzc
-
>
AssertNotAxisLocked
(
)
;
BreakStickyAxisLockTestGesture
(
ScrollDirection
:
:
eHorizontal
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
apzc
-
>
AssertStateIsPanningLockedX
(
)
;
BreakStickyAxisLockTest
(
ScrollDirections
(
ScrollDirection
:
:
eHorizontal
ScrollDirection
:
:
eVertical
)
)
;
apzc
-
>
AssertStateIsPanning
(
)
;
apzc
-
>
AssertNotAxisLocked
(
)
;
BreakStickyAxisLockTest
(
ScrollDirection
:
:
eVertical
)
;
}
TEST_F
(
APZCAxisLockTester
BreakAxisLockByLockAngle
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
2
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
axis_lock
.
lock_angle
"
M_PI
/
4
.
0f
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
axis_lock
.
breakout_angle
"
M_PI
/
8
.
0f
)
;
SetupBasicTest
(
)
;
apzc
=
ApzcOf
(
root
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
1
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
apzc
-
>
AssertStateIsPanningLockedY
(
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
12
10
)
mcc
-
>
Time
(
)
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
apzc
-
>
AssertStateIsPanningLockedX
(
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
}
TEST_F
(
APZCAxisLockTester
TestDominantAxisScrolling
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
3
)
;
int
panY
;
int
panX
;
SetupBasicTest
(
)
;
apzc
=
ApzcOf
(
root
)
;
ParentLayerPoint
lastOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForEventHandling
)
;
for
(
panX
=
0
panY
=
50
;
panY
>
=
0
;
panY
-
=
10
panX
+
=
5
)
{
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
panX
panY
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
static_cast
<
float
>
(
panX
)
static_cast
<
float
>
(
panY
)
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
ParentLayerPoint
scrollOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncPanZoomController
:
:
eForEventHandling
)
;
if
(
panX
>
panY
)
{
EXPECT_GT
(
scrollOffset
.
x
lastOffset
.
x
)
;
EXPECT_EQ
(
scrollOffset
.
y
lastOffset
.
y
)
;
}
else
{
EXPECT_GT
(
scrollOffset
.
y
lastOffset
.
y
)
;
EXPECT_EQ
(
scrollOffset
.
x
lastOffset
.
x
)
;
}
lastOffset
=
scrollOffset
;
}
}
TEST_F
(
APZCAxisLockTester
TestCanScrollWithAxisLock
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
2
)
;
SetupBasicTest
(
)
;
apzc
=
ApzcOf
(
root
)
;
apzc
-
>
SetAxisLocked
(
ScrollDirection
:
:
eHorizontal
true
)
;
EXPECT_EQ
(
apzc
-
>
CanScroll
(
ParentLayerPoint
(
10
0
)
)
true
)
;
apzc
-
>
SetAxisLocked
(
ScrollDirection
:
:
eHorizontal
false
)
;
apzc
-
>
SetAxisLocked
(
ScrollDirection
:
:
eVertical
true
)
;
EXPECT_EQ
(
apzc
-
>
CanScroll
(
ParentLayerPoint
(
0
10
)
)
true
)
;
}
TEST_F
(
APZCAxisLockTester
TestScrollHandoffAxisLockConflict
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
2
)
;
const
char
*
treeShape
=
"
x
(
x
)
"
;
LayerIntRect
layerVisibleRect
[
]
=
{
LayerIntRect
(
0
0
100
100
)
LayerIntRect
(
0
0
100
100
)
}
;
CreateScrollData
(
treeShape
layerVisibleRect
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
500
500
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
500
500
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
rootApzc
=
ApzcOf
(
root
)
;
apzc
=
ApzcOf
(
layers
[
1
]
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
0
2
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
15
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
ParentLayerPoint
childCurrentOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_GT
(
childCurrentOffset
.
y
0
)
;
EXPECT_EQ
(
childCurrentOffset
.
x
0
)
;
ParentLayerPoint
parentCurrentOffset
=
rootApzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_EQ
(
parentCurrentOffset
.
y
0
)
;
EXPECT_EQ
(
parentCurrentOffset
.
x
0
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
2
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_PAN
apzc
ScreenIntPoint
(
50
50
)
ScreenPoint
(
15
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_END
manager
ScreenIntPoint
(
50
50
)
ScreenPoint
(
0
0
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
apzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eHorizontal
)
;
ParentLayerPoint
childFinalOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_GT
(
childFinalOffset
.
x
0
)
;
ParentLayerPoint
parentFinalOffset
=
rootApzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_EQ
(
parentFinalOffset
.
y
0
)
;
EXPECT_EQ
(
parentFinalOffset
.
x
0
)
;
}
TEST_P
(
APZCAxisLockCompatTester
TestPanGestureStart
)
{
const
char
*
treeShape
=
"
x
"
;
LayerIntRect
layerVisibleRect
[
]
=
{
LayerIntRect
(
0
0
100
100
)
}
;
CreateScrollData
(
treeShape
layerVisibleRect
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
500
500
)
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
apzc
=
ApzcOf
(
root
)
;
QueueMockHitResult
(
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
PanGesture
(
PanGestureInput
:
:
PANGESTURE_START
manager
ScreenIntPoint
(
50
50
)
ScreenIntPoint
(
0
10
)
mcc
-
>
Time
(
)
)
;
mcc
-
>
AdvanceByMillis
(
5
)
;
apzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
ParentLayerPoint
currentOffset
=
apzc
-
>
GetCurrentAsyncScrollOffset
(
AsyncTransformConsumer
:
:
eForEventHandling
)
;
EXPECT_EQ
(
currentOffset
.
x
0
)
;
EXPECT_EQ
(
currentOffset
.
y
10
)
;
}
INSTANTIATE_TEST_SUITE_P
(
APZCAxisLockCompat
APZCAxisLockCompatTester
testing
:
:
Values
(
0
1
2
3
)
APZCAxisLockCompatTester
:
:
PrintFromParam
)
;
