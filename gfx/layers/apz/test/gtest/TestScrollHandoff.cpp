#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
class
APZScrollHandoffTester
:
public
APZCTreeManagerTester
{
protected
:
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
TestAsyncPanZoomController
*
rootApzc
;
void
CreateScrollHandoffLayerTree1
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
t
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
100
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetIsRootContent
(
true
)
;
}
void
CreateScrollHandoffLayerTree2
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
c
(
t
)
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
2
CSSRect
(
-
100
-
100
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
100
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
SetScrollHandoff
(
layers
[
2
]
layers
[
1
]
)
;
MOZ_ASSERT
(
registration
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateScrollHandoffLayerTree3
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
c
(
t
)
c
(
t
)
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
50
)
)
nsIntRegion
(
IntRect
(
0
0
100
50
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
layers
[
0
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
2
CSSRect
(
0
0
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
3
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
3
CSSRect
(
0
50
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
4
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
4
CSSRect
(
0
50
100
100
)
)
;
SetScrollHandoff
(
layers
[
1
]
layers
[
0
]
)
;
SetScrollHandoff
(
layers
[
3
]
layers
[
0
]
)
;
SetScrollHandoff
(
layers
[
2
]
layers
[
1
]
)
;
SetScrollHandoff
(
layers
[
4
]
layers
[
3
]
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
}
void
CreateScrollHandoffLayerTree4
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
t
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
200
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateScrollgrabLayerTree
(
bool
makeParentScrollable
=
true
)
{
const
char
*
layerTreeSyntax
=
"
c
(
t
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
20
100
80
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
float
parentHeight
=
makeParentScrollable
?
120
:
100
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
parentHeight
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
200
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetScrollMetadata
(
)
.
SetHasScrollgrab
(
true
)
;
}
void
TestFlingAcceleration
(
)
{
const
float
kAcceleration
=
100
.
0f
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_accel_base_mult
"
kAcceleration
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_accel_min_velocity
"
0
.
0
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
70
40
)
;
SampleAnimationsOnce
(
)
;
float
childVelocityAfterFling1
=
childApzc
-
>
GetVelocityVector
(
)
.
y
;
Pan
(
manager
70
40
)
;
SampleAnimationsOnce
(
)
;
float
childVelocityAfterFling2
=
childApzc
-
>
GetVelocityVector
(
)
.
y
;
EXPECT_GT
(
childVelocityAfterFling2
childVelocityAfterFling1
*
kAcceleration
/
2
)
;
EXPECT_LE
(
childVelocityAfterFling2
childVelocityAfterFling1
*
kAcceleration
*
kAcceleration
/
4
)
;
}
void
TestCrossApzcAxisLock
(
)
{
SCOPED_GFX_PREF_INT
(
"
apz
.
axis_lock
.
mode
"
1
)
;
CreateScrollHandoffLayerTree1
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
ScreenIntPoint
(
10
60
)
ScreenIntPoint
(
15
90
)
PanOptions
:
:
KeepFingerDown
|
PanOptions
:
:
ExactCoordinates
)
;
childApzc
-
>
AssertAxisLocked
(
ScrollDirection
:
:
eVertical
)
;
}
}
;
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
DeferredInputEventProcessing
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
true
)
;
CreateScrollHandoffLayerTree1
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
childApzc
-
>
SetWaitForMainThread
(
)
;
uint64_t
blockId
=
0
;
Pan
(
childApzc
90
30
PanOptions
:
:
NoFling
nullptr
nullptr
&
blockId
)
;
childApzc
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
childApzc
-
>
ConfirmTarget
(
blockId
)
;
EXPECT_EQ
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
10
rootApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
LayerStructureChangesWhileEventsArePending
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
true
)
;
CreateScrollHandoffLayerTree1
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
childApzc
-
>
SetWaitForMainThread
(
)
;
uint64_t
blockId
=
0
;
Pan
(
childApzc
90
30
PanOptions
:
:
NoFling
nullptr
nullptr
&
blockId
)
;
CreateScrollHandoffLayerTree2
(
)
;
RefPtr
<
Layer
>
middle
=
layers
[
1
]
;
childApzc
-
>
SetWaitForMainThread
(
)
;
TestAsyncPanZoomController
*
middleApzc
=
ApzcOf
(
middle
)
;
uint64_t
secondBlockId
=
0
;
Pan
(
childApzc
30
90
PanOptions
:
:
NoFling
nullptr
nullptr
&
secondBlockId
)
;
childApzc
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
childApzc
-
>
ConfirmTarget
(
blockId
)
;
EXPECT_EQ
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
10
rootApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
0
middleApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
childApzc
-
>
ContentReceivedInputBlock
(
secondBlockId
false
)
;
childApzc
-
>
ConfirmTarget
(
secondBlockId
)
;
EXPECT_EQ
(
0
childApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
10
rootApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
-
10
middleApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
StuckInOverscroll_Bug1073250
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
SCOPED_GFX_VAR
(
UseWebRender
bool
false
)
;
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
child
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
10
40
PanOptions
:
:
KeepFingerDown
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
MultiTouchInput
secondFingerDown
=
CreateMultiTouchInput
(
MultiTouchInput
:
:
MULTITOUCH_START
mcc
-
>
Time
(
)
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ScreenIntPoint
(
10
40
)
ScreenSize
(
0
0
)
0
0
)
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ScreenIntPoint
(
30
20
)
ScreenSize
(
0
0
)
0
0
)
)
;
manager
-
>
ReceiveInputEvent
(
secondFingerDown
)
;
MultiTouchInput
fingersUp
=
secondFingerDown
;
fingersUp
.
mType
=
MultiTouchInput
:
:
MULTITOUCH_END
;
manager
-
>
ReceiveInputEvent
(
fingersUp
)
;
child
-
>
AdvanceAnimationsUntilEnd
(
)
;
rootApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
StuckInOverscroll_Bug1231228
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
SCOPED_GFX_VAR
(
UseWebRender
bool
false
)
;
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
child
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
60
90
PanOptions
:
:
KeepFingerDown
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
MultiTouchInput
secondFingerDown
=
CreateMultiTouchInput
(
MultiTouchInput
:
:
MULTITOUCH_START
mcc
-
>
Time
(
)
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ScreenIntPoint
(
10
40
)
ScreenSize
(
0
0
)
0
0
)
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ScreenIntPoint
(
30
20
)
ScreenSize
(
0
0
)
0
0
)
)
;
manager
-
>
ReceiveInputEvent
(
secondFingerDown
)
;
MultiTouchInput
fingersUp
=
secondFingerDown
;
fingersUp
.
mType
=
MultiTouchInput
:
:
MULTITOUCH_END
;
manager
-
>
ReceiveInputEvent
(
fingersUp
)
;
child
-
>
AdvanceAnimationsUntilEnd
(
)
;
rootApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
StuckInOverscroll_Bug1240202a
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
child
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
60
90
PanOptions
:
:
KeepFingerDown
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
TouchUp
(
manager
ScreenIntPoint
(
10
90
)
mcc
-
>
Time
(
)
)
;
TouchDown
(
manager
ScreenIntPoint
(
10
90
)
mcc
-
>
Time
(
)
)
;
TouchUp
(
manager
ScreenIntPoint
(
10
90
)
mcc
-
>
Time
(
)
)
;
child
-
>
AdvanceAnimationsUntilEnd
(
)
;
rootApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
StuckInOverscroll_Bug1240202b
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
SCOPED_GFX_VAR
(
UseWebRender
bool
false
)
;
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
child
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
60
90
PanOptions
:
:
KeepFingerDown
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
TouchUp
(
manager
ScreenIntPoint
(
10
90
)
mcc
-
>
Time
(
)
)
;
TouchDown
(
manager
ScreenIntPoint
(
10
90
)
mcc
-
>
Time
(
)
)
;
MultiTouchInput
secondFingerDown
(
MultiTouchInput
:
:
MULTITOUCH_START
0
TimeStamp
(
)
0
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ScreenIntPoint
(
10
90
)
ScreenSize
(
0
0
)
0
0
)
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ScreenIntPoint
(
10
80
)
ScreenSize
(
0
0
)
0
0
)
)
;
manager
-
>
ReceiveInputEvent
(
secondFingerDown
)
;
MultiTouchInput
fingersUp
=
secondFingerDown
;
fingersUp
.
mType
=
MultiTouchInput
:
:
MULTITOUCH_END
;
manager
-
>
ReceiveInputEvent
(
fingersUp
)
;
child
-
>
AdvanceAnimationsUntilEnd
(
)
;
rootApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
OpposingConstrainedAxes_Bug1201098
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
overscroll
.
enabled
"
true
)
;
CreateScrollHandoffLayerTree4
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
50
60
)
;
EXPECT_TRUE
(
childApzc
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
#
endif
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
PartialFlingHandoff
)
{
SCOPED_GFX_VAR
(
UseWebRender
bool
false
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
CreateScrollHandoffLayerTree1
(
)
;
Pan
(
manager
ScreenIntPoint
(
90
90
)
ScreenIntPoint
(
55
55
)
)
;
RefPtr
<
TestAsyncPanZoomController
>
parent
=
ApzcOf
(
root
)
;
RefPtr
<
TestAsyncPanZoomController
>
child
=
ApzcOf
(
layers
[
1
]
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
child
-
>
AdvanceAnimations
(
mcc
-
>
GetSampleTime
(
)
)
;
child
-
>
AssertStateIsFling
(
)
;
parent
-
>
AssertStateIsFling
(
)
;
}
#
endif
TEST_F
(
APZScrollHandoffTester
SimultaneousFlings
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
CreateScrollHandoffLayerTree3
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
parent1
=
ApzcOf
(
layers
[
1
]
)
;
RefPtr
<
TestAsyncPanZoomController
>
child1
=
ApzcOf
(
layers
[
2
]
)
;
RefPtr
<
TestAsyncPanZoomController
>
parent2
=
ApzcOf
(
layers
[
3
]
)
;
RefPtr
<
TestAsyncPanZoomController
>
child2
=
ApzcOf
(
layers
[
4
]
)
;
Pan
(
child2
45
5
)
;
Pan
(
child1
95
55
)
;
child1
-
>
AssertStateIsFling
(
)
;
child2
-
>
AssertStateIsFling
(
)
;
child1
-
>
AdvanceAnimationsUntilEnd
(
)
;
child2
-
>
AdvanceAnimationsUntilEnd
(
)
;
child1
-
>
AssertStateIsReset
(
)
;
parent1
-
>
AssertStateIsFling
(
)
;
child2
-
>
AssertStateIsReset
(
)
;
parent2
-
>
AssertStateIsFling
(
)
;
}
#
ifndef
MOZ_WIDGET_ANDROID
TEST_F
(
APZScrollHandoffTester
Scrollgrab
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
true
)
;
CreateScrollgrabLayerTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
80
45
)
;
EXPECT_EQ
(
20
rootApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
15
childApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
}
#
endif
TEST_F
(
APZScrollHandoffTester
ScrollgrabFling
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
CreateScrollgrabLayerTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
80
70
)
;
rootApzc
-
>
AssertStateIsFling
(
)
;
childApzc
-
>
AssertStateIsReset
(
)
;
}
TEST_F
(
APZScrollHandoffTester
ScrollgrabFlingAcceleration1
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
SCOPED_GFX_VAR
(
UseWebRender
bool
false
)
;
CreateScrollgrabLayerTree
(
true
)
;
TestFlingAcceleration
(
)
;
}
#
ifndef
MOZ_WIDGET_ANDROID
#
if
0
TEST_F
(
APZScrollHandoffTester
ScrollgrabFlingAcceleration2
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
true
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
SCOPED_GFX_VAR
(
UseWebRender
bool
false
)
;
CreateScrollgrabLayerTree
(
false
)
;
TestFlingAcceleration
(
)
;
}
#
endif
#
endif
TEST_F
(
APZScrollHandoffTester
ImmediateHandoffDisallowed_Pan
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
false
)
;
CreateScrollHandoffLayerTree1
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
parentApzc
=
ApzcOf
(
root
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
60
5
)
;
EXPECT_EQ
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
0
parentApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
Pan
(
childApzc
60
50
)
;
EXPECT_EQ
(
10
parentApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
}
TEST_F
(
APZScrollHandoffTester
ImmediateHandoffDisallowed_Fling
)
{
SCOPED_GFX_PREF_BOOL
(
"
apz
.
allow_immediate_handoff
"
false
)
;
SCOPED_GFX_PREF_FLOAT
(
"
apz
.
fling_min_velocity_threshold
"
0
.
0f
)
;
CreateScrollHandoffLayerTree1
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
parentApzc
=
ApzcOf
(
root
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
60
12
)
;
childApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
parentApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
ASSERT_NEAR
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
COORDINATE_EPSILON
)
;
EXPECT_EQ
(
0
parentApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
)
;
Pan
(
childApzc
60
50
)
;
childApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
parentApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_GT
(
parentApzc
-
>
GetFrameMetrics
(
)
.
GetVisualScrollOffset
(
)
.
y
10
)
;
}
TEST_F
(
APZScrollHandoffTester
CrossApzcAxisLock_NoTouchAction
)
{
SCOPED_GFX_PREF_BOOL
(
"
layout
.
css
.
touch_action
.
enabled
"
false
)
;
TestCrossApzcAxisLock
(
)
;
}
TEST_F
(
APZScrollHandoffTester
CrossApzcAxisLock_TouchAction
)
{
SCOPED_GFX_PREF_BOOL
(
"
layout
.
css
.
touch_action
.
enabled
"
true
)
;
TestCrossApzcAxisLock
(
)
;
}
