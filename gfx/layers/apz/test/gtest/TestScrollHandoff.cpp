#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
class
APZScrollHandoffTester
:
public
APZCTreeManagerTester
{
protected
:
UniquePtr
<
ScopedLayerTreeRegistration
>
registration
;
TestAsyncPanZoomController
*
rootApzc
;
void
CreateScrollHandoffLayerTree1
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
t
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
FrameMetrics
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
100
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateScrollHandoffLayerTree2
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
c
(
t
)
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
FrameMetrics
:
:
START_SCROLL_ID
CSSRect
(
0
0
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
+
2
CSSRect
(
-
100
-
100
200
200
)
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
100
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
SetScrollHandoff
(
layers
[
2
]
layers
[
1
]
)
;
MOZ_ASSERT
(
registration
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
rootApzc
=
ApzcOf
(
root
)
;
}
void
CreateScrollHandoffLayerTree3
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
c
(
t
)
c
(
t
)
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
50
)
)
nsIntRegion
(
IntRect
(
0
0
100
50
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
3
]
FrameMetrics
:
:
START_SCROLL_ID
+
2
CSSRect
(
0
50
100
100
)
)
;
SetScrollableFrameMetrics
(
layers
[
4
]
FrameMetrics
:
:
START_SCROLL_ID
+
3
CSSRect
(
0
50
100
100
)
)
;
SetScrollHandoff
(
layers
[
2
]
layers
[
1
]
)
;
SetScrollHandoff
(
layers
[
4
]
layers
[
3
]
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
}
void
CreateScrollgrabLayerTree
(
bool
makeParentScrollable
=
true
)
{
const
char
*
layerTreeSyntax
=
"
c
(
t
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
20
100
80
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
float
parentHeight
=
makeParentScrollable
?
120
:
100
;
SetScrollableFrameMetrics
(
root
FrameMetrics
:
:
START_SCROLL_ID
CSSRect
(
0
0
100
parentHeight
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
CSSRect
(
0
0
100
200
)
)
;
SetScrollHandoff
(
layers
[
1
]
root
)
;
registration
=
MakeUnique
<
ScopedLayerTreeRegistration
>
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
rootApzc
=
ApzcOf
(
root
)
;
rootApzc
-
>
GetFrameMetrics
(
)
.
SetHasScrollgrab
(
true
)
;
}
void
TestFlingAcceleration
(
)
{
const
float
kAcceleration
=
100
.
0f
;
SCOPED_GFX_PREF
(
APZFlingAccelBaseMultiplier
float
kAcceleration
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
mcc
70
40
)
;
SampleAnimationsOnce
(
)
;
float
childVelocityAfterFling1
=
childApzc
-
>
GetVelocityVector
(
)
.
y
;
Pan
(
manager
mcc
70
40
)
;
SampleAnimationsOnce
(
)
;
float
childVelocityAfterFling2
=
childApzc
-
>
GetVelocityVector
(
)
.
y
;
EXPECT_GT
(
childVelocityAfterFling2
childVelocityAfterFling1
*
kAcceleration
/
2
)
;
EXPECT_LE
(
childVelocityAfterFling2
childVelocityAfterFling1
*
kAcceleration
*
kAcceleration
/
4
)
;
}
}
;
TEST_F
(
APZScrollHandoffTester
DeferredInputEventProcessing
)
{
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
childApzc
-
>
SetWaitForMainThread
(
)
;
uint64_t
blockId
=
0
;
ApzcPanNoFling
(
childApzc
mcc
90
30
&
blockId
)
;
childApzc
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
childApzc
-
>
ConfirmTarget
(
blockId
)
;
EXPECT_EQ
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
10
rootApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
}
TEST_F
(
APZScrollHandoffTester
LayerStructureChangesWhileEventsArePending
)
{
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
childApzc
-
>
SetWaitForMainThread
(
)
;
uint64_t
blockId
=
0
;
ApzcPanNoFling
(
childApzc
mcc
90
30
&
blockId
)
;
CreateScrollHandoffLayerTree2
(
)
;
RefPtr
<
Layer
>
middle
=
layers
[
1
]
;
childApzc
-
>
SetWaitForMainThread
(
)
;
TestAsyncPanZoomController
*
middleApzc
=
ApzcOf
(
middle
)
;
uint64_t
secondBlockId
=
0
;
ApzcPanNoFling
(
childApzc
mcc
30
90
&
secondBlockId
)
;
childApzc
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
childApzc
-
>
ConfirmTarget
(
blockId
)
;
EXPECT_EQ
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
10
rootApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
0
middleApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
childApzc
-
>
ContentReceivedInputBlock
(
secondBlockId
false
)
;
childApzc
-
>
ConfirmTarget
(
secondBlockId
)
;
EXPECT_EQ
(
0
childApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
10
rootApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
-
10
middleApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
}
TEST_F
(
APZScrollHandoffTester
StuckInOverscroll_Bug1073250
)
{
SCOPED_GFX_PREF
(
APZOverscrollEnabled
bool
true
)
;
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
child
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
mcc
10
40
true
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
MultiTouchInput
secondFingerDown
(
MultiTouchInput
:
:
MULTITOUCH_START
0
TimeStamp
(
)
0
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ScreenIntPoint
(
10
40
)
ScreenSize
(
0
0
)
0
0
)
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ScreenIntPoint
(
30
20
)
ScreenSize
(
0
0
)
0
0
)
)
;
manager
-
>
ReceiveInputEvent
(
secondFingerDown
nullptr
nullptr
)
;
MultiTouchInput
fingersUp
=
secondFingerDown
;
fingersUp
.
mType
=
MultiTouchInput
:
:
MULTITOUCH_END
;
manager
-
>
ReceiveInputEvent
(
fingersUp
nullptr
nullptr
)
;
child
-
>
AdvanceAnimationsUntilEnd
(
)
;
rootApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
TEST_F
(
APZScrollHandoffTester
StuckInOverscroll_Bug1231228
)
{
SCOPED_GFX_PREF
(
APZOverscrollEnabled
bool
true
)
;
CreateScrollHandoffLayerTree1
(
)
;
TestAsyncPanZoomController
*
child
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
manager
mcc
60
90
true
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_TRUE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
MultiTouchInput
secondFingerDown
(
MultiTouchInput
:
:
MULTITOUCH_START
0
TimeStamp
(
)
0
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ScreenIntPoint
(
10
40
)
ScreenSize
(
0
0
)
0
0
)
)
;
secondFingerDown
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ScreenIntPoint
(
30
20
)
ScreenSize
(
0
0
)
0
0
)
)
;
manager
-
>
ReceiveInputEvent
(
secondFingerDown
nullptr
nullptr
)
;
MultiTouchInput
fingersUp
=
secondFingerDown
;
fingersUp
.
mType
=
MultiTouchInput
:
:
MULTITOUCH_END
;
manager
-
>
ReceiveInputEvent
(
fingersUp
nullptr
nullptr
)
;
child
-
>
AdvanceAnimationsUntilEnd
(
)
;
rootApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_FALSE
(
child
-
>
IsOverscrolled
(
)
)
;
EXPECT_FALSE
(
rootApzc
-
>
IsOverscrolled
(
)
)
;
}
TEST_F
(
APZScrollHandoffTester
PartialFlingHandoff
)
{
CreateScrollHandoffLayerTree1
(
)
;
Pan
(
manager
mcc
ScreenPoint
(
90
90
)
ScreenPoint
(
55
55
)
)
;
RefPtr
<
TestAsyncPanZoomController
>
parent
=
ApzcOf
(
root
)
;
RefPtr
<
TestAsyncPanZoomController
>
child
=
ApzcOf
(
layers
[
1
]
)
;
mcc
-
>
AdvanceByMillis
(
10
)
;
child
-
>
AdvanceAnimations
(
mcc
-
>
Time
(
)
)
;
child
-
>
AssertStateIsFling
(
)
;
parent
-
>
AssertStateIsFling
(
)
;
}
TEST_F
(
APZScrollHandoffTester
SimultaneousFlings
)
{
CreateScrollHandoffLayerTree3
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
parent1
=
ApzcOf
(
layers
[
1
]
)
;
RefPtr
<
TestAsyncPanZoomController
>
child1
=
ApzcOf
(
layers
[
2
]
)
;
RefPtr
<
TestAsyncPanZoomController
>
parent2
=
ApzcOf
(
layers
[
3
]
)
;
RefPtr
<
TestAsyncPanZoomController
>
child2
=
ApzcOf
(
layers
[
4
]
)
;
Pan
(
child2
mcc
45
5
)
;
Pan
(
child1
mcc
95
55
)
;
child1
-
>
AssertStateIsFling
(
)
;
child2
-
>
AssertStateIsFling
(
)
;
child1
-
>
AdvanceAnimationsUntilEnd
(
)
;
child2
-
>
AdvanceAnimationsUntilEnd
(
)
;
child1
-
>
AssertStateIsReset
(
)
;
parent1
-
>
AssertStateIsFling
(
)
;
child2
-
>
AssertStateIsReset
(
)
;
parent2
-
>
AssertStateIsFling
(
)
;
}
TEST_F
(
APZScrollHandoffTester
Scrollgrab
)
{
CreateScrollgrabLayerTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
mcc
80
45
)
;
EXPECT_EQ
(
20
rootApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
15
childApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
}
TEST_F
(
APZScrollHandoffTester
ScrollgrabFling
)
{
CreateScrollgrabLayerTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
mcc
80
70
)
;
rootApzc
-
>
AssertStateIsFling
(
)
;
childApzc
-
>
AssertStateIsReset
(
)
;
}
TEST_F
(
APZScrollHandoffTester
ScrollgrabFlingAcceleration1
)
{
CreateScrollgrabLayerTree
(
true
)
;
TestFlingAcceleration
(
)
;
}
TEST_F
(
APZScrollHandoffTester
ScrollgrabFlingAcceleration2
)
{
CreateScrollgrabLayerTree
(
false
)
;
TestFlingAcceleration
(
)
;
}
TEST_F
(
APZScrollHandoffTester
ImmediateHandoffDisallowed_Pan
)
{
SCOPED_GFX_PREF
(
APZAllowImmediateHandoff
bool
false
)
;
CreateScrollHandoffLayerTree1
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
parentApzc
=
ApzcOf
(
root
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
mcc
60
5
)
;
EXPECT_EQ
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
EXPECT_EQ
(
0
parentApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
Pan
(
childApzc
mcc
60
50
)
;
EXPECT_EQ
(
10
parentApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
}
TEST_F
(
APZScrollHandoffTester
ImmediateHandoffDisallowed_Fling
)
{
SCOPED_GFX_PREF
(
APZAllowImmediateHandoff
bool
false
)
;
CreateScrollHandoffLayerTree1
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
parentApzc
=
ApzcOf
(
root
)
;
RefPtr
<
TestAsyncPanZoomController
>
childApzc
=
ApzcOf
(
layers
[
1
]
)
;
Pan
(
childApzc
mcc
60
12
)
;
childApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
parentApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
ASSERT_NEAR
(
50
childApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
COORDINATE_EPSILON
)
;
EXPECT_EQ
(
0
parentApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
)
;
Pan
(
childApzc
mcc
60
50
)
;
childApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
parentApzc
-
>
AdvanceAnimationsUntilEnd
(
)
;
EXPECT_GT
(
parentApzc
-
>
GetFrameMetrics
(
)
.
GetScrollOffset
(
)
.
y
10
)
;
}
