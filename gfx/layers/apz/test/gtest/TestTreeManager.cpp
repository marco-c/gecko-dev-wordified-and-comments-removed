#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
class
APZCTreeManagerGenericTester
:
public
APZCTreeManagerTester
{
protected
:
void
CreateSimpleDTCScrollingLayer
(
)
{
const
char
*
layerTreeSyntax
=
"
t
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
root
ScrollableLayerGuid
:
:
START_SCROLL_ID
CSSRect
(
0
0
500
500
)
)
;
EventRegions
regions
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
0
200
200
)
)
;
regions
.
mDispatchToContentHitRegion
=
regions
.
mHitRegion
;
layers
[
0
]
-
>
SetEventRegions
(
regions
)
;
}
void
CreateSimpleMultiLayerTree
(
)
{
const
char
*
treeShape
=
"
x
(
xx
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
50
)
)
nsIntRegion
(
IntRect
(
0
50
100
50
)
)
}
;
CreateScrollData
(
treeShape
layerVisibleRegion
)
;
}
void
CreatePotentiallyLeakingTree
(
)
{
const
char
*
layerTreeSyntax
=
"
c
(
c
(
c
(
t
)
)
c
(
c
(
t
)
)
)
"
;
root
=
CreateLayerTree
(
layerTreeSyntax
nullptr
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
layers
[
0
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
SetScrollableFrameMetrics
(
layers
[
5
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
SetScrollableFrameMetrics
(
layers
[
3
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
2
)
;
SetScrollableFrameMetrics
(
layers
[
6
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
3
)
;
}
void
CreateTwoLayerDTCTree
(
int32_t
aRootContentLayerIndex
)
{
const
char
*
layerTreeSyntax
=
"
c
(
t
)
"
;
nsIntRegion
layerVisibleRegion
[
]
=
{
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
}
;
root
=
CreateLayerTree
(
layerTreeSyntax
layerVisibleRegion
nullptr
lm
layers
)
;
SetScrollableFrameMetrics
(
layers
[
0
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
+
1
)
;
SetScrollHandoff
(
layers
[
1
]
layers
[
0
]
)
;
ModifyFrameMetrics
(
layers
[
aRootContentLayerIndex
]
[
]
(
ScrollMetadata
&
sm
FrameMetrics
&
fm
)
{
fm
.
SetIsRootContent
(
true
)
;
}
)
;
EventRegions
regions
;
regions
.
mHitRegion
=
nsIntRegion
(
IntRect
(
0
0
100
100
)
)
;
regions
.
mDispatchToContentHitRegion
=
regions
.
mHitRegion
;
layers
[
0
]
-
>
SetEventRegions
(
regions
)
;
layers
[
1
]
-
>
SetEventRegions
(
regions
)
;
}
}
;
TEST_F
(
APZCTreeManagerGenericTester
ScrollablePaintedLayers
)
{
CreateSimpleMultiLayerTree
(
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
root
mcc
)
;
auto
&
layers
=
scrollData
;
SetScrollableFrameMetrics
(
layers
[
1
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
ScrollableLayerGuid
:
:
START_SCROLL_ID
)
;
UpdateHitTestingTree
(
)
;
TestAsyncPanZoomController
*
nullAPZC
=
nullptr
;
EXPECT_FALSE
(
HasScrollableFrameMetrics
(
layers
[
0
]
)
)
;
EXPECT_NE
(
nullAPZC
ApzcOf
(
layers
[
1
]
)
)
;
EXPECT_NE
(
nullAPZC
ApzcOf
(
layers
[
2
]
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
1
]
)
ApzcOf
(
layers
[
2
]
)
)
;
}
TEST_F
(
APZCTreeManagerGenericTester
Bug1068268
)
{
CreatePotentiallyLeakingTree
(
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
RefPtr
<
HitTestingTreeNode
>
root
=
manager
-
>
GetRootNode
(
)
;
RefPtr
<
HitTestingTreeNode
>
node2
=
root
-
>
GetFirstChild
(
)
-
>
GetFirstChild
(
)
;
RefPtr
<
HitTestingTreeNode
>
node5
=
root
-
>
GetLastChild
(
)
-
>
GetLastChild
(
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
node5
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
node2
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
0
]
)
ApzcOf
(
layers
[
2
]
)
-
>
GetParent
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
ApzcOf
(
layers
[
5
]
)
)
;
EXPECT_EQ
(
node2
-
>
GetFirstChild
(
)
node2
-
>
GetLastChild
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
3
]
)
node2
-
>
GetLastChild
(
)
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
node5
-
>
GetFirstChild
(
)
node5
-
>
GetLastChild
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
6
]
)
node5
-
>
GetLastChild
(
)
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
ApzcOf
(
layers
[
3
]
)
-
>
GetParent
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
5
]
)
ApzcOf
(
layers
[
6
]
)
-
>
GetParent
(
)
)
;
}
TEST_F
(
APZCTreeManagerGenericTester
Bug1194876
)
{
CreateTwoLayerDTCTree
(
1
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
uint64_t
blockId
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
MultiTouchInput
mti
;
mti
=
CreateMultiTouchInput
(
MultiTouchInput
:
:
MULTITOUCH_START
mcc
-
>
Time
(
)
)
;
mti
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ParentLayerPoint
(
25
50
)
ScreenSize
(
0
0
)
0
0
)
)
;
blockId
=
manager
-
>
ReceiveInputEvent
(
mti
)
.
mInputBlockId
;
manager
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
targets
.
AppendElement
(
ApzcOf
(
layers
[
0
]
)
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
blockId
targets
)
;
mti
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ParentLayerPoint
(
75
50
)
ScreenSize
(
0
0
)
0
0
)
)
;
blockId
=
manager
-
>
ReceiveInputEvent
(
mti
)
.
mInputBlockId
;
manager
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
targets
.
AppendElement
(
ApzcOf
(
layers
[
0
]
)
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
blockId
targets
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eLongTap
_
_
_
_
)
)
.
Times
(
0
)
;
}
TEST_F
(
APZCTreeManagerGenericTester
TargetChangesMidGesture_Bug1570559
)
{
CreateTwoLayerDTCTree
(
0
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
uint64_t
blockId
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
MultiTouchInput
mti
=
CreateMultiTouchInput
(
MultiTouchInput
:
:
MULTITOUCH_START
mcc
-
>
Time
(
)
)
;
mti
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ParentLayerPoint
(
25
50
)
ScreenSize
(
0
0
)
0
0
)
)
;
blockId
=
manager
-
>
ReceiveInputEvent
(
mti
)
.
mInputBlockId
;
manager
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
targets
.
AppendElement
(
ApzcOf
(
layers
[
1
]
)
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
blockId
targets
)
;
mti
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ParentLayerPoint
(
75
50
)
ScreenSize
(
0
0
)
0
0
)
)
;
blockId
=
manager
-
>
ReceiveInputEvent
(
mti
)
.
mInputBlockId
;
manager
-
>
ContentReceivedInputBlock
(
blockId
true
)
;
targets
.
AppendElement
(
ApzcOf
(
layers
[
1
]
)
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
blockId
targets
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eLongTap
_
_
_
_
)
)
.
Times
(
0
)
;
}
TEST_F
(
APZCTreeManagerGenericTester
Bug1198900
)
{
CreateSimpleDTCScrollingLayer
(
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
root
mcc
)
;
UpdateHitTestingTree
(
)
;
ScreenPoint
origin
(
100
50
)
;
ScrollWheelInput
swi
(
MillisecondsSinceStartup
(
mcc
-
>
Time
(
)
)
mcc
-
>
Time
(
)
0
ScrollWheelInput
:
:
SCROLLMODE_INSTANT
ScrollWheelInput
:
:
SCROLLDELTA_PIXEL
origin
0
10
false
WheelDeltaAdjustmentStrategy
:
:
eNone
)
;
uint64_t
blockId
;
blockId
=
manager
-
>
ReceiveInputEvent
(
swi
)
.
mInputBlockId
;
manager
-
>
ContentReceivedInputBlock
(
blockId
true
)
;
}
TEST_F
(
APZCTreeManagerTester
Bug1551582
)
{
CreateSimpleScrollingLayer
(
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
WebRenderLayerScrollData
*
root
=
scrollData
[
0
]
;
ModifyFrameMetrics
(
root
[
]
(
ScrollMetadata
&
aSm
FrameMetrics
&
aMetrics
)
{
aMetrics
.
SetLayoutScrollOffset
(
CSSPoint
(
300
300
)
)
;
nsTArray
<
ScrollPositionUpdate
>
scrollUpdates
;
scrollUpdates
.
AppendElement
(
ScrollPositionUpdate
:
:
NewScroll
(
ScrollOrigin
:
:
Other
CSSPoint
:
:
ToAppUnits
(
CSSPoint
(
300
300
)
)
)
)
;
aSm
.
SetScrollUpdates
(
scrollUpdates
)
;
aMetrics
.
SetScrollGeneration
(
scrollUpdates
.
LastElement
(
)
.
GetGeneration
(
)
)
;
}
)
;
UpdateHitTestingTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
apzc
=
ApzcOf
(
root
)
;
CSSPoint
compositedScrollOffset
=
apzc
-
>
GetCompositedScrollOffset
(
)
;
EXPECT_EQ
(
CSSPoint
(
300
300
)
compositedScrollOffset
)
;
ModifyFrameMetrics
(
root
[
]
(
ScrollMetadata
&
aSm
FrameMetrics
&
aMetrics
)
{
aMetrics
.
SetScrollableRect
(
CSSRect
(
0
0
400
400
)
)
;
}
)
;
UpdateHitTestingTree
(
)
;
compositedScrollOffset
=
apzc
-
>
GetCompositedScrollOffset
(
)
;
EXPECT_EQ
(
CSSPoint
(
200
200
)
compositedScrollOffset
)
;
}
TEST_F
(
APZCTreeManagerTester
Bug1557424
)
{
CreateSimpleScrollingLayer
(
)
;
ScopedLayerTreeRegistration
registration
(
LayersId
{
0
}
mcc
)
;
UpdateHitTestingTree
(
)
;
WebRenderLayerScrollData
*
root
=
scrollData
[
0
]
;
ModifyFrameMetrics
(
root
[
]
(
ScrollMetadata
&
aSm
FrameMetrics
&
aMetrics
)
{
aMetrics
.
SetLayoutScrollOffset
(
CSSPoint
(
300
300
)
)
;
nsTArray
<
ScrollPositionUpdate
>
scrollUpdates
;
scrollUpdates
.
AppendElement
(
ScrollPositionUpdate
:
:
NewScroll
(
ScrollOrigin
:
:
Other
CSSPoint
:
:
ToAppUnits
(
CSSPoint
(
300
300
)
)
)
)
;
aSm
.
SetScrollUpdates
(
scrollUpdates
)
;
aMetrics
.
SetScrollGeneration
(
scrollUpdates
.
LastElement
(
)
.
GetGeneration
(
)
)
;
}
)
;
UpdateHitTestingTree
(
)
;
RefPtr
<
TestAsyncPanZoomController
>
apzc
=
ApzcOf
(
root
)
;
CSSPoint
compositedScrollOffset
=
apzc
-
>
GetCompositedScrollOffset
(
)
;
EXPECT_EQ
(
CSSPoint
(
300
300
)
compositedScrollOffset
)
;
ModifyFrameMetrics
(
root
[
]
(
ScrollMetadata
&
aSm
FrameMetrics
&
aMetrics
)
{
aMetrics
.
SetCompositionBounds
(
ParentLayerRect
(
0
0
300
300
)
)
;
}
)
;
UpdateHitTestingTree
(
)
;
compositedScrollOffset
=
apzc
-
>
GetCompositedScrollOffset
(
)
;
EXPECT_EQ
(
CSSPoint
(
200
200
)
compositedScrollOffset
)
;
}
