#
include
"
APZCTreeManagerTester
.
h
"
#
include
"
APZTestCommon
.
h
"
#
include
"
InputUtils
.
h
"
TEST_F
(
APZCTreeManagerTester
ScrollablePaintedLayers
)
{
CreateSimpleMultiLayerTree
(
)
;
ScopedLayerTreeRegistration
registration
(
manager
0
root
mcc
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
FrameMetrics
:
:
START_SCROLL_ID
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
TestAsyncPanZoomController
*
nullAPZC
=
nullptr
;
EXPECT_FALSE
(
layers
[
0
]
-
>
HasScrollableFrameMetrics
(
)
)
;
EXPECT_NE
(
nullAPZC
ApzcOf
(
layers
[
1
]
)
)
;
EXPECT_NE
(
nullAPZC
ApzcOf
(
layers
[
2
]
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
1
]
)
ApzcOf
(
layers
[
2
]
)
)
;
SetScrollableFrameMetrics
(
layers
[
1
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
EXPECT_NE
(
ApzcOf
(
layers
[
1
]
)
ApzcOf
(
layers
[
2
]
)
)
;
SetScrollableFrameMetrics
(
layers
[
2
]
FrameMetrics
:
:
START_SCROLL_ID
+
1
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
1
]
)
ApzcOf
(
layers
[
2
]
)
)
;
}
TEST_F
(
APZCTreeManagerTester
Bug1068268
)
{
CreatePotentiallyLeakingTree
(
)
;
ScopedLayerTreeRegistration
registration
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
RefPtr
<
HitTestingTreeNode
>
root
=
manager
-
>
GetRootNode
(
)
;
RefPtr
<
HitTestingTreeNode
>
node2
=
root
-
>
GetFirstChild
(
)
-
>
GetFirstChild
(
)
;
RefPtr
<
HitTestingTreeNode
>
node5
=
root
-
>
GetLastChild
(
)
-
>
GetLastChild
(
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
node5
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
node2
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
0
]
)
ApzcOf
(
layers
[
2
]
)
-
>
GetParent
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
ApzcOf
(
layers
[
5
]
)
)
;
EXPECT_EQ
(
node2
-
>
GetFirstChild
(
)
node2
-
>
GetLastChild
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
3
]
)
node2
-
>
GetLastChild
(
)
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
node5
-
>
GetFirstChild
(
)
node5
-
>
GetLastChild
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
6
]
)
node5
-
>
GetLastChild
(
)
-
>
GetApzc
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
2
]
)
ApzcOf
(
layers
[
3
]
)
-
>
GetParent
(
)
)
;
EXPECT_EQ
(
ApzcOf
(
layers
[
5
]
)
ApzcOf
(
layers
[
6
]
)
-
>
GetParent
(
)
)
;
}
TEST_F
(
APZCTreeManagerTester
Bug1194876
)
{
CreateBug1194876Tree
(
)
;
ScopedLayerTreeRegistration
registration
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
uint64_t
blockId
;
nsTArray
<
ScrollableLayerGuid
>
targets
;
MultiTouchInput
mti
;
mti
=
CreateMultiTouchInput
(
MultiTouchInput
:
:
MULTITOUCH_START
mcc
-
>
Time
(
)
)
;
mti
.
mTouches
.
AppendElement
(
SingleTouchData
(
0
ParentLayerPoint
(
25
50
)
ScreenSize
(
0
0
)
0
0
)
)
;
manager
-
>
ReceiveInputEvent
(
mti
nullptr
&
blockId
)
;
manager
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
targets
.
AppendElement
(
ApzcOf
(
layers
[
0
]
)
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
blockId
targets
)
;
mti
.
mTouches
.
AppendElement
(
SingleTouchData
(
1
ParentLayerPoint
(
75
50
)
ScreenSize
(
0
0
)
0
0
)
)
;
manager
-
>
ReceiveInputEvent
(
mti
nullptr
&
blockId
)
;
manager
-
>
ContentReceivedInputBlock
(
blockId
false
)
;
targets
.
AppendElement
(
ApzcOf
(
layers
[
0
]
)
-
>
GetGuid
(
)
)
;
manager
-
>
SetTargetAPZC
(
blockId
targets
)
;
EXPECT_CALL
(
*
mcc
HandleTap
(
TapType
:
:
eLongTap
_
_
_
_
)
)
.
Times
(
0
)
;
}
TEST_F
(
APZCTreeManagerTester
Bug1198900
)
{
CreateSimpleDTCScrollingLayer
(
)
;
ScopedLayerTreeRegistration
registration
(
manager
0
root
mcc
)
;
manager
-
>
UpdateHitTestingTree
(
nullptr
root
false
0
0
)
;
ScreenPoint
origin
(
100
50
)
;
ScrollWheelInput
swi
(
MillisecondsSinceStartup
(
mcc
-
>
Time
(
)
)
mcc
-
>
Time
(
)
0
ScrollWheelInput
:
:
SCROLLMODE_INSTANT
ScrollWheelInput
:
:
SCROLLDELTA_PIXEL
origin
0
10
false
)
;
uint64_t
blockId
;
manager
-
>
ReceiveInputEvent
(
swi
nullptr
&
blockId
)
;
manager
-
>
ContentReceivedInputBlock
(
blockId
true
)
;
}
