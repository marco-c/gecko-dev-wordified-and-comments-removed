#
ifndef
GFX_VR_OSVR_H
#
define
GFX_VR_OSVR_H
#
include
"
nsTArray
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
mozilla
/
gfx
/
2D
.
h
"
#
include
"
mozilla
/
EnumeratedArray
.
h
"
#
include
"
VRDisplayHost
.
h
"
#
include
<
osvr
/
ClientKit
/
ClientKitC
.
h
>
#
include
<
osvr
/
ClientKit
/
DisplayC
.
h
>
namespace
mozilla
{
namespace
gfx
{
namespace
impl
{
class
VRDisplayOSVR
:
public
VRDisplayHost
{
public
:
VRHMDSensorState
GetSensorState
(
)
override
;
VRHMDSensorState
GetImmediateSensorState
(
)
override
;
void
ZeroSensor
(
)
override
;
protected
:
virtual
void
StartPresentation
(
)
override
;
virtual
void
StopPresentation
(
)
override
;
#
if
defined
(
XP_WIN
)
virtual
void
SubmitFrame
(
TextureSourceD3D11
*
aSource
const
IntSize
&
aSize
const
VRHMDSensorState
&
aSensorState
const
gfx
:
:
Rect
&
aLeftEyeRect
const
gfx
:
:
Rect
&
aRightEyeRect
)
override
;
#
endif
public
:
explicit
VRDisplayOSVR
(
OSVR_ClientContext
*
context
OSVR_ClientInterface
*
iface
OSVR_DisplayConfig
*
display
)
;
protected
:
virtual
~
VRDisplayOSVR
(
)
{
Destroy
(
)
;
MOZ_COUNT_DTOR_INHERITED
(
VRDisplayOSVR
VRDisplayHost
)
;
}
void
Destroy
(
)
;
OSVR_ClientContext
*
m_ctx
;
OSVR_ClientInterface
*
m_iface
;
OSVR_DisplayConfig
*
m_display
;
}
;
}
class
VRSystemManagerOSVR
:
public
VRSystemManager
{
public
:
static
already_AddRefed
<
VRSystemManagerOSVR
>
Create
(
)
;
virtual
bool
Init
(
)
override
;
virtual
void
Destroy
(
)
override
;
virtual
void
GetHMDs
(
nsTArray
<
RefPtr
<
VRDisplayHost
>
>
&
aHMDResult
)
override
;
virtual
void
HandleInput
(
)
override
;
virtual
void
GetControllers
(
nsTArray
<
RefPtr
<
VRControllerHost
>
>
&
aControllerResult
)
override
;
virtual
void
ScanForControllers
(
)
override
;
virtual
void
RemoveControllers
(
)
override
;
protected
:
VRSystemManagerOSVR
(
)
:
mOSVRInitialized
(
false
)
mClientContextInitialized
(
false
)
mDisplayConfigInitialized
(
false
)
mInterfaceInitialized
(
false
)
m_ctx
(
nullptr
)
m_iface
(
nullptr
)
m_display
(
nullptr
)
{
}
RefPtr
<
impl
:
:
VRDisplayOSVR
>
mHMDInfo
;
bool
mOSVRInitialized
;
bool
mClientContextInitialized
;
bool
mDisplayConfigInitialized
;
bool
mInterfaceInitialized
;
RefPtr
<
nsIThread
>
mOSVRThread
;
OSVR_ClientContext
m_ctx
;
OSVR_ClientInterface
m_iface
;
OSVR_DisplayConfig
m_display
;
private
:
virtual
void
HandleButtonPress
(
uint32_t
aControllerIdx
uint64_t
aButtonPressed
)
override
;
virtual
void
HandleAxisMove
(
uint32_t
aControllerIdx
uint32_t
aAxis
float
aValue
)
override
;
virtual
void
HandlePoseTracking
(
uint32_t
aControllerIdx
const
dom
:
:
GamepadPoseState
&
aPose
VRControllerHost
*
aController
)
override
;
void
CheckOSVRStatus
(
)
;
void
InitializeClientContext
(
)
;
void
InitializeDisplay
(
)
;
void
InitializeInterface
(
)
;
}
;
}
}
#
endif
