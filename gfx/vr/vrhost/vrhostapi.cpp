#
include
"
vrhostex
.
h
"
#
include
"
VRShMem
.
h
"
#
include
<
stdio
.
h
>
#
include
<
string
.
h
>
#
include
<
random
>
#
include
"
windows
.
h
"
class
VRWindowManager
{
public
:
HWND
GetHWND
(
uint32_t
nId
)
{
if
(
nId
=
=
nWindow
)
{
return
hWindow
;
}
else
{
return
nullptr
;
}
}
HANDLE
GetProc
(
uint32_t
nId
)
{
if
(
nId
=
=
nWindow
)
{
return
hProc
;
}
else
{
return
nullptr
;
}
}
uint32_t
SetHWND
(
HWND
hwnd
HANDLE
hproc
)
{
if
(
hWindow
=
=
nullptr
)
{
MOZ_ASSERT
(
hwnd
!
=
nullptr
&
&
hproc
!
=
nullptr
)
;
hWindow
=
hwnd
;
hProc
=
hproc
;
nWindow
=
GetRandomUInt
(
)
;
#
if
defined
(
DEBUG
)
&
&
defined
(
NIGHTLY_BUILD
)
printf
(
"
VRWindowManager
:
Storing
HWND
:
0x
%
p
as
ID
:
0x
%
X
\
n
"
hWindow
nWindow
)
;
#
endif
return
nWindow
;
}
else
{
return
-
1
;
}
}
uint32_t
GetRandomUInt
(
)
{
return
randomGenerator
(
)
;
}
static
VRWindowManager
*
GetManager
(
)
{
if
(
Instance
=
=
nullptr
)
{
Instance
=
new
VRWindowManager
(
)
;
}
return
Instance
;
}
private
:
static
VRWindowManager
*
Instance
;
uint32_t
nWindow
=
0
;
HWND
hWindow
=
nullptr
;
HANDLE
hProc
=
nullptr
;
std
:
:
random_device
randomGenerator
;
}
;
VRWindowManager
*
VRWindowManager
:
:
Instance
=
nullptr
;
struct
StartFirefoxParams
{
char
*
firefoxFolder
;
char
*
firefoxProfileFolder
;
HANDLE
hProcessFx
;
}
;
DWORD
StartFirefoxThreadProc
(
_In_
LPVOID
lpParameter
)
{
char
cmd
[
]
=
"
%
sfirefox
.
exe
-
wait
-
for
-
browser
-
profile
%
s
-
-
fxr
"
;
StartFirefoxParams
*
params
=
static_cast
<
StartFirefoxParams
*
>
(
lpParameter
)
;
char
cmdWithPath
[
MAX_PATH
+
MAX_PATH
]
=
{
0
}
;
int
err
=
sprintf_s
(
cmdWithPath
ARRAYSIZE
(
cmdWithPath
)
cmd
params
-
>
firefoxFolder
params
-
>
firefoxProfileFolder
)
;
if
(
err
!
=
-
1
)
{
PROCESS_INFORMATION
procFx
=
{
0
}
;
STARTUPINFO
startupInfoFx
=
{
0
}
;
#
if
defined
(
DEBUG
)
&
&
defined
(
NIGHTLY_BUILD
)
printf
(
"
Starting
Firefox
via
:
%
s
\
n
"
cmdWithPath
)
;
#
endif
bool
fCreateContentProc
=
:
:
CreateProcess
(
nullptr
cmdWithPath
nullptr
nullptr
TRUE
0
nullptr
nullptr
&
startupInfoFx
&
procFx
)
;
if
(
!
fCreateContentProc
)
{
printf
(
"
Failed
to
create
Firefox
process
"
)
;
}
params
-
>
hProcessFx
=
procFx
.
hProcess
;
}
return
0
;
}
void
CreateVRWindow
(
char
*
firefoxFolderPath
char
*
firefoxProfilePath
uint32_t
dxgiAdapterID
uint32_t
widthHost
uint32_t
heightHost
uint32_t
*
windowId
void
*
*
hTex
uint32_t
*
width
uint32_t
*
height
)
{
mozilla
:
:
gfx
:
:
VRWindowState
windowState
=
{
0
}
;
int
err
=
sprintf_s
(
windowState
.
signalName
ARRAYSIZE
(
windowState
.
signalName
)
"
fxr
:
:
CreateVRWindow
:
:
%
X
"
VRWindowManager
:
:
GetManager
(
)
-
>
GetRandomUInt
(
)
)
;
if
(
err
>
0
)
{
HANDLE
hEvent
=
:
:
CreateEventA
(
nullptr
TRUE
FALSE
windowState
.
signalName
)
;
if
(
hEvent
!
=
nullptr
)
{
mozilla
:
:
gfx
:
:
VRShMem
shmem
(
nullptr
true
false
)
;
shmem
.
CreateShMem
(
)
;
shmem
.
PushWindowState
(
windowState
)
;
StartFirefoxParams
fxParams
=
{
0
}
;
fxParams
.
firefoxFolder
=
firefoxFolderPath
;
fxParams
.
firefoxProfileFolder
=
firefoxProfilePath
;
DWORD
dwTid
=
0
;
HANDLE
hThreadFx
=
CreateThread
(
nullptr
0
StartFirefoxThreadProc
&
fxParams
0
&
dwTid
)
;
if
(
hThreadFx
!
=
nullptr
)
{
:
:
WaitForSingleObject
(
hEvent
INFINITE
)
;
shmem
.
PullWindowState
(
windowState
)
;
(
*
hTex
)
=
windowState
.
textureFx
;
(
*
windowId
)
=
VRWindowManager
:
:
GetManager
(
)
-
>
SetHWND
(
(
HWND
)
windowState
.
hwndFx
fxParams
.
hProcessFx
)
;
(
*
width
)
=
windowState
.
widthFx
;
(
*
height
)
=
windowState
.
heightFx
;
windowState
=
{
0
}
;
shmem
.
PushWindowState
(
windowState
)
;
}
else
{
}
shmem
.
CloseShMem
(
)
;
}
}
}
void
CloseVRWindow
(
uint32_t
nVRWindowID
bool
waitForTerminate
)
{
:
:
SendMessage
(
VRWindowManager
:
:
GetManager
(
)
-
>
GetHWND
(
nVRWindowID
)
WM_CLOSE
0
0
)
;
if
(
waitForTerminate
)
{
:
:
WaitForSingleObject
(
VRWindowManager
:
:
GetManager
(
)
-
>
GetProc
(
nVRWindowID
)
INFINITE
)
;
}
}
