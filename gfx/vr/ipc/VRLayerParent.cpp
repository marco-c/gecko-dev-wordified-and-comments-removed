#
include
"
VRLayerParent
.
h
"
#
include
"
mozilla
/
dom
/
WebGLParent
.
h
"
#
include
"
mozilla
/
layers
/
CompositorThread
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
SharedSurface
.
h
"
#
include
"
SurfaceTypes
.
h
"
namespace
mozilla
{
using
namespace
layers
;
namespace
gfx
{
VRLayerParent
:
:
VRLayerParent
(
uint32_t
aVRDisplayID
const
uint32_t
aGroup
)
:
mIPCOpen
(
true
)
mVRDisplayID
(
aVRDisplayID
)
mGroup
(
aGroup
)
{
}
VRLayerParent
:
:
~
VRLayerParent
(
)
{
MOZ_COUNT_DTOR
(
VRLayerParent
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
VRLayerParent
:
:
RecvDestroy
(
)
{
Destroy
(
)
;
return
IPC_OK
(
)
;
}
void
VRLayerParent
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
mIPCOpen
=
false
;
}
void
VRLayerParent
:
:
Destroy
(
)
{
if
(
mVRDisplayID
)
{
VRManager
*
vm
=
VRManager
:
:
Get
(
)
;
vm
-
>
RemoveLayer
(
this
)
;
mVRDisplayID
=
0
;
}
if
(
mIPCOpen
)
{
Unused
<
<
PVRLayerParent
:
:
Send__delete__
(
this
)
;
}
}
mozilla
:
:
ipc
:
:
IPCResult
VRLayerParent
:
:
RecvSubmitFrame
(
mozilla
:
:
dom
:
:
PWebGLParent
*
aPWebGLParent
const
uint64_t
&
aFrameId
const
uint64_t
&
aLastFrameId
const
gfx
:
:
Rect
&
aLeftEyeRect
const
gfx
:
:
Rect
&
aRightEyeRect
)
{
mLastFrameTexture
=
mThisFrameTexture
;
auto
webGLParent
=
static_cast
<
mozilla
:
:
dom
:
:
WebGLParent
*
>
(
aPWebGLParent
)
;
if
(
!
webGLParent
)
{
return
IPC_OK
(
)
;
}
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
!
mThisFrameTexture
|
|
aLastFrameId
=
=
mLastSubmittedFrameId
)
{
mThisFrameTexture
=
webGLParent
-
>
GetVRFrame
(
)
;
}
#
else
mThisFrameTexture
=
webGLParent
-
>
GetVRFrame
(
)
;
#
endif
if
(
!
mThisFrameTexture
)
{
return
IPC_OK
(
)
;
}
gl
:
:
SharedSurface
*
surf
=
mThisFrameTexture
-
>
Surf
(
)
;
if
(
surf
-
>
mType
=
=
gl
:
:
SharedSurfaceType
:
:
Basic
)
{
gfxCriticalError
(
)
<
<
"
SharedSurfaceType
:
:
Basic
not
supported
for
WebVR
"
;
return
IPC_OK
(
)
;
}
layers
:
:
SurfaceDescriptor
desc
;
if
(
!
surf
-
>
ToSurfaceDescriptor
(
&
desc
)
)
{
gfxCriticalError
(
)
<
<
"
SharedSurface
:
:
ToSurfaceDescriptor
failed
in
"
"
VRLayerParent
:
:
SubmitFrame
"
;
return
IPC_OK
(
)
;
}
if
(
mVRDisplayID
)
{
VRManager
*
vm
=
VRManager
:
:
Get
(
)
;
vm
-
>
SubmitFrame
(
this
desc
aFrameId
aLeftEyeRect
aRightEyeRect
)
;
}
return
IPC_OK
(
)
;
}
mozilla
:
:
ipc
:
:
IPCResult
VRLayerParent
:
:
RecvClearSurfaces
(
)
{
mThisFrameTexture
=
nullptr
;
mLastFrameTexture
=
nullptr
;
return
IPC_OK
(
)
;
}
}
}
