#
include
"
VRGPUChild
.
h
"
#
include
"
mozilla
/
layers
/
CompositorThread
.
h
"
namespace
mozilla
{
namespace
gfx
{
static
StaticRefPtr
<
VRGPUChild
>
sVRGPUChildSingleton
;
bool
VRGPUChild
:
:
InitForGPUProcess
(
Endpoint
<
PVRGPUChild
>
&
&
aEndpoint
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
!
sVRGPUChildSingleton
)
;
RefPtr
<
VRGPUChild
>
child
(
new
VRGPUChild
(
)
)
;
if
(
!
aEndpoint
.
Bind
(
child
)
)
{
return
false
;
}
sVRGPUChildSingleton
=
child
;
RefPtr
<
Runnable
>
task
=
NS_NewRunnableFunction
(
"
VRGPUChild
:
:
SendStartVRService
"
[
]
(
)
-
>
void
{
VRGPUChild
*
vrGPUChild
=
VRGPUChild
:
:
Get
(
)
;
vrGPUChild
-
>
SendStartVRService
(
)
;
}
)
;
NS_DispatchToMainThread
(
task
.
forget
(
)
)
;
return
true
;
}
bool
VRGPUChild
:
:
IsCreated
(
)
{
return
!
!
sVRGPUChildSingleton
;
}
VRGPUChild
*
VRGPUChild
:
:
Get
(
)
{
MOZ_ASSERT
(
IsCreated
(
)
"
VRGPUChild
haven
'
t
initialized
yet
.
"
)
;
return
sVRGPUChildSingleton
;
}
void
VRGPUChild
:
:
Shutdown
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
if
(
sVRGPUChildSingleton
&
&
!
sVRGPUChildSingleton
-
>
IsClosed
(
)
)
{
sVRGPUChildSingleton
-
>
Close
(
)
;
}
sVRGPUChildSingleton
=
nullptr
;
}
void
VRGPUChild
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
VRManager
*
vm
=
VRManager
:
:
Get
(
)
;
mozilla
:
:
layers
:
:
CompositorThreadHolder
:
:
Loop
(
)
-
>
PostTask
(
NewRunnableMethod
(
"
VRGPUChild
:
:
ActorDestroy
"
vm
&
VRManager
:
:
Shutdown
)
)
;
mClosed
=
true
;
}
bool
VRGPUChild
:
:
IsClosed
(
)
{
return
mClosed
;
}
}
}
