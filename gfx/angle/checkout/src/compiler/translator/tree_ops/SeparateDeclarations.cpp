#
include
"
compiler
/
translator
/
tree_ops
/
SeparateDeclarations
.
h
"
#
include
"
compiler
/
translator
/
tree_util
/
IntermTraverse
.
h
"
namespace
sh
{
namespace
{
class
SeparateDeclarationsTraverser
:
private
TIntermTraverser
{
public
:
ANGLE_NO_DISCARD
static
bool
apply
(
TCompiler
*
compiler
TIntermNode
*
root
)
;
private
:
SeparateDeclarationsTraverser
(
)
;
bool
visitDeclaration
(
Visit
TIntermDeclaration
*
node
)
override
;
}
;
bool
SeparateDeclarationsTraverser
:
:
apply
(
TCompiler
*
compiler
TIntermNode
*
root
)
{
SeparateDeclarationsTraverser
separateDecl
;
root
-
>
traverse
(
&
separateDecl
)
;
return
separateDecl
.
updateTree
(
compiler
root
)
;
}
SeparateDeclarationsTraverser
:
:
SeparateDeclarationsTraverser
(
)
:
TIntermTraverser
(
true
false
false
)
{
}
bool
SeparateDeclarationsTraverser
:
:
visitDeclaration
(
Visit
TIntermDeclaration
*
node
)
{
TIntermSequence
*
sequence
=
node
-
>
getSequence
(
)
;
if
(
sequence
-
>
size
(
)
>
1
)
{
TIntermBlock
*
parentBlock
=
getParentNode
(
)
-
>
getAsBlock
(
)
;
ASSERT
(
parentBlock
!
=
nullptr
)
;
TIntermSequence
replacementDeclarations
;
for
(
size_t
ii
=
0
;
ii
<
sequence
-
>
size
(
)
;
+
+
ii
)
{
TIntermDeclaration
*
replacementDeclaration
=
new
TIntermDeclaration
(
)
;
replacementDeclaration
-
>
appendDeclarator
(
sequence
-
>
at
(
ii
)
-
>
getAsTyped
(
)
)
;
replacementDeclaration
-
>
setLine
(
sequence
-
>
at
(
ii
)
-
>
getLine
(
)
)
;
replacementDeclarations
.
push_back
(
replacementDeclaration
)
;
}
mMultiReplacements
.
emplace_back
(
parentBlock
node
std
:
:
move
(
replacementDeclarations
)
)
;
}
return
false
;
}
}
bool
SeparateDeclarations
(
TCompiler
*
compiler
TIntermNode
*
root
)
{
return
SeparateDeclarationsTraverser
:
:
apply
(
compiler
root
)
;
}
}
