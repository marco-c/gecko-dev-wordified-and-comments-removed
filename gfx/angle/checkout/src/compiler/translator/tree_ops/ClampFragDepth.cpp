#
include
"
compiler
/
translator
/
tree_ops
/
ClampFragDepth
.
h
"
#
include
"
compiler
/
translator
/
ImmutableString
.
h
"
#
include
"
compiler
/
translator
/
SymbolTable
.
h
"
#
include
"
compiler
/
translator
/
tree_util
/
BuiltIn_autogen
.
h
"
#
include
"
compiler
/
translator
/
tree_util
/
FindSymbolNode
.
h
"
#
include
"
compiler
/
translator
/
tree_util
/
IntermNode_util
.
h
"
#
include
"
compiler
/
translator
/
tree_util
/
RunAtTheEndOfShader
.
h
"
namespace
sh
{
void
ClampFragDepth
(
TIntermBlock
*
root
TSymbolTable
*
symbolTable
)
{
if
(
!
FindSymbolNode
(
root
ImmutableString
(
"
gl_FragDepth
"
)
)
)
{
return
;
}
TIntermSymbol
*
fragDepthNode
=
new
TIntermSymbol
(
BuiltInVariable
:
:
gl_FragDepth
(
)
)
;
TIntermTyped
*
minFragDepthNode
=
CreateZeroNode
(
TType
(
EbtFloat
EbpHigh
EvqConst
)
)
;
TConstantUnion
*
maxFragDepthConstant
=
new
TConstantUnion
(
)
;
maxFragDepthConstant
-
>
setFConst
(
1
.
0
)
;
TIntermConstantUnion
*
maxFragDepthNode
=
new
TIntermConstantUnion
(
maxFragDepthConstant
TType
(
EbtFloat
EbpHigh
EvqConst
)
)
;
TIntermSequence
*
clampArguments
=
new
TIntermSequence
(
)
;
clampArguments
-
>
push_back
(
fragDepthNode
-
>
deepCopy
(
)
)
;
clampArguments
-
>
push_back
(
minFragDepthNode
)
;
clampArguments
-
>
push_back
(
maxFragDepthNode
)
;
TIntermTyped
*
clampedFragDepth
=
CreateBuiltInFunctionCallNode
(
"
clamp
"
clampArguments
*
symbolTable
100
)
;
TIntermBinary
*
assignFragDepth
=
new
TIntermBinary
(
EOpAssign
fragDepthNode
clampedFragDepth
)
;
RunAtTheEndOfShader
(
root
assignFragDepth
symbolTable
)
;
}
}
