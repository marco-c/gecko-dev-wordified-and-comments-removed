#
ifndef
COMPILER_TRANSLATOR_COMPILER_H_
#
define
COMPILER_TRANSLATOR_COMPILER_H_
#
include
<
GLSLANG
/
ShaderVars
.
h
>
#
include
"
common
/
PackedEnums
.
h
"
#
include
"
compiler
/
translator
/
BuiltInFunctionEmulator
.
h
"
#
include
"
compiler
/
translator
/
CallDAG
.
h
"
#
include
"
compiler
/
translator
/
Diagnostics
.
h
"
#
include
"
compiler
/
translator
/
ExtensionBehavior
.
h
"
#
include
"
compiler
/
translator
/
HashNames
.
h
"
#
include
"
compiler
/
translator
/
InfoSink
.
h
"
#
include
"
compiler
/
translator
/
Pragma
.
h
"
#
include
"
compiler
/
translator
/
SymbolTable
.
h
"
#
include
"
compiler
/
translator
/
ValidateAST
.
h
"
namespace
sh
{
class
TCompiler
;
class
TParseContext
;
#
ifdef
ANGLE_ENABLE_HLSL
class
TranslatorHLSL
;
#
endif
#
ifdef
ANGLE_ENABLE_METAL
class
TranslatorMetalDirect
;
#
endif
using
SpecConstUsageBits
=
angle
:
:
PackedEnumBitSet
<
vk
:
:
SpecConstUsage
uint32_t
>
;
bool
IsGLSL130OrNewer
(
ShShaderOutput
output
)
;
bool
IsGLSL420OrNewer
(
ShShaderOutput
output
)
;
bool
IsGLSL410OrOlder
(
ShShaderOutput
output
)
;
bool
RemoveInvariant
(
sh
:
:
GLenum
shaderType
int
shaderVersion
ShShaderOutput
outputType
const
ShCompileOptions
&
compileOptions
)
;
class
TShHandleBase
{
public
:
TShHandleBase
(
)
;
virtual
~
TShHandleBase
(
)
;
virtual
TCompiler
*
getAsCompiler
(
)
{
return
0
;
}
#
ifdef
ANGLE_ENABLE_HLSL
virtual
TranslatorHLSL
*
getAsTranslatorHLSL
(
)
{
return
0
;
}
#
endif
#
ifdef
ANGLE_ENABLE_METAL
virtual
TranslatorMetalDirect
*
getAsTranslatorMetalDirect
(
)
{
return
nullptr
;
}
#
endif
protected
:
angle
:
:
PoolAllocator
allocator
;
}
;
struct
TFunctionMetadata
{
bool
used
=
false
;
}
;
class
TCompiler
:
public
TShHandleBase
{
public
:
TCompiler
(
sh
:
:
GLenum
type
ShShaderSpec
spec
ShShaderOutput
output
)
;
~
TCompiler
(
)
override
;
TCompiler
*
getAsCompiler
(
)
override
{
return
this
;
}
bool
Init
(
const
ShBuiltInResources
&
resources
)
;
TIntermBlock
*
compileTreeForTesting
(
const
char
*
const
shaderStrings
[
]
size_t
numStrings
const
ShCompileOptions
&
compileOptions
)
;
bool
compile
(
const
char
*
const
shaderStrings
[
]
size_t
numStrings
const
ShCompileOptions
&
compileOptions
)
;
int
getShaderVersion
(
)
const
{
return
mShaderVersion
;
}
TInfoSink
&
getInfoSink
(
)
{
return
mInfoSink
;
}
bool
specifyEarlyFragmentTests
(
)
{
return
mEarlyFragmentTestsSpecified
=
true
;
}
bool
isEarlyFragmentTestsSpecified
(
)
const
{
return
mEarlyFragmentTestsSpecified
;
}
bool
hasDiscard
(
)
const
{
return
mHasDiscard
;
}
bool
enablesPerSampleShading
(
)
const
{
return
mEnablesPerSampleShading
;
}
SpecConstUsageBits
getSpecConstUsageBits
(
)
const
{
return
mSpecConstUsageBits
;
}
bool
isComputeShaderLocalSizeDeclared
(
)
const
{
return
mComputeShaderLocalSizeDeclared
;
}
const
sh
:
:
WorkGroupSize
&
getComputeShaderLocalSize
(
)
const
{
return
mComputeShaderLocalSize
;
}
int
getNumViews
(
)
const
{
return
mNumViews
;
}
void
clearResults
(
)
;
const
std
:
:
vector
<
sh
:
:
ShaderVariable
>
&
getAttributes
(
)
const
{
return
mAttributes
;
}
const
std
:
:
vector
<
sh
:
:
ShaderVariable
>
&
getOutputVariables
(
)
const
{
return
mOutputVariables
;
}
const
std
:
:
vector
<
sh
:
:
ShaderVariable
>
&
getUniforms
(
)
const
{
return
mUniforms
;
}
const
std
:
:
vector
<
sh
:
:
ShaderVariable
>
&
getInputVaryings
(
)
const
{
return
mInputVaryings
;
}
const
std
:
:
vector
<
sh
:
:
ShaderVariable
>
&
getOutputVaryings
(
)
const
{
return
mOutputVaryings
;
}
const
std
:
:
vector
<
sh
:
:
InterfaceBlock
>
&
getInterfaceBlocks
(
)
const
{
return
mInterfaceBlocks
;
}
const
std
:
:
vector
<
sh
:
:
InterfaceBlock
>
&
getUniformBlocks
(
)
const
{
return
mUniformBlocks
;
}
const
std
:
:
vector
<
sh
:
:
InterfaceBlock
>
&
getShaderStorageBlocks
(
)
const
{
return
mShaderStorageBlocks
;
}
ShHashFunction64
getHashFunction
(
)
const
{
return
mResources
.
HashFunction
;
}
NameMap
&
getNameMap
(
)
{
return
mNameMap
;
}
TSymbolTable
&
getSymbolTable
(
)
{
return
mSymbolTable
;
}
ShShaderSpec
getShaderSpec
(
)
const
{
return
mShaderSpec
;
}
ShShaderOutput
getOutputType
(
)
const
{
return
mOutputType
;
}
ShBuiltInResources
getBuiltInResources
(
)
const
{
return
mResources
;
}
const
std
:
:
string
&
getBuiltInResourcesString
(
)
const
{
return
mBuiltInResourcesString
;
}
bool
isHighPrecisionSupported
(
)
const
;
bool
shouldRunLoopAndIndexingValidation
(
const
ShCompileOptions
&
compileOptions
)
const
;
bool
shouldLimitTypeSizes
(
)
const
;
const
ShBuiltInResources
&
getResources
(
)
const
;
const
TPragma
&
getPragma
(
)
const
{
return
mPragma
;
}
int
getGeometryShaderMaxVertices
(
)
const
{
return
mGeometryShaderMaxVertices
;
}
int
getGeometryShaderInvocations
(
)
const
{
return
mGeometryShaderInvocations
;
}
TLayoutPrimitiveType
getGeometryShaderInputPrimitiveType
(
)
const
{
return
mGeometryShaderInputPrimitiveType
;
}
TLayoutPrimitiveType
getGeometryShaderOutputPrimitiveType
(
)
const
{
return
mGeometryShaderOutputPrimitiveType
;
}
unsigned
int
getStructSize
(
const
ShaderVariable
&
var
)
const
;
int
getTessControlShaderOutputVertices
(
)
const
{
return
mTessControlShaderOutputVertices
;
}
TLayoutTessEvaluationType
getTessEvaluationShaderInputPrimitiveType
(
)
const
{
return
mTessEvaluationShaderInputPrimitiveType
;
}
TLayoutTessEvaluationType
getTessEvaluationShaderInputVertexSpacingType
(
)
const
{
return
mTessEvaluationShaderInputVertexSpacingType
;
}
TLayoutTessEvaluationType
getTessEvaluationShaderInputOrderingType
(
)
const
{
return
mTessEvaluationShaderInputOrderingType
;
}
TLayoutTessEvaluationType
getTessEvaluationShaderInputPointType
(
)
const
{
return
mTessEvaluationShaderInputPointType
;
}
bool
hasAnyPreciseType
(
)
const
{
return
mHasAnyPreciseType
;
}
AdvancedBlendEquations
getAdvancedBlendEquations
(
)
const
{
return
mAdvancedBlendEquations
;
}
bool
hasPixelLocalStorageUniforms
(
)
const
{
return
mHasPixelLocalStorageUniforms
;
}
unsigned
int
getSharedMemorySize
(
)
const
;
sh
:
:
GLenum
getShaderType
(
)
const
{
return
mShaderType
;
}
bool
validateAST
(
TIntermNode
*
root
)
;
bool
disableValidateFunctionCall
(
)
;
void
restoreValidateFunctionCall
(
bool
enable
)
;
bool
disableValidateVariableReferences
(
)
;
void
restoreValidateVariableReferences
(
bool
enable
)
;
void
enableValidateNoMoreTransformations
(
)
;
protected
:
virtual
void
initBuiltInFunctionEmulator
(
BuiltInFunctionEmulator
*
emu
const
ShCompileOptions
&
compileOptions
)
{
}
[
[
nodiscard
]
]
virtual
bool
translate
(
TIntermBlock
*
root
const
ShCompileOptions
&
compileOptions
PerformanceDiagnostics
*
perfDiagnostics
)
=
0
;
const
TExtensionBehavior
&
getExtensionBehavior
(
)
const
;
const
char
*
getSourcePath
(
)
const
;
bool
isVaryingDefined
(
const
char
*
varyingName
)
;
const
BuiltInFunctionEmulator
&
getBuiltInFunctionEmulator
(
)
const
;
virtual
bool
shouldFlattenPragmaStdglInvariantAll
(
)
=
0
;
virtual
bool
shouldCollectVariables
(
const
ShCompileOptions
&
compileOptions
)
;
bool
wereVariablesCollected
(
)
const
;
std
:
:
vector
<
sh
:
:
ShaderVariable
>
mAttributes
;
std
:
:
vector
<
sh
:
:
ShaderVariable
>
mOutputVariables
;
std
:
:
vector
<
sh
:
:
ShaderVariable
>
mUniforms
;
std
:
:
vector
<
sh
:
:
ShaderVariable
>
mInputVaryings
;
std
:
:
vector
<
sh
:
:
ShaderVariable
>
mOutputVaryings
;
std
:
:
vector
<
sh
:
:
ShaderVariable
>
mSharedVariables
;
std
:
:
vector
<
sh
:
:
InterfaceBlock
>
mInterfaceBlocks
;
std
:
:
vector
<
sh
:
:
InterfaceBlock
>
mUniformBlocks
;
std
:
:
vector
<
sh
:
:
InterfaceBlock
>
mShaderStorageBlocks
;
ValidateASTOptions
mValidateASTOptions
;
SpecConstUsageBits
mSpecConstUsageBits
;
private
:
bool
initBuiltInSymbolTable
(
const
ShBuiltInResources
&
resources
)
;
void
setResourceString
(
)
;
bool
checkCallDepth
(
)
;
[
[
nodiscard
]
]
bool
useAllMembersInUnusedStandardAndSharedBlocks
(
TIntermBlock
*
root
)
;
[
[
nodiscard
]
]
bool
initializeOutputVariables
(
TIntermBlock
*
root
)
;
[
[
nodiscard
]
]
bool
initializeGLPosition
(
TIntermBlock
*
root
)
;
bool
limitExpressionComplexity
(
TIntermBlock
*
root
)
;
bool
initCallDag
(
TIntermNode
*
root
)
;
bool
tagUsedFunctions
(
)
;
void
internalTagUsedFunction
(
size_t
index
)
;
void
collectInterfaceBlocks
(
)
;
bool
mVariablesCollected
;
bool
mGLPositionInitialized
;
bool
pruneUnusedFunctions
(
TIntermBlock
*
root
)
;
TIntermBlock
*
compileTreeImpl
(
const
char
*
const
shaderStrings
[
]
size_t
numStrings
const
ShCompileOptions
&
compileOptions
)
;
void
setASTMetadata
(
const
TParseContext
&
parseContext
)
;
bool
checkShaderVersion
(
TParseContext
*
parseContext
)
;
bool
checkAndSimplifyAST
(
TIntermBlock
*
root
const
TParseContext
&
parseContext
const
ShCompileOptions
&
compileOptions
)
;
bool
postParseChecks
(
const
TParseContext
&
parseContext
)
;
sh
:
:
GLenum
mShaderType
;
ShShaderSpec
mShaderSpec
;
ShShaderOutput
mOutputType
;
CallDAG
mCallDag
;
std
:
:
vector
<
TFunctionMetadata
>
mFunctionMetadata
;
ShBuiltInResources
mResources
;
std
:
:
string
mBuiltInResourcesString
;
TSymbolTable
mSymbolTable
;
TExtensionBehavior
mExtensionBehavior
;
BuiltInFunctionEmulator
mBuiltInFunctionEmulator
;
int
mShaderVersion
;
TInfoSink
mInfoSink
;
TDiagnostics
mDiagnostics
;
const
char
*
mSourcePath
;
bool
mEarlyFragmentTestsSpecified
;
bool
mHasDiscard
;
bool
mEnablesPerSampleShading
;
bool
mComputeShaderLocalSizeDeclared
;
sh
:
:
WorkGroupSize
mComputeShaderLocalSize
;
int
mNumViews
;
int
mGeometryShaderMaxVertices
;
int
mGeometryShaderInvocations
;
TLayoutPrimitiveType
mGeometryShaderInputPrimitiveType
;
TLayoutPrimitiveType
mGeometryShaderOutputPrimitiveType
;
int
mTessControlShaderOutputVertices
;
TLayoutTessEvaluationType
mTessEvaluationShaderInputPrimitiveType
;
TLayoutTessEvaluationType
mTessEvaluationShaderInputVertexSpacingType
;
TLayoutTessEvaluationType
mTessEvaluationShaderInputOrderingType
;
TLayoutTessEvaluationType
mTessEvaluationShaderInputPointType
;
bool
mHasAnyPreciseType
;
AdvancedBlendEquations
mAdvancedBlendEquations
;
bool
mHasPixelLocalStorageUniforms
;
NameMap
mNameMap
;
TPragma
mPragma
;
ShCompileOptions
mCompileOptions
;
}
;
TCompiler
*
ConstructCompiler
(
sh
:
:
GLenum
type
ShShaderSpec
spec
ShShaderOutput
output
)
;
void
DeleteCompiler
(
TCompiler
*
)
;
struct
ShaderDumpHeader
{
uint32_t
type
;
uint32_t
spec
;
uint32_t
output
;
uint8_t
basicCompileOptions
[
32
]
;
uint8_t
metalCompileOptions
[
32
]
;
uint8_t
plsCompileOptions
[
32
]
;
uint8_t
padding
[
20
]
;
}
;
static_assert
(
sizeof
(
ShaderDumpHeader
)
=
=
128
)
;
}
#
endif
