#
include
"
compiler
/
translator
/
RegenerateStructNames
.
h
"
#
include
"
common
/
debug
.
h
"
#
include
"
compiler
/
translator
/
ImmutableStringBuilder
.
h
"
namespace
sh
{
namespace
{
constexpr
const
ImmutableString
kPrefix
(
"
_webgl_struct_
"
)
;
}
void
RegenerateStructNames
:
:
visitSymbol
(
TIntermSymbol
*
symbol
)
{
ASSERT
(
symbol
)
;
const
TType
&
type
=
symbol
-
>
getType
(
)
;
const
TStructure
*
userType
=
type
.
getStruct
(
)
;
if
(
!
userType
)
return
;
if
(
userType
-
>
symbolType
(
)
=
=
SymbolType
:
:
BuiltIn
|
|
userType
-
>
symbolType
(
)
=
=
SymbolType
:
:
Empty
)
{
return
;
}
int
uniqueId
=
userType
-
>
uniqueId
(
)
.
get
(
)
;
ASSERT
(
mScopeDepth
>
0
)
;
if
(
mScopeDepth
=
=
1
)
{
mDeclaredGlobalStructs
.
insert
(
uniqueId
)
;
return
;
}
if
(
mDeclaredGlobalStructs
.
count
(
uniqueId
)
>
0
)
return
;
if
(
userType
-
>
name
(
)
.
beginsWith
(
kPrefix
)
)
{
return
;
}
ImmutableStringBuilder
tmp
(
kPrefix
.
length
(
)
+
sizeof
(
uniqueId
)
*
2u
+
1u
+
userType
-
>
name
(
)
.
length
(
)
)
;
tmp
<
<
kPrefix
;
tmp
.
appendHex
(
uniqueId
)
;
tmp
<
<
'
_
'
<
<
userType
-
>
name
(
)
;
const_cast
<
TStructure
*
>
(
userType
)
-
>
setName
(
tmp
)
;
}
bool
RegenerateStructNames
:
:
visitBlock
(
Visit
TIntermBlock
*
block
)
{
+
+
mScopeDepth
;
TIntermSequence
&
sequence
=
*
(
block
-
>
getSequence
(
)
)
;
for
(
TIntermNode
*
node
:
sequence
)
{
node
-
>
traverse
(
this
)
;
}
-
-
mScopeDepth
;
return
false
;
}
}
