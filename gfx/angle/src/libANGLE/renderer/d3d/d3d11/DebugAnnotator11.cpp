#
include
"
libANGLE
/
renderer
/
d3d
/
d3d11
/
DebugAnnotator11
.
h
"
#
include
"
common
/
debug
.
h
"
#
include
"
libANGLE
/
renderer
/
d3d
/
d3d11
/
renderer11_utils
.
h
"
namespace
rx
{
DebugAnnotator11
:
:
DebugAnnotator11
(
)
:
mInitialized
(
false
)
mD3d11Module
(
nullptr
)
mUserDefinedAnnotation
(
nullptr
)
{
}
DebugAnnotator11
:
:
~
DebugAnnotator11
(
)
{
if
(
mInitialized
)
{
SafeRelease
(
mUserDefinedAnnotation
)
;
#
if
!
defined
(
ANGLE_ENABLE_WINDOWS_STORE
)
FreeLibrary
(
mD3d11Module
)
;
#
endif
}
}
void
DebugAnnotator11
:
:
beginEvent
(
const
wchar_t
*
eventName
)
{
initializeDevice
(
)
;
mUserDefinedAnnotation
-
>
BeginEvent
(
eventName
)
;
}
void
DebugAnnotator11
:
:
endEvent
(
)
{
initializeDevice
(
)
;
mUserDefinedAnnotation
-
>
EndEvent
(
)
;
}
void
DebugAnnotator11
:
:
setMarker
(
const
wchar_t
*
markerName
)
{
initializeDevice
(
)
;
mUserDefinedAnnotation
-
>
SetMarker
(
markerName
)
;
}
bool
DebugAnnotator11
:
:
getStatus
(
)
{
static
bool
underCapture
=
true
;
#
if
defined
(
_DEBUG
)
&
&
defined
(
ANGLE_ENABLE_WINDOWS_STORE
)
static
bool
triedIDXGraphicsAnalysis
=
false
;
if
(
!
triedIDXGraphicsAnalysis
)
{
IDXGraphicsAnalysis
*
graphicsAnalysis
=
nullptr
;
HRESULT
result
=
DXGIGetDebugInterface1
(
0
IID_PPV_ARGS
(
&
graphicsAnalysis
)
)
;
if
(
SUCCEEDED
(
result
)
)
{
underCapture
=
(
graphicsAnalysis
!
=
nullptr
)
;
}
SafeRelease
(
graphicsAnalysis
)
;
triedIDXGraphicsAnalysis
=
true
;
}
#
endif
return
underCapture
;
}
void
DebugAnnotator11
:
:
initializeDevice
(
)
{
if
(
!
mInitialized
)
{
#
if
!
defined
(
ANGLE_ENABLE_WINDOWS_STORE
)
mD3d11Module
=
LoadLibrary
(
TEXT
(
"
d3d11
.
dll
"
)
)
;
ASSERT
(
mD3d11Module
)
;
PFN_D3D11_CREATE_DEVICE
D3D11CreateDevice
=
(
PFN_D3D11_CREATE_DEVICE
)
GetProcAddress
(
mD3d11Module
"
D3D11CreateDevice
"
)
;
ASSERT
(
D3D11CreateDevice
!
=
nullptr
)
;
#
endif
ID3D11Device
*
device
=
nullptr
;
ID3D11DeviceContext
*
context
=
nullptr
;
HRESULT
hr
=
E_FAIL
;
hr
=
D3D11CreateDevice
(
NULL
D3D_DRIVER_TYPE_NULL
nullptr
0
nullptr
0
D3D11_SDK_VERSION
&
device
nullptr
&
context
)
;
ASSERT
(
SUCCEEDED
(
hr
)
)
;
if
(
SUCCEEDED
(
hr
)
)
{
mUserDefinedAnnotation
=
d3d11
:
:
DynamicCastComObject
<
ID3DUserDefinedAnnotation
>
(
context
)
;
ASSERT
(
mUserDefinedAnnotation
!
=
nullptr
)
;
mInitialized
=
true
;
}
SafeRelease
(
device
)
;
SafeRelease
(
context
)
;
}
}
}
