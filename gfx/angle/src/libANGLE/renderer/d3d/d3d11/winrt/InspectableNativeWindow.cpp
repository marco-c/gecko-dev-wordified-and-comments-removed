#
include
"
libANGLE
/
renderer
/
d3d
/
d3d11
/
winrt
/
CoreWindowNativeWindow
.
h
"
#
include
"
libANGLE
/
renderer
/
d3d
/
d3d11
/
winrt
/
SwapChainPanelNativeWindow
.
h
"
namespace
rx
{
NativeWindow
:
:
NativeWindow
(
EGLNativeWindowType
window
)
{
mWindow
=
window
;
}
bool
NativeWindow
:
:
initialize
(
)
{
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
Collections
:
:
IPropertySet
>
propertySet
;
ComPtr
<
IInspectable
>
eglNativeWindow
;
if
(
IsEGLConfiguredPropertySet
(
mWindow
&
propertySet
&
eglNativeWindow
)
)
{
mWindow
=
eglNativeWindow
.
Get
(
)
;
}
ComPtr
<
ABI
:
:
Windows
:
:
UI
:
:
Core
:
:
ICoreWindow
>
coreWindow
;
ComPtr
<
ABI
:
:
Windows
:
:
UI
:
:
Xaml
:
:
Controls
:
:
ISwapChainPanel
>
swapChainPanel
;
if
(
IsCoreWindow
(
mWindow
&
coreWindow
)
)
{
mImpl
=
std
:
:
make_shared
<
CoreWindowNativeWindow
>
(
)
;
if
(
mImpl
)
{
return
mImpl
-
>
initialize
(
mWindow
propertySet
.
Get
(
)
)
;
}
}
else
if
(
IsSwapChainPanel
(
mWindow
&
swapChainPanel
)
)
{
mImpl
=
std
:
:
make_shared
<
SwapChainPanelNativeWindow
>
(
)
;
if
(
mImpl
)
{
return
mImpl
-
>
initialize
(
mWindow
propertySet
.
Get
(
)
)
;
}
}
else
{
ERR
(
"
Invalid
IInspectable
EGLNativeWindowType
detected
.
Valid
IInspectables
include
ICoreWindow
ISwapChainPanel
and
IPropertySet
"
)
;
}
return
false
;
}
bool
NativeWindow
:
:
getClientRect
(
RECT
*
rect
)
{
if
(
mImpl
)
{
return
mImpl
-
>
getClientRect
(
rect
)
;
}
return
false
;
}
bool
NativeWindow
:
:
isIconic
(
)
{
return
false
;
}
bool
NativeWindow
:
:
isValidNativeWindow
(
EGLNativeWindowType
window
)
{
return
IsValidEGLNativeWindowType
(
window
)
;
}
HRESULT
NativeWindow
:
:
createSwapChain
(
ID3D11Device
*
device
DXGIFactory
*
factory
DXGI_FORMAT
format
unsigned
int
width
unsigned
int
height
DXGISwapChain
*
*
swapChain
)
{
if
(
mImpl
)
{
return
mImpl
-
>
createSwapChain
(
device
factory
format
width
height
swapChain
)
;
}
return
E_UNEXPECTED
;
}
bool
IsCoreWindow
(
EGLNativeWindowType
window
ComPtr
<
ABI
:
:
Windows
:
:
UI
:
:
Core
:
:
ICoreWindow
>
*
coreWindow
)
{
if
(
!
window
)
{
return
false
;
}
ComPtr
<
IInspectable
>
win
=
window
;
ComPtr
<
ABI
:
:
Windows
:
:
UI
:
:
Core
:
:
ICoreWindow
>
coreWin
;
if
(
SUCCEEDED
(
win
.
As
(
&
coreWin
)
)
)
{
if
(
coreWindow
!
=
nullptr
)
{
*
coreWindow
=
coreWin
.
Detach
(
)
;
}
return
true
;
}
return
false
;
}
bool
IsSwapChainPanel
(
EGLNativeWindowType
window
ComPtr
<
ABI
:
:
Windows
:
:
UI
:
:
Xaml
:
:
Controls
:
:
ISwapChainPanel
>
*
swapChainPanel
)
{
if
(
!
window
)
{
return
false
;
}
ComPtr
<
IInspectable
>
win
=
window
;
ComPtr
<
ABI
:
:
Windows
:
:
UI
:
:
Xaml
:
:
Controls
:
:
ISwapChainPanel
>
panel
;
if
(
SUCCEEDED
(
win
.
As
(
&
panel
)
)
)
{
if
(
swapChainPanel
!
=
nullptr
)
{
*
swapChainPanel
=
panel
.
Detach
(
)
;
}
return
true
;
}
return
false
;
}
bool
IsEGLConfiguredPropertySet
(
EGLNativeWindowType
window
ABI
:
:
Windows
:
:
Foundation
:
:
Collections
:
:
IPropertySet
*
*
propertySet
IInspectable
*
*
eglNativeWindow
)
{
if
(
!
window
)
{
return
false
;
}
ComPtr
<
IInspectable
>
props
=
window
;
ComPtr
<
IPropertySet
>
propSet
;
ComPtr
<
IInspectable
>
nativeWindow
;
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
Collections
:
:
IMap
<
HSTRING
IInspectable
*
>
>
propMap
;
boolean
hasEglNativeWindowPropertyKey
=
false
;
HRESULT
result
=
props
.
As
(
&
propSet
)
;
if
(
SUCCEEDED
(
result
)
)
{
result
=
propSet
.
As
(
&
propMap
)
;
}
if
(
SUCCEEDED
(
result
)
)
{
result
=
propMap
-
>
HasKey
(
HStringReference
(
EGLNativeWindowTypeProperty
)
.
Get
(
)
&
hasEglNativeWindowPropertyKey
)
;
}
if
(
SUCCEEDED
(
result
)
&
&
!
hasEglNativeWindowPropertyKey
)
{
ERR
(
"
Could
not
find
EGLNativeWindowTypeProperty
in
IPropertySet
.
Valid
EGLNativeWindowTypeProperty
values
include
ICoreWindow
"
)
;
return
false
;
}
if
(
SUCCEEDED
(
result
)
&
&
hasEglNativeWindowPropertyKey
)
{
result
=
propMap
-
>
Lookup
(
HStringReference
(
EGLNativeWindowTypeProperty
)
.
Get
(
)
&
nativeWindow
)
;
}
if
(
SUCCEEDED
(
result
)
)
{
if
(
propertySet
!
=
nullptr
)
{
result
=
propSet
.
CopyTo
(
propertySet
)
;
}
}
if
(
SUCCEEDED
(
result
)
)
{
if
(
eglNativeWindow
!
=
nullptr
)
{
result
=
nativeWindow
.
CopyTo
(
eglNativeWindow
)
;
}
}
if
(
SUCCEEDED
(
result
)
)
{
return
true
;
}
return
false
;
}
bool
IsValidEGLNativeWindowType
(
EGLNativeWindowType
window
)
{
return
IsCoreWindow
(
window
)
|
|
IsSwapChainPanel
(
window
)
|
|
IsEGLConfiguredPropertySet
(
window
)
;
}
HRESULT
GetOptionalPropertyValue
(
const
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
Collections
:
:
IMap
<
HSTRING
IInspectable
*
>
>
&
propertyMap
const
wchar_t
*
propertyName
boolean
*
hasKey
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
IPropertyValue
>
&
propertyValue
)
{
if
(
!
propertyMap
|
|
!
hasKey
)
{
return
E_INVALIDARG
;
}
*
hasKey
=
false
;
HRESULT
result
=
propertyMap
-
>
HasKey
(
HStringReference
(
propertyName
)
.
Get
(
)
hasKey
)
;
if
(
SUCCEEDED
(
result
)
&
&
!
(
*
hasKey
)
)
{
return
S_OK
;
}
if
(
SUCCEEDED
(
result
)
)
{
result
=
propertyMap
-
>
Lookup
(
HStringReference
(
propertyName
)
.
Get
(
)
&
propertyValue
)
;
}
return
result
;
}
HRESULT
GetOptionalSizePropertyValue
(
const
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
Collections
:
:
IMap
<
HSTRING
IInspectable
*
>
>
&
propertyMap
const
wchar_t
*
propertyName
SIZE
*
value
bool
*
valueExists
)
{
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
IPropertyValue
>
propertyValue
;
ABI
:
:
Windows
:
:
Foundation
:
:
PropertyType
propertyType
=
ABI
:
:
Windows
:
:
Foundation
:
:
PropertyType
:
:
PropertyType_Empty
;
Size
sizeValue
=
{
0
0
}
;
boolean
hasKey
=
false
;
if
(
!
propertyMap
|
|
!
value
|
|
!
valueExists
)
{
return
E_INVALIDARG
;
}
*
valueExists
=
false
;
*
value
=
{
0
0
}
;
HRESULT
result
=
GetOptionalPropertyValue
(
propertyMap
propertyName
&
hasKey
propertyValue
)
;
if
(
SUCCEEDED
(
result
)
&
&
hasKey
)
{
result
=
propertyValue
-
>
get_Type
(
&
propertyType
)
;
if
(
SUCCEEDED
(
result
)
&
&
propertyType
=
=
ABI
:
:
Windows
:
:
Foundation
:
:
PropertyType
:
:
PropertyType_Size
)
{
if
(
SUCCEEDED
(
propertyValue
-
>
GetSize
(
&
sizeValue
)
)
&
&
(
sizeValue
.
Width
>
0
&
&
sizeValue
.
Height
>
0
)
)
{
*
value
=
{
static_cast
<
long
>
(
sizeValue
.
Width
)
static_cast
<
long
>
(
sizeValue
.
Height
)
}
;
*
valueExists
=
true
;
result
=
S_OK
;
}
else
{
result
=
E_INVALIDARG
;
}
}
else
{
result
=
E_INVALIDARG
;
}
}
return
result
;
}
HRESULT
GetOptionalSinglePropertyValue
(
const
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
Collections
:
:
IMap
<
HSTRING
IInspectable
*
>
>
&
propertyMap
const
wchar_t
*
propertyName
float
*
value
bool
*
valueExists
)
{
ComPtr
<
ABI
:
:
Windows
:
:
Foundation
:
:
IPropertyValue
>
propertyValue
;
ABI
:
:
Windows
:
:
Foundation
:
:
PropertyType
propertyType
=
ABI
:
:
Windows
:
:
Foundation
:
:
PropertyType
:
:
PropertyType_Empty
;
float
scaleValue
=
0
.
0f
;
boolean
hasKey
=
false
;
if
(
!
propertyMap
|
|
!
value
|
|
!
valueExists
)
{
return
E_INVALIDARG
;
}
*
valueExists
=
false
;
*
value
=
0
.
0f
;
HRESULT
result
=
GetOptionalPropertyValue
(
propertyMap
propertyName
&
hasKey
propertyValue
)
;
if
(
SUCCEEDED
(
result
)
&
&
hasKey
)
{
result
=
propertyValue
-
>
get_Type
(
&
propertyType
)
;
if
(
SUCCEEDED
(
result
)
&
&
propertyType
=
=
ABI
:
:
Windows
:
:
Foundation
:
:
PropertyType
:
:
PropertyType_Single
)
{
if
(
SUCCEEDED
(
propertyValue
-
>
GetSingle
(
&
scaleValue
)
)
&
&
(
scaleValue
>
0
.
0f
)
)
{
*
value
=
scaleValue
;
*
valueExists
=
true
;
result
=
S_OK
;
}
else
{
result
=
E_INVALIDARG
;
}
}
else
{
result
=
E_INVALIDARG
;
}
}
return
result
;
}
}
