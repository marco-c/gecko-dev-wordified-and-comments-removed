#
include
"
compiler
/
translator
/
DeclareAndInitBuiltinsForInstancedMultiview
.
h
"
#
include
"
compiler
/
translator
/
FindMain
.
h
"
#
include
"
compiler
/
translator
/
InitializeVariables
.
h
"
#
include
"
compiler
/
translator
/
IntermNode_util
.
h
"
#
include
"
compiler
/
translator
/
IntermTraverse
.
h
"
#
include
"
compiler
/
translator
/
SymbolTable
.
h
"
#
include
"
compiler
/
translator
/
util
.
h
"
namespace
sh
{
namespace
{
class
ReplaceVariableTraverser
:
public
TIntermTraverser
{
public
:
ReplaceVariableTraverser
(
const
TString
&
symbolName
TIntermSymbol
*
newSymbol
)
:
TIntermTraverser
(
true
false
false
)
mSymbolName
(
symbolName
)
mNewSymbol
(
newSymbol
)
{
}
void
visitSymbol
(
TIntermSymbol
*
node
)
override
{
TName
&
name
=
node
-
>
getName
(
)
;
if
(
name
.
getString
(
)
=
=
mSymbolName
)
{
queueReplacement
(
mNewSymbol
-
>
deepCopy
(
)
OriginalNode
:
:
IS_DROPPED
)
;
}
}
private
:
TString
mSymbolName
;
TIntermSymbol
*
mNewSymbol
;
}
;
TIntermSymbol
*
CreateGLInstanceIDSymbol
(
const
TSymbolTable
&
symbolTable
)
{
return
ReferenceBuiltInVariable
(
"
gl_InstanceID
"
symbolTable
300
)
;
}
void
InitializeViewIDAndInstanceID
(
TIntermTyped
*
viewIDSymbol
TIntermTyped
*
instanceIDSymbol
unsigned
numberOfViews
const
TSymbolTable
&
symbolTable
TIntermSequence
*
initializers
)
{
TConstantUnion
*
numberOfViewsUnsignedConstant
=
new
TConstantUnion
(
)
;
numberOfViewsUnsignedConstant
-
>
setUConst
(
numberOfViews
)
;
TIntermConstantUnion
*
numberOfViewsUint
=
new
TIntermConstantUnion
(
numberOfViewsUnsignedConstant
TType
(
EbtUInt
EbpHigh
EvqConst
)
)
;
TIntermSequence
*
glInstanceIDSymbolCastArguments
=
new
TIntermSequence
(
)
;
glInstanceIDSymbolCastArguments
-
>
push_back
(
CreateGLInstanceIDSymbol
(
symbolTable
)
)
;
TIntermAggregate
*
glInstanceIDAsUint
=
TIntermAggregate
:
:
CreateConstructor
(
TType
(
EbtUInt
EbpHigh
EvqTemporary
)
glInstanceIDSymbolCastArguments
)
;
TIntermBinary
*
normalizedInstanceID
=
new
TIntermBinary
(
EOpDiv
glInstanceIDAsUint
numberOfViewsUint
)
;
TIntermSequence
*
normalizedInstanceIDCastArguments
=
new
TIntermSequence
(
)
;
normalizedInstanceIDCastArguments
-
>
push_back
(
normalizedInstanceID
)
;
TIntermAggregate
*
normalizedInstanceIDAsInt
=
TIntermAggregate
:
:
CreateConstructor
(
TType
(
EbtInt
EbpHigh
EvqTemporary
)
normalizedInstanceIDCastArguments
)
;
TIntermBinary
*
instanceIDInitializer
=
new
TIntermBinary
(
EOpAssign
instanceIDSymbol
-
>
deepCopy
(
)
normalizedInstanceIDAsInt
)
;
initializers
-
>
push_back
(
instanceIDInitializer
)
;
TIntermBinary
*
normalizedViewID
=
new
TIntermBinary
(
EOpIMod
glInstanceIDAsUint
-
>
deepCopy
(
)
numberOfViewsUint
-
>
deepCopy
(
)
)
;
TIntermBinary
*
viewIDInitializer
=
new
TIntermBinary
(
EOpAssign
viewIDSymbol
-
>
deepCopy
(
)
normalizedViewID
)
;
initializers
-
>
push_back
(
viewIDInitializer
)
;
}
void
ReplaceSymbol
(
TIntermBlock
*
root
const
TString
&
symbolName
TIntermSymbol
*
newSymbolNode
)
{
ReplaceVariableTraverser
traverser
(
symbolName
newSymbolNode
)
;
root
-
>
traverse
(
&
traverser
)
;
traverser
.
updateTree
(
)
;
}
void
DeclareGlobalVariable
(
TIntermBlock
*
root
TIntermTyped
*
typedNode
)
{
TIntermSequence
*
globalSequence
=
root
-
>
getSequence
(
)
;
TIntermDeclaration
*
declaration
=
new
TIntermDeclaration
(
)
;
declaration
-
>
appendDeclarator
(
typedNode
-
>
deepCopy
(
)
)
;
globalSequence
-
>
insert
(
globalSequence
-
>
begin
(
)
declaration
)
;
}
void
SelectViewIndexInVertexShader
(
TIntermTyped
*
viewIDSymbol
TIntermTyped
*
multiviewBaseViewLayerIndexSymbol
TIntermSequence
*
initializers
const
TSymbolTable
&
symbolTable
)
{
TIntermSequence
*
viewIDSymbolCastArguments
=
new
TIntermSequence
(
)
;
viewIDSymbolCastArguments
-
>
push_back
(
viewIDSymbol
)
;
TIntermAggregate
*
viewIDAsInt
=
TIntermAggregate
:
:
CreateConstructor
(
TType
(
EbtInt
EbpHigh
EvqTemporary
)
viewIDSymbolCastArguments
)
;
TIntermSymbol
*
viewportIndexSymbol
=
ReferenceBuiltInVariable
(
"
gl_ViewportIndex
"
symbolTable
0
)
;
TIntermBlock
*
viewportIndexInitializerInBlock
=
new
TIntermBlock
(
)
;
viewportIndexInitializerInBlock
-
>
appendStatement
(
new
TIntermBinary
(
EOpAssign
viewportIndexSymbol
viewIDAsInt
)
)
;
TIntermSymbol
*
layerSymbol
=
new
TIntermSymbol
(
0
"
gl_Layer
"
TType
(
EbtInt
EbpHigh
EvqLayer
)
)
;
TIntermBinary
*
sumOfViewIDAndBaseViewIndex
=
new
TIntermBinary
(
EOpAdd
viewIDAsInt
-
>
deepCopy
(
)
multiviewBaseViewLayerIndexSymbol
)
;
TIntermBlock
*
layerInitializerInBlock
=
new
TIntermBlock
(
)
;
layerInitializerInBlock
-
>
appendStatement
(
new
TIntermBinary
(
EOpAssign
layerSymbol
sumOfViewIDAndBaseViewIndex
)
)
;
TIntermBinary
*
multiviewBaseViewLayerIndexZeroComparison
=
new
TIntermBinary
(
EOpLessThan
multiviewBaseViewLayerIndexSymbol
-
>
deepCopy
(
)
CreateZeroNode
(
TType
(
EbtInt
EbpHigh
EvqConst
)
)
)
;
TIntermIfElse
*
multiviewBranch
=
new
TIntermIfElse
(
multiviewBaseViewLayerIndexZeroComparison
viewportIndexInitializerInBlock
layerInitializerInBlock
)
;
initializers
-
>
push_back
(
multiviewBranch
)
;
}
}
void
DeclareAndInitBuiltinsForInstancedMultiview
(
TIntermBlock
*
root
unsigned
numberOfViews
GLenum
shaderType
ShCompileOptions
compileOptions
ShShaderOutput
shaderOutput
TSymbolTable
*
symbolTable
)
{
ASSERT
(
shaderType
=
=
GL_VERTEX_SHADER
|
|
shaderType
=
=
GL_FRAGMENT_SHADER
)
;
TQualifier
viewIDQualifier
=
(
shaderType
=
=
GL_VERTEX_SHADER
)
?
EvqFlatOut
:
EvqFlatIn
;
TIntermSymbol
*
viewIDSymbol
=
new
TIntermSymbol
(
symbolTable
-
>
nextUniqueId
(
)
"
ViewID_OVR
"
TType
(
EbtUInt
EbpHigh
viewIDQualifier
)
)
;
viewIDSymbol
-
>
setInternal
(
true
)
;
DeclareGlobalVariable
(
root
viewIDSymbol
)
;
ReplaceSymbol
(
root
"
gl_ViewID_OVR
"
viewIDSymbol
)
;
if
(
shaderType
=
=
GL_VERTEX_SHADER
)
{
TIntermSymbol
*
instanceIDSymbol
=
new
TIntermSymbol
(
symbolTable
-
>
nextUniqueId
(
)
"
InstanceID
"
TType
(
EbtInt
EbpHigh
EvqGlobal
)
)
;
instanceIDSymbol
-
>
setInternal
(
true
)
;
DeclareGlobalVariable
(
root
instanceIDSymbol
)
;
ReplaceSymbol
(
root
"
gl_InstanceID
"
instanceIDSymbol
)
;
TIntermSequence
*
initializers
=
new
TIntermSequence
(
)
;
InitializeViewIDAndInstanceID
(
viewIDSymbol
instanceIDSymbol
numberOfViews
*
symbolTable
initializers
)
;
const
bool
selectView
=
(
compileOptions
&
SH_SELECT_VIEW_IN_NV_GLSL_VERTEX_SHADER
)
!
=
0u
;
ASSERT
(
!
selectView
|
|
IsOutputGLSL
(
shaderOutput
)
|
|
IsOutputESSL
(
shaderOutput
)
)
;
if
(
selectView
)
{
TIntermSymbol
*
multiviewBaseViewLayerIndexSymbol
=
new
TIntermSymbol
(
symbolTable
-
>
nextUniqueId
(
)
"
multiviewBaseViewLayerIndex
"
TType
(
EbtInt
EbpHigh
EvqUniform
)
)
;
multiviewBaseViewLayerIndexSymbol
-
>
setInternal
(
true
)
;
DeclareGlobalVariable
(
root
multiviewBaseViewLayerIndexSymbol
)
;
SelectViewIndexInVertexShader
(
viewIDSymbol
-
>
deepCopy
(
)
multiviewBaseViewLayerIndexSymbol
-
>
deepCopy
(
)
initializers
*
symbolTable
)
;
}
TIntermBlock
*
initializersBlock
=
new
TIntermBlock
(
)
;
initializersBlock
-
>
getSequence
(
)
-
>
swap
(
*
initializers
)
;
TIntermBlock
*
mainBody
=
FindMainBody
(
root
)
;
mainBody
-
>
getSequence
(
)
-
>
insert
(
mainBody
-
>
getSequence
(
)
-
>
begin
(
)
initializersBlock
)
;
}
}
}
