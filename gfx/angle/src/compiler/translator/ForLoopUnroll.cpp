#
include
"
compiler
/
translator
/
ForLoopUnroll
.
h
"
#
include
"
compiler
/
translator
/
ValidateLimitations
.
h
"
#
include
"
angle_gl
.
h
"
namespace
sh
{
bool
ForLoopUnrollMarker
:
:
visitBinary
(
Visit
TIntermBinary
*
node
)
{
if
(
mUnrollCondition
!
=
kSamplerArrayIndex
)
return
true
;
switch
(
node
-
>
getOp
(
)
)
{
case
EOpIndexIndirect
:
if
(
node
-
>
getLeft
(
)
!
=
NULL
&
&
node
-
>
getRight
(
)
!
=
NULL
&
&
node
-
>
getLeft
(
)
-
>
getAsSymbolNode
(
)
)
{
TIntermSymbol
*
symbol
=
node
-
>
getLeft
(
)
-
>
getAsSymbolNode
(
)
;
if
(
IsSampler
(
symbol
-
>
getBasicType
(
)
)
&
&
symbol
-
>
isArray
(
)
&
&
!
mLoopStack
.
empty
(
)
)
{
mVisitSamplerArrayIndexNodeInsideLoop
=
true
;
node
-
>
getRight
(
)
-
>
traverse
(
this
)
;
mVisitSamplerArrayIndexNodeInsideLoop
=
false
;
return
false
;
}
}
break
;
default
:
break
;
}
return
true
;
}
bool
ForLoopUnrollMarker
:
:
visitLoop
(
Visit
TIntermLoop
*
node
)
{
bool
canBeUnrolled
=
mHasRunLoopValidation
;
if
(
!
mHasRunLoopValidation
)
{
canBeUnrolled
=
ValidateLimitations
:
:
IsLimitedForLoop
(
node
)
;
}
if
(
mUnrollCondition
=
=
kIntegerIndex
&
&
canBeUnrolled
)
{
TIntermSequence
*
declSeq
=
node
-
>
getInit
(
)
-
>
getAsDeclarationNode
(
)
-
>
getSequence
(
)
;
TIntermSymbol
*
symbol
=
(
*
declSeq
)
[
0
]
-
>
getAsBinaryNode
(
)
-
>
getLeft
(
)
-
>
getAsSymbolNode
(
)
;
if
(
symbol
-
>
getBasicType
(
)
=
=
EbtInt
)
node
-
>
setUnrollFlag
(
true
)
;
}
TIntermNode
*
body
=
node
-
>
getBody
(
)
;
if
(
body
!
=
nullptr
)
{
if
(
canBeUnrolled
)
{
mLoopStack
.
push
(
node
)
;
body
-
>
traverse
(
this
)
;
mLoopStack
.
pop
(
)
;
}
else
{
body
-
>
traverse
(
this
)
;
}
}
return
false
;
}
void
ForLoopUnrollMarker
:
:
visitSymbol
(
TIntermSymbol
*
symbol
)
{
if
(
!
mVisitSamplerArrayIndexNodeInsideLoop
)
return
;
TIntermLoop
*
loop
=
mLoopStack
.
findLoop
(
symbol
)
;
if
(
loop
)
{
switch
(
symbol
-
>
getBasicType
(
)
)
{
case
EbtFloat
:
mSamplerArrayIndexIsFloatLoopIndex
=
true
;
break
;
case
EbtInt
:
loop
-
>
setUnrollFlag
(
true
)
;
break
;
default
:
UNREACHABLE
(
)
;
}
}
}
}
