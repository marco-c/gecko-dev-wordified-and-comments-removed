from
__future__
import
print_function
import
json
import
os
import
subprocess
import
time
import
urllib2
FILE
=
'
perf
.
json
'
URL
=
'
https
:
/
/
wrperf
.
org
/
submit
'
while
True
:
    
try
:
        
try
:
            
os
.
remove
(
FILE
)
        
except
:
            
pass
        
subprocess
.
call
(
[
"
git
"
"
pull
"
]
)
        
revision
=
subprocess
.
check_output
(
[
"
git
"
"
rev
-
parse
"
"
HEAD
"
]
)
.
strip
(
)
        
subprocess
.
call
(
[
"
cargo
"
"
build
"
"
-
-
release
"
]
)
        
env
=
os
.
environ
.
copy
(
)
        
env
[
'
vblank_mode
'
]
=
'
0
'
        
subprocess
.
call
(
[
"
cargo
"
"
run
"
"
-
-
release
"
"
-
-
"
"
perf
"
FILE
]
env
=
env
)
        
with
open
(
FILE
)
as
file
:
            
results
=
json
.
load
(
file
)
        
payload
=
{
            
'
key
'
:
env
[
'
WEBRENDER_PERF_KEY
'
]
            
'
revision
'
:
revision
            
'
timestamp
'
:
str
(
time
.
time
(
)
)
            
'
tests
'
:
results
[
'
tests
'
]
        
}
        
req
=
urllib2
.
Request
(
URL
                              
headers
=
{
"
Content
-
Type
"
:
"
application
/
json
"
}
                              
data
=
json
.
dumps
(
payload
)
)
        
f
=
urllib2
.
urlopen
(
req
)
    
except
Exception
as
e
:
        
print
(
e
)
    
time
.
sleep
(
60
*
60
)
