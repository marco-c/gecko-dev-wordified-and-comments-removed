use
api
:
:
ColorF
;
use
api
:
:
units
:
:
{
DeviceRect
DeviceIntSize
DeviceIntRect
DeviceIntPoint
}
;
use
crate
:
:
gpu_types
:
:
{
ZBufferId
ZBufferIdGenerator
}
;
use
crate
:
:
picture
:
:
{
ResolvedSurfaceTexture
SurfaceTextureDescriptor
}
;
#
[
derive
(
Debug
Clone
)
]
#
[
cfg_attr
(
feature
=
"
capture
"
derive
(
Serialize
)
)
]
#
[
cfg_attr
(
feature
=
"
replay
"
derive
(
Deserialize
)
)
]
pub
enum
NativeSurfaceOperationDetails
{
CreateSurface
{
size
:
DeviceIntSize
}
DestroySurface
}
#
[
derive
(
Debug
Clone
)
]
#
[
cfg_attr
(
feature
=
"
capture
"
derive
(
Serialize
)
)
]
#
[
cfg_attr
(
feature
=
"
replay
"
derive
(
Deserialize
)
)
]
pub
struct
NativeSurfaceOperation
{
pub
id
:
NativeSurfaceId
pub
details
:
NativeSurfaceOperationDetails
}
#
[
cfg_attr
(
feature
=
"
capture
"
derive
(
Serialize
)
)
]
#
[
cfg_attr
(
feature
=
"
replay
"
derive
(
Deserialize
)
)
]
pub
enum
CompositeTileSurface
{
Texture
{
surface
:
ResolvedSurfaceTexture
}
Color
{
color
:
ColorF
}
Clear
}
#
[
cfg_attr
(
feature
=
"
capture
"
derive
(
Serialize
)
)
]
#
[
cfg_attr
(
feature
=
"
replay
"
derive
(
Deserialize
)
)
]
pub
struct
CompositeTile
{
pub
surface
:
CompositeTileSurface
pub
rect
:
DeviceRect
pub
clip_rect
:
DeviceRect
pub
dirty_rect
:
DeviceRect
pub
z_id
:
ZBufferId
}
#
[
cfg_attr
(
feature
=
"
capture
"
derive
(
Serialize
)
)
]
#
[
cfg_attr
(
feature
=
"
replay
"
derive
(
Deserialize
)
)
]
#
[
derive
(
Debug
Copy
Clone
PartialEq
)
]
pub
enum
CompositeMode
{
Draw
Native
}
#
[
cfg_attr
(
feature
=
"
capture
"
derive
(
Serialize
)
)
]
#
[
cfg_attr
(
feature
=
"
replay
"
derive
(
Deserialize
)
)
]
pub
struct
CompositeState
{
pub
opaque_tiles
:
Vec
<
CompositeTile
>
pub
alpha_tiles
:
Vec
<
CompositeTile
>
pub
clear_tiles
:
Vec
<
CompositeTile
>
pub
z_generator
:
ZBufferIdGenerator
pub
dirty_rects_are_valid
:
bool
pub
native_surface_updates
:
Vec
<
NativeSurfaceOperation
>
pub
composite_mode
:
CompositeMode
}
impl
CompositeState
{
pub
fn
new
(
composite_mode
:
CompositeMode
)
-
>
Self
{
CompositeState
{
opaque_tiles
:
Vec
:
:
new
(
)
alpha_tiles
:
Vec
:
:
new
(
)
clear_tiles
:
Vec
:
:
new
(
)
z_generator
:
ZBufferIdGenerator
:
:
new
(
0
)
dirty_rects_are_valid
:
true
native_surface_updates
:
Vec
:
:
new
(
)
composite_mode
}
}
pub
fn
create_surface
(
&
mut
self
id
:
NativeSurfaceId
size
:
DeviceIntSize
)
-
>
SurfaceTextureDescriptor
{
debug_assert_eq
!
(
self
.
composite_mode
CompositeMode
:
:
Native
)
;
self
.
native_surface_updates
.
push
(
NativeSurfaceOperation
{
id
details
:
NativeSurfaceOperationDetails
:
:
CreateSurface
{
size
}
}
)
;
SurfaceTextureDescriptor
:
:
NativeSurface
{
id
size
}
}
pub
fn
destroy_surface
(
&
mut
self
id
:
NativeSurfaceId
)
{
debug_assert_eq
!
(
self
.
composite_mode
CompositeMode
:
:
Native
)
;
self
.
native_surface_updates
.
push
(
NativeSurfaceOperation
{
id
details
:
NativeSurfaceOperationDetails
:
:
DestroySurface
}
)
;
}
}
#
[
repr
(
C
)
]
#
[
derive
(
Debug
Copy
Clone
)
]
#
[
cfg_attr
(
feature
=
"
capture
"
derive
(
Serialize
)
)
]
#
[
cfg_attr
(
feature
=
"
replay
"
derive
(
Deserialize
)
)
]
pub
struct
NativeSurfaceId
(
pub
u64
)
;
pub
trait
Compositor
{
fn
create_surface
(
&
mut
self
id
:
NativeSurfaceId
size
:
DeviceIntSize
)
;
fn
destroy_surface
(
&
mut
self
id
:
NativeSurfaceId
)
;
fn
bind
(
&
mut
self
id
:
NativeSurfaceId
)
-
>
DeviceIntPoint
;
fn
unbind
(
&
mut
self
)
;
fn
begin_frame
(
&
mut
self
)
;
fn
add_surface
(
&
mut
self
id
:
NativeSurfaceId
position
:
DeviceIntPoint
clip_rect
:
DeviceIntRect
)
;
fn
end_frame
(
&
mut
self
)
;
}
