#
include
"
nsDeviceContext
.
h
"
#
include
<
algorithm
>
#
include
"
gfxContext
.
h
"
#
include
"
gfxImageSurface
.
h
"
#
include
"
gfxPoint
.
h
"
#
include
"
gfxTextRun
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
gfx
/
PathHelpers
.
h
"
#
include
"
mozilla
/
gfx
/
PrintTarget
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
nsCRT
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
nsFont
.
h
"
#
include
"
nsFontCache
.
h
"
#
include
"
nsFontMetrics
.
h
"
#
include
"
nsAtom
.
h
"
#
include
"
nsID
.
h
"
#
include
"
nsIDeviceContextSpec
.
h
"
#
include
"
nsLanguageAtomService
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsIObserverService
.
h
"
#
include
"
nsIScreen
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsISupportsUtils
.
h
"
#
include
"
nsIWidget
.
h
"
#
include
"
nsRect
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
widget
/
ScreenManager
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
gfx
;
using
mozilla
:
:
widget
:
:
ScreenManager
;
nsDeviceContext
:
:
nsDeviceContext
(
)
:
mWidth
(
0
)
mHeight
(
0
)
mAppUnitsPerDevPixel
(
-
1
)
mAppUnitsPerDevPixelAtUnitFullZoom
(
-
1
)
mAppUnitsPerPhysicalInch
(
-
1
)
mFullZoom
(
1
.
0f
)
mPrintingScale
(
1
.
0f
)
mPrintingTranslate
(
gfxPoint
(
0
0
)
)
mIsCurrentlyPrintingDoc
(
false
)
#
ifdef
DEBUG
mIsInitialized
(
false
)
#
endif
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
"
nsDeviceContext
created
off
main
thread
"
)
;
}
nsDeviceContext
:
:
~
nsDeviceContext
(
)
=
default
;
bool
nsDeviceContext
:
:
IsPrinterContext
(
)
{
return
mPrintTarget
!
=
nullptr
;
}
void
nsDeviceContext
:
:
SetDPI
(
double
*
aScale
)
{
float
dpi
;
if
(
mDeviceContextSpec
)
{
dpi
=
mDeviceContextSpec
-
>
GetDPI
(
)
;
mPrintingScale
=
mDeviceContextSpec
-
>
GetPrintingScale
(
)
;
mPrintingTranslate
=
mDeviceContextSpec
-
>
GetPrintingTranslate
(
)
;
mAppUnitsPerDevPixelAtUnitFullZoom
=
NS_lround
(
(
AppUnitsPerCSSPixel
(
)
*
96
)
/
dpi
)
;
}
else
{
RefPtr
<
widget
:
:
Screen
>
primaryScreen
=
ScreenManager
:
:
GetSingleton
(
)
.
GetPrimaryScreen
(
)
;
MOZ_ASSERT
(
primaryScreen
)
;
int32_t
prefDPI
=
StaticPrefs
:
:
layout_css_dpi
(
)
;
if
(
prefDPI
>
0
)
{
dpi
=
prefDPI
;
}
else
if
(
mWidget
)
{
dpi
=
mWidget
-
>
GetDPI
(
)
;
if
(
dpi
<
0
)
{
dpi
=
primaryScreen
-
>
GetDPI
(
)
;
}
if
(
prefDPI
<
0
)
{
dpi
=
std
:
:
max
(
96
.
0f
dpi
)
;
}
}
else
{
dpi
=
96
.
0f
;
}
double
devPixelsPerCSSPixel
;
if
(
aScale
&
&
*
aScale
>
0
.
0
)
{
devPixelsPerCSSPixel
=
*
aScale
;
}
else
{
CSSToLayoutDeviceScale
scale
=
mWidget
?
mWidget
-
>
GetDefaultScale
(
)
:
CSSToLayoutDeviceScale
(
1
.
0
)
;
devPixelsPerCSSPixel
=
scale
.
scale
;
if
(
devPixelsPerCSSPixel
<
0
)
{
primaryScreen
-
>
GetDefaultCSSScaleFactor
(
&
devPixelsPerCSSPixel
)
;
}
if
(
aScale
)
{
*
aScale
=
devPixelsPerCSSPixel
;
}
}
mAppUnitsPerDevPixelAtUnitFullZoom
=
std
:
:
max
(
1
NS_lround
(
AppUnitsPerCSSPixel
(
)
/
devPixelsPerCSSPixel
)
)
;
}
NS_ASSERTION
(
dpi
!
=
-
1
.
0
"
no
dpi
set
"
)
;
mAppUnitsPerPhysicalInch
=
NS_lround
(
dpi
*
mAppUnitsPerDevPixelAtUnitFullZoom
)
;
UpdateAppUnitsForFullZoom
(
)
;
}
nsresult
nsDeviceContext
:
:
Init
(
nsIWidget
*
aWidget
)
{
#
ifdef
DEBUG
mIsInitialized
=
true
;
#
endif
nsresult
rv
=
NS_OK
;
if
(
mScreenManager
&
&
mWidget
=
=
aWidget
)
return
rv
;
mWidget
=
aWidget
;
SetDPI
(
)
;
if
(
mScreenManager
)
return
rv
;
mScreenManager
=
do_GetService
(
"
mozilla
.
org
/
gfx
/
screenmanager
;
1
"
&
rv
)
;
return
rv
;
}
already_AddRefed
<
gfxContext
>
nsDeviceContext
:
:
CreateRenderingContext
(
)
{
return
CreateRenderingContextCommon
(
false
)
;
}
already_AddRefed
<
gfxContext
>
nsDeviceContext
:
:
CreateReferenceRenderingContext
(
)
{
return
CreateRenderingContextCommon
(
true
)
;
}
already_AddRefed
<
gfxContext
>
nsDeviceContext
:
:
CreateRenderingContextCommon
(
bool
aWantReferenceContext
)
{
MOZ_ASSERT
(
IsPrinterContext
(
)
)
;
MOZ_ASSERT
(
mWidth
>
0
&
&
mHeight
>
0
)
;
if
(
NS_WARN_IF
(
!
mPrintTarget
)
)
{
return
nullptr
;
}
RefPtr
<
gfx
:
:
DrawTarget
>
dt
;
if
(
aWantReferenceContext
)
{
dt
=
mPrintTarget
-
>
GetReferenceDrawTarget
(
)
;
}
else
{
RefPtr
<
DrawEventRecorder
>
recorder
;
mDeviceContextSpec
-
>
GetDrawEventRecorder
(
getter_AddRefs
(
recorder
)
)
;
dt
=
mPrintTarget
-
>
MakeDrawTarget
(
gfx
:
:
IntSize
(
mWidth
mHeight
)
recorder
)
;
}
if
(
!
dt
|
|
!
dt
-
>
IsValid
(
)
)
{
gfxCriticalNote
<
<
"
Failed
to
create
draw
target
in
device
context
sized
"
<
<
mWidth
<
<
"
x
"
<
<
mHeight
<
<
"
and
pointer
"
<
<
hexa
(
mPrintTarget
)
;
return
nullptr
;
}
dt
-
>
AddUserData
(
&
sDisablePixelSnapping
(
void
*
)
0x1
nullptr
)
;
RefPtr
<
gfxContext
>
pContext
=
gfxContext
:
:
CreateOrNull
(
dt
)
;
MOZ_ASSERT
(
pContext
)
;
gfxMatrix
transform
;
transform
.
PreTranslate
(
mPrintingTranslate
)
;
if
(
mPrintTarget
-
>
RotateNeededForLandscape
(
)
)
{
IntSize
size
=
mPrintTarget
-
>
GetSize
(
)
;
transform
.
PreTranslate
(
gfxPoint
(
0
size
.
width
)
)
;
gfxMatrix
rotate
(
0
-
1
1
0
0
0
)
;
transform
=
rotate
*
transform
;
}
transform
.
PreScale
(
mPrintingScale
mPrintingScale
)
;
pContext
-
>
SetMatrixDouble
(
transform
)
;
return
pContext
.
forget
(
)
;
}
uint32_t
nsDeviceContext
:
:
GetDepth
(
)
{
nsCOMPtr
<
nsIScreen
>
screen
;
FindScreen
(
getter_AddRefs
(
screen
)
)
;
if
(
!
screen
)
{
ScreenManager
&
screenManager
=
ScreenManager
:
:
GetSingleton
(
)
;
screenManager
.
GetPrimaryScreen
(
getter_AddRefs
(
screen
)
)
;
MOZ_ASSERT
(
screen
)
;
}
int32_t
depth
=
0
;
screen
-
>
GetColorDepth
(
&
depth
)
;
return
uint32_t
(
depth
)
;
}
nsresult
nsDeviceContext
:
:
GetDeviceSurfaceDimensions
(
nscoord
&
aWidth
nscoord
&
aHeight
)
{
if
(
IsPrinterContext
(
)
)
{
aWidth
=
mWidth
;
aHeight
=
mHeight
;
}
else
{
nsRect
area
;
ComputeFullAreaUsingScreen
(
&
area
)
;
aWidth
=
area
.
Width
(
)
;
aHeight
=
area
.
Height
(
)
;
}
return
NS_OK
;
}
nsresult
nsDeviceContext
:
:
GetRect
(
nsRect
&
aRect
)
{
if
(
IsPrinterContext
(
)
)
{
aRect
.
SetRect
(
0
0
mWidth
mHeight
)
;
}
else
ComputeFullAreaUsingScreen
(
&
aRect
)
;
return
NS_OK
;
}
nsresult
nsDeviceContext
:
:
GetClientRect
(
nsRect
&
aRect
)
{
if
(
IsPrinterContext
(
)
)
{
aRect
.
SetRect
(
0
0
mWidth
mHeight
)
;
}
else
ComputeClientRectUsingScreen
(
&
aRect
)
;
return
NS_OK
;
}
nsresult
nsDeviceContext
:
:
InitForPrinting
(
nsIDeviceContextSpec
*
aDevice
)
{
NS_ENSURE_ARG_POINTER
(
aDevice
)
;
MOZ_ASSERT
(
!
mIsInitialized
"
Only
initialize
once
immediately
after
construction
"
)
;
mPrintTarget
=
aDevice
-
>
MakePrintTarget
(
)
;
if
(
!
mPrintTarget
)
{
return
NS_ERROR_FAILURE
;
}
mDeviceContextSpec
=
aDevice
;
Init
(
nullptr
)
;
if
(
!
CalcPrintingSize
(
)
)
{
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
nsresult
nsDeviceContext
:
:
BeginDocument
(
const
nsAString
&
aTitle
const
nsAString
&
aPrintToFileName
int32_t
aStartPage
int32_t
aEndPage
)
{
MOZ_DIAGNOSTIC_ASSERT
(
!
mIsCurrentlyPrintingDoc
"
Mismatched
BeginDocument
/
EndDocument
calls
"
)
;
nsresult
rv
=
mPrintTarget
-
>
BeginPrinting
(
aTitle
aPrintToFileName
aStartPage
aEndPage
)
;
if
(
NS_SUCCEEDED
(
rv
)
)
{
if
(
mDeviceContextSpec
)
{
rv
=
mDeviceContextSpec
-
>
BeginDocument
(
aTitle
aPrintToFileName
aStartPage
aEndPage
)
;
}
mIsCurrentlyPrintingDoc
=
true
;
}
NS_WARNING_ASSERTION
(
NS_SUCCEEDED
(
rv
)
|
|
rv
=
=
NS_ERROR_ABORT
"
nsDeviceContext
:
:
BeginDocument
failed
"
)
;
return
rv
;
}
nsresult
nsDeviceContext
:
:
EndDocument
(
)
{
MOZ_DIAGNOSTIC_ASSERT
(
mIsCurrentlyPrintingDoc
"
Mismatched
BeginDocument
/
EndDocument
calls
"
)
;
MOZ_DIAGNOSTIC_ASSERT
(
mPrintTarget
)
;
mIsCurrentlyPrintingDoc
=
false
;
if
(
mPrintTarget
)
{
MOZ_TRY
(
mPrintTarget
-
>
EndPrinting
(
)
)
;
mPrintTarget
-
>
Finish
(
)
;
mPrintTarget
=
nullptr
;
}
if
(
mDeviceContextSpec
)
{
MOZ_TRY
(
mDeviceContextSpec
-
>
EndDocument
(
)
)
;
}
return
NS_OK
;
}
nsresult
nsDeviceContext
:
:
AbortDocument
(
)
{
MOZ_DIAGNOSTIC_ASSERT
(
mIsCurrentlyPrintingDoc
"
Mismatched
BeginDocument
/
EndDocument
calls
"
)
;
nsresult
rv
=
mPrintTarget
-
>
AbortPrinting
(
)
;
mIsCurrentlyPrintingDoc
=
false
;
if
(
mDeviceContextSpec
)
{
mDeviceContextSpec
-
>
EndDocument
(
)
;
}
mPrintTarget
=
nullptr
;
return
rv
;
}
nsresult
nsDeviceContext
:
:
BeginPage
(
)
{
MOZ_DIAGNOSTIC_ASSERT
(
!
mIsCurrentlyPrintingDoc
|
|
mPrintTarget
"
What
nulled
out
our
print
target
while
printing
?
"
)
;
if
(
mDeviceContextSpec
)
{
MOZ_TRY
(
mDeviceContextSpec
-
>
BeginPage
(
)
)
;
}
if
(
mPrintTarget
)
{
MOZ_TRY
(
mPrintTarget
-
>
BeginPage
(
)
)
;
}
return
NS_OK
;
}
nsresult
nsDeviceContext
:
:
EndPage
(
)
{
MOZ_DIAGNOSTIC_ASSERT
(
!
mIsCurrentlyPrintingDoc
|
|
mPrintTarget
"
What
nulled
out
our
print
target
while
printing
?
"
)
;
if
(
mPrintTarget
)
{
MOZ_TRY
(
mPrintTarget
-
>
EndPage
(
)
)
;
}
if
(
mDeviceContextSpec
)
{
MOZ_TRY
(
mDeviceContextSpec
-
>
EndPage
(
)
)
;
}
return
NS_OK
;
}
void
nsDeviceContext
:
:
ComputeClientRectUsingScreen
(
nsRect
*
outRect
)
{
nsCOMPtr
<
nsIScreen
>
screen
;
FindScreen
(
getter_AddRefs
(
screen
)
)
;
if
(
screen
)
{
int32_t
x
y
width
height
;
screen
-
>
GetAvailRect
(
&
x
&
y
&
width
&
height
)
;
outRect
-
>
SetRect
(
NSIntPixelsToAppUnits
(
x
AppUnitsPerDevPixel
(
)
)
NSIntPixelsToAppUnits
(
y
AppUnitsPerDevPixel
(
)
)
NSIntPixelsToAppUnits
(
width
AppUnitsPerDevPixel
(
)
)
NSIntPixelsToAppUnits
(
height
AppUnitsPerDevPixel
(
)
)
)
;
}
}
void
nsDeviceContext
:
:
ComputeFullAreaUsingScreen
(
nsRect
*
outRect
)
{
nsCOMPtr
<
nsIScreen
>
screen
;
FindScreen
(
getter_AddRefs
(
screen
)
)
;
if
(
screen
)
{
int32_t
x
y
width
height
;
screen
-
>
GetRect
(
&
x
&
y
&
width
&
height
)
;
outRect
-
>
SetRect
(
NSIntPixelsToAppUnits
(
x
AppUnitsPerDevPixel
(
)
)
NSIntPixelsToAppUnits
(
y
AppUnitsPerDevPixel
(
)
)
NSIntPixelsToAppUnits
(
width
AppUnitsPerDevPixel
(
)
)
NSIntPixelsToAppUnits
(
height
AppUnitsPerDevPixel
(
)
)
)
;
mWidth
=
outRect
-
>
Width
(
)
;
mHeight
=
outRect
-
>
Height
(
)
;
}
}
void
nsDeviceContext
:
:
FindScreen
(
nsIScreen
*
*
outScreen
)
{
if
(
!
mWidget
|
|
!
mScreenManager
)
{
return
;
}
CheckDPIChange
(
)
;
nsCOMPtr
<
nsIScreen
>
screen
=
mWidget
-
>
GetWidgetScreen
(
)
;
screen
.
forget
(
outScreen
)
;
if
(
!
(
*
outScreen
)
)
{
mScreenManager
-
>
GetPrimaryScreen
(
outScreen
)
;
}
}
bool
nsDeviceContext
:
:
CalcPrintingSize
(
)
{
gfxSize
size
(
mPrintTarget
-
>
GetSize
(
)
)
;
mWidth
=
NSToCoordRound
(
size
.
width
*
AppUnitsPerPhysicalInch
(
)
/
POINTS_PER_INCH_FLOAT
)
;
mHeight
=
NSToCoordRound
(
size
.
height
*
AppUnitsPerPhysicalInch
(
)
/
POINTS_PER_INCH_FLOAT
)
;
return
(
mWidth
>
0
&
&
mHeight
>
0
)
;
}
bool
nsDeviceContext
:
:
CheckDPIChange
(
double
*
aScale
)
{
int32_t
oldDevPixels
=
mAppUnitsPerDevPixelAtUnitFullZoom
;
int32_t
oldInches
=
mAppUnitsPerPhysicalInch
;
SetDPI
(
aScale
)
;
return
oldDevPixels
!
=
mAppUnitsPerDevPixelAtUnitFullZoom
|
|
oldInches
!
=
mAppUnitsPerPhysicalInch
;
}
bool
nsDeviceContext
:
:
SetFullZoom
(
float
aScale
)
{
if
(
aScale
<
=
0
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Invalid
full
zoom
value
"
)
;
return
false
;
}
int32_t
oldAppUnitsPerDevPixel
=
mAppUnitsPerDevPixel
;
mFullZoom
=
aScale
;
UpdateAppUnitsForFullZoom
(
)
;
return
oldAppUnitsPerDevPixel
!
=
mAppUnitsPerDevPixel
;
}
void
nsDeviceContext
:
:
UpdateAppUnitsForFullZoom
(
)
{
mAppUnitsPerDevPixel
=
std
:
:
max
(
1
NSToIntRound
(
float
(
mAppUnitsPerDevPixelAtUnitFullZoom
)
/
mFullZoom
)
)
;
mFullZoom
=
float
(
mAppUnitsPerDevPixelAtUnitFullZoom
)
/
mAppUnitsPerDevPixel
;
}
DesktopToLayoutDeviceScale
nsDeviceContext
:
:
GetDesktopToDeviceScale
(
)
{
nsCOMPtr
<
nsIScreen
>
screen
;
FindScreen
(
getter_AddRefs
(
screen
)
)
;
if
(
screen
)
{
double
scale
;
screen
-
>
GetContentsScaleFactor
(
&
scale
)
;
return
DesktopToLayoutDeviceScale
(
scale
)
;
}
return
DesktopToLayoutDeviceScale
(
1
.
0
)
;
}
