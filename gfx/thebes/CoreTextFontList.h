#
ifndef
CoreTextFontList_H
#
define
CoreTextFontList_H
#
include
<
CoreFoundation
/
CoreFoundation
.
h
>
#
include
"
gfxPlatformFontList
.
h
"
#
include
"
gfxPlatformMac
.
h
"
#
include
"
mozilla
/
FontPropertyTypes
.
h
"
#
include
"
mozilla
/
gfx
/
UnscaledFontMac
.
h
"
#
include
"
mozilla
/
LookAndFeel
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsUnicharUtils
.
h
"
class
CTFontEntry
final
:
public
gfxFontEntry
{
public
:
friend
class
CoreTextFontList
;
friend
class
gfxMacPlatformFontList
;
friend
class
gfxMacFont
;
CTFontEntry
(
const
nsACString
&
aPostscriptName
WeightRange
aWeight
bool
aIsStandardFace
=
false
double
aSizeHint
=
0
.
0
)
;
CTFontEntry
(
const
nsACString
&
aPostscriptName
CGFontRef
aFontRef
WeightRange
aWeight
StretchRange
aStretch
SlantStyleRange
aStyle
bool
aIsDataUserFont
bool
aIsLocal
)
;
virtual
~
CTFontEntry
(
)
{
:
:
CGFontRelease
(
mFontRef
)
;
}
gfxFontEntry
*
Clone
(
)
const
override
;
CGFontRef
GetFontRef
(
)
;
CGFontRef
CreateOrCopyFontRef
(
)
MOZ_REQUIRES_SHARED
(
mLock
)
;
hb_blob_t
*
GetFontTable
(
uint32_t
aTag
)
override
;
void
AddSizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
FontListSizes
*
aSizes
)
const
override
;
nsresult
ReadCMAP
(
FontInfoData
*
aFontInfoData
=
nullptr
)
override
;
bool
RequiresAATLayout
(
)
const
{
return
mRequiresAAT
;
}
bool
HasVariations
(
)
override
;
void
GetVariationAxes
(
nsTArray
<
gfxFontVariationAxis
>
&
aVariationAxes
)
override
;
void
GetVariationInstances
(
nsTArray
<
gfxFontVariationInstance
>
&
aInstances
)
override
;
bool
IsCFF
(
)
;
bool
SupportsOpenTypeFeature
(
Script
aScript
uint32_t
aFeatureTag
)
override
;
protected
:
gfxFont
*
CreateFontInstance
(
const
gfxFontStyle
*
aFontStyle
)
override
;
bool
HasFontTable
(
uint32_t
aTableTag
)
override
;
static
void
DestroyBlobFunc
(
void
*
aUserData
)
;
CGFontRef
mFontRef
MOZ_GUARDED_BY
(
mLock
)
;
const
double
mSizeHint
;
bool
mFontRefInitialized
MOZ_GUARDED_BY
(
mLock
)
;
mozilla
:
:
Atomic
<
bool
>
mRequiresAAT
;
mozilla
:
:
Atomic
<
bool
>
mIsCFF
;
mozilla
:
:
Atomic
<
bool
>
mIsCFFInitialized
;
mozilla
:
:
Atomic
<
bool
>
mHasVariations
;
mozilla
:
:
Atomic
<
bool
>
mHasVariationsInitialized
;
mozilla
:
:
Atomic
<
bool
>
mHasAATSmallCaps
;
mozilla
:
:
Atomic
<
bool
>
mHasAATSmallCapsInitialized
;
gfxFontVariationAxis
mOpszAxis
MOZ_GUARDED_BY
(
mLock
)
;
float
mAdjustedDefaultOpsz
MOZ_GUARDED_BY
(
mLock
)
;
nsTHashtable
<
nsUint32HashKey
>
mAvailableTables
MOZ_GUARDED_BY
(
mLock
)
;
mozilla
:
:
ThreadSafeWeakPtr
<
mozilla
:
:
gfx
:
:
UnscaledFontMac
>
mUnscaledFont
;
}
;
class
CTFontFamily
:
public
gfxFontFamily
{
public
:
CTFontFamily
(
const
nsACString
&
aName
FontVisibility
aVisibility
)
:
gfxFontFamily
(
aName
aVisibility
)
{
}
CTFontFamily
(
const
nsACString
&
aName
CTFontRef
aSystemFont
)
:
gfxFontFamily
(
aName
FontVisibility
:
:
Unknown
)
mForSystemFont
(
aSystemFont
)
{
CFRetain
(
mForSystemFont
)
;
}
virtual
~
CTFontFamily
(
)
=
default
;
void
LocalizedName
(
nsACString
&
aLocalizedName
)
override
;
void
FindStyleVariationsLocked
(
FontInfoData
*
aFontInfoData
=
nullptr
)
MOZ_REQUIRES
(
mLock
)
override
;
protected
:
void
AddFace
(
CTFontDescriptorRef
aFace
)
MOZ_REQUIRES
(
mLock
)
;
CTFontRef
mForSystemFont
=
nullptr
;
}
;
class
gfxMacFontFamily
final
:
public
CTFontFamily
{
public
:
}
;
class
CoreTextFontList
:
public
gfxPlatformFontList
{
using
FontFamilyListEntry
=
mozilla
:
:
dom
:
:
SystemFontListEntry
;
public
:
gfxFontFamily
*
CreateFontFamily
(
const
nsACString
&
aName
FontVisibility
aVisibility
)
const
override
;
static
int32_t
AppleWeightToCSSWeight
(
int32_t
aAppleWeight
)
;
gfxFontEntry
*
LookupLocalFont
(
FontVisibilityProvider
*
aFontVisibilityProvider
const
nsACString
&
aFontName
WeightRange
aWeightForEntry
StretchRange
aStretchForEntry
SlantStyleRange
aStyleForEntry
)
override
;
gfxFontEntry
*
MakePlatformFont
(
const
nsACString
&
aFontName
WeightRange
aWeightForEntry
StretchRange
aStretchForEntry
SlantStyleRange
aStyleForEntry
const
uint8_t
*
aFontData
uint32_t
aLength
)
override
;
bool
FindAndAddFamiliesLocked
(
FontVisibilityProvider
*
aFontVisibilityProvider
mozilla
:
:
StyleGenericFontFamily
aGeneric
const
nsACString
&
aFamily
nsTArray
<
FamilyAndGeneric
>
*
aOutput
FindFamiliesFlags
aFlags
gfxFontStyle
*
aStyle
=
nullptr
nsAtom
*
aLanguage
=
nullptr
gfxFloat
aDevToCssSize
=
1
.
0
)
MOZ_REQUIRES
(
mLock
)
override
;
enum
FontFamilyEntryType
{
kStandardFontFamily
=
0
kSystemFontFamily
=
1
}
;
void
ReadSystemFontList
(
mozilla
:
:
dom
:
:
SystemFontList
*
)
;
protected
:
CoreTextFontList
(
)
;
virtual
~
CoreTextFontList
(
)
;
nsresult
InitFontListForPlatform
(
)
MOZ_REQUIRES
(
mLock
)
override
;
void
InitSharedFontListForPlatform
(
)
MOZ_REQUIRES
(
mLock
)
override
;
void
PreloadNamesList
(
)
MOZ_REQUIRES
(
mLock
)
;
void
InitSystemFontNames
(
)
MOZ_REQUIRES
(
mLock
)
;
FontFamily
GetDefaultFontForPlatform
(
FontVisibilityProvider
*
aFontVisibilityProvider
const
gfxFontStyle
*
aStyle
nsAtom
*
aLanguage
=
nullptr
)
MOZ_REQUIRES
(
mLock
)
override
;
virtual
void
InitSingleFaceList
(
)
{
}
virtual
void
InitAliasesForSingleFaceList
(
)
{
}
virtual
bool
DeprecatedFamilyIsAvailable
(
const
nsACString
&
aName
)
{
return
false
;
}
virtual
FontVisibility
GetVisibilityForFamily
(
const
nsACString
&
aName
)
const
{
return
FontVisibility
:
:
Unknown
;
}
gfxFontFamily
*
FindSystemFontFamily
(
const
nsACString
&
aFamily
)
MOZ_REQUIRES
(
mLock
)
;
static
void
RegisteredFontsChangedNotificationCallback
(
CFNotificationCenterRef
center
void
*
observer
CFStringRef
name
const
void
*
object
CFDictionaryRef
userInfo
)
;
gfxFontEntry
*
PlatformGlobalFontFallback
(
FontVisibilityProvider
*
aFontVisibilityProvider
const
uint32_t
aCh
Script
aRunScript
const
gfxFontStyle
*
aMatchStyle
FontFamily
&
aMatchedFamily
)
MOZ_REQUIRES
(
mLock
)
override
;
bool
UsesSystemFallback
(
)
override
{
return
true
;
}
already_AddRefed
<
FontInfoData
>
CreateFontInfoData
(
)
override
;
void
AddFamily
(
CFStringRef
aFamily
)
MOZ_REQUIRES
(
mLock
)
;
void
AddFamily
(
const
nsACString
&
aFamilyName
FontVisibility
aVisibility
)
MOZ_REQUIRES
(
mLock
)
;
static
void
ActivateFontsFromDir
(
const
nsACString
&
aDir
nsTHashSet
<
nsCStringHashKey
>
*
aLoadedFamilies
=
nullptr
)
;
gfxFontEntry
*
CreateFontEntry
(
mozilla
:
:
fontlist
:
:
Face
*
aFace
const
mozilla
:
:
fontlist
:
:
Family
*
aFamily
)
override
;
void
GetFacesInitDataForFamily
(
const
mozilla
:
:
fontlist
:
:
Family
*
aFamily
nsTArray
<
mozilla
:
:
fontlist
:
:
Face
:
:
InitData
>
&
aFaces
bool
aLoadCmaps
)
const
override
;
static
void
AddFaceInitData
(
CTFontDescriptorRef
aFontDesc
nsTArray
<
mozilla
:
:
fontlist
:
:
Face
:
:
InitData
>
&
aFaces
bool
aLoadCmaps
)
;
void
ReadFaceNamesForFamily
(
mozilla
:
:
fontlist
:
:
Family
*
aFamily
bool
aNeedFullnamePostscriptNames
)
MOZ_REQUIRES
(
mLock
)
override
;
#
ifdef
MOZ_BUNDLED_FONTS
void
ActivateBundledFonts
(
)
;
#
endif
CTFontRef
mDefaultFont
;
nsCString
mSystemFontFamilyName
;
nsTArray
<
nsCString
>
mPreloadFonts
;
#
ifdef
MOZ_BUNDLED_FONTS
nsTHashSet
<
nsCStringHashKey
>
mBundledFamilies
;
#
endif
}
;
#
endif
