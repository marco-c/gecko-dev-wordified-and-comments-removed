#
ifndef
GFXPLATFORMFONTLIST_H_
#
define
GFXPLATFORMFONTLIST_H_
#
include
"
nsDataHashtable
.
h
"
#
include
"
nsRefPtrHashtable
.
h
"
#
include
"
nsTHashtable
.
h
"
#
include
"
gfxFontUtils
.
h
"
#
include
"
gfxFontInfoLoader
.
h
"
#
include
"
gfxFont
.
h
"
#
include
"
gfxFontConstants
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
gfxFontFamilyList
.
h
"
#
include
"
nsIMemoryReporter
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
RangedArray
.
h
"
#
include
"
nsILanguageAtomService
.
h
"
class
CharMapHashKey
:
public
PLDHashEntryHdr
{
public
:
typedef
gfxCharacterMap
*
KeyType
;
typedef
const
gfxCharacterMap
*
KeyTypePointer
;
explicit
CharMapHashKey
(
const
gfxCharacterMap
*
aCharMap
)
:
mCharMap
(
const_cast
<
gfxCharacterMap
*
>
(
aCharMap
)
)
{
MOZ_COUNT_CTOR
(
CharMapHashKey
)
;
}
CharMapHashKey
(
const
CharMapHashKey
&
toCopy
)
:
mCharMap
(
toCopy
.
mCharMap
)
{
MOZ_COUNT_CTOR
(
CharMapHashKey
)
;
}
~
CharMapHashKey
(
)
{
MOZ_COUNT_DTOR
(
CharMapHashKey
)
;
}
gfxCharacterMap
*
GetKey
(
)
const
{
return
mCharMap
;
}
bool
KeyEquals
(
const
gfxCharacterMap
*
aCharMap
)
const
{
NS_ASSERTION
(
!
aCharMap
-
>
mBuildOnTheFly
&
&
!
mCharMap
-
>
mBuildOnTheFly
"
custom
cmap
used
in
shared
cmap
hashtable
"
)
;
if
(
aCharMap
-
>
mHash
!
=
mCharMap
-
>
mHash
)
{
return
false
;
}
return
mCharMap
-
>
Equals
(
aCharMap
)
;
}
static
const
gfxCharacterMap
*
KeyToPointer
(
gfxCharacterMap
*
aCharMap
)
{
return
aCharMap
;
}
static
PLDHashNumber
HashKey
(
const
gfxCharacterMap
*
aCharMap
)
{
return
aCharMap
-
>
mHash
;
}
enum
{
ALLOW_MEMMOVE
=
true
}
;
protected
:
gfxCharacterMap
*
mCharMap
;
}
;
struct
FontListSizes
{
uint32_t
mFontListSize
;
uint32_t
mFontTableCacheSize
;
uint32_t
mCharMapsSize
;
}
;
class
gfxUserFontSet
;
class
gfxPlatformFontList
:
public
gfxFontInfoLoader
{
public
:
static
gfxPlatformFontList
*
PlatformFontList
(
)
{
return
sPlatformFontList
;
}
static
nsresult
Init
(
)
{
NS_ASSERTION
(
!
sPlatformFontList
"
What
'
s
this
doing
here
?
"
)
;
gfxPlatform
:
:
GetPlatform
(
)
-
>
CreatePlatformFontList
(
)
;
if
(
!
sPlatformFontList
)
{
return
NS_ERROR_OUT_OF_MEMORY
;
}
return
NS_OK
;
}
static
void
Shutdown
(
)
{
delete
sPlatformFontList
;
sPlatformFontList
=
nullptr
;
}
virtual
~
gfxPlatformFontList
(
)
;
virtual
nsresult
InitFontList
(
)
;
virtual
void
GetFontList
(
nsIAtom
*
aLangGroup
const
nsACString
&
aGenericFamily
nsTArray
<
nsString
>
&
aListOfFonts
)
;
void
UpdateFontList
(
)
;
virtual
void
ClearLangGroupPrefFonts
(
)
;
virtual
void
GetFontFamilyList
(
nsTArray
<
RefPtr
<
gfxFontFamily
>
>
&
aFamilyArray
)
;
gfxFontEntry
*
SystemFindFontForChar
(
uint32_t
aCh
uint32_t
aNextCh
int32_t
aRunScript
const
gfxFontStyle
*
aStyle
)
;
virtual
gfxFontFamily
*
FindFamily
(
const
nsAString
&
aFamily
gfxFontStyle
*
aStyle
=
nullptr
gfxFloat
aDevToCssSize
=
1
.
0
)
;
gfxFontEntry
*
FindFontForFamily
(
const
nsAString
&
aFamily
const
gfxFontStyle
*
aStyle
bool
&
aNeedsBold
)
;
void
AddOtherFamilyName
(
gfxFontFamily
*
aFamilyEntry
nsAString
&
aOtherFamilyName
)
;
void
AddFullname
(
gfxFontEntry
*
aFontEntry
nsAString
&
aFullname
)
;
void
AddPostscriptName
(
gfxFontEntry
*
aFontEntry
nsAString
&
aPostscriptName
)
;
bool
NeedFullnamePostscriptNames
(
)
{
return
mExtraNames
!
=
nullptr
;
}
virtual
gfxFontFamily
*
GetDefaultFont
(
const
gfxFontStyle
*
aStyle
)
=
0
;
virtual
gfxFontEntry
*
LookupLocalFont
(
const
nsAString
&
aFontName
uint16_t
aWeight
int16_t
aStretch
uint8_t
aStyle
)
=
0
;
virtual
gfxFontEntry
*
MakePlatformFont
(
const
nsAString
&
aFontName
uint16_t
aWeight
int16_t
aStretch
uint8_t
aStyle
const
uint8_t
*
aFontData
uint32_t
aLength
)
=
0
;
virtual
bool
GetStandardFamilyName
(
const
nsAString
&
aFontName
nsAString
&
aFamilyName
)
;
virtual
void
AddSizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
FontListSizes
*
aSizes
)
const
;
virtual
void
AddSizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
FontListSizes
*
aSizes
)
const
;
gfxCharacterMap
*
FindCharMap
(
gfxCharacterMap
*
aCmap
)
;
gfxCharacterMap
*
AddCmap
(
const
gfxCharacterMap
*
aCharMap
)
;
void
RemoveCmap
(
const
gfxCharacterMap
*
aCharMap
)
;
void
AddUserFontSet
(
gfxUserFontSet
*
aUserFontSet
)
{
mUserFontSetList
.
PutEntry
(
aUserFontSet
)
;
}
void
RemoveUserFontSet
(
gfxUserFontSet
*
aUserFontSet
)
{
mUserFontSetList
.
RemoveEntry
(
aUserFontSet
)
;
}
static
const
gfxFontEntry
:
:
ScriptRange
sComplexScriptRanges
[
]
;
void
GetFontlistInitInfo
(
uint32_t
&
aNumInits
uint32_t
&
aLoaderState
)
{
aNumInits
=
mFontlistInitCount
;
aLoaderState
=
(
uint32_t
)
mState
;
}
virtual
void
AppendLinkedSystemFamilies
(
nsIAtom
*
aLanguage
nsTArray
<
gfxFontFamily
*
>
&
aFamilyList
)
{
}
virtual
void
AddGenericFonts
(
mozilla
:
:
FontFamilyType
aGenericType
nsIAtom
*
aLanguage
nsTArray
<
gfxFontFamily
*
>
&
aFamilyList
)
;
nsTArray
<
RefPtr
<
gfxFontFamily
>
>
*
GetPrefFontsLangGroup
(
mozilla
:
:
FontFamilyType
aGenericType
eFontPrefLang
aPrefLang
)
;
void
GetLangPrefs
(
eFontPrefLang
aPrefLangs
[
]
uint32_t
&
aLen
eFontPrefLang
aCharLang
eFontPrefLang
aPageLang
)
;
static
eFontPrefLang
GetFontPrefLangFor
(
const
char
*
aLang
)
;
static
eFontPrefLang
GetFontPrefLangFor
(
nsIAtom
*
aLang
)
;
static
nsIAtom
*
GetLangGroupForPrefLang
(
eFontPrefLang
aLang
)
;
static
const
char
*
GetPrefLangName
(
eFontPrefLang
aLang
)
;
static
eFontPrefLang
GetFontPrefLangFor
(
uint8_t
aUnicodeRange
)
;
static
bool
IsLangCJK
(
eFontPrefLang
aLang
)
;
static
void
AppendPrefLang
(
eFontPrefLang
aPrefLangs
[
]
uint32_t
&
aLen
eFontPrefLang
aAddLang
)
;
mozilla
:
:
FontFamilyType
GetDefaultGeneric
(
eFontPrefLang
aLang
)
;
void
GetSampleLangForGroup
(
nsIAtom
*
aLanguage
nsACString
&
aLangStr
bool
aCheckEnvironment
=
true
)
;
protected
:
class
MemoryReporter
final
:
public
nsIMemoryReporter
{
~
MemoryReporter
(
)
{
}
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIMEMORYREPORTER
}
;
explicit
gfxPlatformFontList
(
bool
aNeedFullnamePostscriptNames
=
true
)
;
static
gfxPlatformFontList
*
sPlatformFontList
;
gfxFontFamily
*
FindFamilyByCanonicalName
(
const
nsAString
&
aFamily
)
{
nsAutoString
key
;
gfxFontFamily
*
familyEntry
;
GenerateFontListKey
(
aFamily
key
)
;
if
(
(
familyEntry
=
mFontFamilies
.
GetWeak
(
key
)
)
)
{
return
CheckFamily
(
familyEntry
)
;
}
return
nullptr
;
}
gfxFontEntry
*
CommonFontFallback
(
uint32_t
aCh
uint32_t
aNextCh
int32_t
aRunScript
const
gfxFontStyle
*
aMatchStyle
gfxFontFamily
*
*
aMatchedFamily
)
;
virtual
gfxFontEntry
*
GlobalFontFallback
(
const
uint32_t
aCh
int32_t
aRunScript
const
gfxFontStyle
*
aMatchStyle
uint32_t
&
aCmapCount
gfxFontFamily
*
*
aMatchedFamily
)
;
virtual
bool
UsesSystemFallback
(
)
{
return
false
;
}
void
AppendCJKPrefLangs
(
eFontPrefLang
aPrefLangs
[
]
uint32_t
&
aLen
eFontPrefLang
aCharLang
eFontPrefLang
aPageLang
)
;
gfxFontFamily
*
CheckFamily
(
gfxFontFamily
*
aFamily
)
;
void
InitOtherFamilyNames
(
)
;
gfxFontEntry
*
SearchFamiliesForFaceName
(
const
nsAString
&
aFaceName
)
;
gfxFontEntry
*
FindFaceName
(
const
nsAString
&
aFaceName
)
;
virtual
gfxFontEntry
*
LookupInFaceNameLists
(
const
nsAString
&
aFontName
)
;
virtual
void
PreloadNamesList
(
)
;
void
LoadBadUnderlineList
(
)
;
void
GenerateFontListKey
(
const
nsAString
&
aKeyName
nsAString
&
aResult
)
;
virtual
void
GetFontFamilyNames
(
nsTArray
<
nsString
>
&
aFontFamilyNames
)
;
nsILanguageAtomService
*
GetLangService
(
)
;
nsIAtom
*
GetLangGroup
(
nsIAtom
*
aLanguage
)
;
bool
TryLangForGroup
(
const
nsACString
&
aOSLang
nsIAtom
*
aLangGroup
nsACString
&
aLang
)
;
static
const
char
*
GetGenericName
(
mozilla
:
:
FontFamilyType
aGenericType
)
;
virtual
void
InitLoader
(
)
;
virtual
bool
LoadFontInfo
(
)
;
virtual
void
CleanupLoader
(
)
;
void
GetPrefsAndStartLoader
(
)
;
void
ForceGlobalReflow
(
)
;
void
RebuildLocalFonts
(
)
;
void
ResolveGenericFontNames
(
mozilla
:
:
FontFamilyType
aGenericType
eFontPrefLang
aPrefLang
nsTArray
<
RefPtr
<
gfxFontFamily
>
>
*
aGenericFamilies
)
;
typedef
nsRefPtrHashtable
<
nsStringHashKey
gfxFontFamily
>
FontFamilyTable
;
typedef
nsRefPtrHashtable
<
nsStringHashKey
gfxFontEntry
>
FontEntryTable
;
static
size_t
SizeOfFontFamilyTableExcludingThis
(
const
FontFamilyTable
&
aTable
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
;
static
size_t
SizeOfFontEntryTableExcludingThis
(
const
FontEntryTable
&
aTable
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
;
FontFamilyTable
mFontFamilies
;
FontFamilyTable
mOtherFamilyNames
;
bool
mOtherFamilyNamesInitialized
;
bool
mFaceNameListsInitialized
;
struct
ExtraNames
{
ExtraNames
(
)
:
mFullnames
(
64
)
mPostscriptNames
(
64
)
{
}
FontEntryTable
mFullnames
;
FontEntryTable
mPostscriptNames
;
}
;
nsAutoPtr
<
ExtraNames
>
mExtraNames
;
nsAutoPtr
<
nsTHashtable
<
nsStringHashKey
>
>
mFaceNamesMissed
;
nsAutoPtr
<
nsTHashtable
<
nsStringHashKey
>
>
mOtherNamesMissed
;
typedef
nsTArray
<
RefPtr
<
gfxFontFamily
>
>
PrefFontList
;
typedef
mozilla
:
:
RangedArray
<
nsAutoPtr
<
PrefFontList
>
mozilla
:
:
eFamily_generic_first
mozilla
:
:
eFamily_generic_count
>
PrefFontsForLangGroup
;
mozilla
:
:
RangedArray
<
PrefFontsForLangGroup
eFontPrefLang_First
eFontPrefLang_Count
>
mLangGroupPrefFonts
;
gfxSparseBitSet
mCodepointsWithNoFonts
;
RefPtr
<
gfxFontFamily
>
mReplacementCharFallbackFamily
;
nsTHashtable
<
nsStringHashKey
>
mBadUnderlineFamilyNames
;
nsTHashtable
<
CharMapHashKey
>
mSharedCmaps
;
nsTArray
<
RefPtr
<
gfxFontFamily
>
>
mFontFamiliesToLoad
;
uint32_t
mStartIndex
;
uint32_t
mIncrement
;
uint32_t
mNumFamilies
;
uint32_t
mFontlistInitCount
;
nsTHashtable
<
nsPtrHashKey
<
gfxUserFontSet
>
>
mUserFontSetList
;
nsCOMPtr
<
nsILanguageAtomService
>
mLangService
;
nsTArray
<
uint32_t
>
mCJKPrefLangs
;
nsTArray
<
mozilla
:
:
FontFamilyType
>
mDefaultGenericsLangGroup
;
}
;
#
endif
