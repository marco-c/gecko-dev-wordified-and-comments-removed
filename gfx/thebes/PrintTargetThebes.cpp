#
include
"
PrintTargetThebes
.
h
"
#
include
"
gfxASurface
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
namespace
mozilla
{
namespace
gfx
{
already_AddRefed
<
PrintTargetThebes
>
PrintTargetThebes
:
:
CreateOrNull
(
gfxASurface
*
aSurface
)
{
MOZ_ASSERT
(
aSurface
)
;
if
(
!
aSurface
|
|
aSurface
-
>
CairoStatus
(
)
)
{
return
nullptr
;
}
RefPtr
<
PrintTargetThebes
>
target
=
new
PrintTargetThebes
(
aSurface
)
;
return
target
.
forget
(
)
;
}
PrintTargetThebes
:
:
PrintTargetThebes
(
gfxASurface
*
aSurface
)
:
PrintTarget
(
nullptr
aSurface
-
>
GetSize
(
)
)
mGfxSurface
(
aSurface
)
{
}
already_AddRefed
<
DrawTarget
>
PrintTargetThebes
:
:
MakeDrawTarget
(
const
IntSize
&
aSize
DrawEventRecorder
*
aRecorder
)
{
MOZ_ASSERT
(
mHasActivePage
"
We
can
'
t
guarantee
a
valid
DrawTarget
"
)
;
RefPtr
<
gfx
:
:
DrawTarget
>
dt
=
gfxPlatform
:
:
GetPlatform
(
)
-
>
CreateDrawTargetForSurface
(
mGfxSurface
aSize
)
;
if
(
!
dt
|
|
!
dt
-
>
IsValid
(
)
)
{
return
nullptr
;
}
if
(
aRecorder
)
{
dt
=
CreateRecordingDrawTarget
(
aRecorder
dt
)
;
if
(
!
dt
|
|
!
dt
-
>
IsValid
(
)
)
{
return
nullptr
;
}
}
return
dt
.
forget
(
)
;
}
already_AddRefed
<
DrawTarget
>
PrintTargetThebes
:
:
GetReferenceDrawTarget
(
DrawEventRecorder
*
aRecorder
)
{
if
(
!
mRefDT
)
{
RefPtr
<
gfx
:
:
DrawTarget
>
dt
=
gfxPlatform
:
:
GetPlatform
(
)
-
>
CreateDrawTargetForSurface
(
mGfxSurface
mSize
)
;
if
(
!
dt
|
|
!
dt
-
>
IsValid
(
)
)
{
return
nullptr
;
}
mRefDT
=
dt
-
>
CreateSimilarDrawTarget
(
IntSize
(
1
1
)
dt
-
>
GetFormat
(
)
)
;
}
if
(
aRecorder
)
{
if
(
!
mRecordingRefDT
)
{
RefPtr
<
DrawTarget
>
dt
=
CreateRecordingDrawTarget
(
aRecorder
mRefDT
)
;
if
(
!
dt
|
|
!
dt
-
>
IsValid
(
)
)
{
return
nullptr
;
}
mRecordingRefDT
=
dt
.
forget
(
)
;
#
ifdef
DEBUG
mRecorder
=
aRecorder
;
#
endif
}
#
ifdef
DEBUG
else
{
MOZ_ASSERT
(
aRecorder
=
=
mRecorder
"
Caching
mRecordingRefDT
assumes
the
aRecorder
is
an
invariant
"
)
;
}
#
endif
return
do_AddRef
(
mRecordingRefDT
)
;
}
return
do_AddRef
(
mRefDT
)
;
}
nsresult
PrintTargetThebes
:
:
BeginPrinting
(
const
nsAString
&
aTitle
const
nsAString
&
aPrintToFileName
int32_t
aStartPage
int32_t
aEndPage
)
{
return
mGfxSurface
-
>
BeginPrinting
(
aTitle
aPrintToFileName
)
;
}
nsresult
PrintTargetThebes
:
:
EndPrinting
(
)
{
return
mGfxSurface
-
>
EndPrinting
(
)
;
}
nsresult
PrintTargetThebes
:
:
AbortPrinting
(
)
{
#
ifdef
DEBUG
mHasActivePage
=
false
;
#
endif
return
mGfxSurface
-
>
AbortPrinting
(
)
;
}
nsresult
PrintTargetThebes
:
:
BeginPage
(
)
{
#
ifdef
DEBUG
mHasActivePage
=
true
;
#
endif
return
mGfxSurface
-
>
BeginPage
(
)
;
}
nsresult
PrintTargetThebes
:
:
EndPage
(
)
{
#
ifdef
DEBUG
mHasActivePage
=
false
;
#
endif
return
mGfxSurface
-
>
EndPage
(
)
;
}
void
PrintTargetThebes
:
:
Finish
(
)
{
return
mGfxSurface
-
>
Finish
(
)
;
}
}
}
