#
ifndef
GFX_FT2FONTLIST_H
#
define
GFX_FT2FONTLIST_H
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
gfxFT2FontBase
.
h
"
#
include
"
gfxPlatformFontList
.
h
"
#
include
"
nsTHashSet
.
h
"
namespace
mozilla
{
namespace
dom
{
class
SystemFontListEntry
;
}
;
}
;
class
FontNameCache
;
typedef
struct
FT_FaceRec_
*
FT_Face
;
class
nsZipArchive
;
class
WillShutdownObserver
;
class
FTUserFontData
;
class
FT2FontEntry
final
:
public
gfxFT2FontEntryBase
{
friend
class
gfxFT2FontList
;
using
FontListEntry
=
mozilla
:
:
dom
:
:
SystemFontListEntry
;
public
:
explicit
FT2FontEntry
(
const
nsACString
&
aFaceName
)
:
gfxFT2FontEntryBase
(
aFaceName
)
mFTFontIndex
(
0
)
{
}
~
FT2FontEntry
(
)
;
gfxFontEntry
*
Clone
(
)
const
override
;
const
nsCString
&
GetName
(
)
const
{
return
Name
(
)
;
}
static
FT2FontEntry
*
CreateFontEntry
(
const
nsACString
&
aFontName
WeightRange
aWeight
StretchRange
aStretch
SlantStyleRange
aStyle
const
uint8_t
*
aFontData
uint32_t
aLength
)
;
static
FT2FontEntry
*
CreateFontEntry
(
const
FontListEntry
&
aFLE
)
;
static
FT2FontEntry
*
CreateFontEntry
(
const
nsACString
&
aName
const
char
*
aFilename
uint8_t
aIndex
const
hb_face_t
*
aFace
)
;
gfxFont
*
CreateFontInstance
(
const
gfxFontStyle
*
aStyle
)
override
;
nsresult
ReadCMAP
(
FontInfoData
*
aFontInfoData
=
nullptr
)
override
;
hb_blob_t
*
GetFontTable
(
uint32_t
aTableTag
)
override
;
bool
HasFontTable
(
uint32_t
aTableTag
)
override
;
nsresult
CopyFontTable
(
uint32_t
aTableTag
nsTArray
<
uint8_t
>
&
)
override
;
bool
HasVariations
(
)
override
;
void
GetVariationAxes
(
nsTArray
<
gfxFontVariationAxis
>
&
aVariationAxes
)
override
;
void
GetVariationInstances
(
nsTArray
<
gfxFontVariationInstance
>
&
aInstances
)
override
;
void
CheckForBrokenFont
(
gfxFontFamily
*
aFamily
)
;
void
CheckForBrokenFont
(
const
nsACString
&
aFamilyKey
)
;
already_AddRefed
<
mozilla
:
:
gfx
:
:
SharedFTFace
>
GetFTFace
(
bool
aCommit
=
false
)
;
FTUserFontData
*
GetUserFontData
(
)
;
FT_MM_Var
*
GetMMVar
(
)
override
;
hb_face_t
*
CreateHBFace
(
)
const
;
void
AppendToFaceList
(
nsCString
&
aFaceList
const
nsACString
&
aFamilyName
const
nsACString
&
aPSName
const
nsACString
&
aFullName
FontVisibility
aVisibility
)
;
void
AddSizeOfExcludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
FontListSizes
*
aSizes
)
const
override
;
void
AddSizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
FontListSizes
*
aSizes
)
const
override
;
RefPtr
<
mozilla
:
:
gfx
:
:
SharedFTFace
>
mFTFace
;
FT_MM_Var
*
mMMVar
=
nullptr
;
nsCString
mFilename
;
uint8_t
mFTFontIndex
;
mozilla
:
:
ThreadSafeWeakPtr
<
mozilla
:
:
gfx
:
:
UnscaledFontFreeType
>
mUnscaledFont
;
nsTHashSet
<
uint32_t
>
mAvailableTables
;
bool
mHasVariations
=
false
;
bool
mHasVariationsInitialized
=
false
;
bool
mMMVarInitialized
=
false
;
}
;
class
FT2FontFamily
final
:
public
gfxFontFamily
{
using
FontListEntry
=
mozilla
:
:
dom
:
:
SystemFontListEntry
;
public
:
explicit
FT2FontFamily
(
const
nsACString
&
aName
FontVisibility
aVisibility
)
:
gfxFontFamily
(
aName
aVisibility
)
{
}
void
AddFacesToFontList
(
nsTArray
<
FontListEntry
>
*
aFontList
)
;
void
FinalizeMemberList
(
bool
aSortFaces
)
;
}
;
class
gfxFT2FontList
final
:
public
gfxPlatformFontList
{
using
FontListEntry
=
mozilla
:
:
dom
:
:
SystemFontListEntry
;
public
:
gfxFT2FontList
(
)
;
virtual
~
gfxFT2FontList
(
)
;
gfxFontEntry
*
CreateFontEntry
(
mozilla
:
:
fontlist
:
:
Face
*
aFace
const
mozilla
:
:
fontlist
:
:
Family
*
aFamily
)
override
;
gfxFontEntry
*
LookupLocalFont
(
nsPresContext
*
aPresContext
const
nsACString
&
aFontName
WeightRange
aWeightForEntry
StretchRange
aStretchForEntry
SlantStyleRange
aStyleForEntry
)
override
;
gfxFontEntry
*
MakePlatformFont
(
const
nsACString
&
aFontName
WeightRange
aWeightForEntry
StretchRange
aStretchForEntry
SlantStyleRange
aStyleForEntry
const
uint8_t
*
aFontData
uint32_t
aLength
)
override
;
void
WriteCache
(
)
;
void
ReadSystemFontList
(
mozilla
:
:
dom
:
:
SystemFontList
*
)
;
static
gfxFT2FontList
*
PlatformFontList
(
)
{
return
static_cast
<
gfxFT2FontList
*
>
(
gfxPlatformFontList
:
:
PlatformFontList
(
)
)
;
}
gfxFontFamily
*
CreateFontFamily
(
const
nsACString
&
aName
FontVisibility
aVisibility
)
const
override
;
void
WillShutdown
(
)
;
protected
:
typedef
enum
{
kUnknown
kStandard
}
StandardFile
;
nsresult
InitFontListForPlatform
(
)
REQUIRES
(
mLock
)
override
;
void
AppendFaceFromFontListEntry
(
const
FontListEntry
&
aFLE
StandardFile
aStdFile
)
REQUIRES
(
mLock
)
;
void
AppendFacesFromBlob
(
const
nsCString
&
aFileName
StandardFile
aStdFile
hb_blob_t
*
aBlob
FontNameCache
*
aCache
uint32_t
aTimestamp
uint32_t
aFilesize
)
REQUIRES
(
mLock
)
;
void
AppendFacesFromFontFile
(
const
nsCString
&
aFileName
FontNameCache
*
aCache
StandardFile
aStdFile
)
REQUIRES
(
mLock
)
;
void
AppendFacesFromOmnijarEntry
(
nsZipArchive
*
aReader
const
nsCString
&
aEntryName
FontNameCache
*
aCache
bool
aJarChanged
)
REQUIRES
(
mLock
)
;
void
InitSharedFontListForPlatform
(
)
REQUIRES
(
mLock
)
override
;
void
CollectInitData
(
const
FontListEntry
&
aFLE
const
nsCString
&
aPSName
const
nsCString
&
aFullName
StandardFile
aStdFile
)
;
typedef
void
(
*
CollectFunc
)
(
const
FontListEntry
&
aFLE
const
nsCString
&
aPSName
const
nsCString
&
aFullName
StandardFile
aStdFile
)
;
bool
AppendFacesFromCachedFaceList
(
CollectFunc
aCollectFace
const
nsCString
&
aFileName
const
nsCString
&
aFaceList
StandardFile
aStdFile
)
REQUIRES
(
mLock
)
;
void
AddFaceToList
(
const
nsCString
&
aEntryName
uint32_t
aIndex
StandardFile
aStdFile
hb_face_t
*
aFace
nsCString
&
aFaceList
)
REQUIRES
(
mLock
)
;
void
FindFonts
(
)
REQUIRES
(
mLock
)
;
void
FindFontsInOmnijar
(
FontNameCache
*
aCache
)
REQUIRES
(
mLock
)
;
void
FindFontsInDir
(
const
nsCString
&
aDir
FontNameCache
*
aFNC
)
REQUIRES
(
mLock
)
;
FontFamily
GetDefaultFontForPlatform
(
nsPresContext
*
aPresContext
const
gfxFontStyle
*
aStyle
nsAtom
*
aLanguage
=
nullptr
)
REQUIRES
(
mLock
)
override
;
nsTHashSet
<
nsCString
>
mSkipSpaceLookupCheckFamilies
;
private
:
mozilla
:
:
UniquePtr
<
FontNameCache
>
mFontNameCache
;
int64_t
mJarModifiedTime
;
RefPtr
<
WillShutdownObserver
>
mObserver
;
nsTArray
<
mozilla
:
:
fontlist
:
:
Family
:
:
InitData
>
mFamilyInitData
;
nsClassHashtable
<
nsCStringHashKey
nsTArray
<
mozilla
:
:
fontlist
:
:
Face
:
:
InitData
>
>
mFaceInitData
;
}
;
#
endif
