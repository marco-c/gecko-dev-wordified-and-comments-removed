#
include
"
SoftwareVsyncSource
.
h
"
#
include
"
base
/
task
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
nsThreadUtils
.
h
"
using
namespace
mozilla
;
SoftwareVsyncSource
:
:
SoftwareVsyncSource
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
mGlobalDisplay
=
new
SoftwareDisplay
(
)
;
}
SoftwareVsyncSource
:
:
~
SoftwareVsyncSource
(
)
{
auto
strongRef
=
mGlobalDisplay
;
mGlobalDisplay
=
nullptr
;
if
(
!
NS_IsMainThread
(
)
)
{
const
auto
fnRun
=
[
strongRef
]
(
)
{
}
;
strongRef
=
nullptr
;
already_AddRefed
<
mozilla
:
:
Runnable
>
runnable
=
NS_NewRunnableFunction
(
"
enqueue
~
SoftwareDisplay
"
fnRun
)
;
NS_DispatchToMainThread
(
std
:
:
move
(
runnable
)
0
)
;
}
}
SoftwareDisplay
:
:
SoftwareDisplay
(
)
:
mVsyncEnabled
(
false
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
const
double
rate
=
1000
.
0
/
(
double
)
gfxPlatform
:
:
GetSoftwareVsyncRate
(
)
;
mVsyncRate
=
mozilla
:
:
TimeDuration
:
:
FromMilliseconds
(
rate
)
;
mVsyncThread
=
new
base
:
:
Thread
(
"
SoftwareVsyncThread
"
)
;
MOZ_RELEASE_ASSERT
(
mVsyncThread
-
>
Start
(
)
"
GFX
:
Could
not
start
software
vsync
thread
"
)
;
}
SoftwareDisplay
:
:
~
SoftwareDisplay
(
)
=
default
;
void
SoftwareDisplay
:
:
EnableVsync
(
)
{
MOZ_ASSERT
(
mVsyncThread
-
>
IsRunning
(
)
)
;
if
(
NS_IsMainThread
(
)
)
{
if
(
mVsyncEnabled
)
{
return
;
}
mVsyncEnabled
=
true
;
mVsyncThread
-
>
message_loop
(
)
-
>
PostTask
(
NewRunnableMethod
(
"
SoftwareDisplay
:
:
EnableVsync
"
this
&
SoftwareDisplay
:
:
EnableVsync
)
)
;
return
;
}
MOZ_ASSERT
(
IsInSoftwareVsyncThread
(
)
)
;
TimeStamp
vsyncTime
=
TimeStamp
:
:
Now
(
)
;
TimeStamp
outputTime
=
vsyncTime
+
mVsyncRate
;
NotifyVsync
(
vsyncTime
outputTime
)
;
}
void
SoftwareDisplay
:
:
DisableVsync
(
)
{
MOZ_ASSERT
(
mVsyncThread
-
>
IsRunning
(
)
)
;
if
(
NS_IsMainThread
(
)
)
{
if
(
!
mVsyncEnabled
)
{
return
;
}
mVsyncEnabled
=
false
;
mVsyncThread
-
>
message_loop
(
)
-
>
PostTask
(
NewRunnableMethod
(
"
SoftwareDisplay
:
:
DisableVsync
"
this
&
SoftwareDisplay
:
:
DisableVsync
)
)
;
return
;
}
MOZ_ASSERT
(
IsInSoftwareVsyncThread
(
)
)
;
if
(
mCurrentVsyncTask
)
{
mCurrentVsyncTask
-
>
Cancel
(
)
;
mCurrentVsyncTask
=
nullptr
;
}
}
bool
SoftwareDisplay
:
:
IsVsyncEnabled
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
return
mVsyncEnabled
;
}
bool
SoftwareDisplay
:
:
IsInSoftwareVsyncThread
(
)
{
return
mVsyncThread
-
>
thread_id
(
)
=
=
PlatformThread
:
:
CurrentId
(
)
;
}
void
SoftwareDisplay
:
:
NotifyVsync
(
const
mozilla
:
:
TimeStamp
&
aVsyncTimestamp
const
mozilla
:
:
TimeStamp
&
aOutputTimestamp
)
{
MOZ_ASSERT
(
IsInSoftwareVsyncThread
(
)
)
;
mozilla
:
:
TimeStamp
displayVsyncTime
=
aVsyncTimestamp
;
mozilla
:
:
TimeStamp
now
=
mozilla
:
:
TimeStamp
:
:
Now
(
)
;
if
(
aVsyncTimestamp
>
now
)
{
displayVsyncTime
=
now
;
}
Display
:
:
NotifyVsync
(
displayVsyncTime
aOutputTimestamp
)
;
ScheduleNextVsync
(
aVsyncTimestamp
)
;
}
mozilla
:
:
TimeDuration
SoftwareDisplay
:
:
GetVsyncRate
(
)
{
return
mVsyncRate
;
}
void
SoftwareDisplay
:
:
ScheduleNextVsync
(
mozilla
:
:
TimeStamp
aVsyncTimestamp
)
{
MOZ_ASSERT
(
IsInSoftwareVsyncThread
(
)
)
;
mozilla
:
:
TimeStamp
nextVsync
=
aVsyncTimestamp
+
mVsyncRate
;
mozilla
:
:
TimeDuration
delay
=
nextVsync
-
mozilla
:
:
TimeStamp
:
:
Now
(
)
;
if
(
delay
.
ToMilliseconds
(
)
<
0
)
{
delay
=
mozilla
:
:
TimeDuration
:
:
FromMilliseconds
(
0
)
;
nextVsync
=
mozilla
:
:
TimeStamp
:
:
Now
(
)
;
}
TimeStamp
outputTime
=
nextVsync
+
mVsyncRate
;
mCurrentVsyncTask
=
NewCancelableRunnableMethod
<
mozilla
:
:
TimeStamp
mozilla
:
:
TimeStamp
>
(
"
SoftwareDisplay
:
:
NotifyVsync
"
this
&
SoftwareDisplay
:
:
NotifyVsync
nextVsync
outputTime
)
;
RefPtr
<
Runnable
>
addrefedTask
=
mCurrentVsyncTask
;
mVsyncThread
-
>
message_loop
(
)
-
>
PostDelayedTask
(
addrefedTask
.
forget
(
)
delay
.
ToMilliseconds
(
)
)
;
}
void
SoftwareDisplay
:
:
Shutdown
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
DisableVsync
(
)
;
mVsyncThread
-
>
Stop
(
)
;
delete
mVsyncThread
;
}
