#
ifndef
GFXFCPLATFORMFONTLIST_H_
#
define
GFXFCPLATFORMFONTLIST_H_
#
include
"
gfxFont
.
h
"
#
include
"
gfxFontEntry
.
h
"
#
include
"
gfxFT2FontBase
.
h
"
#
include
"
gfxPlatformFontList
.
h
"
#
include
"
mozilla
/
FontPropertyTypes
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
nsAutoRef
.
h
"
#
include
"
nsClassHashtable
.
h
"
#
include
<
fontconfig
/
fontconfig
.
h
>
#
include
"
ft2build
.
h
"
#
include
FT_FREETYPE_H
#
include
FT_TRUETYPE_TABLES_H
#
include
FT_MULTIPLE_MASTERS_H
#
include
<
cairo
.
h
>
#
include
<
cairo
-
ft
.
h
>
#
if
defined
(
MOZ_CONTENT_SANDBOX
)
&
&
defined
(
XP_LINUX
)
#
include
"
mozilla
/
SandboxBroker
.
h
"
#
endif
namespace
mozilla
{
namespace
dom
{
class
SystemFontListEntry
;
}
;
}
;
template
<
>
class
nsAutoRefTraits
<
FcPattern
>
:
public
nsPointerRefTraits
<
FcPattern
>
{
public
:
static
void
Release
(
FcPattern
*
ptr
)
{
FcPatternDestroy
(
ptr
)
;
}
static
void
AddRef
(
FcPattern
*
ptr
)
{
FcPatternReference
(
ptr
)
;
}
}
;
template
<
>
class
nsAutoRefTraits
<
FcConfig
>
:
public
nsPointerRefTraits
<
FcConfig
>
{
public
:
static
void
Release
(
FcConfig
*
ptr
)
{
FcConfigDestroy
(
ptr
)
;
}
static
void
AddRef
(
FcConfig
*
ptr
)
{
FcConfigReference
(
ptr
)
;
}
}
;
class
FTUserFontData
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
FTUserFontData
)
explicit
FTUserFontData
(
FT_Face
aFace
const
uint8_t
*
aData
)
:
mFace
(
aFace
)
mFontData
(
aData
)
{
}
const
uint8_t
*
FontData
(
)
const
{
return
mFontData
;
}
private
:
~
FTUserFontData
(
)
{
mozilla
:
:
gfx
:
:
Factory
:
:
ReleaseFTFace
(
mFace
)
;
if
(
mFontData
)
{
free
(
(
void
*
)
mFontData
)
;
}
}
FT_Face
mFace
;
const
uint8_t
*
mFontData
;
}
;
class
gfxFontconfigFontEntry
:
public
gfxFontEntry
{
public
:
explicit
gfxFontconfigFontEntry
(
const
nsAString
&
aFaceName
FcPattern
*
aFontPattern
bool
aIgnoreFcCharmap
)
;
explicit
gfxFontconfigFontEntry
(
const
nsAString
&
aFaceName
WeightRange
aWeight
StretchRange
aStretch
SlantStyleRange
aStyle
const
uint8_t
*
aData
uint32_t
aLength
FT_Face
aFace
)
;
explicit
gfxFontconfigFontEntry
(
const
nsAString
&
aFaceName
FcPattern
*
aFontPattern
WeightRange
aWeight
StretchRange
aStretch
SlantStyleRange
aStyle
)
;
gfxFontEntry
*
Clone
(
)
const
override
;
FcPattern
*
GetPattern
(
)
{
return
mFontPattern
;
}
nsresult
ReadCMAP
(
FontInfoData
*
aFontInfoData
=
nullptr
)
override
;
bool
TestCharacterMap
(
uint32_t
aCh
)
override
;
FT_Face
GetFTFace
(
)
;
FT_MM_Var
*
GetMMVar
(
)
override
;
bool
HasVariations
(
)
override
;
void
GetVariationAxes
(
nsTArray
<
gfxFontVariationAxis
>
&
aAxes
)
override
;
void
GetVariationInstances
(
nsTArray
<
gfxFontVariationInstance
>
&
aInstances
)
override
;
hb_blob_t
*
GetFontTable
(
uint32_t
aTableTag
)
override
;
void
ForgetHBFace
(
)
override
;
void
ReleaseGrFace
(
gr_face
*
aFace
)
override
;
double
GetAspect
(
)
;
protected
:
virtual
~
gfxFontconfigFontEntry
(
)
;
gfxFont
*
CreateFontInstance
(
const
gfxFontStyle
*
aFontStyle
)
override
;
cairo_scaled_font_t
*
CreateScaledFont
(
FcPattern
*
aRenderPattern
gfxFloat
aAdjustedSize
const
gfxFontStyle
*
aStyle
FT_Face
aFTFace
)
;
virtual
nsresult
CopyFontTable
(
uint32_t
aTableTag
nsTArray
<
uint8_t
>
&
aBuffer
)
override
;
void
MaybeReleaseFTFace
(
)
;
nsCountedRef
<
FcPattern
>
mFontPattern
;
RefPtr
<
FTUserFontData
>
mUserFontData
;
FT_Face
mFTFace
;
bool
mFTFaceInitialized
;
bool
mIgnoreFcCharmap
;
bool
mHasVariations
;
bool
mHasVariationsInitialized
;
double
mAspect
;
const
uint8_t
*
mFontData
;
uint32_t
mLength
;
class
UnscaledFontCache
{
public
:
already_AddRefed
<
mozilla
:
:
gfx
:
:
UnscaledFontFontconfig
>
Lookup
(
const
char
*
aFile
uint32_t
aIndex
)
;
void
Add
(
const
RefPtr
<
mozilla
:
:
gfx
:
:
UnscaledFontFontconfig
>
&
aUnscaledFont
)
{
mUnscaledFonts
[
kNumEntries
-
1
]
=
aUnscaledFont
;
MoveToFront
(
kNumEntries
-
1
)
;
}
private
:
void
MoveToFront
(
size_t
aIndex
)
;
static
const
size_t
kNumEntries
=
3
;
mozilla
:
:
ThreadSafeWeakPtr
<
mozilla
:
:
gfx
:
:
UnscaledFontFontconfig
>
mUnscaledFonts
[
kNumEntries
]
;
}
;
UnscaledFontCache
mUnscaledFontCache
;
FT_MM_Var
*
mMMVar
=
nullptr
;
bool
mMMVarInitialized
=
false
;
}
;
class
gfxFontconfigFontFamily
:
public
gfxFontFamily
{
public
:
explicit
gfxFontconfigFontFamily
(
const
nsAString
&
aName
)
:
gfxFontFamily
(
aName
)
mContainsAppFonts
(
false
)
mHasNonScalableFaces
(
false
)
mForceScalable
(
false
)
{
}
template
<
typename
Func
>
void
AddFacesToFontList
(
Func
aAddPatternFunc
)
;
void
FindStyleVariations
(
FontInfoData
*
aFontInfoData
=
nullptr
)
override
;
void
AddFontPattern
(
FcPattern
*
aFontPattern
)
;
void
SetFamilyContainsAppFonts
(
bool
aContainsAppFonts
)
{
mContainsAppFonts
=
aContainsAppFonts
;
}
void
FindAllFontsForStyle
(
const
gfxFontStyle
&
aFontStyle
nsTArray
<
gfxFontEntry
*
>
&
aFontEntryList
bool
aIgnoreSizeTolerance
)
override
;
bool
FilterForFontList
(
nsAtom
*
aLangGroup
const
nsACString
&
aGeneric
)
const
final
{
return
SupportsLangGroup
(
aLangGroup
)
;
}
protected
:
virtual
~
gfxFontconfigFontFamily
(
)
;
bool
SupportsLangGroup
(
nsAtom
*
aLangGroup
)
const
;
nsTArray
<
nsCountedRef
<
FcPattern
>
>
mFontPatterns
;
bool
mContainsAppFonts
;
bool
mHasNonScalableFaces
;
bool
mForceScalable
;
}
;
class
gfxFontconfigFont
:
public
gfxFT2FontBase
{
public
:
gfxFontconfigFont
(
const
RefPtr
<
mozilla
:
:
gfx
:
:
UnscaledFontFontconfig
>
&
aUnscaledFont
cairo_scaled_font_t
*
aScaledFont
FcPattern
*
aPattern
gfxFloat
aAdjustedSize
gfxFontEntry
*
aFontEntry
const
gfxFontStyle
*
aFontStyle
)
;
virtual
FontType
GetType
(
)
const
override
{
return
FONT_TYPE_FONTCONFIG
;
}
virtual
FcPattern
*
GetPattern
(
)
const
{
return
mPattern
;
}
virtual
already_AddRefed
<
mozilla
:
:
gfx
:
:
ScaledFont
>
GetScaledFont
(
DrawTarget
*
aTarget
)
override
;
private
:
virtual
~
gfxFontconfigFont
(
)
;
nsCountedRef
<
FcPattern
>
mPattern
;
}
;
class
gfxFcPlatformFontList
:
public
gfxPlatformFontList
{
public
:
gfxFcPlatformFontList
(
)
;
static
gfxFcPlatformFontList
*
PlatformFontList
(
)
{
return
static_cast
<
gfxFcPlatformFontList
*
>
(
sPlatformFontList
)
;
}
virtual
nsresult
InitFontListForPlatform
(
)
override
;
void
GetFontList
(
nsAtom
*
aLangGroup
const
nsACString
&
aGenericFamily
nsTArray
<
nsString
>
&
aListOfFonts
)
override
;
void
ReadSystemFontList
(
InfallibleTArray
<
mozilla
:
:
dom
:
:
SystemFontListEntry
>
*
retValue
)
;
gfxFontEntry
*
LookupLocalFont
(
const
nsAString
&
aFontName
WeightRange
aWeightForEntry
StretchRange
aStretchForEntry
SlantStyleRange
aStyleForEntry
)
override
;
gfxFontEntry
*
MakePlatformFont
(
const
nsAString
&
aFontName
WeightRange
aWeightForEntry
StretchRange
aStretchForEntry
SlantStyleRange
aStyleForEntry
const
uint8_t
*
aFontData
uint32_t
aLength
)
override
;
bool
FindAndAddFamilies
(
const
nsAString
&
aFamily
nsTArray
<
FamilyAndGeneric
>
*
aOutput
FindFamiliesFlags
aFlags
gfxFontStyle
*
aStyle
=
nullptr
gfxFloat
aDevToCssSize
=
1
.
0
)
override
;
bool
GetStandardFamilyName
(
const
nsAString
&
aFontName
nsAString
&
aFamilyName
)
override
;
FcConfig
*
GetLastConfig
(
)
const
{
return
mLastConfig
;
}
void
AddGenericFonts
(
mozilla
:
:
FontFamilyType
aGenericType
nsAtom
*
aLanguage
nsTArray
<
FamilyAndGeneric
>
&
aFamilyList
)
override
;
void
ClearLangGroupPrefFonts
(
)
override
;
void
ClearGenericMappings
(
)
{
mGenericMappings
.
Clear
(
)
;
}
void
GetSampleLangForGroup
(
nsAtom
*
aLanguage
nsACString
&
aLangStr
bool
aForFontEnumerationThread
=
false
)
;
static
FT_Library
GetFTLibrary
(
)
;
protected
:
virtual
~
gfxFcPlatformFontList
(
)
;
#
ifdef
MOZ_CONTENT_SANDBOX
typedef
mozilla
:
:
SandboxBroker
:
:
Policy
SandboxPolicy
;
#
else
struct
SandboxPolicy
{
}
;
#
endif
void
AddFontSetFamilies
(
FcFontSet
*
aFontSet
const
SandboxPolicy
*
aPolicy
bool
aAppFonts
)
;
void
AddPatternToFontList
(
FcPattern
*
aFont
FcChar8
*
&
aLastFamilyName
nsAString
&
aFamilyName
RefPtr
<
gfxFontconfigFontFamily
>
&
aFontFamily
bool
aAppFonts
)
;
PrefFontList
*
FindGenericFamilies
(
const
nsAString
&
aGeneric
nsAtom
*
aLanguage
)
;
bool
PrefFontListsUseOnlyGenerics
(
)
;
static
void
CheckFontUpdates
(
nsITimer
*
aTimer
void
*
aThis
)
;
virtual
gfxFontFamily
*
GetDefaultFontForPlatform
(
const
gfxFontStyle
*
aStyle
)
override
;
gfxFontFamily
*
CreateFontFamily
(
const
nsAString
&
aName
)
const
override
;
bool
TryLangForGroup
(
const
nsACString
&
aOSLang
nsAtom
*
aLangGroup
nsACString
&
aLang
bool
aForFontEnumerationThread
)
;
#
ifdef
MOZ_BUNDLED_FONTS
void
ActivateBundledFonts
(
)
;
nsCString
mBundledFontsPath
;
bool
mBundledFontsInitialized
;
#
endif
nsBaseHashtable
<
nsStringHashKey
nsCountedRef
<
FcPattern
>
FcPattern
*
>
mLocalNames
;
nsClassHashtable
<
nsCStringHashKey
PrefFontList
>
mGenericMappings
;
nsDataHashtable
<
nsCStringHashKey
nsTArray
<
FamilyAndGeneric
>
>
mFcSubstituteCache
;
nsCOMPtr
<
nsITimer
>
mCheckFontUpdatesTimer
;
nsCountedRef
<
FcConfig
>
mLastConfig
;
bool
mAlwaysUseFontconfigGenerics
;
static
FT_Library
sCairoFTLibrary
;
}
;
#
endif
