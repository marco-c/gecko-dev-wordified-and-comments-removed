#
ifndef
GFX_VSYNCSOURCE_H
#
define
GFX_VSYNCSOURCE_H
#
include
"
nsTArray
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
nsISupportsImpl
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
namespace
mozilla
{
class
RefreshTimerVsyncDispatcher
;
class
CompositorVsyncDispatcher
;
class
VsyncObserver
;
struct
VsyncEvent
;
class
VsyncIdType
{
}
;
typedef
layers
:
:
BaseTransactionId
<
VsyncIdType
>
VsyncId
;
namespace
gfx
{
class
VsyncSource
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
VsyncSource
)
typedef
mozilla
:
:
RefreshTimerVsyncDispatcher
RefreshTimerVsyncDispatcher
;
typedef
mozilla
:
:
CompositorVsyncDispatcher
CompositorVsyncDispatcher
;
public
:
class
Display
{
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
Display
)
public
:
Display
(
)
;
virtual
void
NotifyVsync
(
const
TimeStamp
&
aVsyncTimestamp
const
TimeStamp
&
aOutputTimestamp
)
;
void
NotifyGenericObservers
(
VsyncEvent
aEvent
)
;
RefPtr
<
RefreshTimerVsyncDispatcher
>
GetRefreshTimerVsyncDispatcher
(
)
;
void
RegisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
DeregisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
EnableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
DisableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
AddGenericObserver
(
VsyncObserver
*
aObserver
)
;
void
RemoveGenericObserver
(
VsyncObserver
*
aObserver
)
;
void
MoveListenersToNewSource
(
const
RefPtr
<
VsyncSource
>
&
aNewSource
)
;
void
NotifyRefreshTimerVsyncStatus
(
bool
aEnable
)
;
virtual
TimeDuration
GetVsyncRate
(
)
;
virtual
void
EnableVsync
(
)
=
0
;
virtual
void
DisableVsync
(
)
=
0
;
virtual
bool
IsVsyncEnabled
(
)
=
0
;
virtual
void
Shutdown
(
)
=
0
;
protected
:
virtual
~
Display
(
)
;
private
:
void
UpdateVsyncStatus
(
)
;
Mutex
mDispatcherLock
;
bool
mRefreshTimerNeedsVsync
;
nsTArray
<
RefPtr
<
CompositorVsyncDispatcher
>
>
mEnabledCompositorVsyncDispatchers
;
nsTArray
<
RefPtr
<
CompositorVsyncDispatcher
>
>
mRegisteredCompositorVsyncDispatchers
;
RefPtr
<
RefreshTimerVsyncDispatcher
>
mRefreshTimerVsyncDispatcher
;
nsTArray
<
RefPtr
<
VsyncObserver
>
>
mGenericObservers
;
VsyncId
mVsyncId
;
VsyncId
mLastVsyncIdSentToMainThread
;
VsyncId
mLastMainThreadProcessedVsyncId
;
bool
mHasGenericObservers
;
}
;
void
EnableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
DisableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
RegisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
DeregisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
;
void
AddGenericObserver
(
VsyncObserver
*
aObserver
)
;
void
RemoveGenericObserver
(
VsyncObserver
*
aObserver
)
;
void
MoveListenersToNewSource
(
const
RefPtr
<
VsyncSource
>
&
aNewSource
)
;
RefPtr
<
RefreshTimerVsyncDispatcher
>
GetRefreshTimerVsyncDispatcher
(
)
;
virtual
Display
&
GetGlobalDisplay
(
)
=
0
;
void
Shutdown
(
)
;
static
Maybe
<
TimeDuration
>
GetFastestVsyncRate
(
)
;
protected
:
virtual
~
VsyncSource
(
)
=
default
;
}
;
}
struct
VsyncEvent
{
VsyncId
mId
;
TimeStamp
mTime
;
TimeStamp
mOutputTime
;
VsyncEvent
(
const
VsyncId
&
aId
const
TimeStamp
&
aVsyncTime
const
TimeStamp
&
aOutputTime
)
:
mId
(
aId
)
mTime
(
aVsyncTime
)
mOutputTime
(
aOutputTime
)
{
}
VsyncEvent
(
)
=
default
;
}
;
}
#
endif
