#
ifndef
GFX_WINDOWS_PLATFORM_H
#
define
GFX_WINDOWS_PLATFORM_H
#
include
"
cairo
-
win32
.
h
"
#
include
"
gfxCrashReporterUtils
.
h
"
#
include
"
gfxFontUtils
.
h
"
#
include
"
gfxWindowsSurface
.
h
"
#
include
"
gfxFont
.
h
"
#
include
"
gfxDWriteFonts
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
gfxTelemetry
.
h
"
#
include
"
gfxTypes
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsDataHashtable
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
<
windows
.
h
>
#
include
<
objbase
.
h
>
#
include
<
dxgi
.
h
>
#
include
<
d3dcommon
.
h
>
#
if
!
defined
(
D3D_FEATURE_LEVEL_11_1
)
#
define
D3D_FEATURE_LEVEL_11_1
static_cast
<
D3D_FEATURE_LEVEL
>
(
0xb100
)
#
define
D3D_FL9_1_REQ_TEXTURE2D_U_OR_V_DIMENSION
2048
#
define
D3D_FL9_3_REQ_TEXTURE2D_U_OR_V_DIMENSION
4096
#
endif
namespace
mozilla
{
namespace
gfx
{
class
DrawTarget
;
}
namespace
layers
{
class
DeviceManagerD3D9
;
class
ReadbackManagerD3D11
;
}
}
struct
IDirect3DDevice9
;
struct
ID3D11Device
;
struct
IDXGIAdapter1
;
class
MOZ_STACK_CLASS
DCFromDrawTarget
final
{
public
:
DCFromDrawTarget
(
mozilla
:
:
gfx
:
:
DrawTarget
&
aDrawTarget
)
;
~
DCFromDrawTarget
(
)
{
if
(
mNeedsRelease
)
{
ReleaseDC
(
nullptr
mDC
)
;
}
else
{
RestoreDC
(
mDC
-
1
)
;
}
}
operator
HDC
(
)
{
return
mDC
;
}
private
:
HDC
mDC
;
bool
mNeedsRelease
;
}
;
struct
ClearTypeParameterInfo
{
ClearTypeParameterInfo
(
)
:
gamma
(
-
1
)
pixelStructure
(
-
1
)
clearTypeLevel
(
-
1
)
enhancedContrast
(
-
1
)
{
}
nsString
displayName
;
int32_t
gamma
;
int32_t
pixelStructure
;
int32_t
clearTypeLevel
;
int32_t
enhancedContrast
;
}
;
class
gfxWindowsPlatform
:
public
gfxPlatform
{
public
:
enum
TextRenderingMode
{
TEXT_RENDERING_NO_CLEARTYPE
TEXT_RENDERING_NORMAL
TEXT_RENDERING_GDI_CLASSIC
TEXT_RENDERING_COUNT
}
;
gfxWindowsPlatform
(
)
;
virtual
~
gfxWindowsPlatform
(
)
;
static
gfxWindowsPlatform
*
GetPlatform
(
)
{
return
(
gfxWindowsPlatform
*
)
gfxPlatform
:
:
GetPlatform
(
)
;
}
virtual
gfxPlatformFontList
*
CreatePlatformFontList
(
)
override
;
virtual
already_AddRefed
<
gfxASurface
>
CreateOffscreenSurface
(
const
IntSize
&
aSize
gfxImageFormat
aFormat
)
override
;
virtual
already_AddRefed
<
mozilla
:
:
gfx
:
:
ScaledFont
>
GetScaledFontForFont
(
mozilla
:
:
gfx
:
:
DrawTarget
*
aTarget
gfxFont
*
aFont
)
override
;
enum
RenderMode
{
RENDER_GDI
=
0
RENDER_IMAGE_STRETCH32
RENDER_IMAGE_STRETCH24
RENDER_DIRECT2D
RENDER_MODE_MAX
}
;
RenderMode
GetRenderMode
(
)
{
return
mRenderMode
;
}
void
SetRenderMode
(
RenderMode
rmode
)
{
mRenderMode
=
rmode
;
}
void
UpdateRenderMode
(
)
;
void
ForceDeviceReset
(
ForcedDeviceResetReason
aReason
)
;
void
VerifyD2DDevice
(
bool
aAttemptForce
)
;
nsresult
GetFontList
(
nsIAtom
*
aLangGroup
const
nsACString
&
aGenericFamily
nsTArray
<
nsString
>
&
aListOfFonts
)
override
;
nsresult
UpdateFontList
(
)
;
virtual
void
GetCommonFallbackFonts
(
uint32_t
aCh
uint32_t
aNextCh
int32_t
aRunScript
nsTArray
<
const
char
*
>
&
aFontList
)
override
;
nsresult
GetStandardFamilyName
(
const
nsAString
&
aFontName
nsAString
&
aFamilyName
)
override
;
gfxFontGroup
*
CreateFontGroup
(
const
mozilla
:
:
FontFamilyList
&
aFontFamilyList
const
gfxFontStyle
*
aStyle
gfxTextPerfMetrics
*
aTextPerf
gfxUserFontSet
*
aUserFontSet
gfxFloat
aDevToCssSize
)
override
;
virtual
gfxFontEntry
*
LookupLocalFont
(
const
nsAString
&
aFontName
uint16_t
aWeight
int16_t
aStretch
uint8_t
aStyle
)
override
;
virtual
gfxFontEntry
*
MakePlatformFont
(
const
nsAString
&
aFontName
uint16_t
aWeight
int16_t
aStretch
uint8_t
aStyle
const
uint8_t
*
aFontData
uint32_t
aLength
)
override
;
virtual
bool
CanUseHardwareVideoDecoding
(
)
override
;
virtual
bool
IsFontFormatSupported
(
nsIURI
*
aFontURI
uint32_t
aFormatFlags
)
override
;
bool
DidRenderingDeviceReset
(
DeviceResetReason
*
aResetReason
=
nullptr
)
override
;
bool
UpdateForDeviceReset
(
)
override
;
mozilla
:
:
gfx
:
:
BackendType
GetContentBackendFor
(
mozilla
:
:
layers
:
:
LayersBackend
aLayers
)
override
;
bool
UseClearTypeForDownloadableFonts
(
)
;
bool
UseClearTypeAlways
(
)
;
static
void
GetDLLVersion
(
char16ptr_t
aDLLPath
nsAString
&
aVersion
)
;
static
void
GetCleartypeParams
(
nsTArray
<
ClearTypeParameterInfo
>
&
aParams
)
;
virtual
void
FontsPrefsChanged
(
const
char
*
aPref
)
override
;
void
SetupClearTypeParams
(
)
;
IDWriteFactory
*
GetDWriteFactory
(
)
{
return
mDWriteFactory
;
}
inline
bool
DWriteEnabled
(
)
{
return
!
!
mDWriteFactory
;
}
inline
DWRITE_MEASURING_MODE
DWriteMeasuringMode
(
)
{
return
mMeasuringMode
;
}
IDWriteRenderingParams
*
GetRenderingParams
(
TextRenderingMode
aRenderMode
)
{
return
mRenderingParams
[
aRenderMode
]
;
}
void
OnDeviceManagerDestroy
(
mozilla
:
:
layers
:
:
DeviceManagerD3D9
*
aDeviceManager
)
;
mozilla
:
:
layers
:
:
DeviceManagerD3D9
*
GetD3D9DeviceManager
(
)
;
IDirect3DDevice9
*
GetD3D9Device
(
)
;
ID3D11Device
*
GetD3D11Device
(
)
;
ID3D11Device
*
GetD3D11ContentDevice
(
)
;
ID3D11Device
*
GetD3D11DeviceForCurrentThread
(
)
;
ID3D11Device
*
GetD3D11ImageBridgeDevice
(
)
;
already_AddRefed
<
ID3D11Device
>
CreateD3D11DecoderDevice
(
)
;
bool
CreateD3D11DecoderDeviceHelper
(
IDXGIAdapter1
*
aAdapter
RefPtr
<
ID3D11Device
>
&
aDevice
HRESULT
&
aResOut
)
;
mozilla
:
:
layers
:
:
ReadbackManagerD3D11
*
GetReadbackManager
(
)
;
static
bool
IsOptimus
(
)
;
bool
IsWARP
(
)
{
return
mIsWARP
;
}
bool
CompositorD3D11TextureSharingWorks
(
)
const
{
return
mCompositorD3D11TextureSharingWorks
;
}
bool
SupportsApzWheelInput
(
)
const
override
{
return
true
;
}
bool
SupportsApzTouchInput
(
)
const
override
;
bool
HandleDeviceReset
(
)
;
void
UpdateBackendPrefs
(
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
GetD3D11Status
(
)
const
;
mozilla
:
:
gfx
:
:
FeatureStatus
GetD2D1Status
(
)
const
;
unsigned
GetD3D11Version
(
)
;
void
TestDeviceReset
(
DeviceResetReason
aReason
)
override
;
virtual
already_AddRefed
<
mozilla
:
:
gfx
:
:
VsyncSource
>
CreateHardwareVsyncSource
(
)
override
;
static
mozilla
:
:
Atomic
<
size_t
>
sD3D11MemoryUsed
;
static
mozilla
:
:
Atomic
<
size_t
>
sD3D9MemoryUsed
;
static
mozilla
:
:
Atomic
<
size_t
>
sD3D9SharedTextureUsed
;
void
GetDeviceInitData
(
mozilla
:
:
gfx
:
:
DeviceInitData
*
aOut
)
override
;
bool
SupportsPluginDirectBitmapDrawing
(
)
override
{
return
true
;
}
bool
SupportsPluginDirectDXGIDrawing
(
)
;
protected
:
bool
AccelerateLayersByDefault
(
)
override
{
return
true
;
}
void
GetAcceleratedCompositorBackends
(
nsTArray
<
mozilla
:
:
layers
:
:
LayersBackend
>
&
aBackends
)
override
;
virtual
void
GetPlatformCMSOutputProfile
(
void
*
&
mem
size_t
&
size
)
override
;
void
SetDeviceInitData
(
mozilla
:
:
gfx
:
:
DeviceInitData
&
aData
)
override
;
protected
:
RenderMode
mRenderMode
;
int8_t
mUseClearTypeForDownloadableFonts
;
int8_t
mUseClearTypeAlways
;
private
:
void
Init
(
)
;
void
InitializeDevices
(
)
;
void
InitializeD3D11
(
)
;
void
InitializeD2D
(
)
;
bool
InitDWriteSupport
(
)
;
void
DisableD2D
(
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
CheckAccelerationSupport
(
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
CheckD3D11Support
(
bool
*
aCanUseHardware
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
CheckD2D1Support
(
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
AttemptD3D11DeviceCreation
(
)
;
bool
AttemptD3D11DeviceCreationHelper
(
IDXGIAdapter1
*
aAdapter
HRESULT
&
aResOut
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
AttemptWARPDeviceCreation
(
)
;
bool
AttemptWARPDeviceCreationHelper
(
mozilla
:
:
ScopedGfxFeatureReporter
&
aReporterWARP
HRESULT
&
aResOut
)
;
bool
AttemptD3D11ImageBridgeDeviceCreationHelper
(
IDXGIAdapter1
*
aAdapter
HRESULT
&
aResOut
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
AttemptD3D11ImageBridgeDeviceCreation
(
)
;
mozilla
:
:
gfx
:
:
FeatureStatus
AttemptD3D11ContentDeviceCreation
(
)
;
bool
AttemptD3D11ContentDeviceCreationHelper
(
IDXGIAdapter1
*
aAdapter
HRESULT
&
aResOut
)
;
bool
CanUseD3D11ImageBridge
(
)
;
bool
ContentAdapterIsParentAdapter
(
ID3D11Device
*
device
)
;
void
DisableD3D11AfterCrash
(
)
;
void
ResetD3D11Devices
(
)
;
IDXGIAdapter1
*
GetDXGIAdapter
(
)
;
bool
IsDeviceReset
(
HRESULT
hr
DeviceResetReason
*
aReason
)
;
RefPtr
<
IDWriteFactory
>
mDWriteFactory
;
RefPtr
<
IDWriteRenderingParams
>
mRenderingParams
[
TEXT_RENDERING_COUNT
]
;
DWRITE_MEASURING_MODE
mMeasuringMode
;
RefPtr
<
IDXGIAdapter1
>
mAdapter
;
RefPtr
<
mozilla
:
:
layers
:
:
DeviceManagerD3D9
>
mDeviceManager
;
RefPtr
<
ID3D11Device
>
mD3D11Device
;
RefPtr
<
ID3D11Device
>
mD3D11ContentDevice
;
RefPtr
<
ID3D11Device
>
mD3D11ImageBridgeDevice
;
RefPtr
<
mozilla
:
:
layers
:
:
ReadbackManagerD3D11
>
mD3D11ReadbackManager
;
bool
mIsWARP
;
bool
mHasDeviceReset
;
bool
mHasFakeDeviceReset
;
bool
mCompositorD3D11TextureSharingWorks
;
DeviceResetReason
mDeviceResetReason
;
mozilla
:
:
gfx
:
:
FeatureStatus
mAcceleration
;
mozilla
:
:
gfx
:
:
FeatureStatus
mD3D11Status
;
mozilla
:
:
gfx
:
:
FeatureStatus
mD2D1Status
;
nsTArray
<
D3D_FEATURE_LEVEL
>
mFeatureLevels
;
}
;
#
endif
