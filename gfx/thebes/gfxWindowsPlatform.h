#
ifndef
GFX_WINDOWS_PLATFORM_H
#
define
GFX_WINDOWS_PLATFORM_H
#
include
"
gfxCrashReporterUtils
.
h
"
#
include
"
gfxFontUtils
.
h
"
#
include
"
gfxWindowsSurface
.
h
"
#
include
"
gfxFont
.
h
"
#
include
"
gfxDWriteFonts
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
gfxTelemetry
.
h
"
#
include
"
gfxTypes
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
<
windows
.
h
>
#
include
<
objbase
.
h
>
#
include
<
dxgi
.
h
>
#
include
<
d3dcommon
.
h
>
#
if
!
defined
(
D3D_FEATURE_LEVEL_11_1
)
#
define
D3D_FEATURE_LEVEL_11_1
static_cast
<
D3D_FEATURE_LEVEL
>
(
0xb100
)
#
define
D3D_FL9_1_REQ_TEXTURE2D_U_OR_V_DIMENSION
2048
#
define
D3D_FL9_3_REQ_TEXTURE2D_U_OR_V_DIMENSION
4096
#
endif
namespace
mozilla
{
namespace
gfx
{
class
DrawTarget
;
class
FeatureState
;
class
DeviceManagerDx
;
}
}
struct
IDirect3DDevice9
;
struct
ID3D11Device
;
struct
IDXGIAdapter1
;
class
MOZ_STACK_CLASS
DCForMetrics
final
{
public
:
explicit
DCForMetrics
(
)
;
~
DCForMetrics
(
)
{
ReleaseDC
(
nullptr
mDC
)
;
}
operator
HDC
(
)
{
return
mDC
;
}
private
:
HDC
mDC
;
}
;
struct
ClearTypeParameterInfo
{
ClearTypeParameterInfo
(
)
:
gamma
(
-
1
)
pixelStructure
(
-
1
)
clearTypeLevel
(
-
1
)
enhancedContrast
(
-
1
)
{
}
nsString
displayName
;
int32_t
gamma
;
int32_t
pixelStructure
;
int32_t
clearTypeLevel
;
int32_t
enhancedContrast
;
}
;
class
gfxWindowsPlatform
final
:
public
gfxPlatform
{
friend
class
mozilla
:
:
gfx
:
:
DeviceManagerDx
;
public
:
enum
TextRenderingMode
{
TEXT_RENDERING_NO_CLEARTYPE
TEXT_RENDERING_NORMAL
TEXT_RENDERING_GDI_CLASSIC
TEXT_RENDERING_COUNT
}
;
gfxWindowsPlatform
(
)
;
virtual
~
gfxWindowsPlatform
(
)
;
static
gfxWindowsPlatform
*
GetPlatform
(
)
{
return
(
gfxWindowsPlatform
*
)
gfxPlatform
:
:
GetPlatform
(
)
;
}
void
EnsureDevicesInitialized
(
)
override
;
bool
DevicesInitialized
(
)
override
;
bool
CreatePlatformFontList
(
)
override
;
virtual
already_AddRefed
<
gfxASurface
>
CreateOffscreenSurface
(
const
IntSize
&
aSize
gfxImageFormat
aFormat
)
override
;
enum
RenderMode
{
RENDER_GDI
=
0
RENDER_IMAGE_STRETCH32
RENDER_IMAGE_STRETCH24
RENDER_DIRECT2D
RENDER_MODE_MAX
}
;
bool
IsDirect2DBackend
(
)
;
void
UpdateRenderMode
(
)
;
void
VerifyD2DDevice
(
bool
aAttemptForce
)
;
void
GetCommonFallbackFonts
(
uint32_t
aCh
Script
aRunScript
eFontPresentation
aPresentation
nsTArray
<
const
char
*
>
&
aFontList
)
override
;
bool
CanUseHardwareVideoDecoding
(
)
override
;
void
CompositorUpdated
(
)
override
;
bool
DidRenderingDeviceReset
(
DeviceResetReason
*
aResetReason
=
nullptr
)
override
;
void
SchedulePaintIfDeviceReset
(
)
override
;
void
CheckForContentOnlyDeviceReset
(
)
;
mozilla
:
:
gfx
:
:
BackendType
GetContentBackendFor
(
mozilla
:
:
layers
:
:
LayersBackend
aLayers
)
override
;
mozilla
:
:
gfx
:
:
BackendType
GetPreferredCanvasBackend
(
)
override
;
static
void
GetDLLVersion
(
char16ptr_t
aDLLPath
nsAString
&
aVersion
)
;
static
void
GetCleartypeParams
(
nsTArray
<
ClearTypeParameterInfo
>
&
aParams
)
;
void
FontsPrefsChanged
(
const
char
*
aPref
)
override
;
static
inline
bool
DWriteEnabled
(
)
{
return
!
!
mozilla
:
:
gfx
:
:
Factory
:
:
GetDWriteFactory
(
)
;
}
public
:
static
nsresult
GetGpuTimeSinceProcessStartInMs
(
uint64_t
*
aResult
)
;
bool
DwmCompositionEnabled
(
)
;
static
bool
IsOptimus
(
)
;
bool
SupportsApzWheelInput
(
)
const
override
{
return
true
;
}
bool
HandleDeviceReset
(
)
;
void
UpdateBackendPrefs
(
)
;
already_AddRefed
<
mozilla
:
:
gfx
:
:
VsyncSource
>
CreateGlobalHardwareVsyncSource
(
)
override
;
static
mozilla
:
:
Atomic
<
size_t
>
sD3D11SharedTextures
;
static
mozilla
:
:
Atomic
<
size_t
>
sD3D9SharedTextures
;
bool
SupportsPluginDirectBitmapDrawing
(
)
override
{
return
true
;
}
static
void
RecordContentDeviceFailure
(
mozilla
:
:
gfx
:
:
TelemetryDeviceCode
aDevice
)
;
static
void
InitMemoryReportersForGPUProcess
(
)
;
protected
:
bool
AccelerateLayersByDefault
(
)
override
{
return
true
;
}
nsTArray
<
uint8_t
>
GetPlatformCMSOutputProfileData
(
)
override
;
void
GetPlatformDisplayInfo
(
mozilla
:
:
widget
:
:
InfoObject
&
aObj
)
override
;
void
ImportGPUDeviceData
(
const
mozilla
:
:
gfx
:
:
GPUDeviceData
&
aData
)
override
;
void
ImportContentDeviceData
(
const
mozilla
:
:
gfx
:
:
ContentDeviceData
&
aData
)
override
;
void
BuildContentDeviceData
(
mozilla
:
:
gfx
:
:
ContentDeviceData
*
aOut
)
override
;
BackendPrefsData
GetBackendPrefs
(
)
const
override
;
bool
CheckVariationFontSupport
(
)
override
;
protected
:
RenderMode
mRenderMode
;
private
:
enum
class
DwmCompositionStatus
:
uint32_t
{
Unknown
Disabled
Enabled
}
;
void
Init
(
)
;
void
InitAcceleration
(
)
override
;
void
InitWebRenderConfig
(
)
override
;
void
InitializeDevices
(
)
;
void
InitializeD3D11
(
)
;
void
InitializeD2D
(
)
;
bool
InitDWriteSupport
(
)
;
void
InitGPUProcessSupport
(
)
;
void
DisableD2D
(
mozilla
:
:
gfx
:
:
FeatureStatus
aStatus
const
char
*
aMessage
const
nsACString
&
aFailureId
)
;
void
InitializeConfig
(
)
;
void
InitializeD3D9Config
(
)
;
void
InitializeD3D11Config
(
)
;
void
InitializeD2DConfig
(
)
;
void
InitializeDirectDrawConfig
(
)
;
void
RecordStartupTelemetry
(
)
;
bool
mInitializedDevices
=
false
;
mozilla
:
:
Atomic
<
DwmCompositionStatus
mozilla
:
:
ReleaseAcquire
>
mDwmCompositionStatus
;
nsTArray
<
uint8_t
>
mCachedOutputColorProfile
;
}
;
#
endif
