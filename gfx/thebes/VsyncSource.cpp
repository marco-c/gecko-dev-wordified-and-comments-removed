#
include
"
VsyncSource
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
include
"
mozilla
/
VsyncDispatcher
.
h
"
#
include
"
MainThreadUtils
.
h
"
namespace
mozilla
{
namespace
gfx
{
void
VsyncSource
:
:
EnableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
GetGlobalDisplay
(
)
.
EnableCompositorVsyncDispatcher
(
aCompositorVsyncDispatcher
)
;
}
void
VsyncSource
:
:
DisableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
GetGlobalDisplay
(
)
.
DisableCompositorVsyncDispatcher
(
aCompositorVsyncDispatcher
)
;
}
void
VsyncSource
:
:
RegisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
GetGlobalDisplay
(
)
.
RegisterCompositorVsyncDispatcher
(
aCompositorVsyncDispatcher
)
;
}
void
VsyncSource
:
:
DeregisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
GetGlobalDisplay
(
)
.
DeregisterCompositorVsyncDispatcher
(
aCompositorVsyncDispatcher
)
;
}
void
VsyncSource
:
:
AddGenericObserver
(
VsyncObserver
*
aObserver
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
GetGlobalDisplay
(
)
.
AddGenericObserver
(
aObserver
)
;
}
void
VsyncSource
:
:
RemoveGenericObserver
(
VsyncObserver
*
aObserver
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
GetGlobalDisplay
(
)
.
RemoveGenericObserver
(
aObserver
)
;
}
void
VsyncSource
:
:
MoveListenersToNewSource
(
const
RefPtr
<
VsyncSource
>
&
aNewSource
)
{
GetGlobalDisplay
(
)
.
MoveListenersToNewSource
(
aNewSource
)
;
}
RefPtr
<
RefreshTimerVsyncDispatcher
>
VsyncSource
:
:
GetRefreshTimerVsyncDispatcher
(
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
return
GetGlobalDisplay
(
)
.
GetRefreshTimerVsyncDispatcher
(
)
;
}
VsyncSource
:
:
Display
:
:
Display
(
)
:
mDispatcherLock
(
"
display
dispatcher
lock
"
)
mRefreshTimerNeedsVsync
(
false
)
mHasGenericObservers
(
false
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
mRefreshTimerVsyncDispatcher
=
new
RefreshTimerVsyncDispatcher
(
this
)
;
}
VsyncSource
:
:
Display
:
:
~
Display
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MutexAutoLock
lock
(
mDispatcherLock
)
;
mRefreshTimerVsyncDispatcher
=
nullptr
;
MOZ_ASSERT
(
mRegisteredCompositorVsyncDispatchers
.
Length
(
)
=
=
0
)
;
MOZ_ASSERT
(
mEnabledCompositorVsyncDispatchers
.
Length
(
)
=
=
0
)
;
}
void
VsyncSource
:
:
Display
:
:
NotifyVsync
(
const
TimeStamp
&
aVsyncTimestamp
const
TimeStamp
&
aOutputTimestamp
)
{
MutexAutoLock
lock
(
mDispatcherLock
)
;
if
(
!
mRefreshTimerVsyncDispatcher
)
{
return
;
}
bool
dispatchToMainThread
=
mHasGenericObservers
&
&
(
mLastVsyncIdSentToMainThread
=
=
mLastMainThreadProcessedVsyncId
)
;
mVsyncId
=
mVsyncId
.
Next
(
)
;
const
VsyncEvent
event
(
mVsyncId
aVsyncTimestamp
aOutputTimestamp
)
;
for
(
size_t
i
=
0
;
i
<
mEnabledCompositorVsyncDispatchers
.
Length
(
)
;
i
+
+
)
{
mEnabledCompositorVsyncDispatchers
[
i
]
-
>
NotifyVsync
(
event
)
;
}
mRefreshTimerVsyncDispatcher
-
>
NotifyVsync
(
event
)
;
if
(
dispatchToMainThread
)
{
mLastVsyncIdSentToMainThread
=
mVsyncId
;
NS_DispatchToMainThread
(
NewRunnableMethod
<
VsyncEvent
>
(
"
VsyncSource
:
:
Display
:
:
NotifyGenericObservers
"
this
&
VsyncSource
:
:
Display
:
:
NotifyGenericObservers
event
)
)
;
}
}
void
VsyncSource
:
:
Display
:
:
NotifyGenericObservers
(
VsyncEvent
aEvent
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
for
(
size_t
i
=
0
;
i
<
mGenericObservers
.
Length
(
)
;
i
+
+
)
{
mGenericObservers
[
i
]
-
>
NotifyVsync
(
aEvent
)
;
}
{
MutexAutoLock
lock
(
mDispatcherLock
)
;
mLastMainThreadProcessedVsyncId
=
aEvent
.
mId
;
}
}
TimeDuration
VsyncSource
:
:
Display
:
:
GetVsyncRate
(
)
{
return
TimeDuration
:
:
FromMilliseconds
(
1000
.
0
/
60
.
0
)
;
}
void
VsyncSource
:
:
Display
:
:
RegisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aCompositorVsyncDispatcher
)
;
{
MutexAutoLock
lock
(
mDispatcherLock
)
;
mRegisteredCompositorVsyncDispatchers
.
AppendElement
(
aCompositorVsyncDispatcher
)
;
}
}
void
VsyncSource
:
:
Display
:
:
DeregisterCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aCompositorVsyncDispatcher
)
;
{
MutexAutoLock
lock
(
mDispatcherLock
)
;
mRegisteredCompositorVsyncDispatchers
.
RemoveElement
(
aCompositorVsyncDispatcher
)
;
}
}
void
VsyncSource
:
:
Display
:
:
EnableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aCompositorVsyncDispatcher
)
;
{
MutexAutoLock
lock
(
mDispatcherLock
)
;
if
(
!
mEnabledCompositorVsyncDispatchers
.
Contains
(
aCompositorVsyncDispatcher
)
)
{
mEnabledCompositorVsyncDispatchers
.
AppendElement
(
aCompositorVsyncDispatcher
)
;
}
}
UpdateVsyncStatus
(
)
;
}
void
VsyncSource
:
:
Display
:
:
DisableCompositorVsyncDispatcher
(
CompositorVsyncDispatcher
*
aCompositorVsyncDispatcher
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aCompositorVsyncDispatcher
)
;
{
MutexAutoLock
lock
(
mDispatcherLock
)
;
if
(
mEnabledCompositorVsyncDispatchers
.
Contains
(
aCompositorVsyncDispatcher
)
)
{
mEnabledCompositorVsyncDispatchers
.
RemoveElement
(
aCompositorVsyncDispatcher
)
;
}
}
UpdateVsyncStatus
(
)
;
}
void
VsyncSource
:
:
Display
:
:
AddGenericObserver
(
VsyncObserver
*
aObserver
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aObserver
)
;
mGenericObservers
.
AppendElement
(
aObserver
)
;
UpdateVsyncStatus
(
)
;
}
void
VsyncSource
:
:
Display
:
:
RemoveGenericObserver
(
VsyncObserver
*
aObserver
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aObserver
)
;
mGenericObservers
.
RemoveElement
(
aObserver
)
;
UpdateVsyncStatus
(
)
;
}
void
VsyncSource
:
:
Display
:
:
MoveListenersToNewSource
(
const
RefPtr
<
VsyncSource
>
&
aNewSource
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
VsyncSource
:
:
Display
&
aNewDisplay
=
aNewSource
-
>
GetGlobalDisplay
(
)
;
MutexAutoLock
lock
(
mDispatcherLock
)
;
MutexAutoLock
newLock
(
aNewDisplay
.
mDispatcherLock
)
;
aNewDisplay
.
mRegisteredCompositorVsyncDispatchers
.
AppendElements
(
std
:
:
move
(
mRegisteredCompositorVsyncDispatchers
)
)
;
aNewDisplay
.
mEnabledCompositorVsyncDispatchers
.
AppendElements
(
std
:
:
move
(
mEnabledCompositorVsyncDispatchers
)
)
;
aNewDisplay
.
mGenericObservers
.
AppendElements
(
std
:
:
move
(
mGenericObservers
)
)
;
for
(
size_t
i
=
0
;
i
<
aNewDisplay
.
mRegisteredCompositorVsyncDispatchers
.
Length
(
)
;
i
+
+
)
{
aNewDisplay
.
mRegisteredCompositorVsyncDispatchers
[
i
]
-
>
MoveToSource
(
aNewSource
)
;
}
aNewDisplay
.
mRefreshTimerVsyncDispatcher
=
mRefreshTimerVsyncDispatcher
;
mRefreshTimerVsyncDispatcher
-
>
MoveToDisplay
(
&
aNewDisplay
)
;
mRefreshTimerVsyncDispatcher
=
nullptr
;
}
void
VsyncSource
:
:
Display
:
:
NotifyRefreshTimerVsyncStatus
(
bool
aEnable
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
mRefreshTimerNeedsVsync
=
aEnable
;
UpdateVsyncStatus
(
)
;
}
void
VsyncSource
:
:
Display
:
:
UpdateVsyncStatus
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
bool
enableVsync
=
false
;
{
MutexAutoLock
lock
(
mDispatcherLock
)
;
enableVsync
=
!
mEnabledCompositorVsyncDispatchers
.
IsEmpty
(
)
|
|
mRefreshTimerNeedsVsync
|
|
!
mGenericObservers
.
IsEmpty
(
)
;
mHasGenericObservers
=
!
mGenericObservers
.
IsEmpty
(
)
;
}
if
(
enableVsync
)
{
EnableVsync
(
)
;
}
else
{
DisableVsync
(
)
;
}
if
(
IsVsyncEnabled
(
)
!
=
enableVsync
)
{
NS_WARNING
(
"
Vsync
status
did
not
change
.
"
)
;
}
}
RefPtr
<
RefreshTimerVsyncDispatcher
>
VsyncSource
:
:
Display
:
:
GetRefreshTimerVsyncDispatcher
(
)
{
return
mRefreshTimerVsyncDispatcher
;
}
void
VsyncSource
:
:
Shutdown
(
)
{
GetGlobalDisplay
(
)
.
Shutdown
(
)
;
}
}
}
