#
include
"
ScaledFontWin
.
h
"
#
include
"
AutoHelpersWin
.
h
"
#
include
"
Logging
.
h
"
#
include
"
SFNTData
.
h
"
#
ifdef
USE_SKIA
#
include
"
skia
/
include
/
ports
/
SkTypeface_win
.
h
"
#
endif
#
ifdef
USE_CAIRO_SCALED_FONT
#
include
"
cairo
-
win32
.
h
"
#
endif
namespace
mozilla
{
namespace
gfx
{
ScaledFontWin
:
:
ScaledFontWin
(
LOGFONT
*
aFont
Float
aSize
)
:
ScaledFontBase
(
aSize
)
mLogFont
(
*
aFont
)
{
}
bool
ScaledFontWin
:
:
GetFontFileData
(
FontFileDataOutput
aDataCallback
void
*
aBaton
)
{
AutoDC
dc
;
AutoSelectFont
font
(
dc
.
GetDC
(
)
&
mLogFont
)
;
uint32_t
table
=
0x66637474
;
uint32_t
tableSize
=
:
:
GetFontData
(
dc
.
GetDC
(
)
table
0
nullptr
0
)
;
if
(
tableSize
=
=
GDI_ERROR
)
{
table
=
0
;
tableSize
=
:
:
GetFontData
(
dc
.
GetDC
(
)
table
0
nullptr
0
)
;
if
(
tableSize
=
=
GDI_ERROR
)
{
gfxDevCrash
(
LogReason
:
:
GetFontFileDataFailed
)
<
<
"
Failed
to
get
font
data
from
GDI
"
;
return
false
;
}
}
UniquePtr
<
uint8_t
[
]
>
fontData
(
new
uint8_t
[
tableSize
]
)
;
uint32_t
sizeGot
=
:
:
GetFontData
(
dc
.
GetDC
(
)
table
0
fontData
.
get
(
)
tableSize
)
;
if
(
sizeGot
!
=
tableSize
)
{
gfxDevCrash
(
LogReason
:
:
GetFontFileDataFailed
)
<
<
"
GDI
did
not
return
enough
data
for
font
:
wanted
"
<
<
tableSize
<
<
"
got
"
<
<
sizeGot
;
return
false
;
}
uint32_t
index
=
0
;
if
(
table
!
=
0
)
{
UniquePtr
<
SFNTData
>
sfntData
=
SFNTData
:
:
Create
(
fontData
.
get
(
)
tableSize
)
;
if
(
!
sfntData
)
{
gfxDevCrash
(
LogReason
:
:
GetFontFileDataFailed
)
<
<
"
Failed
to
create
SFNTData
for
GetFontFileData
.
"
;
return
false
;
}
if
(
!
sfntData
-
>
GetIndexForU16Name
(
reinterpret_cast
<
char16_t
*
>
(
mLogFont
.
lfFaceName
)
&
index
)
)
{
gfxDevCrash
(
LogReason
:
:
GetFontFileDataFailed
)
<
<
"
Failed
to
get
index
for
face
name
.
"
;
return
false
;
}
}
aDataCallback
(
fontData
.
get
(
)
tableSize
index
mSize
aBaton
)
;
return
true
;
}
#
ifdef
USE_SKIA
SkTypeface
*
ScaledFontWin
:
:
GetSkTypeface
(
)
{
if
(
!
mTypeface
)
{
mTypeface
=
SkCreateTypefaceFromLOGFONT
(
mLogFont
)
;
}
return
mTypeface
;
}
#
endif
#
ifdef
USE_CAIRO_SCALED_FONT
cairo_font_face_t
*
ScaledFontWin
:
:
GetCairoFontFace
(
)
{
if
(
mLogFont
.
lfFaceName
[
0
]
=
=
0
)
{
return
nullptr
;
}
return
cairo_win32_font_face_create_for_logfontw
(
&
mLogFont
)
;
}
#
endif
}
}
