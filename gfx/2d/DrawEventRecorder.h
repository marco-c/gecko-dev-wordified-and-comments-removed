#
ifndef
MOZILLA_GFX_DRAWEVENTRECORDER_H_
#
define
MOZILLA_GFX_DRAWEVENTRECORDER_H_
#
include
"
2D
.
h
"
#
include
"
RecordedEvent
.
h
"
#
include
<
ostream
>
#
include
<
fstream
>
#
if
defined
(
_MSC_VER
)
#
include
<
unordered_set
>
#
else
#
include
<
set
>
#
endif
namespace
mozilla
{
namespace
gfx
{
class
PathRecording
;
class
DrawEventRecorderPrivate
:
public
DrawEventRecorder
{
public
:
MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME
(
DrawEventRecorderPrivate
)
explicit
DrawEventRecorderPrivate
(
std
:
:
ostream
*
aStream
)
;
virtual
~
DrawEventRecorderPrivate
(
)
{
}
void
WriteHeader
(
)
;
void
RecordEvent
(
const
RecordedEvent
&
aEvent
)
;
void
WritePath
(
const
PathRecording
*
aPath
)
;
void
AddStoredObject
(
const
ReferencePtr
aObject
)
{
mStoredObjects
.
insert
(
aObject
)
;
}
void
RemoveStoredObject
(
const
ReferencePtr
aObject
)
{
mStoredObjects
.
erase
(
aObject
)
;
}
bool
HasStoredObject
(
const
ReferencePtr
aObject
)
{
return
mStoredObjects
.
find
(
aObject
)
!
=
mStoredObjects
.
end
(
)
;
}
void
AddStoredFontData
(
const
uint64_t
aFontDataKey
)
{
mStoredFontData
.
insert
(
aFontDataKey
)
;
}
bool
HasStoredFontData
(
const
uint64_t
aFontDataKey
)
{
return
mStoredFontData
.
find
(
aFontDataKey
)
!
=
mStoredFontData
.
end
(
)
;
}
protected
:
std
:
:
ostream
*
mOutputStream
;
virtual
void
Flush
(
)
=
0
;
#
if
defined
(
_MSC_VER
)
typedef
std
:
:
unordered_set
<
const
void
*
>
ObjectSet
;
typedef
std
:
:
unordered_set
<
uint64_t
>
Uint64Set
;
#
else
typedef
std
:
:
set
<
const
void
*
>
ObjectSet
;
typedef
std
:
:
set
<
uint64_t
>
Uint64Set
;
#
endif
ObjectSet
mStoredObjects
;
Uint64Set
mStoredFontData
;
}
;
class
DrawEventRecorderFile
:
public
DrawEventRecorderPrivate
{
public
:
MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME
(
DrawEventRecorderFile
)
explicit
DrawEventRecorderFile
(
const
char
*
aFilename
)
;
~
DrawEventRecorderFile
(
)
;
bool
IsOpen
(
)
;
void
OpenNew
(
const
char
*
aFilename
)
;
void
Close
(
)
;
private
:
virtual
void
Flush
(
)
;
std
:
:
ofstream
mOutputFile
;
}
;
}
}
#
endif
