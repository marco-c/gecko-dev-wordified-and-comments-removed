#
include
"
InlineTranslator
.
h
"
#
include
"
RecordedEventImpl
.
h
"
#
include
"
mozilla
/
gfx
/
RecordingTypes
.
h
"
using
namespace
mozilla
:
:
gfx
;
namespace
mozilla
:
:
gfx
{
InlineTranslator
:
:
InlineTranslator
(
)
:
mFontContext
(
nullptr
)
{
}
InlineTranslator
:
:
InlineTranslator
(
DrawTarget
*
aDT
void
*
aFontContext
)
:
mBaseDT
(
aDT
)
mFontContext
(
aFontContext
)
{
}
bool
InlineTranslator
:
:
TranslateRecording
(
char
*
aData
size_t
aLen
)
{
struct
MemReader
{
MemReader
(
char
*
aData
size_t
aLen
)
:
mData
(
aData
)
mEnd
(
aData
+
aLen
)
{
}
void
read
(
char
*
s
std
:
:
streamsize
n
)
{
if
(
n
<
=
(
mEnd
-
mData
)
)
{
memcpy
(
s
mData
n
)
;
mData
+
=
n
;
}
else
{
SetIsBad
(
)
;
}
}
bool
eof
(
)
{
return
mData
>
mEnd
;
}
bool
good
(
)
{
return
!
eof
(
)
;
}
void
SetIsBad
(
)
{
mData
=
mEnd
+
1
;
}
char
*
mData
;
char
*
mEnd
;
}
;
MemReader
reader
(
aData
aLen
)
;
uint32_t
magicInt
;
ReadElement
(
reader
magicInt
)
;
if
(
magicInt
!
=
mozilla
:
:
gfx
:
:
kMagicInt
)
{
mError
=
"
Magic
"
;
return
false
;
}
uint16_t
majorRevision
;
ReadElement
(
reader
majorRevision
)
;
if
(
majorRevision
!
=
kMajorRevision
)
{
mError
=
"
Major
"
;
return
false
;
}
uint16_t
minorRevision
;
ReadElement
(
reader
minorRevision
)
;
if
(
minorRevision
>
kMinorRevision
)
{
mError
=
"
Minor
"
;
return
false
;
}
int32_t
eventType
;
ReadElement
(
reader
eventType
)
;
while
(
reader
.
good
(
)
)
{
bool
success
=
RecordedEvent
:
:
DoWithEvent
(
reader
static_cast
<
RecordedEvent
:
:
EventType
>
(
eventType
)
[
&
]
(
RecordedEvent
*
recordedEvent
)
-
>
bool
{
if
(
!
reader
.
good
(
)
)
{
mError
=
"
READ
"
;
return
false
;
}
if
(
!
recordedEvent
-
>
PlayEvent
(
this
)
)
{
mError
=
"
PLAY
"
;
return
false
;
}
return
true
;
}
)
;
if
(
!
success
)
{
mError
=
RecordedEvent
:
:
GetEventName
(
static_cast
<
RecordedEvent
:
:
EventType
>
(
eventType
)
)
+
mError
;
return
false
;
}
ReadElement
(
reader
eventType
)
;
}
return
true
;
}
already_AddRefed
<
DrawTarget
>
InlineTranslator
:
:
CreateDrawTarget
(
ReferencePtr
aRefPtr
const
gfx
:
:
IntSize
&
aSize
gfx
:
:
SurfaceFormat
aFormat
)
{
MOZ_ASSERT
(
mBaseDT
"
mBaseDT
has
not
been
initialized
.
"
)
;
RefPtr
<
DrawTarget
>
drawTarget
=
mBaseDT
;
AddDrawTarget
(
aRefPtr
drawTarget
)
;
return
drawTarget
.
forget
(
)
;
}
already_AddRefed
<
SourceSurface
>
InlineTranslator
:
:
LookupExternalSurface
(
uint64_t
aKey
)
{
if
(
!
mExternalSurfaces
)
{
return
nullptr
;
}
RefPtr
<
SourceSurface
>
surface
=
mExternalSurfaces
-
>
Get
(
aKey
)
;
return
surface
.
forget
(
)
;
}
}
