#
include
"
DrawEventRecorder
.
h
"
#
include
"
mozilla
/
UniquePtrExtensions
.
h
"
#
include
"
PathRecording
.
h
"
#
include
"
RecordingTypes
.
h
"
#
include
"
RecordedEventImpl
.
h
"
namespace
mozilla
{
namespace
gfx
{
DrawEventRecorderPrivate
:
:
DrawEventRecorderPrivate
(
)
:
mExternalFonts
(
false
)
{
}
void
DrawEventRecorderPrivate
:
:
StoreExternalSurfaceRecording
(
SourceSurface
*
aSurface
uint64_t
aKey
)
{
RecordEvent
(
RecordedExternalSurfaceCreation
(
aSurface
aKey
)
)
;
mExternalSurfaces
.
push_back
(
aSurface
)
;
}
void
DrawEventRecorderPrivate
:
:
StoreSourceSurfaceRecording
(
SourceSurface
*
aSurface
const
char
*
aReason
)
{
RefPtr
<
DataSourceSurface
>
dataSurf
=
aSurface
-
>
GetDataSurface
(
)
;
IntSize
surfaceSize
=
aSurface
-
>
GetSize
(
)
;
Maybe
<
DataSourceSurface
:
:
ScopedMap
>
map
;
if
(
dataSurf
)
{
map
.
emplace
(
dataSurf
DataSourceSurface
:
:
READ
)
;
}
if
(
!
dataSurf
|
|
!
map
-
>
IsMapped
(
)
|
|
!
Factory
:
:
AllowedSurfaceSize
(
surfaceSize
)
)
{
gfxWarning
(
)
<
<
"
Recording
failed
to
record
SourceSurface
for
"
<
<
aReason
;
if
(
!
Factory
:
:
AllowedSurfaceSize
(
surfaceSize
)
)
{
surfaceSize
.
width
=
std
:
:
min
(
surfaceSize
.
width
kReasonableSurfaceSize
)
;
surfaceSize
.
height
=
std
:
:
min
(
surfaceSize
.
height
kReasonableSurfaceSize
)
;
}
int32_t
stride
=
surfaceSize
.
width
*
BytesPerPixel
(
aSurface
-
>
GetFormat
(
)
)
;
UniquePtr
<
uint8_t
[
]
>
sourceData
=
MakeUniqueFallible
<
uint8_t
[
]
>
(
stride
*
surfaceSize
.
height
)
;
if
(
!
sourceData
)
{
surfaceSize
.
width
=
1
;
surfaceSize
.
height
=
1
;
stride
=
surfaceSize
.
width
*
BytesPerPixel
(
aSurface
-
>
GetFormat
(
)
)
;
sourceData
=
MakeUnique
<
uint8_t
[
]
>
(
stride
*
surfaceSize
.
height
)
;
}
RecordEvent
(
RecordedSourceSurfaceCreation
(
aSurface
sourceData
.
get
(
)
stride
surfaceSize
aSurface
-
>
GetFormat
(
)
)
)
;
return
;
}
RecordEvent
(
RecordedSourceSurfaceCreation
(
aSurface
map
-
>
GetData
(
)
map
-
>
GetStride
(
)
dataSurf
-
>
GetSize
(
)
dataSurf
-
>
GetFormat
(
)
)
)
;
}
void
DrawEventRecorderPrivate
:
:
RecordSourceSurfaceDestruction
(
void
*
aSurface
)
{
RemoveSourceSurface
(
static_cast
<
SourceSurface
*
>
(
aSurface
)
)
;
RemoveStoredObject
(
aSurface
)
;
RecordEvent
(
RecordedSourceSurfaceDestruction
(
ReferencePtr
(
aSurface
)
)
)
;
}
void
DrawEventRecorderPrivate
:
:
DecrementUnscaledFontRefCount
(
const
ReferencePtr
aUnscaledFont
)
{
auto
element
=
mUnscaledFontRefs
.
find
(
aUnscaledFont
)
;
MOZ_DIAGNOSTIC_ASSERT
(
element
!
=
mUnscaledFontRefs
.
end
(
)
"
DecrementUnscaledFontRefCount
calls
should
balance
"
"
with
IncrementUnscaledFontRefCount
calls
"
)
;
if
(
-
-
(
element
-
>
second
)
<
=
0
)
{
RecordEvent
(
RecordedUnscaledFontDestruction
(
aUnscaledFont
)
)
;
mUnscaledFontRefs
.
erase
(
aUnscaledFont
)
;
}
}
void
DrawEventRecorderFile
:
:
RecordEvent
(
const
RecordedEvent
&
aEvent
)
{
aEvent
.
RecordToStream
(
mOutputStream
)
;
Flush
(
)
;
}
void
DrawEventRecorderMemory
:
:
RecordEvent
(
const
RecordedEvent
&
aEvent
)
{
aEvent
.
RecordToStream
(
mOutputStream
)
;
}
void
DrawEventRecorderMemory
:
:
AddDependentSurface
(
uint64_t
aDependencyId
)
{
mDependentSurfaces
.
Insert
(
aDependencyId
)
;
}
nsTHashSet
<
uint64_t
>
&
&
DrawEventRecorderMemory
:
:
TakeDependentSurfaces
(
)
{
return
std
:
:
move
(
mDependentSurfaces
)
;
}
DrawEventRecorderFile
:
:
DrawEventRecorderFile
(
const
char_type
*
aFilename
)
:
mOutputStream
(
aFilename
std
:
:
ofstream
:
:
binary
)
{
WriteHeader
(
mOutputStream
)
;
}
DrawEventRecorderFile
:
:
~
DrawEventRecorderFile
(
)
{
mOutputStream
.
close
(
)
;
}
void
DrawEventRecorderFile
:
:
Flush
(
)
{
mOutputStream
.
flush
(
)
;
}
bool
DrawEventRecorderFile
:
:
IsOpen
(
)
{
return
mOutputStream
.
is_open
(
)
;
}
void
DrawEventRecorderFile
:
:
OpenNew
(
const
char_type
*
aFilename
)
{
MOZ_ASSERT
(
!
mOutputStream
.
is_open
(
)
)
;
mOutputStream
.
open
(
aFilename
std
:
:
ofstream
:
:
binary
)
;
WriteHeader
(
mOutputStream
)
;
}
void
DrawEventRecorderFile
:
:
Close
(
)
{
MOZ_ASSERT
(
mOutputStream
.
is_open
(
)
)
;
mOutputStream
.
close
(
)
;
}
DrawEventRecorderMemory
:
:
DrawEventRecorderMemory
(
)
{
WriteHeader
(
mOutputStream
)
;
}
DrawEventRecorderMemory
:
:
DrawEventRecorderMemory
(
const
SerializeResourcesFn
&
aFn
)
:
mSerializeCallback
(
aFn
)
{
mExternalFonts
=
!
!
mSerializeCallback
;
WriteHeader
(
mOutputStream
)
;
}
void
DrawEventRecorderMemory
:
:
Flush
(
)
{
}
void
DrawEventRecorderMemory
:
:
FlushItem
(
IntRect
aRect
)
{
MOZ_RELEASE_ASSERT
(
!
aRect
.
IsEmpty
(
)
)
;
DetachResources
(
)
;
WriteElement
(
mIndex
mOutputStream
.
mLength
)
;
mSerializeCallback
(
mOutputStream
mScaledFonts
)
;
WriteElement
(
mIndex
mOutputStream
.
mLength
)
;
WriteElement
(
mIndex
aRect
.
x
)
;
WriteElement
(
mIndex
aRect
.
y
)
;
WriteElement
(
mIndex
aRect
.
XMost
(
)
)
;
WriteElement
(
mIndex
aRect
.
YMost
(
)
)
;
ClearResources
(
)
;
WriteHeader
(
mOutputStream
)
;
}
bool
DrawEventRecorderMemory
:
:
Finish
(
)
{
size_t
indexOffset
=
mOutputStream
.
mLength
;
mOutputStream
.
write
(
mIndex
.
mData
mIndex
.
mLength
)
;
bool
hasItems
=
mIndex
.
mLength
!
=
0
;
mIndex
.
reset
(
)
;
WriteElement
(
mOutputStream
indexOffset
)
;
ClearResources
(
)
;
return
hasItems
;
}
size_t
DrawEventRecorderMemory
:
:
RecordingSize
(
)
{
return
mOutputStream
.
mLength
;
}
void
DrawEventRecorderMemory
:
:
WipeRecording
(
)
{
mOutputStream
.
reset
(
)
;
mIndex
.
reset
(
)
;
WriteHeader
(
mOutputStream
)
;
}
}
}
