#
ifndef
MOZILLA_GFX_SOURCESURFACED2D1_H_
#
define
MOZILLA_GFX_SOURCESURFACED2D1_H_
#
include
"
2D
.
h
"
#
include
"
HelpersD2D
.
h
"
#
include
<
vector
>
#
include
<
d3d11
.
h
>
#
include
<
d2d1_1
.
h
>
namespace
mozilla
{
namespace
gfx
{
class
DrawTargetD2D1
;
class
SourceSurfaceD2D1
:
public
SourceSurface
{
public
:
MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME
(
SourceSurfaceD2D1
override
)
SourceSurfaceD2D1
(
ID2D1Image
*
aImage
ID2D1DeviceContext
*
aDC
SurfaceFormat
aFormat
const
IntSize
&
aSize
DrawTargetD2D1
*
aDT
=
nullptr
)
;
~
SourceSurfaceD2D1
(
)
;
SurfaceType
GetType
(
)
const
override
{
return
SurfaceType
:
:
D2D1_1_IMAGE
;
}
IntSize
GetSize
(
)
const
override
{
return
mSize
;
}
SurfaceFormat
GetFormat
(
)
const
override
{
return
mFormat
;
}
bool
IsValid
(
)
const
override
;
already_AddRefed
<
DataSourceSurface
>
GetDataSurface
(
)
override
;
ID2D1Image
*
GetImage
(
)
{
return
mImage
;
}
void
EnsureIndependent
(
)
{
if
(
!
mDrawTarget
)
return
;
DrawTargetWillChange
(
)
;
}
private
:
friend
class
DrawTargetD2D1
;
bool
EnsureRealizedBitmap
(
)
;
void
DrawTargetWillChange
(
)
;
void
MarkIndependent
(
)
;
RefPtr
<
ID2D1Image
>
mImage
;
RefPtr
<
ID2D1Bitmap1
>
mRealizedBitmap
;
RefPtr
<
ID2D1DeviceContext
>
mDC
;
RefPtr
<
ID2D1Device
>
mDevice
;
const
SurfaceFormat
mFormat
;
const
IntSize
mSize
;
DrawTargetD2D1
*
mDrawTarget
;
std
:
:
shared_ptr
<
Mutex
>
mSnapshotLock
;
bool
mOwnsCopy
;
}
;
class
DataSourceSurfaceD2D1
:
public
DataSourceSurface
{
public
:
MOZ_DECLARE_REFCOUNTED_VIRTUAL_TYPENAME
(
DataSourceSurfaceD2D1
override
)
DataSourceSurfaceD2D1
(
ID2D1Bitmap1
*
aMappableBitmap
SurfaceFormat
aFormat
)
;
~
DataSourceSurfaceD2D1
(
)
;
SurfaceType
GetType
(
)
const
override
{
return
SurfaceType
:
:
DATA
;
}
IntSize
GetSize
(
)
const
override
;
SurfaceFormat
GetFormat
(
)
const
override
{
return
mFormat
;
}
bool
IsValid
(
)
const
override
{
return
!
!
mBitmap
;
}
uint8_t
*
GetData
(
)
override
;
int32_t
Stride
(
)
override
;
bool
Map
(
MapType
MappedSurface
*
aMappedSurface
)
override
;
void
Unmap
(
)
override
;
private
:
friend
class
SourceSurfaceD2DTarget
;
void
EnsureMapped
(
)
;
mutable
RefPtr
<
ID2D1Bitmap1
>
mBitmap
;
SurfaceFormat
mFormat
;
D2D1_MAPPED_RECT
mMap
;
bool
mIsMapped
;
bool
mImplicitMapped
;
}
;
}
}
#
endif
