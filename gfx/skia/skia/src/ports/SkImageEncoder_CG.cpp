#
include
"
SkImageEncoderPriv
.
h
"
#
if
defined
(
SK_BUILD_FOR_MAC
)
|
|
defined
(
SK_BUILD_FOR_IOS
)
#
include
"
SkBitmap
.
h
"
#
include
"
SkCGUtils
.
h
"
#
include
"
SkColorPriv
.
h
"
#
include
"
SkData
.
h
"
#
include
"
SkStream
.
h
"
#
include
"
SkStreamPriv
.
h
"
#
include
"
SkTemplates
.
h
"
#
include
"
SkUnPreMultiply
.
h
"
#
ifdef
SK_BUILD_FOR_MAC
#
include
<
ApplicationServices
/
ApplicationServices
.
h
>
#
endif
#
ifdef
SK_BUILD_FOR_IOS
#
include
<
CoreGraphics
/
CoreGraphics
.
h
>
#
include
<
ImageIO
/
ImageIO
.
h
>
#
include
<
MobileCoreServices
/
MobileCoreServices
.
h
>
#
endif
static
size_t
consumer_put
(
void
*
info
const
void
*
buffer
size_t
count
)
{
SkWStream
*
stream
=
reinterpret_cast
<
SkWStream
*
>
(
info
)
;
return
stream
-
>
write
(
buffer
count
)
?
count
:
0
;
}
static
void
consumer_release
(
void
*
info
)
{
}
static
CGDataConsumerRef
SkStreamToCGDataConsumer
(
SkWStream
*
stream
)
{
CGDataConsumerCallbacks
procs
;
procs
.
putBytes
=
consumer_put
;
procs
.
releaseConsumer
=
consumer_release
;
return
CGDataConsumerCreate
(
stream
&
procs
)
;
}
static
CGImageDestinationRef
SkStreamToImageDestination
(
SkWStream
*
stream
CFStringRef
type
)
{
CGDataConsumerRef
consumer
=
SkStreamToCGDataConsumer
(
stream
)
;
if
(
nullptr
=
=
consumer
)
{
return
nullptr
;
}
SkAutoTCallVProc
<
const
void
CFRelease
>
arconsumer
(
consumer
)
;
return
CGImageDestinationCreateWithDataConsumer
(
consumer
type
1
nullptr
)
;
}
bool
SkEncodeImageWithCG
(
SkWStream
*
stream
const
SkPixmap
&
pixmap
SkEncodedImageFormat
format
)
{
SkBitmap
bm
;
if
(
!
bm
.
installPixels
(
pixmap
)
)
{
return
false
;
}
bm
.
setImmutable
(
)
;
CFStringRef
type
;
switch
(
format
)
{
case
SkEncodedImageFormat
:
:
kICO
:
type
=
kUTTypeICO
;
break
;
case
SkEncodedImageFormat
:
:
kBMP
:
type
=
kUTTypeBMP
;
break
;
case
SkEncodedImageFormat
:
:
kGIF
:
type
=
kUTTypeGIF
;
break
;
case
SkEncodedImageFormat
:
:
kJPEG
:
type
=
kUTTypeJPEG
;
break
;
case
SkEncodedImageFormat
:
:
kPNG
:
if
(
bm
.
colorType
(
)
=
=
kARGB_4444_SkColorType
)
{
SkBitmap
bitmap8888
;
bm
.
copyTo
(
&
bitmap8888
kN32_SkColorType
)
;
bm
.
swap
(
bitmap8888
)
;
}
type
=
kUTTypePNG
;
break
;
default
:
return
false
;
}
CGImageDestinationRef
dst
=
SkStreamToImageDestination
(
stream
type
)
;
if
(
nullptr
=
=
dst
)
{
return
false
;
}
SkAutoTCallVProc
<
const
void
CFRelease
>
ardst
(
dst
)
;
CGImageRef
image
=
SkCreateCGImageRef
(
bm
)
;
if
(
nullptr
=
=
image
)
{
return
false
;
}
SkAutoTCallVProc
<
CGImage
CGImageRelease
>
agimage
(
image
)
;
CGImageDestinationAddImage
(
dst
image
nullptr
)
;
return
CGImageDestinationFinalize
(
dst
)
;
}
#
endif
