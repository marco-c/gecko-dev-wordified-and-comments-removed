#
ifndef
GrUserStencilSettings_DEFINED
#
define
GrUserStencilSettings_DEFINED
#
include
"
include
/
gpu
/
GrTypes
.
h
"
enum
GrStencilFlags
:
int
{
kDisabled_StencilFlag
=
(
1
<
<
0
)
kTestAlwaysPasses_StencilFlag
=
(
1
<
<
1
)
kNoModifyStencil_StencilFlag
=
(
1
<
<
2
)
kNoWrapOps_StencilFlag
=
(
1
<
<
3
)
kSingleSided_StencilFlag
=
(
1
<
<
4
)
kLast_StencilFlag
=
kSingleSided_StencilFlag
kAll_StencilFlags
=
kLast_StencilFlag
|
(
kLast_StencilFlag
-
1
)
}
;
template
<
typename
TTest
typename
TOp
>
struct
GrTStencilFaceSettings
{
uint16_t
fRef
;
TTest
fTest
;
uint16_t
fTestMask
;
TOp
fPassOp
;
TOp
fFailOp
;
uint16_t
fWriteMask
;
}
;
enum
class
GrUserStencilTest
:
uint16_t
{
kAlwaysIfInClip
kEqualIfInClip
kLessIfInClip
kLEqualIfInClip
kAlways
kNever
kGreater
kGEqual
kLess
kLEqual
kEqual
kNotEqual
}
;
constexpr
static
GrUserStencilTest
kLastClippedStencilTest
=
GrUserStencilTest
:
:
kLEqualIfInClip
;
constexpr
static
int
kGrUserStencilTestCount
=
1
+
(
int
)
GrUserStencilTest
:
:
kNotEqual
;
enum
class
GrUserStencilOp
:
uint8_t
{
kKeep
kZero
kReplace
kInvert
kIncWrap
kDecWrap
kIncMaybeClamp
kDecMaybeClamp
kZeroClipBit
kSetClipBit
kInvertClipBit
kSetClipAndReplaceUserBits
kZeroClipAndUserBits
}
;
constexpr
static
GrUserStencilOp
kLastUserOnlyStencilOp
=
GrUserStencilOp
:
:
kDecMaybeClamp
;
constexpr
static
GrUserStencilOp
kLastClipOnlyStencilOp
=
GrUserStencilOp
:
:
kInvertClipBit
;
constexpr
static
int
kGrUserStencilOpCount
=
1
+
(
int
)
GrUserStencilOp
:
:
kZeroClipAndUserBits
;
struct
GrUserStencilSettings
{
typedef
GrTStencilFaceSettings
<
GrUserStencilTest
GrUserStencilOp
>
Face
;
template
<
GrUserStencilTest
GrUserStencilOp
PassOp
GrUserStencilOp
FailOp
>
struct
Attrs
;
template
<
uint16_t
Ref
GrUserStencilTest
Test
uint16_t
TestMask
GrUserStencilOp
PassOp
GrUserStencilOp
FailOp
uint16_t
WriteMask
>
struct
Init
{
}
;
template
<
uint16_t
CWRef
uint16_t
CCWRef
GrUserStencilTest
CWTest
GrUserStencilTest
CCWTest
uint16_t
CWTestMask
uint16_t
CCWTestMask
GrUserStencilOp
CWPassOp
GrUserStencilOp
CCWPassOp
GrUserStencilOp
CWFailOp
GrUserStencilOp
CCWFailOp
uint16_t
CWWriteMask
uint16_t
CCWWriteMask
>
struct
InitSeparate
{
}
;
template
<
uint16_t
Ref
GrUserStencilTest
Test
uint16_t
TestMask
GrUserStencilOp
PassOp
GrUserStencilOp
FailOp
uint16_t
WriteMask
>
constexpr
static
Init
<
Ref
Test
TestMask
PassOp
FailOp
WriteMask
>
StaticInit
(
)
{
return
Init
<
Ref
Test
TestMask
PassOp
FailOp
WriteMask
>
(
)
;
}
template
<
uint16_t
CWRef
uint16_t
CCWRef
GrUserStencilTest
CWTest
GrUserStencilTest
CCWTest
uint16_t
CWTestMask
uint16_t
CCWTestMask
GrUserStencilOp
CWPassOp
GrUserStencilOp
CCWPassOp
GrUserStencilOp
CWFailOp
GrUserStencilOp
CCWFailOp
uint16_t
CWWriteMask
uint16_t
CCWWriteMask
>
constexpr
static
InitSeparate
<
CWRef
CCWRef
CWTest
CCWTest
CWTestMask
CCWTestMask
CWPassOp
CCWPassOp
CWFailOp
CCWFailOp
CWWriteMask
CCWWriteMask
>
StaticInitSeparate
(
)
{
return
InitSeparate
<
CWRef
CCWRef
CWTest
CCWTest
CWTestMask
CCWTestMask
CWPassOp
CCWPassOp
CWFailOp
CCWFailOp
CWWriteMask
CCWWriteMask
>
(
)
;
}
template
<
uint16_t
Ref
GrUserStencilTest
Test
uint16_t
TestMask
GrUserStencilOp
PassOp
GrUserStencilOp
FailOp
uint16_t
WriteMask
typename
Attrs
=
Attrs
<
Test
PassOp
FailOp
>
>
constexpr
explicit
GrUserStencilSettings
(
const
Init
<
Ref
Test
TestMask
PassOp
FailOp
WriteMask
>
&
)
:
fCWFlags
{
(
uint16_t
)
(
Attrs
:
:
Flags
(
false
)
|
kSingleSided_StencilFlag
)
(
uint16_t
)
(
Attrs
:
:
Flags
(
true
)
|
kSingleSided_StencilFlag
)
}
fCWFace
{
Ref
Test
Attrs
:
:
EffectiveTestMask
(
TestMask
)
PassOp
FailOp
Attrs
:
:
EffectiveWriteMask
(
WriteMask
)
}
fCCWFlags
{
(
uint16_t
)
(
Attrs
:
:
Flags
(
false
)
|
kSingleSided_StencilFlag
)
(
uint16_t
)
(
Attrs
:
:
Flags
(
true
)
|
kSingleSided_StencilFlag
)
}
fCCWFace
{
Ref
Test
Attrs
:
:
EffectiveTestMask
(
TestMask
)
PassOp
FailOp
Attrs
:
:
EffectiveWriteMask
(
WriteMask
)
}
{
}
template
<
uint16_t
CWRef
uint16_t
CCWRef
GrUserStencilTest
CWTest
GrUserStencilTest
CCWTest
uint16_t
CWTestMask
uint16_t
CCWTestMask
GrUserStencilOp
CWPassOp
GrUserStencilOp
CCWPassOp
GrUserStencilOp
CWFailOp
GrUserStencilOp
CCWFailOp
uint16_t
CWWriteMask
uint16_t
CCWWriteMask
typename
CWAttrs
=
Attrs
<
CWTest
CWPassOp
CWFailOp
>
typename
CCWAttrs
=
Attrs
<
CCWTest
CCWPassOp
CCWFailOp
>
>
constexpr
explicit
GrUserStencilSettings
(
const
InitSeparate
<
CWRef
CCWRef
CWTest
CCWTest
CWTestMask
CCWTestMask
CWPassOp
CCWPassOp
CWFailOp
CCWFailOp
CWWriteMask
CCWWriteMask
>
&
)
:
fCWFlags
{
CWAttrs
:
:
Flags
(
false
)
CWAttrs
:
:
Flags
(
true
)
}
fCWFace
{
CWRef
CWTest
CWAttrs
:
:
EffectiveTestMask
(
CWTestMask
)
CWPassOp
CWFailOp
CWAttrs
:
:
EffectiveWriteMask
(
CWWriteMask
)
}
fCCWFlags
{
CCWAttrs
:
:
Flags
(
false
)
CCWAttrs
:
:
Flags
(
true
)
}
fCCWFace
{
CCWRef
CCWTest
CCWAttrs
:
:
EffectiveTestMask
(
CCWTestMask
)
CCWPassOp
CCWFailOp
CCWAttrs
:
:
EffectiveWriteMask
(
CCWWriteMask
)
}
{
}
GrUserStencilSettings
(
)
=
delete
;
GrUserStencilSettings
(
const
GrUserStencilSettings
&
)
=
delete
;
uint16_t
flags
(
bool
hasStencilClip
)
const
{
return
fCWFlags
[
hasStencilClip
]
&
fCCWFlags
[
hasStencilClip
]
;
}
bool
isDisabled
(
bool
hasStencilClip
)
const
{
return
this
-
>
flags
(
hasStencilClip
)
&
kDisabled_StencilFlag
;
}
bool
testAlwaysPasses
(
bool
hasStencilClip
)
const
{
return
this
-
>
flags
(
hasStencilClip
)
&
kTestAlwaysPasses_StencilFlag
;
}
bool
isTwoSided
(
bool
hasStencilClip
)
const
{
return
!
(
this
-
>
flags
(
hasStencilClip
)
&
kSingleSided_StencilFlag
)
;
}
bool
usesWrapOp
(
bool
hasStencilClip
)
const
{
return
!
(
this
-
>
flags
(
hasStencilClip
)
&
kNoWrapOps_StencilFlag
)
;
}
const
uint16_t
fCWFlags
[
2
]
;
const
Face
fCWFace
;
const
uint16_t
fCCWFlags
[
2
]
;
const
Face
fCCWFace
;
static
const
GrUserStencilSettings
&
kUnused
;
bool
isUnused
(
)
const
{
return
this
=
=
&
kUnused
;
}
}
;
template
<
GrUserStencilTest
Test
GrUserStencilOp
PassOp
GrUserStencilOp
FailOp
>
struct
GrUserStencilSettings
:
:
Attrs
{
static_assert
(
GrUserStencilOp
:
:
kKeep
=
=
PassOp
|
|
GrUserStencilOp
:
:
kKeep
=
=
FailOp
|
|
(
PassOp
<
=
kLastUserOnlyStencilOp
)
=
=
(
FailOp
<
=
kLastUserOnlyStencilOp
)
)
;
static_assert
(
GrUserStencilOp
:
:
kKeep
=
=
PassOp
|
|
GrUserStencilOp
:
:
kKeep
=
=
FailOp
|
|
(
PassOp
<
=
kLastClipOnlyStencilOp
)
=
=
(
FailOp
<
=
kLastClipOnlyStencilOp
)
)
;
constexpr
static
bool
TestAlwaysPasses
(
bool
hasStencilClip
)
{
return
(
!
hasStencilClip
&
&
GrUserStencilTest
:
:
kAlwaysIfInClip
=
=
Test
)
|
|
GrUserStencilTest
:
:
kAlways
=
=
Test
;
}
constexpr
static
bool
DoesNotModifyStencil
(
bool
hasStencilClip
)
{
return
(
GrUserStencilTest
:
:
kNever
=
=
Test
|
|
GrUserStencilOp
:
:
kKeep
=
=
PassOp
)
&
&
(
TestAlwaysPasses
(
hasStencilClip
)
|
|
GrUserStencilOp
:
:
kKeep
=
=
FailOp
)
;
}
constexpr
static
bool
IsDisabled
(
bool
hasStencilClip
)
{
return
TestAlwaysPasses
(
hasStencilClip
)
&
&
DoesNotModifyStencil
(
hasStencilClip
)
;
}
constexpr
static
bool
UsesWrapOps
(
)
{
return
GrUserStencilOp
:
:
kIncWrap
=
=
PassOp
|
|
GrUserStencilOp
:
:
kDecWrap
=
=
PassOp
|
|
GrUserStencilOp
:
:
kIncWrap
=
=
FailOp
|
|
GrUserStencilOp
:
:
kDecWrap
=
=
FailOp
;
}
constexpr
static
bool
TestIgnoresRef
(
)
{
return
(
GrUserStencilTest
:
:
kAlwaysIfInClip
=
=
Test
|
|
GrUserStencilTest
:
:
kAlways
=
=
Test
|
|
GrUserStencilTest
:
:
kNever
=
=
Test
)
;
}
constexpr
static
uint16_t
Flags
(
bool
hasStencilClip
)
{
return
(
IsDisabled
(
hasStencilClip
)
?
kDisabled_StencilFlag
:
0
)
|
(
TestAlwaysPasses
(
hasStencilClip
)
?
kTestAlwaysPasses_StencilFlag
:
0
)
|
(
DoesNotModifyStencil
(
hasStencilClip
)
?
kNoModifyStencil_StencilFlag
:
0
)
|
(
UsesWrapOps
(
)
?
0
:
kNoWrapOps_StencilFlag
)
;
}
constexpr
static
uint16_t
EffectiveTestMask
(
uint16_t
testMask
)
{
return
TestIgnoresRef
(
)
?
0
:
testMask
;
}
constexpr
static
uint16_t
EffectiveWriteMask
(
uint16_t
writeMask
)
{
return
DoesNotModifyStencil
(
true
)
?
0
:
writeMask
;
}
}
;
#
endif
