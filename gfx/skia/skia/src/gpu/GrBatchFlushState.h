#
ifndef
GrBatchBuffer_DEFINED
#
define
GrBatchBuffer_DEFINED
#
include
"
GrBufferAllocPool
.
h
"
#
include
"
batches
/
GrVertexBatch
.
h
"
class
GrResourceProvider
;
class
GrBatchUploader
:
:
TextureUploader
{
public
:
TextureUploader
(
GrGpu
*
gpu
)
:
fGpu
(
gpu
)
{
SkASSERT
(
gpu
)
;
}
bool
writeTexturePixels
(
GrTexture
*
texture
int
left
int
top
int
width
int
height
GrPixelConfig
config
const
void
*
buffer
size_t
rowBytes
)
{
return
fGpu
-
>
writePixels
(
texture
left
top
width
height
config
buffer
rowBytes
)
;
}
private
:
GrGpu
*
fGpu
;
}
;
class
GrBatchFlushState
{
public
:
GrBatchFlushState
(
GrGpu
*
GrResourceProvider
*
)
;
~
GrBatchFlushState
(
)
{
this
-
>
reset
(
)
;
}
void
advanceToken
(
)
{
+
+
fCurrentToken
;
}
void
advanceLastFlushedToken
(
)
{
+
+
fLastFlushedToken
;
}
void
addASAPUpload
(
GrBatchUploader
*
upload
)
{
fAsapUploads
.
push_back
(
)
.
reset
(
SkRef
(
upload
)
)
;
}
const
GrCaps
&
caps
(
)
const
{
return
*
fGpu
-
>
caps
(
)
;
}
GrResourceProvider
*
resourceProvider
(
)
const
{
return
fResourceProvider
;
}
bool
hasTokenBeenFlushed
(
GrBatchToken
token
)
const
{
return
fLastFlushedToken
>
=
token
;
}
GrBatchToken
currentToken
(
)
const
{
return
fCurrentToken
;
}
GrBatchToken
lastFlushedToken
(
)
const
{
return
fLastFlushedToken
;
}
GrBatchToken
asapToken
(
)
const
{
return
fLastFlushedToken
+
1
;
}
void
*
makeVertexSpace
(
size_t
vertexSize
int
vertexCount
const
GrVertexBuffer
*
*
buffer
int
*
startVertex
)
;
uint16_t
*
makeIndexSpace
(
int
indexCount
const
GrIndexBuffer
*
*
buffer
int
*
startIndex
)
;
void
preIssueDraws
(
)
{
fVertexPool
.
unmap
(
)
;
fIndexPool
.
unmap
(
)
;
int
uploadCount
=
fAsapUploads
.
count
(
)
;
for
(
int
i
=
0
;
i
<
uploadCount
;
i
+
+
)
{
fAsapUploads
[
i
]
-
>
upload
(
&
fUploader
)
;
}
fAsapUploads
.
reset
(
)
;
}
void
putBackIndices
(
size_t
indices
)
{
fIndexPool
.
putBack
(
indices
*
sizeof
(
uint16_t
)
)
;
}
void
putBackVertexSpace
(
size_t
sizeInBytes
)
{
fVertexPool
.
putBack
(
sizeInBytes
)
;
}
GrBatchUploader
:
:
TextureUploader
*
uploader
(
)
{
return
&
fUploader
;
}
GrGpu
*
gpu
(
)
{
return
fGpu
;
}
void
reset
(
)
{
fVertexPool
.
reset
(
)
;
fIndexPool
.
reset
(
)
;
}
private
:
GrGpu
*
fGpu
;
GrBatchUploader
:
:
TextureUploader
fUploader
;
GrResourceProvider
*
fResourceProvider
;
GrVertexBufferAllocPool
fVertexPool
;
GrIndexBufferAllocPool
fIndexPool
;
SkTArray
<
SkAutoTUnref
<
GrBatchUploader
>
true
>
fAsapUploads
;
GrBatchToken
fCurrentToken
;
GrBatchToken
fLastFlushedToken
;
}
;
class
GrDrawBatch
:
:
Target
{
public
:
Target
(
GrBatchFlushState
*
state
GrDrawBatch
*
batch
)
:
fState
(
state
)
fBatch
(
batch
)
{
}
void
upload
(
GrBatchUploader
*
upload
)
{
if
(
this
-
>
asapToken
(
)
=
=
upload
-
>
lastUploadToken
(
)
)
{
fState
-
>
addASAPUpload
(
upload
)
;
}
else
{
fBatch
-
>
fInlineUploads
.
push_back
(
)
.
reset
(
SkRef
(
upload
)
)
;
}
}
bool
hasTokenBeenFlushed
(
GrBatchToken
token
)
const
{
return
fState
-
>
hasTokenBeenFlushed
(
token
)
;
}
GrBatchToken
currentToken
(
)
const
{
return
fState
-
>
currentToken
(
)
;
}
GrBatchToken
asapToken
(
)
const
{
return
fState
-
>
asapToken
(
)
;
}
const
GrCaps
&
caps
(
)
const
{
return
fState
-
>
caps
(
)
;
}
GrResourceProvider
*
resourceProvider
(
)
const
{
return
fState
-
>
resourceProvider
(
)
;
}
protected
:
GrDrawBatch
*
batch
(
)
{
return
fBatch
;
}
GrBatchFlushState
*
state
(
)
{
return
fState
;
}
private
:
GrBatchFlushState
*
fState
;
GrDrawBatch
*
fBatch
;
}
;
class
GrVertexBatch
:
:
Target
:
public
GrDrawBatch
:
:
Target
{
public
:
Target
(
GrBatchFlushState
*
state
GrVertexBatch
*
batch
)
:
INHERITED
(
state
batch
)
{
}
void
initDraw
(
const
GrPrimitiveProcessor
*
primProc
const
GrPipeline
*
pipeline
)
{
GrVertexBatch
:
:
DrawArray
*
draws
=
this
-
>
vertexBatch
(
)
-
>
fDrawArrays
.
addToTail
(
)
;
draws
-
>
fPrimitiveProcessor
.
reset
(
primProc
)
;
this
-
>
state
(
)
-
>
advanceToken
(
)
;
}
void
draw
(
const
GrVertices
&
vertices
)
{
this
-
>
vertexBatch
(
)
-
>
fDrawArrays
.
tail
(
)
-
>
fDraws
.
push_back
(
vertices
)
;
}
void
*
makeVertexSpace
(
size_t
vertexSize
int
vertexCount
const
GrVertexBuffer
*
*
buffer
int
*
startVertex
)
{
return
this
-
>
state
(
)
-
>
makeVertexSpace
(
vertexSize
vertexCount
buffer
startVertex
)
;
}
uint16_t
*
makeIndexSpace
(
int
indexCount
const
GrIndexBuffer
*
*
buffer
int
*
startIndex
)
{
return
this
-
>
state
(
)
-
>
makeIndexSpace
(
indexCount
buffer
startIndex
)
;
}
void
putBackIndices
(
int
indices
)
{
this
-
>
state
(
)
-
>
putBackIndices
(
indices
)
;
}
void
putBackVertices
(
int
vertices
size_t
vertexStride
)
{
this
-
>
state
(
)
-
>
putBackVertexSpace
(
vertices
*
vertexStride
)
;
}
private
:
GrVertexBatch
*
vertexBatch
(
)
{
return
static_cast
<
GrVertexBatch
*
>
(
this
-
>
batch
(
)
)
;
}
typedef
GrDrawBatch
:
:
Target
INHERITED
;
}
;
#
endif
