#
ifndef
GrVkUniformHandler_DEFINED
#
define
GrVkUniformHandler_DEFINED
#
include
"
include
/
gpu
/
vk
/
GrVkTypes
.
h
"
#
include
"
src
/
gpu
/
GrAllocator
.
h
"
#
include
"
src
/
gpu
/
GrSamplerState
.
h
"
#
include
"
src
/
gpu
/
GrShaderVar
.
h
"
#
include
"
src
/
gpu
/
glsl
/
GrGLSLUniformHandler
.
h
"
#
include
"
src
/
gpu
/
vk
/
GrVkSampler
.
h
"
class
GrVkUniformHandler
:
public
GrGLSLUniformHandler
{
public
:
static
const
int
kUniformsPerBlock
=
8
;
enum
{
kUniformBufferDescSet
=
0
kSamplerDescSet
=
1
}
;
enum
{
kUniformBinding
=
0
}
;
struct
UniformInfo
{
GrShaderVar
fVariable
;
uint32_t
fVisibility
;
uint32_t
fUBOffset
;
const
GrVkSampler
*
fImmutableSampler
=
nullptr
;
}
;
typedef
GrTAllocator
<
UniformInfo
>
UniformInfoArray
;
~
GrVkUniformHandler
(
)
override
;
const
GrShaderVar
&
getUniformVariable
(
UniformHandle
u
)
const
override
{
return
fUniforms
[
u
.
toIndex
(
)
]
.
fVariable
;
}
const
char
*
getUniformCStr
(
UniformHandle
u
)
const
override
{
return
this
-
>
getUniformVariable
(
u
)
.
c_str
(
)
;
}
uint32_t
getRTHeightOffset
(
)
const
;
private
:
explicit
GrVkUniformHandler
(
GrGLSLProgramBuilder
*
program
)
:
INHERITED
(
program
)
fUniforms
(
kUniformsPerBlock
)
fSamplers
(
kUniformsPerBlock
)
fCurrentUBOOffset
(
0
)
{
}
UniformHandle
internalAddUniformArray
(
uint32_t
visibility
GrSLType
type
const
char
*
name
bool
mangleName
int
arrayCount
const
char
*
*
outName
)
override
;
void
updateUniformVisibility
(
UniformHandle
u
uint32_t
visibility
)
override
{
fUniforms
[
u
.
toIndex
(
)
]
.
fVisibility
|
=
visibility
;
}
SamplerHandle
addSampler
(
const
GrTextureProxy
*
const
GrSamplerState
&
const
GrSwizzle
&
const
char
*
name
const
GrShaderCaps
*
)
override
;
int
numSamplers
(
)
const
{
return
fSamplers
.
count
(
)
;
}
const
char
*
samplerVariable
(
SamplerHandle
handle
)
const
override
{
return
fSamplers
[
handle
.
toIndex
(
)
]
.
fVariable
.
c_str
(
)
;
}
GrSwizzle
samplerSwizzle
(
SamplerHandle
handle
)
const
override
{
return
fSamplerSwizzles
[
handle
.
toIndex
(
)
]
;
}
uint32_t
samplerVisibility
(
SamplerHandle
handle
)
const
{
return
fSamplers
[
handle
.
toIndex
(
)
]
.
fVisibility
;
}
const
GrVkSampler
*
immutableSampler
(
UniformHandle
u
)
const
{
return
fSamplers
[
u
.
toIndex
(
)
]
.
fImmutableSampler
;
}
void
appendUniformDecls
(
GrShaderFlags
SkString
*
)
const
override
;
const
UniformInfo
&
getUniformInfo
(
UniformHandle
u
)
const
{
return
fUniforms
[
u
.
toIndex
(
)
]
;
}
UniformInfoArray
fUniforms
;
UniformInfoArray
fSamplers
;
SkTArray
<
GrSwizzle
>
fSamplerSwizzles
;
uint32_t
fCurrentUBOOffset
;
friend
class
GrVkPipelineStateBuilder
;
friend
class
GrVkDescriptorSetManager
;
typedef
GrGLSLUniformHandler
INHERITED
;
}
;
#
endif
