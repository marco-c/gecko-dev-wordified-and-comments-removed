#
ifndef
GrVkPipelineState_DEFINED
#
define
GrVkPipelineState_DEFINED
#
include
"
GrProgramDesc
.
h
"
#
include
"
GrStencilSettings
.
h
"
#
include
"
GrVkDescriptorSetManager
.
h
"
#
include
"
GrVkImage
.
h
"
#
include
"
GrVkPipelineStateDataManager
.
h
"
#
include
"
glsl
/
GrGLSLProgramBuilder
.
h
"
#
include
"
vk
/
GrVkDefines
.
h
"
class
GrPipeline
;
class
GrVkBufferView
;
class
GrVkCommandBuffer
;
class
GrVkDescriptorPool
;
class
GrVkDescriptorSet
;
class
GrVkGpu
;
class
GrVkImageView
;
class
GrVkPipeline
;
class
GrVkSampler
;
class
GrVkUniformBuffer
;
class
GrVkPipelineState
:
public
SkRefCnt
{
public
:
typedef
GrGLSLProgramBuilder
:
:
BuiltinUniformHandles
BuiltinUniformHandles
;
~
GrVkPipelineState
(
)
;
GrVkPipeline
*
vkPipeline
(
)
const
{
return
fPipeline
;
}
void
setData
(
GrVkGpu
*
const
GrPrimitiveProcessor
&
const
GrPipeline
&
)
;
void
bind
(
const
GrVkGpu
*
gpu
GrVkCommandBuffer
*
commandBuffer
)
;
void
addUniformResources
(
GrVkCommandBuffer
&
)
;
void
freeGPUResources
(
const
GrVkGpu
*
gpu
)
;
void
freeTempResources
(
const
GrVkGpu
*
gpu
)
;
void
abandonGPUResources
(
)
;
class
Desc
:
public
GrProgramDesc
{
public
:
static
bool
Build
(
Desc
*
const
GrPrimitiveProcessor
&
const
GrPipeline
&
const
GrStencilSettings
&
GrPrimitiveType
primitiveType
const
GrShaderCaps
&
)
;
private
:
typedef
GrProgramDesc
INHERITED
;
}
;
const
Desc
&
getDesc
(
)
{
return
fDesc
;
}
private
:
typedef
GrVkPipelineStateDataManager
:
:
UniformInfoArray
UniformInfoArray
;
typedef
GrGLSLProgramDataManager
:
:
UniformHandle
UniformHandle
;
GrVkPipelineState
(
GrVkGpu
*
gpu
const
GrVkPipelineState
:
:
Desc
&
GrVkPipeline
*
pipeline
VkPipelineLayout
layout
const
GrVkDescriptorSetManager
:
:
Handle
&
samplerDSHandle
const
GrVkDescriptorSetManager
:
:
Handle
&
texelBufferDSHandle
const
BuiltinUniformHandles
&
builtinUniformHandles
const
UniformInfoArray
&
uniforms
uint32_t
geometryUniformSize
uint32_t
fragmentUniformSize
uint32_t
numSamplers
uint32_t
numTexelBuffers
std
:
:
unique_ptr
<
GrGLSLPrimitiveProcessor
>
geometryProcessor
std
:
:
unique_ptr
<
GrGLSLXferProcessor
>
xferProcessor
const
GrGLSLFragProcs
&
fragmentProcessors
)
;
void
writeUniformBuffers
(
const
GrVkGpu
*
gpu
)
;
void
writeSamplers
(
GrVkGpu
*
gpu
const
SkTArray
<
const
GrResourceIOProcessor
:
:
TextureSampler
*
>
&
textureBindings
bool
allowSRGBInputs
)
;
void
writeTexelBuffers
(
GrVkGpu
*
gpu
const
SkTArray
<
const
GrResourceIOProcessor
:
:
BufferAccess
*
>
&
bufferAccesses
)
;
struct
RenderTargetState
{
SkISize
fRenderTargetSize
;
GrSurfaceOrigin
fRenderTargetOrigin
;
RenderTargetState
(
)
{
this
-
>
invalidate
(
)
;
}
void
invalidate
(
)
{
fRenderTargetSize
.
fWidth
=
-
1
;
fRenderTargetSize
.
fHeight
=
-
1
;
fRenderTargetOrigin
=
(
GrSurfaceOrigin
)
-
1
;
}
void
getRTAdjustmentVec
(
float
*
destVec
)
{
destVec
[
0
]
=
2
.
f
/
fRenderTargetSize
.
fWidth
;
destVec
[
1
]
=
-
1
.
f
;
if
(
kBottomLeft_GrSurfaceOrigin
=
=
fRenderTargetOrigin
)
{
destVec
[
2
]
=
-
2
.
f
/
fRenderTargetSize
.
fHeight
;
destVec
[
3
]
=
1
.
f
;
}
else
{
destVec
[
2
]
=
2
.
f
/
fRenderTargetSize
.
fHeight
;
destVec
[
3
]
=
-
1
.
f
;
}
}
}
;
void
setRenderTargetState
(
const
GrRenderTargetProxy
*
)
;
GrVkPipeline
*
fPipeline
;
VkPipelineLayout
fPipelineLayout
;
VkDescriptorSet
fDescriptorSets
[
3
]
;
const
GrVkDescriptorSet
*
fUniformDescriptorSet
;
const
GrVkDescriptorSet
*
fSamplerDescriptorSet
;
const
GrVkDescriptorSet
*
fTexelBufferDescriptorSet
;
const
GrVkDescriptorSetManager
:
:
Handle
fSamplerDSHandle
;
const
GrVkDescriptorSetManager
:
:
Handle
fTexelBufferDSHandle
;
std
:
:
unique_ptr
<
GrVkUniformBuffer
>
fGeometryUniformBuffer
;
std
:
:
unique_ptr
<
GrVkUniformBuffer
>
fFragmentUniformBuffer
;
SkTDArray
<
GrVkSampler
*
>
fSamplers
;
SkTDArray
<
const
GrVkImageView
*
>
fTextureViews
;
SkTDArray
<
const
GrVkResource
*
>
fTextures
;
SkTDArray
<
const
GrVkBufferView
*
>
fBufferViews
;
SkTDArray
<
const
GrVkResource
*
>
fTexelBuffers
;
RenderTargetState
fRenderTargetState
;
BuiltinUniformHandles
fBuiltinUniformHandles
;
std
:
:
unique_ptr
<
GrGLSLPrimitiveProcessor
>
fGeometryProcessor
;
std
:
:
unique_ptr
<
GrGLSLXferProcessor
>
fXferProcessor
;
GrGLSLFragProcs
fFragmentProcessors
;
Desc
fDesc
;
GrVkPipelineStateDataManager
fDataManager
;
int
fNumSamplers
;
int
fNumTexelBuffers
;
friend
class
GrVkPipelineStateBuilder
;
}
;
#
endif
