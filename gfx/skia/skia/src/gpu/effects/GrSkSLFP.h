#
ifndef
GrSkSLFP_DEFINED
#
define
GrSkSLFP_DEFINED
#
include
"
include
/
core
/
SkRefCnt
.
h
"
#
include
"
src
/
gpu
/
GrCaps
.
h
"
#
include
"
src
/
gpu
/
GrCoordTransform
.
h
"
#
include
"
src
/
gpu
/
GrFragmentProcessor
.
h
"
#
include
"
src
/
gpu
/
GrShaderCaps
.
h
"
#
include
"
src
/
gpu
/
GrSkSLFPFactoryCache
.
h
"
#
include
"
src
/
sksl
/
SkSLCompiler
.
h
"
#
include
"
src
/
sksl
/
SkSLPipelineStageCodeGenerator
.
h
"
#
include
<
atomic
>
#
if
GR_TEST_UTILS
#
define
GR_FP_SRC_STRING
const
char
*
#
else
#
define
GR_FP_SRC_STRING
static
const
char
*
#
endif
class
GrContext_Base
;
class
GrSkSLFPFactory
;
class
GrSkSLFP
:
public
GrFragmentProcessor
{
public
:
static
int
NewIndex
(
)
{
static
std
:
:
atomic
<
int
>
nextIndex
{
0
}
;
return
nextIndex
+
+
;
}
static
std
:
:
unique_ptr
<
GrSkSLFP
>
Make
(
GrContext_Base
*
context
int
index
const
char
*
name
const
char
*
sksl
const
void
*
inputs
size_t
inputSize
SkSL
:
:
Program
:
:
Kind
kind
=
SkSL
:
:
Program
:
:
kPipelineStage_Kind
const
SkMatrix
*
matrix
=
nullptr
)
;
static
std
:
:
unique_ptr
<
GrSkSLFP
>
Make
(
GrContext_Base
*
context
int
index
const
char
*
name
SkString
sksl
const
void
*
inputs
size_t
inputSize
SkSL
:
:
Program
:
:
Kind
kind
=
SkSL
:
:
Program
:
:
kPipelineStage_Kind
const
SkMatrix
*
matrix
=
nullptr
)
;
const
char
*
name
(
)
const
override
;
void
addChild
(
std
:
:
unique_ptr
<
GrFragmentProcessor
>
child
)
;
std
:
:
unique_ptr
<
GrFragmentProcessor
>
clone
(
)
const
override
;
private
:
GrSkSLFP
(
sk_sp
<
GrSkSLFPFactoryCache
>
factoryCache
const
GrShaderCaps
*
shaderCaps
SkSL
:
:
Program
:
:
Kind
kind
int
fIndex
const
char
*
name
const
char
*
sksl
SkString
skslString
const
void
*
inputs
size_t
inputSize
const
SkMatrix
*
matrix
)
;
GrSkSLFP
(
const
GrSkSLFP
&
other
)
;
GrGLSLFragmentProcessor
*
onCreateGLSLInstance
(
)
const
override
;
void
onGetGLSLProcessorKey
(
const
GrShaderCaps
&
GrProcessorKeyBuilder
*
)
const
override
;
bool
onIsEqual
(
const
GrFragmentProcessor
&
)
const
override
;
void
createFactory
(
)
const
;
sk_sp
<
GrSkSLFPFactoryCache
>
fFactoryCache
;
const
sk_sp
<
GrShaderCaps
>
fShaderCaps
;
mutable
sk_sp
<
GrSkSLFPFactory
>
fFactory
;
SkSL
:
:
Program
:
:
Kind
fKind
;
int
fIndex
;
const
char
*
fName
;
SkString
fSkSLString
;
const
char
*
fSkSL
;
const
std
:
:
unique_ptr
<
int8_t
[
]
>
fInputs
;
size_t
fInputSize
;
GrCoordTransform
fCoordTransform
;
mutable
SkSL
:
:
String
fKey
;
GR_DECLARE_FRAGMENT_PROCESSOR_TEST
typedef
GrFragmentProcessor
INHERITED
;
friend
class
GrGLSLSkSLFP
;
friend
class
GrSkSLFPFactory
;
}
;
class
GrSkSLFPFactory
:
public
SkNVRefCnt
<
GrSkSLFPFactory
>
{
public
:
GrSkSLFPFactory
(
const
char
*
name
const
GrShaderCaps
*
shaderCaps
const
char
*
sksl
SkSL
:
:
Program
:
:
Kind
kind
=
SkSL
:
:
Program
:
:
kPipelineStage_Kind
)
;
const
SkSL
:
:
Program
*
getSpecialization
(
const
SkSL
:
:
String
&
key
const
void
*
inputs
size_t
inputSize
)
;
SkSL
:
:
Program
:
:
Kind
fKind
;
const
char
*
fName
;
SkSL
:
:
Compiler
fCompiler
;
std
:
:
shared_ptr
<
SkSL
:
:
Program
>
fBaseProgram
;
std
:
:
vector
<
const
SkSL
:
:
Variable
*
>
fInAndUniformVars
;
std
:
:
unordered_map
<
SkSL
:
:
String
std
:
:
unique_ptr
<
const
SkSL
:
:
Program
>
>
fSpecializations
;
friend
class
GrSkSLFP
;
}
;
#
endif
