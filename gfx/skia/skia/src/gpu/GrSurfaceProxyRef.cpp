#
include
"
GrSurfaceProxyRef
.
h
"
#
include
"
GrTextureProxy
.
h
"
GrSurfaceProxyRef
:
:
GrSurfaceProxyRef
(
)
{
fProxy
=
nullptr
;
fOwnRef
=
false
;
fPendingIO
=
false
;
}
GrSurfaceProxyRef
:
:
GrSurfaceProxyRef
(
sk_sp
<
GrSurfaceProxy
>
proxy
GrIOType
ioType
)
{
fProxy
=
nullptr
;
fOwnRef
=
false
;
fPendingIO
=
false
;
this
-
>
setProxy
(
std
:
:
move
(
proxy
)
ioType
)
;
}
GrSurfaceProxyRef
:
:
~
GrSurfaceProxyRef
(
)
{
this
-
>
reset
(
)
;
}
void
GrSurfaceProxyRef
:
:
reset
(
)
{
if
(
fPendingIO
)
{
SkASSERT
(
fProxy
)
;
switch
(
fIOType
)
{
case
kRead_GrIOType
:
fProxy
-
>
completedRead
(
)
;
break
;
case
kWrite_GrIOType
:
fProxy
-
>
completedWrite
(
)
;
break
;
case
kRW_GrIOType
:
fProxy
-
>
completedRead
(
)
;
fProxy
-
>
completedWrite
(
)
;
break
;
}
fPendingIO
=
false
;
}
if
(
fOwnRef
)
{
SkASSERT
(
fProxy
)
;
fProxy
-
>
unref
(
)
;
fOwnRef
=
false
;
}
fProxy
=
nullptr
;
}
void
GrSurfaceProxyRef
:
:
setProxy
(
sk_sp
<
GrSurfaceProxy
>
proxy
GrIOType
ioType
)
{
SkASSERT
(
!
fPendingIO
)
;
SkASSERT
(
SkToBool
(
fProxy
)
=
=
fOwnRef
)
;
SkSafeUnref
(
fProxy
)
;
if
(
!
proxy
)
{
fProxy
=
nullptr
;
fOwnRef
=
false
;
}
else
{
fProxy
=
proxy
.
release
(
)
;
fOwnRef
=
true
;
fIOType
=
ioType
;
}
}
void
GrSurfaceProxyRef
:
:
markPendingIO
(
)
const
{
SkASSERT
(
!
fPendingIO
)
;
SkASSERT
(
fProxy
)
;
fPendingIO
=
true
;
switch
(
fIOType
)
{
case
kRead_GrIOType
:
fProxy
-
>
addPendingRead
(
)
;
break
;
case
kWrite_GrIOType
:
fProxy
-
>
addPendingWrite
(
)
;
break
;
case
kRW_GrIOType
:
fProxy
-
>
addPendingRead
(
)
;
fProxy
-
>
addPendingWrite
(
)
;
break
;
}
}
void
GrSurfaceProxyRef
:
:
pendingIOComplete
(
)
const
{
SkASSERT
(
fOwnRef
)
;
SkASSERT
(
fPendingIO
)
;
switch
(
fIOType
)
{
case
kRead_GrIOType
:
fProxy
-
>
completedRead
(
)
;
break
;
case
kWrite_GrIOType
:
fProxy
-
>
completedWrite
(
)
;
break
;
case
kRW_GrIOType
:
fProxy
-
>
completedRead
(
)
;
fProxy
-
>
completedWrite
(
)
;
break
;
}
fPendingIO
=
false
;
}
void
GrSurfaceProxyRef
:
:
removeRef
(
)
const
{
SkASSERT
(
fOwnRef
)
;
SkASSERT
(
fPendingIO
)
;
SkASSERT
(
fProxy
)
;
fProxy
-
>
unref
(
)
;
fOwnRef
=
false
;
}
