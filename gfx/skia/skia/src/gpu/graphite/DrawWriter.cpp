#
include
"
src
/
gpu
/
graphite
/
DrawWriter
.
h
"
#
include
"
src
/
gpu
/
BufferWriter
.
h
"
#
include
"
src
/
gpu
/
graphite
/
DrawCommands
.
h
"
namespace
skgpu
:
:
graphite
{
DrawWriter
:
:
DrawWriter
(
DrawPassCommands
:
:
List
*
commandList
DrawBufferManager
*
bufferManager
)
:
fCommandList
(
commandList
)
fManager
(
bufferManager
)
fPrimitiveType
(
PrimitiveType
:
:
kTriangles
)
fVertexStride
(
0
)
fInstanceStride
(
0
)
fVertices
(
)
fIndices
(
)
fInstances
(
)
fTemplateCount
(
0
)
fPendingCount
(
0
)
fPendingBase
(
0
)
fPendingBufferBinds
(
true
)
{
SkASSERT
(
commandList
&
&
bufferManager
)
;
}
void
DrawWriter
:
:
setTemplate
(
BindBufferInfo
vertices
BindBufferInfo
indices
BindBufferInfo
instances
int
templateCount
)
{
if
(
vertices
!
=
fVertices
|
|
instances
!
=
fInstances
|
|
fIndices
!
=
indices
)
{
if
(
fPendingCount
>
0
)
{
this
-
>
flush
(
)
;
}
bool
willAppendVertices
=
templateCount
=
=
0
;
bool
isAppendingVertices
=
fTemplateCount
=
=
0
;
if
(
willAppendVertices
!
=
isAppendingVertices
|
|
(
isAppendingVertices
&
&
fVertices
!
=
vertices
)
|
|
(
!
isAppendingVertices
&
&
fInstances
!
=
instances
)
)
{
fPendingBase
=
0
;
}
fVertices
=
vertices
;
fInstances
=
instances
;
fIndices
=
indices
;
fTemplateCount
=
templateCount
;
fPendingBufferBinds
=
true
;
}
else
if
(
(
templateCount
>
=
0
&
&
templateCount
!
=
fTemplateCount
)
|
|
(
templateCount
<
0
&
&
fTemplateCount
>
=
0
)
)
{
if
(
fPendingCount
>
0
)
{
this
-
>
flush
(
)
;
}
if
(
(
templateCount
=
=
0
)
!
=
(
fTemplateCount
=
=
0
)
)
{
fPendingBase
=
0
;
}
fTemplateCount
=
templateCount
;
}
SkASSERT
(
fVertices
=
=
vertices
)
;
SkASSERT
(
fInstances
=
=
instances
)
;
SkASSERT
(
fIndices
=
=
indices
)
;
SkASSERT
(
(
fTemplateCount
<
0
)
=
=
(
templateCount
<
0
)
)
;
SkASSERT
(
fTemplateCount
<
0
|
|
fTemplateCount
=
=
templateCount
)
;
}
void
DrawWriter
:
:
flush
(
)
{
if
(
fPendingCount
=
=
0
|
|
fTemplateCount
=
=
-
1
)
{
return
;
}
if
(
fPendingBufferBinds
)
{
fCommandList
-
>
bindDrawBuffers
(
fVertices
fInstances
fIndices
{
}
)
;
fPendingBufferBinds
=
false
;
}
if
(
fTemplateCount
)
{
unsigned
int
realVertexCount
;
if
(
fTemplateCount
<
0
)
{
realVertexCount
=
-
fTemplateCount
-
1
;
fTemplateCount
=
-
1
;
}
else
{
realVertexCount
=
fTemplateCount
;
}
if
(
fIndices
)
{
fCommandList
-
>
drawIndexedInstanced
(
fPrimitiveType
0
realVertexCount
0
fPendingBase
fPendingCount
)
;
}
else
{
fCommandList
-
>
drawInstanced
(
fPrimitiveType
0
realVertexCount
fPendingBase
fPendingCount
)
;
}
}
else
{
SkASSERT
(
!
fInstances
)
;
if
(
fIndices
)
{
fCommandList
-
>
drawIndexed
(
fPrimitiveType
0
fPendingCount
fPendingBase
)
;
}
else
{
fCommandList
-
>
draw
(
fPrimitiveType
fPendingBase
fPendingCount
)
;
}
}
fPendingBase
+
=
fPendingCount
;
fPendingCount
=
0
;
}
}
