#
include
"
GrBitmapTextureMaker
.
h
"
#
include
"
GrContext
.
h
"
#
include
"
GrContextPriv
.
h
"
#
include
"
GrGpuResourcePriv
.
h
"
#
include
"
GrProxyProvider
.
h
"
#
include
"
GrSurfaceContext
.
h
"
#
include
"
SkBitmap
.
h
"
#
include
"
SkGr
.
h
"
#
include
"
SkMipMap
.
h
"
#
include
"
SkPixelRef
.
h
"
static
bool
bmp_is_alpha_only
(
const
SkBitmap
&
bm
)
{
return
kAlpha_8_SkColorType
=
=
bm
.
colorType
(
)
;
}
GrBitmapTextureMaker
:
:
GrBitmapTextureMaker
(
GrContext
*
context
const
SkBitmap
&
bitmap
)
:
INHERITED
(
context
bitmap
.
width
(
)
bitmap
.
height
(
)
bmp_is_alpha_only
(
bitmap
)
)
fBitmap
(
bitmap
)
{
if
(
!
bitmap
.
isVolatile
(
)
)
{
SkIPoint
origin
=
bitmap
.
pixelRefOrigin
(
)
;
SkIRect
subset
=
SkIRect
:
:
MakeXYWH
(
origin
.
fX
origin
.
fY
bitmap
.
width
(
)
bitmap
.
height
(
)
)
;
GrMakeKeyFromImageID
(
&
fOriginalKey
bitmap
.
pixelRef
(
)
-
>
getGenerationID
(
)
subset
)
;
}
}
sk_sp
<
GrTextureProxy
>
GrBitmapTextureMaker
:
:
refOriginalTextureProxy
(
bool
willBeMipped
SkColorSpace
*
dstColorSpace
AllowedTexGenType
onlyIfFast
)
{
if
(
AllowedTexGenType
:
:
kCheap
=
=
onlyIfFast
)
{
return
nullptr
;
}
GrProxyProvider
*
proxyProvider
=
this
-
>
context
(
)
-
>
contextPriv
(
)
.
proxyProvider
(
)
;
sk_sp
<
GrTextureProxy
>
proxy
;
if
(
fOriginalKey
.
isValid
(
)
)
{
proxy
=
proxyProvider
-
>
findOrCreateProxyByUniqueKey
(
fOriginalKey
kTopLeft_GrSurfaceOrigin
)
;
if
(
proxy
&
&
(
!
willBeMipped
|
|
GrMipMapped
:
:
kYes
=
=
proxy
-
>
mipMapped
(
)
)
)
{
return
proxy
;
}
}
if
(
!
proxy
)
{
if
(
willBeMipped
)
{
proxy
=
proxyProvider
-
>
createMipMapProxyFromBitmap
(
fBitmap
)
;
}
if
(
!
proxy
)
{
proxy
=
GrUploadBitmapToTextureProxy
(
proxyProvider
fBitmap
)
;
}
if
(
proxy
)
{
if
(
fOriginalKey
.
isValid
(
)
)
{
proxyProvider
-
>
assignUniqueKeyToProxy
(
fOriginalKey
proxy
.
get
(
)
)
;
}
if
(
!
willBeMipped
|
|
GrMipMapped
:
:
kYes
=
=
proxy
-
>
mipMapped
(
)
)
{
SkASSERT
(
proxy
-
>
origin
(
)
=
=
kTopLeft_GrSurfaceOrigin
)
;
if
(
fOriginalKey
.
isValid
(
)
)
{
GrInstallBitmapUniqueKeyInvalidator
(
fOriginalKey
proxyProvider
-
>
contextUniqueID
(
)
fBitmap
.
pixelRef
(
)
)
;
}
return
proxy
;
}
}
}
if
(
proxy
)
{
SkASSERT
(
willBeMipped
)
;
SkASSERT
(
GrMipMapped
:
:
kNo
=
=
proxy
-
>
mipMapped
(
)
)
;
if
(
auto
mippedProxy
=
GrCopyBaseMipMapToTextureProxy
(
this
-
>
context
(
)
proxy
.
get
(
)
)
)
{
SkASSERT
(
mippedProxy
-
>
origin
(
)
=
=
kTopLeft_GrSurfaceOrigin
)
;
if
(
fOriginalKey
.
isValid
(
)
)
{
proxyProvider
-
>
removeUniqueKeyFromProxy
(
fOriginalKey
proxy
.
get
(
)
)
;
proxyProvider
-
>
assignUniqueKeyToProxy
(
fOriginalKey
mippedProxy
.
get
(
)
)
;
GrInstallBitmapUniqueKeyInvalidator
(
fOriginalKey
proxyProvider
-
>
contextUniqueID
(
)
fBitmap
.
pixelRef
(
)
)
;
}
return
mippedProxy
;
}
return
proxy
;
}
return
nullptr
;
}
void
GrBitmapTextureMaker
:
:
makeCopyKey
(
const
CopyParams
&
copyParams
GrUniqueKey
*
copyKey
)
{
if
(
fOriginalKey
.
isValid
(
)
)
{
MakeCopyKeyFromOrigKey
(
fOriginalKey
copyParams
copyKey
)
;
}
}
void
GrBitmapTextureMaker
:
:
didCacheCopy
(
const
GrUniqueKey
&
copyKey
uint32_t
contextUniqueID
)
{
GrInstallBitmapUniqueKeyInvalidator
(
copyKey
contextUniqueID
fBitmap
.
pixelRef
(
)
)
;
}
SkAlphaType
GrBitmapTextureMaker
:
:
alphaType
(
)
const
{
return
fBitmap
.
alphaType
(
)
;
}
sk_sp
<
SkColorSpace
>
GrBitmapTextureMaker
:
:
getColorSpace
(
SkColorSpace
*
dstColorSpace
)
{
return
fBitmap
.
refColorSpace
(
)
;
}
