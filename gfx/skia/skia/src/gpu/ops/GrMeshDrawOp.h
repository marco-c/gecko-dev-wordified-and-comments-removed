#
ifndef
GrMeshDrawOp_DEFINED
#
define
GrMeshDrawOp_DEFINED
#
include
"
GrAppliedClip
.
h
"
#
include
"
GrDrawOp
.
h
"
#
include
"
GrGeometryProcessor
.
h
"
#
include
"
GrMesh
.
h
"
class
GrAtlasManager
;
class
GrCaps
;
class
GrGlyphCache
;
class
GrOpFlushState
;
class
GrMeshDrawOp
:
public
GrDrawOp
{
public
:
class
Target
;
protected
:
GrMeshDrawOp
(
uint32_t
classID
)
;
class
PatternHelper
{
public
:
PatternHelper
(
Target
*
GrPrimitiveType
size_t
vertexStride
const
GrBuffer
*
int
verticesPerRepetition
int
indicesPerRepetition
int
repeatCount
)
;
void
recordDraw
(
Target
*
sk_sp
<
const
GrGeometryProcessor
>
const
GrPipeline
*
const
GrPipeline
:
:
FixedDynamicState
*
)
const
;
void
*
vertices
(
)
const
{
return
fVertices
;
}
protected
:
PatternHelper
(
)
=
default
;
void
init
(
Target
*
GrPrimitiveType
size_t
vertexStride
const
GrBuffer
*
int
verticesPerRepetition
int
indicesPerRepetition
int
repeatCount
)
;
private
:
void
*
fVertices
=
nullptr
;
GrMesh
*
fMesh
=
nullptr
;
}
;
static
const
int
kVerticesPerQuad
=
4
;
static
const
int
kIndicesPerQuad
=
6
;
class
QuadHelper
:
private
PatternHelper
{
public
:
QuadHelper
(
)
=
delete
;
QuadHelper
(
Target
*
target
size_t
vertexStride
int
quadsToDraw
)
;
using
PatternHelper
:
:
recordDraw
;
using
PatternHelper
:
:
vertices
;
private
:
typedef
PatternHelper
INHERITED
;
}
;
private
:
void
onPrepare
(
GrOpFlushState
*
state
)
final
;
void
onExecute
(
GrOpFlushState
*
state
)
final
;
virtual
void
onPrepareDraws
(
Target
*
)
=
0
;
typedef
GrDrawOp
INHERITED
;
}
;
class
GrMeshDrawOp
:
:
Target
{
public
:
virtual
~
Target
(
)
{
}
virtual
void
draw
(
sk_sp
<
const
GrGeometryProcessor
>
const
GrPipeline
*
const
GrPipeline
:
:
FixedDynamicState
*
const
GrPipeline
:
:
DynamicStateArrays
*
const
GrMesh
[
]
int
meshCount
)
=
0
;
void
draw
(
sk_sp
<
const
GrGeometryProcessor
>
gp
const
GrPipeline
*
pipeline
const
GrPipeline
:
:
FixedDynamicState
*
fixedDynamicState
const
GrMesh
*
mesh
)
{
this
-
>
draw
(
std
:
:
move
(
gp
)
pipeline
fixedDynamicState
nullptr
mesh
1
)
;
}
virtual
void
*
makeVertexSpace
(
size_t
vertexSize
int
vertexCount
const
GrBuffer
*
*
int
*
startVertex
)
=
0
;
virtual
uint16_t
*
makeIndexSpace
(
int
indexCount
const
GrBuffer
*
*
int
*
startIndex
)
=
0
;
virtual
void
*
makeVertexSpaceAtLeast
(
size_t
vertexSize
int
minVertexCount
int
fallbackVertexCount
const
GrBuffer
*
*
int
*
startVertex
int
*
actualVertexCount
)
=
0
;
virtual
uint16_t
*
makeIndexSpaceAtLeast
(
int
minIndexCount
int
fallbackIndexCount
const
GrBuffer
*
*
int
*
startIndex
int
*
actualIndexCount
)
=
0
;
virtual
void
putBackIndices
(
int
indices
)
=
0
;
virtual
void
putBackVertices
(
int
vertices
size_t
vertexStride
)
=
0
;
template
<
typename
.
.
.
Args
>
GrPipeline
*
allocPipeline
(
Args
&
&
.
.
.
args
)
{
return
this
-
>
pipelineArena
(
)
-
>
make
<
GrPipeline
>
(
std
:
:
forward
<
Args
>
(
args
)
.
.
.
)
;
}
GrMesh
*
allocMesh
(
GrPrimitiveType
primitiveType
)
{
return
this
-
>
pipelineArena
(
)
-
>
make
<
GrMesh
>
(
primitiveType
)
;
}
GrMesh
*
allocMeshes
(
int
n
)
{
return
this
-
>
pipelineArena
(
)
-
>
makeArray
<
GrMesh
>
(
n
)
;
}
GrPipeline
:
:
FixedDynamicState
*
allocFixedDynamicState
(
const
SkIRect
&
rect
int
numPrimitiveProcessorTextures
=
0
)
;
GrPipeline
:
:
DynamicStateArrays
*
allocDynamicStateArrays
(
int
numMeshes
int
numPrimitiveProcessorTextures
bool
allocScissors
)
;
GrTextureProxy
*
*
allocPrimitiveProcessorTextureArray
(
int
n
)
{
SkASSERT
(
n
>
0
)
;
return
this
-
>
pipelineArena
(
)
-
>
makeArrayDefault
<
GrTextureProxy
*
>
(
n
)
;
}
struct
PipelineAndFixedDynamicState
{
const
GrPipeline
*
fPipeline
;
GrPipeline
:
:
FixedDynamicState
*
fFixedDynamicState
;
}
;
PipelineAndFixedDynamicState
makePipeline
(
uint32_t
pipelineFlags
GrProcessorSet
&
&
GrAppliedClip
&
&
int
numPrimitiveProcessorTextures
=
0
)
;
virtual
GrRenderTargetProxy
*
proxy
(
)
const
=
0
;
virtual
GrAppliedClip
detachAppliedClip
(
)
=
0
;
virtual
const
GrXferProcessor
:
:
DstProxy
&
dstProxy
(
)
const
=
0
;
virtual
GrResourceProvider
*
resourceProvider
(
)
const
=
0
;
uint32_t
contextUniqueID
(
)
const
{
return
this
-
>
resourceProvider
(
)
-
>
contextUniqueID
(
)
;
}
virtual
GrGlyphCache
*
glyphCache
(
)
const
=
0
;
virtual
GrAtlasManager
*
atlasManager
(
)
const
=
0
;
virtual
const
GrCaps
&
caps
(
)
const
=
0
;
virtual
GrDeferredUploadTarget
*
deferredUploadTarget
(
)
=
0
;
private
:
virtual
SkArenaAlloc
*
pipelineArena
(
)
=
0
;
}
;
#
endif
