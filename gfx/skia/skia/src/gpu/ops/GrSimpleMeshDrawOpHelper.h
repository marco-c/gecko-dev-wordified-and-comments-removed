#
ifndef
GrSimpleMeshDrawOpHelper_DEFINED
#
define
GrSimpleMeshDrawOpHelper_DEFINED
#
include
"
GrContext
.
h
"
#
include
"
GrContextPriv
.
h
"
#
include
"
GrMemoryPool
.
h
"
#
include
"
GrMeshDrawOp
.
h
"
#
include
"
GrOpFlushState
.
h
"
#
include
"
GrPipeline
.
h
"
#
include
<
new
>
struct
SkRect
;
class
GrSimpleMeshDrawOpHelper
{
public
:
struct
MakeArgs
;
template
<
typename
Op
typename
.
.
.
OpArgs
>
static
std
:
:
unique_ptr
<
GrDrawOp
>
FactoryHelper
(
GrContext
*
GrPaint
&
&
paint
OpArgs
.
.
.
opArgs
)
;
enum
class
Flags
:
uint32_t
{
kNone
=
0x0
kSnapVerticesToPixelCenters
=
0x1
}
;
GR_DECL_BITFIELD_CLASS_OPS_FRIENDS
(
Flags
)
;
GrSimpleMeshDrawOpHelper
(
const
MakeArgs
&
GrAAType
Flags
=
Flags
:
:
kNone
)
;
~
GrSimpleMeshDrawOpHelper
(
)
;
GrSimpleMeshDrawOpHelper
(
)
=
delete
;
GrSimpleMeshDrawOpHelper
(
const
GrSimpleMeshDrawOpHelper
&
)
=
delete
;
GrSimpleMeshDrawOpHelper
&
operator
=
(
const
GrSimpleMeshDrawOpHelper
&
)
=
delete
;
GrDrawOp
:
:
FixedFunctionFlags
fixedFunctionFlags
(
)
const
;
bool
isCompatible
(
const
GrSimpleMeshDrawOpHelper
&
that
const
GrCaps
&
const
SkRect
&
thisBounds
const
SkRect
&
thatBounds
)
const
;
GrDrawOp
:
:
RequiresDstTexture
xpRequiresDstTexture
(
const
GrCaps
&
caps
const
GrAppliedClip
*
clip
GrProcessorAnalysisCoverage
geometryCoverage
GrProcessorAnalysisColor
*
geometryColor
)
;
GrDrawOp
:
:
RequiresDstTexture
xpRequiresDstTexture
(
const
GrCaps
&
const
GrAppliedClip
*
GrProcessorAnalysisCoverage
geometryCoverage
GrColor
*
geometryColor
)
;
bool
usesLocalCoords
(
)
const
{
SkASSERT
(
fDidAnalysis
)
;
return
fUsesLocalCoords
;
}
bool
compatibleWithAlphaAsCoverage
(
)
const
{
return
fCompatibleWithAlphaAsCoveage
;
}
using
PipelineAndFixedDynamicState
=
GrOpFlushState
:
:
PipelineAndFixedDynamicState
;
PipelineAndFixedDynamicState
makePipeline
(
GrMeshDrawOp
:
:
Target
*
target
int
numPrimitiveProcessorTextures
=
0
)
{
return
this
-
>
internalMakePipeline
(
target
this
-
>
pipelineInitArgs
(
target
)
numPrimitiveProcessorTextures
)
;
}
struct
MakeArgs
{
private
:
MakeArgs
(
)
=
default
;
GrProcessorSet
*
fProcessorSet
;
friend
class
GrSimpleMeshDrawOpHelper
;
}
;
void
visitProxies
(
const
std
:
:
function
<
void
(
GrSurfaceProxy
*
)
>
&
func
)
const
{
if
(
fProcessors
)
{
fProcessors
-
>
visitProxies
(
func
)
;
}
}
SkString
dumpInfo
(
)
const
;
protected
:
GrAAType
aaType
(
)
const
{
return
static_cast
<
GrAAType
>
(
fAAType
)
;
}
uint32_t
pipelineFlags
(
)
const
{
return
fPipelineFlags
;
}
GrPipeline
:
:
InitArgs
pipelineInitArgs
(
GrMeshDrawOp
:
:
Target
*
target
)
const
;
PipelineAndFixedDynamicState
internalMakePipeline
(
GrMeshDrawOp
:
:
Target
*
const
GrPipeline
:
:
InitArgs
&
int
numPrimitiveProcessorTextures
)
;
private
:
GrProcessorSet
*
fProcessors
;
unsigned
fPipelineFlags
:
8
;
unsigned
fAAType
:
2
;
unsigned
fRequiresDstTexture
:
1
;
unsigned
fUsesLocalCoords
:
1
;
unsigned
fCompatibleWithAlphaAsCoveage
:
1
;
SkDEBUGCODE
(
unsigned
fMadePipeline
:
1
;
)
SkDEBUGCODE
(
unsigned
fDidAnalysis
:
1
;
)
}
;
class
GrSimpleMeshDrawOpHelperWithStencil
:
private
GrSimpleMeshDrawOpHelper
{
public
:
using
MakeArgs
=
GrSimpleMeshDrawOpHelper
:
:
MakeArgs
;
using
Flags
=
GrSimpleMeshDrawOpHelper
:
:
Flags
;
using
PipelineAndFixedDynamicState
=
GrOpFlushState
:
:
PipelineAndFixedDynamicState
;
using
GrSimpleMeshDrawOpHelper
:
:
visitProxies
;
template
<
typename
Op
typename
.
.
.
OpArgs
>
static
std
:
:
unique_ptr
<
GrDrawOp
>
FactoryHelper
(
GrContext
*
context
GrPaint
&
&
paint
OpArgs
.
.
.
opArgs
)
{
return
GrSimpleMeshDrawOpHelper
:
:
FactoryHelper
<
Op
OpArgs
.
.
.
>
(
context
std
:
:
move
(
paint
)
std
:
:
forward
<
OpArgs
>
(
opArgs
)
.
.
.
)
;
}
GrSimpleMeshDrawOpHelperWithStencil
(
const
MakeArgs
&
GrAAType
const
GrUserStencilSettings
*
Flags
=
Flags
:
:
kNone
)
;
GrDrawOp
:
:
FixedFunctionFlags
fixedFunctionFlags
(
)
const
;
using
GrSimpleMeshDrawOpHelper
:
:
xpRequiresDstTexture
;
using
GrSimpleMeshDrawOpHelper
:
:
usesLocalCoords
;
using
GrSimpleMeshDrawOpHelper
:
:
compatibleWithAlphaAsCoverage
;
bool
isCompatible
(
const
GrSimpleMeshDrawOpHelperWithStencil
&
that
const
GrCaps
&
const
SkRect
&
thisBounds
const
SkRect
&
thatBounds
)
const
;
PipelineAndFixedDynamicState
makePipeline
(
GrMeshDrawOp
:
:
Target
*
int
numPrimitiveProcessorTextures
=
0
)
;
SkString
dumpInfo
(
)
const
;
private
:
const
GrUserStencilSettings
*
fStencilSettings
;
typedef
GrSimpleMeshDrawOpHelper
INHERITED
;
}
;
template
<
typename
Op
typename
.
.
.
OpArgs
>
std
:
:
unique_ptr
<
GrDrawOp
>
GrSimpleMeshDrawOpHelper
:
:
FactoryHelper
(
GrContext
*
context
GrPaint
&
&
paint
OpArgs
.
.
.
opArgs
)
{
GrOpMemoryPool
*
pool
=
context
-
>
contextPriv
(
)
.
opMemoryPool
(
)
;
MakeArgs
makeArgs
;
GrColor
color
=
paint
.
getColor
(
)
;
if
(
paint
.
isTrivial
(
)
)
{
makeArgs
.
fProcessorSet
=
nullptr
;
return
pool
-
>
allocate
<
Op
>
(
makeArgs
color
std
:
:
forward
<
OpArgs
>
(
opArgs
)
.
.
.
)
;
}
else
{
char
*
mem
=
(
char
*
)
pool
-
>
allocate
(
sizeof
(
Op
)
+
sizeof
(
GrProcessorSet
)
)
;
char
*
setMem
=
mem
+
sizeof
(
Op
)
;
makeArgs
.
fProcessorSet
=
new
(
setMem
)
GrProcessorSet
(
std
:
:
move
(
paint
)
)
;
return
std
:
:
unique_ptr
<
GrDrawOp
>
(
new
(
mem
)
Op
(
makeArgs
color
std
:
:
forward
<
OpArgs
>
(
opArgs
)
.
.
.
)
)
;
}
}
GR_MAKE_BITFIELD_CLASS_OPS
(
GrSimpleMeshDrawOpHelper
:
:
Flags
)
#
endif
