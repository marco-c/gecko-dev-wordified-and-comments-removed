#
ifndef
GrGLSLFragmentShaderBuilder_DEFINED
#
define
GrGLSLFragmentShaderBuilder_DEFINED
#
include
"
GrBlend
.
h
"
#
include
"
GrGLSLShaderBuilder
.
h
"
#
include
"
GrProcessor
.
h
"
class
GrRenderTarget
;
class
GrGLSLVarying
;
class
GrGLSLFragmentBuilder
:
public
GrGLSLShaderBuilder
{
public
:
GrGLSLFragmentBuilder
(
GrGLSLProgramBuilder
*
program
)
:
INHERITED
(
program
)
{
}
virtual
~
GrGLSLFragmentBuilder
(
)
{
}
virtual
SkString
ensureCoords2D
(
const
GrShaderVar
&
)
=
0
;
void
declAppendf
(
const
char
*
fmt
.
.
.
)
;
private
:
typedef
GrGLSLShaderBuilder
INHERITED
;
}
;
class
GrGLSLFPFragmentBuilder
:
virtual
public
GrGLSLFragmentBuilder
{
public
:
GrGLSLFPFragmentBuilder
(
)
:
GrGLSLFragmentBuilder
(
nullptr
)
{
}
enum
class
Scope
:
bool
{
kTopLevel
kInsideLoopOrBranch
}
;
virtual
void
maskOffMultisampleCoverage
(
const
char
*
mask
Scope
)
=
0
;
virtual
void
onBeforeChildProcEmitCode
(
)
=
0
;
virtual
void
onAfterChildProcEmitCode
(
)
=
0
;
virtual
const
SkString
&
getMangleString
(
)
const
=
0
;
virtual
void
forceHighPrecision
(
)
=
0
;
}
;
class
GrGLSLXPFragmentBuilder
:
virtual
public
GrGLSLFragmentBuilder
{
public
:
GrGLSLXPFragmentBuilder
(
)
:
GrGLSLFragmentBuilder
(
nullptr
)
{
}
virtual
bool
hasCustomColorOutput
(
)
const
=
0
;
virtual
bool
hasSecondaryOutput
(
)
const
=
0
;
virtual
const
char
*
dstColor
(
)
=
0
;
virtual
void
enableAdvancedBlendEquationIfNeeded
(
GrBlendEquation
)
=
0
;
}
;
class
GrGLSLFragmentShaderBuilder
:
public
GrGLSLFPFragmentBuilder
public
GrGLSLXPFragmentBuilder
{
public
:
static
uint8_t
KeyForSurfaceOrigin
(
GrSurfaceOrigin
)
;
GrGLSLFragmentShaderBuilder
(
GrGLSLProgramBuilder
*
program
)
;
virtual
SkString
ensureCoords2D
(
const
GrShaderVar
&
)
override
;
void
maskOffMultisampleCoverage
(
const
char
*
mask
Scope
)
override
;
const
SkString
&
getMangleString
(
)
const
override
{
return
fMangleString
;
}
void
onBeforeChildProcEmitCode
(
)
override
;
void
onAfterChildProcEmitCode
(
)
override
;
void
forceHighPrecision
(
)
override
{
fForceHighPrecision
=
true
;
}
bool
hasCustomColorOutput
(
)
const
override
{
return
fHasCustomColorOutput
;
}
bool
hasSecondaryOutput
(
)
const
override
{
return
fHasSecondaryOutput
;
}
const
char
*
dstColor
(
)
override
;
void
enableAdvancedBlendEquationIfNeeded
(
GrBlendEquation
)
override
;
private
:
void
enableCustomOutput
(
)
;
void
enableSecondaryOutput
(
)
;
const
char
*
getPrimaryColorOutputName
(
)
const
;
const
char
*
getSecondaryColorOutputName
(
)
const
;
bool
primaryColorOutputIsInOut
(
)
const
;
#
ifdef
SK_DEBUG
bool
hasReadDstColor
(
)
const
{
return
fHasReadDstColor
;
}
void
resetVerification
(
)
{
fHasReadDstColor
=
false
;
}
#
endif
static
const
char
*
DeclaredColorOutputName
(
)
{
return
"
sk_FragColor
"
;
}
static
const
char
*
DeclaredSecondaryColorOutputName
(
)
{
return
"
fsSecondaryColorOut
"
;
}
GrSurfaceOrigin
getSurfaceOrigin
(
)
const
;
void
onFinalize
(
)
override
;
static
const
char
*
kDstColorName
;
SkTArray
<
int
>
fSubstageIndices
;
SkString
fMangleString
;
bool
fSetupFragPosition
;
bool
fHasCustomColorOutput
;
int
fCustomColorOutputIndex
;
bool
fHasSecondaryOutput
;
bool
fHasInitializedSampleMask
;
bool
fForceHighPrecision
;
#
ifdef
SK_DEBUG
bool
fHasReadDstColor
;
#
endif
friend
class
GrGLSLProgramBuilder
;
friend
class
GrGLProgramBuilder
;
}
;
#
endif
