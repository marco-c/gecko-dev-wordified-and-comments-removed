#
ifndef
GrGLSLFragmentShaderBuilder_DEFINED
#
define
GrGLSLFragmentShaderBuilder_DEFINED
#
include
"
src
/
gpu
/
GrBlend
.
h
"
#
include
"
src
/
gpu
/
GrProcessor
.
h
"
#
include
"
src
/
gpu
/
glsl
/
GrGLSLFragmentProcessor
.
h
"
#
include
"
src
/
gpu
/
glsl
/
GrGLSLShaderBuilder
.
h
"
class
GrRenderTarget
;
class
GrGLSLVarying
;
class
GrGLSLFragmentBuilder
:
public
GrGLSLShaderBuilder
{
public
:
GrGLSLFragmentBuilder
(
GrGLSLProgramBuilder
*
program
)
:
INHERITED
(
program
)
{
}
virtual
~
GrGLSLFragmentBuilder
(
)
{
}
virtual
SkString
ensureCoords2D
(
const
GrShaderVar
&
)
=
0
;
void
declAppendf
(
const
char
*
fmt
.
.
.
)
;
private
:
typedef
GrGLSLShaderBuilder
INHERITED
;
}
;
class
GrGLSLFPFragmentBuilder
:
virtual
public
GrGLSLFragmentBuilder
{
public
:
GrGLSLFPFragmentBuilder
(
)
:
GrGLSLFragmentBuilder
(
nullptr
)
{
}
virtual
const
char
*
sampleOffsets
(
)
=
0
;
enum
class
ScopeFlags
{
kTopLevel
=
0
kInsidePerPrimitiveBranch
=
(
1
<
<
0
)
kInsidePerPixelBranch
=
(
1
<
<
1
)
kInsideLoop
=
(
1
<
<
2
)
}
;
virtual
void
maskOffMultisampleCoverage
(
const
char
*
mask
ScopeFlags
)
=
0
;
virtual
void
applyFnToMultisampleMask
(
const
char
*
fn
const
char
*
grad
ScopeFlags
)
=
0
;
virtual
void
onBeforeChildProcEmitCode
(
)
=
0
;
virtual
void
onAfterChildProcEmitCode
(
)
=
0
;
virtual
SkString
writeProcessorFunction
(
GrGLSLFragmentProcessor
*
fp
GrGLSLFragmentProcessor
:
:
EmitArgs
&
args
)
;
virtual
const
SkString
&
getMangleString
(
)
const
=
0
;
virtual
void
forceHighPrecision
(
)
=
0
;
}
;
GR_MAKE_BITFIELD_CLASS_OPS
(
GrGLSLFPFragmentBuilder
:
:
ScopeFlags
)
;
class
GrGLSLXPFragmentBuilder
:
virtual
public
GrGLSLFragmentBuilder
{
public
:
GrGLSLXPFragmentBuilder
(
)
:
GrGLSLFragmentBuilder
(
nullptr
)
{
}
virtual
bool
hasCustomColorOutput
(
)
const
=
0
;
virtual
bool
hasSecondaryOutput
(
)
const
=
0
;
virtual
const
char
*
dstColor
(
)
=
0
;
virtual
void
enableAdvancedBlendEquationIfNeeded
(
GrBlendEquation
)
=
0
;
}
;
class
GrGLSLFragmentShaderBuilder
:
public
GrGLSLFPFragmentBuilder
public
GrGLSLXPFragmentBuilder
{
public
:
static
uint8_t
KeyForSurfaceOrigin
(
GrSurfaceOrigin
)
;
GrGLSLFragmentShaderBuilder
(
GrGLSLProgramBuilder
*
program
)
;
virtual
SkString
ensureCoords2D
(
const
GrShaderVar
&
)
override
;
const
char
*
sampleOffsets
(
)
override
;
void
maskOffMultisampleCoverage
(
const
char
*
mask
ScopeFlags
)
override
;
void
applyFnToMultisampleMask
(
const
char
*
fn
const
char
*
grad
ScopeFlags
)
override
;
const
SkString
&
getMangleString
(
)
const
override
{
return
fMangleString
;
}
void
onBeforeChildProcEmitCode
(
)
override
;
void
onAfterChildProcEmitCode
(
)
override
;
void
forceHighPrecision
(
)
override
{
fForceHighPrecision
=
true
;
}
bool
hasCustomColorOutput
(
)
const
override
{
return
fHasCustomColorOutput
;
}
bool
hasSecondaryOutput
(
)
const
override
{
return
fHasSecondaryOutput
;
}
const
char
*
dstColor
(
)
override
;
void
enableAdvancedBlendEquationIfNeeded
(
GrBlendEquation
)
override
;
private
:
using
CustomFeatures
=
GrProcessor
:
:
CustomFeatures
;
void
enableCustomOutput
(
)
;
void
enableSecondaryOutput
(
)
;
const
char
*
getPrimaryColorOutputName
(
)
const
;
const
char
*
getSecondaryColorOutputName
(
)
const
;
bool
primaryColorOutputIsInOut
(
)
const
;
#
ifdef
SK_DEBUG
bool
fHasReadDstColorThisStage_DebugOnly
=
false
;
CustomFeatures
fUsedProcessorFeaturesThisStage_DebugOnly
=
CustomFeatures
:
:
kNone
;
CustomFeatures
fUsedProcessorFeaturesAllStages_DebugOnly
=
CustomFeatures
:
:
kNone
;
void
debugOnly_resetPerStageVerification
(
)
{
fHasReadDstColorThisStage_DebugOnly
=
false
;
fUsedProcessorFeaturesThisStage_DebugOnly
=
CustomFeatures
:
:
kNone
;
}
#
endif
static
const
char
*
DeclaredColorOutputName
(
)
{
return
"
sk_FragColor
"
;
}
static
const
char
*
DeclaredSecondaryColorOutputName
(
)
{
return
"
fsSecondaryColorOut
"
;
}
GrSurfaceOrigin
getSurfaceOrigin
(
)
const
;
void
onFinalize
(
)
override
;
static
const
char
*
kDstColorName
;
SkTArray
<
int
>
fSubstageIndices
;
SkString
fMangleString
;
bool
fSetupFragPosition
=
false
;
bool
fHasCustomColorOutput
=
false
;
int
fCustomColorOutputIndex
=
-
1
;
bool
fHasSecondaryOutput
=
false
;
bool
fHasModifiedSampleMask
=
false
;
bool
fForceHighPrecision
=
false
;
friend
class
GrGLSLProgramBuilder
;
friend
class
GrGLProgramBuilder
;
}
;
#
endif
