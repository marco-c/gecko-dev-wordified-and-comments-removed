#
ifndef
GrOpFlushState_DEFINED
#
define
GrOpFlushState_DEFINED
#
include
"
GrBufferAllocPool
.
h
"
#
include
"
GrGpu
.
h
"
#
include
"
ops
/
GrMeshDrawOp
.
h
"
class
GrGpuCommandBuffer
;
class
GrResourceProvider
;
class
GrOpFlushState
{
public
:
GrOpFlushState
(
GrGpu
*
GrResourceProvider
*
)
;
~
GrOpFlushState
(
)
{
this
-
>
reset
(
)
;
}
void
addASAPUpload
(
GrDrawOp
:
:
DeferredUploadFn
&
&
upload
)
{
fAsapUploads
.
emplace_back
(
std
:
:
move
(
upload
)
)
;
}
const
GrCaps
&
caps
(
)
const
{
return
*
fGpu
-
>
caps
(
)
;
}
GrResourceProvider
*
resourceProvider
(
)
const
{
return
fResourceProvider
;
}
bool
hasDrawBeenFlushed
(
GrDrawOpUploadToken
token
)
const
{
return
token
.
fSequenceNumber
<
=
fLastFlushedToken
.
fSequenceNumber
;
}
GrDrawOpUploadToken
issueDrawToken
(
)
{
return
GrDrawOpUploadToken
(
+
+
fLastIssuedToken
.
fSequenceNumber
)
;
}
void
flushToken
(
)
{
+
+
fLastFlushedToken
.
fSequenceNumber
;
}
GrDrawOpUploadToken
nextDrawToken
(
)
const
{
return
GrDrawOpUploadToken
(
fLastIssuedToken
.
fSequenceNumber
+
1
)
;
}
GrDrawOpUploadToken
nextTokenToFlush
(
)
const
{
return
GrDrawOpUploadToken
(
fLastFlushedToken
.
fSequenceNumber
+
1
)
;
}
void
*
makeVertexSpace
(
size_t
vertexSize
int
vertexCount
const
GrBuffer
*
*
buffer
int
*
startVertex
)
;
uint16_t
*
makeIndexSpace
(
int
indexCount
const
GrBuffer
*
*
buffer
int
*
startIndex
)
;
void
preIssueDraws
(
)
{
fVertexPool
.
unmap
(
)
;
fIndexPool
.
unmap
(
)
;
int
uploadCount
=
fAsapUploads
.
count
(
)
;
for
(
int
i
=
0
;
i
<
uploadCount
;
i
+
+
)
{
this
-
>
doUpload
(
fAsapUploads
[
i
]
)
;
}
fAsapUploads
.
reset
(
)
;
}
void
doUpload
(
GrDrawOp
:
:
DeferredUploadFn
&
upload
)
{
GrDrawOp
:
:
WritePixelsFn
wp
=
[
this
]
(
GrSurface
*
surface
int
left
int
top
int
width
int
height
GrPixelConfig
config
const
void
*
buffer
size_t
rowBytes
)
-
>
bool
{
return
this
-
>
fGpu
-
>
writePixels
(
surface
left
top
width
height
config
buffer
rowBytes
)
;
}
;
upload
(
wp
)
;
}
void
putBackIndices
(
size_t
indices
)
{
fIndexPool
.
putBack
(
indices
*
sizeof
(
uint16_t
)
)
;
}
void
putBackVertexSpace
(
size_t
sizeInBytes
)
{
fVertexPool
.
putBack
(
sizeInBytes
)
;
}
GrGpuCommandBuffer
*
commandBuffer
(
)
{
return
fCommandBuffer
;
}
void
setCommandBuffer
(
GrGpuCommandBuffer
*
buffer
)
{
fCommandBuffer
=
buffer
;
}
GrGpu
*
gpu
(
)
{
return
fGpu
;
}
void
reset
(
)
{
fVertexPool
.
reset
(
)
;
fIndexPool
.
reset
(
)
;
}
struct
DrawOpArgs
{
GrRenderTarget
*
fRenderTarget
;
const
GrAppliedClip
*
fAppliedClip
;
GrXferProcessor
:
:
DstTexture
fDstTexture
;
}
;
void
setDrawOpArgs
(
DrawOpArgs
*
opArgs
)
{
fOpArgs
=
opArgs
;
}
const
DrawOpArgs
&
drawOpArgs
(
)
const
{
SkASSERT
(
fOpArgs
)
;
return
*
fOpArgs
;
}
private
:
GrGpu
*
fGpu
;
GrResourceProvider
*
fResourceProvider
;
GrGpuCommandBuffer
*
fCommandBuffer
;
GrVertexBufferAllocPool
fVertexPool
;
GrIndexBufferAllocPool
fIndexPool
;
SkSTArray
<
4
GrDrawOp
:
:
DeferredUploadFn
>
fAsapUploads
;
GrDrawOpUploadToken
fLastIssuedToken
;
GrDrawOpUploadToken
fLastFlushedToken
;
DrawOpArgs
*
fOpArgs
;
}
;
class
GrDrawOp
:
:
Target
{
public
:
Target
(
GrOpFlushState
*
state
GrDrawOp
*
op
)
:
fState
(
state
)
fOp
(
op
)
{
}
GrDrawOpUploadToken
addInlineUpload
(
DeferredUploadFn
&
&
upload
)
{
fOp
-
>
fInlineUploads
.
emplace_back
(
std
:
:
move
(
upload
)
fState
-
>
nextDrawToken
(
)
)
;
return
fOp
-
>
fInlineUploads
.
back
(
)
.
fUploadBeforeToken
;
}
GrDrawOpUploadToken
addAsapUpload
(
DeferredUploadFn
&
&
upload
)
{
fState
-
>
addASAPUpload
(
std
:
:
move
(
upload
)
)
;
return
fState
-
>
nextTokenToFlush
(
)
;
}
bool
hasDrawBeenFlushed
(
GrDrawOpUploadToken
token
)
const
{
return
fState
-
>
hasDrawBeenFlushed
(
token
)
;
}
GrDrawOpUploadToken
nextDrawToken
(
)
const
{
return
fState
-
>
nextDrawToken
(
)
;
}
const
GrCaps
&
caps
(
)
const
{
return
fState
-
>
caps
(
)
;
}
GrResourceProvider
*
resourceProvider
(
)
const
{
return
fState
-
>
resourceProvider
(
)
;
}
protected
:
GrDrawOp
*
op
(
)
{
return
fOp
;
}
GrOpFlushState
*
state
(
)
{
return
fState
;
}
private
:
GrOpFlushState
*
fState
;
GrDrawOp
*
fOp
;
}
;
class
GrMeshDrawOp
:
:
Target
:
public
GrDrawOp
:
:
Target
{
public
:
Target
(
GrOpFlushState
*
state
GrMeshDrawOp
*
op
)
:
INHERITED
(
state
op
)
{
}
void
draw
(
const
GrGeometryProcessor
*
gp
const
GrPipeline
*
pipeline
const
GrMesh
&
mesh
)
;
void
*
makeVertexSpace
(
size_t
vertexSize
int
vertexCount
const
GrBuffer
*
*
buffer
int
*
startVertex
)
{
return
this
-
>
state
(
)
-
>
makeVertexSpace
(
vertexSize
vertexCount
buffer
startVertex
)
;
}
uint16_t
*
makeIndexSpace
(
int
indexCount
const
GrBuffer
*
*
buffer
int
*
startIndex
)
{
return
this
-
>
state
(
)
-
>
makeIndexSpace
(
indexCount
buffer
startIndex
)
;
}
void
putBackIndices
(
int
indices
)
{
this
-
>
state
(
)
-
>
putBackIndices
(
indices
)
;
}
void
putBackVertices
(
int
vertices
size_t
vertexStride
)
{
this
-
>
state
(
)
-
>
putBackVertexSpace
(
vertices
*
vertexStride
)
;
}
private
:
GrMeshDrawOp
*
meshDrawOp
(
)
{
return
static_cast
<
GrMeshDrawOp
*
>
(
this
-
>
op
(
)
)
;
}
typedef
GrDrawOp
:
:
Target
INHERITED
;
}
;
#
endif
