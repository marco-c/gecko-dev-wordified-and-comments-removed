#
include
"
GrPrimitiveProcessor
.
h
"
#
include
"
GrCoordTransform
.
h
"
enum
{
kMatrixTypeKeyBits
=
1
kMatrixTypeKeyMask
=
(
1
<
<
kMatrixTypeKeyBits
)
-
1
kPrecisionBits
=
2
kPrecisionShift
=
kMatrixTypeKeyBits
kPositionCoords_Flag
=
(
1
<
<
(
kPrecisionShift
+
kPrecisionBits
)
)
kTransformKeyBits
=
kMatrixTypeKeyBits
+
kPrecisionBits
+
2
}
;
GR_STATIC_ASSERT
(
kHigh_GrSLPrecision
<
(
1
<
<
kPrecisionBits
)
)
;
enum
MatrixType
{
kNoPersp_MatrixType
=
0
kGeneral_MatrixType
=
1
}
;
uint32_t
GrPrimitiveProcessor
:
:
getTransformKey
(
const
SkTArray
<
const
GrCoordTransform
*
true
>
&
coords
int
numCoords
)
const
{
uint32_t
totalKey
=
0
;
for
(
int
t
=
0
;
t
<
numCoords
;
+
+
t
)
{
uint32_t
key
=
0
;
const
GrCoordTransform
*
coordTransform
=
coords
[
t
]
;
if
(
coordTransform
-
>
getMatrix
(
)
.
hasPerspective
(
)
)
{
key
|
=
kGeneral_MatrixType
;
}
else
{
key
|
=
kNoPersp_MatrixType
;
}
if
(
!
this
-
>
hasExplicitLocalCoords
(
)
)
{
key
|
=
kPositionCoords_Flag
;
}
GR_STATIC_ASSERT
(
kGrSLPrecisionCount
<
=
(
1
<
<
kPrecisionBits
)
)
;
key
|
=
(
coordTransform
-
>
precision
(
)
<
<
kPrecisionShift
)
;
key
<
<
=
kTransformKeyBits
*
t
;
SkASSERT
(
0
=
=
(
totalKey
&
key
)
)
;
totalKey
|
=
key
;
}
return
totalKey
;
}
