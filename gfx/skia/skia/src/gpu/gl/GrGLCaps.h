#
ifndef
GrGLCaps_DEFINED
#
define
GrGLCaps_DEFINED
#
include
"
glsl
/
GrGLSL
.
h
"
#
include
"
GrCaps
.
h
"
#
include
"
GrGLStencilAttachment
.
h
"
#
include
"
GrSwizzle
.
h
"
#
include
"
SkChecksum
.
h
"
#
include
"
SkTHash
.
h
"
#
include
"
SkTArray
.
h
"
class
GrGLContextInfo
;
class
GrGLSLCaps
;
class
GrGLCaps
:
public
GrCaps
{
public
:
typedef
GrGLStencilAttachment
:
:
Format
StencilFormat
;
enum
MSFBOType
{
kNone_MSFBOType
=
0
kDesktop_ARB_MSFBOType
kDesktop_EXT_MSFBOType
kES_3_0_MSFBOType
kES_Apple_MSFBOType
kES_IMG_MsToTexture_MSFBOType
kES_EXT_MsToTexture_MSFBOType
kMixedSamples_MSFBOType
kLast_MSFBOType
=
kMixedSamples_MSFBOType
}
;
enum
InvalidateFBType
{
kNone_InvalidateFBType
kDiscard_InvalidateFBType
kInvalidate_InvalidateFBType
kLast_InvalidateFBType
=
kInvalidate_InvalidateFBType
}
;
enum
MapBufferType
{
kNone_MapBufferType
kMapBuffer_MapBufferType
kMapBufferRange_MapBufferType
kChromium_MapBufferType
kLast_MapBufferType
=
kChromium_MapBufferType
}
;
enum
TransferBufferType
{
kNone_TransferBufferType
kPBO_TransferBufferType
kChromium_TransferBufferType
kLast_TransferBufferType
=
kChromium_TransferBufferType
}
;
GrGLCaps
(
const
GrContextOptions
&
contextOptions
const
GrGLContextInfo
&
ctxInfo
const
GrGLInterface
*
glInterface
)
;
bool
isConfigTexturable
(
GrPixelConfig
config
)
const
override
{
SkASSERT
(
kGrPixelConfigCnt
>
config
)
;
return
SkToBool
(
fConfigTable
[
config
]
.
fFlags
&
ConfigInfo
:
:
kTextureable_Flag
)
;
}
bool
isConfigRenderable
(
GrPixelConfig
config
bool
withMSAA
)
const
override
{
SkASSERT
(
kGrPixelConfigCnt
>
config
)
;
if
(
withMSAA
)
{
return
SkToBool
(
fConfigTable
[
config
]
.
fFlags
&
ConfigInfo
:
:
kRenderableWithMSAA_Flag
)
;
}
else
{
return
SkToBool
(
fConfigTable
[
config
]
.
fFlags
&
ConfigInfo
:
:
kRenderable_Flag
)
;
}
}
const
GrSwizzle
&
configSwizzle
(
GrPixelConfig
config
)
const
{
return
fConfigTable
[
config
]
.
fSwizzle
;
}
bool
getTexImageFormats
(
GrPixelConfig
surfaceConfig
GrPixelConfig
externalConfig
GrGLenum
*
internalFormat
GrGLenum
*
externalFormat
GrGLenum
*
externalType
)
const
;
bool
getCompressedTexImageFormats
(
GrPixelConfig
surfaceConfig
GrGLenum
*
internalFormat
)
const
;
bool
getReadPixelsFormat
(
GrPixelConfig
surfaceConfig
GrPixelConfig
externalConfig
GrGLenum
*
externalFormat
GrGLenum
*
externalType
)
const
;
bool
getRenderbufferFormat
(
GrPixelConfig
config
GrGLenum
*
internalFormat
)
const
;
const
SkTArray
<
StencilFormat
true
>
&
stencilFormats
(
)
const
{
return
fStencilFormats
;
}
bool
hasStencilFormatBeenDeterminedForConfig
(
GrPixelConfig
config
)
const
{
return
fConfigTable
[
config
]
.
fStencilFormatIndex
!
=
ConfigInfo
:
:
kUnknown_StencilIndex
;
}
int
getStencilFormatIndexForConfig
(
GrPixelConfig
config
)
const
{
SkASSERT
(
this
-
>
hasStencilFormatBeenDeterminedForConfig
(
config
)
)
;
return
fConfigTable
[
config
]
.
fStencilFormatIndex
;
}
void
setStencilFormatIndexForConfig
(
GrPixelConfig
config
int
index
)
{
SkASSERT
(
!
this
-
>
hasStencilFormatBeenDeterminedForConfig
(
config
)
)
;
if
(
index
<
0
)
{
fConfigTable
[
config
]
.
fStencilFormatIndex
=
ConfigInfo
:
:
kUnsupported_StencilFormatIndex
;
}
else
{
fConfigTable
[
config
]
.
fStencilFormatIndex
=
index
;
}
}
void
markConfigAsValidColorAttachment
(
GrPixelConfig
config
)
{
fConfigTable
[
config
]
.
fFlags
|
=
ConfigInfo
:
:
kVerifiedColorAttachment_Flag
;
}
bool
isConfigVerifiedColorAttachment
(
GrPixelConfig
config
)
const
{
return
SkToBool
(
fConfigTable
[
config
]
.
fFlags
&
ConfigInfo
:
:
kVerifiedColorAttachment_Flag
)
;
}
MSFBOType
msFBOType
(
)
const
{
return
fMSFBOType
;
}
bool
usesMSAARenderBuffers
(
)
const
{
return
kNone_MSFBOType
!
=
fMSFBOType
&
&
kES_IMG_MsToTexture_MSFBOType
!
=
fMSFBOType
&
&
kES_EXT_MsToTexture_MSFBOType
!
=
fMSFBOType
&
&
kMixedSamples_MSFBOType
!
=
fMSFBOType
;
}
bool
usesImplicitMSAAResolve
(
)
const
{
return
kES_IMG_MsToTexture_MSFBOType
=
=
fMSFBOType
|
|
kES_EXT_MsToTexture_MSFBOType
=
=
fMSFBOType
;
}
InvalidateFBType
invalidateFBType
(
)
const
{
return
fInvalidateFBType
;
}
MapBufferType
mapBufferType
(
)
const
{
return
fMapBufferType
;
}
TransferBufferType
transferBufferType
(
)
const
{
return
fTransferBufferType
;
}
int
maxFragmentUniformVectors
(
)
const
{
return
fMaxFragmentUniformVectors
;
}
int
maxVertexAttributes
(
)
const
{
return
fMaxVertexAttributes
;
}
int
maxFragmentTextureUnits
(
)
const
{
return
fMaxFragmentTextureUnits
;
}
bool
bgraIsInternalFormat
(
)
const
;
bool
unpackRowLengthSupport
(
)
const
{
return
fUnpackRowLengthSupport
;
}
bool
unpackFlipYSupport
(
)
const
{
return
fUnpackFlipYSupport
;
}
bool
packRowLengthSupport
(
)
const
{
return
fPackRowLengthSupport
;
}
bool
packFlipYSupport
(
)
const
{
return
fPackFlipYSupport
;
}
bool
textureUsageSupport
(
)
const
{
return
fTextureUsageSupport
;
}
bool
texStorageSupport
(
)
const
{
return
fTexStorageSupport
;
}
bool
textureRedSupport
(
)
const
{
return
fTextureRedSupport
;
}
bool
imagingSupport
(
)
const
{
return
fImagingSupport
;
}
bool
vertexArrayObjectSupport
(
)
const
{
return
fVertexArrayObjectSupport
;
}
bool
directStateAccessSupport
(
)
const
{
return
fDirectStateAccessSupport
;
}
bool
debugSupport
(
)
const
{
return
fDebugSupport
;
}
bool
ES2CompatibilitySupport
(
)
const
{
return
fES2CompatibilitySupport
;
}
bool
multisampleDisableSupport
(
)
const
{
return
fMultisampleDisableSupport
;
}
bool
useNonVBOVertexAndIndexDynamicData
(
)
const
{
return
fUseNonVBOVertexAndIndexDynamicData
;
}
bool
readPixelsSupported
(
const
GrGLInterface
*
intf
GrPixelConfig
readConfig
GrPixelConfig
currFBOConfig
)
const
;
bool
isCoreProfile
(
)
const
{
return
fIsCoreProfile
;
}
bool
bindFragDataLocationSupport
(
)
const
{
return
fBindFragDataLocationSupport
;
}
bool
bindUniformLocationSupport
(
)
const
{
return
fBindUniformLocationSupport
;
}
bool
externalTextureSupport
(
)
const
{
return
fExternalTextureSupport
;
}
bool
rectangleTextureSupport
(
)
const
{
return
fRectangleTextureSupport
;
}
bool
textureSwizzleSupport
(
)
const
{
return
fTextureSwizzleSupport
;
}
bool
srgbWriteControl
(
)
const
{
return
fSRGBWriteControl
;
}
SkString
dump
(
)
const
override
;
bool
rgba8888PixelsOpsAreSlow
(
)
const
{
return
fRGBA8888PixelsOpsAreSlow
;
}
bool
partialFBOReadIsSlow
(
)
const
{
return
fPartialFBOReadIsSlow
;
}
const
GrGLSLCaps
*
glslCaps
(
)
const
{
return
reinterpret_cast
<
GrGLSLCaps
*
>
(
fShaderCaps
.
get
(
)
)
;
}
private
:
enum
ExternalFormatUsage
{
kTexImage_ExternalFormatUsage
kOther_ExternalFormatUsage
kLast_ExternalFormatUsage
=
kOther_ExternalFormatUsage
}
;
static
const
int
kExternalFormatUsageCnt
=
kLast_ExternalFormatUsage
+
1
;
bool
getExternalFormat
(
GrPixelConfig
surfaceConfig
GrPixelConfig
memoryConfig
ExternalFormatUsage
usage
GrGLenum
*
externalFormat
GrGLenum
*
externalType
)
const
;
void
init
(
const
GrContextOptions
&
const
GrGLContextInfo
&
const
GrGLInterface
*
)
;
void
initGLSL
(
const
GrGLContextInfo
&
)
;
bool
hasPathRenderingSupport
(
const
GrGLContextInfo
&
const
GrGLInterface
*
)
;
void
onApplyOptionsOverrides
(
const
GrContextOptions
&
options
)
override
;
void
initFSAASupport
(
const
GrGLContextInfo
&
const
GrGLInterface
*
)
;
void
initBlendEqationSupport
(
const
GrGLContextInfo
&
)
;
void
initStencilFormats
(
const
GrGLContextInfo
&
)
;
void
initConfigTable
(
const
GrGLContextInfo
&
const
GrGLInterface
*
gli
GrGLSLCaps
*
glslCaps
)
;
void
initShaderPrecisionTable
(
const
GrGLContextInfo
&
ctxInfo
const
GrGLInterface
*
intf
GrGLSLCaps
*
glslCaps
)
;
SkTArray
<
StencilFormat
true
>
fStencilFormats
;
int
fMaxFragmentUniformVectors
;
int
fMaxVertexAttributes
;
int
fMaxFragmentTextureUnits
;
MSFBOType
fMSFBOType
;
InvalidateFBType
fInvalidateFBType
;
MapBufferType
fMapBufferType
;
TransferBufferType
fTransferBufferType
;
bool
fUnpackRowLengthSupport
:
1
;
bool
fUnpackFlipYSupport
:
1
;
bool
fPackRowLengthSupport
:
1
;
bool
fPackFlipYSupport
:
1
;
bool
fTextureUsageSupport
:
1
;
bool
fTexStorageSupport
:
1
;
bool
fTextureRedSupport
:
1
;
bool
fImagingSupport
:
1
;
bool
fVertexArrayObjectSupport
:
1
;
bool
fDirectStateAccessSupport
:
1
;
bool
fDebugSupport
:
1
;
bool
fES2CompatibilitySupport
:
1
;
bool
fMultisampleDisableSupport
:
1
;
bool
fUseNonVBOVertexAndIndexDynamicData
:
1
;
bool
fIsCoreProfile
:
1
;
bool
fBindFragDataLocationSupport
:
1
;
bool
fSRGBWriteControl
:
1
;
bool
fRGBA8888PixelsOpsAreSlow
:
1
;
bool
fPartialFBOReadIsSlow
:
1
;
bool
fBindUniformLocationSupport
:
1
;
bool
fExternalTextureSupport
:
1
;
bool
fRectangleTextureSupport
:
1
;
bool
fTextureSwizzleSupport
:
1
;
enum
FormatType
{
kNormalizedFixedPoint_FormatType
kFloat_FormatType
}
;
struct
ReadPixelsFormat
{
ReadPixelsFormat
(
)
:
fFormat
(
0
)
fType
(
0
)
{
}
GrGLenum
fFormat
;
GrGLenum
fType
;
}
;
struct
ConfigFormats
{
ConfigFormats
(
)
{
memset
(
this
0xAB
sizeof
(
ConfigFormats
)
)
;
}
GrGLenum
fBaseInternalFormat
;
GrGLenum
fSizedInternalFormat
;
GrGLenum
fExternalFormat
[
kExternalFormatUsageCnt
]
;
GrGLenum
fExternalType
;
GrGLenum
fInternalFormatTexImage
;
GrGLenum
fInternalFormatRenderbuffer
;
}
;
struct
ConfigInfo
{
ConfigInfo
(
)
:
fStencilFormatIndex
(
kUnknown_StencilIndex
)
fFlags
(
0
)
{
}
ConfigFormats
fFormats
;
FormatType
fFormatType
;
ReadPixelsFormat
fSecondReadPixelsFormat
;
enum
{
kUnknown_StencilIndex
=
-
1
kUnsupported_StencilFormatIndex
=
-
2
}
;
int
fStencilFormatIndex
;
enum
{
kVerifiedColorAttachment_Flag
=
0x1
kTextureable_Flag
=
0x2
kRenderable_Flag
=
0x4
kRenderableWithMSAA_Flag
=
0x8
}
;
uint32_t
fFlags
;
GrSwizzle
fSwizzle
;
}
;
ConfigInfo
fConfigTable
[
kGrPixelConfigCnt
]
;
typedef
GrCaps
INHERITED
;
}
;
#
endif
