#
include
"
src
/
text
/
gpu
/
DistanceFieldAdjustTable
.
h
"
#
include
"
src
/
core
/
SkScalerContext
.
h
"
using
namespace
skia_private
;
namespace
sktext
:
:
gpu
{
SkDEBUGCODE
(
static
const
int
kExpectedDistanceAdjustTableSize
=
8
;
)
SkScalar
*
build_distance_adjust_table
(
SkScalar
paintGamma
SkScalar
deviceGamma
)
{
int
width
height
;
size_t
size
;
#
ifdef
SK_GAMMA_CONTRAST
SkScalar
contrast
=
SK_GAMMA_CONTRAST
;
#
else
SkScalar
contrast
=
0
.
5f
;
#
endif
size
=
SkScalerContext
:
:
GetGammaLUTSize
(
contrast
paintGamma
deviceGamma
&
width
&
height
)
;
SkASSERT
(
kExpectedDistanceAdjustTableSize
=
=
height
)
;
SkScalar
*
table
=
new
SkScalar
[
height
]
;
AutoTArray
<
uint8_t
>
data
(
(
int
)
size
)
;
if
(
!
SkScalerContext
:
:
GetGammaLUTData
(
contrast
paintGamma
deviceGamma
data
.
get
(
)
)
)
{
for
(
int
row
=
0
;
row
<
height
;
+
+
row
)
{
table
[
row
]
=
0
;
}
return
table
;
}
for
(
int
row
=
0
;
row
<
height
;
+
+
row
)
{
uint8_t
*
rowPtr
=
data
.
get
(
)
+
row
*
width
;
for
(
int
col
=
0
;
col
<
width
-
1
;
+
+
col
)
{
if
(
rowPtr
[
col
]
<
=
127
&
&
rowPtr
[
col
+
1
]
>
=
128
)
{
float
interp
=
(
127
.
5f
-
rowPtr
[
col
]
)
/
(
rowPtr
[
col
+
1
]
-
rowPtr
[
col
]
)
;
float
borderAlpha
=
(
col
+
interp
)
/
255
.
f
;
float
t
=
borderAlpha
*
(
borderAlpha
*
(
4
.
0f
*
borderAlpha
-
6
.
0f
)
+
5
.
0f
)
/
3
.
0f
;
const
float
kDistanceFieldAAFactor
=
0
.
65f
;
float
d
=
2
.
0f
*
kDistanceFieldAAFactor
*
t
-
kDistanceFieldAAFactor
;
table
[
row
]
=
d
;
break
;
}
}
}
return
table
;
}
const
DistanceFieldAdjustTable
*
DistanceFieldAdjustTable
:
:
Get
(
)
{
static
const
DistanceFieldAdjustTable
*
dfat
=
new
DistanceFieldAdjustTable
;
return
dfat
;
}
DistanceFieldAdjustTable
:
:
DistanceFieldAdjustTable
(
)
{
fTable
=
build_distance_adjust_table
(
SK_GAMMA_EXPONENT
SK_GAMMA_EXPONENT
)
;
fGammaCorrectTable
=
build_distance_adjust_table
(
SK_Scalar1
SK_Scalar1
)
;
}
}
