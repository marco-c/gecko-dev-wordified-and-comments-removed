#
ifndef
SkImage_Lazy_DEFINED
#
define
SkImage_Lazy_DEFINED
#
include
"
SkImage_Base
.
h
"
#
include
"
SkMutex
.
h
"
#
if
SK_SUPPORT_GPU
#
include
"
GrTextureMaker
.
h
"
#
endif
class
SharedGenerator
;
class
SkImage_Lazy
:
public
SkImage_Base
{
public
:
struct
Validator
{
Validator
(
sk_sp
<
SharedGenerator
>
const
SkIRect
*
subset
sk_sp
<
SkColorSpace
>
colorSpace
)
;
MOZ_IMPLICIT
operator
bool
(
)
const
{
return
fSharedGenerator
.
get
(
)
;
}
sk_sp
<
SharedGenerator
>
fSharedGenerator
;
SkImageInfo
fInfo
;
SkIPoint
fOrigin
;
sk_sp
<
SkColorSpace
>
fColorSpace
;
uint32_t
fUniqueID
;
}
;
SkImage_Lazy
(
Validator
*
validator
)
;
~
SkImage_Lazy
(
)
override
;
SkImageInfo
onImageInfo
(
)
const
override
{
return
fInfo
;
}
SkIRect
onGetSubset
(
)
const
override
{
return
SkIRect
:
:
MakeXYWH
(
fOrigin
.
fX
fOrigin
.
fY
fInfo
.
width
(
)
fInfo
.
height
(
)
)
;
}
bool
onReadPixels
(
const
SkImageInfo
&
void
*
size_t
int
srcX
int
srcY
CachingHint
)
const
override
;
#
if
SK_SUPPORT_GPU
sk_sp
<
GrTextureProxy
>
asTextureProxyRef
(
GrContext
*
const
GrSamplerState
&
SkColorSpace
*
sk_sp
<
SkColorSpace
>
*
SkScalar
scaleAdjust
[
2
]
)
const
override
;
sk_sp
<
SkCachedData
>
getPlanes
(
SkYUVSizeInfo
*
SkYUVColorSpace
*
const
void
*
planes
[
3
]
)
override
;
#
endif
sk_sp
<
SkData
>
onRefEncoded
(
)
const
override
;
sk_sp
<
SkImage
>
onMakeSubset
(
const
SkIRect
&
)
const
override
;
bool
getROPixels
(
SkBitmap
*
SkColorSpace
*
dstColorSpace
CachingHint
)
const
override
;
bool
onIsLazyGenerated
(
)
const
override
{
return
true
;
}
sk_sp
<
SkImage
>
onMakeColorSpace
(
sk_sp
<
SkColorSpace
>
)
const
override
;
bool
onIsValid
(
GrContext
*
)
const
override
;
bool
lockAsBitmapOnlyIfAlreadyCached
(
SkBitmap
*
const
SkImageInfo
&
)
const
;
bool
directGeneratePixels
(
const
SkImageInfo
&
dstInfo
void
*
dstPixels
size_t
dstRB
int
srcX
int
srcY
)
const
;
#
if
SK_SUPPORT_GPU
sk_sp
<
GrTextureProxy
>
lockTextureProxy
(
GrContext
*
const
GrUniqueKey
&
key
SkImage
:
:
CachingHint
bool
willBeMipped
SkColorSpace
*
dstColorSpace
GrTextureMaker
:
:
AllowedTexGenType
genType
)
const
;
void
makeCacheKeyFromOrigKey
(
const
GrUniqueKey
&
origKey
GrUniqueKey
*
cacheKey
)
const
;
#
endif
private
:
class
ScopedGenerator
;
bool
lockAsBitmap
(
SkBitmap
*
SkImage
:
:
CachingHint
const
SkImageInfo
&
)
const
;
sk_sp
<
SharedGenerator
>
fSharedGenerator
;
const
SkImageInfo
fInfo
;
const
SkIPoint
fOrigin
;
uint32_t
fUniqueID
;
mutable
SkMutex
fOnMakeColorSpaceMutex
;
mutable
sk_sp
<
SkColorSpace
>
fOnMakeColorSpaceTarget
;
mutable
sk_sp
<
SkImage
>
fOnMakeColorSpaceResult
;
#
if
SK_SUPPORT_GPU
mutable
SkTDArray
<
GrUniqueKeyInvalidatedMessage
*
>
fUniqueKeyInvalidatedMessages
;
#
endif
typedef
SkImage_Base
INHERITED
;
}
;
#
endif
