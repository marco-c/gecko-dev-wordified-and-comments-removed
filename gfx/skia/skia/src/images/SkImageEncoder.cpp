#
include
"
include
/
encode
/
SkJpegEncoder
.
h
"
#
include
"
include
/
encode
/
SkPngEncoder
.
h
"
#
include
"
include
/
encode
/
SkWebpEncoder
.
h
"
#
include
"
src
/
images
/
SkImageEncoderPriv
.
h
"
#
ifndef
SK_HAS_JPEG_LIBRARY
bool
SkJpegEncoder
:
:
Encode
(
SkWStream
*
const
SkPixmap
&
const
Options
&
)
{
return
false
;
}
std
:
:
unique_ptr
<
SkEncoder
>
SkJpegEncoder
:
:
Make
(
SkWStream
*
const
SkPixmap
&
const
Options
&
)
{
return
nullptr
;
}
#
endif
#
ifndef
SK_HAS_PNG_LIBRARY
bool
SkPngEncoder
:
:
Encode
(
SkWStream
*
const
SkPixmap
&
const
Options
&
)
{
return
false
;
}
std
:
:
unique_ptr
<
SkEncoder
>
SkPngEncoder
:
:
Make
(
SkWStream
*
const
SkPixmap
&
const
Options
&
)
{
return
nullptr
;
}
#
endif
#
ifndef
SK_HAS_WEBP_LIBRARY
bool
SkWebpEncoder
:
:
Encode
(
SkWStream
*
const
SkPixmap
&
const
Options
&
)
{
return
false
;
}
#
endif
bool
SkEncodeImage
(
SkWStream
*
dst
const
SkPixmap
&
src
SkEncodedImageFormat
format
int
quality
)
{
#
ifdef
SK_USE_CG_ENCODER
(
void
)
quality
;
return
SkEncodeImageWithCG
(
dst
src
format
)
;
#
elif
SK_USE_WIC_ENCODER
return
SkEncodeImageWithWIC
(
dst
src
format
quality
)
;
#
else
switch
(
format
)
{
case
SkEncodedImageFormat
:
:
kJPEG
:
{
SkJpegEncoder
:
:
Options
opts
;
opts
.
fQuality
=
quality
;
return
SkJpegEncoder
:
:
Encode
(
dst
src
opts
)
;
}
case
SkEncodedImageFormat
:
:
kPNG
:
{
SkPngEncoder
:
:
Options
opts
;
return
SkPngEncoder
:
:
Encode
(
dst
src
opts
)
;
}
case
SkEncodedImageFormat
:
:
kWEBP
:
{
SkWebpEncoder
:
:
Options
opts
;
if
(
quality
=
=
100
)
{
opts
.
fCompression
=
SkWebpEncoder
:
:
Compression
:
:
kLossless
;
opts
.
fQuality
=
75
;
}
else
{
opts
.
fCompression
=
SkWebpEncoder
:
:
Compression
:
:
kLossy
;
opts
.
fQuality
=
quality
;
}
return
SkWebpEncoder
:
:
Encode
(
dst
src
opts
)
;
}
default
:
return
false
;
}
#
endif
}
bool
SkEncoder
:
:
encodeRows
(
int
numRows
)
{
SkASSERT
(
numRows
>
0
&
&
fCurrRow
<
fSrc
.
height
(
)
)
;
if
(
numRows
<
=
0
|
|
fCurrRow
>
=
fSrc
.
height
(
)
)
{
return
false
;
}
if
(
fCurrRow
+
numRows
>
fSrc
.
height
(
)
)
{
numRows
=
fSrc
.
height
(
)
-
fCurrRow
;
}
if
(
!
this
-
>
onEncodeRows
(
numRows
)
)
{
fCurrRow
=
fSrc
.
height
(
)
;
return
false
;
}
return
true
;
}
sk_sp
<
SkData
>
SkEncodePixmap
(
const
SkPixmap
&
src
SkEncodedImageFormat
format
int
quality
)
{
SkDynamicMemoryWStream
stream
;
return
SkEncodeImage
(
&
stream
src
format
quality
)
?
stream
.
detachAsData
(
)
:
nullptr
;
}
sk_sp
<
SkData
>
SkEncodeBitmap
(
const
SkBitmap
&
src
SkEncodedImageFormat
format
int
quality
)
{
SkPixmap
pixmap
;
return
src
.
peekPixels
(
&
pixmap
)
?
SkEncodePixmap
(
pixmap
format
quality
)
:
nullptr
;
}
