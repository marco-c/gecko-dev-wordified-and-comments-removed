#
ifndef
SKSL_CODEGENERATOR
#
define
SKSL_CODEGENERATOR
#
include
"
src
/
sksl
/
SkSLContext
.
h
"
#
include
"
src
/
sksl
/
SkSLOutputStream
.
h
"
#
include
"
src
/
sksl
/
ir
/
SkSLProgram
.
h
"
namespace
SkSL
{
struct
ShaderCaps
;
class
CodeGenerator
{
public
:
CodeGenerator
(
const
Context
*
context
const
ShaderCaps
*
caps
const
Program
*
program
OutputStream
*
stream
)
:
fProgram
(
*
program
)
fContext
(
fProgram
.
fContext
-
>
fTypes
*
fProgram
.
fContext
-
>
fErrors
)
fCaps
(
*
caps
)
fOut
(
stream
)
{
fContext
.
fConfig
=
fProgram
.
fConfig
.
get
(
)
;
fContext
.
fModule
=
fProgram
.
fContext
-
>
fModule
;
fContext
.
fSymbolTable
=
fProgram
.
fSymbols
.
get
(
)
;
}
virtual
~
CodeGenerator
(
)
=
default
;
virtual
bool
generateCode
(
)
=
0
;
OutputStream
*
outputStream
(
)
{
return
fOut
;
}
void
setOutputStream
(
OutputStream
*
output
)
{
fOut
=
output
;
}
protected
:
static
constexpr
float
kSharpenTexturesBias
=
-
.
475f
;
const
Program
&
fProgram
;
Context
fContext
;
const
ShaderCaps
&
fCaps
;
OutputStream
*
fOut
;
}
;
class
AutoOutputStream
{
public
:
AutoOutputStream
(
CodeGenerator
*
codeGen
OutputStream
*
newOutput
)
:
fCodeGen
(
codeGen
)
fOldOutput
(
codeGen
-
>
outputStream
(
)
)
{
fCodeGen
-
>
setOutputStream
(
newOutput
)
;
}
AutoOutputStream
(
CodeGenerator
*
codeGen
OutputStream
*
newOutput
int
*
indentationPtr
)
:
fCodeGen
(
codeGen
)
fOldOutput
(
codeGen
-
>
outputStream
(
)
)
fIndentationPtr
(
indentationPtr
)
fOldIndentation
(
indentationPtr
?
*
indentationPtr
:
0
)
{
fCodeGen
-
>
setOutputStream
(
newOutput
)
;
*
fIndentationPtr
=
0
;
}
~
AutoOutputStream
(
)
{
fCodeGen
-
>
setOutputStream
(
fOldOutput
)
;
if
(
fIndentationPtr
)
{
*
fIndentationPtr
=
fOldIndentation
;
}
}
private
:
CodeGenerator
*
fCodeGen
=
nullptr
;
OutputStream
*
fOldOutput
=
nullptr
;
int
*
fIndentationPtr
=
nullptr
;
int
fOldIndentation
=
0
;
}
;
}
#
endif
