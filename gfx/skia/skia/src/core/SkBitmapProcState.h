#
ifndef
SkBitmapProcState_DEFINED
#
define
SkBitmapProcState_DEFINED
#
include
"
SkBitmap
.
h
"
#
include
"
SkBitmapController
.
h
"
#
include
"
SkBitmapFilter
.
h
"
#
include
"
SkBitmapProvider
.
h
"
#
include
"
SkFloatBits
.
h
"
#
include
"
SkMatrix
.
h
"
#
include
"
SkMipMap
.
h
"
#
include
"
SkPaint
.
h
"
#
include
"
SkShader
.
h
"
#
include
"
SkTemplates
.
h
"
typedef
SkFixed3232
SkFractionalInt
;
#
define
SkScalarToFractionalInt
(
x
)
SkScalarToFixed3232
(
x
)
#
define
SkFractionalIntToFixed
(
x
)
SkFixed3232ToFixed
(
x
)
#
define
SkFixedToFractionalInt
(
x
)
SkFixedToFixed3232
(
x
)
#
define
SkFractionalIntToInt
(
x
)
SkFixed3232ToInt
(
x
)
class
SkPaint
;
struct
SkBitmapProcState
{
SkBitmapProcState
(
const
SkBitmapProvider
&
SkShader
:
:
TileMode
tmx
SkShader
:
:
TileMode
tmy
)
;
SkBitmapProcState
(
const
SkBitmap
&
SkShader
:
:
TileMode
tmx
SkShader
:
:
TileMode
tmy
)
;
~
SkBitmapProcState
(
)
;
typedef
void
(
*
ShaderProc32
)
(
const
void
*
ctx
int
x
int
y
SkPMColor
[
]
int
count
)
;
typedef
void
(
*
ShaderProc16
)
(
const
void
*
ctx
int
x
int
y
uint16_t
[
]
int
count
)
;
typedef
void
(
*
MatrixProc
)
(
const
SkBitmapProcState
&
uint32_t
bitmapXY
[
]
int
count
int
x
int
y
)
;
typedef
void
(
*
SampleProc32
)
(
const
SkBitmapProcState
&
const
uint32_t
[
]
int
count
SkPMColor
colors
[
]
)
;
typedef
U16CPU
(
*
FixedTileProc
)
(
SkFixed
)
;
typedef
U16CPU
(
*
FixedTileLowBitsProc
)
(
SkFixed
int
)
;
typedef
U16CPU
(
*
IntTileProc
)
(
int
value
int
count
)
;
SkPixmap
fPixmap
;
SkMatrix
fInvMatrix
;
SkMatrix
:
:
MapXYProc
fInvProc
;
SkFractionalInt
fInvSxFractionalInt
;
SkFractionalInt
fInvKyFractionalInt
;
FixedTileProc
fTileProcX
;
FixedTileProc
fTileProcY
;
FixedTileLowBitsProc
fTileLowBitsProcX
;
FixedTileLowBitsProc
fTileLowBitsProcY
;
IntTileProc
fIntTileProcY
;
SkFixed
fFilterOneX
;
SkFixed
fFilterOneY
;
SkPMColor
fPaintPMColor
;
SkFixed
fInvSx
;
SkFixed
fInvKy
;
uint16_t
fAlphaScale
;
uint8_t
fInvType
;
uint8_t
fTileModeX
;
uint8_t
fTileModeY
;
uint8_t
fFilterLevel
;
void
platformProcs
(
)
;
int
maxCountForBufferSize
(
size_t
bufferSize
)
const
;
ShaderProc32
getShaderProc32
(
)
const
{
return
fShaderProc32
;
}
ShaderProc16
getShaderProc16
(
)
const
{
return
fShaderProc16
;
}
#
ifdef
SK_DEBUG
MatrixProc
getMatrixProc
(
)
const
;
#
else
MatrixProc
getMatrixProc
(
)
const
{
return
fMatrixProc
;
}
#
endif
SampleProc32
getSampleProc32
(
)
const
{
return
fSampleProc32
;
}
private
:
friend
class
SkBitmapProcShader
;
friend
class
SkLightingShaderImpl
;
ShaderProc32
fShaderProc32
;
ShaderProc16
fShaderProc16
;
MatrixProc
fMatrixProc
;
SampleProc32
fSampleProc32
;
const
SkBitmapProvider
fProvider
;
enum
{
kBMStateSize
=
136
}
;
SkAlignedSStorage
<
kBMStateSize
>
fBMStateStorage
;
SkBitmapController
:
:
State
*
fBMState
;
MatrixProc
chooseMatrixProc
(
bool
trivial_matrix
)
;
bool
chooseProcs
(
const
SkMatrix
&
inv
const
SkPaint
&
)
;
bool
chooseScanlineProcs
(
bool
trivialMatrix
bool
clampClamp
const
SkPaint
&
paint
)
;
ShaderProc32
chooseShaderProc32
(
)
;
bool
setupForTranslate
(
)
;
#
ifdef
SK_DEBUG
static
void
DebugMatrixProc
(
const
SkBitmapProcState
&
uint32_t
[
]
int
count
int
x
int
y
)
;
#
endif
}
;
#
ifdef
SK_CPU_BENDIAN
#
define
PACK_TWO_SHORTS
(
pri
sec
)
(
(
pri
)
<
<
16
|
(
sec
)
)
#
define
UNPACK_PRIMARY_SHORT
(
packed
)
(
(
uint32_t
)
(
packed
)
>
>
16
)
#
define
UNPACK_SECONDARY_SHORT
(
packed
)
(
(
packed
)
&
0xFFFF
)
#
else
#
define
PACK_TWO_SHORTS
(
pri
sec
)
(
(
pri
)
|
(
(
sec
)
<
<
16
)
)
#
define
UNPACK_PRIMARY_SHORT
(
packed
)
(
(
packed
)
&
0xFFFF
)
#
define
UNPACK_SECONDARY_SHORT
(
packed
)
(
(
uint32_t
)
(
packed
)
>
>
16
)
#
endif
#
ifdef
SK_DEBUG
static
inline
uint32_t
pack_two_shorts
(
U16CPU
pri
U16CPU
sec
)
{
SkASSERT
(
(
uint16_t
)
pri
=
=
pri
)
;
SkASSERT
(
(
uint16_t
)
sec
=
=
sec
)
;
return
PACK_TWO_SHORTS
(
pri
sec
)
;
}
#
else
#
define
pack_two_shorts
(
pri
sec
)
PACK_TWO_SHORTS
(
pri
sec
)
#
endif
void
S32_opaque_D32_filter_DX
(
const
SkBitmapProcState
&
s
const
uint32_t
xy
[
]
int
count
SkPMColor
colors
[
]
)
;
void
S32_alpha_D32_filter_DX
(
const
SkBitmapProcState
&
s
const
uint32_t
xy
[
]
int
count
SkPMColor
colors
[
]
)
;
void
S32_opaque_D32_filter_DXDY
(
const
SkBitmapProcState
&
s
const
uint32_t
xy
[
]
int
count
SkPMColor
colors
[
]
)
;
void
S32_alpha_D32_filter_DXDY
(
const
SkBitmapProcState
&
s
const
uint32_t
xy
[
]
int
count
SkPMColor
colors
[
]
)
;
void
ClampX_ClampY_filter_scale
(
const
SkBitmapProcState
&
s
uint32_t
xy
[
]
int
count
int
x
int
y
)
;
void
ClampX_ClampY_nofilter_scale
(
const
SkBitmapProcState
&
s
uint32_t
xy
[
]
int
count
int
x
int
y
)
;
void
ClampX_ClampY_filter_affine
(
const
SkBitmapProcState
&
s
uint32_t
xy
[
]
int
count
int
x
int
y
)
;
void
ClampX_ClampY_nofilter_affine
(
const
SkBitmapProcState
&
s
uint32_t
xy
[
]
int
count
int
x
int
y
)
;
class
SkBitmapProcStateAutoMapper
{
public
:
SkBitmapProcStateAutoMapper
(
const
SkBitmapProcState
&
s
int
x
int
y
)
{
SkPoint
pt
;
s
.
fInvProc
(
s
.
fInvMatrix
SkIntToScalar
(
x
)
+
SK_ScalarHalf
SkIntToScalar
(
y
)
+
SK_ScalarHalf
&
pt
)
;
const
SkFixed
biasX
=
(
s
.
fInvMatrix
.
getScaleX
(
)
>
0
)
;
const
SkFixed
biasY
=
(
s
.
fInvMatrix
.
getScaleY
(
)
>
0
)
;
fX
=
SkScalarToFractionalInt
(
pt
.
x
(
)
)
-
SkFixedToFractionalInt
(
biasX
)
;
fY
=
SkScalarToFractionalInt
(
pt
.
y
(
)
)
-
SkFixedToFractionalInt
(
biasY
)
;
}
SkFractionalInt
x
(
)
const
{
return
fX
;
}
SkFractionalInt
y
(
)
const
{
return
fY
;
}
private
:
SkFractionalInt
fX
fY
;
}
;
#
endif
