#
ifndef
SkMessageBus_DEFINED
#
define
SkMessageBus_DEFINED
#
include
"
include
/
core
/
SkTypes
.
h
"
#
include
"
include
/
private
/
SkMutex
.
h
"
#
include
"
include
/
private
/
SkNoncopyable
.
h
"
#
include
"
include
/
private
/
SkOnce
.
h
"
#
include
"
include
/
private
/
SkTArray
.
h
"
#
include
"
include
/
private
/
SkTDArray
.
h
"
template
<
typename
Message
>
class
SkMessageBus
:
SkNoncopyable
{
public
:
static
void
Post
(
const
Message
&
m
)
;
class
Inbox
{
public
:
Inbox
(
uint32_t
uniqueID
=
SK_InvalidUniqueID
)
;
~
Inbox
(
)
;
uint32_t
uniqueID
(
)
const
{
return
fUniqueID
;
}
void
poll
(
SkTArray
<
Message
>
*
out
)
;
private
:
SkTArray
<
Message
>
fMessages
;
SkMutex
fMessagesMutex
;
uint32_t
fUniqueID
;
friend
class
SkMessageBus
;
void
receive
(
const
Message
&
m
)
;
}
;
private
:
SkMessageBus
(
)
;
static
SkMessageBus
*
Get
(
)
;
SkTDArray
<
Inbox
*
>
fInboxes
;
SkMutex
fInboxesMutex
;
}
;
#
define
DECLARE_SKMESSAGEBUS_MESSAGE
(
Message
)
\
template
<
>
\
SkMessageBus
<
Message
>
*
SkMessageBus
<
Message
>
:
:
Get
(
)
{
\
static
SkOnce
once
;
\
static
SkMessageBus
<
Message
>
*
bus
;
\
once
(
[
]
{
bus
=
new
SkMessageBus
<
Message
>
(
)
;
}
)
;
\
return
bus
;
\
}
template
<
typename
Message
>
SkMessageBus
<
Message
>
:
:
Inbox
:
:
Inbox
(
uint32_t
uniqueID
)
:
fUniqueID
(
uniqueID
)
{
SkMessageBus
<
Message
>
*
bus
=
SkMessageBus
<
Message
>
:
:
Get
(
)
;
SkAutoMutexExclusive
lock
(
bus
-
>
fInboxesMutex
)
;
bus
-
>
fInboxes
.
push_back
(
this
)
;
}
template
<
typename
Message
>
SkMessageBus
<
Message
>
:
:
Inbox
:
:
~
Inbox
(
)
{
SkMessageBus
<
Message
>
*
bus
=
SkMessageBus
<
Message
>
:
:
Get
(
)
;
SkAutoMutexExclusive
lock
(
bus
-
>
fInboxesMutex
)
;
for
(
int
i
=
0
;
i
<
bus
-
>
fInboxes
.
count
(
)
;
i
+
+
)
{
if
(
this
=
=
bus
-
>
fInboxes
[
i
]
)
{
bus
-
>
fInboxes
.
removeShuffle
(
i
)
;
break
;
}
}
}
template
<
typename
Message
>
void
SkMessageBus
<
Message
>
:
:
Inbox
:
:
receive
(
const
Message
&
m
)
{
SkAutoMutexExclusive
lock
(
fMessagesMutex
)
;
fMessages
.
push_back
(
m
)
;
}
template
<
typename
Message
>
void
SkMessageBus
<
Message
>
:
:
Inbox
:
:
poll
(
SkTArray
<
Message
>
*
messages
)
{
SkASSERT
(
messages
)
;
messages
-
>
reset
(
)
;
SkAutoMutexExclusive
lock
(
fMessagesMutex
)
;
fMessages
.
swap
(
*
messages
)
;
}
template
<
typename
Message
>
SkMessageBus
<
Message
>
:
:
SkMessageBus
(
)
{
}
template
<
typename
Message
>
void
SkMessageBus
<
Message
>
:
:
Post
(
const
Message
&
m
)
{
SkMessageBus
<
Message
>
*
bus
=
SkMessageBus
<
Message
>
:
:
Get
(
)
;
SkAutoMutexExclusive
lock
(
bus
-
>
fInboxesMutex
)
;
for
(
int
i
=
0
;
i
<
bus
-
>
fInboxes
.
count
(
)
;
i
+
+
)
{
if
(
SkShouldPostMessageToBus
(
m
bus
-
>
fInboxes
[
i
]
-
>
fUniqueID
)
)
{
bus
-
>
fInboxes
[
i
]
-
>
receive
(
m
)
;
}
}
}
#
endif
