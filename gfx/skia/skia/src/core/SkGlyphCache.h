#
ifndef
SkGlyphCache_DEFINED
#
define
SkGlyphCache_DEFINED
#
include
"
SkBitmap
.
h
"
#
include
"
SkChunkAlloc
.
h
"
#
include
"
SkDescriptor
.
h
"
#
include
"
SkGlyph
.
h
"
#
include
"
SkTHash
.
h
"
#
include
"
SkScalerContext
.
h
"
#
include
"
SkTemplates
.
h
"
#
include
"
SkTDArray
.
h
"
class
SkPaint
;
class
SkTraceMemoryDump
;
class
SkGlyphCache_Globals
;
class
SkGlyphCache
{
public
:
const
SkGlyph
&
getUnicharAdvance
(
SkUnichar
)
;
const
SkGlyph
&
getGlyphIDAdvance
(
uint16_t
)
;
const
SkGlyph
&
getUnicharMetrics
(
SkUnichar
)
;
const
SkGlyph
&
getGlyphIDMetrics
(
uint16_t
)
;
const
SkGlyph
&
getUnicharMetrics
(
SkUnichar
SkFixed
x
SkFixed
y
)
;
const
SkGlyph
&
getGlyphIDMetrics
(
uint16_t
SkFixed
x
SkFixed
y
)
;
uint16_t
unicharToGlyph
(
SkUnichar
)
;
SkUnichar
glyphToUnichar
(
uint16_t
)
;
unsigned
getGlyphCount
(
)
const
;
int
countCachedGlyphs
(
)
const
;
const
void
*
findImage
(
const
SkGlyph
&
)
;
const
SkPath
*
findPath
(
const
SkGlyph
&
)
;
const
SkPaint
:
:
FontMetrics
&
getFontMetrics
(
)
const
{
return
fFontMetrics
;
}
const
SkDescriptor
&
getDescriptor
(
)
const
{
return
*
fDesc
;
}
SkMask
:
:
Format
getMaskFormat
(
)
const
{
return
fScalerContext
-
>
getMaskFormat
(
)
;
}
bool
isSubpixel
(
)
const
{
return
fScalerContext
-
>
isSubpixel
(
)
;
}
size_t
getMemoryUsed
(
)
const
{
return
fMemoryUsed
;
}
void
dump
(
)
const
;
bool
getAuxProcData
(
void
(
*
auxProc
)
(
void
*
)
void
*
*
dataPtr
)
const
;
void
setAuxProc
(
void
(
*
auxProc
)
(
void
*
)
void
*
auxData
)
;
SkScalerContext
*
getScalerContext
(
)
const
{
return
fScalerContext
;
}
static
SkGlyphCache
*
VisitCache
(
SkTypeface
*
const
SkDescriptor
*
desc
bool
(
*
proc
)
(
const
SkGlyphCache
*
void
*
)
void
*
context
)
;
static
void
AttachCache
(
SkGlyphCache
*
)
;
static
SkGlyphCache
*
DetachCache
(
SkTypeface
*
typeface
const
SkDescriptor
*
desc
)
{
return
VisitCache
(
typeface
desc
DetachProc
nullptr
)
;
}
static
void
Dump
(
)
;
static
void
DumpMemoryStatistics
(
SkTraceMemoryDump
*
dump
)
;
typedef
void
(
*
Visitor
)
(
const
SkGlyphCache
&
void
*
context
)
;
static
void
VisitAll
(
Visitor
void
*
context
)
;
#
ifdef
SK_DEBUG
void
validate
(
)
const
;
#
else
void
validate
(
)
const
{
}
#
endif
class
AutoValidate
:
SkNoncopyable
{
public
:
AutoValidate
(
const
SkGlyphCache
*
cache
)
:
fCache
(
cache
)
{
if
(
fCache
)
{
fCache
-
>
validate
(
)
;
}
}
~
AutoValidate
(
)
{
if
(
fCache
)
{
fCache
-
>
validate
(
)
;
}
}
void
forget
(
)
{
fCache
=
nullptr
;
}
private
:
const
SkGlyphCache
*
fCache
;
}
;
private
:
friend
class
SkGlyphCache_Globals
;
enum
MetricsType
{
kJustAdvance_MetricsType
kFull_MetricsType
}
;
enum
{
kHashBits
=
8
kHashCount
=
1
<
<
kHashBits
kHashMask
=
kHashCount
-
1
}
;
typedef
uint32_t
PackedGlyphID
;
typedef
uint32_t
PackedUnicharID
;
struct
CharGlyphRec
{
PackedUnicharID
fPackedUnicharID
;
PackedGlyphID
fPackedGlyphID
;
}
;
struct
AuxProcRec
{
AuxProcRec
*
fNext
;
void
(
*
fProc
)
(
void
*
)
;
void
*
fData
;
}
;
SkGlyphCache
(
SkTypeface
*
const
SkDescriptor
*
SkScalerContext
*
)
;
~
SkGlyphCache
(
)
;
SkGlyph
*
lookupByPackedGlyphID
(
PackedGlyphID
packedGlyphID
MetricsType
type
)
;
SkGlyph
*
lookupByChar
(
SkUnichar
id
MetricsType
type
SkFixed
x
=
0
SkFixed
y
=
0
)
;
SkGlyph
*
allocateNewGlyph
(
PackedGlyphID
packedGlyphID
MetricsType
type
)
;
static
bool
DetachProc
(
const
SkGlyphCache
*
void
*
)
{
return
true
;
}
CharGlyphRec
*
getCharGlyphRec
(
PackedUnicharID
id
)
;
void
invokeAndRemoveAuxProcs
(
)
;
inline
static
SkGlyphCache
*
FindTail
(
SkGlyphCache
*
head
)
;
SkGlyphCache
*
fNext
;
SkGlyphCache
*
fPrev
;
SkDescriptor
*
const
fDesc
;
SkScalerContext
*
const
fScalerContext
;
SkPaint
:
:
FontMetrics
fFontMetrics
;
SkTHashTable
<
SkGlyph
PackedGlyphID
SkGlyph
:
:
HashTraits
>
fGlyphMap
;
SkChunkAlloc
fGlyphAlloc
;
SkAutoTArray
<
CharGlyphRec
>
fPackedUnicharIDToPackedGlyphID
;
size_t
fMemoryUsed
;
AuxProcRec
*
fAuxProcList
;
}
;
class
SkAutoGlyphCacheBase
{
public
:
SkGlyphCache
*
getCache
(
)
const
{
return
fCache
;
}
void
release
(
)
{
if
(
fCache
)
{
SkGlyphCache
:
:
AttachCache
(
fCache
)
;
fCache
=
nullptr
;
}
}
protected
:
SkAutoGlyphCacheBase
(
SkGlyphCache
*
cache
)
:
fCache
(
cache
)
{
}
SkAutoGlyphCacheBase
(
SkTypeface
*
typeface
const
SkDescriptor
*
desc
)
{
fCache
=
SkGlyphCache
:
:
DetachCache
(
typeface
desc
)
;
}
SkAutoGlyphCacheBase
(
const
SkPaint
&
const
SkSurfaceProps
*
const
SkMatrix
*
)
{
fCache
=
nullptr
;
}
SkAutoGlyphCacheBase
(
)
{
fCache
=
nullptr
;
}
~
SkAutoGlyphCacheBase
(
)
{
if
(
fCache
)
{
SkGlyphCache
:
:
AttachCache
(
fCache
)
;
}
}
SkGlyphCache
*
fCache
;
private
:
static
bool
DetachProc
(
const
SkGlyphCache
*
void
*
)
;
}
;
class
SkAutoGlyphCache
:
public
SkAutoGlyphCacheBase
{
public
:
SkAutoGlyphCache
(
SkGlyphCache
*
cache
)
:
SkAutoGlyphCacheBase
(
cache
)
{
}
SkAutoGlyphCache
(
SkTypeface
*
typeface
const
SkDescriptor
*
desc
)
:
SkAutoGlyphCacheBase
(
typeface
desc
)
{
}
SkAutoGlyphCache
(
const
SkPaint
&
paint
const
SkSurfaceProps
*
surfaceProps
const
SkMatrix
*
matrix
)
{
fCache
=
paint
.
detachCache
(
surfaceProps
matrix
false
)
;
}
private
:
SkAutoGlyphCache
(
)
:
SkAutoGlyphCacheBase
(
)
{
}
}
;
#
define
SkAutoGlyphCache
(
.
.
.
)
SK_REQUIRE_LOCAL_VAR
(
SkAutoGlyphCache
)
class
SkAutoGlyphCacheNoGamma
:
public
SkAutoGlyphCacheBase
{
public
:
SkAutoGlyphCacheNoGamma
(
SkGlyphCache
*
cache
)
:
SkAutoGlyphCacheBase
(
cache
)
{
}
SkAutoGlyphCacheNoGamma
(
SkTypeface
*
typeface
const
SkDescriptor
*
desc
)
:
SkAutoGlyphCacheBase
(
typeface
desc
)
{
}
SkAutoGlyphCacheNoGamma
(
const
SkPaint
&
paint
const
SkSurfaceProps
*
surfaceProps
const
SkMatrix
*
matrix
)
{
fCache
=
paint
.
detachCache
(
surfaceProps
matrix
true
)
;
}
private
:
SkAutoGlyphCacheNoGamma
(
)
:
SkAutoGlyphCacheBase
(
)
{
}
}
;
#
define
SkAutoGlyphCacheNoGamma
(
.
.
.
)
SK_REQUIRE_LOCAL_VAR
(
SkAutoGlyphCacheNoGamma
)
#
endif
