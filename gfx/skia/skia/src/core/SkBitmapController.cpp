#
include
"
include
/
core
/
SkBitmap
.
h
"
#
include
"
include
/
core
/
SkMatrix
.
h
"
#
include
"
include
/
private
/
SkTemplates
.
h
"
#
include
"
src
/
core
/
SkArenaAlloc
.
h
"
#
include
"
src
/
core
/
SkBitmapCache
.
h
"
#
include
"
src
/
core
/
SkBitmapController
.
h
"
#
include
"
src
/
core
/
SkMatrixPriv
.
h
"
#
include
"
src
/
core
/
SkMipMap
.
h
"
#
include
"
src
/
image
/
SkImage_Base
.
h
"
SkBitmapController
:
:
State
*
SkBitmapController
:
:
RequestBitmap
(
const
SkImage_Base
*
image
const
SkMatrix
&
inv
SkFilterQuality
quality
SkArenaAlloc
*
alloc
)
{
auto
*
state
=
alloc
-
>
make
<
SkBitmapController
:
:
State
>
(
image
inv
quality
)
;
return
state
-
>
pixmap
(
)
.
addr
(
)
?
state
:
nullptr
;
}
bool
SkBitmapController
:
:
State
:
:
processHighRequest
(
const
SkImage_Base
*
image
)
{
if
(
fQuality
!
=
kHigh_SkFilterQuality
)
{
return
false
;
}
if
(
SkMatrixPriv
:
:
AdjustHighQualityFilterLevel
(
fInvMatrix
true
)
!
=
kHigh_SkFilterQuality
)
{
fQuality
=
kMedium_SkFilterQuality
;
return
false
;
}
(
void
)
image
-
>
getROPixels
(
&
fResultBitmap
)
;
return
true
;
}
bool
SkBitmapController
:
:
State
:
:
processMediumRequest
(
const
SkImage_Base
*
image
)
{
SkASSERT
(
fQuality
<
=
kMedium_SkFilterQuality
)
;
if
(
fQuality
!
=
kMedium_SkFilterQuality
)
{
return
false
;
}
fQuality
=
kLow_SkFilterQuality
;
SkSize
invScaleSize
;
if
(
!
fInvMatrix
.
decomposeScale
(
&
invScaleSize
nullptr
)
)
{
return
false
;
}
if
(
invScaleSize
.
width
(
)
>
SK_Scalar1
|
|
invScaleSize
.
height
(
)
>
SK_Scalar1
)
{
fCurrMip
.
reset
(
SkMipMapCache
:
:
FindAndRef
(
SkBitmapCacheDesc
:
:
Make
(
image
)
)
)
;
if
(
nullptr
=
=
fCurrMip
.
get
(
)
)
{
fCurrMip
.
reset
(
SkMipMapCache
:
:
AddAndRef
(
image
)
)
;
if
(
nullptr
=
=
fCurrMip
.
get
(
)
)
{
return
false
;
}
}
SkASSERT_RELEASE
(
fCurrMip
-
>
data
(
)
)
;
const
SkSize
scale
=
SkSize
:
:
Make
(
SkScalarInvert
(
invScaleSize
.
width
(
)
)
SkScalarInvert
(
invScaleSize
.
height
(
)
)
)
;
SkMipMap
:
:
Level
level
;
if
(
fCurrMip
-
>
extractLevel
(
scale
&
level
)
)
{
const
SkSize
&
invScaleFixup
=
level
.
fScale
;
fInvMatrix
.
postScale
(
invScaleFixup
.
width
(
)
invScaleFixup
.
height
(
)
)
;
return
fResultBitmap
.
installPixels
(
level
.
fPixmap
)
;
}
else
{
fCurrMip
.
reset
(
nullptr
)
;
}
}
return
false
;
}
SkBitmapController
:
:
State
:
:
State
(
const
SkImage_Base
*
image
const
SkMatrix
&
inv
SkFilterQuality
qual
)
{
fInvMatrix
=
inv
;
fQuality
=
qual
;
if
(
this
-
>
processHighRequest
(
image
)
|
|
this
-
>
processMediumRequest
(
image
)
)
{
SkASSERT
(
fResultBitmap
.
getPixels
(
)
)
;
}
else
{
(
void
)
image
-
>
getROPixels
(
&
fResultBitmap
)
;
}
fPixmap
.
reset
(
fResultBitmap
.
info
(
)
fResultBitmap
.
getPixels
(
)
fResultBitmap
.
rowBytes
(
)
)
;
}
