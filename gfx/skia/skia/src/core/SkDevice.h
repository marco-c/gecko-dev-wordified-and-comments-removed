#
ifndef
SkDevice_DEFINED
#
define
SkDevice_DEFINED
#
include
"
SkRefCnt
.
h
"
#
include
"
SkCanvas
.
h
"
#
include
"
SkColor
.
h
"
#
include
"
SkRegion
.
h
"
#
include
"
SkSurfaceProps
.
h
"
class
SkBitmap
;
struct
SkDrawShadowRec
;
class
SkGlyphRun
;
class
SkGlyphRunList
;
class
SkImageFilterCache
;
struct
SkIRect
;
class
SkMatrix
;
class
SkRasterHandleAllocator
;
class
SkSpecialImage
;
class
SkBaseDevice
:
public
SkRefCnt
{
public
:
SkBaseDevice
(
const
SkImageInfo
&
const
SkSurfaceProps
&
)
;
const
SkImageInfo
&
imageInfo
(
)
const
{
return
fInfo
;
}
const
SkSurfaceProps
&
surfaceProps
(
)
const
{
return
fSurfaceProps
;
}
void
getGlobalBounds
(
SkIRect
*
bounds
)
const
{
SkASSERT
(
bounds
)
;
const
SkIPoint
&
origin
=
this
-
>
getOrigin
(
)
;
bounds
-
>
setXYWH
(
origin
.
x
(
)
origin
.
y
(
)
this
-
>
width
(
)
this
-
>
height
(
)
)
;
}
SkIRect
getGlobalBounds
(
)
const
{
SkIRect
bounds
;
this
-
>
getGlobalBounds
(
&
bounds
)
;
return
bounds
;
}
int
width
(
)
const
{
return
this
-
>
imageInfo
(
)
.
width
(
)
;
}
int
height
(
)
const
{
return
this
-
>
imageInfo
(
)
.
height
(
)
;
}
bool
isOpaque
(
)
const
{
return
this
-
>
imageInfo
(
)
.
isOpaque
(
)
;
}
bool
writePixels
(
const
SkPixmap
&
int
x
int
y
)
;
bool
accessPixels
(
SkPixmap
*
pmap
)
;
bool
peekPixels
(
SkPixmap
*
)
;
const
SkIPoint
&
getOrigin
(
)
const
{
return
fOrigin
;
}
virtual
void
*
getRasterHandle
(
)
const
{
return
nullptr
;
}
void
save
(
)
{
this
-
>
onSave
(
)
;
}
void
restore
(
const
SkMatrix
&
ctm
)
{
this
-
>
onRestore
(
)
;
this
-
>
setGlobalCTM
(
ctm
)
;
}
void
clipRect
(
const
SkRect
&
rect
SkClipOp
op
bool
aa
)
{
this
-
>
onClipRect
(
rect
op
aa
)
;
}
void
clipRRect
(
const
SkRRect
&
rrect
SkClipOp
op
bool
aa
)
{
this
-
>
onClipRRect
(
rrect
op
aa
)
;
}
void
clipPath
(
const
SkPath
&
path
SkClipOp
op
bool
aa
)
{
this
-
>
onClipPath
(
path
op
aa
)
;
}
void
clipRegion
(
const
SkRegion
&
region
SkClipOp
op
)
{
this
-
>
onClipRegion
(
region
op
)
;
}
void
androidFramework_setDeviceClipRestriction
(
SkIRect
*
mutableClipRestriction
)
{
this
-
>
onSetDeviceClipRestriction
(
mutableClipRestriction
)
;
}
bool
clipIsWideOpen
(
)
const
;
const
SkMatrix
&
ctm
(
)
const
{
return
fCTM
;
}
void
setCTM
(
const
SkMatrix
&
ctm
)
{
fCTM
=
ctm
;
}
void
setGlobalCTM
(
const
SkMatrix
&
ctm
)
;
virtual
void
validateDevBounds
(
const
SkIRect
&
)
{
}
protected
:
enum
TileUsage
{
kPossible_TileUsage
kNever_TileUsage
}
;
struct
TextFlags
{
uint32_t
fFlags
;
}
;
virtual
void
onSave
(
)
{
}
virtual
void
onRestore
(
)
{
}
virtual
void
onClipRect
(
const
SkRect
&
rect
SkClipOp
bool
aa
)
{
}
virtual
void
onClipRRect
(
const
SkRRect
&
rrect
SkClipOp
bool
aa
)
{
}
virtual
void
onClipPath
(
const
SkPath
&
path
SkClipOp
bool
aa
)
{
}
virtual
void
onClipRegion
(
const
SkRegion
&
deviceRgn
SkClipOp
)
{
}
virtual
void
onSetDeviceClipRestriction
(
SkIRect
*
mutableClipRestriction
)
{
}
virtual
bool
onClipIsAA
(
)
const
=
0
;
virtual
void
onAsRgnClip
(
SkRegion
*
)
const
=
0
;
enum
ClipType
{
kEmpty_ClipType
kRect_ClipType
kComplex_ClipType
}
;
virtual
ClipType
onGetClipType
(
)
const
=
0
;
virtual
void
drawPaint
(
const
SkPaint
&
paint
)
=
0
;
virtual
void
drawPoints
(
SkCanvas
:
:
PointMode
mode
size_t
count
const
SkPoint
[
]
const
SkPaint
&
paint
)
=
0
;
virtual
void
drawRect
(
const
SkRect
&
r
const
SkPaint
&
paint
)
=
0
;
virtual
void
drawRegion
(
const
SkRegion
&
r
const
SkPaint
&
paint
)
;
virtual
void
drawOval
(
const
SkRect
&
oval
const
SkPaint
&
paint
)
=
0
;
virtual
void
drawArc
(
const
SkRect
&
oval
SkScalar
startAngle
SkScalar
sweepAngle
bool
useCenter
const
SkPaint
&
paint
)
;
virtual
void
drawRRect
(
const
SkRRect
&
rr
const
SkPaint
&
paint
)
=
0
;
virtual
void
drawDRRect
(
const
SkRRect
&
outer
const
SkRRect
&
inner
const
SkPaint
&
)
;
virtual
void
drawEdgeAARect
(
const
SkRect
&
r
SkCanvas
:
:
QuadAAFlags
aa
SkColor
color
SkBlendMode
mode
)
;
virtual
void
drawPath
(
const
SkPath
&
path
const
SkPaint
&
paint
bool
pathIsMutable
=
false
)
=
0
;
virtual
void
drawSprite
(
const
SkBitmap
&
bitmap
int
x
int
y
const
SkPaint
&
paint
)
=
0
;
virtual
void
drawBitmapRect
(
const
SkBitmap
&
const
SkRect
*
srcOrNull
const
SkRect
&
dst
const
SkPaint
&
paint
SkCanvas
:
:
SrcRectConstraint
)
=
0
;
virtual
void
drawBitmapNine
(
const
SkBitmap
&
const
SkIRect
&
center
const
SkRect
&
dst
const
SkPaint
&
)
;
virtual
void
drawBitmapLattice
(
const
SkBitmap
&
const
SkCanvas
:
:
Lattice
&
const
SkRect
&
dst
const
SkPaint
&
)
;
virtual
void
drawImageRect
(
const
SkImage
*
const
SkRect
*
src
const
SkRect
&
dst
const
SkPaint
&
SkCanvas
:
:
SrcRectConstraint
)
;
virtual
void
drawImageNine
(
const
SkImage
*
const
SkIRect
&
center
const
SkRect
&
dst
const
SkPaint
&
)
;
virtual
void
drawImageLattice
(
const
SkImage
*
const
SkCanvas
:
:
Lattice
&
const
SkRect
&
dst
const
SkPaint
&
)
;
virtual
void
drawImageSet
(
const
SkCanvas
:
:
ImageSetEntry
[
]
int
count
SkFilterQuality
SkBlendMode
)
;
virtual
void
drawVertices
(
const
SkVertices
*
const
SkVertices
:
:
Bone
bones
[
]
int
boneCount
SkBlendMode
const
SkPaint
&
)
=
0
;
virtual
void
drawShadow
(
const
SkPath
&
const
SkDrawShadowRec
&
)
;
virtual
void
drawGlyphRunList
(
const
SkGlyphRunList
&
glyphRunList
)
=
0
;
virtual
void
drawPatch
(
const
SkPoint
cubics
[
12
]
const
SkColor
colors
[
4
]
const
SkPoint
texCoords
[
4
]
SkBlendMode
const
SkPaint
&
paint
)
;
virtual
void
drawAtlas
(
const
SkImage
*
atlas
const
SkRSXform
[
]
const
SkRect
[
]
const
SkColor
[
]
int
count
SkBlendMode
const
SkPaint
&
)
;
virtual
void
drawAnnotation
(
const
SkRect
&
const
char
[
]
SkData
*
)
{
}
virtual
void
drawDevice
(
SkBaseDevice
*
int
x
int
y
const
SkPaint
&
)
=
0
;
void
drawGlyphRunRSXform
(
const
SkFont
&
const
SkGlyphID
[
]
const
SkRSXform
[
]
int
count
SkPoint
origin
const
SkPaint
&
paint
)
;
virtual
void
drawDrawable
(
SkDrawable
*
const
SkMatrix
*
SkCanvas
*
)
;
virtual
void
drawSpecial
(
SkSpecialImage
*
int
x
int
y
const
SkPaint
&
SkImage
*
clipImage
const
SkMatrix
&
clipMatrix
)
;
virtual
sk_sp
<
SkSpecialImage
>
makeSpecial
(
const
SkBitmap
&
)
;
virtual
sk_sp
<
SkSpecialImage
>
makeSpecial
(
const
SkImage
*
)
;
virtual
sk_sp
<
SkSpecialImage
>
snapSpecial
(
)
;
virtual
void
setImmutable
(
)
{
}
bool
readPixels
(
const
SkPixmap
&
int
x
int
y
)
;
virtual
sk_sp
<
SkSpecialImage
>
snapBackImage
(
const
SkIRect
&
)
;
virtual
GrContext
*
context
(
)
const
{
return
nullptr
;
}
virtual
sk_sp
<
SkSurface
>
makeSurface
(
const
SkImageInfo
&
const
SkSurfaceProps
&
)
;
virtual
bool
onPeekPixels
(
SkPixmap
*
)
{
return
false
;
}
virtual
bool
onReadPixels
(
const
SkPixmap
&
int
x
int
y
)
;
virtual
bool
onWritePixels
(
const
SkPixmap
&
int
x
int
y
)
;
virtual
bool
onAccessPixels
(
SkPixmap
*
)
{
return
false
;
}
struct
CreateInfo
{
static
SkPixelGeometry
AdjustGeometry
(
const
SkImageInfo
&
TileUsage
SkPixelGeometry
bool
preserveLCDText
)
;
CreateInfo
(
const
SkImageInfo
&
info
TileUsage
tileUsage
SkPixelGeometry
geo
)
:
fInfo
(
info
)
fTileUsage
(
tileUsage
)
fPixelGeometry
(
AdjustGeometry
(
info
tileUsage
geo
false
)
)
{
}
CreateInfo
(
const
SkImageInfo
&
info
TileUsage
tileUsage
SkPixelGeometry
geo
bool
preserveLCDText
bool
trackCoverage
SkRasterHandleAllocator
*
allocator
)
:
fInfo
(
info
)
fTileUsage
(
tileUsage
)
fPixelGeometry
(
AdjustGeometry
(
info
tileUsage
geo
preserveLCDText
)
)
fTrackCoverage
(
trackCoverage
)
fAllocator
(
allocator
)
{
}
const
SkImageInfo
fInfo
;
const
TileUsage
fTileUsage
;
const
SkPixelGeometry
fPixelGeometry
;
const
bool
fTrackCoverage
=
false
;
SkRasterHandleAllocator
*
fAllocator
=
nullptr
;
}
;
virtual
SkBaseDevice
*
onCreateDevice
(
const
CreateInfo
&
const
SkPaint
*
)
{
return
nullptr
;
}
static
void
LogDrawScaleFactor
(
const
SkMatrix
&
view
const
SkMatrix
&
srcToDst
SkFilterQuality
)
;
private
:
friend
class
SkAndroidFrameworkUtils
;
friend
class
SkCanvas
;
friend
struct
DeviceCM
;
friend
class
SkDraw
;
friend
class
SkDrawIter
;
friend
class
SkSurface_Raster
;
friend
class
DeviceTestingAccess
;
friend
class
SkGlyphRun
;
friend
class
SkGlyphRunList
;
friend
class
SkGlyphRunBuilder
;
friend
class
ClipTileRenderer
;
virtual
void
replaceBitmapBackendForRasterSurface
(
const
SkBitmap
&
)
{
}
virtual
bool
forceConservativeRasterClip
(
)
const
{
return
false
;
}
virtual
GrRenderTargetContext
*
accessRenderTargetContext
(
)
{
return
nullptr
;
}
void
setOrigin
(
const
SkMatrix
&
ctm
int
x
int
y
)
;
virtual
void
flush
(
)
{
}
virtual
SkImageFilterCache
*
getImageFilterCache
(
)
{
return
nullptr
;
}
friend
class
SkNoPixelsDevice
;
friend
class
SkBitmapDevice
;
void
privateResize
(
int
w
int
h
)
{
*
const_cast
<
SkImageInfo
*
>
(
&
fInfo
)
=
fInfo
.
makeWH
(
w
h
)
;
}
SkIPoint
fOrigin
;
const
SkImageInfo
fInfo
;
const
SkSurfaceProps
fSurfaceProps
;
SkMatrix
fCTM
;
typedef
SkRefCnt
INHERITED
;
}
;
class
SkNoPixelsDevice
:
public
SkBaseDevice
{
public
:
SkNoPixelsDevice
(
const
SkIRect
&
bounds
const
SkSurfaceProps
&
props
sk_sp
<
SkColorSpace
>
colorSpace
=
nullptr
)
:
SkBaseDevice
(
SkImageInfo
:
:
Make
(
bounds
.
width
(
)
bounds
.
height
(
)
kUnknown_SkColorType
kUnknown_SkAlphaType
std
:
:
move
(
colorSpace
)
)
props
)
{
}
void
resetForNextPicture
(
const
SkIRect
&
bounds
)
{
this
-
>
privateResize
(
bounds
.
width
(
)
bounds
.
height
(
)
)
;
}
protected
:
void
onSave
(
)
override
{
}
void
onRestore
(
)
override
{
}
void
onClipRect
(
const
SkRect
&
rect
SkClipOp
bool
aa
)
override
{
}
void
onClipRRect
(
const
SkRRect
&
rrect
SkClipOp
bool
aa
)
override
{
}
void
onClipPath
(
const
SkPath
&
path
SkClipOp
bool
aa
)
override
{
}
void
onClipRegion
(
const
SkRegion
&
deviceRgn
SkClipOp
)
override
{
}
void
onSetDeviceClipRestriction
(
SkIRect
*
mutableClipRestriction
)
override
{
}
bool
onClipIsAA
(
)
const
override
{
return
false
;
}
void
onAsRgnClip
(
SkRegion
*
rgn
)
const
override
{
rgn
-
>
setRect
(
SkIRect
:
:
MakeWH
(
this
-
>
width
(
)
this
-
>
height
(
)
)
)
;
}
ClipType
onGetClipType
(
)
const
override
{
return
kRect_ClipType
;
}
void
drawPaint
(
const
SkPaint
&
paint
)
override
{
}
void
drawPoints
(
SkCanvas
:
:
PointMode
size_t
const
SkPoint
[
]
const
SkPaint
&
)
override
{
}
void
drawRect
(
const
SkRect
&
const
SkPaint
&
)
override
{
}
void
drawOval
(
const
SkRect
&
const
SkPaint
&
)
override
{
}
void
drawRRect
(
const
SkRRect
&
const
SkPaint
&
)
override
{
}
void
drawPath
(
const
SkPath
&
const
SkPaint
&
bool
)
override
{
}
void
drawSprite
(
const
SkBitmap
&
int
int
const
SkPaint
&
)
override
{
}
void
drawBitmapRect
(
const
SkBitmap
&
const
SkRect
*
const
SkRect
&
const
SkPaint
&
SkCanvas
:
:
SrcRectConstraint
)
override
{
}
void
drawDevice
(
SkBaseDevice
*
int
int
const
SkPaint
&
)
override
{
}
void
drawGlyphRunList
(
const
SkGlyphRunList
&
glyphRunList
)
override
{
}
void
drawVertices
(
const
SkVertices
*
const
SkVertices
:
:
Bone
[
]
int
SkBlendMode
const
SkPaint
&
)
override
{
}
private
:
typedef
SkBaseDevice
INHERITED
;
}
;
class
SkAutoDeviceCTMRestore
:
SkNoncopyable
{
public
:
SkAutoDeviceCTMRestore
(
SkBaseDevice
*
device
const
SkMatrix
&
ctm
)
:
fDevice
(
device
)
fPrevCTM
(
device
-
>
ctm
(
)
)
{
fDevice
-
>
setCTM
(
ctm
)
;
}
~
SkAutoDeviceCTMRestore
(
)
{
fDevice
-
>
setCTM
(
fPrevCTM
)
;
}
private
:
SkBaseDevice
*
fDevice
;
const
SkMatrix
fPrevCTM
;
}
;
#
endif
