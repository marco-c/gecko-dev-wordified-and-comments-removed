#
ifndef
SkPDFTypes_DEFINED
#
define
SkPDFTypes_DEFINED
#
include
"
SkRefCnt
.
h
"
#
include
"
SkScalar
.
h
"
#
include
"
SkStream
.
h
"
#
include
"
SkString
.
h
"
#
include
"
SkTDArray
.
h
"
#
include
"
SkTHash
.
h
"
#
include
"
SkTypes
.
h
"
class
SkPDFObjNumMap
;
class
SkPDFObject
;
class
SkPDFSubstituteMap
;
#
ifdef
SK_PDF_IMAGE_STATS
#
include
"
SkAtomics
.
h
"
#
endif
class
SkPDFObject
:
public
SkRefCnt
{
public
:
virtual
void
emitObject
(
SkWStream
*
stream
const
SkPDFObjNumMap
&
objNumMap
const
SkPDFSubstituteMap
&
substitutes
)
const
=
0
;
virtual
void
addResources
(
SkPDFObjNumMap
*
catalog
const
SkPDFSubstituteMap
&
substitutes
)
const
{
}
virtual
void
drop
(
)
{
}
virtual
~
SkPDFObject
(
)
{
}
private
:
typedef
SkRefCnt
INHERITED
;
}
;
class
SkPDFUnion
{
public
:
SkPDFUnion
(
SkPDFUnion
&
&
other
)
;
SkPDFUnion
&
operator
=
(
SkPDFUnion
&
&
other
)
;
~
SkPDFUnion
(
)
;
static
SkPDFUnion
Int
(
int32_t
)
;
static
SkPDFUnion
Int
(
size_t
v
)
{
return
SkPDFUnion
:
:
Int
(
SkToS32
(
v
)
)
;
}
static
SkPDFUnion
Bool
(
bool
)
;
static
SkPDFUnion
Scalar
(
SkScalar
)
;
static
SkPDFUnion
Name
(
const
char
*
)
;
static
SkPDFUnion
String
(
const
char
*
)
;
static
SkPDFUnion
Name
(
const
SkString
&
)
;
static
SkPDFUnion
String
(
const
SkString
&
)
;
static
SkPDFUnion
Object
(
sk_sp
<
SkPDFObject
>
)
;
static
SkPDFUnion
ObjRef
(
sk_sp
<
SkPDFObject
>
)
;
void
emitObject
(
SkWStream
*
const
SkPDFObjNumMap
&
const
SkPDFSubstituteMap
&
)
const
;
void
addResources
(
SkPDFObjNumMap
*
const
SkPDFSubstituteMap
&
)
const
;
bool
isName
(
)
const
;
private
:
union
{
int32_t
fIntValue
;
bool
fBoolValue
;
SkScalar
fScalarValue
;
const
char
*
fStaticString
;
char
fSkString
[
sizeof
(
SkString
)
]
;
SkPDFObject
*
fObject
;
}
;
enum
class
Type
:
char
{
kDestroyed
=
0
kInt
kBool
kScalar
kName
kString
kNameSkS
kStringSkS
kObjRef
kObject
}
;
Type
fType
;
SkPDFUnion
(
Type
)
;
SkPDFUnion
&
operator
=
(
const
SkPDFUnion
&
)
=
delete
;
SkPDFUnion
(
const
SkPDFUnion
&
)
=
delete
;
}
;
static_assert
(
sizeof
(
SkString
)
=
=
sizeof
(
void
*
)
"
SkString_size
"
)
;
#
if
0
class
SkPDFAtom
final
:
public
SkPDFObject
{
public
:
void
emitObject
(
SkWStream
*
stream
const
SkPDFObjNumMap
&
objNumMap
const
SkPDFSubstituteMap
&
substitutes
)
final
;
void
addResources
(
SkPDFObjNumMap
*
const
SkPDFSubstituteMap
&
)
const
final
;
SkPDFAtom
(
SkPDFUnion
&
&
v
)
:
fValue
(
std
:
:
move
(
v
)
{
}
private
:
const
SkPDFUnion
fValue
;
typedef
SkPDFObject
INHERITED
;
}
;
#
endif
class
SkPDFArray
final
:
public
SkPDFObject
{
public
:
SkPDFArray
(
)
;
virtual
~
SkPDFArray
(
)
;
void
emitObject
(
SkWStream
*
stream
const
SkPDFObjNumMap
&
objNumMap
const
SkPDFSubstituteMap
&
substitutes
)
const
override
;
void
addResources
(
SkPDFObjNumMap
*
const
SkPDFSubstituteMap
&
)
const
override
;
void
drop
(
)
override
;
int
size
(
)
const
;
void
reserve
(
int
length
)
;
void
appendInt
(
int32_t
)
;
void
appendBool
(
bool
)
;
void
appendScalar
(
SkScalar
)
;
void
appendName
(
const
char
[
]
)
;
void
appendName
(
const
SkString
&
)
;
void
appendString
(
const
char
[
]
)
;
void
appendString
(
const
SkString
&
)
;
void
appendObject
(
sk_sp
<
SkPDFObject
>
)
;
void
appendObjRef
(
sk_sp
<
SkPDFObject
>
)
;
private
:
SkTArray
<
SkPDFUnion
>
fValues
;
void
append
(
SkPDFUnion
&
&
value
)
;
SkDEBUGCODE
(
bool
fDumped
;
)
}
;
class
SkPDFDict
:
public
SkPDFObject
{
public
:
explicit
SkPDFDict
(
const
char
type
[
]
=
nullptr
)
;
virtual
~
SkPDFDict
(
)
;
void
emitObject
(
SkWStream
*
stream
const
SkPDFObjNumMap
&
objNumMap
const
SkPDFSubstituteMap
&
substitutes
)
const
override
;
void
addResources
(
SkPDFObjNumMap
*
const
SkPDFSubstituteMap
&
)
const
override
;
void
drop
(
)
override
;
int
size
(
)
const
;
void
insertObject
(
const
char
key
[
]
sk_sp
<
SkPDFObject
>
)
;
void
insertObject
(
const
SkString
&
key
sk_sp
<
SkPDFObject
>
)
;
void
insertObjRef
(
const
char
key
[
]
sk_sp
<
SkPDFObject
>
)
;
void
insertObjRef
(
const
SkString
&
key
sk_sp
<
SkPDFObject
>
)
;
void
insertBool
(
const
char
key
[
]
bool
value
)
;
void
insertInt
(
const
char
key
[
]
int32_t
value
)
;
void
insertInt
(
const
char
key
[
]
size_t
value
)
;
void
insertScalar
(
const
char
key
[
]
SkScalar
value
)
;
void
insertName
(
const
char
key
[
]
const
char
nameValue
[
]
)
;
void
insertName
(
const
char
key
[
]
const
SkString
&
nameValue
)
;
void
insertString
(
const
char
key
[
]
const
char
value
[
]
)
;
void
insertString
(
const
char
key
[
]
const
SkString
&
value
)
;
void
emitAll
(
SkWStream
*
stream
const
SkPDFObjNumMap
&
objNumMap
const
SkPDFSubstituteMap
&
substitutes
)
const
;
private
:
struct
Record
{
SkPDFUnion
fKey
;
SkPDFUnion
fValue
;
Record
(
SkPDFUnion
&
&
SkPDFUnion
&
&
)
;
Record
(
Record
&
&
)
;
Record
&
operator
=
(
Record
&
&
)
;
Record
(
const
Record
&
)
=
delete
;
Record
&
operator
=
(
const
Record
&
)
=
delete
;
}
;
SkTArray
<
Record
>
fRecords
;
SkDEBUGCODE
(
bool
fDumped
;
)
}
;
class
SkPDFSharedStream
final
:
public
SkPDFObject
{
public
:
SkPDFSharedStream
(
SkStreamAsset
*
data
)
;
~
SkPDFSharedStream
(
)
;
SkPDFDict
*
dict
(
)
{
return
fDict
.
get
(
)
;
}
void
emitObject
(
SkWStream
*
const
SkPDFObjNumMap
&
const
SkPDFSubstituteMap
&
)
const
override
;
void
addResources
(
SkPDFObjNumMap
*
const
SkPDFSubstituteMap
&
)
const
override
;
void
drop
(
)
override
;
private
:
std
:
:
unique_ptr
<
SkStreamAsset
>
fAsset
;
sk_sp
<
SkPDFDict
>
fDict
;
SkDEBUGCODE
(
bool
fDumped
;
)
typedef
SkPDFObject
INHERITED
;
}
;
class
SkPDFObjNumMap
:
SkNoncopyable
{
public
:
bool
addObject
(
SkPDFObject
*
obj
)
;
void
addObjectRecursively
(
SkPDFObject
*
obj
const
SkPDFSubstituteMap
&
subs
)
;
int32_t
getObjectNumber
(
SkPDFObject
*
obj
)
const
;
const
SkTArray
<
sk_sp
<
SkPDFObject
>
>
&
objects
(
)
const
{
return
fObjects
;
}
private
:
SkTArray
<
sk_sp
<
SkPDFObject
>
>
fObjects
;
SkTHashMap
<
SkPDFObject
*
int32_t
>
fObjectNumbers
;
}
;
class
SkPDFSubstituteMap
:
SkNoncopyable
{
public
:
~
SkPDFSubstituteMap
(
)
;
void
setSubstitute
(
SkPDFObject
*
original
SkPDFObject
*
substitute
)
;
SkPDFObject
*
getSubstitute
(
SkPDFObject
*
object
)
const
;
SkPDFObject
*
operator
(
)
(
SkPDFObject
*
o
)
const
{
return
this
-
>
getSubstitute
(
o
)
;
}
private
:
SkTHashMap
<
SkPDFObject
*
SkPDFObject
*
>
fSubstituteMap
;
}
;
#
ifdef
SK_PDF_IMAGE_STATS
extern
SkAtomic
<
int
>
gDrawImageCalls
;
extern
SkAtomic
<
int
>
gJpegImageObjects
;
extern
SkAtomic
<
int
>
gRegularImageObjects
;
extern
void
SkPDFImageDumpStats
(
)
;
#
endif
#
endif
