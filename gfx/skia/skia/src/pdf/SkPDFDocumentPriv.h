#
ifndef
SkPDFDocumentPriv_DEFINED
#
define
SkPDFDocumentPriv_DEFINED
#
include
"
include
/
core
/
SkCanvas
.
h
"
#
include
"
include
/
core
/
SkStream
.
h
"
#
include
"
include
/
docs
/
SkPDFDocument
.
h
"
#
include
"
include
/
private
/
base
/
SkMutex
.
h
"
#
include
"
src
/
core
/
SkTHash
.
h
"
#
include
"
src
/
pdf
/
SkPDFBitmap
.
h
"
#
include
"
src
/
pdf
/
SkPDFGraphicState
.
h
"
#
include
"
src
/
pdf
/
SkPDFMetadata
.
h
"
#
include
"
src
/
pdf
/
SkPDFShader
.
h
"
#
include
"
src
/
pdf
/
SkPDFTag
.
h
"
#
include
<
atomic
>
#
include
<
vector
>
#
include
<
memory
>
class
SkExecutor
;
class
SkPDFDevice
;
class
SkPDFFont
;
struct
SkAdvancedTypefaceMetrics
;
struct
SkBitmapKey
;
namespace
SkPDFGradientShader
{
struct
Key
;
struct
KeyHash
;
}
const
char
*
SkPDFGetNodeIdKey
(
)
;
class
SkPDFOffsetMap
{
public
:
void
markStartOfDocument
(
const
SkWStream
*
)
;
void
markStartOfObject
(
int
referenceNumber
const
SkWStream
*
)
;
int
objectCount
(
)
const
;
int
emitCrossReferenceTable
(
SkWStream
*
s
)
const
;
private
:
std
:
:
vector
<
int
>
fOffsets
;
size_t
fBaseOffset
=
SIZE_MAX
;
}
;
struct
SkPDFNamedDestination
{
sk_sp
<
SkData
>
fName
;
SkPoint
fPoint
;
SkPDFIndirectReference
fPage
;
}
;
struct
SkPDFLink
{
enum
class
Type
{
kNone
kUrl
kNamedDestination
}
;
SkPDFLink
(
Type
type
SkData
*
data
const
SkRect
&
rect
int
nodeId
)
:
fType
(
type
)
fData
(
sk_ref_sp
(
data
)
)
fRect
(
rect
)
fNodeId
(
nodeId
)
{
}
const
Type
fType
;
const
sk_sp
<
SkData
>
fData
;
const
SkRect
fRect
;
const
int
fNodeId
;
}
;
class
SkPDFDocument
:
public
SkDocument
{
public
:
SkPDFDocument
(
SkWStream
*
SkPDF
:
:
Metadata
)
;
~
SkPDFDocument
(
)
override
;
SkCanvas
*
onBeginPage
(
SkScalar
SkScalar
)
override
;
void
onEndPage
(
)
override
;
void
onClose
(
SkWStream
*
)
override
;
void
onAbort
(
)
override
;
SkPDFIndirectReference
emit
(
const
SkPDFObject
&
SkPDFIndirectReference
)
;
SkPDFIndirectReference
emit
(
const
SkPDFObject
&
o
)
{
return
this
-
>
emit
(
o
this
-
>
reserveRef
(
)
)
;
}
template
<
typename
T
>
void
emitStream
(
const
SkPDFDict
&
dict
T
writeStream
SkPDFIndirectReference
ref
)
{
SkAutoMutexExclusive
lock
(
fMutex
)
;
SkWStream
*
stream
=
this
-
>
beginObject
(
ref
)
;
dict
.
emitObject
(
stream
)
;
stream
-
>
writeText
(
"
stream
\
n
"
)
;
writeStream
(
stream
)
;
stream
-
>
writeText
(
"
\
nendstream
"
)
;
this
-
>
endObject
(
)
;
}
const
SkPDF
:
:
Metadata
&
metadata
(
)
const
{
return
fMetadata
;
}
SkPDFIndirectReference
getPage
(
size_t
pageIndex
)
const
;
bool
hasCurrentPage
(
)
const
{
return
bool
(
fPageDevice
)
;
}
SkPDFIndirectReference
currentPage
(
)
const
{
return
SkASSERT
(
this
-
>
hasCurrentPage
(
)
&
&
!
fPageRefs
.
empty
(
)
)
fPageRefs
.
back
(
)
;
}
SkPDFTagTree
:
:
Mark
createMarkIdForNodeId
(
int
nodeId
SkPoint
)
;
int
createStructParentKeyForNodeId
(
int
nodeId
)
;
void
addNodeTitle
(
int
nodeId
SkSpan
<
const
char
>
)
;
std
:
:
unique_ptr
<
SkPDFArray
>
getAnnotations
(
)
;
SkPDFIndirectReference
reserveRef
(
)
{
return
SkPDFIndirectReference
{
fNextObjectNumber
+
+
}
;
}
SkString
nextFontSubsetTag
(
)
;
SkExecutor
*
executor
(
)
const
{
return
fExecutor
;
}
void
incrementJobCount
(
)
;
void
signalJobComplete
(
)
;
size_t
currentPageIndex
(
)
{
return
fPages
.
size
(
)
;
}
size_t
pageCount
(
)
{
return
fPageRefs
.
size
(
)
;
}
const
SkMatrix
&
currentPageTransform
(
)
const
;
skia_private
:
:
THashMap
<
SkPDFImageShaderKey
SkPDFIndirectReference
SkPDFImageShaderKey
:
:
Hash
>
fImageShaderMap
;
skia_private
:
:
THashMap
<
SkPDFGradientShader
:
:
Key
SkPDFIndirectReference
SkPDFGradientShader
:
:
KeyHash
>
fGradientPatternMap
;
skia_private
:
:
THashMap
<
SkBitmapKey
SkPDFIndirectReference
>
fPDFBitmapMap
;
skia_private
:
:
THashMap
<
SkPDFIccProfileKey
SkPDFIndirectReference
SkPDFIccProfileKey
:
:
Hash
>
fICCProfileMap
;
skia_private
:
:
THashMap
<
uint32_t
std
:
:
unique_ptr
<
SkAdvancedTypefaceMetrics
>
>
fTypefaceMetrics
;
skia_private
:
:
THashMap
<
uint32_t
std
:
:
vector
<
SkString
>
>
fType1GlyphNames
;
skia_private
:
:
THashMap
<
uint32_t
std
:
:
vector
<
SkUnichar
>
>
fToUnicodeMap
;
skia_private
:
:
THashMap
<
uint32_t
SkPDFIndirectReference
>
fFontDescriptors
;
skia_private
:
:
THashMap
<
uint32_t
SkPDFIndirectReference
>
fType3FontDescriptors
;
skia_private
:
:
THashMap
<
uint64_t
SkPDFFont
>
fFontMap
;
skia_private
:
:
THashMap
<
SkPDFStrokeGraphicState
SkPDFIndirectReference
SkPDFStrokeGraphicState
:
:
Hash
>
fStrokeGSMap
;
skia_private
:
:
THashMap
<
SkPDFFillGraphicState
SkPDFIndirectReference
SkPDFFillGraphicState
:
:
Hash
>
fFillGSMap
;
SkPDFIndirectReference
fInvertFunction
;
SkPDFIndirectReference
fNoSmaskGraphicState
;
std
:
:
vector
<
std
:
:
unique_ptr
<
SkPDFLink
>
>
fCurrentPageLinks
;
std
:
:
vector
<
SkPDFNamedDestination
>
fNamedDestinations
;
private
:
SkPDFOffsetMap
fOffsetMap
;
SkCanvas
fCanvas
;
std
:
:
vector
<
std
:
:
unique_ptr
<
SkPDFDict
>
>
fPages
;
std
:
:
vector
<
SkPDFIndirectReference
>
fPageRefs
;
sk_sp
<
SkPDFDevice
>
fPageDevice
;
std
:
:
atomic
<
int
>
fNextObjectNumber
=
{
1
}
;
std
:
:
atomic
<
int
>
fJobCount
=
{
0
}
;
uint32_t
fNextFontSubsetTag
=
{
0
}
;
SkUUID
fUUID
;
SkPDFIndirectReference
fInfoDict
;
SkPDFIndirectReference
fXMP
;
SkPDF
:
:
Metadata
fMetadata
;
SkScalar
fRasterScale
=
1
;
SkScalar
fInverseRasterScale
=
1
;
SkExecutor
*
fExecutor
=
nullptr
;
SkPDFTagTree
fTagTree
;
SkMutex
fMutex
;
SkSemaphore
fSemaphore
;
void
waitForJobs
(
)
;
SkWStream
*
beginObject
(
SkPDFIndirectReference
)
;
void
endObject
(
)
;
}
;
#
endif
