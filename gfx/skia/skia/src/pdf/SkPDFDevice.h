#
ifndef
SkPDFDevice_DEFINED
#
define
SkPDFDevice_DEFINED
#
include
"
SkBitmap
.
h
"
#
include
"
SkBitmapKey
.
h
"
#
include
"
SkCanvas
.
h
"
#
include
"
SkClipStack
.
h
"
#
include
"
SkData
.
h
"
#
include
"
SkDevice
.
h
"
#
include
"
SkPaint
.
h
"
#
include
"
SkPath
.
h
"
#
include
"
SkPicture
.
h
"
#
include
"
SkRect
.
h
"
#
include
"
SkRefCnt
.
h
"
#
include
"
SkStream
.
h
"
#
include
"
SkTDArray
.
h
"
#
include
"
SkTemplates
.
h
"
#
include
"
SkSinglyLinkedList
.
h
"
class
SkPDFArray
;
class
SkPDFCanon
;
class
SkPDFDevice
;
class
SkPDFDocument
;
class
SkPDFDict
;
class
SkPDFFont
;
class
SkPDFFormXObject
;
class
SkPDFGlyphSetMap
;
class
SkPDFGraphicState
;
class
SkPDFObject
;
class
SkPDFShader
;
class
SkPDFStream
;
class
SkRRect
;
class
SkPDFDevice
final
:
public
SkBaseDevice
{
public
:
static
SkPDFDevice
*
Create
(
SkISize
pageSize
SkScalar
rasterDpi
SkPDFDocument
*
doc
)
{
return
new
SkPDFDevice
(
pageSize
rasterDpi
doc
true
)
;
}
static
SkPDFDevice
*
CreateUnflipped
(
SkISize
pageSize
SkScalar
rasterDpi
SkPDFDocument
*
doc
)
{
return
new
SkPDFDevice
(
pageSize
rasterDpi
doc
false
)
;
}
virtual
~
SkPDFDevice
(
)
;
void
drawPaint
(
const
SkDraw
&
const
SkPaint
&
paint
)
override
;
void
drawPoints
(
const
SkDraw
&
SkCanvas
:
:
PointMode
mode
size_t
count
const
SkPoint
[
]
const
SkPaint
&
paint
)
override
;
void
drawRect
(
const
SkDraw
&
const
SkRect
&
r
const
SkPaint
&
paint
)
override
;
void
drawOval
(
const
SkDraw
&
const
SkRect
&
oval
const
SkPaint
&
paint
)
override
;
void
drawRRect
(
const
SkDraw
&
const
SkRRect
&
rr
const
SkPaint
&
paint
)
override
;
void
drawPath
(
const
SkDraw
&
const
SkPath
&
origpath
const
SkPaint
&
paint
const
SkMatrix
*
prePathMatrix
bool
pathIsMutable
)
override
;
void
drawBitmapRect
(
const
SkDraw
&
draw
const
SkBitmap
&
bitmap
const
SkRect
*
src
const
SkRect
&
dst
const
SkPaint
&
SkCanvas
:
:
SrcRectConstraint
)
override
;
void
drawBitmap
(
const
SkDraw
&
const
SkBitmap
&
bitmap
const
SkMatrix
&
matrix
const
SkPaint
&
)
override
;
void
drawSprite
(
const
SkDraw
&
const
SkBitmap
&
bitmap
int
x
int
y
const
SkPaint
&
paint
)
override
;
void
drawImage
(
const
SkDraw
&
const
SkImage
*
SkScalar
x
SkScalar
y
const
SkPaint
&
)
override
;
void
drawImageRect
(
const
SkDraw
&
const
SkImage
*
const
SkRect
*
src
const
SkRect
&
dst
const
SkPaint
&
SkCanvas
:
:
SrcRectConstraint
)
override
;
void
drawText
(
const
SkDraw
&
const
void
*
text
size_t
len
SkScalar
x
SkScalar
y
const
SkPaint
&
)
override
;
void
drawPosText
(
const
SkDraw
&
const
void
*
text
size_t
len
const
SkScalar
pos
[
]
int
scalarsPerPos
const
SkPoint
&
offset
const
SkPaint
&
)
override
;
void
drawVertices
(
const
SkDraw
&
SkCanvas
:
:
VertexMode
int
vertexCount
const
SkPoint
verts
[
]
const
SkPoint
texs
[
]
const
SkColor
colors
[
]
SkXfermode
*
xmode
const
uint16_t
indices
[
]
int
indexCount
const
SkPaint
&
paint
)
override
;
void
drawDevice
(
const
SkDraw
&
SkBaseDevice
*
int
x
int
y
const
SkPaint
&
)
override
;
void
onAttachToCanvas
(
SkCanvas
*
canvas
)
override
;
void
onDetachFromCanvas
(
)
override
;
SkImageInfo
imageInfo
(
)
const
override
;
sk_sp
<
SkPDFDict
>
makeResourceDict
(
)
const
;
const
SkTDArray
<
SkPDFFont
*
>
&
getFontResources
(
)
const
;
void
appendAnnotations
(
SkPDFArray
*
array
)
const
;
void
appendDestinations
(
SkPDFDict
*
dict
SkPDFObject
*
page
)
const
;
sk_sp
<
SkPDFArray
>
copyMediaBox
(
)
const
;
std
:
:
unique_ptr
<
SkStreamAsset
>
content
(
)
const
;
void
writeContent
(
SkWStream
*
)
const
;
const
SkMatrix
&
initialTransform
(
)
const
{
return
fInitialTransform
;
}
const
SkPDFGlyphSetMap
&
getFontGlyphUsage
(
)
const
{
return
*
(
fFontGlyphUsage
.
get
(
)
)
;
}
SkPDFCanon
*
getCanon
(
)
const
;
struct
GraphicStateEntry
{
GraphicStateEntry
(
)
;
bool
compareInitialState
(
const
GraphicStateEntry
&
b
)
;
SkMatrix
fMatrix
;
SkClipStack
fClipStack
;
SkRegion
fClipRegion
;
SkColor
fColor
;
SkScalar
fTextScaleX
;
SkPaint
:
:
Style
fTextFill
;
int
fShaderIndex
;
int
fGraphicStateIndex
;
SkPDFFont
*
fFont
;
SkScalar
fTextSize
;
}
;
protected
:
const
SkBitmap
&
onAccessBitmap
(
)
override
{
return
fLegacyBitmap
;
}
sk_sp
<
SkSurface
>
makeSurface
(
const
SkImageInfo
&
const
SkSurfaceProps
&
)
override
;
void
drawAnnotation
(
const
SkDraw
&
const
SkRect
&
const
char
key
[
]
SkData
*
value
)
override
;
private
:
struct
RectWithData
{
SkRect
rect
;
sk_sp
<
SkData
>
data
;
RectWithData
(
const
SkRect
&
rect
SkData
*
data
)
:
rect
(
rect
)
data
(
SkRef
(
data
)
)
{
}
RectWithData
(
RectWithData
&
&
other
)
:
rect
(
other
.
rect
)
data
(
std
:
:
move
(
other
.
data
)
)
{
}
RectWithData
&
operator
=
(
RectWithData
&
&
other
)
{
rect
=
other
.
rect
;
data
=
std
:
:
move
(
other
.
data
)
;
return
*
this
;
}
}
;
struct
NamedDestination
{
sk_sp
<
SkData
>
nameData
;
SkPoint
point
;
NamedDestination
(
SkData
*
nameData
const
SkPoint
&
point
)
:
nameData
(
SkRef
(
nameData
)
)
point
(
point
)
{
}
NamedDestination
(
NamedDestination
&
&
other
)
:
nameData
(
std
:
:
move
(
other
.
nameData
)
)
point
(
other
.
point
)
{
}
NamedDestination
&
operator
=
(
NamedDestination
&
&
other
)
{
nameData
=
std
:
:
move
(
other
.
nameData
)
;
point
=
other
.
point
;
return
*
this
;
}
}
;
friend
class
ScopedContentEntry
;
SkISize
fPageSize
;
SkISize
fContentSize
;
SkMatrix
fInitialTransform
;
SkClipStack
fExistingClipStack
;
SkRegion
fExistingClipRegion
;
SkTArray
<
RectWithData
>
fLinkToURLs
;
SkTArray
<
RectWithData
>
fLinkToDestinations
;
SkTArray
<
NamedDestination
>
fNamedDestinations
;
SkTDArray
<
SkPDFObject
*
>
fGraphicStateResources
;
SkTDArray
<
SkPDFObject
*
>
fXObjectResources
;
SkTDArray
<
SkPDFFont
*
>
fFontResources
;
SkTDArray
<
SkPDFObject
*
>
fShaderResources
;
struct
ContentEntry
{
GraphicStateEntry
fState
;
SkDynamicMemoryWStream
fContent
;
}
;
SkSinglyLinkedList
<
ContentEntry
>
fContentEntries
;
const
SkClipStack
*
fClipStack
;
std
:
:
unique_ptr
<
SkPDFGlyphSetMap
>
fFontGlyphUsage
;
SkScalar
fRasterDpi
;
SkBitmap
fLegacyBitmap
;
SkPDFDocument
*
fDocument
;
SkPDFDevice
(
SkISize
pageSize
SkScalar
rasterDpi
SkPDFDocument
*
doc
bool
flip
)
;
SkBaseDevice
*
onCreateDevice
(
const
CreateInfo
&
const
SkPaint
*
)
override
;
void
init
(
)
;
void
cleanUp
(
bool
clearFontUsage
)
;
SkPDFFormXObject
*
createFormXObjectFromDevice
(
)
;
void
drawFormXObjectWithMask
(
int
xObjectIndex
SkPDFFormXObject
*
mask
const
SkClipStack
*
clipStack
const
SkRegion
&
clipRegion
SkXfermode
:
:
Mode
mode
bool
invertClip
)
;
ContentEntry
*
setUpContentEntry
(
const
SkClipStack
*
clipStack
const
SkRegion
&
clipRegion
const
SkMatrix
&
matrix
const
SkPaint
&
paint
bool
hasText
SkPDFFormXObject
*
*
dst
)
;
void
finishContentEntry
(
SkXfermode
:
:
Mode
xfermode
SkPDFFormXObject
*
dst
SkPath
*
shape
)
;
bool
isContentEmpty
(
)
;
void
populateGraphicStateEntryFromPaint
(
const
SkMatrix
&
matrix
const
SkClipStack
&
clipStack
const
SkRegion
&
clipRegion
const
SkPaint
&
paint
bool
hasText
GraphicStateEntry
*
entry
)
;
int
addGraphicStateResource
(
SkPDFObject
*
gs
)
;
int
addXObjectResource
(
SkPDFObject
*
xObject
)
;
void
updateFont
(
const
SkPaint
&
paint
uint16_t
glyphID
ContentEntry
*
contentEntry
)
;
int
getFontResourceIndex
(
SkTypeface
*
typeface
uint16_t
glyphID
)
;
void
internalDrawPaint
(
const
SkPaint
&
paint
ContentEntry
*
contentEntry
)
;
void
internalDrawImage
(
const
SkMatrix
&
origMatrix
const
SkClipStack
*
clipStack
const
SkRegion
&
origClipRegion
SkImageBitmap
imageBitmap
const
SkPaint
&
paint
)
;
bool
handleInversePath
(
const
SkDraw
&
d
const
SkPath
&
origPath
const
SkPaint
&
paint
bool
pathIsMutable
const
SkMatrix
*
prePathMatrix
=
nullptr
)
;
void
handlePointAnnotation
(
const
SkPoint
&
const
SkMatrix
&
const
char
key
[
]
SkData
*
value
)
;
void
handlePathAnnotation
(
const
SkPath
&
const
SkDraw
&
d
const
char
key
[
]
SkData
*
value
)
;
typedef
SkBaseDevice
INHERITED
;
}
;
#
endif
