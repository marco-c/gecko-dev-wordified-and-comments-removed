#
ifndef
SkPixelRef_DEFINED
#
define
SkPixelRef_DEFINED
#
include
"
.
.
/
private
/
SkAtomics
.
h
"
#
include
"
SkBitmap
.
h
"
#
include
"
SkFilterQuality
.
h
"
#
include
"
SkImageInfo
.
h
"
#
include
"
.
.
/
private
/
SkMutex
.
h
"
#
include
"
SkPixmap
.
h
"
#
include
"
SkRefCnt
.
h
"
#
include
"
SkSize
.
h
"
#
include
"
SkString
.
h
"
#
include
"
SkTDArray
.
h
"
class
SkColorTable
;
class
SkData
;
struct
SkIRect
;
class
GrTexture
;
class
SkDiscardableMemory
;
class
SK_API
SkPixelRef
:
public
SkRefCnt
{
public
:
explicit
SkPixelRef
(
const
SkImageInfo
&
)
;
virtual
~
SkPixelRef
(
)
;
const
SkImageInfo
&
info
(
)
const
{
return
fInfo
;
}
void
*
pixels
(
)
const
{
return
fRec
.
fPixels
;
}
SkColorTable
*
colorTable
(
)
const
{
return
fRec
.
fColorTable
;
}
size_t
rowBytes
(
)
const
{
return
fRec
.
fRowBytes
;
}
struct
LockRec
{
LockRec
(
)
:
fPixels
(
NULL
)
fColorTable
(
NULL
)
{
}
void
*
fPixels
;
SkColorTable
*
fColorTable
;
size_t
fRowBytes
;
void
zero
(
)
{
sk_bzero
(
this
sizeof
(
*
this
)
)
;
}
bool
isZero
(
)
const
{
return
NULL
=
=
fPixels
&
&
NULL
=
=
fColorTable
&
&
0
=
=
fRowBytes
;
}
}
;
SkDEBUGCODE
(
bool
isLocked
(
)
const
{
return
fLockCount
>
0
;
}
)
SkDEBUGCODE
(
int
getLockCount
(
)
const
{
return
fLockCount
;
}
)
bool
lockPixels
(
)
;
bool
lockPixels
(
LockRec
*
rec
)
;
void
unlockPixels
(
)
;
bool
lockPixelsAreWritable
(
)
const
;
uint32_t
getGenerationID
(
)
const
;
#
ifdef
SK_BUILD_FOR_ANDROID_FRAMEWORK
uint32_t
getStableID
(
)
const
{
return
fStableID
;
}
#
endif
void
notifyPixelsChanged
(
)
;
void
changeAlphaType
(
SkAlphaType
at
)
;
bool
isImmutable
(
)
const
{
return
fMutability
!
=
kMutable
;
}
void
setImmutable
(
)
;
const
char
*
getURI
(
)
const
{
return
fURI
.
size
(
)
?
fURI
.
c_str
(
)
:
NULL
;
}
void
setURI
(
const
char
uri
[
]
)
{
fURI
.
set
(
uri
)
;
}
void
setURI
(
const
char
uri
[
]
size_t
len
)
{
fURI
.
set
(
uri
len
)
;
}
void
setURI
(
const
SkString
&
uri
)
{
fURI
=
uri
;
}
SkData
*
refEncodedData
(
)
{
return
this
-
>
onRefEncodedData
(
)
;
}
struct
LockRequest
{
SkISize
fSize
;
SkFilterQuality
fQuality
;
}
;
struct
LockResult
{
LockResult
(
)
:
fPixels
(
NULL
)
fCTable
(
NULL
)
{
}
void
(
*
fUnlockProc
)
(
void
*
ctx
)
;
void
*
fUnlockContext
;
const
void
*
fPixels
;
SkColorTable
*
fCTable
;
size_t
fRowBytes
;
SkISize
fSize
;
void
unlock
(
)
{
if
(
fUnlockProc
)
{
fUnlockProc
(
fUnlockContext
)
;
fUnlockProc
=
NULL
;
}
}
}
;
bool
requestLock
(
const
LockRequest
&
LockResult
*
)
;
virtual
GrTexture
*
getTexture
(
)
{
return
NULL
;
}
bool
getYUV8Planes
(
SkISize
sizes
[
3
]
void
*
planes
[
3
]
size_t
rowBytes
[
3
]
SkYUVColorSpace
*
colorSpace
)
{
return
this
-
>
onGetYUV8Planes
(
sizes
planes
rowBytes
colorSpace
)
;
}
bool
readPixels
(
SkBitmap
*
dst
SkColorType
colorType
const
SkIRect
*
subset
=
NULL
)
;
virtual
SkPixelRef
*
deepCopy
(
SkColorType
SkColorProfileType
const
SkIRect
*
)
{
return
NULL
;
}
struct
GenIDChangeListener
{
virtual
~
GenIDChangeListener
(
)
{
}
virtual
void
onChange
(
)
=
0
;
}
;
void
addGenIDChangeListener
(
GenIDChangeListener
*
listener
)
;
void
notifyAddedToCache
(
)
{
fAddedToCache
.
store
(
true
)
;
}
virtual
SkDiscardableMemory
*
diagnostic_only_getDiscardable
(
)
const
{
return
NULL
;
}
bool
isLazyGenerated
(
)
const
{
return
this
-
>
onIsLazyGenerated
(
)
;
}
protected
:
virtual
bool
onNewLockPixels
(
LockRec
*
)
=
0
;
virtual
void
onUnlockPixels
(
)
=
0
;
virtual
bool
onLockPixelsAreWritable
(
)
const
;
virtual
bool
onReadPixels
(
SkBitmap
*
dst
SkColorType
colorType
const
SkIRect
*
subsetOrNull
)
;
virtual
SkData
*
onRefEncodedData
(
)
;
virtual
void
onNotifyPixelsChanged
(
)
;
virtual
bool
onGetYUV8Planes
(
SkISize
sizes
[
3
]
void
*
planes
[
3
]
size_t
rowBytes
[
3
]
SkYUVColorSpace
*
colorSpace
)
;
virtual
size_t
getAllocatedSizeInBytes
(
)
const
;
virtual
bool
onRequestLock
(
const
LockRequest
&
LockResult
*
)
;
virtual
bool
onIsLazyGenerated
(
)
const
{
return
false
;
}
SkBaseMutex
*
mutex
(
)
const
{
return
&
fMutex
;
}
void
setPreLocked
(
void
*
size_t
rowBytes
SkColorTable
*
)
;
private
:
mutable
SkMutex
fMutex
;
const
SkImageInfo
fInfo
;
LockRec
fRec
;
int
fLockCount
;
bool
lockPixelsInsideMutex
(
)
;
bool
genIDIsUnique
(
)
const
{
return
SkToBool
(
fTaggedGenID
.
load
(
)
&
1
)
;
}
mutable
SkAtomic
<
uint32_t
>
fTaggedGenID
;
#
ifdef
SK_BUILD_FOR_ANDROID_FRAMEWORK
const
uint32_t
fStableID
;
#
endif
SkTDArray
<
GenIDChangeListener
*
>
fGenIDChangeListeners
;
SkString
fURI
;
SkAtomic
<
bool
>
fAddedToCache
;
enum
{
kMutable
kTemporarilyImmutable
kImmutable
}
fMutability
:
8
;
bool
fPreLocked
;
void
needsNewGenID
(
)
;
void
callGenIDChangeListeners
(
)
;
void
setTemporarilyImmutable
(
)
;
void
restoreMutability
(
)
;
friend
class
SkSurface_Raster
;
bool
isPreLocked
(
)
const
{
return
fPreLocked
;
}
friend
class
SkImage_Raster
;
friend
class
SkBitmap
;
void
cloneGenID
(
const
SkPixelRef
&
)
;
void
setImmutableWithID
(
uint32_t
genID
)
;
friend
class
SkImage_Gpu
;
friend
class
SkImageCacherator
;
typedef
SkRefCnt
INHERITED
;
}
;
class
SkPixelRefFactory
:
public
SkRefCnt
{
public
:
virtual
SkPixelRef
*
create
(
const
SkImageInfo
&
size_t
rowBytes
SkColorTable
*
)
=
0
;
}
;
#
endif
