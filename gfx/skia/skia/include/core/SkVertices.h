#
ifndef
SkVertices_DEFINED
#
define
SkVertices_DEFINED
#
include
"
SkColor
.
h
"
#
include
"
SkData
.
h
"
#
include
"
SkPoint
.
h
"
#
include
"
SkRect
.
h
"
#
include
"
SkRefCnt
.
h
"
class
SK_API
SkVertices
:
public
SkNVRefCnt
<
SkVertices
>
{
public
:
struct
BoneIndices
{
uint32_t
indices
[
4
]
;
uint32_t
&
operator
[
]
(
int
i
)
{
SkASSERT
(
i
>
=
0
)
;
SkASSERT
(
i
<
4
)
;
return
indices
[
i
]
;
}
const
uint32_t
&
operator
[
]
(
int
i
)
const
{
SkASSERT
(
i
>
=
0
)
;
SkASSERT
(
i
<
4
)
;
return
indices
[
i
]
;
}
}
;
struct
BoneWeights
{
float
weights
[
4
]
;
float
&
operator
[
]
(
int
i
)
{
SkASSERT
(
i
>
=
0
)
;
SkASSERT
(
i
<
4
)
;
return
weights
[
i
]
;
}
const
float
&
operator
[
]
(
int
i
)
const
{
SkASSERT
(
i
>
=
0
)
;
SkASSERT
(
i
<
4
)
;
return
weights
[
i
]
;
}
}
;
struct
Bone
{
float
values
[
6
]
;
float
&
operator
[
]
(
int
i
)
{
SkASSERT
(
i
>
=
0
)
;
SkASSERT
(
i
<
6
)
;
return
values
[
i
]
;
}
const
float
&
operator
[
]
(
int
i
)
const
{
SkASSERT
(
i
>
=
0
)
;
SkASSERT
(
i
<
6
)
;
return
values
[
i
]
;
}
SkPoint
mapPoint
(
const
SkPoint
&
point
)
const
{
float
x
=
values
[
0
]
*
point
.
x
(
)
+
values
[
2
]
*
point
.
y
(
)
+
values
[
4
]
;
float
y
=
values
[
1
]
*
point
.
x
(
)
+
values
[
3
]
*
point
.
y
(
)
+
values
[
5
]
;
return
SkPoint
:
:
Make
(
x
y
)
;
}
SkRect
mapRect
(
const
SkRect
&
rect
)
const
{
SkRect
dst
=
SkRect
:
:
MakeEmpty
(
)
;
SkPoint
quad
[
4
]
;
rect
.
toQuad
(
quad
)
;
for
(
int
i
=
0
;
i
<
4
;
i
+
+
)
{
quad
[
i
]
=
mapPoint
(
quad
[
i
]
)
;
}
dst
.
setBoundsNoCheck
(
quad
4
)
;
return
dst
;
}
}
;
enum
VertexMode
{
kTriangles_VertexMode
kTriangleStrip_VertexMode
kTriangleFan_VertexMode
kLast_VertexMode
=
kTriangleFan_VertexMode
}
;
static
sk_sp
<
SkVertices
>
MakeCopy
(
VertexMode
mode
int
vertexCount
const
SkPoint
positions
[
]
const
SkPoint
texs
[
]
const
SkColor
colors
[
]
const
BoneIndices
boneIndices
[
]
const
BoneWeights
boneWeights
[
]
int
indexCount
const
uint16_t
indices
[
]
bool
isVolatile
=
true
)
;
static
sk_sp
<
SkVertices
>
MakeCopy
(
VertexMode
mode
int
vertexCount
const
SkPoint
positions
[
]
const
SkPoint
texs
[
]
const
SkColor
colors
[
]
const
BoneIndices
boneIndices
[
]
const
BoneWeights
boneWeights
[
]
bool
isVolatile
=
true
)
{
return
MakeCopy
(
mode
vertexCount
positions
texs
colors
boneIndices
boneWeights
0
nullptr
isVolatile
)
;
}
static
sk_sp
<
SkVertices
>
MakeCopy
(
VertexMode
mode
int
vertexCount
const
SkPoint
positions
[
]
const
SkPoint
texs
[
]
const
SkColor
colors
[
]
int
indexCount
const
uint16_t
indices
[
]
bool
isVolatile
=
true
)
{
return
MakeCopy
(
mode
vertexCount
positions
texs
colors
nullptr
nullptr
indexCount
indices
isVolatile
)
;
}
static
sk_sp
<
SkVertices
>
MakeCopy
(
VertexMode
mode
int
vertexCount
const
SkPoint
positions
[
]
const
SkPoint
texs
[
]
const
SkColor
colors
[
]
bool
isVolatile
=
true
)
{
return
MakeCopy
(
mode
vertexCount
positions
texs
colors
nullptr
nullptr
isVolatile
)
;
}
struct
Sizes
;
enum
BuilderFlags
{
kHasTexCoords_BuilderFlag
=
1
<
<
0
kHasColors_BuilderFlag
=
1
<
<
1
kHasBones_BuilderFlag
=
1
<
<
2
kIsNonVolatile_BuilderFlag
=
1
<
<
3
}
;
class
Builder
{
public
:
Builder
(
VertexMode
mode
int
vertexCount
int
indexCount
uint32_t
flags
)
;
bool
isValid
(
)
const
{
return
fVertices
!
=
nullptr
;
}
int
vertexCount
(
)
const
;
int
indexCount
(
)
const
;
bool
isVolatile
(
)
const
;
SkPoint
*
positions
(
)
;
SkPoint
*
texCoords
(
)
;
SkColor
*
colors
(
)
;
BoneIndices
*
boneIndices
(
)
;
BoneWeights
*
boneWeights
(
)
;
uint16_t
*
indices
(
)
;
sk_sp
<
SkVertices
>
detach
(
)
;
private
:
Builder
(
VertexMode
mode
int
vertexCount
int
indexCount
bool
isVolatile
const
Sizes
&
)
;
void
init
(
VertexMode
mode
int
vertexCount
int
indexCount
bool
isVolatile
const
Sizes
&
)
;
sk_sp
<
SkVertices
>
fVertices
;
std
:
:
unique_ptr
<
uint8_t
[
]
>
fIntermediateFanIndices
;
friend
class
SkVertices
;
}
;
uint32_t
uniqueID
(
)
const
{
return
fUniqueID
;
}
VertexMode
mode
(
)
const
{
return
fMode
;
}
const
SkRect
&
bounds
(
)
const
{
return
fBounds
;
}
bool
hasColors
(
)
const
{
return
SkToBool
(
this
-
>
colors
(
)
)
;
}
bool
hasTexCoords
(
)
const
{
return
SkToBool
(
this
-
>
texCoords
(
)
)
;
}
bool
hasBones
(
)
const
{
return
SkToBool
(
this
-
>
boneIndices
(
)
)
;
}
bool
hasIndices
(
)
const
{
return
SkToBool
(
this
-
>
indices
(
)
)
;
}
int
vertexCount
(
)
const
{
return
fVertexCnt
;
}
const
SkPoint
*
positions
(
)
const
{
return
fPositions
;
}
const
SkPoint
*
texCoords
(
)
const
{
return
fTexs
;
}
const
SkColor
*
colors
(
)
const
{
return
fColors
;
}
const
BoneIndices
*
boneIndices
(
)
const
{
return
fBoneIndices
;
}
const
BoneWeights
*
boneWeights
(
)
const
{
return
fBoneWeights
;
}
int
indexCount
(
)
const
{
return
fIndexCnt
;
}
const
uint16_t
*
indices
(
)
const
{
return
fIndices
;
}
bool
isVolatile
(
)
const
{
return
fIsVolatile
;
}
sk_sp
<
SkVertices
>
applyBones
(
const
Bone
bones
[
]
int
boneCount
)
const
;
size_t
approximateSize
(
)
const
;
static
sk_sp
<
SkVertices
>
Decode
(
const
void
*
buffer
size_t
length
)
;
sk_sp
<
SkData
>
encode
(
)
const
;
private
:
SkVertices
(
)
{
}
friend
class
SkNVRefCnt
<
SkVertices
>
;
void
operator
delete
(
void
*
p
)
;
static
sk_sp
<
SkVertices
>
Alloc
(
int
vCount
int
iCount
uint32_t
builderFlags
size_t
*
arraySize
)
;
uint32_t
fUniqueID
;
SkPoint
*
fPositions
;
SkPoint
*
fTexs
;
SkColor
*
fColors
;
BoneIndices
*
fBoneIndices
;
BoneWeights
*
fBoneWeights
;
uint16_t
*
fIndices
;
SkRect
fBounds
;
int
fVertexCnt
;
int
fIndexCnt
;
bool
fIsVolatile
;
VertexMode
fMode
;
}
;
#
endif
