#
ifndef
SkCanvas_DEFINED
#
define
SkCanvas_DEFINED
#
include
"
SkTypes
.
h
"
#
include
"
SkBitmap
.
h
"
#
include
"
SkDeque
.
h
"
#
include
"
SkPaint
.
h
"
#
include
"
SkRefCnt
.
h
"
#
include
"
SkRegion
.
h
"
#
include
"
SkSurfaceProps
.
h
"
#
include
"
SkXfermode
.
h
"
class
GrContext
;
class
GrRenderTarget
;
class
SkBaseDevice
;
class
SkCanvasClipVisitor
;
class
SkClipStack
;
class
SkDraw
;
class
SkDrawable
;
class
SkDrawFilter
;
class
SkImage
;
class
SkImageFilter
;
class
SkMetaData
;
class
SkPath
;
class
SkPicture
;
class
SkPixmap
;
class
SkRRect
;
struct
SkRSXform
;
class
SkSurface
;
class
SkSurface_Base
;
class
SkTextBlob
;
#
ifdef
SK_SUPPORT_LEGACY_CLIPTOLAYERFLAG
#
ifndef
SK_SUPPORT_LEGACY_SAVEFLAGS
#
define
SK_SUPPORT_LEGACY_SAVEFLAGS
#
endif
#
endif
class
SK_API
SkCanvas
:
public
SkRefCnt
{
enum
PrivateSaveLayerFlags
{
kDontClipToLayer_PrivateSaveLayerFlag
=
1
<
<
31
}
;
public
:
static
SkCanvas
*
NewRasterDirect
(
const
SkImageInfo
&
void
*
size_t
)
;
static
SkCanvas
*
NewRasterDirectN32
(
int
width
int
height
SkPMColor
*
pixels
size_t
rowBytes
)
{
return
NewRasterDirect
(
SkImageInfo
:
:
MakeN32Premul
(
width
height
)
pixels
rowBytes
)
;
}
SkCanvas
(
)
;
SkCanvas
(
int
width
int
height
const
SkSurfaceProps
*
=
NULL
)
;
explicit
SkCanvas
(
SkBaseDevice
*
device
)
;
explicit
SkCanvas
(
const
SkBitmap
&
bitmap
)
;
SkCanvas
(
const
SkBitmap
&
bitmap
const
SkSurfaceProps
&
props
)
;
virtual
~
SkCanvas
(
)
;
SkMetaData
&
getMetaData
(
)
;
SkImageInfo
imageInfo
(
)
const
;
void
flush
(
)
;
virtual
SkISize
getBaseLayerSize
(
)
const
;
SkISize
getDeviceSize
(
)
const
{
return
this
-
>
getBaseLayerSize
(
)
;
}
#
ifndef
SK_SUPPORT_LEGACY_GETDEVICE
protected
:
#
endif
SkBaseDevice
*
getDevice
(
)
const
;
public
:
SkBaseDevice
*
getDevice_just_for_deprecated_compatibility_testing
(
)
const
{
return
this
-
>
getDevice
(
)
;
}
#
ifndef
SK_SUPPORT_LEGACY_GETTOPDEVICE
private
:
#
endif
SkBaseDevice
*
getTopDevice
(
bool
updateMatrixClip
=
false
)
const
;
public
:
SkSurface
*
newSurface
(
const
SkImageInfo
&
const
SkSurfaceProps
*
=
NULL
)
;
GrContext
*
getGrContext
(
)
;
void
*
accessTopLayerPixels
(
SkImageInfo
*
info
size_t
*
rowBytes
SkIPoint
*
origin
=
NULL
)
;
const
void
*
peekPixels
(
SkImageInfo
*
info
size_t
*
rowBytes
)
;
bool
readPixels
(
const
SkImageInfo
&
dstInfo
void
*
dstPixels
size_t
dstRowBytes
int
srcX
int
srcY
)
;
bool
readPixels
(
SkBitmap
*
bitmap
int
srcX
int
srcY
)
;
bool
readPixels
(
const
SkIRect
&
srcRect
SkBitmap
*
bitmap
)
;
bool
writePixels
(
const
SkImageInfo
&
const
void
*
pixels
size_t
rowBytes
int
x
int
y
)
;
bool
writePixels
(
const
SkBitmap
&
bitmap
int
x
int
y
)
;
#
ifdef
SK_SUPPORT_LEGACY_SAVEFLAGS
enum
SaveFlags
{
kMatrix_SaveFlag
=
0x01
kClip_SaveFlag
=
0x02
kHasAlphaLayer_SaveFlag
=
0x04
kFullColorLayer_SaveFlag
=
0x08
kClipToLayer_SaveFlag
=
0x10
kMatrixClip_SaveFlag
=
0x03
#
ifdef
SK_SUPPORT_LEGACY_CLIPTOLAYERFLAG
kARGB_NoClipLayer_SaveFlag
=
0x0F
#
endif
kARGB_ClipLayer_SaveFlag
=
0x1F
}
;
#
endif
int
save
(
)
;
int
saveLayer
(
const
SkRect
*
bounds
const
SkPaint
*
paint
)
;
int
saveLayer
(
const
SkRect
&
bounds
const
SkPaint
*
paint
)
{
return
this
-
>
saveLayer
(
&
bounds
paint
)
;
}
int
saveLayerPreserveLCDTextRequests
(
const
SkRect
*
bounds
const
SkPaint
*
paint
)
;
#
ifdef
SK_SUPPORT_LEGACY_SAVEFLAGS
SK_ATTR_EXTERNALLY_DEPRECATED
(
"
SaveFlags
use
is
deprecated
"
)
int
saveLayer
(
const
SkRect
*
bounds
const
SkPaint
*
paint
SaveFlags
flags
)
;
#
endif
int
saveLayerAlpha
(
const
SkRect
*
bounds
U8CPU
alpha
)
;
#
ifdef
SK_SUPPORT_LEGACY_SAVEFLAGS
SK_ATTR_EXTERNALLY_DEPRECATED
(
"
SaveFlags
use
is
deprecated
"
)
int
saveLayerAlpha
(
const
SkRect
*
bounds
U8CPU
alpha
SaveFlags
flags
)
;
#
endif
enum
{
kIsOpaque_SaveLayerFlag
=
1
<
<
0
kPreserveLCDText_SaveLayerFlag
=
1
<
<
1
#
ifdef
SK_SUPPORT_LEGACY_CLIPTOLAYERFLAG
kDontClipToLayer_Legacy_SaveLayerFlag
=
kDontClipToLayer_PrivateSaveLayerFlag
#
endif
}
;
typedef
uint32_t
SaveLayerFlags
;
struct
SaveLayerRec
{
SaveLayerRec
(
)
:
fBounds
(
nullptr
)
fPaint
(
nullptr
)
fBackdrop
(
nullptr
)
fSaveLayerFlags
(
0
)
{
}
SaveLayerRec
(
const
SkRect
*
bounds
const
SkPaint
*
paint
SaveLayerFlags
saveLayerFlags
=
0
)
:
fBounds
(
bounds
)
fPaint
(
paint
)
fBackdrop
(
nullptr
)
fSaveLayerFlags
(
saveLayerFlags
)
{
}
SaveLayerRec
(
const
SkRect
*
bounds
const
SkPaint
*
paint
const
SkImageFilter
*
backdrop
SaveLayerFlags
saveLayerFlags
)
:
fBounds
(
bounds
)
fPaint
(
paint
)
fBackdrop
(
backdrop
)
fSaveLayerFlags
(
saveLayerFlags
)
{
}
const
SkRect
*
fBounds
;
const
SkPaint
*
fPaint
;
const
SkImageFilter
*
fBackdrop
;
SaveLayerFlags
fSaveLayerFlags
;
}
;
int
saveLayer
(
const
SaveLayerRec
&
)
;
void
restore
(
)
;
int
getSaveCount
(
)
const
;
void
restoreToCount
(
int
saveCount
)
;
void
translate
(
SkScalar
dx
SkScalar
dy
)
;
void
scale
(
SkScalar
sx
SkScalar
sy
)
;
void
rotate
(
SkScalar
degrees
)
;
void
skew
(
SkScalar
sx
SkScalar
sy
)
;
void
concat
(
const
SkMatrix
&
matrix
)
;
void
setMatrix
(
const
SkMatrix
&
matrix
)
;
void
resetMatrix
(
)
;
void
clipRect
(
const
SkRect
&
rect
SkRegion
:
:
Op
op
=
SkRegion
:
:
kIntersect_Op
bool
doAntiAlias
=
false
)
;
void
clipRRect
(
const
SkRRect
&
rrect
SkRegion
:
:
Op
op
=
SkRegion
:
:
kIntersect_Op
bool
doAntiAlias
=
false
)
;
void
clipPath
(
const
SkPath
&
path
SkRegion
:
:
Op
op
=
SkRegion
:
:
kIntersect_Op
bool
doAntiAlias
=
false
)
;
void
setAllowSoftClip
(
bool
allow
)
{
fAllowSoftClip
=
allow
;
}
void
setAllowSimplifyClip
(
bool
allow
)
{
fAllowSimplifyClip
=
allow
;
}
void
clipRegion
(
const
SkRegion
&
deviceRgn
SkRegion
:
:
Op
op
=
SkRegion
:
:
kIntersect_Op
)
;
void
setClipRegion
(
const
SkRegion
&
deviceRgn
)
{
this
-
>
clipRegion
(
deviceRgn
SkRegion
:
:
kReplace_Op
)
;
}
bool
quickReject
(
const
SkRect
&
rect
)
const
;
bool
quickReject
(
const
SkPath
&
path
)
const
;
bool
quickRejectY
(
SkScalar
top
SkScalar
bottom
)
const
{
SkASSERT
(
top
<
=
bottom
)
;
#
ifndef
SK_WILL_NEVER_DRAW_PERSPECTIVE_TEXT
if
(
this
-
>
getTotalMatrix
(
)
.
hasPerspective
(
)
)
{
return
false
;
}
#
endif
const
SkRect
&
clipR
=
this
-
>
getLocalClipBounds
(
)
;
return
top
>
=
clipR
.
fBottom
|
|
bottom
<
=
clipR
.
fTop
;
}
virtual
bool
getClipBounds
(
SkRect
*
bounds
)
const
;
virtual
bool
getClipDeviceBounds
(
SkIRect
*
bounds
)
const
;
void
drawARGB
(
U8CPU
a
U8CPU
r
U8CPU
g
U8CPU
b
SkXfermode
:
:
Mode
mode
=
SkXfermode
:
:
kSrcOver_Mode
)
;
void
drawColor
(
SkColor
color
SkXfermode
:
:
Mode
mode
=
SkXfermode
:
:
kSrcOver_Mode
)
;
void
clear
(
SkColor
color
)
{
this
-
>
drawColor
(
color
SkXfermode
:
:
kSrc_Mode
)
;
}
void
discard
(
)
{
this
-
>
onDiscard
(
)
;
}
void
drawPaint
(
const
SkPaint
&
paint
)
;
enum
PointMode
{
kPoints_PointMode
kLines_PointMode
kPolygon_PointMode
}
;
void
drawPoints
(
PointMode
mode
size_t
count
const
SkPoint
pts
[
]
const
SkPaint
&
paint
)
;
void
drawPoint
(
SkScalar
x
SkScalar
y
const
SkPaint
&
paint
)
;
void
drawPoint
(
SkScalar
x
SkScalar
y
SkColor
color
)
;
void
drawLine
(
SkScalar
x0
SkScalar
y0
SkScalar
x1
SkScalar
y1
const
SkPaint
&
paint
)
;
void
drawRect
(
const
SkRect
&
rect
const
SkPaint
&
paint
)
;
void
drawIRect
(
const
SkIRect
&
rect
const
SkPaint
&
paint
)
{
SkRect
r
;
r
.
set
(
rect
)
;
this
-
>
drawRect
(
r
paint
)
;
}
void
drawRectCoords
(
SkScalar
left
SkScalar
top
SkScalar
right
SkScalar
bottom
const
SkPaint
&
paint
)
;
void
drawOval
(
const
SkRect
&
oval
const
SkPaint
&
)
;
void
drawRRect
(
const
SkRRect
&
rrect
const
SkPaint
&
paint
)
;
void
drawDRRect
(
const
SkRRect
&
outer
const
SkRRect
&
inner
const
SkPaint
&
)
;
void
drawCircle
(
SkScalar
cx
SkScalar
cy
SkScalar
radius
const
SkPaint
&
paint
)
;
void
drawArc
(
const
SkRect
&
oval
SkScalar
startAngle
SkScalar
sweepAngle
bool
useCenter
const
SkPaint
&
paint
)
;
void
drawRoundRect
(
const
SkRect
&
rect
SkScalar
rx
SkScalar
ry
const
SkPaint
&
paint
)
;
void
drawPath
(
const
SkPath
&
path
const
SkPaint
&
paint
)
;
void
drawImage
(
const
SkImage
*
image
SkScalar
left
SkScalar
top
const
SkPaint
*
paint
=
NULL
)
;
enum
SrcRectConstraint
{
kStrict_SrcRectConstraint
kFast_SrcRectConstraint
}
;
void
drawImageRect
(
const
SkImage
*
image
const
SkRect
&
src
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
constraint
=
kStrict_SrcRectConstraint
)
;
void
drawImageRect
(
const
SkImage
*
image
const
SkIRect
&
isrc
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
=
kStrict_SrcRectConstraint
)
;
void
drawImageRect
(
const
SkImage
*
image
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
=
kStrict_SrcRectConstraint
)
;
void
drawImageNine
(
const
SkImage
*
const
SkIRect
&
center
const
SkRect
&
dst
const
SkPaint
*
paint
=
NULL
)
;
void
drawBitmap
(
const
SkBitmap
&
bitmap
SkScalar
left
SkScalar
top
const
SkPaint
*
paint
=
NULL
)
;
void
drawBitmapRect
(
const
SkBitmap
&
bitmap
const
SkRect
&
src
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
=
kStrict_SrcRectConstraint
)
;
void
drawBitmapRect
(
const
SkBitmap
&
bitmap
const
SkIRect
&
isrc
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
=
kStrict_SrcRectConstraint
)
;
void
drawBitmapRect
(
const
SkBitmap
&
bitmap
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
=
kStrict_SrcRectConstraint
)
;
void
drawBitmapNine
(
const
SkBitmap
&
bitmap
const
SkIRect
&
center
const
SkRect
&
dst
const
SkPaint
*
paint
=
NULL
)
;
void
drawText
(
const
void
*
text
size_t
byteLength
SkScalar
x
SkScalar
y
const
SkPaint
&
paint
)
;
void
drawPosText
(
const
void
*
text
size_t
byteLength
const
SkPoint
pos
[
]
const
SkPaint
&
paint
)
;
void
drawPosTextH
(
const
void
*
text
size_t
byteLength
const
SkScalar
xpos
[
]
SkScalar
constY
const
SkPaint
&
paint
)
;
void
drawTextOnPathHV
(
const
void
*
text
size_t
byteLength
const
SkPath
&
path
SkScalar
hOffset
SkScalar
vOffset
const
SkPaint
&
paint
)
;
void
drawTextOnPath
(
const
void
*
text
size_t
byteLength
const
SkPath
&
path
const
SkMatrix
*
matrix
const
SkPaint
&
paint
)
;
void
drawTextBlob
(
const
SkTextBlob
*
blob
SkScalar
x
SkScalar
y
const
SkPaint
&
paint
)
;
void
drawPicture
(
const
SkPicture
*
picture
)
{
this
-
>
drawPicture
(
picture
NULL
NULL
)
;
}
void
drawPicture
(
const
SkPicture
*
const
SkMatrix
*
matrix
const
SkPaint
*
paint
)
;
enum
VertexMode
{
kTriangles_VertexMode
kTriangleStrip_VertexMode
kTriangleFan_VertexMode
}
;
void
drawVertices
(
VertexMode
vmode
int
vertexCount
const
SkPoint
vertices
[
]
const
SkPoint
texs
[
]
const
SkColor
colors
[
]
SkXfermode
*
xmode
const
uint16_t
indices
[
]
int
indexCount
const
SkPaint
&
paint
)
;
void
drawPatch
(
const
SkPoint
cubics
[
12
]
const
SkColor
colors
[
4
]
const
SkPoint
texCoords
[
4
]
SkXfermode
*
xmode
const
SkPaint
&
paint
)
;
void
drawAtlas
(
const
SkImage
*
atlas
const
SkRSXform
xform
[
]
const
SkRect
tex
[
]
const
SkColor
colors
[
]
int
count
SkXfermode
:
:
Mode
const
SkRect
*
cullRect
const
SkPaint
*
paint
)
;
void
drawAtlas
(
const
SkImage
*
atlas
const
SkRSXform
xform
[
]
const
SkRect
tex
[
]
int
count
const
SkRect
*
cullRect
const
SkPaint
*
paint
)
{
this
-
>
drawAtlas
(
atlas
xform
tex
NULL
count
SkXfermode
:
:
kDst_Mode
cullRect
paint
)
;
}
void
drawDrawable
(
SkDrawable
*
drawable
const
SkMatrix
*
=
NULL
)
;
void
drawDrawable
(
SkDrawable
*
SkScalar
x
SkScalar
y
)
;
SkDrawFilter
*
getDrawFilter
(
)
const
;
virtual
SkDrawFilter
*
setDrawFilter
(
SkDrawFilter
*
filter
)
;
virtual
bool
isClipEmpty
(
)
const
;
virtual
bool
isClipRect
(
)
const
;
const
SkMatrix
&
getTotalMatrix
(
)
const
;
const
SkClipStack
*
getClipStack
(
)
const
{
return
fClipStack
;
}
typedef
SkCanvasClipVisitor
ClipVisitor
;
void
replayClips
(
ClipVisitor
*
)
const
;
class
SK_API
LayerIter
{
public
:
LayerIter
(
SkCanvas
*
bool
skipEmptyClips
)
;
~
LayerIter
(
)
;
bool
done
(
)
const
{
return
fDone
;
}
void
next
(
)
;
SkBaseDevice
*
device
(
)
const
;
const
SkMatrix
&
matrix
(
)
const
;
const
SkRegion
&
clip
(
)
const
;
const
SkPaint
&
paint
(
)
const
;
int
x
(
)
const
;
int
y
(
)
const
;
private
:
intptr_t
fStorage
[
32
]
;
class
SkDrawIter
*
fImpl
;
SkPaint
fDefaultPaint
;
bool
fDone
;
}
;
GrRenderTarget
*
internal_private_accessTopLayerRenderTarget
(
)
;
static
void
Internal_Private_SetIgnoreSaveLayerBounds
(
bool
)
;
static
bool
Internal_Private_GetIgnoreSaveLayerBounds
(
)
;
static
void
Internal_Private_SetTreatSpriteAsBitmap
(
bool
)
;
static
bool
Internal_Private_GetTreatSpriteAsBitmap
(
)
;
void
legacy_drawImageRect
(
const
SkImage
*
image
const
SkRect
*
src
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
constraint
=
kStrict_SrcRectConstraint
)
;
void
legacy_drawBitmapRect
(
const
SkBitmap
&
bitmap
const
SkRect
*
src
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
constraint
=
kStrict_SrcRectConstraint
)
;
protected
:
virtual
SkSurface
*
onNewSurface
(
const
SkImageInfo
&
const
SkSurfaceProps
&
)
;
virtual
bool
onPeekPixels
(
SkPixmap
*
)
;
virtual
bool
onAccessTopLayerPixels
(
SkPixmap
*
)
;
enum
SaveLayerStrategy
{
kFullLayer_SaveLayerStrategy
kNoLayer_SaveLayerStrategy
}
;
virtual
void
willSave
(
)
{
}
virtual
SaveLayerStrategy
getSaveLayerStrategy
(
const
SaveLayerRec
&
)
{
return
kFullLayer_SaveLayerStrategy
;
}
virtual
void
willRestore
(
)
{
}
virtual
void
didRestore
(
)
{
}
virtual
void
didConcat
(
const
SkMatrix
&
)
{
}
virtual
void
didSetMatrix
(
const
SkMatrix
&
)
{
}
virtual
void
onDrawDRRect
(
const
SkRRect
&
const
SkRRect
&
const
SkPaint
&
)
;
virtual
void
onDrawText
(
const
void
*
text
size_t
byteLength
SkScalar
x
SkScalar
y
const
SkPaint
&
paint
)
;
virtual
void
onDrawPosText
(
const
void
*
text
size_t
byteLength
const
SkPoint
pos
[
]
const
SkPaint
&
paint
)
;
virtual
void
onDrawPosTextH
(
const
void
*
text
size_t
byteLength
const
SkScalar
xpos
[
]
SkScalar
constY
const
SkPaint
&
paint
)
;
virtual
void
onDrawTextOnPath
(
const
void
*
text
size_t
byteLength
const
SkPath
&
path
const
SkMatrix
*
matrix
const
SkPaint
&
paint
)
;
virtual
void
onDrawTextBlob
(
const
SkTextBlob
*
blob
SkScalar
x
SkScalar
y
const
SkPaint
&
paint
)
;
virtual
void
onDrawPatch
(
const
SkPoint
cubics
[
12
]
const
SkColor
colors
[
4
]
const
SkPoint
texCoords
[
4
]
SkXfermode
*
xmode
const
SkPaint
&
paint
)
;
virtual
void
onDrawDrawable
(
SkDrawable
*
const
SkMatrix
*
)
;
virtual
void
onDrawPaint
(
const
SkPaint
&
)
;
virtual
void
onDrawRect
(
const
SkRect
&
const
SkPaint
&
)
;
virtual
void
onDrawOval
(
const
SkRect
&
const
SkPaint
&
)
;
virtual
void
onDrawRRect
(
const
SkRRect
&
const
SkPaint
&
)
;
virtual
void
onDrawPoints
(
PointMode
size_t
count
const
SkPoint
pts
[
]
const
SkPaint
&
)
;
virtual
void
onDrawVertices
(
VertexMode
int
vertexCount
const
SkPoint
vertices
[
]
const
SkPoint
texs
[
]
const
SkColor
colors
[
]
SkXfermode
*
const
uint16_t
indices
[
]
int
indexCount
const
SkPaint
&
)
;
virtual
void
onDrawAtlas
(
const
SkImage
*
const
SkRSXform
[
]
const
SkRect
[
]
const
SkColor
[
]
int
count
SkXfermode
:
:
Mode
const
SkRect
*
cull
const
SkPaint
*
)
;
virtual
void
onDrawPath
(
const
SkPath
&
const
SkPaint
&
)
;
virtual
void
onDrawImage
(
const
SkImage
*
SkScalar
dx
SkScalar
dy
const
SkPaint
*
)
;
virtual
void
onDrawImageRect
(
const
SkImage
*
const
SkRect
*
const
SkRect
&
const
SkPaint
*
SrcRectConstraint
)
;
virtual
void
onDrawImageNine
(
const
SkImage
*
const
SkIRect
&
center
const
SkRect
&
dst
const
SkPaint
*
)
;
virtual
void
onDrawBitmap
(
const
SkBitmap
&
SkScalar
dx
SkScalar
dy
const
SkPaint
*
)
;
virtual
void
onDrawBitmapRect
(
const
SkBitmap
&
const
SkRect
*
const
SkRect
&
const
SkPaint
*
SrcRectConstraint
)
;
virtual
void
onDrawBitmapNine
(
const
SkBitmap
&
const
SkIRect
&
center
const
SkRect
&
dst
const
SkPaint
*
)
;
enum
ClipEdgeStyle
{
kHard_ClipEdgeStyle
kSoft_ClipEdgeStyle
}
;
virtual
void
onClipRect
(
const
SkRect
&
rect
SkRegion
:
:
Op
op
ClipEdgeStyle
edgeStyle
)
;
virtual
void
onClipRRect
(
const
SkRRect
&
rrect
SkRegion
:
:
Op
op
ClipEdgeStyle
edgeStyle
)
;
virtual
void
onClipPath
(
const
SkPath
&
path
SkRegion
:
:
Op
op
ClipEdgeStyle
edgeStyle
)
;
virtual
void
onClipRegion
(
const
SkRegion
&
deviceRgn
SkRegion
:
:
Op
op
)
;
virtual
void
onDiscard
(
)
;
virtual
void
onDrawPicture
(
const
SkPicture
*
const
SkMatrix
*
const
SkPaint
*
)
;
virtual
SkCanvas
*
canvasForDrawIter
(
)
;
bool
clipRectBounds
(
const
SkRect
*
bounds
SaveLayerFlags
SkIRect
*
intersection
const
SkImageFilter
*
imageFilter
=
NULL
)
;
#
ifdef
SK_SUPPORT_LEGACY_SAVEFLAGS
static
uint32_t
SaveLayerFlagsToSaveFlags
(
SaveLayerFlags
)
;
#
endif
private
:
static
bool
BoundsAffectsClip
(
SaveLayerFlags
)
;
#
ifdef
SK_SUPPORT_LEGACY_SAVEFLAGS
static
uint32_t
SaveFlagsToSaveLayerFlags
(
SaveFlags
)
;
#
endif
static
SaveLayerFlags
LegacySaveFlagsToSaveLayerFlags
(
uint32_t
legacySaveFlags
)
;
enum
ShaderOverrideOpacity
{
kNone_ShaderOverrideOpacity
kOpaque_ShaderOverrideOpacity
kNotOpaque_ShaderOverrideOpacity
}
;
void
predrawNotify
(
bool
willOverwritesEntireSurface
=
false
)
;
void
predrawNotify
(
const
SkRect
*
rect
const
SkPaint
*
paint
ShaderOverrideOpacity
)
;
void
predrawNotify
(
const
SkRect
*
rect
const
SkPaint
*
paint
bool
shaderOverrideIsOpaque
)
{
this
-
>
predrawNotify
(
rect
paint
shaderOverrideIsOpaque
?
kOpaque_ShaderOverrideOpacity
:
kNotOpaque_ShaderOverrideOpacity
)
;
}
class
MCRec
;
SkAutoTUnref
<
SkClipStack
>
fClipStack
;
SkDeque
fMCStack
;
MCRec
*
fMCRec
;
enum
{
kMCRecSize
=
128
kMCRecCount
=
32
kDeviceCMSize
=
136
}
;
intptr_t
fMCRecStorage
[
kMCRecSize
*
kMCRecCount
/
sizeof
(
intptr_t
)
]
;
intptr_t
fDeviceCMStorage
[
kDeviceCMSize
/
sizeof
(
intptr_t
)
]
;
const
SkSurfaceProps
fProps
;
int
fSaveCount
;
SkMetaData
*
fMetaData
;
SkSurface_Base
*
fSurfaceBase
;
SkSurface_Base
*
getSurfaceBase
(
)
const
{
return
fSurfaceBase
;
}
void
setSurfaceBase
(
SkSurface_Base
*
sb
)
{
fSurfaceBase
=
sb
;
}
friend
class
SkSurface_Base
;
friend
class
SkSurface_Gpu
;
bool
fDeviceCMDirty
;
void
updateDeviceCMCache
(
)
;
void
doSave
(
)
;
void
checkForDeferredSave
(
)
;
friend
class
SkDrawIter
;
friend
class
AutoDrawLooper
;
friend
class
SkLua
;
friend
class
SkDebugCanvas
;
friend
class
SkSurface_Raster
;
friend
class
SkRecorder
;
friend
class
SkNoSaveLayerCanvas
;
friend
class
SkPictureImageFilter
;
friend
class
SkPictureRecord
;
friend
class
SkPicturePlayback
;
enum
InitFlags
{
kDefault_InitFlags
=
0
kConservativeRasterClip_InitFlag
=
1
<
<
0
}
;
SkCanvas
(
const
SkIRect
&
bounds
InitFlags
)
;
SkCanvas
(
SkBaseDevice
*
device
InitFlags
)
;
void
resetForNextPicture
(
const
SkIRect
&
bounds
)
;
friend
class
SkCanvasStateUtils
;
void
setupDevice
(
SkBaseDevice
*
)
;
SkBaseDevice
*
init
(
SkBaseDevice
*
InitFlags
)
;
SkISize
getTopLayerSize
(
)
const
;
SkIPoint
getTopLayerOrigin
(
)
const
;
void
internalDrawBitmapRect
(
const
SkBitmap
&
bitmap
const
SkRect
*
src
const
SkRect
&
dst
const
SkPaint
*
paint
SrcRectConstraint
)
;
void
internalDrawPaint
(
const
SkPaint
&
paint
)
;
void
internalSaveLayer
(
const
SaveLayerRec
&
SaveLayerStrategy
)
;
void
internalDrawDevice
(
SkBaseDevice
*
int
x
int
y
const
SkPaint
*
bool
isBitmapDevice
)
;
void
internalSave
(
)
;
void
internalRestore
(
)
;
static
void
DrawRect
(
const
SkDraw
&
draw
const
SkPaint
&
paint
const
SkRect
&
r
SkScalar
textSize
)
;
static
void
DrawTextDecorations
(
const
SkDraw
&
draw
const
SkPaint
&
paint
const
char
text
[
]
size_t
byteLength
SkScalar
x
SkScalar
y
)
;
const
SkRegion
&
internal_private_getTotalClip
(
)
const
;
bool
wouldOverwriteEntireSurface
(
const
SkRect
*
const
SkPaint
*
ShaderOverrideOpacity
)
const
;
bool
canDrawBitmapAsSprite
(
SkScalar
x
SkScalar
y
int
w
int
h
const
SkPaint
&
)
;
mutable
SkRect
fCachedLocalClipBounds
;
mutable
bool
fCachedLocalClipBoundsDirty
;
bool
fAllowSoftClip
;
bool
fAllowSimplifyClip
;
const
bool
fConservativeRasterClip
;
const
SkRect
&
getLocalClipBounds
(
)
const
{
if
(
fCachedLocalClipBoundsDirty
)
{
if
(
!
this
-
>
getClipBounds
(
&
fCachedLocalClipBounds
)
)
{
fCachedLocalClipBounds
.
setEmpty
(
)
;
}
fCachedLocalClipBoundsDirty
=
false
;
}
return
fCachedLocalClipBounds
;
}
class
AutoValidateClip
:
:
:
SkNoncopyable
{
public
:
explicit
AutoValidateClip
(
SkCanvas
*
canvas
)
:
fCanvas
(
canvas
)
{
fCanvas
-
>
validateClip
(
)
;
}
~
AutoValidateClip
(
)
{
fCanvas
-
>
validateClip
(
)
;
}
private
:
const
SkCanvas
*
fCanvas
;
}
;
#
ifdef
SK_DEBUG
void
validateClip
(
)
const
;
#
else
void
validateClip
(
)
const
{
}
#
endif
typedef
SkRefCnt
INHERITED
;
}
;
class
SkAutoCanvasRestore
:
SkNoncopyable
{
public
:
SkAutoCanvasRestore
(
SkCanvas
*
canvas
bool
doSave
)
:
fCanvas
(
canvas
)
fSaveCount
(
0
)
{
if
(
fCanvas
)
{
fSaveCount
=
canvas
-
>
getSaveCount
(
)
;
if
(
doSave
)
{
canvas
-
>
save
(
)
;
}
}
}
~
SkAutoCanvasRestore
(
)
{
if
(
fCanvas
)
{
fCanvas
-
>
restoreToCount
(
fSaveCount
)
;
}
}
void
restore
(
)
{
if
(
fCanvas
)
{
fCanvas
-
>
restoreToCount
(
fSaveCount
)
;
fCanvas
=
NULL
;
}
}
private
:
SkCanvas
*
fCanvas
;
int
fSaveCount
;
}
;
#
define
SkAutoCanvasRestore
(
.
.
.
)
SK_REQUIRE_LOCAL_VAR
(
SkAutoCanvasRestore
)
#
ifdef
SK_SUPPORT_LEGACY_SAVEFLAGS
static
inline
SkCanvas
:
:
SaveFlags
operator
|
(
const
SkCanvas
:
:
SaveFlags
lhs
const
SkCanvas
:
:
SaveFlags
rhs
)
{
return
static_cast
<
SkCanvas
:
:
SaveFlags
>
(
static_cast
<
int
>
(
lhs
)
|
static_cast
<
int
>
(
rhs
)
)
;
}
static
inline
SkCanvas
:
:
SaveFlags
&
operator
|
=
(
SkCanvas
:
:
SaveFlags
&
lhs
const
SkCanvas
:
:
SaveFlags
rhs
)
{
lhs
=
lhs
|
rhs
;
return
lhs
;
}
#
endif
class
SkCanvasClipVisitor
{
public
:
virtual
~
SkCanvasClipVisitor
(
)
;
virtual
void
clipRect
(
const
SkRect
&
SkRegion
:
:
Op
bool
antialias
)
=
0
;
virtual
void
clipRRect
(
const
SkRRect
&
SkRegion
:
:
Op
bool
antialias
)
=
0
;
virtual
void
clipPath
(
const
SkPath
&
SkRegion
:
:
Op
bool
antialias
)
=
0
;
}
;
#
endif
