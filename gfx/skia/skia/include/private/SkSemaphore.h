#
ifndef
SkSemaphore_DEFINED
#
define
SkSemaphore_DEFINED
#
include
"
.
.
/
private
/
SkOnce
.
h
"
#
include
"
SkTypes
.
h
"
#
include
<
atomic
>
class
SkBaseSemaphore
{
public
:
constexpr
SkBaseSemaphore
(
int
count
=
0
)
:
fCount
(
count
)
fOSSemaphore
(
nullptr
)
{
}
void
signal
(
int
n
=
1
)
;
void
wait
(
)
;
void
cleanup
(
)
;
private
:
struct
OSSemaphore
;
void
osSignal
(
int
n
)
;
void
osWait
(
)
;
std
:
:
atomic
<
int
>
fCount
;
SkOnce
fOSSemaphoreOnce
;
OSSemaphore
*
fOSSemaphore
;
}
;
class
SkSemaphore
:
public
SkBaseSemaphore
{
public
:
using
SkBaseSemaphore
:
:
SkBaseSemaphore
;
~
SkSemaphore
(
)
{
this
-
>
cleanup
(
)
;
}
}
;
inline
void
SkBaseSemaphore
:
:
signal
(
int
n
)
{
int
prev
=
fCount
.
fetch_add
(
n
std
:
:
memory_order_release
)
;
int
toSignal
=
SkTMin
(
-
prev
n
)
;
if
(
toSignal
>
0
)
{
this
-
>
osSignal
(
toSignal
)
;
}
}
inline
void
SkBaseSemaphore
:
:
wait
(
)
{
if
(
fCount
.
fetch_sub
(
1
std
:
:
memory_order_acquire
)
<
=
0
)
{
this
-
>
osWait
(
)
;
}
}
#
endif
