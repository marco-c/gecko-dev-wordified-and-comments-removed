#
ifndef
GrAuditTrail_DEFINED
#
define
GrAuditTrail_DEFINED
#
include
"
GrConfig
.
h
"
#
include
"
SkRect
.
h
"
#
include
"
SkString
.
h
"
#
include
"
SkTArray
.
h
"
#
include
"
SkTHash
.
h
"
class
GrBatch
;
class
GrAuditTrail
{
public
:
GrAuditTrail
(
)
:
fClientID
(
kGrAuditTrailInvalidID
)
fEnabled
(
false
)
{
}
class
AutoEnable
{
public
:
AutoEnable
(
GrAuditTrail
*
auditTrail
)
:
fAuditTrail
(
auditTrail
)
{
SkASSERT
(
!
fAuditTrail
-
>
isEnabled
(
)
)
;
fAuditTrail
-
>
setEnabled
(
true
)
;
}
~
AutoEnable
(
)
{
SkASSERT
(
fAuditTrail
-
>
isEnabled
(
)
)
;
fAuditTrail
-
>
setEnabled
(
false
)
;
}
private
:
GrAuditTrail
*
fAuditTrail
;
}
;
class
AutoManageBatchList
{
public
:
AutoManageBatchList
(
GrAuditTrail
*
auditTrail
)
:
fAutoEnable
(
auditTrail
)
fAuditTrail
(
auditTrail
)
{
}
~
AutoManageBatchList
(
)
{
fAuditTrail
-
>
fullReset
(
)
;
}
private
:
AutoEnable
fAutoEnable
;
GrAuditTrail
*
fAuditTrail
;
}
;
class
AutoCollectBatches
{
public
:
AutoCollectBatches
(
GrAuditTrail
*
auditTrail
int
clientID
)
:
fAutoEnable
(
auditTrail
)
fAuditTrail
(
auditTrail
)
{
fAuditTrail
-
>
setClientID
(
clientID
)
;
}
~
AutoCollectBatches
(
)
{
fAuditTrail
-
>
setClientID
(
kGrAuditTrailInvalidID
)
;
}
private
:
AutoEnable
fAutoEnable
;
GrAuditTrail
*
fAuditTrail
;
}
;
void
pushFrame
(
const
char
*
framename
)
{
SkASSERT
(
fEnabled
)
;
fCurrentStackTrace
.
push_back
(
SkString
(
framename
)
)
;
}
void
addBatch
(
const
GrBatch
*
batch
)
;
void
batchingResultCombined
(
const
GrBatch
*
consumer
const
GrBatch
*
consumed
)
;
SkString
toJson
(
bool
prettyPrint
=
false
)
const
;
SkString
toJson
(
int
clientID
bool
prettyPrint
=
false
)
const
;
bool
isEnabled
(
)
{
return
fEnabled
;
}
void
setEnabled
(
bool
enabled
)
{
fEnabled
=
enabled
;
}
void
setClientID
(
int
clientID
)
{
fClientID
=
clientID
;
}
struct
BatchInfo
{
SkRect
fBounds
;
uint32_t
fRenderTargetUniqueID
;
struct
Batch
{
int
fClientID
;
SkRect
fBounds
;
}
;
SkTArray
<
Batch
>
fBatches
;
}
;
void
getBoundsByClientID
(
SkTArray
<
BatchInfo
>
*
outInfo
int
clientID
)
;
void
getBoundsByBatchListID
(
BatchInfo
*
outInfo
int
batchListID
)
;
void
fullReset
(
)
;
static
const
int
kGrAuditTrailInvalidID
;
private
:
struct
Batch
{
SkString
toJson
(
)
const
;
SkString
fName
;
SkTArray
<
SkString
>
fStackTrace
;
SkRect
fBounds
;
int
fClientID
;
int
fBatchListID
;
int
fChildID
;
}
;
typedef
SkTArray
<
SkAutoTDelete
<
Batch
>
true
>
BatchPool
;
typedef
SkTArray
<
Batch
*
>
Batches
;
struct
BatchNode
{
SkString
toJson
(
)
const
;
SkRect
fBounds
;
Batches
fChildren
;
uint32_t
fRenderTargetUniqueID
;
}
;
typedef
SkTArray
<
SkAutoTDelete
<
BatchNode
>
true
>
BatchList
;
void
copyOutFromBatchList
(
BatchInfo
*
outBatchInfo
int
batchListID
)
;
template
<
typename
T
>
static
void
JsonifyTArray
(
SkString
*
json
const
char
*
name
const
T
&
array
bool
addComma
)
;
BatchPool
fBatchPool
;
SkTHashMap
<
uint32_t
int
>
fIDLookup
;
SkTHashMap
<
int
Batches
*
>
fClientIDLookup
;
BatchList
fBatchList
;
SkTArray
<
SkString
>
fCurrentStackTrace
;
int
fClientID
;
bool
fEnabled
;
}
;
#
define
GR_AUDIT_TRAIL_INVOKE_GUARD
(
audit_trail
invoke
.
.
.
)
\
if
(
audit_trail
-
>
isEnabled
(
)
)
{
\
audit_trail
-
>
invoke
(
__VA_ARGS__
)
;
\
}
#
define
GR_AUDIT_TRAIL_AUTO_FRAME
(
audit_trail
framename
)
\
GR_AUDIT_TRAIL_INVOKE_GUARD
(
(
audit_trail
)
pushFrame
framename
)
;
#
define
GR_AUDIT_TRAIL_RESET
(
audit_trail
)
#
define
GR_AUDIT_TRAIL_ADDBATCH
(
audit_trail
batch
)
\
GR_AUDIT_TRAIL_INVOKE_GUARD
(
audit_trail
addBatch
batch
)
;
#
define
GR_AUDIT_TRAIL_BATCHING_RESULT_COMBINED
(
audit_trail
combineWith
batch
)
\
GR_AUDIT_TRAIL_INVOKE_GUARD
(
audit_trail
batchingResultCombined
combineWith
batch
)
;
#
define
GR_AUDIT_TRAIL_BATCHING_RESULT_NEW
(
audit_trail
batch
)
#
endif
