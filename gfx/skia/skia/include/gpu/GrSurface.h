#
ifndef
GrSurface_DEFINED
#
define
GrSurface_DEFINED
#
include
"
include
/
core
/
SkImageInfo
.
h
"
#
include
"
include
/
core
/
SkRect
.
h
"
#
include
"
include
/
gpu
/
GrBackendSurface
.
h
"
#
include
"
include
/
gpu
/
GrGpuResource
.
h
"
#
include
"
include
/
gpu
/
GrTypes
.
h
"
class
GrRenderTarget
;
class
GrSurfacePriv
;
class
GrTexture
;
class
GrSurface
:
public
GrGpuResource
{
public
:
int
width
(
)
const
{
return
fWidth
;
}
int
height
(
)
const
{
return
fHeight
;
}
SkRect
getBoundsRect
(
)
const
{
return
SkRect
:
:
MakeIWH
(
this
-
>
width
(
)
this
-
>
height
(
)
)
;
}
GrPixelConfig
config
(
)
const
{
return
fConfig
;
}
virtual
GrBackendFormat
backendFormat
(
)
const
=
0
;
SK_API
void
setRelease
(
sk_sp
<
GrRefCntedCallback
>
releaseHelper
)
{
this
-
>
onSetRelease
(
releaseHelper
)
;
fReleaseHelper
=
std
:
:
move
(
releaseHelper
)
;
}
typedef
void
*
ReleaseCtx
;
typedef
void
(
*
ReleaseProc
)
(
ReleaseCtx
)
;
SK_API
void
setRelease
(
ReleaseProc
proc
ReleaseCtx
ctx
)
{
sk_sp
<
GrRefCntedCallback
>
helper
(
new
GrRefCntedCallback
(
proc
ctx
)
)
;
this
-
>
setRelease
(
std
:
:
move
(
helper
)
)
;
}
virtual
GrTexture
*
asTexture
(
)
{
return
nullptr
;
}
virtual
const
GrTexture
*
asTexture
(
)
const
{
return
nullptr
;
}
virtual
GrRenderTarget
*
asRenderTarget
(
)
{
return
nullptr
;
}
virtual
const
GrRenderTarget
*
asRenderTarget
(
)
const
{
return
nullptr
;
}
inline
GrSurfacePriv
surfacePriv
(
)
;
inline
const
GrSurfacePriv
surfacePriv
(
)
const
;
static
size_t
ComputeSize
(
const
GrCaps
&
const
GrBackendFormat
&
int
width
int
height
int
colorSamplesPerPixel
GrMipMapped
bool
binSize
=
false
)
;
bool
readOnly
(
)
const
{
return
fSurfaceFlags
&
GrInternalSurfaceFlags
:
:
kReadOnly
;
}
bool
isProtected
(
)
const
{
return
fIsProtected
=
=
GrProtected
:
:
kYes
;
}
protected
:
void
setGLRTFBOIDIs0
(
)
{
SkASSERT
(
!
this
-
>
requiresManualMSAAResolve
(
)
)
;
SkASSERT
(
!
this
-
>
asTexture
(
)
)
;
SkASSERT
(
this
-
>
asRenderTarget
(
)
)
;
fSurfaceFlags
|
=
GrInternalSurfaceFlags
:
:
kGLRTFBOIDIs0
;
}
bool
glRTFBOIDis0
(
)
const
{
return
fSurfaceFlags
&
GrInternalSurfaceFlags
:
:
kGLRTFBOIDIs0
;
}
void
setRequiresManualMSAAResolve
(
)
{
SkASSERT
(
!
this
-
>
glRTFBOIDis0
(
)
)
;
SkASSERT
(
this
-
>
asRenderTarget
(
)
)
;
fSurfaceFlags
|
=
GrInternalSurfaceFlags
:
:
kRequiresManualMSAAResolve
;
}
bool
requiresManualMSAAResolve
(
)
const
{
return
fSurfaceFlags
&
GrInternalSurfaceFlags
:
:
kRequiresManualMSAAResolve
;
}
void
setReadOnly
(
)
{
SkASSERT
(
!
this
-
>
asRenderTarget
(
)
)
;
fSurfaceFlags
|
=
GrInternalSurfaceFlags
:
:
kReadOnly
;
}
friend
class
GrSurfacePriv
;
GrSurface
(
GrGpu
*
gpu
const
SkISize
&
size
GrPixelConfig
config
GrProtected
isProtected
)
:
INHERITED
(
gpu
)
fConfig
(
config
)
fWidth
(
size
.
width
(
)
)
fHeight
(
size
.
height
(
)
)
fSurfaceFlags
(
GrInternalSurfaceFlags
:
:
kNone
)
fIsProtected
(
isProtected
)
{
}
~
GrSurface
(
)
override
{
SkASSERT
(
!
fReleaseHelper
)
;
}
void
onRelease
(
)
override
;
void
onAbandon
(
)
override
;
private
:
const
char
*
getResourceType
(
)
const
override
{
return
"
Surface
"
;
}
virtual
void
onSetRelease
(
sk_sp
<
GrRefCntedCallback
>
)
{
}
void
invokeReleaseProc
(
)
{
fReleaseHelper
.
reset
(
)
;
}
GrPixelConfig
fConfig
;
int
fWidth
;
int
fHeight
;
GrInternalSurfaceFlags
fSurfaceFlags
;
GrProtected
fIsProtected
;
sk_sp
<
GrRefCntedCallback
>
fReleaseHelper
;
typedef
GrGpuResource
INHERITED
;
}
;
#
endif
