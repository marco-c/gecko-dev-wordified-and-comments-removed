#
include
"
GPUChild
.
h
"
#
include
"
gfxConfig
.
h
"
#
include
"
gfxPrefs
.
h
"
#
include
"
GPUProcessHost
.
h
"
#
include
"
mozilla
/
dom
/
CheckerboardReportService
.
h
"
#
include
"
mozilla
/
gfx
/
gfxVars
.
h
"
#
if
defined
(
XP_WIN
)
#
include
"
mozilla
/
gfx
/
DeviceManagerDx
.
h
"
#
endif
namespace
mozilla
{
namespace
gfx
{
GPUChild
:
:
GPUChild
(
GPUProcessHost
*
aHost
)
:
mHost
(
aHost
)
mGPUReady
(
false
)
{
MOZ_COUNT_CTOR
(
GPUChild
)
;
}
GPUChild
:
:
~
GPUChild
(
)
{
MOZ_COUNT_DTOR
(
GPUChild
)
;
}
void
GPUChild
:
:
Init
(
)
{
nsTArray
<
GfxPrefSetting
>
prefs
;
for
(
auto
pref
:
gfxPrefs
:
:
all
(
)
)
{
if
(
pref
-
>
HasDefaultValue
(
)
)
{
continue
;
}
GfxPrefValue
value
;
pref
-
>
GetCachedValue
(
&
value
)
;
prefs
.
AppendElement
(
GfxPrefSetting
(
pref
-
>
Index
(
)
value
)
)
;
}
nsTArray
<
GfxVarUpdate
>
updates
=
gfxVars
:
:
FetchNonDefaultVars
(
)
;
DevicePrefs
devicePrefs
;
devicePrefs
.
hwCompositing
(
)
=
gfxConfig
:
:
GetValue
(
Feature
:
:
HW_COMPOSITING
)
;
devicePrefs
.
d3d11Compositing
(
)
=
gfxConfig
:
:
GetValue
(
Feature
:
:
D3D11_COMPOSITING
)
;
devicePrefs
.
d3d9Compositing
(
)
=
gfxConfig
:
:
GetValue
(
Feature
:
:
D3D9_COMPOSITING
)
;
devicePrefs
.
oglCompositing
(
)
=
gfxConfig
:
:
GetValue
(
Feature
:
:
OPENGL_COMPOSITING
)
;
devicePrefs
.
useD2D1
(
)
=
gfxConfig
:
:
GetValue
(
Feature
:
:
DIRECT2D
)
;
SendInit
(
prefs
updates
devicePrefs
)
;
gfxVars
:
:
AddReceiver
(
this
)
;
}
void
GPUChild
:
:
OnVarChanged
(
const
GfxVarUpdate
&
aVar
)
{
SendUpdateVar
(
aVar
)
;
}
void
GPUChild
:
:
EnsureGPUReady
(
)
{
if
(
mGPUReady
)
{
return
;
}
GPUDeviceData
data
;
SendGetDeviceStatus
(
&
data
)
;
gfxPlatform
:
:
GetPlatform
(
)
-
>
ImportGPUDeviceData
(
data
)
;
mGPUReady
=
true
;
}
bool
GPUChild
:
:
RecvInitComplete
(
const
GPUDeviceData
&
aData
)
{
if
(
mGPUReady
)
{
return
true
;
}
gfxPlatform
:
:
GetPlatform
(
)
-
>
ImportGPUDeviceData
(
aData
)
;
mGPUReady
=
true
;
return
true
;
}
bool
GPUChild
:
:
RecvReportCheckerboard
(
const
uint32_t
&
aSeverity
const
nsCString
&
aLog
)
{
layers
:
:
CheckerboardEventStorage
:
:
Report
(
aSeverity
std
:
:
string
(
aLog
.
get
(
)
)
)
;
return
true
;
}
bool
GPUChild
:
:
RecvGraphicsError
(
const
nsCString
&
aError
)
{
gfx
:
:
LogForwarder
*
lf
=
gfx
:
:
Factory
:
:
GetLogForwarder
(
)
;
if
(
lf
)
{
std
:
:
stringstream
message
;
message
<
<
"
GP
+
"
<
<
aError
.
get
(
)
;
lf
-
>
UpdateStringsVector
(
message
.
str
(
)
)
;
}
return
true
;
}
void
GPUChild
:
:
ActorDestroy
(
ActorDestroyReason
aWhy
)
{
gfxVars
:
:
RemoveReceiver
(
this
)
;
mHost
-
>
OnChannelClosed
(
)
;
}
class
DeferredDeleteGPUChild
:
public
Runnable
{
public
:
explicit
DeferredDeleteGPUChild
(
UniquePtr
<
GPUChild
>
&
&
aChild
)
:
mChild
(
Move
(
aChild
)
)
{
}
NS_IMETHODIMP
Run
(
)
override
{
return
NS_OK
;
}
private
:
UniquePtr
<
GPUChild
>
mChild
;
}
;
void
GPUChild
:
:
Destroy
(
UniquePtr
<
GPUChild
>
&
&
aChild
)
{
NS_DispatchToMainThread
(
new
DeferredDeleteGPUChild
(
Move
(
aChild
)
)
)
;
}
}
}
