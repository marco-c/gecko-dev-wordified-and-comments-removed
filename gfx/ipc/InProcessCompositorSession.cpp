#
include
"
InProcessCompositorSession
.
h
"
#
include
"
mozilla
/
layers
/
APZCTreeManager
.
h
"
#
include
"
mozilla
/
layers
/
IAPZCTreeManager
.
h
"
namespace
mozilla
{
namespace
layers
{
InProcessCompositorSession
:
:
InProcessCompositorSession
(
widget
:
:
CompositorWidget
*
aWidget
CompositorBridgeChild
*
aChild
CompositorBridgeParent
*
aParent
)
:
CompositorSession
(
aWidget
-
>
AsDelegate
(
)
aChild
aParent
-
>
RootLayerTreeId
(
)
)
mCompositorBridgeParent
(
aParent
)
mCompositorWidget
(
aWidget
)
{
}
RefPtr
<
InProcessCompositorSession
>
InProcessCompositorSession
:
:
Create
(
nsIWidget
*
aWidget
LayerManager
*
aLayerManager
const
uint64_t
&
aRootLayerTreeId
CSSToLayoutDeviceScale
aScale
const
CompositorOptions
&
aOptions
bool
aUseExternalSurfaceSize
const
gfx
:
:
IntSize
&
aSurfaceSize
uint32_t
aNamespace
)
{
CompositorWidgetInitData
initData
;
aWidget
-
>
GetCompositorWidgetInitData
(
&
initData
)
;
RefPtr
<
CompositorWidget
>
widget
=
CompositorWidget
:
:
CreateLocal
(
initData
aOptions
aWidget
)
;
RefPtr
<
CompositorBridgeParent
>
parent
=
CompositorManagerParent
:
:
CreateSameProcessWidgetCompositorBridge
(
aScale
aOptions
aUseExternalSurfaceSize
aSurfaceSize
)
;
MOZ_ASSERT
(
parent
)
;
parent
-
>
InitSameProcess
(
widget
aRootLayerTreeId
)
;
RefPtr
<
CompositorBridgeChild
>
child
=
CompositorManagerChild
:
:
CreateSameProcessWidgetCompositorBridge
(
aLayerManager
aNamespace
)
;
MOZ_ASSERT
(
child
)
;
return
new
InProcessCompositorSession
(
widget
child
parent
)
;
}
CompositorBridgeParent
*
InProcessCompositorSession
:
:
GetInProcessBridge
(
)
const
{
return
mCompositorBridgeParent
;
}
void
InProcessCompositorSession
:
:
SetContentController
(
GeckoContentController
*
aController
)
{
mCompositorBridgeParent
-
>
SetControllerForLayerTree
(
mRootLayerTreeId
aController
)
;
}
RefPtr
<
IAPZCTreeManager
>
InProcessCompositorSession
:
:
GetAPZCTreeManager
(
)
const
{
return
mCompositorBridgeParent
-
>
GetAPZCTreeManager
(
mRootLayerTreeId
)
;
}
void
InProcessCompositorSession
:
:
Shutdown
(
)
{
mCompositorBridgeChild
-
>
Destroy
(
)
;
mCompositorBridgeChild
=
nullptr
;
mCompositorBridgeParent
=
nullptr
;
mCompositorWidget
=
nullptr
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mUiCompositorControllerChild
)
{
mUiCompositorControllerChild
-
>
Destroy
(
)
;
mUiCompositorControllerChild
=
nullptr
;
}
#
endif
}
}
}
