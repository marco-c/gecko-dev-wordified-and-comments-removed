#
include
"
RemoteCompositorSession
.
h
"
#
include
"
mozilla
/
VsyncDispatcher
.
h
"
#
include
"
mozilla
/
layers
/
APZChild
.
h
"
#
include
"
mozilla
/
layers
/
APZCTreeManagerChild
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsBaseWidget
.
h
"
#
if
defined
(
MOZ_WIDGET_ANDROID
)
#
include
"
mozilla
/
layers
/
UiCompositorControllerChild
.
h
"
#
endif
namespace
mozilla
{
namespace
layers
{
using
namespace
gfx
;
using
namespace
widget
;
RemoteCompositorSession
:
:
RemoteCompositorSession
(
nsBaseWidget
*
aWidget
CompositorBridgeChild
*
aChild
CompositorWidgetDelegate
*
aWidgetDelegate
APZCTreeManagerChild
*
aAPZ
const
LayersId
&
aRootLayerTreeId
)
:
CompositorSession
(
aWidget
aWidgetDelegate
aChild
aRootLayerTreeId
)
mAPZ
(
aAPZ
)
{
MOZ_ASSERT
(
!
gfxPlatform
:
:
IsHeadless
(
)
)
;
GPUProcessManager
:
:
Get
(
)
-
>
RegisterRemoteProcessSession
(
this
)
;
if
(
mAPZ
)
{
mAPZ
-
>
SetCompositorSession
(
this
)
;
}
}
RemoteCompositorSession
:
:
~
RemoteCompositorSession
(
)
{
MOZ_ASSERT
(
!
mCompositorBridgeChild
)
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
MOZ_ASSERT
(
!
mUiCompositorControllerChild
)
;
#
endif
}
void
RemoteCompositorSession
:
:
NotifySessionLost
(
)
{
mWidget
-
>
NotifyCompositorSessionLost
(
this
)
;
}
CompositorBridgeParent
*
RemoteCompositorSession
:
:
GetInProcessBridge
(
)
const
{
return
nullptr
;
}
void
RemoteCompositorSession
:
:
SetContentController
(
GeckoContentController
*
aController
)
{
mContentController
=
aController
;
mCompositorBridgeChild
-
>
SendPAPZConstructor
(
new
APZChild
(
aController
)
LayersId
{
0
}
)
;
}
GeckoContentController
*
RemoteCompositorSession
:
:
GetContentController
(
)
{
return
mContentController
.
get
(
)
;
}
nsIWidget
*
RemoteCompositorSession
:
:
GetWidget
(
)
const
{
return
mWidget
;
}
RefPtr
<
IAPZCTreeManager
>
RemoteCompositorSession
:
:
GetAPZCTreeManager
(
)
const
{
return
mAPZ
;
}
void
RemoteCompositorSession
:
:
Shutdown
(
)
{
mContentController
=
nullptr
;
if
(
mAPZ
)
{
mAPZ
-
>
SetCompositorSession
(
nullptr
)
;
mAPZ
-
>
Destroy
(
)
;
}
mCompositorBridgeChild
-
>
Destroy
(
)
;
mCompositorBridgeChild
=
nullptr
;
mCompositorWidgetDelegate
=
nullptr
;
mWidget
=
nullptr
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
if
(
mUiCompositorControllerChild
)
{
mUiCompositorControllerChild
-
>
Destroy
(
)
;
mUiCompositorControllerChild
=
nullptr
;
}
#
endif
GPUProcessManager
:
:
Get
(
)
-
>
UnregisterRemoteProcessSession
(
this
)
;
}
}
}
