#
ifndef
_include_mozilla_gfx_ipc_GPUProcessHost_h_
#
define
_include_mozilla_gfx_ipc_GPUProcessHost_h_
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
gfx
/
Types
.
h
"
#
include
"
mozilla
/
ipc
/
GeckoChildProcessHost
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
ifdef
MOZ_WIDGET_ANDROID
#
include
"
mozilla
/
java
/
CompositorSurfaceManagerWrappers
.
h
"
#
endif
namespace
mozilla
{
namespace
ipc
{
class
SharedPreferenceSerializer
;
}
}
class
nsITimer
;
namespace
mozilla
{
namespace
gfx
{
class
GPUChild
;
class
GPUProcessHost
final
:
public
mozilla
:
:
ipc
:
:
GeckoChildProcessHost
{
friend
class
GPUChild
;
public
:
class
Listener
{
public
:
virtual
void
OnProcessLaunchComplete
(
GPUProcessHost
*
aHost
)
{
}
virtual
void
OnProcessUnexpectedShutdown
(
GPUProcessHost
*
aHost
)
{
}
virtual
void
OnRemoteProcessDeviceReset
(
GPUProcessHost
*
aHost
const
DeviceResetReason
&
aReason
const
DeviceResetDetectPlace
&
aPlace
)
{
}
virtual
void
OnProcessDeclaredStable
(
)
{
}
}
;
explicit
GPUProcessHost
(
Listener
*
listener
)
;
bool
Launch
(
geckoargs
:
:
ChildProcessArgs
aExtraOpts
)
;
bool
WaitForLaunch
(
)
;
void
Shutdown
(
bool
aUnexpectedShutdown
=
false
)
;
GPUChild
*
GetActor
(
)
const
{
return
mGPUChild
.
get
(
)
;
}
uint64_t
GetProcessToken
(
)
const
;
bool
IsConnected
(
)
const
{
return
!
!
mGPUChild
;
}
TimeStamp
GetLaunchTime
(
)
const
{
return
mLaunchTime
;
}
void
OnChannelConnected
(
base
:
:
ProcessId
peer_pid
)
override
;
void
SetListener
(
Listener
*
aListener
)
;
void
KillProcess
(
bool
aGenerateMinidump
)
;
void
CrashProcess
(
)
;
#
ifdef
MOZ_WIDGET_ANDROID
java
:
:
CompositorSurfaceManager
:
:
Param
GetCompositorSurfaceManager
(
)
;
#
endif
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
static
MacSandboxType
GetMacSandboxType
(
)
{
return
MacSandboxType_GPU
;
}
;
#
endif
private
:
~
GPUProcessHost
(
)
;
void
InitAfterConnect
(
bool
aSucceeded
)
;
void
OnAsyncInitComplete
(
)
;
bool
CompleteInitSynchronously
(
)
;
void
OnChannelClosed
(
)
;
void
KillHard
(
bool
aGenerateMinidump
)
;
void
DestroyProcess
(
)
;
#
if
defined
(
XP_MACOSX
)
&
&
defined
(
MOZ_SANDBOX
)
static
bool
sLaunchWithMacSandbox
;
bool
IsMacSandboxLaunchEnabled
(
)
override
{
return
sLaunchWithMacSandbox
;
}
bool
FillMacSandboxInfo
(
MacSandboxInfo
&
aInfo
)
override
;
#
endif
DISALLOW_COPY_AND_ASSIGN
(
GPUProcessHost
)
;
Listener
*
mListener
;
enum
class
LaunchPhase
{
Unlaunched
Waiting
Connected
Complete
}
;
LaunchPhase
mLaunchPhase
;
RefPtr
<
GPUChild
>
mGPUChild
;
uint64_t
mProcessToken
;
UniquePtr
<
mozilla
:
:
ipc
:
:
SharedPreferenceSerializer
>
mPrefSerializer
;
bool
mShutdownRequested
;
bool
mChannelClosed
;
TimeStamp
mLaunchTime
;
const
RefPtr
<
media
:
:
Refcountable
<
bool
>
>
mLiveToken
;
#
ifdef
MOZ_WIDGET_ANDROID
java
:
:
CompositorSurfaceManager
:
:
GlobalRef
mCompositorSurfaceManager
;
#
endif
}
;
}
}
#
endif
