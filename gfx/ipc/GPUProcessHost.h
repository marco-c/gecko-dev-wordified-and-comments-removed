#
ifndef
_include_mozilla_gfx_ipc_GPUProcessHost_h_
#
define
_include_mozilla_gfx_ipc_GPUProcessHost_h_
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
ipc
/
GeckoChildProcessHost
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
ipc
/
TaskFactory
.
h
"
class
nsITimer
;
namespace
mozilla
{
namespace
gfx
{
class
GPUChild
;
class
GPUProcessHost
final
:
public
mozilla
:
:
ipc
:
:
GeckoChildProcessHost
{
friend
class
GPUChild
;
public
:
class
Listener
{
public
:
virtual
void
OnProcessLaunchComplete
(
GPUProcessHost
*
aHost
)
{
}
virtual
void
OnProcessUnexpectedShutdown
(
GPUProcessHost
*
aHost
)
{
}
virtual
void
OnRemoteProcessDeviceReset
(
GPUProcessHost
*
aHost
)
{
}
}
;
public
:
explicit
GPUProcessHost
(
Listener
*
listener
)
;
~
GPUProcessHost
(
)
;
bool
Launch
(
)
;
bool
WaitForLaunch
(
)
;
void
Shutdown
(
)
;
GPUChild
*
GetActor
(
)
const
{
return
mGPUChild
.
get
(
)
;
}
uint64_t
GetProcessToken
(
)
const
;
bool
IsConnected
(
)
const
{
return
!
!
mGPUChild
;
}
TimeStamp
GetLaunchTime
(
)
const
{
return
mLaunchTime
;
}
void
OnChannelConnected
(
int32_t
peer_pid
)
override
;
void
OnChannelError
(
)
override
;
void
SetListener
(
Listener
*
aListener
)
;
void
KillProcess
(
)
;
private
:
void
OnChannelConnectedTask
(
)
;
void
OnChannelErrorTask
(
)
;
void
InitAfterConnect
(
bool
aSucceeded
)
;
void
OnChannelClosed
(
)
;
void
KillHard
(
const
char
*
aReason
)
;
void
DestroyProcess
(
)
;
private
:
DISALLOW_COPY_AND_ASSIGN
(
GPUProcessHost
)
;
Listener
*
mListener
;
mozilla
:
:
ipc
:
:
TaskFactory
<
GPUProcessHost
>
mTaskFactory
;
enum
class
LaunchPhase
{
Unlaunched
Waiting
Complete
}
;
LaunchPhase
mLaunchPhase
;
UniquePtr
<
GPUChild
>
mGPUChild
;
uint64_t
mProcessToken
;
bool
mShutdownRequested
;
bool
mChannelClosed
;
TimeStamp
mLaunchTime
;
}
;
}
}
#
endif
