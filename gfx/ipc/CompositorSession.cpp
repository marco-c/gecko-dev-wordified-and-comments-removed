#
include
"
CompositorSession
.
h
"
#
include
"
mozilla
/
layers
/
CompositorBridgeChild
.
h
"
#
include
"
mozilla
/
layers
/
CompositorBridgeParent
.
h
"
#
include
"
base
/
process_util
.
h
"
namespace
mozilla
{
namespace
layers
{
class
InProcessCompositorSession
final
:
public
CompositorSession
{
public
:
InProcessCompositorSession
(
widget
:
:
CompositorWidgetProxy
*
aWidgetProxy
ClientLayerManager
*
aLayerManager
CSSToLayoutDeviceScale
aScale
bool
aUseAPZ
bool
aUseExternalSurfaceSize
int
aSurfaceWidth
int
aSurfaceHeight
)
;
CompositorBridgeParent
*
GetInProcessBridge
(
)
const
override
;
void
SetContentController
(
GeckoContentController
*
aController
)
override
;
uint64_t
RootLayerTreeId
(
)
const
override
;
APZCTreeManager
*
GetAPZCTreeManager
(
)
const
override
;
void
Shutdown
(
)
override
;
private
:
RefPtr
<
CompositorBridgeParent
>
mCompositorBridgeParent
;
}
;
already_AddRefed
<
CompositorSession
>
CompositorSession
:
:
CreateTopLevel
(
widget
:
:
CompositorWidgetProxy
*
aWidgetProxy
ClientLayerManager
*
aLayerManager
CSSToLayoutDeviceScale
aScale
bool
aUseAPZ
bool
aUseExternalSurfaceSize
int
aSurfaceWidth
int
aSurfaceHeight
)
{
RefPtr
<
InProcessCompositorSession
>
session
=
new
InProcessCompositorSession
(
aWidgetProxy
aLayerManager
aScale
aUseAPZ
aUseExternalSurfaceSize
aSurfaceWidth
aSurfaceHeight
)
;
return
session
.
forget
(
)
;
}
CompositorSession
:
:
CompositorSession
(
)
{
}
CompositorSession
:
:
~
CompositorSession
(
)
{
}
CompositorBridgeChild
*
CompositorSession
:
:
GetCompositorBridgeChild
(
)
{
return
mCompositorBridgeChild
;
}
InProcessCompositorSession
:
:
InProcessCompositorSession
(
widget
:
:
CompositorWidgetProxy
*
aWidgetProxy
ClientLayerManager
*
aLayerManager
CSSToLayoutDeviceScale
aScale
bool
aUseAPZ
bool
aUseExternalSurfaceSize
int
aSurfaceWidth
int
aSurfaceHeight
)
{
mCompositorBridgeParent
=
new
CompositorBridgeParent
(
aWidgetProxy
aScale
aUseAPZ
aUseExternalSurfaceSize
aSurfaceWidth
aSurfaceHeight
)
;
mCompositorBridgeChild
=
new
CompositorBridgeChild
(
aLayerManager
)
;
mCompositorBridgeChild
-
>
OpenSameProcess
(
mCompositorBridgeParent
)
;
mCompositorBridgeParent
-
>
SetOtherProcessId
(
base
:
:
GetCurrentProcId
(
)
)
;
}
CompositorBridgeParent
*
InProcessCompositorSession
:
:
GetInProcessBridge
(
)
const
{
return
mCompositorBridgeParent
;
}
void
InProcessCompositorSession
:
:
SetContentController
(
GeckoContentController
*
aController
)
{
mCompositorBridgeParent
-
>
SetControllerForLayerTree
(
RootLayerTreeId
(
)
aController
)
;
}
uint64_t
InProcessCompositorSession
:
:
RootLayerTreeId
(
)
const
{
return
mCompositorBridgeParent
-
>
RootLayerTreeId
(
)
;
}
APZCTreeManager
*
InProcessCompositorSession
:
:
GetAPZCTreeManager
(
)
const
{
return
mCompositorBridgeParent
-
>
GetAPZCTreeManager
(
RootLayerTreeId
(
)
)
;
}
void
InProcessCompositorSession
:
:
Shutdown
(
)
{
RefPtr
<
CompositorBridgeChild
>
compositorChild
=
mCompositorBridgeChild
;
RefPtr
<
CompositorBridgeParent
>
compositorParent
=
mCompositorBridgeParent
;
mCompositorBridgeChild
-
>
Destroy
(
)
;
mCompositorBridgeChild
=
nullptr
;
}
}
}
