#
ifndef
_include_mozilla_gfx_ipc_GPUProcessManager_h_
#
define
_include_mozilla_gfx_ipc_GPUProcessManager_h_
#
include
"
base
/
basictypes
.
h
"
#
include
"
base
/
process
.
h
"
#
include
"
Units
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
dom
/
ipc
/
IdType
.
h
"
#
include
"
mozilla
/
gfx
/
GPUProcessHost
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
ipc
/
ProtocolUtils
.
h
"
#
include
"
mozilla
/
ipc
/
TaskFactory
.
h
"
#
include
"
mozilla
/
ipc
/
Transport
.
h
"
#
include
"
mozilla
/
webrender
/
WebRenderTypes
.
h
"
#
include
"
nsIObserverService
.
h
"
#
include
"
nsThreadUtils
.
h
"
class
nsBaseWidget
;
namespace
mozilla
{
class
MemoryReportingProcess
;
namespace
layers
{
class
IAPZCTreeManager
;
class
CompositorOptions
;
class
CompositorSession
;
class
CompositorUpdateObserver
;
class
PCompositorBridgeChild
;
class
PCompositorManagerChild
;
class
PImageBridgeChild
;
class
RemoteCompositorSession
;
class
InProcessCompositorSession
;
class
UiCompositorControllerChild
;
}
namespace
widget
{
class
CompositorWidget
;
}
namespace
dom
{
class
ContentParent
;
class
TabParent
;
class
PVideoDecoderManagerChild
;
}
namespace
ipc
{
class
GeckoChildProcessHost
;
}
namespace
gfx
{
class
GPUChild
;
class
GPUProcessListener
;
class
PVRManagerChild
;
class
VsyncBridgeChild
;
class
VsyncIOThreadHolder
;
class
GPUProcessManager
final
:
public
GPUProcessHost
:
:
Listener
{
friend
class
layers
:
:
RemoteCompositorSession
;
friend
class
layers
:
:
InProcessCompositorSession
;
typedef
layers
:
:
CompositorOptions
CompositorOptions
;
typedef
layers
:
:
CompositorSession
CompositorSession
;
typedef
layers
:
:
CompositorUpdateObserver
CompositorUpdateObserver
;
typedef
layers
:
:
IAPZCTreeManager
IAPZCTreeManager
;
typedef
layers
:
:
LayerManager
LayerManager
;
typedef
layers
:
:
PCompositorBridgeChild
PCompositorBridgeChild
;
typedef
layers
:
:
PCompositorManagerChild
PCompositorManagerChild
;
typedef
layers
:
:
PImageBridgeChild
PImageBridgeChild
;
typedef
layers
:
:
RemoteCompositorSession
RemoteCompositorSession
;
typedef
layers
:
:
InProcessCompositorSession
InProcessCompositorSession
;
typedef
layers
:
:
UiCompositorControllerChild
UiCompositorControllerChild
;
public
:
static
void
Initialize
(
)
;
static
void
Shutdown
(
)
;
static
GPUProcessManager
*
Get
(
)
;
~
GPUProcessManager
(
)
;
void
LaunchGPUProcess
(
)
;
bool
EnsureGPUReady
(
)
;
already_AddRefed
<
CompositorSession
>
CreateTopLevelCompositor
(
nsBaseWidget
*
aWidget
LayerManager
*
aLayerManager
CSSToLayoutDeviceScale
aScale
const
CompositorOptions
&
aOptions
bool
aUseExternalSurfaceSize
const
gfx
:
:
IntSize
&
aSurfaceSize
bool
*
aRetry
)
;
bool
CreateContentBridges
(
base
:
:
ProcessId
aOtherProcess
mozilla
:
:
ipc
:
:
Endpoint
<
PCompositorManagerChild
>
*
aOutCompositor
mozilla
:
:
ipc
:
:
Endpoint
<
PImageBridgeChild
>
*
aOutImageBridge
mozilla
:
:
ipc
:
:
Endpoint
<
PVRManagerChild
>
*
aOutVRBridge
mozilla
:
:
ipc
:
:
Endpoint
<
dom
:
:
PVideoDecoderManagerChild
>
*
aOutVideoManager
nsTArray
<
uint32_t
>
*
aNamespaces
)
;
void
MapLayerTreeId
(
uint64_t
aLayersId
base
:
:
ProcessId
aOwningId
)
;
void
UnmapLayerTreeId
(
uint64_t
aLayersId
base
:
:
ProcessId
aOwningId
)
;
bool
IsLayerTreeIdMapped
(
uint64_t
aLayersId
base
:
:
ProcessId
aRequestingId
)
;
uint64_t
AllocateLayerTreeId
(
)
;
uint32_t
AllocateNamespace
(
)
;
bool
AllocateAndConnectLayerTreeId
(
PCompositorBridgeChild
*
aCompositorBridge
base
:
:
ProcessId
aOtherPid
uint64_t
*
aOutLayersId
CompositorOptions
*
aOutCompositorOptions
)
;
void
ResetCompositors
(
)
;
void
OnProcessLaunchComplete
(
GPUProcessHost
*
aHost
)
override
;
void
OnProcessUnexpectedShutdown
(
GPUProcessHost
*
aHost
)
override
;
void
SimulateDeviceReset
(
)
;
void
DisableWebRender
(
wr
:
:
WebRenderError
aError
)
;
void
NotifyWebRenderError
(
wr
:
:
WebRenderError
aError
)
;
void
OnInProcessDeviceReset
(
)
;
void
OnRemoteProcessDeviceReset
(
GPUProcessHost
*
aHost
)
override
;
void
NotifyListenersOnCompositeDeviceReset
(
)
;
void
NotifyRemoteActorDestroyed
(
const
uint64_t
&
aProcessToken
)
;
void
AddListener
(
GPUProcessListener
*
aListener
)
;
void
RemoveListener
(
GPUProcessListener
*
aListener
)
;
bool
NotifyGpuObservers
(
const
char
*
aTopic
)
;
void
KillProcess
(
)
;
base
:
:
ProcessId
GPUProcessPid
(
)
;
RefPtr
<
MemoryReportingProcess
>
GetProcessMemoryReporter
(
)
;
GPUChild
*
GetGPUChild
(
)
{
return
mGPUChild
;
}
bool
AttemptedGPUProcess
(
)
const
{
return
mNumProcessAttempts
>
0
;
}
private
:
void
OnXPCOMShutdown
(
)
;
bool
CreateContentCompositorManager
(
base
:
:
ProcessId
aOtherProcess
mozilla
:
:
ipc
:
:
Endpoint
<
PCompositorManagerChild
>
*
aOutEndpoint
)
;
bool
CreateContentImageBridge
(
base
:
:
ProcessId
aOtherProcess
mozilla
:
:
ipc
:
:
Endpoint
<
PImageBridgeChild
>
*
aOutEndpoint
)
;
bool
CreateContentVRManager
(
base
:
:
ProcessId
aOtherProcess
mozilla
:
:
ipc
:
:
Endpoint
<
PVRManagerChild
>
*
aOutEndpoint
)
;
void
CreateContentVideoDecoderManager
(
base
:
:
ProcessId
aOtherProcess
mozilla
:
:
ipc
:
:
Endpoint
<
dom
:
:
PVideoDecoderManagerChild
>
*
aOutEndPoint
)
;
void
RegisterRemoteProcessSession
(
RemoteCompositorSession
*
aSession
)
;
void
UnregisterRemoteProcessSession
(
RemoteCompositorSession
*
aSession
)
;
void
RegisterInProcessSession
(
InProcessCompositorSession
*
aSession
)
;
void
UnregisterInProcessSession
(
InProcessCompositorSession
*
aSession
)
;
void
RebuildRemoteSessions
(
)
;
void
RebuildInProcessSessions
(
)
;
private
:
GPUProcessManager
(
)
;
void
DisableGPUProcess
(
const
char
*
aMessage
)
;
void
CleanShutdown
(
)
;
void
DestroyProcess
(
)
;
void
HandleProcessLost
(
)
;
void
EnsureVsyncIOThread
(
)
;
void
ShutdownVsyncIOThread
(
)
;
void
EnsureProtocolsReady
(
)
;
void
EnsureCompositorManagerChild
(
)
;
void
EnsureImageBridgeChild
(
)
;
void
EnsureVRManager
(
)
;
#
if
defined
(
MOZ_WIDGET_ANDROID
)
already_AddRefed
<
UiCompositorControllerChild
>
CreateUiCompositorController
(
nsBaseWidget
*
aWidget
const
uint64_t
aId
)
;
#
endif
RefPtr
<
CompositorSession
>
CreateRemoteSession
(
nsBaseWidget
*
aWidget
LayerManager
*
aLayerManager
const
uint64_t
&
aRootLayerTreeId
CSSToLayoutDeviceScale
aScale
const
CompositorOptions
&
aOptions
bool
aUseExternalSurfaceSize
const
gfx
:
:
IntSize
&
aSurfaceSize
)
;
DISALLOW_COPY_AND_ASSIGN
(
GPUProcessManager
)
;
class
Observer
final
:
public
nsIObserver
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIOBSERVER
explicit
Observer
(
GPUProcessManager
*
aManager
)
;
protected
:
~
Observer
(
)
{
}
GPUProcessManager
*
mManager
;
}
;
friend
class
Observer
;
private
:
bool
mDecodeVideoOnGpuProcess
=
true
;
RefPtr
<
Observer
>
mObserver
;
mozilla
:
:
ipc
:
:
TaskFactory
<
GPUProcessManager
>
mTaskFactory
;
RefPtr
<
VsyncIOThreadHolder
>
mVsyncIOThread
;
uint32_t
mNextNamespace
;
uint32_t
mIdNamespace
;
uint32_t
mResourceId
;
uint32_t
mNumProcessAttempts
;
nsTArray
<
RefPtr
<
RemoteCompositorSession
>
>
mRemoteSessions
;
nsTArray
<
RefPtr
<
InProcessCompositorSession
>
>
mInProcessSessions
;
nsTArray
<
GPUProcessListener
*
>
mListeners
;
uint32_t
mDeviceResetCount
;
TimeStamp
mDeviceResetLastTime
;
GPUProcessHost
*
mProcess
;
uint64_t
mProcessToken
;
GPUChild
*
mGPUChild
;
RefPtr
<
VsyncBridgeChild
>
mVsyncBridge
;
}
;
}
}
#
endif
