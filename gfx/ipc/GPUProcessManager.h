#
ifndef
_include_mozilla_gfx_ipc_GPUProcessManager_h_
#
define
_include_mozilla_gfx_ipc_GPUProcessManager_h_
#
include
"
base
/
basictypes
.
h
"
#
include
"
base
/
process
.
h
"
#
include
"
Units
.
h
"
#
include
"
mozilla
/
dom
/
ipc
/
IdType
.
h
"
#
include
"
mozilla
/
gfx
/
GPUProcessHost
.
h
"
#
include
"
mozilla
/
gfx
/
Point
.
h
"
#
include
"
mozilla
/
ipc
/
Transport
.
h
"
#
include
"
nsIObserverService
.
h
"
namespace
mozilla
{
namespace
layers
{
class
APZCTreeManager
;
class
CompositorSession
;
class
ClientLayerManager
;
class
CompositorUpdateObserver
;
class
PCompositorBridgeParent
;
}
namespace
widget
{
class
CompositorWidget
;
}
namespace
dom
{
class
ContentParent
;
class
TabParent
;
}
namespace
ipc
{
class
GeckoChildProcessHost
;
}
namespace
gfx
{
class
GPUChild
;
class
GPUProcessManager
final
:
public
GPUProcessHost
:
:
Listener
{
typedef
layers
:
:
APZCTreeManager
APZCTreeManager
;
typedef
layers
:
:
CompositorUpdateObserver
CompositorUpdateObserver
;
public
:
static
void
Initialize
(
)
;
static
void
Shutdown
(
)
;
static
GPUProcessManager
*
Get
(
)
;
~
GPUProcessManager
(
)
;
void
EnableGPUProcess
(
)
;
void
EnsureGPUReady
(
)
;
RefPtr
<
layers
:
:
CompositorSession
>
CreateTopLevelCompositor
(
nsIWidget
*
aWidget
layers
:
:
ClientLayerManager
*
aLayerManager
CSSToLayoutDeviceScale
aScale
bool
aUseAPZ
bool
aUseExternalSurfaceSize
const
gfx
:
:
IntSize
&
aSurfaceSize
)
;
layers
:
:
PCompositorBridgeParent
*
CreateTabCompositorBridge
(
ipc
:
:
Transport
*
aTransport
base
:
:
ProcessId
aOtherProcess
)
;
already_AddRefed
<
APZCTreeManager
>
GetAPZCTreeManagerForLayers
(
uint64_t
aLayersId
)
;
uint64_t
AllocateLayerTreeId
(
)
;
void
DeallocateLayerTreeId
(
uint64_t
aLayersId
)
;
void
RequestNotifyLayerTreeReady
(
uint64_t
aLayersId
CompositorUpdateObserver
*
aObserver
)
;
void
RequestNotifyLayerTreeCleared
(
uint64_t
aLayersId
CompositorUpdateObserver
*
aObserver
)
;
void
SwapLayerTreeObservers
(
uint64_t
aLayer
uint64_t
aOtherLayer
)
;
bool
UpdateRemoteContentController
(
uint64_t
aLayersId
dom
:
:
ContentParent
*
aContentParent
const
dom
:
:
TabId
&
aTabId
dom
:
:
TabParent
*
aBrowserParent
)
;
void
OnProcessLaunchComplete
(
GPUProcessHost
*
aHost
)
override
;
void
OnProcessUnexpectedShutdown
(
GPUProcessHost
*
aHost
)
override
;
GPUChild
*
GetGPUChild
(
)
{
return
mGPUChild
;
}
private
:
void
OnXPCOMShutdown
(
)
;
private
:
GPUProcessManager
(
)
;
void
DisableGPUProcess
(
const
char
*
aMessage
)
;
void
DestroyProcess
(
)
;
DISALLOW_COPY_AND_ASSIGN
(
GPUProcessManager
)
;
class
Observer
final
:
public
nsIObserver
{
public
:
NS_DECL_ISUPPORTS
NS_DECL_NSIOBSERVER
explicit
Observer
(
GPUProcessManager
*
aManager
)
;
protected
:
~
Observer
(
)
{
}
GPUProcessManager
*
mManager
;
}
;
friend
class
Observer
;
private
:
RefPtr
<
Observer
>
mObserver
;
GPUProcessHost
*
mProcess
;
GPUChild
*
mGPUChild
;
}
;
}
}
#
endif
