#
include
"
RenderWaylandDMABUFTextureHostOGL
.
h
"
#
include
"
GLContextEGL
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
ScopedGLHelpers
.
h
"
namespace
mozilla
{
namespace
wr
{
RenderWaylandDMABUFTextureHostOGL
:
:
RenderWaylandDMABUFTextureHostOGL
(
WaylandDMABufSurface
*
aSurface
)
:
mSurface
(
aSurface
)
mTextureTarget
(
LOCAL_GL_TEXTURE_2D
)
mTextureHandle
(
0
)
{
MOZ_COUNT_CTOR_INHERITED
(
RenderWaylandDMABUFTextureHostOGL
RenderTextureHostOGL
)
;
}
RenderWaylandDMABUFTextureHostOGL
:
:
~
RenderWaylandDMABUFTextureHostOGL
(
)
{
MOZ_COUNT_DTOR_INHERITED
(
RenderWaylandDMABUFTextureHostOGL
RenderTextureHostOGL
)
;
DeleteTextureHandle
(
)
;
}
GLuint
RenderWaylandDMABUFTextureHostOGL
:
:
GetGLHandle
(
uint8_t
aChannelIndex
)
const
{
MOZ_ASSERT
(
mSurface
)
;
return
mTextureHandle
;
}
gfx
:
:
IntSize
RenderWaylandDMABUFTextureHostOGL
:
:
GetSize
(
uint8_t
aChannelIndex
)
const
{
if
(
!
mSurface
)
{
return
gfx
:
:
IntSize
(
)
;
}
return
gfx
:
:
IntSize
(
mSurface
-
>
GetWidth
(
)
mSurface
-
>
GetHeight
(
)
)
;
}
wr
:
:
WrExternalImage
RenderWaylandDMABUFTextureHostOGL
:
:
Lock
(
uint8_t
aChannelIndex
gl
:
:
GLContext
*
aGL
wr
:
:
ImageRendering
aRendering
)
{
MOZ_ASSERT
(
aChannelIndex
=
=
0
)
;
if
(
mGL
.
get
(
)
!
=
aGL
)
{
if
(
mGL
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Unexpected
GL
context
"
)
;
return
InvalidToWrExternalImage
(
)
;
}
mGL
=
aGL
;
}
if
(
!
mGL
|
|
!
mGL
-
>
MakeCurrent
(
)
)
{
return
InvalidToWrExternalImage
(
)
;
}
if
(
!
mTextureHandle
)
{
if
(
!
mSurface
-
>
CreateEGLImage
(
mGL
)
)
{
return
InvalidToWrExternalImage
(
)
;
}
mTextureTarget
=
mGL
-
>
GetPreferredEGLImageTextureTarget
(
)
;
MOZ_ASSERT
(
mTextureTarget
=
=
LOCAL_GL_TEXTURE_2D
|
|
mTextureTarget
=
=
LOCAL_GL_TEXTURE_EXTERNAL
)
;
mGL
-
>
fGenTextures
(
1
&
mTextureHandle
)
;
mCachedRendering
=
aRendering
;
ActivateBindAndTexParameteri
(
mGL
LOCAL_GL_TEXTURE0
mTextureTarget
mTextureHandle
aRendering
)
;
mGL
-
>
fEGLImageTargetTexture2D
(
mTextureTarget
mSurface
-
>
GetEGLImage
(
)
)
;
}
else
if
(
IsFilterUpdateNecessary
(
aRendering
)
)
{
mCachedRendering
=
aRendering
;
ActivateBindAndTexParameteri
(
mGL
LOCAL_GL_TEXTURE0
mTextureTarget
mTextureHandle
aRendering
)
;
}
return
NativeTextureToWrExternalImage
(
mTextureHandle
0
0
mSurface
-
>
GetWidth
(
)
mSurface
-
>
GetHeight
(
)
)
;
}
void
RenderWaylandDMABUFTextureHostOGL
:
:
Unlock
(
)
{
}
void
RenderWaylandDMABUFTextureHostOGL
:
:
DeleteTextureHandle
(
)
{
if
(
mTextureHandle
)
{
mGL
-
>
fDeleteTextures
(
1
&
mTextureHandle
)
;
mTextureHandle
=
0
;
}
}
}
}
