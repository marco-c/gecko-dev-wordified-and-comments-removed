#
include
"
RenderAndroidSurfaceTextureHost
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
webrender
/
RenderThread
.
h
"
#
include
"
GLContext
.
h
"
namespace
mozilla
{
namespace
wr
{
RenderAndroidSurfaceTextureHost
:
:
RenderAndroidSurfaceTextureHost
(
const
java
:
:
GeckoSurfaceTexture
:
:
GlobalRef
&
aSurfTex
gfx
:
:
IntSize
aSize
gfx
:
:
SurfaceFormat
aFormat
bool
aContinuousUpdate
)
:
mSurfTex
(
aSurfTex
)
mSize
(
aSize
)
mFormat
(
aFormat
)
mContinuousUpdate
(
aContinuousUpdate
)
mPrepareStatus
(
STATUS_NONE
)
mAttachedToGLContext
(
false
)
{
MOZ_COUNT_CTOR_INHERITED
(
RenderAndroidSurfaceTextureHost
RenderTextureHost
)
;
if
(
mSurfTex
)
{
mSurfTex
-
>
IncrementUse
(
)
;
}
}
RenderAndroidSurfaceTextureHost
:
:
~
RenderAndroidSurfaceTextureHost
(
)
{
MOZ_ASSERT
(
RenderThread
:
:
IsInRenderThread
(
)
)
;
MOZ_COUNT_DTOR_INHERITED
(
RenderAndroidSurfaceTextureHost
RenderTextureHost
)
;
if
(
mSurfTex
)
{
mSurfTex
-
>
DecrementUse
(
)
;
}
}
wr
:
:
WrExternalImage
RenderAndroidSurfaceTextureHost
:
:
Lock
(
uint8_t
aChannelIndex
gl
:
:
GLContext
*
aGL
wr
:
:
ImageRendering
aRendering
)
{
MOZ_ASSERT
(
aChannelIndex
=
=
0
)
;
MOZ_ASSERT
(
(
mPrepareStatus
=
=
STATUS_PREPARED
)
|
|
(
!
mSurfTex
-
>
IsSingleBuffer
(
)
&
&
mPrepareStatus
=
=
STATUS_UPDATE_TEX_IMAGE_NEEDED
)
)
;
if
(
mGL
.
get
(
)
!
=
aGL
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Unexpected
GL
context
"
)
;
return
InvalidToWrExternalImage
(
)
;
}
if
(
!
mSurfTex
|
|
!
mGL
|
|
!
mGL
-
>
MakeCurrent
(
)
)
{
return
InvalidToWrExternalImage
(
)
;
}
MOZ_ASSERT
(
mAttachedToGLContext
)
;
if
(
!
mAttachedToGLContext
)
{
return
InvalidToWrExternalImage
(
)
;
}
if
(
IsFilterUpdateNecessary
(
aRendering
)
)
{
mCachedRendering
=
aRendering
;
ActivateBindAndTexParameteri
(
mGL
LOCAL_GL_TEXTURE0
LOCAL_GL_TEXTURE_EXTERNAL_OES
mSurfTex
-
>
GetTexName
(
)
aRendering
)
;
}
if
(
mContinuousUpdate
)
{
MOZ_ASSERT
(
!
mSurfTex
-
>
IsSingleBuffer
(
)
)
;
mSurfTex
-
>
UpdateTexImage
(
)
;
}
else
if
(
mPrepareStatus
=
=
STATUS_UPDATE_TEX_IMAGE_NEEDED
)
{
MOZ_ASSERT
(
!
mSurfTex
-
>
IsSingleBuffer
(
)
)
;
mSurfTex
-
>
UpdateTexImage
(
)
;
mPrepareStatus
=
STATUS_PREPARED
;
}
return
NativeTextureToWrExternalImage
(
mSurfTex
-
>
GetTexName
(
)
0
0
mSize
.
width
mSize
.
height
)
;
}
void
RenderAndroidSurfaceTextureHost
:
:
Unlock
(
)
{
}
bool
RenderAndroidSurfaceTextureHost
:
:
EnsureAttachedToGLContext
(
)
{
if
(
RenderThread
:
:
Get
(
)
-
>
IsHandlingWebRenderError
(
)
)
{
return
false
;
}
if
(
mAttachedToGLContext
)
{
return
true
;
}
if
(
!
mGL
)
{
mGL
=
RenderThread
:
:
Get
(
)
-
>
SharedGL
(
)
;
}
if
(
!
mSurfTex
|
|
!
mGL
|
|
!
mGL
-
>
MakeCurrent
(
)
)
{
return
false
;
}
if
(
!
mSurfTex
-
>
IsAttachedToGLContext
(
(
int64_t
)
mGL
.
get
(
)
)
)
{
GLuint
texName
;
mGL
-
>
fGenTextures
(
1
&
texName
)
;
ActivateBindAndTexParameteri
(
mGL
LOCAL_GL_TEXTURE0
LOCAL_GL_TEXTURE_EXTERNAL_OES
texName
mCachedRendering
)
;
if
(
NS_FAILED
(
mSurfTex
-
>
AttachToGLContext
(
(
int64_t
)
mGL
.
get
(
)
texName
)
)
)
{
MOZ_ASSERT
(
0
)
;
mGL
-
>
fDeleteTextures
(
1
&
texName
)
;
return
false
;
}
}
mAttachedToGLContext
=
true
;
return
true
;
}
void
RenderAndroidSurfaceTextureHost
:
:
PrepareForUse
(
)
{
MOZ_ASSERT
(
RenderThread
:
:
IsInRenderThread
(
)
)
;
MOZ_ASSERT
(
mPrepareStatus
=
=
STATUS_NONE
)
;
if
(
mContinuousUpdate
|
|
!
mSurfTex
)
{
return
;
}
mPrepareStatus
=
STATUS_MIGHT_BE_USED_BY_WR
;
if
(
mSurfTex
-
>
IsSingleBuffer
(
)
)
{
EnsureAttachedToGLContext
(
)
;
mSurfTex
-
>
UpdateTexImage
(
)
;
mPrepareStatus
=
STATUS_PREPARED
;
}
}
void
RenderAndroidSurfaceTextureHost
:
:
NotifyForUse
(
)
{
MOZ_ASSERT
(
RenderThread
:
:
IsInRenderThread
(
)
)
;
if
(
mPrepareStatus
=
=
STATUS_MIGHT_BE_USED_BY_WR
)
{
MOZ_ASSERT
(
!
mSurfTex
-
>
IsSingleBuffer
(
)
)
;
if
(
!
EnsureAttachedToGLContext
(
)
)
{
return
;
}
mPrepareStatus
=
STATUS_UPDATE_TEX_IMAGE_NEEDED
;
}
}
void
RenderAndroidSurfaceTextureHost
:
:
NotifyNotUsed
(
)
{
MOZ_ASSERT
(
RenderThread
:
:
IsInRenderThread
(
)
)
;
if
(
!
mSurfTex
)
{
MOZ_ASSERT
(
mPrepareStatus
=
=
STATUS_NONE
)
;
return
;
}
if
(
mSurfTex
-
>
IsSingleBuffer
(
)
)
{
MOZ_ASSERT
(
mPrepareStatus
=
=
STATUS_PREPARED
)
;
MOZ_ASSERT
(
mAttachedToGLContext
)
;
mGL
-
>
MakeCurrent
(
)
;
mSurfTex
-
>
ReleaseTexImage
(
)
;
}
else
if
(
mPrepareStatus
=
=
STATUS_UPDATE_TEX_IMAGE_NEEDED
)
{
MOZ_ASSERT
(
mAttachedToGLContext
)
;
mSurfTex
-
>
UpdateTexImage
(
)
;
}
mPrepareStatus
=
STATUS_NONE
;
}
}
}
