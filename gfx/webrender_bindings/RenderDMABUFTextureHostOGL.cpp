#
include
"
RenderDMABUFTextureHostOGL
.
h
"
#
include
"
GLContextEGL
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
ScopedGLHelpers
.
h
"
namespace
mozilla
:
:
wr
{
RenderDMABUFTextureHostOGL
:
:
RenderDMABUFTextureHostOGL
(
DMABufSurface
*
aSurface
)
:
mSurface
(
aSurface
)
{
MOZ_COUNT_CTOR_INHERITED
(
RenderDMABUFTextureHostOGL
RenderTextureHostOGL
)
;
}
RenderDMABUFTextureHostOGL
:
:
~
RenderDMABUFTextureHostOGL
(
)
{
MOZ_COUNT_DTOR_INHERITED
(
RenderDMABUFTextureHostOGL
RenderTextureHostOGL
)
;
DeleteTextureHandle
(
)
;
}
GLuint
RenderDMABUFTextureHostOGL
:
:
GetGLHandle
(
uint8_t
aChannelIndex
)
const
{
return
mSurface
-
>
GetTexture
(
aChannelIndex
)
;
}
gfx
:
:
IntSize
RenderDMABUFTextureHostOGL
:
:
GetSize
(
uint8_t
aChannelIndex
)
const
{
return
gfx
:
:
IntSize
(
mSurface
-
>
GetWidth
(
aChannelIndex
)
mSurface
-
>
GetHeight
(
aChannelIndex
)
)
;
}
wr
:
:
WrExternalImage
RenderDMABUFTextureHostOGL
:
:
Lock
(
uint8_t
aChannelIndex
gl
:
:
GLContext
*
aGL
wr
:
:
ImageRendering
aRendering
)
{
if
(
mGL
.
get
(
)
!
=
aGL
)
{
if
(
mGL
)
{
MOZ_ASSERT_UNREACHABLE
(
"
Unexpected
GL
context
"
)
;
return
InvalidToWrExternalImage
(
)
;
}
mGL
=
aGL
;
}
if
(
!
mGL
|
|
!
mGL
-
>
MakeCurrent
(
)
)
{
return
InvalidToWrExternalImage
(
)
;
}
bool
bindTexture
=
IsFilterUpdateNecessary
(
aRendering
)
;
if
(
!
mSurface
-
>
GetTexture
(
aChannelIndex
)
)
{
if
(
!
mSurface
-
>
CreateTexture
(
mGL
aChannelIndex
)
)
{
return
InvalidToWrExternalImage
(
)
;
}
bindTexture
=
true
;
}
if
(
bindTexture
)
{
mCachedRendering
=
aRendering
;
ActivateBindAndTexParameteri
(
mGL
LOCAL_GL_TEXTURE0
LOCAL_GL_TEXTURE_2D
mSurface
-
>
GetTexture
(
aChannelIndex
)
aRendering
)
;
}
return
NativeTextureToWrExternalImage
(
mSurface
-
>
GetTexture
(
aChannelIndex
)
0
0
mSurface
-
>
GetWidth
(
aChannelIndex
)
mSurface
-
>
GetHeight
(
aChannelIndex
)
)
;
}
void
RenderDMABUFTextureHostOGL
:
:
Unlock
(
)
{
}
void
RenderDMABUFTextureHostOGL
:
:
DeleteTextureHandle
(
)
{
mSurface
-
>
ReleaseTextures
(
)
;
}
}
