#
include
"
RenderCompositorSWGL
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
widget
/
CompositorWidget
.
h
"
namespace
mozilla
{
namespace
wr
{
UniquePtr
<
RenderCompositor
>
RenderCompositorSWGL
:
:
Create
(
RefPtr
<
widget
:
:
CompositorWidget
>
&
&
aWidget
nsACString
&
aError
)
{
void
*
ctx
=
wr_swgl_create_context
(
)
;
if
(
!
ctx
)
{
gfxCriticalNote
<
<
"
Failed
SWGL
context
creation
for
WebRender
"
;
return
nullptr
;
}
return
MakeUnique
<
RenderCompositorSWGL
>
(
std
:
:
move
(
aWidget
)
ctx
)
;
}
RenderCompositorSWGL
:
:
RenderCompositorSWGL
(
RefPtr
<
widget
:
:
CompositorWidget
>
&
&
aWidget
void
*
aContext
)
:
RenderCompositor
(
std
:
:
move
(
aWidget
)
)
mContext
(
aContext
)
{
MOZ_ASSERT
(
mContext
)
;
}
RenderCompositorSWGL
:
:
~
RenderCompositorSWGL
(
)
{
wr_swgl_destroy_context
(
mContext
)
;
}
void
RenderCompositorSWGL
:
:
ClearMappedBuffer
(
)
{
mMappedData
=
nullptr
;
mMappedStride
=
0
;
mDT
=
nullptr
;
}
bool
RenderCompositorSWGL
:
:
MakeCurrent
(
)
{
wr_swgl_make_current
(
mContext
)
;
return
true
;
}
bool
RenderCompositorSWGL
:
:
BeginFrame
(
)
{
ClearMappedBuffer
(
)
;
LayoutDeviceIntRect
bounds
(
LayoutDeviceIntPoint
(
)
GetBufferSize
(
)
)
;
mRegion
=
LayoutDeviceIntRegion
(
bounds
)
;
layers
:
:
BufferMode
bufferMode
=
layers
:
:
BufferMode
:
:
BUFFERED
;
mDT
=
mWidget
-
>
StartRemoteDrawingInRegion
(
mRegion
&
bufferMode
)
;
if
(
!
mDT
)
{
return
false
;
}
uint8_t
*
data
=
nullptr
;
gfx
:
:
IntSize
size
;
int32_t
stride
=
0
;
gfx
:
:
SurfaceFormat
format
=
gfx
:
:
SurfaceFormat
:
:
UNKNOWN
;
if
(
!
mSurface
&
&
mDT
-
>
LockBits
(
&
data
&
size
&
stride
&
format
)
&
&
(
size
!
=
bounds
.
Size
(
)
.
ToUnknownSize
(
)
|
|
(
format
!
=
gfx
:
:
SurfaceFormat
:
:
B8G8R8A8
&
&
format
!
=
gfx
:
:
SurfaceFormat
:
:
B8G8R8X8
)
)
)
{
mDT
-
>
ReleaseBits
(
data
)
;
data
=
nullptr
;
}
if
(
data
)
{
mMappedData
=
data
;
mMappedStride
=
stride
;
}
else
{
size
=
bounds
.
Size
(
)
.
ToUnknownSize
(
)
;
if
(
!
mSurface
|
|
mSurface
-
>
GetSize
(
)
!
=
size
)
{
mSurface
=
gfx
:
:
Factory
:
:
CreateDataSourceSurface
(
size
gfx
:
:
SurfaceFormat
:
:
B8G8R8A8
)
;
}
gfx
:
:
DataSourceSurface
:
:
MappedSurface
map
=
{
nullptr
0
}
;
if
(
!
mSurface
|
|
!
mSurface
-
>
Map
(
gfx
:
:
DataSourceSurface
:
:
READ_WRITE
&
map
)
)
{
mWidget
-
>
EndRemoteDrawingInRegion
(
mDT
mRegion
)
;
ClearMappedBuffer
(
)
;
return
false
;
}
mMappedData
=
map
.
mData
;
mMappedStride
=
map
.
mStride
;
}
MOZ_ASSERT
(
mMappedData
!
=
nullptr
&
&
mMappedStride
>
0
)
;
wr_swgl_make_current
(
mContext
)
;
wr_swgl_init_default_framebuffer
(
mContext
bounds
.
width
bounds
.
height
mMappedStride
mMappedData
)
;
return
true
;
}
void
RenderCompositorSWGL
:
:
CommitMappedBuffer
(
)
{
if
(
!
mDT
)
{
return
;
}
MOZ_ASSERT
(
mMappedData
!
=
nullptr
)
;
if
(
mSurface
)
{
mSurface
-
>
Unmap
(
)
;
for
(
auto
iter
=
mRegion
.
RectIter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
const
LayoutDeviceIntRect
&
dirtyRect
=
iter
.
Get
(
)
;
gfx
:
:
Rect
bounds
(
dirtyRect
.
x
dirtyRect
.
y
dirtyRect
.
width
dirtyRect
.
height
)
;
mDT
-
>
DrawSurface
(
mSurface
bounds
bounds
gfx
:
:
DrawSurfaceOptions
(
gfx
:
:
SamplingFilter
:
:
POINT
)
gfx
:
:
DrawOptions
(
1
.
0f
gfx
:
:
CompositionOp
:
:
OP_SOURCE
)
)
;
}
}
else
{
mDT
-
>
ReleaseBits
(
mMappedData
)
;
}
mWidget
-
>
EndRemoteDrawingInRegion
(
mDT
mRegion
)
;
ClearMappedBuffer
(
)
;
}
void
RenderCompositorSWGL
:
:
CancelFrame
(
)
{
CommitMappedBuffer
(
)
;
}
RenderedFrameId
RenderCompositorSWGL
:
:
EndFrame
(
const
nsTArray
<
DeviceIntRect
>
&
aDirtyRects
)
{
if
(
!
aDirtyRects
.
IsEmpty
(
)
)
{
mRegion
.
SetEmpty
(
)
;
for
(
auto
&
rect
:
aDirtyRects
)
{
mRegion
.
OrWith
(
LayoutDeviceIntRect
(
rect
.
origin
.
x
rect
.
origin
.
y
rect
.
size
.
width
rect
.
size
.
height
)
)
;
}
}
RenderedFrameId
frameId
=
GetNextRenderFrameId
(
)
;
CommitMappedBuffer
(
)
;
return
frameId
;
}
void
RenderCompositorSWGL
:
:
Pause
(
)
{
}
bool
RenderCompositorSWGL
:
:
Resume
(
)
{
return
true
;
}
LayoutDeviceIntSize
RenderCompositorSWGL
:
:
GetBufferSize
(
)
{
return
mWidget
-
>
GetClientSize
(
)
;
}
CompositorCapabilities
RenderCompositorSWGL
:
:
GetCompositorCapabilities
(
)
{
CompositorCapabilities
caps
;
caps
.
virtual_surface_size
=
0
;
return
caps
;
}
}
}
