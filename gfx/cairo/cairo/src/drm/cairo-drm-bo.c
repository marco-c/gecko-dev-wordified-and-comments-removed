#
include
"
cairoint
.
h
"
#
include
"
cairo
-
drm
-
private
.
h
"
#
include
"
cairo
-
error
-
private
.
h
"
#
include
<
sys
/
ioctl
.
h
>
#
include
<
errno
.
h
>
#
include
<
libdrm
/
drm
.
h
>
#
define
ERR_DEBUG
(
x
)
x
cairo_status_t
_cairo_drm_bo_open_for_name
(
const
cairo_drm_device_t
*
dev
cairo_drm_bo_t
*
bo
uint32_t
name
)
{
struct
drm_gem_open
open
;
int
ret
;
open
.
name
=
name
;
open
.
handle
=
0
;
open
.
size
=
0
;
do
{
ret
=
ioctl
(
dev
-
>
fd
DRM_IOCTL_GEM_OPEN
&
open
)
;
}
while
(
ret
=
=
-
1
&
&
errno
=
=
EINTR
)
;
if
(
ret
=
=
-
1
)
{
ERR_DEBUG
(
(
fprintf
(
stderr
"
Failed
to
open
bo
for
name
%
d
:
%
s
\
n
"
name
strerror
(
errno
)
)
)
)
;
return
_cairo_error
(
CAIRO_STATUS_NO_MEMORY
)
;
}
bo
-
>
name
=
name
;
bo
-
>
size
=
open
.
size
;
bo
-
>
handle
=
open
.
handle
;
return
CAIRO_STATUS_SUCCESS
;
}
cairo_status_t
_cairo_drm_bo_flink
(
const
cairo_drm_device_t
*
dev
cairo_drm_bo_t
*
bo
)
{
struct
drm_gem_flink
flink
;
int
ret
;
memset
(
&
flink
0
sizeof
(
flink
)
)
;
flink
.
handle
=
bo
-
>
handle
;
ret
=
ioctl
(
dev
-
>
fd
DRM_IOCTL_GEM_FLINK
&
flink
)
;
if
(
ret
=
=
-
1
)
{
ERR_DEBUG
(
(
fprintf
(
stderr
"
Failed
to
flink
bo
:
%
s
\
n
"
strerror
(
errno
)
)
)
)
;
return
_cairo_error
(
CAIRO_STATUS_NO_MEMORY
)
;
}
bo
-
>
name
=
flink
.
name
;
return
CAIRO_STATUS_SUCCESS
;
}
void
_cairo_drm_bo_close
(
const
cairo_drm_device_t
*
dev
cairo_drm_bo_t
*
bo
)
{
struct
drm_gem_close
close
;
int
ret
;
close
.
handle
=
bo
-
>
handle
;
do
{
ret
=
ioctl
(
dev
-
>
fd
DRM_IOCTL_GEM_CLOSE
&
close
)
;
}
while
(
ret
=
=
-
1
&
&
errno
=
=
EINTR
)
;
}
