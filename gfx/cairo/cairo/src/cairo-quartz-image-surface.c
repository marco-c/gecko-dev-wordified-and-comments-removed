#
include
"
cairoint
.
h
"
#
include
"
cairo
-
image
-
surface
-
inline
.
h
"
#
include
"
cairo
-
quartz
-
image
.
h
"
#
include
"
cairo
-
quartz
-
private
.
h
"
#
include
"
cairo
-
surface
-
backend
-
private
.
h
"
#
include
"
cairo
-
error
-
private
.
h
"
#
include
"
cairo
-
default
-
context
-
private
.
h
"
#
define
SURFACE_ERROR_NO_MEMORY
(
_cairo_surface_create_in_error
(
_cairo_error
(
CAIRO_STATUS_NO_MEMORY
)
)
)
#
define
SURFACE_ERROR_TYPE_MISMATCH
(
_cairo_surface_create_in_error
(
_cairo_error
(
CAIRO_STATUS_SURFACE_TYPE_MISMATCH
)
)
)
#
define
SURFACE_ERROR_INVALID_SIZE
(
_cairo_surface_create_in_error
(
_cairo_error
(
CAIRO_STATUS_INVALID_SIZE
)
)
)
#
define
SURFACE_ERROR_INVALID_FORMAT
(
_cairo_surface_create_in_error
(
_cairo_error
(
CAIRO_STATUS_INVALID_FORMAT
)
)
)
static
void
DataProviderReleaseCallback
(
void
*
image_info
const
void
*
data
size_t
size
)
{
free
(
image_info
)
;
}
static
cairo_surface_t
*
_cairo_quartz_image_surface_create_similar
(
void
*
asurface
cairo_content_t
content
int
width
int
height
)
{
cairo_surface_t
*
isurf
=
_cairo_image_surface_create_with_content
(
content
width
height
)
;
cairo_surface_t
*
result
=
cairo_quartz_image_surface_create
(
isurf
)
;
cairo_surface_destroy
(
isurf
)
;
return
result
;
}
static
cairo_surface_t
*
_cairo_quartz_image_surface_create_similar_image
(
void
*
asurface
cairo_format_t
format
int
width
int
height
)
{
cairo_surface_t
*
isurf
=
cairo_image_surface_create
(
format
width
height
)
;
cairo_surface_t
*
result
=
cairo_quartz_image_surface_create
(
isurf
)
;
cairo_surface_destroy
(
isurf
)
;
return
result
;
}
static
cairo_status_t
_cairo_quartz_image_surface_finish
(
void
*
asurface
)
{
cairo_quartz_image_surface_t
*
surface
=
(
cairo_quartz_image_surface_t
*
)
asurface
;
CGImageRelease
(
surface
-
>
image
)
;
cairo_surface_destroy
(
(
cairo_surface_t
*
)
surface
-
>
imageSurface
)
;
return
CAIRO_STATUS_SUCCESS
;
}
static
cairo_status_t
_cairo_quartz_image_surface_acquire_source_image
(
void
*
asurface
cairo_image_surface_t
*
*
image_out
void
*
*
image_extra
)
{
cairo_quartz_image_surface_t
*
surface
=
(
cairo_quartz_image_surface_t
*
)
asurface
;
*
image_out
=
surface
-
>
imageSurface
;
*
image_extra
=
NULL
;
return
CAIRO_STATUS_SUCCESS
;
}
static
cairo_image_surface_t
*
_cairo_quartz_image_surface_map_to_image
(
void
*
asurface
const
cairo_rectangle_int_t
*
extents
)
{
cairo_quartz_image_surface_t
*
surface
=
(
cairo_quartz_image_surface_t
*
)
asurface
;
return
_cairo_surface_map_to_image
(
&
surface
-
>
imageSurface
-
>
base
extents
)
;
}
static
cairo_int_status_t
_cairo_quartz_image_surface_unmap_image
(
void
*
asurface
cairo_image_surface_t
*
image
)
{
cairo_quartz_image_surface_t
*
surface
=
(
cairo_quartz_image_surface_t
*
)
asurface
;
return
_cairo_surface_unmap_image
(
&
surface
-
>
imageSurface
-
>
base
image
)
;
}
static
cairo_bool_t
_cairo_quartz_image_surface_get_extents
(
void
*
asurface
cairo_rectangle_int_t
*
extents
)
{
cairo_quartz_image_surface_t
*
surface
=
(
cairo_quartz_image_surface_t
*
)
asurface
;
extents
-
>
x
=
0
;
extents
-
>
y
=
0
;
extents
-
>
width
=
surface
-
>
width
;
extents
-
>
height
=
surface
-
>
height
;
return
TRUE
;
}
static
cairo_status_t
_cairo_quartz_image_surface_flush
(
void
*
asurface
unsigned
flags
)
{
cairo_quartz_image_surface_t
*
surface
=
(
cairo_quartz_image_surface_t
*
)
asurface
;
CGImageRef
oldImage
=
surface
-
>
image
;
CGImageRef
newImage
=
NULL
;
void
*
image_data
;
const
unsigned
int
size
=
surface
-
>
imageSurface
-
>
height
*
surface
-
>
imageSurface
-
>
stride
;
if
(
flags
)
return
CAIRO_STATUS_SUCCESS
;
image_data
=
_cairo_malloc_ab
(
surface
-
>
imageSurface
-
>
height
surface
-
>
imageSurface
-
>
stride
)
;
if
(
unlikely
(
!
image_data
)
)
return
_cairo_error
(
CAIRO_STATUS_NO_MEMORY
)
;
memcpy
(
image_data
surface
-
>
imageSurface
-
>
data
surface
-
>
imageSurface
-
>
height
*
surface
-
>
imageSurface
-
>
stride
)
;
newImage
=
CairoQuartzCreateCGImage
(
surface
-
>
imageSurface
-
>
format
surface
-
>
imageSurface
-
>
width
surface
-
>
imageSurface
-
>
height
surface
-
>
imageSurface
-
>
stride
image_data
TRUE
NULL
DataProviderReleaseCallback
image_data
)
;
surface
-
>
image
=
newImage
;
CGImageRelease
(
oldImage
)
;
return
CAIRO_STATUS_SUCCESS
;
}
static
cairo_int_status_t
_cairo_quartz_image_surface_paint
(
void
*
abstract_surface
cairo_operator_t
op
const
cairo_pattern_t
*
source
const
cairo_clip_t
*
clip
)
{
cairo_quartz_image_surface_t
*
surface
=
abstract_surface
;
return
_cairo_surface_paint
(
&
surface
-
>
imageSurface
-
>
base
op
source
clip
)
;
}
static
cairo_int_status_t
_cairo_quartz_image_surface_mask
(
void
*
abstract_surface
cairo_operator_t
op
const
cairo_pattern_t
*
source
const
cairo_pattern_t
*
mask
const
cairo_clip_t
*
clip
)
{
cairo_quartz_image_surface_t
*
surface
=
abstract_surface
;
return
_cairo_surface_mask
(
&
surface
-
>
imageSurface
-
>
base
op
source
mask
clip
)
;
}
static
cairo_int_status_t
_cairo_quartz_image_surface_stroke
(
void
*
abstract_surface
cairo_operator_t
op
const
cairo_pattern_t
*
source
const
cairo_path_fixed_t
*
path
const
cairo_stroke_style_t
*
style
const
cairo_matrix_t
*
ctm
const
cairo_matrix_t
*
ctm_inverse
double
tolerance
cairo_antialias_t
antialias
const
cairo_clip_t
*
clip
)
{
cairo_quartz_image_surface_t
*
surface
=
abstract_surface
;
return
_cairo_surface_stroke
(
&
surface
-
>
imageSurface
-
>
base
op
source
path
style
ctm
ctm_inverse
tolerance
antialias
clip
)
;
}
static
cairo_int_status_t
_cairo_quartz_image_surface_fill
(
void
*
abstract_surface
cairo_operator_t
op
const
cairo_pattern_t
*
source
const
cairo_path_fixed_t
*
path
cairo_fill_rule_t
fill_rule
double
tolerance
cairo_antialias_t
antialias
const
cairo_clip_t
*
clip
)
{
cairo_quartz_image_surface_t
*
surface
=
abstract_surface
;
return
_cairo_surface_fill
(
&
surface
-
>
imageSurface
-
>
base
op
source
path
fill_rule
tolerance
antialias
clip
)
;
}
static
cairo_int_status_t
_cairo_quartz_image_surface_glyphs
(
void
*
abstract_surface
cairo_operator_t
op
const
cairo_pattern_t
*
source
cairo_glyph_t
*
glyphs
int
num_glyphs
cairo_scaled_font_t
*
scaled_font
const
cairo_clip_t
*
clip
)
{
cairo_quartz_image_surface_t
*
surface
=
abstract_surface
;
return
_cairo_surface_show_text_glyphs
(
&
surface
-
>
imageSurface
-
>
base
op
source
NULL
0
glyphs
num_glyphs
NULL
0
0
scaled_font
clip
)
;
}
static
const
cairo_surface_backend_t
cairo_quartz_image_surface_backend
=
{
CAIRO_SURFACE_TYPE_QUARTZ_IMAGE
_cairo_quartz_image_surface_finish
_cairo_default_context_create
_cairo_quartz_image_surface_create_similar
_cairo_quartz_image_surface_create_similar_image
_cairo_quartz_image_surface_map_to_image
_cairo_quartz_image_surface_unmap_image
_cairo_surface_default_source
_cairo_quartz_image_surface_acquire_source_image
NULL
NULL
NULL
NULL
_cairo_quartz_image_surface_get_extents
NULL
_cairo_quartz_image_surface_flush
NULL
_cairo_quartz_image_surface_paint
_cairo_quartz_image_surface_mask
_cairo_quartz_image_surface_stroke
_cairo_quartz_image_surface_fill
NULL
_cairo_quartz_image_surface_glyphs
}
;
cairo_surface_t
*
cairo_quartz_image_surface_create
(
cairo_surface_t
*
surface
)
{
cairo_quartz_image_surface_t
*
qisurf
;
CGImageRef
image
;
cairo_image_surface_t
*
image_surface
;
int
width
height
stride
;
cairo_format_t
format
;
void
*
image_data
;
if
(
surface
-
>
status
)
return
surface
;
if
(
!
_cairo_surface_is_image
(
surface
)
)
return
SURFACE_ERROR_TYPE_MISMATCH
;
image_surface
=
(
cairo_image_surface_t
*
)
surface
;
width
=
image_surface
-
>
width
;
height
=
image_surface
-
>
height
;
stride
=
image_surface
-
>
stride
;
format
=
image_surface
-
>
format
;
if
(
!
_cairo_quartz_verify_surface_size
(
width
height
)
)
return
SURFACE_ERROR_INVALID_SIZE
;
if
(
width
=
=
0
|
|
height
=
=
0
)
return
SURFACE_ERROR_INVALID_SIZE
;
if
(
format
!
=
CAIRO_FORMAT_ARGB32
&
&
format
!
=
CAIRO_FORMAT_RGB24
)
return
SURFACE_ERROR_INVALID_FORMAT
;
qisurf
=
_cairo_malloc
(
sizeof
(
cairo_quartz_image_surface_t
)
)
;
if
(
qisurf
=
=
NULL
)
return
SURFACE_ERROR_NO_MEMORY
;
memset
(
qisurf
0
sizeof
(
cairo_quartz_image_surface_t
)
)
;
image_data
=
_cairo_malloc_ab
(
height
stride
)
;
if
(
unlikely
(
!
image_data
)
)
{
free
(
qisurf
)
;
return
SURFACE_ERROR_NO_MEMORY
;
}
memcpy
(
image_data
image_surface
-
>
data
height
*
stride
)
;
image
=
CairoQuartzCreateCGImage
(
format
width
height
stride
image_data
TRUE
NULL
DataProviderReleaseCallback
image_data
)
;
if
(
!
image
)
{
free
(
qisurf
)
;
return
SURFACE_ERROR_NO_MEMORY
;
}
_cairo_surface_init
(
&
qisurf
-
>
base
&
cairo_quartz_image_surface_backend
NULL
_cairo_content_from_format
(
format
)
FALSE
)
;
qisurf
-
>
width
=
width
;
qisurf
-
>
height
=
height
;
qisurf
-
>
image
=
image
;
qisurf
-
>
imageSurface
=
(
cairo_image_surface_t
*
)
cairo_surface_reference
(
surface
)
;
return
&
qisurf
-
>
base
;
}
cairo_surface_t
*
cairo_quartz_image_surface_get_image
(
cairo_surface_t
*
asurface
)
{
cairo_quartz_image_surface_t
*
surface
=
(
cairo_quartz_image_surface_t
*
)
asurface
;
if
(
!
_cairo_surface_is_quartz
(
asurface
)
)
{
return
SURFACE_ERROR_TYPE_MISMATCH
;
}
return
(
cairo_surface_t
*
)
surface
-
>
imageSurface
;
}
cairo_bool_t
_cairo_surface_is_quartz_image
(
const
cairo_surface_t
*
surface
)
{
return
surface
-
>
backend
=
=
&
cairo_quartz_image_surface_backend
;
}
cairo_bool_t
_cairo_quartz_image_surface_is_zero
(
const
cairo_quartz_image_surface_t
*
surface
)
{
return
surface
-
>
width
=
=
0
|
|
surface
-
>
height
=
=
0
;
}
