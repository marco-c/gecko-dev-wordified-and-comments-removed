#
ifndef
mozilla_BasePrincipal_h
#
define
mozilla_BasePrincipal_h
#
include
"
nsIPrincipal
.
h
"
#
include
"
nsIScriptSecurityManager
.
h
"
#
include
"
nsJSPrincipals
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
dom
/
ChromeUtilsBinding
.
h
"
class
nsIContentSecurityPolicy
;
class
nsIObjectOutputStream
;
class
nsIObjectInputStream
;
class
nsIURI
;
class
nsExpandedPrincipal
;
namespace
mozilla
{
class
GenericOriginAttributes
;
class
OriginAttributes
:
public
dom
:
:
OriginAttributesDictionary
{
public
:
bool
operator
=
=
(
const
OriginAttributes
&
aOther
)
const
{
return
mAppId
=
=
aOther
.
mAppId
&
&
mInIsolatedMozBrowser
=
=
aOther
.
mInIsolatedMozBrowser
&
&
mAddonId
=
=
aOther
.
mAddonId
&
&
mUserContextId
=
=
aOther
.
mUserContextId
&
&
mSignedPkg
=
=
aOther
.
mSignedPkg
&
&
mPrivateBrowsingId
=
=
aOther
.
mPrivateBrowsingId
&
&
mFirstPartyDomain
=
=
aOther
.
mFirstPartyDomain
;
}
bool
operator
!
=
(
const
OriginAttributes
&
aOther
)
const
{
return
!
(
*
this
=
=
aOther
)
;
}
void
CreateSuffix
(
nsACString
&
aStr
)
const
;
MOZ_MUST_USE
bool
PopulateFromSuffix
(
const
nsACString
&
aStr
)
;
MOZ_MUST_USE
bool
PopulateFromOrigin
(
const
nsACString
&
aOrigin
nsACString
&
aOriginNoSuffix
)
;
void
SyncAttributesWithPrivateBrowsing
(
bool
aInPrivateBrowsing
)
;
void
SetFromGenericAttributes
(
const
GenericOriginAttributes
&
aAttrs
)
;
protected
:
OriginAttributes
(
)
{
}
explicit
OriginAttributes
(
const
OriginAttributesDictionary
&
aOther
)
:
OriginAttributesDictionary
(
aOther
)
{
}
bool
IsFirstPartyEnabled
(
)
;
}
;
class
PrincipalOriginAttributes
;
class
DocShellOriginAttributes
;
class
NeckoOriginAttributes
;
class
PrincipalOriginAttributes
:
public
OriginAttributes
{
public
:
PrincipalOriginAttributes
(
)
{
}
PrincipalOriginAttributes
(
uint32_t
aAppId
bool
aInIsolatedMozBrowser
)
{
mAppId
=
aAppId
;
mInIsolatedMozBrowser
=
aInIsolatedMozBrowser
;
}
void
InheritFromDocShellToDoc
(
const
DocShellOriginAttributes
&
aAttrs
const
nsIURI
*
aURI
)
;
void
InheritFromNecko
(
const
NeckoOriginAttributes
&
aAttrs
)
;
void
StripUserContextIdAndFirstPartyDomain
(
)
;
}
;
class
DocShellOriginAttributes
:
public
OriginAttributes
{
public
:
DocShellOriginAttributes
(
)
{
}
DocShellOriginAttributes
(
uint32_t
aAppId
bool
aInIsolatedMozBrowser
)
{
mAppId
=
aAppId
;
mInIsolatedMozBrowser
=
aInIsolatedMozBrowser
;
}
void
InheritFromDocToChildDocShell
(
const
PrincipalOriginAttributes
&
aAttrs
)
;
}
;
class
NeckoOriginAttributes
:
public
OriginAttributes
{
public
:
NeckoOriginAttributes
(
)
{
}
NeckoOriginAttributes
(
uint32_t
aAppId
bool
aInIsolatedMozBrowser
)
{
mAppId
=
aAppId
;
mInIsolatedMozBrowser
=
aInIsolatedMozBrowser
;
}
void
InheritFromDocToNecko
(
const
PrincipalOriginAttributes
&
aAttrs
)
;
void
InheritFromDocShellToNecko
(
const
DocShellOriginAttributes
&
aAttrs
const
bool
aIsTopLevelDocument
=
false
nsIURI
*
aURI
=
nullptr
)
;
}
;
class
GenericOriginAttributes
:
public
OriginAttributes
{
public
:
GenericOriginAttributes
(
)
{
}
explicit
GenericOriginAttributes
(
const
OriginAttributesDictionary
&
aOther
)
:
OriginAttributes
(
aOther
)
{
}
}
;
class
OriginAttributesPattern
:
public
dom
:
:
OriginAttributesPatternDictionary
{
public
:
OriginAttributesPattern
(
)
{
}
explicit
OriginAttributesPattern
(
const
OriginAttributesPatternDictionary
&
aOther
)
:
OriginAttributesPatternDictionary
(
aOther
)
{
}
bool
Matches
(
const
OriginAttributes
&
aAttrs
)
const
{
if
(
mAppId
.
WasPassed
(
)
&
&
mAppId
.
Value
(
)
!
=
aAttrs
.
mAppId
)
{
return
false
;
}
if
(
mInIsolatedMozBrowser
.
WasPassed
(
)
&
&
mInIsolatedMozBrowser
.
Value
(
)
!
=
aAttrs
.
mInIsolatedMozBrowser
)
{
return
false
;
}
if
(
mAddonId
.
WasPassed
(
)
&
&
mAddonId
.
Value
(
)
!
=
aAttrs
.
mAddonId
)
{
return
false
;
}
if
(
mUserContextId
.
WasPassed
(
)
&
&
mUserContextId
.
Value
(
)
!
=
aAttrs
.
mUserContextId
)
{
return
false
;
}
if
(
mSignedPkg
.
WasPassed
(
)
&
&
mSignedPkg
.
Value
(
)
!
=
aAttrs
.
mSignedPkg
)
{
return
false
;
}
if
(
mPrivateBrowsingId
.
WasPassed
(
)
&
&
mPrivateBrowsingId
.
Value
(
)
!
=
aAttrs
.
mPrivateBrowsingId
)
{
return
false
;
}
if
(
mFirstPartyDomain
.
WasPassed
(
)
&
&
mFirstPartyDomain
.
Value
(
)
!
=
aAttrs
.
mFirstPartyDomain
)
{
return
false
;
}
return
true
;
}
bool
Overlaps
(
const
OriginAttributesPattern
&
aOther
)
const
{
if
(
mAppId
.
WasPassed
(
)
&
&
aOther
.
mAppId
.
WasPassed
(
)
&
&
mAppId
.
Value
(
)
!
=
aOther
.
mAppId
.
Value
(
)
)
{
return
false
;
}
if
(
mInIsolatedMozBrowser
.
WasPassed
(
)
&
&
aOther
.
mInIsolatedMozBrowser
.
WasPassed
(
)
&
&
mInIsolatedMozBrowser
.
Value
(
)
!
=
aOther
.
mInIsolatedMozBrowser
.
Value
(
)
)
{
return
false
;
}
if
(
mAddonId
.
WasPassed
(
)
&
&
aOther
.
mAddonId
.
WasPassed
(
)
&
&
mAddonId
.
Value
(
)
!
=
aOther
.
mAddonId
.
Value
(
)
)
{
return
false
;
}
if
(
mUserContextId
.
WasPassed
(
)
&
&
aOther
.
mUserContextId
.
WasPassed
(
)
&
&
mUserContextId
.
Value
(
)
!
=
aOther
.
mUserContextId
.
Value
(
)
)
{
return
false
;
}
if
(
mSignedPkg
.
WasPassed
(
)
&
&
aOther
.
mSignedPkg
.
WasPassed
(
)
&
&
mSignedPkg
.
Value
(
)
!
=
aOther
.
mSignedPkg
.
Value
(
)
)
{
return
false
;
}
if
(
mPrivateBrowsingId
.
WasPassed
(
)
&
&
aOther
.
mPrivateBrowsingId
.
WasPassed
(
)
&
&
mPrivateBrowsingId
.
Value
(
)
!
=
aOther
.
mPrivateBrowsingId
.
Value
(
)
)
{
return
false
;
}
if
(
mFirstPartyDomain
.
WasPassed
(
)
&
&
aOther
.
mFirstPartyDomain
.
WasPassed
(
)
&
&
mFirstPartyDomain
.
Value
(
)
!
=
aOther
.
mFirstPartyDomain
.
Value
(
)
)
{
return
false
;
}
return
true
;
}
}
;
class
BasePrincipal
:
public
nsJSPrincipals
{
public
:
BasePrincipal
(
)
;
enum
DocumentDomainConsideration
{
DontConsiderDocumentDomain
ConsiderDocumentDomain
}
;
bool
Subsumes
(
nsIPrincipal
*
aOther
DocumentDomainConsideration
aConsideration
)
;
NS_IMETHOD
GetOrigin
(
nsACString
&
aOrigin
)
final
;
NS_IMETHOD
GetOriginNoSuffix
(
nsACString
&
aOrigin
)
final
;
NS_IMETHOD
Equals
(
nsIPrincipal
*
other
bool
*
_retval
)
final
;
NS_IMETHOD
EqualsConsideringDomain
(
nsIPrincipal
*
other
bool
*
_retval
)
final
;
NS_IMETHOD
Subsumes
(
nsIPrincipal
*
other
bool
*
_retval
)
final
;
NS_IMETHOD
SubsumesConsideringDomain
(
nsIPrincipal
*
other
bool
*
_retval
)
final
;
NS_IMETHOD
CheckMayLoad
(
nsIURI
*
uri
bool
report
bool
allowIfInheritsPrincipal
)
final
;
NS_IMETHOD
GetCsp
(
nsIContentSecurityPolicy
*
*
aCsp
)
override
;
NS_IMETHOD
EnsureCSP
(
nsIDOMDocument
*
aDocument
nsIContentSecurityPolicy
*
*
aCSP
)
override
;
NS_IMETHOD
GetPreloadCsp
(
nsIContentSecurityPolicy
*
*
aPreloadCSP
)
override
;
NS_IMETHOD
EnsurePreloadCSP
(
nsIDOMDocument
*
aDocument
nsIContentSecurityPolicy
*
*
aCSP
)
override
;
NS_IMETHOD
GetCspJSON
(
nsAString
&
outCSPinJSON
)
override
;
NS_IMETHOD
GetIsNullPrincipal
(
bool
*
aResult
)
override
;
NS_IMETHOD
GetIsCodebasePrincipal
(
bool
*
aResult
)
override
;
NS_IMETHOD
GetIsExpandedPrincipal
(
bool
*
aResult
)
override
;
NS_IMETHOD
GetIsSystemPrincipal
(
bool
*
aResult
)
override
;
NS_IMETHOD
GetJarPrefix
(
nsACString
&
aJarPrefix
)
final
;
NS_IMETHOD
GetOriginAttributes
(
JSContext
*
aCx
JS
:
:
MutableHandle
<
JS
:
:
Value
>
aVal
)
final
;
NS_IMETHOD
GetOriginSuffix
(
nsACString
&
aOriginSuffix
)
final
;
NS_IMETHOD
GetAppStatus
(
uint16_t
*
aAppStatus
)
final
;
NS_IMETHOD
GetAppId
(
uint32_t
*
aAppStatus
)
final
;
NS_IMETHOD
GetAddonId
(
nsAString
&
aAddonId
)
final
;
NS_IMETHOD
GetIsInIsolatedMozBrowserElement
(
bool
*
aIsInIsolatedMozBrowserElement
)
final
;
NS_IMETHOD
GetUnknownAppId
(
bool
*
aUnknownAppId
)
final
;
NS_IMETHOD
GetUserContextId
(
uint32_t
*
aUserContextId
)
final
;
NS_IMETHOD
GetPrivateBrowsingId
(
uint32_t
*
aPrivateBrowsingId
)
final
;
virtual
bool
AddonHasPermission
(
const
nsAString
&
aPerm
)
;
virtual
bool
IsOnCSSUnprefixingWhitelist
(
)
override
{
return
false
;
}
virtual
bool
IsCodebasePrincipal
(
)
const
{
return
false
;
}
;
static
BasePrincipal
*
Cast
(
nsIPrincipal
*
aPrin
)
{
return
static_cast
<
BasePrincipal
*
>
(
aPrin
)
;
}
static
already_AddRefed
<
BasePrincipal
>
CreateCodebasePrincipal
(
nsIURI
*
aURI
const
PrincipalOriginAttributes
&
aAttrs
)
;
static
already_AddRefed
<
BasePrincipal
>
CreateCodebasePrincipal
(
const
nsACString
&
aOrigin
)
;
const
PrincipalOriginAttributes
&
OriginAttributesRef
(
)
{
return
mOriginAttributes
;
}
uint32_t
AppId
(
)
const
{
return
mOriginAttributes
.
mAppId
;
}
uint32_t
UserContextId
(
)
const
{
return
mOriginAttributes
.
mUserContextId
;
}
uint32_t
PrivateBrowsingId
(
)
const
{
return
mOriginAttributes
.
mPrivateBrowsingId
;
}
bool
IsInIsolatedMozBrowserElement
(
)
const
{
return
mOriginAttributes
.
mInIsolatedMozBrowser
;
}
enum
PrincipalKind
{
eNullPrincipal
eCodebasePrincipal
eExpandedPrincipal
eSystemPrincipal
}
;
virtual
PrincipalKind
Kind
(
)
=
0
;
already_AddRefed
<
BasePrincipal
>
CloneStrippingUserContextIdAndFirstPartyDomain
(
)
;
protected
:
virtual
~
BasePrincipal
(
)
;
virtual
nsresult
GetOriginInternal
(
nsACString
&
aOrigin
)
=
0
;
virtual
bool
SubsumesInternal
(
nsIPrincipal
*
aOther
DocumentDomainConsideration
aConsider
)
=
0
;
virtual
bool
MayLoadInternal
(
nsIURI
*
aURI
)
=
0
;
friend
class
:
:
nsExpandedPrincipal
;
bool
AddonAllowsLoad
(
nsIURI
*
aURI
)
;
nsCOMPtr
<
nsIContentSecurityPolicy
>
mCSP
;
nsCOMPtr
<
nsIContentSecurityPolicy
>
mPreloadCSP
;
PrincipalOriginAttributes
mOriginAttributes
;
}
;
}
#
endif
