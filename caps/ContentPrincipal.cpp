#
include
"
ContentPrincipal
.
h
"
#
include
"
mozIThirdPartyUtil
.
h
"
#
include
"
nscore
.
h
"
#
include
"
nsScriptSecurityManager
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsReadableUtils
.
h
"
#
include
"
pratom
.
h
"
#
include
"
nsIURI
.
h
"
#
include
"
nsIURL
.
h
"
#
include
"
nsIStandardURL
.
h
"
#
include
"
nsIURIWithPrincipal
.
h
"
#
include
"
nsJSPrincipals
.
h
"
#
include
"
nsIEffectiveTLDService
.
h
"
#
include
"
nsIClassInfoImpl
.
h
"
#
include
"
nsIObjectInputStream
.
h
"
#
include
"
nsIObjectOutputStream
.
h
"
#
include
"
nsIProtocolHandler
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsIContentSecurityPolicy
.
h
"
#
include
"
nsNetCID
.
h
"
#
include
"
js
/
Wrapper
.
h
"
#
include
"
mozilla
/
dom
/
nsCSPContext
.
h
"
#
include
"
mozilla
/
dom
/
ScriptSettings
.
h
"
#
include
"
mozilla
/
ClearOnShutdown
.
h
"
#
include
"
mozilla
/
ExtensionPolicyService
.
h
"
#
include
"
mozilla
/
NullPrincipal
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
HashFunctions
.
h
"
using
namespace
mozilla
;
static
inline
ExtensionPolicyService
&
EPS
(
)
{
return
ExtensionPolicyService
:
:
GetSingleton
(
)
;
}
NS_IMPL_CLASSINFO
(
ContentPrincipal
nullptr
nsIClassInfo
:
:
MAIN_THREAD_ONLY
NS_PRINCIPAL_CID
)
NS_IMPL_QUERY_INTERFACE_CI
(
ContentPrincipal
nsIPrincipal
nsISerializable
)
NS_IMPL_CI_INTERFACE_GETTER
(
ContentPrincipal
nsIPrincipal
nsISerializable
)
ContentPrincipal
:
:
ContentPrincipal
(
)
:
BasePrincipal
(
eCodebasePrincipal
)
{
}
ContentPrincipal
:
:
~
ContentPrincipal
(
)
{
if
(
mCSP
)
{
static_cast
<
nsCSPContext
*
>
(
mCSP
.
get
(
)
)
-
>
clearLoadingPrincipal
(
)
;
}
}
nsresult
ContentPrincipal
:
:
Init
(
nsIURI
*
aCodebase
const
OriginAttributes
&
aOriginAttributes
const
nsACString
&
aOriginNoSuffix
)
{
NS_ENSURE_ARG
(
aCodebase
)
;
bool
hasFlag
;
Unused
<
<
hasFlag
;
MOZ_DIAGNOSTIC_ASSERT
(
NS_SUCCEEDED
(
NS_URIChainHasFlags
(
aCodebase
nsIProtocolHandler
:
:
URI_INHERITS_SECURITY_CONTEXT
&
hasFlag
)
)
&
&
!
hasFlag
)
;
mCodebase
=
aCodebase
;
FinishInit
(
aOriginNoSuffix
aOriginAttributes
)
;
return
NS_OK
;
}
nsresult
ContentPrincipal
:
:
GetScriptLocation
(
nsACString
&
aStr
)
{
return
mCodebase
-
>
GetSpec
(
aStr
)
;
}
nsresult
ContentPrincipal
:
:
GenerateOriginNoSuffixFromURI
(
nsIURI
*
aURI
nsACString
&
aOriginNoSuffix
)
{
if
(
!
aURI
)
{
return
NS_ERROR_FAILURE
;
}
nsCOMPtr
<
nsIURI
>
origin
=
NS_GetInnermostURI
(
aURI
)
;
if
(
!
origin
)
{
return
NS_ERROR_FAILURE
;
}
MOZ_ASSERT
(
!
NS_IsAboutBlank
(
origin
)
"
The
inner
URI
for
about
:
blank
must
be
moz
-
safe
-
about
:
blank
"
)
;
if
(
!
nsScriptSecurityManager
:
:
GetStrictFileOriginPolicy
(
)
&
&
NS_URIIsLocalFile
(
origin
)
)
{
aOriginNoSuffix
.
AssignLiteral
(
"
file
:
/
/
UNIVERSAL_FILE_URI_ORIGIN
"
)
;
return
NS_OK
;
}
nsresult
rv
;
#
if
IS_ORIGIN_IS_FULL_SPEC_DEFINED
bool
fullSpec
=
false
;
rv
=
NS_URIChainHasFlags
(
origin
nsIProtocolHandler
:
:
ORIGIN_IS_FULL_SPEC
&
fullSpec
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
fullSpec
)
{
return
origin
-
>
GetAsciiSpec
(
aOriginNoSuffix
)
;
}
#
endif
bool
isBehaved
;
if
(
(
NS_SUCCEEDED
(
origin
-
>
SchemeIs
(
"
about
"
&
isBehaved
)
)
&
&
isBehaved
)
|
|
(
NS_SUCCEEDED
(
origin
-
>
SchemeIs
(
"
moz
-
safe
-
about
"
&
isBehaved
)
)
&
&
isBehaved
&
&
!
origin
-
>
GetSpecOrDefault
(
)
.
EqualsLiteral
(
"
moz
-
safe
-
about
:
blank
"
)
)
|
|
(
NS_SUCCEEDED
(
origin
-
>
SchemeIs
(
"
indexeddb
"
&
isBehaved
)
)
&
&
isBehaved
)
)
{
rv
=
origin
-
>
GetAsciiSpec
(
aOriginNoSuffix
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
NS_WARN_IF
(
aOriginNoSuffix
.
FindChar
(
'
^
'
0
)
!
=
-
1
)
)
{
aOriginNoSuffix
.
Truncate
(
)
;
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
nsCOMPtr
<
nsIURIWithPrincipal
>
uriWithPrincipal
=
do_QueryInterface
(
origin
)
;
if
(
uriWithPrincipal
)
{
nsCOMPtr
<
nsIPrincipal
>
uriPrincipal
;
rv
=
uriWithPrincipal
-
>
GetPrincipal
(
getter_AddRefs
(
uriPrincipal
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
!
uriPrincipal
)
{
uriPrincipal
=
NullPrincipal
:
:
CreateWithoutOriginAttributes
(
)
;
MOZ_ASSERT
(
uriPrincipal
)
;
}
return
uriPrincipal
-
>
GetOriginNoSuffix
(
aOriginNoSuffix
)
;
}
nsCOMPtr
<
nsIStandardURL
>
standardURL
=
do_QueryInterface
(
origin
)
;
if
(
!
standardURL
)
{
return
NS_ERROR_FAILURE
;
}
nsAutoCString
hostPort
;
bool
isChrome
=
false
;
rv
=
origin
-
>
SchemeIs
(
"
chrome
"
&
isChrome
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
!
isChrome
)
{
rv
=
origin
-
>
GetAsciiHostPort
(
hostPort
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
if
(
!
hostPort
.
IsEmpty
(
)
)
{
rv
=
origin
-
>
GetScheme
(
aOriginNoSuffix
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
aOriginNoSuffix
.
AppendLiteral
(
"
:
/
/
"
)
;
aOriginNoSuffix
.
Append
(
hostPort
)
;
return
NS_OK
;
}
rv
=
aURI
-
>
GetAsciiSpec
(
aOriginNoSuffix
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
int32_t
pos
=
aOriginNoSuffix
.
FindChar
(
'
?
'
)
;
int32_t
hashPos
=
aOriginNoSuffix
.
FindChar
(
'
#
'
)
;
if
(
hashPos
!
=
kNotFound
&
&
(
pos
=
=
kNotFound
|
|
hashPos
<
pos
)
)
{
pos
=
hashPos
;
}
if
(
pos
!
=
kNotFound
)
{
aOriginNoSuffix
.
Truncate
(
pos
)
;
}
return
NS_OK
;
}
bool
ContentPrincipal
:
:
SubsumesInternal
(
nsIPrincipal
*
aOther
BasePrincipal
:
:
DocumentDomainConsideration
aConsideration
)
{
MOZ_ASSERT
(
aOther
)
;
if
(
aOther
=
=
this
)
{
return
true
;
}
nsresult
rv
;
if
(
aConsideration
=
=
ConsiderDocumentDomain
)
{
nsCOMPtr
<
nsIURI
>
thisDomain
otherDomain
;
GetDomain
(
getter_AddRefs
(
thisDomain
)
)
;
aOther
-
>
GetDomain
(
getter_AddRefs
(
otherDomain
)
)
;
if
(
thisDomain
|
|
otherDomain
)
{
return
nsScriptSecurityManager
:
:
SecurityCompareURIs
(
thisDomain
otherDomain
)
;
}
}
nsCOMPtr
<
nsIURI
>
otherURI
;
rv
=
aOther
-
>
GetURI
(
getter_AddRefs
(
otherURI
)
)
;
NS_ENSURE_SUCCESS
(
rv
false
)
;
return
nsScriptSecurityManager
:
:
SecurityCompareURIs
(
mCodebase
otherURI
)
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
GetURI
(
nsIURI
*
*
aURI
)
{
NS_ADDREF
(
*
aURI
=
mCodebase
)
;
return
NS_OK
;
}
bool
ContentPrincipal
:
:
MayLoadInternal
(
nsIURI
*
aURI
)
{
nsCOMPtr
<
nsIURIWithPrincipal
>
uriWithPrin
=
do_QueryInterface
(
aURI
)
;
if
(
uriWithPrin
)
{
nsCOMPtr
<
nsIPrincipal
>
uriPrin
;
nsresult
rv
=
uriWithPrin
-
>
GetPrincipal
(
getter_AddRefs
(
uriPrin
)
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
|
|
!
uriPrin
)
{
return
false
;
}
return
nsIPrincipal
:
:
Subsumes
(
uriPrin
)
;
}
if
(
AddonAllowsLoad
(
aURI
)
)
{
return
true
;
}
if
(
nsScriptSecurityManager
:
:
SecurityCompareURIs
(
mCodebase
aURI
)
)
{
return
true
;
}
if
(
nsScriptSecurityManager
:
:
GetStrictFileOriginPolicy
(
)
&
&
NS_URIIsLocalFile
(
aURI
)
&
&
NS_RelaxStrictFileOriginPolicy
(
aURI
mCodebase
)
)
{
return
true
;
}
return
false
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
GetHashValue
(
uint32_t
*
aValue
)
{
MOZ_ASSERT
(
mCodebase
"
Need
a
codebase
"
)
;
*
aValue
=
nsScriptSecurityManager
:
:
HashPrincipalByOrigin
(
this
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
GetDomain
(
nsIURI
*
*
aDomain
)
{
if
(
!
mDomain
)
{
*
aDomain
=
nullptr
;
return
NS_OK
;
}
NS_ADDREF
(
*
aDomain
=
mDomain
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
SetDomain
(
nsIURI
*
aDomain
)
{
mDomain
=
aDomain
;
SetHasExplicitDomain
(
)
;
AutoSafeJSContext
cx
;
JSPrincipals
*
principals
=
nsJSPrincipals
:
:
get
(
static_cast
<
nsIPrincipal
*
>
(
this
)
)
;
bool
success
=
js
:
:
RecomputeWrappers
(
cx
js
:
:
ContentCompartmentsOnly
(
)
js
:
:
CompartmentsWithPrincipals
(
principals
)
)
;
NS_ENSURE_TRUE
(
success
NS_ERROR_FAILURE
)
;
success
=
js
:
:
RecomputeWrappers
(
cx
js
:
:
CompartmentsWithPrincipals
(
principals
)
js
:
:
ContentCompartmentsOnly
(
)
)
;
NS_ENSURE_TRUE
(
success
NS_ERROR_FAILURE
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
GetBaseDomain
(
nsACString
&
aBaseDomain
)
{
if
(
NS_URIIsLocalFile
(
mCodebase
)
)
{
nsCOMPtr
<
nsIURL
>
url
=
do_QueryInterface
(
mCodebase
)
;
if
(
url
)
{
return
url
-
>
GetFilePath
(
aBaseDomain
)
;
}
}
bool
hasNoRelativeFlag
;
nsresult
rv
=
NS_URIChainHasFlags
(
mCodebase
nsIProtocolHandler
:
:
URI_NORELATIVE
&
hasNoRelativeFlag
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
if
(
hasNoRelativeFlag
)
{
return
mCodebase
-
>
GetSpec
(
aBaseDomain
)
;
}
nsCOMPtr
<
mozIThirdPartyUtil
>
thirdPartyUtil
=
do_GetService
(
THIRDPARTYUTIL_CONTRACTID
)
;
if
(
thirdPartyUtil
)
{
return
thirdPartyUtil
-
>
GetBaseDomain
(
mCodebase
aBaseDomain
)
;
}
return
NS_OK
;
}
WebExtensionPolicy
*
ContentPrincipal
:
:
AddonPolicy
(
)
{
if
(
!
mAddon
.
isSome
(
)
)
{
NS_ENSURE_TRUE
(
mCodebase
nullptr
)
;
bool
isMozExt
;
if
(
NS_SUCCEEDED
(
mCodebase
-
>
SchemeIs
(
"
moz
-
extension
"
&
isMozExt
)
)
&
&
isMozExt
)
{
mAddon
.
emplace
(
EPS
(
)
.
GetByURL
(
mCodebase
.
get
(
)
)
)
;
}
else
{
mAddon
.
emplace
(
nullptr
)
;
}
}
return
mAddon
.
value
(
)
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
GetAddonId
(
nsAString
&
aAddonId
)
{
auto
policy
=
AddonPolicy
(
)
;
if
(
policy
)
{
policy
-
>
GetId
(
aAddonId
)
;
}
else
{
aAddonId
.
Truncate
(
)
;
}
return
NS_OK
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
Read
(
nsIObjectInputStream
*
aStream
)
{
nsCOMPtr
<
nsISupports
>
supports
;
nsCOMPtr
<
nsIURI
>
codebase
;
nsresult
rv
=
NS_ReadOptionalObject
(
aStream
true
getter_AddRefs
(
supports
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
codebase
=
do_QueryInterface
(
supports
)
;
bool
isAbout
=
false
;
if
(
NS_SUCCEEDED
(
codebase
-
>
SchemeIs
(
"
about
"
&
isAbout
)
)
&
&
isAbout
)
{
nsAutoCString
spec
;
codebase
-
>
GetSpec
(
spec
)
;
NS_ENSURE_SUCCESS
(
NS_NewURI
(
getter_AddRefs
(
codebase
)
spec
)
NS_ERROR_FAILURE
)
;
}
nsCOMPtr
<
nsIURI
>
domain
;
rv
=
NS_ReadOptionalObject
(
aStream
true
getter_AddRefs
(
supports
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
domain
=
do_QueryInterface
(
supports
)
;
nsAutoCString
suffix
;
rv
=
aStream
-
>
ReadCString
(
suffix
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
OriginAttributes
attrs
;
bool
ok
=
attrs
.
PopulateFromSuffix
(
suffix
)
;
NS_ENSURE_TRUE
(
ok
NS_ERROR_FAILURE
)
;
rv
=
NS_ReadOptionalObject
(
aStream
true
getter_AddRefs
(
supports
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsAutoCString
originNoSuffix
;
rv
=
GenerateOriginNoSuffixFromURI
(
codebase
originNoSuffix
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
rv
=
Init
(
codebase
attrs
originNoSuffix
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
mCSP
=
do_QueryInterface
(
supports
&
rv
)
;
if
(
mCSP
)
{
mCSP
-
>
SetRequestContext
(
nullptr
this
)
;
}
SetDomain
(
domain
)
;
return
NS_OK
;
}
NS_IMETHODIMP
ContentPrincipal
:
:
Write
(
nsIObjectOutputStream
*
aStream
)
{
NS_ENSURE_STATE
(
mCodebase
)
;
nsresult
rv
=
NS_WriteOptionalCompoundObject
(
aStream
mCodebase
NS_GET_IID
(
nsIURI
)
true
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
rv
=
NS_WriteOptionalCompoundObject
(
aStream
mDomain
NS_GET_IID
(
nsIURI
)
true
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
nsAutoCString
suffix
;
OriginAttributesRef
(
)
.
CreateSuffix
(
suffix
)
;
rv
=
aStream
-
>
WriteStringZ
(
suffix
.
get
(
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
rv
=
NS_WriteOptionalCompoundObject
(
aStream
mCSP
NS_GET_IID
(
nsIContentSecurityPolicy
)
true
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
rv
;
}
return
NS_OK
;
}
