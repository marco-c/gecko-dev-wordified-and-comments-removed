#
ifndef
mozilla_Monitor_h
#
define
mozilla_Monitor_h
#
include
"
mozilla
/
CondVar
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
namespace
mozilla
{
class
MOZ_CAPABILITY
(
"
monitor
"
)
Monitor
{
public
:
explicit
Monitor
(
const
char
*
aName
)
:
mMutex
(
aName
)
mCondVar
(
mMutex
"
[
Monitor
.
mCondVar
]
"
)
{
}
~
Monitor
(
)
=
default
;
void
Lock
(
)
MOZ_CAPABILITY_ACQUIRE
(
)
{
mMutex
.
Lock
(
)
;
}
[
[
nodiscard
]
]
bool
TryLock
(
)
MOZ_TRY_ACQUIRE
(
true
)
{
return
mMutex
.
TryLock
(
)
;
}
void
Unlock
(
)
MOZ_CAPABILITY_RELEASE
(
)
{
mMutex
.
Unlock
(
)
;
}
void
Wait
(
)
MOZ_REQUIRES
(
this
)
{
mCondVar
.
Wait
(
)
;
}
CVStatus
Wait
(
TimeDuration
aDuration
)
MOZ_REQUIRES
(
this
)
{
return
mCondVar
.
Wait
(
aDuration
)
;
}
void
Notify
(
)
{
mCondVar
.
Notify
(
)
;
}
void
NotifyAll
(
)
{
mCondVar
.
NotifyAll
(
)
;
}
void
AssertCurrentThreadOwns
(
)
const
MOZ_ASSERT_CAPABILITY
(
this
)
{
mMutex
.
AssertCurrentThreadOwns
(
)
;
}
void
AssertNotCurrentThreadOwns
(
)
const
MOZ_ASSERT_CAPABILITY
(
!
this
)
{
mMutex
.
AssertNotCurrentThreadOwns
(
)
;
}
private
:
Monitor
(
)
=
delete
;
Monitor
(
const
Monitor
&
)
=
delete
;
Monitor
&
operator
=
(
const
Monitor
&
)
=
delete
;
Mutex
mMutex
;
CondVar
mCondVar
;
}
;
class
MOZ_SCOPED_CAPABILITY
MOZ_STACK_CLASS
MonitorAutoLock
{
public
:
explicit
MonitorAutoLock
(
Monitor
&
aMonitor
)
MOZ_CAPABILITY_ACQUIRE
(
aMonitor
)
:
mMonitor
(
&
aMonitor
)
{
mMonitor
-
>
Lock
(
)
;
}
~
MonitorAutoLock
(
)
MOZ_CAPABILITY_RELEASE
(
)
{
mMonitor
-
>
Unlock
(
)
;
}
void
Wait
(
)
{
mMonitor
-
>
AssertCurrentThreadOwns
(
)
;
mMonitor
-
>
Wait
(
)
;
}
CVStatus
Wait
(
TimeDuration
aDuration
)
{
mMonitor
-
>
AssertCurrentThreadOwns
(
)
;
return
mMonitor
-
>
Wait
(
aDuration
)
;
}
void
Notify
(
)
{
mMonitor
-
>
Notify
(
)
;
}
void
NotifyAll
(
)
{
mMonitor
-
>
NotifyAll
(
)
;
}
void
AssertOwns
(
const
Monitor
&
aMonitor
)
const
MOZ_ASSERT_CAPABILITY
(
aMonitor
)
{
MOZ_ASSERT
(
&
aMonitor
=
=
mMonitor
)
;
mMonitor
-
>
AssertCurrentThreadOwns
(
)
;
}
private
:
MonitorAutoLock
(
)
=
delete
;
MonitorAutoLock
(
const
MonitorAutoLock
&
)
=
delete
;
MonitorAutoLock
&
operator
=
(
const
MonitorAutoLock
&
)
=
delete
;
static
void
*
operator
new
(
size_t
)
noexcept
(
true
)
;
friend
class
MonitorAutoUnlock
;
protected
:
Monitor
*
mMonitor
;
}
;
class
MOZ_STACK_CLASS
MOZ_SCOPED_CAPABILITY
MonitorAutoUnlock
{
public
:
explicit
MonitorAutoUnlock
(
Monitor
&
aMonitor
)
MOZ_SCOPED_UNLOCK_RELEASE
(
aMonitor
)
:
mMonitor
(
&
aMonitor
)
{
mMonitor
-
>
Unlock
(
)
;
}
~
MonitorAutoUnlock
(
)
MOZ_SCOPED_UNLOCK_REACQUIRE
(
)
{
mMonitor
-
>
Lock
(
)
;
}
private
:
MonitorAutoUnlock
(
)
=
delete
;
MonitorAutoUnlock
(
const
MonitorAutoUnlock
&
)
=
delete
;
MonitorAutoUnlock
&
operator
=
(
const
MonitorAutoUnlock
&
)
=
delete
;
static
void
*
operator
new
(
size_t
)
noexcept
(
true
)
;
Monitor
*
mMonitor
;
}
;
class
MOZ_SCOPED_CAPABILITY
MOZ_STACK_CLASS
ReleasableMonitorAutoLock
{
public
:
explicit
ReleasableMonitorAutoLock
(
Monitor
&
aMonitor
)
MOZ_CAPABILITY_ACQUIRE
(
aMonitor
)
:
mMonitor
(
&
aMonitor
)
{
mMonitor
-
>
Lock
(
)
;
mLocked
=
true
;
}
~
ReleasableMonitorAutoLock
(
)
MOZ_CAPABILITY_RELEASE
(
)
{
if
(
mLocked
)
{
mMonitor
-
>
Unlock
(
)
;
}
}
void
Wait
(
)
{
mMonitor
-
>
AssertCurrentThreadOwns
(
)
;
mMonitor
-
>
Wait
(
)
;
}
CVStatus
Wait
(
TimeDuration
aDuration
)
{
mMonitor
-
>
AssertCurrentThreadOwns
(
)
;
return
mMonitor
-
>
Wait
(
aDuration
)
;
}
void
Notify
(
)
{
MOZ_ASSERT
(
mLocked
)
;
mMonitor
-
>
Notify
(
)
;
}
void
NotifyAll
(
)
{
MOZ_ASSERT
(
mLocked
)
;
mMonitor
-
>
NotifyAll
(
)
;
}
void
Unlock
(
)
MOZ_CAPABILITY_RELEASE
(
)
{
MOZ_ASSERT
(
mLocked
)
;
mMonitor
-
>
Unlock
(
)
;
mLocked
=
false
;
}
void
Lock
(
)
MOZ_CAPABILITY_ACQUIRE
(
)
{
MOZ_ASSERT
(
!
mLocked
)
;
mMonitor
-
>
Lock
(
)
;
mLocked
=
true
;
}
void
AssertCurrentThreadOwns
(
)
const
MOZ_ASSERT_CAPABILITY
(
)
{
mMonitor
-
>
AssertCurrentThreadOwns
(
)
;
}
private
:
bool
mLocked
;
Monitor
*
mMonitor
;
ReleasableMonitorAutoLock
(
)
=
delete
;
ReleasableMonitorAutoLock
(
const
ReleasableMonitorAutoLock
&
)
=
delete
;
ReleasableMonitorAutoLock
&
operator
=
(
const
ReleasableMonitorAutoLock
&
)
=
delete
;
static
void
*
operator
new
(
size_t
)
noexcept
(
true
)
;
}
;
}
#
endif
