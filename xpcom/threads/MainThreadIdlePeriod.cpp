#
include
"
MainThreadIdlePeriod
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
nsRefreshDriver
.
h
"
#
define
DEFAULT_LONG_IDLE_PERIOD
50
.
0f
#
define
DEFAULT_MIN_IDLE_PERIOD
3
.
0f
namespace
mozilla
{
NS_IMETHODIMP
MainThreadIdlePeriod
:
:
GetIdlePeriodHint
(
TimeStamp
*
aIdleDeadline
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
aIdleDeadline
)
;
Maybe
<
TimeStamp
>
deadline
=
nsRefreshDriver
:
:
GetIdleDeadlineHint
(
)
;
if
(
deadline
.
isSome
(
)
)
{
TimeDuration
minIdlePeriod
=
TimeDuration
:
:
FromMilliseconds
(
GetMinIdlePeriod
(
)
)
;
bool
busySoon
=
deadline
.
value
(
)
.
IsNull
(
)
|
|
(
TimeStamp
:
:
Now
(
)
>
=
(
deadline
.
value
(
)
-
minIdlePeriod
)
)
;
*
aIdleDeadline
=
busySoon
?
TimeStamp
(
)
:
deadline
.
value
(
)
;
}
else
{
*
aIdleDeadline
=
TimeStamp
:
:
Now
(
)
+
TimeDuration
:
:
FromMilliseconds
(
GetLongIdlePeriod
(
)
)
;
}
return
NS_OK
;
}
float
MainThreadIdlePeriod
:
:
GetLongIdlePeriod
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
static
float
sLongIdlePeriod
=
DEFAULT_LONG_IDLE_PERIOD
;
static
bool
sInitialized
=
false
;
if
(
!
sInitialized
&
&
Preferences
:
:
IsServiceAvailable
(
)
)
{
sInitialized
=
true
;
Preferences
:
:
AddFloatVarCache
(
&
sLongIdlePeriod
"
idle_queue
.
long_period
"
DEFAULT_LONG_IDLE_PERIOD
)
;
}
return
sLongIdlePeriod
;
}
float
MainThreadIdlePeriod
:
:
GetMinIdlePeriod
(
)
{
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
static
float
sMinIdlePeriod
=
DEFAULT_MIN_IDLE_PERIOD
;
static
bool
sInitialized
=
false
;
if
(
!
sInitialized
&
&
Preferences
:
:
IsServiceAvailable
(
)
)
{
sInitialized
=
true
;
Preferences
:
:
AddFloatVarCache
(
&
sMinIdlePeriod
"
idle_queue
.
min_period
"
DEFAULT_MIN_IDLE_PERIOD
)
;
}
return
sMinIdlePeriod
;
}
}
