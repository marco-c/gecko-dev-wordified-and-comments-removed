#
include
"
nsCocoaUtils
.
h
"
#
include
"
nsEscape
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
<
CoreFoundation
/
CoreFoundation
.
h
>
void
ExpectUnchangedByNSURL
(
nsCString
&
aEncoded
)
{
NSURL
*
macURL
=
nsCocoaUtils
:
:
ToNSURL
(
NS_ConvertUTF8toUTF16
(
aEncoded
)
)
;
NSString
*
macURLString
=
[
macURL
absoluteString
]
;
nsString
geckoURLString
;
nsCocoaUtils
:
:
GetStringForNSString
(
macURLString
geckoURLString
)
;
EXPECT_STREQ
(
aEncoded
.
BeginReading
(
)
NS_ConvertUTF16toUTF8
(
geckoURLString
)
.
get
(
)
)
;
}
TEST
(
NSURLEscaping
NSURLEscapingTests
)
{
nsTArray
<
std
:
:
pair
<
nsCString
nsCString
>
>
pairs
{
{
"
https
:
/
/
chat
.
mozilla
.
org
/
#
/
room
/
#
macdev
:
mozilla
.
org
"
_ns
"
https
:
/
/
chat
.
mozilla
.
org
/
#
/
room
/
%
23macdev
:
mozilla
.
org
"
_ns
}
{
"
https
:
/
/
example
.
com
/
path
#
ref_with_
#
_and
\
"
"
_ns
"
https
:
/
/
example
.
com
/
path
#
ref_with_
%
23_and
%
22
"
_ns
}
{
"
https
:
/
/
example
.
com
/
path
#
ref_with_
[
foo
]
_
{
and
}
_
|
"
_ns
"
https
:
/
/
example
.
com
/
path
#
ref_with_
%
5Bfoo
%
5D_
%
7Band
%
7D_
%
7C
"
_ns
}
{
"
https
:
/
/
example
.
com
/
path
-
_
.
!
~
&
'
(
x
)
?
x
=
y
&
x
=
z
-
_
.
!
~
&
'
(
x
)
#
ref
-
_
.
!
~
&
'
(
x
)
"
_ns
"
https
:
/
/
example
.
com
/
path
-
_
.
!
~
&
'
(
x
)
?
x
=
y
&
x
=
z
-
_
.
!
~
&
%
27
(
x
)
#
ref
-
_
.
!
~
&
'
(
x
)
"
_ns
}
{
"
https
:
/
/
example
.
com
/
path
#
ref
\
"
#
<
>
[
]
\
\
^
{
|
}
ref
"
_ns
"
https
:
/
/
example
.
com
/
path
#
ref
%
20
%
22
%
23
%
3C
%
3E
%
5B
%
5D
%
5C
%
5E
%
60
%
7B
%
7C
%
7Dref
"
_ns
}
}
;
for
(
std
:
:
pair
<
nsCString
nsCString
>
&
pair
:
pairs
)
{
nsCString
escaped
;
nsresult
rv
=
NS_GetSpecWithNSURLEncoding
(
escaped
pair
.
first
)
;
EXPECT_EQ
(
rv
NS_OK
)
;
EXPECT_STREQ
(
pair
.
second
.
BeginReading
(
)
escaped
.
BeginReading
(
)
)
;
ExpectUnchangedByNSURL
(
escaped
)
;
}
nsTArray
<
nsCString
>
unchangedURLs
{
"
https
:
/
/
bugzilla
.
mozilla
.
org
/
show_bug
.
cgi
?
id
=
1737854
"
_ns
"
https
:
/
/
bugzilla
.
mozilla
.
org
/
show_bug
.
cgi
?
id
=
1737854
#
ref
"
_ns
"
https
:
/
/
bugzilla
.
mozilla
.
org
/
allinref
#
show_bug
.
cgi
?
id
=
1737854ref
"
_ns
"
https
:
/
/
example
.
com
/
script
?
foo
=
bar
#
this_ref
"
_ns
"
https
:
/
/
html
.
spec
.
whatwg
.
org
/
multipage
/
dom
.
html
#
the
-
document
%
27s
-
address
"
_ns
"
https
:
/
/
www
.
google
.
com
/
search
?
q
=
firefox
+
web
+
browser
&
client
=
firefox
-
b
-
1
-
d
&
ei
=
abc
&
ved
=
abc
&
abc
=
5
&
oq
=
firefox
+
web
+
browser
&
gs_lcp
=
abc
&
sclient
=
gws
-
wiz
"
_ns
"
https
:
/
/
chat
.
mozilla
.
org
/
#
/
room
/
%
23macdev
%
3Amozilla
.
org
"
_ns
"
https
:
/
/
searchfox
.
org
/
mozilla
-
central
/
search
?
q
=
symbol
%
3AE_
%
3CT_mozilla
%
3A
%
3AWebGLExtensionID
%
3E_EXT_color_buffer_half_float
&
path
=
"
_ns
"
https
:
/
/
example
.
com
/
path
#
ref
!
&
'
(
foo
)
:
;
=
?
~
"
_ns
"
https
:
/
/
example
.
com
/
path
-
_
.
!
~
&
'
(
x
)
#
ref
"
_ns
"
https
:
/
/
example
.
com
/
path
-
_
.
!
~
&
'
(
x
)
#
ref
-
_
.
!
~
&
'
(
x
)
"
_ns
"
https
:
/
/
example
.
com
/
path
?
a
=
b
&
;
=
/
&
/
=
?
&
=
a
+
b
"
_ns
}
;
for
(
nsCString
&
toEscape
:
unchangedURLs
)
{
nsCString
escaped
;
nsresult
rv
=
NS_GetSpecWithNSURLEncoding
(
escaped
toEscape
)
;
EXPECT_EQ
(
rv
NS_OK
)
;
EXPECT_STREQ
(
toEscape
.
BeginReading
(
)
escaped
.
BeginReading
(
)
)
;
ExpectUnchangedByNSURL
(
escaped
)
;
}
}
