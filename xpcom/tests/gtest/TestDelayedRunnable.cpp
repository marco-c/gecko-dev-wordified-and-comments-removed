#
include
"
mozilla
/
DelayedRunnable
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
include
"
mozilla
/
media
/
MediaUtils
.
h
"
#
include
"
VideoUtils
.
h
"
namespace
{
struct
ReleaseDetector
{
explicit
ReleaseDetector
(
Atomic
<
bool
>
*
aActive
)
:
mActive
(
aActive
)
{
*
mActive
=
true
;
}
ReleaseDetector
(
ReleaseDetector
&
&
aOther
)
noexcept
:
mActive
(
aOther
.
mActive
)
{
aOther
.
mActive
=
nullptr
;
}
ReleaseDetector
(
const
ReleaseDetector
&
)
=
delete
;
~
ReleaseDetector
(
)
{
if
(
mActive
)
{
*
mActive
=
false
;
}
}
Atomic
<
bool
>
*
mActive
;
}
;
}
TEST
(
DelayedRunnable
TaskQueueShutdownLeak
)
{
Atomic
<
bool
>
active
{
false
}
;
auto
taskQueue
=
MakeRefPtr
<
TaskQueue
>
(
GetMediaThreadPool
(
MediaThreadType
:
:
SUPERVISOR
)
)
;
taskQueue
-
>
DelayedDispatch
(
NS_NewRunnableFunction
(
__func__
[
release
=
ReleaseDetector
(
&
active
)
]
{
}
)
60e3
)
;
EXPECT_TRUE
(
active
)
;
taskQueue
-
>
BeginShutdown
(
)
;
taskQueue
-
>
AwaitIdle
(
)
;
EXPECT_FALSE
(
active
)
;
}
TEST
(
DelayedRunnable
nsThreadShutdownLeak
)
{
Atomic
<
bool
>
active
{
false
}
;
nsCOMPtr
<
nsIThread
>
thread
;
ASSERT_EQ
(
NS_NewNamedThread
(
"
Test
Thread
"
getter_AddRefs
(
thread
)
)
NS_OK
)
;
thread
-
>
DelayedDispatch
(
NS_NewRunnableFunction
(
__func__
[
release
=
ReleaseDetector
(
&
active
)
]
{
}
)
60e3
)
;
EXPECT_TRUE
(
active
)
;
ASSERT_EQ
(
thread
-
>
Shutdown
(
)
NS_OK
)
;
EXPECT_FALSE
(
active
)
;
}
TEST
(
DelayedRunnable
BackgroundTaskQueueShutdownTask
)
{
nsCOMPtr
<
nsISerialEventTarget
>
taskQueue
;
nsresult
rv
=
NS_CreateBackgroundTaskQueue
(
"
TestDelayedRunnable
"
getter_AddRefs
(
taskQueue
)
)
;
ASSERT_TRUE
(
NS_SUCCEEDED
(
rv
)
)
;
nsISerialEventTarget
*
tq
=
taskQueue
.
forget
(
)
.
take
(
)
;
Unused
<
<
tq
;
}
TEST
(
DelayedRunnable
nsThreadShutdownTask
)
{
nsCOMPtr
<
nsIThread
>
thread
;
ASSERT_EQ
(
NS_NewNamedThread
(
"
Test
Thread
"
getter_AddRefs
(
thread
)
)
NS_OK
)
;
nsIThread
*
t
=
thread
.
forget
(
)
.
take
(
)
;
Unused
<
<
t
;
}
