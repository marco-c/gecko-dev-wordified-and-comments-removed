#
include
"
mozmemory
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
define
ASSERT_ALLOCATION_HAPPENED
(
lambda
)
\
ASSERT_TRUE
(
ValidateHookedAllocation
(
lambda
free
)
)
;
const
size_t
kAllocAmount
=
16
;
static
bool
ValidateHookedAllocation
(
void
*
(
*
aAllocator
)
(
void
)
void
(
*
aFreeFunction
)
(
void
*
)
)
{
void
*
p
=
aAllocator
(
)
;
if
(
!
p
)
{
return
false
;
}
jemalloc_ptr_info_t
info
;
jemalloc_ptr_info
(
p
&
info
)
;
aFreeFunction
(
p
)
;
return
(
info
.
tag
=
=
PtrInfoTag
:
:
TagLiveAlloc
)
;
}
TEST
(
AllocReplacement
malloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
return
malloc
(
kAllocAmount
)
;
}
)
;
}
TEST
(
AllocReplacement
calloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
return
calloc
(
1
kAllocAmount
)
;
}
)
;
}
TEST
(
AllocReplacement
realloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
return
realloc
(
nullptr
kAllocAmount
)
;
}
)
;
}
#
if
defined
(
HAVE_POSIX_MEMALIGN
)
TEST
(
AllocReplacement
posix_memalign_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
void
*
p
=
nullptr
;
int
result
=
posix_memalign
(
&
p
sizeof
(
void
*
)
kAllocAmount
)
;
if
(
result
!
=
0
)
{
return
static_cast
<
void
*
>
(
nullptr
)
;
}
return
p
;
}
)
;
}
#
endif
