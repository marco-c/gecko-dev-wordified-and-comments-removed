#
include
"
mozilla
/
Attributes
.
h
"
#
include
"
mozilla
/
mozalloc
.
h
"
#
include
"
mozilla
/
ScopeExit
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIMemoryReporter
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
gtest
/
gtest
.
h
"
#
if
defined
(
MOZ_MEMORY
)
#
define
ALLOCATION_ASSERT
(
b
)
ASSERT_TRUE
(
(
b
)
)
#
else
#
define
ALLOCATION_ASSERT
(
b
)
(
void
)
(
b
)
#
endif
#
define
ASSERT_ALLOCATION_HAPPENED
(
lambda
)
\
ALLOCATION_ASSERT
(
ValidateHookedAllocation
(
lambda
free
)
)
;
const
size_t
kAllocAmount
=
16
;
static
MOZ_NEVER_INLINE
bool
ValidateHookedAllocation
(
void
*
(
*
aAllocator
)
(
void
)
void
(
*
aFreeFunction
)
(
void
*
)
)
{
nsCOMPtr
<
nsIMemoryReporterManager
>
manager
=
do_GetService
(
"
mozilla
.
org
/
memory
-
reporter
-
manager
;
1
"
)
;
int64_t
before
=
0
;
nsresult
rv
=
manager
-
>
GetHeapAllocated
(
&
before
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
false
;
}
{
void
*
p
=
aAllocator
(
)
;
if
(
!
p
)
{
return
false
;
}
int64_t
after
=
0
;
rv
=
manager
-
>
GetHeapAllocated
(
&
after
)
;
aFreeFunction
(
p
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
false
;
}
if
(
(
before
+
int64_t
(
kAllocAmount
)
)
!
=
after
)
{
return
false
;
}
}
int64_t
after
=
0
;
rv
=
manager
-
>
GetHeapAllocated
(
&
after
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
false
;
}
return
before
=
=
after
;
}
TEST
(
AllocReplacementDeathTest
malloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
return
malloc
(
kAllocAmount
)
;
}
)
;
}
TEST
(
AllocReplacementDeathTest
calloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
return
calloc
(
1
kAllocAmount
)
;
}
)
;
}
TEST
(
AllocReplacementDeathTest
realloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
return
realloc
(
nullptr
kAllocAmount
)
;
}
)
;
}
#
if
defined
(
HAVE_POSIX_MEMALIGN
)
TEST
(
AllocReplacementDeathTest
posix_memalign_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
void
*
p
=
nullptr
;
int
result
=
posix_memalign
(
&
p
sizeof
(
void
*
)
kAllocAmount
)
;
if
(
result
!
=
0
)
{
return
static_cast
<
void
*
>
(
nullptr
)
;
}
return
p
;
}
)
;
}
#
endif
#
if
defined
(
XP_WIN
)
#
include
<
windows
.
h
>
#
undef
ASSERT_ALLOCATION_HAPPENED
#
define
ASSERT_ALLOCATION_HAPPENED
(
lambda
)
\
ALLOCATION_ASSERT
(
ValidateHookedAllocation
(
lambda
[
]
(
void
*
p
)
{
\
HeapFree
(
GetProcessHeap
(
)
0
p
)
;
\
}
)
)
;
TEST
(
AllocReplacementDeathTest
HeapAlloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
HANDLE
h
=
GetProcessHeap
(
)
;
return
HeapAlloc
(
h
0
kAllocAmount
)
;
}
)
;
}
TEST
(
AllocReplacementDeathTest
HeapReAlloc_check
)
{
ASSERT_ALLOCATION_HAPPENED
(
[
]
{
HANDLE
h
=
GetProcessHeap
(
)
;
void
*
p
=
HeapAlloc
(
h
0
kAllocAmount
/
2
)
;
if
(
!
p
)
{
return
static_cast
<
void
*
>
(
nullptr
)
;
}
return
HeapReAlloc
(
h
0
p
kAllocAmount
)
;
}
)
;
}
#
endif
