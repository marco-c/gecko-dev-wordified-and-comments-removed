#
include
"
mozilla
/
ClearOnShutdown
.
h
"
namespace
mozilla
{
namespace
ClearOnShutdown_Internal
{
Array
<
StaticAutoPtr
<
ShutdownList
>
static_cast
<
size_t
>
(
ShutdownPhase
:
:
ShutdownPhase_Length
)
>
sShutdownObservers
;
ShutdownPhase
sCurrentShutdownPhase
=
ShutdownPhase
:
:
NotInShutdown
;
void
InsertIntoShutdownList
(
ShutdownObserver
*
aObserver
ShutdownPhase
aPhase
)
{
if
(
!
(
static_cast
<
size_t
>
(
sCurrentShutdownPhase
)
<
static_cast
<
size_t
>
(
aPhase
)
)
)
{
MOZ_ASSERT
(
false
"
ClearOnShutdown
for
phase
that
already
was
cleared
"
)
;
aObserver
-
>
Shutdown
(
)
;
delete
aObserver
;
return
;
}
if
(
!
(
sShutdownObservers
[
static_cast
<
size_t
>
(
aPhase
)
]
)
)
{
sShutdownObservers
[
static_cast
<
size_t
>
(
aPhase
)
]
=
new
ShutdownList
(
)
;
}
sShutdownObservers
[
static_cast
<
size_t
>
(
aPhase
)
]
-
>
insertBack
(
aObserver
)
;
}
}
void
KillClearOnShutdown
(
ShutdownPhase
aPhase
)
{
using
namespace
ClearOnShutdown_Internal
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
static_cast
<
size_t
>
(
sCurrentShutdownPhase
)
<
static_cast
<
size_t
>
(
aPhase
)
)
;
for
(
size_t
phase
=
static_cast
<
size_t
>
(
ShutdownPhase
:
:
First
)
;
phase
<
=
static_cast
<
size_t
>
(
aPhase
)
;
phase
+
+
)
{
if
(
sShutdownObservers
[
static_cast
<
size_t
>
(
phase
)
]
)
{
while
(
ShutdownObserver
*
observer
=
sShutdownObservers
[
static_cast
<
size_t
>
(
phase
)
]
-
>
popLast
(
)
)
{
observer
-
>
Shutdown
(
)
;
delete
observer
;
}
sShutdownObservers
[
static_cast
<
size_t
>
(
phase
)
]
=
nullptr
;
}
}
}
}
