#
include
"
nsMacUtilsImpl
.
h
"
#
include
"
base
/
command_line
.
h
"
#
include
"
nsDirectoryServiceDefs
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIFile
.
h
"
#
include
"
nsIProperties
.
h
"
#
include
"
nsServiceManagerUtils
.
h
"
#
include
"
nsXULAppAPI
.
h
"
#
include
<
CoreFoundation
/
CoreFoundation
.
h
>
NS_IMPL_ISUPPORTS
(
nsMacUtilsImpl
nsIMacUtils
)
nsresult
nsMacUtilsImpl
:
:
GetArchString
(
nsAString
&
aArchString
)
{
if
(
!
mBinaryArchs
.
IsEmpty
(
)
)
{
aArchString
.
Assign
(
mBinaryArchs
)
;
return
NS_OK
;
}
aArchString
.
Truncate
(
)
;
bool
foundPPC
=
false
foundX86
=
false
foundPPC64
=
false
foundX86_64
=
false
;
CFBundleRef
mainBundle
=
:
:
CFBundleGetMainBundle
(
)
;
if
(
!
mainBundle
)
{
return
NS_ERROR_FAILURE
;
}
CFArrayRef
archList
=
:
:
CFBundleCopyExecutableArchitectures
(
mainBundle
)
;
if
(
!
archList
)
{
return
NS_ERROR_FAILURE
;
}
CFIndex
archCount
=
:
:
CFArrayGetCount
(
archList
)
;
for
(
CFIndex
i
=
0
;
i
<
archCount
;
i
+
+
)
{
CFNumberRef
arch
=
static_cast
<
CFNumberRef
>
(
:
:
CFArrayGetValueAtIndex
(
archList
i
)
)
;
int
archInt
=
0
;
if
(
!
:
:
CFNumberGetValue
(
arch
kCFNumberIntType
&
archInt
)
)
{
:
:
CFRelease
(
archList
)
;
return
NS_ERROR_FAILURE
;
}
if
(
archInt
=
=
kCFBundleExecutableArchitecturePPC
)
{
foundPPC
=
true
;
}
else
if
(
archInt
=
=
kCFBundleExecutableArchitectureI386
)
{
foundX86
=
true
;
}
else
if
(
archInt
=
=
kCFBundleExecutableArchitecturePPC64
)
{
foundPPC64
=
true
;
}
else
if
(
archInt
=
=
kCFBundleExecutableArchitectureX86_64
)
{
foundX86_64
=
true
;
}
}
:
:
CFRelease
(
archList
)
;
if
(
foundPPC
)
{
mBinaryArchs
.
AppendLiteral
(
"
ppc
"
)
;
}
if
(
foundX86
)
{
if
(
!
mBinaryArchs
.
IsEmpty
(
)
)
{
mBinaryArchs
.
Append
(
'
-
'
)
;
}
mBinaryArchs
.
AppendLiteral
(
"
i386
"
)
;
}
if
(
foundPPC64
)
{
if
(
!
mBinaryArchs
.
IsEmpty
(
)
)
{
mBinaryArchs
.
Append
(
'
-
'
)
;
}
mBinaryArchs
.
AppendLiteral
(
"
ppc64
"
)
;
}
if
(
foundX86_64
)
{
if
(
!
mBinaryArchs
.
IsEmpty
(
)
)
{
mBinaryArchs
.
Append
(
'
-
'
)
;
}
mBinaryArchs
.
AppendLiteral
(
"
x86_64
"
)
;
}
aArchString
.
Assign
(
mBinaryArchs
)
;
return
(
aArchString
.
IsEmpty
(
)
?
NS_ERROR_FAILURE
:
NS_OK
)
;
}
NS_IMETHODIMP
nsMacUtilsImpl
:
:
GetArchitecturesInBinary
(
nsAString
&
aArchString
)
{
return
GetArchString
(
aArchString
)
;
}
NS_IMETHODIMP
nsMacUtilsImpl
:
:
GetIsTranslated
(
bool
*
aIsTranslated
)
{
#
ifdef
__ppc__
static
bool
sInitialized
=
false
;
static
int32_t
sIsNative
=
1
;
if
(
!
sInitialized
)
{
size_t
sz
=
sizeof
(
sIsNative
)
;
sysctlbyname
(
"
sysctl
.
proc_native
"
&
sIsNative
&
sz
nullptr
0
)
;
sInitialized
=
true
;
}
*
aIsTranslated
=
!
sIsNative
;
#
else
*
aIsTranslated
=
false
;
#
endif
return
NS_OK
;
}
#
if
defined
(
MOZ_SANDBOX
)
bool
nsMacUtilsImpl
:
:
GetAppPath
(
nsCString
&
aAppPath
)
{
nsAutoCString
appPath
;
nsAutoCString
appBinaryPath
(
(
CommandLine
:
:
ForCurrentProcess
(
)
-
>
argv
(
)
[
0
]
)
.
c_str
(
)
)
;
auto
pattern
=
NS_LITERAL_CSTRING
(
"
/
Contents
/
MacOS
/
"
)
;
nsAutoCString
:
:
const_iterator
start
end
;
appBinaryPath
.
BeginReading
(
start
)
;
appBinaryPath
.
EndReading
(
end
)
;
if
(
RFindInReadable
(
pattern
start
end
)
)
{
end
=
start
;
appBinaryPath
.
BeginReading
(
start
)
;
if
(
!
XRE_IsParentProcess
(
)
)
{
if
(
RFindInReadable
(
pattern
start
end
)
)
{
end
=
start
;
appBinaryPath
.
BeginReading
(
start
)
;
}
else
{
return
false
;
}
}
appPath
.
Assign
(
Substring
(
start
end
)
)
;
}
else
{
return
false
;
}
nsCOMPtr
<
nsIFile
>
app
;
nsresult
rv
=
NS_NewLocalFile
(
NS_ConvertUTF8toUTF16
(
appPath
)
true
getter_AddRefs
(
app
)
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
false
;
}
rv
=
app
-
>
Normalize
(
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
false
;
}
app
-
>
GetNativePath
(
aAppPath
)
;
return
true
;
}
#
if
defined
(
DEBUG
)
nsAutoCString
nsMacUtilsImpl
:
:
GetDirectoryPath
(
const
char
*
aPath
)
{
nsCOMPtr
<
nsIFile
>
file
=
do_CreateInstance
(
NS_LOCAL_FILE_CONTRACTID
)
;
if
(
!
file
|
|
NS_FAILED
(
file
-
>
InitWithNativePath
(
nsDependentCString
(
aPath
)
)
)
)
{
MOZ_CRASH
(
"
Failed
to
create
or
init
an
nsIFile
"
)
;
}
nsCOMPtr
<
nsIFile
>
directoryFile
;
if
(
NS_FAILED
(
file
-
>
GetParent
(
getter_AddRefs
(
directoryFile
)
)
)
|
|
!
directoryFile
)
{
MOZ_CRASH
(
"
Failed
to
get
parent
for
an
nsIFile
"
)
;
}
directoryFile
-
>
Normalize
(
)
;
nsAutoCString
directoryPath
;
if
(
NS_FAILED
(
directoryFile
-
>
GetNativePath
(
directoryPath
)
)
)
{
MOZ_CRASH
(
"
Failed
to
get
path
for
an
nsIFile
"
)
;
}
return
directoryPath
;
}
#
endif
#
endif
