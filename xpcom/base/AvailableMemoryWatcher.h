#
ifndef
mozilla_AvailableMemoryWatcher_h
#
define
mozilla_AvailableMemoryWatcher_h
#
include
"
mozilla
/
ipc
/
CrashReporterHost
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
MemoryPressureLevelMac
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIAvailableMemoryWatcherBase
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsIObserverService
.
h
"
namespace
mozilla
{
#
if
defined
(
XP_LINUX
)
&
&
!
defined
(
ANDROID
)
struct
PSIInfo
{
unsigned
long
some_avg10
=
0
;
unsigned
long
some_avg60
=
0
;
unsigned
long
some_avg300
=
0
;
unsigned
long
some_total
=
0
;
unsigned
long
full_avg10
=
0
;
unsigned
long
full_avg60
=
0
;
unsigned
long
full_avg300
=
0
;
unsigned
long
full_total
=
0
;
}
;
nsresult
GetLastPSISnapshot
(
PSIInfo
&
aResult
)
;
#
endif
class
nsAvailableMemoryWatcherBase
:
public
nsIAvailableMemoryWatcherBase
public
nsIObserver
{
static
StaticRefPtr
<
nsAvailableMemoryWatcherBase
>
sSingleton
;
static
const
char
*
const
kObserverTopics
[
]
;
TimeStamp
mLowMemoryStart
;
protected
:
Mutex
mMutex
;
uint32_t
mNumOfTabUnloading
MOZ_GUARDED_BY
(
mMutex
)
;
uint32_t
mNumOfMemoryPressure
MOZ_GUARDED_BY
(
mMutex
)
;
nsCOMPtr
<
nsITabUnloader
>
mTabUnloader
;
nsCOMPtr
<
nsIObserverService
>
mObserverSvc
;
bool
mInteracting
;
virtual
~
nsAvailableMemoryWatcherBase
(
)
=
default
;
virtual
nsresult
Init
(
)
;
void
Shutdown
(
)
;
void
UpdateLowMemoryTimeStamp
(
)
;
void
RecordTelemetryEventOnHighMemory
(
const
MutexAutoLock
&
)
MOZ_REQUIRES
(
mMutex
)
;
public
:
static
already_AddRefed
<
nsAvailableMemoryWatcherBase
>
GetSingleton
(
)
;
nsAvailableMemoryWatcherBase
(
)
;
#
if
defined
(
XP_DARWIN
)
virtual
void
OnMemoryPressureChanged
(
MacMemoryPressureLevel
aNewLevel
)
{
}
;
virtual
void
AddChildAnnotations
(
const
UniquePtr
<
ipc
:
:
CrashReporterHost
>
&
aCrashReporter
)
{
}
;
#
endif
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIAVAILABLEMEMORYWATCHERBASE
NS_DECL_NSIOBSERVER
}
;
already_AddRefed
<
nsAvailableMemoryWatcherBase
>
CreateAvailableMemoryWatcher
(
)
;
}
#
endif
