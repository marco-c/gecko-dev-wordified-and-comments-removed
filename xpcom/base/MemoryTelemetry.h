#
ifndef
mozilla_MemoryTelemetry_h
#
define
mozilla_MemoryTelemetry_h
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
"
mozilla
/
Maybe
.
h
"
#
include
"
mozilla
/
Result
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsTArray
.
h
"
#
include
<
functional
>
class
nsIEventTarget
;
class
TimeStampWindow
;
namespace
mozilla
{
namespace
ipc
{
enum
class
ResponseRejectReason
;
}
class
MemoryTelemetry
final
{
public
:
NS_INLINE_DECL_THREADSAFE_REFCOUNTING
(
MemoryTelemetry
)
static
RefPtr
<
MemoryTelemetry
>
Create
(
)
;
static
RefPtr
<
MemoryTelemetry
>
Get
(
)
;
nsresult
GatherReports
(
const
std
:
:
function
<
void
(
)
>
&
aCompletionCallback
=
nullptr
)
;
void
DelayedInit
(
)
;
void
Poke
(
)
;
nsresult
Shutdown
(
)
;
private
:
MemoryTelemetry
(
)
;
~
MemoryTelemetry
(
)
;
static
Result
<
uint32_t
nsresult
>
GetOpenTabsCount
(
)
;
void
GatherTotalMemory
(
)
;
nsresult
FinishGatheringTotalMemory
(
Maybe
<
int64_t
>
aTotalMemory
const
nsTArray
<
int64_t
>
&
aChildSizes
)
;
nsCOMPtr
<
nsIEventTarget
>
mThreadPool
;
bool
mGatheringTotalMemory
=
false
;
TimeStamp
mLastRun
{
}
;
TimeStamp
mLastPoke
{
}
;
UniquePtr
<
TimeStampWindow
>
mPokeWindow
;
nsCOMPtr
<
nsITimer
>
mTimer
;
bool
mCanRun
=
false
;
}
;
}
#
endif
