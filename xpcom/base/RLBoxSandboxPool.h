#
ifndef
SECURITY_RLBOX_SANDBOX_POOL_H_
#
define
SECURITY_RLBOX_SANDBOX_POOL_H_
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsITimer
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsINamed
.
h
"
#
include
"
mozilla
/
Mutex
.
h
"
#
include
"
mozilla
/
rlbox
/
rlbox_types
.
hpp
"
namespace
mozilla
{
class
RLBoxSandboxDataBase
;
class
RLBoxSandboxPoolData
;
class
RLBoxSandboxPool
:
public
nsITimerCallback
public
nsINamed
{
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSITIMERCALLBACK
NS_DECL_NSINAMED
RLBoxSandboxPool
(
size_t
aDelaySeconds
=
10
)
:
mPool
(
)
mDelaySeconds
(
aDelaySeconds
)
mMutex
(
"
RLBoxSandboxPool
:
:
mMutex
"
)
{
}
;
void
Push
(
UniquePtr
<
RLBoxSandboxDataBase
>
sbx
)
;
UniquePtr
<
RLBoxSandboxPoolData
>
PopOrCreate
(
uint64_t
aMinSize
=
0
)
;
protected
:
virtual
UniquePtr
<
RLBoxSandboxDataBase
>
CreateSandboxData
(
uint64_t
aSize
)
=
0
;
virtual
~
RLBoxSandboxPool
(
)
=
default
;
private
:
void
StartTimer
(
)
REQUIRES
(
mMutex
)
;
void
CancelTimer
(
)
REQUIRES
(
mMutex
)
;
nsTArray
<
UniquePtr
<
RLBoxSandboxDataBase
>
>
mPool
GUARDED_BY
(
mMutex
)
;
const
size_t
mDelaySeconds
GUARDED_BY
(
mMutex
)
;
nsCOMPtr
<
nsITimer
>
mTimer
GUARDED_BY
(
mMutex
)
;
mozilla
:
:
Mutex
mMutex
;
}
;
class
RLBoxSandboxDataBase
{
public
:
const
uint64_t
mSize
;
explicit
RLBoxSandboxDataBase
(
uint64_t
aSize
)
:
mSize
(
aSize
)
{
}
virtual
~
RLBoxSandboxDataBase
(
)
=
default
;
}
;
class
RLBoxSandboxPoolData
{
public
:
RLBoxSandboxPoolData
(
UniquePtr
<
RLBoxSandboxDataBase
>
aSbxData
RefPtr
<
RLBoxSandboxPool
>
aPool
)
{
mSbxData
=
std
:
:
move
(
aSbxData
)
;
mPool
=
aPool
;
MOZ_COUNT_CTOR
(
RLBoxSandboxPoolData
)
;
}
RLBoxSandboxDataBase
*
SandboxData
(
)
const
{
return
mSbxData
.
get
(
)
;
}
;
~
RLBoxSandboxPoolData
(
)
{
mPool
-
>
Push
(
std
:
:
move
(
mSbxData
)
)
;
MOZ_COUNT_DTOR
(
RLBoxSandboxPoolData
)
;
}
;
private
:
UniquePtr
<
RLBoxSandboxDataBase
>
mSbxData
;
RefPtr
<
RLBoxSandboxPool
>
mPool
;
}
;
}
#
endif
