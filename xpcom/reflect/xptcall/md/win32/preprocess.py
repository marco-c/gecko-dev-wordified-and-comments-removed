import
errno
import
sys
import
os
import
shlex
import
subprocess
import
tempfile
import
buildconfig
from
mozfile
import
which
def
preprocess
(
out
asm_file
)
:
    
cxx
=
shlex
.
split
(
buildconfig
.
substs
[
'
CXX
'
]
)
    
if
not
os
.
path
.
exists
(
cxx
[
0
]
)
:
        
tool
=
cxx
[
0
]
        
cxx
[
0
]
=
which
(
tool
)
        
if
not
cxx
[
0
]
:
            
raise
OSError
(
errno
.
ENOENT
"
Could
not
find
{
}
on
PATH
.
"
.
format
(
tool
)
)
    
cppflags
=
buildconfig
.
substs
[
'
OS_CPPFLAGS
'
]
    
(
outhandle
tmpout
)
=
tempfile
.
mkstemp
(
suffix
=
'
.
cpp
'
)
    
command
=
cxx
+
[
'
/
EP
'
]
+
cppflags
+
[
'
/
TP
'
asm_file
]
    
with
open
(
tmpout
'
wb
'
)
as
t
:
        
result
=
subprocess
.
Popen
(
command
stdout
=
t
)
.
wait
(
)
        
if
result
!
=
0
:
            
sys
.
exit
(
result
)
    
with
open
(
tmpout
'
rb
'
)
as
t
:
        
out
.
write
(
t
.
read
(
)
)
    
os
.
close
(
outhandle
)
    
os
.
remove
(
tmpout
)
