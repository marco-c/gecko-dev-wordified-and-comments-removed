#
ifndef
nsAtom_h
#
define
nsAtom_h
#
include
"
nsISupportsImpl
.
h
"
#
include
"
nsString
.
h
"
#
include
"
mozilla
/
HashFunctions
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
namespace
mozilla
{
struct
AtomsSizes
;
}
class
nsStaticAtom
;
class
nsDynamicAtom
;
class
nsAtom
{
public
:
void
AddSizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
mozilla
:
:
AtomsSizes
&
aSizes
)
const
;
enum
class
AtomKind
:
uint8_t
{
Static
=
0
DynamicNormal
=
1
DynamicHTML5
=
2
}
;
bool
Equals
(
char16ptr_t
aString
uint32_t
aLength
)
const
{
return
mLength
=
=
aLength
&
&
memcmp
(
GetUTF16String
(
)
aString
mLength
*
sizeof
(
char16_t
)
)
=
=
0
;
}
bool
Equals
(
const
nsAString
&
aString
)
const
{
return
Equals
(
aString
.
BeginReading
(
)
aString
.
Length
(
)
)
;
}
AtomKind
Kind
(
)
const
{
return
static_cast
<
AtomKind
>
(
mKind
)
;
}
bool
IsStatic
(
)
const
{
return
Kind
(
)
=
=
AtomKind
:
:
Static
;
}
bool
IsDynamic
(
)
const
{
return
Kind
(
)
=
=
AtomKind
:
:
DynamicNormal
|
|
Kind
(
)
=
=
AtomKind
:
:
DynamicHTML5
;
}
bool
IsDynamicHTML5
(
)
const
{
return
Kind
(
)
=
=
AtomKind
:
:
DynamicHTML5
;
}
const
nsStaticAtom
*
AsStatic
(
)
const
;
const
nsDynamicAtom
*
AsDynamic
(
)
const
;
nsDynamicAtom
*
AsDynamic
(
)
;
char16ptr_t
GetUTF16String
(
)
const
;
uint32_t
GetLength
(
)
const
{
return
mLength
;
}
void
ToString
(
nsAString
&
aString
)
const
;
void
ToUTF8String
(
nsACString
&
aString
)
const
;
uint32_t
hash
(
)
const
{
MOZ_ASSERT
(
!
IsDynamicHTML5
(
)
)
;
return
mHash
;
}
MozExternalRefCountType
AddRef
(
)
;
MozExternalRefCountType
Release
(
)
;
typedef
mozilla
:
:
TrueType
HasThreadSafeRefCnt
;
protected
:
constexpr
nsAtom
(
const
char16_t
*
aStr
uint32_t
aLength
)
:
mLength
(
aLength
)
mKind
(
static_cast
<
uint32_t
>
(
nsAtom
:
:
AtomKind
:
:
Static
)
)
mHash
(
mozilla
:
:
HashString
(
aStr
)
)
{
}
nsAtom
(
AtomKind
aKind
const
nsAString
&
aString
uint32_t
aHash
)
:
mLength
(
aString
.
Length
(
)
)
mKind
(
static_cast
<
uint32_t
>
(
aKind
)
)
mHash
(
aHash
)
{
MOZ_ASSERT
(
aKind
=
=
AtomKind
:
:
DynamicNormal
|
|
aKind
=
=
AtomKind
:
:
DynamicHTML5
)
;
}
~
nsAtom
(
)
=
default
;
const
uint32_t
mLength
:
30
;
const
uint32_t
mKind
:
2
;
const
uint32_t
mHash
;
}
;
class
nsStaticAtom
:
public
nsAtom
{
public
:
MozExternalRefCountType
AddRef
(
)
=
delete
;
MozExternalRefCountType
Release
(
)
=
delete
;
constexpr
nsStaticAtom
(
const
char16_t
*
aStr
uint32_t
aLength
uint32_t
aStringOffset
)
:
nsAtom
(
aStr
aLength
)
mStringOffset
(
aStringOffset
)
{
}
const
char16_t
*
String
(
)
const
{
return
reinterpret_cast
<
const
char16_t
*
>
(
uintptr_t
(
this
)
-
mStringOffset
)
;
}
already_AddRefed
<
nsAtom
>
ToAddRefed
(
)
{
return
already_AddRefed
<
nsAtom
>
(
static_cast
<
nsAtom
*
>
(
this
)
)
;
}
private
:
uint32_t
mStringOffset
;
}
;
class
nsDynamicAtom
:
public
nsAtom
{
public
:
MozExternalRefCountType
AddRef
(
)
;
MozExternalRefCountType
Release
(
)
;
const
char16_t
*
String
(
)
const
{
return
reinterpret_cast
<
const
char16_t
*
>
(
this
+
1
)
;
}
static
nsDynamicAtom
*
FromChars
(
char16_t
*
chars
)
{
return
reinterpret_cast
<
nsDynamicAtom
*
>
(
chars
)
-
1
;
}
private
:
friend
class
nsAtomTable
;
friend
class
nsAtomSubTable
;
friend
class
nsHtml5AtomEntry
;
static
nsDynamicAtom
*
CreateInner
(
const
nsAString
&
aString
uint32_t
aHash
)
;
nsDynamicAtom
(
const
nsAString
&
aString
uint32_t
aHash
)
;
~
nsDynamicAtom
(
)
{
}
static
nsDynamicAtom
*
Create
(
const
nsAString
&
aString
uint32_t
aHash
)
;
static
nsDynamicAtom
*
Create
(
const
nsAString
&
aString
)
;
static
void
Destroy
(
nsDynamicAtom
*
aAtom
)
;
mozilla
:
:
ThreadSafeAutoRefCnt
mRefCnt
;
}
;
already_AddRefed
<
nsAtom
>
NS_Atomize
(
const
char
*
aUTF8String
)
;
already_AddRefed
<
nsAtom
>
NS_Atomize
(
const
nsACString
&
aUTF8String
)
;
already_AddRefed
<
nsAtom
>
NS_Atomize
(
const
char16_t
*
aUTF16String
)
;
already_AddRefed
<
nsAtom
>
NS_Atomize
(
const
nsAString
&
aUTF16String
)
;
already_AddRefed
<
nsAtom
>
NS_AtomizeMainThread
(
const
nsAString
&
aUTF16String
)
;
nsrefcnt
NS_GetNumberOfAtoms
(
)
;
nsStaticAtom
*
NS_GetStaticAtom
(
const
nsAString
&
aUTF16String
)
;
void
NS_SetStaticAtomsDone
(
)
;
class
nsAtomString
:
public
nsString
{
public
:
explicit
nsAtomString
(
const
nsAtom
*
aAtom
)
{
aAtom
-
>
ToString
(
*
this
)
;
}
}
;
class
nsAtomCString
:
public
nsCString
{
public
:
explicit
nsAtomCString
(
nsAtom
*
aAtom
)
{
aAtom
-
>
ToUTF8String
(
*
this
)
;
}
}
;
class
nsDependentAtomString
:
public
nsDependentString
{
public
:
explicit
nsDependentAtomString
(
const
nsAtom
*
aAtom
)
:
nsDependentString
(
aAtom
-
>
GetUTF16String
(
)
aAtom
-
>
GetLength
(
)
)
{
}
}
;
void
ToLowerCaseASCII
(
RefPtr
<
nsAtom
>
&
aAtom
)
;
#
endif
