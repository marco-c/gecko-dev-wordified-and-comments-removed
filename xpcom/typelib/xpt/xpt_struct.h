#
ifndef
xpt_struct_h
#
define
xpt_struct_h
#
include
"
nsID
.
h
"
#
include
<
stdint
.
h
>
struct
XPTHeader
;
struct
XPTInterfaceDirectoryEntry
;
struct
XPTInterfaceDescriptor
;
struct
XPTConstDescriptor
;
struct
XPTMethodDescriptor
;
struct
XPTParamDescriptor
;
struct
XPTTypeDescriptor
;
struct
XPTTypeDescriptorPrefix
;
struct
XPTHeader
{
uint8_t
major_version
;
uint16_t
num_interfaces
;
const
XPTInterfaceDirectoryEntry
*
interface_directory
;
}
;
#
define
XPT_MAJOR_INCOMPATIBLE_VERSION
0x02
struct
XPTInterfaceDirectoryEntry
{
nsID
iid
;
const
char
*
name
;
const
XPTInterfaceDescriptor
*
interface_descriptor
;
}
;
struct
XPTInterfaceDescriptor
{
static
const
uint8_t
kScriptableMask
=
0x80
;
static
const
uint8_t
kFunctionMask
=
0x40
;
static
const
uint8_t
kBuiltinClassMask
=
0x20
;
static
const
uint8_t
kMainProcessScriptableOnlyMask
=
0x10
;
bool
IsScriptable
(
)
const
{
return
!
!
(
flags
&
kScriptableMask
)
;
}
bool
IsFunction
(
)
const
{
return
!
!
(
flags
&
kFunctionMask
)
;
}
bool
IsBuiltinClass
(
)
const
{
return
!
!
(
flags
&
kBuiltinClassMask
)
;
}
bool
IsMainProcessScriptableOnly
(
)
const
{
return
!
!
(
flags
&
kMainProcessScriptableOnlyMask
)
;
}
const
XPTMethodDescriptor
*
method_descriptors
;
XPTConstDescriptor
*
const_descriptors
;
XPTTypeDescriptor
*
additional_types
;
uint16_t
parent_interface
;
uint16_t
num_methods
;
uint16_t
num_constants
;
uint8_t
flags
;
uint8_t
num_additional_types
;
}
;
struct
XPTTypeDescriptorPrefix
{
uint8_t
TagPart
(
)
const
{
static
const
uint8_t
kFlagMask
=
0xe0
;
return
(
uint8_t
)
(
flags
&
~
kFlagMask
)
;
}
uint8_t
flags
;
}
;
enum
XPTTypeDescriptorTags
{
TD_INT8
=
0
TD_INT16
=
1
TD_INT32
=
2
TD_INT64
=
3
TD_UINT8
=
4
TD_UINT16
=
5
TD_UINT32
=
6
TD_UINT64
=
7
TD_FLOAT
=
8
TD_DOUBLE
=
9
TD_BOOL
=
10
TD_CHAR
=
11
TD_WCHAR
=
12
TD_VOID
=
13
TD_PNSIID
=
14
TD_DOMSTRING
=
15
TD_PSTRING
=
16
TD_PWSTRING
=
17
TD_INTERFACE_TYPE
=
18
TD_INTERFACE_IS_TYPE
=
19
TD_ARRAY
=
20
TD_PSTRING_SIZE_IS
=
21
TD_PWSTRING_SIZE_IS
=
22
TD_UTF8STRING
=
23
TD_CSTRING
=
24
TD_ASTRING
=
25
TD_JSVAL
=
26
}
;
struct
XPTTypeDescriptor
{
uint8_t
Tag
(
)
const
{
return
prefix
.
TagPart
(
)
;
}
XPTTypeDescriptorPrefix
prefix
;
union
{
struct
{
uint8_t
argnum
;
}
interface_is
;
struct
{
uint8_t
argnum
;
}
pstring_is
;
struct
{
uint8_t
argnum
;
uint8_t
additional_type
;
}
array
;
struct
{
uint8_t
iface_hi8
;
uint8_t
iface_lo8
;
}
iface
;
}
u
;
}
;
union
XPTConstValue
{
int16_t
i16
;
uint16_t
ui16
;
int32_t
i32
;
uint32_t
ui32
;
}
;
struct
XPTConstDescriptor
{
const
char
*
name
;
XPTTypeDescriptor
type
;
union
XPTConstValue
value
;
}
;
struct
XPTParamDescriptor
{
uint8_t
flags
;
XPTTypeDescriptor
type
;
}
;
struct
XPTMethodDescriptor
{
const
char
*
name
;
XPTParamDescriptor
*
params
;
uint8_t
flags
;
uint8_t
num_args
;
}
;
#
endif
