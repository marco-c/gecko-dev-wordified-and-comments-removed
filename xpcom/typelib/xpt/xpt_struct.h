#
ifndef
xpt_struct_h
#
define
xpt_struct_h
#
include
"
nsID
.
h
"
#
include
<
stdint
.
h
>
#
include
"
mozilla
/
Assertions
.
h
"
struct
XPTInterfaceDirectoryEntry
;
struct
XPTInterfaceDescriptor
;
struct
XPTConstDescriptor
;
struct
XPTMethodDescriptor
;
struct
XPTParamDescriptor
;
struct
XPTTypeDescriptor
;
struct
XPTTypeDescriptorPrefix
;
struct
XPTHeader
{
static
const
uint16_t
kNumInterfaces
;
static
const
XPTInterfaceDirectoryEntry
kInterfaceDirectory
[
]
;
static
const
XPTInterfaceDescriptor
kInterfaces
[
]
;
static
const
XPTTypeDescriptor
kTypes
[
]
;
static
const
XPTParamDescriptor
kParams
[
]
;
static
const
XPTMethodDescriptor
kMethods
[
]
;
static
const
XPTConstDescriptor
kConsts
[
]
;
static
const
char
kStrings
[
]
;
}
;
struct
XPTInterfaceDirectoryEntry
{
inline
const
XPTInterfaceDescriptor
*
InterfaceDescriptor
(
)
const
;
inline
const
char
*
Name
(
)
const
;
nsID
mIID
;
uint32_t
mName
;
uint32_t
mInterfaceDescriptor
;
}
;
struct
XPTInterfaceDescriptor
{
static
const
uint8_t
kScriptableMask
=
0x80
;
static
const
uint8_t
kFunctionMask
=
0x40
;
static
const
uint8_t
kBuiltinClassMask
=
0x20
;
static
const
uint8_t
kMainProcessScriptableOnlyMask
=
0x10
;
bool
IsScriptable
(
)
const
{
return
!
!
(
mFlags
&
kScriptableMask
)
;
}
bool
IsFunction
(
)
const
{
return
!
!
(
mFlags
&
kFunctionMask
)
;
}
bool
IsBuiltinClass
(
)
const
{
return
!
!
(
mFlags
&
kBuiltinClassMask
)
;
}
bool
IsMainProcessScriptableOnly
(
)
const
{
return
!
!
(
mFlags
&
kMainProcessScriptableOnlyMask
)
;
}
inline
const
XPTMethodDescriptor
&
Method
(
size_t
aIndex
)
const
;
inline
const
XPTConstDescriptor
&
Const
(
size_t
aIndex
)
const
;
uint16_t
mMethodDescriptors
;
uint16_t
mConstDescriptors
;
uint16_t
mParentInterface
;
uint16_t
mNumMethods
;
uint16_t
mNumConstants
;
uint8_t
mFlags
;
}
;
struct
XPTTypeDescriptorPrefix
{
uint8_t
TagPart
(
)
const
{
static
const
uint8_t
kFlagMask
=
0xe0
;
return
(
uint8_t
)
(
mFlags
&
~
kFlagMask
)
;
}
uint8_t
mFlags
;
}
;
enum
XPTTypeDescriptorTags
{
TD_INT8
=
0
TD_INT16
=
1
TD_INT32
=
2
TD_INT64
=
3
TD_UINT8
=
4
TD_UINT16
=
5
TD_UINT32
=
6
TD_UINT64
=
7
TD_FLOAT
=
8
TD_DOUBLE
=
9
TD_BOOL
=
10
TD_CHAR
=
11
TD_WCHAR
=
12
TD_VOID
=
13
TD_PNSIID
=
14
TD_DOMSTRING
=
15
TD_PSTRING
=
16
TD_PWSTRING
=
17
TD_INTERFACE_TYPE
=
18
TD_INTERFACE_IS_TYPE
=
19
TD_ARRAY
=
20
TD_PSTRING_SIZE_IS
=
21
TD_PWSTRING_SIZE_IS
=
22
TD_UTF8STRING
=
23
TD_CSTRING
=
24
TD_ASTRING
=
25
TD_JSVAL
=
26
}
;
struct
XPTTypeDescriptor
{
uint8_t
Tag
(
)
const
{
return
mPrefix
.
TagPart
(
)
;
}
uint8_t
ArgNum
(
)
const
{
MOZ_ASSERT
(
Tag
(
)
=
=
TD_INTERFACE_IS_TYPE
|
|
Tag
(
)
=
=
TD_PSTRING_SIZE_IS
|
|
Tag
(
)
=
=
TD_PWSTRING_SIZE_IS
|
|
Tag
(
)
=
=
TD_ARRAY
)
;
return
mData1
;
}
const
XPTTypeDescriptor
*
ArrayElementType
(
)
const
{
MOZ_ASSERT
(
Tag
(
)
=
=
TD_ARRAY
)
;
return
&
XPTHeader
:
:
kTypes
[
mData2
]
;
}
uint16_t
InterfaceIndex
(
)
const
{
MOZ_ASSERT
(
Tag
(
)
=
=
TD_INTERFACE_TYPE
)
;
return
(
mData1
<
<
8
)
|
mData2
;
}
XPTTypeDescriptorPrefix
mPrefix
;
uint8_t
mData1
;
uint8_t
mData2
;
}
;
union
XPTConstValue
{
int16_t
i16
;
uint16_t
ui16
;
int32_t
i32
;
uint32_t
ui32
;
}
;
struct
XPTConstDescriptor
{
const
char
*
Name
(
)
const
{
return
&
XPTHeader
:
:
kStrings
[
mName
]
;
}
uint32_t
mName
;
XPTTypeDescriptor
mType
;
union
XPTConstValue
mValue
;
}
;
struct
XPTParamDescriptor
{
uint8_t
mFlags
;
XPTTypeDescriptor
mType
;
}
;
struct
XPTMethodDescriptor
{
const
char
*
Name
(
)
const
{
return
&
XPTHeader
:
:
kStrings
[
mName
]
;
}
const
XPTParamDescriptor
&
Param
(
uint8_t
aIndex
)
const
{
return
XPTHeader
:
:
kParams
[
mParams
+
aIndex
]
;
}
uint32_t
mName
;
uint32_t
mParams
;
uint8_t
mFlags
;
uint8_t
mNumArgs
;
}
;
const
char
*
XPTInterfaceDirectoryEntry
:
:
Name
(
)
const
{
return
&
XPTHeader
:
:
kStrings
[
mName
]
;
}
const
XPTInterfaceDescriptor
*
XPTInterfaceDirectoryEntry
:
:
InterfaceDescriptor
(
)
const
{
if
(
mInterfaceDescriptor
=
=
0
)
{
return
nullptr
;
}
return
&
XPTHeader
:
:
kInterfaces
[
mInterfaceDescriptor
-
1
]
;
}
const
XPTMethodDescriptor
&
XPTInterfaceDescriptor
:
:
Method
(
size_t
aIndex
)
const
{
return
XPTHeader
:
:
kMethods
[
mMethodDescriptors
+
aIndex
]
;
}
const
XPTConstDescriptor
&
XPTInterfaceDescriptor
:
:
Const
(
size_t
aIndex
)
const
{
return
XPTHeader
:
:
kConsts
[
mConstDescriptors
+
aIndex
]
;
}
#
endif
