#
include
<
Types
.
h
>
#
include
<
Errors
.
h
>
#
include
<
Memory
.
h
>
#
include
<
Files
.
h
>
#
include
<
Script
.
h
>
#
define
__COMPILINGMOREFILES
#
include
"
MoreFiles
.
h
"
#
include
"
MoreFilesExtras
.
h
"
#
include
"
MoreDesktopMgr
.
h
"
#
include
"
FileCopy
.
h
"
#
include
"
MacDirectoryCopy
.
h
"
#
include
<
string
.
h
>
enum
{
getNextItemOp
=
1
copyDirCommentOp
=
2
copyDirAccessPrivsOp
=
3
copyDirFMAttributesOp
=
4
dirCreateOp
=
5
fileCopyOp
=
6
}
;
#
define
CallCopyErrProc
(
userRoutine
error
failedOperation
srcVRefNum
srcDirID
srcName
dstVRefNum
dstDirID
dstName
)
\
(
*
(
userRoutine
)
)
(
(
error
)
(
failedOperation
)
(
srcVRefNum
)
(
srcDirID
)
(
srcName
)
(
dstVRefNum
)
(
dstDirID
)
(
dstName
)
)
typedef
pascal
Boolean
(
*
CopyFilterProcPtr
)
(
const
CInfoPBRec
*
const
cpbPtr
)
;
#
define
CallCopyFilterProc
(
userRoutine
cpbPtr
)
(
*
(
userRoutine
)
)
(
(
cpbPtr
)
)
enum
{
dirCopyBigCopyBuffSize
=
0x00004000
dirCopyMinCopyBuffSize
=
0x00000200
}
;
#
if
PRAGMA_STRUCT_ALIGN
#
pragma
options
align
=
mac68k
#
endif
struct
EnumerateGlobals
{
Ptr
copyBuffer
;
long
bufferSize
;
CopyErrProcPtr
errorHandler
;
CopyFilterProcPtr
copyFilterProc
;
OSErr
error
;
Boolean
bailout
;
short
destinationVRefNum
;
Str63
itemName
;
CInfoPBRec
myCPB
;
}
;
#
if
PRAGMA_STRUCT_ALIGN
#
pragma
options
align
=
reset
#
endif
typedef
struct
EnumerateGlobals
EnumerateGlobals
;
typedef
EnumerateGlobals
*
EnumerateGlobalsPtr
;
#
if
PRAGMA_STRUCT_ALIGN
#
pragma
options
align
=
mac68k
#
endif
struct
PreflightGlobals
{
OSErr
result
;
Str63
itemName
;
CInfoPBRec
myCPB
;
unsigned
long
dstBlksPerAllocBlk
;
unsigned
long
allocBlksNeeded
;
unsigned
long
tempBlocks
;
CopyFilterProcPtr
copyFilterProc
;
}
;
#
if
PRAGMA_STRUCT_ALIGN
#
pragma
options
align
=
reset
#
endif
typedef
struct
PreflightGlobals
PreflightGlobals
;
typedef
PreflightGlobals
*
PreflightGlobalsPtr
;
static
void
GetLevelSize
(
long
currentDirID
PreflightGlobals
*
theGlobals
)
;
static
OSErr
PreflightDirectoryCopySpace
(
short
srcVRefNum
long
srcDirID
short
dstVRefNum
CopyFilterProcPtr
copyFilterProc
Boolean
*
spaceOK
)
;
static
void
CopyLevel
(
long
sourceDirID
long
dstDirID
EnumerateGlobals
*
theGlobals
)
;
static
void
GetLevelSize
(
long
currentDirID
PreflightGlobals
*
theGlobals
)
{
short
index
=
1
;
do
{
theGlobals
-
>
myCPB
.
dirInfo
.
ioFDirIndex
=
index
;
theGlobals
-
>
myCPB
.
dirInfo
.
ioDrDirID
=
currentDirID
;
theGlobals
-
>
result
=
PBGetCatInfoSync
(
&
theGlobals
-
>
myCPB
)
;
if
(
theGlobals
-
>
result
=
=
noErr
)
{
if
(
(
theGlobals
-
>
copyFilterProc
=
=
NULL
)
|
|
CallCopyFilterProc
(
theGlobals
-
>
copyFilterProc
&
theGlobals
-
>
myCPB
)
)
{
if
(
(
theGlobals
-
>
myCPB
.
dirInfo
.
ioFlAttrib
&
ioDirMask
)
!
=
0
)
{
GetLevelSize
(
theGlobals
-
>
myCPB
.
dirInfo
.
ioDrDirID
theGlobals
)
;
theGlobals
-
>
result
=
noErr
;
}
else
{
if
(
(
(
unsigned
long
)
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlLgLen
&
0x000001ff
)
!
=
0
)
{
theGlobals
-
>
tempBlocks
=
(
(
unsigned
long
)
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlLgLen
>
>
9
)
+
1
;
}
else
{
theGlobals
-
>
tempBlocks
=
(
unsigned
long
)
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlLgLen
>
>
9
;
}
if
(
theGlobals
-
>
tempBlocks
%
theGlobals
-
>
dstBlksPerAllocBlk
)
{
theGlobals
-
>
allocBlksNeeded
+
=
(
theGlobals
-
>
tempBlocks
/
theGlobals
-
>
dstBlksPerAllocBlk
)
+
1
;
}
else
{
theGlobals
-
>
allocBlksNeeded
+
=
theGlobals
-
>
tempBlocks
/
theGlobals
-
>
dstBlksPerAllocBlk
;
}
if
(
(
(
unsigned
long
)
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlRLgLen
&
0x000001ff
)
!
=
0
)
{
theGlobals
-
>
tempBlocks
=
(
(
unsigned
long
)
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlRLgLen
>
>
9
)
+
1
;
}
else
{
theGlobals
-
>
tempBlocks
=
(
unsigned
long
)
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlRLgLen
>
>
9
;
}
if
(
theGlobals
-
>
tempBlocks
%
theGlobals
-
>
dstBlksPerAllocBlk
)
{
theGlobals
-
>
allocBlksNeeded
+
=
(
theGlobals
-
>
tempBlocks
/
theGlobals
-
>
dstBlksPerAllocBlk
)
+
1
;
}
else
{
theGlobals
-
>
allocBlksNeeded
+
=
theGlobals
-
>
tempBlocks
/
theGlobals
-
>
dstBlksPerAllocBlk
;
}
}
}
}
+
+
index
;
}
while
(
theGlobals
-
>
result
=
=
noErr
)
;
}
static
OSErr
PreflightDirectoryCopySpace
(
short
srcVRefNum
long
srcDirID
short
dstVRefNum
CopyFilterProcPtr
copyFilterProc
Boolean
*
spaceOK
)
{
XVolumeParam
pb
;
OSErr
error
;
unsigned
long
dstFreeBlocks
;
PreflightGlobals
theGlobals
;
error
=
XGetVolumeInfoNoName
(
NULL
dstVRefNum
&
pb
)
;
if
(
error
=
=
noErr
)
{
dstFreeBlocks
=
(
pb
.
ioVFreeBytes
>
>
9
)
;
theGlobals
.
dstBlksPerAllocBlk
=
(
(
unsigned
long
)
pb
.
ioVAlBlkSiz
>
>
9
)
;
theGlobals
.
allocBlksNeeded
=
0
;
theGlobals
.
myCPB
.
dirInfo
.
ioNamePtr
=
theGlobals
.
itemName
;
theGlobals
.
myCPB
.
dirInfo
.
ioVRefNum
=
srcVRefNum
;
theGlobals
.
copyFilterProc
=
copyFilterProc
;
GetLevelSize
(
srcDirID
&
theGlobals
)
;
*
spaceOK
=
(
(
theGlobals
.
allocBlksNeeded
*
theGlobals
.
dstBlksPerAllocBlk
)
<
=
dstFreeBlocks
)
;
}
return
(
error
)
;
}
static
void
CopyLevel
(
long
sourceDirID
long
dstDirID
EnumerateGlobals
*
theGlobals
)
{
long
currentSrcDirID
;
long
newDirID
;
short
index
=
1
;
do
{
theGlobals
-
>
myCPB
.
dirInfo
.
ioFDirIndex
=
index
;
theGlobals
-
>
myCPB
.
dirInfo
.
ioDrDirID
=
sourceDirID
;
theGlobals
-
>
error
=
PBGetCatInfoSync
(
&
theGlobals
-
>
myCPB
)
;
if
(
theGlobals
-
>
error
=
=
noErr
)
{
if
(
(
theGlobals
-
>
copyFilterProc
=
=
NULL
)
|
|
CallCopyFilterProc
(
theGlobals
-
>
copyFilterProc
&
theGlobals
-
>
myCPB
)
)
{
if
(
(
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlAttrib
&
ioDirMask
)
!
=
0
)
{
theGlobals
-
>
error
=
DirCreate
(
theGlobals
-
>
destinationVRefNum
dstDirID
theGlobals
-
>
itemName
&
newDirID
)
;
if
(
theGlobals
-
>
error
=
=
noErr
)
{
currentSrcDirID
=
theGlobals
-
>
myCPB
.
dirInfo
.
ioDrDirID
;
CopyLevel
(
theGlobals
-
>
myCPB
.
dirInfo
.
ioDrDirID
newDirID
theGlobals
)
;
if
(
!
theGlobals
-
>
bailout
)
{
(
void
)
DTCopyComment
(
theGlobals
-
>
myCPB
.
dirInfo
.
ioVRefNum
currentSrcDirID
NULL
theGlobals
-
>
destinationVRefNum
newDirID
NULL
)
;
theGlobals
-
>
error
=
CopyFileMgrAttributes
(
theGlobals
-
>
myCPB
.
dirInfo
.
ioVRefNum
currentSrcDirID
NULL
theGlobals
-
>
destinationVRefNum
newDirID
NULL
true
)
;
if
(
theGlobals
-
>
error
!
=
noErr
)
{
if
(
theGlobals
-
>
errorHandler
!
=
NULL
)
{
theGlobals
-
>
bailout
=
CallCopyErrProc
(
theGlobals
-
>
errorHandler
theGlobals
-
>
error
copyDirFMAttributesOp
theGlobals
-
>
myCPB
.
dirInfo
.
ioVRefNum
currentSrcDirID
NULL
theGlobals
-
>
destinationVRefNum
newDirID
NULL
)
;
}
else
{
theGlobals
-
>
bailout
=
true
;
}
}
}
}
else
{
if
(
theGlobals
-
>
errorHandler
!
=
NULL
)
{
theGlobals
-
>
bailout
=
CallCopyErrProc
(
theGlobals
-
>
errorHandler
theGlobals
-
>
error
dirCreateOp
theGlobals
-
>
myCPB
.
dirInfo
.
ioVRefNum
currentSrcDirID
NULL
theGlobals
-
>
destinationVRefNum
dstDirID
theGlobals
-
>
itemName
)
;
}
else
{
theGlobals
-
>
bailout
=
true
;
}
}
if
(
!
theGlobals
-
>
bailout
)
{
theGlobals
-
>
error
=
noErr
;
}
}
else
{
theGlobals
-
>
error
=
FileCopy
(
theGlobals
-
>
myCPB
.
hFileInfo
.
ioVRefNum
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlParID
theGlobals
-
>
itemName
theGlobals
-
>
destinationVRefNum
dstDirID
NULL
NULL
theGlobals
-
>
copyBuffer
theGlobals
-
>
bufferSize
false
)
;
if
(
theGlobals
-
>
error
!
=
noErr
)
{
if
(
theGlobals
-
>
errorHandler
!
=
NULL
)
{
theGlobals
-
>
bailout
=
CallCopyErrProc
(
theGlobals
-
>
errorHandler
theGlobals
-
>
error
fileCopyOp
theGlobals
-
>
myCPB
.
hFileInfo
.
ioVRefNum
theGlobals
-
>
myCPB
.
hFileInfo
.
ioFlParID
theGlobals
-
>
itemName
theGlobals
-
>
destinationVRefNum
dstDirID
NULL
)
;
if
(
!
theGlobals
-
>
bailout
)
{
theGlobals
-
>
error
=
noErr
;
}
}
else
{
theGlobals
-
>
bailout
=
true
;
}
}
}
}
}
else
{
if
(
theGlobals
-
>
error
!
=
fnfErr
)
{
if
(
theGlobals
-
>
errorHandler
!
=
NULL
)
{
theGlobals
-
>
bailout
=
CallCopyErrProc
(
theGlobals
-
>
errorHandler
theGlobals
-
>
error
getNextItemOp
theGlobals
-
>
myCPB
.
dirInfo
.
ioVRefNum
sourceDirID
NULL
0
0
NULL
)
;
if
(
!
theGlobals
-
>
bailout
)
{
theGlobals
-
>
error
=
noErr
;
}
}
else
{
theGlobals
-
>
bailout
=
true
;
}
}
}
+
+
index
;
}
while
(
(
theGlobals
-
>
error
=
=
noErr
)
&
&
(
!
theGlobals
-
>
bailout
)
)
;
}
pascal
OSErr
FilteredDirectoryCopy
(
short
srcVRefNum
long
srcDirID
ConstStr255Param
srcName
short
dstVRefNum
long
dstDirID
ConstStr255Param
dstName
void
*
copyBufferPtr
long
copyBufferSize
Boolean
preflight
CopyErrProcPtr
copyErrHandler
CopyFilterProcPtr
copyFilterProc
ConstStr255Param
newName
)
;
pascal
OSErr
FilteredDirectoryCopy
(
short
srcVRefNum
long
srcDirID
ConstStr255Param
srcName
short
dstVRefNum
long
dstDirID
ConstStr255Param
dstName
void
*
copyBufferPtr
long
copyBufferSize
Boolean
preflight
CopyErrProcPtr
copyErrHandler
CopyFilterProcPtr
copyFilterProc
ConstStr255Param
newName
)
{
EnumerateGlobals
theGlobals
;
Boolean
isDirectory
;
OSErr
error
;
Boolean
ourCopyBuffer
=
false
;
Str63
srcDirName
oldDiskName
;
Boolean
spaceOK
;
if
(
copyBufferPtr
=
=
NULL
)
{
copyBufferSize
=
dirCopyBigCopyBuffSize
;
copyBufferPtr
=
NewPtr
(
copyBufferSize
)
;
if
(
copyBufferPtr
=
=
NULL
)
{
copyBufferSize
=
dirCopyMinCopyBuffSize
;
copyBufferPtr
=
NewPtr
(
copyBufferSize
)
;
if
(
copyBufferPtr
=
=
NULL
)
{
return
(
memFullErr
)
;
}
}
ourCopyBuffer
=
true
;
}
error
=
GetDirectoryID
(
srcVRefNum
srcDirID
srcName
&
srcDirID
&
isDirectory
)
;
if
(
error
!
=
noErr
)
{
goto
ErrorExit
;
}
if
(
!
isDirectory
)
{
error
=
dirNFErr
;
goto
ErrorExit
;
}
if
(
(
dstDirID
=
=
fsRtParID
)
&
&
(
dstName
=
=
NULL
)
)
{
dstDirID
=
fsRtParID
;
isDirectory
=
true
;
error
=
noErr
;
}
else
{
error
=
GetDirectoryID
(
dstVRefNum
dstDirID
dstName
&
dstDirID
&
isDirectory
)
;
if
(
error
!
=
noErr
)
{
goto
ErrorExit
;
}
if
(
!
isDirectory
)
{
error
=
dirNFErr
;
goto
ErrorExit
;
}
}
error
=
DetermineVRefNum
(
srcName
srcVRefNum
&
srcVRefNum
)
;
if
(
error
!
=
noErr
)
{
goto
ErrorExit
;
}
error
=
DetermineVRefNum
(
dstName
dstVRefNum
&
dstVRefNum
)
;
if
(
error
!
=
noErr
)
{
goto
ErrorExit
;
}
if
(
preflight
)
{
error
=
PreflightDirectoryCopySpace
(
srcVRefNum
srcDirID
dstVRefNum
copyFilterProc
&
spaceOK
)
;
if
(
error
!
=
noErr
)
{
goto
ErrorExit
;
}
if
(
!
spaceOK
)
{
error
=
dskFulErr
;
goto
ErrorExit
;
}
}
if
(
newName
[
0
]
=
=
0
)
{
error
=
GetDirName
(
srcVRefNum
srcDirID
srcDirName
)
;
if
(
error
!
=
noErr
)
{
goto
ErrorExit
;
}
}
else
{
memcpy
(
srcDirName
newName
32
)
;
}
if
(
dstDirID
=
=
fsRtParID
)
{
error
=
GetDirName
(
dstVRefNum
fsRtDirID
oldDiskName
)
;
if
(
error
=
=
noErr
)
{
TruncPString
(
srcDirName
srcDirName
27
)
;
error
=
HRename
(
dstVRefNum
fsRtParID
oldDiskName
srcDirName
)
;
dstDirID
=
fsRtDirID
;
}
}
else
{
error
=
DirCreate
(
dstVRefNum
dstDirID
srcDirName
&
dstDirID
)
;
}
if
(
error
!
=
noErr
)
{
if
(
copyErrHandler
!
=
NULL
)
{
if
(
CallCopyErrProc
(
copyErrHandler
error
dirCreateOp
srcVRefNum
srcDirID
NULL
dstVRefNum
dstDirID
srcDirName
)
)
{
goto
ErrorExit
;
}
else
{
error
=
noErr
;
}
}
else
{
goto
ErrorExit
;
}
}
theGlobals
.
copyBuffer
=
(
Ptr
)
copyBufferPtr
;
theGlobals
.
bufferSize
=
copyBufferSize
;
theGlobals
.
destinationVRefNum
=
dstVRefNum
;
theGlobals
.
myCPB
.
hFileInfo
.
ioNamePtr
=
(
StringPtr
)
&
theGlobals
.
itemName
;
theGlobals
.
myCPB
.
hFileInfo
.
ioVRefNum
=
srcVRefNum
;
theGlobals
.
errorHandler
=
copyErrHandler
;
theGlobals
.
bailout
=
false
;
theGlobals
.
copyFilterProc
=
copyFilterProc
;
CopyLevel
(
srcDirID
dstDirID
&
theGlobals
)
;
error
=
theGlobals
.
error
;
if
(
!
theGlobals
.
bailout
)
{
(
void
)
DTCopyComment
(
srcVRefNum
srcDirID
NULL
dstVRefNum
dstDirID
NULL
)
;
error
=
CopyFileMgrAttributes
(
srcVRefNum
srcDirID
NULL
dstVRefNum
dstDirID
NULL
true
)
;
if
(
(
error
!
=
noErr
)
&
&
(
copyErrHandler
!
=
NULL
)
)
{
theGlobals
.
bailout
=
CallCopyErrProc
(
copyErrHandler
error
copyDirFMAttributesOp
srcVRefNum
srcDirID
NULL
dstVRefNum
dstDirID
NULL
)
;
}
}
ErrorExit
:
if
(
ourCopyBuffer
)
{
DisposePtr
(
(
Ptr
)
copyBufferPtr
)
;
}
return
(
error
)
;
}
pascal
OSErr
MacFSpDirectoryCopyRename
(
const
FSSpec
*
srcSpec
const
FSSpec
*
dstSpec
ConstStr255Param
newName
void
*
copyBufferPtr
long
copyBufferSize
Boolean
preflight
CopyErrProcPtr
copyErrHandler
)
{
return
(
FilteredDirectoryCopy
(
srcSpec
-
>
vRefNum
srcSpec
-
>
parID
srcSpec
-
>
name
dstSpec
-
>
vRefNum
dstSpec
-
>
parID
dstSpec
-
>
name
copyBufferPtr
copyBufferSize
preflight
copyErrHandler
NULL
newName
)
)
;
}
