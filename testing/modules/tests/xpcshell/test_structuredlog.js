const
{
StructuredLogger
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
StructuredLog
.
sys
.
mjs
"
)
;
add_task
(
function
test_StructuredLogger
(
)
{
let
testBuffer
=
[
]
;
let
appendBuffer
=
function
(
msg
)
{
testBuffer
.
push
(
JSON
.
stringify
(
msg
)
)
;
}
;
let
assertLastMsg
=
function
(
refData
)
{
let
lastMsg
=
JSON
.
parse
(
testBuffer
.
pop
(
)
)
;
for
(
let
field
in
refData
)
{
deepEqual
(
lastMsg
[
field
]
refData
[
field
]
)
;
}
equal
(
lastMsg
.
source
"
test_log
"
)
;
}
;
let
logger
=
new
StructuredLogger
(
"
test_log
"
appendBuffer
)
;
logger
.
info
(
"
Test
message
"
)
;
assertLastMsg
(
{
action
:
"
log
"
message
:
"
Test
message
"
level
:
"
INFO
"
}
)
;
logger
.
info
(
"
Test
message
"
{
foo
:
"
bar
"
}
)
;
assertLastMsg
(
{
action
:
"
log
"
message
:
"
Test
message
"
level
:
"
INFO
"
extra
:
{
foo
:
"
bar
"
}
}
)
;
logger
.
testStart
(
"
aTest
"
)
;
assertLastMsg
(
{
test
:
"
aTest
"
action
:
"
test_start
"
}
)
;
logger
.
testEnd
(
"
aTest
"
"
OK
"
)
;
assertLastMsg
(
{
test
:
"
aTest
"
action
:
"
test_end
"
status
:
"
OK
"
}
)
;
logger
.
testStart
(
"
aTest
"
)
;
logger
.
testEnd
(
"
aTest
"
"
FAIL
"
"
PASS
"
)
;
assertLastMsg
(
{
action
:
"
test_end
"
test
:
"
aTest
"
status
:
"
FAIL
"
expected
:
"
PASS
"
}
)
;
logger
.
testStart
(
"
aTest
"
)
;
logger
.
testEnd
(
"
aTest
"
"
FAIL
"
"
PASS
"
null
"
Many
\
nlines
\
nof
\
nstack
\
n
"
)
;
assertLastMsg
(
{
action
:
"
test_end
"
test
:
"
aTest
"
status
:
"
FAIL
"
expected
:
"
PASS
"
stack
:
"
Many
\
nlines
\
nof
\
nstack
\
n
"
}
)
;
logger
.
testStart
(
"
aTest
"
)
;
logger
.
testEnd
(
"
aTest
"
"
SKIP
"
"
PASS
"
)
;
ok
(
!
JSON
.
parse
(
testBuffer
[
testBuffer
.
length
-
1
]
)
.
hasOwnProperty
(
"
expected
"
)
)
;
assertLastMsg
(
{
action
:
"
test_end
"
test
:
"
aTest
"
status
:
"
SKIP
"
}
)
;
logger
.
testStatus
(
"
aTest
"
"
foo
"
"
PASS
"
"
PASS
"
"
Passed
test
"
)
;
ok
(
!
JSON
.
parse
(
testBuffer
[
testBuffer
.
length
-
1
]
)
.
hasOwnProperty
(
"
expected
"
)
)
;
assertLastMsg
(
{
action
:
"
test_status
"
test
:
"
aTest
"
subtest
:
"
foo
"
status
:
"
PASS
"
message
:
"
Passed
test
"
}
)
;
logger
.
testStatus
(
"
aTest
"
"
bar
"
"
FAIL
"
)
;
assertLastMsg
(
{
action
:
"
test_status
"
test
:
"
aTest
"
subtest
:
"
bar
"
status
:
"
FAIL
"
expected
:
"
PASS
"
}
)
;
logger
.
testStatus
(
"
aTest
"
"
bar
"
"
FAIL
"
"
PASS
"
null
"
Many
\
nlines
\
nof
\
nstack
\
n
"
)
;
assertLastMsg
(
{
action
:
"
test_status
"
test
:
"
aTest
"
subtest
:
"
bar
"
status
:
"
FAIL
"
expected
:
"
PASS
"
stack
:
"
Many
\
nlines
\
nof
\
nstack
\
n
"
}
)
;
logger
.
testStatus
(
"
aTest
"
"
baz
"
"
SKIP
"
)
;
ok
(
!
JSON
.
parse
(
testBuffer
[
testBuffer
.
length
-
1
]
)
.
hasOwnProperty
(
"
expected
"
)
)
;
assertLastMsg
(
{
action
:
"
test_status
"
test
:
"
aTest
"
subtest
:
"
baz
"
status
:
"
SKIP
"
}
)
;
var
ids
=
{
aManifest
:
[
"
aTest
"
]
}
;
logger
.
suiteStart
(
ids
)
;
assertLastMsg
(
{
action
:
"
suite_start
"
tests
:
{
aManifest
:
[
"
aTest
"
]
}
}
)
;
logger
.
suiteEnd
(
)
;
assertLastMsg
(
{
action
:
"
suite_end
"
}
)
;
}
)
;
add_task
(
function
test_StructuredLogger_with_dumpScope
(
)
{
let
testBuffer
=
[
]
;
let
appendBuffer2
=
msg
=
>
{
testBuffer
.
push
(
msg
)
;
}
;
let
assertSeenMsg
=
(
expected
checkExtra
)
=
>
{
const
{
action
message
level
extra
}
=
testBuffer
.
shift
(
)
;
deepEqual
(
{
action
message
level
}
expected
)
;
ok
(
checkExtra
(
extra
)
Extra
:
{
uneval
(
extra
)
}
)
;
}
;
let
logger2
=
new
StructuredLogger
(
"
test_dump
"
appendBuffer2
globalThis
)
;
const
extraNotCloneable
=
{
notCloneable
:
(
)
=
>
{
}
}
;
logger2
.
info
(
"
Test
non
-
cloneable
"
extraNotCloneable
)
;
assertSeenMsg
(
{
action
:
"
log
"
message
:
"
Failed
to
cloneInto
:
Error
:
Permission
denied
to
pass
a
Function
via
structured
clone
"
level
:
"
ERROR
"
}
extra
=
>
extra
=
=
=
undefined
)
;
testBuffer
[
0
]
.
message
=
testBuffer
[
0
]
.
message
.
replace
(
/
time
:
\
d
+
/
"
time
:
123
"
)
;
assertSeenMsg
(
{
action
:
"
log
"
message
:
Tried
to
clone
:
(
{
action
:
"
log
"
time
:
123
thread
:
null
pid
:
null
source
:
"
test_dump
"
level
:
"
INFO
"
message
:
"
Test
non
-
cloneable
"
extra
:
{
notCloneable
:
(
)
=
>
{
}
}
}
)
level
:
"
WARNING
"
}
extra
=
>
extra
=
=
=
undefined
)
;
assertSeenMsg
(
{
action
:
"
log
"
message
:
"
Test
non
-
cloneable
"
level
:
"
INFO
"
}
extra
=
>
extra
=
=
=
extraNotCloneable
)
;
const
extraCloneable
=
{
cloneable
:
"
Yes
I
am
"
}
;
logger2
.
info
(
"
Test
cloneable
"
extraCloneable
)
;
assertSeenMsg
(
{
action
:
"
log
"
message
:
"
Test
cloneable
"
level
:
"
INFO
"
}
extra
=
>
{
deepEqual
(
extra
extraCloneable
)
;
return
extra
!
=
=
extraCloneable
;
}
)
;
equal
(
testBuffer
.
length
0
"
No
messages
unaccounted
for
"
)
;
}
)
;
