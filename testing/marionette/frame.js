"
use
strict
"
;
const
{
classes
:
Cc
interfaces
:
Ci
results
:
Cr
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
this
.
EXPORTED_SYMBOLS
=
[
"
frame
"
]
;
this
.
frame
=
{
}
;
const
FRAME_SCRIPT
=
"
chrome
:
/
/
marionette
/
content
/
listener
.
js
"
;
var
remoteFrames
=
[
]
;
frame
.
RemoteFrame
=
function
(
windowId
frameId
)
{
this
.
windowId
=
windowId
;
this
.
frameId
=
frameId
;
this
.
targetFrameId
=
this
.
frameId
;
this
.
remoteFrames
=
[
]
;
}
;
frame
.
Manager
=
class
{
constructor
(
driver
)
{
this
.
currentRemoteFrame
=
null
;
this
.
previousRemoteFrame
=
null
;
this
.
handledModal
=
false
;
this
.
driver
=
driver
;
}
receiveMessage
(
message
)
{
switch
(
message
.
name
)
{
case
"
MarionetteFrame
:
getInterruptedState
"
:
if
(
this
.
previousRemoteFrame
)
{
let
interruptedFrame
=
Services
.
wm
.
getOuterWindowWithId
(
this
.
previousRemoteFrame
.
windowId
)
;
if
(
this
.
previousRemoteFrame
.
frameId
!
=
=
null
)
{
let
iframes
=
interruptedFrame
.
document
.
getElementsByTagName
(
"
iframe
"
)
;
interruptedFrame
=
iframes
[
this
.
previousRemoteFrame
.
frameId
]
;
}
if
(
interruptedFrame
.
src
=
=
message
.
target
.
src
)
{
return
{
value
:
this
.
handledModal
}
;
}
}
else
if
(
this
.
currentRemoteFrame
=
=
=
null
)
{
return
{
value
:
this
.
handledModal
}
;
}
return
{
value
:
false
}
;
case
"
MarionetteFrame
:
handleModal
"
:
let
isLocal
=
true
;
if
(
this
.
currentRemoteFrame
!
=
=
null
)
{
isLocal
=
false
;
this
.
removeMessageManagerListeners
(
this
.
currentRemoteFrame
.
messageManager
.
get
(
)
)
;
this
.
previousRemoteFrame
=
this
.
currentRemoteFrame
;
this
.
currentRemoteFrame
=
null
;
this
.
driver
.
messageManager
=
Cc
[
"
mozilla
.
org
/
globalmessagemanager
;
1
"
]
.
getService
(
Ci
.
nsIMessageBroadcaster
)
;
}
this
.
handledModal
=
true
;
this
.
driver
.
sendOk
(
this
.
driver
.
command_id
)
;
return
{
value
:
isLocal
}
;
case
"
MarionetteFrame
:
getCurrentFrameId
"
:
if
(
this
.
currentRemoteFrame
!
=
=
null
)
{
return
this
.
currentRemoteFrame
.
frameId
;
}
}
}
getOopFrame
(
winId
frameId
)
{
let
outerWin
=
Services
.
wm
.
getOuterWindowWithId
(
winId
)
;
let
f
=
outerWin
.
document
.
getElementsByTagName
(
"
iframe
"
)
[
frameId
]
;
return
f
;
}
getFrameMM
(
winId
frameId
)
{
let
oopFrame
=
this
.
getOopFrame
(
winId
frameId
)
;
let
mm
=
oopFrame
.
QueryInterface
(
Ci
.
nsIFrameLoaderOwner
)
.
frameLoader
.
messageManager
;
return
mm
;
}
switchToFrame
(
winId
frameId
)
{
let
oopFrame
=
this
.
getOopFrame
(
winId
frameId
)
;
let
mm
=
this
.
getFrameMM
(
winId
frameId
)
;
for
(
let
i
=
0
;
i
<
remoteFrames
.
length
;
i
+
+
)
{
let
f
=
remoteFrames
[
i
]
;
let
fmm
=
f
.
messageManager
.
get
(
)
;
try
{
fmm
.
sendAsyncMessage
(
"
aliveCheck
"
{
}
)
;
}
catch
(
e
)
{
if
(
e
.
result
=
=
Cr
.
NS_ERROR_NOT_INITIALIZED
)
{
remoteFrames
.
splice
(
i
-
-
1
)
;
continue
;
}
}
if
(
fmm
=
=
mm
)
{
this
.
currentRemoteFrame
=
f
;
this
.
addMessageManagerListeners
(
mm
)
;
mm
.
sendAsyncMessage
(
"
Marionette
:
restart
"
)
;
return
oopFrame
.
id
;
}
}
this
.
addMessageManagerListeners
(
mm
)
;
let
f
=
new
frame
.
RemoteFrame
(
winId
frameId
)
;
f
.
messageManager
=
Cu
.
getWeakReference
(
mm
)
;
remoteFrames
.
push
(
f
)
;
this
.
currentRemoteFrame
=
f
;
mm
.
loadFrameScript
(
FRAME_SCRIPT
true
true
)
;
return
oopFrame
.
id
;
}
switchToModalOrigin
(
)
{
if
(
this
.
previousRemoteFrame
!
=
=
null
)
{
this
.
currentRemoteFrame
=
this
.
previousRemoteFrame
;
let
mm
=
this
.
currentRemoteFrame
.
messageManager
.
get
(
)
;
this
.
addMessageManagerListeners
(
mm
)
;
}
this
.
handledModal
=
false
;
}
addMessageManagerListeners
(
mm
)
{
mm
.
addWeakMessageListener
(
"
Marionette
:
ok
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
done
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
error
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
emitTouchEvent
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
log
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
shareData
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
switchToModalOrigin
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
switchedToFrame
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
getVisibleCookies
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
getImportedScripts
"
this
.
driver
.
importedScripts
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
register
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
Marionette
:
listenersAttached
"
this
.
driver
)
;
mm
.
addWeakMessageListener
(
"
MarionetteFrame
:
handleModal
"
this
)
;
mm
.
addWeakMessageListener
(
"
MarionetteFrame
:
getCurrentFrameId
"
this
)
;
mm
.
addWeakMessageListener
(
"
MarionetteFrame
:
getInterruptedState
"
this
)
;
}
removeMessageManagerListeners
(
mm
)
{
mm
.
removeWeakMessageListener
(
"
Marionette
:
ok
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
done
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
error
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
log
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
shareData
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
switchedToFrame
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
getVisibleCookies
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
getImportedScripts
"
this
.
driver
.
importedScripts
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
listenersAttached
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
Marionette
:
register
"
this
.
driver
)
;
mm
.
removeWeakMessageListener
(
"
MarionetteFrame
:
handleModal
"
this
)
;
mm
.
removeWeakMessageListener
(
"
MarionetteFrame
:
getCurrentFrameId
"
this
)
;
}
}
;
frame
.
Manager
.
prototype
.
QueryInterface
=
XPCOMUtils
.
generateQI
(
[
Ci
.
nsIMessageListener
Ci
.
nsISupportsWeakReference
]
)
;
