from
__future__
import
absolute_import
import
os
import
re
def
init_android_power_test
(
raptor
)
:
    
upload_dir
=
os
.
getenv
(
'
MOZ_UPLOAD_DIR
'
)
    
if
not
upload_dir
:
        
raptor
.
log
.
critical
(
"
%
power
test
ignored
;
MOZ_UPLOAD_DIR
unset
"
%
raptor
.
config
[
'
app
'
]
)
        
return
    
raptor
.
screen_off_timeout
=
raptor
.
device
.
shell_output
(
        
"
settings
get
system
screen_off_timeout
"
)
.
strip
(
)
    
raptor
.
device
.
shell_output
(
"
settings
put
system
screen_off_timeout
7200000
"
)
    
raptor
.
device
.
shell_output
(
"
dumpsys
batterystats
-
-
reset
"
)
    
raptor
.
device
.
shell_output
(
"
dumpsys
batterystats
-
-
enable
full
-
wake
-
history
"
)
    
filepath
=
os
.
path
.
join
(
upload_dir
'
battery
-
before
.
txt
'
)
    
with
open
(
filepath
'
w
'
)
as
output
:
        
output
.
write
(
raptor
.
device
.
shell_output
(
"
dumpsys
battery
"
)
)
def
finish_android_power_test
(
raptor
test_name
)
:
    
upload_dir
=
os
.
getenv
(
'
MOZ_UPLOAD_DIR
'
)
    
if
not
upload_dir
:
        
raptor
.
log
.
critical
(
"
%
power
test
ignored
because
MOZ_UPLOAD_DIR
was
not
set
"
%
test_name
)
        
return
    
raptor
.
device
.
shell_output
(
        
"
settings
put
system
screen_off_timeout
%
s
"
%
raptor
.
screen_off_timeout
)
    
filepath
=
os
.
path
.
join
(
upload_dir
'
battery
-
after
.
txt
'
)
    
with
open
(
filepath
'
w
'
)
as
output
:
        
output
.
write
(
raptor
.
device
.
shell_output
(
"
dumpsys
battery
"
)
)
    
verbose
=
raptor
.
device
.
_verbose
    
raptor
.
device
.
_verbose
=
False
    
filepath
=
os
.
path
.
join
(
upload_dir
'
batterystats
.
csv
'
)
    
with
open
(
filepath
'
w
'
)
as
output
:
        
output
.
write
(
raptor
.
device
.
shell_output
(
"
dumpsys
batterystats
-
-
checkin
"
)
)
    
filepath
=
os
.
path
.
join
(
upload_dir
'
batterystats
.
txt
'
)
    
with
open
(
filepath
'
w
'
)
as
output
:
        
batterystats
=
raptor
.
device
.
shell_output
(
"
dumpsys
batterystats
"
)
        
output
.
write
(
batterystats
)
    
raptor
.
device
.
_verbose
=
verbose
    
estimated_power
=
False
    
uid
=
None
    
total
=
cpu
=
wifi
=
smearing
=
screen
=
proportional
=
0
    
full_screen
=
0
    
full_wifi
=
0
    
re_uid
=
re
.
compile
(
r
'
proc
=
(
[
^
:
]
+
)
:
"
%
s
"
'
%
raptor
.
config
[
'
binary
'
]
)
    
re_estimated_power
=
re
.
compile
(
r
'
\
s
+
Estimated
power
use
[
(
]
mAh
[
)
]
'
)
    
re_proportional
=
re
.
compile
(
r
'
proportional
=
(
[
\
d
.
]
+
)
'
)
    
re_screen
=
re
.
compile
(
r
'
screen
=
(
[
\
d
.
]
+
)
'
)
    
re_full_screen
=
re
.
compile
(
r
'
\
s
+
Screen
:
\
s
+
(
[
\
d
.
]
+
)
'
)
    
re_full_wifi
=
re
.
compile
(
r
'
\
s
+
Wifi
:
\
s
+
(
[
\
d
.
]
+
)
'
)
    
re_power
=
None
    
batterystats
=
batterystats
.
split
(
'
\
n
'
)
    
for
line
in
batterystats
:
        
if
uid
is
None
:
            
match
=
re_uid
.
search
(
line
)
            
if
match
:
                
uid
=
match
.
group
(
1
)
                
re_power
=
re
.
compile
(
                    
r
'
\
s
+
Uid
%
s
:
\
s
+
(
[
\
d
.
]
+
)
(
[
(
]
cpu
=
(
[
\
d
.
]
+
)
wifi
=
(
[
\
d
.
]
+
)
[
)
]
'
                    
r
'
Including
smearing
:
(
[
\
d
.
]
+
)
)
?
'
%
uid
)
                
continue
        
if
not
estimated_power
:
            
match
=
re_estimated_power
.
match
(
line
)
            
if
match
:
                
estimated_power
=
True
            
continue
        
if
full_screen
=
=
0
:
            
match
=
re_full_screen
.
match
(
line
)
            
if
match
:
                
full_screen
=
match
.
group
(
1
)
                
continue
        
if
full_wifi
=
=
0
:
            
match
=
re_full_wifi
.
match
(
line
)
            
if
match
:
                
full_wifi
=
match
.
group
(
1
)
                
continue
        
if
re_power
:
            
match
=
re_power
.
match
(
line
)
            
if
match
:
                
(
total
android8
cpu
wifi
smearing
)
=
match
.
groups
(
)
                
if
android8
:
                    
match
=
re_screen
.
search
(
line
)
                    
if
match
:
                        
screen
=
match
.
group
(
1
)
                    
match
=
re_proportional
.
search
(
line
)
                    
if
match
:
                        
proportional
=
match
.
group
(
1
)
        
if
full_screen
and
full_wifi
and
(
cpu
and
wifi
and
smearing
or
total
)
:
            
break
    
cpu
=
total
if
cpu
is
None
else
cpu
    
screen
=
full_screen
if
screen
=
=
0
else
screen
    
wifi
=
full_wifi
if
wifi
is
None
else
wifi
    
raptor
.
log
.
info
(
'
power
data
for
uid
:
%
s
cpu
:
%
s
wifi
:
%
s
screen
:
%
s
proportional
:
%
s
'
%
                    
(
uid
cpu
wifi
screen
proportional
)
)
    
power_data
=
{
'
type
'
:
'
power
'
                  
'
test
'
:
test_name
                  
'
unit
'
:
'
mAh
'
                  
'
values
'
:
{
                      
'
cpu
'
:
float
(
cpu
)
                      
'
wifi
'
:
float
(
wifi
)
                      
'
screen
'
:
float
(
screen
)
                      
'
proportional
'
:
float
(
proportional
)
}
}
    
raptor
.
log
.
info
(
"
submitting
power
data
via
control
server
directly
"
)
    
raptor
.
control_server
.
submit_supporting_data
(
power_data
)
    
raptor
.
log
.
info
(
"
generating
power
bugreport
zip
"
)
    
raptor
.
device
.
command_output
(
[
"
bugreport
"
upload_dir
]
)
