import
os
import
shutil
import
sys
import
tarfile
import
tempfile
from
unittest
.
mock
import
patch
import
mozunit
here
=
os
.
path
.
abspath
(
os
.
path
.
dirname
(
__file__
)
)
raptor_dir
=
os
.
path
.
join
(
os
.
path
.
dirname
(
here
)
"
raptor
"
)
sys
.
path
.
insert
(
0
raptor_dir
)
from
gecko_profile
import
GeckoProfile
patch
(
"
logger
.
logger
.
RaptorLogger
.
info
"
)
patch
(
"
logger
.
logger
.
RaptorLogger
.
critical
"
)
def
test_browsertime_profiling
(
mock_log_info
mock_log_critical
)
:
    
result_dir
=
tempfile
.
mkdtemp
(
)
    
with
tarfile
.
open
(
os
.
path
.
join
(
here
"
geckoProfileTest
.
tar
"
)
)
as
f
:
        
f
.
extractall
(
path
=
result_dir
)
    
upload_dir
=
tempfile
.
mkdtemp
(
)
    
symbols_path
=
tempfile
.
mkdtemp
(
)
    
raptor_config
=
{
        
"
symbols_path
"
:
symbols_path
        
"
browsertime
"
:
True
        
"
browsertime_result_dir
"
:
os
.
path
.
join
(
result_dir
"
amazon
"
)
    
}
    
test_config
=
{
"
name
"
:
"
tp6
"
}
    
try
:
        
profile
=
GeckoProfile
(
upload_dir
raptor_config
test_config
)
        
profile
.
symbolicate
(
)
        
profile
.
clean
(
)
        
arcname
=
os
.
environ
[
"
RAPTOR_LATEST_GECKO_PROFILE_ARCHIVE
"
]
        
assert
os
.
stat
(
arcname
)
.
st_size
>
1000000
"
We
got
a
1mb
+
zip
"
    
except
Exception
:
        
assert
False
"
Symbolication
failed
!
"
        
raise
    
finally
:
        
shutil
.
rmtree
(
upload_dir
)
        
shutil
.
rmtree
(
symbols_path
)
        
shutil
.
rmtree
(
result_dir
)
if
__name__
=
=
"
__main__
"
:
    
mozunit
.
main
(
)
