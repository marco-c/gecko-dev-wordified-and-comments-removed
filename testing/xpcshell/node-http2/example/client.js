var
fs
=
require
(
'
fs
'
)
;
var
path
=
require
(
'
path
'
)
;
var
http2
=
require
(
'
.
.
'
)
;
var
urlParse
=
require
(
'
url
'
)
.
parse
;
http2
.
globalAgent
=
new
http2
.
Agent
(
{
rejectUnauthorized
:
true
log
:
require
(
'
.
.
/
test
/
util
'
)
.
createLogger
(
'
client
'
)
}
)
;
var
url
=
process
.
argv
.
pop
(
)
;
var
options
=
urlParse
(
url
)
;
if
(
options
.
hostname
=
=
'
localhost
'
)
{
options
.
key
=
fs
.
readFileSync
(
path
.
join
(
__dirname
'
/
localhost
.
key
'
)
)
;
options
.
ca
=
fs
.
readFileSync
(
path
.
join
(
__dirname
'
/
localhost
.
crt
'
)
)
;
}
var
request
=
process
.
env
.
HTTP2_PLAIN
?
http2
.
raw
.
get
(
options
)
:
http2
.
get
(
options
)
;
request
.
on
(
'
response
'
function
(
response
)
{
response
.
pipe
(
process
.
stdout
)
;
response
.
on
(
'
end
'
finish
)
;
}
)
;
request
.
on
(
'
push
'
function
(
pushRequest
)
{
var
filename
=
path
.
join
(
__dirname
'
/
push
-
'
+
push_count
)
;
push_count
+
=
1
;
console
.
error
(
'
Receiving
pushed
resource
:
'
+
pushRequest
.
url
+
'
-
>
'
+
filename
)
;
pushRequest
.
on
(
'
response
'
function
(
pushResponse
)
{
pushResponse
.
pipe
(
fs
.
createWriteStream
(
filename
)
)
.
on
(
'
finish
'
finish
)
;
}
)
;
}
)
;
var
push_count
=
0
;
var
finished
=
0
;
function
finish
(
)
{
finished
+
=
1
;
if
(
finished
=
=
=
(
1
+
push_count
)
)
{
process
.
exit
(
)
;
}
}
