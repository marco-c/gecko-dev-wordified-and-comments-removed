"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
AppTestDelegateParent
"
]
;
var
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
AppUiTestDelegate
:
"
resource
:
/
/
testing
-
common
/
AppUiTestDelegate
.
jsm
"
}
)
;
const
UUIDGen
=
Services
.
uuid
;
class
AppTestDelegateParent
extends
JSWindowActorParent
{
constructor
(
)
{
super
(
)
;
this
.
_tabs
=
new
Map
(
)
;
}
get
browser
(
)
{
return
this
.
browsingContext
.
top
.
embedderElement
;
}
get
window
(
)
{
return
this
.
browser
.
ownerGlobal
;
}
async
receiveMessage
(
message
)
{
const
{
extensionId
url
waitForLoad
tabId
}
=
message
.
data
;
switch
(
message
.
name
)
{
case
"
DOMContentLoaded
"
:
case
"
load
"
:
{
return
this
.
browser
?
.
dispatchEvent
(
new
CustomEvent
(
AppTestDelegate
:
{
message
.
name
}
{
detail
:
{
browsingContext
:
this
.
browsingContext
.
.
.
message
.
data
}
}
)
)
;
}
case
"
clickPageAction
"
:
return
AppUiTestDelegate
.
clickPageAction
(
this
.
window
extensionId
)
;
case
"
clickBrowserAction
"
:
return
AppUiTestDelegate
.
clickBrowserAction
(
this
.
window
extensionId
)
;
case
"
closePageAction
"
:
return
AppUiTestDelegate
.
closePageAction
(
this
.
window
extensionId
)
;
case
"
closeBrowserAction
"
:
return
AppUiTestDelegate
.
closeBrowserAction
(
this
.
window
extensionId
)
;
case
"
awaitExtensionPanel
"
:
await
AppUiTestDelegate
.
awaitExtensionPanel
(
this
.
window
extensionId
)
;
return
null
;
case
"
openNewForegroundTab
"
:
{
const
uuid
=
UUIDGen
.
generateUUID
(
)
.
toString
(
)
;
const
tab
=
await
AppUiTestDelegate
.
openNewForegroundTab
(
this
.
window
url
waitForLoad
)
;
this
.
_tabs
.
set
(
uuid
tab
)
;
return
uuid
;
}
case
"
removeTab
"
:
{
const
tab
=
this
.
_tabs
.
get
(
tabId
)
;
this
.
_tabs
.
delete
(
tabId
)
;
return
AppUiTestDelegate
.
removeTab
(
tab
)
;
}
default
:
throw
new
Error
(
Unknown
Test
API
:
{
message
.
name
}
.
)
;
}
}
}
