function
waitForAnimationFrames
(
count
)
{
return
new
Promise
(
resolve
=
>
{
if
(
count
-
-
<
=
0
)
{
resolve
(
)
;
}
else
{
requestAnimationFrame
(
(
)
=
>
{
waitForAnimationFrames
(
count
)
.
then
(
resolve
)
;
}
)
;
}
}
)
;
}
async
function
assertNoFirstContentfulPaint
(
t
)
{
await
waitForAnimationFrames
(
3
)
;
assert_equals
(
performance
.
getEntriesByName
(
'
first
-
contentful
-
paint
'
)
.
length
0
'
First
contentful
paint
marked
too
early
.
'
)
;
}
async
function
assertFirstContentfulPaint
(
t
)
{
return
new
Promise
(
resolve
=
>
{
function
checkFCP
(
)
{
if
(
performance
.
getEntriesByName
(
'
first
-
contentful
-
paint
'
)
.
length
=
=
=
1
)
{
resolve
(
)
;
}
else
{
t
.
step_timeout
(
checkFCP
0
)
;
}
}
t
.
step
(
checkFCP
)
;
}
)
;
}
async
function
test_fcp
(
label
before_assert_fcp_func
)
{
setup
(
{
"
hide_test_state
"
:
true
}
)
;
const
style
=
document
.
createElement
(
'
style
'
)
;
document
.
head
.
appendChild
(
style
)
;
await
promise_test
(
async
t
=
>
{
assert_implements
(
window
.
PerformancePaintTiming
"
Paint
Timing
isn
'
t
supported
.
"
)
;
const
main
=
document
.
getElementById
(
'
main
'
)
;
await
new
Promise
(
r
=
>
window
.
addEventListener
(
'
load
'
r
)
)
;
await
assertNoFirstContentfulPaint
(
t
)
;
main
.
className
=
'
preFCP
'
;
await
assertNoFirstContentfulPaint
(
t
)
;
if
(
before_assert_fcp_func
)
{
await
before_assert_fcp_func
(
)
;
}
main
.
className
=
'
contentful
'
;
await
assertFirstContentfulPaint
(
t
)
;
}
label
)
;
}
