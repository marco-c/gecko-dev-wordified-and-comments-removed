const
reportID
=
"
{
{
id
:
uuid
(
)
}
}
"
;
function
obtainNELLock
(
)
{
return
fetch
(
"
/
network
-
error
-
logging
/
support
/
lock
.
py
?
op
=
lock
&
reportID
=
"
+
reportID
)
;
}
function
releaseNELLock
(
)
{
return
fetch
(
"
/
network
-
error
-
logging
/
support
/
lock
.
py
?
op
=
unlock
&
reportID
=
"
+
reportID
)
;
}
function
nel_test
(
callback
name
properties
)
{
promise_test
(
async
t
=
>
{
await
obtainNELLock
(
)
;
await
assertNELIsImplemented
(
)
;
await
clearReportingAndNELConfigurations
(
)
;
await
callback
(
t
)
;
await
releaseNELLock
(
)
;
}
name
properties
)
;
}
function
nel_iframe_test
(
callback
name
properties
)
{
promise_test
(
async
t
=
>
{
await
obtainNELLock
(
)
;
await
assertNELIsImplemented
(
)
;
await
clearReportingAndNELConfigurationsInIframe
(
)
;
await
callback
(
t
)
;
await
releaseNELLock
(
)
;
}
name
properties
)
;
}
function
_monitoredDomain
(
subdomain
)
{
if
(
subdomain
=
=
"
www
"
)
{
return
"
{
{
hosts
[
alt
]
[
www
]
}
}
"
}
else
if
(
subdomain
=
=
"
www1
"
)
{
return
"
{
{
hosts
[
alt
]
[
www1
]
}
}
"
}
else
if
(
subdomain
=
=
"
www2
"
)
{
return
"
{
{
hosts
[
alt
]
[
www2
]
}
}
"
}
else
if
(
subdomain
=
=
"
nonexistent
"
)
{
return
"
{
{
hosts
[
alt
]
[
nonexistent
]
}
}
"
}
else
{
return
"
{
{
hosts
[
alt
]
[
]
}
}
"
}
}
function
_getNELResourceURL
(
subdomain
suffix
options
=
{
}
)
{
return
https
:
/
/
{
_monitoredDomain
(
subdomain
)
}
:
{
{
ports
[
https
]
[
0
]
}
}
/
+
(
options
.
sanitize
?
"
"
:
network
-
error
-
logging
/
support
/
{
suffix
}
)
;
}
function
getURLForResourceWithBasicPolicy
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
pass
.
png
?
id
=
"
+
reportID
+
"
&
success_fraction
=
1
.
0
"
)
;
}
function
getURLForResourceWithBasicPolicyv1
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
pass2
.
png
?
id
=
"
+
reportID
+
"
&
success_fraction
=
1
.
0
"
)
;
}
function
getSanitizedURLForResourceWithNoPolicy
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
no
-
policy
-
pass
.
png
"
{
sanitize
:
true
}
)
;
}
function
fetchResourceWithBasicPolicy
(
subdomain
)
{
const
url
=
getURLForResourceWithBasicPolicy
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
fetchResourceWithBasicPolicyv1
(
subdomain
)
{
const
url
=
getURLForResourceWithBasicPolicyv1
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
fetchResourceWithZeroSuccessFractionPolicy
(
subdomain
)
{
const
url
=
_getNELResourceURL
(
subdomain
"
pass
.
png
?
id
=
"
+
reportID
+
"
&
success_fraction
=
0
.
0
"
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
loadResourceWithBasicPolicyInIframe
(
subdomain
)
{
return
loadResourceWithPolicyInIframe
(
getURLForResourceWithBasicPolicy
(
subdomain
)
)
;
}
function
loadResourceWithZeroSuccessFractionPolicyInIframe
(
subdomain
)
{
return
loadResourceWithPolicyInIframe
(
_getNELResourceURL
(
subdomain
"
pass
.
png
?
id
=
"
+
reportID
+
"
&
success_fraction
=
0
.
0
"
)
)
;
}
function
clearResourceWithBasicPolicyInIframe
(
subdomain
)
{
return
loadResourceWithPolicyInIframe
(
getURLForClearingConfiguration
(
subdomain
)
)
;
}
function
loadResourceWithPolicyInIframe
(
url
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
const
frame
=
document
.
createElement
(
'
iframe
'
)
;
frame
.
src
=
url
;
frame
.
onload
=
(
)
=
>
resolve
(
frame
)
;
frame
.
onerror
=
(
)
=
>
reject
(
'
failed
to
load
'
+
url
)
;
document
.
body
.
appendChild
(
frame
)
;
}
)
;
}
function
getURLForResourceWithIncludeSubdomainsPolicy
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
subdomains
-
pass
.
png
?
id
=
"
+
reportID
)
;
}
function
fetchResourceWithIncludeSubdomainsPolicy
(
subdomain
)
{
const
url
=
getURLForResourceWithIncludeSubdomainsPolicy
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
getURLForResourceWithNoPolicy
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
no
-
policy
-
pass
.
png
"
)
;
}
function
fetchResourceWithNoPolicy
(
subdomain
)
{
const
url
=
getURLForResourceWithNoPolicy
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
getURLForMissingResource
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
nonexistent
.
png
"
)
;
}
function
fetchMissingResource
(
subdomain
)
{
const
url
=
getURLForMissingResource
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
getURLForCachedResource
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
cached
-
for
-
one
-
minute
.
png
"
)
;
}
function
fetchCachedResource
(
subdomain
)
{
const
url
=
getURLForCachedResource
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
getURLForValidatedCachedResource
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
cached
-
with
-
validation
.
py
"
)
;
}
function
fetchValidatedCachedResource
(
subdomain
)
{
const
url
=
getURLForValidatedCachedResource
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
getURLForRedirectedResource
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
redirect
.
py
?
id
=
"
+
reportID
)
;
}
function
fetchRedirectedResource
(
subdomain
)
{
const
url
=
getURLForRedirectedResource
(
subdomain
)
;
return
fetch
(
url
{
mode
:
"
no
-
cors
"
}
)
;
}
function
getURLForClearingConfiguration
(
subdomain
)
{
return
_getNELResourceURL
(
subdomain
"
clear
-
policy
-
pass
.
png
?
id
=
"
+
reportID
)
;
}
async
function
clearReportingAndNELConfigurations
(
subdomain
)
{
await
Promise
.
all
(
[
fetch
(
getURLForClearingConfiguration
(
"
"
)
{
mode
:
"
no
-
cors
"
}
)
fetch
(
getURLForClearingConfiguration
(
"
www
"
)
{
mode
:
"
no
-
cors
"
}
)
fetch
(
getURLForClearingConfiguration
(
"
www1
"
)
{
mode
:
"
no
-
cors
"
}
)
fetch
(
getURLForClearingConfiguration
(
"
www2
"
)
{
mode
:
"
no
-
cors
"
}
)
]
)
;
return
;
}
async
function
clearReportingAndNELConfigurationsInIframe
(
subdomain
)
{
await
Promise
.
all
(
[
clearResourceWithBasicPolicyInIframe
(
"
"
)
clearResourceWithBasicPolicyInIframe
(
"
www
"
)
clearResourceWithBasicPolicyInIframe
(
"
www1
"
)
clearResourceWithBasicPolicyInIframe
(
"
www2
"
)
]
)
;
return
;
}
function
_isSubsetOf
(
obj1
obj2
)
{
for
(
const
prop
in
obj1
)
{
if
(
typeof
obj1
[
prop
]
=
=
=
'
object
'
)
{
if
(
typeof
obj2
[
prop
]
!
=
=
'
object
'
)
{
return
false
;
}
if
(
!
_isSubsetOf
(
obj1
[
prop
]
obj2
[
prop
]
)
)
{
return
false
;
}
}
else
if
(
obj1
[
prop
]
!
=
obj2
[
prop
]
)
{
return
false
;
}
}
return
true
;
}
async
function
reportExists
(
expected
retain_reports
timeout
)
{
if
(
!
timeout
)
{
timeout
=
document
.
querySelector
(
"
meta
[
name
=
timeout
]
[
content
=
long
]
"
)
?
50
:
1
;
}
var
reportLocation
=
"
/
reporting
/
resources
/
report
.
py
?
op
=
retrieve_report
&
timeout
=
"
+
timeout
+
"
&
reportID
=
"
+
reportID
;
if
(
retain_reports
)
reportLocation
+
=
"
&
retain
=
1
"
;
const
response
=
await
fetch
(
reportLocation
)
;
const
json
=
await
response
.
json
(
)
;
for
(
const
report
of
json
)
{
if
(
_isSubsetOf
(
expected
report
)
)
{
return
true
;
}
}
return
false
;
}
async
function
reportsExist
(
expected_reports
retain_reports
)
{
const
timeout
=
10
;
let
reportLocation
=
"
/
reporting
/
resources
/
report
.
py
?
op
=
retrieve_report
&
timeout
=
"
+
timeout
+
"
&
reportID
=
"
+
reportID
;
if
(
retain_reports
)
reportLocation
+
=
"
&
retain
"
;
const
min_count
=
expected_reports
.
length
+
1
;
reportLocation
+
=
"
&
min_count
=
"
+
min_count
;
const
response
=
await
fetch
(
reportLocation
)
;
const
json
=
await
response
.
json
(
)
;
for
(
const
expected
of
expected_reports
)
{
const
found
=
json
.
some
(
(
report
)
=
>
{
return
_isSubsetOf
(
expected
report
)
;
}
)
;
if
(
!
found
)
return
false
;
}
return
true
;
}
async
function
assertNELIsImplemented
(
)
{
await
fetchResourceWithBasicPolicy
(
)
;
assert_implements
(
await
reportExists
(
{
url
:
getURLForResourceWithBasicPolicy
(
)
type
:
"
network
-
error
"
}
false
1
)
"
'
Basic
NEL
support
:
missing
network
-
error
report
'
"
)
;
}
