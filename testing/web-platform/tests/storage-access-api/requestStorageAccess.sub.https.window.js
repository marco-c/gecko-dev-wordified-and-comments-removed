'
use
strict
'
;
const
{
testPrefix
topLevelDocument
}
=
processQueryParams
(
)
;
if
(
window
!
=
=
window
.
top
)
{
test_driver
.
set_test_context
(
window
.
top
)
;
}
test
(
(
)
=
>
{
assert_not_equals
(
document
.
requestStorageAccess
undefined
)
;
}
"
[
"
+
testPrefix
+
"
]
document
.
requestStorageAccess
(
)
should
exist
on
the
document
interface
"
)
;
promise_setup
(
async
(
)
=
>
{
await
test_driver
.
set_permission
(
{
name
:
'
storage
-
access
'
}
'
prompt
'
)
;
}
)
;
promise_test
(
async
t
=
>
{
if
(
topLevelDocument
)
{
await
document
.
requestStorageAccess
(
)
.
catch
(
t
.
unreached_func
(
"
document
.
requestStorageAccess
(
)
call
should
resolve
in
top
-
level
frame
"
)
)
;
}
else
{
return
promise_rejects_dom
(
t
"
NotAllowedError
"
document
.
requestStorageAccess
(
)
"
document
.
requestStorageAccess
(
)
call
without
user
gesture
"
)
;
}
}
"
[
"
+
testPrefix
+
"
]
document
.
requestStorageAccess
(
)
should
resolve
in
top
-
level
frame
or
otherwise
reject
with
a
NotAllowedError
with
no
user
gesture
"
)
;
promise_test
(
async
(
)
=
>
{
await
test_driver
.
set_permission
(
{
name
:
'
storage
-
access
'
}
'
granted
'
)
;
await
RunCallbackWithGesture
(
(
)
=
>
document
.
requestStorageAccess
(
)
)
;
}
'
[
'
+
testPrefix
+
'
]
document
.
requestStorageAccess
(
)
should
be
resolved
when
called
properly
with
a
user
gesture
'
)
;
if
(
testPrefix
=
=
'
cross
-
origin
-
frame
'
|
|
testPrefix
=
=
'
nested
-
cross
-
origin
-
frame
'
)
{
promise_test
(
async
t
=
>
{
await
RunCallbackWithGesture
(
(
)
=
>
{
return
promise_rejects_dom
(
t
"
NotAllowedError
"
document
.
requestStorageAccess
(
)
"
document
.
requestStorageAccess
(
)
call
without
permission
"
)
;
}
)
;
}
'
[
'
+
testPrefix
+
'
]
document
.
requestStorageAccess
(
)
should
be
rejected
with
a
NotAllowedError
without
permission
grant
'
)
;
promise_test
(
async
t
=
>
{
await
test_driver
.
set_permission
(
{
name
:
'
storage
-
access
'
}
'
denied
'
)
;
await
RunCallbackWithGesture
(
(
)
=
>
{
return
promise_rejects_dom
(
t
"
NotAllowedError
"
document
.
requestStorageAccess
(
)
"
document
.
requestStorageAccess
(
)
call
without
permission
"
)
;
}
)
;
}
'
[
'
+
testPrefix
+
'
]
document
.
requestStorageAccess
(
)
should
be
rejected
with
a
NotAllowedError
with
denied
permission
'
)
;
}
