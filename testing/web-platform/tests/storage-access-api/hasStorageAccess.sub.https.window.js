'
use
strict
'
;
const
{
testPrefix
topLevelDocument
}
=
processQueryParams
(
)
;
promise_test
(
async
(
)
=
>
{
assert_not_equals
(
document
.
hasStorageAccess
undefined
)
;
}
"
[
"
+
testPrefix
+
"
]
document
.
hasStorageAccess
(
)
should
exist
on
the
document
interface
"
)
;
promise_test
(
async
(
)
=
>
{
await
MaybeSetStorageAccess
(
"
*
"
"
*
"
"
blocked
"
)
;
const
hasAccess
=
await
document
.
hasStorageAccess
(
)
;
if
(
topLevelDocument
|
|
testPrefix
.
includes
(
'
same
-
origin
'
)
)
{
assert_true
(
hasAccess
"
Access
should
be
granted
in
top
-
level
frame
or
iframe
that
is
in
first
-
party
context
by
default
.
"
)
;
}
else
if
(
testPrefix
=
=
'
ABA
'
)
{
assert_false
(
hasAccess
"
Access
should
not
be
granted
in
secure
same
-
origin
iframe
that
is
in
a
third
-
party
context
by
default
.
"
)
;
}
else
{
assert_false
(
hasAccess
"
Access
should
not
be
granted
in
secure
cross
-
origin
iframes
.
"
)
;
}
}
"
[
"
+
testPrefix
+
"
]
document
.
hasStorageAccess
(
)
should
not
be
allowed
by
default
unless
in
top
-
level
frame
or
same
-
origin
iframe
.
"
)
;
promise_test
(
async
(
t
)
=
>
{
const
description
=
"
Promise
should
reject
when
called
on
a
generated
document
not
part
of
the
DOM
.
"
;
const
createdDocument
=
document
.
implementation
.
createDocument
(
"
"
null
)
;
await
createdDocument
.
hasStorageAccess
(
)
.
then
(
t
.
unreached_func
(
"
Should
have
rejected
:
"
+
description
)
(
e
)
=
>
{
assert_equals
(
e
.
name
'
InvalidStateError
'
description
)
;
}
)
;
}
"
[
"
+
testPrefix
+
"
]
document
.
hasStorageAccess
(
)
should
reject
in
a
document
that
isn
'
t
fully
active
.
"
)
;
if
(
topLevelDocument
)
{
RunTestsInIFrame
(
"
resources
/
hasStorageAccess
-
iframe
.
https
.
html
?
testCase
=
same
-
origin
-
frame
"
)
;
RunTestsInIFrame
(
"
https
:
/
/
{
{
hosts
[
alt
]
[
]
}
}
:
{
{
ports
[
https
]
[
0
]
}
}
/
storage
-
access
-
api
/
resources
/
hasStorageAccess
-
iframe
.
https
.
html
?
testCase
=
cross
-
site
-
frame
"
)
;
RunTestsInNestedIFrame
(
"
resources
/
hasStorageAccess
-
iframe
.
https
.
html
?
testCase
=
nested
-
same
-
origin
-
frame
"
)
;
RunTestsInNestedIFrame
(
"
https
:
/
/
{
{
hosts
[
alt
]
[
]
}
}
:
{
{
ports
[
https
]
[
0
]
}
}
/
storage
-
access
-
api
/
resources
/
hasStorageAccess
-
iframe
.
https
.
html
?
testCase
=
nested
-
cross
-
site
-
frame
"
)
;
}
