var
TestUtils
=
(
function
(
)
{
function
randomString
(
)
{
var
result
=
"
"
;
for
(
var
i
=
0
;
i
<
5
;
i
+
+
)
result
+
=
String
.
fromCharCode
(
97
+
Math
.
floor
(
Math
.
random
(
)
*
26
)
)
;
return
result
;
}
;
var
Datatype
;
var
TestUtils
=
{
}
;
TestUtils
.
DATATYPES
=
[
{
"
name
"
:
"
cookies
"
"
add
"
:
function
(
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
document
.
cookie
=
randomString
(
)
+
"
=
"
+
randomString
(
)
;
resolve
(
)
;
}
)
;
}
"
isEmpty
"
:
function
(
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
resolve
(
!
document
.
cookie
)
;
}
)
;
}
}
{
"
name
"
:
"
storage
"
"
add
"
:
function
(
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
localStorage
.
setItem
(
randomString
(
)
randomString
(
)
)
;
resolve
(
)
;
}
)
;
}
"
isEmpty
"
:
function
(
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
resolve
(
!
localStorage
.
length
)
;
}
)
;
}
}
]
;
TestUtils
.
COMBINATIONS
=
(
function
(
)
{
var
combinations
=
[
]
;
for
(
var
mask
=
0
;
mask
<
(
1
<
<
TestUtils
.
DATATYPES
.
length
)
;
mask
+
+
)
{
var
combination
=
[
]
;
for
(
var
datatype
=
0
;
datatype
<
TestUtils
.
DATATYPES
.
length
;
datatype
+
+
)
{
if
(
mask
&
(
1
<
<
datatype
)
)
combination
.
push
(
TestUtils
.
DATATYPES
[
datatype
]
)
;
}
combinations
.
push
(
combination
)
;
}
return
combinations
;
}
)
(
)
;
TestUtils
.
populateDatatypes
=
function
(
)
{
return
Promise
.
all
(
TestUtils
.
DATATYPES
.
map
(
function
(
datatype
)
{
return
new
Promise
(
function
(
resolve
reject
)
{
datatype
.
add
(
)
.
then
(
function
(
)
{
datatype
.
isEmpty
(
)
.
then
(
function
(
isEmpty
)
{
assert_false
(
isEmpty
datatype
.
name
+
"
has
to
be
nonempty
before
the
test
starts
.
"
)
;
resolve
(
)
;
}
)
;
}
)
;
}
)
;
}
)
)
;
}
;
TestUtils
.
getClearSiteDataUrl
=
function
(
datatypes
)
{
names
=
datatypes
.
map
(
function
(
e
)
{
return
e
.
name
}
)
;
return
"
support
/
echo
-
clear
-
site
-
data
.
py
?
"
+
names
.
join
(
"
&
"
)
;
}
TestUtils
.
getPageWithResourceUrl
=
function
(
page_scheme
resource_scheme
)
{
if
(
page_scheme
!
=
"
https
"
&
&
page_scheme
!
=
"
http
"
)
throw
"
Unsupported
scheme
:
"
+
page_scheme
;
if
(
resource_scheme
!
=
"
https
"
&
&
resource_scheme
!
=
"
http
"
)
throw
"
Unsupported
scheme
:
"
+
resource_scheme
;
return
page_scheme
+
"
:
/
/
web
-
platform
.
test
:
"
+
(
page_scheme
=
=
"
https
"
?
{
{
ports
[
https
]
[
0
]
}
}
:
{
{
ports
[
http
]
[
0
]
}
}
)
+
"
/
clear
-
site
-
data
/
support
/
page_with_resource
.
sub
.
html
?
scheme
=
"
+
resource_scheme
;
}
return
TestUtils
;
}
)
(
)
;
