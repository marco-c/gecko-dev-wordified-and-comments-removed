promise_test
(
async
test
=
>
{
const
child_token
=
token
(
)
;
const
child
=
new
RemoteContext
(
child_token
)
;
const
iframe
=
document
.
createElement
(
"
iframe
"
)
;
iframe
.
src
=
remoteExecutorUrl
(
child_token
{
host
:
get_host_info
(
)
.
REMOTE_HOST
}
)
;
document
.
body
.
appendChild
(
iframe
)
;
await
child
.
execute_script
(
(
)
=
>
{
window
.
sameDocumentNavigation
=
new
Promise
(
resolve
=
>
{
window
.
addEventListener
(
"
popstate
"
resolve
)
;
}
)
;
}
)
;
const
meta
=
document
.
createElement
(
"
meta
"
)
;
meta
.
httpEquiv
=
"
Content
-
Security
-
Policy
"
;
meta
.
content
=
"
frame
-
src
'
none
'
"
;
document
.
head
.
appendChild
(
meta
)
;
document
.
addEventListener
(
"
securitypolicyviolation
"
test
.
unreached_func
(
"
same
-
document
navigations
aren
'
t
subject
to
CSP
"
)
)
;
iframe
.
src
+
=
"
#
foo
"
;
await
child
.
execute_script
(
(
)
=
>
sameDocumentNavigation
)
;
assert_equals
(
await
child
.
execute_script
(
(
)
=
>
location
.
href
)
iframe
.
src
)
;
}
)
