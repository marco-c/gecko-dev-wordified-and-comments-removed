const
testAbortPromise
=
async
(
t
method
)
=
>
{
{
const
controller
=
new
AbortController
(
)
;
const
promise
=
method
(
controller
.
signal
)
;
controller
.
abort
(
)
;
await
promise_rejects_dom
(
t
'
AbortError
'
promise
)
;
const
anotherPromise
=
method
(
controller
.
signal
)
;
await
promise_rejects_dom
(
t
'
AbortError
'
anotherPromise
)
;
}
{
const
err
=
new
Error
(
'
test
'
)
;
const
controller
=
new
AbortController
(
)
;
const
promise
=
method
(
controller
.
signal
)
;
controller
.
abort
(
err
)
;
await
promise_rejects_exactly
(
t
err
promise
)
;
const
anotherPromise
=
method
(
controller
.
signal
)
;
await
promise_rejects_exactly
(
t
err
anotherPromise
)
;
}
}
;
async
function
testMonitor
(
createFunc
options
=
{
}
)
{
let
created
=
false
;
const
progressEvents
=
[
]
;
function
monitor
(
m
)
{
m
.
addEventListener
(
'
downloadprogress
'
e
=
>
{
assert_false
(
created
)
;
progressEvents
.
push
(
e
)
;
}
)
;
}
await
createFunc
(
{
.
.
.
options
monitor
}
)
;
created
=
true
;
assert_greater_than_equal
(
progressEvents
.
length
2
)
;
assert_equals
(
progressEvents
.
at
(
0
)
.
loaded
0
)
;
assert_equals
(
progressEvents
.
at
(
-
1
)
.
loaded
1
)
;
let
lastProgressEventLoaded
=
-
1
;
for
(
const
progressEvent
of
progressEvents
)
{
assert_equals
(
progressEvent
.
total
1
)
;
assert_less_than_equal
(
progressEvent
.
loaded
progressEvent
.
total
)
;
assert_greater_than
(
progressEvent
.
loaded
lastProgressEventLoaded
)
;
lastProgressEventLoaded
=
progressEvent
.
loaded
;
}
}
