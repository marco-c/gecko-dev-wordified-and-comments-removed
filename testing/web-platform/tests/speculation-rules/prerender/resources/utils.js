const
STORE_URL
=
'
/
speculation
-
rules
/
prerender
/
resources
/
key
-
value
-
store
.
py
'
;
function
assertSpeculationRulesIsSupported
(
)
{
assert_implements
(
'
supports
'
in
HTMLScriptElement
'
HTMLScriptElement
.
supports
is
not
supported
'
)
;
assert_implements
(
HTMLScriptElement
.
supports
(
'
speculationrules
'
)
'
<
script
type
=
"
speculationrules
"
>
is
not
supported
'
)
;
}
function
startPrerendering
(
url
)
{
const
script
=
document
.
createElement
(
'
script
'
)
;
script
.
type
=
'
speculationrules
'
;
script
.
text
=
{
"
prerender
"
:
[
{
"
source
"
:
"
list
"
"
urls
"
:
[
"
{
url
}
"
]
}
]
}
;
document
.
head
.
appendChild
(
script
)
;
}
async
function
readValueFromServer
(
key
)
{
const
serverUrl
=
{
STORE_URL
}
?
key
=
{
key
}
;
const
response
=
await
fetch
(
serverUrl
)
;
if
(
!
response
.
ok
)
throw
new
Error
(
'
An
error
happened
in
the
server
'
)
;
const
value
=
await
response
.
text
(
)
;
if
(
value
=
=
=
"
"
)
return
{
status
:
false
}
;
return
{
status
:
true
value
:
value
}
;
}
async
function
nextValueFromServer
(
key
)
{
while
(
true
)
{
const
{
status
value
}
=
await
readValueFromServer
(
key
)
;
if
(
!
status
)
{
await
new
Promise
(
resolve
=
>
setTimeout
(
resolve
100
)
)
;
continue
;
}
return
value
;
}
}
async
function
writeValueToServer
(
key
value
)
{
const
serverUrl
=
{
STORE_URL
}
?
key
=
{
key
}
&
value
=
{
value
}
;
await
fetch
(
serverUrl
)
;
}
function
loadInitiatorPage
(
)
{
const
prerenderChannel
=
new
BroadcastChannel
(
'
prerender
-
channel
'
)
;
window
.
addEventListener
(
'
unload
'
(
)
=
>
{
prerenderChannel
.
close
(
)
;
}
)
;
const
readyToActivate
=
new
Promise
(
(
resolve
reject
)
=
>
{
prerenderChannel
.
addEventListener
(
'
message
'
e
=
>
{
if
(
e
.
data
!
=
'
readyToActivate
'
)
reject
(
The
initiator
page
receives
an
unsupported
message
:
{
e
.
data
}
)
;
resolve
(
e
.
data
)
;
}
)
;
}
)
;
const
url
=
new
URL
(
document
.
URL
)
;
url
.
searchParams
.
append
(
'
prerendering
'
'
'
)
;
startPrerendering
(
url
.
toString
(
)
)
;
readyToActivate
.
then
(
(
)
=
>
{
window
.
location
=
url
.
toString
(
)
;
}
)
.
catch
(
e
=
>
{
const
testChannel
=
new
BroadcastChannel
(
'
test
-
channel
'
)
;
testChannel
.
postMessage
(
Failed
to
navigate
the
prerendered
page
:
{
e
.
toString
(
)
}
)
;
testChannel
.
close
(
)
;
window
.
close
(
)
;
}
)
;
}
class
BroadcastMessageQueue
{
constructor
(
broadcastChannel
)
{
this
.
messages
=
[
]
;
this
.
resolveFunctions
=
[
]
;
this
.
channel
=
broadcastChannel
;
this
.
channel
.
addEventListener
(
'
message
'
e
=
>
{
if
(
this
.
resolveFunctions
.
length
>
0
)
{
const
fn
=
this
.
resolveFunctions
.
shift
(
)
;
fn
(
e
.
data
)
;
}
else
{
this
.
messages
.
push
(
e
.
data
)
;
}
}
)
;
}
nextMessage
(
)
{
return
new
Promise
(
resolve
=
>
{
if
(
this
.
messages
.
length
>
0
)
resolve
(
this
.
messages
.
shift
(
)
)
else
this
.
resolveFunctions
.
push
(
resolve
)
;
}
)
;
}
}
function
createFrame
(
url
)
{
return
new
Promise
(
resolve
=
>
{
const
frame
=
document
.
createElement
(
'
iframe
'
)
;
frame
.
src
=
url
;
frame
.
onload
=
(
)
=
>
resolve
(
frame
)
;
document
.
body
.
appendChild
(
frame
)
;
}
)
;
}
