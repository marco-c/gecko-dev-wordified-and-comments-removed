import
pytest
from
webdriver
.
error
import
TimeoutException
pytestmark
=
pytest
.
mark
.
asyncio
pytest
.
mark
.
asyncio
async
def
test_speculation_rules_generate_ready_events
(
    
bidi_session
subscribe_events
new_tab
url
wait_for_events
add_speculation_rules_and_link
)
:
    
'
'
'
Test
that
speculation
rules
generate
prefetch
events
with
proper
pending
-
>
ready
sequence
.
'
'
'
    
await
subscribe_events
(
events
=
[
"
speculation
.
prefetchStatusUpdated
"
]
)
    
test_url
=
url
(
"
/
common
/
blank
.
html
"
protocol
=
"
https
"
)
    
await
bidi_session
.
browsing_context
.
navigate
(
        
context
=
new_tab
[
"
context
"
]
        
url
=
test_url
        
wait
=
"
none
"
    
)
    
prefetch_target
=
url
(
"
/
common
/
dummy
.
xml
"
protocol
=
"
https
"
)
    
speculation_rules
=
f
'
'
'
{
{
        
"
prefetch
"
:
[
{
{
            
"
where
"
:
{
{
"
href_matches
"
:
"
{
prefetch_target
}
"
}
}
            
"
eagerness
"
:
"
immediate
"
        
}
}
]
    
}
}
'
'
'
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
add_speculation_rules_and_link
(
new_tab
speculation_rules
prefetch_target
)
        
events
=
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
=
=
2
)
    
assert
events
=
=
[
        
(
"
speculation
.
prefetchStatusUpdated
"
{
            
"
url
"
:
prefetch_target
            
"
status
"
:
"
pending
"
            
"
context
"
:
new_tab
[
"
context
"
]
        
}
)
        
(
"
speculation
.
prefetchStatusUpdated
"
{
            
"
url
"
:
prefetch_target
            
"
status
"
:
"
ready
"
            
"
context
"
:
new_tab
[
"
context
"
]
        
}
)
    
]
f
"
Events
don
'
t
match
expected
sequence
:
{
events
}
"
pytest
.
mark
.
asyncio
async
def
test_speculation_rules_generate_events_with_navigation
(
    
bidi_session
subscribe_events
new_tab
url
wait_for_events
add_speculation_rules_and_link
)
:
    
'
'
'
Test
that
speculation
rules
generate
prefetch
events
with
navigation
and
success
event
after
using
prefetched
page
.
'
'
'
    
await
subscribe_events
(
events
=
[
"
speculation
.
prefetchStatusUpdated
"
]
)
    
test_url
=
url
(
"
/
common
/
blank
.
html
"
protocol
=
"
https
"
)
    
await
bidi_session
.
browsing_context
.
navigate
(
        
context
=
new_tab
[
"
context
"
]
        
url
=
test_url
        
wait
=
"
none
"
    
)
    
prefetch_target
=
url
(
"
/
common
/
dummy
.
xml
"
protocol
=
"
https
"
)
    
speculation_rules
=
f
'
'
'
{
{
        
"
prefetch
"
:
[
{
{
            
"
where
"
:
{
{
"
href_matches
"
:
"
{
prefetch_target
}
"
}
}
            
"
eagerness
"
:
"
immediate
"
        
}
}
]
    
}
}
'
'
'
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
add_speculation_rules_and_link
(
new_tab
speculation_rules
prefetch_target
)
        
events
=
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
>
=
2
)
    
assert
events
=
=
[
        
(
"
speculation
.
prefetchStatusUpdated
"
{
            
"
url
"
:
prefetch_target
            
"
status
"
:
"
pending
"
            
"
context
"
:
new_tab
[
"
context
"
]
        
}
)
        
(
"
speculation
.
prefetchStatusUpdated
"
{
            
"
url
"
:
prefetch_target
            
"
status
"
:
"
ready
"
            
"
context
"
:
new_tab
[
"
context
"
]
        
}
)
    
]
f
"
Events
don
'
t
match
expected
sequence
:
{
events
}
"
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
bidi_session
.
script
.
evaluate
(
            
expression
=
'
'
'
                
const
prefetchLink
=
document
.
getElementById
(
'
prefetch
-
page
'
)
;
                
if
(
prefetchLink
)
{
                    
prefetchLink
.
click
(
)
;
                
}
            
'
'
'
            
target
=
{
"
context
"
:
new_tab
[
"
context
"
]
}
            
await_promise
=
False
        
)
        
success_event
=
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
>
=
1
)
    
assert
success_event
=
=
[
        
(
"
speculation
.
prefetchStatusUpdated
"
{
            
"
url
"
:
prefetch_target
            
"
status
"
:
"
success
"
            
"
context
"
:
new_tab
[
"
context
"
]
        
}
)
    
]
f
"
Success
event
doesn
'
t
match
expected
sequence
:
{
success_event
}
"
pytest
.
mark
.
asyncio
async
def
test_speculation_rules_generate_failure_events
(
    
bidi_session
subscribe_events
new_tab
url
wait_for_events
add_speculation_rules_and_link
)
:
    
'
'
'
Test
that
speculation
rules
generate
pending
and
failure
events
for
failed
prefetch
.
'
'
'
    
await
subscribe_events
(
events
=
[
"
speculation
.
prefetchStatusUpdated
"
]
)
    
test_url
=
url
(
"
/
common
/
blank
.
html
"
protocol
=
"
https
"
)
    
await
bidi_session
.
browsing_context
.
navigate
(
        
context
=
new_tab
[
"
context
"
]
        
url
=
test_url
        
wait
=
"
none
"
    
)
    
failed_target
=
url
(
"
/
nonexistent
/
path
/
that
/
will
/
404
.
xml
"
protocol
=
"
https
"
)
    
speculation_rules
=
f
'
'
'
{
{
        
"
prefetch
"
:
[
{
{
            
"
where
"
:
{
{
"
href_matches
"
:
"
{
failed_target
}
"
}
}
            
"
eagerness
"
:
"
immediate
"
        
}
}
]
    
}
}
'
'
'
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
add_speculation_rules_and_link
(
new_tab
speculation_rules
failed_target
)
        
events
=
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
>
=
2
)
    
assert
events
=
=
[
        
(
"
speculation
.
prefetchStatusUpdated
"
{
            
"
url
"
:
failed_target
            
"
status
"
:
"
pending
"
            
"
context
"
:
new_tab
[
"
context
"
]
        
}
)
        
(
"
speculation
.
prefetchStatusUpdated
"
{
            
"
url
"
:
failed_target
            
"
status
"
:
"
failure
"
            
"
context
"
:
new_tab
[
"
context
"
]
        
}
)
    
]
f
"
Events
don
'
t
match
expected
sequence
:
{
events
}
"
pytest
.
mark
.
asyncio
async
def
test_subscribe_unsubscribe_event_emission
(
    
bidi_session
subscribe_events
new_tab
url
wait_for_events
add_speculation_rules_and_link
)
:
    
'
'
'
Test
that
events
are
emitted
when
subscribed
and
not
emitted
when
unsubscribed
.
'
'
'
    
test_url
=
url
(
"
/
common
/
blank
.
html
"
protocol
=
"
https
"
)
    
await
bidi_session
.
browsing_context
.
navigate
(
        
context
=
new_tab
[
"
context
"
]
        
url
=
test_url
        
wait
=
"
complete
"
    
)
    
prefetch_target
=
url
(
"
/
common
/
dummy
.
xml
"
protocol
=
"
https
"
)
    
speculation_rules
=
f
'
'
'
{
{
        
"
prefetch
"
:
[
{
{
            
"
where
"
:
{
{
"
href_matches
"
:
"
{
prefetch_target
}
"
}
}
            
"
eagerness
"
:
"
immediate
"
        
}
}
]
    
}
}
'
'
'
    
subscription_result
=
await
subscribe_events
(
events
=
[
"
speculation
.
prefetchStatusUpdated
"
]
)
    
subscription_id
=
subscription_result
[
"
subscription
"
]
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
add_speculation_rules_and_link
(
new_tab
speculation_rules
prefetch_target
)
        
events
=
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
>
=
2
)
    
await
bidi_session
.
session
.
unsubscribe
(
subscriptions
=
[
subscription_id
]
)
    
await
bidi_session
.
browsing_context
.
navigate
(
        
context
=
new_tab
[
"
context
"
]
        
url
=
test_url
        
wait
=
"
complete
"
    
)
    
prefetch_target_2
=
url
(
"
/
common
/
square
.
png
"
protocol
=
"
https
"
)
    
speculation_rules_2
=
f
'
'
'
{
{
        
"
prefetch
"
:
[
{
{
            
"
where
"
:
{
{
"
href_matches
"
:
"
{
prefetch_target_2
}
"
}
}
            
"
eagerness
"
:
"
immediate
"
        
}
}
]
    
}
}
'
'
'
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
add_speculation_rules_and_link
(
new_tab
speculation_rules_2
prefetch_target_2
)
        
with
pytest
.
raises
(
TimeoutException
)
:
            
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
>
=
1
timeout
=
0
.
5
)
pytest
.
mark
.
asyncio
async
def
test_subscribe_unsubscribe_module_subscription
(
    
bidi_session
subscribe_events
new_tab
url
wait_for_events
add_speculation_rules_and_link
)
:
    
'
'
'
Test
that
module
subscription
(
'
speculation
'
)
works
for
subscribe
/
unsubscribe
.
'
'
'
    
test_url
=
url
(
"
/
common
/
blank
.
html
"
protocol
=
"
https
"
)
    
await
bidi_session
.
browsing_context
.
navigate
(
        
context
=
new_tab
[
"
context
"
]
        
url
=
test_url
        
wait
=
"
complete
"
    
)
    
prefetch_target
=
url
(
"
/
common
/
dummy
.
xml
"
protocol
=
"
https
"
)
    
speculation_rules
=
f
'
'
'
{
{
        
"
prefetch
"
:
[
{
{
            
"
where
"
:
{
{
"
href_matches
"
:
"
{
prefetch_target
}
"
}
}
            
"
eagerness
"
:
"
immediate
"
        
}
}
]
    
}
}
'
'
'
    
subscription_result
=
await
subscribe_events
(
events
=
[
"
speculation
"
]
)
    
subscription_id
=
subscription_result
[
"
subscription
"
]
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
add_speculation_rules_and_link
(
new_tab
speculation_rules
prefetch_target
)
        
events
=
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
>
=
2
)
    
await
bidi_session
.
session
.
unsubscribe
(
subscriptions
=
[
subscription_id
]
)
    
await
bidi_session
.
browsing_context
.
navigate
(
        
context
=
new_tab
[
"
context
"
]
        
url
=
test_url
        
wait
=
"
complete
"
    
)
    
prefetch_target_2
=
url
(
"
/
common
/
square
.
png
"
protocol
=
"
https
"
)
    
speculation_rules_2
=
f
'
'
'
{
{
        
"
prefetch
"
:
[
{
{
            
"
where
"
:
{
{
"
href_matches
"
:
"
{
prefetch_target_2
}
"
}
}
            
"
eagerness
"
:
"
immediate
"
        
}
}
]
    
}
}
'
'
'
    
with
wait_for_events
(
[
"
speculation
.
prefetchStatusUpdated
"
]
)
as
waiter
:
        
await
add_speculation_rules_and_link
(
new_tab
speculation_rules_2
prefetch_target_2
)
        
with
pytest
.
raises
(
TimeoutException
)
:
            
await
waiter
.
get_events
(
lambda
events
:
len
(
events
)
>
=
1
timeout
=
0
.
5
)
pytest
.
mark
.
asyncio
async
def
test_unsubscribe_from_prefetch_status_updated
(
    
bidi_session
)
:
    
'
'
'
Test
unsubscribing
from
prefetch
status
updated
events
.
'
'
'
    
subscription_result
=
await
bidi_session
.
session
.
subscribe
(
        
events
=
[
"
speculation
.
prefetchStatusUpdated
"
]
    
)
    
subscription_id
=
subscription_result
[
"
subscription
"
]
    
await
bidi_session
.
session
.
unsubscribe
(
subscriptions
=
[
subscription_id
]
)
