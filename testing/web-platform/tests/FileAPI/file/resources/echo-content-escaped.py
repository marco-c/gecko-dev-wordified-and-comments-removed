from
wptserve
.
utils
import
isomorphic_encode
def
escape_byte
(
byte
)
:
    
code
=
byte
if
type
(
byte
)
is
int
else
ord
(
byte
)
    
if
0
<
=
code
<
=
0x1F
or
code
>
=
0x7F
:
        
return
b
"
\
\
x
%
02x
"
%
code
    
if
code
=
=
ord
(
b
"
\
\
"
)
:
        
return
b
"
\
\
\
\
"
    
return
byte
def
main
(
request
response
)
:
    
headers
=
[
(
b
"
X
-
Request
-
Method
"
isomorphic_encode
(
request
.
method
)
)
               
(
b
"
X
-
Request
-
Content
-
Length
"
request
.
headers
.
get
(
b
"
Content
-
Length
"
b
"
NO
"
)
)
               
(
b
"
X
-
Request
-
Content
-
Type
"
request
.
headers
.
get
(
b
"
Content
-
Type
"
b
"
NO
"
)
)
               
(
b
"
Content
-
Type
"
b
"
text
/
plain
;
charset
=
UTF
-
8
"
)
]
    
content
=
b
"
"
.
join
(
map
(
escape_byte
request
.
body
)
)
.
replace
(
b
"
\
\
x0d
\
\
x0a
"
b
"
\
r
\
n
"
)
    
return
headers
content
