import
sys
from
os
.
path
import
join
dirname
import
mock
import
pytest
sys
.
path
.
insert
(
0
join
(
dirname
(
__file__
)
"
.
.
"
"
.
.
"
"
.
.
"
)
)
sauce
=
pytest
.
importorskip
(
"
wptrunner
.
browsers
.
sauce
"
)
def
test_sauceconnect_success
(
)
:
    
with
mock
.
patch
.
object
(
sauce
.
SauceConnect
"
upload_prerun_exec
"
)
\
            
mock
.
patch
.
object
(
sauce
.
subprocess
"
Popen
"
)
as
Popen
\
            
mock
.
patch
.
object
(
sauce
.
os
.
path
"
exists
"
)
as
exists
:
        
Popen
.
return_value
.
poll
.
return_value
=
None
        
Popen
.
return_value
.
returncode
=
None
        
exists
.
return_value
=
True
        
sauce_connect
=
sauce
.
SauceConnect
(
            
sauce_user
=
"
aaa
"
            
sauce_key
=
"
bbb
"
            
sauce_tunnel_id
=
"
ccc
"
            
sauce_connect_binary
=
"
ddd
"
)
        
sauce_connect
.
__enter__
(
None
)
pytest
.
mark
.
parametrize
(
"
readyfile
returncode
"
[
    
(
True
0
)
    
(
True
1
)
    
(
True
2
)
    
(
False
0
)
    
(
False
1
)
    
(
False
2
)
]
)
def
test_sauceconnect_failure_exit
(
readyfile
returncode
)
:
    
with
mock
.
patch
.
object
(
sauce
.
SauceConnect
"
upload_prerun_exec
"
)
\
            
mock
.
patch
.
object
(
sauce
.
subprocess
"
Popen
"
)
as
Popen
\
            
mock
.
patch
.
object
(
sauce
.
os
.
path
"
exists
"
)
as
exists
\
            
mock
.
patch
.
object
(
sauce
.
time
"
sleep
"
)
as
sleep
:
        
Popen
.
return_value
.
poll
.
return_value
=
returncode
        
Popen
.
return_value
.
returncode
=
returncode
        
exists
.
return_value
=
readyfile
        
sauce_connect
=
sauce
.
SauceConnect
(
            
sauce_user
=
"
aaa
"
            
sauce_key
=
"
bbb
"
            
sauce_tunnel_id
=
"
ccc
"
            
sauce_connect_binary
=
"
ddd
"
)
        
with
pytest
.
raises
(
sauce
.
SauceException
)
:
            
sauce_connect
.
__enter__
(
None
)
        
sleep
.
assert_not_called
(
)
def
test_sauceconnect_failure_never_ready
(
)
:
    
with
mock
.
patch
.
object
(
sauce
.
SauceConnect
"
upload_prerun_exec
"
)
\
            
mock
.
patch
.
object
(
sauce
.
subprocess
"
Popen
"
)
as
Popen
\
            
mock
.
patch
.
object
(
sauce
.
os
.
path
"
exists
"
)
as
exists
\
            
mock
.
patch
.
object
(
sauce
.
time
"
sleep
"
)
as
sleep
:
        
Popen
.
return_value
.
poll
.
return_value
=
None
        
Popen
.
return_value
.
returncode
=
None
        
exists
.
return_value
=
False
        
sauce_connect
=
sauce
.
SauceConnect
(
            
sauce_user
=
"
aaa
"
            
sauce_key
=
"
bbb
"
            
sauce_tunnel_id
=
"
ccc
"
            
sauce_connect_binary
=
"
ddd
"
)
        
with
pytest
.
raises
(
sauce
.
SauceException
)
:
            
sauce_connect
.
__enter__
(
None
)
        
sleep
.
assert_called
(
)
        
Popen
.
return_value
.
terminate
.
assert_called
(
)
        
Popen
.
return_value
.
kill
.
assert_called
(
)
