"
use
strict
"
;
const
SINGLE_SELLER_AUCTION_SELLER
=
window
.
location
.
origin
;
const
ADDITIONAL_BID_SECRET_KEY
=
'
nWGxne
/
9WmC6hEr0kuwsxERJxWl7MmkZcDusAxyuf2A
=
'
;
const
ADDITIONAL_BID_PUBLIC_KEY
=
'
11qYAYKxCrfVS
/
7TyWQHOg7hcvPapiMlrwIaaPcHURo
=
'
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
0
'
horses
'
)
;
}
'
single
valid
additional
bid
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
additionalBid2
]
)
1
.
99
'
planes
'
)
;
}
'
two
valid
additional
bids
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
Promise
.
all
(
[
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
]
)
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid2
]
)
]
)
1
.
99
'
planes
'
)
;
}
'
two
valid
additional
bids
from
two
distinct
Fetch
requests
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonceInHeader
=
await
navigator
.
createAuctionNonce
(
)
;
const
auctionNonceInBid
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
additionalBid
=
auctionNonceInBid
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonceInHeader
)
;
await
runAdditionalBidTestNoWinner
(
test
uuid
[
buyer
]
auctionNonceInHeader
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
)
;
}
'
single
valid
additional
bid
with
wrong
auctionNonce
in
bid
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
await
runAdditionalBidTestNoWinner
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
)
;
}
'
single
valid
additional
bid
with
no
auctionNonce
in
bid
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
sellerNonce
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
bidNonce
=
await
additionalBidHelper
.
computeBidNonce
(
auctionNonce
sellerNonce
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
await
runAdditionalBidTestNoWinner
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
)
;
}
'
single
valid
additional
bid
with
bidNonce
in
bid
but
no
sellerNonce
in
header
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
sellerNonce
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
bidNonce
=
await
additionalBidHelper
.
computeBidNonce
(
auctionNonce
sellerNonce
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
additionalBidHelper
.
setSellerNonceInHeader
(
additionalBid
sellerNonce
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
0
'
horses
'
)
;
}
'
single
valid
additional
bid
with
bidNonce
and
sellerNonce
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
sellerNonce
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
additionalBidHelper
.
setSellerNonceInHeader
(
additionalBid
sellerNonce
)
;
await
runAdditionalBidTestNoWinner
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
)
;
}
'
single
additional
bid
with
sellerNonce
in
the
header
but
auctionNonce
in
the
bid
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
sellerNonce
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
additionalBidHelper
.
setSellerNonceInHeader
(
additionalBid
sellerNonce
)
;
await
runAdditionalBidTestNoWinner
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
)
;
}
'
single
additional
bid
with
sellerNonce
in
the
header
but
no
bidNonce
or
'
+
'
auctionNonce
in
the
bid
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
sellerNonce
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
auctionNonce
=
auctionNonce
;
additionalBid
.
bidNonce
=
await
additionalBidHelper
.
computeBidNonce
(
auctionNonce
sellerNonce
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
additionalBidHelper
.
setSellerNonceInHeader
(
additionalBid
sellerNonce
)
;
await
runAdditionalBidTestNoWinner
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
)
;
}
'
single
additional
bid
with
sellerNonce
in
the
header
but
with
both
'
+
'
bidNonce
and
auctionNonce
in
the
bid
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
sellerNonce
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
bidNonce
=
await
additionalBidHelper
.
computeBidNonce
(
auctionNonce
crypto
.
randomUUID
(
)
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
additionalBidHelper
.
setSellerNonceInHeader
(
additionalBid
sellerNonce
)
;
await
runAdditionalBidTestNoWinner
(
test
uuid
[
buyer
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
)
;
}
'
single
additional
bid
with
invalid
bidNonce
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
sellerNonce1
=
crypto
.
randomUUID
(
)
;
const
sellerNonce2
=
crypto
.
randomUUID
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
bidNonce
=
await
additionalBidHelper
.
computeBidNonce
(
auctionNonce
sellerNonce1
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
additionalBidHelper
.
setSellerNonceInHeader
(
additionalBid1
sellerNonce1
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
bidNonce
=
await
additionalBidHelper
.
computeBidNonce
(
auctionNonce
sellerNonce2
)
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
additionalBidHelper
.
setSellerNonceInHeader
(
additionalBid2
sellerNonce2
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
additionalBid2
]
)
1
.
99
'
planes
'
)
;
}
'
two
valid
additional
bids
using
distinct
bidNonces
and
sellerNonces
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
negativeInterestGroupName
=
'
already
-
owns
-
a
-
plane
'
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
planes
'
2
.
99
)
;
additionalBid
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
additionalBidHelper
.
addNegativeInterestGroup
(
additionalBid
negativeInterestGroupName
)
;
additionalBidHelper
.
signWithSecretKeys
(
additionalBid
[
ADDITIONAL_BID_SECRET_KEY
]
)
;
await
joinNegativeInterestGroup
(
test
buyer
negativeInterestGroupName
ADDITIONAL_BID_PUBLIC_KEY
)
;
await
runBasicFledgeTestExpectingNoWinner
(
test
uuid
{
interestGroupBuyers
:
[
buyer
]
auctionNonce
:
auctionNonce
additionalBids
:
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
}
)
;
}
'
one
additional
bid
filtered
by
negative
targeting
so
auction
has
no
'
+
'
winner
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
negativeInterestGroupName
=
'
already
-
owns
-
a
-
plane
'
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
additionalBidHelper
.
addNegativeInterestGroup
(
additionalBid2
negativeInterestGroupName
)
;
additionalBidHelper
.
signWithSecretKeys
(
additionalBid2
[
ADDITIONAL_BID_SECRET_KEY
]
)
;
await
joinNegativeInterestGroup
(
test
buyer2
negativeInterestGroupName
ADDITIONAL_BID_PUBLIC_KEY
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
additionalBid2
]
)
0
'
horses
'
)
;
}
'
higher
additional
bid
is
filtered
by
negative
targeting
so
'
+
'
lower
additional
bid
wins
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
negativeInterestGroupName
=
'
already
-
owns
-
a
-
plane
'
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
additionalBidHelper
.
addNegativeInterestGroup
(
additionalBid2
negativeInterestGroupName
)
;
await
joinNegativeInterestGroup
(
test
buyer2
negativeInterestGroupName
ADDITIONAL_BID_PUBLIC_KEY
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
additionalBid2
]
)
1
.
99
'
planes
'
)
;
}
'
higher
additional
bid
is
filtered
by
negative
targeting
but
it
is
'
+
'
missing
a
signature
so
it
still
wins
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
negativeInterestGroupName
=
'
already
-
owns
-
a
-
plane
'
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
additionalBidHelper
.
addNegativeInterestGroup
(
additionalBid2
negativeInterestGroupName
)
;
additionalBidHelper
.
incorrectlySignWithSecretKeys
(
additionalBid2
[
ADDITIONAL_BID_SECRET_KEY
]
)
;
await
joinNegativeInterestGroup
(
test
buyer2
negativeInterestGroupName
ADDITIONAL_BID_PUBLIC_KEY
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
additionalBid2
]
)
1
.
99
'
planes
'
)
;
}
'
higher
additional
bid
is
filtered
by
negative
targeting
but
it
has
an
'
+
'
invalid
signature
so
it
still
wins
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
negativeInterestGroupName1
=
'
already
-
owns
-
a
-
plane
'
;
const
negativeInterestGroupName2
=
'
another
-
negative
-
interest
-
group
'
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
additionalBidHelper
.
addNegativeInterestGroups
(
additionalBid2
[
negativeInterestGroupName1
negativeInterestGroupName2
]
window
.
location
.
origin
)
;
additionalBidHelper
.
signWithSecretKeys
(
additionalBid2
[
ADDITIONAL_BID_SECRET_KEY
]
)
;
await
joinNegativeInterestGroup
(
test
buyer2
negativeInterestGroupName1
ADDITIONAL_BID_PUBLIC_KEY
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
additionalBid2
]
)
0
'
horses
'
)
;
}
'
higher
additional
bid
is
filtered
by
negative
targeting
by
two
negative
'
+
'
interest
groups
and
since
one
is
on
the
device
the
lower
bid
wins
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
negativeInterestGroupName1
=
'
already
-
owns
-
a
-
plane
'
;
const
negativeInterestGroupName2
=
'
another
-
negative
-
interest
-
group
'
;
const
buyer1
=
OTHER_ORIGIN1
;
const
additionalBid1
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer1
'
horses
'
1
.
99
)
;
additionalBid1
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid1
auctionNonce
)
;
const
buyer2
=
OTHER_ORIGIN2
;
const
additionalBid2
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer2
'
planes
'
2
.
99
)
;
additionalBid2
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid2
auctionNonce
)
;
additionalBidHelper
.
addNegativeInterestGroups
(
additionalBid2
[
negativeInterestGroupName1
negativeInterestGroupName2
]
OTHER_ORIGIN1
)
;
additionalBidHelper
.
signWithSecretKeys
(
additionalBid2
[
ADDITIONAL_BID_SECRET_KEY
]
)
;
await
joinNegativeInterestGroup
(
test
buyer2
negativeInterestGroupName1
ADDITIONAL_BID_PUBLIC_KEY
)
;
await
runAdditionalBidTest
(
test
uuid
[
buyer1
buyer2
]
auctionNonce
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid1
additionalBid2
]
)
1
.
99
'
planes
'
)
;
}
'
higher
additional
bid
is
filtered
by
negative
targeting
by
two
negative
'
+
'
interest
groups
but
because
of
a
joining
origin
mismatch
it
still
wins
'
)
;
subsetTest
(
promise_test
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
const
auctionNonce
=
await
navigator
.
createAuctionNonce
(
)
;
const
seller
=
SINGLE_SELLER_AUCTION_SELLER
;
const
buyer
=
OTHER_ORIGIN1
;
const
additionalBid
=
additionalBidHelper
.
createAdditionalBid
(
uuid
seller
buyer
'
horses
'
1
.
99
)
;
additionalBid
.
auctionNonce
=
auctionNonce
;
additionalBidHelper
.
setAuctionNonceInHeader
(
additionalBid
auctionNonce
)
;
let
renderURL
=
createRenderURL
(
uuid
)
;
await
runBasicFledgeTestExpectingWinner
(
test
uuid
{
interestGroupBuyers
:
[
buyer
]
auctionNonce
:
auctionNonce
additionalBids
:
additionalBidHelper
.
fetchAdditionalBids
(
seller
[
additionalBid
]
)
decisionLogicURL
:
createDecisionScriptURL
(
uuid
{
scoreAd
:
if
(
!
"
{
renderURL
}
"
in
trustedScoringSignals
.
renderURL
)
+
'
throw
"
missing
trusted
signals
"
;
'
}
)
trustedScoringSignalsURL
:
TRUSTED_SCORING_SIGNALS_URL
}
)
;
}
'
trusted
seller
signals
retrieved
for
additional
bids
'
)
;
