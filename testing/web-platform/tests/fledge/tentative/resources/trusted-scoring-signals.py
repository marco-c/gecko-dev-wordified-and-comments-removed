import
json
from
urllib
.
parse
import
unquote_plus
urlparse
from
fledge
.
tentative
.
resources
import
fledge_http_server_util
def
main
(
request
response
)
:
    
hostname
=
None
    
renderUrls
=
None
    
adComponentRenderURLs
=
None
    
urlLists
=
[
]
    
for
param
in
request
.
url_parts
.
query
.
split
(
"
&
"
)
:
        
pair
=
param
.
split
(
"
=
"
1
)
        
if
len
(
pair
)
!
=
2
:
            
return
fail
(
response
"
Bad
query
parameter
:
"
+
param
)
        
if
"
%
20
"
in
pair
[
1
]
:
            
return
fail
(
response
"
Query
parameter
should
escape
using
'
+
'
:
"
+
param
)
        
if
pair
[
0
]
=
=
"
hostname
"
and
hostname
=
=
None
and
len
(
pair
[
1
]
)
>
0
:
            
hostname
=
pair
[
1
]
            
continue
        
if
pair
[
0
]
=
=
"
renderUrls
"
and
renderUrls
=
=
None
:
            
renderUrls
=
list
(
map
(
unquote_plus
pair
[
1
]
.
split
(
"
"
)
)
)
            
urlLists
.
append
(
{
"
type
"
:
"
renderURLs
"
"
urls
"
:
renderUrls
}
)
            
continue
        
if
pair
[
0
]
=
=
"
adComponentRenderUrls
"
and
adComponentRenderURLs
=
=
None
:
            
adComponentRenderURLs
=
list
(
map
(
unquote_plus
pair
[
1
]
.
split
(
"
"
)
)
)
            
urlLists
.
append
(
{
"
type
"
:
"
adComponentRenderURLs
"
"
urls
"
:
adComponentRenderURLs
}
)
            
continue
        
return
fail
(
response
"
Unexpected
query
parameter
:
"
+
param
)
    
if
not
hostname
:
        
return
fail
(
response
"
hostname
missing
"
)
    
if
not
renderUrls
:
        
return
fail
(
response
"
renderUrls
missing
"
)
    
response
.
status
=
(
200
b
"
OK
"
)
    
responseBody
=
{
"
renderUrls
"
:
{
}
}
    
body
=
None
    
contentType
=
"
application
/
json
"
    
adAuctionAllowed
=
"
true
"
    
dataVersion
=
None
    
for
urlList
in
urlLists
:
        
for
renderUrl
in
urlList
[
"
urls
"
]
:
            
value
=
"
default
value
"
            
addValue
=
True
            
signalsParams
=
None
            
for
param
in
urlparse
(
renderUrl
)
.
query
.
split
(
"
&
"
)
:
                
pair
=
param
.
split
(
"
=
"
1
)
                
if
len
(
pair
)
!
=
2
:
                    
continue
                
if
pair
[
0
]
=
=
"
signalsParams
"
:
                    
if
signalsParams
!
=
None
:
                        
return
fail
(
response
"
renderUrl
has
multiple
signalsParams
:
"
+
renderUrl
)
                    
signalsParams
=
pair
[
1
]
            
if
signalsParams
!
=
None
:
                
signalsParams
=
unquote_plus
(
signalsParams
)
                
for
signalsParam
in
signalsParams
.
split
(
"
"
)
:
                    
if
signalsParam
=
=
"
close
-
connection
"
:
                        
response
.
writer
.
write
(
"
"
)
                        
response
.
close_connection
=
True
                        
return
                    
elif
signalsParam
.
startswith
(
"
replace
-
body
:
"
)
:
                        
body
=
signalsParam
.
split
(
'
:
'
1
)
[
1
]
                    
elif
signalsParam
.
startswith
(
"
data
-
version
:
"
)
:
                        
dataVersion
=
signalsParam
.
split
(
'
:
'
1
)
[
1
]
                    
elif
signalsParam
=
=
"
http
-
error
"
:
                        
response
.
status
=
(
404
b
"
Not
found
"
)
                    
elif
signalsParam
=
=
"
no
-
content
-
type
"
:
                        
contentType
=
None
                    
elif
signalsParam
=
=
"
wrong
-
content
-
type
"
:
                        
contentType
=
'
text
/
plain
'
                    
elif
signalsParam
=
=
"
bad
-
ad
-
auction
-
allowed
"
:
                        
adAuctionAllowed
=
"
sometimes
"
                    
elif
signalsParam
=
=
"
ad
-
auction
-
not
-
allowed
"
:
                        
adAuctionAllowed
=
"
false
"
                    
elif
signalsParam
=
=
"
no
-
ad
-
auction
-
allow
"
:
                        
adAuctionAllowed
=
None
                    
elif
signalsParam
=
=
"
wrong
-
url
"
:
                        
renderUrl
=
"
https
:
/
/
wrong
-
url
.
test
/
"
                    
elif
signalsParam
=
=
"
no
-
value
"
:
                        
addValue
=
False
                    
elif
signalsParam
=
=
"
null
-
value
"
:
                        
value
=
None
                    
elif
signalsParam
=
=
"
num
-
value
"
:
                        
value
=
1
                    
elif
signalsParam
=
=
"
string
-
value
"
:
                        
value
=
"
1
"
                    
elif
signalsParam
=
=
"
array
-
value
"
:
                        
value
=
[
1
"
foo
"
None
]
                    
elif
signalsParam
=
=
"
object
-
value
"
:
                        
value
=
{
"
a
"
:
"
b
"
"
c
"
:
[
"
d
"
]
}
                    
elif
signalsParam
=
=
"
hostname
"
:
                        
value
=
request
.
GET
.
first
(
b
"
hostname
"
b
"
not
-
found
"
)
.
decode
(
"
ASCII
"
)
                    
elif
signalsParam
=
=
"
headers
"
:
                        
value
=
fledge_http_server_util
.
headers_to_ascii
(
request
.
headers
)
                    
elif
signalsParam
=
=
"
url
"
:
                        
value
=
request
.
url
            
if
addValue
:
                
if
urlList
[
"
type
"
]
not
in
responseBody
:
                    
responseBody
[
urlList
[
"
type
"
]
]
=
{
}
                
responseBody
[
urlList
[
"
type
"
]
]
[
renderUrl
]
=
value
    
if
contentType
:
        
response
.
headers
.
set
(
"
Content
-
Type
"
contentType
)
    
if
adAuctionAllowed
:
        
response
.
headers
.
set
(
"
Ad
-
Auction
-
Allowed
"
adAuctionAllowed
)
    
if
dataVersion
:
        
response
.
headers
.
set
(
"
Data
-
Version
"
dataVersion
)
    
if
body
!
=
None
:
        
return
body
    
return
json
.
dumps
(
responseBody
)
def
fail
(
response
body
)
:
    
response
.
status
=
(
400
"
Bad
Request
"
)
    
response
.
headers
.
set
(
b
"
Content
-
Type
"
b
"
text
/
plain
"
)
    
return
body
