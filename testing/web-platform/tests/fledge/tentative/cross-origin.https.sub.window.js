"
use
strict
;
"
const
OTHER_ORIGIN1
=
'
https
:
/
/
{
{
hosts
[
alt
]
[
]
}
}
:
{
{
ports
[
https
]
[
0
]
}
}
'
;
function
runInIframe
(
test
iframe
script
)
{
const
messageUuid
=
generateUuid
(
test
)
;
return
new
Promise
(
function
(
resolve
reject
)
{
function
WaitForMessage
(
event
)
{
if
(
event
.
data
.
messageUuid
!
=
messageUuid
)
return
;
if
(
event
.
data
.
result
=
=
=
'
success
'
)
{
resolve
(
)
;
}
else
{
reject
(
event
.
data
.
result
)
;
}
}
window
.
addEventListener
(
'
message
'
WaitForMessage
)
;
iframe
.
contentWindow
.
postMessage
(
{
messageUuid
:
messageUuid
script
:
script
}
'
*
'
)
;
}
)
;
}
async
function
createIframe
(
test
origin
permissions
)
{
const
iframeUuid
=
generateUuid
(
test
)
;
const
iframeUrl
=
{
origin
}
{
RESOURCE_PATH
}
iframe
.
sub
.
html
?
uuid
=
{
iframeUuid
}
;
let
iframe
=
document
.
createElement
(
'
iframe
'
)
;
await
new
Promise
(
function
(
resolve
reject
)
{
function
WaitForMessage
(
event
)
{
if
(
event
.
data
.
messageUuid
!
=
iframeUuid
)
return
;
if
(
event
.
data
.
result
=
=
=
'
load
complete
'
)
{
resolve
(
)
;
}
else
{
reject
(
event
.
data
.
result
)
;
}
}
window
.
addEventListener
(
'
message
'
WaitForMessage
)
;
if
(
permissions
)
iframe
.
allow
=
permissions
;
iframe
.
src
=
iframeUrl
;
document
.
body
.
appendChild
(
iframe
)
;
test
.
add_cleanup
(
async
(
)
=
>
{
await
runInIframe
(
test
iframe
"
await
test_instance
.
do_cleanup
(
)
;
"
)
;
document
.
body
.
removeChild
(
iframe
)
;
}
)
;
}
)
;
return
iframe
;
}
promise_test
(
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
let
iframe
=
await
createIframe
(
test
document
.
location
.
origin
)
;
await
runInIframe
(
test
iframe
await
joinInterestGroup
(
test_instance
"
{
uuid
}
"
)
;
)
;
let
config
=
await
runBasicFledgeTestExpectingWinner
(
test
uuid
)
;
}
'
Join
interest
group
in
same
-
origin
iframe
default
permissions
.
'
)
;
promise_test
(
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
let
iframe
=
await
createIframe
(
test
OTHER_ORIGIN1
)
;
await
runInIframe
(
test
iframe
await
joinInterestGroup
(
test_instance
"
{
uuid
}
"
)
;
)
;
let
config
=
await
runBasicFledgeTestExpectingWinner
(
test
uuid
{
interestGroupBuyers
:
[
OTHER_ORIGIN1
]
scoreAd
:
if
(
browserSignals
.
interestGroupOwner
!
=
=
"
{
OTHER_ORIGIN1
}
"
)
throw
"
Wrong
owner
:
"
+
browserSignals
.
interestGroupOwner
}
)
;
}
'
Join
interest
group
in
cross
-
origin
iframe
default
permissions
.
'
)
;
promise_test
(
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
let
iframe
=
await
createIframe
(
test
OTHER_ORIGIN1
'
join
-
ad
-
interest
-
group
'
)
;
await
runInIframe
(
test
iframe
await
joinInterestGroup
(
test_instance
"
{
uuid
}
"
)
;
)
;
let
config
=
await
runBasicFledgeTestExpectingWinner
(
test
uuid
{
interestGroupBuyers
:
[
OTHER_ORIGIN1
]
scoreAd
:
if
(
browserSignals
.
interestGroupOwner
!
=
=
"
{
OTHER_ORIGIN1
}
"
)
throw
"
Wrong
owner
:
"
+
browserSignals
.
interestGroupOwner
}
)
;
}
'
Join
interest
group
in
cross
-
origin
iframe
with
join
-
ad
-
interest
-
group
permission
.
'
)
;
promise_test
(
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
let
iframe
=
await
createIframe
(
test
OTHER_ORIGIN1
"
join
-
ad
-
interest
-
group
'
none
'
"
)
;
await
runInIframe
(
test
iframe
try
{
await
joinInterestGroup
(
test_instance
"
{
uuid
}
"
)
;
}
catch
(
e
)
{
return
"
success
"
;
}
return
"
exception
unexpectedly
not
thrown
"
;
)
;
let
config
=
await
runBasicFledgeTestExpectingNoWinner
(
test
uuid
{
interestGroupBuyers
:
[
OTHER_ORIGIN1
]
}
)
;
}
'
Join
interest
group
in
cross
-
origin
iframe
with
join
-
ad
-
interest
-
group
permission
denied
.
'
)
;
promise_test
(
async
test
=
>
{
const
uuid
=
generateUuid
(
test
)
;
let
iframe
=
await
createIframe
(
test
OTHER_ORIGIN1
'
join
-
ad
-
interest
-
group
'
)
;
let
interestGroup
=
JSON
.
stringify
(
createInterestGroupForOrigin
(
uuid
window
.
location
.
origin
)
)
;
await
runInIframe
(
test
iframe
joinInterestGroup
(
test_instance
"
{
uuid
}
"
{
interestGroup
}
)
)
;
let
config
=
await
runBasicFledgeTestExpectingNoWinner
(
test
uuid
)
;
}
"
Join
interest
group
owned
by
parent
'
s
origin
in
cross
-
origin
iframe
.
"
)
;
