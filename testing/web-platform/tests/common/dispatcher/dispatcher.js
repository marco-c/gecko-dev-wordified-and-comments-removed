const
dispatcher_path
=
"
/
common
/
dispatcher
/
dispatcher
.
py
"
;
const
dispatcher_url
=
new
URL
(
dispatcher_path
location
.
href
)
.
href
;
const
concurrencyLimiter
=
(
max_concurrency
)
=
>
{
let
pending
=
0
;
let
waiting
=
[
]
;
return
async
(
task
)
=
>
{
pending
+
+
;
if
(
pending
>
max_concurrency
)
await
new
Promise
(
resolve
=
>
waiting
.
push
(
resolve
)
)
;
let
result
=
await
task
(
)
;
pending
-
-
;
waiting
.
shift
(
)
?
.
(
)
;
return
result
;
}
;
}
const
randomDelay
=
(
)
=
>
{
return
new
Promise
(
resolve
=
>
setTimeout
(
resolve
10
+
90
*
Math
.
random
(
)
)
)
;
}
const
limiter
=
concurrencyLimiter
(
6
)
;
const
send
=
async
function
(
uuid
message
)
{
await
limiter
(
async
(
)
=
>
{
while
(
1
)
{
try
{
let
response
=
await
fetch
(
dispatcher_url
+
?
uuid
=
{
uuid
}
{
method
:
'
POST
'
body
:
message
}
)
if
(
await
response
.
text
(
)
=
=
"
done
"
)
return
;
}
catch
(
fetch_error
)
{
}
await
randomDelay
(
)
;
}
;
}
)
;
}
const
receive
=
async
function
(
uuid
)
{
while
(
1
)
{
let
data
=
"
not
ready
"
;
try
{
data
=
await
limiter
(
async
(
)
=
>
{
let
response
=
await
fetch
(
dispatcher_url
+
?
uuid
=
{
uuid
}
)
;
return
await
response
.
text
(
)
;
}
)
;
}
catch
(
fetch_error
)
{
}
if
(
data
=
=
"
not
ready
"
)
{
await
randomDelay
(
)
;
continue
;
}
return
data
;
}
}
const
showRequestHeaders
=
function
(
origin
uuid
)
{
return
origin
+
dispatcher_path
+
?
uuid
=
{
uuid
}
&
show
-
headers
;
}
const
cacheableShowRequestHeaders
=
function
(
origin
uuid
)
{
return
origin
+
dispatcher_path
+
?
uuid
=
{
uuid
}
&
cacheable
&
show
-
headers
;
}
