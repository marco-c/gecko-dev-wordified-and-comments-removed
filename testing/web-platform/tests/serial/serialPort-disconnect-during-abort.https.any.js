serial_test
(
async
(
t
fake
)
=
>
{
const
{
port
fakePort
}
=
await
getFakeSerialPort
(
fake
)
;
await
port
.
open
(
{
baudRate
:
9600
}
)
;
assert_true
(
port
.
writable
instanceof
WritableStream
)
;
const
writer
=
port
.
writable
.
getWriter
(
)
;
await
fakePort
.
readable
(
)
;
fakePort
.
simulateDisconnectOnWrite
(
)
;
const
data
=
new
Uint8Array
(
1024
)
;
const
writePromise
=
writer
.
write
(
data
)
;
await
promise_rejects_dom
(
t
'
NetworkError
'
writer
.
abort
(
'
Aborting
'
)
)
;
await
promise_rejects_exactly
(
t
'
Aborting
'
writePromise
)
;
await
port
.
close
(
)
;
}
'
Disconnect
error
during
abort
works
correctly
'
)
;
