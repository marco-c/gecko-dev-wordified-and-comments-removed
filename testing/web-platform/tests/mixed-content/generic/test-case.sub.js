function
getSubresourceOrigin
(
originType
)
{
const
httpProtocol
=
"
http
"
;
const
httpsProtocol
=
"
https
"
;
const
wsProtocol
=
"
ws
"
;
const
wssProtocol
=
"
wss
"
;
const
sameOriginHost
=
"
{
{
host
}
}
"
;
const
crossOriginHost
=
"
{
{
domains
[
www1
]
}
}
"
;
const
httpPort
=
getNormalizedPort
(
parseInt
(
"
{
{
ports
[
http
]
[
0
]
}
}
"
10
)
)
;
const
httpsPort
=
getNormalizedPort
(
parseInt
(
"
{
{
ports
[
https
]
[
0
]
}
}
"
10
)
)
;
const
wsPort
=
getNormalizedPort
(
parseInt
(
"
{
{
ports
[
ws
]
[
0
]
}
}
"
10
)
)
;
const
wssPort
=
getNormalizedPort
(
parseInt
(
"
{
{
ports
[
wss
]
[
0
]
}
}
"
10
)
)
;
const
originMap
=
{
"
same
-
https
"
:
httpsProtocol
+
"
:
/
/
"
+
sameOriginHost
+
httpsPort
"
same
-
http
"
:
httpProtocol
+
"
:
/
/
"
+
sameOriginHost
+
httpPort
"
cross
-
https
"
:
httpsProtocol
+
"
:
/
/
"
+
crossOriginHost
+
httpsPort
"
cross
-
http
"
:
httpProtocol
+
"
:
/
/
"
+
crossOriginHost
+
httpPort
"
same
-
wss
"
:
wssProtocol
+
"
:
/
/
"
+
sameOriginHost
+
wssPort
"
same
-
ws
"
:
wsProtocol
+
"
:
/
/
"
+
sameOriginHost
+
wsPort
"
cross
-
wss
"
:
wssProtocol
+
"
:
/
/
"
+
crossOriginHost
+
wssPort
"
cross
-
ws
"
:
wsProtocol
+
"
:
/
/
"
+
crossOriginHost
+
wsPort
}
;
return
originMap
[
originType
]
;
}
function
TestCase
(
scenario
description
sanityChecker
)
{
sanityChecker
.
checkScenario
(
scenario
subresourceMap
)
;
const
redirectionTypeConversion
=
{
"
no
-
redirect
"
:
"
no
-
redirect
"
"
keep
-
scheme
"
:
"
keep
-
scheme
-
redirect
"
"
swap
-
scheme
"
:
"
swap
-
scheme
-
redirect
"
"
keep
-
origin
"
:
"
keep
-
origin
-
redirect
"
"
swap
-
origin
"
:
"
swap
-
origin
-
redirect
"
}
;
const
subresourceTypeConversion
=
{
"
beacon
"
:
"
beacon
-
request
"
"
fetch
"
:
"
fetch
-
request
"
"
xhr
"
:
"
xhr
-
request
"
"
websocket
"
:
"
websocket
-
request
"
"
worker
-
classic
"
:
"
worker
-
request
"
"
worker
-
module
"
:
"
module
-
worker
"
"
worker
-
import
-
data
"
:
"
module
-
data
-
worker
-
import
"
"
sharedworker
-
classic
"
:
"
shared
-
worker
"
"
worklet
-
animation
"
:
"
worklet
-
animation
-
top
-
level
"
"
worklet
-
audio
"
:
"
worklet
-
audio
-
top
-
level
"
"
worklet
-
layout
"
:
"
worklet
-
layout
-
top
-
level
"
"
worklet
-
paint
"
:
"
worklet
-
paint
-
top
-
level
"
"
worklet
-
animation
-
import
-
data
"
:
"
worklet
-
animation
-
data
-
import
"
"
worklet
-
audio
-
import
-
data
"
:
"
worklet
-
audio
-
data
-
import
"
"
worklet
-
layout
-
import
-
data
"
:
"
worklet
-
layout
-
data
-
import
"
"
worklet
-
paint
-
import
-
data
"
:
"
worklet
-
paint
-
data
-
import
"
}
;
const
subresourceType
=
subresourceTypeConversion
[
scenario
.
subresource
]
|
|
scenario
.
subresource
;
const
urls
=
getRequestURLs
(
subresourceType
scenario
.
origin
redirectionTypeConversion
[
scenario
.
redirection
]
)
;
const
checkResult
=
_
=
>
{
return
xhrRequest
(
urls
.
assertUrl
)
.
then
(
assertResult
=
>
{
assert_equals
(
assertResult
.
status
scenario
.
expectation
"
The
resource
request
should
be
'
"
+
scenario
.
expectation
+
"
'
.
"
)
;
}
)
;
}
;
function
runTest
(
)
{
const
subresource
=
{
subresourceType
:
subresourceType
url
:
urls
.
testUrl
policyDeliveries
:
scenario
.
subresource_policy_deliveries
}
;
promise_test
(
(
)
=
>
{
return
xhrRequest
(
urls
.
announceUrl
)
.
then
(
_
=
>
invokeRequest
(
subresource
scenario
.
source_context_list
)
)
.
then
(
checkResult
checkResult
)
;
}
description
)
;
}
return
{
start
:
runTest
}
;
}
