window
.
AudioContext
=
window
.
AudioContext
|
|
window
.
webkitAudioContext
;
var
FFT_SIZE
=
2048
;
var
audioContext
;
var
sourceNode
;
function
getPitchDetector
(
media
)
{
if
(
!
audioContext
)
{
audioContext
=
new
AudioContext
(
)
;
sourceNode
=
audioContext
.
createMediaElementSource
(
media
)
;
}
var
analyser
=
audioContext
.
createAnalyser
(
)
;
analyser
.
fftSize
=
FFT_SIZE
;
sourceNode
.
connect
(
analyser
)
;
analyser
.
connect
(
audioContext
.
destination
)
;
return
{
ensureStart
(
)
{
return
audioContext
.
resume
(
)
;
}
detect
(
)
{
return
getPitch
(
analyser
)
;
}
cleanup
(
)
{
sourceNode
.
disconnect
(
)
;
analyser
.
disconnect
(
)
;
}
}
;
}
function
getPitch
(
analyser
)
{
var
binConverter
=
(
bin
)
=
>
(
audioContext
.
sampleRate
/
2
)
*
(
(
bin
)
/
(
analyser
.
frequencyBinCount
-
1
)
)
;
var
buf
=
new
Uint8Array
(
analyser
.
frequencyBinCount
)
;
analyser
.
getByteFrequencyData
(
buf
)
;
return
findDominantFrequency
(
buf
binConverter
)
;
}
function
findDominantFrequency
(
buf
binConverter
)
{
var
max
=
0
;
var
bin
=
0
;
for
(
var
i
=
0
;
i
<
buf
.
length
;
i
+
+
)
{
if
(
buf
[
i
]
>
max
)
{
max
=
buf
[
i
]
;
bin
=
i
;
}
}
return
{
value
:
binConverter
(
bin
)
margin
:
binConverter
(
1
)
}
;
}
