'
use
strict
'
;
runBfcacheTest
(
{
funcBeforeNavigation
:
async
(
)
=
>
{
globalThis
.
worker
=
new
SharedWorker
(
'
.
.
/
resources
/
echo
-
worker
.
js
'
)
;
await
WorkerHelper
.
pingWorker
(
globalThis
.
worker
)
;
const
workerUrl
=
new
URL
(
'
.
.
/
resources
/
echo
-
worker
.
js
'
window
.
location
.
href
)
.
href
;
const
helperPageContent
=
<
script
>
new
SharedWorker
(
'
{
workerUrl
}
'
)
;
const
bc
=
new
BroadcastChannel
(
'
worker_ready
'
)
;
bc
.
postMessage
(
'
ready
'
)
;
bc
.
close
(
)
;
<
/
script
>
;
const
blob
=
new
Blob
(
[
helperPageContent
]
{
type
:
'
text
/
html
'
}
)
;
window
.
open
(
URL
.
createObjectURL
(
blob
)
'
_blank
'
'
noopener
'
)
;
await
new
Promise
(
resolve
=
>
{
const
bc
=
new
BroadcastChannel
(
'
worker_ready
'
)
;
bc
.
onmessage
=
e
=
>
{
if
(
e
.
data
=
=
=
'
ready
'
)
{
bc
.
close
(
)
;
resolve
(
)
;
}
}
;
}
)
;
}
funcAfterAssertion
:
async
(
pageA
)
=
>
{
assert_equals
(
await
pageA
.
execute_script
(
(
)
=
>
WorkerHelper
.
pingWorker
(
globalThis
.
worker
)
)
'
PASS
'
'
SharedWorker
should
still
work
after
restored
from
BFCache
'
)
;
}
}
'
Eligibility
:
shared
workers
with
another
active
client
in
a
separate
window
'
)
;
