const
sw_url
=
location
.
pathname
.
replace
(
/
[
^
/
]
*
/
'
'
)
+
"
.
/
resources
/
serviceworker
-
partitioning
-
helper
.
js
"
;
promise_test
(
async
t
=
>
{
let
iframes
=
await
Promise
.
all
(
[
{
name
:
"
normal
"
anonymous
:
false
}
{
name
:
"
normal_control
"
anonymous
:
false
}
{
name
:
"
anonymous
"
anonymous
:
true
}
{
name
:
"
anonymous_control
"
anonymous
:
true
}
]
.
map
(
async
(
{
name
anonymous
}
)
=
>
{
let
iframe
=
await
new
Promise
(
resolve
=
>
{
let
iframe
=
document
.
createElement
(
'
iframe
'
)
;
iframe
.
onload
=
(
)
=
>
resolve
(
iframe
)
;
iframe
.
src
=
'
/
common
/
blank
.
html
'
;
if
(
anonymous
)
iframe
.
anonymous
=
true
;
document
.
body
.
append
(
iframe
)
;
}
)
;
let
sw
=
await
new
Promise
(
resolve
=
>
{
iframe
.
contentWindow
.
navigator
.
serviceWorker
.
register
(
sw_url
)
.
then
(
r
=
>
{
add_completion_callback
(
_
=
>
r
.
unregister
(
)
)
;
resolve
(
r
.
active
|
|
r
.
installing
|
|
r
.
waiting
)
;
}
)
;
}
)
;
return
{
iframe
:
iframe
name
:
name
sw
:
sw
}
;
}
)
)
;
iframes
.
forEach
(
(
iframe
i
)
=
>
{
iframe
.
channel
=
new
MessageChannel
(
)
;
iframe
.
sw
.
postMessage
(
{
from
:
iframe
.
name
}
[
iframe
.
channel
.
port2
]
)
;
}
)
;
let
msg_promises
=
iframes
.
map
(
iframe
=
>
new
Promise
(
resolve
=
>
{
iframe
.
channel
.
port1
.
onmessage
=
event
=
>
resolve
(
event
.
data
)
;
}
)
)
;
iframes
.
map
(
iframe
=
>
iframe
.
sw
.
postMessage
(
{
check
:
iframe
.
name
}
)
)
;
let
msgs
=
await
Promise
.
all
(
msg_promises
)
;
assert_true
(
!
!
msgs
[
0
]
[
"
normal
"
]
)
;
assert_true
(
!
!
msgs
[
0
]
[
"
normal_control
"
]
)
;
assert_false
(
!
!
msgs
[
0
]
[
"
anonymous
"
]
)
;
assert_false
(
!
!
msgs
[
0
]
[
"
anonymous_control
"
]
)
;
assert_true
(
!
!
msgs
[
1
]
[
"
normal
"
]
)
;
assert_true
(
!
!
msgs
[
1
]
[
"
normal_control
"
]
)
;
assert_false
(
!
!
msgs
[
1
]
[
"
anonymous
"
]
)
;
assert_false
(
!
!
msgs
[
1
]
[
"
anonymous_control
"
]
)
;
assert_false
(
!
!
msgs
[
2
]
[
"
normal
"
]
)
;
assert_false
(
!
!
msgs
[
2
]
[
"
normal_control
"
]
)
;
assert_true
(
!
!
msgs
[
2
]
[
"
anonymous
"
]
)
;
assert_true
(
!
!
msgs
[
2
]
[
"
anonymous_control
"
]
)
;
assert_false
(
!
!
msgs
[
3
]
[
"
normal
"
]
)
;
assert_false
(
!
!
msgs
[
3
]
[
"
normal_control
"
]
)
;
assert_true
(
!
!
msgs
[
3
]
[
"
anonymous
"
]
)
;
assert_true
(
!
!
msgs
[
3
]
[
"
anonymous_control
"
]
)
;
}
"
Anonymous
iframes
get
partitioned
service
workers
.
"
)
;
