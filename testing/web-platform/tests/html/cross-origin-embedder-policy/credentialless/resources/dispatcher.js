const
dispatcher_path
=
"
/
html
/
cross
-
origin
-
embedder
-
policy
/
credentialless
/
resources
/
dispatcher
.
py
"
;
const
dispatcher_url
=
new
URL
(
dispatcher_path
location
.
href
)
.
href
;
const
send
=
async
function
(
uuid
message
)
{
await
navigator
.
locks
.
request
(
"
dispatcher_send
"
async
lock
=
>
{
await
fetch
(
dispatcher_url
+
?
uuid
=
{
uuid
}
{
method
:
'
POST
'
body
:
message
}
)
;
}
)
;
}
const
receive
=
async
function
(
uuid
)
{
while
(
1
)
{
let
response
=
await
fetch
(
dispatcher_url
+
?
uuid
=
{
uuid
}
)
;
let
data
=
await
response
.
text
(
)
;
if
(
data
!
=
'
not
ready
'
)
return
data
;
await
new
Promise
(
r
=
>
setTimeout
(
r
10
+
100
*
Math
.
random
(
)
)
)
;
}
}
const
showRequestHeaders
=
function
(
origin
uuid
)
{
return
origin
+
dispatcher_path
+
?
uuid
=
{
uuid
}
&
show
-
headers
;
}
