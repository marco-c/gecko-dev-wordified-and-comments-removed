const
GET_PROTOCOLS
=
(
[
"
openid4vp
-
v1
-
unsigned
"
"
openid4vp
-
v1
-
signed
"
"
openid4vp
-
v1
-
multisigned
"
"
org
-
iso
-
mdoc
"
]
)
;
const
CREATE_PROTOCOLS
=
(
[
"
openid4vci
"
]
)
;
const
SUPPORTED_GET_PROTOCOL
=
GET_PROTOCOLS
.
find
(
(
protocol
)
=
>
DigitalCredential
.
userAgentAllowsProtocol
(
protocol
)
)
;
const
SUPPORTED_CREATE_PROTOCOL
=
CREATE_PROTOCOLS
.
find
(
(
protocol
)
=
>
DigitalCredential
.
userAgentAllowsProtocol
(
protocol
)
)
;
function
_makeOptionsInternal
(
requestsInputArray
mediation
requestMapping
signal
)
{
const
requests
=
[
]
;
for
(
const
request
of
requestsInputArray
)
{
const
factoryFunction
=
requestMapping
[
request
]
;
if
(
factoryFunction
)
{
requests
.
push
(
factoryFunction
(
)
)
;
}
else
{
throw
new
Error
(
Unknown
request
type
within
array
:
{
request
}
)
;
}
}
const
result
=
{
digital
:
{
requests
}
mediation
}
;
if
(
signal
!
=
=
undefined
)
{
result
.
signal
=
signal
;
}
return
result
;
}
const
allMappings
=
{
get
:
{
"
org
-
iso
-
mdoc
"
:
(
)
=
>
makeMDocRequest
(
)
"
openid4vp
-
v1
-
unsigned
"
:
(
)
=
>
makeOID4VPDict
(
"
openid4vp
-
v1
-
unsigned
"
)
"
openid4vp
-
v1
-
signed
"
:
(
)
=
>
makeOID4VPDict
(
"
openid4vp
-
v1
-
signed
"
)
"
openid4vp
-
v1
-
multisigned
"
:
(
)
=
>
makeOID4VPDict
(
"
openid4vp
-
v1
-
multisigned
"
)
}
create
:
{
"
openid4vci
"
:
(
)
=
>
makeOID4VCIDict
(
)
}
}
;
function
_makeOptionsUnified
(
type
protocol
mediation
signal
)
{
const
mapping
=
allMappings
[
type
]
;
if
(
!
mapping
)
{
throw
new
Error
(
Internal
error
:
Invalid
options
type
specified
:
{
type
}
)
;
}
if
(
typeof
protocol
=
=
=
'
string
'
)
{
if
(
protocol
in
mapping
)
{
return
_makeOptionsInternal
(
[
protocol
]
mediation
mapping
signal
)
;
}
else
{
throw
new
Error
(
Unknown
request
type
string
'
{
protocol
}
'
provided
for
operation
type
'
{
type
}
'
)
;
}
}
if
(
Array
.
isArray
(
protocol
)
)
{
if
(
protocol
.
length
=
=
=
0
)
{
const
result
=
{
digital
:
{
requests
:
[
]
}
mediation
}
;
if
(
signal
!
=
=
undefined
)
{
result
.
signal
=
signal
;
}
return
result
;
}
return
_makeOptionsInternal
(
protocol
mediation
mapping
signal
)
;
}
const
result
=
{
digital
:
{
requests
:
[
]
}
mediation
}
;
if
(
signal
!
=
=
undefined
)
{
result
.
signal
=
signal
;
}
return
result
;
}
export
function
makeGetOptions
(
config
=
{
}
)
{
const
{
protocol
=
SUPPORTED_GET_PROTOCOL
mediation
=
"
required
"
signal
}
=
config
;
if
(
!
protocol
)
{
throw
new
Error
(
"
No
Protocol
.
Can
'
t
make
get
options
.
"
)
;
}
return
_makeOptionsUnified
(
'
get
'
protocol
mediation
signal
)
;
}
export
function
makeCreateOptions
(
config
=
{
}
)
{
const
{
protocol
=
SUPPORTED_CREATE_PROTOCOL
mediation
=
"
required
"
signal
}
=
config
;
if
(
!
protocol
)
{
throw
new
Error
(
"
No
protocol
.
Can
'
t
make
create
options
.
"
)
;
}
return
_makeOptionsUnified
(
'
create
'
protocol
mediation
signal
)
;
}
function
makeDigitalCredentialGetRequest
(
protocol
=
"
protocol
"
data
=
{
}
)
{
return
{
protocol
data
}
;
}
function
makeOID4VPDict
(
identifier
=
"
openid4vp
-
v1
-
unsigned
"
)
{
return
makeDigitalCredentialGetRequest
(
identifier
{
}
)
;
}
function
makeDigitalCredentialCreateRequest
(
protocol
=
"
protocol
"
data
=
{
}
)
{
return
{
protocol
data
}
;
}
function
makeOID4VCIDict
(
)
{
return
makeDigitalCredentialCreateRequest
(
"
openid4vci
"
{
}
)
;
}
function
makeMDocRequest
(
)
{
return
makeDigitalCredentialGetRequest
(
"
org
-
iso
-
mdoc
"
{
}
)
;
}
export
function
sendMessage
(
iframe
data
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
if
(
!
iframe
.
contentWindow
)
{
reject
(
new
Error
(
"
iframe
.
contentWindow
is
undefined
cannot
send
message
(
something
is
wrong
with
the
test
that
called
this
)
.
"
)
)
;
return
;
}
window
.
addEventListener
(
"
message
"
function
messageListener
(
event
)
{
if
(
event
.
source
=
=
=
iframe
.
contentWindow
)
{
window
.
removeEventListener
(
"
message
"
messageListener
)
;
resolve
(
event
.
data
)
;
}
}
)
;
iframe
.
contentWindow
.
postMessage
(
data
"
*
"
)
;
}
)
;
}
export
function
loadIframe
(
iframe
url
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
iframe
.
addEventListener
(
"
load
"
(
)
=
>
resolve
(
)
{
once
:
true
}
)
;
iframe
.
addEventListener
(
"
error
"
(
event
)
=
>
reject
(
event
.
error
)
{
once
:
true
}
)
;
if
(
!
iframe
.
isConnected
)
{
document
.
body
.
appendChild
(
iframe
)
;
}
iframe
.
src
=
url
.
toString
(
)
;
}
)
;
}
