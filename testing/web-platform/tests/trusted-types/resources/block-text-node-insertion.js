'
use
strict
'
function
checkMessage
(
t
fn
expect_count
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
let
count
=
0
;
globalThis
.
addEventListener
(
"
message
"
function
handler
(
e
)
{
t
.
add_cleanup
(
(
)
=
>
{
globalThis
.
removeEventListener
(
"
message
"
handler
)
;
}
)
;
if
(
e
.
data
.
includes
(
"
block
"
)
)
{
reject
(
'
block
'
received
(
{
e
.
data
}
)
)
;
}
else
if
(
e
.
data
.
includes
(
"
count
"
)
)
{
count
=
count
+
1
;
}
else
if
(
e
.
data
.
includes
(
"
done
"
)
)
{
globalThis
.
removeEventListener
(
"
message
"
handler
)
;
if
(
expect_count
&
&
count
!
=
expect_count
)
{
reject
(
'
done
'
received
but
unexpected
counts
:
expected
{
expect_count
}
!
=
actual
{
count
}
(
{
e
.
data
}
)
)
;
}
else
{
resolve
(
e
.
data
)
;
}
}
else
{
reject
(
"
unexpected
message
received
:
"
+
e
.
data
)
;
}
}
)
;
fn
(
)
;
requestAnimationFrame
(
_
=
>
requestAnimationFrame
(
_
=
>
postMessage
(
"
done
"
"
*
"
)
)
)
;
}
)
;
}
