export
const
manifest_origin
=
"
https
:
/
/
{
{
host
}
}
:
{
{
ports
[
https
]
[
0
]
}
}
"
;
export
const
alt_manifest_origin
=
'
https
:
/
/
{
{
hosts
[
alt
]
[
]
}
}
:
{
{
ports
[
https
]
[
0
]
}
}
'
;
export
const
same_site_manifest_origin
=
'
https
:
/
/
{
{
hosts
[
]
[
www1
]
}
}
:
{
{
ports
[
https
]
[
0
]
}
}
'
;
export
const
default_manifest_path
=
'
/
fedcm
/
support
/
manifest
.
py
'
;
export
function
open_and_wait_for_popup
(
origin
path
)
{
return
new
Promise
(
resolve
=
>
{
let
popup_window
=
window
.
open
(
origin
+
path
)
;
const
popup_message_handler
=
(
event
)
=
>
{
if
(
new
URL
(
event
.
origin
)
.
toString
(
)
=
=
new
URL
(
origin
)
.
toString
(
)
)
{
popup_window
.
close
(
)
;
window
.
removeEventListener
(
'
message
'
popup_message_handler
)
;
resolve
(
)
;
}
}
;
window
.
addEventListener
(
'
message
'
popup_message_handler
)
;
}
)
;
}
export
function
set_fedcm_cookie
(
host
)
{
if
(
host
=
=
undefined
)
{
document
.
cookie
=
'
cookie
=
1
;
SameSite
=
None
;
Path
=
/
fedcm
/
support
;
Secure
'
;
return
Promise
.
resolve
(
)
;
}
else
{
return
open_and_wait_for_popup
(
host
'
/
fedcm
/
support
/
set_cookie
'
)
;
}
}
export
function
set_alt_fedcm_cookie
(
)
{
return
set_fedcm_cookie
(
alt_manifest_origin
)
;
}
export
function
setup_accounts_push
(
origin
=
manifest_origin
)
{
return
open_and_wait_for_popup
(
origin
'
/
fedcm
/
support
/
push_accounts
'
)
;
}
export
function
mark_signed_in
(
origin
=
manifest_origin
)
{
return
open_and_wait_for_popup
(
origin
'
/
fedcm
/
support
/
mark_signedin
'
)
;
}
export
function
mark_signed_out
(
origin
=
manifest_origin
)
{
return
open_and_wait_for_popup
(
origin
'
/
fedcm
/
support
/
mark_signedout
'
)
;
}
export
function
request_options_with_mediation_required
(
manifest_filename
origin
=
manifest_origin
)
{
if
(
manifest_filename
=
=
=
undefined
)
{
manifest_filename
=
"
manifest
.
py
"
;
}
const
manifest_path
=
{
origin
}
/
\
fedcm
/
support
/
{
manifest_filename
}
;
return
{
identity
:
{
providers
:
[
{
configURL
:
manifest_path
clientId
:
'
1
'
nonce
:
'
2
'
}
]
}
mediation
:
'
required
'
}
;
}
export
function
alt_request_options_with_mediation_required
(
manifest_filename
)
{
return
request_options_with_mediation_required
(
manifest_filename
alt_manifest_origin
)
;
}
export
function
request_options_with_mediation_optional
(
manifest_filename
)
{
let
options
=
alt_request_options_with_mediation_required
(
manifest_filename
)
;
options
.
identity
.
providers
[
0
]
.
clientId
=
'
123
'
;
options
.
mediation
=
'
optional
'
;
return
options
;
}
export
function
request_options_with_context
(
manifest_filename
context
)
{
if
(
manifest_filename
=
=
=
undefined
)
{
manifest_filename
=
"
manifest
.
py
"
;
}
const
manifest_path
=
{
manifest_origin
}
/
\
fedcm
/
support
/
{
manifest_filename
}
;
return
{
identity
:
{
providers
:
[
{
configURL
:
manifest_path
clientId
:
'
1
'
nonce
:
'
2
'
}
]
context
:
context
}
mediation
:
'
required
'
}
;
}
export
function
request_options_with_two_idps
(
mediation
=
'
required
'
)
{
const
first_config
=
{
manifest_origin
}
{
default_manifest_path
}
;
const
second_config
=
{
alt_manifest_origin
}
{
default_manifest_path
}
;
return
{
identity
:
{
providers
:
[
{
configURL
:
first_config
clientId
:
'
123
'
nonce
:
'
N1
'
}
{
configURL
:
second_config
clientId
:
'
456
'
nonce
:
'
N2
'
}
]
}
mediation
:
mediation
}
;
}
export
function
fedcm_test
(
test_func
test_name
)
{
promise_test
(
async
t
=
>
{
assert_implements
(
window
.
IdentityCredential
"
FedCM
is
not
supported
"
)
;
try
{
await
test_driver
.
set_fedcm_delay_enabled
(
false
)
;
}
catch
(
e
)
{
}
await
set_fedcm_cookie
(
)
;
await
set_alt_fedcm_cookie
(
)
;
await
test_func
(
t
)
;
}
test_name
)
;
}
function
select_manifest_impl
(
manifest_url
)
{
const
url_query
=
(
manifest_url
=
=
=
undefined
)
?
'
'
:
?
manifest_url
=
{
manifest_url
}
;
return
new
Promise
(
resolve
=
>
{
const
img
=
document
.
createElement
(
'
img
'
)
;
img
.
src
=
/
fedcm
/
support
/
select_manifest_in_root_manifest
.
py
{
url_query
}
;
img
.
addEventListener
(
'
error
'
resolve
)
;
document
.
body
.
appendChild
(
img
)
;
}
)
;
}
export
function
select_manifest
(
test
test_options
)
{
test
.
add_cleanup
(
async
(
)
=
>
{
await
select_manifest_impl
(
)
;
}
)
;
const
manifest_url
=
test_options
.
identity
.
providers
[
0
]
.
configURL
;
return
select_manifest_impl
(
manifest_url
)
;
}
export
function
request_options_with_login_hint
(
manifest_filename
login_hint
)
{
let
options
=
request_options_with_mediation_required
(
manifest_filename
)
;
options
.
identity
.
providers
[
0
]
.
loginHint
=
login_hint
;
return
options
;
}
export
function
request_options_with_domain_hint
(
manifest_filename
domain_hint
)
{
let
options
=
request_options_with_mediation_required
(
manifest_filename
)
;
options
.
identity
.
providers
[
0
]
.
domainHint
=
domain_hint
;
return
options
;
}
export
function
fedcm_get_dialog_type_promise
(
t
)
{
return
new
Promise
(
resolve
=
>
{
async
function
helper
(
)
{
try
{
const
type
=
await
window
.
test_driver
.
get_fedcm_dialog_type
(
)
;
resolve
(
type
)
;
}
catch
(
ex
)
{
t
.
step_timeout
(
helper
100
)
;
}
}
helper
(
)
;
}
)
;
}
export
async
function
fedcm_settles_without_dialog
(
t
cred_promise
)
{
let
dialog_promise
=
fedcm_get_dialog_type_promise
(
t
)
;
let
result
=
await
Promise
.
race
(
[
cred_promise
dialog_promise
]
)
;
if
(
result
instanceof
IdentityCredential
)
{
return
result
;
}
throw
"
expected
request
to
finish
got
dialog
:
"
+
result
;
}
export
async
function
fedcm_expect_dialog
(
cred_promise
other_promise
)
{
let
result
=
await
Promise
.
race
(
[
cred_promise
other_promise
]
)
;
if
(
result
instanceof
IdentityCredential
)
{
throw
"
did
not
expect
FedCM
request
to
finish
got
token
:
"
+
result
.
token
;
}
return
result
;
}
export
function
fedcm_get_title_promise
(
t
)
{
return
new
Promise
(
resolve
=
>
{
async
function
helper
(
)
{
try
{
const
title
=
await
window
.
test_driver
.
get_fedcm_dialog_title
(
)
;
resolve
(
title
)
;
}
catch
(
ex
)
{
t
.
step_timeout
(
helper
100
)
;
}
}
helper
(
)
;
}
)
;
}
export
async
function
fedcm_select_account_promise
(
t
account_index
)
{
let
type
=
await
fedcm_get_dialog_type_promise
(
t
)
;
if
(
type
!
=
"
AccountChooser
"
)
throw
"
Incorrect
dialog
type
:
"
+
type
;
await
window
.
test_driver
.
select_fedcm_account
(
account_index
)
;
}
export
async
function
fedcm_get_and_select_first_account
(
t
options
)
{
const
credentialPromise
=
navigator
.
credentials
.
get
(
options
)
;
let
type
=
await
fedcm_expect_dialog
(
credentialPromise
fedcm_get_dialog_type_promise
(
t
)
)
;
if
(
type
!
=
"
AccountChooser
"
)
throw
"
Incorrect
dialog
type
:
"
+
type
;
await
window
.
test_driver
.
select_fedcm_account
(
0
)
;
return
credentialPromise
;
}
export
function
fedcm_error_dialog_dismiss
(
t
)
{
return
new
Promise
(
resolve
=
>
{
async
function
helper
(
)
{
try
{
let
type
=
await
fedcm_get_dialog_type_promise
(
t
)
;
assert_equals
(
type
"
Error
"
)
;
await
window
.
test_driver
.
cancel_fedcm_dialog
(
)
;
resolve
(
)
;
}
catch
(
ex
)
{
t
.
step_timeout
(
helper
100
)
;
}
}
helper
(
)
;
}
)
;
}
export
function
fedcm_error_dialog_click_button
(
t
button
)
{
return
new
Promise
(
resolve
=
>
{
async
function
helper
(
)
{
try
{
let
type
=
await
fedcm_get_dialog_type_promise
(
t
)
;
assert_equals
(
type
"
Error
"
)
;
await
window
.
test_driver
.
click_fedcm_dialog_button
(
button
)
;
resolve
(
)
;
}
catch
(
ex
)
{
t
.
step_timeout
(
helper
100
)
;
}
}
helper
(
)
;
}
)
;
}
export
function
disconnect_options
(
accountHint
manifest_filename
)
{
if
(
manifest_filename
=
=
=
undefined
)
{
manifest_filename
=
"
manifest
.
py
"
;
}
const
manifest_path
=
{
manifest_origin
}
/
\
fedcm
/
support
/
{
manifest_filename
}
;
return
{
configURL
:
manifest_path
clientId
:
'
1
'
accountHint
:
accountHint
}
;
}
export
function
alt_disconnect_options
(
accountHint
manifest_filename
)
{
if
(
manifest_filename
=
=
=
undefined
)
{
manifest_filename
=
"
manifest
.
py
"
;
}
const
manifest_path
=
{
alt_manifest_origin
}
/
\
fedcm
/
support
/
{
manifest_filename
}
;
return
{
configURL
:
manifest_path
clientId
:
'
1
'
accountHint
:
accountHint
}
;
}
