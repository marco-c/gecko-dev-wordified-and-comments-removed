"
use
strict
"
;
var
smallPayloadSize
=
10
;
var
mediumPayloadSize
=
10000
;
var
largePayloadSize
=
50000
;
var
maxPayloadSize
=
65536
;
var
smallPayload
=
smallPayloadSize
+
"
:
"
+
Array
(
smallPayloadSize
)
.
fill
(
'
*
'
)
.
join
(
"
"
)
;
var
mediumPayload
=
mediumPayloadSize
+
"
:
"
+
Array
(
mediumPayloadSize
)
.
fill
(
'
*
'
)
.
join
(
"
"
)
;
var
largePayload
=
largePayloadSize
+
"
:
"
+
Array
(
largePayloadSize
)
.
fill
(
'
*
'
)
.
join
(
"
"
)
;
var
maxPayload
=
(
maxPayloadSize
-
6
)
+
"
:
"
+
Array
(
maxPayloadSize
-
6
)
.
fill
(
'
*
'
)
.
join
(
"
"
)
var
noDataTest
=
{
id
:
"
NoData
"
}
;
var
nullDataTest
=
{
id
:
"
NullData
"
data
:
null
}
;
var
undefinedDataTest
=
{
id
:
"
UndefinedData
"
data
:
undefined
}
;
var
smallStringTest
=
{
id
:
"
SmallString
"
data
:
smallPayload
}
;
var
mediumStringTest
=
{
id
:
"
MediumString
"
data
:
mediumPayload
}
;
var
largeStringTest
=
{
id
:
"
LargeString
"
data
:
largePayload
}
;
var
maxStringTest
=
{
id
:
"
MaxString
"
data
:
maxPayload
}
;
var
emptyBlobTest
=
{
id
:
"
EmptyBlob
"
data
:
new
Blob
(
)
}
;
var
smallBlobTest
=
{
id
:
"
SmallBlob
"
data
:
new
Blob
(
[
smallPayload
]
)
}
;
var
mediumBlobTest
=
{
id
:
"
MediumBlob
"
data
:
new
Blob
(
[
mediumPayload
]
)
}
;
var
largeBlobTest
=
{
id
:
"
LargeBlob
"
data
:
new
Blob
(
[
largePayload
]
)
}
;
var
maxBlobTest
=
{
id
:
"
MaxBlob
"
data
:
new
Blob
(
[
maxPayload
]
)
}
;
var
emptyBufferSourceTest
=
{
id
:
"
EmptyBufferSource
"
data
:
new
Uint8Array
(
)
}
;
var
smallBufferSourceTest
=
{
id
:
"
SmallBufferSource
"
data
:
CreateArrayBufferFromPayload
(
smallPayload
)
}
;
var
mediumBufferSourceTest
=
{
id
:
"
MediumBufferSource
"
data
:
CreateArrayBufferFromPayload
(
mediumPayload
)
}
;
var
largeBufferSourceTest
=
{
id
:
"
LargeBufferSource
"
data
:
CreateArrayBufferFromPayload
(
largePayload
)
}
;
var
maxBufferSourceTest
=
{
id
:
"
MaxBufferSource
"
data
:
CreateArrayBufferFromPayload
(
maxPayload
)
}
;
var
emptyFormDataTest
=
{
id
:
"
EmptyFormData
"
data
:
CreateEmptyFormDataPayload
(
)
}
;
var
smallFormDataTest
=
{
id
:
"
SmallFormData
"
data
:
CreateFormDataFromPayload
(
smallPayload
)
}
;
var
mediumFormDataTest
=
{
id
:
"
MediumFormData
"
data
:
CreateFormDataFromPayload
(
mediumPayload
)
}
;
var
largeFormDataTest
=
{
id
:
"
LargeFormData
"
data
:
CreateFormDataFromPayload
(
largePayload
)
}
;
var
smallSafeContentTypeEncodedTest
=
{
id
:
"
SmallSafeContentTypeEncoded
"
data
:
new
Blob
(
[
smallPayload
]
{
type
:
'
application
/
x
-
www
-
form
-
urlencoded
'
}
)
}
;
var
smallSafeContentTypeFormTest
=
{
id
:
"
SmallSafeContentTypeForm
"
data
:
new
FormData
(
)
}
;
var
smallSafeContentTypeTextTest
=
{
id
:
"
SmallSafeContentTypeText
"
data
:
new
Blob
(
[
smallPayload
]
{
type
:
'
text
/
plain
'
}
)
}
;
var
smallCORSContentTypeTextTest
=
{
id
:
"
SmallCORSContentTypeText
"
data
:
new
Blob
(
[
smallPayload
]
{
type
:
'
text
/
html
'
}
)
}
;
var
stringTests
=
[
noDataTest
nullDataTest
undefinedDataTest
smallStringTest
mediumStringTest
largeStringTest
]
;
var
stringMaxTest
=
[
maxStringTest
]
;
var
blobTests
=
[
emptyBlobTest
smallBlobTest
mediumBlobTest
largeBlobTest
]
;
var
blobMaxTest
=
[
maxBlobTest
]
;
var
bufferSourceTests
=
[
emptyBufferSourceTest
smallBufferSourceTest
mediumBufferSourceTest
largeBufferSourceTest
]
;
var
bufferSourceMaxTest
=
[
maxBufferSourceTest
]
;
var
formDataTests
=
[
emptyFormDataTest
smallFormDataTest
mediumFormDataTest
largeFormDataTest
]
;
var
formDataMaxTest
=
[
largeFormDataTest
]
;
var
allTests
=
[
]
.
concat
(
stringTests
stringMaxTest
blobTests
blobMaxTest
bufferSourceTests
bufferSourceMaxTest
formDataTests
formDataMaxTest
)
;
var
sampleTests
=
[
noDataTest
nullDataTest
undefinedDataTest
smallStringTest
smallBlobTest
smallBufferSourceTest
smallFormDataTest
smallSafeContentTypeEncodedTest
smallSafeContentTypeFormTest
smallSafeContentTypeTextTest
]
;
var
preflightTests
=
[
smallCORSContentTypeTextTest
]
;
var
testLookup
=
{
}
;
allTests
.
forEach
(
function
(
testCase
)
{
testLookup
[
testCase
.
id
]
=
testCase
;
}
)
;
function
CreateArrayBufferFromPayload
(
payload
)
{
var
length
=
payload
.
length
;
var
buffer
=
new
Uint8Array
(
length
)
;
for
(
var
i
=
0
;
i
<
length
;
i
+
+
)
{
buffer
[
i
]
=
payload
.
charCodeAt
(
i
)
;
}
return
buffer
;
}
function
CreateEmptyFormDataPayload
(
)
{
if
(
self
.
document
=
=
=
undefined
)
{
return
null
;
}
return
new
FormData
(
)
;
}
function
CreateFormDataFromPayload
(
payload
)
{
if
(
self
.
document
=
=
=
undefined
)
{
return
null
;
}
var
formData
=
new
FormData
(
)
;
formData
.
append
(
"
payload
"
payload
)
;
return
formData
;
}
function
initSession
(
testCases
)
{
return
{
id
:
self
.
token
(
)
testCaseLookup
:
{
}
testCases
:
[
]
totalCount
:
testCases
.
length
sentCount
:
0
doneCount
:
0
add
:
function
add
(
testCase
)
{
this
.
testCases
.
push
(
testCase
)
;
this
.
testCaseLookup
[
testCase
.
id
]
=
testCase
;
}
}
;
}
function
runTests
(
testCases
)
{
var
session
=
initSession
(
testCases
)
;
testCases
.
forEach
(
function
(
testCase
testIndex
)
{
var
testCaseCopy
=
Object
.
assign
(
{
session
:
session
}
testCase
)
;
var
testId
=
testCase
.
id
;
if
(
self
.
buildId
)
{
testId
=
self
.
buildId
(
testId
)
;
}
testCaseCopy
.
origId
=
testCaseCopy
.
id
;
testCaseCopy
.
id
=
testId
;
testCaseCopy
.
index
=
testIndex
;
session
.
add
(
testCaseCopy
)
;
async_test
(
function
(
test
)
{
testCaseCopy
.
test
=
test
;
var
baseUrl
=
"
http
:
/
/
{
{
host
}
}
:
{
{
ports
[
http
]
[
0
]
}
}
"
;
if
(
self
.
buildBaseUrl
)
{
baseUrl
=
self
.
buildBaseUrl
(
baseUrl
)
;
}
var
targetUrl
=
{
baseUrl
}
/
beacon
/
resources
/
beacon
.
py
?
cmd
=
store
&
sid
=
{
session
.
id
}
&
tid
=
{
testId
}
&
tidx
=
{
testIndex
}
;
if
(
self
.
buildTargetUrl
)
{
targetUrl
=
self
.
buildTargetUrl
(
targetUrl
)
;
}
testCaseCopy
.
url
=
targetUrl
;
var
sendFunc
=
test
.
step_func
(
function
sendImmediately
(
testCase
)
{
var
sendResult
=
sendData
(
testCase
)
;
continueAfterSendingBeacon
(
sendResult
testCase
)
;
}
)
;
if
(
self
.
sendFunc
)
{
sendFunc
=
test
.
step_func
(
self
.
sendFunc
)
;
}
sendFunc
(
testCaseCopy
)
;
}
Verify
'
navigator
.
sendbeacon
(
)
'
successfully
sends
for
variant
:
{
testCaseCopy
.
id
}
)
;
}
)
;
}
function
sendData
(
testCase
)
{
var
sent
=
false
;
if
(
testCase
.
data
)
{
sent
=
self
.
navigator
.
sendBeacon
(
testCase
.
url
testCase
.
data
)
;
}
else
{
sent
=
self
.
navigator
.
sendBeacon
(
testCase
.
url
)
}
return
sent
;
}
function
continueAfterSendingBeacon
(
sendResult
testCase
)
{
var
session
=
testCase
.
session
;
if
(
sendResult
)
{
session
.
sentCount
+
+
;
}
else
{
session
.
totalCount
-
-
;
}
if
(
session
.
sentCount
=
=
session
.
totalCount
)
{
step_timeout
(
waitForResults
.
bind
(
this
session
)
0
)
;
}
assert_true
(
sendResult
"
'
sendbeacon
'
function
call
must
succeed
"
)
;
}
function
waitForResults
(
session
)
{
fetch
(
resources
/
beacon
.
py
?
cmd
=
stat
&
sid
=
{
session
.
id
}
&
tidx_min
=
0
&
tidx_max
=
{
session
.
totalCount
-
1
}
)
.
then
(
function
(
response
)
{
response
.
text
(
)
.
then
(
function
(
rawResponse
)
{
var
results
;
var
failure
;
try
{
results
=
JSON
.
parse
(
rawResponse
)
;
if
(
results
.
length
=
=
=
undefined
)
{
failure
=
bad
validation
response
schema
:
rawResponse
=
'
{
rawResponse
}
'
;
}
}
catch
(
e
)
{
failure
=
bad
validation
response
:
rawResponse
=
'
{
rawResponse
}
'
got
parse
error
'
{
e
}
'
;
}
if
(
failure
)
{
failSession
(
session
failure
)
;
return
;
}
results
.
forEach
(
function
(
result
)
{
var
testCase
=
session
.
testCaseLookup
[
result
.
id
]
;
if
(
!
testCase
.
done
)
{
testCase
.
done
=
true
;
session
.
doneCount
+
+
;
}
var
test
=
testCase
.
test
;
test
.
step
(
function
(
)
{
assert_equals
(
result
.
error
null
"
'
sendbeacon
'
data
must
not
fail
validation
"
)
;
}
)
;
test
.
done
(
)
;
}
)
;
if
(
session
.
doneCount
<
session
.
sentCount
)
{
step_timeout
(
waitForResults
.
bind
(
this
session
)
100
)
;
}
}
)
.
catch
(
function
(
error
)
{
failSession
(
session
unexpected
error
reading
response
error
=
'
{
error
}
'
)
;
}
)
;
}
)
;
}
function
failSession
(
session
reason
)
{
session
.
testCases
.
forEach
(
function
(
testCase
)
{
var
test
=
testCase
.
test
;
test
.
unreached_func
(
reason
)
(
)
;
}
)
;
}
function
runSendInIframeAndNavigateTests
(
funcName
)
{
var
iframe
=
document
.
createElement
(
"
iframe
"
)
;
iframe
.
id
=
"
iframe
"
;
iframe
.
onload
=
function
(
)
{
var
tests
=
Array
(
)
;
this
.
onload
=
null
;
self
.
buildId
=
function
(
baseId
)
{
return
{
baseId
}
-
{
funcName
}
-
NAVIGATE
;
}
;
window
.
onmessage
=
function
(
e
)
{
var
testCase
=
tests
[
e
.
data
]
;
continueAfterSendingBeacon
(
true
testCase
)
;
}
;
self
.
sendFunc
=
function
(
testCase
)
{
var
iframeWindow
=
document
.
getElementById
(
"
iframe
"
)
.
contentWindow
;
tests
[
testCase
.
origId
]
=
testCase
;
iframeWindow
.
postMessage
(
[
testCase
.
origId
testCase
.
url
funcName
]
"
*
"
)
;
}
;
runTests
(
sampleTests
)
;
}
;
iframe
.
src
=
"
navigate
.
iFrame
.
sub
.
html
"
;
document
.
body
.
appendChild
(
iframe
)
;
}
