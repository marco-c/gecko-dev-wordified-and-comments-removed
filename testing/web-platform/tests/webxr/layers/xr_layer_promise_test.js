'
use
strict
'
;
function
xr_layer_promise_test
(
name
func
fakeDeviceInit
sessionMode
sessionInit
properties
glcontextPropertiesParam
)
{
const
glcontextProperties
=
(
glcontextPropertiesParam
)
?
glcontextPropertiesParam
:
{
}
;
function
runTest
(
t
glContext
)
{
let
testSession
;
let
testDeviceController
;
let
sessionObjects
=
{
gl
:
glContext
}
;
t
.
add_cleanup
(
async
(
)
=
>
{
if
(
testSession
)
{
await
testSession
.
end
(
)
.
catch
(
(
)
=
>
{
}
)
;
}
}
)
;
return
navigator
.
xr
.
test
.
simulateDeviceConnection
(
fakeDeviceInit
)
.
then
(
(
controller
)
=
>
{
testDeviceController
=
controller
;
return
sessionObjects
.
gl
.
makeXRCompatible
(
)
;
}
)
.
then
(
(
)
=
>
new
Promise
(
(
resolve
reject
)
=
>
{
xr_debug
(
name
'
simulateUserActivation
'
)
;
navigator
.
xr
.
test
.
simulateUserActivation
(
(
)
=
>
{
xr_debug
(
name
'
document
.
hasFocus
(
)
=
'
+
document
.
hasFocus
(
)
)
;
navigator
.
xr
.
requestSession
(
sessionMode
sessionInit
|
|
{
}
)
.
then
(
async
(
session
)
=
>
{
xr_debug
(
name
'
session
start
'
)
;
testSession
=
session
;
session
.
mode
=
sessionMode
;
session
.
sessionInit
=
sessionInit
;
sessionObjects
.
xrBinding
=
new
XRWebGLBinding
(
session
sessionObjects
.
gl
)
;
sessionObjects
.
xrSpace
=
await
session
.
requestReferenceSpace
(
'
local
'
)
;
if
(
!
sessionObjects
.
xrSpace
)
{
reject
(
"
Local
space
is
required
for
layers
test
.
"
)
;
return
;
}
xr_debug
(
name
'
session
.
visibilityState
=
'
+
session
.
visibilityState
)
;
try
{
resolve
(
func
(
session
testDeviceController
t
sessionObjects
)
)
;
}
catch
(
err
)
{
reject
(
"
Test
function
failed
with
:
"
+
err
)
;
}
}
)
.
catch
(
(
err
)
=
>
{
xr_debug
(
name
'
error
:
'
+
err
)
;
reject
(
'
Session
with
params
'
+
JSON
.
stringify
(
sessionMode
)
+
'
was
rejected
on
device
'
+
JSON
.
stringify
(
fakeDeviceInit
)
+
'
with
error
:
'
+
err
)
;
}
)
;
}
)
;
}
)
)
;
}
xr_promise_test
(
name
+
'
-
webgl
'
runTest
properties
'
webgl
'
{
alpha
:
false
antialias
:
false
.
.
.
glcontextProperties
}
)
;
xr_promise_test
(
name
+
'
-
webgl2
'
runTest
properties
'
webgl2
'
{
alpha
:
false
antialias
:
false
.
.
.
glcontextProperties
}
)
;
}
