'
use
strict
'
;
const
statsValidatorTable
=
{
'
codec
'
:
validateCodecStats
'
inbound
-
rtp
'
:
validateInboundRtpStreamStats
'
outbound
-
rtp
'
:
validateOutboundRtpStreamStats
'
remote
-
inbound
-
rtp
'
:
validateRemoteInboundRtpStreamStats
'
remote
-
outbound
-
rtp
'
:
validateRemoteOutboundRtpStreamStats
'
csrc
'
:
validateContributingSourceStats
'
peer
-
connection
'
:
validatePeerConnectionStats
'
data
-
channel
'
:
validateDataChannelStats
'
stream
'
:
validateMediaStreamStats
'
track
'
:
validateMediaStreamTrackStats
'
transport
'
:
validateTransportStats
'
candidate
-
pair
'
:
validateIceCandidatePairStats
'
local
-
candidate
'
:
validateIceCandidateStats
'
remote
-
candidate
'
:
validateIceCandidateStats
'
certificate
'
:
validateCertificateStats
}
;
function
validateStatsReport
(
statsReport
)
{
for
(
const
[
id
stats
]
of
statsReport
.
entries
(
)
)
{
assert_equals
(
stats
.
id
id
'
expect
stats
.
id
to
be
the
same
as
the
key
in
statsReport
'
)
;
const
validator
=
statsValidatorTable
[
stats
.
type
]
;
if
(
validator
)
{
validator
(
statsReport
stats
)
;
}
else
{
validateRtcStats
(
statsReport
stats
)
;
}
}
}
function
assert_stats_report_has_stats
(
statsReport
statsTypes
)
{
const
hasTypes
=
new
Set
(
[
.
.
.
statsReport
.
values
(
)
]
.
map
(
stats
=
>
stats
.
type
)
)
;
for
(
const
type
of
statsTypes
)
{
assert_true
(
hasTypes
.
has
(
type
)
Expect
statsReport
to
contain
stats
object
of
type
{
type
}
)
;
}
}
function
findStatsFromReport
(
statsReport
predicate
message
)
{
for
(
const
stats
of
statsReport
.
values
(
)
)
{
if
(
predicate
(
stats
)
)
{
return
stats
;
}
}
assert_unreached
(
message
|
|
'
none
of
stats
in
statsReport
satisfy
given
condition
'
)
}
function
getRequiredStats
(
statsReport
type
)
{
for
(
const
stats
of
statsReport
.
values
(
)
)
{
if
(
stats
.
type
=
=
=
type
)
{
return
stats
;
}
}
assert_unreached
(
required
stats
of
type
{
type
}
is
not
found
in
stats
report
)
;
}
function
getStatsById
(
statsReport
statsId
)
{
assert_true
(
statsReport
.
has
(
statsId
)
Expect
stats
report
to
have
stats
object
with
id
{
statsId
}
)
;
return
statsReport
.
get
(
statsId
)
;
}
function
validateIdField
(
statsReport
stats
field
type
)
{
assert_string_field
(
stats
field
)
;
const
linkedStats
=
getStatsById
(
statsReport
stats
[
field
]
)
;
assert_equals
(
linkedStats
.
type
type
Expect
linked
stats
object
to
have
type
{
type
}
)
;
}
function
validateOptionalIdField
(
statsReport
stats
field
type
)
{
if
(
stats
[
field
]
!
=
=
undefined
)
{
validateIdField
(
statsReport
stats
field
type
)
;
}
}
function
validateRtcStats
(
statsReport
stats
)
{
assert_number_field
(
stats
'
timestamp
'
)
;
assert_string_field
(
stats
'
type
'
)
;
assert_string_field
(
stats
'
id
'
)
;
}
function
validateRtpStreamStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_unsigned_int_field
(
stats
'
ssrc
'
)
;
assert_string_field
(
stats
'
mediaType
'
)
;
assert_enum_field
(
stats
'
mediaType
'
[
'
audio
'
'
video
'
]
)
validateIdField
(
statsReport
stats
'
trackId
'
'
track
'
)
;
validateIdField
(
statsReport
stats
'
transportId
'
'
transport
'
)
;
validateIdField
(
statsReport
stats
'
codecId
'
'
codec
'
)
;
assert_optional_unsigned_int_field
(
stats
'
firCount
'
)
;
assert_optional_unsigned_int_field
(
stats
'
pliCount
'
)
;
assert_optional_unsigned_int_field
(
stats
'
nackCount
'
)
;
assert_optional_unsigned_int_field
(
stats
'
sliCount
'
)
;
assert_optional_unsigned_int_field
(
stats
'
qpSum
'
)
;
}
function
validateCodecStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_unsigned_int_field
(
stats
'
payloadType
'
)
;
assert_optional_enum_field
(
stats
'
codecType
'
[
'
encode
'
'
decode
'
]
)
;
validateOptionalIdField
(
statsReport
stats
'
transportId
'
'
transport
'
)
;
assert_optional_string_field
(
stats
'
mimeType
'
)
;
assert_unsigned_int_field
(
stats
'
clockRate
'
)
;
assert_optional_unsigned_int_field
(
stats
'
channels
'
)
;
assert_optional_string_field
(
stats
'
sdpFmtpLine
'
)
;
assert_optional_string_field
(
stats
'
implementation
'
)
;
}
function
validateReceivedRtpStreamStats
(
statsReport
stats
)
{
validateRtpStreamStats
(
statsReport
stats
)
;
assert_unsigned_int_field
(
stats
'
packetsReceived
'
)
;
assert_unsigned_int_field
(
stats
'
bytesReceived
'
)
;
assert_unsigned_int_field
(
stats
'
packetsLost
'
)
;
assert_number_field
(
stats
'
jitter
'
)
;
assert_optional_number_field
(
stats
'
fractionLost
'
)
;
assert_unsigned_int_field
(
stats
'
packetsDiscarded
'
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsFailedDecryption
'
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsRepaired
'
)
;
assert_optional_unsigned_int_field
(
stats
'
burstPacketsLost
'
)
;
assert_optional_unsigned_int_field
(
stats
'
burstPacketsDiscarded
'
)
;
assert_optional_unsigned_int_field
(
stats
'
burstLossCount
'
)
;
assert_optional_unsigned_int_field
(
stats
'
burstDiscardCount
'
)
;
assert_optional_number_field
(
stats
'
burstLossRate
'
)
;
assert_optional_number_field
(
stats
'
burstDiscardRate
'
)
;
assert_optional_number_field
(
stats
'
gapLossRate
'
)
;
assert_optional_number_field
(
stats
'
gapDiscardRate
'
)
;
}
function
validateInboundRtpStreamStats
(
statsReport
stats
)
{
validateReceivedRtpStreamStats
(
statsReport
stats
)
;
validateIdField
(
statsReport
stats
'
remoteId
'
'
remote
-
outbound
-
rtp
'
)
;
assert_unsigned_int_field
(
stats
'
framesDecoded
'
)
;
assert_optional_number_field
(
stats
'
lastPacketReceivedTimeStamp
'
)
;
}
function
validateRemoteInboundRtpStreamStats
(
statsReport
stats
)
{
validateReceivedRtpStreamStats
(
statsReport
stats
)
;
validateIdField
(
statsReport
stats
'
localId
'
'
outbound
-
rtp
'
)
;
assert_number_field
(
stats
'
roundTripTime
'
)
;
}
function
validateSentRtpStreamStats
(
statsReport
stats
)
{
validateRtpStreamStats
(
statsReport
stats
)
;
assert_unsigned_int_field
(
stats
'
packetsSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsDiscardedOnSend
'
)
;
assert_unsigned_int_field
(
stats
'
bytesSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
bytesDiscardedOnSend
'
)
;
}
function
validateOutboundRtpStreamStats
(
statsReport
stats
)
{
validateSentRtpStreamStats
(
statsReport
stats
)
validateIdField
(
statsReport
stats
'
remoteId
'
'
remote
-
inbound
-
rtp
'
)
;
assert_optional_number_field
(
stats
'
lastPacketSentTimestamp
'
)
;
assert_optional_number_field
(
stats
'
targetBitrate
'
)
;
if
(
stats
[
'
mediaType
'
]
=
=
'
video
'
)
{
assert_unsigned_int_field
(
stats
'
framesEncoded
'
)
;
}
assert_optional_number_field
(
stats
'
totalEncodeTime
'
)
;
assert_optional_number_field
(
stats
'
averageRTCPInterval
'
)
;
}
function
validateRemoteOutboundRtpStreamStats
(
statsReport
stats
)
{
validateSentRtpStreamStats
(
statsReport
stats
)
;
validateIdField
(
statsReport
stats
'
localId
'
'
inbound
-
rtp
'
)
;
assert_number_field
(
stats
'
remoteTimeStamp
'
)
;
}
function
validateContributingSourceStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_optional_unsigned_int_field
(
stats
'
contributorSsrc
'
)
;
validateOptionalIdField
(
statsReport
stats
'
inboundRtpStreamId
'
'
inbound
-
rtp
'
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsContributedTo
'
)
;
assert_optional_number_field
(
stats
'
audioLevel
'
)
;
}
function
validatePeerConnectionStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_unsigned_int_field
(
stats
'
dataChannelsOpened
'
)
;
assert_unsigned_int_field
(
stats
'
dataChannelsClosed
'
)
;
assert_optional_unsigned_int_field
(
stats
'
dataChannelsRequested
'
)
;
assert_optional_unsigned_int_field
(
stats
'
dataChannelsAccepted
'
)
;
}
function
validateMediaStreamStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_string_field
(
stats
'
streamIdentifier
'
)
;
assert_array_field
(
stats
'
trackIds
'
)
;
for
(
const
trackId
of
stats
.
trackIds
)
{
assert_equals
(
typeof
trackId
'
string
'
'
Expect
trackId
elements
to
be
string
'
)
;
assert_true
(
statsReport
.
has
(
trackId
)
Expect
stats
report
to
have
stats
object
with
id
{
trackId
}
)
;
const
trackStats
=
statsReport
.
get
(
trackId
)
;
assert_equals
(
trackStats
.
type
'
track
'
Expect
track
stats
object
to
have
type
'
track
'
)
;
}
}
function
validateMediaStreamTrackStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_string_field
(
stats
'
trackIdentifier
'
)
;
assert_boolean_field
(
stats
'
remoteSource
'
)
;
assert_boolean_field
(
stats
'
ended
'
)
;
assert_boolean_field
(
stats
'
detached
'
)
;
assert_optional_enum_field
(
stats
'
kind
'
[
'
audio
'
'
video
'
]
)
;
assert_optional_number_field
(
stats
'
estimatedPlayoutTimestamp
'
)
;
if
(
stats
[
'
kind
'
]
=
=
=
'
video
'
)
{
assert_unsigned_int_field
(
stats
'
frameWidth
'
)
;
assert_unsigned_int_field
(
stats
'
frameHeight
'
)
;
assert_number_field
(
stats
'
framesPerSecond
'
)
;
if
(
stats
[
'
framesSent
'
]
)
{
assert_optional_unsigned_int_field
(
stats
'
framesCaptured
'
)
;
assert_unsigned_int_field
(
stats
'
framesSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
keyFramesSent
'
)
;
}
else
{
assert_unsigned_int_field
(
stats
'
framesReceived
'
)
;
assert_optional_unsigned_int_field
(
stats
'
keyFramesReceived
'
)
;
assert_unsigned_int_field
(
stats
'
framesDecoded
'
)
;
assert_unsigned_int_field
(
stats
'
framesDropped
'
)
;
assert_unsigned_int_field
(
stats
'
framesCorrupted
'
)
;
}
assert_optional_unsigned_int_field
(
stats
'
partialFramesLost
'
)
;
assert_optional_unsigned_int_field
(
stats
'
fullFramesLost
'
)
;
}
else
{
if
(
stats
[
'
remoteSource
'
]
)
{
assert_number_field
(
stats
'
audioLevel
'
)
;
assert_optional_number_field
(
stats
'
totalAudioEnergy
'
)
;
assert_optional_number_field
(
stats
'
totalSamplesDuration
'
)
;
}
assert_optional_boolean_field
(
stats
'
voiceActivityFlag
'
)
;
assert_optional_number_field
(
stats
'
echoReturnLoss
'
)
;
assert_optional_number_field
(
stats
'
echoReturnLossEnhancement
'
)
;
assert_optional_unsigned_int_field
(
stats
'
totalSamplesSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
totalSamplesReceived
'
)
;
assert_optional_unsigned_int_field
(
stats
'
concealedSamples
'
)
;
assert_optional_unsigned_int_field
(
stats
'
concealmentEvents
'
)
;
assert_optional_number_field
(
stats
'
jitterBufferDelay
'
)
;
}
assert_optional_enum_field
(
stats
'
priority
'
[
'
very
-
low
'
'
low
'
'
medium
'
'
high
'
]
)
;
}
function
validateDataChannelStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_string_field
(
stats
'
label
'
)
;
assert_string_field
(
stats
'
protocol
'
)
;
assert_int_field
(
stats
'
dataChannelIdentifier
'
)
;
validateOptionalIdField
(
statsReport
stats
'
transportId
'
'
transport
'
)
;
assert_enum_field
(
stats
'
state
'
[
'
connecting
'
'
open
'
'
closing
'
'
closed
'
]
)
;
assert_unsigned_int_field
(
stats
'
messagesSent
'
)
;
assert_unsigned_int_field
(
stats
'
bytesSent
'
)
;
assert_unsigned_int_field
(
stats
'
messagesReceived
'
)
;
assert_unsigned_int_field
(
stats
'
bytesReceived
'
)
;
}
function
validateTransportStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsReceived
'
)
;
assert_unsigned_int_field
(
stats
'
bytesSent
'
)
;
assert_unsigned_int_field
(
stats
'
bytesReceived
'
)
;
validateOptionalIdField
(
statsReport
stats
'
rtcpTransportStatsId
'
'
transport
'
)
;
assert_optional_enum_field
(
stats
'
iceRole
'
[
'
controlling
'
'
controlled
'
]
)
;
assert_optional_enum_field
(
stats
'
dtlsState
'
[
'
new
'
'
connecting
'
'
connected
'
'
closed
'
'
failed
'
]
)
;
validateIdField
(
statsReport
stats
'
selectedCandidatePairId
'
'
candidate
-
pair
'
)
;
validateIdField
(
statsReport
stats
'
localCertificateId
'
'
certificate
'
)
;
validateIdField
(
statsReport
stats
'
remoteCertificateId
'
'
certificate
'
)
;
}
function
validateIceCandidateStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
validateOptionalIdField
(
statsReport
stats
'
transportId
'
'
transport
'
)
;
assert_optional_boolean_field
(
stats
'
isRemote
'
)
;
assert_optional_enum_field
(
stats
'
networkType
'
[
'
bluetooth
'
'
cellular
'
'
ethernet
'
'
wifi
'
'
wimax
'
'
vpn
'
'
unknown
'
]
)
assert_string_field
(
stats
'
ip
'
)
;
assert_int_field
(
stats
'
port
'
)
;
assert_string_field
(
stats
'
protocol
'
)
;
assert_enum_field
(
stats
'
candidateType
'
[
'
host
'
'
srflx
'
'
prflx
'
'
relay
'
]
)
;
assert_int_field
(
stats
'
priority
'
)
;
assert_optional_string_field
(
stats
'
url
'
)
;
assert_optional_string_field
(
stats
'
relayProtocol
'
)
;
assert_optional_boolean_field
(
stats
'
deleted
'
)
;
}
function
validateIceCandidatePairStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
validateIdField
(
statsReport
stats
'
transportId
'
'
transport
'
)
;
validateIdField
(
statsReport
stats
'
localCandidateId
'
'
local
-
candidate
'
)
;
validateIdField
(
statsReport
stats
'
remoteCandidateId
'
'
remote
-
candidate
'
)
;
assert_enum_field
(
stats
'
state
'
[
'
frozen
'
'
waiting
'
'
in
-
progress
'
'
failed
'
'
succeeded
'
]
)
;
assert_unsigned_int_field
(
stats
'
priority
'
)
;
assert_boolean_field
(
stats
'
nominated
'
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
packetsReceived
'
)
;
assert_unsigned_int_field
(
stats
'
bytesSent
'
)
;
assert_unsigned_int_field
(
stats
'
bytesReceived
'
)
;
assert_optional_number_field
(
stats
'
lastPacketSentTimestamp
'
)
;
assert_optional_number_field
(
stats
'
lastPacketReceivedTimestamp
'
)
;
assert_optional_number_field
(
stats
'
firstRequestTimestamp
'
)
;
assert_optional_number_field
(
stats
'
lastRequestTimestamp
'
)
;
assert_optional_number_field
(
stats
'
lastResponseTimestamp
'
)
;
assert_number_field
(
stats
'
totalRoundTripTime
'
)
;
assert_number_field
(
stats
'
currentRoundTripTime
'
)
;
assert_optional_number_field
(
stats
'
availableOutgoingBitrate
'
)
;
assert_optional_number_field
(
stats
'
availableIncomingBitrate
'
)
;
assert_optional_unsigned_int_field
(
stats
'
circuitBreakerTriggerCount
'
)
;
assert_optional_unsigned_int_field
(
stats
'
requestsReceived
'
)
;
assert_optional_unsigned_int_field
(
stats
'
requestsSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
responsesReceived
'
)
;
assert_optional_unsigned_int_field
(
stats
'
responsesSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
retransmissionsReceived
'
)
;
assert_optional_unsigned_int_field
(
stats
'
retransmissionsSent
'
)
;
assert_optional_unsigned_int_field
(
stats
'
consentRequestsSent
'
)
;
assert_optional_number_field
(
stats
'
consentExpiredTimestamp
'
)
;
}
function
validateCertificateStats
(
statsReport
stats
)
{
validateRtcStats
(
statsReport
stats
)
;
assert_string_field
(
stats
'
fingerprint
'
)
;
assert_string_field
(
stats
'
fingerprintAlgorithm
'
)
;
assert_string_field
(
stats
'
base64Certificate
'
)
;
assert_optional_string_field
(
stats
'
issuerCertificateId
'
)
;
}
