async
function
openWebSocket
(
remoteContextHelper
)
{
let
return_value
=
await
remoteContextHelper
.
executeScript
(
(
domain
)
=
>
{
return
new
Promise
(
(
resolve
)
=
>
{
var
webSocketInNotRestoredReasonsTests
=
new
WebSocket
(
domain
+
'
/
echo
'
)
;
webSocketInNotRestoredReasonsTests
.
onopen
=
(
)
=
>
{
resolve
(
42
)
;
}
;
}
)
;
}
[
SCHEME_DOMAIN_PORT
]
)
;
assert_equals
(
return_value
42
)
;
}
async
function
openThenCloseWebSocket
(
remoteContextHelper
)
{
let
return_value
=
await
remoteContextHelper
.
executeScript
(
(
domain
)
=
>
{
return
new
Promise
(
(
resolve
)
=
>
{
var
testWebSocket
=
new
WebSocket
(
domain
+
'
/
echo
'
)
;
testWebSocket
.
onopen
=
(
)
=
>
{
testWebSocket
.
close
(
)
}
;
testWebSocket
.
onclose
=
(
)
=
>
{
resolve
(
42
)
}
;
}
)
;
}
[
SCHEME_DOMAIN_PORT
]
)
;
assert_equals
(
return_value
42
)
;
}
async
function
openWebSocketAndCloseItInPageHide
(
remoteContextHelper
)
{
window
.
wsErrorOccurred
=
false
;
window
.
wsCloseOccurred
=
false
;
let
return_value
=
await
remoteContextHelper
.
executeScript
(
(
domain
)
=
>
{
return
new
Promise
(
(
resolve
)
=
>
{
var
testWebSocket
=
new
WebSocket
(
domain
+
'
/
echo
'
)
;
testWebSocket
.
onopen
=
(
)
=
>
{
window
.
addEventListener
(
'
pagehide
'
(
)
=
>
testWebSocket
.
close
(
)
)
;
resolve
(
42
)
;
}
;
testWebSocket
.
onerror
=
(
)
=
>
{
window
.
wsErrorOccurred
=
true
;
}
;
testWebSocket
.
onclose
=
(
)
=
>
{
window
.
wsCloseOccurred
=
true
;
}
;
}
)
;
}
[
SCHEME_DOMAIN_PORT
]
)
;
assert_equals
(
return_value
42
)
;
}
async
function
readWebSocketCloseAndErrorFlags
(
remoteContext
)
{
return
await
remoteContext
.
executeScript
(
(
)
=
>
{
return
{
wsError
:
window
.
wsErrorOccurred
=
=
=
true
wsClose
:
window
.
wsCloseOccurred
=
=
=
true
}
;
}
)
;
}
