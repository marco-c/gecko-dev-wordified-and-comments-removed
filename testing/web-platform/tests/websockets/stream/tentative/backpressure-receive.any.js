const
JITTER_ALLOWANCE_MS
=
200
;
const
LARGE_MESSAGE_COUNT
=
16
;
promise_test
(
async
t
=
>
{
const
wss
=
new
WebSocketStream
(
{
BASEURL
}
/
send
-
backpressure
)
;
const
{
readable
}
=
await
wss
.
opened
;
const
reader
=
readable
.
getReader
(
)
;
await
new
Promise
(
resolve
=
>
t
.
step_timeout
(
resolve
2000
)
)
;
await
reader
.
read
(
)
;
for
(
let
i
=
0
;
i
<
LARGE_MESSAGE_COUNT
;
+
+
i
)
{
await
reader
.
read
(
)
;
}
const
{
value
done
}
=
await
reader
.
read
(
)
;
assert_greater_than_equal
(
Number
(
value
)
2
-
JITTER_ALLOWANCE_MS
/
1000
'
data
send
should
have
taken
at
least
2
seconds
'
)
;
}
'
backpressure
should
be
applied
to
received
messages
'
)
;
