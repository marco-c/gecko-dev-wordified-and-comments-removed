function
getKeepAliveIframeUrl
(
token
method
sendOnPagehide
=
false
)
{
const
https
=
location
.
protocol
.
startsWith
(
'
https
'
)
;
const
frameOrigin
=
get_host_info
(
)
[
https
?
'
HTTPS_NOTSAMESITE_ORIGIN
'
:
'
HTTP_NOTSAMESITE_ORIGIN
'
]
;
return
{
frameOrigin
}
/
fetch
/
api
/
resources
/
keepalive
-
iframe
.
html
?
+
token
=
{
token
}
&
+
method
=
{
method
}
&
+
sendOnPagehide
=
{
sendOnPagehide
}
;
}
function
getKeepAliveAndRedirectIframeUrl
(
token
origin1
origin2
withPreflight
)
{
const
https
=
location
.
protocol
.
startsWith
(
'
https
'
)
;
const
frameOrigin
=
get_host_info
(
)
[
https
?
'
HTTPS_NOTSAMESITE_ORIGIN
'
:
'
HTTP_NOTSAMESITE_ORIGIN
'
]
;
return
{
frameOrigin
}
/
fetch
/
api
/
resources
/
keepalive
-
redirect
-
iframe
.
html
?
+
token
=
{
token
}
&
+
origin1
=
{
origin1
}
&
+
origin2
=
{
origin2
}
&
+
(
withPreflight
?
with
-
headers
:
)
;
}
async
function
iframeLoaded
(
iframe
)
{
return
new
Promise
(
(
resolve
)
=
>
iframe
.
addEventListener
(
'
load
'
resolve
)
)
;
}
async
function
getTokenFromMessage
(
)
{
return
new
Promise
(
(
resolve
)
=
>
{
window
.
addEventListener
(
'
message
'
(
event
)
=
>
{
resolve
(
event
.
data
)
;
}
{
once
:
true
}
)
;
}
)
;
}
async
function
queryToken
(
token
)
{
const
response
=
await
fetch
(
.
.
/
resources
/
stash
-
take
.
py
?
key
=
{
token
}
)
;
const
json
=
await
response
.
json
(
)
;
return
json
;
}
function
assertStashedTokenAsync
(
testName
token
{
shouldPass
=
true
}
=
{
}
)
{
async_test
(
(
test
)
=
>
{
new
Promise
(
(
resolve
)
=
>
test
.
step_timeout
(
resolve
3000
)
)
.
then
(
(
)
=
>
{
return
queryToken
(
token
)
;
}
)
.
then
(
(
result
)
=
>
{
assert_equals
(
result
'
on
'
)
;
}
)
.
then
(
(
)
=
>
{
test
.
done
(
)
;
}
)
.
catch
(
test
.
step_func
(
(
e
)
=
>
{
if
(
shouldPass
)
{
assert_unreached
(
e
)
;
}
else
{
test
.
done
(
)
;
}
}
)
)
;
}
testName
)
;
}
