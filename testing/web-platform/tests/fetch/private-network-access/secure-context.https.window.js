setup
(
(
)
=
>
{
assert_true
(
window
.
isSecureContext
)
;
}
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
}
target
:
{
port
:
kPorts
.
httpsLocal
}
expected
:
kFetchTestResult
.
success
}
)
"
local
to
local
:
no
preflight
required
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
}
target
:
{
port
:
kPorts
.
httpsPrivate
searchParams
:
{
"
final
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
success
}
)
"
local
to
private
:
no
preflight
required
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
}
target
:
{
port
:
kPorts
.
httpsPublic
searchParams
:
{
"
final
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
success
}
)
"
local
to
public
:
no
preflight
required
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
}
target
:
{
port
:
kPorts
.
httpsPublic
searchParams
:
{
"
preflight
-
headers
"
:
"
cors
"
"
final
-
headers
"
:
"
cors
"
}
}
fetchOptions
:
{
method
:
"
PUT
"
}
expected
:
kFetchTestResult
.
failure
}
)
"
local
to
public
:
PUT
preflight
failure
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
}
target
:
{
port
:
kPorts
.
httpsPublic
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
"
"
final
-
headers
"
:
"
cors
"
}
}
fetchOptions
:
{
method
:
"
PUT
"
}
expected
:
kFetchTestResult
.
success
}
)
"
local
to
public
:
PUT
preflight
success
"
)
;
function
makePreflightTests
(
{
source
sourceDescription
targetPort
targetDescription
}
)
{
const
prefix
=
{
sourceDescription
}
to
{
targetDescription
}
:
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
headers
"
:
"
cors
+
pna
"
"
final
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
failure
}
)
prefix
+
"
failed
preflight
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
}
}
expected
:
kFetchTestResult
.
failure
}
)
prefix
+
"
missing
CORS
headers
on
preflight
response
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
failure
}
)
prefix
+
"
missing
PNA
header
on
preflight
response
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
+
pna
"
}
}
expected
:
kFetchTestResult
.
failure
}
)
prefix
+
"
missing
CORS
headers
on
final
response
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
+
pna
"
"
final
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
success
}
)
prefix
+
"
success
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
+
pna
"
"
final
-
headers
"
:
"
cors
"
}
}
fetchOptions
:
{
method
:
"
PUT
"
}
expected
:
kFetchTestResult
.
success
}
)
prefix
+
"
PUT
success
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
}
fetchOptions
:
{
mode
:
"
no
-
cors
"
}
expected
:
kFetchTestResult
.
failure
}
)
prefix
+
"
no
-
CORS
mode
failed
preflight
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
}
}
fetchOptions
:
{
mode
:
"
no
-
cors
"
}
expected
:
kFetchTestResult
.
failure
}
)
prefix
+
"
no
-
CORS
mode
missing
CORS
headers
on
preflight
response
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
"
}
}
fetchOptions
:
{
mode
:
"
no
-
cors
"
}
expected
:
kFetchTestResult
.
failure
}
)
prefix
+
"
no
-
CORS
mode
missing
PNA
header
on
preflight
response
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
target
:
{
port
:
targetPort
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
+
pna
"
}
}
fetchOptions
:
{
mode
:
"
no
-
cors
"
}
expected
:
kFetchTestResult
.
opaque
}
)
prefix
+
"
no
-
CORS
mode
success
.
"
)
;
}
makePreflightTests
(
{
source
:
{
port
:
kPorts
.
httpsPrivate
}
sourceDescription
:
"
private
"
targetPort
:
kPorts
.
httpsLocal
targetDescription
:
"
local
"
}
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsPrivate
}
target
:
{
port
:
kPorts
.
httpsPrivate
}
expected
:
kFetchTestResult
.
success
}
)
"
private
to
private
:
no
preflight
required
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsPrivate
}
target
:
{
port
:
kPorts
.
httpsPublic
searchParams
:
{
"
final
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
success
}
)
"
private
to
public
:
no
preflight
required
.
"
)
;
makePreflightTests
(
{
source
:
{
port
:
kPorts
.
httpsPublic
}
sourceDescription
:
"
public
"
targetPort
:
kPorts
.
httpsLocal
targetDescription
:
"
local
"
}
)
;
makePreflightTests
(
{
source
:
{
port
:
kPorts
.
httpsPublic
}
sourceDescription
:
"
public
"
targetPort
:
kPorts
.
httpsPrivate
targetDescription
:
"
private
"
}
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsPublic
}
target
:
{
port
:
kPorts
.
httpsPublic
}
expected
:
kFetchTestResult
.
success
}
)
"
public
to
public
:
no
preflight
required
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
headers
:
{
"
Content
-
Security
-
Policy
"
:
"
treat
-
as
-
public
-
address
"
}
}
target
:
{
port
:
kPorts
.
httpsLocal
}
expected
:
kFetchTestResult
.
failure
}
)
"
treat
-
as
-
public
-
address
to
local
:
failed
preflight
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
headers
:
{
"
Content
-
Security
-
Policy
"
:
"
treat
-
as
-
public
-
address
"
}
}
target
:
{
port
:
kPorts
.
httpsLocal
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
+
pna
"
}
}
expected
:
kFetchTestResult
.
success
}
)
"
treat
-
as
-
public
-
address
to
local
:
success
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
headers
:
{
"
Content
-
Security
-
Policy
"
:
"
treat
-
as
-
public
-
address
"
}
}
target
:
{
port
:
kPorts
.
httpsPrivate
}
expected
:
kFetchTestResult
.
failure
}
)
"
treat
-
as
-
public
-
address
to
private
:
failed
preflight
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
headers
:
{
"
Content
-
Security
-
Policy
"
:
"
treat
-
as
-
public
-
address
"
}
}
target
:
{
port
:
kPorts
.
httpsPrivate
searchParams
:
{
"
preflight
-
uuid
"
:
token
(
)
"
preflight
-
headers
"
:
"
cors
+
pna
"
"
final
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
success
}
)
"
treat
-
as
-
public
-
address
to
private
:
success
.
"
)
;
promise_test
(
t
=
>
fetchTest
(
t
{
source
:
{
port
:
kPorts
.
httpsLocal
headers
:
{
"
Content
-
Security
-
Policy
"
:
"
treat
-
as
-
public
-
address
"
}
}
target
:
{
port
:
kPorts
.
httpsPublic
searchParams
:
{
"
final
-
headers
"
:
"
cors
"
}
}
expected
:
kFetchTestResult
.
success
}
)
"
treat
-
as
-
public
-
address
to
public
:
no
preflight
required
.
"
)
;
promise_test
(
t
=
>
websocketTest
(
t
{
source
:
{
protocol
:
"
https
:
"
port
:
kPorts
.
httpsLocal
}
target
:
{
protocol
:
"
wss
:
"
port
:
kPorts
.
wssLocal
}
expected
:
kWebsocketTestResult
.
success
}
)
"
local
to
local
:
websocket
success
.
"
)
;
promise_test
(
t
=
>
websocketTest
(
t
{
source
:
{
protocol
:
"
https
:
"
port
:
kPorts
.
httpsPrivate
}
target
:
{
protocol
:
"
wss
:
"
port
:
kPorts
.
wssLocal
}
expected
:
kWebsocketTestResult
.
success
}
)
"
private
to
local
:
websocket
success
.
"
)
;
promise_test
(
t
=
>
websocketTest
(
t
{
source
:
{
protocol
:
"
https
:
"
port
:
kPorts
.
httpsPublic
}
target
:
{
protocol
:
"
wss
:
"
port
:
kPorts
.
wssLocal
}
expected
:
kWebsocketTestResult
.
success
}
)
"
public
to
local
:
websocket
success
.
"
)
;
promise_test
(
t
=
>
websocketTest
(
t
{
source
:
{
protocol
:
"
https
:
"
port
:
kPorts
.
httpsLocal
treatAsPublicAddress
:
true
}
target
:
{
protocol
:
"
wss
:
"
port
:
kPorts
.
wssLocal
}
expected
:
kWebsocketTestResult
.
success
}
)
"
treat
-
as
-
public
to
local
:
websocket
success
.
"
)
;
