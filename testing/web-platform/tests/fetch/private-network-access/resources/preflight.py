import
os
import
random
from
wptserve
.
utils
import
isomorphic_encode
_ACAO
=
(
"
Access
-
Control
-
Allow
-
Origin
"
"
*
"
)
_ACAPN
=
(
"
Access
-
Control
-
Allow
-
Private
-
Network
"
"
true
"
)
_ACAH
=
(
"
Access
-
Control
-
Allow
-
Headers
"
"
Service
-
Worker
"
)
def
_get_response_headers
(
method
mode
origin
)
:
  
acam
=
(
"
Access
-
Control
-
Allow
-
Methods
"
method
)
  
if
mode
=
=
b
"
cors
"
:
    
return
[
acam
_ACAO
]
  
if
mode
=
=
b
"
cors
+
pna
"
:
    
return
[
acam
_ACAO
_ACAPN
]
  
if
mode
=
=
b
"
cors
+
pna
+
sw
"
:
    
return
[
acam
_ACAO
_ACAPN
_ACAH
]
  
if
mode
=
=
b
"
navigation
"
:
    
return
[
        
acam
        
(
"
Access
-
Control
-
Allow
-
Origin
"
origin
)
        
(
"
Access
-
Control
-
Allow
-
Credentials
"
"
true
"
)
        
_ACAPN
    
]
  
return
[
]
def
_get_expect_single_preflight
(
request
)
:
  
return
request
.
GET
.
get
(
b
"
expect
-
single
-
preflight
"
)
def
_is_preflight_optional
(
request
)
:
  
return
request
.
GET
.
get
(
b
"
is
-
preflight
-
optional
"
)
or
\
         
request
.
GET
.
get
(
b
"
file
-
if
-
no
-
preflight
-
received
"
)
def
_get_preflight_uuid
(
request
)
:
  
return
request
.
GET
.
get
(
b
"
preflight
-
uuid
"
)
def
_is_loaded_in_fenced_frame
(
request
)
:
  
return
request
.
GET
.
get
(
b
"
is
-
loaded
-
in
-
fenced
-
frame
"
)
def
_should_treat_as_public_once
(
request
)
:
  
uuid
=
request
.
GET
.
get
(
b
"
treat
-
as
-
public
-
once
"
)
  
if
uuid
is
None
:
    
return
False
  
result
=
request
.
server
.
stash
.
take
(
uuid
)
is
None
  
request
.
server
.
stash
.
put
(
uuid
"
"
)
  
return
result
def
_handle_preflight_request
(
request
response
)
:
  
if
_should_treat_as_public_once
(
request
)
:
    
return
(
400
[
]
"
received
preflight
for
first
treat
-
as
-
public
request
"
)
  
uuid
=
_get_preflight_uuid
(
request
)
  
if
uuid
is
None
:
    
return
(
400
[
]
"
missing
preflight
-
uuid
param
from
preflight
URL
"
)
  
value
=
request
.
server
.
stash
.
take
(
uuid
)
  
request
.
server
.
stash
.
put
(
uuid
"
preflight
"
)
  
if
_get_expect_single_preflight
(
request
)
and
value
is
not
None
:
    
return
(
400
[
]
"
received
duplicated
preflight
"
)
  
method
=
request
.
headers
.
get
(
"
Access
-
Control
-
Request
-
Method
"
)
  
mode
=
request
.
GET
.
get
(
b
"
preflight
-
headers
"
)
  
origin
=
request
.
headers
.
get
(
"
Origin
"
)
  
headers
=
_get_response_headers
(
method
mode
origin
)
  
return
(
headers
"
preflight
"
)
def
_final_response_body
(
request
missing_preflight
)
:
  
file_name
=
None
  
if
missing_preflight
and
not
request
.
GET
.
get
(
b
"
is
-
preflight
-
optional
"
)
:
    
file_name
=
request
.
GET
.
get
(
b
"
file
-
if
-
no
-
preflight
-
received
"
)
  
if
file_name
is
None
:
    
file_name
=
request
.
GET
.
get
(
b
"
file
"
)
  
if
file_name
is
None
:
    
return
request
.
GET
.
get
(
b
"
body
"
)
or
"
success
"
  
prefix
=
b
"
"
  
if
request
.
GET
.
get
(
b
"
random
-
js
-
prefix
"
)
:
    
value
=
random
.
randint
(
0
1000000000
)
    
prefix
=
isomorphic_encode
(
"
/
/
Random
value
:
{
}
\
n
\
n
"
.
format
(
value
)
)
  
path
=
os
.
path
.
join
(
os
.
path
.
dirname
(
isomorphic_encode
(
__file__
)
)
file_name
)
  
with
open
(
path
'
rb
'
)
as
f
:
    
contents
=
f
.
read
(
)
  
return
prefix
+
contents
def
_handle_final_request
(
request
response
)
:
  
missing_preflight
=
False
  
if
_should_treat_as_public_once
(
request
)
:
    
headers
=
[
(
"
Content
-
Security
-
Policy
"
"
treat
-
as
-
public
-
address
"
)
]
  
else
:
    
uuid
=
_get_preflight_uuid
(
request
)
    
if
uuid
is
not
None
:
      
missing_preflight
=
request
.
server
.
stash
.
take
(
uuid
)
is
None
      
if
missing_preflight
and
not
_is_preflight_optional
(
request
)
:
        
return
(
405
[
]
"
no
preflight
received
"
)
      
request
.
server
.
stash
.
put
(
uuid
"
final
"
)
    
mode
=
request
.
GET
.
get
(
b
"
final
-
headers
"
)
    
origin
=
request
.
headers
.
get
(
"
Origin
"
)
    
headers
=
_get_response_headers
(
request
.
method
mode
origin
)
  
redirect
=
request
.
GET
.
get
(
b
"
redirect
"
)
  
if
redirect
is
not
None
:
    
headers
.
append
(
(
"
Location
"
redirect
)
)
    
return
(
301
headers
b
"
"
)
  
mime_type
=
request
.
GET
.
get
(
b
"
mime
-
type
"
)
  
if
mime_type
is
not
None
:
    
headers
.
append
(
(
"
Content
-
Type
"
mime_type
)
)
  
if
_is_loaded_in_fenced_frame
(
request
)
:
    
headers
.
append
(
(
"
Supports
-
Loading
-
Mode
"
"
fenced
-
frame
"
)
)
  
body
=
_final_response_body
(
request
missing_preflight
)
  
return
(
headers
body
)
def
main
(
request
response
)
:
  
try
:
    
if
request
.
method
=
=
"
OPTIONS
"
:
      
return
_handle_preflight_request
(
request
response
)
    
else
:
      
return
_handle_final_request
(
request
response
)
  
except
BaseException
as
e
:
    
return
(
500
[
(
"
X
-
exception
"
str
(
e
)
)
]
"
exception
:
{
}
"
.
format
(
e
)
)
