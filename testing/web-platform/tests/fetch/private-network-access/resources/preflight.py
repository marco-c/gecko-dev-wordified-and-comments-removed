import
os
import
random
from
wptserve
.
utils
import
isomorphic_encode
_ACAO
=
(
"
Access
-
Control
-
Allow
-
Origin
"
"
*
"
)
_ACAPN
=
(
"
Access
-
Control
-
Allow
-
Private
-
Network
"
"
true
"
)
def
_get_response_headers
(
method
mode
)
:
  
acam
=
(
"
Access
-
Control
-
Allow
-
Methods
"
method
)
  
if
mode
=
=
b
"
cors
"
:
    
return
[
acam
_ACAO
]
  
if
mode
=
=
b
"
cors
+
pna
"
:
    
return
[
acam
_ACAO
_ACAPN
]
  
return
[
]
def
_get_preflight_uuid
(
request
)
:
  
return
request
.
GET
.
get
(
b
"
preflight
-
uuid
"
)
def
_should_treat_as_public_once
(
request
)
:
  
uuid
=
request
.
GET
.
get
(
b
"
treat
-
as
-
public
-
once
"
)
  
if
uuid
is
None
:
    
return
False
  
result
=
request
.
server
.
stash
.
take
(
uuid
)
is
None
  
request
.
server
.
stash
.
put
(
uuid
"
"
)
  
return
result
def
_handle_preflight_request
(
request
response
)
:
  
if
_should_treat_as_public_once
(
request
)
:
    
return
(
400
[
]
"
received
preflight
for
first
treat
-
as
-
public
request
"
)
  
uuid
=
_get_preflight_uuid
(
request
)
  
if
uuid
is
None
:
    
return
(
400
[
]
"
missing
preflight
-
uuid
param
from
preflight
URL
"
)
  
request
.
server
.
stash
.
put
(
uuid
"
"
)
  
method
=
request
.
headers
.
get
(
"
Access
-
Control
-
Request
-
Method
"
)
  
mode
=
request
.
GET
.
get
(
b
"
preflight
-
headers
"
)
  
headers
=
_get_response_headers
(
method
mode
)
  
return
(
headers
"
preflight
"
)
def
_final_response_body
(
request
)
:
  
file_name
=
request
.
GET
.
get
(
b
"
file
"
)
  
if
file_name
is
None
:
    
return
request
.
GET
.
get
(
b
"
body
"
)
or
"
success
"
  
prefix
=
b
"
"
  
if
request
.
GET
.
get
(
b
"
random
-
js
-
prefix
"
)
:
    
value
=
random
.
randint
(
0
1000000000
)
    
prefix
=
isomorphic_encode
(
"
/
/
Random
value
:
{
}
\
n
\
n
"
.
format
(
value
)
)
  
path
=
os
.
path
.
join
(
os
.
path
.
dirname
(
isomorphic_encode
(
__file__
)
)
file_name
)
  
with
open
(
path
'
rb
'
)
as
f
:
    
contents
=
f
.
read
(
)
  
return
prefix
+
contents
def
_handle_final_request
(
request
response
)
:
  
if
_should_treat_as_public_once
(
request
)
:
    
headers
=
[
(
"
Content
-
Security
-
Policy
"
"
treat
-
as
-
public
-
address
"
)
]
  
else
:
    
uuid
=
_get_preflight_uuid
(
request
)
    
if
uuid
is
not
None
and
request
.
server
.
stash
.
take
(
uuid
)
is
None
:
      
return
(
405
[
]
"
no
preflight
received
for
{
}
"
.
format
(
uuid
)
)
    
mode
=
request
.
GET
.
get
(
b
"
final
-
headers
"
)
    
headers
=
_get_response_headers
(
request
.
method
mode
)
  
redirect
=
request
.
GET
.
get
(
b
"
redirect
"
)
  
if
redirect
is
not
None
:
    
headers
.
append
(
(
"
Location
"
redirect
)
)
    
return
(
301
headers
b
"
"
)
  
mime_type
=
request
.
GET
.
get
(
b
"
mime
-
type
"
)
  
if
mime_type
is
not
None
:
    
headers
.
append
(
(
"
Content
-
Type
"
mime_type
)
)
  
body
=
_final_response_body
(
request
)
  
return
(
headers
body
)
def
main
(
request
response
)
:
  
try
:
    
if
request
.
method
=
=
"
OPTIONS
"
:
      
return
_handle_preflight_request
(
request
response
)
    
else
:
      
return
_handle_final_request
(
request
response
)
  
except
BaseException
as
e
:
    
return
(
500
[
(
"
X
-
exception
"
str
(
e
)
)
]
"
exception
:
{
}
"
.
format
(
e
)
)
