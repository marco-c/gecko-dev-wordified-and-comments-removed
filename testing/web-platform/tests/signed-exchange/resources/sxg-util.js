function
openSXGInIframeAndWaitForMessage
(
test_object
url
)
{
return
new
Promise
(
async
(
resolve
reject
)
=
>
{
test_object
.
step_timeout
(
(
)
=
>
reject
(
'
timeout
'
)
2000
)
;
const
frame
=
await
withIframe
(
url
'
sxg_iframe
'
)
;
const
channel
=
new
MessageChannel
(
)
;
channel
.
port1
.
onmessage
=
(
event
)
=
>
resolve
(
event
.
data
)
;
frame
.
contentWindow
.
postMessage
(
{
port
:
channel
.
port2
}
'
*
'
[
channel
.
port2
]
)
;
}
)
;
}
function
withIframe
(
url
name
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
const
frame
=
document
.
createElement
(
'
iframe
'
)
;
frame
.
src
=
url
;
frame
.
name
=
name
;
frame
.
onload
=
(
)
=
>
resolve
(
frame
)
;
frame
.
onerror
=
(
)
=
>
reject
(
'
failed
to
load
'
+
url
)
;
document
.
body
.
appendChild
(
frame
)
;
}
)
;
}
function
loadScript
(
url
)
{
return
new
Promise
(
(
resolve
reject
)
=
>
{
const
scriptTag
=
document
.
createElement
(
'
script
'
)
;
scriptTag
.
src
=
url
;
scriptTag
.
onload
=
(
)
=
>
resolve
(
)
;
scriptTag
.
onerror
=
(
)
=
>
reject
(
'
failed
to
load
'
+
url
)
;
document
.
head
.
appendChild
(
scriptTag
)
;
}
)
;
}
