'
use
strict
'
;
const
kScope
=
'
/
cookiestore
/
does
/
not
/
exist
'
;
const
kServiceWorkerActivatedPromise
=
new
Promise
(
(
resolve
)
=
>
{
self
.
addEventListener
(
'
activate
'
event
=
>
{
resolve
(
)
;
}
)
;
}
)
;
let
g_cookie_changes
=
[
]
;
let
g_cookie_change_received_promise_resolver
=
null
;
self
.
addEventListener
(
'
cookiechange
'
(
event
)
=
>
{
g_cookie_changes
.
push
(
event
)
;
if
(
g_cookie_change_received_promise_resolver
)
{
g_cookie_change_received_promise_resolver
(
)
;
}
}
)
;
function
RearmCookieChangeReceivedPromise
(
)
{
return
new
Promise
(
(
resolve
)
=
>
{
g_cookie_change_received_promise_resolver
=
resolve
;
}
)
;
}
promise_test
(
async
testCase
=
>
{
await
kServiceWorkerActivatedPromise
;
const
subscriptions
=
[
{
name
:
'
cookie
-
name
'
}
{
url
:
{
kScope
}
/
path
}
]
;
await
registration
.
cookies
.
subscribe
(
subscriptions
)
;
testCase
.
add_cleanup
(
(
)
=
>
registration
.
cookies
.
unsubscribe
(
subscriptions
)
)
;
let
cookie_change_received_promise
=
RearmCookieChangeReceivedPromise
(
)
;
await
cookieStore
.
set
(
'
cookie
-
name
'
'
cookie
-
value
'
)
;
testCase
.
add_cleanup
(
async
(
)
=
>
{
await
cookieStore
.
delete
(
'
cookie
-
name
'
)
;
}
)
;
testCase
.
add_cleanup
(
(
)
=
>
{
g_cookie_changes
=
[
]
;
}
)
;
await
cookie_change_received_promise
;
cookie_change_received_promise
=
RearmCookieChangeReceivedPromise
(
)
;
await
cookieStore
.
set
(
'
coo
'
'
coo
-
value
'
)
;
testCase
.
add_cleanup
(
async
(
)
=
>
{
await
cookieStore
.
delete
(
'
coo
'
)
;
}
)
;
testCase
.
add_cleanup
(
(
)
=
>
{
g_cookie_changes
=
[
]
;
}
)
;
await
cookie_change_received_promise
;
assert_equals
(
g_cookie_changes
.
length
2
)
;
{
const
event
=
g_cookie_changes
[
0
]
;
assert_equals
(
event
.
type
'
cookiechange
'
)
;
assert_equals
(
event
.
changed
.
length
1
)
;
assert_equals
(
event
.
changed
[
0
]
.
name
'
cookie
-
name
'
)
;
assert_equals
(
event
.
changed
[
0
]
.
value
'
cookie
-
value
'
)
;
assert_equals
(
event
.
deleted
.
length
0
)
;
assert_true
(
event
instanceof
ExtendableCookieChangeEvent
)
;
assert_true
(
event
instanceof
ExtendableEvent
)
;
}
{
const
event
=
g_cookie_changes
[
1
]
;
assert_equals
(
event
.
type
'
cookiechange
'
)
;
assert_equals
(
event
.
changed
.
length
1
)
;
assert_equals
(
event
.
changed
[
0
]
.
name
'
coo
'
)
;
assert_equals
(
event
.
changed
[
0
]
.
value
'
coo
-
value
'
)
;
assert_equals
(
event
.
deleted
.
length
0
)
;
assert_true
(
event
instanceof
ExtendableCookieChangeEvent
)
;
assert_true
(
event
instanceof
ExtendableEvent
)
;
}
}
'
1
cookiechange
event
dispatched
with
cookie
change
that
matches
multiple
'
+
'
subscriptions
'
)
;
