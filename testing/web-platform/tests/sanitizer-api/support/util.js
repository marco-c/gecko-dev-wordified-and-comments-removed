function
is_same_sanitizer_name
(
a
b
)
{
return
a
.
name
=
=
=
b
.
name
&
&
a
.
namespace
=
=
=
b
.
namespace
;
}
function
assert_config_is_valid
(
config
)
{
assert_false
(
"
elements
"
in
config
&
&
"
removeElements
"
in
config
"
Either
elements
or
a
removeElements
but
not
both
"
)
;
assert_true
(
"
elements
"
in
config
|
|
"
removeElements
"
in
config
"
Either
elements
or
a
removeElements
"
)
;
assert_false
(
"
attributes
"
in
config
&
&
"
removeAttributes
"
in
config
"
Either
attributes
or
a
removeAttributes
but
not
both
"
)
;
assert_true
(
"
attributes
"
in
config
|
|
"
removeAttributes
"
in
config
"
Either
attributes
or
removeAttributes
"
)
;
if
(
config
.
elements
&
&
config
.
replaceWithChildrenElements
)
{
for
(
let
element
of
config
.
elements
)
{
assert_false
(
config
.
replaceWithChildrenElements
.
some
(
(
replaceElement
)
=
>
is_same_sanitizer_name
(
element
replaceElement
)
)
replaceWithChildrenElements
should
not
contain
{
element
.
name
}
)
;
}
}
if
(
config
.
removeElements
&
&
config
.
replaceWithChildrenElements
)
{
for
(
let
removeElement
of
config
.
removeElements
)
{
assert_false
(
config
.
replaceWithChildrenElements
.
some
(
(
replaceElement
)
=
>
is_same_sanitizer_name
(
removeElement
replaceElement
)
)
replaceWithChildrenElements
should
not
contain
{
removeElement
.
name
}
)
;
}
}
if
(
config
.
attributes
)
{
}
else
{
if
(
config
.
elements
)
{
for
(
let
element
of
config
.
elements
)
{
assert_false
(
"
attributes
"
in
element
&
&
"
removeAttributes
"
in
element
Element
{
element
.
name
}
can
'
t
have
both
'
attributes
'
and
'
removeAttributes
'
)
;
}
}
assert_false
(
"
dataAttributes
"
in
config
"
dataAttributes
does
not
exist
"
)
;
}
}
function
assert_config
(
config
expected
)
{
const
PROPERTIES
=
[
"
attributes
"
"
removeAttributes
"
"
elements
"
"
removeElements
"
"
replaceWithChildrenElements
"
"
comments
"
"
dataAttributes
"
]
;
for
(
let
key
of
Object
.
keys
(
expected
)
)
{
assert_in_array
(
key
PROPERTIES
"
expected
"
)
;
}
for
(
let
key
of
Object
.
keys
(
config
)
)
{
assert_in_array
(
key
PROPERTIES
"
config
"
)
;
}
assert_config_is_valid
(
config
)
;
function
assert_attrs
(
key
config
expected
prefix
=
"
config
"
)
{
if
(
!
(
key
in
expected
)
)
{
return
;
}
if
(
expected
[
key
]
=
=
=
undefined
)
{
assert_false
(
key
in
config
Unexpected
'
{
key
}
'
in
{
prefix
}
)
;
return
;
}
assert_true
(
key
in
config
Missing
'
{
key
}
'
from
{
prefix
}
)
;
assert_equals
(
config
[
key
]
?
.
length
expected
[
key
]
.
length
{
prefix
}
.
{
key
}
.
length
)
;
for
(
let
i
=
0
;
i
<
expected
[
key
]
.
length
;
i
+
+
)
{
let
attribute
=
expected
[
key
]
[
i
]
;
if
(
typeof
attribute
=
=
=
"
string
"
)
{
assert_object_equals
(
config
[
key
]
[
i
]
{
name
:
attribute
namespace
:
null
}
{
prefix
}
.
{
key
}
[
{
i
}
]
should
match
)
;
}
else
{
assert_object_equals
(
config
[
key
]
[
i
]
attribute
{
prefix
}
.
{
key
}
[
{
i
}
]
should
match
)
;
}
}
}
assert_attrs
(
"
attributes
"
config
expected
)
;
assert_attrs
(
"
removeAttributes
"
config
expected
)
;
function
assert_elems
(
key
)
{
if
(
!
(
key
in
expected
)
)
{
return
;
}
if
(
expected
[
key
]
=
=
=
undefined
)
{
assert_false
(
key
in
config
Unexpected
'
{
key
}
'
in
config
)
;
return
;
}
assert_true
(
key
in
config
Missing
'
{
key
}
'
from
config
)
;
assert_equals
(
config
[
key
]
?
.
length
expected
[
key
]
.
length
{
key
}
.
length
)
;
const
XHTML_NS
=
"
http
:
/
/
www
.
w3
.
org
/
1999
/
xhtml
"
;
for
(
let
i
=
0
;
i
<
expected
[
key
]
.
length
;
i
+
+
)
{
let
element
=
expected
[
key
]
[
i
]
;
if
(
typeof
element
=
=
=
"
string
"
)
{
let
extra
=
key
=
=
=
"
elements
"
?
{
removeAttributes
:
[
]
}
:
{
}
;
assert_object_equals
(
config
[
key
]
[
i
]
{
name
:
element
namespace
:
XHTML_NS
.
.
.
extra
}
{
key
}
[
{
i
}
]
should
match
)
;
}
else
{
if
(
key
=
=
=
"
elements
"
)
{
assert_equals
(
config
[
key
]
[
i
]
.
name
element
.
name
{
key
}
[
{
i
}
]
.
name
should
match
)
;
let
ns
=
"
namespace
"
in
element
?
element
.
namespace
:
XHTML_NS
;
assert_equals
(
config
[
key
]
[
i
]
.
namespace
ns
{
key
}
[
{
i
}
]
.
namespace
should
match
)
;
assert_attrs
(
"
attributes
"
config
[
key
]
[
i
]
element
config
.
elements
[
{
i
}
]
)
;
assert_attrs
(
"
removeAttributes
"
config
[
key
]
[
i
]
element
config
.
elements
[
{
i
}
]
)
;
}
else
{
assert_object_equals
(
config
[
key
]
[
i
]
element
{
key
}
[
{
i
}
]
should
match
)
;
}
}
}
}
assert_elems
(
"
elements
"
)
;
assert_elems
(
"
removeElements
"
)
;
assert_elems
(
"
replaceWithChildrenElements
"
)
;
if
(
"
comments
"
in
expected
)
{
assert_equals
(
config
.
comments
expected
.
comments
"
comments
should
match
"
)
;
}
if
(
"
dataAttributes
"
in
expected
)
{
assert_equals
(
config
.
dataAttributes
expected
.
dataAttributes
"
dataAttributes
should
match
"
)
;
}
}
