function
fetch_text
(
url
)
{
return
fetch
(
url
)
.
then
(
function
(
r
)
{
if
(
!
r
.
ok
)
{
throw
new
Error
(
"
Error
fetching
"
+
url
+
"
.
"
)
;
}
return
r
.
text
(
)
;
}
)
;
}
function
idl_test_shadowrealm
(
srcs
deps
)
{
promise_setup
(
async
t
=
>
{
const
realm
=
new
ShadowRealm
(
)
;
const
specs
=
await
Promise
.
all
(
srcs
.
concat
(
deps
)
.
map
(
spec
=
>
{
return
fetch_text
(
"
/
interfaces
/
"
+
spec
+
"
.
idl
"
)
;
}
)
)
;
const
idls
=
JSON
.
stringify
(
specs
)
;
await
shadowRealmEvalAsync
(
realm
await
import
(
"
/
resources
/
testharness
-
shadowrealm
-
inner
.
js
"
)
;
await
import
(
"
/
resources
/
testharness
.
js
"
)
;
await
import
(
"
/
resources
/
WebIDLParser
.
js
"
)
;
await
import
(
"
/
resources
/
idlharness
.
js
"
)
;
const
idls
=
{
idls
}
;
const
idl_array
=
new
IdlArray
(
)
;
for
(
let
i
=
0
;
i
<
{
srcs
.
length
}
;
i
+
+
)
{
idl_array
.
add_idls
(
idls
[
i
]
)
;
}
for
(
let
i
=
{
srcs
.
length
}
;
i
<
{
srcs
.
length
+
deps
.
length
}
;
i
+
+
)
{
idl_array
.
add_dependency_idls
(
idls
[
i
]
)
;
}
idl_array
.
test
(
)
;
)
;
await
fetch_tests_from_shadow_realm
(
realm
)
;
}
)
;
}
