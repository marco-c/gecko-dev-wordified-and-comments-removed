(
function
(
)
{
"
use
strict
"
;
var
idCounter
=
0
;
let
testharness_context
=
null
;
function
getInViewCenterPoint
(
rect
)
{
var
left
=
Math
.
max
(
0
rect
.
left
)
;
var
right
=
Math
.
min
(
window
.
innerWidth
rect
.
right
)
;
var
top
=
Math
.
max
(
0
rect
.
top
)
;
var
bottom
=
Math
.
min
(
window
.
innerHeight
rect
.
bottom
)
;
var
x
=
0
.
5
*
(
left
+
right
)
;
var
y
=
0
.
5
*
(
top
+
bottom
)
;
return
[
x
y
]
;
}
function
getPointerInteractablePaintTree
(
element
)
{
let
elementDocument
=
element
.
ownerDocument
;
if
(
!
elementDocument
.
contains
(
element
)
)
{
return
[
]
;
}
var
rectangles
=
element
.
getClientRects
(
)
;
if
(
rectangles
.
length
=
=
=
0
)
{
return
[
]
;
}
var
centerPoint
=
getInViewCenterPoint
(
rectangles
[
0
]
)
;
if
(
"
elementsFromPoint
"
in
elementDocument
)
{
return
elementDocument
.
elementsFromPoint
(
centerPoint
[
0
]
centerPoint
[
1
]
)
;
}
else
if
(
"
msElementsFromPoint
"
in
elementDocument
)
{
var
rv
=
elementDocument
.
msElementsFromPoint
(
centerPoint
[
0
]
centerPoint
[
1
]
)
;
return
Array
.
prototype
.
slice
.
call
(
rv
?
rv
:
[
]
)
;
}
else
{
throw
new
Error
(
"
document
.
elementsFromPoint
unsupported
"
)
;
}
}
function
inView
(
element
)
{
var
pointerInteractablePaintTree
=
getPointerInteractablePaintTree
(
element
)
;
return
pointerInteractablePaintTree
.
indexOf
(
element
)
!
=
=
-
1
;
}
window
.
test_driver
=
{
bidi
:
{
log
:
{
entry_added
:
{
subscribe
:
async
function
(
params
=
{
}
)
{
return
window
.
test_driver_internal
.
bidi
.
log
.
entry_added
.
subscribe
(
params
)
;
}
on
:
function
(
callback
)
{
return
window
.
test_driver_internal
.
bidi
.
log
.
entry_added
.
on
(
callback
)
;
}
once
:
function
(
)
{
return
new
Promise
(
resolve
=
>
{
const
remove_handler
=
window
.
test_driver_internal
.
bidi
.
log
.
entry_added
.
on
(
data
=
>
{
resolve
(
data
)
;
remove_handler
(
)
;
}
)
;
}
)
;
}
}
}
}
set_test_context
:
function
(
context
)
{
if
(
window
.
test_driver_internal
.
set_test_context
)
{
window
.
test_driver_internal
.
set_test_context
(
context
)
;
}
testharness_context
=
context
;
}
message_test
:
function
(
msg
)
{
let
target
=
testharness_context
;
if
(
testharness_context
=
=
=
null
)
{
target
=
window
;
}
target
.
postMessage
(
msg
"
*
"
)
;
}
bless
:
function
(
intent
action
context
=
null
)
{
let
contextDocument
=
context
?
context
.
document
:
document
;
var
button
=
contextDocument
.
createElement
(
"
button
"
)
;
button
.
innerHTML
=
"
This
test
requires
user
interaction
.
<
br
/
>
"
+
"
Please
click
here
to
allow
"
+
intent
+
"
.
"
;
button
.
id
=
"
wpt
-
test
-
driver
-
bless
-
"
+
(
idCounter
+
=
1
)
;
const
elem
=
contextDocument
.
body
|
|
contextDocument
.
documentElement
;
elem
.
appendChild
(
button
)
;
let
wait_click
=
new
Promise
(
resolve
=
>
button
.
addEventListener
(
"
click
"
resolve
)
)
;
return
test_driver
.
click
(
button
)
.
then
(
wait_click
)
.
then
(
function
(
)
{
button
.
remove
(
)
;
if
(
typeof
action
=
=
=
"
function
"
)
{
return
action
(
)
;
}
return
null
;
}
)
;
}
click
:
function
(
element
)
{
if
(
!
inView
(
element
)
)
{
element
.
scrollIntoView
(
{
behavior
:
"
instant
"
block
:
"
end
"
inline
:
"
nearest
"
}
)
;
}
var
pointerInteractablePaintTree
=
getPointerInteractablePaintTree
(
element
)
;
if
(
pointerInteractablePaintTree
.
length
=
=
=
0
|
|
!
element
.
contains
(
pointerInteractablePaintTree
[
0
]
)
)
{
return
Promise
.
reject
(
new
Error
(
"
element
click
intercepted
error
"
)
)
;
}
var
rect
=
element
.
getClientRects
(
)
[
0
]
;
var
centerPoint
=
getInViewCenterPoint
(
rect
)
;
return
window
.
test_driver_internal
.
click
(
element
{
x
:
centerPoint
[
0
]
y
:
centerPoint
[
1
]
}
)
;
}
delete_all_cookies
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
delete_all_cookies
(
context
)
;
}
get_all_cookies
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
get_all_cookies
(
context
)
;
}
get_named_cookie
:
async
function
(
name
context
=
null
)
{
let
cookie
=
await
window
.
test_driver_internal
.
get_named_cookie
(
name
context
)
;
if
(
!
cookie
)
{
throw
new
Error
(
"
no
such
cookie
"
)
;
}
return
cookie
;
}
get_computed_label
:
async
function
(
element
)
{
let
label
=
await
window
.
test_driver_internal
.
get_computed_label
(
element
)
;
return
label
;
}
get_computed_role
:
async
function
(
element
)
{
let
role
=
await
window
.
test_driver_internal
.
get_computed_role
(
element
)
;
return
role
;
}
send_keys
:
function
(
element
keys
)
{
if
(
!
inView
(
element
)
)
{
element
.
scrollIntoView
(
{
behavior
:
"
instant
"
block
:
"
end
"
inline
:
"
nearest
"
}
)
;
}
return
window
.
test_driver_internal
.
send_keys
(
element
keys
)
;
}
freeze
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
freeze
(
)
;
}
minimize_window
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
minimize_window
(
context
)
;
}
set_window_rect
:
function
(
rect
context
=
null
)
{
return
window
.
test_driver_internal
.
set_window_rect
(
rect
context
)
;
}
get_window_rect
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
get_window_rect
(
context
)
;
}
action_sequence
:
function
(
actions
context
=
null
)
{
return
window
.
test_driver_internal
.
action_sequence
(
actions
context
)
;
}
generate_test_report
:
function
(
message
context
=
null
)
{
return
window
.
test_driver_internal
.
generate_test_report
(
message
context
)
;
}
set_permission
:
function
(
descriptor
state
context
=
null
)
{
let
permission_params
=
{
descriptor
state
}
;
return
window
.
test_driver_internal
.
set_permission
(
permission_params
context
)
;
}
add_virtual_authenticator
:
function
(
config
context
=
null
)
{
return
window
.
test_driver_internal
.
add_virtual_authenticator
(
config
context
)
;
}
remove_virtual_authenticator
:
function
(
authenticator_id
context
=
null
)
{
return
window
.
test_driver_internal
.
remove_virtual_authenticator
(
authenticator_id
context
)
;
}
add_credential
:
function
(
authenticator_id
credential
context
=
null
)
{
return
window
.
test_driver_internal
.
add_credential
(
authenticator_id
credential
context
)
;
}
get_credentials
:
function
(
authenticator_id
context
=
null
)
{
return
window
.
test_driver_internal
.
get_credentials
(
authenticator_id
context
=
null
)
;
}
remove_credential
:
function
(
authenticator_id
credential_id
context
=
null
)
{
return
window
.
test_driver_internal
.
remove_credential
(
authenticator_id
credential_id
context
)
;
}
remove_all_credentials
:
function
(
authenticator_id
context
=
null
)
{
return
window
.
test_driver_internal
.
remove_all_credentials
(
authenticator_id
context
)
;
}
set_user_verified
:
function
(
authenticator_id
uv
context
=
null
)
{
return
window
.
test_driver_internal
.
set_user_verified
(
authenticator_id
uv
context
)
;
}
set_storage_access
:
function
(
origin
embedding_origin
state
context
=
null
)
{
if
(
state
!
=
=
"
allowed
"
&
&
state
!
=
=
"
blocked
"
)
{
throw
new
Error
(
"
storage
access
status
must
be
'
allowed
'
or
'
blocked
'
"
)
;
}
const
blocked
=
state
=
=
=
"
blocked
"
;
return
window
.
test_driver_internal
.
set_storage_access
(
origin
embedding_origin
blocked
context
)
;
}
set_spc_transaction_mode
:
function
(
mode
context
=
null
)
{
return
window
.
test_driver_internal
.
set_spc_transaction_mode
(
mode
context
)
;
}
set_rph_registration_mode
:
function
(
mode
context
=
null
)
{
return
window
.
test_driver_internal
.
set_rph_registration_mode
(
mode
context
)
;
}
cancel_fedcm_dialog
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
cancel_fedcm_dialog
(
context
)
;
}
click_fedcm_dialog_button
:
function
(
dialog_button
context
=
null
)
{
return
window
.
test_driver_internal
.
click_fedcm_dialog_button
(
dialog_button
context
)
;
}
select_fedcm_account
:
function
(
account_index
context
=
null
)
{
return
window
.
test_driver_internal
.
select_fedcm_account
(
account_index
context
)
;
}
get_fedcm_account_list
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
get_fedcm_account_list
(
context
)
;
}
get_fedcm_dialog_title
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
get_fedcm_dialog_title
(
context
)
;
}
get_fedcm_dialog_type
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
get_fedcm_dialog_type
(
context
)
;
}
set_fedcm_delay_enabled
:
function
(
enabled
context
=
null
)
{
return
window
.
test_driver_internal
.
set_fedcm_delay_enabled
(
enabled
context
)
;
}
reset_fedcm_cooldown
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
reset_fedcm_cooldown
(
context
)
;
}
create_virtual_sensor
:
function
(
sensor_type
sensor_params
=
{
}
context
=
null
)
{
return
window
.
test_driver_internal
.
create_virtual_sensor
(
sensor_type
sensor_params
context
)
;
}
update_virtual_sensor
:
function
(
sensor_type
reading
context
=
null
)
{
return
window
.
test_driver_internal
.
update_virtual_sensor
(
sensor_type
reading
context
)
;
}
remove_virtual_sensor
:
function
(
sensor_type
context
=
null
)
{
return
window
.
test_driver_internal
.
remove_virtual_sensor
(
sensor_type
context
)
;
}
get_virtual_sensor_information
:
function
(
sensor_type
context
=
null
)
{
return
window
.
test_driver_internal
.
get_virtual_sensor_information
(
sensor_type
context
)
;
}
set_device_posture
:
function
(
posture
context
=
null
)
{
return
window
.
test_driver_internal
.
set_device_posture
(
posture
context
)
;
}
clear_device_posture
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
clear_device_posture
(
context
)
;
}
run_bounce_tracking_mitigations
:
function
(
context
=
null
)
{
return
window
.
test_driver_internal
.
run_bounce_tracking_mitigations
(
context
)
;
}
create_virtual_pressure_source
:
function
(
source_type
metadata
=
{
}
context
=
null
)
{
return
window
.
test_driver_internal
.
create_virtual_pressure_source
(
source_type
metadata
context
)
;
}
update_virtual_pressure_source
:
function
(
source_type
sample
context
=
null
)
{
return
window
.
test_driver_internal
.
update_virtual_pressure_source
(
source_type
sample
context
)
;
}
remove_virtual_pressure_source
:
function
(
source_type
context
=
null
)
{
return
window
.
test_driver_internal
.
remove_virtual_pressure_source
(
source_type
context
)
;
}
}
;
window
.
test_driver_internal
=
{
in_automation
:
false
bidi
:
{
log
:
{
entry_added
:
{
async
subscribe
(
)
{
throw
new
Error
(
"
bidi
.
log
.
entry_added
.
subscribe
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
on
(
)
{
throw
new
Error
(
"
bidi
.
log
.
entry_added
.
on
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
}
}
}
async
click
(
element
coords
)
{
if
(
this
.
in_automation
)
{
throw
new
Error
(
"
click
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
return
new
Promise
(
function
(
resolve
reject
)
{
element
.
addEventListener
(
"
click
"
resolve
)
;
}
)
;
}
async
delete_all_cookies
(
context
=
null
)
{
throw
new
Error
(
"
delete_all_cookies
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_all_cookies
(
context
=
null
)
{
throw
new
Error
(
"
get_all_cookies
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_named_cookie
(
name
context
=
null
)
{
throw
new
Error
(
"
get_named_cookie
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_computed_role
(
element
)
{
throw
new
Error
(
"
get_computed_role
is
a
testdriver
.
js
function
which
cannot
be
run
in
this
context
.
"
)
;
}
async
get_computed_name
(
element
)
{
throw
new
Error
(
"
get_computed_name
is
a
testdriver
.
js
function
which
cannot
be
run
in
this
context
.
"
)
;
}
async
send_keys
(
element
keys
)
{
if
(
this
.
in_automation
)
{
throw
new
Error
(
"
send_keys
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
return
new
Promise
(
function
(
resolve
reject
)
{
var
seen
=
"
"
;
function
remove
(
)
{
element
.
removeEventListener
(
"
keydown
"
onKeyDown
)
;
}
function
onKeyDown
(
event
)
{
if
(
event
.
key
.
length
>
1
)
{
return
;
}
seen
+
=
event
.
key
;
if
(
keys
.
indexOf
(
seen
)
!
=
=
0
)
{
reject
(
new
Error
(
"
Unexpected
key
sequence
:
"
+
seen
)
)
;
remove
(
)
;
}
else
if
(
seen
=
=
=
keys
)
{
resolve
(
)
;
remove
(
)
;
}
}
element
.
addEventListener
(
"
keydown
"
onKeyDown
)
;
}
)
;
}
async
freeze
(
context
=
null
)
{
throw
new
Error
(
"
freeze
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
minimize_window
(
context
=
null
)
{
throw
new
Error
(
"
minimize_window
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
set_window_rect
(
rect
context
=
null
)
{
throw
new
Error
(
"
set_window_rect
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_window_rect
(
context
=
null
)
{
throw
new
Error
(
"
get_window_rect
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
action_sequence
(
actions
context
=
null
)
{
throw
new
Error
(
"
action_sequence
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
generate_test_report
(
message
context
=
null
)
{
throw
new
Error
(
"
generate_test_report
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
set_permission
(
permission_params
context
=
null
)
{
throw
new
Error
(
"
set_permission
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
add_virtual_authenticator
(
config
context
=
null
)
{
throw
new
Error
(
"
add_virtual_authenticator
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
remove_virtual_authenticator
(
authenticator_id
context
=
null
)
{
throw
new
Error
(
"
remove_virtual_authenticator
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
add_credential
(
authenticator_id
credential
context
=
null
)
{
throw
new
Error
(
"
add_credential
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_credentials
(
authenticator_id
context
=
null
)
{
throw
new
Error
(
"
get_credentials
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
remove_credential
(
authenticator_id
credential_id
context
=
null
)
{
throw
new
Error
(
"
remove_credential
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
remove_all_credentials
(
authenticator_id
context
=
null
)
{
throw
new
Error
(
"
remove_all_credentials
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
set_user_verified
(
authenticator_id
uv
context
=
null
)
{
throw
new
Error
(
"
set_user_verified
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
set_storage_access
(
origin
embedding_origin
blocked
context
=
null
)
{
throw
new
Error
(
"
set_storage_access
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
set_spc_transaction_mode
(
mode
context
=
null
)
{
throw
new
Error
(
"
set_spc_transaction_mode
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
set_rph_registration_mode
:
function
(
mode
context
=
null
)
{
return
Promise
.
reject
(
new
Error
(
"
unimplemented
"
)
)
;
}
async
cancel_fedcm_dialog
(
context
=
null
)
{
throw
new
Error
(
"
cancel_fedcm_dialog
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
click_fedcm_dialog_button
(
dialog_button
context
=
null
)
{
throw
new
Error
(
"
click_fedcm_dialog_button
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
select_fedcm_account
(
account_index
context
=
null
)
{
throw
new
Error
(
"
select_fedcm_account
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_fedcm_account_list
(
context
=
null
)
{
throw
new
Error
(
"
get_fedcm_account_list
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_fedcm_dialog_title
(
context
=
null
)
{
throw
new
Error
(
"
get_fedcm_dialog_title
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_fedcm_dialog_type
(
context
=
null
)
{
throw
new
Error
(
"
get_fedcm_dialog_type
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
set_fedcm_delay_enabled
(
enabled
context
=
null
)
{
throw
new
Error
(
"
set_fedcm_delay_enabled
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
reset_fedcm_cooldown
(
context
=
null
)
{
throw
new
Error
(
"
reset_fedcm_cooldown
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
create_virtual_sensor
(
sensor_type
sensor_params
context
=
null
)
{
throw
new
Error
(
"
create_virtual_sensor
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
update_virtual_sensor
(
sensor_type
reading
context
=
null
)
{
throw
new
Error
(
"
update_virtual_sensor
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
remove_virtual_sensor
(
sensor_type
context
=
null
)
{
throw
new
Error
(
"
remove_virtual_sensor
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
get_virtual_sensor_information
(
sensor_type
context
=
null
)
{
throw
new
Error
(
"
get_virtual_sensor_information
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
set_device_posture
(
posture
context
=
null
)
{
throw
new
Error
(
"
set_device_posture
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
clear_device_posture
(
context
=
null
)
{
throw
new
Error
(
"
clear_device_posture
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
run_bounce_tracking_mitigations
(
context
=
null
)
{
throw
new
Error
(
"
run_bounce_tracking_mitigations
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
create_virtual_pressure_source
(
source_type
metadata
=
{
}
context
=
null
)
{
throw
new
Error
(
"
create_virtual_pressure_source
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
update_virtual_pressure_source
(
source_type
sample
context
=
null
)
{
throw
new
Error
(
"
update_virtual_pressure_source
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
async
remove_virtual_pressure_source
(
source_type
context
=
null
)
{
throw
new
Error
(
"
remove_virtual_pressure_source
(
)
is
not
implemented
by
testdriver
-
vendor
.
js
"
)
;
}
}
;
}
)
(
)
;
