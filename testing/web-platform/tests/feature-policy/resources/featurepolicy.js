function
assert_feature_policy_supported
(
)
{
assert_not_equals
(
document
.
policy
undefined
'
Feature
Policy
is
supported
'
)
;
}
function
test_feature_availability
(
feature_description
test
src
expect_feature_available
feature_name
allow_attribute
)
{
let
frame
=
document
.
createElement
(
'
iframe
'
)
;
frame
.
src
=
src
;
if
(
typeof
feature_name
!
=
=
'
undefined
'
)
{
frame
.
allow
=
frame
.
allow
.
concat
(
"
;
"
+
feature_name
)
;
}
if
(
typeof
allow_attribute
!
=
=
'
undefined
'
)
{
frame
.
setAttribute
(
allow_attribute
true
)
;
}
window
.
addEventListener
(
'
message
'
test
.
step_func
(
function
handler
(
evt
)
{
if
(
evt
.
source
=
=
=
frame
.
contentWindow
)
{
expect_feature_available
(
evt
.
data
feature_description
)
;
document
.
body
.
removeChild
(
frame
)
;
window
.
removeEventListener
(
'
message
'
handler
)
;
test
.
done
(
)
;
}
}
)
)
;
document
.
body
.
appendChild
(
frame
)
;
}
function
expect_feature_available_default
(
data
feature_description
)
{
assert_true
(
data
.
enabled
feature_description
)
;
}
function
expect_feature_unavailable_default
(
data
feature_description
)
{
assert_false
(
data
.
enabled
feature_description
)
;
}
function
test_feature_availability_with_post_message_result
(
test
src
expected_result
allow_attribute
)
{
var
test_result
=
function
(
data
feature_description
)
{
assert_equals
(
data
expected_result
)
;
}
;
test_feature_availability
(
null
test
src
test_result
allow_attribute
)
;
}
function
test_feature_in_iframe
(
feature_name
feature_promise_factory
)
{
if
(
location
.
hash
.
includes
(
feature_name
)
)
{
feature_promise_factory
(
)
.
then
(
(
)
=
>
window
.
parent
.
postMessage
(
'
#
OK
'
'
*
'
)
(
e
)
=
>
window
.
parent
.
postMessage
(
'
#
'
+
e
.
name
'
*
'
)
)
;
}
}
function
page_loaded_in_iframe
(
)
{
return
location
.
hash
.
startsWith
(
'
#
iframe
'
)
;
}
function
same_origin_url
(
feature_name
)
{
return
location
.
pathname
+
'
#
iframe
#
'
+
feature_name
;
}
function
cross_origin_url
(
base_url
feature_name
)
{
return
base_url
+
same_origin_url
(
feature_name
)
;
}
function
run_all_fp_tests_allow_self
(
cross_origin
feature_name
error_name
feature_promise_factory
)
{
if
(
page_loaded_in_iframe
(
)
)
{
test_feature_in_iframe
(
feature_name
feature_promise_factory
)
;
return
;
}
promise_test
(
(
)
=
>
feature_promise_factory
(
)
'
Default
"
'
+
feature_name
+
'
"
feature
policy
[
"
self
"
]
allows
the
top
-
level
document
.
'
)
;
const
same_origin_frame_pathname
=
same_origin_url
(
feature_name
)
;
async_test
(
t
=
>
{
test_feature_availability_with_post_message_result
(
t
same_origin_frame_pathname
'
#
OK
'
)
;
}
'
Default
"
'
+
feature_name
+
'
"
feature
policy
[
"
self
"
]
allows
same
-
origin
iframes
.
'
)
;
const
cross_origin_frame_url
=
cross_origin_url
(
cross_origin
feature_name
)
;
async_test
(
t
=
>
{
test_feature_availability_with_post_message_result
(
t
cross_origin_frame_url
'
#
'
+
error_name
)
;
}
'
Default
"
'
+
feature_name
+
'
"
feature
policy
[
"
self
"
]
disallows
cross
-
origin
iframes
.
'
)
;
async_test
(
t
=
>
{
test_feature_availability_with_post_message_result
(
t
cross_origin_frame_url
'
#
OK
'
feature_name
)
;
}
'
Feature
policy
"
'
+
feature_name
+
'
"
can
be
enabled
in
cross
-
origin
iframes
using
"
allow
"
attribute
.
'
)
;
}
function
run_all_fp_tests_allow_all
(
cross_origin
feature_name
error_name
feature_promise_factory
)
{
if
(
page_loaded_in_iframe
(
)
)
{
test_feature_in_iframe
(
feature_name
feature_promise_factory
)
;
return
;
}
promise_test
(
(
)
=
>
feature_promise_factory
(
)
'
Default
"
'
+
feature_name
+
'
"
feature
policy
[
"
*
"
]
allows
the
top
-
level
document
.
'
)
;
const
same_origin_frame_pathname
=
same_origin_url
(
feature_name
)
;
async_test
(
t
=
>
{
test_feature_availability_with_post_message_result
(
t
same_origin_frame_pathname
'
#
OK
'
)
;
}
'
Default
"
'
+
feature_name
+
'
"
feature
policy
[
"
*
"
]
allows
same
-
origin
iframes
.
'
)
;
const
cross_origin_frame_url
=
cross_origin_url
(
cross_origin
feature_name
)
;
async_test
(
t
=
>
{
test_feature_availability_with_post_message_result
(
t
cross_origin_frame_url
'
#
OK
'
)
;
}
'
Default
"
'
+
feature_name
+
'
"
feature
policy
[
"
*
"
]
allows
cross
-
origin
iframes
.
'
)
;
async_test
(
t
=
>
{
test_feature_availability_with_post_message_result
(
t
cross_origin_frame_url
'
#
'
+
error_name
feature_name
+
"
'
none
'
"
)
;
}
'
Feature
policy
"
'
+
feature_name
+
'
"
can
be
disabled
in
cross
-
origin
iframes
using
"
allow
"
attribute
.
'
)
;
}
function
test_allowlists
(
expected_policy
policy
message
)
{
for
(
var
allowlist
of
allowlists
)
{
test
(
function
(
)
{
assert_array_equals
(
policy
.
getAllowlistForFeature
(
allowlist
.
feature
)
allowlist
.
allowlist
)
;
}
message
+
'
for
feature
'
+
allowlist
.
feature
)
;
}
}
function
test_allowed_feature_for_subframe
(
message
feature
src
allow
)
{
let
frame
=
document
.
createElement
(
'
iframe
'
)
;
if
(
typeof
allow
!
=
=
'
undefined
'
)
{
frame
.
allow
=
allow
;
}
promise_test
(
function
(
)
{
assert_feature_policy_supported
(
)
;
frame
.
src
=
src
;
return
new
Promise
(
function
(
resolve
reject
)
{
window
.
addEventListener
(
'
message
'
function
handler
(
evt
)
{
resolve
(
evt
.
data
)
;
}
{
once
:
true
}
)
;
document
.
body
.
appendChild
(
frame
)
;
}
)
.
then
(
function
(
data
)
{
assert_true
(
data
.
includes
(
feature
)
feature
)
;
}
)
;
}
message
)
;
}
function
test_disallowed_feature_for_subframe
(
message
feature
src
allow
)
{
let
frame
=
document
.
createElement
(
'
iframe
'
)
;
if
(
typeof
allow
!
=
=
'
undefined
'
)
{
frame
.
allow
=
allow
;
}
promise_test
(
function
(
)
{
assert_feature_policy_supported
(
)
;
frame
.
src
=
src
;
return
new
Promise
(
function
(
resolve
reject
)
{
window
.
addEventListener
(
'
message
'
function
handler
(
evt
)
{
resolve
(
evt
.
data
)
;
}
{
once
:
true
}
)
;
document
.
body
.
appendChild
(
frame
)
;
}
)
.
then
(
function
(
data
)
{
assert_false
(
data
.
includes
(
feature
)
feature
)
;
}
)
;
}
message
)
;
}
function
test_subframe_header_policy
(
feature
frame_header_policy
src
test_expects
test_name
)
{
let
frame
=
document
.
createElement
(
'
iframe
'
)
;
promise_test
(
function
(
)
{
assert_feature_policy_supported
(
)
frame
.
src
=
src
+
'
?
pipe
=
sub
|
header
(
Feature
-
Policy
'
+
feature
+
'
'
+
frame_header_policy
+
'
;
)
'
;
return
new
Promise
(
function
(
resolve
reject
)
{
let
results
=
[
]
;
window
.
addEventListener
(
'
message
'
function
handler
(
evt
)
{
results
.
push
(
evt
.
data
)
;
if
(
results
.
length
>
=
6
)
{
resolve
(
results
)
;
}
}
)
;
document
.
body
.
appendChild
(
frame
)
;
}
)
.
then
(
function
(
results
)
{
for
(
var
j
=
0
;
j
<
results
.
length
;
j
+
+
)
{
var
data
=
results
[
j
]
;
function
test_result
(
message
test_expect
)
{
if
(
test_expect
)
{
assert_true
(
data
.
allowedfeatures
.
includes
(
feature
)
message
)
;
}
else
{
assert_false
(
data
.
allowedfeatures
.
includes
(
feature
)
message
)
;
}
}
if
(
data
.
frame
=
=
=
'
local
'
)
{
if
(
data
.
policy
=
=
=
'
*
'
)
{
test_result
(
'
local_all
:
'
test_expects
.
local_all
)
;
}
if
(
data
.
policy
=
=
=
'
\
'
self
\
'
'
)
{
test_result
(
'
local_self
:
'
test_expects
.
local_self
)
;
}
if
(
data
.
policy
=
=
=
'
\
'
none
\
'
'
)
{
test_result
(
'
local_none
:
'
test_expects
.
local_none
)
;
}
}
if
(
data
.
frame
=
=
=
'
remote
'
)
{
if
(
data
.
policy
=
=
=
'
*
'
)
{
test_result
(
'
remote_all
:
'
test_expects
.
remote_all
)
;
}
if
(
data
.
policy
=
=
=
'
\
'
self
\
'
'
)
{
test_result
(
'
remote_self
:
'
test_expects
.
remote_self
)
;
}
if
(
data
.
policy
=
=
=
'
\
'
none
\
'
'
)
{
test_result
(
'
remote_none
:
'
test_expects
.
remote_none
)
;
}
}
}
}
)
;
}
test_name
)
;
}
function
test_frame_policy
(
feature
src
test_expect
allow
allowfullscreen
sandbox
)
{
let
frame
=
document
.
createElement
(
'
iframe
'
)
;
document
.
body
.
appendChild
(
frame
)
;
var
frame_policy
=
frame
.
policy
;
if
(
typeof
allow
!
=
=
'
undefined
'
)
{
frame
.
setAttribute
(
'
allow
'
allow
)
;
}
if
(
!
!
allowfullscreen
)
{
frame
.
setAttribute
(
'
allowfullscreen
'
true
)
;
}
if
(
!
!
sandbox
)
{
frame
.
setAttribute
(
'
sandbox
'
'
allow
-
scripts
'
)
;
}
frame
.
src
=
src
;
if
(
test_expect
)
{
assert_true
(
frame_policy
.
allowedFeatures
(
)
.
includes
(
feature
)
)
;
}
else
{
assert_false
(
frame_policy
.
allowedFeatures
(
)
.
includes
(
feature
)
)
;
}
}
