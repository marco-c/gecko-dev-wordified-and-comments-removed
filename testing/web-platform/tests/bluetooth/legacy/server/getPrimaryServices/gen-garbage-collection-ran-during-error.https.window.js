'
use
strict
'
;
const
test_desc
=
'
Garbage
Collection
ran
during
a
getPrimaryServices
'
+
'
call
that
failed
.
Should
not
crash
.
'
const
expected
=
new
DOMException
(
'
GATT
Server
is
disconnected
.
Cannot
retrieve
services
.
(
Re
)
connect
first
'
+
'
with
device
.
gatt
.
connect
.
'
'
NetworkError
'
)
;
let
promise
;
bluetooth_test
(
(
)
=
>
getEmptyHealthThermometerDevice
(
)
.
then
(
(
{
device
}
)
=
>
{
promise
=
assert_promise_rejects_with_message
(
device
.
gatt
.
getPrimaryServices
(
)
expected
)
;
device
.
gatt
.
disconnect
(
)
;
return
garbageCollect
(
)
;
}
)
.
then
(
(
)
=
>
promise
)
test_desc
)
;
