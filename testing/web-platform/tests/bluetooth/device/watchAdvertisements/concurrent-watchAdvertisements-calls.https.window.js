'
use
strict
'
;
const
test_desc
=
'
concurrent
watchAdvertisements
(
)
calls
results
in
the
'
+
second
call
rejecting
with
'
InvalidStateError
'
;
bluetooth_test
(
async
(
t
)
=
>
{
let
{
device
}
=
await
getDiscoveredHealthThermometerDevice
(
)
;
const
watcher
=
new
EventWatcher
(
t
device
[
'
advertisementreceived
'
]
)
;
let
firstWatchAdvertisementsPromise
=
device
.
watchAdvertisements
(
)
;
await
promise_rejects_dom
(
t
'
InvalidStateError
'
device
.
watchAdvertisements
(
)
)
;
await
firstWatchAdvertisementsPromise
;
let
advertisementreceivedPromise
=
watcher
.
wait_for
(
'
advertisementreceived
'
)
;
await
fake_central
.
simulateAdvertisementReceived
(
health_thermometer_ad_packet
)
;
let
evt
=
await
advertisementreceivedPromise
;
assert_equals
(
evt
.
device
device
)
;
}
test_desc
)
;
