'
use
strict
'
;
async
function
timeout
(
cmd
)
{
const
timer
=
new
Promise
(
(
resolve
reject
)
=
>
{
const
id
=
setTimeout
(
(
)
=
>
{
clearTimeout
(
id
)
reject
(
new
Error
(
"
Promise
timed
out
!
"
)
)
}
750
)
}
)
return
Promise
.
race
(
[
cmd
timer
]
)
}
promise_test
(
async
t
=
>
{
let
wt1
=
new
WebTransport
(
webtransport_url
(
query
.
py
?
token
=
{
token
(
)
}
)
)
;
const
weakref
=
new
WeakRef
(
wt1
)
;
const
wt2
=
new
WebTransport
(
webtransport_url
(
query
.
py
?
token
=
{
token
(
)
}
)
)
;
t
.
add_cleanup
(
(
)
=
>
wt2
.
close
(
)
)
;
wt1
=
undefined
;
await
wt2
.
ready
;
await
garbageCollect
(
)
;
for
(
let
i
=
0
;
i
<
8
;
i
+
+
)
{
await
timeout
(
wt2
.
createBidirectionalStream
(
{
}
)
)
;
}
const
target
=
weakref
.
deref
(
)
;
if
(
target
!
=
=
undefined
)
{
try
{
await
timeout
(
target
.
ready
)
;
}
catch
(
e
)
{
}
}
}
'
WebTransport
garbage
collection
behavior
with
WeakRef
'
)
;
