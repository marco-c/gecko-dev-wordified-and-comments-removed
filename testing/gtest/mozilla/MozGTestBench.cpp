#
include
"
MozGTestBench
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
<
stdio
.
h
>
#
define
MOZ_GTEST_BENCH_FRAMEWORK
"
platform_microbench
"
using
mozilla
:
:
TimeStamp
;
namespace
mozilla
{
void
GTestBench
(
const
char
*
aSuite
const
char
*
aName
const
std
:
:
function
<
void
(
)
>
&
aTest
)
{
#
ifdef
DEBUG
aTest
(
)
;
#
else
bool
shouldAlert
=
bool
(
getenv
(
"
PERFHERDER_ALERTING_ENABLED
"
)
)
;
mozilla
:
:
TimeStamp
start
=
TimeStamp
:
:
Now
(
)
;
aTest
(
)
;
int
msDuration
=
(
TimeStamp
:
:
Now
(
)
-
start
)
.
ToMicroseconds
(
)
;
printf
(
"
PERFHERDER_DATA
:
{
\
"
framework
\
"
:
{
\
"
name
\
"
:
\
"
%
s
\
"
}
"
"
\
"
suites
\
"
:
[
{
\
"
name
\
"
:
\
"
%
s
\
"
\
"
subtests
\
"
:
"
"
[
{
\
"
name
\
"
:
\
"
%
s
\
"
\
"
value
\
"
:
%
i
\
"
lowerIsBetter
\
"
:
true
\
"
shouldAlert
\
"
:
%
s
}
]
"
"
}
]
}
\
n
"
MOZ_GTEST_BENCH_FRAMEWORK
aSuite
aName
msDuration
shouldAlert
?
"
true
"
:
"
false
"
)
;
#
endif
}
}
