#
include
"
MozGTestBench
.
h
"
#
include
"
mozilla
/
TimeStamp
.
h
"
#
include
<
stdio
.
h
>
#
include
<
string
>
#
include
<
vector
>
#
define
MOZ_GTEST_BENCH_FRAMEWORK
"
platform_microbench
"
#
define
MOZ_GTEST_NUM_ITERATIONS
5
namespace
mozilla
{
void
GTestBench
(
const
char
*
aSuite
const
char
*
aName
const
std
:
:
function
<
void
(
)
>
&
aTest
)
{
#
if
defined
(
DEBUG
)
|
|
defined
(
MOZ_ASAN
)
aTest
(
)
;
#
else
bool
shouldAlert
=
bool
(
getenv
(
"
PERFHERDER_ALERTING_ENABLED
"
)
)
;
std
:
:
vector
<
int
>
durations
;
int
iterations
;
if
(
!
getenv
(
"
MOZ_GTEST_NUM_ITERATIONS
"
)
|
|
(
iterations
=
atoi
(
getenv
(
"
MOZ_GTEST_NUM_ITERATIONS
"
)
)
)
=
=
0
)
iterations
=
MOZ_GTEST_NUM_ITERATIONS
;
for
(
int
i
=
0
;
i
<
iterations
;
i
+
+
)
{
mozilla
:
:
TimeStamp
start
=
TimeStamp
:
:
Now
(
)
;
aTest
(
)
;
durations
.
push_back
(
(
TimeStamp
:
:
Now
(
)
-
start
)
.
ToMicroseconds
(
)
)
;
}
std
:
:
string
replicatesStr
=
"
[
"
+
std
:
:
to_string
(
durations
[
0
]
)
;
for
(
int
i
=
1
;
i
<
iterations
;
i
+
+
)
{
replicatesStr
+
=
"
"
+
std
:
:
to_string
(
durations
[
i
]
)
;
}
replicatesStr
+
=
"
]
"
;
std
:
:
sort
(
durations
.
begin
(
)
durations
.
end
(
)
)
;
int
medianIndex
=
(
iterations
/
2
)
+
(
(
iterations
%
2
=
=
0
)
?
(
-
1
)
:
0
)
;
printf
(
"
PERFHERDER_DATA
:
{
\
"
framework
\
"
:
{
\
"
name
\
"
:
\
"
%
s
\
"
}
"
"
\
"
suites
\
"
:
[
{
\
"
name
\
"
:
\
"
%
s
\
"
\
"
subtests
\
"
:
"
"
[
{
\
"
name
\
"
:
\
"
%
s
\
"
\
"
value
\
"
:
%
i
\
"
replicates
\
"
:
%
s
"
"
\
"
lowerIsBetter
\
"
:
true
\
"
shouldAlert
\
"
:
%
s
}
]
"
"
}
]
}
\
n
"
MOZ_GTEST_BENCH_FRAMEWORK
aSuite
aName
durations
[
medianIndex
]
replicatesStr
.
c_str
(
)
shouldAlert
?
"
true
"
:
"
false
"
)
;
#
endif
}
}
