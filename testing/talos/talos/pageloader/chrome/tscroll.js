function
testScroll
(
target
stepSize
opt_reportFunc
opt_numSteps
)
{
var
win
;
if
(
target
=
=
"
content
"
)
{
target
=
content
.
wrappedJSObject
;
win
=
content
;
}
else
{
win
=
window
;
}
var
result
=
{
names
:
[
]
values
:
[
]
}
;
var
href
=
win
.
location
.
href
;
var
testBaseName
=
href
.
split
(
"
/
tp5n
/
"
)
[
1
]
|
|
href
.
split
(
"
/
"
)
.
pop
(
)
|
|
href
.
split
(
"
/
"
)
.
splice
(
-
2
1
)
[
0
]
|
|
"
REALLY_WEIRD_URI
"
;
TalosPowersParent
=
{
replyId
:
1
exec
(
commandName
arg
callback
opt_custom_window
)
{
let
win
=
opt_custom_window
|
|
window
;
let
replyEvent
=
"
TalosPowers
:
ParentExec
:
ReplyEvent
:
"
+
this
.
replyId
+
+
;
if
(
callback
)
{
win
.
addEventListener
(
replyEvent
function
(
e
)
{
callback
(
e
.
detail
)
;
}
{
once
:
true
}
)
;
}
win
.
dispatchEvent
(
new
win
.
CustomEvent
(
"
TalosPowers
:
ParentExec
:
QueryEvent
"
{
bubbles
:
true
detail
:
{
command
:
{
name
:
commandName
data
:
arg
}
listeningTo
:
replyEvent
}
}
)
)
;
}
}
;
var
report
;
function
P_setupReportFn
(
)
{
return
new
Promise
(
function
(
resolve
)
{
report
=
opt_reportFunc
|
|
win
.
tpRecordTime
;
if
(
report
=
=
"
PageLoader
:
RecordTime
"
)
{
report
=
function
(
duration
start
name
)
{
var
msg
=
{
time
:
duration
startTime
:
start
testName
:
name
}
;
sendAsyncMessage
(
"
PageLoader
:
RecordTime
"
msg
)
;
}
;
resolve
(
)
;
return
;
}
if
(
!
report
&
&
document
.
head
)
{
var
imported
=
document
.
createElement
(
"
script
"
)
;
imported
.
addEventListener
(
"
load
"
function
(
)
{
report
=
tpRecordTime
;
resolve
(
)
;
}
)
;
imported
.
src
=
"
.
.
/
.
.
/
scripts
/
talos
-
debug
.
js
?
dummy
=
"
+
Date
.
now
(
)
;
document
.
head
.
appendChild
(
imported
)
;
return
;
}
resolve
(
)
;
}
)
;
}
function
FP_wait
(
ms
)
{
return
function
(
)
{
return
new
Promise
(
function
(
resolve
)
{
setTimeout
(
resolve
ms
)
;
}
)
;
}
;
}
function
rAF
(
fn
)
{
return
win
.
requestAnimationFrame
(
fn
)
;
}
function
P_rAF
(
)
{
return
new
Promise
(
function
(
resolve
)
{
rAF
(
resolve
)
;
}
)
;
}
function
P_MozAfterPaint
(
)
{
return
new
Promise
(
function
(
resolve
)
{
win
.
addEventListener
(
"
MozAfterPaint
"
(
)
=
>
resolve
(
)
{
once
:
true
}
)
;
}
)
;
}
function
myNow
(
)
{
return
win
.
performance
&
&
win
.
performance
.
now
?
win
.
performance
.
now
(
)
:
Date
.
now
(
)
;
}
var
isWindow
=
target
.
self
=
=
=
target
;
var
getPos
=
isWindow
?
function
(
)
{
return
target
.
pageYOffset
;
}
:
function
(
)
{
return
target
.
scrollTop
;
}
;
var
gotoTop
=
isWindow
?
function
(
)
{
target
.
scroll
(
0
0
)
;
ensureScroll
(
)
;
}
:
function
(
)
{
target
.
scrollTop
=
0
;
ensureScroll
(
)
;
}
;
var
doScrollTick
=
isWindow
?
function
(
)
{
target
.
scrollBy
(
0
stepSize
)
;
ensureScroll
(
)
;
}
:
function
(
)
{
target
.
scrollTop
+
=
stepSize
;
ensureScroll
(
)
;
}
;
var
setSmooth
=
isWindow
?
function
(
)
{
target
.
document
.
scrollingElement
.
style
.
scrollBehavior
=
"
smooth
"
;
}
:
function
(
)
{
target
.
style
.
scrollBehavior
=
"
smooth
"
;
}
;
var
gotoBottom
=
isWindow
?
function
(
)
{
target
.
scrollTo
(
0
target
.
scrollMaxY
)
;
}
:
function
(
)
{
target
.
scrollTop
=
target
.
scrollHeight
;
}
;
function
ensureScroll
(
)
{
if
(
!
this
.
dummyEnsureScroll
)
{
this
.
dummyEnsureScroll
=
1
;
}
this
.
dummyEnsureScroll
+
=
win
.
screenY
+
getPos
(
)
;
}
function
P_syncScrollTest
(
)
{
return
new
Promise
(
function
(
resolve
)
{
var
start
=
myNow
(
)
;
var
lastScrollPos
=
getPos
(
)
;
var
lastScrollTime
=
start
;
var
durations
=
[
]
;
function
tick
(
)
{
var
now
=
myNow
(
)
;
var
duration
=
now
-
lastScrollTime
;
lastScrollTime
=
now
;
durations
.
push
(
duration
)
;
doScrollTick
(
)
;
if
(
getPos
(
)
=
=
lastScrollPos
|
|
(
opt_numSteps
&
&
durations
.
length
>
=
opt_numSteps
+
2
)
)
{
let
profilerPaused
=
Promise
.
resolve
(
)
;
if
(
typeof
TalosContentProfiler
!
=
=
"
undefined
"
)
{
profilerPaused
=
TalosContentProfiler
.
pause
(
testBaseName
true
)
;
}
profilerPaused
.
then
(
(
)
=
>
{
durations
.
pop
(
)
;
durations
.
pop
(
)
;
if
(
win
.
talosDebug
)
{
win
.
talosDebug
.
displayData
=
true
;
}
var
sum
=
0
;
for
(
var
i
=
0
;
i
<
durations
.
length
;
i
+
+
)
{
sum
+
=
Number
(
durations
[
i
]
)
;
}
result
.
values
.
push
(
durations
.
length
?
sum
/
durations
.
length
:
0
)
;
result
.
names
.
push
(
testBaseName
)
;
resolve
(
)
;
}
)
;
return
;
}
lastScrollPos
=
getPos
(
)
;
P_MozAfterPaint
(
)
.
then
(
tick
)
;
}
if
(
typeof
TalosContentProfiler
!
=
=
"
undefined
"
)
{
TalosContentProfiler
.
resume
(
testBaseName
true
)
.
then
(
(
)
=
>
{
rAF
(
tick
)
;
}
)
;
}
}
)
;
}
function
P_testAPZScroll
(
)
{
var
APZ_MEASURE_MS
=
1000
;
function
startFrameTimeRecording
(
cb
)
{
TalosPowersParent
.
exec
(
"
startFrameTimeRecording
"
null
cb
win
)
;
}
function
stopFrameTimeRecording
(
handle
cb
)
{
TalosPowersParent
.
exec
(
"
stopFrameTimeRecording
"
handle
cb
win
)
;
}
return
new
Promise
(
function
(
resolve
reject
)
{
setSmooth
(
)
;
var
handle
=
-
1
;
startFrameTimeRecording
(
function
(
rv
)
{
handle
=
rv
;
}
)
;
setTimeout
(
function
(
)
{
stopFrameTimeRecording
(
handle
function
(
intervals
)
{
function
average
(
arr
)
{
var
sum
=
0
;
for
(
var
i
=
0
;
i
<
arr
.
length
;
i
+
+
)
{
sum
+
=
arr
[
i
]
;
}
return
arr
.
length
?
sum
/
arr
.
length
:
0
;
}
result
.
values
.
push
(
average
(
intervals
.
slice
(
2
intervals
.
length
-
2
)
)
)
;
result
.
names
.
push
(
"
CSSOM
.
"
+
testBaseName
)
;
resolve
(
)
;
}
)
;
}
APZ_MEASURE_MS
)
;
gotoBottom
(
)
;
}
)
;
}
P_setupReportFn
(
)
.
then
(
FP_wait
(
260
)
)
.
then
(
gotoTop
)
.
then
(
P_rAF
)
.
then
(
P_syncScrollTest
)
.
then
(
gotoTop
)
.
then
(
FP_wait
(
260
)
)
.
then
(
P_testAPZScroll
)
.
then
(
function
(
)
{
report
(
result
.
values
.
join
(
"
"
)
0
result
.
names
.
join
(
"
"
)
)
;
}
)
;
}
try
{
function
handleMessageFromChrome
(
message
)
{
var
payload
=
message
.
data
.
details
;
testScroll
(
payload
.
target
payload
.
stepSize
"
PageLoader
:
RecordTime
"
payload
.
opt_numSteps
)
;
}
addMessageListener
(
"
PageLoader
:
ScrollTest
"
handleMessageFromChrome
)
;
}
catch
(
e
)
{
}
