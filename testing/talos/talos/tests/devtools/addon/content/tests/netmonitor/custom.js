"
use
strict
"
;
const
{
openToolboxAndLog
reloadPageAndLog
closeToolboxAndLog
testSetup
testTeardown
PAGES_BASE_URL
}
=
require
(
"
damp
-
test
/
tests
/
head
"
)
;
const
{
exportHar
waitForNetworkRequests
}
=
require
(
"
damp
-
test
/
tests
/
netmonitor
/
netmonitor
-
helpers
"
)
;
const
bigFileRequests
=
20
postDataRequests
=
20
xhrRequests
=
50
;
const
expectedSyncCssRequests
=
10
expectedSyncJSRequests
=
10
;
const
expectedSyncIframeRequests
=
2
*
10
+
1
;
const
expectedRequests
=
1
+
expectedSyncCssRequests
+
expectedSyncJSRequests
+
expectedSyncIframeRequests
+
bigFileRequests
+
postDataRequests
+
xhrRequests
;
const
CUSTOM_URL
=
PAGES_BASE_URL
+
"
custom
/
netmonitor
/
index
.
html
"
;
module
.
exports
=
async
function
(
)
{
const
url
=
CUSTOM_URL
+
?
bigFileRequests
=
{
bigFileRequests
}
&
postDataRequests
=
{
postDataRequests
}
&
xhrRequests
=
{
xhrRequests
}
;
let
tab
=
await
testSetup
(
url
)
;
let
{
messageManager
}
=
tab
.
linkedBrowser
;
let
onReady
=
new
Promise
(
done
=
>
{
messageManager
.
addMessageListener
(
"
ready
"
done
)
;
}
)
;
messageManager
.
loadFrameScript
(
"
data
:
(
"
+
encodeURIComponent
(
function
(
)
{
if
(
content
.
wrappedJSObject
.
isReady
)
{
sendAsyncMessage
(
"
ready
"
)
;
}
else
{
content
.
addEventListener
(
"
message
"
function
(
)
{
sendAsyncMessage
(
"
ready
"
)
;
}
)
;
}
}
)
+
"
)
(
)
"
true
)
;
dump
(
"
Waiting
for
document
to
be
ready
and
have
sent
all
its
requests
\
n
"
)
;
await
onReady
;
const
toolbox
=
await
openToolboxAndLog
(
"
custom
.
netmonitor
"
"
netmonitor
"
)
;
dump
(
"
Waiting
for
idle
in
order
to
ensure
running
reload
with
a
waterfall
\
n
"
)
;
let
window
=
toolbox
.
getCurrentPanel
(
)
.
panelWin
;
await
new
Promise
(
done
=
>
{
window
.
requestIdleCallback
(
done
)
;
}
)
;
const
requestsDone
=
waitForNetworkRequests
(
"
custom
.
netmonitor
"
toolbox
expectedRequests
expectedRequests
)
;
await
reloadPageAndLog
(
"
custom
.
netmonitor
"
toolbox
)
;
await
requestsDone
;
await
exportHar
(
"
custom
.
netmonitor
"
toolbox
)
;
await
closeToolboxAndLog
(
"
custom
.
netmonitor
"
toolbox
)
;
await
new
Promise
(
r
=
>
setTimeout
(
r
1000
)
)
;
await
testTeardown
(
)
;
}
;
