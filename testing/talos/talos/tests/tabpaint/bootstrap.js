var
{
classes
:
Cc
interfaces
:
Ci
utils
:
Cu
}
=
Components
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
gre
/
modules
/
Task
.
jsm
"
)
;
Cu
.
import
(
"
resource
:
/
/
/
modules
/
RecentWindow
.
jsm
"
)
;
const
TAB_ANIMATION_PREF
=
"
browser
.
tabs
.
animate
"
;
const
PROCESS_COUNT_PREF
=
"
dom
.
ipc
.
processCount
"
;
const
TARGET_URI
=
"
chrome
:
/
/
tabpaint
/
content
/
target
.
html
"
;
var
TabPaint
=
{
MESSAGES
:
[
"
TabPaint
:
Go
"
"
TabPaint
:
Painted
"
]
originalTabsAnimate
:
null
paintCallback
:
null
get
Profiler
(
)
{
delete
this
.
Profiler
;
let
context
=
{
}
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
talos
-
powers
-
content
/
content
/
TalosParentProfiler
.
js
"
context
)
;
return
this
.
Profiler
=
context
.
TalosParentProfiler
;
}
init
(
)
{
for
(
let
msgName
of
this
.
MESSAGES
)
{
Services
.
mm
.
addMessageListener
(
msgName
this
)
;
}
this
.
originalTabsAnimate
=
Services
.
prefs
.
getBoolPref
(
TAB_ANIMATION_PREF
)
;
Services
.
prefs
.
setBoolPref
(
TAB_ANIMATION_PREF
false
)
;
this
.
originalProcessCount
=
Services
.
prefs
.
getIntPref
(
PROCESS_COUNT_PREF
)
;
Services
.
prefs
.
setIntPref
(
PROCESS_COUNT_PREF
1
)
;
}
uninit
(
)
{
for
(
let
msgName
of
this
.
MESSAGES
)
{
Services
.
mm
.
removeMessageListener
(
msgName
this
)
;
}
Services
.
prefs
.
setBoolPref
(
TAB_ANIMATION_PREF
this
.
originalTabsAnimate
)
;
Services
.
prefs
.
setIntPref
(
PROCESS_COUNT_PREF
this
.
originalProcessCount
)
;
}
receiveMessage
(
msg
)
{
let
browser
=
msg
.
target
;
let
gBrowser
=
browser
.
ownerGlobal
.
gBrowser
;
switch
(
msg
.
name
)
{
case
"
TabPaint
:
Go
"
:
{
this
.
go
(
gBrowser
)
.
then
(
(
results
)
=
>
{
this
.
reportResults
(
results
)
;
}
)
;
break
;
}
case
"
TabPaint
:
Painted
"
:
{
if
(
!
this
.
paintCallback
)
{
throw
new
Error
(
"
TabPaint
:
Painted
fired
without
a
paintCallback
set
"
)
;
}
let
tab
=
gBrowser
.
getTabForBrowser
(
browser
)
;
let
delta
=
msg
.
data
.
delta
;
this
.
paintCallback
(
{
tab
delta
}
)
;
break
;
}
}
}
go
:
Task
.
async
(
function
*
(
gBrowser
)
{
let
fromParent
=
yield
this
.
openTabFromParent
(
gBrowser
)
;
let
fromContent
=
yield
this
.
openTabFromContent
(
gBrowser
)
;
return
{
fromParent
fromContent
}
;
}
)
openTabFromParent
(
gBrowser
)
{
let
win
=
gBrowser
.
ownerGlobal
;
return
new
Promise
(
(
resolve
)
=
>
{
this
.
Profiler
.
resume
(
"
tabpaint
parent
start
"
)
;
gBrowser
.
selectedTab
=
gBrowser
.
addTab
(
TARGET_URI
+
"
?
"
+
Date
.
now
(
)
)
;
this
.
whenTabShown
(
)
.
then
(
(
{
tab
delta
}
)
=
>
{
this
.
Profiler
.
pause
(
"
tabpaint
parent
end
"
)
;
this
.
removeTab
(
tab
)
.
then
(
(
)
=
>
{
resolve
(
delta
)
;
}
)
;
}
)
;
}
)
;
}
openTabFromContent
(
gBrowser
)
{
let
win
=
gBrowser
.
ownerGlobal
;
return
new
Promise
(
(
resolve
)
=
>
{
this
.
Profiler
.
resume
(
"
tabpaint
content
start
"
)
;
Services
.
mm
.
broadcastAsyncMessage
(
"
TabPaint
:
OpenFromContent
"
)
;
this
.
whenTabShown
(
)
.
then
(
(
{
tab
delta
}
)
=
>
{
this
.
Profiler
.
pause
(
"
tabpaint
content
end
"
)
;
this
.
removeTab
(
tab
)
.
then
(
(
)
=
>
{
resolve
(
delta
)
;
}
)
;
}
)
;
}
)
;
}
whenTabShown
(
)
{
return
new
Promise
(
(
resolve
)
=
>
{
this
.
paintCallback
=
resolve
;
}
)
;
}
removeTab
(
tab
)
{
return
new
Promise
(
(
resolve
)
=
>
{
let
{
messageManager
:
mm
frameLoader
}
=
tab
.
linkedBrowser
;
mm
.
addMessageListener
(
"
SessionStore
:
update
"
function
onMessage
(
msg
)
{
if
(
msg
.
targetFrameLoader
=
=
frameLoader
&
&
msg
.
data
.
isFinal
)
{
mm
.
removeMessageListener
(
"
SessionStore
:
update
"
onMessage
)
;
resolve
(
)
;
}
}
true
)
;
tab
.
ownerDocument
.
defaultView
.
gBrowser
.
removeTab
(
tab
)
;
}
)
;
}
reportResults
(
results
)
{
Services
.
mm
.
broadcastAsyncMessage
(
"
TabPaint
:
FinalResults
"
results
)
;
}
}
;
function
install
(
aData
aReason
)
{
}
function
startup
(
aData
aReason
)
{
TabPaint
.
init
(
)
;
}
function
shutdown
(
aData
aReason
)
{
TabPaint
.
uninit
(
)
;
}
function
uninstall
(
aData
aReason
)
{
}
