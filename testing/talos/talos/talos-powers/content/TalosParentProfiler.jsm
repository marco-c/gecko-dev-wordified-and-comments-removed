var
EXPORTED_SYMBOLS
=
[
"
TalosParentProfiler
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
TalosParentProfiler
=
{
initted
:
false
currentTest
:
"
unknown
"
interval
:
undefined
entries
:
undefined
featuresArray
:
undefined
threadsArray
:
undefined
profileDir
:
undefined
get
TalosPowers
(
)
{
return
Cc
[
"
mozilla
.
org
/
talos
/
talos
-
powers
-
service
;
1
"
]
.
getService
(
Ci
.
nsISupports
)
.
wrappedJSObject
;
}
initFromObject
(
obj
=
{
}
)
{
if
(
!
this
.
initted
)
{
if
(
"
gecko_profile_dir
"
in
obj
&
&
typeof
obj
.
gecko_profile_dir
=
=
"
string
"
&
&
"
gecko_profile_interval
"
in
obj
&
&
Number
.
isFinite
(
obj
.
gecko_profile_interval
*
1
)
&
&
"
gecko_profile_entries
"
in
obj
&
&
Number
.
isFinite
(
obj
.
gecko_profile_entries
*
1
)
&
&
"
gecko_profile_features
"
in
obj
&
&
typeof
obj
.
gecko_profile_features
=
=
"
string
"
&
&
"
gecko_profile_threads
"
in
obj
&
&
typeof
obj
.
gecko_profile_threads
=
=
"
string
"
)
{
this
.
interval
=
obj
.
gecko_profile_interval
;
this
.
entries
=
obj
.
gecko_profile_entries
;
this
.
featuresArray
=
obj
.
gecko_profile_features
.
split
(
"
"
)
;
this
.
threadsArray
=
obj
.
gecko_profile_threads
.
split
(
"
"
)
;
this
.
profileDir
=
obj
.
gecko_profile_dir
;
this
.
initted
=
true
;
}
else
{
console
.
error
(
"
Profiler
could
not
init
with
object
:
"
+
JSON
.
stringify
(
obj
)
)
;
}
}
}
initFromURLQueryParams
(
locationSearch
)
{
this
.
initFromObject
(
this
.
searchToObject
(
locationSearch
)
)
;
}
searchToObject
(
locationSearch
)
{
let
pairs
=
locationSearch
.
substring
(
1
)
.
split
(
"
&
"
)
;
let
result
=
{
}
;
for
(
let
i
in
pairs
)
{
if
(
pairs
[
i
]
!
=
=
"
"
)
{
let
pair
=
pairs
[
i
]
.
split
(
"
=
"
)
;
result
[
decodeURIComponent
(
pair
[
0
]
)
]
=
decodeURIComponent
(
pair
[
1
]
|
|
"
"
)
;
}
}
return
result
;
}
beginTest
(
testName
)
{
if
(
this
.
initted
)
{
this
.
currentTest
=
testName
;
this
.
TalosPowers
.
profilerBegin
(
{
entries
:
this
.
entries
interval
:
this
.
interval
featuresArray
:
this
.
featuresArray
threadsArray
:
this
.
threadsArray
}
)
;
}
else
{
let
msg
=
"
You
should
not
call
beginTest
without
having
first
"
+
"
initted
the
Profiler
"
;
console
.
error
(
msg
)
;
}
}
finishTest
(
)
{
if
(
this
.
initted
)
{
let
profileFile
=
this
.
profileDir
+
"
/
"
+
this
.
currentTest
+
"
.
profile
"
;
return
this
.
TalosPowers
.
profilerFinish
(
profileFile
)
;
}
let
msg
=
"
You
should
not
call
finishTest
without
having
first
"
+
"
initted
the
Profiler
"
;
console
.
error
(
msg
)
;
return
Promise
.
reject
(
msg
)
;
}
finishStartupProfiling
(
)
{
if
(
this
.
initted
)
{
let
profileFile
=
this
.
profileDir
+
"
/
startup
.
profile
"
;
return
this
.
TalosPowers
.
profilerFinish
(
profileFile
)
;
}
return
Promise
.
resolve
(
)
;
}
resume
(
marker
=
"
"
)
{
if
(
this
.
initted
)
{
this
.
TalosPowers
.
profilerResume
(
marker
)
;
}
}
pause
(
marker
=
"
"
startTime
=
undefined
)
{
if
(
this
.
initted
)
{
this
.
TalosPowers
.
profilerPause
(
marker
startTime
)
;
}
}
mark
(
marker
startTime
=
undefined
)
{
if
(
this
.
initted
)
{
if
(
!
marker
)
{
marker
=
this
.
currentTest
;
}
this
.
TalosPowers
.
addIntervalMarker
(
marker
startTime
)
;
}
}
afterProfileGathered
(
)
{
if
(
!
this
.
initted
)
{
return
Promise
.
resolve
(
)
;
}
return
new
Promise
(
resolve
=
>
{
Services
.
obs
.
addObserver
(
function
onGathered
(
)
{
Services
.
obs
.
removeObserver
(
onGathered
"
talos
-
profile
-
gathered
"
)
;
resolve
(
)
;
}
"
talos
-
profile
-
gathered
"
)
;
}
)
;
}
}
;
