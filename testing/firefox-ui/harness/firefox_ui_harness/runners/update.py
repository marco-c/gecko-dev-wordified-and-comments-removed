import
os
import
sys
import
mozfile
import
mozinstall
from
firefox_ui_harness
.
runners
import
FirefoxUITestRunner
from
firefox_ui_harness
.
testcases
import
UpdateTestCase
DEFAULT_PREFS
=
{
    
'
app
.
update
.
disabledForTesting
'
:
False
    
'
app
.
update
.
doorhanger
'
:
False
    
'
app
.
update
.
log
'
:
True
    
'
app
.
update
.
staging
.
enabled
'
:
True
    
'
startup
.
homepage_override_url
'
:
'
about
:
blank
'
}
class
UpdateTestRunner
(
FirefoxUITestRunner
)
:
    
def
__init__
(
self
*
*
kwargs
)
:
        
super
(
UpdateTestRunner
self
)
.
__init__
(
*
*
kwargs
)
        
self
.
original_bin
=
self
.
bin
        
self
.
prefs
.
update
(
DEFAULT_PREFS
)
        
self
.
run_direct_update
=
not
kwargs
.
pop
(
'
update_fallback_only
'
False
)
        
self
.
run_fallback_update
=
not
kwargs
.
pop
(
'
update_direct_only
'
False
)
        
self
.
test_handlers
=
[
UpdateTestCase
]
        
os
.
environ
[
'
MOZ_MARIONETTE
'
]
=
'
1
'
    
def
run_tests
(
self
tests
)
:
        
self
.
exc_info
=
None
        
failed
=
0
        
source_folder
=
self
.
get_application_folder
(
self
.
original_bin
)
        
results
=
{
}
        
def
_run_tests
(
tags
)
:
            
application_folder
=
None
            
try
:
                
test_tags
=
self
.
test_tags
                
application_folder
=
self
.
duplicate_application
(
source_folder
)
                
self
.
bin
=
mozinstall
.
get_binary
(
application_folder
'
Firefox
'
)
                
self
.
test_tags
=
tags
                
super
(
UpdateTestRunner
self
)
.
run_tests
(
tests
)
            
except
Exception
:
                
self
.
exc_info
=
sys
.
exc_info
(
)
                
self
.
logger
.
error
(
'
Failure
during
execution
of
the
update
test
.
'
                                  
exc_info
=
self
.
exc_info
)
            
finally
:
                
self
.
test_tags
=
test_tags
                
self
.
logger
.
info
(
'
Removing
copy
of
the
application
at
"
%
s
"
'
%
application_folder
)
                
try
:
                    
mozfile
.
remove
(
application_folder
)
                
except
IOError
as
e
:
                    
self
.
logger
.
error
(
'
Cannot
remove
copy
of
application
:
"
%
s
"
'
%
str
(
e
)
)
        
if
self
.
run_direct_update
:
            
_run_tests
(
tags
=
[
'
direct
'
]
)
            
failed
+
=
self
.
failed
            
results
[
'
Direct
'
]
=
False
if
self
.
failed
else
True
        
if
self
.
run_fallback_update
:
            
_run_tests
(
tags
=
[
'
fallback
'
]
)
            
failed
+
=
self
.
failed
            
results
[
'
Fallback
'
]
=
False
if
self
.
failed
else
True
        
self
.
logger
.
info
(
"
Summary
of
update
tests
:
"
)
        
for
test_type
result
in
results
.
iteritems
(
)
:
            
self
.
logger
.
info
(
"
\
t
%
s
update
test
ran
and
%
s
"
%
                             
(
test_type
'
PASSED
'
if
result
else
'
FAILED
'
)
)
        
self
.
failed
=
failed
        
if
self
.
exc_info
:
            
ex_type
exception
tb
=
self
.
exc_info
            
raise
ex_type
exception
tb
