import
os
import
re
from
firefox_ui_harness
.
testcases
import
FirefoxTestCase
from
marionette_driver
import
Wait
class
TestSafeBrowsingInitialDownload
(
FirefoxTestCase
)
:
    
test_data
=
[
{
        
'
platforms
'
:
[
'
linux
'
'
windows_nt
'
'
darwin
'
]
        
'
files
'
:
[
            
r
'
goog
-
badbinurl
-
shavar
.
pset
'
            
r
'
goog
-
badbinurl
-
shavar
.
sbstore
'
            
r
'
goog
-
malware
-
shavar
.
pset
'
            
r
'
goog
-
malware
-
shavar
.
sbstore
'
            
r
'
goog
(
pub
)
?
-
phish
-
shavar
.
pset
'
            
r
'
goog
(
pub
)
?
-
phish
-
shavar
.
sbstore
'
            
r
'
goog
-
unwanted
-
shavar
.
pset
'
            
r
'
goog
-
unwanted
-
shavar
.
sbstore
'
            
r
'
base
-
track
-
digest256
.
pset
'
            
r
'
base
-
track
-
digest256
.
sbstore
'
            
r
'
mozstd
-
trackwhite
-
digest256
.
pset
'
            
r
'
mozstd
-
trackwhite
-
digest256
.
sbstore
'
        
]
    
}
{
        
'
platforms
'
:
[
'
windows_nt
'
]
        
'
files
'
:
[
            
r
'
goog
-
downloadwhite
-
digest256
.
pset
'
            
r
'
goog
-
downloadwhite
-
digest256
.
sbstore
'
        
]
    
}
    
]
    
browser_prefs
=
{
        
'
browser
.
safebrowsing
.
downloads
.
enabled
'
:
'
true
'
        
'
browser
.
safebrowsing
.
phishing
.
enabled
'
:
'
true
'
        
'
browser
.
safebrowsing
.
malware
.
enabled
'
:
'
true
'
        
'
browser
.
safebrowsing
.
provider
.
google
.
nextupdatetime
'
:
1
        
'
browser
.
safebrowsing
.
provider
.
mozilla
.
nextupdatetime
'
:
1
        
'
privacy
.
trackingprotection
.
enabled
'
:
'
true
'
        
'
privacy
.
trackingprotection
.
pbmode
.
enabled
'
:
'
true
'
    
}
    
def
setUp
(
self
)
:
        
FirefoxTestCase
.
setUp
(
self
)
        
self
.
marionette
.
enforce_gecko_prefs
(
self
.
browser_prefs
)
        
self
.
sb_files_path
=
os
.
path
.
join
(
self
.
marionette
.
instance
.
profile
.
profile
'
safebrowsing
'
)
    
def
tearDown
(
self
)
:
        
try
:
            
self
.
restart
(
clean
=
True
)
        
finally
:
            
FirefoxTestCase
.
tearDown
(
self
)
    
def
test_safe_browsing_initial_download
(
self
)
:
        
wait
=
Wait
(
self
.
marionette
timeout
=
self
.
browser
.
timeout_page_load
                    
ignored_exceptions
=
[
OSError
]
)
        
for
data
in
self
.
test_data
:
            
if
self
.
platform
not
in
data
[
'
platforms
'
]
:
                
continue
            
for
item
in
data
[
'
files
'
]
:
                
wait
.
until
(
                    
lambda
_
:
[
f
for
f
in
os
.
listdir
(
self
.
sb_files_path
)
if
re
.
search
(
item
f
)
]
                    
message
=
'
Safe
Browsing
File
:
{
}
not
found
!
'
.
format
(
item
)
)
