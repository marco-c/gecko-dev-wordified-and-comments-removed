"
use
strict
"
;
loadScripts
(
{
name
:
"
role
.
js
"
dir
:
MOCHITESTS_DIR
}
{
name
:
"
states
.
js
"
dir
:
MOCHITESTS_DIR
}
)
;
function
getMacAccessible
(
accOrElmOrID
)
{
return
new
Promise
(
resolve
=
>
{
let
intervalId
=
setInterval
(
(
)
=
>
{
let
acc
=
getAccessible
(
accOrElmOrID
)
;
if
(
acc
)
{
clearInterval
(
intervalId
)
;
resolve
(
acc
.
nativeInterface
.
QueryInterface
(
Ci
.
nsIAccessibleMacInterface
)
)
;
}
}
10
)
;
}
)
;
}
add_task
(
async
(
)
=
>
{
let
newTabs
=
await
Promise
.
all
(
[
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Two
<
/
title
>
"
)
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Three
<
/
title
>
"
)
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Four
<
/
title
>
"
)
]
)
;
is
(
gBrowser
.
tabs
.
length
4
"
We
now
have
4
open
tabs
"
)
;
let
tablist
=
await
getMacAccessible
(
"
tabbrowser
-
tabs
"
)
;
is
(
tablist
.
getAttributeValue
(
"
AXRole
"
)
"
AXTabGroup
"
"
Correct
role
for
tablist
"
)
;
let
tabMacAccs
=
tablist
.
getAttributeValue
(
"
AXTabs
"
)
;
is
(
tabMacAccs
.
length
4
"
4
items
in
AXTabs
"
)
;
let
selectedTabs
=
tablist
.
getAttributeValue
(
"
AXSelectedChildren
"
)
;
is
(
selectedTabs
.
length
1
"
one
selected
tab
"
)
;
let
tab
=
selectedTabs
[
0
]
;
is
(
tab
.
getAttributeValue
(
"
AXRole
"
)
"
AXRadioButton
"
"
Correct
role
for
tab
"
)
;
is
(
tab
.
getAttributeValue
(
"
AXSubrole
"
)
"
AXTabButton
"
"
Correct
subrole
for
tab
"
)
;
is
(
tab
.
getAttributeValue
(
"
AXTitle
"
)
"
Four
"
"
Correct
title
for
tab
"
)
;
let
tabToSelect
=
tabMacAccs
[
2
]
;
is
(
tabToSelect
.
getAttributeValue
(
"
AXTitle
"
)
"
Three
"
"
Correct
title
for
tab
"
)
;
let
actions
=
tabToSelect
.
actionNames
;
ok
(
true
actions
)
;
ok
(
actions
.
includes
(
"
AXPress
"
)
"
Has
switch
action
"
)
;
let
evt
=
Promise
.
all
(
[
waitForMacEvent
(
"
AXSelectedChildrenChanged
"
)
waitForMacEvent
(
"
AXFocusedUIElementChanged
"
iface
=
>
iface
.
getAttributeValue
(
"
AXRole
"
)
=
=
"
AXWebArea
"
)
]
)
;
tabToSelect
.
performAction
(
"
AXPress
"
)
;
await
evt
;
selectedTabs
=
tablist
.
getAttributeValue
(
"
AXSelectedChildren
"
)
;
is
(
selectedTabs
.
length
1
"
one
selected
tab
"
)
;
is
(
selectedTabs
[
0
]
.
getAttributeValue
(
"
AXTitle
"
)
"
Three
"
"
Correct
title
for
tab
"
)
;
await
Promise
.
all
(
newTabs
.
map
(
t
=
>
BrowserTestUtils
.
removeTab
(
t
)
)
)
;
}
)
;
add_task
(
async
(
)
=
>
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
license
"
}
async
browser
=
>
{
let
root
=
await
getMacAccessible
(
document
)
;
let
rootChildCount
=
(
)
=
>
root
.
getAttributeValue
(
"
AXChildren
"
)
.
length
;
is
(
rootChildCount
(
)
5
"
Root
with
no
popups
has
5
children
"
)
;
const
menu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
document
.
body
{
type
:
"
contextmenu
"
}
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
menu
"
shown
"
)
;
is
(
rootChildCount
(
)
6
"
Root
has
6
children
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
menu
"
hidden
"
)
;
is
(
rootChildCount
(
)
5
"
Root
has
5
children
"
)
;
document
.
getElementById
(
"
identity
-
box
"
)
.
click
(
)
;
const
identityPopup
=
document
.
getElementById
(
"
identity
-
popup
"
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
identityPopup
"
shown
"
)
;
is
(
rootChildCount
(
)
6
"
Root
has
6
children
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
identityPopup
"
hidden
"
)
;
is
(
rootChildCount
(
)
5
"
Root
has
5
children
"
)
;
}
)
;
}
)
;
add_task
(
async
(
)
=
>
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
"
}
async
browser
=
>
{
let
input
=
await
getMacAccessible
(
"
urlbar
-
input
"
)
;
is
(
input
.
getAttributeValue
(
"
AXValue
"
)
"
example
.
com
"
"
Location
bar
has
correct
value
"
)
;
}
)
;
}
)
;
