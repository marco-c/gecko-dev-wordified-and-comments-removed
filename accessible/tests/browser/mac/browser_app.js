"
use
strict
"
;
loadScripts
(
{
name
:
"
role
.
js
"
dir
:
MOCHITESTS_DIR
}
{
name
:
"
states
.
js
"
dir
:
MOCHITESTS_DIR
}
)
;
function
getMacAccessible
(
id
)
{
return
new
Promise
(
resolve
=
>
{
let
intervalId
=
setInterval
(
(
)
=
>
{
let
acc
=
getAccessible
(
id
)
;
if
(
acc
)
{
clearInterval
(
intervalId
)
;
resolve
(
acc
.
nativeInterface
.
QueryInterface
(
Ci
.
nsIAccessibleMacInterface
)
)
;
}
}
10
)
;
}
)
;
}
add_task
(
async
(
)
=
>
{
let
newTabs
=
await
Promise
.
all
(
[
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Two
<
/
title
>
"
)
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Three
<
/
title
>
"
)
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Four
<
/
title
>
"
)
]
)
;
is
(
gBrowser
.
tabs
.
length
4
"
We
now
have
4
open
tabs
"
)
;
let
tablist
=
await
getMacAccessible
(
"
tabbrowser
-
tabs
"
)
;
is
(
tablist
.
getAttributeValue
(
"
AXRole
"
)
"
AXTabGroup
"
"
Correct
role
for
tablist
"
)
;
let
tabMacAccs
=
tablist
.
getAttributeValue
(
"
AXTabs
"
)
;
is
(
tabMacAccs
.
length
4
"
4
items
in
AXTabs
"
)
;
let
selectedTabs
=
tablist
.
getAttributeValue
(
"
AXSelectedChildren
"
)
;
is
(
selectedTabs
.
length
1
"
one
selected
tab
"
)
;
let
tab
=
selectedTabs
[
0
]
;
is
(
tab
.
getAttributeValue
(
"
AXRole
"
)
"
AXRadioButton
"
"
Correct
role
for
tab
"
)
;
todo_is
(
tab
.
getAttributeValue
(
"
AXSubrole
"
)
"
AXTabButton
"
"
Correct
subrole
for
tab
"
)
;
is
(
tab
.
getAttributeValue
(
"
AXTitle
"
)
"
Four
"
"
Correct
title
for
tab
"
)
;
let
tabToSelect
=
tabMacAccs
[
2
]
;
is
(
tabToSelect
.
getAttributeValue
(
"
AXTitle
"
)
"
Three
"
"
Correct
title
for
tab
"
)
;
let
actions
=
tabToSelect
.
actionNames
;
ok
(
true
actions
)
;
ok
(
actions
.
includes
(
"
AXPress
"
)
"
Has
switch
action
"
)
;
let
evt
=
Promise
.
all
(
[
waitForMacEvent
(
"
AXSelectedChildrenChanged
"
)
waitForMacEvent
(
"
AXFocusedUIElementChanged
"
iface
=
>
iface
.
getAttributeValue
(
"
AXRole
"
)
=
=
"
AXWebArea
"
)
]
)
;
tabToSelect
.
performAction
(
"
AXPress
"
)
;
await
evt
;
selectedTabs
=
tablist
.
getAttributeValue
(
"
AXSelectedChildren
"
)
;
is
(
selectedTabs
.
length
1
"
one
selected
tab
"
)
;
is
(
selectedTabs
[
0
]
.
getAttributeValue
(
"
AXTitle
"
)
"
Three
"
"
Correct
title
for
tab
"
)
;
evt
=
waitForMacEvent
(
"
AXFocusedUIElementChanged
"
iface
=
>
iface
.
getAttributeValue
(
"
AXRole
"
)
=
=
"
AXRadioButton
"
)
;
gBrowser
.
selectedTab
.
focus
(
)
;
await
evt
;
evt
=
waitForMacEvent
(
"
AXFocusedUIElementChanged
"
iface
=
>
iface
.
getAttributeValue
(
"
AXRole
"
)
=
=
"
AXRadioButton
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowLeft
"
{
metaKey
:
true
}
)
;
await
evt
;
evt
=
waitForMacEvent
(
"
AXSelectedChildrenChanged
"
)
;
EventUtils
.
synthesizeKey
(
"
"
{
metaKey
:
true
shiftKey
:
true
}
)
;
await
evt
;
selectedTabs
=
tablist
.
getAttributeValue
(
"
AXSelectedChildren
"
)
;
is
(
selectedTabs
.
length
2
"
two
tabs
selected
"
)
;
await
Promise
.
all
(
newTabs
.
map
(
t
=
>
BrowserTestUtils
.
removeTab
(
t
)
)
)
;
}
)
;
