"
use
strict
"
;
const
{
UrlbarTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
UrlbarTestUtils
.
sys
.
mjs
"
)
;
loadScripts
(
{
name
:
"
role
.
js
"
dir
:
MOCHITESTS_DIR
}
{
name
:
"
states
.
js
"
dir
:
MOCHITESTS_DIR
}
)
;
function
getMacAccessible
(
accOrElmOrID
)
{
return
new
Promise
(
resolve
=
>
{
let
intervalId
=
setInterval
(
(
)
=
>
{
let
acc
=
getAccessible
(
accOrElmOrID
)
;
if
(
acc
)
{
clearInterval
(
intervalId
)
;
resolve
(
acc
.
nativeInterface
.
QueryInterface
(
Ci
.
nsIAccessibleMacInterface
)
)
;
}
}
10
)
;
}
)
;
}
add_setup
(
async
function
(
)
{
await
SpecialPowers
.
pushPrefEnv
(
{
set
:
[
[
"
browser
.
urlbar
.
trustPanel
.
featureGate
"
false
]
]
}
)
;
}
)
;
add_task
(
async
(
)
=
>
{
const
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
"
)
;
const
alert
=
document
.
getElementById
(
"
a11y
-
announcement
"
)
;
ok
(
alert
"
Found
alert
to
send
announcements
"
)
;
const
alerted
=
waitForMacEvent
(
"
AXAnnouncementRequested
"
(
iface
data
)
=
>
{
return
data
.
AXAnnouncementKey
=
=
"
hello
world
"
;
}
)
;
A11yUtils
.
announce
(
{
raw
:
"
hello
world
"
}
)
;
await
alerted
;
await
BrowserTestUtils
.
removeTab
(
tab
)
;
}
)
;
add_task
(
async
(
)
=
>
{
let
newTabs
=
await
Promise
.
all
(
[
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Two
<
/
title
>
"
)
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Three
<
/
title
>
"
)
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
"
data
:
text
/
html
<
title
>
Four
<
/
title
>
"
)
]
)
;
is
(
gBrowser
.
tabs
.
length
4
"
We
now
have
4
open
tabs
"
)
;
let
tablist
=
await
getMacAccessible
(
"
tabbrowser
-
tabs
"
)
;
is
(
tablist
.
getAttributeValue
(
"
AXRole
"
)
"
AXTabGroup
"
"
Correct
role
for
tablist
"
)
;
let
tabMacAccs
=
tablist
.
getAttributeValue
(
"
AXTabs
"
)
;
is
(
tabMacAccs
.
length
4
"
4
items
in
AXTabs
"
)
;
let
selectedTabs
=
tablist
.
getAttributeValue
(
"
AXSelectedChildren
"
)
;
is
(
selectedTabs
.
length
1
"
one
selected
tab
"
)
;
let
tab
=
selectedTabs
[
0
]
;
is
(
tab
.
getAttributeValue
(
"
AXRole
"
)
"
AXRadioButton
"
"
Correct
role
for
tab
"
)
;
is
(
tab
.
getAttributeValue
(
"
AXSubrole
"
)
"
AXTabButton
"
"
Correct
subrole
for
tab
"
)
;
is
(
tab
.
getAttributeValue
(
"
AXTitle
"
)
"
Four
"
"
Correct
title
for
tab
"
)
;
let
tabToSelect
=
tabMacAccs
[
2
]
;
is
(
tabToSelect
.
getAttributeValue
(
"
AXTitle
"
)
"
Three
"
"
Correct
title
for
tab
"
)
;
let
actions
=
tabToSelect
.
actionNames
;
ok
(
true
actions
)
;
ok
(
actions
.
includes
(
"
AXPress
"
)
"
Has
switch
action
"
)
;
let
evt
=
Promise
.
all
(
[
waitForMacEvent
(
"
AXSelectedChildrenChanged
"
)
waitForMacEvent
(
"
AXFocusedUIElementChanged
"
iface
=
>
iface
.
getAttributeValue
(
"
AXRole
"
)
=
=
"
AXWebArea
"
)
]
)
;
tabToSelect
.
performAction
(
"
AXPress
"
)
;
await
evt
;
selectedTabs
=
tablist
.
getAttributeValue
(
"
AXSelectedChildren
"
)
;
is
(
selectedTabs
.
length
1
"
one
selected
tab
"
)
;
is
(
selectedTabs
[
0
]
.
getAttributeValue
(
"
AXTitle
"
)
"
Three
"
"
Correct
title
for
tab
"
)
;
await
Promise
.
all
(
newTabs
.
map
(
t
=
>
BrowserTestUtils
.
removeTab
(
t
)
)
)
;
}
)
;
add_task
(
async
(
)
=
>
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
about
:
license
"
}
async
(
)
=
>
{
let
root
=
await
getMacAccessible
(
document
)
;
let
rootChildCount
=
(
)
=
>
root
.
getAttributeValue
(
"
AXChildren
"
)
.
length
;
let
baseRootChildCount
=
5
;
is
(
rootChildCount
(
)
baseRootChildCount
Root
with
no
popups
has
{
baseRootChildCount
}
children
)
;
const
menu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
if
(
Services
.
prefs
.
getBoolPref
(
"
widget
.
macos
.
native
-
context
-
menus
"
false
)
)
{
let
popupshown
=
BrowserTestUtils
.
waitForPopupEvent
(
menu
"
shown
"
)
;
EventUtils
.
synthesizeMouseAtCenter
(
document
.
body
{
type
:
"
contextmenu
"
}
)
;
await
popupshown
;
is
(
rootChildCount
(
)
baseRootChildCount
"
Native
context
menus
do
not
show
up
in
the
root
children
"
)
;
let
popuphidden
=
BrowserTestUtils
.
waitForPopupEvent
(
menu
"
hidden
"
)
;
menu
.
hidePopup
(
)
;
await
popuphidden
;
}
else
{
EventUtils
.
synthesizeMouseAtCenter
(
document
.
body
{
type
:
"
contextmenu
"
}
)
;
await
waitForMacEvent
(
"
AXMenuOpened
"
)
;
is
(
rootChildCount
(
)
baseRootChildCount
+
1
"
Root
has
1
more
child
"
)
;
let
closed
=
waitForMacEvent
(
"
AXMenuClosed
"
"
contentAreaContextMenu
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
menu
"
hidden
"
)
;
await
closed
;
}
is
(
rootChildCount
(
)
baseRootChildCount
"
Root
has
original
child
count
"
)
;
document
.
getElementById
(
"
identity
-
icon
-
box
"
)
.
click
(
)
;
const
identityPopup
=
document
.
getElementById
(
"
identity
-
popup
"
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
identityPopup
"
shown
"
)
;
is
(
rootChildCount
(
)
baseRootChildCount
+
1
"
Root
has
another
child
"
)
;
let
hide
=
waitForMacEvent
(
"
AXUIElementDestroyed
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
BrowserTestUtils
.
waitForPopupEvent
(
identityPopup
"
hidden
"
)
;
await
hide
;
is
(
rootChildCount
(
)
baseRootChildCount
"
Root
has
the
base
child
count
"
)
;
}
)
;
}
)
;
add_task
(
async
(
)
=
>
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
"
}
async
(
)
=
>
{
let
input
=
await
getMacAccessible
(
gURLBar
.
inputField
)
;
is
(
input
.
getAttributeValue
(
"
AXValue
"
)
UrlbarTestUtils
.
trimURL
(
"
http
:
/
/
example
.
com
"
)
"
Location
bar
has
correct
value
"
)
;
}
)
;
}
)
;
add_task
(
async
(
)
=
>
{
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
"
http
:
/
/
example
.
com
"
}
async
(
)
=
>
{
let
root
=
await
getMacAccessible
(
document
)
;
let
navBar
=
await
getMacAccessible
(
"
nav
-
bar
"
)
;
let
elemRange
=
root
.
getParameterizedAttributeValue
(
"
AXTextMarkerRangeForUIElement
"
navBar
)
;
let
attributedString
=
root
.
getParameterizedAttributeValue
(
"
AXAttributedStringForTextMarkerRange
"
elemRange
)
;
let
attachmentRoles
=
attributedString
.
map
(
s
=
>
s
.
AXAttachment
?
s
.
AXAttachment
.
getAttributeValue
(
"
AXRole
"
)
:
null
)
;
ok
(
!
attachmentRoles
.
includes
(
"
AXMenu
"
)
"
Collapsed
menu
should
be
embedded
in
attributed
text
"
)
;
}
)
;
}
)
;
add_task
(
async
(
)
=
>
{
if
(
Services
.
prefs
.
getBoolPref
(
"
widget
.
macos
.
native
-
context
-
menus
"
false
)
)
{
ok
(
true
"
We
cannot
inspect
native
context
menu
contents
;
skip
this
test
.
"
)
;
return
;
}
await
BrowserTestUtils
.
withNewTab
(
{
gBrowser
url
:
'
data
:
text
/
html
<
a
id
=
"
exampleLink
"
href
=
"
https
:
/
/
example
.
com
"
>
link
<
/
a
>
'
}
async
browser
=
>
{
if
(
!
Services
.
search
.
isInitialized
)
{
let
aStatus
=
await
Services
.
search
.
init
(
)
;
Assert
.
ok
(
Components
.
isSuccessCode
(
aStatus
)
)
;
Assert
.
ok
(
Services
.
search
.
isInitialized
)
;
}
const
hasContainers
=
Services
.
prefs
.
getBoolPref
(
"
privacy
.
userContext
.
enabled
"
)
&
&
!
!
ContextualIdentityService
.
getPublicIdentities
(
)
.
length
;
info
(
{
hasContainers
?
"
Do
"
:
"
Don
'
t
"
}
expect
containers
item
.
)
;
const
hasInspectA11y
=
Services
.
prefs
.
getBoolPref
(
"
devtools
.
everOpened
"
false
)
|
|
Services
.
prefs
.
getIntPref
(
"
devtools
.
selfxss
.
count
"
0
)
>
0
;
info
(
{
hasInspectA11y
?
"
Do
"
:
"
Don
'
t
"
}
expect
inspect
a11y
item
.
)
;
let
menu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
await
BrowserTestUtils
.
synthesizeMouseAtCenter
(
"
#
exampleLink
"
{
type
:
"
contextmenu
"
}
browser
)
;
await
waitForMacEvent
(
"
AXMenuOpened
"
)
;
menu
=
await
getMacAccessible
(
menu
)
;
let
menuChildren
=
menu
.
getAttributeValue
(
"
AXChildren
"
)
;
const
expectedChildCount
=
12
+
+
hasContainers
+
+
hasInspectA11y
;
is
(
menuChildren
.
length
expectedChildCount
Context
menu
on
link
contains
{
expectedChildCount
}
items
.
)
;
const
splitterIndicies
=
hasContainers
?
[
4
9
11
]
:
[
3
8
10
]
;
for
(
let
i
=
0
;
i
<
menuChildren
.
length
;
i
+
+
)
{
if
(
splitterIndicies
.
includes
(
i
)
)
{
is
(
menuChildren
[
i
]
.
getAttributeValue
(
"
AXRole
"
)
"
AXSplitter
"
"
found
splitter
in
menu
"
)
;
}
else
{
is
(
menuChildren
[
i
]
.
getAttributeValue
(
"
AXRole
"
)
"
AXMenuItem
"
"
found
menu
item
in
menu
"
)
;
}
}
if
(
hasContainers
)
{
is
(
menuChildren
[
1
]
.
getAttributeValue
(
"
AXVisibleChildren
"
)
null
"
Submenu
1
has
no
visible
chldren
when
hidden
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowDown
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_ArrowRight
"
)
;
await
waitForMacEvent
(
"
AXMenuOpened
"
)
;
menu
=
document
.
getElementById
(
"
contentAreaContextMenu
"
)
;
menu
=
await
getMacAccessible
(
menu
)
;
menuChildren
=
menu
.
getAttributeValue
(
"
AXChildren
"
)
;
is
(
menuChildren
[
1
]
.
getAttributeValue
(
"
AXChildren
"
)
.
length
1
"
Submenu
1
has
one
child
when
open
"
)
;
const
subMenu
=
menuChildren
[
1
]
.
getAttributeValue
(
"
AXChildren
"
)
[
0
]
;
is
(
subMenu
.
getAttributeValue
(
"
AXRole
"
)
"
AXMenu
"
"
submenu
has
role
of
menu
"
)
;
const
subMenuChildren
=
subMenu
.
getAttributeValue
(
"
AXChildren
"
)
;
is
(
subMenuChildren
.
length
4
"
sub
menu
has
4
children
"
)
;
is
(
subMenu
.
getAttributeValue
(
"
AXVisibleChildren
"
)
.
length
4
"
submenu
has
4
visible
children
"
)
;
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
waitForMacEvent
(
"
AXMenuClosed
"
)
;
}
EventUtils
.
synthesizeKey
(
"
KEY_Escape
"
)
;
await
waitForMacEvent
(
"
AXMenuClosed
"
)
;
}
)
;
}
)
;
