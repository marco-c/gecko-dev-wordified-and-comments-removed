"
use
strict
"
;
Services
.
scriptloader
.
loadSubScript
(
"
chrome
:
/
/
mochitests
/
content
/
browser
/
browser
/
components
/
preferences
/
tests
/
head
.
js
"
this
)
;
const
{
TelemetryTestUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
testing
-
common
/
TelemetryTestUtils
.
sys
.
mjs
"
)
;
registerCleanupFunction
(
(
)
=
>
{
reset
(
)
;
}
)
;
function
reset
(
)
{
Services
.
prefs
.
clearUserPref
(
"
browser
.
display
.
document_color_use
"
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
display
.
permit_backplate
"
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
display
.
use_system_colors
"
)
;
Services
.
prefs
.
clearUserPref
(
"
layout
.
css
.
always_underline_links
"
)
;
Services
.
telemetry
.
clearEvents
(
)
;
TelemetryTestUtils
.
assertNumberOfEvents
(
0
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
display
.
foreground_color
"
)
;
Services
.
prefs
.
clearUserPref
(
"
browser
.
display
.
background_color
"
)
;
}
async
function
openColorsDialog
(
)
{
await
openPreferencesViaOpenPreferencesAPI
(
"
general
"
{
leaveOpen
:
true
}
)
;
const
colorsButton
=
gBrowser
.
selectedBrowser
.
contentDocument
.
getElementById
(
"
colors
"
)
;
const
dialogOpened
=
promiseLoadSubDialog
(
"
chrome
:
/
/
browser
/
content
/
preferences
/
dialogs
/
colors
.
xhtml
"
)
;
colorsButton
.
doCommand
(
)
;
return
dialogOpened
;
}
async
function
closeColorsDialog
(
dialogWin
)
{
const
dialogClosed
=
BrowserTestUtils
.
waitForEvent
(
dialogWin
"
unload
"
)
;
const
button
=
dialogWin
.
document
.
getElementById
(
"
ColorsDialog
"
)
.
getButton
(
"
accept
"
)
;
button
.
focus
(
)
;
button
.
doCommand
(
)
;
return
dialogClosed
;
}
function
verifyBackplate
(
expectedValue
)
{
TelemetryTestUtils
.
assertScalar
(
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
"
a11y
.
backplate
"
expectedValue
"
Backplate
scalar
is
logged
as
"
+
expectedValue
)
;
}
function
verifyUseSystemColors
(
expectedValue
)
{
const
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
false
)
;
ok
(
"
a11y
.
use_system_colors
"
in
snapshot
"
System
color
usage
was
logged
.
"
)
;
TelemetryTestUtils
.
assertScalar
(
snapshot
"
a11y
.
use_system_colors
"
expectedValue
"
System
colors
scalar
is
logged
as
"
+
expectedValue
)
;
}
async
function
verifyAlwaysUnderlineLinks
(
expectedValue
)
{
let
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
false
)
;
ok
(
"
a11y
.
always_underline_links
"
in
snapshot
"
Always
underline
links
was
logged
.
"
)
;
await
TestUtils
.
waitForCondition
(
(
)
=
>
{
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
false
)
;
return
snapshot
[
"
a11y
.
always_underline_links
"
]
=
=
expectedValue
;
}
"
Always
underline
links
has
expected
value
"
+
expectedValue
)
;
}
function
testIsWhite
(
pref
snapshot
)
{
ok
(
pref
in
snapshot
"
Scalar
must
be
present
.
"
)
;
is
(
snapshot
[
pref
]
4294967295
"
Scalar
is
logged
as
white
"
)
;
}
function
testIsBlack
(
pref
snapshot
)
{
ok
(
pref
in
snapshot
"
Scalar
must
be
present
.
"
)
;
is
(
snapshot
[
pref
]
4278190080
"
Scalar
is
logged
as
black
"
)
;
}
async
function
setForegroundColor
(
color
)
{
Services
.
prefs
.
setStringPref
(
"
browser
.
display
.
foreground_color
"
color
)
;
}
async
function
setBackgroundColor
(
color
)
{
Services
.
prefs
.
setStringPref
(
"
browser
.
display
.
background_color
"
color
)
;
}
add_task
(
async
function
testInit
(
)
{
const
dialogWin
=
await
openColorsDialog
(
)
;
const
menulistHCM
=
dialogWin
.
document
.
getElementById
(
"
useDocumentColors
"
)
;
if
(
AppConstants
.
platform
=
=
"
win
"
)
{
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
display
.
use_system_colors
"
)
true
"
Use
system
colours
pref
is
init
'
d
correctly
"
)
;
verifyUseSystemColors
(
true
)
;
is
(
menulistHCM
.
value
"
0
"
"
HCM
menulist
should
be
set
to
only
with
HCM
theme
on
startup
for
windows
"
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
"
a11y
.
theme
"
"
default
"
false
)
;
}
else
{
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
display
.
use_system_colors
"
)
false
"
Use
system
colours
pref
is
init
'
d
correctly
"
)
;
verifyUseSystemColors
(
false
)
;
is
(
menulistHCM
.
value
"
1
"
"
HCM
menulist
should
be
set
to
never
on
startup
for
non
-
windows
platforms
"
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
"
a11y
.
theme
"
"
always
"
false
)
;
await
closeColorsDialog
(
dialogWin
)
;
let
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
ok
(
!
(
"
a11y
.
HCM_foreground
"
in
snapshot
)
"
Foreground
color
shouldn
'
t
be
present
.
"
)
;
ok
(
!
(
"
a11y
.
HCM_background
"
in
snapshot
)
"
Background
color
shouldn
'
t
be
present
.
"
)
;
await
setForegroundColor
(
"
#
ffffff
"
)
;
await
setBackgroundColor
(
"
#
000000
"
)
;
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
ok
(
!
(
"
a11y
.
HCM_foreground
"
in
snapshot
)
"
Foreground
color
shouldn
'
t
be
present
.
"
)
;
ok
(
!
(
"
a11y
.
HCM_background
"
in
snapshot
)
"
Background
color
shouldn
'
t
be
present
.
"
)
;
}
reset
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
testSetAlways
(
)
{
const
dialogWin
=
await
openColorsDialog
(
)
;
const
menulistHCM
=
dialogWin
.
document
.
getElementById
(
"
useDocumentColors
"
)
;
menulistHCM
.
doCommand
(
)
;
const
newOption
=
dialogWin
.
document
.
getElementById
(
"
documentColorAlways
"
)
;
newOption
.
click
(
)
;
is
(
menulistHCM
.
value
"
2
"
"
HCM
menulist
should
be
set
to
always
"
)
;
await
closeColorsDialog
(
dialogWin
)
;
let
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
snapshot
"
a11y
.
theme
"
"
never
"
false
)
;
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
testIsWhite
(
"
a11y
.
HCM_background
"
snapshot
)
;
testIsBlack
(
"
a11y
.
HCM_foreground
"
snapshot
)
;
setBackgroundColor
(
"
#
000000
"
)
;
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
if
(
AppConstants
.
platform
=
=
"
win
"
)
{
testIsWhite
(
"
a11y
.
HCM_background
"
snapshot
)
;
}
else
{
testIsBlack
(
"
a11y
.
HCM_background
"
snapshot
)
;
}
setForegroundColor
(
"
#
ffffff
"
)
;
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
if
(
AppConstants
.
platform
=
=
"
win
"
)
{
testIsBlack
(
"
a11y
.
HCM_foreground
"
snapshot
)
;
}
else
{
testIsWhite
(
"
a11y
.
HCM_foreground
"
snapshot
)
;
}
reset
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
testSetDefault
(
)
{
const
dialogWin
=
await
openColorsDialog
(
)
;
const
menulistHCM
=
dialogWin
.
document
.
getElementById
(
"
useDocumentColors
"
)
;
menulistHCM
.
doCommand
(
)
;
const
newOption
=
dialogWin
.
document
.
getElementById
(
"
documentColorAutomatic
"
)
;
newOption
.
click
(
)
;
is
(
menulistHCM
.
value
"
0
"
"
HCM
menulist
should
be
set
to
default
"
)
;
await
closeColorsDialog
(
dialogWin
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
"
a11y
.
theme
"
"
default
"
false
)
;
let
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
ok
(
!
(
"
a11y
.
HCM_foreground
"
in
snapshot
)
"
Foreground
color
shouldn
'
t
be
present
.
"
)
;
ok
(
!
(
"
a11y
.
HCM_background
"
in
snapshot
)
"
Background
color
shouldn
'
t
be
present
.
"
)
;
await
setForegroundColor
(
"
#
ffffff
"
)
;
await
setBackgroundColor
(
"
#
000000
"
)
;
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
ok
(
!
(
"
a11y
.
HCM_foreground
"
in
snapshot
)
"
Foreground
color
shouldn
'
t
be
present
.
"
)
;
ok
(
!
(
"
a11y
.
HCM_background
"
in
snapshot
)
"
Background
color
shouldn
'
t
be
present
.
"
)
;
reset
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
testSetNever
(
)
{
const
dialogWin
=
await
openColorsDialog
(
)
;
const
menulistHCM
=
dialogWin
.
document
.
getElementById
(
"
useDocumentColors
"
)
;
menulistHCM
.
doCommand
(
)
;
const
newOption
=
dialogWin
.
document
.
getElementById
(
"
documentColorNever
"
)
;
newOption
.
click
(
)
;
is
(
menulistHCM
.
value
"
1
"
"
HCM
menulist
should
be
set
to
never
"
)
;
await
closeColorsDialog
(
dialogWin
)
;
TelemetryTestUtils
.
assertKeyedScalar
(
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
true
true
)
"
a11y
.
theme
"
"
always
"
false
)
;
let
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
ok
(
!
(
"
a11y
.
HCM_foreground
"
in
snapshot
)
"
Foreground
color
shouldn
'
t
be
present
.
"
)
;
ok
(
!
(
"
a11y
.
HCM_background
"
in
snapshot
)
"
Background
color
shouldn
'
t
be
present
.
"
)
;
await
setForegroundColor
(
"
#
ffffff
"
)
;
await
setBackgroundColor
(
"
#
000000
"
)
;
snapshot
=
TelemetryTestUtils
.
getProcessScalars
(
"
parent
"
false
true
)
;
ok
(
!
(
"
a11y
.
HCM_foreground
"
in
snapshot
)
"
Foreground
color
shouldn
'
t
be
present
.
"
)
;
ok
(
!
(
"
a11y
.
HCM_background
"
in
snapshot
)
"
Background
color
shouldn
'
t
be
present
.
"
)
;
reset
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
testBackplate
(
)
{
is
(
Services
.
prefs
.
getBoolPref
(
"
browser
.
display
.
permit_backplate
"
)
true
"
Backplate
is
init
'
d
to
true
"
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
display
.
permit_backplate
"
false
)
;
verifyBackplate
(
false
)
;
Services
.
prefs
.
setBoolPref
(
"
browser
.
display
.
permit_backplate
"
true
)
;
verifyBackplate
(
true
)
;
}
)
;
add_task
(
async
function
testSystemColors
(
)
{
let
expectedInitVal
=
false
;
if
(
AppConstants
.
platform
=
=
"
win
"
)
{
expectedInitVal
=
true
;
}
const
dialogWin
=
await
openColorsDialog
(
)
;
const
checkbox
=
dialogWin
.
document
.
getElementById
(
"
browserUseSystemColors
"
)
;
checkbox
.
click
(
)
;
is
(
checkbox
.
checked
!
expectedInitVal
"
System
colors
checkbox
should
be
modified
"
)
;
await
closeColorsDialog
(
dialogWin
)
;
verifyUseSystemColors
(
!
expectedInitVal
)
;
reset
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
add_task
(
async
function
testAlwaysUnderlineLinks
(
)
{
const
expectedInitVal
=
false
;
await
verifyAlwaysUnderlineLinks
(
expectedInitVal
)
;
await
openPreferencesViaOpenPreferencesAPI
(
"
general
"
{
leaveOpen
:
true
}
)
;
const
checkbox
=
gBrowser
.
selectedBrowser
.
contentDocument
.
getElementById
(
"
alwaysUnderlineLinks
"
)
;
is
(
checkbox
.
checked
expectedInitVal
"
Always
underline
links
checkbox
has
correct
initial
state
"
)
;
checkbox
.
click
(
)
;
is
(
checkbox
.
checked
!
expectedInitVal
"
Always
underline
links
checkbox
should
be
modified
"
)
;
is
(
Services
.
prefs
.
getBoolPref
(
"
layout
.
css
.
always_underline_links
"
)
!
expectedInitVal
"
Always
underline
links
pref
reflects
new
value
.
"
)
;
await
verifyAlwaysUnderlineLinks
(
!
expectedInitVal
)
;
reset
(
)
;
gBrowser
.
removeCurrentTab
(
)
;
}
)
;
