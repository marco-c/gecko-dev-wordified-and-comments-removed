"
use
strict
"
;
loadScripts
(
{
name
:
"
role
.
js
"
dir
:
MOCHITESTS_DIR
}
)
;
addAccessibleTask
(
hello
world
async
function
testIframeRootDocument
(
browser
)
{
info
(
"
Loading
iframe
document
"
)
;
const
HIDDEN_IFRAME_URI
=
"
data
:
text
/
html
<
html
id
=
'
new_html
'
aria
-
hidden
=
'
true
'
>
<
body
id
=
'
iframeBody
'
>
<
u
>
hello
world
<
/
u
>
<
/
body
>
<
/
html
>
"
;
const
loaded
=
waitForEvent
(
EVENT_DOCUMENT_LOAD_COMPLETE
"
iframeBody
"
)
;
await
SpecialPowers
.
spawn
(
browser
[
DEFAULT_IFRAME_ID
HIDDEN_IFRAME_URI
]
(
_id
_uri
)
=
>
{
content
.
document
.
getElementById
(
_id
)
.
src
=
_uri
;
}
)
;
await
loaded
;
const
tree
=
{
INTERNAL_FRAME
:
[
{
DOCUMENT
:
[
]
}
]
}
;
const
root
=
getRootAccessible
(
document
)
;
const
iframeDoc
=
findAccessibleChildByID
(
root
DEFAULT_IFRAME_ID
)
;
testAccessibleTree
(
iframeDoc
tree
)
;
}
{
chrome
:
false
topLevel
:
false
iframe
:
true
remoteIframe
:
true
}
)
;
addAccessibleTask
(
<
html
aria
-
hidden
=
"
true
"
>
<
u
>
hello
world
async
function
testTabRootDocument
(
_
accDoc
)
{
const
tree
=
{
DOCUMENT
:
[
{
TEXT_LEAF
:
[
]
}
]
}
;
testAccessibleTree
(
accDoc
tree
)
;
}
{
chrome
:
true
topLevel
:
true
iframe
:
false
remoteIframe
:
false
}
)
;
addAccessibleTask
(
<
p
id
=
"
content
"
>
I
am
some
content
in
a
document
<
/
p
>
async
function
testTabDocument
(
browser
docAcc
)
{
const
originalTree
=
{
DOCUMENT
:
[
{
PARAGRAPH
:
[
{
TEXT_LEAF
:
[
]
}
]
}
]
}
;
testAccessibleTree
(
docAcc
originalTree
)
;
}
{
chrome
:
true
topLevel
:
true
iframe
:
false
remoteIframe
:
false
contentDocBodyAttrs
:
{
"
aria
-
hidden
"
:
"
true
"
}
}
)
;
addAccessibleTask
(
<
p
id
=
"
content
"
>
I
am
some
content
in
a
document
<
/
p
>
async
function
testTabDocumentMutation
(
browser
docAcc
)
{
const
originalTree
=
{
DOCUMENT
:
[
{
PARAGRAPH
:
[
{
TEXT_LEAF
:
[
]
}
]
}
]
}
;
testAccessibleTree
(
docAcc
originalTree
)
;
info
(
"
Adding
aria
-
hidden
=
true
to
content
doc
"
)
;
const
unexpectedEvents
=
{
unexpected
:
[
[
EVENT_REORDER
docAcc
]
]
}
;
await
contentSpawnMutation
(
browser
unexpectedEvents
function
(
)
{
const
b
=
content
.
document
.
body
;
b
.
setAttribute
(
"
aria
-
hidden
"
"
true
"
)
;
}
)
;
testAccessibleTree
(
docAcc
originalTree
)
;
}
{
chrome
:
true
topLevel
:
true
iframe
:
false
remoteIframe
:
false
}
)
;
addAccessibleTask
(
<
p
id
=
"
content
"
>
I
am
some
content
in
a
document
<
/
p
>
async
function
testIframeDocument
(
browser
docAcc
topLevel
)
{
const
originalTree
=
{
DOCUMENT
:
[
{
INTERNAL_FRAME
:
[
{
DOCUMENT
:
[
]
}
]
}
]
}
;
testAccessibleTree
(
topLevel
originalTree
)
;
}
{
chrome
:
false
topLevel
:
false
iframe
:
true
remoteIframe
:
true
iframeDocBodyAttrs
:
{
"
aria
-
hidden
"
:
"
true
"
}
}
)
;
addAccessibleTask
(
<
p
id
=
"
content
"
>
I
am
some
content
in
a
document
<
/
p
>
async
function
testIframeDocumentMutation
(
browser
docAcc
topLevel
)
{
const
originalTree
=
{
DOCUMENT
:
[
{
INTERNAL_FRAME
:
[
{
DOCUMENT
:
[
{
PARAGRAPH
:
[
{
TEXT_LEAF
:
[
]
}
]
}
]
}
]
}
]
}
;
testAccessibleTree
(
topLevel
originalTree
)
;
info
(
"
Adding
aria
-
hidden
=
true
to
content
doc
"
)
;
await
contentSpawnMutation
(
browser
{
expected
:
[
[
EVENT_REORDER
docAcc
]
]
}
function
(
)
{
const
b
=
content
.
document
.
body
;
b
.
setAttribute
(
"
aria
-
hidden
"
"
true
"
)
;
}
)
;
const
newTree
=
{
DOCUMENT
:
[
{
INTERNAL_FRAME
:
[
{
DOCUMENT
:
[
]
}
]
}
]
}
;
testAccessibleTree
(
topLevel
newTree
)
;
}
{
chrome
:
false
topLevel
:
false
iframe
:
true
remoteIframe
:
true
}
)
;
const
SVG_DOCUMENT_ID
=
"
rootSVG
"
;
const
HIDDEN_SVG_URI
=
"
data
:
image
/
svg
+
xml
%
3Csvg
%
20id
%
3D
%
22rootSVG
%
22
%
20xmlns
%
3D
%
22http
%
3A
%
2F
%
2Fwww
.
w3
.
org
%
2F2000
%
2Fsvg
%
22
%
20aria
-
hidden
%
3D
%
22true
%
22
%
3E
%
3Ctext
%
20x
%
3D
%
2210
%
22
%
20y
%
3D
%
2250
%
22
%
20font
-
size
%
3D
%
2230
%
22
%
20id
%
3D
%
22textSVG
%
22
%
3EMy
%
20SVG
%
3C
%
2Ftext
%
3E
%
3C
%
2Fsvg
%
3E
"
;
const
SVG_URI
=
"
data
:
image
/
svg
+
xml
%
3Csvg
%
20id
%
3D
%
22rootSVG
%
22
%
20xmlns
%
3D
%
22http
%
3A
%
2F
%
2Fwww
.
w3
.
org
%
2F2000
%
2Fsvg
%
22
%
3E
%
3Ctext
%
20x
%
3D
%
2210
%
22
%
20y
%
3D
%
2250
%
22
%
20font
-
size
%
3D
%
2230
%
22
%
20id
%
3D
%
22textSVG
%
22
%
3EMy
%
20SVG
%
3C
%
2Ftext
%
3E
%
3C
%
2Fsvg
%
3E
"
;
addAccessibleTask
(
hello
world
async
function
testSVGDocument
(
browser
)
{
let
loaded
=
waitForEvent
(
EVENT_DOCUMENT_LOAD_COMPLETE
SVG_DOCUMENT_ID
)
;
info
(
"
Loading
SVG
"
)
;
browser
.
loadURI
(
Services
.
io
.
newURI
(
HIDDEN_SVG_URI
)
{
triggeringPrincipal
:
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
}
)
;
await
loaded
;
const
tree
=
{
DOCUMENT
:
[
{
TEXT_CONTAINER
:
[
{
TEXT_LEAF
:
[
]
}
]
}
]
}
;
const
root
=
getRootAccessible
(
document
)
;
const
svgRoot
=
findAccessibleChildByID
(
root
SVG_DOCUMENT_ID
)
;
testAccessibleTree
(
svgRoot
tree
)
;
}
{
chrome
:
true
topLevel
:
true
iframe
:
false
remoteIframe
:
false
}
)
;
addAccessibleTask
(
hello
world
async
function
testSVGIframeDocument
(
browser
)
{
info
(
"
Loading
SVG
"
)
;
const
loaded
=
waitForEvent
(
EVENT_DOCUMENT_LOAD_COMPLETE
SVG_DOCUMENT_ID
)
;
await
SpecialPowers
.
spawn
(
browser
[
DEFAULT_IFRAME_ID
HIDDEN_SVG_URI
]
(
_id
_uri
)
=
>
{
content
.
document
.
getElementById
(
_id
)
.
src
=
_uri
;
}
)
;
await
loaded
;
const
tree
=
{
DOCUMENT
:
[
]
}
;
const
root
=
getRootAccessible
(
document
)
;
const
svgRoot
=
findAccessibleChildByID
(
root
SVG_DOCUMENT_ID
)
;
testAccessibleTree
(
svgRoot
tree
)
;
}
{
chrome
:
false
topLevel
:
false
iframe
:
true
remoteIframe
:
true
}
)
;
addAccessibleTask
(
hello
world
async
function
testSVGDocumentMutation
(
browser
)
{
let
loaded
=
waitForEvent
(
EVENT_DOCUMENT_LOAD_COMPLETE
SVG_DOCUMENT_ID
)
;
info
(
"
Loading
SVG
"
)
;
browser
.
loadURI
(
Services
.
io
.
newURI
(
SVG_URI
)
{
triggeringPrincipal
:
Services
.
scriptSecurityManager
.
getSystemPrincipal
(
)
}
)
;
await
loaded
;
const
originalTree
=
{
DOCUMENT
:
[
{
TEXT_CONTAINER
:
[
{
TEXT_LEAF
:
[
]
}
]
}
]
}
;
const
root
=
getRootAccessible
(
document
)
;
const
svgRoot
=
findAccessibleChildByID
(
root
SVG_DOCUMENT_ID
)
;
testAccessibleTree
(
svgRoot
originalTree
)
;
info
(
"
Adding
aria
-
hidden
=
true
to
svg
"
)
;
const
unexpectedEvents
=
{
expected
:
[
[
EVENT_REORDER
SVG_DOCUMENT_ID
]
]
}
;
info
(
"
Adding
aria
-
hidden
"
)
;
await
contentSpawnMutation
(
browser
unexpectedEvents
function
(
_id
)
{
const
d
=
content
.
document
.
getElementById
(
_id
)
;
d
.
setAttribute
(
"
aria
-
hidden
"
"
true
"
)
;
}
[
SVG_DOCUMENT_ID
]
)
;
const
newTree
=
{
DOCUMENT
:
[
{
DIAGRAM
:
[
{
TEXT_CONTAINER
:
[
{
TEXT_LEAF
:
[
]
}
]
}
]
}
]
}
;
testAccessibleTree
(
svgRoot
newTree
)
;
}
{
chrome
:
true
topLevel
:
true
iframe
:
false
remoteIframe
:
false
}
)
;
addAccessibleTask
(
hello
world
async
function
testSVGIframeDocumentMutation
(
browser
)
{
info
(
"
Loading
SVG
"
)
;
const
loaded
=
waitForEvent
(
EVENT_DOCUMENT_LOAD_COMPLETE
SVG_DOCUMENT_ID
)
;
await
SpecialPowers
.
spawn
(
browser
[
DEFAULT_IFRAME_ID
SVG_URI
]
(
contentId
_uri
)
=
>
{
content
.
document
.
getElementById
(
contentId
)
.
src
=
_uri
;
}
)
;
await
loaded
;
const
originalTree
=
{
DOCUMENT
:
[
{
TEXT_CONTAINER
:
[
{
TEXT_LEAF
:
[
]
}
]
}
]
}
;
const
svgRoot
=
findAccessibleChildByID
(
getRootAccessible
(
document
)
SVG_DOCUMENT_ID
)
;
testAccessibleTree
(
svgRoot
originalTree
)
;
info
(
"
Adding
aria
-
hidden
=
true
to
svg
"
)
;
const
events
=
{
expected
:
[
[
EVENT_REORDER
SVG_DOCUMENT_ID
]
]
}
;
await
contentSpawnMutation
(
browser
events
function
(
_id
)
{
const
d
=
content
.
document
.
getElementById
(
_id
)
;
d
.
setAttribute
(
"
aria
-
hidden
"
"
true
"
)
;
}
[
SVG_DOCUMENT_ID
]
)
;
const
newTree
=
{
DOCUMENT
:
[
]
}
;
testAccessibleTree
(
svgRoot
newTree
)
;
}
{
chrome
:
false
topLevel
:
false
iframe
:
true
remoteIframe
:
true
}
)
;
