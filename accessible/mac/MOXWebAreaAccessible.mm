#
import
"
MOXWebAreaAccessible
.
h
"
#
include
"
nsCocoaUtils
.
h
"
#
include
"
DocAccessibleParent
.
h
"
using
namespace
mozilla
:
:
a11y
;
implementation
MOXWebAreaAccessible
-
(
NSURL
*
)
moxURL
{
if
(
[
self
isExpired
]
)
{
return
nil
;
}
nsAutoString
url
;
if
(
mGeckoAccessible
.
IsAccessible
(
)
)
{
MOZ_ASSERT
(
mGeckoAccessible
.
AsAccessible
(
)
-
>
IsDoc
(
)
)
;
DocAccessible
*
acc
=
mGeckoAccessible
.
AsAccessible
(
)
-
>
AsDoc
(
)
;
acc
-
>
URL
(
url
)
;
}
else
{
ProxyAccessible
*
proxy
=
mGeckoAccessible
.
AsProxy
(
)
;
proxy
-
>
URL
(
url
)
;
}
if
(
url
.
IsEmpty
(
)
)
{
return
nil
;
}
return
[
NSURL
URLWithString
:
nsCocoaUtils
:
:
ToNSString
(
url
)
]
;
}
-
(
NSNumber
*
)
moxLoaded
{
if
(
[
self
isExpired
]
)
{
return
nil
;
}
return
(
[
self
stateWithMask
:
(
states
:
:
BUSY
&
states
:
:
STALE
)
]
=
=
0
)
;
}
-
(
NSNumber
*
)
moxLoadingProgress
{
if
(
[
self
isExpired
]
)
{
return
nil
;
}
if
(
[
self
stateWithMask
:
states
:
:
STALE
]
!
=
0
)
{
return
0
.
0
;
}
if
(
[
self
stateWithMask
:
states
:
:
BUSY
]
!
=
0
)
{
return
0
.
5
;
}
return
1
.
0
;
}
-
(
void
)
handleAccessibleEvent
:
(
uint32_t
)
eventType
{
switch
(
eventType
)
{
case
nsIAccessibleEvent
:
:
EVENT_DOCUMENT_LOAD_COMPLETE
:
[
self
moxPostNotification
:
NSAccessibilityFocusedUIElementChangedNotification
]
;
if
(
(
mGeckoAccessible
.
IsProxy
(
)
&
&
mGeckoAccessible
.
AsProxy
(
)
-
>
IsDoc
(
)
&
&
mGeckoAccessible
.
AsProxy
(
)
-
>
AsDoc
(
)
-
>
IsTopLevel
(
)
)
|
|
(
mGeckoAccessible
.
IsAccessible
(
)
&
&
!
mGeckoAccessible
.
AsAccessible
(
)
-
>
IsRoot
(
)
&
&
mGeckoAccessible
.
AsAccessible
(
)
-
>
AsDoc
(
)
-
>
ParentDocument
(
)
-
>
IsRoot
(
)
)
)
{
[
self
moxPostNotification
:
"
AXLoadComplete
"
]
;
}
else
{
[
self
moxPostNotification
:
"
AXLayoutComplete
"
]
;
}
break
;
}
[
super
handleAccessibleEvent
:
eventType
]
;
}
end
implementation
MOXSearchInfo
-
(
id
)
initWithParameters
:
(
NSDictionary
*
)
params
andRoot
:
(
AccessibleOrProxy
)
root
{
if
(
id
searchKeyParam
=
[
params
objectForKey
:
"
AXSearchKey
"
]
)
{
mSearchKeys
=
[
searchKeyParam
isKindOfClass
:
[
NSString
class
]
]
?
[
searchKeyParam
]
:
searchKeyParam
;
}
if
(
id
startElemParam
=
[
params
objectForKey
:
"
AXStartElement
"
]
)
{
mStartElem
=
[
startElemParam
geckoAccessible
]
;
}
else
{
mStartElem
=
root
;
}
MOZ_ASSERT
(
!
mStartElem
.
IsNull
(
)
"
Performing
search
with
null
gecko
accessible
!
"
)
;
mWebArea
=
root
;
mResultLimit
=
[
[
params
objectForKey
:
"
AXResultsLimit
"
]
intValue
]
;
mSearchForward
=
[
[
params
objectForKey
:
"
AXDirection
"
]
isEqualToString
:
"
AXDirectionNext
"
]
;
mImmediateDescendantsOnly
=
[
[
params
objectForKey
:
"
AXImmediateDescendantsOnly
"
]
boolValue
]
;
return
[
super
init
]
;
}
-
(
void
)
dealloc
{
[
mSearchKeys
release
]
;
[
super
dealloc
]
;
}
end
