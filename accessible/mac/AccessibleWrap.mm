#
include
"
DocAccessibleWrap
.
h
"
#
include
"
nsObjCExceptions
.
h
"
#
include
"
nsCocoaUtils
.
h
"
#
include
"
nsUnicharUtils
.
h
"
#
include
"
LocalAccessible
-
inl
.
h
"
#
include
"
nsAccUtils
.
h
"
#
include
"
mozilla
/
a11y
/
Role
.
h
"
#
include
"
TextRange
.
h
"
#
include
"
gfxPlatform
.
h
"
#
import
"
MOXLandmarkAccessibles
.
h
"
#
import
"
MOXMathAccessibles
.
h
"
#
import
"
MOXOuterDoc
.
h
"
#
import
"
MOXTextMarkerDelegate
.
h
"
#
import
"
MOXWebAreaAccessible
.
h
"
#
import
"
mozAccessible
.
h
"
#
import
"
mozActionElements
.
h
"
#
import
"
mozHTMLAccessible
.
h
"
#
import
"
mozSelectableElements
.
h
"
#
import
"
mozTableAccessible
.
h
"
#
import
"
mozTextAccessible
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
a11y
;
AccessibleWrap
:
:
AccessibleWrap
(
nsIContent
*
aContent
DocAccessible
*
aDoc
)
:
LocalAccessible
(
aContent
aDoc
)
mNativeObject
(
nil
)
mNativeInited
(
false
)
{
if
(
aContent
&
&
aContent
-
>
IsElement
(
)
&
&
aDoc
)
{
DocAccessibleWrap
*
doc
=
static_cast
<
DocAccessibleWrap
*
>
(
aDoc
)
;
static
const
dom
:
:
Element
:
:
AttrValuesArray
sLiveRegionValues
[
]
=
{
nsGkAtoms
:
:
OFF
nsGkAtoms
:
:
polite
nsGkAtoms
:
:
assertive
nullptr
}
;
int32_t
attrValue
=
nsAccUtils
:
:
FindARIAAttrValueIn
(
aContent
-
>
AsElement
(
)
nsGkAtoms
:
:
aria_live
sLiveRegionValues
eIgnoreCase
)
;
if
(
attrValue
=
=
0
)
{
}
else
if
(
attrValue
>
0
)
{
doc
-
>
QueueNewLiveRegion
(
this
)
;
}
else
if
(
const
nsRoleMapEntry
*
roleMap
=
aria
:
:
GetRoleMap
(
aContent
-
>
AsElement
(
)
)
)
{
if
(
roleMap
-
>
liveAttRule
=
=
ePoliteLiveAttr
|
|
roleMap
-
>
liveAttRule
=
=
eAssertiveLiveAttr
)
{
doc
-
>
QueueNewLiveRegion
(
this
)
;
}
}
else
if
(
nsStaticAtom
*
value
=
GetAccService
(
)
-
>
MarkupAttribute
(
aContent
nsGkAtoms
:
:
aria_live
)
)
{
if
(
value
=
=
nsGkAtoms
:
:
polite
|
|
value
=
=
nsGkAtoms
:
:
assertive
)
{
doc
-
>
QueueNewLiveRegion
(
this
)
;
}
}
}
}
AccessibleWrap
:
:
~
AccessibleWrap
(
)
{
}
mozAccessible
*
AccessibleWrap
:
:
GetNativeObject
(
)
{
NS_OBJC_BEGIN_TRY_BLOCK_RETURN
;
if
(
!
mNativeInited
&
&
!
mNativeObject
)
{
if
(
!
IsXULTooltip
(
)
&
&
!
IsDefunct
(
)
&
&
Role
(
)
!
=
roles
:
:
WHITESPACE
)
{
mNativeObject
=
[
[
GetNativeType
(
)
alloc
]
initWithAccessible
:
this
]
;
}
}
mNativeInited
=
true
;
return
mNativeObject
;
NS_OBJC_END_TRY_BLOCK_RETURN
(
nil
)
;
}
void
AccessibleWrap
:
:
GetNativeInterface
(
void
*
*
aOutInterface
)
{
*
aOutInterface
=
static_cast
<
void
*
>
(
GetNativeObject
(
)
)
;
}
Class
AccessibleWrap
:
:
GetNativeType
(
)
{
NS_OBJC_BEGIN_TRY_BLOCK_RETURN
;
if
(
IsXULTabpanels
(
)
)
{
return
[
mozPaneAccessible
class
]
;
}
if
(
IsTable
(
)
)
{
return
[
mozTableAccessible
class
]
;
}
if
(
IsTableRow
(
)
)
{
return
[
mozTableRowAccessible
class
]
;
}
if
(
IsTableCell
(
)
)
{
return
[
mozTableCellAccessible
class
]
;
}
if
(
IsDoc
(
)
)
{
return
[
MOXWebAreaAccessible
class
]
;
}
if
(
IsOuterDoc
(
)
)
{
return
[
MOXOuterDoc
class
]
;
}
if
(
IsTextField
(
)
&
&
!
HasNumericValue
(
)
)
{
return
[
mozTextAccessible
class
]
;
}
return
GetTypeFromRole
(
Role
(
)
)
;
NS_OBJC_END_TRY_BLOCK_RETURN
(
nil
)
;
}
void
AccessibleWrap
:
:
Shutdown
(
)
{
mNativeInited
=
true
;
if
(
mNativeObject
)
{
[
mNativeObject
expire
]
;
[
mNativeObject
release
]
;
mNativeObject
=
nil
;
}
LocalAccessible
:
:
Shutdown
(
)
;
}
nsresult
AccessibleWrap
:
:
HandleAccEvent
(
AccEvent
*
aEvent
)
{
NS_OBJC_BEGIN_TRY_BLOCK_RETURN
;
nsresult
rv
=
LocalAccessible
:
:
HandleAccEvent
(
aEvent
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
IsDefunct
(
)
)
{
return
NS_OK
;
}
uint32_t
eventType
=
aEvent
-
>
GetEventType
(
)
;
if
(
eventType
=
=
nsIAccessibleEvent
:
:
EVENT_SHOW
)
{
DocAccessibleWrap
*
doc
=
static_cast
<
DocAccessibleWrap
*
>
(
Document
(
)
)
;
doc
-
>
ProcessNewLiveRegions
(
)
;
}
return
NS_OK
;
NS_OBJC_END_TRY_BLOCK_RETURN
(
NS_ERROR_FAILURE
)
;
}
Class
a11y
:
:
GetTypeFromRole
(
roles
:
:
Role
aRole
)
{
NS_OBJC_BEGIN_TRY_BLOCK_RETURN
;
switch
(
aRole
)
{
case
roles
:
:
COMBOBOX
:
return
[
mozPopupButtonAccessible
class
]
;
case
roles
:
:
PUSHBUTTON
:
return
[
mozButtonAccessible
class
]
;
case
roles
:
:
PAGETAB
:
return
[
mozTabAccessible
class
]
;
case
roles
:
:
DATE_EDITOR
:
return
[
mozDatePickerAccessible
class
]
;
case
roles
:
:
CHECKBUTTON
:
case
roles
:
:
TOGGLE_BUTTON
:
case
roles
:
:
SWITCH
:
case
roles
:
:
CHECK_MENU_ITEM
:
return
[
mozCheckboxAccessible
class
]
;
case
roles
:
:
RADIOBUTTON
:
case
roles
:
:
RADIO_MENU_ITEM
:
return
[
mozRadioButtonAccessible
class
]
;
case
roles
:
:
PROGRESSBAR
:
return
[
mozRangeAccessible
class
]
;
case
roles
:
:
METER
:
return
[
mozMeterAccessible
class
]
;
case
roles
:
:
SPINBUTTON
:
case
roles
:
:
SLIDER
:
return
[
mozIncrementableAccessible
class
]
;
case
roles
:
:
HEADING
:
return
[
mozHeadingAccessible
class
]
;
case
roles
:
:
PAGETABLIST
:
return
[
mozTabGroupAccessible
class
]
;
case
roles
:
:
ENTRY
:
case
roles
:
:
PASSWORD_TEXT
:
return
[
mozTextAccessible
class
]
;
case
roles
:
:
TEXT_LEAF
:
case
roles
:
:
STATICTEXT
:
return
[
mozTextLeafAccessible
class
]
;
case
roles
:
:
LANDMARK
:
return
[
MOXLandmarkAccessible
class
]
;
case
roles
:
:
LINK
:
return
[
mozLinkAccessible
class
]
;
case
roles
:
:
LISTBOX
:
return
[
mozListboxAccessible
class
]
;
case
roles
:
:
LISTITEM
:
return
[
MOXListItemAccessible
class
]
;
case
roles
:
:
OPTION
:
{
return
[
mozOptionAccessible
class
]
;
}
case
roles
:
:
RICH_OPTION
:
{
return
[
mozSelectableChildAccessible
class
]
;
}
case
roles
:
:
COMBOBOX_LIST
:
case
roles
:
:
MENUBAR
:
case
roles
:
:
MENUPOPUP
:
{
return
[
mozMenuAccessible
class
]
;
}
case
roles
:
:
COMBOBOX_OPTION
:
case
roles
:
:
PARENT_MENUITEM
:
case
roles
:
:
MENUITEM
:
{
return
[
mozMenuItemAccessible
class
]
;
}
case
roles
:
:
MATHML_ROOT
:
return
[
MOXMathRootAccessible
class
]
;
case
roles
:
:
MATHML_SQUARE_ROOT
:
return
[
MOXMathSquareRootAccessible
class
]
;
case
roles
:
:
MATHML_FRACTION
:
return
[
MOXMathFractionAccessible
class
]
;
case
roles
:
:
MATHML_SUB
:
case
roles
:
:
MATHML_SUP
:
case
roles
:
:
MATHML_SUB_SUP
:
return
[
MOXMathSubSupAccessible
class
]
;
case
roles
:
:
MATHML_UNDER
:
case
roles
:
:
MATHML_OVER
:
case
roles
:
:
MATHML_UNDER_OVER
:
return
[
MOXMathUnderOverAccessible
class
]
;
case
roles
:
:
OUTLINE
:
case
roles
:
:
TREE_TABLE
:
return
[
mozOutlineAccessible
class
]
;
case
roles
:
:
OUTLINEITEM
:
return
[
mozOutlineRowAccessible
class
]
;
default
:
return
[
mozAccessible
class
]
;
}
return
nil
;
NS_OBJC_END_TRY_BLOCK_RETURN
(
nil
)
;
}
