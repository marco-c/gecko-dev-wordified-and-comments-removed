#
include
"
RootAccessibleWrap
.
h
"
#
include
"
LocalAccessible
-
inl
.
h
"
#
include
"
DocAccessibleParent
.
h
"
#
include
"
DocAccessible
-
inl
.
h
"
#
include
"
RemoteAccessibleWrap
.
h
"
#
include
"
SessionAccessibility
.
h
"
#
include
"
mozilla
/
PresShell
.
h
"
#
include
"
mozilla
/
dom
/
EventTarget
.
h
"
#
include
"
mozilla
/
dom
/
Event
.
h
"
#
include
"
mozilla
/
dom
/
MouseEvent
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
a11y
;
using
namespace
mozilla
:
:
dom
;
RootAccessibleWrap
:
:
RootAccessibleWrap
(
dom
:
:
Document
*
aDoc
PresShell
*
aPresShell
)
:
RootAccessible
(
aDoc
aPresShell
)
{
}
RootAccessibleWrap
:
:
~
RootAccessibleWrap
(
)
{
}
AccessibleWrap
*
RootAccessibleWrap
:
:
GetContentAccessible
(
)
{
if
(
RemoteAccessible
*
proxy
=
GetPrimaryRemoteTopLevelContentDoc
(
)
)
{
return
WrapperFor
(
proxy
)
;
}
for
(
size_t
i
=
0
;
i
<
ChildDocumentCount
(
)
;
i
+
+
)
{
DocAccessible
*
childDoc
=
GetChildDocumentAt
(
i
)
;
if
(
childDoc
&
&
!
childDoc
-
>
IsDefunct
(
)
&
&
!
childDoc
-
>
IsHidden
(
)
)
{
return
childDoc
;
}
}
return
nullptr
;
}
AccessibleWrap
*
RootAccessibleWrap
:
:
FindAccessibleById
(
int32_t
aID
)
{
AccessibleWrap
*
contentAcc
=
GetContentAccessible
(
)
;
if
(
!
contentAcc
)
{
return
nullptr
;
}
if
(
aID
=
=
AccessibleWrap
:
:
kNoID
)
{
return
contentAcc
;
}
if
(
contentAcc
-
>
IsProxy
(
)
)
{
return
FindAccessibleById
(
static_cast
<
DocRemoteAccessibleWrap
*
>
(
contentAcc
)
aID
)
;
}
return
FindAccessibleById
(
static_cast
<
DocAccessibleWrap
*
>
(
contentAcc
-
>
AsDoc
(
)
)
aID
)
;
}
AccessibleWrap
*
RootAccessibleWrap
:
:
FindAccessibleById
(
DocRemoteAccessibleWrap
*
aDoc
int32_t
aID
)
{
AccessibleWrap
*
acc
=
aDoc
-
>
GetAccessibleByID
(
aID
)
;
uint32_t
index
=
0
;
while
(
!
acc
)
{
auto
child
=
static_cast
<
DocRemoteAccessibleWrap
*
>
(
aDoc
-
>
GetChildDocumentAt
(
index
+
+
)
)
;
if
(
!
child
)
{
break
;
}
if
(
child
-
>
VirtualViewID
(
)
=
=
aID
)
{
acc
=
child
;
}
else
{
acc
=
FindAccessibleById
(
child
aID
)
;
}
}
return
acc
;
}
AccessibleWrap
*
RootAccessibleWrap
:
:
FindAccessibleById
(
DocAccessibleWrap
*
aDoc
int32_t
aID
)
{
AccessibleWrap
*
acc
=
aDoc
-
>
GetAccessibleByID
(
aID
)
;
uint32_t
index
=
0
;
while
(
!
acc
)
{
auto
child
=
static_cast
<
DocAccessibleWrap
*
>
(
aDoc
-
>
GetChildDocumentAt
(
index
+
+
)
)
;
if
(
!
child
)
{
break
;
}
acc
=
FindAccessibleById
(
child
aID
)
;
}
return
acc
;
}
nsresult
RootAccessibleWrap
:
:
AddEventListeners
(
)
{
nsPIDOMWindowOuter
*
window
=
mDocumentNode
-
>
GetWindow
(
)
;
nsCOMPtr
<
EventTarget
>
nstarget
=
window
?
window
-
>
GetParentTarget
(
)
:
nullptr
;
if
(
nstarget
)
{
nstarget
-
>
AddEventListener
(
u
"
MozMouseExploreByTouch
"
_ns
this
false
true
)
;
}
return
RootAccessible
:
:
AddEventListeners
(
)
;
}
nsresult
RootAccessibleWrap
:
:
RemoveEventListeners
(
)
{
nsPIDOMWindowOuter
*
window
=
mDocumentNode
-
>
GetWindow
(
)
;
nsCOMPtr
<
EventTarget
>
nstarget
=
window
?
window
-
>
GetParentTarget
(
)
:
nullptr
;
if
(
nstarget
)
{
nstarget
-
>
RemoveEventListener
(
u
"
MozMouseExploreByTouch
"
_ns
this
true
)
;
}
return
RootAccessible
:
:
RemoveEventListeners
(
)
;
}
NS_IMETHODIMP
RootAccessibleWrap
:
:
HandleEvent
(
Event
*
aDOMEvent
)
{
WidgetMouseEvent
*
widgetEvent
=
aDOMEvent
-
>
WidgetEventPtr
(
)
-
>
AsMouseEvent
(
)
;
if
(
widgetEvent
&
&
widgetEvent
-
>
mMessage
=
=
eMouseExploreByTouch
)
{
if
(
HasShutdown
(
)
)
{
return
NS_OK
;
}
if
(
MouseEvent
*
mouseEvent
=
aDOMEvent
-
>
AsMouseEvent
(
)
)
{
LayoutDeviceIntPoint
point
=
mouseEvent
-
>
ScreenPointLayoutDevicePix
(
)
;
ExploreByTouch
(
point
.
x
point
.
y
)
;
}
return
NS_OK
;
}
return
RootAccessible
:
:
HandleEvent
(
aDOMEvent
)
;
}
