#
include
"
XULComboboxAccessible
.
h
"
#
include
"
LocalAccessible
-
inl
.
h
"
#
include
"
nsAccessibilityService
.
h
"
#
include
"
DocAccessible
.
h
"
#
include
"
nsCoreUtils
.
h
"
#
include
"
nsFocusManager
.
h
"
#
include
"
mozilla
/
a11y
/
DocAccessibleParent
.
h
"
#
include
"
mozilla
/
a11y
/
Role
.
h
"
#
include
"
States
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
#
include
"
nsIDOMXULMenuListElement
.
h
"
using
namespace
mozilla
:
:
a11y
;
XULComboboxAccessible
:
:
XULComboboxAccessible
(
nsIContent
*
aContent
DocAccessible
*
aDoc
)
:
AccessibleWrap
(
aContent
aDoc
)
{
mGenericTypes
|
=
eCombobox
;
}
role
XULComboboxAccessible
:
:
NativeRole
(
)
const
{
return
roles
:
:
COMBOBOX
;
}
uint64_t
XULComboboxAccessible
:
:
NativeState
(
)
const
{
uint64_t
state
=
LocalAccessible
:
:
NativeState
(
)
;
nsCOMPtr
<
nsIDOMXULMenuListElement
>
menuList
=
Elm
(
)
-
>
AsXULMenuList
(
)
;
if
(
menuList
)
{
bool
isOpen
=
false
;
menuList
-
>
GetOpen
(
&
isOpen
)
;
if
(
isOpen
)
{
state
|
=
states
:
:
EXPANDED
;
}
}
return
state
|
states
:
:
HASPOPUP
|
states
:
:
EXPANDABLE
;
}
bool
XULComboboxAccessible
:
:
IsAcceptableChild
(
nsIContent
*
aContent
)
const
{
return
AccessibleWrap
:
:
IsAcceptableChild
(
aContent
)
&
&
!
aContent
-
>
IsText
(
)
;
}
EDescriptionValueFlag
XULComboboxAccessible
:
:
Description
(
nsString
&
aDescription
)
const
{
aDescription
.
Truncate
(
)
;
nsCOMPtr
<
nsIDOMXULMenuListElement
>
menuListElm
=
Elm
(
)
-
>
AsXULMenuList
(
)
;
if
(
!
menuListElm
)
return
eDescriptionOK
;
nsCOMPtr
<
dom
:
:
Element
>
focusedOptionItem
;
menuListElm
-
>
GetSelectedItem
(
getter_AddRefs
(
focusedOptionItem
)
)
;
if
(
focusedOptionItem
&
&
mDoc
)
{
LocalAccessible
*
focusedOptionAcc
=
mDoc
-
>
GetAccessible
(
focusedOptionItem
)
;
if
(
focusedOptionAcc
)
{
return
focusedOptionAcc
-
>
Description
(
aDescription
)
;
}
}
return
eDescriptionOK
;
}
void
XULComboboxAccessible
:
:
Value
(
nsString
&
aValue
)
const
{
aValue
.
Truncate
(
)
;
nsCOMPtr
<
nsIDOMXULMenuListElement
>
menuList
=
Elm
(
)
-
>
AsXULMenuList
(
)
;
if
(
menuList
)
menuList
-
>
GetLabel
(
aValue
)
;
}
bool
XULComboboxAccessible
:
:
HasPrimaryAction
(
)
const
{
return
true
;
}
bool
XULComboboxAccessible
:
:
DoAction
(
uint8_t
aIndex
)
const
{
if
(
aIndex
!
=
XULComboboxAccessible
:
:
eAction_Click
)
return
false
;
nsCOMPtr
<
nsIDOMXULMenuListElement
>
menuList
=
Elm
(
)
-
>
AsXULMenuList
(
)
;
if
(
!
menuList
)
return
false
;
bool
isDroppedDown
=
false
;
menuList
-
>
GetOpen
(
&
isDroppedDown
)
;
menuList
-
>
SetOpen
(
!
isDroppedDown
)
;
return
true
;
}
void
XULComboboxAccessible
:
:
ActionNameAt
(
uint8_t
aIndex
nsAString
&
aName
)
{
aName
.
Truncate
(
)
;
if
(
aIndex
!
=
XULComboboxAccessible
:
:
eAction_Click
)
return
;
nsCOMPtr
<
nsIDOMXULMenuListElement
>
menuList
=
Elm
(
)
-
>
AsXULMenuList
(
)
;
if
(
!
menuList
)
return
;
bool
isDroppedDown
=
false
;
menuList
-
>
GetOpen
(
&
isDroppedDown
)
;
if
(
isDroppedDown
)
{
aName
.
AssignLiteral
(
"
close
"
)
;
}
else
{
aName
.
AssignLiteral
(
"
open
"
)
;
}
}
bool
XULComboboxAccessible
:
:
IsActiveWidget
(
)
const
{
if
(
mContent
-
>
AsElement
(
)
-
>
AttrValueIs
(
kNameSpaceID_None
nsGkAtoms
:
:
editable
nsGkAtoms
:
:
_true
eIgnoreCase
)
)
{
int32_t
childCount
=
mChildren
.
Length
(
)
;
for
(
int32_t
idx
=
0
;
idx
<
childCount
;
idx
+
+
)
{
LocalAccessible
*
child
=
mChildren
[
idx
]
;
if
(
child
-
>
Role
(
)
=
=
roles
:
:
ENTRY
)
{
return
FocusMgr
(
)
-
>
HasDOMFocus
(
child
-
>
GetContent
(
)
)
;
}
}
return
false
;
}
return
FocusMgr
(
)
-
>
HasDOMFocus
(
mContent
)
;
}
bool
XULComboboxAccessible
:
:
AreItemsOperable
(
)
const
{
nsCOMPtr
<
nsIDOMXULMenuListElement
>
menuListElm
=
Elm
(
)
-
>
AsXULMenuList
(
)
;
if
(
menuListElm
)
{
bool
isOpen
=
false
;
menuListElm
-
>
GetOpen
(
&
isOpen
)
;
return
isOpen
;
}
return
false
;
}
Accessible
*
XULContentSelectDropdownAccessible
:
:
Parent
(
)
const
{
Accessible
*
focusedAcc
=
nullptr
;
if
(
auto
*
focusedNode
=
FocusMgr
(
)
-
>
FocusedDOMNode
(
)
)
{
DocAccessible
*
doc
=
GetAccService
(
)
-
>
GetDocAccessible
(
focusedNode
-
>
OwnerDoc
(
)
)
;
focusedAcc
=
doc
-
>
GetAccessible
(
focusedNode
)
;
}
else
{
nsFocusManager
*
focusManagerDOM
=
nsFocusManager
:
:
GetFocusManager
(
)
;
dom
:
:
BrowsingContext
*
focusedContext
=
focusManagerDOM
-
>
GetFocusedBrowsingContextInChrome
(
)
;
DocAccessibleParent
*
focusedDoc
=
DocAccessibleParent
:
:
GetFrom
(
focusedContext
)
;
if
(
NS_WARN_IF
(
!
focusedDoc
)
)
{
return
LocalParent
(
)
;
}
MOZ_ASSERT
(
focusedDoc
-
>
IsDoc
(
)
"
Got
non
-
document
?
"
)
;
focusedAcc
=
focusedDoc
-
>
AsDoc
(
)
-
>
GetFocusedAcc
(
)
;
}
if
(
!
NS_WARN_IF
(
focusedAcc
&
&
focusedAcc
-
>
IsHTMLCombobox
(
)
)
)
{
return
LocalParent
(
)
;
}
return
focusedAcc
;
}
