#
if
defined
(
MOZILLA_INTERNAL_API
)
#
error
This
code
is
NOT
for
internal
Gecko
use
!
#
endif
#
include
"
AccessibleHandler
.
h
"
#
include
"
AccessibleHandlerControl
.
h
"
#
include
"
HandlerChildEnumerator
.
h
"
#
include
"
HandlerRelation
.
h
"
#
include
"
Factory
.
h
"
#
include
"
HandlerData
.
h
"
#
include
"
mozilla
/
ArrayUtils
.
h
"
#
include
"
mozilla
/
a11y
/
HandlerDataCleanup
.
h
"
#
include
"
mozilla
/
mscom
/
Registration
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
<
objbase
.
h
>
#
include
<
uiautomation
.
h
>
#
include
<
winreg
.
h
>
#
include
"
AccessibleHypertext
.
h
"
#
include
"
AccessibleHypertext2
.
h
"
#
include
"
AccessibleRole
.
h
"
#
include
"
Accessible2_i
.
c
"
#
include
"
Accessible2_2_i
.
c
"
#
include
"
Accessible2_3_i
.
c
"
#
include
"
AccessibleAction_i
.
c
"
#
include
"
AccessibleHyperlink_i
.
c
"
#
include
"
AccessibleHypertext_i
.
c
"
#
include
"
AccessibleHypertext2_i
.
c
"
#
include
"
AccessibleTable_i
.
c
"
#
include
"
AccessibleTable2_i
.
c
"
#
include
"
AccessibleTableCell_i
.
c
"
#
include
"
AccessibleText_i
.
c
"
namespace
mozilla
{
namespace
a11y
{
static
mscom
:
:
Factory
<
AccessibleHandler
>
sHandlerFactory
;
HRESULT
AccessibleHandler
:
:
Create
(
IUnknown
*
aOuter
REFIID
aIid
void
*
*
aOutInterface
)
{
if
(
!
aOutInterface
|
|
!
aOuter
|
|
aIid
!
=
IID_IUnknown
)
{
return
E_INVALIDARG
;
}
*
aOutInterface
=
nullptr
;
HRESULT
hr
;
RefPtr
<
AccessibleHandler
>
handler
(
new
AccessibleHandler
(
aOuter
&
hr
)
)
;
if
(
!
handler
)
{
return
E_OUTOFMEMORY
;
}
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
handler
-
>
InternalQueryInterface
(
aIid
aOutInterface
)
;
}
AccessibleHandler
:
:
AccessibleHandler
(
IUnknown
*
aOuter
HRESULT
*
aResult
)
:
mscom
:
:
Handler
(
aOuter
aResult
)
mDispatch
(
nullptr
)
mIA2PassThru
(
nullptr
)
mServProvPassThru
(
nullptr
)
mIAHyperlinkPassThru
(
nullptr
)
mIATableCellPassThru
(
nullptr
)
mIAHypertextPassThru
(
nullptr
)
mCachedData
(
)
mCacheGen
(
0
)
mCachedHyperlinks
(
nullptr
)
mCachedNHyperlinks
(
-
1
)
mCachedTextAttribRuns
(
nullptr
)
mCachedNTextAttribRuns
(
-
1
)
mCachedRelations
(
nullptr
)
mCachedNRelations
(
-
1
)
{
RefPtr
<
AccessibleHandlerControl
>
ctl
(
gControlFactory
.
GetOrCreateSingleton
(
)
)
;
MOZ_ASSERT
(
ctl
)
;
if
(
!
ctl
)
{
if
(
aResult
)
{
*
aResult
=
E_UNEXPECTED
;
}
return
;
}
mCacheGen
=
ctl
-
>
GetCacheGen
(
)
;
}
AccessibleHandler
:
:
~
AccessibleHandler
(
)
{
CleanupDynamicIA2Data
(
mCachedData
.
mDynamicData
false
)
;
if
(
mCachedData
.
mGeckoBackChannel
)
{
mCachedData
.
mGeckoBackChannel
-
>
Release
(
)
;
}
ClearTextCache
(
)
;
ClearRelationCache
(
)
;
}
HRESULT
AccessibleHandler
:
:
ResolveIA2
(
)
{
if
(
mIA2PassThru
)
{
return
S_OK
;
}
RefPtr
<
IUnknown
>
proxy
(
GetProxy
(
)
)
;
if
(
!
proxy
)
{
return
E_UNEXPECTED
;
}
HRESULT
hr
=
proxy
-
>
QueryInterface
(
NEWEST_IA2_IID
reinterpret_cast
<
void
*
*
>
(
&
mIA2PassThru
)
)
;
if
(
SUCCEEDED
(
hr
)
)
{
mIA2PassThru
-
>
Release
(
)
;
}
return
hr
;
}
HRESULT
AccessibleHandler
:
:
ResolveIAHyperlink
(
)
{
if
(
mIAHyperlinkPassThru
)
{
return
S_OK
;
}
RefPtr
<
IUnknown
>
proxy
(
GetProxy
(
)
)
;
if
(
!
proxy
)
{
return
E_UNEXPECTED
;
}
HRESULT
hr
=
proxy
-
>
QueryInterface
(
IID_IAccessibleHyperlink
reinterpret_cast
<
void
*
*
>
(
&
mIAHyperlinkPassThru
)
)
;
if
(
SUCCEEDED
(
hr
)
)
{
mIAHyperlinkPassThru
-
>
Release
(
)
;
}
return
hr
;
}
HRESULT
AccessibleHandler
:
:
ResolveIATableCell
(
)
{
if
(
mIATableCellPassThru
)
{
return
S_OK
;
}
RefPtr
<
IUnknown
>
proxy
(
GetProxy
(
)
)
;
if
(
!
proxy
)
{
return
E_UNEXPECTED
;
}
HRESULT
hr
=
proxy
-
>
QueryInterface
(
IID_IAccessibleTableCell
reinterpret_cast
<
void
*
*
>
(
&
mIATableCellPassThru
)
)
;
if
(
SUCCEEDED
(
hr
)
)
{
mIATableCellPassThru
-
>
Release
(
)
;
}
return
hr
;
}
HRESULT
AccessibleHandler
:
:
ResolveIAHypertext
(
)
{
if
(
mIAHypertextPassThru
)
{
return
S_OK
;
}
RefPtr
<
IUnknown
>
proxy
(
GetProxy
(
)
)
;
if
(
!
proxy
)
{
return
E_UNEXPECTED
;
}
HRESULT
hr
=
proxy
-
>
QueryInterface
(
IID_IAccessibleHypertext2
reinterpret_cast
<
void
*
*
>
(
&
mIAHypertextPassThru
)
)
;
if
(
SUCCEEDED
(
hr
)
)
{
mIAHypertextPassThru
-
>
Release
(
)
;
}
return
hr
;
}
HRESULT
AccessibleHandler
:
:
MaybeUpdateCachedData
(
)
{
RefPtr
<
AccessibleHandlerControl
>
ctl
(
gControlFactory
.
GetOrCreateSingleton
(
)
)
;
if
(
!
ctl
)
{
return
E_OUTOFMEMORY
;
}
uint32_t
gen
=
ctl
-
>
GetCacheGen
(
)
;
if
(
gen
=
=
mCacheGen
)
{
return
S_OK
;
}
if
(
!
mCachedData
.
mGeckoBackChannel
)
{
return
E_POINTER
;
}
HRESULT
hr
=
mCachedData
.
mGeckoBackChannel
-
>
Refresh
(
&
mCachedData
.
mDynamicData
)
;
if
(
SUCCEEDED
(
hr
)
)
{
mCacheGen
=
gen
;
}
return
hr
;
}
HRESULT
AccessibleHandler
:
:
GetAllTextInfo
(
BSTR
*
aText
)
{
MOZ_ASSERT
(
mCachedData
.
mGeckoBackChannel
)
;
ClearTextCache
(
)
;
return
mCachedData
.
mGeckoBackChannel
-
>
get_AllTextInfo
(
aText
&
mCachedHyperlinks
&
mCachedNHyperlinks
&
mCachedTextAttribRuns
&
mCachedNTextAttribRuns
)
;
}
void
AccessibleHandler
:
:
ClearTextCache
(
)
{
if
(
mCachedNHyperlinks
>
=
0
)
{
for
(
long
index
=
0
;
index
<
mCachedNHyperlinks
;
+
+
index
)
{
mCachedHyperlinks
[
index
]
-
>
Release
(
)
;
}
if
(
mCachedHyperlinks
)
{
:
:
CoTaskMemFree
(
mCachedHyperlinks
)
;
mCachedHyperlinks
=
nullptr
;
}
mCachedNHyperlinks
=
-
1
;
}
if
(
mCachedTextAttribRuns
)
{
for
(
long
index
=
0
;
index
<
mCachedNTextAttribRuns
;
+
+
index
)
{
if
(
mCachedTextAttribRuns
[
index
]
.
text
)
{
:
:
SysFreeString
(
mCachedTextAttribRuns
[
index
]
.
text
)
;
}
}
:
:
CoTaskMemFree
(
mCachedTextAttribRuns
)
;
mCachedTextAttribRuns
=
nullptr
;
mCachedNTextAttribRuns
=
-
1
;
}
}
HRESULT
AccessibleHandler
:
:
GetRelationsInfo
(
)
{
MOZ_ASSERT
(
mCachedData
.
mGeckoBackChannel
)
;
ClearRelationCache
(
)
;
return
mCachedData
.
mGeckoBackChannel
-
>
get_RelationsInfo
(
&
mCachedRelations
&
mCachedNRelations
)
;
}
void
AccessibleHandler
:
:
ClearRelationCache
(
)
{
if
(
mCachedNRelations
=
=
-
1
)
{
return
;
}
if
(
mCachedRelations
)
{
for
(
long
index
=
0
;
index
<
mCachedNRelations
;
+
+
index
)
{
IARelationData
&
relData
=
mCachedRelations
[
index
]
;
if
(
relData
.
mType
)
{
:
:
SysFreeString
(
relData
.
mType
)
;
}
}
:
:
CoTaskMemFree
(
mCachedRelations
)
;
mCachedRelations
=
nullptr
;
}
mCachedNRelations
=
-
1
;
}
HRESULT
AccessibleHandler
:
:
ResolveIDispatch
(
)
{
if
(
mDispatch
)
{
return
S_OK
;
}
HRESULT
hr
;
if
(
!
mDispatchUnk
)
{
RefPtr
<
AccessibleHandlerControl
>
ctl
(
gControlFactory
.
GetOrCreateSingleton
(
)
)
;
if
(
!
ctl
)
{
return
E_OUTOFMEMORY
;
}
RefPtr
<
ITypeInfo
>
typeinfo
;
hr
=
ctl
-
>
GetHandlerTypeInfo
(
getter_AddRefs
(
typeinfo
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
hr
=
:
:
CreateStdDispatch
(
GetOuter
(
)
static_cast
<
NEWEST_IA2_INTERFACE
*
>
(
this
)
typeinfo
getter_AddRefs
(
mDispatchUnk
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
}
hr
=
mDispatchUnk
-
>
QueryInterface
(
IID_IDispatch
reinterpret_cast
<
void
*
*
>
(
&
mDispatch
)
)
;
if
(
SUCCEEDED
(
hr
)
)
{
mDispatch
-
>
Release
(
)
;
}
return
hr
;
}
HRESULT
AccessibleHandler
:
:
QueryHandlerInterface
(
IUnknown
*
aProxyUnknown
REFIID
aIid
void
*
*
aOutInterface
)
{
MOZ_ASSERT
(
aProxyUnknown
)
;
static_assert
(
&
NEWEST_IA2_IID
=
=
&
IID_IAccessible2_3
"
You
have
modified
NEWEST_IA2_IID
.
This
code
needs
updating
.
"
)
;
if
(
aIid
=
=
IID_IDispatch
|
|
aIid
=
=
IID_IAccessible2_3
|
|
aIid
=
=
IID_IAccessible2_2
|
|
aIid
=
=
IID_IAccessible2
|
|
aIid
=
=
IID_IAccessible
)
{
RefPtr
<
NEWEST_IA2_INTERFACE
>
ia2
(
static_cast
<
NEWEST_IA2_INTERFACE
*
>
(
this
)
)
;
ia2
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
if
(
aIid
=
=
IID_IServiceProvider
)
{
RefPtr
<
IServiceProvider
>
svcProv
(
static_cast
<
IServiceProvider
*
>
(
this
)
)
;
svcProv
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
if
(
HasPayload
(
)
)
{
if
(
(
(
aIid
=
=
IID_IAccessibleText
|
|
aIid
=
=
IID_IAccessibleHypertext
|
|
aIid
=
=
IID_IAccessibleHypertext2
)
&
&
!
mCachedData
.
mStaticData
.
mIAHypertext
)
|
|
(
(
aIid
=
=
IID_IAccessibleAction
|
|
aIid
=
=
IID_IAccessibleHyperlink
)
&
&
!
mCachedData
.
mStaticData
.
mIAHyperlink
)
|
|
(
aIid
=
=
IID_IAccessibleTable
&
&
!
mCachedData
.
mStaticData
.
mIATable
)
|
|
(
aIid
=
=
IID_IAccessibleTable2
&
&
!
mCachedData
.
mStaticData
.
mIATable2
)
|
|
(
aIid
=
=
IID_IAccessibleTableCell
&
&
!
mCachedData
.
mStaticData
.
mIATableCell
)
)
{
return
S_FALSE
;
}
}
if
(
aIid
=
=
IID_IAccessibleAction
|
|
aIid
=
=
IID_IAccessibleHyperlink
)
{
RefPtr
<
IAccessibleHyperlink
>
iaLink
(
static_cast
<
IAccessibleHyperlink
*
>
(
this
)
)
;
iaLink
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
if
(
aIid
=
=
IID_IAccessibleTableCell
)
{
RefPtr
<
IAccessibleTableCell
>
iaCell
(
static_cast
<
IAccessibleTableCell
*
>
(
this
)
)
;
iaCell
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
if
(
aIid
=
=
IID_IAccessibleText
|
|
aIid
=
=
IID_IAccessibleHypertext
|
|
aIid
=
=
IID_IAccessibleHypertext2
)
{
RefPtr
<
IAccessibleHypertext2
>
iaHt
(
static_cast
<
IAccessibleHypertext2
*
>
(
this
)
)
;
iaHt
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
if
(
aIid
=
=
IID_IProvideClassInfo
)
{
RefPtr
<
IProvideClassInfo
>
clsInfo
(
this
)
;
clsInfo
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
if
(
aIid
=
=
IID_IEnumVARIANT
&
&
mCachedData
.
mGeckoBackChannel
)
{
if
(
mCachedData
.
mDynamicData
.
mChildCount
=
=
0
)
{
return
E_NOINTERFACE
;
}
if
(
mCachedData
.
mDynamicData
.
mIA2Role
=
=
IA2_ROLE_INTERNAL_FRAME
&
&
mCachedData
.
mDynamicData
.
mChildCount
=
=
1
)
{
return
S_FALSE
;
}
RefPtr
<
IEnumVARIANT
>
childEnum
(
new
HandlerChildEnumerator
(
this
mCachedData
.
mGeckoBackChannel
)
)
;
childEnum
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
return
E_NOINTERFACE
;
}
HRESULT
AccessibleHandler
:
:
ReadHandlerPayload
(
IStream
*
aStream
REFIID
aIid
)
{
if
(
!
aStream
)
{
return
E_INVALIDARG
;
}
mscom
:
:
StructFromStream
deserializer
(
aStream
)
;
if
(
!
deserializer
)
{
return
E_FAIL
;
}
if
(
deserializer
.
IsEmpty
(
)
)
{
return
S_FALSE
;
}
IA2Payload
newData
{
}
;
if
(
!
deserializer
.
Read
(
&
newData
&
IA2Payload_Decode
)
)
{
return
E_FAIL
;
}
CleanupDynamicIA2Data
(
mCachedData
.
mDynamicData
false
)
;
mCachedData
=
newData
;
ReleaseStaticIA2DataInterfaces
(
mCachedData
.
mStaticData
)
;
if
(
!
mCachedData
.
mGeckoBackChannel
)
{
return
S_OK
;
}
RefPtr
<
AccessibleHandlerControl
>
ctl
(
gControlFactory
.
GetOrCreateSingleton
(
)
)
;
if
(
!
ctl
)
{
return
E_OUTOFMEMORY
;
}
return
ctl
-
>
Register
(
WrapNotNull
(
mCachedData
.
mGeckoBackChannel
)
)
;
}
REFIID
AccessibleHandler
:
:
MarshalAs
(
REFIID
aIid
)
{
static_assert
(
&
NEWEST_IA2_IID
=
=
&
IID_IAccessible2_3
"
You
have
modified
NEWEST_IA2_IID
.
This
code
needs
updating
.
"
)
;
if
(
aIid
=
=
IID_IAccessible2_3
|
|
aIid
=
=
IID_IAccessible2_2
|
|
aIid
=
=
IID_IAccessible2
|
|
aIid
=
=
IID_IAccessible
|
|
aIid
=
=
IID_IDispatch
)
{
return
NEWEST_IA2_IID
;
}
return
aIid
;
}
HRESULT
AccessibleHandler
:
:
GetMarshalInterface
(
REFIID
aMarshalAsIid
NotNull
<
IUnknown
*
>
aProxy
NotNull
<
IID
*
>
aOutIid
NotNull
<
IUnknown
*
*
>
aOutUnk
)
{
if
(
aMarshalAsIid
=
=
NEWEST_IA2_IID
)
{
*
aOutIid
=
IID_IAccessible
;
}
else
{
*
aOutIid
=
aMarshalAsIid
;
}
return
aProxy
-
>
QueryInterface
(
aMarshalAsIid
reinterpret_cast
<
void
*
*
>
(
static_cast
<
IUnknown
*
*
>
(
aOutUnk
)
)
)
;
}
HRESULT
AccessibleHandler
:
:
GetHandlerPayloadSize
(
REFIID
aIid
DWORD
*
aOutPayloadSize
)
{
if
(
!
aOutPayloadSize
)
{
return
E_INVALIDARG
;
}
if
(
FAILED
(
MaybeUpdateCachedData
(
)
)
)
{
*
aOutPayloadSize
=
mscom
:
:
StructToStream
:
:
GetEmptySize
(
)
;
return
S_OK
;
}
mSerializer
=
MakeUnique
<
mscom
:
:
StructToStream
>
(
mCachedData
&
IA2Payload_Encode
)
;
if
(
!
mSerializer
)
{
return
E_FAIL
;
}
*
aOutPayloadSize
=
mSerializer
-
>
GetSize
(
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
WriteHandlerPayload
(
IStream
*
aStream
REFIID
aIid
)
{
if
(
!
aStream
)
{
return
E_INVALIDARG
;
}
if
(
!
mSerializer
)
{
return
E_UNEXPECTED
;
}
HRESULT
hr
=
mSerializer
-
>
Write
(
aStream
)
;
mSerializer
.
reset
(
)
;
return
hr
;
}
HRESULT
AccessibleHandler
:
:
QueryInterface
(
REFIID
riid
void
*
*
ppv
)
{
return
Handler
:
:
QueryInterface
(
riid
ppv
)
;
}
ULONG
AccessibleHandler
:
:
AddRef
(
)
{
return
Handler
:
:
AddRef
(
)
;
}
ULONG
AccessibleHandler
:
:
Release
(
)
{
return
Handler
:
:
Release
(
)
;
}
HRESULT
AccessibleHandler
:
:
GetTypeInfoCount
(
UINT
*
pctinfo
)
{
HRESULT
hr
=
ResolveIDispatch
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mDispatch
-
>
GetTypeInfoCount
(
pctinfo
)
;
}
HRESULT
AccessibleHandler
:
:
GetTypeInfo
(
UINT
iTInfo
LCID
lcid
ITypeInfo
*
*
ppTInfo
)
{
HRESULT
hr
=
ResolveIDispatch
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mDispatch
-
>
GetTypeInfo
(
iTInfo
lcid
ppTInfo
)
;
}
HRESULT
AccessibleHandler
:
:
GetIDsOfNames
(
REFIID
riid
LPOLESTR
*
rgszNames
UINT
cNames
LCID
lcid
DISPID
*
rgDispId
)
{
HRESULT
hr
=
ResolveIDispatch
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mDispatch
-
>
GetIDsOfNames
(
riid
rgszNames
cNames
lcid
rgDispId
)
;
}
HRESULT
AccessibleHandler
:
:
Invoke
(
DISPID
dispIdMember
REFIID
riid
LCID
lcid
WORD
wFlags
DISPPARAMS
*
pDispParams
VARIANT
*
pVarResult
EXCEPINFO
*
pExcepInfo
UINT
*
puArgErr
)
{
HRESULT
hr
=
ResolveIDispatch
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mDispatch
-
>
Invoke
(
dispIdMember
riid
lcid
wFlags
pDispParams
pVarResult
pExcepInfo
puArgErr
)
;
}
#
define
BEGIN_CACHE_ACCESS
\
{
\
HRESULT
hr
;
\
if
(
FAILED
(
hr
=
MaybeUpdateCachedData
(
)
)
)
{
\
return
hr
;
\
}
\
}
#
define
GET_FIELD
(
member
assignTo
)
\
{
assignTo
=
mCachedData
.
mDynamicData
.
member
;
}
#
define
GET_BSTR
(
member
assignTo
)
\
{
assignTo
=
CopyBSTR
(
mCachedData
.
mDynamicData
.
member
)
;
}
HRESULT
AccessibleHandler
:
:
get_accParent
(
IDispatch
*
*
ppdispParent
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accParent
(
ppdispParent
)
;
}
HRESULT
AccessibleHandler
:
:
get_accChildCount
(
long
*
pcountChildren
)
{
if
(
!
pcountChildren
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accChildCount
(
pcountChildren
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mChildCount
*
pcountChildren
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_accChild
(
VARIANT
varChild
IDispatch
*
*
ppdispChild
)
{
if
(
!
ppdispChild
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
vt
=
=
VT_I4
&
&
varChild
.
lVal
=
=
CHILDID_SELF
)
{
RefPtr
<
IDispatch
>
disp
(
this
)
;
disp
.
forget
(
ppdispChild
)
;
return
S_OK
;
}
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accChild
(
varChild
ppdispChild
)
;
}
HRESULT
AccessibleHandler
:
:
get_accName
(
VARIANT
varChild
BSTR
*
pszName
)
{
if
(
!
pszName
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accName
(
varChild
pszName
)
;
}
BEGIN_CACHE_ACCESS
;
GET_BSTR
(
mName
*
pszName
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_accValue
(
VARIANT
varChild
BSTR
*
pszValue
)
{
if
(
!
pszValue
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accValue
(
varChild
pszValue
)
;
}
BEGIN_CACHE_ACCESS
;
GET_BSTR
(
mValue
*
pszValue
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_accDescription
(
VARIANT
varChild
BSTR
*
pszDescription
)
{
if
(
!
pszDescription
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accDescription
(
varChild
pszDescription
)
;
}
BEGIN_CACHE_ACCESS
;
GET_BSTR
(
mDescription
*
pszDescription
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_accRole
(
VARIANT
varChild
VARIANT
*
pvarRole
)
{
if
(
!
pvarRole
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accRole
(
varChild
pvarRole
)
;
}
BEGIN_CACHE_ACCESS
;
return
:
:
VariantCopy
(
pvarRole
&
mCachedData
.
mDynamicData
.
mRole
)
;
}
HRESULT
AccessibleHandler
:
:
get_accState
(
VARIANT
varChild
VARIANT
*
pvarState
)
{
if
(
!
pvarState
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accState
(
varChild
pvarState
)
;
}
pvarState
-
>
vt
=
VT_I4
;
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mState
pvarState
-
>
lVal
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_accHelp
(
VARIANT
varChild
BSTR
*
pszHelp
)
{
if
(
!
pszHelp
)
{
return
E_INVALIDARG
;
}
*
pszHelp
=
nullptr
;
return
S_FALSE
;
}
HRESULT
AccessibleHandler
:
:
get_accHelpTopic
(
BSTR
*
pszHelpFile
VARIANT
varChild
long
*
pidTopic
)
{
if
(
!
pszHelpFile
|
|
!
pidTopic
)
{
return
E_INVALIDARG
;
}
*
pszHelpFile
=
nullptr
;
*
pidTopic
=
0
;
return
S_FALSE
;
}
HRESULT
AccessibleHandler
:
:
get_accKeyboardShortcut
(
VARIANT
varChild
BSTR
*
pszKeyboardShortcut
)
{
if
(
!
pszKeyboardShortcut
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accKeyboardShortcut
(
varChild
pszKeyboardShortcut
)
;
}
BEGIN_CACHE_ACCESS
;
GET_BSTR
(
mKeyboardShortcut
*
pszKeyboardShortcut
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_accFocus
(
VARIANT
*
pvarChild
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accFocus
(
pvarChild
)
;
}
HRESULT
AccessibleHandler
:
:
get_accSelection
(
VARIANT
*
pvarChildren
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accSelection
(
pvarChildren
)
;
}
HRESULT
AccessibleHandler
:
:
get_accDefaultAction
(
VARIANT
varChild
BSTR
*
pszDefaultAction
)
{
if
(
!
pszDefaultAction
)
{
return
E_INVALIDARG
;
}
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accDefaultAction
(
varChild
pszDefaultAction
)
;
}
BEGIN_CACHE_ACCESS
;
GET_BSTR
(
mDefaultAction
*
pszDefaultAction
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
accSelect
(
long
flagsSelect
VARIANT
varChild
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
accSelect
(
flagsSelect
varChild
)
;
}
HRESULT
AccessibleHandler
:
:
accLocation
(
long
*
pxLeft
long
*
pyTop
long
*
pcxWidth
long
*
pcyHeight
VARIANT
varChild
)
{
if
(
varChild
.
lVal
!
=
CHILDID_SELF
|
|
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
accLocation
(
pxLeft
pyTop
pcxWidth
pcyHeight
varChild
)
;
}
if
(
!
pxLeft
|
|
!
pyTop
|
|
!
pcxWidth
|
|
!
pcyHeight
)
{
return
E_INVALIDARG
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mLeft
*
pxLeft
)
;
GET_FIELD
(
mTop
*
pyTop
)
;
GET_FIELD
(
mWidth
*
pcxWidth
)
;
GET_FIELD
(
mHeight
*
pcyHeight
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
accNavigate
(
long
navDir
VARIANT
varStart
VARIANT
*
pvarEndUpAt
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
accNavigate
(
navDir
varStart
pvarEndUpAt
)
;
}
HRESULT
AccessibleHandler
:
:
accHitTest
(
long
xLeft
long
yTop
VARIANT
*
pvarChild
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
accHitTest
(
xLeft
yTop
pvarChild
)
;
}
HRESULT
AccessibleHandler
:
:
accDoDefaultAction
(
VARIANT
varChild
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
accDoDefaultAction
(
varChild
)
;
}
HRESULT
AccessibleHandler
:
:
put_accName
(
VARIANT
varChild
BSTR
szName
)
{
return
E_NOTIMPL
;
}
HRESULT
AccessibleHandler
:
:
put_accValue
(
VARIANT
varChild
BSTR
szValue
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
put_accValue
(
varChild
szValue
)
;
}
HRESULT
AccessibleHandler
:
:
get_nRelations
(
long
*
nRelations
)
{
if
(
!
nRelations
)
{
return
E_INVALIDARG
;
}
HRESULT
hr
;
if
(
mCachedData
.
mGeckoBackChannel
)
{
hr
=
GetRelationsInfo
(
)
;
if
(
SUCCEEDED
(
hr
)
)
{
*
nRelations
=
mCachedNRelations
;
return
S_OK
;
}
}
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_nRelations
(
nRelations
)
;
}
HRESULT
AccessibleHandler
:
:
get_relation
(
long
relationIndex
IAccessibleRelation
*
*
relation
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_relation
(
relationIndex
relation
)
;
}
HRESULT
AccessibleHandler
:
:
get_relations
(
long
maxRelations
IAccessibleRelation
*
*
relations
long
*
nRelations
)
{
if
(
maxRelations
=
=
0
|
|
!
relations
|
|
!
nRelations
)
{
return
E_INVALIDARG
;
}
if
(
mCachedNRelations
!
=
-
1
&
&
maxRelations
>
=
mCachedNRelations
)
{
for
(
long
index
=
0
;
index
<
mCachedNRelations
;
+
+
index
)
{
IARelationData
&
relData
=
mCachedRelations
[
index
]
;
RefPtr
<
IAccessibleRelation
>
hrel
(
new
HandlerRelation
(
this
relData
)
)
;
hrel
.
forget
(
&
relations
[
index
]
)
;
}
*
nRelations
=
mCachedNRelations
;
:
:
CoTaskMemFree
(
mCachedRelations
)
;
mCachedRelations
=
nullptr
;
mCachedNRelations
=
-
1
;
return
S_OK
;
}
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_relations
(
maxRelations
relations
nRelations
)
;
}
HRESULT
AccessibleHandler
:
:
role
(
long
*
role
)
{
if
(
!
role
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
role
(
role
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mIA2Role
*
role
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
scrollTo
(
IA2ScrollType
scrollType
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
scrollTo
(
scrollType
)
;
}
HRESULT
AccessibleHandler
:
:
scrollToPoint
(
IA2CoordinateType
coordinateType
long
x
long
y
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
scrollToPoint
(
coordinateType
x
y
)
;
}
HRESULT
AccessibleHandler
:
:
get_groupPosition
(
long
*
groupLevel
long
*
similarItemsInGroup
long
*
positionInGroup
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_groupPosition
(
groupLevel
similarItemsInGroup
positionInGroup
)
;
}
HRESULT
AccessibleHandler
:
:
get_states
(
AccessibleStates
*
states
)
{
if
(
!
states
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_states
(
states
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mIA2States
*
states
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_extendedRole
(
BSTR
*
extendedRole
)
{
if
(
!
extendedRole
)
{
return
E_INVALIDARG
;
}
*
extendedRole
=
nullptr
;
return
E_NOTIMPL
;
}
HRESULT
AccessibleHandler
:
:
get_localizedExtendedRole
(
BSTR
*
localizedExtendedRole
)
{
if
(
!
localizedExtendedRole
)
{
return
E_INVALIDARG
;
}
*
localizedExtendedRole
=
nullptr
;
return
E_NOTIMPL
;
}
HRESULT
AccessibleHandler
:
:
get_nExtendedStates
(
long
*
nExtendedStates
)
{
if
(
!
nExtendedStates
)
{
return
E_INVALIDARG
;
}
*
nExtendedStates
=
0
;
return
E_NOTIMPL
;
}
HRESULT
AccessibleHandler
:
:
get_extendedStates
(
long
maxExtendedStates
BSTR
*
*
extendedStates
long
*
nExtendedStates
)
{
if
(
!
extendedStates
|
|
!
nExtendedStates
)
{
return
E_INVALIDARG
;
}
*
extendedStates
=
nullptr
;
*
nExtendedStates
=
0
;
return
E_NOTIMPL
;
}
HRESULT
AccessibleHandler
:
:
get_localizedExtendedStates
(
long
maxLocalizedExtendedStates
BSTR
*
*
localizedExtendedStates
long
*
nLocalizedExtendedStates
)
{
if
(
!
localizedExtendedStates
|
|
!
nLocalizedExtendedStates
)
{
return
E_INVALIDARG
;
}
*
localizedExtendedStates
=
nullptr
;
*
nLocalizedExtendedStates
=
0
;
return
E_NOTIMPL
;
}
HRESULT
AccessibleHandler
:
:
get_uniqueID
(
long
*
uniqueID
)
{
if
(
!
uniqueID
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_uniqueID
(
uniqueID
)
;
}
*
uniqueID
=
mCachedData
.
mDynamicData
.
mUniqueId
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_windowHandle
(
HWND
*
windowHandle
)
{
if
(
!
windowHandle
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_windowHandle
(
windowHandle
)
;
}
BEGIN_CACHE_ACCESS
;
long
hwnd
=
0
;
GET_FIELD
(
mHwnd
hwnd
)
;
*
windowHandle
=
reinterpret_cast
<
HWND
>
(
uintptr_t
(
hwnd
)
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_indexInParent
(
long
*
indexInParent
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_indexInParent
(
indexInParent
)
;
}
HRESULT
AccessibleHandler
:
:
get_locale
(
IA2Locale
*
locale
)
{
if
(
!
locale
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_locale
(
locale
)
;
}
BEGIN_CACHE_ACCESS
;
GET_BSTR
(
mIA2Locale
.
language
locale
-
>
language
)
;
GET_BSTR
(
mIA2Locale
.
country
locale
-
>
country
)
;
GET_BSTR
(
mIA2Locale
.
variant
locale
-
>
variant
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_attributes
(
BSTR
*
attributes
)
{
if
(
!
attributes
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_attributes
(
attributes
)
;
}
BEGIN_CACHE_ACCESS
;
GET_BSTR
(
mAttributes
*
attributes
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_attribute
(
BSTR
name
VARIANT
*
attribute
)
{
return
E_NOTIMPL
;
}
HRESULT
AccessibleHandler
:
:
get_accessibleWithCaret
(
IUnknown
*
*
accessible
long
*
caretOffset
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_accessibleWithCaret
(
accessible
caretOffset
)
;
}
HRESULT
AccessibleHandler
:
:
get_relationTargetsOfType
(
BSTR
type
long
maxTargets
IUnknown
*
*
*
targets
long
*
nTargets
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_relationTargetsOfType
(
type
maxTargets
targets
nTargets
)
;
}
HRESULT
AccessibleHandler
:
:
get_selectionRanges
(
IA2Range
*
*
ranges
long
*
nRanges
)
{
HRESULT
hr
=
ResolveIA2
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIA2PassThru
-
>
get_selectionRanges
(
ranges
nRanges
)
;
}
static
const
GUID
kUnsupportedServices
[
]
=
{
{
0x33f139ee
0xe509
0x47f7
{
0xbf
0x39
0x83
0x76
0x44
0xf7
0x45
0x76
}
}
{
0xFDA075CF
0x7C8B
0x498C
{
0xB5
0x14
0xA9
0xCB
0x52
0x1B
0xBF
0xB4
}
}
{
0x8EDAA462
0x21F4
0x4C87
{
0xA0
0x12
0xB3
0xCD
0xA3
0xAB
0x01
0xFC
}
}
{
0xacd46652
0x829d
0x41cb
{
0xa5
0xfc
0x17
0xac
0xf4
0x36
0x61
0xac
}
}
{
0xb96fdb85
0x7204
0x4724
{
0x84
0x2b
0xc7
0x05
0x9d
0xed
0xb9
0xd0
}
}
{
0x902697FA
0x80E4
0x4560
{
0x80
0x2A
0xA1
0x3F
0x22
0xA6
0x47
0x09
}
}
{
0x3050F1FF
0x98B5
0x11CF
{
0xBB
0x82
0x00
0xAA
0x00
0xBD
0xCE
0x0B
}
}
}
;
HRESULT
AccessibleHandler
:
:
QueryService
(
REFGUID
aServiceId
REFIID
aIid
void
*
*
aOutInterface
)
{
static_assert
(
&
NEWEST_IA2_IID
=
=
&
IID_IAccessible2_3
"
You
have
modified
NEWEST_IA2_IID
.
This
code
needs
updating
.
"
)
;
if
(
aIid
=
=
IID_IAccessible2_3
|
|
aIid
=
=
IID_IAccessible2_2
|
|
aIid
=
=
IID_IAccessible2
)
{
RefPtr
<
NEWEST_IA2_INTERFACE
>
ia2
(
this
)
;
ia2
.
forget
(
aOutInterface
)
;
return
S_OK
;
}
if
(
aIid
=
=
IID_IAccessibleAction
|
|
aIid
=
=
IID_IAccessibleText
)
{
return
InternalQueryInterface
(
aIid
aOutInterface
)
;
}
for
(
uint32_t
i
=
0
;
i
<
ArrayLength
(
kUnsupportedServices
)
;
+
+
i
)
{
if
(
aServiceId
=
=
kUnsupportedServices
[
i
]
)
{
return
E_NOINTERFACE
;
}
}
if
(
!
mServProvPassThru
)
{
RefPtr
<
IUnknown
>
proxy
(
GetProxy
(
)
)
;
if
(
!
proxy
)
{
return
E_UNEXPECTED
;
}
HRESULT
hr
=
proxy
-
>
QueryInterface
(
IID_IServiceProvider
reinterpret_cast
<
void
*
*
>
(
&
mServProvPassThru
)
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
mServProvPassThru
-
>
Release
(
)
;
}
return
mServProvPassThru
-
>
QueryService
(
aServiceId
aIid
aOutInterface
)
;
}
HRESULT
AccessibleHandler
:
:
GetClassInfo
(
ITypeInfo
*
*
aOutTypeInfo
)
{
RefPtr
<
AccessibleHandlerControl
>
ctl
(
gControlFactory
.
GetOrCreateSingleton
(
)
)
;
if
(
!
ctl
)
{
return
E_OUTOFMEMORY
;
}
return
ctl
-
>
GetHandlerTypeInfo
(
aOutTypeInfo
)
;
}
HRESULT
AccessibleHandler
:
:
nActions
(
long
*
nActions
)
{
if
(
!
nActions
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
nActions
(
nActions
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mNActions
*
nActions
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
doAction
(
long
actionIndex
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
doAction
(
actionIndex
)
;
}
HRESULT
AccessibleHandler
:
:
get_description
(
long
actionIndex
BSTR
*
description
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_description
(
actionIndex
description
)
;
}
HRESULT
AccessibleHandler
:
:
get_keyBinding
(
long
actionIndex
long
nMaxBindings
BSTR
*
*
keyBindings
long
*
nBindings
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_keyBinding
(
actionIndex
nMaxBindings
keyBindings
nBindings
)
;
}
HRESULT
AccessibleHandler
:
:
get_name
(
long
actionIndex
BSTR
*
name
)
{
if
(
!
name
)
{
return
E_INVALIDARG
;
}
if
(
HasPayload
(
)
)
{
if
(
actionIndex
>
=
mCachedData
.
mDynamicData
.
mNActions
)
{
return
E_INVALIDARG
;
}
if
(
actionIndex
=
=
0
)
{
GET_BSTR
(
mDefaultAction
*
name
)
;
return
S_OK
;
}
}
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_name
(
actionIndex
name
)
;
}
HRESULT
AccessibleHandler
:
:
get_localizedName
(
long
actionIndex
BSTR
*
localizedName
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_localizedName
(
actionIndex
localizedName
)
;
}
HRESULT
AccessibleHandler
:
:
get_anchor
(
long
index
VARIANT
*
anchor
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_anchor
(
index
anchor
)
;
}
HRESULT
AccessibleHandler
:
:
get_anchorTarget
(
long
index
VARIANT
*
anchorTarget
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_anchorTarget
(
index
anchorTarget
)
;
}
HRESULT
AccessibleHandler
:
:
get_startIndex
(
long
*
index
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_startIndex
(
index
)
;
}
HRESULT
AccessibleHandler
:
:
get_endIndex
(
long
*
index
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_endIndex
(
index
)
;
}
HRESULT
AccessibleHandler
:
:
get_valid
(
boolean
*
valid
)
{
HRESULT
hr
=
ResolveIAHyperlink
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHyperlinkPassThru
-
>
get_valid
(
valid
)
;
}
HRESULT
AccessibleHandler
:
:
get_columnExtent
(
long
*
nColumnsSpanned
)
{
if
(
!
nColumnsSpanned
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_columnExtent
(
nColumnsSpanned
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mColumnExtent
*
nColumnsSpanned
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_columnHeaderCells
(
IUnknown
*
*
*
cellAccessibles
long
*
nColumnHeaderCells
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_columnHeaderCells
(
cellAccessibles
nColumnHeaderCells
)
;
}
HRESULT
AccessibleHandler
:
:
get_columnIndex
(
long
*
columnIndex
)
{
if
(
!
columnIndex
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_columnIndex
(
columnIndex
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mColumnIndex
*
columnIndex
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_rowExtent
(
long
*
nRowsSpanned
)
{
if
(
!
nRowsSpanned
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_rowExtent
(
nRowsSpanned
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mRowExtent
*
nRowsSpanned
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_rowHeaderCells
(
IUnknown
*
*
*
cellAccessibles
long
*
nRowHeaderCells
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_rowHeaderCells
(
cellAccessibles
nRowHeaderCells
)
;
}
HRESULT
AccessibleHandler
:
:
get_rowIndex
(
long
*
rowIndex
)
{
if
(
!
rowIndex
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_rowIndex
(
rowIndex
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mRowIndex
*
rowIndex
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_isSelected
(
boolean
*
isSelected
)
{
if
(
!
isSelected
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_isSelected
(
isSelected
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mCellIsSelected
*
isSelected
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_rowColumnExtents
(
long
*
row
long
*
column
long
*
rowExtents
long
*
columnExtents
boolean
*
isSelected
)
{
if
(
!
row
|
|
!
column
|
|
!
rowExtents
|
|
!
columnExtents
|
|
!
isSelected
)
{
return
E_INVALIDARG
;
}
if
(
!
HasPayload
(
)
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_rowColumnExtents
(
row
column
rowExtents
columnExtents
isSelected
)
;
}
BEGIN_CACHE_ACCESS
;
GET_FIELD
(
mRowIndex
*
row
)
;
GET_FIELD
(
mColumnIndex
*
column
)
;
GET_FIELD
(
mRowExtent
*
rowExtents
)
;
GET_FIELD
(
mColumnExtent
*
columnExtents
)
;
GET_FIELD
(
mCellIsSelected
*
isSelected
)
;
return
S_OK
;
}
HRESULT
AccessibleHandler
:
:
get_table
(
IUnknown
*
*
table
)
{
HRESULT
hr
=
ResolveIATableCell
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIATableCellPassThru
-
>
get_table
(
table
)
;
}
HRESULT
AccessibleHandler
:
:
addSelection
(
long
startOffset
long
endOffset
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
addSelection
(
startOffset
endOffset
)
;
}
HRESULT
AccessibleHandler
:
:
get_attributes
(
long
offset
long
*
startOffset
long
*
endOffset
BSTR
*
textAttributes
)
{
if
(
!
startOffset
|
|
!
endOffset
|
|
!
textAttributes
)
{
return
E_INVALIDARG
;
}
if
(
mCachedNTextAttribRuns
>
=
0
)
{
for
(
long
index
=
0
;
index
<
mCachedNTextAttribRuns
;
+
+
index
)
{
auto
&
attribRun
=
mCachedTextAttribRuns
[
index
]
;
if
(
attribRun
.
start
<
=
offset
&
&
offset
<
attribRun
.
end
)
{
*
startOffset
=
attribRun
.
start
;
*
endOffset
=
attribRun
.
end
;
*
textAttributes
=
attribRun
.
text
;
attribRun
.
text
=
nullptr
;
attribRun
.
end
=
0
;
return
S_OK
;
}
}
}
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_attributes
(
offset
startOffset
endOffset
textAttributes
)
;
}
HRESULT
AccessibleHandler
:
:
get_caretOffset
(
long
*
offset
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_caretOffset
(
offset
)
;
}
HRESULT
AccessibleHandler
:
:
get_characterExtents
(
long
offset
enum
IA2CoordinateType
coordType
long
*
x
long
*
y
long
*
width
long
*
height
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_characterExtents
(
offset
coordType
x
y
width
height
)
;
}
HRESULT
AccessibleHandler
:
:
get_nSelections
(
long
*
nSelections
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_nSelections
(
nSelections
)
;
}
HRESULT
AccessibleHandler
:
:
get_offsetAtPoint
(
long
x
long
y
enum
IA2CoordinateType
coordType
long
*
offset
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_offsetAtPoint
(
x
y
coordType
offset
)
;
}
HRESULT
AccessibleHandler
:
:
get_selection
(
long
selectionIndex
long
*
startOffset
long
*
endOffset
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_selection
(
selectionIndex
startOffset
endOffset
)
;
}
HRESULT
AccessibleHandler
:
:
get_text
(
long
startOffset
long
endOffset
BSTR
*
text
)
{
if
(
!
text
)
{
return
E_INVALIDARG
;
}
HRESULT
hr
;
if
(
mCachedData
.
mGeckoBackChannel
&
&
startOffset
=
=
0
&
&
endOffset
=
=
IA2_TEXT_OFFSET_LENGTH
)
{
hr
=
GetAllTextInfo
(
text
)
;
if
(
SUCCEEDED
(
hr
)
)
{
return
hr
;
}
}
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_text
(
startOffset
endOffset
text
)
;
}
HRESULT
AccessibleHandler
:
:
get_textBeforeOffset
(
long
offset
enum
IA2TextBoundaryType
boundaryType
long
*
startOffset
long
*
endOffset
BSTR
*
text
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_textBeforeOffset
(
offset
boundaryType
startOffset
endOffset
text
)
;
}
HRESULT
AccessibleHandler
:
:
get_textAfterOffset
(
long
offset
enum
IA2TextBoundaryType
boundaryType
long
*
startOffset
long
*
endOffset
BSTR
*
text
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_textAfterOffset
(
offset
boundaryType
startOffset
endOffset
text
)
;
}
HRESULT
AccessibleHandler
:
:
get_textAtOffset
(
long
offset
enum
IA2TextBoundaryType
boundaryType
long
*
startOffset
long
*
endOffset
BSTR
*
text
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_textAtOffset
(
offset
boundaryType
startOffset
endOffset
text
)
;
}
HRESULT
AccessibleHandler
:
:
removeSelection
(
long
selectionIndex
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
removeSelection
(
selectionIndex
)
;
}
HRESULT
AccessibleHandler
:
:
setCaretOffset
(
long
offset
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
setCaretOffset
(
offset
)
;
}
HRESULT
AccessibleHandler
:
:
setSelection
(
long
selectionIndex
long
startOffset
long
endOffset
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
setSelection
(
selectionIndex
startOffset
endOffset
)
;
}
HRESULT
AccessibleHandler
:
:
get_nCharacters
(
long
*
nCharacters
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_nCharacters
(
nCharacters
)
;
}
HRESULT
AccessibleHandler
:
:
scrollSubstringTo
(
long
startIndex
long
endIndex
enum
IA2ScrollType
scrollType
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
scrollSubstringTo
(
startIndex
endIndex
scrollType
)
;
}
HRESULT
AccessibleHandler
:
:
scrollSubstringToPoint
(
long
startIndex
long
endIndex
enum
IA2CoordinateType
coordinateType
long
x
long
y
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
scrollSubstringToPoint
(
startIndex
endIndex
coordinateType
x
y
)
;
}
HRESULT
AccessibleHandler
:
:
get_newText
(
IA2TextSegment
*
newText
)
{
if
(
!
newText
)
{
return
E_INVALIDARG
;
}
RefPtr
<
AccessibleHandlerControl
>
ctl
(
gControlFactory
.
GetSingleton
(
)
)
;
MOZ_ASSERT
(
ctl
)
;
if
(
!
ctl
)
{
return
S_OK
;
}
long
id
;
HRESULT
hr
=
this
-
>
get_uniqueID
(
&
id
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
ctl
-
>
GetNewText
(
id
WrapNotNull
(
newText
)
)
;
}
HRESULT
AccessibleHandler
:
:
get_oldText
(
IA2TextSegment
*
oldText
)
{
if
(
!
oldText
)
{
return
E_INVALIDARG
;
}
RefPtr
<
AccessibleHandlerControl
>
ctl
(
gControlFactory
.
GetSingleton
(
)
)
;
MOZ_ASSERT
(
ctl
)
;
if
(
!
ctl
)
{
return
S_OK
;
}
long
id
;
HRESULT
hr
=
this
-
>
get_uniqueID
(
&
id
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
ctl
-
>
GetOldText
(
id
WrapNotNull
(
oldText
)
)
;
}
HRESULT
AccessibleHandler
:
:
get_nHyperlinks
(
long
*
hyperlinkCount
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_nHyperlinks
(
hyperlinkCount
)
;
}
HRESULT
AccessibleHandler
:
:
get_hyperlink
(
long
index
IAccessibleHyperlink
*
*
hyperlink
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_hyperlink
(
index
hyperlink
)
;
}
HRESULT
AccessibleHandler
:
:
get_hyperlinkIndex
(
long
charIndex
long
*
hyperlinkIndex
)
{
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_hyperlinkIndex
(
charIndex
hyperlinkIndex
)
;
}
HRESULT
AccessibleHandler
:
:
get_hyperlinks
(
IAccessibleHyperlink
*
*
*
hyperlinks
long
*
nHyperlinks
)
{
if
(
!
hyperlinks
|
|
!
nHyperlinks
)
{
return
E_INVALIDARG
;
}
if
(
mCachedNHyperlinks
>
=
0
)
{
*
hyperlinks
=
mCachedHyperlinks
;
*
nHyperlinks
=
mCachedNHyperlinks
;
mCachedHyperlinks
=
nullptr
;
mCachedNHyperlinks
=
-
1
;
return
mCachedNHyperlinks
=
=
0
?
S_FALSE
:
S_OK
;
}
HRESULT
hr
=
ResolveIAHypertext
(
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
mIAHypertextPassThru
-
>
get_hyperlinks
(
hyperlinks
nHyperlinks
)
;
}
}
}
extern
"
C
"
HRESULT
__stdcall
ProxyDllCanUnloadNow
(
)
;
extern
"
C
"
HRESULT
__stdcall
DllCanUnloadNow
(
)
{
return
mozilla
:
:
mscom
:
:
Module
:
:
CanUnload
(
)
&
&
ProxyDllCanUnloadNow
(
)
;
}
extern
"
C
"
HRESULT
__stdcall
ProxyDllGetClassObject
(
REFCLSID
aClsid
REFIID
aIid
LPVOID
*
aOutInterface
)
;
extern
"
C
"
HRESULT
__stdcall
DllGetClassObject
(
REFCLSID
aClsid
REFIID
aIid
LPVOID
*
aOutInterface
)
{
if
(
aClsid
=
=
CLSID_AccessibleHandler
)
{
return
mozilla
:
:
a11y
:
:
sHandlerFactory
.
QueryInterface
(
aIid
aOutInterface
)
;
}
return
ProxyDllGetClassObject
(
aClsid
aIid
aOutInterface
)
;
}
extern
"
C
"
BOOL
WINAPI
ProxyDllMain
(
HINSTANCE
aInstDll
DWORD
aReason
LPVOID
aReserved
)
;
BOOL
WINAPI
DllMain
(
HINSTANCE
aInstDll
DWORD
aReason
LPVOID
aReserved
)
{
if
(
aReason
=
=
DLL_PROCESS_ATTACH
)
{
DisableThreadLibraryCalls
(
(
HMODULE
)
aInstDll
)
;
}
return
ProxyDllMain
(
aInstDll
aReason
aReserved
)
;
}
extern
"
C
"
HRESULT
__stdcall
ProxyDllRegisterServer
(
)
;
extern
"
C
"
HRESULT
__stdcall
DllRegisterServer
(
)
{
HRESULT
hr
=
mozilla
:
:
mscom
:
:
Handler
:
:
Register
(
CLSID_AccessibleHandler
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
ProxyDllRegisterServer
(
)
;
}
extern
"
C
"
HRESULT
__stdcall
ProxyDllUnregisterServer
(
)
;
extern
"
C
"
HRESULT
__stdcall
DllUnregisterServer
(
)
{
HRESULT
hr
=
mozilla
:
:
mscom
:
:
Handler
:
:
Unregister
(
CLSID_AccessibleHandler
)
;
if
(
FAILED
(
hr
)
)
{
return
hr
;
}
return
ProxyDllUnregisterServer
(
)
;
}
