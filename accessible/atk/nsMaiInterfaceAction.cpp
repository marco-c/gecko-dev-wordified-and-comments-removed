#
include
"
InterfaceInitFuncs
.
h
"
#
include
"
LocalAccessible
-
inl
.
h
"
#
include
"
nsMai
.
h
"
#
include
"
mozilla
/
Likely
.
h
"
#
include
"
nsAccessibilityService
.
h
"
#
include
"
Relation
.
h
"
#
include
"
RemoteAccessible
.
h
"
#
include
"
nsString
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
a11y
;
extern
"
C
"
{
static
gboolean
doActionCB
(
AtkAction
*
aAction
gint
aActionIndex
)
{
AtkObject
*
atkObject
=
ATK_OBJECT
(
aAction
)
;
Accessible
*
acc
=
GetInternalObj
(
atkObject
)
;
if
(
!
acc
)
{
return
false
;
}
if
(
aActionIndex
<
acc
-
>
ActionCount
(
)
)
{
acc
-
>
DoAction
(
aActionIndex
)
;
return
true
;
}
Relation
customActions
(
acc
-
>
RelationByType
(
RelationType
:
:
ACTION
)
)
;
gint
actionIndex
=
acc
-
>
ActionCount
(
)
;
while
(
Accessible
*
target
=
customActions
.
Next
(
)
)
{
if
(
target
-
>
HasPrimaryAction
(
)
)
{
MOZ_ASSERT
(
target
-
>
ActionCount
(
)
>
0
)
;
if
(
actionIndex
=
=
aActionIndex
)
{
target
-
>
DoAction
(
0
)
;
return
true
;
}
actionIndex
+
+
;
}
}
return
false
;
}
static
gint
getActionCountCB
(
AtkAction
*
aAction
)
{
AtkObject
*
atkObject
=
ATK_OBJECT
(
aAction
)
;
Accessible
*
acc
=
GetInternalObj
(
atkObject
)
;
if
(
!
acc
)
{
return
0
;
}
gint
actionCount
=
acc
-
>
ActionCount
(
)
;
Relation
customActions
(
acc
-
>
RelationByType
(
RelationType
:
:
ACTION
)
)
;
while
(
Accessible
*
target
=
customActions
.
Next
(
)
)
{
if
(
target
-
>
HasPrimaryAction
(
)
)
{
actionCount
+
+
;
}
}
return
actionCount
;
}
static
const
gchar
*
getActionDescriptionCB
(
AtkAction
*
aAction
gint
aActionIndex
)
{
AtkObject
*
atkObject
=
ATK_OBJECT
(
aAction
)
;
nsAutoString
description
;
Accessible
*
acc
=
GetInternalObj
(
atkObject
)
;
if
(
!
acc
)
{
return
0
;
}
if
(
aActionIndex
<
acc
-
>
ActionCount
(
)
)
{
acc
-
>
ActionDescriptionAt
(
aActionIndex
description
)
;
}
else
{
Relation
customActions
(
acc
-
>
RelationByType
(
RelationType
:
:
ACTION
)
)
;
gint
actionIndex
=
acc
-
>
ActionCount
(
)
;
while
(
Accessible
*
target
=
customActions
.
Next
(
)
)
{
if
(
target
-
>
HasPrimaryAction
(
)
)
{
MOZ_ASSERT
(
target
-
>
ActionCount
(
)
>
0
)
;
if
(
actionIndex
=
=
aActionIndex
)
{
target
-
>
ActionDescriptionAt
(
0
description
)
;
break
;
}
actionIndex
+
+
;
}
}
}
if
(
!
description
.
IsEmpty
(
)
)
{
return
AccessibleWrap
:
:
ReturnString
(
description
)
;
}
return
nullptr
;
}
static
const
gchar
*
getActionNameCB
(
AtkAction
*
aAction
gint
aActionIndex
)
{
AtkObject
*
atkObject
=
ATK_OBJECT
(
aAction
)
;
nsAutoString
name
;
Accessible
*
acc
=
GetInternalObj
(
atkObject
)
;
if
(
!
acc
)
{
return
0
;
}
if
(
aActionIndex
<
acc
-
>
ActionCount
(
)
)
{
acc
-
>
ActionNameAt
(
aActionIndex
name
)
;
}
else
{
Relation
customActions
(
acc
-
>
RelationByType
(
RelationType
:
:
ACTION
)
)
;
gint
actionIndex
=
acc
-
>
ActionCount
(
)
;
while
(
Accessible
*
target
=
customActions
.
Next
(
)
)
{
if
(
target
-
>
HasPrimaryAction
(
)
)
{
MOZ_ASSERT
(
target
-
>
ActionCount
(
)
>
0
)
;
if
(
actionIndex
=
=
aActionIndex
)
{
name
.
AssignLiteral
(
"
custom
"
)
;
nsAutoString
domNodeId
;
target
-
>
DOMNodeID
(
domNodeId
)
;
if
(
!
domNodeId
.
IsEmpty
(
)
)
{
name
.
AppendPrintf
(
"
_
%
s
"
NS_ConvertUTF16toUTF8
(
domNodeId
)
.
get
(
)
)
;
}
break
;
}
actionIndex
+
+
;
}
}
}
if
(
!
name
.
IsEmpty
(
)
)
{
return
AccessibleWrap
:
:
ReturnString
(
name
)
;
}
return
nullptr
;
}
static
const
gchar
*
getActionLocalizedNameCB
(
AtkAction
*
aAction
gint
aActionIndex
)
{
AtkObject
*
atkObject
=
ATK_OBJECT
(
aAction
)
;
nsAutoString
name
;
Accessible
*
acc
=
GetInternalObj
(
atkObject
)
;
if
(
!
acc
)
{
return
0
;
}
if
(
aActionIndex
>
=
acc
-
>
ActionCount
(
)
)
{
Relation
customActions
(
acc
-
>
RelationByType
(
RelationType
:
:
ACTION
)
)
;
gint
actionIndex
=
acc
-
>
ActionCount
(
)
;
while
(
Accessible
*
target
=
customActions
.
Next
(
)
)
{
if
(
target
-
>
HasPrimaryAction
(
)
)
{
MOZ_ASSERT
(
target
-
>
ActionCount
(
)
>
0
)
;
if
(
actionIndex
=
=
aActionIndex
)
{
target
-
>
Name
(
name
)
;
break
;
}
actionIndex
+
+
;
}
}
}
if
(
!
name
.
IsEmpty
(
)
)
{
return
AccessibleWrap
:
:
ReturnString
(
name
)
;
}
return
nullptr
;
}
static
const
gchar
*
getKeyBindingCB
(
AtkAction
*
aAction
gint
aActionIndex
)
{
Accessible
*
acc
=
GetInternalObj
(
ATK_OBJECT
(
aAction
)
)
;
if
(
!
acc
)
{
return
nullptr
;
}
nsAutoString
keyBindingsStr
;
AccessibleWrap
:
:
GetKeyBinding
(
acc
keyBindingsStr
)
;
return
AccessibleWrap
:
:
ReturnString
(
keyBindingsStr
)
;
}
}
void
actionInterfaceInitCB
(
AtkActionIface
*
aIface
)
{
NS_ASSERTION
(
aIface
"
Invalid
aIface
"
)
;
if
(
MOZ_UNLIKELY
(
!
aIface
)
)
return
;
aIface
-
>
do_action
=
doActionCB
;
aIface
-
>
get_n_actions
=
getActionCountCB
;
aIface
-
>
get_description
=
getActionDescriptionCB
;
aIface
-
>
get_keybinding
=
getKeyBindingCB
;
aIface
-
>
get_name
=
getActionNameCB
;
aIface
-
>
get_localized_name
=
getActionLocalizedNameCB
;
}
