#
include
<
glib
.
h
>
#
include
<
cstdint
>
#
include
"
mozilla
/
a11y
/
HyperTextAccessibleBase
.
h
"
#
include
"
nsCharTraits
.
h
"
#
include
"
nsString
.
h
"
namespace
mozilla
{
namespace
a11y
{
namespace
DOMtoATK
{
gchar
*
Convert
(
const
nsAString
&
aStr
)
;
void
AddBOMs
(
nsACString
&
aDest
const
nsACString
&
aSource
)
;
class
ATKStringConverterHelper
{
public
:
ATKStringConverterHelper
(
void
)
:
#
ifdef
DEBUG
mAdjusted
(
false
)
#
endif
mStartShifted
(
false
)
mEndShifted
(
false
)
{
}
void
AdjustOffsets
(
gint
*
aStartOffset
gint
*
aEndOffset
gint
count
)
;
gchar
*
ConvertAdjusted
(
const
nsAString
&
aStr
)
;
private
:
gchar
*
FinishUTF16toUTF8
(
nsCString
&
aStr
)
;
#
ifdef
DEBUG
bool
mAdjusted
;
#
endif
bool
mStartShifted
;
bool
mEndShifted
;
}
;
inline
gchar
*
NewATKString
(
HyperTextAccessibleBase
*
aAccessible
gint
aStartOffset
gint
aEndOffset
)
{
gint
startOffset
=
aStartOffset
endOffset
=
aEndOffset
;
ATKStringConverterHelper
converter
;
converter
.
AdjustOffsets
(
&
startOffset
&
endOffset
gint
(
aAccessible
-
>
CharacterCount
(
)
)
)
;
nsAutoString
str
;
aAccessible
-
>
TextSubstring
(
startOffset
endOffset
str
)
;
if
(
str
.
Length
(
)
=
=
0
)
{
return
g_strdup
(
"
"
)
;
}
return
converter
.
ConvertAdjusted
(
str
)
;
}
inline
gunichar
ATKCharacter
(
HyperTextAccessibleBase
*
aAccessible
gint
aOffset
)
{
gunichar
character
=
static_cast
<
gunichar
>
(
aAccessible
-
>
CharAt
(
aOffset
)
)
;
if
(
NS_IS_LOW_SURROGATE
(
character
)
)
{
return
0xFEFF
;
}
if
(
NS_IS_HIGH_SURROGATE
(
character
)
)
{
gunichar
characterLow
=
static_cast
<
gunichar
>
(
aAccessible
-
>
CharAt
(
aOffset
+
1
)
)
;
if
(
!
NS_IS_LOW_SURROGATE
(
characterLow
)
)
{
return
0xFFFD
;
}
return
SURROGATE_TO_UCS4
(
character
characterLow
)
;
}
return
character
;
}
}
}
}
