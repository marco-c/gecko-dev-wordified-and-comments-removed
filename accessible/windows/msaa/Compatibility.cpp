#
include
"
Compatibility
.
h
"
#
include
"
nsWindowsDllInterceptor
.
h
"
#
include
"
nsWinUtils
.
h
"
#
include
"
Statistics
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
a11y
;
bool
IsModuleVersionLessThan
(
HMODULE
aModuleHandle
DWORD
aMajor
DWORD
aMinor
)
{
wchar_t
fileName
[
MAX_PATH
]
;
:
:
GetModuleFileNameW
(
aModuleHandle
fileName
MAX_PATH
)
;
DWORD
dummy
=
0
;
DWORD
length
=
:
:
GetFileVersionInfoSizeW
(
fileName
&
dummy
)
;
LPBYTE
versionInfo
=
new
BYTE
[
length
]
;
:
:
GetFileVersionInfoW
(
fileName
0
length
versionInfo
)
;
UINT
uLen
;
VS_FIXEDFILEINFO
*
fixedFileInfo
=
nullptr
;
:
:
VerQueryValueW
(
versionInfo
L
"
\
\
"
(
LPVOID
*
)
&
fixedFileInfo
&
uLen
)
;
DWORD
dwFileVersionMS
=
fixedFileInfo
-
>
dwFileVersionMS
;
DWORD
dwFileVersionLS
=
fixedFileInfo
-
>
dwFileVersionLS
;
delete
[
]
versionInfo
;
DWORD
dwLeftMost
=
HIWORD
(
dwFileVersionMS
)
;
DWORD
dwSecondRight
=
HIWORD
(
dwFileVersionLS
)
;
return
(
dwLeftMost
<
aMajor
|
|
(
dwLeftMost
=
=
aMajor
&
&
dwSecondRight
<
aMinor
)
)
;
}
static
WindowsDllInterceptor
sUser32Interceptor
;
static
decltype
(
&
InSendMessageEx
)
sInSendMessageExStub
=
nullptr
;
static
bool
sInSendMessageExHackEnabled
=
false
;
static
PVOID
sVectoredExceptionHandler
=
nullptr
;
#
if
defined
(
_MSC_VER
)
#
include
<
intrin
.
h
>
#
pragma
intrinsic
(
_ReturnAddress
)
#
define
RETURN_ADDRESS
(
)
_ReturnAddress
(
)
#
elif
defined
(
__GNUC__
)
|
|
defined
(
__clang__
)
#
define
RETURN_ADDRESS
(
)
__builtin_extract_return_addr
(
__builtin_return_address
(
0
)
)
#
endif
static
inline
bool
IsCurrentThreadInBlockingMessageSend
(
const
DWORD
aStateBits
)
{
return
(
aStateBits
&
(
ISMEX_REPLIED
|
ISMEX_SEND
)
)
=
=
ISMEX_SEND
;
}
static
DWORD
WINAPI
InSendMessageExHook
(
LPVOID
lpReserved
)
{
MOZ_ASSERT
(
XRE_IsParentProcess
(
)
)
;
DWORD
result
=
sInSendMessageExStub
(
lpReserved
)
;
if
(
NS_IsMainThread
(
)
&
&
sInSendMessageExHackEnabled
&
&
IsCurrentThreadInBlockingMessageSend
(
result
)
)
{
static
HMODULE
comModule
=
LoadLibrary
(
L
"
combase
.
dll
"
)
;
MOZ_ASSERT
(
comModule
)
;
if
(
!
comModule
)
{
return
result
;
}
HMODULE
callingModule
;
if
(
GetModuleHandleEx
(
GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS
|
GET_MODULE_HANDLE_EX_FLAG_UNCHANGED_REFCOUNT
reinterpret_cast
<
LPCWSTR
>
(
RETURN_ADDRESS
(
)
)
&
callingModule
)
&
&
callingModule
=
=
comModule
)
{
result
=
ISMEX_NOTIFY
;
}
}
return
result
;
}
static
LONG
CALLBACK
DetectInSendMessageExCompat
(
PEXCEPTION_POINTERS
aExceptionInfo
)
{
DWORD
exceptionCode
=
aExceptionInfo
-
>
ExceptionRecord
-
>
ExceptionCode
;
if
(
exceptionCode
=
=
RPC_E_CANTCALLOUT_ININPUTSYNCCALL
&
&
NS_IsMainThread
(
)
)
{
sInSendMessageExHackEnabled
=
true
;
if
(
RemoveVectoredExceptionHandler
(
sVectoredExceptionHandler
)
)
{
sVectoredExceptionHandler
=
nullptr
;
}
}
return
EXCEPTION_CONTINUE_SEARCH
;
}
uint32_t
Compatibility
:
:
sConsumers
=
Compatibility
:
:
UNKNOWN
;
void
Compatibility
:
:
Init
(
)
{
HMODULE
jawsHandle
=
:
:
GetModuleHandleW
(
L
"
jhook
"
)
;
if
(
jawsHandle
)
sConsumers
|
=
(
IsModuleVersionLessThan
(
jawsHandle
8
2173
)
)
?
OLDJAWS
:
JAWS
;
if
(
:
:
GetModuleHandleW
(
L
"
gwm32inc
"
)
)
sConsumers
|
=
WE
;
if
(
:
:
GetModuleHandleW
(
L
"
dolwinhk
"
)
)
sConsumers
|
=
DOLPHIN
;
if
(
:
:
GetModuleHandleW
(
L
"
STSA32
"
)
)
sConsumers
|
=
SEROTEK
;
if
(
:
:
GetModuleHandleW
(
L
"
nvdaHelperRemote
"
)
)
sConsumers
|
=
NVDA
;
if
(
:
:
GetModuleHandleW
(
L
"
OsmHooks
"
)
)
sConsumers
|
=
COBRA
;
if
(
:
:
GetModuleHandleW
(
L
"
WebFinderRemote
"
)
)
sConsumers
|
=
ZOOMTEXT
;
if
(
:
:
GetModuleHandleW
(
L
"
Kazahook
"
)
)
sConsumers
|
=
KAZAGURU
;
if
(
:
:
GetModuleHandleW
(
L
"
TextExtractorImpl32
"
)
|
|
:
:
GetModuleHandleW
(
L
"
TextExtractorImpl64
"
)
)
sConsumers
|
=
YOUDAO
;
if
(
:
:
GetModuleHandleW
(
L
"
uiautomation
"
)
|
|
:
:
GetModuleHandleW
(
L
"
uiautomationcore
"
)
)
sConsumers
|
=
UIAUTOMATION
;
if
(
sConsumers
!
=
Compatibility
:
:
UNKNOWN
)
sConsumers
^
=
Compatibility
:
:
UNKNOWN
;
uint32_t
temp
=
sConsumers
;
for
(
int
i
=
0
;
temp
;
i
+
+
)
{
if
(
temp
&
0x1
)
statistics
:
:
A11yConsumers
(
i
)
;
temp
>
>
=
1
;
}
if
(
sConsumers
&
(
JAWS
|
OLDJAWS
|
WE
)
)
{
if
(
!
Preferences
:
:
HasUserValue
(
"
browser
.
ctrlTab
.
disallowForScreenReaders
"
)
)
Preferences
:
:
SetBool
(
"
browser
.
ctrlTab
.
disallowForScreenReaders
"
true
)
;
}
if
(
(
sConsumers
&
~
(
Compatibility
:
:
UNKNOWN
|
NVDA
)
)
&
&
BrowserTabsRemoteAutostart
(
)
)
{
sUser32Interceptor
.
Init
(
"
user32
.
dll
"
)
;
if
(
!
sInSendMessageExStub
)
{
sUser32Interceptor
.
AddHook
(
"
InSendMessageEx
"
reinterpret_cast
<
intptr_t
>
(
&
InSendMessageExHook
)
(
void
*
*
)
&
sInSendMessageExStub
)
;
}
if
(
!
sVectoredExceptionHandler
)
{
sVectoredExceptionHandler
=
AddVectoredExceptionHandler
(
TRUE
&
DetectInSendMessageExCompat
)
;
}
}
}
