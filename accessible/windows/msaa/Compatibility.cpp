#
include
"
Compatibility
.
h
"
#
include
"
mozilla
/
WindowsVersion
.
h
"
#
include
"
mozilla
/
WinHeaderOnlyUtils
.
h
"
#
include
"
mozilla
/
StaticPrefs_accessibility
.
h
"
#
include
"
nsExceptionHandler
.
h
"
#
include
"
nsIXULRuntime
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
nsUnicharUtils
.
h
"
#
include
"
nsWinUtils
.
h
"
#
include
"
Statistics
.
h
"
#
include
"
AccessibleWrap
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
<
shlobj
.
h
>
using
namespace
mozilla
;
using
namespace
mozilla
:
:
a11y
;
static
const
wchar_t
*
ConsumerStringMap
[
CONSUMERS_ENUM_LEN
+
1
]
=
{
L
"
NVDA
"
L
"
JAWS
"
L
"
OLDJAWS
"
L
"
WE
"
L
"
DOLPHIN
"
L
"
SEROTEK
"
L
"
COBRA
"
L
"
ZOOMTEXT
"
L
"
KAZAGURU
"
L
"
YOUDAO
"
L
"
UNKNOWN
"
L
"
UIAUTOMATION
"
L
"
VISPEROSHARED
"
L
"
\
0
"
}
;
bool
Compatibility
:
:
IsModuleVersionLessThan
(
HMODULE
aModuleHandle
unsigned
long
long
aVersion
)
{
LauncherResult
<
ModuleVersion
>
version
=
GetModuleVersion
(
aModuleHandle
)
;
if
(
version
.
isErr
(
)
)
{
return
true
;
}
return
version
.
unwrap
(
)
<
aVersion
;
}
uint32_t
Compatibility
:
:
sConsumers
=
Compatibility
:
:
UNKNOWN
;
void
Compatibility
:
:
InitConsumers
(
)
{
HMODULE
jawsHandle
=
:
:
GetModuleHandleW
(
L
"
jhook
"
)
;
if
(
jawsHandle
)
{
sConsumers
|
=
IsModuleVersionLessThan
(
jawsHandle
MAKE_FILE_VERSION
(
19
0
0
0
)
)
?
OLDJAWS
:
JAWS
;
}
if
(
:
:
GetModuleHandleW
(
L
"
gwm32inc
"
)
)
sConsumers
|
=
WE
;
if
(
:
:
GetModuleHandleW
(
L
"
dolwinhk
"
)
)
sConsumers
|
=
DOLPHIN
;
if
(
:
:
GetModuleHandleW
(
L
"
STSA32
"
)
)
sConsumers
|
=
SEROTEK
;
if
(
:
:
GetModuleHandleW
(
L
"
nvdaHelperRemote
"
)
)
sConsumers
|
=
NVDA
;
if
(
:
:
GetModuleHandleW
(
L
"
OsmHooks
"
)
|
|
:
:
GetModuleHandleW
(
L
"
OsmHks64
"
)
)
sConsumers
|
=
COBRA
;
if
(
:
:
GetModuleHandleW
(
L
"
WebFinderRemote
"
)
)
sConsumers
|
=
ZOOMTEXT
;
if
(
:
:
GetModuleHandleW
(
L
"
Kazahook
"
)
)
sConsumers
|
=
KAZAGURU
;
if
(
:
:
GetModuleHandleW
(
L
"
TextExtractorImpl32
"
)
|
|
:
:
GetModuleHandleW
(
L
"
TextExtractorImpl64
"
)
)
sConsumers
|
=
YOUDAO
;
if
(
:
:
GetModuleHandleW
(
L
"
uiautomation
"
)
|
|
:
:
GetModuleHandleW
(
L
"
uiautomationcore
"
)
)
sConsumers
|
=
UIAUTOMATION
;
if
(
:
:
GetModuleHandleW
(
L
"
AccEventCache
"
)
)
{
sConsumers
|
=
VISPEROSHARED
;
}
if
(
sConsumers
!
=
Compatibility
:
:
UNKNOWN
)
sConsumers
&
=
~
Compatibility
:
:
UNKNOWN
;
}
bool
Compatibility
:
:
HasKnownNonUiaConsumer
(
)
{
InitConsumers
(
)
;
return
sConsumers
&
~
(
Compatibility
:
:
UNKNOWN
|
UIAUTOMATION
)
;
}
void
Compatibility
:
:
Init
(
)
{
InitConsumers
(
)
;
CrashReporter
:
:
RecordAnnotationNSCString
(
CrashReporter
:
:
Annotation
:
:
AccessibilityInProcClient
nsPrintfCString
(
"
0x
%
X
"
sConsumers
)
)
;
uint32_t
temp
=
sConsumers
;
for
(
int
i
=
0
;
temp
;
i
+
+
)
{
if
(
temp
&
0x1
)
statistics
:
:
A11yConsumers
(
i
)
;
temp
>
>
=
1
;
}
if
(
sConsumers
&
(
JAWS
|
OLDJAWS
|
WE
)
)
{
if
(
!
Preferences
:
:
HasUserValue
(
"
browser
.
ctrlTab
.
disallowForScreenReaders
"
)
)
Preferences
:
:
SetBool
(
"
browser
.
ctrlTab
.
disallowForScreenReaders
"
true
)
;
}
}
void
Compatibility
:
:
GetHumanReadableConsumersStr
(
nsAString
&
aResult
)
{
bool
appened
=
false
;
uint32_t
index
=
0
;
for
(
uint32_t
consumers
=
sConsumers
;
consumers
;
consumers
=
consumers
>
>
1
)
{
if
(
consumers
&
0x1
)
{
if
(
appened
)
{
aResult
.
AppendLiteral
(
"
"
)
;
}
aResult
.
Append
(
ConsumerStringMap
[
index
]
)
;
appened
=
true
;
}
if
(
+
+
index
>
CONSUMERS_ENUM_LEN
)
{
break
;
}
}
}
struct
SuppressionTimer
{
constexpr
SuppressionTimer
(
)
=
default
;
void
Start
(
)
{
mStart
=
:
:
GetTickCount
(
)
;
}
bool
IsActive
(
DWORD
aTickCount
)
const
{
return
mStart
&
&
aTickCount
-
mStart
<
kSuppressTimeout
;
}
DWORD
mStart
=
0
;
static
constexpr
DWORD
kSuppressTimeout
=
1500
;
}
;
static
SuppressionTimer
sClipboardSuppressionTimer
;
static
SuppressionTimer
sSnapLayoutsSuppressionTimer
;
void
Compatibility
:
:
SuppressA11yForClipboardCopy
(
)
{
bool
doSuppress
=
[
&
]
{
switch
(
StaticPrefs
:
:
accessibility_windows_suppress_after_clipboard_copy
(
)
)
{
case
0
:
return
false
;
case
1
:
return
true
;
default
:
return
IsWin1122H2OrLater
(
)
;
}
}
(
)
;
if
(
doSuppress
)
{
sClipboardSuppressionTimer
.
Start
(
)
;
}
}
void
Compatibility
:
:
SuppressA11yForSnapLayouts
(
)
{
bool
doSuppress
=
[
&
]
{
switch
(
StaticPrefs
:
:
accessibility_windows_suppress_for_snap_layout
(
)
)
{
case
0
:
return
false
;
case
1
:
return
true
;
default
:
return
IsWin1122H2OrLater
(
)
;
}
}
(
)
;
if
(
doSuppress
)
{
sSnapLayoutsSuppressionTimer
.
Start
(
)
;
}
}
SuppressionReasons
Compatibility
:
:
A11ySuppressionReasons
(
)
{
const
auto
now
=
:
:
GetTickCount
(
)
;
auto
reasons
=
SuppressionReasons
:
:
None
;
if
(
sClipboardSuppressionTimer
.
IsActive
(
now
)
)
{
reasons
|
=
SuppressionReasons
:
:
Clipboard
;
}
if
(
sSnapLayoutsSuppressionTimer
.
IsActive
(
now
)
)
{
reasons
|
=
SuppressionReasons
:
:
SnapLayouts
;
}
return
reasons
;
}
bool
Compatibility
:
:
IsUiaEnabled
(
)
{
const
uint32_t
pref
=
StaticPrefs
:
:
accessibility_uia_enable_DoNotUseDirectly
(
)
;
if
(
pref
=
=
0
)
{
return
false
;
}
if
(
pref
=
=
1
)
{
return
true
;
}
return
!
IsJAWS
(
)
&
&
!
IsOldJAWS
(
)
&
&
!
IsVisperoShared
(
)
&
&
!
(
sConsumers
&
NVDA
)
;
}
