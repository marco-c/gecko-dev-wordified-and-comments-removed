"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
ContentProcessSession
"
]
;
const
{
Domains
}
=
ChromeUtils
.
import
(
"
chrome
:
/
/
remote
/
content
/
domains
/
Domains
.
jsm
"
)
;
const
{
ContentProcessDomains
}
=
ChromeUtils
.
import
(
"
chrome
:
/
/
remote
/
content
/
domains
/
ContentProcessDomains
.
jsm
"
)
;
class
ContentProcessSession
{
constructor
(
messageManager
browsingContext
content
docShell
)
{
this
.
messageManager
=
messageManager
;
this
.
browsingContext
=
browsingContext
;
this
.
content
=
content
;
this
.
docShell
=
docShell
;
this
.
domains
=
new
Domains
(
this
ContentProcessDomains
)
;
this
.
messageManager
.
addMessageListener
(
"
remote
:
request
"
this
)
;
this
.
messageManager
.
addMessageListener
(
"
remote
:
destroy
"
this
)
;
this
.
destroy
=
this
.
destroy
.
bind
(
this
)
;
this
.
content
.
addEventListener
(
"
unload
"
this
.
destroy
)
;
}
destroy
(
)
{
this
.
content
.
addEventListener
(
"
unload
"
this
.
destroy
)
;
this
.
messageManager
.
removeMessageListener
(
"
remote
:
request
"
this
)
;
this
.
messageManager
.
removeMessageListener
(
"
remote
:
destroy
"
this
)
;
}
onEvent
(
eventName
params
)
{
this
.
messageManager
.
sendAsyncMessage
(
"
remote
:
event
"
{
browsingContextId
:
this
.
browsingContext
.
id
event
:
{
method
:
eventName
params
}
}
)
;
}
async
receiveMessage
(
{
name
data
}
)
{
const
{
browsingContextId
}
=
data
;
if
(
browsingContextId
!
=
this
.
browsingContext
.
id
)
{
return
;
}
switch
(
name
)
{
case
"
remote
:
request
"
:
try
{
const
{
id
domain
method
params
}
=
data
.
request
;
const
inst
=
this
.
domains
.
get
(
domain
)
;
const
methodFn
=
inst
[
method
]
;
if
(
!
methodFn
|
|
typeof
methodFn
!
=
"
function
"
)
{
throw
new
Error
(
Method
implementation
of
{
method
}
missing
)
;
}
const
result
=
await
methodFn
.
call
(
inst
params
)
;
this
.
messageManager
.
sendAsyncMessage
(
"
remote
:
result
"
{
browsingContextId
id
result
}
)
;
}
catch
(
e
)
{
this
.
messageManager
.
sendAsyncMessage
(
"
remote
:
error
"
{
browsingContextId
id
:
data
.
request
.
id
error
:
{
name
:
e
.
name
|
|
"
exception
"
message
:
e
.
message
|
|
String
(
e
)
stack
:
e
.
stack
}
}
)
;
}
break
;
case
"
remote
:
destroy
"
:
this
.
destroy
(
)
;
break
;
}
}
}
