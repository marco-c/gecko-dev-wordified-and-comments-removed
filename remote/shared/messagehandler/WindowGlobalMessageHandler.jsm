"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
WindowGlobalMessageHandler
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
ContextDescriptorType
:
"
chrome
:
/
/
remote
/
content
/
shared
/
messagehandler
/
MessageHandler
.
jsm
"
MessageHandler
:
"
chrome
:
/
/
remote
/
content
/
shared
/
messagehandler
/
MessageHandler
.
jsm
"
}
)
;
class
WindowGlobalMessageHandler
extends
MessageHandler
{
constructor
(
)
{
super
(
.
.
.
arguments
)
;
this
.
_innerWindowId
=
this
.
_context
.
window
.
windowGlobalChild
.
innerWindowId
;
}
static
get
modulePath
(
)
{
return
"
windowglobal
"
;
}
static
get
type
(
)
{
return
"
WINDOW_GLOBAL
"
;
}
static
getIdFromContext
(
context
)
{
return
context
.
id
;
}
get
innerWindowId
(
)
{
return
this
.
_innerWindowId
;
}
get
window
(
)
{
return
this
.
_context
.
window
;
}
async
applyInitialSessionDataItems
(
sessionDataItems
)
{
if
(
!
Array
.
isArray
(
sessionDataItems
)
)
{
return
;
}
const
destination
=
{
type
:
WindowGlobalMessageHandler
.
type
}
;
const
sessionDataPromises
=
sessionDataItems
.
map
(
sessionDataItem
=
>
{
const
{
moduleName
category
contextDescriptor
value
}
=
sessionDataItem
;
if
(
!
this
.
_matchesContext
(
contextDescriptor
)
)
{
return
Promise
.
resolve
(
)
;
}
if
(
!
this
.
_moduleCache
.
hasModule
(
moduleName
destination
)
)
{
return
Promise
.
resolve
(
)
;
}
return
this
.
handleCommand
(
{
moduleName
commandName
:
"
_applySessionData
"
params
:
{
category
added
:
[
value
]
}
destination
}
)
;
}
)
;
await
Promise
.
all
(
sessionDataPromises
)
;
this
.
emitEvent
(
"
window
-
global
-
handler
-
created
"
{
contextId
:
this
.
_contextId
innerWindowId
:
this
.
_innerWindowId
}
)
;
}
forwardCommand
(
command
)
{
throw
new
Error
(
Cannot
forward
commands
from
a
"
WINDOW_GLOBAL
"
MessageHandler
)
;
}
_matchesContext
(
contextDescriptor
)
{
return
(
contextDescriptor
.
type
=
=
=
ContextDescriptorType
.
All
|
|
(
contextDescriptor
.
type
=
=
=
ContextDescriptorType
.
TopBrowsingContext
&
&
contextDescriptor
.
id
=
=
=
this
.
_context
.
browserId
)
)
;
}
}
