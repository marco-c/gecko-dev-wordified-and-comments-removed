"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
EventsDispatcher
"
]
;
class
EventsDispatcher
{
#
messageHandler
;
#
eventListeners
;
constructor
(
messageHandler
)
{
this
.
#
messageHandler
=
messageHandler
;
this
.
#
eventListeners
=
new
Map
(
)
;
}
destroy
(
)
{
this
.
#
eventListeners
.
clear
(
)
;
}
async
off
(
event
contextDescriptor
callback
)
{
const
listeners
=
this
.
#
eventListeners
.
get
(
event
)
;
if
(
!
listeners
)
{
return
;
}
const
key
=
this
.
#
getContextKey
(
contextDescriptor
)
;
const
callbacks
=
listeners
.
get
(
key
)
;
if
(
!
callbacks
)
{
return
;
}
if
(
callbacks
.
has
(
callback
)
)
{
callbacks
.
delete
(
callback
)
;
if
(
callbacks
.
size
=
=
=
0
)
{
await
this
.
#
messageHandler
.
removeSessionData
(
this
.
#
getSessionDataItem
(
event
contextDescriptor
)
)
;
listeners
.
delete
(
key
)
;
}
}
this
.
#
messageHandler
.
off
(
event
callback
)
;
}
async
on
(
event
contextDescriptor
callback
)
{
if
(
!
this
.
#
eventListeners
.
has
(
event
)
)
{
this
.
#
eventListeners
.
set
(
event
new
Map
(
)
)
;
}
const
key
=
this
.
#
getContextKey
(
contextDescriptor
)
;
const
listeners
=
this
.
#
eventListeners
.
get
(
event
)
;
if
(
listeners
.
has
(
key
)
)
{
const
callbacks
=
listeners
.
get
(
key
)
;
callbacks
.
add
(
callback
)
;
}
else
{
listeners
.
set
(
key
new
Set
(
[
callback
]
)
)
;
await
this
.
#
messageHandler
.
addSessionData
(
this
.
#
getSessionDataItem
(
event
contextDescriptor
)
)
;
}
this
.
#
messageHandler
.
on
(
event
callback
)
;
}
#
getContextKey
(
contextDescriptor
)
{
const
{
id
type
}
=
contextDescriptor
;
return
{
type
}
-
{
id
}
;
}
#
getSessionDataItem
(
event
contextDescriptor
)
{
const
[
moduleName
]
=
event
.
split
(
"
.
"
)
;
return
{
moduleName
category
:
"
internal
-
event
"
contextDescriptor
values
:
[
event
]
}
;
}
}
