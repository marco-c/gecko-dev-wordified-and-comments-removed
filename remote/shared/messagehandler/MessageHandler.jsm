"
use
strict
"
;
const
EXPORTED_SYMBOLS
=
[
"
MessageHandler
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
EventEmitter
:
"
resource
:
/
/
gre
/
modules
/
EventEmitter
.
jsm
"
Log
:
"
chrome
:
/
/
remote
/
content
/
shared
/
Log
.
jsm
"
MessageHandlerInfo
:
"
chrome
:
/
/
remote
/
content
/
shared
/
messagehandler
/
MessageHandlerInfo
.
jsm
"
ModuleCache
:
"
chrome
:
/
/
remote
/
content
/
shared
/
messagehandler
/
ModuleCache
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
logger
"
(
)
=
>
Log
.
get
(
)
)
;
class
MessageHandler
extends
EventEmitter
{
constructor
(
sessionId
context
)
{
super
(
)
;
this
.
_messageHandlerInfo
=
new
MessageHandlerInfo
(
sessionId
this
.
constructor
.
type
this
.
constructor
.
getIdFromContext
(
context
)
)
;
this
.
_moduleCache
=
new
ModuleCache
(
this
)
;
}
get
contextId
(
)
{
return
this
.
_messageHandlerInfo
.
contextId
;
}
get
key
(
)
{
return
this
.
_messageHandlerInfo
.
key
;
}
get
sessionId
(
)
{
return
this
.
_messageHandlerInfo
.
sessionId
;
}
destroy
(
)
{
logger
.
trace
(
MessageHandler
{
this
.
type
}
for
session
{
this
.
sessionId
}
is
being
destroyed
)
;
this
.
_moduleCache
.
destroy
(
)
;
this
.
emit
(
"
message
-
handler
-
destroyed
"
this
)
;
}
handleCommand
(
command
)
{
const
{
moduleName
commandName
destination
params
}
=
command
;
logger
.
trace
(
Received
command
{
moduleName
}
:
{
commandName
}
for
destination
{
destination
.
type
}
)
;
const
mod
=
this
.
_moduleCache
.
getModuleInstance
(
moduleName
destination
)
;
if
(
this
.
_isCommandSupportedByModule
(
commandName
mod
)
)
{
return
mod
[
commandName
]
(
params
destination
)
;
}
return
this
.
forwardCommand
(
command
)
;
}
toString
(
)
{
return
[
object
{
this
.
constructor
.
name
}
{
this
.
key
}
]
;
}
_isCommandSupportedByModule
(
commandName
mod
)
{
return
mod
&
&
typeof
mod
[
commandName
]
=
=
=
"
function
"
;
}
static
get
modulePath
(
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
static
get
type
(
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
static
getIdFromContext
(
context
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
forwardCommand
(
command
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
}
