"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
WebSocketConnection
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
importESModule
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
sys
.
mjs
"
)
;
const
lazy
=
{
}
;
XPCOMUtils
.
defineLazyModuleGetters
(
lazy
{
Log
:
"
chrome
:
/
/
remote
/
content
/
shared
/
Log
.
jsm
"
truncate
:
"
chrome
:
/
/
remote
/
content
/
shared
/
Format
.
jsm
"
WebSocketTransport
:
"
chrome
:
/
/
remote
/
content
/
server
/
WebSocketTransport
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyGetter
(
lazy
"
logger
"
(
)
=
>
lazy
.
Log
.
get
(
)
)
;
class
WebSocketConnection
{
constructor
(
webSocket
httpdConnection
)
{
this
.
id
=
Services
.
uuid
.
generateUUID
(
)
.
toString
(
)
.
slice
(
1
-
1
)
;
this
.
httpdConnection
=
httpdConnection
;
this
.
transport
=
new
lazy
.
WebSocketTransport
(
webSocket
)
;
this
.
transport
.
hooks
=
this
;
this
.
transport
.
ready
(
)
;
lazy
.
logger
.
debug
(
{
this
.
constructor
.
name
}
{
this
.
id
}
accepted
)
;
}
_log
(
direction
data
)
{
function
replacer
(
key
value
)
{
if
(
typeof
value
=
=
=
"
string
"
)
{
return
lazy
.
truncate
{
value
}
;
}
return
value
;
}
const
payload
=
JSON
.
stringify
(
data
replacer
lazy
.
Log
.
verbose
?
"
\
t
"
:
null
)
;
lazy
.
logger
.
trace
(
{
this
.
constructor
.
name
}
{
this
.
id
}
{
direction
}
{
payload
}
)
;
}
close
(
)
{
this
.
transport
.
close
(
)
;
this
.
httpdConnection
.
close
(
)
;
}
registerSession
(
session
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
send
(
data
)
{
this
.
_log
(
"
<
-
"
data
)
;
this
.
transport
.
send
(
data
)
;
}
sendError
(
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
sendEvent
(
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
sendResult
(
)
{
throw
new
Error
(
"
Not
implemented
"
)
;
}
toString
(
)
{
return
[
object
{
this
.
constructor
.
name
}
{
this
.
id
}
]
;
}
onClosed
(
status
)
{
lazy
.
logger
.
debug
(
{
this
.
constructor
.
name
}
{
this
.
id
}
closed
)
;
}
async
onPacket
(
packet
)
{
this
.
_log
(
"
-
>
"
packet
)
;
}
}
