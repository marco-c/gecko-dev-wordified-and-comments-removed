"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
TabObserver
"
]
;
const
{
Services
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
)
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
EventEmitter
:
"
resource
:
/
/
gre
/
modules
/
EventEmitter
.
jsm
"
EventPromise
:
"
chrome
:
/
/
remote
/
content
/
shared
/
Sync
.
jsm
"
}
)
;
class
TabObserver
{
constructor
(
{
registerExisting
=
false
}
=
{
}
)
{
EventEmitter
.
decorate
(
this
)
;
this
.
registerExisting
=
registerExisting
;
this
.
onTabOpen
=
this
.
onTabOpen
.
bind
(
this
)
;
this
.
onTabClose
=
this
.
onTabClose
.
bind
(
this
)
;
}
async
start
(
)
{
Services
.
wm
.
addListener
(
this
)
;
if
(
this
.
registerExisting
)
{
for
(
const
win
of
Services
.
wm
.
getEnumerator
(
"
navigator
:
browser
"
)
)
{
this
.
_registerDOMWindow
(
win
)
;
}
}
}
stop
(
)
{
Services
.
wm
.
removeListener
(
this
)
;
for
(
const
win
of
Services
.
wm
.
getEnumerator
(
"
navigator
:
browser
"
)
)
{
this
.
_unregisterDOMWindow
(
win
)
;
}
}
onTabOpen
(
{
target
}
)
{
this
.
emit
(
"
open
"
target
)
;
}
onTabClose
(
{
target
}
)
{
this
.
emit
(
"
close
"
target
)
;
}
_registerDOMWindow
(
win
)
{
for
(
const
tab
of
win
.
gBrowser
.
tabs
)
{
if
(
!
tab
.
linkedBrowser
)
{
continue
;
}
this
.
onTabOpen
(
{
target
:
tab
}
)
;
}
win
.
gBrowser
.
tabContainer
.
addEventListener
(
"
TabOpen
"
this
.
onTabOpen
)
;
win
.
gBrowser
.
tabContainer
.
addEventListener
(
"
TabClose
"
this
.
onTabClose
)
;
}
_unregisterDOMWindow
(
win
)
{
for
(
const
tab
of
win
.
gBrowser
.
tabs
)
{
if
(
!
tab
.
linkedBrowser
)
{
continue
;
}
this
.
onTabClose
(
{
target
:
tab
}
)
;
}
win
.
gBrowser
.
tabContainer
.
removeEventListener
(
"
TabOpen
"
this
.
onTabOpen
)
;
win
.
gBrowser
.
tabContainer
.
removeEventListener
(
"
TabClose
"
this
.
onTabClose
)
;
}
async
onOpenWindow
(
xulWindow
)
{
const
win
=
xulWindow
.
docShell
.
domWindow
;
await
new
EventPromise
(
win
"
load
"
)
;
if
(
win
.
document
.
documentElement
.
getAttribute
(
"
windowtype
"
)
!
=
"
navigator
:
browser
"
)
{
return
;
}
this
.
_registerDOMWindow
(
win
)
;
}
onCloseWindow
(
xulWindow
)
{
const
win
=
xulWindow
.
docShell
.
domWindow
;
if
(
win
.
document
.
documentElement
.
getAttribute
(
"
windowtype
"
)
!
=
"
navigator
:
browser
"
)
{
return
;
}
this
.
_unregisterDOMWindow
(
win
)
;
}
get
QueryInterface
(
)
{
return
ChromeUtils
.
generateQI
(
[
"
nsIWindowMediatorListener
"
]
)
;
}
}
