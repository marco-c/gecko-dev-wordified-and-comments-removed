"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
CDP
"
]
;
const
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
JSONHandler
:
"
chrome
:
/
/
remote
/
content
/
cdp
/
JSONHandler
.
jsm
"
Log
:
"
chrome
:
/
/
remote
/
content
/
shared
/
Log
.
jsm
"
RecommendedPreferences
:
"
chrome
:
/
/
remote
/
content
/
shared
/
RecommendedPreferences
.
jsm
"
TargetList
:
"
chrome
:
/
/
remote
/
content
/
cdp
/
targets
/
TargetList
.
jsm
"
}
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
logger
"
(
)
=
>
Log
.
get
(
Log
.
TYPES
.
CDP
)
)
;
XPCOMUtils
.
defineLazyGetter
(
this
"
textEncoder
"
(
)
=
>
new
TextEncoder
(
)
)
;
const
RECOMMENDED_PREFS
=
new
Map
(
[
[
"
browser
.
contentblocking
.
features
.
standard
"
"
-
tp
tpPrivate
cookieBehavior0
-
cm
-
fp
"
]
[
"
network
.
cookie
.
cookieBehavior
"
0
]
]
)
;
class
CDP
{
constructor
(
agent
)
{
this
.
agent
=
agent
;
this
.
targetList
=
null
;
this
.
_running
=
false
;
this
.
_activePortPath
;
}
get
address
(
)
{
const
mainTarget
=
this
.
targetList
.
getMainProcessTarget
(
)
;
return
mainTarget
.
wsDebuggerURL
;
}
get
mainTargetPath
(
)
{
const
mainTarget
=
this
.
targetList
.
getMainProcessTarget
(
)
;
return
mainTarget
.
path
;
}
async
start
(
)
{
if
(
this
.
_running
)
{
return
;
}
this
.
_running
=
true
;
RecommendedPreferences
.
applyPreferences
(
RECOMMENDED_PREFS
)
;
this
.
agent
.
server
.
registerPrefixHandler
(
"
/
json
/
"
new
JSONHandler
(
this
)
)
;
this
.
targetList
=
new
TargetList
(
)
;
this
.
targetList
.
on
(
"
target
-
created
"
(
eventName
target
)
=
>
{
this
.
agent
.
server
.
registerPathHandler
(
target
.
path
target
)
;
}
)
;
this
.
targetList
.
on
(
"
target
-
destroyed
"
(
eventName
target
)
=
>
{
this
.
agent
.
server
.
registerPathHandler
(
target
.
path
null
)
;
}
)
;
await
this
.
targetList
.
watchForTargets
(
)
;
Cu
.
printStderr
(
DevTools
listening
on
{
this
.
address
}
\
n
)
;
this
.
_activePortPath
=
PathUtils
.
join
(
PathUtils
.
profileDir
"
DevToolsActivePort
"
)
;
const
data
=
{
this
.
agent
.
port
}
\
n
{
this
.
mainTargetPath
}
;
try
{
await
IOUtils
.
write
(
this
.
_activePortPath
textEncoder
.
encode
(
data
)
)
;
}
catch
(
e
)
{
logger
.
warn
(
Failed
to
create
{
this
.
_activePortPath
}
(
{
e
.
message
}
)
)
;
}
}
async
stop
(
)
{
if
(
!
this
.
_running
)
{
return
;
}
try
{
try
{
await
IOUtils
.
remove
(
this
.
_activePortPath
)
;
}
catch
(
e
)
{
logger
.
warn
(
Failed
to
remove
{
this
.
_activePortPath
}
(
{
e
.
message
}
)
)
;
}
this
.
targetList
?
.
destructor
(
)
;
this
.
targetList
=
null
;
RecommendedPreferences
.
restorePreferences
(
RECOMMENDED_PREFS
)
;
}
finally
{
this
.
_running
=
false
;
}
}
}
