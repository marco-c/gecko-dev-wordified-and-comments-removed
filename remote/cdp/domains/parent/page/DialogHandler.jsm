"
use
strict
"
;
var
EXPORTED_SYMBOLS
=
[
"
DialogHandler
"
]
;
var
{
XPCOMUtils
}
=
ChromeUtils
.
import
(
"
resource
:
/
/
gre
/
modules
/
XPCOMUtils
.
jsm
"
)
;
XPCOMUtils
.
defineLazyModuleGetters
(
this
{
EventEmitter
:
"
resource
:
/
/
gre
/
modules
/
EventEmitter
.
jsm
"
Services
:
"
resource
:
/
/
gre
/
modules
/
Services
.
jsm
"
}
)
;
const
DIALOG_TYPES
=
{
ALERT
:
"
alert
"
BEFOREUNLOAD
:
"
beforeunload
"
CONFIRM
:
"
confirm
"
PROMPT
:
"
prompt
"
}
;
class
DialogHandler
{
constructor
(
browser
)
{
EventEmitter
.
decorate
(
this
)
;
this
.
_dialog
=
null
;
this
.
_browser
=
browser
;
this
.
_onTabDialogLoaded
=
this
.
_onTabDialogLoaded
.
bind
(
this
)
;
Services
.
obs
.
addObserver
(
this
.
_onTabDialogLoaded
"
tabmodal
-
dialog
-
loaded
"
)
;
}
destructor
(
)
{
this
.
_dialog
=
null
;
this
.
_pageTarget
=
null
;
Services
.
obs
.
removeObserver
(
this
.
_onTabDialogLoaded
"
tabmodal
-
dialog
-
loaded
"
)
;
}
async
handleJavaScriptDialog
(
{
accept
promptText
}
)
{
if
(
!
this
.
_dialog
)
{
throw
new
Error
(
"
No
dialog
available
for
handleJavaScriptDialog
"
)
;
}
const
type
=
this
.
_getDialogType
(
)
;
if
(
promptText
&
&
type
=
=
=
"
prompt
"
)
{
this
.
_dialog
.
ui
.
loginTextbox
.
value
=
promptText
;
}
const
onDialogClosed
=
new
Promise
(
r
=
>
{
this
.
_browser
.
addEventListener
(
"
DOMModalDialogClosed
"
r
{
once
:
true
}
)
;
}
)
;
if
(
accept
)
{
this
.
_dialog
.
onButtonClick
(
0
)
;
}
else
{
this
.
_dialog
.
onButtonClick
(
1
)
;
}
await
onDialogClosed
;
this
.
_dialog
=
null
;
}
_getDialogType
(
)
{
const
{
inPermitUnload
promptType
}
=
this
.
_dialog
.
args
;
if
(
inPermitUnload
)
{
return
DIALOG_TYPES
.
BEFOREUNLOAD
;
}
switch
(
promptType
)
{
case
"
alert
"
:
return
DIALOG_TYPES
.
ALERT
;
case
"
confirm
"
:
return
DIALOG_TYPES
.
CONFIRM
;
case
"
prompt
"
:
return
DIALOG_TYPES
.
PROMPT
;
default
:
throw
new
Error
(
"
Unsupported
dialog
type
:
"
+
promptType
)
;
}
}
_onTabDialogLoaded
(
promptContainer
)
{
const
prompts
=
this
.
_browser
.
tabModalPromptBox
.
listPrompts
(
)
;
const
prompt
=
prompts
.
find
(
p
=
>
p
.
ui
.
promptContainer
=
=
=
promptContainer
)
;
if
(
!
prompt
)
{
return
;
}
this
.
_dialog
=
prompt
;
const
message
=
this
.
_dialog
.
args
.
text
;
const
type
=
this
.
_getDialogType
(
)
;
this
.
emit
(
"
dialog
-
loaded
"
{
message
type
}
)
;
}
}
