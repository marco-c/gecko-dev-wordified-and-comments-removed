"
use
strict
"
;
add_task
(
async
function
(
)
{
const
CDP
=
await
getCDP
(
)
;
const
client
=
await
CDP
(
{
}
)
;
info
(
"
Setup
Target
domain
"
)
;
const
{
Target
}
=
client
;
const
targetsCreated
=
new
Promise
(
resolve
=
>
{
let
targets
=
0
;
const
unsubscribe
=
Target
.
targetCreated
(
event
=
>
{
if
(
+
+
targets
>
=
gBrowser
.
tabs
.
length
+
1
)
{
unsubscribe
(
)
;
resolve
(
)
;
}
}
)
;
}
)
;
Target
.
setDiscoverTargets
(
{
discover
:
true
}
)
;
await
targetsCreated
;
info
(
"
Create
a
new
tab
and
wait
for
the
target
to
be
created
"
)
;
const
otherTargetCreated
=
Target
.
targetCreated
(
)
;
const
tab
=
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
toDataURL
(
"
"
)
)
;
const
{
targetInfo
}
=
await
otherTargetCreated
;
is
(
targetInfo
.
type
"
page
"
)
;
const
onTabClose
=
BrowserTestUtils
.
waitForEvent
(
tab
"
TabClose
"
)
;
const
targetDestroyed
=
Target
.
targetDestroyed
(
)
;
info
(
"
Close
the
target
"
)
;
Target
.
closeTarget
(
{
targetId
:
targetInfo
.
targetId
}
)
;
await
onTabClose
;
ok
(
true
"
Tab
was
closed
"
)
;
await
targetDestroyed
;
ok
(
true
"
Received
the
expected
Target
.
targetDestroyed
event
"
)
;
await
client
.
close
(
)
;
ok
(
true
"
The
client
is
closed
"
)
;
}
)
;
