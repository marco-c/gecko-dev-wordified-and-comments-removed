"
use
strict
"
;
const
{
RemoteAgent
}
=
ChromeUtils
.
import
(
"
chrome
:
/
/
remote
/
content
/
RemoteAgent
.
jsm
"
)
;
const
{
RemoteAgentError
}
=
ChromeUtils
.
import
(
"
chrome
:
/
/
remote
/
content
/
Error
.
jsm
"
)
;
const
TEST_URI
=
"
data
:
text
/
html
;
charset
=
utf
-
8
default
-
test
-
page
"
;
add_task
(
async
function
(
)
{
try
{
await
testCDP
(
)
;
}
catch
(
e
)
{
if
(
e
.
response
)
{
throw
RemoteAgentError
.
fromJSON
(
e
.
response
)
;
}
else
{
throw
e
;
}
}
}
)
;
async
function
testCDP
(
)
{
await
BrowserTestUtils
.
openNewForegroundTab
(
gBrowser
TEST_URI
)
;
RemoteAgent
.
init
(
)
;
RemoteAgent
.
tabs
.
start
(
)
;
RemoteAgent
.
listen
(
Services
.
io
.
newURI
(
"
http
:
/
/
localhost
:
9222
"
)
)
;
const
CDP
=
await
getCDP
(
)
;
const
client
=
await
CDP
(
{
target
(
list
)
{
return
list
.
find
(
target
=
>
target
.
url
=
=
TEST_URI
)
;
}
}
)
;
ok
(
true
"
CDP
client
has
been
instantiated
"
)
;
const
{
Page
Runtime
}
=
client
;
await
Runtime
.
enable
(
)
;
ok
(
true
"
Runtime
domain
has
been
enabled
"
)
;
const
executionContextCreated
=
Runtime
.
executionContextCreated
(
)
;
const
url
=
"
data
:
text
/
html
;
charset
=
utf
-
8
test
-
page
"
;
const
{
frameId
}
=
await
Page
.
navigate
(
{
url
}
)
;
ok
(
true
"
A
new
page
has
been
loaded
"
)
;
ok
(
frameId
"
Page
.
navigate
returned
a
frameId
"
)
;
const
{
context
}
=
await
executionContextCreated
;
ok
(
!
!
context
.
id
"
The
execution
context
has
an
id
"
)
;
ok
(
context
.
auxData
.
isDefault
"
The
execution
context
is
the
default
one
"
)
;
is
(
context
.
auxData
.
frameId
frameId
"
The
execution
context
frame
id
is
the
same
"
+
"
the
one
returned
by
Page
.
navigate
"
)
;
await
client
.
close
(
)
;
ok
(
true
"
The
client
is
closed
"
)
;
BrowserTestUtils
.
removeTab
(
gBrowser
.
selectedTab
)
;
await
RemoteAgent
.
close
(
)
;
}
