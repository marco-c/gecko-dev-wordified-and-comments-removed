import
expect
from
'
expect
'
;
import
{
Connection
}
from
'
puppeteer
-
core
/
internal
/
common
/
bidi
/
Connection
.
js
'
;
import
{
ConnectionTransport
}
from
'
puppeteer
-
core
/
internal
/
common
/
ConnectionTransport
.
js
'
;
describe
(
'
WebDriver
BiDi
'
(
)
=
>
{
describe
(
'
Connection
'
(
)
=
>
{
class
TestConnectionTransport
implements
ConnectionTransport
{
sent
:
string
[
]
=
[
]
;
closed
=
false
;
send
(
message
:
string
)
{
this
.
sent
.
push
(
message
)
;
}
close
(
)
:
void
{
this
.
closed
=
true
;
}
}
it
(
'
should
work
'
async
(
)
=
>
{
const
transport
=
new
TestConnectionTransport
(
)
;
const
connection
=
new
Connection
(
transport
)
;
const
responsePromise
=
connection
.
send
(
'
session
.
new
'
{
capabilities
:
{
proxy
:
{
}
}
}
)
;
expect
(
transport
.
sent
)
.
toEqual
(
[
{
"
id
"
:
1
"
method
"
:
"
session
.
new
"
"
params
"
:
{
"
capabilities
"
:
{
"
proxy
"
:
{
}
}
}
}
]
)
;
const
id
=
JSON
.
parse
(
transport
.
sent
[
0
]
!
)
.
id
;
const
rawResponse
=
{
id
result
:
{
ready
:
false
message
:
'
already
connected
'
}
}
;
(
transport
as
ConnectionTransport
)
.
onmessage
?
.
(
JSON
.
stringify
(
rawResponse
)
)
;
const
response
=
await
responsePromise
;
expect
(
response
)
.
toEqual
(
rawResponse
)
;
connection
.
dispose
(
)
;
expect
(
transport
.
closed
)
.
toBeTruthy
(
)
;
}
)
;
}
)
;
}
)
;
