import
{
Protocol
}
from
'
devtools
-
protocol
'
;
import
{
Deferred
}
from
'
.
.
/
util
/
Deferred
.
js
'
;
import
{
CDPSession
}
from
'
.
/
Connection
.
js
'
;
import
{
ConsoleMessageType
}
from
'
.
/
ConsoleMessage
.
js
'
;
import
{
EventEmitter
}
from
'
.
/
EventEmitter
.
js
'
;
import
{
ExecutionContext
}
from
'
.
/
ExecutionContext
.
js
'
;
import
{
CDPJSHandle
}
from
'
.
/
JSHandle
.
js
'
;
import
{
EvaluateFunc
HandleFor
}
from
'
.
/
types
.
js
'
;
import
{
debugError
withSourcePuppeteerURLIfNone
}
from
'
.
/
util
.
js
'
;
export
type
ConsoleAPICalledCallback
=
(
eventType
:
ConsoleMessageType
handles
:
CDPJSHandle
[
]
trace
:
Protocol
.
Runtime
.
StackTrace
)
=
>
void
;
export
type
ExceptionThrownCallback
=
(
details
:
Protocol
.
Runtime
.
ExceptionDetails
)
=
>
void
;
export
class
WebWorker
extends
EventEmitter
{
#
executionContext
=
Deferred
.
create
<
ExecutionContext
>
(
)
;
#
client
:
CDPSession
;
#
url
:
string
;
constructor
(
client
:
CDPSession
url
:
string
consoleAPICalled
:
ConsoleAPICalledCallback
exceptionThrown
:
ExceptionThrownCallback
)
{
super
(
)
;
this
.
#
client
=
client
;
this
.
#
url
=
url
;
this
.
#
client
.
once
(
'
Runtime
.
executionContextCreated
'
async
event
=
>
{
const
context
=
new
ExecutionContext
(
client
event
.
context
)
;
this
.
#
executionContext
.
resolve
(
context
)
;
}
)
;
this
.
#
client
.
on
(
'
Runtime
.
consoleAPICalled
'
async
event
=
>
{
try
{
const
context
=
await
this
.
#
executionContext
.
valueOrThrow
(
)
;
return
consoleAPICalled
(
event
.
type
event
.
args
.
map
(
(
object
:
Protocol
.
Runtime
.
RemoteObject
)
=
>
{
return
new
CDPJSHandle
(
context
object
)
;
}
)
event
.
stackTrace
)
;
}
catch
(
err
)
{
debugError
(
err
)
;
}
}
)
;
this
.
#
client
.
on
(
'
Runtime
.
exceptionThrown
'
exception
=
>
{
return
exceptionThrown
(
exception
.
exceptionDetails
)
;
}
)
;
this
.
#
client
.
send
(
'
Runtime
.
enable
'
)
.
catch
(
debugError
)
;
}
async
executionContext
(
)
:
Promise
<
ExecutionContext
>
{
return
this
.
#
executionContext
.
valueOrThrow
(
)
;
}
url
(
)
:
string
{
return
this
.
#
url
;
}
get
client
(
)
:
CDPSession
{
return
this
.
#
client
;
}
async
evaluate
<
Params
extends
unknown
[
]
Func
extends
EvaluateFunc
<
Params
>
=
EvaluateFunc
<
Params
>
>
(
pageFunction
:
Func
|
string
.
.
.
args
:
Params
)
:
Promise
<
Awaited
<
ReturnType
<
Func
>
>
>
{
pageFunction
=
withSourcePuppeteerURLIfNone
(
this
.
evaluate
.
name
pageFunction
)
;
const
context
=
await
this
.
#
executionContext
.
valueOrThrow
(
)
;
return
context
.
evaluate
(
pageFunction
.
.
.
args
)
;
}
async
evaluateHandle
<
Params
extends
unknown
[
]
Func
extends
EvaluateFunc
<
Params
>
=
EvaluateFunc
<
Params
>
>
(
pageFunction
:
Func
|
string
.
.
.
args
:
Params
)
:
Promise
<
HandleFor
<
Awaited
<
ReturnType
<
Func
>
>
>
>
{
pageFunction
=
withSourcePuppeteerURLIfNone
(
this
.
evaluateHandle
.
name
pageFunction
)
;
const
context
=
await
this
.
#
executionContext
.
valueOrThrow
(
)
;
return
context
.
evaluateHandle
(
pageFunction
.
.
.
args
)
;
}
}
