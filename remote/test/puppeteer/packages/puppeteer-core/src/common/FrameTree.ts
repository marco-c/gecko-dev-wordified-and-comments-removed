import
{
Frame
as
BaseFrame
}
from
'
.
.
/
api
/
Frame
.
js
'
;
import
{
Deferred
}
from
'
.
.
/
util
/
Deferred
.
js
'
;
export
class
FrameTree
<
Frame
extends
BaseFrame
>
{
#
frames
=
new
Map
<
string
Frame
>
(
)
;
#
parentIds
=
new
Map
<
string
string
>
(
)
;
#
childIds
=
new
Map
<
string
Set
<
string
>
>
(
)
;
#
mainFrame
?
:
Frame
;
#
waitRequests
=
new
Map
<
string
Set
<
Deferred
<
Frame
>
>
>
(
)
;
getMainFrame
(
)
:
Frame
|
undefined
{
return
this
.
#
mainFrame
;
}
getById
(
frameId
:
string
)
:
Frame
|
undefined
{
return
this
.
#
frames
.
get
(
frameId
)
;
}
waitForFrame
(
frameId
:
string
)
:
Promise
<
Frame
>
{
const
frame
=
this
.
getById
(
frameId
)
;
if
(
frame
)
{
return
Promise
.
resolve
(
frame
)
;
}
const
deferred
=
Deferred
.
create
<
Frame
>
(
)
;
const
callbacks
=
this
.
#
waitRequests
.
get
(
frameId
)
|
|
new
Set
<
Deferred
<
Frame
>
>
(
)
;
callbacks
.
add
(
deferred
)
;
return
deferred
.
valueOrThrow
(
)
;
}
frames
(
)
:
Frame
[
]
{
return
Array
.
from
(
this
.
#
frames
.
values
(
)
)
;
}
addFrame
(
frame
:
Frame
)
:
void
{
this
.
#
frames
.
set
(
frame
.
_id
frame
)
;
if
(
frame
.
_parentId
)
{
this
.
#
parentIds
.
set
(
frame
.
_id
frame
.
_parentId
)
;
if
(
!
this
.
#
childIds
.
has
(
frame
.
_parentId
)
)
{
this
.
#
childIds
.
set
(
frame
.
_parentId
new
Set
(
)
)
;
}
this
.
#
childIds
.
get
(
frame
.
_parentId
)
!
.
add
(
frame
.
_id
)
;
}
else
if
(
!
this
.
#
mainFrame
)
{
this
.
#
mainFrame
=
frame
;
}
this
.
#
waitRequests
.
get
(
frame
.
_id
)
?
.
forEach
(
request
=
>
{
return
request
.
resolve
(
frame
)
;
}
)
;
}
removeFrame
(
frame
:
Frame
)
:
void
{
this
.
#
frames
.
delete
(
frame
.
_id
)
;
this
.
#
parentIds
.
delete
(
frame
.
_id
)
;
if
(
frame
.
_parentId
)
{
this
.
#
childIds
.
get
(
frame
.
_parentId
)
?
.
delete
(
frame
.
_id
)
;
}
else
{
this
.
#
mainFrame
=
undefined
;
}
}
childFrames
(
frameId
:
string
)
:
Frame
[
]
{
const
childIds
=
this
.
#
childIds
.
get
(
frameId
)
;
if
(
!
childIds
)
{
return
[
]
;
}
return
Array
.
from
(
childIds
)
.
map
(
id
=
>
{
return
this
.
getById
(
id
)
;
}
)
.
filter
(
(
frame
)
:
frame
is
Frame
=
>
{
return
frame
!
=
=
undefined
;
}
)
;
}
parentFrame
(
frameId
:
string
)
:
Frame
|
undefined
{
const
parentId
=
this
.
#
parentIds
.
get
(
frameId
)
;
return
parentId
?
this
.
getById
(
parentId
)
:
undefined
;
}
}
