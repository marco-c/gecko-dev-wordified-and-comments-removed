import
*
as
BidiMapper
from
'
chromium
-
bidi
/
lib
/
cjs
/
bidiMapper
/
bidiMapper
.
js
'
;
import
*
as
Bidi
from
'
chromium
-
bidi
/
lib
/
cjs
/
protocol
/
protocol
.
js
'
;
import
type
{
ProtocolMapping
}
from
'
devtools
-
protocol
/
types
/
protocol
-
mapping
.
js
'
;
import
{
CDPSession
Connection
as
CDPPPtrConnection
}
from
'
.
.
/
Connection
.
js
'
;
import
{
TargetCloseError
}
from
'
.
.
/
Errors
.
js
'
;
import
{
EventEmitter
Handler
}
from
'
.
.
/
EventEmitter
.
js
'
;
import
{
Connection
as
BidiPPtrConnection
}
from
'
.
/
Connection
.
js
'
;
type
CdpEvents
=
{
[
Property
in
keyof
ProtocolMapping
.
Events
]
:
ProtocolMapping
.
Events
[
Property
]
[
0
]
;
}
;
export
async
function
connectBidiOverCDP
(
cdp
:
CDPPPtrConnection
)
:
Promise
<
BidiPPtrConnection
>
{
const
transportBiDi
=
new
NoOpTransport
(
)
;
const
cdpConnectionAdapter
=
new
CDPConnectionAdapter
(
cdp
)
;
const
pptrTransport
=
{
send
(
message
:
string
)
:
void
{
transportBiDi
.
emitMessage
(
JSON
.
parse
(
message
)
)
;
}
close
(
)
:
void
{
bidiServer
.
close
(
)
;
cdpConnectionAdapter
.
close
(
)
;
}
onmessage
(
_message
:
string
)
:
void
{
}
}
;
transportBiDi
.
on
(
'
bidiResponse
'
(
message
:
object
)
=
>
{
pptrTransport
.
onmessage
(
JSON
.
stringify
(
message
)
)
;
}
)
;
const
pptrBiDiConnection
=
new
BidiPPtrConnection
(
cdp
.
url
(
)
pptrTransport
)
;
const
bidiServer
=
await
BidiMapper
.
BidiServer
.
createAndStart
(
transportBiDi
cdpConnectionAdapter
'
'
)
;
return
pptrBiDiConnection
;
}
class
CDPConnectionAdapter
{
#
cdp
:
CDPPPtrConnection
;
#
adapters
=
new
Map
<
CDPSession
CDPClientAdapter
<
CDPSession
>
>
(
)
;
#
browser
:
CDPClientAdapter
<
CDPPPtrConnection
>
;
constructor
(
cdp
:
CDPPPtrConnection
)
{
this
.
#
cdp
=
cdp
;
this
.
#
browser
=
new
CDPClientAdapter
(
cdp
)
;
}
browserClient
(
)
:
CDPClientAdapter
<
CDPPPtrConnection
>
{
return
this
.
#
browser
;
}
getCdpClient
(
id
:
string
)
{
const
session
=
this
.
#
cdp
.
session
(
id
)
;
if
(
!
session
)
{
throw
new
Error
(
'
Unknown
CDP
session
with
id
'
+
id
)
;
}
if
(
!
this
.
#
adapters
.
has
(
session
)
)
{
const
adapter
=
new
CDPClientAdapter
(
session
id
this
.
#
browser
)
;
this
.
#
adapters
.
set
(
session
adapter
)
;
return
adapter
;
}
return
this
.
#
adapters
.
get
(
session
)
!
;
}
close
(
)
{
this
.
#
browser
.
close
(
)
;
for
(
const
adapter
of
this
.
#
adapters
.
values
(
)
)
{
adapter
.
close
(
)
;
}
}
}
class
CDPClientAdapter
<
T
extends
EventEmitter
&
Pick
<
CDPPPtrConnection
'
send
'
>
>
extends
BidiMapper
.
EventEmitter
<
CdpEvents
>
implements
BidiMapper
.
CdpClient
{
#
closed
=
false
;
#
client
:
T
;
sessionId
:
string
|
undefined
=
undefined
;
#
browserClient
?
:
BidiMapper
.
CdpClient
;
constructor
(
client
:
T
sessionId
?
:
string
browserClient
?
:
BidiMapper
.
CdpClient
)
{
super
(
)
;
this
.
#
client
=
client
;
this
.
sessionId
=
sessionId
;
this
.
#
browserClient
=
browserClient
;
this
.
#
client
.
on
(
'
*
'
this
.
#
forwardMessage
as
Handler
<
any
>
)
;
}
browserClient
(
)
:
BidiMapper
.
CdpClient
{
return
this
.
#
browserClient
!
;
}
#
forwardMessage
=
<
T
extends
keyof
CdpEvents
>
(
method
:
T
event
:
CdpEvents
[
T
]
)
=
>
{
this
.
emit
(
method
event
)
;
}
;
async
sendCommand
<
T
extends
keyof
ProtocolMapping
.
Commands
>
(
method
:
T
.
.
.
params
:
ProtocolMapping
.
Commands
[
T
]
[
'
paramsType
'
]
)
:
Promise
<
ProtocolMapping
.
Commands
[
T
]
[
'
returnType
'
]
>
{
if
(
this
.
#
closed
)
{
return
;
}
try
{
return
await
this
.
#
client
.
send
(
method
.
.
.
params
)
;
}
catch
(
err
)
{
if
(
this
.
#
closed
)
{
return
;
}
throw
err
;
}
}
close
(
)
{
this
.
#
client
.
off
(
'
*
'
this
.
#
forwardMessage
as
Handler
<
any
>
)
;
this
.
#
closed
=
true
;
}
isCloseError
(
error
:
any
)
:
boolean
{
return
error
instanceof
TargetCloseError
;
}
}
class
NoOpTransport
extends
BidiMapper
.
EventEmitter
<
any
>
implements
BidiMapper
.
BidiTransport
{
#
onMessage
:
(
message
:
Bidi
.
ChromiumBidi
.
Command
)
=
>
Promise
<
void
>
|
void
=
async
(
_m
:
Bidi
.
ChromiumBidi
.
Command
)
:
Promise
<
void
>
=
>
{
return
;
}
;
emitMessage
(
message
:
Bidi
.
ChromiumBidi
.
Command
)
{
void
this
.
#
onMessage
(
message
)
;
}
setOnMessage
(
onMessage
:
(
message
:
Bidi
.
ChromiumBidi
.
Command
)
=
>
Promise
<
void
>
|
void
)
:
void
{
this
.
#
onMessage
=
onMessage
;
}
async
sendMessage
(
message
:
Bidi
.
ChromiumBidi
.
Message
)
:
Promise
<
void
>
{
this
.
emit
(
'
bidiResponse
'
message
)
;
}
close
(
)
{
this
.
#
onMessage
=
async
(
_m
:
Bidi
.
ChromiumBidi
.
Command
)
:
Promise
<
void
>
=
>
{
return
;
}
;
}
}
