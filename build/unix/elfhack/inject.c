#
include
<
stdint
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
sys
/
mman
.
h
>
#
include
<
elf
.
h
>
#
undef
Elf_Ehdr
#
undef
Elf_Addr
#
if
defined
(
__LP64__
)
#
define
Elf_Ehdr
Elf64_Ehdr
#
define
Elf_Addr
Elf64_Addr
#
else
#
define
Elf_Ehdr
Elf32_Ehdr
#
define
Elf_Addr
Elf32_Addr
#
endif
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
void
original_init
(
int
argc
char
*
*
argv
char
*
*
env
)
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
Elf32_Rel
relhack
[
]
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
Elf_Ehdr
elf_header
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
int
(
*
mprotect_cb
)
(
void
*
addr
size_t
len
int
prot
)
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
char
relro_start
[
]
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
char
relro_end
[
]
;
static
inline
__attribute__
(
(
always_inline
)
)
void
do_relocations
(
void
)
{
Elf32_Rel
*
rel
;
Elf_Addr
*
ptr
*
start
;
for
(
rel
=
relhack
;
rel
-
>
r_offset
;
rel
+
+
)
{
start
=
(
Elf_Addr
*
)
(
(
intptr_t
)
&
elf_header
+
rel
-
>
r_offset
)
;
for
(
ptr
=
start
;
ptr
<
&
start
[
rel
-
>
r_info
]
;
ptr
+
+
)
*
ptr
+
=
(
intptr_t
)
&
elf_header
;
}
}
__attribute__
(
(
section
(
"
.
text
.
_init_noinit
"
)
)
)
int
init_noinit
(
int
argc
char
*
*
argv
char
*
*
env
)
{
do_relocations
(
)
;
return
0
;
}
__attribute__
(
(
section
(
"
.
text
.
_init
"
)
)
)
int
init
(
int
argc
char
*
*
argv
char
*
*
env
)
{
do_relocations
(
)
;
original_init
(
argc
argv
env
)
;
return
0
;
}
static
inline
__attribute__
(
(
always_inline
)
)
void
relro_pre
(
)
{
mprotect_cb
(
relro_start
relro_end
-
relro_start
PROT_READ
|
PROT_WRITE
)
;
}
static
inline
__attribute__
(
(
always_inline
)
)
void
relro_post
(
)
{
mprotect_cb
(
relro_start
relro_end
-
relro_start
PROT_READ
)
;
mprotect_cb
=
NULL
;
}
__attribute__
(
(
section
(
"
.
text
.
_init_noinit_relro
"
)
)
)
int
init_noinit_relro
(
int
argc
char
*
*
argv
char
*
*
env
)
{
relro_pre
(
)
;
do_relocations
(
)
;
relro_post
(
)
;
return
0
;
}
__attribute__
(
(
section
(
"
.
text
.
_init_relro
"
)
)
)
int
init_relro
(
int
argc
char
*
*
argv
char
*
*
env
)
{
relro_pre
(
)
;
do_relocations
(
)
;
original_init
(
argc
argv
env
)
;
relro_post
(
)
;
return
0
;
}
