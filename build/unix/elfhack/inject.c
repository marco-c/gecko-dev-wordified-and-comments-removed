#
include
<
stdint
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
unistd
.
h
>
#
include
<
sys
/
mman
.
h
>
#
include
<
elf
.
h
>
#
undef
Elf_Ehdr
#
undef
Elf_Addr
#
if
defined
(
__LP64__
)
#
define
Elf_Ehdr
Elf64_Ehdr
#
define
Elf_Addr
Elf64_Addr
#
else
#
define
Elf_Ehdr
Elf32_Ehdr
#
define
Elf_Addr
Elf32_Addr
#
endif
#
ifdef
__arm__
__attribute__
(
(
section
(
"
.
text
.
_init_trampoline
"
)
naked
)
)
int
init_trampoline
(
int
argc
char
*
*
argv
char
*
*
env
)
{
__asm__
__volatile__
(
"
.
arm
\
n
"
"
ldr
ip
.
LADDR
\
n
"
"
.
LAFTER
:
\
n
"
"
add
ip
pc
ip
\
n
"
"
bx
ip
\
n
"
"
.
LADDR
:
\
n
"
"
.
word
real_original_init
-
(
.
LAFTER
+
8
)
\
n
"
)
;
}
#
endif
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
void
original_init
(
int
argc
char
*
*
argv
char
*
*
env
)
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
Elf32_Rel
relhack
[
]
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
Elf_Ehdr
elf_header
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
int
(
*
mprotect_cb
)
(
void
*
addr
size_t
len
int
prot
)
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
long
(
*
sysconf_cb
)
(
int
name
)
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
char
relro_start
[
]
;
extern
__attribute__
(
(
visibility
(
"
hidden
"
)
)
)
char
relro_end
[
]
;
static
inline
__attribute__
(
(
always_inline
)
)
void
do_relocations
(
void
)
{
Elf32_Rel
*
rel
;
Elf_Addr
*
ptr
*
start
;
for
(
rel
=
relhack
;
rel
-
>
r_offset
;
rel
+
+
)
{
start
=
(
Elf_Addr
*
)
(
(
intptr_t
)
&
elf_header
+
rel
-
>
r_offset
)
;
for
(
ptr
=
start
;
ptr
<
&
start
[
rel
-
>
r_info
]
;
ptr
+
+
)
*
ptr
+
=
(
intptr_t
)
&
elf_header
;
}
}
__attribute__
(
(
section
(
"
.
text
.
_init_noinit
"
)
)
)
int
init_noinit
(
int
argc
char
*
*
argv
char
*
*
env
)
{
do_relocations
(
)
;
return
0
;
}
__attribute__
(
(
section
(
"
.
text
.
_init
"
)
)
)
int
init
(
int
argc
char
*
*
argv
char
*
*
env
)
{
do_relocations
(
)
;
original_init
(
argc
argv
env
)
;
return
0
;
}
static
inline
__attribute__
(
(
always_inline
)
)
void
do_relocations_with_relro
(
void
)
{
long
page_size
=
sysconf_cb
(
_SC_PAGESIZE
)
;
uintptr_t
aligned_relro_start
=
(
(
uintptr_t
)
relro_start
)
&
~
(
page_size
-
1
)
;
uintptr_t
aligned_relro_end
=
(
(
uintptr_t
)
relro_end
)
&
~
(
page_size
-
1
)
;
mprotect_cb
(
(
void
*
)
aligned_relro_start
aligned_relro_end
-
aligned_relro_start
PROT_READ
|
PROT_WRITE
)
;
do_relocations
(
)
;
mprotect_cb
(
(
void
*
)
aligned_relro_start
aligned_relro_end
-
aligned_relro_start
PROT_READ
)
;
mprotect_cb
=
NULL
;
sysconf_cb
=
NULL
;
}
__attribute__
(
(
section
(
"
.
text
.
_init_noinit_relro
"
)
)
)
int
init_noinit_relro
(
int
argc
char
*
*
argv
char
*
*
env
)
{
do_relocations_with_relro
(
)
;
return
0
;
}
__attribute__
(
(
section
(
"
.
text
.
_init_relro
"
)
)
)
int
init_relro
(
int
argc
char
*
*
argv
char
*
*
env
)
{
do_relocations_with_relro
(
)
;
original_init
(
argc
argv
env
)
;
return
0
;
}
