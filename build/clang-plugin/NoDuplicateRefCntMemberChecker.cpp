#
include
"
NoDuplicateRefCntMemberChecker
.
h
"
#
include
"
CustomMatchers
.
h
"
void
NoDuplicateRefCntMemberChecker
:
:
registerMatcher
(
MatchFinder
&
AstMatcher
)
{
AstMatcher
.
addMatcher
(
cxxRecordDecl
(
)
.
bind
(
"
decl
"
)
this
)
;
}
void
NoDuplicateRefCntMemberChecker
:
:
run
(
const
MatchFinder
:
:
MatchResult
&
Result
)
{
DiagnosticsEngine
&
Diag
=
Result
.
Context
-
>
getDiagnostics
(
)
;
const
CXXRecordDecl
*
D
=
Result
.
Nodes
.
getNodeAs
<
CXXRecordDecl
>
(
"
decl
"
)
;
const
FieldDecl
*
RefCntMember
=
getClassRefCntMember
(
D
)
;
const
FieldDecl
*
FoundRefCntBase
=
nullptr
;
if
(
!
D
-
>
hasDefinition
(
)
)
return
;
D
=
D
-
>
getDefinition
(
)
;
if
(
!
RefCntMember
&
&
D
-
>
getNumBases
(
)
<
2
)
{
return
;
}
for
(
auto
&
Base
:
D
-
>
bases
(
)
)
{
const
FieldDecl
*
BaseRefCntMember
=
getBaseRefCntMember
(
Base
.
getType
(
)
)
;
if
(
BaseRefCntMember
)
{
if
(
RefCntMember
)
{
unsigned
Error
=
Diag
.
getDiagnosticIDs
(
)
-
>
getCustomDiagID
(
DiagnosticIDs
:
:
Error
"
Refcounted
record
%
0
has
multiple
mRefCnt
members
"
)
;
unsigned
Note1
=
Diag
.
getDiagnosticIDs
(
)
-
>
getCustomDiagID
(
DiagnosticIDs
:
:
Note
"
Superclass
%
0
also
has
an
mRefCnt
member
"
)
;
unsigned
Note2
=
Diag
.
getDiagnosticIDs
(
)
-
>
getCustomDiagID
(
DiagnosticIDs
:
:
Note
"
Consider
using
the
_INHERITED
macros
for
AddRef
and
Release
here
"
)
;
Diag
.
Report
(
D
-
>
getLocStart
(
)
Error
)
<
<
D
;
Diag
.
Report
(
BaseRefCntMember
-
>
getLocStart
(
)
Note1
)
<
<
BaseRefCntMember
-
>
getParent
(
)
;
Diag
.
Report
(
RefCntMember
-
>
getLocStart
(
)
Note2
)
;
}
if
(
FoundRefCntBase
)
{
unsigned
Error
=
Diag
.
getDiagnosticIDs
(
)
-
>
getCustomDiagID
(
DiagnosticIDs
:
:
Error
"
Refcounted
record
%
0
has
multiple
superclasses
with
mRefCnt
members
"
)
;
unsigned
Note
=
Diag
.
getDiagnosticIDs
(
)
-
>
getCustomDiagID
(
DiagnosticIDs
:
:
Note
"
Superclass
%
0
has
an
mRefCnt
member
"
)
;
Diag
.
Report
(
D
-
>
getLocStart
(
)
Error
)
<
<
D
;
Diag
.
Report
(
BaseRefCntMember
-
>
getLocStart
(
)
Note
)
<
<
BaseRefCntMember
-
>
getParent
(
)
;
Diag
.
Report
(
FoundRefCntBase
-
>
getLocStart
(
)
Note
)
<
<
FoundRefCntBase
-
>
getParent
(
)
;
}
FoundRefCntBase
=
BaseRefCntMember
;
}
}
}
