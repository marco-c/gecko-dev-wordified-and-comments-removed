import
argparse
import
errno
import
os
import
re
import
subprocess
import
sys
import
pickle
import
mozpack
.
path
as
mozpath
PRECIOUS_VARS
=
set
(
[
    
'
build_alias
'
    
'
host_alias
'
    
'
target_alias
'
    
'
CC
'
    
'
CFLAGS
'
    
'
LDFLAGS
'
    
'
LIBS
'
    
'
CPPFLAGS
'
    
'
CPP
'
    
'
CCC
'
    
'
CXXFLAGS
'
    
'
CXX
'
    
'
CCASFLAGS
'
    
'
CCAS
'
]
)
CONFIGURE_DATA
=
'
configure
.
pkl
'
def
maybe_clear_cache
(
data
)
:
    
env
=
dict
(
data
[
'
env
'
]
)
    
for
kind
in
(
'
target
'
'
host
'
'
build
'
)
:
        
arg
=
data
[
kind
]
        
if
arg
is
not
None
:
            
env
[
'
%
s_alias
'
%
kind
]
=
arg
    
for
arg
in
data
[
'
args
'
]
:
        
if
arg
[
:
1
]
!
=
'
-
'
and
'
=
'
in
arg
:
            
key
value
=
arg
.
split
(
'
=
'
1
)
            
env
[
key
]
=
value
    
comment
=
re
.
compile
(
r
'
^
\
s
+
#
'
)
    
cache
=
{
}
    
with
open
(
data
[
'
cache
-
file
'
]
)
as
f
:
        
for
line
in
f
:
            
if
not
comment
.
match
(
line
)
and
'
=
'
in
line
:
                
key
value
=
line
.
rstrip
(
os
.
linesep
)
.
split
(
'
=
'
1
)
                
if
value
[
:
1
]
=
=
"
'
"
:
                    
value
=
value
[
1
:
-
1
]
.
replace
(
"
'
\
\
'
'
"
"
'
"
)
                
cache
[
key
]
=
value
    
for
precious
in
PRECIOUS_VARS
:
        
if
'
ac_cv_env_
%
s_set
'
%
precious
not
in
cache
:
            
continue
        
is_set
=
cache
.
get
(
'
ac_cv_env_
%
s_set
'
%
precious
)
=
=
'
set
'
        
value
=
cache
.
get
(
'
ac_cv_env_
%
s_value
'
%
precious
)
if
is_set
else
None
        
if
value
!
=
env
.
get
(
precious
)
:
            
print
(
'
Removing
%
s
because
of
%
s
value
change
from
:
'
%
(
data
[
'
cache
-
file
'
]
precious
)
)
            
print
(
'
%
s
'
%
(
value
if
value
is
not
None
else
'
undefined
'
)
)
            
print
(
'
to
:
'
)
            
print
(
'
%
s
'
%
env
.
get
(
precious
'
undefined
'
)
)
            
os
.
remove
(
data
[
'
cache
-
file
'
]
)
            
return
True
    
return
False
def
prepare
(
srcdir
objdir
args
)
:
    
parser
=
argparse
.
ArgumentParser
(
)
    
parser
.
add_argument
(
'
-
-
target
'
type
=
str
)
    
parser
.
add_argument
(
'
-
-
host
'
type
=
str
)
    
parser
.
add_argument
(
'
-
-
build
'
type
=
str
)
    
parser
.
add_argument
(
'
-
-
cache
-
file
'
type
=
str
)
    
parser
.
add_argument
(
'
-
-
srcdir
'
type
=
str
)
    
data_file
=
os
.
path
.
join
(
objdir
CONFIGURE_DATA
)
    
previous_args
=
None
    
if
os
.
path
.
exists
(
data_file
)
:
        
with
open
(
data_file
'
rb
'
)
as
f
:
            
data
=
pickle
.
load
(
f
)
            
previous_args
=
data
[
'
args
'
]
    
args
others
=
parser
.
parse_known_args
(
args
)
    
data
=
{
        
'
target
'
:
args
.
target
        
'
host
'
:
args
.
host
        
'
build
'
:
args
.
build
        
'
args
'
:
others
        
'
srcdir
'
:
srcdir
        
'
objdir
'
:
objdir
        
'
env
'
:
os
.
environ
    
}
    
if
args
.
cache_file
:
        
data
[
'
cache
-
file
'
]
=
mozpath
.
normpath
(
mozpath
.
join
(
os
.
getcwd
(
)
                                                           
args
.
cache_file
)
)
    
else
:
        
data
[
'
cache
-
file
'
]
=
mozpath
.
join
(
objdir
'
config
.
cache
'
)
    
if
previous_args
is
not
None
:
        
data
[
'
previous
-
args
'
]
=
previous_args
    
try
:
        
os
.
makedirs
(
objdir
)
    
except
OSError
as
e
:
        
if
e
.
errno
!
=
errno
.
EEXIST
:
            
raise
    
with
open
(
data_file
'
wb
'
)
as
f
:
        
pickle
.
dump
(
data
f
)
    
return
data
def
prefix_lines
(
text
prefix
)
:
    
return
'
'
.
join
(
'
%
s
>
%
s
'
%
(
prefix
line
)
for
line
in
text
.
splitlines
(
True
)
)
def
execute_and_prefix
(
*
args
*
*
kwargs
)
:
    
prefix
=
kwargs
[
'
prefix
'
]
    
del
kwargs
[
'
prefix
'
]
    
proc
=
subprocess
.
Popen
(
*
args
stdout
=
subprocess
.
PIPE
                            
stderr
=
subprocess
.
STDOUT
*
*
kwargs
)
    
while
True
:
        
line
=
proc
.
stdout
.
readline
(
)
        
if
not
line
:
            
break
        
print
(
prefix_lines
(
line
.
rstrip
(
)
prefix
)
)
        
sys
.
stdout
.
flush
(
)
    
return
proc
.
wait
(
)
def
run
(
data
)
:
    
objdir
=
data
[
'
objdir
'
]
    
relobjdir
=
data
[
'
relobjdir
'
]
=
os
.
path
.
relpath
(
objdir
os
.
getcwd
(
)
)
    
cache_file
=
data
[
'
cache
-
file
'
]
    
cleared_cache
=
True
    
if
os
.
path
.
exists
(
cache_file
)
:
        
cleared_cache
=
maybe_clear_cache
(
data
)
    
configure
=
mozpath
.
join
(
data
[
'
srcdir
'
]
'
old
-
configure
'
)
    
config_status_path
=
mozpath
.
join
(
objdir
'
config
.
status
'
)
    
skip_configure
=
True
    
if
not
os
.
path
.
exists
(
config_status_path
)
:
        
skip_configure
=
False
    
else
:
        
config_status_deps
=
mozpath
.
join
(
objdir
'
config_status_deps
.
in
'
)
        
if
not
os
.
path
.
exists
(
config_status_deps
)
:
            
skip_configure
=
False
        
else
:
            
with
open
(
config_status_deps
'
r
'
)
as
fh
:
                
dep_files
=
fh
.
read
(
)
.
splitlines
(
)
+
[
configure
]
            
if
(
any
(
not
os
.
path
.
exists
(
f
)
or
                    
(
os
.
path
.
getmtime
(
config_status_path
)
<
os
.
path
.
getmtime
(
f
)
)
                    
for
f
in
dep_files
)
or
                
data
.
get
(
'
previous
-
args
'
data
[
'
args
'
]
)
!
=
data
[
'
args
'
]
or
                
cleared_cache
)
:
                
skip_configure
=
False
    
if
not
skip_configure
:
        
command
=
[
            
sys
.
executable
            
os
.
path
.
join
(
os
.
path
.
dirname
(
__file__
)
'
.
.
'
'
configure
.
py
'
)
            
'
-
-
enable
-
project
=
js
'
        
]
        
data
[
'
env
'
]
[
'
OLD_CONFIGURE
'
]
=
os
.
path
.
join
(
            
os
.
path
.
dirname
(
configure
)
'
old
-
configure
'
)
        
for
kind
in
(
'
target
'
'
build
'
'
host
'
)
:
            
if
data
.
get
(
kind
)
is
not
None
:
                
command
+
=
[
'
-
-
%
s
=
%
s
'
%
(
kind
data
[
kind
]
)
]
        
command
+
=
data
[
'
args
'
]
        
command
+
=
[
'
-
-
cache
-
file
=
%
s
'
%
cache_file
]
        
command
+
=
[
'
-
-
no
-
create
'
]
        
print
(
prefix_lines
(
'
configuring
'
relobjdir
)
)
        
print
(
prefix_lines
(
'
running
%
s
'
%
'
'
.
join
(
command
[
:
-
1
]
)
relobjdir
)
)
        
sys
.
stdout
.
flush
(
)
        
returncode
=
execute_and_prefix
(
command
cwd
=
objdir
env
=
data
[
'
env
'
]
                                        
prefix
=
relobjdir
)
        
if
returncode
:
            
return
returncode
    
return
0
def
main
(
args
)
:
    
topsrcdir
=
os
.
path
.
abspath
(
args
[
0
]
)
    
srcdir
=
os
.
path
.
join
(
topsrcdir
'
js
/
src
'
)
    
objdir
=
os
.
path
.
abspath
(
'
js
/
src
'
)
    
data
=
prepare
(
srcdir
objdir
args
[
1
:
]
)
    
return
run
(
data
)
if
__name__
=
=
'
__main__
'
:
    
sys
.
exit
(
main
(
sys
.
argv
[
1
:
]
)
)
