#
include
"
MockDragServiceController
.
h
"
#
include
"
mozilla
/
dom
/
CanonicalBrowsingContext
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
mozilla
/
dom
/
DragEvent
.
h
"
#
include
"
mozilla
/
MouseEvents
.
h
"
#
include
"
mozilla
/
SpinEventLoopUntil
.
h
"
#
include
"
nsIFrame
.
h
"
#
include
"
nsPresContext
.
h
"
#
include
"
nsBaseDragService
.
h
"
namespace
mozilla
:
:
test
{
NS_IMPL_ISUPPORTS
(
MockDragServiceController
nsIMockDragServiceController
)
class
MockDragSession
:
public
nsBaseDragSession
{
protected
:
MOZ_CAN_RUN_SCRIPT
nsresult
InvokeDragSessionImpl
(
nsIWidget
*
aWidget
nsIArray
*
aTransferableArray
const
mozilla
:
:
Maybe
<
mozilla
:
:
CSSIntRegion
>
&
aRegion
uint32_t
aActionType
)
override
{
mDragAction
=
nsIDragService
:
:
DRAGDROP_ACTION_MOVE
;
return
NS_OK
;
}
}
;
class
MockDragService
:
public
nsBaseDragService
{
public
:
NS_IMETHOD
GetIsMockService
(
bool
*
aRet
)
override
{
*
aRet
=
true
;
return
NS_OK
;
}
uint32_t
mLastModifierKeyState
=
0
;
protected
:
already_AddRefed
<
nsIDragSession
>
CreateDragSession
(
)
override
{
RefPtr
<
nsIDragSession
>
session
=
new
MockDragSession
(
)
;
return
session
.
forget
(
)
;
}
}
;
static
void
SetDragEndPointFromScreenPoint
(
nsIDragSession
*
aSession
nsPresContext
*
aPc
const
LayoutDeviceIntPoint
&
aScreenPt
)
{
auto
*
widget
=
aPc
-
>
GetRootWidget
(
)
;
auto
pt
=
aScreenPt
-
widget
-
>
WidgetToScreenOffset
(
)
;
pt
+
=
widget
-
>
WidgetToTopLevelWidgetOffset
(
)
;
aSession
-
>
SetDragEndPoint
(
pt
.
x
pt
.
y
)
;
}
static
bool
IsMouseEvent
(
nsIMockDragServiceController
:
:
EventType
aEventType
)
{
using
EventType
=
nsIMockDragServiceController
:
:
EventType
;
switch
(
aEventType
)
{
case
EventType
:
:
eMouseDown
:
case
EventType
:
:
eMouseMove
:
case
EventType
:
:
eMouseUp
:
return
true
;
default
:
return
false
;
}
}
static
EventMessage
MockEventTypeToEventMessage
(
nsIMockDragServiceController
:
:
EventType
aEventType
)
{
using
EventType
=
nsIMockDragServiceController
:
:
EventType
;
switch
(
aEventType
)
{
case
EventType
:
:
eDragEnter
:
return
EventMessage
:
:
eDragEnter
;
case
EventType
:
:
eDragOver
:
return
EventMessage
:
:
eDragOver
;
case
EventType
:
:
eDragExit
:
return
EventMessage
:
:
eDragExit
;
case
EventType
:
:
eDrop
:
return
EventMessage
:
:
eDrop
;
case
EventType
:
:
eMouseDown
:
return
EventMessage
:
:
eMouseDown
;
case
EventType
:
:
eMouseMove
:
return
EventMessage
:
:
eMouseMove
;
case
EventType
:
:
eMouseUp
:
return
EventMessage
:
:
eMouseUp
;
default
:
MOZ_ASSERT
(
false
"
Invalid
event
type
"
)
;
return
EventMessage
:
:
eVoidEvent
;
}
}
MockDragServiceController
:
:
MockDragServiceController
(
)
:
mDragService
(
new
MockDragService
(
)
)
{
}
MockDragServiceController
:
:
~
MockDragServiceController
(
)
=
default
;
NS_IMETHODIMP
MockDragServiceController
:
:
GetMockDragService
(
nsIDragService
*
*
aService
)
{
RefPtr
<
nsIDragService
>
ds
=
mDragService
;
ds
.
forget
(
aService
)
;
return
NS_OK
;
}
NS_IMETHODIMP
MockDragServiceController
:
:
SendEvent
(
dom
:
:
BrowsingContext
*
aBC
nsIMockDragServiceController
:
:
EventType
aEventType
int32_t
aScreenX
int32_t
aScreenY
uint32_t
aKeyModifiers
=
0
)
{
RefPtr
<
nsIWidget
>
widget
=
aBC
-
>
Canonical
(
)
-
>
GetParentProcessWidgetContaining
(
)
;
NS_ENSURE_TRUE
(
widget
NS_ERROR_UNEXPECTED
)
;
auto
*
embedder
=
aBC
-
>
Top
(
)
-
>
GetEmbedderElement
(
)
;
NS_ENSURE_TRUE
(
embedder
NS_ERROR_UNEXPECTED
)
;
auto
*
frame
=
embedder
-
>
GetPrimaryFrame
(
)
;
NS_ENSURE_TRUE
(
frame
NS_ERROR_UNEXPECTED
)
;
auto
*
presCxt
=
frame
-
>
PresContext
(
)
;
MOZ_ASSERT
(
presCxt
)
;
EventMessage
eventType
=
MockEventTypeToEventMessage
(
aEventType
)
;
UniquePtr
<
WidgetInputEvent
>
widgetEvent
;
if
(
IsMouseEvent
(
aEventType
)
)
{
widgetEvent
=
MakeUnique
<
WidgetMouseEvent
>
(
true
eventType
widget
WidgetMouseEvent
:
:
Reason
:
:
eReal
)
;
}
else
{
widgetEvent
=
MakeUnique
<
WidgetDragEvent
>
(
true
eventType
widget
)
;
}
widgetEvent
-
>
mWidget
=
widget
;
widgetEvent
-
>
mFlags
.
mIsSynthesizedForTests
=
true
;
auto
clientPosInScreenCoords
=
widget
-
>
GetClientBounds
(
)
.
TopLeft
(
)
;
widgetEvent
-
>
mRefPoint
=
LayoutDeviceIntPoint
(
aScreenX
aScreenY
)
-
clientPosInScreenCoords
;
RefPtr
<
MockDragService
>
ds
=
mDragService
;
if
(
aEventType
=
=
EventType
:
:
eDragEnter
)
{
ds
-
>
StartDragSession
(
widget
)
;
}
nsCOMPtr
<
nsIDragSession
>
currentDragSession
=
ds
-
>
GetCurrentSession
(
widget
)
;
nsresult
rv
;
switch
(
aEventType
)
{
case
EventType
:
:
eMouseDown
:
case
EventType
:
:
eMouseMove
:
case
EventType
:
:
eMouseUp
:
widget
-
>
DispatchInputEvent
(
widgetEvent
.
get
(
)
)
;
break
;
case
EventType
:
:
eDragEnter
:
NS_ENSURE_TRUE
(
currentDragSession
NS_ERROR_UNEXPECTED
)
;
currentDragSession
-
>
SetDragAction
(
nsIDragService
:
:
DRAGDROP_ACTION_MOVE
)
;
widget
-
>
DispatchInputEvent
(
widgetEvent
.
get
(
)
)
;
break
;
case
EventType
:
:
eDragExit
:
{
NS_ENSURE_TRUE
(
currentDragSession
NS_ERROR_UNEXPECTED
)
;
currentDragSession
-
>
SetDragAction
(
nsIDragService
:
:
DRAGDROP_ACTION_MOVE
)
;
widget
-
>
DispatchInputEvent
(
widgetEvent
.
get
(
)
)
;
SetDragEndPointFromScreenPoint
(
currentDragSession
presCxt
LayoutDeviceIntPoint
(
aScreenX
aScreenY
)
)
;
nsCOMPtr
<
nsINode
>
sourceNode
;
rv
=
currentDragSession
-
>
GetSourceNode
(
getter_AddRefs
(
sourceNode
)
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
!
sourceNode
)
{
rv
=
currentDragSession
-
>
EndDragSession
(
false
aKeyModifiers
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
}
break
;
case
EventType
:
:
eDragOver
:
NS_ENSURE_TRUE
(
currentDragSession
NS_ERROR_UNEXPECTED
)
;
rv
=
currentDragSession
-
>
FireDragEventAtSource
(
EventMessage
:
:
eDrag
aKeyModifiers
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
currentDragSession
-
>
SetDragAction
(
nsIDragService
:
:
DRAGDROP_ACTION_MOVE
)
;
widget
-
>
DispatchInputEvent
(
widgetEvent
.
get
(
)
)
;
break
;
case
EventType
:
:
eDrop
:
{
NS_ENSURE_TRUE
(
currentDragSession
NS_ERROR_UNEXPECTED
)
;
currentDragSession
-
>
SetDragAction
(
nsIDragService
:
:
DRAGDROP_ACTION_MOVE
)
;
widget
-
>
DispatchInputEvent
(
widgetEvent
.
get
(
)
)
;
SetDragEndPointFromScreenPoint
(
currentDragSession
presCxt
LayoutDeviceIntPoint
(
aScreenX
aScreenY
)
)
;
rv
=
currentDragSession
-
>
EndDragSession
(
true
aKeyModifiers
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
break
;
default
:
MOZ_ASSERT_UNREACHABLE
(
"
Impossible
event
type
?
"
)
;
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
NS_IMETHODIMP
MockDragServiceController
:
:
CancelDrag
(
uint32_t
aKeyModifiers
=
0
)
{
RefPtr
<
MockDragService
>
ds
=
mDragService
;
nsCOMPtr
<
nsIDragSession
>
currentDragSession
;
ds
-
>
GetCurrentSession
(
nullptr
getter_AddRefs
(
currentDragSession
)
)
;
MOZ_ASSERT
(
currentDragSession
)
;
return
currentDragSession
-
>
EndDragSession
(
false
aKeyModifiers
)
;
}
}
