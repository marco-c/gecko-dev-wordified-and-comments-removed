#
include
"
nsIDeviceContextSpec
.
h
"
#
include
"
gfxPoint
.
h
"
#
include
"
mozilla
/
gfx
/
PrintPromise
.
h
"
#
include
"
nsError
.
h
"
#
include
"
nsIPrintSettings
.
h
"
#
include
"
mozilla
/
Components
.
h
"
#
include
"
mozilla
/
TaskQueue
.
h
"
using
mozilla
:
:
MakeRefPtr
;
using
mozilla
:
:
gfx
:
:
PrintEndDocumentPromise
;
float
nsIDeviceContextSpec
:
:
GetPrintingScale
(
)
{
#
ifdef
XP_WIN
if
(
mPrintSettings
-
>
GetOutputFormat
(
)
!
=
nsIPrintSettings
:
:
kOutputFormatPDF
#
ifdef
MOZ_ENABLE_SKIA_PDF
&
&
!
mPrintViaSkPDF
#
endif
)
{
int32_t
resolution
;
mPrintSettings
-
>
GetResolution
(
&
resolution
)
;
return
float
(
resolution
)
/
GetDPI
(
)
;
}
#
endif
return
72
.
0f
/
GetDPI
(
)
;
}
gfxPoint
nsIDeviceContextSpec
:
:
GetPrintingTranslate
(
)
{
#
ifdef
XP_WIN
double
marginTop
marginLeft
;
mPrintSettings
-
>
GetUnwriteableMarginTop
(
&
marginTop
)
;
mPrintSettings
-
>
GetUnwriteableMarginLeft
(
&
marginLeft
)
;
int32_t
resolution
;
mPrintSettings
-
>
GetResolution
(
&
resolution
)
;
return
gfxPoint
(
-
marginLeft
*
resolution
-
marginTop
*
resolution
)
;
#
else
return
gfxPoint
(
0
0
)
;
#
endif
}
RefPtr
<
PrintEndDocumentPromise
>
nsIDeviceContextSpec
:
:
EndDocumentPromiseFromResult
(
nsresult
aResult
const
char
*
aSite
)
{
return
NS_SUCCEEDED
(
aResult
)
?
PrintEndDocumentPromise
:
:
CreateAndResolve
(
true
aSite
)
:
PrintEndDocumentPromise
:
:
CreateAndReject
(
aResult
aSite
)
;
}
RefPtr
<
PrintEndDocumentPromise
>
nsIDeviceContextSpec
:
:
EndDocumentAsync
(
const
char
*
aCallSite
AsyncEndDocumentFunction
aFunction
)
{
auto
promise
=
MakeRefPtr
<
PrintEndDocumentPromise
:
:
Private
>
(
"
PrintEndDocumentPromise
"
)
;
NS_DispatchBackgroundTask
(
NS_NewRunnableFunction
(
"
EndDocumentAsync
"
[
promise
function
=
std
:
:
move
(
aFunction
)
]
(
)
mutable
{
const
auto
result
=
function
(
)
;
if
(
NS_SUCCEEDED
(
result
)
)
{
promise
-
>
Resolve
(
true
__func__
)
;
}
else
{
promise
-
>
Reject
(
result
__func__
)
;
}
}
)
NS_DISPATCH_EVENT_MAY_BLOCK
)
;
return
promise
;
}
