#
ifndef
mozilla_MouseEvents_h__
#
define
mozilla_MouseEvents_h__
#
include
<
stdint
.
h
>
#
include
"
mozilla
/
BasicEvents
.
h
"
#
include
"
mozilla
/
MathAlgorithms
.
h
"
#
include
"
mozilla
/
dom
/
DataTransfer
.
h
"
#
include
"
mozilla
/
ipc
/
IPCForwards
.
h
"
#
include
"
nsCOMPtr
.
h
"
namespace
mozilla
{
namespace
dom
{
class
PBrowserParent
;
class
PBrowserChild
;
class
PBrowserBridgeParent
;
}
class
WidgetPointerEvent
;
}
namespace
mozilla
{
class
WidgetPointerEventHolder
final
{
public
:
nsTArray
<
WidgetPointerEvent
>
mEvents
;
NS_INLINE_DECL_REFCOUNTING
(
WidgetPointerEventHolder
)
private
:
virtual
~
WidgetPointerEventHolder
(
)
=
default
;
}
;
class
WidgetPointerHelper
{
public
:
uint32_t
pointerId
;
int32_t
tiltX
;
int32_t
tiltY
;
int32_t
twist
;
float
tangentialPressure
;
bool
convertToPointer
;
RefPtr
<
WidgetPointerEventHolder
>
mCoalescedWidgetEvents
;
WidgetPointerHelper
(
)
:
pointerId
(
0
)
tiltX
(
0
)
tiltY
(
0
)
twist
(
0
)
tangentialPressure
(
0
)
convertToPointer
(
true
)
{
}
WidgetPointerHelper
(
uint32_t
aPointerId
uint32_t
aTiltX
uint32_t
aTiltY
uint32_t
aTwist
=
0
float
aTangentialPressure
=
0
)
:
pointerId
(
aPointerId
)
tiltX
(
aTiltX
)
tiltY
(
aTiltY
)
twist
(
aTwist
)
tangentialPressure
(
aTangentialPressure
)
convertToPointer
(
true
)
{
}
explicit
WidgetPointerHelper
(
const
WidgetPointerHelper
&
aHelper
)
=
default
;
void
AssignPointerHelperData
(
const
WidgetPointerHelper
&
aEvent
bool
aCopyCoalescedEvents
=
false
)
{
pointerId
=
aEvent
.
pointerId
;
tiltX
=
aEvent
.
tiltX
;
tiltY
=
aEvent
.
tiltY
;
twist
=
aEvent
.
twist
;
tangentialPressure
=
aEvent
.
tangentialPressure
;
convertToPointer
=
aEvent
.
convertToPointer
;
if
(
aCopyCoalescedEvents
)
{
mCoalescedWidgetEvents
=
aEvent
.
mCoalescedWidgetEvents
;
}
}
}
;
class
WidgetMouseEventBase
:
public
WidgetInputEvent
{
private
:
friend
class
dom
:
:
PBrowserParent
;
friend
class
dom
:
:
PBrowserChild
;
friend
class
dom
:
:
PBrowserBridgeParent
;
ALLOW_DEPRECATED_READPARAM
protected
:
WidgetMouseEventBase
(
)
:
mPressure
(
0
)
mButton
(
0
)
mButtons
(
0
)
mInputSource
(
1
)
{
}
WidgetMouseEventBase
(
bool
aIsTrusted
EventMessage
aMessage
nsIWidget
*
aWidget
EventClassID
aEventClassID
)
:
WidgetInputEvent
(
aIsTrusted
aMessage
aWidget
aEventClassID
)
mPressure
(
0
)
mButton
(
0
)
mButtons
(
0
)
mInputSource
(
1
)
{
}
public
:
virtual
WidgetMouseEventBase
*
AsMouseEventBase
(
)
override
{
return
this
;
}
virtual
WidgetEvent
*
Duplicate
(
)
const
override
{
MOZ_CRASH
(
"
WidgetMouseEventBase
must
not
be
most
-
subclass
"
)
;
}
float
mPressure
;
int16_t
mButton
;
int16_t
mButtons
;
uint16_t
mInputSource
;
bool
IsLeftButtonPressed
(
)
const
{
return
!
!
(
mButtons
&
MouseButtonsFlag
:
:
ePrimaryFlag
)
;
}
bool
IsRightButtonPressed
(
)
const
{
return
!
!
(
mButtons
&
MouseButtonsFlag
:
:
eSecondaryFlag
)
;
}
bool
IsMiddleButtonPressed
(
)
const
{
return
!
!
(
mButtons
&
MouseButtonsFlag
:
:
eMiddleFlag
)
;
}
bool
Is4thButtonPressed
(
)
const
{
return
!
!
(
mButtons
&
MouseButtonsFlag
:
:
e4thFlag
)
;
}
bool
Is5thButtonPressed
(
)
const
{
return
!
!
(
mButtons
&
MouseButtonsFlag
:
:
e5thFlag
)
;
}
void
AssignMouseEventBaseData
(
const
WidgetMouseEventBase
&
aEvent
bool
aCopyTargets
)
{
AssignInputEventData
(
aEvent
aCopyTargets
)
;
mButton
=
aEvent
.
mButton
;
mButtons
=
aEvent
.
mButtons
;
mPressure
=
aEvent
.
mPressure
;
mInputSource
=
aEvent
.
mInputSource
;
}
bool
IsLeftClickEvent
(
)
const
{
return
mMessage
=
=
eMouseClick
&
&
mButton
=
=
MouseButton
:
:
ePrimary
;
}
}
;
class
WidgetMouseEvent
:
public
WidgetMouseEventBase
public
WidgetPointerHelper
{
private
:
friend
class
dom
:
:
PBrowserParent
;
friend
class
dom
:
:
PBrowserChild
;
friend
class
dom
:
:
PBrowserBridgeParent
;
ALLOW_DEPRECATED_READPARAM
public
:
typedef
bool
ReasonType
;
enum
Reason
:
ReasonType
{
eReal
eSynthesized
}
;
typedef
uint8_t
ContextMenuTriggerType
;
enum
ContextMenuTrigger
:
ContextMenuTriggerType
{
eNormal
eContextMenuKey
eControlClick
}
;
typedef
uint8_t
ExitFromType
;
enum
ExitFrom
:
ExitFromType
{
ePlatformChild
ePlatformTopLevel
ePuppet
ePuppetParentToPuppetChild
}
;
protected
:
WidgetMouseEvent
(
)
:
mReason
(
eReal
)
mContextMenuTrigger
(
eNormal
)
mClickCount
(
0
)
mIgnoreRootScrollFrame
(
false
)
mUseLegacyNonPrimaryDispatch
(
false
)
mClickEventPrevented
(
false
)
{
}
WidgetMouseEvent
(
bool
aIsTrusted
EventMessage
aMessage
nsIWidget
*
aWidget
EventClassID
aEventClassID
Reason
aReason
)
:
WidgetMouseEventBase
(
aIsTrusted
aMessage
aWidget
aEventClassID
)
mReason
(
aReason
)
mContextMenuTrigger
(
eNormal
)
mClickCount
(
0
)
mIgnoreRootScrollFrame
(
false
)
mUseLegacyNonPrimaryDispatch
(
false
)
mClickEventPrevented
(
false
)
{
}
#
ifdef
DEBUG
void
AssertContextMenuEventButtonConsistency
(
)
const
;
#
endif
public
:
virtual
WidgetMouseEvent
*
AsMouseEvent
(
)
override
{
return
this
;
}
WidgetMouseEvent
(
bool
aIsTrusted
EventMessage
aMessage
nsIWidget
*
aWidget
Reason
aReason
ContextMenuTrigger
aContextMenuTrigger
=
eNormal
)
:
WidgetMouseEventBase
(
aIsTrusted
aMessage
aWidget
eMouseEventClass
)
mReason
(
aReason
)
mContextMenuTrigger
(
aContextMenuTrigger
)
mClickCount
(
0
)
mIgnoreRootScrollFrame
(
false
)
mUseLegacyNonPrimaryDispatch
(
false
)
mClickEventPrevented
(
false
)
{
if
(
aMessage
=
=
eContextMenu
)
{
mButton
=
(
mContextMenuTrigger
=
=
eNormal
)
?
MouseButton
:
:
eSecondary
:
MouseButton
:
:
ePrimary
;
}
}
#
ifdef
DEBUG
virtual
~
WidgetMouseEvent
(
)
{
AssertContextMenuEventButtonConsistency
(
)
;
}
#
endif
virtual
WidgetEvent
*
Duplicate
(
)
const
override
{
MOZ_ASSERT
(
mClass
=
=
eMouseEventClass
"
Duplicate
(
)
must
be
overridden
by
sub
class
"
)
;
WidgetMouseEvent
*
result
=
new
WidgetMouseEvent
(
false
mMessage
nullptr
mReason
mContextMenuTrigger
)
;
result
-
>
AssignMouseEventData
(
*
this
true
)
;
result
-
>
mFlags
=
mFlags
;
return
result
;
}
nsCOMPtr
<
dom
:
:
EventTarget
>
mClickTarget
;
Reason
mReason
;
ContextMenuTrigger
mContextMenuTrigger
;
Maybe
<
ExitFrom
>
mExitFrom
;
uint32_t
mClickCount
;
bool
mIgnoreRootScrollFrame
;
bool
mUseLegacyNonPrimaryDispatch
;
bool
mClickEventPrevented
;
void
AssignMouseEventData
(
const
WidgetMouseEvent
&
aEvent
bool
aCopyTargets
)
{
AssignMouseEventBaseData
(
aEvent
aCopyTargets
)
;
AssignPointerHelperData
(
aEvent
true
)
;
mExitFrom
=
aEvent
.
mExitFrom
;
mClickCount
=
aEvent
.
mClickCount
;
mIgnoreRootScrollFrame
=
aEvent
.
mIgnoreRootScrollFrame
;
mUseLegacyNonPrimaryDispatch
=
aEvent
.
mUseLegacyNonPrimaryDispatch
;
mClickEventPrevented
=
aEvent
.
mClickEventPrevented
;
}
bool
IsContextMenuKeyEvent
(
)
const
{
return
mMessage
=
=
eContextMenu
&
&
mContextMenuTrigger
=
=
eContextMenuKey
;
}
bool
IsReal
(
)
const
{
return
mReason
=
=
eReal
;
}
static
bool
IsMiddleClickPasteEnabled
(
)
;
}
;
class
WidgetDragEvent
:
public
WidgetMouseEvent
{
private
:
friend
class
mozilla
:
:
dom
:
:
PBrowserParent
;
friend
class
mozilla
:
:
dom
:
:
PBrowserChild
;
ALLOW_DEPRECATED_READPARAM
protected
:
WidgetDragEvent
(
)
:
mUserCancelled
(
false
)
mDefaultPreventedOnContent
(
false
)
{
}
public
:
virtual
WidgetDragEvent
*
AsDragEvent
(
)
override
{
return
this
;
}
WidgetDragEvent
(
bool
aIsTrusted
EventMessage
aMessage
nsIWidget
*
aWidget
)
:
WidgetMouseEvent
(
aIsTrusted
aMessage
aWidget
eDragEventClass
eReal
)
mUserCancelled
(
false
)
mDefaultPreventedOnContent
(
false
)
{
}
virtual
WidgetEvent
*
Duplicate
(
)
const
override
{
MOZ_ASSERT
(
mClass
=
=
eDragEventClass
"
Duplicate
(
)
must
be
overridden
by
sub
class
"
)
;
WidgetDragEvent
*
result
=
new
WidgetDragEvent
(
false
mMessage
nullptr
)
;
result
-
>
AssignDragEventData
(
*
this
true
)
;
result
-
>
mFlags
=
mFlags
;
return
result
;
}
nsCOMPtr
<
dom
:
:
DataTransfer
>
mDataTransfer
;
bool
mUserCancelled
;
bool
mDefaultPreventedOnContent
;
void
AssignDragEventData
(
const
WidgetDragEvent
&
aEvent
bool
aCopyTargets
)
{
AssignMouseEventData
(
aEvent
aCopyTargets
)
;
mDataTransfer
=
aEvent
.
mDataTransfer
;
mUserCancelled
=
false
;
mDefaultPreventedOnContent
=
aEvent
.
mDefaultPreventedOnContent
;
}
void
UpdateDefaultPreventedOnContent
(
dom
:
:
EventTarget
*
aTarget
)
;
void
InitDropEffectForTests
(
)
;
}
;
class
WidgetMouseScrollEvent
:
public
WidgetMouseEventBase
{
private
:
WidgetMouseScrollEvent
(
)
:
mDelta
(
0
)
mIsHorizontal
(
false
)
{
}
public
:
virtual
WidgetMouseScrollEvent
*
AsMouseScrollEvent
(
)
override
{
return
this
;
}
WidgetMouseScrollEvent
(
bool
aIsTrusted
EventMessage
aMessage
nsIWidget
*
aWidget
)
:
WidgetMouseEventBase
(
aIsTrusted
aMessage
aWidget
eMouseScrollEventClass
)
mDelta
(
0
)
mIsHorizontal
(
false
)
{
}
virtual
WidgetEvent
*
Duplicate
(
)
const
override
{
MOZ_ASSERT
(
mClass
=
=
eMouseScrollEventClass
"
Duplicate
(
)
must
be
overridden
by
sub
class
"
)
;
WidgetMouseScrollEvent
*
result
=
new
WidgetMouseScrollEvent
(
false
mMessage
nullptr
)
;
result
-
>
AssignMouseScrollEventData
(
*
this
true
)
;
result
-
>
mFlags
=
mFlags
;
return
result
;
}
int32_t
mDelta
;
bool
mIsHorizontal
;
void
AssignMouseScrollEventData
(
const
WidgetMouseScrollEvent
&
aEvent
bool
aCopyTargets
)
{
AssignMouseEventBaseData
(
aEvent
aCopyTargets
)
;
mDelta
=
aEvent
.
mDelta
;
mIsHorizontal
=
aEvent
.
mIsHorizontal
;
}
}
;
class
WidgetWheelEvent
:
public
WidgetMouseEventBase
{
private
:
friend
class
mozilla
:
:
dom
:
:
PBrowserParent
;
friend
class
mozilla
:
:
dom
:
:
PBrowserChild
;
ALLOW_DEPRECATED_READPARAM
WidgetWheelEvent
(
)
:
mDeltaX
(
0
.
0
)
mDeltaY
(
0
.
0
)
mDeltaZ
(
0
.
0
)
mOverflowDeltaX
(
0
.
0
)
mOverflowDeltaY
(
0
.
0
)
mDeltaMode
(
0
)
mLineOrPageDeltaX
(
0
)
mLineOrPageDeltaY
(
0
)
mScrollType
(
SCROLL_DEFAULT
)
mCustomizedByUserPrefs
(
false
)
mMayHaveMomentum
(
false
)
mIsMomentum
(
false
)
mIsNoLineOrPageDelta
(
false
)
mViewPortIsOverscrolled
(
false
)
mCanTriggerSwipe
(
false
)
mAllowToOverrideSystemScrollSpeed
(
false
)
mDeltaValuesHorizontalizedForDefaultHandler
(
false
)
{
}
public
:
virtual
WidgetWheelEvent
*
AsWheelEvent
(
)
override
{
return
this
;
}
WidgetWheelEvent
(
bool
aIsTrusted
EventMessage
aMessage
nsIWidget
*
aWidget
)
:
WidgetMouseEventBase
(
aIsTrusted
aMessage
aWidget
eWheelEventClass
)
mDeltaX
(
0
.
0
)
mDeltaY
(
0
.
0
)
mDeltaZ
(
0
.
0
)
mOverflowDeltaX
(
0
.
0
)
mOverflowDeltaY
(
0
.
0
)
mDeltaMode
(
0
)
mLineOrPageDeltaX
(
0
)
mLineOrPageDeltaY
(
0
)
mScrollType
(
SCROLL_DEFAULT
)
mCustomizedByUserPrefs
(
false
)
mMayHaveMomentum
(
false
)
mIsMomentum
(
false
)
mIsNoLineOrPageDelta
(
false
)
mViewPortIsOverscrolled
(
false
)
mCanTriggerSwipe
(
false
)
mAllowToOverrideSystemScrollSpeed
(
true
)
mDeltaValuesHorizontalizedForDefaultHandler
(
false
)
{
}
virtual
WidgetEvent
*
Duplicate
(
)
const
override
{
MOZ_ASSERT
(
mClass
=
=
eWheelEventClass
"
Duplicate
(
)
must
be
overridden
by
sub
class
"
)
;
WidgetWheelEvent
*
result
=
new
WidgetWheelEvent
(
false
mMessage
nullptr
)
;
result
-
>
AssignWheelEventData
(
*
this
true
)
;
result
-
>
mFlags
=
mFlags
;
return
result
;
}
bool
TriggersSwipe
(
)
const
{
return
mCanTriggerSwipe
&
&
mViewPortIsOverscrolled
&
&
this
-
>
mOverflowDeltaX
!
=
0
.
0
;
}
double
mDeltaX
;
double
mDeltaY
;
double
mDeltaZ
;
double
mWheelTicksX
=
0
.
0
;
double
mWheelTicksY
=
0
.
0
;
enum
class
DeltaModeCheckingState
:
uint8_t
{
Unknown
Unchecked
Checked
}
;
DeltaModeCheckingState
mDeltaModeCheckingState
=
DeltaModeCheckingState
:
:
Unknown
;
nsSize
mScrollAmount
;
double
mOverflowDeltaX
;
double
mOverflowDeltaY
;
uint32_t
mDeltaMode
;
int32_t
mLineOrPageDeltaX
;
int32_t
mLineOrPageDeltaY
;
int32_t
GetPreferredIntDelta
(
)
{
if
(
!
mLineOrPageDeltaX
&
&
!
mLineOrPageDeltaY
)
{
return
0
;
}
if
(
mLineOrPageDeltaY
&
&
!
mLineOrPageDeltaX
)
{
return
mLineOrPageDeltaY
;
}
if
(
mLineOrPageDeltaX
&
&
!
mLineOrPageDeltaY
)
{
return
mLineOrPageDeltaX
;
}
if
(
(
mLineOrPageDeltaX
<
0
&
&
mLineOrPageDeltaY
>
0
)
|
|
(
mLineOrPageDeltaX
>
0
&
&
mLineOrPageDeltaY
<
0
)
)
{
return
0
;
}
return
(
Abs
(
mLineOrPageDeltaX
)
>
Abs
(
mLineOrPageDeltaY
)
)
?
mLineOrPageDeltaX
:
mLineOrPageDeltaY
;
}
enum
ScrollType
:
uint8_t
{
SCROLL_DEFAULT
SCROLL_SYNCHRONOUSLY
SCROLL_ASYNCHRONOUSLY
SCROLL_SMOOTHLY
}
;
ScrollType
mScrollType
;
bool
mCustomizedByUserPrefs
;
bool
mMayHaveMomentum
;
bool
mIsMomentum
;
bool
mIsNoLineOrPageDelta
;
bool
mViewPortIsOverscrolled
;
bool
mCanTriggerSwipe
;
bool
mAllowToOverrideSystemScrollSpeed
;
bool
mDeltaValuesHorizontalizedForDefaultHandler
;
void
AssignWheelEventData
(
const
WidgetWheelEvent
&
aEvent
bool
aCopyTargets
)
{
AssignMouseEventBaseData
(
aEvent
aCopyTargets
)
;
mDeltaX
=
aEvent
.
mDeltaX
;
mDeltaY
=
aEvent
.
mDeltaY
;
mDeltaZ
=
aEvent
.
mDeltaZ
;
mDeltaMode
=
aEvent
.
mDeltaMode
;
mScrollAmount
=
aEvent
.
mScrollAmount
;
mCustomizedByUserPrefs
=
aEvent
.
mCustomizedByUserPrefs
;
mMayHaveMomentum
=
aEvent
.
mMayHaveMomentum
;
mIsMomentum
=
aEvent
.
mIsMomentum
;
mIsNoLineOrPageDelta
=
aEvent
.
mIsNoLineOrPageDelta
;
mLineOrPageDeltaX
=
aEvent
.
mLineOrPageDeltaX
;
mLineOrPageDeltaY
=
aEvent
.
mLineOrPageDeltaY
;
mScrollType
=
aEvent
.
mScrollType
;
mOverflowDeltaX
=
aEvent
.
mOverflowDeltaX
;
mOverflowDeltaY
=
aEvent
.
mOverflowDeltaY
;
mViewPortIsOverscrolled
=
aEvent
.
mViewPortIsOverscrolled
;
mCanTriggerSwipe
=
aEvent
.
mCanTriggerSwipe
;
mAllowToOverrideSystemScrollSpeed
=
aEvent
.
mAllowToOverrideSystemScrollSpeed
;
mDeltaValuesHorizontalizedForDefaultHandler
=
aEvent
.
mDeltaValuesHorizontalizedForDefaultHandler
;
}
double
OverriddenDeltaX
(
)
const
;
double
OverriddenDeltaY
(
)
const
;
static
double
ComputeOverriddenDelta
(
double
aDelta
bool
aIsForVertical
)
;
private
:
static
bool
sInitialized
;
static
bool
sIsSystemScrollSpeedOverrideEnabled
;
static
int32_t
sOverrideFactorX
;
static
int32_t
sOverrideFactorY
;
static
void
Initialize
(
)
;
}
;
class
WidgetPointerEvent
:
public
WidgetMouseEvent
{
friend
class
mozilla
:
:
dom
:
:
PBrowserParent
;
friend
class
mozilla
:
:
dom
:
:
PBrowserChild
;
ALLOW_DEPRECATED_READPARAM
public
:
virtual
WidgetPointerEvent
*
AsPointerEvent
(
)
override
{
return
this
;
}
WidgetPointerEvent
(
bool
aIsTrusted
EventMessage
aMsg
nsIWidget
*
w
)
:
WidgetMouseEvent
(
aIsTrusted
aMsg
w
ePointerEventClass
eReal
)
mWidth
(
1
)
mHeight
(
1
)
mIsPrimary
(
true
)
mFromTouchEvent
(
false
)
{
}
explicit
WidgetPointerEvent
(
const
WidgetMouseEvent
&
aEvent
)
:
WidgetMouseEvent
(
aEvent
)
mWidth
(
1
)
mHeight
(
1
)
mIsPrimary
(
true
)
mFromTouchEvent
(
false
)
{
mClass
=
ePointerEventClass
;
}
virtual
WidgetEvent
*
Duplicate
(
)
const
override
{
MOZ_ASSERT
(
mClass
=
=
ePointerEventClass
"
Duplicate
(
)
must
be
overridden
by
sub
class
"
)
;
WidgetPointerEvent
*
result
=
new
WidgetPointerEvent
(
false
mMessage
nullptr
)
;
result
-
>
AssignPointerEventData
(
*
this
true
)
;
result
-
>
mFlags
=
mFlags
;
return
result
;
}
int32_t
mWidth
;
int32_t
mHeight
;
bool
mIsPrimary
;
bool
mFromTouchEvent
;
void
AssignPointerEventData
(
const
WidgetPointerEvent
&
aEvent
bool
aCopyTargets
)
{
AssignMouseEventData
(
aEvent
aCopyTargets
)
;
mWidth
=
aEvent
.
mWidth
;
mHeight
=
aEvent
.
mHeight
;
mIsPrimary
=
aEvent
.
mIsPrimary
;
mFromTouchEvent
=
aEvent
.
mFromTouchEvent
;
}
}
;
}
#
endif
