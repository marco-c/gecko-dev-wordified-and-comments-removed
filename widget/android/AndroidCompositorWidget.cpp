#
include
"
AndroidCompositorWidget
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
widget
/
PlatformWidgetTypes
.
h
"
#
include
"
nsWindow
.
h
"
namespace
mozilla
{
namespace
widget
{
AndroidCompositorWidget
:
:
AndroidCompositorWidget
(
const
AndroidCompositorWidgetInitData
&
aInitData
const
layers
:
:
CompositorOptions
&
aOptions
)
:
CompositorWidget
(
aOptions
)
mWidgetId
(
aInitData
.
widgetId
(
)
)
mNativeWindow
(
nullptr
)
mFormat
(
WINDOW_FORMAT_RGBA_8888
)
mClientSize
(
0
0
)
{
}
AndroidCompositorWidget
:
:
~
AndroidCompositorWidget
(
)
{
if
(
mNativeWindow
)
{
ANativeWindow_release
(
mNativeWindow
)
;
}
}
already_AddRefed
<
gfx
:
:
DrawTarget
>
AndroidCompositorWidget
:
:
StartRemoteDrawingInRegion
(
const
LayoutDeviceIntRegion
&
aInvalidRegion
layers
:
:
BufferMode
*
aBufferMode
)
{
if
(
!
mNativeWindow
)
{
EGLNativeWindowType
window
=
GetEGLNativeWindow
(
)
;
JNIEnv
*
const
env
=
jni
:
:
GetEnvForThread
(
)
;
mNativeWindow
=
ANativeWindow_fromSurface
(
env
reinterpret_cast
<
jobject
>
(
window
)
)
;
if
(
mNativeWindow
)
{
mFormat
=
ANativeWindow_getFormat
(
mNativeWindow
)
;
ANativeWindow_acquire
(
mNativeWindow
)
;
}
else
{
return
nullptr
;
}
}
if
(
mFormat
!
=
WINDOW_FORMAT_RGBA_8888
&
&
mFormat
!
=
WINDOW_FORMAT_RGBX_8888
)
{
gfxCriticalNoteOnce
<
<
"
Non
supported
format
:
"
<
<
mFormat
;
return
nullptr
;
}
if
(
ANativeWindow_lock
(
mNativeWindow
&
mBuffer
nullptr
)
!
=
0
)
{
return
nullptr
;
}
const
int
bpp
=
4
;
gfx
:
:
SurfaceFormat
format
=
gfx
:
:
SurfaceFormat
:
:
R8G8B8A8
;
if
(
mFormat
=
=
WINDOW_FORMAT_RGBX_8888
)
{
format
=
gfx
:
:
SurfaceFormat
:
:
R8G8B8X8
;
}
RefPtr
<
gfx
:
:
DrawTarget
>
dt
=
gfx
:
:
Factory
:
:
CreateDrawTargetForData
(
gfx
:
:
BackendType
:
:
SKIA
static_cast
<
unsigned
char
*
>
(
mBuffer
.
bits
)
gfx
:
:
IntSize
(
mBuffer
.
width
mBuffer
.
height
)
mBuffer
.
stride
*
bpp
format
true
)
;
return
dt
.
forget
(
)
;
}
void
AndroidCompositorWidget
:
:
EndRemoteDrawingInRegion
(
gfx
:
:
DrawTarget
*
aDrawTarget
const
LayoutDeviceIntRegion
&
aInvalidRegion
)
{
ANativeWindow_unlockAndPost
(
mNativeWindow
)
;
}
bool
AndroidCompositorWidget
:
:
OnResumeComposition
(
)
{
OnCompositorSurfaceChanged
(
)
;
if
(
!
mSurface
)
{
gfxCriticalError
(
)
<
<
"
OnResumeComposition
called
with
null
Surface
"
;
return
false
;
}
JNIEnv
*
const
env
=
jni
:
:
GetEnvForThread
(
)
;
ANativeWindow
*
const
nativeWindow
=
ANativeWindow_fromSurface
(
env
reinterpret_cast
<
jobject
>
(
mSurface
.
Get
(
)
)
)
;
if
(
!
nativeWindow
)
{
gfxCriticalError
(
)
<
<
"
OnResumeComposition
called
with
invalid
Surface
"
;
return
false
;
}
const
int32_t
width
=
ANativeWindow_getWidth
(
nativeWindow
)
;
const
int32_t
height
=
ANativeWindow_getHeight
(
nativeWindow
)
;
mClientSize
=
LayoutDeviceIntSize
(
width
height
)
;
ANativeWindow_release
(
nativeWindow
)
;
return
true
;
}
EGLNativeWindowType
AndroidCompositorWidget
:
:
GetEGLNativeWindow
(
)
{
return
(
EGLNativeWindowType
)
mSurface
.
Get
(
)
;
}
LayoutDeviceIntSize
AndroidCompositorWidget
:
:
GetClientSize
(
)
{
return
mClientSize
;
}
}
}
