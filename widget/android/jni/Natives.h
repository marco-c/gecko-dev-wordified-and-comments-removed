#
ifndef
mozilla_jni_Natives_h__
#
define
mozilla_jni_Natives_h__
#
include
<
jni
.
h
>
#
include
"
mozilla
/
WeakPtr
.
h
"
#
include
"
mozilla
/
jni
/
Accessors
.
h
"
#
include
"
mozilla
/
jni
/
Refs
.
h
"
#
include
"
mozilla
/
jni
/
Types
.
h
"
#
include
"
mozilla
/
jni
/
Utils
.
h
"
namespace
mozilla
{
namespace
jni
{
template
<
class
Impl
>
Impl
*
GetNativePtr
(
JNIEnv
*
env
jobject
instance
)
{
const
auto
ptr
=
reinterpret_cast
<
const
WeakPtr
<
Impl
>
*
>
(
GetNativeHandle
(
env
instance
)
)
;
if
(
!
ptr
)
{
return
nullptr
;
}
Impl
*
const
impl
=
*
ptr
;
if
(
!
impl
)
{
ThrowException
(
env
"
java
/
lang
/
NullPointerException
"
"
Native
object
already
released
"
)
;
}
return
impl
;
}
template
<
class
Impl
class
LocalRef
>
Impl
*
GetNativePtr
(
const
LocalRef
&
instance
)
{
return
GetNativePtr
<
Impl
>
(
instance
.
Env
(
)
instance
.
Get
(
)
)
;
}
template
<
class
Impl
class
LocalRef
>
void
ClearNativePtr
(
const
LocalRef
&
instance
)
{
JNIEnv
*
const
env
=
instance
.
Env
(
)
;
const
auto
ptr
=
reinterpret_cast
<
WeakPtr
<
Impl
>
*
>
(
GetNativeHandle
(
env
instance
.
Get
(
)
)
)
;
if
(
ptr
)
{
SetNativeHandle
(
env
instance
.
Get
(
)
0
)
;
delete
ptr
;
}
else
{
MOZ_ASSERT
(
env
-
>
ExceptionCheck
(
)
)
;
env
-
>
ExceptionClear
(
)
;
}
}
template
<
class
Impl
class
LocalRef
>
void
SetNativePtr
(
const
LocalRef
&
instance
Impl
*
ptr
)
{
ClearNativePtr
<
Impl
>
(
instance
)
;
SetNativeHandle
(
instance
.
Env
(
)
instance
.
Get
(
)
reinterpret_cast
<
uintptr_t
>
(
new
WeakPtr
<
Impl
>
(
ptr
)
)
)
;
}
namespace
detail
{
template
<
bool
IsStatic
typename
ReturnType
class
Traits
class
Impl
class
Args
>
class
NativeStubImpl
;
template
<
typename
ReturnType
class
Traits
class
Impl
typename
.
.
.
Args
>
class
NativeStubImpl
<
false
ReturnType
Traits
Impl
jni
:
:
Args
<
Args
.
.
.
>
>
{
typedef
typename
Traits
:
:
Owner
Owner
;
typedef
typename
TypeAdapter
<
ReturnType
>
:
:
JNIType
ReturnJNIType
;
public
:
template
<
ReturnType
(
Impl
:
:
*
Method
)
(
Args
.
.
.
)
>
static
ReturnJNIType
Wrap
(
JNIEnv
*
env
jobject
instance
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
Impl
*
const
impl
=
GetNativePtr
<
Impl
>
(
env
instance
)
;
if
(
!
impl
)
{
return
ReturnJNIType
(
)
;
}
return
TypeAdapter
<
ReturnType
>
:
:
FromNative
(
env
(
impl
-
>
*
Method
)
(
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
)
;
}
template
<
ReturnType
(
Impl
:
:
*
Method
)
(
const
typename
Owner
:
:
LocalRef
&
Args
.
.
.
)
>
static
ReturnJNIType
Wrap
(
JNIEnv
*
env
jobject
instance
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
Impl
*
const
impl
=
GetNativePtr
<
Impl
>
(
env
instance
)
;
if
(
!
impl
)
{
return
ReturnJNIType
(
)
;
}
auto
self
=
Owner
:
:
LocalRef
:
:
Adopt
(
env
instance
)
;
const
auto
res
=
TypeAdapter
<
ReturnType
>
:
:
FromNative
(
env
(
impl
-
>
*
Method
)
(
self
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
)
;
self
.
Forget
(
)
;
return
res
;
}
}
;
template
<
class
Traits
class
Impl
typename
.
.
.
Args
>
class
NativeStubImpl
<
false
void
Traits
Impl
jni
:
:
Args
<
Args
.
.
.
>
>
{
typedef
typename
Traits
:
:
Owner
Owner
;
public
:
template
<
void
(
Impl
:
:
*
Method
)
(
Args
.
.
.
)
>
static
void
Wrap
(
JNIEnv
*
env
jobject
instance
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
Impl
*
const
impl
=
GetNativePtr
<
Impl
>
(
env
instance
)
;
if
(
!
impl
)
{
return
;
}
(
impl
-
>
*
Method
)
(
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
;
}
template
<
void
(
Impl
:
:
*
Method
)
(
const
typename
Owner
:
:
LocalRef
&
Args
.
.
.
)
>
static
void
Wrap
(
JNIEnv
*
env
jobject
instance
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
Impl
*
const
impl
=
GetNativePtr
<
Impl
>
(
env
instance
)
;
if
(
!
impl
)
{
return
;
}
auto
self
=
Owner
:
:
LocalRef
:
:
Adopt
(
env
instance
)
;
(
impl
-
>
*
Method
)
(
self
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
;
self
.
Forget
(
)
;
}
}
;
template
<
typename
ReturnType
class
Traits
class
Impl
typename
.
.
.
Args
>
class
NativeStubImpl
<
true
ReturnType
Traits
Impl
jni
:
:
Args
<
Args
.
.
.
>
>
{
typedef
typename
TypeAdapter
<
ReturnType
>
:
:
JNIType
ReturnJNIType
;
public
:
template
<
ReturnType
(
*
Method
)
(
Args
.
.
.
)
>
static
ReturnJNIType
Wrap
(
JNIEnv
*
env
jclass
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
return
TypeAdapter
<
ReturnType
>
:
:
FromNative
(
env
(
*
Method
)
(
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
)
;
}
template
<
ReturnType
(
*
Method
)
(
const
ClassObject
:
:
LocalRef
&
Args
.
.
.
)
>
static
ReturnJNIType
Wrap
(
JNIEnv
*
env
jclass
cls
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
auto
clazz
=
ClassObject
:
:
LocalRef
:
:
Adopt
(
env
cls
)
;
const
auto
res
=
TypeAdapter
<
ReturnType
>
:
:
FromNative
(
env
(
*
Method
)
(
clazz
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
)
;
clazz
.
Forget
(
)
;
return
res
;
}
}
;
template
<
class
Traits
class
Impl
typename
.
.
.
Args
>
class
NativeStubImpl
<
true
void
Traits
Impl
jni
:
:
Args
<
Args
.
.
.
>
>
{
public
:
template
<
void
(
*
Method
)
(
Args
.
.
.
)
>
static
void
Wrap
(
JNIEnv
*
env
jclass
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
(
*
Method
)
(
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
;
}
template
<
void
(
*
Method
)
(
const
ClassObject
:
:
LocalRef
&
Args
.
.
.
)
>
static
void
Wrap
(
JNIEnv
*
env
jclass
cls
typename
TypeAdapter
<
Args
>
:
:
JNIType
.
.
.
args
)
{
auto
clazz
=
ClassObject
:
:
LocalRef
:
:
Adopt
(
env
cls
)
;
(
*
Method
)
(
clazz
TypeAdapter
<
Args
>
:
:
ToNative
(
env
args
)
.
.
.
)
;
clazz
.
Forget
(
)
;
}
}
;
}
template
<
class
Traits
class
Impl
>
struct
NativeStub
:
detail
:
:
NativeStubImpl
<
Traits
:
:
isStatic
typename
Traits
:
:
ReturnType
Traits
Impl
typename
Traits
:
:
Args
>
{
}
;
template
<
class
Traits
typename
Ret
typename
.
.
.
Args
>
constexpr
JNINativeMethod
MakeNativeMethod
(
Ret
(
*
stub
)
(
JNIEnv
*
Args
.
.
.
)
)
{
return
{
Traits
:
:
name
Traits
:
:
signature
reinterpret_cast
<
void
*
>
(
stub
)
}
;
}
template
<
class
Cls
class
Impl
>
class
NativeImpl
{
typedef
typename
Cls
:
:
template
Natives
<
Impl
>
Natives
;
static
bool
sInited
;
public
:
static
void
Init
(
)
{
if
(
sInited
)
{
return
;
}
JNIEnv
*
const
env
=
GetJNIForThread
(
)
;
MOZ_ALWAYS_TRUE
(
!
env
-
>
RegisterNatives
(
Accessor
:
:
EnsureClassRef
<
Cls
>
(
env
)
Natives
:
:
methods
sizeof
(
Natives
:
:
methods
)
/
sizeof
(
Natives
:
:
methods
[
0
]
)
)
)
;
sInited
=
true
;
}
protected
:
static
Impl
*
GetNative
(
const
typename
Cls
:
:
LocalRef
&
instance
)
{
return
GetNativePtr
<
Impl
>
(
instance
)
;
}
NativeImpl
(
)
{
Init
(
)
;
}
void
AttachNative
(
const
typename
Cls
:
:
LocalRef
&
instance
)
{
SetNativePtr
<
>
(
instance
static_cast
<
Impl
*
>
(
this
)
)
;
}
void
DisposeNative
(
const
typename
Cls
:
:
LocalRef
&
instance
)
{
ClearNativePtr
<
Impl
>
(
instance
)
;
}
}
;
template
<
class
C
class
I
>
bool
NativeImpl
<
C
I
>
:
:
sInited
;
}
}
#
endif
