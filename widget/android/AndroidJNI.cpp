#
include
"
mozilla
/
Hal
.
h
"
#
include
"
nsIFile
.
h
"
#
include
"
nsString
.
h
"
#
include
"
AndroidBridge
.
h
"
#
include
"
AndroidContentController
.
h
"
#
include
"
AndroidGraphicBuffer
.
h
"
#
include
<
jni
.
h
>
#
include
<
pthread
.
h
>
#
include
<
dlfcn
.
h
>
#
include
<
stdio
.
h
>
#
include
<
unistd
.
h
>
#
include
"
nsAppShell
.
h
"
#
include
"
nsWindow
.
h
"
#
include
<
android
/
log
.
h
>
#
include
"
nsIObserverService
.
h
"
#
include
"
mozilla
/
Services
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
ifdef
MOZ_CRASHREPORTER
#
include
"
nsICrashReporter
.
h
"
#
include
"
nsExceptionHandler
.
h
"
#
endif
#
include
"
mozilla
/
unused
.
h
"
#
include
"
mozilla
/
MathAlgorithms
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
layers
/
APZCTreeManager
.
h
"
#
include
"
nsPluginInstanceOwner
.
h
"
#
include
"
AndroidSurfaceTexture
.
h
"
using
namespace
mozilla
;
using
namespace
mozilla
:
:
dom
;
using
namespace
mozilla
:
:
layers
;
using
namespace
mozilla
:
:
widget
;
extern
"
C
"
{
NS_EXPORT
void
JNICALL
Java_org_mozilla_gecko_GeckoAppShell_reportJavaCrash
(
JNIEnv
*
jenv
jclass
jstring
jStackTrace
)
{
#
ifdef
MOZ_CRASHREPORTER
const
nsJNICString
stackTrace
(
jStackTrace
jenv
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
CrashReporter
:
:
AnnotateCrashReport
(
NS_LITERAL_CSTRING
(
"
JavaStackTrace
"
)
stackTrace
)
)
)
)
{
return
;
}
#
endif
MOZ_CRASH
(
"
Uncaught
Java
exception
"
)
;
}
NS_EXPORT
void
JNICALL
Java_org_mozilla_gecko_GeckoAppShell_invalidateAndScheduleComposite
(
JNIEnv
*
jclass
)
{
nsWindow
:
:
InvalidateAndScheduleComposite
(
)
;
}
NS_EXPORT
void
JNICALL
Java_org_mozilla_gecko_GeckoAppShell_addPresentationSurface
(
JNIEnv
*
jenv
jclass
jobject
surface
)
{
if
(
surface
!
=
NULL
)
{
void
*
window
=
AndroidBridge
:
:
Bridge
(
)
-
>
AcquireNativeWindow
(
jenv
surface
)
;
if
(
window
)
{
AndroidBridge
:
:
Bridge
(
)
-
>
SetPresentationWindow
(
window
)
;
}
}
}
NS_EXPORT
void
JNICALL
Java_org_mozilla_gecko_GeckoAppShell_removePresentationSurface
(
JNIEnv
*
jenv
jclass
jobject
surface
)
{
void
*
window
=
AndroidBridge
:
:
Bridge
(
)
-
>
GetPresentationWindow
(
)
;
if
(
window
)
{
AndroidBridge
:
:
Bridge
(
)
-
>
SetPresentationWindow
(
nullptr
)
;
AndroidBridge
:
:
Bridge
(
)
-
>
ReleaseNativeWindow
(
window
)
;
}
}
NS_EXPORT
void
JNICALL
Java_org_mozilla_gecko_GeckoAppShell_onSurfaceTextureFrameAvailable
(
JNIEnv
*
jenv
jclass
jobject
surfaceTexture
jint
id
)
{
mozilla
:
:
gl
:
:
AndroidSurfaceTexture
*
st
=
mozilla
:
:
gl
:
:
AndroidSurfaceTexture
:
:
Find
(
id
)
;
if
(
!
st
)
{
__android_log_print
(
ANDROID_LOG_ERROR
"
GeckoJNI
"
"
Failed
to
find
AndroidSurfaceTexture
with
id
%
d
"
id
)
;
return
;
}
st
-
>
NotifyFrameAvailable
(
)
;
}
}
