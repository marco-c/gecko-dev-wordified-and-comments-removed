#
include
"
ANRReporter
.
h
"
#
include
"
GeckoProfiler
.
h
"
#
include
<
unistd
.
h
>
namespace
mozilla
{
bool
ANRReporter
:
:
RequestNativeStack
(
bool
aUnwind
)
{
#
ifdef
MOZ_GECKO_PROFILER
if
(
profiler_is_active
(
)
)
{
return
false
;
}
uint32_t
features
=
ProfilerFeature
:
:
Leaf
|
ProfilerFeature
:
:
Privacy
|
(
aUnwind
?
ProfilerFeature
:
:
StackWalk
:
0
)
|
ProfilerFeature
:
:
Threads
;
const
char
*
NATIVE_STACK_THREADS
[
]
=
{
"
GeckoMain
"
"
Compositor
"
}
;
profiler_start
(
100
10000
features
NATIVE_STACK_THREADS
sizeof
(
NATIVE_STACK_THREADS
)
/
sizeof
(
char
*
)
)
;
#
endif
return
true
;
}
jni
:
:
String
:
:
LocalRef
ANRReporter
:
:
GetNativeStack
(
)
{
#
ifdef
MOZ_GECKO_PROFILER
const
PRIntervalTime
timeout
=
PR_SecondsToInterval
(
5
)
;
const
PRIntervalTime
startTime
=
PR_IntervalNow
(
)
;
typedef
mozilla
:
:
UniquePtr
<
char
[
]
>
ProfilePtr
;
ProfilePtr
profile
(
profiler_get_profile
(
)
)
;
if
(
!
profile
)
{
return
nullptr
;
}
while
(
profile
&
&
!
strstr
(
profile
.
get
(
)
"
\
"
samples
\
"
:
[
{
"
)
)
{
if
(
PR_IntervalNow
(
)
-
startTime
>
=
timeout
)
{
return
nullptr
;
}
usleep
(
100000ul
)
;
profile
=
ProfilePtr
(
profiler_get_profile
(
)
)
;
}
if
(
profile
)
{
return
jni
:
:
String
:
:
Param
(
profile
.
get
(
)
)
;
}
#
endif
return
nullptr
;
}
void
ANRReporter
:
:
ReleaseNativeStack
(
)
{
#
ifdef
MOZ_GECKO_PROFILER
if
(
!
profiler_is_active
(
)
)
{
return
;
}
profiler_stop
(
)
;
#
endif
}
}
