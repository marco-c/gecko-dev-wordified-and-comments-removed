#
ifndef
nsAppShell_h__
#
define
nsAppShell_h__
#
include
"
mozilla
/
HangMonitor
.
h
"
#
include
"
mozilla
/
LinkedList
.
h
"
#
include
"
mozilla
/
Monitor
.
h
"
#
include
"
mozilla
/
Move
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
mozilla
/
unused
.
h
"
#
include
"
nsBaseAppShell
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsInterfaceHashtable
.
h
"
#
include
"
nsIAndroidBridge
.
h
"
namespace
mozilla
{
class
AndroidGeckoEvent
;
bool
ProcessNextEvent
(
)
;
void
NotifyEvent
(
)
;
}
class
nsWindow
;
class
nsAppShell
:
public
nsBaseAppShell
{
public
:
struct
Event
:
mozilla
:
:
LinkedListElement
<
Event
>
{
bool
HasSameTypeAs
(
const
Event
*
other
)
const
{
return
*
reinterpret_cast
<
const
uintptr_t
*
>
(
this
)
=
=
*
reinterpret_cast
<
const
uintptr_t
*
>
(
other
)
;
}
virtual
~
Event
(
)
{
}
virtual
void
Run
(
)
=
0
;
virtual
void
PostTo
(
mozilla
:
:
LinkedList
<
Event
>
&
queue
)
{
queue
.
insertBack
(
this
)
;
}
virtual
mozilla
:
:
HangMonitor
:
:
ActivityType
ActivityType
(
)
const
{
return
mozilla
:
:
HangMonitor
:
:
kGeneralActivity
;
}
}
;
class
LegacyGeckoEvent
;
template
<
typename
T
>
class
LambdaEvent
:
public
Event
{
protected
:
T
lambda
;
public
:
LambdaEvent
(
T
&
&
l
)
:
lambda
(
mozilla
:
:
Move
(
l
)
)
{
}
void
Run
(
)
override
{
return
lambda
(
)
;
}
}
;
static
nsAppShell
*
gAppShell
;
nsAppShell
(
)
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_NSIOBSERVER
nsresult
Init
(
)
;
void
NotifyNativeEvent
(
)
;
bool
ProcessNextNativeEvent
(
bool
mayWait
)
override
;
template
<
typename
T
typename
D
>
void
PostEvent
(
mozilla
:
:
UniquePtr
<
T
D
>
&
&
event
)
{
mEventQueue
.
Post
(
mozilla
:
:
Move
(
event
)
)
;
}
template
<
typename
T
>
void
PostEvent
(
T
&
&
lambda
)
{
mEventQueue
.
Post
(
mozilla
:
:
MakeUnique
<
LambdaEvent
<
T
>
>
(
mozilla
:
:
Move
(
lambda
)
)
)
;
}
void
PostEvent
(
mozilla
:
:
AndroidGeckoEvent
*
event
)
;
void
ResendLastResizeEvent
(
nsWindow
*
aDest
)
;
void
OnResume
(
)
{
}
void
SetBrowserApp
(
nsIAndroidBrowserApp
*
aBrowserApp
)
{
mBrowserApp
=
aBrowserApp
;
}
void
GetBrowserApp
(
nsIAndroidBrowserApp
*
*
aBrowserApp
)
{
*
aBrowserApp
=
mBrowserApp
;
}
protected
:
virtual
~
nsAppShell
(
)
;
nsresult
AddObserver
(
const
nsAString
&
aObserverKey
nsIObserver
*
aObserver
)
;
void
ScheduleNativeEventCallback
(
)
override
{
PostEvent
(
[
this
]
{
NativeEventCallback
(
)
;
}
)
;
}
class
Queue
{
public
:
mozilla
:
:
Monitor
mMonitor
;
private
:
mozilla
:
:
LinkedList
<
Event
>
mQueue
;
public
:
Queue
(
)
:
mMonitor
(
"
nsAppShell
.
Queue
"
)
{
}
void
Signal
(
)
{
mozilla
:
:
MonitorAutoLock
lock
(
mMonitor
)
;
lock
.
NotifyAll
(
)
;
}
void
Post
(
mozilla
:
:
UniquePtr
<
Event
>
&
&
event
)
{
MOZ_ASSERT
(
event
&
&
!
event
-
>
isInList
(
)
)
;
mozilla
:
:
MonitorAutoLock
lock
(
mMonitor
)
;
event
-
>
PostTo
(
mQueue
)
;
if
(
event
-
>
isInList
(
)
)
{
mozilla
:
:
unused
<
<
event
.
release
(
)
;
}
lock
.
NotifyAll
(
)
;
}
mozilla
:
:
UniquePtr
<
Event
>
Pop
(
bool
mayWait
)
{
mozilla
:
:
MonitorAutoLock
lock
(
mMonitor
)
;
if
(
mayWait
&
&
mQueue
.
isEmpty
(
)
)
{
lock
.
Wait
(
)
;
}
return
mozilla
:
:
UniquePtr
<
Event
>
(
mQueue
.
popFirst
(
)
)
;
}
}
mEventQueue
;
Event
*
mQueuedViewportEvent
;
bool
mAllowCoalescingTouches
;
nsCOMPtr
<
nsIAndroidBrowserApp
>
mBrowserApp
;
nsInterfaceHashtable
<
nsStringHashKey
nsIObserver
>
mObserversHash
;
}
;
#
endif
