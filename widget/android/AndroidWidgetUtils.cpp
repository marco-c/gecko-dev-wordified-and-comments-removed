#
include
"
AndroidWidgetUtils
.
h
"
#
include
"
mozilla
/
gfx
/
2D
.
h
"
#
include
"
mozilla
/
gfx
/
Swizzle
.
h
"
using
namespace
mozilla
:
:
gfx
;
namespace
mozilla
:
:
widget
{
already_AddRefed
<
DataSourceSurface
>
AndroidWidgetUtils
:
:
GetDataSourceSurfaceForAndroidBitmap
(
gfx
:
:
SourceSurface
*
aSurface
const
LayoutDeviceIntRect
*
aRect
uint32_t
aStride
)
{
RefPtr
<
DataSourceSurface
>
srcDataSurface
=
aSurface
-
>
GetDataSurface
(
)
;
if
(
NS_WARN_IF
(
!
srcDataSurface
)
)
{
return
nullptr
;
}
DataSourceSurface
:
:
ScopedMap
sourceMap
(
srcDataSurface
DataSourceSurface
:
:
READ
)
;
RefPtr
<
DataSourceSurface
>
destDataSurface
=
gfx
:
:
Factory
:
:
CreateDataSourceSurfaceWithStride
(
aRect
?
IntSize
(
aRect
-
>
width
aRect
-
>
height
)
:
srcDataSurface
-
>
GetSize
(
)
SurfaceFormat
:
:
R8G8B8A8
aStride
?
aStride
:
sourceMap
.
GetStride
(
)
)
;
if
(
NS_WARN_IF
(
!
destDataSurface
)
)
{
return
nullptr
;
}
DataSourceSurface
:
:
ScopedMap
destMap
(
destDataSurface
DataSourceSurface
:
:
READ_WRITE
)
;
SwizzleData
(
sourceMap
.
GetData
(
)
sourceMap
.
GetStride
(
)
aSurface
-
>
GetFormat
(
)
destMap
.
GetData
(
)
destMap
.
GetStride
(
)
SurfaceFormat
:
:
R8G8B8A8
destDataSurface
-
>
GetSize
(
)
)
;
return
destDataSurface
.
forget
(
)
;
}
}
