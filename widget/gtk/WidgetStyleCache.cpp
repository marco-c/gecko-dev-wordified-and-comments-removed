#
include
<
dlfcn
.
h
>
#
include
<
gtk
/
gtk
.
h
>
#
include
"
WidgetStyleCache
.
h
"
#
include
"
gtkdrawing
.
h
"
#
include
"
mozilla
/
Assertions
.
h
"
#
include
"
mozilla
/
PodOperations
.
h
"
#
include
"
mozilla
/
ScopeExit
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsDebug
.
h
"
static
GtkWidget
*
sWidgetStorage
[
MOZ_GTK_WIDGET_NODE_COUNT
]
;
static
GtkStyleContext
*
sStyleStorage
[
MOZ_GTK_WIDGET_NODE_COUNT
]
;
static
GtkStyleContext
*
GetWidgetRootStyle
(
WidgetNodeType
aNodeType
)
;
static
GtkStyleContext
*
GetCssNodeStyleInternal
(
WidgetNodeType
aNodeType
)
;
static
GtkWidget
*
CreateWindowContainerWidget
(
)
{
GtkWidget
*
widget
=
gtk_fixed_new
(
)
;
gtk_container_add
(
GTK_CONTAINER
(
GetWidget
(
MOZ_GTK_WINDOW
)
)
widget
)
;
return
widget
;
}
static
void
AddToWindowContainer
(
GtkWidget
*
widget
)
{
gtk_container_add
(
GTK_CONTAINER
(
GetWidget
(
MOZ_GTK_WINDOW_CONTAINER
)
)
widget
)
;
}
static
GtkWidget
*
CreateScrollbarWidget
(
WidgetNodeType
aAppearance
GtkOrientation
aOrientation
)
{
GtkWidget
*
widget
=
gtk_scrollbar_new
(
aOrientation
nullptr
)
;
AddToWindowContainer
(
widget
)
;
return
widget
;
}
static
GtkWidget
*
CreateMenuPopupWidget
(
)
{
GtkWidget
*
widget
=
gtk_menu_new
(
)
;
GtkStyleContext
*
style
=
gtk_widget_get_style_context
(
widget
)
;
gtk_style_context_add_class
(
style
GTK_STYLE_CLASS_POPUP
)
;
gtk_menu_attach_to_widget
(
GTK_MENU
(
widget
)
GetWidget
(
MOZ_GTK_WINDOW
)
nullptr
)
;
return
widget
;
}
static
GtkWidget
*
CreateMenuBarWidget
(
)
{
GtkWidget
*
widget
=
gtk_menu_bar_new
(
)
;
AddToWindowContainer
(
widget
)
;
return
widget
;
}
static
GtkWidget
*
CreateFrameWidget
(
)
{
GtkWidget
*
widget
=
gtk_frame_new
(
nullptr
)
;
AddToWindowContainer
(
widget
)
;
return
widget
;
}
static
GtkWidget
*
CreateButtonWidget
(
)
{
GtkWidget
*
widget
=
gtk_button_new_with_label
(
"
M
"
)
;
AddToWindowContainer
(
widget
)
;
return
widget
;
}
static
GtkWidget
*
CreateScrolledWindowWidget
(
)
{
GtkWidget
*
widget
=
gtk_scrolled_window_new
(
nullptr
nullptr
)
;
AddToWindowContainer
(
widget
)
;
return
widget
;
}
static
GtkWidget
*
CreateTreeViewWidget
(
)
{
GtkWidget
*
widget
=
gtk_tree_view_new
(
)
;
AddToWindowContainer
(
widget
)
;
return
widget
;
}
static
GtkWidget
*
CreateTreeHeaderCellWidget
(
)
{
GtkTreeViewColumn
*
firstTreeViewColumn
;
GtkTreeViewColumn
*
middleTreeViewColumn
;
GtkTreeViewColumn
*
lastTreeViewColumn
;
GtkWidget
*
treeView
=
GetWidget
(
MOZ_GTK_TREEVIEW
)
;
firstTreeViewColumn
=
gtk_tree_view_column_new
(
)
;
gtk_tree_view_column_set_title
(
firstTreeViewColumn
"
M
"
)
;
gtk_tree_view_append_column
(
GTK_TREE_VIEW
(
treeView
)
firstTreeViewColumn
)
;
middleTreeViewColumn
=
gtk_tree_view_column_new
(
)
;
gtk_tree_view_column_set_title
(
middleTreeViewColumn
"
M
"
)
;
gtk_tree_view_append_column
(
GTK_TREE_VIEW
(
treeView
)
middleTreeViewColumn
)
;
lastTreeViewColumn
=
gtk_tree_view_column_new
(
)
;
gtk_tree_view_column_set_title
(
lastTreeViewColumn
"
M
"
)
;
gtk_tree_view_append_column
(
GTK_TREE_VIEW
(
treeView
)
lastTreeViewColumn
)
;
return
gtk_tree_view_column_get_button
(
middleTreeViewColumn
)
;
}
static
void
CreateWindowAndHeaderBar
(
)
{
GtkWidget
*
window
=
gtk_window_new
(
GTK_WINDOW_TOPLEVEL
)
;
gtk_widget_set_name
(
window
"
MozillaGtkWidget
"
)
;
GtkStyleContext
*
windowStyle
=
gtk_widget_get_style_context
(
window
)
;
gtk_style_context_add_class
(
windowStyle
"
csd
"
)
;
GtkWidget
*
fixed
=
gtk_fixed_new
(
)
;
GtkStyleContext
*
fixedStyle
=
gtk_widget_get_style_context
(
fixed
)
;
gtk_style_context_add_class
(
fixedStyle
"
titlebar
"
)
;
GtkWidget
*
headerBar
=
gtk_header_bar_new
(
)
;
g_object_set
(
headerBar
"
title
"
"
Title
"
"
has
-
subtitle
"
FALSE
"
show
-
close
-
button
"
TRUE
NULL
)
;
GtkStyleContext
*
headerBarStyle
=
gtk_widget_get_style_context
(
headerBar
)
;
gtk_style_context_add_class
(
headerBarStyle
GTK_STYLE_CLASS_TITLEBAR
)
;
gtk_style_context_add_class
(
headerBarStyle
"
default
-
decoration
"
)
;
MOZ_ASSERT
(
!
sWidgetStorage
[
MOZ_GTK_HEADER_BAR
]
"
Headerbar
widget
is
already
created
!
"
)
;
MOZ_ASSERT
(
!
sWidgetStorage
[
MOZ_GTK_WINDOW
]
"
Window
widget
is
already
created
!
"
)
;
MOZ_ASSERT
(
!
sWidgetStorage
[
MOZ_GTK_HEADERBAR_FIXED
]
"
Fixed
widget
is
already
created
!
"
)
;
sWidgetStorage
[
MOZ_GTK_HEADER_BAR
]
=
headerBar
;
sWidgetStorage
[
MOZ_GTK_WINDOW
]
=
window
;
sWidgetStorage
[
MOZ_GTK_HEADERBAR_FIXED
]
=
fixed
;
gtk_container_add
(
GTK_CONTAINER
(
fixed
)
headerBar
)
;
gtk_window_set_titlebar
(
GTK_WINDOW
(
window
)
fixed
)
;
gtk_widget_show_all
(
headerBar
)
;
}
static
GtkWidget
*
CreateWidget
(
WidgetNodeType
aAppearance
)
{
switch
(
aAppearance
)
{
case
MOZ_GTK_WINDOW
:
case
MOZ_GTK_HEADERBAR_FIXED
:
case
MOZ_GTK_HEADER_BAR
:
CreateWindowAndHeaderBar
(
)
;
return
sWidgetStorage
[
aAppearance
]
;
case
MOZ_GTK_WINDOW_CONTAINER
:
return
CreateWindowContainerWidget
(
)
;
case
MOZ_GTK_SCROLLBAR_VERTICAL
:
return
CreateScrollbarWidget
(
aAppearance
GTK_ORIENTATION_VERTICAL
)
;
case
MOZ_GTK_MENUPOPUP
:
return
CreateMenuPopupWidget
(
)
;
case
MOZ_GTK_MENUBAR
:
return
CreateMenuBarWidget
(
)
;
case
MOZ_GTK_FRAME
:
return
CreateFrameWidget
(
)
;
case
MOZ_GTK_BUTTON
:
return
CreateButtonWidget
(
)
;
case
MOZ_GTK_SCROLLED_WINDOW
:
return
CreateScrolledWindowWidget
(
)
;
case
MOZ_GTK_TREEVIEW
:
return
CreateTreeViewWidget
(
)
;
case
MOZ_GTK_TREE_HEADER_CELL
:
return
CreateTreeHeaderCellWidget
(
)
;
default
:
return
nullptr
;
}
}
GtkWidget
*
GetWidget
(
WidgetNodeType
aAppearance
)
{
GtkWidget
*
widget
=
sWidgetStorage
[
aAppearance
]
;
if
(
!
widget
)
{
widget
=
CreateWidget
(
aAppearance
)
;
if
(
!
widget
)
{
return
nullptr
;
}
sWidgetStorage
[
aAppearance
]
=
widget
;
}
return
widget
;
}
static
void
AddStyleClassesFromStyle
(
GtkStyleContext
*
aDest
GtkStyleContext
*
aSrc
)
{
GList
*
classes
=
gtk_style_context_list_classes
(
aSrc
)
;
for
(
GList
*
link
=
classes
;
link
;
link
=
link
-
>
next
)
{
gtk_style_context_add_class
(
aDest
static_cast
<
gchar
*
>
(
link
-
>
data
)
)
;
}
g_list_free
(
classes
)
;
}
GtkStyleContext
*
CreateStyleForWidget
(
GtkWidget
*
aWidget
GtkStyleContext
*
aParentStyle
)
{
static
auto
sGtkWidgetClassGetCSSName
=
reinterpret_cast
<
const
char
*
(
*
)
(
GtkWidgetClass
*
)
>
(
dlsym
(
RTLD_DEFAULT
"
gtk_widget_class_get_css_name
"
)
)
;
GtkWidgetClass
*
widgetClass
=
GTK_WIDGET_GET_CLASS
(
aWidget
)
;
const
gchar
*
name
=
sGtkWidgetClassGetCSSName
?
sGtkWidgetClassGetCSSName
(
widgetClass
)
:
nullptr
;
GtkStyleContext
*
context
=
CreateCSSNode
(
name
aParentStyle
G_TYPE_FROM_CLASS
(
widgetClass
)
)
;
GtkStyleContext
*
widgetStyle
=
gtk_widget_get_style_context
(
aWidget
)
;
AddStyleClassesFromStyle
(
context
widgetStyle
)
;
g_object_ref_sink
(
aWidget
)
;
g_object_unref
(
aWidget
)
;
return
context
;
}
static
GtkStyleContext
*
CreateStyleForWidget
(
GtkWidget
*
aWidget
WidgetNodeType
aParentType
)
{
return
CreateStyleForWidget
(
aWidget
GetWidgetRootStyle
(
aParentType
)
)
;
}
GtkStyleContext
*
CreateCSSNode
(
const
char
*
aName
GtkStyleContext
*
aParentStyle
GType
aType
)
{
static
auto
sGtkWidgetPathIterSetObjectName
=
reinterpret_cast
<
void
(
*
)
(
GtkWidgetPath
*
gint
const
char
*
)
>
(
dlsym
(
RTLD_DEFAULT
"
gtk_widget_path_iter_set_object_name
"
)
)
;
GtkWidgetPath
*
path
;
if
(
aParentStyle
)
{
path
=
gtk_widget_path_copy
(
gtk_style_context_get_path
(
aParentStyle
)
)
;
GList
*
classes
=
gtk_style_context_list_classes
(
aParentStyle
)
;
for
(
GList
*
link
=
classes
;
link
;
link
=
link
-
>
next
)
{
gtk_widget_path_iter_add_class
(
path
-
1
static_cast
<
gchar
*
>
(
link
-
>
data
)
)
;
}
g_list_free
(
classes
)
;
}
else
{
path
=
gtk_widget_path_new
(
)
;
}
gtk_widget_path_append_type
(
path
aType
)
;
if
(
sGtkWidgetPathIterSetObjectName
)
{
(
*
sGtkWidgetPathIterSetObjectName
)
(
path
-
1
aName
)
;
}
GtkStyleContext
*
context
=
gtk_style_context_new
(
)
;
gtk_style_context_set_path
(
context
path
)
;
gtk_style_context_set_parent
(
context
aParentStyle
)
;
gtk_widget_path_unref
(
path
)
;
return
context
;
}
static
GtkStyleContext
*
GetWidgetRootStyle
(
WidgetNodeType
aNodeType
)
{
GtkStyleContext
*
style
=
sStyleStorage
[
aNodeType
]
;
if
(
style
)
return
style
;
switch
(
aNodeType
)
{
case
MOZ_GTK_MENUITEM
:
style
=
CreateStyleForWidget
(
gtk_menu_item_new
(
)
MOZ_GTK_MENUPOPUP
)
;
break
;
case
MOZ_GTK_MENUBARITEM
:
style
=
CreateStyleForWidget
(
gtk_menu_item_new
(
)
MOZ_GTK_MENUBAR
)
;
break
;
case
MOZ_GTK_TEXT_VIEW
:
style
=
CreateStyleForWidget
(
gtk_text_view_new
(
)
MOZ_GTK_SCROLLED_WINDOW
)
;
break
;
case
MOZ_GTK_TOOLTIP
:
if
(
gtk_check_version
(
3
20
0
)
!
=
nullptr
)
{
GtkWidget
*
tooltipWindow
=
gtk_window_new
(
GTK_WINDOW_POPUP
)
;
GtkStyleContext
*
style
=
gtk_widget_get_style_context
(
tooltipWindow
)
;
gtk_style_context_add_class
(
style
GTK_STYLE_CLASS_TOOLTIP
)
;
style
=
CreateStyleForWidget
(
tooltipWindow
nullptr
)
;
gtk_widget_destroy
(
tooltipWindow
)
;
}
else
{
style
=
CreateCSSNode
(
"
tooltip
"
nullptr
GTK_TYPE_TOOLTIP
)
;
gtk_style_context_add_class
(
style
GTK_STYLE_CLASS_BACKGROUND
)
;
}
break
;
case
MOZ_GTK_TOOLTIP_BOX
:
style
=
CreateStyleForWidget
(
gtk_box_new
(
GTK_ORIENTATION_HORIZONTAL
0
)
MOZ_GTK_TOOLTIP
)
;
break
;
case
MOZ_GTK_TOOLTIP_BOX_LABEL
:
style
=
CreateStyleForWidget
(
gtk_label_new
(
nullptr
)
MOZ_GTK_TOOLTIP_BOX
)
;
break
;
default
:
GtkWidget
*
widget
=
GetWidget
(
aNodeType
)
;
MOZ_ASSERT
(
widget
)
;
return
gtk_widget_get_style_context
(
widget
)
;
}
MOZ_ASSERT
(
style
)
;
sStyleStorage
[
aNodeType
]
=
style
;
return
style
;
}
static
GtkStyleContext
*
CreateChildCSSNode
(
const
char
*
aName
WidgetNodeType
aParentNodeType
)
{
return
CreateCSSNode
(
aName
GetCssNodeStyleInternal
(
aParentNodeType
)
)
;
}
static
GtkStyleContext
*
CreateSubStyleWithClass
(
WidgetNodeType
aAppearance
const
gchar
*
aStyleClass
)
{
static
auto
sGtkWidgetPathIterGetObjectName
=
reinterpret_cast
<
const
char
*
(
*
)
(
const
GtkWidgetPath
*
gint
)
>
(
dlsym
(
RTLD_DEFAULT
"
gtk_widget_path_iter_get_object_name
"
)
)
;
GtkStyleContext
*
parentStyle
=
GetWidgetRootStyle
(
aAppearance
)
;
const
GtkWidgetPath
*
parentPath
=
gtk_style_context_get_path
(
parentStyle
)
;
const
gchar
*
name
=
sGtkWidgetPathIterGetObjectName
?
sGtkWidgetPathIterGetObjectName
(
parentPath
-
1
)
:
nullptr
;
GType
objectType
=
gtk_widget_path_get_object_type
(
parentPath
)
;
GtkStyleContext
*
style
=
CreateCSSNode
(
name
parentStyle
objectType
)
;
AddStyleClassesFromStyle
(
style
parentStyle
)
;
gtk_style_context_add_class
(
style
aStyleClass
)
;
return
style
;
}
static
GtkStyleContext
*
GetCssNodeStyleInternal
(
WidgetNodeType
aNodeType
)
{
GtkStyleContext
*
style
=
sStyleStorage
[
aNodeType
]
;
if
(
style
)
return
style
;
switch
(
aNodeType
)
{
case
MOZ_GTK_SCROLLBAR_CONTENTS_VERTICAL
:
style
=
CreateChildCSSNode
(
"
contents
"
MOZ_GTK_SCROLLBAR_VERTICAL
)
;
break
;
case
MOZ_GTK_SCROLLBAR_TROUGH_VERTICAL
:
style
=
CreateChildCSSNode
(
GTK_STYLE_CLASS_TROUGH
MOZ_GTK_SCROLLBAR_CONTENTS_VERTICAL
)
;
break
;
case
MOZ_GTK_SCROLLBAR_THUMB_VERTICAL
:
style
=
CreateChildCSSNode
(
GTK_STYLE_CLASS_SLIDER
MOZ_GTK_SCROLLBAR_TROUGH_VERTICAL
)
;
break
;
case
MOZ_GTK_SCROLLED_WINDOW
:
style
=
CreateSubStyleWithClass
(
MOZ_GTK_SCROLLED_WINDOW
GTK_STYLE_CLASS_FRAME
)
;
break
;
case
MOZ_GTK_TEXT_VIEW_TEXT_SELECTION
:
style
=
CreateChildCSSNode
(
"
selection
"
MOZ_GTK_TEXT_VIEW_TEXT
)
;
break
;
case
MOZ_GTK_TEXT_VIEW_TEXT
:
style
=
CreateChildCSSNode
(
"
text
"
MOZ_GTK_TEXT_VIEW
)
;
break
;
case
MOZ_GTK_FRAME_BORDER
:
style
=
CreateChildCSSNode
(
"
border
"
MOZ_GTK_FRAME
)
;
break
;
case
MOZ_GTK_WINDOW_DECORATION
:
{
GtkStyleContext
*
parentStyle
=
CreateSubStyleWithClass
(
MOZ_GTK_WINDOW
"
csd
"
)
;
style
=
CreateCSSNode
(
"
decoration
"
parentStyle
)
;
g_object_unref
(
parentStyle
)
;
break
;
}
default
:
return
GetWidgetRootStyle
(
aNodeType
)
;
}
MOZ_ASSERT
(
style
"
missing
style
context
for
node
type
"
)
;
sStyleStorage
[
aNodeType
]
=
style
;
return
style
;
}
static
GtkStyleContext
*
GetWidgetStyleInternal
(
WidgetNodeType
aNodeType
)
{
GtkStyleContext
*
style
=
sStyleStorage
[
aNodeType
]
;
if
(
style
)
return
style
;
switch
(
aNodeType
)
{
case
MOZ_GTK_SCROLLBAR_TROUGH_VERTICAL
:
style
=
CreateSubStyleWithClass
(
MOZ_GTK_SCROLLBAR_VERTICAL
GTK_STYLE_CLASS_TROUGH
)
;
break
;
case
MOZ_GTK_SCROLLBAR_THUMB_VERTICAL
:
style
=
CreateSubStyleWithClass
(
MOZ_GTK_SCROLLBAR_VERTICAL
GTK_STYLE_CLASS_SLIDER
)
;
break
;
case
MOZ_GTK_SCROLLED_WINDOW
:
style
=
CreateSubStyleWithClass
(
MOZ_GTK_SCROLLED_WINDOW
GTK_STYLE_CLASS_FRAME
)
;
break
;
case
MOZ_GTK_TEXT_VIEW_TEXT
:
style
=
CreateSubStyleWithClass
(
MOZ_GTK_TEXT_VIEW
GTK_STYLE_CLASS_VIEW
)
;
break
;
case
MOZ_GTK_FRAME_BORDER
:
return
GetWidgetRootStyle
(
MOZ_GTK_FRAME
)
;
default
:
return
GetWidgetRootStyle
(
aNodeType
)
;
}
MOZ_ASSERT
(
style
)
;
sStyleStorage
[
aNodeType
]
=
style
;
return
style
;
}
void
ResetWidgetCache
(
)
{
for
(
auto
*
style
:
sStyleStorage
)
{
if
(
style
)
{
g_object_unref
(
style
)
;
}
}
mozilla
:
:
PodArrayZero
(
sStyleStorage
)
;
if
(
sWidgetStorage
[
MOZ_GTK_WINDOW
]
)
{
gtk_widget_destroy
(
sWidgetStorage
[
MOZ_GTK_WINDOW
]
)
;
}
mozilla
:
:
PodArrayZero
(
sWidgetStorage
)
;
}
static
void
StyleContextSetScale
(
GtkStyleContext
*
style
gint
aScaleFactor
)
{
static
auto
sGtkStyleContextSetScalePtr
=
(
void
(
*
)
(
GtkStyleContext
*
gint
)
)
dlsym
(
RTLD_DEFAULT
"
gtk_style_context_set_scale
"
)
;
if
(
sGtkStyleContextSetScalePtr
&
&
style
)
{
sGtkStyleContextSetScalePtr
(
style
aScaleFactor
)
;
}
}
GtkStyleContext
*
GetStyleContext
(
WidgetNodeType
aNodeType
int
aScale
GtkStateFlags
aState
)
{
GtkStyleContext
*
style
;
if
(
gtk_check_version
(
3
20
0
)
!
=
nullptr
)
{
style
=
GetWidgetStyleInternal
(
aNodeType
)
;
}
else
{
style
=
GetCssNodeStyleInternal
(
aNodeType
)
;
StyleContextSetScale
(
style
aScale
)
;
}
if
(
gtk_style_context_get_state
(
style
)
!
=
aState
)
{
gtk_style_context_set_state
(
style
aState
)
;
}
return
style
;
}
