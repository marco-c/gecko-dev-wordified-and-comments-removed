#
include
<
gtk
/
gtk
.
h
>
#
include
"
nsUserIdleServiceGTK
.
h
"
#
include
"
nsDebug
.
h
"
#
include
"
prlink
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
WidgetUtilsGtk
.
h
"
#
ifdef
MOZ_X11
#
include
<
X11
/
Xlib
.
h
>
#
include
<
X11
/
Xutil
.
h
>
#
include
<
gdk
/
gdkx
.
h
>
#
endif
using
mozilla
:
:
LogLevel
;
static
mozilla
:
:
LazyLogModule
sIdleLog
(
"
nsIUserIdleService
"
)
;
#
ifdef
MOZ_X11
typedef
struct
{
Window
window
;
int
state
;
int
kind
;
unsigned
long
til_or_since
;
unsigned
long
idle
;
unsigned
long
event_mask
;
}
XScreenSaverInfo
;
typedef
bool
(
*
_XScreenSaverQueryExtension_fn
)
(
Display
*
dpy
int
*
event_base
int
*
error_base
)
;
typedef
XScreenSaverInfo
*
(
*
_XScreenSaverAllocInfo_fn
)
(
void
)
;
typedef
void
(
*
_XScreenSaverQueryInfo_fn
)
(
Display
*
dpy
Drawable
drw
XScreenSaverInfo
*
info
)
;
class
UserIdleServiceX11
:
public
UserIdleServiceImpl
{
public
:
bool
PollIdleTime
(
uint32_t
*
aIdleTime
)
override
{
MOZ_ASSERT
(
!
mInitialized
)
;
*
aIdleTime
=
0
;
Display
*
dplay
=
GDK_DISPLAY_XDISPLAY
(
gdk_display_get_default
(
)
)
;
if
(
!
dplay
)
{
MOZ_LOG
(
sIdleLog
LogLevel
:
:
Warning
(
"
No
display
found
!
\
n
"
)
)
;
return
false
;
}
int
event_base
error_base
;
if
(
mXSSQueryExtension
(
dplay
&
event_base
&
error_base
)
)
{
if
(
!
mXssInfo
)
mXssInfo
=
mXSSAllocInfo
(
)
;
if
(
!
mXssInfo
)
return
false
;
mXSSQueryInfo
(
dplay
GDK_ROOT_WINDOW
(
)
mXssInfo
)
;
*
aIdleTime
=
mXssInfo
-
>
idle
;
MOZ_LOG
(
sIdleLog
LogLevel
:
:
Info
(
"
UserIdleServiceX11
:
:
PollIdleTime
(
)
%
d
\
n
"
*
aIdleTime
)
)
;
return
true
;
}
MOZ_LOG
(
sIdleLog
LogLevel
:
:
Warning
(
"
XSSQueryExtension
returned
false
!
\
n
"
)
)
;
return
false
;
}
UserIdleServiceX11
(
)
{
MOZ_ASSERT
(
mozilla
:
:
widget
:
:
GdkIsX11Display
(
)
)
;
PRLibrary
*
xsslib
=
PR_LoadLibrary
(
"
libXss
.
so
.
1
"
)
;
if
(
!
xsslib
)
{
MOZ_LOG
(
sIdleLog
LogLevel
:
:
Warning
(
"
Failed
to
find
libXss
.
so
!
\
n
"
)
)
;
return
;
}
mXSSQueryExtension
=
(
_XScreenSaverQueryExtension_fn
)
PR_FindFunctionSymbol
(
xsslib
"
XScreenSaverQueryExtension
"
)
;
mXSSAllocInfo
=
(
_XScreenSaverAllocInfo_fn
)
PR_FindFunctionSymbol
(
xsslib
"
XScreenSaverAllocInfo
"
)
;
mXSSQueryInfo
=
(
_XScreenSaverQueryInfo_fn
)
PR_FindFunctionSymbol
(
xsslib
"
XScreenSaverQueryInfo
"
)
;
if
(
!
mXSSQueryExtension
)
{
MOZ_LOG
(
sIdleLog
LogLevel
:
:
Warning
(
"
Failed
to
get
XSSQueryExtension
!
\
n
"
)
)
;
}
if
(
!
mXSSAllocInfo
)
{
MOZ_LOG
(
sIdleLog
LogLevel
:
:
Warning
(
"
Failed
to
get
XSSAllocInfo
!
\
n
"
)
)
;
}
if
(
!
mXSSQueryInfo
)
{
MOZ_LOG
(
sIdleLog
LogLevel
:
:
Warning
(
"
Failed
to
get
XSSQueryInfo
!
\
n
"
)
)
;
}
mInitialized
=
mXSSQueryExtension
&
&
mXSSAllocInfo
&
&
mXSSQueryInfo
;
}
~
UserIdleServiceX11
(
)
{
#
ifdef
MOZ_X11
if
(
mXssInfo
)
{
XFree
(
mXssInfo
)
;
}
#
endif
#
if
0
if
(
xsslib
)
{
PR_UnloadLibrary
(
xsslib
)
;
xsslib
=
nullptr
;
}
#
endif
}
private
:
XScreenSaverInfo
*
mXssInfo
=
nullptr
;
_XScreenSaverQueryExtension_fn
mXSSQueryExtension
=
nullptr
;
_XScreenSaverAllocInfo_fn
mXSSAllocInfo
=
nullptr
;
_XScreenSaverQueryInfo_fn
mXSSQueryInfo
=
nullptr
;
}
;
#
endif
nsUserIdleServiceGTK
:
:
nsUserIdleServiceGTK
(
)
{
mIdleService
=
mozilla
:
:
MakeUnique
<
UserIdleServiceX11
>
(
)
;
if
(
mIdleService
-
>
IsAvailable
(
)
)
{
return
;
}
mIdleService
=
nullptr
;
}
bool
nsUserIdleServiceGTK
:
:
PollIdleTime
(
uint32_t
*
aIdleTime
)
{
if
(
!
mIdleService
)
{
return
false
;
}
return
mIdleService
-
>
PollIdleTime
(
aIdleTime
)
;
}
