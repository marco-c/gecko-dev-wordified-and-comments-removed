#
include
"
WindowSurfaceProvider
.
h
"
#
include
"
gfxPlatformGtk
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
layers
/
LayersTypes
.
h
"
#
include
"
nsWindow
.
h
"
#
ifdef
MOZ_WAYLAND
#
include
"
mozilla
/
StaticPrefs_widget
.
h
"
#
include
"
WindowSurfaceWaylandMultiBuffer
.
h
"
#
endif
#
ifdef
MOZ_X11
#
include
"
mozilla
/
X11Util
.
h
"
#
include
"
WindowSurfaceX11Image
.
h
"
#
include
"
WindowSurfaceX11SHM
.
h
"
#
endif
#
undef
LOG
#
ifdef
MOZ_LOGGING
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
Units
.
h
"
extern
mozilla
:
:
LazyLogModule
gWidgetLog
;
#
define
LOG
(
args
)
MOZ_LOG
(
gWidgetLog
mozilla
:
:
LogLevel
:
:
Debug
args
)
#
else
#
define
LOG
(
args
)
#
endif
namespace
mozilla
{
namespace
widget
{
using
namespace
mozilla
:
:
layers
;
WindowSurfaceProvider
:
:
WindowSurfaceProvider
(
)
:
mWindowSurface
(
nullptr
)
mMutex
(
"
WindowSurfaceProvider
"
)
mWindowSurfaceValid
(
false
)
#
ifdef
MOZ_WAYLAND
mWidget
(
nullptr
)
#
endif
#
ifdef
MOZ_X11
mIsShaped
(
false
)
mXDepth
(
0
)
mXWindow
(
0
)
mXVisual
(
nullptr
)
#
endif
{
}
#
ifdef
MOZ_WAYLAND
void
WindowSurfaceProvider
:
:
Initialize
(
RefPtr
<
nsWindow
>
aWidget
)
{
mWindowSurfaceValid
=
false
;
mWidget
=
std
:
:
move
(
aWidget
)
;
}
#
endif
#
ifdef
MOZ_X11
void
WindowSurfaceProvider
:
:
Initialize
(
Window
aWindow
Visual
*
aVisual
int
aDepth
bool
aIsShaped
)
{
mWindowSurfaceValid
=
false
;
mXWindow
=
aWindow
;
mXVisual
=
aVisual
;
mXDepth
=
aDepth
;
mIsShaped
=
aIsShaped
;
}
#
endif
void
WindowSurfaceProvider
:
:
CleanupResources
(
)
{
MutexAutoLock
lock
(
mMutex
)
;
mWindowSurfaceValid
=
false
;
#
ifdef
MOZ_WAYLAND
mWidget
=
nullptr
;
#
endif
#
ifdef
MOZ_X11
mXWindow
=
0
;
mXVisual
=
0
;
mXDepth
=
0
;
mIsShaped
=
false
;
#
endif
}
RefPtr
<
WindowSurface
>
WindowSurfaceProvider
:
:
CreateWindowSurface
(
)
{
#
ifdef
MOZ_WAYLAND
if
(
GdkIsWaylandDisplay
(
)
)
{
if
(
!
mWidget
)
{
return
nullptr
;
}
return
MakeRefPtr
<
WindowSurfaceWaylandMB
>
(
mWidget
)
;
}
#
endif
#
ifdef
MOZ_X11
if
(
GdkIsX11Display
(
)
)
{
if
(
!
mXWindow
)
{
return
nullptr
;
}
#
ifdef
MOZ_HAVE_SHMIMAGE
if
(
!
mIsShaped
&
&
nsShmImage
:
:
UseShm
(
)
)
{
LOG
(
(
"
Drawing
to
Window
0x
%
lx
will
use
MIT
-
SHM
\
n
"
mXWindow
)
)
;
return
MakeRefPtr
<
WindowSurfaceX11SHM
>
(
DefaultXDisplay
(
)
mXWindow
mXVisual
mXDepth
)
;
}
#
endif
LOG
(
(
"
Drawing
to
Window
0x
%
lx
will
use
XPutImage
\
n
"
mXWindow
)
)
;
return
MakeRefPtr
<
WindowSurfaceX11Image
>
(
DefaultXDisplay
(
)
mXWindow
mXVisual
mXDepth
mIsShaped
)
;
}
#
endif
MOZ_RELEASE_ASSERT
(
false
)
;
}
already_AddRefed
<
gfx
:
:
DrawTarget
>
WindowSurfaceProvider
:
:
StartRemoteDrawingInRegion
(
const
LayoutDeviceIntRegion
&
aInvalidRegion
layers
:
:
BufferMode
*
aBufferMode
)
{
if
(
aInvalidRegion
.
IsEmpty
(
)
)
{
return
nullptr
;
}
MutexAutoLock
lock
(
mMutex
)
;
if
(
!
mWindowSurfaceValid
)
{
mWindowSurface
=
nullptr
;
mWindowSurfaceValid
=
true
;
}
if
(
!
mWindowSurface
)
{
mWindowSurface
=
CreateWindowSurface
(
)
;
if
(
!
mWindowSurface
)
{
return
nullptr
;
}
}
*
aBufferMode
=
BufferMode
:
:
BUFFER_NONE
;
RefPtr
<
gfx
:
:
DrawTarget
>
dt
=
mWindowSurface
-
>
Lock
(
aInvalidRegion
)
;
#
ifdef
MOZ_X11
if
(
!
dt
&
&
GdkIsX11Display
(
)
&
&
!
mWindowSurface
-
>
IsFallback
(
)
)
{
gfxWarningOnce
(
)
<
<
"
Failed
to
lock
WindowSurface
falling
back
to
XPutImage
backend
.
"
;
mWindowSurface
=
MakeRefPtr
<
WindowSurfaceX11Image
>
(
DefaultXDisplay
(
)
mXWindow
mXVisual
mXDepth
mIsShaped
)
;
dt
=
mWindowSurface
-
>
Lock
(
aInvalidRegion
)
;
}
#
endif
return
dt
.
forget
(
)
;
}
void
WindowSurfaceProvider
:
:
EndRemoteDrawingInRegion
(
gfx
:
:
DrawTarget
*
aDrawTarget
const
LayoutDeviceIntRegion
&
aInvalidRegion
)
{
auto
commit
=
[
RefPtr
{
mWidget
}
this
aInvalidRegion
]
(
)
{
MutexAutoLock
lock
(
mMutex
)
;
if
(
mWindowSurface
&
&
mWindowSurfaceValid
)
{
mWindowSurface
-
>
Commit
(
aInvalidRegion
)
;
}
}
;
if
(
moz_container_wayland_is_commiting_to_parent
(
mWidget
-
>
GetMozContainer
(
)
)
)
{
NS_DispatchToMainThread
(
NS_NewRunnableFunction
(
"
WindowSurfaceProvider
:
:
EndRemoteDrawingInRegion
"
commit
)
)
;
}
else
{
commit
(
)
;
}
}
}
}
