#
ifndef
widget_gtk_GtkCompositorWidget_h
#
define
widget_gtk_GtkCompositorWidget_h
#
include
"
GLDefs
.
h
"
#
include
"
mozilla
/
DataMutex
.
h
"
#
include
"
mozilla
/
widget
/
CompositorWidget
.
h
"
#
include
"
WindowSurfaceProvider
.
h
"
#
include
"
mozilla
/
UniquePtr
.
h
"
#
include
"
MozContainerSurfaceLock
.
h
"
class
nsIWidget
;
class
nsWindow
;
namespace
mozilla
{
namespace
layers
{
class
NativeLayerRootWayland
;
}
namespace
widget
{
class
PlatformCompositorWidgetDelegate
:
public
CompositorWidgetDelegate
{
public
:
virtual
void
NotifyClientSizeChanged
(
const
LayoutDeviceIntSize
&
aClientSize
)
=
0
;
virtual
GtkCompositorWidget
*
AsGtkCompositorWidget
(
)
{
return
nullptr
;
}
;
virtual
void
CleanupResources
(
)
=
0
;
virtual
void
SetRenderingSurface
(
const
uintptr_t
aXWindow
const
bool
aShaped
)
=
0
;
PlatformCompositorWidgetDelegate
*
AsPlatformSpecificDelegate
(
)
override
{
return
this
;
}
}
;
class
GtkCompositorWidgetInitData
;
class
GtkCompositorWidget
:
public
CompositorWidget
public
PlatformCompositorWidgetDelegate
{
public
:
GtkCompositorWidget
(
const
GtkCompositorWidgetInitData
&
aInitData
const
layers
:
:
CompositorOptions
&
aOptions
RefPtr
<
nsWindow
>
aWindow
)
;
~
GtkCompositorWidget
(
)
;
already_AddRefed
<
gfx
:
:
DrawTarget
>
StartRemoteDrawing
(
)
override
;
void
EndRemoteDrawing
(
)
override
;
already_AddRefed
<
gfx
:
:
DrawTarget
>
StartRemoteDrawingInRegion
(
const
LayoutDeviceIntRegion
&
aInvalidRegion
layers
:
:
BufferMode
*
aBufferMode
)
override
;
void
EndRemoteDrawingInRegion
(
gfx
:
:
DrawTarget
*
aDrawTarget
const
LayoutDeviceIntRegion
&
aInvalidRegion
)
override
;
LayoutDeviceIntSize
GetClientSize
(
)
override
;
void
RemoteLayoutSizeUpdated
(
const
LayoutDeviceRect
&
aSize
)
;
nsIWidget
*
RealWidget
(
)
override
;
GtkCompositorWidget
*
AsGTK
(
)
override
{
return
this
;
}
CompositorWidgetDelegate
*
AsDelegate
(
)
override
{
return
this
;
}
EGLNativeWindowType
GetEGLNativeWindow
(
)
;
LayoutDeviceIntRegion
GetTransparentRegion
(
)
override
;
void
CleanupResources
(
)
override
;
void
SetRenderingSurface
(
const
uintptr_t
aXWindow
const
bool
aShaped
)
override
;
bool
SetEGLNativeWindowSize
(
const
LayoutDeviceIntSize
&
aEGLWindowSize
)
;
#
if
defined
(
MOZ_X11
)
Window
XWindow
(
)
const
{
return
mProvider
.
GetXWindow
(
)
;
}
#
endif
#
if
defined
(
MOZ_WAYLAND
)
RefPtr
<
mozilla
:
:
layers
:
:
NativeLayerRoot
>
GetNativeLayerRoot
(
)
override
;
#
endif
void
NotifyClientSizeChanged
(
const
LayoutDeviceIntSize
&
aClientSize
)
override
;
GtkCompositorWidget
*
AsGtkCompositorWidget
(
)
override
{
return
this
;
}
UniquePtr
<
MozContainerSurfaceLock
>
LockSurface
(
)
;
private
:
#
if
defined
(
MOZ_WAYLAND
)
void
ConfigureWaylandBackend
(
)
;
#
endif
#
if
defined
(
MOZ_X11
)
void
ConfigureX11Backend
(
Window
aXWindow
bool
aShaped
)
;
#
endif
#
ifdef
MOZ_LOGGING
bool
IsPopup
(
)
;
#
endif
protected
:
RefPtr
<
nsWindow
>
mWidget
;
private
:
DataMutex
<
LayoutDeviceIntSize
>
mClientSize
;
WindowSurfaceProvider
mProvider
;
#
ifdef
MOZ_WAYLAND
RefPtr
<
mozilla
:
:
layers
:
:
NativeLayerRootWayland
>
mNativeLayerRoot
;
#
endif
}
;
}
}
#
endif
