#
include
"
gfxPlatform
.
h
"
#
include
"
imgIContainer
.
h
"
#
include
"
imgLoader
.
h
"
#
include
"
imgRequestProxy
.
h
"
#
include
"
mozilla
/
dom
/
Document
.
h
"
#
include
"
nsContentUtils
.
h
"
#
include
"
nsIContent
.
h
"
#
include
"
nsISupports
.
h
"
#
include
"
nsNameSpaceManager
.
h
"
#
include
"
nsNetUtil
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
include
"
nsToolkit
.
h
"
#
include
"
nsWindowGfx
.
h
"
#
include
"
IconLoaderHelperWin
.
h
"
using
namespace
mozilla
;
using
mozilla
:
:
gfx
:
:
SourceSurface
;
using
mozilla
:
:
widget
:
:
IconLoader
;
using
mozilla
:
:
widget
:
:
IconLoaderListenerWin
;
namespace
mozilla
:
:
widget
{
NS_IMPL_ISUPPORTS0
(
IconLoaderHelperWin
)
IconLoaderHelperWin
:
:
IconLoaderHelperWin
(
IconLoaderListenerWin
*
aListener
)
:
mLoadListener
(
aListener
)
{
MOZ_ASSERT
(
aListener
)
;
MOZ_ASSERT
(
NS_IsMainThread
(
)
)
;
}
IconLoaderHelperWin
:
:
~
IconLoaderHelperWin
(
)
{
Destroy
(
)
;
}
nsresult
IconLoaderHelperWin
:
:
OnComplete
(
imgIContainer
*
aImage
const
nsIntRect
&
aRect
)
{
NS_ENSURE_ARG_POINTER
(
aImage
)
;
nsresult
rv
=
nsWindowGfx
:
:
CreateIcon
(
aImage
false
LayoutDeviceIntPoint
(
)
nsWindowGfx
:
:
GetIconMetrics
(
nsWindowGfx
:
:
kRegularIcon
)
&
mNativeIconImage
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
mLoadListener
)
{
mLoadListener
-
>
OnComplete
(
)
;
}
return
NS_OK
;
}
HICON
IconLoaderHelperWin
:
:
GetNativeIconImage
(
)
{
if
(
mNativeIconImage
)
{
return
mNativeIconImage
;
}
return
:
:
LoadIcon
(
:
:
GetModuleHandle
(
NULL
)
IDI_APPLICATION
)
;
}
void
IconLoaderHelperWin
:
:
Destroy
(
)
{
if
(
mNativeIconImage
)
{
:
:
DestroyIcon
(
mNativeIconImage
)
;
mNativeIconImage
=
nullptr
;
}
mLoadListener
=
nullptr
;
}
}
