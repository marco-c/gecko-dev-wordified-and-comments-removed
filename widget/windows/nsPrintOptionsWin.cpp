#
include
"
nsCOMPtr
.
h
"
#
include
"
nsPrintOptionsWin
.
h
"
#
include
"
nsPrintSettingsWin
.
h
"
#
include
"
nsPrintDialogUtil
.
h
"
#
include
"
nsGfxCIID
.
h
"
#
include
"
nsIServiceManager
.
h
"
#
include
"
nsIWebBrowserPrint
.
h
"
#
include
"
nsWindowsHelpers
.
h
"
#
include
"
ipc
/
IPCMessageUtils
.
h
"
const
char
kPrinterEnumeratorContractID
[
]
=
"
mozilla
.
org
/
gfx
/
printerenumerator
;
1
"
;
using
namespace
mozilla
:
:
embedding
;
nsPrintOptionsWin
:
:
nsPrintOptionsWin
(
)
{
}
nsPrintOptionsWin
:
:
~
nsPrintOptionsWin
(
)
{
}
NS_IMETHODIMP
nsPrintOptionsWin
:
:
SerializeToPrintData
(
nsIPrintSettings
*
aSettings
nsIWebBrowserPrint
*
aWBP
PrintData
*
data
)
{
nsresult
rv
=
nsPrintOptions
:
:
SerializeToPrintData
(
aSettings
aWBP
data
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
if
(
aWBP
)
{
aWBP
-
>
GetIsFramesetDocument
(
&
data
-
>
isFramesetDocument
(
)
)
;
aWBP
-
>
GetIsFramesetFrameSelected
(
&
data
-
>
isFramesetFrameSelected
(
)
)
;
aWBP
-
>
GetIsIFrameSelected
(
&
data
-
>
isIFrameSelected
(
)
)
;
aWBP
-
>
GetIsRangeSelection
(
&
data
-
>
isRangeSelection
(
)
)
;
}
nsCOMPtr
<
nsIPrintSettingsWin
>
psWin
=
do_QueryInterface
(
aSettings
)
;
if
(
!
psWin
)
{
return
NS_ERROR_FAILURE
;
}
char16_t
*
deviceName
;
char16_t
*
driverName
;
psWin
-
>
GetDeviceName
(
&
deviceName
)
;
psWin
-
>
GetDriverName
(
&
driverName
)
;
data
-
>
deviceName
(
)
.
Assign
(
deviceName
)
;
data
-
>
driverName
(
)
.
Assign
(
driverName
)
;
free
(
deviceName
)
;
free
(
driverName
)
;
if
(
XRE_IsParentProcess
(
)
)
{
psWin
-
>
GetPrintableWidthInInches
(
&
data
-
>
printableWidthInInches
(
)
)
;
psWin
-
>
GetPrintableHeightInInches
(
&
data
-
>
printableHeightInInches
(
)
)
;
LPDEVMODEW
devModeRaw
;
psWin
-
>
GetDevMode
(
&
devModeRaw
)
;
if
(
devModeRaw
)
{
nsAutoDevMode
devMode
(
devModeRaw
)
;
devModeRaw
=
nullptr
;
size_t
devModeTotalSize
=
devMode
-
>
dmSize
+
devMode
-
>
dmDriverExtra
;
size_t
msgTotalSize
=
sizeof
(
PrintData
)
+
devModeTotalSize
;
if
(
msgTotalSize
>
IPC
:
:
MAX_MESSAGE_SIZE
)
{
return
NS_ERROR_FAILURE
;
}
const
char
*
devModeData
=
reinterpret_cast
<
const
char
*
>
(
devMode
.
get
(
)
)
;
nsTArray
<
uint8_t
>
arrayBuf
;
arrayBuf
.
AppendElements
(
devModeData
devModeTotalSize
)
;
data
-
>
devModeData
(
)
.
SwapElements
(
arrayBuf
)
;
}
}
return
NS_OK
;
}
NS_IMETHODIMP
nsPrintOptionsWin
:
:
DeserializeToPrintSettings
(
const
PrintData
&
data
nsIPrintSettings
*
settings
)
{
nsresult
rv
=
nsPrintOptions
:
:
DeserializeToPrintSettings
(
data
settings
)
;
NS_ENSURE_SUCCESS
(
rv
rv
)
;
nsCOMPtr
<
nsIPrintSettingsWin
>
psWin
=
do_QueryInterface
(
settings
)
;
if
(
!
settings
)
{
return
NS_ERROR_FAILURE
;
}
if
(
XRE_IsContentProcess
(
)
)
{
psWin
-
>
SetDeviceName
(
data
.
deviceName
(
)
.
get
(
)
)
;
psWin
-
>
SetDriverName
(
data
.
driverName
(
)
.
get
(
)
)
;
psWin
-
>
SetPrintableWidthInInches
(
data
.
printableWidthInInches
(
)
)
;
psWin
-
>
SetPrintableHeightInInches
(
data
.
printableHeightInInches
(
)
)
;
if
(
data
.
devModeData
(
)
.
IsEmpty
(
)
)
{
psWin
-
>
SetDevMode
(
nullptr
)
;
}
else
{
auto
devModeDataLength
=
data
.
devModeData
(
)
.
Length
(
)
;
if
(
devModeDataLength
<
sizeof
(
DEVMODEW
)
)
{
NS_WARNING
(
"
DEVMODE
data
is
too
short
.
"
)
;
return
NS_ERROR_FAILURE
;
}
DEVMODEW
*
devMode
=
reinterpret_cast
<
DEVMODEW
*
>
(
const_cast
<
uint8_t
*
>
(
data
.
devModeData
(
)
.
Elements
(
)
)
)
;
if
(
(
devMode
-
>
dmSize
+
devMode
-
>
dmDriverExtra
)
!
=
devModeDataLength
)
{
NS_WARNING
(
"
DEVMODE
length
is
incorrect
.
"
)
;
return
NS_ERROR_FAILURE
;
}
psWin
-
>
SetDevMode
(
devMode
)
;
}
}
return
NS_OK
;
}
nsresult
nsPrintOptionsWin
:
:
_CreatePrintSettings
(
nsIPrintSettings
*
*
_retval
)
{
*
_retval
=
nullptr
;
nsPrintSettingsWin
*
printSettings
=
new
nsPrintSettingsWin
(
)
;
NS_ENSURE_TRUE
(
printSettings
NS_ERROR_OUT_OF_MEMORY
)
;
NS_ADDREF
(
*
_retval
=
printSettings
)
;
return
NS_OK
;
}
