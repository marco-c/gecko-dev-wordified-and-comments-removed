#
include
"
nsDeviceContextSpecWin
.
h
"
#
include
"
mozilla
/
ArrayUtils
.
h
"
#
include
"
mozilla
/
gfx
/
PrintTargetPDF
.
h
"
#
include
"
mozilla
/
gfx
/
PrintTargetWindows
.
h
"
#
include
"
mozilla
/
Logging
.
h
"
#
include
"
mozilla
/
Preferences
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
<
winspool
.
h
>
#
include
"
nsIWidget
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsIPrintSettingsWin
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsReadableUtils
.
h
"
#
include
"
nsStringEnumerator
.
h
"
#
include
"
gfxWindowsSurface
.
h
"
#
include
"
nsIFileStreams
.
h
"
#
include
"
nsWindowsHelpers
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
ifdef
MOZ_ENABLE_SKIA_PDF
#
include
"
mozilla
/
gfx
/
PrintTargetSkPDF
.
h
"
#
include
"
mozilla
/
gfx
/
PrintTargetEMF
.
h
"
#
include
"
nsIUUIDGenerator
.
h
"
#
include
"
nsDirectoryServiceDefs
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
nsThreadUtils
.
h
"
#
endif
static
mozilla
:
:
LazyLogModule
kWidgetPrintingLogMod
(
"
printing
-
widget
"
)
;
#
define
PR_PL
(
_p1
)
MOZ_LOG
(
kWidgetPrintingLogMod
mozilla
:
:
LogLevel
:
:
Debug
_p1
)
using
namespace
mozilla
;
using
namespace
mozilla
:
:
gfx
;
#
ifdef
MOZ_ENABLE_SKIA_PDF
using
namespace
mozilla
:
:
widget
;
#
endif
static
const
wchar_t
kDriverName
[
]
=
L
"
WINSPOOL
"
;
class
GlobalPrinters
{
public
:
static
GlobalPrinters
*
GetInstance
(
)
{
return
&
mGlobalPrinters
;
}
~
GlobalPrinters
(
)
{
FreeGlobalPrinters
(
)
;
}
void
FreeGlobalPrinters
(
)
;
bool
PrintersAreAllocated
(
)
{
return
mPrinters
!
=
nullptr
;
}
LPWSTR
GetItemFromList
(
int32_t
aInx
)
{
return
mPrinters
?
mPrinters
-
>
ElementAt
(
aInx
)
:
nullptr
;
}
nsresult
EnumeratePrinterList
(
)
;
void
GetDefaultPrinterName
(
nsAString
&
aDefaultPrinterName
)
;
uint32_t
GetNumPrinters
(
)
{
return
mPrinters
?
mPrinters
-
>
Length
(
)
:
0
;
}
protected
:
GlobalPrinters
(
)
{
}
nsresult
EnumerateNativePrinters
(
)
;
void
ReallocatePrinters
(
)
;
static
GlobalPrinters
mGlobalPrinters
;
static
nsTArray
<
LPWSTR
>
*
mPrinters
;
}
;
GlobalPrinters
GlobalPrinters
:
:
mGlobalPrinters
;
nsTArray
<
LPWSTR
>
*
GlobalPrinters
:
:
mPrinters
=
nullptr
;
struct
AutoFreeGlobalPrinters
{
~
AutoFreeGlobalPrinters
(
)
{
GlobalPrinters
:
:
GetInstance
(
)
-
>
FreeGlobalPrinters
(
)
;
}
}
;
nsDeviceContextSpecWin
:
:
nsDeviceContextSpecWin
(
)
:
mDevMode
(
nullptr
)
#
ifdef
MOZ_ENABLE_SKIA_PDF
mPrintViaSkPDF
(
false
)
#
endif
{
}
NS_IMPL_ISUPPORTS
(
nsDeviceContextSpecWin
nsIDeviceContextSpec
)
nsDeviceContextSpecWin
:
:
~
nsDeviceContextSpecWin
(
)
{
SetDevMode
(
nullptr
)
;
nsCOMPtr
<
nsIPrintSettingsWin
>
psWin
(
do_QueryInterface
(
mPrintSettings
)
)
;
if
(
psWin
)
{
psWin
-
>
SetDeviceName
(
EmptyString
(
)
)
;
psWin
-
>
SetDriverName
(
EmptyString
(
)
)
;
psWin
-
>
SetDevMode
(
nullptr
)
;
}
GlobalPrinters
:
:
GetInstance
(
)
-
>
FreeGlobalPrinters
(
)
;
}
NS_IMETHODIMP
nsDeviceContextSpecWin
:
:
Init
(
nsIWidget
*
aWidget
nsIPrintSettings
*
aPrintSettings
bool
aIsPrintPreview
)
{
mPrintSettings
=
aPrintSettings
;
nsresult
rv
=
NS_ERROR_GFX_PRINTER_NO_PRINTER_AVAILABLE
;
if
(
aPrintSettings
)
{
#
ifdef
MOZ_ENABLE_SKIA_PDF
nsAutoString
printViaPdf
;
Preferences
:
:
GetString
(
"
print
.
print_via_pdf_encoder
"
printViaPdf
)
;
if
(
printViaPdf
.
EqualsLiteral
(
"
skia
-
pdf
"
)
)
{
mPrintViaSkPDF
=
true
;
}
#
endif
mPrintSettings
-
>
GetOutputFormat
(
&
mOutputFormat
)
;
if
(
(
XRE_IsContentProcess
(
)
&
&
Preferences
:
:
GetBool
(
"
print
.
print_via_parent
"
)
)
|
|
mOutputFormat
=
=
nsIPrintSettings
:
:
kOutputFormatPDF
)
{
return
NS_OK
;
}
nsCOMPtr
<
nsIPrintSettingsWin
>
psWin
(
do_QueryInterface
(
aPrintSettings
)
)
;
if
(
psWin
)
{
nsAutoString
deviceName
;
nsAutoString
driverName
;
psWin
-
>
GetDeviceName
(
deviceName
)
;
psWin
-
>
GetDriverName
(
driverName
)
;
LPDEVMODEW
devMode
;
psWin
-
>
GetDevMode
(
&
devMode
)
;
if
(
!
deviceName
.
IsEmpty
(
)
&
&
!
driverName
.
IsEmpty
(
)
&
&
devMode
)
{
if
(
devMode
-
>
dmFields
&
DM_SCALE
)
{
double
scale
=
double
(
devMode
-
>
dmScale
)
/
100
.
0f
;
if
(
scale
!
=
1
.
0
)
{
aPrintSettings
-
>
SetScaling
(
scale
)
;
devMode
-
>
dmScale
=
100
;
}
}
SetDeviceName
(
deviceName
)
;
SetDriverName
(
driverName
)
;
SetDevMode
(
devMode
)
;
return
NS_OK
;
}
else
{
PR_PL
(
(
"
*
*
*
*
*
nsDeviceContextSpecWin
:
:
Init
-
"
"
deviceName
/
driverName
/
devMode
was
NULL
!
\
n
"
)
)
;
if
(
devMode
)
:
:
HeapFree
(
:
:
GetProcessHeap
(
)
0
devMode
)
;
}
}
}
else
{
PR_PL
(
(
"
*
*
*
*
*
nsDeviceContextSpecWin
:
:
Init
-
aPrintSettingswas
NULL
!
\
n
"
)
)
;
}
nsAutoString
printerName
;
if
(
mPrintSettings
)
{
mPrintSettings
-
>
GetPrinterName
(
printerName
)
;
}
if
(
printerName
.
IsEmpty
(
)
)
{
GlobalPrinters
:
:
GetInstance
(
)
-
>
GetDefaultPrinterName
(
printerName
)
;
}
if
(
printerName
.
IsEmpty
(
)
)
{
return
rv
;
}
return
GetDataFromPrinter
(
printerName
mPrintSettings
)
;
}
already_AddRefed
<
PrintTarget
>
nsDeviceContextSpecWin
:
:
MakePrintTarget
(
)
{
NS_ASSERTION
(
mDevMode
"
DevMode
can
'
t
be
NULL
here
"
)
;
#
ifdef
MOZ_ENABLE_SKIA_PDF
if
(
mPrintViaSkPDF
)
{
double
width
height
;
mPrintSettings
-
>
GetEffectivePageSize
(
&
width
&
height
)
;
if
(
width
<
=
0
|
|
height
<
=
0
)
{
return
nullptr
;
}
width
/
=
TWIPS_PER_POINT_FLOAT
;
height
/
=
TWIPS_PER_POINT_FLOAT
;
IntSize
size
=
IntSize
:
:
Truncate
(
width
height
)
;
if
(
mOutputFormat
=
=
nsIPrintSettings
:
:
kOutputFormatPDF
)
{
nsString
filename
;
mPrintSettings
-
>
GetToFileName
(
filename
)
;
nsAutoCString
printFile
(
NS_ConvertUTF16toUTF8
(
filename
)
.
get
(
)
)
;
auto
skStream
=
MakeUnique
<
SkFILEWStream
>
(
printFile
.
get
(
)
)
;
return
PrintTargetSkPDF
:
:
CreateOrNull
(
std
:
:
move
(
skStream
)
size
)
;
}
if
(
mDevMode
)
{
NS_WARNING_ASSERTION
(
!
mDriverName
.
IsEmpty
(
)
"
No
driver
!
"
)
;
HDC
dc
=
:
:
CreateDCW
(
mDriverName
.
get
(
)
mDeviceName
.
get
(
)
nullptr
mDevMode
)
;
if
(
!
dc
)
{
gfxCriticalError
(
gfxCriticalError
:
:
DefaultOptions
(
false
)
)
<
<
"
Failed
to
create
device
context
in
GetSurfaceForPrinter
"
;
return
nullptr
;
}
return
PrintTargetEMF
:
:
CreateOrNull
(
dc
size
)
;
}
}
#
endif
if
(
mOutputFormat
=
=
nsIPrintSettings
:
:
kOutputFormatPDF
)
{
nsString
filename
;
mPrintSettings
-
>
GetToFileName
(
filename
)
;
double
width
height
;
mPrintSettings
-
>
GetEffectivePageSize
(
&
width
&
height
)
;
if
(
width
<
=
0
|
|
height
<
=
0
)
{
return
nullptr
;
}
width
/
=
TWIPS_PER_POINT_FLOAT
;
height
/
=
TWIPS_PER_POINT_FLOAT
;
nsCOMPtr
<
nsIFile
>
file
=
do_CreateInstance
(
"
mozilla
.
org
/
file
/
local
;
1
"
)
;
nsresult
rv
=
file
-
>
InitWithPath
(
filename
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
nullptr
;
}
nsCOMPtr
<
nsIFileOutputStream
>
stream
=
do_CreateInstance
(
"
mozilla
.
org
/
network
/
file
-
output
-
stream
;
1
"
)
;
rv
=
stream
-
>
Init
(
file
-
1
-
1
0
)
;
if
(
NS_FAILED
(
rv
)
)
{
return
nullptr
;
}
return
PrintTargetPDF
:
:
CreateOrNull
(
stream
IntSize
:
:
Truncate
(
width
height
)
)
;
}
if
(
mDevMode
)
{
NS_WARNING_ASSERTION
(
!
mDriverName
.
IsEmpty
(
)
"
No
driver
!
"
)
;
HDC
dc
=
:
:
CreateDCW
(
mDriverName
.
get
(
)
mDeviceName
.
get
(
)
nullptr
mDevMode
)
;
if
(
!
dc
)
{
gfxCriticalError
(
gfxCriticalError
:
:
DefaultOptions
(
false
)
)
<
<
"
Failed
to
create
device
context
in
GetSurfaceForPrinter
"
;
return
nullptr
;
}
return
PrintTargetWindows
:
:
CreateOrNull
(
dc
)
;
}
return
nullptr
;
}
float
nsDeviceContextSpecWin
:
:
GetDPI
(
)
{
#
ifdef
MOZ_ENABLE_SKIA_PDF
if
(
mPrintViaSkPDF
)
{
return
72
.
0f
;
}
#
endif
return
mOutputFormat
=
=
nsIPrintSettings
:
:
kOutputFormatPDF
?
72
.
0f
:
144
.
0f
;
}
float
nsDeviceContextSpecWin
:
:
GetPrintingScale
(
)
{
MOZ_ASSERT
(
mPrintSettings
)
;
#
ifdef
MOZ_ENABLE_SKIA_PDF
if
(
mPrintViaSkPDF
)
{
return
1
.
0f
;
}
#
endif
if
(
mOutputFormat
=
=
nsIPrintSettings
:
:
kOutputFormatPDF
)
{
return
1
.
0f
;
}
int32_t
resolution
;
mPrintSettings
-
>
GetResolution
(
&
resolution
)
;
return
float
(
resolution
)
/
GetDPI
(
)
;
}
gfxPoint
nsDeviceContextSpecWin
:
:
GetPrintingTranslate
(
)
{
double
marginTop
marginLeft
;
mPrintSettings
-
>
GetUnwriteableMarginTop
(
&
marginTop
)
;
mPrintSettings
-
>
GetUnwriteableMarginLeft
(
&
marginLeft
)
;
int32_t
resolution
;
mPrintSettings
-
>
GetResolution
(
&
resolution
)
;
return
gfxPoint
(
-
marginLeft
*
resolution
-
marginTop
*
resolution
)
;
}
void
nsDeviceContextSpecWin
:
:
SetDeviceName
(
const
nsAString
&
aDeviceName
)
{
mDeviceName
=
aDeviceName
;
}
void
nsDeviceContextSpecWin
:
:
SetDriverName
(
const
nsAString
&
aDriverName
)
{
mDriverName
=
aDriverName
;
}
void
nsDeviceContextSpecWin
:
:
SetDevMode
(
LPDEVMODEW
aDevMode
)
{
if
(
mDevMode
)
{
:
:
HeapFree
(
:
:
GetProcessHeap
(
)
0
mDevMode
)
;
}
mDevMode
=
aDevMode
;
}
void
nsDeviceContextSpecWin
:
:
GetDevMode
(
LPDEVMODEW
&
aDevMode
)
{
aDevMode
=
mDevMode
;
}
#
define
DISPLAY_LAST_ERROR
nsresult
nsDeviceContextSpecWin
:
:
GetDataFromPrinter
(
const
nsAString
&
aName
nsIPrintSettings
*
aPS
)
{
nsresult
rv
=
NS_ERROR_FAILURE
;
if
(
!
GlobalPrinters
:
:
GetInstance
(
)
-
>
PrintersAreAllocated
(
)
)
{
rv
=
GlobalPrinters
:
:
GetInstance
(
)
-
>
EnumeratePrinterList
(
)
;
if
(
NS_FAILED
(
rv
)
)
{
PR_PL
(
(
"
*
*
*
*
*
nsDeviceContextSpecWin
:
:
GetDataFromPrinter
-
Couldn
'
t
"
"
enumerate
printers
!
\
n
"
)
)
;
DISPLAY_LAST_ERROR
}
NS_ENSURE_SUCCESS
(
rv
rv
)
;
}
nsHPRINTER
hPrinter
=
nullptr
;
const
nsString
&
flat
=
PromiseFlatString
(
aName
)
;
wchar_t
*
name
=
(
wchar_t
*
)
flat
.
get
(
)
;
BOOL
status
=
:
:
OpenPrinterW
(
name
&
hPrinter
nullptr
)
;
if
(
status
)
{
nsAutoPrinter
autoPrinter
(
hPrinter
)
;
LPDEVMODEW
pDevMode
;
LONG
needed
=
:
:
DocumentPropertiesW
(
nullptr
hPrinter
name
nullptr
nullptr
0
)
;
if
(
needed
<
0
)
{
PR_PL
(
(
"
*
*
*
*
nsDeviceContextSpecWin
:
:
GetDataFromPrinter
-
Couldn
'
t
get
"
"
size
of
DEVMODE
using
DocumentPropertiesW
(
pDeviceName
=
\
"
%
s
\
"
)
.
"
"
GetLastEror
(
)
=
%
08x
\
n
"
NS_ConvertUTF16toUTF8
(
aName
)
.
get
(
)
GetLastError
(
)
)
)
;
return
NS_ERROR_FAILURE
;
}
pDevMode
=
(
LPDEVMODEW
)
:
:
HeapAlloc
(
:
:
GetProcessHeap
(
)
HEAP_ZERO_MEMORY
needed
)
;
if
(
!
pDevMode
)
return
NS_ERROR_FAILURE
;
LONG
ret
=
:
:
DocumentPropertiesW
(
nullptr
hPrinter
name
pDevMode
nullptr
DM_OUT_BUFFER
)
;
if
(
ret
=
=
IDOK
&
&
aPS
)
{
nsCOMPtr
<
nsIPrintSettingsWin
>
psWin
=
do_QueryInterface
(
aPS
)
;
MOZ_ASSERT
(
psWin
)
;
psWin
-
>
CopyToNative
(
pDevMode
)
;
ret
=
:
:
DocumentPropertiesW
(
nullptr
hPrinter
name
pDevMode
pDevMode
DM_IN_BUFFER
|
DM_OUT_BUFFER
)
;
if
(
ret
=
=
IDOK
)
{
nsAutoHDC
printerDC
(
:
:
CreateICW
(
kDriverName
name
nullptr
pDevMode
)
)
;
if
(
NS_WARN_IF
(
!
printerDC
)
)
{
:
:
HeapFree
(
:
:
GetProcessHeap
(
)
0
pDevMode
)
;
return
NS_ERROR_FAILURE
;
}
psWin
-
>
CopyFromNative
(
printerDC
pDevMode
)
;
}
}
if
(
ret
!
=
IDOK
)
{
:
:
HeapFree
(
:
:
GetProcessHeap
(
)
0
pDevMode
)
;
PR_PL
(
(
"
*
*
*
*
*
nsDeviceContextSpecWin
:
:
GetDataFromPrinter
-
"
"
DocumentProperties
call
failed
code
:
%
d
/
0x
%
x
\
n
"
ret
ret
)
)
;
DISPLAY_LAST_ERROR
return
NS_ERROR_FAILURE
;
}
SetDevMode
(
pDevMode
)
;
SetDeviceName
(
aName
)
;
SetDriverName
(
nsDependentString
(
kDriverName
)
)
;
rv
=
NS_OK
;
}
else
{
rv
=
NS_ERROR_GFX_PRINTER_NAME_NOT_FOUND
;
PR_PL
(
(
"
*
*
*
*
*
nsDeviceContextSpecWin
:
:
GetDataFromPrinter
-
Couldn
'
t
open
"
"
printer
:
[
%
s
]
\
n
"
NS_ConvertUTF16toUTF8
(
aName
)
.
get
(
)
)
)
;
DISPLAY_LAST_ERROR
}
return
rv
;
}
nsPrinterEnumeratorWin
:
:
nsPrinterEnumeratorWin
(
)
{
}
nsPrinterEnumeratorWin
:
:
~
nsPrinterEnumeratorWin
(
)
{
}
NS_IMPL_ISUPPORTS
(
nsPrinterEnumeratorWin
nsIPrinterEnumerator
)
NS_IMETHODIMP
nsPrinterEnumeratorWin
:
:
GetDefaultPrinterName
(
nsAString
&
aDefaultPrinterName
)
{
GlobalPrinters
:
:
GetInstance
(
)
-
>
GetDefaultPrinterName
(
aDefaultPrinterName
)
;
return
NS_OK
;
}
NS_IMETHODIMP
nsPrinterEnumeratorWin
:
:
InitPrintSettingsFromPrinter
(
const
nsAString
&
aPrinterName
nsIPrintSettings
*
aPrintSettings
)
{
NS_ENSURE_ARG_POINTER
(
aPrintSettings
)
;
if
(
aPrinterName
.
IsEmpty
(
)
)
{
return
NS_OK
;
}
int16_t
outputFormat
;
aPrintSettings
-
>
GetOutputFormat
(
&
outputFormat
)
;
if
(
outputFormat
=
=
nsIPrintSettings
:
:
kOutputFormatPDF
)
{
return
NS_OK
;
}
RefPtr
<
nsDeviceContextSpecWin
>
devSpecWin
=
new
nsDeviceContextSpecWin
(
)
;
if
(
!
devSpecWin
)
return
NS_ERROR_OUT_OF_MEMORY
;
if
(
NS_FAILED
(
GlobalPrinters
:
:
GetInstance
(
)
-
>
EnumeratePrinterList
(
)
)
)
{
return
NS_ERROR_FAILURE
;
}
AutoFreeGlobalPrinters
autoFreeGlobalPrinters
;
bool
initializedFromPrefs
;
nsresult
rv
=
aPrintSettings
-
>
GetIsInitializedFromPrefs
(
&
initializedFromPrefs
)
;
if
(
NS_WARN_IF
(
NS_FAILED
(
rv
)
)
)
{
return
rv
;
}
if
(
initializedFromPrefs
)
{
return
devSpecWin
-
>
GetDataFromPrinter
(
aPrinterName
aPrintSettings
)
;
}
devSpecWin
-
>
GetDataFromPrinter
(
aPrinterName
)
;
LPDEVMODEW
devmode
;
devSpecWin
-
>
GetDevMode
(
devmode
)
;
if
(
NS_WARN_IF
(
!
devmode
)
)
{
return
NS_ERROR_FAILURE
;
}
aPrintSettings
-
>
SetPrinterName
(
aPrinterName
)
;
const
nsString
&
flat
=
PromiseFlatString
(
aPrinterName
)
;
char16ptr_t
printerName
=
flat
.
get
(
)
;
HDC
dc
=
:
:
CreateICW
(
kDriverName
printerName
nullptr
devmode
)
;
if
(
NS_WARN_IF
(
!
dc
)
)
{
return
NS_ERROR_FAILURE
;
}
nsCOMPtr
<
nsIPrintSettingsWin
>
psWin
=
do_QueryInterface
(
aPrintSettings
)
;
MOZ_ASSERT
(
psWin
)
;
psWin
-
>
CopyFromNative
(
dc
devmode
)
;
:
:
DeleteDC
(
dc
)
;
return
NS_OK
;
}
NS_IMETHODIMP
nsPrinterEnumeratorWin
:
:
GetPrinterNameList
(
nsIStringEnumerator
*
*
aPrinterNameList
)
{
NS_ENSURE_ARG_POINTER
(
aPrinterNameList
)
;
*
aPrinterNameList
=
nullptr
;
nsresult
rv
=
GlobalPrinters
:
:
GetInstance
(
)
-
>
EnumeratePrinterList
(
)
;
if
(
NS_FAILED
(
rv
)
)
{
PR_PL
(
(
"
*
*
*
*
*
nsDeviceContextSpecWin
:
:
GetPrinterNameList
-
Couldn
'
t
"
"
enumerate
printers
!
\
n
"
)
)
;
return
rv
;
}
uint32_t
numPrinters
=
GlobalPrinters
:
:
GetInstance
(
)
-
>
GetNumPrinters
(
)
;
nsTArray
<
nsString
>
*
printers
=
new
nsTArray
<
nsString
>
(
numPrinters
)
;
if
(
!
printers
)
return
NS_ERROR_OUT_OF_MEMORY
;
nsString
*
names
=
printers
-
>
AppendElements
(
numPrinters
)
;
for
(
uint32_t
printerInx
=
0
;
printerInx
<
numPrinters
;
+
+
printerInx
)
{
LPWSTR
name
=
GlobalPrinters
:
:
GetInstance
(
)
-
>
GetItemFromList
(
printerInx
)
;
names
[
printerInx
]
.
Assign
(
name
)
;
}
return
NS_NewAdoptingStringEnumerator
(
aPrinterNameList
printers
)
;
}
void
GlobalPrinters
:
:
ReallocatePrinters
(
)
{
if
(
PrintersAreAllocated
(
)
)
{
FreeGlobalPrinters
(
)
;
}
mPrinters
=
new
nsTArray
<
LPWSTR
>
(
)
;
NS_ASSERTION
(
mPrinters
"
Printers
Array
is
NULL
!
"
)
;
}
void
GlobalPrinters
:
:
FreeGlobalPrinters
(
)
{
if
(
mPrinters
!
=
nullptr
)
{
for
(
uint32_t
i
=
0
;
i
<
mPrinters
-
>
Length
(
)
;
i
+
+
)
{
free
(
mPrinters
-
>
ElementAt
(
i
)
)
;
}
delete
mPrinters
;
mPrinters
=
nullptr
;
}
}
nsresult
GlobalPrinters
:
:
EnumerateNativePrinters
(
)
{
nsresult
rv
=
NS_ERROR_GFX_PRINTER_NO_PRINTER_AVAILABLE
;
PR_PL
(
(
"
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
\
n
"
)
)
;
PR_PL
(
(
"
EnumerateNativePrinters
\
n
"
)
)
;
WCHAR
szDefaultPrinterName
[
1024
]
;
DWORD
status
=
GetProfileStringW
(
L
"
devices
"
0
L
"
"
szDefaultPrinterName
ArrayLength
(
szDefaultPrinterName
)
)
;
if
(
status
>
0
)
{
DWORD
count
=
0
;
LPWSTR
sPtr
=
szDefaultPrinterName
;
LPWSTR
ePtr
=
szDefaultPrinterName
+
status
;
LPWSTR
prvPtr
=
sPtr
;
while
(
sPtr
<
ePtr
)
{
if
(
*
sPtr
=
=
0
)
{
LPWSTR
name
=
wcsdup
(
prvPtr
)
;
mPrinters
-
>
AppendElement
(
name
)
;
PR_PL
(
(
"
Printer
Name
:
%
s
\
n
"
prvPtr
)
)
;
prvPtr
=
sPtr
+
1
;
count
+
+
;
}
sPtr
+
+
;
}
rv
=
NS_OK
;
}
PR_PL
(
(
"
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
\
n
"
)
)
;
return
rv
;
}
void
GlobalPrinters
:
:
GetDefaultPrinterName
(
nsAString
&
aDefaultPrinterName
)
{
aDefaultPrinterName
.
Truncate
(
)
;
WCHAR
szDefaultPrinterName
[
1024
]
;
DWORD
status
=
GetProfileStringW
(
L
"
windows
"
L
"
device
"
0
szDefaultPrinterName
ArrayLength
(
szDefaultPrinterName
)
)
;
if
(
status
>
0
)
{
WCHAR
comma
=
'
'
;
LPWSTR
sPtr
=
szDefaultPrinterName
;
while
(
*
sPtr
!
=
comma
&
&
*
sPtr
!
=
0
)
sPtr
+
+
;
if
(
*
sPtr
=
=
comma
)
{
*
sPtr
=
0
;
}
aDefaultPrinterName
=
szDefaultPrinterName
;
}
else
{
aDefaultPrinterName
=
EmptyString
(
)
;
}
PR_PL
(
(
"
DEFAULT
PRINTER
[
%
s
]
\
n
"
PromiseFlatString
(
aDefaultPrinterName
)
.
get
(
)
)
)
;
}
nsresult
GlobalPrinters
:
:
EnumeratePrinterList
(
)
{
ReallocatePrinters
(
)
;
nsresult
rv
=
EnumerateNativePrinters
(
)
;
if
(
NS_FAILED
(
rv
)
)
return
rv
;
nsAutoString
defPrinterName
;
GetDefaultPrinterName
(
defPrinterName
)
;
if
(
!
defPrinterName
.
IsEmpty
(
)
)
{
for
(
uint32_t
i
=
0
;
i
<
mPrinters
-
>
Length
(
)
;
i
+
+
)
{
LPWSTR
name
=
mPrinters
-
>
ElementAt
(
i
)
;
if
(
defPrinterName
.
Equals
(
name
)
)
{
if
(
i
>
0
)
{
LPWSTR
ptr
=
mPrinters
-
>
ElementAt
(
0
)
;
mPrinters
-
>
ElementAt
(
0
)
=
name
;
mPrinters
-
>
ElementAt
(
i
)
=
ptr
;
}
break
;
}
}
}
if
(
!
PrintersAreAllocated
(
)
)
{
PR_PL
(
(
"
*
*
*
*
*
nsDeviceContextSpecWin
:
:
EnumeratePrinterList
-
Printers
aren
t
"
"
allocated
\
n
"
)
)
;
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
