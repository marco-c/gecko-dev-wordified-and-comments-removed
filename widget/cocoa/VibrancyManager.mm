#
include
"
VibrancyManager
.
h
"
#
include
"
nsChildView
.
h
"
#
include
"
nsCocoaFeatures
.
h
"
#
import
<
objc
/
message
.
h
>
using
namespace
mozilla
;
#
if
!
defined
(
MAC_OS_X_VERSION_10_12
)
|
|
MAC_OS_X_VERSION_MAX_ALLOWED
<
MAC_OS_X_VERSION_10_12
enum
{
NSVisualEffectMaterialSelection
=
4
}
;
interface
NSVisualEffectView
(
NSVisualEffectViewMethods
)
-
(
void
)
setEmphasized
:
(
BOOL
)
emphasized
;
end
#
endif
interface
MOZVibrantView
:
NSVisualEffectView
{
VibrancyType
mType
;
}
-
(
instancetype
)
initWithFrame
:
(
NSRect
)
aRect
vibrancyType
:
(
VibrancyType
)
aVibrancyType
;
end
interface
MOZVibrantLeafView
:
MOZVibrantView
end
static
NSAppearance
*
AppearanceForVibrancyType
(
VibrancyType
aType
)
{
switch
(
aType
)
{
case
VibrancyType
:
:
LIGHT
:
case
VibrancyType
:
:
TOOLTIP
:
case
VibrancyType
:
:
MENU
:
case
VibrancyType
:
:
HIGHLIGHTED_MENUITEM
:
case
VibrancyType
:
:
SHEET
:
case
VibrancyType
:
:
SOURCE_LIST
:
case
VibrancyType
:
:
SOURCE_LIST_SELECTION
:
case
VibrancyType
:
:
ACTIVE_SOURCE_LIST_SELECTION
:
return
[
NSAppearance
appearanceNamed
:
"
NSAppearanceNameVibrantLight
"
]
;
case
VibrancyType
:
:
DARK
:
return
[
NSAppearance
appearanceNamed
:
"
NSAppearanceNameVibrantDark
"
]
;
}
}
static
NSVisualEffectState
VisualEffectStateForVibrancyType
(
VibrancyType
aType
)
{
switch
(
aType
)
{
case
VibrancyType
:
:
TOOLTIP
:
case
VibrancyType
:
:
MENU
:
case
VibrancyType
:
:
HIGHLIGHTED_MENUITEM
:
case
VibrancyType
:
:
SHEET
:
return
NSVisualEffectStateActive
;
default
:
return
NSVisualEffectStateFollowsWindowActiveState
;
}
}
static
NSVisualEffectMaterial
VisualEffectMaterialForVibrancyType
(
VibrancyType
aType
BOOL
*
aOutIsEmphasized
)
{
switch
(
aType
)
{
case
VibrancyType
:
:
MENU
:
return
NSVisualEffectMaterialMenu
;
case
VibrancyType
:
:
SOURCE_LIST
:
return
NSVisualEffectMaterialSidebar
;
case
VibrancyType
:
:
SOURCE_LIST_SELECTION
:
return
(
NSVisualEffectMaterial
)
NSVisualEffectMaterialSelection
;
case
VibrancyType
:
:
HIGHLIGHTED_MENUITEM
:
case
VibrancyType
:
:
ACTIVE_SOURCE_LIST_SELECTION
:
*
aOutIsEmphasized
=
YES
;
return
(
NSVisualEffectMaterial
)
NSVisualEffectMaterialSelection
;
default
:
return
NSVisualEffectMaterialAppearanceBased
;
}
}
static
BOOL
HasVibrantForeground
(
VibrancyType
aType
)
{
switch
(
aType
)
{
case
VibrancyType
:
:
MENU
:
return
YES
;
default
:
return
NO
;
}
}
implementation
MOZVibrantView
-
(
instancetype
)
initWithFrame
:
(
NSRect
)
aRect
vibrancyType
:
(
VibrancyType
)
aType
{
self
=
[
super
initWithFrame
:
aRect
]
;
mType
=
aType
;
self
.
appearance
=
AppearanceForVibrancyType
(
mType
)
;
self
.
state
=
VisualEffectStateForVibrancyType
(
mType
)
;
BOOL
isEmphasized
=
NO
;
self
.
material
=
VisualEffectMaterialForVibrancyType
(
mType
&
isEmphasized
)
;
if
(
isEmphasized
&
&
[
self
respondsToSelector
:
selector
(
setEmphasized
:
)
]
)
{
[
self
setEmphasized
:
YES
]
;
}
return
self
;
}
end
implementation
MOZVibrantLeafView
-
(
NSView
*
)
hitTest
:
(
NSPoint
)
aPoint
{
return
nil
;
}
-
(
BOOL
)
allowsVibrancy
{
return
HasVibrantForeground
(
mType
)
;
}
end
bool
VibrancyManager
:
:
UpdateVibrantRegion
(
VibrancyType
aType
const
LayoutDeviceIntRegion
&
aRegion
)
{
if
(
aRegion
.
IsEmpty
(
)
)
{
return
mVibrantRegions
.
Remove
(
uint32_t
(
aType
)
)
;
}
auto
&
vr
=
*
mVibrantRegions
.
LookupOrAdd
(
uint32_t
(
aType
)
)
;
return
vr
.
UpdateRegion
(
aRegion
mCoordinateConverter
mContainerView
^
(
)
{
return
this
-
>
CreateEffectView
(
aType
)
;
}
)
;
}
LayoutDeviceIntRegion
VibrancyManager
:
:
GetUnionOfVibrantRegions
(
)
const
{
LayoutDeviceIntRegion
result
;
for
(
auto
it
=
mVibrantRegions
.
ConstIter
(
)
;
!
it
.
Done
(
)
;
it
.
Next
(
)
)
{
result
.
OrWith
(
it
.
UserData
(
)
-
>
Region
(
)
)
;
}
return
result
;
}
NSView
*
VibrancyManager
:
:
CreateEffectView
(
VibrancyType
aType
BOOL
aIsContainer
)
{
return
aIsContainer
?
[
[
MOZVibrantView
alloc
]
initWithFrame
:
NSZeroRect
vibrancyType
:
aType
]
:
[
[
MOZVibrantLeafView
alloc
]
initWithFrame
:
NSZeroRect
vibrancyType
:
aType
]
;
}
bool
VibrancyManager
:
:
SystemSupportsVibrancy
(
)
{
return
true
;
}
