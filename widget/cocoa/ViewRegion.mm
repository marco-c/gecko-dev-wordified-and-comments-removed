#
include
"
ViewRegion
.
h
"
#
import
<
Cocoa
/
Cocoa
.
h
>
#
include
"
nsChildView
.
h
"
using
namespace
mozilla
;
ViewRegion
:
:
~
ViewRegion
(
)
{
for
(
NSView
*
view
:
mViews
)
{
[
view
removeFromSuperview
]
;
}
}
bool
ViewRegion
:
:
UpdateRegion
(
const
LayoutDeviceIntRegion
&
aRegion
const
nsChildView
&
aCoordinateConverter
NSView
*
aContainerView
NSView
*
(
^
aViewCreationCallback
)
(
)
)
{
if
(
mRegion
=
=
aRegion
)
{
return
false
;
}
nsTArray
<
NSView
*
>
viewsToRecycle
=
std
:
:
move
(
mViews
)
;
size_t
viewsRecycled
=
0
;
for
(
auto
iter
=
aRegion
.
RectIter
(
)
;
!
iter
.
Done
(
)
;
iter
.
Next
(
)
)
{
NSRect
rect
=
aCoordinateConverter
.
DevPixelsToCocoaPoints
(
iter
.
Get
(
)
)
;
NSView
*
view
=
nil
;
if
(
viewsRecycled
<
viewsToRecycle
.
Length
(
)
)
{
view
=
viewsToRecycle
[
viewsRecycled
+
+
]
;
}
else
{
view
=
aViewCreationCallback
(
)
;
[
aContainerView
addSubview
:
view
]
;
[
view
release
]
;
}
if
(
!
NSEqualRects
(
rect
view
.
frame
)
)
{
view
.
frame
=
rect
;
}
view
.
needsDisplay
=
YES
;
mViews
.
AppendElement
(
view
)
;
}
for
(
NSView
*
view
:
Span
(
viewsToRecycle
)
.
From
(
viewsRecycled
)
)
{
[
view
removeFromSuperview
]
;
}
mRegion
=
aRegion
;
return
true
;
}
