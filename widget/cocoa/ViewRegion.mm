#
include
"
ViewRegion
.
h
"
#
import
<
Cocoa
/
Cocoa
.
h
>
#
include
"
nsChildView
.
h
"
using
namespace
mozilla
;
ViewRegion
:
:
~
ViewRegion
(
)
{
for
(
size_t
i
=
0
;
i
<
mViews
.
Length
(
)
;
i
+
+
)
{
[
mViews
[
i
]
removeFromSuperview
]
;
}
}
bool
ViewRegion
:
:
UpdateRegion
(
const
LayoutDeviceIntRegion
&
aRegion
const
nsChildView
&
aCoordinateConverter
NSView
*
aContainerView
NSView
*
(
^
aViewCreationCallback
)
(
)
)
{
if
(
mRegion
=
=
aRegion
)
{
return
false
;
}
nsTArray
<
NSView
*
>
viewsToRecycle
;
mViews
.
SwapElements
(
viewsToRecycle
)
;
size_t
i
=
0
;
for
(
auto
iter
=
aRegion
.
RectIter
(
)
;
!
iter
.
Done
(
)
|
|
i
<
viewsToRecycle
.
Length
(
)
;
i
+
+
)
{
if
(
!
iter
.
Done
(
)
)
{
NSView
*
view
=
nil
;
NSRect
rect
=
aCoordinateConverter
.
DevPixelsToCocoaPoints
(
iter
.
Get
(
)
)
;
if
(
i
<
viewsToRecycle
.
Length
(
)
)
{
view
=
viewsToRecycle
[
i
]
;
}
else
{
view
=
aViewCreationCallback
(
)
;
[
aContainerView
addSubview
:
view
]
;
[
view
release
]
;
}
if
(
!
NSEqualRects
(
rect
[
view
frame
]
)
)
{
[
view
setFrame
:
rect
]
;
}
[
view
setNeedsDisplay
:
YES
]
;
mViews
.
AppendElement
(
view
)
;
iter
.
Next
(
)
;
}
else
{
[
viewsToRecycle
[
i
]
removeFromSuperview
]
;
}
}
mRegion
=
aRegion
;
return
true
;
}
