#
ifndef
nsCocoaWindow_h_
#
define
nsCocoaWindow_h_
#
undef
DARWIN
#
import
<
Cocoa
/
Cocoa
.
h
>
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
nsBaseWidget
.
h
"
#
include
"
nsPIWidgetCocoa
.
h
"
#
include
"
nsCocoaUtils
.
h
"
#
include
"
nsTouchBar
.
h
"
#
include
<
dlfcn
.
h
>
#
include
<
queue
>
class
nsCocoaWindow
;
class
nsChildView
;
class
nsMenuBarX
;
class
ChildView
;
namespace
mozilla
{
enum
class
NativeKeyBindingsType
:
uint8_t
;
}
typedef
struct
_nsCocoaWindowList
{
_nsCocoaWindowList
(
)
:
prev
(
nullptr
)
window
(
nullptr
)
{
}
struct
_nsCocoaWindowList
*
prev
;
nsCocoaWindow
*
window
;
}
nsCocoaWindowList
;
interface
BaseWindow
:
NSWindow
{
NSMutableDictionary
*
mState
;
BOOL
mDrawsIntoWindowFrame
;
BOOL
mDisabledNeedsDisplay
;
NSTrackingArea
*
mTrackingArea
;
NSRect
mDirtyRect
;
BOOL
mBeingShown
;
BOOL
mDrawTitle
;
BOOL
mUseMenuStyle
;
BOOL
mIsAnimationSuppressed
;
nsTouchBar
*
mTouchBar
;
}
-
(
void
)
importState
:
(
NSDictionary
*
)
aState
;
-
(
NSMutableDictionary
*
)
exportState
;
-
(
void
)
setDrawsContentsIntoWindowFrame
:
(
BOOL
)
aState
;
-
(
BOOL
)
drawsContentsIntoWindowFrame
;
-
(
NSRect
)
childViewRectForFrameRect
:
(
NSRect
)
aFrameRect
;
-
(
NSRect
)
frameRectForChildViewRect
:
(
NSRect
)
aChildViewRect
;
-
(
void
)
mouseEntered
:
(
NSEvent
*
)
aEvent
;
-
(
void
)
mouseExited
:
(
NSEvent
*
)
aEvent
;
-
(
void
)
mouseMoved
:
(
NSEvent
*
)
aEvent
;
-
(
void
)
updateTrackingArea
;
-
(
NSView
*
)
trackingAreaView
;
-
(
void
)
setBeingShown
:
(
BOOL
)
aValue
;
-
(
BOOL
)
isBeingShown
;
-
(
BOOL
)
isVisibleOrBeingShown
;
-
(
void
)
setIsAnimationSuppressed
:
(
BOOL
)
aValue
;
-
(
BOOL
)
isAnimationSuppressed
;
-
(
NSArray
<
NSView
*
>
*
)
contentViewContents
;
-
(
ChildView
*
)
mainChildView
;
-
(
void
)
setWantsTitleDrawn
:
(
BOOL
)
aDrawTitle
;
-
(
BOOL
)
wantsTitleDrawn
;
-
(
void
)
disableSetNeedsDisplay
;
-
(
void
)
enableSetNeedsDisplay
;
-
(
NSRect
)
getAndResetNativeDirtyRect
;
-
(
void
)
setUseMenuStyle
:
(
BOOL
)
aValue
;
property
(
nonatomic
)
mozilla
:
:
StyleWindowShadow
shadowStyle
;
-
(
void
)
releaseJSObjects
;
end
interface
NSWindow
(
Undocumented
)
-
(
void
)
_setWindowNumber
:
(
NSInteger
)
aNumber
;
-
(
BOOL
)
bottomCornerRounded
;
-
(
NSRect
)
contentRectForFrameRect
:
(
NSRect
)
windowFrame
styleMask
:
(
NSUInteger
)
windowStyle
;
-
(
NSRect
)
frameRectForContentRect
:
(
NSRect
)
windowContentRect
styleMask
:
(
NSUInteger
)
windowStyle
;
+
(
Class
)
frameViewClassForStyleMask
:
(
NSUInteger
)
styleMask
;
end
interface
PopupWindow
:
BaseWindow
{
private
BOOL
mIsContextMenu
;
}
-
(
id
)
initWithContentRect
:
(
NSRect
)
contentRect
styleMask
:
(
NSUInteger
)
styleMask
backing
:
(
NSBackingStoreType
)
bufferingType
defer
:
(
BOOL
)
deferCreation
;
-
(
BOOL
)
isContextMenu
;
-
(
void
)
setIsContextMenu
:
(
BOOL
)
flag
;
-
(
BOOL
)
canBecomeMainWindow
;
end
interface
BorderlessWindow
:
BaseWindow
{
}
-
(
BOOL
)
canBecomeKeyWindow
;
-
(
BOOL
)
canBecomeMainWindow
;
end
interface
WindowDelegate
:
NSObject
<
NSWindowDelegate
>
{
nsCocoaWindow
*
mGeckoWindow
;
bool
mToplevelActiveState
;
BOOL
mHasEverBeenZoomed
;
}
+
(
void
)
paintMenubarForWindow
:
(
NSWindow
*
)
aWindow
;
-
(
id
)
initWithGeckoWindow
:
(
nsCocoaWindow
*
)
geckoWind
;
-
(
void
)
windowDidResize
:
(
NSNotification
*
)
aNotification
;
-
(
nsCocoaWindow
*
)
geckoWidget
;
-
(
bool
)
toplevelActiveState
;
-
(
void
)
sendToplevelActivateEvents
;
-
(
void
)
sendToplevelDeactivateEvents
;
end
interface
MOZTitlebarView
:
NSVisualEffectView
end
interface
FullscreenTitlebarTracker
:
NSTitlebarAccessoryViewController
-
(
FullscreenTitlebarTracker
*
)
init
;
end
interface
ToolbarWindow
:
BaseWindow
{
MOZTitlebarView
*
mTitlebarView
;
FullscreenTitlebarTracker
*
mFullscreenTitlebarTracker
;
CGFloat
mUnifiedToolbarHeight
;
CGFloat
mSheetAttachmentPosition
;
CGFloat
mMenuBarHeight
;
CGFloat
mInitialTitlebarHeight
;
NSRect
mWindowButtonsRect
;
}
-
(
void
)
setUnifiedToolbarHeight
:
(
CGFloat
)
aHeight
;
-
(
CGFloat
)
unifiedToolbarHeight
;
-
(
CGFloat
)
titlebarHeight
;
-
(
NSRect
)
titlebarRect
;
-
(
void
)
setTitlebarNeedsDisplay
;
-
(
void
)
setDrawsContentsIntoWindowFrame
:
(
BOOL
)
aState
;
-
(
void
)
setSheetAttachmentPosition
:
(
CGFloat
)
aY
;
-
(
CGFloat
)
sheetAttachmentPosition
;
-
(
void
)
placeWindowButtons
:
(
NSRect
)
aRect
;
-
(
NSRect
)
windowButtonsRect
;
-
(
void
)
windowMainStateChanged
;
end
class
nsCocoaWindow
final
:
public
nsBaseWidget
public
nsPIWidgetCocoa
{
private
:
typedef
nsBaseWidget
Inherited
;
public
:
nsCocoaWindow
(
)
;
NS_DECL_ISUPPORTS_INHERITED
NS_DECL_NSPIWIDGETCOCOA
;
[
[
nodiscard
]
]
virtual
nsresult
Create
(
nsIWidget
*
aParent
nsNativeWidget
aNativeParent
const
DesktopIntRect
&
aRect
InitData
*
=
nullptr
)
override
;
[
[
nodiscard
]
]
virtual
nsresult
Create
(
nsIWidget
*
aParent
nsNativeWidget
aNativeParent
const
LayoutDeviceIntRect
&
aRect
InitData
*
=
nullptr
)
override
;
virtual
void
Destroy
(
)
override
;
virtual
void
Show
(
bool
aState
)
override
;
virtual
bool
NeedsRecreateToReshow
(
)
override
;
virtual
nsIWidget
*
GetSheetWindowParent
(
void
)
override
;
virtual
void
Enable
(
bool
aState
)
override
;
virtual
bool
IsEnabled
(
)
const
override
;
virtual
void
SetModal
(
bool
aState
)
override
;
virtual
void
SetFakeModal
(
bool
aState
)
override
;
virtual
bool
IsRunningAppModal
(
)
override
;
virtual
bool
IsVisible
(
)
const
override
;
virtual
void
SetFocus
(
Raise
mozilla
:
:
dom
:
:
CallerType
aCallerType
)
override
;
virtual
LayoutDeviceIntPoint
WidgetToScreenOffset
(
)
override
;
virtual
LayoutDeviceIntPoint
GetClientOffset
(
)
override
;
virtual
LayoutDeviceIntMargin
ClientToWindowMargin
(
)
override
;
virtual
void
*
GetNativeData
(
uint32_t
aDataType
)
override
;
virtual
void
ConstrainPosition
(
DesktopIntPoint
&
)
override
;
virtual
void
SetSizeConstraints
(
const
SizeConstraints
&
aConstraints
)
override
;
virtual
void
Move
(
double
aX
double
aY
)
override
;
virtual
nsSizeMode
SizeMode
(
)
override
{
return
mSizeMode
;
}
virtual
void
SetSizeMode
(
nsSizeMode
aMode
)
override
;
virtual
void
GetWorkspaceID
(
nsAString
&
workspaceID
)
override
;
virtual
void
MoveToWorkspace
(
const
nsAString
&
workspaceID
)
override
;
virtual
void
SuppressAnimation
(
bool
aSuppress
)
override
;
virtual
void
HideWindowChrome
(
bool
aShouldHide
)
override
;
virtual
bool
PrepareForFullscreenTransition
(
nsISupports
*
*
aData
)
override
;
virtual
void
PerformFullscreenTransition
(
FullscreenTransitionStage
aStage
uint16_t
aDuration
nsISupports
*
aData
nsIRunnable
*
aCallback
)
override
;
virtual
void
CleanupFullscreenTransition
(
)
override
;
nsresult
MakeFullScreen
(
bool
aFullScreen
)
final
;
nsresult
MakeFullScreenWithNativeTransition
(
bool
aFullScreen
)
final
;
NSAnimation
*
FullscreenTransitionAnimation
(
)
const
{
return
mFullscreenTransitionAnimation
;
}
void
ReleaseFullscreenTransitionAnimation
(
)
{
MOZ_ASSERT
(
mFullscreenTransitionAnimation
"
Should
only
be
called
when
there
is
animation
"
)
;
[
mFullscreenTransitionAnimation
release
]
;
mFullscreenTransitionAnimation
=
nil
;
}
virtual
void
Resize
(
double
aWidth
double
aHeight
bool
aRepaint
)
override
;
virtual
void
Resize
(
double
aX
double
aY
double
aWidth
double
aHeight
bool
aRepaint
)
override
;
NSRect
GetClientCocoaRect
(
)
;
virtual
LayoutDeviceIntRect
GetClientBounds
(
)
override
;
virtual
LayoutDeviceIntRect
GetScreenBounds
(
)
override
;
void
ReportMoveEvent
(
)
;
void
ReportSizeEvent
(
)
;
virtual
void
SetCursor
(
const
Cursor
&
)
override
;
CGFloat
BackingScaleFactor
(
)
;
void
BackingScaleFactorChanged
(
)
;
virtual
double
GetDefaultScaleInternal
(
)
override
;
virtual
int32_t
RoundsWidgetCoordinatesTo
(
)
override
;
mozilla
:
:
DesktopToLayoutDeviceScale
GetDesktopToDeviceScale
(
)
final
{
return
mozilla
:
:
DesktopToLayoutDeviceScale
(
BackingScaleFactor
(
)
)
;
}
virtual
nsresult
SetTitle
(
const
nsAString
&
aTitle
)
override
;
virtual
void
Invalidate
(
const
LayoutDeviceIntRect
&
aRect
)
override
;
virtual
WindowRenderer
*
GetWindowRenderer
(
)
override
;
virtual
nsresult
DispatchEvent
(
mozilla
:
:
WidgetGUIEvent
*
aEvent
nsEventStatus
&
aStatus
)
override
;
virtual
void
CaptureRollupEvents
(
bool
aDoCapture
)
override
;
[
[
nodiscard
]
]
virtual
nsresult
GetAttention
(
int32_t
aCycleCount
)
override
;
virtual
bool
HasPendingInputEvent
(
)
override
;
virtual
TransparencyMode
GetTransparencyMode
(
)
override
;
virtual
void
SetTransparencyMode
(
TransparencyMode
aMode
)
override
;
virtual
void
SetWindowShadowStyle
(
mozilla
:
:
StyleWindowShadow
aStyle
)
override
;
virtual
void
SetWindowOpacity
(
float
aOpacity
)
override
;
virtual
void
SetWindowTransform
(
const
mozilla
:
:
gfx
:
:
Matrix
&
aTransform
)
override
;
virtual
void
SetInputRegion
(
const
InputRegion
&
)
override
;
virtual
void
SetColorScheme
(
const
mozilla
:
:
Maybe
<
mozilla
:
:
ColorScheme
>
&
)
override
;
virtual
void
SetShowsToolbarButton
(
bool
aShow
)
override
;
virtual
void
SetSupportsNativeFullscreen
(
bool
aShow
)
override
;
virtual
void
SetWindowAnimationType
(
WindowAnimationType
aType
)
override
;
virtual
void
SetDrawsTitle
(
bool
aDrawTitle
)
override
;
virtual
nsresult
SetNonClientMargins
(
const
LayoutDeviceIntMargin
&
)
override
;
virtual
void
SetDrawsInTitlebar
(
bool
aState
)
override
;
virtual
void
UpdateThemeGeometries
(
const
nsTArray
<
ThemeGeometry
>
&
aThemeGeometries
)
override
;
virtual
nsresult
SynthesizeNativeMouseEvent
(
LayoutDeviceIntPoint
aPoint
NativeMouseMessage
aNativeMessage
mozilla
:
:
MouseButton
aButton
nsIWidget
:
:
Modifiers
aModifierFlags
nsIObserver
*
aObserver
)
override
;
virtual
nsresult
SynthesizeNativeMouseScrollEvent
(
LayoutDeviceIntPoint
aPoint
uint32_t
aNativeMessage
double
aDeltaX
double
aDeltaY
double
aDeltaZ
uint32_t
aModifierFlags
uint32_t
aAdditionalFlags
nsIObserver
*
aObserver
)
override
;
virtual
void
LockAspectRatio
(
bool
aShouldLock
)
override
;
void
DispatchSizeModeEvent
(
)
;
void
DispatchOcclusionEvent
(
)
;
virtual
bool
DragEvent
(
unsigned
int
aMessage
mozilla
:
:
gfx
:
:
Point
aMouseGlobal
UInt16
aKeyModifiers
)
;
bool
HasModalDescendents
(
)
{
return
mNumModalDescendents
>
0
;
}
NSWindow
*
GetCocoaWindow
(
)
{
return
mWindow
;
}
void
SetMenuBar
(
RefPtr
<
nsMenuBarX
>
&
&
aMenuBar
)
;
nsMenuBarX
*
GetMenuBar
(
)
;
virtual
void
SetInputContext
(
const
InputContext
&
aContext
const
InputContextAction
&
aAction
)
override
;
virtual
InputContext
GetInputContext
(
)
override
{
return
mInputContext
;
}
MOZ_CAN_RUN_SCRIPT
virtual
bool
GetEditCommands
(
mozilla
:
:
NativeKeyBindingsType
aType
const
mozilla
:
:
WidgetKeyboardEvent
&
aEvent
nsTArray
<
mozilla
:
:
CommandInt
>
&
aCommands
)
override
;
void
SetPopupWindowLevel
(
)
;
bool
InFullScreenMode
(
)
const
{
return
mInFullScreenMode
;
}
void
PauseOrResumeCompositor
(
bool
aPause
)
override
;
bool
AsyncPanZoomEnabled
(
)
const
override
;
bool
StartAsyncAutoscroll
(
const
ScreenPoint
&
aAnchorLocation
const
ScrollableLayerGuid
&
aGuid
)
override
;
void
StopAsyncAutoscroll
(
const
ScrollableLayerGuid
&
aGuid
)
override
;
void
CocoaWindowWillEnterFullscreen
(
bool
aFullscreen
)
;
void
CocoaWindowDidEnterFullscreen
(
bool
aFullscreen
)
;
void
CocoaWindowDidFailFullscreen
(
bool
aAttemptedFullscreen
)
;
void
CocoaWindowDidResize
(
)
;
void
CocoaSendToplevelActivateEvents
(
)
;
void
CocoaSendToplevelDeactivateEvents
(
)
;
enum
class
TransitionType
{
Windowed
Fullscreen
EmulatedFullscreen
Miniaturize
Deminiaturize
Zoom
}
;
void
FinishCurrentTransition
(
)
;
void
FinishCurrentTransitionIfMatching
(
const
TransitionType
&
aTransition
)
;
bool
HandleUpdateFullscreenOnResize
(
)
;
protected
:
virtual
~
nsCocoaWindow
(
)
;
nsresult
CreateNativeWindow
(
const
NSRect
&
aRect
BorderStyle
aBorderStyle
bool
aRectIsFrameRect
bool
aIsPrivateBrowsing
)
;
nsresult
CreatePopupContentView
(
const
LayoutDeviceIntRect
&
aRect
InitData
*
)
;
void
DestroyNativeWindow
(
)
;
void
UpdateBounds
(
)
;
int32_t
GetWorkspaceID
(
)
;
void
DoResize
(
double
aX
double
aY
double
aWidth
double
aHeight
bool
aRepaint
bool
aConstrainToCurrentScreen
)
;
void
UpdateFullscreenState
(
bool
aFullScreen
bool
aNativeMode
)
;
nsresult
DoMakeFullScreen
(
bool
aFullScreen
bool
aUseSystemTransition
)
;
virtual
already_AddRefed
<
nsIWidget
>
AllocateChildPopupWidget
(
)
override
{
return
nsIWidget
:
:
CreateTopLevelWindow
(
)
;
}
nsIWidget
*
mParent
;
nsIWidget
*
mAncestorLink
;
BaseWindow
*
mWindow
;
WindowDelegate
*
mDelegate
;
RefPtr
<
nsMenuBarX
>
mMenuBar
;
NSWindow
*
mSheetWindowParent
;
nsChildView
*
mPopupContentView
;
NSAnimation
*
mFullscreenTransitionAnimation
;
mozilla
:
:
StyleWindowShadow
mShadowStyle
;
CGFloat
mBackingScaleFactor
;
CGFloat
mAspectRatio
;
WindowAnimationType
mAnimationType
;
bool
mWindowMadeHere
;
bool
mSheetNeedsShow
;
nsSizeMode
mSizeMode
;
bool
mInFullScreenMode
;
bool
mInNativeFullScreenMode
;
mozilla
:
:
Maybe
<
TransitionType
>
mTransitionCurrent
;
std
:
:
queue
<
TransitionType
>
mTransitionsPending
;
bool
mIsTransitionCurrentAdded
=
false
;
mozilla
:
:
Maybe
<
TransitionType
>
mUpdateFullscreenOnResize
;
bool
IsInTransition
(
)
{
return
mTransitionCurrent
.
isSome
(
)
;
}
void
QueueTransition
(
const
TransitionType
&
aTransition
)
;
void
ProcessTransitions
(
)
;
bool
mInProcessTransitions
=
false
;
bool
mSuppressSizeModeEvents
=
false
;
int
mIgnoreOcclusionCount
;
bool
mHasStartedNativeFullscreen
;
bool
mModal
;
bool
mFakeModal
;
bool
mIsAnimationSuppressed
;
bool
mInReportMoveEvent
;
bool
mInResize
;
bool
mWindowTransformIsIdentity
;
bool
mAlwaysOnTop
;
bool
mAspectRatioLocked
;
int32_t
mNumModalDescendents
;
InputContext
mInputContext
;
NSWindowAnimationBehavior
mWindowAnimationBehavior
;
private
:
bool
mWasShown
;
}
;
#
endif
