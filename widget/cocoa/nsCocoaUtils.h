#
ifndef
nsCocoaUtils_h_
#
define
nsCocoaUtils_h_
#
import
<
Cocoa
/
Cocoa
.
h
>
#
include
"
nsRect
.
h
"
#
include
"
imgIContainer
.
h
"
#
include
"
npapi
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
Units
.
h
"
#
include
"
nsObjCExceptions
.
h
"
#
include
"
mozilla
/
EventForwards
.
h
"
interface
NSObject
(
BackingScaleFactorCategory
)
-
(
CGFloat
)
backingScaleFactor
;
end
#
if
!
defined
(
MAC_OS_X_VERSION_10_8
)
|
|
MAC_OS_X_VERSION_MAX_ALLOWED
<
MAC_OS_X_VERSION_10_8
enum
{
NSEventPhaseMayBegin
=
0x1
<
<
5
}
;
#
endif
class
nsIWidget
;
namespace
mozilla
{
class
TimeStamp
;
namespace
gfx
{
class
SourceSurface
;
}
}
class
nsAutoRetainCocoaObject
{
public
:
explicit
nsAutoRetainCocoaObject
(
id
anObject
)
{
mObject
=
NS_OBJC_TRY_EXPR_ABORT
(
[
anObject
retain
]
)
;
}
~
nsAutoRetainCocoaObject
(
)
{
NS_OBJC_TRY_ABORT
(
[
mObject
release
]
)
;
}
private
:
id
mObject
;
}
;
class
nsAutoreleasePool
{
public
:
nsAutoreleasePool
(
)
{
mLocalPool
=
[
[
NSAutoreleasePool
alloc
]
init
]
;
}
~
nsAutoreleasePool
(
)
{
[
mLocalPool
release
]
;
}
private
:
NSAutoreleasePool
*
mLocalPool
;
}
;
interface
NSApplication
(
Undocumented
)
-
(
BOOL
)
_isRunningModal
;
-
(
BOOL
)
_isRunningAppModal
;
-
(
void
)
_modalSession
:
(
NSModalSession
)
aSession
sendEvent
:
(
NSEvent
*
)
theEvent
;
end
struct
KeyBindingsCommand
{
SEL
selector
;
id
data
;
}
;
interface
NativeKeyBindingsRecorder
:
NSResponder
{
private
nsTArray
<
KeyBindingsCommand
>
*
mCommands
;
}
-
(
void
)
startRecording
:
(
nsTArray
<
KeyBindingsCommand
>
&
)
aCommands
;
-
(
void
)
doCommandBySelector
:
(
SEL
)
aSelector
;
-
(
void
)
insertText
:
(
id
)
aString
;
end
class
nsCocoaUtils
{
typedef
mozilla
:
:
gfx
:
:
SourceSurface
SourceSurface
;
typedef
mozilla
:
:
LayoutDeviceIntPoint
LayoutDeviceIntPoint
;
typedef
mozilla
:
:
LayoutDeviceIntRect
LayoutDeviceIntRect
;
public
:
static
CGFloat
GetBackingScaleFactor
(
id
aObject
)
{
if
(
HiDPIEnabled
(
)
&
&
[
aObject
respondsToSelector
:
selector
(
backingScaleFactor
)
]
)
{
return
[
aObject
backingScaleFactor
]
;
}
return
1
.
0
;
}
static
int32_t
CocoaPointsToDevPixels
(
CGFloat
aPts
CGFloat
aBackingScale
)
{
return
NSToIntRound
(
aPts
*
aBackingScale
)
;
}
static
LayoutDeviceIntPoint
CocoaPointsToDevPixels
(
const
NSPoint
&
aPt
CGFloat
aBackingScale
)
{
return
LayoutDeviceIntPoint
(
NSToIntRound
(
aPt
.
x
*
aBackingScale
)
NSToIntRound
(
aPt
.
y
*
aBackingScale
)
)
;
}
static
LayoutDeviceIntPoint
CocoaPointsToDevPixelsRoundDown
(
const
NSPoint
&
aPt
CGFloat
aBackingScale
)
{
return
LayoutDeviceIntPoint
(
NSToIntFloor
(
aPt
.
x
*
aBackingScale
)
NSToIntFloor
(
aPt
.
y
*
aBackingScale
)
)
;
}
static
LayoutDeviceIntRect
CocoaPointsToDevPixels
(
const
NSRect
&
aRect
CGFloat
aBackingScale
)
{
return
LayoutDeviceIntRect
(
NSToIntRound
(
aRect
.
origin
.
x
*
aBackingScale
)
NSToIntRound
(
aRect
.
origin
.
y
*
aBackingScale
)
NSToIntRound
(
aRect
.
size
.
width
*
aBackingScale
)
NSToIntRound
(
aRect
.
size
.
height
*
aBackingScale
)
)
;
}
static
CGFloat
DevPixelsToCocoaPoints
(
int32_t
aPixels
CGFloat
aBackingScale
)
{
return
(
CGFloat
)
aPixels
/
aBackingScale
;
}
static
NSPoint
DevPixelsToCocoaPoints
(
const
mozilla
:
:
LayoutDeviceIntPoint
&
aPt
CGFloat
aBackingScale
)
{
return
NSMakePoint
(
(
CGFloat
)
aPt
.
x
/
aBackingScale
(
CGFloat
)
aPt
.
y
/
aBackingScale
)
;
}
static
NSPoint
ConvertPointFromScreen
(
NSWindow
*
aWindow
const
NSPoint
&
aPt
)
{
return
[
aWindow
convertRectFromScreen
:
NSMakeRect
(
aPt
.
x
aPt
.
y
0
0
)
]
.
origin
;
}
static
NSPoint
ConvertPointToScreen
(
NSWindow
*
aWindow
const
NSPoint
&
aPt
)
{
return
[
aWindow
convertRectToScreen
:
NSMakeRect
(
aPt
.
x
aPt
.
y
0
0
)
]
.
origin
;
}
static
NSRect
DevPixelsToCocoaPoints
(
const
LayoutDeviceIntRect
&
aRect
CGFloat
aBackingScale
)
{
return
NSMakeRect
(
(
CGFloat
)
aRect
.
X
(
)
/
aBackingScale
(
CGFloat
)
aRect
.
Y
(
)
/
aBackingScale
(
CGFloat
)
aRect
.
Width
(
)
/
aBackingScale
(
CGFloat
)
aRect
.
Height
(
)
/
aBackingScale
)
;
}
static
float
FlippedScreenY
(
float
y
)
;
static
NSRect
GeckoRectToCocoaRect
(
const
mozilla
:
:
DesktopIntRect
&
geckoRect
)
;
static
NSRect
GeckoRectToCocoaRectDevPix
(
const
mozilla
:
:
LayoutDeviceIntRect
&
aGeckoRect
CGFloat
aBackingScale
)
;
static
mozilla
:
:
DesktopIntRect
CocoaRectToGeckoRect
(
const
NSRect
&
cocoaRect
)
;
static
mozilla
:
:
LayoutDeviceIntRect
CocoaRectToGeckoRectDevPix
(
const
NSRect
&
aCocoaRect
CGFloat
aBackingScale
)
;
static
NSPoint
ScreenLocationForEvent
(
NSEvent
*
anEvent
)
;
static
BOOL
IsEventOverWindow
(
NSEvent
*
anEvent
NSWindow
*
aWindow
)
;
static
NSPoint
EventLocationForWindow
(
NSEvent
*
anEvent
NSWindow
*
aWindow
)
;
static
NSEventPhase
EventPhase
(
NSEvent
*
aEvent
)
;
static
NSEventPhase
EventMomentumPhase
(
NSEvent
*
aEvent
)
;
static
BOOL
IsMomentumScrollEvent
(
NSEvent
*
aEvent
)
;
static
BOOL
HasPreciseScrollingDeltas
(
NSEvent
*
aEvent
)
;
static
void
GetScrollingDeltas
(
NSEvent
*
aEvent
CGFloat
*
aOutDeltaX
CGFloat
*
aOutDeltaY
)
;
static
BOOL
EventHasPhaseInformation
(
NSEvent
*
aEvent
)
;
static
void
HideOSChromeOnScreen
(
bool
aShouldHide
)
;
static
nsIWidget
*
GetHiddenWindowWidget
(
)
;
static
void
PrepareForNativeAppModalDialog
(
)
;
static
void
CleanUpAfterNativeAppModalDialog
(
)
;
static
nsresult
CreateCGImageFromSurface
(
SourceSurface
*
aSurface
CGImageRef
*
aResult
bool
*
aIsEntirelyBlack
=
nullptr
)
;
static
nsresult
CreateNSImageFromCGImage
(
CGImageRef
aInputImage
NSImage
*
*
aResult
)
;
static
nsresult
CreateNSImageFromImageContainer
(
imgIContainer
*
aImage
uint32_t
aWhichFrame
NSImage
*
*
aResult
CGFloat
scaleFactor
)
;
static
void
GetStringForNSString
(
const
NSString
*
aSrc
nsAString
&
aDist
)
;
static
NSString
*
ToNSString
(
const
nsAString
&
aString
)
;
static
void
GeckoRectToNSRect
(
const
nsIntRect
&
aGeckoRect
NSRect
&
aOutCocoaRect
)
;
static
void
NSRectToGeckoRect
(
const
NSRect
&
aCocoaRect
nsIntRect
&
aOutGeckoRect
)
;
static
NSEvent
*
MakeNewCocoaEventWithType
(
NSEventType
aEventType
NSEvent
*
aEvent
)
;
static
NSEvent
*
MakeNewCococaEventFromWidgetEvent
(
const
mozilla
:
:
WidgetKeyboardEvent
&
aKeyEvent
NSInteger
aWindowNumber
NSGraphicsContext
*
aContext
)
;
static
void
InitNPCocoaEvent
(
NPCocoaEvent
*
aNPCocoaEvent
)
;
static
void
InitInputEvent
(
mozilla
:
:
WidgetInputEvent
&
aInputEvent
NSEvent
*
aNativeEvent
)
;
static
mozilla
:
:
Modifiers
ModifiersForEvent
(
NSEvent
*
aNativeEvent
)
;
static
UInt32
ConvertToCarbonModifier
(
NSUInteger
aCocoaModifier
)
;
static
bool
HiDPIEnabled
(
)
;
static
void
GetCommandsFromKeyEvent
(
NSEvent
*
aEvent
nsTArray
<
KeyBindingsCommand
>
&
aCommands
)
;
static
uint32_t
ConvertGeckoNameToMacCharCode
(
const
nsAString
&
aKeyCodeName
)
;
static
uint32_t
ConvertGeckoKeyCodeToMacCharCode
(
uint32_t
aKeyCode
)
;
static
NSMutableAttributedString
*
GetNSMutableAttributedString
(
const
nsAString
&
aText
const
nsTArray
<
mozilla
:
:
FontRange
>
&
aFontRanges
const
bool
aIsVertical
const
CGFloat
aBackingScaleFactor
)
;
static
mozilla
:
:
TimeStamp
GetEventTimeStamp
(
NSTimeInterval
aEventTime
)
;
}
;
#
endif
