#
import
<
Cocoa
/
Cocoa
.
h
>
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsSystemStatusBarCocoa
.
h
"
#
include
"
NativeMenuMac
.
h
"
#
include
"
nsObjCExceptions
.
h
"
#
include
"
mozilla
/
dom
/
Element
.
h
"
using
mozilla
:
:
dom
:
:
Element
;
using
mozilla
:
:
widget
:
:
NativeMenuMac
;
NS_IMPL_ISUPPORTS
(
nsSystemStatusBarCocoa
nsISystemStatusBar
)
NS_IMETHODIMP
nsSystemStatusBarCocoa
:
:
AddItem
(
Element
*
aElement
)
{
if
(
!
aElement
-
>
IsAnyOfXULElements
(
nsGkAtoms
:
:
menu
nsGkAtoms
:
:
menupopup
)
)
{
return
NS_ERROR_FAILURE
;
}
RefPtr
<
NativeMenuMac
>
menu
=
new
NativeMenuMac
(
aElement
)
;
nsCOMPtr
<
nsISupports
>
keyPtr
=
aElement
;
mItems
.
InsertOrUpdate
(
keyPtr
mozilla
:
:
MakeUnique
<
StatusItem
>
(
menu
)
)
;
return
NS_OK
;
}
NS_IMETHODIMP
nsSystemStatusBarCocoa
:
:
RemoveItem
(
Element
*
aElement
)
{
mItems
.
Remove
(
aElement
)
;
return
NS_OK
;
}
nsSystemStatusBarCocoa
:
:
StatusItem
:
:
StatusItem
(
NativeMenuMac
*
aMenu
)
:
mMenu
(
aMenu
)
{
NS_OBJC_BEGIN_TRY_ABORT_BLOCK
;
MOZ_COUNT_CTOR
(
nsSystemStatusBarCocoa
:
:
StatusItem
)
;
mStatusItem
=
[
[
NSStatusBar
.
systemStatusBar
statusItemWithLength
:
NSSquareStatusItemLength
]
retain
]
;
mStatusItem
.
menu
=
mMenu
-
>
NativeNSMenu
(
)
;
mStatusItem
.
highlightMode
=
YES
;
mMenu
-
>
SetContainerStatusBarItem
(
mStatusItem
)
;
NS_OBJC_END_TRY_ABORT_BLOCK
;
}
nsSystemStatusBarCocoa
:
:
StatusItem
:
:
~
StatusItem
(
)
{
NS_OBJC_BEGIN_TRY_ABORT_BLOCK
;
mMenu
-
>
SetContainerStatusBarItem
(
nil
)
;
[
NSStatusBar
.
systemStatusBar
removeStatusItem
:
mStatusItem
]
;
[
mStatusItem
release
]
;
mStatusItem
=
nil
;
MOZ_COUNT_DTOR
(
nsSystemStatusBarCocoa
:
:
StatusItem
)
;
NS_OBJC_END_TRY_ABORT_BLOCK
;
}
