#
include
"
CocoaCompositorWidget
.
h
"
#
include
"
mozilla
/
gfx
/
Logging
.
h
"
#
include
"
mozilla
/
layers
/
NativeLayerRootRemoteMacChild
.
h
"
#
include
"
mozilla
/
widget
/
PlatformWidgetTypes
.
h
"
#
include
"
nsIWidget
.
h
"
namespace
mozilla
{
namespace
widget
{
CocoaCompositorWidget
:
:
CocoaCompositorWidget
(
const
layers
:
:
CompositorOptions
&
aOptions
)
:
CompositorWidget
(
aOptions
)
{
}
CocoaCompositorWidget
:
:
~
CocoaCompositorWidget
(
)
{
}
void
CocoaCompositorWidget
:
:
Init
(
CompositorWidgetInitData
&
&
aInitData
)
{
MOZ_ASSERT
(
XRE_IsGPUProcess
(
)
)
;
CocoaCompositorWidgetInitData
cocoaInitData
(
std
:
:
move
(
(
aInitData
)
.
get_CocoaCompositorWidgetInitData
(
)
)
)
;
mClientSize
=
cocoaInitData
.
clientSize
(
)
;
mChildEndpoint
=
std
:
:
move
(
cocoaInitData
.
childEndpoint
(
)
)
;
}
RefPtr
<
mozilla
:
:
layers
:
:
NativeLayerRoot
>
CocoaCompositorWidget
:
:
GetNativeLayerRoot
(
)
{
if
(
!
mNativeLayerRoot
)
{
CreateNativeLayerRoot
(
)
;
MOZ_ASSERT
(
mNativeLayerRoot
)
;
}
return
mNativeLayerRoot
;
}
LayoutDeviceIntSize
CocoaCompositorWidget
:
:
GetClientSize
(
)
{
return
mClientSize
;
}
void
CocoaCompositorWidget
:
:
NotifyClientSizeChanged
(
const
LayoutDeviceIntSize
&
aClientSize
)
{
mClientSize
=
LayoutDeviceIntSize
(
std
:
:
min
(
aClientSize
.
width
MOZ_WIDGET_MAX_SIZE
)
std
:
:
min
(
aClientSize
.
height
MOZ_WIDGET_MAX_SIZE
)
)
;
}
void
CocoaCompositorWidget
:
:
CreateNativeLayerRoot
(
)
{
MOZ_ASSERT
(
!
NS_IsMainThread
(
)
)
;
MOZ_ASSERT
(
XRE_IsGPUProcess
(
)
)
;
auto
root
=
MakeRefPtr
<
layers
:
:
NativeLayerRootRemoteMacChild
>
(
)
;
auto
remoteChild
=
root
-
>
GetRemoteChild
(
)
;
MOZ_ALWAYS_TRUE
(
mChildEndpoint
.
Bind
(
remoteChild
)
)
;
mNativeLayerRoot
=
std
:
:
move
(
root
)
;
}
}
}
