#
include
"
nsDeviceContextSpecProxy
.
h
"
#
include
"
gfxASurface
.
h
"
#
include
"
gfxPlatform
.
h
"
#
include
"
mozilla
/
gfx
/
DrawEventRecorder
.
h
"
#
include
"
mozilla
/
gfx
/
PrintTargetThebes
.
h
"
#
include
"
mozilla
/
layout
/
RemotePrintJobChild
.
h
"
#
include
"
mozilla
/
RefPtr
.
h
"
#
include
"
mozilla
/
Unused
.
h
"
#
include
"
nsComponentManagerUtils
.
h
"
#
include
"
nsAppDirectoryServiceDefs
.
h
"
#
include
"
nsDirectoryServiceUtils
.
h
"
#
include
"
nsIPrintSettings
.
h
"
#
include
"
private
/
pprio
.
h
"
using
mozilla
:
:
Unused
;
using
namespace
mozilla
;
using
namespace
mozilla
:
:
gfx
;
NS_IMPL_ISUPPORTS
(
nsDeviceContextSpecProxy
nsIDeviceContextSpec
)
nsDeviceContextSpecProxy
:
:
nsDeviceContextSpecProxy
(
RemotePrintJobChild
*
aRemotePrintJob
)
:
mRemotePrintJob
(
aRemotePrintJob
)
{
}
nsDeviceContextSpecProxy
:
:
~
nsDeviceContextSpecProxy
(
)
=
default
;
NS_IMETHODIMP
nsDeviceContextSpecProxy
:
:
Init
(
nsIPrintSettings
*
aPrintSettings
bool
aIsPrintPreview
)
{
mPrintSettings
=
aPrintSettings
;
if
(
aIsPrintPreview
)
{
return
NS_OK
;
}
if
(
!
mRemotePrintJob
)
{
NS_WARNING
(
"
We
can
'
t
print
via
the
parent
without
a
RemotePrintJobChild
.
"
)
;
return
NS_ERROR_FAILURE
;
}
return
NS_OK
;
}
already_AddRefed
<
PrintTarget
>
nsDeviceContextSpecProxy
:
:
MakePrintTarget
(
)
{
double
width
height
;
mPrintSettings
-
>
GetEffectiveSheetSize
(
&
width
&
height
)
;
if
(
width
<
=
0
|
|
height
<
=
0
)
{
return
nullptr
;
}
width
/
=
TWIPS_PER_POINT_FLOAT
;
height
/
=
TWIPS_PER_POINT_FLOAT
;
RefPtr
<
gfxASurface
>
surface
=
gfxPlatform
:
:
GetPlatform
(
)
-
>
CreateOffscreenSurface
(
mozilla
:
:
gfx
:
:
IntSize
:
:
Ceil
(
width
height
)
mozilla
:
:
gfx
:
:
SurfaceFormat
:
:
A8R8G8B8_UINT32
)
;
if
(
!
surface
)
{
return
nullptr
;
}
RefPtr
<
PrintTarget
>
target
=
PrintTargetThebes
:
:
CreateOrNull
(
surface
)
;
return
target
.
forget
(
)
;
}
NS_IMETHODIMP
nsDeviceContextSpecProxy
:
:
GetDrawEventRecorder
(
mozilla
:
:
gfx
:
:
DrawEventRecorder
*
*
aDrawEventRecorder
)
{
MOZ_ASSERT
(
aDrawEventRecorder
)
;
RefPtr
<
mozilla
:
:
gfx
:
:
DrawEventRecorder
>
result
=
mRecorder
;
result
.
forget
(
aDrawEventRecorder
)
;
return
NS_OK
;
}
NS_IMETHODIMP
nsDeviceContextSpecProxy
:
:
BeginDocument
(
const
nsAString
&
aTitle
const
nsAString
&
aPrintToFileName
int32_t
aStartPage
int32_t
aEndPage
)
{
if
(
!
mRemotePrintJob
|
|
mRemotePrintJob
-
>
IsDestroyed
(
)
)
{
mRemotePrintJob
=
nullptr
;
return
NS_ERROR_NOT_AVAILABLE
;
}
mRecorder
=
new
mozilla
:
:
layout
:
:
DrawEventRecorderPRFileDesc
(
)
;
nsresult
rv
=
mRemotePrintJob
-
>
InitializePrint
(
nsString
(
aTitle
)
aStartPage
aEndPage
)
;
if
(
NS_FAILED
(
rv
)
)
{
mRemotePrintJob
=
nullptr
;
}
return
rv
;
}
RefPtr
<
mozilla
:
:
gfx
:
:
PrintEndDocumentPromise
>
nsDeviceContextSpecProxy
:
:
EndDocument
(
)
{
if
(
!
mRemotePrintJob
|
|
mRemotePrintJob
-
>
IsDestroyed
(
)
)
{
mRemotePrintJob
=
nullptr
;
return
mozilla
:
:
gfx
:
:
PrintEndDocumentPromise
:
:
CreateAndReject
(
NS_ERROR_NOT_AVAILABLE
__func__
)
;
}
Unused
<
<
mRemotePrintJob
-
>
SendFinalizePrint
(
)
;
return
mozilla
:
:
gfx
:
:
PrintEndDocumentPromise
:
:
CreateAndResolve
(
true
__func__
)
;
}
NS_IMETHODIMP
nsDeviceContextSpecProxy
:
:
BeginPage
(
const
IntSize
&
aSizeInPoints
)
{
if
(
!
mRemotePrintJob
|
|
mRemotePrintJob
-
>
IsDestroyed
(
)
)
{
mRemotePrintJob
=
nullptr
;
return
NS_ERROR_NOT_AVAILABLE
;
}
mRecorder
-
>
OpenFD
(
mRemotePrintJob
-
>
GetNextPageFD
(
)
)
;
mCurrentPageSizeInPoints
=
aSizeInPoints
;
return
NS_OK
;
}
NS_IMETHODIMP
nsDeviceContextSpecProxy
:
:
EndPage
(
)
{
if
(
!
mRemotePrintJob
|
|
mRemotePrintJob
-
>
IsDestroyed
(
)
)
{
mRemotePrintJob
=
nullptr
;
return
NS_ERROR_NOT_AVAILABLE
;
}
mRecorder
-
>
Close
(
)
;
mRemotePrintJob
-
>
ProcessPage
(
mCurrentPageSizeInPoints
std
:
:
move
(
mRecorder
-
>
TakeDependentSurfaces
(
)
)
)
;
return
NS_OK
;
}
