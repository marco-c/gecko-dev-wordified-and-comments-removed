#
include
"
CompositorWidget
.
h
"
#
include
"
GLConsts
.
h
"
#
include
"
nsBaseWidget
.
h
"
#
include
"
VsyncDispatcher
.
h
"
namespace
mozilla
{
namespace
widget
{
CompositorWidget
:
:
CompositorWidget
(
const
layers
:
:
CompositorOptions
&
aOptions
)
:
mOptions
(
aOptions
)
{
}
CompositorWidget
:
:
~
CompositorWidget
(
)
{
}
already_AddRefed
<
gfx
:
:
DrawTarget
>
CompositorWidget
:
:
StartRemoteDrawing
(
)
{
return
nullptr
;
}
void
CompositorWidget
:
:
CleanupRemoteDrawing
(
)
{
mLastBackBuffer
=
nullptr
;
}
already_AddRefed
<
gfx
:
:
DrawTarget
>
CompositorWidget
:
:
GetBackBufferDrawTarget
(
gfx
:
:
DrawTarget
*
aScreenTarget
const
LayoutDeviceIntRect
&
aRect
const
LayoutDeviceIntRect
&
aClearRect
)
{
MOZ_ASSERT
(
aScreenTarget
)
;
gfx
:
:
SurfaceFormat
format
=
aScreenTarget
-
>
GetFormat
(
)
=
=
gfx
:
:
SurfaceFormat
:
:
B8G8R8X8
?
gfx
:
:
SurfaceFormat
:
:
B8G8R8X8
:
gfx
:
:
SurfaceFormat
:
:
B8G8R8A8
;
gfx
:
:
IntSize
size
=
aRect
.
ToUnknownRect
(
)
.
Size
(
)
;
gfx
:
:
IntSize
clientSize
=
Max
(
size
GetClientSize
(
)
.
ToUnknownSize
(
)
)
;
RefPtr
<
gfx
:
:
DrawTarget
>
target
;
if
(
mLastBackBuffer
&
&
mLastBackBuffer
-
>
GetBackendType
(
)
=
=
aScreenTarget
-
>
GetBackendType
(
)
&
&
mLastBackBuffer
-
>
GetFormat
(
)
=
=
format
&
&
mLastBackBuffer
-
>
GetSize
(
)
=
=
clientSize
)
{
target
=
mLastBackBuffer
;
target
-
>
SetTransform
(
gfx
:
:
Matrix
(
)
)
;
if
(
!
aClearRect
.
IsEmpty
(
)
)
{
gfx
:
:
IntRect
clearRect
=
aClearRect
.
ToUnknownRect
(
)
-
aRect
.
ToUnknownRect
(
)
.
TopLeft
(
)
;
target
-
>
ClearRect
(
gfx
:
:
Rect
(
clearRect
.
X
(
)
clearRect
.
Y
(
)
clearRect
.
Width
(
)
clearRect
.
Height
(
)
)
)
;
}
}
else
{
target
=
aScreenTarget
-
>
CreateSimilarDrawTarget
(
clientSize
format
)
;
mLastBackBuffer
=
target
;
}
return
target
.
forget
(
)
;
}
already_AddRefed
<
gfx
:
:
SourceSurface
>
CompositorWidget
:
:
EndBackBufferDrawing
(
)
{
RefPtr
<
gfx
:
:
SourceSurface
>
surface
=
mLastBackBuffer
?
mLastBackBuffer
-
>
Snapshot
(
)
:
nullptr
;
return
surface
.
forget
(
)
;
}
uint32_t
CompositorWidget
:
:
GetGLFrameBufferFormat
(
)
{
return
LOCAL_GL_RGBA
;
}
RefPtr
<
VsyncObserver
>
CompositorWidget
:
:
GetVsyncObserver
(
)
const
{
MOZ_ASSERT_UNREACHABLE
(
"
Must
be
implemented
by
derived
class
"
)
;
return
nullptr
;
}
}
}
