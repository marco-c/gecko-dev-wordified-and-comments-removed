import
imp
import
os
import
shlex
import
sys
try
:
    
from
StringIO
import
StringIO
except
ImportError
:
    
from
io
import
StringIO
old_bytecode
=
sys
.
dont_write_bytecode
sys
.
dont_write_bytecode
=
True
path
=
os
.
path
.
join
(
os
.
path
.
dirname
(
__file__
)
'
mach
'
)
if
not
os
.
path
.
exists
(
path
)
:
    
path
=
os
.
path
.
join
(
os
.
path
.
dirname
(
__file__
)
'
config
.
status
'
)
    
config
=
imp
.
load_module
(
'
_buildconfig
'
open
(
path
)
path
(
'
'
'
r
'
imp
.
PY_SOURCE
)
)
    
path
=
os
.
path
.
join
(
config
.
topsrcdir
'
mach
'
)
mach_module
=
imp
.
load_module
(
'
_mach
'
open
(
path
)
path
(
'
'
'
r
'
imp
.
PY_SOURCE
)
)
sys
.
dont_write_bytecode
=
old_bytecode
def
_is_likely_cpp_header
(
filename
)
:
    
if
not
filename
.
endswith
(
'
.
h
'
)
:
        
return
False
    
if
filename
.
endswith
(
'
Inlines
.
h
'
)
or
filename
.
endswith
(
'
-
inl
.
h
'
)
:
        
return
True
    
cpp_file
=
filename
[
:
-
1
]
+
'
cpp
'
    
return
os
.
path
.
exists
(
cpp_file
)
def
FlagsForFile
(
filename
)
:
    
mach
=
mach_module
.
get_mach
(
)
    
out
=
StringIO
(
)
    
out
.
fileno
=
lambda
:
-
1
    
out
.
encoding
=
None
    
mach
.
run
(
[
'
compileflags
'
filename
]
stdout
=
out
stderr
=
out
)
    
flag_list
=
shlex
.
split
(
out
.
getvalue
(
)
)
    
final_flags
=
[
x
for
x
in
flag_list
if
not
x
.
startswith
(
'
-
march
=
armv
'
)
]
    
if
_is_likely_cpp_header
(
filename
)
:
        
final_flags
+
=
[
"
-
x
"
"
c
+
+
"
]
    
return
{
        
'
flags
'
:
final_flags
        
'
do_cache
'
:
True
    
}
