#
include
"
lcms2_internal
.
h
"
#
define
cmsmin
(
a
b
)
(
(
(
a
)
<
(
b
)
)
?
(
a
)
:
(
b
)
)
#
define
cmsmax
(
a
b
)
(
(
(
a
)
>
(
b
)
)
?
(
a
)
:
(
b
)
)
static
cmsHTRANSFORM
CreateRoundtripXForm
(
cmsHPROFILE
hProfile
cmsUInt32Number
nIntent
)
{
cmsContext
ContextID
=
cmsGetProfileContextID
(
hProfile
)
;
cmsHPROFILE
hLab
=
cmsCreateLab4ProfileTHR
(
ContextID
NULL
)
;
cmsHTRANSFORM
xform
;
cmsBool
BPC
[
4
]
=
{
FALSE
FALSE
FALSE
FALSE
}
;
cmsFloat64Number
States
[
4
]
=
{
1
.
0
1
.
0
1
.
0
1
.
0
}
;
cmsHPROFILE
hProfiles
[
4
]
;
cmsUInt32Number
Intents
[
4
]
;
hProfiles
[
0
]
=
hLab
;
hProfiles
[
1
]
=
hProfile
;
hProfiles
[
2
]
=
hProfile
;
hProfiles
[
3
]
=
hLab
;
Intents
[
0
]
=
INTENT_RELATIVE_COLORIMETRIC
;
Intents
[
1
]
=
nIntent
;
Intents
[
2
]
=
INTENT_RELATIVE_COLORIMETRIC
;
Intents
[
3
]
=
INTENT_RELATIVE_COLORIMETRIC
;
xform
=
cmsCreateExtendedTransform
(
ContextID
4
hProfiles
BPC
Intents
States
NULL
0
TYPE_Lab_DBL
TYPE_Lab_DBL
cmsFLAGS_NOCACHE
|
cmsFLAGS_NOOPTIMIZE
)
;
cmsCloseProfile
(
hLab
)
;
return
xform
;
}
static
cmsBool
BlackPointAsDarkerColorant
(
cmsHPROFILE
hInput
cmsUInt32Number
Intent
cmsCIEXYZ
*
BlackPoint
cmsUInt32Number
dwFlags
)
{
cmsUInt16Number
*
Black
;
cmsHTRANSFORM
xform
;
cmsColorSpaceSignature
Space
;
cmsUInt32Number
nChannels
;
cmsUInt32Number
dwFormat
;
cmsHPROFILE
hLab
;
cmsCIELab
Lab
;
cmsCIEXYZ
BlackXYZ
;
cmsContext
ContextID
=
cmsGetProfileContextID
(
hInput
)
;
if
(
!
cmsIsIntentSupported
(
hInput
Intent
LCMS_USED_AS_INPUT
)
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
dwFormat
=
cmsFormatterForColorspaceOfProfile
(
hInput
2
FALSE
)
;
Space
=
cmsGetColorSpace
(
hInput
)
;
if
(
!
_cmsEndPointsBySpace
(
Space
NULL
&
Black
&
nChannels
)
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
if
(
nChannels
!
=
T_CHANNELS
(
dwFormat
)
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
hLab
=
cmsCreateLab2ProfileTHR
(
ContextID
NULL
)
;
if
(
hLab
=
=
NULL
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
xform
=
cmsCreateTransformTHR
(
ContextID
hInput
dwFormat
hLab
TYPE_Lab_DBL
Intent
cmsFLAGS_NOOPTIMIZE
|
cmsFLAGS_NOCACHE
)
;
cmsCloseProfile
(
hLab
)
;
if
(
xform
=
=
NULL
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
cmsDoTransform
(
xform
Black
&
Lab
1
)
;
Lab
.
a
=
Lab
.
b
=
0
;
if
(
Lab
.
L
>
50
)
Lab
.
L
=
50
;
cmsDeleteTransform
(
xform
)
;
cmsLab2XYZ
(
NULL
&
BlackXYZ
&
Lab
)
;
if
(
BlackPoint
!
=
NULL
)
*
BlackPoint
=
BlackXYZ
;
return
TRUE
;
cmsUNUSED_PARAMETER
(
dwFlags
)
;
}
static
cmsBool
BlackPointUsingPerceptualBlack
(
cmsCIEXYZ
*
BlackPoint
cmsHPROFILE
hProfile
)
{
cmsHTRANSFORM
hRoundTrip
;
cmsCIELab
LabIn
LabOut
;
cmsCIEXYZ
BlackXYZ
;
if
(
!
cmsIsIntentSupported
(
hProfile
INTENT_PERCEPTUAL
LCMS_USED_AS_INPUT
)
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
TRUE
;
}
hRoundTrip
=
CreateRoundtripXForm
(
hProfile
INTENT_PERCEPTUAL
)
;
if
(
hRoundTrip
=
=
NULL
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
LabIn
.
L
=
LabIn
.
a
=
LabIn
.
b
=
0
;
cmsDoTransform
(
hRoundTrip
&
LabIn
&
LabOut
1
)
;
if
(
LabOut
.
L
>
50
)
LabOut
.
L
=
50
;
LabOut
.
a
=
LabOut
.
b
=
0
;
cmsDeleteTransform
(
hRoundTrip
)
;
cmsLab2XYZ
(
NULL
&
BlackXYZ
&
LabOut
)
;
if
(
BlackPoint
!
=
NULL
)
*
BlackPoint
=
BlackXYZ
;
return
TRUE
;
}
cmsBool
CMSEXPORT
cmsDetectBlackPoint
(
cmsCIEXYZ
*
BlackPoint
cmsHPROFILE
hProfile
cmsUInt32Number
Intent
cmsUInt32Number
dwFlags
)
{
cmsProfileClassSignature
devClass
;
devClass
=
cmsGetDeviceClass
(
hProfile
)
;
if
(
devClass
=
=
cmsSigLinkClass
|
|
devClass
=
=
cmsSigAbstractClass
|
|
devClass
=
=
cmsSigNamedColorClass
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
if
(
Intent
!
=
INTENT_PERCEPTUAL
&
&
Intent
!
=
INTENT_RELATIVE_COLORIMETRIC
&
&
Intent
!
=
INTENT_SATURATION
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
if
(
(
cmsGetEncodedICCversion
(
hProfile
)
>
=
0x4000000
)
&
&
(
Intent
=
=
INTENT_PERCEPTUAL
|
|
Intent
=
=
INTENT_SATURATION
)
)
{
if
(
cmsIsMatrixShaper
(
hProfile
)
)
return
BlackPointAsDarkerColorant
(
hProfile
INTENT_RELATIVE_COLORIMETRIC
BlackPoint
0
)
;
BlackPoint
-
>
X
=
cmsPERCEPTUAL_BLACK_X
;
BlackPoint
-
>
Y
=
cmsPERCEPTUAL_BLACK_Y
;
BlackPoint
-
>
Z
=
cmsPERCEPTUAL_BLACK_Z
;
return
TRUE
;
}
#
ifdef
CMS_USE_PROFILE_BLACK_POINT_TAG
if
(
cmsIsTag
(
hProfile
cmsSigMediaBlackPointTag
)
&
&
Intent
=
=
INTENT_RELATIVE_COLORIMETRIC
)
{
cmsCIEXYZ
*
BlackPtr
BlackXYZ
UntrustedBlackPoint
TrustedBlackPoint
MediaWhite
;
cmsCIELab
Lab
;
BlackPtr
=
cmsReadTag
(
hProfile
cmsSigMediaBlackPointTag
)
;
if
(
BlackPtr
!
=
NULL
)
{
BlackXYZ
=
*
BlackPtr
;
_cmsReadMediaWhitePoint
(
&
MediaWhite
hProfile
)
;
cmsAdaptToIlluminant
(
&
UntrustedBlackPoint
&
MediaWhite
cmsD50_XYZ
(
)
&
BlackXYZ
)
;
cmsXYZ2Lab
(
NULL
&
Lab
&
UntrustedBlackPoint
)
;
Lab
.
a
=
Lab
.
b
=
0
;
if
(
Lab
.
L
>
50
)
Lab
.
L
=
50
;
cmsLab2XYZ
(
NULL
&
TrustedBlackPoint
&
Lab
)
;
if
(
BlackPoint
!
=
NULL
)
*
BlackPoint
=
TrustedBlackPoint
;
return
TRUE
;
}
}
#
endif
if
(
Intent
=
=
INTENT_RELATIVE_COLORIMETRIC
&
&
(
cmsGetDeviceClass
(
hProfile
)
=
=
cmsSigOutputClass
)
&
&
(
cmsGetColorSpace
(
hProfile
)
=
=
cmsSigCmykData
)
)
return
BlackPointUsingPerceptualBlack
(
BlackPoint
hProfile
)
;
return
BlackPointAsDarkerColorant
(
hProfile
Intent
BlackPoint
dwFlags
)
;
}
static
cmsFloat64Number
RootOfLeastSquaresFitQuadraticCurve
(
int
n
cmsFloat64Number
x
[
]
cmsFloat64Number
y
[
]
)
{
double
sum_x
=
0
sum_x2
=
0
sum_x3
=
0
sum_x4
=
0
;
double
sum_y
=
0
sum_yx
=
0
sum_yx2
=
0
;
double
d
a
b
c
;
int
i
;
cmsMAT3
m
;
cmsVEC3
v
res
;
if
(
n
<
4
)
return
0
;
for
(
i
=
0
;
i
<
n
;
i
+
+
)
{
double
xn
=
x
[
i
]
;
double
yn
=
y
[
i
]
;
sum_x
+
=
xn
;
sum_x2
+
=
xn
*
xn
;
sum_x3
+
=
xn
*
xn
*
xn
;
sum_x4
+
=
xn
*
xn
*
xn
*
xn
;
sum_y
+
=
yn
;
sum_yx
+
=
yn
*
xn
;
sum_yx2
+
=
yn
*
xn
*
xn
;
}
_cmsVEC3init
(
&
m
.
v
[
0
]
n
sum_x
sum_x2
)
;
_cmsVEC3init
(
&
m
.
v
[
1
]
sum_x
sum_x2
sum_x3
)
;
_cmsVEC3init
(
&
m
.
v
[
2
]
sum_x2
sum_x3
sum_x4
)
;
_cmsVEC3init
(
&
v
sum_y
sum_yx
sum_yx2
)
;
if
(
!
_cmsMAT3solve
(
&
res
&
m
&
v
)
)
return
0
;
a
=
res
.
n
[
2
]
;
b
=
res
.
n
[
1
]
;
c
=
res
.
n
[
0
]
;
if
(
fabs
(
a
)
<
1
.
0E
-
10
)
{
return
cmsmin
(
0
cmsmax
(
50
-
c
/
b
)
)
;
}
else
{
d
=
b
*
b
-
4
.
0
*
a
*
c
;
if
(
d
<
=
0
)
{
return
0
;
}
else
{
double
rt
=
(
-
b
+
sqrt
(
d
)
)
/
(
2
.
0
*
a
)
;
return
cmsmax
(
0
cmsmin
(
50
rt
)
)
;
}
}
}
cmsBool
CMSEXPORT
cmsDetectDestinationBlackPoint
(
cmsCIEXYZ
*
BlackPoint
cmsHPROFILE
hProfile
cmsUInt32Number
Intent
cmsUInt32Number
dwFlags
)
{
cmsColorSpaceSignature
ColorSpace
;
cmsHTRANSFORM
hRoundTrip
=
NULL
;
cmsCIELab
InitialLab
destLab
Lab
;
cmsFloat64Number
inRamp
[
256
]
outRamp
[
256
]
;
cmsFloat64Number
MinL
MaxL
;
cmsBool
NearlyStraightMidrange
=
TRUE
;
cmsFloat64Number
yRamp
[
256
]
;
cmsFloat64Number
x
[
256
]
y
[
256
]
;
cmsFloat64Number
lo
hi
;
int
n
l
;
cmsProfileClassSignature
devClass
;
devClass
=
cmsGetDeviceClass
(
hProfile
)
;
if
(
devClass
=
=
cmsSigLinkClass
|
|
devClass
=
=
cmsSigAbstractClass
|
|
devClass
=
=
cmsSigNamedColorClass
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
if
(
Intent
!
=
INTENT_PERCEPTUAL
&
&
Intent
!
=
INTENT_RELATIVE_COLORIMETRIC
&
&
Intent
!
=
INTENT_SATURATION
)
{
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
if
(
(
cmsGetEncodedICCversion
(
hProfile
)
>
=
0x4000000
)
&
&
(
Intent
=
=
INTENT_PERCEPTUAL
|
|
Intent
=
=
INTENT_SATURATION
)
)
{
if
(
cmsIsMatrixShaper
(
hProfile
)
)
return
BlackPointAsDarkerColorant
(
hProfile
INTENT_RELATIVE_COLORIMETRIC
BlackPoint
0
)
;
BlackPoint
-
>
X
=
cmsPERCEPTUAL_BLACK_X
;
BlackPoint
-
>
Y
=
cmsPERCEPTUAL_BLACK_Y
;
BlackPoint
-
>
Z
=
cmsPERCEPTUAL_BLACK_Z
;
return
TRUE
;
}
ColorSpace
=
cmsGetColorSpace
(
hProfile
)
;
if
(
!
cmsIsCLUT
(
hProfile
Intent
LCMS_USED_AS_OUTPUT
)
|
|
(
ColorSpace
!
=
cmsSigGrayData
&
&
ColorSpace
!
=
cmsSigRgbData
&
&
ColorSpace
!
=
cmsSigCmykData
)
)
{
return
cmsDetectBlackPoint
(
BlackPoint
hProfile
Intent
dwFlags
)
;
}
if
(
Intent
=
=
INTENT_RELATIVE_COLORIMETRIC
)
{
cmsCIEXYZ
IniXYZ
;
if
(
!
cmsDetectBlackPoint
(
&
IniXYZ
hProfile
Intent
dwFlags
)
)
{
return
FALSE
;
}
cmsXYZ2Lab
(
NULL
&
InitialLab
&
IniXYZ
)
;
}
else
{
InitialLab
.
L
=
0
;
InitialLab
.
a
=
0
;
InitialLab
.
b
=
0
;
}
hRoundTrip
=
CreateRoundtripXForm
(
hProfile
Intent
)
;
if
(
hRoundTrip
=
=
NULL
)
return
FALSE
;
for
(
l
=
0
;
l
<
256
;
l
+
+
)
{
Lab
.
L
=
(
cmsFloat64Number
)
(
l
*
100
.
0
)
/
255
.
0
;
Lab
.
a
=
cmsmin
(
50
cmsmax
(
-
50
InitialLab
.
a
)
)
;
Lab
.
b
=
cmsmin
(
50
cmsmax
(
-
50
InitialLab
.
b
)
)
;
cmsDoTransform
(
hRoundTrip
&
Lab
&
destLab
1
)
;
inRamp
[
l
]
=
Lab
.
L
;
outRamp
[
l
]
=
destLab
.
L
;
}
for
(
l
=
254
;
l
>
0
;
-
-
l
)
{
outRamp
[
l
]
=
cmsmin
(
outRamp
[
l
]
outRamp
[
l
+
1
]
)
;
}
if
(
!
(
outRamp
[
0
]
<
outRamp
[
255
]
)
)
{
cmsDeleteTransform
(
hRoundTrip
)
;
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
NearlyStraightMidrange
=
TRUE
;
MinL
=
outRamp
[
0
]
;
MaxL
=
outRamp
[
255
]
;
if
(
Intent
=
=
INTENT_RELATIVE_COLORIMETRIC
)
{
for
(
l
=
0
;
l
<
256
;
l
+
+
)
{
if
(
!
(
(
inRamp
[
l
]
<
=
MinL
+
0
.
2
*
(
MaxL
-
MinL
)
)
|
|
(
fabs
(
inRamp
[
l
]
-
outRamp
[
l
]
)
<
4
.
0
)
)
)
NearlyStraightMidrange
=
FALSE
;
}
if
(
NearlyStraightMidrange
)
{
cmsLab2XYZ
(
NULL
BlackPoint
&
InitialLab
)
;
cmsDeleteTransform
(
hRoundTrip
)
;
return
TRUE
;
}
}
for
(
l
=
0
;
l
<
256
;
l
+
+
)
{
yRamp
[
l
]
=
(
outRamp
[
l
]
-
MinL
)
/
(
MaxL
-
MinL
)
;
}
if
(
Intent
=
=
INTENT_RELATIVE_COLORIMETRIC
)
{
lo
=
0
.
1
;
hi
=
0
.
5
;
}
else
{
lo
=
0
.
03
;
hi
=
0
.
25
;
}
n
=
0
;
for
(
l
=
0
;
l
<
256
;
l
+
+
)
{
cmsFloat64Number
ff
=
yRamp
[
l
]
;
if
(
ff
>
=
lo
&
&
ff
<
hi
)
{
x
[
n
]
=
inRamp
[
l
]
;
y
[
n
]
=
yRamp
[
l
]
;
n
+
+
;
}
}
if
(
n
<
3
)
{
cmsDeleteTransform
(
hRoundTrip
)
;
BlackPoint
-
>
X
=
BlackPoint
-
>
Y
=
BlackPoint
-
>
Z
=
0
.
0
;
return
FALSE
;
}
Lab
.
L
=
RootOfLeastSquaresFitQuadraticCurve
(
n
x
y
)
;
if
(
Lab
.
L
<
0
.
0
)
{
Lab
.
L
=
0
;
}
Lab
.
a
=
InitialLab
.
a
;
Lab
.
b
=
InitialLab
.
b
;
cmsLab2XYZ
(
NULL
BlackPoint
&
Lab
)
;
cmsDeleteTransform
(
hRoundTrip
)
;
return
TRUE
;
}
