#
include
"
lcms2_internal
.
h
"
typedef
struct
{
cmsUInt32Number
Pointer
;
}
FILENULL
;
static
cmsUInt32Number
NULLRead
(
cmsIOHANDLER
*
iohandler
void
*
Buffer
cmsUInt32Number
size
cmsUInt32Number
count
)
{
FILENULL
*
ResData
=
(
FILENULL
*
)
iohandler
-
>
stream
;
cmsUInt32Number
len
=
size
*
count
;
ResData
-
>
Pointer
+
=
len
;
return
count
;
cmsUNUSED_PARAMETER
(
Buffer
)
;
}
static
cmsBool
NULLSeek
(
cmsIOHANDLER
*
iohandler
cmsUInt32Number
offset
)
{
FILENULL
*
ResData
=
(
FILENULL
*
)
iohandler
-
>
stream
;
ResData
-
>
Pointer
=
offset
;
return
TRUE
;
}
static
cmsUInt32Number
NULLTell
(
cmsIOHANDLER
*
iohandler
)
{
FILENULL
*
ResData
=
(
FILENULL
*
)
iohandler
-
>
stream
;
return
ResData
-
>
Pointer
;
}
static
cmsBool
NULLWrite
(
cmsIOHANDLER
*
iohandler
cmsUInt32Number
size
const
void
*
Ptr
)
{
FILENULL
*
ResData
=
(
FILENULL
*
)
iohandler
-
>
stream
;
ResData
-
>
Pointer
+
=
size
;
if
(
ResData
-
>
Pointer
>
iohandler
-
>
UsedSpace
)
iohandler
-
>
UsedSpace
=
ResData
-
>
Pointer
;
return
TRUE
;
cmsUNUSED_PARAMETER
(
Ptr
)
;
}
static
cmsBool
NULLClose
(
cmsIOHANDLER
*
iohandler
)
{
FILENULL
*
ResData
=
(
FILENULL
*
)
iohandler
-
>
stream
;
_cmsFree
(
iohandler
-
>
ContextID
ResData
)
;
_cmsFree
(
iohandler
-
>
ContextID
iohandler
)
;
return
TRUE
;
}
cmsIOHANDLER
*
CMSEXPORT
cmsOpenIOhandlerFromNULL
(
cmsContext
ContextID
)
{
struct
_cms_io_handler
*
iohandler
=
NULL
;
FILENULL
*
fm
=
NULL
;
iohandler
=
(
struct
_cms_io_handler
*
)
_cmsMallocZero
(
ContextID
sizeof
(
struct
_cms_io_handler
)
)
;
if
(
iohandler
=
=
NULL
)
return
NULL
;
fm
=
(
FILENULL
*
)
_cmsMallocZero
(
ContextID
sizeof
(
FILENULL
)
)
;
if
(
fm
=
=
NULL
)
goto
Error
;
fm
-
>
Pointer
=
0
;
iohandler
-
>
ContextID
=
ContextID
;
iohandler
-
>
stream
=
(
void
*
)
fm
;
iohandler
-
>
UsedSpace
=
0
;
iohandler
-
>
ReportedSize
=
0
;
iohandler
-
>
PhysicalFile
[
0
]
=
0
;
iohandler
-
>
Read
=
NULLRead
;
iohandler
-
>
Seek
=
NULLSeek
;
iohandler
-
>
Close
=
NULLClose
;
iohandler
-
>
Tell
=
NULLTell
;
iohandler
-
>
Write
=
NULLWrite
;
return
iohandler
;
Error
:
if
(
iohandler
)
_cmsFree
(
ContextID
iohandler
)
;
return
NULL
;
}
typedef
struct
{
cmsUInt8Number
*
Block
;
cmsUInt32Number
Size
;
cmsUInt32Number
Pointer
;
int
FreeBlockOnClose
;
}
FILEMEM
;
static
cmsUInt32Number
MemoryRead
(
struct
_cms_io_handler
*
iohandler
void
*
Buffer
cmsUInt32Number
size
cmsUInt32Number
count
)
{
FILEMEM
*
ResData
=
(
FILEMEM
*
)
iohandler
-
>
stream
;
cmsUInt8Number
*
Ptr
;
cmsUInt32Number
len
=
size
*
count
;
if
(
ResData
-
>
Pointer
+
len
>
ResData
-
>
Size
)
{
len
=
(
ResData
-
>
Size
-
ResData
-
>
Pointer
)
;
cmsSignalError
(
iohandler
-
>
ContextID
cmsERROR_READ
"
Read
from
memory
error
.
Got
%
d
bytes
block
should
be
of
%
d
bytes
"
len
count
*
size
)
;
return
0
;
}
Ptr
=
ResData
-
>
Block
;
Ptr
+
=
ResData
-
>
Pointer
;
memmove
(
Buffer
Ptr
len
)
;
ResData
-
>
Pointer
+
=
len
;
return
count
;
}
static
cmsBool
MemorySeek
(
struct
_cms_io_handler
*
iohandler
cmsUInt32Number
offset
)
{
FILEMEM
*
ResData
=
(
FILEMEM
*
)
iohandler
-
>
stream
;
if
(
offset
>
ResData
-
>
Size
)
{
cmsSignalError
(
iohandler
-
>
ContextID
cmsERROR_SEEK
"
Too
few
data
;
probably
corrupted
profile
"
)
;
return
FALSE
;
}
ResData
-
>
Pointer
=
offset
;
return
TRUE
;
}
static
cmsUInt32Number
MemoryTell
(
struct
_cms_io_handler
*
iohandler
)
{
FILEMEM
*
ResData
=
(
FILEMEM
*
)
iohandler
-
>
stream
;
if
(
ResData
=
=
NULL
)
return
0
;
return
ResData
-
>
Pointer
;
}
static
cmsBool
MemoryWrite
(
struct
_cms_io_handler
*
iohandler
cmsUInt32Number
size
const
void
*
Ptr
)
{
FILEMEM
*
ResData
=
(
FILEMEM
*
)
iohandler
-
>
stream
;
if
(
ResData
=
=
NULL
)
return
FALSE
;
if
(
ResData
-
>
Pointer
+
size
>
ResData
-
>
Size
)
{
size
=
ResData
-
>
Size
-
ResData
-
>
Pointer
;
}
if
(
size
=
=
0
)
return
TRUE
;
memmove
(
ResData
-
>
Block
+
ResData
-
>
Pointer
Ptr
size
)
;
ResData
-
>
Pointer
+
=
size
;
if
(
ResData
-
>
Pointer
>
iohandler
-
>
UsedSpace
)
iohandler
-
>
UsedSpace
=
ResData
-
>
Pointer
;
return
TRUE
;
}
static
cmsBool
MemoryClose
(
struct
_cms_io_handler
*
iohandler
)
{
FILEMEM
*
ResData
=
(
FILEMEM
*
)
iohandler
-
>
stream
;
if
(
ResData
-
>
FreeBlockOnClose
)
{
if
(
ResData
-
>
Block
)
_cmsFree
(
iohandler
-
>
ContextID
ResData
-
>
Block
)
;
}
_cmsFree
(
iohandler
-
>
ContextID
ResData
)
;
_cmsFree
(
iohandler
-
>
ContextID
iohandler
)
;
return
TRUE
;
}
cmsIOHANDLER
*
CMSEXPORT
cmsOpenIOhandlerFromMem
(
cmsContext
ContextID
void
*
Buffer
cmsUInt32Number
size
const
char
*
AccessMode
)
{
cmsIOHANDLER
*
iohandler
=
NULL
;
FILEMEM
*
fm
=
NULL
;
_cmsAssert
(
AccessMode
!
=
NULL
)
;
iohandler
=
(
cmsIOHANDLER
*
)
_cmsMallocZero
(
ContextID
sizeof
(
cmsIOHANDLER
)
)
;
if
(
iohandler
=
=
NULL
)
return
NULL
;
switch
(
*
AccessMode
)
{
case
'
r
'
:
fm
=
(
FILEMEM
*
)
_cmsMallocZero
(
ContextID
sizeof
(
FILEMEM
)
)
;
if
(
fm
=
=
NULL
)
goto
Error
;
if
(
Buffer
=
=
NULL
)
{
cmsSignalError
(
ContextID
cmsERROR_READ
"
Couldn
'
t
read
profile
from
NULL
pointer
"
)
;
goto
Error
;
}
fm
-
>
Block
=
(
cmsUInt8Number
*
)
_cmsMalloc
(
ContextID
size
)
;
if
(
fm
-
>
Block
=
=
NULL
)
{
_cmsFree
(
ContextID
fm
)
;
_cmsFree
(
ContextID
iohandler
)
;
cmsSignalError
(
ContextID
cmsERROR_READ
"
Couldn
'
t
allocate
%
ld
bytes
for
profile
"
size
)
;
return
NULL
;
}
memmove
(
fm
-
>
Block
Buffer
size
)
;
fm
-
>
FreeBlockOnClose
=
TRUE
;
fm
-
>
Size
=
size
;
fm
-
>
Pointer
=
0
;
iohandler
-
>
ReportedSize
=
size
;
break
;
case
'
w
'
:
fm
=
(
FILEMEM
*
)
_cmsMallocZero
(
ContextID
sizeof
(
FILEMEM
)
)
;
if
(
fm
=
=
NULL
)
goto
Error
;
fm
-
>
Block
=
(
cmsUInt8Number
*
)
Buffer
;
fm
-
>
FreeBlockOnClose
=
FALSE
;
fm
-
>
Size
=
size
;
fm
-
>
Pointer
=
0
;
iohandler
-
>
ReportedSize
=
0
;
break
;
default
:
cmsSignalError
(
ContextID
cmsERROR_UNKNOWN_EXTENSION
"
Unknown
access
mode
'
%
c
'
"
*
AccessMode
)
;
return
NULL
;
}
iohandler
-
>
ContextID
=
ContextID
;
iohandler
-
>
stream
=
(
void
*
)
fm
;
iohandler
-
>
UsedSpace
=
0
;
iohandler
-
>
PhysicalFile
[
0
]
=
0
;
iohandler
-
>
Read
=
MemoryRead
;
iohandler
-
>
Seek
=
MemorySeek
;
iohandler
-
>
Close
=
MemoryClose
;
iohandler
-
>
Tell
=
MemoryTell
;
iohandler
-
>
Write
=
MemoryWrite
;
return
iohandler
;
Error
:
if
(
fm
)
_cmsFree
(
ContextID
fm
)
;
if
(
iohandler
)
_cmsFree
(
ContextID
iohandler
)
;
return
NULL
;
}
static
cmsUInt32Number
FileRead
(
cmsIOHANDLER
*
iohandler
void
*
Buffer
cmsUInt32Number
size
cmsUInt32Number
count
)
{
cmsUInt32Number
nReaded
=
(
cmsUInt32Number
)
fread
(
Buffer
size
count
(
FILE
*
)
iohandler
-
>
stream
)
;
if
(
nReaded
!
=
count
)
{
cmsSignalError
(
iohandler
-
>
ContextID
cmsERROR_FILE
"
Read
error
.
Got
%
d
bytes
block
should
be
of
%
d
bytes
"
nReaded
*
size
count
*
size
)
;
return
0
;
}
return
nReaded
;
}
static
cmsBool
FileSeek
(
cmsIOHANDLER
*
iohandler
cmsUInt32Number
offset
)
{
if
(
fseek
(
(
FILE
*
)
iohandler
-
>
stream
(
long
)
offset
SEEK_SET
)
!
=
0
)
{
cmsSignalError
(
iohandler
-
>
ContextID
cmsERROR_FILE
"
Seek
error
;
probably
corrupted
file
"
)
;
return
FALSE
;
}
return
TRUE
;
}
static
cmsUInt32Number
FileTell
(
cmsIOHANDLER
*
iohandler
)
{
return
(
cmsUInt32Number
)
ftell
(
(
FILE
*
)
iohandler
-
>
stream
)
;
}
static
cmsBool
FileWrite
(
cmsIOHANDLER
*
iohandler
cmsUInt32Number
size
const
void
*
Buffer
)
{
if
(
size
=
=
0
)
return
TRUE
;
iohandler
-
>
UsedSpace
+
=
size
;
return
(
fwrite
(
Buffer
size
1
(
FILE
*
)
iohandler
-
>
stream
)
=
=
1
)
;
}
static
cmsBool
FileClose
(
cmsIOHANDLER
*
iohandler
)
{
if
(
fclose
(
(
FILE
*
)
iohandler
-
>
stream
)
!
=
0
)
return
FALSE
;
_cmsFree
(
iohandler
-
>
ContextID
iohandler
)
;
return
TRUE
;
}
cmsIOHANDLER
*
CMSEXPORT
cmsOpenIOhandlerFromFile
(
cmsContext
ContextID
const
char
*
FileName
const
char
*
AccessMode
)
{
cmsIOHANDLER
*
iohandler
=
NULL
;
FILE
*
fm
=
NULL
;
_cmsAssert
(
FileName
!
=
NULL
)
;
_cmsAssert
(
AccessMode
!
=
NULL
)
;
iohandler
=
(
cmsIOHANDLER
*
)
_cmsMallocZero
(
ContextID
sizeof
(
cmsIOHANDLER
)
)
;
if
(
iohandler
=
=
NULL
)
return
NULL
;
switch
(
*
AccessMode
)
{
case
'
r
'
:
fm
=
fopen
(
FileName
"
rb
"
)
;
if
(
fm
=
=
NULL
)
{
_cmsFree
(
ContextID
iohandler
)
;
cmsSignalError
(
ContextID
cmsERROR_FILE
"
File
'
%
s
'
not
found
"
FileName
)
;
return
NULL
;
}
iohandler
-
>
ReportedSize
=
(
cmsUInt32Number
)
cmsfilelength
(
fm
)
;
break
;
case
'
w
'
:
fm
=
fopen
(
FileName
"
wb
"
)
;
if
(
fm
=
=
NULL
)
{
_cmsFree
(
ContextID
iohandler
)
;
cmsSignalError
(
ContextID
cmsERROR_FILE
"
Couldn
'
t
create
'
%
s
'
"
FileName
)
;
return
NULL
;
}
iohandler
-
>
ReportedSize
=
0
;
break
;
default
:
_cmsFree
(
ContextID
iohandler
)
;
cmsSignalError
(
ContextID
cmsERROR_FILE
"
Unknown
access
mode
'
%
c
'
"
*
AccessMode
)
;
return
NULL
;
}
iohandler
-
>
ContextID
=
ContextID
;
iohandler
-
>
stream
=
(
void
*
)
fm
;
iohandler
-
>
UsedSpace
=
0
;
strncpy
(
iohandler
-
>
PhysicalFile
FileName
sizeof
(
iohandler
-
>
PhysicalFile
)
-
1
)
;
iohandler
-
>
PhysicalFile
[
sizeof
(
iohandler
-
>
PhysicalFile
)
-
1
]
=
0
;
iohandler
-
>
Read
=
FileRead
;
iohandler
-
>
Seek
=
FileSeek
;
iohandler
-
>
Close
=
FileClose
;
iohandler
-
>
Tell
=
FileTell
;
iohandler
-
>
Write
=
FileWrite
;
return
iohandler
;
}
cmsIOHANDLER
*
CMSEXPORT
cmsOpenIOhandlerFromStream
(
cmsContext
ContextID
FILE
*
Stream
)
{
cmsIOHANDLER
*
iohandler
=
NULL
;
iohandler
=
(
cmsIOHANDLER
*
)
_cmsMallocZero
(
ContextID
sizeof
(
cmsIOHANDLER
)
)
;
if
(
iohandler
=
=
NULL
)
return
NULL
;
iohandler
-
>
ContextID
=
ContextID
;
iohandler
-
>
stream
=
(
void
*
)
Stream
;
iohandler
-
>
UsedSpace
=
0
;
iohandler
-
>
ReportedSize
=
(
cmsUInt32Number
)
cmsfilelength
(
Stream
)
;
iohandler
-
>
PhysicalFile
[
0
]
=
0
;
iohandler
-
>
Read
=
FileRead
;
iohandler
-
>
Seek
=
FileSeek
;
iohandler
-
>
Close
=
FileClose
;
iohandler
-
>
Tell
=
FileTell
;
iohandler
-
>
Write
=
FileWrite
;
return
iohandler
;
}
cmsBool
CMSEXPORT
cmsCloseIOhandler
(
cmsIOHANDLER
*
io
)
{
return
io
-
>
Close
(
io
)
;
}
#
ifdef
_WIN32_WCE
time_t
wceex_time
(
time_t
*
timer
)
;
struct
tm
*
wceex_gmtime
(
const
time_t
*
timer
)
;
#
define
time
wceex_time
#
define
gmtime
wceex_gmtime
#
endif
cmsHPROFILE
CMSEXPORT
cmsCreateProfilePlaceholder
(
cmsContext
ContextID
)
{
time_t
now
=
time
(
NULL
)
;
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
_cmsMallocZero
(
ContextID
sizeof
(
_cmsICCPROFILE
)
)
;
if
(
Icc
=
=
NULL
)
return
NULL
;
Icc
-
>
ContextID
=
ContextID
;
Icc
-
>
TagCount
=
0
;
Icc
-
>
Version
=
0x02100000
;
memmove
(
&
Icc
-
>
Created
gmtime
(
&
now
)
sizeof
(
Icc
-
>
Created
)
)
;
Icc
-
>
UsrMutex
=
_cmsCreateMutex
(
ContextID
)
;
return
(
cmsHPROFILE
)
Icc
;
}
cmsContext
CMSEXPORT
cmsGetProfileContextID
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
if
(
Icc
=
=
NULL
)
return
NULL
;
return
Icc
-
>
ContextID
;
}
cmsInt32Number
CMSEXPORT
cmsGetTagCount
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
if
(
Icc
=
=
NULL
)
return
-
1
;
return
Icc
-
>
TagCount
;
}
cmsTagSignature
CMSEXPORT
cmsGetTagSignature
(
cmsHPROFILE
hProfile
cmsUInt32Number
n
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
if
(
n
>
Icc
-
>
TagCount
)
return
(
cmsTagSignature
)
0
;
if
(
n
>
=
MAX_TABLE_TAG
)
return
(
cmsTagSignature
)
0
;
return
Icc
-
>
TagNames
[
n
]
;
}
static
int
SearchOneTag
(
_cmsICCPROFILE
*
Profile
cmsTagSignature
sig
)
{
cmsUInt32Number
i
;
for
(
i
=
0
;
i
<
Profile
-
>
TagCount
;
i
+
+
)
{
if
(
sig
=
=
Profile
-
>
TagNames
[
i
]
)
return
i
;
}
return
-
1
;
}
int
_cmsSearchTag
(
_cmsICCPROFILE
*
Icc
cmsTagSignature
sig
cmsBool
lFollowLinks
)
{
int
n
;
cmsTagSignature
LinkedSig
;
do
{
n
=
SearchOneTag
(
Icc
sig
)
;
if
(
n
<
0
)
return
-
1
;
if
(
!
lFollowLinks
)
return
n
;
LinkedSig
=
Icc
-
>
TagLinked
[
n
]
;
if
(
LinkedSig
!
=
(
cmsTagSignature
)
0
)
{
if
(
(
sig
=
=
cmsSigRedTRCTag
|
|
sig
=
=
cmsSigGreenTRCTag
|
|
sig
=
=
cmsSigBlueTRCTag
)
&
&
(
LinkedSig
=
=
cmsSigRedColorantTag
|
|
LinkedSig
=
=
cmsSigGreenColorantTag
|
|
LinkedSig
=
=
cmsSigBlueColorantTag
)
)
{
return
n
;
}
sig
=
LinkedSig
;
}
}
while
(
LinkedSig
!
=
(
cmsTagSignature
)
0
)
;
return
n
;
}
static
void
_cmsDeleteTagByPos
(
_cmsICCPROFILE
*
Icc
int
i
)
{
_cmsAssert
(
Icc
!
=
NULL
)
;
_cmsAssert
(
i
>
=
0
)
;
if
(
Icc
-
>
TagPtrs
[
i
]
!
=
NULL
)
{
if
(
Icc
-
>
TagSaveAsRaw
[
i
]
)
{
_cmsFree
(
Icc
-
>
ContextID
Icc
-
>
TagPtrs
[
i
]
)
;
}
else
{
cmsTagTypeHandler
*
TypeHandler
=
Icc
-
>
TagTypeHandlers
[
i
]
;
if
(
TypeHandler
!
=
NULL
)
{
cmsTagTypeHandler
LocalTypeHandler
=
*
TypeHandler
;
LocalTypeHandler
.
ContextID
=
Icc
-
>
ContextID
;
LocalTypeHandler
.
ICCVersion
=
Icc
-
>
Version
;
LocalTypeHandler
.
FreePtr
(
&
LocalTypeHandler
Icc
-
>
TagPtrs
[
i
]
)
;
Icc
-
>
TagPtrs
[
i
]
=
NULL
;
}
}
}
}
static
cmsBool
_cmsNewTag
(
_cmsICCPROFILE
*
Icc
cmsTagSignature
sig
int
*
NewPos
)
{
int
i
;
i
=
_cmsSearchTag
(
Icc
sig
FALSE
)
;
if
(
i
>
=
0
)
{
_cmsDeleteTagByPos
(
Icc
i
)
;
*
NewPos
=
i
;
}
else
{
if
(
Icc
-
>
TagCount
>
=
MAX_TABLE_TAG
)
{
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_RANGE
"
Too
many
tags
(
%
d
)
"
MAX_TABLE_TAG
)
;
return
FALSE
;
}
*
NewPos
=
Icc
-
>
TagCount
;
Icc
-
>
TagCount
+
+
;
}
return
TRUE
;
}
cmsBool
CMSEXPORT
cmsIsTag
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
(
void
*
)
hProfile
;
return
_cmsSearchTag
(
Icc
sig
FALSE
)
>
=
0
;
}
cmsBool
_cmsReadHeader
(
_cmsICCPROFILE
*
Icc
)
{
cmsTagEntry
Tag
;
cmsICCHeader
Header
;
cmsUInt32Number
i
j
;
cmsUInt32Number
HeaderSize
;
cmsIOHANDLER
*
io
=
Icc
-
>
IOhandler
;
cmsUInt32Number
TagCount
;
if
(
io
-
>
Read
(
io
&
Header
sizeof
(
cmsICCHeader
)
1
)
!
=
1
)
{
return
FALSE
;
}
if
(
_cmsAdjustEndianess32
(
Header
.
magic
)
!
=
cmsMagicNumber
)
{
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_BAD_SIGNATURE
"
not
an
ICC
profile
invalid
signature
"
)
;
return
FALSE
;
}
Icc
-
>
DeviceClass
=
(
cmsProfileClassSignature
)
_cmsAdjustEndianess32
(
Header
.
deviceClass
)
;
Icc
-
>
ColorSpace
=
(
cmsColorSpaceSignature
)
_cmsAdjustEndianess32
(
Header
.
colorSpace
)
;
Icc
-
>
PCS
=
(
cmsColorSpaceSignature
)
_cmsAdjustEndianess32
(
Header
.
pcs
)
;
Icc
-
>
RenderingIntent
=
_cmsAdjustEndianess32
(
Header
.
renderingIntent
)
;
Icc
-
>
flags
=
_cmsAdjustEndianess32
(
Header
.
flags
)
;
Icc
-
>
manufacturer
=
_cmsAdjustEndianess32
(
Header
.
manufacturer
)
;
Icc
-
>
model
=
_cmsAdjustEndianess32
(
Header
.
model
)
;
Icc
-
>
creator
=
_cmsAdjustEndianess32
(
Header
.
creator
)
;
_cmsAdjustEndianess64
(
&
Icc
-
>
attributes
&
Header
.
attributes
)
;
Icc
-
>
Version
=
_cmsAdjustEndianess32
(
Header
.
version
)
;
HeaderSize
=
_cmsAdjustEndianess32
(
Header
.
size
)
;
if
(
HeaderSize
>
=
Icc
-
>
IOhandler
-
>
ReportedSize
)
HeaderSize
=
Icc
-
>
IOhandler
-
>
ReportedSize
;
_cmsDecodeDateTimeNumber
(
&
Header
.
date
&
Icc
-
>
Created
)
;
memmove
(
Icc
-
>
ProfileID
.
ID32
Header
.
profileID
.
ID32
16
)
;
if
(
!
_cmsReadUInt32Number
(
io
&
TagCount
)
)
return
FALSE
;
if
(
TagCount
>
MAX_TABLE_TAG
)
{
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_RANGE
"
Too
many
tags
(
%
d
)
"
TagCount
)
;
return
FALSE
;
}
Icc
-
>
TagCount
=
0
;
for
(
i
=
0
;
i
<
TagCount
;
i
+
+
)
{
if
(
!
_cmsReadUInt32Number
(
io
(
cmsUInt32Number
*
)
&
Tag
.
sig
)
)
return
FALSE
;
if
(
!
_cmsReadUInt32Number
(
io
&
Tag
.
offset
)
)
return
FALSE
;
if
(
!
_cmsReadUInt32Number
(
io
&
Tag
.
size
)
)
return
FALSE
;
if
(
Tag
.
offset
+
Tag
.
size
>
HeaderSize
|
|
Tag
.
offset
+
Tag
.
size
<
Tag
.
offset
)
continue
;
Icc
-
>
TagNames
[
Icc
-
>
TagCount
]
=
Tag
.
sig
;
Icc
-
>
TagOffsets
[
Icc
-
>
TagCount
]
=
Tag
.
offset
;
Icc
-
>
TagSizes
[
Icc
-
>
TagCount
]
=
Tag
.
size
;
for
(
j
=
0
;
j
<
Icc
-
>
TagCount
;
j
+
+
)
{
if
(
(
Icc
-
>
TagOffsets
[
j
]
=
=
Tag
.
offset
)
&
&
(
Icc
-
>
TagSizes
[
j
]
=
=
Tag
.
size
)
&
&
(
Icc
-
>
TagNames
[
j
]
=
=
Tag
.
sig
)
)
{
Icc
-
>
TagLinked
[
Icc
-
>
TagCount
]
=
Icc
-
>
TagNames
[
j
]
;
}
}
Icc
-
>
TagCount
+
+
;
}
return
TRUE
;
}
cmsBool
_cmsWriteHeader
(
_cmsICCPROFILE
*
Icc
cmsUInt32Number
UsedSpace
)
{
cmsICCHeader
Header
;
cmsUInt32Number
i
;
cmsTagEntry
Tag
;
cmsInt32Number
Count
=
0
;
Header
.
size
=
_cmsAdjustEndianess32
(
UsedSpace
)
;
Header
.
cmmId
=
_cmsAdjustEndianess32
(
lcmsSignature
)
;
Header
.
version
=
_cmsAdjustEndianess32
(
Icc
-
>
Version
)
;
Header
.
deviceClass
=
(
cmsProfileClassSignature
)
_cmsAdjustEndianess32
(
Icc
-
>
DeviceClass
)
;
Header
.
colorSpace
=
(
cmsColorSpaceSignature
)
_cmsAdjustEndianess32
(
Icc
-
>
ColorSpace
)
;
Header
.
pcs
=
(
cmsColorSpaceSignature
)
_cmsAdjustEndianess32
(
Icc
-
>
PCS
)
;
_cmsEncodeDateTimeNumber
(
&
Header
.
date
&
Icc
-
>
Created
)
;
Header
.
magic
=
_cmsAdjustEndianess32
(
cmsMagicNumber
)
;
#
ifdef
CMS_IS_WINDOWS_
Header
.
platform
=
(
cmsPlatformSignature
)
_cmsAdjustEndianess32
(
cmsSigMicrosoft
)
;
#
else
Header
.
platform
=
(
cmsPlatformSignature
)
_cmsAdjustEndianess32
(
cmsSigMacintosh
)
;
#
endif
Header
.
flags
=
_cmsAdjustEndianess32
(
Icc
-
>
flags
)
;
Header
.
manufacturer
=
_cmsAdjustEndianess32
(
Icc
-
>
manufacturer
)
;
Header
.
model
=
_cmsAdjustEndianess32
(
Icc
-
>
model
)
;
_cmsAdjustEndianess64
(
&
Header
.
attributes
&
Icc
-
>
attributes
)
;
Header
.
renderingIntent
=
_cmsAdjustEndianess32
(
Icc
-
>
RenderingIntent
)
;
Header
.
illuminant
.
X
=
_cmsAdjustEndianess32
(
_cmsDoubleTo15Fixed16
(
cmsD50_XYZ
(
)
-
>
X
)
)
;
Header
.
illuminant
.
Y
=
_cmsAdjustEndianess32
(
_cmsDoubleTo15Fixed16
(
cmsD50_XYZ
(
)
-
>
Y
)
)
;
Header
.
illuminant
.
Z
=
_cmsAdjustEndianess32
(
_cmsDoubleTo15Fixed16
(
cmsD50_XYZ
(
)
-
>
Z
)
)
;
Header
.
creator
=
_cmsAdjustEndianess32
(
lcmsSignature
)
;
memset
(
&
Header
.
reserved
0
sizeof
(
Header
.
reserved
)
)
;
memmove
(
&
Header
.
profileID
&
Icc
-
>
ProfileID
16
)
;
if
(
!
Icc
-
>
IOhandler
-
>
Write
(
Icc
-
>
IOhandler
sizeof
(
cmsICCHeader
)
&
Header
)
)
return
FALSE
;
for
(
i
=
0
;
i
<
Icc
-
>
TagCount
;
i
+
+
)
{
if
(
Icc
-
>
TagNames
[
i
]
!
=
0
)
Count
+
+
;
}
if
(
!
_cmsWriteUInt32Number
(
Icc
-
>
IOhandler
Count
)
)
return
FALSE
;
for
(
i
=
0
;
i
<
Icc
-
>
TagCount
;
i
+
+
)
{
if
(
Icc
-
>
TagNames
[
i
]
=
=
0
)
continue
;
Tag
.
sig
=
(
cmsTagSignature
)
_cmsAdjustEndianess32
(
(
cmsInt32Number
)
Icc
-
>
TagNames
[
i
]
)
;
Tag
.
offset
=
_cmsAdjustEndianess32
(
(
cmsInt32Number
)
Icc
-
>
TagOffsets
[
i
]
)
;
Tag
.
size
=
_cmsAdjustEndianess32
(
(
cmsInt32Number
)
Icc
-
>
TagSizes
[
i
]
)
;
if
(
!
Icc
-
>
IOhandler
-
>
Write
(
Icc
-
>
IOhandler
sizeof
(
cmsTagEntry
)
&
Tag
)
)
return
FALSE
;
}
return
TRUE
;
}
cmsUInt32Number
CMSEXPORT
cmsGetHeaderRenderingIntent
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
RenderingIntent
;
}
void
CMSEXPORT
cmsSetHeaderRenderingIntent
(
cmsHPROFILE
hProfile
cmsUInt32Number
RenderingIntent
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
RenderingIntent
=
RenderingIntent
;
}
cmsUInt32Number
CMSEXPORT
cmsGetHeaderFlags
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
(
cmsUInt32Number
)
Icc
-
>
flags
;
}
void
CMSEXPORT
cmsSetHeaderFlags
(
cmsHPROFILE
hProfile
cmsUInt32Number
Flags
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
flags
=
(
cmsUInt32Number
)
Flags
;
}
cmsUInt32Number
CMSEXPORT
cmsGetHeaderManufacturer
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
manufacturer
;
}
void
CMSEXPORT
cmsSetHeaderManufacturer
(
cmsHPROFILE
hProfile
cmsUInt32Number
manufacturer
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
manufacturer
=
manufacturer
;
}
cmsUInt32Number
CMSEXPORT
cmsGetHeaderCreator
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
creator
;
}
cmsUInt32Number
CMSEXPORT
cmsGetHeaderModel
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
model
;
}
void
CMSEXPORT
cmsSetHeaderModel
(
cmsHPROFILE
hProfile
cmsUInt32Number
model
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
model
=
model
;
}
void
CMSEXPORT
cmsGetHeaderAttributes
(
cmsHPROFILE
hProfile
cmsUInt64Number
*
Flags
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
memmove
(
Flags
&
Icc
-
>
attributes
sizeof
(
cmsUInt64Number
)
)
;
}
void
CMSEXPORT
cmsSetHeaderAttributes
(
cmsHPROFILE
hProfile
cmsUInt64Number
Flags
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
memmove
(
&
Icc
-
>
attributes
&
Flags
sizeof
(
cmsUInt64Number
)
)
;
}
void
CMSEXPORT
cmsGetHeaderProfileID
(
cmsHPROFILE
hProfile
cmsUInt8Number
*
ProfileID
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
memmove
(
ProfileID
Icc
-
>
ProfileID
.
ID8
16
)
;
}
void
CMSEXPORT
cmsSetHeaderProfileID
(
cmsHPROFILE
hProfile
cmsUInt8Number
*
ProfileID
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
memmove
(
&
Icc
-
>
ProfileID
ProfileID
16
)
;
}
cmsBool
CMSEXPORT
cmsGetHeaderCreationDateTime
(
cmsHPROFILE
hProfile
struct
tm
*
Dest
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
memmove
(
Dest
&
Icc
-
>
Created
sizeof
(
struct
tm
)
)
;
return
TRUE
;
}
cmsColorSpaceSignature
CMSEXPORT
cmsGetPCS
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
PCS
;
}
void
CMSEXPORT
cmsSetPCS
(
cmsHPROFILE
hProfile
cmsColorSpaceSignature
pcs
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
PCS
=
pcs
;
}
cmsColorSpaceSignature
CMSEXPORT
cmsGetColorSpace
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
ColorSpace
;
}
void
CMSEXPORT
cmsSetColorSpace
(
cmsHPROFILE
hProfile
cmsColorSpaceSignature
sig
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
ColorSpace
=
sig
;
}
cmsProfileClassSignature
CMSEXPORT
cmsGetDeviceClass
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
DeviceClass
;
}
void
CMSEXPORT
cmsSetDeviceClass
(
cmsHPROFILE
hProfile
cmsProfileClassSignature
sig
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
DeviceClass
=
sig
;
}
cmsUInt32Number
CMSEXPORT
cmsGetEncodedICCversion
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
return
Icc
-
>
Version
;
}
void
CMSEXPORT
cmsSetEncodedICCversion
(
cmsHPROFILE
hProfile
cmsUInt32Number
Version
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
Version
=
Version
;
}
static
cmsUInt32Number
BaseToBase
(
cmsUInt32Number
in
int
BaseIn
int
BaseOut
)
{
char
Buff
[
100
]
;
int
i
len
;
cmsUInt32Number
out
;
for
(
len
=
0
;
in
>
0
&
&
len
<
100
;
len
+
+
)
{
Buff
[
len
]
=
(
char
)
(
in
%
BaseIn
)
;
in
/
=
BaseIn
;
}
for
(
i
=
len
-
1
out
=
0
;
i
>
=
0
;
-
-
i
)
{
out
=
out
*
BaseOut
+
Buff
[
i
]
;
}
return
out
;
}
void
CMSEXPORT
cmsSetProfileVersion
(
cmsHPROFILE
hProfile
cmsFloat64Number
Version
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
Icc
-
>
Version
=
BaseToBase
(
(
cmsUInt32Number
)
floor
(
Version
*
100
.
0
+
0
.
5
)
10
16
)
<
<
16
;
}
cmsFloat64Number
CMSEXPORT
cmsGetProfileVersion
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
cmsUInt32Number
n
=
Icc
-
>
Version
>
>
16
;
return
BaseToBase
(
n
16
10
)
/
100
.
0
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromIOhandlerTHR
(
cmsContext
ContextID
cmsIOHANDLER
*
io
)
{
_cmsICCPROFILE
*
NewIcc
;
cmsHPROFILE
hEmpty
=
cmsCreateProfilePlaceholder
(
ContextID
)
;
if
(
hEmpty
=
=
NULL
)
return
NULL
;
NewIcc
=
(
_cmsICCPROFILE
*
)
hEmpty
;
NewIcc
-
>
IOhandler
=
io
;
if
(
!
_cmsReadHeader
(
NewIcc
)
)
goto
Error
;
return
hEmpty
;
Error
:
cmsCloseProfile
(
hEmpty
)
;
return
NULL
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromIOhandler2THR
(
cmsContext
ContextID
cmsIOHANDLER
*
io
cmsBool
write
)
{
_cmsICCPROFILE
*
NewIcc
;
cmsHPROFILE
hEmpty
=
cmsCreateProfilePlaceholder
(
ContextID
)
;
if
(
hEmpty
=
=
NULL
)
return
NULL
;
NewIcc
=
(
_cmsICCPROFILE
*
)
hEmpty
;
NewIcc
-
>
IOhandler
=
io
;
if
(
write
)
{
NewIcc
-
>
IsWrite
=
TRUE
;
return
hEmpty
;
}
if
(
!
_cmsReadHeader
(
NewIcc
)
)
goto
Error
;
return
hEmpty
;
Error
:
cmsCloseProfile
(
hEmpty
)
;
return
NULL
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromFileTHR
(
cmsContext
ContextID
const
char
*
lpFileName
const
char
*
sAccess
)
{
_cmsICCPROFILE
*
NewIcc
;
cmsHPROFILE
hEmpty
=
cmsCreateProfilePlaceholder
(
ContextID
)
;
if
(
hEmpty
=
=
NULL
)
return
NULL
;
NewIcc
=
(
_cmsICCPROFILE
*
)
hEmpty
;
NewIcc
-
>
IOhandler
=
cmsOpenIOhandlerFromFile
(
ContextID
lpFileName
sAccess
)
;
if
(
NewIcc
-
>
IOhandler
=
=
NULL
)
goto
Error
;
if
(
*
sAccess
=
=
'
W
'
|
|
*
sAccess
=
=
'
w
'
)
{
NewIcc
-
>
IsWrite
=
TRUE
;
return
hEmpty
;
}
if
(
!
_cmsReadHeader
(
NewIcc
)
)
goto
Error
;
return
hEmpty
;
Error
:
cmsCloseProfile
(
hEmpty
)
;
return
NULL
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromFile
(
const
char
*
ICCProfile
const
char
*
sAccess
)
{
return
cmsOpenProfileFromFileTHR
(
NULL
ICCProfile
sAccess
)
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromStreamTHR
(
cmsContext
ContextID
FILE
*
ICCProfile
const
char
*
sAccess
)
{
_cmsICCPROFILE
*
NewIcc
;
cmsHPROFILE
hEmpty
=
cmsCreateProfilePlaceholder
(
ContextID
)
;
if
(
hEmpty
=
=
NULL
)
return
NULL
;
NewIcc
=
(
_cmsICCPROFILE
*
)
hEmpty
;
NewIcc
-
>
IOhandler
=
cmsOpenIOhandlerFromStream
(
ContextID
ICCProfile
)
;
if
(
NewIcc
-
>
IOhandler
=
=
NULL
)
goto
Error
;
if
(
*
sAccess
=
=
'
w
'
)
{
NewIcc
-
>
IsWrite
=
TRUE
;
return
hEmpty
;
}
if
(
!
_cmsReadHeader
(
NewIcc
)
)
goto
Error
;
return
hEmpty
;
Error
:
cmsCloseProfile
(
hEmpty
)
;
return
NULL
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromStream
(
FILE
*
ICCProfile
const
char
*
sAccess
)
{
return
cmsOpenProfileFromStreamTHR
(
NULL
ICCProfile
sAccess
)
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromMemTHR
(
cmsContext
ContextID
const
void
*
MemPtr
cmsUInt32Number
dwSize
)
{
_cmsICCPROFILE
*
NewIcc
;
cmsHPROFILE
hEmpty
;
hEmpty
=
cmsCreateProfilePlaceholder
(
ContextID
)
;
if
(
hEmpty
=
=
NULL
)
return
NULL
;
NewIcc
=
(
_cmsICCPROFILE
*
)
hEmpty
;
NewIcc
-
>
IOhandler
=
cmsOpenIOhandlerFromMem
(
ContextID
(
void
*
)
MemPtr
dwSize
"
r
"
)
;
if
(
NewIcc
-
>
IOhandler
=
=
NULL
)
goto
Error
;
if
(
!
_cmsReadHeader
(
NewIcc
)
)
goto
Error
;
return
hEmpty
;
Error
:
cmsCloseProfile
(
hEmpty
)
;
return
NULL
;
}
cmsHPROFILE
CMSEXPORT
cmsOpenProfileFromMem
(
const
void
*
MemPtr
cmsUInt32Number
dwSize
)
{
return
cmsOpenProfileFromMemTHR
(
NULL
MemPtr
dwSize
)
;
}
static
cmsBool
SaveTags
(
_cmsICCPROFILE
*
Icc
_cmsICCPROFILE
*
FileOrig
)
{
cmsUInt8Number
*
Data
;
cmsUInt32Number
i
;
cmsUInt32Number
Begin
;
cmsIOHANDLER
*
io
=
Icc
-
>
IOhandler
;
cmsTagDescriptor
*
TagDescriptor
;
cmsTagTypeSignature
TypeBase
;
cmsTagTypeSignature
Type
;
cmsTagTypeHandler
*
TypeHandler
;
cmsFloat64Number
Version
=
cmsGetProfileVersion
(
(
cmsHPROFILE
)
Icc
)
;
cmsTagTypeHandler
LocalTypeHandler
;
for
(
i
=
0
;
i
<
Icc
-
>
TagCount
;
i
+
+
)
{
if
(
Icc
-
>
TagNames
[
i
]
=
=
0
)
continue
;
if
(
Icc
-
>
TagLinked
[
i
]
!
=
(
cmsTagSignature
)
0
)
continue
;
Icc
-
>
TagOffsets
[
i
]
=
Begin
=
io
-
>
UsedSpace
;
Data
=
(
cmsUInt8Number
*
)
Icc
-
>
TagPtrs
[
i
]
;
if
(
!
Data
)
{
if
(
FileOrig
!
=
NULL
&
&
Icc
-
>
TagOffsets
[
i
]
)
{
cmsUInt32Number
TagSize
=
FileOrig
-
>
TagSizes
[
i
]
;
cmsUInt32Number
TagOffset
=
FileOrig
-
>
TagOffsets
[
i
]
;
void
*
Mem
;
if
(
!
FileOrig
-
>
IOhandler
-
>
Seek
(
FileOrig
-
>
IOhandler
TagOffset
)
)
return
FALSE
;
Mem
=
_cmsMalloc
(
Icc
-
>
ContextID
TagSize
)
;
if
(
Mem
=
=
NULL
)
return
FALSE
;
if
(
FileOrig
-
>
IOhandler
-
>
Read
(
FileOrig
-
>
IOhandler
Mem
TagSize
1
)
!
=
1
)
return
FALSE
;
if
(
!
io
-
>
Write
(
io
TagSize
Mem
)
)
return
FALSE
;
_cmsFree
(
Icc
-
>
ContextID
Mem
)
;
Icc
-
>
TagSizes
[
i
]
=
(
io
-
>
UsedSpace
-
Begin
)
;
if
(
!
_cmsWriteAlignment
(
io
)
)
return
FALSE
;
}
continue
;
}
if
(
Icc
-
>
TagSaveAsRaw
[
i
]
)
{
if
(
io
-
>
Write
(
io
Icc
-
>
TagSizes
[
i
]
Data
)
!
=
1
)
return
FALSE
;
}
else
{
TagDescriptor
=
_cmsGetTagDescriptor
(
Icc
-
>
ContextID
Icc
-
>
TagNames
[
i
]
)
;
if
(
TagDescriptor
=
=
NULL
)
continue
;
if
(
TagDescriptor
-
>
DecideType
!
=
NULL
)
{
Type
=
TagDescriptor
-
>
DecideType
(
Version
Data
)
;
}
else
{
Type
=
TagDescriptor
-
>
SupportedTypes
[
0
]
;
}
TypeHandler
=
_cmsGetTagTypeHandler
(
Icc
-
>
ContextID
Type
)
;
if
(
TypeHandler
=
=
NULL
)
{
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_INTERNAL
"
(
Internal
)
no
handler
for
tag
%
x
"
Icc
-
>
TagNames
[
i
]
)
;
continue
;
}
TypeBase
=
TypeHandler
-
>
Signature
;
if
(
!
_cmsWriteTypeBase
(
io
TypeBase
)
)
return
FALSE
;
LocalTypeHandler
=
*
TypeHandler
;
LocalTypeHandler
.
ContextID
=
Icc
-
>
ContextID
;
LocalTypeHandler
.
ICCVersion
=
Icc
-
>
Version
;
if
(
!
LocalTypeHandler
.
WritePtr
(
&
LocalTypeHandler
io
Data
TagDescriptor
-
>
ElemCount
)
)
{
char
String
[
5
]
;
_cmsTagSignature2String
(
String
(
cmsTagSignature
)
TypeBase
)
;
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_WRITE
"
Couldn
'
t
write
type
'
%
s
'
"
String
)
;
return
FALSE
;
}
}
Icc
-
>
TagSizes
[
i
]
=
(
io
-
>
UsedSpace
-
Begin
)
;
if
(
!
_cmsWriteAlignment
(
io
)
)
return
FALSE
;
}
return
TRUE
;
}
static
cmsBool
SetLinks
(
_cmsICCPROFILE
*
Icc
)
{
cmsUInt32Number
i
;
for
(
i
=
0
;
i
<
Icc
-
>
TagCount
;
i
+
+
)
{
cmsTagSignature
lnk
=
Icc
-
>
TagLinked
[
i
]
;
if
(
lnk
!
=
(
cmsTagSignature
)
0
)
{
int
j
=
_cmsSearchTag
(
Icc
lnk
FALSE
)
;
if
(
j
>
=
0
)
{
Icc
-
>
TagOffsets
[
i
]
=
Icc
-
>
TagOffsets
[
j
]
;
Icc
-
>
TagSizes
[
i
]
=
Icc
-
>
TagSizes
[
j
]
;
}
}
}
return
TRUE
;
}
cmsUInt32Number
CMSEXPORT
cmsSaveProfileToIOhandler
(
cmsHPROFILE
hProfile
cmsIOHANDLER
*
io
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
_cmsICCPROFILE
Keep
;
cmsIOHANDLER
*
PrevIO
=
NULL
;
cmsUInt32Number
UsedSpace
;
cmsContext
ContextID
;
_cmsAssert
(
hProfile
!
=
NULL
)
;
memmove
(
&
Keep
Icc
sizeof
(
_cmsICCPROFILE
)
)
;
ContextID
=
cmsGetProfileContextID
(
hProfile
)
;
PrevIO
=
Icc
-
>
IOhandler
=
cmsOpenIOhandlerFromNULL
(
ContextID
)
;
if
(
PrevIO
=
=
NULL
)
return
0
;
if
(
!
_cmsWriteHeader
(
Icc
0
)
)
goto
Error
;
if
(
!
SaveTags
(
Icc
&
Keep
)
)
goto
Error
;
UsedSpace
=
PrevIO
-
>
UsedSpace
;
if
(
io
!
=
NULL
)
{
Icc
-
>
IOhandler
=
io
;
if
(
!
SetLinks
(
Icc
)
)
goto
Error
;
if
(
!
_cmsWriteHeader
(
Icc
UsedSpace
)
)
goto
Error
;
if
(
!
SaveTags
(
Icc
&
Keep
)
)
goto
Error
;
}
memmove
(
Icc
&
Keep
sizeof
(
_cmsICCPROFILE
)
)
;
if
(
!
cmsCloseIOhandler
(
PrevIO
)
)
return
0
;
return
UsedSpace
;
Error
:
cmsCloseIOhandler
(
PrevIO
)
;
memmove
(
Icc
&
Keep
sizeof
(
_cmsICCPROFILE
)
)
;
return
0
;
}
#
ifdef
_WIN32_WCE
int
wceex_unlink
(
const
char
*
filename
)
;
#
ifndef
remove
#
define
remove
wceex_unlink
#
endif
#
endif
cmsBool
CMSEXPORT
cmsSaveProfileToFile
(
cmsHPROFILE
hProfile
const
char
*
FileName
)
{
cmsContext
ContextID
=
cmsGetProfileContextID
(
hProfile
)
;
cmsIOHANDLER
*
io
=
cmsOpenIOhandlerFromFile
(
ContextID
FileName
"
w
"
)
;
cmsBool
rc
;
if
(
io
=
=
NULL
)
return
FALSE
;
rc
=
(
cmsSaveProfileToIOhandler
(
hProfile
io
)
!
=
0
)
;
rc
&
=
cmsCloseIOhandler
(
io
)
;
if
(
rc
=
=
FALSE
)
{
remove
(
FileName
)
;
}
return
rc
;
}
cmsBool
CMSEXPORT
cmsSaveProfileToStream
(
cmsHPROFILE
hProfile
FILE
*
Stream
)
{
cmsBool
rc
;
cmsContext
ContextID
=
cmsGetProfileContextID
(
hProfile
)
;
cmsIOHANDLER
*
io
=
cmsOpenIOhandlerFromStream
(
ContextID
Stream
)
;
if
(
io
=
=
NULL
)
return
FALSE
;
rc
=
(
cmsSaveProfileToIOhandler
(
hProfile
io
)
!
=
0
)
;
rc
&
=
cmsCloseIOhandler
(
io
)
;
return
rc
;
}
cmsBool
CMSEXPORT
cmsSaveProfileToMem
(
cmsHPROFILE
hProfile
void
*
MemPtr
cmsUInt32Number
*
BytesNeeded
)
{
cmsBool
rc
;
cmsIOHANDLER
*
io
;
cmsContext
ContextID
=
cmsGetProfileContextID
(
hProfile
)
;
_cmsAssert
(
BytesNeeded
!
=
NULL
)
;
if
(
MemPtr
=
=
NULL
)
{
*
BytesNeeded
=
cmsSaveProfileToIOhandler
(
hProfile
NULL
)
;
return
(
*
BytesNeeded
=
=
0
)
?
FALSE
:
TRUE
;
}
io
=
cmsOpenIOhandlerFromMem
(
ContextID
MemPtr
*
BytesNeeded
"
w
"
)
;
if
(
io
=
=
NULL
)
return
FALSE
;
rc
=
(
cmsSaveProfileToIOhandler
(
hProfile
io
)
!
=
0
)
;
rc
&
=
cmsCloseIOhandler
(
io
)
;
return
rc
;
}
cmsBool
CMSEXPORT
cmsCloseProfile
(
cmsHPROFILE
hProfile
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
cmsBool
rc
=
TRUE
;
cmsUInt32Number
i
;
if
(
!
Icc
)
return
FALSE
;
if
(
Icc
-
>
IsWrite
)
{
Icc
-
>
IsWrite
=
FALSE
;
rc
&
=
cmsSaveProfileToFile
(
hProfile
Icc
-
>
IOhandler
-
>
PhysicalFile
)
;
}
for
(
i
=
0
;
i
<
Icc
-
>
TagCount
;
i
+
+
)
{
if
(
Icc
-
>
TagPtrs
[
i
]
)
{
cmsTagTypeHandler
*
TypeHandler
=
Icc
-
>
TagTypeHandlers
[
i
]
;
if
(
TypeHandler
!
=
NULL
)
{
cmsTagTypeHandler
LocalTypeHandler
=
*
TypeHandler
;
LocalTypeHandler
.
ContextID
=
Icc
-
>
ContextID
;
LocalTypeHandler
.
ICCVersion
=
Icc
-
>
Version
;
LocalTypeHandler
.
FreePtr
(
&
LocalTypeHandler
Icc
-
>
TagPtrs
[
i
]
)
;
}
else
_cmsFree
(
Icc
-
>
ContextID
Icc
-
>
TagPtrs
[
i
]
)
;
}
}
if
(
Icc
-
>
IOhandler
!
=
NULL
)
{
rc
&
=
cmsCloseIOhandler
(
Icc
-
>
IOhandler
)
;
}
_cmsDestroyMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
_cmsFree
(
Icc
-
>
ContextID
Icc
)
;
return
rc
;
}
static
cmsBool
IsTypeSupported
(
cmsTagDescriptor
*
TagDescriptor
cmsTagTypeSignature
Type
)
{
cmsUInt32Number
i
nMaxTypes
;
nMaxTypes
=
TagDescriptor
-
>
nSupportedTypes
;
if
(
nMaxTypes
>
=
MAX_TYPES_IN_LCMS_PLUGIN
)
nMaxTypes
=
MAX_TYPES_IN_LCMS_PLUGIN
;
for
(
i
=
0
;
i
<
nMaxTypes
;
i
+
+
)
{
if
(
Type
=
=
TagDescriptor
-
>
SupportedTypes
[
i
]
)
return
TRUE
;
}
return
FALSE
;
}
void
*
CMSEXPORT
cmsReadTag
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
cmsIOHANDLER
*
io
=
Icc
-
>
IOhandler
;
cmsTagTypeHandler
*
TypeHandler
;
cmsTagTypeHandler
LocalTypeHandler
;
cmsTagDescriptor
*
TagDescriptor
;
cmsTagTypeSignature
BaseType
;
cmsUInt32Number
Offset
TagSize
;
cmsUInt32Number
ElemCount
;
int
n
;
if
(
!
_cmsLockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
)
return
NULL
;
n
=
_cmsSearchTag
(
Icc
sig
TRUE
)
;
if
(
n
<
0
)
goto
Error
;
if
(
Icc
-
>
TagPtrs
[
n
]
)
{
if
(
Icc
-
>
TagTypeHandlers
[
n
]
=
=
NULL
)
goto
Error
;
BaseType
=
Icc
-
>
TagTypeHandlers
[
n
]
-
>
Signature
;
if
(
BaseType
=
=
0
)
goto
Error
;
TagDescriptor
=
_cmsGetTagDescriptor
(
Icc
-
>
ContextID
sig
)
;
if
(
TagDescriptor
=
=
NULL
)
goto
Error
;
if
(
!
IsTypeSupported
(
TagDescriptor
BaseType
)
)
goto
Error
;
if
(
Icc
-
>
TagSaveAsRaw
[
n
]
)
goto
Error
;
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
Icc
-
>
TagPtrs
[
n
]
;
}
Offset
=
Icc
-
>
TagOffsets
[
n
]
;
TagSize
=
Icc
-
>
TagSizes
[
n
]
;
if
(
!
io
-
>
Seek
(
io
Offset
)
)
goto
Error
;
TagDescriptor
=
_cmsGetTagDescriptor
(
Icc
-
>
ContextID
sig
)
;
if
(
TagDescriptor
=
=
NULL
)
{
char
String
[
5
]
;
_cmsTagSignature2String
(
String
sig
)
;
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_UNKNOWN_EXTENSION
"
Unknown
tag
type
'
%
s
'
found
.
"
String
)
;
goto
Error
;
}
BaseType
=
_cmsReadTypeBase
(
io
)
;
if
(
BaseType
=
=
0
)
goto
Error
;
if
(
!
IsTypeSupported
(
TagDescriptor
BaseType
)
)
goto
Error
;
TagSize
-
=
8
;
TypeHandler
=
_cmsGetTagTypeHandler
(
Icc
-
>
ContextID
BaseType
)
;
if
(
TypeHandler
=
=
NULL
)
goto
Error
;
LocalTypeHandler
=
*
TypeHandler
;
Icc
-
>
TagTypeHandlers
[
n
]
=
TypeHandler
;
LocalTypeHandler
.
ContextID
=
Icc
-
>
ContextID
;
LocalTypeHandler
.
ICCVersion
=
Icc
-
>
Version
;
Icc
-
>
TagPtrs
[
n
]
=
LocalTypeHandler
.
ReadPtr
(
&
LocalTypeHandler
io
&
ElemCount
TagSize
)
;
if
(
Icc
-
>
TagPtrs
[
n
]
=
=
NULL
)
{
char
String
[
5
]
;
_cmsTagSignature2String
(
String
sig
)
;
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_CORRUPTION_DETECTED
"
Corrupted
tag
'
%
s
'
"
String
)
;
goto
Error
;
}
if
(
ElemCount
<
TagDescriptor
-
>
ElemCount
)
{
char
String
[
5
]
;
_cmsTagSignature2String
(
String
sig
)
;
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_CORRUPTION_DETECTED
"
'
%
s
'
Inconsistent
number
of
items
:
expected
%
d
got
%
d
"
String
TagDescriptor
-
>
ElemCount
ElemCount
)
;
}
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
Icc
-
>
TagPtrs
[
n
]
;
Error
:
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
NULL
;
}
cmsTagTypeSignature
_cmsGetTagTrueType
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
cmsTagTypeHandler
*
TypeHandler
;
int
n
;
n
=
_cmsSearchTag
(
Icc
sig
TRUE
)
;
if
(
n
<
0
)
return
(
cmsTagTypeSignature
)
0
;
TypeHandler
=
Icc
-
>
TagTypeHandlers
[
n
]
;
return
TypeHandler
-
>
Signature
;
}
cmsBool
CMSEXPORT
cmsWriteTag
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
const
void
*
data
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
cmsTagTypeHandler
*
TypeHandler
=
NULL
;
cmsTagTypeHandler
LocalTypeHandler
;
cmsTagDescriptor
*
TagDescriptor
=
NULL
;
cmsTagTypeSignature
Type
;
int
i
;
cmsFloat64Number
Version
;
char
TypeString
[
5
]
SigString
[
5
]
;
if
(
!
_cmsLockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
)
return
FALSE
;
if
(
data
=
=
NULL
)
{
i
=
_cmsSearchTag
(
Icc
sig
FALSE
)
;
if
(
i
>
=
0
)
{
_cmsDeleteTagByPos
(
Icc
i
)
;
Icc
-
>
TagNames
[
i
]
=
(
cmsTagSignature
)
0
;
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
TRUE
;
}
goto
Error
;
}
if
(
!
_cmsNewTag
(
Icc
sig
&
i
)
)
goto
Error
;
Icc
-
>
TagSaveAsRaw
[
i
]
=
FALSE
;
Icc
-
>
TagLinked
[
i
]
=
(
cmsTagSignature
)
0
;
TagDescriptor
=
_cmsGetTagDescriptor
(
Icc
-
>
ContextID
sig
)
;
if
(
TagDescriptor
=
=
NULL
)
{
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_UNKNOWN_EXTENSION
"
Unsupported
tag
'
%
x
'
"
sig
)
;
goto
Error
;
}
Version
=
cmsGetProfileVersion
(
hProfile
)
;
if
(
TagDescriptor
-
>
DecideType
!
=
NULL
)
{
Type
=
TagDescriptor
-
>
DecideType
(
Version
data
)
;
}
else
{
Type
=
TagDescriptor
-
>
SupportedTypes
[
0
]
;
}
if
(
!
IsTypeSupported
(
TagDescriptor
Type
)
)
{
_cmsTagSignature2String
(
TypeString
(
cmsTagSignature
)
Type
)
;
_cmsTagSignature2String
(
SigString
sig
)
;
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_UNKNOWN_EXTENSION
"
Unsupported
type
'
%
s
'
for
tag
'
%
s
'
"
TypeString
SigString
)
;
goto
Error
;
}
TypeHandler
=
_cmsGetTagTypeHandler
(
Icc
-
>
ContextID
Type
)
;
if
(
TypeHandler
=
=
NULL
)
{
_cmsTagSignature2String
(
TypeString
(
cmsTagSignature
)
Type
)
;
_cmsTagSignature2String
(
SigString
sig
)
;
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_UNKNOWN_EXTENSION
"
Unsupported
type
'
%
s
'
for
tag
'
%
s
'
"
TypeString
SigString
)
;
goto
Error
;
}
Icc
-
>
TagTypeHandlers
[
i
]
=
TypeHandler
;
Icc
-
>
TagNames
[
i
]
=
sig
;
Icc
-
>
TagSizes
[
i
]
=
0
;
Icc
-
>
TagOffsets
[
i
]
=
0
;
LocalTypeHandler
=
*
TypeHandler
;
LocalTypeHandler
.
ContextID
=
Icc
-
>
ContextID
;
LocalTypeHandler
.
ICCVersion
=
Icc
-
>
Version
;
Icc
-
>
TagPtrs
[
i
]
=
LocalTypeHandler
.
DupPtr
(
&
LocalTypeHandler
data
TagDescriptor
-
>
ElemCount
)
;
if
(
Icc
-
>
TagPtrs
[
i
]
=
=
NULL
)
{
_cmsTagSignature2String
(
TypeString
(
cmsTagSignature
)
Type
)
;
_cmsTagSignature2String
(
SigString
sig
)
;
cmsSignalError
(
Icc
-
>
ContextID
cmsERROR_CORRUPTION_DETECTED
"
Malformed
struct
in
type
'
%
s
'
for
tag
'
%
s
'
"
TypeString
SigString
)
;
goto
Error
;
}
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
TRUE
;
Error
:
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
FALSE
;
}
cmsInt32Number
CMSEXPORT
cmsReadRawTag
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
void
*
data
cmsUInt32Number
BufferSize
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
void
*
Object
;
int
i
;
cmsIOHANDLER
*
MemIO
;
cmsTagTypeHandler
*
TypeHandler
=
NULL
;
cmsTagTypeHandler
LocalTypeHandler
;
cmsTagDescriptor
*
TagDescriptor
=
NULL
;
cmsUInt32Number
rc
;
cmsUInt32Number
Offset
TagSize
;
if
(
!
_cmsLockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
)
return
0
;
i
=
_cmsSearchTag
(
Icc
sig
TRUE
)
;
if
(
i
<
0
)
goto
Error
;
if
(
Icc
-
>
TagPtrs
[
i
]
=
=
NULL
)
{
Offset
=
Icc
-
>
TagOffsets
[
i
]
;
TagSize
=
Icc
-
>
TagSizes
[
i
]
;
if
(
data
!
=
NULL
)
{
if
(
BufferSize
<
TagSize
)
TagSize
=
BufferSize
;
if
(
!
Icc
-
>
IOhandler
-
>
Seek
(
Icc
-
>
IOhandler
Offset
)
)
goto
Error
;
if
(
!
Icc
-
>
IOhandler
-
>
Read
(
Icc
-
>
IOhandler
data
1
TagSize
)
)
goto
Error
;
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
TagSize
;
}
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
Icc
-
>
TagSizes
[
i
]
;
}
if
(
Icc
-
>
TagSaveAsRaw
[
i
]
)
{
if
(
data
!
=
NULL
)
{
TagSize
=
Icc
-
>
TagSizes
[
i
]
;
if
(
BufferSize
<
TagSize
)
TagSize
=
BufferSize
;
memmove
(
data
Icc
-
>
TagPtrs
[
i
]
TagSize
)
;
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
TagSize
;
}
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
Icc
-
>
TagSizes
[
i
]
;
}
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
Object
=
cmsReadTag
(
hProfile
sig
)
;
if
(
!
_cmsLockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
)
return
0
;
if
(
Object
=
=
NULL
)
goto
Error
;
if
(
data
=
=
NULL
)
{
MemIO
=
cmsOpenIOhandlerFromNULL
(
cmsGetProfileContextID
(
hProfile
)
)
;
}
else
{
MemIO
=
cmsOpenIOhandlerFromMem
(
cmsGetProfileContextID
(
hProfile
)
data
BufferSize
"
w
"
)
;
}
if
(
MemIO
=
=
NULL
)
goto
Error
;
TypeHandler
=
Icc
-
>
TagTypeHandlers
[
i
]
;
TagDescriptor
=
_cmsGetTagDescriptor
(
Icc
-
>
ContextID
sig
)
;
if
(
TagDescriptor
=
=
NULL
)
{
cmsCloseIOhandler
(
MemIO
)
;
goto
Error
;
}
if
(
TypeHandler
=
=
NULL
)
goto
Error
;
LocalTypeHandler
=
*
TypeHandler
;
LocalTypeHandler
.
ContextID
=
Icc
-
>
ContextID
;
LocalTypeHandler
.
ICCVersion
=
Icc
-
>
Version
;
if
(
!
_cmsWriteTypeBase
(
MemIO
TypeHandler
-
>
Signature
)
)
{
cmsCloseIOhandler
(
MemIO
)
;
goto
Error
;
}
if
(
!
LocalTypeHandler
.
WritePtr
(
&
LocalTypeHandler
MemIO
Object
TagDescriptor
-
>
ElemCount
)
)
{
cmsCloseIOhandler
(
MemIO
)
;
goto
Error
;
}
rc
=
MemIO
-
>
Tell
(
MemIO
)
;
cmsCloseIOhandler
(
MemIO
)
;
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
rc
;
Error
:
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
0
;
}
cmsBool
CMSEXPORT
cmsWriteRawTag
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
const
void
*
data
cmsUInt32Number
Size
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
int
i
;
if
(
!
_cmsLockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
)
return
0
;
if
(
!
_cmsNewTag
(
Icc
sig
&
i
)
)
{
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
FALSE
;
}
Icc
-
>
TagSaveAsRaw
[
i
]
=
TRUE
;
Icc
-
>
TagNames
[
i
]
=
sig
;
Icc
-
>
TagLinked
[
i
]
=
(
cmsTagSignature
)
0
;
Icc
-
>
TagPtrs
[
i
]
=
_cmsDupMem
(
Icc
-
>
ContextID
data
Size
)
;
Icc
-
>
TagSizes
[
i
]
=
Size
;
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
TRUE
;
}
cmsBool
CMSEXPORT
cmsLinkTag
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
cmsTagSignature
dest
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
int
i
;
if
(
!
_cmsLockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
)
return
FALSE
;
if
(
!
_cmsNewTag
(
Icc
sig
&
i
)
)
{
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
FALSE
;
}
Icc
-
>
TagSaveAsRaw
[
i
]
=
FALSE
;
Icc
-
>
TagNames
[
i
]
=
sig
;
Icc
-
>
TagLinked
[
i
]
=
dest
;
Icc
-
>
TagPtrs
[
i
]
=
NULL
;
Icc
-
>
TagSizes
[
i
]
=
0
;
Icc
-
>
TagOffsets
[
i
]
=
0
;
_cmsUnlockMutex
(
Icc
-
>
ContextID
Icc
-
>
UsrMutex
)
;
return
TRUE
;
}
cmsTagSignature
CMSEXPORT
cmsTagLinkedTo
(
cmsHPROFILE
hProfile
cmsTagSignature
sig
)
{
_cmsICCPROFILE
*
Icc
=
(
_cmsICCPROFILE
*
)
hProfile
;
int
i
;
i
=
_cmsSearchTag
(
Icc
sig
FALSE
)
;
if
(
i
<
0
)
return
(
cmsTagSignature
)
0
;
return
Icc
-
>
TagLinked
[
i
]
;
}
