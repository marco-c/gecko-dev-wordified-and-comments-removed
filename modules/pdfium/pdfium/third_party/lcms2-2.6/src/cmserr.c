#
include
"
lcms2_internal
.
h
"
int
CMSEXPORT
cmsstrcasecmp
(
const
char
*
s1
const
char
*
s2
)
{
register
const
unsigned
char
*
us1
=
(
const
unsigned
char
*
)
s1
*
us2
=
(
const
unsigned
char
*
)
s2
;
while
(
toupper
(
*
us1
)
=
=
toupper
(
*
us2
+
+
)
)
if
(
*
us1
+
+
=
=
'
\
0
'
)
return
0
;
return
(
toupper
(
*
us1
)
-
toupper
(
*
-
-
us2
)
)
;
}
long
int
CMSEXPORT
cmsfilelength
(
FILE
*
f
)
{
long
int
p
n
;
p
=
ftell
(
f
)
;
if
(
fseek
(
f
0
SEEK_END
)
!
=
0
)
{
return
-
1
;
}
n
=
ftell
(
f
)
;
fseek
(
f
p
SEEK_SET
)
;
return
n
;
}
#
if
0
#
define
MAX_MEMORY_FOR_ALLOC
(
(
cmsUInt32Number
)
(
1024U
*
1024U
*
512U
)
)
cmsBool
_cmsRegisterMemHandlerPlugin
(
cmsContext
ContextID
cmsPluginBase
*
Plugin
)
;
static
void
*
_cmsMallocDefaultFn
(
cmsContext
ContextID
cmsUInt32Number
size
)
{
if
(
size
>
MAX_MEMORY_FOR_ALLOC
)
return
NULL
;
return
(
void
*
)
malloc
(
size
)
;
cmsUNUSED_PARAMETER
(
ContextID
)
;
}
static
void
*
_cmsMallocZeroDefaultFn
(
cmsContext
ContextID
cmsUInt32Number
size
)
{
void
*
pt
=
_cmsMalloc
(
ContextID
size
)
;
if
(
pt
=
=
NULL
)
return
NULL
;
memset
(
pt
0
size
)
;
return
pt
;
}
static
void
_cmsFreeDefaultFn
(
cmsContext
ContextID
void
*
Ptr
)
{
if
(
Ptr
)
free
(
Ptr
)
;
cmsUNUSED_PARAMETER
(
ContextID
)
;
}
static
void
*
_cmsReallocDefaultFn
(
cmsContext
ContextID
void
*
Ptr
cmsUInt32Number
size
)
{
if
(
size
>
MAX_MEMORY_FOR_ALLOC
)
return
NULL
;
return
realloc
(
Ptr
size
)
;
cmsUNUSED_PARAMETER
(
ContextID
)
;
}
static
void
*
_cmsCallocDefaultFn
(
cmsContext
ContextID
cmsUInt32Number
num
cmsUInt32Number
size
)
{
cmsUInt32Number
Total
=
num
*
size
;
if
(
Total
=
=
0
)
return
NULL
;
if
(
num
>
=
UINT_MAX
/
size
)
return
NULL
;
if
(
Total
<
num
|
|
Total
<
size
)
{
return
NULL
;
}
if
(
Total
>
MAX_MEMORY_FOR_ALLOC
)
return
NULL
;
return
_cmsMallocZero
(
ContextID
Total
)
;
}
static
void
*
_cmsDupDefaultFn
(
cmsContext
ContextID
const
void
*
Org
cmsUInt32Number
size
)
{
void
*
mem
;
if
(
size
>
MAX_MEMORY_FOR_ALLOC
)
return
NULL
;
mem
=
_cmsMalloc
(
ContextID
size
)
;
if
(
mem
!
=
NULL
&
&
Org
!
=
NULL
)
memmove
(
mem
Org
size
)
;
return
mem
;
}
_cmsMemPluginChunkType
_cmsMemPluginChunk
=
{
_cmsMallocDefaultFn
_cmsMallocZeroDefaultFn
_cmsFreeDefaultFn
_cmsReallocDefaultFn
_cmsCallocDefaultFn
_cmsDupDefaultFn
}
;
void
_cmsAllocMemPluginChunk
(
struct
_cmsContext_struct
*
ctx
const
struct
_cmsContext_struct
*
src
)
{
_cmsAssert
(
ctx
!
=
NULL
)
;
if
(
src
!
=
NULL
)
{
ctx
-
>
chunks
[
MemPlugin
]
=
_cmsSubAllocDup
(
ctx
-
>
MemPool
src
-
>
chunks
[
MemPlugin
]
sizeof
(
_cmsMemPluginChunkType
)
)
;
}
else
{
ctx
-
>
chunks
[
MemPlugin
]
=
&
ctx
-
>
DefaultMemoryManager
;
}
}
void
_cmsInstallAllocFunctions
(
cmsPluginMemHandler
*
Plugin
_cmsMemPluginChunkType
*
ptr
)
{
if
(
Plugin
=
=
NULL
)
{
memcpy
(
ptr
&
_cmsMemPluginChunk
sizeof
(
_cmsMemPluginChunk
)
)
;
}
else
{
ptr
-
>
MallocPtr
=
Plugin
-
>
MallocPtr
;
ptr
-
>
FreePtr
=
Plugin
-
>
FreePtr
;
ptr
-
>
ReallocPtr
=
Plugin
-
>
ReallocPtr
;
ptr
-
>
MallocZeroPtr
=
_cmsMallocZeroDefaultFn
;
ptr
-
>
CallocPtr
=
_cmsCallocDefaultFn
;
ptr
-
>
DupPtr
=
_cmsDupDefaultFn
;
if
(
Plugin
-
>
MallocZeroPtr
!
=
NULL
)
ptr
-
>
MallocZeroPtr
=
Plugin
-
>
MallocZeroPtr
;
if
(
Plugin
-
>
CallocPtr
!
=
NULL
)
ptr
-
>
CallocPtr
=
Plugin
-
>
CallocPtr
;
if
(
Plugin
-
>
DupPtr
!
=
NULL
)
ptr
-
>
DupPtr
=
Plugin
-
>
DupPtr
;
}
}
cmsBool
_cmsRegisterMemHandlerPlugin
(
cmsContext
ContextID
cmsPluginBase
*
Data
)
{
cmsPluginMemHandler
*
Plugin
=
(
cmsPluginMemHandler
*
)
Data
;
_cmsMemPluginChunkType
*
ptr
;
if
(
Data
=
=
NULL
)
{
struct
_cmsContext_struct
*
ctx
=
(
struct
_cmsContext_struct
*
)
ContextID
;
if
(
ContextID
!
=
NULL
)
{
ctx
-
>
chunks
[
MemPlugin
]
=
(
void
*
)
&
ctx
-
>
DefaultMemoryManager
;
}
return
TRUE
;
}
if
(
Plugin
-
>
MallocPtr
=
=
NULL
|
|
Plugin
-
>
FreePtr
=
=
NULL
|
|
Plugin
-
>
ReallocPtr
=
=
NULL
)
return
FALSE
;
ptr
=
(
_cmsMemPluginChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
MemPlugin
)
;
if
(
ptr
=
=
NULL
)
return
FALSE
;
_cmsInstallAllocFunctions
(
Plugin
ptr
)
;
return
TRUE
;
}
#
else
#
include
"
core
/
fxcrt
/
fx_memory
.
h
"
#
include
"
core
/
fxcrt
/
fx_system
.
h
"
cmsBool
_cmsRegisterMemHandlerPlugin
(
cmsContext
ContextID
cmsPluginBase
*
Plugin
)
{
return
TRUE
;
}
void
*
CMSEXPORT
_cmsMalloc
(
cmsContext
ContextID
cmsUInt32Number
size
)
{
return
FXMEM_DefaultAlloc
(
size
1
)
;
}
void
*
CMSEXPORT
_cmsMallocZero
(
cmsContext
ContextID
cmsUInt32Number
size
)
{
void
*
p
=
FXMEM_DefaultAlloc
(
size
1
)
;
if
(
p
)
FXSYS_memset
(
p
0
size
)
;
return
p
;
}
void
*
CMSEXPORT
_cmsCalloc
(
cmsContext
ContextID
cmsUInt32Number
num
cmsUInt32Number
size
)
{
cmsUInt32Number
total
=
num
*
size
;
if
(
total
=
=
0
|
|
total
/
size
!
=
num
|
|
total
>
=
512
*
1024
*
1024
)
return
NULL
;
return
_cmsMallocZero
(
ContextID
num
*
size
)
;
}
void
*
CMSEXPORT
_cmsRealloc
(
cmsContext
ContextID
void
*
Ptr
cmsUInt32Number
size
)
{
return
FXMEM_DefaultRealloc
(
Ptr
size
1
)
;
}
void
CMSEXPORT
_cmsFree
(
cmsContext
ContextID
void
*
Ptr
)
{
if
(
Ptr
!
=
NULL
)
FXMEM_DefaultFree
(
Ptr
0
)
;
}
void
*
CMSEXPORT
_cmsDupMem
(
cmsContext
ContextID
const
void
*
Org
cmsUInt32Number
size
)
{
void
*
p
=
FXMEM_DefaultAlloc
(
size
1
)
;
FXSYS_memmove
(
p
Org
size
)
;
return
p
;
}
_cmsMemPluginChunkType
_cmsMemPluginChunk
=
{
_cmsMalloc
_cmsMallocZero
_cmsFree
_cmsRealloc
_cmsCalloc
_cmsDupMem
}
;
void
_cmsAllocMemPluginChunk
(
struct
_cmsContext_struct
*
ctx
const
struct
_cmsContext_struct
*
src
)
{
_cmsAssert
(
ctx
!
=
NULL
)
;
if
(
src
!
=
NULL
)
{
ctx
-
>
chunks
[
MemPlugin
]
=
_cmsSubAllocDup
(
ctx
-
>
MemPool
src
-
>
chunks
[
MemPlugin
]
sizeof
(
_cmsMemPluginChunkType
)
)
;
}
else
{
ctx
-
>
chunks
[
MemPlugin
]
=
&
ctx
-
>
DefaultMemoryManager
;
}
}
void
_cmsInstallAllocFunctions
(
cmsPluginMemHandler
*
Plugin
_cmsMemPluginChunkType
*
ptr
)
{
if
(
Plugin
=
=
NULL
)
{
memcpy
(
ptr
&
_cmsMemPluginChunk
sizeof
(
_cmsMemPluginChunk
)
)
;
}
else
{
ptr
-
>
MallocPtr
=
Plugin
-
>
MallocPtr
;
ptr
-
>
FreePtr
=
Plugin
-
>
FreePtr
;
ptr
-
>
ReallocPtr
=
Plugin
-
>
ReallocPtr
;
ptr
-
>
MallocZeroPtr
=
_cmsMallocZero
;
ptr
-
>
CallocPtr
=
_cmsCalloc
;
ptr
-
>
DupPtr
=
_cmsDupMem
;
if
(
Plugin
-
>
MallocZeroPtr
!
=
NULL
)
ptr
-
>
MallocZeroPtr
=
Plugin
-
>
MallocZeroPtr
;
if
(
Plugin
-
>
CallocPtr
!
=
NULL
)
ptr
-
>
CallocPtr
=
Plugin
-
>
CallocPtr
;
if
(
Plugin
-
>
DupPtr
!
=
NULL
)
ptr
-
>
DupPtr
=
Plugin
-
>
DupPtr
;
}
}
#
endif
static
_cmsSubAllocator_chunk
*
_cmsCreateSubAllocChunk
(
cmsContext
ContextID
cmsUInt32Number
Initial
)
{
_cmsSubAllocator_chunk
*
chunk
;
if
(
Initial
=
=
0
)
Initial
=
20
*
1024
;
chunk
=
(
_cmsSubAllocator_chunk
*
)
_cmsMallocZero
(
ContextID
sizeof
(
_cmsSubAllocator_chunk
)
)
;
if
(
chunk
=
=
NULL
)
return
NULL
;
chunk
-
>
Block
=
(
cmsUInt8Number
*
)
_cmsMalloc
(
ContextID
Initial
)
;
if
(
chunk
-
>
Block
=
=
NULL
)
{
_cmsFree
(
ContextID
chunk
)
;
return
NULL
;
}
chunk
-
>
BlockSize
=
Initial
;
chunk
-
>
Used
=
0
;
chunk
-
>
next
=
NULL
;
return
chunk
;
}
_cmsSubAllocator
*
_cmsCreateSubAlloc
(
cmsContext
ContextID
cmsUInt32Number
Initial
)
{
_cmsSubAllocator
*
sub
;
sub
=
(
_cmsSubAllocator
*
)
_cmsMallocZero
(
ContextID
sizeof
(
_cmsSubAllocator
)
)
;
if
(
sub
=
=
NULL
)
return
NULL
;
sub
-
>
ContextID
=
ContextID
;
sub
-
>
h
=
_cmsCreateSubAllocChunk
(
ContextID
Initial
)
;
if
(
sub
-
>
h
=
=
NULL
)
{
_cmsFree
(
ContextID
sub
)
;
return
NULL
;
}
return
sub
;
}
void
_cmsSubAllocDestroy
(
_cmsSubAllocator
*
sub
)
{
_cmsSubAllocator_chunk
*
chunk
*
n
;
for
(
chunk
=
sub
-
>
h
;
chunk
!
=
NULL
;
chunk
=
n
)
{
n
=
chunk
-
>
next
;
if
(
chunk
-
>
Block
!
=
NULL
)
_cmsFree
(
sub
-
>
ContextID
chunk
-
>
Block
)
;
_cmsFree
(
sub
-
>
ContextID
chunk
)
;
}
_cmsFree
(
sub
-
>
ContextID
sub
)
;
}
void
*
_cmsSubAlloc
(
_cmsSubAllocator
*
sub
cmsUInt32Number
size
)
{
cmsUInt32Number
Free
=
sub
-
>
h
-
>
BlockSize
-
sub
-
>
h
-
>
Used
;
cmsUInt8Number
*
ptr
;
size
=
_cmsALIGNMEM
(
size
)
;
if
(
size
>
Free
)
{
_cmsSubAllocator_chunk
*
chunk
;
cmsUInt32Number
newSize
;
newSize
=
sub
-
>
h
-
>
BlockSize
*
2
;
if
(
newSize
<
size
)
newSize
=
size
;
chunk
=
_cmsCreateSubAllocChunk
(
sub
-
>
ContextID
newSize
)
;
if
(
chunk
=
=
NULL
)
return
NULL
;
chunk
-
>
next
=
sub
-
>
h
;
sub
-
>
h
=
chunk
;
}
ptr
=
sub
-
>
h
-
>
Block
+
sub
-
>
h
-
>
Used
;
sub
-
>
h
-
>
Used
+
=
size
;
return
(
void
*
)
ptr
;
}
void
*
_cmsSubAllocDup
(
_cmsSubAllocator
*
s
const
void
*
ptr
cmsUInt32Number
size
)
{
void
*
NewPtr
;
if
(
ptr
=
=
NULL
)
return
NULL
;
NewPtr
=
_cmsSubAlloc
(
s
size
)
;
if
(
ptr
!
=
NULL
&
&
NewPtr
!
=
NULL
)
{
memcpy
(
NewPtr
ptr
size
)
;
}
return
NewPtr
;
}
#
define
MAX_ERROR_MESSAGE_LEN
1024
static
void
DefaultLogErrorHandlerFunction
(
cmsContext
ContextID
cmsUInt32Number
ErrorCode
const
char
*
Text
)
;
_cmsLogErrorChunkType
_cmsLogErrorChunk
=
{
DefaultLogErrorHandlerFunction
}
;
void
_cmsAllocLogErrorChunk
(
struct
_cmsContext_struct
*
ctx
const
struct
_cmsContext_struct
*
src
)
{
static
_cmsLogErrorChunkType
LogErrorChunk
=
{
DefaultLogErrorHandlerFunction
}
;
void
*
from
;
if
(
src
!
=
NULL
)
{
from
=
src
-
>
chunks
[
Logger
]
;
}
else
{
from
=
&
LogErrorChunk
;
}
ctx
-
>
chunks
[
Logger
]
=
_cmsSubAllocDup
(
ctx
-
>
MemPool
from
sizeof
(
_cmsLogErrorChunkType
)
)
;
}
static
void
DefaultLogErrorHandlerFunction
(
cmsContext
ContextID
cmsUInt32Number
ErrorCode
const
char
*
Text
)
{
cmsUNUSED_PARAMETER
(
ContextID
)
;
cmsUNUSED_PARAMETER
(
ErrorCode
)
;
cmsUNUSED_PARAMETER
(
Text
)
;
}
void
CMSEXPORT
cmsSetLogErrorHandlerTHR
(
cmsContext
ContextID
cmsLogErrorHandlerFunction
Fn
)
{
_cmsLogErrorChunkType
*
lhg
=
(
_cmsLogErrorChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
Logger
)
;
if
(
lhg
!
=
NULL
)
{
if
(
Fn
=
=
NULL
)
lhg
-
>
LogErrorHandler
=
DefaultLogErrorHandlerFunction
;
else
lhg
-
>
LogErrorHandler
=
Fn
;
}
}
void
CMSEXPORT
cmsSetLogErrorHandler
(
cmsLogErrorHandlerFunction
Fn
)
{
cmsSetLogErrorHandlerTHR
(
NULL
Fn
)
;
}
void
CMSEXPORT
cmsSignalError
(
cmsContext
ContextID
cmsUInt32Number
ErrorCode
const
char
*
ErrorText
.
.
.
)
{
va_list
args
;
char
Buffer
[
MAX_ERROR_MESSAGE_LEN
]
;
_cmsLogErrorChunkType
*
lhg
;
va_start
(
args
ErrorText
)
;
vsnprintf
(
Buffer
MAX_ERROR_MESSAGE_LEN
-
1
ErrorText
args
)
;
va_end
(
args
)
;
lhg
=
(
_cmsLogErrorChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
Logger
)
;
if
(
lhg
-
>
LogErrorHandler
)
{
lhg
-
>
LogErrorHandler
(
ContextID
ErrorCode
Buffer
)
;
}
}
void
_cmsTagSignature2String
(
char
String
[
5
]
cmsTagSignature
sig
)
{
cmsUInt32Number
be
;
be
=
_cmsAdjustEndianess32
(
(
cmsUInt32Number
)
sig
)
;
memmove
(
String
&
be
4
)
;
String
[
4
]
=
0
;
}
static
void
*
defMtxCreate
(
cmsContext
id
)
{
_cmsMutex
*
ptr_mutex
=
(
_cmsMutex
*
)
_cmsMalloc
(
id
sizeof
(
_cmsMutex
)
)
;
_cmsInitMutexPrimitive
(
ptr_mutex
)
;
return
(
void
*
)
ptr_mutex
;
}
static
void
defMtxDestroy
(
cmsContext
id
void
*
mtx
)
{
_cmsDestroyMutexPrimitive
(
(
_cmsMutex
*
)
mtx
)
;
_cmsFree
(
id
mtx
)
;
}
static
cmsBool
defMtxLock
(
cmsContext
id
void
*
mtx
)
{
cmsUNUSED_PARAMETER
(
id
)
;
return
_cmsLockPrimitive
(
(
_cmsMutex
*
)
mtx
)
=
=
0
;
}
static
void
defMtxUnlock
(
cmsContext
id
void
*
mtx
)
{
cmsUNUSED_PARAMETER
(
id
)
;
_cmsUnlockPrimitive
(
(
_cmsMutex
*
)
mtx
)
;
}
_cmsMutexPluginChunkType
_cmsMutexPluginChunk
=
{
defMtxCreate
defMtxDestroy
defMtxLock
defMtxUnlock
}
;
void
_cmsAllocMutexPluginChunk
(
struct
_cmsContext_struct
*
ctx
const
struct
_cmsContext_struct
*
src
)
{
static
_cmsMutexPluginChunkType
MutexChunk
=
{
defMtxCreate
defMtxDestroy
defMtxLock
defMtxUnlock
}
;
void
*
from
;
if
(
src
!
=
NULL
)
{
from
=
src
-
>
chunks
[
MutexPlugin
]
;
}
else
{
from
=
&
MutexChunk
;
}
ctx
-
>
chunks
[
MutexPlugin
]
=
_cmsSubAllocDup
(
ctx
-
>
MemPool
from
sizeof
(
_cmsMutexPluginChunkType
)
)
;
}
cmsBool
_cmsRegisterMutexPlugin
(
cmsContext
ContextID
cmsPluginBase
*
Data
)
{
cmsPluginMutex
*
Plugin
=
(
cmsPluginMutex
*
)
Data
;
_cmsMutexPluginChunkType
*
ctx
=
(
_cmsMutexPluginChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
MutexPlugin
)
;
if
(
Data
=
=
NULL
)
{
ctx
-
>
CreateMutexPtr
=
NULL
;
ctx
-
>
DestroyMutexPtr
=
NULL
;
ctx
-
>
LockMutexPtr
=
NULL
;
ctx
-
>
UnlockMutexPtr
=
NULL
;
return
TRUE
;
}
if
(
Plugin
-
>
CreateMutexPtr
=
=
NULL
|
|
Plugin
-
>
DestroyMutexPtr
=
=
NULL
|
|
Plugin
-
>
LockMutexPtr
=
=
NULL
|
|
Plugin
-
>
UnlockMutexPtr
=
=
NULL
)
return
FALSE
;
ctx
-
>
CreateMutexPtr
=
Plugin
-
>
CreateMutexPtr
;
ctx
-
>
DestroyMutexPtr
=
Plugin
-
>
DestroyMutexPtr
;
ctx
-
>
LockMutexPtr
=
Plugin
-
>
LockMutexPtr
;
ctx
-
>
UnlockMutexPtr
=
Plugin
-
>
UnlockMutexPtr
;
return
TRUE
;
}
void
*
CMSEXPORT
_cmsCreateMutex
(
cmsContext
ContextID
)
{
_cmsMutexPluginChunkType
*
ptr
=
(
_cmsMutexPluginChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
MutexPlugin
)
;
if
(
ptr
-
>
CreateMutexPtr
=
=
NULL
)
return
NULL
;
return
ptr
-
>
CreateMutexPtr
(
ContextID
)
;
}
void
CMSEXPORT
_cmsDestroyMutex
(
cmsContext
ContextID
void
*
mtx
)
{
_cmsMutexPluginChunkType
*
ptr
=
(
_cmsMutexPluginChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
MutexPlugin
)
;
if
(
ptr
-
>
DestroyMutexPtr
!
=
NULL
)
{
ptr
-
>
DestroyMutexPtr
(
ContextID
mtx
)
;
}
}
cmsBool
CMSEXPORT
_cmsLockMutex
(
cmsContext
ContextID
void
*
mtx
)
{
_cmsMutexPluginChunkType
*
ptr
=
(
_cmsMutexPluginChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
MutexPlugin
)
;
if
(
ptr
-
>
LockMutexPtr
=
=
NULL
)
return
TRUE
;
return
ptr
-
>
LockMutexPtr
(
ContextID
mtx
)
;
}
void
CMSEXPORT
_cmsUnlockMutex
(
cmsContext
ContextID
void
*
mtx
)
{
_cmsMutexPluginChunkType
*
ptr
=
(
_cmsMutexPluginChunkType
*
)
_cmsContextGetClientChunk
(
ContextID
MutexPlugin
)
;
if
(
ptr
-
>
UnlockMutexPtr
!
=
NULL
)
{
ptr
-
>
UnlockMutexPtr
(
ContextID
mtx
)
;
}
}
