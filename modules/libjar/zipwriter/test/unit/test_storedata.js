const
DATA
=
"
ZIP
WRITER
TEST
DATA
"
;
const
FILENAME
=
"
test
.
txt
"
;
const
CRC
=
0xe6164331
;
const
time
=
1199145600000
;
function
testpass
(
source
)
{
Assert
.
ok
(
source
.
hasEntry
(
FILENAME
)
)
;
var
entry
=
source
.
getEntry
(
FILENAME
)
;
Assert
.
notEqual
(
entry
null
)
;
Assert
.
ok
(
!
entry
.
isDirectory
)
;
Assert
.
equal
(
entry
.
compression
ZIP_METHOD_STORE
)
;
Assert
.
equal
(
entry
.
lastModifiedTime
/
PR_USEC_PER_MSEC
time
)
;
Assert
.
equal
(
entry
.
realSize
DATA
.
length
)
;
Assert
.
equal
(
entry
.
size
entry
.
realSize
)
;
Assert
.
equal
(
entry
.
CRC32
CRC
)
;
}
function
run_test
(
)
{
zipW
.
open
(
tmpFile
PR_RDWR
|
PR_CREATE_FILE
|
PR_TRUNCATE
)
;
Assert
.
ok
(
!
zipW
.
hasEntry
(
FILENAME
)
)
;
Assert
.
ok
(
!
zipW
.
inQueue
)
;
var
stream
=
Cc
[
"
mozilla
.
org
/
io
/
string
-
input
-
stream
;
1
"
]
.
createInstance
(
Ci
.
nsIStringInputStream
)
;
stream
.
setByteStringData
(
DATA
)
;
zipW
.
addEntryStream
(
FILENAME
time
*
PR_USEC_PER_MSEC
Ci
.
nsIZipWriter
.
COMPRESSION_NONE
stream
false
)
;
testpass
(
zipW
)
;
zipW
.
close
(
)
;
Assert
.
equal
(
tmpFile
.
fileSize
DATA
.
length
+
ZIP_FILE_HEADER_SIZE
+
ZIP_CDS_HEADER_SIZE
+
ZIP_EXTENDED_TIMESTAMP_SIZE
*
2
+
FILENAME
.
length
*
2
+
ZIP_EOCDR_HEADER_SIZE
)
;
zipW
.
open
(
tmpFile
PR_RDWR
)
;
testpass
(
zipW
)
;
zipW
.
close
(
)
;
var
zipR
=
new
ZipReader
(
tmpFile
)
;
testpass
(
zipR
)
;
zipR
.
test
(
FILENAME
)
;
stream
=
Cc
[
"
mozilla
.
org
/
scriptableinputstream
;
1
"
]
.
createInstance
(
Ci
.
nsIScriptableInputStream
)
;
stream
.
init
(
zipR
.
getInputStream
(
FILENAME
)
)
;
var
result
=
stream
.
read
(
DATA
.
length
)
;
stream
.
close
(
)
;
zipR
.
close
(
)
;
Assert
.
equal
(
result
DATA
)
;
}
