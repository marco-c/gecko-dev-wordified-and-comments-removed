#
ifndef
nsJARINPUTSTREAM_h__
#
define
nsJARINPUTSTREAM_h__
#
include
"
nsIInputStream
.
h
"
#
include
"
nsJAR
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
mozilla
/
Attributes
.
h
"
#
ifdef
MOZ_JAR_BROTLI
struct
BrotliDecoderStateStruct
;
#
endif
class
nsJARInputStream
final
:
public
nsIInputStream
{
public
:
nsJARInputStream
(
)
:
mOutSize
(
0
)
mInCrc
(
0
)
mOutCrc
(
0
)
#
ifdef
MOZ_JAR_BROTLI
mBrotliState
(
nullptr
)
#
endif
mNameLen
(
0
)
mCurPos
(
0
)
mArrPos
(
0
)
mMode
(
MODE_NOTINITED
)
{
memset
(
&
mZs
0
sizeof
(
z_stream
)
)
;
}
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIINPUTSTREAM
nsresult
InitFile
(
nsJAR
*
aJar
nsZipItem
*
item
)
;
nsresult
InitDirectory
(
nsJAR
*
aJar
const
nsACString
&
aJarDirSpec
const
char
*
aDir
)
;
private
:
~
nsJARInputStream
(
)
{
Close
(
)
;
}
RefPtr
<
nsZipHandle
>
mFd
;
uint32_t
mOutSize
;
uint32_t
mInCrc
;
uint32_t
mOutCrc
;
z_stream
mZs
;
#
ifdef
MOZ_JAR_BROTLI
BrotliDecoderStateStruct
*
mBrotliState
;
#
endif
RefPtr
<
nsJAR
>
mJar
;
uint32_t
mNameLen
;
nsCString
mBuffer
;
uint32_t
mCurPos
;
uint32_t
mArrPos
;
nsTArray
<
nsCString
>
mArray
;
typedef
enum
{
MODE_NOTINITED
MODE_CLOSED
MODE_DIRECTORY
MODE_INFLATE
#
ifdef
MOZ_JAR_BROTLI
MODE_BROTLI
#
endif
MODE_COPY
}
JISMode
;
JISMode
mMode
;
nsresult
ContinueInflate
(
char
*
aBuf
uint32_t
aCount
uint32_t
*
aBytesRead
)
;
nsresult
ReadDirectory
(
char
*
aBuf
uint32_t
aCount
uint32_t
*
aBytesRead
)
;
uint32_t
CopyDataToBuffer
(
char
*
&
aBuffer
uint32_t
&
aCount
)
;
}
;
#
endif
