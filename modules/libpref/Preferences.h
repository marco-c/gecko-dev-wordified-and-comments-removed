#
ifndef
mozilla_Preferences_h
#
define
mozilla_Preferences_h
#
ifndef
MOZILLA_INTERNAL_API
#
error
"
This
header
is
only
usable
from
within
libxul
(
MOZILLA_INTERNAL_API
)
.
"
#
endif
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsIPrefBranch
.
h
"
#
include
"
nsIPrefService
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsWeakReference
.
h
"
class
nsIFile
;
typedef
void
(
*
PrefChangedFunc
)
(
const
char
*
aPref
void
*
aData
)
;
#
ifdef
DEBUG
enum
pref_initPhase
{
START
BEGIN_INIT_PREFS
END_INIT_PREFS
BEGIN_ALL_PREFS
END_ALL_PREFS
}
;
#
define
SET_PREF_PHASE
(
p
)
Preferences
:
:
SetInitPhase
(
p
)
#
else
#
define
SET_PREF_PHASE
(
p
)
\
do
{
\
}
while
(
0
)
#
endif
namespace
mozilla
{
namespace
dom
{
class
PrefSetting
;
}
enum
class
PrefValueKind
{
Default
User
}
;
class
Preferences
final
:
public
nsIPrefService
public
nsIObserver
public
nsIPrefBranch
public
nsSupportsWeakReference
{
public
:
typedef
mozilla
:
:
dom
:
:
PrefSetting
PrefSetting
;
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIPREFSERVICE
NS_FORWARD_NSIPREFBRANCH
(
mRootBranch
-
>
)
NS_DECL_NSIOBSERVER
Preferences
(
)
;
static
bool
IsServiceAvailable
(
)
;
static
void
InitializeUserPrefs
(
)
;
static
already_AddRefed
<
Preferences
>
GetInstanceForService
(
)
;
static
void
Shutdown
(
)
;
static
nsIPrefService
*
GetService
(
)
{
NS_ENSURE_TRUE
(
InitStaticMembers
(
)
nullptr
)
;
return
sPreferences
;
}
static
nsIPrefBranch
*
GetRootBranch
(
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
NS_ENSURE_TRUE
(
InitStaticMembers
(
)
nullptr
)
;
return
(
aKind
=
=
PrefValueKind
:
:
Default
)
?
sPreferences
-
>
mDefaultRootBranch
:
sPreferences
-
>
mRootBranch
;
}
static
int32_t
GetType
(
const
char
*
aPrefName
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetBool
(
const
char
*
aPrefName
bool
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetInt
(
const
char
*
aPrefName
int32_t
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetUint
(
const
char
*
aPrefName
uint32_t
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
GetInt
(
aPrefName
reinterpret_cast
<
int32_t
*
>
(
aResult
)
aKind
)
;
}
static
nsresult
GetFloat
(
const
char
*
aPrefName
float
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetCString
(
const
char
*
aPrefName
nsACString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetString
(
const
char
*
aPrefName
nsAString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetLocalizedCString
(
const
char
*
aPrefName
nsACString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetLocalizedString
(
const
char
*
aPrefName
nsAString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetComplex
(
const
char
*
aPrefName
const
nsIID
&
aType
void
*
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
bool
GetBool
(
const
char
*
aPrefName
bool
aFallback
=
false
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
bool
result
=
aFallback
;
GetBool
(
aPrefName
&
result
)
;
return
result
;
}
static
int32_t
GetInt
(
const
char
*
aPrefName
int32_t
aFallback
=
0
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
int32_t
result
=
aFallback
;
GetInt
(
aPrefName
&
result
)
;
return
result
;
}
static
uint32_t
GetUint
(
const
char
*
aPrefName
uint32_t
aFallback
=
0
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
uint32_t
result
=
aFallback
;
GetUint
(
aPrefName
&
result
)
;
return
result
;
}
static
float
GetFloat
(
const
char
*
aPrefName
float
aFallback
=
0
.
0f
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
float
result
=
aFallback
;
GetFloat
(
aPrefName
&
result
)
;
return
result
;
}
static
nsresult
SetBool
(
const
char
*
aPrefName
bool
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetInt
(
const
char
*
aPrefName
int32_t
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetUint
(
const
char
*
aPrefName
uint32_t
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
SetInt
(
aPrefName
static_cast
<
int32_t
>
(
aValue
)
aKind
)
;
}
static
nsresult
SetFloat
(
const
char
*
aPrefName
float
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetCString
(
const
char
*
aPrefName
const
char
*
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetCString
(
const
char
*
aPrefName
const
nsACString
&
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetString
(
const
char
*
aPrefName
const
char16ptr_t
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetString
(
const
char
*
aPrefName
const
nsAString
&
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetComplex
(
const
char
*
aPrefName
const
nsIID
&
aType
nsISupports
*
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
ClearUser
(
const
char
*
aPref
)
;
static
bool
HasUserValue
(
const
char
*
aPref
)
;
static
nsresult
AddStrongObserver
(
nsIObserver
*
aObserver
const
char
*
aPref
)
;
static
nsresult
AddWeakObserver
(
nsIObserver
*
aObserver
const
char
*
aPref
)
;
static
nsresult
RemoveObserver
(
nsIObserver
*
aObserver
const
char
*
aPref
)
;
static
nsresult
AddStrongObservers
(
nsIObserver
*
aObserver
const
char
*
*
aPrefs
)
;
static
nsresult
AddWeakObservers
(
nsIObserver
*
aObserver
const
char
*
*
aPrefs
)
;
static
nsresult
RemoveObservers
(
nsIObserver
*
aObserver
const
char
*
*
aPrefs
)
;
static
nsresult
RegisterCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallback
(
aCallback
aPref
aClosure
ExactMatch
)
;
}
static
nsresult
UnregisterCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
=
nullptr
)
{
return
UnregisterCallback
(
aCallback
aPref
aClosure
ExactMatch
)
;
}
static
nsresult
RegisterCallbackAndCall
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallbackAndCall
(
aCallback
aPref
aClosure
ExactMatch
)
;
}
static
nsresult
RegisterPrefixCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallback
(
aCallback
aPref
aClosure
PrefixMatch
)
;
}
static
nsresult
RegisterPrefixCallbackAndCall
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallbackAndCall
(
aCallback
aPref
aClosure
PrefixMatch
)
;
}
static
nsresult
UnregisterPrefixCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
=
nullptr
)
{
return
UnregisterCallback
(
aCallback
aPref
aClosure
PrefixMatch
)
;
}
static
nsresult
AddBoolVarCache
(
bool
*
aVariable
const
char
*
aPref
bool
aDefault
=
false
)
;
static
nsresult
AddIntVarCache
(
int32_t
*
aVariable
const
char
*
aPref
int32_t
aDefault
=
0
)
;
static
nsresult
AddUintVarCache
(
uint32_t
*
aVariable
const
char
*
aPref
uint32_t
aDefault
=
0
)
;
template
<
MemoryOrdering
Order
>
static
nsresult
AddAtomicUintVarCache
(
Atomic
<
uint32_t
Order
>
*
aVariable
const
char
*
aPref
uint32_t
aDefault
=
0
)
;
static
nsresult
AddFloatVarCache
(
float
*
aVariable
const
char
*
aPref
float
aDefault
=
0
.
0f
)
;
static
void
GetPreferences
(
InfallibleTArray
<
PrefSetting
>
*
aPrefs
)
;
static
void
SetInitPreferences
(
nsTArray
<
PrefSetting
>
*
aPrefs
)
;
static
void
GetPreference
(
PrefSetting
*
aPref
)
;
static
void
SetPreference
(
const
PrefSetting
&
aPref
)
;
#
ifdef
DEBUG
static
void
SetInitPhase
(
pref_initPhase
phase
)
;
static
pref_initPhase
InitPhase
(
)
;
#
endif
static
int64_t
SizeOfIncludingThisAndOtherStuff
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
)
;
static
void
HandleDirty
(
)
;
nsresult
SavePrefFileBlocking
(
)
;
nsresult
SavePrefFileAsynchronous
(
)
;
protected
:
virtual
~
Preferences
(
)
;
nsresult
NotifyServiceObservers
(
const
char
*
aSubject
)
;
already_AddRefed
<
nsIFile
>
ReadSavedPrefs
(
)
;
void
ReadUserOverridePrefs
(
)
;
nsresult
MakeBackupPrefFile
(
nsIFile
*
aFile
)
;
enum
class
SaveMethod
{
Blocking
Asynchronous
}
;
nsresult
SavePrefFileInternal
(
nsIFile
*
aFile
SaveMethod
aSaveMethod
)
;
nsresult
WritePrefFile
(
nsIFile
*
aFile
SaveMethod
aSaveMethod
)
;
bool
AllowOffMainThreadSave
(
)
;
public
:
enum
MatchKind
{
PrefixMatch
ExactMatch
}
;
protected
:
static
nsresult
RegisterCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
MatchKind
aMatchKind
)
;
static
nsresult
UnregisterCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
MatchKind
aMatchKind
)
;
static
nsresult
RegisterCallbackAndCall
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
MatchKind
aMatchKind
)
;
private
:
nsCOMPtr
<
nsIFile
>
mCurrentFile
;
bool
mDirty
=
false
;
bool
mProfileShutdown
=
false
;
bool
mSavePending
=
false
;
nsCOMPtr
<
nsIPrefBranch
>
mRootBranch
;
nsCOMPtr
<
nsIPrefBranch
>
mDefaultRootBranch
;
static
StaticRefPtr
<
Preferences
>
sPreferences
;
static
bool
sShutdown
;
static
bool
InitStaticMembers
(
)
;
}
;
}
#
endif
