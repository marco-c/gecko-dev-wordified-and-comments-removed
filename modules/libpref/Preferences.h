#
ifndef
mozilla_Preferences_h
#
define
mozilla_Preferences_h
#
ifndef
MOZILLA_INTERNAL_API
#
error
"
This
header
is
only
usable
from
within
libxul
(
MOZILLA_INTERNAL_API
)
.
"
#
endif
#
include
"
mozilla
/
Atomics
.
h
"
#
include
"
mozilla
/
MemoryReporting
.
h
"
#
include
"
mozilla
/
Result
.
h
"
#
include
"
mozilla
/
StaticPtr
.
h
"
#
include
"
nsCOMPtr
.
h
"
#
include
"
nsIObserver
.
h
"
#
include
"
nsIPrefBranch
.
h
"
#
include
"
nsIPrefService
.
h
"
#
include
"
nsPrintfCString
.
h
"
#
include
"
nsString
.
h
"
#
include
"
nsTArray
.
h
"
#
include
"
nsWeakReference
.
h
"
class
nsIFile
;
typedef
void
(
*
PrefChangedFunc
)
(
const
char
*
aPref
void
*
aData
)
;
class
nsPrefBranch
;
namespace
mozilla
{
namespace
dom
{
class
Pref
;
class
PrefValue
;
}
struct
PrefsSizes
;
#
ifdef
XP_UNIX
static
const
int
kPrefsFileDescriptor
=
8
;
#
endif
enum
class
PrefValueKind
:
uint8_t
{
Default
User
}
;
class
Preferences
final
:
public
nsIPrefService
public
nsIObserver
public
nsIPrefBranch
public
nsSupportsWeakReference
{
friend
class
:
:
nsPrefBranch
;
public
:
NS_DECL_THREADSAFE_ISUPPORTS
NS_DECL_NSIPREFSERVICE
NS_FORWARD_NSIPREFBRANCH
(
mRootBranch
-
>
)
NS_DECL_NSIOBSERVER
Preferences
(
)
;
static
bool
IsServiceAvailable
(
)
;
static
void
InitializeUserPrefs
(
)
;
static
already_AddRefed
<
Preferences
>
GetInstanceForService
(
)
;
static
void
Shutdown
(
)
;
static
nsIPrefService
*
GetService
(
)
{
NS_ENSURE_TRUE
(
InitStaticMembers
(
)
nullptr
)
;
return
sPreferences
;
}
static
nsIPrefBranch
*
GetRootBranch
(
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
NS_ENSURE_TRUE
(
InitStaticMembers
(
)
nullptr
)
;
return
(
aKind
=
=
PrefValueKind
:
:
Default
)
?
sPreferences
-
>
mDefaultRootBranch
:
sPreferences
-
>
mRootBranch
;
}
static
int32_t
GetType
(
const
char
*
aPrefName
)
;
static
nsresult
GetBool
(
const
char
*
aPrefName
bool
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetInt
(
const
char
*
aPrefName
int32_t
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetUint
(
const
char
*
aPrefName
uint32_t
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
GetInt
(
aPrefName
reinterpret_cast
<
int32_t
*
>
(
aResult
)
aKind
)
;
}
static
nsresult
GetFloat
(
const
char
*
aPrefName
float
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetCString
(
const
char
*
aPrefName
nsACString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetString
(
const
char
*
aPrefName
nsAString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetLocalizedCString
(
const
char
*
aPrefName
nsACString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetLocalizedString
(
const
char
*
aPrefName
nsAString
&
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
GetComplex
(
const
char
*
aPrefName
const
nsIID
&
aType
void
*
*
aResult
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
bool
GetBool
(
const
char
*
aPrefName
bool
aFallback
=
false
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
bool
result
=
aFallback
;
GetBool
(
aPrefName
&
result
aKind
)
;
return
result
;
}
static
int32_t
GetInt
(
const
char
*
aPrefName
int32_t
aFallback
=
0
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
int32_t
result
=
aFallback
;
GetInt
(
aPrefName
&
result
aKind
)
;
return
result
;
}
static
uint32_t
GetUint
(
const
char
*
aPrefName
uint32_t
aFallback
=
0
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
uint32_t
result
=
aFallback
;
GetUint
(
aPrefName
&
result
aKind
)
;
return
result
;
}
static
float
GetFloat
(
const
char
*
aPrefName
float
aFallback
=
0
.
0f
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
float
result
=
aFallback
;
GetFloat
(
aPrefName
&
result
aKind
)
;
return
result
;
}
static
nsresult
SetBool
(
const
char
*
aPrefName
bool
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetInt
(
const
char
*
aPrefName
int32_t
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetCString
(
const
char
*
aPrefName
const
nsACString
&
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
SetUint
(
const
char
*
aPrefName
uint32_t
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
SetInt
(
aPrefName
static_cast
<
int32_t
>
(
aValue
)
aKind
)
;
}
static
nsresult
SetFloat
(
const
char
*
aPrefName
float
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
SetCString
(
aPrefName
nsPrintfCString
(
"
%
f
"
aValue
)
aKind
)
;
}
static
nsresult
SetCString
(
const
char
*
aPrefName
const
char
*
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
Preferences
:
:
SetCString
(
aPrefName
nsDependentCString
(
aValue
)
aKind
)
;
}
static
nsresult
SetString
(
const
char
*
aPrefName
const
char16ptr_t
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
Preferences
:
:
SetCString
(
aPrefName
NS_ConvertUTF16toUTF8
(
aValue
)
aKind
)
;
}
static
nsresult
SetString
(
const
char
*
aPrefName
const
nsAString
&
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
{
return
Preferences
:
:
SetCString
(
aPrefName
NS_ConvertUTF16toUTF8
(
aValue
)
aKind
)
;
}
static
nsresult
SetComplex
(
const
char
*
aPrefName
const
nsIID
&
aType
nsISupports
*
aValue
PrefValueKind
aKind
=
PrefValueKind
:
:
User
)
;
static
nsresult
Lock
(
const
char
*
aPrefName
)
;
static
nsresult
Unlock
(
const
char
*
aPrefName
)
;
static
bool
IsLocked
(
const
char
*
aPrefName
)
;
static
nsresult
ClearUser
(
const
char
*
aPrefName
)
;
static
bool
HasUserValue
(
const
char
*
aPref
)
;
static
nsresult
AddStrongObserver
(
nsIObserver
*
aObserver
const
nsACString
&
aPref
)
;
static
nsresult
AddWeakObserver
(
nsIObserver
*
aObserver
const
nsACString
&
aPref
)
;
static
nsresult
RemoveObserver
(
nsIObserver
*
aObserver
const
nsACString
&
aPref
)
;
template
<
int
N
>
static
nsresult
AddStrongObserver
(
nsIObserver
*
aObserver
const
char
(
&
aPref
)
[
N
]
)
{
return
AddStrongObserver
(
aObserver
nsLiteralCString
(
aPref
)
)
;
}
template
<
int
N
>
static
nsresult
AddWeakObserver
(
nsIObserver
*
aObserver
const
char
(
&
aPref
)
[
N
]
)
{
return
AddWeakObserver
(
aObserver
nsLiteralCString
(
aPref
)
)
;
}
template
<
int
N
>
static
nsresult
RemoveObserver
(
nsIObserver
*
aObserver
const
char
(
&
aPref
)
[
N
]
)
{
return
RemoveObserver
(
aObserver
nsLiteralCString
(
aPref
)
)
;
}
static
nsresult
AddStrongObservers
(
nsIObserver
*
aObserver
const
char
*
*
aPrefs
)
;
static
nsresult
AddWeakObservers
(
nsIObserver
*
aObserver
const
char
*
*
aPrefs
)
;
static
nsresult
RemoveObservers
(
nsIObserver
*
aObserver
const
char
*
*
aPrefs
)
;
static
nsresult
RegisterCallback
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallback
(
aCallback
aPref
aClosure
ExactMatch
)
;
}
static
nsresult
UnregisterCallback
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
=
nullptr
)
{
return
UnregisterCallback
(
aCallback
aPref
aClosure
ExactMatch
)
;
}
static
nsresult
RegisterCallbackAndCall
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallbackAndCall
(
aCallback
aPref
aClosure
ExactMatch
)
;
}
static
nsresult
RegisterPrefixCallback
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallback
(
aCallback
aPref
aClosure
PrefixMatch
)
;
}
static
nsresult
RegisterPrefixCallbackAndCall
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
=
nullptr
)
{
return
RegisterCallbackAndCall
(
aCallback
aPref
aClosure
PrefixMatch
)
;
}
static
nsresult
UnregisterPrefixCallback
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
=
nullptr
)
{
return
UnregisterCallback
(
aCallback
aPref
aClosure
PrefixMatch
)
;
}
template
<
int
N
>
static
nsresult
RegisterCallback
(
PrefChangedFunc
aCallback
const
char
(
&
aPref
)
[
N
]
void
*
aClosure
=
nullptr
)
{
return
RegisterCallback
(
aCallback
nsLiteralCString
(
aPref
)
aClosure
ExactMatch
)
;
}
template
<
int
N
>
static
nsresult
UnregisterCallback
(
PrefChangedFunc
aCallback
const
char
(
&
aPref
)
[
N
]
void
*
aClosure
=
nullptr
)
{
return
UnregisterCallback
(
aCallback
nsLiteralCString
(
aPref
)
aClosure
ExactMatch
)
;
}
template
<
int
N
>
static
nsresult
RegisterCallbackAndCall
(
PrefChangedFunc
aCallback
const
char
(
&
aPref
)
[
N
]
void
*
aClosure
=
nullptr
)
{
return
RegisterCallbackAndCall
(
aCallback
nsLiteralCString
(
aPref
)
aClosure
ExactMatch
)
;
}
template
<
int
N
>
static
nsresult
RegisterPrefixCallback
(
PrefChangedFunc
aCallback
const
char
(
&
aPref
)
[
N
]
void
*
aClosure
=
nullptr
)
{
return
RegisterCallback
(
aCallback
nsLiteralCString
(
aPref
)
aClosure
PrefixMatch
)
;
}
template
<
int
N
>
static
nsresult
RegisterPrefixCallbackAndCall
(
PrefChangedFunc
aCallback
const
char
(
&
aPref
)
[
N
]
void
*
aClosure
=
nullptr
)
{
return
RegisterCallbackAndCall
(
aCallback
nsLiteralCString
(
aPref
)
aClosure
PrefixMatch
)
;
}
template
<
int
N
>
static
nsresult
UnregisterPrefixCallback
(
PrefChangedFunc
aCallback
const
char
(
&
aPref
)
[
N
]
void
*
aClosure
=
nullptr
)
{
return
UnregisterCallback
(
aCallback
nsLiteralCString
(
aPref
)
aClosure
PrefixMatch
)
;
}
static
nsresult
AddBoolVarCache
(
bool
*
aVariable
const
nsACString
&
aPref
bool
aDefault
=
false
bool
aSkipAssignment
=
false
)
;
template
<
MemoryOrdering
Order
>
static
nsresult
AddAtomicBoolVarCache
(
Atomic
<
bool
Order
>
*
aVariable
const
nsACString
&
aPref
bool
aDefault
=
false
bool
aSkipAssignment
=
false
)
;
static
nsresult
AddIntVarCache
(
int32_t
*
aVariable
const
nsACString
&
aPref
int32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
;
template
<
MemoryOrdering
Order
>
static
nsresult
AddAtomicIntVarCache
(
Atomic
<
int32_t
Order
>
*
aVariable
const
nsACString
&
aPref
int32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
;
static
nsresult
AddUintVarCache
(
uint32_t
*
aVariable
const
nsACString
&
aPref
uint32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
;
template
<
MemoryOrdering
Order
>
static
nsresult
AddAtomicUintVarCache
(
Atomic
<
uint32_t
Order
>
*
aVariable
const
nsACString
&
aPref
uint32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
;
static
nsresult
AddFloatVarCache
(
float
*
aVariable
const
nsACString
&
aPref
float
aDefault
=
0
.
0f
bool
aSkipAssignment
=
false
)
;
template
<
int
N
>
static
nsresult
AddBoolVarCache
(
bool
*
aVariable
const
char
(
&
aPref
)
[
N
]
bool
aDefault
=
false
bool
aSkipAssignment
=
false
)
{
return
AddBoolVarCache
(
aVariable
nsLiteralCString
(
aPref
)
aDefault
aSkipAssignment
)
;
}
template
<
MemoryOrdering
Order
int
N
>
static
nsresult
AddAtomicBoolVarCache
(
Atomic
<
bool
Order
>
*
aVariable
const
char
(
&
aPref
)
[
N
]
bool
aDefault
=
false
bool
aSkipAssignment
=
false
)
{
return
AddAtomicBoolVarCache
<
Order
>
(
aVariable
nsLiteralCString
(
aPref
)
aDefault
aSkipAssignment
)
;
}
template
<
int
N
>
static
nsresult
AddIntVarCache
(
int32_t
*
aVariable
const
char
(
&
aPref
)
[
N
]
int32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
{
return
AddIntVarCache
(
aVariable
nsLiteralCString
(
aPref
)
aDefault
aSkipAssignment
)
;
}
template
<
MemoryOrdering
Order
int
N
>
static
nsresult
AddAtomicIntVarCache
(
Atomic
<
int32_t
Order
>
*
aVariable
const
char
(
&
aPref
)
[
N
]
int32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
{
return
AddAtomicIntVarCache
<
Order
>
(
aVariable
nsLiteralCString
(
aPref
)
aDefault
aSkipAssignment
)
;
}
template
<
int
N
>
static
nsresult
AddUintVarCache
(
uint32_t
*
aVariable
const
char
(
&
aPref
)
[
N
]
uint32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
{
return
AddUintVarCache
(
aVariable
nsLiteralCString
(
aPref
)
aDefault
aSkipAssignment
)
;
}
template
<
MemoryOrdering
Order
int
N
>
static
nsresult
AddAtomicUintVarCache
(
Atomic
<
uint32_t
Order
>
*
aVariable
const
char
(
&
aPref
)
[
N
]
uint32_t
aDefault
=
0
bool
aSkipAssignment
=
false
)
{
return
AddAtomicUintVarCache
<
Order
>
(
aVariable
nsLiteralCString
(
aPref
)
aDefault
aSkipAssignment
)
;
}
template
<
int
N
>
static
nsresult
AddFloatVarCache
(
float
*
aVariable
const
char
(
&
aPref
)
[
N
]
float
aDefault
=
0
.
0f
bool
aSkipAssignment
=
false
)
{
return
AddFloatVarCache
(
aVariable
nsLiteralCString
(
aPref
)
aDefault
aSkipAssignment
)
;
}
static
void
SerializePreferences
(
nsCString
&
aStr
)
;
static
void
DeserializePreferences
(
char
*
aStr
size_t
aPrefsLen
)
;
static
void
GetPreference
(
dom
:
:
Pref
*
aPref
)
;
static
void
SetPreference
(
const
dom
:
:
Pref
&
aPref
)
;
#
ifdef
DEBUG
static
bool
ArePrefsInitedInContentProcess
(
)
;
#
endif
static
void
AddSizeOfIncludingThis
(
mozilla
:
:
MallocSizeOf
aMallocSizeOf
PrefsSizes
&
aSizes
)
;
static
void
HandleDirty
(
)
;
nsresult
SavePrefFileBlocking
(
)
;
nsresult
SavePrefFileAsynchronous
(
)
;
private
:
virtual
~
Preferences
(
)
;
nsresult
NotifyServiceObservers
(
const
char
*
aSubject
)
;
already_AddRefed
<
nsIFile
>
ReadSavedPrefs
(
)
;
void
ReadUserOverridePrefs
(
)
;
nsresult
MakeBackupPrefFile
(
nsIFile
*
aFile
)
;
enum
class
SaveMethod
{
Blocking
Asynchronous
}
;
nsresult
SavePrefFileInternal
(
nsIFile
*
aFile
SaveMethod
aSaveMethod
)
;
nsresult
WritePrefFile
(
nsIFile
*
aFile
SaveMethod
aSaveMethod
)
;
bool
AllowOffMainThreadSave
(
)
;
public
:
enum
MatchKind
{
PrefixMatch
ExactMatch
}
;
private
:
static
void
SetupTelemetryPref
(
)
;
static
mozilla
:
:
Result
<
mozilla
:
:
Ok
const
char
*
>
InitInitialObjects
(
bool
aIsStartup
)
;
static
nsresult
RegisterCallback
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
MatchKind
aMatchKind
bool
aIsPriority
=
false
)
;
static
nsresult
UnregisterCallback
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
MatchKind
aMatchKind
)
;
static
nsresult
RegisterCallbackAndCall
(
PrefChangedFunc
aCallback
const
nsACString
&
aPref
void
*
aClosure
MatchKind
aMatchKind
)
;
static
nsresult
RegisterCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
MatchKind
aMatchKind
bool
aIsPriority
=
false
)
{
return
RegisterCallback
(
aCallback
nsDependentCString
(
aPref
)
aClosure
aMatchKind
aIsPriority
)
;
}
static
nsresult
UnregisterCallback
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
MatchKind
aMatchKind
)
{
return
UnregisterCallback
(
aCallback
nsDependentCString
(
aPref
)
aClosure
aMatchKind
)
;
}
static
nsresult
RegisterCallbackAndCall
(
PrefChangedFunc
aCallback
const
char
*
aPref
void
*
aClosure
MatchKind
aMatchKind
)
{
return
RegisterCallbackAndCall
(
aCallback
nsDependentCString
(
aPref
)
aClosure
aMatchKind
)
;
}
private
:
nsCOMPtr
<
nsIFile
>
mCurrentFile
;
bool
mDirty
=
false
;
bool
mProfileShutdown
=
false
;
bool
mSavePending
=
false
;
nsCOMPtr
<
nsIPrefBranch
>
mRootBranch
;
nsCOMPtr
<
nsIPrefBranch
>
mDefaultRootBranch
;
static
StaticRefPtr
<
Preferences
>
sPreferences
;
static
bool
sShutdown
;
static
bool
InitStaticMembers
(
)
;
}
;
}
#
endif
