#
include
<
ft2build
.
h
>
#
include
FT_FREETYPE_H
#
include
FT_INTERNAL_DEBUG_H
#
include
FT_INTERNAL_STREAM_H
#
include
FT_INTERNAL_SFNT_H
#
include
FT_SERVICE_CID_H
#
include
FT_SERVICE_POSTSCRIPT_INFO_H
#
include
FT_SERVICE_POSTSCRIPT_NAME_H
#
include
FT_SERVICE_TT_CMAP_H
#
include
"
cffdrivr
.
h
"
#
include
"
cffgload
.
h
"
#
include
"
cffload
.
h
"
#
include
"
cffcmap
.
h
"
#
include
"
cffparse
.
h
"
#
ifdef
TT_CONFIG_OPTION_GX_VAR_SUPPORT
#
include
FT_SERVICE_MULTIPLE_MASTERS_H
#
include
FT_SERVICE_METRICS_VARIATIONS_H
#
endif
#
include
"
cfferrs
.
h
"
#
include
"
cffpic
.
h
"
#
include
FT_SERVICE_FONT_FORMAT_H
#
include
FT_SERVICE_GLYPH_DICT_H
#
include
FT_SERVICE_PROPERTIES_H
#
include
FT_CFF_DRIVER_H
#
undef
FT_COMPONENT
#
define
FT_COMPONENT
trace_cffdriver
FT_CALLBACK_DEF
(
FT_Error
)
cff_get_kerning
(
FT_Face
ttface
FT_UInt
left_glyph
FT_UInt
right_glyph
FT_Vector
*
kerning
)
{
TT_Face
face
=
(
TT_Face
)
ttface
;
SFNT_Service
sfnt
=
(
SFNT_Service
)
face
-
>
sfnt
;
kerning
-
>
x
=
0
;
kerning
-
>
y
=
0
;
if
(
sfnt
)
kerning
-
>
x
=
sfnt
-
>
get_kerning
(
face
left_glyph
right_glyph
)
;
return
FT_Err_Ok
;
}
FT_CALLBACK_DEF
(
FT_Error
)
cff_glyph_load
(
FT_GlyphSlot
cffslot
FT_Size
cffsize
FT_UInt
glyph_index
FT_Int32
load_flags
)
{
FT_Error
error
;
CFF_GlyphSlot
slot
=
(
CFF_GlyphSlot
)
cffslot
;
CFF_Size
size
=
(
CFF_Size
)
cffsize
;
if
(
!
slot
)
return
FT_THROW
(
Invalid_Slot_Handle
)
;
FT_TRACE1
(
(
"
cff_glyph_load
:
glyph
index
%
d
\
n
"
glyph_index
)
)
;
if
(
!
size
)
load_flags
|
=
FT_LOAD_NO_SCALE
|
FT_LOAD_NO_HINTING
;
if
(
load_flags
&
FT_LOAD_NO_SCALE
)
size
=
NULL
;
if
(
size
)
{
if
(
cffsize
-
>
face
!
=
cffslot
-
>
face
)
return
FT_THROW
(
Invalid_Face_Handle
)
;
}
error
=
cff_slot_load
(
slot
size
glyph_index
load_flags
)
;
return
error
;
}
FT_CALLBACK_DEF
(
FT_Error
)
cff_get_advances
(
FT_Face
face
FT_UInt
start
FT_UInt
count
FT_Int32
flags
FT_Fixed
*
advances
)
{
FT_UInt
nn
;
FT_Error
error
=
FT_Err_Ok
;
FT_GlyphSlot
slot
=
face
-
>
glyph
;
if
(
FT_IS_SFNT
(
face
)
)
{
TT_Face
ttface
=
(
TT_Face
)
face
;
FT_Short
dummy
;
if
(
flags
&
FT_LOAD_VERTICAL_LAYOUT
)
{
#
ifdef
TT_CONFIG_OPTION_GX_VAR_SUPPORT
if
(
!
ttface
-
>
is_default_instance
&
&
!
(
ttface
-
>
variation_support
&
TT_FACE_FLAG_VAR_VADVANCE
)
)
return
FT_THROW
(
Unimplemented_Feature
)
;
#
endif
if
(
!
ttface
-
>
vertical_info
)
goto
Missing_Table
;
for
(
nn
=
0
;
nn
<
count
;
nn
+
+
)
{
FT_UShort
ah
;
(
(
SFNT_Service
)
ttface
-
>
sfnt
)
-
>
get_metrics
(
ttface
1
start
+
nn
&
dummy
&
ah
)
;
FT_TRACE5
(
(
"
idx
%
d
:
advance
height
%
d
font
units
\
n
"
start
+
nn
ah
)
)
;
advances
[
nn
]
=
ah
;
}
}
else
{
#
ifdef
TT_CONFIG_OPTION_GX_VAR_SUPPORT
if
(
!
ttface
-
>
is_default_instance
&
&
!
(
ttface
-
>
variation_support
&
TT_FACE_FLAG_VAR_HADVANCE
)
)
return
FT_THROW
(
Unimplemented_Feature
)
;
#
endif
if
(
!
ttface
-
>
horizontal
.
number_Of_HMetrics
)
goto
Missing_Table
;
for
(
nn
=
0
;
nn
<
count
;
nn
+
+
)
{
FT_UShort
aw
;
(
(
SFNT_Service
)
ttface
-
>
sfnt
)
-
>
get_metrics
(
ttface
0
start
+
nn
&
dummy
&
aw
)
;
FT_TRACE5
(
(
"
idx
%
d
:
advance
width
%
d
font
units
\
n
"
start
+
nn
aw
)
)
;
advances
[
nn
]
=
aw
;
}
}
return
error
;
}
Missing_Table
:
flags
|
=
(
FT_UInt32
)
FT_LOAD_ADVANCE_ONLY
;
for
(
nn
=
0
;
nn
<
count
;
nn
+
+
)
{
error
=
cff_glyph_load
(
slot
face
-
>
size
start
+
nn
flags
)
;
if
(
error
)
break
;
advances
[
nn
]
=
(
flags
&
FT_LOAD_VERTICAL_LAYOUT
)
?
slot
-
>
linearVertAdvance
:
slot
-
>
linearHoriAdvance
;
}
return
error
;
}
static
FT_Error
cff_get_glyph_name
(
CFF_Face
face
FT_UInt
glyph_index
FT_Pointer
buffer
FT_UInt
buffer_max
)
{
CFF_Font
font
=
(
CFF_Font
)
face
-
>
extra
.
data
;
FT_String
*
gname
;
FT_UShort
sid
;
FT_Error
error
;
if
(
font
-
>
version_major
=
=
2
)
{
FT_Library
library
=
FT_FACE_LIBRARY
(
face
)
;
FT_Module
sfnt_module
=
FT_Get_Module
(
library
"
sfnt
"
)
;
FT_Service_GlyphDict
service
=
(
FT_Service_GlyphDict
)
ft_module_get_service
(
sfnt_module
FT_SERVICE_ID_GLYPH_DICT
0
)
;
if
(
service
&
&
service
-
>
get_name
)
return
service
-
>
get_name
(
FT_FACE
(
face
)
glyph_index
buffer
buffer_max
)
;
else
{
FT_ERROR
(
(
"
cff_get_glyph_name
:
"
"
cannot
get
glyph
name
from
a
CFF2
font
\
n
"
"
"
"
without
the
PSNames
'
module
\
n
"
)
)
;
error
=
FT_THROW
(
Missing_Module
)
;
goto
Exit
;
}
}
if
(
!
font
-
>
psnames
)
{
FT_ERROR
(
(
"
cff_get_glyph_name
:
"
"
cannot
get
glyph
name
from
CFF
&
CEF
fonts
\
n
"
"
"
"
without
the
PSNames
'
module
\
n
"
)
)
;
error
=
FT_THROW
(
Missing_Module
)
;
goto
Exit
;
}
sid
=
font
-
>
charset
.
sids
[
glyph_index
]
;
gname
=
cff_index_get_sid_string
(
font
sid
)
;
if
(
gname
)
FT_STRCPYN
(
buffer
gname
buffer_max
)
;
error
=
FT_Err_Ok
;
Exit
:
return
error
;
}
static
FT_UInt
cff_get_name_index
(
CFF_Face
face
FT_String
*
glyph_name
)
{
CFF_Font
cff
;
CFF_Charset
charset
;
FT_Service_PsCMaps
psnames
;
FT_String
*
name
;
FT_UShort
sid
;
FT_UInt
i
;
cff
=
(
CFF_FontRec
*
)
face
-
>
extra
.
data
;
charset
=
&
cff
-
>
charset
;
if
(
cff
-
>
version_major
=
=
2
)
{
FT_Library
library
=
FT_FACE_LIBRARY
(
face
)
;
FT_Module
sfnt_module
=
FT_Get_Module
(
library
"
sfnt
"
)
;
FT_Service_GlyphDict
service
=
(
FT_Service_GlyphDict
)
ft_module_get_service
(
sfnt_module
FT_SERVICE_ID_GLYPH_DICT
0
)
;
if
(
service
&
&
service
-
>
name_index
)
return
service
-
>
name_index
(
FT_FACE
(
face
)
glyph_name
)
;
else
{
FT_ERROR
(
(
"
cff_get_name_index
:
"
"
cannot
get
glyph
index
from
a
CFF2
font
\
n
"
"
"
"
without
the
PSNames
'
module
\
n
"
)
)
;
return
0
;
}
}
FT_FACE_FIND_GLOBAL_SERVICE
(
face
psnames
POSTSCRIPT_CMAPS
)
;
if
(
!
psnames
)
return
0
;
for
(
i
=
0
;
i
<
cff
-
>
num_glyphs
;
i
+
+
)
{
sid
=
charset
-
>
sids
[
i
]
;
if
(
sid
>
390
)
name
=
cff_index_get_string
(
cff
sid
-
391
)
;
else
name
=
(
FT_String
*
)
psnames
-
>
adobe_std_strings
(
sid
)
;
if
(
!
name
)
continue
;
if
(
!
ft_strcmp
(
glyph_name
name
)
)
return
i
;
}
return
0
;
}
FT_DEFINE_SERVICE_GLYPHDICTREC
(
cff_service_glyph_dict
(
FT_GlyphDict_GetNameFunc
)
cff_get_glyph_name
(
FT_GlyphDict_NameIndexFunc
)
cff_get_name_index
)
static
FT_Int
cff_ps_has_glyph_names
(
FT_Face
face
)
{
return
(
face
-
>
face_flags
&
FT_FACE_FLAG_GLYPH_NAMES
)
>
0
;
}
static
FT_Error
cff_ps_get_font_info
(
CFF_Face
face
PS_FontInfoRec
*
afont_info
)
{
CFF_Font
cff
=
(
CFF_Font
)
face
-
>
extra
.
data
;
FT_Error
error
=
FT_Err_Ok
;
if
(
cff
&
&
!
cff
-
>
font_info
)
{
CFF_FontRecDict
dict
=
&
cff
-
>
top_font
.
font_dict
;
PS_FontInfoRec
*
font_info
=
NULL
;
FT_Memory
memory
=
face
-
>
root
.
memory
;
if
(
FT_ALLOC
(
font_info
sizeof
(
*
font_info
)
)
)
goto
Fail
;
font_info
-
>
version
=
cff_index_get_sid_string
(
cff
dict
-
>
version
)
;
font_info
-
>
notice
=
cff_index_get_sid_string
(
cff
dict
-
>
notice
)
;
font_info
-
>
full_name
=
cff_index_get_sid_string
(
cff
dict
-
>
full_name
)
;
font_info
-
>
family_name
=
cff_index_get_sid_string
(
cff
dict
-
>
family_name
)
;
font_info
-
>
weight
=
cff_index_get_sid_string
(
cff
dict
-
>
weight
)
;
font_info
-
>
italic_angle
=
dict
-
>
italic_angle
;
font_info
-
>
is_fixed_pitch
=
dict
-
>
is_fixed_pitch
;
font_info
-
>
underline_position
=
(
FT_Short
)
dict
-
>
underline_position
;
font_info
-
>
underline_thickness
=
(
FT_UShort
)
dict
-
>
underline_thickness
;
cff
-
>
font_info
=
font_info
;
}
if
(
cff
)
*
afont_info
=
*
cff
-
>
font_info
;
Fail
:
return
error
;
}
FT_DEFINE_SERVICE_PSINFOREC
(
cff_service_ps_info
(
PS_GetFontInfoFunc
)
cff_ps_get_font_info
(
PS_GetFontExtraFunc
)
NULL
(
PS_HasGlyphNamesFunc
)
cff_ps_has_glyph_names
(
PS_GetFontPrivateFunc
)
NULL
(
PS_GetFontValueFunc
)
NULL
)
static
const
char
*
cff_get_ps_name
(
CFF_Face
face
)
{
CFF_Font
cff
=
(
CFF_Font
)
face
-
>
extra
.
data
;
SFNT_Service
sfnt
=
(
SFNT_Service
)
face
-
>
sfnt
;
if
(
FT_IS_SFNT
(
FT_FACE
(
face
)
)
&
&
sfnt
)
{
FT_Library
library
=
FT_FACE_LIBRARY
(
face
)
;
FT_Module
sfnt_module
=
FT_Get_Module
(
library
"
sfnt
"
)
;
FT_Service_PsFontName
service
=
(
FT_Service_PsFontName
)
ft_module_get_service
(
sfnt_module
FT_SERVICE_ID_POSTSCRIPT_FONT_NAME
0
)
;
if
(
service
&
&
service
-
>
get_ps_font_name
)
return
service
-
>
get_ps_font_name
(
FT_FACE
(
face
)
)
;
}
return
(
const
char
*
)
cff
-
>
font_name
;
}
FT_DEFINE_SERVICE_PSFONTNAMEREC
(
cff_service_ps_name
(
FT_PsName_GetFunc
)
cff_get_ps_name
)
static
FT_Error
cff_get_cmap_info
(
FT_CharMap
charmap
TT_CMapInfo
*
cmap_info
)
{
FT_CMap
cmap
=
FT_CMAP
(
charmap
)
;
FT_Error
error
=
FT_Err_Ok
;
FT_Face
face
=
FT_CMAP_FACE
(
cmap
)
;
FT_Library
library
=
FT_FACE_LIBRARY
(
face
)
;
if
(
cmap
-
>
clazz
!
=
&
CFF_CMAP_ENCODING_CLASS_REC_GET
&
&
cmap
-
>
clazz
!
=
&
CFF_CMAP_UNICODE_CLASS_REC_GET
)
{
FT_Module
sfnt
=
FT_Get_Module
(
library
"
sfnt
"
)
;
FT_Service_TTCMaps
service
=
(
FT_Service_TTCMaps
)
ft_module_get_service
(
sfnt
FT_SERVICE_ID_TT_CMAP
0
)
;
if
(
service
&
&
service
-
>
get_cmap_info
)
error
=
service
-
>
get_cmap_info
(
charmap
cmap_info
)
;
}
else
error
=
FT_THROW
(
Invalid_CharMap_Format
)
;
return
error
;
}
FT_DEFINE_SERVICE_TTCMAPSREC
(
cff_service_get_cmap_info
(
TT_CMap_Info_GetFunc
)
cff_get_cmap_info
)
static
FT_Error
cff_get_ros
(
CFF_Face
face
const
char
*
*
registry
const
char
*
*
ordering
FT_Int
*
supplement
)
{
FT_Error
error
=
FT_Err_Ok
;
CFF_Font
cff
=
(
CFF_Font
)
face
-
>
extra
.
data
;
if
(
cff
)
{
CFF_FontRecDict
dict
=
&
cff
-
>
top_font
.
font_dict
;
if
(
dict
-
>
cid_registry
=
=
0xFFFFU
)
{
error
=
FT_THROW
(
Invalid_Argument
)
;
goto
Fail
;
}
if
(
registry
)
{
if
(
!
cff
-
>
registry
)
cff
-
>
registry
=
cff_index_get_sid_string
(
cff
dict
-
>
cid_registry
)
;
*
registry
=
cff
-
>
registry
;
}
if
(
ordering
)
{
if
(
!
cff
-
>
ordering
)
cff
-
>
ordering
=
cff_index_get_sid_string
(
cff
dict
-
>
cid_ordering
)
;
*
ordering
=
cff
-
>
ordering
;
}
if
(
supplement
)
{
if
(
dict
-
>
cid_supplement
<
FT_INT_MIN
|
|
dict
-
>
cid_supplement
>
FT_INT_MAX
)
FT_TRACE1
(
(
"
cff_get_ros
:
too
large
supplement
%
d
is
truncated
\
n
"
dict
-
>
cid_supplement
)
)
;
*
supplement
=
(
FT_Int
)
dict
-
>
cid_supplement
;
}
}
Fail
:
return
error
;
}
static
FT_Error
cff_get_is_cid
(
CFF_Face
face
FT_Bool
*
is_cid
)
{
FT_Error
error
=
FT_Err_Ok
;
CFF_Font
cff
=
(
CFF_Font
)
face
-
>
extra
.
data
;
*
is_cid
=
0
;
if
(
cff
)
{
CFF_FontRecDict
dict
=
&
cff
-
>
top_font
.
font_dict
;
if
(
dict
-
>
cid_registry
!
=
0xFFFFU
)
*
is_cid
=
1
;
}
return
error
;
}
static
FT_Error
cff_get_cid_from_glyph_index
(
CFF_Face
face
FT_UInt
glyph_index
FT_UInt
*
cid
)
{
FT_Error
error
=
FT_Err_Ok
;
CFF_Font
cff
;
cff
=
(
CFF_Font
)
face
-
>
extra
.
data
;
if
(
cff
)
{
FT_UInt
c
;
CFF_FontRecDict
dict
=
&
cff
-
>
top_font
.
font_dict
;
if
(
dict
-
>
cid_registry
=
=
0xFFFFU
)
{
error
=
FT_THROW
(
Invalid_Argument
)
;
goto
Fail
;
}
if
(
glyph_index
>
cff
-
>
num_glyphs
)
{
error
=
FT_THROW
(
Invalid_Argument
)
;
goto
Fail
;
}
c
=
cff
-
>
charset
.
sids
[
glyph_index
]
;
if
(
cid
)
*
cid
=
c
;
}
Fail
:
return
error
;
}
FT_DEFINE_SERVICE_CIDREC
(
cff_service_cid_info
(
FT_CID_GetRegistryOrderingSupplementFunc
)
cff_get_ros
(
FT_CID_GetIsInternallyCIDKeyedFunc
)
cff_get_is_cid
(
FT_CID_GetCIDFromGlyphIndexFunc
)
cff_get_cid_from_glyph_index
)
static
FT_Error
cff_property_set
(
FT_Module
module
const
char
*
property_name
const
void
*
value
FT_Bool
value_is_string
)
{
FT_Error
error
=
FT_Err_Ok
;
CFF_Driver
driver
=
(
CFF_Driver
)
module
;
#
ifndef
FT_CONFIG_OPTION_ENVIRONMENT_PROPERTIES
FT_UNUSED
(
value_is_string
)
;
#
endif
if
(
!
ft_strcmp
(
property_name
"
darkening
-
parameters
"
)
)
{
FT_Int
*
darken_params
;
FT_Int
x1
y1
x2
y2
x3
y3
x4
y4
;
#
ifdef
FT_CONFIG_OPTION_ENVIRONMENT_PROPERTIES
FT_Int
dp
[
8
]
;
if
(
value_is_string
)
{
const
char
*
s
=
(
const
char
*
)
value
;
char
*
ep
;
int
i
;
for
(
i
=
0
;
i
<
7
;
i
+
+
)
{
dp
[
i
]
=
(
FT_Int
)
ft_strtol
(
s
&
ep
10
)
;
if
(
*
ep
!
=
'
'
|
|
s
=
=
ep
)
return
FT_THROW
(
Invalid_Argument
)
;
s
=
ep
+
1
;
}
dp
[
7
]
=
(
FT_Int
)
ft_strtol
(
s
&
ep
10
)
;
if
(
!
(
*
ep
=
=
'
\
0
'
|
|
*
ep
=
=
'
'
)
|
|
s
=
=
ep
)
return
FT_THROW
(
Invalid_Argument
)
;
darken_params
=
dp
;
}
else
#
endif
darken_params
=
(
FT_Int
*
)
value
;
x1
=
darken_params
[
0
]
;
y1
=
darken_params
[
1
]
;
x2
=
darken_params
[
2
]
;
y2
=
darken_params
[
3
]
;
x3
=
darken_params
[
4
]
;
y3
=
darken_params
[
5
]
;
x4
=
darken_params
[
6
]
;
y4
=
darken_params
[
7
]
;
if
(
x1
<
0
|
|
x2
<
0
|
|
x3
<
0
|
|
x4
<
0
|
|
y1
<
0
|
|
y2
<
0
|
|
y3
<
0
|
|
y4
<
0
|
|
x1
>
x2
|
|
x2
>
x3
|
|
x3
>
x4
|
|
y1
>
500
|
|
y2
>
500
|
|
y3
>
500
|
|
y4
>
500
)
return
FT_THROW
(
Invalid_Argument
)
;
driver
-
>
darken_params
[
0
]
=
x1
;
driver
-
>
darken_params
[
1
]
=
y1
;
driver
-
>
darken_params
[
2
]
=
x2
;
driver
-
>
darken_params
[
3
]
=
y2
;
driver
-
>
darken_params
[
4
]
=
x3
;
driver
-
>
darken_params
[
5
]
=
y3
;
driver
-
>
darken_params
[
6
]
=
x4
;
driver
-
>
darken_params
[
7
]
=
y4
;
return
error
;
}
else
if
(
!
ft_strcmp
(
property_name
"
hinting
-
engine
"
)
)
{
#
ifdef
FT_CONFIG_OPTION_ENVIRONMENT_PROPERTIES
if
(
value_is_string
)
{
const
char
*
s
=
(
const
char
*
)
value
;
if
(
!
ft_strcmp
(
s
"
adobe
"
)
)
driver
-
>
hinting_engine
=
FT_CFF_HINTING_ADOBE
;
#
ifdef
CFF_CONFIG_OPTION_OLD_ENGINE
else
if
(
!
ft_strcmp
(
s
"
freetype
"
)
)
driver
-
>
hinting_engine
=
FT_CFF_HINTING_FREETYPE
;
#
endif
else
return
FT_THROW
(
Invalid_Argument
)
;
}
else
#
endif
{
FT_UInt
*
hinting_engine
=
(
FT_UInt
*
)
value
;
if
(
*
hinting_engine
=
=
FT_CFF_HINTING_ADOBE
#
ifdef
CFF_CONFIG_OPTION_OLD_ENGINE
|
|
*
hinting_engine
=
=
FT_CFF_HINTING_FREETYPE
#
endif
)
driver
-
>
hinting_engine
=
*
hinting_engine
;
else
error
=
FT_ERR
(
Unimplemented_Feature
)
;
return
error
;
}
}
else
if
(
!
ft_strcmp
(
property_name
"
no
-
stem
-
darkening
"
)
)
{
#
ifdef
FT_CONFIG_OPTION_ENVIRONMENT_PROPERTIES
if
(
value_is_string
)
{
const
char
*
s
=
(
const
char
*
)
value
;
long
nsd
=
ft_strtol
(
s
NULL
10
)
;
if
(
!
nsd
)
driver
-
>
no_stem_darkening
=
FALSE
;
else
driver
-
>
no_stem_darkening
=
TRUE
;
}
else
#
endif
{
FT_Bool
*
no_stem_darkening
=
(
FT_Bool
*
)
value
;
driver
-
>
no_stem_darkening
=
*
no_stem_darkening
;
}
return
error
;
}
else
if
(
!
ft_strcmp
(
property_name
"
random
-
seed
"
)
)
{
FT_Int32
random_seed
;
#
ifdef
FT_CONFIG_OPTION_ENVIRONMENT_PROPERTIES
if
(
value_is_string
)
{
const
char
*
s
=
(
const
char
*
)
value
;
random_seed
=
(
FT_Int32
)
ft_strtol
(
s
NULL
10
)
;
}
else
#
endif
random_seed
=
*
(
FT_Int32
*
)
value
;
if
(
random_seed
<
0
)
random_seed
=
0
;
driver
-
>
random_seed
=
random_seed
;
return
error
;
}
FT_TRACE0
(
(
"
cff_property_set
:
missing
property
%
s
'
\
n
"
property_name
)
)
;
return
FT_THROW
(
Missing_Property
)
;
}
static
FT_Error
cff_property_get
(
FT_Module
module
const
char
*
property_name
const
void
*
value
)
{
FT_Error
error
=
FT_Err_Ok
;
CFF_Driver
driver
=
(
CFF_Driver
)
module
;
if
(
!
ft_strcmp
(
property_name
"
darkening
-
parameters
"
)
)
{
FT_Int
*
darken_params
=
driver
-
>
darken_params
;
FT_Int
*
val
=
(
FT_Int
*
)
value
;
val
[
0
]
=
darken_params
[
0
]
;
val
[
1
]
=
darken_params
[
1
]
;
val
[
2
]
=
darken_params
[
2
]
;
val
[
3
]
=
darken_params
[
3
]
;
val
[
4
]
=
darken_params
[
4
]
;
val
[
5
]
=
darken_params
[
5
]
;
val
[
6
]
=
darken_params
[
6
]
;
val
[
7
]
=
darken_params
[
7
]
;
return
error
;
}
else
if
(
!
ft_strcmp
(
property_name
"
hinting
-
engine
"
)
)
{
FT_UInt
hinting_engine
=
driver
-
>
hinting_engine
;
FT_UInt
*
val
=
(
FT_UInt
*
)
value
;
*
val
=
hinting_engine
;
return
error
;
}
else
if
(
!
ft_strcmp
(
property_name
"
no
-
stem
-
darkening
"
)
)
{
FT_Bool
no_stem_darkening
=
driver
-
>
no_stem_darkening
;
FT_Bool
*
val
=
(
FT_Bool
*
)
value
;
*
val
=
no_stem_darkening
;
return
error
;
}
FT_TRACE0
(
(
"
cff_property_get
:
missing
property
%
s
'
\
n
"
property_name
)
)
;
return
FT_THROW
(
Missing_Property
)
;
}
FT_DEFINE_SERVICE_PROPERTIESREC
(
cff_service_properties
(
FT_Properties_SetFunc
)
cff_property_set
(
FT_Properties_GetFunc
)
cff_property_get
)
#
ifdef
TT_CONFIG_OPTION_GX_VAR_SUPPORT
static
FT_Error
cff_set_mm_blend
(
CFF_Face
face
FT_UInt
num_coords
FT_Fixed
*
coords
)
{
FT_Service_MultiMasters
mm
=
(
FT_Service_MultiMasters
)
face
-
>
mm
;
return
mm
-
>
set_mm_blend
(
FT_FACE
(
face
)
num_coords
coords
)
;
}
static
FT_Error
cff_get_mm_blend
(
CFF_Face
face
FT_UInt
num_coords
FT_Fixed
*
coords
)
{
FT_Service_MultiMasters
mm
=
(
FT_Service_MultiMasters
)
face
-
>
mm
;
return
mm
-
>
get_mm_blend
(
FT_FACE
(
face
)
num_coords
coords
)
;
}
static
FT_Error
cff_get_mm_var
(
CFF_Face
face
FT_MM_Var
*
*
master
)
{
FT_Service_MultiMasters
mm
=
(
FT_Service_MultiMasters
)
face
-
>
mm
;
return
mm
-
>
get_mm_var
(
FT_FACE
(
face
)
master
)
;
}
static
FT_Error
cff_set_var_design
(
CFF_Face
face
FT_UInt
num_coords
FT_Fixed
*
coords
)
{
FT_Service_MultiMasters
mm
=
(
FT_Service_MultiMasters
)
face
-
>
mm
;
return
mm
-
>
set_var_design
(
FT_FACE
(
face
)
num_coords
coords
)
;
}
static
FT_Error
cff_get_var_design
(
CFF_Face
face
FT_UInt
num_coords
FT_Fixed
*
coords
)
{
FT_Service_MultiMasters
mm
=
(
FT_Service_MultiMasters
)
face
-
>
mm
;
return
mm
-
>
get_var_design
(
FT_FACE
(
face
)
num_coords
coords
)
;
}
FT_DEFINE_SERVICE_MULTIMASTERSREC
(
cff_service_multi_masters
(
FT_Get_MM_Func
)
NULL
(
FT_Set_MM_Design_Func
)
NULL
(
FT_Set_MM_Blend_Func
)
cff_set_mm_blend
(
FT_Get_MM_Blend_Func
)
cff_get_mm_blend
(
FT_Get_MM_Var_Func
)
cff_get_mm_var
(
FT_Set_Var_Design_Func
)
cff_set_var_design
(
FT_Get_Var_Design_Func
)
cff_get_var_design
(
FT_Get_Var_Blend_Func
)
cff_get_var_blend
(
FT_Done_Blend_Func
)
cff_done_blend
)
static
FT_Error
cff_hadvance_adjust
(
CFF_Face
face
FT_UInt
gindex
FT_Int
*
avalue
)
{
FT_Service_MetricsVariations
var
=
(
FT_Service_MetricsVariations
)
face
-
>
var
;
return
var
-
>
hadvance_adjust
(
FT_FACE
(
face
)
gindex
avalue
)
;
}
static
void
cff_metrics_adjust
(
CFF_Face
face
)
{
FT_Service_MetricsVariations
var
=
(
FT_Service_MetricsVariations
)
face
-
>
var
;
var
-
>
metrics_adjust
(
FT_FACE
(
face
)
)
;
}
FT_DEFINE_SERVICE_METRICSVARIATIONSREC
(
cff_service_metrics_variations
(
FT_HAdvance_Adjust_Func
)
cff_hadvance_adjust
(
FT_LSB_Adjust_Func
)
NULL
(
FT_RSB_Adjust_Func
)
NULL
(
FT_VAdvance_Adjust_Func
)
NULL
(
FT_TSB_Adjust_Func
)
NULL
(
FT_BSB_Adjust_Func
)
NULL
(
FT_VOrg_Adjust_Func
)
NULL
(
FT_Metrics_Adjust_Func
)
cff_metrics_adjust
)
#
endif
#
if
!
defined
FT_CONFIG_OPTION_NO_GLYPH_NAMES
&
&
\
defined
TT_CONFIG_OPTION_GX_VAR_SUPPORT
FT_DEFINE_SERVICEDESCREC9
(
cff_services
FT_SERVICE_ID_FONT_FORMAT
FT_FONT_FORMAT_CFF
FT_SERVICE_ID_MULTI_MASTERS
&
CFF_SERVICE_MULTI_MASTERS_GET
FT_SERVICE_ID_METRICS_VARIATIONS
&
CFF_SERVICE_METRICS_VAR_GET
FT_SERVICE_ID_POSTSCRIPT_INFO
&
CFF_SERVICE_PS_INFO_GET
FT_SERVICE_ID_POSTSCRIPT_FONT_NAME
&
CFF_SERVICE_PS_NAME_GET
FT_SERVICE_ID_GLYPH_DICT
&
CFF_SERVICE_GLYPH_DICT_GET
FT_SERVICE_ID_TT_CMAP
&
CFF_SERVICE_GET_CMAP_INFO_GET
FT_SERVICE_ID_CID
&
CFF_SERVICE_CID_INFO_GET
FT_SERVICE_ID_PROPERTIES
&
CFF_SERVICE_PROPERTIES_GET
)
#
elif
!
defined
FT_CONFIG_OPTION_NO_GLYPH_NAMES
FT_DEFINE_SERVICEDESCREC7
(
cff_services
FT_SERVICE_ID_FONT_FORMAT
FT_FONT_FORMAT_CFF
FT_SERVICE_ID_POSTSCRIPT_INFO
&
CFF_SERVICE_PS_INFO_GET
FT_SERVICE_ID_POSTSCRIPT_FONT_NAME
&
CFF_SERVICE_PS_NAME_GET
FT_SERVICE_ID_GLYPH_DICT
&
CFF_SERVICE_GLYPH_DICT_GET
FT_SERVICE_ID_TT_CMAP
&
CFF_SERVICE_GET_CMAP_INFO_GET
FT_SERVICE_ID_CID
&
CFF_SERVICE_CID_INFO_GET
FT_SERVICE_ID_PROPERTIES
&
CFF_SERVICE_PROPERTIES_GET
)
#
elif
defined
TT_CONFIG_OPTION_GX_VAR_SUPPORT
FT_DEFINE_SERVICEDESCREC8
(
cff_services
FT_SERVICE_ID_FONT_FORMAT
FT_FONT_FORMAT_CFF
FT_SERVICE_ID_MULTI_MASTERS
&
CFF_SERVICE_MULTI_MASTERS_GET
FT_SERVICE_ID_METRICS_VARIATIONS
&
CFF_SERVICE_METRICS_VAR_GET
FT_SERVICE_ID_POSTSCRIPT_INFO
&
CFF_SERVICE_PS_INFO_GET
FT_SERVICE_ID_POSTSCRIPT_FONT_NAME
&
CFF_SERVICE_PS_NAME_GET
FT_SERVICE_ID_TT_CMAP
&
CFF_SERVICE_GET_CMAP_INFO_GET
FT_SERVICE_ID_CID
&
CFF_SERVICE_CID_INFO_GET
FT_SERVICE_ID_PROPERTIES
&
CFF_SERVICE_PROPERTIES_GET
)
#
else
FT_DEFINE_SERVICEDESCREC6
(
cff_services
FT_SERVICE_ID_FONT_FORMAT
FT_FONT_FORMAT_CFF
FT_SERVICE_ID_POSTSCRIPT_INFO
&
CFF_SERVICE_PS_INFO_GET
FT_SERVICE_ID_POSTSCRIPT_FONT_NAME
&
CFF_SERVICE_PS_NAME_GET
FT_SERVICE_ID_TT_CMAP
&
CFF_SERVICE_GET_CMAP_INFO_GET
FT_SERVICE_ID_CID
&
CFF_SERVICE_CID_INFO_GET
FT_SERVICE_ID_PROPERTIES
&
CFF_SERVICE_PROPERTIES_GET
)
#
endif
FT_CALLBACK_DEF
(
FT_Module_Interface
)
cff_get_interface
(
FT_Module
driver
const
char
*
module_interface
)
{
FT_Library
library
;
FT_Module
sfnt
;
FT_Module_Interface
result
;
#
ifdef
FT_CONFIG_OPTION_PIC
if
(
!
driver
)
return
NULL
;
library
=
driver
-
>
library
;
if
(
!
library
)
return
NULL
;
#
endif
result
=
ft_service_list_lookup
(
CFF_SERVICES_GET
module_interface
)
;
if
(
result
)
return
result
;
#
ifndef
FT_CONFIG_OPTION_PIC
if
(
!
driver
)
return
NULL
;
library
=
driver
-
>
library
;
if
(
!
library
)
return
NULL
;
#
endif
sfnt
=
FT_Get_Module
(
library
"
sfnt
"
)
;
return
sfnt
?
sfnt
-
>
clazz
-
>
get_interface
(
sfnt
module_interface
)
:
0
;
}
#
ifdef
TT_CONFIG_OPTION_EMBEDDED_BITMAPS
#
define
CFF_SIZE_SELECT
cff_size_select
#
else
#
define
CFF_SIZE_SELECT
0
#
endif
FT_DEFINE_DRIVER
(
cff_driver_class
FT_MODULE_FONT_DRIVER
|
FT_MODULE_DRIVER_SCALABLE
|
FT_MODULE_DRIVER_HAS_HINTER
|
FT_MODULE_DRIVER_HINTS_LIGHTLY
sizeof
(
CFF_DriverRec
)
"
cff
"
0x10000L
0x20000L
NULL
cff_driver_init
cff_driver_done
cff_get_interface
sizeof
(
TT_FaceRec
)
sizeof
(
CFF_SizeRec
)
sizeof
(
CFF_GlyphSlotRec
)
cff_face_init
cff_face_done
cff_size_init
cff_size_done
cff_slot_init
cff_slot_done
cff_glyph_load
cff_get_kerning
NULL
cff_get_advances
cff_size_request
CFF_SIZE_SELECT
)
