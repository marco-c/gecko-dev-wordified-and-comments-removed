#
include
<
freetype
/
internal
/
ftdebug
.
h
>
#
include
<
freetype
/
internal
/
ftstream
.
h
>
#
include
<
freetype
/
tttags
.
h
>
#
ifdef
TT_CONFIG_OPTION_POSTSCRIPT_NAMES
#
include
"
ttpost
.
h
"
#
include
"
sferrors
.
h
"
#
undef
FT_COMPONENT
#
define
FT_COMPONENT
ttpost
#
ifdef
FT_CONFIG_OPTION_POSTSCRIPT_NAMES
#
include
<
freetype
/
internal
/
services
/
svpscmap
.
h
>
#
define
MAC_NAME
(
x
)
(
FT_String
*
)
psnames
-
>
macintosh_name
(
(
FT_UInt
)
(
x
)
)
#
else
#
define
MAC_NAME
(
x
)
(
FT_String
*
)
tt_post_default_names
[
x
]
static
const
FT_String
*
const
tt_post_default_names
[
258
]
=
{
"
.
notdef
"
"
.
null
"
"
nonmarkingreturn
"
"
space
"
"
exclam
"
"
quotedbl
"
"
numbersign
"
"
dollar
"
"
percent
"
"
ampersand
"
"
quotesingle
"
"
parenleft
"
"
parenright
"
"
asterisk
"
"
plus
"
"
comma
"
"
hyphen
"
"
period
"
"
slash
"
"
zero
"
"
one
"
"
two
"
"
three
"
"
four
"
"
five
"
"
six
"
"
seven
"
"
eight
"
"
nine
"
"
colon
"
"
semicolon
"
"
less
"
"
equal
"
"
greater
"
"
question
"
"
at
"
"
A
"
"
B
"
"
C
"
"
D
"
"
E
"
"
F
"
"
G
"
"
H
"
"
I
"
"
J
"
"
K
"
"
L
"
"
M
"
"
N
"
"
O
"
"
P
"
"
Q
"
"
R
"
"
S
"
"
T
"
"
U
"
"
V
"
"
W
"
"
X
"
"
Y
"
"
Z
"
"
bracketleft
"
"
backslash
"
"
bracketright
"
"
asciicircum
"
"
underscore
"
"
grave
"
"
a
"
"
b
"
"
c
"
"
d
"
"
e
"
"
f
"
"
g
"
"
h
"
"
i
"
"
j
"
"
k
"
"
l
"
"
m
"
"
n
"
"
o
"
"
p
"
"
q
"
"
r
"
"
s
"
"
t
"
"
u
"
"
v
"
"
w
"
"
x
"
"
y
"
"
z
"
"
braceleft
"
"
bar
"
"
braceright
"
"
asciitilde
"
"
Adieresis
"
"
Aring
"
"
Ccedilla
"
"
Eacute
"
"
Ntilde
"
"
Odieresis
"
"
Udieresis
"
"
aacute
"
"
agrave
"
"
acircumflex
"
"
adieresis
"
"
atilde
"
"
aring
"
"
ccedilla
"
"
eacute
"
"
egrave
"
"
ecircumflex
"
"
edieresis
"
"
iacute
"
"
igrave
"
"
icircumflex
"
"
idieresis
"
"
ntilde
"
"
oacute
"
"
ograve
"
"
ocircumflex
"
"
odieresis
"
"
otilde
"
"
uacute
"
"
ugrave
"
"
ucircumflex
"
"
udieresis
"
"
dagger
"
"
degree
"
"
cent
"
"
sterling
"
"
section
"
"
bullet
"
"
paragraph
"
"
germandbls
"
"
registered
"
"
copyright
"
"
trademark
"
"
acute
"
"
dieresis
"
"
notequal
"
"
AE
"
"
Oslash
"
"
infinity
"
"
plusminus
"
"
lessequal
"
"
greaterequal
"
"
yen
"
"
mu
"
"
partialdiff
"
"
summation
"
"
product
"
"
pi
"
"
integral
"
"
ordfeminine
"
"
ordmasculine
"
"
Omega
"
"
ae
"
"
oslash
"
"
questiondown
"
"
exclamdown
"
"
logicalnot
"
"
radical
"
"
florin
"
"
approxequal
"
"
Delta
"
"
guillemotleft
"
"
guillemotright
"
"
ellipsis
"
"
nonbreakingspace
"
"
Agrave
"
"
Atilde
"
"
Otilde
"
"
OE
"
"
oe
"
"
endash
"
"
emdash
"
"
quotedblleft
"
"
quotedblright
"
"
quoteleft
"
"
quoteright
"
"
divide
"
"
lozenge
"
"
ydieresis
"
"
Ydieresis
"
"
fraction
"
"
currency
"
"
guilsinglleft
"
"
guilsinglright
"
"
fi
"
"
fl
"
"
daggerdbl
"
"
periodcentered
"
"
quotesinglbase
"
"
quotedblbase
"
"
perthousand
"
"
Acircumflex
"
"
Ecircumflex
"
"
Aacute
"
"
Edieresis
"
"
Egrave
"
"
Iacute
"
"
Icircumflex
"
"
Idieresis
"
"
Igrave
"
"
Oacute
"
"
Ocircumflex
"
"
apple
"
"
Ograve
"
"
Uacute
"
"
Ucircumflex
"
"
Ugrave
"
"
dotlessi
"
"
circumflex
"
"
tilde
"
"
macron
"
"
breve
"
"
dotaccent
"
"
ring
"
"
cedilla
"
"
hungarumlaut
"
"
ogonek
"
"
caron
"
"
Lslash
"
"
lslash
"
"
Scaron
"
"
scaron
"
"
Zcaron
"
"
zcaron
"
"
brokenbar
"
"
Eth
"
"
eth
"
"
Yacute
"
"
yacute
"
"
Thorn
"
"
thorn
"
"
minus
"
"
multiply
"
"
onesuperior
"
"
twosuperior
"
"
threesuperior
"
"
onehalf
"
"
onequarter
"
"
threequarters
"
"
franc
"
"
Gbreve
"
"
gbreve
"
"
Idotaccent
"
"
Scedilla
"
"
scedilla
"
"
Cacute
"
"
cacute
"
"
Ccaron
"
"
ccaron
"
"
dcroat
"
}
;
#
endif
static
FT_Error
load_format_20
(
TT_Post_Names
names
FT_Stream
stream
FT_UShort
num_glyphs
FT_ULong
post_len
)
{
FT_Memory
memory
=
stream
-
>
memory
;
FT_Error
error
;
FT_UShort
n
;
FT_UShort
num_names
=
0
;
FT_UShort
*
glyph_indices
=
NULL
;
FT_Byte
*
*
name_strings
=
NULL
;
FT_Byte
*
q
;
if
(
(
FT_ULong
)
num_glyphs
*
2
>
post_len
)
{
error
=
FT_THROW
(
Invalid_File_Format
)
;
goto
Exit
;
}
if
(
FT_QNEW_ARRAY
(
glyph_indices
num_glyphs
)
|
|
FT_FRAME_ENTER
(
num_glyphs
*
2
)
)
goto
Fail
;
q
=
(
FT_Byte
*
)
stream
-
>
cursor
;
for
(
n
=
0
;
n
<
num_glyphs
;
n
+
+
)
{
FT_UShort
idx
=
FT_NEXT_USHORT
(
q
)
;
if
(
idx
>
num_names
)
num_names
=
idx
;
glyph_indices
[
n
]
=
idx
;
}
FT_FRAME_EXIT
(
)
;
num_names
=
num_names
>
257
?
num_names
-
257
:
0
;
if
(
num_names
)
{
FT_Byte
*
p
;
FT_Byte
*
p_end
;
post_len
-
=
(
FT_ULong
)
num_glyphs
*
2
;
if
(
FT_QALLOC
(
name_strings
num_names
*
sizeof
(
FT_Byte
*
)
+
post_len
+
1
)
)
goto
Fail
;
p
=
(
FT_Byte
*
)
(
name_strings
+
num_names
)
;
if
(
FT_STREAM_READ
(
p
post_len
)
)
goto
Fail
;
p_end
=
p
+
post_len
;
for
(
n
=
0
;
p
<
p_end
&
&
n
<
num_names
;
n
+
+
)
{
FT_UInt
len
=
*
p
;
if
(
len
>
=
40U
)
FT_TRACE4
(
(
"
load_format_20
:
unusual
%
u
-
char
name
found
\
n
"
len
)
)
;
*
p
+
+
=
0
;
name_strings
[
n
]
=
p
;
p
+
=
len
;
}
*
p_end
=
0
;
if
(
n
<
num_names
)
{
FT_TRACE4
(
(
"
load_format_20
:
%
hu
PostScript
names
are
truncated
\
n
"
(
FT_UShort
)
(
num_names
-
n
)
)
)
;
for
(
;
n
<
num_names
;
n
+
+
)
name_strings
[
n
]
=
p_end
;
}
}
names
-
>
num_glyphs
=
num_glyphs
;
names
-
>
num_names
=
num_names
;
names
-
>
glyph_indices
=
glyph_indices
;
names
-
>
glyph_names
=
name_strings
;
return
FT_Err_Ok
;
Fail
:
FT_FREE
(
name_strings
)
;
FT_FREE
(
glyph_indices
)
;
Exit
:
return
error
;
}
static
FT_Error
load_format_25
(
TT_Post_Names
names
FT_Stream
stream
FT_UShort
num_glyphs
FT_ULong
post_len
)
{
FT_Memory
memory
=
stream
-
>
memory
;
FT_Error
error
;
FT_UShort
n
;
FT_UShort
*
glyph_indices
=
NULL
;
FT_Byte
*
q
;
if
(
num_glyphs
>
post_len
|
|
num_glyphs
>
258
+
128
)
{
error
=
FT_THROW
(
Invalid_File_Format
)
;
goto
Exit
;
}
if
(
FT_QNEW_ARRAY
(
glyph_indices
num_glyphs
)
|
|
FT_FRAME_ENTER
(
num_glyphs
)
)
goto
Fail
;
q
=
(
FT_Byte
*
)
stream
-
>
cursor
;
for
(
n
=
0
;
n
<
num_glyphs
;
n
+
+
)
{
FT_Int
idx
=
n
+
FT_NEXT_CHAR
(
q
)
;
if
(
idx
<
0
|
|
idx
>
257
)
idx
=
0
;
glyph_indices
[
n
]
=
(
FT_UShort
)
idx
;
}
FT_FRAME_EXIT
(
)
;
names
-
>
num_glyphs
=
num_glyphs
;
names
-
>
glyph_indices
=
glyph_indices
;
return
FT_Err_Ok
;
Fail
:
FT_FREE
(
glyph_indices
)
;
Exit
:
return
error
;
}
static
FT_Error
load_post_names
(
TT_Face
face
)
{
FT_Error
error
=
FT_Err_Ok
;
FT_Stream
stream
=
face
-
>
root
.
stream
;
FT_Fixed
format
=
face
-
>
postscript
.
FormatType
;
FT_ULong
post_len
;
FT_UShort
num_glyphs
;
error
=
face
-
>
goto_table
(
face
TTAG_post
stream
&
post_len
)
;
if
(
error
)
goto
Exit
;
if
(
post_len
<
34
|
|
FT_STREAM_SKIP
(
32
)
|
|
FT_READ_USHORT
(
num_glyphs
)
|
|
num_glyphs
>
face
-
>
max_profile
.
numGlyphs
|
|
num_glyphs
=
=
0
)
goto
Exit
;
if
(
format
=
=
0x00020000L
)
error
=
load_format_20
(
&
face
-
>
postscript_names
stream
num_glyphs
post_len
-
34
)
;
else
if
(
format
=
=
0x00025000L
)
error
=
load_format_25
(
&
face
-
>
postscript_names
stream
num_glyphs
post_len
-
34
)
;
Exit
:
face
-
>
postscript_names
.
loaded
=
1
;
return
error
;
}
FT_LOCAL_DEF
(
void
)
tt_face_free_ps_names
(
TT_Face
face
)
{
FT_Memory
memory
=
face
-
>
root
.
memory
;
TT_Post_Names
names
=
&
face
-
>
postscript_names
;
if
(
names
-
>
num_glyphs
)
{
FT_FREE
(
names
-
>
glyph_indices
)
;
names
-
>
num_glyphs
=
0
;
}
if
(
names
-
>
num_names
)
{
FT_FREE
(
names
-
>
glyph_names
)
;
names
-
>
num_names
=
0
;
}
names
-
>
loaded
=
0
;
}
FT_LOCAL_DEF
(
FT_Error
)
tt_face_get_ps_name
(
TT_Face
face
FT_UInt
idx
FT_String
*
*
PSname
)
{
FT_Error
error
;
FT_Fixed
format
;
#
ifdef
FT_CONFIG_OPTION_POSTSCRIPT_NAMES
FT_Service_PsCMaps
psnames
;
#
endif
if
(
!
face
)
return
FT_THROW
(
Invalid_Face_Handle
)
;
if
(
idx
>
=
(
FT_UInt
)
face
-
>
max_profile
.
numGlyphs
)
return
FT_THROW
(
Invalid_Glyph_Index
)
;
#
ifdef
FT_CONFIG_OPTION_POSTSCRIPT_NAMES
psnames
=
(
FT_Service_PsCMaps
)
face
-
>
psnames
;
if
(
!
psnames
)
return
FT_THROW
(
Unimplemented_Feature
)
;
#
endif
*
PSname
=
MAC_NAME
(
0
)
;
format
=
face
-
>
postscript
.
FormatType
;
if
(
format
=
=
0x00020000L
|
|
format
=
=
0x00025000L
)
{
TT_Post_Names
names
=
&
face
-
>
postscript_names
;
if
(
!
names
-
>
loaded
)
{
error
=
load_post_names
(
face
)
;
if
(
error
)
goto
End
;
}
if
(
idx
<
(
FT_UInt
)
names
-
>
num_glyphs
)
{
FT_UShort
name_index
=
names
-
>
glyph_indices
[
idx
]
;
if
(
name_index
<
258
)
*
PSname
=
MAC_NAME
(
name_index
)
;
else
*
PSname
=
(
FT_String
*
)
names
-
>
glyph_names
[
name_index
-
258
]
;
}
}
else
if
(
format
=
=
0x00010000L
&
&
face
-
>
max_profile
.
numGlyphs
=
=
258
)
*
PSname
=
MAC_NAME
(
idx
)
;
End
:
return
FT_Err_Ok
;
}
#
else
typedef
int
tt_post_dummy_
;
#
endif
