#
include
<
ft2build
.
h
>
#
include
FT_INTERNAL_DEBUG_H
#
include
FT_INTERNAL_OBJECTS_H
#
include
FT_OUTLINE_H
#
include
"
ftrend1
.
h
"
#
include
"
ftraster
.
h
"
#
include
"
rastpic
.
h
"
#
include
"
rasterrs
.
h
"
static
FT_Error
ft_raster1_init
(
FT_Renderer
render
)
{
FT_Library
library
=
FT_MODULE_LIBRARY
(
render
)
;
render
-
>
clazz
-
>
raster_class
-
>
raster_reset
(
render
-
>
raster
library
-
>
raster_pool
library
-
>
raster_pool_size
)
;
return
FT_Err_Ok
;
}
static
FT_Error
ft_raster1_set_mode
(
FT_Renderer
render
FT_ULong
mode_tag
FT_Pointer
data
)
{
return
render
-
>
clazz
-
>
raster_class
-
>
raster_set_mode
(
render
-
>
raster
mode_tag
data
)
;
}
static
FT_Error
ft_raster1_transform
(
FT_Renderer
render
FT_GlyphSlot
slot
const
FT_Matrix
*
matrix
const
FT_Vector
*
delta
)
{
FT_Error
error
=
FT_Err_Ok
;
if
(
slot
-
>
format
!
=
render
-
>
glyph_format
)
{
error
=
FT_THROW
(
Invalid_Argument
)
;
goto
Exit
;
}
if
(
matrix
)
FT_Outline_Transform
(
&
slot
-
>
outline
matrix
)
;
if
(
delta
)
FT_Outline_Translate
(
&
slot
-
>
outline
delta
-
>
x
delta
-
>
y
)
;
Exit
:
return
error
;
}
static
void
ft_raster1_get_cbox
(
FT_Renderer
render
FT_GlyphSlot
slot
FT_BBox
*
cbox
)
{
FT_ZERO
(
cbox
)
;
if
(
slot
-
>
format
=
=
render
-
>
glyph_format
)
FT_Outline_Get_CBox
(
&
slot
-
>
outline
cbox
)
;
}
static
FT_Error
ft_raster1_render
(
FT_Renderer
render
FT_GlyphSlot
slot
FT_Render_Mode
mode
const
FT_Vector
*
origin
)
{
FT_Error
error
;
FT_Outline
*
outline
;
FT_BBox
cbox
cbox0
;
FT_UInt
width
height
pitch
;
FT_Bitmap
*
bitmap
;
FT_Memory
memory
;
FT_Raster_Params
params
;
if
(
slot
-
>
format
!
=
render
-
>
glyph_format
)
{
error
=
FT_THROW
(
Invalid_Argument
)
;
goto
Exit
;
}
if
(
mode
!
=
FT_RENDER_MODE_MONO
)
{
return
FT_THROW
(
Cannot_Render_Glyph
)
;
}
outline
=
&
slot
-
>
outline
;
if
(
origin
)
FT_Outline_Translate
(
outline
origin
-
>
x
origin
-
>
y
)
;
FT_Outline_Get_CBox
(
outline
&
cbox0
)
;
#
if
1
cbox
.
xMin
=
FT_PIX_ROUND
(
cbox0
.
xMin
)
;
cbox
.
yMin
=
FT_PIX_ROUND
(
cbox0
.
yMin
)
;
cbox
.
xMax
=
FT_PIX_ROUND
(
cbox0
.
xMax
)
;
cbox
.
yMax
=
FT_PIX_ROUND
(
cbox0
.
yMax
)
;
#
else
cbox
.
xMin
=
FT_PIX_FLOOR
(
cbox
.
xMin
)
;
cbox
.
yMin
=
FT_PIX_FLOOR
(
cbox
.
yMin
)
;
cbox
.
xMax
=
FT_PIX_CEIL
(
cbox
.
xMax
)
;
cbox
.
yMax
=
FT_PIX_CEIL
(
cbox
.
yMax
)
;
#
endif
width
=
(
FT_UInt
)
(
(
cbox
.
xMax
-
cbox
.
xMin
)
>
>
6
)
;
if
(
width
=
=
0
)
{
cbox
.
xMin
=
FT_PIX_FLOOR
(
cbox0
.
xMin
)
;
cbox
.
xMax
=
FT_PIX_CEIL
(
cbox0
.
xMax
)
;
width
=
(
FT_UInt
)
(
(
cbox
.
xMax
-
cbox
.
xMin
)
>
>
6
)
;
}
height
=
(
FT_UInt
)
(
(
cbox
.
yMax
-
cbox
.
yMin
)
>
>
6
)
;
if
(
height
=
=
0
)
{
cbox
.
yMin
=
FT_PIX_FLOOR
(
cbox0
.
yMin
)
;
cbox
.
yMax
=
FT_PIX_CEIL
(
cbox0
.
yMax
)
;
height
=
(
FT_UInt
)
(
(
cbox
.
yMax
-
cbox
.
yMin
)
>
>
6
)
;
}
if
(
width
>
FT_USHORT_MAX
|
|
height
>
FT_USHORT_MAX
)
{
error
=
FT_THROW
(
Invalid_Argument
)
;
goto
Exit
;
}
bitmap
=
&
slot
-
>
bitmap
;
memory
=
render
-
>
root
.
memory
;
if
(
slot
-
>
internal
-
>
flags
&
FT_GLYPH_OWN_BITMAP
)
{
FT_FREE
(
bitmap
-
>
buffer
)
;
slot
-
>
internal
-
>
flags
&
=
~
FT_GLYPH_OWN_BITMAP
;
}
pitch
=
(
(
width
+
15
)
>
>
4
)
<
<
1
;
bitmap
-
>
pixel_mode
=
FT_PIXEL_MODE_MONO
;
bitmap
-
>
width
=
width
;
bitmap
-
>
rows
=
height
;
bitmap
-
>
pitch
=
(
int
)
pitch
;
if
(
FT_ALLOC_MULT
(
bitmap
-
>
buffer
pitch
height
)
)
goto
Exit
;
slot
-
>
internal
-
>
flags
|
=
FT_GLYPH_OWN_BITMAP
;
FT_Outline_Translate
(
outline
-
cbox
.
xMin
-
cbox
.
yMin
)
;
params
.
target
=
bitmap
;
params
.
source
=
outline
;
params
.
flags
=
0
;
error
=
render
-
>
raster_render
(
render
-
>
raster
&
params
)
;
FT_Outline_Translate
(
outline
cbox
.
xMin
cbox
.
yMin
)
;
if
(
error
)
goto
Exit
;
slot
-
>
format
=
FT_GLYPH_FORMAT_BITMAP
;
slot
-
>
bitmap_left
=
(
FT_Int
)
(
cbox
.
xMin
>
>
6
)
;
slot
-
>
bitmap_top
=
(
FT_Int
)
(
cbox
.
yMax
>
>
6
)
;
Exit
:
return
error
;
}
FT_DEFINE_RENDERER
(
ft_raster1_renderer_class
FT_MODULE_RENDERER
sizeof
(
FT_RendererRec
)
"
raster1
"
0x10000L
0x20000L
NULL
(
FT_Module_Constructor
)
ft_raster1_init
(
FT_Module_Destructor
)
NULL
(
FT_Module_Requester
)
NULL
FT_GLYPH_FORMAT_OUTLINE
(
FT_Renderer_RenderFunc
)
ft_raster1_render
(
FT_Renderer_TransformFunc
)
ft_raster1_transform
(
FT_Renderer_GetCBoxFunc
)
ft_raster1_get_cbox
(
FT_Renderer_SetModeFunc
)
ft_raster1_set_mode
(
FT_Raster_Funcs
*
)
&
FT_STANDARD_RASTER_GET
)
