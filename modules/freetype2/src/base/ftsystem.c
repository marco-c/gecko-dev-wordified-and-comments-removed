#
include
<
ft2build
.
h
>
#
include
FT_CONFIG_CONFIG_H
#
include
<
freetype
/
internal
/
ftdebug
.
h
>
#
include
<
freetype
/
internal
/
ftstream
.
h
>
#
include
<
freetype
/
ftsystem
.
h
>
#
include
<
freetype
/
fterrors
.
h
>
#
include
<
freetype
/
fttypes
.
h
>
FT_CALLBACK_DEF
(
void
*
)
ft_alloc
(
FT_Memory
memory
long
size
)
{
FT_UNUSED
(
memory
)
;
return
ft_smalloc
(
(
size_t
)
size
)
;
}
FT_CALLBACK_DEF
(
void
*
)
ft_realloc
(
FT_Memory
memory
long
cur_size
long
new_size
void
*
block
)
{
FT_UNUSED
(
memory
)
;
FT_UNUSED
(
cur_size
)
;
return
ft_srealloc
(
block
(
size_t
)
new_size
)
;
}
FT_CALLBACK_DEF
(
void
)
ft_free
(
FT_Memory
memory
void
*
block
)
{
FT_UNUSED
(
memory
)
;
ft_sfree
(
block
)
;
}
#
ifndef
FT_CONFIG_OPTION_DISABLE_STREAM_SUPPORT
#
undef
FT_COMPONENT
#
define
FT_COMPONENT
io
#
define
STREAM_FILE
(
stream
)
(
(
FT_FILE
*
)
stream
-
>
descriptor
.
pointer
)
FT_CALLBACK_DEF
(
void
)
ft_ansi_stream_close
(
FT_Stream
stream
)
{
ft_fclose
(
STREAM_FILE
(
stream
)
)
;
stream
-
>
descriptor
.
pointer
=
NULL
;
stream
-
>
size
=
0
;
stream
-
>
base
=
NULL
;
}
FT_CALLBACK_DEF
(
unsigned
long
)
ft_ansi_stream_io
(
FT_Stream
stream
unsigned
long
offset
unsigned
char
*
buffer
unsigned
long
count
)
{
FT_FILE
*
file
;
if
(
!
count
&
&
offset
>
stream
-
>
size
)
return
1
;
file
=
STREAM_FILE
(
stream
)
;
if
(
stream
-
>
pos
!
=
offset
)
ft_fseek
(
file
(
long
)
offset
SEEK_SET
)
;
return
(
unsigned
long
)
ft_fread
(
buffer
1
count
file
)
;
}
FT_BASE_DEF
(
FT_Error
)
FT_Stream_Open
(
FT_Stream
stream
const
char
*
filepathname
)
{
FT_FILE
*
file
;
if
(
!
stream
)
return
FT_THROW
(
Invalid_Stream_Handle
)
;
stream
-
>
descriptor
.
pointer
=
NULL
;
stream
-
>
pathname
.
pointer
=
(
char
*
)
filepathname
;
stream
-
>
base
=
NULL
;
stream
-
>
pos
=
0
;
stream
-
>
read
=
NULL
;
stream
-
>
close
=
NULL
;
file
=
ft_fopen
(
filepathname
"
rb
"
)
;
if
(
!
file
)
{
FT_ERROR
(
(
"
FT_Stream_Open
:
"
"
could
not
open
%
s
'
\
n
"
filepathname
)
)
;
return
FT_THROW
(
Cannot_Open_Resource
)
;
}
ft_fseek
(
file
0
SEEK_END
)
;
stream
-
>
size
=
(
unsigned
long
)
ft_ftell
(
file
)
;
if
(
!
stream
-
>
size
)
{
FT_ERROR
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_ERROR
(
(
"
opened
%
s
'
but
zero
-
sized
\
n
"
filepathname
)
)
;
ft_fclose
(
file
)
;
return
FT_THROW
(
Cannot_Open_Stream
)
;
}
ft_fseek
(
file
0
SEEK_SET
)
;
stream
-
>
descriptor
.
pointer
=
file
;
stream
-
>
read
=
ft_ansi_stream_io
;
stream
-
>
close
=
ft_ansi_stream_close
;
FT_TRACE1
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_TRACE1
(
(
"
opened
%
s
'
(
%
ld
bytes
)
successfully
\
n
"
filepathname
stream
-
>
size
)
)
;
return
FT_Err_Ok
;
}
#
endif
#
ifdef
FT_DEBUG_MEMORY
extern
FT_Int
ft_mem_debug_init
(
FT_Memory
memory
)
;
extern
void
ft_mem_debug_done
(
FT_Memory
memory
)
;
#
endif
FT_BASE_DEF
(
FT_Memory
)
FT_New_Memory
(
void
)
{
FT_Memory
memory
;
memory
=
(
FT_Memory
)
ft_smalloc
(
sizeof
(
*
memory
)
)
;
if
(
memory
)
{
memory
-
>
user
=
NULL
;
memory
-
>
alloc
=
ft_alloc
;
memory
-
>
realloc
=
ft_realloc
;
memory
-
>
free
=
ft_free
;
#
ifdef
FT_DEBUG_MEMORY
ft_mem_debug_init
(
memory
)
;
#
endif
}
return
memory
;
}
FT_BASE_DEF
(
void
)
FT_Done_Memory
(
FT_Memory
memory
)
{
#
ifdef
FT_DEBUG_MEMORY
ft_mem_debug_done
(
memory
)
;
#
endif
ft_sfree
(
memory
)
;
}
