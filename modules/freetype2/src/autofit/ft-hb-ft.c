#
include
<
freetype
/
freetype
.
h
>
#
include
<
freetype
/
tttables
.
h
>
#
ifdef
FT_CONFIG_OPTION_USE_HARFBUZZ
#
include
"
ft
-
hb
-
ft
.
h
"
static
hb_blob_t
*
ft_hb_ft_reference_table
(
hb_face_t
*
face
hb_tag_t
tag
void
*
user_data
)
{
AF_FaceGlobals
globals
=
(
AF_FaceGlobals
)
user_data
;
FT_Face
ft_face
=
globals
-
>
face
;
FT_Byte
*
buffer
;
FT_ULong
length
=
0
;
FT_Error
error
;
FT_UNUSED
(
face
)
;
error
=
FT_Load_Sfnt_Table
(
ft_face
tag
0
NULL
&
length
)
;
if
(
error
)
return
NULL
;
buffer
=
(
FT_Byte
*
)
ft_smalloc
(
length
)
;
if
(
!
buffer
)
return
NULL
;
error
=
FT_Load_Sfnt_Table
(
ft_face
tag
0
buffer
&
length
)
;
if
(
error
)
{
free
(
buffer
)
;
return
NULL
;
}
return
hb
(
blob_create
)
(
(
const
char
*
)
buffer
length
HB_MEMORY_MODE_WRITABLE
buffer
ft_sfree
)
;
}
static
hb_face_t
*
ft_hb_ft_face_create
(
AF_FaceGlobals
globals
)
{
FT_Face
ft_face
=
globals
-
>
face
;
hb_face_t
*
face
;
if
(
!
ft_face
-
>
stream
-
>
read
)
{
hb_blob_t
*
blob
;
blob
=
hb
(
blob_create
)
(
(
const
char
*
)
ft_face
-
>
stream
-
>
base
(
unsigned
int
)
ft_face
-
>
stream
-
>
size
HB_MEMORY_MODE_READONLY
ft_face
NULL
)
;
face
=
hb
(
face_create
)
(
blob
ft_face
-
>
face_index
)
;
hb
(
blob_destroy
)
(
blob
)
;
}
else
{
face
=
hb
(
face_create_for_tables
)
(
ft_hb_ft_reference_table
globals
NULL
)
;
}
hb
(
face_set_index
)
(
face
ft_face
-
>
face_index
)
;
hb
(
face_set_upem
)
(
face
ft_face
-
>
units_per_EM
)
;
return
face
;
}
FT_LOCAL_DEF
(
hb_font_t
*
)
ft_hb_ft_font_create
(
AF_FaceGlobals
globals
)
{
hb_font_t
*
font
;
hb_face_t
*
face
;
face
=
ft_hb_ft_face_create
(
globals
)
;
font
=
hb
(
font_create
)
(
face
)
;
hb
(
face_destroy
)
(
face
)
;
return
font
;
}
#
else
typedef
int
ft_hb_ft_dummy_
;
#
endif
