#
define
__NOLIBBASE__
#
define
__NOGLOBALIFACE__
#
define
__USE_INLINE__
#
include
<
proto
/
exec
.
h
>
#
include
<
dos
/
stdio
.
h
>
#
include
<
proto
/
dos
.
h
>
#
ifdef
__amigaos4__
extern
struct
ExecIFace
*
IExec
;
extern
struct
DOSIFace
*
IDOS
;
#
else
extern
struct
Library
*
SysBase
;
extern
struct
Library
*
DOSBase
;
#
endif
#
define
IOBUF_SIZE
512
struct
SysFile
{
BPTR
file
;
ULONG
iobuf_start
;
ULONG
iobuf_end
;
UBYTE
iobuf
[
IOBUF_SIZE
]
;
}
;
#
ifndef
__amigaos4__
APTR
Alloc_VecPooled
(
APTR
poolHeader
ULONG
memSize
)
{
ULONG
newSize
=
memSize
+
sizeof
(
ULONG
)
;
ULONG
*
mem
=
AllocPooled
(
poolHeader
newSize
)
;
if
(
!
mem
)
return
NULL
;
*
mem
=
newSize
;
return
mem
+
1
;
}
void
Free_VecPooled
(
APTR
poolHeader
APTR
memory
)
{
ULONG
*
realmem
=
(
ULONG
*
)
memory
-
1
;
FreePooled
(
poolHeader
realmem
*
realmem
)
;
}
#
endif
#
include
<
ft2build
.
h
>
#
include
FT_CONFIG_CONFIG_H
#
include
FT_INTERNAL_DEBUG_H
#
include
FT_SYSTEM_H
#
include
FT_ERRORS_H
#
include
FT_TYPES_H
#
include
<
stdio
.
h
>
#
include
<
stdlib
.
h
>
#
include
<
string
.
h
>
FT_CALLBACK_DEF
(
void
*
)
ft_alloc
(
FT_Memory
memory
long
size
)
{
#
ifdef
__amigaos4__
return
AllocVecPooled
(
memory
-
>
user
size
)
;
#
else
return
Alloc_VecPooled
(
memory
-
>
user
size
)
;
#
endif
}
FT_CALLBACK_DEF
(
void
*
)
ft_realloc
(
FT_Memory
memory
long
cur_size
long
new_size
void
*
block
)
{
void
*
new_block
;
#
ifdef
__amigaos4__
new_block
=
AllocVecPooled
(
memory
-
>
user
new_size
)
;
#
else
new_block
=
Alloc_VecPooled
(
memory
-
>
user
new_size
)
;
#
endif
if
(
new_block
!
=
NULL
)
{
CopyMem
(
block
new_block
(
new_size
>
cur_size
)
?
cur_size
:
new_size
)
;
#
ifdef
__amigaos4__
FreeVecPooled
(
memory
-
>
user
block
)
;
#
else
Free_VecPooled
(
memory
-
>
user
block
)
;
#
endif
}
return
new_block
;
}
FT_CALLBACK_DEF
(
void
)
ft_free
(
FT_Memory
memory
void
*
block
)
{
#
ifdef
__amigaos4__
FreeVecPooled
(
memory
-
>
user
block
)
;
#
else
Free_VecPooled
(
memory
-
>
user
block
)
;
#
endif
}
#
undef
FT_COMPONENT
#
define
FT_COMPONENT
io
#
define
STREAM_FILE
(
stream
)
(
(
struct
SysFile
*
)
stream
-
>
descriptor
.
pointer
)
FT_CALLBACK_DEF
(
void
)
ft_amiga_stream_close
(
FT_Stream
stream
)
{
struct
SysFile
*
sysfile
;
sysfile
=
STREAM_FILE
(
stream
)
;
Close
(
sysfile
-
>
file
)
;
FreeMem
(
sysfile
sizeof
(
struct
SysFile
)
)
;
stream
-
>
descriptor
.
pointer
=
NULL
;
stream
-
>
size
=
0
;
stream
-
>
base
=
0
;
}
FT_CALLBACK_DEF
(
unsigned
long
)
ft_amiga_stream_io
(
FT_Stream
stream
unsigned
long
offset
unsigned
char
*
buffer
unsigned
long
count
)
{
struct
SysFile
*
sysfile
;
unsigned
long
read_bytes
;
if
(
count
!
=
0
)
{
sysfile
=
STREAM_FILE
(
stream
)
;
if
(
(
offset
<
sysfile
-
>
iobuf_start
)
|
|
(
offset
+
count
>
sysfile
-
>
iobuf_end
)
)
{
if
(
!
sysfile
-
>
iobuf_end
|
|
offset
!
=
sysfile
-
>
iobuf_end
)
{
Seek
(
sysfile
-
>
file
offset
OFFSET_BEGINNING
)
;
}
sysfile
-
>
iobuf_start
=
offset
;
sysfile
-
>
iobuf_end
=
0
;
}
if
(
offset
+
count
<
=
sysfile
-
>
iobuf_end
)
{
CopyMem
(
&
sysfile
-
>
iobuf
[
offset
-
sysfile
-
>
iobuf_start
]
buffer
count
)
;
read_bytes
=
count
;
}
else
{
if
(
count
<
=
IOBUF_SIZE
)
{
read_bytes
=
Read
(
sysfile
-
>
file
sysfile
-
>
iobuf
IOBUF_SIZE
)
;
if
(
read_bytes
=
=
-
1UL
)
{
read_bytes
=
0
;
}
else
{
sysfile
-
>
iobuf_end
=
offset
+
read_bytes
;
CopyMem
(
sysfile
-
>
iobuf
buffer
count
)
;
if
(
read_bytes
>
count
)
{
read_bytes
=
count
;
}
}
}
else
{
read_bytes
=
Read
(
sysfile
-
>
file
buffer
count
)
;
if
(
read_bytes
=
=
-
1UL
)
{
read_bytes
=
0
;
}
else
{
ULONG
bufsize
;
bufsize
=
(
read_bytes
>
IOBUF_SIZE
)
?
IOBUF_SIZE
:
read_bytes
;
sysfile
-
>
iobuf_end
=
offset
+
read_bytes
;
sysfile
-
>
iobuf_start
=
sysfile
-
>
iobuf_end
-
bufsize
;
CopyMem
(
&
buffer
[
read_bytes
-
bufsize
]
sysfile
-
>
iobuf
bufsize
)
;
}
}
}
}
else
{
read_bytes
=
0
;
}
return
read_bytes
;
}
FT_BASE_DEF
(
FT_Error
)
FT_Stream_Open
(
FT_Stream
stream
const
char
*
filepathname
)
{
struct
FileInfoBlock
*
fib
;
struct
SysFile
*
sysfile
;
if
(
!
stream
)
return
FT_THROW
(
Invalid_Stream_Handle
)
;
#
ifdef
__amigaos4__
sysfile
=
AllocMem
(
sizeof
(
struct
SysFile
)
MEMF_SHARED
)
;
#
else
sysfile
=
AllocMem
(
sizeof
(
struct
SysFile
)
MEMF_PUBLIC
)
;
#
endif
if
(
!
sysfile
)
{
FT_ERROR
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_ERROR
(
(
"
could
not
open
%
s
'
\
n
"
filepathname
)
)
;
return
FT_THROW
(
Cannot_Open_Resource
)
;
}
sysfile
-
>
file
=
Open
(
(
STRPTR
)
filepathname
MODE_OLDFILE
)
;
if
(
!
sysfile
-
>
file
)
{
FreeMem
(
sysfile
sizeof
(
struct
SysFile
)
)
;
FT_ERROR
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_ERROR
(
(
"
could
not
open
%
s
'
\
n
"
filepathname
)
)
;
return
FT_THROW
(
Cannot_Open_Resource
)
;
}
fib
=
AllocDosObject
(
DOS_FIB
NULL
)
;
if
(
!
fib
)
{
Close
(
sysfile
-
>
file
)
;
FreeMem
(
sysfile
sizeof
(
struct
SysFile
)
)
;
FT_ERROR
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_ERROR
(
(
"
could
not
open
%
s
'
\
n
"
filepathname
)
)
;
return
FT_THROW
(
Cannot_Open_Resource
)
;
}
if
(
!
(
ExamineFH
(
sysfile
-
>
file
fib
)
)
)
{
FreeDosObject
(
DOS_FIB
fib
)
;
Close
(
sysfile
-
>
file
)
;
FreeMem
(
sysfile
sizeof
(
struct
SysFile
)
)
;
FT_ERROR
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_ERROR
(
(
"
could
not
open
%
s
'
\
n
"
filepathname
)
)
;
return
FT_THROW
(
Cannot_Open_Resource
)
;
}
stream
-
>
size
=
fib
-
>
fib_Size
;
FreeDosObject
(
DOS_FIB
fib
)
;
stream
-
>
descriptor
.
pointer
=
(
void
*
)
sysfile
;
stream
-
>
pathname
.
pointer
=
(
char
*
)
filepathname
;
sysfile
-
>
iobuf_start
=
0
;
sysfile
-
>
iobuf_end
=
0
;
stream
-
>
pos
=
0
;
stream
-
>
read
=
ft_amiga_stream_io
;
stream
-
>
close
=
ft_amiga_stream_close
;
if
(
!
stream
-
>
size
)
{
ft_amiga_stream_close
(
stream
)
;
FT_ERROR
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_ERROR
(
(
"
opened
%
s
'
but
zero
-
sized
\
n
"
filepathname
)
)
;
return
FT_THROW
(
Cannot_Open_Stream
)
;
}
FT_TRACE1
(
(
"
FT_Stream_Open
:
"
)
)
;
FT_TRACE1
(
(
"
opened
%
s
'
(
%
ld
bytes
)
successfully
\
n
"
filepathname
stream
-
>
size
)
)
;
return
FT_Err_Ok
;
}
#
ifdef
FT_DEBUG_MEMORY
extern
FT_Int
ft_mem_debug_init
(
FT_Memory
memory
)
;
extern
void
ft_mem_debug_done
(
FT_Memory
memory
)
;
#
endif
FT_BASE_DEF
(
FT_Memory
)
FT_New_Memory
(
void
)
{
FT_Memory
memory
;
#
ifdef
__amigaos4__
memory
=
(
FT_Memory
)
AllocVec
(
sizeof
(
*
memory
)
MEMF_SHARED
)
;
#
else
memory
=
(
FT_Memory
)
AllocVec
(
sizeof
(
*
memory
)
MEMF_PUBLIC
)
;
#
endif
if
(
memory
)
{
#
ifdef
__amigaos4__
memory
-
>
user
=
CreatePool
(
MEMF_SHARED
16384
16384
)
;
#
else
memory
-
>
user
=
CreatePool
(
MEMF_PUBLIC
16384
16384
)
;
#
endif
if
(
memory
-
>
user
=
=
NULL
)
{
FreeVec
(
memory
)
;
memory
=
NULL
;
}
else
{
memory
-
>
alloc
=
ft_alloc
;
memory
-
>
realloc
=
ft_realloc
;
memory
-
>
free
=
ft_free
;
#
ifdef
FT_DEBUG_MEMORY
ft_mem_debug_init
(
memory
)
;
#
endif
}
}
return
memory
;
}
FT_BASE_DEF
(
void
)
FT_Done_Memory
(
FT_Memory
memory
)
{
#
ifdef
FT_DEBUG_MEMORY
ft_mem_debug_done
(
memory
)
;
#
endif
DeletePool
(
memory
-
>
user
)
;
FreeVec
(
memory
)
;
}
